{
    "url": "http://localhost:9999/tgriesser/bookshelf/browser/bookshelf.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/tgriesser/bookshelf/browser/bookshelf.js",
                "path": "/tgriesser/bookshelf/browser/bookshelf.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC90Z3JpZXNzZXIvYm9va3NoZWxmL2Jyb3dzZXIvYm9va3NoZWxmLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTc2ODkyDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjU5OjI3IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMjo1OToyNCBHTVQNCg0KIWZ1bmN0aW9uKGUpe2lmKCJvYmplY3QiPT10eXBlb2YgZXhwb3J0cyYmInVuZGVmaW5lZCIhPXR5cGVvZiBtb2R1bGUpbW9kdWxlLmV4cG9ydHM9ZSgpO2Vsc2UgaWYoImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZClkZWZpbmUoW10sZSk7ZWxzZXt2YXIgZjsidW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdz9mPXdpbmRvdzoidW5kZWZpbmVkIiE9dHlwZW9mIGdsb2JhbD9mPWdsb2JhbDoidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJihmPXNlbGYpLGYuQm9va3NoZWxmPWUoKX19KGZ1bmN0aW9uKCl7dmFyIGRlZmluZSxtb2R1bGUsZXhwb3J0cztyZXR1cm4gKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpO3Rocm93IGYuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEJvb2tzaGVsZi5qcyAwLjcuOQovLyAtLS0tLS0tLS0tLS0tLS0KCi8vICAgICAoYykgMjAxNCBUaW0gR3JpZXNzZXIKLy8gICAgIEJvb2tzaGVsZiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9ib29rc2hlbGZqcy5vcmcKCnZhciBCb29rc2hlbGYgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gQm9va3NoZWxmLmluaXRpYWxpemUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfTsKCi8vIENvbnN0cnVjdG9yIGZvciBhIG5ldyBgQm9va3NoZWxmYCBvYmplY3QsIGl0IGFjY2VwdHMKLy8gYW4gYWN0aXZlIGBrbmV4YCBpbnN0YW5jZSBhbmQgaW5pdGlhbGl6ZXMgdGhlIGFwcHJvcHJpYXRlCi8vIGBNb2RlbGAgYW5kIGBDb2xsZWN0aW9uYCBjb25zdHJ1Y3RvcnMgZm9yIHVzZSBpbiB0aGUgY3VycmVudCBpbnN0YW5jZS4KQm9va3NoZWxmLmluaXRpYWxpemUgPSBmdW5jdGlvbihrbmV4KSB7CiAgdmFyIGJvb2tzaGVsZiAgPSB7CiAgICBWRVJTSU9OOiAnMC43LjknCiAgfTsKCiAgdmFyIF8gICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKICB2YXIgaW5oZXJpdHMgICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CiAgdmFyIHNlbXZlciAgICAgPSByZXF1aXJlKCdzZW12ZXInKTsKCiAgLy8gV2UndmUgc3VwcGxlbWVudGVkIGBFdmVudHNgIHdpdGggYSBgdHJpZ2dlclRoZW5gCiAgLy8gbWV0aG9kIHRvIGFsbG93IGZvciBhc3luY2hyb25vdXMgZXZlbnQgaGFuZGxpbmcgdmlhIHByb21pc2VzLiBXZSBhbHNvCiAgLy8gbWl4IHRoaXMgaW50byB0aGUgcHJvdG90eXBlcyBvZiB0aGUgbWFpbiBvYmplY3RzIGluIHRoZSBsaWJyYXJ5LgogIHZhciBFdmVudHMgPSByZXF1aXJlKCcuL2xpYi9iYXNlL2V2ZW50cycpOwoKICAvLyBBbGwgY29yZSBtb2R1bGVzIHJlcXVpcmVkIGZvciB0aGUgYm9va3NoZWxmIGluc3RhbmNlLgogIHZhciBCb29rc2hlbGZNb2RlbCAgICAgID0gcmVxdWlyZSgnLi9saWIvbW9kZWwnKTsKICB2YXIgQm9va3NoZWxmQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vbGliL2NvbGxlY3Rpb24nKTsKICB2YXIgQm9va3NoZWxmUmVsYXRpb24gICA9IHJlcXVpcmUoJy4vbGliL3JlbGF0aW9uJyk7CiAgdmFyIEVycm9ycyAgICAgICAgICAgICAgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKTsKCiAgLy8gSWYgdGhlIGtuZXggaXNuJ3QgYSBgS25leGAgaW5zdGFuY2UsIHdlJ2xsIGFzc3VtZSBpdCdzCiAgLy8gYSBjb21wYXRpYmxlIGNvbmZpZyBvYmplY3QgYW5kIHBhc3MgaXQgdGhyb3VnaCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UuCiAgLy8gVGhpcyBiZWhhdmlvciBpcyBub3cgZGVwcmVjYXRlZC4KICBpZiAoXy5pc1BsYWluT2JqZWN0KGtuZXgpKSB7CiAgICBjb25zb2xlLndhcm4oJ0luaXRpYWxpemluZyBCb29rc2hlbGYgd2l0aCBhIGNvbmZpZyBvYmplY3QgaXMgZGVwcmVjYXRlZCwgcGxlYXNlIHBhc3MgYW4gaW5pdGlhbGl6ZWQga25leC5qcyBpbnN0YW5jZS4nKTsKICAgIGtuZXggPSByZXF1aXJlKCdrbmV4Jykoa25leCk7CiAgfQoKICB2YXIgcmFuZ2UgPSAnPj0wLjYuMTAnOwogIGlmICghc2VtdmVyLnNhdGlzZmllcyhrbmV4LlZFUlNJT04sIHJhbmdlKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdUaGUga25leCB2ZXJzaW9uIGlzICcgKyBrbmV4LlZFUlNJT04gKyAnIHdoaWNoIGRvZXMgbm90IHNhdGlzZnkgdGhlIEJvb2tzaGVsZlwncyByZXF1aXJlbWVudCAnICsgcmFuZ2UpOwogIH0KCiAgdmFyIE1vZGVsID0gYm9va3NoZWxmLk1vZGVsID0gZnVuY3Rpb24oKSB7CiAgICBCb29rc2hlbGZNb2RlbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgdmFyIENvbGxlY3Rpb24gPSBib29rc2hlbGYuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgQm9va3NoZWxmQ29sbGVjdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgaW5oZXJpdHMoTW9kZWwsIEJvb2tzaGVsZk1vZGVsKTsKICBpbmhlcml0cyhDb2xsZWN0aW9uLCBCb29rc2hlbGZDb2xsZWN0aW9uKTsKCiAgXy5leHRlbmQoTW9kZWwsIEJvb2tzaGVsZk1vZGVsKTsKICBfLmV4dGVuZChDb2xsZWN0aW9uLCBCb29rc2hlbGZDb2xsZWN0aW9uKTsKCiAgTW9kZWwucHJvdG90eXBlLl9idWlsZGVyID0KICBDb2xsZWN0aW9uLnByb3RvdHlwZS5fYnVpbGRlciA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogICAgdmFyIGJ1aWxkZXIgID0ga25leCh0YWJsZU5hbWUpOwogICAgdmFyIGluc3RhbmNlID0gdGhpczsKICAgIHJldHVybiBidWlsZGVyLm9uKCdxdWVyeScsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgaW5zdGFuY2UudHJpZ2dlcigncXVlcnknLCBkYXRhKTsKICAgIH0pOwogIH07CgogIC8vIFRoZSBjb2xsZWN0aW9uIGFsc28gcmVmZXJlbmNlcyB0aGUgY29ycmVjdCBgTW9kZWxgLCBzcGVjaWZpZWQgYWJvdmUsIGZvciBjcmVhdGluZwogIC8vIG5ldyBgTW9kZWxgIGluc3RhbmNlcyBpbiB0aGUgY29sbGVjdGlvbi4KICBDb2xsZWN0aW9uLnByb3RvdHlwZS5tb2RlbCA9IE1vZGVsOwogIE1vZGVsLnByb3RvdHlwZS5Db2xsZWN0aW9uID0gQ29sbGVjdGlvbjsKCiAgZnVuY3Rpb24gUmVsYXRpb24oKSB7CiAgICBCb29rc2hlbGZSZWxhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KICBpbmhlcml0cyhSZWxhdGlvbiwgQm9va3NoZWxmUmVsYXRpb24pOwogIFJlbGF0aW9uLnByb3RvdHlwZS5Nb2RlbCA9IE1vZGVsOwogIFJlbGF0aW9uLnByb3RvdHlwZS5Db2xsZWN0aW9uID0gQ29sbGVjdGlvbjsKCiAgLy8gVGhlIGBNb2RlbGAgY29uc3RydWN0b3IgaXMgcmVmZXJlbmNlZCBhcyBhIHByb3BlcnR5IG9uIHRoZSBgQm9va3NoZWxmYCBpbnN0YW5jZSwKICAvLyBtaXhpbmcgaW4gdGhlIGNvcnJlY3QgYGJ1aWxkZXJgIG1ldGhvZCwgYXMgd2VsbCBhcyB0aGUgYHJlbGF0aW9uYCBtZXRob2QsCiAgLy8gcGFzc2luZyBpbiB0aGUgY29ycmVjdCBgTW9kZWxgICYgYENvbGxlY3Rpb25gIGNvbnN0cnVjdG9ycyBmb3IgbGF0ZXIgcmVmZXJlbmNlLgogIE1vZGVsLnByb3RvdHlwZS5fcmVsYXRpb24gPSBmdW5jdGlvbih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlICE9PSAnbW9ycGhUbycgJiYgIV8uaXNGdW5jdGlvbihUYXJnZXQpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQSB2YWxpZCB0YXJnZXQgbW9kZWwgbXVzdCBiZSBkZWZpbmVkIGZvciB0aGUgJyArCiAgICAgICAgXy5yZXN1bHQodGhpcywgJ3RhYmxlTmFtZScpICsgJyAnICsgdHlwZSArICcgcmVsYXRpb24nKTsKICAgIH0KICAgIHJldHVybiBuZXcgUmVsYXRpb24odHlwZSwgVGFyZ2V0LCBvcHRpb25zKTsKICB9OwoKICAvLyBTaG9ydGN1dCBmb3IgY3JlYXRpbmcgYSBuZXcgY29sbGVjdGlvbiB3aXRoIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24uCiAgTW9kZWwuY29sbGVjdGlvbiA9IGZ1bmN0aW9uKHJvd3MsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgQ29sbGVjdGlvbigocm93cyB8fCBbXSksIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7bW9kZWw6IHRoaXN9KSk7CiAgfTsKCiAgLy8gQSBgQm9va3NoZWxmYCBpbnN0YW5jZSBtYXkgYmUgdXNlZCBhcyBhIHRvcC1sZXZlbCBwdWItc3ViIGJ1cywgYXMgaXQgbWl4ZXMgaW4gdGhlCiAgLy8gYEV2ZW50c2Agb2JqZWN0LiBJdCBhbHNvIGNvbnRhaW5zIHRoZSB2ZXJzaW9uIG51bWJlciwgYW5kIGEgYFRyYW5zYWN0aW9uYCBtZXRob2QKICAvLyByZWZlcmVuY2luZyB0aGUgY29ycmVjdCB2ZXJzaW9uIG9mIGBrbmV4YCBwYXNzZWQgaW50byB0aGUgb2JqZWN0LgogIF8uZXh0ZW5kKGJvb2tzaGVsZiwgRXZlbnRzLCBFcnJvcnMsIHsKCiAgICAvLyBIZWxwZXIgbWV0aG9kIHRvIHdyYXAgYSBzZXJpZXMgb2YgQm9va3NoZWxmIGFjdGlvbnMgaW4gYSBga25leGAgdHJhbnNhY3Rpb24gYmxvY2s7CiAgICB0cmFuc2FjdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmtuZXgudHJhbnNhY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gUHJvdmlkZXMgYSBuaWNlLCB0ZXN0ZWQsIHN0YW5kYXJkaXplZCB3YXkgb2YgYWRkaW5nIHBsdWdpbnMgdG8gYSBgQm9va3NoZWxmYCBpbnN0YW5jZSwKICAgIC8vIGluamVjdGluZyB0aGUgY3VycmVudCBpbnN0YW5jZSBpbnRvIHRoZSBwbHVnaW4sIHdoaWNoIHNob3VsZCBiZSBhIG1vZHVsZS5leHBvcnRzLgogICAgcGx1Z2luOiBmdW5jdGlvbihwbHVnaW4sIG9wdGlvbnMpIHsKICAgICAgaWYgKF8uaXNTdHJpbmcocGx1Z2luKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXF1aXJlKCcuL3BsdWdpbnMvJyArIHBsdWdpbikodGhpcywgb3B0aW9ucyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVxdWlyZShwbHVnaW4pKHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkocGx1Z2luKSkgewogICAgICAgIF8uZWFjaChwbHVnaW4sIGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgICAgICAgIHRoaXMucGx1Z2luKHBsdWdpbiwgb3B0aW9ucyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGx1Z2luKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9KTsKCiAgLy8gR3JhYiBhIHJlZmVyZW5jZSB0byB0aGUgYGtuZXhgIGluc3RhbmNlIHBhc3NlZCAob3IgY3JlYXRlZCkgaW4gdGhpcyBjb25zdHJ1Y3RvciwKICAvLyBmb3IgY29udmVuaWVuY2UuCiAgYm9va3NoZWxmLmtuZXggPSBrbmV4OwoKICAvLyBUaGUgYGZvcmdlYCBmdW5jdGlvbiBwcm9wZXJseSBpbnN0YW50aWF0ZXMgYSBuZXcgTW9kZWwgb3IgQ29sbGVjdGlvbgogIC8vIHdpdGhvdXQgbmVlZGluZyB0aGUgYG5ld2Agb3BlcmF0b3IuLi4gdG8gbWFrZSBvYmplY3QgY3JlYXRpb24gY2xlYW5lcgogIC8vIGFuZCBtb3JlIGNoYWluYWJsZS4KICBNb2RlbC5mb3JnZSA9IENvbGxlY3Rpb24uZm9yZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0ID0gT2JqZWN0LmNyZWF0ZSh0aGlzLnByb3RvdHlwZSk7CiAgICB2YXIgb2JqID0gdGhpcy5hcHBseShpbnN0LCBhcmd1bWVudHMpOwogICAgcmV0dXJuIChPYmplY3Qob2JqKSA9PT0gb2JqID8gb2JqIDogaW5zdCk7CiAgfTsKCiAgLy8gQXR0YWNoIGB3aGVyZWAsIGBxdWVyeWAsIGFuZCBgZmV0Y2hBbGxgIGFzIHN0YXRpYyBtZXRob2RzLgogIFsnd2hlcmUnLCAncXVlcnknXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWxbbWV0aG9kXSA9CiAgICBDb2xsZWN0aW9uW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5mb3JnZSgpOwogICAgICByZXR1cm4gbW9kZWxbbWV0aG9kXS5hcHBseShtb2RlbCwgYXJndW1lbnRzKTsKICAgIH07CiAgfSk7CiAgTW9kZWwuZmV0Y2hBbGwgPSBmdW5jdGlvbihvcHRpb25zKSB7IHJldHVybiB0aGlzLmZvcmdlKCkuZmV0Y2hBbGwob3B0aW9ucyk7IH07CgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gcmVxdWlyZSgnc2ltcGxlLWV4dGVuZCcpOwoKICByZXR1cm4gYm9va3NoZWxmOwp9OwoKLy8gRmluYWxseSwgZXhwb3J0IGBCb29rc2hlbGZgIHRvIHRoZSB3b3JsZC4KbW9kdWxlLmV4cG9ydHMgPSBCb29rc2hlbGY7Cn0seyIuL2xpYi9iYXNlL2V2ZW50cyI6NCwiLi9saWIvY29sbGVjdGlvbiI6OCwiLi9saWIvZXJyb3JzIjoxMCwiLi9saWIvbW9kZWwiOjEyLCIuL2xpYi9yZWxhdGlvbiI6MTMsImluaGVyaXRzIjo3Niwia25leCI6NzcsImxvZGFzaCI6MTMwLCJzZW12ZXIiOjEzMSwic2ltcGxlLWV4dGVuZCI6MTMyfV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEJhc2UgQ29sbGVjdGlvbgovLyAtLS0tLS0tLS0tLS0tLS0KCi8vIEFsbCBleGVybmFsIGRlcGVuZGVuY2llcyByZXF1aXJlZCBpbiB0aGlzIHNjb3BlLgp2YXIgXyAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBCYWNrYm9uZSAgPSByZXF1aXJlKCdiYWNrYm9uZScpOwoKLy8gQWxsIGNvbXBvbmVudHMgdGhhdCBuZWVkIHRvIGJlIHJlZmVyZW5jZWQgaW4gdGhpcyBzY29wZS4KdmFyIEV2ZW50cyAgICA9IHJlcXVpcmUoJy4vZXZlbnRzJyk7CnZhciBQcm9taXNlICAgPSByZXF1aXJlKCcuL3Byb21pc2UnKTsKdmFyIE1vZGVsQmFzZSA9IHJlcXVpcmUoJy4vbW9kZWwnKTsKCnZhciBhcnJheSAgPSBbXTsKdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCnZhciBDb2xsZWN0aW9uQmFzZSA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogIGlmIChvcHRpb25zKSBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgY29sbGVjdGlvblByb3BzKSk7CiAgdGhpcy5fcmVzZXQoKTsKICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoIV8uaXNGdW5jdGlvbih0aGlzLm1vZGVsKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBIHZhbGlkIGBtb2RlbGAgY29uc3RydWN0b3IgbXVzdCBiZSBkZWZpbmVkIGZvciBhbGwgY29sbGVjdGlvbnMuJyk7CiAgfQogIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwp9OwoKLy8gTGlzdCBvZiBhdHRyaWJ1dGVzIGF0dGFjaGVkIGRpcmVjdGx5IGZyb20gdGhlIGNvbnN0cnVjdG9yJ3Mgb3B0aW9ucyBvYmplY3QuCnZhciBjb2xsZWN0aW9uUHJvcHMgICA9IFsnbW9kZWwnLCAnY29tcGFyYXRvciddOwoKLy8gQSBsaXN0IG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgb21pdHRlZCBmcm9tIHRoZSBgQmFja2JvbmUuTW9kZWwucHJvdG90eXBlYCwgdG8gY3JlYXRlCi8vIGEgZ2VuZXJpYyBjb2xsZWN0aW9uIGJhc2UuCnZhciBjb2xsZWN0aW9uT21pdHRlZCA9IFsnbW9kZWwnLCAnZmV0Y2gnLCAndXJsJywgJ3N5bmMnLCAnY3JlYXRlJ107CgovLyBDb3BpZWQgb3ZlciBmcm9tIEJhY2tib25lLgp2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwoKXy5leHRlbmQoQ29sbGVjdGlvbkJhc2UucHJvdG90eXBlLCBfLm9taXQoQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUsIGNvbGxlY3Rpb25PbWl0dGVkKSwgRXZlbnRzLCB7CgogIC8vIFRoZSBgdGFibGVOYW1lYCBvbiB0aGUgYXNzb2NpYXRlZCBNb2RlbCwgdXNlZCBpbiByZWxhdGlvbiBidWlsZGluZy4KICB0YWJsZU5hbWU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8ucmVzdWx0KHRoaXMubW9kZWwucHJvdG90eXBlLCAndGFibGVOYW1lJyk7CiAgfSwKCiAgLy8gVGhlIGBpZEF0dHJpYnV0ZWAgb24gdGhlIGFzc29jaWF0ZWQgTW9kZWwsIHVzZWQgaW4gcmVsYXRpb24gYnVpbGRpbmcuCiAgaWRBdHRyaWJ1dGU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlOwogIH0sCgogIC8vIEEgc2ltcGxpZmllZCB2ZXJzaW9uIG9mIEJhY2tib25lJ3MgYENvbGxlY3Rpb24jc2V0YCBtZXRob2QsCiAgLy8gcmVtb3ZpbmcgdGhlIGNvbXBhcmF0b3IsIGFuZCBnZXR0aW5nIHJpZCBvZiB0aGUgdGVtcG9yYXJ5IG1vZGVsIGNyZWF0aW9uLAogIC8vIHNpbmNlIHRoZXJlJ3MgKm5vIHdheSogd2UnbGwgYmUgZ2V0dGluZyB0aGUgZGF0YSBpbiBhbiBpbmNvbnNpc3RlbnQKICAvLyBmb3JtIGZyb20gdGhlIGRhdGFiYXNlLgogIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZzsKICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CiAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICB2YXIgb3JkZXIgPSBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgYXR0cnMgPSBtb2RlbHNbaV07CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgIH0KCiAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewogICAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICAgIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVyZ2UpIHsKICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgYSBuZXcgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycywgb3B0aW9ucykpKSBjb250aW51ZTsKICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgfQoKICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICBpZiAocmVtb3ZlKSB7CiAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICB9CiAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKICAgIH0KCiAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICBpZiAodG9BZGQubGVuZ3RoIHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB7CiAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIFthdCwgMF0uY29uY2F0KHRvQWRkKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG9yZGVyKSB7CiAgICAgICAgICB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcmRlciA9IHRvQWRkOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXIubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzOwoKICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgcmV0dXJuIGF0dHJzOwogICAgcmV0dXJuIG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICB9LAoKICAvLyBSdW4gIlByb21pc2UubWFwIiBvdmVyIHRoZSBtb2RlbHMKICBtYXBUaGVuOiBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgcmV0dXJuIFByb21pc2UuYmluZChjb250ZXh0KS50aGVuUmV0dXJuKHRoaXMubW9kZWxzKS5tYXAoaXRlcmF0b3IpOwogIH0sCgogIC8vIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgaW52b2tlLCByZXR1cm5pbmcgYSBgUHJvbWlzZS5hbGxgIHByb21pc2UuCiAgaW52b2tlVGhlbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwodGhpcy5pbnZva2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgfSwKCiAgLy8gUnVuICJyZWR1Y2UiIG92ZXIgdGhlIG1vZGVscyBpbiB0aGUgY29sbGVjdGlvbi4KICByZWR1Y2VUaGVuOiBmdW5jdGlvbihpdGVyYXRvciwgaW5pdGlhbFZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKGNvbnRleHQpLnRoZW5SZXR1cm4odGhpcy5tb2RlbHMpLnJlZHVjZShpdGVyYXRvciwgaW5pdGlhbFZhbHVlKS5iaW5kKCk7CiAgfSwKCiAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0ZWQoJ1RoZSBmZXRjaCBtZXRob2QgaGFzIG5vdCBiZWVuIGltcGxlbWVudGVkJyk7CiAgfQoKfSk7CgovLyBMaXN0IG9mIGF0dHJpYnV0ZXMgYXR0YWNoZWQgZGlyZWN0bHkgZnJvbSB0aGUgYG9wdGlvbnNgIHBhc3NlZCB0byB0aGUgY29uc3RydWN0b3IuCnZhciBtb2RlbFByb3BzID0gWyd0YWJsZU5hbWUnLCAnaGFzVGltZXN0YW1wcyddOwoKQ29sbGVjdGlvbkJhc2UuZXh0ZW5kID0gcmVxdWlyZSgnc2ltcGxlLWV4dGVuZCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uQmFzZTsKCn0seyIuL2V2ZW50cyI6NCwiLi9tb2RlbCI6NSwiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJzaW1wbGUtZXh0ZW5kIjoxMzJ9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gRWFnZXIgQmFzZQovLyAtLS0tLS0tLS0tLS0tLS0KCi8vIFRoZSBFYWdlckJhc2UgcHJvdmlkZXMgYSBzY2FmZm9sZCBmb3IgaGFuZGxpbmcgd2l0aCBlYWdlciByZWxhdGlvbgovLyBwYWlyaW5nLCBieSBxdWV1ZWluZyB0aGUgYXBwcm9wcmlhdGUgcmVsYXRlZCBtZXRob2QgY2FsbHMgd2l0aAovLyBhIGRhdGFiYXNlIHNwZWNpZmljIGBlYWdlckZldGNoYCBtZXRob2QsIHdoaWNoIHRoZW4gbWF5IHV0aWxpemUKLy8gYHB1c2hNb2RlbHNgIGZvciBwYWlyaW5nIHRoZSBtb2RlbHMgZGVwZW5kaW5nIG9uIHRoZSBkYXRhYmFzZSBuZWVkLgoKdmFyIF8gICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgQmFja2JvbmUgID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKdmFyIFByb21pc2UgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKZnVuY3Rpb24gRWFnZXJCYXNlKHBhcmVudCwgcGFyZW50UmVzcG9uc2UsIHRhcmdldCkgewogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMucGFyZW50UmVzcG9uc2UgPSBwYXJlbnRSZXNwb25zZTsKICB0aGlzLnRhcmdldCA9IHRhcmdldDsKfQoKXy5leHRlbmQoRWFnZXJCYXNlLnByb3RvdHlwZSwgewoKICAvLyBUaGlzIGhlbHBlciBmdW5jdGlvbiBpcyB1c2VkIGludGVybmFsbHkgdG8gZGV0ZXJtaW5lIHdoaWNoIHJlbGF0aW9ucwogIC8vIGFyZSBuZWNlc3NhcnkgZm9yIGZldGNoaW5nIGJhc2VkIG9uIHRoZSBgbW9kZWwubG9hZGAgb3IgYHdpdGhSZWxhdGVkYCBvcHRpb24uCiAgZmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciByZWxhdGlvbk5hbWUsIHJlbGF0ZWQsIHJlbGF0aW9uOwogICAgdmFyIHRhcmdldCAgICAgID0gdGhpcy50YXJnZXQ7CiAgICB2YXIgaGFuZGxlZCAgICAgPSB0aGlzLmhhbmRsZWQgPSB7fTsKICAgIHZhciB3aXRoUmVsYXRlZCA9IHRoaXMucHJlcFdpdGhSZWxhdGVkKG9wdGlvbnMud2l0aFJlbGF0ZWQpOwogICAgdmFyIHN1YlJlbGF0ZWQgID0ge307CgogICAgLy8gSW50ZXJuYWwgZmxhZyB0byBkZXRlcm1pbmUgd2hldGhlciB0byBzZXQgdGhlIGN0b3Iocykgb24gdGhlIGBSZWxhdGlvbmAgb2JqZWN0LgogICAgdGFyZ2V0Ll9pc0VhZ2VyID0gdHJ1ZTsKCiAgICAvLyBFYWdlciBsb2FkIGVhY2ggb2YgdGhlIGB3aXRoUmVsYXRlZGAgcmVsYXRpb24gaXRlbSwgc3BsaXR0aW5nIG9uICcuJwogICAgLy8gd2hpY2ggaW5kaWNhdGVzIGEgbmVzdGVkIGVhZ2VyIGxvYWQuCiAgICBmb3IgKHZhciBrZXkgaW4gd2l0aFJlbGF0ZWQpIHsKCiAgICAgIHJlbGF0ZWQgPSBrZXkuc3BsaXQoJy4nKTsKICAgICAgcmVsYXRpb25OYW1lID0gcmVsYXRlZFswXTsKCiAgICAgIC8vIEFkZCBhZGRpdGlvbmFsIGVhZ2VyIGl0ZW1zIHRvIGFuIGFycmF5LCB0byBsb2FkIGF0IHRoZSBuZXh0IGxldmVsIGluIHRoZSBxdWVyeS4KICAgICAgaWYgKHJlbGF0ZWQubGVuZ3RoID4gMSkgewogICAgICAgIHZhciByZWxhdGVkT2JqID0ge307CiAgICAgICAgc3ViUmVsYXRlZFtyZWxhdGlvbk5hbWVdIHx8IChzdWJSZWxhdGVkW3JlbGF0aW9uTmFtZV0gPSBbXSk7CiAgICAgICAgcmVsYXRlZE9ialtyZWxhdGVkLnNsaWNlKDEpLmpvaW4oJy4nKV0gPSB3aXRoUmVsYXRlZFtrZXldOwogICAgICAgIHN1YlJlbGF0ZWRbcmVsYXRpb25OYW1lXS5wdXNoKHJlbGF0ZWRPYmopOwogICAgICB9CgogICAgICAvLyBPbmx5IGFsbG93IG9uZSBvZiBhIGNlcnRhaW4gbmVzdGVkIHR5cGUgcGVyLWxldmVsLgogICAgICBpZiAoaGFuZGxlZFtyZWxhdGlvbk5hbWVdKSBjb250aW51ZTsKCiAgICAgIHJlbGF0aW9uID0gdGFyZ2V0W3JlbGF0aW9uTmFtZV0oKTsKCiAgICAgIGlmICghcmVsYXRpb24pIHRocm93IG5ldyBFcnJvcihyZWxhdGlvbk5hbWUgKyAnIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBtb2RlbC4nKTsKCiAgICAgIGhhbmRsZWRbcmVsYXRpb25OYW1lXSA9IHJlbGF0aW9uOwogICAgfQoKICAgIC8vIERlbGV0ZSB0aGUgaW50ZXJuYWwgZmxhZyBmcm9tIHRoZSBtb2RlbC4KICAgIGRlbGV0ZSB0YXJnZXQuX2lzRWFnZXI7CgogICAgLy8gRmV0Y2ggYWxsIGVhZ2VyIGxvYWRlZCBtb2RlbHMsIGxvYWRpbmcgdGhlbSBvbnRvCiAgICAvLyBhbiBhcnJheSBvZiBwZW5kaW5nIGRlZmVycmVkIG9iamVjdHMsIHdoaWNoIHdpbGwgaGFuZGxlCiAgICAvLyBhbGwgbmVjZXNzYXJ5IHBhaXJpbmcgd2l0aCBwYXJlbnQgb2JqZWN0cywgZXRjLgogICAgdmFyIHBlbmRpbmdEZWZlcnJlZCA9IFtdOwogICAgZm9yIChyZWxhdGlvbk5hbWUgaW4gaGFuZGxlZCkgewogICAgICBwZW5kaW5nRGVmZXJyZWQucHVzaCh0aGlzLmVhZ2VyRmV0Y2gocmVsYXRpb25OYW1lLCBoYW5kbGVkW3JlbGF0aW9uTmFtZV0sIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7CiAgICAgICAgaXNFYWdlcjogdHJ1ZSwKICAgICAgICB3aXRoUmVsYXRlZDogc3ViUmVsYXRlZFtyZWxhdGlvbk5hbWVdLAogICAgICAgIF9iZWZvcmVGbjogd2l0aFJlbGF0ZWRbcmVsYXRpb25OYW1lXSB8fCBub29wCiAgICAgIH0pKSk7CiAgICB9CgogICAgLy8gUmV0dXJuIGEgZGVmZXJyZWQgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBuZXN0ZWQgb2JqZWN0IHN5bmMKICAgIC8vIHJldHVybmluZyB0aGUgb3JpZ2luYWwgcmVzcG9uc2Ugd2hlbiB0aGVzZSBzeW5jcyAmIHBhaXJpbmdzIGFyZSBjb21wbGV0ZS4KICAgIHJldHVybiBQcm9taXNlLmFsbChwZW5kaW5nRGVmZXJyZWQpLnlpZWxkKHRoaXMucGFyZW50UmVzcG9uc2UpOwogIH0pLAoKICAvLyBQcmVwIHRoZSBgd2l0aFJlbGF0ZWRgIG9iamVjdCwgdG8gbm9ybWFsaXplIGludG8gYW4gb2JqZWN0IHdoZXJlIGVhY2gKICAvLyBoYXMgYSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCB3aGVuIHJ1bm5pbmcgdGhlIHF1ZXJ5LgogIHByZXBXaXRoUmVsYXRlZDogZnVuY3Rpb24od2l0aFJlbGF0ZWQpIHsKICAgIGlmICghXy5pc0FycmF5KHdpdGhSZWxhdGVkKSkgd2l0aFJlbGF0ZWQgPSBbd2l0aFJlbGF0ZWRdOwogICAgdmFyIG9iaiA9IHt9OwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB3aXRoUmVsYXRlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHJlbGF0ZWQgPSB3aXRoUmVsYXRlZFtpXTsKICAgICAgXy5pc1N0cmluZyhyZWxhdGVkKSA/IG9ialtyZWxhdGVkXSA9IG5vb3AgOiBfLmV4dGVuZChvYmosIHJlbGF0ZWQpOwogICAgfQogICAgcmV0dXJuIG9iajsKICB9LAoKICAvLyBQdXNoZXMgZWFjaCBvZiB0aGUgaW5jb21pbmcgbW9kZWxzIG9udG8gYSBuZXcgYHJlbGF0ZWRgIGFycmF5LAogIC8vIHdoaWNoIGlzIHVzZWQgdG8gY29ycmVjbHkgcGFpciBhZGRpdGlvbmFsIG5lc3RlZCByZWxhdGlvbnMuCiAgcHVzaE1vZGVsczogZnVuY3Rpb24ocmVsYXRpb25OYW1lLCBoYW5kbGVkLCByZXNwKSB7CiAgICB2YXIgbW9kZWxzICAgICAgPSB0aGlzLnBhcmVudDsKICAgIHZhciByZWxhdGVkRGF0YSA9IGhhbmRsZWQucmVsYXRlZERhdGE7CiAgICB2YXIgcmVsYXRlZCAgICAgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gcmVzcC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcmVsYXRlZC5wdXNoKHJlbGF0ZWREYXRhLmNyZWF0ZU1vZGVsKHJlc3BbaV0pKTsKICAgIH0KICAgIHJldHVybiByZWxhdGVkRGF0YS5lYWdlclBhaXIocmVsYXRpb25OYW1lLCByZWxhdGVkLCBtb2RlbHMpOwogIH0KCn0pOwoKdmFyIG5vb3AgPSBmdW5jdGlvbigpIHt9OwoKbW9kdWxlLmV4cG9ydHMgPSBFYWdlckJhc2U7Cn0seyIuL3Byb21pc2UiOjYsImJhY2tib25lIjoxNSwibG9kYXNoIjoxMzB9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gRXZlbnRzCi8vIC0tLS0tLS0tLS0tLS0tLQoKdmFyIFByb21pc2UgICAgID0gcmVxdWlyZSgnLi9wcm9taXNlJyk7CnZhciBCYWNrYm9uZSAgICA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CnZhciB0cmlnZ2VyVGhlbiA9IHJlcXVpcmUoJ3RyaWdnZXItdGhlbicpOwp2YXIgXyAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKCkJhY2tib25lLkV2ZW50cy5vbmNlID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIC8vaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9KTsKICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKfTsKCi8vIE1peGluIHRoZSBgdHJpZ2dlclRoZW5gIGZ1bmN0aW9uIGludG8gYWxsIHJlbGV2YW50IEJhY2tib25lIG9iamVjdHMsCi8vIHNvIHdlIGNhbiBoYXZlIGV2ZW50IGRyaXZlbiBhc3luYyB2YWxpZGF0aW9ucywgZnVuY3Rpb25zLCBldGMuCnRyaWdnZXJUaGVuKEJhY2tib25lLCBQcm9taXNlKTsKCm1vZHVsZS5leHBvcnRzID0gQmFja2JvbmUuRXZlbnRzOwp9LHsiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJ0cmlnZ2VyLXRoZW4iOjEzM31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBCYXNlIE1vZGVsCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKCnZhciBFdmVudHMgICA9IHJlcXVpcmUoJy4vZXZlbnRzJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKLy8gQSBsaXN0IG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgb21pdHRlZCBmcm9tIHRoZSBgQmFja2JvbmUuTW9kZWwucHJvdG90eXBlYCwgdG8gY3JlYXRlCi8vIGEgZ2VuZXJpYyBtb2RlbCBiYXNlLgp2YXIgbW9kZWxPbWl0dGVkID0gWwogICdjaGFuZ2VkQXR0cmlidXRlcycsICdpc1ZhbGlkJywgJ3ZhbGlkYXRpb25FcnJvcicsCiAgJ3NhdmUnLCAnc3luYycsICdmZXRjaCcsICdkZXN0cm95JywgJ3VybCcsCiAgJ3VybFJvb3QnLCAnX3ZhbGlkYXRlJwpdOwoKLy8gTGlzdCBvZiBhdHRyaWJ1dGVzIGF0dGFjaGVkIGRpcmVjdGx5IGZyb20gdGhlIGBvcHRpb25zYCBwYXNzZWQgdG8gdGhlIGNvbnN0cnVjdG9yLgp2YXIgbW9kZWxQcm9wcyA9IFsndGFibGVOYW1lJywgJ2hhc1RpbWVzdGFtcHMnXTsKCi8vIFRoZSAiTW9kZWxCYXNlIiBpcyBzaW1pbGFyIHRvIHRoZSAnQWN0aXZlIE1vZGVsJyBpbiBSYWlscywKLy8gaXQgZGVmaW5lcyBhIHN0YW5kYXJkIGludGVyZmFjZSBmcm9tIHdoaWNoIG90aGVyIG9iamVjdHMgbWF5Ci8vIGluaGVyaXQuCnZhciBNb2RlbEJhc2UgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogIHRoaXMuYXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdGhpcy5fcmVzZXQoKTsKICB0aGlzLnJlbGF0aW9ucyA9IHt9OwogIHRoaXMuY2lkICA9IF8udW5pcXVlSWQoJ2MnKTsKICBpZiAob3B0aW9ucykgewogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIG1vZGVsUHJvcHMpKTsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogIH0KICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07CgpfLmV4dGVuZChNb2RlbEJhc2UucHJvdG90eXBlLCBfLm9taXQoQmFja2JvbmUuTW9kZWwucHJvdG90eXBlLCBtb2RlbE9taXR0ZWQpLCBFdmVudHMsIHsKCiAgLy8gU2ltaWxhciB0byB0aGUgc3RhbmRhcmQgYEJhY2tib25lYCBzZXQgbWV0aG9kLCBidXQgd2l0aG91dCBpbmRpdmlkdWFsCiAgLy8gY2hhbmdlIGV2ZW50cywgYW5kIGFkZGluZyBkaWZmZXJlbnQgbWVhbmluZyB0byBgY2hhbmdlZGAgYW5kIGBwcmV2aW91c0F0dHJpYnV0ZXNgCiAgLy8gZGVmaW5lZCBhcyB0aGUgbGFzdCAic3luYyInZWQgc3RhdGUgb2YgdGhlIG1vZGVsLgogIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CiAgICB2YXIgYXR0cnM7CgogICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgYXR0cnMgPSBrZXk7CiAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICB9IGVsc2UgewogICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgIH0KICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgdmFyIGhhc0NoYW5nZWQgPSBmYWxzZTsKICAgIHZhciB1bnNldCAgID0gb3B0aW9ucy51bnNldDsKICAgIHZhciBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgdmFyIHByZXYgICAgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgZm9yICh2YXIgYXR0ciBpbiBhdHRycykgewogICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBoYXNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICB9CiAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgfQoKICAgIGlmIChoYXNDaGFuZ2VkICYmICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIFJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYSBzaGFsbG93IGNvcHkgb2YgdGhlIG1vZGVsIGF0dHJpYnV0ZXMsCiAgLy8gYWxvbmcgd2l0aCB0aGUgYHRvSlNPTmAgdmFsdWUgb2YgYW55IHJlbGF0aW9ucywKICAvLyB1bmxlc3MgYHtzaGFsbG93OiB0cnVlfWAgaXMgcGFzc2VkIGluIHRoZSBgb3B0aW9uc2AuCiAgLy8gQWxzbyBpbmNsdWRlcyBfcGl2b3RfIGtleXMgZm9yIHJlbGF0aW9ucyB1bmxlc3MgYHtvbWl0UGl2b3Q6IHRydWV9YAogIC8vIGlzIHBhc3NlZCBpbiBgb3B0aW9uc2AuCiAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2hhbGxvdykgcmV0dXJuIGF0dHJzOwogICAgdmFyIHJlbGF0aW9ucyA9IHRoaXMucmVsYXRpb25zOwogICAgZm9yICh2YXIga2V5IGluIHJlbGF0aW9ucykgewogICAgICB2YXIgcmVsYXRpb24gPSByZWxhdGlvbnNba2V5XTsKICAgICAgYXR0cnNba2V5XSA9IHJlbGF0aW9uLnRvSlNPTiA/IHJlbGF0aW9uLnRvSlNPTihvcHRpb25zKSA6IHJlbGF0aW9uOwogICAgfQogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vbWl0UGl2b3QpIHJldHVybiBhdHRyczsKICAgIGlmICh0aGlzLnBpdm90KSB7CiAgICAgIHZhciBwaXZvdCA9IHRoaXMucGl2b3QuYXR0cmlidXRlczsKICAgICAgZm9yIChrZXkgaW4gcGl2b3QpIHsKICAgICAgICBhdHRyc1snX3Bpdm90XycgKyBrZXldID0gcGl2b3Rba2V5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGF0dHJzOwogIH0sCgogIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgcmV0dXJuIHJlc3A7CiAgfSwKCiAgLy8gKipmb3JtYXQqKiBjb252ZXJ0cyBhIG1vZGVsIGludG8gdGhlIHZhbHVlcyB0aGF0IHNob3VsZCBiZSBzYXZlZCBpbnRvCiAgLy8gdGhlIGRhdGFiYXNlIHRhYmxlLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIGRhdGEgYWxvbmcuCiAgZm9ybWF0OiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgcmV0dXJuIGF0dHJzOwogIH0sCgogIC8vIFJldHVybnMgdGhlIHJlbGF0ZWQgaXRlbSwgb3IgY3JlYXRlcyBhIG5ldwogIC8vIHJlbGF0ZWQgaXRlbSBieSBjcmVhdGluZyBhIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uLgogIHJlbGF0ZWQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHJldHVybiB0aGlzLnJlbGF0aW9uc1tuYW1lXSB8fCAodGhpc1tuYW1lXSA/IHRoaXMucmVsYXRpb25zW25hbWVdID0gdGhpc1tuYW1lXSgpIDogdm9pZCAwKTsKICB9LAoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZSwKICAvLyBpbmNsdWRpbmcgYW55IHJlbGF0aW9ucyBvbiB0aGUgY3VycmVudCBtb2RlbC4KICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgdmFyIHJlbGF0aW9ucyA9IHRoaXMucmVsYXRpb25zOwogICAgZm9yICh2YXIga2V5IGluIHJlbGF0aW9ucykgewogICAgICBtb2RlbC5yZWxhdGlvbnNba2V5XSA9IHJlbGF0aW9uc1trZXldLmNsb25lKCk7CiAgICB9CiAgICBtb2RlbC5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgbW9kZWwuY2hhbmdlZCA9IF8uY2xvbmUodGhpcy5jaGFuZ2VkKTsKICAgIHJldHVybiBtb2RlbDsKICB9LAoKICAvLyBTZXRzIHRoZSB0aW1lc3RhbXBzIGJlZm9yZSBzYXZpbmcgdGhlIG1vZGVsLgogIHRpbWVzdGFtcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgdmFyIGtleXMgPSAoXy5pc0FycmF5KHRoaXMuaGFzVGltZXN0YW1wcykgPyB0aGlzLmhhc1RpbWVzdGFtcHMgOiBbJ2NyZWF0ZWRfYXQnLCAndXBkYXRlZF9hdCddKTsKICAgIHZhciB2YWxzID0ge307CiAgICBpZiAoa2V5c1swXSkgewogICAgICBpZiAodGhpcy5pc05ldyhvcHRpb25zKSkgewogICAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zLm1ldGhvZCAhPT0gJ3VwZGF0ZScpIHsKICAgICAgICAgIHZhbHNba2V5c1swXV0gPSBkOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWV0aG9kID09PSAnaW5zZXJ0JykgewogICAgICAgIHZhbHNba2V5c1swXV0gPSBkOwogICAgICB9CiAgICB9CiAgICBpZiAoa2V5c1sxXSkgdmFsc1trZXlzWzFdXSA9IGQ7CiAgICByZXR1cm4gdmFsczsKICB9LAoKICAvLyBDYWxsZWQgYWZ0ZXIgYSBgc3luY2AgYWN0aW9uIChzYXZlLCBmZXRjaCwgZGVsZXRlKSAtCiAgLy8gcmVzZXRzIHRoZSBgX3ByZXZpb3VzQXR0cmlidXRlc2AgYW5kIGBjaGFuZ2VkYCBoYXNoIGZvciB0aGUgbW9kZWwuCiAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uZXh0ZW5kKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuYXR0cmlidXRlcyk7CiAgICB0aGlzLmNoYW5nZWQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgZmV0Y2g6IGZ1bmN0aW9uKCkge30sCgogIHNhdmU6IGZ1bmN0aW9uKCkge30sCgogIC8vIERlc3Ryb3kgYSBtb2RlbCwgY2FsbGluZyBhICJkZWxldGUiIGJhc2VkIG9uIGl0cyBgaWRBdHRyaWJ1dGVgLgogIC8vIEEgImRlc3Ryb3lpbmciIGFuZCAiZGVzdHJveWVkIiBhcmUgdHJpZ2dlcmVkIG9uIHRoZSBtb2RlbCBiZWZvcmUKICAvLyBhbmQgYWZ0ZXIgdGhlIG1vZGVsIGlzIGRlc3Ryb3llZCwgcmVzcGVjdGl2ZWx5LiBJZiBhbiBlcnJvciBpcyB0aHJvd24KICAvLyBkdXJpbmcgdGhlICJkZXN0cm95aW5nIiBldmVudCwgdGhlIG1vZGVsIHdpbGwgbm90IGJlIGRlc3Ryb3llZC4KICBkZXN0cm95OiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIHZhciBzeW5jID0gdGhpcy5zeW5jKG9wdGlvbnMpOwogICAgb3B0aW9ucy5xdWVyeSA9IHN5bmMucXVlcnk7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdkZXN0cm95aW5nJywgdGhpcywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3luYy5kZWwoKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzcCkgewogICAgICB0aGlzLmNsZWFyKCk7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdkZXN0cm95ZWQnLCB0aGlzLCByZXNwLCBvcHRpb25zKTsKICAgIH0pLnRoZW4odGhpcy5fcmVzZXQpOwogIH0pCgp9KTsKCk1vZGVsQmFzZS5leHRlbmQgPSByZXF1aXJlKCdzaW1wbGUtZXh0ZW5kJyk7Cgptb2R1bGUuZXhwb3J0cyA9IE1vZGVsQmFzZTsKCn0seyIuL2V2ZW50cyI6NCwiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJzaW1wbGUtZXh0ZW5kIjoxMzJ9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZC9qcy9tYWluL3Byb21pc2UnKSgpOwoKUHJvbWlzZS5wcm90b3R5cGUueWllbGQgPSBQcm9taXNlLnByb3RvdHlwZS5yZXR1cm47ClByb21pc2UucHJvdG90eXBlLmVuc3VyZSA9IFByb21pc2UucHJvdG90eXBlLmxhc3RseTsKUHJvbWlzZS5wcm90b3R5cGUub3RoZXJ3aXNlID0gUHJvbWlzZS5wcm90b3R5cGUuY2F1Z2h0OwpQcm9taXNlLnByb3RvdHlwZS5leGVjID0gUHJvbWlzZS5wcm90b3R5cGUubm9kZWlmeTsKClByb21pc2UucmVzb2x2ZSA9IFByb21pc2UuZnVsZmlsbGVkOwpQcm9taXNlLnJlamVjdCAgPSBQcm9taXNlLnJlamVjdGVkOwoKbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlOwp9LHsiYmx1ZWJpcmQvanMvbWFpbi9wcm9taXNlIjozNX1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBCYXNlIFJlbGF0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLQoKdmFyIF8gICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBCYWNrYm9uZSAgICAgICA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CnZhciBDb2xsZWN0aW9uQmFzZSA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwoKLy8gVXNlZCBpbnRlcm5hbGx5LCB0aGUgYFJlbGF0aW9uYCBoZWxwcyBpbiBzaW1wbGlmeWluZyB0aGUgcmVsYXRpb25zaGlwIGJ1aWxkaW5nLAovLyBjZW50cmFsaXppbmcgYWxsIGxvZ2ljIGRlYWxpbmcgd2l0aCB0eXBlICYgb3B0aW9uIGhhbmRsaW5nLgpmdW5jdGlvbiBSZWxhdGlvbkJhc2UodHlwZSwgVGFyZ2V0LCBvcHRpb25zKSB7CiAgdGhpcy50eXBlID0gdHlwZTsKICBpZiAodGhpcy50YXJnZXQgPSBUYXJnZXQpIHsKICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICAgPSBfLnJlc3VsdChUYXJnZXQucHJvdG90eXBlLCAndGFibGVOYW1lJyk7CiAgICB0aGlzLnRhcmdldElkQXR0cmlidXRlID0gXy5yZXN1bHQoVGFyZ2V0LnByb3RvdHlwZSwgJ2lkQXR0cmlidXRlJyk7CiAgfQogIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwp9CgpfLmV4dGVuZChSZWxhdGlvbkJhc2UucHJvdG90eXBlLCB7CgogIC8vIENyZWF0ZXMgYSBuZXcgcmVsYXRpb24gaW5zdGFuY2UsIHVzZWQgYnkgdGhlIGBFYWdlcmAgcmVsYXRpb24gaW4KICAvLyBkZWFsaW5nIHdpdGggYG1vcnBoVG9gIGNhc2VzLCB3aGVyZSB0aGUgc2FtZSByZWxhdGlvbiBpcyB0YXJnZXRpbmcgbXVsdGlwbGUgbW9kZWxzLgogIGluc3RhbmNlOiBmdW5jdGlvbih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpOwogIH0sCgogIC8vIENyZWF0ZXMgYSBuZXcsIHVucGFyc2VkIG1vZGVsLCB1c2VkIGludGVybmFsbHkgaW4gdGhlIGVhZ2VyIGZldGNoIGhlbHBlcgogIC8vIG1ldGhvZHMuIChQYXJzaW5nIG1heSBtdXRhdGUgaW5mb3JtYXRpb24gbmVjZXNzYXJ5IGZvciBlYWdlciBwYWlyaW5nLikKICBjcmVhdGVNb2RlbDogZnVuY3Rpb24oZGF0YSkgewogICAgaWYgKHRoaXMudGFyZ2V0LnByb3RvdHlwZSBpbnN0YW5jZW9mIENvbGxlY3Rpb25CYXNlKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy50YXJnZXQucHJvdG90eXBlLm1vZGVsKGRhdGEpLl9yZXNldCgpOwogICAgfQogICAgcmV0dXJuIG5ldyB0aGlzLnRhcmdldChkYXRhKS5fcmVzZXQoKTsKICB9LAoKICAvLyBFYWdlciBwYWlyIHRoZSBtb2RlbHMuCiAgZWFnZXJQYWlyOiBmdW5jdGlvbigpIHt9Cgp9KTsKClJlbGF0aW9uQmFzZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7Cgptb2R1bGUuZXhwb3J0cyA9IFJlbGF0aW9uQmFzZTsKfSx7Ii4vY29sbGVjdGlvbiI6MiwiYmFja2JvbmUiOjE1LCJsb2Rhc2giOjEzMH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb2xsZWN0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCnZhciBTeW5jICAgICAgICAgICA9IHJlcXVpcmUoJy4vc3luYycpOwp2YXIgSGVscGVycyAgICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIEVhZ2VyUmVsYXRpb24gID0gcmVxdWlyZSgnLi9lYWdlcicpOwp2YXIgRXJyb3JzICAgICAgICAgPSByZXF1aXJlKCcuL2Vycm9ycycpOwoKdmFyIENvbGxlY3Rpb25CYXNlID0gcmVxdWlyZSgnLi9iYXNlL2NvbGxlY3Rpb24nKTsKdmFyIFByb21pc2UgICAgICAgID0gcmVxdWlyZSgnLi9iYXNlL3Byb21pc2UnKTsKCmZ1bmN0aW9uIEJvb2tzaGVsZkNvbGxlY3Rpb24oKSB7CiAgQ29sbGVjdGlvbkJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZDb2xsZWN0aW9uLCBDb2xsZWN0aW9uQmFzZSk7CgpCb29rc2hlbGZDb2xsZWN0aW9uLkVtcHR5RXJyb3IgPSBFcnJvcnMuRW1wdHlFcnJvcjsKCl8uZXh0ZW5kKEJvb2tzaGVsZkNvbGxlY3Rpb24ucHJvdG90eXBlLCB7CgogIC8vIFVzZWQgdG8gZGVmaW5lIHBhc3N0aHJvdWdoIHJlbGF0aW9uc2hpcHMgLSBgaGFzT25lYCwgYGhhc01hbnlgLAogIC8vIGBiZWxvbmdzVG9gIG9yIGBiZWxvbmdzVG9NYW55YCwgInRocm91Z2giIGEgYEludGVyaW1gIG1vZGVsIG9yIGNvbGxlY3Rpb24uCiAgdGhyb3VnaDogZnVuY3Rpb24oSW50ZXJpbSwgZm9yZWlnbktleSwgb3RoZXJLZXkpIHsKICAgIHJldHVybiB0aGlzLnJlbGF0ZWREYXRhLnRocm91Z2godGhpcywgSW50ZXJpbSwge3Rocm91Z2hGb3JlaWduS2V5OiBmb3JlaWduS2V5LCBvdGhlcktleTogb3RoZXJLZXl9KTsKICB9LAoKICAvLyBGZXRjaCB0aGUgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUgbW9kZWxzCiAgLy8gZm9yIHRoZSBxdWVyeSB3aGVuIHRoZXkgYXJyaXZlLgogIGZldGNoOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIHJldHVybiB0aGlzLnN5bmMob3B0aW9ucykKICAgICAgLnNlbGVjdCgpCiAgICAgIC5iaW5kKHRoaXMpCiAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAoIXJlc3BvbnNlIHx8IHJlc3BvbnNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgaWYgKG9wdGlvbnMucmVxdWlyZSkgdGhyb3cgbmV3IEVycm9ycy5FbXB0eUVycm9yKCdFbXB0eVJlc3BvbnNlJyk7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobnVsbCk7CiAgICAgICAgfQogICAgICB9KQoKICAgICAgLy8gTm93LCBsb2FkIGFsbCBvZiB0aGUgZGF0YSBvbnRvIHRoZSBjb2xsZWN0aW9uIGFzIG5lY2Vzc2FyeS4KICAgICAgLnRhcCh0aGlzLl9oYW5kbGVSZXNwb25zZSkKCiAgICAgIC8vIElmIHRoZSAid2l0aFJlbGF0ZWQiIGlzIHNwZWNpZmllZCwgd2UgYWxzbyBuZWVkIHRvIGVhZ2VyIGxvYWQgYWxsIG9mIHRoZQogICAgICAvLyBkYXRhIG9uIHRoZSBjb2xsZWN0aW9uLCBhcyBhIHNpZGUtZWZmZWN0LCBiZWZvcmUgd2UgdWx0aW1hdGVseSBqdW1wIGludG8gdGhlCiAgICAgIC8vIG5leHQgc3RlcCBvZiB0aGUgY29sbGVjdGlvbi4gU2luY2UgdGhlIGBjb2x1bW5zYCBhcmUgb25seSByZWxldmFudCB0byB0aGUgY3VycmVudAogICAgICAvLyBsZXZlbCwgZW5zdXJlIHRob3NlIGFyZSBvbWl0dGVkIGZyb20gdGhlIG9wdGlvbnMuCiAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAob3B0aW9ucy53aXRoUmVsYXRlZCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUVhZ2VyKHJlc3BvbnNlLCBfLm9taXQob3B0aW9ucywgJ2NvbHVtbnMnKSk7CiAgICAgICAgfQogICAgICB9KQogICAgICAudGFwKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2ZldGNoZWQnLCB0aGlzLCByZXNwb25zZSwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyICE9PSBudWxsKSB0aHJvdyBlcnI7CiAgICAgICAgdGhpcy5yZXNldChbXSwge3NpbGVudDogdHJ1ZX0pOwogICAgICB9KQogICAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBGZXRjaGVzIGEgc2luZ2xlIG1vZGVsIGZyb20gdGhlIGNvbGxlY3Rpb24sIHVzZWZ1bCBvbiByZWxhdGVkIGNvbGxlY3Rpb25zLgogIGZldGNoT25lOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbDsKICAgIG1vZGVsLl9rbmV4ID0gdGhpcy5xdWVyeSgpLmNsb25lKCk7CiAgICB0aGlzLnJlc2V0UXVlcnkoKTsKICAgIGlmICh0aGlzLnJlbGF0ZWREYXRhKSBtb2RlbC5yZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICByZXR1cm4gbW9kZWwuZmV0Y2gob3B0aW9ucyk7CiAgfSksCgogIC8vIEVhZ2VyIGxvYWRzIHJlbGF0aW9uc2hpcHMgb250byBhbiBhbHJlYWR5IHBvcHVsYXRlZCBgQ29sbGVjdGlvbmAgaW5zdGFuY2UuCiAgbG9hZDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ocmVsYXRpb25zLCBvcHRpb25zKSB7CiAgICBfLmlzQXJyYXkocmVsYXRpb25zKSB8fCAocmVsYXRpb25zID0gW3JlbGF0aW9uc10pOwogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7c2hhbGxvdzogdHJ1ZSwgd2l0aFJlbGF0ZWQ6IHJlbGF0aW9uc30pOwogICAgcmV0dXJuIG5ldyBFYWdlclJlbGF0aW9uKHRoaXMubW9kZWxzLCB0aGlzLnRvSlNPTihvcHRpb25zKSwgbmV3IHRoaXMubW9kZWwoKSkKICAgICAgLmZldGNoKG9wdGlvbnMpCiAgICAgIC5yZXR1cm4odGhpcyk7CiAgfSksCgogIC8vIFNob3J0Y3V0IGZvciBjcmVhdGluZyBhIG5ldyBtb2RlbCwgc2F2aW5nLCBhbmQgYWRkaW5nIHRvIHRoZSBjb2xsZWN0aW9uLgogIC8vIFJldHVybnMgYSBwcm9taXNlIHdoaWNoIHdpbGwgcmVzb2x2ZSB3aXRoIHRoZSBtb2RlbCBhZGRlZCB0byB0aGUgY29sbGVjdGlvbi4KICAvLyBJZiB0aGUgbW9kZWwgaXMgYSByZWxhdGlvbiwgcHV0IHRoZSBgZm9yZWlnbktleWAgYW5kIGBma1ZhbHVlYCBmcm9tIHRoZSBgcmVsYXRlZERhdGFgCiAgLy8gaGFzaCBpbnRvIHRoZSBpbnNlcnRlZCBtb2RlbC4gQWxzbywgaWYgdGhlIG1vZGVsIGlzIGEgYG1hbnlUb01hbnlgIHJlbGF0aW9uLAogIC8vIGF1dG9tYXRpY2FsbHkgY3JlYXRlIHRoZSBqb2luaW5nIG1vZGVsIHVwb24gaW5zZXJ0aW9uLgogIGNyZWF0ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgdmFyIHJlbGF0ZWREYXRhID0gdGhpcy5yZWxhdGVkRGF0YTsKICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKCiAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGFkZGVkIHRoaW5ncyBvbiB0aGUgcXVlcnkgY2hhaW4sCiAgICAvLyB0aGVzZSBhcmUgbGlrZWx5IGludGVuZGVkIGZvciB0aGUgbW9kZWwuCiAgICBpZiAodGhpcy5fa25leCkgewogICAgICBtb2RlbC5fa25leCA9IHRoaXMuX2tuZXg7CiAgICAgIHRoaXMucmVzZXRRdWVyeSgpOwogICAgfQogICAgcmV0dXJuIEhlbHBlcnMKICAgICAgLnNhdmVDb25zdHJhaW50cyhtb2RlbCwgcmVsYXRlZERhdGEpCiAgICAgIC5zYXZlKG51bGwsIG9wdGlvbnMpCiAgICAgIC5iaW5kKHRoaXMpCiAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChyZWxhdGVkRGF0YSAmJiAocmVsYXRlZERhdGEudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknIHx8IHJlbGF0ZWREYXRhLmlzVGhyb3VnaCgpKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoKG1vZGVsLCBfLm9taXQob3B0aW9ucywgJ3F1ZXJ5JykpOwogICAgICAgIH0KICAgICAgfSkKICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7IHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsgfSkKICAgICAgLnJldHVybihtb2RlbCk7CiAgfSksCgogIC8vIFJlc2V0IHRoZSBxdWVyeSBidWlsZGVyLCBjYWxsZWQgaW50ZXJuYWxseQogIC8vIGVhY2ggdGltZSBhIHF1ZXJ5IGlzIHJ1bi4KICByZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2tuZXggPSBudWxsOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLy8gUmV0dXJucyBhbiBpbnN0YW5jZSBvZiB0aGUgcXVlcnkgYnVpbGRlci4KICBxdWVyeTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gSGVscGVycy5xdWVyeSh0aGlzLCBfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgfSwKCiAgLy8gQ3JlYXRlcyBhbmQgcmV0dXJucyBhIG5ldyBgQm9va3NoZWxmLlN5bmNgIGluc3RhbmNlLgogIHN5bmM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgU3luYyh0aGlzLCBvcHRpb25zKTsKICB9LAoKICAvLyBIYW5kbGVzIHRoZSByZXNwb25zZSBkYXRhIGZvciB0aGUgY29sbGVjdGlvbiwgcmV0dXJuaW5nIGZyb20gdGhlIGNvbGxlY3Rpb24ncyBmZXRjaCBjYWxsLgogIF9oYW5kbGVSZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgIHZhciByZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB0aGlzLnNldChyZXNwb25zZSwge3NpbGVudDogdHJ1ZSwgcGFyc2U6IHRydWV9KS5pbnZva2UoJ19yZXNldCcpOwogICAgaWYgKHJlbGF0ZWREYXRhICYmIHJlbGF0ZWREYXRhLmlzSm9pbmVkKCkpIHsKICAgICAgcmVsYXRlZERhdGEucGFyc2VQaXZvdCh0aGlzLm1vZGVscyk7CiAgICB9CiAgfSwKCiAgLy8gSGFuZGxlIHRoZSByZWxhdGVkIGRhdGEgbG9hZGluZyBvbiB0aGUgY29sbGVjdGlvbi4KICBfaGFuZGxlRWFnZXI6IGZ1bmN0aW9uKHJlc3BvbnNlLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEVhZ2VyUmVsYXRpb24odGhpcy5tb2RlbHMsIHJlc3BvbnNlLCBuZXcgdGhpcy5tb2RlbCgpKS5mZXRjaChvcHRpb25zKTsKICB9Cgp9KTsKCm1vZHVsZS5leHBvcnRzID0gQm9va3NoZWxmQ29sbGVjdGlvbjsKfSx7Ii4vYmFzZS9jb2xsZWN0aW9uIjoyLCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9lYWdlciI6OSwiLi9lcnJvcnMiOjEwLCIuL2hlbHBlcnMiOjExLCIuL3N5bmMiOjE0LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEVhZ2VyUmVsYXRpb24KLy8gLS0tLS0tLS0tLS0tLS0tCnZhciBfICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Cgp2YXIgSGVscGVycyAgID0gcmVxdWlyZSgnLi9oZWxwZXJzJyk7CnZhciBQcm9taXNlICAgPSByZXF1aXJlKCcuL2Jhc2UvcHJvbWlzZScpOwp2YXIgRWFnZXJCYXNlID0gcmVxdWlyZSgnLi9iYXNlL2VhZ2VyJyk7CgovLyBBbiBgRWFnZXJSZWxhdGlvbmAgb2JqZWN0IHRlbXBvcmFyaWx5IHN0b3JlcyB0aGUgbW9kZWxzIGZyb20gYW4gZWFnZXIgbG9hZCwKLy8gYW5kIGhhbmRsZXMgbWF0Y2hpbmcgZWFnZXIgbG9hZGVkIG9iamVjdHMgd2l0aCB0aGVpciBwYXJlbnQocykuIFRoZSBgdGVtcE1vZGVsYAovLyBpcyBvbmx5IHVzZWQgdG8gcmV0cmlldmUgdGhlIHZhbHVlIG9mIHRoZSByZWxhdGlvbiBtZXRob2QsIHRvIGtub3cgdGhlIGNvbnN0cmFpbnMKLy8gZm9yIHRoZSBlYWdlciBxdWVyeS4KZnVuY3Rpb24gRWFnZXJSZWxhdGlvbigpIHsKICBFYWdlckJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhFYWdlclJlbGF0aW9uLCBFYWdlckJhc2UpOwoKXy5leHRlbmQoRWFnZXJSZWxhdGlvbi5wcm90b3R5cGUsIHsKCiAgLy8gSGFuZGxlcyBhbiBlYWdlciBsb2FkZWQgZmV0Y2gsIHBhc3NpbmcgdGhlIG5hbWUgb2YgdGhlIGl0ZW0gd2UncmUgZmV0Y2hpbmcgZm9yLAogIC8vIGFuZCBhbnkgb3B0aW9ucyBuZWVkZWQgZm9yIHRoZSBjdXJyZW50IGZldGNoLgogIGVhZ2VyRmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKHJlbGF0aW9uTmFtZSwgaGFuZGxlZCwgb3B0aW9ucykgewogICAgdmFyIHJlbGF0ZWREYXRhID0gaGFuZGxlZC5yZWxhdGVkRGF0YTsKCiAgICAvLyBza2lwIGVhZ2VyIGxvYWRpbmcgZm9yIHJvd3Mgd2hlcmUgdGhlIGZvcmVpZ24ga2V5IGlzbid0IHNldAogICAgaWYgKHJlbGF0ZWREYXRhLnBhcmVudEZrID09PSBudWxsKSByZXR1cm47CgogICAgaWYgKHJlbGF0ZWREYXRhLnR5cGUgPT09ICdtb3JwaFRvJykgcmV0dXJuIHRoaXMubW9ycGhUb0ZldGNoKHJlbGF0aW9uTmFtZSwgcmVsYXRlZERhdGEsIG9wdGlvbnMpOwoKICAgIHJldHVybiBoYW5kbGVkCiAgICAgIC5zeW5jKF8uZXh0ZW5kKG9wdGlvbnMsIHtwYXJlbnRSZXNwb25zZTogdGhpcy5wYXJlbnRSZXNwb25zZX0pKQogICAgICAuc2VsZWN0KCkKICAgICAgLmJpbmQodGhpcykKICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIHJldHVybiB0aGlzLl9lYWdlckxvYWRIZWxwZXIocmVzcG9uc2UsIHJlbGF0aW9uTmFtZSwgaGFuZGxlZCwgXy5vbWl0KG9wdGlvbnMsICdwYXJlbnRSZXNwb25zZScpKTsKICAgICAgfSk7CiAgfSksCgogIC8vIFNwZWNpYWwgaGFuZGxlciBmb3IgdGhlIGVhZ2VyIGxvYWRlZCBtb3JwaC10byByZWxhdGlvbnMsIHRoaXMgaGFuZGxlcwogIC8vIHRoZSBmYWN0IHRoYXQgdGhlcmUgYXJlIHNldmVyYWwgcG90ZW50aWFsIG1vZGVscyB0aGF0IHdlIG5lZWQgdG8gYmUgZmV0Y2hpbmcgYWdhaW5zdC4KICAvLyBwYWlyaW5nIHRoZW0gdXAgb250byBhIHNpbmdsZSByZXNwb25zZSBmb3IgdGhlIGVhZ2VyIGxvYWRpbmcuCiAgbW9ycGhUb0ZldGNoOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihyZWxhdGlvbk5hbWUsIHJlbGF0ZWREYXRhLCBvcHRpb25zKSB7CiAgICB2YXIgZ3JvdXBzID0gXy5ncm91cEJ5KHRoaXMucGFyZW50LCBmdW5jdGlvbihtKSB7CiAgICAgIHZhciB0eXBlS2V5TmFtZSA9IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzICYmIHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzWzBdID8gcmVsYXRlZERhdGEuY29sdW1uTmFtZXNbMF0gOiByZWxhdGVkRGF0YS5tb3JwaE5hbWUgKyAnX3R5cGUnOwogICAgICByZXR1cm4gbS5nZXQodHlwZUtleU5hbWUpOwogICAgfSk7CiAgICB2YXIgcGVuZGluZyA9IF8ucmVkdWNlKGdyb3VwcywgZnVuY3Rpb24obWVtbywgdmFsLCBncm91cCkgewogICAgICB2YXIgVGFyZ2V0ID0gSGVscGVycy5tb3JwaENhbmRpZGF0ZShyZWxhdGVkRGF0YS5jYW5kaWRhdGVzLCBncm91cCk7CiAgICAgIHZhciB0YXJnZXQgPSBuZXcgVGFyZ2V0KCk7CiAgICAgIHZhciBpZEtleU5hbWUgPSByZWxhdGVkRGF0YS5jb2x1bW5OYW1lcyAmJiByZWxhdGVkRGF0YS5jb2x1bW5OYW1lc1sxXSA/IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzWzFdIDogcmVsYXRlZERhdGEubW9ycGhOYW1lICsgJ19pZCc7CiAgICAgIG1lbW8ucHVzaCh0YXJnZXQKICAgICAgICAucXVlcnkoJ3doZXJlSW4nLAogICAgICAgICAgXy5yZXN1bHQodGFyZ2V0LCAnaWRBdHRyaWJ1dGUnKSwKICAgICAgICAgIF8udW5pcShfLmludm9rZShncm91cHNbZ3JvdXBdLCAnZ2V0JywgaWRLZXlOYW1lKSkKICAgICAgICApCiAgICAgICAgLnN5bmMob3B0aW9ucykKICAgICAgICAuc2VsZWN0KCkKICAgICAgICAuYmluZCh0aGlzKQogICAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9lYWdlckxvYWRIZWxwZXIocmVzcG9uc2UsIHJlbGF0aW9uTmFtZSwgewogICAgICAgICAgICByZWxhdGVkRGF0YTogcmVsYXRlZERhdGEuaW5zdGFuY2UoJ21vcnBoVG8nLCBUYXJnZXQsIHttb3JwaE5hbWU6IHJlbGF0ZWREYXRhLm1vcnBoTmFtZSwgY29sdW1uTmFtZXM6IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzfSkKICAgICAgICAgIH0sIG9wdGlvbnMpOwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gbWVtbzsKICAgIH0sIFtdLCB0aGlzKTsKICAgIHJldHVybiBQcm9taXNlLmFsbChwZW5kaW5nKS50aGVuKGZ1bmN0aW9uKHJlc3BzKSB7CiAgICAgIHJldHVybiBfLmZsYXR0ZW4ocmVzcHMpOwogICAgfSk7CiAgfSksCgogIC8vIEhhbmRsZXMgdGhlIGVhZ2VyIGxvYWQgZm9yIGJvdGggdGhlIGBtb3JwaFRvYCBhbmQgcmVndWxhciBjYXNlcy4KICBfZWFnZXJMb2FkSGVscGVyOiBmdW5jdGlvbihyZXNwb25zZSwgcmVsYXRpb25OYW1lLCBoYW5kbGVkLCBvcHRpb25zKSB7CiAgICB2YXIgcmVsYXRlZE1vZGVscyA9IHRoaXMucHVzaE1vZGVscyhyZWxhdGlvbk5hbWUsIGhhbmRsZWQsIHJlc3BvbnNlKTsKICAgIHZhciByZWxhdGVkRGF0YSAgID0gaGFuZGxlZC5yZWxhdGVkRGF0YTsKCiAgICAvLyBJZiB0aGVyZSBpcyBhIHJlc3BvbnNlLCBmZXRjaCBhZGRpdGlvbmFsIG5lc3RlZCBlYWdlciByZWxhdGlvbnMsIGlmIGFueS4KICAgIGlmIChyZXNwb25zZS5sZW5ndGggPiAwICYmIG9wdGlvbnMud2l0aFJlbGF0ZWQpIHsKICAgICAgdmFyIHJlbGF0ZWRNb2RlbCA9IHJlbGF0ZWREYXRhLmNyZWF0ZU1vZGVsKCk7CgogICAgICAvLyBJZiB0aGlzIGlzIGEgYG1vcnBoVG9gIHJlbGF0aW9uLCB3ZSBuZWVkIHRvIGRvIGFkZGl0aW9uYWwgcHJvY2Vzc2luZwogICAgICAvLyB0byBlbnN1cmUgd2UgZG9uJ3QgdHJ5IHRvIGxvYWQgYW55IHJlbGF0aW9ucyB0aGF0IGRvbid0IGxvb2sgdG8gZXhpc3QuCiAgICAgIGlmIChyZWxhdGVkRGF0YS50eXBlID09PSAnbW9ycGhUbycpIHsKICAgICAgICB2YXIgd2l0aFJlbGF0ZWQgPSB0aGlzLl9maWx0ZXJSZWxhdGVkKHJlbGF0ZWRNb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHdpdGhSZWxhdGVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3dpdGhSZWxhdGVkOiB3aXRoUmVsYXRlZH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgRWFnZXJSZWxhdGlvbihyZWxhdGVkTW9kZWxzLCByZXNwb25zZSwgcmVsYXRlZE1vZGVsKS5mZXRjaChvcHRpb25zKS5yZXR1cm4ocmVzcG9uc2UpOwogICAgfQogIH0sCgogIC8vIEZpbHRlcnMgdGhlIGB3aXRoUmVsYXRlZGAgb24gYSBgbW9ycGhUb2AgcmVsYXRpb24sIHRvIGVuc3VyZSB0aGF0IG9ubHkgdmFsaWQKICAvLyByZWxhdGlvbnMgYXJlIGF0dGVtcHRlZCBmb3IgbG9hZGluZy4KICBfZmlsdGVyUmVsYXRlZDogZnVuY3Rpb24ocmVsYXRlZE1vZGVsLCBvcHRpb25zKSB7CgogICAgLy8gQnkgdGhpcyBwb2ludCwgYWxsIHdpdGhSZWxhdGVkIHNob3VsZCBiZSB0dXJuZWQgaW50byBhIGhhc2gsIHNvIGl0IHNob3VsZAogICAgLy8gYmUgZmFpcmx5IHNpbXBsZSB0byBwcm9jZXNzIGJ5IHNwbGl0dGluZyBvbiB0aGUgZG90cy4KICAgIHJldHVybiBfLnJlZHVjZShvcHRpb25zLndpdGhSZWxhdGVkLCBmdW5jdGlvbihtZW1vLCB2YWwpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHZhbCkgewogICAgICAgIHZhciBzZWcgPSBrZXkuc3BsaXQoJy4nKVswXTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlbGF0ZWRNb2RlbFtzZWddKSkgbWVtby5wdXNoKHZhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1lbW87CiAgICB9LCBbXSk7CiAgfQoKfSk7Cgptb2R1bGUuZXhwb3J0cyA9IEVhZ2VyUmVsYXRpb247Cgp9LHsiLi9iYXNlL2VhZ2VyIjozLCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9oZWxwZXJzIjoxMSwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGNyZWF0ZUVycm9yID0gcmVxdWlyZSgnY3JlYXRlLWVycm9yJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHsKCiAgLy8gVGhyb3duIHdoZW4gdGhlIG1vZGVsIGlzIG5vdCBmb3VuZCBhbmQge3JlcXVpcmU6IHRydWV9IGlzIHBhc3NlZCBpbiB0aGUgZmV0Y2ggb3B0aW9ucwogIE5vdEZvdW5kRXJyb3I6IGNyZWF0ZUVycm9yKCdOb3RGb3VuZEVycm9yJyksCgogIC8vIFRocm93biB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IGFuZCB7cmVxdWlyZTogdHJ1ZX0gaXMgcGFzc2VkIGluIG1vZGVsLmZldGNoQWxsIG9yCiAgLy8gY29sbGVjdGlvbi5mZXRjaAogIEVtcHR5RXJyb3I6IGNyZWF0ZUVycm9yKCdFbXB0eUVycm9yJykKCn07Cn0seyJjcmVhdGUtZXJyb3IiOjc0fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBIZWxwZXJzCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CgogIC8vIFNldHMgdGhlIGNvbnN0cmFpbnRzIG5lY2Vzc2FyeSBkdXJpbmcgYSBgbW9kZWwuc2F2ZWAgY2FsbC4KICBzYXZlQ29uc3RyYWludHM6IGZ1bmN0aW9uKG1vZGVsLCByZWxhdGVkRGF0YSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIGlmIChyZWxhdGVkRGF0YSAmJiByZWxhdGVkRGF0YS50eXBlICYmIHJlbGF0ZWREYXRhLnR5cGUgIT09ICdiZWxvbmdzVG9NYW55JyAmJiByZWxhdGVkRGF0YS50eXBlICE9PSAnYmVsb25nc1RvJykgewogICAgICBkYXRhW3JlbGF0ZWREYXRhLmtleSgnZm9yZWlnbktleScpXSA9IHJlbGF0ZWREYXRhLnBhcmVudEZrIHx8IG1vZGVsLmdldChyZWxhdGVkRGF0YS5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICAgIGlmIChyZWxhdGVkRGF0YS5pc01vcnBoKCkpIGRhdGFbcmVsYXRlZERhdGEua2V5KCdtb3JwaEtleScpXSA9IHJlbGF0ZWREYXRhLmtleSgnbW9ycGhWYWx1ZScpOwogICAgfQogICAgcmV0dXJuIG1vZGVsLnNldChkYXRhKTsKICB9LAoKICAvLyBGaW5kcyB0aGUgc3BlY2lmaWMgYG1vcnBoVG9gIHRhYmxlIHdlIHNob3VsZCBiZSB3b3JraW5nIHdpdGgsIG9yIHRocm93cwogIC8vIGFuIGVycm9yIGlmIG5vbmUgaXMgbWF0Y2hlZC4KICBtb3JwaENhbmRpZGF0ZTogZnVuY3Rpb24oY2FuZGlkYXRlcywgZm9yZWlnblRhYmxlKSB7CiAgICB2YXIgVGFyZ2V0ID0gXy5maW5kKGNhbmRpZGF0ZXMsIGZ1bmN0aW9uKENhbmRpZGF0ZSkgewogICAgICByZXR1cm4gKF8ucmVzdWx0KENhbmRpZGF0ZS5wcm90b3R5cGUsICd0YWJsZU5hbWUnKSA9PT0gZm9yZWlnblRhYmxlKTsKICAgIH0pOwogICAgaWYgKCFUYXJnZXQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgdGFyZ2V0IHBvbHltb3JwaGljIG1vZGVsIHdhcyBub3QgZm91bmQnKTsKICAgIH0KICAgIHJldHVybiBUYXJnZXQ7CiAgfSwKCiAgLy8gSWYgdGhlcmUgYXJlIG5vIGFyZ3VtZW50cywgcmV0dXJuIHRoZSBjdXJyZW50IG9iamVjdCdzCiAgLy8gcXVlcnkgYnVpbGRlciAob3IgY3JlYXRlIGFuZCByZXR1cm4gYSBuZXcgb25lKS4gSWYgdGhlcmUgYXJlIGFyZ3VtZW50cywKICAvLyBjYWxsIHRoZSBxdWVyeSBidWlsZGVyIHdpdGggdGhlIGZpcnN0IGFyZ3VtZW50LCBhcHBseWluZyB0aGUgcmVzdC4KICAvLyBJZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYW4gb2JqZWN0LCBhc3N1bWUgdGhlIGtleXMgYXJlIHF1ZXJ5IGJ1aWxkZXIKICAvLyBtZXRob2RzLCBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGFyZ3VtZW50cyBmb3IgdGhlIHF1ZXJ5LgogIHF1ZXJ5OiBmdW5jdGlvbihvYmosIGFyZ3MpIHsKICAgIG9iai5fa25leCA9IG9iai5fa25leCB8fCBvYmouX2J1aWxkZXIoXy5yZXN1bHQob2JqLCAndGFibGVOYW1lJykpOwogICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gb2JqLl9rbmV4OwogICAgdmFyIG1ldGhvZCA9IGFyZ3NbMF07CiAgICBpZiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgbWV0aG9kLmNhbGwob2JqLl9rbmV4LCBvYmouX2tuZXgpOwogICAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KG1ldGhvZCkpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1ldGhvZCkgewogICAgICAgIHZhciB0YXJnZXQgPSBfLmlzQXJyYXkobWV0aG9kW2tleV0pID8gIG1ldGhvZFtrZXldIDogW21ldGhvZFtrZXldXTsKICAgICAgICBvYmouX2tuZXhba2V5XS5hcHBseShvYmouX2tuZXgsIHRhcmdldCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG9iai5fa25leFttZXRob2RdLmFwcGx5KG9iai5fa25leCwgYXJncy5zbGljZSgxKSk7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCn07Cgp9LHsibG9kYXNoIjoxMzB9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIE1vZGVsCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCnZhciBTeW5jICAgICAgICAgICA9IHJlcXVpcmUoJy4vc3luYycpOwp2YXIgSGVscGVycyAgICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIEVhZ2VyUmVsYXRpb24gID0gcmVxdWlyZSgnLi9lYWdlcicpOwp2YXIgRXJyb3JzICAgICAgICAgPSByZXF1aXJlKCcuL2Vycm9ycycpOwoKdmFyIE1vZGVsQmFzZSAgICAgID0gcmVxdWlyZSgnLi9iYXNlL21vZGVsJyk7CnZhciBQcm9taXNlICAgICAgICA9IHJlcXVpcmUoJy4vYmFzZS9wcm9taXNlJyk7CgpmdW5jdGlvbiBCb29rc2hlbGZNb2RlbCgpIHsKICBNb2RlbEJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZNb2RlbCwgTW9kZWxCYXNlKTsKCkJvb2tzaGVsZk1vZGVsLk5vdEZvdW5kRXJyb3IgPSBFcnJvcnMuTm90Rm91bmRFcnJvcjsKCl8uZXh0ZW5kKEJvb2tzaGVsZk1vZGVsLnByb3RvdHlwZSwgewoKICAvLyBUaGUgYGhhc09uZWAgcmVsYXRpb24gc3BlY2lmaWVzIHRoYXQgdGhpcyB0YWJsZSBoYXMgZXhhY3RseSBvbmUgb2YgYW5vdGhlciB0eXBlIG9mIG9iamVjdCwKICAvLyBzcGVjaWZpZWQgYnkgYSBmb3JlaWduIGtleSBpbiB0aGUgb3RoZXIgdGFibGUuIFRoZSBmb3JlaWduIGtleSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzaW5ndWxhciBvZiB0aGlzCiAgLy8gb2JqZWN0J3MgYHRhYmxlTmFtZWAgd2l0aCBhbiBgX2lkYCBzdWZmaXgsIGJ1dCBhIGN1c3RvbSBgZm9yZWlnbktleWAgYXR0cmlidXRlIG1heSBhbHNvIGJlIHNwZWNpZmllZC4KICBoYXNPbmU6IGZ1bmN0aW9uKFRhcmdldCwgZm9yZWlnbktleSkgewogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdoYXNPbmUnLCBUYXJnZXQsIHtmb3JlaWduS2V5OiBmb3JlaWduS2V5fSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBUaGUgYGhhc01hbnlgIHJlbGF0aW9uIHNwZWNpZmllcyB0aGF0IHRoaXMgb2JqZWN0IGhhcyBvbmUgb3IgbW9yZSByb3dzIGluIGFub3RoZXIgdGFibGUgd2hpY2gKICAvLyBtYXRjaCBvbiB0aGlzIG9iamVjdCdzIHByaW1hcnkga2V5LiBUaGUgZm9yZWlnbiBrZXkgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2luZ3VsYXIgb2YgdGhpcyBvYmplY3QncwogIC8vIGB0YWJsZU5hbWVgIHdpdGggYW4gYF9pZGAgc3VmZml4LCBidXQgYSBjdXN0b20gYGZvcmVpZ25LZXlgIGF0dHJpYnV0ZSBtYXkgYWxzbyBiZSBzcGVjaWZpZWQuCiAgaGFzTWFueTogZnVuY3Rpb24oVGFyZ2V0LCBmb3JlaWduS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fcmVsYXRpb24oJ2hhc01hbnknLCBUYXJnZXQsIHtmb3JlaWduS2V5OiBmb3JlaWduS2V5fSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBBIHJldmVyc2UgYGhhc09uZWAgcmVsYXRpb24sIHRoZSBgYmVsb25nc1RvYCwgd2hlcmUgdGhlIHNwZWNpZmllZCBrZXkgaW4gdGhpcyB0YWJsZQogIC8vIG1hdGNoZXMgdGhlIHByaW1hcnkgYGlkQXR0cmlidXRlYCBvZiBhbm90aGVyIHRhYmxlLgogIGJlbG9uZ3NUbzogZnVuY3Rpb24oVGFyZ2V0LCBmb3JlaWduS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fcmVsYXRpb24oJ2JlbG9uZ3NUbycsIFRhcmdldCwge2ZvcmVpZ25LZXk6IGZvcmVpZ25LZXl9KS5pbml0KHRoaXMpOwogIH0sCgogIC8vIEEgYGJlbG9uZ3NUb01hbnlgIHJlbGF0aW9uIGlzIHdoZW4gdGhlcmUgYXJlIG1hbnktdG8tbWFueSByZWxhdGlvbgogIC8vIGJldHdlZW4gdHdvIG1vZGVscywgd2l0aCBhIGpvaW5pbmcgdGFibGUuCiAgYmVsb25nc1RvTWFueTogZnVuY3Rpb24oVGFyZ2V0LCBqb2luVGFibGVOYW1lLCBmb3JlaWduS2V5LCBvdGhlcktleSkgewogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdiZWxvbmdzVG9NYW55JywgVGFyZ2V0LCB7CiAgICAgIGpvaW5UYWJsZU5hbWU6IGpvaW5UYWJsZU5hbWUsIGZvcmVpZ25LZXk6IGZvcmVpZ25LZXksIG90aGVyS2V5OiBvdGhlcktleQogICAgfSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBBIGBtb3JwaE9uZWAgcmVsYXRpb24gaXMgYSBvbmUtdG8tb25lIHBvbHltb3JwaGljIGFzc29jaWF0aW9uIGZyb20gdGhpcyBtb2RlbAogIC8vIHRvIGFub3RoZXIgbW9kZWwuCiAgbW9ycGhPbmU6IGZ1bmN0aW9uKFRhcmdldCwgbmFtZSwgY29sdW1uTmFtZXMsIG1vcnBoVmFsdWUpIHsKICAgIHJldHVybiB0aGlzLl9tb3JwaE9uZU9yTWFueShUYXJnZXQsIG5hbWUsIGNvbHVtbk5hbWVzLCBtb3JwaFZhbHVlLCAnbW9ycGhPbmUnKTsKICB9LAoKICAvLyBBIGBtb3JwaE1hbnlgIHJlbGF0aW9uIGlzIGEgcG9seW1vcnBoaWMgbWFueS10by1vbmUgcmVsYXRpb24gZnJvbSB0aGlzIG1vZGVsCiAgLy8gdG8gbWFueSBhbm90aGVyIG1vZGVscy4KICBtb3JwaE1hbnk6IGZ1bmN0aW9uKFRhcmdldCwgbmFtZSwgY29sdW1uTmFtZXMsIG1vcnBoVmFsdWUpIHsKICAgIHJldHVybiB0aGlzLl9tb3JwaE9uZU9yTWFueShUYXJnZXQsIG5hbWUsIGNvbHVtbk5hbWVzLCBtb3JwaFZhbHVlLCAnbW9ycGhNYW55Jyk7CiAgfSwKCiAgLy8gRGVmaW5lcyB0aGUgb3Bwb3NpdGUgZW5kIG9mIGEgYG1vcnBoT25lYCBvciBgbW9ycGhNYW55YCByZWxhdGlvbnNoaXAsIHdoZXJlCiAgLy8gdGhlIGFsdGVybmF0ZSBlbmQgb2YgdGhlIHBvbHltb3JwaGljIG1vZGVsIGlzIGRlZmluZWQuCiAgbW9ycGhUbzogZnVuY3Rpb24obW9ycGhOYW1lKSB7CiAgICB2YXIgY29sdW1uTmFtZXMsIHJlbWFpbmRlcjsKICAgIGlmICghXy5pc1N0cmluZyhtb3JwaE5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBgbW9ycGhUb2AgbmFtZSBtdXN0IGJlIHNwZWNpZmllZC4nKTsKICAgIGlmIChfLmlzQXJyYXkoYXJndW1lbnRzWzFdKSkgewogICAgICBjb2x1bW5OYW1lcyA9IGFyZ3VtZW50c1sxXTsKICAgICAgcmVtYWluZGVyID0gXy5yZXN0KGFyZ3VtZW50cywgMik7CiAgICB9IGVsc2UgewogICAgICBjb2x1bW5OYW1lcyA9IG51bGw7CiAgICAgIHJlbWFpbmRlciA9IF8ucmVzdChhcmd1bWVudHMpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdtb3JwaFRvJywgbnVsbCwge21vcnBoTmFtZTogbW9ycGhOYW1lLCBjb2x1bW5OYW1lczogY29sdW1uTmFtZXMsIGNhbmRpZGF0ZXM6IHJlbWFpbmRlcn0pLmluaXQodGhpcyk7CiAgfSwKCiAgLy8gVXNlZCB0byBkZWZpbmUgcGFzc3Rocm91Z2ggcmVsYXRpb25zaGlwcyAtIGBoYXNPbmVgLCBgaGFzTWFueWAsCiAgLy8gYGJlbG9uZ3NUb2Agb3IgYGJlbG9uZ3NUb01hbnlgLCAidGhyb3VnaCIgYSBgSW50ZXJpbWAgbW9kZWwgb3IgY29sbGVjdGlvbi4KICB0aHJvdWdoOiBmdW5jdGlvbihJbnRlcmltLCBmb3JlaWduS2V5LCBvdGhlcktleSkgewogICAgcmV0dXJuIHRoaXMucmVsYXRlZERhdGEudGhyb3VnaCh0aGlzLCBJbnRlcmltLCB7dGhyb3VnaEZvcmVpZ25LZXk6IGZvcmVpZ25LZXksIG90aGVyS2V5OiBvdGhlcktleX0pOwogIH0sCgogIC8vIEZldGNoIGEgbW9kZWwgYmFzZWQgb24gdGhlIGN1cnJlbnRseSBzZXQgYXR0cmlidXRlcywKICAvLyByZXR1cm5pbmcgYSBtb2RlbCB0byB0aGUgY2FsbGJhY2ssIGFsb25nIHdpdGggYW55IG9wdGlvbnMuCiAgLy8gUmV0dXJucyBhIGRlZmVycmVkIHByb21pc2UgdGhyb3VnaCB0aGUgYEJvb2tzaGVsZi5TeW5jYC4KICAvLyBJZiBge3JlcXVpcmU6IHRydWV9YCBpcyBzZXQgYXMgYW4gb3B0aW9uLCB0aGUgZmV0Y2ggaXMgY29uc2lkZXJlZAogIC8vIGEgZmFpbHVyZSBpZiB0aGUgbW9kZWwgY29tZXMgdXAgYmxhbmsuCiAgZmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgIC8vIFJ1biB0aGUgYGZpcnN0YCBjYWxsIG9uIHRoZSBgc3luY2Agb2JqZWN0IHRvIGZldGNoIGEgc2luZ2xlIG1vZGVsLgogICAgcmV0dXJuIHRoaXMuc3luYyhvcHRpb25zKQogICAgICAuZmlyc3QoKQogICAgICAuYmluZCh0aGlzKQoKICAgICAgLy8gSnVtcCB0aGUgcmVzdCBvZiB0aGUgY2hhaW4gaWYgdGhlIHJlc3BvbnNlIGRvZXNuJ3QgZXhpc3QuLi4KICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIGlmICghcmVzcG9uc2UgfHwgcmVzcG9uc2UubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5yZXF1aXJlKSB0aHJvdyBuZXcgRXJyb3JzLk5vdEZvdW5kRXJyb3IoJ0VtcHR5UmVzcG9uc2UnKTsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChudWxsKTsKICAgICAgICB9CiAgICAgIH0pCgogICAgICAvLyBOb3csIGxvYWQgYWxsIG9mIHRoZSBkYXRhIGludG8gdGhlIG1vZGVsIGFzIG5lY2Vzc2FyeS4KICAgICAgLnRhcCh0aGlzLl9oYW5kbGVSZXNwb25zZSkKCiAgICAgIC8vIElmIHRoZSAid2l0aFJlbGF0ZWQiIGlzIHNwZWNpZmllZCwgd2UgYWxzbyBuZWVkIHRvIGVhZ2VyIGxvYWQgYWxsIG9mIHRoZQogICAgICAvLyBkYXRhIG9uIHRoZSBtb2RlbCwgYXMgYSBzaWRlLWVmZmVjdCwgYmVmb3JlIHdlIHVsdGltYXRlbHkganVtcCBpbnRvIHRoZQogICAgICAvLyBuZXh0IHN0ZXAgb2YgdGhlIG1vZGVsLiBTaW5jZSB0aGUgYGNvbHVtbnNgIGFyZSBvbmx5IHJlbGV2YW50IHRvIHRoZSBjdXJyZW50CiAgICAgIC8vIGxldmVsLCBlbnN1cmUgdGhvc2UgYXJlIG9taXR0ZWQgZnJvbSB0aGUgb3B0aW9ucy4KICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIGlmIChvcHRpb25zLndpdGhSZWxhdGVkKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlRWFnZXIocmVzcG9uc2UsIF8ub21pdChvcHRpb25zLCAnY29sdW1ucycpKTsKICAgICAgICB9CiAgICAgIH0pCgogICAgICAudGFwKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2ZldGNoZWQnLCB0aGlzLCByZXNwb25zZSwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5yZXR1cm4odGhpcykKICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIgPT09IG51bGwpIHJldHVybiBlcnI7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9KTsKICB9KSwKCiAgLy8gU2hvcnRjdXQgZm9yIGNyZWF0aW5nIGEgY29sbGVjdGlvbiBhbmQgZmV0Y2hpbmcgdGhlIGFzc29jaWF0ZWQgbW9kZWxzLgogIGZldGNoQWxsOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXMuY29uc3RydWN0b3IuY29sbGVjdGlvbigpOwogICAgY29sbGVjdGlvbi5fa25leCA9IHRoaXMucXVlcnkoKS5jbG9uZSgpOwogICAgdGhpcy5yZXNldFF1ZXJ5KCk7CiAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSkgY29sbGVjdGlvbi5yZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgcmV0dXJuIGNvbGxlY3Rpb24KICAgICAgLm9uKCdmZXRjaGluZycsIGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGNvbHVtbnMsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbW9kZWwudHJpZ2dlclRoZW4oJ2ZldGNoaW5nOmNvbGxlY3Rpb24nLCBjb2xsZWN0aW9uLCBjb2x1bW5zLCBvcHRpb25zKTsKICAgICAgfSkKICAgICAgLm9uKCdmZXRjaGVkJywgZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBtb2RlbC50cmlnZ2VyVGhlbignZmV0Y2hlZDpjb2xsZWN0aW9uJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5mZXRjaChvcHRpb25zKTsKICB9LAoKICAvLyBFYWdlciBsb2FkcyByZWxhdGlvbnNoaXBzIG9udG8gYW4gYWxyZWFkeSBwb3B1bGF0ZWQgYE1vZGVsYCBpbnN0YW5jZS4KICBsb2FkOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihyZWxhdGlvbnMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFt0aGlzLmZvcm1hdChfLmV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCB0aGlzLmF0dHJpYnV0ZXMpKV07CiAgICAgIH0pCiAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUVhZ2VyKHJlc3BvbnNlLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywgewogICAgICAgICAgc2hhbGxvdzogdHJ1ZSwKICAgICAgICAgIHdpdGhSZWxhdGVkOiBfLmlzQXJyYXkocmVsYXRpb25zKSA/IHJlbGF0aW9ucyA6IFtyZWxhdGlvbnNdCiAgICAgICAgfSkpOwogICAgICB9KQogICAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBTZXRzIGFuZCBzYXZlcyB0aGUgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCB0cmlnZ2VyaW5nCiAgLy8gYSAiY3JlYXRpbmciIG9yICJ1cGRhdGluZyIgZXZlbnQgb24gdGhlIG1vZGVsLCBhcyB3ZWxsIGFzIGEgInNhdmluZyIgZXZlbnQsCiAgLy8gdG8gYmluZCBsaXN0ZW5lcnMgZm9yIGFueSBuZWNlc3NhcnkgdmFsaWRhdGlvbiwgbG9nZ2luZywgZXRjLgogIC8vIElmIGFuIGVycm9yIGlzIHRocm93biBkdXJpbmcgdGhlc2UgZXZlbnRzLCB0aGUgbW9kZWwgd2lsbCBub3QgYmUgc2F2ZWQuCiAgc2F2ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRyczsKCiAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IikgewogICAgICBhdHRycyA9IGtleSB8fCB7fTsKICAgICAgb3B0aW9ucyA9IF8uY2xvbmUodmFsKSB8fCB7fTsKICAgIH0gZWxzZSB7CiAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlzTmV3KG9wdGlvbnMpOwogICAgfSkudGhlbihmdW5jdGlvbihpc05ldykgewoKICAgICAgLy8gSWYgdGhlIG1vZGVsIGhhcyB0aW1lc3RhbXAgY29sdW1ucywKICAgICAgLy8gc2V0IHRoZW0gYXMgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGV2ZW4KICAgICAgLy8gaWYgdGhlICJwYXRjaCIgb3B0aW9uIGlzIHNwZWNpZmllZC4KICAgICAgaWYgKHRoaXMuaGFzVGltZXN0YW1wcykgXy5leHRlbmQoYXR0cnMsIHRoaXMudGltZXN0YW1wKG9wdGlvbnMpKTsKCiAgICAgIC8vIERldGVybWluZSB3aGV0aGVyIHRoZSBtb2RlbCBpcyBuZXcsIGJhc2VkIG9uIHdoZXRoZXIgdGhlIG1vZGVsIGhhcyBhbiBgaWRBdHRyaWJ1dGVgIG9yIG5vdC4KICAgICAgb3B0aW9ucy5tZXRob2QgPSAob3B0aW9ucy5tZXRob2QgfHwgKGlzTmV3ID8gJ2luc2VydCcgOiAndXBkYXRlJykpLnRvTG93ZXJDYXNlKCk7CiAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLm1ldGhvZDsKICAgICAgdmFyIHZhbHMgPSBhdHRyczsKCiAgICAgIC8vIElmIHRoZSBvYmplY3QgaXMgYmVpbmcgY3JlYXRlZCwgd2UgbWVyZ2UgYW55IGRlZmF1bHRzIGhlcmUKICAgICAgLy8gcmF0aGVyIHRoYW4gZHVyaW5nIG9iamVjdCBjcmVhdGlvbi4KICAgICAgaWYgKG1ldGhvZCA9PT0gJ2luc2VydCcgfHwgb3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgIHZhciBkZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpOwogICAgICAgIGlmIChkZWZhdWx0cykgewogICAgICAgICAgdmFscyA9IF8uZXh0ZW5kKHt9LCBkZWZhdWx0cywgdGhpcy5hdHRyaWJ1dGVzLCB2YWxzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNldCB0aGUgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwuCiAgICAgIHRoaXMuc2V0KHZhbHMsIHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgc2F2ZSBjb25zdHJhaW50cywgc2V0IHRoZW0gb24gdGhlIG1vZGVsLgogICAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSAmJiB0aGlzLnJlbGF0ZWREYXRhLnR5cGUgIT09ICdtb3JwaFRvJykgewogICAgICAgIEhlbHBlcnMuc2F2ZUNvbnN0cmFpbnRzKHRoaXMsIHRoaXMucmVsYXRlZERhdGEpOwogICAgICB9CgogICAgICAvLyBHaXZlcyBhY2Nlc3MgdG8gdGhlIGBxdWVyeWAgb2JqZWN0IGluIHRoZSBgb3B0aW9uc2AsIGluIGNhc2Ugd2UgbmVlZCBpdAogICAgICAvLyBpbiBhbnkgZXZlbnQgaGFuZGxlcnMuCiAgICAgIHZhciBzeW5jID0gdGhpcy5zeW5jKG9wdGlvbnMpOwogICAgICBvcHRpb25zLnF1ZXJ5ID0gc3luYy5xdWVyeTsKCiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKChtZXRob2QgPT09ICdpbnNlcnQnID8gJ2NyZWF0aW5nIHNhdmluZycgOiAndXBkYXRpbmcgc2F2aW5nJyksIHRoaXMsIGF0dHJzLCBvcHRpb25zKQogICAgICAuYmluZCh0aGlzKQogICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3luY1tvcHRpb25zLm1ldGhvZF0obWV0aG9kID09PSAndXBkYXRlJyAmJiBvcHRpb25zLnBhdGNoID8gYXR0cnMgOiB0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB9KQogICAgICAudGhlbihmdW5jdGlvbihyZXNwKSB7CgogICAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBkYXRhYmFzZSBzYXZlLCB0aGUgaWQgaXMgdXBkYXRlZCBpZiB0aGUgbW9kZWwgd2FzIGNyZWF0ZWQKICAgICAgICBpZiAobWV0aG9kID09PSAnaW5zZXJ0JyAmJiB0aGlzLmlkID09IG51bGwpIHsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlc1t0aGlzLmlkQXR0cmlidXRlXSA9IHRoaXMuaWQgPSByZXNwWzBdOwogICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAndXBkYXRlJyAmJiByZXNwID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHJvd3Mgd2VyZSBhZmZlY3RlZCBpbiB0aGUgdXBkYXRlLCBkaWQgeW91IG1lYW4gdG8gcGFzcyB0aGUge21ldGhvZDogImluc2VydCJ9IG9wdGlvbj8nKTsKICAgICAgICB9CgogICAgICAgIC8vIEluIGNhc2Ugd2UgbmVlZCB0byByZWZlcmVuY2UgdGhlIGBwcmV2aW91c0F0dHJpYnV0ZXNgIGZvciB0aGUgdGhpcwogICAgICAgIC8vIGluIHRoZSBmb2xsb3dpbmcgZXZlbnQgaGFuZGxlcnMuCiAgICAgICAgb3B0aW9ucy5wcmV2aW91c0F0dHJpYnV0ZXMgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAgIHRoaXMuX3Jlc2V0KCk7CgogICAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKChtZXRob2QgPT09ICdpbnNlcnQnID8gJ2NyZWF0ZWQgc2F2ZWQnIDogJ3VwZGF0ZWQgc2F2ZWQnKSwgdGhpcywgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0pOwoKICAgIH0pCiAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBSZXNldCB0aGUgcXVlcnkgYnVpbGRlciwgY2FsbGVkIGludGVybmFsbHkKICAvLyBlYWNoIHRpbWUgYSBxdWVyeSBpcyBydW4uCiAgcmVzZXRRdWVyeTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9rbmV4ID0gbnVsbDsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIFRhcCBpbnRvIHRoZSAicXVlcnkgY2hhaW4iIGZvciB0aGlzIG1vZGVsLgogIHF1ZXJ5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBIZWxwZXJzLnF1ZXJ5KHRoaXMsIF8udG9BcnJheShhcmd1bWVudHMpKTsKICB9LAoKICAvLyBBZGQgdGhlIG1vc3QgY29tbW9uIGNvbmRpdGlvbmFsIGRpcmVjdGx5IHRvIHRoZSBtb2RlbCwgZXZlcnl0aGluZyBlbHNlCiAgLy8gY2FuIGJlIGFjY2Vzc2VkIHdpdGggdGhlIGBxdWVyeWAgbWV0aG9kLgogIHdoZXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy5xdWVyeS5hcHBseSh0aGlzLCBbJ3doZXJlJ10uY29uY2F0KGFyZ3MpKTsKICB9LAoKICAvLyBDcmVhdGVzIGFuZCByZXR1cm5zIGEgbmV3IGBTeW5jYCBpbnN0YW5jZS4KICBzeW5jOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFN5bmModGhpcywgb3B0aW9ucyk7CiAgfSwKCiAgLy8gSGVscGVyIGZvciBzZXR0aW5nIHVwIHRoZSBgbW9ycGhPbmVgIG9yIGBtb3JwaE1hbnlgIHJlbGF0aW9ucy4KICBfbW9ycGhPbmVPck1hbnk6IGZ1bmN0aW9uKFRhcmdldCwgbW9ycGhOYW1lLCBjb2x1bW5OYW1lcywgbW9ycGhWYWx1ZSwgdHlwZSkgewogICAgaWYgKCFfLmlzQXJyYXkoY29sdW1uTmFtZXMpKSB7CiAgICAgIC8vIFNoaWZ0IGJ5IG9uZSBwbGFjZQogICAgICBtb3JwaFZhbHVlID0gY29sdW1uTmFtZXM7CiAgICAgIGNvbHVtbk5hbWVzID0gbnVsbDsKICAgIH0KICAgIGlmICghbW9ycGhOYW1lIHx8ICFUYXJnZXQpIHRocm93IG5ldyBFcnJvcignVGhlIHBvbHltb3JwaGljIGBuYW1lYCBhbmQgYFRhcmdldGAgYXJlIHJlcXVpcmVkLicpOwogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKHR5cGUsIFRhcmdldCwge21vcnBoTmFtZTogbW9ycGhOYW1lLCBtb3JwaFZhbHVlOiBtb3JwaFZhbHVlLCBjb2x1bW5OYW1lczogY29sdW1uTmFtZXN9KS5pbml0KHRoaXMpOwogIH0sCgogIC8vIEhhbmRsZXMgdGhlIHJlc3BvbnNlIGRhdGEgZm9yIHRoZSBtb2RlbCwgcmV0dXJuaW5nIGZyb20gdGhlIG1vZGVsJ3MgZmV0Y2ggY2FsbC4KICAvLyBUb2RvOiB7c2lsZW50OiB0cnVlLCBwYXJzZTogdHJ1ZX0sIGZvciBwYXJpdHkgd2l0aCBjb2xsZWN0aW9uI3NldAogIC8vIG5lZWQgdG8gY2hlY2sgb24gQmFja2JvbmUncyBzdGF0dXMgdGhlcmUsIHRpY2tldCAjMjYzNgogIF9oYW5kbGVSZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgIHZhciByZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB0aGlzLnNldCh0aGlzLnBhcnNlKHJlc3BvbnNlWzBdKSwge3NpbGVudDogdHJ1ZX0pLl9yZXNldCgpOwogICAgaWYgKHJlbGF0ZWREYXRhICYmIHJlbGF0ZWREYXRhLmlzSm9pbmVkKCkpIHsKICAgICAgcmVsYXRlZERhdGEucGFyc2VQaXZvdChbdGhpc10pOwogICAgfQogIH0sCgogIC8vIEhhbmRsZSB0aGUgcmVsYXRlZCBkYXRhIGxvYWRpbmcgb24gdGhlIG1vZGVsLgogIF9oYW5kbGVFYWdlcjogZnVuY3Rpb24ocmVzcG9uc2UsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRWFnZXJSZWxhdGlvbihbdGhpc10sIHJlc3BvbnNlLCB0aGlzKS5mZXRjaChvcHRpb25zKTsKICB9Cgp9KTsKCm1vZHVsZS5leHBvcnRzID0gQm9va3NoZWxmTW9kZWw7Cgp9LHsiLi9iYXNlL21vZGVsIjo1LCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9lYWdlciI6OSwiLi9lcnJvcnMiOjEwLCIuL2hlbHBlcnMiOjExLCIuL3N5bmMiOjE0LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBSZWxhdGlvbgovLyAtLS0tLS0tLS0tLS0tLS0KdmFyIF8gICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoJ2luZmxlY3Rpb24nKTsKCnZhciBIZWxwZXJzICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIE1vZGVsQmFzZSAgICA9IHJlcXVpcmUoJy4vYmFzZS9tb2RlbCcpOwp2YXIgUmVsYXRpb25CYXNlID0gcmVxdWlyZSgnLi9iYXNlL3JlbGF0aW9uJyk7CnZhciBQcm9taXNlICAgICAgPSByZXF1aXJlKCcuL2Jhc2UvcHJvbWlzZScpOwoKdmFyIHB1c2ggICAgICAgICA9IFtdLnB1c2g7CgpmdW5jdGlvbiBCb29rc2hlbGZSZWxhdGlvbigpIHsKICBSZWxhdGlvbkJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZSZWxhdGlvbiwgUmVsYXRpb25CYXNlKTsKCl8uZXh0ZW5kKEJvb2tzaGVsZlJlbGF0aW9uLnByb3RvdHlwZSwgewoKICAvLyBBc3NlbWJsZXMgdGhlIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uIHdlJ3JlIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mLAogIC8vIGdhdGhlcmluZyBhbnkgcmVsZXZhbnQgcHJpbWl0aXZlcyBmcm9tIHRoZSBwYXJlbnQgb2JqZWN0LAogIC8vIHdpdGhvdXQga2VlcGluZyBhbnkgaGFyZCByZWZlcmVuY2VzLgogIGluaXQ6IGZ1bmN0aW9uKHBhcmVudCkgewogICAgdGhpcy5wYXJlbnRJZCAgICAgICAgICA9IHBhcmVudC5pZDsKICAgIHRoaXMucGFyZW50VGFibGVOYW1lICAgPSBfLnJlc3VsdChwYXJlbnQsICd0YWJsZU5hbWUnKTsKICAgIHRoaXMucGFyZW50SWRBdHRyaWJ1dGUgPSBfLnJlc3VsdChwYXJlbnQsICdpZEF0dHJpYnV0ZScpOwoKICAgIGlmICh0aGlzLmlzSW52ZXJzZSgpKSB7CiAgICAgIC8vIHVzZSBmb3JtYXR0ZWQgYXR0cmlidXRlcyBzbyB0aGF0IG1vcnBoS2V5IGFuZCBmb3JlaWduS2V5IHdpbGwgbWF0Y2gKICAgICAgLy8gYXR0cmlidXRlIGtleXMKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBwYXJlbnQuZm9ybWF0KF8uY2xvbmUocGFyZW50LmF0dHJpYnV0ZXMpKTsKCiAgICAgIC8vIElmIHRoZSBwYXJlbnQgb2JqZWN0IGlzIGVhZ2VyIGxvYWRpbmcsIGFuZCBpdCdzIGEgcG9seW1vcnBoaWMgYG1vcnBoVG9gIHJlbGF0aW9uLAogICAgICAvLyB3ZSBjYW4ndCBrbm93IHdoYXQgdGhlIHRhcmdldCB3aWxsIGJlIHVudGlsIHRoZSBtb2RlbHMgYXJlIHNvcnRlZCBhbmQgbWF0Y2hlZC4KICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nICYmICFwYXJlbnQuX2lzRWFnZXIpIHsKICAgICAgICB0aGlzLnRhcmdldCA9IEhlbHBlcnMubW9ycGhDYW5kaWRhdGUodGhpcy5jYW5kaWRhdGVzLCBhdHRyaWJ1dGVzW3RoaXMua2V5KCdtb3JwaEtleScpXSk7CiAgICAgICAgdGhpcy50YXJnZXRUYWJsZU5hbWUgICA9IF8ucmVzdWx0KHRoaXMudGFyZ2V0LnByb3RvdHlwZSwgJ3RhYmxlTmFtZScpOwogICAgICAgIHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGUgPSBfLnJlc3VsdCh0aGlzLnRhcmdldC5wcm90b3R5cGUsICdpZEF0dHJpYnV0ZScpOwogICAgICB9CiAgICAgIHRoaXMucGFyZW50RmsgPSBhdHRyaWJ1dGVzW3RoaXMua2V5KCdmb3JlaWduS2V5JyldOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJlbnRGayA9IHBhcmVudC5pZDsKICAgIH0KCiAgICB2YXIgdGFyZ2V0ID0gdGhpcy50YXJnZXQgPyB0aGlzLnJlbGF0ZWRJbnN0YW5jZSgpIDoge307CiAgICAgICAgdGFyZ2V0LnJlbGF0ZWREYXRhID0gdGhpczsKCiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIHsKICAgICAgXy5leHRlbmQodGFyZ2V0LCBwaXZvdEhlbHBlcnMpOwogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfSwKCiAgLy8gSW5pdGlhbGl6ZXMgYSBgdGhyb3VnaGAgcmVsYXRpb24sIHNldHRpbmcgdGhlIGBUYXJnZXRgIG1vZGVsIGFuZCBgb3B0aW9uc2AsCiAgLy8gd2hpY2ggaW5jbHVkZXMgYW55IGFkZGl0aW9uYWwga2V5cyBmb3IgdGhlIHJlbGF0aW9uLgogIHRocm91Z2g6IGZ1bmN0aW9uKHNvdXJjZSwgVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IHRoaXMudHlwZTsKICAgIGlmICh0eXBlICE9PSAnaGFzT25lJyAmJiB0eXBlICE9PSAnaGFzTWFueScgJiYgdHlwZSAhPT0gJ2JlbG9uZ3NUb01hbnknICYmIHR5cGUgIT09ICdiZWxvbmdzVG8nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignYHRocm91Z2hgIGlzIG9ubHkgY2hhaW5hYmxlIGZyb20gYGhhc09uZWAsIGBiZWxvbmdzVG9gLCBgaGFzTWFueWAsIG9yIGBiZWxvbmdzVG9NYW55YCcpOwogICAgfQoKICAgIHRoaXMudGhyb3VnaFRhcmdldCA9IFRhcmdldDsKICAgIHRoaXMudGhyb3VnaFRhYmxlTmFtZSA9IF8ucmVzdWx0KFRhcmdldC5wcm90b3R5cGUsICd0YWJsZU5hbWUnKTsKICAgIHRoaXMudGhyb3VnaElkQXR0cmlidXRlID0gXy5yZXN1bHQoVGFyZ2V0LnByb3RvdHlwZSwgJ2lkQXR0cmlidXRlJyk7CgogICAgLy8gU2V0IHRoZSBwYXJlbnRGayBhcyBhcHByb3ByaWF0ZSBub3cuCiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgewogICAgICB0aGlzLnBhcmVudEZrID0gdGhpcy5wYXJlbnRJZDsKICAgIH0KCiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgIF8uZXh0ZW5kKHNvdXJjZSwgcGl2b3RIZWxwZXJzKTsKCiAgICAvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGZvcmVpZ24ga2V5IGlmIHdlJ3JlIGRvaW5nIGEgYmVsb25nc1RvTWFueSwgZm9yIGNvbnZlbmllbmNlLgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknKSB7CiAgICAgIHRoaXMuZm9yZWlnbktleSA9IHRoaXMudGhyb3VnaEZvcmVpZ25LZXk7CiAgICB9CgogICAgcmV0dXJuIHNvdXJjZTsKICB9LAoKICAvLyBHZW5lcmF0ZXMgYW5kIHJldHVybnMgYSBzcGVjaWZpZWQga2V5LCBmb3IgY29udmVuaWVuY2UuLi4gb25lIG9mCiAgLy8gYGZvcmVpZ25LZXlgLCBgb3RoZXJLZXlgLCBgdGhyb3VnaEZvcmVpZ25LZXlgLgogIGtleTogZnVuY3Rpb24oa2V5TmFtZSkgewogICAgdmFyIGlkS2V5TmFtZTsKICAgIGlmICh0aGlzW2tleU5hbWVdKSByZXR1cm4gdGhpc1trZXlOYW1lXTsKICAgIGlmIChrZXlOYW1lID09PSAnb3RoZXJLZXknKSB7CiAgICAgIHJldHVybiB0aGlzW2tleU5hbWVdID0gc2luZ3VsYXJNZW1vKHRoaXMudGFyZ2V0VGFibGVOYW1lKSArICdfJyArIHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGU7CiAgICB9CiAgICBpZiAoa2V5TmFtZSA9PT0gJ3Rocm91Z2hGb3JlaWduS2V5JykgewogICAgICByZXR1cm4gdGhpc1trZXlOYW1lXSA9IHNpbmd1bGFyTWVtbyh0aGlzLmpvaW5UYWJsZSgpKSArICdfJyArIHRoaXMudGhyb3VnaElkQXR0cmlidXRlOwogICAgfQogICAgaWYgKGtleU5hbWUgPT09ICdmb3JlaWduS2V5JykgewogICAgICBpZiAodGhpcy50eXBlID09PSAnbW9ycGhUbycpIHsKICAgICAgICBpZEtleU5hbWUgPSB0aGlzLmNvbHVtbk5hbWVzICYmIHRoaXMuY29sdW1uTmFtZXNbMV0gPyB0aGlzLmNvbHVtbk5hbWVzWzFdIDogdGhpcy5tb3JwaE5hbWUgKyAnX2lkJzsKICAgICAgICByZXR1cm4gdGhpc1trZXlOYW1lXSA9IGlkS2V5TmFtZTsKICAgICAgfQogICAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBzaW5ndWxhck1lbW8odGhpcy50YXJnZXRUYWJsZU5hbWUpICsgJ18nICsgdGhpcy50YXJnZXRJZEF0dHJpYnV0ZTsKICAgICAgaWYgKHRoaXMuaXNNb3JwaCgpKSB7CiAgICAgICAgaWRLZXlOYW1lID0gdGhpcy5jb2x1bW5OYW1lcyAmJiB0aGlzLmNvbHVtbk5hbWVzWzFdID8gdGhpcy5jb2x1bW5OYW1lc1sxXSA6IHRoaXMubW9ycGhOYW1lICsgJ19pZCc7CiAgICAgICAgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBpZEtleU5hbWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBzaW5ndWxhck1lbW8odGhpcy5wYXJlbnRUYWJsZU5hbWUpICsgJ18nICsgdGhpcy5wYXJlbnRJZEF0dHJpYnV0ZTsKICAgIH0KICAgIGlmIChrZXlOYW1lID09PSAnbW9ycGhLZXknKSB7CiAgICAgIHZhciB0eXBlS2V5TmFtZSA9IHRoaXMuY29sdW1uTmFtZXMgJiYgdGhpcy5jb2x1bW5OYW1lc1swXSA/IHRoaXMuY29sdW1uTmFtZXNbMF0gOiB0aGlzLm1vcnBoTmFtZSArICdfdHlwZSc7CiAgICAgIHJldHVybiB0aGlzW2tleU5hbWVdID0gdHlwZUtleU5hbWU7CiAgICB9CiAgICBpZiAoa2V5TmFtZSA9PT0gJ21vcnBoVmFsdWUnKSByZXR1cm4gdGhpc1trZXlOYW1lXSA9IHRoaXMucGFyZW50VGFibGVOYW1lIHx8IHRoaXMudGFyZ2V0VGFibGVOYW1lOwogIH0sCgogIC8vIEluamVjdHMgdGhlIG5lY2Vzc2FyeSBgc2VsZWN0YCBjb25zdHJhaW50cyBpbnRvIGEgYGtuZXhgIHF1ZXJ5IGJ1aWxkZXIuCiAgc2VsZWN0Q29uc3RyYWludHM6IGZ1bmN0aW9uKGtuZXgsIG9wdGlvbnMpIHsKICAgIHZhciByZXNwID0gb3B0aW9ucy5wYXJlbnRSZXNwb25zZTsKCiAgICAvLyBUaGUgYGJlbG9uZ3NUb01hbnlgIGFuZCBgdGhyb3VnaGAgcmVsYXRpb25zIGhhdmUgam9pbnMgJiBwaXZvdCBjb2x1bW5zLgogICAgaWYgKHRoaXMuaXNKb2luZWQoKSkgdGhpcy5qb2luQ2xhdXNlcyhrbmV4KTsKCiAgICAvLyBDYWxsIHRoZSBmdW5jdGlvbiwgaWYgb25lIGV4aXN0cywgdG8gY29uc3RyYWluIHRoZSBlYWdlciBsb2FkZWQgcXVlcnkuCiAgICBpZiAob3B0aW9ucy5fYmVmb3JlRm4pIG9wdGlvbnMuX2JlZm9yZUZuLmNhbGwoa25leCwga25leCk7CgogICAgLy8gVGhlIGJhc2Ugc2VsZWN0IGNvbHVtbgogICAgaWYgKF8uaXNBcnJheShvcHRpb25zLmNvbHVtbnMpKSB7CiAgICAgIGtuZXguY29sdW1ucyhvcHRpb25zLmNvbHVtbnMpOwogICAgfQoKICAgIHZhciBjdXJyZW50Q29sdW1ucyA9IF8uZmluZFdoZXJlKGtuZXguX3N0YXRlbWVudHMsIHtncm91cGluZzogJ2NvbHVtbnMnfSk7CgogICAgaWYgKCFjdXJyZW50Q29sdW1ucyB8fCBjdXJyZW50Q29sdW1ucy5sZW5ndGggPT09IDApIHsKICAgICAga25leC5jb2x1bW4odGhpcy50YXJnZXRUYWJsZU5hbWUgKyAnLionKTsKICAgIH0KCiAgICBpZiAodGhpcy5pc0pvaW5lZCgpKSB0aGlzLmpvaW5Db2x1bW5zKGtuZXgpOwogICAgCiAgICAvLyBJZiB0aGlzIGlzIGEgc2luZ2xlIHJlbGF0aW9uIGFuZCB3ZSdyZSBub3QgZWFnZXIgbG9hZGluZywKICAgIC8vIGxpbWl0IHRoZSBxdWVyeSB0byBhIHNpbmdsZSBpdGVtLgogICAgaWYgKHRoaXMuaXNTaW5nbGUoKSAmJiAhcmVzcCkga25leC5saW1pdCgxKTsKCiAgICAvLyBGaW5hbGx5LCBhZGQgKGFuZCB2YWxpZGF0ZSkgdGhlIHdoZXJlIGNvbmRpdGlvbnMsIG5lY2Vzc2FyeSBmb3IgY29uc3RyYWluaW5nIHRoZSByZWxhdGlvbi4KICAgIHRoaXMud2hlcmVDbGF1c2VzKGtuZXgsIHJlc3ApOwogIH0sCgogIC8vIEluamVjdCAmIHZhbGlkYXRlcyBuZWNlc3NhcnkgYHRocm91Z2hgIGNvbnN0cmFpbnRzIGZvciB0aGUgY3VycmVudCBtb2RlbC4KICBqb2luQ29sdW1uczogZnVuY3Rpb24oa25leCkgewogICAgdmFyIGNvbHVtbnMgPSBbXTsKICAgIHZhciBqb2luVGFibGUgPSB0aGlzLmpvaW5UYWJsZSgpOwogICAgaWYgKHRoaXMuaXNUaHJvdWdoKCkpIGNvbHVtbnMucHVzaCh0aGlzLnRocm91Z2hJZEF0dHJpYnV0ZSk7CiAgICBjb2x1bW5zLnB1c2godGhpcy5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIGNvbHVtbnMucHVzaCh0aGlzLmtleSgnb3RoZXJLZXknKSk7CiAgICBwdXNoLmFwcGx5KGNvbHVtbnMsIHRoaXMucGl2b3RDb2x1bW5zKTsKICAgIGtuZXguY29sdW1ucyhfLm1hcChjb2x1bW5zLCBmdW5jdGlvbihjb2wpIHsKICAgICAgcmV0dXJuIGpvaW5UYWJsZSArICcuJyArIGNvbCArICcgYXMgX3Bpdm90XycgKyBjb2w7CiAgICB9KSk7CiAgfSwKCiAgLy8gR2VuZXJhdGVzIHRoZSBqb2luIGNsYXVzZXMgbmVjZXNzYXJ5IGZvciB0aGUgY3VycmVudCByZWxhdGlvbi4KICBqb2luQ2xhdXNlczogZnVuY3Rpb24oa25leCkgewogICAgdmFyIGpvaW5UYWJsZSA9IHRoaXMuam9pblRhYmxlKCk7CgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUbycgfHwgdGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIHsKCiAgICAgIHZhciB0YXJnZXRLZXkgPSAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMua2V5KCdmb3JlaWduS2V5JykgOiB0aGlzLmtleSgnb3RoZXJLZXknKSk7CgogICAgICBrbmV4LmpvaW4oCiAgICAgICAgam9pblRhYmxlLAogICAgICAgIGpvaW5UYWJsZSArICcuJyArIHRhcmdldEtleSwgJz0nLAogICAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy50YXJnZXRJZEF0dHJpYnV0ZQogICAgICApOwoKICAgICAgLy8gQSBgYmVsb25nc1RvYCAtPiBgdGhyb3VnaGAgaXMgY3VycmVudGx5IHRoZSBvbmx5IHJlbGF0aW9uIHdpdGggdHdvIGpvaW5zLgogICAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgewogICAgICAgIGtuZXguam9pbigKICAgICAgICAgIHRoaXMucGFyZW50VGFibGVOYW1lLAogICAgICAgICAgam9pblRhYmxlICsgJy4nICsgdGhpcy50aHJvdWdoSWRBdHRyaWJ1dGUsICc9JywKICAgICAgICAgIHRoaXMucGFyZW50VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JykKICAgICAgICApOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAga25leC5qb2luKAogICAgICAgIGpvaW5UYWJsZSwKICAgICAgICBqb2luVGFibGUgKyAnLicgKyB0aGlzLnRocm91Z2hJZEF0dHJpYnV0ZSwgJz0nLAogICAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JykKICAgICAgKTsKICAgIH0KICB9LAoKICAvLyBDaGVjayB0aGF0IHRoZXJlIGlzbid0IGFuIGluY29ycmVjdCBmb3JlaWduIGtleSBzZXQsIHZzLiB0aGUgb25lCiAgLy8gcGFzc2VkIGluIHdoZW4gdGhlIHJlbGF0aW9uIHdhcyBmb3JtZWQuCiAgd2hlcmVDbGF1c2VzOiBmdW5jdGlvbihrbmV4LCByZXNwKSB7CiAgICB2YXIga2V5OwoKICAgIGlmICh0aGlzLmlzSm9pbmVkKCkpIHsKICAgICAgdmFyIHRhcmdldFRhYmxlID0gdGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMucGFyZW50VGFibGVOYW1lIDogdGhpcy5qb2luVGFibGUoKTsKICAgICAga2V5ID0gdGFyZ2V0VGFibGUgKyAnLicgKyAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMucGFyZW50SWRBdHRyaWJ1dGUgOiB0aGlzLmtleSgnZm9yZWlnbktleScpKTsKICAgIH0gZWxzZSB7CiAgICAgIGtleSA9IHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsKICAgICAgICAodGhpcy5pc0ludmVyc2UoKSA/IHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGUgOiB0aGlzLmtleSgnZm9yZWlnbktleScpKTsKICAgIH0KCiAgICBrbmV4W3Jlc3AgPyAnd2hlcmVJbicgOiAnd2hlcmUnXShrZXksIHJlc3AgPyB0aGlzLmVhZ2VyS2V5cyhyZXNwKSA6IHRoaXMucGFyZW50RmspOwoKICAgIGlmICh0aGlzLmlzTW9ycGgoKSkgewogICAgICBrbmV4LndoZXJlKHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ21vcnBoS2V5JyksIHRoaXMua2V5KCdtb3JwaFZhbHVlJykpOwogICAgfQogIH0sCgogIC8vIEZldGNoZXMgYWxsIGBlYWdlcktleXNgIGZyb20gdGhlIGN1cnJlbnQgcmVsYXRpb24uCiAgZWFnZXJLZXlzOiBmdW5jdGlvbihyZXNwKSB7CiAgICB2YXIga2V5ID0gdGhpcy5pc0ludmVyc2UoKSAmJiAhdGhpcy5pc1Rocm91Z2goKSA/IHRoaXMua2V5KCdmb3JlaWduS2V5JykgOiB0aGlzLnBhcmVudElkQXR0cmlidXRlOwogICAgcmV0dXJuIF8udW5pcShfLnBsdWNrKHJlc3AsIGtleSkpOwogIH0sCgogIC8vIEdlbmVyYXRlcyB0aGUgYXBwcm9wcmlhdGUgc3RhbmRhcmQgam9pbiB0YWJsZS4KICBqb2luVGFibGU6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuaXNUaHJvdWdoKCkpIHJldHVybiB0aGlzLnRocm91Z2hUYWJsZU5hbWU7CiAgICByZXR1cm4gdGhpcy5qb2luVGFibGVOYW1lIHx8IFsKICAgICAgdGhpcy5wYXJlbnRUYWJsZU5hbWUsCiAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lCiAgICBdLnNvcnQoKS5qb2luKCdfJyk7CiAgfSwKCiAgLy8gQ3JlYXRlcyBhIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uIGluc3RhbmNlLCBkZXBlbmRpbmcgb24KICAvLyB0aGUgYHJlbGF0ZWREYXRhYCBzZXR0aW5ncyBhbmQgdGhlIG1vZGVscyBwYXNzZWQgaW4uCiAgcmVsYXRlZEluc3RhbmNlOiBmdW5jdGlvbihtb2RlbHMpIHsKICAgIG1vZGVscyA9IG1vZGVscyB8fCBbXTsKCiAgICB2YXIgVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CgogICAgLy8gSWYgaXQncyBhIHNpbmdsZSBtb2RlbCwgY2hlY2sgd2hldGhlciB0aGVyZSdzIGFscmVhZHkgYSBtb2RlbAogICAgLy8gd2UgY2FuIHBpY2sgZnJvbS4uLiBvdGhlcndpc2UgY3JlYXRlIGEgbmV3IGluc3RhbmNlLgogICAgaWYgKHRoaXMuaXNTaW5nbGUoKSkgewogICAgICBpZiAoIShUYXJnZXQucHJvdG90eXBlIGluc3RhbmNlb2YgTW9kZWxCYXNlKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGAnK3RoaXMudHlwZSsnYCByZWxhdGVkIG9iamVjdCBtdXN0IGJlIGEgQm9va3NoZWxmLk1vZGVsJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vZGVsc1swXSB8fCBuZXcgVGFyZ2V0KCk7CiAgICB9CgogICAgLy8gQWxsb3dzIHVzIHRvIGp1c3QgdXNlIGEgbW9kZWwsIGJ1dCBjcmVhdGUgYSB0ZW1wb3JhcnkKICAgIC8vIGNvbGxlY3Rpb24gZm9yIGEgIiotbWFueSIgcmVsYXRpb24uCiAgICBpZiAoVGFyZ2V0LnByb3RvdHlwZSBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICBUYXJnZXQgPSB0aGlzLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICBtb2RlbDogVGFyZ2V0CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBUYXJnZXQobW9kZWxzLCB7cGFyc2U6IHRydWV9KTsKICB9LAoKICAvLyBHcm91cHMgdGhlIHJlbGF0ZWQgcmVzcG9uc2UgYWNjb3JkaW5nIHRvIHRoZSB0eXBlIG9mIHJlbGF0aW9uc2hpcAogIC8vIHdlJ3JlIGhhbmRsaW5nLCBmb3IgZWFzeSBhdHRhY2htZW50IHRvIHRoZSBwYXJlbnQgbW9kZWxzLgogIGVhZ2VyUGFpcjogZnVuY3Rpb24ocmVsYXRpb25OYW1lLCByZWxhdGVkLCBwYXJlbnRNb2RlbHMpIHsKICAgIHZhciBtb2RlbDsKCiAgICAvLyBJZiB0aGlzIGlzIGEgbW9ycGhUbywgd2Ugb25seSB3YW50IHRvIHBhaXIgb24gdGhlIG1vcnBoVmFsdWUgZm9yIHRoZSBjdXJyZW50IHJlbGF0aW9uLgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nKSB7CiAgICAgIHBhcmVudE1vZGVscyA9IF8uZmlsdGVyKHBhcmVudE1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHRoaXMua2V5KCdtb3JwaEtleScpKSA9PT0gdGhpcy5rZXkoJ21vcnBoVmFsdWUnKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CgogICAgLy8gSWYgdGhpcyBpcyBhIGB0aHJvdWdoYCBvciBgYmVsb25nc1RvTWFueWAgcmVsYXRpb24sIHdlIG5lZWQgdG8gY2xlYW51cCAmIHNldHVwIHRoZSBgaW50ZXJpbWAgbW9kZWwuCiAgICBpZiAodGhpcy5pc0pvaW5lZCgpKSByZWxhdGVkID0gdGhpcy5wYXJzZVBpdm90KHJlbGF0ZWQpOwoKICAgIC8vIEdyb3VwIGFsbCBvZiB0aGUgcmVsYXRlZCBtb2RlbHMgZm9yIGVhc2llciBhc3NvY2lhdGlvbiB3aXRoIHRoZWlyIHBhcmVudCBtb2RlbHMuCiAgICB2YXIgZ3JvdXBlZCA9IF8uZ3JvdXBCeShyZWxhdGVkLCBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAobW9kZWwucGl2b3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc0ludmVyc2UoKSAmJiB0aGlzLmlzVGhyb3VnaCgpID8gbW9kZWwucGl2b3QuaWQgOgogICAgICAgICAgbW9kZWwucGl2b3QuZ2V0KHRoaXMua2V5KCdmb3JlaWduS2V5JykpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmlzSW52ZXJzZSgpID8gbW9kZWwuaWQgOiBtb2RlbC5nZXQodGhpcy5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIC8vIExvb3Agb3ZlciB0aGUgYHBhcmVudE1vZGVsc2AgYW5kIGF0dGFjaCB0aGUgZ3JvdXBlZCBzdWItbW9kZWxzLAogICAgLy8ga2VlcGluZyB0aGUgYHJlbGF0ZWREYXRhYCBvbiB0aGUgbmV3IHJlbGF0ZWQgaW5zdGFuY2UuCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBhcmVudE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgbW9kZWwgPSBwYXJlbnRNb2RlbHNbaV07CiAgICAgIHZhciBncm91cGVkS2V5OwogICAgICBpZiAoIXRoaXMuaXNJbnZlcnNlKCkpIHsKICAgICAgICBncm91cGVkS2V5ID0gbW9kZWwuaWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZvcm1hdHRlZCA9IG1vZGVsLmZvcm1hdChfLmV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCBtb2RlbC5hdHRyaWJ1dGVzKSk7CiAgICAgICAgZ3JvdXBlZEtleSA9IHRoaXMuaXNUaHJvdWdoKCkgPyBmb3JtYXR0ZWRbdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JyldIDogZm9ybWF0dGVkW3RoaXMua2V5KCdmb3JlaWduS2V5JyldOwogICAgICB9CiAgICAgIHZhciByZWxhdGlvbiA9IG1vZGVsLnJlbGF0aW9uc1tyZWxhdGlvbk5hbWVdID0gdGhpcy5yZWxhdGVkSW5zdGFuY2UoZ3JvdXBlZFtncm91cGVkS2V5XSk7CiAgICAgIHJlbGF0aW9uLnJlbGF0ZWREYXRhID0gdGhpczsKICAgICAgaWYgKHRoaXMuaXNKb2luZWQoKSkgXy5leHRlbmQocmVsYXRpb24sIHBpdm90SGVscGVycyk7CiAgICB9CgogICAgLy8gTm93IHRoYXQgcmVsYXRlZCBtb2RlbHMgaGF2ZSBiZWVuIHN1Y2Nlc3NmdWxseSBwYWlyZWQsIHVwZGF0ZSBlYWNoIHdpdGgKICAgIC8vIGl0cyBwYXJzZWQgYXR0cmlidXRlcwogICAgZm9yIChpID0gMCwgbCA9IHJlbGF0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIG1vZGVsID0gcmVsYXRlZFtpXTsKICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IG1vZGVsLnBhcnNlKG1vZGVsLmF0dHJpYnV0ZXMpOwogICAgfQoKICAgIHJldHVybiByZWxhdGVkOwogIH0sCgogIC8vIFRoZSBgbW9kZWxzYCBpcyBhbiBhcnJheSBvZiBtb2RlbHMgcmV0dXJuZWQgZnJvbSB0aGUgZmV0Y2gsCiAgLy8gYWZ0ZXIgdGhleSdyZSBgc2V0YC4uLiBwYXJzaW5nIG91dCBhbnkgb2YgdGhlIGBfcGl2b3RfYCBpdGVtcyBmcm9tIHRoZQogIC8vIGpvaW4gdGFibGUgYW5kIGFzc2lnbmluZyB0aGVtIG9uIHRoZSBwaXZvdCBtb2RlbCBvciBvYmplY3QgYXMgYXBwcm9wcmlhdGUuCiAgcGFyc2VQaXZvdDogZnVuY3Rpb24obW9kZWxzKSB7CiAgICB2YXIgVGhyb3VnaCA9IHRoaXMudGhyb3VnaFRhcmdldDsKICAgIHJldHVybiBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciBkYXRhID0ge30sIGtlZXAgPSB7fSwgYXR0cnMgPSBtb2RlbC5hdHRyaWJ1dGVzLCB0aHJvdWdoOwogICAgICBpZiAoVGhyb3VnaCkgdGhyb3VnaCA9IG5ldyBUaHJvdWdoKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChrZXkuaW5kZXhPZignX3Bpdm90XycpID09PSAwKSB7CiAgICAgICAgICBkYXRhW2tleS5zbGljZSg3KV0gPSBhdHRyc1trZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZWVwW2tleV0gPSBhdHRyc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICBtb2RlbC5hdHRyaWJ1dGVzID0ga2VlcDsKICAgICAgaWYgKCFfLmlzRW1wdHkoZGF0YSkpIHsKICAgICAgICBtb2RlbC5waXZvdCA9IHRocm91Z2ggPyB0aHJvdWdoLnNldChkYXRhLCB7c2lsZW50OiB0cnVlfSkgOiBuZXcgdGhpcy5Nb2RlbChkYXRhLCB7CiAgICAgICAgICB0YWJsZU5hbWU6IHRoaXMuam9pblRhYmxlKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LCB0aGlzKTsKICB9LAoKICAvLyBBIGZldyBwcmVkaWNhdGVzIHRvIGhlbHAgY2xhcmlmeSBzb21lIG9mIHRoZSBsb2dpYyBhYm92ZS4KICBpc1Rocm91Z2g6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLnRocm91Z2hUYXJnZXQgIT0gbnVsbCk7CiAgfSwKICBpc0pvaW5lZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknIHx8IHRoaXMuaXNUaHJvdWdoKCkpOwogIH0sCiAgaXNNb3JwaDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKHRoaXMudHlwZSA9PT0gJ21vcnBoT25lJyB8fCB0aGlzLnR5cGUgPT09ICdtb3JwaE1hbnknKTsKICB9LAogIGlzU2luZ2xlOiBmdW5jdGlvbigpIHsKICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgcmV0dXJuICh0eXBlID09PSAnaGFzT25lJyB8fCB0eXBlID09PSAnYmVsb25nc1RvJyB8fCB0eXBlID09PSAnbW9ycGhPbmUnIHx8IHR5cGUgPT09ICdtb3JwaFRvJyk7CiAgfSwKICBpc0ludmVyc2U6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLnR5cGUgPT09ICdiZWxvbmdzVG8nIHx8IHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nKTsKICB9LAoKICAvLyBTZXRzIHRoZSBgcGl2b3RDb2x1bW5zYCB0byBiZSByZXRyaWV2ZWQgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBtb2RlbC4KICB3aXRoUGl2b3Q6IGZ1bmN0aW9uKGNvbHVtbnMpIHsKICAgIGlmICghXy5pc0FycmF5KGNvbHVtbnMpKSBjb2x1bW5zID0gW2NvbHVtbnNdOwogICAgdGhpcy5waXZvdENvbHVtbnMgfHwgKHRoaXMucGl2b3RDb2x1bW5zID0gW10pOwogICAgcHVzaC5hcHBseSh0aGlzLnBpdm90Q29sdW1ucywgY29sdW1ucyk7CiAgfQoKfSk7CgovLyBTaW1wbGUgbWVtb2l6YXRpb24gb2YgdGhlIHNpbmd1bGFyaXplIGNhbGwuCnZhciBzaW5ndWxhck1lbW8gPSAoZnVuY3Rpb24oKSB7CiAgdmFyIGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICByZXR1cm4gZnVuY3Rpb24oYXJnKSB7CiAgICBpZiAoYXJnIGluIGNhY2hlKSB7CiAgICAgIHJldHVybiBjYWNoZVthcmddOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNhY2hlW2FyZ10gPSBpbmZsZWN0aW9uLnNpbmd1bGFyaXplKGFyZyk7CiAgICB9CiAgfTsKfSgpKTsKCi8vIFNwZWNpZmljIHRvIG1hbnktdG8tbWFueSByZWxhdGlvbnNoaXBzLCB0aGVzZSBtZXRob2RzIGFyZSBtaXhlZAovLyBpbnRvIHRoZSBgYmVsb25nc1RvTWFueWAgcmVsYXRpb25zaGlwcyB3aGVuIHRoZXkgYXJlIGNyZWF0ZWQsCi8vIHByb3ZpZGluZyBoZWxwZXJzIGZvciBhdHRhY2hpbmcgYW5kIGRldGFjaGluZyByZWxhdGVkIG1vZGVscy4KdmFyIHBpdm90SGVscGVycyA9IHsKCiAgLy8gQXR0YWNoIG9uZSBvciBtb3JlICJpZHMiIGZyb20gYSBmb3JlaWduCiAgLy8gdGFibGUgdG8gdGhlIGN1cnJlbnQuIENyZWF0ZXMgJiBzYXZlcyBhIG5ldyBtb2RlbAogIC8vIGFuZCBhdHRhY2hlcyB0aGUgbW9kZWwgd2l0aCBhIGpvaW4gdGFibGUgZW50cnkuCiAgYXR0YWNoOiBmdW5jdGlvbihpZHMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykudGhlbihmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy50cmlnZ2VyVGhlbignYXR0YWNoaW5nJywgdGhpcywgaWRzLCBvcHRpb25zKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVyKCdpbnNlcnQnLCBpZHMsIG9wdGlvbnMpOwogICAgfSkudGhlbihmdW5jdGlvbihyZXNwKSB7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdhdHRhY2hlZCcsIHRoaXMsIHJlc3AsIG9wdGlvbnMpOwogICAgfSk7CiAgfSwKCiAgLy8gRGV0YWNoIHJlbGF0ZWQgb2JqZWN0IGZyb20gdGhlaXIgcGl2b3QgdGFibGVzLgogIC8vIElmIGEgbW9kZWwgb3IgaWQgaXMgcGFzc2VkLCBpdCBhdHRlbXB0cyB0byByZW1vdmUgdGhlCiAgLy8gcGl2b3QgdGFibGUgYmFzZWQgb24gdGhhdCBmb3JlaWduIGtleS4gSWYgYSBoYXNoIGlzIHBhc3NlZCwKICAvLyBpdCBhdHRlbXB0cyB0byByZW1vdmUgdGhlIGl0ZW0gYmFzZWQgb24gYSB3aGVyZSBjbGF1c2Ugd2l0aAogIC8vIHRoZXNlIHBhcmFtZXRlcnMuIElmIG5vIHBhcmFtZXRlcnMgYXJlIHNwZWNpZmllZCwgd2UgYXNzdW1lIHdlIHdpbGwKICAvLyBkZXRhY2ggYWxsIHJlbGF0ZWQgYXNzb2NpYXRpb25zLgogIGRldGFjaDogZnVuY3Rpb24oaWRzLCBvcHRpb25zKSB7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2RldGFjaGluZycsIHRoaXMsIGlkcywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5faGFuZGxlcignZGVsZXRlJywgaWRzLCBvcHRpb25zKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gdGhpcy50cmlnZ2VyVGhlbignZGV0YWNoZWQnLCB0aGlzLCByZXNwLCBvcHRpb25zKTsKICAgIH0pOwogIH0sCgogIC8vIFVwZGF0ZSBhbiBleGlzdGluZyByZWxhdGlvbidzIHBpdm90IHRhYmxlIGVudHJ5LgogIHVwZGF0ZVBpdm90OiBmdW5jdGlvbihkYXRhLCBvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5faGFuZGxlcigndXBkYXRlJywgZGF0YSwgb3B0aW9ucyk7CiAgfSwKCiAgLy8gU2VsZWN0cyBhbnkgYWRkaXRpb25hbCBjb2x1bW5zIG9uIHRoZSBwaXZvdCB0YWJsZSwKICAvLyB0YWtpbmcgYSBoYXNoIG9mIGNvbHVtbnMgd2hpY2ggc3BlY2lmaWVzIHRoZSBwaXZvdAogIC8vIGNvbHVtbiBuYW1lLCBhbmQgdGhlIHZhbHVlIHRoZSBjb2x1bW4gc2hvdWxkIHRha2Ugb24gdGhlCiAgLy8gb3V0cHV0IHRvIHRoZSBtb2RlbCBhdHRyaWJ1dGVzLgogIHdpdGhQaXZvdDogZnVuY3Rpb24oY29sdW1ucykgewogICAgdGhpcy5yZWxhdGVkRGF0YS53aXRoUGl2b3QoY29sdW1ucyk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyBIZWxwZXIgZm9yIGhhbmRsaW5nIGVpdGhlciB0aGUgYGF0dGFjaGAgb3IgYGRldGFjaGAgY2FsbCBvbgogIC8vIHRoZSBgYmVsb25nc1RvTWFueWAgb3IgYGhhc09uZWAgLyBgaGFzTWFueWAgOnRocm91Z2ggcmVsYXRpb25zaGlwLgogIF9oYW5kbGVyOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihtZXRob2QsIGlkcywgb3B0aW9ucykgewogICAgdmFyIHBlbmRpbmcgPSBbXTsKICAgIGlmIChpZHMgPT0gdm9pZCAwKSB7CiAgICAgIGlmIChtZXRob2QgPT09ICdpbnNlcnQnKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpOwogICAgICBpZiAobWV0aG9kID09PSAnZGVsZXRlJykgcGVuZGluZy5wdXNoKHRoaXMuX3Byb2Nlc3NQaXZvdChtZXRob2QsIG51bGwsIG9wdGlvbnMpKTsKICAgIH0KICAgIGlmICghXy5pc0FycmF5KGlkcykpIGlkcyA9IGlkcyA/IFtpZHNdIDogW107CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGlkcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcGVuZGluZy5wdXNoKHRoaXMuX3Byb2Nlc3NQaXZvdChtZXRob2QsIGlkc1tpXSwgb3B0aW9ucykpOwogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKHBlbmRpbmcpLnlpZWxkKHRoaXMpOwogIH0pLAoKICAvLyBIYW5kbGVzIHNldHRpbmcgdGhlIGFwcHJvcHJpYXRlIGNvbnN0cmFpbnRzIGFuZCBzaGVsbGluZyBvdXQKICAvLyB0byBlaXRoZXIgdGhlIGBpbnNlcnRgIG9yIGBkZWxldGVgIGNhbGwgZm9yIHRoZSBjdXJyZW50IG1vZGVsLAogIC8vIHJldHVybmluZyBhIHByb21pc2UuCiAgX3Byb2Nlc3NQaXZvdDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24obWV0aG9kLCBpdGVtLCBvcHRpb25zKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHJlbGF0ZWREYXRhID0gdGhpcy5yZWxhdGVkRGF0YTsKCiAgICAvLyBHcmFiIHRoZSBga25leGAgcXVlcnkgYnVpbGRlciBmb3IgdGhlIGN1cnJlbnQgbW9kZWwsIGFuZAogICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSBhbnkgYWRkaXRpb25hbCBjb25zdHJhaW50cyBmb3IgdGhlIHF1ZXJ5LgogICAgdmFyIGJ1aWxkZXIgPSB0aGlzLl9idWlsZGVyKHJlbGF0ZWREYXRhLmpvaW5UYWJsZSgpKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucXVlcnkpIHsKICAgICAgSGVscGVycy5xdWVyeS5jYWxsKG51bGwsIHtfa25leDogYnVpbGRlcn0sIFtvcHRpb25zLnF1ZXJ5XSk7CiAgICB9CgogICAgZGF0YVtyZWxhdGVkRGF0YS5rZXkoJ2ZvcmVpZ25LZXknKV0gPSByZWxhdGVkRGF0YS5wYXJlbnRGazsKCiAgICAvLyBJZiB0aGUgaXRlbSBpcyBhbiBvYmplY3QsIGl0J3MgZWl0aGVyIGEgbW9kZWwKICAgIC8vIHRoYXQgd2UncmUgbG9va2luZyB0byBhdHRhY2ggdG8gdGhpcyBtb2RlbCwgb3IKICAgIC8vIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIHNldCBpbiB0aGUgcmVsYXRpb24uCiAgICBpZiAoXy5pc09iamVjdChpdGVtKSkgewogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICAgIGRhdGFbcmVsYXRlZERhdGEua2V5KCdvdGhlcktleScpXSA9IGl0ZW0uaWQ7CiAgICAgIH0gZWxzZSBpZiAobWV0aG9kICE9PSAndXBkYXRlJykgewogICAgICAgIF8uZXh0ZW5kKGRhdGEsIGl0ZW0pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGl0ZW0pIHsKICAgICAgZGF0YVtyZWxhdGVkRGF0YS5rZXkoJ290aGVyS2V5JyldID0gaXRlbTsKICAgIH0KCiAgICBpZiAob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy50cmFuc2FjdGluZykgYnVpbGRlci50cmFuc2FjdGluZyhvcHRpb25zLnRyYW5zYWN0aW5nKTsKICAgICAgaWYgKG9wdGlvbnMuZGVidWcpIGJ1aWxkZXIuZGVidWcoKTsKICAgIH0KICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgIGlmIChtZXRob2QgPT09ICdkZWxldGUnKSB7CiAgICAgIHJldHVybiBidWlsZGVyLndoZXJlKGRhdGEpLmRlbCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1vZGVsOwogICAgICAgIGlmICghaXRlbSkgcmV0dXJuIGNvbGxlY3Rpb24ucmVzZXQoKTsKICAgICAgICBpZiAobW9kZWwgPSBjb2xsZWN0aW9uLmdldChkYXRhW3JlbGF0ZWREYXRhLmtleSgnb3RoZXJLZXknKV0pKSB7CiAgICAgICAgICBjb2xsZWN0aW9uLnJlbW92ZShtb2RlbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGlmIChtZXRob2QgPT09ICd1cGRhdGUnKSB7CiAgICAgIHJldHVybiBidWlsZGVyLndoZXJlKGRhdGEpLnVwZGF0ZShpdGVtKS50aGVuKGZ1bmN0aW9uIChudW1VcGRhdGVkKSB7CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5yZXF1aXJlID09PSB0cnVlICYmIG51bVVwZGF0ZWQgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcm93cyB3ZXJlIHVwZGF0ZWQnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bVVwZGF0ZWQ7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiBidWlsZGVyLmluc2VydChkYXRhKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBjb2xsZWN0aW9uLmFkZChpdGVtKTsKICAgIH0pOwogIH0pCgp9OwoKbW9kdWxlLmV4cG9ydHMgPSBCb29rc2hlbGZSZWxhdGlvbjsKCn0seyIuL2Jhc2UvbW9kZWwiOjUsIi4vYmFzZS9wcm9taXNlIjo2LCIuL2Jhc2UvcmVsYXRpb24iOjcsIi4vaGVscGVycyI6MTEsImluZmxlY3Rpb24iOjc1LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBTeW5jCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4vYmFzZS9wcm9taXNlJyk7CgovLyBTeW5jIGlzIHRoZSBkaXNwYXRjaGVyIGZvciBhbnkgZGF0YWJhc2UgcXVlcmllcywKLy8gdGFraW5nIHRoZSAic3luY2luZyIgYG1vZGVsYCBvciBgY29sbGVjdGlvbmAgYmVpbmcgcXVlcmllZCwgYWxvbmcgd2l0aAovLyBhIGhhc2ggb2Ygb3B0aW9ucyB0aGF0IGFyZSB1c2VkIGluIHRoZSB2YXJpb3VzIHF1ZXJ5IG1ldGhvZHMuCi8vIElmIHRoZSBgdHJhbnNhY3RpbmdgIG9wdGlvbiBpcyBzZXQsIHRoZSBxdWVyeSBpcyBhc3N1bWVkIHRvIGJlCi8vIHBhcnQgb2YgYSB0cmFuc2FjdGlvbiwgYW5kIHRoaXMgaW5mb3JtYXRpb24gaXMgcGFzc2VkIGFsb25nIHRvIGBLbmV4YC4KdmFyIFN5bmMgPSBmdW5jdGlvbihzeW5jaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgdGhpcy5xdWVyeSAgID0gc3luY2luZy5xdWVyeSgpOwogIHRoaXMuc3luY2luZyA9IHN5bmNpbmcucmVzZXRRdWVyeSgpOwogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgaWYgKG9wdGlvbnMuZGVidWcpIHRoaXMucXVlcnkuZGVidWcoKTsKICBpZiAob3B0aW9ucy50cmFuc2FjdGluZykgdGhpcy5xdWVyeS50cmFuc2FjdGluZyhvcHRpb25zLnRyYW5zYWN0aW5nKTsKfTsKCl8uZXh0ZW5kKFN5bmMucHJvdG90eXBlLCB7CgogIC8vIFByZWZpeCBhbGwga2V5cyBvZiB0aGUgcGFzc2VkIGluIG9iamVjdCB3aXRoIHRoZQogIC8vIGN1cnJlbnQgdGFibGUgbmFtZQogIHByZWZpeEZpZWxkczogZnVuY3Rpb24oZmllbGRzKSB7CiAgICB2YXIgdGFibGVOYW1lID0gdGhpcy5zeW5jaW5nLnRhYmxlTmFtZTsKICAgIHZhciBwcmVmaXhlZCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIGZpZWxkcykgewogICAgICBwcmVmaXhlZFt0YWJsZU5hbWUgKyAnLicgKyBrZXldID0gZmllbGRzW2tleV07CiAgICB9CiAgICByZXR1cm4gcHJlZml4ZWQ7CiAgfSwKCiAgLy8gU2VsZWN0IHRoZSBmaXJzdCBpdGVtIGZyb20gdGhlIGRhdGFiYXNlIC0gb25seSB1c2VkIGJ5IG1vZGVscy4KICBmaXJzdDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgICB0aGlzLnF1ZXJ5LndoZXJlKHRoaXMucHJlZml4RmllbGRzKHRoaXMuc3luY2luZy5mb3JtYXQoCiAgICAgIF8uZXh0ZW5kKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuc3luY2luZy5hdHRyaWJ1dGVzKQogICAgKSkpLmxpbWl0KDEpOwogICAgcmV0dXJuIHRoaXMuc2VsZWN0KCk7CiAgfSksCgogIC8vIFJ1bnMgYSBgc2VsZWN0YCBxdWVyeSBvbiB0aGUgZGF0YWJhc2UsIGFkZGluZyBhbnkgbmVjZXNzYXJ5IHJlbGF0aW9uYWwKICAvLyBjb25zdHJhaW50cywgcmVzZXR0aW5nIHRoZSBxdWVyeSB3aGVuIGNvbXBsZXRlLiBJZiB0aGVyZSBhcmUgcmVzdWx0cyBhbmQKICAvLyBlYWdlciBsb2FkZWQgcmVsYXRpb25zLCB0aG9zZSBhcmUgZmV0Y2hlZCBhbmQgcmV0dXJuZWQgb24gdGhlIG1vZGVsIGJlZm9yZQogIC8vIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkLiBBbnkgYHN1Y2Nlc3NgIGhhbmRsZXIgcGFzc2VkIGluIHRoZQogIC8vIG9wdGlvbnMgd2lsbCBiZSBjYWxsZWQgLSB1c2VkIGJ5IGJvdGggbW9kZWxzICYgY29sbGVjdGlvbnMuCiAgc2VsZWN0OiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICAgIHZhciBjb2x1bW5zLCBzeW5jID0gdGhpcywKICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVsYXRlZERhdGEgPSB0aGlzLnN5bmNpbmcucmVsYXRlZERhdGE7CiAgICB2YXIga25leCA9IHRoaXMucXVlcnk7CgogICAgLy8gSW5qZWN0IGFsbCBhcHByb3ByaWF0ZSBzZWxlY3QgY29zdHJhaW50cyBkZWFsaW5nIHdpdGggdGhlIHJlbGF0aW9uCiAgICAvLyBpbnRvIHRoZSBga25leGAgcXVlcnkgYnVpbGRlciBmb3IgdGhlIGN1cnJlbnQgaW5zdGFuY2UuCiAgICBpZiAocmVsYXRlZERhdGEpIHsKICAgICAgcmVsYXRlZERhdGEuc2VsZWN0Q29uc3RyYWludHMoa25leCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICBjb2x1bW5zID0gb3B0aW9ucy5jb2x1bW5zOwogICAgICAvLyBDYWxsIHRoZSBmdW5jdGlvbiwgaWYgb25lIGV4aXN0cywgdG8gY29uc3RyYWluIHRoZSBlYWdlciBsb2FkZWQgcXVlcnkuCiAgICAgIGlmIChvcHRpb25zLl9iZWZvcmVGbikgb3B0aW9ucy5fYmVmb3JlRm4uY2FsbChrbmV4LCBrbmV4KTsKICAgICAgaWYgKCFfLmlzQXJyYXkoY29sdW1ucykpIGNvbHVtbnMgPSBjb2x1bW5zID8gW2NvbHVtbnNdIDogW18ucmVzdWx0KHRoaXMuc3luY2luZywgJ3RhYmxlTmFtZScpICsgJy4qJ107CiAgICB9CgogICAgLy8gU2V0IHRoZSBxdWVyeSBidWlsZGVyIG9uIHRoZSBvcHRpb25zLCBpbi1jYXNlIHdlIG5lZWQgdG8KICAgIC8vIGFjY2VzcyBpbiB0aGUgYGZldGNoaW5nYCBldmVudCBoYW5kbGVycy4KICAgIG9wdGlvbnMucXVlcnkgPSBrbmV4OwoKICAgIC8vIFRyaWdnZXIgYSBgZmV0Y2hpbmdgIGV2ZW50IG9uIHRoZSBtb2RlbCwgYW5kIHRoZW4gc2VsZWN0IHRoZSBhcHByb3ByaWF0ZSBjb2x1bW5zLgogICAgcmV0dXJuIFByb21pc2UuYmluZCh0aGlzKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5zeW5jaW5nLnRyaWdnZXJUaGVuKCdmZXRjaGluZycsIHRoaXMuc3luY2luZywgY29sdW1ucywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4ga25leC5zZWxlY3QoY29sdW1ucyk7CiAgICB9KTsKICB9KSwKCiAgLy8gSXNzdWVzIGFuIGBpbnNlcnRgIGNvbW1hbmQgb24gdGhlIHF1ZXJ5IC0gb25seSB1c2VkIGJ5IG1vZGVscy4KICBpbnNlcnQ6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkgewogICAgdmFyIHN5bmNpbmcgPSB0aGlzLnN5bmNpbmc7CiAgICByZXR1cm4gdGhpcy5xdWVyeS5pbnNlcnQoc3luY2luZy5mb3JtYXQoXy5leHRlbmQoT2JqZWN0LmNyZWF0ZShudWxsKSwgc3luY2luZy5hdHRyaWJ1dGVzKSksIHN5bmNpbmcuaWRBdHRyaWJ1dGUpOwogIH0pLAoKICAvLyBJc3N1ZXMgYW4gYHVwZGF0ZWAgY29tbWFuZCBvbiB0aGUgcXVlcnkgLSBvbmx5IHVzZWQgYnkgbW9kZWxzLgogIHVwZGF0ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oYXR0cnMpIHsKICAgIHZhciBzeW5jaW5nID0gdGhpcy5zeW5jaW5nLCBxdWVyeSA9IHRoaXMucXVlcnk7CiAgICBpZiAoc3luY2luZy5pZCAhPSBudWxsKSBxdWVyeS53aGVyZShzeW5jaW5nLmlkQXR0cmlidXRlLCBzeW5jaW5nLmlkKTsKICAgIGlmIChfLndoZXJlKHF1ZXJ5Ll9zdGF0ZW1lbnRzLCB7Z3JvdXBpbmc6ICd3aGVyZSd9KS5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIG1vZGVsIGNhbm5vdCBiZSB1cGRhdGVkIHdpdGhvdXQgYSAid2hlcmUiIGNsYXVzZSBvciBhbiBpZEF0dHJpYnV0ZS4nKTsKICAgIH0KICAgIHJldHVybiBxdWVyeS51cGRhdGUoc3luY2luZy5mb3JtYXQoXy5leHRlbmQoT2JqZWN0LmNyZWF0ZShudWxsKSwgYXR0cnMpKSk7CiAgfSksCgogIC8vIElzc3VlcyBhIGBkZWxldGVgIGNvbW1hbmQgb24gdGhlIHF1ZXJ5LgogIGRlbDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgICB2YXIgcXVlcnkgPSB0aGlzLnF1ZXJ5LCBzeW5jaW5nID0gdGhpcy5zeW5jaW5nOwogICAgaWYgKHN5bmNpbmcuaWQgIT0gbnVsbCkgcXVlcnkud2hlcmUoc3luY2luZy5pZEF0dHJpYnV0ZSwgc3luY2luZy5pZCk7CiAgICBpZiAoXy53aGVyZShxdWVyeS5fc3RhdGVtZW50cywge2dyb3VwaW5nOiAnd2hlcmUnfSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQSBtb2RlbCBjYW5ub3QgYmUgZGVzdHJveWVkIHdpdGhvdXQgYSAid2hlcmUiIGNsYXVzZSBvciBhbiBpZEF0dHJpYnV0ZS4nKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnF1ZXJ5LmRlbCgpOwogIH0pCgp9KTsKCm1vZHVsZS5leHBvcnRzID0gU3luYzsKfSx7Ii4vYmFzZS9wcm9taXNlIjo2LCJsb2Rhc2giOjEzMH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gICAgIEJhY2tib25lLmpzIDEuMS4wCgovLyAgICAgKGMpIDIwMTAtMjAxMSBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgKGMpIDIwMTEtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBCYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwKICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCB0aGUgYnJvd3NlciBhbmQgdGhlIHNlcnZlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMCc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCiAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2suX2NhbGxiYWNrKSB8fAogICAgICAgICAgICAgICAgICAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewogICAgICAgICAgICAgICAgcmV0YWluLnB1c2goZXYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIHRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwogICAgICBpZiAoZXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CiAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgogICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CiAgICAgIGlmICghbGlzdGVuaW5nVG8pIHJldHVybiB0aGlzOwogICAgICB2YXIgcmVtb3ZlID0gIW5hbWUgJiYgIWNhbGxiYWNrOwogICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKSAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CiAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwogICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmIChyZW1vdmUgfHwgXy5pc0VtcHR5KG9iai5fZXZlbnRzKSkgZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgfTsKCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwoKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CgogICAgLy8gSGFuZGxlIGV2ZW50IG1hcHMuCiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCiAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAogIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwogICAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSk7IHJldHVybjsKICAgICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsgcmV0dXJuOwogICAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwogICAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgogIC8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCiAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogIC8vIGxpc3RlbmluZyB0by4KICBfLmVhY2gobGlzdGVuTWV0aG9kcywgZnVuY3Rpb24oaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CiAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgfQogICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IHRydWU7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgogICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7CiAgICB9LAoKICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlKHt9LCBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7IHZhbGlkYXRlOiB0cnVlIH0pKTsKICAgIH0sCgogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KICAgIF92YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zLCB7dmFsaWRhdGlvbkVycm9yOiBlcnJvcn0pKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgogIHZhciBtb2RlbE1ldGhvZHMgPSBbJ2tleXMnLCAndmFsdWVzJywgJ3BhaXJzJywgJ2ludmVydCcsICdwaWNrJywgJ29taXQnXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgTW9kZWwjYXR0cmlidXRlc2AuCiAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwogIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAogIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgogIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgogIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgoKICAvLyBDcmVhdGUgYSBuZXcgKipDb2xsZWN0aW9uKiosIHBlcmhhcHMgdG8gY29udGFpbiBhIHNwZWNpZmljIHR5cGUgb2YgYG1vZGVsYC4KICAvLyBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMubW9kZWwpIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICB9OwoKICAvLyBEZWZhdWx0IG9wdGlvbnMgZm9yIGBDb2xsZWN0aW9uI3NldGAuCiAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKICB2YXIgYWRkT3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogZmFsc2V9OwoKICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgogIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCiAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICBtb2RlbDogTW9kZWwsCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCiAgICAvLyBtb2RlbHMnIGF0dHJpYnV0ZXMuCiAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgogICAgYWRkOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoe21lcmdlOiBmYWxzZX0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwsIG9yIGEgbGlzdCBvZiBtb2RlbHMgZnJvbSB0aGUgc2V0LgogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IFttb2RlbHNdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCiAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CiAgICAvLyBhbHJlYWR5IGV4aXN0IGluIHRoZSBjb2xsZWN0aW9uLCBhcyBuZWNlc3NhcnkuIFNpbWlsYXIgdG8gKipNb2RlbCNzZXQqKiwKICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgogICAgc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gKG1vZGVscyA/IFttb2RlbHNdIDogW10pIDogXy5jbG9uZShtb2RlbHMpOwogICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICAgIHZhciB0YXJnZXRNb2RlbCA9IHRoaXMubW9kZWw7CiAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiAoYXQgPT0gbnVsbCkgJiYgb3B0aW9ucy5zb3J0ICE9PSBmYWxzZTsKICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKICAgICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CiAgICAgIHZhciBhZGQgPSBvcHRpb25zLmFkZCwgbWVyZ2UgPSBvcHRpb25zLm1lcmdlLCByZW1vdmUgPSBvcHRpb25zLnJlbW92ZTsKICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGF0dHJzID0gbW9kZWxzW2ldOwogICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlXTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgaWYgKG1lcmdlKSB7CiAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gYWRkZWQgbW9kZWxzJyBldmVudHMsIGFuZCBpbmRleCBtb2RlbHMgZm9yIGxvb2t1cCBieQogICAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgfQogICAgICAgIGlmIChvcmRlcikgb3JkZXIucHVzaChleGlzdGluZyB8fCBtb2RlbCk7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF0gfHwgdGhpcy5fYnlJZFtvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCgogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAvLyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikgcmV0dXJuIG1vZGVsOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBtb2RlbC52YWxpZGF0aW9uRXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbiddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuCiAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgogIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5J107CgogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAogICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgdmFyIHhociA9IG9wdGlvbnMueGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgdmFyIG5vWGhyUGF0Y2ggPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIChuZXcgWE1MSHR0cFJlcXVlc3QpLmRpc3BhdGNoRXZlbnQpOwoKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICAnUEFUQ0gnLAogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAogICAgJ3JlYWQnOiAgICdHRVQnCiAgfTsKCiAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICAvLyBPdmVycmlkZSB0aGlzIGlmIHlvdSdkIGxpa2UgdG8gdXNlIGEgZGlmZmVyZW50IGxpYnJhcnkuCiAgQmFja2JvbmUuYWpheCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwogIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICBuYW1lID0gJyc7CiAgICAgIH0KICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseShyb3V0ZXIsIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAoKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXlwvXSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCiAgICAvLyB0cmVhdGVkIGFzIGBudWxsYCB0byBub3JtYWxpemUgY3Jvc3MtYnJvd3NlciBiZWhhdmlvci4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgICAgcmV0dXJuIF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsKICAgICAgICByZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKICAgICAgfSk7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQogIC8vIGFuZCBVUkwgZnJhZ21lbnRzLiBJZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBuZWl0aGVyIChvbGQgSUUsIG5hdGNoKSwKICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCiAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CgogICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CiAgICB9CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgogIHZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCiAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgogIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KICB2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2ggYW5kIHF1ZXJ5LgogIHZhciBwYXRoU3RyaXBwZXIgPSAvWz8jXS4qJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuaWZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIiAvPicpLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgIH0KCiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCiAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCiAgICAgIC8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCiAgICAgIC8vIHJlcXVlc3RlZC4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewogICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICB9LAoKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwogICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6ICEhb3B0aW9uc307CgogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwoKICAgICAgLy8gU3RyaXAgdGhlIGZyYWdtZW50IG9mIHRoZSBxdWVyeSBhbmQgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CiAgfTsKCn0pLmNhbGwodGhpcyk7Cgp9LHsidW5kZXJzY29yZSI6MTZ9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vICAgICBVbmRlcnNjb3JlLmpzIDEuNy4wCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIKICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCiAgLy8gQWxsICoqRUNNQVNjcmlwdCA1KiogbmF0aXZlIGZ1bmN0aW9uIGltcGxlbWVudGF0aW9ucyB0aGF0IHdlIGhvcGUgdG8gdXNlCiAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCiAgdmFyCiAgICBuYXRpdmVJc0FycmF5ICAgICAgPSBBcnJheS5pc0FycmF5LAogICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCiAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSByZXR1cm4gbmV3IF8ob2JqKTsKICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CiAgfTsKCiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0LgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdC5fID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS43LjAnOwoKICAvLyBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gZWZmaWNpZW50IChmb3IgY3VycmVudCBlbmdpbmVzKSB2ZXJzaW9uCiAgLy8gb2YgdGhlIHBhc3NlZC1pbiBjYWxsYmFjaywgdG8gYmUgcmVwZWF0ZWRseSBhcHBsaWVkIGluIG90aGVyIFVuZGVyc2NvcmUKICAvLyBmdW5jdGlvbnMuCiAgdmFyIGNyZWF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCwgYXJnQ291bnQpIHsKICAgIGlmIChjb250ZXh0ID09PSB2b2lkIDApIHJldHVybiBmdW5jOwogICAgc3dpdGNoIChhcmdDb3VudCA9PSBudWxsID8gMyA6IGFyZ0NvdW50KSB7CiAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSk7CiAgICAgIH07CiAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBvdGhlcikgewogICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUsIG90aGVyKTsKICAgICAgfTsKICAgICAgY2FzZSAzOiByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9OwogICAgICBjYXNlIDQ6IHJldHVybiBmdW5jdGlvbihhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgIH07CiAgfTsKCiAgLy8gQSBtb3N0bHktaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgY2FsbGJhY2tzIHRoYXQgY2FuIGJlIGFwcGxpZWQKICAvLyB0byBlYWNoIGVsZW1lbnQgaW4gYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgdGhlIGRlc2lyZWQgcmVzdWx0IOKAlCBlaXRoZXIKICAvLyBpZGVudGl0eSwgYW4gYXJiaXRyYXJ5IGNhbGxiYWNrLCBhIHByb3BlcnR5IG1hdGNoZXIsIG9yIGEgcHJvcGVydHkgYWNjZXNzb3IuCiAgXy5pdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCkgewogICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBfLmlkZW50aXR5OwogICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHJldHVybiBjcmVhdGVDYWxsYmFjayh2YWx1ZSwgY29udGV4dCwgYXJnQ291bnQpOwogICAgaWYgKF8uaXNPYmplY3QodmFsdWUpKSByZXR1cm4gXy5tYXRjaGVzKHZhbHVlKTsKICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKICB9OwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgcmF3IG9iamVjdHMgaW4gYWRkaXRpb24gdG8gYXJyYXktbGlrZXMuIFRyZWF0cyBhbGwKICAvLyBzcGFyc2UgYXJyYXktbGlrZXMgYXMgaWYgdGhleSB3ZXJlIGRlbnNlLgogIF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIG9iajsKICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgdmFyIGksIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoID09PSArbGVuZ3RoKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGl0ZXJhdGVlKG9ialtpXSwgaSwgb2JqKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGl0ZXJhdGVlKG9ialtrZXlzW2ldXSwga2V5c1tpXSwgb2JqKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdGVlIHRvIGVhY2ggZWxlbWVudC4KICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCiAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgcmVzdWx0cyA9IEFycmF5KGxlbmd0aCksCiAgICAgICAgY3VycmVudEtleTsKICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICByZXN1bHRzW2luZGV4XSA9IGl0ZXJhdGVlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBtZW1vLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgNCk7CiAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAogICAgICAgIGluZGV4ID0gMCwgY3VycmVudEtleTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICBpZiAoIWxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICAgIG1lbW8gPSBvYmpba2V5cyA/IGtleXNbaW5kZXgrK10gOiBpbmRleCsrXTsKICAgIH0KICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CiAgICAgIG1lbW8gPSBpdGVyYXRlZShtZW1vLCBvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaik7CiAgICB9CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCA0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gKyBvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGluZGV4ID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgY3VycmVudEtleTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICBpZiAoIWluZGV4KSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgICAgbWVtbyA9IG9ialtrZXlzID8ga2V5c1stLWluZGV4XSA6IC0taW5kZXhdOwogICAgfQogICAgd2hpbGUgKGluZGV4LS0pIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwogICAgfQogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBfLnNvbWUob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocHJlZGljYXRlKHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgXy5uZWdhdGUoXy5pdGVyYXRlZShwcmVkaWNhdGUpKSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCiAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CiAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICBpZiAoIXByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAogICAgICAgIGluZGV4LCBjdXJyZW50S2V5OwogICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKICAgICAgaWYgKHByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KICBfLmNvbnRhaW5zID0gXy5pbmNsdWRlID0gZnVuY3Rpb24ob2JqLCB0YXJnZXQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwogICAgcmV0dXJuIF8uaW5kZXhPZihvYmosIHRhcmdldCkgPj0gMDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIF8ucHJvcGVydHkoa2V5KSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICB2YWx1ZSwgY29tcHV0ZWQ7CiAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewogICAgICBvYmogPSBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZSA9IG9ialtpXTsKICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gLUluZmluaXR5ICYmIHJlc3VsdCA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQgPSBJbmZpbml0eSwgbGFzdENvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgdmFsdWUsIGNvbXB1dGVkOwogICAgaWYgKGl0ZXJhdGVlID09IG51bGwgJiYgb2JqICE9IG51bGwpIHsKICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWUgPSBvYmpbaV07CiAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CiAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgICBpZiAoY29tcHV0ZWQgPCBsYXN0Q29tcHV0ZWQgfHwgY29tcHV0ZWQgPT09IEluZmluaXR5ICYmIHJlc3VsdCA9PT0gSW5maW5pdHkpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhIGNvbGxlY3Rpb24sIHVzaW5nIHRoZSBtb2Rlcm4gdmVyc2lvbiBvZiB0aGUKICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgc2V0ID0gb2JqICYmIG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqIDogXy52YWx1ZXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBzZXQubGVuZ3RoOwogICAgdmFyIHNodWZmbGVkID0gQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGluZGV4ID0gMCwgcmFuZDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKDAsIGluZGV4KTsKICAgICAgaWYgKHJhbmQgIT09IGluZGV4KSBzaHVmZmxlZFtpbmRleF0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSBzZXRbaW5kZXhdOwogICAgfQogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIFNhbXBsZSAqKm4qKiByYW5kb20gdmFsdWVzIGZyb20gYSBjb2xsZWN0aW9uLgogIC8vIElmICoqbioqIGlzIG5vdCBzcGVjaWZpZWQsIHJldHVybnMgYSBzaW5nbGUgcmFuZG9tIGVsZW1lbnQuCiAgLy8gVGhlIGludGVybmFsIGBndWFyZGAgYXJndW1lbnQgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgbWFwYC4KICBfLnNhbXBsZSA9IGZ1bmN0aW9uKG9iaiwgbiwgZ3VhcmQpIHsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKICAgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwogICAgICByZXR1cm4gb2JqW18ucmFuZG9tKG9iai5sZW5ndGggLSAxKV07CiAgICB9CiAgICByZXR1cm4gXy5zaHVmZmxlKG9iaikuc2xpY2UoMCwgTWF0aC5tYXgoMCwgbikpOwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRlZS4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWE6IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCkKICAgICAgfTsKICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdC5pbmRleCAtIHJpZ2h0LmluZGV4OwogICAgfSksICd2YWx1ZScpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24oYmVoYXZpb3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgICBiZWhhdmlvcihyZXN1bHQsIHZhbHVlLCBrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0ucHVzaCh2YWx1ZSk7IGVsc2UgcmVzdWx0W2tleV0gPSBbdmFsdWVdOwogIH0pOwoKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0rKzsgZWxzZSByZXN1bHRba2V5XSA9IDE7CiAgfSk7CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0ZWUob2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IGxvdyArIGhpZ2ggPj4+IDE7CiAgICAgIGlmIChpdGVyYXRlZShhcnJheVttaWRdKSA8IHZhbHVlKSBsb3cgPSBtaWQgKyAxOyBlbHNlIGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjcmVhdGUgYSByZWFsLCBsaXZlIGFycmF5IGZyb20gYW55dGhpbmcgaXRlcmFibGUuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CiAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIFNwbGl0IGEgY29sbGVjdGlvbiBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCiAgXy5wYXJ0aXRpb24gPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwogICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqKSB7CiAgICAgIChwcmVkaWNhdGUodmFsdWUsIGtleSwgb2JqKSA/IHBhc3MgOiBmYWlsKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIFtwYXNzLCBmYWlsXTsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHJldHVybiBhcnJheVswXTsKICAgIGlmIChuIDwgMCkgcmV0dXJuIFtdOwogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBNYXRoLm1heCgwLCBhcnJheS5sZW5ndGggLSAobiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pKSk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGZpcnN0IGVudHJ5IG9mIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgdGFpbGAgYW5kIGBkcm9wYC4KICAvLyBFc3BlY2lhbGx5IHVzZWZ1bCBvbiB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyBhbiAqKm4qKiB3aWxsIHJldHVybgogIC8vIHRoZSByZXN0IE4gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKgogIC8vIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLnJlc3QgPSBfLnRhaWwgPSBfLmRyb3AgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCkgewogICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGlucHV0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlucHV0W2ldOwogICAgICBpZiAoIV8uaXNBcnJheSh2YWx1ZSkgJiYgIV8uaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgICAgaWYgKCFzdHJpY3QpIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChzaGFsbG93KSB7CiAgICAgICAgcHVzaC5hcHBseShvdXRwdXQsIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXRwdXQ7CiAgfTsKCiAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgZmFsc2UsIFtdKTsKICB9OwoKICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KICBfLndpdGhvdXQgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9OwoKICAvLyBQcm9kdWNlIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYXJyYXkuIElmIHRoZSBhcnJheSBoYXMgYWxyZWFkeQogIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgogIF8udW5pcSA9IF8udW5pcXVlID0gZnVuY3Rpb24oYXJyYXksIGlzU29ydGVkLCBpdGVyYXRlZSwgY29udGV4dCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKICAgIGlmICghXy5pc0Jvb2xlYW4oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRlZTsKICAgICAgaXRlcmF0ZWUgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIGlmIChpdGVyYXRlZSAhPSBudWxsKSBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpXTsKICAgICAgaWYgKGlzU29ydGVkKSB7CiAgICAgICAgaWYgKCFpIHx8IHNlZW4gIT09IHZhbHVlKSByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgc2VlbiA9IHZhbHVlOwogICAgICB9IGVsc2UgaWYgKGl0ZXJhdGVlKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGksIGFycmF5KTsKICAgICAgICBpZiAoXy5pbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDApIHsKICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKF8uaW5kZXhPZihyZXN1bHQsIHZhbHVlKSA8IDApIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSB1bmlvbjogZWFjaCBkaXN0aW5jdCBlbGVtZW50IGZyb20gYWxsIG9mCiAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgXy51bmlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8udW5pcShmbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgdHJ1ZSwgW10pKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIGFyZ3NMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBpdGVtID0gYXJyYXlbaV07CiAgICAgIGlmIChfLmNvbnRhaW5zKHJlc3VsdCwgaXRlbSkpIGNvbnRpbnVlOwogICAgICBmb3IgKHZhciBqID0gMTsgaiA8IGFyZ3NMZW5ndGg7IGorKykgewogICAgICAgIGlmICghXy5jb250YWlucyhhcmd1bWVudHNbal0sIGl0ZW0pKSBicmVhazsKICAgICAgfQogICAgICBpZiAoaiA9PT0gYXJnc0xlbmd0aCkgcmVzdWx0LnB1c2goaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGZsYXR0ZW4oc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCB0cnVlLCB0cnVlLCBbXSk7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KGFyZ3VtZW50cywgJ2xlbmd0aCcpLmxlbmd0aDsKICAgIHZhciByZXN1bHRzID0gQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJndW1lbnRzLCBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuIGl0ZW0gaW4gYW4gYXJyYXksCiAgLy8gb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaWR4ID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKHR5cGVvZiBmcm9tID09ICdudW1iZXInKSB7CiAgICAgIGlkeCA9IGZyb20gPCAwID8gaWR4ICsgZnJvbSArIDEgOiBNYXRoLm1pbihpZHgsIGZyb20gKyAxKTsKICAgIH0KICAgIHdoaWxlICgtLWlkeCA+PSAwKSBpZiAoYXJyYXlbaWR4XSA9PT0gaXRlbSkgcmV0dXJuIGlkeDsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCiAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKICAvLyBbdGhlIFB5dGhvbiBkb2N1bWVudGF0aW9uXShodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvZnVuY3Rpb25zLmh0bWwjcmFuZ2UpLgogIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IHN0ZXAgfHwgMTsKCiAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIHJhbmdlID0gQXJyYXkobGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCBsZW5ndGg7IGlkeCsrLCBzdGFydCArPSBzdGVwKSB7CiAgICAgIHJhbmdlW2lkeF0gPSBzdGFydDsKICAgIH0KCiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKCiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCiAgdmFyIEN0b3IgPSBmdW5jdGlvbigpe307CgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0JpbmQgbXVzdCBiZSBjYWxsZWQgb24gYSBmdW5jdGlvbicpOwogICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBDdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBDdG9yOwogICAgICBDdG9yLnByb3RvdHlwZSA9IG51bGw7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoXy5pc09iamVjdChyZXN1bHQpKSByZXR1cm4gcmVzdWx0OwogICAgICByZXR1cm4gc2VsZjsKICAgIH07CiAgICByZXR1cm4gYm91bmQ7CiAgfTsKCiAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwogIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKICAvLyBhcyBhIHBsYWNlaG9sZGVyLCBhbGxvd2luZyBhbnkgY29tYmluYXRpb24gb2YgYXJndW1lbnRzIHRvIGJlIHByZS1maWxsZWQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKICAgICAgfQogICAgICB3aGlsZSAocG9zaXRpb24gPCBhcmd1bWVudHMubGVuZ3RoKSBhcmdzLnB1c2goYXJndW1lbnRzW3Bvc2l0aW9uKytdKTsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYSBudW1iZXIgb2YgYW4gb2JqZWN0J3MgbWV0aG9kcyB0byB0aGF0IG9iamVjdC4gUmVtYWluaW5nIGFyZ3VtZW50cwogIC8vIGFyZSB0aGUgbWV0aG9kIG5hbWVzIHRvIGJlIGJvdW5kLiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQgYWxsIGNhbGxiYWNrcwogIC8vIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBpLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBrZXk7CiAgICBpZiAobGVuZ3RoIDw9IDEpIHRocm93IG5ldyBFcnJvcignYmluZEFsbCBtdXN0IGJlIHBhc3NlZCBmdW5jdGlvbiBuYW1lcycpOwogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGtleSA9IGFyZ3VtZW50c1tpXTsKICAgICAgb2JqW2tleV0gPSBfLmJpbmQob2JqW2tleV0sIG9iaik7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtb2l6ZSA9IGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgY2FjaGUgPSBtZW1vaXplLmNhY2hlOwogICAgICB2YXIgYWRkcmVzcyA9IGhhc2hlciA/IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDoga2V5OwogICAgICBpZiAoIV8uaGFzKGNhY2hlLCBhZGRyZXNzKSkgY2FjaGVbYWRkcmVzc10gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBjYWNoZVthZGRyZXNzXTsKICAgIH07CiAgICBtZW1vaXplLmNhY2hlID0ge307CiAgICByZXR1cm4gbWVtb2l6ZTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICBwcmV2aW91cyA9IG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UgPyAwIDogXy5ub3coKTsKICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIGlmICghdGltZW91dCkgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IF8ubm93KCk7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwoKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGFzdCA9IF8ubm93KCkgLSB0aW1lc3RhbXA7CgogICAgICBpZiAobGFzdCA8IHdhaXQgJiYgbGFzdCA+IDApIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRpbWVzdGFtcCA9IF8ubm93KCk7CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBpZiAoIXRpbWVvdXQpIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24oZnVuYywgd3JhcHBlcikgewogICAgcmV0dXJuIF8ucGFydGlhbCh3cmFwcGVyLCBmdW5jKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgbmVnYXRlZCB2ZXJzaW9uIG9mIHRoZSBwYXNzZWQtaW4gcHJlZGljYXRlLgogIF8ubmVnYXRlID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAhcHJlZGljYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgdmFyIHN0YXJ0ID0gYXJncy5sZW5ndGggLSAxOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgaSA9IHN0YXJ0OwogICAgICB2YXIgcmVzdWx0ID0gYXJnc1tzdGFydF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgd2hpbGUgKGktLSkgcmVzdWx0ID0gYXJnc1tpXS5jYWxsKHRoaXMsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYmVmb3JlIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYmVmb3JlID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIHZhciBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA+IDApIHsKICAgICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IF8ucGFydGlhbChfLmJlZm9yZSwgMik7CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gW107CiAgICBpZiAobmF0aXZlS2V5cykgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgcGFpcnMgPSBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwYWlyc1tpXSA9IFtrZXlzW2ldLCBvYmpba2V5c1tpXV1dOwogICAgfQogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICB2YXIgc291cmNlLCBwcm9wOwogICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAocHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIHByb3ApKSB7CiAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IG9ubHkgY29udGFpbmluZyB0aGUgd2hpdGVsaXN0ZWQgcHJvcGVydGllcy4KICBfLnBpY2sgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0ID0ge30sIGtleTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXRlcmF0ZWUpKSB7CiAgICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmpba2V5XTsKICAgICAgICBpZiAoaXRlcmF0ZWUodmFsdWUsIGtleSwgb2JqKSkgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIGlmIChrZXkgaW4gb2JqKSByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZXJhdGVlKSkgewogICAgICBpdGVyYXRlZSA9IF8ubmVnYXRlKGl0ZXJhdGVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5tYXAoY29uY2F0LmFwcGx5KFtdLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpLCBTdHJpbmcpOwogICAgICBpdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICByZXR1cm4gIV8uY29udGFpbnMoa2V5cywga2V5KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBfLnBpY2sob2JqLCBpdGVyYXRlZSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KICBfLmRlZmF1bHRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIGZvciAodmFyIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBDcmVhdGUgYSAoc2hhbGxvdy1jbG9uZWQpIGR1cGxpY2F0ZSBvZiBhbiBvYmplY3QuCiAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CgogIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KICAvLyBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sIGluCiAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBJbnRlcm5hbCByZWN1cnNpdmUgY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgYGlzRXF1YWxgLgogIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PT0gMSAvIGI7CiAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CiAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CiAgICBpZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwogICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgcmVndWxhciBleHByZXNzaW9ucywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CiAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvZXJjZWQgdG8gc3RyaW5ncyBmb3IgY29tcGFyaXNvbiAoTm90ZTogJycgKyAvYS9pID09PSAnL2EvaScpCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gJycgKyBhID09PSAnJyArIGI7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4KICAgICAgICAvLyBPYmplY3QoTmFOKSBpcyBlcXVpdmFsZW50IHRvIE5hTgogICAgICAgIGlmICgrYSAhPT0gK2EpIHJldHVybiArYiAhPT0gK2I7CiAgICAgICAgLy8gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvciBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gK2EgPT09IDAgPyAxIC8gK2EgPT09IDEgLyBiIDogK2EgPT09ICtiOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09PSArYjsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmICgKICAgICAgYUN0b3IgIT09IGJDdG9yICYmCiAgICAgIC8vIEhhbmRsZSBPYmplY3QuY3JlYXRlKHgpIGNhc2VzCiAgICAgICdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIgJiYKICAgICAgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYKICAgICAgICBfLmlzRnVuY3Rpb24oYkN0b3IpICYmIGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplLCByZXN1bHQ7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIHZhciBrZXlzID0gXy5rZXlzKGEpLCBrZXk7CiAgICAgIHNpemUgPSBrZXlzLmxlbmd0aDsKICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYmVmb3JlIGNvbXBhcmluZyBkZWVwIGVxdWFsaXR5LgogICAgICByZXN1bHQgPSBfLmtleXMoYikubGVuZ3RoID09PSBzaXplOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyCiAgICAgICAgICBrZXkgPSBrZXlzW3NpemVdOwogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSB8fCBfLmlzQXJndW1lbnRzKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciB0eXBlID0gdHlwZW9mIG9iajsKICAgIHJldHVybiB0eXBlID09PSAnZnVuY3Rpb24nIHx8IHR5cGUgPT09ICdvYmplY3QnICYmICEhb2JqOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIF8uZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIF8uaGFzKG9iaiwgJ2NhbGxlZScpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4gV29yayBhcm91bmQgYW4gSUUgMTEgYnVnLgogIGlmICh0eXBlb2YgLy4vICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ2Z1bmN0aW9uJyB8fCBmYWxzZTsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9PSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBCb29sZWFuXSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBlcXVhbCB0byBudWxsPwogIF8uaXNOdWxsID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBudWxsOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgdW5kZWZpbmVkPwogIF8uaXNVbmRlZmluZWQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKICB9OwoKICAvLyBTaG9ydGN1dCBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYW4gb2JqZWN0IGhhcyBhIGdpdmVuIHByb3BlcnR5IGRpcmVjdGx5CiAgLy8gb24gaXRzZWxmIChpbiBvdGhlciB3b3Jkcywgbm90IG9uIGEgcHJvdG90eXBlKS4KICBfLmhhcyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CiAgfTsKCiAgLy8gVXRpbGl0eSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCiAgLy8gcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5fID0gcHJldmlvdXNVbmRlcnNjb3JlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdGVlcy4KICBfLmlkZW50aXR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9OwoKICBfLmNvbnN0YW50ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9OwoKICBfLm5vb3AgPSBmdW5jdGlvbigpe307CgogIF8ucHJvcGVydHkgPSBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIG9ialtrZXldOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5tYXRjaGVzID0gZnVuY3Rpb24oYXR0cnMpIHsKICAgIHZhciBwYWlycyA9IF8ucGFpcnMoYXR0cnMpLCBsZW5ndGggPSBwYWlycy5sZW5ndGg7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuICFsZW5ndGg7CiAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwYWlyID0gcGFpcnNbaV0sIGtleSA9IHBhaXJbMF07CiAgICAgICAgaWYgKHBhaXJbMV0gIT09IG9ialtrZXldIHx8ICEoa2V5IGluIG9iaikpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCAxKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdGVlKGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIEEgKHBvc3NpYmx5IGZhc3Rlcikgd2F5IHRvIGdldCB0aGUgY3VycmVudCB0aW1lc3RhbXAgYXMgYW4gaW50ZWdlci4KICBfLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlc2NhcGVNYXAgPSB7CiAgICAnJic6ICcmYW1wOycsCiAgICAnPCc6ICcmbHQ7JywKICAgICc+JzogJyZndDsnLAogICAgJyInOiAnJnF1b3Q7JywKICAgICInIjogJyYjeDI3OycsCiAgICAnYCc6ICcmI3g2MDsnCiAgfTsKICB2YXIgdW5lc2NhcGVNYXAgPSBfLmludmVydChlc2NhcGVNYXApOwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgdmFyIGNyZWF0ZUVzY2FwZXIgPSBmdW5jdGlvbihtYXApIHsKICAgIHZhciBlc2NhcGVyID0gZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgcmV0dXJuIG1hcFttYXRjaF07CiAgICB9OwogICAgLy8gUmVnZXhlcyBmb3IgaWRlbnRpZnlpbmcgYSBrZXkgdGhhdCBuZWVkcyB0byBiZSBlc2NhcGVkCiAgICB2YXIgc291cmNlID0gJyg/OicgKyBfLmtleXMobWFwKS5qb2luKCd8JykgKyAnKSc7CiAgICB2YXIgdGVzdFJlZ2V4cCA9IFJlZ0V4cChzb3VyY2UpOwogICAgdmFyIHJlcGxhY2VSZWdleHAgPSBSZWdFeHAoc291cmNlLCAnZycpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICBzdHJpbmcgPSBzdHJpbmcgPT0gbnVsbCA/ICcnIDogJycgKyBzdHJpbmc7CiAgICAgIHJldHVybiB0ZXN0UmVnZXhwLnRlc3Qoc3RyaW5nKSA/IHN0cmluZy5yZXBsYWNlKHJlcGxhY2VSZWdleHAsIGVzY2FwZXIpIDogc3RyaW5nOwogICAgfTsKICB9OwogIF8uZXNjYXBlID0gY3JlYXRlRXNjYXBlcihlc2NhcGVNYXApOwogIF8udW5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKHVuZXNjYXBlTWFwKTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IG9iamVjdFtwcm9wZXJ0eV0oKSA6IHZhbHVlOwogIH07CgogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHUyMDI4fFx1MjAyOS9nOwoKICB2YXIgZXNjYXBlQ2hhciA9IGZ1bmN0aW9uKG1hdGNoKSB7CiAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwogIH07CgogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIC8vIE5COiBgb2xkU2V0dGluZ3NgIG9ubHkgZXhpc3RzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgc2V0dGluZ3MsIG9sZFNldHRpbmdzKSB7CiAgICBpZiAoIXNldHRpbmdzICYmIG9sZFNldHRpbmdzKSBzZXR0aW5ncyA9IG9sZFNldHRpbmdzOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKCiAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KICAgIHZhciBtYXRjaGVyID0gUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGVzY2FwZUNoYXIpOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKCiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwogICAgICB9IGVsc2UgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0gZWxzZSBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGUgKyAiXG5fX3ArPSciOwogICAgICB9CgogICAgICAvLyBBZG9iZSBWTXMgbmVlZCB0aGUgbWF0Y2ggcmV0dXJuZWQgdG8gcHJvZHVjZSB0aGUgY29ycmVjdCBvZmZlc3QuCiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHZhciBhcmd1bWVudCA9IHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonOwogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyBhcmd1bWVudCArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbi4gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBpbnN0YW5jZSA9IF8ob2JqKTsKICAgIGluc3RhbmNlLl9jaGFpbiA9IHRydWU7CiAgICByZXR1cm4gaW5zdGFuY2U7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgXy5lYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBfLmVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09PSAnc2hpZnQnIHx8IG5hbWUgPT09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CgogIC8vIEFkZCBhbGwgYWNjZXNzb3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIF8uZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogIF8ucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICB9OwoKICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCiAgLy8gdGhhdCBtYXkgbm90IGVuZm9yY2UgbmV4dC10dXJuIHNlbWFudGljcyBvbiBtb2R1bGVzLiBFdmVuIHRob3VnaCBnZW5lcmFsCiAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwogIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCiAgLy8gcG9wdWxhciBlbm91Z2ggdG8gYmUgYnVuZGxlZCBpbiBhIHRoaXJkIHBhcnR5IGxpYiwgYnV0IG5vdCBiZSBwYXJ0IG9mCiAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgogIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZSgndW5kZXJzY29yZScsIFtdLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF87CiAgICB9KTsKICB9Cn0uY2FsbCh0aGlzKSk7Cgp9LHt9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKdmFyIFNvbWVQcm9taXNlQXJyYXkgPSBQcm9taXNlLl9Tb21lUHJvbWlzZUFycmF5OwpmdW5jdGlvbiBQcm9taXNlJF9BbnkocHJvbWlzZXMpIHsKICAgIHZhciByZXQgPSBuZXcgU29tZVByb21pc2VBcnJheShwcm9taXNlcyk7CiAgICB2YXIgcHJvbWlzZSA9IHJldC5wcm9taXNlKCk7CiAgICBpZiAocHJvbWlzZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIHJldC5zZXRIb3dNYW55KDEpOwogICAgcmV0LnNldFVud3JhcCgpOwogICAgcmV0LmluaXQoKTsKICAgIHJldHVybiBwcm9taXNlOwp9CgpQcm9taXNlLmFueSA9IGZ1bmN0aW9uIFByb21pc2UkQW55KHByb21pc2VzKSB7CiAgICByZXR1cm4gUHJvbWlzZSRfQW55KHByb21pc2VzKTsKfTsKClByb21pc2UucHJvdG90eXBlLmFueSA9IGZ1bmN0aW9uIFByb21pc2UkYW55KCkgewogICAgcmV0dXJuIFByb21pc2UkX0FueSh0aGlzKTsKfTsKCn07Cgp9LHt9XSwxODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgc2NoZWR1bGUgPSByZXF1aXJlKCIuL3NjaGVkdWxlLmpzIik7CnZhciBRdWV1ZSA9IHJlcXVpcmUoIi4vcXVldWUuanMiKTsKdmFyIGVycm9yT2JqID0gcmVxdWlyZSgiLi91dGlsLmpzIikuZXJyb3JPYmo7CnZhciB0cnlDYXRjaDEgPSByZXF1aXJlKCIuL3V0aWwuanMiKS50cnlDYXRjaDE7CnZhciBfcHJvY2VzcyA9IHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiA/IHByb2Nlc3MgOiB2b2lkIDA7CgpmdW5jdGlvbiBBc3luYygpIHsKICAgIHRoaXMuX2lzVGlja1VzZWQgPSBmYWxzZTsKICAgIHRoaXMuX3NjaGVkdWxlID0gc2NoZWR1bGU7CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fbGF0ZUJ1ZmZlciA9IG5ldyBRdWV1ZSgxNik7CiAgICB0aGlzLl9mdW5jdGlvbkJ1ZmZlciA9IG5ldyBRdWV1ZSg2NTUzNik7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmNvbnN1bWVGdW5jdGlvbkJ1ZmZlciA9IGZ1bmN0aW9uIEFzeW5jJGNvbnN1bWVGdW5jdGlvbkJ1ZmZlcigpIHsKICAgICAgICBzZWxmLl9jb25zdW1lRnVuY3Rpb25CdWZmZXIoKTsKICAgIH07Cn0KCkFzeW5jLnByb3RvdHlwZS5oYXZlSXRlbXNRdWV1ZWQgPSBmdW5jdGlvbiBBc3luYyRoYXZlSXRlbXNRdWV1ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fbGVuZ3RoID4gMDsKfTsKCkFzeW5jLnByb3RvdHlwZS5pbnZva2VMYXRlciA9IGZ1bmN0aW9uIEFzeW5jJGludm9rZUxhdGVyKGZuLCByZWNlaXZlciwgYXJnKSB7CiAgICBpZiAoX3Byb2Nlc3MgIT09IHZvaWQgMCAmJgogICAgICAgIF9wcm9jZXNzLmRvbWFpbiAhPSBudWxsICYmCiAgICAgICAgIWZuLmRvbWFpbikgewogICAgICAgIGZuID0gX3Byb2Nlc3MuZG9tYWluLmJpbmQoZm4pOwogICAgfQogICAgdGhpcy5fbGF0ZUJ1ZmZlci5wdXNoKGZuLCByZWNlaXZlciwgYXJnKTsKICAgIHRoaXMuX3F1ZXVlVGljaygpOwp9OwoKQXN5bmMucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uIEFzeW5jJGludm9rZShmbiwgcmVjZWl2ZXIsIGFyZykgewogICAgaWYgKF9wcm9jZXNzICE9PSB2b2lkIDAgJiYKICAgICAgICBfcHJvY2Vzcy5kb21haW4gIT0gbnVsbCAmJgogICAgICAgICFmbi5kb21haW4pIHsKICAgICAgICBmbiA9IF9wcm9jZXNzLmRvbWFpbi5iaW5kKGZuKTsKICAgIH0KICAgIHZhciBmdW5jdGlvbkJ1ZmZlciA9IHRoaXMuX2Z1bmN0aW9uQnVmZmVyOwogICAgZnVuY3Rpb25CdWZmZXIucHVzaChmbiwgcmVjZWl2ZXIsIGFyZyk7CiAgICB0aGlzLl9sZW5ndGggPSBmdW5jdGlvbkJ1ZmZlci5sZW5ndGgoKTsKICAgIHRoaXMuX3F1ZXVlVGljaygpOwp9OwoKQXN5bmMucHJvdG90eXBlLl9jb25zdW1lRnVuY3Rpb25CdWZmZXIgPQpmdW5jdGlvbiBBc3luYyRfY29uc3VtZUZ1bmN0aW9uQnVmZmVyKCkgewogICAgdmFyIGZ1bmN0aW9uQnVmZmVyID0gdGhpcy5fZnVuY3Rpb25CdWZmZXI7CiAgICB3aGlsZSAoZnVuY3Rpb25CdWZmZXIubGVuZ3RoKCkgPiAwKSB7CiAgICAgICAgdmFyIGZuID0gZnVuY3Rpb25CdWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSBmdW5jdGlvbkJ1ZmZlci5zaGlmdCgpOwogICAgICAgIHZhciBhcmcgPSBmdW5jdGlvbkJ1ZmZlci5zaGlmdCgpOwogICAgICAgIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7CiAgICB9CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5fY29uc3VtZUxhdGVCdWZmZXIoKTsKfTsKCkFzeW5jLnByb3RvdHlwZS5fY29uc3VtZUxhdGVCdWZmZXIgPSBmdW5jdGlvbiBBc3luYyRfY29uc3VtZUxhdGVCdWZmZXIoKSB7CiAgICB2YXIgYnVmZmVyID0gdGhpcy5fbGF0ZUJ1ZmZlcjsKICAgIHdoaWxlKGJ1ZmZlci5sZW5ndGgoKSA+IDApIHsKICAgICAgICB2YXIgZm4gPSBidWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSBidWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgYXJnID0gYnVmZmVyLnNoaWZ0KCk7CiAgICAgICAgdmFyIHJlcyA9IHRyeUNhdGNoMShmbiwgcmVjZWl2ZXIsIGFyZyk7CiAgICAgICAgaWYgKHJlcyA9PT0gZXJyb3JPYmopIHsKICAgICAgICAgICAgdGhpcy5fcXVldWVUaWNrKCk7CiAgICAgICAgICAgIGlmIChmbi5kb21haW4gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm4uZG9tYWluLmVtaXQoImVycm9yIiwgcmVzLmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgcmVzLmU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CgpBc3luYy5wcm90b3R5cGUuX3F1ZXVlVGljayA9IGZ1bmN0aW9uIEFzeW5jJF9xdWV1ZSgpIHsKICAgIGlmICghdGhpcy5faXNUaWNrVXNlZCkgewogICAgICAgIHRoaXMuX3NjaGVkdWxlKHRoaXMuY29uc3VtZUZ1bmN0aW9uQnVmZmVyKTsKICAgICAgICB0aGlzLl9pc1RpY2tVc2VkID0gdHJ1ZTsKICAgIH0KfTsKCkFzeW5jLnByb3RvdHlwZS5fcmVzZXQgPSBmdW5jdGlvbiBBc3luYyRfcmVzZXQoKSB7CiAgICB0aGlzLl9pc1RpY2tVc2VkID0gZmFsc2U7CiAgICB0aGlzLl9sZW5ndGggPSAwOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBuZXcgQXN5bmMoKTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9xdWV1ZS5qcyI6NDAsIi4vc2NoZWR1bGUuanMiOjQzLCIuL3V0aWwuanMiOjUwLCJfcHJvY2VzcyI6NjB9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgY3IgPSBPYmplY3QuY3JlYXRlOwppZiAoY3IpIHsKICAgIHZhciBjYWxsZXJDYWNoZSA9IGNyKG51bGwpOwogICAgdmFyIGdldHRlckNhY2hlID0gY3IobnVsbCk7CiAgICBjYWxsZXJDYWNoZVsiIHNpemUiXSA9IGdldHRlckNhY2hlWyIgc2l6ZSJdID0gMDsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciBpc0lkZW50aWZpZXIgPSB1dGlsLmlzSWRlbnRpZmllcjsKCmZ1bmN0aW9uIG1ha2VNZXRob2RDYWxsZXIgKG1ldGhvZE5hbWUpIHsKICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIm9iaiIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAndXNlIHN0cmljdCcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICBzd2l0Y2gobGVuKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSk7ICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSwgdGhpc1sxXSk7ICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAzOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSwgdGhpc1sxXSwgdGhpc1syXSk7ICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUoKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG9iai5tZXRob2ROYW1lLmFwcGx5KG9iaiwgdGhpcyk7ICAgICAgICAgICAgICAgICBcblwKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoL21ldGhvZE5hbWUvZywgbWV0aG9kTmFtZSkpOwp9CgpmdW5jdGlvbiBtYWtlR2V0dGVyIChwcm9wZXJ0eU5hbWUpIHsKICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIm9iaiIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICByZXR1cm4gb2JqLnByb3BlcnR5TmFtZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoInByb3BlcnR5TmFtZSIsIHByb3BlcnR5TmFtZSkpOwp9CgpmdW5jdGlvbiBnZXRDb21waWxlZChuYW1lLCBjb21waWxlciwgY2FjaGUpIHsKICAgIHZhciByZXQgPSBjYWNoZVtuYW1lXTsKICAgIGlmICh0eXBlb2YgcmV0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgaWYgKCFpc0lkZW50aWZpZXIobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldCA9IGNvbXBpbGVyKG5hbWUpOwogICAgICAgIGNhY2hlW25hbWVdID0gcmV0OwogICAgICAgIGNhY2hlWyIgc2l6ZSJdKys7CiAgICAgICAgaWYgKGNhY2hlWyIgc2l6ZSJdID4gNTEyKSB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoY2FjaGUpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgKytpKSBkZWxldGUgY2FjaGVba2V5c1tpXV07CiAgICAgICAgICAgIGNhY2hlWyIgc2l6ZSJdID0ga2V5cy5sZW5ndGggLSAyNTY7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZ2V0TWV0aG9kQ2FsbGVyKG5hbWUpIHsKICAgIHJldHVybiBnZXRDb21waWxlZChuYW1lLCBtYWtlTWV0aG9kQ2FsbGVyLCBjYWxsZXJDYWNoZSk7Cn0KCmZ1bmN0aW9uIGdldEdldHRlcihuYW1lKSB7CiAgICByZXR1cm4gZ2V0Q29tcGlsZWQobmFtZSwgbWFrZUdldHRlciwgZ2V0dGVyQ2FjaGUpOwp9CgpmdW5jdGlvbiBjYWxsZXIob2JqKSB7CiAgICByZXR1cm4gb2JqW3RoaXMucG9wKCldLmFwcGx5KG9iaiwgdGhpcyk7Cn0KUHJvbWlzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uIFByb21pc2UkY2FsbChtZXRob2ROYW1lKSB7CiAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuIC0gMSk7IGZvcih2YXIgJF9pID0gMTsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2kgLSAxXSA9IGFyZ3VtZW50c1skX2ldO30KICAgIGlmIChjYW5FdmFsdWF0ZSkgewogICAgICAgIHZhciBtYXliZUNhbGxlciA9IGdldE1ldGhvZENhbGxlcihtZXRob2ROYW1lKTsKICAgICAgICBpZiAobWF5YmVDYWxsZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RoZW4obWF5YmVDYWxsZXIsIHZvaWQgMCwgdm9pZCAwLCBhcmdzLCB2b2lkIDApOwogICAgICAgIH0KICAgIH0KICAgIGFyZ3MucHVzaChtZXRob2ROYW1lKTsKICAgIHJldHVybiB0aGlzLl90aGVuKGNhbGxlciwgdm9pZCAwLCB2b2lkIDAsIGFyZ3MsIHZvaWQgMCk7Cn07CgpmdW5jdGlvbiBuYW1lZEdldHRlcihvYmopIHsKICAgIHJldHVybiBvYmpbdGhpc107Cn0KZnVuY3Rpb24gaW5kZXhlZEdldHRlcihvYmopIHsKICAgIHJldHVybiBvYmpbdGhpc107Cn0KUHJvbWlzZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gUHJvbWlzZSRnZXQocHJvcGVydHlOYW1lKSB7CiAgICB2YXIgaXNJbmRleCA9ICh0eXBlb2YgcHJvcGVydHlOYW1lID09PSAibnVtYmVyIik7CiAgICB2YXIgZ2V0dGVyOwogICAgaWYgKCFpc0luZGV4KSB7CiAgICAgICAgaWYgKGNhbkV2YWx1YXRlKSB7CiAgICAgICAgICAgIHZhciBtYXliZUdldHRlciA9IGdldEdldHRlcihwcm9wZXJ0eU5hbWUpOwogICAgICAgICAgICBnZXR0ZXIgPSBtYXliZUdldHRlciAhPT0gbnVsbCA/IG1heWJlR2V0dGVyIDogbmFtZWRHZXR0ZXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0dGVyID0gbmFtZWRHZXR0ZXI7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBnZXR0ZXIgPSBpbmRleGVkR2V0dGVyOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3RoZW4oZ2V0dGVyLCB2b2lkIDAsIHZvaWQgMCwgcHJvcGVydHlOYW1lLCB2b2lkIDApOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgY2FuQXR0YWNoID0gZXJyb3JzLmNhbkF0dGFjaDsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgQ2FuY2VsbGF0aW9uRXJyb3IgPSBlcnJvcnMuQ2FuY2VsbGF0aW9uRXJyb3I7CgpQcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsID0gZnVuY3Rpb24gUHJvbWlzZSRfY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLmlzQ2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICB2YXIgcGFyZW50OwogICAgdmFyIHByb21pc2VUb1JlamVjdCA9IHRoaXM7CiAgICB3aGlsZSAoKHBhcmVudCA9IHByb21pc2VUb1JlamVjdC5fY2FuY2VsbGF0aW9uUGFyZW50KSAhPT0gdm9pZCAwICYmCiAgICAgICAgcGFyZW50LmlzQ2FuY2VsbGFibGUoKSkgewogICAgICAgIHByb21pc2VUb1JlamVjdCA9IHBhcmVudDsKICAgIH0KICAgIHRoaXMuX3Vuc2V0Q2FuY2VsbGFibGUoKTsKICAgIHByb21pc2VUb1JlamVjdC5fYXR0YWNoRXh0cmFUcmFjZShyZWFzb24pOwogICAgcHJvbWlzZVRvUmVqZWN0Ll9yZWplY3RVbmNoZWNrZWQocmVhc29uKTsKfTsKClByb21pc2UucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uIFByb21pc2UkY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLmlzQ2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICByZWFzb24gPSByZWFzb24gIT09IHZvaWQgMAogICAgICAgID8gKGNhbkF0dGFjaChyZWFzb24pID8gcmVhc29uIDogbmV3IEVycm9yKHJlYXNvbiArICIiKSkKICAgICAgICA6IG5ldyBDYW5jZWxsYXRpb25FcnJvcigpOwogICAgYXN5bmMuaW52b2tlTGF0ZXIodGhpcy5fY2FuY2VsLCB0aGlzLCByZWFzb24pOwogICAgcmV0dXJuIHRoaXM7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5jYW5jZWxsYWJsZSA9IGZ1bmN0aW9uIFByb21pc2UkY2FuY2VsbGFibGUoKSB7CiAgICBpZiAodGhpcy5fY2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICB0aGlzLl9zZXRDYW5jZWxsYWJsZSgpOwogICAgdGhpcy5fY2FuY2VsbGF0aW9uUGFyZW50ID0gdm9pZCAwOwogICAgcmV0dXJuIHRoaXM7Cn07CgpQcm9taXNlLnByb3RvdHlwZS51bmNhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSR1bmNhbmNlbGxhYmxlKCkgewogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fcHJvcGFnYXRlRnJvbSh0aGlzLCAyIHwgNCk7CiAgICByZXQuX2ZvbGxvdyh0aGlzKTsKICAgIHJldC5fdW5zZXRDYW5jZWxsYWJsZSgpOwogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UucHJvdG90eXBlLmZvcmsgPQpmdW5jdGlvbiBQcm9taXNlJGZvcmsoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcykgewogICAgdmFyIHJldCA9IHRoaXMuX3RoZW4oZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKCiAgICByZXQuX3NldENhbmNlbGxhYmxlKCk7CiAgICByZXQuX2NhbmNlbGxhdGlvblBhcmVudCA9IHZvaWQgMDsKICAgIHJldHVybiByZXQ7Cn07Cn07Cgp9LHsiLi9hc3luYy5qcyI6MTgsIi4vZXJyb3JzLmpzIjoyNX1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmluaGVyaXRzOwp2YXIgZGVmaW5lUHJvcGVydHkgPSByZXF1aXJlKCIuL2VzNS5qcyIpLmRlZmluZVByb3BlcnR5OwoKdmFyIHJpZ25vcmUgPSBuZXcgUmVnRXhwKAogICAgIlxcYig/OlthLXpBLVowLTkuXStcXCRfXFx3K3wiICsKICAgICJ0cnlDYXRjaCg/OjF8MnwzfDR8QXBwbHkpfG5ldyBcXHcqUHJvbWlzZUFycmF5fCIgKwogICAgIlxcdypQcm9taXNlQXJyYXlcXC5cXHcqUHJvbWlzZUFycmF5fCIgKwogICAgInNldFRpbWVvdXR8Q2F0Y2hGaWx0ZXJcXCRfXFx3K3xtYWtlTm9kZVByb21pc2lmaWVkfHByb2Nlc3NJbW1lZGlhdGV8IiArCiAgICAicHJvY2Vzcy5fdGlja0NhbGxiYWNrfG5leHRUaWNrfEFzeW5jXFwkXFx3KylcXGIiCik7Cgp2YXIgcnRyYWNlbGluZSA9IG51bGw7CnZhciBmb3JtYXRTdGFjayA9IG51bGw7CgpmdW5jdGlvbiBmb3JtYXROb25FcnJvcihvYmopIHsKICAgIHZhciBzdHI7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHN0ciA9ICJbZnVuY3Rpb24gIiArCiAgICAgICAgICAgIChvYmoubmFtZSB8fCAiYW5vbnltb3VzIikgKwogICAgICAgICAgICAiXSI7CiAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IG9iai50b1N0cmluZygpOwogICAgICAgIHZhciBydXNlbGVzc1RvU3RyaW5nID0gL1xbb2JqZWN0IFthLXpBLVowLTkkX10rXF0vOwogICAgICAgIGlmIChydXNlbGVzc1RvU3RyaW5nLnRlc3Qoc3RyKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIG5ld1N0ciA9IEpTT04uc3RyaW5naWZ5KG9iaik7CiAgICAgICAgICAgICAgICBzdHIgPSBuZXdTdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2goZSkgewoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3RyLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBzdHIgPSAiKGVtcHR5IGFycmF5KSI7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuICgiKDwiICsgc25pcChzdHIpICsgIj4sIG5vIHN0YWNrIHRyYWNlKSIpOwp9CgpmdW5jdGlvbiBzbmlwKHN0cikgewogICAgdmFyIG1heENoYXJzID0gNDE7CiAgICBpZiAoc3RyLmxlbmd0aCA8IG1heENoYXJzKSB7CiAgICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICAgIHJldHVybiBzdHIuc3Vic3RyKDAsIG1heENoYXJzIC0gMykgKyAiLi4uIjsKfQoKZnVuY3Rpb24gQ2FwdHVyZWRUcmFjZShpZ25vcmVVbnRpbCwgaXNUb3BMZXZlbCkgewogICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZShDYXB0dXJlZFRyYWNlLCBpc1RvcExldmVsKTsKCn0KaW5oZXJpdHMoQ2FwdHVyZWRUcmFjZSwgRXJyb3IpOwoKQ2FwdHVyZWRUcmFjZS5wcm90b3R5cGUuY2FwdHVyZVN0YWNrVHJhY2UgPQpmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJGNhcHR1cmVTdGFja1RyYWNlKGlnbm9yZVVudGlsLCBpc1RvcExldmVsKSB7CiAgICBjYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBpZ25vcmVVbnRpbCwgaXNUb3BMZXZlbCk7Cn07CgpDYXB0dXJlZFRyYWNlLnBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gQ2FwdHVyZWRUcmFjZSRQb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbihyZWFzb24pIHsKICAgIGlmICh0eXBlb2YgY29uc29sZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICB2YXIgbWVzc2FnZTsKICAgICAgICBpZiAodHlwZW9mIHJlYXNvbiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHJlYXNvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc3RhY2sgPSByZWFzb24uc3RhY2s7CiAgICAgICAgICAgIG1lc3NhZ2UgPSAiUG9zc2libHkgdW5oYW5kbGVkICIgKyBmb3JtYXRTdGFjayhzdGFjaywgcmVhc29uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZXNzYWdlID0gIlBvc3NpYmx5IHVuaGFuZGxlZCAiICsgU3RyaW5nKHJlYXNvbik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIiB8fAogICAgICAgICAgICB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb25zb2xlLmxvZyA9PT0gImZ1bmN0aW9uIiB8fAogICAgICAgICAgICB0eXBlb2YgY29uc29sZS5sb2cgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KfTsKCkNhcHR1cmVkVHJhY2UuY29tYmluZSA9IGZ1bmN0aW9uIENhcHR1cmVkVHJhY2UkQ29tYmluZShjdXJyZW50LCBwcmV2KSB7CiAgICB2YXIgY3VycmVudExhc3RJbmRleCA9IGN1cnJlbnQubGVuZ3RoIC0gMTsKICAgIHZhciBjdXJyZW50TGFzdExpbmUgPSBjdXJyZW50W2N1cnJlbnRMYXN0SW5kZXhdOwogICAgdmFyIGNvbW1vblJvb3RNZWV0UG9pbnQgPSAtMTsKICAgIGZvciAodmFyIGkgPSBwcmV2Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgaWYgKHByZXZbaV0gPT09IGN1cnJlbnRMYXN0TGluZSkgewogICAgICAgICAgICBjb21tb25Sb290TWVldFBvaW50ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIGkgPSBjb21tb25Sb290TWVldFBvaW50OyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBsaW5lID0gcHJldltpXTsKICAgICAgICBpZiAoY3VycmVudFtjdXJyZW50TGFzdEluZGV4XSA9PT0gbGluZSkgewogICAgICAgICAgICBjdXJyZW50LnBvcCgpOwogICAgICAgICAgICBjdXJyZW50TGFzdEluZGV4LS07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGN1cnJlbnQucHVzaCgiRnJvbSBwcmV2aW91cyBldmVudDoiKTsKICAgIHZhciBsaW5lcyA9IGN1cnJlbnQuY29uY2F0KHByZXYpOwoKICAgIHZhciByZXQgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbGluZXMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKCiAgICAgICAgaWYgKCgocmlnbm9yZS50ZXN0KGxpbmVzW2ldKSAmJiBydHJhY2VsaW5lLnRlc3QobGluZXNbaV0pKSB8fAogICAgICAgICAgICAoaSA+IDAgJiYgIXJ0cmFjZWxpbmUudGVzdChsaW5lc1tpXSkpICYmCiAgICAgICAgICAgIGxpbmVzW2ldICE9PSAiRnJvbSBwcmV2aW91cyBldmVudDoiKQogICAgICAgKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICByZXQucHVzaChsaW5lc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9OwoKQ2FwdHVyZWRUcmFjZS5wcm90ZWN0RXJyb3JNZXNzYWdlTmV3bGluZXMgPSBmdW5jdGlvbihzdGFjaykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGFjay5sZW5ndGg7ICsraSkgewogICAgICAgIGlmIChydHJhY2VsaW5lLnRlc3Qoc3RhY2tbaV0pKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaSA8PSAxKSByZXR1cm47CgogICAgdmFyIGVycm9yTWVzc2FnZUxpbmVzID0gW107CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGk7ICsraikgewogICAgICAgIGVycm9yTWVzc2FnZUxpbmVzLnB1c2goc3RhY2suc2hpZnQoKSk7CiAgICB9CiAgICBzdGFjay51bnNoaWZ0KGVycm9yTWVzc2FnZUxpbmVzLmpvaW4oIlx1MDAwMlx1MDAwMFx1MDAwMSIpKTsKfTsKCkNhcHR1cmVkVHJhY2UuaXNTdXBwb3J0ZWQgPSBmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJElzU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHR5cGVvZiBjYXB0dXJlU3RhY2tUcmFjZSA9PT0gImZ1bmN0aW9uIjsKfTsKCnZhciBjYXB0dXJlU3RhY2tUcmFjZSA9IChmdW5jdGlvbiBzdGFja0RldGVjdGlvbigpIHsKICAgIGlmICh0eXBlb2YgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID09PSAibnVtYmVyIiAmJgogICAgICAgIHR5cGVvZiBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJ0cmFjZWxpbmUgPSAvXlxzKmF0XHMqLzsKICAgICAgICBmb3JtYXRTdGFjayA9IGZ1bmN0aW9uKHN0YWNrLCBlcnJvcikgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0YWNrID09PSAic3RyaW5nIikgcmV0dXJuIHN0YWNrOwoKICAgICAgICAgICAgaWYgKGVycm9yLm5hbWUgIT09IHZvaWQgMCAmJgogICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3IubmFtZSArICIuICIgKyBlcnJvci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7CgoKICAgICAgICB9OwogICAgICAgIHZhciBjYXB0dXJlU3RhY2tUcmFjZSA9IEVycm9yLmNhcHR1cmVTdGFja1RyYWNlOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJF9jYXB0dXJlU3RhY2tUcmFjZSgKICAgICAgICAgICAgcmVjZWl2ZXIsIGlnbm9yZVVudGlsKSB7CiAgICAgICAgICAgIGNhcHR1cmVTdGFja1RyYWNlKHJlY2VpdmVyLCBpZ25vcmVVbnRpbCk7CiAgICAgICAgfTsKICAgIH0KICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoKTsKCiAgICBpZiAodHlwZW9mIGVyci5zdGFjayA9PT0gInN0cmluZyIgJiYKICAgICAgICB0eXBlb2YgIiIuc3RhcnRzV2l0aCA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgIChlcnIuc3RhY2suc3RhcnRzV2l0aCgic3RhY2tEZXRlY3Rpb25AIikpICYmCiAgICAgICAgc3RhY2tEZXRlY3Rpb24ubmFtZSA9PT0gInN0YWNrRGV0ZWN0aW9uIikgewoKICAgICAgICBkZWZpbmVQcm9wZXJ0eShFcnJvciwgInN0YWNrVHJhY2VMaW1pdCIsIHsKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICB2YWx1ZTogMjUKICAgICAgICB9KTsKICAgICAgICBydHJhY2VsaW5lID0gL0AvOwogICAgICAgIHZhciBybGluZSA9IC9bQFxuXS87CgogICAgICAgIGZvcm1hdFN0YWNrID0gZnVuY3Rpb24oc3RhY2ssIGVycm9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGVycm9yLm5hbWUgKyAiLiAiICsgZXJyb3IubWVzc2FnZSArICJcbiIgKyBzdGFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChlcnJvci5uYW1lICE9PSB2b2lkIDAgJiYKICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVycm9yLm5hbWUgKyAiLiAiICsgZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0Tm9uRXJyb3IoZXJyb3IpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBjYXB0dXJlU3RhY2tUcmFjZShvKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrOwogICAgICAgICAgICB2YXIgc3BsaXQgPSBzdGFjay5zcGxpdChybGluZSk7CiAgICAgICAgICAgIHZhciBsZW4gPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgICAgIHZhciByZXQgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICAgICAgICAgICAgcmV0ICs9IHNwbGl0W2ldOwogICAgICAgICAgICAgICAgcmV0ICs9ICJAIjsKICAgICAgICAgICAgICAgIHJldCArPSBzcGxpdFtpICsgMV07CiAgICAgICAgICAgICAgICByZXQgKz0gIlxuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLnN0YWNrID0gcmV0OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIGZvcm1hdFN0YWNrID0gZnVuY3Rpb24oc3RhY2ssIGVycm9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhY2sgPT09ICJzdHJpbmciKSByZXR1cm4gc3RhY2s7CgogICAgICAgICAgICBpZiAoKHR5cGVvZiBlcnJvciA9PT0gIm9iamVjdCIgfHwKICAgICAgICAgICAgICAgIHR5cGVvZiBlcnJvciA9PT0gImZ1bmN0aW9uIikgJiYKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgIT09IHZvaWQgMCAmJgogICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3IubmFtZSArICIuICIgKyBlcnJvci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9Cn0pKCk7CgpyZXR1cm4gQ2FwdHVyZWRUcmFjZTsKfTsKCn0seyIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKE5FWFRfRklMVEVSKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgdHJ5Q2F0Y2gxID0gdXRpbC50cnlDYXRjaDE7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CnZhciBrZXlzID0gcmVxdWlyZSgiLi9lczUuanMiKS5rZXlzOwp2YXIgVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjsKCmZ1bmN0aW9uIENhdGNoRmlsdGVyKGluc3RhbmNlcywgY2FsbGJhY2ssIHByb21pc2UpIHsKICAgIHRoaXMuX2luc3RhbmNlcyA9IGluc3RhbmNlczsKICAgIHRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZTsKfQoKZnVuY3Rpb24gQ2F0Y2hGaWx0ZXIkX3NhZmVQcmVkaWNhdGUocHJlZGljYXRlLCBlKSB7CiAgICB2YXIgc2FmZU9iamVjdCA9IHt9OwogICAgdmFyIHJldGZpbHRlciA9IHRyeUNhdGNoMShwcmVkaWNhdGUsIHNhZmVPYmplY3QsIGUpOwoKICAgIGlmIChyZXRmaWx0ZXIgPT09IGVycm9yT2JqKSByZXR1cm4gcmV0ZmlsdGVyOwoKICAgIHZhciBzYWZlS2V5cyA9IGtleXMoc2FmZU9iamVjdCk7CiAgICBpZiAoc2FmZUtleXMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IG5ldyBUeXBlRXJyb3IoCiAgICAgICAgICAgICJDYXRjaCBmaWx0ZXIgbXVzdCBpbmhlcml0IGZyb20gRXJyb3IgIgogICAgICAgICAgKyAib3IgYmUgYSBzaW1wbGUgcHJlZGljYXRlIGZ1bmN0aW9uIik7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQogICAgcmV0dXJuIHJldGZpbHRlcjsKfQoKQ2F0Y2hGaWx0ZXIucHJvdG90eXBlLmRvRmlsdGVyID0gZnVuY3Rpb24gQ2F0Y2hGaWx0ZXIkX2RvRmlsdGVyKGUpIHsKICAgIHZhciBjYiA9IHRoaXMuX2NhbGxiYWNrOwogICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlOwogICAgdmFyIGJvdW5kVG8gPSBwcm9taXNlLl9ib3VuZFRvOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2luc3RhbmNlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBpdGVtID0gdGhpcy5faW5zdGFuY2VzW2ldOwogICAgICAgIHZhciBpdGVtSXNFcnJvclR5cGUgPSBpdGVtID09PSBFcnJvciB8fAogICAgICAgICAgICAoaXRlbSAhPSBudWxsICYmIGl0ZW0ucHJvdG90eXBlIGluc3RhbmNlb2YgRXJyb3IpOwoKICAgICAgICBpZiAoaXRlbUlzRXJyb3JUeXBlICYmIGUgaW5zdGFuY2VvZiBpdGVtKSB7CiAgICAgICAgICAgIHZhciByZXQgPSB0cnlDYXRjaDEoY2IsIGJvdW5kVG8sIGUpOwogICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgTkVYVF9GSUxURVIuZSA9IHJldC5lOwogICAgICAgICAgICAgICAgcmV0dXJuIE5FWFRfRklMVEVSOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiAmJiAhaXRlbUlzRXJyb3JUeXBlKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRIYW5kbGUgPSBDYXRjaEZpbHRlciRfc2FmZVByZWRpY2F0ZShpdGVtLCBlKTsKICAgICAgICAgICAgaWYgKHNob3VsZEhhbmRsZSA9PT0gZXJyb3JPYmopIHsKICAgICAgICAgICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2goZXJyb3JPYmouZSkKICAgICAgICAgICAgICAgICAgICA/IGVycm9yT2JqLmUKICAgICAgICAgICAgICAgICAgICA6IG5ldyBFcnJvcihlcnJvck9iai5lICsgIiIpOwogICAgICAgICAgICAgICAgdGhpcy5fcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgICAgICAgICBlID0gZXJyb3JPYmouZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZEhhbmRsZSkgewogICAgICAgICAgICAgICAgdmFyIHJldCA9IHRyeUNhdGNoMShjYiwgYm91bmRUbywgZSk7CiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgICAgIE5FWFRfRklMVEVSLmUgPSByZXQuZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTkVYVF9GSUxURVI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgTkVYVF9GSUxURVIuZSA9IGU7CiAgICByZXR1cm4gTkVYVF9GSUxURVI7Cn07CgpyZXR1cm4gQ2F0Y2hGaWx0ZXI7Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwp2YXIgaXNQcmltaXRpdmUgPSB1dGlsLmlzUHJpbWl0aXZlOwp2YXIgd3JhcHNQcmltaXRpdmVSZWNlaXZlciA9IHV0aWwud3JhcHNQcmltaXRpdmVSZWNlaXZlcjsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSkgewp2YXIgcmV0dXJuZXIgPSBmdW5jdGlvbiBQcm9taXNlJF9yZXR1cm5lcigpIHsKICAgIHJldHVybiB0aGlzOwp9Owp2YXIgdGhyb3dlciA9IGZ1bmN0aW9uIFByb21pc2UkX3Rocm93ZXIoKSB7CiAgICB0aHJvdyB0aGlzOwp9OwoKdmFyIHdyYXBwZXIgPSBmdW5jdGlvbiBQcm9taXNlJF93cmFwcGVyKHZhbHVlLCBhY3Rpb24pIHsKICAgIGlmIChhY3Rpb24gPT09IDEpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfdGhyb3dlcigpIHsKICAgICAgICAgICAgdGhyb3cgdmFsdWU7CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIFByb21pc2UkX3JldHVybmVyKCkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfTsKICAgIH0KfTsKCgpQcm9taXNlLnByb3RvdHlwZVsicmV0dXJuIl0gPQpQcm9taXNlLnByb3RvdHlwZS50aGVuUmV0dXJuID0KZnVuY3Rpb24gUHJvbWlzZSR0aGVuUmV0dXJuKHZhbHVlKSB7CiAgICBpZiAod3JhcHNQcmltaXRpdmVSZWNlaXZlciAmJiBpc1ByaW1pdGl2ZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdGhlbigKICAgICAgICAgICAgd3JhcHBlcih2YWx1ZSwgMiksCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMAogICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl90aGVuKHJldHVybmVyLCB2b2lkIDAsIHZvaWQgMCwgdmFsdWUsIHZvaWQgMCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZVsidGhyb3ciXSA9ClByb21pc2UucHJvdG90eXBlLnRoZW5UaHJvdyA9CmZ1bmN0aW9uIFByb21pc2UkdGhlblRocm93KHJlYXNvbikgewogICAgaWYgKHdyYXBzUHJpbWl0aXZlUmVjZWl2ZXIgJiYgaXNQcmltaXRpdmUocmVhc29uKSkgewogICAgICAgIHJldHVybiB0aGlzLl90aGVuKAogICAgICAgICAgICB3cmFwcGVyKHJlYXNvbiwgMSksCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMAogICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl90aGVuKHRocm93ZXIsIHZvaWQgMCwgdm9pZCAwLCByZWFzb24sIHZvaWQgMCk7Cn07Cn07Cgp9LHsiLi91dGlsLmpzIjo1MH1dLDI0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHsKdmFyIFByb21pc2VSZWR1Y2UgPSBQcm9taXNlLnJlZHVjZTsKClByb21pc2UucHJvdG90eXBlLmVhY2ggPSBmdW5jdGlvbiBQcm9taXNlJGVhY2goZm4pIHsKICAgIHJldHVybiBQcm9taXNlUmVkdWNlKHRoaXMsIGZuLCBudWxsLCBJTlRFUk5BTCk7Cn07CgpQcm9taXNlLmVhY2ggPSBmdW5jdGlvbiBQcm9taXNlJEVhY2gocHJvbWlzZXMsIGZuKSB7CiAgICByZXR1cm4gUHJvbWlzZVJlZHVjZShwcm9taXNlcywgZm4sIG51bGwsIElOVEVSTkFMKTsKfTsKfTsKCn0se31dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7CnZhciBPYmplY3RmcmVlemUgPSByZXF1aXJlKCIuL2VzNS5qcyIpLmZyZWV6ZTsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGluaGVyaXRzID0gdXRpbC5pbmhlcml0czsKdmFyIG5vdEVudW1lcmFibGVQcm9wID0gdXRpbC5ub3RFbnVtZXJhYmxlUHJvcDsKCmZ1bmN0aW9uIG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihlKSB7CiAgICB0cnkgewogICAgICAgIG5vdEVudW1lcmFibGVQcm9wKGUsICJpc09wZXJhdGlvbmFsIiwgdHJ1ZSk7CiAgICB9CiAgICBjYXRjaChpZ25vcmUpIHt9Cn0KCmZ1bmN0aW9uIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uKGUpIHsKICAgIGlmIChlID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiAoKGUgaW5zdGFuY2VvZiBPcGVyYXRpb25hbEVycm9yKSB8fAogICAgICAgIGVbImlzT3BlcmF0aW9uYWwiXSA9PT0gdHJ1ZSk7Cn0KCmZ1bmN0aW9uIGlzRXJyb3Iob2JqKSB7CiAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRXJyb3I7Cn0KCmZ1bmN0aW9uIGNhbkF0dGFjaChvYmopIHsKICAgIHJldHVybiBpc0Vycm9yKG9iaik7Cn0KCmZ1bmN0aW9uIHN1YkVycm9yKG5hbWVQcm9wZXJ0eSwgZGVmYXVsdE1lc3NhZ2UpIHsKICAgIGZ1bmN0aW9uIFN1YkVycm9yKG1lc3NhZ2UpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU3ViRXJyb3IpKSByZXR1cm4gbmV3IFN1YkVycm9yKG1lc3NhZ2UpOwogICAgICAgIHRoaXMubWVzc2FnZSA9IHR5cGVvZiBtZXNzYWdlID09PSAic3RyaW5nIiA/IG1lc3NhZ2UgOiBkZWZhdWx0TWVzc2FnZTsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lUHJvcGVydHk7CiAgICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIHRoaXMuY29uc3RydWN0b3IpOwogICAgICAgIH0KICAgIH0KICAgIGluaGVyaXRzKFN1YkVycm9yLCBFcnJvcik7CiAgICByZXR1cm4gU3ViRXJyb3I7Cn0KCnZhciBfVHlwZUVycm9yLCBfUmFuZ2VFcnJvcjsKdmFyIENhbmNlbGxhdGlvbkVycm9yID0gc3ViRXJyb3IoIkNhbmNlbGxhdGlvbkVycm9yIiwgImNhbmNlbGxhdGlvbiBlcnJvciIpOwp2YXIgVGltZW91dEVycm9yID0gc3ViRXJyb3IoIlRpbWVvdXRFcnJvciIsICJ0aW1lb3V0IGVycm9yIik7CnZhciBBZ2dyZWdhdGVFcnJvciA9IHN1YkVycm9yKCJBZ2dyZWdhdGVFcnJvciIsICJhZ2dyZWdhdGUgZXJyb3IiKTsKdHJ5IHsKICAgIF9UeXBlRXJyb3IgPSBUeXBlRXJyb3I7CiAgICBfUmFuZ2VFcnJvciA9IFJhbmdlRXJyb3I7Cn0gY2F0Y2goZSkgewogICAgX1R5cGVFcnJvciA9IHN1YkVycm9yKCJUeXBlRXJyb3IiLCAidHlwZSBlcnJvciIpOwogICAgX1JhbmdlRXJyb3IgPSBzdWJFcnJvcigiUmFuZ2VFcnJvciIsICJyYW5nZSBlcnJvciIpOwp9Cgp2YXIgbWV0aG9kcyA9ICgiam9pbiBwb3AgcHVzaCBzaGlmdCB1bnNoaWZ0IHNsaWNlIGZpbHRlciBmb3JFYWNoIHNvbWUgIiArCiAgICAiZXZlcnkgbWFwIGluZGV4T2YgbGFzdEluZGV4T2YgcmVkdWNlIHJlZHVjZVJpZ2h0IHNvcnQgcmV2ZXJzZSIpLnNwbGl0KCIgIik7Cgpmb3IgKHZhciBpID0gMDsgaSA8IG1ldGhvZHMubGVuZ3RoOyArK2kpIHsKICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlW21ldGhvZHNbaV1dID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgQWdncmVnYXRlRXJyb3IucHJvdG90eXBlW21ldGhvZHNbaV1dID0gQXJyYXkucHJvdG90eXBlW21ldGhvZHNbaV1dOwogICAgfQp9CgpBZ2dyZWdhdGVFcnJvci5wcm90b3R5cGUubGVuZ3RoID0gMDsKQWdncmVnYXRlRXJyb3IucHJvdG90eXBlWyJpc09wZXJhdGlvbmFsIl0gPSB0cnVlOwp2YXIgbGV2ZWwgPSAwOwpBZ2dyZWdhdGVFcnJvci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbmRlbnQgPSBBcnJheShsZXZlbCAqIDQgKyAxKS5qb2luKCIgIik7CiAgICB2YXIgcmV0ID0gIlxuIiArIGluZGVudCArICJBZ2dyZWdhdGVFcnJvciBvZjoiICsgIlxuIjsKICAgIGxldmVsKys7CiAgICBpbmRlbnQgPSBBcnJheShsZXZlbCAqIDQgKyAxKS5qb2luKCIgIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgc3RyID0gdGhpc1tpXSA9PT0gdGhpcyA/ICJbQ2lyY3VsYXIgQWdncmVnYXRlRXJyb3JdIiA6IHRoaXNbaV0gKyAiIjsKICAgICAgICB2YXIgbGluZXMgPSBzdHIuc3BsaXQoIlxuIik7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsaW5lcy5sZW5ndGg7ICsraikgewogICAgICAgICAgICBsaW5lc1tqXSA9IGluZGVudCArIGxpbmVzW2pdOwogICAgICAgIH0KICAgICAgICBzdHIgPSBsaW5lcy5qb2luKCJcbiIpOwogICAgICAgIHJldCArPSBzdHIgKyAiXG4iOwogICAgfQogICAgbGV2ZWwtLTsKICAgIHJldHVybiByZXQ7Cn07CgpmdW5jdGlvbiBPcGVyYXRpb25hbEVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJPcGVyYXRpb25hbEVycm9yIjsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB0aGlzLmNhdXNlID0gbWVzc2FnZTsKICAgIHRoaXNbImlzT3BlcmF0aW9uYWwiXSA9IHRydWU7CgogICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2UubWVzc2FnZTsKICAgICAgICB0aGlzLnN0YWNrID0gbWVzc2FnZS5zdGFjazsKICAgIH0gZWxzZSBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIH0KCn0KaW5oZXJpdHMoT3BlcmF0aW9uYWxFcnJvciwgRXJyb3IpOwoKdmFyIGtleSA9ICJfX0JsdWViaXJkRXJyb3JUeXBlc19fIjsKdmFyIGVycm9yVHlwZXMgPSBFcnJvcltrZXldOwppZiAoIWVycm9yVHlwZXMpIHsKICAgIGVycm9yVHlwZXMgPSBPYmplY3RmcmVlemUoewogICAgICAgIENhbmNlbGxhdGlvbkVycm9yOiBDYW5jZWxsYXRpb25FcnJvciwKICAgICAgICBUaW1lb3V0RXJyb3I6IFRpbWVvdXRFcnJvciwKICAgICAgICBPcGVyYXRpb25hbEVycm9yOiBPcGVyYXRpb25hbEVycm9yLAogICAgICAgIFJlamVjdGlvbkVycm9yOiBPcGVyYXRpb25hbEVycm9yLAogICAgICAgIEFnZ3JlZ2F0ZUVycm9yOiBBZ2dyZWdhdGVFcnJvcgogICAgfSk7CiAgICBub3RFbnVtZXJhYmxlUHJvcChFcnJvciwga2V5LCBlcnJvclR5cGVzKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBFcnJvcjogRXJyb3IsCiAgICBUeXBlRXJyb3I6IF9UeXBlRXJyb3IsCiAgICBSYW5nZUVycm9yOiBfUmFuZ2VFcnJvciwKICAgIENhbmNlbGxhdGlvbkVycm9yOiBlcnJvclR5cGVzLkNhbmNlbGxhdGlvbkVycm9yLAogICAgT3BlcmF0aW9uYWxFcnJvcjogZXJyb3JUeXBlcy5PcGVyYXRpb25hbEVycm9yLAogICAgVGltZW91dEVycm9yOiBlcnJvclR5cGVzLlRpbWVvdXRFcnJvciwKICAgIEFnZ3JlZ2F0ZUVycm9yOiBlcnJvclR5cGVzLkFnZ3JlZ2F0ZUVycm9yLAogICAgb3JpZ2luYXRlc0Zyb21SZWplY3Rpb246IG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uLAogICAgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uOiBtYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24sCiAgICBjYW5BdHRhY2g6IGNhbkF0dGFjaAp9OwoKfSx7Ii4vZXM1LmpzIjoyNywiLi91dGlsLmpzIjo1MH1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSkgewp2YXIgVHlwZUVycm9yID0gcmVxdWlyZSgnLi9lcnJvcnMuanMnKS5UeXBlRXJyb3I7CgpmdW5jdGlvbiBhcGlSZWplY3Rpb24obXNnKSB7CiAgICB2YXIgZXJyb3IgPSBuZXcgVHlwZUVycm9yKG1zZyk7CiAgICB2YXIgcmV0ID0gUHJvbWlzZS5yZWplY3RlZChlcnJvcik7CiAgICB2YXIgcGFyZW50ID0gcmV0Ll9wZWVrQ29udGV4dCgpOwogICAgaWYgKHBhcmVudCAhPSBudWxsKSB7CiAgICAgICAgcGFyZW50Ll9hdHRhY2hFeHRyYVRyYWNlKGVycm9yKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KCnJldHVybiBhcGlSZWplY3Rpb247Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1fV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCnZhciBpc0VTNSA9IChmdW5jdGlvbigpewogICAgInVzZSBzdHJpY3QiOwogICAgcmV0dXJuIHRoaXMgPT09IHZvaWQgMDsKfSkoKTsKCmlmIChpc0VTNSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgZnJlZXplOiBPYmplY3QuZnJlZXplLAogICAgICAgIGRlZmluZVByb3BlcnR5OiBPYmplY3QuZGVmaW5lUHJvcGVydHksCiAgICAgICAga2V5czogT2JqZWN0LmtleXMsCiAgICAgICAgZ2V0UHJvdG90eXBlT2Y6IE9iamVjdC5nZXRQcm90b3R5cGVPZiwKICAgICAgICBpc0FycmF5OiBBcnJheS5pc0FycmF5LAogICAgICAgIGlzRVM1OiBpc0VTNQogICAgfTsKfSBlbHNlIHsKICAgIHZhciBoYXMgPSB7fS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBzdHIgPSB7fS50b1N0cmluZzsKICAgIHZhciBwcm90byA9IHt9LmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKCiAgICB2YXIgT2JqZWN0S2V5cyA9IGZ1bmN0aW9uIE9iamVjdEtleXMobykgewogICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbykgewogICAgICAgICAgICBpZiAoaGFzLmNhbGwobywga2V5KSkgewogICAgICAgICAgICAgICAgcmV0LnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHZhciBPYmplY3REZWZpbmVQcm9wZXJ0eSA9IGZ1bmN0aW9uIE9iamVjdERlZmluZVByb3BlcnR5KG8sIGtleSwgZGVzYykgewogICAgICAgIG9ba2V5XSA9IGRlc2MudmFsdWU7CiAgICAgICAgcmV0dXJuIG87CiAgICB9CgogICAgdmFyIE9iamVjdEZyZWV6ZSA9IGZ1bmN0aW9uIE9iamVjdEZyZWV6ZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIHZhciBPYmplY3RHZXRQcm90b3R5cGVPZiA9IGZ1bmN0aW9uIE9iamVjdEdldFByb3RvdHlwZU9mKG9iaikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qob2JqKS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBwcm90bzsKICAgICAgICB9CiAgICB9CgogICAgdmFyIEFycmF5SXNBcnJheSA9IGZ1bmN0aW9uIEFycmF5SXNBcnJheShvYmopIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gc3RyLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgIGlzQXJyYXk6IEFycmF5SXNBcnJheSwKICAgICAgICBrZXlzOiBPYmplY3RLZXlzLAogICAgICAgIGRlZmluZVByb3BlcnR5OiBPYmplY3REZWZpbmVQcm9wZXJ0eSwKICAgICAgICBmcmVlemU6IE9iamVjdEZyZWV6ZSwKICAgICAgICBnZXRQcm90b3R5cGVPZjogT2JqZWN0R2V0UHJvdG90eXBlT2YsCiAgICAgICAgaXNFUzU6IGlzRVM1CiAgICB9Owp9Cgp9LHt9XSwyODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBQcm9taXNlTWFwID0gUHJvbWlzZS5tYXA7CgpQcm9taXNlLnByb3RvdHlwZS5maWx0ZXIgPSBmdW5jdGlvbiBQcm9taXNlJGZpbHRlcihmbiwgb3B0aW9ucykgewogICAgcmV0dXJuIFByb21pc2VNYXAodGhpcywgZm4sIG9wdGlvbnMsIElOVEVSTkFMKTsKfTsKClByb21pc2UuZmlsdGVyID0gZnVuY3Rpb24gUHJvbWlzZSRGaWx0ZXIocHJvbWlzZXMsIGZuLCBvcHRpb25zKSB7CiAgICByZXR1cm4gUHJvbWlzZU1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIElOVEVSTkFMKTsKfTsKfTsKCn0se31dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgTkVYVF9GSUxURVIsIGNhc3QpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIHdyYXBzUHJpbWl0aXZlUmVjZWl2ZXIgPSB1dGlsLndyYXBzUHJpbWl0aXZlUmVjZWl2ZXI7CnZhciBpc1ByaW1pdGl2ZSA9IHV0aWwuaXNQcmltaXRpdmU7CnZhciB0aHJvd2VyID0gdXRpbC50aHJvd2VyOwoKZnVuY3Rpb24gcmV0dXJuVGhpcygpIHsKICAgIHJldHVybiB0aGlzOwp9CmZ1bmN0aW9uIHRocm93VGhpcygpIHsKICAgIHRocm93IHRoaXM7Cn0KZnVuY3Rpb24gcmV0dXJuJChyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfcmV0dXJuZXIoKSB7CiAgICAgICAgcmV0dXJuIHI7CiAgICB9Owp9CmZ1bmN0aW9uIHRocm93JChyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfdGhyb3dlcigpIHsKICAgICAgICB0aHJvdyByOwogICAgfTsKfQpmdW5jdGlvbiBwcm9taXNlZEZpbmFsbHkocmV0LCByZWFzb25PclZhbHVlLCBpc0Z1bGZpbGxlZCkgewogICAgdmFyIHRoZW47CiAgICBpZiAod3JhcHNQcmltaXRpdmVSZWNlaXZlciAmJiBpc1ByaW1pdGl2ZShyZWFzb25PclZhbHVlKSkgewogICAgICAgIHRoZW4gPSBpc0Z1bGZpbGxlZCA/IHJldHVybiQocmVhc29uT3JWYWx1ZSkgOiB0aHJvdyQocmVhc29uT3JWYWx1ZSk7CiAgICB9IGVsc2UgewogICAgICAgIHRoZW4gPSBpc0Z1bGZpbGxlZCA/IHJldHVyblRoaXMgOiB0aHJvd1RoaXM7CiAgICB9CiAgICByZXR1cm4gcmV0Ll90aGVuKHRoZW4sIHRocm93ZXIsIHZvaWQgMCwgcmVhc29uT3JWYWx1ZSwgdm9pZCAwKTsKfQoKZnVuY3Rpb24gZmluYWxseUhhbmRsZXIocmVhc29uT3JWYWx1ZSkgewogICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CiAgICB2YXIgaGFuZGxlciA9IHRoaXMuaGFuZGxlcjsKCiAgICB2YXIgcmV0ID0gcHJvbWlzZS5faXNCb3VuZCgpCiAgICAgICAgICAgICAgICAgICAgPyBoYW5kbGVyLmNhbGwocHJvbWlzZS5fYm91bmRUbykKICAgICAgICAgICAgICAgICAgICA6IGhhbmRsZXIoKTsKCiAgICBpZiAocmV0ICE9PSB2b2lkIDApIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXQsIHZvaWQgMCk7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2VkRmluYWxseShtYXliZVByb21pc2UsIHJlYXNvbk9yVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuaXNGdWxmaWxsZWQoKSk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChwcm9taXNlLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIE5FWFRfRklMVEVSLmUgPSByZWFzb25PclZhbHVlOwogICAgICAgIHJldHVybiBORVhUX0ZJTFRFUjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlYXNvbk9yVmFsdWU7CiAgICB9Cn0KCmZ1bmN0aW9uIHRhcEhhbmRsZXIodmFsdWUpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlOwogICAgdmFyIGhhbmRsZXIgPSB0aGlzLmhhbmRsZXI7CgogICAgdmFyIHJldCA9IHByb21pc2UuX2lzQm91bmQoKQogICAgICAgICAgICAgICAgICAgID8gaGFuZGxlci5jYWxsKHByb21pc2UuX2JvdW5kVG8sIHZhbHVlKQogICAgICAgICAgICAgICAgICAgIDogaGFuZGxlcih2YWx1ZSk7CgogICAgaWYgKHJldCAhPT0gdm9pZCAwKSB7CiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocmV0LCB2b2lkIDApOwogICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlZEZpbmFsbHkobWF5YmVQcm9taXNlLCB2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgpQcm9taXNlLnByb3RvdHlwZS5fcGFzc1Rocm91Z2hIYW5kbGVyID0KZnVuY3Rpb24gUHJvbWlzZSRfcGFzc1Rocm91Z2hIYW5kbGVyKGhhbmRsZXIsIGlzRmluYWxseSkgewogICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9PSAiZnVuY3Rpb24iKSByZXR1cm4gdGhpcy50aGVuKCk7CgogICAgdmFyIHByb21pc2VBbmRIYW5kbGVyID0gewogICAgICAgIHByb21pc2U6IHRoaXMsCiAgICAgICAgaGFuZGxlcjogaGFuZGxlcgogICAgfTsKCiAgICByZXR1cm4gdGhpcy5fdGhlbigKICAgICAgICAgICAgaXNGaW5hbGx5ID8gZmluYWxseUhhbmRsZXIgOiB0YXBIYW5kbGVyLAogICAgICAgICAgICBpc0ZpbmFsbHkgPyBmaW5hbGx5SGFuZGxlciA6IHZvaWQgMCwgdm9pZCAwLAogICAgICAgICAgICBwcm9taXNlQW5kSGFuZGxlciwgdm9pZCAwKTsKfTsKClByb21pc2UucHJvdG90eXBlLmxhc3RseSA9ClByb21pc2UucHJvdG90eXBlWyJmaW5hbGx5Il0gPSBmdW5jdGlvbiBQcm9taXNlJGZpbmFsbHkoaGFuZGxlcikgewogICAgcmV0dXJuIHRoaXMuX3Bhc3NUaHJvdWdoSGFuZGxlcihoYW5kbGVyLCB0cnVlKTsKfTsKClByb21pc2UucHJvdG90eXBlLnRhcCA9IGZ1bmN0aW9uIFByb21pc2UkdGFwKGhhbmRsZXIpIHsKICAgIHJldHVybiB0aGlzLl9wYXNzVGhyb3VnaEhhbmRsZXIoaGFuZGxlciwgZmFsc2UpOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIGFwaVJlamVjdGlvbiwgSU5URVJOQUwsIGNhc3QpIHsKdmFyIGVycm9ycyA9IHJlcXVpcmUoIi4vZXJyb3JzLmpzIik7CnZhciBUeXBlRXJyb3IgPSBlcnJvcnMuVHlwZUVycm9yOwp2YXIgZGVwcmVjYXRlZCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmRlcHJlY2F0ZWQ7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIHlpZWxkSGFuZGxlcnMgPSBbXTsKCmZ1bmN0aW9uIHByb21pc2VGcm9tWWllbGRIYW5kbGVyKHZhbHVlLCB5aWVsZEhhbmRsZXJzKSB7CiAgICB2YXIgX2Vycm9yT2JqID0gZXJyb3JPYmo7CiAgICB2YXIgX1Byb21pc2UgPSBQcm9taXNlOwogICAgdmFyIGxlbiA9IHlpZWxkSGFuZGxlcnMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciByZXN1bHQgPSB0cnlDYXRjaDEoeWllbGRIYW5kbGVyc1tpXSwgdm9pZCAwLCB2YWx1ZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gX2Vycm9yT2JqKSB7CiAgICAgICAgICAgIHJldHVybiBfUHJvbWlzZS5yZWplY3QoX2Vycm9yT2JqLmUpOwogICAgICAgIH0KICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXN1bHQsIHByb21pc2VGcm9tWWllbGRIYW5kbGVyKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgX1Byb21pc2UpIHJldHVybiBtYXliZVByb21pc2U7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gUHJvbWlzZVNwYXduKGdlbmVyYXRvckZ1bmN0aW9uLCByZWNlaXZlciwgeWllbGRIYW5kbGVyKSB7CiAgICB2YXIgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICBwcm9taXNlLl9zZXRUcmFjZSh2b2lkIDApOwogICAgdGhpcy5fZ2VuZXJhdG9yRnVuY3Rpb24gPSBnZW5lcmF0b3JGdW5jdGlvbjsKICAgIHRoaXMuX3JlY2VpdmVyID0gcmVjZWl2ZXI7CiAgICB0aGlzLl9nZW5lcmF0b3IgPSB2b2lkIDA7CiAgICB0aGlzLl95aWVsZEhhbmRsZXJzID0gdHlwZW9mIHlpZWxkSGFuZGxlciA9PT0gImZ1bmN0aW9uIgogICAgICAgID8gW3lpZWxkSGFuZGxlcl0uY29uY2F0KHlpZWxkSGFuZGxlcnMpCiAgICAgICAgOiB5aWVsZEhhbmRsZXJzOwp9CgpQcm9taXNlU3Bhd24ucHJvdG90eXBlLnByb21pc2UgPSBmdW5jdGlvbiBQcm9taXNlU3Bhd24kcHJvbWlzZSgpIHsKICAgIHJldHVybiB0aGlzLl9wcm9taXNlOwp9OwoKUHJvbWlzZVNwYXduLnByb3RvdHlwZS5fcnVuID0gZnVuY3Rpb24gUHJvbWlzZVNwYXduJF9ydW4oKSB7CiAgICB0aGlzLl9nZW5lcmF0b3IgPSB0aGlzLl9nZW5lcmF0b3JGdW5jdGlvbi5jYWxsKHRoaXMuX3JlY2VpdmVyKTsKICAgIHRoaXMuX3JlY2VpdmVyID0KICAgICAgICB0aGlzLl9nZW5lcmF0b3JGdW5jdGlvbiA9IHZvaWQgMDsKICAgIHRoaXMuX25leHQodm9pZCAwKTsKfTsKClByb21pc2VTcGF3bi5wcm90b3R5cGUuX2NvbnRpbnVlID0gZnVuY3Rpb24gUHJvbWlzZVNwYXduJF9jb250aW51ZShyZXN1bHQpIHsKICAgIGlmIChyZXN1bHQgPT09IGVycm9yT2JqKSB7CiAgICAgICAgdGhpcy5fZ2VuZXJhdG9yID0gdm9pZCAwOwogICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmVzdWx0LmUpCiAgICAgICAgICAgID8gcmVzdWx0LmUgOiBuZXcgRXJyb3IocmVzdWx0LmUgKyAiIik7CiAgICAgICAgdGhpcy5fcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgdGhpcy5fcHJvbWlzZS5fcmVqZWN0KHJlc3VsdC5lLCB0cmFjZSk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZTsKICAgIGlmIChyZXN1bHQuZG9uZSA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuX2dlbmVyYXRvciA9IHZvaWQgMDsKICAgICAgICBpZiAoIXRoaXMuX3Byb21pc2UuX3RyeUZvbGxvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgICAgICBpZiAoIShtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UgPQogICAgICAgICAgICAgICAgcHJvbWlzZUZyb21ZaWVsZEhhbmRsZXIobWF5YmVQcm9taXNlLCB0aGlzLl95aWVsZEhhbmRsZXJzKTsKICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fdGhyb3cobmV3IFR5cGVFcnJvcigiQSB2YWx1ZSB3YXMgeWllbGRlZCB0aGF0IGNvdWxkIG5vdCBiZSB0cmVhdGVkIGFzIGEgcHJvbWlzZSIpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oCiAgICAgICAgICAgIHRoaXMuX25leHQsCiAgICAgICAgICAgIHRoaXMuX3Rocm93LAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIG51bGwKICAgICAgICk7CiAgICB9Cn07CgpQcm9taXNlU3Bhd24ucHJvdG90eXBlLl90aHJvdyA9IGZ1bmN0aW9uIFByb21pc2VTcGF3biRfdGhyb3cocmVhc29uKSB7CiAgICBpZiAoZXJyb3JzLmNhbkF0dGFjaChyZWFzb24pKQogICAgICAgIHRoaXMuX3Byb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UocmVhc29uKTsKICAgIHRoaXMuX2NvbnRpbnVlKAogICAgICAgIHRyeUNhdGNoMSh0aGlzLl9nZW5lcmF0b3JbInRocm93Il0sIHRoaXMuX2dlbmVyYXRvciwgcmVhc29uKQogICApOwp9OwoKUHJvbWlzZVNwYXduLnByb3RvdHlwZS5fbmV4dCA9IGZ1bmN0aW9uIFByb21pc2VTcGF3biRfbmV4dCh2YWx1ZSkgewogICAgdGhpcy5fY29udGludWUoCiAgICAgICAgdHJ5Q2F0Y2gxKHRoaXMuX2dlbmVyYXRvci5uZXh0LCB0aGlzLl9nZW5lcmF0b3IsIHZhbHVlKQogICApOwp9OwoKUHJvbWlzZS5jb3JvdXRpbmUgPQpmdW5jdGlvbiBQcm9taXNlJENvcm91dGluZShnZW5lcmF0b3JGdW5jdGlvbiwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBnZW5lcmF0b3JGdW5jdGlvbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImdlbmVyYXRvckZ1bmN0aW9uIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgdmFyIHlpZWxkSGFuZGxlciA9IE9iamVjdChvcHRpb25zKS55aWVsZEhhbmRsZXI7CiAgICB2YXIgUHJvbWlzZVNwYXduJCA9IFByb21pc2VTcGF3bjsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGdlbmVyYXRvciA9IGdlbmVyYXRvckZ1bmN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIHNwYXduID0gbmV3IFByb21pc2VTcGF3biQodm9pZCAwLCB2b2lkIDAsIHlpZWxkSGFuZGxlcik7CiAgICAgICAgc3Bhd24uX2dlbmVyYXRvciA9IGdlbmVyYXRvcjsKICAgICAgICBzcGF3bi5fbmV4dCh2b2lkIDApOwogICAgICAgIHJldHVybiBzcGF3bi5wcm9taXNlKCk7CiAgICB9Owp9OwoKUHJvbWlzZS5jb3JvdXRpbmUuYWRkWWllbGRIYW5kbGVyID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgeWllbGRIYW5kbGVycy5wdXNoKGZuKTsKfTsKClByb21pc2Uuc3Bhd24gPSBmdW5jdGlvbiBQcm9taXNlJFNwYXduKGdlbmVyYXRvckZ1bmN0aW9uKSB7CiAgICBkZXByZWNhdGVkKCJQcm9taXNlLnNwYXduIGlzIGRlcHJlY2F0ZWQuIFVzZSBQcm9taXNlLmNvcm91dGluZSBpbnN0ZWFkLiIpOwogICAgaWYgKHR5cGVvZiBnZW5lcmF0b3JGdW5jdGlvbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImdlbmVyYXRvckZ1bmN0aW9uIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgdmFyIHNwYXduID0gbmV3IFByb21pc2VTcGF3bihnZW5lcmF0b3JGdW5jdGlvbiwgdGhpcyk7CiAgICB2YXIgcmV0ID0gc3Bhd24ucHJvbWlzZSgpOwogICAgc3Bhd24uX3J1bihQcm9taXNlLnNwYXduKTsKICAgIHJldHVybiByZXQ7Cn07Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPQpmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXksIGNhc3QsIElOVEVSTkFMKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKCgppZiAoY2FuRXZhbHVhdGUpIHsKICAgIHZhciB0aGVuQ2FsbGJhY2sgPSBmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigidmFsdWUiLCAiaG9sZGVyIiwgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICd1c2Ugc3RyaWN0JzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIGhvbGRlci5wSW5kZXggPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIGhvbGRlci5jaGVja0Z1bGZpbGxtZW50KHRoaXMpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICIucmVwbGFjZSgvSW5kZXgvZywgaSkpOwogICAgfTsKCiAgICB2YXIgY2FsbGVyID0gZnVuY3Rpb24oY291bnQpIHsKICAgICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gY291bnQ7ICsraSkgdmFsdWVzLnB1c2goImhvbGRlci5wIiArIGkpOwogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oImhvbGRlciIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBob2xkZXIuZm47ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sodmFsdWVzKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiLnJlcGxhY2UoL3ZhbHVlcy9nLCB2YWx1ZXMuam9pbigiLCAiKSkpOwogICAgfTsKICAgIHZhciB0aGVuQ2FsbGJhY2tzID0gW107CiAgICB2YXIgY2FsbGVycyA9IFt2b2lkIDBdOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gNTsgKytpKSB7CiAgICAgICAgdGhlbkNhbGxiYWNrcy5wdXNoKHRoZW5DYWxsYmFjayhpKSk7CiAgICAgICAgY2FsbGVycy5wdXNoKGNhbGxlcihpKSk7CiAgICB9CgogICAgdmFyIEhvbGRlciA9IGZ1bmN0aW9uKHRvdGFsLCBmbikgewogICAgICAgIHRoaXMucDEgPSB0aGlzLnAyID0gdGhpcy5wMyA9IHRoaXMucDQgPSB0aGlzLnA1ID0gbnVsbDsKICAgICAgICB0aGlzLmZuID0gZm47CiAgICAgICAgdGhpcy50b3RhbCA9IHRvdGFsOwogICAgICAgIHRoaXMubm93ID0gMDsKICAgIH07CgogICAgSG9sZGVyLnByb3RvdHlwZS5jYWxsZXJzID0gY2FsbGVyczsKICAgIEhvbGRlci5wcm90b3R5cGUuY2hlY2tGdWxmaWxsbWVudCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICB2YXIgbm93ID0gdGhpcy5ub3c7CiAgICAgICAgbm93Kys7CiAgICAgICAgdmFyIHRvdGFsID0gdGhpcy50b3RhbDsKICAgICAgICBpZiAobm93ID49IHRvdGFsKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5jYWxsZXJzW3RvdGFsXTsKICAgICAgICAgICAgdmFyIHJldCA9IHRyeUNhdGNoMShoYW5kbGVyLCB2b2lkIDAsIHRoaXMpOwogICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0VW5jaGVja2VkKHJldC5lKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvbWlzZS5fdHJ5Rm9sbG93KHJldCkpIHsKICAgICAgICAgICAgICAgIHByb21pc2UuX2Z1bGZpbGxVbmNoZWNrZWQocmV0KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMubm93ID0gbm93OwogICAgICAgIH0KICAgIH07Cn0KCgoKClByb21pc2Uuam9pbiA9IGZ1bmN0aW9uIFByb21pc2UkSm9pbigpIHsKICAgIHZhciBsYXN0ID0gYXJndW1lbnRzLmxlbmd0aCAtIDE7CiAgICB2YXIgZm47CiAgICBpZiAobGFzdCA+IDAgJiYgdHlwZW9mIGFyZ3VtZW50c1tsYXN0XSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGZuID0gYXJndW1lbnRzW2xhc3RdOwogICAgICAgIGlmIChsYXN0IDwgNiAmJiBjYW5FdmFsdWF0ZSkgewogICAgICAgICAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgICAgICByZXQuX3NldFRyYWNlKHZvaWQgMCk7CiAgICAgICAgICAgIHZhciBob2xkZXIgPSBuZXcgSG9sZGVyKGxhc3QsIGZuKTsKICAgICAgICAgICAgdmFyIHJlamVjdCA9IHJldC5fcmVqZWN0OwogICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gdGhlbkNhbGxiYWNrczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsYXN0OyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBtYXliZVByb21pc2UgPSBjYXN0KGFyZ3VtZW50c1tpXSwgdm9pZCAwKTsKICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oY2FsbGJhY2tzW2ldLCByZWplY3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkIDAsIHJldCwgaG9sZGVyKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXS5jYWxsKHJldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlLl9zZXR0bGVkVmFsdWUsIGhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0Ll9yZWplY3QobWF5YmVQcm9taXNlLl9zZXR0bGVkVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXS5jYWxsKHJldCwgbWF5YmVQcm9taXNlLCBob2xkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgfQogICAgdmFyICRfbGVuID0gYXJndW1lbnRzLmxlbmd0aDt2YXIgYXJncyA9IG5ldyBBcnJheSgkX2xlbik7IGZvcih2YXIgJF9pID0gMDsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2ldID0gYXJndW1lbnRzWyRfaV07fQogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlQXJyYXkoYXJncykucHJvbWlzZSgpOwogICAgcmV0dXJuIGZuICE9PSB2b2lkIDAgPyByZXQuc3ByZWFkKGZuKSA6IHJldDsKfTsKCn07Cgp9LHsiLi91dGlsLmpzIjo1MH1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgUHJvbWlzZUFycmF5LCBhcGlSZWplY3Rpb24sIGNhc3QsIElOVEVSTkFMKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciB0cnlDYXRjaDMgPSB1dGlsLnRyeUNhdGNoMzsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKdmFyIFBFTkRJTkcgPSB7fTsKdmFyIEVNUFRZX0FSUkFZID0gW107CgpmdW5jdGlvbiBNYXBwaW5nUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgbGltaXQsIF9maWx0ZXIpIHsKICAgIHRoaXMuY29uc3RydWN0b3IkKHByb21pc2VzKTsKICAgIHRoaXMuX2NhbGxiYWNrID0gZm47CiAgICB0aGlzLl9wcmVzZXJ2ZWRWYWx1ZXMgPSBfZmlsdGVyID09PSBJTlRFUk5BTAogICAgICAgID8gbmV3IEFycmF5KHRoaXMubGVuZ3RoKCkpCiAgICAgICAgOiBudWxsOwogICAgdGhpcy5fbGltaXQgPSBsaW1pdDsKICAgIHRoaXMuX2luRmxpZ2h0ID0gMDsKICAgIHRoaXMuX3F1ZXVlID0gbGltaXQgPj0gMSA/IFtdIDogRU1QVFlfQVJSQVk7CiAgICB0aGlzLl9pbml0JCh2b2lkIDAsIC0yKTsKfQp1dGlsLmluaGVyaXRzKE1hcHBpbmdQcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpNYXBwaW5nUHJvbWlzZUFycmF5LnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIE1hcHBpbmdQcm9taXNlQXJyYXkkX2luaXQoKSB7fTsKCk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gTWFwcGluZ1Byb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIHZhciB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7CiAgICBpZiAodmFsdWVzID09PSBudWxsKSByZXR1cm47CgogICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoKCk7CiAgICB2YXIgcHJlc2VydmVkVmFsdWVzID0gdGhpcy5fcHJlc2VydmVkVmFsdWVzOwogICAgdmFyIGxpbWl0ID0gdGhpcy5fbGltaXQ7CiAgICBpZiAodmFsdWVzW2luZGV4XSA9PT0gUEVORElORykgewogICAgICAgIHZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICBpZiAobGltaXQgPj0gMSkgewogICAgICAgICAgICB0aGlzLl9pbkZsaWdodC0tOwogICAgICAgICAgICB0aGlzLl9kcmFpblF1ZXVlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmIChsaW1pdCA+PSAxICYmIHRoaXMuX2luRmxpZ2h0ID49IGxpbWl0KSB7CiAgICAgICAgICAgIHZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5fcXVldWUucHVzaChpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHByZXNlcnZlZFZhbHVlcyAhPT0gbnVsbCkgcHJlc2VydmVkVmFsdWVzW2luZGV4XSA9IHZhbHVlOwoKICAgICAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLl9jYWxsYmFjazsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSB0aGlzLl9wcm9taXNlLl9ib3VuZFRvOwogICAgICAgIHZhciByZXQgPSB0cnlDYXRjaDMoY2FsbGJhY2ssIHJlY2VpdmVyLCB2YWx1ZSwgaW5kZXgsIGxlbmd0aCk7CiAgICAgICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHJldHVybiB0aGlzLl9yZWplY3QocmV0LmUpOwoKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXQsIHZvaWQgMCk7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICAgICAgaWYgKGxpbWl0ID49IDEpIHRoaXMuX2luRmxpZ2h0Kys7CiAgICAgICAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gUEVORElORzsKICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGluZGV4KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXliZVByb21pc2UuaXNGdWxmaWxsZWQoKSkgewogICAgICAgICAgICAgICAgcmV0ID0gbWF5YmVQcm9taXNlLnZhbHVlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWplY3QobWF5YmVQcm9taXNlLnJlYXNvbigpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YWx1ZXNbaW5kZXhdID0gcmV0OwogICAgfQogICAgdmFyIHRvdGFsUmVzb2x2ZWQgPSArK3RoaXMuX3RvdGFsUmVzb2x2ZWQ7CiAgICBpZiAodG90YWxSZXNvbHZlZCA+PSBsZW5ndGgpIHsKICAgICAgICBpZiAocHJlc2VydmVkVmFsdWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpbHRlcih2YWx1ZXMsIHByZXNlcnZlZFZhbHVlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh2YWx1ZXMpOwogICAgICAgIH0KCiAgICB9Cn07CgpNYXBwaW5nUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fZHJhaW5RdWV1ZSA9CmZ1bmN0aW9uIE1hcHBpbmdQcm9taXNlQXJyYXkkX2RyYWluUXVldWUoKSB7CiAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTsKICAgIHZhciBsaW1pdCA9IHRoaXMuX2xpbWl0OwogICAgdmFyIHZhbHVlcyA9IHRoaXMuX3ZhbHVlczsKICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwICYmIHRoaXMuX2luRmxpZ2h0IDwgbGltaXQpIHsKICAgICAgICB2YXIgaW5kZXggPSBxdWV1ZS5wb3AoKTsKICAgICAgICB0aGlzLl9wcm9taXNlRnVsZmlsbGVkKHZhbHVlc1tpbmRleF0sIGluZGV4KTsKICAgIH0KfTsKCk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9maWx0ZXIgPQpmdW5jdGlvbiBNYXBwaW5nUHJvbWlzZUFycmF5JF9maWx0ZXIoYm9vbGVhbnMsIHZhbHVlcykgewogICAgdmFyIGxlbiA9IHZhbHVlcy5sZW5ndGg7CiAgICB2YXIgcmV0ID0gbmV3IEFycmF5KGxlbik7CiAgICB2YXIgaiA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgaWYgKGJvb2xlYW5zW2ldKSByZXRbaisrXSA9IHZhbHVlc1tpXTsKICAgIH0KICAgIHJldC5sZW5ndGggPSBqOwogICAgdGhpcy5fcmVzb2x2ZShyZXQpOwp9OwoKTWFwcGluZ1Byb21pc2VBcnJheS5wcm90b3R5cGUucHJlc2VydmVkVmFsdWVzID0KZnVuY3Rpb24gTWFwcGluZ1Byb21pc2VBcnJheSRwcmVzZXJ2ZVZhbHVlcygpIHsKICAgIHJldHVybiB0aGlzLl9wcmVzZXJ2ZWRWYWx1ZXM7Cn07CgpmdW5jdGlvbiBtYXAocHJvbWlzZXMsIGZuLCBvcHRpb25zLCBfZmlsdGVyKSB7CiAgICB2YXIgbGltaXQgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbAogICAgICAgID8gb3B0aW9ucy5jb25jdXJyZW5jeQogICAgICAgIDogMDsKICAgIGxpbWl0ID0gdHlwZW9mIGxpbWl0ID09PSAibnVtYmVyIiAmJgogICAgICAgIGlzRmluaXRlKGxpbWl0KSAmJiBsaW1pdCA+PSAxID8gbGltaXQgOiAwOwogICAgcmV0dXJuIG5ldyBNYXBwaW5nUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgbGltaXQsIF9maWx0ZXIpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5tYXAgPSBmdW5jdGlvbiBQcm9taXNlJG1hcChmbiwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CgogICAgcmV0dXJuIG1hcCh0aGlzLCBmbiwgb3B0aW9ucywgbnVsbCkucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5tYXAgPSBmdW5jdGlvbiBQcm9taXNlJE1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIF9maWx0ZXIpIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHJldHVybiBhcGlSZWplY3Rpb24oImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgcmV0dXJuIG1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIF9maWx0ZXIpLnByb21pc2UoKTsKfTsKCgp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgdHJ5Q2F0Y2gyID0gdXRpbC50cnlDYXRjaDI7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKCmZ1bmN0aW9uIHRocm93ZXIocikgewogICAgdGhyb3cgcjsKfQoKZnVuY3Rpb24gUHJvbWlzZSRfc3ByZWFkQWRhcHRlcih2YWwsIHJlY2VpdmVyKSB7CiAgICBpZiAoIXV0aWwuaXNBcnJheSh2YWwpKSByZXR1cm4gUHJvbWlzZSRfc3VjY2Vzc0FkYXB0ZXIodmFsLCByZWNlaXZlcik7CiAgICB2YXIgcmV0ID0gdXRpbC50cnlDYXRjaEFwcGx5KHRoaXMsIFtudWxsXS5jb25jYXQodmFsKSwgcmVjZWl2ZXIpOwogICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHsKICAgICAgICBhc3luYy5pbnZva2VMYXRlcih0aHJvd2VyLCB2b2lkIDAsIHJldC5lKTsKICAgIH0KfQoKZnVuY3Rpb24gUHJvbWlzZSRfc3VjY2Vzc0FkYXB0ZXIodmFsLCByZWNlaXZlcikgewogICAgdmFyIG5vZGViYWNrID0gdGhpczsKICAgIHZhciByZXQgPSB2YWwgPT09IHZvaWQgMAogICAgICAgID8gdHJ5Q2F0Y2gxKG5vZGViYWNrLCByZWNlaXZlciwgbnVsbCkKICAgICAgICA6IHRyeUNhdGNoMihub2RlYmFjaywgcmVjZWl2ZXIsIG51bGwsIHZhbCk7CiAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgcmV0LmUpOwogICAgfQp9CmZ1bmN0aW9uIFByb21pc2UkX2Vycm9yQWRhcHRlcihyZWFzb24sIHJlY2VpdmVyKSB7CiAgICB2YXIgbm9kZWJhY2sgPSB0aGlzOwogICAgdmFyIHJldCA9IHRyeUNhdGNoMShub2RlYmFjaywgcmVjZWl2ZXIsIHJlYXNvbik7CiAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgcmV0LmUpOwogICAgfQp9CgpQcm9taXNlLnByb3RvdHlwZS5ub2RlaWZ5ID0gZnVuY3Rpb24gUHJvbWlzZSRub2RlaWZ5KG5vZGViYWNrLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIG5vZGViYWNrID09ICJmdW5jdGlvbiIpIHsKICAgICAgICB2YXIgYWRhcHRlciA9IFByb21pc2UkX3N1Y2Nlc3NBZGFwdGVyOwogICAgICAgIGlmIChvcHRpb25zICE9PSB2b2lkIDAgJiYgT2JqZWN0KG9wdGlvbnMpLnNwcmVhZCkgewogICAgICAgICAgICBhZGFwdGVyID0gUHJvbWlzZSRfc3ByZWFkQWRhcHRlcjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdGhlbigKICAgICAgICAgICAgYWRhcHRlciwKICAgICAgICAgICAgUHJvbWlzZSRfZXJyb3JBZGFwdGVyLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIG5vZGViYWNrLAogICAgICAgICAgICB0aGlzLl9ib3VuZFRvCiAgICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9Owp9OwoKfSx7Ii4vYXN5bmMuanMiOjE4LCIuL3V0aWwuanMiOjUwfV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXkpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKTsKdmFyIHRyeUNhdGNoMSA9IHV0aWwudHJ5Q2F0Y2gxOwp2YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqOwoKUHJvbWlzZS5wcm90b3R5cGUucHJvZ3Jlc3NlZCA9IGZ1bmN0aW9uIFByb21pc2UkcHJvZ3Jlc3NlZChoYW5kbGVyKSB7CiAgICByZXR1cm4gdGhpcy5fdGhlbih2b2lkIDAsIHZvaWQgMCwgaGFuZGxlciwgdm9pZCAwLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Byb2dyZXNzID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJvZ3Jlc3MocHJvZ3Jlc3NWYWx1ZSkgewogICAgaWYgKHRoaXMuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkKCkpIHJldHVybjsKICAgIHRoaXMuX3Byb2dyZXNzVW5jaGVja2VkKHByb2dyZXNzVmFsdWUpOwoKfTsKClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGEkQmFzZSA9ClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGE7ClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGEgPQpmdW5jdGlvbiBQcm9taXNlJF9jbGVhckZpcnN0SGFuZGxlckRhdGEoKSB7CiAgICB0aGlzLl9jbGVhckZpcnN0SGFuZGxlckRhdGEkQmFzZSgpOwogICAgdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyMCA9IHZvaWQgMDsKfTsKClByb21pc2UucHJvdG90eXBlLl9wcm9ncmVzc0hhbmRsZXJBdCA9CmZ1bmN0aW9uIFByb21pc2UkX3Byb2dyZXNzSGFuZGxlckF0KGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3Byb2dyZXNzSGFuZGxlcjAKICAgICAgICA6IHRoaXNbKGluZGV4IDw8IDIpICsgaW5kZXggLSA1ICsgMl07Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZG9Qcm9ncmVzc1dpdGggPQpmdW5jdGlvbiBQcm9taXNlJF9kb1Byb2dyZXNzV2l0aChwcm9ncmVzc2lvbikgewogICAgdmFyIHByb2dyZXNzVmFsdWUgPSBwcm9ncmVzc2lvbi52YWx1ZTsKICAgIHZhciBoYW5kbGVyID0gcHJvZ3Jlc3Npb24uaGFuZGxlcjsKICAgIHZhciBwcm9taXNlID0gcHJvZ3Jlc3Npb24ucHJvbWlzZTsKICAgIHZhciByZWNlaXZlciA9IHByb2dyZXNzaW9uLnJlY2VpdmVyOwoKICAgIHZhciByZXQgPSB0cnlDYXRjaDEoaGFuZGxlciwgcmVjZWl2ZXIsIHByb2dyZXNzVmFsdWUpOwogICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHsKICAgICAgICBpZiAocmV0LmUgIT0gbnVsbCAmJgogICAgICAgICAgICByZXQuZS5uYW1lICE9PSAiU3RvcFByb2dyZXNzUHJvcGFnYXRpb24iKSB7CiAgICAgICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmV0LmUpCiAgICAgICAgICAgICAgICA/IHJldC5lIDogbmV3IEVycm9yKHJldC5lICsgIiIpOwogICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgICAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3MocmV0LmUpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAocmV0IGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHJldC5fdGhlbihwcm9taXNlLl9wcm9ncmVzcywgbnVsbCwgbnVsbCwgcHJvbWlzZSwgdm9pZCAwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3MocmV0KTsKICAgIH0KfTsKCgpQcm9taXNlLnByb3RvdHlwZS5fcHJvZ3Jlc3NVbmNoZWNrZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9wcm9ncmVzc1VuY2hlY2tlZChwcm9ncmVzc1ZhbHVlKSB7CiAgICBpZiAoIXRoaXMuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIHZhciBsZW4gPSB0aGlzLl9sZW5ndGgoKTsKICAgIHZhciBwcm9ncmVzcyA9IHRoaXMuX3Byb2dyZXNzOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyQXQoaSk7CiAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlQXQoaSk7CiAgICAgICAgaWYgKCEocHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSB7CiAgICAgICAgICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3JlY2VpdmVyQXQoaSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKHJlY2VpdmVyLCBwcm9ncmVzc1ZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciBpbnN0YW5jZW9mIFByb21pc2UgJiYgcmVjZWl2ZXIuX2lzUHJveGllZCgpKSB7CiAgICAgICAgICAgICAgICByZWNlaXZlci5fcHJvZ3Jlc3NVbmNoZWNrZWQocHJvZ3Jlc3NWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVjZWl2ZXIgaW5zdGFuY2VvZiBQcm9taXNlQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVyLl9wcm9taXNlUHJvZ3Jlc3NlZChwcm9ncmVzc1ZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhc3luYy5pbnZva2UodGhpcy5fZG9Qcm9ncmVzc1dpdGgsIHRoaXMsIHsKICAgICAgICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICAgICAgICBwcm9taXNlOiBwcm9taXNlLAogICAgICAgICAgICAgICAgcmVjZWl2ZXI6IHRoaXMuX3JlY2VpdmVyQXQoaSksCiAgICAgICAgICAgICAgICB2YWx1ZTogcHJvZ3Jlc3NWYWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3luYy5pbnZva2UocHJvZ3Jlc3MsIHByb21pc2UsIHByb2dyZXNzVmFsdWUpOwogICAgICAgIH0KICAgIH0KfTsKfTsKCn0seyIuL2FzeW5jLmpzIjoxOCwiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIG9sZDsKaWYgKHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgb2xkID0gUHJvbWlzZTsKZnVuY3Rpb24gbm9Db25mbGljdChibHVlYmlyZCkgewogICAgdHJ5IHsgaWYgKFByb21pc2UgPT09IGJsdWViaXJkKSBQcm9taXNlID0gb2xkOyB9CiAgICBjYXRjaCAoZSkge30KICAgIHJldHVybiBibHVlYmlyZDsKfQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkgewp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwp2YXIgYXN5bmMgPSByZXF1aXJlKCIuL2FzeW5jLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwoKdmFyIElOVEVSTkFMID0gZnVuY3Rpb24oKXt9Owp2YXIgQVBQTFkgPSB7fTsKdmFyIE5FWFRfRklMVEVSID0ge2U6IG51bGx9OwoKdmFyIGNhc3QgPSByZXF1aXJlKCIuL3RoZW5hYmxlcy5qcyIpKFByb21pc2UsIElOVEVSTkFMKTsKdmFyIFByb21pc2VBcnJheSA9IHJlcXVpcmUoIi4vcHJvbWlzZV9hcnJheS5qcyIpKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KTsKdmFyIENhcHR1cmVkVHJhY2UgPSByZXF1aXJlKCIuL2NhcHR1cmVkX3RyYWNlLmpzIikoKTsKdmFyIENhdGNoRmlsdGVyID0gcmVxdWlyZSgiLi9jYXRjaF9maWx0ZXIuanMiKShORVhUX0ZJTFRFUik7CnZhciBQcm9taXNlUmVzb2x2ZXIgPSByZXF1aXJlKCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiKTsKCnZhciBpc0FycmF5ID0gdXRpbC5pc0FycmF5OwoKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKdmFyIHRyeUNhdGNoMSA9IHV0aWwudHJ5Q2F0Y2gxOwp2YXIgdHJ5Q2F0Y2gyID0gdXRpbC50cnlDYXRjaDI7CnZhciB0cnlDYXRjaEFwcGx5ID0gdXRpbC50cnlDYXRjaEFwcGx5Owp2YXIgUmFuZ2VFcnJvciA9IGVycm9ycy5SYW5nZUVycm9yOwp2YXIgVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjsKdmFyIENhbmNlbGxhdGlvbkVycm9yID0gZXJyb3JzLkNhbmNlbGxhdGlvbkVycm9yOwp2YXIgVGltZW91dEVycm9yID0gZXJyb3JzLlRpbWVvdXRFcnJvcjsKdmFyIE9wZXJhdGlvbmFsRXJyb3IgPSBlcnJvcnMuT3BlcmF0aW9uYWxFcnJvcjsKdmFyIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uID0gZXJyb3JzLm9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uOwp2YXIgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uID0gZXJyb3JzLm1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbjsKdmFyIGNhbkF0dGFjaCA9IGVycm9ycy5jYW5BdHRhY2g7CnZhciB0aHJvd2VyID0gdXRpbC50aHJvd2VyOwp2YXIgYXBpUmVqZWN0aW9uID0gcmVxdWlyZSgiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiIpKFByb21pc2UpOwoKCnZhciBtYWtlU2VsZlJlc29sdXRpb25FcnJvciA9IGZ1bmN0aW9uIFByb21pc2UkX21ha2VTZWxmUmVzb2x1dGlvbkVycm9yKCkgewogICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoImNpcmN1bGFyIHByb21pc2UgcmVzb2x1dGlvbiBjaGFpbiIpOwp9OwoKZnVuY3Rpb24gUHJvbWlzZShyZXNvbHZlcikgewogICAgaWYgKHR5cGVvZiByZXNvbHZlciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIHJlcXVpcmVzIGEgcmVzb2x2ZXIgZnVuY3Rpb24iKTsKICAgIH0KICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yICE9PSBQcm9taXNlKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidGhlIHByb21pc2UgY29uc3RydWN0b3IgY2Fubm90IGJlIGludm9rZWQgZGlyZWN0bHkiKTsKICAgIH0KICAgIHRoaXMuX2JpdEZpZWxkID0gMDsKICAgIHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjAgPSB2b2lkIDA7CiAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9IHZvaWQgMDsKICAgIHRoaXMuX3Byb21pc2UwID0gdm9pZCAwOwogICAgdGhpcy5fcmVjZWl2ZXIwID0gdm9pZCAwOwogICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdm9pZCAwOwogICAgdGhpcy5fYm91bmRUbyA9IHZvaWQgMDsKICAgIGlmIChyZXNvbHZlciAhPT0gSU5URVJOQUwpIHRoaXMuX3Jlc29sdmVGcm9tUmVzb2x2ZXIocmVzb2x2ZXIpOwp9CgpmdW5jdGlvbiByZXR1cm5GaXJzdEVsZW1lbnQoZWxlbWVudHMpIHsKICAgIHJldHVybiBlbGVtZW50c1swXTsKfQoKUHJvbWlzZS5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uIFByb21pc2UkYmluZCh0aGlzQXJnKSB7CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGlzQXJnLCB2b2lkIDApOwogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgdmFyIGJpbmRlciA9IG1heWJlUHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRoaXNBcmcpIHsKICAgICAgICAgICAgcmV0Ll9zZXRCb3VuZFRvKHRoaXNBcmcpOwogICAgICAgIH0pOwogICAgICAgIHZhciBwID0gUHJvbWlzZS5hbGwoW3RoaXMsIGJpbmRlcl0pLnRoZW4ocmV0dXJuRmlyc3RFbGVtZW50KTsKICAgICAgICByZXQuX2ZvbGxvdyhwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0Ll9mb2xsb3codGhpcyk7CiAgICAgICAgcmV0Ll9zZXRCb3VuZFRvKHRoaXNBcmcpOwogICAgfQogICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHRoaXMsIDIgfCAxKTsKICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIFByb21pc2UkdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIltvYmplY3QgUHJvbWlzZV0iOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuY2F1Z2h0ID0gUHJvbWlzZS5wcm90b3R5cGVbImNhdGNoIl0gPQpmdW5jdGlvbiBQcm9taXNlJGNhdGNoKGZuKSB7CiAgICB2YXIgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIGlmIChsZW4gPiAxKSB7CiAgICAgICAgdmFyIGNhdGNoSW5zdGFuY2VzID0gbmV3IEFycmF5KGxlbiAtIDEpLAogICAgICAgICAgICBqID0gMCwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuIC0gMTsgKytpKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGNhdGNoSW5zdGFuY2VzW2orK10gPSBpdGVtOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGNhdGNoRmlsdGVyVHlwZUVycm9yID0KICAgICAgICAgICAgICAgICAgICBuZXcgVHlwZUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiQSBjYXRjaCBmaWx0ZXIgbXVzdCBiZSBhbiBlcnJvciBjb25zdHJ1Y3RvciAiCiAgICAgICAgICAgICAgICAgICAgICAgICsgIm9yIGEgZmlsdGVyIGZ1bmN0aW9uIik7CgogICAgICAgICAgICAgICAgdGhpcy5fYXR0YWNoRXh0cmFUcmFjZShjYXRjaEZpbHRlclR5cGVFcnJvcik7CiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoY2F0Y2hGaWx0ZXJUeXBlRXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoSW5zdGFuY2VzLmxlbmd0aCA9IGo7CiAgICAgICAgZm4gPSBhcmd1bWVudHNbaV07CgogICAgICAgIHRoaXMuX3Jlc2V0VHJhY2UoKTsKICAgICAgICB2YXIgY2F0Y2hGaWx0ZXIgPSBuZXcgQ2F0Y2hGaWx0ZXIoY2F0Y2hJbnN0YW5jZXMsIGZuLCB0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fdGhlbih2b2lkIDAsIGNhdGNoRmlsdGVyLmRvRmlsdGVyLCB2b2lkIDAsCiAgICAgICAgICAgIGNhdGNoRmlsdGVyLCB2b2lkIDApOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3RoZW4odm9pZCAwLCBmbiwgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCk7Cn07CgpmdW5jdGlvbiByZWZsZWN0KCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlLlByb21pc2VJbnNwZWN0aW9uKHRoaXMpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5yZWZsZWN0ID0gZnVuY3Rpb24gUHJvbWlzZSRyZWZsZWN0KCkgewogICAgcmV0dXJuIHRoaXMuX3RoZW4ocmVmbGVjdCwgcmVmbGVjdCwgdm9pZCAwLCB0aGlzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUudGhlbiA9CmZ1bmN0aW9uIFByb21pc2UkdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzKSB7CiAgICByZXR1cm4gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLAogICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKfTsKCgpQcm9taXNlLnByb3RvdHlwZS5kb25lID0KZnVuY3Rpb24gUHJvbWlzZSRkb25lKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCwgZGlkUHJvZ3Jlc3MpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLAogICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKICAgIHByb21pc2UuX3NldElzRmluYWwoKTsKfTsKClByb21pc2UucHJvdG90eXBlLnNwcmVhZCA9IGZ1bmN0aW9uIFByb21pc2Ukc3ByZWFkKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCkgewogICAgcmV0dXJuIHRoaXMuX3RoZW4oZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCB2b2lkIDAsCiAgICAgICAgQVBQTFksIHZvaWQgMCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5pc0NhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRpc0NhbmNlbGxhYmxlKCkgewogICAgcmV0dXJuICF0aGlzLmlzUmVzb2x2ZWQoKSAmJgogICAgICAgIHRoaXMuX2NhbmNlbGxhYmxlKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiBQcm9taXNlJHRvSlNPTigpIHsKICAgIHZhciByZXQgPSB7CiAgICAgICAgaXNGdWxmaWxsZWQ6IGZhbHNlLAogICAgICAgIGlzUmVqZWN0ZWQ6IGZhbHNlLAogICAgICAgIGZ1bGZpbGxtZW50VmFsdWU6IHZvaWQgMCwKICAgICAgICByZWplY3Rpb25SZWFzb246IHZvaWQgMAogICAgfTsKICAgIGlmICh0aGlzLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICByZXQuZnVsZmlsbG1lbnRWYWx1ZSA9IHRoaXMuX3NldHRsZWRWYWx1ZTsKICAgICAgICByZXQuaXNGdWxmaWxsZWQgPSB0cnVlOwogICAgfSBlbHNlIGlmICh0aGlzLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIHJldC5yZWplY3Rpb25SZWFzb24gPSB0aGlzLl9zZXR0bGVkVmFsdWU7CiAgICAgICAgcmV0LmlzUmVqZWN0ZWQgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UucHJvdG90eXBlLmFsbCA9IGZ1bmN0aW9uIFByb21pc2UkYWxsKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlQXJyYXkodGhpcykucHJvbWlzZSgpOwp9OwoKClByb21pc2UuaXMgPSBmdW5jdGlvbiBQcm9taXNlJElzKHZhbCkgewogICAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIFByb21pc2U7Cn07CgpQcm9taXNlLmFsbCA9IGZ1bmN0aW9uIFByb21pc2UkQWxsKHByb21pc2VzKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2VBcnJheShwcm9taXNlcykucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiBQcm9taXNlJF9lcnJvcihmbikgewogICAgcmV0dXJuIHRoaXMuY2F1Z2h0KG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uLCBmbik7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVzb2x2ZUZyb21TeW5jVmFsdWUgPQpmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVN5bmNWYWx1ZSh2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBlcnJvck9iaikgewogICAgICAgIHRoaXMuX2NsZWFuVmFsdWVzKCk7CiAgICAgICAgdGhpcy5fc2V0UmVqZWN0ZWQoKTsKICAgICAgICB2YXIgcmVhc29uID0gdmFsdWUuZTsKICAgICAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSByZWFzb247CiAgICAgICAgdGhpcy5fdHJ5QXR0YWNoRXh0cmFUcmFjZShyZWFzb24pOwogICAgICAgIHRoaXMuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICB0aGlzLl9mb2xsb3cobWF5YmVQcm9taXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9jbGVhblZhbHVlcygpOwogICAgICAgICAgICB0aGlzLl9zZXRGdWxmaWxsZWQoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgfQp9OwoKUHJvbWlzZS5tZXRob2QgPSBmdW5jdGlvbiBQcm9taXNlJF9NZXRob2QoZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJmbiBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbiBQcm9taXNlJF9tZXRob2QoKSB7CiAgICAgICAgdmFyIHZhbHVlOwogICAgICAgIHN3aXRjaChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgY2FzZSAwOiB2YWx1ZSA9IHRyeUNhdGNoMShmbiwgdGhpcywgdm9pZCAwKTsgYnJlYWs7CiAgICAgICAgY2FzZSAxOiB2YWx1ZSA9IHRyeUNhdGNoMShmbiwgdGhpcywgYXJndW1lbnRzWzBdKTsgYnJlYWs7CiAgICAgICAgY2FzZSAyOiB2YWx1ZSA9IHRyeUNhdGNoMihmbiwgdGhpcywgYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMV0pOyBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuKTsgZm9yKHZhciAkX2kgPSAwOyAkX2kgPCAkX2xlbjsgKyskX2kpIHthcmdzWyRfaV0gPSBhcmd1bWVudHNbJF9pXTt9CiAgICAgICAgICAgIHZhbHVlID0gdHJ5Q2F0Y2hBcHBseShmbiwgYXJncywgdGhpcyk7IGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICByZXQuX3Jlc29sdmVGcm9tU3luY1ZhbHVlKHZhbHVlKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfTsKfTsKClByb21pc2UuYXR0ZW1wdCA9IFByb21pc2VbInRyeSJdID0gZnVuY3Rpb24gUHJvbWlzZSRfVHJ5KGZuLCBhcmdzLCBjdHgpIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gYXBpUmVqZWN0aW9uKCJmbiBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgIH0KICAgIHZhciB2YWx1ZSA9IGlzQXJyYXkoYXJncykKICAgICAgICA/IHRyeUNhdGNoQXBwbHkoZm4sIGFyZ3MsIGN0eCkKICAgICAgICA6IHRyeUNhdGNoMShmbiwgY3R4LCBhcmdzKTsKCiAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgcmV0Ll9zZXRUcmFjZSh2b2lkIDApOwogICAgcmV0Ll9yZXNvbHZlRnJvbVN5bmNWYWx1ZSh2YWx1ZSk7CiAgICByZXR1cm4gcmV0Owp9OwoKUHJvbWlzZS5kZWZlciA9IFByb21pc2UucGVuZGluZyA9IGZ1bmN0aW9uIFByb21pc2UkRGVmZXIoKSB7CiAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7CiAgICByZXR1cm4gbmV3IFByb21pc2VSZXNvbHZlcihwcm9taXNlKTsKfTsKClByb21pc2UuYmluZCA9IGZ1bmN0aW9uIFByb21pc2UkQmluZCh0aGlzQXJnKSB7CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGlzQXJnLCB2b2lkIDApOwogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKCiAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHZhciBwID0gbWF5YmVQcm9taXNlLnRoZW4oZnVuY3Rpb24odGhpc0FyZykgewogICAgICAgICAgICByZXQuX3NldEJvdW5kVG8odGhpc0FyZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0Ll9mb2xsb3cocCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldC5fc2V0Qm91bmRUbyh0aGlzQXJnKTsKICAgICAgICByZXQuX3NldEZ1bGZpbGxlZCgpOwogICAgfQogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UuY2FzdCA9IGZ1bmN0aW9uIFByb21pc2UkX0Nhc3Qob2JqKSB7CiAgICB2YXIgcmV0ID0gY2FzdChvYmosIHZvaWQgMCk7CiAgICBpZiAoIShyZXQgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgIHZhciB2YWwgPSByZXQ7CiAgICAgICAgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICByZXQuX3NldEZ1bGZpbGxlZCgpOwogICAgICAgIHJldC5fY2xlYW5WYWx1ZXMoKTsKICAgICAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHZhbDsKICAgIH0KICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnJlc29sdmUgPSBQcm9taXNlLmZ1bGZpbGxlZCA9IFByb21pc2UuY2FzdDsKClByb21pc2UucmVqZWN0ID0gUHJvbWlzZS5yZWplY3RlZCA9IGZ1bmN0aW9uIFByb21pc2UkUmVqZWN0KHJlYXNvbikgewogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgIG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihyZWFzb24pOwogICAgcmV0Ll9jbGVhblZhbHVlcygpOwogICAgcmV0Ll9zZXRSZWplY3RlZCgpOwogICAgcmV0Ll9zZXR0bGVkVmFsdWUgPSByZWFzb247CiAgICBpZiAoIWNhbkF0dGFjaChyZWFzb24pKSB7CiAgICAgICAgdmFyIHRyYWNlID0gbmV3IEVycm9yKHJlYXNvbiArICIiKTsKICAgICAgICByZXQuX3NldENhcnJpZWRTdGFja1RyYWNlKHRyYWNlKTsKICAgIH0KICAgIHJldC5fZW5zdXJlUG9zc2libGVSZWplY3Rpb25IYW5kbGVkKCk7CiAgICByZXR1cm4gcmV0Owp9OwoKUHJvbWlzZS5vblBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gUHJvbWlzZSRPblBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uKGZuKSB7CiAgICAgICAgQ2FwdHVyZWRUcmFjZS5wb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbiA9IHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBmbiA6IHZvaWQgMDsKfTsKCnZhciB1bmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkOwpQcm9taXNlLm9uVW5oYW5kbGVkUmVqZWN0aW9uSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2Ukb25VbmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkKGZuKSB7CiAgICB1bmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkID0gdHlwZW9mIGZuID09PSAiZnVuY3Rpb24iID8gZm4gOiB2b2lkIDA7Cn07Cgp2YXIgZGVidWdnaW5nID0gZmFsc2UgfHwgISEoCiAgICB0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYKICAgIHR5cGVvZiBwcm9jZXNzLmV4ZWNQYXRoID09PSAic3RyaW5nIiAmJgogICAgdHlwZW9mIHByb2Nlc3MuZW52ID09PSAib2JqZWN0IiAmJgogICAgKHByb2Nlc3MuZW52WyJCTFVFQklSRF9ERUJVRyJdIHx8CiAgICAgICAgcHJvY2Vzcy5lbnZbIk5PREVfRU5WIl0gPT09ICJkZXZlbG9wbWVudCIpCik7CgoKUHJvbWlzZS5sb25nU3RhY2tUcmFjZXMgPSBmdW5jdGlvbiBQcm9taXNlJExvbmdTdGFja1RyYWNlcygpIHsKICAgIGlmIChhc3luYy5oYXZlSXRlbXNRdWV1ZWQoKSAmJgogICAgICAgIGRlYnVnZ2luZyA9PT0gZmFsc2UKICAgKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgZW5hYmxlIGxvbmcgc3RhY2sgdHJhY2VzIGFmdGVyIHByb21pc2VzIGhhdmUgYmVlbiBjcmVhdGVkIik7CiAgICB9CiAgICBkZWJ1Z2dpbmcgPSBDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCk7Cn07CgpQcm9taXNlLmhhc0xvbmdTdGFja1RyYWNlcyA9IGZ1bmN0aW9uIFByb21pc2UkSGFzTG9uZ1N0YWNrVHJhY2VzKCkgewogICAgcmV0dXJuIGRlYnVnZ2luZyAmJiBDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdGhlbiA9CmZ1bmN0aW9uIFByb21pc2UkX3RoZW4oCiAgICBkaWRGdWxmaWxsLAogICAgZGlkUmVqZWN0LAogICAgZGlkUHJvZ3Jlc3MsCiAgICByZWNlaXZlciwKICAgIGludGVybmFsRGF0YQopIHsKICAgIHZhciBoYXZlSW50ZXJuYWxEYXRhID0gaW50ZXJuYWxEYXRhICE9PSB2b2lkIDA7CiAgICB2YXIgcmV0ID0gaGF2ZUludGVybmFsRGF0YSA/IGludGVybmFsRGF0YSA6IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKCiAgICBpZiAoIWhhdmVJbnRlcm5hbERhdGEpIHsKICAgICAgICBpZiAoZGVidWdnaW5nKSB7CiAgICAgICAgICAgIHZhciBoYXZlU2FtZUNvbnRleHQgPSB0aGlzLl9wZWVrQ29udGV4dCgpID09PSB0aGlzLl90cmFjZVBhcmVudDsKICAgICAgICAgICAgcmV0Ll90cmFjZVBhcmVudCA9IGhhdmVTYW1lQ29udGV4dCA/IHRoaXMuX3RyYWNlUGFyZW50IDogdGhpczsKICAgICAgICB9CiAgICAgICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHRoaXMsIDcpOwogICAgfQoKICAgIHZhciBjYWxsYmFja0luZGV4ID0KICAgICAgICB0aGlzLl9hZGRDYWxsYmFja3MoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcywgcmV0LCByZWNlaXZlcik7CgogICAgaWYgKHRoaXMuaXNSZXNvbHZlZCgpKSB7CiAgICAgICAgYXN5bmMuaW52b2tlKHRoaXMuX3F1ZXVlU2V0dGxlQXQsIHRoaXMsIGNhbGxiYWNrSW5kZXgpOwogICAgfQoKICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fbGVuZ3RoID0gZnVuY3Rpb24gUHJvbWlzZSRfbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2JpdEZpZWxkICYgMjYyMTQzOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkID0KZnVuY3Rpb24gUHJvbWlzZSRfaXNGb2xsb3dpbmdPckZ1bGZpbGxlZE9yUmVqZWN0ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgOTM5NTI0MDk2KSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNGb2xsb3dpbmcgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0ZvbGxvd2luZygpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA1MzY4NzA5MTIpID09PSA1MzY4NzA5MTI7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0TGVuZ3RoID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0TGVuZ3RoKGxlbikgewogICAgdGhpcy5fYml0RmllbGQgPSAodGhpcy5fYml0RmllbGQgJiAtMjYyMTQ0KSB8CiAgICAgICAgKGxlbiAmIDI2MjE0Myk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0RnVsZmlsbGVkID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0RnVsZmlsbGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDI2ODQzNTQ1NjsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRSZWplY3RlZCA9IGZ1bmN0aW9uIFByb21pc2UkX3NldFJlamVjdGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDEzNDIxNzcyODsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRGb2xsb3dpbmcgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRGb2xsb3dpbmcoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNTM2ODcwOTEyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldElzRmluYWwgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRJc0ZpbmFsKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDMzNTU0NDMyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzRmluYWwgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0ZpbmFsKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDMzNTU0NDMyKSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsbGFibGUgPSBmdW5jdGlvbiBQcm9taXNlJF9jYW5jZWxsYWJsZSgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA2NzEwODg2NCkgPiAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldENhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0Q2FuY2VsbGFibGUoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNjcxMDg4NjQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdW5zZXRDYW5jZWxsYWJsZSA9IGZ1bmN0aW9uIFByb21pc2UkX3Vuc2V0Q2FuY2VsbGFibGUoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkICYgKH42NzEwODg2NCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpIHsKICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCAyMDk3MTUyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+MjA5NzE1Mik7CiAgICBpZiAodGhpcy5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCgpKSB7CiAgICAgICAgdGhpcy5fdW5zZXRVbmhhbmRsZWRSZWplY3Rpb25Jc05vdGlmaWVkKCk7CiAgICAgICAgdGhpcy5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uSXNIYW5kbGVkKCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNSZWplY3Rpb25VbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9pc1JlamVjdGlvblVuaGFuZGxlZCgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiAyMDk3MTUyKSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX3NldFVuaGFuZGxlZFJlamVjdGlvbklzTm90aWZpZWQoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNTI0Mjg4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX3Vuc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCgpIHsKICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjUyNDI4OCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX2lzVW5oYW5kbGVkUmVqZWN0aW9uTm90aWZpZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNTI0Mjg4KSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0Q2FycmllZFN0YWNrVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRDYXJyaWVkU3RhY2tUcmFjZShjYXB0dXJlZFRyYWNlKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgMTA0ODU3NjsKICAgIHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjAgPSBjYXB0dXJlZFRyYWNlOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0Q2FycmllZFN0YWNrVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF91bnNldENhcnJpZWRTdGFja1RyYWNlKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+MTA0ODU3Nik7CiAgICB0aGlzLl9mdWxmaWxsbWVudEhhbmRsZXIwID0gdm9pZCAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzQ2FycnlpbmdTdGFja1RyYWNlID0KZnVuY3Rpb24gUHJvbWlzZSRfaXNDYXJyeWluZ1N0YWNrVHJhY2UoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTA0ODU3NikgPiAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2dldENhcnJpZWRTdGFja1RyYWNlID0KZnVuY3Rpb24gUHJvbWlzZSRfZ2V0Q2FycmllZFN0YWNrVHJhY2UoKSB7CiAgICByZXR1cm4gdGhpcy5faXNDYXJyeWluZ1N0YWNrVHJhY2UoKQogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMAogICAgICAgIDogdm9pZCAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlY2VpdmVyQXQgPSBmdW5jdGlvbiBQcm9taXNlJF9yZWNlaXZlckF0KGluZGV4KSB7CiAgICB2YXIgcmV0ID0gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3JlY2VpdmVyMAogICAgICAgIDogdGhpc1soaW5kZXggPDwgMikgKyBpbmRleCAtIDUgKyA0XTsKICAgIGlmICh0aGlzLl9pc0JvdW5kKCkgJiYgcmV0ID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gdGhpcy5fYm91bmRUbzsKICAgIH0KICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHJvbWlzZUF0ID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJvbWlzZUF0KGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3Byb21pc2UwCiAgICAgICAgOiB0aGlzWyhpbmRleCA8PCAyKSArIGluZGV4IC0gNSArIDNdOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Z1bGZpbGxtZW50SGFuZGxlckF0ID0KZnVuY3Rpb24gUHJvbWlzZSRfZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpIHsKICAgIHJldHVybiBpbmRleCA9PT0gMAogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMAogICAgICAgIDogdGhpc1soaW5kZXggPDwgMikgKyBpbmRleCAtIDUgKyAwXTsKfTsKClByb21pc2UucHJvdG90eXBlLl9yZWplY3Rpb25IYW5kbGVyQXQgPQpmdW5jdGlvbiBQcm9taXNlJF9yZWplY3Rpb25IYW5kbGVyQXQoaW5kZXgpIHsKICAgIHJldHVybiBpbmRleCA9PT0gMAogICAgICAgID8gdGhpcy5fcmVqZWN0aW9uSGFuZGxlcjAKICAgICAgICA6IHRoaXNbKGluZGV4IDw8IDIpICsgaW5kZXggLSA1ICsgMV07Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fYWRkQ2FsbGJhY2tzID0gZnVuY3Rpb24gUHJvbWlzZSRfYWRkQ2FsbGJhY2tzKAogICAgZnVsZmlsbCwKICAgIHJlamVjdCwKICAgIHByb2dyZXNzLAogICAgcHJvbWlzZSwKICAgIHJlY2VpdmVyCikgewogICAgdmFyIGluZGV4ID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKGluZGV4ID49IDI2MjE0MyAtIDUpIHsKICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgdGhpcy5fc2V0TGVuZ3RoKDApOwogICAgfQoKICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgIHRoaXMuX3Byb21pc2UwID0gcHJvbWlzZTsKICAgICAgICBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgdGhpcy5fcmVjZWl2ZXIwID0gcmVjZWl2ZXI7CiAgICAgICAgaWYgKHR5cGVvZiBmdWxmaWxsID09PSAiZnVuY3Rpb24iICYmICF0aGlzLl9pc0NhcnJ5aW5nU3RhY2tUcmFjZSgpKQogICAgICAgICAgICB0aGlzLl9mdWxmaWxsbWVudEhhbmRsZXIwID0gZnVsZmlsbDsKICAgICAgICBpZiAodHlwZW9mIHJlamVjdCA9PT0gImZ1bmN0aW9uIikgdGhpcy5fcmVqZWN0aW9uSGFuZGxlcjAgPSByZWplY3Q7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9ncmVzcyA9PT0gImZ1bmN0aW9uIikgdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyMCA9IHByb2dyZXNzOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgYmFzZSA9IChpbmRleCA8PCAyKSArIGluZGV4IC0gNTsKICAgICAgICB0aGlzW2Jhc2UgKyAzXSA9IHByb21pc2U7CiAgICAgICAgdGhpc1tiYXNlICsgNF0gPSByZWNlaXZlcjsKICAgICAgICB0aGlzW2Jhc2UgKyAwXSA9IHR5cGVvZiBmdWxmaWxsID09PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBmdWxmaWxsIDogdm9pZCAwOwogICAgICAgIHRoaXNbYmFzZSArIDFdID0gdHlwZW9mIHJlamVjdCA9PT0gImZ1bmN0aW9uIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gcmVqZWN0IDogdm9pZCAwOwogICAgICAgIHRoaXNbYmFzZSArIDJdID0gdHlwZW9mIHByb2dyZXNzID09PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwcm9ncmVzcyA6IHZvaWQgMDsKICAgIH0KICAgIHRoaXMuX3NldExlbmd0aChpbmRleCArIDEpOwogICAgcmV0dXJuIGluZGV4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldFByb3h5SGFuZGxlcnMgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRQcm94eUhhbmRsZXJzKHJlY2VpdmVyLCBwcm9taXNlU2xvdFZhbHVlKSB7CiAgICB2YXIgaW5kZXggPSB0aGlzLl9sZW5ndGgoKTsKCiAgICBpZiAoaW5kZXggPj0gMjYyMTQzIC0gNSkgewogICAgICAgIGluZGV4ID0gMDsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoMCk7CiAgICB9CiAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICB0aGlzLl9wcm9taXNlMCA9IHByb21pc2VTbG90VmFsdWU7CiAgICAgICAgdGhpcy5fcmVjZWl2ZXIwID0gcmVjZWl2ZXI7CiAgICB9IGVsc2UgewogICAgICAgIHZhciBiYXNlID0gKGluZGV4IDw8IDIpICsgaW5kZXggLSA1OwogICAgICAgIHRoaXNbYmFzZSArIDNdID0gcHJvbWlzZVNsb3RWYWx1ZTsKICAgICAgICB0aGlzW2Jhc2UgKyA0XSA9IHJlY2VpdmVyOwogICAgICAgIHRoaXNbYmFzZSArIDBdID0KICAgICAgICB0aGlzW2Jhc2UgKyAxXSA9CiAgICAgICAgdGhpc1tiYXNlICsgMl0gPSB2b2lkIDA7CiAgICB9CiAgICB0aGlzLl9zZXRMZW5ndGgoaW5kZXggKyAxKTsKfTsKClByb21pc2UucHJvdG90eXBlLl9wcm94eVByb21pc2VBcnJheSA9CmZ1bmN0aW9uIFByb21pc2UkX3Byb3h5UHJvbWlzZUFycmF5KHByb21pc2VBcnJheSwgaW5kZXgpIHsKICAgIHRoaXMuX3NldFByb3h5SGFuZGxlcnMocHJvbWlzZUFycmF5LCBpbmRleCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHJveHlQcm9taXNlID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJveHlQcm9taXNlKHByb21pc2UpIHsKICAgIHByb21pc2UuX3NldFByb3hpZWQoKTsKICAgIHRoaXMuX3NldFByb3h5SGFuZGxlcnMocHJvbWlzZSwgLTE1KTsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRCb3VuZFRvID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0Qm91bmRUbyhvYmopIHsKICAgIGlmIChvYmogIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCA4Mzg4NjA4OwogICAgICAgIHRoaXMuX2JvdW5kVG8gPSBvYmo7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjgzODg2MDgpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzQm91bmQgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0JvdW5kKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDgzODg2MDgpID09PSA4Mzg4NjA4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Jlc29sdmVGcm9tUmVzb2x2ZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVJlc29sdmVyKHJlc29sdmVyKSB7CiAgICB2YXIgcHJvbWlzZSA9IHRoaXM7CiAgICB0aGlzLl9zZXRUcmFjZSh2b2lkIDApOwogICAgdGhpcy5fcHVzaENvbnRleHQoKTsKCiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlcih2YWwpIHsKICAgICAgICBpZiAocHJvbWlzZS5fdHJ5Rm9sbG93KHZhbCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwcm9taXNlLl9mdWxmaWxsKHZhbCk7CiAgICB9CiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZWplY3Rlcih2YWwpIHsKICAgICAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2godmFsKSA/IHZhbCA6IG5ldyBFcnJvcih2YWwgKyAiIik7CiAgICAgICAgcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKHZhbCk7CiAgICAgICAgcHJvbWlzZS5fcmVqZWN0KHZhbCwgdHJhY2UgPT09IHZhbCA/IHZvaWQgMCA6IHRyYWNlKTsKICAgIH0KICAgIHZhciByID0gdHJ5Q2F0Y2gyKHJlc29sdmVyLCB2b2lkIDAsIFByb21pc2UkX3Jlc29sdmVyLCBQcm9taXNlJF9yZWplY3Rlcik7CiAgICB0aGlzLl9wb3BDb250ZXh0KCk7CgogICAgaWYgKHIgIT09IHZvaWQgMCAmJiByID09PSBlcnJvck9iaikgewogICAgICAgIHZhciBlID0gci5lOwogICAgICAgIHZhciB0cmFjZSA9IGNhbkF0dGFjaChlKSA/IGUgOiBuZXcgRXJyb3IoZSArICIiKTsKICAgICAgICBwcm9taXNlLl9yZWplY3QoZSwgdHJhY2UpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NwcmVhZFNsb3dDYXNlID0KZnVuY3Rpb24gUHJvbWlzZSRfc3ByZWFkU2xvd0Nhc2UodGFyZ2V0Rm4sIHByb21pc2UsIHZhbHVlcywgYm91bmRUbykgewogICAgdmFyIHByb21pc2VGb3JBbGwgPSBuZXcgUHJvbWlzZUFycmF5KHZhbHVlcykucHJvbWlzZSgpOwogICAgdmFyIHByb21pc2UyID0gcHJvbWlzZUZvckFsbC5fdGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGFyZ2V0Rm4uYXBwbHkoYm91bmRUbywgYXJndW1lbnRzKTsKICAgIH0sIHZvaWQgMCwgdm9pZCAwLCBBUFBMWSwgdm9pZCAwKTsKICAgIHByb21pc2UuX2ZvbGxvdyhwcm9taXNlMik7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FsbFNwcmVhZCA9CmZ1bmN0aW9uIFByb21pc2UkX2NhbGxTcHJlYWQoaGFuZGxlciwgcHJvbWlzZSwgdmFsdWUpIHsKICAgIHZhciBib3VuZFRvID0gdGhpcy5fYm91bmRUbzsKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgICBpZiAoY2FzdCh2YWx1ZVtpXSwgdm9pZCAwKSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NwcmVhZFNsb3dDYXNlKGhhbmRsZXIsIHByb21pc2UsIHZhbHVlLCBib3VuZFRvKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHByb21pc2UuX3B1c2hDb250ZXh0KCk7CiAgICByZXR1cm4gdHJ5Q2F0Y2hBcHBseShoYW5kbGVyLCB2YWx1ZSwgYm91bmRUbyk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FsbEhhbmRsZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9jYWxsSGFuZGxlcigKICAgIGhhbmRsZXIsIHJlY2VpdmVyLCBwcm9taXNlLCB2YWx1ZSkgewogICAgdmFyIHg7CiAgICBpZiAocmVjZWl2ZXIgPT09IEFQUExZICYmICF0aGlzLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIHggPSB0aGlzLl9jYWxsU3ByZWFkKGhhbmRsZXIsIHByb21pc2UsIHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZS5fcHVzaENvbnRleHQoKTsKICAgICAgICB4ID0gdHJ5Q2F0Y2gxKGhhbmRsZXIsIHJlY2VpdmVyLCB2YWx1ZSk7CiAgICB9CiAgICBwcm9taXNlLl9wb3BDb250ZXh0KCk7CiAgICByZXR1cm4geDsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXR0bGVQcm9taXNlRnJvbUhhbmRsZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXR0bGVQcm9taXNlRnJvbUhhbmRsZXIoCiAgICBoYW5kbGVyLCByZWNlaXZlciwgdmFsdWUsIHByb21pc2UKKSB7CiAgICBpZiAoIShwcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkpIHsKICAgICAgICBoYW5kbGVyLmNhbGwocmVjZWl2ZXIsIHZhbHVlLCBwcm9taXNlKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJvbWlzZS5pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciB4ID0gdGhpcy5fY2FsbEhhbmRsZXIoaGFuZGxlciwgcmVjZWl2ZXIsIHByb21pc2UsIHZhbHVlKTsKICAgIGlmIChwcm9taXNlLl9pc0ZvbGxvd2luZygpKSByZXR1cm47CgogICAgaWYgKHggPT09IGVycm9yT2JqIHx8IHggPT09IHByb21pc2UgfHwgeCA9PT0gTkVYVF9GSUxURVIpIHsKICAgICAgICB2YXIgZXJyID0geCA9PT0gcHJvbWlzZQogICAgICAgICAgICAgICAgICAgID8gbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IoKQogICAgICAgICAgICAgICAgICAgIDogeC5lOwogICAgICAgIHZhciB0cmFjZSA9IGNhbkF0dGFjaChlcnIpID8gZXJyIDogbmV3IEVycm9yKGVyciArICIiKTsKICAgICAgICBpZiAoeCAhPT0gTkVYVF9GSUxURVIpIHByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UodHJhY2UpOwogICAgICAgIHByb21pc2UuX3JlamVjdFVuY2hlY2tlZChlcnIsIHRyYWNlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNhc3RWYWx1ZSA9IGNhc3QoeCwgcHJvbWlzZSk7CiAgICAgICAgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgaWYgKGNhc3RWYWx1ZS5pc1JlamVjdGVkKCkgJiYKICAgICAgICAgICAgICAgICFjYXN0VmFsdWUuX2lzQ2FycnlpbmdTdGFja1RyYWNlKCkgJiYKICAgICAgICAgICAgICAgICFjYW5BdHRhY2goY2FzdFZhbHVlLl9zZXR0bGVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJhY2UgPSBuZXcgRXJyb3IoY2FzdFZhbHVlLl9zZXR0bGVkVmFsdWUgKyAiIik7CiAgICAgICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgICAgICAgICAgICAgIGNhc3RWYWx1ZS5fc2V0Q2FycmllZFN0YWNrVHJhY2UodHJhY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb21pc2UuX2ZvbGxvdyhjYXN0VmFsdWUpOwogICAgICAgICAgICBwcm9taXNlLl9wcm9wYWdhdGVGcm9tKGNhc3RWYWx1ZSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvbWlzZS5fZnVsZmlsbFVuY2hlY2tlZCh4KTsKICAgICAgICB9CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZm9sbG93ID0KZnVuY3Rpb24gUHJvbWlzZSRfZm9sbG93KHByb21pc2UpIHsKICAgIHRoaXMuX3NldEZvbGxvd2luZygpOwoKICAgIGlmIChwcm9taXNlLmlzUGVuZGluZygpKSB7CiAgICAgICAgdGhpcy5fcHJvcGFnYXRlRnJvbShwcm9taXNlLCAxKTsKICAgICAgICBwcm9taXNlLl9wcm94eVByb21pc2UodGhpcyk7CiAgICB9IGVsc2UgaWYgKHByb21pc2UuaXNGdWxmaWxsZWQoKSkgewogICAgICAgIHRoaXMuX2Z1bGZpbGxVbmNoZWNrZWQocHJvbWlzZS5fc2V0dGxlZFZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcmVqZWN0VW5jaGVja2VkKHByb21pc2UuX3NldHRsZWRWYWx1ZSwKICAgICAgICAgICAgcHJvbWlzZS5fZ2V0Q2FycmllZFN0YWNrVHJhY2UoKSk7CiAgICB9CgogICAgaWYgKHByb21pc2UuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKCiAgICBpZiAoZGVidWdnaW5nICYmCiAgICAgICAgcHJvbWlzZS5fdHJhY2VQYXJlbnQgPT0gbnVsbCkgewogICAgICAgIHByb21pc2UuX3RyYWNlUGFyZW50ID0gdGhpczsKICAgIH0KfTsKClByb21pc2UucHJvdG90eXBlLl90cnlGb2xsb3cgPQpmdW5jdGlvbiBQcm9taXNlJF90cnlGb2xsb3codmFsdWUpIHsKICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpIHx8CiAgICAgICAgdmFsdWUgPT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgIGlmICghKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fZm9sbG93KG1heWJlUHJvbWlzZSk7CiAgICByZXR1cm4gdHJ1ZTsKfTsKClByb21pc2UucHJvdG90eXBlLl9yZXNldFRyYWNlID0gZnVuY3Rpb24gUHJvbWlzZSRfcmVzZXRUcmFjZSgpIHsKICAgIGlmIChkZWJ1Z2dpbmcpIHsKICAgICAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKHRoaXMuX3BlZWtDb250ZXh0KCkgPT09IHZvaWQgMCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0VHJhY2UgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRUcmFjZShwYXJlbnQpIHsKICAgIGlmIChkZWJ1Z2dpbmcpIHsKICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuX3BlZWtDb250ZXh0KCk7CiAgICAgICAgdGhpcy5fdHJhY2VQYXJlbnQgPSBjb250ZXh0OwogICAgICAgIHZhciBpc1RvcExldmVsID0gY29udGV4dCA9PT0gdm9pZCAwOwogICAgICAgIGlmIChwYXJlbnQgIT09IHZvaWQgMCAmJgogICAgICAgICAgICBwYXJlbnQuX3RyYWNlUGFyZW50ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIHRoaXMuX3RyYWNlID0gcGFyZW50Ll90cmFjZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKGlzVG9wTGV2ZWwpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3RyeUF0dGFjaEV4dHJhVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF90cnlBdHRhY2hFeHRyYVRyYWNlKGVycm9yKSB7CiAgICBpZiAoY2FuQXR0YWNoKGVycm9yKSkgewogICAgICAgIHRoaXMuX2F0dGFjaEV4dHJhVHJhY2UoZXJyb3IpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2F0dGFjaEV4dHJhVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF9hdHRhY2hFeHRyYVRyYWNlKGVycm9yKSB7CiAgICBpZiAoZGVidWdnaW5nKSB7CiAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzOwogICAgICAgIHZhciBzdGFjayA9IGVycm9yLnN0YWNrOwogICAgICAgIHN0YWNrID0gdHlwZW9mIHN0YWNrID09PSAic3RyaW5nIiA/IHN0YWNrLnNwbGl0KCJcbiIpIDogW107CiAgICAgICAgQ2FwdHVyZWRUcmFjZS5wcm90ZWN0RXJyb3JNZXNzYWdlTmV3bGluZXMoc3RhY2spOwogICAgICAgIHZhciBoZWFkZXJMaW5lQ291bnQgPSAxOwogICAgICAgIHZhciBjb21iaW5lZFRyYWNlcyA9IDE7CiAgICAgICAgd2hpbGUocHJvbWlzZSAhPSBudWxsICYmCiAgICAgICAgICAgIHByb21pc2UuX3RyYWNlICE9IG51bGwpIHsKICAgICAgICAgICAgc3RhY2sgPSBDYXB0dXJlZFRyYWNlLmNvbWJpbmUoCiAgICAgICAgICAgICAgICBzdGFjaywKICAgICAgICAgICAgICAgIHByb21pc2UuX3RyYWNlLnN0YWNrLnNwbGl0KCJcbiIpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLl90cmFjZVBhcmVudDsKICAgICAgICAgICAgY29tYmluZWRUcmFjZXMrKzsKICAgICAgICB9CgogICAgICAgIHZhciBzdGFja1RyYWNlTGltaXQgPSBFcnJvci5zdGFja1RyYWNlTGltaXQgfHwgMTA7CiAgICAgICAgdmFyIG1heCA9IChzdGFja1RyYWNlTGltaXQgKyBoZWFkZXJMaW5lQ291bnQpICogY29tYmluZWRUcmFjZXM7CiAgICAgICAgdmFyIGxlbiA9IHN0YWNrLmxlbmd0aDsKICAgICAgICBpZiAobGVuID4gbWF4KSB7CiAgICAgICAgICAgIHN0YWNrLmxlbmd0aCA9IG1heDsKICAgICAgICB9CgogICAgICAgIGlmIChsZW4gPiAwKQogICAgICAgICAgICBzdGFja1swXSA9IHN0YWNrWzBdLnNwbGl0KCJcdTAwMDJcdTAwMDBcdTAwMDEiKS5qb2luKCJcbiIpOwoKICAgICAgICBpZiAoc3RhY2subGVuZ3RoIDw9IGhlYWRlckxpbmVDb3VudCkgewogICAgICAgICAgICBlcnJvci5zdGFjayA9ICIoTm8gc3RhY2sgdHJhY2UpIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlcnJvci5zdGFjayA9IHN0YWNrLmpvaW4oIlxuIik7CiAgICAgICAgfQogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2NsZWFuVmFsdWVzID0gZnVuY3Rpb24gUHJvbWlzZSRfY2xlYW5WYWx1ZXMoKSB7CiAgICBpZiAodGhpcy5fY2FuY2VsbGFibGUoKSkgewogICAgICAgIHRoaXMuX2NhbmNlbGxhdGlvblBhcmVudCA9IHZvaWQgMDsKICAgIH0KfTsKClByb21pc2UucHJvdG90eXBlLl9wcm9wYWdhdGVGcm9tID0KZnVuY3Rpb24gUHJvbWlzZSRfcHJvcGFnYXRlRnJvbShwYXJlbnQsIGZsYWdzKSB7CiAgICBpZiAoKGZsYWdzICYgMSkgPiAwICYmIHBhcmVudC5fY2FuY2VsbGFibGUoKSkgewogICAgICAgIHRoaXMuX3NldENhbmNlbGxhYmxlKCk7CiAgICAgICAgdGhpcy5fY2FuY2VsbGF0aW9uUGFyZW50ID0gcGFyZW50OwogICAgfQogICAgaWYgKChmbGFncyAmIDQpID4gMCkgewogICAgICAgIHRoaXMuX3NldEJvdW5kVG8ocGFyZW50Ll9ib3VuZFRvKTsKICAgIH0KICAgIGlmICgoZmxhZ3MgJiAyKSA+IDApIHsKICAgICAgICB0aGlzLl9zZXRUcmFjZShwYXJlbnQpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Z1bGZpbGwgPSBmdW5jdGlvbiBQcm9taXNlJF9mdWxmaWxsKHZhbHVlKSB7CiAgICBpZiAodGhpcy5faXNGb2xsb3dpbmdPckZ1bGZpbGxlZE9yUmVqZWN0ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fZnVsZmlsbFVuY2hlY2tlZCh2YWx1ZSk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVqZWN0ID0KZnVuY3Rpb24gUHJvbWlzZSRfcmVqZWN0KHJlYXNvbiwgY2FycmllZFN0YWNrVHJhY2UpIHsKICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpKSByZXR1cm47CiAgICB0aGlzLl9yZWplY3RVbmNoZWNrZWQocmVhc29uLCBjYXJyaWVkU3RhY2tUcmFjZSk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0dGxlUHJvbWlzZUF0ID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0dGxlUHJvbWlzZUF0KGluZGV4KSB7CiAgICB2YXIgaGFuZGxlciA9IHRoaXMuaXNGdWxmaWxsZWQoKQogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpCiAgICAgICAgOiB0aGlzLl9yZWplY3Rpb25IYW5kbGVyQXQoaW5kZXgpOwoKICAgIHZhciB2YWx1ZSA9IHRoaXMuX3NldHRsZWRWYWx1ZTsKICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3JlY2VpdmVyQXQoaW5kZXgpOwogICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlQXQoaW5kZXgpOwoKICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX3NldHRsZVByb21pc2VGcm9tSGFuZGxlcihoYW5kbGVyLCByZWNlaXZlciwgdmFsdWUsIHByb21pc2UpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgZG9uZSA9IGZhbHNlOwogICAgICAgIHZhciBpc0Z1bGZpbGxlZCA9IHRoaXMuaXNGdWxmaWxsZWQoKTsKICAgICAgICBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAocmVjZWl2ZXIgaW5zdGFuY2VvZiBQcm9taXNlICYmCiAgICAgICAgICAgICAgICByZWNlaXZlci5faXNQcm94aWVkKCkpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVyLl91bnNldFByb3hpZWQoKTsKCiAgICAgICAgICAgICAgICBpZiAoaXNGdWxmaWxsZWQpIHJlY2VpdmVyLl9mdWxmaWxsVW5jaGVja2VkKHZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgcmVjZWl2ZXIuX3JlamVjdFVuY2hlY2tlZCh2YWx1ZSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSgpKTsKICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlY2VpdmVyIGluc3RhbmNlb2YgUHJvbWlzZUFycmF5KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNGdWxmaWxsZWQpIHJlY2VpdmVyLl9wcm9taXNlRnVsZmlsbGVkKHZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgIGVsc2UgcmVjZWl2ZXIuX3Byb21pc2VSZWplY3RlZCh2YWx1ZSwgcHJvbWlzZSk7CiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFkb25lKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bGZpbGxlZCkgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgICAgIGVsc2UgcHJvbWlzZS5fcmVqZWN0KHZhbHVlLCB0aGlzLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGluZGV4ID49IDQpIHsKICAgICAgICB0aGlzLl9xdWV1ZUdDKCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNQcm94aWVkID0gZnVuY3Rpb24gUHJvbWlzZSRfaXNQcm94aWVkKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDQxOTQzMDQpID09PSA0MTk0MzA0Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldFByb3hpZWQgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRQcm94aWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDQxOTQzMDQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdW5zZXRQcm94aWVkID0gZnVuY3Rpb24gUHJvbWlzZSRfdW5zZXRQcm94aWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+NDE5NDMwNCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNHY1F1ZXVlZCA9IGZ1bmN0aW9uIFByb21pc2UkX2lzR2NRdWV1ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgLTEwNzM3NDE4MjQpID09PSAtMTA3Mzc0MTgyNDsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRHY1F1ZXVlZCA9IGZ1bmN0aW9uIFByb21pc2UkX3NldEdjUXVldWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IC0xMDczNzQxODI0Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0R2NRdWV1ZWQgPSBmdW5jdGlvbiBQcm9taXNlJF91bnNldEdjUXVldWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+LTEwNzM3NDE4MjQpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3F1ZXVlR0MgPSBmdW5jdGlvbiBQcm9taXNlJF9xdWV1ZUdDKCkgewogICAgaWYgKHRoaXMuX2lzR2NRdWV1ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fc2V0R2NRdWV1ZWQoKTsKICAgIGFzeW5jLmludm9rZUxhdGVyKHRoaXMuX2djLCB0aGlzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2djID0gZnVuY3Rpb24gUHJvbWlzZSRnYygpIHsKICAgIHZhciBsZW4gPSB0aGlzLl9sZW5ndGgoKSAqIDUgLSA1OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGRlbGV0ZSB0aGlzW2ldOwogICAgfQogICAgdGhpcy5fY2xlYXJGaXJzdEhhbmRsZXJEYXRhKCk7CiAgICB0aGlzLl9zZXRMZW5ndGgoMCk7CiAgICB0aGlzLl91bnNldEdjUXVldWVkKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2xlYXJGaXJzdEhhbmRsZXJEYXRhID0KZnVuY3Rpb24gUHJvbWlzZSRfY2xlYXJGaXJzdEhhbmRsZXJEYXRhKCkgewogICAgdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IHZvaWQgMDsKICAgIHRoaXMuX3JlamVjdGlvbkhhbmRsZXIwID0gdm9pZCAwOwogICAgdGhpcy5fcHJvbWlzZTAgPSB2b2lkIDA7CiAgICB0aGlzLl9yZWNlaXZlcjAgPSB2b2lkIDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcXVldWVTZXR0bGVBdCA9IGZ1bmN0aW9uIFByb21pc2UkX3F1ZXVlU2V0dGxlQXQoaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1JlamVjdGlvblVuaGFuZGxlZCgpKSB0aGlzLl91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICBhc3luYy5pbnZva2UodGhpcy5fc2V0dGxlUHJvbWlzZUF0LCB0aGlzLCBpbmRleCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZnVsZmlsbFVuY2hlY2tlZCA9CmZ1bmN0aW9uIFByb21pc2UkX2Z1bGZpbGxVbmNoZWNrZWQodmFsdWUpIHsKICAgIGlmICghdGhpcy5pc1BlbmRpbmcoKSkgcmV0dXJuOwogICAgaWYgKHZhbHVlID09PSB0aGlzKSB7CiAgICAgICAgdmFyIGVyciA9IG1ha2VTZWxmUmVzb2x1dGlvbkVycm9yKCk7CiAgICAgICAgdGhpcy5fYXR0YWNoRXh0cmFUcmFjZShlcnIpOwogICAgICAgIHJldHVybiB0aGlzLl9yZWplY3RVbmNoZWNrZWQoZXJyLCB2b2lkIDApOwogICAgfQogICAgdGhpcy5fY2xlYW5WYWx1ZXMoKTsKICAgIHRoaXMuX3NldEZ1bGZpbGxlZCgpOwogICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKGxlbiA+IDApIHsKICAgICAgICBhc3luYy5pbnZva2UodGhpcy5fc2V0dGxlUHJvbWlzZXMsIHRoaXMsIGxlbik7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVqZWN0VW5jaGVja2VkQ2hlY2tFcnJvciA9CmZ1bmN0aW9uIFByb21pc2UkX3JlamVjdFVuY2hlY2tlZENoZWNrRXJyb3IocmVhc29uKSB7CiAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICB0aGlzLl9yZWplY3RVbmNoZWNrZWQocmVhc29uLCB0cmFjZSA9PT0gcmVhc29uID8gdm9pZCAwIDogdHJhY2UpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdFVuY2hlY2tlZCA9CmZ1bmN0aW9uIFByb21pc2UkX3JlamVjdFVuY2hlY2tlZChyZWFzb24sIHRyYWNlKSB7CiAgICBpZiAoIXRoaXMuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIGlmIChyZWFzb24gPT09IHRoaXMpIHsKICAgICAgICB2YXIgZXJyID0gbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IoKTsKICAgICAgICB0aGlzLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdFVuY2hlY2tlZChlcnIpOwogICAgfQogICAgdGhpcy5fY2xlYW5WYWx1ZXMoKTsKICAgIHRoaXMuX3NldFJlamVjdGVkKCk7CiAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSByZWFzb247CgogICAgaWYgKHRoaXMuX2lzRmluYWwoKSkgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgdHJhY2UgPT09IHZvaWQgMCA/IHJlYXNvbiA6IHRyYWNlKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKHRyYWNlICE9PSB2b2lkIDApIHRoaXMuX3NldENhcnJpZWRTdGFja1RyYWNlKHRyYWNlKTsKCiAgICBpZiAobGVuID4gMCkgewogICAgICAgIGFzeW5jLmludm9rZSh0aGlzLl9yZWplY3RQcm9taXNlcywgdGhpcywgbnVsbCk7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdFByb21pc2VzID0gZnVuY3Rpb24gUHJvbWlzZSRfcmVqZWN0UHJvbWlzZXMoKSB7CiAgICB0aGlzLl9zZXR0bGVQcm9taXNlcygpOwogICAgdGhpcy5fdW5zZXRDYXJyaWVkU3RhY2tUcmFjZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VzID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0dGxlUHJvbWlzZXMoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgdGhpcy5fc2V0dGxlUHJvbWlzZUF0KGkpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2UkX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpIHsKICAgIHRoaXMuX3NldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICBpZiAoQ2FwdHVyZWRUcmFjZS5wb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgYXN5bmMuaW52b2tlTGF0ZXIodGhpcy5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uLCB0aGlzLCB2b2lkIDApOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX25vdGlmeVVuaGFuZGxlZFJlamVjdGlvbklzSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2UkX25vdGlmeVVuaGFuZGxlZFJlamVjdGlvbklzSGFuZGxlZCgpIHsKICAgIGlmICh0eXBlb2YgdW5oYW5kbGVkUmVqZWN0aW9uSGFuZGxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHVuaGFuZGxlZFJlamVjdGlvbkhhbmRsZWQsIHZvaWQgMCwgdGhpcyk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gUHJvbWlzZSRfbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uKCkgewogICAgaWYgKHRoaXMuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHsKICAgICAgICB2YXIgcmVhc29uID0gdGhpcy5fc2V0dGxlZFZhbHVlOwogICAgICAgIHZhciB0cmFjZSA9IHRoaXMuX2dldENhcnJpZWRTdGFja1RyYWNlKCk7CgogICAgICAgIHRoaXMuX3NldFVuaGFuZGxlZFJlamVjdGlvbklzTm90aWZpZWQoKTsKCiAgICAgICAgaWYgKHRyYWNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdGhpcy5fdW5zZXRDYXJyaWVkU3RhY2tUcmFjZSgpOwogICAgICAgICAgICByZWFzb24gPSB0cmFjZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBDYXB0dXJlZFRyYWNlLnBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIENhcHR1cmVkVHJhY2UucG9zc2libHlVbmhhbmRsZWRSZWplY3Rpb24ocmVhc29uLCB0aGlzKTsKICAgICAgICB9CiAgICB9Cn07Cgp2YXIgY29udGV4dFN0YWNrID0gW107ClByb21pc2UucHJvdG90eXBlLl9wZWVrQ29udGV4dCA9IGZ1bmN0aW9uIFByb21pc2UkX3BlZWtDb250ZXh0KCkgewogICAgdmFyIGxhc3RJbmRleCA9IGNvbnRleHRTdGFjay5sZW5ndGggLSAxOwogICAgaWYgKGxhc3RJbmRleCA+PSAwKSB7CiAgICAgICAgcmV0dXJuIGNvbnRleHRTdGFja1tsYXN0SW5kZXhdOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKCn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHVzaENvbnRleHQgPSBmdW5jdGlvbiBQcm9taXNlJF9wdXNoQ29udGV4dCgpIHsKICAgIGlmICghZGVidWdnaW5nKSByZXR1cm47CiAgICBjb250ZXh0U3RhY2sucHVzaCh0aGlzKTsKfTsKClByb21pc2UucHJvdG90eXBlLl9wb3BDb250ZXh0ID0gZnVuY3Rpb24gUHJvbWlzZSRfcG9wQ29udGV4dCgpIHsKICAgIGlmICghZGVidWdnaW5nKSByZXR1cm47CiAgICBjb250ZXh0U3RhY2sucG9wKCk7Cn07CgpQcm9taXNlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiBQcm9taXNlJE5vQ29uZmxpY3QoKSB7CiAgICByZXR1cm4gbm9Db25mbGljdChQcm9taXNlKTsKfTsKClByb21pc2Uuc2V0U2NoZWR1bGVyID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgYXN5bmMuX3NjaGVkdWxlID0gZm47Cn07CgppZiAoIUNhcHR1cmVkVHJhY2UuaXNTdXBwb3J0ZWQoKSkgewogICAgUHJvbWlzZS5sb25nU3RhY2tUcmFjZXMgPSBmdW5jdGlvbigpe307CiAgICBkZWJ1Z2dpbmcgPSBmYWxzZTsKfQoKUHJvbWlzZS5fbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IgPSBtYWtlU2VsZlJlc29sdXRpb25FcnJvcjsKcmVxdWlyZSgiLi9maW5hbGx5LmpzIikoUHJvbWlzZSwgTkVYVF9GSUxURVIsIGNhc3QpOwpyZXF1aXJlKCIuL2RpcmVjdF9yZXNvbHZlLmpzIikoUHJvbWlzZSk7CnJlcXVpcmUoIi4vc3luY2hyb25vdXNfaW5zcGVjdGlvbi5qcyIpKFByb21pc2UpOwpyZXF1aXJlKCIuL2pvaW4uanMiKShQcm9taXNlLCBQcm9taXNlQXJyYXksIGNhc3QsIElOVEVSTkFMKTsKUHJvbWlzZS5SYW5nZUVycm9yID0gUmFuZ2VFcnJvcjsKUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciA9IENhbmNlbGxhdGlvbkVycm9yOwpQcm9taXNlLlRpbWVvdXRFcnJvciA9IFRpbWVvdXRFcnJvcjsKUHJvbWlzZS5UeXBlRXJyb3IgPSBUeXBlRXJyb3I7ClByb21pc2UuT3BlcmF0aW9uYWxFcnJvciA9IE9wZXJhdGlvbmFsRXJyb3I7ClByb21pc2UuUmVqZWN0aW9uRXJyb3IgPSBPcGVyYXRpb25hbEVycm9yOwpQcm9taXNlLkFnZ3JlZ2F0ZUVycm9yID0gZXJyb3JzLkFnZ3JlZ2F0ZUVycm9yOwoKdXRpbC50b0Zhc3RQcm9wZXJ0aWVzKFByb21pc2UpOwp1dGlsLnRvRmFzdFByb3BlcnRpZXMoUHJvbWlzZS5wcm90b3R5cGUpOwpQcm9taXNlLlByb21pc2UgPSBQcm9taXNlOwpyZXF1aXJlKCcuL3RpbWVycy5qcycpKFByb21pc2UsSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vcmFjZS5qcycpKFByb21pc2UsSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vY2FsbF9nZXQuanMnKShQcm9taXNlKTsKcmVxdWlyZSgnLi9nZW5lcmF0b3JzLmpzJykoUHJvbWlzZSxhcGlSZWplY3Rpb24sSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vbWFwLmpzJykoUHJvbWlzZSxQcm9taXNlQXJyYXksYXBpUmVqZWN0aW9uLGNhc3QsSU5URVJOQUwpOwpyZXF1aXJlKCcuL25vZGVpZnkuanMnKShQcm9taXNlKTsKcmVxdWlyZSgnLi9wcm9taXNpZnkuanMnKShQcm9taXNlLElOVEVSTkFMKTsKcmVxdWlyZSgnLi9wcm9wcy5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGNhc3QpOwpyZXF1aXJlKCcuL3JlZHVjZS5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGFwaVJlamVjdGlvbixjYXN0LElOVEVSTkFMKTsKcmVxdWlyZSgnLi9zZXR0bGUuanMnKShQcm9taXNlLFByb21pc2VBcnJheSk7CnJlcXVpcmUoJy4vc29tZS5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGFwaVJlamVjdGlvbik7CnJlcXVpcmUoJy4vcHJvZ3Jlc3MuanMnKShQcm9taXNlLFByb21pc2VBcnJheSk7CnJlcXVpcmUoJy4vY2FuY2VsLmpzJykoUHJvbWlzZSxJTlRFUk5BTCk7CnJlcXVpcmUoJy4vZmlsdGVyLmpzJykoUHJvbWlzZSxJTlRFUk5BTCk7CnJlcXVpcmUoJy4vYW55LmpzJykoUHJvbWlzZSxQcm9taXNlQXJyYXkpOwpyZXF1aXJlKCcuL2VhY2guanMnKShQcm9taXNlLElOVEVSTkFMKTsKcmVxdWlyZSgnLi91c2luZy5qcycpKFByb21pc2UsYXBpUmVqZWN0aW9uLGNhc3QpOwoKUHJvbWlzZS5wcm90b3R5cGUgPSBQcm9taXNlLnByb3RvdHlwZTsKcmV0dXJuIFByb21pc2U7Cgp9OwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2FueS5qcyI6MTcsIi4vYXN5bmMuanMiOjE4LCIuL2NhbGxfZ2V0LmpzIjoxOSwiLi9jYW5jZWwuanMiOjIwLCIuL2NhcHR1cmVkX3RyYWNlLmpzIjoyMSwiLi9jYXRjaF9maWx0ZXIuanMiOjIyLCIuL2RpcmVjdF9yZXNvbHZlLmpzIjoyMywiLi9lYWNoLmpzIjoyNCwiLi9lcnJvcnMuanMiOjI1LCIuL2Vycm9yc19hcGlfcmVqZWN0aW9uIjoyNiwiLi9maWx0ZXIuanMiOjI4LCIuL2ZpbmFsbHkuanMiOjI5LCIuL2dlbmVyYXRvcnMuanMiOjMwLCIuL2pvaW4uanMiOjMxLCIuL21hcC5qcyI6MzIsIi4vbm9kZWlmeS5qcyI6MzMsIi4vcHJvZ3Jlc3MuanMiOjM0LCIuL3Byb21pc2VfYXJyYXkuanMiOjM2LCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiOjM3LCIuL3Byb21pc2lmeS5qcyI6MzgsIi4vcHJvcHMuanMiOjM5LCIuL3JhY2UuanMiOjQxLCIuL3JlZHVjZS5qcyI6NDIsIi4vc2V0dGxlLmpzIjo0NCwiLi9zb21lLmpzIjo0NSwiLi9zeW5jaHJvbm91c19pbnNwZWN0aW9uLmpzIjo0NiwiLi90aGVuYWJsZXMuanMiOjQ3LCIuL3RpbWVycy5qcyI6NDgsIi4vdXNpbmcuanMiOjQ5LCIuL3V0aWwuanMiOjUwLCJfcHJvY2VzcyI6NjB9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KSB7CnZhciBjYW5BdHRhY2ggPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLmNhbkF0dGFjaDsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGlzQXJyYXkgPSB1dGlsLmlzQXJyYXk7CgpmdW5jdGlvbiB0b1Jlc29sdXRpb25WYWx1ZSh2YWwpIHsKICAgIHN3aXRjaCh2YWwpIHsKICAgIGNhc2UgLTE6IHJldHVybiB2b2lkIDA7CiAgICBjYXNlIC0yOiByZXR1cm4gW107CiAgICBjYXNlIC0zOiByZXR1cm4ge307CiAgICB9Cn0KCmZ1bmN0aW9uIFByb21pc2VBcnJheSh2YWx1ZXMpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5fcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHZhciBwYXJlbnQgPSB2b2lkIDA7CiAgICBpZiAodmFsdWVzIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHBhcmVudCA9IHZhbHVlczsKICAgICAgICBwcm9taXNlLl9wcm9wYWdhdGVGcm9tKHBhcmVudCwgMSB8IDQpOwogICAgfQogICAgcHJvbWlzZS5fc2V0VHJhY2UocGFyZW50KTsKICAgIHRoaXMuX3ZhbHVlcyA9IHZhbHVlczsKICAgIHRoaXMuX2xlbmd0aCA9IDA7CiAgICB0aGlzLl90b3RhbFJlc29sdmVkID0gMDsKICAgIHRoaXMuX2luaXQodm9pZCAwLCAtMik7Cn0KUHJvbWlzZUFycmF5LnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2xlbmd0aDsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIFByb21pc2VBcnJheSRwcm9taXNlKCkgewogICAgcmV0dXJuIHRoaXMuX3Byb21pc2U7Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9pbml0KF8sIHJlc29sdmVWYWx1ZUlmRW1wdHkpIHsKICAgIHZhciB2YWx1ZXMgPSBjYXN0KHRoaXMuX3ZhbHVlcywgdm9pZCAwKTsKICAgIGlmICh2YWx1ZXMgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgdGhpcy5fdmFsdWVzID0gdmFsdWVzOwogICAgICAgIHZhbHVlcy5fc2V0Qm91bmRUbyh0aGlzLl9wcm9taXNlLl9ib3VuZFRvKTsKICAgICAgICBpZiAodmFsdWVzLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzLl9zZXR0bGVkVmFsdWU7CiAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZXMpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyID0gbmV3IFByb21pc2UuVHlwZUVycm9yKCJleHBlY3RpbmcgYW4gYXJyYXksIGEgcHJvbWlzZSBvciBhIHRoZW5hYmxlIik7CiAgICAgICAgICAgICAgICB0aGlzLl9faGFyZFJlamVjdF9fKGVycik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHZhbHVlcy5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICB2YWx1ZXMuX3RoZW4oCiAgICAgICAgICAgICAgICBQcm9taXNlQXJyYXkkX2luaXQsCiAgICAgICAgICAgICAgICB0aGlzLl9yZWplY3QsCiAgICAgICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgICAgICB0aGlzLAogICAgICAgICAgICAgICAgcmVzb2x2ZVZhbHVlSWZFbXB0eQogICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZXMuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgdGhpcy5fcmVqZWN0KHZhbHVlcy5fc2V0dGxlZFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoIWlzQXJyYXkodmFsdWVzKSkgewogICAgICAgIHZhciBlcnIgPSBuZXcgUHJvbWlzZS5UeXBlRXJyb3IoImV4cGVjdGluZyBhbiBhcnJheSwgYSBwcm9taXNlIG9yIGEgdGhlbmFibGUiKTsKICAgICAgICB0aGlzLl9faGFyZFJlamVjdF9fKGVycik7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKHJlc29sdmVWYWx1ZUlmRW1wdHkgPT09IC01KSB7CiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVFbXB0eUFycmF5KCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLl9yZXNvbHZlKHRvUmVzb2x1dGlvblZhbHVlKHJlc29sdmVWYWx1ZUlmRW1wdHkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGxlbiA9IHRoaXMuZ2V0QWN0dWFsTGVuZ3RoKHZhbHVlcy5sZW5ndGgpOwogICAgdmFyIG5ld0xlbiA9IGxlbjsKICAgIHZhciBuZXdWYWx1ZXMgPSB0aGlzLnNob3VsZENvcHlWYWx1ZXMoKSA/IG5ldyBBcnJheShsZW4pIDogdGhpcy5fdmFsdWVzOwogICAgdmFyIGlzRGlyZWN0U2Nhbk5lZWRlZCA9IGZhbHNlOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBtYXliZVByb21pc2UgPSBjYXN0KHZhbHVlc1tpXSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlLmlzUGVuZGluZygpKSB7CiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlLl91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICAgICAgICAgICAgICBpc0RpcmVjdFNjYW5OZWVkZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNEaXJlY3RTY2FuTmVlZGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbmV3VmFsdWVzW2ldID0gbWF5YmVQcm9taXNlOwogICAgfQogICAgdGhpcy5fdmFsdWVzID0gbmV3VmFsdWVzOwogICAgdGhpcy5fbGVuZ3RoID0gbmV3TGVuOwogICAgaWYgKGlzRGlyZWN0U2Nhbk5lZWRlZCkgewogICAgICAgIHRoaXMuX3NjYW5EaXJlY3RWYWx1ZXMobGVuKTsKICAgIH0KfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VBdCA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfc2V0dGxlUHJvbWlzZUF0KGluZGV4KSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLl92YWx1ZXNbaW5kZXhdOwogICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgIHRoaXMuX3Byb21pc2VGdWxmaWxsZWQodmFsdWUsIGluZGV4KTsKICAgIH0gZWxzZSBpZiAodmFsdWUuaXNGdWxmaWxsZWQoKSkgewogICAgICAgIHRoaXMuX3Byb21pc2VGdWxmaWxsZWQodmFsdWUuX3NldHRsZWRWYWx1ZSwgaW5kZXgpOwogICAgfSBlbHNlIGlmICh2YWx1ZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICB0aGlzLl9wcm9taXNlUmVqZWN0ZWQodmFsdWUuX3NldHRsZWRWYWx1ZSwgaW5kZXgpOwogICAgfQp9OwoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fc2NhbkRpcmVjdFZhbHVlcyA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfc2NhbkRpcmVjdFZhbHVlcyhsZW4pIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zZXR0bGVQcm9taXNlQXQoaSk7CiAgICB9Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pc1Jlc29sdmVkID0gZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9pc1Jlc29sdmVkKCkgewogICAgcmV0dXJuIHRoaXMuX3ZhbHVlcyA9PT0gbnVsbDsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3Jlc29sdmUgPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3Jlc29sdmUodmFsdWUpIHsKICAgIHRoaXMuX3ZhbHVlcyA9IG51bGw7CiAgICB0aGlzLl9wcm9taXNlLl9mdWxmaWxsKHZhbHVlKTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX19oYXJkUmVqZWN0X18gPQpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZWplY3QgPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3JlamVjdChyZWFzb24pIHsKICAgIHRoaXMuX3ZhbHVlcyA9IG51bGw7CiAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICB0aGlzLl9wcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgIHRoaXMuX3Byb21pc2UuX3JlamVjdChyZWFzb24sIHRyYWNlKTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VQcm9ncmVzc2VkID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9wcm9taXNlUHJvZ3Jlc3NlZChwcm9ncmVzc1ZhbHVlLCBpbmRleCkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fcHJvbWlzZS5fcHJvZ3Jlc3MoewogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICB2YWx1ZTogcHJvZ3Jlc3NWYWx1ZQogICAgfSk7Cn07CgoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZUZ1bGZpbGxlZCA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHRoaXMuX3ZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgIHZhciB0b3RhbFJlc29sdmVkID0gKyt0aGlzLl90b3RhbFJlc29sdmVkOwogICAgaWYgKHRvdGFsUmVzb2x2ZWQgPj0gdGhpcy5fbGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fcmVzb2x2ZSh0aGlzLl92YWx1ZXMpOwogICAgfQp9OwoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVJlamVjdGVkID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9wcm9taXNlUmVqZWN0ZWQocmVhc29uLCBpbmRleCkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fdG90YWxSZXNvbHZlZCsrOwogICAgdGhpcy5fcmVqZWN0KHJlYXNvbik7Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLnNob3VsZENvcHlWYWx1ZXMgPQpmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3Nob3VsZENvcHlWYWx1ZXMoKSB7CiAgICByZXR1cm4gdHJ1ZTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuZ2V0QWN0dWFsTGVuZ3RoID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JGdldEFjdHVhbExlbmd0aChsZW4pIHsKICAgIHJldHVybiBsZW47Cn07CgpyZXR1cm4gUHJvbWlzZUFycmF5Owp9OwoKfSx7Ii4vZXJyb3JzLmpzIjoyNSwiLi91dGlsLmpzIjo1MH1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBtYXliZVdyYXBBc0Vycm9yID0gdXRpbC5tYXliZVdyYXBBc0Vycm9yOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKTsKdmFyIFRpbWVvdXRFcnJvciA9IGVycm9ycy5UaW1lb3V0RXJyb3I7CnZhciBPcGVyYXRpb25hbEVycm9yID0gZXJyb3JzLk9wZXJhdGlvbmFsRXJyb3I7CnZhciBhc3luYyA9IHJlcXVpcmUoIi4vYXN5bmMuanMiKTsKdmFyIGhhdmVHZXR0ZXJzID0gdXRpbC5oYXZlR2V0dGVyczsKdmFyIGVzNSA9IHJlcXVpcmUoIi4vZXM1LmpzIik7CgpmdW5jdGlvbiBpc1VudHlwZWRFcnJvcihvYmopIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBFcnJvciAmJgogICAgICAgIGVzNS5nZXRQcm90b3R5cGVPZihvYmopID09PSBFcnJvci5wcm90b3R5cGU7Cn0KCmZ1bmN0aW9uIHdyYXBBc09wZXJhdGlvbmFsRXJyb3Iob2JqKSB7CiAgICB2YXIgcmV0OwogICAgaWYgKGlzVW50eXBlZEVycm9yKG9iaikpIHsKICAgICAgICByZXQgPSBuZXcgT3BlcmF0aW9uYWxFcnJvcihvYmopOwogICAgfSBlbHNlIHsKICAgICAgICByZXQgPSBvYmo7CiAgICB9CiAgICBlcnJvcnMubWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKHJldCk7CiAgICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSkgewogICAgZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJF9jYWxsYmFjayhlcnIsIHZhbHVlKSB7CiAgICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIHJldHVybjsKCiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgd3JhcHBlZCA9IHdyYXBBc09wZXJhdGlvbmFsRXJyb3IobWF5YmVXcmFwQXNFcnJvcihlcnIpKTsKICAgICAgICAgICAgcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh3cmFwcGVkKTsKICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0KHdyYXBwZWQpOwogICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgdmFyICRfbGVuID0gYXJndW1lbnRzLmxlbmd0aDt2YXIgYXJncyA9IG5ldyBBcnJheSgkX2xlbiAtIDEpOyBmb3IodmFyICRfaSA9IDE7ICRfaSA8ICRfbGVuOyArKyRfaSkge2FyZ3NbJF9pIC0gMV0gPSBhcmd1bWVudHNbJF9pXTt9CiAgICAgICAgICAgIHByb21pc2UuX2Z1bGZpbGwoYXJncyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBwcm9taXNlID0gbnVsbDsKICAgIH0KICAgIHJldHVybiBQcm9taXNlUmVzb2x2ZXIkX2NhbGxiYWNrOwp9CgoKdmFyIFByb21pc2VSZXNvbHZlcjsKaWYgKCFoYXZlR2V0dGVycykgewogICAgUHJvbWlzZVJlc29sdmVyID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyKHByb21pc2UpIHsKICAgICAgICB0aGlzLnByb21pc2UgPSBwcm9taXNlOwogICAgICAgIHRoaXMuYXNDYWxsYmFjayA9IG5vZGViYWNrRm9yUHJvbWlzZShwcm9taXNlKTsKICAgICAgICB0aGlzLmNhbGxiYWNrID0gdGhpcy5hc0NhbGxiYWNrOwogICAgfTsKfQplbHNlIHsKICAgIFByb21pc2VSZXNvbHZlciA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlcihwcm9taXNlKSB7CiAgICAgICAgdGhpcy5wcm9taXNlID0gcHJvbWlzZTsKICAgIH07Cn0KaWYgKGhhdmVHZXR0ZXJzKSB7CiAgICB2YXIgcHJvcCA9IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbm9kZWJhY2tGb3JQcm9taXNlKHRoaXMucHJvbWlzZSk7CiAgICAgICAgfQogICAgfTsKICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLCAiYXNDYWxsYmFjayIsIHByb3ApOwogICAgZXM1LmRlZmluZVByb3BlcnR5KFByb21pc2VSZXNvbHZlci5wcm90b3R5cGUsICJjYWxsYmFjayIsIHByb3ApOwp9CgpQcm9taXNlUmVzb2x2ZXIuX25vZGViYWNrRm9yUHJvbWlzZSA9IG5vZGViYWNrRm9yUHJvbWlzZTsKClByb21pc2VSZXNvbHZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiBQcm9taXNlUmVzb2x2ZXIkdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIltvYmplY3QgUHJvbWlzZVJlc29sdmVyXSI7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLnJlc29sdmUgPQpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmZ1bGZpbGwgPSBmdW5jdGlvbiBQcm9taXNlUmVzb2x2ZXIkcmVzb2x2ZSh2YWx1ZSkgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFByb21pc2VSZXNvbHZlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuIik7CiAgICB9CgogICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CiAgICBpZiAocHJvbWlzZS5fdHJ5Rm9sbG93KHZhbHVlKSkgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIGFzeW5jLmludm9rZShwcm9taXNlLl9mdWxmaWxsLCBwcm9taXNlLCB2YWx1ZSk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRyZWplY3QocmVhc29uKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUHJvbWlzZVJlc29sdmVyKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIklsbGVnYWwgaW52b2NhdGlvbiwgcmVzb2x2ZXIgcmVzb2x2ZS9yZWplY3QgbXVzdCBiZSBjYWxsZWQgd2l0aGluIGEgcmVzb2x2ZXIgY29udGV4dC4gQ29uc2lkZXIgdXNpbmcgdGhlIHByb21pc2UgY29uc3RydWN0b3IgaW5zdGVhZC4iKTsKICAgIH0KCiAgICB2YXIgcHJvbWlzZSA9IHRoaXMucHJvbWlzZTsKICAgIGVycm9ycy5tYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24ocmVhc29uKTsKICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgIGFzeW5jLmludm9rZShwcm9taXNlLl9yZWplY3QsIHByb21pc2UsIHJlYXNvbik7CiAgICBpZiAodHJhY2UgIT09IHJlYXNvbikgewogICAgICAgIGFzeW5jLmludm9rZSh0aGlzLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSwgdGhpcywgdHJhY2UpOwogICAgfQp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5wcm9ncmVzcyA9CmZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRwcm9ncmVzcyh2YWx1ZSkgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFByb21pc2VSZXNvbHZlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuIik7CiAgICB9CiAgICBhc3luYy5pbnZva2UodGhpcy5wcm9taXNlLl9wcm9ncmVzcywgdGhpcy5wcm9taXNlLCB2YWx1ZSk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRjYW5jZWwoKSB7CiAgICBhc3luYy5pbnZva2UodGhpcy5wcm9taXNlLmNhbmNlbCwgdGhpcy5wcm9taXNlLCB2b2lkIDApOwp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS50aW1lb3V0ID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJHRpbWVvdXQoKSB7CiAgICB0aGlzLnJlamVjdChuZXcgVGltZW91dEVycm9yKCJ0aW1lb3V0IikpOwp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5pc1Jlc29sdmVkID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJGlzUmVzb2x2ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5wcm9taXNlLmlzUmVzb2x2ZWQoKTsKfTsKClByb21pc2VSZXNvbHZlci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLnByb21pc2UudG9KU09OKCk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSA9CmZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRfc2V0Q2FycmllZFN0YWNrVHJhY2UodHJhY2UpIHsKICAgIGlmICh0aGlzLnByb21pc2UuaXNSZWplY3RlZCgpKSB7CiAgICAgICAgdGhpcy5wcm9taXNlLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSh0cmFjZSk7CiAgICB9Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFByb21pc2VSZXNvbHZlcjsKCn0seyIuL2FzeW5jLmpzIjoxOCwiLi9lcnJvcnMuanMiOjI1LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBUSElTID0ge307CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBub2RlYmFja0ZvclByb21pc2UgPSByZXF1aXJlKCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiKQogICAgLl9ub2RlYmFja0ZvclByb21pc2U7CnZhciB3aXRoQXBwZW5kZWQgPSB1dGlsLndpdGhBcHBlbmRlZDsKdmFyIG1heWJlV3JhcEFzRXJyb3IgPSB1dGlsLm1heWJlV3JhcEFzRXJyb3I7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciBUeXBlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycyIpLlR5cGVFcnJvcjsKdmFyIGRlZmF1bHRTdWZmaXggPSAiQXN5bmMiOwp2YXIgZGVmYXVsdEZpbHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKICAgIHJldHVybiB1dGlsLmlzSWRlbnRpZmllcihuYW1lKSAmJgogICAgICAgIG5hbWUuY2hhckF0KDApICE9PSAiXyIgJiYKICAgICAgICAhdXRpbC5pc0NsYXNzKGZ1bmMpOwp9Owp2YXIgZGVmYXVsdFByb21pc2lmaWVkID0ge19faXNQcm9taXNpZmllZF9fOiB0cnVlfTsKCgpmdW5jdGlvbiBlc2NhcGVJZGVudFJlZ2V4KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oWyRdKS8sICJcXCQiKTsKfQoKZnVuY3Rpb24gaXNQcm9taXNpZmllZChmbikgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4uX19pc1Byb21pc2lmaWVkX18gPT09IHRydWU7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQoKZnVuY3Rpb24gaGFzUHJvbWlzaWZpZWQob2JqLCBrZXksIHN1ZmZpeCkgewogICAgdmFyIHZhbCA9IHV0aWwuZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0KG9iaiwga2V5ICsgc3VmZml4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9taXNpZmllZCk7CiAgICByZXR1cm4gdmFsID8gaXNQcm9taXNpZmllZCh2YWwpIDogZmFsc2U7Cn0KZnVuY3Rpb24gY2hlY2tWYWxpZChyZXQsIHN1ZmZpeCwgc3VmZml4UmVnZXhwKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldC5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIHZhciBrZXkgPSByZXRbaV07CiAgICAgICAgaWYgKHN1ZmZpeFJlZ2V4cC50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFyIGtleVdpdGhvdXRBc3luY1N1ZmZpeCA9IGtleS5yZXBsYWNlKHN1ZmZpeFJlZ2V4cCwgIiIpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJldC5sZW5ndGg7IGogKz0gMikgewogICAgICAgICAgICAgICAgaWYgKHJldFtqXSA9PT0ga2V5V2l0aG91dEFzeW5jU3VmZml4KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IHByb21pc2lmeSBhbiBBUEkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aGF0IGhhcyBub3JtYWwgbWV0aG9kcyB3aXRoICciK3N1ZmZpeCsiJy1zdWZmaXgiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gcHJvbWlzaWZpYWJsZU1ldGhvZHMob2JqLCBzdWZmaXgsIHN1ZmZpeFJlZ2V4cCwgZmlsdGVyKSB7CiAgICB2YXIga2V5cyA9IHV0aWwuaW5oZXJpdGVkRGF0YUtleXMob2JqKTsKICAgIHZhciByZXQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgJiYKICAgICAgICAgICAgIWlzUHJvbWlzaWZpZWQodmFsdWUpICYmCiAgICAgICAgICAgICFoYXNQcm9taXNpZmllZChvYmosIGtleSwgc3VmZml4KSAmJgogICAgICAgICAgICBmaWx0ZXIoa2V5LCB2YWx1ZSwgb2JqKSkgewogICAgICAgICAgICByZXQucHVzaChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBjaGVja1ZhbGlkKHJldCwgc3VmZml4LCBzdWZmaXhSZWdleHApOwogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gc3dpdGNoQ2FzZUFyZ3VtZW50T3JkZXIobGlrZWx5QXJndW1lbnRDb3VudCkgewogICAgdmFyIHJldCA9IFtsaWtlbHlBcmd1bWVudENvdW50XTsKICAgIHZhciBtaW4gPSBNYXRoLm1heCgwLCBsaWtlbHlBcmd1bWVudENvdW50IC0gMSAtIDUpOwogICAgZm9yKHZhciBpID0gbGlrZWx5QXJndW1lbnRDb3VudCAtIDE7IGkgPj0gbWluOyAtLWkpIHsKICAgICAgICBpZiAoaSA9PT0gbGlrZWx5QXJndW1lbnRDb3VudCkgY29udGludWU7CiAgICAgICAgcmV0LnB1c2goaSk7CiAgICB9CiAgICBmb3IodmFyIGkgPSBsaWtlbHlBcmd1bWVudENvdW50ICsgMTsgaSA8PSA1OyArK2kpIHsKICAgICAgICByZXQucHVzaChpKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGFyZ3VtZW50U2VxdWVuY2UoYXJndW1lbnRDb3VudCkgewogICAgcmV0dXJuIHV0aWwuZmlsbGVkUmFuZ2UoYXJndW1lbnRDb3VudCwgImFyZ3VtZW50c1siLCAiXSIpOwp9CgpmdW5jdGlvbiBwYXJhbWV0ZXJEZWNsYXJhdGlvbihwYXJhbWV0ZXJDb3VudCkgewogICAgcmV0dXJuIHV0aWwuZmlsbGVkUmFuZ2UocGFyYW1ldGVyQ291bnQsICJfYXJnIiwgIiIpOwp9CgpmdW5jdGlvbiBwYXJhbWV0ZXJDb3VudChmbikgewogICAgaWYgKHR5cGVvZiBmbi5sZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KE1hdGgubWluKGZuLmxlbmd0aCwgMTAyMyArIDEpLCAwKTsKICAgIH0KICAgIHJldHVybiAwOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGtleSkgewogICAgaWYgKHV0aWwuaXNJZGVudGlmaWVyKGtleSkpIHsKICAgICAgICByZXR1cm4gIi4iICsga2V5OwogICAgfQogICAgZWxzZSByZXR1cm4gIlsnIiArIGtleS5yZXBsYWNlKC8oWydcXF0pL2csICJcXCQxIikgKyAiJ10iOwp9CgpmdW5jdGlvbiBtYWtlTm9kZVByb21pc2lmaWVkRXZhbChjYWxsYmFjaywgcmVjZWl2ZXIsIG9yaWdpbmFsTmFtZSwgZm4sIHN1ZmZpeCkgewogICAgdmFyIG5ld1BhcmFtZXRlckNvdW50ID0gTWF0aC5tYXgoMCwgcGFyYW1ldGVyQ291bnQoZm4pIC0gMSk7CiAgICB2YXIgYXJndW1lbnRPcmRlciA9IHN3aXRjaENhc2VBcmd1bWVudE9yZGVyKG5ld1BhcmFtZXRlckNvdW50KTsKICAgIHZhciBjYWxsYmFja05hbWUgPQogICAgICAgICh0eXBlb2Ygb3JpZ2luYWxOYW1lID09PSAic3RyaW5nIiAmJiB1dGlsLmlzSWRlbnRpZmllcihvcmlnaW5hbE5hbWUpCiAgICAgICAgICAgID8gb3JpZ2luYWxOYW1lICsgc3VmZml4CiAgICAgICAgICAgIDogInByb21pc2lmaWVkIik7CgogICAgZnVuY3Rpb24gZ2VuZXJhdGVDYWxsRm9yQXJndW1lbnRDb3VudChjb3VudCkgewogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRTZXF1ZW5jZShjb3VudCkuam9pbigiLCAiKTsKICAgICAgICB2YXIgY29tbWEgPSBjb3VudCA+IDAgPyAiLCAiIDogIiI7CiAgICAgICAgdmFyIHJldDsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXQgPSAiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgdGhpcy5tZXRob2Qoe3thcmdzfX0sIGZuKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiLnJlcGxhY2UoIi5tZXRob2QiLCBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGNhbGxiYWNrKSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciA9PT0gVEhJUykgewogICAgICAgICAgICByZXQgPSAgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCB7e2FyZ3N9fSwgZm4pOyAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXQgPSAgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbChyZWNlaXZlciwge3thcmdzfX0sIGZuKTsgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldCA9ICAiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBjYWxsYmFjayh7e2FyZ3N9fSwgZm4pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBicmVhazsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQucmVwbGFjZSgie3thcmdzfX0iLCBhcmdzKS5yZXBsYWNlKCIsICIsIGNvbW1hKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpIHsKICAgICAgICB2YXIgcmV0ID0gIiI7CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50T3JkZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgcmV0ICs9ICJjYXNlICIgKyBhcmd1bWVudE9yZGVyW2ldICsiOiIgKwogICAgICAgICAgICAgICAgZ2VuZXJhdGVDYWxsRm9yQXJndW1lbnRDb3VudChhcmd1bWVudE9yZGVyW2ldKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvZGVGb3JDYWxsOwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGNvZGVGb3JDYWxsID0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3MpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICIKICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIucHJvcGVydHkiLCBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGNhbGxiYWNrKSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciA9PT0gVEhJUykgewogICAgICAgICAgICBjb2RlRm9yQ2FsbCA9ICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvZGVGb3JDYWxsID0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShyZWNlaXZlciwgYXJncyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICI7CiAgICAgICAgfQoKICAgICAgICByZXQgKz0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICBkZWZhdWx0OiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkobGVuICsgMSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgdmFyIGkgPSAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgYXJnc1tpXSA9IGZuOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgW0NvZGVGb3JDYWxsXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoIltDb2RlRm9yQ2FsbF0iLCBjb2RlRm9yQ2FsbCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJQcm9taXNlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlY2VpdmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgIndpdGhBcHBlbmRlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtYXliZVdyYXBBc0Vycm9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm5vZGViYWNrRm9yUHJvbWlzZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJJTlRFUk5BTCIsIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgdmFyIHJldCA9IGZ1bmN0aW9uIEZ1bmN0aW9uTmFtZShQYXJhbWV0ZXJzKSB7ICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICd1c2Ugc3RyaWN0JzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoSU5URVJOQUwpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBmbiA9IG5vZGViYWNrRm9yUHJvbWlzZShwcm9taXNlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHRyeSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBzd2l0Y2gobGVuKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICAgICAgW0NvZGVGb3JTd2l0Y2hDYXNlXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZCA9IG1heWJlV3JhcEFzRXJyb3IoZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHdyYXBwZWQpOyAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBwcm9taXNlLl9yZWplY3Qod3JhcHBlZCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgfTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgcmV0Ll9faXNQcm9taXNpZmllZF9fID0gdHJ1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgcmV0dXJuIHJldDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgIgogICAgICAgIC5yZXBsYWNlKCJGdW5jdGlvbk5hbWUiLCBjYWxsYmFja05hbWUpCiAgICAgICAgLnJlcGxhY2UoIlBhcmFtZXRlcnMiLCBwYXJhbWV0ZXJEZWNsYXJhdGlvbihuZXdQYXJhbWV0ZXJDb3VudCkpCiAgICAgICAgLnJlcGxhY2UoIltDb2RlRm9yU3dpdGNoQ2FzZV0iLCBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpKSkoCiAgICAgICAgICAgIFByb21pc2UsCiAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICByZWNlaXZlciwKICAgICAgICAgICAgd2l0aEFwcGVuZGVkLAogICAgICAgICAgICBtYXliZVdyYXBBc0Vycm9yLAogICAgICAgICAgICBub2RlYmFja0ZvclByb21pc2UsCiAgICAgICAgICAgIElOVEVSTkFMCiAgICAgICAgKTsKfQoKZnVuY3Rpb24gbWFrZU5vZGVQcm9taXNpZmllZENsb3N1cmUoY2FsbGJhY2ssIHJlY2VpdmVyKSB7CiAgICBmdW5jdGlvbiBwcm9taXNpZmllZCgpIHsKICAgICAgICB2YXIgX3JlY2VpdmVyID0gcmVjZWl2ZXI7CiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBUSElTKSBfcmVjZWl2ZXIgPSB0aGlzOwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gX3JlY2VpdmVyW2NhbGxiYWNrXTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICAgICAgcHJvbWlzZS5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICB2YXIgZm4gPSBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoX3JlY2VpdmVyLCB3aXRoQXBwZW5kZWQoYXJndW1lbnRzLCBmbikpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICB2YXIgd3JhcHBlZCA9IG1heWJlV3JhcEFzRXJyb3IoZSk7CiAgICAgICAgICAgIHByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2Uod3JhcHBlZCk7CiAgICAgICAgICAgIHByb21pc2UuX3JlamVjdCh3cmFwcGVkKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBwcm9taXNpZmllZC5fX2lzUHJvbWlzaWZpZWRfXyA9IHRydWU7CiAgICByZXR1cm4gcHJvbWlzaWZpZWQ7Cn0KCnZhciBtYWtlTm9kZVByb21pc2lmaWVkID0gY2FuRXZhbHVhdGUKICAgID8gbWFrZU5vZGVQcm9taXNpZmllZEV2YWwKICAgIDogbWFrZU5vZGVQcm9taXNpZmllZENsb3N1cmU7CgpmdW5jdGlvbiBwcm9taXNpZnlBbGwob2JqLCBzdWZmaXgsIGZpbHRlciwgcHJvbWlzaWZpZXIpIHsKICAgIHZhciBzdWZmaXhSZWdleHAgPSBuZXcgUmVnRXhwKGVzY2FwZUlkZW50UmVnZXgoc3VmZml4KSArICIkIik7CiAgICB2YXIgbWV0aG9kcyA9CiAgICAgICAgcHJvbWlzaWZpYWJsZU1ldGhvZHMob2JqLCBzdWZmaXgsIHN1ZmZpeFJlZ2V4cCwgZmlsdGVyKTsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsZW47IGkrPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IG1ldGhvZHNbaV07CiAgICAgICAgdmFyIGZuID0gbWV0aG9kc1tpKzFdOwogICAgICAgIHZhciBwcm9taXNpZmllZEtleSA9IGtleSArIHN1ZmZpeDsKICAgICAgICBvYmpbcHJvbWlzaWZpZWRLZXldID0gcHJvbWlzaWZpZXIgPT09IG1ha2VOb2RlUHJvbWlzaWZpZWQKICAgICAgICAgICAgICAgID8gbWFrZU5vZGVQcm9taXNpZmllZChrZXksIFRISVMsIGtleSwgZm4sIHN1ZmZpeCkKICAgICAgICAgICAgICAgIDogcHJvbWlzaWZpZXIoZm4pOwogICAgfQogICAgdXRpbC50b0Zhc3RQcm9wZXJ0aWVzKG9iaik7CiAgICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBwcm9taXNpZnkoY2FsbGJhY2ssIHJlY2VpdmVyKSB7CiAgICByZXR1cm4gbWFrZU5vZGVQcm9taXNpZmllZChjYWxsYmFjaywgcmVjZWl2ZXIsIHZvaWQgMCwgY2FsbGJhY2spOwp9CgpQcm9taXNlLnByb21pc2lmeSA9IGZ1bmN0aW9uIFByb21pc2UkUHJvbWlzaWZ5KGZuLCByZWNlaXZlcikgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgaWYgKGlzUHJvbWlzaWZpZWQoZm4pKSB7CiAgICAgICAgcmV0dXJuIGZuOwogICAgfQogICAgcmV0dXJuIHByb21pc2lmeShmbiwgYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBUSElTIDogcmVjZWl2ZXIpOwp9OwoKUHJvbWlzZS5wcm9taXNpZnlBbGwgPSBmdW5jdGlvbiBQcm9taXNlJFByb21pc2lmeUFsbCh0YXJnZXQsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidGhlIHRhcmdldCBvZiBwcm9taXNpZnlBbGwgbXVzdCBiZSBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbiIpOwogICAgfQogICAgb3B0aW9ucyA9IE9iamVjdChvcHRpb25zKTsKICAgIHZhciBzdWZmaXggPSBvcHRpb25zLnN1ZmZpeDsKICAgIGlmICh0eXBlb2Ygc3VmZml4ICE9PSAic3RyaW5nIikgc3VmZml4ID0gZGVmYXVsdFN1ZmZpeDsKICAgIHZhciBmaWx0ZXIgPSBvcHRpb25zLmZpbHRlcjsKICAgIGlmICh0eXBlb2YgZmlsdGVyICE9PSAiZnVuY3Rpb24iKSBmaWx0ZXIgPSBkZWZhdWx0RmlsdGVyOwogICAgdmFyIHByb21pc2lmaWVyID0gb3B0aW9ucy5wcm9taXNpZmllcjsKICAgIGlmICh0eXBlb2YgcHJvbWlzaWZpZXIgIT09ICJmdW5jdGlvbiIpIHByb21pc2lmaWVyID0gbWFrZU5vZGVQcm9taXNpZmllZDsKCiAgICBpZiAoIXV0aWwuaXNJZGVudGlmaWVyKHN1ZmZpeCkpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigic3VmZml4IG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyIik7CiAgICB9CgogICAgdmFyIGtleXMgPSB1dGlsLmluaGVyaXRlZERhdGFLZXlzKHRhcmdldCwge2luY2x1ZGVIaWRkZW46IHRydWV9KTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciB2YWx1ZSA9IHRhcmdldFtrZXlzW2ldXTsKICAgICAgICBpZiAoa2V5c1tpXSAhPT0gImNvbnN0cnVjdG9yIiAmJgogICAgICAgICAgICB1dGlsLmlzQ2xhc3ModmFsdWUpKSB7CiAgICAgICAgICAgIHByb21pc2lmeUFsbCh2YWx1ZS5wcm90b3R5cGUsIHN1ZmZpeCwgZmlsdGVyLCBwcm9taXNpZmllcik7CiAgICAgICAgICAgIHByb21pc2lmeUFsbCh2YWx1ZSwgc3VmZml4LCBmaWx0ZXIsIHByb21pc2lmaWVyKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHByb21pc2lmeUFsbCh0YXJnZXQsIHN1ZmZpeCwgZmlsdGVyLCBwcm9taXNpZmllcik7Cn07Cn07CgoKfSx7Ii4vZXJyb3JzIjoyNSwiLi9wcm9taXNlX3Jlc29sdmVyLmpzIjozNywiLi91dGlsLmpzIjo1MH1dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgUHJvbWlzZUFycmF5LCBjYXN0KSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBhcGlSZWplY3Rpb24gPSByZXF1aXJlKCIuL2Vycm9yc19hcGlfcmVqZWN0aW9uIikoUHJvbWlzZSk7CnZhciBpc09iamVjdCA9IHV0aWwuaXNPYmplY3Q7CnZhciBlczUgPSByZXF1aXJlKCIuL2VzNS5qcyIpOwoKZnVuY3Rpb24gUHJvcGVydGllc1Byb21pc2VBcnJheShvYmopIHsKICAgIHZhciBrZXlzID0gZXM1LmtleXMob2JqKTsKICAgIHZhciBsZW4gPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuICogMik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgdmFsdWVzW2ldID0gb2JqW2tleV07CiAgICAgICAgdmFsdWVzW2kgKyBsZW5dID0ga2V5OwogICAgfQogICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTsKfQp1dGlsLmluaGVyaXRzKFByb3BlcnRpZXNQcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5faW5pdCA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX2luaXQoKSB7CiAgICB0aGlzLl9pbml0JCh2b2lkIDAsIC0zKSA7Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZUZ1bGZpbGxlZCA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX3Byb21pc2VGdWxmaWxsZWQodmFsdWUsIGluZGV4KSB7CiAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSByZXR1cm47CiAgICB0aGlzLl92YWx1ZXNbaW5kZXhdID0gdmFsdWU7CiAgICB2YXIgdG90YWxSZXNvbHZlZCA9ICsrdGhpcy5fdG90YWxSZXNvbHZlZDsKICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkgewogICAgICAgIHZhciB2YWwgPSB7fTsKICAgICAgICB2YXIga2V5T2Zmc2V0ID0gdGhpcy5sZW5ndGgoKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGgoKTsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgIHZhbFt0aGlzLl92YWx1ZXNbaSArIGtleU9mZnNldF1dID0gdGhpcy5fdmFsdWVzW2ldOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZXNvbHZlKHZhbCk7CiAgICB9Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVByb2dyZXNzZWQgPQpmdW5jdGlvbiBQcm9wZXJ0aWVzUHJvbWlzZUFycmF5JF9wcm9taXNlUHJvZ3Jlc3NlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKCiAgICB0aGlzLl9wcm9taXNlLl9wcm9ncmVzcyh7CiAgICAgICAga2V5OiB0aGlzLl92YWx1ZXNbaW5kZXggKyB0aGlzLmxlbmd0aCgpXSwKICAgICAgICB2YWx1ZTogdmFsdWUKICAgIH0pOwp9OwoKUHJvcGVydGllc1Byb21pc2VBcnJheS5wcm90b3R5cGUuc2hvdWxkQ29weVZhbHVlcyA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX3Nob3VsZENvcHlWYWx1ZXMoKSB7CiAgICByZXR1cm4gZmFsc2U7Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5nZXRBY3R1YWxMZW5ndGggPQpmdW5jdGlvbiBQcm9wZXJ0aWVzUHJvbWlzZUFycmF5JGdldEFjdHVhbExlbmd0aChsZW4pIHsKICAgIHJldHVybiBsZW4gPj4gMTsKfTsKCmZ1bmN0aW9uIFByb21pc2UkX1Byb3BzKHByb21pc2VzKSB7CiAgICB2YXIgcmV0OwogICAgdmFyIGNhc3RWYWx1ZSA9IGNhc3QocHJvbWlzZXMsIHZvaWQgMCk7CgogICAgaWYgKCFpc09iamVjdChjYXN0VmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGFwaVJlamVjdGlvbigiY2Fubm90IGF3YWl0IHByb3BlcnRpZXMgb2YgYSBub24tb2JqZWN0Iik7CiAgICB9IGVsc2UgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXQgPSBjYXN0VmFsdWUuX3RoZW4oUHJvbWlzZS5wcm9wcywgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgdm9pZCAwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0ID0gbmV3IFByb3BlcnRpZXNQcm9taXNlQXJyYXkoY2FzdFZhbHVlKS5wcm9taXNlKCk7CiAgICB9CgogICAgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXQuX3Byb3BhZ2F0ZUZyb20oY2FzdFZhbHVlLCA0KTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KClByb21pc2UucHJvdG90eXBlLnByb3BzID0gZnVuY3Rpb24gUHJvbWlzZSRwcm9wcygpIHsKICAgIHJldHVybiBQcm9taXNlJF9Qcm9wcyh0aGlzKTsKfTsKClByb21pc2UucHJvcHMgPSBmdW5jdGlvbiBQcm9taXNlJFByb3BzKHByb21pc2VzKSB7CiAgICByZXR1cm4gUHJvbWlzZSRfUHJvcHMocHJvbWlzZXMpOwp9Owp9OwoKfSx7Ii4vZXJyb3JzX2FwaV9yZWplY3Rpb24iOjI2LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwpmdW5jdGlvbiBhcnJheUNvcHkoc3JjLCBzcmNJbmRleCwgZHN0LCBkc3RJbmRleCwgbGVuKSB7CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGxlbjsgKytqKSB7CiAgICAgICAgZHN0W2ogKyBkc3RJbmRleF0gPSBzcmNbaiArIHNyY0luZGV4XTsKICAgIH0KfQoKZnVuY3Rpb24gUXVldWUoY2FwYWNpdHkpIHsKICAgIHRoaXMuX2NhcGFjaXR5ID0gY2FwYWNpdHk7CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fZnJvbnQgPSAwOwogICAgdGhpcy5fbWFrZUNhcGFjaXR5KCk7Cn0KClF1ZXVlLnByb3RvdHlwZS5fd2lsbEJlT3ZlckNhcGFjaXR5ID0KZnVuY3Rpb24gUXVldWUkX3dpbGxCZU92ZXJDYXBhY2l0eShzaXplKSB7CiAgICByZXR1cm4gdGhpcy5fY2FwYWNpdHkgPCBzaXplOwp9OwoKUXVldWUucHJvdG90eXBlLl9wdXNoT25lID0gZnVuY3Rpb24gUXVldWUkX3B1c2hPbmUoYXJnKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKTsKICAgIHRoaXMuX2NoZWNrQ2FwYWNpdHkobGVuZ3RoICsgMSk7CiAgICB2YXIgaSA9ICh0aGlzLl9mcm9udCArIGxlbmd0aCkgJiAodGhpcy5fY2FwYWNpdHkgLSAxKTsKICAgIHRoaXNbaV0gPSBhcmc7CiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGggKyAxOwp9OwoKUXVldWUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBRdWV1ZSRwdXNoKGZuLCByZWNlaXZlciwgYXJnKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKSArIDM7CiAgICBpZiAodGhpcy5fd2lsbEJlT3ZlckNhcGFjaXR5KGxlbmd0aCkpIHsKICAgICAgICB0aGlzLl9wdXNoT25lKGZuKTsKICAgICAgICB0aGlzLl9wdXNoT25lKHJlY2VpdmVyKTsKICAgICAgICB0aGlzLl9wdXNoT25lKGFyZyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGogPSB0aGlzLl9mcm9udCArIGxlbmd0aCAtIDM7CiAgICB0aGlzLl9jaGVja0NhcGFjaXR5KGxlbmd0aCk7CiAgICB2YXIgd3JhcE1hc2sgPSB0aGlzLl9jYXBhY2l0eSAtIDE7CiAgICB0aGlzWyhqICsgMCkgJiB3cmFwTWFza10gPSBmbjsKICAgIHRoaXNbKGogKyAxKSAmIHdyYXBNYXNrXSA9IHJlY2VpdmVyOwogICAgdGhpc1soaiArIDIpICYgd3JhcE1hc2tdID0gYXJnOwogICAgdGhpcy5fbGVuZ3RoID0gbGVuZ3RoOwp9OwoKUXVldWUucHJvdG90eXBlLnNoaWZ0ID0gZnVuY3Rpb24gUXVldWUkc2hpZnQoKSB7CiAgICB2YXIgZnJvbnQgPSB0aGlzLl9mcm9udCwKICAgICAgICByZXQgPSB0aGlzW2Zyb250XTsKCiAgICB0aGlzW2Zyb250XSA9IHZvaWQgMDsKICAgIHRoaXMuX2Zyb250ID0gKGZyb250ICsgMSkgJiAodGhpcy5fY2FwYWNpdHkgLSAxKTsKICAgIHRoaXMuX2xlbmd0aC0tOwogICAgcmV0dXJuIHJldDsKfTsKClF1ZXVlLnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiBRdWV1ZSRsZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwp9OwoKUXVldWUucHJvdG90eXBlLl9tYWtlQ2FwYWNpdHkgPSBmdW5jdGlvbiBRdWV1ZSRfbWFrZUNhcGFjaXR5KCkgewogICAgdmFyIGxlbiA9IHRoaXMuX2NhcGFjaXR5OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHRoaXNbaV0gPSB2b2lkIDA7CiAgICB9Cn07CgpRdWV1ZS5wcm90b3R5cGUuX2NoZWNrQ2FwYWNpdHkgPSBmdW5jdGlvbiBRdWV1ZSRfY2hlY2tDYXBhY2l0eShzaXplKSB7CiAgICBpZiAodGhpcy5fY2FwYWNpdHkgPCBzaXplKSB7CiAgICAgICAgdGhpcy5fcmVzaXplVG8odGhpcy5fY2FwYWNpdHkgPDwgMyk7CiAgICB9Cn07CgpRdWV1ZS5wcm90b3R5cGUuX3Jlc2l6ZVRvID0gZnVuY3Rpb24gUXVldWUkX3Jlc2l6ZVRvKGNhcGFjaXR5KSB7CiAgICB2YXIgb2xkRnJvbnQgPSB0aGlzLl9mcm9udDsKICAgIHZhciBvbGRDYXBhY2l0eSA9IHRoaXMuX2NhcGFjaXR5OwogICAgdmFyIG9sZFF1ZXVlID0gbmV3IEFycmF5KG9sZENhcGFjaXR5KTsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwoKICAgIGFycmF5Q29weSh0aGlzLCAwLCBvbGRRdWV1ZSwgMCwgb2xkQ2FwYWNpdHkpOwogICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eTsKICAgIHRoaXMuX21ha2VDYXBhY2l0eSgpOwogICAgdGhpcy5fZnJvbnQgPSAwOwogICAgaWYgKG9sZEZyb250ICsgbGVuZ3RoIDw9IG9sZENhcGFjaXR5KSB7CiAgICAgICAgYXJyYXlDb3B5KG9sZFF1ZXVlLCBvbGRGcm9udCwgdGhpcywgMCwgbGVuZ3RoKTsKICAgIH0gZWxzZSB7ICAgICAgICB2YXIgbGVuZ3RoQmVmb3JlV3JhcHBpbmcgPQogICAgICAgICAgICBsZW5ndGggLSAoKG9sZEZyb250ICsgbGVuZ3RoKSAmIChvbGRDYXBhY2l0eSAtIDEpKTsKCiAgICAgICAgYXJyYXlDb3B5KG9sZFF1ZXVlLCBvbGRGcm9udCwgdGhpcywgMCwgbGVuZ3RoQmVmb3JlV3JhcHBpbmcpOwogICAgICAgIGFycmF5Q29weShvbGRRdWV1ZSwgMCwgdGhpcywgbGVuZ3RoQmVmb3JlV3JhcHBpbmcsCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoIC0gbGVuZ3RoQmVmb3JlV3JhcHBpbmcpOwogICAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBRdWV1ZTsKCn0se31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwsIGNhc3QpIHsKdmFyIGFwaVJlamVjdGlvbiA9IHJlcXVpcmUoIi4vZXJyb3JzX2FwaV9yZWplY3Rpb24uanMiKShQcm9taXNlKTsKdmFyIGlzQXJyYXkgPSByZXF1aXJlKCIuL3V0aWwuanMiKS5pc0FycmF5OwoKdmFyIHJhY2VMYXRlciA9IGZ1bmN0aW9uIFByb21pc2UkX3JhY2VMYXRlcihwcm9taXNlKSB7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UkX1JhY2UoYXJyYXksIHByb21pc2UpOwogICAgfSk7Cn07Cgp2YXIgaGFzT3duID0ge30uaGFzT3duUHJvcGVydHk7CmZ1bmN0aW9uIFByb21pc2UkX1JhY2UocHJvbWlzZXMsIHBhcmVudCkgewogICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocHJvbWlzZXMsIHZvaWQgMCk7CgogICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXR1cm4gcmFjZUxhdGVyKG1heWJlUHJvbWlzZSk7CiAgICB9IGVsc2UgaWYgKCFpc0FycmF5KHByb21pc2VzKSkgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImV4cGVjdGluZyBhbiBhcnJheSwgYSBwcm9taXNlIG9yIGEgdGhlbmFibGUiKTsKICAgIH0KCiAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgaWYgKHBhcmVudCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHBhcmVudCwgNyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgIH0KICAgIHZhciBmdWxmaWxsID0gcmV0Ll9mdWxmaWxsOwogICAgdmFyIHJlamVjdCA9IHJldC5fcmVqZWN0OwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHByb21pc2VzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIHZhbCA9IHByb21pc2VzW2ldOwoKICAgICAgICBpZiAodmFsID09PSB2b2lkIDAgJiYgIShoYXNPd24uY2FsbChwcm9taXNlcywgaSkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgUHJvbWlzZS5jYXN0KHZhbCkuX3RoZW4oZnVsZmlsbCwgcmVqZWN0LCB2b2lkIDAsIHJldCwgbnVsbCk7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9CgpQcm9taXNlLnJhY2UgPSBmdW5jdGlvbiBQcm9taXNlJFJhY2UocHJvbWlzZXMpIHsKICAgIHJldHVybiBQcm9taXNlJF9SYWNlKHByb21pc2VzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUucmFjZSA9IGZ1bmN0aW9uIFByb21pc2UkcmFjZSgpIHsKICAgIHJldHVybiBQcm9taXNlJF9SYWNlKHRoaXMsIHZvaWQgMCk7Cn07Cgp9OwoKfSx7Ii4vZXJyb3JzX2FwaV9yZWplY3Rpb24uanMiOjI2LCIuL3V0aWwuanMiOjUwfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXksIGFwaVJlamVjdGlvbiwgY2FzdCwgSU5URVJOQUwpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIHRyeUNhdGNoNCA9IHV0aWwudHJ5Q2F0Y2g0Owp2YXIgdHJ5Q2F0Y2gzID0gdXRpbC50cnlDYXRjaDM7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CmZ1bmN0aW9uIFJlZHVjdGlvblByb21pc2VBcnJheShwcm9taXNlcywgZm4sIGFjY3VtLCBfZWFjaCkgewogICAgdGhpcy5jb25zdHJ1Y3RvciQocHJvbWlzZXMpOwogICAgdGhpcy5fcHJlc2VydmVkVmFsdWVzID0gX2VhY2ggPT09IElOVEVSTkFMID8gW10gOiBudWxsOwogICAgdGhpcy5femVyb3RoSXNBY2N1bSA9IChhY2N1bSA9PT0gdm9pZCAwKTsKICAgIHRoaXMuX2dvdEFjY3VtID0gZmFsc2U7CiAgICB0aGlzLl9yZWR1Y2luZ0luZGV4ID0gKHRoaXMuX3plcm90aElzQWNjdW0gPyAxIDogMCk7CiAgICB0aGlzLl92YWx1ZXNQaGFzZSA9IHVuZGVmaW5lZDsKCiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChhY2N1bSwgdm9pZCAwKTsKICAgIHZhciByZWplY3RlZCA9IGZhbHNlOwogICAgdmFyIGlzUHJvbWlzZSA9IG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2U7CiAgICBpZiAoaXNQcm9taXNlKSB7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIC0xKTsKICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgIGFjY3VtID0gbWF5YmVQcm9taXNlLnZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgdGhpcy5fcmVqZWN0KG1heWJlUHJvbWlzZS5yZWFzb24oKSk7CiAgICAgICAgICAgIHJlamVjdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoIShpc1Byb21pc2UgfHwgdGhpcy5femVyb3RoSXNBY2N1bSkpIHRoaXMuX2dvdEFjY3VtID0gdHJ1ZTsKICAgIHRoaXMuX2NhbGxiYWNrID0gZm47CiAgICB0aGlzLl9hY2N1bSA9IGFjY3VtOwogICAgaWYgKCFyZWplY3RlZCkgdGhpcy5faW5pdCQodm9pZCAwLCAtNSk7Cn0KdXRpbC5pbmhlcml0cyhSZWR1Y3Rpb25Qcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0KZnVuY3Rpb24gUmVkdWN0aW9uUHJvbWlzZUFycmF5JF9pbml0KCkge307CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZXNvbHZlRW1wdHlBcnJheSA9CmZ1bmN0aW9uIFJlZHVjdGlvblByb21pc2VBcnJheSRfcmVzb2x2ZUVtcHR5QXJyYXkoKSB7CiAgICBpZiAodGhpcy5fZ290QWNjdW0gfHwgdGhpcy5femVyb3RoSXNBY2N1bSkgewogICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fcHJlc2VydmVkVmFsdWVzICE9PSBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgID8gW10gOiB0aGlzLl9hY2N1bSk7CiAgICB9Cn07CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gUmVkdWN0aW9uUHJvbWlzZUFycmF5JF9wcm9taXNlRnVsZmlsbGVkKHZhbHVlLCBpbmRleCkgewogICAgdmFyIHZhbHVlcyA9IHRoaXMuX3ZhbHVlczsKICAgIGlmICh2YWx1ZXMgPT09IG51bGwpIHJldHVybjsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgdmFyIHByZXNlcnZlZFZhbHVlcyA9IHRoaXMuX3ByZXNlcnZlZFZhbHVlczsKICAgIHZhciBpc0VhY2ggPSBwcmVzZXJ2ZWRWYWx1ZXMgIT09IG51bGw7CiAgICB2YXIgZ290QWNjdW0gPSB0aGlzLl9nb3RBY2N1bTsKICAgIHZhciB2YWx1ZXNQaGFzZSA9IHRoaXMuX3ZhbHVlc1BoYXNlOwogICAgdmFyIHZhbHVlc1BoYXNlSW5kZXg7CiAgICBpZiAoIXZhbHVlc1BoYXNlKSB7CiAgICAgICAgdmFsdWVzUGhhc2UgPSB0aGlzLl92YWx1ZXNQaGFzZSA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yICh2YWx1ZXNQaGFzZUluZGV4PTA7IHZhbHVlc1BoYXNlSW5kZXg8bGVuZ3RoOyArK3ZhbHVlc1BoYXNlSW5kZXgpIHsKICAgICAgICAgICAgdmFsdWVzUGhhc2VbdmFsdWVzUGhhc2VJbmRleF0gPSAwOwogICAgICAgIH0KICAgIH0KICAgIHZhbHVlc1BoYXNlSW5kZXggPSB2YWx1ZXNQaGFzZVtpbmRleF07CgogICAgaWYgKGluZGV4ID09PSAwICYmIHRoaXMuX3plcm90aElzQWNjdW0pIHsKICAgICAgICBpZiAoIWdvdEFjY3VtKSB7CiAgICAgICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gZ290QWNjdW0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICB2YWx1ZXNQaGFzZVtpbmRleF0gPSAoKHZhbHVlc1BoYXNlSW5kZXggPT09IDApCiAgICAgICAgICAgID8gMSA6IDIpOwogICAgfSBlbHNlIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICBpZiAoIWdvdEFjY3VtKSB7CiAgICAgICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gZ290QWNjdW0gPSB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggPT09IDApIHsKICAgICAgICAgICAgdmFsdWVzUGhhc2VbaW5kZXhdID0gMTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhbHVlc1BoYXNlW2luZGV4XSA9IDI7CiAgICAgICAgICAgIGlmIChnb3RBY2N1bSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmICghZ290QWNjdW0pIHJldHVybjsKCiAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLl9jYWxsYmFjazsKICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3Byb21pc2UuX2JvdW5kVG87CiAgICB2YXIgcmV0OwoKICAgIGZvciAodmFyIGkgPSB0aGlzLl9yZWR1Y2luZ0luZGV4OyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICB2YWx1ZXNQaGFzZUluZGV4ID0gdmFsdWVzUGhhc2VbaV07CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggPT09IDIpIHsKICAgICAgICAgICAgdGhpcy5fcmVkdWNpbmdJbmRleCA9IGkgKyAxOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggIT09IDEpIHJldHVybjsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZXNbaV07CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICBpZiAodmFsdWUuaXNGdWxmaWxsZWQoKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5fc2V0dGxlZFZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmlzUGVuZGluZygpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWx1ZS5fdW5zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdCh2YWx1ZS5yZWFzb24oKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpc0VhY2gpIHsKICAgICAgICAgICAgcHJlc2VydmVkVmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICByZXQgPSB0cnlDYXRjaDMoY2FsbGJhY2ssIHJlY2VpdmVyLCB2YWx1ZSwgaSwgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldCA9IHRyeUNhdGNoNChjYWxsYmFjaywgcmVjZWl2ZXIsIHRoaXMuX2FjY3VtLCB2YWx1ZSwgaSwgbGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIGlmIChyZXQgPT09IGVycm9yT2JqKSByZXR1cm4gdGhpcy5fcmVqZWN0KHJldC5lKTsKCiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocmV0LCB2b2lkIDApOwogICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UuaXNQZW5kaW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhbHVlc1BoYXNlW2ldID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgICAgICByZXQgPSBtYXliZVByb21pc2UudmFsdWUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fdW5zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdChtYXliZVByb21pc2UucmVhc29uKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZWR1Y2luZ0luZGV4ID0gaSArIDE7CiAgICAgICAgdGhpcy5fYWNjdW0gPSByZXQ7CiAgICB9CgogICAgaWYgKHRoaXMuX3JlZHVjaW5nSW5kZXggPCBsZW5ndGgpIHJldHVybjsKICAgIHRoaXMuX3Jlc29sdmUoaXNFYWNoID8gcHJlc2VydmVkVmFsdWVzIDogdGhpcy5fYWNjdW0pOwp9OwoKZnVuY3Rpb24gcmVkdWNlKHByb21pc2VzLCBmbiwgaW5pdGlhbFZhbHVlLCBfZWFjaCkgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICB2YXIgYXJyYXkgPSBuZXcgUmVkdWN0aW9uUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgaW5pdGlhbFZhbHVlLCBfZWFjaCk7CiAgICByZXR1cm4gYXJyYXkucHJvbWlzZSgpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiBQcm9taXNlJHJlZHVjZShmbiwgaW5pdGlhbFZhbHVlKSB7CiAgICByZXR1cm4gcmVkdWNlKHRoaXMsIGZuLCBpbml0aWFsVmFsdWUsIG51bGwpOwp9OwoKUHJvbWlzZS5yZWR1Y2UgPSBmdW5jdGlvbiBQcm9taXNlJFJlZHVjZShwcm9taXNlcywgZm4sIGluaXRpYWxWYWx1ZSwgX2VhY2gpIHsKICAgIHJldHVybiByZWR1Y2UocHJvbWlzZXMsIGZuLCBpbml0aWFsVmFsdWUsIF9lYWNoKTsKfTsKfTsKCn0seyIuL3V0aWwuanMiOjUwfV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIHNjaGVkdWxlOwp2YXIgX011dGF0aW9uT2JzZXJ2ZXI7CmlmICh0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb2Nlc3MudmVyc2lvbiA9PT0gInN0cmluZyIpIHsKICAgIHNjaGVkdWxlID0gZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKGZuKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmbik7CiAgICB9Owp9CmVsc2UgaWYgKCh0eXBlb2YgTXV0YXRpb25PYnNlcnZlciAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgKF9NdXRhdGlvbk9ic2VydmVyID0gTXV0YXRpb25PYnNlcnZlcikpIHx8CiAgICAgICAgICh0eXBlb2YgV2ViS2l0TXV0YXRpb25PYnNlcnZlciAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgKF9NdXRhdGlvbk9ic2VydmVyID0gV2ViS2l0TXV0YXRpb25PYnNlcnZlcikpKSB7CiAgICBzY2hlZHVsZSA9IChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgdmFyIHF1ZXVlZEZuID0gdm9pZCAwOwogICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBfTXV0YXRpb25PYnNlcnZlcigKICAgICAgICAgICAgZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKCkgewogICAgICAgICAgICAgICAgdmFyIGZuID0gcXVldWVkRm47CiAgICAgICAgICAgICAgICBxdWV1ZWRGbiA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICk7CiAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShkaXYsIHsKICAgICAgICAgICAgYXR0cmlidXRlczogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBQcm9taXNlJF9TY2hlZHVsZXIoZm4pIHsKICAgICAgICAgICAgcXVldWVkRm4gPSBmbjsKICAgICAgICAgICAgZGl2LmNsYXNzTGlzdC50b2dnbGUoImZvbyIpOwogICAgICAgIH07CgogICAgfSkoKTsKfQplbHNlIGlmICh0eXBlb2Ygc2V0VGltZW91dCAhPT0gInVuZGVmaW5lZCIpIHsKICAgIHNjaGVkdWxlID0gZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKGZuKSB7CiAgICAgICAgc2V0VGltZW91dChmbiwgMCk7CiAgICB9Owp9CmVsc2UgdGhyb3cgbmV3IEVycm9yKCJubyBhc3luYyBzY2hlZHVsZXIgYXZhaWxhYmxlIik7Cm1vZHVsZS5leHBvcnRzID0gc2NoZWR1bGU7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Il9wcm9jZXNzIjo2MH1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0KICAgIGZ1bmN0aW9uKFByb21pc2UsIFByb21pc2VBcnJheSkgewp2YXIgUHJvbWlzZUluc3BlY3Rpb24gPSBQcm9taXNlLlByb21pc2VJbnNwZWN0aW9uOwp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwoKZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSh2YWx1ZXMpIHsKICAgIHRoaXMuY29uc3RydWN0b3IkKHZhbHVlcyk7Cn0KdXRpbC5pbmhlcml0cyhTZXR0bGVkUHJvbWlzZUFycmF5LCBQcm9taXNlQXJyYXkpOwoKU2V0dGxlZFByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VSZXNvbHZlZCA9CmZ1bmN0aW9uIFNldHRsZWRQcm9taXNlQXJyYXkkX3Byb21pc2VSZXNvbHZlZChpbmRleCwgaW5zcGVjdGlvbikgewogICAgdGhpcy5fdmFsdWVzW2luZGV4XSA9IGluc3BlY3Rpb247CiAgICB2YXIgdG90YWxSZXNvbHZlZCA9ICsrdGhpcy5fdG90YWxSZXNvbHZlZDsKICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkgewogICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fdmFsdWVzKTsKICAgIH0KfTsKClNldHRsZWRQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZUluc3BlY3Rpb24oKTsKICAgIHJldC5fYml0RmllbGQgPSAyNjg0MzU0NTY7CiAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHZhbHVlOwogICAgdGhpcy5fcHJvbWlzZVJlc29sdmVkKGluZGV4LCByZXQpOwp9OwpTZXR0bGVkUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVJlamVjdGVkID0KZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSRfcHJvbWlzZVJlamVjdGVkKHJlYXNvbiwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZUluc3BlY3Rpb24oKTsKICAgIHJldC5fYml0RmllbGQgPSAxMzQyMTc3Mjg7CiAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHJlYXNvbjsKICAgIHRoaXMuX3Byb21pc2VSZXNvbHZlZChpbmRleCwgcmV0KTsKfTsKClByb21pc2Uuc2V0dGxlID0gZnVuY3Rpb24gUHJvbWlzZSRTZXR0bGUocHJvbWlzZXMpIHsKICAgIHJldHVybiBuZXcgU2V0dGxlZFByb21pc2VBcnJheShwcm9taXNlcykucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuc2V0dGxlID0gZnVuY3Rpb24gUHJvbWlzZSRzZXR0bGUoKSB7CiAgICByZXR1cm4gbmV3IFNldHRsZWRQcm9taXNlQXJyYXkodGhpcykucHJvbWlzZSgpOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9CmZ1bmN0aW9uKFByb21pc2UsIFByb21pc2VBcnJheSwgYXBpUmVqZWN0aW9uKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBSYW5nZUVycm9yID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKS5SYW5nZUVycm9yOwp2YXIgQWdncmVnYXRlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLkFnZ3JlZ2F0ZUVycm9yOwp2YXIgaXNBcnJheSA9IHV0aWwuaXNBcnJheTsKCgpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5KHZhbHVlcykgewogICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTsKICAgIHRoaXMuX2hvd01hbnkgPSAwOwogICAgdGhpcy5fdW53cmFwID0gZmFsc2U7CiAgICB0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlOwp9CnV0aWwuaW5oZXJpdHMoU29tZVByb21pc2VBcnJheSwgUHJvbWlzZUFycmF5KTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfaW5pdCgpIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5faG93TWFueSA9PT0gMCkgewogICAgICAgIHRoaXMuX3Jlc29sdmUoW10pOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2luaXQkKHZvaWQgMCwgLTUpOwogICAgdmFyIGlzQXJyYXlSZXNvbHZlZCA9IGlzQXJyYXkodGhpcy5fdmFsdWVzKTsKICAgIGlmICghdGhpcy5faXNSZXNvbHZlZCgpICYmCiAgICAgICAgaXNBcnJheVJlc29sdmVkICYmCiAgICAgICAgdGhpcy5faG93TWFueSA+IHRoaXMuX2NhblBvc3NpYmx5RnVsZmlsbCgpKSB7CiAgICAgICAgdGhpcy5fcmVqZWN0KHRoaXMuX2dldFJhbmdlRXJyb3IodGhpcy5sZW5ndGgoKSkpOwogICAgfQp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkaW5pdCgpIHsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsKICAgIHRoaXMuX2luaXQoKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldFVud3JhcCA9IGZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkc2V0VW53cmFwKCkgewogICAgdGhpcy5fdW53cmFwID0gdHJ1ZTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLmhvd01hbnkgPSBmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JGhvd01hbnkoKSB7CiAgICByZXR1cm4gdGhpcy5faG93TWFueTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldEhvd01hbnkgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JHNldEhvd01hbnkoY291bnQpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHRoaXMuX2hvd01hbnkgPSBjb3VudDsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fYWRkRnVsZmlsbGVkKHZhbHVlKTsKICAgIGlmICh0aGlzLl9mdWxmaWxsZWQoKSA9PT0gdGhpcy5ob3dNYW55KCkpIHsKICAgICAgICB0aGlzLl92YWx1ZXMubGVuZ3RoID0gdGhpcy5ob3dNYW55KCk7CiAgICAgICAgaWYgKHRoaXMuaG93TWFueSgpID09PSAxICYmIHRoaXMuX3Vud3JhcCkgewogICAgICAgICAgICB0aGlzLl9yZXNvbHZlKHRoaXMuX3ZhbHVlc1swXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh0aGlzLl92YWx1ZXMpOwogICAgICAgIH0KICAgIH0KCn07ClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlUmVqZWN0ZWQgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9wcm9taXNlUmVqZWN0ZWQocmVhc29uKSB7CiAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSByZXR1cm47CiAgICB0aGlzLl9hZGRSZWplY3RlZChyZWFzb24pOwogICAgaWYgKHRoaXMuaG93TWFueSgpID4gdGhpcy5fY2FuUG9zc2libHlGdWxmaWxsKCkpIHsKICAgICAgICB2YXIgZSA9IG5ldyBBZ2dyZWdhdGVFcnJvcigpOwogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmxlbmd0aCgpOyBpIDwgdGhpcy5fdmFsdWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGUucHVzaCh0aGlzLl92YWx1ZXNbaV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZWplY3QoZSk7CiAgICB9Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fZnVsZmlsbGVkID0gZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfZnVsZmlsbGVkKCkgewogICAgcmV0dXJuIHRoaXMuX3RvdGFsUmVzb2x2ZWQ7Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcmVqZWN0ZWQgPSBmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9yZWplY3RlZCgpIHsKICAgIHJldHVybiB0aGlzLl92YWx1ZXMubGVuZ3RoIC0gdGhpcy5sZW5ndGgoKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9hZGRSZWplY3RlZCA9CmZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkX2FkZFJlamVjdGVkKHJlYXNvbikgewogICAgdGhpcy5fdmFsdWVzLnB1c2gocmVhc29uKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9hZGRGdWxmaWxsZWQgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9hZGRGdWxmaWxsZWQodmFsdWUpIHsKICAgIHRoaXMuX3ZhbHVlc1t0aGlzLl90b3RhbFJlc29sdmVkKytdID0gdmFsdWU7Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fY2FuUG9zc2libHlGdWxmaWxsID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfY2FuUG9zc2libHlGdWxmaWxsKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoKCkgLSB0aGlzLl9yZWplY3RlZCgpOwp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX2dldFJhbmdlRXJyb3IgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9nZXRSYW5nZUVycm9yKGNvdW50KSB7CiAgICB2YXIgbWVzc2FnZSA9ICJJbnB1dCBhcnJheSBtdXN0IGNvbnRhaW4gYXQgbGVhc3QgIiArCiAgICAgICAgICAgIHRoaXMuX2hvd01hbnkgKyAiIGl0ZW1zIGJ1dCBjb250YWlucyBvbmx5ICIgKyBjb3VudCArICIgaXRlbXMiOwogICAgcmV0dXJuIG5ldyBSYW5nZUVycm9yKG1lc3NhZ2UpOwp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX3Jlc29sdmVFbXB0eUFycmF5ID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfcmVzb2x2ZUVtcHR5QXJyYXkoKSB7CiAgICB0aGlzLl9yZWplY3QodGhpcy5fZ2V0UmFuZ2VFcnJvcigwKSk7Cn07CgpmdW5jdGlvbiBQcm9taXNlJF9Tb21lKHByb21pc2VzLCBob3dNYW55KSB7CiAgICBpZiAoKGhvd01hbnkgfCAwKSAhPT0gaG93TWFueSB8fCBob3dNYW55IDwgMCkgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImV4cGVjdGluZyBhIHBvc2l0aXZlIGludGVnZXIiKTsKICAgIH0KICAgIHZhciByZXQgPSBuZXcgU29tZVByb21pc2VBcnJheShwcm9taXNlcyk7CiAgICB2YXIgcHJvbWlzZSA9IHJldC5wcm9taXNlKCk7CiAgICBpZiAocHJvbWlzZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIHJldC5zZXRIb3dNYW55KGhvd01hbnkpOwogICAgcmV0LmluaXQoKTsKICAgIHJldHVybiBwcm9taXNlOwp9CgpQcm9taXNlLnNvbWUgPSBmdW5jdGlvbiBQcm9taXNlJFNvbWUocHJvbWlzZXMsIGhvd01hbnkpIHsKICAgIHJldHVybiBQcm9taXNlJF9Tb21lKHByb21pc2VzLCBob3dNYW55KTsKfTsKClByb21pc2UucHJvdG90eXBlLnNvbWUgPSBmdW5jdGlvbiBQcm9taXNlJHNvbWUoaG93TWFueSkgewogICAgcmV0dXJuIFByb21pc2UkX1NvbWUodGhpcywgaG93TWFueSk7Cn07CgpQcm9taXNlLl9Tb21lUHJvbWlzZUFycmF5ID0gU29tZVByb21pc2VBcnJheTsKfTsKCn0seyIuL2Vycm9ycy5qcyI6MjUsIi4vdXRpbC5qcyI6NTB9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKZnVuY3Rpb24gUHJvbWlzZUluc3BlY3Rpb24ocHJvbWlzZSkgewogICAgaWYgKHByb21pc2UgIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gcHJvbWlzZS5fYml0RmllbGQ7CiAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gcHJvbWlzZS5pc1Jlc29sdmVkKCkKICAgICAgICAgICAgPyBwcm9taXNlLl9zZXR0bGVkVmFsdWUKICAgICAgICAgICAgOiB2b2lkIDA7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0aGlzLl9iaXRGaWVsZCA9IDA7CiAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdm9pZCAwOwogICAgfQp9CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNGdWxmaWxsZWQgPQpQcm9taXNlLnByb3RvdHlwZS5pc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uIFByb21pc2UkaXNGdWxmaWxsZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMjY4NDM1NDU2KSA+IDA7Cn07CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNSZWplY3RlZCA9ClByb21pc2UucHJvdG90eXBlLmlzUmVqZWN0ZWQgPSBmdW5jdGlvbiBQcm9taXNlJGlzUmVqZWN0ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTM0MjE3NzI4KSA+IDA7Cn07CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNQZW5kaW5nID0KUHJvbWlzZS5wcm90b3R5cGUuaXNQZW5kaW5nID0gZnVuY3Rpb24gUHJvbWlzZSRpc1BlbmRpbmcoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNDAyNjUzMTg0KSA9PT0gMDsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS52YWx1ZSA9ClByb21pc2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gUHJvbWlzZSR2YWx1ZSgpIHsKICAgIGlmICghdGhpcy5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiY2Fubm90IGdldCBmdWxmaWxsbWVudCB2YWx1ZSBvZiBhIG5vbi1mdWxmaWxsZWQgcHJvbWlzZSIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3NldHRsZWRWYWx1ZTsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5lcnJvciA9ClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5yZWFzb24gPQpQcm9taXNlLnByb3RvdHlwZS5yZWFzb24gPSBmdW5jdGlvbiBQcm9taXNlJHJlYXNvbigpIHsKICAgIGlmICghdGhpcy5pc1JlamVjdGVkKCkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3QgZ2V0IHJlamVjdGlvbiByZWFzb24gb2YgYSBub24tcmVqZWN0ZWQgcHJvbWlzZSIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3NldHRsZWRWYWx1ZTsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5pc1Jlc29sdmVkID0KUHJvbWlzZS5wcm90b3R5cGUuaXNSZXNvbHZlZCA9IGZ1bmN0aW9uIFByb21pc2UkaXNSZXNvbHZlZCgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA0MDI2NTMxODQpID4gMDsKfTsKClByb21pc2UuUHJvbWlzZUluc3BlY3Rpb24gPSBQcm9taXNlSW5zcGVjdGlvbjsKfTsKCn0se31dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGNhbkF0dGFjaCA9IHJlcXVpcmUoIi4vZXJyb3JzLmpzIikuY2FuQXR0YWNoOwp2YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqOwp2YXIgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0OwoKZnVuY3Rpb24gZ2V0VGhlbihvYmopIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG9iai50aGVuOwogICAgfQogICAgY2F0Y2goZSkgewogICAgICAgIGVycm9yT2JqLmUgPSBlOwogICAgICAgIHJldHVybiBlcnJvck9iajsKICAgIH0KfQoKZnVuY3Rpb24gUHJvbWlzZSRfQ2FzdChvYmosIG9yaWdpbmFsUHJvbWlzZSkgewogICAgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpc0FueUJsdWViaXJkUHJvbWlzZShvYmopKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICAgICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICAgICAgb2JqLl90aGVuKAogICAgICAgICAgICAgICAgcmV0Ll9mdWxmaWxsVW5jaGVja2VkLAogICAgICAgICAgICAgICAgcmV0Ll9yZWplY3RVbmNoZWNrZWRDaGVja0Vycm9yLAogICAgICAgICAgICAgICAgcmV0Ll9wcm9ncmVzc1VuY2hlY2tlZCwKICAgICAgICAgICAgICAgIHJldCwKICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0Ll9zZXRGb2xsb3dpbmcoKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgdmFyIHRoZW4gPSBnZXRUaGVuKG9iaik7CiAgICAgICAgaWYgKHRoZW4gPT09IGVycm9yT2JqKSB7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb21pc2UgIT09IHZvaWQgMCAmJiBjYW5BdHRhY2godGhlbi5lKSkgewogICAgICAgICAgICAgICAgb3JpZ2luYWxQcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRoZW4uZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHRoZW4uZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZSRfZG9UaGVuYWJsZShvYmosIHRoZW4sIG9yaWdpbmFsUHJvbWlzZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKfQoKdmFyIGhhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eTsKZnVuY3Rpb24gaXNBbnlCbHVlYmlyZFByb21pc2Uob2JqKSB7CiAgICByZXR1cm4gaGFzUHJvcC5jYWxsKG9iaiwgIl9wcm9taXNlMCIpOwp9CgpmdW5jdGlvbiBQcm9taXNlJF9kb1RoZW5hYmxlKHgsIHRoZW4sIG9yaWdpbmFsUHJvbWlzZSkgewogICAgdmFyIHJlc29sdmVyID0gUHJvbWlzZS5kZWZlcigpOwogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgdHJ5IHsKICAgICAgICB0aGVuLmNhbGwoCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIFByb21pc2UkX3Jlc29sdmVGcm9tVGhlbmFibGUsCiAgICAgICAgICAgIFByb21pc2UkX3JlamVjdEZyb21UaGVuYWJsZSwKICAgICAgICAgICAgUHJvbWlzZSRfcHJvZ3Jlc3NGcm9tVGhlbmFibGUKICAgICAgICApOwogICAgfSBjYXRjaChlKSB7CiAgICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRyYWNlID0gY2FuQXR0YWNoKGUpID8gZSA6IG5ldyBFcnJvcihlICsgIiIpOwogICAgICAgICAgICBpZiAob3JpZ2luYWxQcm9taXNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG9yaWdpbmFsUHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb2x2ZXIucHJvbWlzZS5fcmVqZWN0KGUsIHRyYWNlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzb2x2ZXIucHJvbWlzZTsKCiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVRoZW5hYmxlKHkpIHsKICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHggPT09IHkpIHsKICAgICAgICAgICAgdmFyIGUgPSBQcm9taXNlLl9tYWtlU2VsZlJlc29sdXRpb25FcnJvcigpOwogICAgICAgICAgICBpZiAob3JpZ2luYWxQcm9taXNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG9yaWdpbmFsUHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZShlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvbHZlci5wcm9taXNlLl9yZWplY3QoZSwgdm9pZCAwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXNvbHZlci5yZXNvbHZlKHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFByb21pc2UkX3JlamVjdEZyb21UaGVuYWJsZShyKSB7CiAgICAgICAgaWYgKGNhbGxlZCkgcmV0dXJuOwogICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgdmFyIHRyYWNlID0gY2FuQXR0YWNoKHIpID8gciA6IG5ldyBFcnJvcihyICsgIiIpOwogICAgICAgIGlmIChvcmlnaW5hbFByb21pc2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICBvcmlnaW5hbFByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UodHJhY2UpOwogICAgICAgIH0KICAgICAgICByZXNvbHZlci5wcm9taXNlLl9yZWplY3QociwgdHJhY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIFByb21pc2UkX3Byb2dyZXNzRnJvbVRoZW5hYmxlKHYpIHsKICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47CiAgICAgICAgdmFyIHByb21pc2UgPSByZXNvbHZlci5wcm9taXNlOwogICAgICAgIGlmICh0eXBlb2YgcHJvbWlzZS5fcHJvZ3Jlc3MgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3Modik7CiAgICAgICAgfQogICAgfQp9CgpyZXR1cm4gUHJvbWlzZSRfQ2FzdDsKfTsKCn0seyIuL2Vycm9ycy5qcyI6MjUsIi4vdXRpbC5qcyI6NTB9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgX3NldFRpbWVvdXQgPSBmdW5jdGlvbihmbiwgbXMpIHsKICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgdmFyIGFyZzAgPSBhcmd1bWVudHNbMl07CiAgICB2YXIgYXJnMSA9IGFyZ3VtZW50c1szXTsKICAgIHZhciBhcmcyID0gbGVuID49IDUgPyBhcmd1bWVudHNbNF0gOiB2b2lkIDA7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGZuKGFyZzAsIGFyZzEsIGFyZzIpOwogICAgfSwgbXN8MCk7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgYXBpUmVqZWN0aW9uID0gcmVxdWlyZSgiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiIpKFByb21pc2UpOwp2YXIgVGltZW91dEVycm9yID0gUHJvbWlzZS5UaW1lb3V0RXJyb3I7Cgp2YXIgYWZ0ZXJUaW1lb3V0ID0gZnVuY3Rpb24gUHJvbWlzZSRfYWZ0ZXJUaW1lb3V0KHByb21pc2UsIG1lc3NhZ2UsIG1zKSB7CiAgICBpZiAoIXByb21pc2UuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gInN0cmluZyIpIHsKICAgICAgICBtZXNzYWdlID0gIm9wZXJhdGlvbiB0aW1lZCBvdXQgYWZ0ZXIiICsgIiAiICsgbXMgKyAiIG1zIgogICAgfQogICAgdmFyIGVyciA9IG5ldyBUaW1lb3V0RXJyb3IobWVzc2FnZSk7CiAgICBlcnJvcnMubWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKGVycik7CiAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7CiAgICBwcm9taXNlLl9jYW5jZWwoZXJyKTsKfTsKCnZhciBhZnRlckRlbGF5ID0gZnVuY3Rpb24gUHJvbWlzZSRfYWZ0ZXJEZWxheSh2YWx1ZSwgcHJvbWlzZSkgewogICAgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7Cn07Cgp2YXIgZGVsYXkgPSBQcm9taXNlLmRlbGF5ID0gZnVuY3Rpb24gUHJvbWlzZSREZWxheSh2YWx1ZSwgbXMpIHsKICAgIGlmIChtcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgbXMgPSB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IHZvaWQgMDsKICAgIH0KICAgIG1zID0gK21zOwogICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QodmFsdWUsIHZvaWQgMCk7CiAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKCiAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHByb21pc2UuX3Byb3BhZ2F0ZUZyb20obWF5YmVQcm9taXNlLCA3KTsKICAgICAgICBwcm9taXNlLl9mb2xsb3cobWF5YmVQcm9taXNlKTsKICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmRlbGF5KHZhbHVlLCBtcyk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7CiAgICAgICAgX3NldFRpbWVvdXQoYWZ0ZXJEZWxheSwgbXMsIHZhbHVlLCBwcm9taXNlKTsKICAgIH0KICAgIHJldHVybiBwcm9taXNlOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuZGVsYXkgPSBmdW5jdGlvbiBQcm9taXNlJGRlbGF5KG1zKSB7CiAgICByZXR1cm4gZGVsYXkodGhpcywgbXMpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUudGltZW91dCA9IGZ1bmN0aW9uIFByb21pc2UkdGltZW91dChtcywgbWVzc2FnZSkgewogICAgbXMgPSArbXM7CgogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fcHJvcGFnYXRlRnJvbSh0aGlzLCA3KTsKICAgIHJldC5fZm9sbG93KHRoaXMpOwogICAgX3NldFRpbWVvdXQoYWZ0ZXJUaW1lb3V0LCBtcywgcmV0LCBtZXNzYWdlLCBtcyk7CiAgICByZXR1cm4gcmV0LmNhbmNlbGxhYmxlKCk7Cn07Cgp9OwoKfSx7Ii4vZXJyb3JzLmpzIjoyNSwiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiI6MjYsIi4vdXRpbC5qcyI6NTB9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChQcm9taXNlLCBhcGlSZWplY3Rpb24sIGNhc3QpIHsKICAgIHZhciBUeXBlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLlR5cGVFcnJvcjsKICAgIHZhciBpbmhlcml0cyA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmluaGVyaXRzOwogICAgdmFyIFByb21pc2VJbnNwZWN0aW9uID0gUHJvbWlzZS5Qcm9taXNlSW5zcGVjdGlvbjsKCiAgICBmdW5jdGlvbiBpbnNwZWN0aW9uTWFwcGVyKGluc3BlY3Rpb25zKSB7CiAgICAgICAgdmFyIGxlbiA9IGluc3BlY3Rpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgIHZhciBpbnNwZWN0aW9uID0gaW5zcGVjdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChpbnNwZWN0aW9uLmlzUmVqZWN0ZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGluc3BlY3Rpb24uZXJyb3IoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zcGVjdGlvbnNbaV0gPSBpbnNwZWN0aW9uLnZhbHVlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnNwZWN0aW9uczsKICAgIH0KCiAgICBmdW5jdGlvbiB0aHJvd2VyKGUpIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7dGhyb3cgZTt9LCAwKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYXN0UHJlc2VydmluZ0Rpc3Bvc2FibGUodGhlbmFibGUpIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGVuYWJsZSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlICE9PSB0aGVuYWJsZSAmJgogICAgICAgICAgICB0eXBlb2YgdGhlbmFibGUuX2lzRGlzcG9zYWJsZSA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgICAgICB0eXBlb2YgdGhlbmFibGUuX2dldERpc3Bvc2VyID09PSAiZnVuY3Rpb24iICYmCiAgICAgICAgICAgIHRoZW5hYmxlLl9pc0Rpc3Bvc2FibGUoKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3NldERpc3Bvc2FibGUodGhlbmFibGUuX2dldERpc3Bvc2VyKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF5YmVQcm9taXNlOwogICAgfQogICAgZnVuY3Rpb24gZGlzcG9zZShyZXNvdXJjZXMsIGluc3BlY3Rpb24pIHsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgdmFyIGxlbiA9IHJlc291cmNlcy5sZW5ndGg7CiAgICAgICAgdmFyIHJldCA9IFByb21pc2UuZGVmZXIoKTsKICAgICAgICBmdW5jdGlvbiBpdGVyYXRvcigpIHsKICAgICAgICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4gcmV0LnJlc29sdmUoKTsKICAgICAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3RQcmVzZXJ2aW5nRGlzcG9zYWJsZShyZXNvdXJjZXNbaSsrXSk7CiAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlICYmCiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX2lzRGlzcG9zYWJsZSgpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZSA9IGNhc3QobWF5YmVQcm9taXNlLl9nZXREaXNwb3NlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJ5RGlzcG9zZShpbnNwZWN0aW9uKSwgdm9pZCAwKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlUHJvbWlzZS5fdGhlbihpdGVyYXRvciwgdGhyb3dlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIG51bGwsIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZXJhdG9yKCk7CiAgICAgICAgfQogICAgICAgIGl0ZXJhdG9yKCk7CiAgICAgICAgcmV0dXJuIHJldC5wcm9taXNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc3Bvc2VyU3VjY2Vzcyh2YWx1ZSkgewogICAgICAgIHZhciBpbnNwZWN0aW9uID0gbmV3IFByb21pc2VJbnNwZWN0aW9uKCk7CiAgICAgICAgaW5zcGVjdGlvbi5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICAgICAgaW5zcGVjdGlvbi5fYml0RmllbGQgPSAyNjg0MzU0NTY7CiAgICAgICAgcmV0dXJuIGRpc3Bvc2UodGhpcywgaW5zcGVjdGlvbikudGhlblJldHVybih2YWx1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzcG9zZXJGYWlsKHJlYXNvbikgewogICAgICAgIHZhciBpbnNwZWN0aW9uID0gbmV3IFByb21pc2VJbnNwZWN0aW9uKCk7CiAgICAgICAgaW5zcGVjdGlvbi5fc2V0dGxlZFZhbHVlID0gcmVhc29uOwogICAgICAgIGluc3BlY3Rpb24uX2JpdEZpZWxkID0gMTM0MjE3NzI4OwogICAgICAgIHJldHVybiBkaXNwb3NlKHRoaXMsIGluc3BlY3Rpb24pLnRoZW5UaHJvdyhyZWFzb24pOwogICAgfQoKICAgIGZ1bmN0aW9uIERpc3Bvc2VyKGRhdGEsIHByb21pc2UpIHsKICAgICAgICB0aGlzLl9kYXRhID0gZGF0YTsKICAgICAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZTsKICAgIH0KCiAgICBEaXNwb3Nlci5wcm90b3R5cGUuZGF0YSA9IGZ1bmN0aW9uIERpc3Bvc2VyJGRhdGEoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgICB9OwoKICAgIERpc3Bvc2VyLnByb3RvdHlwZS5wcm9taXNlID0gZnVuY3Rpb24gRGlzcG9zZXIkcHJvbWlzZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcHJvbWlzZTsKICAgIH07CgogICAgRGlzcG9zZXIucHJvdG90eXBlLnJlc291cmNlID0gZnVuY3Rpb24gRGlzcG9zZXIkcmVzb3VyY2UoKSB7CiAgICAgICAgaWYgKHRoaXMucHJvbWlzZSgpLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvbWlzZSgpLnZhbHVlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICBEaXNwb3Nlci5wcm90b3R5cGUudHJ5RGlzcG9zZSA9IGZ1bmN0aW9uKGluc3BlY3Rpb24pIHsKICAgICAgICB2YXIgcmVzb3VyY2UgPSB0aGlzLnJlc291cmNlKCk7CiAgICAgICAgdmFyIHJldCA9IHJlc291cmNlICE9PSBudWxsCiAgICAgICAgICAgID8gdGhpcy5kb0Rpc3Bvc2UocmVzb3VyY2UsIGluc3BlY3Rpb24pIDogbnVsbDsKICAgICAgICB0aGlzLl9wcm9taXNlLl91bnNldERpc3Bvc2FibGUoKTsKICAgICAgICB0aGlzLl9kYXRhID0gdGhpcy5fcHJvbWlzZSA9IG51bGw7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgRGlzcG9zZXIuaXNEaXNwb3NlciA9IGZ1bmN0aW9uIERpc3Bvc2VyJGlzRGlzcG9zZXIoZCkgewogICAgICAgIHJldHVybiAoZCAhPSBudWxsICYmCiAgICAgICAgICAgICAgICB0eXBlb2YgZC5yZXNvdXJjZSA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgICAgICAgICAgdHlwZW9mIGQudHJ5RGlzcG9zZSA9PT0gImZ1bmN0aW9uIik7CiAgICB9OwoKICAgIGZ1bmN0aW9uIEZ1bmN0aW9uRGlzcG9zZXIoZm4sIHByb21pc2UpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yJChmbiwgcHJvbWlzZSk7CiAgICB9CiAgICBpbmhlcml0cyhGdW5jdGlvbkRpc3Bvc2VyLCBEaXNwb3Nlcik7CgogICAgRnVuY3Rpb25EaXNwb3Nlci5wcm90b3R5cGUuZG9EaXNwb3NlID0gZnVuY3Rpb24gKHJlc291cmNlLCBpbnNwZWN0aW9uKSB7CiAgICAgICAgdmFyIGZuID0gdGhpcy5kYXRhKCk7CiAgICAgICAgcmV0dXJuIGZuLmNhbGwocmVzb3VyY2UsIHJlc291cmNlLCBpbnNwZWN0aW9uKTsKICAgIH07CgogICAgUHJvbWlzZS51c2luZyA9IGZ1bmN0aW9uIFByb21pc2UkdXNpbmcoKSB7CiAgICAgICAgdmFyIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbiA8IDIpIHJldHVybiBhcGlSZWplY3Rpb24oCiAgICAgICAgICAgICAgICAgICAgICAgICJ5b3UgbXVzdCBwYXNzIGF0IGxlYXN0IDIgYXJndW1lbnRzIHRvIFByb21pc2UudXNpbmciKTsKICAgICAgICB2YXIgZm4gPSBhcmd1bWVudHNbbGVuIC0gMV07CiAgICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgbGVuLS07CiAgICAgICAgdmFyIHJlc291cmNlcyA9IG5ldyBBcnJheShsZW4pOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZiAoRGlzcG9zZXIuaXNEaXNwb3NlcihyZXNvdXJjZSkpIHsKICAgICAgICAgICAgICAgIHZhciBkaXNwb3NlciA9IHJlc291cmNlOwogICAgICAgICAgICAgICAgcmVzb3VyY2UgPSByZXNvdXJjZS5wcm9taXNlKCk7CiAgICAgICAgICAgICAgICByZXNvdXJjZS5fc2V0RGlzcG9zYWJsZShkaXNwb3Nlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb3VyY2VzW2ldID0gcmVzb3VyY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUHJvbWlzZS5zZXR0bGUocmVzb3VyY2VzKQogICAgICAgICAgICAudGhlbihpbnNwZWN0aW9uTWFwcGVyKQogICAgICAgICAgICAuc3ByZWFkKGZuKQogICAgICAgICAgICAuX3RoZW4oZGlzcG9zZXJTdWNjZXNzLCBkaXNwb3NlckZhaWwsIHZvaWQgMCwgcmVzb3VyY2VzLCB2b2lkIDApOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5fc2V0RGlzcG9zYWJsZSA9CiAgICBmdW5jdGlvbiBQcm9taXNlJF9zZXREaXNwb3NhYmxlKGRpc3Bvc2VyKSB7CiAgICAgICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDI2MjE0NDsKICAgICAgICB0aGlzLl9kaXNwb3NlciA9IGRpc3Bvc2VyOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5faXNEaXNwb3NhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfaXNEaXNwb3NhYmxlKCkgewogICAgICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiAyNjIxNDQpID4gMDsKICAgIH07CgogICAgUHJvbWlzZS5wcm90b3R5cGUuX2dldERpc3Bvc2VyID0gZnVuY3Rpb24gUHJvbWlzZSRfZ2V0RGlzcG9zZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3Bvc2VyOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5fdW5zZXREaXNwb3NhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfdW5zZXREaXNwb3NhYmxlKCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjI2MjE0NCk7CiAgICAgICAgdGhpcy5fZGlzcG9zZXIgPSB2b2lkIDA7CiAgICB9OwoKICAgIFByb21pc2UucHJvdG90eXBlLmRpc3Bvc2VyID0gZnVuY3Rpb24gUHJvbWlzZSRkaXNwb3NlcihmbikgewogICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbkRpc3Bvc2VyKGZuLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgfTsKCn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIGVzNSA9IHJlcXVpcmUoIi4vZXM1LmpzIik7CnZhciBoYXZlR2V0dGVycyA9IChmdW5jdGlvbigpewogICAgdHJ5IHsKICAgICAgICB2YXIgbyA9IHt9OwogICAgICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShvLCAiZiIsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvLmYgPT09IDM7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCn0pKCk7CnZhciBjYW5FdmFsdWF0ZSA9IHR5cGVvZiBuYXZpZ2F0b3IgPT0gInVuZGVmaW5lZCI7CnZhciBlcnJvck9iaiA9IHtlOiB7fX07CmZ1bmN0aW9uIHRyeUNhdGNoMShmbiwgcmVjZWl2ZXIsIGFyZykgewogICAgdHJ5IHsgcmV0dXJuIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7IH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IGU7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQp9CgpmdW5jdGlvbiB0cnlDYXRjaDIoZm4sIHJlY2VpdmVyLCBhcmcsIGFyZzIpIHsKICAgIHRyeSB7IHJldHVybiBmbi5jYWxsKHJlY2VpdmVyLCBhcmcsIGFyZzIpOyB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIGVycm9yT2JqLmUgPSBlOwogICAgICAgIHJldHVybiBlcnJvck9iajsKICAgIH0KfQoKZnVuY3Rpb24gdHJ5Q2F0Y2gzKGZuLCByZWNlaXZlciwgYXJnLCBhcmcyLCBhcmczKSB7CiAgICB0cnkgeyByZXR1cm4gZm4uY2FsbChyZWNlaXZlciwgYXJnLCBhcmcyLCBhcmczKTsgfQogICAgY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvck9iai5lID0gZTsKICAgICAgICByZXR1cm4gZXJyb3JPYmo7CiAgICB9Cn0KCmZ1bmN0aW9uIHRyeUNhdGNoNChmbiwgcmVjZWl2ZXIsIGFyZywgYXJnMiwgYXJnMywgYXJnNCkgewogICAgdHJ5IHsgcmV0dXJuIGZuLmNhbGwocmVjZWl2ZXIsIGFyZywgYXJnMiwgYXJnMywgYXJnNCk7IH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IGU7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQp9CgpmdW5jdGlvbiB0cnlDYXRjaEFwcGx5KGZuLCBhcmdzLCByZWNlaXZlcikgewogICAgdHJ5IHsgcmV0dXJuIGZuLmFwcGx5KHJlY2VpdmVyLCBhcmdzKTsgfQogICAgY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvck9iai5lID0gZTsKICAgICAgICByZXR1cm4gZXJyb3JPYmo7CiAgICB9Cn0KCnZhciBpbmhlcml0cyA9IGZ1bmN0aW9uKENoaWxkLCBQYXJlbnQpIHsKICAgIHZhciBoYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHk7CgogICAgZnVuY3Rpb24gVCgpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yID0gQ2hpbGQ7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciQgPSBQYXJlbnQ7CiAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIFBhcmVudC5wcm90b3R5cGUpIHsKICAgICAgICAgICAgaWYgKGhhc1Byb3AuY2FsbChQYXJlbnQucHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUpICYmCiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWUuY2hhckF0KHByb3BlcnR5TmFtZS5sZW5ndGgtMSkgIT09ICIkIgogICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpc1twcm9wZXJ0eU5hbWUgKyAiJCJdID0gUGFyZW50LnByb3RvdHlwZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgVC5wcm90b3R5cGUgPSBQYXJlbnQucHJvdG90eXBlOwogICAgQ2hpbGQucHJvdG90eXBlID0gbmV3IFQoKTsKICAgIHJldHVybiBDaGlsZC5wcm90b3R5cGU7Cn07CgpmdW5jdGlvbiBhc1N0cmluZyh2YWwpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsID09PSAic3RyaW5nIiA/IHZhbCA6ICgiIiArIHZhbCk7Cn0KCmZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbCkgewogICAgcmV0dXJuIHZhbCA9PSBudWxsIHx8IHZhbCA9PT0gdHJ1ZSB8fCB2YWwgPT09IGZhbHNlIHx8CiAgICAgICAgdHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciI7Cgp9CgpmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgcmV0dXJuICFpc1ByaW1pdGl2ZSh2YWx1ZSk7Cn0KCmZ1bmN0aW9uIG1heWJlV3JhcEFzRXJyb3IobWF5YmVFcnJvcikgewogICAgaWYgKCFpc1ByaW1pdGl2ZShtYXliZUVycm9yKSkgcmV0dXJuIG1heWJlRXJyb3I7CgogICAgcmV0dXJuIG5ldyBFcnJvcihhc1N0cmluZyhtYXliZUVycm9yKSk7Cn0KCmZ1bmN0aW9uIHdpdGhBcHBlbmRlZCh0YXJnZXQsIGFwcGVuZGVlKSB7CiAgICB2YXIgbGVuID0gdGFyZ2V0Lmxlbmd0aDsKICAgIHZhciByZXQgPSBuZXcgQXJyYXkobGVuICsgMSk7CiAgICB2YXIgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHJldFtpXSA9IHRhcmdldFtpXTsKICAgIH0KICAgIHJldFtpXSA9IGFwcGVuZGVlOwogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0KG9iaiwga2V5LCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmIChlczUuaXNFUzUpIHsKICAgICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwogICAgICAgIGlmIChkZXNjICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2MuZ2V0ID09IG51bGwgJiYgZGVzYy5zZXQgPT0gbnVsbAogICAgICAgICAgICAgICAgICAgID8gZGVzYy52YWx1ZQogICAgICAgICAgICAgICAgICAgIDogZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHt9Lmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpID8gb2JqW2tleV0gOiB2b2lkIDA7CiAgICB9Cn0KCmZ1bmN0aW9uIG5vdEVudW1lcmFibGVQcm9wKG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmIChpc1ByaW1pdGl2ZShvYmopKSByZXR1cm4gb2JqOwogICAgdmFyIGRlc2NyaXB0b3IgPSB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgfTsKICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShvYmosIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgcmV0dXJuIG9iajsKfQoKCnZhciB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyID0gKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMgIT09ICJzdHJpbmciOwp9KS5jYWxsKCJzdHJpbmciKTsKCmZ1bmN0aW9uIHRocm93ZXIocikgewogICAgdGhyb3cgcjsKfQoKdmFyIGluaGVyaXRlZERhdGFLZXlzID0gKGZ1bmN0aW9uKCkgewogICAgaWYgKGVzNS5pc0VTNSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihvYmosIG9wdHMpIHsKICAgICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgICB2YXIgdmlzaXRlZEtleXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgICB2YXIgZ2V0S2V5cyA9IE9iamVjdChvcHRzKS5pbmNsdWRlSGlkZGVuCiAgICAgICAgICAgICAgICA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzCiAgICAgICAgICAgICAgICA6IE9iamVjdC5rZXlzOwogICAgICAgICAgICB3aGlsZSAob2JqICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBrZXlzOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBrZXlzID0gZ2V0S2V5cyhvYmopOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmlzaXRlZEtleXNba2V5XSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgdmlzaXRlZEtleXNba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzYyAhPSBudWxsICYmIGRlc2MuZ2V0ID09IG51bGwgJiYgZGVzYy5zZXQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9iaiA9IGVzNS5nZXRQcm90b3R5cGVPZihvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIHJldC5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwogICAgfQoKfSkoKTsKCmZ1bmN0aW9uIGlzQ2xhc3MoZm4pIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIga2V5cyA9IGVzNS5rZXlzKGZuLnByb3RvdHlwZSk7CiAgICAgICAgICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDAgJiYKICAgICAgICAgICAgICAgICAgICEoa2V5cy5sZW5ndGggPT09IDEgJiYga2V5c1swXSA9PT0gImNvbnN0cnVjdG9yIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KCmZ1bmN0aW9uIHRvRmFzdFByb3BlcnRpZXMob2JqKSB7CiAgICAvKmpzaGludCAtVzAyNyovCiAgICBmdW5jdGlvbiBmKCkge30KICAgIGYucHJvdG90eXBlID0gb2JqOwogICAgcmV0dXJuIGY7CiAgICBldmFsKG9iaik7Cn0KCnZhciByaWRlbnQgPSAvXlthLXokX11bYS16JF8wLTldKiQvaTsKZnVuY3Rpb24gaXNJZGVudGlmaWVyKHN0cikgewogICAgcmV0dXJuIHJpZGVudC50ZXN0KHN0cik7Cn0KCmZ1bmN0aW9uIGZpbGxlZFJhbmdlKGNvdW50LCBwcmVmaXgsIHN1ZmZpeCkgewogICAgdmFyIHJldCA9IG5ldyBBcnJheShjb3VudCk7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewogICAgICAgIHJldFtpXSA9IHByZWZpeCArIGkgKyBzdWZmaXg7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9Cgp2YXIgcmV0ID0gewogICAgaXNDbGFzczogaXNDbGFzcywKICAgIGlzSWRlbnRpZmllcjogaXNJZGVudGlmaWVyLAogICAgaW5oZXJpdGVkRGF0YUtleXM6IGluaGVyaXRlZERhdGFLZXlzLAogICAgZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0OiBnZXREYXRhUHJvcGVydHlPckRlZmF1bHQsCiAgICB0aHJvd2VyOiB0aHJvd2VyLAogICAgaXNBcnJheTogZXM1LmlzQXJyYXksCiAgICBoYXZlR2V0dGVyczogaGF2ZUdldHRlcnMsCiAgICBub3RFbnVtZXJhYmxlUHJvcDogbm90RW51bWVyYWJsZVByb3AsCiAgICBpc1ByaW1pdGl2ZTogaXNQcmltaXRpdmUsCiAgICBpc09iamVjdDogaXNPYmplY3QsCiAgICBjYW5FdmFsdWF0ZTogY2FuRXZhbHVhdGUsCiAgICBlcnJvck9iajogZXJyb3JPYmosCiAgICB0cnlDYXRjaDE6IHRyeUNhdGNoMSwKICAgIHRyeUNhdGNoMjogdHJ5Q2F0Y2gyLAogICAgdHJ5Q2F0Y2gzOiB0cnlDYXRjaDMsCiAgICB0cnlDYXRjaDQ6IHRyeUNhdGNoNCwKICAgIHRyeUNhdGNoQXBwbHk6IHRyeUNhdGNoQXBwbHksCiAgICBpbmhlcml0czogaW5oZXJpdHMsCiAgICB3aXRoQXBwZW5kZWQ6IHdpdGhBcHBlbmRlZCwKICAgIGFzU3RyaW5nOiBhc1N0cmluZywKICAgIG1heWJlV3JhcEFzRXJyb3I6IG1heWJlV3JhcEFzRXJyb3IsCiAgICB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyOiB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyLAogICAgdG9GYXN0UHJvcGVydGllczogdG9GYXN0UHJvcGVydGllcywKICAgIGZpbGxlZFJhbmdlOiBmaWxsZWRSYW5nZQp9OwoKbW9kdWxlLmV4cG9ydHMgPSByZXQ7Cgp9LHsiLi9lczUuanMiOjI3fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoKfSx7fV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDUxKQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9saWIvX2VtcHR5LmpzIjo1MX1dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KCnZhciBiYXNlNjQgPSByZXF1aXJlKCdiYXNlNjQtanMnKQp2YXIgaWVlZTc1NCA9IHJlcXVpcmUoJ2llZWU3NTQnKQp2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzLWFycmF5JykKCmV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCmV4cG9ydHMuU2xvd0J1ZmZlciA9IEJ1ZmZlcgpleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTID0gNTAKQnVmZmVyLnBvb2xTaXplID0gODE5MiAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCgp2YXIga01heExlbmd0aCA9IDB4M2ZmZmZmZmYKCi8qKgogKiBJZiBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgOgogKiAgID09PSB0cnVlICAgIFVzZSBVaW50OEFycmF5IGltcGxlbWVudGF0aW9uIChmYXN0ZXN0KQogKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAqCiAqIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0eXBlZCBhcnJheXMgYXJlIElFIDEwKywgRmlyZWZveCA0KywgQ2hyb21lIDcrLCBTYWZhcmkgNS4xKywKICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogKgogKiBOb3RlOgogKgogKiAtIEltcGxlbWVudGF0aW9uIG11c3Qgc3VwcG9ydCBhZGRpbmcgbmV3IHByb3BlcnRpZXMgdG8gYFVpbnQ4QXJyYXlgIGluc3RhbmNlcy4KICogICBGaXJlZm94IDQtMjkgbGFja2VkIHN1cHBvcnQsIGZpeGVkIGluIEZpcmVmb3ggMzArLgogKiAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogKgogKiAgLSBDaHJvbWUgOS0xMCBpcyBtaXNzaW5nIHRoZSBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uLgogKgogKiAgLSBJRTEwIGhhcyBhIGJyb2tlbiBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYXJyYXlzIG9mCiAqICAgIGluY29ycmVjdCBsZW5ndGggaW4gc29tZSBzaXR1YXRpb25zLgogKgogKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleSB3aWxsCiAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IHdpbGwgd29yayBjb3JyZWN0bHkuCiAqLwpCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCA9IChmdW5jdGlvbiAoKSB7CiAgdHJ5IHsKICAgIHZhciBidWYgPSBuZXcgQXJyYXlCdWZmZXIoMCkKICAgIHZhciBhcnIgPSBuZXcgVWludDhBcnJheShidWYpCiAgICBhcnIuZm9vID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfQogICAgcmV0dXJuIDQyID09PSBhcnIuZm9vKCkgJiYgLy8gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQKICAgICAgICB0eXBlb2YgYXJyLnN1YmFycmF5ID09PSAnZnVuY3Rpb24nICYmIC8vIGNocm9tZSA5LTEwIGxhY2sgYHN1YmFycmF5YAogICAgICAgIG5ldyBVaW50OEFycmF5KDEpLnN1YmFycmF5KDEsIDEpLmJ5dGVMZW5ndGggPT09IDAgLy8gaWUxMCBoYXMgYnJva2VuIGBzdWJhcnJheWAKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0pKCkKCi8qKgogKiBDbGFzczogQnVmZmVyCiAqID09PT09PT09PT09PT0KICoKICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBhcmUgYXVnbWVudGVkCiAqIHdpdGggZnVuY3Rpb24gcHJvcGVydGllcyBmb3IgYWxsIHRoZSBub2RlIGBCdWZmZXJgIEFQSSBmdW5jdGlvbnMuIFdlIHVzZQogKiBgVWludDhBcnJheWAgc28gdGhhdCBzcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdCByZXR1cm5zCiAqIGEgc2luZ2xlIG9jdGV0LgogKgogKiBCeSBhdWdtZW50aW5nIHRoZSBpbnN0YW5jZXMsIHdlIGNhbiBhdm9pZCBtb2RpZnlpbmcgdGhlIGBVaW50OEFycmF5YAogKiBwcm90b3R5cGUuCiAqLwpmdW5jdGlvbiBCdWZmZXIgKHN1YmplY3QsIGVuY29kaW5nLCBub1plcm8pIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQnVmZmVyKSkKICAgIHJldHVybiBuZXcgQnVmZmVyKHN1YmplY3QsIGVuY29kaW5nLCBub1plcm8pCgogIHZhciB0eXBlID0gdHlwZW9mIHN1YmplY3QKCiAgLy8gRmluZCB0aGUgbGVuZ3RoCiAgdmFyIGxlbmd0aAogIGlmICh0eXBlID09PSAnbnVtYmVyJykKICAgIGxlbmd0aCA9IHN1YmplY3QgPiAwID8gc3ViamVjdCA+Pj4gMCA6IDAKICBlbHNlIGlmICh0eXBlID09PSAnc3RyaW5nJykgewogICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykKICAgICAgc3ViamVjdCA9IGJhc2U2NGNsZWFuKHN1YmplY3QpCiAgICBsZW5ndGggPSBCdWZmZXIuYnl0ZUxlbmd0aChzdWJqZWN0LCBlbmNvZGluZykKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdvYmplY3QnICYmIHN1YmplY3QgIT09IG51bGwpIHsgLy8gYXNzdW1lIG9iamVjdCBpcyBhcnJheS1saWtlCiAgICBpZiAoc3ViamVjdC50eXBlID09PSAnQnVmZmVyJyAmJiBpc0FycmF5KHN1YmplY3QuZGF0YSkpCiAgICAgIHN1YmplY3QgPSBzdWJqZWN0LmRhdGEKICAgIGxlbmd0aCA9ICtzdWJqZWN0Lmxlbmd0aCA+IDAgPyBNYXRoLmZsb29yKCtzdWJqZWN0Lmxlbmd0aCkgOiAwCiAgfSBlbHNlCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtdXN0IHN0YXJ0IHdpdGggbnVtYmVyLCBidWZmZXIsIGFycmF5IG9yIHN0cmluZycpCgogIGlmICh0aGlzLmxlbmd0aCA+IGtNYXhMZW5ndGgpCiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSAnICsKICAgICAgJ3NpemU6IDB4JyArIGtNYXhMZW5ndGgudG9TdHJpbmcoMTYpICsgJyBieXRlcycpCgogIHZhciBidWYKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIC8vIFByZWZlcnJlZDogUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgIGJ1ZiA9IEJ1ZmZlci5fYXVnbWVudChuZXcgVWludDhBcnJheShsZW5ndGgpKQogIH0gZWxzZSB7CiAgICAvLyBGYWxsYmFjazogUmV0dXJuIFRISVMgaW5zdGFuY2Ugb2YgQnVmZmVyIChjcmVhdGVkIGJ5IGBuZXdgKQogICAgYnVmID0gdGhpcwogICAgYnVmLmxlbmd0aCA9IGxlbmd0aAogICAgYnVmLl9pc0J1ZmZlciA9IHRydWUKICB9CgogIHZhciBpCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmIHR5cGVvZiBzdWJqZWN0LmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAvLyBTcGVlZCBvcHRpbWl6YXRpb24gLS0gdXNlIHNldCBpZiB3ZSdyZSBjb3B5aW5nIGZyb20gYSB0eXBlZCBhcnJheQogICAgYnVmLl9zZXQoc3ViamVjdCkKICB9IGVsc2UgaWYgKGlzQXJyYXlpc2goc3ViamVjdCkpIHsKICAgIC8vIFRyZWF0IGFycmF5LWlzaCBvYmplY3RzIGFzIGEgYnl0ZSBhcnJheQogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdWJqZWN0KSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgICAgYnVmW2ldID0gc3ViamVjdC5yZWFkVUludDgoaSkKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykKICAgICAgICBidWZbaV0gPSAoKHN1YmplY3RbaV0gJSAyNTYpICsgMjU2KSAlIDI1NgogICAgfQogIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIGJ1Zi53cml0ZShzdWJqZWN0LCAwLCBlbmNvZGluZykKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdudW1iZXInICYmICFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhbm9aZXJvKSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgYnVmW2ldID0gMAogICAgfQogIH0KCiAgcmV0dXJuIGJ1Zgp9CgpCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiAoYikgewogIHJldHVybiAhIShiICE9IG51bGwgJiYgYi5faXNCdWZmZXIpCn0KCkJ1ZmZlci5jb21wYXJlID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKQogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIG11c3QgYmUgQnVmZmVycycpCgogIHZhciB4ID0gYS5sZW5ndGgKICB2YXIgeSA9IGIubGVuZ3RoCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IE1hdGgubWluKHgsIHkpOyBpIDwgbGVuICYmIGFbaV0gPT09IGJbaV07IGkrKykge30KICBpZiAoaSAhPT0gbGVuKSB7CiAgICB4ID0gYVtpXQogICAgeSA9IGJbaV0KICB9CiAgaWYgKHggPCB5KSByZXR1cm4gLTEKICBpZiAoeSA8IHgpIHJldHVybiAxCiAgcmV0dXJuIDAKfQoKQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewogICAgY2FzZSAnaGV4JzoKICAgIGNhc2UgJ3V0ZjgnOgogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICBjYXNlICdyYXcnOgogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0dXJuIHRydWUKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZQogIH0KfQoKQnVmZmVyLmNvbmNhdCA9IGZ1bmN0aW9uIChsaXN0LCB0b3RhbExlbmd0aCkgewogIGlmICghaXNBcnJheShsaXN0KSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVXNhZ2U6IEJ1ZmZlci5jb25jYXQobGlzdFssIGxlbmd0aF0pJykKCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbmV3IEJ1ZmZlcigwKQogIH0gZWxzZSBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiBsaXN0WzBdCiAgfQoKICB2YXIgaQogIGlmICh0b3RhbExlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0b3RhbExlbmd0aCA9IDAKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHRvdGFsTGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoCiAgICB9CiAgfQoKICB2YXIgYnVmID0gbmV3IEJ1ZmZlcih0b3RhbExlbmd0aCkKICB2YXIgcG9zID0gMAogIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgaXRlbSA9IGxpc3RbaV0KICAgIGl0ZW0uY29weShidWYsIHBvcykKICAgIHBvcyArPSBpdGVtLmxlbmd0aAogIH0KICByZXR1cm4gYnVmCn0KCkJ1ZmZlci5ieXRlTGVuZ3RoID0gZnVuY3Rpb24gKHN0ciwgZW5jb2RpbmcpIHsKICB2YXIgcmV0CiAgc3RyID0gc3RyICsgJycKICBzd2l0Y2ggKGVuY29kaW5nIHx8ICd1dGY4JykgewogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGNhc2UgJ3Jhdyc6CiAgICAgIHJldCA9IHN0ci5sZW5ndGgKICAgICAgYnJlYWsKICAgIGNhc2UgJ3VjczInOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIHJldCA9IHN0ci5sZW5ndGggKiAyCiAgICAgIGJyZWFrCiAgICBjYXNlICdoZXgnOgogICAgICByZXQgPSBzdHIubGVuZ3RoID4+PiAxCiAgICAgIGJyZWFrCiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgcmV0ID0gdXRmOFRvQnl0ZXMoc3RyKS5sZW5ndGgKICAgICAgYnJlYWsKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIHJldCA9IGJhc2U2NFRvQnl0ZXMoc3RyKS5sZW5ndGgKICAgICAgYnJlYWsKICAgIGRlZmF1bHQ6CiAgICAgIHJldCA9IHN0ci5sZW5ndGgKICB9CiAgcmV0dXJuIHJldAp9CgovLyBwcmUtc2V0IGZvciB2YWx1ZXMgdGhhdCBtYXkgZXhpc3QgaW4gdGhlIGZ1dHVyZQpCdWZmZXIucHJvdG90eXBlLmxlbmd0aCA9IHVuZGVmaW5lZApCdWZmZXIucHJvdG90eXBlLnBhcmVudCA9IHVuZGVmaW5lZAoKLy8gdG9TdHJpbmcoZW5jb2RpbmcsIHN0YXJ0PTAsIGVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKCiAgc3RhcnQgPSBzdGFydCA+Pj4gMAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA9PT0gSW5maW5pdHkgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMAoKICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIGlmIChzdGFydCA8IDApIHN0YXJ0ID0gMAogIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICBpZiAoZW5kIDw9IHN0YXJ0KSByZXR1cm4gJycKCiAgd2hpbGUgKHRydWUpIHsKICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIHJldHVybiBhc2NpaVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiBiaW5hcnlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHV0ZjE2bGVTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAobG93ZXJlZENhc2UpCiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKQogICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgfQogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiAoYikgewogIGlmKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAp9CgpCdWZmZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHN0ciA9ICcnCiAgdmFyIG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMKICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCdoZXgnLCAwLCBtYXgpLm1hdGNoKC8uezJ9L2cpLmpvaW4oJyAnKQogICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KQogICAgICBzdHIgKz0gJyAuLi4gJwogIH0KICByZXR1cm4gJzxCdWZmZXIgJyArIHN0ciArICc+Jwp9CgpCdWZmZXIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiAoYikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGIpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikKfQoKLy8gYGdldGAgd2lsbCBiZSByZW1vdmVkIGluIE5vZGUgMC4xMysKQnVmZmVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAob2Zmc2V0KSB7CiAgY29uc29sZS5sb2coJy5nZXQoKSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdXNpbmcgYXJyYXkgaW5kZXhlcyBpbnN0ZWFkLicpCiAgcmV0dXJuIHRoaXMucmVhZFVJbnQ4KG9mZnNldCkKfQoKLy8gYHNldGAgd2lsbCBiZSByZW1vdmVkIGluIE5vZGUgMC4xMysKQnVmZmVyLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiAodiwgb2Zmc2V0KSB7CiAgY29uc29sZS5sb2coJy5zZXQoKSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdXNpbmcgYXJyYXkgaW5kZXhlcyBpbnN0ZWFkLicpCiAgcmV0dXJuIHRoaXMud3JpdGVVSW50OCh2LCBvZmZzZXQpCn0KCmZ1bmN0aW9uIGhleFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgdmFyIHJlbWFpbmluZyA9IGJ1Zi5sZW5ndGggLSBvZmZzZXQKICBpZiAoIWxlbmd0aCkgewogICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgfSBlbHNlIHsKICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfQogIH0KCiAgLy8gbXVzdCBiZSBhbiBldmVuIG51bWJlciBvZiBkaWdpdHMKICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogIGlmIChzdHJMZW4gJSAyICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCgogIGlmIChsZW5ndGggPiBzdHJMZW4gLyAyKSB7CiAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIHZhciBieXRlID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KQogICAgaWYgKGlzTmFOKGJ5dGUpKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCiAgICBidWZbb2Zmc2V0ICsgaV0gPSBieXRlCiAgfQogIHJldHVybiBpCn0KCmZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgdmFyIGNoYXJzV3JpdHRlbiA9IGJsaXRCdWZmZXIodXRmOFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCmZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHZhciBjaGFyc1dyaXR0ZW4gPSBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIHJldHVybiBjaGFyc1dyaXR0ZW4KfQoKZnVuY3Rpb24gYmluYXJ5V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gYmFzZTY0V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHZhciBjaGFyc1dyaXR0ZW4gPSBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCmZ1bmN0aW9uIHV0ZjE2bGVXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgdmFyIGNoYXJzV3JpdHRlbiA9IGJsaXRCdWZmZXIodXRmMTZsZVRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAvLyBTdXBwb3J0IGJvdGggKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKQogIC8vIGFuZCB0aGUgbGVnYWN5IChzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aCkKICBpZiAoaXNGaW5pdGUob2Zmc2V0KSkgewogICAgaWYgKCFpc0Zpbml0ZShsZW5ndGgpKSB7CiAgICAgIGVuY29kaW5nID0gbGVuZ3RoCiAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgfQogIH0gZWxzZSB7ICAvLyBsZWdhY3kKICAgIHZhciBzd2FwID0gZW5jb2RpbmcKICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICBvZmZzZXQgPSBsZW5ndGgKICAgIGxlbmd0aCA9IHN3YXAKICB9CgogIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDAKICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICBpZiAoIWxlbmd0aCkgewogICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgfSBlbHNlIHsKICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfQogIH0KICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCkKCiAgdmFyIHJldAogIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgIGNhc2UgJ2hleCc6CiAgICAgIHJldCA9IGhleFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgcmV0ID0gdXRmOFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICdhc2NpaSc6CiAgICAgIHJldCA9IGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAgICAgYnJlYWsKICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIHJldCA9IGJpbmFyeVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICdiYXNlNjQnOgogICAgICByZXQgPSBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogICAgICBicmVhawogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0ID0gdXRmMTZsZVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgfQogIHJldHVybiByZXQKfQoKQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHsKICAgIHR5cGU6ICdCdWZmZXInLAogICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgfQp9CgpmdW5jdGlvbiBiYXNlNjRTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICB9IGVsc2UgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1Zi5zbGljZShzdGFydCwgZW5kKSkKICB9Cn0KCmZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJlcyA9ICcnCiAgdmFyIHRtcCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgaWYgKGJ1ZltpXSA8PSAweDdGKSB7CiAgICAgIHJlcyArPSBkZWNvZGVVdGY4Q2hhcih0bXApICsgU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pCiAgICAgIHRtcCA9ICcnCiAgICB9IGVsc2UgewogICAgICB0bXAgKz0gJyUnICsgYnVmW2ldLnRvU3RyaW5nKDE2KQogICAgfQogIH0KCiAgcmV0dXJuIHJlcyArIGRlY29kZVV0ZjhDaGFyKHRtcCkKfQoKZnVuY3Rpb24gYXNjaWlTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJldCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKQogIH0KICByZXR1cm4gcmV0Cn0KCmZ1bmN0aW9uIGJpbmFyeVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gYXNjaWlTbGljZShidWYsIHN0YXJ0LCBlbmQpCn0KCmZ1bmN0aW9uIGhleFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgbGVuID0gYnVmLmxlbmd0aAoKICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pIGVuZCA9IGxlbgoKICB2YXIgb3V0ID0gJycKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICB9CiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB1dGYxNmxlU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogIHZhciByZXMgPSAnJwogIGZvciAodmFyIGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogIH0KICByZXR1cm4gcmVzCn0KCkJ1ZmZlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiAoc3RhcnQsIGVuZCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIHN0YXJ0ID0gfn5zdGFydAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gbGVuIDogfn5lbmQKCiAgaWYgKHN0YXJ0IDwgMCkgewogICAgc3RhcnQgKz0gbGVuOwogICAgaWYgKHN0YXJ0IDwgMCkKICAgICAgc3RhcnQgPSAwCiAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgc3RhcnQgPSBsZW4KICB9CgogIGlmIChlbmQgPCAwKSB7CiAgICBlbmQgKz0gbGVuCiAgICBpZiAoZW5kIDwgMCkKICAgICAgZW5kID0gMAogIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICBlbmQgPSBsZW4KICB9CgogIGlmIChlbmQgPCBzdGFydCkKICAgIGVuZCA9IHN0YXJ0CgogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgcmV0dXJuIEJ1ZmZlci5fYXVnbWVudCh0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpKQogIH0gZWxzZSB7CiAgICB2YXIgc2xpY2VMZW4gPSBlbmQgLSBzdGFydAogICAgdmFyIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCwgdHJ1ZSkKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpY2VMZW47IGkrKykgewogICAgICBuZXdCdWZbaV0gPSB0aGlzW2kgKyBzdGFydF0KICAgIH0KICAgIHJldHVybiBuZXdCdWYKICB9Cn0KCi8qCiAqIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYnVmZmVyIGlzbid0IHRyeWluZyB0byB3cml0ZSBvdXQgb2YgYm91bmRzLgogKi8KZnVuY3Rpb24gY2hlY2tPZmZzZXQgKG9mZnNldCwgZXh0LCBsZW5ndGgpIHsKICBpZiAoKG9mZnNldCAlIDEpICE9PSAwIHx8IG9mZnNldCA8IDApCiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKQogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RyeWluZyB0byBhY2Nlc3MgYmV5b25kIGJ1ZmZlciBsZW5ndGgnKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCA4KSB8IHRoaXNbb2Zmc2V0ICsgMV0KfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUgPSBmdW5jdGlvbiAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gKiAweDEwMDAwMDApICsKICAgICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgdGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgaWYgKCEodGhpc1tvZmZzZXRdICYgMHg4MCkpCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICByZXR1cm4gKCgweGZmIC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAxXSB8ICh0aGlzW29mZnNldF0gPDwgOCkKICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdIDw8IDI0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdEJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKfQoKZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ2J1ZmZlciBtdXN0IGJlIGEgQnVmZmVyIGluc3RhbmNlJykKICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhbHVlIGlzIG91dCBvZiBib3VuZHMnKQogIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdpbmRleCBvdXQgb2YgcmFuZ2UnKQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDggPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweGZmLCAwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICB0aGlzW29mZnNldF0gPSB2YWx1ZQogIHJldHVybiBvZmZzZXQgKyAxCn0KCmZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDE2IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCAyKTsgaSA8IGo7IGkrKykgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlICYgKDB4ZmYgPDwgKDggKiAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSkpKSA+Pj4KICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgfQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCA0KTsgaSA8IGo7IGkrKykgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkxFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgPj4+IDAKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZQogIH0gZWxzZSBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwCiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4N2YsIC0weDgwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmYgKyB2YWx1ZSArIDEKICB0aGlzW29mZnNldF0gPSB2YWx1ZQogIHJldHVybiBvZmZzZXQgKyAxCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgPj4+IDAKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgfSBlbHNlIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJCRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwCiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZQogIH0gZWxzZSBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpmdW5jdGlvbiBjaGVja0lFRUU3NTQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsdWUgaXMgb3V0IG9mIGJvdW5kcycpCiAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ2luZGV4IG91dCBvZiByYW5nZScpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRMRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGUgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCwgLTEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4KQogIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogIHJldHVybiBvZmZzZXQgKyA4Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVMRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKLy8gY29weSh0YXJnZXRCdWZmZXIsIHRhcmdldFN0YXJ0PTAsIHNvdXJjZVN0YXJ0PTAsIHNvdXJjZUVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiAodGFyZ2V0LCB0YXJnZXRfc3RhcnQsIHN0YXJ0LCBlbmQpIHsKICB2YXIgc291cmNlID0gdGhpcwoKICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoCiAgaWYgKCF0YXJnZXRfc3RhcnQpIHRhcmdldF9zdGFydCA9IDAKCiAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCiAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybgogIGlmICh0YXJnZXQubGVuZ3RoID09PSAwIHx8IHNvdXJjZS5sZW5ndGggPT09IDApIHJldHVybgoKICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgaWYgKGVuZCA8IHN0YXJ0KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzb3VyY2VFbmQgPCBzb3VyY2VTdGFydCcpCiAgaWYgKHRhcmdldF9zdGFydCA8IDAgfHwgdGFyZ2V0X3N0YXJ0ID49IHRhcmdldC5sZW5ndGgpCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHNvdXJjZS5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3NvdXJjZVN0YXJ0IG91dCBvZiBib3VuZHMnKQogIGlmIChlbmQgPCAwIHx8IGVuZCA+IHNvdXJjZS5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3NvdXJjZUVuZCBvdXQgb2YgYm91bmRzJykKCiAgLy8gQXJlIHdlIG9vYj8KICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpCiAgICBlbmQgPSB0aGlzLmxlbmd0aAogIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0X3N0YXJ0IDwgZW5kIC0gc3RhcnQpCiAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0X3N0YXJ0ICsgc3RhcnQKCiAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CgogIGlmIChsZW4gPCAxMDAgfHwgIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHRhcmdldFtpICsgdGFyZ2V0X3N0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgfQogIH0gZWxzZSB7CiAgICB0YXJnZXQuX3NldCh0aGlzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIGxlbiksIHRhcmdldF9zdGFydCkKICB9Cn0KCi8vIGZpbGwodmFsdWUsIHN0YXJ0PTAsIGVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiAodmFsdWUsIHN0YXJ0LCBlbmQpIHsKICBpZiAoIXZhbHVlKSB2YWx1ZSA9IDAKICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICBpZiAoIWVuZCkgZW5kID0gdGhpcy5sZW5ndGgKCiAgaWYgKGVuZCA8IHN0YXJ0KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmQgPCBzdGFydCcpCgogIC8vIEZpbGwgMCBieXRlczsgd2UncmUgZG9uZQogIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4KICBpZiAodGhpcy5sZW5ndGggPT09IDApIHJldHVybgoKICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzdGFydCBvdXQgb2YgYm91bmRzJykKICBpZiAoZW5kIDwgMCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5kIG91dCBvZiBib3VuZHMnKQoKICB2YXIgaQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7CiAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7CiAgICAgIHRoaXNbaV0gPSB2YWx1ZQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgYnl0ZXMgPSB1dGY4VG9CeXRlcyh2YWx1ZS50b1N0cmluZygpKQogICAgdmFyIGxlbiA9IGJ5dGVzLmxlbmd0aAogICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICB0aGlzW2ldID0gYnl0ZXNbaSAlIGxlbl0KICAgIH0KICB9CgogIHJldHVybiB0aGlzCn0KCi8qKgogKiBDcmVhdGVzIGEgbmV3IGBBcnJheUJ1ZmZlcmAgd2l0aCB0aGUgKmNvcGllZCogbWVtb3J5IG9mIHRoZSBidWZmZXIgaW5zdGFuY2UuCiAqIEFkZGVkIGluIE5vZGUgMC4xMi4gT25seSBhdmFpbGFibGUgaW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IEFycmF5QnVmZmVyLgogKi8KQnVmZmVyLnByb3RvdHlwZS50b0FycmF5QnVmZmVyID0gZnVuY3Rpb24gKCkgewogIGlmICh0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICByZXR1cm4gKG5ldyBCdWZmZXIodGhpcykpLmJ1ZmZlcgogICAgfSBlbHNlIHsKICAgICAgdmFyIGJ1ZiA9IG5ldyBVaW50OEFycmF5KHRoaXMubGVuZ3RoKQogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYnVmLmxlbmd0aDsgaSA8IGxlbjsgaSArPSAxKSB7CiAgICAgICAgYnVmW2ldID0gdGhpc1tpXQogICAgICB9CiAgICAgIHJldHVybiBidWYuYnVmZmVyCiAgICB9CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0J1ZmZlci50b0FycmF5QnVmZmVyIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyJykKICB9Cn0KCi8vIEhFTFBFUiBGVU5DVElPTlMKLy8gPT09PT09PT09PT09PT09PQoKdmFyIEJQID0gQnVmZmVyLnByb3RvdHlwZQoKLyoqCiAqIEF1Z21lbnQgYSBVaW50OEFycmF5ICppbnN0YW5jZSogKG5vdCB0aGUgVWludDhBcnJheSBjbGFzcyEpIHdpdGggQnVmZmVyIG1ldGhvZHMKICovCkJ1ZmZlci5fYXVnbWVudCA9IGZ1bmN0aW9uIChhcnIpIHsKICBhcnIuX2lzQnVmZmVyID0gdHJ1ZQoKICAvLyBzYXZlIHJlZmVyZW5jZSB0byBvcmlnaW5hbCBVaW50OEFycmF5IGdldC9zZXQgbWV0aG9kcyBiZWZvcmUgb3ZlcndyaXRpbmcKICBhcnIuX2dldCA9IGFyci5nZXQKICBhcnIuX3NldCA9IGFyci5zZXQKCiAgLy8gZGVwcmVjYXRlZCwgd2lsbCBiZSByZW1vdmVkIGluIG5vZGUgMC4xMysKICBhcnIuZ2V0ID0gQlAuZ2V0CiAgYXJyLnNldCA9IEJQLnNldAoKICBhcnIud3JpdGUgPSBCUC53cml0ZQogIGFyci50b1N0cmluZyA9IEJQLnRvU3RyaW5nCiAgYXJyLnRvTG9jYWxlU3RyaW5nID0gQlAudG9TdHJpbmcKICBhcnIudG9KU09OID0gQlAudG9KU09OCiAgYXJyLmVxdWFscyA9IEJQLmVxdWFscwogIGFyci5jb21wYXJlID0gQlAuY29tcGFyZQogIGFyci5jb3B5ID0gQlAuY29weQogIGFyci5zbGljZSA9IEJQLnNsaWNlCiAgYXJyLnJlYWRVSW50OCA9IEJQLnJlYWRVSW50OAogIGFyci5yZWFkVUludDE2TEUgPSBCUC5yZWFkVUludDE2TEUKICBhcnIucmVhZFVJbnQxNkJFID0gQlAucmVhZFVJbnQxNkJFCiAgYXJyLnJlYWRVSW50MzJMRSA9IEJQLnJlYWRVSW50MzJMRQogIGFyci5yZWFkVUludDMyQkUgPSBCUC5yZWFkVUludDMyQkUKICBhcnIucmVhZEludDggPSBCUC5yZWFkSW50OAogIGFyci5yZWFkSW50MTZMRSA9IEJQLnJlYWRJbnQxNkxFCiAgYXJyLnJlYWRJbnQxNkJFID0gQlAucmVhZEludDE2QkUKICBhcnIucmVhZEludDMyTEUgPSBCUC5yZWFkSW50MzJMRQogIGFyci5yZWFkSW50MzJCRSA9IEJQLnJlYWRJbnQzMkJFCiAgYXJyLnJlYWRGbG9hdExFID0gQlAucmVhZEZsb2F0TEUKICBhcnIucmVhZEZsb2F0QkUgPSBCUC5yZWFkRmxvYXRCRQogIGFyci5yZWFkRG91YmxlTEUgPSBCUC5yZWFkRG91YmxlTEUKICBhcnIucmVhZERvdWJsZUJFID0gQlAucmVhZERvdWJsZUJFCiAgYXJyLndyaXRlVUludDggPSBCUC53cml0ZVVJbnQ4CiAgYXJyLndyaXRlVUludDE2TEUgPSBCUC53cml0ZVVJbnQxNkxFCiAgYXJyLndyaXRlVUludDE2QkUgPSBCUC53cml0ZVVJbnQxNkJFCiAgYXJyLndyaXRlVUludDMyTEUgPSBCUC53cml0ZVVJbnQzMkxFCiAgYXJyLndyaXRlVUludDMyQkUgPSBCUC53cml0ZVVJbnQzMkJFCiAgYXJyLndyaXRlSW50OCA9IEJQLndyaXRlSW50OAogIGFyci53cml0ZUludDE2TEUgPSBCUC53cml0ZUludDE2TEUKICBhcnIud3JpdGVJbnQxNkJFID0gQlAud3JpdGVJbnQxNkJFCiAgYXJyLndyaXRlSW50MzJMRSA9IEJQLndyaXRlSW50MzJMRQogIGFyci53cml0ZUludDMyQkUgPSBCUC53cml0ZUludDMyQkUKICBhcnIud3JpdGVGbG9hdExFID0gQlAud3JpdGVGbG9hdExFCiAgYXJyLndyaXRlRmxvYXRCRSA9IEJQLndyaXRlRmxvYXRCRQogIGFyci53cml0ZURvdWJsZUxFID0gQlAud3JpdGVEb3VibGVMRQogIGFyci53cml0ZURvdWJsZUJFID0gQlAud3JpdGVEb3VibGVCRQogIGFyci5maWxsID0gQlAuZmlsbAogIGFyci5pbnNwZWN0ID0gQlAuaW5zcGVjdAogIGFyci50b0FycmF5QnVmZmVyID0gQlAudG9BcnJheUJ1ZmZlcgoKICByZXR1cm4gYXJyCn0KCnZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtel0vZwoKZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKICBzdHIgPSBzdHJpbmd0cmltKHN0cikucmVwbGFjZShJTlZBTElEX0JBU0U2NF9SRSwgJycpCiAgLy8gTm9kZSBhbGxvd3MgZm9yIG5vbi1wYWRkZWQgYmFzZTY0IHN0cmluZ3MgKG1pc3NpbmcgdHJhaWxpbmcgPT09KSwgYmFzZTY0LWpzIGRvZXMgbm90CiAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICBzdHIgPSBzdHIgKyAnPScKICB9CiAgcmV0dXJuIHN0cgp9CgpmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICBpZiAoc3RyLnRyaW0pIHJldHVybiBzdHIudHJpbSgpCiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCn0KCmZ1bmN0aW9uIGlzQXJyYXlpc2ggKHN1YmplY3QpIHsKICByZXR1cm4gaXNBcnJheShzdWJqZWN0KSB8fCBCdWZmZXIuaXNCdWZmZXIoc3ViamVjdCkgfHwKICAgICAgc3ViamVjdCAmJiB0eXBlb2Ygc3ViamVjdCA9PT0gJ29iamVjdCcgJiYKICAgICAgdHlwZW9mIHN1YmplY3QubGVuZ3RoID09PSAnbnVtYmVyJwp9CgpmdW5jdGlvbiB0b0hleCAobikgewogIGlmIChuIDwgMTYpIHJldHVybiAnMCcgKyBuLnRvU3RyaW5nKDE2KQogIHJldHVybiBuLnRvU3RyaW5nKDE2KQp9CgpmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyKSB7CiAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgIHZhciBiID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgIGlmIChiIDw9IDB4N0YpIHsKICAgICAgYnl0ZUFycmF5LnB1c2goYikKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzdGFydCA9IGkKICAgICAgaWYgKGIgPj0gMHhEODAwICYmIGIgPD0gMHhERkZGKSBpKysKICAgICAgdmFyIGggPSBlbmNvZGVVUklDb21wb25lbnQoc3RyLnNsaWNlKHN0YXJ0LCBpKzEpKS5zdWJzdHIoMSkuc3BsaXQoJyUnKQogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGgubGVuZ3RoOyBqKyspIHsKICAgICAgICBieXRlQXJyYXkucHVzaChwYXJzZUludChoW2pdLCAxNikpCiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiBhc2NpaVRvQnl0ZXMgKHN0cikgewogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICAvLyBOb2RlJ3MgY29kZSBzZWVtcyB0byBiZSBkb2luZyB0aGlzIGFuZCBub3QgJiAweDdGLi4KICAgIGJ5dGVBcnJheS5wdXNoKHN0ci5jaGFyQ29kZUF0KGkpICYgMHhGRikKICB9CiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiB1dGYxNmxlVG9CeXRlcyAoc3RyKSB7CiAgdmFyIGMsIGhpLCBsbwogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgIGhpID0gYyA+PiA4CiAgICBsbyA9IGMgJSAyNTYKICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgYnl0ZUFycmF5LnB1c2goaGkpCiAgfQoKICByZXR1cm4gYnl0ZUFycmF5Cn0KCmZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewogIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoc3RyKQp9CgpmdW5jdGlvbiBibGl0QnVmZmVyIChzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpCiAgICAgIGJyZWFrCiAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV0KICB9CiAgcmV0dXJuIGkKfQoKZnVuY3Rpb24gZGVjb2RlVXRmOENoYXIgKHN0cikgewogIHRyeSB7CiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0cikKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4RkZGRCkgLy8gVVRGIDggaW52YWxpZCBjaGFyCiAgfQp9Cgp9LHsiYmFzZTY0LWpzIjo1NCwiaWVlZTc1NCI6NTUsImlzLWFycmF5Ijo1Nn1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGxvb2t1cCA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJzsKCjsoZnVuY3Rpb24gKGV4cG9ydHMpIHsKCSd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFyciA9ICh0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpCiAgICA/IFVpbnQ4QXJyYXkKICAgIDogQXJyYXkKCgl2YXIgUExVUyAgID0gJysnLmNoYXJDb2RlQXQoMCkKCXZhciBTTEFTSCAgPSAnLycuY2hhckNvZGVBdCgwKQoJdmFyIE5VTUJFUiA9ICcwJy5jaGFyQ29kZUF0KDApCgl2YXIgTE9XRVIgID0gJ2EnLmNoYXJDb2RlQXQoMCkKCXZhciBVUFBFUiAgPSAnQScuY2hhckNvZGVBdCgwKQoKCWZ1bmN0aW9uIGRlY29kZSAoZWx0KSB7CgkJdmFyIGNvZGUgPSBlbHQuY2hhckNvZGVBdCgwKQoJCWlmIChjb2RlID09PSBQTFVTKQoJCQlyZXR1cm4gNjIgLy8gJysnCgkJaWYgKGNvZGUgPT09IFNMQVNIKQoJCQlyZXR1cm4gNjMgLy8gJy8nCgkJaWYgKGNvZGUgPCBOVU1CRVIpCgkJCXJldHVybiAtMSAvL25vIG1hdGNoCgkJaWYgKGNvZGUgPCBOVU1CRVIgKyAxMCkKCQkJcmV0dXJuIGNvZGUgLSBOVU1CRVIgKyAyNiArIDI2CgkJaWYgKGNvZGUgPCBVUFBFUiArIDI2KQoJCQlyZXR1cm4gY29kZSAtIFVQUEVSCgkJaWYgKGNvZGUgPCBMT1dFUiArIDI2KQoJCQlyZXR1cm4gY29kZSAtIExPV0VSICsgMjYKCX0KCglmdW5jdGlvbiBiNjRUb0J5dGVBcnJheSAoYjY0KSB7CgkJdmFyIGksIGosIGwsIHRtcCwgcGxhY2VIb2xkZXJzLCBhcnIKCgkJaWYgKGI2NC5sZW5ndGggJSA0ID4gMCkgewoJCQl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQnKQoJCX0KCgkJLy8gdGhlIG51bWJlciBvZiBlcXVhbCBzaWducyAocGxhY2UgaG9sZGVycykKCQkvLyBpZiB0aGVyZSBhcmUgdHdvIHBsYWNlaG9sZGVycywgdGhhbiB0aGUgdHdvIGNoYXJhY3RlcnMgYmVmb3JlIGl0CgkJLy8gcmVwcmVzZW50IG9uZSBieXRlCgkJLy8gaWYgdGhlcmUgaXMgb25seSBvbmUsIHRoZW4gdGhlIHRocmVlIGNoYXJhY3RlcnMgYmVmb3JlIGl0IHJlcHJlc2VudCAyIGJ5dGVzCgkJLy8gdGhpcyBpcyBqdXN0IGEgY2hlYXAgaGFjayB0byBub3QgZG8gaW5kZXhPZiB0d2ljZQoJCXZhciBsZW4gPSBiNjQubGVuZ3RoCgkJcGxhY2VIb2xkZXJzID0gJz0nID09PSBiNjQuY2hhckF0KGxlbiAtIDIpID8gMiA6ICc9JyA9PT0gYjY0LmNoYXJBdChsZW4gLSAxKSA/IDEgOiAwCgoJCS8vIGJhc2U2NCBpcyA0LzMgKyB1cCB0byB0d28gY2hhcmFjdGVycyBvZiB0aGUgb3JpZ2luYWwgZGF0YQoJCWFyciA9IG5ldyBBcnIoYjY0Lmxlbmd0aCAqIDMgLyA0IC0gcGxhY2VIb2xkZXJzKQoKCQkvLyBpZiB0aGVyZSBhcmUgcGxhY2Vob2xkZXJzLCBvbmx5IGdldCB1cCB0byB0aGUgbGFzdCBjb21wbGV0ZSA0IGNoYXJzCgkJbCA9IHBsYWNlSG9sZGVycyA+IDAgPyBiNjQubGVuZ3RoIC0gNCA6IGI2NC5sZW5ndGgKCgkJdmFyIEwgPSAwCgoJCWZ1bmN0aW9uIHB1c2ggKHYpIHsKCQkJYXJyW0wrK10gPSB2CgkJfQoKCQlmb3IgKGkgPSAwLCBqID0gMDsgaSA8IGw7IGkgKz0gNCwgaiArPSAzKSB7CgkJCXRtcCA9IChkZWNvZGUoYjY0LmNoYXJBdChpKSkgPDwgMTgpIHwgKGRlY29kZShiNjQuY2hhckF0KGkgKyAxKSkgPDwgMTIpIHwgKGRlY29kZShiNjQuY2hhckF0KGkgKyAyKSkgPDwgNikgfCBkZWNvZGUoYjY0LmNoYXJBdChpICsgMykpCgkJCXB1c2goKHRtcCAmIDB4RkYwMDAwKSA+PiAxNikKCQkJcHVzaCgodG1wICYgMHhGRjAwKSA+PiA4KQoJCQlwdXNoKHRtcCAmIDB4RkYpCgkJfQoKCQlpZiAocGxhY2VIb2xkZXJzID09PSAyKSB7CgkJCXRtcCA9IChkZWNvZGUoYjY0LmNoYXJBdChpKSkgPDwgMikgfCAoZGVjb2RlKGI2NC5jaGFyQXQoaSArIDEpKSA+PiA0KQoJCQlwdXNoKHRtcCAmIDB4RkYpCgkJfSBlbHNlIGlmIChwbGFjZUhvbGRlcnMgPT09IDEpIHsKCQkJdG1wID0gKGRlY29kZShiNjQuY2hhckF0KGkpKSA8PCAxMCkgfCAoZGVjb2RlKGI2NC5jaGFyQXQoaSArIDEpKSA8PCA0KSB8IChkZWNvZGUoYjY0LmNoYXJBdChpICsgMikpID4+IDIpCgkJCXB1c2goKHRtcCA+PiA4KSAmIDB4RkYpCgkJCXB1c2godG1wICYgMHhGRikKCQl9CgoJCXJldHVybiBhcnIKCX0KCglmdW5jdGlvbiB1aW50OFRvQmFzZTY0ICh1aW50OCkgewoJCXZhciBpLAoJCQlleHRyYUJ5dGVzID0gdWludDgubGVuZ3RoICUgMywgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKCQkJb3V0cHV0ID0gIiIsCgkJCXRlbXAsIGxlbmd0aAoKCQlmdW5jdGlvbiBlbmNvZGUgKG51bSkgewoJCQlyZXR1cm4gbG9va3VwLmNoYXJBdChudW0pCgkJfQoKCQlmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQgKG51bSkgewoJCQlyZXR1cm4gZW5jb2RlKG51bSA+PiAxOCAmIDB4M0YpICsgZW5jb2RlKG51bSA+PiAxMiAmIDB4M0YpICsgZW5jb2RlKG51bSA+PiA2ICYgMHgzRikgKyBlbmNvZGUobnVtICYgMHgzRikKCQl9CgoJCS8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKCQlmb3IgKGkgPSAwLCBsZW5ndGggPSB1aW50OC5sZW5ndGggLSBleHRyYUJ5dGVzOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKCQkJdGVtcCA9ICh1aW50OFtpXSA8PCAxNikgKyAodWludDhbaSArIDFdIDw8IDgpICsgKHVpbnQ4W2kgKyAyXSkKCQkJb3V0cHV0ICs9IHRyaXBsZXRUb0Jhc2U2NCh0ZW1wKQoJCX0KCgkJLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwoJCXN3aXRjaCAoZXh0cmFCeXRlcykgewoJCQljYXNlIDE6CgkJCQl0ZW1wID0gdWludDhbdWludDgubGVuZ3RoIC0gMV0KCQkJCW91dHB1dCArPSBlbmNvZGUodGVtcCA+PiAyKQoJCQkJb3V0cHV0ICs9IGVuY29kZSgodGVtcCA8PCA0KSAmIDB4M0YpCgkJCQlvdXRwdXQgKz0gJz09JwoJCQkJYnJlYWsKCQkJY2FzZSAyOgoJCQkJdGVtcCA9ICh1aW50OFt1aW50OC5sZW5ndGggLSAyXSA8PCA4KSArICh1aW50OFt1aW50OC5sZW5ndGggLSAxXSkKCQkJCW91dHB1dCArPSBlbmNvZGUodGVtcCA+PiAxMCkKCQkJCW91dHB1dCArPSBlbmNvZGUoKHRlbXAgPj4gNCkgJiAweDNGKQoJCQkJb3V0cHV0ICs9IGVuY29kZSgodGVtcCA8PCAyKSAmIDB4M0YpCgkJCQlvdXRwdXQgKz0gJz0nCgkJCQlicmVhawoJCX0KCgkJcmV0dXJuIG91dHB1dAoJfQoKCWV4cG9ydHMudG9CeXRlQXJyYXkgPSBiNjRUb0J5dGVBcnJheQoJZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gdWludDhUb0Jhc2U2NAp9KHR5cGVvZiBleHBvcnRzID09PSAndW5kZWZpbmVkJyA/ICh0aGlzLmJhc2U2NGpzID0ge30pIDogZXhwb3J0cykpCgp9LHt9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICB2YXIgZSwgbSwKICAgICAgZUxlbiA9IG5CeXRlcyAqIDggLSBtTGVuIC0gMSwKICAgICAgZU1heCA9ICgxIDw8IGVMZW4pIC0gMSwKICAgICAgZUJpYXMgPSBlTWF4ID4+IDEsCiAgICAgIG5CaXRzID0gLTcsCiAgICAgIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMCwKICAgICAgZCA9IGlzTEUgPyAtMSA6IDEsCiAgICAgIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV07CgogIGkgKz0gZDsKCiAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgcyA+Pj0gKC1uQml0cyk7CiAgbkJpdHMgKz0gZUxlbjsKICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gZSAqIDI1NiArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KTsKCiAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgZSA+Pj0gKC1uQml0cyk7CiAgbkJpdHMgKz0gbUxlbjsKICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gbSAqIDI1NiArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KTsKCiAgaWYgKGUgPT09IDApIHsKICAgIGUgPSAxIC0gZUJpYXM7CiAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CiAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSk7CiAgfSBlbHNlIHsKICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbik7CiAgICBlID0gZSAtIGVCaWFzOwogIH0KICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKTsKfTsKCmV4cG9ydHMud3JpdGUgPSBmdW5jdGlvbihidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogIHZhciBlLCBtLCBjLAogICAgICBlTGVuID0gbkJ5dGVzICogOCAtIG1MZW4gLSAxLAogICAgICBlTWF4ID0gKDEgPDwgZUxlbikgLSAxLAogICAgICBlQmlhcyA9IGVNYXggPj4gMSwKICAgICAgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApLAogICAgICBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSksCiAgICAgIGQgPSBpc0xFID8gMSA6IC0xLAogICAgICBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwOwoKICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKCiAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gSW5maW5pdHkpIHsKICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMDsKICAgIGUgPSBlTWF4OwogIH0gZWxzZSB7CiAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMik7CiAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgIGUtLTsKICAgICAgYyAqPSAyOwogICAgfQogICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgIHZhbHVlICs9IHJ0IC8gYzsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlICs9IHJ0ICogTWF0aC5wb3coMiwgMSAtIGVCaWFzKTsKICAgIH0KICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICBlKys7CiAgICAgIGMgLz0gMjsKICAgIH0KCiAgICBpZiAoZSArIGVCaWFzID49IGVNYXgpIHsKICAgICAgbSA9IDA7CiAgICAgIGUgPSBlTWF4OwogICAgfSBlbHNlIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICBtID0gKHZhbHVlICogYyAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgIGUgPSBlICsgZUJpYXM7CiAgICB9IGVsc2UgewogICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgIGUgPSAwOwogICAgfQogIH0KCiAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCk7CgogIGUgPSAoZSA8PCBtTGVuKSB8IG07CiAgZUxlbiArPSBtTGVuOwogIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCk7CgogIGJ1ZmZlcltvZmZzZXQgKyBpIC0gZF0gfD0gcyAqIDEyODsKfTsKCn0se31dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKCi8qKgogKiBpc0FycmF5CiAqLwoKdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwoKLyoqCiAqIHRvU3RyaW5nCiAqLwoKdmFyIHN0ciA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovKioKICogV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGB2YWxgCiAqIGlzIGFuIGFycmF5LgogKgogKiBleGFtcGxlOgogKgogKiAgICAgICAgaXNBcnJheShbXSk7CiAqICAgICAgICAvLyA+IHRydWUKICogICAgICAgIGlzQXJyYXkoYXJndW1lbnRzKTsKICogICAgICAgIC8vID4gZmFsc2UKICogICAgICAgIGlzQXJyYXkoJycpOwogKiAgICAgICAgLy8gPiBmYWxzZQogKgogKiBAcGFyYW0ge21peGVkfSB2YWwKICogQHJldHVybiB7Ym9vbH0KICovCgptb2R1bGUuZXhwb3J0cyA9IGlzQXJyYXkgfHwgZnVuY3Rpb24gKHZhbCkgewogIHJldHVybiAhISB2YWwgJiYgJ1tvYmplY3QgQXJyYXldJyA9PSBzdHIuY2FsbCh2YWwpOwp9OwoKfSx7fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgpmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwogIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7Cn0KbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CgovLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwoKLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCi8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuCkV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CgovLyBPYnZpb3VzbHkgbm90IGFsbCBFbWl0dGVycyBzaG91bGQgYmUgbGltaXRlZCB0byAxMC4gVGhpcyBmdW5jdGlvbiBhbGxvd3MKLy8gdGhhdCB0byBiZSBpbmNyZWFzZWQuIFNldCB0byB6ZXJvIGZvciB1bmxpbWl0ZWQuCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogIGlmICghaXNOdW1iZXIobikgfHwgbiA8IDAgfHwgaXNOYU4obikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ24gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlcicpOwogIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICB0aGlzLl9ldmVudHMgPSB7fTsKCiAgLy8gSWYgdGhlcmUgaXMgbm8gJ2Vycm9yJyBldmVudCBsaXN0ZW5lciB0aGVuIHRocm93LgogIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgIChpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICBlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICB0aHJvdyBlcjsgLy8gVW5oYW5kbGVkICdlcnJvcicgZXZlbnQKICAgICAgfQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LicpOwogICAgfQogIH0KCiAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgaWYgKGlzVW5kZWZpbmVkKGhhbmRsZXIpKQogICAgcmV0dXJuIGZhbHNlOwoKICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIC8vIGZhc3QgY2FzZXMKICAgICAgY2FzZSAxOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgLy8gc2xvd2VyCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgICBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW47IGkrKykKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgewogICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuOyBpKyspCiAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwoKICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICB9CgogIHJldHVybiB0cnVlOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgdmFyIG07CgogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgogIGlmICh0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIpCiAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CiAgICAgICAgICAgICAgbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lcik7CgogIGlmICghdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICBlbHNlIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgogICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogIGVsc2UKICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgogICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwoKICAvLyBDaGVjayBmb3IgbGlzdGVuZXIgbGVhawogIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICB2YXIgbTsKICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwogICAgfSBlbHNlIHsKICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgfQoKICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQgPSB0cnVlOwogICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAnVXNlIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKCkgdG8gaW5jcmVhc2UgbGltaXQuJywKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gbm90IHN1cHBvcnRlZCBpbiBJRSAxMAogICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIHZhciBmaXJlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBnKCkgewogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKCiAgICBpZiAoIWZpcmVkKSB7CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICB0aGlzLm9uKHR5cGUsIGcpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwoKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldHVybiB0aGlzOwoKICBsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogIHBvc2l0aW9uID0gLTE7CgogIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fAogICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoKICB9IGVsc2UgaWYgKGlzT2JqZWN0KGxpc3QpKSB7CiAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAogICAgICAgICAgKGxpc3RbaV0ubGlzdGVuZXIgJiYgbGlzdFtpXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYgKHBvc2l0aW9uIDwgMCkKICAgICAgcmV0dXJuIHRoaXM7CgogICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIH0gZWxzZSB7CiAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgIH0KCiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIga2V5LCBsaXN0ZW5lcnM7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgcmV0dXJuIHRoaXM7CgogIC8vIG5vdCBsaXN0ZW5pbmcgZm9yIHJlbW92ZUxpc3RlbmVyLCBubyBuZWVkIHRvIGVtaXQKICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBlbWl0IHJlbW92ZUxpc3RlbmVyIGZvciBhbGwgbGlzdGVuZXJzIG9uIGFsbCBldmVudHMKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOwogICAgfQogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJyk7CiAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgfSBlbHNlIHsKICAgIC8vIExJRk8gb3JkZXIKICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogIH0KICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogIHZhciByZXQ7CiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldCA9IFtdOwogIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwogIGVsc2UKICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogIHJldHVybiByZXQ7Cn07CgpFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICB2YXIgcmV0OwogIGlmICghZW1pdHRlci5fZXZlbnRzIHx8ICFlbWl0dGVyLl9ldmVudHNbdHlwZV0pCiAgICByZXQgPSAwOwogIGVsc2UgaWYgKGlzRnVuY3Rpb24oZW1pdHRlci5fZXZlbnRzW3R5cGVdKSkKICAgIHJldCA9IDE7CiAgZWxzZQogICAgcmV0ID0gZW1pdHRlci5fZXZlbnRzW3R5cGVdLmxlbmd0aDsKICByZXR1cm4gcmV0Owp9OwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CgpmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09PSB2b2lkIDA7Cn0KCn0se31dLDU4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChhcnIpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCn0se31dLDU5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKLy8gcmVzb2x2ZXMgLiBhbmQgLi4gZWxlbWVudHMgaW4gYSBwYXRoIGFycmF5IHdpdGggZGlyZWN0b3J5IG5hbWVzIHRoZXJlCi8vIG11c3QgYmUgbm8gc2xhc2hlcywgZW1wdHkgZWxlbWVudHMsIG9yIGRldmljZSBuYW1lcyAoYzpcKSBpbiB0aGUgYXJyYXkKLy8gKHNvIGFsc28gbm8gbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcyAtIGl0IGRvZXMgbm90IGRpc3Rpbmd1aXNoCi8vIHJlbGF0aXZlIGFuZCBhYnNvbHV0ZSBwYXRocykKZnVuY3Rpb24gbm9ybWFsaXplQXJyYXkocGFydHMsIGFsbG93QWJvdmVSb290KSB7CiAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICB2YXIgdXAgPSAwOwogIGZvciAodmFyIGkgPSBwYXJ0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgdmFyIGxhc3QgPSBwYXJ0c1tpXTsKICAgIGlmIChsYXN0ID09PSAnLicpIHsKICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgIHBhcnRzLnNwbGljZShpLCAxKTsKICAgICAgdXArKzsKICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgICB1cC0tOwogICAgfQogIH0KCiAgLy8gaWYgdGhlIHBhdGggaXMgYWxsb3dlZCB0byBnbyBhYm92ZSB0aGUgcm9vdCwgcmVzdG9yZSBsZWFkaW5nIC4ucwogIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgZm9yICg7IHVwLS07IHVwKSB7CiAgICAgIHBhcnRzLnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgfQoKICByZXR1cm4gcGFydHM7Cn0KCi8vIFNwbGl0IGEgZmlsZW5hbWUgaW50byBbcm9vdCwgZGlyLCBiYXNlbmFtZSwgZXh0XSwgdW5peCB2ZXJzaW9uCi8vICdyb290JyBpcyBqdXN0IGEgc2xhc2gsIG9yIG5vdGhpbmcuCnZhciBzcGxpdFBhdGhSZSA9CiAgICAvXihcLz98KShbXHNcU10qPykoKD86XC57MSwyfXxbXlwvXSs/fCkoXC5bXi5cL10qfCkpKD86W1wvXSopJC87CnZhciBzcGxpdFBhdGggPSBmdW5jdGlvbihmaWxlbmFtZSkgewogIHJldHVybiBzcGxpdFBhdGhSZS5leGVjKGZpbGVuYW1lKS5zbGljZSgxKTsKfTsKCi8vIHBhdGgucmVzb2x2ZShbZnJvbSAuLi5dLCB0bykKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLnJlc29sdmUgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzb2x2ZWRQYXRoID0gJycsCiAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZTsKCiAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgIHZhciBwYXRoID0gKGkgPj0gMCkgPyBhcmd1bWVudHNbaV0gOiBwcm9jZXNzLmN3ZCgpOwoKICAgIC8vIFNraXAgZW1wdHkgYW5kIGludmFsaWQgZW50cmllcwogICAgaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudHMgdG8gcGF0aC5yZXNvbHZlIG11c3QgYmUgc3RyaW5ncycpOwogICAgfSBlbHNlIGlmICghcGF0aCkgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgJy8nICsgcmVzb2x2ZWRQYXRoOwogICAgcmVzb2x2ZWRBYnNvbHV0ZSA9IHBhdGguY2hhckF0KDApID09PSAnLyc7CiAgfQoKICAvLyBBdCB0aGlzIHBvaW50IHRoZSBwYXRoIHNob3VsZCBiZSByZXNvbHZlZCB0byBhIGZ1bGwgYWJzb2x1dGUgcGF0aCwgYnV0CiAgLy8gaGFuZGxlIHJlbGF0aXZlIHBhdGhzIHRvIGJlIHNhZmUgKG1pZ2h0IGhhcHBlbiB3aGVuIHByb2Nlc3MuY3dkKCkgZmFpbHMpCgogIC8vIE5vcm1hbGl6ZSB0aGUgcGF0aAogIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZUFycmF5KGZpbHRlcihyZXNvbHZlZFBhdGguc3BsaXQoJy8nKSwgZnVuY3Rpb24ocCkgewogICAgcmV0dXJuICEhcDsKICB9KSwgIXJlc29sdmVkQWJzb2x1dGUpLmpvaW4oJy8nKTsKCiAgcmV0dXJuICgocmVzb2x2ZWRBYnNvbHV0ZSA/ICcvJyA6ICcnKSArIHJlc29sdmVkUGF0aCkgfHwgJy4nOwp9OwoKLy8gcGF0aC5ub3JtYWxpemUocGF0aCkKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHBhdGgpIHsKICB2YXIgaXNBYnNvbHV0ZSA9IGV4cG9ydHMuaXNBYnNvbHV0ZShwYXRoKSwKICAgICAgdHJhaWxpbmdTbGFzaCA9IHN1YnN0cihwYXRoLCAtMSkgPT09ICcvJzsKCiAgLy8gTm9ybWFsaXplIHRoZSBwYXRoCiAgcGF0aCA9IG5vcm1hbGl6ZUFycmF5KGZpbHRlcihwYXRoLnNwbGl0KCcvJyksIGZ1bmN0aW9uKHApIHsKICAgIHJldHVybiAhIXA7CiAgfSksICFpc0Fic29sdXRlKS5qb2luKCcvJyk7CgogIGlmICghcGF0aCAmJiAhaXNBYnNvbHV0ZSkgewogICAgcGF0aCA9ICcuJzsKICB9CiAgaWYgKHBhdGggJiYgdHJhaWxpbmdTbGFzaCkgewogICAgcGF0aCArPSAnLyc7CiAgfQoKICByZXR1cm4gKGlzQWJzb2x1dGUgPyAnLycgOiAnJykgKyBwYXRoOwp9OwoKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLmlzQWJzb2x1dGUgPSBmdW5jdGlvbihwYXRoKSB7CiAgcmV0dXJuIHBhdGguY2hhckF0KDApID09PSAnLyc7Cn07CgovLyBwb3NpeCB2ZXJzaW9uCmV4cG9ydHMuam9pbiA9IGZ1bmN0aW9uKCkgewogIHZhciBwYXRocyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgcmV0dXJuIGV4cG9ydHMubm9ybWFsaXplKGZpbHRlcihwYXRocywgZnVuY3Rpb24ocCwgaW5kZXgpIHsKICAgIGlmICh0eXBlb2YgcCAhPT0gJ3N0cmluZycpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIHRvIHBhdGguam9pbiBtdXN0IGJlIHN0cmluZ3MnKTsKICAgIH0KICAgIHJldHVybiBwOwogIH0pLmpvaW4oJy8nKSk7Cn07CgoKLy8gcGF0aC5yZWxhdGl2ZShmcm9tLCB0bykKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICBmcm9tID0gZXhwb3J0cy5yZXNvbHZlKGZyb20pLnN1YnN0cigxKTsKICB0byA9IGV4cG9ydHMucmVzb2x2ZSh0bykuc3Vic3RyKDEpOwoKICBmdW5jdGlvbiB0cmltKGFycikgewogICAgdmFyIHN0YXJ0ID0gMDsKICAgIGZvciAoOyBzdGFydCA8IGFyci5sZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgaWYgKGFycltzdGFydF0gIT09ICcnKSBicmVhazsKICAgIH0KCiAgICB2YXIgZW5kID0gYXJyLmxlbmd0aCAtIDE7CiAgICBmb3IgKDsgZW5kID49IDA7IGVuZC0tKSB7CiAgICAgIGlmIChhcnJbZW5kXSAhPT0gJycpIGJyZWFrOwogICAgfQoKICAgIGlmIChzdGFydCA+IGVuZCkgcmV0dXJuIFtdOwogICAgcmV0dXJuIGFyci5zbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKTsKICB9CgogIHZhciBmcm9tUGFydHMgPSB0cmltKGZyb20uc3BsaXQoJy8nKSk7CiAgdmFyIHRvUGFydHMgPSB0cmltKHRvLnNwbGl0KCcvJykpOwoKICB2YXIgbGVuZ3RoID0gTWF0aC5taW4oZnJvbVBhcnRzLmxlbmd0aCwgdG9QYXJ0cy5sZW5ndGgpOwogIHZhciBzYW1lUGFydHNMZW5ndGggPSBsZW5ndGg7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgaWYgKGZyb21QYXJ0c1tpXSAhPT0gdG9QYXJ0c1tpXSkgewogICAgICBzYW1lUGFydHNMZW5ndGggPSBpOwogICAgICBicmVhazsKICAgIH0KICB9CgogIHZhciBvdXRwdXRQYXJ0cyA9IFtdOwogIGZvciAodmFyIGkgPSBzYW1lUGFydHNMZW5ndGg7IGkgPCBmcm9tUGFydHMubGVuZ3RoOyBpKyspIHsKICAgIG91dHB1dFBhcnRzLnB1c2goJy4uJyk7CiAgfQoKICBvdXRwdXRQYXJ0cyA9IG91dHB1dFBhcnRzLmNvbmNhdCh0b1BhcnRzLnNsaWNlKHNhbWVQYXJ0c0xlbmd0aCkpOwoKICByZXR1cm4gb3V0cHV0UGFydHMuam9pbignLycpOwp9OwoKZXhwb3J0cy5zZXAgPSAnLyc7CmV4cG9ydHMuZGVsaW1pdGVyID0gJzonOwoKZXhwb3J0cy5kaXJuYW1lID0gZnVuY3Rpb24ocGF0aCkgewogIHZhciByZXN1bHQgPSBzcGxpdFBhdGgocGF0aCksCiAgICAgIHJvb3QgPSByZXN1bHRbMF0sCiAgICAgIGRpciA9IHJlc3VsdFsxXTsKCiAgaWYgKCFyb290ICYmICFkaXIpIHsKICAgIC8vIE5vIGRpcm5hbWUgd2hhdHNvZXZlcgogICAgcmV0dXJuICcuJzsKICB9CgogIGlmIChkaXIpIHsKICAgIC8vIEl0IGhhcyBhIGRpcm5hbWUsIHN0cmlwIHRyYWlsaW5nIHNsYXNoCiAgICBkaXIgPSBkaXIuc3Vic3RyKDAsIGRpci5sZW5ndGggLSAxKTsKICB9CgogIHJldHVybiByb290ICsgZGlyOwp9OwoKCmV4cG9ydHMuYmFzZW5hbWUgPSBmdW5jdGlvbihwYXRoLCBleHQpIHsKICB2YXIgZiA9IHNwbGl0UGF0aChwYXRoKVsyXTsKICAvLyBUT0RPOiBtYWtlIHRoaXMgY29tcGFyaXNvbiBjYXNlLWluc2Vuc2l0aXZlIG9uIHdpbmRvd3M/CiAgaWYgKGV4dCAmJiBmLnN1YnN0cigtMSAqIGV4dC5sZW5ndGgpID09PSBleHQpIHsKICAgIGYgPSBmLnN1YnN0cigwLCBmLmxlbmd0aCAtIGV4dC5sZW5ndGgpOwogIH0KICByZXR1cm4gZjsKfTsKCgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbihwYXRoKSB7CiAgcmV0dXJuIHNwbGl0UGF0aChwYXRoKVszXTsKfTsKCmZ1bmN0aW9uIGZpbHRlciAoeHMsIGYpIHsKICAgIGlmICh4cy5maWx0ZXIpIHJldHVybiB4cy5maWx0ZXIoZik7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGYoeHNbaV0sIGksIHhzKSkgcmVzLnB1c2goeHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlczsKfQoKLy8gU3RyaW5nLnByb3RvdHlwZS5zdWJzdHIgLSBuZWdhdGl2ZSBpbmRleCBkb24ndCB3b3JrIGluIElFOAp2YXIgc3Vic3RyID0gJ2FiJy5zdWJzdHIoLTEpID09PSAnYicKICAgID8gZnVuY3Rpb24gKHN0ciwgc3RhcnQsIGxlbikgeyByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuKSB9CiAgICA6IGZ1bmN0aW9uIChzdHIsIHN0YXJ0LCBsZW4pIHsKICAgICAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IHN0ci5sZW5ndGggKyBzdGFydDsKICAgICAgICByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuKTsKICAgIH0KOwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyJfcHJvY2VzcyI6NjB9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3NlcgoKdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwoKcHJvY2Vzcy5uZXh0VGljayA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2FuU2V0SW1tZWRpYXRlID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICYmIHdpbmRvdy5zZXRJbW1lZGlhdGU7CiAgICB2YXIgY2FuTXV0YXRpb25PYnNlcnZlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnCiAgICAmJiB3aW5kb3cuTXV0YXRpb25PYnNlcnZlcjsKICAgIHZhciBjYW5Qb3N0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICYmIHdpbmRvdy5wb3N0TWVzc2FnZSAmJiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcgogICAgOwoKICAgIGlmIChjYW5TZXRJbW1lZGlhdGUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGYpIHsgcmV0dXJuIHdpbmRvdy5zZXRJbW1lZGlhdGUoZikgfTsKICAgIH0KCiAgICB2YXIgcXVldWUgPSBbXTsKCiAgICBpZiAoY2FuTXV0YXRpb25PYnNlcnZlcikgewogICAgICAgIHZhciBoaWRkZW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxpc3QgPSBxdWV1ZS5zbGljZSgpOwogICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICBxdWV1ZUxpc3QuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBvYnNlcnZlci5vYnNlcnZlKGhpZGRlbkRpdiwgeyBhdHRyaWJ1dGVzOiB0cnVlIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpZGRlbkRpdi5zZXRBdHRyaWJ1dGUoJ3llcycsICdubycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLnB1c2goZm4pOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKGNhblBvc3QpIHsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChldikgewogICAgICAgICAgICB2YXIgc291cmNlID0gZXYuc291cmNlOwogICAgICAgICAgICBpZiAoKHNvdXJjZSA9PT0gd2luZG93IHx8IHNvdXJjZSA9PT0gbnVsbCkgJiYgZXYuZGF0YSA9PT0gJ3Byb2Nlc3MtdGljaycpIHsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5leHRUaWNrKGZuKSB7CiAgICAgICAgICAgIHF1ZXVlLnB1c2goZm4pOwogICAgICAgICAgICB3aW5kb3cucG9zdE1lc3NhZ2UoJ3Byb2Nlc3MtdGljaycsICcqJyk7CiAgICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgIH07Cn0pKCk7Cgpwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwpwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwpwcm9jZXNzLmVudiA9IHt9Owpwcm9jZXNzLmFyZ3YgPSBbXTsKCmZ1bmN0aW9uIG5vb3AoKSB7fQoKcHJvY2Vzcy5vbiA9IG5vb3A7CnByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLm9uY2UgPSBub29wOwpwcm9jZXNzLm9mZiA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CnByb2Nlc3MuZW1pdCA9IG5vb3A7Cgpwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwp9OwoKLy8gVE9ETyhzaHR5bG1hbikKcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07Cgp9LHt9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgiLi9saWIvX3N0cmVhbV9kdXBsZXguanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fZHVwbGV4LmpzIjo2Mn1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKLy8gYSBkdXBsZXggc3RyZWFtIGlzIGp1c3QgYSBzdHJlYW0gdGhhdCBpcyBib3RoIHJlYWRhYmxlIGFuZCB3cml0YWJsZS4KLy8gU2luY2UgSlMgZG9lc24ndCBoYXZlIG11bHRpcGxlIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UsIHRoaXMgY2xhc3MKLy8gcHJvdG90eXBhbGx5IGluaGVyaXRzIGZyb20gUmVhZGFibGUsIGFuZCB0aGVuIHBhcmFzaXRpY2FsbHkgZnJvbQovLyBXcml0YWJsZS4KCm1vZHVsZS5leHBvcnRzID0gRHVwbGV4OwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgdmFyIGtleXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSBrZXlzLnB1c2goa2V5KTsKICByZXR1cm4ga2V5czsKfQovKjwvcmVwbGFjZW1lbnQ+Ki8KCgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgUmVhZGFibGUgPSByZXF1aXJlKCcuL19zdHJlYW1fcmVhZGFibGUnKTsKdmFyIFdyaXRhYmxlID0gcmVxdWlyZSgnLi9fc3RyZWFtX3dyaXRhYmxlJyk7Cgp1dGlsLmluaGVyaXRzKER1cGxleCwgUmVhZGFibGUpOwoKZm9yRWFjaChvYmplY3RLZXlzKFdyaXRhYmxlLnByb3RvdHlwZSksIGZ1bmN0aW9uKG1ldGhvZCkgewogIGlmICghRHVwbGV4LnByb3RvdHlwZVttZXRob2RdKQogICAgRHVwbGV4LnByb3RvdHlwZVttZXRob2RdID0gV3JpdGFibGUucHJvdG90eXBlW21ldGhvZF07Cn0pOwoKZnVuY3Rpb24gRHVwbGV4KG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgRHVwbGV4KSkKICAgIHJldHVybiBuZXcgRHVwbGV4KG9wdGlvbnMpOwoKICBSZWFkYWJsZS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIFdyaXRhYmxlLmNhbGwodGhpcywgb3B0aW9ucyk7CgogIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmVhZGFibGUgPT09IGZhbHNlKQogICAgdGhpcy5yZWFkYWJsZSA9IGZhbHNlOwoKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLndyaXRhYmxlID09PSBmYWxzZSkKICAgIHRoaXMud3JpdGFibGUgPSBmYWxzZTsKCiAgdGhpcy5hbGxvd0hhbGZPcGVuID0gdHJ1ZTsKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmFsbG93SGFsZk9wZW4gPT09IGZhbHNlKQogICAgdGhpcy5hbGxvd0hhbGZPcGVuID0gZmFsc2U7CgogIHRoaXMub25jZSgnZW5kJywgb25lbmQpOwp9CgovLyB0aGUgbm8taGFsZi1vcGVuIGVuZm9yY2VyCmZ1bmN0aW9uIG9uZW5kKCkgewogIC8vIGlmIHdlIGFsbG93IGhhbGYtb3BlbiBzdGF0ZSwgb3IgaWYgdGhlIHdyaXRhYmxlIHNpZGUgZW5kZWQsCiAgLy8gdGhlbiB3ZSdyZSBvay4KICBpZiAodGhpcy5hbGxvd0hhbGZPcGVuIHx8IHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kZWQpCiAgICByZXR1cm47CgogIC8vIG5vIG1vcmUgZGF0YSBjYW4gYmUgd3JpdHRlbi4KICAvLyBCdXQgYWxsb3cgbW9yZSB3cml0ZXMgdG8gaGFwcGVuIGluIHRoaXMgdGljay4KICBwcm9jZXNzLm5leHRUaWNrKHRoaXMuZW5kLmJpbmQodGhpcykpOwp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9fc3RyZWFtX3JlYWRhYmxlIjo2NCwiLi9fc3RyZWFtX3dyaXRhYmxlIjo2NiwiX3Byb2Nlc3MiOjYwLCJjb3JlLXV0aWwtaXMiOjY3LCJpbmhlcml0cyI6NzZ9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIGEgcGFzc3Rocm91Z2ggc3RyZWFtLgovLyBiYXNpY2FsbHkganVzdCB0aGUgbW9zdCBtaW5pbWFsIHNvcnQgb2YgVHJhbnNmb3JtIHN0cmVhbS4KLy8gRXZlcnkgd3JpdHRlbiBjaHVuayBnZXRzIG91dHB1dCBhcy1pcy4KCm1vZHVsZS5leHBvcnRzID0gUGFzc1Rocm91Z2g7Cgp2YXIgVHJhbnNmb3JtID0gcmVxdWlyZSgnLi9fc3RyZWFtX3RyYW5zZm9ybScpOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIHV0aWwgPSByZXF1aXJlKCdjb3JlLXV0aWwtaXMnKTsKdXRpbC5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKdXRpbC5pbmhlcml0cyhQYXNzVGhyb3VnaCwgVHJhbnNmb3JtKTsKCmZ1bmN0aW9uIFBhc3NUaHJvdWdoKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUGFzc1Rocm91Z2gpKQogICAgcmV0dXJuIG5ldyBQYXNzVGhyb3VnaChvcHRpb25zKTsKCiAgVHJhbnNmb3JtLmNhbGwodGhpcywgb3B0aW9ucyk7Cn0KClBhc3NUaHJvdWdoLnByb3RvdHlwZS5fdHJhbnNmb3JtID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIGNiKG51bGwsIGNodW5rKTsKfTsKCn0seyIuL19zdHJlYW1fdHJhbnNmb3JtIjo2NSwiY29yZS11dGlsLWlzIjo2NywiaW5oZXJpdHMiOjc2fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFJlYWRhYmxlOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5Jyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXInKS5CdWZmZXI7Ci8qPC9yZXBsYWNlbWVudD4qLwoKUmVhZGFibGUuUmVhZGFibGVTdGF0ZSA9IFJlYWRhYmxlU3RhdGU7Cgp2YXIgRUUgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovKjxyZXBsYWNlbWVudD4qLwppZiAoIUVFLmxpc3RlbmVyQ291bnQpIEVFLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJzKHR5cGUpLmxlbmd0aDsKfTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyaW5nRGVjb2RlcjsKCnV0aWwuaW5oZXJpdHMoUmVhZGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBSZWFkYWJsZVN0YXRlKG9wdGlvbnMsIHN0cmVhbSkgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAvLyB0aGUgcG9pbnQgYXQgd2hpY2ggaXQgc3RvcHMgY2FsbGluZyBfcmVhZCgpIHRvIGZpbGwgdGhlIGJ1ZmZlcgogIC8vIE5vdGU6IDAgaXMgYSB2YWxpZCB2YWx1ZSwgbWVhbnMgImRvbid0IGNhbGwgX3JlYWQgcHJlZW1wdGl2ZWx5IGV2ZXIiCiAgdmFyIGh3bSA9IG9wdGlvbnMuaGlnaFdhdGVyTWFyazsKICB0aGlzLmhpZ2hXYXRlck1hcmsgPSAoaHdtIHx8IGh3bSA9PT0gMCkgPyBod20gOiAxNiAqIDEwMjQ7CgogIC8vIGNhc3QgdG8gaW50cy4KICB0aGlzLmhpZ2hXYXRlck1hcmsgPSB+fnRoaXMuaGlnaFdhdGVyTWFyazsKCiAgdGhpcy5idWZmZXIgPSBbXTsKICB0aGlzLmxlbmd0aCA9IDA7CiAgdGhpcy5waXBlcyA9IG51bGw7CiAgdGhpcy5waXBlc0NvdW50ID0gMDsKICB0aGlzLmZsb3dpbmcgPSBmYWxzZTsKICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgdGhpcy5lbmRFbWl0dGVkID0gZmFsc2U7CiAgdGhpcy5yZWFkaW5nID0gZmFsc2U7CgogIC8vIEluIHN0cmVhbXMgdGhhdCBuZXZlciBoYXZlIGFueSBkYXRhLCBhbmQgZG8gcHVzaChudWxsKSByaWdodCBhd2F5LAogIC8vIHRoZSBjb25zdW1lciBjYW4gbWlzcyB0aGUgJ2VuZCcgZXZlbnQgaWYgdGhleSBkbyBzb21lIEkvTyBiZWZvcmUKICAvLyBjb25zdW1pbmcgdGhlIHN0cmVhbS4gIFNvLCB3ZSBkb24ndCBlbWl0KCdlbmQnKSB1bnRpbCBzb21lIHJlYWRpbmcKICAvLyBoYXBwZW5zLgogIHRoaXMuY2FsbGVkUmVhZCA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWN1YXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gd2hlbmV2ZXIgd2UgcmV0dXJuIG51bGwsIHRoZW4gd2Ugc2V0IGEgZmxhZyB0byBzYXkKICAvLyB0aGF0IHdlJ3JlIGF3YWl0aW5nIGEgJ3JlYWRhYmxlJyBldmVudCBlbWlzc2lvbi4KICB0aGlzLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIHRoaXMuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgdGhpcy5yZWFkYWJsZUxpc3RlbmluZyA9IGZhbHNlOwoKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnLiBVc2VkIHRvIG1ha2UgcmVhZChuKSBpZ25vcmUgbiBhbmQgdG8KICAvLyBtYWtlIGFsbCB0aGUgYnVmZmVyIG1lcmdpbmcgYW5kIGxlbmd0aCBjaGVja3MgZ28gYXdheQogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICAvLyBDcnlwdG8gaXMga2luZCBvZiBvbGQgYW5kIGNydXN0eS4gIEhpc3RvcmljYWxseSwgaXRzIGRlZmF1bHQgc3RyaW5nCiAgLy8gZW5jb2RpbmcgaXMgJ2JpbmFyeScgc28gd2UgaGF2ZSB0byBtYWtlIHRoaXMgY29uZmlndXJhYmxlLgogIC8vIEV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgdW5pdmVyc2UgdXNlcyAndXRmOCcsIHRob3VnaC4KICB0aGlzLmRlZmF1bHRFbmNvZGluZyA9IG9wdGlvbnMuZGVmYXVsdEVuY29kaW5nIHx8ICd1dGY4JzsKCiAgLy8gd2hlbiBwaXBpbmcsIHdlIG9ubHkgY2FyZSBhYm91dCAncmVhZGFibGUnIGV2ZW50cyB0aGF0IGhhcHBlbgogIC8vIGFmdGVyIHJlYWQoKWluZyBhbGwgdGhlIGJ5dGVzIGFuZCBub3QgZ2V0dGluZyBhbnkgcHVzaGJhY2suCiAgdGhpcy5yYW5PdXQgPSBmYWxzZTsKCiAgLy8gdGhlIG51bWJlciBvZiB3cml0ZXJzIHRoYXQgYXJlIGF3YWl0aW5nIGEgZHJhaW4gZXZlbnQgaW4gLnBpcGUoKXMKICB0aGlzLmF3YWl0RHJhaW4gPSAwOwoKICAvLyBpZiB0cnVlLCBhIG1heWJlUmVhZE1vcmUgaGFzIGJlZW4gc2NoZWR1bGVkCiAgdGhpcy5yZWFkaW5nTW9yZSA9IGZhbHNlOwoKICB0aGlzLmRlY29kZXIgPSBudWxsOwogIHRoaXMuZW5jb2RpbmcgPSBudWxsOwogIGlmIChvcHRpb25zLmVuY29kaW5nKSB7CiAgICBpZiAoIVN0cmluZ0RlY29kZXIpCiAgICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogICAgdGhpcy5kZWNvZGVyID0gbmV3IFN0cmluZ0RlY29kZXIob3B0aW9ucy5lbmNvZGluZyk7CiAgICB0aGlzLmVuY29kaW5nID0gb3B0aW9ucy5lbmNvZGluZzsKICB9Cn0KCmZ1bmN0aW9uIFJlYWRhYmxlKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVhZGFibGUpKQogICAgcmV0dXJuIG5ldyBSZWFkYWJsZShvcHRpb25zKTsKCiAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IG5ldyBSZWFkYWJsZVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyBsZWdhY3kKICB0aGlzLnJlYWRhYmxlID0gdHJ1ZTsKCiAgU3RyZWFtLmNhbGwodGhpcyk7Cn0KCi8vIE1hbnVhbGx5IHNob3ZlIHNvbWV0aGluZyBpbnRvIHRoZSByZWFkKCkgYnVmZmVyLgovLyBUaGlzIHJldHVybnMgdHJ1ZSBpZiB0aGUgaGlnaFdhdGVyTWFyayBoYXMgbm90IGJlZW4gaGl0IHlldCwKLy8gc2ltaWxhciB0byBob3cgV3JpdGFibGUud3JpdGUoKSByZXR1cm5zIHRydWUgaWYgeW91IHNob3VsZAovLyB3cml0ZSgpIHNvbWUgbW9yZS4KUmVhZGFibGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwoKICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJyAmJiAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBzdGF0ZS5kZWZhdWx0RW5jb2Rpbmc7CiAgICBpZiAoZW5jb2RpbmcgIT09IHN0YXRlLmVuY29kaW5nKSB7CiAgICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogICAgICBlbmNvZGluZyA9ICcnOwogICAgfQogIH0KCiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgZmFsc2UpOwp9OwoKLy8gVW5zaGlmdCBzaG91bGQgKmFsd2F5cyogYmUgc29tZXRoaW5nIGRpcmVjdGx5IG91dCBvZiByZWFkKCkKUmVhZGFibGUucHJvdG90eXBlLnVuc2hpZnQgPSBmdW5jdGlvbihjaHVuaykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCAnJywgdHJ1ZSk7Cn07CgpmdW5jdGlvbiByZWFkYWJsZUFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgYWRkVG9Gcm9udCkgewogIHZhciBlciA9IGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspOwogIGlmIChlcikgewogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIH0gZWxzZSBpZiAoY2h1bmsgPT09IG51bGwgfHwgY2h1bmsgPT09IHVuZGVmaW5lZCkgewogICAgc3RhdGUucmVhZGluZyA9IGZhbHNlOwogICAgaWYgKCFzdGF0ZS5lbmRlZCkKICAgICAgb25Fb2ZDaHVuayhzdHJlYW0sIHN0YXRlKTsKICB9IGVsc2UgaWYgKHN0YXRlLm9iamVjdE1vZGUgfHwgY2h1bmsgJiYgY2h1bmsubGVuZ3RoID4gMCkgewogICAgaWYgKHN0YXRlLmVuZGVkICYmICFhZGRUb0Zyb250KSB7CiAgICAgIHZhciBlID0gbmV3IEVycm9yKCdzdHJlYW0ucHVzaCgpIGFmdGVyIEVPRicpOwogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlKTsKICAgIH0gZWxzZSBpZiAoc3RhdGUuZW5kRW1pdHRlZCAmJiBhZGRUb0Zyb250KSB7CiAgICAgIHZhciBlID0gbmV3IEVycm9yKCdzdHJlYW0udW5zaGlmdCgpIGFmdGVyIGVuZCBldmVudCcpOwogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGF0ZS5kZWNvZGVyICYmICFhZGRUb0Zyb250ICYmICFlbmNvZGluZykKICAgICAgICBjaHVuayA9IHN0YXRlLmRlY29kZXIud3JpdGUoY2h1bmspOwoKICAgICAgLy8gdXBkYXRlIHRoZSBidWZmZXIgaW5mby4KICAgICAgc3RhdGUubGVuZ3RoICs9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwogICAgICBpZiAoYWRkVG9Gcm9udCkgewogICAgICAgIHN0YXRlLmJ1ZmZlci51bnNoaWZ0KGNodW5rKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgICAgICAgc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICB9CgogICAgICBpZiAoc3RhdGUubmVlZFJlYWRhYmxlKQogICAgICAgIGVtaXRSZWFkYWJsZShzdHJlYW0pOwoKICAgICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICAgIH0KICB9IGVsc2UgaWYgKCFhZGRUb0Zyb250KSB7CiAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgfQoKICByZXR1cm4gbmVlZE1vcmVEYXRhKHN0YXRlKTsKfQoKCgovLyBpZiBpdCdzIHBhc3QgdGhlIGhpZ2ggd2F0ZXIgbWFyaywgd2UgY2FuIHB1c2ggaW4gc29tZSBtb3JlLgovLyBBbHNvLCBpZiB3ZSBoYXZlIG5vIGRhdGEgeWV0LCB3ZSBjYW4gc3RhbmQgc29tZQovLyBtb3JlIGJ5dGVzLiAgVGhpcyBpcyB0byB3b3JrIGFyb3VuZCBjYXNlcyB3aGVyZSBod209MCwKLy8gc3VjaCBhcyB0aGUgcmVwbC4gIEFsc28sIGlmIHRoZSBwdXNoKCkgdHJpZ2dlcmVkIGEKLy8gcmVhZGFibGUgZXZlbnQsIGFuZCB0aGUgdXNlciBjYWxsZWQgcmVhZChsYXJnZU51bWJlcikgc3VjaCB0aGF0Ci8vIG5lZWRSZWFkYWJsZSB3YXMgc2V0LCB0aGVuIHdlIG91Z2h0IHRvIHB1c2ggbW9yZSwgc28gdGhhdCBhbm90aGVyCi8vICdyZWFkYWJsZScgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQuCmZ1bmN0aW9uIG5lZWRNb3JlRGF0YShzdGF0ZSkgewogIHJldHVybiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgKHN0YXRlLm5lZWRSZWFkYWJsZSB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyayB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwKTsKfQoKLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuClJlYWRhYmxlLnByb3RvdHlwZS5zZXRFbmNvZGluZyA9IGZ1bmN0aW9uKGVuYykgewogIGlmICghU3RyaW5nRGVjb2RlcikKICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogIHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuYyk7CiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA9IGVuYzsKfTsKCi8vIERvbid0IHJhaXNlIHRoZSBod20gPiAxMjhNQgp2YXIgTUFYX0hXTSA9IDB4ODAwMDAwOwpmdW5jdGlvbiByb3VuZFVwVG9OZXh0UG93ZXJPZjIobikgewogIGlmIChuID49IE1BWF9IV00pIHsKICAgIG4gPSBNQVhfSFdNOwogIH0gZWxzZSB7CiAgICAvLyBHZXQgdGhlIG5leHQgaGlnaGVzdCBwb3dlciBvZiAyCiAgICBuLS07CiAgICBmb3IgKHZhciBwID0gMTsgcCA8IDMyOyBwIDw8PSAxKSBuIHw9IG4gPj4gcDsKICAgIG4rKzsKICB9CiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uIGhvd011Y2hUb1JlYWQobiwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLmVuZGVkKQogICAgcmV0dXJuIDA7CgogIGlmIChzdGF0ZS5vYmplY3RNb2RlKQogICAgcmV0dXJuIG4gPT09IDAgPyAwIDogMTsKCiAgaWYgKG4gPT09IG51bGwgfHwgaXNOYU4obikpIHsKICAgIC8vIG9ubHkgZmxvdyBvbmUgYnVmZmVyIGF0IGEgdGltZQogICAgaWYgKHN0YXRlLmZsb3dpbmcgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgcmV0dXJuIHN0YXRlLmJ1ZmZlclswXS5sZW5ndGg7CiAgICBlbHNlCiAgICAgIHJldHVybiBzdGF0ZS5sZW5ndGg7CiAgfQoKICBpZiAobiA8PSAwKQogICAgcmV0dXJuIDA7CgogIC8vIElmIHdlJ3JlIGFza2luZyBmb3IgbW9yZSB0aGFuIHRoZSB0YXJnZXQgYnVmZmVyIGxldmVsLAogIC8vIHRoZW4gcmFpc2UgdGhlIHdhdGVyIG1hcmsuICBCdW1wIHVwIHRvIHRoZSBuZXh0IGhpZ2hlc3QKICAvLyBwb3dlciBvZiAyLCB0byBwcmV2ZW50IGluY3JlYXNpbmcgaXQgZXhjZXNzaXZlbHkgaW4gdGlueQogIC8vIGFtb3VudHMuCiAgaWYgKG4gPiBzdGF0ZS5oaWdoV2F0ZXJNYXJrKQogICAgc3RhdGUuaGlnaFdhdGVyTWFyayA9IHJvdW5kVXBUb05leHRQb3dlck9mMihuKTsKCiAgLy8gZG9uJ3QgaGF2ZSB0aGF0IG11Y2guICByZXR1cm4gbnVsbCwgdW5sZXNzIHdlJ3ZlIGVuZGVkLgogIGlmIChuID4gc3RhdGUubGVuZ3RoKSB7CiAgICBpZiAoIXN0YXRlLmVuZGVkKSB7CiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIHJldHVybiAwOwogICAgfSBlbHNlCiAgICAgIHJldHVybiBzdGF0ZS5sZW5ndGg7CiAgfQoKICByZXR1cm4gbjsKfQoKLy8geW91IGNhbiBvdmVycmlkZSBlaXRoZXIgdGhpcyBtZXRob2QsIG9yIHRoZSBhc3luYyBfcmVhZChuKSBiZWxvdy4KUmVhZGFibGUucHJvdG90eXBlLnJlYWQgPSBmdW5jdGlvbihuKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICBzdGF0ZS5jYWxsZWRSZWFkID0gdHJ1ZTsKICB2YXIgbk9yaWcgPSBuOwogIHZhciByZXQ7CgogIGlmICh0eXBlb2YgbiAhPT0gJ251bWJlcicgfHwgbiA+IDApCiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSBmYWxzZTsKCiAgLy8gaWYgd2UncmUgZG9pbmcgcmVhZCgwKSB0byB0cmlnZ2VyIGEgcmVhZGFibGUgZXZlbnQsIGJ1dCB3ZQogIC8vIGFscmVhZHkgaGF2ZSBhIGJ1bmNoIG9mIGRhdGEgaW4gdGhlIGJ1ZmZlciwgdGhlbiBqdXN0IHRyaWdnZXIKICAvLyB0aGUgJ3JlYWRhYmxlJyBldmVudCBhbmQgbW92ZSBvbi4KICBpZiAobiA9PT0gMCAmJgogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgJiYKICAgICAgKHN0YXRlLmxlbmd0aCA+PSBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmVuZGVkKSkgewogICAgZW1pdFJlYWRhYmxlKHRoaXMpOwogICAgcmV0dXJuIG51bGw7CiAgfQoKICBuID0gaG93TXVjaFRvUmVhZChuLCBzdGF0ZSk7CgogIC8vIGlmIHdlJ3ZlIGVuZGVkLCBhbmQgd2UncmUgbm93IGNsZWFyLCB0aGVuIGZpbmlzaCBpdCB1cC4KICBpZiAobiA9PT0gMCAmJiBzdGF0ZS5lbmRlZCkgewogICAgcmV0ID0gbnVsbDsKCiAgICAvLyBJbiBjYXNlcyB3aGVyZSB0aGUgZGVjb2RlciBkaWQgbm90IHJlY2VpdmUgZW5vdWdoIGRhdGEKICAgIC8vIHRvIHByb2R1Y2UgYSBmdWxsIGNodW5rLCB0aGVuIGltbWVkaWF0ZWx5IHJlY2VpdmVkIGFuCiAgICAvLyBFT0YsIHN0YXRlLmJ1ZmZlciB3aWxsIGNvbnRhaW4gWzxCdWZmZXIgPiwgPEJ1ZmZlciAwMCAuLi4+XS4KICAgIC8vIGhvd011Y2hUb1JlYWQgd2lsbCBzZWUgdGhpcyBhbmQgY29lcmNlIHRoZSBhbW91bnQgdG8KICAgIC8vIHJlYWQgdG8gemVybyAoYmVjYXVzZSBpdCdzIGxvb2tpbmcgYXQgdGhlIGxlbmd0aCBvZiB0aGUKICAgIC8vIGZpcnN0IDxCdWZmZXIgPiBpbiBzdGF0ZS5idWZmZXIpLCBhbmQgd2UnbGwgZW5kIHVwIGhlcmUuCiAgICAvLwogICAgLy8gVGhpcyBjYW4gb25seSBoYXBwZW4gdmlhIHN0YXRlLmRlY29kZXIgLS0gbm8gb3RoZXIgdmVudWUKICAgIC8vIGV4aXN0cyBmb3IgcHVzaGluZyBhIHplcm8tbGVuZ3RoIGNodW5rIGludG8gc3RhdGUuYnVmZmVyCiAgICAvLyBhbmQgdHJpZ2dlcmluZyB0aGlzIGJlaGF2aW9yLiBJbiB0aGlzIGNhc2UsIHdlIHJldHVybiBvdXIKICAgIC8vIHJlbWFpbmluZyBkYXRhIGFuZCBlbmQgdGhlIHN0cmVhbSwgaWYgYXBwcm9wcmlhdGUuCiAgICBpZiAoc3RhdGUubGVuZ3RoID4gMCAmJiBzdGF0ZS5kZWNvZGVyKSB7CiAgICAgIHJldCA9IGZyb21MaXN0KG4sIHN0YXRlKTsKICAgICAgc3RhdGUubGVuZ3RoIC09IHJldC5sZW5ndGg7CiAgICB9CgogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkKICAgICAgZW5kUmVhZGFibGUodGhpcyk7CgogICAgcmV0dXJuIHJldDsKICB9CgogIC8vIEFsbCB0aGUgYWN0dWFsIGNodW5rIGdlbmVyYXRpb24gbG9naWMgbmVlZHMgdG8gYmUKICAvLyAqYmVsb3cqIHRoZSBjYWxsIHRvIF9yZWFkLiAgVGhlIHJlYXNvbiBpcyB0aGF0IGluIGNlcnRhaW4KICAvLyBzeW50aGV0aWMgc3RyZWFtIGNhc2VzLCBzdWNoIGFzIHBhc3N0aHJvdWdoIHN0cmVhbXMsIF9yZWFkCiAgLy8gbWF5IGJlIGEgY29tcGxldGVseSBzeW5jaHJvbm91cyBvcGVyYXRpb24gd2hpY2ggbWF5IGNoYW5nZQogIC8vIHRoZSBzdGF0ZSBvZiB0aGUgcmVhZCBidWZmZXIsIHByb3ZpZGluZyBlbm91Z2ggZGF0YSB3aGVuCiAgLy8gYmVmb3JlIHRoZXJlIHdhcyAqbm90KiBlbm91Z2guCiAgLy8KICAvLyBTbywgdGhlIHN0ZXBzIGFyZToKICAvLyAxLiBGaWd1cmUgb3V0IHdoYXQgdGhlIHN0YXRlIG9mIHRoaW5ncyB3aWxsIGJlIGFmdGVyIHdlIGRvCiAgLy8gYSByZWFkIGZyb20gdGhlIGJ1ZmZlci4KICAvLwogIC8vIDIuIElmIHRoYXQgcmVzdWx0aW5nIHN0YXRlIHdpbGwgdHJpZ2dlciBhIF9yZWFkLCB0aGVuIGNhbGwgX3JlYWQuCiAgLy8gTm90ZSB0aGF0IHRoaXMgbWF5IGJlIGFzeW5jaHJvbm91cywgb3Igc3luY2hyb25vdXMuICBZZXMsIGl0IGlzCiAgLy8gZGVlcGx5IHVnbHkgdG8gd3JpdGUgQVBJcyB0aGlzIHdheSwgYnV0IHRoYXQgc3RpbGwgZG9lc24ndCBtZWFuCiAgLy8gdGhhdCB0aGUgUmVhZGFibGUgY2xhc3Mgc2hvdWxkIGJlaGF2ZSBpbXByb3Blcmx5LCBhcyBzdHJlYW1zIGFyZQogIC8vIGRlc2lnbmVkIHRvIGJlIHN5bmMvYXN5bmMgYWdub3N0aWMuCiAgLy8gVGFrZSBub3RlIGlmIHRoZSBfcmVhZCBjYWxsIGlzIHN5bmMgb3IgYXN5bmMgKGllLCBpZiB0aGUgcmVhZCBjYWxsCiAgLy8gaGFzIHJldHVybmVkIHlldCksIHNvIHRoYXQgd2Uga25vdyB3aGV0aGVyIG9yIG5vdCBpdCdzIHNhZmUgdG8gZW1pdAogIC8vICdyZWFkYWJsZScgZXRjLgogIC8vCiAgLy8gMy4gQWN0dWFsbHkgcHVsbCB0aGUgcmVxdWVzdGVkIGNodW5rcyBvdXQgb2YgdGhlIGJ1ZmZlciBhbmQgcmV0dXJuLgoKICAvLyBpZiB3ZSBuZWVkIGEgcmVhZGFibGUgZXZlbnQsIHRoZW4gd2UgbmVlZCB0byBkbyBzb21lIHJlYWRpbmcuCiAgdmFyIGRvUmVhZCA9IHN0YXRlLm5lZWRSZWFkYWJsZTsKCiAgLy8gaWYgd2UgY3VycmVudGx5IGhhdmUgbGVzcyB0aGFuIHRoZSBoaWdoV2F0ZXJNYXJrLCB0aGVuIGFsc28gcmVhZCBzb21lCiAgaWYgKHN0YXRlLmxlbmd0aCAtIG4gPD0gc3RhdGUuaGlnaFdhdGVyTWFyaykKICAgIGRvUmVhZCA9IHRydWU7CgogIC8vIGhvd2V2ZXIsIGlmIHdlJ3ZlIGVuZGVkLCB0aGVuIHRoZXJlJ3Mgbm8gcG9pbnQsIGFuZCBpZiB3ZSdyZSBhbHJlYWR5CiAgLy8gcmVhZGluZywgdGhlbiBpdCdzIHVubmVjZXNzYXJ5LgogIGlmIChzdGF0ZS5lbmRlZCB8fCBzdGF0ZS5yZWFkaW5nKQogICAgZG9SZWFkID0gZmFsc2U7CgogIGlmIChkb1JlYWQpIHsKICAgIHN0YXRlLnJlYWRpbmcgPSB0cnVlOwogICAgc3RhdGUuc3luYyA9IHRydWU7CiAgICAvLyBpZiB0aGUgbGVuZ3RoIGlzIGN1cnJlbnRseSB6ZXJvLCB0aGVuIHdlICpuZWVkKiBhIHJlYWRhYmxlIGV2ZW50LgogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkKICAgICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKICAgIC8vIGNhbGwgaW50ZXJuYWwgcmVhZCBtZXRob2QKICAgIHRoaXMuX3JlYWQoc3RhdGUuaGlnaFdhdGVyTWFyayk7CiAgICBzdGF0ZS5zeW5jID0gZmFsc2U7CiAgfQoKICAvLyBJZiBfcmVhZCBjYWxsZWQgaXRzIGNhbGxiYWNrIHN5bmNocm9ub3VzbHksIHRoZW4gYHJlYWRpbmdgCiAgLy8gd2lsbCBiZSBmYWxzZSwgYW5kIHdlIG5lZWQgdG8gcmUtZXZhbHVhdGUgaG93IG11Y2ggZGF0YSB3ZQogIC8vIGNhbiByZXR1cm4gdG8gdGhlIHVzZXIuCiAgaWYgKGRvUmVhZCAmJiAhc3RhdGUucmVhZGluZykKICAgIG4gPSBob3dNdWNoVG9SZWFkKG5PcmlnLCBzdGF0ZSk7CgogIGlmIChuID4gMCkKICAgIHJldCA9IGZyb21MaXN0KG4sIHN0YXRlKTsKICBlbHNlCiAgICByZXQgPSBudWxsOwoKICBpZiAocmV0ID09PSBudWxsKSB7CiAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgbiA9IDA7CiAgfQoKICBzdGF0ZS5sZW5ndGggLT0gbjsKCiAgLy8gSWYgd2UgaGF2ZSBub3RoaW5nIGluIHRoZSBidWZmZXIsIHRoZW4gd2Ugd2FudCB0byBrbm93CiAgLy8gYXMgc29vbiBhcyB3ZSAqZG8qIGdldCBzb21ldGhpbmcgaW50byB0aGUgYnVmZmVyLgogIGlmIChzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLmVuZGVkKQogICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gSWYgd2UgaGFwcGVuZWQgdG8gcmVhZCgpIGV4YWN0bHkgdGhlIHJlbWFpbmluZyBhbW91bnQgaW4gdGhlCiAgLy8gYnVmZmVyLCBhbmQgdGhlIEVPRiBoYXMgYmVlbiBzZWVuIGF0IHRoaXMgcG9pbnQsIHRoZW4gbWFrZSBzdXJlCiAgLy8gdGhhdCB3ZSBlbWl0ICdlbmQnIG9uIHRoZSB2ZXJ5IG5leHQgdGljay4KICBpZiAoc3RhdGUuZW5kZWQgJiYgIXN0YXRlLmVuZEVtaXR0ZWQgJiYgc3RhdGUubGVuZ3RoID09PSAwKQogICAgZW5kUmVhZGFibGUodGhpcyk7CgogIHJldHVybiByZXQ7Cn07CgpmdW5jdGlvbiBjaHVua0ludmFsaWQoc3RhdGUsIGNodW5rKSB7CiAgdmFyIGVyID0gbnVsbDsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgJ3N0cmluZycgIT09IHR5cGVvZiBjaHVuayAmJgogICAgICBjaHVuayAhPT0gbnVsbCAmJgogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmCiAgICAgICFzdGF0ZS5vYmplY3RNb2RlKSB7CiAgICBlciA9IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgbm9uLXN0cmluZy9idWZmZXIgY2h1bmsnKTsKICB9CiAgcmV0dXJuIGVyOwp9CgoKZnVuY3Rpb24gb25Fb2ZDaHVuayhzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKHN0YXRlLmRlY29kZXIgJiYgIXN0YXRlLmVuZGVkKSB7CiAgICB2YXIgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLmVuZCgpOwogICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICBzdGF0ZS5idWZmZXIucHVzaChjaHVuayk7CiAgICAgIHN0YXRlLmxlbmd0aCArPSBzdGF0ZS5vYmplY3RNb2RlID8gMSA6IGNodW5rLmxlbmd0aDsKICAgIH0KICB9CiAgc3RhdGUuZW5kZWQgPSB0cnVlOwoKICAvLyBpZiB3ZSd2ZSBlbmRlZCBhbmQgd2UgaGF2ZSBzb21lIGRhdGEgbGVmdCwgdGhlbiBlbWl0CiAgLy8gJ3JlYWRhYmxlJyBub3cgdG8gbWFrZSBzdXJlIGl0IGdldHMgcGlja2VkIHVwLgogIGlmIChzdGF0ZS5sZW5ndGggPiAwKQogICAgZW1pdFJlYWRhYmxlKHN0cmVhbSk7CiAgZWxzZQogICAgZW5kUmVhZGFibGUoc3RyZWFtKTsKfQoKLy8gRG9uJ3QgZW1pdCByZWFkYWJsZSByaWdodCBhd2F5IGluIHN5bmMgbW9kZSwgYmVjYXVzZSB0aGlzIGNhbiB0cmlnZ2VyCi8vIGFub3RoZXIgcmVhZCgpIGNhbGwgPT4gc3RhY2sgb3ZlcmZsb3cuICBUaGlzIHdheSwgaXQgbWlnaHQgdHJpZ2dlcgovLyBhIG5leHRUaWNrIHJlY3Vyc2lvbiB3YXJuaW5nLCBidXQgdGhhdCdzIG5vdCBzbyBiYWQuCmZ1bmN0aW9uIGVtaXRSZWFkYWJsZShzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgc3RhdGUubmVlZFJlYWRhYmxlID0gZmFsc2U7CiAgaWYgKHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSkKICAgIHJldHVybjsKCiAgc3RhdGUuZW1pdHRlZFJlYWRhYmxlID0gdHJ1ZTsKICBpZiAoc3RhdGUuc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIGVtaXRSZWFkYWJsZV8oc3RyZWFtKTsKICAgIH0pOwogIGVsc2UKICAgIGVtaXRSZWFkYWJsZV8oc3RyZWFtKTsKfQoKZnVuY3Rpb24gZW1pdFJlYWRhYmxlXyhzdHJlYW0pIHsKICBzdHJlYW0uZW1pdCgncmVhZGFibGUnKTsKfQoKCi8vIGF0IHRoaXMgcG9pbnQsIHRoZSB1c2VyIGhhcyBwcmVzdW1hYmx5IHNlZW4gdGhlICdyZWFkYWJsZScgZXZlbnQsCi8vIGFuZCBjYWxsZWQgcmVhZCgpIHRvIGNvbnN1bWUgc29tZSBkYXRhLiAgdGhhdCBtYXkgaGF2ZSB0cmlnZ2VyZWQKLy8gaW4gdHVybiBhbm90aGVyIF9yZWFkKG4pIGNhbGwsIGluIHdoaWNoIGNhc2UgcmVhZGluZyA9IHRydWUgaWYKLy8gaXQncyBpbiBwcm9ncmVzcy4KLy8gSG93ZXZlciwgaWYgd2UncmUgbm90IGVuZGVkLCBvciByZWFkaW5nLCBhbmQgdGhlIGxlbmd0aCA8IGh3bSwKLy8gdGhlbiBnbyBhaGVhZCBhbmQgdHJ5IHRvIHJlYWQgc29tZSBtb3JlIHByZWVtcHRpdmVseS4KZnVuY3Rpb24gbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5yZWFkaW5nTW9yZSkgewogICAgc3RhdGUucmVhZGluZ01vcmUgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgbWF5YmVSZWFkTW9yZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG1heWJlUmVhZE1vcmVfKHN0cmVhbSwgc3RhdGUpIHsKICB2YXIgbGVuID0gc3RhdGUubGVuZ3RoOwogIHdoaWxlICghc3RhdGUucmVhZGluZyAmJiAhc3RhdGUuZmxvd2luZyAmJiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyaykgewogICAgc3RyZWFtLnJlYWQoMCk7CiAgICBpZiAobGVuID09PSBzdGF0ZS5sZW5ndGgpCiAgICAgIC8vIGRpZG4ndCBnZXQgYW55IGRhdGEsIHN0b3Agc3Bpbm5pbmcuCiAgICAgIGJyZWFrOwogICAgZWxzZQogICAgICBsZW4gPSBzdGF0ZS5sZW5ndGg7CiAgfQogIHN0YXRlLnJlYWRpbmdNb3JlID0gZmFsc2U7Cn0KCi8vIGFic3RyYWN0IG1ldGhvZC4gIHRvIGJlIG92ZXJyaWRkZW4gaW4gc3BlY2lmaWMgaW1wbGVtZW50YXRpb24gY2xhc3Nlcy4KLy8gY2FsbCBjYihlciwgZGF0YSkgd2hlcmUgZGF0YSBpcyA8PSBuIGluIGxlbmd0aC4KLy8gZm9yIHZpcnR1YWwgKG5vbi1zdHJpbmcsIG5vbi1idWZmZXIpIHN0cmVhbXMsICJsZW5ndGgiIGlzIHNvbWV3aGF0Ci8vIGFyYml0cmFyeSwgYW5kIHBlcmhhcHMgbm90IHZlcnkgbWVhbmluZ2Z1bC4KUmVhZGFibGUucHJvdG90eXBlLl9yZWFkID0gZnVuY3Rpb24obikgewogIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpKTsKfTsKClJlYWRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oZGVzdCwgcGlwZU9wdHMpIHsKICB2YXIgc3JjID0gdGhpczsKICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwoKICBzd2l0Y2ggKHN0YXRlLnBpcGVzQ291bnQpIHsKICAgIGNhc2UgMDoKICAgICAgc3RhdGUucGlwZXMgPSBkZXN0OwogICAgICBicmVhazsKICAgIGNhc2UgMToKICAgICAgc3RhdGUucGlwZXMgPSBbc3RhdGUucGlwZXMsIGRlc3RdOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHN0YXRlLnBpcGVzLnB1c2goZGVzdCk7CiAgICAgIGJyZWFrOwogIH0KICBzdGF0ZS5waXBlc0NvdW50ICs9IDE7CgogIHZhciBkb0VuZCA9ICghcGlwZU9wdHMgfHwgcGlwZU9wdHMuZW5kICE9PSBmYWxzZSkgJiYKICAgICAgICAgICAgICBkZXN0ICE9PSBwcm9jZXNzLnN0ZG91dCAmJgogICAgICAgICAgICAgIGRlc3QgIT09IHByb2Nlc3Muc3RkZXJyOwoKICB2YXIgZW5kRm4gPSBkb0VuZCA/IG9uZW5kIDogY2xlYW51cDsKICBpZiAoc3RhdGUuZW5kRW1pdHRlZCkKICAgIHByb2Nlc3MubmV4dFRpY2soZW5kRm4pOwogIGVsc2UKICAgIHNyYy5vbmNlKCdlbmQnLCBlbmRGbik7CgogIGRlc3Qub24oJ3VucGlwZScsIG9udW5waXBlKTsKICBmdW5jdGlvbiBvbnVucGlwZShyZWFkYWJsZSkgewogICAgaWYgKHJlYWRhYmxlICE9PSBzcmMpIHJldHVybjsKICAgIGNsZWFudXAoKTsKICB9CgogIGZ1bmN0aW9uIG9uZW5kKCkgewogICAgZGVzdC5lbmQoKTsKICB9CgogIC8vIHdoZW4gdGhlIGRlc3QgZHJhaW5zLCBpdCByZWR1Y2VzIHRoZSBhd2FpdERyYWluIGNvdW50ZXIKICAvLyBvbiB0aGUgc291cmNlLiAgVGhpcyB3b3VsZCBiZSBtb3JlIGVsZWdhbnQgd2l0aCBhIC5vbmNlKCkKICAvLyBoYW5kbGVyIGluIGZsb3coKSwgYnV0IGFkZGluZyBhbmQgcmVtb3ZpbmcgcmVwZWF0ZWRseSBpcwogIC8vIHRvbyBzbG93LgogIHZhciBvbmRyYWluID0gcGlwZU9uRHJhaW4oc3JjKTsKICBkZXN0Lm9uKCdkcmFpbicsIG9uZHJhaW4pOwoKICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgLy8gY2xlYW51cCBldmVudCBoYW5kbGVycyBvbmNlIHRoZSBwaXBlIGlzIGJyb2tlbgogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2RyYWluJywgb25kcmFpbik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcigndW5waXBlJywgb251bnBpcGUpOwogICAgc3JjLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCBvbmVuZCk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIGNsZWFudXApOwoKICAgIC8vIGlmIHRoZSByZWFkZXIgaXMgd2FpdGluZyBmb3IgYSBkcmFpbiBldmVudCBmcm9tIHRoaXMKICAgIC8vIHNwZWNpZmljIHdyaXRlciwgdGhlbiBpdCB3b3VsZCBjYXVzZSBpdCB0byBuZXZlciBzdGFydAogICAgLy8gZmxvd2luZyBhZ2Fpbi4KICAgIC8vIFNvLCBpZiB0aGlzIGlzIGF3YWl0aW5nIGEgZHJhaW4sIHRoZW4gd2UganVzdCBjYWxsIGl0IG5vdy4KICAgIC8vIElmIHdlIGRvbid0IGtub3csIHRoZW4gYXNzdW1lIHRoYXQgd2UgYXJlIHdhaXRpbmcgZm9yIG9uZS4KICAgIGlmICghZGVzdC5fd3JpdGFibGVTdGF0ZSB8fCBkZXN0Ll93cml0YWJsZVN0YXRlLm5lZWREcmFpbikKICAgICAgb25kcmFpbigpOwogIH0KCiAgLy8gaWYgdGhlIGRlc3QgaGFzIGFuIGVycm9yLCB0aGVuIHN0b3AgcGlwaW5nIGludG8gaXQuCiAgLy8gaG93ZXZlciwgZG9uJ3Qgc3VwcHJlc3MgdGhlIHRocm93aW5nIGJlaGF2aW9yIGZvciB0aGlzLgogIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgIHVucGlwZSgpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKTsKICAgIGlmIChFRS5saXN0ZW5lckNvdW50KGRlc3QsICdlcnJvcicpID09PSAwKQogICAgICBkZXN0LmVtaXQoJ2Vycm9yJywgZXIpOwogIH0KICAvLyBUaGlzIGlzIGEgYnJ1dGFsbHkgdWdseSBoYWNrIHRvIG1ha2Ugc3VyZSB0aGF0IG91ciBlcnJvciBoYW5kbGVyCiAgLy8gaXMgYXR0YWNoZWQgYmVmb3JlIGFueSB1c2VybGFuZCBvbmVzLiAgTkVWRVIgRE8gVEhJUy4KICBpZiAoIWRlc3QuX2V2ZW50cyB8fCAhZGVzdC5fZXZlbnRzLmVycm9yKQogICAgZGVzdC5vbignZXJyb3InLCBvbmVycm9yKTsKICBlbHNlIGlmIChpc0FycmF5KGRlc3QuX2V2ZW50cy5lcnJvcikpCiAgICBkZXN0Ll9ldmVudHMuZXJyb3IudW5zaGlmdChvbmVycm9yKTsKICBlbHNlCiAgICBkZXN0Ll9ldmVudHMuZXJyb3IgPSBbb25lcnJvciwgZGVzdC5fZXZlbnRzLmVycm9yXTsKCgoKICAvLyBCb3RoIGNsb3NlIGFuZCBmaW5pc2ggc2hvdWxkIHRyaWdnZXIgdW5waXBlLCBidXQgb25seSBvbmNlLgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdmaW5pc2gnLCBvbmZpbmlzaCk7CiAgICB1bnBpcGUoKTsKICB9CiAgZGVzdC5vbmNlKCdjbG9zZScsIG9uY2xvc2UpOwogIGZ1bmN0aW9uIG9uZmluaXNoKCkgewogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgIHVucGlwZSgpOwogIH0KICBkZXN0Lm9uY2UoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKCiAgZnVuY3Rpb24gdW5waXBlKCkgewogICAgc3JjLnVucGlwZShkZXN0KTsKICB9CgogIC8vIHRlbGwgdGhlIGRlc3QgdGhhdCBpdCdzIGJlaW5nIHBpcGVkIHRvCiAgZGVzdC5lbWl0KCdwaXBlJywgc3JjKTsKCiAgLy8gc3RhcnQgdGhlIGZsb3cgaWYgaXQgaGFzbid0IGJlZW4gc3RhcnRlZCBhbHJlYWR5LgogIGlmICghc3RhdGUuZmxvd2luZykgewogICAgLy8gdGhlIGhhbmRsZXIgdGhhdCB3YWl0cyBmb3IgcmVhZGFibGUgZXZlbnRzIGFmdGVyIGFsbAogICAgLy8gdGhlIGRhdGEgZ2V0cyBzdWNrZWQgb3V0IGluIGZsb3cuCiAgICAvLyBUaGlzIHdvdWxkIGJlIGVhc2llciB0byBmb2xsb3cgd2l0aCBhIC5vbmNlKCkgaGFuZGxlcgogICAgLy8gaW4gZmxvdygpLCBidXQgdGhhdCBpcyB0b28gc2xvdy4KICAgIHRoaXMub24oJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwoKICAgIHN0YXRlLmZsb3dpbmcgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgZmxvdyhzcmMpOwogICAgfSk7CiAgfQoKICByZXR1cm4gZGVzdDsKfTsKCmZ1bmN0aW9uIHBpcGVPbkRyYWluKHNyYykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBkZXN0ID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHNyYy5fcmVhZGFibGVTdGF0ZTsKICAgIHN0YXRlLmF3YWl0RHJhaW4tLTsKICAgIGlmIChzdGF0ZS5hd2FpdERyYWluID09PSAwKQogICAgICBmbG93KHNyYyk7CiAgfTsKfQoKZnVuY3Rpb24gZmxvdyhzcmMpIHsKICB2YXIgc3RhdGUgPSBzcmMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIGNodW5rOwogIHN0YXRlLmF3YWl0RHJhaW4gPSAwOwoKICBmdW5jdGlvbiB3cml0ZShkZXN0LCBpLCBsaXN0KSB7CiAgICB2YXIgd3JpdHRlbiA9IGRlc3Qud3JpdGUoY2h1bmspOwogICAgaWYgKGZhbHNlID09PSB3cml0dGVuKSB7CiAgICAgIHN0YXRlLmF3YWl0RHJhaW4rKzsKICAgIH0KICB9CgogIHdoaWxlIChzdGF0ZS5waXBlc0NvdW50ICYmIG51bGwgIT09IChjaHVuayA9IHNyYy5yZWFkKCkpKSB7CgogICAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICAgIHdyaXRlKHN0YXRlLnBpcGVzLCAwLCBudWxsKTsKICAgIGVsc2UKICAgICAgZm9yRWFjaChzdGF0ZS5waXBlcywgd3JpdGUpOwoKICAgIHNyYy5lbWl0KCdkYXRhJywgY2h1bmspOwoKICAgIC8vIGlmIGFueW9uZSBuZWVkcyBhIGRyYWluLCB0aGVuIHdlIGhhdmUgdG8gd2FpdCBmb3IgdGhhdC4KICAgIGlmIChzdGF0ZS5hd2FpdERyYWluID4gMCkKICAgICAgcmV0dXJuOwogIH0KCiAgLy8gaWYgZXZlcnkgZGVzdGluYXRpb24gd2FzIHVucGlwZWQsIGVpdGhlciBiZWZvcmUgZW50ZXJpbmcgdGhpcwogIC8vIGZ1bmN0aW9uLCBvciBpbiB0aGUgd2hpbGUgbG9vcCwgdGhlbiBzdG9wIGZsb3dpbmcuCiAgLy8KICAvLyBOQjogVGhpcyBpcyBhIHByZXR0eSByYXJlIGVkZ2UgY2FzZS4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMCkgewogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIC8vIGlmIHRoZXJlIHdlcmUgZGF0YSBldmVudCBsaXN0ZW5lcnMgYWRkZWQsIHRoZW4gc3dpdGNoIHRvIG9sZCBtb2RlLgogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQoc3JjLCAnZGF0YScpID4gMCkKICAgICAgZW1pdERhdGFFdmVudHMoc3JjKTsKICAgIHJldHVybjsKICB9CgogIC8vIGF0IHRoaXMgcG9pbnQsIG5vIG9uZSBuZWVkZWQgYSBkcmFpbiwgc28gd2UganVzdCByYW4gb3V0IG9mIGRhdGEKICAvLyBvbiB0aGUgbmV4dCByZWFkYWJsZSBldmVudCwgc3RhcnQgaXQgb3ZlciBhZ2Fpbi4KICBzdGF0ZS5yYW5PdXQgPSB0cnVlOwp9CgpmdW5jdGlvbiBwaXBlT25SZWFkYWJsZSgpIHsKICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5yYW5PdXQpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUucmFuT3V0ID0gZmFsc2U7CiAgICBmbG93KHRoaXMpOwogIH0KfQoKClJlYWRhYmxlLnByb3RvdHlwZS51bnBpcGUgPSBmdW5jdGlvbihkZXN0KSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKCiAgLy8gaWYgd2UncmUgbm90IHBpcGluZyBhbnl3aGVyZSwgdGhlbiBkbyBub3RoaW5nLgogIGlmIChzdGF0ZS5waXBlc0NvdW50ID09PSAwKQogICAgcmV0dXJuIHRoaXM7CgogIC8vIGp1c3Qgb25lIGRlc3RpbmF0aW9uLiAgbW9zdCBjb21tb24gY2FzZS4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMSkgewogICAgLy8gcGFzc2VkIGluIG9uZSwgYnV0IGl0J3Mgbm90IHRoZSByaWdodCBvbmUuCiAgICBpZiAoZGVzdCAmJiBkZXN0ICE9PSBzdGF0ZS5waXBlcykKICAgICAgcmV0dXJuIHRoaXM7CgogICAgaWYgKCFkZXN0KQogICAgICBkZXN0ID0gc3RhdGUucGlwZXM7CgogICAgLy8gZ290IGEgbWF0Y2guCiAgICBzdGF0ZS5waXBlcyA9IG51bGw7CiAgICBzdGF0ZS5waXBlc0NvdW50ID0gMDsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwogICAgaWYgKGRlc3QpCiAgICAgIGRlc3QuZW1pdCgndW5waXBlJywgdGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8vIHNsb3cgY2FzZS4gbXVsdGlwbGUgcGlwZSBkZXN0aW5hdGlvbnMuCgogIGlmICghZGVzdCkgewogICAgLy8gcmVtb3ZlIGFsbC4KICAgIHZhciBkZXN0cyA9IHN0YXRlLnBpcGVzOwogICAgdmFyIGxlbiA9IHN0YXRlLnBpcGVzQ291bnQ7CiAgICBzdGF0ZS5waXBlcyA9IG51bGw7CiAgICBzdGF0ZS5waXBlc0NvdW50ID0gMDsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGRlc3RzW2ldLmVtaXQoJ3VucGlwZScsIHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyB0cnkgdG8gZmluZCB0aGUgcmlnaHQgb25lLgogIHZhciBpID0gaW5kZXhPZihzdGF0ZS5waXBlcywgZGVzdCk7CiAgaWYgKGkgPT09IC0xKQogICAgcmV0dXJuIHRoaXM7CgogIHN0YXRlLnBpcGVzLnNwbGljZShpLCAxKTsKICBzdGF0ZS5waXBlc0NvdW50IC09IDE7CiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICBzdGF0ZS5waXBlcyA9IHN0YXRlLnBpcGVzWzBdOwoKICBkZXN0LmVtaXQoJ3VucGlwZScsIHRoaXMpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIHNldCB1cCBkYXRhIGV2ZW50cyBpZiB0aGV5IGFyZSBhc2tlZCBmb3IKLy8gRW5zdXJlIHJlYWRhYmxlIGxpc3RlbmVycyBldmVudHVhbGx5IGdldCBzb21ldGhpbmcKUmVhZGFibGUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXYsIGZuKSB7CiAgdmFyIHJlcyA9IFN0cmVhbS5wcm90b3R5cGUub24uY2FsbCh0aGlzLCBldiwgZm4pOwoKICBpZiAoZXYgPT09ICdkYXRhJyAmJiAhdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nKQogICAgZW1pdERhdGFFdmVudHModGhpcyk7CgogIGlmIChldiA9PT0gJ3JlYWRhYmxlJyAmJiB0aGlzLnJlYWRhYmxlKSB7CiAgICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKCFzdGF0ZS5yZWFkYWJsZUxpc3RlbmluZykgewogICAgICBzdGF0ZS5yZWFkYWJsZUxpc3RlbmluZyA9IHRydWU7CiAgICAgIHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSA9IGZhbHNlOwogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgICBpZiAoIXN0YXRlLnJlYWRpbmcpIHsKICAgICAgICB0aGlzLnJlYWQoMCk7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgZW1pdFJlYWRhYmxlKHRoaXMsIHN0YXRlKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfTsKUmVhZGFibGUucHJvdG90eXBlLmFkZExpc3RlbmVyID0gUmVhZGFibGUucHJvdG90eXBlLm9uOwoKLy8gcGF1c2UoKSBhbmQgcmVzdW1lKCkgYXJlIHJlbW5hbnRzIG9mIHRoZSBsZWdhY3kgcmVhZGFibGUgc3RyZWFtIEFQSQovLyBJZiB0aGUgdXNlciB1c2VzIHRoZW0sIHRoZW4gc3dpdGNoIGludG8gb2xkIG1vZGUuClJlYWRhYmxlLnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbigpIHsKICBlbWl0RGF0YUV2ZW50cyh0aGlzKTsKICB0aGlzLnJlYWQoMCk7CiAgdGhpcy5lbWl0KCdyZXN1bWUnKTsKfTsKClJlYWRhYmxlLnByb3RvdHlwZS5wYXVzZSA9IGZ1bmN0aW9uKCkgewogIGVtaXREYXRhRXZlbnRzKHRoaXMsIHRydWUpOwogIHRoaXMuZW1pdCgncGF1c2UnKTsKfTsKCmZ1bmN0aW9uIGVtaXREYXRhRXZlbnRzKHN0cmVhbSwgc3RhcnRQYXVzZWQpIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CgogIGlmIChzdGF0ZS5mbG93aW5nKSB7CiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL3JlYWRhYmxlLXN0cmVhbS9pc3N1ZXMvMTYKICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHN3aXRjaCB0byBvbGQgbW9kZSBub3cuJyk7CiAgfQoKICB2YXIgcGF1c2VkID0gc3RhcnRQYXVzZWQgfHwgZmFsc2U7CiAgdmFyIHJlYWRhYmxlID0gZmFsc2U7CgogIC8vIGNvbnZlcnQgdG8gYW4gb2xkLXN0eWxlIHN0cmVhbS4KICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwogIHN0cmVhbS5waXBlID0gU3RyZWFtLnByb3RvdHlwZS5waXBlOwogIHN0cmVhbS5vbiA9IHN0cmVhbS5hZGRMaXN0ZW5lciA9IFN0cmVhbS5wcm90b3R5cGUub247CgogIHN0cmVhbS5vbigncmVhZGFibGUnLCBmdW5jdGlvbigpIHsKICAgIHJlYWRhYmxlID0gdHJ1ZTsKCiAgICB2YXIgYzsKICAgIHdoaWxlICghcGF1c2VkICYmIChudWxsICE9PSAoYyA9IHN0cmVhbS5yZWFkKCkpKSkKICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBjKTsKCiAgICBpZiAoYyA9PT0gbnVsbCkgewogICAgICByZWFkYWJsZSA9IGZhbHNlOwogICAgICBzdHJlYW0uX3JlYWRhYmxlU3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKICAgIH0KICB9KTsKCiAgc3RyZWFtLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICBwYXVzZWQgPSB0cnVlOwogICAgdGhpcy5lbWl0KCdwYXVzZScpOwogIH07CgogIHN0cmVhbS5yZXN1bWUgPSBmdW5jdGlvbigpIHsKICAgIHBhdXNlZCA9IGZhbHNlOwogICAgaWYgKHJlYWRhYmxlKQogICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgdGhpcy5yZWFkKDApOwogICAgdGhpcy5lbWl0KCdyZXN1bWUnKTsKICB9OwoKICAvLyBub3cgbWFrZSBpdCBzdGFydCwganVzdCBpbiBjYXNlIGl0IGhhZG4ndCBhbHJlYWR5LgogIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwp9CgovLyB3cmFwIGFuIG9sZC1zdHlsZSBzdHJlYW0gYXMgdGhlIGFzeW5jIGRhdGEgc291cmNlLgovLyBUaGlzIGlzICpub3QqIHBhcnQgb2YgdGhlIHJlYWRhYmxlIHN0cmVhbSBpbnRlcmZhY2UuCi8vIEl0IGlzIGFuIHVnbHkgdW5mb3J0dW5hdGUgbWVzcyBvZiBoaXN0b3J5LgpSZWFkYWJsZS5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIHBhdXNlZCA9IGZhbHNlOwoKICB2YXIgc2VsZiA9IHRoaXM7CiAgc3RyZWFtLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgIGlmIChzdGF0ZS5kZWNvZGVyICYmICFzdGF0ZS5lbmRlZCkgewogICAgICB2YXIgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLmVuZCgpOwogICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKQogICAgICAgIHNlbGYucHVzaChjaHVuayk7CiAgICB9CgogICAgc2VsZi5wdXNoKG51bGwpOwogIH0pOwoKICBzdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgewogICAgaWYgKHN0YXRlLmRlY29kZXIpCiAgICAgIGNodW5rID0gc3RhdGUuZGVjb2Rlci53cml0ZShjaHVuayk7CgogICAgLy8gZG9uJ3Qgc2tpcCBvdmVyIGZhbHN5IHZhbHVlcyBpbiBvYmplY3RNb2RlCiAgICAvL2lmIChzdGF0ZS5vYmplY3RNb2RlICYmIHV0aWwuaXNOdWxsT3JVbmRlZmluZWQoY2h1bmspKQogICAgaWYgKHN0YXRlLm9iamVjdE1vZGUgJiYgKGNodW5rID09PSBudWxsIHx8IGNodW5rID09PSB1bmRlZmluZWQpKQogICAgICByZXR1cm47CiAgICBlbHNlIGlmICghc3RhdGUub2JqZWN0TW9kZSAmJiAoIWNodW5rIHx8ICFjaHVuay5sZW5ndGgpKQogICAgICByZXR1cm47CgogICAgdmFyIHJldCA9IHNlbGYucHVzaChjaHVuayk7CiAgICBpZiAoIXJldCkgewogICAgICBwYXVzZWQgPSB0cnVlOwogICAgICBzdHJlYW0ucGF1c2UoKTsKICAgIH0KICB9KTsKCiAgLy8gcHJveHkgYWxsIHRoZSBvdGhlciBtZXRob2RzLgogIC8vIGltcG9ydGFudCB3aGVuIHdyYXBwaW5nIGZpbHRlcnMgYW5kIGR1cGxleGVzLgogIGZvciAodmFyIGkgaW4gc3RyZWFtKSB7CiAgICBpZiAodHlwZW9mIHN0cmVhbVtpXSA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgIHR5cGVvZiB0aGlzW2ldID09PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzW2ldID0gZnVuY3Rpb24obWV0aG9kKSB7IHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3RyZWFtW21ldGhvZF0uYXBwbHkoc3RyZWFtLCBhcmd1bWVudHMpOwogICAgICB9fShpKTsKICAgIH0KICB9CgogIC8vIHByb3h5IGNlcnRhaW4gaW1wb3J0YW50IGV2ZW50cy4KICB2YXIgZXZlbnRzID0gWydlcnJvcicsICdjbG9zZScsICdkZXN0cm95JywgJ3BhdXNlJywgJ3Jlc3VtZSddOwogIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbihldikgewogICAgc3RyZWFtLm9uKGV2LCBzZWxmLmVtaXQuYmluZChzZWxmLCBldikpOwogIH0pOwoKICAvLyB3aGVuIHdlIHRyeSB0byBjb25zdW1lIHNvbWUgbW9yZSBieXRlcywgc2ltcGx5IHVucGF1c2UgdGhlCiAgLy8gdW5kZXJseWluZyBzdHJlYW0uCiAgc2VsZi5fcmVhZCA9IGZ1bmN0aW9uKG4pIHsKICAgIGlmIChwYXVzZWQpIHsKICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgIHN0cmVhbS5yZXN1bWUoKTsKICAgIH0KICB9OwoKICByZXR1cm4gc2VsZjsKfTsKCgoKLy8gZXhwb3NlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LgpSZWFkYWJsZS5fZnJvbUxpc3QgPSBmcm9tTGlzdDsKCi8vIFBsdWNrIG9mZiBuIGJ5dGVzIGZyb20gYW4gYXJyYXkgb2YgYnVmZmVycy4KLy8gTGVuZ3RoIGlzIHRoZSBjb21iaW5lZCBsZW5ndGhzIG9mIGFsbCB0aGUgYnVmZmVycyBpbiB0aGUgbGlzdC4KZnVuY3Rpb24gZnJvbUxpc3Qobiwgc3RhdGUpIHsKICB2YXIgbGlzdCA9IHN0YXRlLmJ1ZmZlcjsKICB2YXIgbGVuZ3RoID0gc3RhdGUubGVuZ3RoOwogIHZhciBzdHJpbmdNb2RlID0gISFzdGF0ZS5kZWNvZGVyOwogIHZhciBvYmplY3RNb2RlID0gISFzdGF0ZS5vYmplY3RNb2RlOwogIHZhciByZXQ7CgogIC8vIG5vdGhpbmcgaW4gdGhlIGxpc3QsIGRlZmluaXRlbHkgZW1wdHkuCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKQogICAgcmV0dXJuIG51bGw7CgogIGlmIChsZW5ndGggPT09IDApCiAgICByZXQgPSBudWxsOwogIGVsc2UgaWYgKG9iamVjdE1vZGUpCiAgICByZXQgPSBsaXN0LnNoaWZ0KCk7CiAgZWxzZSBpZiAoIW4gfHwgbiA+PSBsZW5ndGgpIHsKICAgIC8vIHJlYWQgaXQgYWxsLCB0cnVuY2F0ZSB0aGUgYXJyYXkuCiAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgcmV0ID0gbGlzdC5qb2luKCcnKTsKICAgIGVsc2UKICAgICAgcmV0ID0gQnVmZmVyLmNvbmNhdChsaXN0LCBsZW5ndGgpOwogICAgbGlzdC5sZW5ndGggPSAwOwogIH0gZWxzZSB7CiAgICAvLyByZWFkIGp1c3Qgc29tZSBvZiBpdC4KICAgIGlmIChuIDwgbGlzdFswXS5sZW5ndGgpIHsKICAgICAgLy8ganVzdCB0YWtlIGEgcGFydCBvZiB0aGUgZmlyc3QgbGlzdCBpdGVtLgogICAgICAvLyBzbGljZSBpcyB0aGUgc2FtZSBmb3IgYnVmZmVycyBhbmQgc3RyaW5ncy4KICAgICAgdmFyIGJ1ZiA9IGxpc3RbMF07CiAgICAgIHJldCA9IGJ1Zi5zbGljZSgwLCBuKTsKICAgICAgbGlzdFswXSA9IGJ1Zi5zbGljZShuKTsKICAgIH0gZWxzZSBpZiAobiA9PT0gbGlzdFswXS5sZW5ndGgpIHsKICAgICAgLy8gZmlyc3QgbGlzdCBpcyBhIHBlcmZlY3QgbWF0Y2gKICAgICAgcmV0ID0gbGlzdC5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gY29tcGxleCBjYXNlLgogICAgICAvLyB3ZSBoYXZlIGVub3VnaCB0byBjb3ZlciBpdCwgYnV0IGl0IHNwYW5zIHBhc3QgdGhlIGZpcnN0IGJ1ZmZlci4KICAgICAgaWYgKHN0cmluZ01vZGUpCiAgICAgICAgcmV0ID0gJyc7CiAgICAgIGVsc2UKICAgICAgICByZXQgPSBuZXcgQnVmZmVyKG4pOwoKICAgICAgdmFyIGMgPSAwOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbCAmJiBjIDwgbjsgaSsrKSB7CiAgICAgICAgdmFyIGJ1ZiA9IGxpc3RbMF07CiAgICAgICAgdmFyIGNweSA9IE1hdGgubWluKG4gLSBjLCBidWYubGVuZ3RoKTsKCiAgICAgICAgaWYgKHN0cmluZ01vZGUpCiAgICAgICAgICByZXQgKz0gYnVmLnNsaWNlKDAsIGNweSk7CiAgICAgICAgZWxzZQogICAgICAgICAgYnVmLmNvcHkocmV0LCBjLCAwLCBjcHkpOwoKICAgICAgICBpZiAoY3B5IDwgYnVmLmxlbmd0aCkKICAgICAgICAgIGxpc3RbMF0gPSBidWYuc2xpY2UoY3B5KTsKICAgICAgICBlbHNlCiAgICAgICAgICBsaXN0LnNoaWZ0KCk7CgogICAgICAgIGMgKz0gY3B5OwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBlbmRSZWFkYWJsZShzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CgogIC8vIElmIHdlIGdldCBoZXJlIGJlZm9yZSBjb25zdW1pbmcgYWxsIHRoZSBieXRlcywgdGhlbiB0aGF0IGlzIGEKICAvLyBidWcgaW4gbm9kZS4gIFNob3VsZCBuZXZlciBoYXBwZW4uCiAgaWYgKHN0YXRlLmxlbmd0aCA+IDApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2VuZFJlYWRhYmxlIGNhbGxlZCBvbiBub24tZW1wdHkgc3RyZWFtJyk7CgogIGlmICghc3RhdGUuZW5kRW1pdHRlZCAmJiBzdGF0ZS5jYWxsZWRSZWFkKSB7CiAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAvLyBDaGVjayB0aGF0IHdlIGRpZG4ndCBnZXQgb25lIGxhc3QgdW5zaGlmdC4KICAgICAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkICYmIHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCmZ1bmN0aW9uIGluZGV4T2YgKHhzLCB4KSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSB4cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmICh4c1tpXSA9PT0geCkgcmV0dXJuIGk7CiAgfQogIHJldHVybiAtMTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyJfcHJvY2VzcyI6NjAsImJ1ZmZlciI6NTMsImNvcmUtdXRpbC1pcyI6NjcsImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwiaXNhcnJheSI6NTgsInN0cmVhbSI6NzIsInN0cmluZ19kZWNvZGVyLyI6NzN9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCgovLyBhIHRyYW5zZm9ybSBzdHJlYW0gaXMgYSByZWFkYWJsZS93cml0YWJsZSBzdHJlYW0gd2hlcmUgeW91IGRvCi8vIHNvbWV0aGluZyB3aXRoIHRoZSBkYXRhLiAgU29tZXRpbWVzIGl0J3MgY2FsbGVkIGEgImZpbHRlciIsCi8vIGJ1dCB0aGF0J3Mgbm90IGEgZ3JlYXQgbmFtZSBmb3IgaXQsIHNpbmNlIHRoYXQgaW1wbGllcyBhIHRoaW5nIHdoZXJlCi8vIHNvbWUgYml0cyBwYXNzIHRocm91Z2gsIGFuZCBvdGhlcnMgYXJlIHNpbXBseSBpZ25vcmVkLiAgKFRoYXQgd291bGQKLy8gYmUgYSB2YWxpZCBleGFtcGxlIG9mIGEgdHJhbnNmb3JtLCBvZiBjb3Vyc2UuKQovLwovLyBXaGlsZSB0aGUgb3V0cHV0IGlzIGNhdXNhbGx5IHJlbGF0ZWQgdG8gdGhlIGlucHV0LCBpdCdzIG5vdCBhCi8vIG5lY2Vzc2FyaWx5IHN5bW1ldHJpYyBvciBzeW5jaHJvbm91cyB0cmFuc2Zvcm1hdGlvbi4gIEZvciBleGFtcGxlLAovLyBhIHpsaWIgc3RyZWFtIG1pZ2h0IHRha2UgbXVsdGlwbGUgcGxhaW4tdGV4dCB3cml0ZXMoKSwgYW5kIHRoZW4KLy8gZW1pdCBhIHNpbmdsZSBjb21wcmVzc2VkIGNodW5rIHNvbWUgdGltZSBpbiB0aGUgZnV0dXJlLgovLwovLyBIZXJlJ3MgaG93IHRoaXMgd29ya3M6Ci8vCi8vIFRoZSBUcmFuc2Zvcm0gc3RyZWFtIGhhcyBhbGwgdGhlIGFzcGVjdHMgb2YgdGhlIHJlYWRhYmxlIGFuZCB3cml0YWJsZQovLyBzdHJlYW0gY2xhc3Nlcy4gIFdoZW4geW91IHdyaXRlKGNodW5rKSwgdGhhdCBjYWxscyBfd3JpdGUoY2h1bmssY2IpCi8vIGludGVybmFsbHksIGFuZCByZXR1cm5zIGZhbHNlIGlmIHRoZXJlJ3MgYSBsb3Qgb2YgcGVuZGluZyB3cml0ZXMKLy8gYnVmZmVyZWQgdXAuICBXaGVuIHlvdSBjYWxsIHJlYWQoKSwgdGhhdCBjYWxscyBfcmVhZChuKSB1bnRpbAovLyB0aGVyZSdzIGVub3VnaCBwZW5kaW5nIHJlYWRhYmxlIGRhdGEgYnVmZmVyZWQgdXAuCi8vCi8vIEluIGEgdHJhbnNmb3JtIHN0cmVhbSwgdGhlIHdyaXR0ZW4gZGF0YSBpcyBwbGFjZWQgaW4gYSBidWZmZXIuICBXaGVuCi8vIF9yZWFkKG4pIGlzIGNhbGxlZCwgaXQgdHJhbnNmb3JtcyB0aGUgcXVldWVkIHVwIGRhdGEsIGNhbGxpbmcgdGhlCi8vIGJ1ZmZlcmVkIF93cml0ZSBjYidzIGFzIGl0IGNvbnN1bWVzIGNodW5rcy4gIElmIGNvbnN1bWluZyBhIHNpbmdsZQovLyB3cml0dGVuIGNodW5rIHdvdWxkIHJlc3VsdCBpbiBtdWx0aXBsZSBvdXRwdXQgY2h1bmtzLCB0aGVuIHRoZSBmaXJzdAovLyBvdXRwdXR0ZWQgYml0IGNhbGxzIHRoZSByZWFkY2IsIGFuZCBzdWJzZXF1ZW50IGNodW5rcyBqdXN0IGdvIGludG8KLy8gdGhlIHJlYWQgYnVmZmVyLCBhbmQgd2lsbCBjYXVzZSBpdCB0byBlbWl0ICdyZWFkYWJsZScgaWYgbmVjZXNzYXJ5LgovLwovLyBUaGlzIHdheSwgYmFjay1wcmVzc3VyZSBpcyBhY3R1YWxseSBkZXRlcm1pbmVkIGJ5IHRoZSByZWFkaW5nIHNpZGUsCi8vIHNpbmNlIF9yZWFkIGhhcyB0byBiZSBjYWxsZWQgdG8gc3RhcnQgcHJvY2Vzc2luZyBhIG5ldyBjaHVuay4gIEhvd2V2ZXIsCi8vIGEgcGF0aG9sb2dpY2FsIGluZmxhdGUgdHlwZSBvZiB0cmFuc2Zvcm0gY2FuIGNhdXNlIGV4Y2Vzc2l2ZSBidWZmZXJpbmcKLy8gaGVyZS4gIEZvciBleGFtcGxlLCBpbWFnaW5lIGEgc3RyZWFtIHdoZXJlIGV2ZXJ5IGJ5dGUgb2YgaW5wdXQgaXMKLy8gaW50ZXJwcmV0ZWQgYXMgYW4gaW50ZWdlciBmcm9tIDAtMjU1LCBhbmQgdGhlbiByZXN1bHRzIGluIHRoYXQgbWFueQovLyBieXRlcyBvZiBvdXRwdXQuICBXcml0aW5nIHRoZSA0IGJ5dGVzIHtmZixmZixmZixmZn0gd291bGQgcmVzdWx0IGluCi8vIDFrYiBvZiBkYXRhIGJlaW5nIG91dHB1dC4gIEluIHRoaXMgY2FzZSwgeW91IGNvdWxkIHdyaXRlIGEgdmVyeSBzbWFsbAovLyBhbW91bnQgb2YgaW5wdXQsIGFuZCBlbmQgdXAgd2l0aCBhIHZlcnkgbGFyZ2UgYW1vdW50IG9mIG91dHB1dC4gIEluCi8vIHN1Y2ggYSBwYXRob2xvZ2ljYWwgaW5mbGF0aW5nIG1lY2hhbmlzbSwgdGhlcmUnZCBiZSBubyB3YXkgdG8gdGVsbAovLyB0aGUgc3lzdGVtIHRvIHN0b3AgZG9pbmcgdGhlIHRyYW5zZm9ybS4gIEEgc2luZ2xlIDRNQiB3cml0ZSBjb3VsZAovLyBjYXVzZSB0aGUgc3lzdGVtIHRvIHJ1biBvdXQgb2YgbWVtb3J5LgovLwovLyBIb3dldmVyLCBldmVuIGluIHN1Y2ggYSBwYXRob2xvZ2ljYWwgY2FzZSwgb25seSBhIHNpbmdsZSB3cml0dGVuIGNodW5rCi8vIHdvdWxkIGJlIGNvbnN1bWVkLCBhbmQgdGhlbiB0aGUgcmVzdCB3b3VsZCB3YWl0ICh1bi10cmFuc2Zvcm1lZCkgdW50aWwKLy8gdGhlIHJlc3VsdHMgb2YgdGhlIHByZXZpb3VzIHRyYW5zZm9ybWVkIGNodW5rIHdlcmUgY29uc3VtZWQuCgptb2R1bGUuZXhwb3J0cyA9IFRyYW5zZm9ybTsKCnZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp1dGlsLmluaGVyaXRzKFRyYW5zZm9ybSwgRHVwbGV4KTsKCgpmdW5jdGlvbiBUcmFuc2Zvcm1TdGF0ZShvcHRpb25zLCBzdHJlYW0pIHsKICB0aGlzLmFmdGVyVHJhbnNmb3JtID0gZnVuY3Rpb24oZXIsIGRhdGEpIHsKICAgIHJldHVybiBhZnRlclRyYW5zZm9ybShzdHJlYW0sIGVyLCBkYXRhKTsKICB9OwoKICB0aGlzLm5lZWRUcmFuc2Zvcm0gPSBmYWxzZTsKICB0aGlzLnRyYW5zZm9ybWluZyA9IGZhbHNlOwogIHRoaXMud3JpdGVjYiA9IG51bGw7CiAgdGhpcy53cml0ZWNodW5rID0gbnVsbDsKfQoKZnVuY3Rpb24gYWZ0ZXJUcmFuc2Zvcm0oc3RyZWFtLCBlciwgZGF0YSkgewogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CiAgdHMudHJhbnNmb3JtaW5nID0gZmFsc2U7CgogIHZhciBjYiA9IHRzLndyaXRlY2I7CgogIGlmICghY2IpCiAgICByZXR1cm4gc3RyZWFtLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdubyB3cml0ZWNiIGluIFRyYW5zZm9ybSBjbGFzcycpKTsKCiAgdHMud3JpdGVjaHVuayA9IG51bGw7CiAgdHMud3JpdGVjYiA9IG51bGw7CgogIGlmIChkYXRhICE9PSBudWxsICYmIGRhdGEgIT09IHVuZGVmaW5lZCkKICAgIHN0cmVhbS5wdXNoKGRhdGEpOwoKICBpZiAoY2IpCiAgICBjYihlcik7CgogIHZhciBycyA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICBycy5yZWFkaW5nID0gZmFsc2U7CiAgaWYgKHJzLm5lZWRSZWFkYWJsZSB8fCBycy5sZW5ndGggPCBycy5oaWdoV2F0ZXJNYXJrKSB7CiAgICBzdHJlYW0uX3JlYWQocnMuaGlnaFdhdGVyTWFyayk7CiAgfQp9CgoKZnVuY3Rpb24gVHJhbnNmb3JtKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVHJhbnNmb3JtKSkKICAgIHJldHVybiBuZXcgVHJhbnNmb3JtKG9wdGlvbnMpOwoKICBEdXBsZXguY2FsbCh0aGlzLCBvcHRpb25zKTsKCiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGUgPSBuZXcgVHJhbnNmb3JtU3RhdGUob3B0aW9ucywgdGhpcyk7CgogIC8vIHdoZW4gdGhlIHdyaXRhYmxlIHNpZGUgZmluaXNoZXMsIHRoZW4gZmx1c2ggb3V0IGFueXRoaW5nIHJlbWFpbmluZy4KICB2YXIgc3RyZWFtID0gdGhpczsKCiAgLy8gc3RhcnQgb3V0IGFza2luZyBmb3IgYSByZWFkYWJsZSBldmVudCBvbmNlIGRhdGEgaXMgdHJhbnNmb3JtZWQuCiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwoKICAvLyB3ZSBoYXZlIGltcGxlbWVudGVkIHRoZSBfcmVhZCBtZXRob2QsIGFuZCBkb25lIHRoZSBvdGhlciB0aGluZ3MKICAvLyB0aGF0IFJlYWRhYmxlIHdhbnRzIGJlZm9yZSB0aGUgZmlyc3QgX3JlYWQgY2FsbCwgc28gdW5zZXQgdGhlCiAgLy8gc3luYyBndWFyZCBmbGFnLgogIHRoaXMuX3JlYWRhYmxlU3RhdGUuc3luYyA9IGZhbHNlOwoKICB0aGlzLm9uY2UoJ2ZpbmlzaCcsIGZ1bmN0aW9uKCkgewogICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiB0aGlzLl9mbHVzaCkKICAgICAgdGhpcy5fZmx1c2goZnVuY3Rpb24oZXIpIHsKICAgICAgICBkb25lKHN0cmVhbSwgZXIpOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgZG9uZShzdHJlYW0pOwogIH0pOwp9CgpUcmFuc2Zvcm0ucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcpIHsKICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5uZWVkVHJhbnNmb3JtID0gZmFsc2U7CiAgcmV0dXJuIER1cGxleC5wcm90b3R5cGUucHVzaC5jYWxsKHRoaXMsIGNodW5rLCBlbmNvZGluZyk7Cn07CgovLyBUaGlzIGlzIHRoZSBwYXJ0IHdoZXJlIHlvdSBkbyBzdHVmZiEKLy8gb3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiBpbiBpbXBsZW1lbnRhdGlvbiBjbGFzc2VzLgovLyAnY2h1bmsnIGlzIGFuIGlucHV0IGNodW5rLgovLwovLyBDYWxsIGBwdXNoKG5ld0NodW5rKWAgdG8gcGFzcyBhbG9uZyB0cmFuc2Zvcm1lZCBvdXRwdXQKLy8gdG8gdGhlIHJlYWRhYmxlIHNpZGUuICBZb3UgbWF5IGNhbGwgJ3B1c2gnIHplcm8gb3IgbW9yZSB0aW1lcy4KLy8KLy8gQ2FsbCBgY2IoZXJyKWAgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCB0aGlzIGNodW5rLiAgSWYgeW91IHBhc3MKLy8gYW4gZXJyb3IsIHRoZW4gdGhhdCdsbCBwdXQgdGhlIGh1cnQgb24gdGhlIHdob2xlIG9wZXJhdGlvbi4gIElmIHlvdQovLyBuZXZlciBjYWxsIGNiKCksIHRoZW4geW91J2xsIG5ldmVyIGdldCBhbm90aGVyIGNodW5rLgpUcmFuc2Zvcm0ucHJvdG90eXBlLl90cmFuc2Zvcm0gPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhyb3cgbmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKTsKfTsKClRyYW5zZm9ybS5wcm90b3R5cGUuX3dyaXRlID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIHZhciB0cyA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlOwogIHRzLndyaXRlY2IgPSBjYjsKICB0cy53cml0ZWNodW5rID0gY2h1bms7CiAgdHMud3JpdGVlbmNvZGluZyA9IGVuY29kaW5nOwogIGlmICghdHMudHJhbnNmb3JtaW5nKSB7CiAgICB2YXIgcnMgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKHRzLm5lZWRUcmFuc2Zvcm0gfHwKICAgICAgICBycy5uZWVkUmVhZGFibGUgfHwKICAgICAgICBycy5sZW5ndGggPCBycy5oaWdoV2F0ZXJNYXJrKQogICAgICB0aGlzLl9yZWFkKHJzLmhpZ2hXYXRlck1hcmspOwogIH0KfTsKCi8vIERvZXNuJ3QgbWF0dGVyIHdoYXQgdGhlIGFyZ3MgYXJlIGhlcmUuCi8vIF90cmFuc2Zvcm0gZG9lcyBhbGwgdGhlIHdvcmsuCi8vIFRoYXQgd2UgZ290IGhlcmUgbWVhbnMgdGhhdCB0aGUgcmVhZGFibGUgc2lkZSB3YW50cyBtb3JlIGRhdGEuClRyYW5zZm9ybS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh0cy53cml0ZWNodW5rICE9PSBudWxsICYmIHRzLndyaXRlY2IgJiYgIXRzLnRyYW5zZm9ybWluZykgewogICAgdHMudHJhbnNmb3JtaW5nID0gdHJ1ZTsKICAgIHRoaXMuX3RyYW5zZm9ybSh0cy53cml0ZWNodW5rLCB0cy53cml0ZWVuY29kaW5nLCB0cy5hZnRlclRyYW5zZm9ybSk7CiAgfSBlbHNlIHsKICAgIC8vIG1hcmsgdGhhdCB3ZSBuZWVkIGEgdHJhbnNmb3JtLCBzbyB0aGF0IGFueSBkYXRhIHRoYXQgY29tZXMgaW4KICAgIC8vIHdpbGwgZ2V0IHByb2Nlc3NlZCwgbm93IHRoYXQgd2UndmUgYXNrZWQgZm9yIGl0LgogICAgdHMubmVlZFRyYW5zZm9ybSA9IHRydWU7CiAgfQp9OwoKCmZ1bmN0aW9uIGRvbmUoc3RyZWFtLCBlcikgewogIGlmIChlcikKICAgIHJldHVybiBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CgogIC8vIGlmIHRoZXJlJ3Mgbm90aGluZyBpbiB0aGUgd3JpdGUgYnVmZmVyLCB0aGVuIHRoYXQgbWVhbnMKICAvLyB0aGF0IG5vdGhpbmcgbW9yZSB3aWxsIGV2ZXIgYmUgcHJvdmlkZWQKICB2YXIgd3MgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGU7CiAgdmFyIHJzID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh3cy5sZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbGxpbmcgdHJhbnNmb3JtIGRvbmUgd2hlbiB3cy5sZW5ndGggIT0gMCcpOwoKICBpZiAodHMudHJhbnNmb3JtaW5nKQogICAgdGhyb3cgbmV3IEVycm9yKCdjYWxsaW5nIHRyYW5zZm9ybSBkb25lIHdoZW4gc3RpbGwgdHJhbnNmb3JtaW5nJyk7CgogIHJldHVybiBzdHJlYW0ucHVzaChudWxsKTsKfQoKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjYyLCJjb3JlLXV0aWwtaXMiOjY3LCJpbmhlcml0cyI6NzZ9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIEEgYml0IHNpbXBsZXIgdGhhbiByZWFkYWJsZSBzdHJlYW1zLgovLyBJbXBsZW1lbnQgYW4gYXN5bmMgLl93cml0ZShjaHVuaywgY2IpLCBhbmQgaXQnbGwgaGFuZGxlIGFsbAovLyB0aGUgZHJhaW4gZXZlbnQgZW1pc3Npb24gYW5kIGJ1ZmZlcmluZy4KCm1vZHVsZS5leHBvcnRzID0gV3JpdGFibGU7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCldyaXRhYmxlLldyaXRhYmxlU3RhdGUgPSBXcml0YWJsZVN0YXRlOwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciB1dGlsID0gcmVxdWlyZSgnY29yZS11dGlsLWlzJyk7CnV0aWwuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCnZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTsKCnV0aWwuaW5oZXJpdHMoV3JpdGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhpcy5jaHVuayA9IGNodW5rOwogIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZzsKICB0aGlzLmNhbGxiYWNrID0gY2I7Cn0KCmZ1bmN0aW9uIFdyaXRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCB3cml0ZSgpIHN0YXJ0cyByZXR1cm5pbmcgZmFsc2UKICAvLyBOb3RlOiAwIGlzIGEgdmFsaWQgdmFsdWUsIG1lYW5zIHRoYXQgd2UgYWx3YXlzIHJldHVybiBmYWxzZSBpZgogIC8vIHRoZSBlbnRpcmUgYnVmZmVyIGlzIG5vdCBmbHVzaGVkIGltbWVkaWF0ZWx5IG9uIHdyaXRlKCkKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHRoaXMuaGlnaFdhdGVyTWFyayA9IChod20gfHwgaHdtID09PSAwKSA/IGh3bSA6IDE2ICogMTAyNDsKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnIHRvIGluZGljYXRlIHdoZXRoZXIgb3Igbm90IHRoaXMgc3RyZWFtCiAgLy8gY29udGFpbnMgYnVmZmVycyBvciBvYmplY3RzLgogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICAvLyBjYXN0IHRvIGludHMuCiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gfn50aGlzLmhpZ2hXYXRlck1hcms7CgogIHRoaXMubmVlZERyYWluID0gZmFsc2U7CiAgLy8gYXQgdGhlIHN0YXJ0IG9mIGNhbGxpbmcgZW5kKCkKICB0aGlzLmVuZGluZyA9IGZhbHNlOwogIC8vIHdoZW4gZW5kKCkgaGFzIGJlZW4gY2FsbGVkLCBhbmQgcmV0dXJuZWQKICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgLy8gd2hlbiAnZmluaXNoJyBpcyBlbWl0dGVkCiAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwoKICAvLyBzaG91bGQgd2UgZGVjb2RlIHN0cmluZ3MgaW50byBidWZmZXJzIGJlZm9yZSBwYXNzaW5nIHRvIF93cml0ZT8KICAvLyB0aGlzIGlzIGhlcmUgc28gdGhhdCBzb21lIG5vZGUtY29yZSBzdHJlYW1zIGNhbiBvcHRpbWl6ZSBzdHJpbmcKICAvLyBoYW5kbGluZyBhdCBhIGxvd2VyIGxldmVsLgogIHZhciBub0RlY29kZSA9IG9wdGlvbnMuZGVjb2RlU3RyaW5ncyA9PT0gZmFsc2U7CiAgdGhpcy5kZWNvZGVTdHJpbmdzID0gIW5vRGVjb2RlOwoKICAvLyBDcnlwdG8gaXMga2luZCBvZiBvbGQgYW5kIGNydXN0eS4gIEhpc3RvcmljYWxseSwgaXRzIGRlZmF1bHQgc3RyaW5nCiAgLy8gZW5jb2RpbmcgaXMgJ2JpbmFyeScgc28gd2UgaGF2ZSB0byBtYWtlIHRoaXMgY29uZmlndXJhYmxlLgogIC8vIEV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgdW5pdmVyc2UgdXNlcyAndXRmOCcsIHRob3VnaC4KICB0aGlzLmRlZmF1bHRFbmNvZGluZyA9IG9wdGlvbnMuZGVmYXVsdEVuY29kaW5nIHx8ICd1dGY4JzsKCiAgLy8gbm90IGFuIGFjdHVhbCBidWZmZXIgd2Uga2VlcCB0cmFjayBvZiwgYnV0IGEgbWVhc3VyZW1lbnQKICAvLyBvZiBob3cgbXVjaCB3ZSdyZSB3YWl0aW5nIHRvIGdldCBwdXNoZWQgdG8gc29tZSB1bmRlcmx5aW5nCiAgLy8gc29ja2V0IG9yIGZpbGUuCiAgdGhpcy5sZW5ndGggPSAwOwoKICAvLyBhIGZsYWcgdG8gc2VlIHdoZW4gd2UncmUgaW4gdGhlIG1pZGRsZSBvZiBhIHdyaXRlLgogIHRoaXMud3JpdGluZyA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWN1YXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gYSBmbGFnIHRvIGtub3cgaWYgd2UncmUgcHJvY2Vzc2luZyBwcmV2aW91c2x5IGJ1ZmZlcmVkIGl0ZW1zLCB3aGljaAogIC8vIG1heSBjYWxsIHRoZSBfd3JpdGUoKSBjYWxsYmFjayBpbiB0aGUgc2FtZSB0aWNrLCBzbyB0aGF0IHdlIGRvbid0CiAgLy8gZW5kIHVwIGluIGFuIG92ZXJsYXBwZWQgb253cml0ZSBzaXR1YXRpb24uCiAgdGhpcy5idWZmZXJQcm9jZXNzaW5nID0gZmFsc2U7CgogIC8vIHRoZSBjYWxsYmFjayB0aGF0J3MgcGFzc2VkIHRvIF93cml0ZShjaHVuayxjYikKICB0aGlzLm9ud3JpdGUgPSBmdW5jdGlvbihlcikgewogICAgb253cml0ZShzdHJlYW0sIGVyKTsKICB9OwoKICAvLyB0aGUgY2FsbGJhY2sgdGhhdCB0aGUgdXNlciBzdXBwbGllcyB0byB3cml0ZShjaHVuayxlbmNvZGluZyxjYikKICB0aGlzLndyaXRlY2IgPSBudWxsOwoKICAvLyB0aGUgYW1vdW50IHRoYXQgaXMgYmVpbmcgd3JpdHRlbiB3aGVuIF93cml0ZSBpcyBjYWxsZWQuCiAgdGhpcy53cml0ZWxlbiA9IDA7CgogIHRoaXMuYnVmZmVyID0gW107CgogIC8vIFRydWUgaWYgdGhlIGVycm9yIHdhcyBhbHJlYWR5IGVtaXR0ZWQgYW5kIHNob3VsZCBub3QgYmUgdGhyb3duIGFnYWluCiAgdGhpcy5lcnJvckVtaXR0ZWQgPSBmYWxzZTsKfQoKZnVuY3Rpb24gV3JpdGFibGUob3B0aW9ucykgewogIHZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgogIC8vIFdyaXRhYmxlIGN0b3IgaXMgYXBwbGllZCB0byBEdXBsZXhlcywgdGhvdWdoIHRoZXkncmUgbm90CiAgLy8gaW5zdGFuY2VvZiBXcml0YWJsZSwgdGhleSdyZSBpbnN0YW5jZW9mIFJlYWRhYmxlLgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBXcml0YWJsZSkgJiYgISh0aGlzIGluc3RhbmNlb2YgRHVwbGV4KSkKICAgIHJldHVybiBuZXcgV3JpdGFibGUob3B0aW9ucyk7CgogIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZShvcHRpb25zLCB0aGlzKTsKCiAgLy8gbGVnYWN5LgogIHRoaXMud3JpdGFibGUgPSB0cnVlOwoKICBTdHJlYW0uY2FsbCh0aGlzKTsKfQoKLy8gT3RoZXJ3aXNlIHBlb3BsZSBjYW4gcGlwZSBXcml0YWJsZSBzdHJlYW1zLCB3aGljaCBpcyBqdXN0IHdyb25nLgpXcml0YWJsZS5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ0Nhbm5vdCBwaXBlLiBOb3QgcmVhZGFibGUuJykpOwp9OwoKCmZ1bmN0aW9uIHdyaXRlQWZ0ZXJFbmQoc3RyZWFtLCBzdGF0ZSwgY2IpIHsKICB2YXIgZXIgPSBuZXcgRXJyb3IoJ3dyaXRlIGFmdGVyIGVuZCcpOwogIC8vIFRPRE86IGRlZmVyIGVycm9yIGV2ZW50cyBjb25zaXN0ZW50bHkgZXZlcnl3aGVyZSwgbm90IGp1c3QgdGhlIGNiCiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICBjYihlcik7CiAgfSk7Cn0KCi8vIElmIHdlIGdldCBzb21ldGhpbmcgdGhhdCBpcyBub3QgYSBidWZmZXIsIHN0cmluZywgbnVsbCwgb3IgdW5kZWZpbmVkLAovLyBhbmQgd2UncmUgbm90IGluIG9iamVjdE1vZGUsIHRoZW4gdGhhdCdzIGFuIGVycm9yLgovLyBPdGhlcndpc2Ugc3RyZWFtIGNodW5rcyBhcmUgYWxsIGNvbnNpZGVyZWQgdG8gYmUgb2YgbGVuZ3RoPTEsIGFuZCB0aGUKLy8gd2F0ZXJtYXJrcyBkZXRlcm1pbmUgaG93IG1hbnkgb2JqZWN0cyB0byBrZWVwIGluIHRoZSBidWZmZXIsIHJhdGhlciB0aGFuCi8vIGhvdyBtYW55IGJ5dGVzIG9yIGNoYXJhY3RlcnMuCmZ1bmN0aW9uIHZhbGlkQ2h1bmsoc3RyZWFtLCBzdGF0ZSwgY2h1bmssIGNiKSB7CiAgdmFyIHZhbGlkID0gdHJ1ZTsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgJ3N0cmluZycgIT09IHR5cGVvZiBjaHVuayAmJgogICAgICBjaHVuayAhPT0gbnVsbCAmJgogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmCiAgICAgICFzdGF0ZS5vYmplY3RNb2RlKSB7CiAgICB2YXIgZXIgPSBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG5vbi1zdHJpbmcvYnVmZmVyIGNodW5rJyk7CiAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICBjYihlcik7CiAgICB9KTsKICAgIHZhbGlkID0gZmFsc2U7CiAgfQogIHJldHVybiB2YWxpZDsKfQoKV3JpdGFibGUucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIHZhciBzdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgdmFyIHJldCA9IGZhbHNlOwoKICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGVuY29kaW5nOwogICAgZW5jb2RpbmcgPSBudWxsOwogIH0KCiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVuaykpCiAgICBlbmNvZGluZyA9ICdidWZmZXInOwogIGVsc2UgaWYgKCFlbmNvZGluZykKICAgIGVuY29kaW5nID0gc3RhdGUuZGVmYXVsdEVuY29kaW5nOwoKICBpZiAodHlwZW9mIGNiICE9PSAnZnVuY3Rpb24nKQogICAgY2IgPSBmdW5jdGlvbigpIHt9OwoKICBpZiAoc3RhdGUuZW5kZWQpCiAgICB3cml0ZUFmdGVyRW5kKHRoaXMsIHN0YXRlLCBjYik7CiAgZWxzZSBpZiAodmFsaWRDaHVuayh0aGlzLCBzdGF0ZSwgY2h1bmssIGNiKSkKICAgIHJldCA9IHdyaXRlT3JCdWZmZXIodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICByZXR1cm4gcmV0Owp9OwoKZnVuY3Rpb24gZGVjb2RlQ2h1bmsoc3RhdGUsIGNodW5rLCBlbmNvZGluZykgewogIGlmICghc3RhdGUub2JqZWN0TW9kZSAmJgogICAgICBzdGF0ZS5kZWNvZGVTdHJpbmdzICE9PSBmYWxzZSAmJgogICAgICB0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICBjaHVuayA9IG5ldyBCdWZmZXIoY2h1bmssIGVuY29kaW5nKTsKICB9CiAgcmV0dXJuIGNodW5rOwp9CgovLyBpZiB3ZSdyZSBhbHJlYWR5IHdyaXRpbmcgc29tZXRoaW5nLCB0aGVuIGp1c3QgcHV0IHRoaXMKLy8gaW4gdGhlIHF1ZXVlLCBhbmQgd2FpdCBvdXIgdHVybi4gIE90aGVyd2lzZSwgY2FsbCBfd3JpdGUKLy8gSWYgd2UgcmV0dXJuIGZhbHNlLCB0aGVuIHdlIG5lZWQgYSBkcmFpbiBldmVudCwgc28gc2V0IHRoYXQgZmxhZy4KZnVuY3Rpb24gd3JpdGVPckJ1ZmZlcihzdHJlYW0sIHN0YXRlLCBjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgY2h1bmsgPSBkZWNvZGVDaHVuayhzdGF0ZSwgY2h1bmssIGVuY29kaW5nKTsKICBpZiAoQnVmZmVyLmlzQnVmZmVyKGNodW5rKSkKICAgIGVuY29kaW5nID0gJ2J1ZmZlcic7CiAgdmFyIGxlbiA9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwoKICBzdGF0ZS5sZW5ndGggKz0gbGVuOwoKICB2YXIgcmV0ID0gc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyazsKICAvLyB3ZSBtdXN0IGVuc3VyZSB0aGF0IHByZXZpb3VzIG5lZWREcmFpbiB3aWxsIG5vdCBiZSByZXNldCB0byBmYWxzZS4KICBpZiAoIXJldCkKICAgIHN0YXRlLm5lZWREcmFpbiA9IHRydWU7CgogIGlmIChzdGF0ZS53cml0aW5nKQogICAgc3RhdGUuYnVmZmVyLnB1c2gobmV3IFdyaXRlUmVxKGNodW5rLCBlbmNvZGluZywgY2IpKTsKICBlbHNlCiAgICBkb1dyaXRlKHN0cmVhbSwgc3RhdGUsIGxlbiwgY2h1bmssIGVuY29kaW5nLCBjYik7CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgbGVuLCBjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgc3RhdGUud3JpdGVsZW4gPSBsZW47CiAgc3RhdGUud3JpdGVjYiA9IGNiOwogIHN0YXRlLndyaXRpbmcgPSB0cnVlOwogIHN0YXRlLnN5bmMgPSB0cnVlOwogIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICBzdGF0ZS5zeW5jID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIG9ud3JpdGVFcnJvcihzdHJlYW0sIHN0YXRlLCBzeW5jLCBlciwgY2IpIHsKICBpZiAoc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIGNiKGVyKTsKICAgIH0pOwogIGVsc2UKICAgIGNiKGVyKTsKCiAgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVycm9yRW1pdHRlZCA9IHRydWU7CiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwp9CgpmdW5jdGlvbiBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpIHsKICBzdGF0ZS53cml0aW5nID0gZmFsc2U7CiAgc3RhdGUud3JpdGVjYiA9IG51bGw7CiAgc3RhdGUubGVuZ3RoIC09IHN0YXRlLndyaXRlbGVuOwogIHN0YXRlLndyaXRlbGVuID0gMDsKfQoKZnVuY3Rpb24gb253cml0ZShzdHJlYW0sIGVyKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciBzeW5jID0gc3RhdGUuc3luYzsKICB2YXIgY2IgPSBzdGF0ZS53cml0ZWNiOwoKICBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpOwoKICBpZiAoZXIpCiAgICBvbndyaXRlRXJyb3Ioc3RyZWFtLCBzdGF0ZSwgc3luYywgZXIsIGNiKTsKICBlbHNlIHsKICAgIC8vIENoZWNrIGlmIHdlJ3JlIGFjdHVhbGx5IHJlYWR5IHRvIGZpbmlzaCwgYnV0IGRvbid0IGVtaXQgeWV0CiAgICB2YXIgZmluaXNoZWQgPSBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpOwoKICAgIGlmICghZmluaXNoZWQgJiYgIXN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgY2xlYXJCdWZmZXIoc3RyZWFtLCBzdGF0ZSk7CgogICAgaWYgKHN5bmMpIHsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICBhZnRlcldyaXRlKHN0cmVhbSwgc3RhdGUsIGZpbmlzaGVkLCBjYik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpIHsKICBpZiAoIWZpbmlzaGVkKQogICAgb253cml0ZURyYWluKHN0cmVhbSwgc3RhdGUpOwogIGNiKCk7CiAgaWYgKGZpbmlzaGVkKQogICAgZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSk7Cn0KCi8vIE11c3QgZm9yY2UgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIG9uIG5leHRUaWNrLCBzbyB0aGF0IHdlIGRvbid0Ci8vIGVtaXQgJ2RyYWluJyBiZWZvcmUgdGhlIHdyaXRlKCkgY29uc3VtZXIgZ2V0cyB0aGUgJ2ZhbHNlJyByZXR1cm4KLy8gdmFsdWUsIGFuZCBoYXMgYSBjaGFuY2UgdG8gYXR0YWNoIGEgJ2RyYWluJyBsaXN0ZW5lci4KZnVuY3Rpb24gb253cml0ZURyYWluKHN0cmVhbSwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLm5lZWREcmFpbikgewogICAgc3RhdGUubmVlZERyYWluID0gZmFsc2U7CiAgICBzdHJlYW0uZW1pdCgnZHJhaW4nKTsKICB9Cn0KCgovLyBpZiB0aGVyZSdzIHNvbWV0aGluZyBpbiB0aGUgYnVmZmVyIHdhaXRpbmcsIHRoZW4gcHJvY2VzcyBpdApmdW5jdGlvbiBjbGVhckJ1ZmZlcihzdHJlYW0sIHN0YXRlKSB7CiAgc3RhdGUuYnVmZmVyUHJvY2Vzc2luZyA9IHRydWU7CgogIGZvciAodmFyIGMgPSAwOyBjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aDsgYysrKSB7CiAgICB2YXIgZW50cnkgPSBzdGF0ZS5idWZmZXJbY107CiAgICB2YXIgY2h1bmsgPSBlbnRyeS5jaHVuazsKICAgIHZhciBlbmNvZGluZyA9IGVudHJ5LmVuY29kaW5nOwogICAgdmFyIGNiID0gZW50cnkuY2FsbGJhY2s7CiAgICB2YXIgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CgogICAgZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCBsZW4sIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICAgIC8vIGlmIHdlIGRpZG4ndCBjYWxsIHRoZSBvbndyaXRlIGltbWVkaWF0ZWx5LCB0aGVuCiAgICAvLyBpdCBtZWFucyB0aGF0IHdlIG5lZWQgdG8gd2FpdCB1bnRpbCBpdCBkb2VzLgogICAgLy8gYWxzbywgdGhhdCBtZWFucyB0aGF0IHRoZSBjaHVuayBhbmQgY2IgYXJlIGN1cnJlbnRseQogICAgLy8gYmVpbmcgcHJvY2Vzc2VkLCBzbyBtb3ZlIHRoZSBidWZmZXIgY291bnRlciBwYXN0IHRoZW0uCiAgICBpZiAoc3RhdGUud3JpdGluZykgewogICAgICBjKys7CiAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgc3RhdGUuYnVmZmVyUHJvY2Vzc2luZyA9IGZhbHNlOwogIGlmIChjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgIHN0YXRlLmJ1ZmZlciA9IHN0YXRlLmJ1ZmZlci5zbGljZShjKTsKICBlbHNlCiAgICBzdGF0ZS5idWZmZXIubGVuZ3RoID0gMDsKfQoKV3JpdGFibGUucHJvdG90eXBlLl93cml0ZSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICBjYihuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpKTsKfTsKCldyaXRhYmxlLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBjaHVuazsKICAgIGNodW5rID0gbnVsbDsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBlbmNvZGluZzsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9CgogIGlmICh0eXBlb2YgY2h1bmsgIT09ICd1bmRlZmluZWQnICYmIGNodW5rICE9PSBudWxsKQogICAgdGhpcy53cml0ZShjaHVuaywgZW5jb2RpbmcpOwoKICAvLyBpZ25vcmUgdW5uZWNlc3NhcnkgZW5kKCkgY2FsbHMuCiAgaWYgKCFzdGF0ZS5lbmRpbmcgJiYgIXN0YXRlLmZpbmlzaGVkKQogICAgZW5kV3JpdGFibGUodGhpcywgc3RhdGUsIGNiKTsKfTsKCgpmdW5jdGlvbiBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpIHsKICByZXR1cm4gKHN0YXRlLmVuZGluZyAmJgogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwICYmCiAgICAgICAgICAhc3RhdGUuZmluaXNoZWQgJiYKICAgICAgICAgICFzdGF0ZS53cml0aW5nKTsKfQoKZnVuY3Rpb24gZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSkgewogIHZhciBuZWVkID0gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICBpZiAobmVlZCkgewogICAgc3RhdGUuZmluaXNoZWQgPSB0cnVlOwogICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpOwogIH0KICByZXR1cm4gbmVlZDsKfQoKZnVuY3Rpb24gZW5kV3JpdGFibGUoc3RyZWFtLCBzdGF0ZSwgY2IpIHsKICBzdGF0ZS5lbmRpbmcgPSB0cnVlOwogIGZpbmlzaE1heWJlKHN0cmVhbSwgc3RhdGUpOwogIGlmIChjYikgewogICAgaWYgKHN0YXRlLmZpbmlzaGVkKQogICAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTsKICAgIGVsc2UKICAgICAgc3RyZWFtLm9uY2UoJ2ZpbmlzaCcsIGNiKTsKICB9CiAgc3RhdGUuZW5kZWQgPSB0cnVlOwp9Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjYyLCJfcHJvY2VzcyI6NjAsImJ1ZmZlciI6NTMsImNvcmUtdXRpbC1pcyI6NjcsImluaGVyaXRzIjo3Niwic3RyZWFtIjo3Mn1dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChCdWZmZXIpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgovLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKLy8gYmVjYXVzZSBpdCBpcyBmcmFnaWxlIGFuZCBjYW4gYmUgZWFzaWx5IGZha2VkIHdpdGggYE9iamVjdC5jcmVhdGUoKWAuCmZ1bmN0aW9uIGlzQXJyYXkoYXIpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7Cn0KZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKCmZ1bmN0aW9uIGlzQm9vbGVhbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwp9CmV4cG9ydHMuaXNCb29sZWFuID0gaXNCb29sZWFuOwoKZnVuY3Rpb24gaXNOdWxsKGFyZykgewogIHJldHVybiBhcmcgPT09IG51bGw7Cn0KZXhwb3J0cy5pc051bGwgPSBpc051bGw7CgpmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09IG51bGw7Cn0KZXhwb3J0cy5pc051bGxPclVuZGVmaW5lZCA9IGlzTnVsbE9yVW5kZWZpbmVkOwoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CmV4cG9ydHMuaXNOdW1iZXIgPSBpc051bWJlcjsKCmZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKfQpleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CgpmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7Cn0KZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwoKZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwp9CmV4cG9ydHMuaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKCmZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9CmV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwoKZnVuY3Rpb24gaXNEYXRlKGQpIHsKICByZXR1cm4gaXNPYmplY3QoZCkgJiYgb2JqZWN0VG9TdHJpbmcoZCkgPT09ICdbb2JqZWN0IERhdGVdJzsKfQpleHBvcnRzLmlzRGF0ZSA9IGlzRGF0ZTsKCmZ1bmN0aW9uIGlzRXJyb3IoZSkgewogIHJldHVybiBpc09iamVjdChlKSAmJgogICAgICAob2JqZWN0VG9TdHJpbmcoZSkgPT09ICdbb2JqZWN0IEVycm9yXScgfHwgZSBpbnN0YW5jZW9mIEVycm9yKTsKfQpleHBvcnRzLmlzRXJyb3IgPSBpc0Vycm9yOwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQpleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwoKZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ251bWJlcicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCcgfHwgIC8vIEVTNiBzeW1ib2wKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCc7Cn0KZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwoKZnVuY3Rpb24gaXNCdWZmZXIoYXJnKSB7CiAgcmV0dXJuIEJ1ZmZlci5pc0J1ZmZlcihhcmcpOwp9CmV4cG9ydHMuaXNCdWZmZXIgPSBpc0J1ZmZlcjsKCmZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwp9Cn0pLmNhbGwodGhpcyxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCn0seyJidWZmZXIiOjUzfV0sNjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoIi4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiOjYzfV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7IC8vIGhhY2sgdG8gZml4IGEgY2lyY3VsYXIgZGVwZW5kZW5jeSBpc3N1ZSB3aGVuIHVzZWQgd2l0aCBicm93c2VyaWZ5CmV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fcmVhZGFibGUuanMnKTsKZXhwb3J0cy5TdHJlYW0gPSBTdHJlYW07CmV4cG9ydHMuUmVhZGFibGUgPSBleHBvcnRzOwpleHBvcnRzLldyaXRhYmxlID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV93cml0YWJsZS5qcycpOwpleHBvcnRzLkR1cGxleCA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fZHVwbGV4LmpzJyk7CmV4cG9ydHMuVHJhbnNmb3JtID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMnKTsKZXhwb3J0cy5QYXNzVGhyb3VnaCA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMnKTsKCn0seyIuL2xpYi9fc3RyZWFtX2R1cGxleC5qcyI6NjIsIi4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiOjYzLCIuL2xpYi9fc3RyZWFtX3JlYWRhYmxlLmpzIjo2NCwiLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMiOjY1LCIuL2xpYi9fc3RyZWFtX3dyaXRhYmxlLmpzIjo2Niwic3RyZWFtIjo3Mn1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCIuL2xpYi9fc3RyZWFtX3RyYW5zZm9ybS5qcyIpCgp9LHsiLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMiOjY1fV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoIi4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiOjY2fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFN0cmVhbTsKCnZhciBFRSA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCmluaGVyaXRzKFN0cmVhbSwgRUUpOwpTdHJlYW0uUmVhZGFibGUgPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vcmVhZGFibGUuanMnKTsKU3RyZWFtLldyaXRhYmxlID0gcmVxdWlyZSgncmVhZGFibGUtc3RyZWFtL3dyaXRhYmxlLmpzJyk7ClN0cmVhbS5EdXBsZXggPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vZHVwbGV4LmpzJyk7ClN0cmVhbS5UcmFuc2Zvcm0gPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vdHJhbnNmb3JtLmpzJyk7ClN0cmVhbS5QYXNzVGhyb3VnaCA9IHJlcXVpcmUoJ3JlYWRhYmxlLXN0cmVhbS9wYXNzdGhyb3VnaC5qcycpOwoKLy8gQmFja3dhcmRzLWNvbXBhdCB3aXRoIG5vZGUgMC40LngKU3RyZWFtLlN0cmVhbSA9IFN0cmVhbTsKCgoKLy8gb2xkLXN0eWxlIHN0cmVhbXMuICBOb3RlIHRoYXQgdGhlIHBpcGUgbWV0aG9kICh0aGUgb25seSByZWxldmFudAovLyBwYXJ0IG9mIHRoaXMgY2xhc3MpIGlzIG92ZXJyaWRkZW4gaW4gdGhlIFJlYWRhYmxlIGNsYXNzLgoKZnVuY3Rpb24gU3RyZWFtKCkgewogIEVFLmNhbGwodGhpcyk7Cn0KClN0cmVhbS5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKGRlc3QsIG9wdGlvbnMpIHsKICB2YXIgc291cmNlID0gdGhpczsKCiAgZnVuY3Rpb24gb25kYXRhKGNodW5rKSB7CiAgICBpZiAoZGVzdC53cml0YWJsZSkgewogICAgICBpZiAoZmFsc2UgPT09IGRlc3Qud3JpdGUoY2h1bmspICYmIHNvdXJjZS5wYXVzZSkgewogICAgICAgIHNvdXJjZS5wYXVzZSgpOwogICAgICB9CiAgICB9CiAgfQoKICBzb3VyY2Uub24oJ2RhdGEnLCBvbmRhdGEpOwoKICBmdW5jdGlvbiBvbmRyYWluKCkgewogICAgaWYgKHNvdXJjZS5yZWFkYWJsZSAmJiBzb3VyY2UucmVzdW1lKSB7CiAgICAgIHNvdXJjZS5yZXN1bWUoKTsKICAgIH0KICB9CgogIGRlc3Qub24oJ2RyYWluJywgb25kcmFpbik7CgogIC8vIElmIHRoZSAnZW5kJyBvcHRpb24gaXMgbm90IHN1cHBsaWVkLCBkZXN0LmVuZCgpIHdpbGwgYmUgY2FsbGVkIHdoZW4KICAvLyBzb3VyY2UgZ2V0cyB0aGUgJ2VuZCcgb3IgJ2Nsb3NlJyBldmVudHMuICBPbmx5IGRlc3QuZW5kKCkgb25jZS4KICBpZiAoIWRlc3QuX2lzU3RkaW8gJiYgKCFvcHRpb25zIHx8IG9wdGlvbnMuZW5kICE9PSBmYWxzZSkpIHsKICAgIHNvdXJjZS5vbignZW5kJywgb25lbmQpOwogICAgc291cmNlLm9uKCdjbG9zZScsIG9uY2xvc2UpOwogIH0KCiAgdmFyIGRpZE9uRW5kID0gZmFsc2U7CiAgZnVuY3Rpb24gb25lbmQoKSB7CiAgICBpZiAoZGlkT25FbmQpIHJldHVybjsKICAgIGRpZE9uRW5kID0gdHJ1ZTsKCiAgICBkZXN0LmVuZCgpOwogIH0KCgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBpZiAoZGlkT25FbmQpIHJldHVybjsKICAgIGRpZE9uRW5kID0gdHJ1ZTsKCiAgICBpZiAodHlwZW9mIGRlc3QuZGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykgZGVzdC5kZXN0cm95KCk7CiAgfQoKICAvLyBkb24ndCBsZWF2ZSBkYW5nbGluZyBwaXBlcyB3aGVuIHRoZXJlIGFyZSBlcnJvcnMuCiAgZnVuY3Rpb24gb25lcnJvcihlcikgewogICAgY2xlYW51cCgpOwogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQodGhpcywgJ2Vycm9yJykgPT09IDApIHsKICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCBzdHJlYW0gZXJyb3IgaW4gcGlwZS4KICAgIH0KICB9CgogIHNvdXJjZS5vbignZXJyb3InLCBvbmVycm9yKTsKICBkZXN0Lm9uKCdlcnJvcicsIG9uZXJyb3IpOwoKICAvLyByZW1vdmUgYWxsIHRoZSBldmVudCBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGFkZGVkLgogIGZ1bmN0aW9uIGNsZWFudXAoKSB7CiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZHJhaW4nLCBvbmRyYWluKTsKCiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKCiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwoKICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignZW5kJywgY2xlYW51cCk7CiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgY2xlYW51cCk7CgogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBjbGVhbnVwKTsKICB9CgogIHNvdXJjZS5vbignZW5kJywgY2xlYW51cCk7CiAgc291cmNlLm9uKCdjbG9zZScsIGNsZWFudXApOwoKICBkZXN0Lm9uKCdjbG9zZScsIGNsZWFudXApOwoKICBkZXN0LmVtaXQoJ3BpcGUnLCBzb3VyY2UpOwoKICAvLyBBbGxvdyBmb3IgdW5peC1saWtlIHVzYWdlOiBBLnBpcGUoQikucGlwZShDKQogIHJldHVybiBkZXN0Owp9OwoKfSx7ImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwicmVhZGFibGUtc3RyZWFtL2R1cGxleC5qcyI6NjEsInJlYWRhYmxlLXN0cmVhbS9wYXNzdGhyb3VnaC5qcyI6NjgsInJlYWRhYmxlLXN0cmVhbS9yZWFkYWJsZS5qcyI6NjksInJlYWRhYmxlLXN0cmVhbS90cmFuc2Zvcm0uanMiOjcwLCJyZWFkYWJsZS1zdHJlYW0vd3JpdGFibGUuanMiOjcxfV0sNzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwoKdmFyIGlzQnVmZmVyRW5jb2RpbmcgPSBCdWZmZXIuaXNFbmNvZGluZwogIHx8IGZ1bmN0aW9uKGVuY29kaW5nKSB7CiAgICAgICBzd2l0Y2ggKGVuY29kaW5nICYmIGVuY29kaW5nLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgY2FzZSAnaGV4JzogY2FzZSAndXRmOCc6IGNhc2UgJ3V0Zi04JzogY2FzZSAnYXNjaWknOiBjYXNlICdiaW5hcnknOiBjYXNlICdiYXNlNjQnOiBjYXNlICd1Y3MyJzogY2FzZSAndWNzLTInOiBjYXNlICd1dGYxNmxlJzogY2FzZSAndXRmLTE2bGUnOiBjYXNlICdyYXcnOiByZXR1cm4gdHJ1ZTsKICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgfQogICAgIH0KCgpmdW5jdGlvbiBhc3NlcnRFbmNvZGluZyhlbmNvZGluZykgewogIGlmIChlbmNvZGluZyAmJiAhaXNCdWZmZXJFbmNvZGluZyhlbmNvZGluZykpIHsKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKTsKICB9Cn0KCi8vIFN0cmluZ0RlY29kZXIgcHJvdmlkZXMgYW4gaW50ZXJmYWNlIGZvciBlZmZpY2llbnRseSBzcGxpdHRpbmcgYSBzZXJpZXMgb2YKLy8gYnVmZmVycyBpbnRvIGEgc2VyaWVzIG9mIEpTIHN0cmluZ3Mgd2l0aG91dCBicmVha2luZyBhcGFydCBtdWx0aS1ieXRlCi8vIGNoYXJhY3RlcnMuIENFU1UtOCBpcyBoYW5kbGVkIGFzIHBhcnQgb2YgdGhlIFVURi04IGVuY29kaW5nLgovLwovLyBAVE9ETyBIYW5kbGluZyBhbGwgZW5jb2RpbmdzIGluc2lkZSBhIHNpbmdsZSBvYmplY3QgbWFrZXMgaXQgdmVyeSBkaWZmaWN1bHQKLy8gdG8gcmVhc29uIGFib3V0IHRoaXMgY29kZSwgc28gaXQgc2hvdWxkIGJlIHNwbGl0IHVwIGluIHRoZSBmdXR1cmUuCi8vIEBUT0RPIFRoZXJlIHNob3VsZCBiZSBhIHV0Zjgtc3RyaWN0IGVuY29kaW5nIHRoYXQgcmVqZWN0cyBpbnZhbGlkIFVURi04IGNvZGUKLy8gcG9pbnRzIGFzIHVzZWQgYnkgQ0VTVS04Lgp2YXIgU3RyaW5nRGVjb2RlciA9IGV4cG9ydHMuU3RyaW5nRGVjb2RlciA9IGZ1bmN0aW9uKGVuY29kaW5nKSB7CiAgdGhpcy5lbmNvZGluZyA9IChlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvWy1fXS8sICcnKTsKICBhc3NlcnRFbmNvZGluZyhlbmNvZGluZyk7CiAgc3dpdGNoICh0aGlzLmVuY29kaW5nKSB7CiAgICBjYXNlICd1dGY4JzoKICAgICAgLy8gQ0VTVS04IHJlcHJlc2VudHMgZWFjaCBvZiBTdXJyb2dhdGUgUGFpciBieSAzLWJ5dGVzCiAgICAgIHRoaXMuc3Vycm9nYXRlU2l6ZSA9IDM7CiAgICAgIGJyZWFrOwogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgLy8gVVRGLTE2IHJlcHJlc2VudHMgZWFjaCBvZiBTdXJyb2dhdGUgUGFpciBieSAyLWJ5dGVzCiAgICAgIHRoaXMuc3Vycm9nYXRlU2l6ZSA9IDI7CiAgICAgIHRoaXMuZGV0ZWN0SW5jb21wbGV0ZUNoYXIgPSB1dGYxNkRldGVjdEluY29tcGxldGVDaGFyOwogICAgICBicmVhazsKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIC8vIEJhc2UtNjQgc3RvcmVzIDMgYnl0ZXMgaW4gNCBjaGFycywgYW5kIHBhZHMgdGhlIHJlbWFpbmRlci4KICAgICAgdGhpcy5zdXJyb2dhdGVTaXplID0gMzsKICAgICAgdGhpcy5kZXRlY3RJbmNvbXBsZXRlQ2hhciA9IGJhc2U2NERldGVjdEluY29tcGxldGVDaGFyOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRoaXMud3JpdGUgPSBwYXNzVGhyb3VnaFdyaXRlOwogICAgICByZXR1cm47CiAgfQoKICAvLyBFbm91Z2ggc3BhY2UgdG8gc3RvcmUgYWxsIGJ5dGVzIG9mIGEgc2luZ2xlIGNoYXJhY3Rlci4gVVRGLTggbmVlZHMgNAogIC8vIGJ5dGVzLCBidXQgQ0VTVS04IG1heSByZXF1aXJlIHVwIHRvIDYgKDMgYnl0ZXMgcGVyIHN1cnJvZ2F0ZSkuCiAgdGhpcy5jaGFyQnVmZmVyID0gbmV3IEJ1ZmZlcig2KTsKICAvLyBOdW1iZXIgb2YgYnl0ZXMgcmVjZWl2ZWQgZm9yIHRoZSBjdXJyZW50IGluY29tcGxldGUgbXVsdGktYnl0ZSBjaGFyYWN0ZXIuCiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSAwOwogIC8vIE51bWJlciBvZiBieXRlcyBleHBlY3RlZCBmb3IgdGhlIGN1cnJlbnQgaW5jb21wbGV0ZSBtdWx0aS1ieXRlIGNoYXJhY3Rlci4KICB0aGlzLmNoYXJMZW5ndGggPSAwOwp9OwoKCi8vIHdyaXRlIGRlY29kZXMgdGhlIGdpdmVuIGJ1ZmZlciBhbmQgcmV0dXJucyBpdCBhcyBKUyBzdHJpbmcgdGhhdCBpcwovLyBndWFyYW50ZWVkIHRvIG5vdCBjb250YWluIGFueSBwYXJ0aWFsIG11bHRpLWJ5dGUgY2hhcmFjdGVycy4gQW55IHBhcnRpYWwKLy8gY2hhcmFjdGVyIGZvdW5kIGF0IHRoZSBlbmQgb2YgdGhlIGJ1ZmZlciBpcyBidWZmZXJlZCB1cCwgYW5kIHdpbGwgYmUKLy8gcmV0dXJuZWQgd2hlbiBjYWxsaW5nIHdyaXRlIGFnYWluIHdpdGggdGhlIHJlbWFpbmluZyBieXRlcy4KLy8KLy8gTm90ZTogQ29udmVydGluZyBhIEJ1ZmZlciBjb250YWluaW5nIGFuIG9ycGhhbiBzdXJyb2dhdGUgdG8gYSBTdHJpbmcKLy8gY3VycmVudGx5IHdvcmtzLCBidXQgY29udmVydGluZyBhIFN0cmluZyB0byBhIEJ1ZmZlciAodmlhIGBuZXcgQnVmZmVyYCwgb3IKLy8gQnVmZmVyI3dyaXRlKSB3aWxsIHJlcGxhY2UgaW5jb21wbGV0ZSBzdXJyb2dhdGVzIHdpdGggdGhlIHVuaWNvZGUKLy8gcmVwbGFjZW1lbnQgY2hhcmFjdGVyLiBTZWUgaHR0cHM6Ly9jb2RlcmV2aWV3LmNocm9taXVtLm9yZy8xMjExNzMwMDkvIC4KU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbihidWZmZXIpIHsKICB2YXIgY2hhclN0ciA9ICcnOwogIC8vIGlmIG91ciBsYXN0IHdyaXRlIGVuZGVkIHdpdGggYW4gaW5jb21wbGV0ZSBtdWx0aWJ5dGUgY2hhcmFjdGVyCiAgd2hpbGUgKHRoaXMuY2hhckxlbmd0aCkgewogICAgLy8gZGV0ZXJtaW5lIGhvdyBtYW55IHJlbWFpbmluZyBieXRlcyB0aGlzIGJ1ZmZlciBoYXMgdG8gb2ZmZXIgZm9yIHRoaXMgY2hhcgogICAgdmFyIGF2YWlsYWJsZSA9IChidWZmZXIubGVuZ3RoID49IHRoaXMuY2hhckxlbmd0aCAtIHRoaXMuY2hhclJlY2VpdmVkKSA/CiAgICAgICAgdGhpcy5jaGFyTGVuZ3RoIC0gdGhpcy5jaGFyUmVjZWl2ZWQgOgogICAgICAgIGJ1ZmZlci5sZW5ndGg7CgogICAgLy8gYWRkIHRoZSBuZXcgYnl0ZXMgdG8gdGhlIGNoYXIgYnVmZmVyCiAgICBidWZmZXIuY29weSh0aGlzLmNoYXJCdWZmZXIsIHRoaXMuY2hhclJlY2VpdmVkLCAwLCBhdmFpbGFibGUpOwogICAgdGhpcy5jaGFyUmVjZWl2ZWQgKz0gYXZhaWxhYmxlOwoKICAgIGlmICh0aGlzLmNoYXJSZWNlaXZlZCA8IHRoaXMuY2hhckxlbmd0aCkgewogICAgICAvLyBzdGlsbCBub3QgZW5vdWdoIGNoYXJzIGluIHRoaXMgYnVmZmVyPyB3YWl0IGZvciBtb3JlIC4uLgogICAgICByZXR1cm4gJyc7CiAgICB9CgogICAgLy8gcmVtb3ZlIGJ5dGVzIGJlbG9uZ2luZyB0byB0aGUgY3VycmVudCBjaGFyYWN0ZXIgZnJvbSB0aGUgYnVmZmVyCiAgICBidWZmZXIgPSBidWZmZXIuc2xpY2UoYXZhaWxhYmxlLCBidWZmZXIubGVuZ3RoKTsKCiAgICAvLyBnZXQgdGhlIGNoYXJhY3RlciB0aGF0IHdhcyBzcGxpdAogICAgY2hhclN0ciA9IHRoaXMuY2hhckJ1ZmZlci5zbGljZSgwLCB0aGlzLmNoYXJMZW5ndGgpLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcpOwoKICAgIC8vIENFU1UtODogbGVhZCBzdXJyb2dhdGUgKEQ4MDAtREJGRikgaXMgYWxzbyB0aGUgaW5jb21wbGV0ZSBjaGFyYWN0ZXIKICAgIHZhciBjaGFyQ29kZSA9IGNoYXJTdHIuY2hhckNvZGVBdChjaGFyU3RyLmxlbmd0aCAtIDEpOwogICAgaWYgKGNoYXJDb2RlID49IDB4RDgwMCAmJiBjaGFyQ29kZSA8PSAweERCRkYpIHsKICAgICAgdGhpcy5jaGFyTGVuZ3RoICs9IHRoaXMuc3Vycm9nYXRlU2l6ZTsKICAgICAgY2hhclN0ciA9ICcnOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIHRoaXMuY2hhclJlY2VpdmVkID0gdGhpcy5jaGFyTGVuZ3RoID0gMDsKCiAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbW9yZSBieXRlcyBpbiB0aGlzIGJ1ZmZlciwganVzdCBlbWl0IG91ciBjaGFyCiAgICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gY2hhclN0cjsKICAgIH0KICAgIGJyZWFrOwogIH0KCiAgLy8gZGV0ZXJtaW5lIGFuZCBzZXQgY2hhckxlbmd0aCAvIGNoYXJSZWNlaXZlZAogIHRoaXMuZGV0ZWN0SW5jb21wbGV0ZUNoYXIoYnVmZmVyKTsKCiAgdmFyIGVuZCA9IGJ1ZmZlci5sZW5ndGg7CiAgaWYgKHRoaXMuY2hhckxlbmd0aCkgewogICAgLy8gYnVmZmVyIHRoZSBpbmNvbXBsZXRlIGNoYXJhY3RlciBieXRlcyB3ZSBnb3QKICAgIGJ1ZmZlci5jb3B5KHRoaXMuY2hhckJ1ZmZlciwgMCwgYnVmZmVyLmxlbmd0aCAtIHRoaXMuY2hhclJlY2VpdmVkLCBlbmQpOwogICAgZW5kIC09IHRoaXMuY2hhclJlY2VpdmVkOwogIH0KCiAgY2hhclN0ciArPSBidWZmZXIudG9TdHJpbmcodGhpcy5lbmNvZGluZywgMCwgZW5kKTsKCiAgdmFyIGVuZCA9IGNoYXJTdHIubGVuZ3RoIC0gMTsKICB2YXIgY2hhckNvZGUgPSBjaGFyU3RyLmNoYXJDb2RlQXQoZW5kKTsKICAvLyBDRVNVLTg6IGxlYWQgc3Vycm9nYXRlIChEODAwLURCRkYpIGlzIGFsc28gdGhlIGluY29tcGxldGUgY2hhcmFjdGVyCiAgaWYgKGNoYXJDb2RlID49IDB4RDgwMCAmJiBjaGFyQ29kZSA8PSAweERCRkYpIHsKICAgIHZhciBzaXplID0gdGhpcy5zdXJyb2dhdGVTaXplOwogICAgdGhpcy5jaGFyTGVuZ3RoICs9IHNpemU7CiAgICB0aGlzLmNoYXJSZWNlaXZlZCArPSBzaXplOwogICAgdGhpcy5jaGFyQnVmZmVyLmNvcHkodGhpcy5jaGFyQnVmZmVyLCBzaXplLCAwLCBzaXplKTsKICAgIGJ1ZmZlci5jb3B5KHRoaXMuY2hhckJ1ZmZlciwgMCwgMCwgc2l6ZSk7CiAgICByZXR1cm4gY2hhclN0ci5zdWJzdHJpbmcoMCwgZW5kKTsKICB9CgogIC8vIG9yIGp1c3QgZW1pdCB0aGUgY2hhclN0cgogIHJldHVybiBjaGFyU3RyOwp9OwoKLy8gZGV0ZWN0SW5jb21wbGV0ZUNoYXIgZGV0ZXJtaW5lcyBpZiB0aGVyZSBpcyBhbiBpbmNvbXBsZXRlIFVURi04IGNoYXJhY3RlciBhdAovLyB0aGUgZW5kIG9mIHRoZSBnaXZlbiBidWZmZXIuIElmIHNvLCBpdCBzZXRzIHRoaXMuY2hhckxlbmd0aCB0byB0aGUgYnl0ZQovLyBsZW5ndGggdGhhdCBjaGFyYWN0ZXIsIGFuZCBzZXRzIHRoaXMuY2hhclJlY2VpdmVkIHRvIHRoZSBudW1iZXIgb2YgYnl0ZXMKLy8gdGhhdCBhcmUgYXZhaWxhYmxlIGZvciB0aGlzIGNoYXJhY3Rlci4KU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUuZGV0ZWN0SW5jb21wbGV0ZUNoYXIgPSBmdW5jdGlvbihidWZmZXIpIHsKICAvLyBkZXRlcm1pbmUgaG93IG1hbnkgYnl0ZXMgd2UgaGF2ZSB0byBjaGVjayBhdCB0aGUgZW5kIG9mIHRoaXMgYnVmZmVyCiAgdmFyIGkgPSAoYnVmZmVyLmxlbmd0aCA+PSAzKSA/IDMgOiBidWZmZXIubGVuZ3RoOwoKICAvLyBGaWd1cmUgb3V0IGlmIG9uZSBvZiB0aGUgbGFzdCBpIGJ5dGVzIG9mIG91ciBidWZmZXIgYW5ub3VuY2VzIGFuCiAgLy8gaW5jb21wbGV0ZSBjaGFyLgogIGZvciAoOyBpID4gMDsgaS0tKSB7CiAgICB2YXIgYyA9IGJ1ZmZlcltidWZmZXIubGVuZ3RoIC0gaV07CgogICAgLy8gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVVRGLTgjRGVzY3JpcHRpb24KCiAgICAvLyAxMTBYWFhYWAogICAgaWYgKGkgPT0gMSAmJiBjID4+IDUgPT0gMHgwNikgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSAyOwogICAgICBicmVhazsKICAgIH0KCiAgICAvLyAxMTEwWFhYWAogICAgaWYgKGkgPD0gMiAmJiBjID4+IDQgPT0gMHgwRSkgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSAzOwogICAgICBicmVhazsKICAgIH0KCiAgICAvLyAxMTExMFhYWAogICAgaWYgKGkgPD0gMyAmJiBjID4+IDMgPT0gMHgxRSkgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSA0OwogICAgICBicmVhazsKICAgIH0KICB9CiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSBpOwp9OwoKU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24oYnVmZmVyKSB7CiAgdmFyIHJlcyA9ICcnOwogIGlmIChidWZmZXIgJiYgYnVmZmVyLmxlbmd0aCkKICAgIHJlcyA9IHRoaXMud3JpdGUoYnVmZmVyKTsKCiAgaWYgKHRoaXMuY2hhclJlY2VpdmVkKSB7CiAgICB2YXIgY3IgPSB0aGlzLmNoYXJSZWNlaXZlZDsKICAgIHZhciBidWYgPSB0aGlzLmNoYXJCdWZmZXI7CiAgICB2YXIgZW5jID0gdGhpcy5lbmNvZGluZzsKICAgIHJlcyArPSBidWYuc2xpY2UoMCwgY3IpLnRvU3RyaW5nKGVuYyk7CiAgfQoKICByZXR1cm4gcmVzOwp9OwoKZnVuY3Rpb24gcGFzc1Rocm91Z2hXcml0ZShidWZmZXIpIHsKICByZXR1cm4gYnVmZmVyLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcpOwp9CgpmdW5jdGlvbiB1dGYxNkRldGVjdEluY29tcGxldGVDaGFyKGJ1ZmZlcikgewogIHRoaXMuY2hhclJlY2VpdmVkID0gYnVmZmVyLmxlbmd0aCAlIDI7CiAgdGhpcy5jaGFyTGVuZ3RoID0gdGhpcy5jaGFyUmVjZWl2ZWQgPyAyIDogMDsKfQoKZnVuY3Rpb24gYmFzZTY0RGV0ZWN0SW5jb21wbGV0ZUNoYXIoYnVmZmVyKSB7CiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSBidWZmZXIubGVuZ3RoICUgMzsKICB0aGlzLmNoYXJMZW5ndGggPSB0aGlzLmNoYXJSZWNlaXZlZCA/IDMgOiAwOwp9Cgp9LHsiYnVmZmVyIjo1M31dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gICAgIGNyZWF0ZS1lcnJvci5qcyAwLjMuMQovLyAgICAgKGMpIDIwMTMgVGltIEdyaWVzc2VyCi8vICAgICBUaGlzIHNvdXJjZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKGZ1bmN0aW9uKGZhY3RvcnkpIHsKCiJ1c2Ugc3RyaWN0IjsKCi8vIEEgc2ltcGxlIHV0aWxpdHkgZm9yIHN1YmNsYXNzaW5nIHRoZSAiRXJyb3IiCi8vIG9iamVjdCBpbiBtdWx0aXBsZSBlbnZpcm9ubWVudHMsIHdoaWxlIG1haW50YWluaW5nCi8vIHJlbGV2YW50IHN0YWNrIHRyYWNlcywgbWVzc2FnZXMsIGFuZCBwcm90b3R5cGVzLgpmYWN0b3J5KGZ1bmN0aW9uKCkgewoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCi8vIENyZWF0ZXMgYW4gbmV3IGVycm9yIHR5cGUgd2l0aCBhICJuYW1lIiwKLy8gYW5kIGFueSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgYmUgc2V0Ci8vIG9uIHRoZSBlcnJvciBpbnN0YW5jZS4KcmV0dXJuIGZ1bmN0aW9uKCkgewogIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkgewogICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICB9CiAgdmFyIG5hbWUgICAgICAgPSBnZXROYW1lKGFyZ3MpOwogIHZhciB0YXJnZXQgICAgID0gZ2V0VGFyZ2V0KGFyZ3MpOwogIHZhciBwcm9wZXJ0aWVzID0gZ2V0UHJvcHMoYXJncyk7CiAgZnVuY3Rpb24gRXJyb3JDdG9yKG1lc3NhZ2UsIG9iaikgewogICAgYXR0YWNoUHJvcHModGhpcywgcHJvcGVydGllcyk7CiAgICBhdHRhY2hQcm9wcyh0aGlzLCBvYmopOwogICAgdGhpcy5tZXNzYWdlID0gKG1lc3NhZ2UgfHwgdGhpcy5tZXNzYWdlKTsKICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlOwogICAgICB0aGlzLnN0YWNrID0gbWVzc2FnZS5zdGFjazsKICAgIH0gZWxzZSBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVycigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IEVycm9yQ3RvcjsgfQogIEVyci5wcm90b3R5cGUgPSB0YXJnZXRbJ3Byb3RvdHlwZSddOwogIEVycm9yQ3Rvci5wcm90b3R5cGUgPSBuZXcgRXJyKCk7CiAgRXJyb3JDdG9yLnByb3RvdHlwZS5uYW1lID0gKCcnICsgbmFtZSkgfHwgJ0N1c3RvbUVycm9yJzsKICByZXR1cm4gRXJyb3JDdG9yOwp9OwoKLy8gSnVzdCBhIGZldyBoZWxwZXJzIHRvIGNsZWFuIHVwIHRoZSBmdW5jdGlvbiBhYm92ZQovLyBodHRwczovL2dpdGh1Yi5jb20vcGV0a2FhbnRvbm92L2JsdWViaXJkL3dpa2kvT3B0aW1pemF0aW9uLWtpbGxlcnMKZnVuY3Rpb24gZ2V0TmFtZShhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyAoYXJnc1sxXSB8fCAnJykgOiBhcmdzWzBdOwp9CmZ1bmN0aW9uIGdldFRhcmdldChhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gRXJyb3I7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyBhcmdzWzBdIDogRXJyb3I7Cn0KZnVuY3Rpb24gZ2V0UHJvcHMoYXJncykgewogIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyBhcmdzWzJdIDogYXJnc1sxXTsKfQpmdW5jdGlvbiBpbmhlcml0ZWRLZXlzKG9iaikgewogIHZhciByZXQgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICByZXQucHVzaChrZXkpOwogIH0KICByZXR1cm4gcmV0Owp9CgovLyBSaWdodCBub3cgd2UncmUganVzdCBhc3N1bWluZyB0aGF0IGEgZnVuY3Rpb24gaW4gdGhlIGZpcnN0IGFyZ3VtZW50IGlzIGFuIGVycm9yLgpmdW5jdGlvbiBpc0Vycm9yKG9iaikgewogIHJldHVybiAodHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIik7Cn0KCi8vIFdlIGRvbid0IG5lZWQgdGhlIGZ1bGwgdW5kZXJzY29yZSBjaGVjayBoZXJlLCBzaW5jZSBpdCBzaG91bGQgZWl0aGVyIGJlCi8vIGFuIG9iamVjdC1saXRlcmFsLCBvciBub3RoaW5nIGF0IGFsbC4KZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgcmV0dXJuIChvYmogJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBPYmplY3RdIik7Cn0KCi8vIFVzZWQgdG8gYXR0YWNoIGF0dHJpYnV0ZXMgdG8gdGhlIGVycm9yIG9iamVjdCBpbiB0aGUgY29uc3RydWN0b3IuCmZ1bmN0aW9uIGF0dGFjaFByb3BzKGNvbnRleHQsIHRhcmdldCkgewogIGlmIChpc09iamVjdCh0YXJnZXQpKSB7CiAgICB2YXIga2V5cyA9IGluaGVyaXRlZEtleXModGFyZ2V0KTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgY29udGV4dFtrZXlzW2ldXSA9IGNsb25lKHRhcmdldFtrZXlzW2ldXSk7CiAgICB9CiAgfQp9CgovLyBEb24ndCBuZWVkIHRoZSBmdWxsLW91dCAiY2xvbmUiIG1lY2hhbmlzbSBoZXJlLCBzaW5jZSBpZiB5b3UncmUKLy8gdHJ5aW5nIHRvIHNldCB0aGluZ3Mgb3RoZXIgdGhhbiBlbXB0eSBhcnJheXMvb2JqZWN0cyBvbiB5b3VyCi8vIHN1Yi1jbGFzc2VkIGBFcnJvcmAgb2JqZWN0LCB5b3UncmUgcHJvYmFibHkgZG9pbmcgaXQgd3JvbmcuCmZ1bmN0aW9uIGNsb25lKHRhcmdldCkgewogIGlmICh0YXJnZXQgPT0gbnVsbCB8fCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IikgcmV0dXJuIHRhcmdldDsKICB2YXIgY2xvbmVkID0gdGFyZ2V0LmNvbnN0cnVjdG9yID8gdGFyZ2V0LmNvbnN0cnVjdG9yKCkgOiBPYmplY3QuY3JlYXRlKG51bGwpOwogIGZvciAodmFyIGF0dHIgaW4gdGFyZ2V0KSB7CiAgICBpZiAodGFyZ2V0Lmhhc093blByb3BlcnR5KGF0dHIpKSB7CiAgICAgIGNsb25lZFthdHRyXSA9IHRhcmdldFthdHRyXTsKICAgIH0KICB9CiAgcmV0dXJuIGNsb25lZDsKfQoKfSk7CgovLyBCb2lsZXJwbGF0ZSBVTUQgZGVmaW5pdGlvbiBibG9jay4uLgp9KShmdW5jdGlvbihjcmVhdGVFcnJvckxpYikgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZShjcmVhdGVFcnJvckxpYik7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gY3JlYXRlRXJyb3JMaWIoKTsKICB9IGVsc2UgewogICAgdmFyIHJvb3QgPSB0aGlzOwogICAgdmFyIGxhc3RjcmVhdGVFcnJvciA9IHJvb3QuY3JlYXRlRXJyb3I7CiAgICB2YXIgY3JlYXRlRXJyb3IgPSByb290LmNyZWF0ZUVycm9yID0gY3JlYXRlRXJyb3JMaWIoKTsKICAgIGNyZWF0ZUVycm9yLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgcm9vdC5jcmVhdGVFcnJvciA9IGxhc3RjcmVhdGVFcnJvcjsKICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yOwogICAgfTsKICB9Cn0pOwoKfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiEKICogaW5mbGVjdGlvbgogKiBDb3B5cmlnaHQoYykgMjAxMSBCZW4gTGluIDxiZW5AZHJlYW1lcnNsYWIuY29tPgogKiBNSVQgTGljZW5zZWQKICoKICogQGZpbGVvdmVydmlldwogKiBBIHBvcnQgb2YgaW5mbGVjdGlvbi1qcyB0byBub2RlLmpzIG1vZHVsZS4KICovCgooIGZ1bmN0aW9uICggcm9vdCwgZmFjdG9yeSApewogIGlmKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKXsKICAgIGRlZmluZShbXSwgZmFjdG9yeSApOwogIH1lbHNlIGlmKCB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgKXsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH1lbHNlewogICAgcm9vdC5pbmZsZWN0aW9uID0gZmFjdG9yeSgpOwogIH0KfSggdGhpcywgZnVuY3Rpb24gKCl7CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGlzIGlzIGEgbGlzdCBvZiBub3VucyB0aGF0IHVzZSB0aGUgc2FtZSBmb3JtIGZvciBib3RoIHNpbmd1bGFyIGFuZCBwbHVyYWwuCiAgICogICAgICAgICAgICAgIFRoaXMgbGlzdCBzaG91bGQgcmVtYWluIGVudGlyZWx5IGluIGxvd2VyIGNhc2UgdG8gY29ycmVjdGx5IG1hdGNoIFN0cmluZ3MuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgdW5jb3VudGFibGVfd29yZHMgPSBbCiAgICAnYWNjZXNzJywKICAgICdhY2NvbW1vZGF0aW9uJywKICAgICdhZHVsdGhvb2QnLAogICAgJ2FkdmVydGlzaW5nJywKICAgICdhZHZpY2UnLAogICAgJ2FnZ3Jlc3Npb24nLAogICAgJ2FpZCcsCiAgICAnYWlyJywKICAgICdhaXJjcmFmdCcsCiAgICAnYWxjb2hvbCcsCiAgICAnYW5nZXInLAogICAgJ2FwcGxhdXNlJywKICAgICdhcml0aG1ldGljJywKICAgICdhcnQnLAogICAgJ2Fzc2lzdGFuY2UnLAogICAgJ2F0aGxldGljcycsCiAgICAnYXR0ZW50aW9uJywKCiAgICAnYmFjb24nLAogICAgJ2JhZ2dhZ2UnLAogICAgJ2JhbGxldCcsCiAgICAnYmVhdXR5JywKICAgICdiZWVmJywKICAgICdiZWVyJywKICAgICdiZWhhdmlvcicsCiAgICAnYmlvbG9neScsCiAgICAvLyAnYmlsbGlhcmRzJywKICAgICdibG9vZCcsCiAgICAnYm90YW55JywKICAgIC8vICdib3dlbHMnLAogICAgJ2JyZWFkJywKICAgICdidXNpbmVzcycsCiAgICAnYnV0dGVyJywKCiAgICAnY2FyYm9uJywKICAgICdjYXJkYm9hcmQnLAogICAgJ2Nhc2gnLAogICAgJ2NoYWxrJywKICAgICdjaGFvcycsCiAgICAnY2hlc3MnLAogICAgJ2Nyb3Nzcm9hZHMnLAogICAgJ2NvdW50cnlzaWRlJywKCiAgICAnZGFtYWdlJywKICAgICdkYW5jaW5nJywKICAgICdkYW5nZXInLAogICAgJ2RlZXInLAogICAgJ2RlbGlnaHQnLAogICAgJ2Rlc3NlcnQnLAogICAgJ2RpZ25pdHknLAogICAgJ2RpcnQnLAogICAgJ2Rpc3RyaWJ1dGlvbicsCiAgICAnZHVzdCcsCgogICAgJ2Vjb25vbWljcycsCiAgICAnZWR1Y2F0aW9uJywKICAgICdlbGVjdHJpY2l0eScsCiAgICAnZW1wbG95bWVudCcsCiAgICAnZW5lcmd5JywKICAgICdlbmdpbmVlcmluZycsCiAgICAnZW5qb3ltZW50JywKICAgICdlbnRlcnRhaW5tZW50JywKICAgICdlbnZ5JywKICAgICdlcXVpcG1lbnQnLAogICAgJ2V0aGljcycsCiAgICAnZXZpZGVuY2UnLAogICAgJ2V2b2x1dGlvbicsCgogICAgJ2ZhaWx1cmUnLAogICAgJ2ZhaXRoJywKICAgICdmYW1lJywKICAgICdmaWN0aW9uJywKICAgIC8vICdmaXNoJywKICAgICdmbG91cicsCiAgICAnZmx1JywKICAgICdmb29kJywKICAgICdmcmVlZG9tJywKICAgICdmcnVpdCcsCiAgICAnZnVlbCcsCiAgICAnZnVuJywKICAgIC8vICdmdW5lcmFsJywKICAgICdmdXJuaXR1cmUnLAoKICAgICdnYWxsb3dzJywKICAgICdnYXJiYWdlJywKICAgICdnYXJsaWMnLAogICAgJ2dhcycsCiAgICAnZ2VuZXRpY3MnLAogICAgJ2dsYXNzJywKICAgICdnb2xkJywKICAgICdnb2xmJywKICAgICdnb3NzaXAnLAogICAgJ2dyYW1tYXInLAogICAgJ2dyYXNzJywKICAgICdncmF0aXR1ZGUnLAogICAgJ2dyaWVmJywKICAgICdncm91bmQnLAogICAgJ2d1aWx0JywKICAgICdneW1uYXN0aWNzJywKCiAgICAnaGFpcicsCiAgICAnaGFwcGluZXNzJywKICAgICdoYXJkd2FyZScsCiAgICAnaGFybScsCiAgICAnaGF0ZScsCiAgICAnaGF0cmVkJywKICAgICdoZWFsdGgnLAogICAgJ2hlYXQnLAogICAgJ2hlaWdodCcsCiAgICAnaGVscCcsCiAgICAnaG9tZXdvcmsnLAogICAgJ2hvbmVzdHknLAogICAgJ2hvbmV5JywKICAgICdob3NwaXRhbGl0eScsCiAgICAnaG91c2V3b3JrJywKICAgICdodW1vdXInLAogICAgJ2h1bmdlcicsCiAgICAnaHlkcm9nZW4nLAoKICAgICdpY2UnLAogICAgJ2ltcG9ydGFuY2UnLAogICAgJ2luZmxhdGlvbicsCiAgICAnaW5mb3JtYXRpb24nLAogICAgJ2luanVzdGljZScsCiAgICAnaW5ub2NlbmNlJywKICAgICdpbnRlbGxpZ2VuY2UnLAogICAgJ2lyb24nLAogICAgJ2lyb255JywKCiAgICAnamFtJywKICAgICdqZWFsb3VzeScsCiAgICAnamVsbHknLAogICAgJ2pld2VscnknLAogICAgJ2pveScsCiAgICAnanVkbycsCiAgICAnanVpY2UnLAogICAgJ2p1c3RpY2UnLAoKICAgICdrYXJhdGUnLAogICAgJ2tpbmRuZXNzJywKICAgICdrbm93bGVkZ2UnLAoKICAgICdsYWJvdXInLAogICAgJ2xhY2snLAogICAgJ2xhbmQnLAogICAgJ2xhdWdodGVyJywKICAgICdsYXZhJywKICAgICdsZWF0aGVyJywKICAgICdsZWlzdXJlJywKICAgICdsaWdodG5pbmcnLAogICAgJ2xpbmd1aW5lJywKICAgICdsaW5ndWluaScsCiAgICAnbGluZ3Vpc3RpY3MnLAogICAgJ2xpdGVyYXR1cmUnLAogICAgJ2xpdHRlcicsCiAgICAnbGl2ZXN0b2NrJywKICAgICdsb2dpYycsCiAgICAnbG9uZWxpbmVzcycsCiAgICAnbG92ZScsCiAgICAnbHVjaycsCiAgICAnbHVnZ2FnZScsCgogICAgJ21hY2Fyb25pJywKICAgICdtYWNoaW5lcnknLAogICAgJ21hZ2ljJywKICAgICdtYWlsJywKICAgICdtYW5hZ2VtZW50JywKICAgICdtYW5raW5kJywKICAgICdtYXJibGUnLAogICAgJ21hdGhlbWF0aWNzJywKICAgICdtYXlvbm5haXNlJywKICAgICdtZWFzbGVzJywKICAgICdtZWF0JywKICAgICdtZXRhbCcsCiAgICAnbWV0aGFuZScsCiAgICAnbWlsaycsCiAgICAnbW9uZXknLAogICAgLy8gJ21vb3NlJywKICAgICdtdWQnLAogICAgJ211c2ljJywKICAgICdtdW1wcycsCgogICAgJ25hdHVyZScsCiAgICAnbmV3cycsCiAgICAnbml0cm9nZW4nLAogICAgJ25vbnNlbnNlJywKICAgICdudXJ0dXJlJywKICAgICdudXRyaXRpb24nLAoKICAgICdvYmVkaWVuY2UnLAogICAgJ29iZXNpdHknLAogICAgJ29pbCcsCiAgICAnb3h5Z2VuJywKCiAgICAncGFwZXInLAogICAgJ3Bhc3Npb24nLAogICAgJ3Bhc3RhJywKICAgICdwYXRpZW5jZScsCiAgICAncGVybWlzc2lvbicsCiAgICAncGh5c2ljcycsCiAgICAncG9ldHJ5JywKICAgICdwb2xsdXRpb24nLAogICAgJ3BvdmVydHknLAogICAgJ3Bvd2VyJywKICAgICdwcmlkZScsCiAgICAncHJvZHVjdGlvbicsCiAgICAncHJvZ3Jlc3MnLAogICAgJ3Byb251bmNpYXRpb24nLAogICAgJ3BzeWNob2xvZ3knLAogICAgJ3B1YmxpY2l0eScsCiAgICAncHVuY3R1YXRpb24nLAoKICAgICdxdWFsaXR5JywKICAgICdxdWFudGl0eScsCiAgICAncXVhcnR6JywKCiAgICAncmFjaXNtJywKICAgICdyYWluJywKICAgICdyZWNyZWF0aW9uJywKICAgICdyZWxheGF0aW9uJywKICAgICdyZWxpYWJpbGl0eScsCiAgICAncmVzZWFyY2gnLAogICAgJ3Jlc3BlY3QnLAogICAgJ3JldmVuZ2UnLAogICAgJ3JpY2UnLAogICAgJ3J1YmJpc2gnLAogICAgJ3J1bScsCgogICAgJ3NhZmV0eScsCiAgICAnc2FsYWQnLAogICAgJ3NhbHQnLAogICAgJ3NhbmQnLAogICAgJ3NhdGlyZScsCiAgICAnc2NlbmVyeScsCiAgICAnc2VhZm9vZCcsCiAgICAnc2Vhc2lkZScsCiAgICAnc2VyaWVzJywKICAgICdzaGFtZScsCiAgICAnc2hlZXAnLAogICAgJ3Nob3BwaW5nJywKICAgICdzaWxlbmNlJywKICAgICdzbGVlcCcsCiAgICAvLyAnc2xhbmcnCiAgICAnc21va2UnLAogICAgJ3Ntb2tpbmcnLAogICAgJ3Nub3cnLAogICAgJ3NvYXAnLAogICAgJ3NvZnR3YXJlJywKICAgICdzb2lsJywKICAgICdzb3Jyb3cnLAogICAgJ3NvdXAnLAogICAgJ3NwYWdoZXR0aScsCiAgICAnc3BlZWQnLAogICAgJ3NwZWNpZXMnLAogICAgJ3NwZWxsaW5nJywKICAgICdzcG9ydCcsCiAgICAnc3RlYW0nLAogICAgJ3N0cmVuZ3RoJywKICAgICdzdHVmZicsCiAgICAnc3R1cGlkaXR5JywKICAgICdzdWNjZXNzJywKICAgICdzdWdhcicsCiAgICAnc3Vuc2hpbmUnLAogICAgJ3N5bW1ldHJ5JywKCiAgICAndGVhJywKICAgICd0ZW5uaXMnLAogICAgJ3RoaXJzdCcsCiAgICAndGh1bmRlcicsCiAgICAndGltYmVyJywKICAgICd0aW1lJywKICAgICd0b2FzdCcsCiAgICAndG9sZXJhbmNlJywKICAgICd0cmFkZScsCiAgICAndHJhZmZpYycsCiAgICAndHJhbnNwb3J0YXRpb24nLAogICAgJ3RyYXZlbCcsCiAgICAndHJ1c3QnLAoKICAgICd1bmRlcnN0YW5kaW5nJywKICAgICd1bmRlcndlYXInLAogICAgJ3VuZW1wbG95bWVudCcsCiAgICAndW5pdHknLAogICAgJ3VzYWdlJywKCiAgICAndmFsaWRpdHknLAogICAgJ3ZlYWwnLAogICAgJ3ZlZ2V0YXRpb24nLAogICAgJ3ZlZ2V0YXJpYW5pc20nLAogICAgJ3ZlbmdlYW5jZScsCiAgICAndmlvbGVuY2UnLAogICAgJ3Zpc2lvbicsCiAgICAndml0YWxpdHknLAoKICAgICd3YXJtdGgnLAogICAgJ3dhdGVyJywKICAgICd3ZWFsdGgnLAogICAgJ3dlYXRoZXInLAogICAgJ3dlaWdodCcsCiAgICAnd2VsZmFyZScsCiAgICAnd2hlYXQnLAogICAgJ3doaXNrZXknLAogICAgJ3dpZHRoJywKICAgICd3aWxkbGlmZScsCiAgICAnd2luZScsCiAgICAnd2lzZG9tJywKICAgICd3b29kJywKICAgICd3b29sJywKICAgICd3b3JrJywKCiAgICAneWVhc3QnLAogICAgJ3lvZ2EnLAoKICAgICd6aW5jJywKICAgICd6b29sb2d5JwogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBydWxlcyB0cmFuc2xhdGUgZnJvbSB0aGUgc2luZ3VsYXIgZm9ybSBvZiBhIG5vdW4gdG8gaXRzIHBsdXJhbCBmb3JtLgogICAqIEBwcml2YXRlCiAgICovCgogIHZhciByZWdleCA9IHsKICAgIHBsdXJhbCA6IHsKICAgICAgbWVuICAgICAgIDogbmV3IFJlZ0V4cCggJ14obSllbiQnICAgICwgJ2dpJyApLAogICAgICBwZW9wbGUgICAgOiBuZXcgUmVnRXhwKCAnKHBlKW9wbGUkJyAgLCAnZ2knICksCiAgICAgIGNoaWxkcmVuICA6IG5ldyBSZWdFeHAoICcoY2hpbGQpcmVuJCcsICdnaScgKSwKICAgICAgdGlhICAgICAgIDogbmV3IFJlZ0V4cCggJyhbdGldKWEkJyAgICwgJ2dpJyApLAogICAgICBhbmFseXNlcyAgOiBuZXcgUmVnRXhwKCAnKChhKW5hbHl8KGIpYXwoZClpYWdub3wocClhcmVudGhlfChwKXJvZ25vfChzKXlub3B8KHQpaGUpc2VzJCcsJ2dpJyApLAogICAgICBoaXZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKGhpfHRpKXZlcyQnICAgICAgICwgJ2dpJyApLAogICAgICBjdXJ2ZXMgICAgOiBuZXcgUmVnRXhwKCAnKGN1cnZlKXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBscnZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKFtscl0pdmVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICBmb3ZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKFteZm9dKXZlcyQnICAgICAgICwgJ2dpJyApLAogICAgICBtb3ZpZXMgICAgOiBuZXcgUmVnRXhwKCAnKG0pb3ZpZXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBhZWlvdXlpZXMgOiBuZXcgUmVnRXhwKCAnKFteYWVpb3V5XXxxdSlpZXMkJywgJ2dpJyApLAogICAgICBzZXJpZXMgICAgOiBuZXcgUmVnRXhwKCAnKHMpZXJpZXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICB4ZXMgICAgICAgOiBuZXcgUmVnRXhwKCAnKHh8Y2h8c3N8c2gpZXMkJyAgICwgJ2dpJyApLAogICAgICBtaWNlICAgICAgOiBuZXcgUmVnRXhwKCAnKFttfGxdKWljZSQnICAgICAgICwgJ2dpJyApLAogICAgICBidXNlcyAgICAgOiBuZXcgUmVnRXhwKCAnKGJ1cyllcyQnICAgICAgICAgICwgJ2dpJyApLAogICAgICBvZXMgICAgICAgOiBuZXcgUmVnRXhwKCAnKG8pZXMkJyAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzaG9lcyAgICAgOiBuZXcgUmVnRXhwKCAnKHNob2UpcyQnICAgICAgICAgICwgJ2dpJyApLAogICAgICBjcmlzZXMgICAgOiBuZXcgUmVnRXhwKCAnKGNyaXN8YXh8dGVzdCllcyQnICwgJ2dpJyApLAogICAgICBvY3RvcGkgICAgOiBuZXcgUmVnRXhwKCAnKG9jdG9wfHZpcilpJCcgICAgICwgJ2dpJyApLAogICAgICBhbGlhc2VzICAgOiBuZXcgUmVnRXhwKCAnKGFsaWFzfHN0YXR1cyllcyQnICwgJ2dpJyApLAogICAgICBzdW1tb25zZXMgOiBuZXcgUmVnRXhwKCAnXihzdW1tb25zKWVzJCcgICAgICwgJ2dpJyApLAogICAgICBveGVuICAgICAgOiBuZXcgUmVnRXhwKCAnXihveCllbicgICAgICAgICAgICwgJ2dpJyApLAogICAgICBtYXRyaWNlcyAgOiBuZXcgUmVnRXhwKCAnKG1hdHIpaWNlcyQnICAgICAgICwgJ2dpJyApLAogICAgICB2ZXJ0aWNlcyAgOiBuZXcgUmVnRXhwKCAnKHZlcnR8aW5kKWljZXMkJyAgICwgJ2dpJyApLAogICAgICBmZWV0ICAgICAgOiBuZXcgUmVnRXhwKCAnXmZlZXQkJyAgICAgICAgICAgICwgJ2dpJyApLAogICAgICB0ZWV0aCAgICAgOiBuZXcgUmVnRXhwKCAnXnRlZXRoJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBnZWVzZSAgICAgOiBuZXcgUmVnRXhwKCAnXmdlZXNlJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBxdWl6emVzICAgOiBuZXcgUmVnRXhwKCAnKHF1aXopemVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICB3aGVyZWFzZXMgOiBuZXcgUmVnRXhwKCAnXih3aGVyZWFzKWVzJCcgICAgICwgJ2dpJyApLAogICAgICBzcyAgICAgICAgOiBuZXcgUmVnRXhwKCAnc3MkJyAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzICAgICAgICAgOiBuZXcgUmVnRXhwKCAncyQnICAgICAgICAgICAgICAgICwgJ2dpJyApCiAgICB9LAoKICAgIHNpbmd1bGFyIDogewogICAgICBtYW4gICAgIDogbmV3IFJlZ0V4cCggJ14obSlhbiQnICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIHBlcnNvbiAgOiBuZXcgUmVnRXhwKCAnKHBlKXJzb24kJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgY2hpbGQgICA6IG5ldyBSZWdFeHAoICcoY2hpbGQpJCcgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBveCAgICAgIDogbmV3IFJlZ0V4cCggJ14ob3gpJCcgICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIGF4aXMgICAgOiBuZXcgUmVnRXhwKCAnKGF4fHRlc3QpaXMkJyAgICAgICAgICAsICdnaScgKSwKICAgICAgb2N0b3B1cyA6IG5ldyBSZWdFeHAoICcob2N0b3B8dmlyKXVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICBhbGlhcyAgIDogbmV3IFJlZ0V4cCggJyhhbGlhc3xzdGF0dXMpJCcgICAgICAgLCAnZ2knICksCiAgICAgIHN1bW1vbnMgOiBuZXcgUmVnRXhwKCAnXihzdW1tb25zKSQnICAgICAgICAgICAsICdnaScgKSwKICAgICAgYnVzICAgICA6IG5ldyBSZWdFeHAoICcoYnUpcyQnICAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBidWZmYWxvIDogbmV3IFJlZ0V4cCggJyhidWZmYWx8dG9tYXR8cG90YXQpbyQnLCAnZ2knICksCiAgICAgIHRpdW0gICAgOiBuZXcgUmVnRXhwKCAnKFt0aV0pdW0kJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgc2lzICAgICA6IG5ldyBSZWdFeHAoICdzaXMkJyAgICAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBmZmUgICAgIDogbmV3IFJlZ0V4cCggJyg/OihbXmZdKWZlfChbbHJdKWYpJCcgLCAnZ2knICksCiAgICAgIGhpdmUgICAgOiBuZXcgUmVnRXhwKCAnKGhpfHRpKXZlJCcgICAgICAgICAgICAsICdnaScgKSwKICAgICAgYWVpb3V5eSA6IG5ldyBSZWdFeHAoICcoW15hZWlvdXldfHF1KXkkJyAgICAgICwgJ2dpJyApLAogICAgICB4ICAgICAgIDogbmV3IFJlZ0V4cCggJyh4fGNofHNzfHNoKSQnICAgICAgICAgLCAnZ2knICksCiAgICAgIG1hdHJpeCAgOiBuZXcgUmVnRXhwKCAnKG1hdHIpaXgkJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgdmVydGV4ICA6IG5ldyBSZWdFeHAoICcodmVydHxpbmQpZXgkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBtb3VzZSAgIDogbmV3IFJlZ0V4cCggJyhbbXxsXSlvdXNlJCcgICAgICAgICAgLCAnZ2knICksCiAgICAgIGZvb3QgICAgOiBuZXcgUmVnRXhwKCAnXmZvb3QkJyAgICAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgdG9vdGggICA6IG5ldyBSZWdFeHAoICdedG9vdGgkJyAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBnb29zZSAgIDogbmV3IFJlZ0V4cCggJ15nb29zZSQnICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIHF1aXogICAgOiBuZXcgUmVnRXhwKCAnKHF1aXopJCcgICAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgd2hlcmVhcyA6IG5ldyBSZWdFeHAoICdeKHdoZXJlYXMpJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzICAgICAgIDogbmV3IFJlZ0V4cCggJ3MkJyAgICAgICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIGNvbW1vbiAgOiBuZXcgUmVnRXhwKCAnJCcgICAgICAgICAgICAgICAgICAgICAsICdnaScgKQogICAgfQogIH07CgogIHZhciBwbHVyYWxfcnVsZXMgPSBbCgogICAgLy8gZG8gbm90IHJlcGxhY2UgaWYgaXRzIGFscmVhZHkgYSBwbHVyYWwgd29yZAogICAgWyByZWdleC5wbHVyYWwubWVuICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5wZW9wbGUgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmNoaWxkcmVuICBdLAogICAgWyByZWdleC5wbHVyYWwudGlhICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hbmFseXNlcyAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmhpdmVzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwuY3VydmVzICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5scnZlcyAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZvdmVzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwuYWVpb3V5aWVzIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zZXJpZXMgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLm1vdmllcyAgICBdLAogICAgWyByZWdleC5wbHVyYWwueGVzICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5taWNlICAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmJ1c2VzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwub2VzICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zaG9lcyAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmNyaXNlcyAgICBdLAogICAgWyByZWdleC5wbHVyYWwub2N0b3BpICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hbGlhc2VzICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLnN1bW1vbnNlcyBdLAogICAgWyByZWdleC5wbHVyYWwub3hlbiAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5tYXRyaWNlcyAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZlZXQgICAgICBdLAogICAgWyByZWdleC5wbHVyYWwudGVldGggICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5nZWVzZSAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLnF1aXp6ZXMgICBdLAogICAgWyByZWdleC5wbHVyYWwud2hlcmVhc2VzIF0sCgogICAgLy8gb3JpZ2luYWwgcnVsZQogICAgWyByZWdleC5zaW5ndWxhci5tYW4gICAgLCAnJDFlbicgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIucGVyc29uICwgJyQxb3BsZScgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY2hpbGQgICwgJyQxcmVuJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5veCAgICAgLCAnJDFlbicgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYXhpcyAgICwgJyQxZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm9jdG9wdXMsICckMWknIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmFsaWFzICAsICckMWVzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5zdW1tb25zLCAnJDFlcycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYnVzICAgICwgJyQxc2VzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5idWZmYWxvLCAnJDFvZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRpdW0gICAsICckMWEnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnNpcyAgICAsICdzZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmZmZSAgICAsICckMSQydmVzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5oaXZlICAgLCAnJDF2ZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmFlaW91eXksICckMWllcycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIueCAgICAgICwgJyQxZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1hdHJpeCAsICckMWljZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnZlcnRleCAsICckMWljZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1vdXNlICAsICckMWljZScgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZm9vdCAgICwgJ2ZlZXQnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRvb3RoICAsICd0ZWV0aCcgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZ29vc2UgICwgJ2dlZXNlJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5xdWl6ICAgLCAnJDF6ZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLndoZXJlYXMsICckMWVzJyBdLAoKICAgIFsgcmVnZXguc2luZ3VsYXIucyAgICAgLCAncycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY29tbW9uLCAncycgXQogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBydWxlcyB0cmFuc2xhdGUgZnJvbSB0aGUgcGx1cmFsIGZvcm0gb2YgYSBub3VuIHRvIGl0cyBzaW5ndWxhciBmb3JtLgogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIHNpbmd1bGFyX3J1bGVzID0gWwoKICAgIC8vIGRvIG5vdCByZXBsYWNlIGlmIGl0cyBhbHJlYWR5IGEgc2luZ3VsYXIgd29yZAogICAgWyByZWdleC5zaW5ndWxhci5tYW4gICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnBlcnNvbiAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY2hpbGQgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5veCAgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmF4aXMgICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIub2N0b3B1cyBdLAogICAgWyByZWdleC5zaW5ndWxhci5hbGlhcyAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnN1bW1vbnMgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYnVzICAgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5idWZmYWxvIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRpdW0gICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuc2lzICAgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5mZmUgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmhpdmUgICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYWVpb3V5eSBdLAogICAgWyByZWdleC5zaW5ndWxhci54ICAgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1hdHJpeCAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIubW91c2UgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5mb290ICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRvb3RoICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZ29vc2UgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5xdWl6ICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLndoZXJlYXMgXSwKCiAgICAvLyBvcmlnaW5hbCBydWxlCiAgICBbIHJlZ2V4LnBsdXJhbC5tZW4gICAgICAsICckMWFuJyBdLAogICAgWyByZWdleC5wbHVyYWwucGVvcGxlICAgLCAnJDFyc29uJyBdLAogICAgWyByZWdleC5wbHVyYWwuY2hpbGRyZW4gLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC50aWEgICAgICAsICckMXVtJyBdLAogICAgWyByZWdleC5wbHVyYWwuYW5hbHlzZXMgLCAnJDEkMnNpcycgXSwKICAgIFsgcmVnZXgucGx1cmFsLmhpdmVzICAgICwgJyQxdmUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5jdXJ2ZXMgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLmxydmVzICAgICwgJyQxZicgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZvdmVzICAgICwgJyQxZmUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5tb3ZpZXMgICAsICckMW92aWUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hZWlvdXlpZXMsICckMXknIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zZXJpZXMgICAsICckMWVyaWVzJyBdLAogICAgWyByZWdleC5wbHVyYWwueGVzICAgICAgLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5taWNlICAgICAsICckMW91c2UnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5idXNlcyAgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLm9lcyAgICAgICwgJyQxJyBdLAogICAgWyByZWdleC5wbHVyYWwuc2hvZXMgICAgLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5jcmlzZXMgICAsICckMWlzJyBdLAogICAgWyByZWdleC5wbHVyYWwub2N0b3BpICAgLCAnJDF1cycgXSwKICAgIFsgcmVnZXgucGx1cmFsLmFsaWFzZXMgICwgJyQxJyBdLAogICAgWyByZWdleC5wbHVyYWwuc3VtbW9uc2VzLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5veGVuICAgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLm1hdHJpY2VzICwgJyQxaXgnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC52ZXJ0aWNlcyAsICckMWV4JyBdLAogICAgWyByZWdleC5wbHVyYWwuZmVldCAgICAgLCAnZm9vdCcgXSwKICAgIFsgcmVnZXgucGx1cmFsLnRlZXRoICAgICwgJ3Rvb3RoJyBdLAogICAgWyByZWdleC5wbHVyYWwuZ2Vlc2UgICAgLCAnZ29vc2UnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5xdWl6emVzICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLndoZXJlYXNlcywgJyQxJyBdLAoKICAgIFsgcmVnZXgucGx1cmFsLnNzLCAnc3MnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zICwgJycgXQogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGlzIGlzIGEgbGlzdCBvZiB3b3JkcyB0aGF0IHNob3VsZCBub3QgYmUgY2FwaXRhbGl6ZWQgZm9yIHRpdGxlIGNhc2UuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgbm9uX3RpdGxlY2FzZWRfd29yZHMgPSBbCiAgICAnYW5kJywgJ29yJywgJ25vcicsICdhJywgJ2FuJywgJ3RoZScsICdzbycsICdidXQnLCAndG8nLCAnb2YnLCAnYXQnLCdieScsCiAgICAnZnJvbScsICdpbnRvJywgJ29uJywgJ29udG8nLCAnb2ZmJywgJ291dCcsICdpbicsICdvdmVyJywgJ3dpdGgnLCAnZm9yJwogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBhcmUgcmVndWxhciBleHByZXNzaW9ucyB1c2VkIGZvciBjb252ZXJ0aW5nIGJldHdlZW4gU3RyaW5nIGZvcm1hdHMuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgaWRfc3VmZml4ICAgICAgICAgPSBuZXcgUmVnRXhwKCAnKF9pZHN8X2lkKSQnLCAnZycgKTsKICB2YXIgdW5kZXJiYXIgICAgICAgICAgPSBuZXcgUmVnRXhwKCAnXycsICdnJyApOwogIHZhciBzcGFjZV9vcl91bmRlcmJhciA9IG5ldyBSZWdFeHAoICdbXCBfXScsICdnJyApOwogIHZhciB1cHBlcmNhc2UgICAgICAgICA9IG5ldyBSZWdFeHAoICcoW0EtWl0pJywgJ2cnICk7CiAgdmFyIHVuZGVyYmFyX3ByZWZpeCAgID0gbmV3IFJlZ0V4cCggJ15fJyApOwoKICB2YXIgaW5mbGVjdG9yID0gewoKICAvKioKICAgKiBBIGhlbHBlciBtZXRob2QgdGhhdCBhcHBsaWVzIHJ1bGVzIGJhc2VkIHJlcGxhY2VtZW50IHRvIGEgU3RyaW5nLgogICAqIEBwcml2YXRlCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBTdHJpbmcgdG8gbW9kaWZ5IGFuZCByZXR1cm4gYmFzZWQgb24gdGhlIHBhc3NlZCBydWxlcy4KICAgKiBAcGFyYW0ge0FycmF5OiBbUmVnRXhwLCBTdHJpbmddfSBydWxlcyBSZWdleHAgdG8gbWF0Y2ggcGFpcmVkIHdpdGggU3RyaW5nIHRvIHVzZSBmb3IgcmVwbGFjZW1lbnQKICAgKiBAcGFyYW0ge0FycmF5OiBbU3RyaW5nXX0gc2tpcCBTdHJpbmdzIHRvIHNraXAgaWYgdGhleSBtYXRjaAogICAqIEBwYXJhbSB7U3RyaW5nfSBvdmVycmlkZSBTdHJpbmcgdG8gcmV0dXJuIGFzIHRob3VnaCB0aGlzIG1ldGhvZCBzdWNjZWVkZWQgKHVzZWQgdG8gY29uZm9ybSB0byBBUElzKQogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBwYXNzZWQgU3RyaW5nIG1vZGlmaWVkIGJ5IHBhc3NlZCBydWxlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHRoaXMuX2FwcGx5X3J1bGVzKCAnY293cycsIHNpbmd1bGFyX3J1bGVzICk7IC8vID09PSAnY293JwogICAqLwogICAgX2FwcGx5X3J1bGVzIDogZnVuY3Rpb24gKCBzdHIsIHJ1bGVzLCBza2lwLCBvdmVycmlkZSApewogICAgICBpZiggb3ZlcnJpZGUgKXsKICAgICAgICBzdHIgPSBvdmVycmlkZTsKICAgICAgfWVsc2V7CiAgICAgICAgdmFyIGlnbm9yZSA9ICggaW5mbGVjdG9yLmluZGV4T2YoIHNraXAsIHN0ci50b0xvd2VyQ2FzZSgpKSA+IC0xICk7CgogICAgICAgIGlmKCAhaWdub3JlICl7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICB2YXIgaiA9IHJ1bGVzLmxlbmd0aDsKCiAgICAgICAgICBmb3IoIDsgaSA8IGo7IGkrKyApewogICAgICAgICAgICBpZiggc3RyLm1hdGNoKCBydWxlc1sgaSBdWyAwIF0pKXsKICAgICAgICAgICAgICBpZiggcnVsZXNbIGkgXVsgMSBdICE9PSB1bmRlZmluZWQgKXsKICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCBydWxlc1sgaSBdWyAwIF0sIHJ1bGVzWyBpIF1bIDEgXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGxldHMgdXMgZGV0ZWN0IGlmIGFuIEFycmF5IGNvbnRhaW5zIGEgZ2l2ZW4gZWxlbWVudC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtBcnJheX0gYXJyIFRoZSBzdWJqZWN0IGFycmF5LgogICAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIE9iamVjdCB0byBsb2NhdGUgaW4gdGhlIEFycmF5LgogICAqIEBwYXJhbSB7TnVtYmVyfSBmcm9tX2luZGV4IFN0YXJ0cyBjaGVja2luZyBmcm9tIHRoaXMgcG9zaXRpb24gaW4gdGhlIEFycmF5LihvcHRpb25hbCkKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wYXJlX2Z1bmMgRnVuY3Rpb24gdXNlZCB0byBjb21wYXJlIEFycmF5IGl0ZW0gdnMgcGFzc2VkIGl0ZW0uKG9wdGlvbmFsKQogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybiBpbmRleCBwb3NpdGlvbiBpbiB0aGUgQXJyYXkgb2YgdGhlIHBhc3NlZCBpdGVtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLmluZGV4T2YoWyAnaGknLCd0aGVyZScgXSwgJ2d1eXMnICk7IC8vID09PSAtMQogICAqICAgICBpbmZsZWN0aW9uLmluZGV4T2YoWyAnaGknLCd0aGVyZScgXSwgJ2hpJyApOyAvLyA9PT0gMAogICAqLwogICAgaW5kZXhPZiA6IGZ1bmN0aW9uICggYXJyLCBpdGVtLCBmcm9tX2luZGV4LCBjb21wYXJlX2Z1bmMgKXsKICAgICAgaWYoICFmcm9tX2luZGV4ICl7CiAgICAgICAgZnJvbV9pbmRleCA9IC0xOwogICAgICB9CgogICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgdmFyIGkgICAgID0gZnJvbV9pbmRleDsKICAgICAgdmFyIGogICAgID0gYXJyLmxlbmd0aDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgaWYoIGFyclsgaSBdICA9PT0gaXRlbSB8fCBjb21wYXJlX2Z1bmMgJiYgY29tcGFyZV9mdW5jKCBhcnJbIGkgXSwgaXRlbSApKXsKICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGluZGV4OwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgcGx1cmFsaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7U3RyaW5nfSBwbHVyYWwgT3ZlcnJpZGVzIG5vcm1hbCBvdXRwdXQgd2l0aCBzYWlkIFN0cmluZy4ob3B0aW9uYWwpCiAgICogQHJldHVybnMge1N0cmluZ30gU2luZ3VsYXIgRW5nbGlzaCBsYW5ndWFnZSBub3VucyBhcmUgcmV0dXJuZWQgaW4gcGx1cmFsIGZvcm0uCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24ucGx1cmFsaXplKCAncGVyc29uJyApOyAvLyA9PT0gJ3Blb3BsZScKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdvY3RvcHVzJyApOyAvLyA9PT0gJ29jdG9waScKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdIYXQnICk7IC8vID09PSAnSGF0cycKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdwZXJzb24nLCAnZ3V5cycgKTsgLy8gPT09ICdndXlzJwogICAqLwogICAgcGx1cmFsaXplIDogZnVuY3Rpb24gKCBzdHIsIHBsdXJhbCApewogICAgICByZXR1cm4gaW5mbGVjdG9yLl9hcHBseV9ydWxlcyggc3RyLCBwbHVyYWxfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBwbHVyYWwgKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIHNpbmd1bGFyaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7U3RyaW5nfSBzaW5ndWxhciBPdmVycmlkZXMgbm9ybWFsIG91dHB1dCB3aXRoIHNhaWQgU3RyaW5nLihvcHRpb25hbCkKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBQbHVyYWwgRW5nbGlzaCBsYW5ndWFnZSBub3VucyBhcmUgcmV0dXJuZWQgaW4gc2luZ3VsYXIgZm9ybS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5zaW5ndWxhcml6ZSggJ3Blb3BsZScgKTsgLy8gPT09ICdwZXJzb24nCiAgICogICAgIGluZmxlY3Rpb24uc2luZ3VsYXJpemUoICdvY3RvcGknICk7IC8vID09PSAnb2N0b3B1cycKICAgKiAgICAgaW5mbGVjdGlvbi5zaW5ndWxhcml6ZSggJ0hhdHMnICk7IC8vID09PSAnSGF0JwogICAqICAgICBpbmZsZWN0aW9uLnNpbmd1bGFyaXplKCAnZ3V5cycsICdwZXJzb24nICk7IC8vID09PSAncGVyc29uJwogICAqLwogICAgc2luZ3VsYXJpemUgOiBmdW5jdGlvbiAoIHN0ciwgc2luZ3VsYXIgKXsKICAgICAgcmV0dXJuIGluZmxlY3Rvci5fYXBwbHlfcnVsZXMoIHN0ciwgc2luZ3VsYXJfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBzaW5ndWxhciApOwogICAgfSwKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gd2lsbCBwbHVyYWxpemUgb3Igc2luZ3VsYXJsaXplIGEgU3RyaW5nIGFwcHJvcHJpYXRlbHkgYmFzZWQgb24gYW4gaW50ZWdlciB2YWx1ZQogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIG51bWJlciB0byBiYXNlIHBsdXJhbGl6YXRpb24gb2ZmIG9mLgogICAqIEBwYXJhbSB7U3RyaW5nfSBzaW5ndWxhciBPdmVycmlkZXMgbm9ybWFsIG91dHB1dCB3aXRoIHNhaWQgU3RyaW5nLihvcHRpb25hbCkKICAgKiBAcGFyYW0ge1N0cmluZ30gcGx1cmFsIE92ZXJyaWRlcyBub3JtYWwgb3V0cHV0IHdpdGggc2FpZCBTdHJpbmcuKG9wdGlvbmFsKQogICAqIEByZXR1cm5zIHtTdHJpbmd9IEVuZ2xpc2ggbGFuZ3VhZ2Ugbm91bnMgYXJlIHJldHVybmVkIGluIHRoZSBwbHVyYWwgb3Igc2luZ3VsYXIgZm9ybSBiYXNlZCBvbiB0aGUgY291bnQuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uaW5mbGVjdCggJ3Blb3BsZScgMSApOyAvLyA9PT0gJ3BlcnNvbicKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnb2N0b3BpJyAxICk7IC8vID09PSAnb2N0b3B1cycKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnSGF0cycgMSApOyAvLyA9PT0gJ0hhdCcKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnZ3V5cycsIDEgLCAncGVyc29uJyApOyAvLyA9PT0gJ3BlcnNvbicKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAncGVyc29uJywgMiApOyAvLyA9PT0gJ3Blb3BsZScKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnb2N0b3B1cycsIDIgKTsgLy8gPT09ICdvY3RvcGknCiAgICogICAgIGluZmxlY3Rpb24uaW5mbGVjdCggJ0hhdCcsIDIgKTsgLy8gPT09ICdIYXRzJwogICAqICAgICBpbmZsZWN0aW9uLmluZmxlY3QoICdwZXJzb24nLCAyLCBudWxsLCAnZ3V5cycgKTsgLy8gPT09ICdndXlzJwogICAqLwogICAgaW5mbGVjdCA6IGZ1bmN0aW9uICggc3RyLCBjb3VudCwgc2luZ3VsYXIsIHBsdXJhbCApewogICAgICBjb3VudCA9IHBhcnNlSW50KCBjb3VudCwgMTAgKTsKCiAgICAgIGlmKCBpc05hTiggY291bnQgKSkgcmV0dXJuIHN0cjsKCiAgICAgIGlmKCBjb3VudCA9PT0gMCB8fCBjb3VudCA+IDEgKXsKICAgICAgICByZXR1cm4gaW5mbGVjdG9yLl9hcHBseV9ydWxlcyggc3RyLCBwbHVyYWxfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBwbHVyYWwgKTsKICAgICAgfWVsc2V7CiAgICAgICAgcmV0dXJuIGluZmxlY3Rvci5fYXBwbHlfcnVsZXMoIHN0ciwgc2luZ3VsYXJfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBzaW5ndWxhciApOwogICAgICB9CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyBjYW1lbGl6YXRpb24gc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGxvd19maXJzdF9sZXR0ZXIgRGVmYXVsdCBpcyB0byBjYXBpdGFsaXplIHRoZSBmaXJzdCBsZXR0ZXIgb2YgdGhlIHJlc3VsdHMuKG9wdGlvbmFsKQogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFzc2luZyB0cnVlIHdpbGwgbG93ZXJjYXNlIGl0LgogICAqIEByZXR1cm5zIHtTdHJpbmd9IExvd2VyIGNhc2UgdW5kZXJzY29yZWQgd29yZHMgd2lsbCBiZSByZXR1cm5lZCBpbiBjYW1lbCBjYXNlLgogICAqICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbGx5ICcvJyBpcyB0cmFuc2xhdGVkIHRvICc6OicKICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5jYW1lbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlUHJvcGVydGllcycKICAgKiAgICAgaW5mbGVjdGlvbi5jYW1lbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycsIHRydWUgKTsgLy8gPT09ICdtZXNzYWdlUHJvcGVydGllcycKICAgKi8KICAgIGNhbWVsaXplIDogZnVuY3Rpb24gKCBzdHIsIGxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgdmFyIHN0cl9wYXRoID0gc3RyLnNwbGl0KCAnLycgKTsKICAgICAgdmFyIGkgICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgID0gc3RyX3BhdGgubGVuZ3RoOwogICAgICB2YXIgc3RyX2FyciwgaW5pdF94LCBrLCBsLCBmaXJzdDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgc3RyX2FyciA9IHN0cl9wYXRoWyBpIF0uc3BsaXQoICdfJyApOwogICAgICAgIGsgICAgICAgPSAwOwogICAgICAgIGwgICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKCiAgICAgICAgZm9yKCA7IGsgPCBsOyBrKysgKXsKICAgICAgICAgIGlmKCBrICE9PSAwICl7CiAgICAgICAgICAgIHN0cl9hcnJbIGsgXSA9IHN0cl9hcnJbIGsgXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgfQoKICAgICAgICAgIGZpcnN0ID0gc3RyX2FyclsgayBdLmNoYXJBdCggMCApOwogICAgICAgICAgZmlyc3QgPSBsb3dfZmlyc3RfbGV0dGVyICYmIGkgPT09IDAgJiYgayA9PT0gMAogICAgICAgICAgICA/IGZpcnN0LnRvTG93ZXJDYXNlKCkgOiBmaXJzdC50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgc3RyX2FyclsgayBdID0gZmlyc3QgKyBzdHJfYXJyWyBrIF0uc3Vic3RyaW5nKCAxICk7CiAgICAgICAgfQoKICAgICAgICBzdHJfcGF0aFsgaSBdID0gc3RyX2Fyci5qb2luKCAnJyApOwogICAgICB9CgogICAgICByZXR1cm4gc3RyX3BhdGguam9pbiggJzo6JyApOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgdW5kZXJzY29yZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gYWxsX3VwcGVyX2Nhc2UgRGVmYXVsdCBpcyB0byBsb3dlcmNhc2UgYW5kIGFkZCB1bmRlcnNjb3JlIHByZWZpeC4ob3B0aW9uYWwpCiAgICogICAgICAgICAgICAgICAgICBQYXNzaW5nIHRydWUgd2lsbCByZXR1cm4gYXMgZW50ZXJlZC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBDYW1lbCBjYXNlZCB3b3JkcyBhcmUgcmV0dXJuZWQgYXMgbG93ZXIgY2FzZWQgYW5kIHVuZGVyc2NvcmVkLgogICAqICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbGx5ICc6OicgaXMgdHJhbnNsYXRlZCB0byAnLycuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24udW5kZXJzY29yZSggJ01lc3NhZ2VQcm9wZXJ0aWVzJyApOyAvLyA9PT0gJ21lc3NhZ2VfcHJvcGVydGllcycKICAgKiAgICAgaW5mbGVjdGlvbi51bmRlcnNjb3JlKCAnbWVzc2FnZVByb3BlcnRpZXMnICk7IC8vID09PSAnbWVzc2FnZV9wcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLnVuZGVyc2NvcmUoICdNUCcsIHRydWUgKTsgLy8gPT09ICdNUCcKICAgKi8KICAgIHVuZGVyc2NvcmUgOiBmdW5jdGlvbiAoIHN0ciwgYWxsX3VwcGVyX2Nhc2UgKXsKICAgICAgaWYoIGFsbF91cHBlcl9jYXNlICYmIHN0ciA9PT0gc3RyLnRvVXBwZXJDYXNlKCkpIHJldHVybiBzdHI7CgogICAgICB2YXIgc3RyX3BhdGggPSBzdHIuc3BsaXQoICc6OicgKTsKICAgICAgdmFyIGkgICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgID0gc3RyX3BhdGgubGVuZ3RoOwoKICAgICAgZm9yKCA7IGkgPCBqOyBpKysgKXsKICAgICAgICBzdHJfcGF0aFsgaSBdID0gc3RyX3BhdGhbIGkgXS5yZXBsYWNlKCB1cHBlcmNhc2UsICdfJDEnICk7CiAgICAgICAgc3RyX3BhdGhbIGkgXSA9IHN0cl9wYXRoWyBpIF0ucmVwbGFjZSggdW5kZXJiYXJfcHJlZml4LCAnJyApOwogICAgICB9CgogICAgICByZXR1cm4gc3RyX3BhdGguam9pbiggJy8nICkudG9Mb3dlckNhc2UoKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIGh1bWFuaXplIHN1cHBvcnQgdG8gZXZlcnkgU3RyaW5nIG9iamVjdC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHBhcmFtIHtCb29sZWFufSBsb3dfZmlyc3RfbGV0dGVyIERlZmF1bHQgaXMgdG8gY2FwaXRhbGl6ZSB0aGUgZmlyc3QgbGV0dGVyIG9mIHRoZSByZXN1bHRzLihvcHRpb25hbCkKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhc3NpbmcgdHJ1ZSB3aWxsIGxvd2VyY2FzZSBpdC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBMb3dlciBjYXNlIHVuZGVyc2NvcmVkIHdvcmRzIHdpbGwgYmUgcmV0dXJuZWQgaW4gaHVtYW5pemVkIGZvcm0uCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uaHVtYW5pemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnTWVzc2FnZSBwcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLmh1bWFuaXplKCAnbWVzc2FnZV9wcm9wZXJ0aWVzJywgdHJ1ZSApOyAvLyA9PT0gJ21lc3NhZ2UgcHJvcGVydGllcycKICAgKi8KICAgIGh1bWFuaXplIDogZnVuY3Rpb24gKCBzdHIsIGxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCBpZF9zdWZmaXgsICcnICk7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCB1bmRlcmJhciwgJyAnICk7CgogICAgICBpZiggIWxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgICBzdHIgPSBpbmZsZWN0b3IuY2FwaXRhbGl6ZSggc3RyICk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHI7CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyBjYXBpdGFsaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IEFsbCBjaGFyYWN0ZXJzIHdpbGwgYmUgbG93ZXIgY2FzZSBhbmQgdGhlIGZpcnN0IHdpbGwgYmUgdXBwZXIuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uY2FwaXRhbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlX3Byb3BlcnRpZXMnCiAgICogICAgIGluZmxlY3Rpb24uY2FwaXRhbGl6ZSggJ21lc3NhZ2UgcHJvcGVydGllcycsIHRydWUgKTsgLy8gPT09ICdNZXNzYWdlIHByb3BlcnRpZXMnCiAgICovCiAgICBjYXBpdGFsaXplIDogZnVuY3Rpb24gKCBzdHIgKXsKICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CgogICAgICByZXR1cm4gc3RyLnN1YnN0cmluZyggMCwgMSApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc3Vic3RyaW5nKCAxICk7CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gcmVwbGFjZXMgdW5kZXJzY29yZXMgd2l0aCBkYXNoZXMgaW4gdGhlIHN0cmluZy4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHJldHVybnMge1N0cmluZ30gUmVwbGFjZXMgYWxsIHNwYWNlcyBvciB1bmRlcnNjb3JlcyB3aXRoIGRhc2hlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5kYXNoZXJpemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnbWVzc2FnZS1wcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLmRhc2hlcml6ZSggJ01lc3NhZ2UgUHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlLVByb3BlcnRpZXMnCiAgICovCiAgICBkYXNoZXJpemUgOiBmdW5jdGlvbiAoIHN0ciApewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoIHNwYWNlX29yX3VuZGVyYmFyLCAnLScgKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIHRpdGxlaXplIHN1cHBvcnQgdG8gZXZlcnkgU3RyaW5nIG9iamVjdC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHJldHVybnMge1N0cmluZ30gQ2FwaXRhbGl6ZXMgd29yZHMgYXMgeW91IHdvdWxkIGZvciBhIGJvb2sgdGl0bGUuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24udGl0bGVpemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnTWVzc2FnZSBQcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLnRpdGxlaXplKCAnbWVzc2FnZSBwcm9wZXJ0aWVzIHRvIGtlZXAnICk7IC8vID09PSAnTWVzc2FnZSBQcm9wZXJ0aWVzIHRvIEtlZXAnCiAgICovCiAgICB0aXRsZWl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciAgICAgICAgID0gc3RyLnRvTG93ZXJDYXNlKCkucmVwbGFjZSggdW5kZXJiYXIsICcgJyApOwogICAgICB2YXIgc3RyX2FyciA9IHN0ci5zcGxpdCggJyAnICk7CiAgICAgIHZhciBpICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKICAgICAgdmFyIGQsIGssIGw7CgogICAgICBmb3IoIDsgaSA8IGo7IGkrKyApewogICAgICAgIGQgPSBzdHJfYXJyWyBpIF0uc3BsaXQoICctJyApOwogICAgICAgIGsgPSAwOwogICAgICAgIGwgPSBkLmxlbmd0aDsKCiAgICAgICAgZm9yKCA7IGsgPCBsOyBrKyspewogICAgICAgICAgaWYoIGluZmxlY3Rvci5pbmRleE9mKCBub25fdGl0bGVjYXNlZF93b3JkcywgZFsgayBdLnRvTG93ZXJDYXNlKCkpIDwgMCApewogICAgICAgICAgICBkWyBrIF0gPSBpbmZsZWN0b3IuY2FwaXRhbGl6ZSggZFsgayBdKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0cl9hcnJbIGkgXSA9IGQuam9pbiggJy0nICk7CiAgICAgIH0KCiAgICAgIHN0ciA9IHN0cl9hcnIuam9pbiggJyAnICk7CiAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoIDAsIDEgKS50b1VwcGVyQ2FzZSgpICsgc3RyLnN1YnN0cmluZyggMSApOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIGRlbW9kdWxpemUgc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZW1vdmVzIG1vZHVsZSBuYW1lcyBsZWF2aW5nIG9ubHkgY2xhc3MgbmFtZXMuKFJ1Ynkgc3R5bGUpCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uZGVtb2R1bGl6ZSggJ01lc3NhZ2U6OkJ1czo6UHJvcGVydGllcycgKTsgLy8gPT09ICdQcm9wZXJ0aWVzJwogICAqLwogICAgZGVtb2R1bGl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHZhciBzdHJfYXJyID0gc3RyLnNwbGl0KCAnOjonICk7CgogICAgICByZXR1cm4gc3RyX2Fyclsgc3RyX2Fyci5sZW5ndGggLSAxIF07CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyB0YWJsZWl6ZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBjYW1lbCBjYXNlZCB3b3JkcyBpbnRvIHRoZWlyIHVuZGVyc2NvcmVkIHBsdXJhbCBmb3JtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLnRhYmxlaXplKCAnTWVzc2FnZUJ1c1Byb3BlcnR5JyApOyAvLyA9PT0gJ21lc3NhZ2VfYnVzX3Byb3BlcnRpZXMnCiAgICovCiAgICB0YWJsZWl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci51bmRlcnNjb3JlKCBzdHIgKTsKICAgICAgc3RyID0gaW5mbGVjdG9yLnBsdXJhbGl6ZSggc3RyICk7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgY2xhc3NpZmljYXRpb24gc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBVbmRlcnNjb3JlZCBwbHVyYWwgbm91bnMgYmVjb21lIHRoZSBjYW1lbCBjYXNlZCBzaW5ndWxhciBmb3JtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLmNsYXNzaWZ5KCAnbWVzc2FnZV9idXNfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlQnVzUHJvcGVydHknCiAgICovCiAgICBjbGFzc2lmeSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5jYW1lbGl6ZSggc3RyICk7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5zaW5ndWxhcml6ZSggc3RyICk7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgZm9yZWlnbiBrZXkgc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRyb3BfaWRfdWJhciBEZWZhdWx0IGlzIHRvIHNlcGVyYXRlIGlkIHdpdGggYW4gdW5kZXJiYXIgYXQgdGhlIGVuZCBvZiB0aGUgY2xhc3MgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91IGNhbiBwYXNzIHRydWUgdG8gc2tpcCBpdC4ob3B0aW9uYWwpCiAgICogQHJldHVybnMge1N0cmluZ30gVW5kZXJzY29yZWQgcGx1cmFsIG5vdW5zIGJlY29tZSB0aGUgY2FtZWwgY2FzZWQgc2luZ3VsYXIgZm9ybS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5mb3JlaWduX2tleSggJ01lc3NhZ2VCdXNQcm9wZXJ0eScgKTsgLy8gPT09ICdtZXNzYWdlX2J1c19wcm9wZXJ0eV9pZCcKICAgKiAgICAgaW5mbGVjdGlvbi5mb3JlaWduX2tleSggJ01lc3NhZ2VCdXNQcm9wZXJ0eScsIHRydWUgKTsgLy8gPT09ICdtZXNzYWdlX2J1c19wcm9wZXJ0eWlkJwogICAqLwogICAgZm9yZWlnbl9rZXkgOiBmdW5jdGlvbiAoIHN0ciwgZHJvcF9pZF91YmFyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5kZW1vZHVsaXplKCBzdHIgKTsKICAgICAgc3RyID0gaW5mbGVjdG9yLnVuZGVyc2NvcmUoIHN0ciApICsgKCggZHJvcF9pZF91YmFyICkgPyAoICcnICkgOiAoICdfJyApKSArICdpZCc7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgb3JkaW5hbGl6ZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBhbGwgZm91bmQgbnVtYmVycyB0aGVpciBzZXF1ZW5jZSBsaWtlICcyMm5kJy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5vcmRpbmFsaXplKCAndGhlIDEgcGl0Y2gnICk7IC8vID09PSAndGhlIDFzdCBwaXRjaCcKICAgKi8KICAgIG9yZGluYWxpemUgOiBmdW5jdGlvbiAoIHN0ciApewogICAgICB2YXIgc3RyX2FyciA9IHN0ci5zcGxpdCggJyAnICk7CiAgICAgIHZhciBpICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgdmFyIGsgPSBwYXJzZUludCggc3RyX2FyclsgaSBdLCAxMCApOwoKICAgICAgICBpZiggIWlzTmFOKCBrICkpewogICAgICAgICAgdmFyIGx0ZCA9IHN0cl9hcnJbIGkgXS5zdWJzdHJpbmcoIHN0cl9hcnJbIGkgXS5sZW5ndGggLSAyICk7CiAgICAgICAgICB2YXIgbGQgID0gc3RyX2FyclsgaSBdLnN1YnN0cmluZyggc3RyX2FyclsgaSBdLmxlbmd0aCAtIDEgKTsKICAgICAgICAgIHZhciBzdWYgPSAndGgnOwoKICAgICAgICAgIGlmKCBsdGQgIT0gJzExJyAmJiBsdGQgIT0gJzEyJyAmJiBsdGQgIT0gJzEzJyApewogICAgICAgICAgICBpZiggbGQgPT09ICcxJyApewogICAgICAgICAgICAgIHN1ZiA9ICdzdCc7CiAgICAgICAgICAgIH1lbHNlIGlmKCBsZCA9PT0gJzInICl7CiAgICAgICAgICAgICAgc3VmID0gJ25kJzsKICAgICAgICAgICAgfWVsc2UgaWYoIGxkID09PSAnMycgKXsKICAgICAgICAgICAgICBzdWYgPSAncmQnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgc3RyX2FyclsgaSBdICs9IHN1ZjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHJfYXJyLmpvaW4oICcgJyApOwogICAgfSwKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBwZXJmb3JtcyBtdWx0aXBsZSBpbmZsZWN0aW9uIG1ldGhvZHMgb24gYSBzdHJpbmcKICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHBhcmFtIHtBcnJheX0gYXJyIEFuIGFycmF5IG9mIGluZmxlY3Rpb24gbWV0aG9kcy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLnRyYW5zZm9ybSggJ2FsbCBqb2InLCBbICdwbHVyYWxpemUnLCAnY2FwaXRhbGl6ZScsICdkYXNoZXJpemUnIF0pOyAvLyA9PT0gJ0FsbC1qb2JzJwogICAqLwogICAgdHJhbnNmb3JtIDogZnVuY3Rpb24gKCBzdHIsIGFyciApewogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBqID0gYXJyLmxlbmd0aDsKCiAgICAgIGZvciggO2kgPCBqOyBpKysgKXsKICAgICAgICB2YXIgbWV0aG9kID0gYXJyWyBpIF07CgogICAgICAgIGlmKCB0aGlzLmhhc093blByb3BlcnR5KCBtZXRob2QgKSl7CiAgICAgICAgICBzdHIgPSB0aGlzWyBtZXRob2QgXSggc3RyICk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc3RyOwogICAgfQogIH07CgovKioKICogQHB1YmxpYwogKi8KICBpbmZsZWN0b3IudmVyc2lvbiA9ICcxLjUuMSc7CgogIHJldHVybiBpbmZsZWN0b3I7Cn0pKTsKCn0se31dLDc2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgLy8gaW1wbGVtZW50YXRpb24gZnJvbSBzdGFuZGFyZCBub2RlLmpzICd1dGlsJyBtb2R1bGUKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0KICAgIH0pOwogIH07Cn0gZWxzZSB7CiAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIHZhciBUZW1wQ3RvciA9IGZ1bmN0aW9uICgpIHt9CiAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpCiAgICBjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3IKICB9Cn0KCn0se31dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gS25leC5qcyAgMC43LjMKLy8gLS0tLS0tLS0tLS0tLS0KCid1c2Ugc3RyaWN0JzsKCi8vICAgICAoYykgMjAxNCBUaW0gR3JpZXNzZXIKLy8gICAgIEtuZXggbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9rbmV4anMub3JnCgovLyBUaGUgIktuZXgiIG9iamVjdCB3ZSdyZSBleHBvcnRpbmcgaXMganVzdCBhIHBhc3N0aHJvdWdoIHRvIGBLbmV4LmluaXRpYWxpemVgLgpmdW5jdGlvbiBLbmV4KCkgewogIHJldHVybiBLbmV4LmluaXRpYWxpemUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQoKLy8gUmVxdWlyZSB0aGUgbWFpbiBjb25zdHJ1Y3RvcnMgbmVjZXNzYXJ5IGZvciBhIGBLbmV4YCBpbnN0YW5jZSwKLy8gZWFjaCBvZiB3aGljaCBhcmUgaW5qZWN0ZWQgd2l0aCB0aGUgY3VycmVudCBpbnN0YW5jZSwgc28gdGhleSBtYWludGFpbgovLyB0aGUgY29ycmVjdCBjbGllbnQgcmVmZXJlbmNlICYgZ3JhbW1hci4KdmFyIFJhdyA9IHJlcXVpcmUoJy4vbGliL3JhdycpOwoKLy8gUnVuIGEgInJhdyIgcXVlcnksIHRob3VnaCB3ZSBjYW4ndCBkbyBhbnl0aGluZyB3aXRoIGl0IG90aGVyIHRoYW4gcHV0Ci8vIGl0IGluIGEgcXVlcnkgc3RhdGVtZW50LgpLbmV4LnJhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICByZXR1cm4gbmV3IFJhdyhzcWwsIGJpbmRpbmdzKTsKfTsKCi8vIERvaW5nIGl0IHRoaXMgd2F5IG1ha2VzIGl0IGVhc2llciB0byBidWlsZCBmb3IgYnJvd3NlcmlmeS4KdmFyIG15c3FsID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9teXNxbCcpOyB9Owp2YXIgbXlzcWwyID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9teXNxbDInKTsgfTsKdmFyIG1hcmlhID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9tYXJpYScpOyB9Owp2YXIgb3JhY2xlID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9vcmFjbGUnKTsgfTsKdmFyIHBnID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9wb3N0Z3JlcycpOyB9Owp2YXIgc3FsaXRlMyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gcmVxdWlyZSgnLi9saWIvZGlhbGVjdHMvc3FsaXRlMycpOyB9Owp2YXIgd2Vic3FsID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy93ZWJzcWwnKTsgfTsKCi8vIFRoZSBjbGllbnQgbmFtZXMgd2UnbGwgYWxsb3cgaW4gdGhlIGB7bmFtZTogbGlifWAgcGFpcmluZy4KdmFyIENsaWVudHMgPSBLbmV4LkNsaWVudHMgPSB7CiAgJ215c3FsJyAgICAgIDogbXlzcWwsCiAgJ215c3FsMicgICAgIDogbXlzcWwyLAogICdtYXJpYScgICAgICA6IG1hcmlhLAogICdtYXJpYWRiJyAgICA6IG1hcmlhLAogICdtYXJpYXNxbCcgICA6IG1hcmlhLAogICdvcmFjbGUnICAgICA6IG9yYWNsZSwKICAncGcnICAgICAgICAgOiBwZywKICAncG9zdGdyZXMnICAgOiBwZywKICAncG9zdGdyZXNxbCcgOiBwZywKICAnc3FsaXRlJyAgICAgOiBzcWxpdGUzLAogICdzcWxpdGUzJyAgICA6IHNxbGl0ZTMsCiAgJ3dlYnNxbCcgICAgIDogd2Vic3FsCn07CgovLyBFYWNoIG9mIHRoZSBtZXRob2RzIHdoaWNoIG1heSBiZSBzdGF0aWNhbGx5IGNoYWluZWQgZnJvbSBrbmV4Lgp2YXIgUXVlcnlJbnRlcmZhY2UgICA9IHJlcXVpcmUoJy4vbGliL3F1ZXJ5L21ldGhvZHMnKTsKCi8vIENyZWF0ZSBhIG5ldyAia25leCIgaW5zdGFuY2Ugd2l0aCB0aGUgYXBwcm9wcmlhdGUgY29uZmlndXJlZCBjbGllbnQuCktuZXguaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGNvbmZpZykgewogIHZhciBEaWFsZWN0LCBjbGllbnQ7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCiAgLy8gVGhlIG9iamVjdCB3ZSdyZSBwb3RlbnRpYWxseSB1c2luZyB0byBraWNrIG9mZiBhbgogIC8vIGluaXRpYWwgY2hhaW4uIEl0IGlzIGFzc3VtZWQgdGhhdCBga25leGAgaXNuJ3QgYQogIC8vIGNvbnN0cnVjdG9yLCBzbyB3ZSBoYXZlIG5vIHJlZmVyZW5jZSB0byAndGhpcycganVzdAogIC8vIGluIGNhc2UgaXQncyBjYWxsZWQgd2l0aCBgbmV3YC4KICBmdW5jdGlvbiBrbmV4KHRhYmxlTmFtZSkgewogICAgdmFyIHFiID0gbmV3IGNsaWVudC5RdWVyeUJ1aWxkZXIoKTsKICAgIGlmIChjb25maWcuX190cmFuc2FjdG9yX18pIHFiLnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICByZXR1cm4gdGFibGVOYW1lID8gcWIudGFibGUodGFibGVOYW1lKSA6IHFiOwogIH0KCiAgLy8gSG9vayB1cCB0aGUgImtuZXgiIG9iamVjdCBhcyBhbiBFdmVudEVtaXR0ZXIuCiAgdmFyIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpOwogIGZvciAodmFyIGtleSBpbiBlZSkgewogICAga25leFtrZXldID0gZWVba2V5XTsKICB9CgogIC8vIFRoZSBgX19rbmV4X19gIGlzIHVzZWQgaWYgeW91IG5lZWQgdG8gZHVjay10eXBlIGNoZWNrIHdoZXRoZXIgdGhpcwogIC8vIGlzIGEga25leCBidWlsZGVyLCB3aXRob3V0IGEgZnVsbCBvbiBgaW5zdGFuY2VvZmAgY2hlY2suCiAga25leC5WRVJTSU9OID0ga25leC5fX2tuZXhfXyAgPSAnMC43LjMnOwogIGtuZXgucmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogICAgdmFyIHJhdyA9IG5ldyBjbGllbnQuUmF3KHNxbCwgYmluZGluZ3MpOwogICAgaWYgKGNvbmZpZy5fX3RyYW5zYWN0b3JfXykgcmF3LnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICByZXR1cm4gcmF3OwogIH07CgogIC8vIFJ1bnMgYSBuZXcgdHJhbnNhY3Rpb24sIHRha2luZyBhIGNvbnRhaW5lciBhbmQgcmV0dXJuaW5nIGEgcHJvbWlzZQogIC8vIGZvciB3aGVuIHRoZSB0cmFuc2FjdGlvbiBpcyByZXNvbHZlZC4KICBrbmV4LnRyYW5zYWN0aW9uID0gZnVuY3Rpb24oY29udGFpbmVyKSB7CiAgICByZXR1cm4gbmV3IGNsaWVudC5UcmFuc2FjdGlvbihjb250YWluZXIpOwogIH07CgogIC8vIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgdGVhcmluZyBkb3duIHRoZSBwb29sLgogIGtuZXguZGVzdHJveSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgcmV0dXJuIHRoaXMuY2xpZW50LmRlc3Ryb3koY2FsbGJhY2spOwogIH07CgogIGlmIChjb25maWcuX19jbGllbnRfXykgewogICAgY2xpZW50ID0gY29uZmlnLl9fY2xpZW50X187CiAgfSBlbHNlIHsKCiAgICAvLyBCdWlsZCB0aGUgImNsaWVudCIKICAgIHZhciBjbGllbnROYW1lID0gY29uZmlnLmNsaWVudCB8fCBjb25maWcuZGlhbGVjdDsKICAgIGlmICghQ2xpZW50c1tjbGllbnROYW1lXSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoY2xpZW50TmFtZSArICcgaXMgbm90IGEgdmFsaWQgS25leCBjbGllbnQsIGRpZCB5b3UgbWlzc3BlbGwgaXQ/Jyk7CiAgICB9CiAgICBrbmV4LnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAnW29iamVjdCBLbmV4OicgKyBjbGllbnROYW1lICsgJ10nOwogICAgfTsKICAgIERpYWxlY3QgPSBDbGllbnRzW2NsaWVudE5hbWVdKCk7CiAgICBjbGllbnQgID0gbmV3IERpYWxlY3QoY29uZmlnKTsKCiAgICAvLyBQYXNzdGhyb3VnaCBhbGwgInN0YXJ0IiBhbmQgInF1ZXJ5IiBldmVudHMgdG8gdGhlIGtuZXggb2JqZWN0LgogICAgY2xpZW50Lm9uKCdzdGFydCcsIGZ1bmN0aW9uKG9iaikgewogICAgICBrbmV4LmVtaXQoJ3N0YXJ0Jywgb2JqKTsKICAgIH0pOwogICAgY2xpZW50Lm9uKCdxdWVyeScsIGZ1bmN0aW9uKG9iaikgewogICAgICBrbmV4LmVtaXQoJ3F1ZXJ5Jywgb2JqKTsKICAgIH0pOwogIH0KCiAgLy8gQWxsb3cgY2hhaW5pbmcgbWV0aG9kcyBmcm9tIHRoZSByb290IG9iamVjdCwgYmVmb3JlCiAgLy8gYW55IG90aGVyIGluZm9ybWF0aW9uIGlzIHNwZWNpZmllZC4KICBRdWVyeUludGVyZmFjZS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAga25leFttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBidWlsZGVyID0ga25leCgpOwogICAgICByZXR1cm4gYnVpbGRlclttZXRob2RdLmFwcGx5KGJ1aWxkZXIsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0pOwogIGtuZXguY2xpZW50ID0gY2xpZW50OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhrbmV4LCB7CgogICAgLy8gTGF6eS1sb2FkIC8gcmV0dXJuIGEgInNjaGVtYSIgYnVpbGRlciBvYmplY3QsIGVuc3VyaW5nIGl0J3MgY29udGV4dC1hd2FyZS4KICAgIHNjaGVtYTogewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghY2xpZW50LlNjaGVtYUJ1aWxkZXIpIGNsaWVudC5pbml0U2NoZW1hKCk7CiAgICAgICAgdmFyIGJ1aWxkZXIgPSBuZXcgY2xpZW50LlNjaGVtYUJ1aWxkZXIoKTsKICAgICAgICBpZiAoY29uZmlnLl9fdHJhbnNhY3Rvcl9fKSBidWlsZGVyLnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICAgIH0KICAgIH0sCgogICAgLy8gTGF6eS1sb2FkIC8gcmV0dXJuIGEgYE1pZ3JhdG9yYCBvYmplY3QuCiAgICBtaWdyYXRlOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuTWlncmF0b3IpIGNsaWVudC5pbml0TWlncmF0b3IoKTsKICAgICAgICByZXR1cm4gbmV3IGNsaWVudC5NaWdyYXRvcihrbmV4KTsKICAgICAgfQogICAgfSwKCiAgICAvLyBMYXp5LWxvYWQgLyByZXR1cm4gYSBgU2VlZGVyYCBvYmplY3QuCiAgICBzZWVkOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuU2VlZGVyKSBjbGllbnQuaW5pdFNlZWRlcigpOwogICAgICAgIHJldHVybiBuZXcgY2xpZW50LlNlZWRlcihrbmV4KTsKICAgICAgfQogICAgfSwKCiAgICAvLyBMYXp5LWxvYWQgLyByZXR1cm4gYSBgRnVuY3Rpb25IZWxwZXJgIG9iamVjdC4KICAgIGZuOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuRnVuY3Rpb25IZWxwZXIpIGNsaWVudC5pbml0RnVuY3Rpb25IZWxwZXIoKTsKICAgICAgICByZXR1cm4gY2xpZW50LkZ1bmN0aW9uSGVscGVyOwogICAgICB9CiAgICB9CiAgfSk7CgogIHJldHVybiBrbmV4Owp9OwoKbW9kdWxlLmV4cG9ydHMgPSBLbmV4OwoKfSx7Ii4vbGliL2RpYWxlY3RzL21hcmlhIjo1MiwiLi9saWIvZGlhbGVjdHMvbXlzcWwiOjUyLCIuL2xpYi9kaWFsZWN0cy9teXNxbDIiOjUyLCIuL2xpYi9kaWFsZWN0cy9vcmFjbGUiOjUyLCIuL2xpYi9kaWFsZWN0cy9wb3N0Z3JlcyI6NTIsIi4vbGliL2RpYWxlY3RzL3NxbGl0ZTMiOjUyLCIuL2xpYi9kaWFsZWN0cy93ZWJzcWwiOjk1LCIuL2xpYi9xdWVyeS9tZXRob2RzIjoxMDcsIi4vbGliL3JhdyI6MTA4LCJldmVudHMiOjU3fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyAiQmFzZSBDbGllbnQiCi8vIC0tLS0tLQp2YXIgUHJvbWlzZSAgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwp2YXIgXyAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovLyBUaGUgYmFzZSBjbGllbnQgcHJvdmlkZXMgdGhlIGdlbmVyYWwgc3RydWN0dXJlCi8vIGZvciBhIGRpYWxlY3Qgc3BlY2lmaWMgY2xpZW50IG9iamVjdC4gVGhlIGNsaWVudAovLyBvYmplY3QgYXR0YWNoZXMgZnJlc2ggY29uc3RydWN0b3JzIGZvciBlYWNoIGNvbXBvbmVudAovLyBvZiB0aGUgbGlicmFyeS4KZnVuY3Rpb24gQ2xpZW50KGNvbmZpZykgewogIHRoaXMuaW5pdEZvcm1hdHRlcigpOwogIHRoaXMuaW5pdFJhdygpOwogIHRoaXMuaW5pdFRyYW5zYWN0aW9uKCk7CiAgdGhpcy5pbml0UXVlcnkoKTsKICB0aGlzLm1pZ3JhdGlvbkNvbmZpZyA9IF8uY2xvbmUoY29uZmlnICYmIGNvbmZpZy5taWdyYXRpb25zKTsKICB0aGlzLnNlZWRDb25maWcgPSBfLmNsb25lKGNvbmZpZyAmJiBjb25maWcuc2VlZHMpOwp9CmluaGVyaXRzKENsaWVudCwgRXZlbnRFbWl0dGVyKTsKCi8vIFNldCB0aGUgImlzRGVidWdnaW5nIiBmbGFnIG9uIHRoZSBjbGllbnQgdG8gInRydWUiIHRvIGxvZwovLyBhbGwgcXVlcmllcyBydW4gYnkgdGhlIGNsaWVudC4KQ2xpZW50LnByb3RvdHlwZS5pc0RlYnVnZ2luZyA9IGZhbHNlOwoKLy8gQWNxdWlyZSBhIGNvbm5lY3Rpb24gZnJvbSB0aGUgcG9vbC4KQ2xpZW50LnByb3RvdHlwZS5hY3F1aXJlQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKCkgewogIHZhciBwb29sID0gdGhpcy5wb29sOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIGlmICghcG9vbCkgcmV0dXJuIHJlamVjdGVyKG5ldyBFcnJvcignVGhlcmUgaXMgbm8gcG9vbCBkZWZpbmVkIG9uIHRoZSBjdXJyZW50IGNsaWVudCcpKTsKICAgIHBvb2wuYWNxdWlyZShmdW5jdGlvbihlcnIsIGNvbm5lY3Rpb24pIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdGVyKGVycik7CiAgICAgIHJlc29sdmVyKGNvbm5lY3Rpb24pOwogICAgfSk7CiAgfSk7Cn07CgovLyBSZWxlYXNlcyBhIGNvbm5lY3Rpb24gZnJvbSB0aGUgY29ubmVjdGlvbiBwb29sLAovLyByZXR1cm5pbmcgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgcmVsZWFzZWQuCkNsaWVudC5wcm90b3R5cGUucmVsZWFzZUNvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgdmFyIHBvb2wgPSB0aGlzLnBvb2w7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3RlcikgewogICAgcG9vbC5yZWxlYXNlKGNvbm5lY3Rpb24sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKTsKICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7CiAgICB9KTsKICB9KTsKfTsKCi8vIERlc3Ryb3kgdGhlIGN1cnJlbnQgY29ubmVjdGlvbiBwb29sIGZvciB0aGUgY2xpZW50LgpDbGllbnQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihjYWxsYmFjaykgewogIHZhciBwb29sID0gdGhpcy5wb29sOwogIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7CiAgICBpZiAoIXBvb2wpIHJlc29sdmVyKCk7CiAgICBwb29sLmRlc3Ryb3koZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpOwogICAgICByZXNvbHZlcigpOwogICAgfSk7CiAgfSk7CiAgLy8gQWxsb3cgZWl0aGVyIGEgY2FsbGJhY2sgb3IgcHJvbWlzZSBpbnRlcmZhY2UgZm9yIGRlc3RydWN0aW9uLgogIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgIHByb21pc2UuZXhlYyhjYWxsYmFjayk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBwcm9taXNlOwogIH0KfTsKCi8vIFJldHVybiB0aGUgZGF0YWJhc2UgYmVpbmcgdXNlZCBieSB0aGlzIGNsaWVudC4KQ2xpZW50LnByb3RvdHlwZS5kYXRhYmFzZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLmRhdGFiYXNlTmFtZSB8fCB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncy5kYXRhYmFzZTsKfTsKCm1vZHVsZS5leHBvcnRzID0gQ2xpZW50OwoKfSx7Ii4vcHJvbWlzZSI6MTAzLCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKEJ1ZmZlcil7Cid1c2Ugc3RyaWN0JzsKCmZ1bmN0aW9uIHplcm9QYWQobnVtYmVyLCBsZW5ndGgpIHsKICBudW1iZXIgPSBudW1iZXIudG9TdHJpbmcoKTsKICB3aGlsZSAobnVtYmVyLmxlbmd0aCA8IGxlbmd0aCkgewogICAgbnVtYmVyID0gJzAnICsgbnVtYmVyOwogIH0KCiAgcmV0dXJuIG51bWJlcjsKfQoKZnVuY3Rpb24gY29udmVydFRpbWV6b25lKHR6KSB7CiAgaWYgKHR6ID09PSAiWiIpIHJldHVybiAwOwoKICB2YXIgbSA9IHR6Lm1hdGNoKC8oW1wrXC1cc10pKFxkXGQpOj8oXGRcZCk/Lyk7CiAgaWYgKG0pIHsKICAgIHJldHVybiAobVsxXSA9PT0gJy0nID8gLTEgOiAxKSAqIChwYXJzZUludChtWzJdLCAxMCkgKyAoKG1bM10gPyBwYXJzZUludChtWzNdLCAxMCkgOiAwKSAvIDYwKSkgKiA2MDsKICB9CiAgcmV0dXJuIGZhbHNlOwp9Cgp2YXIgU3FsU3RyaW5nID0gZXhwb3J0czsKClNxbFN0cmluZy5lc2NhcGVJZCA9IGZ1bmN0aW9uICh2YWwsIGZvcmJpZFF1YWxpZmllZCkgewogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgIHJldHVybiB2YWwubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGVJZCh2LCBmb3JiaWRRdWFsaWZpZWQpOwogICAgfSkuam9pbignLCAnKTsKICB9CgogIGlmIChmb3JiaWRRdWFsaWZpZWQpIHsKICAgIHJldHVybiAnYCcgKyB2YWwucmVwbGFjZSgvYC9nLCAnYGAnKSArICdgJzsKICB9CiAgcmV0dXJuICdgJyArIHZhbC5yZXBsYWNlKC9gL2csICdgYCcpLnJlcGxhY2UoL1wuL2csICdgLmAnKSArICdgJzsKfTsKClNxbFN0cmluZy5lc2NhcGUgPSBmdW5jdGlvbih2YWwsIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKSB7CiAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gbnVsbCkgewogICAgcmV0dXJuICdOVUxMJzsKICB9CgogIHN3aXRjaCAodHlwZW9mIHZhbCkgewogICAgY2FzZSAnYm9vbGVhbic6IHJldHVybiAodmFsKSA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgICBjYXNlICdudW1iZXInOiByZXR1cm4gdmFsKycnOwogIH0KCiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHZhbCA9IFNxbFN0cmluZy5kYXRlVG9TdHJpbmcodmFsLCB0aW1lWm9uZSB8fCAnbG9jYWwnKTsKICB9CgogIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgcmV0dXJuIFNxbFN0cmluZy5idWZmZXJUb1N0cmluZyh2YWwpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgcmV0dXJuIFNxbFN0cmluZy5hcnJheVRvTGlzdCh2YWwsIHRpbWVab25lKTsKICB9CgogIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0JykgewogICAgaWYgKHN0cmluZ2lmeU9iamVjdHMpIHsKICAgICAgdmFsID0gdmFsLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gU3FsU3RyaW5nLm9iamVjdFRvVmFsdWVzKHZhbCwgdGltZVpvbmUpOwogICAgfQogIH0KCiAgdmFsID0gdmFsLnJlcGxhY2UoL1tcMFxuXHJcYlx0XFxcJ1wiXHgxYV0vZywgZnVuY3Rpb24ocykgewogICAgc3dpdGNoKHMpIHsKICAgICAgY2FzZSAiXDAiOiByZXR1cm4gIlxcMCI7CiAgICAgIGNhc2UgIlxuIjogcmV0dXJuICJcXG4iOwogICAgICBjYXNlICJcciI6IHJldHVybiAiXFxyIjsKICAgICAgY2FzZSAiXGIiOiByZXR1cm4gIlxcYiI7CiAgICAgIGNhc2UgIlx0IjogcmV0dXJuICJcXHQiOwogICAgICBjYXNlICJceDFhIjogcmV0dXJuICJcXFoiOwogICAgICBkZWZhdWx0OiByZXR1cm4gIlxcIitzOwogICAgfQogIH0pOwogIHJldHVybiAiJyIrdmFsKyInIjsKfTsKClNxbFN0cmluZy5hcnJheVRvTGlzdCA9IGZ1bmN0aW9uKGFycmF5LCB0aW1lWm9uZSkgewogIHJldHVybiBhcnJheS5tYXAoZnVuY3Rpb24odikgewogICAgaWYgKEFycmF5LmlzQXJyYXkodikpIHJldHVybiAnKCcgKyBTcWxTdHJpbmcuYXJyYXlUb0xpc3QodiwgdGltZVpvbmUpICsgJyknOwogICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGUodiwgdHJ1ZSwgdGltZVpvbmUpOwogIH0pLmpvaW4oJywgJyk7Cn07CgpTcWxTdHJpbmcuZm9ybWF0ID0gZnVuY3Rpb24oc3FsLCB2YWx1ZXMsIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKSB7CiAgdmFsdWVzID0gIXZhbHVlcyA/IFtdIDogW10uY29uY2F0KHZhbHVlcyk7CgogIHJldHVybiBzcWwucmVwbGFjZSgvXD9cPz8vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9CgogICAgaWYgKG1hdGNoID09PSAiPz8iKSB7CiAgICAgIHJldHVybiBTcWxTdHJpbmcuZXNjYXBlSWQodmFsdWVzLnNoaWZ0KCkpOwogICAgfQogICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGUodmFsdWVzLnNoaWZ0KCksIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKTsKICB9KTsKfTsKClNxbFN0cmluZy5kYXRlVG9TdHJpbmcgPSBmdW5jdGlvbihkYXRlLCB0aW1lWm9uZSkgewogIHZhciBkdCA9IG5ldyBEYXRlKGRhdGUpOwoKICBpZiAodGltZVpvbmUgIT09ICdsb2NhbCcpIHsKICAgIHZhciB0eiA9IGNvbnZlcnRUaW1lem9uZSh0aW1lWm9uZSk7CgogICAgZHQuc2V0VGltZShkdC5nZXRUaW1lKCkgKyAoZHQuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKSk7CiAgICBpZiAodHogIT09IGZhbHNlKSB7CiAgICAgIGR0LnNldFRpbWUoZHQuZ2V0VGltZSgpICsgKHR6ICogNjAwMDApKTsKICAgIH0KICB9CgogIHZhciB5ZWFyICAgPSBkdC5nZXRGdWxsWWVhcigpOwogIHZhciBtb250aCAgPSB6ZXJvUGFkKGR0LmdldE1vbnRoKCkgKyAxLCAyKTsKICB2YXIgZGF5ICAgID0gemVyb1BhZChkdC5nZXREYXRlKCksIDIpOwogIHZhciBob3VyICAgPSB6ZXJvUGFkKGR0LmdldEhvdXJzKCksIDIpOwogIHZhciBtaW51dGUgPSB6ZXJvUGFkKGR0LmdldE1pbnV0ZXMoKSwgMik7CiAgdmFyIHNlY29uZCA9IHplcm9QYWQoZHQuZ2V0U2Vjb25kcygpLCAyKTsKICB2YXIgbWlsbGlzZWNvbmQgPSB6ZXJvUGFkKGR0LmdldE1pbGxpc2Vjb25kcygpLCAzKTsKCiAgcmV0dXJuIHllYXIgKyAnLScgKyBtb250aCArICctJyArIGRheSArICcgJyArIGhvdXIgKyAnOicgKyBtaW51dGUgKyAnOicgKyBzZWNvbmQgKyAnLicgKyBtaWxsaXNlY29uZDsKfTsKClNxbFN0cmluZy5idWZmZXJUb1N0cmluZyA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogIHZhciBoZXggPSAnJzsKICB0cnkgewogICAgaGV4ID0gYnVmZmVyLnRvU3RyaW5nKCdoZXgnKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIC8vIG5vZGUgdjAuNC54IGRvZXMgbm90IHN1cHBvcnQgaGV4IC8gdGhyb3dzIHVua25vd24gZW5jb2RpbmcgZXJyb3IKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBieXRlID0gYnVmZmVyW2ldOwogICAgICBoZXggKz0gemVyb1BhZChieXRlLnRvU3RyaW5nKDE2KSk7CiAgICB9CiAgfQoKICByZXR1cm4gIlgnIiArIGhleCsgIiciOwp9OwoKU3FsU3RyaW5nLm9iamVjdFRvVmFsdWVzID0gZnVuY3Rpb24ob2JqZWN0LCB0aW1lWm9uZSkgewogIHZhciB2YWx1ZXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICB2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKICAgIGlmKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICB2YWx1ZXMucHVzaCh0aGlzLmVzY2FwZUlkKGtleSkgKyAnID0gJyArIFNxbFN0cmluZy5lc2NhcGUodmFsdWUsIHRydWUsIHRpbWVab25lKSk7CiAgfQoKICByZXR1cm4gdmFsdWVzLmpvaW4oJywgJyk7Cn07Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgiYnVmZmVyIikuQnVmZmVyKQp9LHsiYnVmZmVyIjo1M31dLDgwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMyBGb3JtYXR0ZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIEZvcm1hdHRlciA9IHJlcXVpcmUoJy4uLy4uL2Zvcm1hdHRlcicpOwp2YXIgaW5oZXJpdHMgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCi8vIFRoZSAiZm9ybWF0dGVyIiBpcyB1c2VkIHRvIGVuc3VyZSBhbGwgb3V0cHV0IGlzIHByb3Blcmx5Ci8vIGVzY2FwZWQgJiBwYXJhbWV0ZXJpemVkLgpmdW5jdGlvbiBGb3JtYXR0ZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBGb3JtYXR0ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhGb3JtYXR0ZXJfU1FMaXRlMywgRm9ybWF0dGVyKTsKCkZvcm1hdHRlcl9TUUxpdGUzLnByb3RvdHlwZS5vcGVyYXRvcnMgPSBbCiAgJz0nLCAnPCcsICc+JywgJzw9JywgJz49JywgJzw+JywgJyE9JywKICAnbGlrZScsICdub3QgbGlrZScsICdiZXR3ZWVuJywgJ2lsaWtlJywKICAnJicsICd8JywgJzw8JywgJz4+JwpdOwoKLy8gV3JhcHMgYSB2YWx1ZSAoY29sdW1uLCB0YWJsZU5hbWUpIHdpdGggdGhlIGNvcnJlY3QgdGlja3MuCkZvcm1hdHRlcl9TUUxpdGUzLnByb3RvdHlwZS53cmFwVmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiAodmFsdWUgIT09ICcqJyA/ICciJyArIHZhbHVlICsgJyInIDogJyonKTsKfTsKCi8vIE1lbW9pemUgdGhlIGNhbGxzIHRvICJ3cmFwIiBmb3IgYSBsaXR0bGUgZXh0cmEgcGVyZi4KdmFyIHdyYXBwZXJNZW1vID0gKGZ1bmN0aW9uKCl7CiAgdmFyIG1lbW8gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHJldHVybiBmdW5jdGlvbihrZXkpIHsKICAgIGlmIChtZW1vW2tleV0gPT09IHZvaWQgMCkgewogICAgICBtZW1vW2tleV0gPSB0aGlzLl93cmFwU3RyaW5nKGtleSk7CiAgICB9CiAgICByZXR1cm4gbWVtb1trZXldOwogIH07Cn0oKSk7CgpGb3JtYXR0ZXJfU1FMaXRlMy5wcm90b3R5cGUuX3dyYXAgPSB3cmFwcGVyTWVtbzsKCi8vIEFzc2lnbiB0aGUgZm9ybWF0dGVyIHRvIHRoZSB0aGUgY2xpZW50LgpjbGllbnQuRm9ybWF0dGVyID0gRm9ybWF0dGVyX1NRTGl0ZTM7Cgp9Owp9LHsiLi4vLi4vZm9ybWF0dGVyIjo5NywiaW5oZXJpdHMiOjc2fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIEZ1bmN0aW9uSGVscGVyID0gcmVxdWlyZSgnLi4vLi4vZnVuY3Rpb25oZWxwZXInKTsKCnZhciBGdW5jdGlvbkhlbHBlcl9TUUxpdGUzID0gT2JqZWN0LmNyZWF0ZShGdW5jdGlvbkhlbHBlcik7CkZ1bmN0aW9uSGVscGVyX1NRTGl0ZTMuY2xpZW50ID0gY2xpZW50OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgRnVuY3Rpb25IZWxwZXJgIGNvbnN0cnVjdG9yIHRvIHRoZSBjbGllbnQgb2JqZWN0LgpjbGllbnQuRnVuY3Rpb25IZWxwZXIgPSBGdW5jdGlvbkhlbHBlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL2Z1bmN0aW9uaGVscGVyIjo5OH1dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMwovLyAtLS0tLS0tCgp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwoKdmFyIENsaWVudCAgPSByZXF1aXJlKCcuLi8uLi9jbGllbnQnKTsKdmFyIFByb21pc2UgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJyk7CgpmdW5jdGlvbiBDbGllbnRfU1FMaXRlMyhjb25maWcpIHsKICBDbGllbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoY29uZmlnLmRlYnVnKSB0aGlzLmlzRGVidWdnaW5nID0gdHJ1ZTsKICBpZiAoY29uZmlnLmNvbm5lY3Rpb24pIHsKICAgIHRoaXMuaW5pdERyaXZlcigpOwogICAgdGhpcy5pbml0UnVubmVyKCk7CiAgICB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncyA9IGNvbmZpZy5jb25uZWN0aW9uOwogICAgdGhpcy5pbml0UG9vbCgpOwogICAgdGhpcy5wb29sID0gbmV3IHRoaXMuUG9vbChjb25maWcucG9vbCk7CiAgfQogIC8vIFRvZG86IFBsdWdpbnMgaGVyZSBwb3NzaWJseT8/Cn0KaW5oZXJpdHMoQ2xpZW50X1NRTGl0ZTMsIENsaWVudCk7CgovLyBMYXp5IGxvYWQgdGhlIHNxbGl0ZTMgbW9kdWxlLCBzaW5jZSB3ZSBtaWdodCBqdXN0IGJlIHVzaW5nCi8vIHRoZSBjbGllbnQgdG8gZ2VuZXJhdGUgU1FMIHN0cmluZ3MuCnZhciBzcWxpdGUzOwoKQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmRpYWxlY3QgPSAnc3FsaXRlMyc7CgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi90cmFuc2FjdGlvbicpKHRoaXMpOwp9OwoKQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRGb3JtYXR0ZXIgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL2Zvcm1hdHRlcicpKHRoaXMpOwp9OwoKLy8gTGF6eS1sb2FkIHRoZSBzcWxpdGUzIGRlcGVuZGVuY3kuCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0RHJpdmVyID0gZnVuY3Rpb24oKSB7CiAgc3FsaXRlMyA9IHNxbGl0ZTMgfHwgcmVxdWlyZSgnc3FsaXRlMycpOwp9OwoKLy8gSW5pdGlhbGl6ZSB0aGUgcmF3IGNvbm5lY3Rpb24gb24gdGhlIGNsaWVudC4KQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRSYXcgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3JhdycpKHRoaXMpOwp9OwoKLy8gQXR0YWNoZXMgdGhlIGBGdW5jdGlvbkhlbHBlcmAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0RnVuY3Rpb25IZWxwZXIgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL2Z1bmN0aW9uaGVscGVyJykodGhpcyk7Cn07CgovLyBBbHdheXMgaW5pdGlhbGl6ZSB3aXRoIHRoZSAiUXVlcnkiIGFuZCAiUXVlcnlDb21waWxlciIKLy8gb2JqZWN0cywgZWFjaCBvZiB3aGljaCBpcyB1bmlxdWUgdG8gdGhpcyBjbGllbnQgKGFuZCB0aHVzKQovLyBjYW4gYmUgYWx0ZXJlZCB3aXRob3V0IG1lc3NpbmcgdXAgYW55dGhpbmcgZm9yIGFueW9uZSBlbHNlLgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFF1ZXJ5ID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi9xdWVyeScpKHRoaXMpOwp9OwoKLy8gSW5pdGlhbGl6ZXMgYSBuZXcgcG9vbCBpbnN0YW5jZSBmb3IgdGhlIGN1cnJlbnQgY2xpZW50LgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFBvb2wgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3Bvb2wnKSh0aGlzKTsKfTsKCi8vIEluaXRpYWxpemUgdGhlIHF1ZXJ5ICJydW5uZXIiCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0UnVubmVyID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi9ydW5uZXInKSh0aGlzKTsKfTsKCi8vIExhenktbG9hZCB0aGUgc2NoZW1hIGRlcGVuZGVuY2llcy4KQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRTY2hlbWEgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3NjaGVtYScpKHRoaXMpOwp9OwoKLy8gTGF6eS1sb2FkIHRoZSBtaWdyYXRpb24gZGVwZW5kZW5jeQpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdE1pZ3JhdG9yID0gZnVuY3Rpb24oKSB7CiAgICByZXF1aXJlKCcuL21pZ3JhdG9yJykodGhpcyk7Cn07CgovLyBMYXp5LWxvYWQgdGhlIHNlZWRpbmcgZGVwZW5kZW5jeQpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFNlZWRlciA9IGZ1bmN0aW9uKCkgewogICAgcmVxdWlyZSgnLi9zZWVkZXInKSh0aGlzKTsKfTsKCi8vIEdldCBhIHJhdyBjb25uZWN0aW9uIGZyb20gdGhlIGRhdGFiYXNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHdpdGggdGhlIGNvbm5lY3Rpb24gb2JqZWN0LgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuYWNxdWlyZVJhd0Nvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHsKICB2YXIgZHJpdmVyID0gdGhpczsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICB2YXIgZGIgPSBuZXcgc3FsaXRlMy5EYXRhYmFzZShkcml2ZXIuY29ubmVjdGlvblNldHRpbmdzLmZpbGVuYW1lLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpOwogICAgICByZXNvbHZlKGRiKTsKICAgIH0pOwogIH0pOwp9OwoKLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2wKLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuZGVzdHJveVJhd0Nvbm5lY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgY29ubmVjdGlvbi5jbG9zZSgpOwp9KTsKCm1vZHVsZS5leHBvcnRzID0gQ2xpZW50X1NRTGl0ZTM7Cn0seyIuLi8uLi9jbGllbnQiOjc4LCIuLi8uLi9wcm9taXNlIjoxMDMsIi4vZm9ybWF0dGVyIjo4MCwiLi9mdW5jdGlvbmhlbHBlciI6ODEsIi4vbWlncmF0b3IiOjgzLCIuL3Bvb2wiOjg0LCIuL3F1ZXJ5Ijo4NSwiLi9yYXciOjg2LCIuL3J1bm5lciI6ODcsIi4vc2NoZW1hIjo5MCwiLi9zZWVkZXIiOjkzLCIuL3RyYW5zYWN0aW9uIjo5NCwiaW5oZXJpdHMiOjc2LCJzcWxpdGUzIjo1Mn1dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBNaWdyYXRvciA9IHJlcXVpcmUoJy4uLy4uL21pZ3JhdGUnKTsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCi8vIEluaGVyaXQgZnJvbSB0aGUgYE1pZ3JhdG9yYCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBNaWdyYXRvcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIE1pZ3JhdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoTWlncmF0b3JfU1FMaXRlMywgTWlncmF0b3IpOwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgTWlncmF0b3JgIGNvbnN0cnVjdG9yIHRvIHRoZSBjbGllbnQgb2JqZWN0LgpjbGllbnQuTWlncmF0b3IgPSBNaWdyYXRvcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL21pZ3JhdGUiOjEwMSwiaW5oZXJpdHMiOjc2fV0sODQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFBvb2wgICAgID0gcmVxdWlyZSgnLi4vLi4vcG9vbCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKCi8vIEluaGVyaXQgZnJvbSB0aGUgYFBvb2xgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLgpmdW5jdGlvbiBQb29sX1NRTGl0ZTMoKSB7CiAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgUG9vbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFBvb2xfU1FMaXRlMywgUG9vbCk7CgpQb29sX1NRTGl0ZTMucHJvdG90eXBlLmRlZmF1bHRzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIF8uZXh0ZW5kKFBvb2wucHJvdG90eXBlLmRlZmF1bHRzLmNhbGwodGhpcyksIHsKICAgIG1heDogMSwKICAgIG1pbjogMSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKGNsaWVudCkgeyBjbGllbnQuY2xvc2UoKTsgfQogIH0pOwp9OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgUG9vbGAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5Qb29sID0gUG9vbF9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL3Bvb2wiOjEwMiwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMyBRdWVyeSBCdWlsZGVyICYgQ29tcGlsZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Cgp2YXIgUXVlcnlCdWlsZGVyICA9IHJlcXVpcmUoJy4uLy4uL3F1ZXJ5L2J1aWxkZXInKTsKdmFyIFF1ZXJ5Q29tcGlsZXIgPSByZXF1aXJlKCcuLi8uLi9xdWVyeS9jb21waWxlcicpOwoKLy8gUXVlcnkgQnVpbGRlcgovLyAtLS0tLS0tCmZ1bmN0aW9uIFF1ZXJ5QnVpbGRlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFF1ZXJ5QnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFF1ZXJ5QnVpbGRlcl9TUUxpdGUzLCBRdWVyeUJ1aWxkZXIpOwoKLy8gUXVlcnkgQ29tcGlsZXIKLy8gLS0tLS0tLQpmdW5jdGlvbiBRdWVyeUNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5mb3JtYXR0ZXIgPSBuZXcgY2xpZW50LkZvcm1hdHRlcigpOwogIFF1ZXJ5Q29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhRdWVyeUNvbXBpbGVyX1NRTGl0ZTMsIFF1ZXJ5Q29tcGlsZXIpOwoKLy8gVGhlIGxvY2tzIGFyZSBub3QgYXBwbGljYWJsZSBpbiBTUUxpdGUzClF1ZXJ5Q29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZm9yU2hhcmUgPQpRdWVyeUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmZvclVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAnJzsKfTsKCi8vIFNRTGl0ZSByZXF1aXJlcyB1cyB0byBidWlsZCB0aGUgbXVsdGktcm93IGluc2VydCBhcyBhIGxpc3Rpbmcgb2Ygc2VsZWN0IHdpdGgKLy8gdW5pb25zIGpvaW5pbmcgdGhlbSB0b2dldGhlci4gU28gd2UnbGwgYnVpbGQgb3V0IHRoaXMgbGlzdCBvZiBjb2x1bW5zIGFuZAovLyB0aGVuIGpvaW4gdGhlbSBhbGwgdG9nZXRoZXIgd2l0aCBzZWxlY3QgdW5pb25zIHRvIGNvbXBsZXRlIHRoZSBxdWVyaWVzLgpRdWVyeUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmluc2VydCA9IGZ1bmN0aW9uKCkgewogIHZhciBpbnNlcnQgPSB0aGlzLnNpbmdsZS5pbnNlcnQ7CiAgdmFyIHNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7CgogIGlmIChfLmlzQXJyYXkoaW5zZXJ0KSAmJiAoaW5zZXJ0Lmxlbmd0aCA9PT0gMSkgJiYgXy5pc0VtcHR5KGluc2VydFswXSkpIHsKICAgIGluc2VydCA9IFtdOwogIH0KCiAgaWYgKF8uaXNFbXB0eShpbnNlcnQpICYmICFfLmlzRnVuY3Rpb24oaW5zZXJ0KSkgewogICAgcmV0dXJuIHNxbCArICdkZWZhdWx0IHZhbHVlcyc7CiAgfQogIHZhciBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnQpOwogIGlmIChfLmlzU3RyaW5nKGluc2VydERhdGEpKSByZXR1cm4gc3FsICsgaW5zZXJ0RGF0YTsKICBzcWwgKz0gJygnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGluc2VydERhdGEuY29sdW1ucykgKyAnKSc7CiAgaWYgKGluc2VydERhdGEudmFsdWVzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIHNxbCArICcgdmFsdWVzICgnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKGluc2VydERhdGEudmFsdWVzWzBdKSArICcpJzsKICB9CiAgdmFyIGJsb2NrcyA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBsID0gaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgYmxvY2sgPSBibG9ja3NbaV0gPSBbXTsKICAgIHZhciBjdXJyZW50ID0gaW5zZXJ0RGF0YS52YWx1ZXNbaV07CiAgICBmb3IgKHZhciBpMiA9IDAsIGwyID0gaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aDsgaTIgPCBsMjsgaTIrKykgewogICAgICBibG9jay5wdXNoKHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihjdXJyZW50W2kyXSkgKyAnIGFzICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGluc2VydERhdGEuY29sdW1uc1tpMl0pKTsKICAgIH0KICAgIGJsb2Nrc1tpXSA9IGJsb2NrLmpvaW4oJywgJyk7CiAgfQogIHJldHVybiBzcWwgKyAnIHNlbGVjdCAnICsgYmxvY2tzLmpvaW4oJyB1bmlvbiBhbGwgc2VsZWN0ICcpOwp9OwoKLy8gQ29tcGlsZSBhIHRydW5jYXRlIHRhYmxlIHN0YXRlbWVudCBpbnRvIFNRTC4KUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHZhciB0YWJsZSA9IHRoaXMudGFibGVOYW1lOwogIHJldHVybiB7CiAgICBzcWw6ICdkZWxldGUgZnJvbSBzcWxpdGVfc2VxdWVuY2Ugd2hlcmUgbmFtZSA9ICcgKyB0aGlzLnRhYmxlTmFtZSwKICAgIG91dHB1dDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHtzcWw6ICdkZWxldGUgZnJvbSAnICsgdGFibGV9KTsKICAgIH0KICB9Owp9OwoKLy8gQ29tcGlsZXMgYSBgY29sdW1uSW5mb2AgcXVlcnkKUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5jb2x1bW5JbmZvID0gZnVuY3Rpb24oKSB7CiAgdmFyIGNvbHVtbiA9IHRoaXMuc2luZ2xlLmNvbHVtbkluZm87CiAgcmV0dXJuIHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLnNpbmdsZS50YWJsZSArJyknLAogICAgb3V0cHV0OiBmdW5jdGlvbihyZXNwKSB7CiAgICAgIHZhciBtYXhMZW5ndGhSZWdleCA9IC8uKlwoKFxkKylcKS87CiAgICAgIHZhciBvdXQgPSBfLnJlZHVjZShyZXNwLCBmdW5jdGlvbiAoY29sdW1ucywgdmFsKSB7CiAgICAgICAgdmFyIHR5cGUgPSB2YWwudHlwZTsKICAgICAgICB2YXIgbWF4TGVuZ3RoID0gKG1heExlbmd0aCA9IHR5cGUubWF0Y2gobWF4TGVuZ3RoUmVnZXgpKSAmJiBtYXhMZW5ndGhbMV07CiAgICAgICAgdHlwZSA9IG1heExlbmd0aCA/IHR5cGUuc3BsaXQoJygnKVswXSA6IHR5cGU7CiAgICAgICAgY29sdW1uc1t2YWwubmFtZV0gPSB7CiAgICAgICAgICB0eXBlOiB0eXBlLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICBtYXhMZW5ndGg6IG1heExlbmd0aCwKICAgICAgICAgIG51bGxhYmxlOiAhdmFsLm5vdG51bGwsCiAgICAgICAgICBkZWZhdWx0VmFsdWU6IHZhbC5kZmx0X3ZhbHVlCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gY29sdW1uczsKICAgICAgfSwge30pOwogICAgICByZXR1cm4gY29sdW1uICYmIG91dFtjb2x1bW5dIHx8IG91dDsKICAgIH0KICB9Owp9OwoKUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5saW1pdCA9IGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5zaW5nbGUubGltaXQgJiYgIXRoaXMuc2luZ2xlLm9mZnNldCkgcmV0dXJuICcnOwoKICAvLyBXb3JrYXJvdW5kIGZvciBvZmZzZXQgb25seSwgc2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTA0OTE0OTIvc3FsbGl0ZS13aXRoLXNraXAtb2Zmc2V0LW9ubHktbm90LWxpbWl0CiAgcmV0dXJuICdsaW1pdCAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKCh0aGlzLnNpbmdsZS5vZmZzZXQgJiYgIXRoaXMuc2luZ2xlLmxpbWl0KSA/IC0xIDogdGhpcy5zaW5nbGUubGltaXQpOwp9OwoKY2xpZW50LlF1ZXJ5QnVpbGRlciA9IFF1ZXJ5QnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuUXVlcnlDb21waWxlciA9IFF1ZXJ5Q29tcGlsZXJfU1FMaXRlMzsKCn07Cgp9LHsiLi4vLi4vcXVlcnkvYnVpbGRlciI6MTA0LCIuLi8uLi9xdWVyeS9jb21waWxlciI6MTA1LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSYXcKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFJhdyA9IHJlcXVpcmUoJy4uLy4uL3JhdycpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwoKLy8gSW5oZXJpdCBmcm9tIHRoZSBgUmF3YCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBSYXdfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBSYXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhSYXdfU1FMaXRlMywgUmF3KTsKCi8vIEFzc2lnbiB0aGUgbmV3bHkgZXh0ZW5kZWQgYFJhd2AgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5SYXcgPSBSYXdfU1FMaXRlMzsKCn07Cn0seyIuLi8uLi9yYXciOjEwOCwiaW5oZXJpdHMiOjc2fV0sODc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSdW5uZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTsKdmFyIFJ1bm5lciAgID0gcmVxdWlyZSgnLi4vLi4vcnVubmVyJyk7CnZhciBoZWxwZXJzICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKTsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CgovLyBJbmhlcml0IGZyb20gdGhlIGBSdW5uZXJgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLAovLyBzbyB3ZSBjYW4gYWRkIHRoZSBjb3JyZWN0IGB0aGVuYCBtZXRob2QuCmZ1bmN0aW9uIFJ1bm5lcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFJ1bm5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFJ1bm5lcl9TUUxpdGUzLCBSdW5uZXIpOwoKUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLl9iZWdpblRyYW5zYWN0aW9uID0gJ2JlZ2luIHRyYW5zYWN0aW9uOyc7CgovLyBSdW5zIHRoZSBxdWVyeSBvbiB0aGUgc3BlY2lmaWVkIGNvbm5lY3Rpb24sIHByb3ZpZGluZyB0aGUgYmluZGluZ3MgYW5kIGFueSBvdGhlciBuZWNlc3NhcnkgcHJlcCB3b3JrLgpSdW5uZXJfU1FMaXRlMy5wcm90b3R5cGUuX3F1ZXJ5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ob2JqKSB7CiAgdmFyIG1ldGhvZCA9IG9iai5tZXRob2Q7CiAgaWYgKHRoaXMuaXNEZWJ1Z2dpbmcoKSkgdGhpcy5kZWJ1ZyhvYmopOwogIHZhciBjYWxsTWV0aG9kOwogIHN3aXRjaCAobWV0aG9kKSB7CiAgICBjYXNlICdpbnNlcnQnOgogICAgY2FzZSAndXBkYXRlJzoKICAgIGNhc2UgJ2NvdW50ZXInOgogICAgY2FzZSAnZGVsJzoKICAgICAgY2FsbE1ldGhvZCA9ICdydW4nOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNhbGxNZXRob2QgPSAnYWxsJzsKICB9CiAgdmFyIGNvbm5lY3Rpb24gPSB0aGlzLmNvbm5lY3Rpb247CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3RlcikgewogICAgaWYgKCFjb25uZWN0aW9uIHx8ICFjb25uZWN0aW9uW2NhbGxNZXRob2RdKSB7CiAgICAgIHJldHVybiByZWplY3RlcihuZXcgRXJyb3IoJ0Vycm9yIGNhbGxpbmcgJyArIGNhbGxNZXRob2QgKyAnIG9uIGNvbm5lY3Rpb24uJykpOwogICAgfQogICAgY29ubmVjdGlvbltjYWxsTWV0aG9kXShvYmouc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdGVyKGVycik7CiAgICAgIG9iai5yZXNwb25zZSA9IHJlc3BvbnNlOwoKICAgICAgLy8gV2UgbmVlZCB0aGUgY29udGV4dCBoZXJlLCBhcyBpdCBjb250YWlucwogICAgICAvLyB0aGUgInRoaXMubGFzdElEIiBvciAidGhpcy5jaGFuZ2VzIgogICAgICBvYmouY29udGV4dCAgPSB0aGlzOwogICAgICByZXR1cm4gcmVzb2x2ZXIob2JqKTsKICAgIH0pOwogIH0pOwp9KTsKCi8vIFNvdW5kcyBsaWtlIC5lYWNoIGRvZXNuJ3Qgd29yayBncmVhdCBmb3IKUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLl9zdHJlYW0gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihzcWwsIHN0cmVhbSwgb3B0aW9ucykgewogIC8qanNoaW50IHVudXNlZDogZmFsc2UqLwogIHZhciBydW5uZXIgPSB0aGlzOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3Rlcik7CiAgICBzdHJlYW0ub24oJ2VuZCcsIHJlc29sdmVyKTsKICAgIHJldHVybiBydW5uZXIucXVlcnkoc3FsKS5tYXAoZnVuY3Rpb24ocm93KSB7CiAgICAgIHN0cmVhbS53cml0ZShyb3cpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzdHJlYW0uZW5kKCk7CiAgICB9KTsKICB9KTsKfSk7CgovLyBFbnN1cmVzIHRoZSByZXNwb25zZSBpcyByZXR1cm5lZCBpbiB0aGUgc2FtZSBmb3JtYXQgYXMgb3RoZXIgY2xpZW50cy4KUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaikgewogIHZhciBjdHggICAgICA9IG9iai5jb250ZXh0OwogIHZhciByZXNwb25zZSA9IG9iai5yZXNwb25zZTsKICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbCh0aGlzLCByZXNwb25zZSk7CiAgc3dpdGNoIChvYmoubWV0aG9kKSB7CiAgICBjYXNlICdzZWxlY3QnOgogICAgY2FzZSAncGx1Y2snOgogICAgY2FzZSAnZmlyc3QnOgogICAgICByZXNwb25zZSA9IGhlbHBlcnMuc2tpbShyZXNwb25zZSk7CiAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXNwb25zZSA9IF8ucGx1Y2socmVzcG9uc2UsIG9iai5wbHVjayk7CiAgICAgIHJldHVybiBvYmoubWV0aG9kID09PSAnZmlyc3QnID8gcmVzcG9uc2VbMF0gOiByZXNwb25zZTsKICAgIGNhc2UgJ2luc2VydCc6CiAgICAgIHJldHVybiBbY3R4Lmxhc3RJRF07CiAgICBjYXNlICdkZWwnOgogICAgY2FzZSAndXBkYXRlJzoKICAgIGNhc2UgJ2NvdW50ZXInOgogICAgICByZXR1cm4gY3R4LmNoYW5nZXM7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gcmVzcG9uc2U7CiAgfQp9OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgUnVubmVyYCBjb25zdHJ1Y3RvciB0byB0aGUgY2xpZW50IG9iamVjdC4KY2xpZW50LlJ1bm5lciA9IFJ1bm5lcl9TUUxpdGUzOwoKfTsKCn0seyIuLi8uLi9oZWxwZXJzIjo5OSwiLi4vLi4vcHJvbWlzZSI6MTAzLCIuLi8uLi9ydW5uZXIiOjEwOSwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMzogQ29sdW1uIEJ1aWxkZXIgJiBDb21waWxlcgovLyAtLS0tLS0tCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY2xpZW50KSB7Cgp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgU2NoZW1hICAgPSByZXF1aXJlKCcuLi8uLi8uLi9zY2hlbWEnKTsKCi8vIENvbHVtbiBCdWlsZGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIENvbHVtbkJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuQ29sdW1uQnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKENvbHVtbkJ1aWxkZXJfU1FMaXRlMywgU2NoZW1hLkNvbHVtbkJ1aWxkZXIpOwoKLy8gQ29sdW1uIENvbXBpbGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIENvbHVtbkNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5tb2RpZmllcnMgPSBbJ251bGxhYmxlJywgJ2RlZmF1bHRUbyddOwogIHRoaXMuRm9ybWF0dGVyID0gY2xpZW50LkZvcm1hdHRlcjsKICBTY2hlbWEuQ29sdW1uQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhDb2x1bW5Db21waWxlcl9TUUxpdGUzLCBTY2hlbWEuQ29sdW1uQ29tcGlsZXIpOwoKLy8gVHlwZXMKLy8gLS0tLS0tLQoKQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZG91YmxlID0KQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZGVjaW1hbCA9CkNvbHVtbkNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmZsb2F0aW5nID0gJ2Zsb2F0JzsKQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUudGltZXN0YW1wID0gJ2RhdGV0aW1lJzsKCmNsaWVudC5Db2x1bW5CdWlsZGVyID0gQ29sdW1uQnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuQ29sdW1uQ29tcGlsZXIgPSBDb2x1bW5Db21waWxlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uLy4uL3NjaGVtYSI6MTE0LCJpbmhlcml0cyI6NzZ9XSw4OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFNRTGl0ZTNfRERMCi8vCi8vIEFsbCBvZiB0aGUgU1FMaXRlMyBzcGVjaWZpYyBEREwgaGVscGVycyBmb3IgcmVuYW1pbmcvZHJvcHBpbmcKLy8gY29sdW1ucyBhbmQgY2hhbmdpbmcgZGF0YXR5cGVzLgovLyAtLS0tLS0tCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY2xpZW50KSB7Cgp2YXIgXyAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uLy4uL3Byb21pc2UnKTsKCi8vIFNvIGFsdGVyaW5nIHRoZSBzY2hlbWEgaW4gU1FMaXRlMyBpcyBhIG1ham9yIHBhaW4uCi8vIFdlIGhhdmUgb3VyIG93biBvYmplY3QgdG8gZGVhbCB3aXRoIHRoZSByZW5hbWluZyBhbmQgYWx0ZXJpbmcgdGhlIHR5cGVzCi8vIGZvciBzcWxpdGUzIHRoaW5ncy4KZnVuY3Rpb24gU1FMaXRlM19EREwocnVubmVyLCB0YWJsZUNvbXBpbGVyLCBwcmFnbWEpIHsKICB0aGlzLnRhYmxlQ29tcGlsZXIgPSB0YWJsZUNvbXBpbGVyOwogIHRoaXMucHJhZ21hID0gcHJhZ21hOwogIHRoaXMucnVubmVyID0gcnVubmVyOwogIHRoaXMuZm9ybWF0dGVyID0gbmV3IGNsaWVudC5Gb3JtYXR0ZXIoKTsKICB0aGlzLnRhYmxlTmFtZSA9IHRoaXMudGFibGVDb21waWxlci50YWJsZU5hbWVSYXc7CiAgdGhpcy5hbHRlcmVkTmFtZSA9ICdfa25leF90ZW1wX2FsdGVyJyArIF8udW5pcXVlSWQoKTsKfQoKU1FMaXRlM19EREwucHJvdG90eXBlLmdldENvbHVtbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbHVtbikgewogIHZhciBjdXJyZW50Q29sID0gXy5maW5kV2hlcmUodGhpcy5wcmFnbWEsIHtuYW1lOiBjb2x1bW59KTsKICBpZiAoIWN1cnJlbnRDb2wpIHRocm93IG5ldyBFcnJvcignVGhlIGNvbHVtbiAnICsgY29sdW1uICsgJyBpcyBub3QgaW4gdGhlICcgKyB0aGlzLnRhYmxlTmFtZSArICcgdGFibGUnKTsKICByZXR1cm4gY3VycmVudENvbDsKfSk7CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZW5zdXJlVHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5ydW5uZXIuYmVnaW5UcmFuc2FjdGlvbigpOwogIH0KfSk7CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuY29tbWl0VHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5ydW5uZXIuY29tbWl0VHJhbnNhY3Rpb24oKTsKICB9Cn0pOwoKU1FMaXRlM19EREwucHJvdG90eXBlLnJvbGxiYWNrVHJhbnNhY3Rpb24gPSBmdW5jdGlvbihlKSB7CiAgaWYgKHRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB0aHJvdyBlOwogIHJldHVybiB0aGlzLnJ1bm5lci5yb2xsYmFja1RyYW5zYWN0aW9uKCkudGhyb3coZSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZ2V0VGFibGVTcWwgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogJ1NFTEVDVCBuYW1lLCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGU9InRhYmxlIiBBTkQgbmFtZT0iJyArIHRoaXMudGFibGVOYW1lICsgJyInfSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUucmVuYW1lVGFibGUgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogJ0FMVEVSIFRBQkxFICInICsgdGhpcy50YWJsZU5hbWUgKyAnIiBSRU5BTUUgVE8gIicgKyB0aGlzLmFsdGVyZWROYW1lICsgJyInfSk7Cn0pOwoKU1FMaXRlM19EREwucHJvdG90eXBlLmRyb3BPcmlnaW5hbCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnRFJPUCBUQUJMRSAiJyArIHRoaXMudGFibGVOYW1lICsgJyInfSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZHJvcFRlbXBUYWJsZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnRFJPUCBUQUJMRSAiJyArIHRoaXMuYWx0ZXJlZE5hbWUgKyAnIid9KTsKfTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5jb3B5RGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnU0VMRUNUICogRlJPTSAiJyArIHRoaXMudGFibGVOYW1lICsgJyInfSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmluc2VydENodW5rZWQoMjAsIHRoaXMuYWx0ZXJlZE5hbWUpKTsKfTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5yZWluc2VydERhdGEgPSBmdW5jdGlvbihpdGVyYXRvcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnU0VMRUNUICogRlJPTSAiJyArIHRoaXMuYWx0ZXJlZE5hbWUgKyAnIid9KQogICAgICAuYmluZCh0aGlzKQogICAgICAudGhlbih0aGlzLmluc2VydENodW5rZWQoMjAsIHRoaXMudGFibGVOYW1lLCBpdGVyYXRvcikpOwogIH07Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuaW5zZXJ0Q2h1bmtlZCA9IGZ1bmN0aW9uKGFtb3VudCwgdGFyZ2V0LCBpdGVyYXRvcikgewogIGl0ZXJhdG9yID0gaXRlcmF0b3IgfHwgZnVuY3Rpb24obm9vcCkgeyByZXR1cm4gbm9vcDsgfTsKICByZXR1cm4gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICB2YXIgYmF0Y2ggPSBbXTsKICAgIHZhciBkZGwgPSB0aGlzOwogICAgcmV0dXJuIFByb21pc2UucmVkdWNlKHJlc3VsdCwgZnVuY3Rpb24obWVtbywgcm93KSB7CiAgICAgIG1lbW8rKzsKICAgICAgYmF0Y2gucHVzaChyb3cpOwogICAgICBpZiAobWVtbyAlIDIwID09PSAwIHx8IG1lbW8gPT09IHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gbmV3IGNsaWVudC5RdWVyeUJ1aWxkZXIoKQogICAgICAgICAgLmNvbm5lY3Rpb24oZGRsLnJ1bm5lci5jb25uZWN0aW9uKQogICAgICAgICAgLnRhYmxlKHRhcmdldCkKICAgICAgICAgIC5pbnNlcnQoXy5tYXAoYmF0Y2gsIGl0ZXJhdG9yKSkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgeyBiYXRjaCA9IFtdOyB9KQogICAgICAgICAgLnRoZW5SZXR1cm4obWVtbyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1lbW87CiAgICB9LCAwKTsKICB9Owp9OwoKU1FMaXRlM19EREwucHJvdG90eXBlLmNyZWF0ZVRlbXBUYWJsZSA9IGZ1bmN0aW9uKGNyZWF0ZVRhYmxlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucnVubmVyLnF1ZXJ5KHtzcWw6IGNyZWF0ZVRhYmxlLnNxbC5yZXBsYWNlKHRoaXMudGFibGVOYW1lLCB0aGlzLmFsdGVyZWROYW1lKX0pOwogIH07Cn07CgovLyBCb3ksIHRoaXMgaXMgcXVpdGUgYSBtZXRob2QuClNRTGl0ZTNfRERMLnByb3RvdHlwZS5yZW5hbWVDb2x1bW4gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihmcm9tLCB0bykgewogIHZhciBjdXJyZW50Q29sOwogIHJldHVybiB0aGlzLmVuc3VyZVRyYW5zYWN0aW9uKCkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uKGZyb20pOwogICAgfSkKICAgIC50YXAoZnVuY3Rpb24oY29sKSB7IGN1cnJlbnRDb2wgPSBjb2w7IH0pCiAgICAudGhlbih0aGlzLmdldFRhYmxlU3FsKQogICAgLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHZhciBjcmVhdGVUYWJsZSA9IHNxbFswXTsKICAgICAgdmFyIGEgPSB0aGlzLmZvcm1hdHRlci53cmFwKGZyb20pICsgJyAnICsgY3VycmVudENvbC50eXBlOwogICAgICB2YXIgYiA9IHRoaXMuZm9ybWF0dGVyLndyYXAodG8pICAgKyAnICcgKyBjdXJyZW50Q29sLnR5cGU7CiAgICAgIGlmIChjcmVhdGVUYWJsZS5zcWwuaW5kZXhPZihhKSA9PT0gLTEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBmaW5kIHRoZSBjb2x1bW4gdG8gY2hhbmdlJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UuYmluZCh0aGlzKQogICAgICAudGhlbih0aGlzLmNyZWF0ZVRlbXBUYWJsZShjcmVhdGVUYWJsZSkpCiAgICAgIC50aGVuKHRoaXMuY29weURhdGEpCiAgICAgIC50aGVuKHRoaXMuZHJvcE9yaWdpbmFsKQogICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogY3JlYXRlVGFibGUuc3FsLnJlcGxhY2UoYSwgYil9KTsKICAgICAgfSkKICAgICAgLnRoZW4odGhpcy5yZWluc2VydERhdGEoZnVuY3Rpb24ocm93KSB7CiAgICAgICAgcm93W3RvXSA9IHJvd1tmcm9tXTsKICAgICAgICByZXR1cm4gXy5vbWl0KHJvdywgZnJvbSk7CiAgICAgIH0pKQogICAgICAudGhlbih0aGlzLmRyb3BUZW1wVGFibGUpOwogICAgfSkKICAgIC50YXAodGhpcy5jb21taXRUcmFuc2FjdGlvbikKICAgIC5jYXRjaCh0aGlzLnJvbGxiYWNrVHJhbnNhY3Rpb24pOwp9KTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5kcm9wQ29sdW1uID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29sdW1uKSB7CiAgIHZhciBjdXJyZW50Q29sOwogICByZXR1cm4gdGhpcy5lbnN1cmVUcmFuc2FjdGlvbigpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldENvbHVtbihjb2x1bW4pOwogICAgfSkKICAgIC50YXAoZnVuY3Rpb24oY29sKSB7IGN1cnJlbnRDb2wgPSBjb2w7IH0pCiAgICAudGhlbih0aGlzLmdldFRhYmxlU3FsKQogICAgLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHZhciBjcmVhdGVUYWJsZSA9IHNxbFswXTsKICAgICAgdmFyIGEgPSB0aGlzLmZvcm1hdHRlci53cmFwKGNvbHVtbikgKyAnICcgKyBjdXJyZW50Q29sLnR5cGUgKyAnLCAnOwogICAgICBpZiAoY3JlYXRlVGFibGUuc3FsLmluZGV4T2YoYSkgPT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZmluZCB0aGUgY29sdW1uIHRvIGNoYW5nZScpOwogICAgICB9CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbih0aGlzLmNyZWF0ZVRlbXBUYWJsZShjcmVhdGVUYWJsZSkpCiAgICAgICAgLnRoZW4odGhpcy5jb3B5RGF0YSkKICAgICAgICAudGhlbih0aGlzLmRyb3BPcmlnaW5hbCkKICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiBjcmVhdGVUYWJsZS5zcWwucmVwbGFjZShhLCAnJyl9KTsKICAgICAgICB9KQogICAgICAgIC50aGVuKHRoaXMucmVpbnNlcnREYXRhKGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgcmV0dXJuIF8ub21pdChyb3csIGNvbHVtbik7CiAgICAgICAgfSkpCiAgICAgICAgLnRoZW4odGhpcy5kcm9wVGVtcFRhYmxlKTsKICAgIH0pCiAgICAudGFwKHRoaXMuY29tbWl0VHJhbnNhY3Rpb24pCiAgICAuY2F0Y2godGhpcy5yb2xsYmFja1RyYW5zYWN0aW9uKTsKfSk7CgpjbGllbnQuU1FMaXRlM19EREwgPSBTUUxpdGUzX0RETDsKCn07Cgp9LHsiLi4vLi4vLi4vcHJvbWlzZSI6MTAzLCJsb2Rhc2giOjEzMH1dLDkwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKICByZXF1aXJlKCcuL2RkbCcpKGNsaWVudCk7CiAgcmVxdWlyZSgnLi9zY2hlbWEnKShjbGllbnQpOwogIHJlcXVpcmUoJy4vdGFibGUnKShjbGllbnQpOwogIHJlcXVpcmUoJy4vY29sdW1uJykoY2xpZW50KTsKfTsKfSx7Ii4vY29sdW1uIjo4OCwiLi9kZGwiOjg5LCIuL3NjaGVtYSI6OTEsIi4vdGFibGUiOjkyfV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBTUUxpdGUzOiBDb2x1bW4gQnVpbGRlciAmIENvbXBpbGVyCi8vIC0tLS0tLS0KbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgU2NoZW1hICAgPSByZXF1aXJlKCcuLi8uLi8uLi9zY2hlbWEnKTsKCi8vIFNjaGVtYSBCdWlsZGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIFNjaGVtYUJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuQnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNjaGVtYUJ1aWxkZXJfU1FMaXRlMywgU2NoZW1hLkJ1aWxkZXIpOwoKLy8gU2NoZW1hIENvbXBpbGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgdGhpcy5Gb3JtYXR0ZXIgPSBjbGllbnQuRm9ybWF0dGVyOwogIFNjaGVtYS5Db21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMsIFNjaGVtYS5Db21waWxlcik7CgovLyBDb21waWxlIHRoZSBxdWVyeSB0byBkZXRlcm1pbmUgaWYgYSB0YWJsZSBleGlzdHMuClNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmhhc1RhYmxlID0gZnVuY3Rpb24odGFibGVOYW1lKSB7CiAgdGhpcy5wdXNoUXVlcnkoewogICAgc3FsOiAic2VsZWN0ICogZnJvbSBzcWxpdGVfbWFzdGVyIHdoZXJlIHR5cGUgPSAndGFibGUnIGFuZCBuYW1lID0gIiArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0YWJsZU5hbWUpLAogICAgb3V0cHV0OiBmdW5jdGlvbihyZXNwKSB7CiAgICAgIHJldHVybiByZXNwLmxlbmd0aCA+IDA7CiAgICB9CiAgfSk7Cn07CgovLyBDb21waWxlIHRoZSBxdWVyeSB0byBkZXRlcm1pbmUgaWYgYSBjb2x1bW4gZXhpc3RzLgpTY2hlbWFDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5oYXNDb2x1bW4gPSBmdW5jdGlvbih0YWJsZU5hbWUsIGNvbHVtbikgewogIHRoaXMucHVzaFF1ZXJ5KHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRhYmxlTmFtZSkgKyAnKScsCiAgICBvdXRwdXQ6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIF8uc29tZShyZXNwLCB7bmFtZTogY29sdW1ufSk7CiAgICB9CiAgfSk7Cn07CgovLyBDb21waWxlIGEgcmVuYW1lIHRhYmxlIGNvbW1hbmQuClNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLnJlbmFtZVRhYmxlID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoZnJvbSkgKyAnIHJlbmFtZSB0byAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcCh0bykpOwp9OwoKY2xpZW50LlNjaGVtYUJ1aWxkZXIgPSBTY2hlbWFCdWlsZGVyX1NRTGl0ZTM7CmNsaWVudC5TY2hlbWFDb21waWxlciA9IFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTM7Cgp9Owp9LHsiLi4vLi4vLi4vc2NoZW1hIjoxMTQsImluaGVyaXRzIjo3NiwibG9kYXNoIjoxMzB9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFNRTGl0ZTM6IENvbHVtbiBCdWlsZGVyICYgQ29tcGlsZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBTY2hlbWEgICA9IHJlcXVpcmUoJy4uLy4uLy4uL3NjaGVtYScpOwoKLy8gVGFibGUgQnVpbGRlcgovLyAtLS0tLS0tCgpmdW5jdGlvbiBUYWJsZUJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuVGFibGVCdWlsZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoVGFibGVCdWlsZGVyX1NRTGl0ZTMsIFNjaGVtYS5UYWJsZUJ1aWxkZXIpOwoKLy8gVGFibGUgQ29tcGlsZXIKLy8gLS0tLS0tLQoKZnVuY3Rpb24gVGFibGVDb21waWxlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIHRoaXMuRm9ybWF0dGVyID0gY2xpZW50LkZvcm1hdHRlcjsKICB0aGlzLlNRTGl0ZTNfRERMID0gY2xpZW50LlNRTGl0ZTNfRERMOwogIHRoaXMucHJpbWFyeUtleSA9IHZvaWQgMDsKICBTY2hlbWEuVGFibGVDb21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFRhYmxlQ29tcGlsZXJfU1FMaXRlMywgU2NoZW1hLlRhYmxlQ29tcGlsZXIpOwoKLy8gQ3JlYXRlIGEgbmV3IHRhYmxlLgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmNyZWF0ZVF1ZXJ5ID0gZnVuY3Rpb24oY29sdW1ucywgaWZOb3QpIHsKICB2YXIgY3JlYXRlU3RhdGVtZW50ID0gaWZOb3QgPyAnY3JlYXRlIHRhYmxlIGlmIG5vdCBleGlzdHMgJyA6ICdjcmVhdGUgdGFibGUgJzsKICB2YXIgc3FsID0gY3JlYXRlU3RhdGVtZW50ICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zLnNxbC5qb2luKCcsICcpOwoKICAvLyBTUUxpdGUgZm9yY2VzIHByaW1hcnkga2V5cyB0byBiZSBhZGRlZCB3aGVuIHRoZSB0YWJsZSBpcyBpbml0aWFsbHkgY3JlYXRlZAogIC8vIHNvIHdlIHdpbGwgbmVlZCB0byBjaGVjayBmb3IgYSBwcmltYXJ5IGtleSBjb21tYW5kcyBhbmQgYWRkIHRoZSBjb2x1bW5zCiAgLy8gdG8gdGhlIHRhYmxlJ3MgZGVjbGFyYXRpb24gaGVyZSBzbyB0aGV5IGNhbiBiZSBjcmVhdGVkIG9uIHRoZSB0YWJsZXMuCiAgc3FsICs9IHRoaXMuZm9yZWlnbktleXMoKSB8fCAnJzsKICBzcWwgKz0gdGhpcy5wcmltYXJ5S2V5cygpIHx8ICcnOwogIHNxbCArPSAnKSc7CgogIHRoaXMucHVzaFF1ZXJ5KHNxbCk7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmFkZENvbHVtbnMgPSBmdW5jdGlvbihjb2x1bW5zKSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBjb2x1bW5zLnNxbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHRoaXMucHVzaFF1ZXJ5KHsKICAgICAgc3FsOiAnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGFkZCBjb2x1bW4gJyArIGNvbHVtbnMuc3FsW2ldLAogICAgICBiaW5kaW5nczogY29sdW1ucy5iaW5kaW5nc1tpXQogICAgfSk7CiAgfQp9OwoKLy8gQ29tcGlsZSBhIGRyb3AgdW5pcXVlIGtleSBjb21tYW5kLgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmRyb3BVbmlxdWUgPSBmdW5jdGlvbihjb2x1bW5zLCBpbmRleE5hbWUpIHsKICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2Ryb3AgaW5kZXggJyArIGluZGV4TmFtZSk7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmRyb3BJbmRleCA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkgewogIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpOwogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIGluZGV4ICcgKyBpbmRleE5hbWUpOwp9OwoKLy8gQ29tcGlsZSBhIHVuaXF1ZSBrZXkgY29tbWFuZC4KVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS51bmlxdWUgPSBmdW5jdGlvbihjb2x1bW5zLCBpbmRleE5hbWUpIHsKICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7CiAgY29sdW1ucyA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKTsKICB0aGlzLnB1c2hRdWVyeSgnY3JlYXRlIHVuaXF1ZSBpbmRleCAnICsgaW5kZXhOYW1lICsgJyBvbiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zICsgJyknKTsKfTsKCi8vIENvbXBpbGUgYSBwbGFpbiBpbmRleCBrZXkgY29tbWFuZC4KVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5pbmRleCA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkgewogIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpOwogIGNvbHVtbnMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2NyZWF0ZSBpbmRleCAnICsgaW5kZXhOYW1lICsgJyBvbiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zICsgJyknKTsKfTsKClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucHJpbWFyeSA9ClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZm9yZWlnbiA9IGZ1bmN0aW9uKCkgewogIGlmICh0aGlzLm1ldGhvZCAhPT0gJ2NyZWF0ZScpIHsKICAgIGNvbnNvbGUud2FybignU1FMaXRlMyBGb3JlaWduICYgUHJpbWFyeSBrZXlzIG1heSBvbmx5IGJlIGFkZGVkIG9uIGNyZWF0ZScpOwogIH0KfTsKClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucHJpbWFyeUtleXMgPSBmdW5jdGlvbigpIHsKICB2YXIgcGtzID0gXy53aGVyZSh0aGlzLmdyb3VwZWQuYWx0ZXJUYWJsZSB8fCBbXSwge21ldGhvZDogJ3ByaW1hcnknfSk7CiAgaWYgKHBrcy5sZW5ndGggPiAwICYmIHBrc1swXS5hcmdzLmxlbmd0aCA+IDApIHsKICAgIHZhciBhcmdzID0gXy5pc0FycmF5KHBrc1swXS5hcmdzWzBdKSA/IHBrc1swXS5hcmdzWzBdIDogcGtzWzBdLmFyZ3M7CiAgICByZXR1cm4gJywgcHJpbWFyeSBrZXkgKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoYXJncykgKyAnKSc7CiAgfQp9OwoKVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5mb3JlaWduS2V5cyA9IGZ1bmN0aW9uKCkgewogIHZhciBzcWwgPSAnJzsKICB2YXIgZm9yZWlnbktleXMgPSBfLndoZXJlKHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdLCB7bWV0aG9kOiAnZm9yZWlnbid9KTsKICBmb3IgKHZhciBpID0gMCwgbCA9IGZvcmVpZ25LZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGZvcmVpZ24gICAgICAgPSBmb3JlaWduS2V5c1tpXS5hcmdzWzBdOwogICAgdmFyIGNvbHVtbiAgICAgICAgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbi5jb2x1bW4pOwogICAgdmFyIHJlZmVyZW5jZXMgICAgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbi5yZWZlcmVuY2VzKTsKICAgIHZhciBmb3JlaWduVGFibGUgID0gdGhpcy5mb3JtYXR0ZXIud3JhcChmb3JlaWduLmluVGFibGUpOwogICAgc3FsICs9ICcsIGZvcmVpZ24ga2V5KCcgKyBjb2x1bW4gKyAnKSByZWZlcmVuY2VzICcgKyBmb3JlaWduVGFibGUgKyAnKCcgKyByZWZlcmVuY2VzICsgJyknOwogICAgaWYgKGZvcmVpZ24ub25EZWxldGUpIHNxbCArPSAnIG9uIGRlbGV0ZSAnICsgZm9yZWlnbi5vbkRlbGV0ZTsKICAgIGlmIChmb3JlaWduLm9uVXBkYXRlKSBzcWwgKz0gJyBvbiB1cGRhdGUgJyArIGZvcmVpZ24ub25VcGRhdGU7CiAgfQogIHJldHVybiBzcWw7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmNyZWF0ZVRhYmxlQmxvY2sgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5nZXRDb2x1bW5zKCkuY29uY2F0KCkuam9pbignLCcpOwp9OwoKLy8gQ29tcGlsZSBhIHJlbmFtZSBjb2x1bW4gY29tbWFuZC4uLiB2ZXJ5IGNvbXBsZXggaW4gc3FsaXRlClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucmVuYW1lQ29sdW1uID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICB2YXIgY29tcGlsZXIgPSB0aGlzOwogIHRoaXMucHVzaFF1ZXJ5KHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyknLAogICAgb3V0cHV0OiBmdW5jdGlvbihwcmFnbWEpIHsKICAgICAgcmV0dXJuIG5ldyBjb21waWxlci5TUUxpdGUzX0RETCh0aGlzLCBjb21waWxlciwgcHJhZ21hKS5yZW5hbWVDb2x1bW4oZnJvbSwgdG8pOwogICAgfQogIH0pOwp9OwoKVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5kcm9wQ29sdW1uID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdmFyIGNvbXBpbGVyID0gdGhpczsKICB0aGlzLnB1c2hRdWVyeSh7CiAgICBzcWw6ICdQUkFHTUEgdGFibGVfaW5mbygnICsgdGhpcy50YWJsZU5hbWUoKSArICcpJywKICAgIG91dHB1dDogZnVuY3Rpb24ocHJhZ21hKSB7CiAgICAgIHJldHVybiBuZXcgY29tcGlsZXIuU1FMaXRlM19EREwodGhpcywgY29tcGlsZXIsIHByYWdtYSkuZHJvcENvbHVtbihjb2x1bW4pOwogICAgfQogIH0pOwp9OwoKY2xpZW50LlRhYmxlQnVpbGRlciA9IFRhYmxlQnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuVGFibGVDb21waWxlciA9IFRhYmxlQ29tcGlsZXJfU1FMaXRlMzsKCn07Cn0seyIuLi8uLi8uLi9zY2hlbWEiOjExNCwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBTZWVkZXIgPSByZXF1aXJlKCcuLi8uLi9zZWVkJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CgovLyBJbmhlcml0IGZyb20gdGhlIGBTZWVkZXJgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLAovLyBzbyB3ZSBjYW4gYWRkIHRoZSBjb3JyZWN0IGB0aGVuYCBtZXRob2QuCmZ1bmN0aW9uIFNlZWRlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFNlZWRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNlZWRlcl9TUUxpdGUzLCBTZWVkZXIpOwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgU2VlZGVyYCBjb25zdHJ1Y3RvciB0byB0aGUgY2xpZW50IG9iamVjdC4KY2xpZW50LlNlZWRlciA9IFNlZWRlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL3NlZWQiOjExNywiaW5oZXJpdHMiOjc2fV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBTUUxpdGUzIFRyYW5zYWN0aW9uCi8vIC0tLS0tLS0KbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zYWN0aW9uJyk7CgpmdW5jdGlvbiBUcmFuc2FjdGlvbl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFRyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoVHJhbnNhY3Rpb25fU1FMaXRlMywgVHJhbnNhY3Rpb24pOwoKY2xpZW50LlRyYW5zYWN0aW9uID0gVHJhbnNhY3Rpb25fU1FMaXRlMzsKCn07Cn0seyIuLi8uLi90cmFuc2FjdGlvbiI6MTE4LCJpbmhlcml0cyI6NzZ9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFdlYlNRTAovLyAtLS0tLS0tCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKdmFyIENsaWVudF9TUUxpdGUzID0gcmVxdWlyZSgnLi4vc3FsaXRlMy9pbmRleCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTsKCmZ1bmN0aW9uIENsaWVudF9XZWJTUUwoY29uZmlnKSB7CiAgY29uZmlnID0gY29uZmlnIHx8IHt9OwogIENsaWVudF9TUUxpdGUzLnN1cGVyXy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmIChjb25maWcuZGVidWcpIHRoaXMuaXNEZWJ1Z2dpbmcgPSB0cnVlOwogIHRoaXMubmFtZSA9IGNvbmZpZy5uYW1lIHx8ICdrbmV4X2RhdGFiYXNlJzsKICB0aGlzLnZlcnNpb24gPSBjb25maWcudmVyc2lvbiB8fCAnMS4wJzsKICB0aGlzLmRpc3BsYXlOYW1lID0gY29uZmlnLmRpc3BsYXlOYW1lIHx8IHRoaXMubmFtZTsKICB0aGlzLmVzdGltYXRlZFNpemUgPSBjb25maWcuZXN0aW1hdGVkU2l6ZSB8fCA1ICogMTAyNCAqIDEwMjQ7CiAgdGhpcy5pbml0RHJpdmVyKCk7CiAgdGhpcy5pbml0UnVubmVyKCk7CiAgdGhpcy50cmFuc2FjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KaW5oZXJpdHMoQ2xpZW50X1dlYlNRTCwgQ2xpZW50X1NRTGl0ZTMpOwoKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuZGlhbGVjdCA9ICd3ZWJzcWwnOwpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5pbml0RHJpdmVyID0gZnVuY3Rpb24oKSB7fTsKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuaW5pdFBvb2wgPSBmdW5jdGlvbigpIHt9OwpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5pbml0TWlncmF0b3IgPSBmdW5jdGlvbigpIHt9OwoKLy8gSW5pdGlhbGl6ZSB0aGUgcXVlcnkgInJ1bm5lciIKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuaW5pdFJ1bm5lciA9IGZ1bmN0aW9uKCkgewogIHJlcXVpcmUoJy4vcnVubmVyJykodGhpcyk7Cn07CgovLyBHZXQgYSByYXcgY29ubmVjdGlvbiBmcm9tIHRoZSBkYXRhYmFzZSwgcmV0dXJuaW5nIGEgcHJvbWlzZSB3aXRoIHRoZSBjb25uZWN0aW9uIG9iamVjdC4KQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuYWNxdWlyZUNvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHsKICB2YXIgY2xpZW50ID0gdGhpczsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICB0cnkgewogICAgICAvKmpzbGludCBicm93c2VyOiB0cnVlKi8KICAgICAgdmFyIGRiID0gb3BlbkRhdGFiYXNlKGNsaWVudC5uYW1lLCBjbGllbnQudmVyc2lvbiwgY2xpZW50LmRpc3BsYXlOYW1lLCBjbGllbnQuZXN0aW1hdGVkU2l6ZSk7CiAgICAgIGRiLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICB0Ll9fY2lkID0gXy51bmlxdWVJZCgnX19jaWQnKTsKICAgICAgICByZXNvbHZlKHQpOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmVqZWN0KGUpOwogICAgfQogIH0pOwp9OwoKLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2wKLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLgpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5yZWxlYXNlQ29ubmVjdGlvbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkge30pOwoKbW9kdWxlLmV4cG9ydHMgPSBDbGllbnRfV2ViU1FMOwp9LHsiLi4vLi4vcHJvbWlzZSI6MTAzLCIuLi9zcWxpdGUzL2luZGV4Ijo4MiwiLi9ydW5uZXIiOjk2LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSdW5uZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFByb21pc2UgID0gcmVxdWlyZSgnLi4vLi4vcHJvbWlzZScpOwoKLy8gUmVxdWlyZSB0aGUgU1FMaXRlMyBSdW5uZXIuCnJlcXVpcmUoJy4uL3NxbGl0ZTMvcnVubmVyJykoY2xpZW50KTsKdmFyIFJ1bm5lcl9TUUxpdGUzID0gY2xpZW50LlJ1bm5lcjsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKLy8gSW5oZXJpdCBmcm9tIHRoZSBgUnVubmVyYCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBSdW5uZXJfV2ViU1FMKCkgewogIFJ1bm5lcl9TUUxpdGUzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoUnVubmVyX1dlYlNRTCwgUnVubmVyX1NRTGl0ZTMpOwoKLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzIGFuZCBhbnkgb3RoZXIgbmVjZXNzYXJ5IHByZXAgd29yay4KUnVubmVyX1dlYlNRTC5wcm90b3R5cGUuX3F1ZXJ5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ob2JqKSB7CiAgaWYgKHRoaXMuaXNEZWJ1Z2dpbmcoKSkgdGhpcy5kZWJ1ZyhvYmopOwogIHZhciBjb25uZWN0aW9uID0gdGhpcy5jb25uZWN0aW9uOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIGlmICghY29ubmVjdGlvbikgewogICAgICByZXR1cm4gcmVqZWN0ZXIobmV3IEVycm9yKCdObyBjb25uZWN0aW9uIHByb3ZpZGVkLicpKTsKICAgIH0KICAgIGNvbm5lY3Rpb24uZXhlY3V0ZVNxbChvYmouc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uKHRyeCwgcmVzcG9uc2UpIHsKICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgIHJldHVybiByZXNvbHZlcihvYmopOwogICAgfSwgZnVuY3Rpb24odHJ4LCBlcnIpIHsKICAgICAgY29uc29sZS5lcnJvcihlcnIpOwogICAgICByZWplY3RlcihlcnIpOwogICAgfSk7CiAgfSk7Cn0pOwoKLy8gTnVsbCBvdXQgdGhlIHRyYW5zYWN0aW9uIHN0YXRlbWVudHMgc28gdGhleSBhcmVuJ3QgcnVuLgpSdW5uZXJfV2ViU1FMLnByb3RvdHlwZS5fYmVnaW5UcmFuc2FjdGlvbiAgICA9IG51bGw7ClJ1bm5lcl9XZWJTUUwucHJvdG90eXBlLl9jb21taXRUcmFuc2FjdGlvbiAgID0gbnVsbDsKUnVubmVyX1dlYlNRTC5wcm90b3R5cGUuX3JvbGxiYWNrVHJhbnNhY3Rpb24gPSBudWxsOwoKLy8gRW5zdXJlcyB0aGUgcmVzcG9uc2UgaXMgcmV0dXJuZWQgaW4gdGhlIHNhbWUgZm9ybWF0IGFzIG90aGVyIGNsaWVudHMuClJ1bm5lcl9XZWJTUUwucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaikgewogIHZhciByZXNwID0gb2JqLnJlc3BvbnNlOwogIGlmIChvYmoub3V0cHV0KSByZXR1cm4gb2JqLm91dHB1dC5jYWxsKHRoaXMsIHJlc3ApOwogIHN3aXRjaCAob2JqLm1ldGhvZCkgewogICAgY2FzZSAncGx1Y2snOgogICAgY2FzZSAnZmlyc3QnOgogICAgY2FzZSAnc2VsZWN0JzoKICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXNwLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcmVzdWx0c1tpXSA9IF8uY2xvbmUocmVzcC5yb3dzLml0ZW0oaSkpOwogICAgICB9CiAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXN1bHRzID0gXy5wbHVjayhyZXN1bHRzLCBvYmoucGx1Y2spOwogICAgICByZXR1cm4gb2JqLm1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3VsdHNbMF0gOiByZXN1bHRzOwogICAgY2FzZSAnaW5zZXJ0JzoKICAgICAgcmV0dXJuIFtyZXNwLmluc2VydElkXTsKICAgIGNhc2UgJ2RlbGV0ZSc6CiAgICBjYXNlICd1cGRhdGUnOgogICAgY2FzZSAnY291bnRlcic6CiAgICAgIHJldHVybiByZXNwLnJvd3NBZmZlY3RlZDsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiByZXNwOwogIH0KfTsKCi8vIEFzc2lnbiB0aGUgbmV3bHkgZXh0ZW5kZWQgYFJ1bm5lcmAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5SdW5uZXIgPSBSdW5uZXJfV2ViU1FMOwoKfTsKfSx7Ii4uLy4uL3Byb21pc2UiOjEwMywiLi4vc3FsaXRlMy9ydW5uZXIiOjg3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBNaXhlZCBpbnRvIHRoZSBxdWVyeSBjb21waWxlciAmIHNjaGVtYSBwaWVjZXMuIEFzc3VtZXMgYSBgZ3JhbW1hcmAKLy8gcHJvcGVydHkgZXhpc3RzIG9uIHRoZSBjdXJyZW50IG9iamVjdC4KdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUXVlcnlCdWlsZGVyID0gcmVxdWlyZSgnLi9xdWVyeS9idWlsZGVyJyk7Cgp2YXIgUmF3ICA9IHJlcXVpcmUoJy4vcmF3Jyk7CnZhciBwdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2g7CgovLyBWYWxpZCB2YWx1ZXMgZm9yIHRoZSBgb3JkZXIgYnlgIGNsYXVzZSBnZW5lcmF0aW9uLgp2YXIgb3JkZXJCeXMgID0gWydhc2MnLCAnZGVzYyddOwoKLy8gQSAiZm9ybWF0dGVyIiBpbnN0YW5jZSBpcyB1c2VkIHRvIGJvdGggZGV0ZXJtaW5lIGhvdyB3cmFwLCBiaW5kLCBhbmQKLy8gcGFyYW1ldGVyaXplIHZhbHVlcyB3aXRoaW4gYSBxdWVyeSwga2VlcGluZyB0cmFjayBvZiBhbGwgYmluZGluZ3MKLy8gYWRkZWQgdG8gdGhlIHF1ZXJ5LiBUaGlzIGFsbG93cyB1cyB0byBlYXNpbHkga2VlcCB0cmFjayBvZiByYXcgc3RhdGVtZW50cwovLyBhcmJpdHJhcmlseSBhZGRlZCB0byBxdWVyaWVzLgpmdW5jdGlvbiBGb3JtYXR0ZXIoKSB7CiAgdGhpcy5iaW5kaW5ncyA9IFtdOwp9CgovLyBUdXJucyBhIGxpc3Qgb2YgdmFsdWVzIGludG8gYSBsaXN0IG9mID8ncywgam9pbmluZyB0aGVtIHdpdGggY29tbWFzIHVubGVzcwovLyBhICJqb2luaW5nIiB2YWx1ZSBpcyBzcGVjaWZpZWQgKGUuZy4gJyBhbmQgJykKRm9ybWF0dGVyLnByb3RvdHlwZS5wYXJhbWV0ZXJpemUgPSBmdW5jdGlvbih2YWx1ZXMpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlcykpIHJldHVybiB0aGlzLnBhcmFtZXRlcih2YWx1ZXMpOwogIHZhbHVlcyA9IF8uaXNBcnJheSh2YWx1ZXMpID8gdmFsdWVzIDogW3ZhbHVlc107CiAgcmV0dXJuIF8ubWFwKHZhbHVlcywgdGhpcy5wYXJhbWV0ZXIsIHRoaXMpLmpvaW4oJywgJyk7Cn07CgovLyBDaGVja3Mgd2hldGhlciBhIHZhbHVlIGlzIGEgZnVuY3Rpb24uLi4gaWYgaXQgaXMsIHdlIGNvbXBpbGUgaXQKLy8gb3RoZXJ3aXNlIHdlIGNoZWNrIHdoZXRoZXIgaXQncyBhIHJhdwpGb3JtYXR0ZXIucHJvdG90eXBlLnBhcmFtZXRlciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlKSwgdHJ1ZSk7CiAgfQogIHJldHVybiB0aGlzLmNoZWNrUmF3KHZhbHVlLCB0cnVlKSB8fCAnPyc7Cn07CgpGb3JtYXR0ZXIucHJvdG90eXBlLmNoZWNrUmF3ID0gZnVuY3Rpb24odmFsdWUsIHBhcmFtZXRlcikgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFF1ZXJ5QnVpbGRlcikgewogICAgdmFyIHF1ZXJ5ID0gdmFsdWUudG9TUUwoKTsKICAgIGlmIChxdWVyeS5iaW5kaW5ncykgcHVzaC5hcHBseSh0aGlzLmJpbmRpbmdzLCBxdWVyeS5iaW5kaW5ncyk7CiAgICByZXR1cm4gdGhpcy5vdXRwdXRRdWVyeShxdWVyeSk7CiAgfQogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJhdykgewogICAgaWYgKHZhbHVlLmJpbmRpbmdzKSBwdXNoLmFwcGx5KHRoaXMuYmluZGluZ3MsIHZhbHVlLmJpbmRpbmdzKTsKICAgIHJldHVybiB2YWx1ZS5zcWw7CiAgfQogIGlmIChwYXJhbWV0ZXIpIHRoaXMuYmluZGluZ3MucHVzaCh2YWx1ZSk7Cn07CgpGb3JtYXR0ZXIucHJvdG90eXBlLnJhd09yRm4gPSBmdW5jdGlvbih2YWx1ZSwgbWV0aG9kKSB7CiAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlLCBtZXRob2QpKTsKICB9CiAgcmV0dXJuIHRoaXMuY2hlY2tSYXcodmFsdWUpIHx8ICcnOwp9OwoKLy8gUHV0cyB0aGUgYXBwcm9wcmlhdGUgd3JhcHBlciBhcm91bmQgYSB2YWx1ZSBkZXBlbmRpbmcgb24gdGhlIGRhdGFiYXNlCi8vIGVuZ2luZSwgdW5sZXNzIGl0J3MgYSBrbmV4LnJhdyB2YWx1ZSwgaW4gd2hpY2ggY2FzZSBpdCdzIGxlZnQgYWxvbmUuCkZvcm1hdHRlci5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgdmFyIHJhdzsKICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgcmV0dXJuIHRoaXMub3V0cHV0UXVlcnkodGhpcy5jb21waWxlQ2FsbGJhY2sodmFsdWUpLCB0cnVlKTsKICB9CiAgcmF3ID0gdGhpcy5jaGVja1Jhdyh2YWx1ZSk7CiAgaWYgKHJhdykgcmV0dXJuIHJhdzsKICBpZiAoXy5pc051bWJlcih2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICByZXR1cm4gdGhpcy5fd3JhcCh2YWx1ZSArICcnKTsKfTsKCi8vIENvZXJjZSB0byBzdHJpbmcgdG8gcHJldmVudCBzdHJhbmdlIGVycm9ycyB3aGVuIGl0J3Mgbm90IGEgc3RyaW5nLgpGb3JtYXR0ZXIucHJvdG90eXBlLl93cmFwU3RyaW5nID0gZnVuY3Rpb24odmFsdWUpIHsKICB2YXIgc2VnbWVudHMsIGFzSW5kZXggPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJyBhcyAnKTsKICBpZiAoYXNJbmRleCAhPT0gLTEpIHsKICAgIHZhciBmaXJzdCAgPSB2YWx1ZS5zbGljZSgwLCBhc0luZGV4KTsKICAgIHZhciBzZWNvbmQgPSB2YWx1ZS5zbGljZShhc0luZGV4ICsgNCk7CiAgICByZXR1cm4gdGhpcy53cmFwKGZpcnN0KSArICcgYXMgJyArIHRoaXMud3JhcChzZWNvbmQpOwogIH0KICB2YXIgd3JhcHBlZCA9IFtdOwogIHNlZ21lbnRzID0gdmFsdWUuc3BsaXQoJy4nKTsKICBmb3IgKHZhciBpID0gMCwgbCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkgPSArK2kpIHsKICAgIHZhbHVlID0gc2VnbWVudHNbaV07CiAgICBpZiAoaSA9PT0gMCAmJiBzZWdtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIHdyYXBwZWQucHVzaCh0aGlzLndyYXAoKHZhbHVlIHx8ICcnKS50cmltKCkpKTsKICAgIH0gZWxzZSB7CiAgICAgIHdyYXBwZWQucHVzaCh0aGlzLndyYXBWYWx1ZSgodmFsdWUgfHwgJycpLnRyaW0oKSkpOwogICAgfQogIH0KICByZXR1cm4gd3JhcHBlZC5qb2luKCcuJyk7Cn07CgovLyBBY2NlcHRzIGEgc3RyaW5nIG9yIGFycmF5IG9mIGNvbHVtbnMgdG8gd3JhcCBhcyBhcHByb3ByaWF0ZS4KRm9ybWF0dGVyLnByb3RvdHlwZS5jb2x1bW5pemUgPSBmdW5jdGlvbih0YXJnZXQpIHsKICB2YXIgY29sdW1ucyA9IChfLmlzU3RyaW5nKHRhcmdldCkgPyBbdGFyZ2V0XSA6IHRhcmdldCk7CiAgcmV0dXJuIF8ubWFwKGNvbHVtbnMsIHRoaXMud3JhcCwgdGhpcykuam9pbignLCAnKTsKfTsKCi8vIFRoZSBvcGVyYXRvciBtZXRob2QgdGFrZXMgYSB2YWx1ZSBhbmQgcmV0dXJucyBzb21ldGhpbmcgb3Igb3RoZXIuCkZvcm1hdHRlci5wcm90b3R5cGUub3BlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogIHZhciByYXcgPSB0aGlzLmNoZWNrUmF3KHZhbHVlKTsKICBpZiAocmF3KSByZXR1cm4gcmF3OwogIGlmICghXy5jb250YWlucyh0aGlzLm9wZXJhdG9ycywgKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIG9wZXJhdG9yICInICsgdmFsdWUgKyAnIiBpcyBub3QgcGVybWl0dGVkJyk7CiAgfQogIHJldHVybiB2YWx1ZTsKfTsKCi8vIFNwZWNpZnkgdGhlIGRpcmVjdGlvbiBvZiB0aGUgb3JkZXJpbmcuCkZvcm1hdHRlci5wcm90b3R5cGUuZGlyZWN0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICB2YXIgcmF3ID0gdGhpcy5jaGVja1Jhdyh2YWx1ZSk7CiAgaWYgKHJhdykgcmV0dXJuIHJhdzsKICByZXR1cm4gXy5jb250YWlucyhvcmRlckJ5cywgKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSA/IHZhbHVlIDogJ2FzYyc7Cn07CgovLyBDb21waWxlcyBhIGNhbGxiYWNrIHVzaW5nIHRoZSBxdWVyeSBidWlsZGVyLgpGb3JtYXR0ZXIucHJvdG90eXBlLmNvbXBpbGVDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBtZXRob2QpIHsKICB2YXIgY2xpZW50ID0gdGhpcy5jbGllbnQ7CgogIC8vIEJ1aWxkIHRoZSBjYWxsYmFjawogIHZhciBidWlsZGVyICA9IG5ldyBjbGllbnQuUXVlcnlCdWlsZGVyKCk7CiAgY2FsbGJhY2suY2FsbChidWlsZGVyLCBidWlsZGVyKTsKCiAgLy8gQ29tcGlsZSB0aGUgY2FsbGJhY2ssIHVzaW5nIHRoZSBjdXJyZW50IGZvcm1hdHRlciAodG8gdHJhY2sgYWxsIGJpbmRpbmdzKS4KICB2YXIgY29tcGlsZXIgPSBuZXcgY2xpZW50LlF1ZXJ5Q29tcGlsZXIoYnVpbGRlcik7CiAgY29tcGlsZXIuZm9ybWF0dGVyID0gdGhpczsKCiAgLy8gUmV0dXJuIHRoZSBjb21waWxlZCAmIHBhcmFtZXRlcml6ZWQgc3FsLgogIHJldHVybiBjb21waWxlci50b1NRTChtZXRob2QgfHwgJ3NlbGVjdCcpOwp9OwoKLy8gRW5zdXJlcyB0aGUgcXVlcnkgaXMgYWxpYXNlZCBpZiBuZWNlc3NhcnkuCkZvcm1hdHRlci5wcm90b3R5cGUub3V0cHV0UXVlcnkgPSBmdW5jdGlvbihjb21waWxlZCwgYWx3YXlzV3JhcHBlZCkgewogIHZhciBzcWwgPSBjb21waWxlZC5zcWwgfHwgJyc7CiAgaWYgKHNxbCkgewogICAgaWYgKGNvbXBpbGVkLm1ldGhvZCA9PT0gJ3NlbGVjdCcgJiYgYWx3YXlzV3JhcHBlZCB8fCBjb21waWxlZC5hcykgewogICAgICBzcWwgPSAnKCcgKyBzcWwgKyAnKSc7CiAgICAgIGlmIChjb21waWxlZC5hcykgc3FsICs9ICcgYXMgJyArIHRoaXMud3JhcChjb21waWxlZC5hcyk7CiAgICB9CiAgfQogIHJldHVybiBzcWw7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IEZvcm1hdHRlcjsKfSx7Ii4vcXVlcnkvYnVpbGRlciI6MTA0LCIuL3JhdyI6MTA4LCJsb2Rhc2giOjEzMH1dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gRnVuY3Rpb25IZWxwZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IHsKCiAgbm93OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jbGllbnQuUmF3KCdDVVJSRU5UX1RJTUVTVEFNUCcpOwogIH0KCn07Cn0se31dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gaGVscGVycy5qcwovLyAtLS0tLS0tCgovLyBKdXN0IHNvbWUgY29tbW9uIGZ1bmN0aW9ucyBuZWVkZWQgaW4gbXVsdGlwbGUgcGxhY2VzIHdpdGhpbiB0aGUgbGlicmFyeS4KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKCnZhciBoZWxwZXJzID0gewoKICAvLyBQaWNrIG9mZiB0aGUgYXR0cmlidXRlcyBmcm9tIG9ubHkgdGhlIGN1cnJlbnQgbGF5ZXIgb2YgdGhlIG9iamVjdC4KICBza2ltOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy5tYXAoZGF0YSwgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBfLnBpY2sob2JqLCBfLmtleXMob2JqKSk7CiAgICB9KTsKICB9LAoKICAvLyBDaGVjayBpZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYW4gYXJyYXksIG90aGVyd2lzZQogIC8vIHVzZXMgYWxsIGFyZ3VtZW50cyBhcyBhbiBhcnJheS4KICBub3JtYWxpemVBcnI6IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgIH0KICAgIGlmIChfLmlzQXJyYXkoYXJnc1swXSkpIHsKICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICB9CiAgICByZXR1cm4gYXJnczsKICB9LAoKICAvLyBVc2VkIHRvIHNpZ25pZnkgZGVwcmVjYXRlZCBmdW5jdGlvbmFsaXR5LgogIGRlcHJlY2F0ZTogZnVuY3Rpb24obXNnKSB7CiAgICB0aGlzLndhcm4obXNnKTsKICB9LAoKICAvLyBVc2VkIHRvIHdhcm4gYWJvdXQgaW5jb3JyZWN0IHVzZSwgd2l0aG91dCBlcnJvcidpbmcKICB3YXJuOiBmdW5jdGlvbihtc2cpIHsKICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCAmJgogICAgICB0eXBlb2YgY29uc29sZS53YXJuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNvbnNvbGUud2FybigiS25leDogIiArIG1zZyk7CiAgICB9CiAgfSwKCiAgLy8gU29ydCB0aGUga2V5cyBmb3IgdGhlIGluc2VydAogIHNvcnRPYmplY3Q6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uc29ydEJ5KF8ucGFpcnMob2JqKSwgZnVuY3Rpb24oYSkgewogICAgICByZXR1cm4gYVswXTsKICAgIH0pOwogIH0KCn07Cgptb2R1bGUuZXhwb3J0cyA9IGhlbHBlcnM7Cn0seyJsb2Rhc2giOjEzMH1dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oVGFyZ2V0KSB7CnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBTcWxTdHJpbmcgPSByZXF1aXJlKCcuL2RpYWxlY3RzL215c3FsL3N0cmluZycpOwoKVGFyZ2V0LnByb3RvdHlwZS50b1F1ZXJ5ID0gZnVuY3Rpb24odHopIHsKICB2YXIgZGF0YSA9IHRoaXMudG9TUUwodGhpcy5fbWV0aG9kKTsKICBpZiAodGhpcy5fZXJyb3JzICYmIHRoaXMuX2Vycm9ycy5sZW5ndGggPiAwKSB0aHJvdyB0aGlzLl9lcnJvcnNbMF07CiAgaWYgKCFfLmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBbZGF0YV07CiAgcmV0dXJuIF8ubWFwKGRhdGEsIGZ1bmN0aW9uKHN0YXRlbWVudCkgewogICAgcmV0dXJuIHRoaXMuX2Zvcm1hdFF1ZXJ5KHN0YXRlbWVudC5zcWwsIHN0YXRlbWVudC5iaW5kaW5ncywgdHopOwogIH0sIHRoaXMpLmpvaW4oJztcbicpOwp9OwoKLy8gRm9ybWF0IHRoZSBxdWVyeSBhcyBzcWwsIHByZXBwaW5nIGJpbmRpbmdzIGFzIG5lY2Vzc2FyeS4KVGFyZ2V0LnByb3RvdHlwZS5fZm9ybWF0UXVlcnkgPSBmdW5jdGlvbihzcWwsIGJpbmRpbmdzLCB0eikgewogIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5wcmVwQmluZGluZ3MpIHsKICAgIGJpbmRpbmdzID0gdGhpcy5jbGllbnQucHJlcEJpbmRpbmdzKGJpbmRpbmdzLCB0eik7CiAgfQogIHJldHVybiBTcWxTdHJpbmcuZm9ybWF0KHNxbCwgYmluZGluZ3MsIHRydWUsIHR6KTsKfTsKCi8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgYFJ1bm5lcmAsIHBhc3NpbmcgaW4gdGhlIGN1cnJlbnQgb2JqZWN0LgpUYXJnZXQucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkgewogIHZhciBSdW5uZXIgPSB0aGlzLmNsaWVudC5SdW5uZXI7CiAgcmV0dXJuIG5ldyBSdW5uZXIodGhpcykucnVuKCkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCk7Cn07CgovLyBBZGQgYWRkaXRpb25hbCAib3B0aW9ucyIgdG8gdGhlIGJ1aWxkZXIuIFR5cGljYWxseSB1c2VkIGZvciBjbGllbnQgc3BlY2lmaWMKLy8gaXRlbXMsIGxpa2UgdGhlIGBteXNxbGAgYW5kIGBzcWxpdGUzYCBkcml2ZXJzLgpUYXJnZXQucHJvdG90eXBlLm9wdGlvbnMgPSBmdW5jdGlvbihvcHRzKSB7CiAgdGhpcy5fb3B0aW9ucyA9IHRoaXMuX29wdGlvbnMgfHwgW107CiAgdGhpcy5fb3B0aW9ucy5wdXNoKF8uY2xvbmUob3B0cykgfHwge30pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU2V0cyBhbiBleHBsaWNpdCAiY29ubm5lY3Rpb24iIHdlIHdpc2ggdG8gdXNlIGZvciB0aGlzIHF1ZXJ5LgpUYXJnZXQucHJvdG90eXBlLmNvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXQgYSBkZWJ1ZyBmbGFnIGZvciB0aGUgY3VycmVudCBzY2hlbWEgcXVlcnkgc3RhY2suClRhcmdldC5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbih2YWwpIHsKICB0aGlzLl9kZWJ1ZyA9ICh2YWwgPT09IHVuZGVmaW5lZCB8fCB2YWwgPT09IG51bGwpID8gdHJ1ZSA6IHZhbDsKICByZXR1cm4gdGhpczsKfTsKCi8vIFNldCB0aGUgdHJhbnNhY3Rpb24gb2JqZWN0IGZvciB0aGlzIHF1ZXJ5LgpUYXJnZXQucHJvdG90eXBlLnRyYW5zYWN0aW5nID0gZnVuY3Rpb24odCkgewogIHRoaXMuX3RyYW5zYWN0aW5nID0gdDsKICByZXR1cm4gdGhpczsKfTsKCi8vIEluaXRpYWxpemVzIGEgc3RyZWFtLgpUYXJnZXQucHJvdG90eXBlLnN0cmVhbSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgUnVubmVyID0gdGhpcy5jbGllbnQuUnVubmVyOwogIHJldHVybiBuZXcgUnVubmVyKHRoaXMpLnN0cmVhbShvcHRpb25zKTsKfTsKCi8vIEluaXRpYWxpemUgYSBzdHJlYW0gJiBwaXBlIGF1dG9tYXRpY2FsbHkuClRhcmdldC5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKHdyaXRhYmxlKSB7CiAgdmFyIFJ1bm5lciA9IHRoaXMuY2xpZW50LlJ1bm5lcjsKICByZXR1cm4gbmV3IFJ1bm5lcih0aGlzKS5waXBlKHdyaXRhYmxlKTsKfTsKCi8vIENyZWF0ZXMgYSBtZXRob2Qgd2hpY2ggImNvZXJjZXMiIHRvIGEgcHJvbWlzZSwgYnkgY2FsbGluZyBhCi8vICJ0aGVuIiBtZXRob2Qgb24gdGhlIGN1cnJlbnQgYFRhcmdldGAKXy5lYWNoKFsnYmluZCcsICdjYXRjaCcsICdzcHJlYWQnLCAnb3RoZXJ3aXNlJywgJ21hcCcsICdyZWR1Y2UnLCAndGFwJywgJ3RoZW5SZXR1cm4nLAogICdyZXR1cm4nLCAneWllbGQnLCAnZW5zdXJlJywgJ25vZGVpZnknLCAnZXhlYyddLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYXJnZXQucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgIHZhciB0aGVuID0gdGhpcy50aGVuKCk7CiAgICByZXR1cm4gdGhlblttZXRob2RdLmFwcGx5KHRoZW4sIGFyZ3VtZW50cyk7CiAgfTsKfSk7Cgp9Owp9LHsiLi9kaWFsZWN0cy9teXNxbC9zdHJpbmciOjc5LCJsb2Rhc2giOjEzMH1dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2VzcyxfX2Rpcm5hbWUpewovLyBNaWdyYXRvcgovLyAtLS0tLS0tCiJ1c2Ugc3RyaWN0IjsKCnZhciBmcyAgICAgICA9IHJlcXVpcmUoJ2ZzJyk7CnZhciBwYXRoICAgICA9IHJlcXVpcmUoJ3BhdGgnKTsKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBta2RpcnAgICA9IHJlcXVpcmUoJ21rZGlycCcpOwp2YXIgUHJvbWlzZSAgPSByZXF1aXJlKCcuLi9wcm9taXNlJyk7CgovLyBWYWxpZGF0ZXMgdGhhdCBtaWdyYXRpb25zIGFyZSBwcmVzZW50IGluIHRoZSBhcHByb3ByaWF0ZSBkaXJlY3Rvcmllcy4KZnVuY3Rpb24gdmFsaWRhdGVNaWdyYXRpb25MaXN0KGFsbCwgY29tcGxldGVkKSB7CiAgdmFyIGRpZmYgPSBfLmRpZmZlcmVuY2UoY29tcGxldGVkLCBhbGwpOwogIGlmICghXy5pc0VtcHR5KGRpZmYpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdUaGUgbWlncmF0aW9uIGRpcmVjdG9yeSBpcyBjb3JydXB0LCB0aGUgZm9sbG93aW5nIGZpbGVzIGFyZSBtaXNzaW5nOiAnICsgZGlmZi5qb2luKCcsICcpCiAgICApOwogIH0KfQoKLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSAyIHBsYWNlcyBmb3IgZWFjaCBvZiB0aGUgZGF0ZSBzZWdtZW50cwp2YXIgcGFkRGF0ZSA9IGZ1bmN0aW9uKHNlZ21lbnQpIHsKICBzZWdtZW50ID0gc2VnbWVudC50b1N0cmluZygpOwogIHJldHVybiBzZWdtZW50WzFdID8gc2VnbWVudCA6ICcwJyArIHNlZ21lbnQ7Cn07CgovLyBHZXQgYSBkYXRlIG9iamVjdCBpbiB0aGUgY29ycmVjdCBmb3JtYXQsIHdpdGhvdXQgcmVxdWlyaW5nCi8vIGEgZnVsbCBvdXQgbGlicmFyeSBsaWtlICJtb21lbnQuanMiLgp2YXIgeXl5eW1tZGRoaG1tc3MgPSBmdW5jdGlvbigpIHsKICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgcmV0dXJuIGQuZ2V0RnVsbFllYXIoKS50b1N0cmluZygpICsKICAgICAgcGFkRGF0ZShkLmdldE1vbnRoKCkgKyAxKSArCiAgICAgIHBhZERhdGUoZC5nZXREYXRlKCkpICsKICAgICAgcGFkRGF0ZShkLmdldEhvdXJzKCkpICsKICAgICAgcGFkRGF0ZShkLmdldE1pbnV0ZXMoKSkgKwogICAgICBwYWREYXRlKGQuZ2V0U2Vjb25kcygpKTsKfTsKCi8vIFRoZSBuZXcgbWlncmF0aW9uIHdlJ3JlIHBlcmZvcm1pbmcsIHR5cGljYWxseSBjYWxsZWQgZnJvbSB0aGUgYGtuZXgubWlncmF0ZWAKLy8gaW50ZXJmYWNlIG9uIHRoZSBtYWluIGBrbmV4YCBvYmplY3QuIFBhc3NlcyB0aGUgYGtuZXhgIGluc3RhbmNlIHBlcmZvcm1pbmcKLy8gdGhlIG1pZ3JhdGlvbi4KZnVuY3Rpb24gTWlncmF0b3Ioa25leCkgewogIHRoaXMua25leCAgID0ga25leDsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGtuZXguY2xpZW50Lm1pZ3JhdGlvbkNvbmZpZyk7Cn0KCi8vIE1pZ3JhdG9ycyB0byB0aGUgbGF0ZXN0IGNvbmZpZ3VyYXRpb24uCk1pZ3JhdG9yLnByb3RvdHlwZS5sYXRlc3QgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgcmV0dXJuIHRoaXMuX21pZ3JhdGlvbkRhdGEoKQogICAgLnRhcCh2YWxpZGF0ZU1pZ3JhdGlvbkxpc3QpCiAgICAuYmluZCh0aGlzKQogICAgLnNwcmVhZChmdW5jdGlvbihhbGwsIGNvbXBsZXRlZCkgewogICAgICByZXR1cm4gdGhpcy5fcnVuQmF0Y2goXy5kaWZmZXJlbmNlKGFsbCwgY29tcGxldGVkKSwgJ3VwJyk7CiAgICB9KTsKfSk7CgovLyBSb2xsYmFjayB0aGUgbGFzdCAiYmF0Y2giIG9mIG1pZ3JhdGlvbnMgdGhhdCB3ZXJlIHJ1bi4KTWlncmF0b3IucHJvdG90eXBlLnJvbGxiYWNrID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIHJldHVybiB0aGlzLl9taWdyYXRpb25EYXRhKCkKICAgIC50YXAodmFsaWRhdGVNaWdyYXRpb25MaXN0KQogICAgLmJpbmQodGhpcykKICAgIC50aGVuKHRoaXMuX2dldExhc3RCYXRjaCkKICAgIC50aGVuKGZ1bmN0aW9uKG1pZ3JhdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3J1bkJhdGNoKF8ucGx1Y2sobWlncmF0aW9ucywgJ25hbWUnKSwgJ2Rvd24nKTsKICAgIH0pOwp9KTsKCi8vIFJldHJpZXZlcyBhbmQgcmV0dXJucyB0aGUgY3VycmVudCBtaWdyYXRpb24gdmVyc2lvbgovLyB3ZSdyZSBvbiwgYXMgYSBwcm9taXNlLiBJZiB0aGVyZSBhcmVuJ3QgYW55IG1pZ3JhdGlvbnMgcnVuIHlldCwKLy8gcmV0dXJuICJub25lIiBhcyB0aGUgdmFsdWUgZm9yIHRoZSBgY3VycmVudFZlcnNpb25gLgpNaWdyYXRvci5wcm90b3R5cGUuY3VycmVudFZlcnNpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgcmV0dXJuIHRoaXMuX2xpc3RDb21wbGV0ZWQoY29uZmlnKS50aGVuKGZ1bmN0aW9uKGNvbXBsZXRlZCkgewogICAgdmFyIHZhbCA9IF8uY2hhaW4oY29tcGxldGVkKS5tYXAoZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnNwbGl0KCdfJylbMF07CiAgICB9KS5tYXgoKS52YWx1ZSgpOwogICAgcmV0dXJuICh2YWwgPT09IC1JbmZpbml0eSA/ICdub25lJyA6IHZhbCk7CiAgfSk7Cn07CgovLyBDcmVhdGVzIGEgbmV3IG1pZ3JhdGlvbiwgd2l0aCBhIGdpdmVuIG5hbWUuCk1pZ3JhdG9yLnByb3RvdHlwZS5tYWtlID0gZnVuY3Rpb24obmFtZSwgY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIGlmICghbmFtZSkgUHJvbWlzZS5yZWplY3RlZChuZXcgRXJyb3IoJ0EgbmFtZSBtdXN0IGJlIHNwZWNpZmllZCBmb3IgdGhlIGdlbmVyYXRlZCBtaWdyYXRpb24nKSk7CiAgcmV0dXJuIHRoaXMuX2Vuc3VyZUZvbGRlcihjb25maWcpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4odGhpcy5fZ2VuZXJhdGVTdHViVGVtcGxhdGUpCiAgICAudGhlbih0aGlzLl93cml0ZU5ld01pZ3JhdGlvbihuYW1lKSk7Cn07CgovLyBMaXN0cyBhbGwgYXZhaWxhYmxlIG1pZ3JhdGlvbiB2ZXJzaW9ucywgYXMgYSBzb3J0ZWQgYXJyYXkuCk1pZ3JhdG9yLnByb3RvdHlwZS5fbGlzdEFsbCA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbmZpZykgewogIHRoaXMuY29uZmlnID0gdGhpcy5zZXRDb25maWcoY29uZmlnKTsKICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMucmVhZGRpciwgZnMpKHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCkpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24obWlncmF0aW9ucykgewogICAgICByZXR1cm4gXy5maWx0ZXIobWlncmF0aW9ucywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgZXh0ZW5zaW9uID0gcGF0aC5leHRuYW1lKHZhbHVlKTsKICAgICAgICByZXR1cm4gXy5jb250YWlucyhbJy5jbycsICcuY29mZmVlJywgJy5pY2VkJywgJy5qcycsICcubGl0Y29mZmVlJywgJy5scyddLCBleHRlbnNpb24pOwogICAgICB9KS5zb3J0KCk7CiAgICB9KTsKfSk7CgovLyBFbnN1cmVzIGEgZm9sZGVyIGZvciB0aGUgbWlncmF0aW9ucyBleGlzdCwgZGVwZW5kZW50IG9uIHRoZQovLyBtaWdyYXRpb24gY29uZmlnIHNldHRpbmdzLgpNaWdyYXRvci5wcm90b3R5cGUuX2Vuc3VyZUZvbGRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBkaXIgPSB0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5zdGF0LCBmcykoZGlyKQogICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkobWtkaXJwKShkaXIpOwogICAgfSk7Cn07CgovLyBFbnN1cmVzIHRoYXQgdGhlIHByb3BlciB0YWJsZSBoYXMgYmVlbiBjcmVhdGVkLAovLyBkZXBlbmRlbnQgb24gdGhlIG1pZ3JhdGlvbiBjb25maWcgc2V0dGluZ3MuCk1pZ3JhdG9yLnByb3RvdHlwZS5fZW5zdXJlVGFibGUgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgdGFibGUgPSB0aGlzLmNvbmZpZy50YWJsZU5hbWU7CiAgcmV0dXJuIHRoaXMua25leC5zY2hlbWEuaGFzVGFibGUodGFibGUpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24oZXhpc3RzKSB7CiAgICAgIGlmICghZXhpc3RzKSByZXR1cm4gdGhpcy5fY3JlYXRlTWlncmF0aW9uVGFibGUodGFibGUpOwogICAgfSk7Cn0pOwoKLy8gQ3JlYXRlIHRoZSBtaWdyYXRpb24gdGFibGUsIGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC4KTWlncmF0b3IucHJvdG90eXBlLl9jcmVhdGVNaWdyYXRpb25UYWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHJldHVybiB0aGlzLmtuZXguc2NoZW1hLmNyZWF0ZVRhYmxlKHRhYmxlTmFtZSwgZnVuY3Rpb24odCkgewogICAgdC5pbmNyZW1lbnRzKCk7CiAgICB0LnN0cmluZygnbmFtZScpOwogICAgdC5pbnRlZ2VyKCdiYXRjaCcpOwogICAgdC50aW1lc3RhbXAoJ21pZ3JhdGlvbl90aW1lJyk7CiAgfSk7Cn07CgovLyBSdW4gYSBiYXRjaCBvZiBjdXJyZW50IG1pZ3JhdGlvbnMsIGluIHNlcXVlbmNlLgpNaWdyYXRvci5wcm90b3R5cGUuX3J1bkJhdGNoID0gZnVuY3Rpb24obWlncmF0aW9ucywgZGlyZWN0aW9uKSB7CiAgcmV0dXJuIFByb21pc2UuYWxsKF8ubWFwKG1pZ3JhdGlvbnMsIHRoaXMuX3ZhbGlkYXRlTWlncmF0aW9uU3RydWN0dXJlLCB0aGlzKSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbihtaWdyYXRpb25zKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbih0aGlzLl9sYXRlc3RCYXRjaE51bWJlcikKICAgICAgICAudGhlbihmdW5jdGlvbihiYXRjaE5vKSB7CiAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndXAnKSBiYXRjaE5vKys7CiAgICAgICAgICByZXR1cm4gYmF0Y2hObzsKICAgICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKGJhdGNoTm8pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl93YXRlcmZhbGxCYXRjaChiYXRjaE5vLCBtaWdyYXRpb25zLCBkaXJlY3Rpb24pOwogICAgICAgIH0pOwogICAgfSk7Cn07CgovLyBWYWxpZGF0ZXMgc29tZSBtaWdyYXRpb25zIGJ5IHJlcXVpcmluZyBhbmQgY2hlY2tpbmcgZm9yIGFuIGB1cGAgYW5kIGBkb3duYCBmdW5jdGlvbi4KTWlncmF0b3IucHJvdG90eXBlLl92YWxpZGF0ZU1pZ3JhdGlvblN0cnVjdHVyZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgbWlncmF0aW9uID0gcmVxdWlyZShwYXRoLmpvaW4odGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKSwgbmFtZSkpOwogIGlmICghXy5pc0Z1bmN0aW9uKG1pZ3JhdGlvbi51cCkgfHwgIV8uaXNGdW5jdGlvbihtaWdyYXRpb24uZG93bikpIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtaWdyYXRpb246ICcgKyBuYW1lICsgJyBtdXN0IGhhdmUgYm90aCBhbiB1cCBhbmQgZG93biBmdW5jdGlvbicpOwogIH0KICByZXR1cm4gbmFtZTsKfTsKCi8vIExpc3RzIGFsbCBtaWdyYXRpb25zIHRoYXQgaGF2ZSBiZWVuIGNvbXBsZXRlZCBmb3IgdGhlIGN1cnJlbnQgZGIsIGFzIGFuIGFycmF5LgpNaWdyYXRvci5wcm90b3R5cGUuX2xpc3RDb21wbGV0ZWQgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgdGFibGVOYW1lID0gdGhpcy5jb25maWcudGFibGVOYW1lOwogIHJldHVybiB0aGlzLl9lbnN1cmVUYWJsZSh0YWJsZU5hbWUpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5rbmV4KHRhYmxlTmFtZSkub3JkZXJCeSgnaWQnKS5zZWxlY3QoJ25hbWUnKTsKICAgIH0pCiAgICAudGhlbihmdW5jdGlvbihtaWdyYXRpb25zKSB7CiAgICAgIHJldHVybiBfLnBsdWNrKG1pZ3JhdGlvbnMsICduYW1lJyk7CiAgICB9KTsKfSk7CgovLyBHZXRzIHRoZSBtaWdyYXRpb24gbGlzdCBmcm9tIHRoZSBzcGVjaWZpZWQgbWlncmF0aW9uIGRpcmVjdG9yeSwKLy8gYXMgd2VsbCBhcyB0aGUgbGlzdCBvZiBjb21wbGV0ZWQgbWlncmF0aW9ucyB0byBjaGVjayB3aGF0Ci8vIHNob3VsZCBiZSBydW4uCk1pZ3JhdG9yLnByb3RvdHlwZS5fbWlncmF0aW9uRGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBQcm9taXNlLmFsbChbCiAgICB0aGlzLl9saXN0QWxsKCksCiAgICB0aGlzLl9saXN0Q29tcGxldGVkKCkKICBdKTsKfTsKCi8vIEdlbmVyYXRlcyB0aGUgc3R1YiB0ZW1wbGF0ZSBmb3IgdGhlIGN1cnJlbnQgbWlncmF0aW9uLCByZXR1cm5pbmcgYSBjb21waWxlZCB0ZW1wbGF0ZS4KTWlncmF0b3IucHJvdG90eXBlLl9nZW5lcmF0ZVN0dWJUZW1wbGF0ZSA9IGZ1bmN0aW9uKCkgewogIHZhciBzdHViUGF0aCA9IHRoaXMuY29uZmlnLnN0dWIgfHwgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3N0dWInLCB0aGlzLmNvbmZpZy5leHRlbnNpb24gKyAnLnN0dWInKTsKICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMucmVhZEZpbGUsIGZzKShzdHViUGF0aCkudGhlbihmdW5jdGlvbihzdHViKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZShzdHViLnRvU3RyaW5nKCksIG51bGwsIHt2YXJpYWJsZTogJ2QnfSk7CiAgfSk7Cn07CgovLyBXcml0ZSBhIG5ldyBtaWdyYXRpb24gdG8gZGlzaywgdXNpbmcgdGhlIGNvbmZpZyBhbmQgZ2VuZXJhdGVkIGZpbGVuYW1lLAovLyBwYXNzaW5nIGFueSBgdmFyaWFibGVzYCBnaXZlbiBpbiB0aGUgY29uZmlnIHRvIHRoZSB0ZW1wbGF0ZS4KTWlncmF0b3IucHJvdG90eXBlLl93cml0ZU5ld01pZ3JhdGlvbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgdmFyIGRpciA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKHRtcGwpIHsKICAgIGlmIChuYW1lWzBdID09PSAnLScpIG5hbWUgPSBuYW1lLnNsaWNlKDEpOwogICAgdmFyIGZpbGVuYW1lICA9IHl5eXltbWRkaGhtbXNzKCkgKyAnXycgKyBuYW1lICsgJy4nICsgY29uZmlnLmV4dGVuc2lvbjsKICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy53cml0ZUZpbGUsIGZzKSgKICAgICAgcGF0aC5qb2luKGRpciwgZmlsZW5hbWUpLAogICAgICB0bXBsKGNvbmZpZy52YXJpYWJsZXMgfHwge30pCiAgICApLnJldHVybihwYXRoLmpvaW4oZGlyLCBmaWxlbmFtZSkpOwogIH07Cn07CgovLyBHZXQgdGhlIGxhc3QgYmF0Y2ggb2YgbWlncmF0aW9ucywgYnkgbmFtZSwgb3JkZXJlZCBieSBpbnNlcnQgaWQKLy8gaW4gcmV2ZXJzZSBvcmRlci4KTWlncmF0b3IucHJvdG90eXBlLl9nZXRMYXN0QmF0Y2ggPSBmdW5jdGlvbigpIHsKICB2YXIga25leCA9IHRoaXMua25leDsKICB2YXIgdGFibGVOYW1lID0gdGhpcy5jb25maWcudGFibGVOYW1lOwogIHJldHVybiB0aGlzLmtuZXgodGFibGVOYW1lKQogICAgLndoZXJlKCdiYXRjaCcsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNlbGVjdChrbmV4LnJhdygnTUFYKGJhdGNoKScpKS5mcm9tKHRhYmxlTmFtZSk7CiAgICB9KQogICAgLm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKTsKfTsKCi8vIFJldHVybnMgdGhlIGxhdGVzdCBiYXRjaCBudW1iZXIuCk1pZ3JhdG9yLnByb3RvdHlwZS5fbGF0ZXN0QmF0Y2hOdW1iZXIgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5rbmV4KHRoaXMuY29uZmlnLnRhYmxlTmFtZSkKICAgIC5tYXgoJ2JhdGNoIGFzIGJhdGNoTm8nKS50aGVuKGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gKG9ialswXS5iYXRjaE5vIHx8IDApOwogICAgfSk7Cn07CgovLyBSdW5zIGEgYmF0Y2ggb2YgYG1pZ3JhdGlvbnNgIGluIGEgc3BlY2lmaWVkIGBkaXJlY3Rpb25gLAovLyBzYXZpbmcgdGhlIGFwcHJvcHJpYXRlIGRhdGFiYXNlIGluZm9ybWF0aW9uIGFzIHRoZSBtaWdyYXRpb25zIGFyZSBydW4uCk1pZ3JhdG9yLnByb3RvdHlwZS5fd2F0ZXJmYWxsQmF0Y2ggPSBmdW5jdGlvbihiYXRjaE5vLCBtaWdyYXRpb25zLCBkaXJlY3Rpb24pIHsKICB2YXIga25leCAgICAgID0gdGhpcy5rbmV4OwogIHZhciB0YWJsZU5hbWUgPSB0aGlzLmNvbmZpZy50YWJsZU5hbWU7CiAgdmFyIGRpcmVjdG9yeSA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgdmFyIGN1cnJlbnQgICA9IFByb21pc2UuYmluZCh7ZmFpbGVkOiBmYWxzZSwgZmFpbGVkT246IDB9KTsKICB2YXIgbG9nICAgICAgID0gW107CiAgXy5lYWNoKG1pZ3JhdGlvbnMsIGZ1bmN0aW9uKG1pZ3JhdGlvbikgewogICAgdmFyIG5hbWUgID0gbWlncmF0aW9uOwogICAgbWlncmF0aW9uID0gcmVxdWlyZShkaXJlY3RvcnkgKyAnLycgKyBuYW1lKTsKCiAgICAvLyBXZSdyZSBnb2luZyB0byBydW4gZWFjaCBvZiB0aGUgbWlncmF0aW9ucyBpbiB0aGUgY3VycmVudCAidXAiCiAgICBjdXJyZW50ID0gY3VycmVudC50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbWlncmF0aW9uW2RpcmVjdGlvbl0oa25leCwgUHJvbWlzZSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBsb2cucHVzaChwYXRoLmpvaW4oZGlyZWN0b3J5LCBuYW1lKSk7CiAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd1cCcpIHsKICAgICAgICByZXR1cm4ga25leCh0YWJsZU5hbWUpLmluc2VydCh7CiAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgYmF0Y2g6IGJhdGNoTm8sCiAgICAgICAgICBtaWdyYXRpb25fdGltZTogbmV3IERhdGUoKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChkaXJlY3Rpb24gPT09ICdkb3duJykgewogICAgICAgIHJldHVybiBrbmV4KHRhYmxlTmFtZSkud2hlcmUoe25hbWU6IG5hbWV9KS5kZWwoKTsKICAgICAgfQogICAgfSk7CiAgfSk7CgogIHJldHVybiBjdXJyZW50LnRoZW5SZXR1cm4oW2JhdGNoTm8sIGxvZ10pOwp9OwoKTWlncmF0b3IucHJvdG90eXBlLl9hYnNvbHV0ZUNvbmZpZ0RpciA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgdGhpcy5jb25maWcuZGlyZWN0b3J5KTsKfTsKCk1pZ3JhdG9yLnByb3RvdHlwZS5zZXRDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICByZXR1cm4gXy5leHRlbmQoewogICAgZXh0ZW5zaW9uOiAnanMnLAogICAgdGFibGVOYW1lOiAna25leF9taWdyYXRpb25zJywKICAgIGRpcmVjdG9yeTogJy4vbWlncmF0aW9ucycKICB9LCB0aGlzLmNvbmZpZyB8fCB7fSwgY29uZmlnKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gTWlncmF0b3I7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSwiL25vZGVfbW9kdWxlcy9rbmV4L2xpYi9taWdyYXRlIikKfSx7Ii4uL3Byb21pc2UiOjEwMywiX3Byb2Nlc3MiOjYwLCJmcyI6NTEsImxvZGFzaCI6MTMwLCJta2RpcnAiOjEyMCwicGF0aCI6NTl9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBQb29sCi8vIC0tLS0tLS0KdmFyIF8gICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBHZW5lcmljUG9vbCA9IHJlcXVpcmUoJ2dlbmVyaWMtcG9vbC1yZWR1eCcpLlBvb2w7CnZhciBQcm9taXNlICAgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKLy8gVGhlICJQb29sIiBvYmplY3QgaXMgYSB0aGluIHdyYXBwZXIgYXJvdW5kIHRoZQovLyAiZ2VuZXJpYy1wb29sLXJlZHV4IiBsaWJyYXJ5LCBleHBvc2luZyBhIGBkZXN0cm95YAovLyBtZXRob2QgZm9yIGV4cGxpY2l0bHkgZHJhaW5pbmcgdGhlIHBvb2wuIFRoZQovLyBgaW5pdGAgbWV0aG9kIGlzIGNhbGxlZCBpbnRlcm5hbGx5IGFuZCBpbml0aWFsaXplcwovLyB0aGUgcG9vbCBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3QuCmZ1bmN0aW9uIFBvb2woY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSBfLmNsb25lKGNvbmZpZykgfHwge307CiAgdGhpcy5nZW5lcmljUG9vbCA9IHRoaXMuaW5pdGlhbGl6ZSgpOwp9CgovLyBUeXBpY2FsbHkgb25seSBjYWxsZWQgaW50ZXJuYWxseSwgdGhpcyBpbml0aWFsaXplcwovLyBhIG5ldyBgR2VuZXJpY1Bvb2xgIGluc3RhbmNlLCBiYXNlZCBvbiB0aGUgYGNvbmZpZ2AKLy8gb3B0aW9ucyBwYXNzZWQgaW50byB0aGUgY29uc3RydWN0b3IuClBvb2wucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IEdlbmVyaWNQb29sKF8uZGVmYXVsdHModGhpcy5jb25maWcsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKSk7Cn07CgovLyBTb21lIGJhc2ljIGRlZmF1bHRzIGZvciB0aGUgcG9vbC4uLgpQb29sLnByb3RvdHlwZS5kZWZhdWx0cyA9IGZ1bmN0aW9uKCkgewogIHZhciBwb29sID0gdGhpczsKICByZXR1cm4gewogICAgbWluOiAyLAogICAgbWF4OiAxMCwKICAgIGNyZWF0ZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgcG9vbC5jbGllbnQuYWNxdWlyZVJhd0Nvbm5lY3Rpb24oKQogICAgICAgIC50YXAoZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgICAgICAgY29ubmVjdGlvbi5fX2NpZCA9IF8udW5pcXVlSWQoJ19fY2lkJyk7CiAgICAgICAgICBpZiAocG9vbC5jb25maWcuYWZ0ZXJDcmVhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucHJvbWlzaWZ5KHBvb2wuY29uZmlnLmFmdGVyQ3JlYXRlKShjb25uZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9KS5leGVjKGNhbGxiYWNrKTsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIGlmIChwb29sLmNvbmZpZy5iZWZvcmVEZXN0cm95KSB7CiAgICAgICAgcmV0dXJuIHBvb2wuY29uZmlnLmJlZm9yZURlc3Ryb3koY29ubmVjdGlvbiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoY29ubmVjdGlvbiAhPT0gdm9pZCAwKSBjb25uZWN0aW9uLmVuZCgpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChjb25uZWN0aW9uICE9PSB2b2lkIDApIGNvbm5lY3Rpb24uZW5kKCk7CiAgICB9CiAgfTsKfTsKCi8vIEFjcXVpcmVzIGEgY29ubmVjdGlvbiBmcm9tIHRoZSBwb29sLgpQb29sLnByb3RvdHlwZS5hY3F1aXJlID0gZnVuY3Rpb24oY2FsbGJhY2ssIHByaW9yaXR5KSB7CiAgaWYgKHRoaXMuZ2VuZXJpY1Bvb2wpIHsKICAgIHRoaXMuZ2VuZXJpY1Bvb2wuYWNxdWlyZShjYWxsYmFjaywgcHJpb3JpdHkpOwogIH0gZWxzZSB7CiAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ1RoZSBnZW5lcmljUG9vbCBpcyBub3QgaW5pdGlhbGl6ZWQuJykpOwogIH0KfTsKCi8vIFJlbGVhc2UgYSBjb25uZWN0aW9uIGJhY2sgdG8gdGhlIGNvbm5lY3Rpb24gcG9vbC4KUG9vbC5wcm90b3R5cGUucmVsZWFzZSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNhbGxiYWNrKSB7CiAgaWYgKHRoaXMuZ2VuZXJpY1Bvb2wpIHsKICAgIHRoaXMuZ2VuZXJpY1Bvb2wucmVsZWFzZShjb25uZWN0aW9uLCBjYWxsYmFjayk7CiAgfSBlbHNlIHsKICAgIGNhbGxiYWNrKG5ldyBFcnJvcignVGhlIGdlbmVyaWNQb29sIGlzIG5vdCBpbml0aWFsaXplZC4nKSk7CiAgfQp9OwoKLy8gVGVhciBkb3duIHRoZSBwb29sLCBvbmx5IG5lY2Vzc2FyeSBpZiB5b3UgbmVlZCBpdC4KUG9vbC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgdmFyIGdlbmVyaWNQb29sID0gdGhpcy5nZW5lcmljUG9vbDsKICBpZiAoZ2VuZXJpY1Bvb2wpIHsKICAgIGdlbmVyaWNQb29sLmRyYWluKGZ1bmN0aW9uKCkgewogICAgICBnZW5lcmljUG9vbC5kZXN0cm95QWxsTm93KGNhbGxiYWNrKTsKICAgIH0pOwogICAgdGhpcy5nZW5lcmljUG9vbCA9IHZvaWQgMDsKICB9IGVsc2UgewogICAgY2FsbGJhY2soKTsKICB9CiAgcmV0dXJuIHRoaXM7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFBvb2w7Cn0seyIuL3Byb21pc2UiOjEwMywiZ2VuZXJpYy1wb29sLXJlZHV4IjoxMTksImxvZGFzaCI6MTMwfV0sMTAzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZC9qcy9tYWluL3Byb21pc2UnKSgpOwoKUHJvbWlzZS5wcm90b3R5cGUueWllbGQgICAgID0gUHJvbWlzZS5wcm90b3R5cGUudGhlblJldHVybjsKUHJvbWlzZS5wcm90b3R5cGUuZW5zdXJlICAgID0gUHJvbWlzZS5wcm90b3R5cGUubGFzdGx5OwpQcm9taXNlLnByb3RvdHlwZS5vdGhlcndpc2UgPSBQcm9taXNlLnByb3RvdHlwZS5jYXVnaHQ7ClByb21pc2UucHJvdG90eXBlLmV4ZWMgICAgICA9IFByb21pc2UucHJvdG90eXBlLm5vZGVpZnk7Cgptb2R1bGUuZXhwb3J0cyA9IFByb21pc2U7Cgp9LHsiYmx1ZWJpcmQvanMvbWFpbi9wcm9taXNlIjozNX1dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIEJ1aWxkZXIKLy8gLS0tLS0tLQp2YXIgXyAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKdmFyIFJhdyAgICAgICAgICA9IHJlcXVpcmUoJy4uL3JhdycpOwp2YXIgaGVscGVycyAgICAgID0gcmVxdWlyZSgnLi4vaGVscGVycycpOwoKdmFyIEpvaW5DbGF1c2UgID0gcmVxdWlyZSgnLi9qb2luY2xhdXNlJyk7CgovLyBUeXBpY2FsbHkgY2FsbGVkIGZyb20gYGtuZXguYnVpbGRlcmAsCi8vIHN0YXJ0IGEgbmV3IHF1ZXJ5IGJ1aWxkaW5nIGNoYWluLgpmdW5jdGlvbiBRdWVyeUJ1aWxkZXIoKSB7CiAgdGhpcy5fc2luZ2xlICAgICA9IHt9OwogIHRoaXMuX3N0YXRlbWVudHMgPSBbXTsKICB0aGlzLl9lcnJvcnMgICAgID0gW107CgogIC8vIEludGVybmFsIGZsYWdzIHVzZWQgaW4gdGhlIGJ1aWxkZXIuCiAgdGhpcy5fam9pbkZsYWcgID0gJ2lubmVyJzsKICB0aGlzLl9ib29sRmxhZyAgPSAnYW5kJzsKICB0aGlzLl9ub3RGbGFnICAgPSBmYWxzZTsKCiAgdGhpcy5hbmQgPSB0aGlzOwp9CmluaGVyaXRzKFF1ZXJ5QnVpbGRlciwgRXZlbnRFbWl0dGVyKTsKClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy50b1F1ZXJ5KCk7Cn07CgovLyBDb252ZXJ0IHRoZSBjdXJyZW50IHF1ZXJ5ICJ0b1NRTCIKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHZhciBRdWVyeUNvbXBpbGVyID0gdGhpcy5jbGllbnQuUXVlcnlDb21waWxlcjsKICByZXR1cm4gbmV3IFF1ZXJ5Q29tcGlsZXIodGhpcykudG9TUUwodGhpcy5fbWV0aG9kIHx8ICdzZWxlY3QnKTsKfTsKCi8vIENyZWF0ZSBhIHNoYWxsb3cgY2xvbmUgb2YgdGhlIGN1cnJlbnQgcXVlcnkgYnVpbGRlci4KLy8gVE9ETzogVGVzdCB0aGlzISEKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogIHZhciBjbG9uZWQgICAgICAgICAgICA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCk7CiAgICBjbG9uZWQuX21ldGhvZCAgICAgID0gdGhpcy5fbWV0aG9kOwogICAgY2xvbmVkLl9zaW5nbGUgICAgICA9IF8uY2xvbmUodGhpcy5fc2luZ2xlKTsKICAgIGNsb25lZC5fb3B0aW9ucyAgICAgPSBfLmNsb25lKHRoaXMuX29wdGlvbnMpOwogICAgY2xvbmVkLl9zdGF0ZW1lbnRzICA9IHRoaXMuX3N0YXRlbWVudHMuc2xpY2UoKTsKICAgIGNsb25lZC5fZXJyb3JzICAgICAgPSB0aGlzLl9lcnJvcnMuc2xpY2UoKTsKICAgIGNsb25lZC5fZGVidWcgICAgICAgPSB0aGlzLl9kZWJ1ZzsKICAgIGNsb25lZC5fdHJhbnNhY3RpbmcgPSB0aGlzLl90cmFuc2FjdGluZzsKICAgIGNsb25lZC5fY29ubmVjdGlvbiAgPSB0aGlzLl9jb25uZWN0aW9uOwogIHJldHVybiBjbG9uZWQ7Cn07CgovLyBTZWxlY3QKLy8gLS0tLS0tCgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGEgYHNlbGVjdGAgcXVlcnksCi8vIHdoaWNoIGlzIHRoZSBzYW1lIGFzIHNwZWNpZnlpbmcgdGhlIGNvbHVtbnMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuc2VsZWN0ID0KCi8vIEFkZHMgYSBjb2x1bW4gb3IgY29sdW1ucyB0byB0aGUgbGlzdCBvZiAiY29sdW1ucyIKLy8gYmVpbmcgc2VsZWN0ZWQgb24gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbnMgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbiA9IGZ1bmN0aW9uKGNvbHVtbikgewogIGlmICghY29sdW1uKSByZXR1cm4gdGhpczsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdjb2x1bW5zJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBbGxvdyBmb3IgYSBzdWItc2VsZWN0IHRvIGJlIGV4cGxpY2l0bHkgYWxpYXNlZCBhcyBhIGNvbHVtbiwKLy8gd2l0aG91dCBuZWVkaW5nIHRvIGNvbXBpbGUgdGhlIHF1ZXJ5IGluIGEgd2hlcmUuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuYXMgPSBmdW5jdGlvbihjb2x1bW4pIHsKICB0aGlzLl9zaW5nbGUuYXMgPSBjb2x1bW47CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXRzIHRoZSBgdGFibGVOYW1lYCBvbiB0aGUgcXVlcnkuCi8vIEFsaWFzIHRvICJmcm9tIiBmb3Igc2VsZWN0IGFuZCAiaW50byIgZm9yIGluc2VydCBzdGF0ZW1lbnRzCi8vIGUuZy4gYnVpbGRlci5pbnNlcnQoe2E6IHZhbHVlfSkuaW50bygndGFibGVOYW1lJykKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHRoaXMuX3NpbmdsZS50YWJsZSA9IHRhYmxlTmFtZTsKICByZXR1cm4gdGhpczsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mcm9tID0gUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5pbnRvID0gUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZTsKCi8vIEFkZHMgYSBgZGlzdGluY3RgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZGlzdGluY3QgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdjb2x1bW5zJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpLAogICAgZGlzdGluY3Q6IHRydWUKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBqb2luIGNsYXVzZSB0byB0aGUgcXVlcnksIGFsbG93aW5nIGZvciBhZHZhbmNlZCBqb2lucwovLyB3aXRoIGFuIGFub255bW91cyBmdW5jdGlvbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LgovLyBmdW5jdGlvbih0YWJsZSwgZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmQpClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuam9pbiA9IGZ1bmN0aW9uKHRhYmxlLCBmaXJzdCkgewogIHZhciBqb2luOwogIHZhciBqb2luVHlwZSA9IHRoaXMuX2pvaW5UeXBlKCk7CiAgaWYgKF8uaXNGdW5jdGlvbihmaXJzdCkpIHsKICAgIGpvaW4gPSBuZXcgSm9pbkNsYXVzZSh0YWJsZSwgam9pblR5cGUpOwogICAgZmlyc3QuY2FsbChqb2luLCBqb2luKTsKICB9IGVsc2UgaWYgKGpvaW5UeXBlID09PSAncmF3JykgewogICAgam9pbiA9IG5ldyBKb2luQ2xhdXNlKG5ldyBSYXcodGFibGUsIGZpcnN0KSwgJ3JhdycpOwogIH0gZWxzZSB7CiAgICBqb2luID0gbmV3IEpvaW5DbGF1c2UodGFibGUsIGpvaW5UeXBlKTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBqb2luLm9uLmFwcGx5KGpvaW4sIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpKTsKICAgIH0KICB9CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKGpvaW4pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gSk9JTiBibG9ja3M6ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaW5uZXJKb2luID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2pvaW5UeXBlKCdpbm5lcicpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5sZWZ0Sm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnbGVmdCcpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5sZWZ0T3V0ZXJKb2luID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2pvaW5UeXBlKCdsZWZ0IG91dGVyJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLnJpZ2h0Sm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgncmlnaHQnKS5qb2luLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUucmlnaHRPdXRlckpvaW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ3JpZ2h0IG91dGVyJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm91dGVySm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnb3V0ZXInKS5qb2luLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZnVsbE91dGVySm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnZnVsbCBvdXRlcicpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5jcm9zc0pvaW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ2Nyb3NzJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmpvaW5SYXcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ3JhdycpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCi8vIFRoZSB3aGVyZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCBpbiBzZXZlcmFsIHdheXM6Ci8vIFRoZSBtb3N0IGJhc2ljIGlzIGB3aGVyZShrZXksIHZhbHVlKWAsIHdoaWNoIGV4cGFuZHMgdG8KLy8gd2hlcmUga2V5ID0gdmFsdWUuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmUgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZFdoZXJlID0gZnVuY3Rpb24oY29sdW1uLCBvcGVyYXRvciwgdmFsdWUpIHsKCiAgLy8gU3VwcG9ydCAid2hlcmUgdHJ1ZSB8fCB3aGVyZSBmYWxzZSIKICBpZiAoY29sdW1uID09PSBmYWxzZSB8fCBjb2x1bW4gPT09IHRydWUpIHsKICAgIHJldHVybiB0aGlzLndoZXJlUmF3KGNvbHVtbik7CiAgfQoKICAvLyBDaGVjayBpZiB0aGUgY29sdW1uIGlzIGEgZnVuY3Rpb24sIGluIHdoaWNoIGNhc2UgaXQncwogIC8vIGEgd2hlcmUgc3RhdGVtZW50IHdyYXBwZWQgaW4gcGFyZW5zLgogIGlmIChfLmlzRnVuY3Rpb24oY29sdW1uKSkgewogICAgcmV0dXJuIHRoaXMud2hlcmVXcmFwcGVkKGNvbHVtbik7CiAgfQoKICAvLyBBbGxvdyBhIHJhdyBzdGF0ZW1lbnQgdG8gYmUgcGFzc2VkIGFsb25nIHRvIHRoZSBxdWVyeS4KICBpZiAoY29sdW1uIGluc3RhbmNlb2YgUmF3KSByZXR1cm4gdGhpcy53aGVyZVJhdyhjb2x1bW4pOwoKICAvLyBBbGxvd3MgYHdoZXJlKHtpZDogMn0pYCBzeW50YXguCiAgaWYgKF8uaXNPYmplY3QoY29sdW1uKSkgcmV0dXJuIHRoaXMuX29iamVjdFdoZXJlKGNvbHVtbik7CgogIC8vIEVuYWJsZSB0aGUgd2hlcmUoJ2tleScsIHZhbHVlKSBzeW50YXgsIG9ubHkgd2hlbiB0aGVyZQogIC8vIGFyZSBleHBsaWNpdGx5IHR3byBhcmd1bWVudHMgcGFzc2VkLCBzbyBpdCdzIG5vdCBwb3NzaWJsZSB0bwogIC8vIGRvIHdoZXJlKCdrZXknLCAnIT0nKSBhbmQgaGF2ZSB0aGF0IHR1cm4gaW50byB3aGVyZSBrZXkgIT0gbnVsbAogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICB2YWx1ZSAgICA9IG9wZXJhdG9yOwogICAgb3BlcmF0b3IgPSAnPSc7CgogICAgLy8gSWYgdGhlIHZhbHVlIGlzIG51bGwsIGFuZCBpdCdzIGEgdHdvIGFyZ3VtZW50IHF1ZXJ5LAogICAgLy8gd2UgYXNzdW1lIHdlJ3JlIGdvaW5nIGZvciBhIGB3aGVyZU51bGxgLgogICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlTnVsbChjb2x1bW4pOwogICAgfQogIH0KCiAgLy8gbG93ZXIgY2FzZSB0aGUgb3BlcmF0b3IgZm9yIGNvbXBhcmlzb24gcHVycG9zZXMKICB2YXIgY2hlY2tPcGVyYXRvciA9ICgnJyArIG9wZXJhdG9yKS50b0xvd2VyQ2FzZSgpLnRyaW0oKTsKCiAgLy8gSWYgdGhlcmUgYXJlIDMgYXJndW1lbnRzLCBjaGVjayB3aGV0aGVyICdpbicgaXMgb25lIG9mIHRoZW0uCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHsKICAgIGlmIChjaGVja09wZXJhdG9yID09PSAnaW4nIHx8IGNoZWNrT3BlcmF0b3IgPT09ICdub3QgaW4nKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3QoY2hlY2tPcGVyYXRvciA9PT0gJ25vdCBpbicpLndoZXJlSW4oYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMl0pOwogICAgfQogICAgaWYgKGNoZWNrT3BlcmF0b3IgPT09ICdiZXR3ZWVuJyB8fCBjaGVja09wZXJhdG9yID09PSAnbm90IGJldHdlZW4nKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3QoY2hlY2tPcGVyYXRvciA9PT0gJ25vdCBiZXR3ZWVuJykud2hlcmVCZXR3ZWVuKGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzJdKTsKICAgIH0KICB9CgogIC8vIElmIHRoZSB2YWx1ZSBpcyBzdGlsbCBudWxsLCBjaGVjayB3aGV0aGVyIHRoZXkncmUgbWVhbmluZwogIC8vIHdoZXJlIHZhbHVlIGlzIG51bGwKICBpZiAodmFsdWUgPT09IG51bGwpIHsKCiAgICAvLyBDaGVjayBmb3IgLndoZXJlKGtleSwgJ2lzJywgbnVsbCkgb3IgLndoZXJlKGtleSwgJ2lzIG5vdCcsICdudWxsJyk7CiAgICBpZiAoY2hlY2tPcGVyYXRvciA9PT0gJ2lzJyB8fCBjaGVja09wZXJhdG9yID09PSAnaXMgbm90JykgewogICAgICByZXR1cm4gdGhpcy5fbm90KGNoZWNrT3BlcmF0b3IgPT09ICdpcyBub3QnKS53aGVyZU51bGwoY29sdW1uKTsKICAgIH0KICB9CgogIC8vIFB1c2ggb250byB0aGUgd2hlcmUgc3RhdGVtZW50IHN0YWNrLgogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZUJhc2ljJywKICAgIGNvbHVtbjogY29sdW1uLAogICAgb3BlcmF0b3I6IG9wZXJhdG9yLAogICAgdmFsdWU6IHZhbHVlLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07Ci8vIEFkZHMgYW4gYG9yIHdoZXJlYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9yV2hlcmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKLy8gUHJvY2Vzc2VzIGFuIG9iamVjdCBsaXRlcmFsIHByb3ZpZGVkIGluIGEgIndoZXJlIiBjbGF1c2UuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX29iamVjdFdoZXJlID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIGJvb2xWYWwgPSB0aGlzLl9ib29sKCk7CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgdGhpc1tib29sVmFsICsgJ1doZXJlJ10oa2V5LCBvYmpba2V5XSk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkcyBhIHJhdyBgd2hlcmVgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmVSYXcgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZFdoZXJlUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlUmF3JywKICAgIHZhbHVlOiByYXcsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlUmF3KHNxbCwgYmluZGluZ3MpOwp9OwoKLy8gSGVscGVyIGZvciBjb21waWxpbmcgYW55IGFkdmFuY2VkIGB3aGVyZWAgcXVlcmllcy4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZVdyYXBwZWQgPSBmdW5jdGlvbihjYWxsYmFjaykgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZVdyYXBwZWQnLAogICAgdmFsdWU6IGNhbGxiYWNrLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYHdoZXJlIGV4aXN0c2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZUV4aXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlRXhpc3RzJywKICAgIHZhbHVlOiBjYWxsYmFjaywKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCksCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGFuIGBvciB3aGVyZSBleGlzdHNgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JXaGVyZUV4aXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykud2hlcmVFeGlzdHMoY2FsbGJhY2spOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBub3QgZXhpc3RzYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90RXhpc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICByZXR1cm4gdGhpcy5fbm90KHRydWUpLndoZXJlRXhpc3RzKGNhbGxiYWNrKTsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgbm90IGV4aXN0c2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90RXhpc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZU5vdEV4aXN0cyhjYWxsYmFjayk7Cn07CgovLyBBZGRzIGEgYHdoZXJlIGluYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlSW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIGlmIChfLmlzQXJyYXkodmFsdWVzKSAmJiBfLmlzRW1wdHkodmFsdWVzKSkgcmV0dXJuIHRoaXMud2hlcmUodGhpcy5fbm90KCkpOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZUluJywKICAgIGNvbHVtbjogY29sdW1uLAogICAgdmFsdWU6IHZhbHVlcywKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgaW5gIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JXaGVyZUluID0gZnVuY3Rpb24oY29sdW1uLCB2YWx1ZXMpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZUluKGNvbHVtbiwgdmFsdWVzKTsKfTsKCi8vIEFkZHMgYSBgd2hlcmUgbm90IGluYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90SW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIHJldHVybiB0aGlzLl9ub3QodHJ1ZSkud2hlcmVJbihjb2x1bW4sIHZhbHVlcyk7Cn07CgovLyBBZGRzIGEgYG9yIHdoZXJlIG5vdCBpbmAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90SW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLl9ub3QodHJ1ZSkud2hlcmVJbihjb2x1bW4sIHZhbHVlcyk7Cn07CgovLyBBZGRzIGEgYHdoZXJlIG51bGxgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmVOdWxsID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlTnVsbCcsCiAgICBjb2x1bW46IGNvbHVtbiwKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTnVsbCA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlTnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBub3QgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZU5vdE51bGwgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fbm90KHRydWUpLndoZXJlTnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBub3QgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90TnVsbCA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlTm90TnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlQmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgaWYgKCFfLmlzQXJyYXkodmFsdWVzKSkgewogICAgcmV0dXJuIHRoaXMuX2Vycm9ycy5wdXNoKG5ldyBFcnJvcignVGhlIHNlY29uZCBhcmd1bWVudCB0byB3aGVyZUJldHdlZW4gbXVzdCBiZSBhbiBhcnJheS4nKSk7CiAgfQogIGlmICh2YWx1ZXMubGVuZ3RoICE9PSAyKSB7CiAgICByZXR1cm4gdGhpcy5fZXJyb3JzLnB1c2gobmV3IEVycm9yKCdZb3UgbXVzdCBzcGVjaWZ5IDIgdmFsdWVzIGZvciB0aGUgd2hlcmVCZXR3ZWVuIGNsYXVzZScpKTsKICB9CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlQmV0d2VlbicsCiAgICBjb2x1bW46IGNvbHVtbiwKICAgIHZhbHVlOiB2YWx1ZXMsCiAgICBub3Q6IHRoaXMuX25vdCgpLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYHdoZXJlIG5vdCBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90QmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgcmV0dXJuIHRoaXMuX25vdCh0cnVlKS53aGVyZUJldHdlZW4oY29sdW1uLCB2YWx1ZXMpOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9yV2hlcmVCZXR3ZWVuID0gZnVuY3Rpb24oY29sdW1uLCB2YWx1ZXMpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZUJldHdlZW4oY29sdW1uLCB2YWx1ZXMpOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBub3QgYmV0d2VlbmAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90QmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykud2hlcmVOb3RCZXR3ZWVuKGNvbHVtbiwgdmFsdWVzKTsKfTsKCi8vIEFkZHMgYSBgZ3JvdXAgYnlgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZ3JvdXBCeSA9IGZ1bmN0aW9uKGl0ZW0pIHsKICBpZiAoaXRlbSBpbnN0YW5jZW9mIFJhdykgewogICAgcmV0dXJuIHRoaXMuZ3JvdXBCeVJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdncm91cCcsCiAgICB0eXBlOiAnZ3JvdXBCeUJhc2ljJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgcmF3IGBncm91cCBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5ncm91cEJ5UmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnZ3JvdXAnLAogICAgdHlwZTogJ2dyb3VwQnlSYXcnLAogICAgdmFsdWU6IHJhdwogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkcyBhIGBvcmRlciBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcmRlckJ5ID0gZnVuY3Rpb24oY29sdW1uLCBkaXJlY3Rpb24pIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdvcmRlcicsCiAgICB0eXBlOiAnb3JkZXJCeUJhc2ljJywKICAgIHZhbHVlOiBjb2x1bW4sCiAgICBkaXJlY3Rpb246IGRpcmVjdGlvbgogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkIGEgcmF3IGBvcmRlciBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcmRlckJ5UmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnb3JkZXInLAogICAgdHlwZTogJ29yZGVyQnlSYXcnLAogICAgdmFsdWU6IHJhdwogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkIGEgdW5pb24gc3RhdGVtZW50IHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS51bmlvbiA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB3cmFwKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJncy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgdGhpcy51bmlvbihhcmdzW2ldKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICd1bmlvbicsCiAgICBjbGF1c2U6ICd1bmlvbicsCiAgICB2YWx1ZTogY2FsbGJhY2ssCiAgICB3cmFwOiB3cmFwIHx8IGZhbHNlCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgdW5pb24gYWxsIHN0YXRlbWVudCB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudW5pb25BbGwgPSBmdW5jdGlvbihjYWxsYmFjaywgd3JhcCkgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3VuaW9uJywKICAgIGNsYXVzZTogJ3VuaW9uIGFsbCcsCiAgICB2YWx1ZTogY2FsbGJhY2ssCiAgICB3cmFwOiB3cmFwIHx8IGZhbHNlCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYGhhdmluZ2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5oYXZpbmcgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZEhhdmluZyA9IGZ1bmN0aW9uKGNvbHVtbiwgb3BlcmF0b3IsIHZhbHVlKSB7CiAgaWYgKGNvbHVtbiBpbnN0YW5jZW9mIFJhdyAmJiBhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gdGhpcy5faGF2aW5nUmF3KGNvbHVtbik7CiAgfQogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2hhdmluZycsCiAgICB0eXBlOiAnaGF2aW5nQmFzaWMnLAogICAgY29sdW1uOiBjb2x1bW4sCiAgICBvcGVyYXRvcjogb3BlcmF0b3IsCiAgICB2YWx1ZTogdmFsdWUsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKLy8gQWRkcyBhbiBgb3IgaGF2aW5nYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9ySGF2aW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykuaGF2aW5nLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaGF2aW5nUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHJldHVybiB0aGlzLl9oYXZpbmdSYXcoc3FsLCBiaW5kaW5ncyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JIYXZpbmdSYXcgPSBmdW5jdGlvbihzcWwsIGJpbmRpbmdzKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykuaGF2aW5nUmF3KHNxbCwgYmluZGluZ3MpOwp9OwovLyBBZGRzIGEgcmF3IGBoYXZpbmdgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX2hhdmluZ1JhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICB2YXIgcmF3ID0gKHNxbCBpbnN0YW5jZW9mIFJhdyA/IHNxbCA6IG5ldyBSYXcoc3FsLCBiaW5kaW5ncykpOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2hhdmluZycsCiAgICB0eXBlOiAnaGF2aW5nUmF3JywKICAgIHZhbHVlOiByYXcsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIE9ubHkgYWxsb3cgYSBzaW5nbGUgIm9mZnNldCIgdG8gYmUgc2V0IGZvciB0aGUgY3VycmVudCBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vZmZzZXQgPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMuX3NpbmdsZS5vZmZzZXQgPSB2YWx1ZTsKICByZXR1cm4gdGhpczsKfTsKCi8vIE9ubHkgYWxsb3cgYSBzaW5nbGUgImxpbWl0IiB0byBiZSBzZXQgZm9yIHRoZSBjdXJyZW50IHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmxpbWl0ID0gZnVuY3Rpb24odmFsdWUpIHsKICB0aGlzLl9zaW5nbGUubGltaXQgPSB2YWx1ZTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFJldHJpZXZlIHRoZSAiY291bnQiIHJlc3VsdCBvZiB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuY291bnQgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdjb3VudCcsIChjb2x1bW4gfHwgJyonKSk7Cn07CgovLyBSZXRyaWV2ZSB0aGUgbWluaW11bSB2YWx1ZSBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5taW4gPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdtaW4nLCBjb2x1bW4pOwp9OwoKLy8gUmV0cmlldmUgdGhlIG1heGltdW0gdmFsdWUgb2YgYSBnaXZlbiBjb2x1bW4uClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUubWF4ID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgcmV0dXJuIHRoaXMuX2FnZ3JlZ2F0ZSgnbWF4JywgY29sdW1uKTsKfTsKCi8vIFJldHJpZXZlIHRoZSBzdW0gb2YgdGhlIHZhbHVlcyBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5zdW0gPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdzdW0nLCBjb2x1bW4pOwp9OwoKLy8gUmV0cmlldmUgdGhlIGF2ZXJhZ2Ugb2YgdGhlIHZhbHVlcyBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5hdmcgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdhdmcnLCBjb2x1bW4pOwp9OwoKLy8gSW5jcmVtZW50cyBhIGNvbHVtbidzIHZhbHVlIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmluY3JlbWVudCA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50KSB7CiAgcmV0dXJuIHRoaXMuX2NvdW50ZXIoY29sdW1uLCBhbW91bnQpOwp9OwoKLy8gRGVjcmVtZW50cyBhIGNvbHVtbidzIHZhbHVlIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmRlY3JlbWVudCA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50KSB7CiAgcmV0dXJuIHRoaXMuX2NvdW50ZXIoY29sdW1uLCBhbW91bnQsICctJyk7Cn07CgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGEgYHNlbGVjdGAgcXVlcnksIGluZm9ybWluZyB0aGF0IG9ubHkgdGhlIGZpcnN0Ci8vIHJvdyBzaG91bGQgYmUgcmV0dXJuZWQgKGxpbWl0IDEpLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmZpcnN0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIGksIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCk7CiAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbaV07CiAgfQogIHRoaXMuc2VsZWN0LmFwcGx5KHRoaXMsIGFyZ3MpOwogIHRoaXMuX21ldGhvZCA9ICdmaXJzdCc7CiAgdGhpcy5saW1pdCgxKTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFBsdWNrIGEgY29sdW1uIGZyb20gYSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5wbHVjayA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHRoaXMuX21ldGhvZCA9ICdwbHVjayc7CiAgdGhpcy5fc2luZ2xlLnBsdWNrID0gY29sdW1uOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2NvbHVtbnMnLAogICAgdHlwZTogJ3BsdWNrJywKICAgIHZhbHVlOiBjb2x1bW4KICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEluc2VydCAmIFVwZGF0ZQovLyAtLS0tLS0KCi8vIFNldHMgdGhlIHZhbHVlcyBmb3IgYW4gYGluc2VydGAgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24odmFsdWVzLCByZXR1cm5pbmcpIHsKICB0aGlzLl9tZXRob2QgPSAnaW5zZXJ0JzsKICBpZiAoIV8uaXNFbXB0eShyZXR1cm5pbmcpKSB0aGlzLnJldHVybmluZyhyZXR1cm5pbmcpOwogIHRoaXMuX3NpbmdsZS5pbnNlcnQgPSB2YWx1ZXM7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGFuIGB1cGRhdGVgLCBhbGxvd2luZyBmb3IgYm90aAovLyBgLnVwZGF0ZShrZXksIHZhbHVlLCBbcmV0dXJuaW5nXSlgIGFuZCBgLnVwZGF0ZShvYmosIFtyZXR1cm5pbmddKWAgc3ludGF4ZXMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24odmFsdWVzLCByZXR1cm5pbmcpIHsKICB2YXIgcmV0LCBvYmogPSB7fTsKICB0aGlzLl9tZXRob2QgPSAndXBkYXRlJzsKICB2YXIgaSwgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKICBmb3IgKGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICB9CiAgaWYgKF8uaXNTdHJpbmcodmFsdWVzKSkgewogICAgb2JqW3ZhbHVlc10gPSByZXR1cm5pbmc7CiAgICBpZiAoYXJncy5sZW5ndGggPiAyKSB7CiAgICAgIHJldCA9IGFyZ3NbMl07CiAgICB9CiAgfSBlbHNlIHsKICAgIG9iaiA9IHZhbHVlczsKICAgIHJldCA9IGFyZ3NbMV07CiAgfQogIGlmICghXy5pc0VtcHR5KHJldCkpIHRoaXMucmV0dXJuaW5nKHJldCk7CiAgdGhpcy5fc2luZ2xlLnVwZGF0ZSA9IG9iajsKICByZXR1cm4gdGhpczsKfTsKCi8vIFNldHMgdGhlIHJldHVybmluZyB2YWx1ZSBmb3IgdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLnJldHVybmluZyA9IGZ1bmN0aW9uKHJldHVybmluZykgewogIHRoaXMuX3NpbmdsZS5yZXR1cm5pbmcgPSByZXR1cm5pbmc7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBEZWxldGUKLy8gLS0tLS0tCgovLyBFeGVjdXRlcyBhIGRlbGV0ZSBzdGF0ZW1lbnQgb24gdGhlIHF1ZXJ5OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmRlbCA9ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24ocmV0KSB7CiAgdGhpcy5fbWV0aG9kID0gJ2RlbCc7CiAgaWYgKCFfLmlzRW1wdHkocmV0KSkgdGhpcy5yZXR1cm5pbmcocmV0KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFRydW5jYXRlcyBhIHRhYmxlLCBlbmRzIHRoZSBxdWVyeSBjaGFpbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuX21ldGhvZCA9ICd0cnVuY2F0ZSc7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBSZXRyaWV2ZXMgY29sdW1ucyBmb3IgdGhlIHRhYmxlIHNwZWNpZmllZCBieSBga25leCh0YWJsZU5hbWUpYApRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbkluZm8gPSBmdW5jdGlvbihjb2x1bW4pIHsKICB0aGlzLl9tZXRob2QgPSAnY29sdW1uSW5mbyc7CiAgdGhpcy5fc2luZ2xlLmNvbHVtbkluZm8gPSBjb2x1bW47CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXQgYSBsb2NrIGZvciB1cGRhdGUgY29uc3RyYWludC4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mb3JVcGRhdGUgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zaW5nbGUubG9jayA9ICdmb3JVcGRhdGUnOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU2V0IGEgbG9jayBmb3Igc2hhcmUgY29uc3RyYWludC4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mb3JTaGFyZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuX3NpbmdsZS5sb2NrID0gJ2ZvclNoYXJlJzsKICByZXR1cm4gdGhpczsKfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIEhlbHBlciBmb3IgdGhlIGluY3JlbWVudGluZy9kZWNyZW1lbnRpbmcgcXVlcmllcy4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5fY291bnRlciA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50LCBzeW1ib2wpIHsKICB2YXIgYW10ID0gcGFyc2VJbnQoYW1vdW50LCAxMCk7CiAgaWYgKGlzTmFOKGFtdCkpIGFtdCA9IDE7CiAgdGhpcy5fbWV0aG9kID0gJ2NvdW50ZXInOwogIHRoaXMuX3NpbmdsZS5jb3VudGVyID0gewogICAgY29sdW1uOiBjb2x1bW4sCiAgICBhbW91bnQ6IGFtdCwKICAgIHN5bWJvbDogKHN5bWJvbCB8fCAnKycpCiAgfTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEhlbHBlciB0byBnZXQgb3Igc2V0IHRoZSAiYm9vbEZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9ib29sID0gZnVuY3Rpb24odmFsKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHRoaXMuX2Jvb2xGbGFnID0gdmFsOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHZhciByZXQgPSB0aGlzLl9ib29sRmxhZzsKICB0aGlzLl9ib29sRmxhZyA9ICdhbmQnOwogIHJldHVybiByZXQ7Cn07CgovLyBIZWxwZXIgdG8gZ2V0IG9yIHNldCB0aGUgIm5vdEZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9ub3QgPSBmdW5jdGlvbih2YWwpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdGhpcy5fbm90RmxhZyA9IHZhbDsKICAgIHJldHVybiB0aGlzOwogIH0KICB2YXIgcmV0ID0gdGhpcy5fbm90RmxhZzsKICB0aGlzLl9ub3RGbGFnID0gZmFsc2U7CiAgcmV0dXJuIHJldDsKfTsKCi8vIEhlbHBlciB0byBnZXQgb3Igc2V0IHRoZSAiam9pbkZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9qb2luVHlwZSA9IGZ1bmN0aW9uICh2YWwpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdGhpcy5fam9pbkZsYWcgPSB2YWw7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdmFyIHJldCA9IHRoaXMuX2pvaW5GbGFnIHx8ICdpbm5lcic7CiAgdGhpcy5fam9pbkZsYWcgPSAnaW5uZXInOwogIHJldHVybiByZXQ7Cn07CgovLyBIZWxwZXIgZm9yIGNvbXBpbGluZyBhbnkgYWdncmVnYXRlIHF1ZXJpZXMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX2FnZ3JlZ2F0ZSA9IGZ1bmN0aW9uKG1ldGhvZCwgY29sdW1uKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnY29sdW1ucycsCiAgICB0eXBlOiAnYWdncmVnYXRlJywKICAgIG1ldGhvZDogbWV0aG9kLAogICAgdmFsdWU6IGNvbHVtbgogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFF1ZXJ5QnVpbGRlci5wcm90b3R5cGUsICdvcicsIHsKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9ib29sKCdvcicpOwogIH0KfSk7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFF1ZXJ5QnVpbGRlci5wcm90b3R5cGUsICdub3QnLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fbm90KHRydWUpOwogIH0KfSk7CgovLyBBdHRhY2ggYWxsIG9mIHRoZSB0b3AgbGV2ZWwgcHJvbWlzZSBtZXRob2RzIHRoYXQgc2hvdWxkIGJlIGNoYWluYWJsZS4KcmVxdWlyZSgnLi4vaW50ZXJmYWNlJykoUXVlcnlCdWlsZGVyKTsKCm1vZHVsZS5leHBvcnRzID0gUXVlcnlCdWlsZGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCIuLi9pbnRlcmZhY2UiOjEwMCwiLi4vcmF3IjoxMDgsIi4vam9pbmNsYXVzZSI6MTA2LCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gUXVlcnkgQ29tcGlsZXIKLy8gLS0tLS0tLQoKdmFyIF8gICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuLi9oZWxwZXJzJyk7CnZhciBSYXcgICAgID0gcmVxdWlyZSgnLi4vcmF3Jyk7CgovLyBUaGUgIlF1ZXJ5Q29tcGlsZXIiIHRha2VzIGFsbCBvZiB0aGUgcXVlcnkgc3RhdGVtZW50cyB3aGljaCBoYXZlIGJlZW4KLy8gZ2F0aGVyZWQgaW4gdGhlICJRdWVyeUJ1aWxkZXIiIGFuZCB0dXJucyB0aGVtIGludG8gYSBwcm9wZXJseSBmb3JtYXR0ZWQgLyBib3VuZAovLyBxdWVyeSBzdHJpbmcuCmZ1bmN0aW9uIFF1ZXJ5Q29tcGlsZXIocXVlcnlCdWlsZGVyKSB7CiAgdGhpcy5tZXRob2QgICAgICA9IHF1ZXJ5QnVpbGRlci5fbWV0aG9kIHx8ICdzZWxlY3QnOwogIHRoaXMub3B0aW9ucyAgICAgPSBxdWVyeUJ1aWxkZXIuX29wdGlvbnM7CiAgdGhpcy5zaW5nbGUgICAgICA9IHF1ZXJ5QnVpbGRlci5fc2luZ2xlOwogIHRoaXMudHJhbnNhY3RpbmcgPSBxdWVyeUJ1aWxkZXIuX3RyYW5zYWN0aW5nOwogIHRoaXMuZ3JvdXBlZCAgICAgPSBfLmdyb3VwQnkocXVlcnlCdWlsZGVyLl9zdGF0ZW1lbnRzLCAnZ3JvdXBpbmcnKTsKICB0aGlzLnRhYmxlTmFtZSAgID0gdGhpcy5zaW5nbGUudGFibGUgPyB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMuc2luZ2xlLnRhYmxlKSA6ICcnOwp9CgovLyBDb2xsYXBzZSB0aGUgYnVpbGRlciBpbnRvIGEgc2luZ2xlIG9iamVjdApRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKG1ldGhvZCkgewogIHZhciB2YWwgPSB0aGlzW21ldGhvZF0oKTsKICB2YXIgZGVmYXVsdHMgPSB7CiAgICBtZXRob2Q6IG1ldGhvZCwKICAgIG9wdGlvbnM6IHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMubGVuZ3RoID4gMCA/CiAgICAgIF8uZXh0ZW5kLmFwcGx5KF8sIHRoaXMub3B0aW9ucykgOiB2b2lkIDAsCiAgICBiaW5kaW5nczogdGhpcy5mb3JtYXR0ZXIuYmluZGluZ3MKICB9OwogIGlmIChfLmlzU3RyaW5nKHZhbCkpIHsKICAgIHZhbCA9IHtzcWw6IHZhbH07CiAgfQogIGlmIChtZXRob2QgPT09ICdzZWxlY3QnICYmIHRoaXMuc2luZ2xlLmFzKSB7CiAgICBkZWZhdWx0cy5hcyA9IHRoaXMuc2luZ2xlLmFzOwogIH0KICByZXR1cm4gXy5leHRlbmQoZGVmYXVsdHMsIHZhbCk7Cn07Cgp2YXIgY29tcG9uZW50cyA9IFsKICAnY29sdW1ucycsICdqb2luJywgJ3doZXJlJywgJ3VuaW9uJywgJ2dyb3VwJywKICAnaGF2aW5nJywgJ29yZGVyJywgJ2xpbWl0JywgJ29mZnNldCcsICdsb2NrJwpdOwoKLy8gQ29tcGlsZXMgdGhlIGBzZWxlY3RgIHN0YXRlbWVudCwgb3IgbmVzdGVkIHN1Yi1zZWxlY3RzCi8vIGJ5IGNhbGxpbmcgZWFjaCBvZiB0aGUgY29tcG9uZW50IGNvbXBpbGVycywgdHJpbW1pbmcgb3V0Ci8vIHRoZSBlbXB0aWVzLCBhbmQgcmV0dXJuaW5nIGEgZ2VuZXJhdGVkIHF1ZXJ5IHN0cmluZy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuc2VsZWN0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbXBvbmVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgY29tcG9uZW50ID0gY29tcG9uZW50c1tpXTsKICAgIHN0YXRlbWVudHMucHVzaCh0aGlzW2NvbXBvbmVudF0odGhpcykpOwogIH0KICByZXR1cm4gXy5jb21wYWN0KHN0YXRlbWVudHMpLmpvaW4oJyAnKTsKfTsKUXVlcnlDb21waWxlci5wcm90b3R5cGUuZmlyc3QgPSBRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5zZWxlY3Q7ClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLnBsdWNrID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHNxbDogdGhpcy5zZWxlY3QoKSwKICAgIHBsdWNrOiB0aGlzLnNpbmdsZS5wbHVjawogIH07Cn07CgovLyBDb21waWxlcyBhbiAiaW5zZXJ0IiBxdWVyeSwgYWxsb3dpbmcgZm9yIG11bHRpcGxlCi8vIGluc2VydHMgdXNpbmcgYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5pbnNlcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIGluc2VydFZhbHVlcyA9IHRoaXMuc2luZ2xlLmluc2VydDsKCiAgdmFyIHNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7CgogIGlmIChfLmlzQXJyYXkoaW5zZXJ0VmFsdWVzKSAmJiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSkgJiYgXy5pc0VtcHR5KGluc2VydFZhbHVlc1swXSkpIHsKICAgIGluc2VydFZhbHVlcyA9IFtdOwogIH0KCiAgaWYgKF8uaXNFbXB0eShpbnNlcnRWYWx1ZXMpICYmICFfLmlzRnVuY3Rpb24oaW5zZXJ0VmFsdWVzKSkgewogICAgc3FsICs9IHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWU7CiAgfSBlbHNlIHsKICAgIHZhciBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnRWYWx1ZXMpOwoKICAgIGlmIChfLmlzU3RyaW5nKGluc2VydERhdGEpKSB7CiAgICAgIHNxbCArPSBpbnNlcnREYXRhOwogICAgfSBlbHNlICB7CiAgICAgIGlmIChpbnNlcnREYXRhLmNvbHVtbnMubGVuZ3RoKSB7CiAgICAgICAgc3FsICs9ICcoJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShpbnNlcnREYXRhLmNvbHVtbnMpICsgJykgdmFsdWVzICgnICsKICAgICAgICAgIF8ubWFwKGluc2VydERhdGEudmFsdWVzLCB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUsIHRoaXMuZm9ybWF0dGVyKS5qb2luKCcpLCAoJykgKyAnKSc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gdGFyZ2V0IGNvbHVtbiBvbmx5IGluc2VydCBkZWZhdWx0IHZhbHVlcwogICAgICAgIHNxbCArPSAnKCkgdmFsdWVzICcgKyBfLm1hcChpbnNlcnREYXRhLnZhbHVlcywgZnVuY3Rpb24gKCkgeyByZXR1cm4gJygnICsgKHNlbGYuX2RlZmF1bHRJbnNlcnRWYWx1ZSB8fCAnJykgKyAnKSc7IH0pLmpvaW4oJywgJyk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHNxbDsKfTsKCi8vIENvbXBpbGVzIHRoZSAidXBkYXRlIiBxdWVyeS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKSB7CiAgdmFyIHVwZGF0ZURhdGEgPSB0aGlzLl9wcmVwVXBkYXRlKHRoaXMuc2luZ2xlLnVwZGF0ZSk7CiAgdmFyIHdoZXJlcyAgICAgPSB0aGlzLndoZXJlKCk7CiAgcmV0dXJuICd1cGRhdGUgJyArIHRoaXMudGFibGVOYW1lICsKICAgICcgc2V0ICcgKyB1cGRhdGVEYXRhLmpvaW4oJywgJykgKwogICAgKHdoZXJlcyA/ICcgJyArIHdoZXJlcyA6ICcnKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBjb2x1bW5zIGluIHRoZSBxdWVyeSwgc3BlY2lmeWluZyBpZiBhbiBpdGVtIHdhcyBkaXN0aW5jdC4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuY29sdW1ucyA9IGZ1bmN0aW9uKCkgewogIHZhciBkaXN0aW5jdCA9IGZhbHNlOwogIGlmICh0aGlzLm9ubHlVbmlvbnMoKSkgcmV0dXJuICcnOwogIHZhciBjb2x1bW5zID0gdGhpcy5ncm91cGVkLmNvbHVtbnMgfHwgW107CiAgdmFyIHNxbCA9IFtdOwogIGlmIChjb2x1bW5zKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbHVtbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBzdG10ID0gY29sdW1uc1tpXTsKICAgICAgaWYgKHN0bXQuZGlzdGluY3QpIGRpc3RpbmN0ID0gdHJ1ZTsKICAgICAgaWYgKHN0bXQudHlwZSA9PT0gJ2FnZ3JlZ2F0ZScpIHsKICAgICAgICBzcWwucHVzaCh0aGlzLmFnZ3JlZ2F0ZShzdG10KSk7CiAgICAgIH0gZWxzZSBpZiAoc3RtdC52YWx1ZSAmJiBzdG10LnZhbHVlLmxlbmd0aCA+IDApIHsKICAgICAgICBzcWwucHVzaCh0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoc3RtdC52YWx1ZSkpOwogICAgICB9CiAgICB9CiAgfQogIGlmIChzcWwubGVuZ3RoID09PSAwKSBzcWwucHVzaCgnKicpOwogIHJldHVybiAnc2VsZWN0ICcgKyAoZGlzdGluY3QgPyAnZGlzdGluY3QgJyA6ICcnKSArCiAgICAgIChzcWwuam9pbignLCAnKSB8fCAnKicpICsgKHRoaXMudGFibGVOYW1lID8gJyBmcm9tICcgKyB0aGlzLnRhYmxlTmFtZSA6ICcnKTsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLmFnZ3JlZ2F0ZSA9IGZ1bmN0aW9uKHN0bXQpIHsKICB2YXIgdmFsID0gc3RtdC52YWx1ZTsKICB2YXIgc3BsaXRPbiA9IHZhbC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJyBhcyAnKTsKICAvLyBBbGxvd3MgdXMgdG8gc3BlY2l5IGFuIGFsaWFzIGZvciB0aGUgYWdncmVnYXRlIHR5cGVzLgogIGlmIChzcGxpdE9uICE9PSAtMSkgewogICAgdmFyIGNvbCA9IHZhbC5zbGljZSgwLCBzcGxpdE9uKTsKICAgIHZhciBhbGlhcyA9IHZhbC5zbGljZShzcGxpdE9uICsgNCk7CiAgICByZXR1cm4gc3RtdC5tZXRob2QgKyAnKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGNvbCkgKyAnKSBhcyAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcChhbGlhcyk7CiAgfQogIHJldHVybiBzdG10Lm1ldGhvZCArICcoJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodmFsKSArICcpJzsKfTsKCi8vIENvbXBpbGVzIGFsbCBlYWNoIG9mIHRoZSBgam9pbmAgY2xhdXNlcyBvbiB0aGUgcXVlcnksCi8vIGluY2x1ZGluZyBhbnkgbmVzdGVkIGpvaW4gcXVlcmllcy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuam9pbiA9IGZ1bmN0aW9uKCkgewogIHZhciBqb2lucyA9IHRoaXMuZ3JvdXBlZC5qb2luOwogIGlmICgham9pbnMpIHJldHVybiAnJzsKICB2YXIgc3FsID0gXy5yZWR1Y2Uoam9pbnMsIGZ1bmN0aW9uKGFjYywgam9pbikgewogICAgaWYgKGpvaW4uam9pblR5cGUgPT09ICdyYXcnKSB7CiAgICAgIGFjYy5wdXNoKHRoaXMuZm9ybWF0dGVyLmNoZWNrUmF3KGpvaW4udGFibGUpKTsKICAgIH0gZWxzZSB7CiAgICAgIGFjYy5wdXNoKGpvaW4uam9pblR5cGUgKyAnIGpvaW4gJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoam9pbi50YWJsZSkpOwogICAgICBfLmVhY2goam9pbi5jbGF1c2VzLCBmdW5jdGlvbihjbGF1c2UsIGkpIHsKICAgICAgICBhY2MucHVzaChpID4gMCA/IGNsYXVzZVsxXSA6IGNsYXVzZVswXSk7CiAgICAgICAgYWNjLnB1c2godGhpcy5mb3JtYXR0ZXIud3JhcChjbGF1c2VbMl0pKTsKICAgICAgICBpZiAoY2xhdXNlWzNdKSBhY2MucHVzaCh0aGlzLmZvcm1hdHRlci5vcGVyYXRvcihjbGF1c2VbM10pKTsKICAgICAgICBpZiAoY2xhdXNlWzRdKSBhY2MucHVzaCh0aGlzLmZvcm1hdHRlci53cmFwKGNsYXVzZVs0XSkpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgW10sIHRoaXMpOwogIHJldHVybiBzcWwubGVuZ3RoID4gMCA/IHNxbC5qb2luKCcgJykgOiAnJzsKfTsKCi8vIENvbXBpbGVzIGFsbCBgd2hlcmVgIHN0YXRlbWVudHMgb24gdGhlIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZSA9IGZ1bmN0aW9uKCkgewogIHZhciB3aGVyZXMgPSB0aGlzLmdyb3VwZWQud2hlcmU7CiAgaWYgKCF3aGVyZXMpIHJldHVybjsKICB2YXIgc3FsID0gW107CiAgc3FsWzBdID0gJ3doZXJlJzsKICBmb3IgKHZhciBpID0gMCwgbCA9IHdoZXJlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBzdG10ID0gd2hlcmVzW2ldOwogICAgaWYgKGkgIT09IDApIHNxbC5wdXNoKHN0bXQuYm9vbCk7CiAgICBzcWwucHVzaCh0aGlzW3N0bXQudHlwZV0oc3RtdCkpOwogIH0KICByZXR1cm4gc3FsLmxlbmd0aCA+IDEgPyBzcWwuam9pbignICcpIDogJyc7Cn07CgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5ncm91cCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9ncm91cHNPcmRlcnMoJ2dyb3VwJyk7Cn07ClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLm9yZGVyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2dyb3Vwc09yZGVycygnb3JkZXInKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBgaGF2aW5nYCBzdGF0ZW1lbnRzLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5oYXZpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgaGF2aW5ncyA9IHRoaXMuZ3JvdXBlZC5oYXZpbmc7CiAgaWYgKCFoYXZpbmdzKSByZXR1cm4gJyc7CiAgdmFyIHNxbCA9IFsnaGF2aW5nJ107CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBoYXZpbmdzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIHN0ciA9ICcnLCBzID0gaGF2aW5nc1tpXTsKICAgIGlmIChpICE9PSAwKSBzdHIgPSBzLmJvb2wgKyAnICc7CiAgICBpZiAocy50eXBlID09PSAnaGF2aW5nQmFzaWMnKSB7CiAgICAgIHNxbC5wdXNoKHN0ciArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShzLmNvbHVtbikgKyAnICcgKwogICAgICAgIHRoaXMuZm9ybWF0dGVyLm9wZXJhdG9yKHMub3BlcmF0b3IpICsgJyAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHMudmFsdWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIHNxbC5wdXNoKHN0ciArIHRoaXMuZm9ybWF0dGVyLmNoZWNrUmF3KHMudmFsdWUpKTsKICAgIH0KICB9CiAgcmV0dXJuIHNxbC5sZW5ndGggPiAxID8gc3FsLmpvaW4oJyAnKSA6ICcnOwp9OwoKLy8gQ29tcGlsZSB0aGUgInVuaW9uIiBxdWVyaWVzIGF0dGFjaGVkIHRvIHRoZSBtYWluIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS51bmlvbiA9IGZ1bmN0aW9uKCkgewogIHZhciBvbmx5VW5pb25zID0gdGhpcy5vbmx5VW5pb25zKCk7CiAgdmFyIHVuaW9ucyA9IHRoaXMuZ3JvdXBlZC51bmlvbjsKICBpZiAoIXVuaW9ucykgcmV0dXJuICcnOwogIHZhciBzcWwgPSAnJzsKICBmb3IgKHZhciBpID0gMCwgbCA9IHVuaW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciB1bmlvbiA9IHVuaW9uc1tpXTsKICAgIGlmIChpID4gMCkgc3FsICs9ICcgJzsKICAgIGlmIChpID4gMCB8fCAhb25seVVuaW9ucykgc3FsICs9IHVuaW9uLmNsYXVzZSArICcgJzsKICAgIHZhciBzdGF0ZW1lbnQgPSB0aGlzLmZvcm1hdHRlci5yYXdPckZuKHVuaW9uLnZhbHVlKTsKICAgIGlmIChzdGF0ZW1lbnQpIHsKICAgICAgaWYgKHVuaW9uLndyYXApIHNxbCArPSAnKCc7CiAgICAgIHNxbCArPSBzdGF0ZW1lbnQ7CiAgICAgIGlmICh1bmlvbi53cmFwKSBzcWwgKz0gJyknOwogICAgfQogIH0KICByZXR1cm4gc3FsOwp9OwoKLy8gSWYgd2UgaGF2ZW4ndCBzcGVjaWZpZWQgYW55IGNvbHVtbnMgb3IgYSBgdGFibGVOYW1lYCwgd2UncmUgYXNzdW1pbmcgdGhpcwovLyBpcyBvbmx5IGJlaW5nIHVzZWQgZm9yIHVuaW9ucy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUub25seVVuaW9ucyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAoIXRoaXMuZ3JvdXBlZC5jb2x1bW5zICYmIHRoaXMuZ3JvdXBlZC51bmlvbiAmJiAhdGhpcy50YWJsZU5hbWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUubGltaXQgPSBmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMuc2luZ2xlLmxpbWl0KSByZXR1cm4gJyc7CiAgcmV0dXJuICdsaW1pdCAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMuc2luZ2xlLmxpbWl0KTsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLm9mZnNldCA9IGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5zaW5nbGUub2Zmc2V0KSByZXR1cm4gJyc7CiAgcmV0dXJuICdvZmZzZXQgJyArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5vZmZzZXQpOwp9OwoKLy8gQ29tcGlsZXMgYSBgZGVsZXRlYCBxdWVyeS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuZGVsID0gZnVuY3Rpb24oKSB7CiAgdmFyIHdoZXJlcyA9IHRoaXMud2hlcmUoKTsKICByZXR1cm4gJ2RlbGV0ZSBmcm9tICcgKyB0aGlzLnRhYmxlTmFtZSArCiAgICAod2hlcmVzID8gJyAnICsgd2hlcmVzIDogJycpOwp9OwoKLy8gQ29tcGlsZXMgYSBgdHJ1bmNhdGVgIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAndHJ1bmNhdGUgJyArIHRoaXMudGFibGVOYW1lOwp9OwoKLy8gQ29tcGlsZXMgdGhlICJsb2NrcyIuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLmxvY2sgPSBmdW5jdGlvbigpIHsKICBpZiAodGhpcy5zaW5nbGUubG9jaykgewogICAgaWYgKCF0aGlzLnRyYW5zYWN0aW5nKSB7CiAgICAgIGhlbHBlcnMud2FybignWW91IGFyZSBhdHRlbXB0aW5nIHRvIHBlcmZvcm0gYSAibG9jayIgY29tbWFuZCBvdXRzaWRlIG9mIGEgdHJhbnNhY3Rpb24uJyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpc1t0aGlzLnNpbmdsZS5sb2NrXSgpOwogICAgfQogIH0KfTsKCi8vIENvbXBpbGUgdGhlICJjb3VudGVyIi4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuY291bnRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBjb3VudGVyID0gdGhpcy5zaW5nbGUuY291bnRlcjsKICB2YXIgdG9VcGRhdGUgPSB7fTsKICB0b1VwZGF0ZVtjb3VudGVyLmNvbHVtbl0gPSBuZXcgUmF3KHRoaXMuZm9ybWF0dGVyLndyYXAoY291bnRlci5jb2x1bW4pICsKICAgICcgJyArIChjb3VudGVyLnN5bWJvbCB8fCAnKycpICsKICAgICcgJyArIGNvdW50ZXIuYW1vdW50KTsKICB0aGlzLnNpbmdsZS51cGRhdGUgPSB0b1VwZGF0ZTsKICByZXR1cm4gdGhpcy51cGRhdGUoKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBgb3JkZXIgYnlgIHN0YXRlbWVudHMuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLl9ncm91cHNPcmRlcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGl0ZW1zID0gdGhpcy5ncm91cGVkW3R5cGVdOwogIGlmICghaXRlbXMpIHJldHVybiAnJzsKICB2YXIgZm9ybWF0dGVyID0gdGhpcy5mb3JtYXR0ZXI7CiAgdmFyIHNxbCA9IGl0ZW1zLm1hcChmdW5jdGlvbiAoaXRlbSkgewogICAgcmV0dXJuIChpdGVtLnZhbHVlIGluc3RhbmNlb2YgUmF3ID8gZm9ybWF0dGVyLmNoZWNrUmF3KGl0ZW0udmFsdWUpIDogZm9ybWF0dGVyLmNvbHVtbml6ZShpdGVtLnZhbHVlKSkgKwogICAgICAoKHR5cGUgPT09ICdvcmRlcicgJiYgaXRlbS50eXBlICE9PSAnb3JkZXJCeVJhdycpID8gJyAnICsgZm9ybWF0dGVyLmRpcmVjdGlvbihpdGVtLmRpcmVjdGlvbikgOiAnJyk7CiAgfSk7CiAgcmV0dXJuIHNxbC5sZW5ndGggPyB0eXBlICsgJyBieSAnICsgc3FsLmpvaW4oJywgJykgOiAnJzsKfTsKCi8vIFdoZXJlIENsYXVzZQovLyAtLS0tLS0KClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlSW4gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICBpZiAoXy5pc0FycmF5KHN0YXRlbWVudC5jb2x1bW4pKSByZXR1cm4gdGhpcy5tdWx0aVdoZXJlSW4oc3RhdGVtZW50KTsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArIHRoaXMuX25vdChzdGF0ZW1lbnQsICdpbiAnKSArCiAgICB0aGlzLndyYXAodGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKHN0YXRlbWVudC52YWx1ZSkpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUubXVsdGlXaGVyZUluID0gZnVuY3Rpb24oc3RhdGVtZW50KSB7CiAgcmV0dXJuICcoJyArIF8ubWFwKHN0YXRlbWVudC5jb2x1bW4sIHRoaXMuZm9ybWF0dGVyLndyYXAsIHRoaXMuZm9ybWF0dGVyKSArICcpICcgKwogICAgdGhpcy5fbm90KHN0YXRlbWVudCwgJ2luICcpICsgJygoJyArCiAgICBfLm1hcChzdGF0ZW1lbnQudmFsdWUsIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcml6ZSwgdGhpcy5mb3JtYXR0ZXIpLmpvaW4oJyksKCcpICsgJykpJzsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlTnVsbCA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKHN0YXRlbWVudC5jb2x1bW4pICsgJyBpcyAnICsgdGhpcy5fbm90KHN0YXRlbWVudCwgJ251bGwnKTsKfTsKCi8vIENvbXBpbGVzIGEgYmFzaWMgIndoZXJlIiBjbGF1c2UuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlQmFzaWMgPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArCiAgICB0aGlzLmZvcm1hdHRlci5vcGVyYXRvcihzdGF0ZW1lbnQub3BlcmF0b3IpICsgJyAnICsKICAgIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihzdGF0ZW1lbnQudmFsdWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUud2hlcmVFeGlzdHMgPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5fbm90KHN0YXRlbWVudCwgJ2V4aXN0cycpICsgJyAoJyArIHRoaXMuZm9ybWF0dGVyLnJhd09yRm4oc3RhdGVtZW50LnZhbHVlKSArICcpJzsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlV3JhcHBlZCA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiAnKCcgKyB0aGlzLmZvcm1hdHRlci5yYXdPckZuKHN0YXRlbWVudC52YWx1ZSwgJ3doZXJlJykuc2xpY2UoNikgKyAnKSc7Cn07CgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZUJldHdlZW4gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArIHRoaXMuX25vdChzdGF0ZW1lbnQsICdiZXR3ZWVuJykgKyAnICcgKwogICAgXy5tYXAoc3RhdGVtZW50LnZhbHVlLCB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIsIHRoaXMuZm9ybWF0dGVyKS5qb2luKCcgYW5kICcpOwp9OwoKLy8gQ29tcGlsZXMgYSAid2hlcmVSYXciIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZVJhdyA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci5jaGVja1JhdyhzdGF0ZW1lbnQudmFsdWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cikgewogIGlmIChzdHIuY2hhckF0KDApICE9PSAnKCcpIHJldHVybiAnKCcgKyBzdHIgKyAnKSc7CiAgcmV0dXJuIHN0cjsKfTsKCi8vIERldGVybWluZXMgd2hldGhlciB0byBhZGQgYSAibm90IiBwcmVmaXggdG8gdGhlIHdoZXJlIGNsYXVzZS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuX25vdCA9IGZ1bmN0aW9uKHN0YXRlbWVudCwgc3RyKSB7CiAgaWYgKHN0YXRlbWVudC5ub3QpIHJldHVybiAnbm90ICcgKyBzdHI7CiAgcmV0dXJuIHN0cjsKfTsKCi8vICJQcmVwcyIgdGhlIGluc2VydC4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuX3ByZXBJbnNlcnQgPSBmdW5jdGlvbihkYXRhKSB7CiAgdmFyIGlzUmF3ID0gdGhpcy5mb3JtYXR0ZXIucmF3T3JGbihkYXRhKTsKICBpZiAoaXNSYXcpIHJldHVybiBpc1JhdzsKICB2YXIgdmFsdWVzID0gW107CiAgdmFyIGNvbHVtbnMsIGNvbExpc3Q7CiAgaWYgKCFfLmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBkYXRhID8gW2RhdGFdIDogW107CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBkYXRhLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgIHZhciBzb3J0ZWQgPSBoZWxwZXJzLnNvcnRPYmplY3QoZGF0YVtpXSk7CiAgICBjb2x1bW5zID0gXy5wbHVjayhzb3J0ZWQsIDApOwogICAgY29sTGlzdCA9IGNvbExpc3QgfHwgY29sdW1uczsKICAgIGlmICghXy5pc0VxdWFsKGNvbHVtbnMsIGNvbExpc3QpKSB7CiAgICAgIHJldHVybiB0aGlzLl9wcmVwSW5zZXJ0KHRoaXMuX25vcm1hbGl6ZUluc2VydChkYXRhKSk7CiAgICB9CiAgICB2YWx1ZXMucHVzaChfLnBsdWNrKHNvcnRlZCwgMSkpOwogIH0KICByZXR1cm4gewogICAgY29sdW1uczogY29sdW1ucywKICAgIHZhbHVlczogdmFsdWVzCiAgfTsKfTsKCi8vIElmIHdlIGFyZSBydW5uaW5nIGFuIGluc2VydCB3aXRoIHZhcmlhYmxlIG9iamVjdCBrZXlzLCB3ZSBuZWVkIHRvIG5vcm1hbGl6ZQovLyBmb3IgdGhlIG1pc3Npbmcga2V5cywgcHJlc3VtYWJseSBzZXR0aW5nIHRoZSB2YWx1ZXMgdG8gdW5kZWZpbmVkLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5fbm9ybWFsaXplSW5zZXJ0ID0gZnVuY3Rpb24oZGF0YSkgewogIGlmICghXy5pc0FycmF5KGRhdGEpKSByZXR1cm4gXy5jbG9uZShkYXRhKTsKICB2YXIgZGVmYXVsdE9iaiA9IF8ucmVkdWNlKF8udW5pb24uYXBwbHkoXywgXy5tYXAoZGF0YSwgZnVuY3Rpb24odmFsKSB7CiAgICByZXR1cm4gXy5rZXlzKHZhbCk7CiAgfSkpLCBmdW5jdGlvbihtZW1vLCBrZXkpIHsKICAgIG1lbW9ba2V5XSA9IHZvaWQgMDsKICAgIHJldHVybiBtZW1vOwogIH0sIHt9KTsKICByZXR1cm4gXy5tYXAoZGF0YSwgZnVuY3Rpb24ocm93KSB7IHJldHVybiBfLmRlZmF1bHRzKHJvdywgZGVmYXVsdE9iaik7IH0pOwp9OwoKLy8gIlByZXBzIiB0aGUgdXBkYXRlLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5fcHJlcFVwZGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICB2YXIgdmFscyA9IFtdOwogIHZhciBzb3J0ZWQgPSBoZWxwZXJzLnNvcnRPYmplY3QoZGF0YSk7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBzb3J0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YWxzLnB1c2godGhpcy5mb3JtYXR0ZXIud3JhcChzb3J0ZWRbaV1bMF0pICsgJyA9ICcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIoc29ydGVkW2ldWzFdKSk7CiAgfQogIHJldHVybiB2YWxzOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBRdWVyeUNvbXBpbGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCIuLi9yYXciOjEwOCwibG9kYXNoIjoxMzB9XSwxMDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBKb2luQ2xhdXNlCi8vIC0tLS0tLS0KCi8vIFRoZSAiSm9pbkNsYXVzZSIgaXMgYW4gb2JqZWN0IGhvbGRpbmcgYW55IG5lY2Vzc2FyeSBpbmZvIGFib3V0IGEgam9pbiwKLy8gaW5jbHVkaW5nIHRoZSB0eXBlLCBhbmQgYW55IGFzc29jaWF0ZWQgdGFibGVzICYgY29sdW1ucyBiZWluZyBqb2luZWQuCmZ1bmN0aW9uIEpvaW5DbGF1c2UodGFibGUsIHR5cGUpIHsKICB0aGlzLnRhYmxlICAgID0gdGFibGU7CiAgdGhpcy5qb2luVHlwZSA9IHR5cGU7CiAgdGhpcy5jbGF1c2VzICA9IFtdOwogIHRoaXMuYW5kICAgICAgPSB0aGlzOwp9CgpKb2luQ2xhdXNlLnByb3RvdHlwZS5ncm91cGluZyA9ICdqb2luJzsKCi8vIEFkZHMgYW4gIm9uIiBjbGF1c2UgdG8gdGhlIGN1cnJlbnQgam9pbiBvYmplY3QuCkpvaW5DbGF1c2UucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmQpIHsKICB2YXIgZGF0YTsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMTogIGRhdGEgPSBbJ29uJywgdGhpcy5fYm9vbCgpLCBmaXJzdF07IGJyZWFrOwogICAgY2FzZSAyOiAgZGF0YSA9IFsnb24nLCB0aGlzLl9ib29sKCksIGZpcnN0LCAnPScsIG9wZXJhdG9yXTsgYnJlYWs7CiAgICBkZWZhdWx0OiBkYXRhID0gWydvbicsIHRoaXMuX2Jvb2woKSwgZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmRdOwogIH0KICB0aGlzLmNsYXVzZXMucHVzaChkYXRhKTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSAidXNpbmciIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luLgpKb2luQ2xhdXNlLnByb3RvdHlwZS51c2luZyA9IGZ1bmN0aW9uKHRhYmxlKSB7CiAgcmV0dXJuIHRoaXMuY2xhdXNlcy5wdXNoKFsndXNpbmcnLCB0aGlzLl9ib29sKCksIHRhYmxlXSk7Cn07CgovLyBBZGRzIGFuICJhbmQgb24iIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luIG9iamVjdC4KSm9pbkNsYXVzZS5wcm90b3R5cGUuYW5kT24gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5vbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKLy8gQWRkcyBhbiAib3Igb24iIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luIG9iamVjdC4KSm9pbkNsYXVzZS5wcm90b3R5cGUub3JPbiA9IGZ1bmN0aW9uKGZpcnN0LCBvcGVyYXRvciwgc2Vjb25kKSB7CiAgLypqc2hpbnQgdW51c2VkOiBmYWxzZSovCiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykub24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCi8vIEV4cGxpY2l0bHkgc2V0IHRoZSB0eXBlIG9mIGpvaW4sIHVzZWZ1bCB3aXRoaW4gYSBmdW5jdGlvbiB3aGVuIGNyZWF0aW5nIGEgZ3JvdXBlZCBqb2luLgpKb2luQ2xhdXNlLnByb3RvdHlwZS50eXBlID0gZnVuY3Rpb24odHlwZSkgewogIHRoaXMuam9pblR5cGUgPSB0eXBlOwogIHJldHVybiB0aGlzOwp9OwoKSm9pbkNsYXVzZS5wcm90b3R5cGUuX2Jvb2wgPSBmdW5jdGlvbihib29sKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHRoaXMuX2Jvb2xGbGFnID0gYm9vbDsKICAgIHJldHVybiB0aGlzOwogIH0KICB2YXIgcmV0ID0gdGhpcy5fYm9vbEZsYWcgfHwgJ2FuZCc7CiAgdGhpcy5fYm9vbEZsYWcgPSAnYW5kJzsKICByZXR1cm4gcmV0Owp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KEpvaW5DbGF1c2UucHJvdG90eXBlLCAnb3InLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKTsKICB9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBKb2luQ2xhdXNlOwp9LHt9XSwxMDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBBbGwgcHJvcGVydGllcyB3ZSBjYW4gdXNlIHRvIHN0YXJ0IGEgcXVlcnkgY2hhaW4KLy8gZnJvbSB0aGUgYGtuZXhgIG9iamVjdCwgZS5nLiBga25leC5zZWxlY3QoJyonKS5mcm9tKC4uLmAKbW9kdWxlLmV4cG9ydHMgPSBbCiAgJ3NlbGVjdCcsCiAgJ2FzJywKICAnY29sdW1ucycsCiAgJ2NvbHVtbicsCiAgJ2Zyb20nLAogICdpbnRvJywKICAndGFibGUnLAogICdkaXN0aW5jdCcsCiAgJ2pvaW4nLAogICdqb2luUmF3JywKICAnaW5uZXJKb2luJywKICAnbGVmdEpvaW4nLAogICdsZWZ0T3V0ZXJKb2luJywKICAncmlnaHRKb2luJywKICAncmlnaHRPdXRlckpvaW4nLAogICdvdXRlckpvaW4nLAogICdmdWxsT3V0ZXJKb2luJywKICAnY3Jvc3NKb2luJywKICAnd2hlcmUnLAogICdhbmRXaGVyZScsCiAgJ29yV2hlcmUnLAogICd3aGVyZVJhdycsCiAgJ3doZXJlV3JhcHBlZCcsCiAgJ29yV2hlcmVSYXcnLAogICd3aGVyZUV4aXN0cycsCiAgJ29yV2hlcmVFeGlzdHMnLAogICd3aGVyZU5vdEV4aXN0cycsCiAgJ29yV2hlcmVOb3RFeGlzdHMnLAogICd3aGVyZUluJywKICAnb3JXaGVyZUluJywKICAnd2hlcmVOb3RJbicsCiAgJ29yV2hlcmVOb3RJbicsCiAgJ3doZXJlTnVsbCcsCiAgJ29yV2hlcmVOdWxsJywKICAnd2hlcmVOb3ROdWxsJywKICAnb3JXaGVyZU5vdE51bGwnLAogICd3aGVyZUJldHdlZW4nLAogICd3aGVyZU5vdEJldHdlZW4nLAogICdvcldoZXJlQmV0d2VlbicsCiAgJ29yV2hlcmVOb3RCZXR3ZWVuJywKICAnZ3JvdXBCeScsCiAgJ2dyb3VwQnlSYXcnLAogICdvcmRlckJ5JywKICAnb3JkZXJCeVJhdycsCiAgJ3VuaW9uJywKICAndW5pb25BbGwnLAogICdoYXZpbmcnLAogICdoYXZpbmdSYXcnLAogICdvckhhdmluZycsCiAgJ29ySGF2aW5nUmF3JywKICAnb2Zmc2V0JywKICAnbGltaXQnLAogICdjb3VudCcsCiAgJ21pbicsCiAgJ21heCcsCiAgJ3N1bScsCiAgJ2F2ZycsCiAgJ2luY3JlbWVudCcsCiAgJ2RlY3JlbWVudCcsCiAgJ2ZpcnN0JywKICAnZGVidWcnLAogICdwbHVjaycsCiAgJ2luc2VydCcsCiAgJ3VwZGF0ZScsCiAgJ3JldHVybmluZycsCiAgJ2RlbCcsCiAgJ2RlbGV0ZScsCiAgJ3RydW5jYXRlJywKICAndHJhbnNhY3RpbmcnLAogICdjb25uZWN0aW9uJwpdOwp9LHt9XSwxMDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSYXcKLy8gLS0tLS0tLQp2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKZnVuY3Rpb24gUmF3KHNxbCwgYmluZGluZ3MpIHsKICBpZiAoc3FsICYmIHNxbC50b1NRTCkgewogICAgdmFyIG91dHB1dCA9IHNxbC50b1NRTCgpOwogICAgc3FsID0gb3V0cHV0LnNxbDsKICAgIGJpbmRpbmdzID0gb3V0cHV0LmJpbmRpbmdzOwogIH0KICB0aGlzLnNxbCA9IHNxbCArICcnOwogIHRoaXMuYmluZGluZ3MgPSBfLmlzQXJyYXkoYmluZGluZ3MpID8gYmluZGluZ3MgOgogICAgYmluZGluZ3MgPyBbYmluZGluZ3NdIDogW107CiAgdGhpcy5pbnRlcnBvbGF0ZUJpbmRpbmdzKCk7CiAgdGhpcy5fZGVidWcgICAgICAgPSB2b2lkIDA7CiAgdGhpcy5fdHJhbnNhY3RpbmcgPSB2b2lkIDA7Cn0KaW5oZXJpdHMoUmF3LCBFdmVudEVtaXR0ZXIpOwoKLy8gV3JhcHMgdGhlIGN1cnJlbnQgc3FsIHdpdGggYGJlZm9yZWAgYW5kIGBhZnRlcmAuClJhdy5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKGJlZm9yZSwgYWZ0ZXIpIHsKICB0aGlzLnNxbCA9IGJlZm9yZSArIHRoaXMuc3FsICsgYWZ0ZXI7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBDYWxscyBgdG9TdHJpbmdgIG9uIHRoZSBLbmV4IG9iamVjdC4KUmF3LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnRvUXVlcnkoKTsKfTsKCi8vIEVuc3VyZSBhbGwgUmF3IC8gYnVpbGRlciBiaW5kaW5ncyBhcmUgbWl4ZWQtaW4gdG8gdGhlID8gcGxhY2Vob2xkZXJzCi8vIGFzIGFwcHJvcHJpYXRlLgpSYXcucHJvdG90eXBlLmludGVycG9sYXRlQmluZGluZ3MgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVwbGFjZW1lbnRzID0gW107CiAgdGhpcy5iaW5kaW5ncyA9IF8ucmVkdWNlKHRoaXMuYmluZGluZ3MsIGZ1bmN0aW9uKGFjY3VtLCBwYXJhbSwgaW5kZXgpIHsKICAgIHZhciBpbm5lckJpbmRpbmdzID0gW3BhcmFtXTsKICAgIGlmIChwYXJhbSAmJiBwYXJhbS50b1NRTCkgewogICAgICB2YXIgcmVzdWx0ICAgID0gdGhpcy5zcGxpY2VyKHBhcmFtLCBpbmRleCk7CiAgICAgIGlubmVyQmluZGluZ3MgPSByZXN1bHQuYmluZGluZ3M7CiAgICAgIHJlcGxhY2VtZW50cy5wdXNoKHJlc3VsdC5yZXBsYWNlcik7CiAgICB9CiAgICByZXR1cm4gYWNjdW0uY29uY2F0KGlubmVyQmluZGluZ3MpOwogIH0sIFtdLCB0aGlzKTsKCiAgLy8gd2UgcnVuIHRoaXMgaW4gcmV2ZXJzZSBvcmRlciwgYmVjYXVzZSA/IGNvbmNhdHMgZWFybGllciBpbiB0aGUKICAvLyBxdWVyeSBzdHJpbmcgd2lsbCBkaXNydXB0IGluZGljZXMgZm9yIGxhdGVyIG9uZXMKICB0aGlzLnNxbCA9IF8ucmVkdWNlKHJlcGxhY2VtZW50cy5yZXZlcnNlKCksIGZ1bmN0aW9uKGFjY3VtLCBmbikgewogICAgcmV0dXJuIGZuKGFjY3VtKTsKICB9LCB0aGlzLnNxbC5zcGxpdCgnPycpKS5qb2luKCc/Jyk7Cn07CgovLyBSZXR1cm5zIGEgcmVwbGFjZXIgZnVuY3Rpb24gdGhhdCBzcGxpY2VzIGludG8gdGhlIGkndGgKLy8gPyBpbiB0aGUgc3FsIHN0cmluZyB0aGUgaW5uZXIgcmF3J3Mgc3FsLAovLyBhbmQgdGhlIGJpbmRpbmdzIGFzc29jaWF0ZWQgd2l0aCBpdApSYXcucHJvdG90eXBlLnNwbGljZXIgPSBmdW5jdGlvbihyYXcsIGkpIHsKICB2YXIgb2JqID0gcmF3LnRvU1FMKCk7CgogIC8vIHRoZSByZXBsYWNlciBmdW5jdGlvbiBhc3N1bWVzIHRoYXQgdGhlIHNxbCBoYXMgYmVlbgogIC8vIGFscmVhZHkgc3FsLnNwbGl0KCc/JykgYW5kIHdpbGwgYmUgYXJyLmpvaW4oJz8nKQogIHZhciByZXBsYWNlciA9IGZ1bmN0aW9uKGFycikgewogICAgYXJyW2ldID0gYXJyW2ldICsgb2JqLnNxbCArIGFycltpICsgMV07CiAgICBhcnIuc3BsaWNlKGkgKyAxLCAxKTsKICAgIHJldHVybiBhcnI7CiAgfTsKCiAgcmV0dXJuIHsKICAgIHJlcGxhY2VyOiByZXBsYWNlciwKICAgIGJpbmRpbmdzOiBvYmouYmluZGluZ3MKICB9Owp9OwoKLy8gUmV0dXJucyB0aGUgcmF3IHNxbCBmb3IgdGhlIHF1ZXJ5LgpSYXcucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHNxbDogdGhpcy5zcWwsCiAgICBtZXRob2Q6ICdyYXcnLAogICAgYmluZGluZ3M6IHRoaXMuYmluZGluZ3MKICB9Owp9OwoKLy8gQWxsb3cgdGhlIGBSYXdgIG9iamVjdCB0byBiZSB1dGlsaXplZCB3aXRoIGZ1bGwgYWNjZXNzIHRvIHRoZSByZWxldmFudAovLyBwcm9taXNlIEFQSS4KcmVxdWlyZSgnLi9pbnRlcmZhY2UnKShSYXcpOwoKbW9kdWxlLmV4cG9ydHMgPSBSYXc7Cn0seyIuL2ludGVyZmFjZSI6MTAwLCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTA5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSAgICAgID0gcmVxdWlyZSgnLi9wcm9taXNlJyk7CgovLyBUaGUgIlJ1bm5lciIgY29uc3RydWN0b3IgdGFrZXMgYSAiYnVpbGRlciIgKHF1ZXJ5LCBzY2hlbWEsIG9yIHJhdykKLy8gYW5kIHJ1bnMgdGhyb3VnaCBlYWNoIG9mIHRoZSBxdWVyeSBzdGF0ZW1lbnRzLCBjYWxsaW5nIGFueSBhZGRpdGlvbmFsCi8vICJvdXRwdXQiIG1ldGhvZCBwcm92aWRlZCBhbG9uZ3NpZGUgdGhlIHF1ZXJ5IGFuZCBiaW5kaW5ncy4KZnVuY3Rpb24gUnVubmVyKGJ1aWxkZXIpIHsKICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogIHRoaXMucXVlcmllcyA9IFtdOwoKICAvLyBUaGUgImNvbm5lY3Rpb24iIG9iamVjdCBpcyBzZXQgb24gdGhlIHJ1bm5lciB3aGVuCiAgLy8gInJ1biIgaXMgY2FsbGVkLgogIHRoaXMuY29ubmVjdGlvbiA9IHZvaWQgMDsKfQoKUnVubmVyLnByb3RvdHlwZS5fYmVnaW5UcmFuc2FjdGlvbiA9ICdiZWdpbjsnOwpSdW5uZXIucHJvdG90eXBlLl9jb21taXRUcmFuc2FjdGlvbiA9ICdjb21taXQ7JzsKUnVubmVyLnByb3RvdHlwZS5fcm9sbGJhY2tUcmFuc2FjdGlvbiA9ICdyb2xsYmFjazsnOwoKLy8gIlJ1biIgdGhlIHRhcmdldCwgY2FsbGluZyAidG9TUUwiIG9uIHRoZSBidWlsZGVyLCByZXR1cm5pbmcKLy8gYW4gb2JqZWN0IG9yIGFycmF5IG9mIHF1ZXJpZXMgdG8gcnVuLCBlYWNoIG9mIHdoaWNoIGFyZSBydW4gb24KLy8gYSBzaW5nbGUgY29ubmVjdGlvbi4KUnVubmVyLnByb3RvdHlwZS5ydW4gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAodGhpcy5idWlsZGVyLl90cmFuc2FjdGluZykgewogICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25RdWVyeSgpOwogIH0KICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CgogICAgICAvLyBFbWl0IGEgInN0YXJ0IiBldmVudCBvbiBib3RoIHRoZSBidWlsZGVyIGFuZCB0aGUgY2xpZW50LAogICAgICAvLyBhbGxvd2luZyB1cyB0byBsaXN0ZW4gaW4gb24gYW55IGV2ZW50cy4gV2UgZmlyZSBvbiB0aGUgImNsaWVudCIKICAgICAgLy8gYmVmb3JlIGJ1aWxkaW5nIHRoZSBTUUwsIGFuZCBvbiB0aGUgYnVpbGRlciBhZnRlciBidWlsZGluZyB0aGUgU1FMCiAgICAgIC8vIGluIGNhc2Ugd2Ugd2FudCB0byBkZXRlcm1pbmUgYXQgaG93IGxvbmcgaXQgYWN0dWFsbHkKICAgICAgLy8gdG9vayB0byBidWlsZCB0aGUgcXVlcnkuCiAgICAgIHRoaXMuY2xpZW50LmVtaXQoJ3N0YXJ0JywgdGhpcy5idWlsZGVyKTsKICAgICAgdmFyIHNxbCA9IHRoaXMuYnVpbGRlci50b1NRTCgpOwogICAgICB0aGlzLmJ1aWxkZXIuZW1pdCgnc3RhcnQnLCB0aGlzLmJ1aWxkZXIpOwoKICAgICAgaWYgKF8uaXNBcnJheShzcWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlBcnJheShzcWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHNxbCk7CiAgICB9KQoKICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgImVycm9yIiBsaXN0ZW5lcnMsIHdlIGZpcmUgYW4gZXJyb3IgZXZlbnQKICAgIC8vIGFuZCB0aGVuIHJlLXRocm93IHRoZSBlcnJvciB0byBiZSBldmVudHVhbGx5IGhhbmRsZWQgYnkKICAgIC8vIHRoZSBwcm9taXNlIGNoYWluLiBVc2VmdWwgaWYgeW91J3JlIHdyYXBwaW5nIGluIGEgY3VzdG9tIGBQcm9taXNlYC4KICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKHRoaXMuYnVpbGRlci5fZXZlbnRzICYmIHRoaXMuYnVpbGRlci5fZXZlbnRzLmVycm9yKSB7CiAgICAgICAgdGhpcy5idWlsZGVyLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfQogICAgICB0aHJvdyBlcnI7CiAgICB9KQoKICAgIC8vIEZpcmUgYSBzaW5nbGUgImVuZCIgZXZlbnQgb24gdGhlIGJ1aWxkZXIgd2hlbgogICAgLy8gYWxsIHF1ZXJpZXMgaGF2ZSBzdWNjZXNzZnVsbHkgY29tcGxldGVkLgogICAgLnRhcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5idWlsZGVyLmVtaXQoJ2VuZCcpOwogICAgfSkKICAgIC5maW5hbGx5KHRoaXMuY2xlYW51cENvbm5lY3Rpb24pOwp9KTsKCi8vIFN0cmVhbSB0aGUgcmVzdWx0IHNldCwgYnkgcGFzc2luZyB0aHJvdWdoIHRvIHRoZSBkaWFsZWN0J3Mgc3RyZWFtaW5nCi8vIGNhcGFiaWxpdGllcy4gSWYgdGhlIG9wdGlvbnMgYXJlCnZhciBQYXNzVGhyb3VnaDsKUnVubmVyLnByb3RvdHlwZS5zdHJlYW0gPSBmdW5jdGlvbihvcHRpb25zLCBoYW5kbGVyKSB7CiAgLy8gSWYgd2Ugc3BlY2lmeSBzdHJlYW0oaGFuZGxlcikudGhlbiguLi4KICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgaWYgKF8uaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICBoYW5kbGVyID0gb3B0aW9uczsKICAgICAgb3B0aW9ucyA9IHt9OwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIHdlIGVtaXQgYW4gZXJyb3Igb3IgdGhyb3cgaGVyZS4KICB2YXIgaGFzSGFuZGxlciA9IF8uaXNGdW5jdGlvbihoYW5kbGVyKTsKCiAgLy8gTGF6eS1sb2FkIHRoZSAiUGFzc1Rocm91Z2giIGRlcGVuZGVuY3kuCiAgUGFzc1Rocm91Z2ggPSBQYXNzVGhyb3VnaCB8fCByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0nKS5QYXNzVGhyb3VnaDsKICB2YXIgc3RyZWFtICA9IG5ldyBQYXNzVGhyb3VnaCh7b2JqZWN0TW9kZTogdHJ1ZX0pOwogIHZhciBwcm9taXNlID0gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgICAgIHZhciBzcWwgPSB0aGlzLmJ1aWxkZXIudG9TUUwoKTsKICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVGhlIHN0cmVhbSBtYXkgb25seSBiZSB1c2VkIHdpdGggYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LicpOwogICAgICBpZiAoXy5pc0FycmF5KHNxbCkpIHsKICAgICAgICBpZiAoaGFzSGFuZGxlcikgdGhyb3cgZXJyOwogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNxbDsKICAgIH0pLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdHJlYW0oc3FsLCBzdHJlYW0sIG9wdGlvbnMpOwogICAgfSkuZmluYWxseSh0aGlzLmNsZWFudXBDb25uZWN0aW9uKTsKCiAgLy8gSWYgYSBmdW5jdGlvbiBpcyBwYXNzZWQgdG8gaGFuZGxlIHRoZSBzdHJlYW0sIHNlbmQgdGhlIHN0cmVhbQogIC8vIHRoZXJlIGFuZCByZXR1cm4gdGhlIHByb21pc2UsIG90aGVyd2lzZSBqdXN0IHJldHVybiB0aGUgc3RyZWFtCiAgLy8gYW5kIHRoZSBwcm9taXNlIHdpbGwgdGFrZSBjYXJlIG9mIGl0c3NlbGYuCiAgaWYgKGhhc0hhbmRsZXIpIHsKICAgIGhhbmRsZXIoc3RyZWFtKTsKICAgIHJldHVybiBwcm9taXNlOwogIH0KICByZXR1cm4gc3RyZWFtOwp9OwoKLy8gQWxsb3cgeW91IHRvIHBpcGUgdGhlIHN0cmVhbSB0byBhIHdyaXRhYmxlIHN0cmVhbS4KUnVubmVyLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24od3JpdGFibGUpIHsKICByZXR1cm4gdGhpcy5zdHJlYW0oKS5waXBlKHdyaXRhYmxlKTsKfTsKCi8vICJSdW5zIiBhIHF1ZXJ5LCByZXR1cm5pbmcgYSBwcm9taXNlLiBBbGwgcXVlcmllcyBzcGVjaWZpZWQgYnkgdGhlIGJ1aWxkZXIgYXJlIGd1YXJhbnRlZWQKLy8gdG8gcnVuIGluIHNlcXVlbmNlLCBhbmQgb24gdGhlIHNhbWUgY29ubmVjdGlvbiwgZXNwZWNpYWxseSBoZWxwZnVsIHdoZW4gc2NoZW1hIGJ1aWxkaW5nCi8vIGFuZCBkZWFsaW5nIHdpdGggZm9yZWlnbiBrZXkgY29uc3RyYWludHMsIGV0Yy4KUnVubmVyLnByb3RvdHlwZS5xdWVyeSA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9iaikgewogIGlmICghdGhpcy5jb25uZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIGFuIGVycm9yIHdpdGggdGhlIGRhdGFiYXNlIGNvbm5lY3Rpb24uIFBsZWFzZSBjaGVjayB5b3VyIGNvbmZpZy4nKTsKICB9CiAgb2JqLl9fY2lkID0gdGhpcy5jb25uZWN0aW9uLl9fY2lkOwogIHRoaXMuYnVpbGRlci5lbWl0KCdxdWVyeScsIG9iaik7CiAgdGhpcy5jbGllbnQuZW1pdCgncXVlcnknLCBvYmopOwogIHJldHVybiB0aGlzLl9xdWVyeShvYmopLmJpbmQodGhpcykudGhlbih0aGlzLnByb2Nlc3NSZXNwb25zZSk7Cn0pOwoKLy8gSW4gdGhlIGNhc2Ugb2YgdGhlICJzY2hlbWEgYnVpbGRlciIgd2UgY2FsbCBgcXVlcnlBcnJheWAsIHdoaWNoIHJ1bnMgZWFjaAovLyBvZiB0aGUgcXVlcmllcyBpbiBzZXF1ZW5jZS4KUnVubmVyLnByb3RvdHlwZS5xdWVyeUFycmF5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ocXVlcmllcykgewogIHJldHVybiBxdWVyaWVzLmxlbmd0aCA9PT0gMSA/IHRoaXMucXVlcnkocXVlcmllc1swXSkgOiBQcm9taXNlLmJpbmQodGhpcykKICAgIC50aGVuUmV0dXJuKHF1ZXJpZXMpCiAgICAucmVkdWNlKGZ1bmN0aW9uKG1lbW8sIHF1ZXJ5KSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHF1ZXJ5KS50aGVuKGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBtZW1vLnB1c2gocmVzcCk7CiAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgIH0pOwogICAgfSwgW10pOwp9KTsKCi8vIENoZWNrIHdoZXRoZXIgdGhlcmUncyBhIHRyYW5zYWN0aW9uIGZsYWcsIGFuZCB0aGF0IGl0IGhhcyBhIGNvbm5lY3Rpb24uClJ1bm5lci5wcm90b3R5cGUuZW5zdXJlQ29ubmVjdGlvbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkgewogIGlmICh0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb24pIHsKICAgIHJldHVybiB0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb247CiAgfQogIHJldHVybiB0aGlzLmNsaWVudC5hY3F1aXJlQ29ubmVjdGlvbigpOwp9KTsKCi8vICJEZWJ1ZyIgdGhlIHF1ZXJ5IGJlaW5nIHJ1bi4KUnVubmVyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uKG9iaikgewogIGNvbnNvbGUuZGlyKF8uZXh0ZW5kKHtfX2NpZDogdGhpcy5jb25uZWN0aW9uLl9fY2lkfSwgb2JqKSk7Cn07CgovLyBDaGVjayB3aGV0aGVyIHdlJ3JlICJkZWJ1Z2dpbmciLCBiYXNlZCBvbiBlaXRoZXIgY2FsbGluZyBgZGVidWdgIG9uIHRoZSBxdWVyeS4KUnVubmVyLnByb3RvdHlwZS5pc0RlYnVnZ2luZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAodGhpcy5jbGllbnQuaXNEZWJ1Z2dpbmcgPT09IHRydWUgfHwgdGhpcy5idWlsZGVyLl9kZWJ1ZyA9PT0gdHJ1ZSk7Cn07CgovLyBUcmFuc2FjdGlvbiBNZXRob2RzOgovLyAtLS0tLS0tCgovLyBSdW4gdGhlIHRyYW5zYWN0aW9uIG9uIHRoZSBjb3JyZWN0ICJydW5uZXIiIGluc3RhbmNlLgpSdW5uZXIucHJvdG90eXBlLnRyYW5zYWN0aW9uUXVlcnkgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgcnVubmVyID0gdGhpcy5idWlsZGVyLl90cmFuc2FjdGluZy5fcnVubmVyOwogIGlmICghKHJ1bm5lciBpbnN0YW5jZW9mIFJ1bm5lcikpIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0cmFuc2FjdGlvbiBvYmplY3QgcHJvdmlkZWQuJyk7CiAgfQogIHZhciBzcWwgPSB0aGlzLmJ1aWxkZXIudG9TUUwoKTsKICBpZiAoXy5pc0FycmF5KHNxbCkpIHsKICAgIHJldHVybiBydW5uZXIucXVlcnlBcnJheShzcWwpOwogIH0KICByZXR1cm4gcnVubmVyLnF1ZXJ5KHNxbCk7Cn0pOwoKLy8gQmVnaW5zIGEgdHJhbnNhY3Rpb24gc3RhdGVtZW50IG9uIHRoZSBpbnN0YW5jZSwKLy8gcmVzb2x2aW5nIHdpdGggdGhlIGN1cnJlbnQgcnVubmVyLgpSdW5uZXIucHJvdG90eXBlLnN0YXJ0VHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiAgPSBjb25uZWN0aW9uOwogICAgICB0aGlzLnRyYW5zYWN0aW9uID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuYmVnaW5UcmFuc2FjdGlvbigpOwogICAgfSkudGhlblJldHVybih0aGlzKTsKfSk7CgovLyBGaW5pc2hlcyB0aGUgdHJhbnNhY3Rpb24gc3RhdGVtZW50IGFuZCBoYW5kbGVzIGRpc3Bvc2luZyBvZiB0aGUgY29ubmVjdGlvbiwKLy8gcmVzb2x2aW5nIC8gcmVqZWN0aW5nIHRoZSB0cmFuc2FjdGlvbidzIHByb21pc2UsIGFuZCBlbnN1cmluZyB0aGUgdHJhbnNhY3Rpb24gb2JqZWN0J3MKLy8gYF9ydW5uZXJgIHByb3BlcnR5IGlzIGBudWxsYCdlZCBvdXQgc28gaXQgY2Fubm90IGNvbnRpbnVlIHRvIGJlIHVzZWQuClJ1bm5lci5wcm90b3R5cGUuZmluaXNoVHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihhY3Rpb24sIGNvbnRhaW5lck9iamVjdCwgbXNnKSB7CiAgdmFyIHF1ZXJ5LCBkZmQgPSBjb250YWluZXJPYmplY3QuX19kZmRfXzsKCiAgLy8gUnVuIHRoZSBxdWVyeSB0byBjb21taXQgLyByb2xsYmFjayB0aGUgdHJhbnNhY3Rpb24uCiAgc3dpdGNoIChhY3Rpb24pIHsKICAgIGNhc2UgMDoKICAgICAgcXVlcnkgPSB0aGlzLmNvbW1pdFRyYW5zYWN0aW9uKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICBxdWVyeSA9IHRoaXMucm9sbGJhY2tUcmFuc2FjdGlvbigpOwogICAgICBicmVhazsKICB9CgogIHJldHVybiBxdWVyeS50aGVuKGZ1bmN0aW9uKHJlc3ApIHsKICAgIG1zZyA9IChtc2cgPT09IHZvaWQgMCkgPyByZXNwIDogbXNnOwogICAgc3dpdGNoIChhY3Rpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGRmZC5mdWxmaWxsKG1zZyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICBkZmQucmVqZWN0KG1zZyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogIC8vIElmIHRoZXJlIHdhcyBhIHByb2JsZW0gY29tbWl0dGluZyB0aGUgdHJhbnNhY3Rpb24sCiAgLy8gcmVqZWN0IHRoZSB0cmFuc2FjdGlvbiBibG9jayAodG8gcmVqZWN0IHRoZSBlbnRpcmUgdHJhbnNhY3Rpb24gYmxvY2spLAogIC8vIHRoZW4gcmUtdGhyb3cgdGhlIGVycm9yIGZvciBhbnkgcHJvbWlzZXMgY2hhaW5lZCBvZmYgdGhlIGNvbW1pdC4KICB9KS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICBkZmQucmVqZWN0KGUpOwogICAgdGhyb3cgZTsKICB9KS5iaW5kKHRoaXMpLmZpbmFsbHkoZnVuY3Rpb24oKSB7CgogICAgLy8gS2lsbCB0aGUgIl9ydW5uZXIiIG9iamVjdCBvbiB0aGUgY29udGFpbmVyT2JqZWN0LAogICAgLy8gc28gaXQncyBub3QgcG9zc2libGUgdG8gY29udGludWUgdXNpbmcgdGhlIHRyYW5zYWN0aW9uIG9iamVjdC4KICAgIGNvbnRhaW5lck9iamVjdC5fcnVubmVyID0gdm9pZCAwOwoKICAgIHJldHVybiB0aGlzLmNsZWFudXBDb25uZWN0aW9uKCk7CiAgfSk7Cn0pOwoKUnVubmVyLnByb3RvdHlwZS5iZWdpblRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2JlZ2luVHJhbnNhY3Rpb24gICAmJiB0aGlzLnF1ZXJ5KHtzcWw6IHRoaXMuX2JlZ2luVHJhbnNhY3Rpb259KTsKfTsKUnVubmVyLnByb3RvdHlwZS5jb21taXRUcmFuc2FjdGlvbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9jb21taXRUcmFuc2FjdGlvbiAgICYmIHRoaXMucXVlcnkoe3NxbDogdGhpcy5fY29tbWl0VHJhbnNhY3Rpb259KTsKfTsKUnVubmVyLnByb3RvdHlwZS5yb2xsYmFja1RyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX3JvbGxiYWNrVHJhbnNhY3Rpb24gJiYgdGhpcy5xdWVyeSh7c3FsOiB0aGlzLl9yb2xsYmFja1RyYW5zYWN0aW9ufSk7Cn07CgovLyBDbGVhbnVwIHRoZSBjb25uZWN0aW9uIGFzIG5lY2Vzc2FyeSwgaWYgdGhlIGBfY29ubmVjdGlvbmAgd2FzCi8vIGV4cGxpY2l0bHkgc2V0IG9uIHRoZSBxdWVyeSB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nIGhlcmUsCi8vIG90aGVyd2lzZSB3ZQpSdW5uZXIucHJvdG90eXBlLmNsZWFudXBDb25uZWN0aW9uID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgaWYgKCF0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb24gJiYgdHlwZW9mIHRoaXMuY29ubmVjdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgIHJldHVybiB0aGlzLmNsaWVudC5yZWxlYXNlQ29ubmVjdGlvbih0aGlzLmNvbm5lY3Rpb24pOwogIH0KfSk7Cgptb2R1bGUuZXhwb3J0cyA9IFJ1bm5lcjsKCn0seyIuL3Byb21pc2UiOjEwMywibG9kYXNoIjoxMzAsInJlYWRhYmxlLXN0cmVhbSI6MTI5fV0sMTEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCi8vIENvbnN0cnVjdG9yIGZvciB0aGUgYnVpbGRlciBpbnN0YW5jZSwgdHlwaWNhbGx5IGNhbGxlZCBmcm9tCi8vIGBrbmV4LmJ1aWxkZXJgLCBhY2NlcHRpbmcgdGhlIGN1cnJlbnQgYGtuZXhgIGluc3RhbmNlLAovLyBhbmQgcHVsbGluZyBvdXQgdGhlIGBjbGllbnRgIGFuZCBgZ3JhbW1hcmAgZnJvbSB0aGUgY3VycmVudAovLyBrbmV4IGluc3RhbmNlLgpmdW5jdGlvbiBTY2hlbWFCdWlsZGVyKCkgewogIHRoaXMuX3NlcXVlbmNlID0gW107CiAgdGhpcy5fZXJyb3JzID0gW107Cn0KaW5oZXJpdHMoU2NoZW1hQnVpbGRlciwgRXZlbnRFbWl0dGVyKTsKCi8vIEVhY2ggb2YgdGhlIHNjaGVtYSBidWlsZGVyIG1ldGhvZHMganVzdCBhZGQgdG8gdGhlCi8vICJfc2VxdWVuY2UiIGFycmF5IGZvciBjb25zaXN0ZW5jeS4KXy5lYWNoKFsKICAnY3JlYXRlVGFibGUnLCAnY3JlYXRlVGFibGVJZk5vdEV4aXN0cycsICdjcmVhdGVTY2hlbWEnLAogICdjcmVhdGVTY2hlbWFJZk5vdEV4aXN0cycsICdkcm9wU2NoZW1hJywgJ2Ryb3BTY2hlbWFJZkV4aXN0cycsCiAgJ3RhYmxlJywgJ2FsdGVyVGFibGUnLCAnaGFzVGFibGUnLCAnaGFzQ29sdW1uJywKICAnZHJvcFRhYmxlJywgJ3JlbmFtZVRhYmxlJywgJ2Ryb3BUYWJsZUlmRXhpc3RzJywgJ3JhdycsICdkZWJ1ZycKXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgU2NoZW1hQnVpbGRlci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKG1ldGhvZCA9PT0gJ3RhYmxlJykgbWV0aG9kID0gJ2FsdGVyVGFibGUnOwogICAgdGhpcy5fc2VxdWVuY2UucHVzaCh7CiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBhcmdzOiBfLnRvQXJyYXkoYXJndW1lbnRzKQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKClNjaGVtYUJ1aWxkZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMudG9RdWVyeSgpOwp9OwoKU2NoZW1hQnVpbGRlci5wcm90b3R5cGUudG9TUUwgPSBmdW5jdGlvbigpIHsKICB2YXIgU2NoZW1hQ29tcGlsZXIgPSB0aGlzLmNsaWVudC5TY2hlbWFDb21waWxlcjsKICByZXR1cm4gbmV3IFNjaGVtYUNvbXBpbGVyKHRoaXMpLnRvU1FMKCk7Cn07CgpyZXF1aXJlKCcuLi9pbnRlcmZhY2UnKShTY2hlbWFCdWlsZGVyKTsKCm1vZHVsZS5leHBvcnRzID0gU2NoZW1hQnVpbGRlcjsKCn0seyIuLi9pbnRlcmZhY2UiOjEwMCwiZXZlbnRzIjo1NywiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDExMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cgp2YXIgQWx0ZXJNZXRob2RzID0ge307CgovLyBTcGVjaWZ5IHRoYXQgdGhlIGNvbHVtbiBpcyB0byBiZSBkcm9wcGVkLiBUaGlzIHRha2VzIHByZWNlZGVuY2UKLy8gb3ZlciBhbGwgb3RoZXIgcnVsZXMgZm9yIHRoZSBjb2x1bW4uCkFsdGVyTWV0aG9kcy5kcm9wID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5fc2luZ2xlLmRyb3AgPSB0cnVlOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU3BlY2lmeSB0aGUgInR5cGUiIHRoYXQgd2UncmUgbG9va2luZyB0byBzZXQgdGhlCi8vIEtuZXggdGFrZXMgbm8gcmVzcG9uc2liaWxpdHkgZm9yIGFueSBkYXRhLWxvc3MgdGhhdCBtYXkKLy8gb2NjdXIgd2hlbiBjaGFuZ2luZyBkYXRhIHR5cGVzLgpBbHRlck1ldGhvZHMuYWx0ZXJUeXBlID0gZnVuY3Rpb24odHlwZSkgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2FsdGVyVHlwZScsCiAgICB2YWx1ZTogdHlwZQogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWxsIG9mIHRoZSBtb2RpZmllciBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgdG8gbW9kaWZ5IHRoZSBjdXJyZW50IHF1ZXJ5Lgp2YXIgbW9kaWZpZXJzID0gWwogICdkZWZhdWx0JywgJ2RlZmF1bHRzVG8nLCAnZGVmYXVsdFRvJywgJ3Vuc2lnbmVkJywKICAnbnVsbGFibGUnLCAnbm90TnVsbCcsICdub3ROdWxsYWJsZScsCiAgJ2ZpcnN0JywgJ2FmdGVyJywgJ2NvbW1lbnQnCl07CgovLyBBbGlhc2VzIGZvciBjb252ZW5pZW5jZS4KdmFyIGFsaWFzTWV0aG9kID0gewogIGRlZmF1bHQ6ICdkZWZhdWx0VG8nLAogIGRlZmF1bHRzVG86ICdkZWZhdWx0VG8nLAogIG5vdE51bGw6ICdub3ROdWxsYWJsZScKfTsKCi8vIEFsaWFzIGEgZmV3IG1ldGhvZHMgZm9yIGNsYXJpdHkgd2hlbiBwcm9jZXNzaW5nLgp2YXIgY29sdW1uQWxpYXMgPSB7CiAgJ2Zsb2F0JyAgOiAnZmxvYXRpbmcnLAogICdlbnVtJyAgIDogJ2VudScsCiAgJ2Jvb2xlYW4nOiAnYm9vbCcsCiAgJ3N0cmluZycgOiAndmFyY2hhcicsCiAgJ2JpZ2ludCcgOiAnYmlnSW50ZWdlcicKfTsKCi8vIFRoZSBjaGFpbmFibGUgaW50ZXJmYWNlIG9mZiB0aGUgb3JpZ2luYWwgImNvbHVtbiIgbWV0aG9kLgpmdW5jdGlvbiBDb2x1bW5CdWlsZGVyKHRhYmxlQnVpbGRlciwgdHlwZSwgYXJncykgewogIHRoaXMuX3NpbmdsZSAgICAgICA9IHt9OwogIHRoaXMuX21vZGlmaWVycyAgICA9IHt9OwogIHRoaXMuX3N0YXRlbWVudHMgICA9IFtdOwogIHRoaXMuX3R5cGUgICAgICAgICA9IGNvbHVtbkFsaWFzW3R5cGVdIHx8IHR5cGU7CiAgdGhpcy5fYXJncyAgICAgICAgID0gYXJnczsKICB0aGlzLl90YWJsZUJ1aWxkZXIgPSB0YWJsZUJ1aWxkZXI7CgogIC8vIElmIHdlJ3JlIGFsdGVyaW5nIHRoZSB0YWJsZSwgZXh0ZW5kIHRoZSBvYmplY3QKICAvLyB3aXRoIHRoZSBhdmFpbGFibGUgImFsdGVyIiBtZXRob2RzLgogIGlmICh0YWJsZUJ1aWxkZXIuX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgXy5leHRlbmQodGhpcywgQWx0ZXJNZXRob2RzKTsKICB9Cn0KCi8vIElmIHdlIGNhbGwgYW55IG9mIHRoZSBtb2RpZmllcnMgKGluZGV4IG9yIG90aGVyd2lzZSkgb24gdGhlIGNoYWluYWJsZSwgd2UgcHJldGVuZAovLyBhcyB0aG91Z2ggd2UncmUgY2FsbGluZyBgdGFibGUubWV0aG9kKGNvbHVtbilgIGRpcmVjdGx5LgpfLmVhY2gobW9kaWZpZXJzLCBmdW5jdGlvbihtZXRob2QpIHsKICBDb2x1bW5CdWlsZGVyLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoYWxpYXNNZXRob2RbbWV0aG9kXSkgewogICAgICBtZXRob2QgPSBhbGlhc01ldGhvZFttZXRob2RdOwogICAgfQogICAgaWYgKG1ldGhvZCA9PT0gJ25vdE51bGxhYmxlJykgcmV0dXJuIHRoaXMubnVsbGFibGUoZmFsc2UpOwogICAgdGhpcy5fbW9kaWZpZXJzW21ldGhvZF0gPSBfLnRvQXJyYXkoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzOwogIH07Cn0pOwoKXy5lYWNoKFsnaW5kZXgnLCAncHJpbWFyeScsICd1bmlxdWUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgQ29sdW1uQnVpbGRlci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX3R5cGUudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpbmNyZW1lbnRzJykgPT09IC0xKSB7CiAgICAgIHRoaXMuX3RhYmxlQnVpbGRlclttZXRob2RdLmFwcGx5KHRoaXMuX3RhYmxlQnVpbGRlciwKICAgICAgICBbdGhpcy5fYXJnc1swXV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKCi8vIFNwZWNpZnkgdGhhdCB0aGUgY3VycmVudCBjb2x1bW4gInJlZmVyZW5jZXMiIGEgY29sdW1uLAovLyB3aGljaCBtYXkgYmUgdGFibGVOYW1lLmNvbHVtbiBvciBqdXN0ICJjb2x1bW4iCkNvbHVtbkJ1aWxkZXIucHJvdG90eXBlLnJlZmVyZW5jZXMgPSBmdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiB0aGlzLl90YWJsZUJ1aWxkZXIuZm9yZWlnbi5jYWxsKHRoaXMuX3RhYmxlQnVpbGRlciwgdGhpcy5fYXJnc1swXSwgdGhpcykKICAgIC5fY29sdW1uQnVpbGRlcih0aGlzKQogICAgLnJlZmVyZW5jZXModmFsdWUpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBDb2x1bW5CdWlsZGVyOwoKfSx7ImxvZGFzaCI6MTMwfV0sMTEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gQ29sdW1uIENvbXBpbGVyCi8vIFVzZWQgZm9yIGRlc2lnbmF0aW5nIGNvbHVtbiBkZWZpbml0aW9ucwovLyBkdXJpbmcgdGhlIHRhYmxlICJjcmVhdGUiIC8gImFsdGVyIiBzdGF0ZW1lbnRzLgovLyAtLS0tLS0tCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBSYXcgPSByZXF1aXJlKCcuLi9yYXcnKTsKCmZ1bmN0aW9uIENvbHVtbkNvbXBpbGVyKHRhYmxlQ29tcGlsZXIsIGNvbHVtbkJ1aWxkZXIpIHsKICB0aGlzLnRhYmxlQ29tcGlsZXIgPSB0YWJsZUNvbXBpbGVyOwogIHRoaXMuY29sdW1uQnVpbGRlciA9IGNvbHVtbkJ1aWxkZXI7CiAgdGhpcy5hcmdzID0gY29sdW1uQnVpbGRlci5fYXJnczsKICB0aGlzLnR5cGUgPSBjb2x1bW5CdWlsZGVyLl90eXBlLnRvTG93ZXJDYXNlKCk7CiAgdGhpcy5ncm91cGVkID0gXy5ncm91cEJ5KGNvbHVtbkJ1aWxkZXIuX3N0YXRlbWVudHMsICdncm91cGluZycpOwogIHRoaXMubW9kaWZpZWQgPSBjb2x1bW5CdWlsZGVyLl9tb2RpZmllcnM7CiAgdGhpcy5pc0luY3JlbWVudHMgPSAodGhpcy50eXBlLmluZGV4T2YoJ2luY3JlbWVudHMnKSAhPT0gLTEpOwogIHRoaXMuaW5pdENvbXBpbGVyKCk7Cn0KCi8vIFRvIGNvbnZlcnQgdG8gc3FsLCB3ZSBmaXJzdCBnbyB0aHJvdWdoIGFuZCBidWlsZCB0aGUKLy8gY29sdW1uIGFzIGl0IHdvdWxkIGJlIGluIHRoZSBpbnNlcnQgc3RhdGVtZW50CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHRoaXMucHVzaFF1ZXJ5KHRoaXMuY29tcGlsZUNvbHVtbigpKTsKICBpZiAodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsKSB7CiAgICB0aGlzLnNlcXVlbmNlID0gdGhpcy5zZXF1ZW5jZS5jb25jYXQodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsKTsKICB9CiAgcmV0dXJuIHRoaXMuc2VxdWVuY2U7Cn07CgovLyBDb21waWxlcyBhIGNvbHVtbi4KQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmNvbXBpbGVDb2x1bW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcCh0aGlzLmdldENvbHVtbk5hbWUoKSkgKyAnICcgKwogICAgdGhpcy5nZXRDb2x1bW5UeXBlKCkgKyB0aGlzLmdldE1vZGlmaWVycygpOwp9OwoKLy8gQXNzdW1lcyB0aGUgYXV0b2luY3JlbWVudGluZyBrZXkgaXMgbmFtZWQgYGlkYCBpZiBub3Qgb3RoZXJ3aXNlIHNwZWNpZmllZC4KQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbk5hbWUgPSBmdW5jdGlvbigpIHsKICB2YXIgdmFsdWUgPSBfLmZpcnN0KHRoaXMuYXJncyk7CiAgaWYgKHZhbHVlKSByZXR1cm4gdmFsdWU7CiAgaWYgKHRoaXMuaXNJbmNyZW1lbnRzKSB7CiAgICByZXR1cm4gJ2lkJzsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgZGlkIG5vdCBzcGVjaWZ5IGEgY29sdW1uIG5hbWUgZm9yIHRoZSAnICsgdGhpcy50eXBlICsgJ2NvbHVtbi4nKTsKICB9Cn07CgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZ2V0Q29sdW1uVHlwZSA9IGZ1bmN0aW9uKCkgewogIHZhciB0eXBlID0gdGhpc1t0aGlzLnR5cGVdOwogIHJldHVybiBfLmlzRnVuY3Rpb24odHlwZSkgPyB0eXBlLmFwcGx5KHRoaXMsIF8ucmVzdCh0aGlzLmFyZ3MpKSA6IHR5cGU7Cn07CgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZ2V0TW9kaWZpZXJzID0gZnVuY3Rpb24oKSB7CiAgdmFyIG1vZGlmaWVycyA9IFtdOwogIGlmICh0aGlzLnR5cGUuaW5kZXhPZignaW5jcmVtZW50cycpID09PSAtMSkgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGlmaWVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIG1vZGlmaWVyID0gdGhpcy5tb2RpZmllcnNbaV07CiAgICAgIGlmIChfLmhhcyh0aGlzLm1vZGlmaWVkLCBtb2RpZmllcikpIHsKICAgICAgICB2YXIgdmFsID0gdGhpc1ttb2RpZmllcl0uYXBwbHkodGhpcywgdGhpcy5tb2RpZmllZFttb2RpZmllcl0pOwogICAgICAgIGlmICh2YWwpIG1vZGlmaWVycy5wdXNoKHZhbCk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1vZGlmaWVycy5sZW5ndGggPiAwID8gJyAnICsgbW9kaWZpZXJzLmpvaW4oJyAnKSA6ICcnOwp9OwoKLy8gVHlwZXMKLy8gLS0tLS0tCgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuaW5jcmVtZW50cyA9ICdpbnRlZ2VyIG5vdCBudWxsIHByaW1hcnkga2V5IGF1dG9pbmNyZW1lbnQnOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuYmlnaW5jcmVtZW50cyA9ICdpbnRlZ2VyIG5vdCBudWxsIHByaW1hcnkga2V5IGF1dG9pbmNyZW1lbnQnOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuaW50ZWdlciA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5zbWFsbGludCA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5tZWRpdW1pbnQgPSAnaW50ZWdlcic7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaWdpbnRlZ2VyID0gJ2JpZ2ludCc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS52YXJjaGFyID0gZnVuY3Rpb24obGVuZ3RoKSB7CiAgcmV0dXJuICd2YXJjaGFyKCcgKyB0aGlzLl9udW0obGVuZ3RoLCAyNTUpICsgJyknOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUudGV4dCA9ICd0ZXh0JzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnRpbnlpbnQgPSAndGlueWludCc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5mbG9hdGluZyA9IGZ1bmN0aW9uKHByZWNpc2lvbiwgc2NhbGUpIHsKICByZXR1cm4gJ2Zsb2F0KCcgKyB0aGlzLl9udW0ocHJlY2lzaW9uLCA4KSArICcsICcgKyB0aGlzLl9udW0oc2NhbGUsIDIpICsgJyknOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZGVjaW1hbCA9IGZ1bmN0aW9uKHByZWNpc2lvbiwgc2NhbGUpIHsKICByZXR1cm4gJ2RlY2ltYWwoJyArIHRoaXMuX251bShwcmVjaXNpb24sIDgpICsgJywgJyArIHRoaXMuX251bShzY2FsZSwgMikgKyAnKSc7Cn07CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaW5hcnkgPSAnYmxvYic7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5ib29sID0gJ2Jvb2xlYW4nOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZGF0ZSA9ICdkYXRlJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmRhdGV0aW1lID0gJ2RhdGV0aW1lJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnRpbWUgPSAndGltZSc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50aW1lc3RhbXAgPSAndGltZXN0YW1wJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmVudSA9ICd2YXJjaGFyJzsKCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaXQgPQpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuanNvbiA9ICd0ZXh0JzsKCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS51dWlkID0gJ2NoYXIoMzYpJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnNwZWNpZmljdHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsKICByZXR1cm4gdHlwZTsKfTsKCi8vIE1vZGlmaWVycwovLyAtLS0tLS0tCgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUubnVsbGFibGUgPSBmdW5jdGlvbihudWxsYWJsZSkgewogIHJldHVybiBudWxsYWJsZSA9PT0gZmFsc2UgPyAnbm90IG51bGwnIDogJ251bGwnOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUubm90TnVsbGFibGUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5udWxsYWJsZShmYWxzZSk7Cn07CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5kZWZhdWx0VG8gPSBmdW5jdGlvbih2YWx1ZSkgewogIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gJyc7CiAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgdmFsdWUgPSAibnVsbCI7CiAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJhdykgewogICAgdmFsdWUgPSB2YWx1ZS50b1F1ZXJ5KCk7CiAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdib29sJykgewogICAgaWYgKHZhbHVlID09PSAnZmFsc2UnKSB2YWx1ZSA9IDA7CiAgICB2YWx1ZSA9ICInIiArICh2YWx1ZSA/IDEgOiAwKSArICInIjsKICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2pzb24nICYmIF8uaXNPYmplY3QodmFsdWUpKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB2YWx1ZSA9ICInIiArIHZhbHVlICsgIiciOwogIH0KICByZXR1cm4gJ2RlZmF1bHQgJyArIHZhbHVlOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuX251bSA9IGZ1bmN0aW9uKHZhbCwgZmFsbGJhY2spIHsKICBpZiAodmFsID09PSB1bmRlZmluZWQgfHwgdmFsID09PSBudWxsKSByZXR1cm4gZmFsbGJhY2s7CiAgdmFyIG51bWJlciA9IHBhcnNlSW50KHZhbCwgMTApOwogIHJldHVybiBpc05hTihudW1iZXIpID8gZmFsbGJhY2sgOiBudW1iZXI7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IENvbHVtbkNvbXBpbGVyOwoKfSx7Ii4uL3JhdyI6MTA4LCJsb2Rhc2giOjEzMH1dLDExMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFRoZSAiU2NoZW1hQ29tcGlsZXIiIHRha2VzIGFsbCBvZiB0aGUgcXVlcnkgc3RhdGVtZW50cyB3aGljaCBoYXZlIGJlZW4KLy8gZ2F0aGVyZWQgaW4gdGhlICJTY2hlbWFCdWlsZGVyIiBhbmQgdHVybnMgdGhlbSBpbnRvIGFuIGFycmF5IG9mCi8vIHByb3Blcmx5IGZvcm1hdHRlZCAvIGJvdW5kIHF1ZXJ5IHN0cmluZ3MuCmZ1bmN0aW9uIFNjaGVtYUNvbXBpbGVyKGJ1aWxkZXIpIHsKICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogIHRoaXMuaW5pdENvbXBpbGVyKCk7Cn0KCmZ1bmN0aW9uIGJ1aWxkVGFibGUodHlwZSkgewogIHJldHVybiBmdW5jdGlvbih0YWJsZU5hbWUsIGZuKSB7CiAgICB2YXIgVGFibGVCdWlsZGVyID0gdGhpcy5jbGllbnQuVGFibGVCdWlsZGVyOwogICAgdmFyIHNxbCA9IG5ldyBUYWJsZUJ1aWxkZXIodHlwZSwgdGFibGVOYW1lLCBmbikudG9TUUwoKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3FsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB0aGlzLnNlcXVlbmNlLnB1c2goc3FsW2ldKTsKICAgIH0KICB9Owp9CgpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuY3JlYXRlVGFibGUgPSBidWlsZFRhYmxlKCdjcmVhdGUnKTsKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZVRhYmxlSWZOb3RFeGlzdHMgPSBidWlsZFRhYmxlKCdjcmVhdGVJZk5vdCcpOwpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuYWx0ZXJUYWJsZSAgPSBidWlsZFRhYmxlKCdhbHRlcicpOwoKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLmRyb3BUYWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIHRhYmxlICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRhYmxlTmFtZSkpOwp9OwpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuZHJvcFRhYmxlSWZFeGlzdHMgPSBmdW5jdGlvbih0YWJsZU5hbWUpIHsKICB0aGlzLnB1c2hRdWVyeSgnZHJvcCB0YWJsZSBpZiBleGlzdHMgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodGFibGVOYW1lKSk7Cn07ClNjaGVtYUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHZhciBzZXF1ZW5jZSA9IHRoaXMuYnVpbGRlci5fc2VxdWVuY2U7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBzZXF1ZW5jZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBxdWVyeSA9IHNlcXVlbmNlW2ldOwogICAgdGhpc1txdWVyeS5tZXRob2RdLmFwcGx5KHRoaXMsIHF1ZXJ5LmFyZ3MpOwogIH0KICByZXR1cm4gdGhpcy5zZXF1ZW5jZTsKfTsKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLnJhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICB0aGlzLnNlcXVlbmNlLnB1c2gobmV3IHRoaXMuY2xpZW50LlJhdyhzcWwsIGJpbmRpbmdzKS50b1NRTCgpKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gU2NoZW1hQ29tcGlsZXI7Cn0se31dLDExNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cgp2YXIgQnVpbGRlciA9IHJlcXVpcmUoJy4vYnVpbGRlcicpOwp2YXIgQ29tcGlsZXIgPSByZXF1aXJlKCcuL2NvbXBpbGVyJyk7CnZhciBUYWJsZUJ1aWxkZXIgPSByZXF1aXJlKCcuL3RhYmxlYnVpbGRlcicpOwp2YXIgVGFibGVDb21waWxlciA9IHJlcXVpcmUoJy4vdGFibGVjb21waWxlcicpOwp2YXIgQ29sdW1uQnVpbGRlciA9IHJlcXVpcmUoJy4vY29sdW1uYnVpbGRlcicpOwp2YXIgQ29sdW1uQ29tcGlsZXIgPSByZXF1aXJlKCcuL2NvbHVtbmNvbXBpbGVyJyk7CgovLyBJbml0aWFsaXplIHRoZSBjb21waWxlci4KQ29tcGlsZXIucHJvdG90eXBlLmluaXRDb21waWxlciA9ClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmluaXRDb21waWxlciA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5pbml0Q29tcGlsZXIgPSBmdW5jdGlvbigpIHsKICB0aGlzLmZvcm1hdHRlciA9IG5ldyB0aGlzLkZvcm1hdHRlcigpOwogIHRoaXMuc2VxdWVuY2UgID0gW107Cn07CgovLyBQdXNoIGEgbmV3IHF1ZXJ5IG9udG8gdGhlIGNvbXBpbGVkICJzZXF1ZW5jZSIgc3RhY2ssCi8vIGNyZWF0aW5nIGEgbmV3IGZvcm1hdHRlciwgcmV0dXJuaW5nIHRoZSBjb21waWxlci4KQ29tcGlsZXIucHJvdG90eXBlLnB1c2hRdWVyeSA9ClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnB1c2hRdWVyeSA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5wdXNoUXVlcnkgPSBmdW5jdGlvbihxdWVyeSkgewogIGlmICghcXVlcnkpIHJldHVybjsKICBpZiAoXy5pc1N0cmluZyhxdWVyeSkpIHsKICAgIHF1ZXJ5ID0ge3NxbDogcXVlcnl9OwogIH0gZWxzZSB7CiAgICBxdWVyeSA9IHF1ZXJ5OwogIH0KICBpZiAoIXF1ZXJ5LmJpbmRpbmdzKSB7CiAgICBxdWVyeS5iaW5kaW5ncyA9IHRoaXMuZm9ybWF0dGVyLmJpbmRpbmdzOwogIH0KICB0aGlzLnNlcXVlbmNlLnB1c2gocXVlcnkpOwogIHRoaXMuZm9ybWF0dGVyID0gbmV3IHRoaXMuRm9ybWF0dGVyKCk7Cn07CgovLyBVc2VkIGluIGNhc2VzIHdoZXJlIHdlIG5lZWQgdG8gcHVzaCBzb21lIGFkZGl0aW9uYWwgY29sdW1uIHNwZWNpZmljIHN0YXRlbWVudHMuCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5wdXNoQWRkaXRpb25hbCA9IGZ1bmN0aW9uKGZuKSB7CiAgdmFyIGNoaWxkID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy50YWJsZUNvbXBpbGVyLCB0aGlzLmNvbHVtbkJ1aWxkZXIpOwogIGZuLmNhbGwoY2hpbGQsIF8ucmVzdChhcmd1bWVudHMpKTsKICB0aGlzLnNlcXVlbmNlLmFkZGl0aW9uYWwgPSAodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsIHx8IFtdKS5jb25jYXQoY2hpbGQuc2VxdWVuY2UpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgQnVpbGRlcjogQnVpbGRlciwKICBDb21waWxlcjogQ29tcGlsZXIsCiAgVGFibGVCdWlsZGVyOiBUYWJsZUJ1aWxkZXIsCiAgVGFibGVDb21waWxlcjogVGFibGVDb21waWxlciwKICBDb2x1bW5CdWlsZGVyOiBDb2x1bW5CdWlsZGVyLAogIENvbHVtbkNvbXBpbGVyOiBDb2x1bW5Db21waWxlcgp9Owp9LHsiLi9idWlsZGVyIjoxMTAsIi4vY29sdW1uYnVpbGRlciI6MTExLCIuL2NvbHVtbmNvbXBpbGVyIjoxMTIsIi4vY29tcGlsZXIiOjExMywiLi90YWJsZWJ1aWxkZXIiOjExNSwiLi90YWJsZWNvbXBpbGVyIjoxMTYsImxvZGFzaCI6MTMwfV0sMTE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gVGFibGVCdWlsZGVyCgovLyBUYWtlcyB0aGUgZnVuY3Rpb24gcGFzc2VkIHRvIHRoZSAiY3JlYXRlVGFibGUiIG9yICJ0YWJsZS9lZGl0VGFibGUiCi8vIGZ1bmN0aW9ucyBhbmQgY2FsbHMgaXQgd2l0aCB0aGUgIlRhYmxlQnVpbGRlciIgYXMgYm90aCB0aGUgY29udGV4dCBhbmQKLy8gdGhlIGZpcnN0IGFyZ3VtZW50LiBJbnNpZGUgdGhpcyBmdW5jdGlvbiB3ZSBjYW4gc3BlY2lmeSB3aGF0IGhhcHBlbnMgdG8gdGhlCi8vIG1ldGhvZCwgcHVzaGluZyBldmVyeXRoaW5nIHdlIHdhbnQgdG8gZG8gb250byB0aGUgImFsbFN0YXRlbWVudHMiIGFycmF5LAovLyB3aGljaCBpcyB0aGVuIGNvbXBpbGVkIGludG8gc3FsLgovLyAtLS0tLS0KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuLi9oZWxwZXJzJyk7Cgp2YXIgQWx0ZXJNZXRob2RzID0gewoKICAvLyBSZW5hbWVzIHRoZSBjdXJyZW50IGNvbHVtbiBgZnJvbWAgdGhlIGN1cnJlbnQKICAvLyBUT0RPOiB0aGlzLmNvbHVtbihmcm9tKS5yZW5hbWUodG8pCiAgcmVuYW1lQ29sdW1uOiBmdW5jdGlvbihmcm9tLCB0bykgewogICAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgICAgbWV0aG9kOiAncmVuYW1lQ29sdW1uJywKICAgICAgYXJnczogW2Zyb20sIHRvXQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBkcm9wVGltZXN0YW1wczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5kcm9wQ29sdW1ucyhbJ2NyZWF0ZWRfYXQnLCAndXBkYXRlZF9hdCddKTsKICB9CgogIC8vIFRPRE86IGNoYW5nZVR5cGUKfTsKCi8vIERyb3AgYSBjb2x1bW4gZnJvbSB0aGUgY3VycmVudCB0YWJsZS4KLy8gVE9ETzogRW5hYmxlIHRoaXMuY29sdW1uKGNvbHVtbk5hbWUpLmRyb3AoKTsKQWx0ZXJNZXRob2RzLmRyb3BDb2x1bW4gPQpBbHRlck1ldGhvZHMuZHJvcENvbHVtbnMgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgIG1ldGhvZDogJ2Ryb3BDb2x1bW4nLAogICAgYXJnczogXy50b0FycmF5KGFyZ3VtZW50cykKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCmZ1bmN0aW9uIFRhYmxlQnVpbGRlcihtZXRob2QsIHRhYmxlTmFtZSwgZm4pIHsKICB0aGlzLl9mbiAgICAgICAgID0gZm47CiAgdGhpcy5fbWV0aG9kICAgICA9IG1ldGhvZDsKICB0aGlzLl90YWJsZU5hbWUgID0gdGFibGVOYW1lOwogIHRoaXMuX3N0YXRlbWVudHMgPSBbXTsKICB0aGlzLl9zaW5nbGUgICAgID0ge307Cn0KCi8vIENvbnZlcnQgdGhlIGN1cnJlbnQgdGFibGVCdWlsZGVyIG9iamVjdCAidG9TUUwiCi8vIGdpdmluZyB1cyBhZGRpdGlvbmFsIG1ldGhvZHMgaWYgd2UncmUgYWx0ZXJpbmcKLy8gcmF0aGVyIHRoYW4gY3JlYXRpbmcgdGhlIHRhYmxlLgpUYWJsZUJ1aWxkZXIucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgXy5leHRlbmQodGhpcywgQWx0ZXJNZXRob2RzKTsKICB9CiAgdGhpcy5fZm4uY2FsbCh0aGlzLCB0aGlzKTsKICB2YXIgVGFibGVDb21waWxlciA9IHRoaXMuY2xpZW50LlRhYmxlQ29tcGlsZXI7CiAgcmV0dXJuIG5ldyBUYWJsZUNvbXBpbGVyKHRoaXMpLnRvU1FMKCk7Cn07CgpfLmVhY2goWwoKICAvLyBFYWNoIG9mIHRoZSBpbmRleCBtZXRob2RzIGNhbiBiZSBjYWxsZWQgaW5kaXZpZHVhbGx5LCB3aXRoIHRoZQogIC8vIGNvbHVtbiBuYW1lIHRvIGJlIHVzZWQsIGUuZy4gdGFibGUudW5pcXVlKCdjb2x1bW4nKS4KICAnaW5kZXgnLCAncHJpbWFyeScsICd1bmlxdWUnLAoKICAvLyBLZXkgc3BlY2lmaWMKICAnZHJvcFByaW1hcnknLCAnZHJvcFVuaXF1ZScsICdkcm9wSW5kZXgnLCAnZHJvcEZvcmVpZ24nCgpdLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICAgIGdyb3VwaW5nOiAnYWx0ZXJUYWJsZScsCiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBhcmdzOiBfLnRvQXJyYXkoYXJndW1lbnRzKQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKCi8vIFdhcm4gaWYgd2UncmUgbm90IGluIE15U1FMLCBzaW5jZSB0aGF0J3MgdGhlIG9ubHkgdGltZSB0aGVzZQovLyB0aHJlZSBhcmUgc3VwcG9ydGVkLgp2YXIgc3BlY2lhbE1ldGhvZHMgPSBbJ2VuZ2luZScsICdjaGFyc2V0JywgJ2NvbGxhdGUnXTsKXy5lYWNoKHNwZWNpYWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGZhbHNlKSB7CiAgICAgIGhlbHBlcnMud2FybignS25leCBvbmx5IHN1cHBvcnRzICcgKyBtZXRob2QgKyAnIHN0YXRlbWVudCB3aXRoIG15c3FsLicpOwogICAgfSBpZiAodGhpcy5fX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgICBoZWxwZXJzLndhcm4oJ0tuZXggZG9lcyBub3Qgc3VwcG9ydCBhbHRlcmluZyB0aGUgJyArIG1ldGhvZCArICcgb3V0c2lkZSBvZiB0aGUgY3JlYXRlIHRhYmxlLCBwbGVhc2UgdXNlIGtuZXgucmF3IHN0YXRlbWVudC4nKTsKICAgIH0KICAgIHRoaXMuX3NpbmdsZVttZXRob2RdID0gdmFsdWU7CiAgfTsKfSk7CgovLyBFYWNoIG9mIHRoZSBjb2x1bW4gdHlwZXMgdGhhdCB3ZSBjYW4gYWRkLCB3ZSBjcmVhdGUgYSBuZXcgQ29sdW1uQnVpbGRlcgovLyBpbnN0YW5jZSBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGF0ZW1lbnRzIGFycmF5Lgp2YXIgY29sdW1uVHlwZXMgPSBbCgogIC8vIE51bWVyaWMKICAndGlueWludCcsCiAgJ3NtYWxsaW50JywKICAnbWVkaXVtaW50JywKICAnaW50JywKICAnYmlnaW50JywKICAnZGVjaW1hbCcsCiAgJ2Zsb2F0JywKICAnZG91YmxlJywKICAncmVhbCcsCiAgJ2JpdCcsCiAgJ2Jvb2xlYW4nLAogICdzZXJpYWwnLAoKICAvLyBEYXRlIC8gVGltZQogICdkYXRlJywKICAnZGF0ZXRpbWUnLAogICd0aW1lc3RhbXAnLAogICd0aW1lJywKICAneWVhcicsCgogIC8vIFN0cmluZwogICdjaGFyJywKICAndmFyY2hhcicsCiAgJ3Rpbnl0ZXh0JywKICAndGlueVRleHQnLAogICd0ZXh0JywKICAnbWVkaXVtdGV4dCcsCiAgJ21lZGl1bVRleHQnLAogICdsb25ndGV4dCcsCiAgJ2xvbmdUZXh0JywKICAnYmluYXJ5JywKICAndmFyYmluYXJ5JywKICAndGlueWJsb2InLAogICd0aW55QmxvYicsCiAgJ21lZGl1bWJsb2InLAogICdtZWRpdW1CbG9iJywKICAnYmxvYicsCiAgJ2xvbmdibG9iJywKICAnbG9uZ0Jsb2InLAogICdlbnVtJywKICAnc2V0JywKCiAgLy8gSW5jcmVtZW50cywgQWxpYXNlcywgYW5kIEFkZGl0aW9uYWwKICAnYm9vbCcsCiAgJ2RhdGVUaW1lJywKICAnaW5jcmVtZW50cycsCiAgJ2JpZ2luY3JlbWVudHMnLAogICdiaWdJbmNyZW1lbnRzJywKICAnaW50ZWdlcicsCiAgJ2JpZ2ludGVnZXInLAogICdiaWdJbnRlZ2VyJywKICAnc3RyaW5nJywKICAndGltZXN0YW1wcycsCiAgJ2pzb24nLAogICd1dWlkJywKICAnZW51JywKICAnc3BlY2lmaWNUeXBlJwpdOwoKLy8gRm9yIGVhY2ggb2YgdGhlIGNvbHVtbiBtZXRob2RzLCBjcmVhdGUgYSBuZXcgIkNvbHVtbkJ1aWxkZXIiIGludGVyZmFjZSwKLy8gcHVzaCBpdCBvbnRvIHRoZSAiYWxsU3RhdGVtZW50cyIgc3RhY2ssIGFuZCB0aGVuIHJldHVybiB0aGUgaW50ZXJmYWNlLAovLyB3aXRoIHdoaWNoIHdlIGNhbiBhZGQgaW5kZXhlcywgZXRjLgpfLmVhY2goY29sdW1uVHlwZXMsIGZ1bmN0aW9uKHR5cGUpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW3R5cGVdID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwoKICAgIC8vIFRoZSAidGltZXN0YW1wcyIgY2FsbCBpcyByZWFsbHkgYSBjb21wb3VuZCBjYWxsIHRvIHNldCB0aGUKICAgIC8vIGBjcmVhdGVkX2F0YCBhbmQgYHVwZGF0ZWRfYXRgIGNvbHVtbnMuCiAgICBpZiAodHlwZSA9PT0gJ3RpbWVzdGFtcHMnKSB7CiAgICAgIGlmIChhcmdzWzBdID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy50aW1lc3RhbXAoJ2NyZWF0ZWRfYXQnKTsKICAgICAgICB0aGlzLnRpbWVzdGFtcCgndXBkYXRlZF9hdCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGF0ZXRpbWUoJ2NyZWF0ZWRfYXQnKTsKICAgICAgICB0aGlzLmRhdGV0aW1lKCd1cGRhdGVkX2F0Jyk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIENvbHVtbkJ1aWxkZXIgPSB0aGlzLmNsaWVudC5Db2x1bW5CdWlsZGVyOwogICAgdmFyIGJ1aWxkZXIgICAgICAgPSBuZXcgQ29sdW1uQnVpbGRlcih0aGlzLCB0eXBlLCBhcmdzKTsKCiAgICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgICBncm91cGluZzogJ2NvbHVtbnMnLAogICAgICBidWlsZGVyOiBidWlsZGVyCiAgICB9KTsKICAgIHJldHVybiBidWlsZGVyOwogIH07Cgp9KTsKCi8vIFNldCB0aGUgY29tbWVudCB2YWx1ZSBmb3IgYSB0YWJsZSwgdGhleSdyZSBvbmx5IGFsbG93ZWQgdG8gYmUgY2FsbGVkCi8vIG9uY2UgcGVyIHRhYmxlLgpUYWJsZUJ1aWxkZXIucHJvdG90eXBlLmNvbW1lbnQgPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMuX3NpbmdsZS5jb21tZW50ID0gdmFsdWU7Cn07CgovLyBTZXQgYSBmb3JlaWduIGtleSBvbiB0aGUgdGFibGUsIGNhbGxpbmcKLy8gYHRhYmxlLmZvcmVpZ24oJ2NvbHVtbl9uYW1lJykucmVmZXJlbmNlcygnY29sdW1uJykub24oJ3RhYmxlJykub25EZWxldGUoKS4uLgovLyBBbHNvIGNhbGxlZCBmcm9tIHRoZSBDb2x1bW5CdWlsZGVyIGNvbnRleHQgd2hlbiBjaGFpbmluZy4KVGFibGVCdWlsZGVyLnByb3RvdHlwZS5mb3JlaWduID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdmFyIGZvcmVpZ25EYXRhID0ge2NvbHVtbjogY29sdW1ufTsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgIG1ldGhvZDogJ2ZvcmVpZ24nLAogICAgYXJnczogW2ZvcmVpZ25EYXRhXQogIH0pOwogIHZhciByZXR1cm5PYmogPSB7CiAgICByZWZlcmVuY2VzOiBmdW5jdGlvbih0YWJsZUNvbHVtbikgewogICAgICB2YXIgcGllY2VzOwogICAgICBpZiAoXy5pc1N0cmluZyh0YWJsZUNvbHVtbikpIHsKICAgICAgICBwaWVjZXMgPSB0YWJsZUNvbHVtbi5zcGxpdCgnLicpOwogICAgICB9CiAgICAgIGlmICghcGllY2VzIHx8IHBpZWNlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBmb3JlaWduRGF0YS5yZWZlcmVuY2VzID0gcGllY2VzID8gcGllY2VzWzBdIDogdGFibGVDb2x1bW47CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG9uOiBmdW5jdGlvbih0YWJsZU5hbWUpIHsKICAgICAgICAgICAgZm9yZWlnbkRhdGEuaW5UYWJsZSA9IHRhYmxlTmFtZTsKICAgICAgICAgICAgcmV0dXJuIHJldHVybk9iajsKICAgICAgICAgIH0sCiAgICAgICAgICBpblRhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZvcmVpZ25EYXRhLmluVGFibGUgPSBwaWVjZXNbMF07CiAgICAgIGZvcmVpZ25EYXRhLnJlZmVyZW5jZXMgPSBwaWVjZXNbMV07CiAgICAgIHJldHVybiByZXR1cm5PYmo7CiAgICB9LAogICAgb25VcGRhdGU6IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogICAgICBmb3JlaWduRGF0YS5vblVwZGF0ZSA9IHN0YXRlbWVudDsKICAgICAgcmV0dXJuIHJldHVybk9iajsKICAgIH0sCiAgICBvbkRlbGV0ZTogZnVuY3Rpb24oc3RhdGVtZW50KSB7CiAgICAgIGZvcmVpZ25EYXRhLm9uRGVsZXRlID0gc3RhdGVtZW50OwogICAgICByZXR1cm4gcmV0dXJuT2JqOwogICAgfSwKICAgIF9jb2x1bW5CdWlsZGVyOiBmdW5jdGlvbihidWlsZGVyKSB7CiAgICAgIF8uZXh0ZW5kKGJ1aWxkZXIsIHJldHVybk9iaik7CiAgICAgIHJldHVybk9iaiA9IGJ1aWxkZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfQogIH07CiAgcmV0dXJuIHJldHVybk9iajsKfTsKCm1vZHVsZS5leHBvcnRzID0gVGFibGVCdWlsZGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCJsb2Rhc2giOjEzMH1dLDExNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFRhYmxlIENvbXBpbGVyCi8vIC0tLS0tLS0KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSgnLi4vaGVscGVycycpOwoKZnVuY3Rpb24gVGFibGVDb21waWxlcih0YWJsZUJ1aWxkZXIpIHsKICB0aGlzLm1ldGhvZCAgICAgICAgID0gdGFibGVCdWlsZGVyLl9tZXRob2Q7CiAgdGhpcy50YWJsZU5hbWVSYXcgICA9IHRhYmxlQnVpbGRlci5fdGFibGVOYW1lOwogIHRoaXMuc2luZ2xlICAgICAgICAgPSB0YWJsZUJ1aWxkZXIuX3NpbmdsZTsKICB0aGlzLmdyb3VwZWQgICAgICAgID0gXy5ncm91cEJ5KHRhYmxlQnVpbGRlci5fc3RhdGVtZW50cywgJ2dyb3VwaW5nJyk7CiAgdGhpcy5pbml0Q29tcGlsZXIoKTsKfQoKLy8gQ29udmVydCB0aGUgdGFibGVDb21waWxlciB0b1NRTApUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHRoaXNbdGhpcy5tZXRob2RdKCk7CiAgcmV0dXJuIHRoaXMuc2VxdWVuY2U7Cn07CgovLyBDb2x1bW4gQ29tcGlsYXRpb24KLy8gLS0tLS0tLQoKLy8gSWYgdGhpcyBpcyBhIHRhYmxlICJjcmVhdGlvbiIsIHdlIG5lZWQgdG8gZmlyc3QgcnVuIHRocm91Z2ggYWxsCi8vIG9mIHRoZSBjb2x1bW5zIHRvIGJ1aWxkIHRoZW0gaW50byBhIHNpbmdsZSBzdHJpbmcsCi8vIGFuZCB0aGVuIHJ1biB0aHJvdWdoIGFueXRoaW5nIGVsc2UgYW5kIHB1c2ggaXQgdG8gdGhlIHF1ZXJ5IHNlcXVlbmNlLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5jcmVhdGUgPSBmdW5jdGlvbihpZk5vdCkgewogIHZhciBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKCk7CiAgdmFyIGNvbHVtblR5cGVzID0gdGhpcy5nZXRDb2x1bW5UeXBlcyhjb2x1bW5zKTsKICB0aGlzLmNyZWF0ZVF1ZXJ5KGNvbHVtblR5cGVzLCBpZk5vdCk7CiAgdGhpcy5jb2x1bW5RdWVyaWVzKGNvbHVtbnMpOwogIGRlbGV0ZSB0aGlzLnNpbmdsZS5jb21tZW50OwogIHRoaXMuYWx0ZXJUYWJsZSgpOwp9OwoKLy8gT25seSBjcmVhdGUgdGhlIHRhYmxlIGlmIGl0IGRvZXNuJ3QgZXhpc3QuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZUlmTm90ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5jcmVhdGUodHJ1ZSk7Cn07CgovLyBJZiB3ZSdyZSBhbHRlcmluZyB0aGUgdGFibGUsIHdlIG5lZWQgdG8gb25lLWJ5LW9uZQovLyBnbyB0aHJvdWdoIGFuZCBoYW5kbGUgZWFjaCBvZiB0aGUgcXVlcmllcyBhc3NvY2lhdGVkCi8vIHdpdGggYWx0ZXJpbmcgdGhlIHRhYmxlJ3Mgc2NoZW1hLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hbHRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKCk7CiAgdmFyIGNvbHVtblR5cGVzID0gdGhpcy5nZXRDb2x1bW5UeXBlcyhjb2x1bW5zKTsKICB0aGlzLmFkZENvbHVtbnMoY29sdW1uVHlwZXMpOwogIHRoaXMuY29sdW1uUXVlcmllcyhjb2x1bW5zKTsKICB0aGlzLmFsdGVyVGFibGUoKTsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmZvcmVpZ24gPSBmdW5jdGlvbihmb3JlaWduRGF0YSkgewogIGlmIChmb3JlaWduRGF0YS5pblRhYmxlICYmIGZvcmVpZ25EYXRhLnJlZmVyZW5jZXMpIHsKICAgIHZhciBrZXlOYW1lICAgID0gdGhpcy5faW5kZXhDb21tYW5kKCdmb3JlaWduJywgdGhpcy50YWJsZU5hbWVSYXcsIGZvcmVpZ25EYXRhLmNvbHVtbik7CiAgICB2YXIgY29sdW1uICAgICA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShmb3JlaWduRGF0YS5jb2x1bW4pOwogICAgdmFyIHJlZmVyZW5jZXMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbkRhdGEucmVmZXJlbmNlcyk7CiAgICB2YXIgaW5UYWJsZSAgICA9IHRoaXMuZm9ybWF0dGVyLndyYXAoZm9yZWlnbkRhdGEuaW5UYWJsZSk7CiAgICB2YXIgb25VcGRhdGUgICA9IGZvcmVpZ25EYXRhLm9uVXBkYXRlID8gJyBvbiB1cGRhdGUgJyArIGZvcmVpZ25EYXRhLm9uVXBkYXRlIDogJyc7CiAgICB2YXIgb25EZWxldGUgICA9IGZvcmVpZ25EYXRhLm9uRGVsZXRlID8gJyBvbiBkZWxldGUgJyArIGZvcmVpZ25EYXRhLm9uRGVsZXRlIDogJyc7CiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGFkZCBjb25zdHJhaW50ICcgKyBrZXlOYW1lICsgJyAnICsKICAgICAgJ2ZvcmVpZ24ga2V5ICgnICsgY29sdW1uICsgJykgcmVmZXJlbmNlcyAnICsgaW5UYWJsZSArICcgKCcgKyByZWZlcmVuY2VzICsgJyknICsgb25VcGRhdGUgKyBvbkRlbGV0ZSk7CiAgfQp9OwoKLy8gR2V0IGFsbCBvZiB0aGUgY29sdW1uIHNxbCAmIGJpbmRpbmdzIGluZGl2aWR1YWxseSBmb3IgYnVpbGRpbmcgdGhlIHRhYmxlIHF1ZXJpZXMuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtblR5cGVzID0gZnVuY3Rpb24oY29sdW1ucykgewogIHJldHVybiBfLnJlZHVjZShfLm1hcChjb2x1bW5zLCBfLmZpcnN0KSwgZnVuY3Rpb24obWVtbywgY29sdW1uKSB7CiAgICBtZW1vLnNxbC5wdXNoKGNvbHVtbi5zcWwpOwogICAgbWVtby5iaW5kaW5ncy5jb25jYXQoY29sdW1uLmJpbmRpbmdzKTsKICAgIHJldHVybiBtZW1vOwogIH0sIHtzcWw6IFtdLCBiaW5kaW5nczogW119KTsKfTsKCi8vIEFkZHMgYWxsIG9mIHRoZSBhZGRpdGlvbmFsIHF1ZXJpZXMgZnJvbSB0aGUgImNvbHVtbiIKVGFibGVDb21waWxlci5wcm90b3R5cGUuY29sdW1uUXVlcmllcyA9IGZ1bmN0aW9uKGNvbHVtbnMpIHsKICB2YXIgcXVlcmllcyA9IF8ucmVkdWNlKF8ubWFwKGNvbHVtbnMsIF8ucmVzdCksIGZ1bmN0aW9uKG1lbW8sIGNvbHVtbikgewogICAgaWYgKCFfLmlzRW1wdHkoY29sdW1uKSkgcmV0dXJuIG1lbW8uY29uY2F0KGNvbHVtbik7CiAgICByZXR1cm4gbWVtbzsKICB9LCBbXSk7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBxdWVyaWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdGhpcy5wdXNoUXVlcnkocXVlcmllc1tpXSk7CiAgfQp9OwoKLy8gQWRkIGEgbmV3IGNvbHVtbi4KVGFibGVDb21waWxlci5wcm90b3R5cGUuYWRkQ29sdW1uc1ByZWZpeCA9ICdhZGQgY29sdW1uICc7CgovLyBBbGwgb2YgdGhlIGNvbHVtbnMgdG8gImFkZCIgZm9yIHRoZSBxdWVyeQpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hZGRDb2x1bW5zID0gZnVuY3Rpb24oY29sdW1ucykgewogIGlmIChjb2x1bW5zLnNxbC5sZW5ndGggPiAwKSB7CiAgICB2YXIgY29sdW1uU3FsID0gXy5tYXAoY29sdW1ucy5zcWwsIGZ1bmN0aW9uKGNvbHVtbikgewogICAgICByZXR1cm4gdGhpcy5hZGRDb2x1bW5zUHJlZml4ICsgY29sdW1uOwogICAgfSwgdGhpcyk7CiAgICB0aGlzLnB1c2hRdWVyeSh7CiAgICAgIHNxbDogJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgY29sdW1uU3FsLmpvaW4oJywgJyksCiAgICAgIGJpbmRpbmdzOiBjb2x1bW5zLmJpbmRpbmdzCiAgICB9KTsKICB9Cn07CgovLyBDb21waWxlIHRoZSBjb2x1bW5zIGFzIG5lZWRlZCBmb3IgdGhlIGN1cnJlbnQgY3JlYXRlIG9yIGFsdGVyIHRhYmxlClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbnMgPSBmdW5jdGlvbigpIHsKICB2YXIgY29tcGlsZWRDb2x1bW5zID0gW10sIGNvbHVtbnMgPSB0aGlzLmdyb3VwZWQuY29sdW1ucyB8fCBbXTsKICB2YXIgQ29sdW1uQ29tcGlsZXIgPSB0aGlzLmNsaWVudC5Db2x1bW5Db21waWxlcjsKICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbHVtbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBjb21waWxlZENvbHVtbnMucHVzaChuZXcgQ29sdW1uQ29tcGlsZXIodGhpcywgY29sdW1uc1tpXS5idWlsZGVyKS50b1NRTCgpKTsKICB9CiAgcmV0dXJuIGNvbXBpbGVkQ29sdW1uczsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnRhYmxlTmFtZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMudGFibGVOYW1lUmF3KTsKfTsKCi8vIEdlbmVyYXRlIGFsbCBvZiB0aGUgYWx0ZXIgY29sdW1uIHN0YXRlbWVudHMgbmVjZXNzYXJ5IGZvciB0aGUgcXVlcnkuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFsdGVyVGFibGUgPSBmdW5jdGlvbigpIHsKICB2YXIgYWx0ZXJUYWJsZSA9IHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdOwogIGZvciAodmFyIGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBzdGF0ZW1lbnQgPSBhbHRlclRhYmxlW2ldOwogICAgaWYgKHRoaXNbc3RhdGVtZW50Lm1ldGhvZF0pIHsKICAgICAgdGhpc1tzdGF0ZW1lbnQubWV0aG9kXS5hcHBseSh0aGlzLCBzdGF0ZW1lbnQuYXJncyk7CiAgICB9IGVsc2UgewogICAgICBjb25zb2xlLmVycm9yKCdEZWJ1ZzogJyArIHN0YXRlbWVudC5tZXRob2QgKyAnIGRvZXMgbm90IGV4aXN0Jyk7CiAgICB9CiAgfQogIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5zaW5nbGUpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpc1tpdGVtXSkpIHRoaXNbaXRlbV0odGhpcy5zaW5nbGVbaXRlbV0pOwogIH0KfTsKCi8vIERyb3AgdGhlIGluZGV4IG9uIHRoZSBjdXJyZW50IHRhYmxlLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wSW5kZXggPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIGluZGV4JyArIHZhbHVlKTsKfTsKCi8vIERyb3AgdGhlIHVuaXF1ZQpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wVW5pcXVlID0KVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcEZvcmVpZ24gPSBmdW5jdGlvbigpIHsKICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBpbXBsZW1lbnRlZCBpbiB0aGUgZGlhbGVjdCBkcml2ZXInKTsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmRyb3BDb2x1bW5QcmVmaXggPSAnZHJvcCBjb2x1bW4gJzsKVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcENvbHVtbiA9IGZ1bmN0aW9uKCkgewogIHZhciBjb2x1bW5zID0gaGVscGVycy5ub3JtYWxpemVBcnIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICB2YXIgZHJvcHMgPSBfLm1hcChfLmlzQXJyYXkoY29sdW1ucykgPyBjb2x1bW5zIDogW2NvbHVtbnNdLCBmdW5jdGlvbihjb2x1bW4pIHsKICAgIHJldHVybiB0aGlzLmRyb3BDb2x1bW5QcmVmaXggKyB0aGlzLmZvcm1hdHRlci53cmFwKGNvbHVtbik7CiAgfSwgdGhpcyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgZHJvcHMuam9pbignLCAnKSk7Cn07CgovLyBJZiBubyBuYW1lIHdhcyBzcGVjaWZpZWQgZm9yIHRoaXMgaW5kZXgsIHdlIHdpbGwgY3JlYXRlIG9uZSB1c2luZyBhIGJhc2ljCi8vIGNvbnZlbnRpb24gb2YgdGhlIHRhYmxlIG5hbWUsIGZvbGxvd2VkIGJ5IHRoZSBjb2x1bW5zLCBmb2xsb3dlZCBieSBhbgovLyBpbmRleCB0eXBlLCBzdWNoIGFzIHByaW1hcnkgb3IgaW5kZXgsIHdoaWNoIG1ha2VzIHRoZSBpbmRleCB1bmlxdWUuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLl9pbmRleENvbW1hbmQgPSBmdW5jdGlvbih0eXBlLCB0YWJsZU5hbWUsIGNvbHVtbnMpIHsKICBpZiAoIV8uaXNBcnJheShjb2x1bW5zKSkgY29sdW1ucyA9IGNvbHVtbnMgPyBbY29sdW1uc10gOiBbXTsKICB2YXIgdGFibGUgPSB0YWJsZU5hbWUucmVwbGFjZSgvXC58LS9nLCAnXycpOwogIHJldHVybiAodGFibGUgKyAnXycgKyBjb2x1bW5zLmpvaW4oJ18nKSArICdfJyArIHR5cGUpLnRvTG93ZXJDYXNlKCk7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFRhYmxlQ29tcGlsZXI7Cn0seyIuLi9oZWxwZXJzIjo5OSwibG9kYXNoIjoxMzB9XSwxMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MsX19kaXJuYW1lKXsKLy8gU2VlZGVyCi8vIC0tLS0tLS0KJ3VzZSBzdHJpY3QnOwoKdmFyIGZzICAgICAgID0gcmVxdWlyZSgnZnMnKTsKdmFyIHBhdGggICAgID0gcmVxdWlyZSgncGF0aCcpOwp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIG1rZGlycCAgID0gcmVxdWlyZSgnbWtkaXJwJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4uL3Byb21pc2UnKTsKCgoKLy8gVGhlIG5ldyBzZWVkcyB3ZSdyZSBwZXJmb3JtaW5nLCB0eXBpY2FsbHkgY2FsbGVkIGZyb20gdGhlIGBrbmV4LnNlZWRgCi8vIGludGVyZmFjZSBvbiB0aGUgbWFpbiBga25leGAgb2JqZWN0LiBQYXNzZXMgdGhlIGBrbmV4YCBpbnN0YW5jZSBwZXJmb3JtaW5nCi8vIHRoZSBzZWVkcy4KZnVuY3Rpb24gU2VlZGVyKGtuZXgpIHsKICB0aGlzLmtuZXggICA9IGtuZXg7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhrbmV4LmNsaWVudC5zZWVkQ29uZmlnKTsKfQoKLy8gUnVucyBhbGwgc2VlZCBmaWxlcyBmb3IgdGhlIGdpdmVuIGVudmlyb25tZW50LgpTZWVkZXIucHJvdG90eXBlLnJ1biA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbmZpZykgewogIHRoaXMuY29uZmlnID0gdGhpcy5zZXRDb25maWcoY29uZmlnKTsKICByZXR1cm4gdGhpcy5fc2VlZERhdGEoKQogICAgLmJpbmQodGhpcykKICAgIC5zcHJlYWQoZnVuY3Rpb24oYWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9ydW5TZWVkcyhhbGwpOwogICAgfSk7Cn0pOwoKLy8gQ3JlYXRlcyBhIG5ldyBzZWVkIGZpbGUsIHdpdGggYSBnaXZlbiBuYW1lLgpTZWVkZXIucHJvdG90eXBlLm1ha2UgPSBmdW5jdGlvbihuYW1lLCBjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgaWYgKCFuYW1lKSBQcm9taXNlLnJlamVjdGVkKG5ldyBFcnJvcignQSBuYW1lIG11c3QgYmUgc3BlY2lmaWVkIGZvciB0aGUgZ2VuZXJhdGVkIHNlZWQnKSk7CiAgcmV0dXJuIHRoaXMuX2Vuc3VyZUZvbGRlcihjb25maWcpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4odGhpcy5fZ2VuZXJhdGVTdHViVGVtcGxhdGUpCiAgICAudGhlbih0aGlzLl93cml0ZU5ld1NlZWQobmFtZSkpOwp9OwoKLy8gTGlzdHMgYWxsIGF2YWlsYWJsZSBzZWVkIGZpbGVzIGFzIGEgc29ydGVkIGFycmF5LgpTZWVkZXIucHJvdG90eXBlLl9saXN0QWxsID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5yZWFkZGlyLCBmcykodGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbihzZWVkcykgewogICAgICByZXR1cm4gXy5maWx0ZXIoc2VlZHMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIGV4dGVuc2lvbiA9IHBhdGguZXh0bmFtZSh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIF8uY29udGFpbnMoWycuY28nLCAnLmNvZmZlZScsICcuaWNlZCcsICcuanMnLCAnLmxpdGNvZmZlZScsICcubHMnXSwgZXh0ZW5zaW9uKTsKICAgICAgfSkuc29ydCgpOwogICAgfSk7Cn0pOwoKLy8gR2V0cyB0aGUgc2VlZCBmaWxlIGxpc3QgZnJvbSB0aGUgc3BlY2lmaWVkIHNlZWQgZGlyZWN0b3J5LgpTZWVkZXIucHJvdG90eXBlLl9zZWVkRGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBQcm9taXNlLmpvaW4odGhpcy5fbGlzdEFsbCgpKTsKfTsKCgovLyBFbnN1cmVzIGEgZm9sZGVyIGZvciB0aGUgc2VlZHMgZXhpc3QsIGRlcGVuZGVudCBvbiB0aGUKLy8gc2VlZCBjb25maWcgc2V0dGluZ3MuClNlZWRlci5wcm90b3R5cGUuX2Vuc3VyZUZvbGRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGRpciA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMuc3RhdCwgZnMpKGRpcikKICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShta2RpcnApKGRpcik7CiAgICAgIH0pOwp9OwoKLy8gUnVuIHNlZWQgZmlsZXMsIGluIHNlcXVlbmNlLgpTZWVkZXIucHJvdG90eXBlLl9ydW5TZWVkcyA9IGZ1bmN0aW9uKHNlZWRzKSB7CiAgcmV0dXJuIFByb21pc2UuYWxsKF8ubWFwKHNlZWRzLCB0aGlzLl92YWxpZGF0ZVNlZWRTdHJ1Y3R1cmUsIHRoaXMpKQogICAgLmJpbmQodGhpcykKICAgIC50aGVuKGZ1bmN0aW9uKHNlZWRzKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl93YXRlcmZhbGxCYXRjaChzZWVkcyk7CiAgICAgICAgfSk7CiAgICB9KTsKfTsKCi8vIFZhbGlkYXRlcyBzZWVkIGZpbGVzIGJ5IHJlcXVpcmluZyBhbmQgY2hlY2tpbmcgZm9yIGEgYHNlZWRgIGZ1bmN0aW9uLgpTZWVkZXIucHJvdG90eXBlLl92YWxpZGF0ZVNlZWRTdHJ1Y3R1cmUgPSBmdW5jdGlvbihuYW1lKSB7CiAgdmFyIHNlZWQgPSByZXF1aXJlKHBhdGguam9pbih0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpLCBuYW1lKSk7CiAgaWYgKCFfLmlzRnVuY3Rpb24oc2VlZC5zZWVkKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlZWQgZmlsZTogJyArIG5hbWUgKyAnIG11c3QgaGF2ZSBhIHNlZWQgZnVuY3Rpb24nKTsKICB9CiAgcmV0dXJuIG5hbWU7Cn07CgovLyBHZW5lcmF0ZXMgdGhlIHN0dWIgdGVtcGxhdGUgZm9yIHRoZSBjdXJyZW50IHNlZWQgZmlsZSwgcmV0dXJuaW5nIGEgY29tcGlsZWQgdGVtcGxhdGUuClNlZWRlci5wcm90b3R5cGUuX2dlbmVyYXRlU3R1YlRlbXBsYXRlID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0dWJQYXRoID0gdGhpcy5jb25maWcuc3R1YiB8fCBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc3R1YicsIHRoaXMuY29uZmlnLmV4dGVuc2lvbiArICcuc3R1YicpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5yZWFkRmlsZSwgZnMpKHN0dWJQYXRoKS50aGVuKGZ1bmN0aW9uKHN0dWIpIHsKICAgIHJldHVybiBfLnRlbXBsYXRlKHN0dWIudG9TdHJpbmcoKSwgbnVsbCwge3ZhcmlhYmxlOiAnZCd9KTsKICB9KTsKfTsKCi8vIFdyaXRlIGEgbmV3IHNlZWQgdG8gZGlzaywgdXNpbmcgdGhlIGNvbmZpZyBhbmQgZ2VuZXJhdGVkIGZpbGVuYW1lLAovLyBwYXNzaW5nIGFueSBgdmFyaWFibGVzYCBnaXZlbiBpbiB0aGUgY29uZmlnIHRvIHRoZSB0ZW1wbGF0ZS4KU2VlZGVyLnByb3RvdHlwZS5fd3JpdGVOZXdTZWVkID0gZnVuY3Rpb24obmFtZSkgewogIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICB2YXIgZGlyID0gdGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKTsKICByZXR1cm4gZnVuY3Rpb24odG1wbCkgewogICAgaWYgKG5hbWVbMF0gPT09ICctJykgbmFtZSA9IG5hbWUuc2xpY2UoMSk7CiAgICB2YXIgZmlsZW5hbWUgID0gbmFtZSArICcuJyArIGNvbmZpZy5leHRlbnNpb247CiAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMud3JpdGVGaWxlLCBmcykoCiAgICAgIHBhdGguam9pbihkaXIsIGZpbGVuYW1lKSwKICAgICAgdG1wbChjb25maWcudmFyaWFibGVzIHx8IHt9KQogICAgKS5yZXR1cm4ocGF0aC5qb2luKGRpciwgZmlsZW5hbWUpKTsKICB9Owp9OwoKLy8gUnVucyBhIGJhdGNoIG9mIHNlZWQgZmlsZXMuClNlZWRlci5wcm90b3R5cGUuX3dhdGVyZmFsbEJhdGNoID0gZnVuY3Rpb24oc2VlZHMpIHsKICB2YXIga25leCAgICAgID0gdGhpcy5rbmV4OwogIHZhciBzZWVkRGlyZWN0b3J5ID0gdGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKTsKICB2YXIgY3VycmVudCAgID0gUHJvbWlzZS5iaW5kKHtmYWlsZWQ6IGZhbHNlLCBmYWlsZWRPbjogMH0pOwogIHZhciBsb2cgICAgICAgPSBbXTsKICBfLmVhY2goc2VlZHMsIGZ1bmN0aW9uKHNlZWQpIHsKICAgIHZhciBuYW1lICA9IHBhdGguam9pbihzZWVkRGlyZWN0b3J5LCBzZWVkKTsKICAgIHNlZWQgPSByZXF1aXJlKG5hbWUpOwoKICAgIC8vIFJ1biBlYWNoIHNlZWQgZmlsZS4KICAgIGN1cnJlbnQgPSBjdXJyZW50LnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzZWVkLnNlZWQoa25leCwgUHJvbWlzZSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBsb2cucHVzaChuYW1lKTsKICAgIH0pOwogIH0pOwoKICByZXR1cm4gY3VycmVudC50aGVuUmV0dXJuKFtsb2ddKTsKfTsKClNlZWRlci5wcm90b3R5cGUuX2Fic29sdXRlQ29uZmlnRGlyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCB0aGlzLmNvbmZpZy5kaXJlY3RvcnkpOwp9OwoKU2VlZGVyLnByb3RvdHlwZS5zZXRDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICByZXR1cm4gXy5leHRlbmQoewogICAgZXh0ZW5zaW9uOiAnanMnLAogICAgZGlyZWN0b3J5OiAnLi9zZWVkcycKICB9LCB0aGlzLmNvbmZpZyB8fCB7fSwgY29uZmlnKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gU2VlZGVyOwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksIi9ub2RlX21vZHVsZXMva25leC9saWIvc2VlZCIpCn0seyIuLi9wcm9taXNlIjoxMDMsIl9wcm9jZXNzIjo2MCwiZnMiOjUxLCJsb2Rhc2giOjEzMCwibWtkaXJwIjoxMjAsInBhdGgiOjU5fV0sMTE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gVHJhbnNhY3Rpb24KLy8gLS0tLS0tLQp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKLy8gQ3JlYXRlcyBhIG5ldyB3cmFwcGVyIG9iamVjdCBmb3IgY29uc3RydWN0aW5nIGEgdHJhbnNhY3Rpb24uCi8vIENhbGxlZCBieSB0aGUgYGtuZXgudHJhbnNhY3Rpb25gLCB3aGljaCBzZXRzIHRoZSBjb3JyZWN0IGNsaWVudAovLyBhbmQgaGFuZGxlcyB0aGUgYGNvbnRhaW5lcmAgb2JqZWN0LCBwYXNzaW5nIGFsb25nIHRoZSBjb3JyZWN0Ci8vIGBjb25uZWN0aW9uYCB0byBrZWVwIGFsbCBvZiB0aGUgdHJhbnNhY3Rpb25zIG9uIHRoZSBjb3JyZWN0IGNvbm5lY3Rpb24uCmZ1bmN0aW9uIFRyYW5zYWN0aW9uKGNvbnRhaW5lcikgewogIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwp9CmluaGVyaXRzKFRyYW5zYWN0aW9uLCBFdmVudEVtaXR0ZXIpOwoKLy8gQnVpbGQgdGhlIGtuZXggaW5zdGFuY2UgcGFzc2VkIGFyb3VuZCBpbnNpZGUgdGhlIHRyYW5zYWN0aW9uIGNvbnRhaW5lci4KLy8gSXQgY2FuIGJlIHVzZWQgYm90aCBhcyBhIGZ1bGx5IGZ1bmN0aW9uYWwga25leCBpbnN0YW5jZSwgb3IgYXNzaW1pbGF0ZWQKLy8gaW50byBleGlzdGluZyBrbmV4IGNoYWlucyB2aWEgdGhlICIudHJhbnNhY3RpbmciIG1ldGhvZCBjYWxsLgpUcmFuc2FjdGlvbi5wcm90b3R5cGUuY29udGFpbmVyT2JqZWN0ID0gZnVuY3Rpb24ocnVubmVyKSB7CiAgdmFyIEtuZXggPSByZXF1aXJlKCcuLi9rbmV4Jyk7CgogIC8vIENyZWF0ZSBhbiBlbnRpcmVseSBuZXcga25leCBpbnN0YW5jZSBqdXN0IGZvciB0aGlzIHRyYW5zYWN0aW9uCiAgdmFyIHRyYW5zYWN0b3IgPSBLbmV4LmluaXRpYWxpemUoewogICAgX19jbGllbnRfXyAgICAgOiB0aGlzLmNsaWVudCwKICAgIF9fdHJhbnNhY3Rvcl9fIDoge19ydW5uZXI6IHJ1bm5lcn0KICB9KTsKCiAgLy8gUmVtb3ZlIHRoZSBhYmlsaXR5IHRvIHN0YXJ0IGEgdHJhbnNhY3Rpb24gb3IgZGVzdHJveQogIC8vIHRoZSBlbnRpcmUgcG9vbCB3aXRoaW4gYSB0cmFuc2FjdGlvbi4KICB0cmFuc2FjdG9yLmRlc3Ryb3kgPSB0cmFuc2FjdG9yLnRyYW5zYWN0aW9uID0gdm9pZCAwOwoKICAvLyBDb21taXRzIHRoZSB0cmFuc2FjdGlvbjoKICB0cmFuc2FjdG9yLmNvbW1pdCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgIHJ1bm5lci5maW5pc2hUcmFuc2FjdGlvbigwLCB0cmFuc2FjdG9yLCBtZXNzYWdlKTsKICB9OwoKICAvLyBSb2xscyBiYWNrIHRoZSB0cmFuc2FjdGlvbi4KICB0cmFuc2FjdG9yLnJvbGxiYWNrID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgIHJ1bm5lci5maW5pc2hUcmFuc2FjdGlvbigxLCB0cmFuc2FjdG9yLCBlcnJvcik7CiAgfTsKCiAgdHJhbnNhY3Rvci5fcnVubmVyID0gcnVubmVyOwoKICByZXR1cm4gdHJhbnNhY3RvcjsKfTsKClRyYW5zYWN0aW9uLnByb3RvdHlwZS5pbml0aWF0ZURlZmVycmVkID0gZnVuY3Rpb24odHJhbnNhY3RvcikgewoKICAvLyBJbml0aWF0ZSBhIGRlZmVycmVkIG9iamVjdCwgYm91bmQgdG8gdGhlIGNvbnRhaW5lciBvYmplY3QsCiAgLy8gc28gd2Uga25vdyB3aGVuIHRoZSB0cmFuc2FjdGlvbiBjb21wbGV0ZXMgb3IgZmFpbHMKICAvLyBhbmQgY2FuIGNvbnRpbnVlIGZyb20gdGhlcmUuCiAgdmFyIGRmZCA9IHRyYW5zYWN0b3IuX19kZmRfXyA9IFByb21pc2UucGVuZGluZygpOwoKICAvLyBDYWxsIHRoZSBjb250YWluZXIgd2l0aCB0aGUgdHJhbnNhY3Rpb24KICAvLyBjb21taXQgJiByb2xsYmFjayBvYmplY3RzLgogIHZhciByZXN1bHQgPSB0aGlzLmNvbnRhaW5lcih0cmFuc2FjdG9yKTsKCiAgLy8gSWYgd2UndmUgcmV0dXJuZWQgYSAidGhlbmFibGUiIGZyb20gdGhlIHRyYW5zYWN0aW9uIGNvbnRhaW5lciwKICAvLyBhbmQgaXQncyBnb3QgdGhlIHRyYW5zYWN0aW9uIG9iamVjdCB3ZSdyZSBydW5uaW5nIGZvciB0aGlzLCBhc3N1bWUKICAvLyB0aGUgcm9sbGJhY2sgYW5kIGNvbW1pdCBhcmUgY2hhaW5lZCB0byB0aGlzIG9iamVjdCdzIHN1Y2Nlc3MgLyBmYWlsdXJlLgogIGlmIChyZXN1bHQgJiYgcmVzdWx0LnRoZW4gJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXN1bHQudGhlbihmdW5jdGlvbih2YWwpIHsgdHJhbnNhY3Rvci5jb21taXQodmFsKTsgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7IHRyYW5zYWN0b3Iucm9sbGJhY2soZXJyKTsgfSk7CiAgfQoKICAvLyBSZXR1cm4gdGhlIHByb21pc2UgZm9yIHRoZSBlbnRpcmUgdHJhbnNhY3Rpb24uCiAgcmV0dXJuIGRmZC5wcm9taXNlOwp9OwoKLy8gQWxsb3cgdGhlIGBUcmFuc2FjdGlvbmAgb2JqZWN0IHRvIGJlIHV0aWxpemVkIHdpdGggZnVsbCBhY2Nlc3MgdG8gdGhlIHJlbGV2YW50Ci8vIHByb21pc2UgQVBJLgpyZXF1aXJlKCcuL2ludGVyZmFjZScpKFRyYW5zYWN0aW9uKTsKCi8vIFBhc3NlZCBhIGBjb250YWluZXJgIGZ1bmN0aW9uLCB0aGlzIG1ldGhvZCBydW5zIHRoZSBjdXJyZW50Ci8vIHRyYW5zYWN0aW9uLCByZXR1cm5pbmcgYSBwcm9taXNlLgpUcmFuc2FjdGlvbi5wcm90b3R5cGUudGhlbiA9IGZ1bmN0aW9uKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7CiAgdmFyIFJ1bm5lciAgPSB0aGlzLmNsaWVudC5SdW5uZXI7CiAgdmFyIHByb21pc2UgPSB0aGlzOwogIAogIC8vIENyZWF0ZSBhIG5ldyAicnVubmVyIiBvYmplY3QsIHBhc3NpbmcgdGhlICJydW5uZXIiCiAgLy8gb2JqZWN0IGFsb25nLCBzbyB3ZSBjYW4gZWFzaWx5IGtlZXAgdHJhY2sgb2YgZXZlcnkKICAvLyBxdWVyeSBydW4gb24gdGhlIGN1cnJlbnQgY29ubmVjdGlvbi4KICByZXR1cm4gbmV3IFJ1bm5lcih0aGlzKQogICAgLnN0YXJ0VHJhbnNhY3Rpb24oKQogICAgLnRoZW4oZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBwcm9taXNlLmNvbnRhaW5lck9iamVjdChvYmopOwogICAgfSkKICAgIC50aGVuKGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gcHJvbWlzZS5pbml0aWF0ZURlZmVycmVkKG9iaik7CiAgICB9KQogICAgLnRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBUcmFuc2FjdGlvbjsKfSx7Ii4uL2tuZXgiOjc3LCIuL2ludGVyZmFjZSI6MTAwLCIuL3Byb21pc2UiOjEwMywiZXZlbnRzIjo1NywiaW5oZXJpdHMiOjc2fV0sMTE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gR2VuZXJpYyBQb29sIFJlZHV4Ci8vCi8vIEZvcmsgb2YgaHR0cHM6Ly9naXRodWIuY29tL2Nvb3Blcm51cnNlL25vZGUtcG9vbAovLyB3aXRoIHByb3RvdHlwZXMsIGFwaSBjaGFuZ2VzLCBhbmQgc3VwcG9ydCBmb3IgdGhlIGNsaWVudC4KLy8gTGljZW5zZTogTUlUCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQooZnVuY3Rpb24oZGVmaW5lKSB7CgoidXNlIHN0cmljdCI7CgpkZWZpbmUoZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7CgogIC8vIEluaXRpYWxpemUgYXJyYXlzIHRvIGhvbGQgcXVldWUgZWxlbWVudHMuCiAgdmFyIFByaW9yaXR5UXVldWUgPSBmdW5jdGlvbihzaXplKSB7CiAgICB0aGlzLnNsb3RzID0gW107CiAgICB0aGlzLnF1ZXVlU2l6ZSA9IE1hdGgubWF4KCtzaXplIHwgMCwgMSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucXVldWVTaXplOyBpICs9IDEpIHsKICAgICAgdGhpcy5zbG90cy5wdXNoKFtdKTsKICAgIH0KICB9OwoKICBQcmlvcml0eVF1ZXVlLnByb3RvdHlwZSA9IHsKCiAgICB0b3RhbDogbnVsbCwKCiAgICAvLyBDYWxjdWxhdGVzIHRoZSBzaXplIG9mIHRoZSBxdWV1ZSwgYW5kIHNldHMKICAgIC8vIHRoZSB2YWx1ZSB0byB0b3RhbC4KICAgIHNpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy50b3RhbCA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5xdWV1ZVNpemU7IGkgKz0gMSkgewogICAgICAgICAgdGhpcy50b3RhbCArPSB0aGlzLnNsb3RzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMudG90YWw7CiAgICB9LAoKICAgIC8vIENsZWFycyB0aGUgY2FjaGUgZm9yIHRvdGFsIGFuZCBhZGRzIGFuCiAgICAvLyBvYmplY3QgdG8gdGhlIHF1ZXVlLCBiYXNlZCBvbiBhbiBvcHRpb25hbCBwcmlvcml0eS4KICAgIGVucXVldWU6IGZ1bmN0aW9uKG9iaiwgcHJpb3JpdHkpIHsKICAgICAgcHJpb3JpdHkgPSBwcmlvcml0eSAmJiArcHJpb3JpdHkgfCAwIHx8IDA7CiAgICAgIHRoaXMudG90YWwgPSBudWxsOwogICAgICBpZiAocHJpb3JpdHkpIHsKICAgICAgICB2YXIgcHJpb3JpdHlPcmlnID0gcHJpb3JpdHk7CiAgICAgICAgaWYgKHByaW9yaXR5IDwgMCB8fCBwcmlvcml0eSA+PSB0aGlzLnF1ZXVlU2l6ZSkgewogICAgICAgICAgcHJpb3JpdHkgPSAodGhpcy5zaXplIC0gMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuc2xvdHNbcHJpb3JpdHldLnB1c2gob2JqKTsKICAgIH0sCgogICAgLy8gQ2xlYXJzIHRoZSBjYWNoZSBmb3IgdG90YWwgYW5kIHJlbW92ZXMgYW4gb2JqZWN0CiAgICAvLyBmcm9tIHRoZSBxdWV1ZS4KICAgIGRlcXVldWU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gbnVsbCwgaSwgc2wgPSB0aGlzLnNsb3RzLmxlbmd0aDsKICAgICAgdGhpcy50b3RhbCA9IG51bGw7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBzbDsgaSArPSAxKSB7CiAgICAgICAgaWYgKHRoaXMuc2xvdHNbaV0ubGVuZ3RoKSB7CiAgICAgICAgICBvYmogPSB0aGlzLnNsb3RzW2ldLnNoaWZ0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgfTsKCiAgLy8gQ29uc3RydWN0b3IgZm9yIGEgbmV3IHBvb2wuCiAgdmFyIFBvb2wgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUG9vbCkpIHJldHVybiBuZXcgUG9vbChvcHRpb25zKTsKICAgIHRoaXMuaWRsZVRpbWVvdXRNaWxsaXMgPSBvcHRpb25zLmlkbGVUaW1lb3V0TWlsbGlzICB8fCAzMDAwMDsKICAgIHRoaXMucmVhcEludGVydmFsICAgICAgPSBvcHRpb25zLnJlYXBJbnRlcnZhbE1pbGxpcyB8fCAxMDAwOwogICAgdGhpcy5kZXN0cm95SGFuZGxlciAgICA9IG9wdGlvbnMuZGVzdHJveSB8fCBmdW5jdGlvbigpIHt9OwogICAgdGhpcy5yZWZyZXNoSWRsZSAgICAgICA9ICgncmVmcmVzaElkbGUnIGluIG9wdGlvbnMpID8gb3B0aW9ucy5yZWZyZXNoSWRsZSA6IHRydWU7CiAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgID0gW107CiAgICB0aGlzLndhaXRpbmdDbGllbnRzICAgID0gbmV3IFByaW9yaXR5UXVldWUob3B0aW9ucy5wcmlvcml0eVJhbmdlIHx8IDEpOwogICAgdGhpcy5jcmVhdGUgICAgICAgICAgICA9IG9wdGlvbnMuY3JlYXRlIHx8IChmdW5jdGlvbigpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIGNyZWF0ZSBtZXRob2QgbXVzdCBiZSBkZWZpbmVkIGZvciB0aGUgY29ubmVjdGlvbiBwb29sLicpOwogICAgfSkoKTsKCiAgICAvLyBJZiBhIHZhbGlkYXRlIG1ldGhvZCBpcyBwcm92aWRlZCwgdXNlIHRoYXQgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdC4KICAgIGlmIChvcHRpb25zLnZhbGlkYXRlKSB0aGlzLnZhbGlkYXRlID0gb3B0aW9ucy52YWxpZGF0ZTsKCiAgICAvLyBTZXQgdGhlIG1heCAmIG1pbidzIG9uIHRoZSBvcHRpb25zLgogICAgdmFyIG1heCA9IHBhcnNlSW50KG9wdGlvbnMubWF4LCAxMCk7CiAgICB2YXIgbWluID0gcGFyc2VJbnQob3B0aW9ucy5taW4sIDEwKTsKICAgIHRoaXMubWF4ID0gTWF0aC5tYXgoaXNOYU4obWF4KSA/IDEgOiBtYXgsIDEpOwogICAgdGhpcy5taW4gPSBNYXRoLm1pbihpc05hTihtaW4pID8gMCA6IG1pbiwgdGhpcy5tYXggLSAxKTsKCiAgICAvLyBFbnN1cmUgdGhlIG1pbmltdW0gaXMgY3JlYXRlZC4KICAgIHRoaXMuZW5zdXJlTWluaW11bSgpOwogIH07CgogIFBvb2wucHJvdG90eXBlID0gewoKICAgIGNvdW50OiAwLAoKICAgIGRyYWluaW5nOiBmYWxzZSwKCiAgICByZW1vdmVJZGxlVGltZXI6IG51bGwsCgogICAgcmVtb3ZlSWRsZVNjaGVkdWxlZDogZmFsc2UsCgogICAgLy8gRGVmYXVsdCB2YWxpZGF0ZS4KICAgIHZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8vIFJlcXVlc3QgYSBuZXcgY2xpZW50LiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQsCiAgICAvLyB3aGVuIGEgbmV3IGNsaWVudCB3aWxsIGJlIGF2YWlsYWJlLCBwYXNzaW5nIHRoZSBjbGllbnQgdG8gaXQuCiAgICAvLyBPcHRpb25hbGx5LCB5b3kgbWF5IHNwZWNpZnkgYSBwcmlvcml0eSBvZiB0aGUgY2FsbGVyIGlmIHRoZXJlIGFyZSBubwogICAgLy8gYXZhaWxhYmxlIHJlc291cmNlcy4gIExvd2VyIG51bWJlcnMgbWVhbiBoaWdoZXIgcHJpb3JpdHkuCiAgICBhY3F1aXJlOiBmdW5jdGlvbihjYWxsYmFjaywgcHJpb3JpdHkpIHsKICAgICAgaWYgKHRoaXMuZHJhaW5pbmcpIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoIlBvb2wgaXMgZHJhaW5pbmcgYW5kIGNhbm5vdCBhY2NlcHQgd29yayIpKTsKICAgICAgdGhpcy53YWl0aW5nQ2xpZW50cy5lbnF1ZXVlKGNhbGxiYWNrLCBwcmlvcml0eSk7CiAgICAgIHRoaXMuZGlzcGVuc2UoKTsKICAgICAgcmV0dXJuICh0aGlzLmNvdW50IDwgdGhpcy5tYXgpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGNsaWVudCB0byB0aGUgcG9vbCwgaW4gY2FzZSBpdCBpcyBubyBsb25nZXIgcmVxdWlyZWQuCiAgICByZWxlYXNlOiBmdW5jdGlvbihvYmosIGNhbGxiYWNrKSB7CiAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGlzIG9iamVjdCBoYXMgYWxyZWFkeSBiZWVuIHJlbGVhc2VkIChpLmUuLCBpcyBiYWNrIGluIHRoZSBwb29sIG9mIGF2YWlsYWJsZU9iamVjdHMpCiAgICAgIGlmICh0aGlzLmF2YWlsYWJsZU9iamVjdHMuc29tZShmdW5jdGlvbihvYmpXaXRoVGltZW91dCkgewogICAgICAgIHJldHVybiAob2JqV2l0aFRpbWVvdXQub2JqID09PSBvYmopOwogICAgICB9KSkgewogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sobmV3IEVycm9yKCdSZWxlYXNlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBvbiB0aGUgc2FtZSBvYmplY3QnKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBvYmpXaXRoVGltZW91dCA9IHsKICAgICAgICBvYmo6IG9iaiwKICAgICAgICB0aW1lb3V0OiAobmV3IERhdGUoKS5nZXRUaW1lKCkgKyB0aGlzLmlkbGVUaW1lb3V0TWlsbGlzKQogICAgICB9OwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMucHVzaChvYmpXaXRoVGltZW91dCk7CiAgICAgIHRoaXMuZGlzcGVuc2UoKTsKICAgICAgdGhpcy5zY2hlZHVsZVJlbW92ZUlkbGUoKTsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsKTsKICAgIH0sCgogICAgLy8gVHJ5IHRvIGdldCBhIG5ldyBjbGllbnQgdG8gd29yaywgYW5kIGNsZWFuIHVwIHBvb2wgdW51c2VkIChpZGxlKSBpdGVtcy4KICAgIC8vCiAgICAvLyAtIElmIHRoZXJlIGFyZSBhdmFpbGFibGUgY2xpZW50cyB3YWl0aW5nLCBzaGlmdCB0aGUgZmlyc3Qgb25lIG91dCAoTElGTyksCiAgICAvLyAgIGFuZCBjYWxsIGl0cyBjYWxsYmFjay4KICAgIC8vIC0gSWYgdGhlcmUgYXJlIG5vIHdhaXRpbmcgY2xpZW50cywgdHJ5IHRvIGNyZWF0ZSBvbmUgaWYgaXQgd29uJ3QgZXhjZWVkCiAgICAvLyAgIHRoZSBtYXhpbXVtIG51bWJlciBvZiBjbGllbnRzLgogICAgLy8gLSBJZiBjcmVhdGluZyBhIG5ldyBjbGllbnQgd291bGQgZXhjZWVkIHRoZSBtYXhpbXVtLCBhZGQgdGhlIGNsaWVudCB0bwogICAgLy8gICB0aGUgd2FpdCBsaXN0LgogICAgZGlzcGVuc2U6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gbnVsbCwKICAgICAgICBvYmpXaXRoVGltZW91dCA9IG51bGwsCiAgICAgICAgZXJyID0gbnVsbCwKICAgICAgICBjbGllbnRDYiA9IG51bGwsCiAgICAgICAgd2FpdGluZ0NvdW50ID0gdGhpcy53YWl0aW5nQ2xpZW50cy5zaXplKCk7CgogICAgICBpZiAod2FpdGluZ0NvdW50ID4gMCkgewogICAgICAgIHdoaWxlICh0aGlzLmF2YWlsYWJsZU9iamVjdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgb2JqV2l0aFRpbWVvdXQgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHNbMF07CiAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGUob2JqV2l0aFRpbWVvdXQub2JqKSkgewogICAgICAgICAgICB0aGlzLmRlc3Ryb3kob2JqV2l0aFRpbWVvdXQub2JqKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMuc2hpZnQoKTsKICAgICAgICAgIGNsaWVudENiID0gdGhpcy53YWl0aW5nQ2xpZW50cy5kZXF1ZXVlKCk7CiAgICAgICAgICByZXR1cm4gY2xpZW50Q2IoZXJyLCBvYmpXaXRoVGltZW91dC5vYmopOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jb3VudCA8IHRoaXMubWF4KSB7CiAgICAgICAgICB0aGlzLmNyZWF0ZVJlc291cmNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIERpc2FsbG93IGFueSBuZXcgcmVxdWVzdHMgYW5kIGxldCB0aGUgcmVxdWVzdCBiYWNrbG9nIGRpc3NhcGF0ZSwKICAgIC8vIFNldHRpbmcgdGhlIGBkcmFpbmluZ2AgZmxhZyBzbyBhcyB0byBsZXQgYW55IGFkZGl0aW9uYWwgd29yayBvbiB0aGUgcXVldWUKICAgIC8vIGRpc3NhcGF0ZS4KICAgIGRyYWluOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLmRyYWluaW5nID0gdHJ1ZTsKICAgICAgdmFyIHBvb2wgPSB0aGlzOwogICAgICB2YXIgY2hlY2tpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAocG9vbC53YWl0aW5nQ2xpZW50cy5zaXplKCkgPiAwIHx8IHBvb2wuYXZhaWxhYmxlT2JqZWN0cy5sZW5ndGggIT0gcG9vbC5jb3VudCkgewogICAgICAgICAgc2V0VGltZW91dChjaGVja2luZywgMTAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY2hlY2tpbmcoKTsKICAgIH0sCgogICAgLy8gRm9yY2libHkgZGVzdHJveXMgYWxsIGNsaWVudHMgcmVnYXJkbGVzcyBvZiB0aW1lb3V0LiBJbnRlbmRlZCB0byBiZQogICAgLy8gaW52b2tlZCBhcyBwYXJ0IG9mIGEgZHJhaW4uIERvZXMgbm90IHByZXZlbnQgdGhlIGNyZWF0aW9uIG9mIG5ldwogICAgLy8gY2xpZW50cyBhcyBhIHJlc3VsdCBvZiBzdWJzZXF1ZW50IGNhbGxzIHRvIGFjcXVpcmUuCiAgICAvLwogICAgLy8gTm90ZSB0aGF0IGlmIHRoaXMubWluID4gMCwgdGhlIHBvb2wgd2lsbCBkZXN0cm95IGFsbCBpZGxlIHJlc291cmNlcwogICAgLy8gaW4gdGhlIHBvb2wsIGJ1dCByZXBsYWNlIHRoZW0gd2l0aCBuZXdseSBjcmVhdGVkIHJlc291cmNlcyB1cCB0byB0aGUKICAgIC8vIHNwZWNpZmllZCB0aGlzLm1pbiB2YWx1ZS4gIElmIHRoaXMgaXMgbm90IGRlc2lyZWQsIHNldCB0aGlzLm1pbgogICAgLy8gdG8gemVybyBiZWZvcmUgY2FsbGluZyBkZXN0cm95QWxsTm93KCkKICAgIGRlc3Ryb3lBbGxOb3c6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciB3aWxsRGllID0gdGhpcy5hdmFpbGFibGVPYmplY3RzOwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgPSBbXTsKICAgICAgdmFyIG9iaiA9IHdpbGxEaWUuc2hpZnQoKTsKICAgICAgd2hpbGUgKG9iaiAhPT0gbnVsbCAmJiBvYmogIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuZGVzdHJveShvYmoub2JqKTsKICAgICAgICBvYmogPSB3aWxsRGllLnNoaWZ0KCk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlbW92ZUlkbGVUaW1lcik7CiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKICAgIH0sCgogICAgLy8gRGVjb3JhdGVzIGEgZnVuY3Rpb24gdG8gdXNlIGEgYWNxdWlyZWQgY2xpZW50IGZyb20gdGhlIG9iamVjdCBwb29sIHdoZW4gY2FsbGVkLgogICAgcG9vbGVkOiBmdW5jdGlvbihkZWNvcmF0ZWQsIHByaW9yaXR5KSB7CiAgICAgIHZhciBwb29sID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWxsZXJBcmdzID0gYXJndW1lbnRzOwogICAgICAgIHZhciBjYWxsZXJDYWxsYmFjayA9IGNhbGxlckFyZ3NbY2FsbGVyQXJncy5sZW5ndGggLSAxXTsKICAgICAgICB2YXIgY2FsbGVySGFzQ2FsbGJhY2sgPSB0eXBlb2YgY2FsbGVyQ2FsbGJhY2sgPT09ICdmdW5jdGlvbic7CiAgICAgICAgcG9vbC5hY3F1aXJlKGZ1bmN0aW9uKGVyciwgY2xpZW50KSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGlmIChjYWxsZXJIYXNDYWxsYmFjaykgY2FsbGVyQ2FsbGJhY2soZXJyLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFyZ3MgPSBbY2xpZW50XS5jb25jYXQoc2xpY2UuY2FsbChjYWxsZXJBcmdzLCAwLCBjYWxsZXJIYXNDYWxsYmFjayA/IC0xIDogdW5kZWZpbmVkKSk7CiAgICAgICAgICBhcmdzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvb2wucmVsZWFzZS5jYWxsKHBvb2wsIGNsaWVudCk7CiAgICAgICAgICAgIGlmIChjYWxsZXJIYXNDYWxsYmFjaykgY2FsbGVyQ2FsbGJhY2suYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZGVjb3JhdGVkLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0sIHByaW9yaXR5KTsKICAgICAgfTsKICAgIH0sCgogICAgLy8gUmVxdWVzdCB0aGUgY2xpZW50IHRvIGJlIGRlc3Ryb3llZC4gVGhlIGZhY3RvcnkncyBkZXN0cm95IGhhbmRsZXIKICAgIC8vIHdpbGwgYWxzbyBiZSBjYWxsZWQuIFRoaXMgc2hvdWxkIGJlIGNhbGxlZCB3aXRoaW4gYW4gYWNxdWlyZSgpCiAgICAvLyBibG9jayBhcyBhbiBhbHRlcm5hdGl2ZSB0byByZWxlYXNlKCkuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvYmopIHsKICAgICAgdGhpcy5jb3VudCAtPSAxOwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHMuZmlsdGVyKGZ1bmN0aW9uKG9ialdpdGhUaW1lb3V0KSB7CiAgICAgICAgcmV0dXJuIChvYmpXaXRoVGltZW91dC5vYmogIT09IG9iaik7CiAgICAgIH0pOwogICAgICB0aGlzLmRlc3Ryb3lIYW5kbGVyKG9iaik7CiAgICAgIHRoaXMuZW5zdXJlTWluaW11bSgpOwogICAgfSwKCiAgICAvLyBDaGVja3MgYW5kIHJlbW92ZXMgdGhlIGF2YWlsYWJsZSAoaWRsZSkgY2xpZW50cyB0aGF0IGhhdmUgdGltZWQgb3V0LgogICAgcmVtb3ZlSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0b1JlbW92ZSA9IFtdLAogICAgICAgIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgIGksIGF2YWlsYWJsZUxlbmd0aCwgdHIsIHRpbWVvdXQ7CgogICAgICB0aGlzLnJlbW92ZUlkbGVTY2hlZHVsZWQgPSBmYWxzZTsKCiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGF2YWlsYWJsZSAoaWRsZSkgaXRlbXMsCiAgICAgIC8vIGNoZWNrIGlmIHRoZXkgaGF2ZSB0aW1lZCBvdXQKICAgICAgZm9yIChpID0gMCwgYXZhaWxhYmxlTGVuZ3RoID0gdGhpcy5hdmFpbGFibGVPYmplY3RzLmxlbmd0aDsgaSA8IGF2YWlsYWJsZUxlbmd0aCAmJiAodGhpcy5yZWZyZXNoSWRsZSB8fCAodGhpcy5jb3VudCAtIHRoaXMubWluID4gdG9SZW1vdmUubGVuZ3RoKSk7IGkgKz0gMSkgewogICAgICAgIHRpbWVvdXQgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHNbaV0udGltZW91dDsKICAgICAgICBpZiAobm93ID49IHRpbWVvdXQpIHsKICAgICAgICAgIC8vIENsaWVudCB0aW1lZCBvdXQsIHNvIGRlc3Ryb3kgaXQuCiAgICAgICAgICB0b1JlbW92ZS5wdXNoKHRoaXMuYXZhaWxhYmxlT2JqZWN0c1tpXS5vYmopOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpID0gMCwgdHIgPSB0b1JlbW92ZS5sZW5ndGg7IGkgPCB0cjsgaSArPSAxKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KHRvUmVtb3ZlW2ldKTsKICAgICAgfQoKICAgICAgLy8gUmVwbGFjZSB0aGUgYXZhaWxhYmxlIGl0ZW1zIHdpdGggdGhlIG9uZXMgdG8ga2VlcC4KICAgICAgYXZhaWxhYmxlTGVuZ3RoID0gdGhpcy5hdmFpbGFibGVPYmplY3RzLmxlbmd0aDsKCiAgICAgIGlmIChhdmFpbGFibGVMZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5zY2hlZHVsZVJlbW92ZUlkbGUoKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBTY2hlZHVsZSByZW1vdmFsIG9mIGlkbGUgaXRlbXMgaW4gdGhlIHBvb2wuCiAgICAvLyBNb3JlIHNjaGVkdWxlcyBjYW5ub3QgcnVuIGNvbmN1cnJlbnRseS4KICAgIHNjaGVkdWxlUmVtb3ZlSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkKSB7CiAgICAgICAgdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICB2YXIgcG9vbCA9IHRoaXM7CiAgICAgICAgdGhpcy5yZW1vdmVJZGxlVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgcG9vbC5yZW1vdmVJZGxlLmNhbGwocG9vbCk7CiAgICAgICAgfSwgdGhpcy5yZWFwSW50ZXJ2YWwpOwogICAgICB9CiAgICB9LAoKICAgIC8vIENyZWF0ZXMgYSBuZXcgcmVzb3VyY2UsIGFkZGluZyBhbiBvYmplY3QgdG8gdGhlIHBvb2wKICAgIGNyZWF0ZVJlc291cmNlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBvb2wgPSB0aGlzOwogICAgICB0aGlzLmNvdW50ICs9IDE7CiAgICAgIHRoaXMuY3JlYXRlKGZ1bmN0aW9uKGVyciwgb2JqKSB7CiAgICAgICAgdmFyIGNsaWVudENiID0gcG9vbC53YWl0aW5nQ2xpZW50cy5kZXF1ZXVlKCk7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcG9vbC5jb3VudCAtPSAxOwogICAgICAgICAgaWYgKGNsaWVudENiKSBjbGllbnRDYihlcnIsIG51bGwpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9vbC5kaXNwZW5zZS5jYWxsKHBvb2wpOwogICAgICAgICAgfSwgMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjbGllbnRDYikgcmV0dXJuIGNsaWVudENiKG51bGwsIG9iaik7CiAgICAgICAgICBwb29sLnJlbGVhc2Uob2JqKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBJZiB0aGUgY2xpZW50IGlzbid0IGluIHRoZSBwcm9jZXNzIG9mIGRyYWluaW5nLCB0aGlzIGVuc3VyZXMKICAgIC8vIHRoYXQgdGhlIG1pbmltdW0gbnVtYmVyIG9mIHJlc291cmNlcyBhcmUgYWx3YXlzIGFyb3VuZC4KICAgIGVuc3VyZU1pbmltdW06IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaSwgZGlmZjsKICAgICAgaWYgKCF0aGlzLmRyYWluaW5nICYmICh0aGlzLmNvdW50IDwgdGhpcy5taW4pKSB7CiAgICAgICAgZGlmZiA9IHRoaXMubWluIC0gdGhpcy5jb3VudDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGlmZjsgaSsrKSB7CiAgICAgICAgICB0aGlzLmNyZWF0ZVJlc291cmNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKICBtb2R1bGUuZXhwb3J0cyA9IHsKCiAgICAvLyBFeHBvcnQgdGhlIGBQb29sYCBjb25zdHJ1Y3Rvci4KICAgIFBvb2w6IFBvb2wsCgogICAgLy8gRXhwb3J0IHRoZSBQcmlvcml0eVF1ZXVlIGNvbnN0cnVjdG9yLCBpbiBjYXNlIGFueW9uZSB3YW50cyB0byBmaWRkbGUgd2l0aCB0aGF0LgogICAgUHJpb3JpdHlRdWV1ZTogUHJpb3JpdHlRdWV1ZQoKICB9OwoKfSk7Cgp9KSgKICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUgOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyBmYWN0b3J5KHJlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZSk7IH0KKTsKfSx7fV0sMTIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKdmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7CnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7Cgptb2R1bGUuZXhwb3J0cyA9IG1rZGlyUC5ta2RpcnAgPSBta2RpclAubWtkaXJQID0gbWtkaXJQOwoKZnVuY3Rpb24gbWtkaXJQIChwLCBvcHRzLCBmLCBtYWRlKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBmID0gb3B0czsKICAgICAgICBvcHRzID0ge307CiAgICB9CiAgICBlbHNlIGlmICghb3B0cyB8fCB0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcpIHsKICAgICAgICBvcHRzID0geyBtb2RlOiBvcHRzIH07CiAgICB9CiAgICAKICAgIHZhciBtb2RlID0gb3B0cy5tb2RlOwogICAgdmFyIHhmcyA9IG9wdHMuZnMgfHwgZnM7CiAgICAKICAgIGlmIChtb2RlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBtb2RlID0gMDc3NyAmICh+cHJvY2Vzcy51bWFzaygpKTsKICAgIH0KICAgIGlmICghbWFkZSkgbWFkZSA9IG51bGw7CiAgICAKICAgIHZhciBjYiA9IGYgfHwgZnVuY3Rpb24gKCkge307CiAgICBwID0gcGF0aC5yZXNvbHZlKHApOwogICAgCiAgICB4ZnMubWtkaXIocCwgbW9kZSwgZnVuY3Rpb24gKGVyKSB7CiAgICAgICAgaWYgKCFlcikgewogICAgICAgICAgICBtYWRlID0gbWFkZSB8fCBwOwogICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbWFkZSk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoZXIuY29kZSkgewogICAgICAgICAgICBjYXNlICdFTk9FTlQnOgogICAgICAgICAgICAgICAgbWtkaXJQKHBhdGguZGlybmFtZShwKSwgb3B0cywgZnVuY3Rpb24gKGVyLCBtYWRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVyKSBjYihlciwgbWFkZSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBta2RpclAocCwgb3B0cywgY2IsIG1hZGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIC8vIEluIHRoZSBjYXNlIG9mIGFueSBvdGhlciBlcnJvciwganVzdCBzZWUgaWYgdGhlcmUncyBhIGRpcgogICAgICAgICAgICAvLyB0aGVyZSBhbHJlYWR5LiAgSWYgc28sIHRoZW4gaG9vcmF5ISAgSWYgbm90LCB0aGVuIHNvbWV0aGluZwogICAgICAgICAgICAvLyBpcyBib3JrZWQuCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB4ZnMuc3RhdChwLCBmdW5jdGlvbiAoZXIyLCBzdGF0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHN0YXQgZmFpbHMsIHRoZW4gdGhhdCdzIHN1cGVyIHdlaXJkLgogICAgICAgICAgICAgICAgICAgIC8vIGxldCB0aGUgb3JpZ2luYWwgZXJyb3IgYmUgdGhlIGZhaWx1cmUgcmVhc29uLgogICAgICAgICAgICAgICAgICAgIGlmIChlcjIgfHwgIXN0YXQuaXNEaXJlY3RvcnkoKSkgY2IoZXIsIG1hZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjYihudWxsLCBtYWRlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfSk7Cn0KCm1rZGlyUC5zeW5jID0gZnVuY3Rpb24gc3luYyAocCwgb3B0cywgbWFkZSkgewogICAgaWYgKCFvcHRzIHx8IHR5cGVvZiBvcHRzICE9PSAnb2JqZWN0JykgewogICAgICAgIG9wdHMgPSB7IG1vZGU6IG9wdHMgfTsKICAgIH0KICAgIAogICAgdmFyIG1vZGUgPSBvcHRzLm1vZGU7CiAgICB2YXIgeGZzID0gb3B0cy5mcyB8fCBmczsKICAgIAogICAgaWYgKG1vZGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIG1vZGUgPSAwNzc3ICYgKH5wcm9jZXNzLnVtYXNrKCkpOwogICAgfQogICAgaWYgKCFtYWRlKSBtYWRlID0gbnVsbDsKCiAgICBwID0gcGF0aC5yZXNvbHZlKHApOwoKICAgIHRyeSB7CiAgICAgICAgeGZzLm1rZGlyU3luYyhwLCBtb2RlKTsKICAgICAgICBtYWRlID0gbWFkZSB8fCBwOwogICAgfQogICAgY2F0Y2ggKGVycjApIHsKICAgICAgICBzd2l0Y2ggKGVycjAuY29kZSkgewogICAgICAgICAgICBjYXNlICdFTk9FTlQnIDoKICAgICAgICAgICAgICAgIG1hZGUgPSBzeW5jKHBhdGguZGlybmFtZShwKSwgb3B0cywgbWFkZSk7CiAgICAgICAgICAgICAgICBzeW5jKHAsIG9wdHMsIG1hZGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAvLyBJbiB0aGUgY2FzZSBvZiBhbnkgb3RoZXIgZXJyb3IsIGp1c3Qgc2VlIGlmIHRoZXJlJ3MgYSBkaXIKICAgICAgICAgICAgLy8gdGhlcmUgYWxyZWFkeS4gIElmIHNvLCB0aGVuIGhvb3JheSEgIElmIG5vdCwgdGhlbiBzb21ldGhpbmcKICAgICAgICAgICAgLy8gaXMgYm9ya2VkLgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIHN0YXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXQgPSB4ZnMuc3RhdFN5bmMocCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXN0YXQuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyMDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbWFkZTsKfTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiX3Byb2Nlc3MiOjYwLCJmcyI6NTEsInBhdGgiOjU5fV0sMTIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKYXJndW1lbnRzWzRdWzYyXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKfSx7Ii4vX3N0cmVhbV9yZWFkYWJsZSI6MTIzLCIuL19zdHJlYW1fd3JpdGFibGUiOjEyNSwiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvcmVhZGFibGUtc3RyZWFtL2xpYi9fc3RyZWFtX2R1cGxleC5qcyI6NjIsIl9wcm9jZXNzIjo2MCwiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Nn1dLDEyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmFyZ3VtZW50c1s0XVs2M11bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCn0seyIuL19zdHJlYW1fdHJhbnNmb3JtIjoxMjQsIi9Vc2Vycy90Z3JpZXNzZXIvR2l0aHViL2Jvb2tzaGVsZi9ib29rc2hlbGYvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL3JlYWRhYmxlLXN0cmVhbS9saWIvX3N0cmVhbV9wYXNzdGhyb3VnaC5qcyI6NjMsImNvcmUtdXRpbC1pcyI6MTI2LCJpbmhlcml0cyI6NzZ9XSwxMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFJlYWRhYmxlOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5Jyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXInKS5CdWZmZXI7Ci8qPC9yZXBsYWNlbWVudD4qLwoKUmVhZGFibGUuUmVhZGFibGVTdGF0ZSA9IFJlYWRhYmxlU3RhdGU7Cgp2YXIgRUUgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovKjxyZXBsYWNlbWVudD4qLwppZiAoIUVFLmxpc3RlbmVyQ291bnQpIEVFLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJzKHR5cGUpLmxlbmd0aDsKfTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyaW5nRGVjb2RlcjsKCgovKjxyZXBsYWNlbWVudD4qLwp2YXIgZGVidWcgPSByZXF1aXJlKCd1dGlsJyk7CmlmIChkZWJ1ZyAmJiBkZWJ1Zy5kZWJ1Z2xvZykgewogIGRlYnVnID0gZGVidWcuZGVidWdsb2coJ3N0cmVhbScpOwp9IGVsc2UgewogIGRlYnVnID0gZnVuY3Rpb24gKCkge307Cn0KLyo8L3JlcGxhY2VtZW50PiovCgoKdXRpbC5pbmhlcml0cyhSZWFkYWJsZSwgU3RyZWFtKTsKCmZ1bmN0aW9uIFJlYWRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCBpdCBzdG9wcyBjYWxsaW5nIF9yZWFkKCkgdG8gZmlsbCB0aGUgYnVmZmVyCiAgLy8gTm90ZTogMCBpcyBhIHZhbGlkIHZhbHVlLCBtZWFucyAiZG9uJ3QgY2FsbCBfcmVhZCBwcmVlbXB0aXZlbHkgZXZlciIKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHZhciBkZWZhdWx0SHdtID0gb3B0aW9ucy5vYmplY3RNb2RlID8gMTYgOiAxNiAqIDEwMjQ7CiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gKGh3bSB8fCBod20gPT09IDApID8gaHdtIDogZGVmYXVsdEh3bTsKCiAgLy8gY2FzdCB0byBpbnRzLgogIHRoaXMuaGlnaFdhdGVyTWFyayA9IH5+dGhpcy5oaWdoV2F0ZXJNYXJrOwoKICB0aGlzLmJ1ZmZlciA9IFtdOwogIHRoaXMubGVuZ3RoID0gMDsKICB0aGlzLnBpcGVzID0gbnVsbDsKICB0aGlzLnBpcGVzQ291bnQgPSAwOwogIHRoaXMuZmxvd2luZyA9IG51bGw7CiAgdGhpcy5lbmRlZCA9IGZhbHNlOwogIHRoaXMuZW5kRW1pdHRlZCA9IGZhbHNlOwogIHRoaXMucmVhZGluZyA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWNhdXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gd2hlbmV2ZXIgd2UgcmV0dXJuIG51bGwsIHRoZW4gd2Ugc2V0IGEgZmxhZyB0byBzYXkKICAvLyB0aGF0IHdlJ3JlIGF3YWl0aW5nIGEgJ3JlYWRhYmxlJyBldmVudCBlbWlzc2lvbi4KICB0aGlzLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIHRoaXMuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgdGhpcy5yZWFkYWJsZUxpc3RlbmluZyA9IGZhbHNlOwoKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnLiBVc2VkIHRvIG1ha2UgcmVhZChuKSBpZ25vcmUgbiBhbmQgdG8KICAvLyBtYWtlIGFsbCB0aGUgYnVmZmVyIG1lcmdpbmcgYW5kIGxlbmd0aCBjaGVja3MgZ28gYXdheQogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICBpZiAoc3RyZWFtIGluc3RhbmNlb2YgRHVwbGV4KQogICAgdGhpcy5vYmplY3RNb2RlID0gdGhpcy5vYmplY3RNb2RlIHx8ICEhb3B0aW9ucy5yZWFkYWJsZU9iamVjdE1vZGU7CgogIC8vIENyeXB0byBpcyBraW5kIG9mIG9sZCBhbmQgY3J1c3R5LiAgSGlzdG9yaWNhbGx5LCBpdHMgZGVmYXVsdCBzdHJpbmcKICAvLyBlbmNvZGluZyBpcyAnYmluYXJ5JyBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhpcyBjb25maWd1cmFibGUuCiAgLy8gRXZlcnl0aGluZyBlbHNlIGluIHRoZSB1bml2ZXJzZSB1c2VzICd1dGY4JywgdGhvdWdoLgogIHRoaXMuZGVmYXVsdEVuY29kaW5nID0gb3B0aW9ucy5kZWZhdWx0RW5jb2RpbmcgfHwgJ3V0ZjgnOwoKICAvLyB3aGVuIHBpcGluZywgd2Ugb25seSBjYXJlIGFib3V0ICdyZWFkYWJsZScgZXZlbnRzIHRoYXQgaGFwcGVuCiAgLy8gYWZ0ZXIgcmVhZCgpaW5nIGFsbCB0aGUgYnl0ZXMgYW5kIG5vdCBnZXR0aW5nIGFueSBwdXNoYmFjay4KICB0aGlzLnJhbk91dCA9IGZhbHNlOwoKICAvLyB0aGUgbnVtYmVyIG9mIHdyaXRlcnMgdGhhdCBhcmUgYXdhaXRpbmcgYSBkcmFpbiBldmVudCBpbiAucGlwZSgpcwogIHRoaXMuYXdhaXREcmFpbiA9IDA7CgogIC8vIGlmIHRydWUsIGEgbWF5YmVSZWFkTW9yZSBoYXMgYmVlbiBzY2hlZHVsZWQKICB0aGlzLnJlYWRpbmdNb3JlID0gZmFsc2U7CgogIHRoaXMuZGVjb2RlciA9IG51bGw7CiAgdGhpcy5lbmNvZGluZyA9IG51bGw7CiAgaWYgKG9wdGlvbnMuZW5jb2RpbmcpIHsKICAgIGlmICghU3RyaW5nRGVjb2RlcikKICAgICAgU3RyaW5nRGVjb2RlciA9IHJlcXVpcmUoJ3N0cmluZ19kZWNvZGVyLycpLlN0cmluZ0RlY29kZXI7CiAgICB0aGlzLmRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihvcHRpb25zLmVuY29kaW5nKTsKICAgIHRoaXMuZW5jb2RpbmcgPSBvcHRpb25zLmVuY29kaW5nOwogIH0KfQoKZnVuY3Rpb24gUmVhZGFibGUob3B0aW9ucykgewogIHZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBSZWFkYWJsZSkpCiAgICByZXR1cm4gbmV3IFJlYWRhYmxlKG9wdGlvbnMpOwoKICB0aGlzLl9yZWFkYWJsZVN0YXRlID0gbmV3IFJlYWRhYmxlU3RhdGUob3B0aW9ucywgdGhpcyk7CgogIC8vIGxlZ2FjeQogIHRoaXMucmVhZGFibGUgPSB0cnVlOwoKICBTdHJlYW0uY2FsbCh0aGlzKTsKfQoKLy8gTWFudWFsbHkgc2hvdmUgc29tZXRoaW5nIGludG8gdGhlIHJlYWQoKSBidWZmZXIuCi8vIFRoaXMgcmV0dXJucyB0cnVlIGlmIHRoZSBoaWdoV2F0ZXJNYXJrIGhhcyBub3QgYmVlbiBoaXQgeWV0LAovLyBzaW1pbGFyIHRvIGhvdyBXcml0YWJsZS53cml0ZSgpIHJldHVybnMgdHJ1ZSBpZiB5b3Ugc2hvdWxkCi8vIHdyaXRlKCkgc29tZSBtb3JlLgpSZWFkYWJsZS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIGlmICh1dGlsLmlzU3RyaW5nKGNodW5rKSAmJiAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBzdGF0ZS5kZWZhdWx0RW5jb2Rpbmc7CiAgICBpZiAoZW5jb2RpbmcgIT09IHN0YXRlLmVuY29kaW5nKSB7CiAgICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogICAgICBlbmNvZGluZyA9ICcnOwogICAgfQogIH0KCiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgZmFsc2UpOwp9OwoKLy8gVW5zaGlmdCBzaG91bGQgKmFsd2F5cyogYmUgc29tZXRoaW5nIGRpcmVjdGx5IG91dCBvZiByZWFkKCkKUmVhZGFibGUucHJvdG90eXBlLnVuc2hpZnQgPSBmdW5jdGlvbihjaHVuaykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCAnJywgdHJ1ZSk7Cn07CgpmdW5jdGlvbiByZWFkYWJsZUFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgYWRkVG9Gcm9udCkgewogIHZhciBlciA9IGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspOwogIGlmIChlcikgewogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIH0gZWxzZSBpZiAodXRpbC5pc051bGxPclVuZGVmaW5lZChjaHVuaykpIHsKICAgIHN0YXRlLnJlYWRpbmcgPSBmYWxzZTsKICAgIGlmICghc3RhdGUuZW5kZWQpCiAgICAgIG9uRW9mQ2h1bmsoc3RyZWFtLCBzdGF0ZSk7CiAgfSBlbHNlIGlmIChzdGF0ZS5vYmplY3RNb2RlIHx8IGNodW5rICYmIGNodW5rLmxlbmd0aCA+IDApIHsKICAgIGlmIChzdGF0ZS5lbmRlZCAmJiAhYWRkVG9Gcm9udCkgewogICAgICB2YXIgZSA9IG5ldyBFcnJvcignc3RyZWFtLnB1c2goKSBhZnRlciBFT0YnKTsKICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZSk7CiAgICB9IGVsc2UgaWYgKHN0YXRlLmVuZEVtaXR0ZWQgJiYgYWRkVG9Gcm9udCkgewogICAgICB2YXIgZSA9IG5ldyBFcnJvcignc3RyZWFtLnVuc2hpZnQoKSBhZnRlciBlbmQgZXZlbnQnKTsKICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoc3RhdGUuZGVjb2RlciAmJiAhYWRkVG9Gcm9udCAmJiAhZW5jb2RpbmcpCiAgICAgICAgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLndyaXRlKGNodW5rKTsKCiAgICAgIGlmICghYWRkVG9Gcm9udCkKICAgICAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CgogICAgICAvLyBpZiB3ZSB3YW50IHRoZSBkYXRhIG5vdywganVzdCBlbWl0IGl0LgogICAgICBpZiAoc3RhdGUuZmxvd2luZyAmJiBzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLnN5bmMpIHsKICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGNodW5rKTsKICAgICAgICBzdHJlYW0ucmVhZCgwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB1cGRhdGUgdGhlIGJ1ZmZlciBpbmZvLgogICAgICAgIHN0YXRlLmxlbmd0aCArPSBzdGF0ZS5vYmplY3RNb2RlID8gMSA6IGNodW5rLmxlbmd0aDsKICAgICAgICBpZiAoYWRkVG9Gcm9udCkKICAgICAgICAgIHN0YXRlLmJ1ZmZlci51bnNoaWZ0KGNodW5rKTsKICAgICAgICBlbHNlCiAgICAgICAgICBzdGF0ZS5idWZmZXIucHVzaChjaHVuayk7CgogICAgICAgIGlmIChzdGF0ZS5uZWVkUmVhZGFibGUpCiAgICAgICAgICBlbWl0UmVhZGFibGUoc3RyZWFtKTsKICAgICAgfQoKICAgICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICAgIH0KICB9IGVsc2UgaWYgKCFhZGRUb0Zyb250KSB7CiAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgfQoKICByZXR1cm4gbmVlZE1vcmVEYXRhKHN0YXRlKTsKfQoKCgovLyBpZiBpdCdzIHBhc3QgdGhlIGhpZ2ggd2F0ZXIgbWFyaywgd2UgY2FuIHB1c2ggaW4gc29tZSBtb3JlLgovLyBBbHNvLCBpZiB3ZSBoYXZlIG5vIGRhdGEgeWV0LCB3ZSBjYW4gc3RhbmQgc29tZQovLyBtb3JlIGJ5dGVzLiAgVGhpcyBpcyB0byB3b3JrIGFyb3VuZCBjYXNlcyB3aGVyZSBod209MCwKLy8gc3VjaCBhcyB0aGUgcmVwbC4gIEFsc28sIGlmIHRoZSBwdXNoKCkgdHJpZ2dlcmVkIGEKLy8gcmVhZGFibGUgZXZlbnQsIGFuZCB0aGUgdXNlciBjYWxsZWQgcmVhZChsYXJnZU51bWJlcikgc3VjaCB0aGF0Ci8vIG5lZWRSZWFkYWJsZSB3YXMgc2V0LCB0aGVuIHdlIG91Z2h0IHRvIHB1c2ggbW9yZSwgc28gdGhhdCBhbm90aGVyCi8vICdyZWFkYWJsZScgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQuCmZ1bmN0aW9uIG5lZWRNb3JlRGF0YShzdGF0ZSkgewogIHJldHVybiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgKHN0YXRlLm5lZWRSZWFkYWJsZSB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyayB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwKTsKfQoKLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuClJlYWRhYmxlLnByb3RvdHlwZS5zZXRFbmNvZGluZyA9IGZ1bmN0aW9uKGVuYykgewogIGlmICghU3RyaW5nRGVjb2RlcikKICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogIHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuYyk7CiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA9IGVuYzsKICByZXR1cm4gdGhpczsKfTsKCi8vIERvbid0IHJhaXNlIHRoZSBod20gPiAxMjhNQgp2YXIgTUFYX0hXTSA9IDB4ODAwMDAwOwpmdW5jdGlvbiByb3VuZFVwVG9OZXh0UG93ZXJPZjIobikgewogIGlmIChuID49IE1BWF9IV00pIHsKICAgIG4gPSBNQVhfSFdNOwogIH0gZWxzZSB7CiAgICAvLyBHZXQgdGhlIG5leHQgaGlnaGVzdCBwb3dlciBvZiAyCiAgICBuLS07CiAgICBmb3IgKHZhciBwID0gMTsgcCA8IDMyOyBwIDw8PSAxKSBuIHw9IG4gPj4gcDsKICAgIG4rKzsKICB9CiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uIGhvd011Y2hUb1JlYWQobiwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLmVuZGVkKQogICAgcmV0dXJuIDA7CgogIGlmIChzdGF0ZS5vYmplY3RNb2RlKQogICAgcmV0dXJuIG4gPT09IDAgPyAwIDogMTsKCiAgaWYgKGlzTmFOKG4pIHx8IHV0aWwuaXNOdWxsKG4pKSB7CiAgICAvLyBvbmx5IGZsb3cgb25lIGJ1ZmZlciBhdCBhIHRpbWUKICAgIGlmIChzdGF0ZS5mbG93aW5nICYmIHN0YXRlLmJ1ZmZlci5sZW5ndGgpCiAgICAgIHJldHVybiBzdGF0ZS5idWZmZXJbMF0ubGVuZ3RoOwogICAgZWxzZQogICAgICByZXR1cm4gc3RhdGUubGVuZ3RoOwogIH0KCiAgaWYgKG4gPD0gMCkKICAgIHJldHVybiAwOwoKICAvLyBJZiB3ZSdyZSBhc2tpbmcgZm9yIG1vcmUgdGhhbiB0aGUgdGFyZ2V0IGJ1ZmZlciBsZXZlbCwKICAvLyB0aGVuIHJhaXNlIHRoZSB3YXRlciBtYXJrLiAgQnVtcCB1cCB0byB0aGUgbmV4dCBoaWdoZXN0CiAgLy8gcG93ZXIgb2YgMiwgdG8gcHJldmVudCBpbmNyZWFzaW5nIGl0IGV4Y2Vzc2l2ZWx5IGluIHRpbnkKICAvLyBhbW91bnRzLgogIGlmIChuID4gc3RhdGUuaGlnaFdhdGVyTWFyaykKICAgIHN0YXRlLmhpZ2hXYXRlck1hcmsgPSByb3VuZFVwVG9OZXh0UG93ZXJPZjIobik7CgogIC8vIGRvbid0IGhhdmUgdGhhdCBtdWNoLiAgcmV0dXJuIG51bGwsIHVubGVzcyB3ZSd2ZSBlbmRlZC4KICBpZiAobiA+IHN0YXRlLmxlbmd0aCkgewogICAgaWYgKCFzdGF0ZS5lbmRlZCkgewogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgICByZXR1cm4gMDsKICAgIH0gZWxzZQogICAgICByZXR1cm4gc3RhdGUubGVuZ3RoOwogIH0KCiAgcmV0dXJuIG47Cn0KCi8vIHlvdSBjYW4gb3ZlcnJpZGUgZWl0aGVyIHRoaXMgbWV0aG9kLCBvciB0aGUgYXN5bmMgX3JlYWQobikgYmVsb3cuClJlYWRhYmxlLnByb3RvdHlwZS5yZWFkID0gZnVuY3Rpb24obikgewogIGRlYnVnKCdyZWFkJywgbik7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICB2YXIgbk9yaWcgPSBuOwoKICBpZiAoIXV0aWwuaXNOdW1iZXIobikgfHwgbiA+IDApCiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSBmYWxzZTsKCiAgLy8gaWYgd2UncmUgZG9pbmcgcmVhZCgwKSB0byB0cmlnZ2VyIGEgcmVhZGFibGUgZXZlbnQsIGJ1dCB3ZQogIC8vIGFscmVhZHkgaGF2ZSBhIGJ1bmNoIG9mIGRhdGEgaW4gdGhlIGJ1ZmZlciwgdGhlbiBqdXN0IHRyaWdnZXIKICAvLyB0aGUgJ3JlYWRhYmxlJyBldmVudCBhbmQgbW92ZSBvbi4KICBpZiAobiA9PT0gMCAmJgogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgJiYKICAgICAgKHN0YXRlLmxlbmd0aCA+PSBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmVuZGVkKSkgewogICAgZGVidWcoJ3JlYWQ6IGVtaXRSZWFkYWJsZScsIHN0YXRlLmxlbmd0aCwgc3RhdGUuZW5kZWQpOwogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCAmJiBzdGF0ZS5lbmRlZCkKICAgICAgZW5kUmVhZGFibGUodGhpcyk7CiAgICBlbHNlCiAgICAgIGVtaXRSZWFkYWJsZSh0aGlzKTsKICAgIHJldHVybiBudWxsOwogIH0KCiAgbiA9IGhvd011Y2hUb1JlYWQobiwgc3RhdGUpOwoKICAvLyBpZiB3ZSd2ZSBlbmRlZCwgYW5kIHdlJ3JlIG5vdyBjbGVhciwgdGhlbiBmaW5pc2ggaXQgdXAuCiAgaWYgKG4gPT09IDAgJiYgc3RhdGUuZW5kZWQpIHsKICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDApCiAgICAgIGVuZFJlYWRhYmxlKHRoaXMpOwogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvLyBBbGwgdGhlIGFjdHVhbCBjaHVuayBnZW5lcmF0aW9uIGxvZ2ljIG5lZWRzIHRvIGJlCiAgLy8gKmJlbG93KiB0aGUgY2FsbCB0byBfcmVhZC4gIFRoZSByZWFzb24gaXMgdGhhdCBpbiBjZXJ0YWluCiAgLy8gc3ludGhldGljIHN0cmVhbSBjYXNlcywgc3VjaCBhcyBwYXNzdGhyb3VnaCBzdHJlYW1zLCBfcmVhZAogIC8vIG1heSBiZSBhIGNvbXBsZXRlbHkgc3luY2hyb25vdXMgb3BlcmF0aW9uIHdoaWNoIG1heSBjaGFuZ2UKICAvLyB0aGUgc3RhdGUgb2YgdGhlIHJlYWQgYnVmZmVyLCBwcm92aWRpbmcgZW5vdWdoIGRhdGEgd2hlbgogIC8vIGJlZm9yZSB0aGVyZSB3YXMgKm5vdCogZW5vdWdoLgogIC8vCiAgLy8gU28sIHRoZSBzdGVwcyBhcmU6CiAgLy8gMS4gRmlndXJlIG91dCB3aGF0IHRoZSBzdGF0ZSBvZiB0aGluZ3Mgd2lsbCBiZSBhZnRlciB3ZSBkbwogIC8vIGEgcmVhZCBmcm9tIHRoZSBidWZmZXIuCiAgLy8KICAvLyAyLiBJZiB0aGF0IHJlc3VsdGluZyBzdGF0ZSB3aWxsIHRyaWdnZXIgYSBfcmVhZCwgdGhlbiBjYWxsIF9yZWFkLgogIC8vIE5vdGUgdGhhdCB0aGlzIG1heSBiZSBhc3luY2hyb25vdXMsIG9yIHN5bmNocm9ub3VzLiAgWWVzLCBpdCBpcwogIC8vIGRlZXBseSB1Z2x5IHRvIHdyaXRlIEFQSXMgdGhpcyB3YXksIGJ1dCB0aGF0IHN0aWxsIGRvZXNuJ3QgbWVhbgogIC8vIHRoYXQgdGhlIFJlYWRhYmxlIGNsYXNzIHNob3VsZCBiZWhhdmUgaW1wcm9wZXJseSwgYXMgc3RyZWFtcyBhcmUKICAvLyBkZXNpZ25lZCB0byBiZSBzeW5jL2FzeW5jIGFnbm9zdGljLgogIC8vIFRha2Ugbm90ZSBpZiB0aGUgX3JlYWQgY2FsbCBpcyBzeW5jIG9yIGFzeW5jIChpZSwgaWYgdGhlIHJlYWQgY2FsbAogIC8vIGhhcyByZXR1cm5lZCB5ZXQpLCBzbyB0aGF0IHdlIGtub3cgd2hldGhlciBvciBub3QgaXQncyBzYWZlIHRvIGVtaXQKICAvLyAncmVhZGFibGUnIGV0Yy4KICAvLwogIC8vIDMuIEFjdHVhbGx5IHB1bGwgdGhlIHJlcXVlc3RlZCBjaHVua3Mgb3V0IG9mIHRoZSBidWZmZXIgYW5kIHJldHVybi4KCiAgLy8gaWYgd2UgbmVlZCBhIHJlYWRhYmxlIGV2ZW50LCB0aGVuIHdlIG5lZWQgdG8gZG8gc29tZSByZWFkaW5nLgogIHZhciBkb1JlYWQgPSBzdGF0ZS5uZWVkUmVhZGFibGU7CiAgZGVidWcoJ25lZWQgcmVhZGFibGUnLCBkb1JlYWQpOwoKICAvLyBpZiB3ZSBjdXJyZW50bHkgaGF2ZSBsZXNzIHRoYW4gdGhlIGhpZ2hXYXRlck1hcmssIHRoZW4gYWxzbyByZWFkIHNvbWUKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwIHx8IHN0YXRlLmxlbmd0aCAtIG4gPCBzdGF0ZS5oaWdoV2F0ZXJNYXJrKSB7CiAgICBkb1JlYWQgPSB0cnVlOwogICAgZGVidWcoJ2xlbmd0aCBsZXNzIHRoYW4gd2F0ZXJtYXJrJywgZG9SZWFkKTsKICB9CgogIC8vIGhvd2V2ZXIsIGlmIHdlJ3ZlIGVuZGVkLCB0aGVuIHRoZXJlJ3Mgbm8gcG9pbnQsIGFuZCBpZiB3ZSdyZSBhbHJlYWR5CiAgLy8gcmVhZGluZywgdGhlbiBpdCdzIHVubmVjZXNzYXJ5LgogIGlmIChzdGF0ZS5lbmRlZCB8fCBzdGF0ZS5yZWFkaW5nKSB7CiAgICBkb1JlYWQgPSBmYWxzZTsKICAgIGRlYnVnKCdyZWFkaW5nIG9yIGVuZGVkJywgZG9SZWFkKTsKICB9CgogIGlmIChkb1JlYWQpIHsKICAgIGRlYnVnKCdkbyByZWFkJyk7CiAgICBzdGF0ZS5yZWFkaW5nID0gdHJ1ZTsKICAgIHN0YXRlLnN5bmMgPSB0cnVlOwogICAgLy8gaWYgdGhlIGxlbmd0aCBpcyBjdXJyZW50bHkgemVybywgdGhlbiB3ZSAqbmVlZCogYSByZWFkYWJsZSBldmVudC4KICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDApCiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAvLyBjYWxsIGludGVybmFsIHJlYWQgbWV0aG9kCiAgICB0aGlzLl9yZWFkKHN0YXRlLmhpZ2hXYXRlck1hcmspOwogICAgc3RhdGUuc3luYyA9IGZhbHNlOwogIH0KCiAgLy8gSWYgX3JlYWQgcHVzaGVkIGRhdGEgc3luY2hyb25vdXNseSwgdGhlbiBgcmVhZGluZ2Agd2lsbCBiZSBmYWxzZSwKICAvLyBhbmQgd2UgbmVlZCB0byByZS1ldmFsdWF0ZSBob3cgbXVjaCBkYXRhIHdlIGNhbiByZXR1cm4gdG8gdGhlIHVzZXIuCiAgaWYgKGRvUmVhZCAmJiAhc3RhdGUucmVhZGluZykKICAgIG4gPSBob3dNdWNoVG9SZWFkKG5PcmlnLCBzdGF0ZSk7CgogIHZhciByZXQ7CiAgaWYgKG4gPiAwKQogICAgcmV0ID0gZnJvbUxpc3Qobiwgc3RhdGUpOwogIGVsc2UKICAgIHJldCA9IG51bGw7CgogIGlmICh1dGlsLmlzTnVsbChyZXQpKSB7CiAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgbiA9IDA7CiAgfQoKICBzdGF0ZS5sZW5ndGggLT0gbjsKCiAgLy8gSWYgd2UgaGF2ZSBub3RoaW5nIGluIHRoZSBidWZmZXIsIHRoZW4gd2Ugd2FudCB0byBrbm93CiAgLy8gYXMgc29vbiBhcyB3ZSAqZG8qIGdldCBzb21ldGhpbmcgaW50byB0aGUgYnVmZmVyLgogIGlmIChzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLmVuZGVkKQogICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gSWYgd2UgdHJpZWQgdG8gcmVhZCgpIHBhc3QgdGhlIEVPRiwgdGhlbiBlbWl0IGVuZCBvbiB0aGUgbmV4dCB0aWNrLgogIGlmIChuT3JpZyAhPT0gbiAmJiBzdGF0ZS5lbmRlZCAmJiBzdGF0ZS5sZW5ndGggPT09IDApCiAgICBlbmRSZWFkYWJsZSh0aGlzKTsKCiAgaWYgKCF1dGlsLmlzTnVsbChyZXQpKQogICAgdGhpcy5lbWl0KCdkYXRhJywgcmV0KTsKCiAgcmV0dXJuIHJldDsKfTsKCmZ1bmN0aW9uIGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspIHsKICB2YXIgZXIgPSBudWxsOwogIGlmICghdXRpbC5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgIXV0aWwuaXNTdHJpbmcoY2h1bmspICYmCiAgICAgICF1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNodW5rKSAmJgogICAgICAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZXIgPSBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG5vbi1zdHJpbmcvYnVmZmVyIGNodW5rJyk7CiAgfQogIHJldHVybiBlcjsKfQoKCmZ1bmN0aW9uIG9uRW9mQ2h1bmsoc3RyZWFtLCBzdGF0ZSkgewogIGlmIChzdGF0ZS5kZWNvZGVyICYmICFzdGF0ZS5lbmRlZCkgewogICAgdmFyIGNodW5rID0gc3RhdGUuZGVjb2Rlci5lbmQoKTsKICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICBzdGF0ZS5sZW5ndGggKz0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CiAgICB9CiAgfQogIHN0YXRlLmVuZGVkID0gdHJ1ZTsKCiAgLy8gZW1pdCAncmVhZGFibGUnIG5vdyB0byBtYWtlIHN1cmUgaXQgZ2V0cyBwaWNrZWQgdXAuCiAgZW1pdFJlYWRhYmxlKHN0cmVhbSk7Cn0KCi8vIERvbid0IGVtaXQgcmVhZGFibGUgcmlnaHQgYXdheSBpbiBzeW5jIG1vZGUsIGJlY2F1c2UgdGhpcyBjYW4gdHJpZ2dlcgovLyBhbm90aGVyIHJlYWQoKSBjYWxsID0+IHN0YWNrIG92ZXJmbG93LiAgVGhpcyB3YXksIGl0IG1pZ2h0IHRyaWdnZXIKLy8gYSBuZXh0VGljayByZWN1cnNpb24gd2FybmluZywgYnV0IHRoYXQncyBub3Qgc28gYmFkLgpmdW5jdGlvbiBlbWl0UmVhZGFibGUoc3RyZWFtKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogIHN0YXRlLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIGlmICghc3RhdGUuZW1pdHRlZFJlYWRhYmxlKSB7CiAgICBkZWJ1ZygnZW1pdFJlYWRhYmxlJywgc3RhdGUuZmxvd2luZyk7CiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSB0cnVlOwogICAgaWYgKHN0YXRlLnN5bmMpCiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgZW1pdFJlYWRhYmxlXyhzdHJlYW0pOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgZW1pdFJlYWRhYmxlXyhzdHJlYW0pOwogIH0KfQoKZnVuY3Rpb24gZW1pdFJlYWRhYmxlXyhzdHJlYW0pIHsKICBkZWJ1ZygnZW1pdCByZWFkYWJsZScpOwogIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwogIGZsb3coc3RyZWFtKTsKfQoKCi8vIGF0IHRoaXMgcG9pbnQsIHRoZSB1c2VyIGhhcyBwcmVzdW1hYmx5IHNlZW4gdGhlICdyZWFkYWJsZScgZXZlbnQsCi8vIGFuZCBjYWxsZWQgcmVhZCgpIHRvIGNvbnN1bWUgc29tZSBkYXRhLiAgdGhhdCBtYXkgaGF2ZSB0cmlnZ2VyZWQKLy8gaW4gdHVybiBhbm90aGVyIF9yZWFkKG4pIGNhbGwsIGluIHdoaWNoIGNhc2UgcmVhZGluZyA9IHRydWUgaWYKLy8gaXQncyBpbiBwcm9ncmVzcy4KLy8gSG93ZXZlciwgaWYgd2UncmUgbm90IGVuZGVkLCBvciByZWFkaW5nLCBhbmQgdGhlIGxlbmd0aCA8IGh3bSwKLy8gdGhlbiBnbyBhaGVhZCBhbmQgdHJ5IHRvIHJlYWQgc29tZSBtb3JlIHByZWVtcHRpdmVseS4KZnVuY3Rpb24gbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5yZWFkaW5nTW9yZSkgewogICAgc3RhdGUucmVhZGluZ01vcmUgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgbWF5YmVSZWFkTW9yZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG1heWJlUmVhZE1vcmVfKHN0cmVhbSwgc3RhdGUpIHsKICB2YXIgbGVuID0gc3RhdGUubGVuZ3RoOwogIHdoaWxlICghc3RhdGUucmVhZGluZyAmJiAhc3RhdGUuZmxvd2luZyAmJiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyaykgewogICAgZGVidWcoJ21heWJlUmVhZE1vcmUgcmVhZCAwJyk7CiAgICBzdHJlYW0ucmVhZCgwKTsKICAgIGlmIChsZW4gPT09IHN0YXRlLmxlbmd0aCkKICAgICAgLy8gZGlkbid0IGdldCBhbnkgZGF0YSwgc3RvcCBzcGlubmluZy4KICAgICAgYnJlYWs7CiAgICBlbHNlCiAgICAgIGxlbiA9IHN0YXRlLmxlbmd0aDsKICB9CiAgc3RhdGUucmVhZGluZ01vcmUgPSBmYWxzZTsKfQoKLy8gYWJzdHJhY3QgbWV0aG9kLiAgdG8gYmUgb3ZlcnJpZGRlbiBpbiBzcGVjaWZpYyBpbXBsZW1lbnRhdGlvbiBjbGFzc2VzLgovLyBjYWxsIGNiKGVyLCBkYXRhKSB3aGVyZSBkYXRhIGlzIDw9IG4gaW4gbGVuZ3RoLgovLyBmb3IgdmlydHVhbCAobm9uLXN0cmluZywgbm9uLWJ1ZmZlcikgc3RyZWFtcywgImxlbmd0aCIgaXMgc29tZXdoYXQKLy8gYXJiaXRyYXJ5LCBhbmQgcGVyaGFwcyBub3QgdmVyeSBtZWFuaW5nZnVsLgpSZWFkYWJsZS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignbm90IGltcGxlbWVudGVkJykpOwp9OwoKUmVhZGFibGUucHJvdG90eXBlLnBpcGUgPSBmdW5jdGlvbihkZXN0LCBwaXBlT3B0cykgewogIHZhciBzcmMgPSB0aGlzOwogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIHN3aXRjaCAoc3RhdGUucGlwZXNDb3VudCkgewogICAgY2FzZSAwOgogICAgICBzdGF0ZS5waXBlcyA9IGRlc3Q7CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICBzdGF0ZS5waXBlcyA9IFtzdGF0ZS5waXBlcywgZGVzdF07CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgc3RhdGUucGlwZXMucHVzaChkZXN0KTsKICAgICAgYnJlYWs7CiAgfQogIHN0YXRlLnBpcGVzQ291bnQgKz0gMTsKICBkZWJ1ZygncGlwZSBjb3VudD0lZCBvcHRzPSVqJywgc3RhdGUucGlwZXNDb3VudCwgcGlwZU9wdHMpOwoKICB2YXIgZG9FbmQgPSAoIXBpcGVPcHRzIHx8IHBpcGVPcHRzLmVuZCAhPT0gZmFsc2UpICYmCiAgICAgICAgICAgICAgZGVzdCAhPT0gcHJvY2Vzcy5zdGRvdXQgJiYKICAgICAgICAgICAgICBkZXN0ICE9PSBwcm9jZXNzLnN0ZGVycjsKCiAgdmFyIGVuZEZuID0gZG9FbmQgPyBvbmVuZCA6IGNsZWFudXA7CiAgaWYgKHN0YXRlLmVuZEVtaXR0ZWQpCiAgICBwcm9jZXNzLm5leHRUaWNrKGVuZEZuKTsKICBlbHNlCiAgICBzcmMub25jZSgnZW5kJywgZW5kRm4pOwoKICBkZXN0Lm9uKCd1bnBpcGUnLCBvbnVucGlwZSk7CiAgZnVuY3Rpb24gb251bnBpcGUocmVhZGFibGUpIHsKICAgIGRlYnVnKCdvbnVucGlwZScpOwogICAgaWYgKHJlYWRhYmxlID09PSBzcmMpIHsKICAgICAgY2xlYW51cCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25lbmQoKSB7CiAgICBkZWJ1Zygnb25lbmQnKTsKICAgIGRlc3QuZW5kKCk7CiAgfQoKICAvLyB3aGVuIHRoZSBkZXN0IGRyYWlucywgaXQgcmVkdWNlcyB0aGUgYXdhaXREcmFpbiBjb3VudGVyCiAgLy8gb24gdGhlIHNvdXJjZS4gIFRoaXMgd291bGQgYmUgbW9yZSBlbGVnYW50IHdpdGggYSAub25jZSgpCiAgLy8gaGFuZGxlciBpbiBmbG93KCksIGJ1dCBhZGRpbmcgYW5kIHJlbW92aW5nIHJlcGVhdGVkbHkgaXMKICAvLyB0b28gc2xvdy4KICB2YXIgb25kcmFpbiA9IHBpcGVPbkRyYWluKHNyYyk7CiAgZGVzdC5vbignZHJhaW4nLCBvbmRyYWluKTsKCiAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgIGRlYnVnKCdjbGVhbnVwJyk7CiAgICAvLyBjbGVhbnVwIGV2ZW50IGhhbmRsZXJzIG9uY2UgdGhlIHBpcGUgaXMgYnJva2VuCiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZmluaXNoJywgb25maW5pc2gpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZHJhaW4nLCBvbmRyYWluKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCd1bnBpcGUnLCBvbnVucGlwZSk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgIHNyYy5yZW1vdmVMaXN0ZW5lcignZW5kJywgY2xlYW51cCk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwoKICAgIC8vIGlmIHRoZSByZWFkZXIgaXMgd2FpdGluZyBmb3IgYSBkcmFpbiBldmVudCBmcm9tIHRoaXMKICAgIC8vIHNwZWNpZmljIHdyaXRlciwgdGhlbiBpdCB3b3VsZCBjYXVzZSBpdCB0byBuZXZlciBzdGFydAogICAgLy8gZmxvd2luZyBhZ2Fpbi4KICAgIC8vIFNvLCBpZiB0aGlzIGlzIGF3YWl0aW5nIGEgZHJhaW4sIHRoZW4gd2UganVzdCBjYWxsIGl0IG5vdy4KICAgIC8vIElmIHdlIGRvbid0IGtub3csIHRoZW4gYXNzdW1lIHRoYXQgd2UgYXJlIHdhaXRpbmcgZm9yIG9uZS4KICAgIGlmIChzdGF0ZS5hd2FpdERyYWluICYmCiAgICAgICAgKCFkZXN0Ll93cml0YWJsZVN0YXRlIHx8IGRlc3QuX3dyaXRhYmxlU3RhdGUubmVlZERyYWluKSkKICAgICAgb25kcmFpbigpOwogIH0KCiAgc3JjLm9uKCdkYXRhJywgb25kYXRhKTsKICBmdW5jdGlvbiBvbmRhdGEoY2h1bmspIHsKICAgIGRlYnVnKCdvbmRhdGEnKTsKICAgIHZhciByZXQgPSBkZXN0LndyaXRlKGNodW5rKTsKICAgIGlmIChmYWxzZSA9PT0gcmV0KSB7CiAgICAgIGRlYnVnKCdmYWxzZSB3cml0ZSByZXNwb25zZSwgcGF1c2UnLAogICAgICAgICAgICBzcmMuX3JlYWRhYmxlU3RhdGUuYXdhaXREcmFpbik7CiAgICAgIHNyYy5fcmVhZGFibGVTdGF0ZS5hd2FpdERyYWluKys7CiAgICAgIHNyYy5wYXVzZSgpOwogICAgfQogIH0KCiAgLy8gaWYgdGhlIGRlc3QgaGFzIGFuIGVycm9yLCB0aGVuIHN0b3AgcGlwaW5nIGludG8gaXQuCiAgLy8gaG93ZXZlciwgZG9uJ3Qgc3VwcHJlc3MgdGhlIHRocm93aW5nIGJlaGF2aW9yIGZvciB0aGlzLgogIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgIGRlYnVnKCdvbmVycm9yJywgZXIpOwogICAgdW5waXBlKCk7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQoZGVzdCwgJ2Vycm9yJykgPT09IDApCiAgICAgIGRlc3QuZW1pdCgnZXJyb3InLCBlcik7CiAgfQogIC8vIFRoaXMgaXMgYSBicnV0YWxseSB1Z2x5IGhhY2sgdG8gbWFrZSBzdXJlIHRoYXQgb3VyIGVycm9yIGhhbmRsZXIKICAvLyBpcyBhdHRhY2hlZCBiZWZvcmUgYW55IHVzZXJsYW5kIG9uZXMuICBORVZFUiBETyBUSElTLgogIGlmICghZGVzdC5fZXZlbnRzIHx8ICFkZXN0Ll9ldmVudHMuZXJyb3IpCiAgICBkZXN0Lm9uKCdlcnJvcicsIG9uZXJyb3IpOwogIGVsc2UgaWYgKGlzQXJyYXkoZGVzdC5fZXZlbnRzLmVycm9yKSkKICAgIGRlc3QuX2V2ZW50cy5lcnJvci51bnNoaWZ0KG9uZXJyb3IpOwogIGVsc2UKICAgIGRlc3QuX2V2ZW50cy5lcnJvciA9IFtvbmVycm9yLCBkZXN0Ll9ldmVudHMuZXJyb3JdOwoKCgogIC8vIEJvdGggY2xvc2UgYW5kIGZpbmlzaCBzaG91bGQgdHJpZ2dlciB1bnBpcGUsIGJ1dCBvbmx5IG9uY2UuCiAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKICAgIHVucGlwZSgpOwogIH0KICBkZXN0Lm9uY2UoJ2Nsb3NlJywgb25jbG9zZSk7CiAgZnVuY3Rpb24gb25maW5pc2goKSB7CiAgICBkZWJ1Zygnb25maW5pc2gnKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSk7CiAgICB1bnBpcGUoKTsKICB9CiAgZGVzdC5vbmNlKCdmaW5pc2gnLCBvbmZpbmlzaCk7CgogIGZ1bmN0aW9uIHVucGlwZSgpIHsKICAgIGRlYnVnKCd1bnBpcGUnKTsKICAgIHNyYy51bnBpcGUoZGVzdCk7CiAgfQoKICAvLyB0ZWxsIHRoZSBkZXN0IHRoYXQgaXQncyBiZWluZyBwaXBlZCB0bwogIGRlc3QuZW1pdCgncGlwZScsIHNyYyk7CgogIC8vIHN0YXJ0IHRoZSBmbG93IGlmIGl0IGhhc24ndCBiZWVuIHN0YXJ0ZWQgYWxyZWFkeS4KICBpZiAoIXN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdwaXBlIHJlc3VtZScpOwogICAgc3JjLnJlc3VtZSgpOwogIH0KCiAgcmV0dXJuIGRlc3Q7Cn07CgpmdW5jdGlvbiBwaXBlT25EcmFpbihzcmMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgc3RhdGUgPSBzcmMuX3JlYWRhYmxlU3RhdGU7CiAgICBkZWJ1ZygncGlwZU9uRHJhaW4nLCBzdGF0ZS5hd2FpdERyYWluKTsKICAgIGlmIChzdGF0ZS5hd2FpdERyYWluKQogICAgICBzdGF0ZS5hd2FpdERyYWluLS07CiAgICBpZiAoc3RhdGUuYXdhaXREcmFpbiA9PT0gMCAmJiBFRS5saXN0ZW5lckNvdW50KHNyYywgJ2RhdGEnKSkgewogICAgICBzdGF0ZS5mbG93aW5nID0gdHJ1ZTsKICAgICAgZmxvdyhzcmMpOwogICAgfQogIH07Cn0KCgpSZWFkYWJsZS5wcm90b3R5cGUudW5waXBlID0gZnVuY3Rpb24oZGVzdCkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIC8vIGlmIHdlJ3JlIG5vdCBwaXBpbmcgYW55d2hlcmUsIHRoZW4gZG8gbm90aGluZy4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMCkKICAgIHJldHVybiB0aGlzOwoKICAvLyBqdXN0IG9uZSBkZXN0aW5hdGlvbi4gIG1vc3QgY29tbW9uIGNhc2UuCiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpIHsKICAgIC8vIHBhc3NlZCBpbiBvbmUsIGJ1dCBpdCdzIG5vdCB0aGUgcmlnaHQgb25lLgogICAgaWYgKGRlc3QgJiYgZGVzdCAhPT0gc3RhdGUucGlwZXMpCiAgICAgIHJldHVybiB0aGlzOwoKICAgIGlmICghZGVzdCkKICAgICAgZGVzdCA9IHN0YXRlLnBpcGVzOwoKICAgIC8vIGdvdCBhIG1hdGNoLgogICAgc3RhdGUucGlwZXMgPSBudWxsOwogICAgc3RhdGUucGlwZXNDb3VudCA9IDA7CiAgICBzdGF0ZS5mbG93aW5nID0gZmFsc2U7CiAgICBpZiAoZGVzdCkKICAgICAgZGVzdC5lbWl0KCd1bnBpcGUnLCB0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLy8gc2xvdyBjYXNlLiBtdWx0aXBsZSBwaXBlIGRlc3RpbmF0aW9ucy4KCiAgaWYgKCFkZXN0KSB7CiAgICAvLyByZW1vdmUgYWxsLgogICAgdmFyIGRlc3RzID0gc3RhdGUucGlwZXM7CiAgICB2YXIgbGVuID0gc3RhdGUucGlwZXNDb3VudDsKICAgIHN0YXRlLnBpcGVzID0gbnVsbDsKICAgIHN0YXRlLnBpcGVzQ291bnQgPSAwOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGRlc3RzW2ldLmVtaXQoJ3VucGlwZScsIHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyB0cnkgdG8gZmluZCB0aGUgcmlnaHQgb25lLgogIHZhciBpID0gaW5kZXhPZihzdGF0ZS5waXBlcywgZGVzdCk7CiAgaWYgKGkgPT09IC0xKQogICAgcmV0dXJuIHRoaXM7CgogIHN0YXRlLnBpcGVzLnNwbGljZShpLCAxKTsKICBzdGF0ZS5waXBlc0NvdW50IC09IDE7CiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICBzdGF0ZS5waXBlcyA9IHN0YXRlLnBpcGVzWzBdOwoKICBkZXN0LmVtaXQoJ3VucGlwZScsIHRoaXMpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIHNldCB1cCBkYXRhIGV2ZW50cyBpZiB0aGV5IGFyZSBhc2tlZCBmb3IKLy8gRW5zdXJlIHJlYWRhYmxlIGxpc3RlbmVycyBldmVudHVhbGx5IGdldCBzb21ldGhpbmcKUmVhZGFibGUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXYsIGZuKSB7CiAgdmFyIHJlcyA9IFN0cmVhbS5wcm90b3R5cGUub24uY2FsbCh0aGlzLCBldiwgZm4pOwoKICAvLyBJZiBsaXN0ZW5pbmcgdG8gZGF0YSwgYW5kIGl0IGhhcyBub3QgZXhwbGljaXRseSBiZWVuIHBhdXNlZCwKICAvLyB0aGVuIGNhbGwgcmVzdW1lIHRvIHN0YXJ0IHRoZSBmbG93IG9mIGRhdGEgb24gdGhlIG5leHQgdGljay4KICBpZiAoZXYgPT09ICdkYXRhJyAmJiBmYWxzZSAhPT0gdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nKSB7CiAgICB0aGlzLnJlc3VtZSgpOwogIH0KCiAgaWYgKGV2ID09PSAncmVhZGFibGUnICYmIHRoaXMucmVhZGFibGUpIHsKICAgIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgICBpZiAoIXN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nKSB7CiAgICAgIHN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nID0gdHJ1ZTsKICAgICAgc3RhdGUuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIGlmICghc3RhdGUucmVhZGluZykgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVidWcoJ3JlYWRhYmxlIG5leHR0aWNrIHJlYWQgMCcpOwogICAgICAgICAgc2VsZi5yZWFkKDApOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHN0YXRlLmxlbmd0aCkgewogICAgICAgIGVtaXRSZWFkYWJsZSh0aGlzLCBzdGF0ZSk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXM7Cn07ClJlYWRhYmxlLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IFJlYWRhYmxlLnByb3RvdHlwZS5vbjsKCi8vIHBhdXNlKCkgYW5kIHJlc3VtZSgpIGFyZSByZW1uYW50cyBvZiB0aGUgbGVnYWN5IHJlYWRhYmxlIHN0cmVhbSBBUEkKLy8gSWYgdGhlIHVzZXIgdXNlcyB0aGVtLCB0aGVuIHN3aXRjaCBpbnRvIG9sZCBtb2RlLgpSZWFkYWJsZS5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICBpZiAoIXN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdyZXN1bWUnKTsKICAgIHN0YXRlLmZsb3dpbmcgPSB0cnVlOwogICAgaWYgKCFzdGF0ZS5yZWFkaW5nKSB7CiAgICAgIGRlYnVnKCdyZXN1bWUgcmVhZCAwJyk7CiAgICAgIHRoaXMucmVhZCgwKTsKICAgIH0KICAgIHJlc3VtZSh0aGlzLCBzdGF0ZSk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gcmVzdW1lKHN0cmVhbSwgc3RhdGUpIHsKICBpZiAoIXN0YXRlLnJlc3VtZVNjaGVkdWxlZCkgewogICAgc3RhdGUucmVzdW1lU2NoZWR1bGVkID0gdHJ1ZTsKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIHJlc3VtZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHJlc3VtZV8oc3RyZWFtLCBzdGF0ZSkgewogIHN0YXRlLnJlc3VtZVNjaGVkdWxlZCA9IGZhbHNlOwogIHN0cmVhbS5lbWl0KCdyZXN1bWUnKTsKICBmbG93KHN0cmVhbSk7CiAgaWYgKHN0YXRlLmZsb3dpbmcgJiYgIXN0YXRlLnJlYWRpbmcpCiAgICBzdHJlYW0ucmVhZCgwKTsKfQoKUmVhZGFibGUucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgZGVidWcoJ2NhbGwgcGF1c2UgZmxvd2luZz0laicsIHRoaXMuX3JlYWRhYmxlU3RhdGUuZmxvd2luZyk7CiAgaWYgKGZhbHNlICE9PSB0aGlzLl9yZWFkYWJsZVN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdwYXVzZScpOwogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nID0gZmFsc2U7CiAgICB0aGlzLmVtaXQoJ3BhdXNlJyk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gZmxvdyhzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgZGVidWcoJ2Zsb3cnLCBzdGF0ZS5mbG93aW5nKTsKICBpZiAoc3RhdGUuZmxvd2luZykgewogICAgZG8gewogICAgICB2YXIgY2h1bmsgPSBzdHJlYW0ucmVhZCgpOwogICAgfSB3aGlsZSAobnVsbCAhPT0gY2h1bmsgJiYgc3RhdGUuZmxvd2luZyk7CiAgfQp9CgovLyB3cmFwIGFuIG9sZC1zdHlsZSBzdHJlYW0gYXMgdGhlIGFzeW5jIGRhdGEgc291cmNlLgovLyBUaGlzIGlzICpub3QqIHBhcnQgb2YgdGhlIHJlYWRhYmxlIHN0cmVhbSBpbnRlcmZhY2UuCi8vIEl0IGlzIGFuIHVnbHkgdW5mb3J0dW5hdGUgbWVzcyBvZiBoaXN0b3J5LgpSZWFkYWJsZS5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIHBhdXNlZCA9IGZhbHNlOwoKICB2YXIgc2VsZiA9IHRoaXM7CiAgc3RyZWFtLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgIGRlYnVnKCd3cmFwcGVkIGVuZCcpOwogICAgaWYgKHN0YXRlLmRlY29kZXIgJiYgIXN0YXRlLmVuZGVkKSB7CiAgICAgIHZhciBjaHVuayA9IHN0YXRlLmRlY29kZXIuZW5kKCk7CiAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpCiAgICAgICAgc2VsZi5wdXNoKGNodW5rKTsKICAgIH0KCiAgICBzZWxmLnB1c2gobnVsbCk7CiAgfSk7CgogIHN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7CiAgICBkZWJ1Zygnd3JhcHBlZCBkYXRhJyk7CiAgICBpZiAoc3RhdGUuZGVjb2RlcikKICAgICAgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLndyaXRlKGNodW5rKTsKICAgIGlmICghY2h1bmsgfHwgIXN0YXRlLm9iamVjdE1vZGUgJiYgIWNodW5rLmxlbmd0aCkKICAgICAgcmV0dXJuOwoKICAgIHZhciByZXQgPSBzZWxmLnB1c2goY2h1bmspOwogICAgaWYgKCFyZXQpIHsKICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgc3RyZWFtLnBhdXNlKCk7CiAgICB9CiAgfSk7CgogIC8vIHByb3h5IGFsbCB0aGUgb3RoZXIgbWV0aG9kcy4KICAvLyBpbXBvcnRhbnQgd2hlbiB3cmFwcGluZyBmaWx0ZXJzIGFuZCBkdXBsZXhlcy4KICBmb3IgKHZhciBpIGluIHN0cmVhbSkgewogICAgaWYgKHV0aWwuaXNGdW5jdGlvbihzdHJlYW1baV0pICYmIHV0aWwuaXNVbmRlZmluZWQodGhpc1tpXSkpIHsKICAgICAgdGhpc1tpXSA9IGZ1bmN0aW9uKG1ldGhvZCkgeyByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN0cmVhbVttZXRob2RdLmFwcGx5KHN0cmVhbSwgYXJndW1lbnRzKTsKICAgICAgfX0oaSk7CiAgICB9CiAgfQoKICAvLyBwcm94eSBjZXJ0YWluIGltcG9ydGFudCBldmVudHMuCiAgdmFyIGV2ZW50cyA9IFsnZXJyb3InLCAnY2xvc2UnLCAnZGVzdHJveScsICdwYXVzZScsICdyZXN1bWUnXTsKICBmb3JFYWNoKGV2ZW50cywgZnVuY3Rpb24oZXYpIHsKICAgIHN0cmVhbS5vbihldiwgc2VsZi5lbWl0LmJpbmQoc2VsZiwgZXYpKTsKICB9KTsKCiAgLy8gd2hlbiB3ZSB0cnkgdG8gY29uc3VtZSBzb21lIG1vcmUgYnl0ZXMsIHNpbXBseSB1bnBhdXNlIHRoZQogIC8vIHVuZGVybHlpbmcgc3RyZWFtLgogIHNlbGYuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgICBkZWJ1Zygnd3JhcHBlZCBfcmVhZCcsIG4pOwogICAgaWYgKHBhdXNlZCkgewogICAgICBwYXVzZWQgPSBmYWxzZTsKICAgICAgc3RyZWFtLnJlc3VtZSgpOwogICAgfQogIH07CgogIHJldHVybiBzZWxmOwp9OwoKCgovLyBleHBvc2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzIG9ubHkuClJlYWRhYmxlLl9mcm9tTGlzdCA9IGZyb21MaXN0OwoKLy8gUGx1Y2sgb2ZmIG4gYnl0ZXMgZnJvbSBhbiBhcnJheSBvZiBidWZmZXJzLgovLyBMZW5ndGggaXMgdGhlIGNvbWJpbmVkIGxlbmd0aHMgb2YgYWxsIHRoZSBidWZmZXJzIGluIHRoZSBsaXN0LgpmdW5jdGlvbiBmcm9tTGlzdChuLCBzdGF0ZSkgewogIHZhciBsaXN0ID0gc3RhdGUuYnVmZmVyOwogIHZhciBsZW5ndGggPSBzdGF0ZS5sZW5ndGg7CiAgdmFyIHN0cmluZ01vZGUgPSAhIXN0YXRlLmRlY29kZXI7CiAgdmFyIG9iamVjdE1vZGUgPSAhIXN0YXRlLm9iamVjdE1vZGU7CiAgdmFyIHJldDsKCiAgLy8gbm90aGluZyBpbiB0aGUgbGlzdCwgZGVmaW5pdGVseSBlbXB0eS4KICBpZiAobGlzdC5sZW5ndGggPT09IDApCiAgICByZXR1cm4gbnVsbDsKCiAgaWYgKGxlbmd0aCA9PT0gMCkKICAgIHJldCA9IG51bGw7CiAgZWxzZSBpZiAob2JqZWN0TW9kZSkKICAgIHJldCA9IGxpc3Quc2hpZnQoKTsKICBlbHNlIGlmICghbiB8fCBuID49IGxlbmd0aCkgewogICAgLy8gcmVhZCBpdCBhbGwsIHRydW5jYXRlIHRoZSBhcnJheS4KICAgIGlmIChzdHJpbmdNb2RlKQogICAgICByZXQgPSBsaXN0LmpvaW4oJycpOwogICAgZWxzZQogICAgICByZXQgPSBCdWZmZXIuY29uY2F0KGxpc3QsIGxlbmd0aCk7CiAgICBsaXN0Lmxlbmd0aCA9IDA7CiAgfSBlbHNlIHsKICAgIC8vIHJlYWQganVzdCBzb21lIG9mIGl0LgogICAgaWYgKG4gPCBsaXN0WzBdLmxlbmd0aCkgewogICAgICAvLyBqdXN0IHRha2UgYSBwYXJ0IG9mIHRoZSBmaXJzdCBsaXN0IGl0ZW0uCiAgICAgIC8vIHNsaWNlIGlzIHRoZSBzYW1lIGZvciBidWZmZXJzIGFuZCBzdHJpbmdzLgogICAgICB2YXIgYnVmID0gbGlzdFswXTsKICAgICAgcmV0ID0gYnVmLnNsaWNlKDAsIG4pOwogICAgICBsaXN0WzBdID0gYnVmLnNsaWNlKG4pOwogICAgfSBlbHNlIGlmIChuID09PSBsaXN0WzBdLmxlbmd0aCkgewogICAgICAvLyBmaXJzdCBsaXN0IGlzIGEgcGVyZmVjdCBtYXRjaAogICAgICByZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICB9IGVsc2UgewogICAgICAvLyBjb21wbGV4IGNhc2UuCiAgICAgIC8vIHdlIGhhdmUgZW5vdWdoIHRvIGNvdmVyIGl0LCBidXQgaXQgc3BhbnMgcGFzdCB0aGUgZmlyc3QgYnVmZmVyLgogICAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgICByZXQgPSAnJzsKICAgICAgZWxzZQogICAgICAgIHJldCA9IG5ldyBCdWZmZXIobik7CgogICAgICB2YXIgYyA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsICYmIGMgPCBuOyBpKyspIHsKICAgICAgICB2YXIgYnVmID0gbGlzdFswXTsKICAgICAgICB2YXIgY3B5ID0gTWF0aC5taW4obiAtIGMsIGJ1Zi5sZW5ndGgpOwoKICAgICAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgICAgIHJldCArPSBidWYuc2xpY2UoMCwgY3B5KTsKICAgICAgICBlbHNlCiAgICAgICAgICBidWYuY29weShyZXQsIGMsIDAsIGNweSk7CgogICAgICAgIGlmIChjcHkgPCBidWYubGVuZ3RoKQogICAgICAgICAgbGlzdFswXSA9IGJ1Zi5zbGljZShjcHkpOwogICAgICAgIGVsc2UKICAgICAgICAgIGxpc3Quc2hpZnQoKTsKCiAgICAgICAgYyArPSBjcHk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGVuZFJlYWRhYmxlKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKCiAgLy8gSWYgd2UgZ2V0IGhlcmUgYmVmb3JlIGNvbnN1bWluZyBhbGwgdGhlIGJ5dGVzLCB0aGVuIHRoYXQgaXMgYQogIC8vIGJ1ZyBpbiBub2RlLiAgU2hvdWxkIG5ldmVyIGhhcHBlbi4KICBpZiAoc3RhdGUubGVuZ3RoID4gMCkKICAgIHRocm93IG5ldyBFcnJvcignZW5kUmVhZGFibGUgY2FsbGVkIG9uIG5vbi1lbXB0eSBzdHJlYW0nKTsKCiAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkKSB7CiAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAvLyBDaGVjayB0aGF0IHdlIGRpZG4ndCBnZXQgb25lIGxhc3QgdW5zaGlmdC4KICAgICAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkICYmIHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCmZ1bmN0aW9uIGluZGV4T2YgKHhzLCB4KSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSB4cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmICh4c1tpXSA9PT0geCkgcmV0dXJuIGk7CiAgfQogIHJldHVybiAtMTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL19zdHJlYW1fZHVwbGV4IjoxMjEsIl9wcm9jZXNzIjo2MCwiYnVmZmVyIjo1MywiY29yZS11dGlsLWlzIjoxMjYsImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwiaXNhcnJheSI6MTI3LCJzdHJlYW0iOjcyLCJzdHJpbmdfZGVjb2Rlci8iOjEyOCwidXRpbCI6NTJ9XSwxMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgoKLy8gYSB0cmFuc2Zvcm0gc3RyZWFtIGlzIGEgcmVhZGFibGUvd3JpdGFibGUgc3RyZWFtIHdoZXJlIHlvdSBkbwovLyBzb21ldGhpbmcgd2l0aCB0aGUgZGF0YS4gIFNvbWV0aW1lcyBpdCdzIGNhbGxlZCBhICJmaWx0ZXIiLAovLyBidXQgdGhhdCdzIG5vdCBhIGdyZWF0IG5hbWUgZm9yIGl0LCBzaW5jZSB0aGF0IGltcGxpZXMgYSB0aGluZyB3aGVyZQovLyBzb21lIGJpdHMgcGFzcyB0aHJvdWdoLCBhbmQgb3RoZXJzIGFyZSBzaW1wbHkgaWdub3JlZC4gIChUaGF0IHdvdWxkCi8vIGJlIGEgdmFsaWQgZXhhbXBsZSBvZiBhIHRyYW5zZm9ybSwgb2YgY291cnNlLikKLy8KLy8gV2hpbGUgdGhlIG91dHB1dCBpcyBjYXVzYWxseSByZWxhdGVkIHRvIHRoZSBpbnB1dCwgaXQncyBub3QgYQovLyBuZWNlc3NhcmlseSBzeW1tZXRyaWMgb3Igc3luY2hyb25vdXMgdHJhbnNmb3JtYXRpb24uICBGb3IgZXhhbXBsZSwKLy8gYSB6bGliIHN0cmVhbSBtaWdodCB0YWtlIG11bHRpcGxlIHBsYWluLXRleHQgd3JpdGVzKCksIGFuZCB0aGVuCi8vIGVtaXQgYSBzaW5nbGUgY29tcHJlc3NlZCBjaHVuayBzb21lIHRpbWUgaW4gdGhlIGZ1dHVyZS4KLy8KLy8gSGVyZSdzIGhvdyB0aGlzIHdvcmtzOgovLwovLyBUaGUgVHJhbnNmb3JtIHN0cmVhbSBoYXMgYWxsIHRoZSBhc3BlY3RzIG9mIHRoZSByZWFkYWJsZSBhbmQgd3JpdGFibGUKLy8gc3RyZWFtIGNsYXNzZXMuICBXaGVuIHlvdSB3cml0ZShjaHVuayksIHRoYXQgY2FsbHMgX3dyaXRlKGNodW5rLGNiKQovLyBpbnRlcm5hbGx5LCBhbmQgcmV0dXJucyBmYWxzZSBpZiB0aGVyZSdzIGEgbG90IG9mIHBlbmRpbmcgd3JpdGVzCi8vIGJ1ZmZlcmVkIHVwLiAgV2hlbiB5b3UgY2FsbCByZWFkKCksIHRoYXQgY2FsbHMgX3JlYWQobikgdW50aWwKLy8gdGhlcmUncyBlbm91Z2ggcGVuZGluZyByZWFkYWJsZSBkYXRhIGJ1ZmZlcmVkIHVwLgovLwovLyBJbiBhIHRyYW5zZm9ybSBzdHJlYW0sIHRoZSB3cml0dGVuIGRhdGEgaXMgcGxhY2VkIGluIGEgYnVmZmVyLiAgV2hlbgovLyBfcmVhZChuKSBpcyBjYWxsZWQsIGl0IHRyYW5zZm9ybXMgdGhlIHF1ZXVlZCB1cCBkYXRhLCBjYWxsaW5nIHRoZQovLyBidWZmZXJlZCBfd3JpdGUgY2IncyBhcyBpdCBjb25zdW1lcyBjaHVua3MuICBJZiBjb25zdW1pbmcgYSBzaW5nbGUKLy8gd3JpdHRlbiBjaHVuayB3b3VsZCByZXN1bHQgaW4gbXVsdGlwbGUgb3V0cHV0IGNodW5rcywgdGhlbiB0aGUgZmlyc3QKLy8gb3V0cHV0dGVkIGJpdCBjYWxscyB0aGUgcmVhZGNiLCBhbmQgc3Vic2VxdWVudCBjaHVua3MganVzdCBnbyBpbnRvCi8vIHRoZSByZWFkIGJ1ZmZlciwgYW5kIHdpbGwgY2F1c2UgaXQgdG8gZW1pdCAncmVhZGFibGUnIGlmIG5lY2Vzc2FyeS4KLy8KLy8gVGhpcyB3YXksIGJhY2stcHJlc3N1cmUgaXMgYWN0dWFsbHkgZGV0ZXJtaW5lZCBieSB0aGUgcmVhZGluZyBzaWRlLAovLyBzaW5jZSBfcmVhZCBoYXMgdG8gYmUgY2FsbGVkIHRvIHN0YXJ0IHByb2Nlc3NpbmcgYSBuZXcgY2h1bmsuICBIb3dldmVyLAovLyBhIHBhdGhvbG9naWNhbCBpbmZsYXRlIHR5cGUgb2YgdHJhbnNmb3JtIGNhbiBjYXVzZSBleGNlc3NpdmUgYnVmZmVyaW5nCi8vIGhlcmUuICBGb3IgZXhhbXBsZSwgaW1hZ2luZSBhIHN0cmVhbSB3aGVyZSBldmVyeSBieXRlIG9mIGlucHV0IGlzCi8vIGludGVycHJldGVkIGFzIGFuIGludGVnZXIgZnJvbSAwLTI1NSwgYW5kIHRoZW4gcmVzdWx0cyBpbiB0aGF0IG1hbnkKLy8gYnl0ZXMgb2Ygb3V0cHV0LiAgV3JpdGluZyB0aGUgNCBieXRlcyB7ZmYsZmYsZmYsZmZ9IHdvdWxkIHJlc3VsdCBpbgovLyAxa2Igb2YgZGF0YSBiZWluZyBvdXRwdXQuICBJbiB0aGlzIGNhc2UsIHlvdSBjb3VsZCB3cml0ZSBhIHZlcnkgc21hbGwKLy8gYW1vdW50IG9mIGlucHV0LCBhbmQgZW5kIHVwIHdpdGggYSB2ZXJ5IGxhcmdlIGFtb3VudCBvZiBvdXRwdXQuICBJbgovLyBzdWNoIGEgcGF0aG9sb2dpY2FsIGluZmxhdGluZyBtZWNoYW5pc20sIHRoZXJlJ2QgYmUgbm8gd2F5IHRvIHRlbGwKLy8gdGhlIHN5c3RlbSB0byBzdG9wIGRvaW5nIHRoZSB0cmFuc2Zvcm0uICBBIHNpbmdsZSA0TUIgd3JpdGUgY291bGQKLy8gY2F1c2UgdGhlIHN5c3RlbSB0byBydW4gb3V0IG9mIG1lbW9yeS4KLy8KLy8gSG93ZXZlciwgZXZlbiBpbiBzdWNoIGEgcGF0aG9sb2dpY2FsIGNhc2UsIG9ubHkgYSBzaW5nbGUgd3JpdHRlbiBjaHVuawovLyB3b3VsZCBiZSBjb25zdW1lZCwgYW5kIHRoZW4gdGhlIHJlc3Qgd291bGQgd2FpdCAodW4tdHJhbnNmb3JtZWQpIHVudGlsCi8vIHRoZSByZXN1bHRzIG9mIHRoZSBwcmV2aW91cyB0cmFuc2Zvcm1lZCBjaHVuayB3ZXJlIGNvbnN1bWVkLgoKbW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm07Cgp2YXIgRHVwbGV4ID0gcmVxdWlyZSgnLi9fc3RyZWFtX2R1cGxleCcpOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIHV0aWwgPSByZXF1aXJlKCdjb3JlLXV0aWwtaXMnKTsKdXRpbC5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKdXRpbC5pbmhlcml0cyhUcmFuc2Zvcm0sIER1cGxleCk7CgoKZnVuY3Rpb24gVHJhbnNmb3JtU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdGhpcy5hZnRlclRyYW5zZm9ybSA9IGZ1bmN0aW9uKGVyLCBkYXRhKSB7CiAgICByZXR1cm4gYWZ0ZXJUcmFuc2Zvcm0oc3RyZWFtLCBlciwgZGF0YSk7CiAgfTsKCiAgdGhpcy5uZWVkVHJhbnNmb3JtID0gZmFsc2U7CiAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTsKICB0aGlzLndyaXRlY2IgPSBudWxsOwogIHRoaXMud3JpdGVjaHVuayA9IG51bGw7Cn0KCmZ1bmN0aW9uIGFmdGVyVHJhbnNmb3JtKHN0cmVhbSwgZXIsIGRhdGEpIHsKICB2YXIgdHMgPSBzdHJlYW0uX3RyYW5zZm9ybVN0YXRlOwogIHRzLnRyYW5zZm9ybWluZyA9IGZhbHNlOwoKICB2YXIgY2IgPSB0cy53cml0ZWNiOwoKICBpZiAoIWNiKQogICAgcmV0dXJuIHN0cmVhbS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignbm8gd3JpdGVjYiBpbiBUcmFuc2Zvcm0gY2xhc3MnKSk7CgogIHRzLndyaXRlY2h1bmsgPSBudWxsOwogIHRzLndyaXRlY2IgPSBudWxsOwoKICBpZiAoIXV0aWwuaXNOdWxsT3JVbmRlZmluZWQoZGF0YSkpCiAgICBzdHJlYW0ucHVzaChkYXRhKTsKCiAgaWYgKGNiKQogICAgY2IoZXIpOwoKICB2YXIgcnMgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgcnMucmVhZGluZyA9IGZhbHNlOwogIGlmIChycy5uZWVkUmVhZGFibGUgfHwgcnMubGVuZ3RoIDwgcnMuaGlnaFdhdGVyTWFyaykgewogICAgc3RyZWFtLl9yZWFkKHJzLmhpZ2hXYXRlck1hcmspOwogIH0KfQoKCmZ1bmN0aW9uIFRyYW5zZm9ybShvcHRpb25zKSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRyYW5zZm9ybSkpCiAgICByZXR1cm4gbmV3IFRyYW5zZm9ybShvcHRpb25zKTsKCiAgRHVwbGV4LmNhbGwodGhpcywgb3B0aW9ucyk7CgogIHRoaXMuX3RyYW5zZm9ybVN0YXRlID0gbmV3IFRyYW5zZm9ybVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyB3aGVuIHRoZSB3cml0YWJsZSBzaWRlIGZpbmlzaGVzLCB0aGVuIGZsdXNoIG91dCBhbnl0aGluZyByZW1haW5pbmcuCiAgdmFyIHN0cmVhbSA9IHRoaXM7CgogIC8vIHN0YXJ0IG91dCBhc2tpbmcgZm9yIGEgcmVhZGFibGUgZXZlbnQgb25jZSBkYXRhIGlzIHRyYW5zZm9ybWVkLgogIHRoaXMuX3JlYWRhYmxlU3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gd2UgaGF2ZSBpbXBsZW1lbnRlZCB0aGUgX3JlYWQgbWV0aG9kLCBhbmQgZG9uZSB0aGUgb3RoZXIgdGhpbmdzCiAgLy8gdGhhdCBSZWFkYWJsZSB3YW50cyBiZWZvcmUgdGhlIGZpcnN0IF9yZWFkIGNhbGwsIHNvIHVuc2V0IHRoZQogIC8vIHN5bmMgZ3VhcmQgZmxhZy4KICB0aGlzLl9yZWFkYWJsZVN0YXRlLnN5bmMgPSBmYWxzZTsKCiAgdGhpcy5vbmNlKCdwcmVmaW5pc2gnLCBmdW5jdGlvbigpIHsKICAgIGlmICh1dGlsLmlzRnVuY3Rpb24odGhpcy5fZmx1c2gpKQogICAgICB0aGlzLl9mbHVzaChmdW5jdGlvbihlcikgewogICAgICAgIGRvbmUoc3RyZWFtLCBlcik7CiAgICAgIH0pOwogICAgZWxzZQogICAgICBkb25lKHN0cmVhbSk7CiAgfSk7Cn0KClRyYW5zZm9ybS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZykgewogIHRoaXMuX3RyYW5zZm9ybVN0YXRlLm5lZWRUcmFuc2Zvcm0gPSBmYWxzZTsKICByZXR1cm4gRHVwbGV4LnByb3RvdHlwZS5wdXNoLmNhbGwodGhpcywgY2h1bmssIGVuY29kaW5nKTsKfTsKCi8vIFRoaXMgaXMgdGhlIHBhcnQgd2hlcmUgeW91IGRvIHN0dWZmIQovLyBvdmVycmlkZSB0aGlzIGZ1bmN0aW9uIGluIGltcGxlbWVudGF0aW9uIGNsYXNzZXMuCi8vICdjaHVuaycgaXMgYW4gaW5wdXQgY2h1bmsuCi8vCi8vIENhbGwgYHB1c2gobmV3Q2h1bmspYCB0byBwYXNzIGFsb25nIHRyYW5zZm9ybWVkIG91dHB1dAovLyB0byB0aGUgcmVhZGFibGUgc2lkZS4gIFlvdSBtYXkgY2FsbCAncHVzaCcgemVybyBvciBtb3JlIHRpbWVzLgovLwovLyBDYWxsIGBjYihlcnIpYCB3aGVuIHlvdSBhcmUgZG9uZSB3aXRoIHRoaXMgY2h1bmsuICBJZiB5b3UgcGFzcwovLyBhbiBlcnJvciwgdGhlbiB0aGF0J2xsIHB1dCB0aGUgaHVydCBvbiB0aGUgd2hvbGUgb3BlcmF0aW9uLiAgSWYgeW91Ci8vIG5ldmVyIGNhbGwgY2IoKSwgdGhlbiB5b3UnbGwgbmV2ZXIgZ2V0IGFub3RoZXIgY2h1bmsuClRyYW5zZm9ybS5wcm90b3R5cGUuX3RyYW5zZm9ybSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpOwp9OwoKVHJhbnNmb3JtLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGU7CiAgdHMud3JpdGVjYiA9IGNiOwogIHRzLndyaXRlY2h1bmsgPSBjaHVuazsKICB0cy53cml0ZWVuY29kaW5nID0gZW5jb2Rpbmc7CiAgaWYgKCF0cy50cmFuc2Zvcm1pbmcpIHsKICAgIHZhciBycyA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgICBpZiAodHMubmVlZFRyYW5zZm9ybSB8fAogICAgICAgIHJzLm5lZWRSZWFkYWJsZSB8fAogICAgICAgIHJzLmxlbmd0aCA8IHJzLmhpZ2hXYXRlck1hcmspCiAgICAgIHRoaXMuX3JlYWQocnMuaGlnaFdhdGVyTWFyayk7CiAgfQp9OwoKLy8gRG9lc24ndCBtYXR0ZXIgd2hhdCB0aGUgYXJncyBhcmUgaGVyZS4KLy8gX3RyYW5zZm9ybSBkb2VzIGFsbCB0aGUgd29yay4KLy8gVGhhdCB3ZSBnb3QgaGVyZSBtZWFucyB0aGF0IHRoZSByZWFkYWJsZSBzaWRlIHdhbnRzIG1vcmUgZGF0YS4KVHJhbnNmb3JtLnByb3RvdHlwZS5fcmVhZCA9IGZ1bmN0aW9uKG4pIHsKICB2YXIgdHMgPSB0aGlzLl90cmFuc2Zvcm1TdGF0ZTsKCiAgaWYgKCF1dGlsLmlzTnVsbCh0cy53cml0ZWNodW5rKSAmJiB0cy53cml0ZWNiICYmICF0cy50cmFuc2Zvcm1pbmcpIHsKICAgIHRzLnRyYW5zZm9ybWluZyA9IHRydWU7CiAgICB0aGlzLl90cmFuc2Zvcm0odHMud3JpdGVjaHVuaywgdHMud3JpdGVlbmNvZGluZywgdHMuYWZ0ZXJUcmFuc2Zvcm0pOwogIH0gZWxzZSB7CiAgICAvLyBtYXJrIHRoYXQgd2UgbmVlZCBhIHRyYW5zZm9ybSwgc28gdGhhdCBhbnkgZGF0YSB0aGF0IGNvbWVzIGluCiAgICAvLyB3aWxsIGdldCBwcm9jZXNzZWQsIG5vdyB0aGF0IHdlJ3ZlIGFza2VkIGZvciBpdC4KICAgIHRzLm5lZWRUcmFuc2Zvcm0gPSB0cnVlOwogIH0KfTsKCgpmdW5jdGlvbiBkb25lKHN0cmVhbSwgZXIpIHsKICBpZiAoZXIpCiAgICByZXR1cm4gc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwoKICAvLyBpZiB0aGVyZSdzIG5vdGhpbmcgaW4gdGhlIHdyaXRlIGJ1ZmZlciwgdGhlbiB0aGF0IG1lYW5zCiAgLy8gdGhhdCBub3RoaW5nIG1vcmUgd2lsbCBldmVyIGJlIHByb3ZpZGVkCiAgdmFyIHdzID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh3cy5sZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbGxpbmcgdHJhbnNmb3JtIGRvbmUgd2hlbiB3cy5sZW5ndGggIT0gMCcpOwoKICBpZiAodHMudHJhbnNmb3JtaW5nKQogICAgdGhyb3cgbmV3IEVycm9yKCdjYWxsaW5nIHRyYW5zZm9ybSBkb25lIHdoZW4gc3RpbGwgdHJhbnNmb3JtaW5nJyk7CgogIHJldHVybiBzdHJlYW0ucHVzaChudWxsKTsKfQoKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjEyMSwiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Nn1dLDEyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIEEgYml0IHNpbXBsZXIgdGhhbiByZWFkYWJsZSBzdHJlYW1zLgovLyBJbXBsZW1lbnQgYW4gYXN5bmMgLl93cml0ZShjaHVuaywgY2IpLCBhbmQgaXQnbGwgaGFuZGxlIGFsbAovLyB0aGUgZHJhaW4gZXZlbnQgZW1pc3Npb24gYW5kIGJ1ZmZlcmluZy4KCm1vZHVsZS5leHBvcnRzID0gV3JpdGFibGU7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCldyaXRhYmxlLldyaXRhYmxlU3RhdGUgPSBXcml0YWJsZVN0YXRlOwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciB1dGlsID0gcmVxdWlyZSgnY29yZS11dGlsLWlzJyk7CnV0aWwuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCnZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTsKCnV0aWwuaW5oZXJpdHMoV3JpdGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhpcy5jaHVuayA9IGNodW5rOwogIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZzsKICB0aGlzLmNhbGxiYWNrID0gY2I7Cn0KCmZ1bmN0aW9uIFdyaXRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCB3cml0ZSgpIHN0YXJ0cyByZXR1cm5pbmcgZmFsc2UKICAvLyBOb3RlOiAwIGlzIGEgdmFsaWQgdmFsdWUsIG1lYW5zIHRoYXQgd2UgYWx3YXlzIHJldHVybiBmYWxzZSBpZgogIC8vIHRoZSBlbnRpcmUgYnVmZmVyIGlzIG5vdCBmbHVzaGVkIGltbWVkaWF0ZWx5IG9uIHdyaXRlKCkKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHZhciBkZWZhdWx0SHdtID0gb3B0aW9ucy5vYmplY3RNb2RlID8gMTYgOiAxNiAqIDEwMjQ7CiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gKGh3bSB8fCBod20gPT09IDApID8gaHdtIDogZGVmYXVsdEh3bTsKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnIHRvIGluZGljYXRlIHdoZXRoZXIgb3Igbm90IHRoaXMgc3RyZWFtCiAgLy8gY29udGFpbnMgYnVmZmVycyBvciBvYmplY3RzLgogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICBpZiAoc3RyZWFtIGluc3RhbmNlb2YgRHVwbGV4KQogICAgdGhpcy5vYmplY3RNb2RlID0gdGhpcy5vYmplY3RNb2RlIHx8ICEhb3B0aW9ucy53cml0YWJsZU9iamVjdE1vZGU7CgogIC8vIGNhc3QgdG8gaW50cy4KICB0aGlzLmhpZ2hXYXRlck1hcmsgPSB+fnRoaXMuaGlnaFdhdGVyTWFyazsKCiAgdGhpcy5uZWVkRHJhaW4gPSBmYWxzZTsKICAvLyBhdCB0aGUgc3RhcnQgb2YgY2FsbGluZyBlbmQoKQogIHRoaXMuZW5kaW5nID0gZmFsc2U7CiAgLy8gd2hlbiBlbmQoKSBoYXMgYmVlbiBjYWxsZWQsIGFuZCByZXR1cm5lZAogIHRoaXMuZW5kZWQgPSBmYWxzZTsKICAvLyB3aGVuICdmaW5pc2gnIGlzIGVtaXR0ZWQKICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CgogIC8vIHNob3VsZCB3ZSBkZWNvZGUgc3RyaW5ncyBpbnRvIGJ1ZmZlcnMgYmVmb3JlIHBhc3NpbmcgdG8gX3dyaXRlPwogIC8vIHRoaXMgaXMgaGVyZSBzbyB0aGF0IHNvbWUgbm9kZS1jb3JlIHN0cmVhbXMgY2FuIG9wdGltaXplIHN0cmluZwogIC8vIGhhbmRsaW5nIGF0IGEgbG93ZXIgbGV2ZWwuCiAgdmFyIG5vRGVjb2RlID0gb3B0aW9ucy5kZWNvZGVTdHJpbmdzID09PSBmYWxzZTsKICB0aGlzLmRlY29kZVN0cmluZ3MgPSAhbm9EZWNvZGU7CgogIC8vIENyeXB0byBpcyBraW5kIG9mIG9sZCBhbmQgY3J1c3R5LiAgSGlzdG9yaWNhbGx5LCBpdHMgZGVmYXVsdCBzdHJpbmcKICAvLyBlbmNvZGluZyBpcyAnYmluYXJ5JyBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhpcyBjb25maWd1cmFibGUuCiAgLy8gRXZlcnl0aGluZyBlbHNlIGluIHRoZSB1bml2ZXJzZSB1c2VzICd1dGY4JywgdGhvdWdoLgogIHRoaXMuZGVmYXVsdEVuY29kaW5nID0gb3B0aW9ucy5kZWZhdWx0RW5jb2RpbmcgfHwgJ3V0ZjgnOwoKICAvLyBub3QgYW4gYWN0dWFsIGJ1ZmZlciB3ZSBrZWVwIHRyYWNrIG9mLCBidXQgYSBtZWFzdXJlbWVudAogIC8vIG9mIGhvdyBtdWNoIHdlJ3JlIHdhaXRpbmcgdG8gZ2V0IHB1c2hlZCB0byBzb21lIHVuZGVybHlpbmcKICAvLyBzb2NrZXQgb3IgZmlsZS4KICB0aGlzLmxlbmd0aCA9IDA7CgogIC8vIGEgZmxhZyB0byBzZWUgd2hlbiB3ZSdyZSBpbiB0aGUgbWlkZGxlIG9mIGEgd3JpdGUuCiAgdGhpcy53cml0aW5nID0gZmFsc2U7CgogIC8vIHdoZW4gdHJ1ZSBhbGwgd3JpdGVzIHdpbGwgYmUgYnVmZmVyZWQgdW50aWwgLnVuY29yaygpIGNhbGwKICB0aGlzLmNvcmtlZCA9IDA7CgogIC8vIGEgZmxhZyB0byBiZSBhYmxlIHRvIHRlbGwgaWYgdGhlIG9ud3JpdGUgY2IgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LAogIC8vIG9yIG9uIGEgbGF0ZXIgdGljay4gIFdlIHNldCB0aGlzIHRvIHRydWUgYXQgZmlyc3QsIGJlY2F1c2UgYW55CiAgLy8gYWN0aW9ucyB0aGF0IHNob3VsZG4ndCBoYXBwZW4gdW50aWwgImxhdGVyIiBzaG91bGQgZ2VuZXJhbGx5IGFsc28KICAvLyBub3QgaGFwcGVuIGJlZm9yZSB0aGUgZmlyc3Qgd3JpdGUgY2FsbC4KICB0aGlzLnN5bmMgPSB0cnVlOwoKICAvLyBhIGZsYWcgdG8ga25vdyBpZiB3ZSdyZSBwcm9jZXNzaW5nIHByZXZpb3VzbHkgYnVmZmVyZWQgaXRlbXMsIHdoaWNoCiAgLy8gbWF5IGNhbGwgdGhlIF93cml0ZSgpIGNhbGxiYWNrIGluIHRoZSBzYW1lIHRpY2ssIHNvIHRoYXQgd2UgZG9uJ3QKICAvLyBlbmQgdXAgaW4gYW4gb3ZlcmxhcHBlZCBvbndyaXRlIHNpdHVhdGlvbi4KICB0aGlzLmJ1ZmZlclByb2Nlc3NpbmcgPSBmYWxzZTsKCiAgLy8gdGhlIGNhbGxiYWNrIHRoYXQncyBwYXNzZWQgdG8gX3dyaXRlKGNodW5rLGNiKQogIHRoaXMub253cml0ZSA9IGZ1bmN0aW9uKGVyKSB7CiAgICBvbndyaXRlKHN0cmVhbSwgZXIpOwogIH07CgogIC8vIHRoZSBjYWxsYmFjayB0aGF0IHRoZSB1c2VyIHN1cHBsaWVzIHRvIHdyaXRlKGNodW5rLGVuY29kaW5nLGNiKQogIHRoaXMud3JpdGVjYiA9IG51bGw7CgogIC8vIHRoZSBhbW91bnQgdGhhdCBpcyBiZWluZyB3cml0dGVuIHdoZW4gX3dyaXRlIGlzIGNhbGxlZC4KICB0aGlzLndyaXRlbGVuID0gMDsKCiAgdGhpcy5idWZmZXIgPSBbXTsKCiAgLy8gbnVtYmVyIG9mIHBlbmRpbmcgdXNlci1zdXBwbGllZCB3cml0ZSBjYWxsYmFja3MKICAvLyB0aGlzIG11c3QgYmUgMCBiZWZvcmUgJ2ZpbmlzaCcgY2FuIGJlIGVtaXR0ZWQKICB0aGlzLnBlbmRpbmdjYiA9IDA7CgogIC8vIGVtaXQgcHJlZmluaXNoIGlmIHRoZSBvbmx5IHRoaW5nIHdlJ3JlIHdhaXRpbmcgZm9yIGlzIF93cml0ZSBjYnMKICAvLyBUaGlzIGlzIHJlbGV2YW50IGZvciBzeW5jaHJvbm91cyBUcmFuc2Zvcm0gc3RyZWFtcwogIHRoaXMucHJlZmluaXNoZWQgPSBmYWxzZTsKCiAgLy8gVHJ1ZSBpZiB0aGUgZXJyb3Igd2FzIGFscmVhZHkgZW1pdHRlZCBhbmQgc2hvdWxkIG5vdCBiZSB0aHJvd24gYWdhaW4KICB0aGlzLmVycm9yRW1pdHRlZCA9IGZhbHNlOwp9CgpmdW5jdGlvbiBXcml0YWJsZShvcHRpb25zKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgLy8gV3JpdGFibGUgY3RvciBpcyBhcHBsaWVkIHRvIER1cGxleGVzLCB0aG91Z2ggdGhleSdyZSBub3QKICAvLyBpbnN0YW5jZW9mIFdyaXRhYmxlLCB0aGV5J3JlIGluc3RhbmNlb2YgUmVhZGFibGUuCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFdyaXRhYmxlKSAmJiAhKHRoaXMgaW5zdGFuY2VvZiBEdXBsZXgpKQogICAgcmV0dXJuIG5ldyBXcml0YWJsZShvcHRpb25zKTsKCiAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG5ldyBXcml0YWJsZVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyBsZWdhY3kuCiAgdGhpcy53cml0YWJsZSA9IHRydWU7CgogIFN0cmVhbS5jYWxsKHRoaXMpOwp9CgovLyBPdGhlcndpc2UgcGVvcGxlIGNhbiBwaXBlIFdyaXRhYmxlIHN0cmVhbXMsIHdoaWNoIGlzIGp1c3Qgd3JvbmcuCldyaXRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignQ2Fubm90IHBpcGUuIE5vdCByZWFkYWJsZS4nKSk7Cn07CgoKZnVuY3Rpb24gd3JpdGVBZnRlckVuZChzdHJlYW0sIHN0YXRlLCBjYikgewogIHZhciBlciA9IG5ldyBFcnJvcignd3JpdGUgYWZ0ZXIgZW5kJyk7CiAgLy8gVE9ETzogZGVmZXIgZXJyb3IgZXZlbnRzIGNvbnNpc3RlbnRseSBldmVyeXdoZXJlLCBub3QganVzdCB0aGUgY2IKICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CiAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgIGNiKGVyKTsKICB9KTsKfQoKLy8gSWYgd2UgZ2V0IHNvbWV0aGluZyB0aGF0IGlzIG5vdCBhIGJ1ZmZlciwgc3RyaW5nLCBudWxsLCBvciB1bmRlZmluZWQsCi8vIGFuZCB3ZSdyZSBub3QgaW4gb2JqZWN0TW9kZSwgdGhlbiB0aGF0J3MgYW4gZXJyb3IuCi8vIE90aGVyd2lzZSBzdHJlYW0gY2h1bmtzIGFyZSBhbGwgY29uc2lkZXJlZCB0byBiZSBvZiBsZW5ndGg9MSwgYW5kIHRoZQovLyB3YXRlcm1hcmtzIGRldGVybWluZSBob3cgbWFueSBvYmplY3RzIHRvIGtlZXAgaW4gdGhlIGJ1ZmZlciwgcmF0aGVyIHRoYW4KLy8gaG93IG1hbnkgYnl0ZXMgb3IgY2hhcmFjdGVycy4KZnVuY3Rpb24gdmFsaWRDaHVuayhzdHJlYW0sIHN0YXRlLCBjaHVuaywgY2IpIHsKICB2YXIgdmFsaWQgPSB0cnVlOwogIGlmICghdXRpbC5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgIXV0aWwuaXNTdHJpbmcoY2h1bmspICYmCiAgICAgICF1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNodW5rKSAmJgogICAgICAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgdmFyIGVyID0gbmV3IFR5cGVFcnJvcignSW52YWxpZCBub24tc3RyaW5nL2J1ZmZlciBjaHVuaycpOwogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgY2IoZXIpOwogICAgfSk7CiAgICB2YWxpZCA9IGZhbHNlOwogIH0KICByZXR1cm4gdmFsaWQ7Cn0KCldyaXRhYmxlLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwogIHZhciByZXQgPSBmYWxzZTsKCiAgaWYgKHV0aWwuaXNGdW5jdGlvbihlbmNvZGluZykpIHsKICAgIGNiID0gZW5jb2Rpbmc7CiAgICBlbmNvZGluZyA9IG51bGw7CiAgfQoKICBpZiAodXRpbC5pc0J1ZmZlcihjaHVuaykpCiAgICBlbmNvZGluZyA9ICdidWZmZXInOwogIGVsc2UgaWYgKCFlbmNvZGluZykKICAgIGVuY29kaW5nID0gc3RhdGUuZGVmYXVsdEVuY29kaW5nOwoKICBpZiAoIXV0aWwuaXNGdW5jdGlvbihjYikpCiAgICBjYiA9IGZ1bmN0aW9uKCkge307CgogIGlmIChzdGF0ZS5lbmRlZCkKICAgIHdyaXRlQWZ0ZXJFbmQodGhpcywgc3RhdGUsIGNiKTsKICBlbHNlIGlmICh2YWxpZENodW5rKHRoaXMsIHN0YXRlLCBjaHVuaywgY2IpKSB7CiAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgIHJldCA9IHdyaXRlT3JCdWZmZXIodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKCldyaXRhYmxlLnByb3RvdHlwZS5jb3JrID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgc3RhdGUuY29ya2VkKys7Cn07CgpXcml0YWJsZS5wcm90b3R5cGUudW5jb3JrID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgaWYgKHN0YXRlLmNvcmtlZCkgewogICAgc3RhdGUuY29ya2VkLS07CgogICAgaWYgKCFzdGF0ZS53cml0aW5nICYmCiAgICAgICAgIXN0YXRlLmNvcmtlZCAmJgogICAgICAgICFzdGF0ZS5maW5pc2hlZCAmJgogICAgICAgICFzdGF0ZS5idWZmZXJQcm9jZXNzaW5nICYmCiAgICAgICAgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgY2xlYXJCdWZmZXIodGhpcywgc3RhdGUpOwogIH0KfTsKCmZ1bmN0aW9uIGRlY29kZUNodW5rKHN0YXRlLCBjaHVuaywgZW5jb2RpbmcpIHsKICBpZiAoIXN0YXRlLm9iamVjdE1vZGUgJiYKICAgICAgc3RhdGUuZGVjb2RlU3RyaW5ncyAhPT0gZmFsc2UgJiYKICAgICAgdXRpbC5pc1N0cmluZyhjaHVuaykpIHsKICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogIH0KICByZXR1cm4gY2h1bms7Cn0KCi8vIGlmIHdlJ3JlIGFscmVhZHkgd3JpdGluZyBzb21ldGhpbmcsIHRoZW4ganVzdCBwdXQgdGhpcwovLyBpbiB0aGUgcXVldWUsIGFuZCB3YWl0IG91ciB0dXJuLiAgT3RoZXJ3aXNlLCBjYWxsIF93cml0ZQovLyBJZiB3ZSByZXR1cm4gZmFsc2UsIHRoZW4gd2UgbmVlZCBhIGRyYWluIGV2ZW50LCBzbyBzZXQgdGhhdCBmbGFnLgpmdW5jdGlvbiB3cml0ZU9yQnVmZmVyKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpIHsKICBjaHVuayA9IGRlY29kZUNodW5rKHN0YXRlLCBjaHVuaywgZW5jb2RpbmcpOwogIGlmICh1dGlsLmlzQnVmZmVyKGNodW5rKSkKICAgIGVuY29kaW5nID0gJ2J1ZmZlcic7CiAgdmFyIGxlbiA9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwoKICBzdGF0ZS5sZW5ndGggKz0gbGVuOwoKICB2YXIgcmV0ID0gc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyazsKICAvLyB3ZSBtdXN0IGVuc3VyZSB0aGF0IHByZXZpb3VzIG5lZWREcmFpbiB3aWxsIG5vdCBiZSByZXNldCB0byBmYWxzZS4KICBpZiAoIXJldCkKICAgIHN0YXRlLm5lZWREcmFpbiA9IHRydWU7CgogIGlmIChzdGF0ZS53cml0aW5nIHx8IHN0YXRlLmNvcmtlZCkKICAgIHN0YXRlLmJ1ZmZlci5wdXNoKG5ldyBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSk7CiAgZWxzZQogICAgZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCBmYWxzZSwgbGVuLCBjaHVuaywgZW5jb2RpbmcsIGNiKTsKCiAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCB3cml0ZXYsIGxlbiwgY2h1bmssIGVuY29kaW5nLCBjYikgewogIHN0YXRlLndyaXRlbGVuID0gbGVuOwogIHN0YXRlLndyaXRlY2IgPSBjYjsKICBzdGF0ZS53cml0aW5nID0gdHJ1ZTsKICBzdGF0ZS5zeW5jID0gdHJ1ZTsKICBpZiAod3JpdGV2KQogICAgc3RyZWFtLl93cml0ZXYoY2h1bmssIHN0YXRlLm9ud3JpdGUpOwogIGVsc2UKICAgIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICBzdGF0ZS5zeW5jID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIG9ud3JpdGVFcnJvcihzdHJlYW0sIHN0YXRlLCBzeW5jLCBlciwgY2IpIHsKICBpZiAoc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgICBjYihlcik7CiAgICB9KTsKICBlbHNlIHsKICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgY2IoZXIpOwogIH0KCiAgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVycm9yRW1pdHRlZCA9IHRydWU7CiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwp9CgpmdW5jdGlvbiBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpIHsKICBzdGF0ZS53cml0aW5nID0gZmFsc2U7CiAgc3RhdGUud3JpdGVjYiA9IG51bGw7CiAgc3RhdGUubGVuZ3RoIC09IHN0YXRlLndyaXRlbGVuOwogIHN0YXRlLndyaXRlbGVuID0gMDsKfQoKZnVuY3Rpb24gb253cml0ZShzdHJlYW0sIGVyKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciBzeW5jID0gc3RhdGUuc3luYzsKICB2YXIgY2IgPSBzdGF0ZS53cml0ZWNiOwoKICBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpOwoKICBpZiAoZXIpCiAgICBvbndyaXRlRXJyb3Ioc3RyZWFtLCBzdGF0ZSwgc3luYywgZXIsIGNiKTsKICBlbHNlIHsKICAgIC8vIENoZWNrIGlmIHdlJ3JlIGFjdHVhbGx5IHJlYWR5IHRvIGZpbmlzaCwgYnV0IGRvbid0IGVtaXQgeWV0CiAgICB2YXIgZmluaXNoZWQgPSBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpOwoKICAgIGlmICghZmluaXNoZWQgJiYKICAgICAgICAhc3RhdGUuY29ya2VkICYmCiAgICAgICAgIXN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgJiYKICAgICAgICBzdGF0ZS5idWZmZXIubGVuZ3RoKSB7CiAgICAgIGNsZWFyQnVmZmVyKHN0cmVhbSwgc3RhdGUpOwogICAgfQoKICAgIGlmIChzeW5jKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGFmdGVyV3JpdGUoc3RyZWFtLCBzdGF0ZSwgZmluaXNoZWQsIGNiKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFmdGVyV3JpdGUoc3RyZWFtLCBzdGF0ZSwgZmluaXNoZWQsIGNiKSB7CiAgaWYgKCFmaW5pc2hlZCkKICAgIG9ud3JpdGVEcmFpbihzdHJlYW0sIHN0YXRlKTsKICBzdGF0ZS5wZW5kaW5nY2ItLTsKICBjYigpOwogIGZpbmlzaE1heWJlKHN0cmVhbSwgc3RhdGUpOwp9CgovLyBNdXN0IGZvcmNlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCBvbiBuZXh0VGljaywgc28gdGhhdCB3ZSBkb24ndAovLyBlbWl0ICdkcmFpbicgYmVmb3JlIHRoZSB3cml0ZSgpIGNvbnN1bWVyIGdldHMgdGhlICdmYWxzZScgcmV0dXJuCi8vIHZhbHVlLCBhbmQgaGFzIGEgY2hhbmNlIHRvIGF0dGFjaCBhICdkcmFpbicgbGlzdGVuZXIuCmZ1bmN0aW9uIG9ud3JpdGVEcmFpbihzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCAmJiBzdGF0ZS5uZWVkRHJhaW4pIHsKICAgIHN0YXRlLm5lZWREcmFpbiA9IGZhbHNlOwogICAgc3RyZWFtLmVtaXQoJ2RyYWluJyk7CiAgfQp9CgoKLy8gaWYgdGhlcmUncyBzb21ldGhpbmcgaW4gdGhlIGJ1ZmZlciB3YWl0aW5nLCB0aGVuIHByb2Nlc3MgaXQKZnVuY3Rpb24gY2xlYXJCdWZmZXIoc3RyZWFtLCBzdGF0ZSkgewogIHN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgPSB0cnVlOwoKICBpZiAoc3RyZWFtLl93cml0ZXYgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCA+IDEpIHsKICAgIC8vIEZhc3QgY2FzZSwgd3JpdGUgZXZlcnl0aGluZyB1c2luZyBfd3JpdGV2KCkKICAgIHZhciBjYnMgPSBbXTsKICAgIGZvciAodmFyIGMgPSAwOyBjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aDsgYysrKQogICAgICBjYnMucHVzaChzdGF0ZS5idWZmZXJbY10uY2FsbGJhY2spOwoKICAgIC8vIGNvdW50IHRoZSBvbmUgd2UgYXJlIGFkZGluZywgYXMgd2VsbC4KICAgIC8vIFRPRE8oaXNhYWNzKSBjbGVhbiB0aGlzIHVwCiAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgdHJ1ZSwgc3RhdGUubGVuZ3RoLCBzdGF0ZS5idWZmZXIsICcnLCBmdW5jdGlvbihlcnIpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzdGF0ZS5wZW5kaW5nY2ItLTsKICAgICAgICBjYnNbaV0oZXJyKTsKICAgICAgfQogICAgfSk7CgogICAgLy8gQ2xlYXIgYnVmZmVyCiAgICBzdGF0ZS5idWZmZXIgPSBbXTsKICB9IGVsc2UgewogICAgLy8gU2xvdyBjYXNlLCB3cml0ZSBjaHVua3Mgb25lLWJ5LW9uZQogICAgZm9yICh2YXIgYyA9IDA7IGMgPCBzdGF0ZS5idWZmZXIubGVuZ3RoOyBjKyspIHsKICAgICAgdmFyIGVudHJ5ID0gc3RhdGUuYnVmZmVyW2NdOwogICAgICB2YXIgY2h1bmsgPSBlbnRyeS5jaHVuazsKICAgICAgdmFyIGVuY29kaW5nID0gZW50cnkuZW5jb2Rpbmc7CiAgICAgIHZhciBjYiA9IGVudHJ5LmNhbGxiYWNrOwogICAgICB2YXIgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CgogICAgICBkb1dyaXRlKHN0cmVhbSwgc3RhdGUsIGZhbHNlLCBsZW4sIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICAgICAgLy8gaWYgd2UgZGlkbid0IGNhbGwgdGhlIG9ud3JpdGUgaW1tZWRpYXRlbHksIHRoZW4KICAgICAgLy8gaXQgbWVhbnMgdGhhdCB3ZSBuZWVkIHRvIHdhaXQgdW50aWwgaXQgZG9lcy4KICAgICAgLy8gYWxzbywgdGhhdCBtZWFucyB0aGF0IHRoZSBjaHVuayBhbmQgY2IgYXJlIGN1cnJlbnRseQogICAgICAvLyBiZWluZyBwcm9jZXNzZWQsIHNvIG1vdmUgdGhlIGJ1ZmZlciBjb3VudGVyIHBhc3QgdGhlbS4KICAgICAgaWYgKHN0YXRlLndyaXRpbmcpIHsKICAgICAgICBjKys7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoYyA8IHN0YXRlLmJ1ZmZlci5sZW5ndGgpCiAgICAgIHN0YXRlLmJ1ZmZlciA9IHN0YXRlLmJ1ZmZlci5zbGljZShjKTsKICAgIGVsc2UKICAgICAgc3RhdGUuYnVmZmVyLmxlbmd0aCA9IDA7CiAgfQoKICBzdGF0ZS5idWZmZXJQcm9jZXNzaW5nID0gZmFsc2U7Cn0KCldyaXRhYmxlLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgY2IobmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKSk7Cgp9OwoKV3JpdGFibGUucHJvdG90eXBlLl93cml0ZXYgPSBudWxsOwoKV3JpdGFibGUucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwoKICBpZiAodXRpbC5pc0Z1bmN0aW9uKGNodW5rKSkgewogICAgY2IgPSBjaHVuazsKICAgIGNodW5rID0gbnVsbDsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9IGVsc2UgaWYgKHV0aWwuaXNGdW5jdGlvbihlbmNvZGluZykpIHsKICAgIGNiID0gZW5jb2Rpbmc7CiAgICBlbmNvZGluZyA9IG51bGw7CiAgfQoKICBpZiAoIXV0aWwuaXNOdWxsT3JVbmRlZmluZWQoY2h1bmspKQogICAgdGhpcy53cml0ZShjaHVuaywgZW5jb2RpbmcpOwoKICAvLyAuZW5kKCkgZnVsbHkgdW5jb3JrcwogIGlmIChzdGF0ZS5jb3JrZWQpIHsKICAgIHN0YXRlLmNvcmtlZCA9IDE7CiAgICB0aGlzLnVuY29yaygpOwogIH0KCiAgLy8gaWdub3JlIHVubmVjZXNzYXJ5IGVuZCgpIGNhbGxzLgogIGlmICghc3RhdGUuZW5kaW5nICYmICFzdGF0ZS5maW5pc2hlZCkKICAgIGVuZFdyaXRhYmxlKHRoaXMsIHN0YXRlLCBjYik7Cn07CgoKZnVuY3Rpb24gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKSB7CiAgcmV0dXJuIChzdGF0ZS5lbmRpbmcgJiYKICAgICAgICAgIHN0YXRlLmxlbmd0aCA9PT0gMCAmJgogICAgICAgICAgIXN0YXRlLmZpbmlzaGVkICYmCiAgICAgICAgICAhc3RhdGUud3JpdGluZyk7Cn0KCmZ1bmN0aW9uIHByZWZpbmlzaChzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5wcmVmaW5pc2hlZCkgewogICAgc3RhdGUucHJlZmluaXNoZWQgPSB0cnVlOwogICAgc3RyZWFtLmVtaXQoJ3ByZWZpbmlzaCcpOwogIH0KfQoKZnVuY3Rpb24gZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSkgewogIHZhciBuZWVkID0gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICBpZiAobmVlZCkgewogICAgaWYgKHN0YXRlLnBlbmRpbmdjYiA9PT0gMCkgewogICAgICBwcmVmaW5pc2goc3RyZWFtLCBzdGF0ZSk7CiAgICAgIHN0YXRlLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpOwogICAgfSBlbHNlCiAgICAgIHByZWZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICB9CiAgcmV0dXJuIG5lZWQ7Cn0KCmZ1bmN0aW9uIGVuZFdyaXRhYmxlKHN0cmVhbSwgc3RhdGUsIGNiKSB7CiAgc3RhdGUuZW5kaW5nID0gdHJ1ZTsKICBmaW5pc2hNYXliZShzdHJlYW0sIHN0YXRlKTsKICBpZiAoY2IpIHsKICAgIGlmIChzdGF0ZS5maW5pc2hlZCkKICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7CiAgICBlbHNlCiAgICAgIHN0cmVhbS5vbmNlKCdmaW5pc2gnLCBjYik7CiAgfQogIHN0YXRlLmVuZGVkID0gdHJ1ZTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL19zdHJlYW1fZHVwbGV4IjoxMjEsIl9wcm9jZXNzIjo2MCwiYnVmZmVyIjo1MywiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Niwic3RyZWFtIjo3Mn1dLDEyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXJlcXVpcmUoNjcpCn0seyIvVXNlcnMvdGdyaWVzc2VyL0dpdGh1Yi9ib29rc2hlbGYvYm9va3NoZWxmL25vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9yZWFkYWJsZS1zdHJlYW0vbm9kZV9tb2R1bGVzL2NvcmUtdXRpbC1pcy9saWIvdXRpbC5qcyI6NjcsImJ1ZmZlciI6NTN9XSwxMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDU4KQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvaXNhcnJheS9pbmRleC5qcyI6NTh9XSwxMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDczKQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvc3RyaW5nX2RlY29kZXIvaW5kZXguanMiOjczLCJidWZmZXIiOjUzfV0sMTI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV9yZWFkYWJsZS5qcycpOwpleHBvcnRzLlN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpOwpleHBvcnRzLlJlYWRhYmxlID0gZXhwb3J0czsKZXhwb3J0cy5Xcml0YWJsZSA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fd3JpdGFibGUuanMnKTsKZXhwb3J0cy5EdXBsZXggPSByZXF1aXJlKCcuL2xpYi9fc3RyZWFtX2R1cGxleC5qcycpOwpleHBvcnRzLlRyYW5zZm9ybSA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fdHJhbnNmb3JtLmpzJyk7CmV4cG9ydHMuUGFzc1Rocm91Z2ggPSByZXF1aXJlKCcuL2xpYi9fc3RyZWFtX3Bhc3N0aHJvdWdoLmpzJyk7Cgp9LHsiLi9saWIvX3N0cmVhbV9kdXBsZXguanMiOjEyMSwiLi9saWIvX3N0cmVhbV9wYXNzdGhyb3VnaC5qcyI6MTIyLCIuL2xpYi9fc3RyZWFtX3JlYWRhYmxlLmpzIjoxMjMsIi4vbGliL19zdHJlYW1fdHJhbnNmb3JtLmpzIjoxMjQsIi4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiOjEyNSwic3RyZWFtIjo3Mn1dLDEzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoZ2xvYmFsKXsKLyoqCiAqIEBsaWNlbnNlCiAqIExvLURhc2ggMi40LjEgKEN1c3RvbSBCdWlsZCkgPGh0dHA6Ly9sb2Rhc2guY29tLz4KICogQnVpbGQ6IGBsb2Rhc2ggbW9kZXJuIC1vIC4vZGlzdC9sb2Rhc2guanNgCiAqIENvcHlyaWdodCAyMDEyLTIwMTMgVGhlIERvam8gRm91bmRhdGlvbiA8aHR0cDovL2Rvam9mb3VuZGF0aW9uLm9yZy8+CiAqIEJhc2VkIG9uIFVuZGVyc2NvcmUuanMgMS41LjIgPGh0dHA6Ly91bmRlcnNjb3JlanMub3JnL0xJQ0VOU0U+CiAqIENvcHlyaWdodCAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKICogQXZhaWxhYmxlIHVuZGVyIE1JVCBsaWNlbnNlIDxodHRwOi8vbG9kYXNoLmNvbS9saWNlbnNlPgogKi8KOyhmdW5jdGlvbigpIHsKCiAgLyoqIFVzZWQgYXMgYSBzYWZlIHJlZmVyZW5jZSBmb3IgYHVuZGVmaW5lZGAgaW4gcHJlIEVTNSBlbnZpcm9ubWVudHMgKi8KICB2YXIgdW5kZWZpbmVkOwoKICAvKiogVXNlZCB0byBwb29sIGFycmF5cyBhbmQgb2JqZWN0cyB1c2VkIGludGVybmFsbHkgKi8KICB2YXIgYXJyYXlQb29sID0gW10sCiAgICAgIG9iamVjdFBvb2wgPSBbXTsKCiAgLyoqIFVzZWQgdG8gZ2VuZXJhdGUgdW5pcXVlIElEcyAqLwogIHZhciBpZENvdW50ZXIgPSAwOwoKICAvKiogVXNlZCB0byBwcmVmaXgga2V5cyB0byBhdm9pZCBpc3N1ZXMgd2l0aCBgX19wcm90b19fYCBhbmQgcHJvcGVydGllcyBvbiBgT2JqZWN0LnByb3RvdHlwZWAgKi8KICB2YXIga2V5UHJlZml4ID0gK25ldyBEYXRlICsgJyc7CgogIC8qKiBVc2VkIGFzIHRoZSBzaXplIHdoZW4gb3B0aW1pemF0aW9ucyBhcmUgZW5hYmxlZCBmb3IgbGFyZ2UgYXJyYXlzICovCiAgdmFyIGxhcmdlQXJyYXlTaXplID0gNzU7CgogIC8qKiBVc2VkIGFzIHRoZSBtYXggc2l6ZSBvZiB0aGUgYGFycmF5UG9vbGAgYW5kIGBvYmplY3RQb29sYCAqLwogIHZhciBtYXhQb29sU2l6ZSA9IDQwOwoKICAvKiogVXNlZCB0byBkZXRlY3QgYW5kIHRlc3Qgd2hpdGVzcGFjZSAqLwogIHZhciB3aGl0ZXNwYWNlID0gKAogICAgLy8gd2hpdGVzcGFjZQogICAgJyBcdFx4MEJcZlx4QTBcdWZlZmYnICsKCiAgICAvLyBsaW5lIHRlcm1pbmF0b3JzCiAgICAnXG5cclx1MjAyOFx1MjAyOScgKwoKICAgIC8vIHVuaWNvZGUgY2F0ZWdvcnkgIlpzIiBzcGFjZSBzZXBhcmF0b3JzCiAgICAnXHUxNjgwXHUxODBlXHUyMDAwXHUyMDAxXHUyMDAyXHUyMDAzXHUyMDA0XHUyMDA1XHUyMDA2XHUyMDA3XHUyMDA4XHUyMDA5XHUyMDBhXHUyMDJmXHUyMDVmXHUzMDAwJwogICk7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGVtcHR5IHN0cmluZyBsaXRlcmFscyBpbiBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVFbXB0eVN0cmluZ0xlYWRpbmcgPSAvXGJfX3AgXCs9ICcnOy9nLAogICAgICByZUVtcHR5U3RyaW5nTWlkZGxlID0gL1xiKF9fcCBcKz0pICcnIFwrL2csCiAgICAgIHJlRW1wdHlTdHJpbmdUcmFpbGluZyA9IC8oX19lXCguKj9cKXxcYl9fdFwpKSBcK1xuJyc7L2c7CgogIC8qKgogICAqIFVzZWQgdG8gbWF0Y2ggRVM2IHRlbXBsYXRlIGRlbGltaXRlcnMKICAgKiBodHRwOi8vcGVvcGxlLm1vemlsbGEub3JnL35qb3JlbmRvcmZmL2VzNi1kcmFmdC5odG1sI3NlYy1saXRlcmFscy1zdHJpbmctbGl0ZXJhbHMKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoW15cXH1dKig/OlxcLlteXFx9XSopKilcfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0ZWQgbmFtZWQgZnVuY3Rpb25zICovCiAgdmFyIHJlRnVuY05hbWUgPSAvXlxzKmZ1bmN0aW9uWyBcblxyXHRdK1x3LzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggImludGVycG9sYXRlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlSW50ZXJwb2xhdGUgPSAvPCU9KFtcc1xTXSs/KSU+L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGxlYWRpbmcgd2hpdGVzcGFjZSBhbmQgemVyb3MgdG8gYmUgcmVtb3ZlZCAqLwogIHZhciByZUxlYWRpbmdTcGFjZXNBbmRaZXJvcyA9IFJlZ0V4cCgnXlsnICsgd2hpdGVzcGFjZSArICddKjArKD89LiQpJyk7CgogIC8qKiBVc2VkIHRvIGVuc3VyZSBjYXB0dXJpbmcgb3JkZXIgb2YgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZU5vTWF0Y2ggPSAvKCReKS87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBmdW5jdGlvbnMgY29udGFpbmluZyBhIGB0aGlzYCByZWZlcmVuY2UgKi8KICB2YXIgcmVUaGlzID0gL1xidGhpc1xiLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGFzc2lnbiBkZWZhdWx0IGBjb250ZXh0YCBvYmplY3QgcHJvcGVydGllcyAqLwogIHZhciBjb250ZXh0UHJvcHMgPSBbCiAgICAnQXJyYXknLCAnQm9vbGVhbicsICdEYXRlJywgJ0Z1bmN0aW9uJywgJ01hdGgnLCAnTnVtYmVyJywgJ09iamVjdCcsCiAgICAnUmVnRXhwJywgJ1N0cmluZycsICdfJywgJ2F0dGFjaEV2ZW50JywgJ2NsZWFyVGltZW91dCcsICdpc0Zpbml0ZScsICdpc05hTicsCiAgICAncGFyc2VJbnQnLCAnc2V0VGltZW91dCcKICBdOwoKICAvKiogVXNlZCB0byBtYWtlIHRlbXBsYXRlIHNvdXJjZVVSTHMgZWFzaWVyIHRvIGlkZW50aWZ5ICovCiAgdmFyIHRlbXBsYXRlQ291bnRlciA9IDA7CgogIC8qKiBgT2JqZWN0I3RvU3RyaW5nYCByZXN1bHQgc2hvcnRjdXRzICovCiAgdmFyIGFyZ3NDbGFzcyA9ICdbb2JqZWN0IEFyZ3VtZW50c10nLAogICAgICBhcnJheUNsYXNzID0gJ1tvYmplY3QgQXJyYXldJywKICAgICAgYm9vbENsYXNzID0gJ1tvYmplY3QgQm9vbGVhbl0nLAogICAgICBkYXRlQ2xhc3MgPSAnW29iamVjdCBEYXRlXScsCiAgICAgIGZ1bmNDbGFzcyA9ICdbb2JqZWN0IEZ1bmN0aW9uXScsCiAgICAgIG51bWJlckNsYXNzID0gJ1tvYmplY3QgTnVtYmVyXScsCiAgICAgIG9iamVjdENsYXNzID0gJ1tvYmplY3QgT2JqZWN0XScsCiAgICAgIHJlZ2V4cENsYXNzID0gJ1tvYmplY3QgUmVnRXhwXScsCiAgICAgIHN0cmluZ0NsYXNzID0gJ1tvYmplY3QgU3RyaW5nXSc7CgogIC8qKiBVc2VkIHRvIGlkZW50aWZ5IG9iamVjdCBjbGFzc2lmaWNhdGlvbnMgdGhhdCBgXy5jbG9uZWAgc3VwcG9ydHMgKi8KICB2YXIgY2xvbmVhYmxlQ2xhc3NlcyA9IHt9OwogIGNsb25lYWJsZUNsYXNzZXNbZnVuY0NsYXNzXSA9IGZhbHNlOwogIGNsb25lYWJsZUNsYXNzZXNbYXJnc0NsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbYXJyYXlDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbYm9vbENsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbZGF0ZUNsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tudW1iZXJDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW29iamVjdENsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tyZWdleHBDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW3N0cmluZ0NsYXNzXSA9IHRydWU7CgogIC8qKiBVc2VkIGFzIGFuIGludGVybmFsIGBfLmRlYm91bmNlYCBvcHRpb25zIG9iamVjdCAqLwogIHZhciBkZWJvdW5jZU9wdGlvbnMgPSB7CiAgICAnbGVhZGluZyc6IGZhbHNlLAogICAgJ21heFdhaXQnOiAwLAogICAgJ3RyYWlsaW5nJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCBhcyB0aGUgcHJvcGVydHkgZGVzY3JpcHRvciBmb3IgYF9fYmluZERhdGFfX2AgKi8KICB2YXIgZGVzY3JpcHRvciA9IHsKICAgICdjb25maWd1cmFibGUnOiBmYWxzZSwKICAgICdlbnVtZXJhYmxlJzogZmFsc2UsCiAgICAndmFsdWUnOiBudWxsLAogICAgJ3dyaXRhYmxlJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCB0byBkZXRlcm1pbmUgaWYgdmFsdWVzIGFyZSBvZiB0aGUgbGFuZ3VhZ2UgdHlwZSBPYmplY3QgKi8KICB2YXIgb2JqZWN0VHlwZXMgPSB7CiAgICAnYm9vbGVhbic6IGZhbHNlLAogICAgJ2Z1bmN0aW9uJzogdHJ1ZSwKICAgICdvYmplY3QnOiB0cnVlLAogICAgJ251bWJlcic6IGZhbHNlLAogICAgJ3N0cmluZyc6IGZhbHNlLAogICAgJ3VuZGVmaW5lZCc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZCBzdHJpbmcgbGl0ZXJhbHMgKi8KICB2YXIgc3RyaW5nRXNjYXBlcyA9IHsKICAgICdcXCc6ICdcXCcsCiAgICAiJyI6ICInIiwKICAgICdcbic6ICduJywKICAgICdccic6ICdyJywKICAgICdcdCc6ICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICAvKiogVXNlZCBhcyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAqLwogIHZhciByb290ID0gKG9iamVjdFR5cGVzW3R5cGVvZiB3aW5kb3ddICYmIHdpbmRvdykgfHwgdGhpczsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBleHBvcnRzYCAqLwogIHZhciBmcmVlRXhwb3J0cyA9IG9iamVjdFR5cGVzW3R5cGVvZiBleHBvcnRzXSAmJiBleHBvcnRzICYmICFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgbW9kdWxlYCAqLwogIHZhciBmcmVlTW9kdWxlID0gb2JqZWN0VHlwZXNbdHlwZW9mIG1vZHVsZV0gJiYgbW9kdWxlICYmICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwoKICAvKiogRGV0ZWN0IHRoZSBwb3B1bGFyIENvbW1vbkpTIGV4dGVuc2lvbiBgbW9kdWxlLmV4cG9ydHNgICovCiAgdmFyIG1vZHVsZUV4cG9ydHMgPSBmcmVlTW9kdWxlICYmIGZyZWVNb2R1bGUuZXhwb3J0cyA9PT0gZnJlZUV4cG9ydHMgJiYgZnJlZUV4cG9ydHM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZ2xvYmFsYCBmcm9tIE5vZGUuanMgb3IgQnJvd3NlcmlmaWVkIGNvZGUgYW5kIHVzZSBpdCBhcyBgcm9vdGAgKi8KICB2YXIgZnJlZUdsb2JhbCA9IG9iamVjdFR5cGVzW3R5cGVvZiBnbG9iYWxdICYmIGdsb2JhbDsKICBpZiAoZnJlZUdsb2JhbCAmJiAoZnJlZUdsb2JhbC5nbG9iYWwgPT09IGZyZWVHbG9iYWwgfHwgZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwpKSB7CiAgICByb290ID0gZnJlZUdsb2JhbDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pbmRleE9mYCB3aXRob3V0IHN1cHBvcnQgZm9yIGJpbmFyeSBzZWFyY2hlcwogICAqIG9yIGBmcm9tSW5kZXhgIGNvbnN0cmFpbnRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICovCiAgZnVuY3Rpb24gYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IChmcm9tSW5kZXggfHwgMCkgLSAxLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogQW4gaW1wbGVtZW50YXRpb24gb2YgYF8uY29udGFpbnNgIGZvciBjYWNoZSBvYmplY3RzIHRoYXQgbWltaWNzIHRoZSByZXR1cm4KICAgKiBzaWduYXR1cmUgb2YgYF8uaW5kZXhPZmAgYnkgcmV0dXJuaW5nIGAwYCBpZiB0aGUgdmFsdWUgaXMgZm91bmQsIGVsc2UgYC0xYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGNhY2hlIFRoZSBjYWNoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgYDBgIGlmIGB2YWx1ZWAgaXMgZm91bmQsIGVsc2UgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgIGNhY2hlID0gY2FjaGUuY2FjaGU7CgogICAgaWYgKHR5cGUgPT0gJ2Jvb2xlYW4nIHx8IHZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGNhY2hlW3ZhbHVlXSA/IDAgOiAtMTsKICAgIH0KICAgIGlmICh0eXBlICE9ICdudW1iZXInICYmIHR5cGUgIT0gJ3N0cmluZycpIHsKICAgICAgdHlwZSA9ICdvYmplY3QnOwogICAgfQogICAgdmFyIGtleSA9IHR5cGUgPT0gJ251bWJlcicgPyB2YWx1ZSA6IGtleVByZWZpeCArIHZhbHVlOwogICAgY2FjaGUgPSAoY2FjaGUgPSBjYWNoZVt0eXBlXSkgJiYgY2FjaGVba2V5XTsKCiAgICByZXR1cm4gdHlwZSA9PSAnb2JqZWN0JwogICAgICA/IChjYWNoZSAmJiBiYXNlSW5kZXhPZihjYWNoZSwgdmFsdWUpID4gLTEgPyAwIDogLTEpCiAgICAgIDogKGNhY2hlID8gMCA6IC0xKTsKICB9CgogIC8qKgogICAqIEFkZHMgYSBnaXZlbiB2YWx1ZSB0byB0aGUgY29ycmVzcG9uZGluZyBjYWNoZSBvYmplY3QuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGFkZCB0byB0aGUgY2FjaGUuCiAgICovCiAgZnVuY3Rpb24gY2FjaGVQdXNoKHZhbHVlKSB7CiAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLAogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgogICAgaWYgKHR5cGUgPT0gJ2Jvb2xlYW4nIHx8IHZhbHVlID09IG51bGwpIHsKICAgICAgY2FjaGVbdmFsdWVdID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0eXBlICE9ICdudW1iZXInICYmIHR5cGUgIT0gJ3N0cmluZycpIHsKICAgICAgICB0eXBlID0gJ29iamVjdCc7CiAgICAgIH0KICAgICAgdmFyIGtleSA9IHR5cGUgPT0gJ251bWJlcicgPyB2YWx1ZSA6IGtleVByZWZpeCArIHZhbHVlLAogICAgICAgICAgdHlwZUNhY2hlID0gY2FjaGVbdHlwZV0gfHwgKGNhY2hlW3R5cGVdID0ge30pOwoKICAgICAgaWYgKHR5cGUgPT0gJ29iamVjdCcpIHsKICAgICAgICAodHlwZUNhY2hlW2tleV0gfHwgKHR5cGVDYWNoZVtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlQ2FjaGVba2V5XSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIFVzZWQgYnkgYF8ubWF4YCBhbmQgYF8ubWluYCBhcyB0aGUgZGVmYXVsdCBjYWxsYmFjayB3aGVuIGEgZ2l2ZW4KICAgKiBjb2xsZWN0aW9uIGlzIGEgc3RyaW5nIHZhbHVlLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIGNoYXJhY3RlciB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGNvZGUgdW5pdCBvZiBnaXZlbiBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gY2hhckF0Q2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5jaGFyQ29kZUF0KDApOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgc29ydEJ5YCB0byBjb21wYXJlIHRyYW5zZm9ybWVkIGBjb2xsZWN0aW9uYCBlbGVtZW50cywgc3RhYmxlIHNvcnRpbmcKICAgKiB0aGVtIGluIGFzY2VuZGluZyBvcmRlci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBiYC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGFgLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHNvcnQgb3JkZXIgaW5kaWNhdG9yIG9mIGAxYCBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcoYSwgYikgewogICAgdmFyIGFjID0gYS5jcml0ZXJpYSwKICAgICAgICBiYyA9IGIuY3JpdGVyaWEsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhYy5sZW5ndGg7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYWNbaW5kZXhdLAogICAgICAgICAgb3RoZXIgPSBiY1tpbmRleF07CgogICAgICBpZiAodmFsdWUgIT09IG90aGVyKSB7CiAgICAgICAgaWYgKHZhbHVlID4gb3RoZXIgfHwgdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlIDwgb3RoZXIgfHwgdHlwZW9mIG90aGVyID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBGaXhlcyBhbiBgQXJyYXkjc29ydGAgYnVnIGluIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgYXBwbGljYXRpb25zCiAgICAvLyB0aGF0IGNhdXNlcyBpdCwgdW5kZXIgY2VydGFpbiBjaXJjdW1zdGFuY2VzLCB0byByZXR1cm4gdGhlIHNhbWUgdmFsdWUgZm9yCiAgICAvLyBgYWAgYW5kIGBiYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qYXNoa2VuYXMvdW5kZXJzY29yZS9wdWxsLzEyNDcKICAgIC8vCiAgICAvLyBUaGlzIGFsc28gZW5zdXJlcyBhIHN0YWJsZSBzb3J0IGluIFY4IGFuZCBvdGhlciBlbmdpbmVzLgogICAgLy8gU2VlIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTkwCiAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgY2FjaGUgb2JqZWN0IHRvIG9wdGltaXplIGxpbmVhciBzZWFyY2hlcyBvZiBsYXJnZSBhcnJheXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheT1bXV0gVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcmV0dXJucyB7bnVsbHxPYmplY3R9IFJldHVybnMgdGhlIGNhY2hlIG9iamVjdCBvciBgbnVsbGAgaWYgY2FjaGluZyBzaG91bGQgbm90IGJlIHVzZWQuCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGUoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBmaXJzdCA9IGFycmF5WzBdLAogICAgICAgIG1pZCA9IGFycmF5WyhsZW5ndGggLyAyKSB8IDBdLAogICAgICAgIGxhc3QgPSBhcnJheVtsZW5ndGggLSAxXTsKCiAgICBpZiAoZmlyc3QgJiYgdHlwZW9mIGZpcnN0ID09ICdvYmplY3QnICYmCiAgICAgICAgbWlkICYmIHR5cGVvZiBtaWQgPT0gJ29iamVjdCcgJiYgbGFzdCAmJiB0eXBlb2YgbGFzdCA9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgY2FjaGUgPSBnZXRPYmplY3QoKTsKICAgIGNhY2hlWydmYWxzZSddID0gY2FjaGVbJ251bGwnXSA9IGNhY2hlWyd0cnVlJ10gPSBjYWNoZVsndW5kZWZpbmVkJ10gPSBmYWxzZTsKCiAgICB2YXIgcmVzdWx0ID0gZ2V0T2JqZWN0KCk7CiAgICByZXN1bHQuYXJyYXkgPSBhcnJheTsKICAgIHJlc3VsdC5jYWNoZSA9IGNhY2hlOwogICAgcmVzdWx0LnB1c2ggPSBjYWNoZVB1c2g7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZAogICAqIHN0cmluZyBsaXRlcmFscy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlU3RyaW5nQ2hhcihtYXRjaCkgewogICAgcmV0dXJuICdcXCcgKyBzdHJpbmdFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIEdldHMgYW4gYXJyYXkgZnJvbSB0aGUgYXJyYXkgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge0FycmF5fSBUaGUgYXJyYXkgZnJvbSB0aGUgcG9vbC4KICAgKi8KICBmdW5jdGlvbiBnZXRBcnJheSgpIHsKICAgIHJldHVybiBhcnJheVBvb2wucG9wKCkgfHwgW107CiAgfQoKICAvKioKICAgKiBHZXRzIGFuIG9iamVjdCBmcm9tIHRoZSBvYmplY3QgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge09iamVjdH0gVGhlIG9iamVjdCBmcm9tIHRoZSBwb29sLgogICAqLwogIGZ1bmN0aW9uIGdldE9iamVjdCgpIHsKICAgIHJldHVybiBvYmplY3RQb29sLnBvcCgpIHx8IHsKICAgICAgJ2FycmF5JzogbnVsbCwKICAgICAgJ2NhY2hlJzogbnVsbCwKICAgICAgJ2NyaXRlcmlhJzogbnVsbCwKICAgICAgJ2ZhbHNlJzogZmFsc2UsCiAgICAgICdpbmRleCc6IDAsCiAgICAgICdudWxsJzogZmFsc2UsCiAgICAgICdudW1iZXInOiBudWxsLAogICAgICAnb2JqZWN0JzogbnVsbCwKICAgICAgJ3B1c2gnOiBudWxsLAogICAgICAnc3RyaW5nJzogbnVsbCwKICAgICAgJ3RydWUnOiBmYWxzZSwKICAgICAgJ3VuZGVmaW5lZCc6IGZhbHNlLAogICAgICAndmFsdWUnOiBudWxsCiAgICB9OwogIH0KCiAgLyoqCiAgICogUmVsZWFzZXMgdGhlIGdpdmVuIGFycmF5IGJhY2sgdG8gdGhlIGFycmF5IHBvb2wuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheV0gVGhlIGFycmF5IHRvIHJlbGVhc2UuCiAgICovCiAgZnVuY3Rpb24gcmVsZWFzZUFycmF5KGFycmF5KSB7CiAgICBhcnJheS5sZW5ndGggPSAwOwogICAgaWYgKGFycmF5UG9vbC5sZW5ndGggPCBtYXhQb29sU2l6ZSkgewogICAgICBhcnJheVBvb2wucHVzaChhcnJheSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBSZWxlYXNlcyB0aGUgZ2l2ZW4gb2JqZWN0IGJhY2sgdG8gdGhlIG9iamVjdCBwb29sLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byByZWxlYXNlLgogICAqLwogIGZ1bmN0aW9uIHJlbGVhc2VPYmplY3Qob2JqZWN0KSB7CiAgICB2YXIgY2FjaGUgPSBvYmplY3QuY2FjaGU7CiAgICBpZiAoY2FjaGUpIHsKICAgICAgcmVsZWFzZU9iamVjdChjYWNoZSk7CiAgICB9CiAgICBvYmplY3QuYXJyYXkgPSBvYmplY3QuY2FjaGUgPSBvYmplY3QuY3JpdGVyaWEgPSBvYmplY3Qub2JqZWN0ID0gb2JqZWN0Lm51bWJlciA9IG9iamVjdC5zdHJpbmcgPSBvYmplY3QudmFsdWUgPSBudWxsOwogICAgaWYgKG9iamVjdFBvb2wubGVuZ3RoIDwgbWF4UG9vbFNpemUpIHsKICAgICAgb2JqZWN0UG9vbC5wdXNoKG9iamVjdCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBTbGljZXMgdGhlIGBjb2xsZWN0aW9uYCBmcm9tIHRoZSBgc3RhcnRgIGluZGV4IHVwIHRvLCBidXQgbm90IGluY2x1ZGluZywKICAgKiB0aGUgYGVuZGAgaW5kZXguCiAgICoKICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgaW5zdGVhZCBvZiBgQXJyYXkjc2xpY2VgIHRvIHN1cHBvcnQgbm9kZSBsaXN0cwogICAqIGluIElFIDwgOSBhbmQgdG8gZW5zdXJlIGRlbnNlIGFycmF5cyBhcmUgcmV0dXJuZWQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBzbGljZS4KICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgVGhlIHN0YXJ0IGluZGV4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBpbmRleC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBzbGljZShhcnJheSwgc3RhcnQsIGVuZCkgewogICAgc3RhcnQgfHwgKHN0YXJ0ID0gMCk7CiAgICBpZiAodHlwZW9mIGVuZCA9PSAndW5kZWZpbmVkJykgewogICAgICBlbmQgPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICB9CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBlbmQgLSBzdGFydCB8fCAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCA8IDAgPyAwIDogbGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gYXJyYXlbc3RhcnQgKyBpbmRleF07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBgbG9kYXNoYCBmdW5jdGlvbiB1c2luZyB0aGUgZ2l2ZW4gY29udGV4dCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0PXJvb3RdIFRoZSBjb250ZXh0IG9iamVjdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIHJ1bkluQ29udGV4dChjb250ZXh0KSB7CiAgICAvLyBBdm9pZCBpc3N1ZXMgd2l0aCBzb21lIEVTMyBlbnZpcm9ubWVudHMgdGhhdCBhdHRlbXB0IHRvIHVzZSB2YWx1ZXMsIG5hbWVkCiAgICAvLyBhZnRlciBidWlsdC1pbiBjb25zdHJ1Y3RvcnMgbGlrZSBgT2JqZWN0YCwgZm9yIHRoZSBjcmVhdGlvbiBvZiBsaXRlcmFscy4KICAgIC8vIEVTNSBjbGVhcnMgdGhpcyB1cCBieSBzdGF0aW5nIHRoYXQgbGl0ZXJhbHMgbXVzdCB1c2UgYnVpbHQtaW4gY29uc3RydWN0b3JzLgogICAgLy8gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTEuMS41LgogICAgY29udGV4dCA9IGNvbnRleHQgPyBfLmRlZmF1bHRzKHJvb3QuT2JqZWN0KCksIGNvbnRleHQsIF8ucGljayhyb290LCBjb250ZXh0UHJvcHMpKSA6IHJvb3Q7CgogICAgLyoqIE5hdGl2ZSBjb25zdHJ1Y3RvciByZWZlcmVuY2VzICovCiAgICB2YXIgQXJyYXkgPSBjb250ZXh0LkFycmF5LAogICAgICAgIEJvb2xlYW4gPSBjb250ZXh0LkJvb2xlYW4sCiAgICAgICAgRGF0ZSA9IGNvbnRleHQuRGF0ZSwKICAgICAgICBGdW5jdGlvbiA9IGNvbnRleHQuRnVuY3Rpb24sCiAgICAgICAgTWF0aCA9IGNvbnRleHQuTWF0aCwKICAgICAgICBOdW1iZXIgPSBjb250ZXh0Lk51bWJlciwKICAgICAgICBPYmplY3QgPSBjb250ZXh0Lk9iamVjdCwKICAgICAgICBSZWdFeHAgPSBjb250ZXh0LlJlZ0V4cCwKICAgICAgICBTdHJpbmcgPSBjb250ZXh0LlN0cmluZywKICAgICAgICBUeXBlRXJyb3IgPSBjb250ZXh0LlR5cGVFcnJvcjsKCiAgICAvKioKICAgICAqIFVzZWQgZm9yIGBBcnJheWAgbWV0aG9kIHJlZmVyZW5jZXMuCiAgICAgKgogICAgICogTm9ybWFsbHkgYEFycmF5LnByb3RvdHlwZWAgd291bGQgc3VmZmljZSwgaG93ZXZlciwgdXNpbmcgYW4gYXJyYXkgbGl0ZXJhbAogICAgICogYXZvaWRzIGlzc3VlcyBpbiBOYXJ3aGFsLgogICAgICovCiAgICB2YXIgYXJyYXlSZWYgPSBbXTsKCiAgICAvKiogVXNlZCBmb3IgbmF0aXZlIG1ldGhvZCByZWZlcmVuY2VzICovCiAgICB2YXIgb2JqZWN0UHJvdG8gPSBPYmplY3QucHJvdG90eXBlOwoKICAgIC8qKiBVc2VkIHRvIHJlc3RvcmUgdGhlIG9yaWdpbmFsIGBfYCByZWZlcmVuY2UgaW4gYG5vQ29uZmxpY3RgICovCiAgICB2YXIgb2xkRGFzaCA9IGNvbnRleHQuXzsKCiAgICAvKiogVXNlZCB0byByZXNvbHZlIHRoZSBpbnRlcm5hbCBbW0NsYXNzXV0gb2YgdmFsdWVzICovCiAgICB2YXIgdG9TdHJpbmcgPSBvYmplY3RQcm90by50b1N0cmluZzsKCiAgICAvKiogVXNlZCB0byBkZXRlY3QgaWYgYSBtZXRob2QgaXMgbmF0aXZlICovCiAgICB2YXIgcmVOYXRpdmUgPSBSZWdFeHAoJ14nICsKICAgICAgU3RyaW5nKHRvU3RyaW5nKQogICAgICAgIC5yZXBsYWNlKC9bLiorP14ke30oKXxbXF1cXF0vZywgJ1xcJCYnKQogICAgICAgIC5yZXBsYWNlKC90b1N0cmluZ3wgZm9yIFteXF1dKy9nLCAnLio/JykgKyAnJCcKICAgICk7CgogICAgLyoqIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzICovCiAgICB2YXIgY2VpbCA9IE1hdGguY2VpbCwKICAgICAgICBjbGVhclRpbWVvdXQgPSBjb250ZXh0LmNsZWFyVGltZW91dCwKICAgICAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICAgICAgZm5Ub1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICBnZXRQcm90b3R5cGVPZiA9IGlzTmF0aXZlKGdldFByb3RvdHlwZU9mID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKSAmJiBnZXRQcm90b3R5cGVPZiwKICAgICAgICBoYXNPd25Qcm9wZXJ0eSA9IG9iamVjdFByb3RvLmhhc093blByb3BlcnR5LAogICAgICAgIHB1c2ggPSBhcnJheVJlZi5wdXNoLAogICAgICAgIHNldFRpbWVvdXQgPSBjb250ZXh0LnNldFRpbWVvdXQsCiAgICAgICAgc3BsaWNlID0gYXJyYXlSZWYuc3BsaWNlLAogICAgICAgIHVuc2hpZnQgPSBhcnJheVJlZi51bnNoaWZ0OwoKICAgIC8qKiBVc2VkIHRvIHNldCBtZXRhIGRhdGEgb24gZnVuY3Rpb25zICovCiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIElFIDggb25seSBhY2NlcHRzIERPTSBlbGVtZW50cwogICAgICB0cnkgewogICAgICAgIHZhciBvID0ge30sCiAgICAgICAgICAgIGZ1bmMgPSBpc05hdGl2ZShmdW5jID0gT2JqZWN0LmRlZmluZVByb3BlcnR5KSAmJiBmdW5jLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jKG8sIG8sIG8pICYmIGZ1bmM7CiAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9KCkpOwoKICAgIC8qIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzIGZvciBtZXRob2RzIHdpdGggdGhlIHNhbWUgbmFtZSBhcyBvdGhlciBgbG9kYXNoYCBtZXRob2RzICovCiAgICB2YXIgbmF0aXZlQ3JlYXRlID0gaXNOYXRpdmUobmF0aXZlQ3JlYXRlID0gT2JqZWN0LmNyZWF0ZSkgJiYgbmF0aXZlQ3JlYXRlLAogICAgICAgIG5hdGl2ZUlzQXJyYXkgPSBpc05hdGl2ZShuYXRpdmVJc0FycmF5ID0gQXJyYXkuaXNBcnJheSkgJiYgbmF0aXZlSXNBcnJheSwKICAgICAgICBuYXRpdmVJc0Zpbml0ZSA9IGNvbnRleHQuaXNGaW5pdGUsCiAgICAgICAgbmF0aXZlSXNOYU4gPSBjb250ZXh0LmlzTmFOLAogICAgICAgIG5hdGl2ZUtleXMgPSBpc05hdGl2ZShuYXRpdmVLZXlzID0gT2JqZWN0LmtleXMpICYmIG5hdGl2ZUtleXMsCiAgICAgICAgbmF0aXZlTWF4ID0gTWF0aC5tYXgsCiAgICAgICAgbmF0aXZlTWluID0gTWF0aC5taW4sCiAgICAgICAgbmF0aXZlUGFyc2VJbnQgPSBjb250ZXh0LnBhcnNlSW50LAogICAgICAgIG5hdGl2ZVJhbmRvbSA9IE1hdGgucmFuZG9tOwoKICAgIC8qKiBVc2VkIHRvIGxvb2t1cCBhIGJ1aWx0LWluIGNvbnN0cnVjdG9yIGJ5IFtbQ2xhc3NdXSAqLwogICAgdmFyIGN0b3JCeUNsYXNzID0ge307CiAgICBjdG9yQnlDbGFzc1thcnJheUNsYXNzXSA9IEFycmF5OwogICAgY3RvckJ5Q2xhc3NbYm9vbENsYXNzXSA9IEJvb2xlYW47CiAgICBjdG9yQnlDbGFzc1tkYXRlQ2xhc3NdID0gRGF0ZTsKICAgIGN0b3JCeUNsYXNzW2Z1bmNDbGFzc10gPSBGdW5jdGlvbjsKICAgIGN0b3JCeUNsYXNzW29iamVjdENsYXNzXSA9IE9iamVjdDsKICAgIGN0b3JCeUNsYXNzW251bWJlckNsYXNzXSA9IE51bWJlcjsKICAgIGN0b3JCeUNsYXNzW3JlZ2V4cENsYXNzXSA9IFJlZ0V4cDsKICAgIGN0b3JCeUNsYXNzW3N0cmluZ0NsYXNzXSA9IFN0cmluZzsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBgbG9kYXNoYCBvYmplY3Qgd2hpY2ggd3JhcHMgdGhlIGdpdmVuIHZhbHVlIHRvIGVuYWJsZSBpbnR1aXRpdmUKICAgICAqIG1ldGhvZCBjaGFpbmluZy4KICAgICAqCiAgICAgKiBJbiBhZGRpdGlvbiB0byBMby1EYXNoIG1ldGhvZHMsIHdyYXBwZXJzIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGBBcnJheWAgbWV0aG9kczoKICAgICAqIGBjb25jYXRgLCBgam9pbmAsIGBwb3BgLCBgcHVzaGAsIGByZXZlcnNlYCwgYHNoaWZ0YCwgYHNsaWNlYCwgYHNvcnRgLCBgc3BsaWNlYCwKICAgICAqIGFuZCBgdW5zaGlmdGAKICAgICAqCiAgICAgKiBDaGFpbmluZyBpcyBzdXBwb3J0ZWQgaW4gY3VzdG9tIGJ1aWxkcyBhcyBsb25nIGFzIHRoZSBgdmFsdWVgIG1ldGhvZCBpcwogICAgICogaW1wbGljaXRseSBvciBleHBsaWNpdGx5IGluY2x1ZGVkIGluIHRoZSBidWlsZC4KICAgICAqCiAgICAgKiBUaGUgY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgICAqIGBhZnRlcmAsIGBhc3NpZ25gLCBgYmluZGAsIGBiaW5kQWxsYCwgYGJpbmRLZXlgLCBgY2hhaW5gLCBgY29tcGFjdGAsCiAgICAgKiBgY29tcG9zZWAsIGBjb25jYXRgLCBgY291bnRCeWAsIGBjcmVhdGVgLCBgY3JlYXRlQ2FsbGJhY2tgLCBgY3VycnlgLAogICAgICogYGRlYm91bmNlYCwgYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLCBgZmlsdGVyYCwgYGZsYXR0ZW5gLAogICAgICogYGZvckVhY2hgLCBgZm9yRWFjaFJpZ2h0YCwgYGZvckluYCwgYGZvckluUmlnaHRgLCBgZm9yT3duYCwgYGZvck93blJpZ2h0YCwKICAgICAqIGBmdW5jdGlvbnNgLCBgZ3JvdXBCeWAsIGBpbmRleEJ5YCwgYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsCiAgICAgKiBgaW52b2tlYCwgYGtleXNgLCBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwgYG1lcmdlYCwgYG1pbmAsIGBvYmplY3RgLCBgb21pdGAsCiAgICAgKiBgb25jZWAsIGBwYWlyc2AsIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsIGBwaWNrYCwgYHBsdWNrYCwgYHB1bGxgLCBgcHVzaGAsCiAgICAgKiBgcmFuZ2VgLCBgcmVqZWN0YCwgYHJlbW92ZWAsIGByZXN0YCwgYHJldmVyc2VgLCBgc2h1ZmZsZWAsIGBzbGljZWAsIGBzb3J0YCwKICAgICAqIGBzb3J0QnlgLCBgc3BsaWNlYCwgYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwgYHRyYW5zZm9ybWAsCiAgICAgKiBgdW5pb25gLCBgdW5pcWAsIGB1bnNoaWZ0YCwgYHVuemlwYCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLAogICAgICogYW5kIGB6aXBgCiAgICAgKgogICAgICogVGhlIG5vbi1jaGFpbmFibGUgd3JhcHBlciBmdW5jdGlvbnMgYXJlOgogICAgICogYGNsb25lYCwgYGNsb25lRGVlcGAsIGBjb250YWluc2AsIGBlc2NhcGVgLCBgZXZlcnlgLCBgZmluZGAsIGBmaW5kSW5kZXhgLAogICAgICogYGZpbmRLZXlgLCBgZmluZExhc3RgLCBgZmluZExhc3RJbmRleGAsIGBmaW5kTGFzdEtleWAsIGBoYXNgLCBgaWRlbnRpdHlgLAogICAgICogYGluZGV4T2ZgLCBgaXNBcmd1bWVudHNgLCBgaXNBcnJheWAsIGBpc0Jvb2xlYW5gLCBgaXNEYXRlYCwgYGlzRWxlbWVudGAsCiAgICAgKiBgaXNFbXB0eWAsIGBpc0VxdWFsYCwgYGlzRmluaXRlYCwgYGlzRnVuY3Rpb25gLCBgaXNOYU5gLCBgaXNOdWxsYCwgYGlzTnVtYmVyYCwKICAgICAqIGBpc09iamVjdGAsIGBpc1BsYWluT2JqZWN0YCwgYGlzUmVnRXhwYCwgYGlzU3RyaW5nYCwgYGlzVW5kZWZpbmVkYCwgYGpvaW5gLAogICAgICogYGxhc3RJbmRleE9mYCwgYG1peGluYCwgYG5vQ29uZmxpY3RgLCBgcGFyc2VJbnRgLCBgcG9wYCwgYHJhbmRvbWAsIGByZWR1Y2VgLAogICAgICogYHJlZHVjZVJpZ2h0YCwgYHJlc3VsdGAsIGBzaGlmdGAsIGBzaXplYCwgYHNvbWVgLCBgc29ydGVkSW5kZXhgLCBgcnVuSW5Db250ZXh0YCwKICAgICAqIGB0ZW1wbGF0ZWAsIGB1bmVzY2FwZWAsIGB1bmlxdWVJZGAsIGFuZCBgdmFsdWVgCiAgICAgKgogICAgICogVGhlIHdyYXBwZXIgZnVuY3Rpb25zIGBmaXJzdGAgYW5kIGBsYXN0YCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBgbmAgaXMKICAgICAqIHByb3ZpZGVkLCBvdGhlcndpc2UgdGhleSByZXR1cm4gdW53cmFwcGVkIHZhbHVlcy4KICAgICAqCiAgICAgKiBFeHBsaWNpdCBjaGFpbmluZyBjYW4gYmUgZW5hYmxlZCBieSB1c2luZyB0aGUgYF8uY2hhaW5gIG1ldGhvZC4KICAgICAqCiAgICAgKiBAbmFtZSBfCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcCBpbiBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgd3JhcHBlZCA9IF8oWzEsIDIsIDNdKTsKICAgICAqCiAgICAgKiAvLyByZXR1cm5zIGFuIHVud3JhcHBlZCB2YWx1ZQogICAgICogd3JhcHBlZC5yZWR1Y2UoZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIC8vIHJldHVybnMgYSB3cmFwcGVkIHZhbHVlCiAgICAgKiB2YXIgc3F1YXJlcyA9IHdyYXBwZWQubWFwKGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICogbnVtOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5pc0FycmF5KHNxdWFyZXMpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoc3F1YXJlcy52YWx1ZSgpKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gbG9kYXNoKHZhbHVlKSB7CiAgICAgIC8vIGRvbid0IHdyYXAgaWYgYWxyZWFkeSB3cmFwcGVkLCBldmVuIGlmIHdyYXBwZWQgYnkgYSBkaWZmZXJlbnQgYGxvZGFzaGAgY29uc3RydWN0b3IKICAgICAgcmV0dXJuICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgIWlzQXJyYXkodmFsdWUpICYmIGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdfX3dyYXBwZWRfXycpKQogICAgICAgPyB2YWx1ZQogICAgICAgOiBuZXcgbG9kYXNoV3JhcHBlcih2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGZhc3QgcGF0aCBmb3IgY3JlYXRpbmcgYGxvZGFzaGAgd3JhcHBlciBvYmplY3RzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoYWluQWxsIEEgZmxhZyB0byBlbmFibGUgY2hhaW5pbmcgZm9yIGFsbCBtZXRob2RzCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxvZGFzaFdyYXBwZXIodmFsdWUsIGNoYWluQWxsKSB7CiAgICAgIHRoaXMuX19jaGFpbl9fID0gISFjaGFpbkFsbDsKICAgICAgdGhpcy5fX3dyYXBwZWRfXyA9IHZhbHVlOwogICAgfQogICAgLy8gZW5zdXJlIGBuZXcgbG9kYXNoV3JhcHBlcmAgaXMgYW4gaW5zdGFuY2Ugb2YgYGxvZGFzaGAKICAgIGxvZGFzaFdyYXBwZXIucHJvdG90eXBlID0gbG9kYXNoLnByb3RvdHlwZTsKCiAgICAvKioKICAgICAqIEFuIG9iamVjdCB1c2VkIHRvIGZsYWcgZW52aXJvbm1lbnRzIGZlYXR1cmVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBPYmplY3QKICAgICAqLwogICAgdmFyIHN1cHBvcnQgPSBsb2Rhc2guc3VwcG9ydCA9IHt9OwoKICAgIC8qKgogICAgICogRGV0ZWN0IGlmIGZ1bmN0aW9ucyBjYW4gYmUgZGVjb21waWxlZCBieSBgRnVuY3Rpb24jdG9TdHJpbmdgCiAgICAgKiAoYWxsIGJ1dCBQUzMgYW5kIG9sZGVyIE9wZXJhIG1vYmlsZSBicm93c2VycyAmIGF2b2lkZWQgaW4gV2luZG93cyA4IGFwcHMpLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnN1cHBvcnQKICAgICAqIEB0eXBlIGJvb2xlYW4KICAgICAqLwogICAgc3VwcG9ydC5mdW5jRGVjb21wID0gIWlzTmF0aXZlKGNvbnRleHQuV2luUlRFcnJvcikgJiYgcmVUaGlzLnRlc3QocnVuSW5Db250ZXh0KTsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBgRnVuY3Rpb24jbmFtZWAgaXMgc3VwcG9ydGVkIChhbGwgYnV0IElFKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY05hbWVzID0gdHlwZW9mIEZ1bmN0aW9uLm5hbWUgPT0gJ3N0cmluZyc7CgogICAgLyoqCiAgICAgKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgZGVsaW1pdGVycyB1c2VkIGJ5IExvLURhc2ggYXJlIHNpbWlsYXIgdG8gdGhvc2UgaW4KICAgICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAgICogZGVsaW1pdGVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2VzY2FwZSc6IC88JS0oW1xzXFNdKz8pJT4vZywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAgICovCiAgICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gaW5qZWN0LgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgc3RyaW5nCiAgICAgICAqLwogICAgICAndmFyaWFibGUnOiAnJywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAnaW1wb3J0cyc6IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICAnXyc6IGxvZGFzaAogICAgICB9CiAgICB9OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uYmluZGAgdGhhdCBjcmVhdGVzIHRoZSBib3VuZCBmdW5jdGlvbiBhbmQKICAgICAqIHNldHMgaXRzIG1ldGEgZGF0YS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYmluZERhdGEgVGhlIGJpbmQgZGF0YSBhcnJheS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlQmluZChiaW5kRGF0YSkgewogICAgICB2YXIgZnVuYyA9IGJpbmREYXRhWzBdLAogICAgICAgICAgcGFydGlhbEFyZ3MgPSBiaW5kRGF0YVsyXSwKICAgICAgICAgIHRoaXNBcmcgPSBiaW5kRGF0YVs0XTsKCiAgICAgIGZ1bmN0aW9uIGJvdW5kKCkgewogICAgICAgIC8vIGBGdW5jdGlvbiNiaW5kYCBzcGVjCiAgICAgICAgLy8gaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4zLjQuNQogICAgICAgIGlmIChwYXJ0aWFsQXJncykgewogICAgICAgICAgLy8gYXZvaWQgYGFyZ3VtZW50c2Agb2JqZWN0IGRlb3B0aW1pemF0aW9ucyBieSB1c2luZyBgc2xpY2VgIGluc3RlYWQKICAgICAgICAgIC8vIG9mIGBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbGAgYW5kIG5vdCBhc3NpZ25pbmcgYGFyZ3VtZW50c2AgdG8gYQogICAgICAgICAgLy8gdmFyaWFibGUgYXMgYSB0ZXJuYXJ5IGV4cHJlc3Npb24KICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UocGFydGlhbEFyZ3MpOwogICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICAvLyBtaW1pYyB0aGUgY29uc3RydWN0b3IncyBgcmV0dXJuYCBiZWhhdmlvcgogICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTMuMi4yCiAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgICAgLy8gZW5zdXJlIGBuZXcgYm91bmRgIGlzIGFuIGluc3RhbmNlIG9mIGBmdW5jYAogICAgICAgICAgdmFyIHRoaXNCaW5kaW5nID0gYmFzZUNyZWF0ZShmdW5jLnByb3RvdHlwZSksCiAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyB8fCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyB8fCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHNldEJpbmREYXRhKGJvdW5kLCBiaW5kRGF0YSk7CiAgICAgIHJldHVybiBib3VuZDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmNsb25lYCB3aXRob3V0IGFyZ3VtZW50IGp1Z2dsaW5nIG9yIHN1cHBvcnQKICAgICAqIGZvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2xvbmUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc0RlZXA9ZmFsc2VdIFNwZWNpZnkgYSBkZWVwIGNsb25lLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNsb25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgY2xvbmVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDbG9uZSh2YWx1ZSwgaXNEZWVwLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlKTsKICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gaW5zcGVjdCBbW0NsYXNzXV0KICAgICAgdmFyIGlzT2JqID0gaXNPYmplY3QodmFsdWUpOwogICAgICBpZiAoaXNPYmopIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgICAgaWYgKCFjbG9uZWFibGVDbGFzc2VzW2NsYXNzTmFtZV0pIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGN0b3IgPSBjdG9yQnlDbGFzc1tjbGFzc05hbWVdOwogICAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgICAgICBjYXNlIGJvb2xDbGFzczoKICAgICAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgICAgICByZXR1cm4gbmV3IGN0b3IoK3ZhbHVlKTsKCiAgICAgICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICAgICAgcmV0dXJuIG5ldyBjdG9yKHZhbHVlKTsKCiAgICAgICAgICBjYXNlIHJlZ2V4cENsYXNzOgogICAgICAgICAgICByZXN1bHQgPSBjdG9yKHZhbHVlLnNvdXJjZSwgcmVGbGFncy5leGVjKHZhbHVlKSk7CiAgICAgICAgICAgIHJlc3VsdC5sYXN0SW5kZXggPSB2YWx1ZS5sYXN0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGlzRGVlcCkgewogICAgICAgIC8vIGNoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VzIGFuZCByZXR1cm4gY29ycmVzcG9uZGluZyBjbG9uZQogICAgICAgIHZhciBpbml0ZWRTdGFjayA9ICFzdGFja0E7CiAgICAgICAgc3RhY2tBIHx8IChzdGFja0EgPSBnZXRBcnJheSgpKTsKICAgICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgICB2YXIgbGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IGlzQXJyID8gY3Rvcih2YWx1ZS5sZW5ndGgpIDoge307CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gaXNBcnIgPyBzbGljZSh2YWx1ZSkgOiBhc3NpZ24oe30sIHZhbHVlKTsKICAgICAgfQogICAgICAvLyBhZGQgYXJyYXkgcHJvcGVydGllcyBhc3NpZ25lZCBieSBgUmVnRXhwI2V4ZWNgCiAgICAgIGlmIChpc0FycikgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5kZXgnKSkgewogICAgICAgICAgcmVzdWx0LmluZGV4ID0gdmFsdWUuaW5kZXg7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5wdXQnKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWUuaW5wdXQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZm9yIHNoYWxsb3cgY2xvbmUKICAgICAgaWYgKCFpc0RlZXApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGFkZCB0aGUgc291cmNlIHZhbHVlIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgICAgc3RhY2tCLnB1c2gocmVzdWx0KTsKCiAgICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGJhc2VDbG9uZShvYmpWYWx1ZSwgaXNEZWVwLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpOwogICAgICB9KTsKCiAgICAgIGlmIChpbml0ZWRTdGFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0EpOwogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5jcmVhdGVgIHdpdGhvdXQgc3VwcG9ydCBmb3IgYXNzaWduaW5nCiAgICAgKiBwcm9wZXJ0aWVzIHRvIHRoZSBjcmVhdGVkIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHByb3RvdHlwZSBUaGUgb2JqZWN0IHRvIGluaGVyaXQgZnJvbS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDcmVhdGUocHJvdG90eXBlLCBwcm9wZXJ0aWVzKSB7CiAgICAgIHJldHVybiBpc09iamVjdChwcm90b3R5cGUpID8gbmF0aXZlQ3JlYXRlKHByb3RvdHlwZSkgOiB7fTsKICAgIH0KICAgIC8vIGZhbGxiYWNrIGZvciBicm93c2VycyB3aXRob3V0IGBPYmplY3QuY3JlYXRlYAogICAgaWYgKCFuYXRpdmVDcmVhdGUpIHsKICAgICAgYmFzZUNyZWF0ZSA9IChmdW5jdGlvbigpIHsKICAgICAgICBmdW5jdGlvbiBPYmplY3QoKSB7fQogICAgICAgIHJldHVybiBmdW5jdGlvbihwcm90b3R5cGUpIHsKICAgICAgICAgIGlmIChpc09iamVjdChwcm90b3R5cGUpKSB7CiAgICAgICAgICAgIE9iamVjdC5wcm90b3R5cGUgPSBwcm90b3R5cGU7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgT2JqZWN0OwogICAgICAgICAgICBPYmplY3QucHJvdG90eXBlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQgfHwgY29udGV4dC5PYmplY3QoKTsKICAgICAgICB9OwogICAgICB9KCkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY3JlYXRlQ2FsbGJhY2tgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY3JlYXRpbmcKICAgICAqICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2tzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IFtmdW5jPWlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcmdDb3VudF0gVGhlIG51bWJlciBvZiBhcmd1bWVudHMgdGhlIGNhbGxiYWNrIGFjY2VwdHMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KSB7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIG5vIGB0aGlzQXJnYCBvciBhbHJlYWR5IGJvdW5kIGJ5IGBGdW5jdGlvbiNiaW5kYAogICAgICBpZiAodHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgfHwgISgncHJvdG90eXBlJyBpbiBmdW5jKSkgewogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIHZhciBiaW5kRGF0YSA9IGZ1bmMuX19iaW5kRGF0YV9fOwogICAgICBpZiAodHlwZW9mIGJpbmREYXRhID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKHN1cHBvcnQuZnVuY05hbWVzKSB7CiAgICAgICAgICBiaW5kRGF0YSA9ICFmdW5jLm5hbWU7CiAgICAgICAgfQogICAgICAgIGJpbmREYXRhID0gYmluZERhdGEgfHwgIXN1cHBvcnQuZnVuY0RlY29tcDsKICAgICAgICBpZiAoIWJpbmREYXRhKSB7CiAgICAgICAgICB2YXIgc291cmNlID0gZm5Ub1N0cmluZy5jYWxsKGZ1bmMpOwogICAgICAgICAgaWYgKCFzdXBwb3J0LmZ1bmNOYW1lcykgewogICAgICAgICAgICBiaW5kRGF0YSA9ICFyZUZ1bmNOYW1lLnRlc3Qoc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZERhdGEpIHsKICAgICAgICAgICAgLy8gY2hlY2tzIGlmIGBmdW5jYCByZWZlcmVuY2VzIHRoZSBgdGhpc2Aga2V5d29yZCBhbmQgc3RvcmVzIHRoZSByZXN1bHQKICAgICAgICAgICAgYmluZERhdGEgPSByZVRoaXMudGVzdChzb3VyY2UpOwogICAgICAgICAgICBzZXRCaW5kRGF0YShmdW5jLCBiaW5kRGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgYXJlIG5vIGB0aGlzYCByZWZlcmVuY2VzIG9yIGBmdW5jYCBpcyBib3VuZAogICAgICBpZiAoYmluZERhdGEgPT09IGZhbHNlIHx8IChiaW5kRGF0YSAhPT0gdHJ1ZSAmJiBiaW5kRGF0YVsxXSAmIDEpKSB7CiAgICAgICAgcmV0dXJuIGZ1bmM7CiAgICAgIH0KICAgICAgc3dpdGNoIChhcmdDb3VudCkgewogICAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIHZhbHVlKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgYSwgYik7CiAgICAgICAgfTsKICAgICAgICBjYXNlIDM6IHJldHVybiBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgNDogcmV0dXJuIGZ1bmN0aW9uKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gYmluZChmdW5jLCB0aGlzQXJnKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBjcmVhdGVXcmFwcGVyYCB0aGF0IGNyZWF0ZXMgdGhlIHdyYXBwZXIgYW5kCiAgICAgKiBzZXRzIGl0cyBtZXRhIGRhdGEuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGJpbmREYXRhIFRoZSBiaW5kIGRhdGEgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZVdyYXBwZXIoYmluZERhdGEpIHsKICAgICAgdmFyIGZ1bmMgPSBiaW5kRGF0YVswXSwKICAgICAgICAgIGJpdG1hc2sgPSBiaW5kRGF0YVsxXSwKICAgICAgICAgIHBhcnRpYWxBcmdzID0gYmluZERhdGFbMl0sCiAgICAgICAgICBwYXJ0aWFsUmlnaHRBcmdzID0gYmluZERhdGFbM10sCiAgICAgICAgICB0aGlzQXJnID0gYmluZERhdGFbNF0sCiAgICAgICAgICBhcml0eSA9IGJpbmREYXRhWzVdOwoKICAgICAgdmFyIGlzQmluZCA9IGJpdG1hc2sgJiAxLAogICAgICAgICAgaXNCaW5kS2V5ID0gYml0bWFzayAmIDIsCiAgICAgICAgICBpc0N1cnJ5ID0gYml0bWFzayAmIDQsCiAgICAgICAgICBpc0N1cnJ5Qm91bmQgPSBiaXRtYXNrICYgOCwKICAgICAgICAgIGtleSA9IGZ1bmM7CgogICAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgICB2YXIgdGhpc0JpbmRpbmcgPSBpc0JpbmQgPyB0aGlzQXJnIDogdGhpczsKICAgICAgICBpZiAocGFydGlhbEFyZ3MpIHsKICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UocGFydGlhbEFyZ3MpOwogICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBpZiAocGFydGlhbFJpZ2h0QXJncyB8fCBpc0N1cnJ5KSB7CiAgICAgICAgICBhcmdzIHx8IChhcmdzID0gc2xpY2UoYXJndW1lbnRzKSk7CiAgICAgICAgICBpZiAocGFydGlhbFJpZ2h0QXJncykgewogICAgICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VycnkgJiYgYXJncy5sZW5ndGggPCBhcml0eSkgewogICAgICAgICAgICBiaXRtYXNrIHw9IDE2ICYgfjMyOwogICAgICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZVdyYXBwZXIoW2Z1bmMsIChpc0N1cnJ5Qm91bmQgPyBiaXRtYXNrIDogYml0bWFzayAmIH4zKSwgYXJncywgbnVsbCwgdGhpc0FyZywgYXJpdHldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXJncyB8fCAoYXJncyA9IGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGlzQmluZEtleSkgewogICAgICAgICAgZnVuYyA9IHRoaXNCaW5kaW5nW2tleV07CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgYm91bmQpIHsKICAgICAgICAgIHRoaXNCaW5kaW5nID0gYmFzZUNyZWF0ZShmdW5jLnByb3RvdHlwZSk7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgICAgICByZXR1cm4gaXNPYmplY3QocmVzdWx0KSA/IHJlc3VsdCA6IHRoaXNCaW5kaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgIH0KICAgICAgc2V0QmluZERhdGEoYm91bmQsIGJpbmREYXRhKTsKICAgICAgcmV0dXJuIGJvdW5kOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZGlmZmVyZW5jZWAgdGhhdCBhY2NlcHRzIGEgc2luZ2xlIGFycmF5CiAgICAgKiBvZiB2YWx1ZXMgdG8gZXhjbHVkZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzXSBUaGUgYXJyYXkgb2YgdmFsdWVzIHRvIGV4Y2x1ZGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZmlsdGVyZWQgdmFsdWVzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRGlmZmVyZW5jZShhcnJheSwgdmFsdWVzKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIGlzTGFyZ2UgPSBsZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYgaW5kZXhPZiA9PT0gYmFzZUluZGV4T2YsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGNhY2hlID0gY3JlYXRlQ2FjaGUodmFsdWVzKTsKICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgIGluZGV4T2YgPSBjYWNoZUluZGV4T2Y7CiAgICAgICAgICB2YWx1ZXMgPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAoaW5kZXhPZih2YWx1ZXMsIHZhbHVlKSA8IDApIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICByZWxlYXNlT2JqZWN0KHZhbHVlcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmZsYXR0ZW5gIHdpdGhvdXQgc3VwcG9ydCBmb3IgY2FsbGJhY2sKICAgICAqIHNob3J0aGFuZHMgb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmbGF0dGVuLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTaGFsbG93PWZhbHNlXSBBIGZsYWcgdG8gcmVzdHJpY3QgZmxhdHRlbmluZyB0byBhIHNpbmdsZSBsZXZlbC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzU3RyaWN0PWZhbHNlXSBBIGZsYWcgdG8gcmVzdHJpY3QgZmxhdHRlbmluZyB0byBhcnJheXMgYW5kIGBhcmd1bWVudHNgIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc3RhcnQgZnJvbS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VGbGF0dGVuKGFycmF5LCBpc1NoYWxsb3csIGlzU3RyaWN0LCBmcm9tSW5kZXgpIHsKICAgICAgdmFyIGluZGV4ID0gKGZyb21JbmRleCB8fCAwKSAtIDEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicKICAgICAgICAgICAgJiYgKGlzQXJyYXkodmFsdWUpIHx8IGlzQXJndW1lbnRzKHZhbHVlKSkpIHsKICAgICAgICAgIC8vIHJlY3Vyc2l2ZWx5IGZsYXR0ZW4gYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgIGlmICghaXNTaGFsbG93KSB7CiAgICAgICAgICAgIHZhbHVlID0gYmFzZUZsYXR0ZW4odmFsdWUsIGlzU2hhbGxvdywgaXNTdHJpY3QpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbEluZGV4ID0gLTEsCiAgICAgICAgICAgICAgdmFsTGVuZ3RoID0gdmFsdWUubGVuZ3RoLAogICAgICAgICAgICAgIHJlc0luZGV4ID0gcmVzdWx0Lmxlbmd0aDsKCiAgICAgICAgICByZXN1bHQubGVuZ3RoICs9IHZhbExlbmd0aDsKICAgICAgICAgIHdoaWxlICgrK3ZhbEluZGV4IDwgdmFsTGVuZ3RoKSB7CiAgICAgICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IHZhbHVlW3ZhbEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFpc1N0cmljdCkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNFcXVhbGAsIHdpdGhvdXQgc3VwcG9ydCBmb3IgYHRoaXNBcmdgIGJpbmRpbmcsCiAgICAgKiB0aGF0IGFsbG93cyBwYXJ0aWFsICJfLndoZXJlIiBzdHlsZSBjb21wYXJpc29ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXNXaGVyZT1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHBlcmZvcm1pbmcgcGFydGlhbCBjb21wYXJpc29ucy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0E9W11dIFRyYWNrcyB0cmF2ZXJzZWQgYGFgIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc3RhY2tCPVtdXSBUcmFja3MgdHJhdmVyc2VkIGBiYCBvYmplY3RzLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzRXF1YWwoYSwgYiwgY2FsbGJhY2ssIGlzV2hlcmUsIHN0YWNrQSwgc3RhY2tCKSB7CiAgICAgIC8vIHVzZWQgdG8gaW5kaWNhdGUgdGhhdCB3aGVuIGNvbXBhcmluZyBvYmplY3RzLCBgYWAgaGFzIGF0IGxlYXN0IHRoZSBwcm9wZXJ0aWVzIG9mIGBiYAogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2soYSwgYik7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZXhpdCBlYXJseSBmb3IgaWRlbnRpY2FsIHZhbHVlcwogICAgICBpZiAoYSA9PT0gYikgewogICAgICAgIC8vIHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgICAgcmV0dXJuIGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKTsKICAgICAgfQogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBhLAogICAgICAgICAgb3RoZXJUeXBlID0gdHlwZW9mIGI7CgogICAgICAvLyBleGl0IGVhcmx5IGZvciB1bmxpa2UgcHJpbWl0aXZlIHZhbHVlcwogICAgICBpZiAoYSA9PT0gYSAmJgogICAgICAgICAgIShhICYmIG9iamVjdFR5cGVzW3R5cGVdKSAmJgogICAgICAgICAgIShiICYmIG9iamVjdFR5cGVzW290aGVyVHlwZV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIGBudWxsYCBhbmQgYHVuZGVmaW5lZGAgYXZvaWRpbmcgRVMzJ3MgRnVuY3Rpb24jY2FsbCBiZWhhdmlvcgogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjMuNC40CiAgICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgIH0KICAgICAgLy8gY29tcGFyZSBbW0NsYXNzXV0gbmFtZXMKICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSksCiAgICAgICAgICBvdGhlckNsYXNzID0gdG9TdHJpbmcuY2FsbChiKTsKCiAgICAgIGlmIChjbGFzc05hbWUgPT0gYXJnc0NsYXNzKSB7CiAgICAgICAgY2xhc3NOYW1lID0gb2JqZWN0Q2xhc3M7CiAgICAgIH0KICAgICAgaWYgKG90aGVyQ2xhc3MgPT0gYXJnc0NsYXNzKSB7CiAgICAgICAgb3RoZXJDbGFzcyA9IG9iamVjdENsYXNzOwogICAgICB9CiAgICAgIGlmIChjbGFzc05hbWUgIT0gb3RoZXJDbGFzcykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgICAgLy8gY29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1iZXJzLCBkYXRlcyB0byBtaWxsaXNlY29uZHMgYW5kIGJvb2xlYW5zCiAgICAgICAgICAvLyB0byBgMWAgb3IgYDBgIHRyZWF0aW5nIGludmFsaWQgZGF0ZXMgY29lcmNlZCB0byBgTmFOYCBhcyBub3QgZXF1YWwKICAgICAgICAgIHJldHVybiArYSA9PSArYjsKCiAgICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAgIC8vIHRyZWF0IGBOYU5gIHZzLiBgTmFOYCBhcyBlcXVhbAogICAgICAgICAgcmV0dXJuIChhICE9ICthKQogICAgICAgICAgICA/IGIgIT0gK2IKICAgICAgICAgICAgLy8gYnV0IHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDogKGEgPT0gMCA/ICgxIC8gYSA9PSAxIC8gYikgOiBhID09ICtiKTsKCiAgICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICBjYXNlIHN0cmluZ0NsYXNzOgogICAgICAgICAgLy8gY29lcmNlIHJlZ2V4ZXMgdG8gc3RyaW5ncyAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMC42LjQpCiAgICAgICAgICAvLyB0cmVhdCBzdHJpbmcgcHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3QgaW5zdGFuY2VzIGFzIGVxdWFsCiAgICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gY2xhc3NOYW1lID09IGFycmF5Q2xhc3M7CiAgICAgIGlmICghaXNBcnIpIHsKICAgICAgICAvLyB1bndyYXAgYW55IGBsb2Rhc2hgIHdyYXBwZWQgdmFsdWVzCiAgICAgICAgdmFyIGFXcmFwcGVkID0gaGFzT3duUHJvcGVydHkuY2FsbChhLCAnX193cmFwcGVkX18nKSwKICAgICAgICAgICAgYldyYXBwZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsICdfX3dyYXBwZWRfXycpOwoKICAgICAgICBpZiAoYVdyYXBwZWQgfHwgYldyYXBwZWQpIHsKICAgICAgICAgIHJldHVybiBiYXNlSXNFcXVhbChhV3JhcHBlZCA/IGEuX193cmFwcGVkX18gOiBhLCBiV3JhcHBlZCA/IGIuX193cmFwcGVkX18gOiBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpOwogICAgICAgIH0KICAgICAgICAvLyBleGl0IGZvciBmdW5jdGlvbnMgYW5kIERPTSBub2RlcwogICAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICAgIHZhciBjdG9yQSA9IGEuY29uc3RydWN0b3IsCiAgICAgICAgICAgIGN0b3JCID0gYi5jb25zdHJ1Y3RvcjsKCiAgICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYKICAgICAgICAgICAgICAhKGlzRnVuY3Rpb24oY3RvckEpICYmIGN0b3JBIGluc3RhbmNlb2YgY3RvckEgJiYgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQikgJiYKICAgICAgICAgICAgICAoJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYikKICAgICAgICAgICAgKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGFzc3VtZSBjeWNsaWMgc3RydWN0dXJlcyBhcmUgZXF1YWwKICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMi4zKQogICAgICB2YXIgaW5pdGVkU3RhY2sgPSAhc3RhY2tBOwogICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHNpemUgPSAwOwogICAgICByZXN1bHQgPSB0cnVlOwoKICAgICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICBzdGFja0EucHVzaChhKTsKICAgICAgc3RhY2tCLnB1c2goYik7CgogICAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycikgewogICAgICAgIC8vIGNvbXBhcmUgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5CiAgICAgICAgbGVuZ3RoID0gYS5sZW5ndGg7CiAgICAgICAgc2l6ZSA9IGIubGVuZ3RoOwogICAgICAgIHJlc3VsdCA9IHNpemUgPT0gbGVuZ3RoOwoKICAgICAgICBpZiAocmVzdWx0IHx8IGlzV2hlcmUpIHsKICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMKICAgICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoLAogICAgICAgICAgICAgICAgdmFsdWUgPSBiW3NpemVdOwoKICAgICAgICAgICAgaWYgKGlzV2hlcmUpIHsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgICAgICAgaWYgKChyZXN1bHQgPSBiYXNlSXNFcXVhbChhW2luZGV4XSwgdmFsdWUsIGNhbGxiYWNrLCBpc1doZXJlLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghKHJlc3VsdCA9IGJhc2VJc0VxdWFsKGFbc2l6ZV0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIC8vIGRlZXAgY29tcGFyZSBvYmplY3RzIHVzaW5nIGBmb3JJbmAsIGluc3RlYWQgb2YgYGZvck93bmAsIHRvIGF2b2lkIGBPYmplY3Qua2V5c2AKICAgICAgICAvLyB3aGljaCwgaW4gdGhpcyBjYXNlLCBpcyBtb3JlIGNvc3RseQogICAgICAgIGZvckluKGIsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGIpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkpIHsKICAgICAgICAgICAgLy8gY291bnQgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSBlYWNoIHByb3BlcnR5IHZhbHVlLgogICAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYSwga2V5KSAmJiBiYXNlSXNFcXVhbChhW2tleV0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKHJlc3VsdCAmJiAhaXNXaGVyZSkgewogICAgICAgICAgLy8gZW5zdXJlIGJvdGggb2JqZWN0cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzCiAgICAgICAgICBmb3JJbihhLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBhKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkpIHsKICAgICAgICAgICAgICAvLyBgc2l6ZWAgd2lsbCBiZSBgLTFgIGlmIGBhYCBoYXMgbW9yZSBwcm9wZXJ0aWVzIHRoYW4gYGJgCiAgICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBzdGFja0EucG9wKCk7CiAgICAgIHN0YWNrQi5wb3AoKTsKCiAgICAgIGlmIChpbml0ZWRTdGFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0EpOwogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5tZXJnZWAgd2l0aG91dCBhcmd1bWVudCBqdWdnbGluZyBvciBzdXBwb3J0CiAgICAgKiBmb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgbWVyZ2luZyBwcm9wZXJ0aWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgdmFsdWVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZU1lcmdlKG9iamVjdCwgc291cmNlLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgKGlzQXJyYXkoc291cmNlKSA/IGZvckVhY2ggOiBmb3JPd24pKHNvdXJjZSwgZnVuY3Rpb24oc291cmNlLCBrZXkpIHsKICAgICAgICB2YXIgZm91bmQsCiAgICAgICAgICAgIGlzQXJyLAogICAgICAgICAgICByZXN1bHQgPSBzb3VyY2UsCiAgICAgICAgICAgIHZhbHVlID0gb2JqZWN0W2tleV07CgogICAgICAgIGlmIChzb3VyY2UgJiYgKChpc0FyciA9IGlzQXJyYXkoc291cmNlKSkgfHwgaXNQbGFpbk9iamVjdChzb3VyY2UpKSkgewogICAgICAgICAgLy8gYXZvaWQgbWVyZ2luZyBwcmV2aW91c2x5IG1lcmdlZCBjeWNsaWMgc291cmNlcwogICAgICAgICAgdmFyIHN0YWNrTGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdGFja0xlbmd0aC0tKSB7CiAgICAgICAgICAgIGlmICgoZm91bmQgPSBzdGFja0Fbc3RhY2tMZW5ndGhdID09IHNvdXJjZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IHN0YWNrQltzdGFja0xlbmd0aF07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgdmFyIGlzU2hhbGxvdzsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2sodmFsdWUsIHNvdXJjZSk7CiAgICAgICAgICAgICAgaWYgKChpc1NoYWxsb3cgPSB0eXBlb2YgcmVzdWx0ICE9ICd1bmRlZmluZWQnKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNTaGFsbG93KSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBpc0FycgogICAgICAgICAgICAgICAgPyAoaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IFtdKQogICAgICAgICAgICAgICAgOiAoaXNQbGFpbk9iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IHt9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhZGQgYHNvdXJjZWAgYW5kIGFzc29jaWF0ZWQgYHZhbHVlYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgICAgICAgICAgc3RhY2tBLnB1c2goc291cmNlKTsKICAgICAgICAgICAgc3RhY2tCLnB1c2godmFsdWUpOwoKICAgICAgICAgICAgLy8gcmVjdXJzaXZlbHkgbWVyZ2Ugb2JqZWN0cyBhbmQgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgICBiYXNlTWVyZ2UodmFsdWUsIHNvdXJjZSwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBzb3VyY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJhbmRvbWAgd2l0aG91dCBhcmd1bWVudCBqdWdnbGluZyBvciBzdXBwb3J0CiAgICAgKiBmb3IgcmV0dXJuaW5nIGZsb2F0aW5nLXBvaW50IG51bWJlcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gVGhlIG1pbmltdW0gcG9zc2libGUgdmFsdWUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyBhIHJhbmRvbSBudW1iZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VSYW5kb20obWluLCBtYXgpIHsKICAgICAgcmV0dXJuIG1pbiArIGZsb29yKG5hdGl2ZVJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnVuaXFgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICogb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTb3J0ZWQ9ZmFsc2VdIEEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGBhcnJheWAgaXMgc29ydGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVVuaXEoYXJyYXksIGlzU29ydGVkLCBjYWxsYmFjaykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIHZhciBpc0xhcmdlID0gIWlzU29ydGVkICYmIGxlbmd0aCA+PSBsYXJnZUFycmF5U2l6ZSAmJiBpbmRleE9mID09PSBiYXNlSW5kZXhPZiwKICAgICAgICAgIHNlZW4gPSAoY2FsbGJhY2sgfHwgaXNMYXJnZSkgPyBnZXRBcnJheSgpIDogcmVzdWx0OwoKICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICB2YXIgY2FjaGUgPSBjcmVhdGVDYWNoZShzZWVuKTsKICAgICAgICBpbmRleE9mID0gY2FjaGVJbmRleE9mOwogICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XSwKICAgICAgICAgICAgY29tcHV0ZWQgPSBjYWxsYmFjayA/IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgYXJyYXkpIDogdmFsdWU7CgogICAgICAgIGlmIChpc1NvcnRlZAogICAgICAgICAgICAgID8gIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gY29tcHV0ZWQKICAgICAgICAgICAgICA6IGluZGV4T2Yoc2VlbiwgY29tcHV0ZWQpIDwgMAogICAgICAgICAgICApIHsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBpc0xhcmdlKSB7CiAgICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgcmVsZWFzZUFycmF5KHNlZW4uYXJyYXkpOwogICAgICAgIHJlbGVhc2VPYmplY3Qoc2Vlbik7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICByZWxlYXNlQXJyYXkoc2Vlbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYSBjb2xsZWN0aW9uLCBjcmVhdGluZyBhbiBvYmplY3QgY29tcG9zZWQKICAgICAqIG9mIGtleXMgZ2VuZXJhdGVkIGZyb20gdGhlIHJlc3VsdHMgb2YgcnVubmluZyBlYWNoIGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24KICAgICAqIHRocm91Z2ggYSBjYWxsYmFjay4gVGhlIGdpdmVuIGBzZXR0ZXJgIGZ1bmN0aW9uIHNldHMgdGhlIGtleXMgYW5kIHZhbHVlcwogICAgICogb2YgdGhlIGNvbXBvc2VkIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gc2V0dGVyIFRoZSBzZXR0ZXIgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBhZ2dyZWdhdG9yIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVBZ2dyZWdhdG9yKHNldHRlcikgewogICAgICByZXR1cm4gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgICBzZXR0ZXIocmVzdWx0LCB2YWx1ZSwgY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSwgY29sbGVjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIHNldHRlcihyZXN1bHQsIHZhbHVlLCBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSwgY29sbGVjdGlvbik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgZWl0aGVyIGN1cnJpZXMgb3IgaW52b2tlcyBgZnVuY2AKICAgICAqIHdpdGggYW4gb3B0aW9uYWwgYHRoaXNgIGJpbmRpbmcgYW5kIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGZ1bmMgVGhlIGZ1bmN0aW9uIG9yIG1ldGhvZCBuYW1lIHRvIHJlZmVyZW5jZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIG9mIG1ldGhvZCBmbGFncyB0byBjb21wb3NlLgogICAgICogIFRoZSBiaXRtYXNrIG1heSBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGZsYWdzOgogICAgICogIDEgLSBgXy5iaW5kYAogICAgICogIDIgLSBgXy5iaW5kS2V5YAogICAgICogIDQgLSBgXy5jdXJyeWAKICAgICAqICA4IC0gYF8uY3VycnlgIChib3VuZCkKICAgICAqICAxNiAtIGBfLnBhcnRpYWxgCiAgICAgKiAgMzIgLSBgXy5wYXJ0aWFsUmlnaHRgCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcGFydGlhbEFyZ3NdIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwcmVwZW5kIHRvIHRob3NlCiAgICAgKiAgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwYXJ0aWFsUmlnaHRBcmdzXSBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gYXBwZW5kIHRvIHRob3NlCiAgICAgKiAgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyaXR5XSBUaGUgYXJpdHkgb2YgYGZ1bmNgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVdyYXBwZXIoZnVuYywgYml0bWFzaywgcGFydGlhbEFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MsIHRoaXNBcmcsIGFyaXR5KSB7CiAgICAgIHZhciBpc0JpbmQgPSBiaXRtYXNrICYgMSwKICAgICAgICAgIGlzQmluZEtleSA9IGJpdG1hc2sgJiAyLAogICAgICAgICAgaXNDdXJyeSA9IGJpdG1hc2sgJiA0LAogICAgICAgICAgaXNDdXJyeUJvdW5kID0gYml0bWFzayAmIDgsCiAgICAgICAgICBpc1BhcnRpYWwgPSBiaXRtYXNrICYgMTYsCiAgICAgICAgICBpc1BhcnRpYWxSaWdodCA9IGJpdG1hc2sgJiAzMjsKCiAgICAgIGlmICghaXNCaW5kS2V5ICYmICFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICBpZiAoaXNQYXJ0aWFsICYmICFwYXJ0aWFsQXJncy5sZW5ndGgpIHsKICAgICAgICBiaXRtYXNrICY9IH4xNjsKICAgICAgICBpc1BhcnRpYWwgPSBwYXJ0aWFsQXJncyA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChpc1BhcnRpYWxSaWdodCAmJiAhcGFydGlhbFJpZ2h0QXJncy5sZW5ndGgpIHsKICAgICAgICBiaXRtYXNrICY9IH4zMjsKICAgICAgICBpc1BhcnRpYWxSaWdodCA9IHBhcnRpYWxSaWdodEFyZ3MgPSBmYWxzZTsKICAgICAgfQogICAgICB2YXIgYmluZERhdGEgPSBmdW5jICYmIGZ1bmMuX19iaW5kRGF0YV9fOwogICAgICBpZiAoYmluZERhdGEgJiYgYmluZERhdGEgIT09IHRydWUpIHsKICAgICAgICAvLyBjbG9uZSBgYmluZERhdGFgCiAgICAgICAgYmluZERhdGEgPSBzbGljZShiaW5kRGF0YSk7CiAgICAgICAgaWYgKGJpbmREYXRhWzJdKSB7CiAgICAgICAgICBiaW5kRGF0YVsyXSA9IHNsaWNlKGJpbmREYXRhWzJdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGJpbmREYXRhWzNdKSB7CiAgICAgICAgICBiaW5kRGF0YVszXSA9IHNsaWNlKGJpbmREYXRhWzNdKTsKICAgICAgICB9CiAgICAgICAgLy8gc2V0IGB0aGlzQmluZGluZ2AgaXMgbm90IHByZXZpb3VzbHkgYm91bmQKICAgICAgICBpZiAoaXNCaW5kICYmICEoYmluZERhdGFbMV0gJiAxKSkgewogICAgICAgICAgYmluZERhdGFbNF0gPSB0aGlzQXJnOwogICAgICAgIH0KICAgICAgICAvLyBzZXQgaWYgcHJldmlvdXNseSBib3VuZCBidXQgbm90IGN1cnJlbnRseSAoc3Vic2VxdWVudCBjdXJyaWVkIGZ1bmN0aW9ucykKICAgICAgICBpZiAoIWlzQmluZCAmJiBiaW5kRGF0YVsxXSAmIDEpIHsKICAgICAgICAgIGJpdG1hc2sgfD0gODsKICAgICAgICB9CiAgICAgICAgLy8gc2V0IGN1cnJpZWQgYXJpdHkgaWYgbm90IHlldCBzZXQKICAgICAgICBpZiAoaXNDdXJyeSAmJiAhKGJpbmREYXRhWzFdICYgNCkpIHsKICAgICAgICAgIGJpbmREYXRhWzVdID0gYXJpdHk7CiAgICAgICAgfQogICAgICAgIC8vIGFwcGVuZCBwYXJ0aWFsIGxlZnQgYXJndW1lbnRzCiAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgcHVzaC5hcHBseShiaW5kRGF0YVsyXSB8fCAoYmluZERhdGFbMl0gPSBbXSksIHBhcnRpYWxBcmdzKTsKICAgICAgICB9CiAgICAgICAgLy8gYXBwZW5kIHBhcnRpYWwgcmlnaHQgYXJndW1lbnRzCiAgICAgICAgaWYgKGlzUGFydGlhbFJpZ2h0KSB7CiAgICAgICAgICB1bnNoaWZ0LmFwcGx5KGJpbmREYXRhWzNdIHx8IChiaW5kRGF0YVszXSA9IFtdKSwgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgfQogICAgICAgIC8vIG1lcmdlIGZsYWdzCiAgICAgICAgYmluZERhdGFbMV0gfD0gYml0bWFzazsKICAgICAgICByZXR1cm4gY3JlYXRlV3JhcHBlci5hcHBseShudWxsLCBiaW5kRGF0YSk7CiAgICAgIH0KICAgICAgLy8gZmFzdCBwYXRoIGZvciBgXy5iaW5kYAogICAgICB2YXIgY3JlYXRlciA9IChiaXRtYXNrID09IDEgfHwgYml0bWFzayA9PT0gMTcpID8gYmFzZUJpbmQgOiBiYXNlQ3JlYXRlV3JhcHBlcjsKICAgICAgcmV0dXJuIGNyZWF0ZXIoW2Z1bmMsIGJpdG1hc2ssIHBhcnRpYWxBcmdzLCBwYXJ0aWFsUmlnaHRBcmdzLCB0aGlzQXJnLCBhcml0eV0pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGFwcHJvcHJpYXRlICJpbmRleE9mIiBmdW5jdGlvbi4gSWYgdGhlIGBfLmluZGV4T2ZgIG1ldGhvZCBpcwogICAgICogY3VzdG9taXplZCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgY3VzdG9tIG1ldGhvZCwgb3RoZXJ3aXNlIGl0IHJldHVybnMKICAgICAqIHRoZSBgYmFzZUluZGV4T2ZgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlICJpbmRleE9mIiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SW5kZXhPZigpIHsKICAgICAgdmFyIHJlc3VsdCA9IChyZXN1bHQgPSBsb2Rhc2guaW5kZXhPZikgPT09IGluZGV4T2YgPyBiYXNlSW5kZXhPZiA6IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgbmF0aXZlIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIG5hdGl2ZSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc05hdGl2ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicgJiYgcmVOYXRpdmUudGVzdCh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIGB0aGlzYCBiaW5kaW5nIGRhdGEgb24gYSBnaXZlbiBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gc2V0IGRhdGEgb24uCiAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZSBUaGUgZGF0YSBhcnJheSB0byBzZXQuCiAgICAgKi8KICAgIHZhciBzZXRCaW5kRGF0YSA9ICFkZWZpbmVQcm9wZXJ0eSA/IG5vb3AgOiBmdW5jdGlvbihmdW5jLCB2YWx1ZSkgewogICAgICBkZXNjcmlwdG9yLnZhbHVlID0gdmFsdWU7CiAgICAgIGRlZmluZVByb3BlcnR5KGZ1bmMsICdfX2JpbmREYXRhX18nLCBkZXNjcmlwdG9yKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBpc1BsYWluT2JqZWN0YCB3aGljaCBjaGVja3MgaWYgYSBnaXZlbiB2YWx1ZQogICAgICogaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLCBhc3N1bWluZyBvYmplY3RzIGNyZWF0ZWQKICAgICAqIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3RvciBoYXZlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYW5kIHRoYXQKICAgICAqIHRoZXJlIGFyZSBubyBgT2JqZWN0LnByb3RvdHlwZWAgZXh0ZW5zaW9ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSkgewogICAgICB2YXIgY3RvciwKICAgICAgICAgIHJlc3VsdDsKCiAgICAgIC8vIGF2b2lkIG5vbiBPYmplY3Qgb2JqZWN0cywgYGFyZ3VtZW50c2Agb2JqZWN0cywgYW5kIERPTSBlbGVtZW50cwogICAgICBpZiAoISh2YWx1ZSAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBvYmplY3RDbGFzcykgfHwKICAgICAgICAgIChjdG9yID0gdmFsdWUuY29uc3RydWN0b3IsIGlzRnVuY3Rpb24oY3RvcikgJiYgIShjdG9yIGluc3RhbmNlb2YgY3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIEluIG1vc3QgZW52aXJvbm1lbnRzIGFuIG9iamVjdCdzIG93biBwcm9wZXJ0aWVzIGFyZSBpdGVyYXRlZCBiZWZvcmUKICAgICAgLy8gaXRzIGluaGVyaXRlZCBwcm9wZXJ0aWVzLiBJZiB0aGUgbGFzdCBpdGVyYXRlZCBwcm9wZXJ0eSBpcyBhbiBvYmplY3QncwogICAgICAvLyBvd24gcHJvcGVydHkgdGhlbiB0aGVyZSBhcmUgbm8gaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAgZm9ySW4odmFsdWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHQgPSBrZXk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdHlwZW9mIHJlc3VsdCA9PSAndW5kZWZpbmVkJyB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCByZXN1bHQpOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgdW5lc2NhcGVgIHRvIGNvbnZlcnQgSFRNTCBlbnRpdGllcyB0byBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIHVuZXNjYXBlLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gdW5lc2NhcGVIdG1sQ2hhcihtYXRjaCkgewogICAgICByZXR1cm4gaHRtbFVuZXNjYXBlc1ttYXRjaF07CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpOyB9KSgxLCAyLCAzKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzQXJndW1lbnRzKFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicgJiYKICAgICAgICB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcmdzQ2xhc3MgfHwgZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJyYXkoYXJndW1lbnRzKTsgfSkoKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0FycmF5KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIHZhciBpc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicgJiYKICAgICAgICB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcnJheUNsYXNzIHx8IGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgZmFsbGJhY2sgaW1wbGVtZW50YXRpb24gb2YgYE9iamVjdC5rZXlzYCB3aGljaCBwcm9kdWNlcyBhbiBhcnJheSBvZiB0aGUKICAgICAqIGdpdmVuIG9iamVjdCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKi8KICAgIHZhciBzaGltS2V5cyA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBbXTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgaWYgKCEob2JqZWN0VHlwZXNbdHlwZW9mIG9iamVjdF0pKSByZXR1cm4gcmVzdWx0OwogICAgICAgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCkpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzIG9mIGFuIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmtleXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICAgKiAvLyA9PiBbJ29uZScsICd0d28nLCAndGhyZWUnXSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgdmFyIGtleXMgPSAhbmF0aXZlS2V5cyA/IHNoaW1LZXlzIDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICByZXR1cm4gbmF0aXZlS2V5cyhvYmplY3QpOwogICAgfTsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gY29udmVydCBjaGFyYWN0ZXJzIHRvIEhUTUwgZW50aXRpZXM6CiAgICAgKgogICAgICogVGhvdWdoIHRoZSBgPmAgY2hhcmFjdGVyIGlzIGVzY2FwZWQgZm9yIHN5bW1ldHJ5LCBjaGFyYWN0ZXJzIGxpa2UgYD5gIGFuZCBgL2AKICAgICAqIGRvbid0IHJlcXVpcmUgZXNjYXBpbmcgaW4gSFRNTCBhbmQgaGF2ZSBubyBzcGVjaWFsIG1lYW5pbmcgdW5sZXNzIHRoZXkncmUgcGFydAogICAgICogb2YgYSB0YWcgb3IgYW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlLgogICAgICogaHR0cDovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvYW1iaWd1b3VzLWFtcGVyc2FuZHMgKHVuZGVyICJzZW1pLXJlbGF0ZWQgZnVuIGZhY3QiKQogICAgICovCiAgICB2YXIgaHRtbEVzY2FwZXMgPSB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmIzM5OycKICAgIH07CgogICAgLyoqIFVzZWQgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMgKi8KICAgIHZhciBodG1sVW5lc2NhcGVzID0gaW52ZXJ0KGh0bWxFc2NhcGVzKTsKCiAgICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGVudGl0aWVzIGFuZCBIVE1MIGNoYXJhY3RlcnMgKi8KICAgIHZhciByZUVzY2FwZWRIdG1sID0gUmVnRXhwKCcoJyArIGtleXMoaHRtbFVuZXNjYXBlcykuam9pbignfCcpICsgJyknLCAnZycpLAogICAgICAgIHJlVW5lc2NhcGVkSHRtbCA9IFJlZ0V4cCgnWycgKyBrZXlzKGh0bWxFc2NhcGVzKS5qb2luKCcnKSArICddJywgJ2cnKTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIEFzc2lnbnMgb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBvZiBzb3VyY2Ugb2JqZWN0KHMpIHRvIHRoZSBkZXN0aW5hdGlvbgogICAgICogb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMgd2lsbCBvdmVyd3JpdGUgcHJvcGVydHkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMKICAgICAqIHNvdXJjZXMuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCB0byBwcm9kdWNlIHRoZQogICAgICogYXNzaWduZWQgdmFsdWVzLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdHdvCiAgICAgKiBhcmd1bWVudHM7IChvYmplY3RWYWx1ZSwgc291cmNlVmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGFsaWFzIGV4dGVuZAogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgYXNzaWduaW5nIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmFzc2lnbih7ICduYW1lJzogJ2ZyZWQnIH0sIHsgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnZnJlZCcsICdlbXBsb3llcic6ICdzbGF0ZScgfQogICAgICoKICAgICAqIHZhciBkZWZhdWx0cyA9IF8ucGFydGlhbFJpZ2h0KF8uYXNzaWduLCBmdW5jdGlvbihhLCBiKSB7CiAgICAgKiAgIHJldHVybiB0eXBlb2YgYSA9PSAndW5kZWZpbmVkJyA/IGIgOiBhOwogICAgICogfSk7CiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ25hbWUnOiAnYmFybmV5JyB9OwogICAgICogZGVmYXVsdHMob2JqZWN0LCB7ICduYW1lJzogJ2ZyZWQnLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdiYXJuZXknLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0KICAgICAqLwogICAgdmFyIGFzc2lnbiA9IGZ1bmN0aW9uKG9iamVjdCwgc291cmNlLCBndWFyZCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmdzLmxlbmd0aDsKICAgICAgaWYgKGFyZ3NMZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2FyZ3NMZW5ndGggLSAyXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGFyZ3NbLS1hcmdzTGVuZ3RoIC0gMV0sIGFyZ3NbYXJnc0xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAoYXJnc0xlbmd0aCA+IDIgJiYgdHlwZW9mIGFyZ3NbYXJnc0xlbmd0aCAtIDFdID09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IGFyZ3NbLS1hcmdzTGVuZ3RoXTsKICAgICAgfQogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgaXRlcmFibGUgPSBhcmdzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGl0ZXJhYmxlICYmIG9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHsKICAgICAgICB2YXIgb3duSW5kZXggPSAtMSwKICAgICAgICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdICYmIGtleXMoaXRlcmFibGUpLAogICAgICAgICAgICBsZW5ndGggPSBvd25Qcm9wcyA/IG93blByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK293bkluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayA/IGNhbGxiYWNrKHJlc3VsdFtpbmRleF0sIGl0ZXJhYmxlW2luZGV4XSkgOiBpdGVyYWJsZVtpbmRleF07CiAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGB2YWx1ZWAuIElmIGBpc0RlZXBgIGlzIGB0cnVlYCBuZXN0ZWQgb2JqZWN0cyB3aWxsIGFsc28KICAgICAqIGJlIGNsb25lZCwgb3RoZXJ3aXNlIHRoZXkgd2lsbCBiZSBhc3NpZ25lZCBieSByZWZlcmVuY2UuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgY2xvbmVkIHZhbHVlcy4gSWYgdGhlCiAgICAgKiBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIGNsb25pbmcgd2lsbCBiZSBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzRGVlcD1mYWxzZV0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIHZhciBzaGFsbG93ID0gXy5jbG9uZShjaGFyYWN0ZXJzKTsKICAgICAqIHNoYWxsb3dbMF0gPT09IGNoYXJhY3RlcnNbMF07CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogdmFyIGRlZXAgPSBfLmNsb25lKGNoYXJhY3RlcnMsIHRydWUpOwogICAgICogZGVlcFswXSA9PT0gY2hhcmFjdGVyc1swXTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5taXhpbih7CiAgICAgKiAgICdjbG9uZSc6IF8ucGFydGlhbFJpZ2h0KF8uY2xvbmUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgICAgcmV0dXJuIF8uaXNFbGVtZW50KHZhbHVlKSA/IHZhbHVlLmNsb25lTm9kZShmYWxzZSkgOiB1bmRlZmluZWQ7CiAgICAgKiAgIH0pCiAgICAgKiB9KTsKICAgICAqCiAgICAgKiB2YXIgY2xvbmUgPSBfLmNsb25lKGRvY3VtZW50LmJvZHkpOwogICAgICogY2xvbmUuY2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgKiAvLyA9PiAwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lKHZhbHVlLCBpc0RlZXAsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggIkNvbGxlY3Rpb25zIiBtZXRob2RzIHdpdGhvdXQgdXNpbmcgdGhlaXIgYGluZGV4YAogICAgICAvLyBhbmQgYGNvbGxlY3Rpb25gIGFyZ3VtZW50cyBmb3IgYGlzRGVlcGAgYW5kIGBjYWxsYmFja2AKICAgICAgaWYgKHR5cGVvZiBpc0RlZXAgIT0gJ2Jvb2xlYW4nICYmIGlzRGVlcCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gaXNEZWVwOwogICAgICAgIGlzRGVlcCA9IGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIGlzRGVlcCwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjbG9uZSBvZiBgdmFsdWVgLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUKICAgICAqIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIGNsb25lZCB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgCiAgICAgKiBjbG9uaW5nIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIGxvb3NlbHkgYmFzZWQgb24gdGhlIHN0cnVjdHVyZWQgY2xvbmUgYWxnb3JpdGhtLiBGdW5jdGlvbnMKICAgICAqIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kCiAgICAgKiBvYmplY3RzIGNyZWF0ZWQgYnkgY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIGRlZXAgPSBfLmNsb25lRGVlcChjaGFyYWN0ZXJzKTsKICAgICAqIGRlZXBbMF0gPT09IGNoYXJhY3RlcnNbMF07CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIHZhciB2aWV3ID0gewogICAgICogICAnbGFiZWwnOiAnZG9jcycsCiAgICAgKiAgICdub2RlJzogZWxlbWVudAogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgY2xvbmUgPSBfLmNsb25lRGVlcCh2aWV3LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICByZXR1cm4gXy5pc0VsZW1lbnQodmFsdWUpID8gdmFsdWUuY2xvbmVOb2RlKHRydWUpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKgogICAgICogY2xvbmUubm9kZSA9PSB2aWV3Lm5vZGU7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZURlZXAodmFsdWUsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIHRydWUsIHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nICYmIGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgdGhhdCBpbmhlcml0cyBmcm9tIHRoZSBnaXZlbiBgcHJvdG90eXBlYCBvYmplY3QuIElmIGEKICAgICAqIGBwcm9wZXJ0aWVzYCBvYmplY3QgaXMgcHJvdmlkZWQgaXRzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGFzc2lnbmVkCiAgICAgKiB0byB0aGUgY3JlYXRlZCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvdG90eXBlIFRoZSBvYmplY3QgdG8gaW5oZXJpdCBmcm9tLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtwcm9wZXJ0aWVzXSBUaGUgcHJvcGVydGllcyB0byBhc3NpZ24gdG8gdGhlIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIFNoYXBlKCkgewogICAgICogICB0aGlzLnggPSAwOwogICAgICogICB0aGlzLnkgPSAwOwogICAgICogfQogICAgICoKICAgICAqIGZ1bmN0aW9uIENpcmNsZSgpIHsKICAgICAqICAgU2hhcGUuY2FsbCh0aGlzKTsKICAgICAqIH0KICAgICAqCiAgICAgKiBDaXJjbGUucHJvdG90eXBlID0gXy5jcmVhdGUoU2hhcGUucHJvdG90eXBlLCB7ICdjb25zdHJ1Y3Rvcic6IENpcmNsZSB9KTsKICAgICAqCiAgICAgKiB2YXIgY2lyY2xlID0gbmV3IENpcmNsZTsKICAgICAqIGNpcmNsZSBpbnN0YW5jZW9mIENpcmNsZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBjaXJjbGUgaW5zdGFuY2VvZiBTaGFwZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlKHByb3RvdHlwZSwgcHJvcGVydGllcykgewogICAgICB2YXIgcmVzdWx0ID0gYmFzZUNyZWF0ZShwcm90b3R5cGUpOwogICAgICByZXR1cm4gcHJvcGVydGllcyA/IGFzc2lnbihyZXN1bHQsIHByb3BlcnRpZXMpIDogcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBvYmplY3QgZm9yIGFsbCBkZXN0aW5hdGlvbiBwcm9wZXJ0aWVzIHRoYXQgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYC4gT25jZSBhCiAgICAgKiBwcm9wZXJ0eSBpcyBzZXQsIGFkZGl0aW9uYWwgZGVmYXVsdHMgb2YgdGhlIHNhbWUgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gQWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzCiAgICAgKiAgYGtleWAgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdiYXJuZXknIH07CiAgICAgKiBfLmRlZmF1bHRzKG9iamVjdCwgeyAnbmFtZSc6ICdmcmVkJywgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFybmV5JywgJ2VtcGxveWVyJzogJ3NsYXRlJyB9CiAgICAgKi8KICAgIHZhciBkZWZhdWx0cyA9IGZ1bmN0aW9uKG9iamVjdCwgc291cmNlLCBndWFyZCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmdzLmxlbmd0aDsKICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIGl0ZXJhYmxlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGlmIChpdGVyYWJsZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSB7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdFtpbmRleF0gPT0gJ3VuZGVmaW5lZCcpIHJlc3VsdFtpbmRleF0gPSBpdGVyYWJsZVtpbmRleF07CiAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kSW5kZXhgIGV4Y2VwdCB0aGF0IGl0IHJldHVybnMgdGhlIGtleSBvZiB0aGUKICAgICAqIGZpcnN0IGVsZW1lbnQgdGhhdCBwYXNzZXMgdGhlIGNhbGxiYWNrIGNoZWNrLCBpbnN0ZWFkIG9mIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2Jhcm5leSc6IHsgICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiBmYWxzZSB9LAogICAgICogICAnZnJlZCc6IHsgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZmluZEtleShjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsKICAgICAqICAgcmV0dXJuIGNoci5hZ2UgPCA0MDsKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2Jhcm5leScgKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kS2V5KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDEgfSk7CiAgICAgKiAvLyA9PiAncGViYmxlcycKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmRLZXkoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKTsKICAgICAqIC8vID0+ICdmcmVkJwogICAgICovCiAgICBmdW5jdGlvbiBmaW5kS2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRLZXlgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2Jhcm5leSc6IHsgICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiB0cnVlIH0sCiAgICAgKiAgICdmcmVkJzogeyAgICAnYWdlJzogNDAsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiB0cnVlIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5maW5kTGFzdEtleShjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsKICAgICAqICAgcmV0dXJuIGNoci5hZ2UgPCA0MDsKICAgICAqIH0pOwogICAgICogLy8gPT4gcmV0dXJucyBgcGViYmxlc2AsIGFzc3VtaW5nIGBfLmZpbmRLZXlgIHJldHVybnMgYGJhcm5leWAKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmRMYXN0S2V5KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDQwIH0pOwogICAgICogLy8gPT4gJ2ZyZWQnCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kTGFzdEtleShjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gJ3BlYmJsZXMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRMYXN0S2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd25SaWdodChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICByZXN1bHQgPSBrZXk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCwKICAgICAqIGV4ZWN1dGluZyB0aGUgY2FsbGJhY2sgZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AKICAgICAqIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0CiAgICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIFNoYXBlKCkgewogICAgICogICB0aGlzLnggPSAwOwogICAgICogICB0aGlzLnkgPSAwOwogICAgICogfQogICAgICoKICAgICAqIFNoYXBlLnByb3RvdHlwZS5tb3ZlID0gZnVuY3Rpb24oeCwgeSkgewogICAgICogICB0aGlzLnggKz0geDsKICAgICAqICAgdGhpcy55ICs9IHk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW4obmV3IFNoYXBlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ3gnLCAneScsIGFuZCAnbW92ZScgKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKi8KICAgIHZhciBmb3JJbiA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBjb2xsZWN0aW9uLCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgaWYgKCFvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSByZXR1cm4gcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5mb3JJbmAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgaW4gdGhlIG9wcG9zaXRlIG9yZGVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBTaGFwZSgpIHsKICAgICAqICAgdGhpcy54ID0gMDsKICAgICAqICAgdGhpcy55ID0gMDsKICAgICAqIH0KICAgICAqCiAgICAgKiBTaGFwZS5wcm90b3R5cGUubW92ZSA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAqICAgdGhpcy54ICs9IHg7CiAgICAgKiAgIHRoaXMueSArPSB5OwogICAgICogfTsKICAgICAqCiAgICAgKiBfLmZvckluUmlnaHQobmV3IFNoYXBlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ21vdmUnLCAneScsIGFuZCAneCcgYXNzdW1pbmcgYF8uZm9ySW4gYCBsb2dzICd4JywgJ3knLCBhbmQgJ21vdmUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckluUmlnaHQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcGFpcnMgPSBbXTsKCiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHBhaXJzLnB1c2goa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBpZiAoY2FsbGJhY2socGFpcnNbbGVuZ3RoLS1dLCBwYWlyc1tsZW5ndGhdLCBvYmplY3QpID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LCBleGVjdXRpbmcgdGhlIGNhbGxiYWNrCiAgICAgKiBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5CiAgICAgKiBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mb3JPd24oeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9yT3duID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIW9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHJldHVybiByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yT3duYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yT3duUmlnaHQoeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnbGVuZ3RoJywgJzEnLCBhbmQgJzAnIGFzc3VtaW5nIGBfLmZvck93bmAgbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvck93blJpZ2h0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbbGVuZ3RoXTsKICAgICAgICBpZiAoY2FsbGJhY2sob2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLAogICAgICogb3duIGFuZCBpbmhlcml0ZWQsIG9mIGBvYmplY3RgIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBtZXRob2RzCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mdW5jdGlvbnMoXyk7CiAgICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgICAqLwogICAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5IG5hbWUgZXhpc3RzIGFzIGEgZGlyZWN0IHByb3BlcnR5IG9mIGBvYmplY3RgLAogICAgICogaW5zdGVhZCBvZiBhbiBpbmhlcml0ZWQgcHJvcGVydHkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaGFzKG9iamVjdCwga2V5KSB7CiAgICAgIHJldHVybiBvYmplY3QgPyBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSA6IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGludmVydGVkIGtleXMgYW5kIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGludmVydC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNyZWF0ZWQgaW52ZXJ0ZWQgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludmVydCh7ICdmaXJzdCc6ICdmcmVkJywgJ3NlY29uZCc6ICdiYXJuZXknIH0pOwogICAgICogLy8gPT4geyAnZnJlZCc6ICdmaXJzdCcsICdiYXJuZXknOiAnc2Vjb25kJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVydChvYmplY3QpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IHt9OwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICAgIHJlc3VsdFtvYmplY3Rba2V5XV0gPSBrZXk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzQm9vbGVhbihudWxsKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGJvb2xDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZGF0ZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZGF0ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRGF0ZShuZXcgRGF0ZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGRhdGVDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbGVtZW50KGRvY3VtZW50LmJvZHkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VsZW1lbnQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICYmIHZhbHVlLm5vZGVUeXBlID09PSAxIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgZW1wdHkuIEFycmF5cywgc3RyaW5ncywgb3IgYGFyZ3VtZW50c2Agb2JqZWN0cyB3aXRoIGEKICAgICAqIGxlbmd0aCBvZiBgMGAgYW5kIG9iamVjdHMgd2l0aCBubyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGFyZSBjb25zaWRlcmVkCiAgICAgKiAiZW1wdHkiLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBlbXB0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0VtcHR5KHt9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoJycpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSksCiAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgogICAgICBpZiAoKGNsYXNzTmFtZSA9PSBhcnJheUNsYXNzIHx8IGNsYXNzTmFtZSA9PSBzdHJpbmdDbGFzcyB8fCBjbGFzc05hbWUgPT0gYXJnc0NsYXNzICkgfHwKICAgICAgICAgIChjbGFzc05hbWUgPT0gb2JqZWN0Q2xhc3MgJiYgdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyAmJiBpc0Z1bmN0aW9uKHZhbHVlLnNwbGljZSkpKSB7CiAgICAgICAgcmV0dXJuICFsZW5ndGg7CiAgICAgIH0KICAgICAgZm9yT3duKHZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGZhbHNlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICAgKiBlcXVpdmFsZW50IHRvIGVhY2ggb3RoZXIuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZAogICAgICogdG8gY29tcGFyZSB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIGNvbXBhcmlzb25zIHdpbGwKICAgICAqIGJlIGhhbmRsZWQgYnkgdGhlIG1ldGhvZCBpbnN0ZWFkLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAgICogaW52b2tlZCB3aXRoIHR3byBhcmd1bWVudHM7IChhLCBiKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gYSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gYiBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb21wYXJpbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdmcmVkJyB9OwogICAgICogdmFyIGNvcHkgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKgogICAgICogb2JqZWN0ID09IGNvcHk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNFcXVhbChvYmplY3QsIGNvcHkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIHZhciB3b3JkcyA9IFsnaGVsbG8nLCAnZ29vZGJ5ZSddOwogICAgICogdmFyIG90aGVyV29yZHMgPSBbJ2hpJywgJ2dvb2RieWUnXTsKICAgICAqCiAgICAgKiBfLmlzRXF1YWwod29yZHMsIG90aGVyV29yZHMsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgdmFyIHJlR3JlZXQgPSAvXig/OmhlbGxvfGhpKSQvaSwKICAgICAqICAgICAgIGFHcmVldCA9IF8uaXNTdHJpbmcoYSkgJiYgcmVHcmVldC50ZXN0KGEpLAogICAgICogICAgICAgYkdyZWV0ID0gXy5pc1N0cmluZyhiKSAmJiByZUdyZWV0LnRlc3QoYik7CiAgICAgKgogICAgICogICByZXR1cm4gKGFHcmVldCB8fCBiR3JlZXQpID8gKGFHcmVldCA9PSBiR3JlZXQpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsKGEsIGIsIHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nICYmIGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMikpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMsIG9yIGNhbiBiZSBjb2VyY2VkIHRvLCBhIGZpbml0ZSBudW1iZXIuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc0Zpbml0ZWAgd2hpY2ggd2lsbCByZXR1cm4gdHJ1ZSBmb3IKICAgICAqIGJvb2xlYW5zIGFuZCBlbXB0eSBzdHJpbmdzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xLjIuNS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGZpbml0ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKC0xMDEpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoJzEwJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSh0cnVlKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSgnJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNGaW5pdGUodmFsdWUpIHsKICAgICAgcmV0dXJuIG5hdGl2ZUlzRmluaXRlKHZhbHVlKSAmJiAhbmF0aXZlSXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Z1bmN0aW9uKF8pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJzsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHRoZSBsYW5ndWFnZSB0eXBlIG9mIE9iamVjdC4KICAgICAqIChlLmcuIGFycmF5cywgZnVuY3Rpb25zLCBvYmplY3RzLCByZWdleGVzLCBgbmV3IE51bWJlcigwKWAsIGFuZCBgbmV3IFN0cmluZygnJylgKQogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNPYmplY3Qoe30pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNPYmplY3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KDEpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgLy8gY2hlY2sgaWYgdGhlIHZhbHVlIGlzIHRoZSBFQ01BU2NyaXB0IGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0CiAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4OAogICAgICAvLyBhbmQgYXZvaWQgYSBWOCBidWcKICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MjI5MQogICAgICByZXR1cm4gISEodmFsdWUgJiYgb2JqZWN0VHlwZXNbdHlwZW9mIHZhbHVlXSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgTmFOYC4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBhcyBuYXRpdmUgYGlzTmFOYCB3aGljaCB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yCiAgICAgKiBgdW5kZWZpbmVkYCBhbmQgb3RoZXIgbm9uLW51bWVyaWMgdmFsdWVzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xLjIuNC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGBOYU5gLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOYU4oTmFOKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmFOKG5ldyBOdW1iZXIoTmFOKSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogaXNOYU4odW5kZWZpbmVkKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmFOKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc05hTih2YWx1ZSkgewogICAgICAvLyBgTmFOYCBhcyBhIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYKICAgICAgLy8gKHBlcmZvcm0gdGhlIFtbQ2xhc3NdXSBjaGVjayBmaXJzdCB0byBhdm9pZCBlcnJvcnMgd2l0aCBzb21lIGhvc3Qgb2JqZWN0cyBpbiBJRSkKICAgICAgcmV0dXJuIGlzTnVtYmVyKHZhbHVlKSAmJiB2YWx1ZSAhPSArdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgbnVsbGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgbnVsbGAsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc051bGwobnVsbCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc051bGwodW5kZWZpbmVkKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzTnVsbCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIG51bWJlci4KICAgICAqCiAgICAgKiBOb3RlOiBgTmFOYCBpcyBjb25zaWRlcmVkIGEgbnVtYmVyLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3g4LjUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIG51bWJlciwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTnVtYmVyKDguNCAqIDUpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBTaGFwZSgpIHsKICAgICAqICAgdGhpcy54ID0gMDsKICAgICAqICAgdGhpcy55ID0gMDsKICAgICAqIH0KICAgICAqCiAgICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFNoYXBlKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNQbGFpbk9iamVjdCh7ICd4JzogMCwgJ3knOiAwIH0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICB2YXIgaXNQbGFpbk9iamVjdCA9ICFnZXRQcm90b3R5cGVPZiA/IHNoaW1Jc1BsYWluT2JqZWN0IDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKCEodmFsdWUgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gb2JqZWN0Q2xhc3MpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHZhciB2YWx1ZU9mID0gdmFsdWUudmFsdWVPZiwKICAgICAgICAgIG9ialByb3RvID0gaXNOYXRpdmUodmFsdWVPZikgJiYgKG9ialByb3RvID0gZ2V0UHJvdG90eXBlT2YodmFsdWVPZikpICYmIGdldFByb3RvdHlwZU9mKG9ialByb3RvKTsKCiAgICAgIHJldHVybiBvYmpQcm90bwogICAgICAgID8gKHZhbHVlID09IG9ialByb3RvIHx8IGdldFByb3RvdHlwZU9mKHZhbHVlKSA9PSBvYmpQcm90bykKICAgICAgICA6IHNoaW1Jc1BsYWluT2JqZWN0KHZhbHVlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNSZWdFeHAoL2ZyZWQvKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1N0cmluZygnZnJlZCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IHN0cmluZ0NsYXNzIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYHVuZGVmaW5lZGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzVW5kZWZpbmVkKHZvaWQgMCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3VuZGVmaW5lZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCB3aXRoIHRoZSBzYW1lIGtleXMgYXMgYG9iamVjdGAgYW5kIHZhbHVlcyBnZW5lcmF0ZWQgYnkKICAgICAqIHJ1bm5pbmcgZWFjaCBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBvZiBgb2JqZWN0YCB0aHJvdWdoIHRoZSBjYWxsYmFjay4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgb2JqZWN0IHdpdGggdmFsdWVzIG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWFwVmFsdWVzKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogM30gLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAgICogLy8gPT4geyAnYSc6IDMsICdiJzogNiwgJ2MnOiA5IH0KICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2ZyZWQnOiB7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICduYW1lJzogJ3BlYmJsZXMnLCAnYWdlJzogMSB9CiAgICAgKiB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWFwVmFsdWVzKGNoYXJhY3RlcnMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ2ZyZWQnOiA0MCwgJ3BlYmJsZXMnOiAxIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWFwVmFsdWVzKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgbWVyZ2VzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgdGhlIHNvdXJjZSBvYmplY3QocyksIHRoYXQKICAgICAqIGRvbid0IHJlc29sdmUgdG8gYHVuZGVmaW5lZGAgaW50byB0aGUgZGVzdGluYXRpb24gb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMKICAgICAqIHdpbGwgb3ZlcndyaXRlIHByb3BlcnR5IGFzc2lnbm1lbnRzIG9mIHByZXZpb3VzIHNvdXJjZXMuIElmIGEgY2FsbGJhY2sgaXMKICAgICAqIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgbWVyZ2VkIHZhbHVlcyBvZiB0aGUgZGVzdGluYXRpb24KICAgICAqIGFuZCBzb3VyY2UgcHJvcGVydGllcy4gSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgbWVyZ2luZyB3aWxsCiAgICAgKiBiZSBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0d28gYXJndW1lbnRzOyAob2JqZWN0VmFsdWUsIHNvdXJjZVZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgbWVyZ2luZyBwcm9wZXJ0aWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBuYW1lcyA9IHsKICAgICAqICAgJ2NoYXJhY3RlcnMnOiBbCiAgICAgKiAgICAgeyAnbmFtZSc6ICdiYXJuZXknIH0sCiAgICAgKiAgICAgeyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKiAgIF0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGFnZXMgPSB7CiAgICAgKiAgICdjaGFyYWN0ZXJzJzogWwogICAgICogICAgIHsgJ2FnZSc6IDM2IH0sCiAgICAgKiAgICAgeyAnYWdlJzogNDAgfQogICAgICogICBdCiAgICAgKiB9OwogICAgICoKICAgICAqIF8ubWVyZ2UobmFtZXMsIGFnZXMpOwogICAgICogLy8gPT4geyAnY2hhcmFjdGVycyc6IFt7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LCB7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfV0gfQogICAgICoKICAgICAqIHZhciBmb29kID0gewogICAgICogICAnZnJ1aXRzJzogWydhcHBsZSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnYmVldCddCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBvdGhlckZvb2QgPSB7CiAgICAgKiAgICdmcnVpdHMnOiBbJ2JhbmFuYSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnY2Fycm90J10KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShmb29kLCBvdGhlckZvb2QsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgcmV0dXJuIF8uaXNBcnJheShhKSA/IGEuY29uY2F0KGIpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdmcnVpdHMnOiBbJ2FwcGxlJywgJ2JhbmFuYSddLCAndmVnZXRhYmxlcyc6IFsnYmVldCcsICdjYXJyb3RdIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0KSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gMjsKCiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0KICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIGFuZCBgXy5yZWR1Y2VSaWdodGAgd2l0aG91dCB1c2luZwogICAgICAvLyB0aGVpciBgaW5kZXhgIGFuZCBgY29sbGVjdGlvbmAgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgYXJnc1syXSAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2xlbmd0aCAtIDJdID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soYXJnc1stLWxlbmd0aCAtIDFdLCBhcmdzW2xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiB0eXBlb2YgYXJnc1tsZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tbGVuZ3RoXTsKICAgICAgfQogICAgICB2YXIgc291cmNlcyA9IHNsaWNlKGFyZ3VtZW50cywgMSwgbGVuZ3RoKSwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBzdGFja0EgPSBnZXRBcnJheSgpLAogICAgICAgICAgc3RhY2tCID0gZ2V0QXJyYXkoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgYmFzZU1lcmdlKG9iamVjdCwgc291cmNlc1tpbmRleF0sIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQik7CiAgICAgIH0KICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQSk7CiAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgZXhjbHVkaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KICAgICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mCiAgICAgKiBwcm9wZXJ0eSBuYW1lcy4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoCiAgICAgKiBwcm9wZXJ0eSBvZiBgb2JqZWN0YCBvbWl0dGluZyB0aGUgcHJvcGVydGllcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleQogICAgICogZm9yLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnwuLi5zdHJpbmd8c3RyaW5nW119IFtjYWxsYmFja10gVGhlIHByb3BlcnRpZXMgdG8gb21pdCBvciB0aGUKICAgICAqICBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3Qgd2l0aG91dCB0aGUgb21pdHRlZCBwcm9wZXJ0aWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm9taXQoeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH0sICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnZnJlZCcgfQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIG9taXQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBwcm9wcyA9IFtdOwogICAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgcHJvcHMucHVzaChrZXkpOwogICAgICAgIH0pOwogICAgICAgIHByb3BzID0gYmFzZURpZmZlcmVuY2UocHJvcHMsIGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgZmFsc2UsIDEpKTsKCiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgICByZXN1bHRba2V5XSA9IG9iamVjdFtrZXldOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIGlmICghY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgdHdvIGRpbWVuc2lvbmFsIGFycmF5IG9mIGFuIG9iamVjdCdzIGtleS12YWx1ZSBwYWlycywKICAgICAqIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIG5ldyBhcnJheSBvZiBrZXktdmFsdWUgcGFpcnMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFpcnMoeyAnYmFybmV5JzogMzYsICdmcmVkJzogNDAgfSk7CiAgICAgKiAvLyA9PiBbWydiYXJuZXknLCAzNl0sIFsnZnJlZCcsIDQwXV0gKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhaXJzKG9iamVjdCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gW2tleSwgb2JqZWN0W2tleV1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBjb21wb3NlZCBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCiAgICAgKiBQcm9wZXJ0eSBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZgogICAgICogcHJvcGVydHkgbmFtZXMuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaAogICAgICogcHJvcGVydHkgb2YgYG9iamVjdGAgcGlja2luZyB0aGUgcHJvcGVydGllcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleQogICAgICogZm9yLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnwuLi5zdHJpbmd8c3RyaW5nW119IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24gb3IgcHJvcGVydHkgbmFtZXMgdG8gcGljaywgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgcHJvcGVydHkKICAgICAqICBuYW1lcyBvciBhcnJheXMgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBwaWNrZWQgcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5waWNrKHsgJ25hbWUnOiAnZnJlZCcsICdfdXNlcmlkJzogJ2ZyZWQxJyB9LCAnbmFtZScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKgogICAgICogXy5waWNrKHsgJ25hbWUnOiAnZnJlZCcsICdfdXNlcmlkJzogJ2ZyZWQxJyB9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApICE9ICdfJzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBpY2sob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBwcm9wcyA9IGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgZmFsc2UsIDEpLAogICAgICAgICAgICBsZW5ndGggPSBpc09iamVjdChvYmplY3QpID8gcHJvcHMubGVuZ3RoIDogMDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgICBpZiAoa2V5IGluIG9iamVjdCkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IG9iamVjdFtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEFuIGFsdGVybmF0aXZlIHRvIGBfLnJlZHVjZWAgdGhpcyBtZXRob2QgdHJhbnNmb3JtcyBgb2JqZWN0YCB0byBhIG5ldwogICAgICogYGFjY3VtdWxhdG9yYCBvYmplY3Qgd2hpY2ggaXMgdGhlIHJlc3VsdCBvZiBydW5uaW5nIGVhY2ggb2YgaXRzIG93bgogICAgICogZW51bWVyYWJsZSBwcm9wZXJ0aWVzIHRocm91Z2ggYSBjYWxsYmFjaywgd2l0aCBlYWNoIGNhbGxiYWNrIGV4ZWN1dGlvbgogICAgICogcG90ZW50aWFsbHkgbXV0YXRpbmcgdGhlIGBhY2N1bXVsYXRvcmAgb2JqZWN0LiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8KICAgICAqIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gVGhlIGN1c3RvbSBhY2N1bXVsYXRvciB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3F1YXJlcyA9IF8udHJhbnNmb3JtKFsxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMF0sIGZ1bmN0aW9uKHJlc3VsdCwgbnVtKSB7CiAgICAgKiAgIG51bSAqPSBudW07CiAgICAgKiAgIGlmIChudW0gJSAyKSB7CiAgICAgKiAgICAgcmV0dXJuIHJlc3VsdC5wdXNoKG51bSkgPCAzOwogICAgICogICB9CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsxLCA5LCAyNV0KICAgICAqCiAgICAgKiB2YXIgbWFwcGVkID0gXy50cmFuc2Zvcm0oeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAzIH0sIGZ1bmN0aW9uKHJlc3VsdCwgbnVtLCBrZXkpIHsKICAgICAqICAgcmVzdWx0W2tleV0gPSBudW0gKiAzOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm0ob2JqZWN0LCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShvYmplY3QpOwogICAgICBpZiAoYWNjdW11bGF0b3IgPT0gbnVsbCkgewogICAgICAgIGlmIChpc0FycikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGN0b3IgPSBvYmplY3QgJiYgb2JqZWN0LmNvbnN0cnVjdG9yLAogICAgICAgICAgICAgIHByb3RvID0gY3RvciAmJiBjdG9yLnByb3RvdHlwZTsKCiAgICAgICAgICBhY2N1bXVsYXRvciA9IGJhc2VDcmVhdGUocHJvdG8pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CiAgICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgdmFsdWVzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnZhbHVlcyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IFsxLCAyLCAzXSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IG9iamVjdFtwcm9wc1tpbmRleF1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzIGZyb20gdGhlIHNwZWNpZmllZCBpbmRleGVzLCBvciBrZXlzLCBvZiB0aGUKICAgICAqIGBjb2xsZWN0aW9uYC4gSW5kZXhlcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cwogICAgICogb2YgaW5kZXhlcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsuLi4obnVtYmVyfG51bWJlcltdfHN0cmluZ3xzdHJpbmdbXSl9IFtpbmRleF0gVGhlIGluZGV4ZXMgb2YgYGNvbGxlY3Rpb25gCiAgICAgKiAgIHRvIHJldHJpZXZlLCBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBpbmRleGVzIG9yIGFycmF5cyBvZiBpbmRleGVzLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIGNvcnJlc3BvbmRpbmcgdG8gdGhlCiAgICAgKiAgcHJvdmlkZWQgaW5kZXhlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5hdChbJ2EnLCAnYicsICdjJywgJ2QnLCAnZSddLCBbMCwgMiwgNF0pOwogICAgICogLy8gPT4gWydhJywgJ2MnLCAnZSddCiAgICAgKgogICAgICogXy5hdChbJ2ZyZWQnLCAnYmFybmV5JywgJ3BlYmJsZXMnXSwgMCwgMik7CiAgICAgKiAvLyA9PiBbJ2ZyZWQnLCAncGViYmxlcyddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGF0KGNvbGxlY3Rpb24pIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmdzLCB0cnVlLCBmYWxzZSwgMSksCiAgICAgICAgICBsZW5ndGggPSAoYXJnc1syXSAmJiBhcmdzWzJdW2FyZ3NbMV1dID09PSBjb2xsZWN0aW9uKSA/IDEgOiBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjb2xsZWN0aW9uW3Byb3BzW2luZGV4XV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBhIGdpdmVuIHZhbHVlIGlzIHByZXNlbnQgaW4gYSBjb2xsZWN0aW9uIHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiBgZnJvbUluZGV4YCBpcyBuZWdhdGl2ZSwgaXQgaXMgdXNlZCBhcyB0aGUKICAgICAqIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBpbmNsdWRlCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0geyp9IHRhcmdldCBUaGUgdmFsdWUgdG8gY2hlY2sgZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdGFyZ2V0YCBlbGVtZW50IGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29udGFpbnMoWzEsIDIsIDNdLCAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSwgMik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uY29udGFpbnMoeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH0sICdmcmVkJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5jb250YWlucygncGViYmxlcycsICdlYicpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHJlc3VsdCA9IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpID4gLTE7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHJlc3VsdCA9IChpc1N0cmluZyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSkgPiAtMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICgrK2luZGV4ID49IGZyb21JbmRleCkgewogICAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IHdhcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2suCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiAyLCAnNSc6IDEgfQogICAgICovCiAgICB2YXIgY291bnRCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YKICAgICAqIGEgY29sbGVjdGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGFsbAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ldmVyeShjaGFyYWN0ZXJzLCAnYWdlJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ldmVyeShjaGFyYWN0ZXJzLCB7ICdhZ2UnOiAzNiB9KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV2ZXJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSAhIWNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9ICEhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YgYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzCiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBzZWxlY3QKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyB0aGF0IHBhc3NlZCB0aGUgY2FsbGJhY2sgY2hlY2suCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBldmVucyA9IF8uZmlsdGVyKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzIsIDQsIDZdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbHRlcihjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCwgJ2Jsb2NrZWQnOiB0cnVlIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maWx0ZXIoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyB0aGUgZmlyc3QgZWxlbWVudCB0aGF0CiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkZXRlY3QsIGZpbmRXaGVyZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2FnZSc6IDEsICAnYmxvY2tlZCc6IGZhbHNlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5maW5kKGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA8IDQwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kKGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDEgfSk7CiAgICAgKiAvLyA9PiAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2FnZSc6IDEsICdibG9ja2VkJzogZmFsc2UgfQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0KFsxLCAyLCAzLCA0XSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gJSAyID09IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDMKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3QoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVsZW1lbnRzIG9mIGEgY29sbGVjdGlvbiwgZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaAogICAgICogZWxlbWVudC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieQogICAgICogZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBOb3RlOiBBcyB3aXRoIG90aGVyICJDb2xsZWN0aW9ucyIgbWV0aG9kcywgb2JqZWN0cyB3aXRoIGEgYGxlbmd0aGAgcHJvcGVydHkKICAgICAqIGFyZSBpdGVyYXRlZCBsaWtlIGFycmF5cy4gVG8gYXZvaWQgdGhpcyBiZWhhdmlvciBgXy5mb3JJbmAgb3IgYF8uZm9yT3duYAogICAgICogbWF5IGJlIHVzZWQgZm9yIG9iamVjdCBpdGVyYXRpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBlYWNoCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxzdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzXSkuZm9yRWFjaChmdW5jdGlvbihudW0pIHsgY29uc29sZS5sb2cobnVtKTsgfSkuam9pbignLCcpOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBhbmQgcmV0dXJucyAnMSwyLDMnCiAgICAgKgogICAgICogXy5mb3JFYWNoKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KTsKICAgICAqIC8vID0+IGxvZ3MgZWFjaCBudW1iZXIgYW5kIHJldHVybnMgdGhlIG9iamVjdCAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgZnVuY3Rpb24gZm9yRWFjaChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBjYWxsYmFjayk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZvckVhY2hgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGVhY2hSaWdodAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheXxPYmplY3R8c3RyaW5nfSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLmZvckVhY2hSaWdodChmdW5jdGlvbihudW0pIHsgY29uc29sZS5sb2cobnVtKTsgfSkuam9pbignLCcpOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBmcm9tIHJpZ2h0IHRvIGxlZnQgYW5kIHJldHVybnMgJzMsMiwxJwogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltsZW5ndGhdLCBsZW5ndGgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHByb3BzID0ga2V5cyhjb2xsZWN0aW9uKTsKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGtleSA9IHByb3BzID8gcHJvcHNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soY29sbGVjdGlvbltrZXldLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjb2xsZWN0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYSBjb2xsZWN0aW9uIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgYW4gYXJyYXkgb2YgdGhlIGVsZW1lbnRzIHJlc3BvbnNpYmxlIGZvciBnZW5lcmF0aW5nIHRoZSBrZXkuCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNvbXBvc2VkIGFnZ3JlZ2F0ZSBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgICAqCiAgICAgKiBfLmdyb3VwQnkoWzQuMiwgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogWzQuMl0sICc2JzogWzYuMSwgNi40XSB9CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ncm91cEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICAgKiAvLyA9PiB7ICczJzogWydvbmUnLCAndHdvJ10sICc1JzogWyd0aHJlZSddIH0KICAgICAqLwogICAgdmFyIGdyb3VwQnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IHJlc3VsdFtrZXldID0gW10pLnB1c2godmFsdWUpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiBrZXlzIGdlbmVyYXRlZCBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBvZiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBnaXZlbiBjYWxsYmFjay4gVGhlIGNvcnJlc3BvbmRpbmcKICAgICAqIHZhbHVlIG9mIGVhY2gga2V5IGlzIHRoZSBsYXN0IGVsZW1lbnQgcmVzcG9uc2libGUgZm9yIGdlbmVyYXRpbmcgdGhlIGtleS4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNvbXBvc2VkIGFnZ3JlZ2F0ZSBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBrZXlzID0gWwogICAgICogICB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwKICAgICAqICAgeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLmluZGV4Qnkoa2V5cywgJ2RpcicpOwogICAgICogLy8gPT4geyAnbGVmdCc6IHsgJ2Rpcic6ICdsZWZ0JywgJ2NvZGUnOiA5NyB9LCAncmlnaHQnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqCiAgICAgKiBfLmluZGV4Qnkoa2V5cywgZnVuY3Rpb24oa2V5KSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGtleS5jb2RlKTsgfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdkJzogeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfSB9CiAgICAgKgogICAgICogXy5pbmRleEJ5KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGtleSkgeyB0aGlzLmZyb21DaGFyQ29kZShrZXkuY29kZSk7IH0sIFN0cmluZyk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdkJzogeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfSB9CiAgICAgKi8KICAgIHZhciBpbmRleEJ5ID0gY3JlYXRlQWdncmVnYXRvcihmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIC8qKgogICAgICogSW52b2tlcyB0aGUgbWV0aG9kIG5hbWVkIGJ5IGBtZXRob2ROYW1lYCBvbiBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYAogICAgICogcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICAgKiB3aWxsIGJlIHByb3ZpZGVkIHRvIGVhY2ggaW52b2tlZCBtZXRob2QuIElmIGBtZXRob2ROYW1lYCBpcyBhIGZ1bmN0aW9uIGl0CiAgICAgKiB3aWxsIGJlIGludm9rZWQgZm9yLCBhbmQgYHRoaXNgIGJvdW5kIHRvLCBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBpbnZva2Ugb3IKICAgICAqICB0aGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBtZXRob2Qgd2l0aC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGludm9rZWQgbWV0aG9kLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludm9rZShbWzUsIDEsIDddLCBbMywgMiwgMV1dLCAnc29ydCcpOwogICAgICogLy8gPT4gW1sxLCA1LCA3XSwgWzEsIDIsIDNdXQogICAgICoKICAgICAqIF8uaW52b2tlKFsxMjMsIDQ1Nl0sIFN0cmluZy5wcm90b3R5cGUuc3BsaXQsICcnKTsKICAgICAqIC8vID0+IFtbJzEnLCAnMicsICczJ10sIFsnNCcsICc1JywgJzYnXV0KICAgICAqLwogICAgZnVuY3Rpb24gaW52b2tlKGNvbGxlY3Rpb24sIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGlzRnVuYyA9IHR5cGVvZiBtZXRob2ROYW1lID09ICdmdW5jdGlvbicsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogdmFsdWVbbWV0aG9kTmFtZV0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHZhbHVlcyBieSBydW5uaW5nIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbgogICAgICogdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aAogICAgICogdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBjb2xsZWN0CiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5tYXAoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAgICogLy8gPT4gWzMsIDYsIDldCiAgICAgKgogICAgICogXy5tYXAoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgICAqIC8vID0+IFszLCA2LCA5XSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1hcChjaGFyYWN0ZXJzLCAnbmFtZScpOwogICAgICogLy8gPT4gWydiYXJuZXknLCAnZnJlZCddCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICAgICAgcmVzdWx0WysraW5kZXhdID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgbWF4aW11bSB2YWx1ZSBvZiBhIGNvbGxlY3Rpb24uIElmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IG9yCiAgICAgKiBmYWxzZXkgYC1JbmZpbml0eWAgaXMgcmV0dXJuZWQuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZAogICAgICogZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGNvbGxlY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUKICAgICAqIGlzIHJhbmtlZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgbWF4aW11bSB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5tYXgoWzQsIDIsIDgsIDZdKTsKICAgICAqIC8vID0+IDgKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1heChjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsgcmV0dXJuIGNoci5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5tYXgoY2hhcmFjdGVycywgJ2FnZScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH07CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1heChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgY29tcHV0ZWQgPSAtSW5maW5pdHksCiAgICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggZnVuY3Rpb25zIGxpa2UgYF8ubWFwYCB3aXRob3V0IHVzaW5nCiAgICAgIC8vIHRoZWlyIGBpbmRleGAgYXJndW1lbnQgYXMgYSBjYWxsYmFjawogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicgJiYgdGhpc0FyZyAmJiB0aGlzQXJnW2NhbGxiYWNrXSA9PT0gY29sbGVjdGlvbikgewogICAgICAgIGNhbGxiYWNrID0gbnVsbDsKICAgICAgfQogICAgICBpZiAoY2FsbGJhY2sgPT0gbnVsbCAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrID0gKGNhbGxiYWNrID09IG51bGwgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpCiAgICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgICA6IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgICBpZiAoY3VycmVudCA+IGNvbXB1dGVkKSB7CiAgICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgbWluaW11bSB2YWx1ZSBvZiBhIGNvbGxlY3Rpb24uIElmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IG9yCiAgICAgKiBmYWxzZXkgYEluZmluaXR5YCBpcyByZXR1cm5lZC4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkCiAgICAgKiBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgY29sbGVjdGlvbiB0byBnZW5lcmF0ZSB0aGUgY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZQogICAgICogaXMgcmFua2VkLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm1pbihbNCwgMiwgOCwgNl0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8ubWluKGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgeyByZXR1cm4gY2hyLmFnZTsgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWluKGNoYXJhY3RlcnMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH07CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1pbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgY29tcHV0ZWQgPSBJbmZpbml0eSwKICAgICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBmdW5jdGlvbnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcKICAgICAgLy8gdGhlaXIgYGluZGV4YCBhcmd1bWVudCBhcyBhIGNhbGxiYWNrCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJyAmJiB0aGlzQXJnICYmIHRoaXNBcmdbY2FsbGJhY2tdID09PSBjb2xsZWN0aW9uKSB7CiAgICAgICAgY2FsbGJhY2sgPSBudWxsOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayA9PSBudWxsICYmIGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSAoY2FsbGJhY2sgPT0gbnVsbCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkKICAgICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICAgIDogbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICAgIGlmIChjdXJyZW50IDwgY29tcHV0ZWQpIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHNwZWNpZmllZCBwcm9wZXJ0eSBmcm9tIGFsbCBlbGVtZW50cyBpbiB0aGUgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnBsdWNrKGNoYXJhY3RlcnMsICduYW1lJyk7CiAgICAgKiAvLyA9PiBbJ2Jhcm5leScsICdmcmVkJ10KICAgICAqLwogICAgdmFyIHBsdWNrID0gbWFwOwoKICAgIC8qKgogICAgICogUmVkdWNlcyBhIGNvbGxlY3Rpb24gdG8gYSB2YWx1ZSB3aGljaCBpcyB0aGUgYWNjdW11bGF0ZWQgcmVzdWx0IG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjaywgd2hlcmUgZWFjaCBzdWNjZXNzaXZlCiAgICAgKiBjYWxsYmFjayBleGVjdXRpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJldmlvdXMgZXhlY3V0aW9uLiBJZgogICAgICogYGFjY3VtdWxhdG9yYCBpcyBub3QgcHJvdmlkZWQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24gd2lsbCBiZQogICAgICogdXNlZCBhcyB0aGUgaW5pdGlhbCBgYWNjdW11bGF0b3JgIHZhbHVlLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICAgKiBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIHZhciBtYXBwZWQgPSBfLnJlZHVjZSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgZnVuY3Rpb24ocmVzdWx0LCBudW0sIGtleSkgewogICAgICogICByZXN1bHRba2V5XSA9IG51bSAqIDM7CiAgICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICAgKiB9LCB7fSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICBpZiAobm9hY2N1bSkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBub2FjY3VtCiAgICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnJlZHVjZWAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZHIKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAgICogdmFyIGZsYXQgPSBfLnJlZHVjZVJpZ2h0KGxpc3QsIGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEuY29uY2F0KGIpOyB9LCBbXSk7CiAgICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVkdWNlUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCA0KTsKICAgICAgZm9yRWFjaFJpZ2h0KGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSBlbGVtZW50cyBvZiBhCiAgICAgKiBjb2xsZWN0aW9uIHRoYXQgdGhlIGNhbGxiYWNrIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1ZXkgZm9yLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBmYWlsZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzEsIDMsIDVdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlamVjdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5yZWplY3QoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVqZWN0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgcmV0dXJuIGZpbHRlcihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIGEgcmFuZG9tIGVsZW1lbnQgb3IgYG5gIHJhbmRvbSBlbGVtZW50cyBmcm9tIGEgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2FtcGxlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBBbGxvd3Mgd29ya2luZyB3aXRoIGZ1bmN0aW9ucyBsaWtlIGBfLm1hcGAKICAgICAqICB3aXRob3V0IHVzaW5nIHRoZWlyIGBpbmRleGAgYXJndW1lbnRzIGFzIGBuYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZG9tIHNhbXBsZShzKSBvZiBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2FtcGxlKFsxLCAyLCAzLCA0XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zYW1wbGUoWzEsIDIsIDMsIDRdLCAyKTsKICAgICAqIC8vID0+IFszLCAxXQogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGUoY29sbGVjdGlvbiwgbiwgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoICE9ICdudW1iZXInKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlcyhjb2xsZWN0aW9uKTsKICAgICAgfQogICAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uW2Jhc2VSYW5kb20oMCwgY29sbGVjdGlvbi5sZW5ndGggLSAxKV0gOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHNodWZmbGUoY29sbGVjdGlvbik7CiAgICAgIHJlc3VsdC5sZW5ndGggPSBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCByZXN1bHQubGVuZ3RoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgdmFsdWVzLCB1c2luZyBhIHZlcnNpb24gb2YgdGhlIEZpc2hlci1ZYXRlcwogICAgICogc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgICAqLwogICAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgcmFuZCA9IGJhc2VSYW5kb20oMCwgKytpbmRleCk7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IHJlc3VsdFtyYW5kXTsKICAgICAgICByZXN1bHRbcmFuZF0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBzaXplIG9mIHRoZSBgY29sbGVjdGlvbmAgYnkgcmV0dXJuaW5nIGBjb2xsZWN0aW9uLmxlbmd0aGAgZm9yIGFycmF5cwogICAgICogYW5kIGFycmF5LWxpa2Ugb2JqZWN0cyBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgZm9yIG9iamVjdHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGBjb2xsZWN0aW9uLmxlbmd0aGAgb3IgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2l6ZShbMSwgMl0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIF8uc2l6ZSh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IDMKICAgICAqCiAgICAgKiBfLnNpemUoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+IDcKICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZXkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICAgKiBjb2xsZWN0aW9uLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGEgcGFzc2luZyB2YWx1ZSBhbmQKICAgICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGNvbGxlY3Rpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBhbnkKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbnkgZWxlbWVudCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAsICdibG9ja2VkJzogdHJ1ZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29tZShjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29tZShjaGFyYWN0ZXJzLCB7ICdhZ2UnOiAxIH0pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gc29tZShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoKHJlc3VsdCA9IGNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzLCBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICAgKiBydW5uaW5nIGVhY2ggZWxlbWVudCBpbiBhIGNvbGxlY3Rpb24gdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoaXMgbWV0aG9kCiAgICAgKiBwZXJmb3JtcyBhIHN0YWJsZSBzb3J0LCB0aGF0IGlzLCBpdCB3aWxsIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzb3J0IG9yZGVyCiAgICAgKiBvZiBlcXVhbCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoCiAgICAgKiB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNvbGxlY3Rpb24KICAgICAqIHdpbGwgYmUgc29ydGVkIGJ5IGVhY2ggcHJvcGVydHkgdmFsdWUuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHNvcnRlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguc2luKG51bSk7IH0pOwogICAgICogLy8gPT4gWzMsIDEsIDJdCiAgICAgKgogICAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuc2luKG51bSk7IH0sIE1hdGgpOwogICAgICogLy8gPT4gWzMsIDEsIDJdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDI2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdhZ2UnOiAzMCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWFwKF8uc29ydEJ5KGNoYXJhY3RlcnMsICdhZ2UnKSwgXy52YWx1ZXMpOwogICAgICogLy8gPT4gW1snYmFybmV5JywgMjZdLCBbJ2ZyZWQnLCAzMF0sIFsnYmFybmV5JywgMzZdLCBbJ2ZyZWQnLCA0MF1dCiAgICAgKgogICAgICogLy8gc29ydGluZyBieSBtdWx0aXBsZSBwcm9wZXJ0aWVzCiAgICAgKiBfLm1hcChfLnNvcnRCeShjaGFyYWN0ZXJzLCBbJ25hbWUnLCAnYWdlJ10pLCBfLnZhbHVlcyk7CiAgICAgKiAvLyA9ID4gW1snYmFybmV5JywgMjZdLCBbJ2Jhcm5leScsIDM2XSwgWydmcmVkJywgMzBdLCBbJ2ZyZWQnLCA0MF1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRCeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGlzQXJyID0gaXNBcnJheShjYWxsYmFjayksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgaWYgKCFpc0FycikgewogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgfQogICAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgb2JqZWN0ID0gcmVzdWx0WysraW5kZXhdID0gZ2V0T2JqZWN0KCk7CiAgICAgICAgaWYgKGlzQXJyKSB7CiAgICAgICAgICBvYmplY3QuY3JpdGVyaWEgPSBtYXAoY2FsbGJhY2ssIGZ1bmN0aW9uKGtleSkgeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIChvYmplY3QuY3JpdGVyaWEgPSBnZXRBcnJheSgpKVswXSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0KICAgICAgICBvYmplY3QuaW5kZXggPSBpbmRleDsKICAgICAgICBvYmplY3QudmFsdWUgPSB2YWx1ZTsKICAgICAgfSk7CgogICAgICBsZW5ndGggPSByZXN1bHQubGVuZ3RoOwogICAgICByZXN1bHQuc29ydChjb21wYXJlQXNjZW5kaW5nKTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIG9iamVjdCA9IHJlc3VsdFtsZW5ndGhdOwogICAgICAgIHJlc3VsdFtsZW5ndGhdID0gb2JqZWN0LnZhbHVlOwogICAgICAgIGlmICghaXNBcnIpIHsKICAgICAgICAgIHJlbGVhc2VBcnJheShvYmplY3QuY3JpdGVyaWEpOwogICAgICAgIH0KICAgICAgICByZWxlYXNlT2JqZWN0KG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgICAqIC8vID0+IFsyLCAzLCA0XQogICAgICovCiAgICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHNsaWNlKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXMoY29sbGVjdGlvbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBvZiBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAgdG8gdGhlIGdpdmVuCiAgICAgKiBgcHJvcGVydGllc2Agb2JqZWN0LCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzIHRoYXQgaGF2ZSBlcXVpdmFsZW50CiAgICAgKiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcHMgVGhlIG9iamVjdCBvZiBwcm9wZXJ0eSB2YWx1ZXMgdG8gZmlsdGVyIGJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgZ2l2ZW4gcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAncGV0cyc6IFsnaG9wcHknXSB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCwgJ3BldHMnOiBbJ2JhYnkgcHVzcycsICdkaW5vJ10gfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLndoZXJlKGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDM2IH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAncGV0cyc6IFsnaG9wcHknXSB9XQogICAgICoKICAgICAqIF8ud2hlcmUoY2hhcmFjdGVycywgeyAncGV0cyc6IFsnZGlubyddIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCwgJ3BldHMnOiBbJ2JhYnkgcHVzcycsICdkaW5vJ10gfV0KICAgICAqLwogICAgdmFyIHdoZXJlID0gZmlsdGVyOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIHJlbW92ZWQuIFRoZSB2YWx1ZXMgYGZhbHNlYCwgYG51bGxgLAogICAgICogYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCwgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGV4Y2x1ZGluZyBhbGwgdmFsdWVzIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW3ZhbHVlc10gVGhlIGFycmF5cyBvZiB2YWx1ZXMgdG8gZXhjbHVkZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGlmZmVyZW5jZShbMSwgMiwgMywgNCwgNV0sIFs1LCAyLCAxMF0pOwogICAgICogLy8gPT4gWzEsIDMsIDRdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpZmZlcmVuY2UoYXJyYXkpIHsKICAgICAgcmV0dXJuIGJhc2VEaWZmZXJlbmNlKGFycmF5LCBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmluZGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGZpcnN0CiAgICAgKiBlbGVtZW50IHRoYXQgcGFzc2VzIHRoZSBjYWxsYmFjayBjaGVjaywgaW5zdGVhZCBvZiB0aGUgZWxlbWVudCBpdHNlbGYuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZm91bmQgZWxlbWVudCwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdhZ2UnOiA0MCwgJ2Jsb2NrZWQnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmluZEluZGV4KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA8IDIwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kSW5kZXgoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiAwCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kSW5kZXgoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKTsKICAgICAqIC8vID0+IDEKICAgICAqLwogICAgZnVuY3Rpb24gZmluZEluZGV4KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmluZEluZGV4YCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZm91bmQgZWxlbWVudCwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiB0cnVlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5maW5kTGFzdEluZGV4KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA+IDMwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kTGFzdEluZGV4KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDM2IH0pOwogICAgICogLy8gPT4gMAogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZExhc3RJbmRleChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gMgogICAgICovCiAgICBmdW5jdGlvbiBmaW5kTGFzdEluZGV4KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChjYWxsYmFjayhhcnJheVtsZW5ndGhdLCBsZW5ndGgsIGFycmF5KSkgewogICAgICAgICAgcmV0dXJuIGxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgZmlyc3QgZWxlbWVudCBvciBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSByZXR1cm5lZCBhcyBsb25nCiAgICAgKiBhcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGhlYWQsIHRha2UKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZmlyc3QgZWxlbWVudChzKSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogXy5maXJzdChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogXy5maXJzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2Jsb2NrZWQnOiBmYWxzZSwgJ2VtcGxveWVyJzogJ3NsYXRlJyB9LAogICAgICogICB7ICduYW1lJzogJ3BlYmJsZXMnLCAnYmxvY2tlZCc6IHRydWUsICAnZW1wbG95ZXInOiAnbmEnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maXJzdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnc2xhdGUnIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5wbHVjayhfLmZpcnN0KGNoYXJhY3RlcnMsIHsgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KSwgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICovCiAgICBmdW5jdGlvbiBmaXJzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnbnVtYmVyJyAmJiBjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkgPyBhcnJheVswXSA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCBsZW5ndGgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEZsYXR0ZW5zIGEgbmVzdGVkIGFycmF5ICh0aGUgbmVzdGluZyBjYW4gYmUgdG8gYW55IGRlcHRoKS4gSWYgYGlzU2hhbGxvd2AKICAgICAqIGlzIHRydWV5LCB0aGUgYXJyYXkgd2lsbCBvbmx5IGJlIGZsYXR0ZW5lZCBhIHNpbmdsZSBsZXZlbC4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgZWFjaCBlbGVtZW50IG9mIHRoZSBhcnJheSBpcyBwYXNzZWQgdGhyb3VnaCB0aGUgY2FsbGJhY2sgYmVmb3JlCiAgICAgKiBmbGF0dGVuaW5nLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gZmxhdHRlbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzU2hhbGxvdz1mYWxzZV0gQSBmbGFnIHRvIHJlc3RyaWN0IGZsYXR0ZW5pbmcgdG8gYSBzaW5nbGUgbGV2ZWwuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0pOwogICAgICogLy8gPT4gWzEsIDIsIDMsIDRdOwogICAgICoKICAgICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSwgdHJ1ZSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgW1s0XV1dOwogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzMCwgJ3BldHMnOiBbJ2hvcHB5J10gfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAsICdwZXRzJzogWydiYWJ5IHB1c3MnLCAnZGlubyddIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5mbGF0dGVuKGNoYXJhY3RlcnMsICdwZXRzJyk7CiAgICAgKiAvLyA9PiBbJ2hvcHB5JywgJ2JhYnkgcHVzcycsICdkaW5vJ10KICAgICAqLwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSwgaXNTaGFsbG93LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgaXNTaGFsbG93ICE9ICdib29sZWFuJyAmJiBpc1NoYWxsb3cgIT0gbnVsbCkgewogICAgICAgIHRoaXNBcmcgPSBjYWxsYmFjazsKICAgICAgICBjYWxsYmFjayA9ICh0eXBlb2YgaXNTaGFsbG93ICE9ICdmdW5jdGlvbicgJiYgdGhpc0FyZyAmJiB0aGlzQXJnW2lzU2hhbGxvd10gPT09IGFycmF5KSA/IG51bGwgOiBpc1NoYWxsb3c7CiAgICAgICAgaXNTaGFsbG93ID0gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICBhcnJheSA9IG1hcChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlRmxhdHRlbihhcnJheSwgaXNTaGFsbG93KTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBhcnJheSBpcyBhbHJlYWR5IHNvcnRlZAogICAgICogcHJvdmlkaW5nIGB0cnVlYCBmb3IgYGZyb21JbmRleGAgd2lsbCBydW4gYSBmYXN0ZXIgYmluYXJ5IHNlYXJjaC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbSBvciBgdHJ1ZWAKICAgICAqICB0byBwZXJmb3JtIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBhcnJheS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gMQogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIsIDMpOwogICAgICogLy8gPT4gNAogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMSwgMiwgMiwgMywgM10sIDIsIHRydWUpOwogICAgICogLy8gPT4gMgogICAgICovCiAgICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4IHx8IDApOwogICAgICB9IGVsc2UgaWYgKGZyb21JbmRleCkgewogICAgICAgIHZhciBpbmRleCA9IHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XSA9PT0gdmFsdWUgPyBpbmRleCA6IC0xOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlSW5kZXhPZihhcnJheSwgdmFsdWUsIGZyb21JbmRleCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIGFsbCBidXQgdGhlIGxhc3QgZWxlbWVudCBvciBsYXN0IGBuYCBlbGVtZW50cyBvZiBhbiBhcnJheS4gSWYgYQogICAgICogY2FsbGJhY2sgaXMgcHJvdmlkZWQgZWxlbWVudHMgYXQgdGhlIGVuZCBvZiB0aGUgYXJyYXkgYXJlIGV4Y2x1ZGVkIGZyb20KICAgICAqIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kCiAgICAgKiB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgZWxlbWVudCBvciB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW5pdGlhbChbMSwgMiwgM10pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqCiAgICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsxXQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYmxvY2tlZCc6IGZhbHNlLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAgJ2VtcGxveWVyJzogJ25hJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uaW5pdGlhbChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogZmFsc2UsICdlbXBsb3llcic6ICdzbGF0ZScgfV0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnBsdWNrKF8uaW5pdGlhbChjaGFyYWN0ZXJzLCB7ICdlbXBsb3llcic6ICduYScgfSksICduYW1lJyk7CiAgICAgKiAvLyA9PiBbJ2Jhcm5leScsICdmcmVkJ10KICAgICAqLwogICAgZnVuY3Rpb24gaW5pdGlhbChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnbnVtYmVyJyAmJiBjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICB3aGlsZSAoaW5kZXgtLSAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IChjYWxsYmFjayA9PSBudWxsIHx8IHRoaXNBcmcpID8gMSA6IGNhbGxiYWNrIHx8IG47CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pLCBsZW5ndGgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdW5pcXVlIHZhbHVlcyBwcmVzZW50IGluIGFsbCBwcm92aWRlZCBhcnJheXMgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHNoYXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW50ZXJzZWN0aW9uKFsxLCAyLCAzXSwgWzUsIDIsIDEsIDRdLCBbMiwgMV0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludGVyc2VjdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgIGFyZ3NJbmRleCA9IC0xLAogICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICBjYWNoZXMgPSBnZXRBcnJheSgpLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIHRydXN0SW5kZXhPZiA9IGluZGV4T2YgPT09IGJhc2VJbmRleE9mLAogICAgICAgICAgc2VlbiA9IGdldEFycmF5KCk7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJndW1lbnRzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpIHx8IGlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgICAgYXJncy5wdXNoKHZhbHVlKTsKICAgICAgICAgIGNhY2hlcy5wdXNoKHRydXN0SW5kZXhPZiAmJiB2YWx1ZS5sZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYKICAgICAgICAgICAgY3JlYXRlQ2FjaGUoYXJnc0luZGV4ID8gYXJnc1thcmdzSW5kZXhdIDogc2VlbikpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgYXJyYXkgPSBhcmdzWzBdLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgb3V0ZXI6CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGNhY2hlID0gY2FjaGVzWzBdOwogICAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgICBpZiAoKGNhY2hlID8gY2FjaGVJbmRleE9mKGNhY2hlLCB2YWx1ZSkgOiBpbmRleE9mKHNlZW4sIHZhbHVlKSkgPCAwKSB7CiAgICAgICAgICBhcmdzSW5kZXggPSBhcmdzTGVuZ3RoOwogICAgICAgICAgKGNhY2hlIHx8IHNlZW4pLnB1c2godmFsdWUpOwogICAgICAgICAgd2hpbGUgKC0tYXJnc0luZGV4KSB7CiAgICAgICAgICAgIGNhY2hlID0gY2FjaGVzW2FyZ3NJbmRleF07CiAgICAgICAgICAgIGlmICgoY2FjaGUgPyBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA6IGluZGV4T2YoYXJnc1thcmdzSW5kZXhdLCB2YWx1ZSkpIDwgMCkgewogICAgICAgICAgICAgIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlIChhcmdzTGVuZ3RoLS0pIHsKICAgICAgICBjYWNoZSA9IGNhY2hlc1thcmdzTGVuZ3RoXTsKICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgIHJlbGVhc2VPYmplY3QoY2FjaGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZWxlYXNlQXJyYXkoY2FjaGVzKTsKICAgICAgcmVsZWFzZUFycmF5KHNlZW4pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgbGFzdCBlbGVtZW50IG9yIGxhc3QgYG5gIGVsZW1lbnRzIG9mIGFuIGFycmF5LiBJZiBhIGNhbGxiYWNrIGlzCiAgICAgKiBwcm92aWRlZCBlbGVtZW50cyBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheSBhcmUgcmV0dXJuZWQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgbGFzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubGFzdChbMSwgMiwgM10pOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8ubGFzdChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzIsIDNdCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPiAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2Jsb2NrZWQnOiBmYWxzZSwgJ2VtcGxveWVyJzogJ3NsYXRlJyB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICAnYmxvY2tlZCc6IHRydWUsICAnZW1wbG95ZXInOiAnc2xhdGUnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICduYScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnBsdWNrKF8ubGFzdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpLCAnbmFtZScpOwogICAgICogLy8gPT4gWydmcmVkJywgJ3BlYmJsZXMnXQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubGFzdChjaGFyYWN0ZXJzLCB7ICdlbXBsb3llcic6ICduYScgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnbmEnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSBjYWxsYmFjazsKICAgICAgICBpZiAobiA9PSBudWxsIHx8IHRoaXNBcmcpIHsKICAgICAgICAgIHJldHVybiBhcnJheSA/IGFycmF5W2xlbmd0aCAtIDFdIDogdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIG5hdGl2ZU1heCgwLCBsZW5ndGggLSBuKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgbGFzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD1hcnJheS5sZW5ndGgtMV0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sYXN0SW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gNAogICAgICoKICAgICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgICAqIC8vID0+IDEKICAgICAqLwogICAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgICAgdmFyIGluZGV4ID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICAgIGluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgaW5kZXggKyBmcm9tSW5kZXgpIDogbmF0aXZlTWluKGZyb21JbmRleCwgaW5kZXggLSAxKSkgKyAxOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiBpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgcHJvdmlkZWQgdmFsdWVzIGZyb20gdGhlIGdpdmVuIGFycmF5IHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IKICAgICAqIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHsuLi4qfSBbdmFsdWVdIFRoZSB2YWx1ZXMgdG8gcmVtb3ZlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IFsxLCAyLCAzLCAxLCAyLCAzXTsKICAgICAqIF8ucHVsbChhcnJheSwgMiwgMyk7CiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbMSwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcHVsbChhcnJheSkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIGFyZ3NJbmRleCA9IDAsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIHZhbHVlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgICAgICBzcGxpY2UuY2FsbChhcnJheSwgaW5kZXgtLSwgMSk7CiAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG51bWJlcnMgKHBvc2l0aXZlIGFuZC9vciBuZWdhdGl2ZSkgcHJvZ3Jlc3NpbmcgZnJvbQogICAgICogYHN0YXJ0YCB1cCB0byBidXQgbm90IGluY2x1ZGluZyBgZW5kYC4gSWYgYHN0YXJ0YCBpcyBsZXNzIHRoYW4gYHN0b3BgIGEKICAgICAqIHplcm8tbGVuZ3RoIHJhbmdlIGlzIGNyZWF0ZWQgdW5sZXNzIGEgbmVnYXRpdmUgYHN0ZXBgIGlzIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RlcD0xXSBUaGUgdmFsdWUgdG8gaW5jcmVtZW50IG9yIGRlY3JlbWVudCBieS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyByYW5nZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yYW5nZSg0KTsKICAgICAqIC8vID0+IFswLCAxLCAyLCAzXQogICAgICoKICAgICAqIF8ucmFuZ2UoMSwgNSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNF0KICAgICAqCiAgICAgKiBfLnJhbmdlKDAsIDIwLCA1KTsKICAgICAqIC8vID0+IFswLCA1LCAxMCwgMTVdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAtNCwgLTEpOwogICAgICogLy8gPT4gWzAsIC0xLCAtMiwgLTNdCiAgICAgKgogICAgICogXy5yYW5nZSgxLCA0LCAwKTsKICAgICAqIC8vID0+IFsxLCAxLCAxXQogICAgICoKICAgICAqIF8ucmFuZ2UoMCk7CiAgICAgKiAvLyA9PiBbXQogICAgICovCiAgICBmdW5jdGlvbiByYW5nZShzdGFydCwgZW5kLCBzdGVwKSB7CiAgICAgIHN0YXJ0ID0gK3N0YXJ0IHx8IDA7CiAgICAgIHN0ZXAgPSB0eXBlb2Ygc3RlcCA9PSAnbnVtYmVyJyA/IHN0ZXAgOiAoK3N0ZXAgfHwgMSk7CgogICAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0KICAgICAgLy8gdXNlIGBBcnJheShsZW5ndGgpYCBzbyBlbmdpbmVzIGxpa2UgQ2hha3JhIGFuZCBWOCBhdm9pZCBzbG93ZXIgbW9kZXMKICAgICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWF4KDAsIGNlaWwoKGVuZCAtIHN0YXJ0KSAvIChzdGVwIHx8IDEpKSksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgZWxlbWVudHMgZnJvbSBhbiBhcnJheSB0aGF0IHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvcgogICAgICogYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgcmVtb3ZlZCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgNCwgNSwgNl07CiAgICAgKiB2YXIgZXZlbnMgPSBfLnJlbW92ZShhcnJheSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxLCAzLCA1XQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGV2ZW5zKTsKICAgICAqIC8vID0+IFsyLCA0LCA2XQogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmUoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gW107CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uaW5pdGlhbGAgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCBlbGVtZW50IG9yCiAgICAgKiBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZWxlbWVudHMKICAgICAqIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxudW1iZXJ8c3RyaW5nfSBbY2FsbGJhY2s9MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gZXhjbHVkZS4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yCiAgICAgKiAgb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiCiAgICAgKiAgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLnJlc3QoWzEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IFszXQogICAgICoKICAgICAqIF8ucmVzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzNdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2Jsb2NrZWQnOiBmYWxzZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnbmEnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5wbHVjayhfLnJlc3QoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKSwgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnZnJlZCcsICdwZWJibGVzJ10KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlc3QoY2hhcmFjdGVycywgeyAnZW1wbG95ZXInOiAnc2xhdGUnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAncGViYmxlcycsICdibG9ja2VkJzogdHJ1ZSwgJ2VtcGxveWVyJzogJ25hJyB9XQogICAgICovCiAgICBmdW5jdGlvbiByZXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdudW1iZXInICYmIGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gKGNhbGxiYWNrID09IG51bGwgfHwgdGhpc0FyZykgPyAxIDogbmF0aXZlTWF4KDAsIGNhbGxiYWNrKTsKICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIG4pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlcyBhIGJpbmFyeSBzZWFyY2ggdG8gZGV0ZXJtaW5lIHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaCBhIHZhbHVlCiAgICAgKiBzaG91bGQgYmUgaW5zZXJ0ZWQgaW50byBhIGdpdmVuIHNvcnRlZCBhcnJheSBpbiBvcmRlciB0byBtYWludGFpbiB0aGUgc29ydAogICAgICogb3JkZXIgb2YgdGhlIGFycmF5LiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yCiAgICAgKiBgdmFsdWVgIGFuZCBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YCB0byBjb21wdXRlIHRoZWlyIHNvcnQgcmFua2luZy4gVGhlCiAgICAgKiBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbMjAsIDMwLCA1MF0sIDQwKTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnNvcnRlZEluZGV4KFt7ICd4JzogMjAgfSwgeyAneCc6IDMwIH0sIHsgJ3gnOiA1MCB9XSwgeyAneCc6IDQwIH0sICd4Jyk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIGRpY3QgPSB7CiAgICAgKiAgICd3b3JkVG9OdW1iZXInOiB7ICd0d2VudHknOiAyMCwgJ3RoaXJ0eSc6IDMwLCAnZm91cnR5JzogNDAsICdmaWZ0eSc6IDUwIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgICAqICAgcmV0dXJuIGRpY3Qud29yZFRvTnVtYmVyW3dvcmRdOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgICAqICAgcmV0dXJuIHRoaXMud29yZFRvTnVtYmVyW3dvcmRdOwogICAgICogfSwgZGljdCk7CiAgICAgKiAvLyA9PiAyCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGxvdyA9IDAsCiAgICAgICAgICBoaWdoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiBsb3c7CgogICAgICAvLyBleHBsaWNpdGx5IHJlZmVyZW5jZSBgaWRlbnRpdHlgIGZvciBiZXR0ZXIgaW5saW5pbmcgaW4gRmlyZWZveAogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID8gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSA6IGlkZW50aXR5OwogICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlKTsKCiAgICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgICAoY2FsbGJhY2soYXJyYXlbbWlkXSkgPCB2YWx1ZSkKICAgICAgICAgID8gbG93ID0gbWlkICsgMQogICAgICAgICAgOiBoaWdoID0gbWlkOwogICAgICB9CiAgICAgIHJldHVybiBsb3c7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCBvZiB0aGUgcHJvdmlkZWQgYXJyYXlzIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXldIFRoZSBhcnJheXMgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBjb21iaW5lZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pb24oWzEsIDIsIDNdLCBbNSwgMiwgMSwgNF0sIFsyLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNSwgNF0KICAgICAqLwogICAgZnVuY3Rpb24gdW5pb24oKSB7CiAgICAgIHJldHVybiBiYXNlVW5pcShiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSB2ZXJzaW9uIG9mIGFuIGFycmF5IHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYXJyYXkgaXMgc29ydGVkLCBwcm92aWRpbmcKICAgICAqIGB0cnVlYCBmb3IgYGlzU29ydGVkYCB3aWxsIHVzZSBhIGZhc3RlciBhbGdvcml0aG0uIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQKICAgICAqIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIGlzIHBhc3NlZCB0aHJvdWdoIHRoZSBjYWxsYmFjayBiZWZvcmUgdW5pcXVlbmVzcwogICAgICogaXMgY29tcHV0ZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyB1bmlxdWUKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTb3J0ZWQ9ZmFsc2VdIEEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGBhcnJheWAgaXMgc29ydGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pcShbMSwgMiwgMSwgMywgMV0pOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKgogICAgICogXy51bmlxKFsxLCAxLCAyLCAyLCAzXSwgdHJ1ZSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiBfLnVuaXEoWydBJywgJ2InLCAnQycsICdhJywgJ0InLCAnYyddLCBmdW5jdGlvbihsZXR0ZXIpIHsgcmV0dXJuIGxldHRlci50b0xvd2VyQ2FzZSgpOyB9KTsKICAgICAqIC8vID0+IFsnQScsICdiJywgJ0MnXQogICAgICoKICAgICAqIF8udW5pcShbMSwgMi41LCAzLCAxLjUsIDIsIDMuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgICAqIC8vID0+IFsxLCAyLjUsIDNdCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy51bmlxKFt7ICd4JzogMSB9LCB7ICd4JzogMiB9LCB7ICd4JzogMSB9XSwgJ3gnKTsKICAgICAqIC8vID0+IFt7ICd4JzogMSB9LCB7ICd4JzogMiB9XQogICAgICovCiAgICBmdW5jdGlvbiB1bmlxKGFycmF5LCBpc1NvcnRlZCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgICBpZiAodHlwZW9mIGlzU29ydGVkICE9ICdib29sZWFuJyAmJiBpc1NvcnRlZCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gKHR5cGVvZiBpc1NvcnRlZCAhPSAnZnVuY3Rpb24nICYmIHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NvcnRlZF0gPT09IGFycmF5KSA/IG51bGwgOiBpc1NvcnRlZDsKICAgICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgZXhjbHVkaW5nIGFsbCBwcm92aWRlZCB2YWx1ZXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAgICogY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFt2YWx1ZV0gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy53aXRob3V0KFsxLCAyLCAxLCAwLCAzLCAxLCA0XSwgMCwgMSk7CiAgICAgKiAvLyA9PiBbMiwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gd2l0aG91dChhcnJheSkgewogICAgICByZXR1cm4gYmFzZURpZmZlcmVuY2UoYXJyYXksIHNsaWNlKGFyZ3VtZW50cywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB0aGF0IGlzIHRoZSBzeW1tZXRyaWMgZGlmZmVyZW5jZSBvZiB0aGUgcHJvdmlkZWQgYXJyYXlzLgogICAgICogU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3ltbWV0cmljX2RpZmZlcmVuY2UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy54b3IoWzEsIDIsIDNdLCBbNSwgMiwgMSwgNF0pOwogICAgICogLy8gPT4gWzMsIDUsIDRdCiAgICAgKgogICAgICogXy54b3IoWzEsIDIsIDVdLCBbMiwgMywgNV0sIFszLCA0LCA1XSk7CiAgICAgKiAvLyA9PiBbMSwgNCwgNV0KICAgICAqLwogICAgZnVuY3Rpb24geG9yKCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBhcnJheSA9IGFyZ3VtZW50c1tpbmRleF07CiAgICAgICAgaWYgKGlzQXJyYXkoYXJyYXkpIHx8IGlzQXJndW1lbnRzKGFycmF5KSkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IHJlc3VsdAogICAgICAgICAgICA/IGJhc2VVbmlxKGJhc2VEaWZmZXJlbmNlKHJlc3VsdCwgYXJyYXkpLmNvbmNhdChiYXNlRGlmZmVyZW5jZShhcnJheSwgcmVzdWx0KSkpCiAgICAgICAgICAgIDogYXJyYXk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQgfHwgW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGdyb3VwZWQgZWxlbWVudHMsIHRoZSBmaXJzdCBvZiB3aGljaCBjb250YWlucyB0aGUgZmlyc3QKICAgICAqIGVsZW1lbnRzIG9mIHRoZSBnaXZlbiBhcnJheXMsIHRoZSBzZWNvbmQgb2Ygd2hpY2ggY29udGFpbnMgdGhlIHNlY29uZAogICAgICogZWxlbWVudHMgb2YgdGhlIGdpdmVuIGFycmF5cywgYW5kIHNvIG9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdW56aXAKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy56aXAoWydmcmVkJywgJ2Jhcm5leSddLCBbMzAsIDQwXSwgW3RydWUsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiBbWydmcmVkJywgMzAsIHRydWVdLCBbJ2Jhcm5leScsIDQwLCBmYWxzZV1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcCgpIHsKICAgICAgdmFyIGFycmF5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHMgOiBhcmd1bWVudHNbMF0sCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBtYXgocGx1Y2soYXJyYXksICdsZW5ndGgnKSkgOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gcGx1Y2soYXJyYXksIGluZGV4KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgZnJvbSBhcnJheXMgb2YgYGtleXNgIGFuZCBgdmFsdWVzYC4gUHJvdmlkZQogICAgICogZWl0aGVyIGEgc2luZ2xlIHR3byBkaW1lbnNpb25hbCBhcnJheSwgaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gCiAgICAgKiBvciB0d28gYXJyYXlzLCBvbmUgb2YgYGtleXNgIGFuZCBvbmUgb2YgY29ycmVzcG9uZGluZyBgdmFsdWVzYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIG9iamVjdAogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgYXJyYXkgb2Yga2V5cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFt2YWx1ZXM9W11dIFRoZSBhcnJheSBvZiB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4ga2V5cyBhbmQKICAgICAqICBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy56aXBPYmplY3QoWydmcmVkJywgJ2Jhcm5leSddLCBbMzAsIDQwXSk7CiAgICAgKiAvLyA9PiB7ICdmcmVkJzogMzAsICdiYXJuZXknOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcE9iamVjdChrZXlzLCB2YWx1ZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICBpZiAoIXZhbHVlcyAmJiBsZW5ndGggJiYgIWlzQXJyYXkoa2V5c1swXSkpIHsKICAgICAgICB2YWx1ZXMgPSBbXTsKICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgICAgfSBlbHNlIGlmIChrZXkpIHsKICAgICAgICAgIHJlc3VsdFtrZXlbMF1dID0ga2V5WzFdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgZXhlY3V0ZXMgYGZ1bmNgLCB3aXRoICB0aGUgYHRoaXNgIGJpbmRpbmcgYW5kCiAgICAgKiBhcmd1bWVudHMgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24sIG9ubHkgYWZ0ZXIgYmVpbmcgY2FsbGVkIGBuYCB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZnVuY3Rpb24gbXVzdCBiZSBjYWxsZWQgYmVmb3JlCiAgICAgKiAgYGZ1bmNgIGlzIGV4ZWN1dGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F2ZXMgPSBbJ3Byb2ZpbGUnLCAnc2V0dGluZ3MnXTsKICAgICAqCiAgICAgKiB2YXIgZG9uZSA9IF8uYWZ0ZXIoc2F2ZXMubGVuZ3RoLCBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ0RvbmUgc2F2aW5nIScpOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5mb3JFYWNoKHNhdmVzLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgKiAgIGFzeW5jU2F2ZSh7ICd0eXBlJzogdHlwZSwgJ2NvbXBsZXRlJzogZG9uZSB9KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnRG9uZSBzYXZpbmchJywgYWZ0ZXIgYWxsIHNhdmVzIGhhdmUgY29tcGxldGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKC0tbiA8IDEpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICAgKiBwcm92aWRlZCB0byB0aGUgYm91bmQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiB9OwogICAgICoKICAgICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdmcmVkJyB9LCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBmcmVkJwogICAgICovCiAgICBmdW5jdGlvbiBiaW5kKGZ1bmMsIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAyCiAgICAgICAgPyBjcmVhdGVXcmFwcGVyKGZ1bmMsIDE3LCBzbGljZShhcmd1bWVudHMsIDIpLCBudWxsLCB0aGlzQXJnKQogICAgICAgIDogY3JlYXRlV3JhcHBlcihmdW5jLCAxLCBudWxsLCBudWxsLCB0aGlzQXJnKTsKICAgIH0KCiAgICAvKioKICAgICAqIEJpbmRzIG1ldGhvZHMgb2YgYW4gb2JqZWN0IHRvIHRoZSBvYmplY3QgaXRzZWxmLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcKICAgICAqIG1ldGhvZC4gTWV0aG9kIG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICAgKiBvZiBtZXRob2QgbmFtZXMuIElmIG5vIG1ldGhvZCBuYW1lcyBhcmUgcHJvdmlkZWQgYWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJ0aWVzCiAgICAgKiBvZiBgb2JqZWN0YCB3aWxsIGJlIGJvdW5kLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYmluZCBhbmQgYXNzaWduIHRoZSBib3VuZCBtZXRob2RzIHRvLgogICAgICogQHBhcmFtIHsuLi5zdHJpbmd9IFttZXRob2ROYW1lXSBUaGUgb2JqZWN0IG1ldGhvZCBuYW1lcyB0bwogICAgICogIGJpbmQsIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIG1ldGhvZCBuYW1lcyBvciBhcnJheXMgb2YgbWV0aG9kIG5hbWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHZpZXcgPSB7CiAgICAgKiAgICdsYWJlbCc6ICdkb2NzJywKICAgICAqICAgJ29uQ2xpY2snOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2NsaWNrZWQgJyArIHRoaXMubGFiZWwpOyB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uYmluZEFsbCh2aWV3KTsKICAgICAqIGpRdWVyeSgnI2RvY3MnKS5vbignY2xpY2snLCB2aWV3Lm9uQ2xpY2spOwogICAgICogLy8gPT4gbG9ncyAnY2xpY2tlZCBkb2NzJywgd2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSA6IGZ1bmN0aW9ucyhvYmplY3QpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgICBvYmplY3Rba2V5XSA9IGNyZWF0ZVdyYXBwZXIob2JqZWN0W2tleV0sIDEsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyB0aGUgbWV0aG9kIGF0IGBvYmplY3Rba2V5XWAKICAgICAqIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZEtleWAgYXJndW1lbnRzIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBib3VuZAogICAgICogZnVuY3Rpb24uIFRoaXMgbWV0aG9kIGRpZmZlcnMgZnJvbSBgXy5iaW5kYCBieSBhbGxvd2luZyBib3VuZCBmdW5jdGlvbnMgdG8KICAgICAqIHJlZmVyZW5jZSBtZXRob2RzIHRoYXQgd2lsbCBiZSByZWRlZmluZWQgb3IgZG9uJ3QgeWV0IGV4aXN0LgogICAgICogU2VlIGh0dHA6Ly9taWNoYXV4LmNhL2FydGljbGVzL2xhenktZnVuY3Rpb24tZGVmaW5pdGlvbi1wYXR0ZXJuLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdGhlIG1ldGhvZCBiZWxvbmdzIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBtZXRob2QuCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnbmFtZSc6ICdmcmVkJywKICAgICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBmcmVkJwogICAgICoKICAgICAqIG9iamVjdC5ncmVldCA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgKiAgIHJldHVybiBncmVldGluZyArICd5YSAnICsgdGhpcy5uYW1lICsgJyEnOwogICAgICogfTsKICAgICAqCiAgICAgKiBmdW5jKCk7CiAgICAgKiAvLyA9PiAnaGl5YSBmcmVkIScKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEtleShvYmplY3QsIGtleSkgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIKICAgICAgICA/IGNyZWF0ZVdyYXBwZXIoa2V5LCAxOSwgc2xpY2UoYXJndW1lbnRzLCAyKSwgbnVsbCwgb2JqZWN0KQogICAgICAgIDogY3JlYXRlV3JhcHBlcihrZXksIDMsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGZ1bmN0aW9ucywKICAgICAqIHdoZXJlIGVhY2ggZnVuY3Rpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogICAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Li4uRnVuY3Rpb259IFtmdW5jXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNvbXBvc2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcmVhbE5hbWVNYXAgPSB7CiAgICAgKiAgICdwZWJibGVzJzogJ3BlbmVsb3BlJwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgZm9ybWF0ID0gZnVuY3Rpb24obmFtZSkgewogICAgICogICBuYW1lID0gcmVhbE5hbWVNYXBbbmFtZS50b0xvd2VyQ2FzZSgpXSB8fCBuYW1lOwogICAgICogICByZXR1cm4gbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZm9ybWF0dGVkKSB7CiAgICAgKiAgIHJldHVybiAnSGl5YSAnICsgZm9ybWF0dGVkICsgJyEnOwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgd2VsY29tZSA9IF8uY29tcG9zZShncmVldCwgZm9ybWF0KTsKICAgICAqIHdlbGNvbWUoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+ICdIaXlhIFBlbmVsb3BlIScKICAgICAqLwogICAgZnVuY3Rpb24gY29tcG9zZSgpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmNzW2xlbmd0aF0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBhcmdzID0gW2Z1bmNzW2xlbmd0aF0uYXBwbHkodGhpcywgYXJncyldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnc1swXTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB3aGljaCBhY2NlcHRzIG9uZSBvciBtb3JlIGFyZ3VtZW50cyBvZiBgZnVuY2AgdGhhdCB3aGVuCiAgICAgKiBpbnZva2VkIGVpdGhlciBleGVjdXRlcyBgZnVuY2AgcmV0dXJuaW5nIGl0cyByZXN1bHQsIGlmIGFsbCBgZnVuY2AgYXJndW1lbnRzCiAgICAgKiBoYXZlIGJlZW4gcHJvdmlkZWQsIG9yIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgb25lIG9yIG1vcmUgb2YgdGhlCiAgICAgKiByZW1haW5pbmcgYGZ1bmNgIGFyZ3VtZW50cywgYW5kIHNvIG9uLiBUaGUgYXJpdHkgb2YgYGZ1bmNgIGNhbiBiZSBzcGVjaWZpZWQKICAgICAqIGlmIGBmdW5jLmxlbmd0aGAgaXMgbm90IHN1ZmZpY2llbnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGN1cnJ5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcml0eT1mdW5jLmxlbmd0aF0gVGhlIGFyaXR5IG9mIGBmdW5jYC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGN1cnJpZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjdXJyaWVkID0gXy5jdXJyeShmdW5jdGlvbihhLCBiLCBjKSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGEgKyBiICsgYyk7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBjdXJyaWVkKDEpKDIpKDMpOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMikoMyk7CiAgICAgKiAvLyA9PiA2CiAgICAgKgogICAgICogY3VycmllZCgxLCAyLCAzKTsKICAgICAqIC8vID0+IDYKICAgICAqLwogICAgZnVuY3Rpb24gY3VycnkoZnVuYywgYXJpdHkpIHsKICAgICAgYXJpdHkgPSB0eXBlb2YgYXJpdHkgPT0gJ251bWJlcicgPyBhcml0eSA6ICgrYXJpdHkgfHwgZnVuYy5sZW5ndGgpOwogICAgICByZXR1cm4gY3JlYXRlV3JhcHBlcihmdW5jLCA0LCBudWxsLCBudWxsLCBudWxsLCBhcml0eSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgYGZ1bmNgIHVudGlsIGFmdGVyCiAgICAgKiBgd2FpdGAgbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBpbnZva2VkLgogICAgICogUHJvdmlkZSBhbiBvcHRpb25zIG9iamVjdCB0byBpbmRpY2F0ZSB0aGF0IGBmdW5jYCBzaG91bGQgYmUgaW52b2tlZCBvbgogICAgICogdGhlIGxlYWRpbmcgYW5kL29yIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIGB3YWl0YCB0aW1lb3V0LiBTdWJzZXF1ZW50IGNhbGxzCiAgICAgKiB0byB0aGUgZGVib3VuY2VkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICAgKgogICAgICogTm90ZTogSWYgYGxlYWRpbmdgIGFuZCBgdHJhaWxpbmdgIG9wdGlvbnMgYXJlIGB0cnVlYCBgZnVuY2Agd2lsbCBiZSBjYWxsZWQKICAgICAqIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0IG9ubHkgaWYgdGhlIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gaXMKICAgICAqIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVib3VuY2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgb2JqZWN0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5sZWFkaW5nPWZhbHNlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm1heFdhaXRdIFRoZSBtYXhpbXVtIHRpbWUgYGZ1bmNgIGlzIGFsbG93ZWQgdG8gYmUgZGVsYXllZCBiZWZvcmUgaXQncyBjYWxsZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnRyYWlsaW5nPXRydWVdIFNwZWNpZnkgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZGVib3VuY2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyBhdm9pZCBjb3N0bHkgY2FsY3VsYXRpb25zIHdoaWxlIHRoZSB3aW5kb3cgc2l6ZSBpcyBpbiBmbHV4CiAgICAgKiB2YXIgbGF6eUxheW91dCA9IF8uZGVib3VuY2UoY2FsY3VsYXRlTGF5b3V0LCAxNTApOwogICAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Jlc2l6ZScsIGxhenlMYXlvdXQpOwogICAgICoKICAgICAqIC8vIGV4ZWN1dGUgYHNlbmRNYWlsYCB3aGVuIHRoZSBjbGljayBldmVudCBpcyBmaXJlZCwgZGVib3VuY2luZyBzdWJzZXF1ZW50IGNhbGxzCiAgICAgKiBqUXVlcnkoJyNwb3N0Ym94Jykub24oJ2NsaWNrJywgXy5kZWJvdW5jZShzZW5kTWFpbCwgMzAwLCB7CiAgICAgKiAgICdsZWFkaW5nJzogdHJ1ZSwKICAgICAqICAgJ3RyYWlsaW5nJzogZmFsc2UKICAgICAqIH0pOwogICAgICoKICAgICAqIC8vIGVuc3VyZSBgYmF0Y2hMb2dgIGlzIGV4ZWN1dGVkIG9uY2UgYWZ0ZXIgMSBzZWNvbmQgb2YgZGVib3VuY2VkIGNhbGxzCiAgICAgKiB2YXIgc291cmNlID0gbmV3IEV2ZW50U291cmNlKCcvc3RyZWFtJyk7CiAgICAgKiBzb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIF8uZGVib3VuY2UoYmF0Y2hMb2csIDI1MCwgewogICAgICogICAnbWF4V2FpdCc6IDEwMDAKICAgICAqIH0sIGZhbHNlKTsKICAgICAqLwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgYXJncywKICAgICAgICAgIG1heFRpbWVvdXRJZCwKICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgIHN0YW1wLAogICAgICAgICAgdGhpc0FyZywKICAgICAgICAgIHRpbWVvdXRJZCwKICAgICAgICAgIHRyYWlsaW5nQ2FsbCwKICAgICAgICAgIGxhc3RDYWxsZWQgPSAwLAogICAgICAgICAgbWF4V2FpdCA9IGZhbHNlLAogICAgICAgICAgdHJhaWxpbmcgPSB0cnVlOwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICB3YWl0ID0gbmF0aXZlTWF4KDAsIHdhaXQpIHx8IDA7CiAgICAgIGlmIChvcHRpb25zID09PSB0cnVlKSB7CiAgICAgICAgdmFyIGxlYWRpbmcgPSB0cnVlOwogICAgICAgIHRyYWlsaW5nID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykpIHsKICAgICAgICBsZWFkaW5nID0gb3B0aW9ucy5sZWFkaW5nOwogICAgICAgIG1heFdhaXQgPSAnbWF4V2FpdCcgaW4gb3B0aW9ucyAmJiAobmF0aXZlTWF4KHdhaXQsIG9wdGlvbnMubWF4V2FpdCkgfHwgMCk7CiAgICAgICAgdHJhaWxpbmcgPSAndHJhaWxpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLnRyYWlsaW5nIDogdHJhaWxpbmc7CiAgICAgIH0KICAgICAgdmFyIGRlbGF5ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3coKSAtIHN0YW1wKTsKICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgIGlmIChtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KG1heFRpbWVvdXRJZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDYWxsZWQgPSB0cmFpbGluZ0NhbGw7CiAgICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoaXNDYWxsZWQpIHsKICAgICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgICBpZiAoIXRpbWVvdXRJZCAmJiAhbWF4VGltZW91dElkKSB7CiAgICAgICAgICAgICAgYXJncyA9IHRoaXNBcmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgbWF4RGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aW1lb3V0SWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHRyYWlsaW5nIHx8IChtYXhXYWl0ICE9PSB3YWl0KSkgewogICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICAgIGlmICghdGltZW91dElkICYmICFtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgYXJncyA9IHRoaXNBcmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIHN0YW1wID0gbm93KCk7CiAgICAgICAgdGhpc0FyZyA9IHRoaXM7CiAgICAgICAgdHJhaWxpbmdDYWxsID0gdHJhaWxpbmcgJiYgKHRpbWVvdXRJZCB8fCAhbGVhZGluZyk7CgogICAgICAgIGlmIChtYXhXYWl0ID09PSBmYWxzZSkgewogICAgICAgICAgdmFyIGxlYWRpbmdDYWxsID0gbGVhZGluZyAmJiAhdGltZW91dElkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIW1heFRpbWVvdXRJZCAmJiAhbGVhZGluZykgewogICAgICAgICAgICBsYXN0Q2FsbGVkID0gc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVtYWluaW5nID0gbWF4V2FpdCAtIChzdGFtcCAtIGxhc3RDYWxsZWQpLAogICAgICAgICAgICAgIGlzQ2FsbGVkID0gcmVtYWluaW5nIDw9IDA7CgogICAgICAgICAgaWYgKGlzQ2FsbGVkKSB7CiAgICAgICAgICAgIGlmIChtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgICBtYXhUaW1lb3V0SWQgPSBjbGVhclRpbWVvdXQobWF4VGltZW91dElkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0Q2FsbGVkID0gc3RhbXA7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICghbWF4VGltZW91dElkKSB7CiAgICAgICAgICAgIG1heFRpbWVvdXRJZCA9IHNldFRpbWVvdXQobWF4RGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzQ2FsbGVkICYmIHRpbWVvdXRJZCkgewogICAgICAgICAgdGltZW91dElkID0gY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCF0aW1lb3V0SWQgJiYgd2FpdCAhPT0gbWF4V2FpdCkgewogICAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChkZWxheWVkLCB3YWl0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlYWRpbmdDYWxsKSB7CiAgICAgICAgICBpc0NhbGxlZCA9IHRydWU7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNDYWxsZWQgJiYgIXRpbWVvdXRJZCAmJiAhbWF4VGltZW91dElkKSB7CiAgICAgICAgICBhcmdzID0gdGhpc0FyZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBEZWZlcnMgZXhlY3V0aW5nIHRoZSBgZnVuY2AgZnVuY3Rpb24gdW50aWwgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMgY2xlYXJlZC4KICAgICAqIEFkZGl0aW9uYWwgYXJndW1lbnRzIHdpbGwgYmUgcHJvdmlkZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVmZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSB0aW1lciBpZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kZWZlcihmdW5jdGlvbih0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LCAnZGVmZXJyZWQnKTsKICAgICAqIC8vIGxvZ3MgJ2RlZmVycmVkJyBhZnRlciBvbmUgb3IgbW9yZSBtaWxsaXNlY29uZHMKICAgICAqLwogICAgZnVuY3Rpb24gZGVmZXIoZnVuYykgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAxKTsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgMSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIGFmdGVyIGB3YWl0YCBtaWxsaXNlY29uZHMuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICAgKiB3aWxsIGJlIHByb3ZpZGVkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgZXhlY3V0aW9uLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgdGltZXIgaWQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGVsYXkoZnVuY3Rpb24odGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwgMTAwMCwgJ2xhdGVyJyk7CiAgICAgKiAvLyA9PiBsb2dzICdsYXRlcicgYWZ0ZXIgb25lIHNlY29uZAogICAgICovCiAgICBmdW5jdGlvbiBkZWxheShmdW5jLCB3YWl0KSB7CiAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpOwogICAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnVuYy5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOyB9LCB3YWl0KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICAgKiBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBjYWNoZSBrZXkgZm9yIHN0b3JpbmcgdGhlIHJlc3VsdAogICAgICogYmFzZWQgb24gdGhlIGFyZ3VtZW50cyBwcm92aWRlZCB0byB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uIEJ5IGRlZmF1bHQsIHRoZQogICAgICogZmlyc3QgYXJndW1lbnQgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGNhY2hlIGtleS4KICAgICAqIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIG1lbW9pemVkIGZ1bmN0aW9uLgogICAgICogVGhlIHJlc3VsdCBjYWNoZSBpcyBleHBvc2VkIGFzIHRoZSBgY2FjaGVgIHByb3BlcnR5IG9uIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc29sdmVyXSBBIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgY2FjaGUga2V5LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgbWVtb2l6aW5nIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZmlib25hY2NpID0gXy5tZW1vaXplKGZ1bmN0aW9uKG4pIHsKICAgICAqICAgcmV0dXJuIG4gPCAyID8gbiA6IGZpYm9uYWNjaShuIC0gMSkgKyBmaWJvbmFjY2kobiAtIDIpOwogICAgICogfSk7CiAgICAgKgogICAgICogZmlib25hY2NpKDkpCiAgICAgKiAvLyA9PiAzNAogICAgICoKICAgICAqIHZhciBkYXRhID0gewogICAgICogICAnZnJlZCc6IHsgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCB9LAogICAgICogICAncGViYmxlcyc6IHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqIH07CiAgICAgKgogICAgICogLy8gbW9kaWZ5aW5nIHRoZSByZXN1bHQgY2FjaGUKICAgICAqIHZhciBnZXQgPSBfLm1lbW9pemUoZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gZGF0YVtuYW1lXTsgfSwgXy5pZGVudGl0eSk7CiAgICAgKiBnZXQoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqCiAgICAgKiBnZXQuY2FjaGUucGViYmxlcy5uYW1lID0gJ3BlbmVsb3BlJzsKICAgICAqIGdldCgncGViYmxlcycpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdwZW5lbG9wZScsICdhZ2UnOiAxIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBtZW1vaXplZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWNoZSA9IG1lbW9pemVkLmNhY2hlLAogICAgICAgICAgICBrZXkgPSByZXNvbHZlciA/IHJlc29sdmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBrZXlQcmVmaXggKyBhcmd1bWVudHNbMF07CgogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICB9CiAgICAgIG1lbW9pemVkLmNhY2hlID0ge307CiAgICAgIHJldHVybiBtZW1vaXplZDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICAgKiB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHZhbHVlIG9mIHRoZSBmaXJzdCBjYWxsLiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkCiAgICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9uY2UoZnVuYykgewogICAgICB2YXIgcmFuLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHJhbikgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmFuID0gdHJ1ZTsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBuZXcgZnVuY3Rpb24uIFRoaXMKICAgICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgbmFtZTsgfTsKICAgICAqIHZhciBoaSA9IF8ucGFydGlhbChncmVldCwgJ2hpJyk7CiAgICAgKiBoaSgnZnJlZCcpOwogICAgICogLy8gPT4gJ2hpIGZyZWQnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnRpYWwoZnVuYykgewogICAgICByZXR1cm4gY3JlYXRlV3JhcHBlcihmdW5jLCAxNiwgc2xpY2UoYXJndW1lbnRzLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnBhcnRpYWxgIGV4Y2VwdCB0aGF0IGBwYXJ0aWFsYCBhcmd1bWVudHMgYXJlCiAgICAgKiBhcHBlbmRlZCB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGRlZmF1bHRzRGVlcCA9IF8ucGFydGlhbFJpZ2h0KF8ubWVyZ2UsIF8uZGVmYXVsdHMpOwogICAgICoKICAgICAqIHZhciBvcHRpb25zID0gewogICAgICogICAndmFyaWFibGUnOiAnZGF0YScsCiAgICAgKiAgICdpbXBvcnRzJzogeyAnanEnOiAkIH0KICAgICAqIH07CiAgICAgKgogICAgICogZGVmYXVsdHNEZWVwKG9wdGlvbnMsIF8udGVtcGxhdGVTZXR0aW5ncyk7CiAgICAgKgogICAgICogb3B0aW9ucy52YXJpYWJsZQogICAgICogLy8gPT4gJ2RhdGEnCiAgICAgKgogICAgICogb3B0aW9ucy5pbXBvcnRzCiAgICAgKiAvLyA9PiB7ICdfJzogXywgJ2pxJzogJCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnRpYWxSaWdodChmdW5jKSB7CiAgICAgIHJldHVybiBjcmVhdGVXcmFwcGVyKGZ1bmMsIDMyLCBudWxsLCBzbGljZShhcmd1bWVudHMsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGV4ZWN1dGVkLCB3aWxsIG9ubHkgY2FsbCB0aGUgYGZ1bmNgIGZ1bmN0aW9uCiAgICAgKiBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IGB3YWl0YCBtaWxsaXNlY29uZHMuIFByb3ZpZGUgYW4gb3B0aW9ucyBvYmplY3QgdG8KICAgICAqIGluZGljYXRlIHRoYXQgYGZ1bmNgIHNob3VsZCBiZSBpbnZva2VkIG9uIHRoZSBsZWFkaW5nIGFuZC9vciB0cmFpbGluZyBlZGdlCiAgICAgKiBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlIHRocm90dGxlZCBmdW5jdGlvbiB3aWxsCiAgICAgKiByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgICAqCiAgICAgKiBOb3RlOiBJZiBgbGVhZGluZ2AgYW5kIGB0cmFpbGluZ2Agb3B0aW9ucyBhcmUgYHRydWVgIGBmdW5jYCB3aWxsIGJlIGNhbGxlZAogICAgICogb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQgb25seSBpZiB0aGUgdGhlIHRocm90dGxlZCBmdW5jdGlvbiBpcwogICAgICogaW52b2tlZCBtb3JlIHRoYW4gb25jZSBkdXJpbmcgdGhlIGB3YWl0YCB0aW1lb3V0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB0aHJvdHRsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHRocm90dGxlIGV4ZWN1dGlvbnMgdG8uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMubGVhZGluZz10cnVlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy50cmFpbGluZz10cnVlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHRocm90dGxlZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogLy8gYXZvaWQgZXhjZXNzaXZlbHkgdXBkYXRpbmcgdGhlIHBvc2l0aW9uIHdoaWxlIHNjcm9sbGluZwogICAgICogdmFyIHRocm90dGxlZCA9IF8udGhyb3R0bGUodXBkYXRlUG9zaXRpb24sIDEwMCk7CiAgICAgKiBqUXVlcnkod2luZG93KS5vbignc2Nyb2xsJywgdGhyb3R0bGVkKTsKICAgICAqCiAgICAgKiAvLyBleGVjdXRlIGByZW5ld1Rva2VuYCB3aGVuIHRoZSBjbGljayBldmVudCBpcyBmaXJlZCwgYnV0IG5vdCBtb3JlIHRoYW4gb25jZSBldmVyeSA1IG1pbnV0ZXMKICAgICAqIGpRdWVyeSgnLmludGVyYWN0aXZlJykub24oJ2NsaWNrJywgXy50aHJvdHRsZShyZW5ld1Rva2VuLCAzMDAwMDAsIHsKICAgICAqICAgJ3RyYWlsaW5nJzogZmFsc2UKICAgICAqIH0pKTsKICAgICAqLwogICAgZnVuY3Rpb24gdGhyb3R0bGUoZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgbGVhZGluZyA9IHRydWUsCiAgICAgICAgICB0cmFpbGluZyA9IHRydWU7CgogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zID09PSBmYWxzZSkgewogICAgICAgIGxlYWRpbmcgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIGxlYWRpbmcgPSAnbGVhZGluZycgaW4gb3B0aW9ucyA/IG9wdGlvbnMubGVhZGluZyA6IGxlYWRpbmc7CiAgICAgICAgdHJhaWxpbmcgPSAndHJhaWxpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLnRyYWlsaW5nIDogdHJhaWxpbmc7CiAgICAgIH0KICAgICAgZGVib3VuY2VPcHRpb25zLmxlYWRpbmcgPSBsZWFkaW5nOwogICAgICBkZWJvdW5jZU9wdGlvbnMubWF4V2FpdCA9IHdhaXQ7CiAgICAgIGRlYm91bmNlT3B0aW9ucy50cmFpbGluZyA9IHRyYWlsaW5nOwoKICAgICAgcmV0dXJuIGRlYm91bmNlKGZ1bmMsIHdhaXQsIGRlYm91bmNlT3B0aW9ucyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBgdmFsdWVgIHRvIHRoZSB3cmFwcGVyIGZ1bmN0aW9uIGFzIGl0cwogICAgICogZmlyc3QgYXJndW1lbnQuIEFkZGl0aW9uYWwgYXJndW1lbnRzIHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbiBhcmUgYXBwZW5kZWQKICAgICAqIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSB3cmFwcGVyIGZ1bmN0aW9uLiBUaGUgd3JhcHBlciBpcyBleGVjdXRlZCB3aXRoCiAgICAgKiB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB3cmFwcGVyIFRoZSB3cmFwcGVyIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBwID0gXy53cmFwKF8uZXNjYXBlLCBmdW5jdGlvbihmdW5jLCB0ZXh0KSB7CiAgICAgKiAgIHJldHVybiAnPHA+JyArIGZ1bmModGV4dCkgKyAnPC9wPic7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBwKCdGcmVkLCBXaWxtYSwgJiBQZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnPHA+RnJlZCwgV2lsbWEsICZhbXA7IFBlYmJsZXM8L3A+JwogICAgICovCiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCB3cmFwcGVyKSB7CiAgICAgIHJldHVybiBjcmVhdGVXcmFwcGVyKHdyYXBwZXIsIDE2LCBbdmFsdWVdKTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYHZhbHVlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcmV0dXJuIGZyb20gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdmcmVkJyB9OwogICAgICogdmFyIGdldHRlciA9IF8uY29uc3RhbnQob2JqZWN0KTsKICAgICAqIGdldHRlcigpID09PSBvYmplY3Q7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbnN0YW50KHZhbHVlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIGNhbGxiYWNrIGJvdW5kIHRvIGFuIG9wdGlvbmFsIGB0aGlzQXJnYC4gSWYgYGZ1bmNgIGlzIGEgcHJvcGVydHkKICAgICAqIG5hbWUgdGhlIGNyZWF0ZWQgY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIGZvciBhIGdpdmVuIGVsZW1lbnQuCiAgICAgKiBJZiBgZnVuY2AgaXMgYW4gb2JqZWN0IHRoZSBjcmVhdGVkIGNhbGxiYWNrIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMKICAgICAqIHRoYXQgY29udGFpbiB0aGUgZXF1aXZhbGVudCBvYmplY3QgcHJvcGVydGllcywgb3RoZXJ3aXNlIGl0IHdpbGwgcmV0dXJuIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7Kn0gW2Z1bmM9aWRlbnRpdHldIFRoZSB2YWx1ZSB0byBjb252ZXJ0IHRvIGEgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyZ0NvdW50XSBUaGUgbnVtYmVyIG9mIGFyZ3VtZW50cyB0aGUgY2FsbGJhY2sgYWNjZXB0cy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBhIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB3cmFwIHRvIGNyZWF0ZSBjdXN0b20gY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICogXy5jcmVhdGVDYWxsYmFjayA9IF8ud3JhcChfLmNyZWF0ZUNhbGxiYWNrLCBmdW5jdGlvbihmdW5jLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICogICB2YXIgbWF0Y2ggPSAvXiguKz8pX18oW2dsXXQpKC4rKSQvLmV4ZWMoY2FsbGJhY2spOwogICAgICogICByZXR1cm4gIW1hdGNoID8gZnVuYyhjYWxsYmFjaywgdGhpc0FyZykgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAqICAgICByZXR1cm4gbWF0Y2hbMl0gPT0gJ2d0JyA/IG9iamVjdFttYXRjaFsxXV0gPiBtYXRjaFszXSA6IG9iamVjdFttYXRjaFsxXV0gPCBtYXRjaFszXTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICoKICAgICAqIF8uZmlsdGVyKGNoYXJhY3RlcnMsICdhZ2VfX2d0MzgnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfV0KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYXJnQ291bnQpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgICAgaWYgKGZ1bmMgPT0gbnVsbCB8fCB0eXBlID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KTsKICAgICAgfQogICAgICAvLyBoYW5kbGUgIl8ucGx1Y2siIHN0eWxlIGNhbGxiYWNrIHNob3J0aGFuZHMKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkoZnVuYyk7CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKSwKICAgICAgICAgIGtleSA9IHByb3BzWzBdLAogICAgICAgICAgYSA9IGZ1bmNba2V5XTsKCiAgICAgIC8vIGhhbmRsZSAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICBpZiAocHJvcHMubGVuZ3RoID09IDEgJiYgYSA9PT0gYSAmJiAhaXNPYmplY3QoYSkpIHsKICAgICAgICAvLyBmYXN0IHBhdGggdGhlIGNvbW1vbiBjYXNlIG9mIHByb3ZpZGluZyBhbiBvYmplY3Qgd2l0aCBhIHNpbmdsZQogICAgICAgIC8vIHByb3BlcnR5IGNvbnRhaW5pbmcgYSBwcmltaXRpdmUgdmFsdWUKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB2YXIgYiA9IG9iamVjdFtrZXldOwogICAgICAgICAgcmV0dXJuIGEgPT09IGIgJiYgKGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwob2JqZWN0W3Byb3BzW2xlbmd0aF1dLCBmdW5jW3Byb3BzW2xlbmd0aF1dLCBudWxsLCB0cnVlKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgY2hhcmFjdGVycyBgJmAsIGA8YCwgYD5gLCBgImAsIGFuZCBgJ2AgaW4gYHN0cmluZ2AgdG8gdGhlaXIKICAgICAqIGNvcnJlc3BvbmRpbmcgSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGVzY2FwZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmVzY2FwZSgnRnJlZCwgV2lsbWEsICYgUGViYmxlcycpOwogICAgICogLy8gPT4gJ0ZyZWQsIFdpbG1hLCAmYW1wOyBQZWJibGVzJwogICAgICovCiAgICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IHByb3ZpZGVkIHRvIGl0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIEFueSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKiBfLmlkZW50aXR5KG9iamVjdCkgPT09IG9iamVjdDsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQWRkcyBmdW5jdGlvbiBwcm9wZXJ0aWVzIG9mIGEgc291cmNlIG9iamVjdCB0byB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogSWYgYG9iamVjdGAgaXMgYSBmdW5jdGlvbiBtZXRob2RzIHdpbGwgYmUgYWRkZWQgdG8gaXRzIHByb3RvdHlwZSBhcyB3ZWxsLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdH0gW29iamVjdD1sb2Rhc2hdIG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIGZ1bmN0aW9ucyB0byBhZGQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuY2hhaW49dHJ1ZV0gU3BlY2lmeSB3aGV0aGVyIHRoZSBmdW5jdGlvbnMgYWRkZWQgYXJlIGNoYWluYWJsZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gY2FwaXRhbGl6ZShzdHJpbmcpIHsKICAgICAqICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogfQogICAgICoKICAgICAqIF8ubWl4aW4oeyAnY2FwaXRhbGl6ZSc6IGNhcGl0YWxpemUgfSk7CiAgICAgKiBfLmNhcGl0YWxpemUoJ2ZyZWQnKTsKICAgICAqIC8vID0+ICdGcmVkJwogICAgICoKICAgICAqIF8oJ2ZyZWQnKS5jYXBpdGFsaXplKCkudmFsdWUoKTsKICAgICAqIC8vID0+ICdGcmVkJwogICAgICoKICAgICAqIF8ubWl4aW4oeyAnY2FwaXRhbGl6ZSc6IGNhcGl0YWxpemUgfSwgeyAnY2hhaW4nOiBmYWxzZSB9KTsKICAgICAqIF8oJ2ZyZWQnKS5jYXBpdGFsaXplKCk7CiAgICAgKiAvLyA9PiAnRnJlZCcKICAgICAqLwogICAgZnVuY3Rpb24gbWl4aW4ob2JqZWN0LCBzb3VyY2UsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNoYWluID0gdHJ1ZSwKICAgICAgICAgIG1ldGhvZE5hbWVzID0gc291cmNlICYmIGZ1bmN0aW9ucyhzb3VyY2UpOwoKICAgICAgaWYgKCFzb3VyY2UgfHwgKCFvcHRpb25zICYmICFtZXRob2ROYW1lcy5sZW5ndGgpKSB7CiAgICAgICAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewogICAgICAgICAgb3B0aW9ucyA9IHNvdXJjZTsKICAgICAgICB9CiAgICAgICAgY3RvciA9IGxvZGFzaFdyYXBwZXI7CiAgICAgICAgc291cmNlID0gb2JqZWN0OwogICAgICAgIG9iamVjdCA9IGxvZGFzaDsKICAgICAgICBtZXRob2ROYW1lcyA9IGZ1bmN0aW9ucyhzb3VyY2UpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zID09PSBmYWxzZSkgewogICAgICAgIGNoYWluID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykgJiYgJ2NoYWluJyBpbiBvcHRpb25zKSB7CiAgICAgICAgY2hhaW4gPSBvcHRpb25zLmNoYWluOwogICAgICB9CiAgICAgIHZhciBjdG9yID0gb2JqZWN0LAogICAgICAgICAgaXNGdW5jID0gaXNGdW5jdGlvbihjdG9yKTsKCiAgICAgIGZvckVhY2gobWV0aG9kTmFtZXMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgZnVuYyA9IG9iamVjdFttZXRob2ROYW1lXSA9IHNvdXJjZVttZXRob2ROYW1lXTsKICAgICAgICBpZiAoaXNGdW5jKSB7CiAgICAgICAgICBjdG9yLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2hhaW5BbGwgPSB0aGlzLl9fY2hhaW5fXywKICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXywKICAgICAgICAgICAgICAgIGFyZ3MgPSBbdmFsdWVdOwoKICAgICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShvYmplY3QsIGFyZ3MpOwogICAgICAgICAgICBpZiAoY2hhaW4gfHwgY2hhaW5BbGwpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IHJlc3VsdCAmJiBpc09iamVjdChyZXN1bHQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IGN0b3IocmVzdWx0KTsKICAgICAgICAgICAgICByZXN1bHQuX19jaGFpbl9fID0gY2hhaW5BbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldmVydHMgdGhlICdfJyB2YXJpYWJsZSB0byBpdHMgcHJldmlvdXMgdmFsdWUgYW5kIHJldHVybnMgYSByZWZlcmVuY2UgdG8KICAgICAqIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGxvZGFzaCA9IF8ubm9Db25mbGljdCgpOwogICAgICovCiAgICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgICBjb250ZXh0Ll8gPSBvbGREYXNoOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIEEgbm8tb3BlcmF0aW9uIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKiBfLm5vb3Aob2JqZWN0KSA9PT0gdW5kZWZpbmVkOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkgewogICAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgaGF2ZSBlbGFwc2VkIHNpbmNlIHRoZSBVbml4IGVwb2NoCiAgICAgKiAoMSBKYW51YXJ5IDE5NzAgMDA6MDA6MDAgVVRDKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3RhbXAgPSBfLm5vdygpOwogICAgICogXy5kZWZlcihmdW5jdGlvbigpIHsgY29uc29sZS5sb2coXy5ub3coKSAtIHN0YW1wKTsgfSk7CiAgICAgKiAvLyA9PiBsb2dzIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGl0IHRvb2sgZm9yIHRoZSBkZWZlcnJlZCBmdW5jdGlvbiB0byBiZSBjYWxsZWQKICAgICAqLwogICAgdmFyIG5vdyA9IGlzTmF0aXZlKG5vdyA9IERhdGUubm93KSAmJiBub3cgfHwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gdmFsdWUgaW50byBhbiBpbnRlZ2VyIG9mIHRoZSBzcGVjaWZpZWQgcmFkaXguCiAgICAgKiBJZiBgcmFkaXhgIGlzIGB1bmRlZmluZWRgIG9yIGAwYCBhIGByYWRpeGAgb2YgYDEwYCBpcyB1c2VkIHVubGVzcyB0aGUKICAgICAqIGB2YWx1ZWAgaXMgYSBoZXhhZGVjaW1hbCwgaW4gd2hpY2ggY2FzZSBhIGByYWRpeGAgb2YgYDE2YCBpcyB1c2VkLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGF2b2lkcyBkaWZmZXJlbmNlcyBpbiBuYXRpdmUgRVMzIGFuZCBFUzUgYHBhcnNlSW50YAogICAgICogaW1wbGVtZW50YXRpb25zLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI0UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFyc2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl4XSBUaGUgcmFkaXggdXNlZCB0byBpbnRlcnByZXQgdGhlIHZhbHVlIHRvIHBhcnNlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbmV3IGludGVnZXIgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFyc2VJbnQoJzA4Jyk7CiAgICAgKiAvLyA9PiA4CiAgICAgKi8KICAgIHZhciBwYXJzZUludCA9IG5hdGl2ZVBhcnNlSW50KHdoaXRlc3BhY2UgKyAnMDgnKSA9PSA4ID8gbmF0aXZlUGFyc2VJbnQgOiBmdW5jdGlvbih2YWx1ZSwgcmFkaXgpIHsKICAgICAgLy8gRmlyZWZveCA8IDIxIGFuZCBPcGVyYSA8IDE1IGZvbGxvdyB0aGUgRVMzIHNwZWNpZmllZCBpbXBsZW1lbnRhdGlvbiBvZiBgcGFyc2VJbnRgCiAgICAgIHJldHVybiBuYXRpdmVQYXJzZUludChpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKHJlTGVhZGluZ1NwYWNlc0FuZFplcm9zLCAnJykgOiB2YWx1ZSwgcmFkaXggfHwgMCk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhICJfLnBsdWNrIiBzdHlsZSBmdW5jdGlvbiwgd2hpY2ggcmV0dXJucyB0aGUgYGtleWAgdmFsdWUgb2YgYQogICAgICogZ2l2ZW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfQogICAgICogXTsKICAgICAqCiAgICAgKiB2YXIgZ2V0TmFtZSA9IF8ucHJvcGVydHkoJ25hbWUnKTsKICAgICAqCiAgICAgKiBfLm1hcChjaGFyYWN0ZXJzLCBnZXROYW1lKTsKICAgICAqIC8vID0+IFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICoKICAgICAqIF8uc29ydEJ5KGNoYXJhY3RlcnMsIGdldE5hbWUpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHByb3BlcnR5KGtleSkgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIG9iamVjdFtrZXldOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUHJvZHVjZXMgYSByYW5kb20gbnVtYmVyIGJldHdlZW4gYG1pbmAgYW5kIGBtYXhgIChpbmNsdXNpdmUpLiBJZiBvbmx5IG9uZQogICAgICogYXJndW1lbnQgaXMgcHJvdmlkZWQgYSBudW1iZXIgYmV0d2VlbiBgMGAgYW5kIHRoZSBnaXZlbiBudW1iZXIgd2lsbCBiZQogICAgICogcmV0dXJuZWQuIElmIGBmbG9hdGluZ2AgaXMgdHJ1ZXkgb3IgZWl0aGVyIGBtaW5gIG9yIGBtYXhgIGFyZSBmbG9hdHMgYQogICAgICogZmxvYXRpbmctcG9pbnQgbnVtYmVyIHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZCBvZiBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21pbj0wXSBUaGUgbWluaW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4PTFdIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHBhcmFtIHtib29sZWFufSBbZmxvYXRpbmc9ZmFsc2VdIFNwZWNpZnkgcmV0dXJuaW5nIGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyBhIHJhbmRvbSBudW1iZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZG9tKDAsIDUpOwogICAgICogLy8gPT4gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1KTsKICAgICAqIC8vID0+IGFsc28gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1LCB0cnVlKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDEuMiwgNS4yKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMS4yIGFuZCA1LjIKICAgICAqLwogICAgZnVuY3Rpb24gcmFuZG9tKG1pbiwgbWF4LCBmbG9hdGluZykgewogICAgICB2YXIgbm9NaW4gPSBtaW4gPT0gbnVsbCwKICAgICAgICAgIG5vTWF4ID0gbWF4ID09IG51bGw7CgogICAgICBpZiAoZmxvYXRpbmcgPT0gbnVsbCkgewogICAgICAgIGlmICh0eXBlb2YgbWluID09ICdib29sZWFuJyAmJiBub01heCkgewogICAgICAgICAgZmxvYXRpbmcgPSBtaW47CiAgICAgICAgICBtaW4gPSAxOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghbm9NYXggJiYgdHlwZW9mIG1heCA9PSAnYm9vbGVhbicpIHsKICAgICAgICAgIGZsb2F0aW5nID0gbWF4OwogICAgICAgICAgbm9NYXggPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9NaW4gJiYgbm9NYXgpIHsKICAgICAgICBtYXggPSAxOwogICAgICB9CiAgICAgIG1pbiA9ICttaW4gfHwgMDsKICAgICAgaWYgKG5vTWF4KSB7CiAgICAgICAgbWF4ID0gbWluOwogICAgICAgIG1pbiA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF4ID0gK21heCB8fCAwOwogICAgICB9CiAgICAgIGlmIChmbG9hdGluZyB8fCBtaW4gJSAxIHx8IG1heCAlIDEpIHsKICAgICAgICB2YXIgcmFuZCA9IG5hdGl2ZVJhbmRvbSgpOwogICAgICAgIHJldHVybiBuYXRpdmVNaW4obWluICsgKHJhbmQgKiAobWF4IC0gbWluICsgcGFyc2VGbG9hdCgnMWUtJyArICgocmFuZCArJycpLmxlbmd0aCAtIDEpKSkpLCBtYXgpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlUmFuZG9tKG1pbiwgbWF4KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSB2YWx1ZSBvZiBwcm9wZXJ0eSBga2V5YCBvbiBgb2JqZWN0YC4gSWYgYGtleWAgaXMgYSBmdW5jdGlvbgogICAgICogaXQgd2lsbCBiZSBpbnZva2VkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBvYmplY3RgIGFuZCBpdHMgcmVzdWx0IHJldHVybmVkLAogICAgICogZWxzZSB0aGUgcHJvcGVydHkgdmFsdWUgaXMgcmV0dXJuZWQuIElmIGBvYmplY3RgIGlzIGZhbHNleSB0aGVuIGB1bmRlZmluZWRgCiAgICAgKiBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byByZXNvbHZlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgcmV0dXJuICdub25zZW5zZSc7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgICAqIC8vID0+ICdub25zZW5zZScKICAgICAqLwogICAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwga2V5KSB7CiAgICAgIGlmIChvYmplY3QpIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKICAgICAgICByZXR1cm4gaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3Rba2V5XSgpIDogdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgICAqIHdoaXRlc3BhY2UsIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogICAgICoKICAgICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCwgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHByZWNvbXBpbGluZyB0ZW1wbGF0ZXMgc2VlOgogICAgICogaHR0cDovL2xvZGFzaC5jb20vY3VzdG9tLWJ1aWxkcwogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIENocm9tZSBleHRlbnNpb24gc2FuZGJveGVzIHNlZToKICAgICAqIGh0dHA6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS9zdGFibGUvZXh0ZW5zaW9ucy9zYW5kYm94aW5nRXZhbC5odG1sCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRoZSB0ZW1wbGF0ZSB0ZXh0LgogICAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgb2JqZWN0IHVzZWQgdG8gcG9wdWxhdGUgdGhlIHRleHQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7UmVnRXhwfSBbb3B0aW9ucy5lc2NhcGVdIFRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuZXZhbHVhdGVdIFRoZSAiZXZhbHVhdGUiIGRlbGltaXRlci4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy5pbXBvcnRzXSBBbiBvYmplY3QgdG8gaW1wb3J0IGludG8gdGhlIHRlbXBsYXRlIGFzIGxvY2FsIHZhcmlhYmxlcy4KICAgICAqIEBwYXJhbSB7UmVnRXhwfSBbb3B0aW9ucy5pbnRlcnBvbGF0ZV0gVGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzb3VyY2VVUkxdIFRoZSBzb3VyY2VVUkwgb2YgdGhlIHRlbXBsYXRlJ3MgY29tcGlsZWQgc291cmNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFt2YXJpYWJsZV0gVGhlIGRhdGEgb2JqZWN0IHZhcmlhYmxlIG5hbWUuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb258c3RyaW5nfSBSZXR1cm5zIGEgY29tcGlsZWQgZnVuY3Rpb24gd2hlbiBubyBgZGF0YWAgb2JqZWN0CiAgICAgKiAgaXMgZ2l2ZW4sIGVsc2UgaXQgcmV0dXJucyB0aGUgaW50ZXJwb2xhdGVkIHRleHQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiaW50ZXJwb2xhdGUiIGRlbGltaXRlciB0byBjcmVhdGUgYSBjb21waWxlZCB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nKTsKICAgICAqIGNvbXBpbGVkKHsgJ25hbWUnOiAnZnJlZCcgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gZnJlZCcKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImVzY2FwZSIgZGVsaW1pdGVyIHRvIGVzY2FwZSBIVE1MIGluIGRhdGEgcHJvcGVydHkgdmFsdWVzCiAgICAgKiBfLnRlbXBsYXRlKCc8Yj48JS0gdmFsdWUgJT48L2I+JywgeyAndmFsdWUnOiAnPHNjcmlwdD4nIH0pOwogICAgICogLy8gPT4gJzxiPiZsdDtzY3JpcHQmZ3Q7PC9iPicKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImV2YWx1YXRlIiBkZWxpbWl0ZXIgdG8gZ2VuZXJhdGUgSFRNTAogICAgICogdmFyIGxpc3QgPSAnPCUgXy5mb3JFYWNoKHBlb3BsZSwgZnVuY3Rpb24obmFtZSkgeyAlPjxsaT48JS0gbmFtZSAlPjwvbGk+PCUgfSk7ICU+JzsKICAgICAqIF8udGVtcGxhdGUobGlzdCwgeyAncGVvcGxlJzogWydmcmVkJywgJ2Jhcm5leSddIH0pOwogICAgICogLy8gPT4gJzxsaT5mcmVkPC9saT48bGk+YmFybmV5PC9saT4nCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIEVTNiBkZWxpbWl0ZXIgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmF1bHQgImludGVycG9sYXRlIiBkZWxpbWl0ZXIKICAgICAqIF8udGVtcGxhdGUoJ2hlbGxvICR7IG5hbWUgfScsIHsgJ25hbWUnOiAncGViYmxlcycgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gcGViYmxlcycKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGUoJzwlIHByaW50KCJoZWxsbyAiICsgbmFtZSk7ICU+IScsIHsgJ25hbWUnOiAnYmFybmV5JyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBiYXJuZXkhJwogICAgICoKICAgICAqIC8vIHVzaW5nIGEgY3VzdG9tIHRlbXBsYXRlIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgICAqICAgJ2ludGVycG9sYXRlJzogL3t7KFtcc1xTXSs/KX19L2cKICAgICAqIH07CiAgICAgKgogICAgICogXy50ZW1wbGF0ZSgnaGVsbG8ge3sgbmFtZSB9fSEnLCB7ICduYW1lJzogJ211c3RhY2hlJyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBtdXN0YWNoZSEnCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGBpbXBvcnRzYCBvcHRpb24gdG8gaW1wb3J0IGpRdWVyeQogICAgICogdmFyIGxpc3QgPSAnPCUganEuZWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCUtIG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnZnJlZCcsICdiYXJuZXknXSB9LCB7ICdpbXBvcnRzJzogeyAnanEnOiBqUXVlcnkgfSB9KTsKICAgICAqIC8vID0+ICc8bGk+ZnJlZDwvbGk+PGxpPmJhcm5leTwvbGk+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgc291cmNlVVJMYCBvcHRpb24gdG8gc3BlY2lmeSBhIGN1c3RvbSBzb3VyY2VVUkwgZm9yIHRoZSB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nLCBudWxsLCB7ICdzb3VyY2VVUkwnOiAnL2Jhc2ljL2dyZWV0aW5nLmpzdCcgfSk7CiAgICAgKiBjb21waWxlZChkYXRhKTsKICAgICAqIC8vID0+IGZpbmQgdGhlIHNvdXJjZSBvZiAiZ3JlZXRpbmcuanN0IiB1bmRlciB0aGUgU291cmNlcyB0YWIgb3IgUmVzb3VyY2VzIHBhbmVsIG9mIHRoZSB3ZWIgaW5zcGVjdG9yCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGB2YXJpYWJsZWAgb3B0aW9uIHRvIGVuc3VyZSBhIHdpdGgtc3RhdGVtZW50IGlzbid0IHVzZWQgaW4gdGhlIGNvbXBpbGVkIHRlbXBsYXRlCiAgICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoaSA8JT0gZGF0YS5uYW1lICU+IScsIG51bGwsIHsgJ3ZhcmlhYmxlJzogJ2RhdGEnIH0pOwogICAgICogY29tcGlsZWQuc291cmNlOwogICAgICogLy8gPT4gZnVuY3Rpb24oZGF0YSkgewogICAgICogICB2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGU7CiAgICAgKiAgIF9fcCArPSAnaGkgJyArICgoX190ID0gKCBkYXRhLm5hbWUgKSkgPT0gbnVsbCA/ICcnIDogX190KSArICchJzsKICAgICAqICAgcmV0dXJuIF9fcDsKICAgICAqIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZWAgcHJvcGVydHkgdG8gaW5saW5lIGNvbXBpbGVkIHRlbXBsYXRlcyBmb3IgbWVhbmluZ2Z1bAogICAgICogLy8gbGluZSBudW1iZXJzIGluIGVycm9yIG1lc3NhZ2VzIGFuZCBhIHN0YWNrIHRyYWNlCiAgICAgKiBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihjd2QsICdqc3QuanMnKSwgJ1wKICAgICAqICAgdmFyIEpTVCA9IHtcCiAgICAgKiAgICAgIm1haW4iOiAnICsgXy50ZW1wbGF0ZShtYWluVGV4dCkuc291cmNlICsgJ1wKICAgICAqICAgfTtcCiAgICAgKiAnKTsKICAgICAqLwogICAgZnVuY3Rpb24gdGVtcGxhdGUodGV4dCwgZGF0YSwgb3B0aW9ucykgewogICAgICAvLyBiYXNlZCBvbiBKb2huIFJlc2lnJ3MgYHRtcGxgIGltcGxlbWVudGF0aW9uCiAgICAgIC8vIGh0dHA6Ly9lam9obi5vcmcvYmxvZy9qYXZhc2NyaXB0LW1pY3JvLXRlbXBsYXRpbmcvCiAgICAgIC8vIGFuZCBMYXVyYSBEb2t0b3JvdmEncyBkb1QuanMKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL29sYWRvL2RvVAogICAgICB2YXIgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5nczsKICAgICAgdGV4dCA9IFN0cmluZyh0ZXh0IHx8ICcnKTsKCiAgICAgIC8vIGF2b2lkIG1pc3NpbmcgZGVwZW5kZW5jaWVzIHdoZW4gYGl0ZXJhdG9yVGVtcGxhdGVgIGlzIG5vdCBkZWZpbmVkCiAgICAgIG9wdGlvbnMgPSBkZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0dGluZ3MpOwoKICAgICAgdmFyIGltcG9ydHMgPSBkZWZhdWx0cyh7fSwgb3B0aW9ucy5pbXBvcnRzLCBzZXR0aW5ncy5pbXBvcnRzKSwKICAgICAgICAgIGltcG9ydHNLZXlzID0ga2V5cyhpbXBvcnRzKSwKICAgICAgICAgIGltcG9ydHNWYWx1ZXMgPSB2YWx1ZXMoaW1wb3J0cyk7CgogICAgICB2YXIgaXNFdmFsdWF0aW5nLAogICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgaW50ZXJwb2xhdGUgPSBvcHRpb25zLmludGVycG9sYXRlIHx8IHJlTm9NYXRjaCwKICAgICAgICAgIHNvdXJjZSA9ICJfX3AgKz0gJyI7CgogICAgICAvLyBjb21waWxlIHRoZSByZWdleHAgdG8gbWF0Y2ggZWFjaCBkZWxpbWl0ZXIKICAgICAgdmFyIHJlRGVsaW1pdGVycyA9IFJlZ0V4cCgKICAgICAgICAob3B0aW9ucy5lc2NhcGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICAgIGludGVycG9sYXRlLnNvdXJjZSArICd8JyArCiAgICAgICAgKGludGVycG9sYXRlID09PSByZUludGVycG9sYXRlID8gcmVFc1RlbXBsYXRlIDogcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICAgIChvcHRpb25zLmV2YWx1YXRlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wkJwogICAgICAsICdnJyk7CgogICAgICB0ZXh0LnJlcGxhY2UocmVEZWxpbWl0ZXJzLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlVmFsdWUsIGludGVycG9sYXRlVmFsdWUsIGVzVGVtcGxhdGVWYWx1ZSwgZXZhbHVhdGVWYWx1ZSwgb2Zmc2V0KSB7CiAgICAgICAgaW50ZXJwb2xhdGVWYWx1ZSB8fCAoaW50ZXJwb2xhdGVWYWx1ZSA9IGVzVGVtcGxhdGVWYWx1ZSk7CgogICAgICAgIC8vIGVzY2FwZSBjaGFyYWN0ZXJzIHRoYXQgY2Fubm90IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscwogICAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpLnJlcGxhY2UocmVVbmVzY2FwZWRTdHJpbmcsIGVzY2FwZVN0cmluZ0NoYXIpOwoKICAgICAgICAvLyByZXBsYWNlIGRlbGltaXRlcnMgd2l0aCBzbmlwcGV0cwogICAgICAgIGlmIChlc2NhcGVWYWx1ZSkgewogICAgICAgICAgc291cmNlICs9ICInICtcbl9fZSgiICsgZXNjYXBlVmFsdWUgKyAiKSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaWYgKGV2YWx1YXRlVmFsdWUpIHsKICAgICAgICAgIGlzRXZhbHVhdGluZyA9IHRydWU7CiAgICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGVWYWx1ZSArICI7XG5fX3AgKz0gJyI7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlcnBvbGF0ZVZhbHVlKSB7CiAgICAgICAgICBzb3VyY2UgKz0gIicgK1xuKChfX3QgPSAoIiArIGludGVycG9sYXRlVmFsdWUgKyAiKSkgPT0gbnVsbCA/ICcnIDogX190KSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CgogICAgICAgIC8vIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgcHJvZHVjdHMgcmVxdWlyZXMgcmV0dXJuaW5nIHRoZSBgbWF0Y2hgCiAgICAgICAgLy8gc3RyaW5nIGluIG9yZGVyIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3QgYG9mZnNldGAgdmFsdWUKICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgIH0pOwoKICAgICAgc291cmNlICs9ICInO1xuIjsKCiAgICAgIC8vIGlmIGB2YXJpYWJsZWAgaXMgbm90IHNwZWNpZmllZCwgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkCiAgICAgIC8vIGNvZGUgdG8gYWRkIHRoZSBkYXRhIG9iamVjdCB0byB0aGUgdG9wIG9mIHRoZSBzY29wZSBjaGFpbgogICAgICB2YXIgdmFyaWFibGUgPSBvcHRpb25zLnZhcmlhYmxlLAogICAgICAgICAgaGFzVmFyaWFibGUgPSB2YXJpYWJsZTsKCiAgICAgIGlmICghaGFzVmFyaWFibGUpIHsKICAgICAgICB2YXJpYWJsZSA9ICdvYmonOwogICAgICAgIHNvdXJjZSA9ICd3aXRoICgnICsgdmFyaWFibGUgKyAnKSB7XG4nICsgc291cmNlICsgJ1xufVxuJzsKICAgICAgfQogICAgICAvLyBjbGVhbnVwIGNvZGUgYnkgc3RyaXBwaW5nIGVtcHR5IHN0cmluZ3MKICAgICAgc291cmNlID0gKGlzRXZhbHVhdGluZyA/IHNvdXJjZS5yZXBsYWNlKHJlRW1wdHlTdHJpbmdMZWFkaW5nLCAnJykgOiBzb3VyY2UpCiAgICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgICAucmVwbGFjZShyZUVtcHR5U3RyaW5nVHJhaWxpbmcsICckMTsnKTsKCiAgICAgIC8vIGZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkKICAgICAgc291cmNlID0gJ2Z1bmN0aW9uKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKwogICAgICAgIChoYXNWYXJpYWJsZSA/ICcnIDogdmFyaWFibGUgKyAnIHx8ICgnICsgdmFyaWFibGUgKyAnID0ge30pO1xuJykgKwogICAgICAgICJ2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGUiICsKICAgICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgICA/ICcsIF9faiA9IEFycmF5LnByb3RvdHlwZS5qb2luO1xuJyArCiAgICAgICAgICAgICJmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgJycpIH1cbiIKICAgICAgICAgIDogJztcbicKICAgICAgICApICsKICAgICAgICBzb3VyY2UgKwogICAgICAgICdyZXR1cm4gX19wXG59JzsKCiAgICAgIC8vIFVzZSBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZy4KICAgICAgLy8gaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICB2YXIgc291cmNlVVJMID0gJ1xuLypcbi8vIyBzb3VyY2VVUkw9JyArIChvcHRpb25zLnNvdXJjZVVSTCB8fCAnL2xvZGFzaC90ZW1wbGF0ZS9zb3VyY2VbJyArICh0ZW1wbGF0ZUNvdW50ZXIrKykgKyAnXScpICsgJ1xuKi8nOwoKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcmVzdWx0ID0gRnVuY3Rpb24oaW1wb3J0c0tleXMsICdyZXR1cm4gJyArIHNvdXJjZSArIHNvdXJjZVVSTCkuYXBwbHkodW5kZWZpbmVkLCBpbXBvcnRzVmFsdWVzKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgICBpZiAoZGF0YSkgewogICAgICAgIHJldHVybiByZXN1bHQoZGF0YSk7CiAgICAgIH0KICAgICAgLy8gcHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24ncyBzb3VyY2UgYnkgaXRzIGB0b1N0cmluZ2AgbWV0aG9kLCBpbgogICAgICAvLyBzdXBwb3J0ZWQgZW52aXJvbm1lbnRzLCBvciB0aGUgYHNvdXJjZWAgcHJvcGVydHkgYXMgYSBjb252ZW5pZW5jZSBmb3IKICAgICAgLy8gaW5saW5pbmcgY29tcGlsZWQgdGVtcGxhdGVzIGR1cmluZyB0aGUgYnVpbGQgcHJvY2VzcwogICAgICByZXN1bHQuc291cmNlID0gc291cmNlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGNhbGxiYWNrIGBuYCB0aW1lcywgcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzCiAgICAgKiBvZiBlYWNoIGNhbGxiYWNrIGV4ZWN1dGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAgICogd2l0aCBvbmUgYXJndW1lbnQ7IChpbmRleCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGBjYWxsYmFja2AgZXhlY3V0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZGljZVJvbGxzID0gXy50aW1lcygzLCBfLnBhcnRpYWwoXy5yYW5kb20sIDEsIDYpKTsKICAgICAqIC8vID0+IFszLCA2LCA0XQogICAgICoKICAgICAqIF8udGltZXMoMywgZnVuY3Rpb24obikgeyBtYWdlLmNhc3RTcGVsbChuKTsgfSk7CiAgICAgKiAvLyA9PiBjYWxscyBgbWFnZS5jYXN0U3BlbGwobilgIHRocmVlIHRpbWVzLCBwYXNzaW5nIGBuYCBvZiBgMGAsIGAxYCwgYW5kIGAyYCByZXNwZWN0aXZlbHkKICAgICAqCiAgICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgdGhpcy5jYXN0KG4pOyB9LCBtYWdlKTsKICAgICAqIC8vID0+IGFsc28gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcwogICAgICovCiAgICBmdW5jdGlvbiB0aW1lcyhuLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBuID0gKG4gPSArbikgPiAtMSA/IG4gOiAwOwogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KG4pOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDEpOwogICAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soaW5kZXgpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgaW52ZXJzZSBvZiBgXy5lc2NhcGVgIHRoaXMgbWV0aG9kIGNvbnZlcnRzIHRoZSBIVE1MIGVudGl0aWVzCiAgICAgKiBgJmFtcDtgLCBgJmx0O2AsIGAmZ3Q7YCwgYCZxdW90O2AsIGFuZCBgJiMzOTtgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICAgKiBjb3JyZXNwb25kaW5nIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byB1bmVzY2FwZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHVuZXNjYXBlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5lc2NhcGUoJ0ZyZWQsIEJhcm5leSAmYW1wOyBQZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnRnJlZCwgQmFybmV5ICYgUGViYmxlcycKICAgICAqLwogICAgZnVuY3Rpb24gdW5lc2NhcGUoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZShyZUVzY2FwZWRIdG1sLCB1bmVzY2FwZUh0bWxDaGFyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIHVuaXF1ZSBJRC4gSWYgYHByZWZpeGAgaXMgcHJvdmlkZWQgdGhlIElEIHdpbGwgYmUgYXBwZW5kZWQgdG8gaXQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcHJlZml4XSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBJRCB3aXRoLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdW5pcXVlIElELgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuaXF1ZUlkKCdjb250YWN0XycpOwogICAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAgICoKICAgICAqIF8udW5pcXVlSWQoKTsKICAgICAqIC8vID0+ICcxMDUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVuaXF1ZUlkKHByZWZpeCkgewogICAgICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICAgICAgcmV0dXJuIFN0cmluZyhwcmVmaXggPT0gbnVsbCA/ICcnIDogcHJlZml4KSArIGlkOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGBsb2Rhc2hgIG9iamVjdCB0aGF0IHdyYXBzIHRoZSBnaXZlbiB2YWx1ZSB3aXRoIGV4cGxpY2l0CiAgICAgKiBtZXRob2QgY2hhaW5pbmcgZW5hYmxlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgd3JhcHBlciBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIHlvdW5nZXN0ID0gXy5jaGFpbihjaGFyYWN0ZXJzKQogICAgICogICAgIC5zb3J0QnkoJ2FnZScpCiAgICAgKiAgICAgLm1hcChmdW5jdGlvbihjaHIpIHsgcmV0dXJuIGNoci5uYW1lICsgJyBpcyAnICsgY2hyLmFnZTsgfSkKICAgICAqICAgICAuZmlyc3QoKQogICAgICogICAgIC52YWx1ZSgpOwogICAgICogLy8gPT4gJ3BlYmJsZXMgaXMgMScKICAgICAqLwogICAgZnVuY3Rpb24gY2hhaW4odmFsdWUpIHsKICAgICAgdmFsdWUgPSBuZXcgbG9kYXNoV3JhcHBlcih2YWx1ZSk7CiAgICAgIHZhbHVlLl9fY2hhaW5fXyA9IHRydWU7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZXMgYGludGVyY2VwdG9yYCB3aXRoIHRoZSBgdmFsdWVgIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBhbmQgdGhlbgogICAgICogcmV0dXJucyBgdmFsdWVgLiBUaGUgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kCiAgICAgKiBjaGFpbiBpbiBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluCiAgICAgKiB0aGUgY2hhaW4uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvdmlkZSB0byBgaW50ZXJjZXB0b3JgLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW50ZXJjZXB0b3IgVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDMsIDRdKQogICAgICogIC50YXAoZnVuY3Rpb24oYXJyYXkpIHsgYXJyYXkucG9wKCk7IH0pCiAgICAgKiAgLnJldmVyc2UoKQogICAgICogIC52YWx1ZSgpOwogICAgICogLy8gPT4gWzMsIDIsIDFdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgICAgaW50ZXJjZXB0b3IodmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBFbmFibGVzIGV4cGxpY2l0IG1ldGhvZCBjaGFpbmluZyBvbiB0aGUgd3JhcHBlciBvYmplY3QuCiAgICAgKgogICAgICogQG5hbWUgY2hhaW4KICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gd2l0aG91dCBleHBsaWNpdCBjaGFpbmluZwogICAgICogXyhjaGFyYWN0ZXJzKS5maXJzdCgpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfQogICAgICoKICAgICAqIC8vIHdpdGggZXhwbGljaXQgY2hhaW5pbmcKICAgICAqIF8oY2hhcmFjdGVycykuY2hhaW4oKQogICAgICogICAuZmlyc3QoKQogICAgICogICAucGljaygnYWdlJykKICAgICAqICAgLnZhbHVlKCk7CiAgICAgKiAvLyA9PiB7ICdhZ2UnOiAzNiB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbmFtZSB0b1N0cmluZwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlc3VsdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLnRvU3RyaW5nKCk7CiAgICAgKiAvLyA9PiAnMSwyLDMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJUb1N0cmluZygpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLl9fd3JhcHBlZF9fKTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAgICoKICAgICAqIEBuYW1lIHZhbHVlT2YKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdmFsdWUKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICAgIHJldHVybiB0aGlzLl9fd3JhcHBlZF9fOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogICAgbG9kYXNoLmF0ID0gYXQ7CiAgICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgICBsb2Rhc2guYmluZEtleSA9IGJpbmRLZXk7CiAgICBsb2Rhc2guY2hhaW4gPSBjaGFpbjsKICAgIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICAgIGxvZGFzaC5jb21wb3NlID0gY29tcG9zZTsKICAgIGxvZGFzaC5jb25zdGFudCA9IGNvbnN0YW50OwogICAgbG9kYXNoLmNvdW50QnkgPSBjb3VudEJ5OwogICAgbG9kYXNoLmNyZWF0ZSA9IGNyZWF0ZTsKICAgIGxvZGFzaC5jcmVhdGVDYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrOwogICAgbG9kYXNoLmN1cnJ5ID0gY3Vycnk7CiAgICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgbG9kYXNoLmRlZmVyID0gZGVmZXI7CiAgICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICAgIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICAgIGxvZGFzaC5maWx0ZXIgPSBmaWx0ZXI7CiAgICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZm9yRWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgICBsb2Rhc2guZm9ySW5SaWdodCA9IGZvckluUmlnaHQ7CiAgICBsb2Rhc2guZm9yT3duID0gZm9yT3duOwogICAgbG9kYXNoLmZvck93blJpZ2h0ID0gZm9yT3duUmlnaHQ7CiAgICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLmdyb3VwQnkgPSBncm91cEJ5OwogICAgbG9kYXNoLmluZGV4QnkgPSBpbmRleEJ5OwogICAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogICAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICAgIGxvZGFzaC5pbnZlcnQgPSBpbnZlcnQ7CiAgICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogICAgbG9kYXNoLmtleXMgPSBrZXlzOwogICAgbG9kYXNoLm1hcCA9IG1hcDsKICAgIGxvZGFzaC5tYXBWYWx1ZXMgPSBtYXBWYWx1ZXM7CiAgICBsb2Rhc2gubWF4ID0gbWF4OwogICAgbG9kYXNoLm1lbW9pemUgPSBtZW1vaXplOwogICAgbG9kYXNoLm1lcmdlID0gbWVyZ2U7CiAgICBsb2Rhc2gubWluID0gbWluOwogICAgbG9kYXNoLm9taXQgPSBvbWl0OwogICAgbG9kYXNoLm9uY2UgPSBvbmNlOwogICAgbG9kYXNoLnBhaXJzID0gcGFpcnM7CiAgICBsb2Rhc2gucGFydGlhbCA9IHBhcnRpYWw7CiAgICBsb2Rhc2gucGFydGlhbFJpZ2h0ID0gcGFydGlhbFJpZ2h0OwogICAgbG9kYXNoLnBpY2sgPSBwaWNrOwogICAgbG9kYXNoLnBsdWNrID0gcGx1Y2s7CiAgICBsb2Rhc2gucHJvcGVydHkgPSBwcm9wZXJ0eTsKICAgIGxvZGFzaC5wdWxsID0gcHVsbDsKICAgIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogICAgbG9kYXNoLnJlamVjdCA9IHJlamVjdDsKICAgIGxvZGFzaC5yZW1vdmUgPSByZW1vdmU7CiAgICBsb2Rhc2gucmVzdCA9IHJlc3Q7CiAgICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogICAgbG9kYXNoLnRhcCA9IHRhcDsKICAgIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogICAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgICBsb2Rhc2gudG9BcnJheSA9IHRvQXJyYXk7CiAgICBsb2Rhc2gudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogICAgbG9kYXNoLndoZXJlID0gd2hlcmU7CiAgICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgICBsb2Rhc2gueG9yID0geG9yOwogICAgbG9kYXNoLnppcCA9IHppcDsKICAgIGxvZGFzaC56aXBPYmplY3QgPSB6aXBPYmplY3Q7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC5jb2xsZWN0ID0gbWFwOwogICAgbG9kYXNoLmRyb3AgPSByZXN0OwogICAgbG9kYXNoLmVhY2ggPSBmb3JFYWNoOwogICAgbG9kYXNoLmVhY2hSaWdodCA9IGZvckVhY2hSaWdodDsKICAgIGxvZGFzaC5leHRlbmQgPSBhc3NpZ247CiAgICBsb2Rhc2gubWV0aG9kcyA9IGZ1bmN0aW9uczsKICAgIGxvZGFzaC5vYmplY3QgPSB6aXBPYmplY3Q7CiAgICBsb2Rhc2guc2VsZWN0ID0gZmlsdGVyOwogICAgbG9kYXNoLnRhaWwgPSByZXN0OwogICAgbG9kYXNoLnVuaXF1ZSA9IHVuaXE7CiAgICBsb2Rhc2gudW56aXAgPSB6aXA7CgogICAgLy8gYWRkIGZ1bmN0aW9ucyB0byBgbG9kYXNoLnByb3RvdHlwZWAKICAgIG1peGluKGxvZGFzaCk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLy8gYWRkIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICAgIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogICAgbG9kYXNoLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICAgIGxvZGFzaC5jb250YWlucyA9IGNvbnRhaW5zOwogICAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICAgIGxvZGFzaC5ldmVyeSA9IGV2ZXJ5OwogICAgbG9kYXNoLmZpbmQgPSBmaW5kOwogICAgbG9kYXNoLmZpbmRJbmRleCA9IGZpbmRJbmRleDsKICAgIGxvZGFzaC5maW5kS2V5ID0gZmluZEtleTsKICAgIGxvZGFzaC5maW5kTGFzdCA9IGZpbmRMYXN0OwogICAgbG9kYXNoLmZpbmRMYXN0SW5kZXggPSBmaW5kTGFzdEluZGV4OwogICAgbG9kYXNoLmZpbmRMYXN0S2V5ID0gZmluZExhc3RLZXk7CiAgICBsb2Rhc2guaGFzID0gaGFzOwogICAgbG9kYXNoLmlkZW50aXR5ID0gaWRlbnRpdHk7CiAgICBsb2Rhc2guaW5kZXhPZiA9IGluZGV4T2Y7CiAgICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICAgIGxvZGFzaC5pc0FycmF5ID0gaXNBcnJheTsKICAgIGxvZGFzaC5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogICAgbG9kYXNoLmlzRWxlbWVudCA9IGlzRWxlbWVudDsKICAgIGxvZGFzaC5pc0VtcHR5ID0gaXNFbXB0eTsKICAgIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICAgIGxvZGFzaC5pc0Zpbml0ZSA9IGlzRmluaXRlOwogICAgbG9kYXNoLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogICAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgICBsb2Rhc2guaXNOdWxsID0gaXNOdWxsOwogICAgbG9kYXNoLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgICBsb2Rhc2guaXNPYmplY3QgPSBpc09iamVjdDsKICAgIGxvZGFzaC5pc1BsYWluT2JqZWN0ID0gaXNQbGFpbk9iamVjdDsKICAgIGxvZGFzaC5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogICAgbG9kYXNoLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgICBsb2Rhc2guaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKICAgIGxvZGFzaC5sYXN0SW5kZXhPZiA9IGxhc3RJbmRleE9mOwogICAgbG9kYXNoLm1peGluID0gbWl4aW47CiAgICBsb2Rhc2gubm9Db25mbGljdCA9IG5vQ29uZmxpY3Q7CiAgICBsb2Rhc2gubm9vcCA9IG5vb3A7CiAgICBsb2Rhc2gubm93ID0gbm93OwogICAgbG9kYXNoLnBhcnNlSW50ID0gcGFyc2VJbnQ7CiAgICBsb2Rhc2gucmFuZG9tID0gcmFuZG9tOwogICAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICAgIGxvZGFzaC5yZWR1Y2VSaWdodCA9IHJlZHVjZVJpZ2h0OwogICAgbG9kYXNoLnJlc3VsdCA9IHJlc3VsdDsKICAgIGxvZGFzaC5ydW5JbkNvbnRleHQgPSBydW5JbkNvbnRleHQ7CiAgICBsb2Rhc2guc2l6ZSA9IHNpemU7CiAgICBsb2Rhc2guc29tZSA9IHNvbWU7CiAgICBsb2Rhc2guc29ydGVkSW5kZXggPSBzb3J0ZWRJbmRleDsKICAgIGxvZGFzaC50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgbG9kYXNoLnVuZXNjYXBlID0gdW5lc2NhcGU7CiAgICBsb2Rhc2gudW5pcXVlSWQgPSB1bmlxdWVJZDsKCiAgICAvLyBhZGQgYWxpYXNlcwogICAgbG9kYXNoLmFsbCA9IGV2ZXJ5OwogICAgbG9kYXNoLmFueSA9IHNvbWU7CiAgICBsb2Rhc2guZGV0ZWN0ID0gZmluZDsKICAgIGxvZGFzaC5maW5kV2hlcmUgPSBmaW5kOwogICAgbG9kYXNoLmZvbGRsID0gcmVkdWNlOwogICAgbG9kYXNoLmZvbGRyID0gcmVkdWNlUmlnaHQ7CiAgICBsb2Rhc2guaW5jbHVkZSA9IGNvbnRhaW5zOwogICAgbG9kYXNoLmluamVjdCA9IHJlZHVjZTsKCiAgICBtaXhpbihmdW5jdGlvbigpIHsKICAgICAgdmFyIHNvdXJjZSA9IHt9CiAgICAgIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICAgIHNvdXJjZVttZXRob2ROYW1lXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0oKSwgZmFsc2UpOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgY2FwYWJsZSBvZiByZXR1cm5pbmcgd3JhcHBlZCBhbmQgdW53cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgICBsb2Rhc2guZmlyc3QgPSBmaXJzdDsKICAgIGxvZGFzaC5sYXN0ID0gbGFzdDsKICAgIGxvZGFzaC5zYW1wbGUgPSBzYW1wbGU7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC50YWtlID0gZmlyc3Q7CiAgICBsb2Rhc2guaGVhZCA9IGZpcnN0OwoKICAgIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGNhbGxiYWNrYWJsZSA9IG1ldGhvZE5hbWUgIT09ICdzYW1wbGUnOwogICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdPSBmdW5jdGlvbihuLCBndWFyZCkgewogICAgICAgICAgdmFyIGNoYWluQWxsID0gdGhpcy5fX2NoYWluX18sCiAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYyh0aGlzLl9fd3JhcHBlZF9fLCBuLCBndWFyZCk7CgogICAgICAgICAgcmV0dXJuICFjaGFpbkFsbCAmJiAobiA9PSBudWxsIHx8IChndWFyZCAmJiAhKGNhbGxiYWNrYWJsZSAmJiB0eXBlb2YgbiA9PSAnZnVuY3Rpb24nKSkpCiAgICAgICAgICAgID8gcmVzdWx0CiAgICAgICAgICAgIDogbmV3IGxvZGFzaFdyYXBwZXIocmVzdWx0LCBjaGFpbkFsbCk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIHN0cmluZwogICAgICovCiAgICBsb2Rhc2guVkVSU0lPTiA9ICcyLjQuMSc7CgogICAgLy8gYWRkICJDaGFpbmluZyIgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyCiAgICBsb2Rhc2gucHJvdG90eXBlLmNoYWluID0gd3JhcHBlckNoYWluOwogICAgbG9kYXNoLnByb3RvdHlwZS50b1N0cmluZyA9IHdyYXBwZXJUb1N0cmluZzsKICAgIGxvZGFzaC5wcm90b3R5cGUudmFsdWUgPSB3cmFwcGVyVmFsdWVPZjsKICAgIGxvZGFzaC5wcm90b3R5cGUudmFsdWVPZiA9IHdyYXBwZXJWYWx1ZU9mOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzCiAgICBmb3JFYWNoKFsnam9pbicsICdwb3AnLCAnc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNoYWluQWxsID0gdGhpcy5fX2NoYWluX18sCiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKCiAgICAgICAgcmV0dXJuIGNoYWluQWxsCiAgICAgICAgICA/IG5ldyBsb2Rhc2hXcmFwcGVyKHJlc3VsdCwgY2hhaW5BbGwpCiAgICAgICAgICA6IHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB0aGUgZXhpc3Rpbmcgd3JhcHBlZCB2YWx1ZQogICAgZm9yRWFjaChbJ3B1c2gnLCAncmV2ZXJzZScsICdzb3J0JywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuYy5hcHBseSh0aGlzLl9fd3JhcHBlZF9fLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwogICAgfSk7CgogICAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIG5ldyB3cmFwcGVkIHZhbHVlcwogICAgZm9yRWFjaChbJ2NvbmNhdCcsICdzbGljZScsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBsb2Rhc2hXcmFwcGVyKGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKSwgdGhpcy5fX2NoYWluX18pOwogICAgICB9OwogICAgfSk7CgogICAgcmV0dXJuIGxvZGFzaDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBleHBvc2UgTG8tRGFzaAogIHZhciBfID0gcnVuSW5Db250ZXh0KCk7CgogIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMgbGlrZSByLmpzIGNoZWNrIGZvciBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIGlzIGxvYWRlZCB3aXRoIGEgUmVxdWlyZUpTIHNoaW0gY29uZmlnLgogICAgLy8gU2VlIGh0dHA6Ly9yZXF1aXJlanMub3JnL2RvY3MvYXBpLmh0bWwjY29uZmlnLXNoaW0KICAgIHJvb3QuXyA9IF87CgogICAgLy8gZGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUKICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF87CiAgICB9KTsKICB9CiAgLy8gY2hlY2sgZm9yIGBleHBvcnRzYCBhZnRlciBgZGVmaW5lYCBpbiBjYXNlIGEgYnVpbGQgb3B0aW1pemVyIGFkZHMgYW4gYGV4cG9ydHNgIG9iamVjdAogIGVsc2UgaWYgKGZyZWVFeHBvcnRzICYmIGZyZWVNb2R1bGUpIHsKICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUwogICAgaWYgKG1vZHVsZUV4cG9ydHMpIHsKICAgICAgKGZyZWVNb2R1bGUuZXhwb3J0cyA9IF8pLl8gPSBfOwogICAgfQogICAgLy8gaW4gTmFyd2hhbCBvciBSaGlubyAtcmVxdWlyZQogICAgZWxzZSB7CiAgICAgIGZyZWVFeHBvcnRzLl8gPSBfOwogICAgfQogIH0KICBlbHNlIHsKICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgcm9vdC5fID0gXzsKICB9Cn0uY2FsbCh0aGlzKSk7Cgp9KS5jYWxsKHRoaXMsdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7fV0sMTMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKOyhmdW5jdGlvbihleHBvcnRzKSB7CgovLyBleHBvcnQgdGhlIGNsYXNzIGlmIHdlIGFyZSBpbiBhIE5vZGUtbGlrZSBzeXN0ZW0uCmlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiBtb2R1bGUuZXhwb3J0cyA9PT0gZXhwb3J0cykKICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBTZW1WZXI7CgovLyBUaGUgZGVidWcgZnVuY3Rpb24gaXMgZXhjbHVkZWQgZW50aXJlbHkgZnJvbSB0aGUgbWluaWZpZWQgdmVyc2lvbi4KCi8vIE5vdGU6IHRoaXMgaXMgdGhlIHNlbXZlci5vcmcgdmVyc2lvbiBvZiB0aGUgc3BlYyB0aGF0IGl0IGltcGxlbWVudHMKLy8gTm90IG5lY2Vzc2FyaWx5IHRoZSBwYWNrYWdlIHZlcnNpb24gb2YgdGhpcyBjb2RlLgpleHBvcnRzLlNFTVZFUl9TUEVDX1ZFUlNJT04gPSAnMi4wLjAnOwoKLy8gVGhlIGFjdHVhbCByZWdleHBzIGdvIG9uIGV4cG9ydHMucmUKdmFyIHJlID0gZXhwb3J0cy5yZSA9IFtdOwp2YXIgc3JjID0gZXhwb3J0cy5zcmMgPSBbXTsKdmFyIFIgPSAwOwoKLy8gVGhlIGZvbGxvd2luZyBSZWd1bGFyIEV4cHJlc3Npb25zIGNhbiBiZSB1c2VkIGZvciB0b2tlbml6aW5nLAovLyB2YWxpZGF0aW5nLCBhbmQgcGFyc2luZyBTZW1WZXIgdmVyc2lvbiBzdHJpbmdzLgoKLy8gIyMgTnVtZXJpYyBJZGVudGlmaWVyCi8vIEEgc2luZ2xlIGAwYCwgb3IgYSBub24temVybyBkaWdpdCBmb2xsb3dlZCBieSB6ZXJvIG9yIG1vcmUgZGlnaXRzLgoKdmFyIE5VTUVSSUNJREVOVElGSUVSID0gUisrOwpzcmNbTlVNRVJJQ0lERU5USUZJRVJdID0gJzB8WzEtOV1cXGQqJzsKdmFyIE5VTUVSSUNJREVOVElGSUVSTE9PU0UgPSBSKys7CnNyY1tOVU1FUklDSURFTlRJRklFUkxPT1NFXSA9ICdbMC05XSsnOwoKCi8vICMjIE5vbi1udW1lcmljIElkZW50aWZpZXIKLy8gWmVybyBvciBtb3JlIGRpZ2l0cywgZm9sbG93ZWQgYnkgYSBsZXR0ZXIgb3IgaHlwaGVuLCBhbmQgdGhlbiB6ZXJvIG9yCi8vIG1vcmUgbGV0dGVycywgZGlnaXRzLCBvciBoeXBoZW5zLgoKdmFyIE5PTk5VTUVSSUNJREVOVElGSUVSID0gUisrOwpzcmNbTk9OTlVNRVJJQ0lERU5USUZJRVJdID0gJ1xcZCpbYS16QS1aLV1bYS16QS1aMC05LV0qJzsKCgovLyAjIyBNYWluIFZlcnNpb24KLy8gVGhyZWUgZG90LXNlcGFyYXRlZCBudW1lcmljIGlkZW50aWZpZXJzLgoKdmFyIE1BSU5WRVJTSU9OID0gUisrOwpzcmNbTUFJTlZFUlNJT05dID0gJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSXSArICcpXFwuJyArCiAgICAgICAgICAgICAgICAgICAnKCcgKyBzcmNbTlVNRVJJQ0lERU5USUZJRVJdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICcoJyArIHNyY1tOVU1FUklDSURFTlRJRklFUl0gKyAnKSc7Cgp2YXIgTUFJTlZFUlNJT05MT09TRSA9IFIrKzsKc3JjW01BSU5WRVJTSU9OTE9PU0VdID0gJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJyknOwoKLy8gIyMgUHJlLXJlbGVhc2UgVmVyc2lvbiBJZGVudGlmaWVyCi8vIEEgbnVtZXJpYyBpZGVudGlmaWVyLCBvciBhIG5vbi1udW1lcmljIGlkZW50aWZpZXIuCgp2YXIgUFJFUkVMRUFTRUlERU5USUZJRVIgPSBSKys7CnNyY1tQUkVSRUxFQVNFSURFTlRJRklFUl0gPSAnKD86JyArIHNyY1tOVU1FUklDSURFTlRJRklFUl0gKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wnICsgc3JjW05PTk5VTUVSSUNJREVOVElGSUVSXSArICcpJzsKCnZhciBQUkVSRUxFQVNFSURFTlRJRklFUkxPT1NFID0gUisrOwpzcmNbUFJFUkVMRUFTRUlERU5USUZJRVJMT09TRV0gPSAnKD86JyArIHNyY1tOVU1FUklDSURFTlRJRklFUkxPT1NFXSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8JyArIHNyY1tOT05OVU1FUklDSURFTlRJRklFUl0gKyAnKSc7CgoKLy8gIyMgUHJlLXJlbGVhc2UgVmVyc2lvbgovLyBIeXBoZW4sIGZvbGxvd2VkIGJ5IG9uZSBvciBtb3JlIGRvdC1zZXBhcmF0ZWQgcHJlLXJlbGVhc2UgdmVyc2lvbgovLyBpZGVudGlmaWVycy4KCnZhciBQUkVSRUxFQVNFID0gUisrOwpzcmNbUFJFUkVMRUFTRV0gPSAnKD86LSgnICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSXSArCiAgICAgICAgICAgICAgICAgICcoPzpcXC4nICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSXSArICcpKikpJzsKCnZhciBQUkVSRUxFQVNFTE9PU0UgPSBSKys7CnNyY1tQUkVSRUxFQVNFTE9PU0VdID0gJyg/Oi0/KCcgKyBzcmNbUFJFUkVMRUFTRUlERU5USUZJRVJMT09TRV0gKwogICAgICAgICAgICAgICAgICAgICAgICcoPzpcXC4nICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSTE9PU0VdICsgJykqKSknOwoKLy8gIyMgQnVpbGQgTWV0YWRhdGEgSWRlbnRpZmllcgovLyBBbnkgY29tYmluYXRpb24gb2YgZGlnaXRzLCBsZXR0ZXJzLCBvciBoeXBoZW5zLgoKdmFyIEJVSUxESURFTlRJRklFUiA9IFIrKzsKc3JjW0JVSUxESURFTlRJRklFUl0gPSAnWzAtOUEtWmEtei1dKyc7CgovLyAjIyBCdWlsZCBNZXRhZGF0YQovLyBQbHVzIHNpZ24sIGZvbGxvd2VkIGJ5IG9uZSBvciBtb3JlIHBlcmlvZC1zZXBhcmF0ZWQgYnVpbGQgbWV0YWRhdGEKLy8gaWRlbnRpZmllcnMuCgp2YXIgQlVJTEQgPSBSKys7CnNyY1tCVUlMRF0gPSAnKD86XFwrKCcgKyBzcmNbQlVJTERJREVOVElGSUVSXSArCiAgICAgICAgICAgICAnKD86XFwuJyArIHNyY1tCVUlMRElERU5USUZJRVJdICsgJykqKSknOwoKCi8vICMjIEZ1bGwgVmVyc2lvbiBTdHJpbmcKLy8gQSBtYWluIHZlcnNpb24sIGZvbGxvd2VkIG9wdGlvbmFsbHkgYnkgYSBwcmUtcmVsZWFzZSB2ZXJzaW9uIGFuZAovLyBidWlsZCBtZXRhZGF0YS4KCi8vIE5vdGUgdGhhdCB0aGUgb25seSBtYWpvciwgbWlub3IsIHBhdGNoLCBhbmQgcHJlLXJlbGVhc2Ugc2VjdGlvbnMgb2YKLy8gdGhlIHZlcnNpb24gc3RyaW5nIGFyZSBjYXB0dXJpbmcgZ3JvdXBzLiAgVGhlIGJ1aWxkIG1ldGFkYXRhIGlzIG5vdCBhCi8vIGNhcHR1cmluZyBncm91cCwgYmVjYXVzZSBpdCBzaG91bGQgbm90IGV2ZXIgYmUgdXNlZCBpbiB2ZXJzaW9uCi8vIGNvbXBhcmlzb24uCgp2YXIgRlVMTCA9IFIrKzsKdmFyIEZVTExQTEFJTiA9ICd2PycgKyBzcmNbTUFJTlZFUlNJT05dICsKICAgICAgICAgICAgICAgIHNyY1tQUkVSRUxFQVNFXSArICc/JyArCiAgICAgICAgICAgICAgICBzcmNbQlVJTERdICsgJz8nOwoKc3JjW0ZVTExdID0gJ14nICsgRlVMTFBMQUlOICsgJyQnOwoKLy8gbGlrZSBmdWxsLCBidXQgYWxsb3dzIHYxLjIuMyBhbmQgPTEuMi4zLCB3aGljaCBwZW9wbGUgZG8gc29tZXRpbWVzLgovLyBhbHNvLCAxLjAuMGFscGhhMSAocHJlcmVsZWFzZSB3aXRob3V0IHRoZSBoeXBoZW4pIHdoaWNoIGlzIHByZXR0eQovLyBjb21tb24gaW4gdGhlIG5wbSByZWdpc3RyeS4KdmFyIExPT1NFUExBSU4gPSAnW3Y9XFxzXSonICsgc3JjW01BSU5WRVJTSU9OTE9PU0VdICsKICAgICAgICAgICAgICAgICBzcmNbUFJFUkVMRUFTRUxPT1NFXSArICc/JyArCiAgICAgICAgICAgICAgICAgc3JjW0JVSUxEXSArICc/JzsKCnZhciBMT09TRSA9IFIrKzsKc3JjW0xPT1NFXSA9ICdeJyArIExPT1NFUExBSU4gKyAnJCc7Cgp2YXIgR1RMVCA9IFIrKzsKc3JjW0dUTFRdID0gJygoPzo8fD4pPz0/KSc7CgovLyBTb21ldGhpbmcgbGlrZSAiMi4qIiBvciAiMS4yLngiLgovLyBOb3RlIHRoYXQgIngueCIgaXMgYSB2YWxpZCB4UmFuZ2UgaWRlbnRpZmVyLCBtZWFuaW5nICJhbnkgdmVyc2lvbiIKLy8gT25seSB0aGUgZmlyc3QgaXRlbSBpcyBzdHJpY3RseSByZXF1aXJlZC4KdmFyIFhSQU5HRUlERU5USUZJRVJMT09TRSA9IFIrKzsKc3JjW1hSQU5HRUlERU5USUZJRVJMT09TRV0gPSBzcmNbTlVNRVJJQ0lERU5USUZJRVJMT09TRV0gKyAnfHh8WHxcXConOwp2YXIgWFJBTkdFSURFTlRJRklFUiA9IFIrKzsKc3JjW1hSQU5HRUlERU5USUZJRVJdID0gc3JjW05VTUVSSUNJREVOVElGSUVSXSArICd8eHxYfFxcKic7Cgp2YXIgWFJBTkdFUExBSU4gPSBSKys7CnNyY1tYUkFOR0VQTEFJTl0gPSAnW3Y9XFxzXSooJyArIHNyY1tYUkFOR0VJREVOVElGSUVSXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAnKD86XFwuKCcgKyBzcmNbWFJBTkdFSURFTlRJRklFUl0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgJyg/OlxcLignICsgc3JjW1hSQU5HRUlERU5USUZJRVJdICsgJyknICsKICAgICAgICAgICAgICAgICAgICcoPzonICsgc3JjW1BSRVJFTEVBU0VdICsgJyk/JyArCiAgICAgICAgICAgICAgICAgICBzcmNbQlVJTERdICsgJz8nICsKICAgICAgICAgICAgICAgICAgICcpPyk/JzsKCnZhciBYUkFOR0VQTEFJTkxPT1NFID0gUisrOwpzcmNbWFJBTkdFUExBSU5MT09TRV0gPSAnW3Y9XFxzXSooJyArIHNyY1tYUkFOR0VJREVOVElGSUVSTE9PU0VdICsgJyknICsKICAgICAgICAgICAgICAgICAgICAgICAgJyg/OlxcLignICsgc3JjW1hSQU5HRUlERU5USUZJRVJMT09TRV0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgICAgICAnKD86XFwuKCcgKyBzcmNbWFJBTkdFSURFTlRJRklFUkxPT1NFXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAgICAgICcoPzonICsgc3JjW1BSRVJFTEVBU0VMT09TRV0gKyAnKT8nICsKICAgICAgICAgICAgICAgICAgICAgICAgc3JjW0JVSUxEXSArICc/JyArCiAgICAgICAgICAgICAgICAgICAgICAgICcpPyk/JzsKCnZhciBYUkFOR0UgPSBSKys7CnNyY1tYUkFOR0VdID0gJ14nICsgc3JjW0dUTFRdICsgJ1xccyonICsgc3JjW1hSQU5HRVBMQUlOXSArICckJzsKdmFyIFhSQU5HRUxPT1NFID0gUisrOwpzcmNbWFJBTkdFTE9PU0VdID0gJ14nICsgc3JjW0dUTFRdICsgJ1xccyonICsgc3JjW1hSQU5HRVBMQUlOTE9PU0VdICsgJyQnOwoKLy8gVGlsZGUgcmFuZ2VzLgovLyBNZWFuaW5nIGlzICJyZWFzb25hYmx5IGF0IG9yIGdyZWF0ZXIgdGhhbiIKdmFyIExPTkVUSUxERSA9IFIrKzsKc3JjW0xPTkVUSUxERV0gPSAnKD86fj4/KSc7Cgp2YXIgVElMREVUUklNID0gUisrOwpzcmNbVElMREVUUklNXSA9ICcoXFxzKiknICsgc3JjW0xPTkVUSUxERV0gKyAnXFxzKyc7CnJlW1RJTERFVFJJTV0gPSBuZXcgUmVnRXhwKHNyY1tUSUxERVRSSU1dLCAnZycpOwp2YXIgdGlsZGVUcmltUmVwbGFjZSA9ICckMX4nOwoKdmFyIFRJTERFID0gUisrOwpzcmNbVElMREVdID0gJ14nICsgc3JjW0xPTkVUSUxERV0gKyBzcmNbWFJBTkdFUExBSU5dICsgJyQnOwp2YXIgVElMREVMT09TRSA9IFIrKzsKc3JjW1RJTERFTE9PU0VdID0gJ14nICsgc3JjW0xPTkVUSUxERV0gKyBzcmNbWFJBTkdFUExBSU5MT09TRV0gKyAnJCc7CgovLyBDYXJldCByYW5nZXMuCi8vIE1lYW5pbmcgaXMgImF0IGxlYXN0IGFuZCBiYWNrd2FyZHMgY29tcGF0aWJsZSB3aXRoIgp2YXIgTE9ORUNBUkVUID0gUisrOwpzcmNbTE9ORUNBUkVUXSA9ICcoPzpcXF4pJzsKCnZhciBDQVJFVFRSSU0gPSBSKys7CnNyY1tDQVJFVFRSSU1dID0gJyhcXHMqKScgKyBzcmNbTE9ORUNBUkVUXSArICdcXHMrJzsKcmVbQ0FSRVRUUklNXSA9IG5ldyBSZWdFeHAoc3JjW0NBUkVUVFJJTV0sICdnJyk7CnZhciBjYXJldFRyaW1SZXBsYWNlID0gJyQxXic7Cgp2YXIgQ0FSRVQgPSBSKys7CnNyY1tDQVJFVF0gPSAnXicgKyBzcmNbTE9ORUNBUkVUXSArIHNyY1tYUkFOR0VQTEFJTl0gKyAnJCc7CnZhciBDQVJFVExPT1NFID0gUisrOwpzcmNbQ0FSRVRMT09TRV0gPSAnXicgKyBzcmNbTE9ORUNBUkVUXSArIHNyY1tYUkFOR0VQTEFJTkxPT1NFXSArICckJzsKCi8vIEEgc2ltcGxlIGd0L2x0L2VxIHRoaW5nLCBvciBqdXN0ICIiIHRvIGluZGljYXRlICJhbnkgdmVyc2lvbiIKdmFyIENPTVBBUkFUT1JMT09TRSA9IFIrKzsKc3JjW0NPTVBBUkFUT1JMT09TRV0gPSAnXicgKyBzcmNbR1RMVF0gKyAnXFxzKignICsgTE9PU0VQTEFJTiArICcpJHxeJCc7CnZhciBDT01QQVJBVE9SID0gUisrOwpzcmNbQ09NUEFSQVRPUl0gPSAnXicgKyBzcmNbR1RMVF0gKyAnXFxzKignICsgRlVMTFBMQUlOICsgJykkfF4kJzsKCgovLyBBbiBleHByZXNzaW9uIHRvIHN0cmlwIGFueSB3aGl0ZXNwYWNlIGJldHdlZW4gdGhlIGd0bHQgYW5kIHRoZSB0aGluZwovLyBpdCBtb2RpZmllcywgc28gdGhhdCBgPiAxLjIuM2AgPT0+IGA+MS4yLjNgCnZhciBDT01QQVJBVE9SVFJJTSA9IFIrKzsKc3JjW0NPTVBBUkFUT1JUUklNXSA9ICcoXFxzKiknICsgc3JjW0dUTFRdICsKICAgICAgICAgICAgICAgICAgICAgICdcXHMqKCcgKyBMT09TRVBMQUlOICsgJ3wnICsgc3JjW1hSQU5HRVBMQUlOXSArICcpJzsKCi8vIHRoaXMgb25lIGhhcyB0byB1c2UgdGhlIC9nIGZsYWcKcmVbQ09NUEFSQVRPUlRSSU1dID0gbmV3IFJlZ0V4cChzcmNbQ09NUEFSQVRPUlRSSU1dLCAnZycpOwp2YXIgY29tcGFyYXRvclRyaW1SZXBsYWNlID0gJyQxJDIkMyc7CgoKLy8gU29tZXRoaW5nIGxpa2UgYDEuMi4zIC0gMS4yLjRgCi8vIE5vdGUgdGhhdCB0aGVzZSBhbGwgdXNlIHRoZSBsb29zZSBmb3JtLCBiZWNhdXNlIHRoZXknbGwgYmUKLy8gY2hlY2tlZCBhZ2FpbnN0IGVpdGhlciB0aGUgc3RyaWN0IG9yIGxvb3NlIGNvbXBhcmF0b3IgZm9ybQovLyBsYXRlci4KdmFyIEhZUEhFTlJBTkdFID0gUisrOwpzcmNbSFlQSEVOUkFOR0VdID0gJ15cXHMqKCcgKyBzcmNbWFJBTkdFUExBSU5dICsgJyknICsKICAgICAgICAgICAgICAgICAgICdcXHMrLVxccysnICsKICAgICAgICAgICAgICAgICAgICcoJyArIHNyY1tYUkFOR0VQTEFJTl0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgJ1xccyokJzsKCnZhciBIWVBIRU5SQU5HRUxPT1NFID0gUisrOwpzcmNbSFlQSEVOUkFOR0VMT09TRV0gPSAnXlxccyooJyArIHNyY1tYUkFOR0VQTEFJTkxPT1NFXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAgICAgICdcXHMrLVxccysnICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW1hSQU5HRVBMQUlOTE9PU0VdICsgJyknICsKICAgICAgICAgICAgICAgICAgICAgICAgJ1xccyokJzsKCi8vIFN0YXIgcmFuZ2VzIGJhc2ljYWxseSBqdXN0IGFsbG93IGFueXRoaW5nIGF0IGFsbC4KdmFyIFNUQVIgPSBSKys7CnNyY1tTVEFSXSA9ICcoPHw+KT89P1xccypcXConOwoKLy8gQ29tcGlsZSB0byBhY3R1YWwgcmVnZXhwIG9iamVjdHMuCi8vIEFsbCBhcmUgZmxhZy1mcmVlLCB1bmxlc3MgdGhleSB3ZXJlIGNyZWF0ZWQgYWJvdmUgd2l0aCBhIGZsYWcuCmZvciAodmFyIGkgPSAwOyBpIDwgUjsgaSsrKSB7CiAgOwogIGlmICghcmVbaV0pCiAgICByZVtpXSA9IG5ldyBSZWdFeHAoc3JjW2ldKTsKfQoKZXhwb3J0cy5wYXJzZSA9IHBhcnNlOwpmdW5jdGlvbiBwYXJzZSh2ZXJzaW9uLCBsb29zZSkgewogIHZhciByID0gbG9vc2UgPyByZVtMT09TRV0gOiByZVtGVUxMXTsKICByZXR1cm4gKHIudGVzdCh2ZXJzaW9uKSkgPyBuZXcgU2VtVmVyKHZlcnNpb24sIGxvb3NlKSA6IG51bGw7Cn0KCmV4cG9ydHMudmFsaWQgPSB2YWxpZDsKZnVuY3Rpb24gdmFsaWQodmVyc2lvbiwgbG9vc2UpIHsKICB2YXIgdiA9IHBhcnNlKHZlcnNpb24sIGxvb3NlKTsKICByZXR1cm4gdiA/IHYudmVyc2lvbiA6IG51bGw7Cn0KCgpleHBvcnRzLmNsZWFuID0gY2xlYW47CmZ1bmN0aW9uIGNsZWFuKHZlcnNpb24sIGxvb3NlKSB7CiAgdmFyIHMgPSBwYXJzZSh2ZXJzaW9uLnRyaW0oKS5yZXBsYWNlKC9eWz12XSsvLCAnJyksIGxvb3NlKTsKICByZXR1cm4gcyA/IHMudmVyc2lvbiA6IG51bGw7Cn0KCmV4cG9ydHMuU2VtVmVyID0gU2VtVmVyOwoKZnVuY3Rpb24gU2VtVmVyKHZlcnNpb24sIGxvb3NlKSB7CiAgaWYgKHZlcnNpb24gaW5zdGFuY2VvZiBTZW1WZXIpIHsKICAgIGlmICh2ZXJzaW9uLmxvb3NlID09PSBsb29zZSkKICAgICAgcmV0dXJuIHZlcnNpb247CiAgICBlbHNlCiAgICAgIHZlcnNpb24gPSB2ZXJzaW9uLnZlcnNpb247CiAgfSBlbHNlIGlmICh0eXBlb2YgdmVyc2lvbiAhPT0gJ3N0cmluZycpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgVmVyc2lvbjogJyArIHZlcnNpb24pOwogIH0KCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFNlbVZlcikpCiAgICByZXR1cm4gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSk7CgogIDsKICB0aGlzLmxvb3NlID0gbG9vc2U7CiAgdmFyIG0gPSB2ZXJzaW9uLnRyaW0oKS5tYXRjaChsb29zZSA/IHJlW0xPT1NFXSA6IHJlW0ZVTExdKTsKCiAgaWYgKCFtKQogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBWZXJzaW9uOiAnICsgdmVyc2lvbik7CgogIHRoaXMucmF3ID0gdmVyc2lvbjsKCiAgLy8gdGhlc2UgYXJlIGFjdHVhbGx5IG51bWJlcnMKICB0aGlzLm1ham9yID0gK21bMV07CiAgdGhpcy5taW5vciA9ICttWzJdOwogIHRoaXMucGF0Y2ggPSArbVszXTsKCiAgLy8gbnVtYmVyaWZ5IGFueSBwcmVyZWxlYXNlIG51bWVyaWMgaWRzCiAgaWYgKCFtWzRdKQogICAgdGhpcy5wcmVyZWxlYXNlID0gW107CiAgZWxzZQogICAgdGhpcy5wcmVyZWxlYXNlID0gbVs0XS5zcGxpdCgnLicpLm1hcChmdW5jdGlvbihpZCkgewogICAgICByZXR1cm4gKC9eWzAtOV0rJC8udGVzdChpZCkpID8gK2lkIDogaWQ7CiAgICB9KTsKCiAgdGhpcy5idWlsZCA9IG1bNV0gPyBtWzVdLnNwbGl0KCcuJykgOiBbXTsKICB0aGlzLmZvcm1hdCgpOwp9CgpTZW1WZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogIHRoaXMudmVyc2lvbiA9IHRoaXMubWFqb3IgKyAnLicgKyB0aGlzLm1pbm9yICsgJy4nICsgdGhpcy5wYXRjaDsKICBpZiAodGhpcy5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHRoaXMudmVyc2lvbiArPSAnLScgKyB0aGlzLnByZXJlbGVhc2Uuam9pbignLicpOwogIHJldHVybiB0aGlzLnZlcnNpb247Cn07CgpTZW1WZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gJzxTZW1WZXIgIicgKyB0aGlzICsgJyI+JzsKfTsKClNlbVZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy52ZXJzaW9uOwp9OwoKU2VtVmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24ob3RoZXIpIHsKICA7CiAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBTZW1WZXIpKQogICAgb3RoZXIgPSBuZXcgU2VtVmVyKG90aGVyLCB0aGlzLmxvb3NlKTsKCiAgcmV0dXJuIHRoaXMuY29tcGFyZU1haW4ob3RoZXIpIHx8IHRoaXMuY29tcGFyZVByZShvdGhlcik7Cn07CgpTZW1WZXIucHJvdG90eXBlLmNvbXBhcmVNYWluID0gZnVuY3Rpb24ob3RoZXIpIHsKICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIFNlbVZlcikpCiAgICBvdGhlciA9IG5ldyBTZW1WZXIob3RoZXIsIHRoaXMubG9vc2UpOwoKICByZXR1cm4gY29tcGFyZUlkZW50aWZpZXJzKHRoaXMubWFqb3IsIG90aGVyLm1ham9yKSB8fAogICAgICAgICBjb21wYXJlSWRlbnRpZmllcnModGhpcy5taW5vciwgb3RoZXIubWlub3IpIHx8CiAgICAgICAgIGNvbXBhcmVJZGVudGlmaWVycyh0aGlzLnBhdGNoLCBvdGhlci5wYXRjaCk7Cn07CgpTZW1WZXIucHJvdG90eXBlLmNvbXBhcmVQcmUgPSBmdW5jdGlvbihvdGhlcikgewogIGlmICghKG90aGVyIGluc3RhbmNlb2YgU2VtVmVyKSkKICAgIG90aGVyID0gbmV3IFNlbVZlcihvdGhlciwgdGhpcy5sb29zZSk7CgogIC8vIE5PVCBoYXZpbmcgYSBwcmVyZWxlYXNlIGlzID4gaGF2aW5nIG9uZQogIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoICYmICFvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAtMTsKICBlbHNlIGlmICghdGhpcy5wcmVyZWxlYXNlLmxlbmd0aCAmJiBvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAxOwogIGVsc2UgaWYgKCF0aGlzLnByZXJlbGVhc2UubGVuZ3RoICYmICFvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAwOwoKICB2YXIgaSA9IDA7CiAgZG8gewogICAgdmFyIGEgPSB0aGlzLnByZXJlbGVhc2VbaV07CiAgICB2YXIgYiA9IG90aGVyLnByZXJlbGVhc2VbaV07CiAgICA7CiAgICBpZiAoYSA9PT0gdW5kZWZpbmVkICYmIGIgPT09IHVuZGVmaW5lZCkKICAgICAgcmV0dXJuIDA7CiAgICBlbHNlIGlmIChiID09PSB1bmRlZmluZWQpCiAgICAgIHJldHVybiAxOwogICAgZWxzZSBpZiAoYSA9PT0gdW5kZWZpbmVkKQogICAgICByZXR1cm4gLTE7CiAgICBlbHNlIGlmIChhID09PSBiKQogICAgICBjb250aW51ZTsKICAgIGVsc2UKICAgICAgcmV0dXJuIGNvbXBhcmVJZGVudGlmaWVycyhhLCBiKTsKICB9IHdoaWxlICgrK2kpOwp9OwoKLy8gcHJlbWlub3Igd2lsbCBidW1wIHRoZSB2ZXJzaW9uIHVwIHRvIHRoZSBuZXh0IG1pbm9yIHJlbGVhc2UsIGFuZCBpbW1lZGlhdGVseQovLyBkb3duIHRvIHByZS1yZWxlYXNlLiBwcmVtYWpvciBhbmQgcHJlcGF0Y2ggd29yayB0aGUgc2FtZSB3YXkuClNlbVZlci5wcm90b3R5cGUuaW5jID0gZnVuY3Rpb24ocmVsZWFzZSwgaWRlbnRpZmllcikgewogIHN3aXRjaCAocmVsZWFzZSkgewogICAgY2FzZSAncHJlbWFqb3InOgogICAgICB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID0gMDsKICAgICAgdGhpcy5wYXRjaCA9IDA7CiAgICAgIHRoaXMubWlub3IgPSAwOwogICAgICB0aGlzLm1ham9yKys7CiAgICAgIHRoaXMuaW5jKCdwcmUnLCBpZGVudGlmaWVyKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdwcmVtaW5vcic6CiAgICAgIHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPSAwOwogICAgICB0aGlzLnBhdGNoID0gMDsKICAgICAgdGhpcy5taW5vcisrOwogICAgICB0aGlzLmluYygncHJlJywgaWRlbnRpZmllcik7CiAgICAgIGJyZWFrOwogICAgY2FzZSAncHJlcGF0Y2gnOgogICAgICAvLyBJZiB0aGlzIGlzIGFscmVhZHkgYSBwcmVyZWxlYXNlLCBpdCB3aWxsIGJ1bXAgdG8gdGhlIG5leHQgdmVyc2lvbgogICAgICAvLyBkcm9wIGFueSBwcmVyZWxlYXNlcyB0aGF0IG1pZ2h0IGFscmVhZHkgZXhpc3QsIHNpbmNlIHRoZXkgYXJlIG5vdAogICAgICAvLyByZWxldmFudCBhdCB0aGlzIHBvaW50LgogICAgICB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID0gMDsKICAgICAgdGhpcy5pbmMoJ3BhdGNoJywgaWRlbnRpZmllcik7CiAgICAgIHRoaXMuaW5jKCdwcmUnLCBpZGVudGlmaWVyKTsKICAgICAgYnJlYWs7CiAgICAvLyBJZiB0aGUgaW5wdXQgaXMgYSBub24tcHJlcmVsZWFzZSB2ZXJzaW9uLCB0aGlzIGFjdHMgdGhlIHNhbWUgYXMKICAgIC8vIHByZXBhdGNoLgogICAgY2FzZSAncHJlcmVsZWFzZSc6CiAgICAgIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMuaW5jKCdwYXRjaCcsIGlkZW50aWZpZXIpOwogICAgICB0aGlzLmluYygncHJlJywgaWRlbnRpZmllcik7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgJ21ham9yJzoKICAgICAgLy8gSWYgdGhpcyBpcyBhIHByZS1tYWpvciB2ZXJzaW9uLCBidW1wIHVwIHRvIHRoZSBzYW1lIG1ham9yIHZlcnNpb24uCiAgICAgIC8vIE90aGVyd2lzZSBpbmNyZW1lbnQgbWFqb3IuCiAgICAgIC8vIDEuMC4wLTUgYnVtcHMgdG8gMS4wLjAKICAgICAgLy8gMS4xLjAgYnVtcHMgdG8gMi4wLjAKICAgICAgaWYgKHRoaXMubWlub3IgIT09IDAgfHwgdGhpcy5wYXRjaCAhPT0gMCB8fCB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMubWFqb3IrKzsKICAgICAgdGhpcy5taW5vciA9IDA7CiAgICAgIHRoaXMucGF0Y2ggPSAwOwogICAgICB0aGlzLnByZXJlbGVhc2UgPSBbXTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdtaW5vcic6CiAgICAgIC8vIElmIHRoaXMgaXMgYSBwcmUtbWlub3IgdmVyc2lvbiwgYnVtcCB1cCB0byB0aGUgc2FtZSBtaW5vciB2ZXJzaW9uLgogICAgICAvLyBPdGhlcndpc2UgaW5jcmVtZW50IG1pbm9yLgogICAgICAvLyAxLjIuMC01IGJ1bXBzIHRvIDEuMi4wCiAgICAgIC8vIDEuMi4xIGJ1bXBzIHRvIDEuMy4wCiAgICAgIGlmICh0aGlzLnBhdGNoICE9PSAwIHx8IHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5taW5vcisrOwogICAgICB0aGlzLnBhdGNoID0gMDsKICAgICAgdGhpcy5wcmVyZWxlYXNlID0gW107CiAgICAgIGJyZWFrOwogICAgY2FzZSAncGF0Y2gnOgogICAgICAvLyBJZiB0aGlzIGlzIG5vdCBhIHByZS1yZWxlYXNlIHZlcnNpb24sIGl0IHdpbGwgaW5jcmVtZW50IHRoZSBwYXRjaC4KICAgICAgLy8gSWYgaXQgaXMgYSBwcmUtcmVsZWFzZSBpdCB3aWxsIGJ1bXAgdXAgdG8gdGhlIHNhbWUgcGF0Y2ggdmVyc2lvbi4KICAgICAgLy8gMS4yLjAtNSBwYXRjaGVzIHRvIDEuMi4wCiAgICAgIC8vIDEuMi4wIHBhdGNoZXMgdG8gMS4yLjEKICAgICAgaWYgKHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5wYXRjaCsrOwogICAgICB0aGlzLnByZXJlbGVhc2UgPSBbXTsKICAgICAgYnJlYWs7CiAgICAvLyBUaGlzIHByb2JhYmx5IHNob3VsZG4ndCBiZSB1c2VkIHB1YmxpY2x5LgogICAgLy8gMS4wLjAgInByZSIgd291bGQgYmVjb21lIDEuMC4wLTAgd2hpY2ggaXMgdGhlIHdyb25nIGRpcmVjdGlvbi4KICAgIGNhc2UgJ3ByZSc6CiAgICAgIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFswXTsKICAgICAgZWxzZSB7CiAgICAgICAgdmFyIGkgPSB0aGlzLnByZXJlbGVhc2UubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkgPj0gMCkgewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnByZXJlbGVhc2VbaV0gPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHRoaXMucHJlcmVsZWFzZVtpXSsrOwogICAgICAgICAgICBpID0gLTI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpID09PSAtMSkgLy8gZGlkbid0IGluY3JlbWVudCBhbnl0aGluZwogICAgICAgICAgdGhpcy5wcmVyZWxlYXNlLnB1c2goMCk7CiAgICAgIH0KICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAvLyAxLjIuMC1iZXRhLjEgYnVtcHMgdG8gMS4yLjAtYmV0YS4yLAogICAgICAgIC8vIDEuMi4wLWJldGEuZm9vYmx6IG9yIDEuMi4wLWJldGEgYnVtcHMgdG8gMS4yLjAtYmV0YS4wCiAgICAgICAgaWYgKHRoaXMucHJlcmVsZWFzZVswXSA9PT0gaWRlbnRpZmllcikgewogICAgICAgICAgaWYgKGlzTmFOKHRoaXMucHJlcmVsZWFzZVsxXSkpCiAgICAgICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFtpZGVudGlmaWVyLCAwXTsKICAgICAgICB9IGVsc2UKICAgICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFtpZGVudGlmaWVyLCAwXTsKICAgICAgfQogICAgICBicmVhazsKCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgaW5jcmVtZW50IGFyZ3VtZW50OiAnICsgcmVsZWFzZSk7CiAgfQogIHRoaXMuZm9ybWF0KCk7CiAgcmV0dXJuIHRoaXM7Cn07CgpleHBvcnRzLmluYyA9IGluYzsKZnVuY3Rpb24gaW5jKHZlcnNpb24sIHJlbGVhc2UsIGxvb3NlLCBpZGVudGlmaWVyKSB7CiAgaWYgKHR5cGVvZihsb29zZSkgPT09ICdzdHJpbmcnKSB7CiAgICBpZGVudGlmaWVyID0gbG9vc2U7CiAgICBsb29zZSA9IHVuZGVmaW5lZDsKICB9CgogIHRyeSB7CiAgICByZXR1cm4gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSkuaW5jKHJlbGVhc2UsIGlkZW50aWZpZXIpLnZlcnNpb247CiAgfSBjYXRjaCAoZXIpIHsKICAgIHJldHVybiBudWxsOwogIH0KfQoKZXhwb3J0cy5jb21wYXJlSWRlbnRpZmllcnMgPSBjb21wYXJlSWRlbnRpZmllcnM7Cgp2YXIgbnVtZXJpYyA9IC9eWzAtOV0rJC87CmZ1bmN0aW9uIGNvbXBhcmVJZGVudGlmaWVycyhhLCBiKSB7CiAgdmFyIGFudW0gPSBudW1lcmljLnRlc3QoYSk7CiAgdmFyIGJudW0gPSBudW1lcmljLnRlc3QoYik7CgogIGlmIChhbnVtICYmIGJudW0pIHsKICAgIGEgPSArYTsKICAgIGIgPSArYjsKICB9CgogIHJldHVybiAoYW51bSAmJiAhYm51bSkgPyAtMSA6CiAgICAgICAgIChibnVtICYmICFhbnVtKSA/IDEgOgogICAgICAgICBhIDwgYiA/IC0xIDoKICAgICAgICAgYSA+IGIgPyAxIDoKICAgICAgICAgMDsKfQoKZXhwb3J0cy5yY29tcGFyZUlkZW50aWZpZXJzID0gcmNvbXBhcmVJZGVudGlmaWVyczsKZnVuY3Rpb24gcmNvbXBhcmVJZGVudGlmaWVycyhhLCBiKSB7CiAgcmV0dXJuIGNvbXBhcmVJZGVudGlmaWVycyhiLCBhKTsKfQoKZXhwb3J0cy5jb21wYXJlID0gY29tcGFyZTsKZnVuY3Rpb24gY29tcGFyZShhLCBiLCBsb29zZSkgewogIHJldHVybiBuZXcgU2VtVmVyKGEsIGxvb3NlKS5jb21wYXJlKGIpOwp9CgpleHBvcnRzLmNvbXBhcmVMb29zZSA9IGNvbXBhcmVMb29zZTsKZnVuY3Rpb24gY29tcGFyZUxvb3NlKGEsIGIpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCB0cnVlKTsKfQoKZXhwb3J0cy5yY29tcGFyZSA9IHJjb21wYXJlOwpmdW5jdGlvbiByY29tcGFyZShhLCBiLCBsb29zZSkgewogIHJldHVybiBjb21wYXJlKGIsIGEsIGxvb3NlKTsKfQoKZXhwb3J0cy5zb3J0ID0gc29ydDsKZnVuY3Rpb24gc29ydChsaXN0LCBsb29zZSkgewogIHJldHVybiBsaXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGV4cG9ydHMuY29tcGFyZShhLCBiLCBsb29zZSk7CiAgfSk7Cn0KCmV4cG9ydHMucnNvcnQgPSByc29ydDsKZnVuY3Rpb24gcnNvcnQobGlzdCwgbG9vc2UpIHsKICByZXR1cm4gbGlzdC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBleHBvcnRzLnJjb21wYXJlKGEsIGIsIGxvb3NlKTsKICB9KTsKfQoKZXhwb3J0cy5ndCA9IGd0OwpmdW5jdGlvbiBndChhLCBiLCBsb29zZSkgewogIHJldHVybiBjb21wYXJlKGEsIGIsIGxvb3NlKSA+IDA7Cn0KCmV4cG9ydHMubHQgPSBsdDsKZnVuY3Rpb24gbHQoYSwgYiwgbG9vc2UpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCBsb29zZSkgPCAwOwp9CgpleHBvcnRzLmVxID0gZXE7CmZ1bmN0aW9uIGVxKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpID09PSAwOwp9CgpleHBvcnRzLm5lcSA9IG5lcTsKZnVuY3Rpb24gbmVxKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpICE9PSAwOwp9CgpleHBvcnRzLmd0ZSA9IGd0ZTsKZnVuY3Rpb24gZ3RlKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpID49IDA7Cn0KCmV4cG9ydHMubHRlID0gbHRlOwpmdW5jdGlvbiBsdGUoYSwgYiwgbG9vc2UpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCBsb29zZSkgPD0gMDsKfQoKZXhwb3J0cy5jbXAgPSBjbXA7CmZ1bmN0aW9uIGNtcChhLCBvcCwgYiwgbG9vc2UpIHsKICB2YXIgcmV0OwogIHN3aXRjaCAob3ApIHsKICAgIGNhc2UgJz09PSc6CiAgICAgIGlmICh0eXBlb2YgYSA9PT0gJ29iamVjdCcpIGEgPSBhLnZlcnNpb247CiAgICAgIGlmICh0eXBlb2YgYiA9PT0gJ29iamVjdCcpIGIgPSBiLnZlcnNpb247CiAgICAgIHJldCA9IGEgPT09IGI7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnIT09JzoKICAgICAgaWYgKHR5cGVvZiBhID09PSAnb2JqZWN0JykgYSA9IGEudmVyc2lvbjsKICAgICAgaWYgKHR5cGVvZiBiID09PSAnb2JqZWN0JykgYiA9IGIudmVyc2lvbjsKICAgICAgcmV0ID0gYSAhPT0gYjsKICAgICAgYnJlYWs7CiAgICBjYXNlICcnOiBjYXNlICc9JzogY2FzZSAnPT0nOiByZXQgPSBlcShhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnIT0nOiByZXQgPSBuZXEoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGNhc2UgJz4nOiByZXQgPSBndChhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnPj0nOiByZXQgPSBndGUoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGNhc2UgJzwnOiByZXQgPSBsdChhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnPD0nOiByZXQgPSBsdGUoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGRlZmF1bHQ6IHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgb3BlcmF0b3I6ICcgKyBvcCk7CiAgfQogIHJldHVybiByZXQ7Cn0KCmV4cG9ydHMuQ29tcGFyYXRvciA9IENvbXBhcmF0b3I7CmZ1bmN0aW9uIENvbXBhcmF0b3IoY29tcCwgbG9vc2UpIHsKICBpZiAoY29tcCBpbnN0YW5jZW9mIENvbXBhcmF0b3IpIHsKICAgIGlmIChjb21wLmxvb3NlID09PSBsb29zZSkKICAgICAgcmV0dXJuIGNvbXA7CiAgICBlbHNlCiAgICAgIGNvbXAgPSBjb21wLnZhbHVlOwogIH0KCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIENvbXBhcmF0b3IpKQogICAgcmV0dXJuIG5ldyBDb21wYXJhdG9yKGNvbXAsIGxvb3NlKTsKCiAgOwogIHRoaXMubG9vc2UgPSBsb29zZTsKICB0aGlzLnBhcnNlKGNvbXApOwoKICBpZiAodGhpcy5zZW12ZXIgPT09IEFOWSkKICAgIHRoaXMudmFsdWUgPSAnJzsKICBlbHNlCiAgICB0aGlzLnZhbHVlID0gdGhpcy5vcGVyYXRvciArIHRoaXMuc2VtdmVyLnZlcnNpb247CgogIDsKfQoKdmFyIEFOWSA9IHt9OwpDb21wYXJhdG9yLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGNvbXApIHsKICB2YXIgciA9IHRoaXMubG9vc2UgPyByZVtDT01QQVJBVE9STE9PU0VdIDogcmVbQ09NUEFSQVRPUl07CiAgdmFyIG0gPSBjb21wLm1hdGNoKHIpOwoKICBpZiAoIW0pCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIGNvbXBhcmF0b3I6ICcgKyBjb21wKTsKCiAgdGhpcy5vcGVyYXRvciA9IG1bMV07CiAgaWYgKHRoaXMub3BlcmF0b3IgPT09ICc9JykKICAgIHRoaXMub3BlcmF0b3IgPSAnJzsKCiAgLy8gaWYgaXQgbGl0ZXJhbGx5IGlzIGp1c3QgJz4nIG9yICcnIHRoZW4gYWxsb3cgYW55dGhpbmcuCiAgaWYgKCFtWzJdKQogICAgdGhpcy5zZW12ZXIgPSBBTlk7CiAgZWxzZQogICAgdGhpcy5zZW12ZXIgPSBuZXcgU2VtVmVyKG1bMl0sIHRoaXMubG9vc2UpOwp9OwoKQ29tcGFyYXRvci5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAnPFNlbVZlciBDb21wYXJhdG9yICInICsgdGhpcyArICciPic7Cn07CgpDb21wYXJhdG9yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnZhbHVlOwp9OwoKQ29tcGFyYXRvci5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uKHZlcnNpb24pIHsKICA7CgogIGlmICh0aGlzLnNlbXZlciA9PT0gQU5ZKQogICAgcmV0dXJuIHRydWU7CgogIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpCiAgICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCB0aGlzLmxvb3NlKTsKCiAgcmV0dXJuIGNtcCh2ZXJzaW9uLCB0aGlzLm9wZXJhdG9yLCB0aGlzLnNlbXZlciwgdGhpcy5sb29zZSk7Cn07CgoKZXhwb3J0cy5SYW5nZSA9IFJhbmdlOwpmdW5jdGlvbiBSYW5nZShyYW5nZSwgbG9vc2UpIHsKICBpZiAoKHJhbmdlIGluc3RhbmNlb2YgUmFuZ2UpICYmIHJhbmdlLmxvb3NlID09PSBsb29zZSkKICAgIHJldHVybiByYW5nZTsKCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFJhbmdlKSkKICAgIHJldHVybiBuZXcgUmFuZ2UocmFuZ2UsIGxvb3NlKTsKCiAgdGhpcy5sb29zZSA9IGxvb3NlOwoKICAvLyBGaXJzdCwgc3BsaXQgYmFzZWQgb24gYm9vbGVhbiBvciB8fAogIHRoaXMucmF3ID0gcmFuZ2U7CiAgdGhpcy5zZXQgPSByYW5nZS5zcGxpdCgvXHMqXHxcfFxzKi8pLm1hcChmdW5jdGlvbihyYW5nZSkgewogICAgcmV0dXJuIHRoaXMucGFyc2VSYW5nZShyYW5nZS50cmltKCkpOwogIH0sIHRoaXMpLmZpbHRlcihmdW5jdGlvbihjKSB7CiAgICAvLyB0aHJvdyBvdXQgYW55IHRoYXQgYXJlIG5vdCByZWxldmFudCBmb3Igd2hhdGV2ZXIgcmVhc29uCiAgICByZXR1cm4gYy5sZW5ndGg7CiAgfSk7CgogIGlmICghdGhpcy5zZXQubGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIFNlbVZlciBSYW5nZTogJyArIHJhbmdlKTsKICB9CgogIHRoaXMuZm9ybWF0KCk7Cn0KClJhbmdlLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuICc8U2VtVmVyIFJhbmdlICInICsgdGhpcy5yYW5nZSArICciPic7Cn07CgpSYW5nZS5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yYW5nZSA9IHRoaXMuc2V0Lm1hcChmdW5jdGlvbihjb21wcykgewogICAgcmV0dXJuIGNvbXBzLmpvaW4oJyAnKS50cmltKCk7CiAgfSkuam9pbignfHwnKS50cmltKCk7CiAgcmV0dXJuIHRoaXMucmFuZ2U7Cn07CgpSYW5nZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5yYW5nZTsKfTsKClJhbmdlLnByb3RvdHlwZS5wYXJzZVJhbmdlID0gZnVuY3Rpb24ocmFuZ2UpIHsKICB2YXIgbG9vc2UgPSB0aGlzLmxvb3NlOwogIHJhbmdlID0gcmFuZ2UudHJpbSgpOwogIDsKICAvLyBgMS4yLjMgLSAxLjIuNGAgPT4gYD49MS4yLjMgPD0xLjIuNGAKICB2YXIgaHIgPSBsb29zZSA/IHJlW0hZUEhFTlJBTkdFTE9PU0VdIDogcmVbSFlQSEVOUkFOR0VdOwogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShociwgaHlwaGVuUmVwbGFjZSk7CiAgOwogIC8vIGA+IDEuMi4zIDwgMS4yLjVgID0+IGA+MS4yLjMgPDEuMi41YAogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShyZVtDT01QQVJBVE9SVFJJTV0sIGNvbXBhcmF0b3JUcmltUmVwbGFjZSk7CiAgOwoKICAvLyBgfiAxLjIuM2AgPT4gYH4xLjIuM2AKICByYW5nZSA9IHJhbmdlLnJlcGxhY2UocmVbVElMREVUUklNXSwgdGlsZGVUcmltUmVwbGFjZSk7CgogIC8vIGBeIDEuMi4zYCA9PiBgXjEuMi4zYAogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShyZVtDQVJFVFRSSU1dLCBjYXJldFRyaW1SZXBsYWNlKTsKCiAgLy8gbm9ybWFsaXplIHNwYWNlcwogIHJhbmdlID0gcmFuZ2Uuc3BsaXQoL1xzKy8pLmpvaW4oJyAnKTsKCiAgLy8gQXQgdGhpcyBwb2ludCwgdGhlIHJhbmdlIGlzIGNvbXBsZXRlbHkgdHJpbW1lZCBhbmQKICAvLyByZWFkeSB0byBiZSBzcGxpdCBpbnRvIGNvbXBhcmF0b3JzLgoKICB2YXIgY29tcFJlID0gbG9vc2UgPyByZVtDT01QQVJBVE9STE9PU0VdIDogcmVbQ09NUEFSQVRPUl07CiAgdmFyIHNldCA9IHJhbmdlLnNwbGl0KCcgJykubWFwKGZ1bmN0aW9uKGNvbXApIHsKICAgIHJldHVybiBwYXJzZUNvbXBhcmF0b3IoY29tcCwgbG9vc2UpOwogIH0pLmpvaW4oJyAnKS5zcGxpdCgvXHMrLyk7CiAgaWYgKHRoaXMubG9vc2UpIHsKICAgIC8vIGluIGxvb3NlIG1vZGUsIHRocm93IG91dCBhbnkgdGhhdCBhcmUgbm90IHZhbGlkIGNvbXBhcmF0b3JzCiAgICBzZXQgPSBzZXQuZmlsdGVyKGZ1bmN0aW9uKGNvbXApIHsKICAgICAgcmV0dXJuICEhY29tcC5tYXRjaChjb21wUmUpOwogICAgfSk7CiAgfQogIHNldCA9IHNldC5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIG5ldyBDb21wYXJhdG9yKGNvbXAsIGxvb3NlKTsKICB9KTsKCiAgcmV0dXJuIHNldDsKfTsKCi8vIE1vc3RseSBqdXN0IGZvciB0ZXN0aW5nIGFuZCBsZWdhY3kgQVBJIHJlYXNvbnMKZXhwb3J0cy50b0NvbXBhcmF0b3JzID0gdG9Db21wYXJhdG9yczsKZnVuY3Rpb24gdG9Db21wYXJhdG9ycyhyYW5nZSwgbG9vc2UpIHsKICByZXR1cm4gbmV3IFJhbmdlKHJhbmdlLCBsb29zZSkuc2V0Lm1hcChmdW5jdGlvbihjb21wKSB7CiAgICByZXR1cm4gY29tcC5tYXAoZnVuY3Rpb24oYykgewogICAgICByZXR1cm4gYy52YWx1ZTsKICAgIH0pLmpvaW4oJyAnKS50cmltKCkuc3BsaXQoJyAnKTsKICB9KTsKfQoKLy8gY29tcHJpc2VkIG9mIHhyYW5nZXMsIHRpbGRlcywgc3RhcnMsIGFuZCBndGx0J3MgYXQgdGhpcyBwb2ludC4KLy8gYWxyZWFkeSByZXBsYWNlZCB0aGUgaHlwaGVuIHJhbmdlcwovLyB0dXJuIGludG8gYSBzZXQgb2YgSlVTVCBjb21wYXJhdG9ycy4KZnVuY3Rpb24gcGFyc2VDb21wYXJhdG9yKGNvbXAsIGxvb3NlKSB7CiAgOwogIGNvbXAgPSByZXBsYWNlQ2FyZXRzKGNvbXAsIGxvb3NlKTsKICA7CiAgY29tcCA9IHJlcGxhY2VUaWxkZXMoY29tcCwgbG9vc2UpOwogIDsKICBjb21wID0gcmVwbGFjZVhSYW5nZXMoY29tcCwgbG9vc2UpOwogIDsKICBjb21wID0gcmVwbGFjZVN0YXJzKGNvbXAsIGxvb3NlKTsKICA7CiAgcmV0dXJuIGNvbXA7Cn0KCmZ1bmN0aW9uIGlzWChpZCkgewogIHJldHVybiAhaWQgfHwgaWQudG9Mb3dlckNhc2UoKSA9PT0gJ3gnIHx8IGlkID09PSAnKic7Cn0KCi8vIH4sIH4+IC0tPiAqIChhbnksIGtpbmRhIHNpbGx5KQovLyB+MiwgfjIueCwgfjIueC54LCB+PjIsIH4+Mi54IH4+Mi54LnggLS0+ID49Mi4wLjAgPDMuMC4wCi8vIH4yLjAsIH4yLjAueCwgfj4yLjAsIH4+Mi4wLnggLS0+ID49Mi4wLjAgPDIuMS4wCi8vIH4xLjIsIH4xLjIueCwgfj4xLjIsIH4+MS4yLnggLS0+ID49MS4yLjAgPDEuMy4wCi8vIH4xLjIuMywgfj4xLjIuMyAtLT4gPj0xLjIuMyA8MS4zLjAKLy8gfjEuMi4wLCB+PjEuMi4wIC0tPiA+PTEuMi4wIDwxLjMuMApmdW5jdGlvbiByZXBsYWNlVGlsZGVzKGNvbXAsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXAudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIHJlcGxhY2VUaWxkZShjb21wLCBsb29zZSk7CiAgfSkuam9pbignICcpOwp9CgpmdW5jdGlvbiByZXBsYWNlVGlsZGUoY29tcCwgbG9vc2UpIHsKICB2YXIgciA9IGxvb3NlID8gcmVbVElMREVMT09TRV0gOiByZVtUSUxERV07CiAgcmV0dXJuIGNvbXAucmVwbGFjZShyLCBmdW5jdGlvbihfLCBNLCBtLCBwLCBwcikgewogICAgOwogICAgdmFyIHJldDsKCiAgICBpZiAoaXNYKE0pKQogICAgICByZXQgPSAnJzsKICAgIGVsc2UgaWYgKGlzWChtKSkKICAgICAgcmV0ID0gJz49JyArIE0gKyAnLjAuMCA8JyArICgrTSArIDEpICsgJy4wLjAnOwogICAgZWxzZSBpZiAoaXNYKHApKQogICAgICAvLyB+MS4yID09ID49MS4yLjAtIDwxLjMuMC0KICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4wIDwnICsgTSArICcuJyArICgrbSArIDEpICsgJy4wJzsKICAgIGVsc2UgaWYgKHByKSB7CiAgICAgIDsKICAgICAgaWYgKHByLmNoYXJBdCgwKSAhPT0gJy0nKQogICAgICAgIHByID0gJy0nICsgcHI7CiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKyBwciArCiAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgKCttICsgMSkgKyAnLjAnOwogICAgfSBlbHNlCiAgICAgIC8vIH4xLjIuMyA9PSA+PTEuMi4zIDwxLjMuMAogICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsKICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CgogICAgOwogICAgcmV0dXJuIHJldDsKICB9KTsKfQoKLy8gXiAtLT4gKiAoYW55LCBraW5kYSBzaWxseSkKLy8gXjIsIF4yLngsIF4yLngueCAtLT4gPj0yLjAuMCA8My4wLjAKLy8gXjIuMCwgXjIuMC54IC0tPiA+PTIuMC4wIDwzLjAuMAovLyBeMS4yLCBeMS4yLnggLS0+ID49MS4yLjAgPDIuMC4wCi8vIF4xLjIuMyAtLT4gPj0xLjIuMyA8Mi4wLjAKLy8gXjEuMi4wIC0tPiA+PTEuMi4wIDwyLjAuMApmdW5jdGlvbiByZXBsYWNlQ2FyZXRzKGNvbXAsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXAudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIHJlcGxhY2VDYXJldChjb21wLCBsb29zZSk7CiAgfSkuam9pbignICcpOwp9CgpmdW5jdGlvbiByZXBsYWNlQ2FyZXQoY29tcCwgbG9vc2UpIHsKICA7CiAgdmFyIHIgPSBsb29zZSA/IHJlW0NBUkVUTE9PU0VdIDogcmVbQ0FSRVRdOwogIHJldHVybiBjb21wLnJlcGxhY2UociwgZnVuY3Rpb24oXywgTSwgbSwgcCwgcHIpIHsKICAgIDsKICAgIHZhciByZXQ7CgogICAgaWYgKGlzWChNKSkKICAgICAgcmV0ID0gJyc7CiAgICBlbHNlIGlmIChpc1gobSkpCiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4wLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIGVsc2UgaWYgKGlzWChwKSkgewogICAgICBpZiAoTSA9PT0gJzAnKQogICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuMCA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CiAgICAgIGVsc2UKICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSBpZiAocHIpIHsKICAgICAgOwogICAgICBpZiAocHIuY2hhckF0KDApICE9PSAnLScpCiAgICAgICAgcHIgPSAnLScgKyBwcjsKICAgICAgaWYgKE0gPT09ICcwJykgewogICAgICAgIGlmIChtID09PSAnMCcpCiAgICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsgcHIgKwogICAgICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyBtICsgJy4nICsgKCtwICsgMSk7CiAgICAgICAgZWxzZQogICAgICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4nICsgcCArIHByICsKICAgICAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgKCttICsgMSkgKyAnLjAnOwogICAgICB9IGVsc2UKICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsgcHIgKwogICAgICAgICAgICAgICcgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSB7CiAgICAgIDsKICAgICAgaWYgKE0gPT09ICcwJykgewogICAgICAgIGlmIChtID09PSAnMCcpCiAgICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsKICAgICAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgbSArICcuJyArICgrcCArIDEpOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKwogICAgICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CiAgICAgIH0gZWxzZQogICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKwogICAgICAgICAgICAgICcgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0KCiAgICA7CiAgICByZXR1cm4gcmV0OwogIH0pOwp9CgpmdW5jdGlvbiByZXBsYWNlWFJhbmdlcyhjb21wLCBsb29zZSkgewogIDsKICByZXR1cm4gY29tcC5zcGxpdCgvXHMrLykubWFwKGZ1bmN0aW9uKGNvbXApIHsKICAgIHJldHVybiByZXBsYWNlWFJhbmdlKGNvbXAsIGxvb3NlKTsKICB9KS5qb2luKCcgJyk7Cn0KCmZ1bmN0aW9uIHJlcGxhY2VYUmFuZ2UoY29tcCwgbG9vc2UpIHsKICBjb21wID0gY29tcC50cmltKCk7CiAgdmFyIHIgPSBsb29zZSA/IHJlW1hSQU5HRUxPT1NFXSA6IHJlW1hSQU5HRV07CiAgcmV0dXJuIGNvbXAucmVwbGFjZShyLCBmdW5jdGlvbihyZXQsIGd0bHQsIE0sIG0sIHAsIHByKSB7CiAgICA7CiAgICB2YXIgeE0gPSBpc1goTSk7CiAgICB2YXIgeG0gPSB4TSB8fCBpc1gobSk7CiAgICB2YXIgeHAgPSB4bSB8fCBpc1gocCk7CiAgICB2YXIgYW55WCA9IHhwOwoKICAgIGlmIChndGx0ID09PSAnPScgJiYgYW55WCkKICAgICAgZ3RsdCA9ICcnOwoKICAgIGlmICh4TSkgewogICAgICBpZiAoZ3RsdCA9PT0gJz4nIHx8IGd0bHQgPT09ICc8JykgewogICAgICAgIC8vIG5vdGhpbmcgaXMgYWxsb3dlZAogICAgICAgIHJldCA9ICc8MC4wLjAnOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIG5vdGhpbmcgaXMgZm9yYmlkZGVuCiAgICAgICAgcmV0ID0gJyonOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGd0bHQgJiYgYW55WCkgewogICAgICAvLyByZXBsYWNlIFggd2l0aCAwCiAgICAgIGlmICh4bSkKICAgICAgICBtID0gMDsKICAgICAgaWYgKHhwKQogICAgICAgIHAgPSAwOwoKICAgICAgaWYgKGd0bHQgPT09ICc+JykgewogICAgICAgIC8vID4xID0+ID49Mi4wLjAKICAgICAgICAvLyA+MS4yID0+ID49MS4zLjAKICAgICAgICAvLyA+MS4yLjMgPT4gPj0gMS4yLjQKICAgICAgICBndGx0ID0gJz49JzsKICAgICAgICBpZiAoeG0pIHsKICAgICAgICAgIE0gPSArTSArIDE7CiAgICAgICAgICBtID0gMDsKICAgICAgICAgIHAgPSAwOwogICAgICAgIH0gZWxzZSBpZiAoeHApIHsKICAgICAgICAgIG0gPSArbSArIDE7CiAgICAgICAgICBwID0gMDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZ3RsdCA9PT0gJzw9JykgewogICAgICAgIC8vIDw9MC43LnggaXMgYWN0dWFsbHkgPDAuOC4wLCBzaW5jZSBhbnkgMC43Lnggc2hvdWxkCiAgICAgICAgLy8gcGFzcy4gIFNpbWlsYXJseSwgPD03LnggaXMgYWN0dWFsbHkgPDguMC4wLCBldGMuCiAgICAgICAgZ3RsdCA9ICc8JwogICAgICAgIGlmICh4bSkKICAgICAgICAgIE0gPSArTSArIDEKICAgICAgICBlbHNlCiAgICAgICAgICBtID0gK20gKyAxCiAgICAgIH0KCiAgICAgIHJldCA9IGd0bHQgKyBNICsgJy4nICsgbSArICcuJyArIHA7CiAgICB9IGVsc2UgaWYgKHhtKSB7CiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4wLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSBpZiAoeHApIHsKICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4wIDwnICsgTSArICcuJyArICgrbSArIDEpICsgJy4wJzsKICAgIH0KCiAgICA7CgogICAgcmV0dXJuIHJldDsKICB9KTsKfQoKLy8gQmVjYXVzZSAqIGlzIEFORC1lZCB3aXRoIGV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgY29tcGFyYXRvciwKLy8gYW5kICcnIG1lYW5zICJhbnkgdmVyc2lvbiIsIGp1c3QgcmVtb3ZlIHRoZSAqcyBlbnRpcmVseS4KZnVuY3Rpb24gcmVwbGFjZVN0YXJzKGNvbXAsIGxvb3NlKSB7CiAgOwogIC8vIExvb3NlbmVzcyBpcyBpZ25vcmVkIGhlcmUuICBzdGFyIGlzIGFsd2F5cyBhcyBsb29zZSBhcyBpdCBnZXRzIQogIHJldHVybiBjb21wLnRyaW0oKS5yZXBsYWNlKHJlW1NUQVJdLCAnJyk7Cn0KCi8vIFRoaXMgZnVuY3Rpb24gaXMgcGFzc2VkIHRvIHN0cmluZy5yZXBsYWNlKHJlW0hZUEhFTlJBTkdFXSkKLy8gTSwgbSwgcGF0Y2gsIHByZXJlbGVhc2UsIGJ1aWxkCi8vIDEuMiAtIDMuNC41ID0+ID49MS4yLjAgPD0zLjQuNQovLyAxLjIuMyAtIDMuNCA9PiA+PTEuMi4wIDwzLjUuMCBBbnkgMy40Lnggd2lsbCBkbwovLyAxLjIgLSAzLjQgPT4gPj0xLjIuMCA8My41LjAKZnVuY3Rpb24gaHlwaGVuUmVwbGFjZSgkMCwKICAgICAgICAgICAgICAgICAgICAgICBmcm9tLCBmTSwgZm0sIGZwLCBmcHIsIGZiLAogICAgICAgICAgICAgICAgICAgICAgIHRvLCB0TSwgdG0sIHRwLCB0cHIsIHRiKSB7CgogIGlmIChpc1goZk0pKQogICAgZnJvbSA9ICcnOwogIGVsc2UgaWYgKGlzWChmbSkpCiAgICBmcm9tID0gJz49JyArIGZNICsgJy4wLjAnOwogIGVsc2UgaWYgKGlzWChmcCkpCiAgICBmcm9tID0gJz49JyArIGZNICsgJy4nICsgZm0gKyAnLjAnOwogIGVsc2UKICAgIGZyb20gPSAnPj0nICsgZnJvbTsKCiAgaWYgKGlzWCh0TSkpCiAgICB0byA9ICcnOwogIGVsc2UgaWYgKGlzWCh0bSkpCiAgICB0byA9ICc8JyArICgrdE0gKyAxKSArICcuMC4wJzsKICBlbHNlIGlmIChpc1godHApKQogICAgdG8gPSAnPCcgKyB0TSArICcuJyArICgrdG0gKyAxKSArICcuMCc7CiAgZWxzZSBpZiAodHByKQogICAgdG8gPSAnPD0nICsgdE0gKyAnLicgKyB0bSArICcuJyArIHRwICsgJy0nICsgdHByOwogIGVsc2UKICAgIHRvID0gJzw9JyArIHRvOwoKICByZXR1cm4gKGZyb20gKyAnICcgKyB0bykudHJpbSgpOwp9CgoKLy8gaWYgQU5ZIG9mIHRoZSBzZXRzIG1hdGNoIEFMTCBvZiBpdHMgY29tcGFyYXRvcnMsIHRoZW4gcGFzcwpSYW5nZS5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uKHZlcnNpb24pIHsKICBpZiAoIXZlcnNpb24pCiAgICByZXR1cm4gZmFsc2U7CgogIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpCiAgICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCB0aGlzLmxvb3NlKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNldC5sZW5ndGg7IGkrKykgewogICAgaWYgKHRlc3RTZXQodGhpcy5zZXRbaV0sIHZlcnNpb24pKQogICAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKZnVuY3Rpb24gdGVzdFNldChzZXQsIHZlcnNpb24pIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKykgewogICAgaWYgKCFzZXRbaV0udGVzdCh2ZXJzaW9uKSkKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgaWYgKHZlcnNpb24ucHJlcmVsZWFzZS5sZW5ndGgpIHsKICAgIC8vIEZpbmQgdGhlIHNldCBvZiB2ZXJzaW9ucyB0aGF0IGFyZSBhbGxvd2VkIHRvIGhhdmUgcHJlcmVsZWFzZXMKICAgIC8vIEZvciBleGFtcGxlLCBeMS4yLjMtcHIuMSBkZXN1Z2FycyB0byA+PTEuMi4zLXByLjEgPDIuMC4wCiAgICAvLyBUaGF0IHNob3VsZCBhbGxvdyBgMS4yLjMtcHIuMmAgdG8gcGFzcy4KICAgIC8vIEhvd2V2ZXIsIGAxLjIuNC1hbHBoYS5ub3RyZWFkeWAgc2hvdWxkIE5PVCBiZSBhbGxvd2VkLAogICAgLy8gZXZlbiB0aG91Z2ggaXQncyB3aXRoaW4gdGhlIHJhbmdlIHNldCBieSB0aGUgY29tcGFyYXRvcnMuCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKykgewogICAgICA7CiAgICAgIGlmIChzZXRbaV0uc2VtdmVyID09PSBBTlkpCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICBpZiAoc2V0W2ldLnNlbXZlci5wcmVyZWxlYXNlLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgYWxsb3dlZCA9IHNldFtpXS5zZW12ZXI7CiAgICAgICAgaWYgKGFsbG93ZWQubWFqb3IgPT09IHZlcnNpb24ubWFqb3IgJiYKICAgICAgICAgICAgYWxsb3dlZC5taW5vciA9PT0gdmVyc2lvbi5taW5vciAmJgogICAgICAgICAgICBhbGxvd2VkLnBhdGNoID09PSB2ZXJzaW9uLnBhdGNoKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICAvLyBWZXJzaW9uIGhhcyBhIC1wcmUsIGJ1dCBpdCdzIG5vdCBvbmUgb2YgdGhlIG9uZXMgd2UgbGlrZS4KICAgIHJldHVybiBmYWxzZTsKICB9CgogIHJldHVybiB0cnVlOwp9CgpleHBvcnRzLnNhdGlzZmllcyA9IHNhdGlzZmllczsKZnVuY3Rpb24gc2F0aXNmaWVzKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHRyeSB7CiAgICByYW5nZSA9IG5ldyBSYW5nZShyYW5nZSwgbG9vc2UpOwogIH0gY2F0Y2ggKGVyKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiByYW5nZS50ZXN0KHZlcnNpb24pOwp9CgpleHBvcnRzLm1heFNhdGlzZnlpbmcgPSBtYXhTYXRpc2Z5aW5nOwpmdW5jdGlvbiBtYXhTYXRpc2Z5aW5nKHZlcnNpb25zLCByYW5nZSwgbG9vc2UpIHsKICByZXR1cm4gdmVyc2lvbnMuZmlsdGVyKGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgIHJldHVybiBzYXRpc2ZpZXModmVyc2lvbiwgcmFuZ2UsIGxvb3NlKTsKICB9KS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiByY29tcGFyZShhLCBiLCBsb29zZSk7CiAgfSlbMF0gfHwgbnVsbDsKfQoKZXhwb3J0cy52YWxpZFJhbmdlID0gdmFsaWRSYW5nZTsKZnVuY3Rpb24gdmFsaWRSYW5nZShyYW5nZSwgbG9vc2UpIHsKICB0cnkgewogICAgLy8gUmV0dXJuICcqJyBpbnN0ZWFkIG9mICcnIHNvIHRoYXQgdHJ1dGhpbmVzcyB3b3Jrcy4KICAgIC8vIFRoaXMgd2lsbCB0aHJvdyBpZiBpdCdzIGludmFsaWQgYW55d2F5CiAgICByZXR1cm4gbmV3IFJhbmdlKHJhbmdlLCBsb29zZSkucmFuZ2UgfHwgJyonOwogIH0gY2F0Y2ggKGVyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCi8vIERldGVybWluZSBpZiB2ZXJzaW9uIGlzIGxlc3MgdGhhbiBhbGwgdGhlIHZlcnNpb25zIHBvc3NpYmxlIGluIHRoZSByYW5nZQpleHBvcnRzLmx0ciA9IGx0cjsKZnVuY3Rpb24gbHRyKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHJldHVybiBvdXRzaWRlKHZlcnNpb24sIHJhbmdlLCAnPCcsIGxvb3NlKTsKfQoKLy8gRGV0ZXJtaW5lIGlmIHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIGFsbCB0aGUgdmVyc2lvbnMgcG9zc2libGUgaW4gdGhlIHJhbmdlLgpleHBvcnRzLmd0ciA9IGd0cjsKZnVuY3Rpb24gZ3RyKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHJldHVybiBvdXRzaWRlKHZlcnNpb24sIHJhbmdlLCAnPicsIGxvb3NlKTsKfQoKZXhwb3J0cy5vdXRzaWRlID0gb3V0c2lkZTsKZnVuY3Rpb24gb3V0c2lkZSh2ZXJzaW9uLCByYW5nZSwgaGlsbywgbG9vc2UpIHsKICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSk7CiAgcmFuZ2UgPSBuZXcgUmFuZ2UocmFuZ2UsIGxvb3NlKTsKCiAgdmFyIGd0Zm4sIGx0ZWZuLCBsdGZuLCBjb21wLCBlY29tcDsKICBzd2l0Y2ggKGhpbG8pIHsKICAgIGNhc2UgJz4nOgogICAgICBndGZuID0gZ3Q7CiAgICAgIGx0ZWZuID0gbHRlOwogICAgICBsdGZuID0gbHQ7CiAgICAgIGNvbXAgPSAnPic7CiAgICAgIGVjb21wID0gJz49JzsKICAgICAgYnJlYWs7CiAgICBjYXNlICc8JzoKICAgICAgZ3RmbiA9IGx0OwogICAgICBsdGVmbiA9IGd0ZTsKICAgICAgbHRmbiA9IGd0OwogICAgICBjb21wID0gJzwnOwogICAgICBlY29tcCA9ICc8PSc7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTXVzdCBwcm92aWRlIGEgaGlsbyB2YWwgb2YgIjwiIG9yICI+IicpOwogIH0KCiAgLy8gSWYgaXQgc2F0aXNpZmVzIHRoZSByYW5nZSBpdCBpcyBub3Qgb3V0c2lkZQogIGlmIChzYXRpc2ZpZXModmVyc2lvbiwgcmFuZ2UsIGxvb3NlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gRnJvbSBub3cgb24sIHZhcmlhYmxlIHRlcm1zIGFyZSBhcyBpZiB3ZSdyZSBpbiAiZ3RyIiBtb2RlLgogIC8vIGJ1dCBub3RlIHRoYXQgZXZlcnl0aGluZyBpcyBmbGlwcGVkIGZvciB0aGUgImx0ciIgZnVuY3Rpb24uCgogIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2Uuc2V0Lmxlbmd0aDsgKytpKSB7CiAgICB2YXIgY29tcGFyYXRvcnMgPSByYW5nZS5zZXRbaV07CgogICAgdmFyIGhpZ2ggPSBudWxsOwogICAgdmFyIGxvdyA9IG51bGw7CgogICAgY29tcGFyYXRvcnMuZm9yRWFjaChmdW5jdGlvbihjb21wYXJhdG9yKSB7CiAgICAgIGhpZ2ggPSBoaWdoIHx8IGNvbXBhcmF0b3I7CiAgICAgIGxvdyA9IGxvdyB8fCBjb21wYXJhdG9yOwogICAgICBpZiAoZ3Rmbihjb21wYXJhdG9yLnNlbXZlciwgaGlnaC5zZW12ZXIsIGxvb3NlKSkgewogICAgICAgIGhpZ2ggPSBjb21wYXJhdG9yOwogICAgICB9IGVsc2UgaWYgKGx0Zm4oY29tcGFyYXRvci5zZW12ZXIsIGxvdy5zZW12ZXIsIGxvb3NlKSkgewogICAgICAgIGxvdyA9IGNvbXBhcmF0b3I7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIElmIHRoZSBlZGdlIHZlcnNpb24gY29tcGFyYXRvciBoYXMgYSBvcGVyYXRvciB0aGVuIG91ciB2ZXJzaW9uCiAgICAvLyBpc24ndCBvdXRzaWRlIGl0CiAgICBpZiAoaGlnaC5vcGVyYXRvciA9PT0gY29tcCB8fCBoaWdoLm9wZXJhdG9yID09PSBlY29tcCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgdGhlIGxvd2VzdCB2ZXJzaW9uIGNvbXBhcmF0b3IgaGFzIGFuIG9wZXJhdG9yIGFuZCBvdXIgdmVyc2lvbgogICAgLy8gaXMgbGVzcyB0aGFuIGl0IHRoZW4gaXQgaXNuJ3QgaGlnaGVyIHRoYW4gdGhlIHJhbmdlCiAgICBpZiAoKCFsb3cub3BlcmF0b3IgfHwgbG93Lm9wZXJhdG9yID09PSBjb21wKSAmJgogICAgICAgIGx0ZWZuKHZlcnNpb24sIGxvdy5zZW12ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSBpZiAobG93Lm9wZXJhdG9yID09PSBlY29tcCAmJiBsdGZuKHZlcnNpb24sIGxvdy5zZW12ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIFVzZSB0aGUgZGVmaW5lKCkgZnVuY3Rpb24gaWYgd2UncmUgaW4gQU1EIGxhbmQKaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKICBkZWZpbmUoZXhwb3J0cyk7Cgp9KSgKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgPyBleHBvcnRzIDoKICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyB7fSA6CiAgc2VtdmVyID0ge30KKTsKCn0se31dLDEzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNpbXBsZS1leHRlbmQuanMgMC4xLjAKLy8gQSBzaW1wbGUgJ2V4dGVuZCcgaGVscGVyLCBhZGFwdGVkIGZyb20gdGhlIEJhY2tib25lLmpzIGxpYnJhcnkuCi8vIGh0dHA6Ly9naXRodWIuY29tL3Rncmllc3Nlci9zaW1wbGUtZXh0ZW5kCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CgovLyBTaGFyZWQgZW1wdHkgY29uc3RydWN0b3IgZnVuY3Rpb24gdG8gYWlkIGluIHByb3RvdHlwZS1jaGFpbiBjcmVhdGlvbi4KdmFyIGN0b3IgPSBmdW5jdGlvbigpIHt9OwoKLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCi8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCi8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICB2YXIgcGFyZW50ID0gdGhpczsKICB2YXIgY2hpbGQ7CgogIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICB9IGVsc2UgewogICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICB9CgogIC8vIEluaGVyaXQgY2xhc3MgKHN0YXRpYykgcHJvcGVydGllcyBmcm9tIHBhcmVudC4KICBfLmV4dGVuZChjaGlsZCwgcGFyZW50KTsKCiAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogIGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOwoKICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAvLyBpZiBzdXBwbGllZC4KICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgaWYgKHN0YXRpY1Byb3BzKSBfLmV4dGVuZChjaGlsZCwgc3RhdGljUHJvcHMpOwoKICAvLyBDb3JyZWN0bHkgc2V0IGNoaWxkJ3MgYHByb3RvdHlwZS5jb25zdHJ1Y3RvcmAuCiAgY2hpbGQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY2hpbGQ7CgogIC8vIElmIHRoZXJlIGlzIGFuICJleHRlbmRlZCIgZnVuY3Rpb24gc2V0IG9uIHRoZSBwYXJlbnQsCiAgLy8gY2FsbCBpdCB3aXRoIHRoZSBleHRlbmRlZCBjaGlsZCBvYmplY3QuCiAgaWYgKHR5cGVvZiBwYXJlbnQuZXh0ZW5kZWQgPT09ICJmdW5jdGlvbiIpIHBhcmVudC5leHRlbmRlZChjaGlsZCk7CgogIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQgbGF0ZXIuCiAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgcmV0dXJuIGNoaWxkOwp9Owp9LHsibG9kYXNoIjoxMzB9XSwxMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyAgICAgdHJpZ2dlci10aGVuLmpzIDAuMy4wCi8vICAgICAoYykgMjAxMyBUaW0gR3JpZXNzZXIKLy8gICAgIHRyaWdnZXItdGhlbiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCi8vIEV4cG9ydHMgdGhlIGZ1bmN0aW9uIHdoaWNoIG1peGVzIGB0cmlnZ2VyVGhlbmAKLy8gaW50byB0aGUgc3BlY2lmaWVkIGBCYWNrYm9uZWAgY29weSdzIGBFdmVudHNgIG9iamVjdCwKLy8gdXNpbmcgdGhlIHByb21pc2UtbGliJ3MgImFsbCIgaW1wbGVtZW50YXRpb24gcHJvdmlkZWQKLy8gaW4gdGhlIHNlY29uZCBhcmd1bWVudC4KKGZ1bmN0aW9uKHJvb3QsIG1peGluRm4pIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IG1peGluRm47CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZSgndHJpZ2dlci10aGVuJywgW10sIGZ1bmN0aW9uKCkgeyByZXR1cm4gbWl4aW5GbjsgfSk7CiAgfSBlbHNlIHsKICAgIHJvb3RbJ3RyaWdnZXItdGhlbiddID0gbWl4aW5GbjsKICB9Cn0pKHRoaXMsIGZ1bmN0aW9uKEJhY2tib25lLCBQcm9taXNlTGliKSB7CgogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7CiAgdmFyIHB1c2ggICA9IEFycmF5LnByb3RvdHlwZS5wdXNoOwogIHZhciBzbGljZSAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLiBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIG9mIHRoZQogIC8vIGV2ZW50IHRyaWdnZXIgY2FsbHMsIGluIGNhc2UgYW55IHJldHVybiBkZWZlcnJlZHMuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHZhciBkZmRzID0gW107CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KSk7IHJldHVybiBkZmRzOwogICAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSBkZmRzLnB1c2goKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpKTsgcmV0dXJuIGRmZHM7CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpKTsgcmV0dXJuIGRmZHM7CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKSk7IHJldHVybiBkZmRzOwogICAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgZGZkcy5wdXNoKChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKSk7IHJldHVybiBkZmRzOwogICAgfQogIH07CgogIC8vIEZpcmVzIGV2ZW50cyBhcyBgdHJpZ2dlcmAgbm9ybWFsbHkgd291bGQsIGJ1dCBhc3N1bWVzIHRoYXQgc29tZSBvZiB0aGUgYHJldHVybmAKICAvLyB2YWx1ZXMgZnJvbSB0aGUgZXZlbnRzIG1heSBiZSBwcm9taXNlcywgYW5kIGFuZCByZXR1cm5zIGEgcHJvbWlzZSB3aGVuIGFsbCBvZiB0aGUKICAvLyBldmVudHMgYXJlIHJlc29sdmVkLgogIHZhciB0cmlnZ2VyVGhlbiA9IEV2ZW50cy50cmlnZ2VyVGhlbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gUHJvbWlzZUxpYi5hbGwoW10pOwogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICB2YXIgZGZkcyA9IFtdOwogICAgdmFyIGV2dHM7CiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcHVzaC5jYWxsKGRmZHMsIHRyaWdnZXJUaGVuLmFwcGx5KHRoaXMsIFtuYW1lc1tpXV0uY29uY2F0KGFyZ3MpKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2VMaWIuYWxsKGRmZHMpOwogICAgfSBlbHNlIHsKICAgICAgZXZ0cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgIH0KICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoKICAgIC8vIFdyYXAgaW4gYSB0cnkvY2F0Y2ggdG8gcmVqZWN0IHRoZSBwcm9taXNlIGlmIGFueSBlcnJvcnMgYXJlIHRocm93biB3aXRoaW4gdGhlIGhhbmRsZXJzLgogICAgdHJ5ICB7CiAgICAgIGlmIChldnRzKSBwdXNoLmFwcGx5KGRmZHMsIHRyaWdnZXJFdmVudHMoZXZ0cywgYXJncykpOwogICAgICBpZiAoYWxsRXZlbnRzKSBwdXNoLmFwcGx5KGRmZHMsIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIFByb21pc2VMaWIucmVqZWN0KGUpOwogICAgfQogICAgcmV0dXJuIFByb21pc2VMaWIuYWxsKGRmZHMpOwogIH07CgogIC8vIE1peGluIGB0cmlnZ2VyVGhlbmAgdG8gdGhlIGFwcHJvcHJpYXRlIG9iamVjdHMgYW5kIHByb3RvdHlwZXMuCiAgQmFja2JvbmUudHJpZ2dlclRoZW4gPSB0cmlnZ2VyVGhlbjsKCiAgdmFyIG9ianMgPSBbJ01vZGVsJywgJ0NvbGxlY3Rpb24nLCAnUm91dGVyJywgJ1ZpZXcnLCAnSGlzdG9yeSddOwoKICBmb3IgKHZhciBpPTAsIGw9b2Jqcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBCYWNrYm9uZVtvYmpzW2ldXS5wcm90b3R5cGUudHJpZ2dlclRoZW4gPSB0cmlnZ2VyVGhlbjsKICB9Cn0pOwp9LHt9XX0se30sWzFdKSgxKQp9KTs=",
                "body": "IWZ1bmN0aW9uKGUpe2lmKCJvYmplY3QiPT10eXBlb2YgZXhwb3J0cyYmInVuZGVmaW5lZCIhPXR5cGVvZiBtb2R1bGUpbW9kdWxlLmV4cG9ydHM9ZSgpO2Vsc2UgaWYoImZ1bmN0aW9uIj09dHlwZW9mIGRlZmluZSYmZGVmaW5lLmFtZClkZWZpbmUoW10sZSk7ZWxzZXt2YXIgZjsidW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdz9mPXdpbmRvdzoidW5kZWZpbmVkIiE9dHlwZW9mIGdsb2JhbD9mPWdsb2JhbDoidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGYmJihmPXNlbGYpLGYuQm9va3NoZWxmPWUoKX19KGZ1bmN0aW9uKCl7dmFyIGRlZmluZSxtb2R1bGUsZXhwb3J0cztyZXR1cm4gKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKCJDYW5ub3QgZmluZCBtb2R1bGUgJyIrbysiJyIpO3Rocm93IGYuY29kZT0iTU9EVUxFX05PVF9GT1VORCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEJvb2tzaGVsZi5qcyAwLjcuOQovLyAtLS0tLS0tLS0tLS0tLS0KCi8vICAgICAoYykgMjAxNCBUaW0gR3JpZXNzZXIKLy8gICAgIEJvb2tzaGVsZiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KLy8gICAgIEZvciBhbGwgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9ib29rc2hlbGZqcy5vcmcKCnZhciBCb29rc2hlbGYgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gQm9va3NoZWxmLmluaXRpYWxpemUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfTsKCi8vIENvbnN0cnVjdG9yIGZvciBhIG5ldyBgQm9va3NoZWxmYCBvYmplY3QsIGl0IGFjY2VwdHMKLy8gYW4gYWN0aXZlIGBrbmV4YCBpbnN0YW5jZSBhbmQgaW5pdGlhbGl6ZXMgdGhlIGFwcHJvcHJpYXRlCi8vIGBNb2RlbGAgYW5kIGBDb2xsZWN0aW9uYCBjb25zdHJ1Y3RvcnMgZm9yIHVzZSBpbiB0aGUgY3VycmVudCBpbnN0YW5jZS4KQm9va3NoZWxmLmluaXRpYWxpemUgPSBmdW5jdGlvbihrbmV4KSB7CiAgdmFyIGJvb2tzaGVsZiAgPSB7CiAgICBWRVJTSU9OOiAnMC43LjknCiAgfTsKCiAgdmFyIF8gICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKICB2YXIgaW5oZXJpdHMgICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CiAgdmFyIHNlbXZlciAgICAgPSByZXF1aXJlKCdzZW12ZXInKTsKCiAgLy8gV2UndmUgc3VwcGxlbWVudGVkIGBFdmVudHNgIHdpdGggYSBgdHJpZ2dlclRoZW5gCiAgLy8gbWV0aG9kIHRvIGFsbG93IGZvciBhc3luY2hyb25vdXMgZXZlbnQgaGFuZGxpbmcgdmlhIHByb21pc2VzLiBXZSBhbHNvCiAgLy8gbWl4IHRoaXMgaW50byB0aGUgcHJvdG90eXBlcyBvZiB0aGUgbWFpbiBvYmplY3RzIGluIHRoZSBsaWJyYXJ5LgogIHZhciBFdmVudHMgPSByZXF1aXJlKCcuL2xpYi9iYXNlL2V2ZW50cycpOwoKICAvLyBBbGwgY29yZSBtb2R1bGVzIHJlcXVpcmVkIGZvciB0aGUgYm9va3NoZWxmIGluc3RhbmNlLgogIHZhciBCb29rc2hlbGZNb2RlbCAgICAgID0gcmVxdWlyZSgnLi9saWIvbW9kZWwnKTsKICB2YXIgQm9va3NoZWxmQ29sbGVjdGlvbiA9IHJlcXVpcmUoJy4vbGliL2NvbGxlY3Rpb24nKTsKICB2YXIgQm9va3NoZWxmUmVsYXRpb24gICA9IHJlcXVpcmUoJy4vbGliL3JlbGF0aW9uJyk7CiAgdmFyIEVycm9ycyAgICAgICAgICAgICAgPSByZXF1aXJlKCcuL2xpYi9lcnJvcnMnKTsKCiAgLy8gSWYgdGhlIGtuZXggaXNuJ3QgYSBgS25leGAgaW5zdGFuY2UsIHdlJ2xsIGFzc3VtZSBpdCdzCiAgLy8gYSBjb21wYXRpYmxlIGNvbmZpZyBvYmplY3QgYW5kIHBhc3MgaXQgdGhyb3VnaCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UuCiAgLy8gVGhpcyBiZWhhdmlvciBpcyBub3cgZGVwcmVjYXRlZC4KICBpZiAoXy5pc1BsYWluT2JqZWN0KGtuZXgpKSB7CiAgICBjb25zb2xlLndhcm4oJ0luaXRpYWxpemluZyBCb29rc2hlbGYgd2l0aCBhIGNvbmZpZyBvYmplY3QgaXMgZGVwcmVjYXRlZCwgcGxlYXNlIHBhc3MgYW4gaW5pdGlhbGl6ZWQga25leC5qcyBpbnN0YW5jZS4nKTsKICAgIGtuZXggPSByZXF1aXJlKCdrbmV4Jykoa25leCk7CiAgfQoKICB2YXIgcmFuZ2UgPSAnPj0wLjYuMTAnOwogIGlmICghc2VtdmVyLnNhdGlzZmllcyhrbmV4LlZFUlNJT04sIHJhbmdlKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdUaGUga25leCB2ZXJzaW9uIGlzICcgKyBrbmV4LlZFUlNJT04gKyAnIHdoaWNoIGRvZXMgbm90IHNhdGlzZnkgdGhlIEJvb2tzaGVsZlwncyByZXF1aXJlbWVudCAnICsgcmFuZ2UpOwogIH0KCiAgdmFyIE1vZGVsID0gYm9va3NoZWxmLk1vZGVsID0gZnVuY3Rpb24oKSB7CiAgICBCb29rc2hlbGZNb2RlbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgdmFyIENvbGxlY3Rpb24gPSBib29rc2hlbGYuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKCkgewogICAgQm9va3NoZWxmQ29sbGVjdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgaW5oZXJpdHMoTW9kZWwsIEJvb2tzaGVsZk1vZGVsKTsKICBpbmhlcml0cyhDb2xsZWN0aW9uLCBCb29rc2hlbGZDb2xsZWN0aW9uKTsKCiAgXy5leHRlbmQoTW9kZWwsIEJvb2tzaGVsZk1vZGVsKTsKICBfLmV4dGVuZChDb2xsZWN0aW9uLCBCb29rc2hlbGZDb2xsZWN0aW9uKTsKCiAgTW9kZWwucHJvdG90eXBlLl9idWlsZGVyID0KICBDb2xsZWN0aW9uLnByb3RvdHlwZS5fYnVpbGRlciA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogICAgdmFyIGJ1aWxkZXIgID0ga25leCh0YWJsZU5hbWUpOwogICAgdmFyIGluc3RhbmNlID0gdGhpczsKICAgIHJldHVybiBidWlsZGVyLm9uKCdxdWVyeScsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgaW5zdGFuY2UudHJpZ2dlcigncXVlcnknLCBkYXRhKTsKICAgIH0pOwogIH07CgogIC8vIFRoZSBjb2xsZWN0aW9uIGFsc28gcmVmZXJlbmNlcyB0aGUgY29ycmVjdCBgTW9kZWxgLCBzcGVjaWZpZWQgYWJvdmUsIGZvciBjcmVhdGluZwogIC8vIG5ldyBgTW9kZWxgIGluc3RhbmNlcyBpbiB0aGUgY29sbGVjdGlvbi4KICBDb2xsZWN0aW9uLnByb3RvdHlwZS5tb2RlbCA9IE1vZGVsOwogIE1vZGVsLnByb3RvdHlwZS5Db2xsZWN0aW9uID0gQ29sbGVjdGlvbjsKCiAgZnVuY3Rpb24gUmVsYXRpb24oKSB7CiAgICBCb29rc2hlbGZSZWxhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KICBpbmhlcml0cyhSZWxhdGlvbiwgQm9va3NoZWxmUmVsYXRpb24pOwogIFJlbGF0aW9uLnByb3RvdHlwZS5Nb2RlbCA9IE1vZGVsOwogIFJlbGF0aW9uLnByb3RvdHlwZS5Db2xsZWN0aW9uID0gQ29sbGVjdGlvbjsKCiAgLy8gVGhlIGBNb2RlbGAgY29uc3RydWN0b3IgaXMgcmVmZXJlbmNlZCBhcyBhIHByb3BlcnR5IG9uIHRoZSBgQm9va3NoZWxmYCBpbnN0YW5jZSwKICAvLyBtaXhpbmcgaW4gdGhlIGNvcnJlY3QgYGJ1aWxkZXJgIG1ldGhvZCwgYXMgd2VsbCBhcyB0aGUgYHJlbGF0aW9uYCBtZXRob2QsCiAgLy8gcGFzc2luZyBpbiB0aGUgY29ycmVjdCBgTW9kZWxgICYgYENvbGxlY3Rpb25gIGNvbnN0cnVjdG9ycyBmb3IgbGF0ZXIgcmVmZXJlbmNlLgogIE1vZGVsLnByb3RvdHlwZS5fcmVsYXRpb24gPSBmdW5jdGlvbih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlICE9PSAnbW9ycGhUbycgJiYgIV8uaXNGdW5jdGlvbihUYXJnZXQpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQSB2YWxpZCB0YXJnZXQgbW9kZWwgbXVzdCBiZSBkZWZpbmVkIGZvciB0aGUgJyArCiAgICAgICAgXy5yZXN1bHQodGhpcywgJ3RhYmxlTmFtZScpICsgJyAnICsgdHlwZSArICcgcmVsYXRpb24nKTsKICAgIH0KICAgIHJldHVybiBuZXcgUmVsYXRpb24odHlwZSwgVGFyZ2V0LCBvcHRpb25zKTsKICB9OwoKICAvLyBTaG9ydGN1dCBmb3IgY3JlYXRpbmcgYSBuZXcgY29sbGVjdGlvbiB3aXRoIHRoZSBjdXJyZW50IGNvbGxlY3Rpb24uCiAgTW9kZWwuY29sbGVjdGlvbiA9IGZ1bmN0aW9uKHJvd3MsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgQ29sbGVjdGlvbigocm93cyB8fCBbXSksIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7bW9kZWw6IHRoaXN9KSk7CiAgfTsKCiAgLy8gQSBgQm9va3NoZWxmYCBpbnN0YW5jZSBtYXkgYmUgdXNlZCBhcyBhIHRvcC1sZXZlbCBwdWItc3ViIGJ1cywgYXMgaXQgbWl4ZXMgaW4gdGhlCiAgLy8gYEV2ZW50c2Agb2JqZWN0LiBJdCBhbHNvIGNvbnRhaW5zIHRoZSB2ZXJzaW9uIG51bWJlciwgYW5kIGEgYFRyYW5zYWN0aW9uYCBtZXRob2QKICAvLyByZWZlcmVuY2luZyB0aGUgY29ycmVjdCB2ZXJzaW9uIG9mIGBrbmV4YCBwYXNzZWQgaW50byB0aGUgb2JqZWN0LgogIF8uZXh0ZW5kKGJvb2tzaGVsZiwgRXZlbnRzLCBFcnJvcnMsIHsKCiAgICAvLyBIZWxwZXIgbWV0aG9kIHRvIHdyYXAgYSBzZXJpZXMgb2YgQm9va3NoZWxmIGFjdGlvbnMgaW4gYSBga25leGAgdHJhbnNhY3Rpb24gYmxvY2s7CiAgICB0cmFuc2FjdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmtuZXgudHJhbnNhY3Rpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gUHJvdmlkZXMgYSBuaWNlLCB0ZXN0ZWQsIHN0YW5kYXJkaXplZCB3YXkgb2YgYWRkaW5nIHBsdWdpbnMgdG8gYSBgQm9va3NoZWxmYCBpbnN0YW5jZSwKICAgIC8vIGluamVjdGluZyB0aGUgY3VycmVudCBpbnN0YW5jZSBpbnRvIHRoZSBwbHVnaW4sIHdoaWNoIHNob3VsZCBiZSBhIG1vZHVsZS5leHBvcnRzLgogICAgcGx1Z2luOiBmdW5jdGlvbihwbHVnaW4sIG9wdGlvbnMpIHsKICAgICAgaWYgKF8uaXNTdHJpbmcocGx1Z2luKSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICByZXF1aXJlKCcuL3BsdWdpbnMvJyArIHBsdWdpbikodGhpcywgb3B0aW9ucyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgcmVxdWlyZShwbHVnaW4pKHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkocGx1Z2luKSkgewogICAgICAgIF8uZWFjaChwbHVnaW4sIGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgICAgICAgIHRoaXMucGx1Z2luKHBsdWdpbiwgb3B0aW9ucyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGx1Z2luKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9KTsKCiAgLy8gR3JhYiBhIHJlZmVyZW5jZSB0byB0aGUgYGtuZXhgIGluc3RhbmNlIHBhc3NlZCAob3IgY3JlYXRlZCkgaW4gdGhpcyBjb25zdHJ1Y3RvciwKICAvLyBmb3IgY29udmVuaWVuY2UuCiAgYm9va3NoZWxmLmtuZXggPSBrbmV4OwoKICAvLyBUaGUgYGZvcmdlYCBmdW5jdGlvbiBwcm9wZXJseSBpbnN0YW50aWF0ZXMgYSBuZXcgTW9kZWwgb3IgQ29sbGVjdGlvbgogIC8vIHdpdGhvdXQgbmVlZGluZyB0aGUgYG5ld2Agb3BlcmF0b3IuLi4gdG8gbWFrZSBvYmplY3QgY3JlYXRpb24gY2xlYW5lcgogIC8vIGFuZCBtb3JlIGNoYWluYWJsZS4KICBNb2RlbC5mb3JnZSA9IENvbGxlY3Rpb24uZm9yZ2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0ID0gT2JqZWN0LmNyZWF0ZSh0aGlzLnByb3RvdHlwZSk7CiAgICB2YXIgb2JqID0gdGhpcy5hcHBseShpbnN0LCBhcmd1bWVudHMpOwogICAgcmV0dXJuIChPYmplY3Qob2JqKSA9PT0gb2JqID8gb2JqIDogaW5zdCk7CiAgfTsKCiAgLy8gQXR0YWNoIGB3aGVyZWAsIGBxdWVyeWAsIGFuZCBgZmV0Y2hBbGxgIGFzIHN0YXRpYyBtZXRob2RzLgogIFsnd2hlcmUnLCAncXVlcnknXS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWxbbWV0aG9kXSA9CiAgICBDb2xsZWN0aW9uW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5mb3JnZSgpOwogICAgICByZXR1cm4gbW9kZWxbbWV0aG9kXS5hcHBseShtb2RlbCwgYXJndW1lbnRzKTsKICAgIH07CiAgfSk7CiAgTW9kZWwuZmV0Y2hBbGwgPSBmdW5jdGlvbihvcHRpb25zKSB7IHJldHVybiB0aGlzLmZvcmdlKCkuZmV0Y2hBbGwob3B0aW9ucyk7IH07CgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gcmVxdWlyZSgnc2ltcGxlLWV4dGVuZCcpOwoKICByZXR1cm4gYm9va3NoZWxmOwp9OwoKLy8gRmluYWxseSwgZXhwb3J0IGBCb29rc2hlbGZgIHRvIHRoZSB3b3JsZC4KbW9kdWxlLmV4cG9ydHMgPSBCb29rc2hlbGY7Cn0seyIuL2xpYi9iYXNlL2V2ZW50cyI6NCwiLi9saWIvY29sbGVjdGlvbiI6OCwiLi9saWIvZXJyb3JzIjoxMCwiLi9saWIvbW9kZWwiOjEyLCIuL2xpYi9yZWxhdGlvbiI6MTMsImluaGVyaXRzIjo3Niwia25leCI6NzcsImxvZGFzaCI6MTMwLCJzZW12ZXIiOjEzMSwic2ltcGxlLWV4dGVuZCI6MTMyfV0sMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEJhc2UgQ29sbGVjdGlvbgovLyAtLS0tLS0tLS0tLS0tLS0KCi8vIEFsbCBleGVybmFsIGRlcGVuZGVuY2llcyByZXF1aXJlZCBpbiB0aGlzIHNjb3BlLgp2YXIgXyAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBCYWNrYm9uZSAgPSByZXF1aXJlKCdiYWNrYm9uZScpOwoKLy8gQWxsIGNvbXBvbmVudHMgdGhhdCBuZWVkIHRvIGJlIHJlZmVyZW5jZWQgaW4gdGhpcyBzY29wZS4KdmFyIEV2ZW50cyAgICA9IHJlcXVpcmUoJy4vZXZlbnRzJyk7CnZhciBQcm9taXNlICAgPSByZXF1aXJlKCcuL3Byb21pc2UnKTsKdmFyIE1vZGVsQmFzZSA9IHJlcXVpcmUoJy4vbW9kZWwnKTsKCnZhciBhcnJheSAgPSBbXTsKdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCnZhciBDb2xsZWN0aW9uQmFzZSA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogIGlmIChvcHRpb25zKSBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgY29sbGVjdGlvblByb3BzKSk7CiAgdGhpcy5fcmVzZXQoKTsKICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoIV8uaXNGdW5jdGlvbih0aGlzLm1vZGVsKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBIHZhbGlkIGBtb2RlbGAgY29uc3RydWN0b3IgbXVzdCBiZSBkZWZpbmVkIGZvciBhbGwgY29sbGVjdGlvbnMuJyk7CiAgfQogIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwp9OwoKLy8gTGlzdCBvZiBhdHRyaWJ1dGVzIGF0dGFjaGVkIGRpcmVjdGx5IGZyb20gdGhlIGNvbnN0cnVjdG9yJ3Mgb3B0aW9ucyBvYmplY3QuCnZhciBjb2xsZWN0aW9uUHJvcHMgICA9IFsnbW9kZWwnLCAnY29tcGFyYXRvciddOwoKLy8gQSBsaXN0IG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgb21pdHRlZCBmcm9tIHRoZSBgQmFja2JvbmUuTW9kZWwucHJvdG90eXBlYCwgdG8gY3JlYXRlCi8vIGEgZ2VuZXJpYyBjb2xsZWN0aW9uIGJhc2UuCnZhciBjb2xsZWN0aW9uT21pdHRlZCA9IFsnbW9kZWwnLCAnZmV0Y2gnLCAndXJsJywgJ3N5bmMnLCAnY3JlYXRlJ107CgovLyBDb3BpZWQgb3ZlciBmcm9tIEJhY2tib25lLgp2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwoKXy5leHRlbmQoQ29sbGVjdGlvbkJhc2UucHJvdG90eXBlLCBfLm9taXQoQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUsIGNvbGxlY3Rpb25PbWl0dGVkKSwgRXZlbnRzLCB7CgogIC8vIFRoZSBgdGFibGVOYW1lYCBvbiB0aGUgYXNzb2NpYXRlZCBNb2RlbCwgdXNlZCBpbiByZWxhdGlvbiBidWlsZGluZy4KICB0YWJsZU5hbWU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8ucmVzdWx0KHRoaXMubW9kZWwucHJvdG90eXBlLCAndGFibGVOYW1lJyk7CiAgfSwKCiAgLy8gVGhlIGBpZEF0dHJpYnV0ZWAgb24gdGhlIGFzc29jaWF0ZWQgTW9kZWwsIHVzZWQgaW4gcmVsYXRpb24gYnVpbGRpbmcuCiAgaWRBdHRyaWJ1dGU6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMubW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlOwogIH0sCgogIC8vIEEgc2ltcGxpZmllZCB2ZXJzaW9uIG9mIEJhY2tib25lJ3MgYENvbGxlY3Rpb24jc2V0YCBtZXRob2QsCiAgLy8gcmVtb3ZpbmcgdGhlIGNvbXBhcmF0b3IsIGFuZCBnZXR0aW5nIHJpZCBvZiB0aGUgdGVtcG9yYXJ5IG1vZGVsIGNyZWF0aW9uLAogIC8vIHNpbmNlIHRoZXJlJ3MgKm5vIHdheSogd2UnbGwgYmUgZ2V0dGluZyB0aGUgZGF0YSBpbiBhbiBpbmNvbnNpc3RlbnQKICAvLyBmb3JtIGZyb20gdGhlIGRhdGFiYXNlLgogIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZzsKICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CiAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICB2YXIgb3JkZXIgPSBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgYXR0cnMgPSBtb2RlbHNbaV07CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZV07CiAgICAgIH0KCiAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgIGlmIChleGlzdGluZyA9IHRoaXMuZ2V0KGlkKSkgewogICAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICAgIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAobWVyZ2UpIHsKICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgZXhpc3Rpbmcuc2V0KGF0dHJzLCBvcHRpb25zKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoaXMgaXMgYSBuZXcgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChhdHRycywgb3B0aW9ucykpKSBjb250aW51ZTsKICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICBpZiAob3JkZXIpIG9yZGVyLnB1c2goZXhpc3RpbmcgfHwgbW9kZWwpOwogICAgfQoKICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICBpZiAocmVtb3ZlKSB7CiAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7ICsraSkgewogICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICB9CiAgICAgIGlmICh0b1JlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHRvUmVtb3ZlLCBvcHRpb25zKTsKICAgIH0KCiAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICBpZiAodG9BZGQubGVuZ3RoIHx8IChvcmRlciAmJiBvcmRlci5sZW5ndGgpKSB7CiAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgaWYgKGF0ICE9IG51bGwpIHsKICAgICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIFthdCwgMF0uY29uY2F0KHRvQWRkKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKG9yZGVyKSB7CiAgICAgICAgICB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvcmRlciA9IHRvQWRkOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXIubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyW2ldKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAob3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzOwoKICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgcmV0dXJuIGF0dHJzOwogICAgcmV0dXJuIG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICB9LAoKICAvLyBSdW4gIlByb21pc2UubWFwIiBvdmVyIHRoZSBtb2RlbHMKICBtYXBUaGVuOiBmdW5jdGlvbihpdGVyYXRvciwgY29udGV4dCkgewogICAgcmV0dXJuIFByb21pc2UuYmluZChjb250ZXh0KS50aGVuUmV0dXJuKHRoaXMubW9kZWxzKS5tYXAoaXRlcmF0b3IpOwogIH0sCgogIC8vIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgaW52b2tlLCByZXR1cm5pbmcgYSBgUHJvbWlzZS5hbGxgIHByb21pc2UuCiAgaW52b2tlVGhlbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gUHJvbWlzZS5hbGwodGhpcy5pbnZva2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgfSwKCiAgLy8gUnVuICJyZWR1Y2UiIG92ZXIgdGhlIG1vZGVscyBpbiB0aGUgY29sbGVjdGlvbi4KICByZWR1Y2VUaGVuOiBmdW5jdGlvbihpdGVyYXRvciwgaW5pdGlhbFZhbHVlLCBjb250ZXh0KSB7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKGNvbnRleHQpLnRoZW5SZXR1cm4odGhpcy5tb2RlbHMpLnJlZHVjZShpdGVyYXRvciwgaW5pdGlhbFZhbHVlKS5iaW5kKCk7CiAgfSwKCiAgZmV0Y2g6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIFByb21pc2UucmVqZWN0ZWQoJ1RoZSBmZXRjaCBtZXRob2QgaGFzIG5vdCBiZWVuIGltcGxlbWVudGVkJyk7CiAgfQoKfSk7CgovLyBMaXN0IG9mIGF0dHJpYnV0ZXMgYXR0YWNoZWQgZGlyZWN0bHkgZnJvbSB0aGUgYG9wdGlvbnNgIHBhc3NlZCB0byB0aGUgY29uc3RydWN0b3IuCnZhciBtb2RlbFByb3BzID0gWyd0YWJsZU5hbWUnLCAnaGFzVGltZXN0YW1wcyddOwoKQ29sbGVjdGlvbkJhc2UuZXh0ZW5kID0gcmVxdWlyZSgnc2ltcGxlLWV4dGVuZCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBDb2xsZWN0aW9uQmFzZTsKCn0seyIuL2V2ZW50cyI6NCwiLi9tb2RlbCI6NSwiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJzaW1wbGUtZXh0ZW5kIjoxMzJ9XSwzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gRWFnZXIgQmFzZQovLyAtLS0tLS0tLS0tLS0tLS0KCi8vIFRoZSBFYWdlckJhc2UgcHJvdmlkZXMgYSBzY2FmZm9sZCBmb3IgaGFuZGxpbmcgd2l0aCBlYWdlciByZWxhdGlvbgovLyBwYWlyaW5nLCBieSBxdWV1ZWluZyB0aGUgYXBwcm9wcmlhdGUgcmVsYXRlZCBtZXRob2QgY2FsbHMgd2l0aAovLyBhIGRhdGFiYXNlIHNwZWNpZmljIGBlYWdlckZldGNoYCBtZXRob2QsIHdoaWNoIHRoZW4gbWF5IHV0aWxpemUKLy8gYHB1c2hNb2RlbHNgIGZvciBwYWlyaW5nIHRoZSBtb2RlbHMgZGVwZW5kaW5nIG9uIHRoZSBkYXRhYmFzZSBuZWVkLgoKdmFyIF8gICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgQmFja2JvbmUgID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKdmFyIFByb21pc2UgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKZnVuY3Rpb24gRWFnZXJCYXNlKHBhcmVudCwgcGFyZW50UmVzcG9uc2UsIHRhcmdldCkgewogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMucGFyZW50UmVzcG9uc2UgPSBwYXJlbnRSZXNwb25zZTsKICB0aGlzLnRhcmdldCA9IHRhcmdldDsKfQoKXy5leHRlbmQoRWFnZXJCYXNlLnByb3RvdHlwZSwgewoKICAvLyBUaGlzIGhlbHBlciBmdW5jdGlvbiBpcyB1c2VkIGludGVybmFsbHkgdG8gZGV0ZXJtaW5lIHdoaWNoIHJlbGF0aW9ucwogIC8vIGFyZSBuZWNlc3NhcnkgZm9yIGZldGNoaW5nIGJhc2VkIG9uIHRoZSBgbW9kZWwubG9hZGAgb3IgYHdpdGhSZWxhdGVkYCBvcHRpb24uCiAgZmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHZhciByZWxhdGlvbk5hbWUsIHJlbGF0ZWQsIHJlbGF0aW9uOwogICAgdmFyIHRhcmdldCAgICAgID0gdGhpcy50YXJnZXQ7CiAgICB2YXIgaGFuZGxlZCAgICAgPSB0aGlzLmhhbmRsZWQgPSB7fTsKICAgIHZhciB3aXRoUmVsYXRlZCA9IHRoaXMucHJlcFdpdGhSZWxhdGVkKG9wdGlvbnMud2l0aFJlbGF0ZWQpOwogICAgdmFyIHN1YlJlbGF0ZWQgID0ge307CgogICAgLy8gSW50ZXJuYWwgZmxhZyB0byBkZXRlcm1pbmUgd2hldGhlciB0byBzZXQgdGhlIGN0b3Iocykgb24gdGhlIGBSZWxhdGlvbmAgb2JqZWN0LgogICAgdGFyZ2V0Ll9pc0VhZ2VyID0gdHJ1ZTsKCiAgICAvLyBFYWdlciBsb2FkIGVhY2ggb2YgdGhlIGB3aXRoUmVsYXRlZGAgcmVsYXRpb24gaXRlbSwgc3BsaXR0aW5nIG9uICcuJwogICAgLy8gd2hpY2ggaW5kaWNhdGVzIGEgbmVzdGVkIGVhZ2VyIGxvYWQuCiAgICBmb3IgKHZhciBrZXkgaW4gd2l0aFJlbGF0ZWQpIHsKCiAgICAgIHJlbGF0ZWQgPSBrZXkuc3BsaXQoJy4nKTsKICAgICAgcmVsYXRpb25OYW1lID0gcmVsYXRlZFswXTsKCiAgICAgIC8vIEFkZCBhZGRpdGlvbmFsIGVhZ2VyIGl0ZW1zIHRvIGFuIGFycmF5LCB0byBsb2FkIGF0IHRoZSBuZXh0IGxldmVsIGluIHRoZSBxdWVyeS4KICAgICAgaWYgKHJlbGF0ZWQubGVuZ3RoID4gMSkgewogICAgICAgIHZhciByZWxhdGVkT2JqID0ge307CiAgICAgICAgc3ViUmVsYXRlZFtyZWxhdGlvbk5hbWVdIHx8IChzdWJSZWxhdGVkW3JlbGF0aW9uTmFtZV0gPSBbXSk7CiAgICAgICAgcmVsYXRlZE9ialtyZWxhdGVkLnNsaWNlKDEpLmpvaW4oJy4nKV0gPSB3aXRoUmVsYXRlZFtrZXldOwogICAgICAgIHN1YlJlbGF0ZWRbcmVsYXRpb25OYW1lXS5wdXNoKHJlbGF0ZWRPYmopOwogICAgICB9CgogICAgICAvLyBPbmx5IGFsbG93IG9uZSBvZiBhIGNlcnRhaW4gbmVzdGVkIHR5cGUgcGVyLWxldmVsLgogICAgICBpZiAoaGFuZGxlZFtyZWxhdGlvbk5hbWVdKSBjb250aW51ZTsKCiAgICAgIHJlbGF0aW9uID0gdGFyZ2V0W3JlbGF0aW9uTmFtZV0oKTsKCiAgICAgIGlmICghcmVsYXRpb24pIHRocm93IG5ldyBFcnJvcihyZWxhdGlvbk5hbWUgKyAnIGlzIG5vdCBkZWZpbmVkIG9uIHRoZSBtb2RlbC4nKTsKCiAgICAgIGhhbmRsZWRbcmVsYXRpb25OYW1lXSA9IHJlbGF0aW9uOwogICAgfQoKICAgIC8vIERlbGV0ZSB0aGUgaW50ZXJuYWwgZmxhZyBmcm9tIHRoZSBtb2RlbC4KICAgIGRlbGV0ZSB0YXJnZXQuX2lzRWFnZXI7CgogICAgLy8gRmV0Y2ggYWxsIGVhZ2VyIGxvYWRlZCBtb2RlbHMsIGxvYWRpbmcgdGhlbSBvbnRvCiAgICAvLyBhbiBhcnJheSBvZiBwZW5kaW5nIGRlZmVycmVkIG9iamVjdHMsIHdoaWNoIHdpbGwgaGFuZGxlCiAgICAvLyBhbGwgbmVjZXNzYXJ5IHBhaXJpbmcgd2l0aCBwYXJlbnQgb2JqZWN0cywgZXRjLgogICAgdmFyIHBlbmRpbmdEZWZlcnJlZCA9IFtdOwogICAgZm9yIChyZWxhdGlvbk5hbWUgaW4gaGFuZGxlZCkgewogICAgICBwZW5kaW5nRGVmZXJyZWQucHVzaCh0aGlzLmVhZ2VyRmV0Y2gocmVsYXRpb25OYW1lLCBoYW5kbGVkW3JlbGF0aW9uTmFtZV0sIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7CiAgICAgICAgaXNFYWdlcjogdHJ1ZSwKICAgICAgICB3aXRoUmVsYXRlZDogc3ViUmVsYXRlZFtyZWxhdGlvbk5hbWVdLAogICAgICAgIF9iZWZvcmVGbjogd2l0aFJlbGF0ZWRbcmVsYXRpb25OYW1lXSB8fCBub29wCiAgICAgIH0pKSk7CiAgICB9CgogICAgLy8gUmV0dXJuIGEgZGVmZXJyZWQgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBuZXN0ZWQgb2JqZWN0IHN5bmMKICAgIC8vIHJldHVybmluZyB0aGUgb3JpZ2luYWwgcmVzcG9uc2Ugd2hlbiB0aGVzZSBzeW5jcyAmIHBhaXJpbmdzIGFyZSBjb21wbGV0ZS4KICAgIHJldHVybiBQcm9taXNlLmFsbChwZW5kaW5nRGVmZXJyZWQpLnlpZWxkKHRoaXMucGFyZW50UmVzcG9uc2UpOwogIH0pLAoKICAvLyBQcmVwIHRoZSBgd2l0aFJlbGF0ZWRgIG9iamVjdCwgdG8gbm9ybWFsaXplIGludG8gYW4gb2JqZWN0IHdoZXJlIGVhY2gKICAvLyBoYXMgYSBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCB3aGVuIHJ1bm5pbmcgdGhlIHF1ZXJ5LgogIHByZXBXaXRoUmVsYXRlZDogZnVuY3Rpb24od2l0aFJlbGF0ZWQpIHsKICAgIGlmICghXy5pc0FycmF5KHdpdGhSZWxhdGVkKSkgd2l0aFJlbGF0ZWQgPSBbd2l0aFJlbGF0ZWRdOwogICAgdmFyIG9iaiA9IHt9OwogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB3aXRoUmVsYXRlZC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIHJlbGF0ZWQgPSB3aXRoUmVsYXRlZFtpXTsKICAgICAgXy5pc1N0cmluZyhyZWxhdGVkKSA/IG9ialtyZWxhdGVkXSA9IG5vb3AgOiBfLmV4dGVuZChvYmosIHJlbGF0ZWQpOwogICAgfQogICAgcmV0dXJuIG9iajsKICB9LAoKICAvLyBQdXNoZXMgZWFjaCBvZiB0aGUgaW5jb21pbmcgbW9kZWxzIG9udG8gYSBuZXcgYHJlbGF0ZWRgIGFycmF5LAogIC8vIHdoaWNoIGlzIHVzZWQgdG8gY29ycmVjbHkgcGFpciBhZGRpdGlvbmFsIG5lc3RlZCByZWxhdGlvbnMuCiAgcHVzaE1vZGVsczogZnVuY3Rpb24ocmVsYXRpb25OYW1lLCBoYW5kbGVkLCByZXNwKSB7CiAgICB2YXIgbW9kZWxzICAgICAgPSB0aGlzLnBhcmVudDsKICAgIHZhciByZWxhdGVkRGF0YSA9IGhhbmRsZWQucmVsYXRlZERhdGE7CiAgICB2YXIgcmVsYXRlZCAgICAgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gcmVzcC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcmVsYXRlZC5wdXNoKHJlbGF0ZWREYXRhLmNyZWF0ZU1vZGVsKHJlc3BbaV0pKTsKICAgIH0KICAgIHJldHVybiByZWxhdGVkRGF0YS5lYWdlclBhaXIocmVsYXRpb25OYW1lLCByZWxhdGVkLCBtb2RlbHMpOwogIH0KCn0pOwoKdmFyIG5vb3AgPSBmdW5jdGlvbigpIHt9OwoKbW9kdWxlLmV4cG9ydHMgPSBFYWdlckJhc2U7Cn0seyIuL3Byb21pc2UiOjYsImJhY2tib25lIjoxNSwibG9kYXNoIjoxMzB9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gRXZlbnRzCi8vIC0tLS0tLS0tLS0tLS0tLQoKdmFyIFByb21pc2UgICAgID0gcmVxdWlyZSgnLi9wcm9taXNlJyk7CnZhciBCYWNrYm9uZSAgICA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CnZhciB0cmlnZ2VyVGhlbiA9IHJlcXVpcmUoJ3RyaWdnZXItdGhlbicpOwp2YXIgXyAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKCkJhY2tib25lLkV2ZW50cy5vbmNlID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIC8vaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9KTsKICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKfTsKCi8vIE1peGluIHRoZSBgdHJpZ2dlclRoZW5gIGZ1bmN0aW9uIGludG8gYWxsIHJlbGV2YW50IEJhY2tib25lIG9iamVjdHMsCi8vIHNvIHdlIGNhbiBoYXZlIGV2ZW50IGRyaXZlbiBhc3luYyB2YWxpZGF0aW9ucywgZnVuY3Rpb25zLCBldGMuCnRyaWdnZXJUaGVuKEJhY2tib25lLCBQcm9taXNlKTsKCm1vZHVsZS5leHBvcnRzID0gQmFja2JvbmUuRXZlbnRzOwp9LHsiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJ0cmlnZ2VyLXRoZW4iOjEzM31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBCYXNlIE1vZGVsCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKCnZhciBFdmVudHMgICA9IHJlcXVpcmUoJy4vZXZlbnRzJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKLy8gQSBsaXN0IG9mIHByb3BlcnRpZXMgdGhhdCBhcmUgb21pdHRlZCBmcm9tIHRoZSBgQmFja2JvbmUuTW9kZWwucHJvdG90eXBlYCwgdG8gY3JlYXRlCi8vIGEgZ2VuZXJpYyBtb2RlbCBiYXNlLgp2YXIgbW9kZWxPbWl0dGVkID0gWwogICdjaGFuZ2VkQXR0cmlidXRlcycsICdpc1ZhbGlkJywgJ3ZhbGlkYXRpb25FcnJvcicsCiAgJ3NhdmUnLCAnc3luYycsICdmZXRjaCcsICdkZXN0cm95JywgJ3VybCcsCiAgJ3VybFJvb3QnLCAnX3ZhbGlkYXRlJwpdOwoKLy8gTGlzdCBvZiBhdHRyaWJ1dGVzIGF0dGFjaGVkIGRpcmVjdGx5IGZyb20gdGhlIGBvcHRpb25zYCBwYXNzZWQgdG8gdGhlIGNvbnN0cnVjdG9yLgp2YXIgbW9kZWxQcm9wcyA9IFsndGFibGVOYW1lJywgJ2hhc1RpbWVzdGFtcHMnXTsKCi8vIFRoZSAiTW9kZWxCYXNlIiBpcyBzaW1pbGFyIHRvIHRoZSAnQWN0aXZlIE1vZGVsJyBpbiBSYWlscywKLy8gaXQgZGVmaW5lcyBhIHN0YW5kYXJkIGludGVyZmFjZSBmcm9tIHdoaWNoIG90aGVyIG9iamVjdHMgbWF5Ci8vIGluaGVyaXQuCnZhciBNb2RlbEJhc2UgPSBmdW5jdGlvbihhdHRyaWJ1dGVzLCBvcHRpb25zKSB7CiAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogIHRoaXMuYXR0cmlidXRlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdGhpcy5fcmVzZXQoKTsKICB0aGlzLnJlbGF0aW9ucyA9IHt9OwogIHRoaXMuY2lkICA9IF8udW5pcXVlSWQoJ2MnKTsKICBpZiAob3B0aW9ucykgewogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIG1vZGVsUHJvcHMpKTsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogIH0KICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07CgpfLmV4dGVuZChNb2RlbEJhc2UucHJvdG90eXBlLCBfLm9taXQoQmFja2JvbmUuTW9kZWwucHJvdG90eXBlLCBtb2RlbE9taXR0ZWQpLCBFdmVudHMsIHsKCiAgLy8gU2ltaWxhciB0byB0aGUgc3RhbmRhcmQgYEJhY2tib25lYCBzZXQgbWV0aG9kLCBidXQgd2l0aG91dCBpbmRpdmlkdWFsCiAgLy8gY2hhbmdlIGV2ZW50cywgYW5kIGFkZGluZyBkaWZmZXJlbnQgbWVhbmluZyB0byBgY2hhbmdlZGAgYW5kIGBwcmV2aW91c0F0dHJpYnV0ZXNgCiAgLy8gZGVmaW5lZCBhcyB0aGUgbGFzdCAic3luYyInZWQgc3RhdGUgb2YgdGhlIG1vZGVsLgogIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CiAgICB2YXIgYXR0cnM7CgogICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ29iamVjdCcpIHsKICAgICAgYXR0cnMgPSBrZXk7CiAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICB9IGVsc2UgewogICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgIH0KICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgdmFyIGhhc0NoYW5nZWQgPSBmYWxzZTsKICAgIHZhciB1bnNldCAgID0gb3B0aW9ucy51bnNldDsKICAgIHZhciBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzOwogICAgdmFyIHByZXYgICAgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgLy8gRm9yIGVhY2ggYHNldGAgYXR0cmlidXRlLCB1cGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLgogICAgZm9yICh2YXIgYXR0ciBpbiBhdHRycykgewogICAgICB2YWwgPSBhdHRyc1thdHRyXTsKICAgICAgaWYgKCFfLmlzRXF1YWwocHJldlthdHRyXSwgdmFsKSkgewogICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICBpZiAoIV8uaXNFcXVhbChjdXJyZW50W2F0dHJdLCB2YWwpKSBoYXNDaGFuZ2VkID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkZWxldGUgdGhpcy5jaGFuZ2VkW2F0dHJdOwogICAgICB9CiAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgfQoKICAgIGlmIChoYXNDaGFuZ2VkICYmICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIFJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYSBzaGFsbG93IGNvcHkgb2YgdGhlIG1vZGVsIGF0dHJpYnV0ZXMsCiAgLy8gYWxvbmcgd2l0aCB0aGUgYHRvSlNPTmAgdmFsdWUgb2YgYW55IHJlbGF0aW9ucywKICAvLyB1bmxlc3MgYHtzaGFsbG93OiB0cnVlfWAgaXMgcGFzc2VkIGluIHRoZSBgb3B0aW9uc2AuCiAgLy8gQWxzbyBpbmNsdWRlcyBfcGl2b3RfIGtleXMgZm9yIHJlbGF0aW9ucyB1bmxlc3MgYHtvbWl0UGl2b3Q6IHRydWV9YAogIC8vIGlzIHBhc3NlZCBpbiBgb3B0aW9uc2AuCiAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2hhbGxvdykgcmV0dXJuIGF0dHJzOwogICAgdmFyIHJlbGF0aW9ucyA9IHRoaXMucmVsYXRpb25zOwogICAgZm9yICh2YXIga2V5IGluIHJlbGF0aW9ucykgewogICAgICB2YXIgcmVsYXRpb24gPSByZWxhdGlvbnNba2V5XTsKICAgICAgYXR0cnNba2V5XSA9IHJlbGF0aW9uLnRvSlNPTiA/IHJlbGF0aW9uLnRvSlNPTihvcHRpb25zKSA6IHJlbGF0aW9uOwogICAgfQogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5vbWl0UGl2b3QpIHJldHVybiBhdHRyczsKICAgIGlmICh0aGlzLnBpdm90KSB7CiAgICAgIHZhciBwaXZvdCA9IHRoaXMucGl2b3QuYXR0cmlidXRlczsKICAgICAgZm9yIChrZXkgaW4gcGl2b3QpIHsKICAgICAgICBhdHRyc1snX3Bpdm90XycgKyBrZXldID0gcGl2b3Rba2V5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGF0dHJzOwogIH0sCgogIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgcmV0dXJuIHJlc3A7CiAgfSwKCiAgLy8gKipmb3JtYXQqKiBjb252ZXJ0cyBhIG1vZGVsIGludG8gdGhlIHZhbHVlcyB0aGF0IHNob3VsZCBiZSBzYXZlZCBpbnRvCiAgLy8gdGhlIGRhdGFiYXNlIHRhYmxlLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIGRhdGEgYWxvbmcuCiAgZm9ybWF0OiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgcmV0dXJuIGF0dHJzOwogIH0sCgogIC8vIFJldHVybnMgdGhlIHJlbGF0ZWQgaXRlbSwgb3IgY3JlYXRlcyBhIG5ldwogIC8vIHJlbGF0ZWQgaXRlbSBieSBjcmVhdGluZyBhIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uLgogIHJlbGF0ZWQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHJldHVybiB0aGlzLnJlbGF0aW9uc1tuYW1lXSB8fCAodGhpc1tuYW1lXSA/IHRoaXMucmVsYXRpb25zW25hbWVdID0gdGhpc1tuYW1lXSgpIDogdm9pZCAwKTsKICB9LAoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZSwKICAvLyBpbmNsdWRpbmcgYW55IHJlbGF0aW9ucyBvbiB0aGUgY3VycmVudCBtb2RlbC4KICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgdmFyIHJlbGF0aW9ucyA9IHRoaXMucmVsYXRpb25zOwogICAgZm9yICh2YXIga2V5IGluIHJlbGF0aW9ucykgewogICAgICBtb2RlbC5yZWxhdGlvbnNba2V5XSA9IHJlbGF0aW9uc1trZXldLmNsb25lKCk7CiAgICB9CiAgICBtb2RlbC5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgbW9kZWwuY2hhbmdlZCA9IF8uY2xvbmUodGhpcy5jaGFuZ2VkKTsKICAgIHJldHVybiBtb2RlbDsKICB9LAoKICAvLyBTZXRzIHRoZSB0aW1lc3RhbXBzIGJlZm9yZSBzYXZpbmcgdGhlIG1vZGVsLgogIHRpbWVzdGFtcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgdmFyIGtleXMgPSAoXy5pc0FycmF5KHRoaXMuaGFzVGltZXN0YW1wcykgPyB0aGlzLmhhc1RpbWVzdGFtcHMgOiBbJ2NyZWF0ZWRfYXQnLCAndXBkYXRlZF9hdCddKTsKICAgIHZhciB2YWxzID0ge307CiAgICBpZiAoa2V5c1swXSkgewogICAgICBpZiAodGhpcy5pc05ldyhvcHRpb25zKSkgewogICAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zLm1ldGhvZCAhPT0gJ3VwZGF0ZScpIHsKICAgICAgICAgIHZhbHNba2V5c1swXV0gPSBkOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWV0aG9kID09PSAnaW5zZXJ0JykgewogICAgICAgIHZhbHNba2V5c1swXV0gPSBkOwogICAgICB9CiAgICB9CiAgICBpZiAoa2V5c1sxXSkgdmFsc1trZXlzWzFdXSA9IGQ7CiAgICByZXR1cm4gdmFsczsKICB9LAoKICAvLyBDYWxsZWQgYWZ0ZXIgYSBgc3luY2AgYWN0aW9uIChzYXZlLCBmZXRjaCwgZGVsZXRlKSAtCiAgLy8gcmVzZXRzIHRoZSBgX3ByZXZpb3VzQXR0cmlidXRlc2AgYW5kIGBjaGFuZ2VkYCBoYXNoIGZvciB0aGUgbW9kZWwuCiAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uZXh0ZW5kKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuYXR0cmlidXRlcyk7CiAgICB0aGlzLmNoYW5nZWQgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgZmV0Y2g6IGZ1bmN0aW9uKCkge30sCgogIHNhdmU6IGZ1bmN0aW9uKCkge30sCgogIC8vIERlc3Ryb3kgYSBtb2RlbCwgY2FsbGluZyBhICJkZWxldGUiIGJhc2VkIG9uIGl0cyBgaWRBdHRyaWJ1dGVgLgogIC8vIEEgImRlc3Ryb3lpbmciIGFuZCAiZGVzdHJveWVkIiBhcmUgdHJpZ2dlcmVkIG9uIHRoZSBtb2RlbCBiZWZvcmUKICAvLyBhbmQgYWZ0ZXIgdGhlIG1vZGVsIGlzIGRlc3Ryb3llZCwgcmVzcGVjdGl2ZWx5LiBJZiBhbiBlcnJvciBpcyB0aHJvd24KICAvLyBkdXJpbmcgdGhlICJkZXN0cm95aW5nIiBldmVudCwgdGhlIG1vZGVsIHdpbGwgbm90IGJlIGRlc3Ryb3llZC4KICBkZXN0cm95OiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIHZhciBzeW5jID0gdGhpcy5zeW5jKG9wdGlvbnMpOwogICAgb3B0aW9ucy5xdWVyeSA9IHN5bmMucXVlcnk7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdkZXN0cm95aW5nJywgdGhpcywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3luYy5kZWwoKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzcCkgewogICAgICB0aGlzLmNsZWFyKCk7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdkZXN0cm95ZWQnLCB0aGlzLCByZXNwLCBvcHRpb25zKTsKICAgIH0pLnRoZW4odGhpcy5fcmVzZXQpOwogIH0pCgp9KTsKCk1vZGVsQmFzZS5leHRlbmQgPSByZXF1aXJlKCdzaW1wbGUtZXh0ZW5kJyk7Cgptb2R1bGUuZXhwb3J0cyA9IE1vZGVsQmFzZTsKCn0seyIuL2V2ZW50cyI6NCwiLi9wcm9taXNlIjo2LCJiYWNrYm9uZSI6MTUsImxvZGFzaCI6MTMwLCJzaW1wbGUtZXh0ZW5kIjoxMzJ9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZC9qcy9tYWluL3Byb21pc2UnKSgpOwoKUHJvbWlzZS5wcm90b3R5cGUueWllbGQgPSBQcm9taXNlLnByb3RvdHlwZS5yZXR1cm47ClByb21pc2UucHJvdG90eXBlLmVuc3VyZSA9IFByb21pc2UucHJvdG90eXBlLmxhc3RseTsKUHJvbWlzZS5wcm90b3R5cGUub3RoZXJ3aXNlID0gUHJvbWlzZS5wcm90b3R5cGUuY2F1Z2h0OwpQcm9taXNlLnByb3RvdHlwZS5leGVjID0gUHJvbWlzZS5wcm90b3R5cGUubm9kZWlmeTsKClByb21pc2UucmVzb2x2ZSA9IFByb21pc2UuZnVsZmlsbGVkOwpQcm9taXNlLnJlamVjdCAgPSBQcm9taXNlLnJlamVjdGVkOwoKbW9kdWxlLmV4cG9ydHMgPSBQcm9taXNlOwp9LHsiYmx1ZWJpcmQvanMvbWFpbi9wcm9taXNlIjozNX1dLDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBCYXNlIFJlbGF0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLQoKdmFyIF8gICAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBCYWNrYm9uZSAgICAgICA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CnZhciBDb2xsZWN0aW9uQmFzZSA9IHJlcXVpcmUoJy4vY29sbGVjdGlvbicpOwoKLy8gVXNlZCBpbnRlcm5hbGx5LCB0aGUgYFJlbGF0aW9uYCBoZWxwcyBpbiBzaW1wbGlmeWluZyB0aGUgcmVsYXRpb25zaGlwIGJ1aWxkaW5nLAovLyBjZW50cmFsaXppbmcgYWxsIGxvZ2ljIGRlYWxpbmcgd2l0aCB0eXBlICYgb3B0aW9uIGhhbmRsaW5nLgpmdW5jdGlvbiBSZWxhdGlvbkJhc2UodHlwZSwgVGFyZ2V0LCBvcHRpb25zKSB7CiAgdGhpcy50eXBlID0gdHlwZTsKICBpZiAodGhpcy50YXJnZXQgPSBUYXJnZXQpIHsKICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICAgPSBfLnJlc3VsdChUYXJnZXQucHJvdG90eXBlLCAndGFibGVOYW1lJyk7CiAgICB0aGlzLnRhcmdldElkQXR0cmlidXRlID0gXy5yZXN1bHQoVGFyZ2V0LnByb3RvdHlwZSwgJ2lkQXR0cmlidXRlJyk7CiAgfQogIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMpOwp9CgpfLmV4dGVuZChSZWxhdGlvbkJhc2UucHJvdG90eXBlLCB7CgogIC8vIENyZWF0ZXMgYSBuZXcgcmVsYXRpb24gaW5zdGFuY2UsIHVzZWQgYnkgdGhlIGBFYWdlcmAgcmVsYXRpb24gaW4KICAvLyBkZWFsaW5nIHdpdGggYG1vcnBoVG9gIGNhc2VzLCB3aGVyZSB0aGUgc2FtZSByZWxhdGlvbiBpcyB0YXJnZXRpbmcgbXVsdGlwbGUgbW9kZWxzLgogIGluc3RhbmNlOiBmdW5jdGlvbih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0eXBlLCBUYXJnZXQsIG9wdGlvbnMpOwogIH0sCgogIC8vIENyZWF0ZXMgYSBuZXcsIHVucGFyc2VkIG1vZGVsLCB1c2VkIGludGVybmFsbHkgaW4gdGhlIGVhZ2VyIGZldGNoIGhlbHBlcgogIC8vIG1ldGhvZHMuIChQYXJzaW5nIG1heSBtdXRhdGUgaW5mb3JtYXRpb24gbmVjZXNzYXJ5IGZvciBlYWdlciBwYWlyaW5nLikKICBjcmVhdGVNb2RlbDogZnVuY3Rpb24oZGF0YSkgewogICAgaWYgKHRoaXMudGFyZ2V0LnByb3RvdHlwZSBpbnN0YW5jZW9mIENvbGxlY3Rpb25CYXNlKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy50YXJnZXQucHJvdG90eXBlLm1vZGVsKGRhdGEpLl9yZXNldCgpOwogICAgfQogICAgcmV0dXJuIG5ldyB0aGlzLnRhcmdldChkYXRhKS5fcmVzZXQoKTsKICB9LAoKICAvLyBFYWdlciBwYWlyIHRoZSBtb2RlbHMuCiAgZWFnZXJQYWlyOiBmdW5jdGlvbigpIHt9Cgp9KTsKClJlbGF0aW9uQmFzZS5leHRlbmQgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQ7Cgptb2R1bGUuZXhwb3J0cyA9IFJlbGF0aW9uQmFzZTsKfSx7Ii4vY29sbGVjdGlvbiI6MiwiYmFja2JvbmUiOjE1LCJsb2Rhc2giOjEzMH1dLDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb2xsZWN0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCnZhciBTeW5jICAgICAgICAgICA9IHJlcXVpcmUoJy4vc3luYycpOwp2YXIgSGVscGVycyAgICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIEVhZ2VyUmVsYXRpb24gID0gcmVxdWlyZSgnLi9lYWdlcicpOwp2YXIgRXJyb3JzICAgICAgICAgPSByZXF1aXJlKCcuL2Vycm9ycycpOwoKdmFyIENvbGxlY3Rpb25CYXNlID0gcmVxdWlyZSgnLi9iYXNlL2NvbGxlY3Rpb24nKTsKdmFyIFByb21pc2UgICAgICAgID0gcmVxdWlyZSgnLi9iYXNlL3Byb21pc2UnKTsKCmZ1bmN0aW9uIEJvb2tzaGVsZkNvbGxlY3Rpb24oKSB7CiAgQ29sbGVjdGlvbkJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZDb2xsZWN0aW9uLCBDb2xsZWN0aW9uQmFzZSk7CgpCb29rc2hlbGZDb2xsZWN0aW9uLkVtcHR5RXJyb3IgPSBFcnJvcnMuRW1wdHlFcnJvcjsKCl8uZXh0ZW5kKEJvb2tzaGVsZkNvbGxlY3Rpb24ucHJvdG90eXBlLCB7CgogIC8vIFVzZWQgdG8gZGVmaW5lIHBhc3N0aHJvdWdoIHJlbGF0aW9uc2hpcHMgLSBgaGFzT25lYCwgYGhhc01hbnlgLAogIC8vIGBiZWxvbmdzVG9gIG9yIGBiZWxvbmdzVG9NYW55YCwgInRocm91Z2giIGEgYEludGVyaW1gIG1vZGVsIG9yIGNvbGxlY3Rpb24uCiAgdGhyb3VnaDogZnVuY3Rpb24oSW50ZXJpbSwgZm9yZWlnbktleSwgb3RoZXJLZXkpIHsKICAgIHJldHVybiB0aGlzLnJlbGF0ZWREYXRhLnRocm91Z2godGhpcywgSW50ZXJpbSwge3Rocm91Z2hGb3JlaWduS2V5OiBmb3JlaWduS2V5LCBvdGhlcktleTogb3RoZXJLZXl9KTsKICB9LAoKICAvLyBGZXRjaCB0aGUgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUgbW9kZWxzCiAgLy8gZm9yIHRoZSBxdWVyeSB3aGVuIHRoZXkgYXJyaXZlLgogIGZldGNoOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIHJldHVybiB0aGlzLnN5bmMob3B0aW9ucykKICAgICAgLnNlbGVjdCgpCiAgICAgIC5iaW5kKHRoaXMpCiAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAoIXJlc3BvbnNlIHx8IHJlc3BvbnNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgaWYgKG9wdGlvbnMucmVxdWlyZSkgdGhyb3cgbmV3IEVycm9ycy5FbXB0eUVycm9yKCdFbXB0eVJlc3BvbnNlJyk7CiAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobnVsbCk7CiAgICAgICAgfQogICAgICB9KQoKICAgICAgLy8gTm93LCBsb2FkIGFsbCBvZiB0aGUgZGF0YSBvbnRvIHRoZSBjb2xsZWN0aW9uIGFzIG5lY2Vzc2FyeS4KICAgICAgLnRhcCh0aGlzLl9oYW5kbGVSZXNwb25zZSkKCiAgICAgIC8vIElmIHRoZSAid2l0aFJlbGF0ZWQiIGlzIHNwZWNpZmllZCwgd2UgYWxzbyBuZWVkIHRvIGVhZ2VyIGxvYWQgYWxsIG9mIHRoZQogICAgICAvLyBkYXRhIG9uIHRoZSBjb2xsZWN0aW9uLCBhcyBhIHNpZGUtZWZmZWN0LCBiZWZvcmUgd2UgdWx0aW1hdGVseSBqdW1wIGludG8gdGhlCiAgICAgIC8vIG5leHQgc3RlcCBvZiB0aGUgY29sbGVjdGlvbi4gU2luY2UgdGhlIGBjb2x1bW5zYCBhcmUgb25seSByZWxldmFudCB0byB0aGUgY3VycmVudAogICAgICAvLyBsZXZlbCwgZW5zdXJlIHRob3NlIGFyZSBvbWl0dGVkIGZyb20gdGhlIG9wdGlvbnMuCiAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICBpZiAob3B0aW9ucy53aXRoUmVsYXRlZCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUVhZ2VyKHJlc3BvbnNlLCBfLm9taXQob3B0aW9ucywgJ2NvbHVtbnMnKSk7CiAgICAgICAgfQogICAgICB9KQogICAgICAudGFwKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2ZldGNoZWQnLCB0aGlzLCByZXNwb25zZSwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgICBpZiAoZXJyICE9PSBudWxsKSB0aHJvdyBlcnI7CiAgICAgICAgdGhpcy5yZXNldChbXSwge3NpbGVudDogdHJ1ZX0pOwogICAgICB9KQogICAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBGZXRjaGVzIGEgc2luZ2xlIG1vZGVsIGZyb20gdGhlIGNvbGxlY3Rpb24sIHVzZWZ1bCBvbiByZWxhdGVkIGNvbGxlY3Rpb25zLgogIGZldGNoT25lOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbDsKICAgIG1vZGVsLl9rbmV4ID0gdGhpcy5xdWVyeSgpLmNsb25lKCk7CiAgICB0aGlzLnJlc2V0UXVlcnkoKTsKICAgIGlmICh0aGlzLnJlbGF0ZWREYXRhKSBtb2RlbC5yZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICByZXR1cm4gbW9kZWwuZmV0Y2gob3B0aW9ucyk7CiAgfSksCgogIC8vIEVhZ2VyIGxvYWRzIHJlbGF0aW9uc2hpcHMgb250byBhbiBhbHJlYWR5IHBvcHVsYXRlZCBgQ29sbGVjdGlvbmAgaW5zdGFuY2UuCiAgbG9hZDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ocmVsYXRpb25zLCBvcHRpb25zKSB7CiAgICBfLmlzQXJyYXkocmVsYXRpb25zKSB8fCAocmVsYXRpb25zID0gW3JlbGF0aW9uc10pOwogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7c2hhbGxvdzogdHJ1ZSwgd2l0aFJlbGF0ZWQ6IHJlbGF0aW9uc30pOwogICAgcmV0dXJuIG5ldyBFYWdlclJlbGF0aW9uKHRoaXMubW9kZWxzLCB0aGlzLnRvSlNPTihvcHRpb25zKSwgbmV3IHRoaXMubW9kZWwoKSkKICAgICAgLmZldGNoKG9wdGlvbnMpCiAgICAgIC5yZXR1cm4odGhpcyk7CiAgfSksCgogIC8vIFNob3J0Y3V0IGZvciBjcmVhdGluZyBhIG5ldyBtb2RlbCwgc2F2aW5nLCBhbmQgYWRkaW5nIHRvIHRoZSBjb2xsZWN0aW9uLgogIC8vIFJldHVybnMgYSBwcm9taXNlIHdoaWNoIHdpbGwgcmVzb2x2ZSB3aXRoIHRoZSBtb2RlbCBhZGRlZCB0byB0aGUgY29sbGVjdGlvbi4KICAvLyBJZiB0aGUgbW9kZWwgaXMgYSByZWxhdGlvbiwgcHV0IHRoZSBgZm9yZWlnbktleWAgYW5kIGBma1ZhbHVlYCBmcm9tIHRoZSBgcmVsYXRlZERhdGFgCiAgLy8gaGFzaCBpbnRvIHRoZSBpbnNlcnRlZCBtb2RlbC4gQWxzbywgaWYgdGhlIG1vZGVsIGlzIGEgYG1hbnlUb01hbnlgIHJlbGF0aW9uLAogIC8vIGF1dG9tYXRpY2FsbHkgY3JlYXRlIHRoZSBqb2luaW5nIG1vZGVsIHVwb24gaW5zZXJ0aW9uLgogIGNyZWF0ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgdmFyIHJlbGF0ZWREYXRhID0gdGhpcy5yZWxhdGVkRGF0YTsKICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKCiAgICAvLyBJZiB3ZSd2ZSBhbHJlYWR5IGFkZGVkIHRoaW5ncyBvbiB0aGUgcXVlcnkgY2hhaW4sCiAgICAvLyB0aGVzZSBhcmUgbGlrZWx5IGludGVuZGVkIGZvciB0aGUgbW9kZWwuCiAgICBpZiAodGhpcy5fa25leCkgewogICAgICBtb2RlbC5fa25leCA9IHRoaXMuX2tuZXg7CiAgICAgIHRoaXMucmVzZXRRdWVyeSgpOwogICAgfQogICAgcmV0dXJuIEhlbHBlcnMKICAgICAgLnNhdmVDb25zdHJhaW50cyhtb2RlbCwgcmVsYXRlZERhdGEpCiAgICAgIC5zYXZlKG51bGwsIG9wdGlvbnMpCiAgICAgIC5iaW5kKHRoaXMpCiAgICAgIC50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChyZWxhdGVkRGF0YSAmJiAocmVsYXRlZERhdGEudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknIHx8IHJlbGF0ZWREYXRhLmlzVGhyb3VnaCgpKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoKG1vZGVsLCBfLm9taXQob3B0aW9ucywgJ3F1ZXJ5JykpOwogICAgICAgIH0KICAgICAgfSkKICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7IHRoaXMuYWRkKG1vZGVsLCBvcHRpb25zKTsgfSkKICAgICAgLnJldHVybihtb2RlbCk7CiAgfSksCgogIC8vIFJlc2V0IHRoZSBxdWVyeSBidWlsZGVyLCBjYWxsZWQgaW50ZXJuYWxseQogIC8vIGVhY2ggdGltZSBhIHF1ZXJ5IGlzIHJ1bi4KICByZXNldFF1ZXJ5OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2tuZXggPSBudWxsOwogICAgcmV0dXJuIHRoaXM7CiAgfSwKCiAgLy8gUmV0dXJucyBhbiBpbnN0YW5jZSBvZiB0aGUgcXVlcnkgYnVpbGRlci4KICBxdWVyeTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gSGVscGVycy5xdWVyeSh0aGlzLCBfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgfSwKCiAgLy8gQ3JlYXRlcyBhbmQgcmV0dXJucyBhIG5ldyBgQm9va3NoZWxmLlN5bmNgIGluc3RhbmNlLgogIHN5bmM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgU3luYyh0aGlzLCBvcHRpb25zKTsKICB9LAoKICAvLyBIYW5kbGVzIHRoZSByZXNwb25zZSBkYXRhIGZvciB0aGUgY29sbGVjdGlvbiwgcmV0dXJuaW5nIGZyb20gdGhlIGNvbGxlY3Rpb24ncyBmZXRjaCBjYWxsLgogIF9oYW5kbGVSZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgIHZhciByZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB0aGlzLnNldChyZXNwb25zZSwge3NpbGVudDogdHJ1ZSwgcGFyc2U6IHRydWV9KS5pbnZva2UoJ19yZXNldCcpOwogICAgaWYgKHJlbGF0ZWREYXRhICYmIHJlbGF0ZWREYXRhLmlzSm9pbmVkKCkpIHsKICAgICAgcmVsYXRlZERhdGEucGFyc2VQaXZvdCh0aGlzLm1vZGVscyk7CiAgICB9CiAgfSwKCiAgLy8gSGFuZGxlIHRoZSByZWxhdGVkIGRhdGEgbG9hZGluZyBvbiB0aGUgY29sbGVjdGlvbi4KICBfaGFuZGxlRWFnZXI6IGZ1bmN0aW9uKHJlc3BvbnNlLCBvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IEVhZ2VyUmVsYXRpb24odGhpcy5tb2RlbHMsIHJlc3BvbnNlLCBuZXcgdGhpcy5tb2RlbCgpKS5mZXRjaChvcHRpb25zKTsKICB9Cgp9KTsKCm1vZHVsZS5leHBvcnRzID0gQm9va3NoZWxmQ29sbGVjdGlvbjsKfSx7Ii4vYmFzZS9jb2xsZWN0aW9uIjoyLCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9lYWdlciI6OSwiLi9lcnJvcnMiOjEwLCIuL2hlbHBlcnMiOjExLCIuL3N5bmMiOjE0LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIEVhZ2VyUmVsYXRpb24KLy8gLS0tLS0tLS0tLS0tLS0tCnZhciBfICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Cgp2YXIgSGVscGVycyAgID0gcmVxdWlyZSgnLi9oZWxwZXJzJyk7CnZhciBQcm9taXNlICAgPSByZXF1aXJlKCcuL2Jhc2UvcHJvbWlzZScpOwp2YXIgRWFnZXJCYXNlID0gcmVxdWlyZSgnLi9iYXNlL2VhZ2VyJyk7CgovLyBBbiBgRWFnZXJSZWxhdGlvbmAgb2JqZWN0IHRlbXBvcmFyaWx5IHN0b3JlcyB0aGUgbW9kZWxzIGZyb20gYW4gZWFnZXIgbG9hZCwKLy8gYW5kIGhhbmRsZXMgbWF0Y2hpbmcgZWFnZXIgbG9hZGVkIG9iamVjdHMgd2l0aCB0aGVpciBwYXJlbnQocykuIFRoZSBgdGVtcE1vZGVsYAovLyBpcyBvbmx5IHVzZWQgdG8gcmV0cmlldmUgdGhlIHZhbHVlIG9mIHRoZSByZWxhdGlvbiBtZXRob2QsIHRvIGtub3cgdGhlIGNvbnN0cmFpbnMKLy8gZm9yIHRoZSBlYWdlciBxdWVyeS4KZnVuY3Rpb24gRWFnZXJSZWxhdGlvbigpIHsKICBFYWdlckJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhFYWdlclJlbGF0aW9uLCBFYWdlckJhc2UpOwoKXy5leHRlbmQoRWFnZXJSZWxhdGlvbi5wcm90b3R5cGUsIHsKCiAgLy8gSGFuZGxlcyBhbiBlYWdlciBsb2FkZWQgZmV0Y2gsIHBhc3NpbmcgdGhlIG5hbWUgb2YgdGhlIGl0ZW0gd2UncmUgZmV0Y2hpbmcgZm9yLAogIC8vIGFuZCBhbnkgb3B0aW9ucyBuZWVkZWQgZm9yIHRoZSBjdXJyZW50IGZldGNoLgogIGVhZ2VyRmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKHJlbGF0aW9uTmFtZSwgaGFuZGxlZCwgb3B0aW9ucykgewogICAgdmFyIHJlbGF0ZWREYXRhID0gaGFuZGxlZC5yZWxhdGVkRGF0YTsKCiAgICAvLyBza2lwIGVhZ2VyIGxvYWRpbmcgZm9yIHJvd3Mgd2hlcmUgdGhlIGZvcmVpZ24ga2V5IGlzbid0IHNldAogICAgaWYgKHJlbGF0ZWREYXRhLnBhcmVudEZrID09PSBudWxsKSByZXR1cm47CgogICAgaWYgKHJlbGF0ZWREYXRhLnR5cGUgPT09ICdtb3JwaFRvJykgcmV0dXJuIHRoaXMubW9ycGhUb0ZldGNoKHJlbGF0aW9uTmFtZSwgcmVsYXRlZERhdGEsIG9wdGlvbnMpOwoKICAgIHJldHVybiBoYW5kbGVkCiAgICAgIC5zeW5jKF8uZXh0ZW5kKG9wdGlvbnMsIHtwYXJlbnRSZXNwb25zZTogdGhpcy5wYXJlbnRSZXNwb25zZX0pKQogICAgICAuc2VsZWN0KCkKICAgICAgLmJpbmQodGhpcykKICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIHJldHVybiB0aGlzLl9lYWdlckxvYWRIZWxwZXIocmVzcG9uc2UsIHJlbGF0aW9uTmFtZSwgaGFuZGxlZCwgXy5vbWl0KG9wdGlvbnMsICdwYXJlbnRSZXNwb25zZScpKTsKICAgICAgfSk7CiAgfSksCgogIC8vIFNwZWNpYWwgaGFuZGxlciBmb3IgdGhlIGVhZ2VyIGxvYWRlZCBtb3JwaC10byByZWxhdGlvbnMsIHRoaXMgaGFuZGxlcwogIC8vIHRoZSBmYWN0IHRoYXQgdGhlcmUgYXJlIHNldmVyYWwgcG90ZW50aWFsIG1vZGVscyB0aGF0IHdlIG5lZWQgdG8gYmUgZmV0Y2hpbmcgYWdhaW5zdC4KICAvLyBwYWlyaW5nIHRoZW0gdXAgb250byBhIHNpbmdsZSByZXNwb25zZSBmb3IgdGhlIGVhZ2VyIGxvYWRpbmcuCiAgbW9ycGhUb0ZldGNoOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihyZWxhdGlvbk5hbWUsIHJlbGF0ZWREYXRhLCBvcHRpb25zKSB7CiAgICB2YXIgZ3JvdXBzID0gXy5ncm91cEJ5KHRoaXMucGFyZW50LCBmdW5jdGlvbihtKSB7CiAgICAgIHZhciB0eXBlS2V5TmFtZSA9IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzICYmIHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzWzBdID8gcmVsYXRlZERhdGEuY29sdW1uTmFtZXNbMF0gOiByZWxhdGVkRGF0YS5tb3JwaE5hbWUgKyAnX3R5cGUnOwogICAgICByZXR1cm4gbS5nZXQodHlwZUtleU5hbWUpOwogICAgfSk7CiAgICB2YXIgcGVuZGluZyA9IF8ucmVkdWNlKGdyb3VwcywgZnVuY3Rpb24obWVtbywgdmFsLCBncm91cCkgewogICAgICB2YXIgVGFyZ2V0ID0gSGVscGVycy5tb3JwaENhbmRpZGF0ZShyZWxhdGVkRGF0YS5jYW5kaWRhdGVzLCBncm91cCk7CiAgICAgIHZhciB0YXJnZXQgPSBuZXcgVGFyZ2V0KCk7CiAgICAgIHZhciBpZEtleU5hbWUgPSByZWxhdGVkRGF0YS5jb2x1bW5OYW1lcyAmJiByZWxhdGVkRGF0YS5jb2x1bW5OYW1lc1sxXSA/IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzWzFdIDogcmVsYXRlZERhdGEubW9ycGhOYW1lICsgJ19pZCc7CiAgICAgIG1lbW8ucHVzaCh0YXJnZXQKICAgICAgICAucXVlcnkoJ3doZXJlSW4nLAogICAgICAgICAgXy5yZXN1bHQodGFyZ2V0LCAnaWRBdHRyaWJ1dGUnKSwKICAgICAgICAgIF8udW5pcShfLmludm9rZShncm91cHNbZ3JvdXBdLCAnZ2V0JywgaWRLZXlOYW1lKSkKICAgICAgICApCiAgICAgICAgLnN5bmMob3B0aW9ucykKICAgICAgICAuc2VsZWN0KCkKICAgICAgICAuYmluZCh0aGlzKQogICAgICAgIC50YXAoZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9lYWdlckxvYWRIZWxwZXIocmVzcG9uc2UsIHJlbGF0aW9uTmFtZSwgewogICAgICAgICAgICByZWxhdGVkRGF0YTogcmVsYXRlZERhdGEuaW5zdGFuY2UoJ21vcnBoVG8nLCBUYXJnZXQsIHttb3JwaE5hbWU6IHJlbGF0ZWREYXRhLm1vcnBoTmFtZSwgY29sdW1uTmFtZXM6IHJlbGF0ZWREYXRhLmNvbHVtbk5hbWVzfSkKICAgICAgICAgIH0sIG9wdGlvbnMpOwogICAgICAgIH0pKTsKICAgICAgICByZXR1cm4gbWVtbzsKICAgIH0sIFtdLCB0aGlzKTsKICAgIHJldHVybiBQcm9taXNlLmFsbChwZW5kaW5nKS50aGVuKGZ1bmN0aW9uKHJlc3BzKSB7CiAgICAgIHJldHVybiBfLmZsYXR0ZW4ocmVzcHMpOwogICAgfSk7CiAgfSksCgogIC8vIEhhbmRsZXMgdGhlIGVhZ2VyIGxvYWQgZm9yIGJvdGggdGhlIGBtb3JwaFRvYCBhbmQgcmVndWxhciBjYXNlcy4KICBfZWFnZXJMb2FkSGVscGVyOiBmdW5jdGlvbihyZXNwb25zZSwgcmVsYXRpb25OYW1lLCBoYW5kbGVkLCBvcHRpb25zKSB7CiAgICB2YXIgcmVsYXRlZE1vZGVscyA9IHRoaXMucHVzaE1vZGVscyhyZWxhdGlvbk5hbWUsIGhhbmRsZWQsIHJlc3BvbnNlKTsKICAgIHZhciByZWxhdGVkRGF0YSAgID0gaGFuZGxlZC5yZWxhdGVkRGF0YTsKCiAgICAvLyBJZiB0aGVyZSBpcyBhIHJlc3BvbnNlLCBmZXRjaCBhZGRpdGlvbmFsIG5lc3RlZCBlYWdlciByZWxhdGlvbnMsIGlmIGFueS4KICAgIGlmIChyZXNwb25zZS5sZW5ndGggPiAwICYmIG9wdGlvbnMud2l0aFJlbGF0ZWQpIHsKICAgICAgdmFyIHJlbGF0ZWRNb2RlbCA9IHJlbGF0ZWREYXRhLmNyZWF0ZU1vZGVsKCk7CgogICAgICAvLyBJZiB0aGlzIGlzIGEgYG1vcnBoVG9gIHJlbGF0aW9uLCB3ZSBuZWVkIHRvIGRvIGFkZGl0aW9uYWwgcHJvY2Vzc2luZwogICAgICAvLyB0byBlbnN1cmUgd2UgZG9uJ3QgdHJ5IHRvIGxvYWQgYW55IHJlbGF0aW9ucyB0aGF0IGRvbid0IGxvb2sgdG8gZXhpc3QuCiAgICAgIGlmIChyZWxhdGVkRGF0YS50eXBlID09PSAnbW9ycGhUbycpIHsKICAgICAgICB2YXIgd2l0aFJlbGF0ZWQgPSB0aGlzLl9maWx0ZXJSZWxhdGVkKHJlbGF0ZWRNb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKHdpdGhSZWxhdGVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3dpdGhSZWxhdGVkOiB3aXRoUmVsYXRlZH0pOwogICAgICB9CiAgICAgIHJldHVybiBuZXcgRWFnZXJSZWxhdGlvbihyZWxhdGVkTW9kZWxzLCByZXNwb25zZSwgcmVsYXRlZE1vZGVsKS5mZXRjaChvcHRpb25zKS5yZXR1cm4ocmVzcG9uc2UpOwogICAgfQogIH0sCgogIC8vIEZpbHRlcnMgdGhlIGB3aXRoUmVsYXRlZGAgb24gYSBgbW9ycGhUb2AgcmVsYXRpb24sIHRvIGVuc3VyZSB0aGF0IG9ubHkgdmFsaWQKICAvLyByZWxhdGlvbnMgYXJlIGF0dGVtcHRlZCBmb3IgbG9hZGluZy4KICBfZmlsdGVyUmVsYXRlZDogZnVuY3Rpb24ocmVsYXRlZE1vZGVsLCBvcHRpb25zKSB7CgogICAgLy8gQnkgdGhpcyBwb2ludCwgYWxsIHdpdGhSZWxhdGVkIHNob3VsZCBiZSB0dXJuZWQgaW50byBhIGhhc2gsIHNvIGl0IHNob3VsZAogICAgLy8gYmUgZmFpcmx5IHNpbXBsZSB0byBwcm9jZXNzIGJ5IHNwbGl0dGluZyBvbiB0aGUgZG90cy4KICAgIHJldHVybiBfLnJlZHVjZShvcHRpb25zLndpdGhSZWxhdGVkLCBmdW5jdGlvbihtZW1vLCB2YWwpIHsKICAgICAgZm9yICh2YXIga2V5IGluIHZhbCkgewogICAgICAgIHZhciBzZWcgPSBrZXkuc3BsaXQoJy4nKVswXTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlbGF0ZWRNb2RlbFtzZWddKSkgbWVtby5wdXNoKHZhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1lbW87CiAgICB9LCBbXSk7CiAgfQoKfSk7Cgptb2R1bGUuZXhwb3J0cyA9IEVhZ2VyUmVsYXRpb247Cgp9LHsiLi9iYXNlL2VhZ2VyIjozLCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9oZWxwZXJzIjoxMSwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGNyZWF0ZUVycm9yID0gcmVxdWlyZSgnY3JlYXRlLWVycm9yJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHsKCiAgLy8gVGhyb3duIHdoZW4gdGhlIG1vZGVsIGlzIG5vdCBmb3VuZCBhbmQge3JlcXVpcmU6IHRydWV9IGlzIHBhc3NlZCBpbiB0aGUgZmV0Y2ggb3B0aW9ucwogIE5vdEZvdW5kRXJyb3I6IGNyZWF0ZUVycm9yKCdOb3RGb3VuZEVycm9yJyksCgogIC8vIFRocm93biB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IGFuZCB7cmVxdWlyZTogdHJ1ZX0gaXMgcGFzc2VkIGluIG1vZGVsLmZldGNoQWxsIG9yCiAgLy8gY29sbGVjdGlvbi5mZXRjaAogIEVtcHR5RXJyb3I6IGNyZWF0ZUVycm9yKCdFbXB0eUVycm9yJykKCn07Cn0seyJjcmVhdGUtZXJyb3IiOjc0fV0sMTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBIZWxwZXJzCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKbW9kdWxlLmV4cG9ydHMgPSB7CgogIC8vIFNldHMgdGhlIGNvbnN0cmFpbnRzIG5lY2Vzc2FyeSBkdXJpbmcgYSBgbW9kZWwuc2F2ZWAgY2FsbC4KICBzYXZlQ29uc3RyYWludHM6IGZ1bmN0aW9uKG1vZGVsLCByZWxhdGVkRGF0YSkgewogICAgdmFyIGRhdGEgPSB7fTsKICAgIGlmIChyZWxhdGVkRGF0YSAmJiByZWxhdGVkRGF0YS50eXBlICYmIHJlbGF0ZWREYXRhLnR5cGUgIT09ICdiZWxvbmdzVG9NYW55JyAmJiByZWxhdGVkRGF0YS50eXBlICE9PSAnYmVsb25nc1RvJykgewogICAgICBkYXRhW3JlbGF0ZWREYXRhLmtleSgnZm9yZWlnbktleScpXSA9IHJlbGF0ZWREYXRhLnBhcmVudEZrIHx8IG1vZGVsLmdldChyZWxhdGVkRGF0YS5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICAgIGlmIChyZWxhdGVkRGF0YS5pc01vcnBoKCkpIGRhdGFbcmVsYXRlZERhdGEua2V5KCdtb3JwaEtleScpXSA9IHJlbGF0ZWREYXRhLmtleSgnbW9ycGhWYWx1ZScpOwogICAgfQogICAgcmV0dXJuIG1vZGVsLnNldChkYXRhKTsKICB9LAoKICAvLyBGaW5kcyB0aGUgc3BlY2lmaWMgYG1vcnBoVG9gIHRhYmxlIHdlIHNob3VsZCBiZSB3b3JraW5nIHdpdGgsIG9yIHRocm93cwogIC8vIGFuIGVycm9yIGlmIG5vbmUgaXMgbWF0Y2hlZC4KICBtb3JwaENhbmRpZGF0ZTogZnVuY3Rpb24oY2FuZGlkYXRlcywgZm9yZWlnblRhYmxlKSB7CiAgICB2YXIgVGFyZ2V0ID0gXy5maW5kKGNhbmRpZGF0ZXMsIGZ1bmN0aW9uKENhbmRpZGF0ZSkgewogICAgICByZXR1cm4gKF8ucmVzdWx0KENhbmRpZGF0ZS5wcm90b3R5cGUsICd0YWJsZU5hbWUnKSA9PT0gZm9yZWlnblRhYmxlKTsKICAgIH0pOwogICAgaWYgKCFUYXJnZXQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgdGFyZ2V0IHBvbHltb3JwaGljIG1vZGVsIHdhcyBub3QgZm91bmQnKTsKICAgIH0KICAgIHJldHVybiBUYXJnZXQ7CiAgfSwKCiAgLy8gSWYgdGhlcmUgYXJlIG5vIGFyZ3VtZW50cywgcmV0dXJuIHRoZSBjdXJyZW50IG9iamVjdCdzCiAgLy8gcXVlcnkgYnVpbGRlciAob3IgY3JlYXRlIGFuZCByZXR1cm4gYSBuZXcgb25lKS4gSWYgdGhlcmUgYXJlIGFyZ3VtZW50cywKICAvLyBjYWxsIHRoZSBxdWVyeSBidWlsZGVyIHdpdGggdGhlIGZpcnN0IGFyZ3VtZW50LCBhcHBseWluZyB0aGUgcmVzdC4KICAvLyBJZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYW4gb2JqZWN0LCBhc3N1bWUgdGhlIGtleXMgYXJlIHF1ZXJ5IGJ1aWxkZXIKICAvLyBtZXRob2RzLCBhbmQgdGhlIHZhbHVlcyBhcmUgdGhlIGFyZ3VtZW50cyBmb3IgdGhlIHF1ZXJ5LgogIHF1ZXJ5OiBmdW5jdGlvbihvYmosIGFyZ3MpIHsKICAgIG9iai5fa25leCA9IG9iai5fa25leCB8fCBvYmouX2J1aWxkZXIoXy5yZXN1bHQob2JqLCAndGFibGVOYW1lJykpOwogICAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gb2JqLl9rbmV4OwogICAgdmFyIG1ldGhvZCA9IGFyZ3NbMF07CiAgICBpZiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgbWV0aG9kLmNhbGwob2JqLl9rbmV4LCBvYmouX2tuZXgpOwogICAgfSBlbHNlIGlmIChfLmlzT2JqZWN0KG1ldGhvZCkpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG1ldGhvZCkgewogICAgICAgIHZhciB0YXJnZXQgPSBfLmlzQXJyYXkobWV0aG9kW2tleV0pID8gIG1ldGhvZFtrZXldIDogW21ldGhvZFtrZXldXTsKICAgICAgICBvYmouX2tuZXhba2V5XS5hcHBseShvYmouX2tuZXgsIHRhcmdldCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG9iai5fa25leFttZXRob2RdLmFwcGx5KG9iai5fa25leCwgYXJncy5zbGljZSgxKSk7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH0KCn07Cgp9LHsibG9kYXNoIjoxMzB9XSwxMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIE1vZGVsCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCnZhciBTeW5jICAgICAgICAgICA9IHJlcXVpcmUoJy4vc3luYycpOwp2YXIgSGVscGVycyAgICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIEVhZ2VyUmVsYXRpb24gID0gcmVxdWlyZSgnLi9lYWdlcicpOwp2YXIgRXJyb3JzICAgICAgICAgPSByZXF1aXJlKCcuL2Vycm9ycycpOwoKdmFyIE1vZGVsQmFzZSAgICAgID0gcmVxdWlyZSgnLi9iYXNlL21vZGVsJyk7CnZhciBQcm9taXNlICAgICAgICA9IHJlcXVpcmUoJy4vYmFzZS9wcm9taXNlJyk7CgpmdW5jdGlvbiBCb29rc2hlbGZNb2RlbCgpIHsKICBNb2RlbEJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZNb2RlbCwgTW9kZWxCYXNlKTsKCkJvb2tzaGVsZk1vZGVsLk5vdEZvdW5kRXJyb3IgPSBFcnJvcnMuTm90Rm91bmRFcnJvcjsKCl8uZXh0ZW5kKEJvb2tzaGVsZk1vZGVsLnByb3RvdHlwZSwgewoKICAvLyBUaGUgYGhhc09uZWAgcmVsYXRpb24gc3BlY2lmaWVzIHRoYXQgdGhpcyB0YWJsZSBoYXMgZXhhY3RseSBvbmUgb2YgYW5vdGhlciB0eXBlIG9mIG9iamVjdCwKICAvLyBzcGVjaWZpZWQgYnkgYSBmb3JlaWduIGtleSBpbiB0aGUgb3RoZXIgdGFibGUuIFRoZSBmb3JlaWduIGtleSBpcyBhc3N1bWVkIHRvIGJlIHRoZSBzaW5ndWxhciBvZiB0aGlzCiAgLy8gb2JqZWN0J3MgYHRhYmxlTmFtZWAgd2l0aCBhbiBgX2lkYCBzdWZmaXgsIGJ1dCBhIGN1c3RvbSBgZm9yZWlnbktleWAgYXR0cmlidXRlIG1heSBhbHNvIGJlIHNwZWNpZmllZC4KICBoYXNPbmU6IGZ1bmN0aW9uKFRhcmdldCwgZm9yZWlnbktleSkgewogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdoYXNPbmUnLCBUYXJnZXQsIHtmb3JlaWduS2V5OiBmb3JlaWduS2V5fSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBUaGUgYGhhc01hbnlgIHJlbGF0aW9uIHNwZWNpZmllcyB0aGF0IHRoaXMgb2JqZWN0IGhhcyBvbmUgb3IgbW9yZSByb3dzIGluIGFub3RoZXIgdGFibGUgd2hpY2gKICAvLyBtYXRjaCBvbiB0aGlzIG9iamVjdCdzIHByaW1hcnkga2V5LiBUaGUgZm9yZWlnbiBrZXkgaXMgYXNzdW1lZCB0byBiZSB0aGUgc2luZ3VsYXIgb2YgdGhpcyBvYmplY3QncwogIC8vIGB0YWJsZU5hbWVgIHdpdGggYW4gYF9pZGAgc3VmZml4LCBidXQgYSBjdXN0b20gYGZvcmVpZ25LZXlgIGF0dHJpYnV0ZSBtYXkgYWxzbyBiZSBzcGVjaWZpZWQuCiAgaGFzTWFueTogZnVuY3Rpb24oVGFyZ2V0LCBmb3JlaWduS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fcmVsYXRpb24oJ2hhc01hbnknLCBUYXJnZXQsIHtmb3JlaWduS2V5OiBmb3JlaWduS2V5fSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBBIHJldmVyc2UgYGhhc09uZWAgcmVsYXRpb24sIHRoZSBgYmVsb25nc1RvYCwgd2hlcmUgdGhlIHNwZWNpZmllZCBrZXkgaW4gdGhpcyB0YWJsZQogIC8vIG1hdGNoZXMgdGhlIHByaW1hcnkgYGlkQXR0cmlidXRlYCBvZiBhbm90aGVyIHRhYmxlLgogIGJlbG9uZ3NUbzogZnVuY3Rpb24oVGFyZ2V0LCBmb3JlaWduS2V5KSB7CiAgICByZXR1cm4gdGhpcy5fcmVsYXRpb24oJ2JlbG9uZ3NUbycsIFRhcmdldCwge2ZvcmVpZ25LZXk6IGZvcmVpZ25LZXl9KS5pbml0KHRoaXMpOwogIH0sCgogIC8vIEEgYGJlbG9uZ3NUb01hbnlgIHJlbGF0aW9uIGlzIHdoZW4gdGhlcmUgYXJlIG1hbnktdG8tbWFueSByZWxhdGlvbgogIC8vIGJldHdlZW4gdHdvIG1vZGVscywgd2l0aCBhIGpvaW5pbmcgdGFibGUuCiAgYmVsb25nc1RvTWFueTogZnVuY3Rpb24oVGFyZ2V0LCBqb2luVGFibGVOYW1lLCBmb3JlaWduS2V5LCBvdGhlcktleSkgewogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdiZWxvbmdzVG9NYW55JywgVGFyZ2V0LCB7CiAgICAgIGpvaW5UYWJsZU5hbWU6IGpvaW5UYWJsZU5hbWUsIGZvcmVpZ25LZXk6IGZvcmVpZ25LZXksIG90aGVyS2V5OiBvdGhlcktleQogICAgfSkuaW5pdCh0aGlzKTsKICB9LAoKICAvLyBBIGBtb3JwaE9uZWAgcmVsYXRpb24gaXMgYSBvbmUtdG8tb25lIHBvbHltb3JwaGljIGFzc29jaWF0aW9uIGZyb20gdGhpcyBtb2RlbAogIC8vIHRvIGFub3RoZXIgbW9kZWwuCiAgbW9ycGhPbmU6IGZ1bmN0aW9uKFRhcmdldCwgbmFtZSwgY29sdW1uTmFtZXMsIG1vcnBoVmFsdWUpIHsKICAgIHJldHVybiB0aGlzLl9tb3JwaE9uZU9yTWFueShUYXJnZXQsIG5hbWUsIGNvbHVtbk5hbWVzLCBtb3JwaFZhbHVlLCAnbW9ycGhPbmUnKTsKICB9LAoKICAvLyBBIGBtb3JwaE1hbnlgIHJlbGF0aW9uIGlzIGEgcG9seW1vcnBoaWMgbWFueS10by1vbmUgcmVsYXRpb24gZnJvbSB0aGlzIG1vZGVsCiAgLy8gdG8gbWFueSBhbm90aGVyIG1vZGVscy4KICBtb3JwaE1hbnk6IGZ1bmN0aW9uKFRhcmdldCwgbmFtZSwgY29sdW1uTmFtZXMsIG1vcnBoVmFsdWUpIHsKICAgIHJldHVybiB0aGlzLl9tb3JwaE9uZU9yTWFueShUYXJnZXQsIG5hbWUsIGNvbHVtbk5hbWVzLCBtb3JwaFZhbHVlLCAnbW9ycGhNYW55Jyk7CiAgfSwKCiAgLy8gRGVmaW5lcyB0aGUgb3Bwb3NpdGUgZW5kIG9mIGEgYG1vcnBoT25lYCBvciBgbW9ycGhNYW55YCByZWxhdGlvbnNoaXAsIHdoZXJlCiAgLy8gdGhlIGFsdGVybmF0ZSBlbmQgb2YgdGhlIHBvbHltb3JwaGljIG1vZGVsIGlzIGRlZmluZWQuCiAgbW9ycGhUbzogZnVuY3Rpb24obW9ycGhOYW1lKSB7CiAgICB2YXIgY29sdW1uTmFtZXMsIHJlbWFpbmRlcjsKICAgIGlmICghXy5pc1N0cmluZyhtb3JwaE5hbWUpKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBgbW9ycGhUb2AgbmFtZSBtdXN0IGJlIHNwZWNpZmllZC4nKTsKICAgIGlmIChfLmlzQXJyYXkoYXJndW1lbnRzWzFdKSkgewogICAgICBjb2x1bW5OYW1lcyA9IGFyZ3VtZW50c1sxXTsKICAgICAgcmVtYWluZGVyID0gXy5yZXN0KGFyZ3VtZW50cywgMik7CiAgICB9IGVsc2UgewogICAgICBjb2x1bW5OYW1lcyA9IG51bGw7CiAgICAgIHJlbWFpbmRlciA9IF8ucmVzdChhcmd1bWVudHMpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKCdtb3JwaFRvJywgbnVsbCwge21vcnBoTmFtZTogbW9ycGhOYW1lLCBjb2x1bW5OYW1lczogY29sdW1uTmFtZXMsIGNhbmRpZGF0ZXM6IHJlbWFpbmRlcn0pLmluaXQodGhpcyk7CiAgfSwKCiAgLy8gVXNlZCB0byBkZWZpbmUgcGFzc3Rocm91Z2ggcmVsYXRpb25zaGlwcyAtIGBoYXNPbmVgLCBgaGFzTWFueWAsCiAgLy8gYGJlbG9uZ3NUb2Agb3IgYGJlbG9uZ3NUb01hbnlgLCAidGhyb3VnaCIgYSBgSW50ZXJpbWAgbW9kZWwgb3IgY29sbGVjdGlvbi4KICB0aHJvdWdoOiBmdW5jdGlvbihJbnRlcmltLCBmb3JlaWduS2V5LCBvdGhlcktleSkgewogICAgcmV0dXJuIHRoaXMucmVsYXRlZERhdGEudGhyb3VnaCh0aGlzLCBJbnRlcmltLCB7dGhyb3VnaEZvcmVpZ25LZXk6IGZvcmVpZ25LZXksIG90aGVyS2V5OiBvdGhlcktleX0pOwogIH0sCgogIC8vIEZldGNoIGEgbW9kZWwgYmFzZWQgb24gdGhlIGN1cnJlbnRseSBzZXQgYXR0cmlidXRlcywKICAvLyByZXR1cm5pbmcgYSBtb2RlbCB0byB0aGUgY2FsbGJhY2ssIGFsb25nIHdpdGggYW55IG9wdGlvbnMuCiAgLy8gUmV0dXJucyBhIGRlZmVycmVkIHByb21pc2UgdGhyb3VnaCB0aGUgYEJvb2tzaGVsZi5TeW5jYC4KICAvLyBJZiBge3JlcXVpcmU6IHRydWV9YCBpcyBzZXQgYXMgYW4gb3B0aW9uLCB0aGUgZmV0Y2ggaXMgY29uc2lkZXJlZAogIC8vIGEgZmFpbHVyZSBpZiB0aGUgbW9kZWwgY29tZXMgdXAgYmxhbmsuCiAgZmV0Y2g6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwoKICAgIC8vIFJ1biB0aGUgYGZpcnN0YCBjYWxsIG9uIHRoZSBgc3luY2Agb2JqZWN0IHRvIGZldGNoIGEgc2luZ2xlIG1vZGVsLgogICAgcmV0dXJuIHRoaXMuc3luYyhvcHRpb25zKQogICAgICAuZmlyc3QoKQogICAgICAuYmluZCh0aGlzKQoKICAgICAgLy8gSnVtcCB0aGUgcmVzdCBvZiB0aGUgY2hhaW4gaWYgdGhlIHJlc3BvbnNlIGRvZXNuJ3QgZXhpc3QuLi4KICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIGlmICghcmVzcG9uc2UgfHwgcmVzcG9uc2UubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBpZiAob3B0aW9ucy5yZXF1aXJlKSB0aHJvdyBuZXcgRXJyb3JzLk5vdEZvdW5kRXJyb3IoJ0VtcHR5UmVzcG9uc2UnKTsKICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChudWxsKTsKICAgICAgICB9CiAgICAgIH0pCgogICAgICAvLyBOb3csIGxvYWQgYWxsIG9mIHRoZSBkYXRhIGludG8gdGhlIG1vZGVsIGFzIG5lY2Vzc2FyeS4KICAgICAgLnRhcCh0aGlzLl9oYW5kbGVSZXNwb25zZSkKCiAgICAgIC8vIElmIHRoZSAid2l0aFJlbGF0ZWQiIGlzIHNwZWNpZmllZCwgd2UgYWxzbyBuZWVkIHRvIGVhZ2VyIGxvYWQgYWxsIG9mIHRoZQogICAgICAvLyBkYXRhIG9uIHRoZSBtb2RlbCwgYXMgYSBzaWRlLWVmZmVjdCwgYmVmb3JlIHdlIHVsdGltYXRlbHkganVtcCBpbnRvIHRoZQogICAgICAvLyBuZXh0IHN0ZXAgb2YgdGhlIG1vZGVsLiBTaW5jZSB0aGUgYGNvbHVtbnNgIGFyZSBvbmx5IHJlbGV2YW50IHRvIHRoZSBjdXJyZW50CiAgICAgIC8vIGxldmVsLCBlbnN1cmUgdGhvc2UgYXJlIG9taXR0ZWQgZnJvbSB0aGUgb3B0aW9ucy4KICAgICAgLnRhcChmdW5jdGlvbihyZXNwb25zZSkgewogICAgICAgIGlmIChvcHRpb25zLndpdGhSZWxhdGVkKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5faGFuZGxlRWFnZXIocmVzcG9uc2UsIF8ub21pdChvcHRpb25zLCAnY29sdW1ucycpKTsKICAgICAgICB9CiAgICAgIH0pCgogICAgICAudGFwKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2ZldGNoZWQnLCB0aGlzLCByZXNwb25zZSwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5yZXR1cm4odGhpcykKICAgICAgLmNhdGNoKGZ1bmN0aW9uKGVycikgewogICAgICAgIGlmIChlcnIgPT09IG51bGwpIHJldHVybiBlcnI7CiAgICAgICAgdGhyb3cgZXJyOwogICAgICB9KTsKICB9KSwKCiAgLy8gU2hvcnRjdXQgZm9yIGNyZWF0aW5nIGEgY29sbGVjdGlvbiBhbmQgZmV0Y2hpbmcgdGhlIGFzc29jaWF0ZWQgbW9kZWxzLgogIGZldGNoQWxsOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXMuY29uc3RydWN0b3IuY29sbGVjdGlvbigpOwogICAgY29sbGVjdGlvbi5fa25leCA9IHRoaXMucXVlcnkoKS5jbG9uZSgpOwogICAgdGhpcy5yZXNldFF1ZXJ5KCk7CiAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSkgY29sbGVjdGlvbi5yZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgcmV0dXJuIGNvbGxlY3Rpb24KICAgICAgLm9uKCdmZXRjaGluZycsIGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGNvbHVtbnMsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbW9kZWwudHJpZ2dlclRoZW4oJ2ZldGNoaW5nOmNvbGxlY3Rpb24nLCBjb2xsZWN0aW9uLCBjb2x1bW5zLCBvcHRpb25zKTsKICAgICAgfSkKICAgICAgLm9uKCdmZXRjaGVkJywgZnVuY3Rpb24oY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBtb2RlbC50cmlnZ2VyVGhlbignZmV0Y2hlZDpjb2xsZWN0aW9uJywgY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0pCiAgICAgIC5mZXRjaChvcHRpb25zKTsKICB9LAoKICAvLyBFYWdlciBsb2FkcyByZWxhdGlvbnNoaXBzIG9udG8gYW4gYWxyZWFkeSBwb3B1bGF0ZWQgYE1vZGVsYCBpbnN0YW5jZS4KICBsb2FkOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihyZWxhdGlvbnMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFt0aGlzLmZvcm1hdChfLmV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCB0aGlzLmF0dHJpYnV0ZXMpKV07CiAgICAgIH0pCiAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhbmRsZUVhZ2VyKHJlc3BvbnNlLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywgewogICAgICAgICAgc2hhbGxvdzogdHJ1ZSwKICAgICAgICAgIHdpdGhSZWxhdGVkOiBfLmlzQXJyYXkocmVsYXRpb25zKSA/IHJlbGF0aW9ucyA6IFtyZWxhdGlvbnNdCiAgICAgICAgfSkpOwogICAgICB9KQogICAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBTZXRzIGFuZCBzYXZlcyB0aGUgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCB0cmlnZ2VyaW5nCiAgLy8gYSAiY3JlYXRpbmciIG9yICJ1cGRhdGluZyIgZXZlbnQgb24gdGhlIG1vZGVsLCBhcyB3ZWxsIGFzIGEgInNhdmluZyIgZXZlbnQsCiAgLy8gdG8gYmluZCBsaXN0ZW5lcnMgZm9yIGFueSBuZWNlc3NhcnkgdmFsaWRhdGlvbiwgbG9nZ2luZywgZXRjLgogIC8vIElmIGFuIGVycm9yIGlzIHRocm93biBkdXJpbmcgdGhlc2UgZXZlbnRzLCB0aGUgbW9kZWwgd2lsbCBub3QgYmUgc2F2ZWQuCiAgc2F2ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRyczsKCiAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IikgewogICAgICBhdHRycyA9IGtleSB8fCB7fTsKICAgICAgb3B0aW9ucyA9IF8uY2xvbmUodmFsKSB8fCB7fTsKICAgIH0gZWxzZSB7CiAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgIH0KCiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlzTmV3KG9wdGlvbnMpOwogICAgfSkudGhlbihmdW5jdGlvbihpc05ldykgewoKICAgICAgLy8gSWYgdGhlIG1vZGVsIGhhcyB0aW1lc3RhbXAgY29sdW1ucywKICAgICAgLy8gc2V0IHRoZW0gYXMgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwsIGV2ZW4KICAgICAgLy8gaWYgdGhlICJwYXRjaCIgb3B0aW9uIGlzIHNwZWNpZmllZC4KICAgICAgaWYgKHRoaXMuaGFzVGltZXN0YW1wcykgXy5leHRlbmQoYXR0cnMsIHRoaXMudGltZXN0YW1wKG9wdGlvbnMpKTsKCiAgICAgIC8vIERldGVybWluZSB3aGV0aGVyIHRoZSBtb2RlbCBpcyBuZXcsIGJhc2VkIG9uIHdoZXRoZXIgdGhlIG1vZGVsIGhhcyBhbiBgaWRBdHRyaWJ1dGVgIG9yIG5vdC4KICAgICAgb3B0aW9ucy5tZXRob2QgPSAob3B0aW9ucy5tZXRob2QgfHwgKGlzTmV3ID8gJ2luc2VydCcgOiAndXBkYXRlJykpLnRvTG93ZXJDYXNlKCk7CiAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLm1ldGhvZDsKICAgICAgdmFyIHZhbHMgPSBhdHRyczsKCiAgICAgIC8vIElmIHRoZSBvYmplY3QgaXMgYmVpbmcgY3JlYXRlZCwgd2UgbWVyZ2UgYW55IGRlZmF1bHRzIGhlcmUKICAgICAgLy8gcmF0aGVyIHRoYW4gZHVyaW5nIG9iamVjdCBjcmVhdGlvbi4KICAgICAgaWYgKG1ldGhvZCA9PT0gJ2luc2VydCcgfHwgb3B0aW9ucy5kZWZhdWx0cykgewogICAgICAgIHZhciBkZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpOwogICAgICAgIGlmIChkZWZhdWx0cykgewogICAgICAgICAgdmFscyA9IF8uZXh0ZW5kKHt9LCBkZWZhdWx0cywgdGhpcy5hdHRyaWJ1dGVzLCB2YWxzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNldCB0aGUgYXR0cmlidXRlcyBvbiB0aGUgbW9kZWwuCiAgICAgIHRoaXMuc2V0KHZhbHMsIHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgc2F2ZSBjb25zdHJhaW50cywgc2V0IHRoZW0gb24gdGhlIG1vZGVsLgogICAgICBpZiAodGhpcy5yZWxhdGVkRGF0YSAmJiB0aGlzLnJlbGF0ZWREYXRhLnR5cGUgIT09ICdtb3JwaFRvJykgewogICAgICAgIEhlbHBlcnMuc2F2ZUNvbnN0cmFpbnRzKHRoaXMsIHRoaXMucmVsYXRlZERhdGEpOwogICAgICB9CgogICAgICAvLyBHaXZlcyBhY2Nlc3MgdG8gdGhlIGBxdWVyeWAgb2JqZWN0IGluIHRoZSBgb3B0aW9uc2AsIGluIGNhc2Ugd2UgbmVlZCBpdAogICAgICAvLyBpbiBhbnkgZXZlbnQgaGFuZGxlcnMuCiAgICAgIHZhciBzeW5jID0gdGhpcy5zeW5jKG9wdGlvbnMpOwogICAgICBvcHRpb25zLnF1ZXJ5ID0gc3luYy5xdWVyeTsKCiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKChtZXRob2QgPT09ICdpbnNlcnQnID8gJ2NyZWF0aW5nIHNhdmluZycgOiAndXBkYXRpbmcgc2F2aW5nJyksIHRoaXMsIGF0dHJzLCBvcHRpb25zKQogICAgICAuYmluZCh0aGlzKQogICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3luY1tvcHRpb25zLm1ldGhvZF0obWV0aG9kID09PSAndXBkYXRlJyAmJiBvcHRpb25zLnBhdGNoID8gYXR0cnMgOiB0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB9KQogICAgICAudGhlbihmdW5jdGlvbihyZXNwKSB7CgogICAgICAgIC8vIEFmdGVyIGEgc3VjY2Vzc2Z1bCBkYXRhYmFzZSBzYXZlLCB0aGUgaWQgaXMgdXBkYXRlZCBpZiB0aGUgbW9kZWwgd2FzIGNyZWF0ZWQKICAgICAgICBpZiAobWV0aG9kID09PSAnaW5zZXJ0JyAmJiB0aGlzLmlkID09IG51bGwpIHsKICAgICAgICAgIHRoaXMuYXR0cmlidXRlc1t0aGlzLmlkQXR0cmlidXRlXSA9IHRoaXMuaWQgPSByZXNwWzBdOwogICAgICAgIH0gZWxzZSBpZiAobWV0aG9kID09PSAndXBkYXRlJyAmJiByZXNwID09PSAwKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHJvd3Mgd2VyZSBhZmZlY3RlZCBpbiB0aGUgdXBkYXRlLCBkaWQgeW91IG1lYW4gdG8gcGFzcyB0aGUge21ldGhvZDogImluc2VydCJ9IG9wdGlvbj8nKTsKICAgICAgICB9CgogICAgICAgIC8vIEluIGNhc2Ugd2UgbmVlZCB0byByZWZlcmVuY2UgdGhlIGBwcmV2aW91c0F0dHJpYnV0ZXNgIGZvciB0aGUgdGhpcwogICAgICAgIC8vIGluIHRoZSBmb2xsb3dpbmcgZXZlbnQgaGFuZGxlcnMuCiAgICAgICAgb3B0aW9ucy5wcmV2aW91c0F0dHJpYnV0ZXMgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7CgogICAgICAgIHRoaXMuX3Jlc2V0KCk7CgogICAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKChtZXRob2QgPT09ICdpbnNlcnQnID8gJ2NyZWF0ZWQgc2F2ZWQnIDogJ3VwZGF0ZWQgc2F2ZWQnKSwgdGhpcywgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH0pOwoKICAgIH0pCiAgICAucmV0dXJuKHRoaXMpOwogIH0pLAoKICAvLyBSZXNldCB0aGUgcXVlcnkgYnVpbGRlciwgY2FsbGVkIGludGVybmFsbHkKICAvLyBlYWNoIHRpbWUgYSBxdWVyeSBpcyBydW4uCiAgcmVzZXRRdWVyeTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9rbmV4ID0gbnVsbDsKICAgIHJldHVybiB0aGlzOwogIH0sCgogIC8vIFRhcCBpbnRvIHRoZSAicXVlcnkgY2hhaW4iIGZvciB0aGlzIG1vZGVsLgogIHF1ZXJ5OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBIZWxwZXJzLnF1ZXJ5KHRoaXMsIF8udG9BcnJheShhcmd1bWVudHMpKTsKICB9LAoKICAvLyBBZGQgdGhlIG1vc3QgY29tbW9uIGNvbmRpdGlvbmFsIGRpcmVjdGx5IHRvIHRoZSBtb2RlbCwgZXZlcnl0aGluZyBlbHNlCiAgLy8gY2FuIGJlIGFjY2Vzc2VkIHdpdGggdGhlIGBxdWVyeWAgbWV0aG9kLgogIHdoZXJlOiBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyk7CiAgICByZXR1cm4gdGhpcy5xdWVyeS5hcHBseSh0aGlzLCBbJ3doZXJlJ10uY29uY2F0KGFyZ3MpKTsKICB9LAoKICAvLyBDcmVhdGVzIGFuZCByZXR1cm5zIGEgbmV3IGBTeW5jYCBpbnN0YW5jZS4KICBzeW5jOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFN5bmModGhpcywgb3B0aW9ucyk7CiAgfSwKCiAgLy8gSGVscGVyIGZvciBzZXR0aW5nIHVwIHRoZSBgbW9ycGhPbmVgIG9yIGBtb3JwaE1hbnlgIHJlbGF0aW9ucy4KICBfbW9ycGhPbmVPck1hbnk6IGZ1bmN0aW9uKFRhcmdldCwgbW9ycGhOYW1lLCBjb2x1bW5OYW1lcywgbW9ycGhWYWx1ZSwgdHlwZSkgewogICAgaWYgKCFfLmlzQXJyYXkoY29sdW1uTmFtZXMpKSB7CiAgICAgIC8vIFNoaWZ0IGJ5IG9uZSBwbGFjZQogICAgICBtb3JwaFZhbHVlID0gY29sdW1uTmFtZXM7CiAgICAgIGNvbHVtbk5hbWVzID0gbnVsbDsKICAgIH0KICAgIGlmICghbW9ycGhOYW1lIHx8ICFUYXJnZXQpIHRocm93IG5ldyBFcnJvcignVGhlIHBvbHltb3JwaGljIGBuYW1lYCBhbmQgYFRhcmdldGAgYXJlIHJlcXVpcmVkLicpOwogICAgcmV0dXJuIHRoaXMuX3JlbGF0aW9uKHR5cGUsIFRhcmdldCwge21vcnBoTmFtZTogbW9ycGhOYW1lLCBtb3JwaFZhbHVlOiBtb3JwaFZhbHVlLCBjb2x1bW5OYW1lczogY29sdW1uTmFtZXN9KS5pbml0KHRoaXMpOwogIH0sCgogIC8vIEhhbmRsZXMgdGhlIHJlc3BvbnNlIGRhdGEgZm9yIHRoZSBtb2RlbCwgcmV0dXJuaW5nIGZyb20gdGhlIG1vZGVsJ3MgZmV0Y2ggY2FsbC4KICAvLyBUb2RvOiB7c2lsZW50OiB0cnVlLCBwYXJzZTogdHJ1ZX0sIGZvciBwYXJpdHkgd2l0aCBjb2xsZWN0aW9uI3NldAogIC8vIG5lZWQgdG8gY2hlY2sgb24gQmFja2JvbmUncyBzdGF0dXMgdGhlcmUsIHRpY2tldCAjMjYzNgogIF9oYW5kbGVSZXNwb25zZTogZnVuY3Rpb24ocmVzcG9uc2UpIHsKICAgIHZhciByZWxhdGVkRGF0YSA9IHRoaXMucmVsYXRlZERhdGE7CiAgICB0aGlzLnNldCh0aGlzLnBhcnNlKHJlc3BvbnNlWzBdKSwge3NpbGVudDogdHJ1ZX0pLl9yZXNldCgpOwogICAgaWYgKHJlbGF0ZWREYXRhICYmIHJlbGF0ZWREYXRhLmlzSm9pbmVkKCkpIHsKICAgICAgcmVsYXRlZERhdGEucGFyc2VQaXZvdChbdGhpc10pOwogICAgfQogIH0sCgogIC8vIEhhbmRsZSB0aGUgcmVsYXRlZCBkYXRhIGxvYWRpbmcgb24gdGhlIG1vZGVsLgogIF9oYW5kbGVFYWdlcjogZnVuY3Rpb24ocmVzcG9uc2UsIG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgRWFnZXJSZWxhdGlvbihbdGhpc10sIHJlc3BvbnNlLCB0aGlzKS5mZXRjaChvcHRpb25zKTsKICB9Cgp9KTsKCm1vZHVsZS5leHBvcnRzID0gQm9va3NoZWxmTW9kZWw7Cgp9LHsiLi9iYXNlL21vZGVsIjo1LCIuL2Jhc2UvcHJvbWlzZSI6NiwiLi9lYWdlciI6OSwiLi9lcnJvcnMiOjEwLCIuL2hlbHBlcnMiOjExLCIuL3N5bmMiOjE0LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBSZWxhdGlvbgovLyAtLS0tLS0tLS0tLS0tLS0KdmFyIF8gICAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGluaGVyaXRzICAgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoJ2luZmxlY3Rpb24nKTsKCnZhciBIZWxwZXJzICAgICAgPSByZXF1aXJlKCcuL2hlbHBlcnMnKTsKdmFyIE1vZGVsQmFzZSAgICA9IHJlcXVpcmUoJy4vYmFzZS9tb2RlbCcpOwp2YXIgUmVsYXRpb25CYXNlID0gcmVxdWlyZSgnLi9iYXNlL3JlbGF0aW9uJyk7CnZhciBQcm9taXNlICAgICAgPSByZXF1aXJlKCcuL2Jhc2UvcHJvbWlzZScpOwoKdmFyIHB1c2ggICAgICAgICA9IFtdLnB1c2g7CgpmdW5jdGlvbiBCb29rc2hlbGZSZWxhdGlvbigpIHsKICBSZWxhdGlvbkJhc2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhCb29rc2hlbGZSZWxhdGlvbiwgUmVsYXRpb25CYXNlKTsKCl8uZXh0ZW5kKEJvb2tzaGVsZlJlbGF0aW9uLnByb3RvdHlwZSwgewoKICAvLyBBc3NlbWJsZXMgdGhlIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uIHdlJ3JlIGNyZWF0aW5nIGFuIGluc3RhbmNlIG9mLAogIC8vIGdhdGhlcmluZyBhbnkgcmVsZXZhbnQgcHJpbWl0aXZlcyBmcm9tIHRoZSBwYXJlbnQgb2JqZWN0LAogIC8vIHdpdGhvdXQga2VlcGluZyBhbnkgaGFyZCByZWZlcmVuY2VzLgogIGluaXQ6IGZ1bmN0aW9uKHBhcmVudCkgewogICAgdGhpcy5wYXJlbnRJZCAgICAgICAgICA9IHBhcmVudC5pZDsKICAgIHRoaXMucGFyZW50VGFibGVOYW1lICAgPSBfLnJlc3VsdChwYXJlbnQsICd0YWJsZU5hbWUnKTsKICAgIHRoaXMucGFyZW50SWRBdHRyaWJ1dGUgPSBfLnJlc3VsdChwYXJlbnQsICdpZEF0dHJpYnV0ZScpOwoKICAgIGlmICh0aGlzLmlzSW52ZXJzZSgpKSB7CiAgICAgIC8vIHVzZSBmb3JtYXR0ZWQgYXR0cmlidXRlcyBzbyB0aGF0IG1vcnBoS2V5IGFuZCBmb3JlaWduS2V5IHdpbGwgbWF0Y2gKICAgICAgLy8gYXR0cmlidXRlIGtleXMKICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBwYXJlbnQuZm9ybWF0KF8uY2xvbmUocGFyZW50LmF0dHJpYnV0ZXMpKTsKCiAgICAgIC8vIElmIHRoZSBwYXJlbnQgb2JqZWN0IGlzIGVhZ2VyIGxvYWRpbmcsIGFuZCBpdCdzIGEgcG9seW1vcnBoaWMgYG1vcnBoVG9gIHJlbGF0aW9uLAogICAgICAvLyB3ZSBjYW4ndCBrbm93IHdoYXQgdGhlIHRhcmdldCB3aWxsIGJlIHVudGlsIHRoZSBtb2RlbHMgYXJlIHNvcnRlZCBhbmQgbWF0Y2hlZC4KICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nICYmICFwYXJlbnQuX2lzRWFnZXIpIHsKICAgICAgICB0aGlzLnRhcmdldCA9IEhlbHBlcnMubW9ycGhDYW5kaWRhdGUodGhpcy5jYW5kaWRhdGVzLCBhdHRyaWJ1dGVzW3RoaXMua2V5KCdtb3JwaEtleScpXSk7CiAgICAgICAgdGhpcy50YXJnZXRUYWJsZU5hbWUgICA9IF8ucmVzdWx0KHRoaXMudGFyZ2V0LnByb3RvdHlwZSwgJ3RhYmxlTmFtZScpOwogICAgICAgIHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGUgPSBfLnJlc3VsdCh0aGlzLnRhcmdldC5wcm90b3R5cGUsICdpZEF0dHJpYnV0ZScpOwogICAgICB9CiAgICAgIHRoaXMucGFyZW50RmsgPSBhdHRyaWJ1dGVzW3RoaXMua2V5KCdmb3JlaWduS2V5JyldOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJlbnRGayA9IHBhcmVudC5pZDsKICAgIH0KCiAgICB2YXIgdGFyZ2V0ID0gdGhpcy50YXJnZXQgPyB0aGlzLnJlbGF0ZWRJbnN0YW5jZSgpIDoge307CiAgICAgICAgdGFyZ2V0LnJlbGF0ZWREYXRhID0gdGhpczsKCiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIHsKICAgICAgXy5leHRlbmQodGFyZ2V0LCBwaXZvdEhlbHBlcnMpOwogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfSwKCiAgLy8gSW5pdGlhbGl6ZXMgYSBgdGhyb3VnaGAgcmVsYXRpb24sIHNldHRpbmcgdGhlIGBUYXJnZXRgIG1vZGVsIGFuZCBgb3B0aW9uc2AsCiAgLy8gd2hpY2ggaW5jbHVkZXMgYW55IGFkZGl0aW9uYWwga2V5cyBmb3IgdGhlIHJlbGF0aW9uLgogIHRocm91Z2g6IGZ1bmN0aW9uKHNvdXJjZSwgVGFyZ2V0LCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IHRoaXMudHlwZTsKICAgIGlmICh0eXBlICE9PSAnaGFzT25lJyAmJiB0eXBlICE9PSAnaGFzTWFueScgJiYgdHlwZSAhPT0gJ2JlbG9uZ3NUb01hbnknICYmIHR5cGUgIT09ICdiZWxvbmdzVG8nKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignYHRocm91Z2hgIGlzIG9ubHkgY2hhaW5hYmxlIGZyb20gYGhhc09uZWAsIGBiZWxvbmdzVG9gLCBgaGFzTWFueWAsIG9yIGBiZWxvbmdzVG9NYW55YCcpOwogICAgfQoKICAgIHRoaXMudGhyb3VnaFRhcmdldCA9IFRhcmdldDsKICAgIHRoaXMudGhyb3VnaFRhYmxlTmFtZSA9IF8ucmVzdWx0KFRhcmdldC5wcm90b3R5cGUsICd0YWJsZU5hbWUnKTsKICAgIHRoaXMudGhyb3VnaElkQXR0cmlidXRlID0gXy5yZXN1bHQoVGFyZ2V0LnByb3RvdHlwZSwgJ2lkQXR0cmlidXRlJyk7CgogICAgLy8gU2V0IHRoZSBwYXJlbnRGayBhcyBhcHByb3ByaWF0ZSBub3cuCiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgewogICAgICB0aGlzLnBhcmVudEZrID0gdGhpcy5wYXJlbnRJZDsKICAgIH0KCiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgIF8uZXh0ZW5kKHNvdXJjZSwgcGl2b3RIZWxwZXJzKTsKCiAgICAvLyBTZXQgdGhlIGFwcHJvcHJpYXRlIGZvcmVpZ24ga2V5IGlmIHdlJ3JlIGRvaW5nIGEgYmVsb25nc1RvTWFueSwgZm9yIGNvbnZlbmllbmNlLgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknKSB7CiAgICAgIHRoaXMuZm9yZWlnbktleSA9IHRoaXMudGhyb3VnaEZvcmVpZ25LZXk7CiAgICB9CgogICAgcmV0dXJuIHNvdXJjZTsKICB9LAoKICAvLyBHZW5lcmF0ZXMgYW5kIHJldHVybnMgYSBzcGVjaWZpZWQga2V5LCBmb3IgY29udmVuaWVuY2UuLi4gb25lIG9mCiAgLy8gYGZvcmVpZ25LZXlgLCBgb3RoZXJLZXlgLCBgdGhyb3VnaEZvcmVpZ25LZXlgLgogIGtleTogZnVuY3Rpb24oa2V5TmFtZSkgewogICAgdmFyIGlkS2V5TmFtZTsKICAgIGlmICh0aGlzW2tleU5hbWVdKSByZXR1cm4gdGhpc1trZXlOYW1lXTsKICAgIGlmIChrZXlOYW1lID09PSAnb3RoZXJLZXknKSB7CiAgICAgIHJldHVybiB0aGlzW2tleU5hbWVdID0gc2luZ3VsYXJNZW1vKHRoaXMudGFyZ2V0VGFibGVOYW1lKSArICdfJyArIHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGU7CiAgICB9CiAgICBpZiAoa2V5TmFtZSA9PT0gJ3Rocm91Z2hGb3JlaWduS2V5JykgewogICAgICByZXR1cm4gdGhpc1trZXlOYW1lXSA9IHNpbmd1bGFyTWVtbyh0aGlzLmpvaW5UYWJsZSgpKSArICdfJyArIHRoaXMudGhyb3VnaElkQXR0cmlidXRlOwogICAgfQogICAgaWYgKGtleU5hbWUgPT09ICdmb3JlaWduS2V5JykgewogICAgICBpZiAodGhpcy50eXBlID09PSAnbW9ycGhUbycpIHsKICAgICAgICBpZEtleU5hbWUgPSB0aGlzLmNvbHVtbk5hbWVzICYmIHRoaXMuY29sdW1uTmFtZXNbMV0gPyB0aGlzLmNvbHVtbk5hbWVzWzFdIDogdGhpcy5tb3JwaE5hbWUgKyAnX2lkJzsKICAgICAgICByZXR1cm4gdGhpc1trZXlOYW1lXSA9IGlkS2V5TmFtZTsKICAgICAgfQogICAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBzaW5ndWxhck1lbW8odGhpcy50YXJnZXRUYWJsZU5hbWUpICsgJ18nICsgdGhpcy50YXJnZXRJZEF0dHJpYnV0ZTsKICAgICAgaWYgKHRoaXMuaXNNb3JwaCgpKSB7CiAgICAgICAgaWRLZXlOYW1lID0gdGhpcy5jb2x1bW5OYW1lcyAmJiB0aGlzLmNvbHVtbk5hbWVzWzFdID8gdGhpcy5jb2x1bW5OYW1lc1sxXSA6IHRoaXMubW9ycGhOYW1lICsgJ19pZCc7CiAgICAgICAgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBpZEtleU5hbWU7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXNba2V5TmFtZV0gPSBzaW5ndWxhck1lbW8odGhpcy5wYXJlbnRUYWJsZU5hbWUpICsgJ18nICsgdGhpcy5wYXJlbnRJZEF0dHJpYnV0ZTsKICAgIH0KICAgIGlmIChrZXlOYW1lID09PSAnbW9ycGhLZXknKSB7CiAgICAgIHZhciB0eXBlS2V5TmFtZSA9IHRoaXMuY29sdW1uTmFtZXMgJiYgdGhpcy5jb2x1bW5OYW1lc1swXSA/IHRoaXMuY29sdW1uTmFtZXNbMF0gOiB0aGlzLm1vcnBoTmFtZSArICdfdHlwZSc7CiAgICAgIHJldHVybiB0aGlzW2tleU5hbWVdID0gdHlwZUtleU5hbWU7CiAgICB9CiAgICBpZiAoa2V5TmFtZSA9PT0gJ21vcnBoVmFsdWUnKSByZXR1cm4gdGhpc1trZXlOYW1lXSA9IHRoaXMucGFyZW50VGFibGVOYW1lIHx8IHRoaXMudGFyZ2V0VGFibGVOYW1lOwogIH0sCgogIC8vIEluamVjdHMgdGhlIG5lY2Vzc2FyeSBgc2VsZWN0YCBjb25zdHJhaW50cyBpbnRvIGEgYGtuZXhgIHF1ZXJ5IGJ1aWxkZXIuCiAgc2VsZWN0Q29uc3RyYWludHM6IGZ1bmN0aW9uKGtuZXgsIG9wdGlvbnMpIHsKICAgIHZhciByZXNwID0gb3B0aW9ucy5wYXJlbnRSZXNwb25zZTsKCiAgICAvLyBUaGUgYGJlbG9uZ3NUb01hbnlgIGFuZCBgdGhyb3VnaGAgcmVsYXRpb25zIGhhdmUgam9pbnMgJiBwaXZvdCBjb2x1bW5zLgogICAgaWYgKHRoaXMuaXNKb2luZWQoKSkgdGhpcy5qb2luQ2xhdXNlcyhrbmV4KTsKCiAgICAvLyBDYWxsIHRoZSBmdW5jdGlvbiwgaWYgb25lIGV4aXN0cywgdG8gY29uc3RyYWluIHRoZSBlYWdlciBsb2FkZWQgcXVlcnkuCiAgICBpZiAob3B0aW9ucy5fYmVmb3JlRm4pIG9wdGlvbnMuX2JlZm9yZUZuLmNhbGwoa25leCwga25leCk7CgogICAgLy8gVGhlIGJhc2Ugc2VsZWN0IGNvbHVtbgogICAgaWYgKF8uaXNBcnJheShvcHRpb25zLmNvbHVtbnMpKSB7CiAgICAgIGtuZXguY29sdW1ucyhvcHRpb25zLmNvbHVtbnMpOwogICAgfQoKICAgIHZhciBjdXJyZW50Q29sdW1ucyA9IF8uZmluZFdoZXJlKGtuZXguX3N0YXRlbWVudHMsIHtncm91cGluZzogJ2NvbHVtbnMnfSk7CgogICAgaWYgKCFjdXJyZW50Q29sdW1ucyB8fCBjdXJyZW50Q29sdW1ucy5sZW5ndGggPT09IDApIHsKICAgICAga25leC5jb2x1bW4odGhpcy50YXJnZXRUYWJsZU5hbWUgKyAnLionKTsKICAgIH0KCiAgICBpZiAodGhpcy5pc0pvaW5lZCgpKSB0aGlzLmpvaW5Db2x1bW5zKGtuZXgpOwogICAgCiAgICAvLyBJZiB0aGlzIGlzIGEgc2luZ2xlIHJlbGF0aW9uIGFuZCB3ZSdyZSBub3QgZWFnZXIgbG9hZGluZywKICAgIC8vIGxpbWl0IHRoZSBxdWVyeSB0byBhIHNpbmdsZSBpdGVtLgogICAgaWYgKHRoaXMuaXNTaW5nbGUoKSAmJiAhcmVzcCkga25leC5saW1pdCgxKTsKCiAgICAvLyBGaW5hbGx5LCBhZGQgKGFuZCB2YWxpZGF0ZSkgdGhlIHdoZXJlIGNvbmRpdGlvbnMsIG5lY2Vzc2FyeSBmb3IgY29uc3RyYWluaW5nIHRoZSByZWxhdGlvbi4KICAgIHRoaXMud2hlcmVDbGF1c2VzKGtuZXgsIHJlc3ApOwogIH0sCgogIC8vIEluamVjdCAmIHZhbGlkYXRlcyBuZWNlc3NhcnkgYHRocm91Z2hgIGNvbnN0cmFpbnRzIGZvciB0aGUgY3VycmVudCBtb2RlbC4KICBqb2luQ29sdW1uczogZnVuY3Rpb24oa25leCkgewogICAgdmFyIGNvbHVtbnMgPSBbXTsKICAgIHZhciBqb2luVGFibGUgPSB0aGlzLmpvaW5UYWJsZSgpOwogICAgaWYgKHRoaXMuaXNUaHJvdWdoKCkpIGNvbHVtbnMucHVzaCh0aGlzLnRocm91Z2hJZEF0dHJpYnV0ZSk7CiAgICBjb2x1bW5zLnB1c2godGhpcy5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIGNvbHVtbnMucHVzaCh0aGlzLmtleSgnb3RoZXJLZXknKSk7CiAgICBwdXNoLmFwcGx5KGNvbHVtbnMsIHRoaXMucGl2b3RDb2x1bW5zKTsKICAgIGtuZXguY29sdW1ucyhfLm1hcChjb2x1bW5zLCBmdW5jdGlvbihjb2wpIHsKICAgICAgcmV0dXJuIGpvaW5UYWJsZSArICcuJyArIGNvbCArICcgYXMgX3Bpdm90XycgKyBjb2w7CiAgICB9KSk7CiAgfSwKCiAgLy8gR2VuZXJhdGVzIHRoZSBqb2luIGNsYXVzZXMgbmVjZXNzYXJ5IGZvciB0aGUgY3VycmVudCByZWxhdGlvbi4KICBqb2luQ2xhdXNlczogZnVuY3Rpb24oa25leCkgewogICAgdmFyIGpvaW5UYWJsZSA9IHRoaXMuam9pblRhYmxlKCk7CgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUbycgfHwgdGhpcy50eXBlID09PSAnYmVsb25nc1RvTWFueScpIHsKCiAgICAgIHZhciB0YXJnZXRLZXkgPSAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMua2V5KCdmb3JlaWduS2V5JykgOiB0aGlzLmtleSgnb3RoZXJLZXknKSk7CgogICAgICBrbmV4LmpvaW4oCiAgICAgICAgam9pblRhYmxlLAogICAgICAgIGpvaW5UYWJsZSArICcuJyArIHRhcmdldEtleSwgJz0nLAogICAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy50YXJnZXRJZEF0dHJpYnV0ZQogICAgICApOwoKICAgICAgLy8gQSBgYmVsb25nc1RvYCAtPiBgdGhyb3VnaGAgaXMgY3VycmVudGx5IHRoZSBvbmx5IHJlbGF0aW9uIHdpdGggdHdvIGpvaW5zLgogICAgICBpZiAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJykgewogICAgICAgIGtuZXguam9pbigKICAgICAgICAgIHRoaXMucGFyZW50VGFibGVOYW1lLAogICAgICAgICAgam9pblRhYmxlICsgJy4nICsgdGhpcy50aHJvdWdoSWRBdHRyaWJ1dGUsICc9JywKICAgICAgICAgIHRoaXMucGFyZW50VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JykKICAgICAgICApOwogICAgICB9CgogICAgfSBlbHNlIHsKICAgICAga25leC5qb2luKAogICAgICAgIGpvaW5UYWJsZSwKICAgICAgICBqb2luVGFibGUgKyAnLicgKyB0aGlzLnRocm91Z2hJZEF0dHJpYnV0ZSwgJz0nLAogICAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JykKICAgICAgKTsKICAgIH0KICB9LAoKICAvLyBDaGVjayB0aGF0IHRoZXJlIGlzbid0IGFuIGluY29ycmVjdCBmb3JlaWduIGtleSBzZXQsIHZzLiB0aGUgb25lCiAgLy8gcGFzc2VkIGluIHdoZW4gdGhlIHJlbGF0aW9uIHdhcyBmb3JtZWQuCiAgd2hlcmVDbGF1c2VzOiBmdW5jdGlvbihrbmV4LCByZXNwKSB7CiAgICB2YXIga2V5OwoKICAgIGlmICh0aGlzLmlzSm9pbmVkKCkpIHsKICAgICAgdmFyIHRhcmdldFRhYmxlID0gdGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMucGFyZW50VGFibGVOYW1lIDogdGhpcy5qb2luVGFibGUoKTsKICAgICAga2V5ID0gdGFyZ2V0VGFibGUgKyAnLicgKyAodGhpcy50eXBlID09PSAnYmVsb25nc1RvJyA/IHRoaXMucGFyZW50SWRBdHRyaWJ1dGUgOiB0aGlzLmtleSgnZm9yZWlnbktleScpKTsKICAgIH0gZWxzZSB7CiAgICAgIGtleSA9IHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsKICAgICAgICAodGhpcy5pc0ludmVyc2UoKSA/IHRoaXMudGFyZ2V0SWRBdHRyaWJ1dGUgOiB0aGlzLmtleSgnZm9yZWlnbktleScpKTsKICAgIH0KCiAgICBrbmV4W3Jlc3AgPyAnd2hlcmVJbicgOiAnd2hlcmUnXShrZXksIHJlc3AgPyB0aGlzLmVhZ2VyS2V5cyhyZXNwKSA6IHRoaXMucGFyZW50RmspOwoKICAgIGlmICh0aGlzLmlzTW9ycGgoKSkgewogICAgICBrbmV4LndoZXJlKHRoaXMudGFyZ2V0VGFibGVOYW1lICsgJy4nICsgdGhpcy5rZXkoJ21vcnBoS2V5JyksIHRoaXMua2V5KCdtb3JwaFZhbHVlJykpOwogICAgfQogIH0sCgogIC8vIEZldGNoZXMgYWxsIGBlYWdlcktleXNgIGZyb20gdGhlIGN1cnJlbnQgcmVsYXRpb24uCiAgZWFnZXJLZXlzOiBmdW5jdGlvbihyZXNwKSB7CiAgICB2YXIga2V5ID0gdGhpcy5pc0ludmVyc2UoKSAmJiAhdGhpcy5pc1Rocm91Z2goKSA/IHRoaXMua2V5KCdmb3JlaWduS2V5JykgOiB0aGlzLnBhcmVudElkQXR0cmlidXRlOwogICAgcmV0dXJuIF8udW5pcShfLnBsdWNrKHJlc3AsIGtleSkpOwogIH0sCgogIC8vIEdlbmVyYXRlcyB0aGUgYXBwcm9wcmlhdGUgc3RhbmRhcmQgam9pbiB0YWJsZS4KICBqb2luVGFibGU6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuaXNUaHJvdWdoKCkpIHJldHVybiB0aGlzLnRocm91Z2hUYWJsZU5hbWU7CiAgICByZXR1cm4gdGhpcy5qb2luVGFibGVOYW1lIHx8IFsKICAgICAgdGhpcy5wYXJlbnRUYWJsZU5hbWUsCiAgICAgIHRoaXMudGFyZ2V0VGFibGVOYW1lCiAgICBdLnNvcnQoKS5qb2luKCdfJyk7CiAgfSwKCiAgLy8gQ3JlYXRlcyBhIG5ldyBtb2RlbCBvciBjb2xsZWN0aW9uIGluc3RhbmNlLCBkZXBlbmRpbmcgb24KICAvLyB0aGUgYHJlbGF0ZWREYXRhYCBzZXR0aW5ncyBhbmQgdGhlIG1vZGVscyBwYXNzZWQgaW4uCiAgcmVsYXRlZEluc3RhbmNlOiBmdW5jdGlvbihtb2RlbHMpIHsKICAgIG1vZGVscyA9IG1vZGVscyB8fCBbXTsKCiAgICB2YXIgVGFyZ2V0ID0gdGhpcy50YXJnZXQ7CgogICAgLy8gSWYgaXQncyBhIHNpbmdsZSBtb2RlbCwgY2hlY2sgd2hldGhlciB0aGVyZSdzIGFscmVhZHkgYSBtb2RlbAogICAgLy8gd2UgY2FuIHBpY2sgZnJvbS4uLiBvdGhlcndpc2UgY3JlYXRlIGEgbmV3IGluc3RhbmNlLgogICAgaWYgKHRoaXMuaXNTaW5nbGUoKSkgewogICAgICBpZiAoIShUYXJnZXQucHJvdG90eXBlIGluc3RhbmNlb2YgTW9kZWxCYXNlKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGAnK3RoaXMudHlwZSsnYCByZWxhdGVkIG9iamVjdCBtdXN0IGJlIGEgQm9va3NoZWxmLk1vZGVsJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1vZGVsc1swXSB8fCBuZXcgVGFyZ2V0KCk7CiAgICB9CgogICAgLy8gQWxsb3dzIHVzIHRvIGp1c3QgdXNlIGEgbW9kZWwsIGJ1dCBjcmVhdGUgYSB0ZW1wb3JhcnkKICAgIC8vIGNvbGxlY3Rpb24gZm9yIGEgIiotbWFueSIgcmVsYXRpb24uCiAgICBpZiAoVGFyZ2V0LnByb3RvdHlwZSBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICBUYXJnZXQgPSB0aGlzLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICAgICAgICBtb2RlbDogVGFyZ2V0CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBUYXJnZXQobW9kZWxzLCB7cGFyc2U6IHRydWV9KTsKICB9LAoKICAvLyBHcm91cHMgdGhlIHJlbGF0ZWQgcmVzcG9uc2UgYWNjb3JkaW5nIHRvIHRoZSB0eXBlIG9mIHJlbGF0aW9uc2hpcAogIC8vIHdlJ3JlIGhhbmRsaW5nLCBmb3IgZWFzeSBhdHRhY2htZW50IHRvIHRoZSBwYXJlbnQgbW9kZWxzLgogIGVhZ2VyUGFpcjogZnVuY3Rpb24ocmVsYXRpb25OYW1lLCByZWxhdGVkLCBwYXJlbnRNb2RlbHMpIHsKICAgIHZhciBtb2RlbDsKCiAgICAvLyBJZiB0aGlzIGlzIGEgbW9ycGhUbywgd2Ugb25seSB3YW50IHRvIHBhaXIgb24gdGhlIG1vcnBoVmFsdWUgZm9yIHRoZSBjdXJyZW50IHJlbGF0aW9uLgogICAgaWYgKHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nKSB7CiAgICAgIHBhcmVudE1vZGVscyA9IF8uZmlsdGVyKHBhcmVudE1vZGVscywgZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHRoaXMua2V5KCdtb3JwaEtleScpKSA9PT0gdGhpcy5rZXkoJ21vcnBoVmFsdWUnKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CgogICAgLy8gSWYgdGhpcyBpcyBhIGB0aHJvdWdoYCBvciBgYmVsb25nc1RvTWFueWAgcmVsYXRpb24sIHdlIG5lZWQgdG8gY2xlYW51cCAmIHNldHVwIHRoZSBgaW50ZXJpbWAgbW9kZWwuCiAgICBpZiAodGhpcy5pc0pvaW5lZCgpKSByZWxhdGVkID0gdGhpcy5wYXJzZVBpdm90KHJlbGF0ZWQpOwoKICAgIC8vIEdyb3VwIGFsbCBvZiB0aGUgcmVsYXRlZCBtb2RlbHMgZm9yIGVhc2llciBhc3NvY2lhdGlvbiB3aXRoIHRoZWlyIHBhcmVudCBtb2RlbHMuCiAgICB2YXIgZ3JvdXBlZCA9IF8uZ3JvdXBCeShyZWxhdGVkLCBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAobW9kZWwucGl2b3QpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc0ludmVyc2UoKSAmJiB0aGlzLmlzVGhyb3VnaCgpID8gbW9kZWwucGl2b3QuaWQgOgogICAgICAgICAgbW9kZWwucGl2b3QuZ2V0KHRoaXMua2V5KCdmb3JlaWduS2V5JykpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmlzSW52ZXJzZSgpID8gbW9kZWwuaWQgOiBtb2RlbC5nZXQodGhpcy5rZXkoJ2ZvcmVpZ25LZXknKSk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwoKICAgIC8vIExvb3Agb3ZlciB0aGUgYHBhcmVudE1vZGVsc2AgYW5kIGF0dGFjaCB0aGUgZ3JvdXBlZCBzdWItbW9kZWxzLAogICAgLy8ga2VlcGluZyB0aGUgYHJlbGF0ZWREYXRhYCBvbiB0aGUgbmV3IHJlbGF0ZWQgaW5zdGFuY2UuCiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHBhcmVudE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgbW9kZWwgPSBwYXJlbnRNb2RlbHNbaV07CiAgICAgIHZhciBncm91cGVkS2V5OwogICAgICBpZiAoIXRoaXMuaXNJbnZlcnNlKCkpIHsKICAgICAgICBncm91cGVkS2V5ID0gbW9kZWwuaWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZvcm1hdHRlZCA9IG1vZGVsLmZvcm1hdChfLmV4dGVuZChPYmplY3QuY3JlYXRlKG51bGwpLCBtb2RlbC5hdHRyaWJ1dGVzKSk7CiAgICAgICAgZ3JvdXBlZEtleSA9IHRoaXMuaXNUaHJvdWdoKCkgPyBmb3JtYXR0ZWRbdGhpcy5rZXkoJ3Rocm91Z2hGb3JlaWduS2V5JyldIDogZm9ybWF0dGVkW3RoaXMua2V5KCdmb3JlaWduS2V5JyldOwogICAgICB9CiAgICAgIHZhciByZWxhdGlvbiA9IG1vZGVsLnJlbGF0aW9uc1tyZWxhdGlvbk5hbWVdID0gdGhpcy5yZWxhdGVkSW5zdGFuY2UoZ3JvdXBlZFtncm91cGVkS2V5XSk7CiAgICAgIHJlbGF0aW9uLnJlbGF0ZWREYXRhID0gdGhpczsKICAgICAgaWYgKHRoaXMuaXNKb2luZWQoKSkgXy5leHRlbmQocmVsYXRpb24sIHBpdm90SGVscGVycyk7CiAgICB9CgogICAgLy8gTm93IHRoYXQgcmVsYXRlZCBtb2RlbHMgaGF2ZSBiZWVuIHN1Y2Nlc3NmdWxseSBwYWlyZWQsIHVwZGF0ZSBlYWNoIHdpdGgKICAgIC8vIGl0cyBwYXJzZWQgYXR0cmlidXRlcwogICAgZm9yIChpID0gMCwgbCA9IHJlbGF0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIG1vZGVsID0gcmVsYXRlZFtpXTsKICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IG1vZGVsLnBhcnNlKG1vZGVsLmF0dHJpYnV0ZXMpOwogICAgfQoKICAgIHJldHVybiByZWxhdGVkOwogIH0sCgogIC8vIFRoZSBgbW9kZWxzYCBpcyBhbiBhcnJheSBvZiBtb2RlbHMgcmV0dXJuZWQgZnJvbSB0aGUgZmV0Y2gsCiAgLy8gYWZ0ZXIgdGhleSdyZSBgc2V0YC4uLiBwYXJzaW5nIG91dCBhbnkgb2YgdGhlIGBfcGl2b3RfYCBpdGVtcyBmcm9tIHRoZQogIC8vIGpvaW4gdGFibGUgYW5kIGFzc2lnbmluZyB0aGVtIG9uIHRoZSBwaXZvdCBtb2RlbCBvciBvYmplY3QgYXMgYXBwcm9wcmlhdGUuCiAgcGFyc2VQaXZvdDogZnVuY3Rpb24obW9kZWxzKSB7CiAgICB2YXIgVGhyb3VnaCA9IHRoaXMudGhyb3VnaFRhcmdldDsKICAgIHJldHVybiBfLm1hcChtb2RlbHMsIGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciBkYXRhID0ge30sIGtlZXAgPSB7fSwgYXR0cnMgPSBtb2RlbC5hdHRyaWJ1dGVzLCB0aHJvdWdoOwogICAgICBpZiAoVGhyb3VnaCkgdGhyb3VnaCA9IG5ldyBUaHJvdWdoKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChrZXkuaW5kZXhPZignX3Bpdm90XycpID09PSAwKSB7CiAgICAgICAgICBkYXRhW2tleS5zbGljZSg3KV0gPSBhdHRyc1trZXldOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBrZWVwW2tleV0gPSBhdHRyc1trZXldOwogICAgICAgIH0KICAgICAgfQogICAgICBtb2RlbC5hdHRyaWJ1dGVzID0ga2VlcDsKICAgICAgaWYgKCFfLmlzRW1wdHkoZGF0YSkpIHsKICAgICAgICBtb2RlbC5waXZvdCA9IHRocm91Z2ggPyB0aHJvdWdoLnNldChkYXRhLCB7c2lsZW50OiB0cnVlfSkgOiBuZXcgdGhpcy5Nb2RlbChkYXRhLCB7CiAgICAgICAgICB0YWJsZU5hbWU6IHRoaXMuam9pblRhYmxlKCkKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LCB0aGlzKTsKICB9LAoKICAvLyBBIGZldyBwcmVkaWNhdGVzIHRvIGhlbHAgY2xhcmlmeSBzb21lIG9mIHRoZSBsb2dpYyBhYm92ZS4KICBpc1Rocm91Z2g6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLnRocm91Z2hUYXJnZXQgIT0gbnVsbCk7CiAgfSwKICBpc0pvaW5lZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKHRoaXMudHlwZSA9PT0gJ2JlbG9uZ3NUb01hbnknIHx8IHRoaXMuaXNUaHJvdWdoKCkpOwogIH0sCiAgaXNNb3JwaDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gKHRoaXMudHlwZSA9PT0gJ21vcnBoT25lJyB8fCB0aGlzLnR5cGUgPT09ICdtb3JwaE1hbnknKTsKICB9LAogIGlzU2luZ2xlOiBmdW5jdGlvbigpIHsKICAgIHZhciB0eXBlID0gdGhpcy50eXBlOwogICAgcmV0dXJuICh0eXBlID09PSAnaGFzT25lJyB8fCB0eXBlID09PSAnYmVsb25nc1RvJyB8fCB0eXBlID09PSAnbW9ycGhPbmUnIHx8IHR5cGUgPT09ICdtb3JwaFRvJyk7CiAgfSwKICBpc0ludmVyc2U6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICh0aGlzLnR5cGUgPT09ICdiZWxvbmdzVG8nIHx8IHRoaXMudHlwZSA9PT0gJ21vcnBoVG8nKTsKICB9LAoKICAvLyBTZXRzIHRoZSBgcGl2b3RDb2x1bW5zYCB0byBiZSByZXRyaWV2ZWQgYWxvbmcgd2l0aCB0aGUgY3VycmVudCBtb2RlbC4KICB3aXRoUGl2b3Q6IGZ1bmN0aW9uKGNvbHVtbnMpIHsKICAgIGlmICghXy5pc0FycmF5KGNvbHVtbnMpKSBjb2x1bW5zID0gW2NvbHVtbnNdOwogICAgdGhpcy5waXZvdENvbHVtbnMgfHwgKHRoaXMucGl2b3RDb2x1bW5zID0gW10pOwogICAgcHVzaC5hcHBseSh0aGlzLnBpdm90Q29sdW1ucywgY29sdW1ucyk7CiAgfQoKfSk7CgovLyBTaW1wbGUgbWVtb2l6YXRpb24gb2YgdGhlIHNpbmd1bGFyaXplIGNhbGwuCnZhciBzaW5ndWxhck1lbW8gPSAoZnVuY3Rpb24oKSB7CiAgdmFyIGNhY2hlID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICByZXR1cm4gZnVuY3Rpb24oYXJnKSB7CiAgICBpZiAoYXJnIGluIGNhY2hlKSB7CiAgICAgIHJldHVybiBjYWNoZVthcmddOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGNhY2hlW2FyZ10gPSBpbmZsZWN0aW9uLnNpbmd1bGFyaXplKGFyZyk7CiAgICB9CiAgfTsKfSgpKTsKCi8vIFNwZWNpZmljIHRvIG1hbnktdG8tbWFueSByZWxhdGlvbnNoaXBzLCB0aGVzZSBtZXRob2RzIGFyZSBtaXhlZAovLyBpbnRvIHRoZSBgYmVsb25nc1RvTWFueWAgcmVsYXRpb25zaGlwcyB3aGVuIHRoZXkgYXJlIGNyZWF0ZWQsCi8vIHByb3ZpZGluZyBoZWxwZXJzIGZvciBhdHRhY2hpbmcgYW5kIGRldGFjaGluZyByZWxhdGVkIG1vZGVscy4KdmFyIHBpdm90SGVscGVycyA9IHsKCiAgLy8gQXR0YWNoIG9uZSBvciBtb3JlICJpZHMiIGZyb20gYSBmb3JlaWduCiAgLy8gdGFibGUgdG8gdGhlIGN1cnJlbnQuIENyZWF0ZXMgJiBzYXZlcyBhIG5ldyBtb2RlbAogIC8vIGFuZCBhdHRhY2hlcyB0aGUgbW9kZWwgd2l0aCBhIGpvaW4gdGFibGUgZW50cnkuCiAgYXR0YWNoOiBmdW5jdGlvbihpZHMsIG9wdGlvbnMpIHsKICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykudGhlbihmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy50cmlnZ2VyVGhlbignYXR0YWNoaW5nJywgdGhpcywgaWRzLCBvcHRpb25zKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVyKCdpbnNlcnQnLCBpZHMsIG9wdGlvbnMpOwogICAgfSkudGhlbihmdW5jdGlvbihyZXNwKSB7CiAgICAgIHJldHVybiB0aGlzLnRyaWdnZXJUaGVuKCdhdHRhY2hlZCcsIHRoaXMsIHJlc3AsIG9wdGlvbnMpOwogICAgfSk7CiAgfSwKCiAgLy8gRGV0YWNoIHJlbGF0ZWQgb2JqZWN0IGZyb20gdGhlaXIgcGl2b3QgdGFibGVzLgogIC8vIElmIGEgbW9kZWwgb3IgaWQgaXMgcGFzc2VkLCBpdCBhdHRlbXB0cyB0byByZW1vdmUgdGhlCiAgLy8gcGl2b3QgdGFibGUgYmFzZWQgb24gdGhhdCBmb3JlaWduIGtleS4gSWYgYSBoYXNoIGlzIHBhc3NlZCwKICAvLyBpdCBhdHRlbXB0cyB0byByZW1vdmUgdGhlIGl0ZW0gYmFzZWQgb24gYSB3aGVyZSBjbGF1c2Ugd2l0aAogIC8vIHRoZXNlIHBhcmFtZXRlcnMuIElmIG5vIHBhcmFtZXRlcnMgYXJlIHNwZWNpZmllZCwgd2UgYXNzdW1lIHdlIHdpbGwKICAvLyBkZXRhY2ggYWxsIHJlbGF0ZWQgYXNzb2NpYXRpb25zLgogIGRldGFjaDogZnVuY3Rpb24oaWRzLCBvcHRpb25zKSB7CiAgICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpLnRoZW4oZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMudHJpZ2dlclRoZW4oJ2RldGFjaGluZycsIHRoaXMsIGlkcywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5faGFuZGxlcignZGVsZXRlJywgaWRzLCBvcHRpb25zKTsKICAgIH0pLnRoZW4oZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gdGhpcy50cmlnZ2VyVGhlbignZGV0YWNoZWQnLCB0aGlzLCByZXNwLCBvcHRpb25zKTsKICAgIH0pOwogIH0sCgogIC8vIFVwZGF0ZSBhbiBleGlzdGluZyByZWxhdGlvbidzIHBpdm90IHRhYmxlIGVudHJ5LgogIHVwZGF0ZVBpdm90OiBmdW5jdGlvbihkYXRhLCBvcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy5faGFuZGxlcigndXBkYXRlJywgZGF0YSwgb3B0aW9ucyk7CiAgfSwKCiAgLy8gU2VsZWN0cyBhbnkgYWRkaXRpb25hbCBjb2x1bW5zIG9uIHRoZSBwaXZvdCB0YWJsZSwKICAvLyB0YWtpbmcgYSBoYXNoIG9mIGNvbHVtbnMgd2hpY2ggc3BlY2lmaWVzIHRoZSBwaXZvdAogIC8vIGNvbHVtbiBuYW1lLCBhbmQgdGhlIHZhbHVlIHRoZSBjb2x1bW4gc2hvdWxkIHRha2Ugb24gdGhlCiAgLy8gb3V0cHV0IHRvIHRoZSBtb2RlbCBhdHRyaWJ1dGVzLgogIHdpdGhQaXZvdDogZnVuY3Rpb24oY29sdW1ucykgewogICAgdGhpcy5yZWxhdGVkRGF0YS53aXRoUGl2b3QoY29sdW1ucyk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICAvLyBIZWxwZXIgZm9yIGhhbmRsaW5nIGVpdGhlciB0aGUgYGF0dGFjaGAgb3IgYGRldGFjaGAgY2FsbCBvbgogIC8vIHRoZSBgYmVsb25nc1RvTWFueWAgb3IgYGhhc09uZWAgLyBgaGFzTWFueWAgOnRocm91Z2ggcmVsYXRpb25zaGlwLgogIF9oYW5kbGVyOiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihtZXRob2QsIGlkcywgb3B0aW9ucykgewogICAgdmFyIHBlbmRpbmcgPSBbXTsKICAgIGlmIChpZHMgPT0gdm9pZCAwKSB7CiAgICAgIGlmIChtZXRob2QgPT09ICdpbnNlcnQnKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHRoaXMpOwogICAgICBpZiAobWV0aG9kID09PSAnZGVsZXRlJykgcGVuZGluZy5wdXNoKHRoaXMuX3Byb2Nlc3NQaXZvdChtZXRob2QsIG51bGwsIG9wdGlvbnMpKTsKICAgIH0KICAgIGlmICghXy5pc0FycmF5KGlkcykpIGlkcyA9IGlkcyA/IFtpZHNdIDogW107CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGlkcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgcGVuZGluZy5wdXNoKHRoaXMuX3Byb2Nlc3NQaXZvdChtZXRob2QsIGlkc1tpXSwgb3B0aW9ucykpOwogICAgfQogICAgcmV0dXJuIFByb21pc2UuYWxsKHBlbmRpbmcpLnlpZWxkKHRoaXMpOwogIH0pLAoKICAvLyBIYW5kbGVzIHNldHRpbmcgdGhlIGFwcHJvcHJpYXRlIGNvbnN0cmFpbnRzIGFuZCBzaGVsbGluZyBvdXQKICAvLyB0byBlaXRoZXIgdGhlIGBpbnNlcnRgIG9yIGBkZWxldGVgIGNhbGwgZm9yIHRoZSBjdXJyZW50IG1vZGVsLAogIC8vIHJldHVybmluZyBhIHByb21pc2UuCiAgX3Byb2Nlc3NQaXZvdDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24obWV0aG9kLCBpdGVtLCBvcHRpb25zKSB7CiAgICB2YXIgZGF0YSA9IHt9OwogICAgdmFyIHJlbGF0ZWREYXRhID0gdGhpcy5yZWxhdGVkRGF0YTsKCiAgICAvLyBHcmFiIHRoZSBga25leGAgcXVlcnkgYnVpbGRlciBmb3IgdGhlIGN1cnJlbnQgbW9kZWwsIGFuZAogICAgLy8gY2hlY2sgaWYgd2UgaGF2ZSBhbnkgYWRkaXRpb25hbCBjb25zdHJhaW50cyBmb3IgdGhlIHF1ZXJ5LgogICAgdmFyIGJ1aWxkZXIgPSB0aGlzLl9idWlsZGVyKHJlbGF0ZWREYXRhLmpvaW5UYWJsZSgpKTsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucXVlcnkpIHsKICAgICAgSGVscGVycy5xdWVyeS5jYWxsKG51bGwsIHtfa25leDogYnVpbGRlcn0sIFtvcHRpb25zLnF1ZXJ5XSk7CiAgICB9CgogICAgZGF0YVtyZWxhdGVkRGF0YS5rZXkoJ2ZvcmVpZ25LZXknKV0gPSByZWxhdGVkRGF0YS5wYXJlbnRGazsKCiAgICAvLyBJZiB0aGUgaXRlbSBpcyBhbiBvYmplY3QsIGl0J3MgZWl0aGVyIGEgbW9kZWwKICAgIC8vIHRoYXQgd2UncmUgbG9va2luZyB0byBhdHRhY2ggdG8gdGhpcyBtb2RlbCwgb3IKICAgIC8vIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIHNldCBpbiB0aGUgcmVsYXRpb24uCiAgICBpZiAoXy5pc09iamVjdChpdGVtKSkgewogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIE1vZGVsQmFzZSkgewogICAgICAgIGRhdGFbcmVsYXRlZERhdGEua2V5KCdvdGhlcktleScpXSA9IGl0ZW0uaWQ7CiAgICAgIH0gZWxzZSBpZiAobWV0aG9kICE9PSAndXBkYXRlJykgewogICAgICAgIF8uZXh0ZW5kKGRhdGEsIGl0ZW0pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGl0ZW0pIHsKICAgICAgZGF0YVtyZWxhdGVkRGF0YS5rZXkoJ290aGVyS2V5JyldID0gaXRlbTsKICAgIH0KCiAgICBpZiAob3B0aW9ucykgewogICAgICBpZiAob3B0aW9ucy50cmFuc2FjdGluZykgYnVpbGRlci50cmFuc2FjdGluZyhvcHRpb25zLnRyYW5zYWN0aW5nKTsKICAgICAgaWYgKG9wdGlvbnMuZGVidWcpIGJ1aWxkZXIuZGVidWcoKTsKICAgIH0KICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgIGlmIChtZXRob2QgPT09ICdkZWxldGUnKSB7CiAgICAgIHJldHVybiBidWlsZGVyLndoZXJlKGRhdGEpLmRlbCgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG1vZGVsOwogICAgICAgIGlmICghaXRlbSkgcmV0dXJuIGNvbGxlY3Rpb24ucmVzZXQoKTsKICAgICAgICBpZiAobW9kZWwgPSBjb2xsZWN0aW9uLmdldChkYXRhW3JlbGF0ZWREYXRhLmtleSgnb3RoZXJLZXknKV0pKSB7CiAgICAgICAgICBjb2xsZWN0aW9uLnJlbW92ZShtb2RlbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGlmIChtZXRob2QgPT09ICd1cGRhdGUnKSB7CiAgICAgIHJldHVybiBidWlsZGVyLndoZXJlKGRhdGEpLnVwZGF0ZShpdGVtKS50aGVuKGZ1bmN0aW9uIChudW1VcGRhdGVkKSB7CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5yZXF1aXJlID09PSB0cnVlICYmIG51bVVwZGF0ZWQgPT09IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gcm93cyB3ZXJlIHVwZGF0ZWQnKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bVVwZGF0ZWQ7CiAgICAgIH0pOwogICAgfQoKICAgIHJldHVybiBidWlsZGVyLmluc2VydChkYXRhKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBjb2xsZWN0aW9uLmFkZChpdGVtKTsKICAgIH0pOwogIH0pCgp9OwoKbW9kdWxlLmV4cG9ydHMgPSBCb29rc2hlbGZSZWxhdGlvbjsKCn0seyIuL2Jhc2UvbW9kZWwiOjUsIi4vYmFzZS9wcm9taXNlIjo2LCIuL2Jhc2UvcmVsYXRpb24iOjcsIi4vaGVscGVycyI6MTEsImluZmxlY3Rpb24iOjc1LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBTeW5jCi8vIC0tLS0tLS0tLS0tLS0tLQp2YXIgXyAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4vYmFzZS9wcm9taXNlJyk7CgovLyBTeW5jIGlzIHRoZSBkaXNwYXRjaGVyIGZvciBhbnkgZGF0YWJhc2UgcXVlcmllcywKLy8gdGFraW5nIHRoZSAic3luY2luZyIgYG1vZGVsYCBvciBgY29sbGVjdGlvbmAgYmVpbmcgcXVlcmllZCwgYWxvbmcgd2l0aAovLyBhIGhhc2ggb2Ygb3B0aW9ucyB0aGF0IGFyZSB1c2VkIGluIHRoZSB2YXJpb3VzIHF1ZXJ5IG1ldGhvZHMuCi8vIElmIHRoZSBgdHJhbnNhY3RpbmdgIG9wdGlvbiBpcyBzZXQsIHRoZSBxdWVyeSBpcyBhc3N1bWVkIHRvIGJlCi8vIHBhcnQgb2YgYSB0cmFuc2FjdGlvbiwgYW5kIHRoaXMgaW5mb3JtYXRpb24gaXMgcGFzc2VkIGFsb25nIHRvIGBLbmV4YC4KdmFyIFN5bmMgPSBmdW5jdGlvbihzeW5jaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgdGhpcy5xdWVyeSAgID0gc3luY2luZy5xdWVyeSgpOwogIHRoaXMuc3luY2luZyA9IHN5bmNpbmcucmVzZXRRdWVyeSgpOwogIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgaWYgKG9wdGlvbnMuZGVidWcpIHRoaXMucXVlcnkuZGVidWcoKTsKICBpZiAob3B0aW9ucy50cmFuc2FjdGluZykgdGhpcy5xdWVyeS50cmFuc2FjdGluZyhvcHRpb25zLnRyYW5zYWN0aW5nKTsKfTsKCl8uZXh0ZW5kKFN5bmMucHJvdG90eXBlLCB7CgogIC8vIFByZWZpeCBhbGwga2V5cyBvZiB0aGUgcGFzc2VkIGluIG9iamVjdCB3aXRoIHRoZQogIC8vIGN1cnJlbnQgdGFibGUgbmFtZQogIHByZWZpeEZpZWxkczogZnVuY3Rpb24oZmllbGRzKSB7CiAgICB2YXIgdGFibGVOYW1lID0gdGhpcy5zeW5jaW5nLnRhYmxlTmFtZTsKICAgIHZhciBwcmVmaXhlZCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIGZpZWxkcykgewogICAgICBwcmVmaXhlZFt0YWJsZU5hbWUgKyAnLicgKyBrZXldID0gZmllbGRzW2tleV07CiAgICB9CiAgICByZXR1cm4gcHJlZml4ZWQ7CiAgfSwKCiAgLy8gU2VsZWN0IHRoZSBmaXJzdCBpdGVtIGZyb20gdGhlIGRhdGFiYXNlIC0gb25seSB1c2VkIGJ5IG1vZGVscy4KICBmaXJzdDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgICB0aGlzLnF1ZXJ5LndoZXJlKHRoaXMucHJlZml4RmllbGRzKHRoaXMuc3luY2luZy5mb3JtYXQoCiAgICAgIF8uZXh0ZW5kKE9iamVjdC5jcmVhdGUobnVsbCksIHRoaXMuc3luY2luZy5hdHRyaWJ1dGVzKQogICAgKSkpLmxpbWl0KDEpOwogICAgcmV0dXJuIHRoaXMuc2VsZWN0KCk7CiAgfSksCgogIC8vIFJ1bnMgYSBgc2VsZWN0YCBxdWVyeSBvbiB0aGUgZGF0YWJhc2UsIGFkZGluZyBhbnkgbmVjZXNzYXJ5IHJlbGF0aW9uYWwKICAvLyBjb25zdHJhaW50cywgcmVzZXR0aW5nIHRoZSBxdWVyeSB3aGVuIGNvbXBsZXRlLiBJZiB0aGVyZSBhcmUgcmVzdWx0cyBhbmQKICAvLyBlYWdlciBsb2FkZWQgcmVsYXRpb25zLCB0aG9zZSBhcmUgZmV0Y2hlZCBhbmQgcmV0dXJuZWQgb24gdGhlIG1vZGVsIGJlZm9yZQogIC8vIHRoZSBwcm9taXNlIGlzIHJlc29sdmVkLiBBbnkgYHN1Y2Nlc3NgIGhhbmRsZXIgcGFzc2VkIGluIHRoZQogIC8vIG9wdGlvbnMgd2lsbCBiZSBjYWxsZWQgLSB1c2VkIGJ5IGJvdGggbW9kZWxzICYgY29sbGVjdGlvbnMuCiAgc2VsZWN0OiBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICAgIHZhciBjb2x1bW5zLCBzeW5jID0gdGhpcywKICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywgcmVsYXRlZERhdGEgPSB0aGlzLnN5bmNpbmcucmVsYXRlZERhdGE7CiAgICB2YXIga25leCA9IHRoaXMucXVlcnk7CgogICAgLy8gSW5qZWN0IGFsbCBhcHByb3ByaWF0ZSBzZWxlY3QgY29zdHJhaW50cyBkZWFsaW5nIHdpdGggdGhlIHJlbGF0aW9uCiAgICAvLyBpbnRvIHRoZSBga25leGAgcXVlcnkgYnVpbGRlciBmb3IgdGhlIGN1cnJlbnQgaW5zdGFuY2UuCiAgICBpZiAocmVsYXRlZERhdGEpIHsKICAgICAgcmVsYXRlZERhdGEuc2VsZWN0Q29uc3RyYWludHMoa25leCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICBjb2x1bW5zID0gb3B0aW9ucy5jb2x1bW5zOwogICAgICAvLyBDYWxsIHRoZSBmdW5jdGlvbiwgaWYgb25lIGV4aXN0cywgdG8gY29uc3RyYWluIHRoZSBlYWdlciBsb2FkZWQgcXVlcnkuCiAgICAgIGlmIChvcHRpb25zLl9iZWZvcmVGbikgb3B0aW9ucy5fYmVmb3JlRm4uY2FsbChrbmV4LCBrbmV4KTsKICAgICAgaWYgKCFfLmlzQXJyYXkoY29sdW1ucykpIGNvbHVtbnMgPSBjb2x1bW5zID8gW2NvbHVtbnNdIDogW18ucmVzdWx0KHRoaXMuc3luY2luZywgJ3RhYmxlTmFtZScpICsgJy4qJ107CiAgICB9CgogICAgLy8gU2V0IHRoZSBxdWVyeSBidWlsZGVyIG9uIHRoZSBvcHRpb25zLCBpbi1jYXNlIHdlIG5lZWQgdG8KICAgIC8vIGFjY2VzcyBpbiB0aGUgYGZldGNoaW5nYCBldmVudCBoYW5kbGVycy4KICAgIG9wdGlvbnMucXVlcnkgPSBrbmV4OwoKICAgIC8vIFRyaWdnZXIgYSBgZmV0Y2hpbmdgIGV2ZW50IG9uIHRoZSBtb2RlbCwgYW5kIHRoZW4gc2VsZWN0IHRoZSBhcHByb3ByaWF0ZSBjb2x1bW5zLgogICAgcmV0dXJuIFByb21pc2UuYmluZCh0aGlzKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5zeW5jaW5nLnRyaWdnZXJUaGVuKCdmZXRjaGluZycsIHRoaXMuc3luY2luZywgY29sdW1ucywgb3B0aW9ucyk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4ga25leC5zZWxlY3QoY29sdW1ucyk7CiAgICB9KTsKICB9KSwKCiAgLy8gSXNzdWVzIGFuIGBpbnNlcnRgIGNvbW1hbmQgb24gdGhlIHF1ZXJ5IC0gb25seSB1c2VkIGJ5IG1vZGVscy4KICBpbnNlcnQ6IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkgewogICAgdmFyIHN5bmNpbmcgPSB0aGlzLnN5bmNpbmc7CiAgICByZXR1cm4gdGhpcy5xdWVyeS5pbnNlcnQoc3luY2luZy5mb3JtYXQoXy5leHRlbmQoT2JqZWN0LmNyZWF0ZShudWxsKSwgc3luY2luZy5hdHRyaWJ1dGVzKSksIHN5bmNpbmcuaWRBdHRyaWJ1dGUpOwogIH0pLAoKICAvLyBJc3N1ZXMgYW4gYHVwZGF0ZWAgY29tbWFuZCBvbiB0aGUgcXVlcnkgLSBvbmx5IHVzZWQgYnkgbW9kZWxzLgogIHVwZGF0ZTogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oYXR0cnMpIHsKICAgIHZhciBzeW5jaW5nID0gdGhpcy5zeW5jaW5nLCBxdWVyeSA9IHRoaXMucXVlcnk7CiAgICBpZiAoc3luY2luZy5pZCAhPSBudWxsKSBxdWVyeS53aGVyZShzeW5jaW5nLmlkQXR0cmlidXRlLCBzeW5jaW5nLmlkKTsKICAgIGlmIChfLndoZXJlKHF1ZXJ5Ll9zdGF0ZW1lbnRzLCB7Z3JvdXBpbmc6ICd3aGVyZSd9KS5sZW5ndGggPT09IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIG1vZGVsIGNhbm5vdCBiZSB1cGRhdGVkIHdpdGhvdXQgYSAid2hlcmUiIGNsYXVzZSBvciBhbiBpZEF0dHJpYnV0ZS4nKTsKICAgIH0KICAgIHJldHVybiBxdWVyeS51cGRhdGUoc3luY2luZy5mb3JtYXQoXy5leHRlbmQoT2JqZWN0LmNyZWF0ZShudWxsKSwgYXR0cnMpKSk7CiAgfSksCgogIC8vIElzc3VlcyBhIGBkZWxldGVgIGNvbW1hbmQgb24gdGhlIHF1ZXJ5LgogIGRlbDogUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgICB2YXIgcXVlcnkgPSB0aGlzLnF1ZXJ5LCBzeW5jaW5nID0gdGhpcy5zeW5jaW5nOwogICAgaWYgKHN5bmNpbmcuaWQgIT0gbnVsbCkgcXVlcnkud2hlcmUoc3luY2luZy5pZEF0dHJpYnV0ZSwgc3luY2luZy5pZCk7CiAgICBpZiAoXy53aGVyZShxdWVyeS5fc3RhdGVtZW50cywge2dyb3VwaW5nOiAnd2hlcmUnfSkubGVuZ3RoID09PSAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcignQSBtb2RlbCBjYW5ub3QgYmUgZGVzdHJveWVkIHdpdGhvdXQgYSAid2hlcmUiIGNsYXVzZSBvciBhbiBpZEF0dHJpYnV0ZS4nKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnF1ZXJ5LmRlbCgpOwogIH0pCgp9KTsKCm1vZHVsZS5leHBvcnRzID0gU3luYzsKfSx7Ii4vYmFzZS9wcm9taXNlIjo2LCJsb2Rhc2giOjEzMH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gICAgIEJhY2tib25lLmpzIDEuMS4wCgovLyAgICAgKGMpIDIwMTAtMjAxMSBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgKGMpIDIwMTEtMjAxMyBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBCYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwKICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCB0aGUgYnJvd3NlciBhbmQgdGhlIHNlcnZlci4KICB2YXIgQmFja2JvbmU7CiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgQmFja2JvbmUgPSBleHBvcnRzOwogIH0gZWxzZSB7CiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMCc7CgogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4KICB2YXIgXyA9IHJvb3QuXzsKICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCiAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0pIHsKICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IHJldGFpbiA9IFtdOwogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsKICAgICAgICAgICAgZm9yIChqID0gMCwgayA9IGV2ZW50cy5sZW5ndGg7IGogPCBrOyBqKyspIHsKICAgICAgICAgICAgICBldiA9IGV2ZW50c1tqXTsKICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2suX2NhbGxiYWNrKSB8fAogICAgICAgICAgICAgICAgICAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBldi5jb250ZXh0KSkgewogICAgICAgICAgICAgICAgcmV0YWluLnB1c2goZXYpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFyZXRhaW4ubGVuZ3RoKSBkZWxldGUgdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRyaWdnZXIgb25lIG9yIG1hbnkgZXZlbnRzLCBmaXJpbmcgYWxsIGJvdW5kIGNhbGxiYWNrcy4gQ2FsbGJhY2tzIGFyZQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8KICAgIC8vIHJlY2VpdmUgdGhlIHRydWUgbmFtZSBvZiB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGFyZ3VtZW50KS4KICAgIHRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOwogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwogICAgICBpZiAoZXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGV2ZW50cywgYXJncyk7CiAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgogICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iaiwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmluZ1RvID0gdGhpcy5fbGlzdGVuaW5nVG87CiAgICAgIGlmICghbGlzdGVuaW5nVG8pIHJldHVybiB0aGlzOwogICAgICB2YXIgcmVtb3ZlID0gIW5hbWUgJiYgIWNhbGxiYWNrOwogICAgICBpZiAoIWNhbGxiYWNrICYmIHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgY2FsbGJhY2sgPSB0aGlzOwogICAgICBpZiAob2JqKSAobGlzdGVuaW5nVG8gPSB7fSlbb2JqLl9saXN0ZW5JZF0gPSBvYmo7CiAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmluZ1RvKSB7CiAgICAgICAgb2JqID0gbGlzdGVuaW5nVG9baWRdOwogICAgICAgIG9iai5vZmYobmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICAgIGlmIChyZW1vdmUgfHwgXy5pc0VtcHR5KG9iai5fZXZlbnRzKSkgZGVsZXRlIHRoaXMuX2xpc3RlbmluZ1RvW2lkXTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgfTsKCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwoKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CgogICAgLy8gSGFuZGxlIGV2ZW50IG1hcHMuCiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEhhbmRsZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnQgbmFtZXMuCiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIEEgZGlmZmljdWx0LXRvLWJlbGlldmUsIGJ1dCBvcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yCiAgLy8gdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBpbnRlcm5hbAogIC8vIEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKGV2ZW50cywgYXJncykgewogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoLCBhMSA9IGFyZ3NbMF0sIGEyID0gYXJnc1sxXSwgYTMgPSBhcmdzWzJdOwogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgewogICAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsgcmV0dXJuOwogICAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSk7IHJldHVybjsKICAgICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyKTsgcmV0dXJuOwogICAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKTsgcmV0dXJuOwogICAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOwogICAgfQogIH07CgogIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgogIC8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCiAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogIC8vIGxpc3RlbmluZyB0by4KICBfLmVhY2gobGlzdGVuTWV0aG9kcywgZnVuY3Rpb24oaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CiAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgfQogICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IHRydWU7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgogICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7CiAgICB9LAoKICAgIC8vIENoZWNrIGlmIHRoZSBtb2RlbCBpcyBjdXJyZW50bHkgaW4gYSB2YWxpZCBzdGF0ZS4KICAgIGlzVmFsaWQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRlKHt9LCBfLmV4dGVuZChvcHRpb25zIHx8IHt9LCB7IHZhbGlkYXRlOiB0cnVlIH0pKTsKICAgIH0sCgogICAgLy8gUnVuIHZhbGlkYXRpb24gYWdhaW5zdCB0aGUgbmV4dCBjb21wbGV0ZSBzZXQgb2YgbW9kZWwgYXR0cmlidXRlcywKICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIE90aGVyd2lzZSwgZmlyZSBhbiBgImludmFsaWQiYCBldmVudC4KICAgIF92YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFvcHRpb25zLnZhbGlkYXRlIHx8ICF0aGlzLnZhbGlkYXRlKSByZXR1cm4gdHJ1ZTsKICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7CiAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGlvbkVycm9yID0gdGhpcy52YWxpZGF0ZShhdHRycywgb3B0aW9ucykgfHwgbnVsbDsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIGVycm9yLCBfLmV4dGVuZChvcHRpb25zLCB7dmFsaWRhdGlvbkVycm9yOiBlcnJvcn0pKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIE1vZGVsLgogIHZhciBtb2RlbE1ldGhvZHMgPSBbJ2tleXMnLCAndmFsdWVzJywgJ3BhaXJzJywgJ2ludmVydCcsICdwaWNrJywgJ29taXQnXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgTW9kZWwjYXR0cmlidXRlc2AuCiAgXy5lYWNoKG1vZGVsTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBNb2RlbC5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMuYXR0cmlidXRlcyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBJZiBtb2RlbHMgdGVuZCB0byByZXByZXNlbnQgYSBzaW5nbGUgcm93IG9mIGRhdGEsIGEgQmFja2JvbmUgQ29sbGVjdGlvbiBpcwogIC8vIG1vcmUgYW5hbGFnb3VzIHRvIGEgdGFibGUgZnVsbCBvZiBkYXRhIC4uLiBvciBhIHNtYWxsIHNsaWNlIG9yIHBhZ2Ugb2YgdGhhdAogIC8vIHRhYmxlLCBvciBhIGNvbGxlY3Rpb24gb2Ygcm93cyB0aGF0IGJlbG9uZyB0b2dldGhlciBmb3IgYSBwYXJ0aWN1bGFyIHJlYXNvbgogIC8vIC0tIGFsbCBvZiB0aGUgbWVzc2FnZXMgaW4gdGhpcyBwYXJ0aWN1bGFyIGZvbGRlciwgYWxsIG9mIHRoZSBkb2N1bWVudHMKICAvLyBiZWxvbmdpbmcgdG8gdGhpcyBwYXJ0aWN1bGFyIGF1dGhvciwgYW5kIHNvIG9uLiBDb2xsZWN0aW9ucyBtYWludGFpbgogIC8vIGluZGV4ZXMgb2YgdGhlaXIgbW9kZWxzLCBib3RoIGluIG9yZGVyLCBhbmQgZm9yIGxvb2t1cCBieSBgaWRgLgoKICAvLyBDcmVhdGUgYSBuZXcgKipDb2xsZWN0aW9uKiosIHBlcmhhcHMgdG8gY29udGFpbiBhIHNwZWNpZmljIHR5cGUgb2YgYG1vZGVsYC4KICAvLyBJZiBhIGBjb21wYXJhdG9yYCBpcyBzcGVjaWZpZWQsIHRoZSBDb2xsZWN0aW9uIHdpbGwgbWFpbnRhaW4KICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuCiAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMubW9kZWwpIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOwogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICB9OwoKICAvLyBEZWZhdWx0IG9wdGlvbnMgZm9yIGBDb2xsZWN0aW9uI3NldGAuCiAgdmFyIHNldE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IHRydWUsIG1lcmdlOiB0cnVlfTsKICB2YXIgYWRkT3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogZmFsc2V9OwoKICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLgogIF8uZXh0ZW5kKENvbGxlY3Rpb24ucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouCiAgICAvLyBUaGlzIHNob3VsZCBiZSBvdmVycmlkZGVuIGluIG1vc3QgY2FzZXMuCiAgICBtb2RlbDogTW9kZWwsCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlCiAgICAvLyBtb2RlbHMnIGF0dHJpYnV0ZXMuCiAgICB0b0pTT046IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsLCBvciBsaXN0IG9mIG1vZGVscyB0byB0aGUgc2V0LgogICAgYWRkOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KG1vZGVscywgXy5leHRlbmQoe21lcmdlOiBmYWxzZX0sIG9wdGlvbnMsIGFkZE9wdGlvbnMpKTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwsIG9yIGEgbGlzdCBvZiBtb2RlbHMgZnJvbSB0aGUgc2V0LgogICAgcmVtb3ZlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IFttb2RlbHNdIDogXy5jbG9uZShtb2RlbHMpOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5nZXQobW9kZWxzW2ldKTsKICAgICAgICBpZiAoIW1vZGVsKSBjb250aW51ZTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSBhIGNvbGxlY3Rpb24gYnkgYHNldGAtaW5nIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCBhZGRpbmcgbmV3IG9uZXMsCiAgICAvLyByZW1vdmluZyBtb2RlbHMgdGhhdCBhcmUgbm8gbG9uZ2VyIHByZXNlbnQsIGFuZCBtZXJnaW5nIG1vZGVscyB0aGF0CiAgICAvLyBhbHJlYWR5IGV4aXN0IGluIHRoZSBjb2xsZWN0aW9uLCBhcyBuZWNlc3NhcnkuIFNpbWlsYXIgdG8gKipNb2RlbCNzZXQqKiwKICAgIC8vIHRoZSBjb3JlIG9wZXJhdGlvbiBmb3IgdXBkYXRpbmcgdGhlIGRhdGEgY29udGFpbmVkIGJ5IHRoZSBjb2xsZWN0aW9uLgogICAgc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldE9wdGlvbnMpOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMsIG9wdGlvbnMpOwogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gKG1vZGVscyA/IFttb2RlbHNdIDogW10pIDogXy5jbG9uZShtb2RlbHMpOwogICAgICB2YXIgaSwgbCwgaWQsIG1vZGVsLCBhdHRycywgZXhpc3RpbmcsIHNvcnQ7CiAgICAgIHZhciBhdCA9IG9wdGlvbnMuYXQ7CiAgICAgIHZhciB0YXJnZXRNb2RlbCA9IHRoaXMubW9kZWw7CiAgICAgIHZhciBzb3J0YWJsZSA9IHRoaXMuY29tcGFyYXRvciAmJiAoYXQgPT0gbnVsbCkgJiYgb3B0aW9ucy5zb3J0ICE9PSBmYWxzZTsKICAgICAgdmFyIHNvcnRBdHRyID0gXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpID8gdGhpcy5jb21wYXJhdG9yIDogbnVsbDsKICAgICAgdmFyIHRvQWRkID0gW10sIHRvUmVtb3ZlID0gW10sIG1vZGVsTWFwID0ge307CiAgICAgIHZhciBhZGQgPSBvcHRpb25zLmFkZCwgbWVyZ2UgPSBvcHRpb25zLm1lcmdlLCByZW1vdmUgPSBvcHRpb25zLnJlbW92ZTsKICAgICAgdmFyIG9yZGVyID0gIXNvcnRhYmxlICYmIGFkZCAmJiByZW1vdmUgPyBbXSA6IGZhbHNlOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGF0dHJzID0gbW9kZWxzW2ldOwogICAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSB7CiAgICAgICAgICBpZCA9IG1vZGVsID0gYXR0cnM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlkID0gYXR0cnNbdGFyZ2V0TW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlXTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgaWYgKG1lcmdlKSB7CiAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gYWRkZWQgbW9kZWxzJyBldmVudHMsIGFuZCBpbmRleCBtb2RlbHMgZm9yIGxvb2t1cCBieQogICAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuCiAgICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgICAgfQogICAgICAgIGlmIChvcmRlcikgb3JkZXIucHVzaChleGlzdGluZyB8fCBtb2RlbCk7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgCiAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWRdIHx8IHRoaXMuX2J5SWRbb2JqLmNpZF0gfHwgdGhpcy5fYnlJZFtvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCgogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAvLyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICAgIHJldHVybiBhdHRyczsKICAgICAgfQogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbmV3IHRoaXMubW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsLnZhbGlkYXRpb25FcnJvcikgcmV0dXJuIG1vZGVsOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBtb2RlbC52YWxpZGF0aW9uRXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbiddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuCiAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgYXJncy51bnNoaWZ0KHRoaXMubW9kZWxzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50LgogIHZhciBhdHRyaWJ1dGVNZXRob2RzID0gWydncm91cEJ5JywgJ2NvdW50QnknLCAnc29ydEJ5J107CgogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAogICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgdmFyIHhociA9IG9wdGlvbnMueGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgdmFyIG5vWGhyUGF0Y2ggPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiAhIXdpbmRvdy5BY3RpdmVYT2JqZWN0ICYmICEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmIChuZXcgWE1MSHR0cFJlcXVlc3QpLmRpc3BhdGNoRXZlbnQpOwoKICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4KICB2YXIgbWV0aG9kTWFwID0gewogICAgJ2NyZWF0ZSc6ICdQT1NUJywKICAgICd1cGRhdGUnOiAnUFVUJywKICAgICdwYXRjaCc6ICAnUEFUQ0gnLAogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLAogICAgJ3JlYWQnOiAgICdHRVQnCiAgfTsKCiAgLy8gU2V0IHRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIG9mIGBCYWNrYm9uZS5hamF4YCB0byBwcm94eSB0aHJvdWdoIHRvIGAkYC4KICAvLyBPdmVycmlkZSB0aGlzIGlmIHlvdSdkIGxpa2UgdG8gdXNlIGEgZGlmZmVyZW50IGxpYnJhcnkuCiAgQmFja2JvbmUuYWpheCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC8oXChcPyk/Olx3Ky9nOwogIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7CiAgdmFyIGVzY2FwZVJlZ0V4cCAgPSAvW1wte31cW1xdKz8uLFxcXF4kfCNcc10vZzsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoUm91dGVyLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyBNYW51YWxseSBiaW5kIGEgc2luZ2xlIG5hbWVkIHJvdXRlIHRvIGEgY2FsbGJhY2suIEZvciBleGFtcGxlOgogICAgLy8KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsKICAgIC8vICAgICAgIC4uLgogICAgLy8gICAgIH0pOwogICAgLy8KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICAgIGNhbGxiYWNrID0gbmFtZTsKICAgICAgICBuYW1lID0gJyc7CiAgICAgIH0KICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgICB2YXIgcm91dGVyID0gdGhpczsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgICB2YXIgYXJncyA9IHJvdXRlci5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseShyb3V0ZXIsIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAoKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXlwvXSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgZGVjb2RlZCBwYXJhbWV0ZXJzLiBFbXB0eSBvciB1bm1hdGNoZWQgcGFyYW1ldGVycyB3aWxsIGJlCiAgICAvLyB0cmVhdGVkIGFzIGBudWxsYCB0byBub3JtYWxpemUgY3Jvc3MtYnJvd3NlciBiZWhhdmlvci4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHZhciBwYXJhbXMgPSByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgICAgcmV0dXJuIF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsKICAgICAgICByZXR1cm4gcGFyYW0gPyBkZWNvZGVVUklDb21wb25lbnQocGFyYW0pIDogbnVsbDsKICAgICAgfSk7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5IaXN0b3J5CiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBlaXRoZXIKICAvLyBbcHVzaFN0YXRlXShodHRwOi8vZGl2ZWludG9odG1sNS5pbmZvL2hpc3RvcnkuaHRtbCkgYW5kIHJlYWwgVVJMcywgb3IKICAvLyBbb25oYXNoY2hhbmdlXShodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS93aW5kb3cub25oYXNoY2hhbmdlKQogIC8vIGFuZCBVUkwgZnJhZ21lbnRzLiBJZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBuZWl0aGVyIChvbGQgSUUsIG5hdGNoKSwKICAvLyBmYWxscyBiYWNrIHRvIHBvbGxpbmcuCiAgdmFyIEhpc3RvcnkgPSBCYWNrYm9uZS5IaXN0b3J5ID0gZnVuY3Rpb24oKSB7CiAgICB0aGlzLmhhbmRsZXJzID0gW107CiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7CgogICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgdGhpcy5sb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CiAgICB9CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLgogIHZhciByb3V0ZVN0cmlwcGVyID0gL15bI1wvXXxccyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuCiAgdmFyIHJvb3RTdHJpcHBlciA9IC9eXC8rfFwvKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4KICB2YXIgaXNFeHBsb3JlciA9IC9tc2llIFtcdy5dKy87CgogIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4KICB2YXIgdHJhaWxpbmdTbGFzaCA9IC9cLyQvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyB1cmxzIG9mIGhhc2ggYW5kIHF1ZXJ5LgogIHZhciBwYXRoU3RyaXBwZXIgPSAvWz8jXS4qJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuaWZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIiAvPicpLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7CiAgICAgIH0KCiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyCiAgICAgIC8vICdvbmhhc2hjaGFuZ2UnIGlzIHN1cHBvcnRlZCwgZGV0ZXJtaW5lIGhvdyB3ZSBjaGVjayB0aGUgVVJMIHN0YXRlLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50OwogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsKICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsKCiAgICAgIC8vIFRyYW5zaXRpb24gZnJvbSBoYXNoQ2hhbmdlIHRvIHB1c2hTdGF0ZSBvciB2aWNlIHZlcnNhIGlmIGJvdGggYXJlCiAgICAgIC8vIHJlcXVlc3RlZC4KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSkgewoKICAgICAgICAvLyBJZiB3ZSd2ZSBzdGFydGVkIG9mZiB3aXRoIGEgcm91dGUgZnJvbSBhIGBwdXNoU3RhdGVgLWVuYWJsZWQKICAgICAgICAvLyBicm93c2VyLCBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLgogICAgICAgIGlmICghdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7CiAgICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgICB0aGlzLmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgdGhpcy5yb290ICsgdGhpcy5mcmFnbWVudCArIGxvYy5zZWFyY2gpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwogICAgfSwKCiAgICAvLyBBZGQgYSByb3V0ZSB0byBiZSB0ZXN0ZWQgd2hlbiB0aGUgZnJhZ21lbnQgY2hhbmdlcy4gUm91dGVzIGFkZGVkIGxhdGVyCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLgogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgewogICAgICB0aGlzLmhhbmRsZXJzLnVuc2hpZnQoe3JvdXRlOiByb3V0ZSwgY2FsbGJhY2s6IGNhbGxiYWNrfSk7CiAgICB9LAoKICAgIC8vIENoZWNrcyB0aGUgY3VycmVudCBVUkwgdG8gc2VlIGlmIGl0IGhhcyBjaGFuZ2VkLCBhbmQgaWYgaXQgaGFzLAogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgewogICAgICB2YXIgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoKTsKICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsKICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsKICAgICAgfQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7CiAgICAgIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQogICAgLy8gbWF0Y2gsIHJldHVybnMgYHRydWVgLiBJZiBubyBkZWZpbmVkIHJvdXRlcyBtYXRjaGVzIHRoZSBmcmFnbWVudCwKICAgIC8vIHJldHVybnMgYGZhbHNlYC4KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgIGZyYWdtZW50ID0gdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQpOwogICAgICByZXR1cm4gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7CiAgICAgICAgICBoYW5kbGVyLmNhbGxiYWNrKGZyYWdtZW50KTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUKICAgIC8vICdyZXBsYWNlJyBvcHRpb24gaXMgcGFzc2VkLiBZb3UgYXJlIHJlc3BvbnNpYmxlIGZvciBwcm9wZXJseSBVUkwtZW5jb2RpbmcKICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLgogICAgLy8KICAgIC8vIFRoZSBvcHRpb25zIG9iamVjdCBjYW4gY29udGFpbiBgdHJpZ2dlcjogdHJ1ZWAgaWYgeW91IHdpc2ggdG8gaGF2ZSB0aGUKICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6ICEhb3B0aW9uc307CgogICAgICB2YXIgdXJsID0gdGhpcy5yb290ICsgKGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJykpOwoKICAgICAgLy8gU3RyaXAgdGhlIGZyYWdtZW50IG9mIHRoZSBxdWVyeSBhbmQgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CiAgfTsKCn0pLmNhbGwodGhpcyk7Cgp9LHsidW5kZXJzY29yZSI6MTZ9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vICAgICBVbmRlcnNjb3JlLmpzIDEuNy4wCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGV4cG9ydHNgIG9uIHRoZSBzZXJ2ZXIuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYF9gIHZhcmlhYmxlLgogIHZhciBwcmV2aW91c1VuZGVyc2NvcmUgPSByb290Ll87CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIKICAgIHB1c2ggICAgICAgICAgICAgPSBBcnJheVByb3RvLnB1c2gsCiAgICBzbGljZSAgICAgICAgICAgID0gQXJyYXlQcm90by5zbGljZSwKICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgIHRvU3RyaW5nICAgICAgICAgPSBPYmpQcm90by50b1N0cmluZywKICAgIGhhc093blByb3BlcnR5ICAgPSBPYmpQcm90by5oYXNPd25Qcm9wZXJ0eTsKCiAgLy8gQWxsICoqRUNNQVNjcmlwdCA1KiogbmF0aXZlIGZ1bmN0aW9uIGltcGxlbWVudGF0aW9ucyB0aGF0IHdlIGhvcGUgdG8gdXNlCiAgLy8gYXJlIGRlY2xhcmVkIGhlcmUuCiAgdmFyCiAgICBuYXRpdmVJc0FycmF5ICAgICAgPSBBcnJheS5pc0FycmF5LAogICAgbmF0aXZlS2V5cyAgICAgICAgID0gT2JqZWN0LmtleXMsCiAgICBuYXRpdmVCaW5kICAgICAgICAgPSBGdW5jUHJvdG8uYmluZDsKCiAgLy8gQ3JlYXRlIGEgc2FmZSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0IGZvciB1c2UgYmVsb3cuCiAgdmFyIF8gPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBfKSByZXR1cm4gb2JqOwogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIF8pKSByZXR1cm4gbmV3IF8ob2JqKTsKICAgIHRoaXMuX3dyYXBwZWQgPSBvYmo7CiAgfTsKCiAgLy8gRXhwb3J0IHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgKipOb2RlLmpzKiosIHdpdGgKICAvLyBiYWNrd2FyZHMtY29tcGF0aWJpbGl0eSBmb3IgdGhlIG9sZCBgcmVxdWlyZSgpYCBBUEkuIElmIHdlJ3JlIGluCiAgLy8gdGhlIGJyb3dzZXIsIGFkZCBgX2AgYXMgYSBnbG9iYWwgb2JqZWN0LgogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgewogICAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBfOwogICAgfQogICAgZXhwb3J0cy5fID0gXzsKICB9IGVsc2UgewogICAgcm9vdC5fID0gXzsKICB9CgogIC8vIEN1cnJlbnQgdmVyc2lvbi4KICBfLlZFUlNJT04gPSAnMS43LjAnOwoKICAvLyBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gZWZmaWNpZW50IChmb3IgY3VycmVudCBlbmdpbmVzKSB2ZXJzaW9uCiAgLy8gb2YgdGhlIHBhc3NlZC1pbiBjYWxsYmFjaywgdG8gYmUgcmVwZWF0ZWRseSBhcHBsaWVkIGluIG90aGVyIFVuZGVyc2NvcmUKICAvLyBmdW5jdGlvbnMuCiAgdmFyIGNyZWF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCwgYXJnQ291bnQpIHsKICAgIGlmIChjb250ZXh0ID09PSB2b2lkIDApIHJldHVybiBmdW5jOwogICAgc3dpdGNoIChhcmdDb3VudCA9PSBudWxsID8gMyA6IGFyZ0NvdW50KSB7CiAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSk7CiAgICAgIH07CiAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBvdGhlcikgewogICAgICAgIHJldHVybiBmdW5jLmNhbGwoY29udGV4dCwgdmFsdWUsIG90aGVyKTsKICAgICAgfTsKICAgICAgY2FzZSAzOiByZXR1cm4gZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9OwogICAgICBjYXNlIDQ6IHJldHVybiBmdW5jdGlvbihhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgIH07CiAgfTsKCiAgLy8gQSBtb3N0bHktaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgY2FsbGJhY2tzIHRoYXQgY2FuIGJlIGFwcGxpZWQKICAvLyB0byBlYWNoIGVsZW1lbnQgaW4gYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgdGhlIGRlc2lyZWQgcmVzdWx0IOKAlCBlaXRoZXIKICAvLyBpZGVudGl0eSwgYW4gYXJiaXRyYXJ5IGNhbGxiYWNrLCBhIHByb3BlcnR5IG1hdGNoZXIsIG9yIGEgcHJvcGVydHkgYWNjZXNzb3IuCiAgXy5pdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0LCBhcmdDb3VudCkgewogICAgaWYgKHZhbHVlID09IG51bGwpIHJldHVybiBfLmlkZW50aXR5OwogICAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHJldHVybiBjcmVhdGVDYWxsYmFjayh2YWx1ZSwgY29udGV4dCwgYXJnQ291bnQpOwogICAgaWYgKF8uaXNPYmplY3QodmFsdWUpKSByZXR1cm4gXy5tYXRjaGVzKHZhbHVlKTsKICAgIHJldHVybiBfLnByb3BlcnR5KHZhbHVlKTsKICB9OwoKICAvLyBDb2xsZWN0aW9uIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIFRoZSBjb3JuZXJzdG9uZSwgYW4gYGVhY2hgIGltcGxlbWVudGF0aW9uLCBha2EgYGZvckVhY2hgLgogIC8vIEhhbmRsZXMgcmF3IG9iamVjdHMgaW4gYWRkaXRpb24gdG8gYXJyYXktbGlrZXMuIFRyZWF0cyBhbGwKICAvLyBzcGFyc2UgYXJyYXktbGlrZXMgYXMgaWYgdGhleSB3ZXJlIGRlbnNlLgogIF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIG9iajsKICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgdmFyIGksIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoID09PSArbGVuZ3RoKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGl0ZXJhdGVlKG9ialtpXSwgaSwgb2JqKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgICAgZm9yIChpID0gMCwgbGVuZ3RoID0ga2V5cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGl0ZXJhdGVlKG9ialtrZXlzW2ldXSwga2V5c1tpXSwgb2JqKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdGVlIHRvIGVhY2ggZWxlbWVudC4KICBfLm1hcCA9IF8uY29sbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCiAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgcmVzdWx0cyA9IEFycmF5KGxlbmd0aCksCiAgICAgICAgY3VycmVudEtleTsKICAgIGZvciAodmFyIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICByZXN1bHRzW2luZGV4XSA9IGl0ZXJhdGVlKG9ialtjdXJyZW50S2V5XSwgY3VycmVudEtleSwgb2JqKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIHZhciByZWR1Y2VFcnJvciA9ICdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJzsKCiAgLy8gKipSZWR1Y2UqKiBidWlsZHMgdXAgYSBzaW5nbGUgcmVzdWx0IGZyb20gYSBsaXN0IG9mIHZhbHVlcywgYWthIGBpbmplY3RgLAogIC8vIG9yIGBmb2xkbGAuCiAgXy5yZWR1Y2UgPSBfLmZvbGRsID0gXy5pbmplY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBtZW1vLCBjb250ZXh0KSB7CiAgICBpZiAob2JqID09IG51bGwpIG9iaiA9IFtdOwogICAgaXRlcmF0ZWUgPSBjcmVhdGVDYWxsYmFjayhpdGVyYXRlZSwgY29udGV4dCwgNCk7CiAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAogICAgICAgIGluZGV4ID0gMCwgY3VycmVudEtleTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICBpZiAoIWxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcihyZWR1Y2VFcnJvcik7CiAgICAgIG1lbW8gPSBvYmpba2V5cyA/IGtleXNbaW5kZXgrK10gOiBpbmRleCsrXTsKICAgIH0KICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBjdXJyZW50S2V5ID0ga2V5cyA/IGtleXNbaW5kZXhdIDogaW5kZXg7CiAgICAgIG1lbW8gPSBpdGVyYXRlZShtZW1vLCBvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaik7CiAgICB9CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBUaGUgcmlnaHQtYXNzb2NpYXRpdmUgdmVyc2lvbiBvZiByZWR1Y2UsIGFsc28ga25vd24gYXMgYGZvbGRyYC4KICBfLnJlZHVjZVJpZ2h0ID0gXy5mb2xkciA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIG1lbW8sIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCA0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gKyBvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGluZGV4ID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgY3VycmVudEtleTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICBpZiAoIWluZGV4KSB0aHJvdyBuZXcgVHlwZUVycm9yKHJlZHVjZUVycm9yKTsKICAgICAgbWVtbyA9IG9ialtrZXlzID8ga2V5c1stLWluZGV4XSA6IC0taW5kZXhdOwogICAgfQogICAgd2hpbGUgKGluZGV4LS0pIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICBtZW1vID0gaXRlcmF0ZWUobWVtbywgb2JqW2N1cnJlbnRLZXldLCBjdXJyZW50S2V5LCBvYmopOwogICAgfQogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBmaXJzdCB2YWx1ZSB3aGljaCBwYXNzZXMgYSB0cnV0aCB0ZXN0LiBBbGlhc2VkIGFzIGBkZXRlY3RgLgogIF8uZmluZCA9IF8uZGV0ZWN0ID0gZnVuY3Rpb24ob2JqLCBwcmVkaWNhdGUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQ7CiAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICBfLnNvbWUob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHByZWRpY2F0ZSh2YWx1ZSwgaW5kZXgsIGxpc3QpKSB7CiAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gYWxsIHRoZSBlbGVtZW50cyB0aGF0IHBhc3MgYSB0cnV0aCB0ZXN0LgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgcHJlZGljYXRlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAocHJlZGljYXRlKHZhbHVlLCBpbmRleCwgbGlzdCkpIHJlc3VsdHMucHVzaCh2YWx1ZSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIGZvciB3aGljaCBhIHRydXRoIHRlc3QgZmFpbHMuCiAgXy5yZWplY3QgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcmV0dXJuIF8uZmlsdGVyKG9iaiwgXy5uZWdhdGUoXy5pdGVyYXRlZShwcmVkaWNhdGUpKSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIHByZWRpY2F0ZSA9IF8uaXRlcmF0ZWUocHJlZGljYXRlLCBjb250ZXh0KTsKICAgIHZhciBrZXlzID0gb2JqLmxlbmd0aCAhPT0gK29iai5sZW5ndGggJiYgXy5rZXlzKG9iaiksCiAgICAgICAgbGVuZ3RoID0gKGtleXMgfHwgb2JqKS5sZW5ndGgsCiAgICAgICAgaW5kZXgsIGN1cnJlbnRLZXk7CiAgICBmb3IgKGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgY3VycmVudEtleSA9IGtleXMgPyBrZXlzW2luZGV4XSA6IGluZGV4OwogICAgICBpZiAoIXByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH07CgogIC8vIERldGVybWluZSBpZiBhdCBsZWFzdCBvbmUgZWxlbWVudCBpbiB0aGUgb2JqZWN0IG1hdGNoZXMgYSB0cnV0aCB0ZXN0LgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgXy5zb21lID0gXy5hbnkgPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgICBwcmVkaWNhdGUgPSBfLml0ZXJhdGVlKHByZWRpY2F0ZSwgY29udGV4dCk7CiAgICB2YXIga2V5cyA9IG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoICYmIF8ua2V5cyhvYmopLAogICAgICAgIGxlbmd0aCA9IChrZXlzIHx8IG9iaikubGVuZ3RoLAogICAgICAgIGluZGV4LCBjdXJyZW50S2V5OwogICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGN1cnJlbnRLZXkgPSBrZXlzID8ga2V5c1tpbmRleF0gOiBpbmRleDsKICAgICAgaWYgKHByZWRpY2F0ZShvYmpbY3VycmVudEtleV0sIGN1cnJlbnRLZXksIG9iaikpIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07CgogIC8vIERldGVybWluZSBpZiB0aGUgYXJyYXkgb3Igb2JqZWN0IGNvbnRhaW5zIGEgZ2l2ZW4gdmFsdWUgKHVzaW5nIGA9PT1gKS4KICAvLyBBbGlhc2VkIGFzIGBpbmNsdWRlYC4KICBfLmNvbnRhaW5zID0gXy5pbmNsdWRlID0gZnVuY3Rpb24ob2JqLCB0YXJnZXQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwogICAgcmV0dXJuIF8uaW5kZXhPZihvYmosIHRhcmdldCkgPj0gMDsKICB9OwoKICAvLyBJbnZva2UgYSBtZXRob2QgKHdpdGggYXJndW1lbnRzKSBvbiBldmVyeSBpdGVtIGluIGEgY29sbGVjdGlvbi4KICBfLmludm9rZSA9IGZ1bmN0aW9uKG9iaiwgbWV0aG9kKSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHZhciBpc0Z1bmMgPSBfLmlzRnVuY3Rpb24obWV0aG9kKTsKICAgIHJldHVybiBfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiAoaXNGdW5jID8gbWV0aG9kIDogdmFsdWVbbWV0aG9kXSkuYXBwbHkodmFsdWUsIGFyZ3MpOwogICAgfSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgbWFwYDogZmV0Y2hpbmcgYSBwcm9wZXJ0eS4KICBfLnBsdWNrID0gZnVuY3Rpb24ob2JqLCBrZXkpIHsKICAgIHJldHVybiBfLm1hcChvYmosIF8ucHJvcGVydHkoa2V5KSk7CiAgfTsKCiAgLy8gQ29udmVuaWVuY2UgdmVyc2lvbiBvZiBhIGNvbW1vbiB1c2UgY2FzZSBvZiBgZmlsdGVyYDogc2VsZWN0aW5nIG9ubHkgb2JqZWN0cwogIC8vIGNvbnRhaW5pbmcgc3BlY2lmaWMgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy53aGVyZSA9IGZ1bmN0aW9uKG9iaiwgYXR0cnMpIHsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYGZpbmRgOiBnZXR0aW5nIHRoZSBmaXJzdCBvYmplY3QKICAvLyBjb250YWluaW5nIHNwZWNpZmljIGBrZXk6dmFsdWVgIHBhaXJzLgogIF8uZmluZFdoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgcmV0dXJuIF8uZmluZChvYmosIF8ubWF0Y2hlcyhhdHRycykpOwogIH07CgogIC8vIFJldHVybiB0aGUgbWF4aW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1heCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQgPSAtSW5maW5pdHksIGxhc3RDb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICB2YWx1ZSwgY29tcHV0ZWQ7CiAgICBpZiAoaXRlcmF0ZWUgPT0gbnVsbCAmJiBvYmogIT0gbnVsbCkgewogICAgICBvYmogPSBvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCA/IG9iaiA6IF8udmFsdWVzKG9iaik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBvYmoubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICB2YWx1ZSA9IG9ialtpXTsKICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgY29tcHV0ZWQgPSBpdGVyYXRlZSh2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICAgIGlmIChjb21wdXRlZCA+IGxhc3RDb21wdXRlZCB8fCBjb21wdXRlZCA9PT0gLUluZmluaXR5ICYmIHJlc3VsdCA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIGxhc3RDb21wdXRlZCA9IGNvbXB1dGVkOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiB0aGUgbWluaW11bSBlbGVtZW50IChvciBlbGVtZW50LWJhc2VkIGNvbXB1dGF0aW9uKS4KICBfLm1pbiA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHQgPSBJbmZpbml0eSwgbGFzdENvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgdmFsdWUsIGNvbXB1dGVkOwogICAgaWYgKGl0ZXJhdGVlID09IG51bGwgJiYgb2JqICE9IG51bGwpIHsKICAgICAgb2JqID0gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmogOiBfLnZhbHVlcyhvYmopOwogICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gb2JqLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWUgPSBvYmpbaV07CiAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CiAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CiAgICAgIF8uZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICAgIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGluZGV4LCBsaXN0KTsKICAgICAgICBpZiAoY29tcHV0ZWQgPCBsYXN0Q29tcHV0ZWQgfHwgY29tcHV0ZWQgPT09IEluZmluaXR5ICYmIHJlc3VsdCA9PT0gSW5maW5pdHkpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgbGFzdENvbXB1dGVkID0gY29tcHV0ZWQ7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhIGNvbGxlY3Rpb24sIHVzaW5nIHRoZSBtb2Rlcm4gdmVyc2lvbiBvZiB0aGUKICAvLyBbRmlzaGVyLVlhdGVzIHNodWZmbGVdKGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVy4oCTWWF0ZXNfc2h1ZmZsZSkuCiAgXy5zaHVmZmxlID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgc2V0ID0gb2JqICYmIG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoID8gb2JqIDogXy52YWx1ZXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBzZXQubGVuZ3RoOwogICAgdmFyIHNodWZmbGVkID0gQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGluZGV4ID0gMCwgcmFuZDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgcmFuZCA9IF8ucmFuZG9tKDAsIGluZGV4KTsKICAgICAgaWYgKHJhbmQgIT09IGluZGV4KSBzaHVmZmxlZFtpbmRleF0gPSBzaHVmZmxlZFtyYW5kXTsKICAgICAgc2h1ZmZsZWRbcmFuZF0gPSBzZXRbaW5kZXhdOwogICAgfQogICAgcmV0dXJuIHNodWZmbGVkOwogIH07CgogIC8vIFNhbXBsZSAqKm4qKiByYW5kb20gdmFsdWVzIGZyb20gYSBjb2xsZWN0aW9uLgogIC8vIElmICoqbioqIGlzIG5vdCBzcGVjaWZpZWQsIHJldHVybnMgYSBzaW5nbGUgcmFuZG9tIGVsZW1lbnQuCiAgLy8gVGhlIGludGVybmFsIGBndWFyZGAgYXJndW1lbnQgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgbWFwYC4KICBfLnNhbXBsZSA9IGZ1bmN0aW9uKG9iaiwgbiwgZ3VhcmQpIHsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHsKICAgICAgaWYgKG9iai5sZW5ndGggIT09ICtvYmoubGVuZ3RoKSBvYmogPSBfLnZhbHVlcyhvYmopOwogICAgICByZXR1cm4gb2JqW18ucmFuZG9tKG9iai5sZW5ndGggLSAxKV07CiAgICB9CiAgICByZXR1cm4gXy5zaHVmZmxlKG9iaikuc2xpY2UoMCwgTWF0aC5tYXgoMCwgbikpOwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRlZS4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0ZWUsIGNvbnRleHQpIHsKICAgIGl0ZXJhdGVlID0gXy5pdGVyYXRlZShpdGVyYXRlZSwgY29udGV4dCk7CiAgICByZXR1cm4gXy5wbHVjayhfLm1hcChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBpbmRleDogaW5kZXgsCiAgICAgICAgY3JpdGVyaWE6IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgbGlzdCkKICAgICAgfTsKICAgIH0pLnNvcnQoZnVuY3Rpb24obGVmdCwgcmlnaHQpIHsKICAgICAgdmFyIGEgPSBsZWZ0LmNyaXRlcmlhOwogICAgICB2YXIgYiA9IHJpZ2h0LmNyaXRlcmlhOwogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGlmIChhID4gYiB8fCBhID09PSB2b2lkIDApIHJldHVybiAxOwogICAgICAgIGlmIChhIDwgYiB8fCBiID09PSB2b2lkIDApIHJldHVybiAtMTsKICAgICAgfQogICAgICByZXR1cm4gbGVmdC5pbmRleCAtIHJpZ2h0LmluZGV4OwogICAgfSksICd2YWx1ZScpOwogIH07CgogIC8vIEFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgZm9yIGFnZ3JlZ2F0ZSAiZ3JvdXAgYnkiIG9wZXJhdGlvbnMuCiAgdmFyIGdyb3VwID0gZnVuY3Rpb24oYmVoYXZpb3IpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgaXRlcmF0ZWUgPSBfLml0ZXJhdGVlKGl0ZXJhdGVlLCBjb250ZXh0KTsKICAgICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgICAgdmFyIGtleSA9IGl0ZXJhdGVlKHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgICBiZWhhdmlvcihyZXN1bHQsIHZhbHVlLCBrZXkpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gR3JvdXBzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24uIFBhc3MgZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZQogIC8vIHRvIGdyb3VwIGJ5LCBvciBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUgY3JpdGVyaW9uLgogIF8uZ3JvdXBCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0ucHVzaCh2YWx1ZSk7IGVsc2UgcmVzdWx0W2tleV0gPSBbdmFsdWVdOwogIH0pOwoKICAvLyBJbmRleGVzIHRoZSBvYmplY3QncyB2YWx1ZXMgYnkgYSBjcml0ZXJpb24sIHNpbWlsYXIgdG8gYGdyb3VwQnlgLCBidXQgZm9yCiAgLy8gd2hlbiB5b3Uga25vdyB0aGF0IHlvdXIgaW5kZXggdmFsdWVzIHdpbGwgYmUgdW5pcXVlLgogIF8uaW5kZXhCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICB9KTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGdyb3VwKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgaWYgKF8uaGFzKHJlc3VsdCwga2V5KSkgcmVzdWx0W2tleV0rKzsgZWxzZSByZXN1bHRba2V5XSA9IDE7CiAgfSk7CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQsIDEpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0ZWUob2JqKTsKICAgIHZhciBsb3cgPSAwLCBoaWdoID0gYXJyYXkubGVuZ3RoOwogICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgdmFyIG1pZCA9IGxvdyArIGhpZ2ggPj4+IDE7CiAgICAgIGlmIChpdGVyYXRlZShhcnJheVttaWRdKSA8IHZhbHVlKSBsb3cgPSBtaWQgKyAxOyBlbHNlIGhpZ2ggPSBtaWQ7CiAgICB9CiAgICByZXR1cm4gbG93OwogIH07CgogIC8vIFNhZmVseSBjcmVhdGUgYSByZWFsLCBsaXZlIGFycmF5IGZyb20gYW55dGhpbmcgaXRlcmFibGUuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKF8uaXNBcnJheShvYmopKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gXy5tYXAob2JqLCBfLmlkZW50aXR5KTsKICAgIHJldHVybiBfLnZhbHVlcyhvYmopOwogIH07CgogIC8vIFJldHVybiB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIGluIGFuIG9iamVjdC4KICBfLnNpemUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIDA7CiAgICByZXR1cm4gb2JqLmxlbmd0aCA9PT0gK29iai5sZW5ndGggPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIFNwbGl0IGEgY29sbGVjdGlvbiBpbnRvIHR3byBhcnJheXM6IG9uZSB3aG9zZSBlbGVtZW50cyBhbGwgc2F0aXNmeSB0aGUgZ2l2ZW4KICAvLyBwcmVkaWNhdGUsIGFuZCBvbmUgd2hvc2UgZWxlbWVudHMgYWxsIGRvIG5vdCBzYXRpc2Z5IHRoZSBwcmVkaWNhdGUuCiAgXy5wYXJ0aXRpb24gPSBmdW5jdGlvbihvYmosIHByZWRpY2F0ZSwgY29udGV4dCkgewogICAgcHJlZGljYXRlID0gXy5pdGVyYXRlZShwcmVkaWNhdGUsIGNvbnRleHQpOwogICAgdmFyIHBhc3MgPSBbXSwgZmFpbCA9IFtdOwogICAgXy5lYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqKSB7CiAgICAgIChwcmVkaWNhdGUodmFsdWUsIGtleSwgb2JqKSA/IHBhc3MgOiBmYWlsKS5wdXNoKHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIFtwYXNzLCBmYWlsXTsKICB9OwoKICAvLyBBcnJheSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gR2V0IHRoZSBmaXJzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBmaXJzdCBOCiAgLy8gdmFsdWVzIGluIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgaGVhZGAgYW5kIGB0YWtlYC4gVGhlICoqZ3VhcmQqKiBjaGVjawogIC8vIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmZpcnN0ID0gXy5oZWFkID0gXy50YWtlID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIGlmIChuID09IG51bGwgfHwgZ3VhcmQpIHJldHVybiBhcnJheVswXTsKICAgIGlmIChuIDwgMCkgcmV0dXJuIFtdOwogICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIDAsIG4pOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBNYXRoLm1heCgwLCBhcnJheS5sZW5ndGggLSAobiA9PSBudWxsIHx8IGd1YXJkID8gMSA6IG4pKSk7CiAgfTsKCiAgLy8gR2V0IHRoZSBsYXN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGxhc3QgTgogIC8vIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKiogY2hlY2sgYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8ubGFzdCA9IGZ1bmN0aW9uKGFycmF5LCBuLCBndWFyZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiB2b2lkIDA7CiAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSByZXR1cm4gYXJyYXlbYXJyYXkubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgTWF0aC5tYXgoYXJyYXkubGVuZ3RoIC0gbiwgMCkpOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGZpcnN0IGVudHJ5IG9mIHRoZSBhcnJheS4gQWxpYXNlZCBhcyBgdGFpbGAgYW5kIGBkcm9wYC4KICAvLyBFc3BlY2lhbGx5IHVzZWZ1bCBvbiB0aGUgYXJndW1lbnRzIG9iamVjdC4gUGFzc2luZyBhbiAqKm4qKiB3aWxsIHJldHVybgogIC8vIHRoZSByZXN0IE4gdmFsdWVzIGluIHRoZSBhcnJheS4gVGhlICoqZ3VhcmQqKgogIC8vIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLnJlc3QgPSBfLnRhaWwgPSBfLmRyb3AgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCBuID09IG51bGwgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIF8uaWRlbnRpdHkpOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCkgewogICAgaWYgKHNoYWxsb3cgJiYgXy5ldmVyeShpbnB1dCwgXy5pc0FycmF5KSkgewogICAgICByZXR1cm4gY29uY2F0LmFwcGx5KG91dHB1dCwgaW5wdXQpOwogICAgfQogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGlucHV0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlucHV0W2ldOwogICAgICBpZiAoIV8uaXNBcnJheSh2YWx1ZSkgJiYgIV8uaXNBcmd1bWVudHModmFsdWUpKSB7CiAgICAgICAgaWYgKCFzdHJpY3QpIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIGlmIChzaGFsbG93KSB7CiAgICAgICAgcHVzaC5hcHBseShvdXRwdXQsIHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBzdHJpY3QsIG91dHB1dCk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvdXRwdXQ7CiAgfTsKCiAgLy8gRmxhdHRlbiBvdXQgYW4gYXJyYXksIGVpdGhlciByZWN1cnNpdmVseSAoYnkgZGVmYXVsdCksIG9yIGp1c3Qgb25lIGxldmVsLgogIF8uZmxhdHRlbiA9IGZ1bmN0aW9uKGFycmF5LCBzaGFsbG93KSB7CiAgICByZXR1cm4gZmxhdHRlbihhcnJheSwgc2hhbGxvdywgZmFsc2UsIFtdKTsKICB9OwoKICAvLyBSZXR1cm4gYSB2ZXJzaW9uIG9mIHRoZSBhcnJheSB0aGF0IGRvZXMgbm90IGNvbnRhaW4gdGhlIHNwZWNpZmllZCB2YWx1ZShzKS4KICBfLndpdGhvdXQgPSBmdW5jdGlvbihhcnJheSkgewogICAgcmV0dXJuIF8uZGlmZmVyZW5jZShhcnJheSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9OwoKICAvLyBQcm9kdWNlIGEgZHVwbGljYXRlLWZyZWUgdmVyc2lvbiBvZiB0aGUgYXJyYXkuIElmIHRoZSBhcnJheSBoYXMgYWxyZWFkeQogIC8vIGJlZW4gc29ydGVkLCB5b3UgaGF2ZSB0aGUgb3B0aW9uIG9mIHVzaW5nIGEgZmFzdGVyIGFsZ29yaXRobS4KICAvLyBBbGlhc2VkIGFzIGB1bmlxdWVgLgogIF8udW5pcSA9IF8udW5pcXVlID0gZnVuY3Rpb24oYXJyYXksIGlzU29ydGVkLCBpdGVyYXRlZSwgY29udGV4dCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiBbXTsKICAgIGlmICghXy5pc0Jvb2xlYW4oaXNTb3J0ZWQpKSB7CiAgICAgIGNvbnRleHQgPSBpdGVyYXRlZTsKICAgICAgaXRlcmF0ZWUgPSBpc1NvcnRlZDsKICAgICAgaXNTb3J0ZWQgPSBmYWxzZTsKICAgIH0KICAgIGlmIChpdGVyYXRlZSAhPSBudWxsKSBpdGVyYXRlZSA9IF8uaXRlcmF0ZWUoaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBhcnJheS5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgdmFsdWUgPSBhcnJheVtpXTsKICAgICAgaWYgKGlzU29ydGVkKSB7CiAgICAgICAgaWYgKCFpIHx8IHNlZW4gIT09IHZhbHVlKSByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgc2VlbiA9IHZhbHVlOwogICAgICB9IGVsc2UgaWYgKGl0ZXJhdGVlKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0ZWUodmFsdWUsIGksIGFycmF5KTsKICAgICAgICBpZiAoXy5pbmRleE9mKHNlZW4sIGNvbXB1dGVkKSA8IDApIHsKICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKF8uaW5kZXhPZihyZXN1bHQsIHZhbHVlKSA8IDApIHsKICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUHJvZHVjZSBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSB1bmlvbjogZWFjaCBkaXN0aW5jdCBlbGVtZW50IGZyb20gYWxsIG9mCiAgLy8gdGhlIHBhc3NlZC1pbiBhcnJheXMuCiAgXy51bmlvbiA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8udW5pcShmbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgdHJ1ZSwgW10pKTsKICB9OwoKICAvLyBQcm9kdWNlIGFuIGFycmF5IHRoYXQgY29udGFpbnMgZXZlcnkgaXRlbSBzaGFyZWQgYmV0d2VlbiBhbGwgdGhlCiAgLy8gcGFzc2VkLWluIGFycmF5cy4KICBfLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgdmFyIHJlc3VsdCA9IFtdOwogICAgdmFyIGFyZ3NMZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFycmF5Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBpdGVtID0gYXJyYXlbaV07CiAgICAgIGlmIChfLmNvbnRhaW5zKHJlc3VsdCwgaXRlbSkpIGNvbnRpbnVlOwogICAgICBmb3IgKHZhciBqID0gMTsgaiA8IGFyZ3NMZW5ndGg7IGorKykgewogICAgICAgIGlmICghXy5jb250YWlucyhhcmd1bWVudHNbal0sIGl0ZW0pKSBicmVhazsKICAgICAgfQogICAgICBpZiAoaiA9PT0gYXJnc0xlbmd0aCkgcmVzdWx0LnB1c2goaXRlbSk7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGZsYXR0ZW4oc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLCB0cnVlLCB0cnVlLCBbXSk7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICFfLmNvbnRhaW5zKHJlc3QsIHZhbHVlKTsKICAgIH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIFtdOwogICAgdmFyIGxlbmd0aCA9IF8ubWF4KGFyZ3VtZW50cywgJ2xlbmd0aCcpLmxlbmd0aDsKICAgIHZhciByZXN1bHRzID0gQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJndW1lbnRzLCBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIGlmIChsaXN0ID09IG51bGwpIHJldHVybiB7fTsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh2YWx1ZXMpIHsKICAgICAgICByZXN1bHRbbGlzdFtpXV0gPSB2YWx1ZXNbaV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2xpc3RbaV1bMF1dID0gbGlzdFtpXVsxXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuIGl0ZW0gaW4gYW4gYXJyYXksCiAgLy8gb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBJZiB0aGUgYXJyYXkgaXMgbGFyZ2UgYW5kIGFscmVhZHkgaW4gc29ydCBvcmRlciwgcGFzcyBgdHJ1ZWAKICAvLyBmb3IgKippc1NvcnRlZCoqIHRvIHVzZSBiaW5hcnkgc2VhcmNoLgogIF8uaW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBpc1NvcnRlZCkgewogICAgaWYgKGFycmF5ID09IG51bGwpIHJldHVybiAtMTsKICAgIHZhciBpID0gMCwgbGVuZ3RoID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gaXNTb3J0ZWQgPCAwID8gTWF0aC5tYXgoMCwgbGVuZ3RoICsgaXNTb3J0ZWQpIDogaXNTb3J0ZWQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgaWYgKGFycmF5W2ldID09PSBpdGVtKSByZXR1cm4gaTsKICAgIHJldHVybiAtMTsKICB9OwoKICBfLmxhc3RJbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGZyb20pIHsKICAgIGlmIChhcnJheSA9PSBudWxsKSByZXR1cm4gLTE7CiAgICB2YXIgaWR4ID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKHR5cGVvZiBmcm9tID09ICdudW1iZXInKSB7CiAgICAgIGlkeCA9IGZyb20gPCAwID8gaWR4ICsgZnJvbSArIDEgOiBNYXRoLm1pbihpZHgsIGZyb20gKyAxKTsKICAgIH0KICAgIHdoaWxlICgtLWlkeCA+PSAwKSBpZiAoYXJyYXlbaWR4XSA9PT0gaXRlbSkgcmV0dXJuIGlkeDsKICAgIHJldHVybiAtMTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhbiBpbnRlZ2VyIEFycmF5IGNvbnRhaW5pbmcgYW4gYXJpdGhtZXRpYyBwcm9ncmVzc2lvbi4gQSBwb3J0IG9mCiAgLy8gdGhlIG5hdGl2ZSBQeXRob24gYHJhbmdlKClgIGZ1bmN0aW9uLiBTZWUKICAvLyBbdGhlIFB5dGhvbiBkb2N1bWVudGF0aW9uXShodHRwOi8vZG9jcy5weXRob24ub3JnL2xpYnJhcnkvZnVuY3Rpb25zLmh0bWwjcmFuZ2UpLgogIF8ucmFuZ2UgPSBmdW5jdGlvbihzdGFydCwgc3RvcCwgc3RlcCkgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPD0gMSkgewogICAgICBzdG9wID0gc3RhcnQgfHwgMDsKICAgICAgc3RhcnQgPSAwOwogICAgfQogICAgc3RlcCA9IHN0ZXAgfHwgMTsKCiAgICB2YXIgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIHJhbmdlID0gQXJyYXkobGVuZ3RoKTsKCiAgICBmb3IgKHZhciBpZHggPSAwOyBpZHggPCBsZW5ndGg7IGlkeCsrLCBzdGFydCArPSBzdGVwKSB7CiAgICAgIHJhbmdlW2lkeF0gPSBzdGFydDsKICAgIH0KCiAgICByZXR1cm4gcmFuZ2U7CiAgfTsKCiAgLy8gRnVuY3Rpb24gKGFoZW0pIEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXVzYWJsZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgcHJvdG90eXBlIHNldHRpbmcuCiAgdmFyIEN0b3IgPSBmdW5jdGlvbigpe307CgogIC8vIENyZWF0ZSBhIGZ1bmN0aW9uIGJvdW5kIHRvIGEgZ2l2ZW4gb2JqZWN0IChhc3NpZ25pbmcgYHRoaXNgLCBhbmQgYXJndW1lbnRzLAogIC8vIG9wdGlvbmFsbHkpLiBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgRnVuY3Rpb24uYmluZGAgaWYKICAvLyBhdmFpbGFibGUuCiAgXy5iaW5kID0gZnVuY3Rpb24oZnVuYywgY29udGV4dCkgewogICAgdmFyIGFyZ3MsIGJvdW5kOwogICAgaWYgKG5hdGl2ZUJpbmQgJiYgZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kKSByZXR1cm4gbmF0aXZlQmluZC5hcHBseShmdW5jLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgaWYgKCFfLmlzRnVuY3Rpb24oZnVuYykpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0JpbmQgbXVzdCBiZSBjYWxsZWQgb24gYSBmdW5jdGlvbicpOwogICAgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIGJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkpIHJldHVybiBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBDdG9yLnByb3RvdHlwZSA9IGZ1bmMucHJvdG90eXBlOwogICAgICB2YXIgc2VsZiA9IG5ldyBDdG9yOwogICAgICBDdG9yLnByb3RvdHlwZSA9IG51bGw7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoXy5pc09iamVjdChyZXN1bHQpKSByZXR1cm4gcmVzdWx0OwogICAgICByZXR1cm4gc2VsZjsKICAgIH07CiAgICByZXR1cm4gYm91bmQ7CiAgfTsKCiAgLy8gUGFydGlhbGx5IGFwcGx5IGEgZnVuY3Rpb24gYnkgY3JlYXRpbmcgYSB2ZXJzaW9uIHRoYXQgaGFzIGhhZCBzb21lIG9mIGl0cwogIC8vIGFyZ3VtZW50cyBwcmUtZmlsbGVkLCB3aXRob3V0IGNoYW5naW5nIGl0cyBkeW5hbWljIGB0aGlzYCBjb250ZXh0LiBfIGFjdHMKICAvLyBhcyBhIHBsYWNlaG9sZGVyLCBhbGxvd2luZyBhbnkgY29tYmluYXRpb24gb2YgYXJndW1lbnRzIHRvIGJlIHByZS1maWxsZWQuCiAgXy5wYXJ0aWFsID0gZnVuY3Rpb24oZnVuYykgewogICAgdmFyIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBvc2l0aW9uID0gMDsKICAgICAgdmFyIGFyZ3MgPSBib3VuZEFyZ3Muc2xpY2UoKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoYXJnc1tpXSA9PT0gXykgYXJnc1tpXSA9IGFyZ3VtZW50c1twb3NpdGlvbisrXTsKICAgICAgfQogICAgICB3aGlsZSAocG9zaXRpb24gPCBhcmd1bWVudHMubGVuZ3RoKSBhcmdzLnB1c2goYXJndW1lbnRzW3Bvc2l0aW9uKytdKTsKICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYSBudW1iZXIgb2YgYW4gb2JqZWN0J3MgbWV0aG9kcyB0byB0aGF0IG9iamVjdC4gUmVtYWluaW5nIGFyZ3VtZW50cwogIC8vIGFyZSB0aGUgbWV0aG9kIG5hbWVzIHRvIGJlIGJvdW5kLiBVc2VmdWwgZm9yIGVuc3VyaW5nIHRoYXQgYWxsIGNhbGxiYWNrcwogIC8vIGRlZmluZWQgb24gYW4gb2JqZWN0IGJlbG9uZyB0byBpdC4KICBfLmJpbmRBbGwgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBpLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLCBrZXk7CiAgICBpZiAobGVuZ3RoIDw9IDEpIHRocm93IG5ldyBFcnJvcignYmluZEFsbCBtdXN0IGJlIHBhc3NlZCBmdW5jdGlvbiBuYW1lcycpOwogICAgZm9yIChpID0gMTsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIGtleSA9IGFyZ3VtZW50c1tpXTsKICAgICAgb2JqW2tleV0gPSBfLmJpbmQob2JqW2tleV0sIG9iaik7CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIE1lbW9pemUgYW4gZXhwZW5zaXZlIGZ1bmN0aW9uIGJ5IHN0b3JpbmcgaXRzIHJlc3VsdHMuCiAgXy5tZW1vaXplID0gZnVuY3Rpb24oZnVuYywgaGFzaGVyKSB7CiAgICB2YXIgbWVtb2l6ZSA9IGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgY2FjaGUgPSBtZW1vaXplLmNhY2hlOwogICAgICB2YXIgYWRkcmVzcyA9IGhhc2hlciA/IGhhc2hlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDoga2V5OwogICAgICBpZiAoIV8uaGFzKGNhY2hlLCBhZGRyZXNzKSkgY2FjaGVbYWRkcmVzc10gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiBjYWNoZVthZGRyZXNzXTsKICAgIH07CiAgICBtZW1vaXplLmNhY2hlID0ge307CiAgICByZXR1cm4gbWVtb2l6ZTsKICB9OwoKICAvLyBEZWxheXMgYSBmdW5jdGlvbiBmb3IgdGhlIGdpdmVuIG51bWJlciBvZiBtaWxsaXNlY29uZHMsIGFuZCB0aGVuIGNhbGxzCiAgLy8gaXQgd2l0aCB0aGUgYXJndW1lbnRzIHN1cHBsaWVkLgogIF8uZGVsYXkgPSBmdW5jdGlvbihmdW5jLCB3YWl0KSB7CiAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4gTm9ybWFsbHksIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbCBydW4KICAvLyBhcyBtdWNoIGFzIGl0IGNhbiwgd2l0aG91dCBldmVyIGdvaW5nIG1vcmUgdGhhbiBvbmNlIHBlciBgd2FpdGAgZHVyYXRpb247CiAgLy8gYnV0IGlmIHlvdSdkIGxpa2UgdG8gZGlzYWJsZSB0aGUgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2UsIHBhc3MKICAvLyBge2xlYWRpbmc6IGZhbHNlfWAuIFRvIGRpc2FibGUgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlLCBkaXR0by4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHJlc3VsdDsKICAgIHZhciB0aW1lb3V0ID0gbnVsbDsKICAgIHZhciBwcmV2aW91cyA9IDA7CiAgICBpZiAoIW9wdGlvbnMpIG9wdGlvbnMgPSB7fTsKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICBwcmV2aW91cyA9IG9wdGlvbnMubGVhZGluZyA9PT0gZmFsc2UgPyAwIDogXy5ub3coKTsKICAgICAgdGltZW91dCA9IG51bGw7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgIGlmICghdGltZW91dCkgY29udGV4dCA9IGFyZ3MgPSBudWxsOwogICAgfTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG5vdyA9IF8ubm93KCk7CiAgICAgIGlmICghcHJldmlvdXMgJiYgb3B0aW9ucy5sZWFkaW5nID09PSBmYWxzZSkgcHJldmlvdXMgPSBub3c7CiAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdyAtIHByZXZpb3VzKTsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGlmIChyZW1haW5pbmcgPD0gMCB8fCByZW1haW5pbmcgPiB3YWl0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpOwogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIHByZXZpb3VzID0gbm93OwogICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgIH0gZWxzZSBpZiAoIXRpbWVvdXQgJiYgb3B0aW9ucy50cmFpbGluZyAhPT0gZmFsc2UpIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgcmVtYWluaW5nKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIGFyZ3MsIGNvbnRleHQsIHRpbWVzdGFtcCwgcmVzdWx0OwoKICAgIHZhciBsYXRlciA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgbGFzdCA9IF8ubm93KCkgLSB0aW1lc3RhbXA7CgogICAgICBpZiAobGFzdCA8IHdhaXQgJiYgbGFzdCA+IDApIHsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCAtIGxhc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgIGlmICghaW1tZWRpYXRlKSB7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgaWYgKCF0aW1lb3V0KSBjb250ZXh0ID0gYXJncyA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgY29udGV4dCA9IHRoaXM7CiAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIHRpbWVzdGFtcCA9IF8ubm93KCk7CiAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICBpZiAoIXRpbWVvdXQpIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCB3YWl0KTsKICAgICAgaWYgKGNhbGxOb3cpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KGNvbnRleHQsIGFyZ3MpOwogICAgICAgIGNvbnRleHQgPSBhcmdzID0gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyB0aGUgZmlyc3QgZnVuY3Rpb24gcGFzc2VkIGFzIGFuIGFyZ3VtZW50IHRvIHRoZSBzZWNvbmQsCiAgLy8gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBhcmd1bWVudHMsIHJ1biBjb2RlIGJlZm9yZSBhbmQgYWZ0ZXIsIGFuZAogIC8vIGNvbmRpdGlvbmFsbHkgZXhlY3V0ZSB0aGUgb3JpZ2luYWwgZnVuY3Rpb24uCiAgXy53cmFwID0gZnVuY3Rpb24oZnVuYywgd3JhcHBlcikgewogICAgcmV0dXJuIF8ucGFydGlhbCh3cmFwcGVyLCBmdW5jKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgbmVnYXRlZCB2ZXJzaW9uIG9mIHRoZSBwYXNzZWQtaW4gcHJlZGljYXRlLgogIF8ubmVnYXRlID0gZnVuY3Rpb24ocHJlZGljYXRlKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAhcHJlZGljYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgdmFyIHN0YXJ0ID0gYXJncy5sZW5ndGggLSAxOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICB2YXIgaSA9IHN0YXJ0OwogICAgICB2YXIgcmVzdWx0ID0gYXJnc1tzdGFydF0uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgd2hpbGUgKGktLSkgcmVzdWx0ID0gYXJnc1tpXS5jYWxsKHRoaXMsIHJlc3VsdCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgb25seSBiZSBleGVjdXRlZCBhZnRlciBiZWluZyBjYWxsZWQgTiB0aW1lcy4KICBfLmFmdGVyID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYmVmb3JlIGJlaW5nIGNhbGxlZCBOIHRpbWVzLgogIF8uYmVmb3JlID0gZnVuY3Rpb24odGltZXMsIGZ1bmMpIHsKICAgIHZhciBtZW1vOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICBpZiAoLS10aW1lcyA+IDApIHsKICAgICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICB9CiAgICAgIHJldHVybiBtZW1vOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIGF0IG1vc3Qgb25lIHRpbWUsIG5vIG1hdHRlciBob3cKICAvLyBvZnRlbiB5b3UgY2FsbCBpdC4gVXNlZnVsIGZvciBsYXp5IGluaXRpYWxpemF0aW9uLgogIF8ub25jZSA9IF8ucGFydGlhbChfLmJlZm9yZSwgMik7CgogIC8vIE9iamVjdCBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJldHJpZXZlIHRoZSBuYW1lcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIC8vIERlbGVnYXRlcyB0byAqKkVDTUFTY3JpcHQgNSoqJ3MgbmF0aXZlIGBPYmplY3Qua2V5c2AKICBfLmtleXMgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gW107CiAgICBpZiAobmF0aXZlS2V5cykgcmV0dXJuIG5hdGl2ZUtleXMob2JqKTsKICAgIHZhciBrZXlzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSBrZXlzLnB1c2goa2V5KTsKICAgIHJldHVybiBrZXlzOwogIH07CgogIC8vIFJldHJpZXZlIHRoZSB2YWx1ZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICBfLnZhbHVlcyA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIHZhciBsZW5ndGggPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YWx1ZXNbaV0gPSBvYmpba2V5c1tpXV07CiAgICB9CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICB2YXIgbGVuZ3RoID0ga2V5cy5sZW5ndGg7CiAgICB2YXIgcGFpcnMgPSBBcnJheShsZW5ndGgpOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBwYWlyc1tpXSA9IFtrZXlzW2ldLCBvYmpba2V5c1tpXV1dOwogICAgfQogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgdmFyIGtleXMgPSBfLmtleXMob2JqKTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBrZXlzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgIHJlc3VsdFtvYmpba2V5c1tpXV1dID0ga2V5c1tpXTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICB2YXIgc291cmNlLCBwcm9wOwogICAgZm9yICh2YXIgaSA9IDEsIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICBzb3VyY2UgPSBhcmd1bWVudHNbaV07CiAgICAgIGZvciAocHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIHByb3ApKSB7CiAgICAgICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgb2JqZWN0IG9ubHkgY29udGFpbmluZyB0aGUgd2hpdGVsaXN0ZWQgcHJvcGVydGllcy4KICBfLnBpY2sgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0ID0ge30sIGtleTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHJlc3VsdDsKICAgIGlmIChfLmlzRnVuY3Rpb24oaXRlcmF0ZWUpKSB7CiAgICAgIGl0ZXJhdGVlID0gY3JlYXRlQ2FsbGJhY2soaXRlcmF0ZWUsIGNvbnRleHQpOwogICAgICBmb3IgKGtleSBpbiBvYmopIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmpba2V5XTsKICAgICAgICBpZiAoaXRlcmF0ZWUodmFsdWUsIGtleSwgb2JqKSkgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoW10sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IGtleXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIGlmIChrZXkgaW4gb2JqKSByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBvYmplY3Qgd2l0aG91dCB0aGUgYmxhY2tsaXN0ZWQgcHJvcGVydGllcy4KICBfLm9taXQgPSBmdW5jdGlvbihvYmosIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZXJhdGVlKSkgewogICAgICBpdGVyYXRlZSA9IF8ubmVnYXRlKGl0ZXJhdGVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBrZXlzID0gXy5tYXAoY29uY2F0LmFwcGx5KFtdLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpLCBTdHJpbmcpOwogICAgICBpdGVyYXRlZSA9IGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICByZXR1cm4gIV8uY29udGFpbnMoa2V5cywga2V5KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBfLnBpY2sob2JqLCBpdGVyYXRlZSwgY29udGV4dCk7CiAgfTsKCiAgLy8gRmlsbCBpbiBhIGdpdmVuIG9iamVjdCB3aXRoIGRlZmF1bHQgcHJvcGVydGllcy4KICBfLmRlZmF1bHRzID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIV8uaXNPYmplY3Qob2JqKSkgcmV0dXJuIG9iajsKICAgIGZvciAodmFyIGkgPSAxLCBsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXTsKICAgICAgZm9yICh2YXIgcHJvcCBpbiBzb3VyY2UpIHsKICAgICAgICBpZiAob2JqW3Byb3BdID09PSB2b2lkIDApIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBDcmVhdGUgYSAoc2hhbGxvdy1jbG9uZWQpIGR1cGxpY2F0ZSBvZiBhbiBvYmplY3QuCiAgXy5jbG9uZSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFfLmlzT2JqZWN0KG9iaikpIHJldHVybiBvYmo7CiAgICByZXR1cm4gXy5pc0FycmF5KG9iaikgPyBvYmouc2xpY2UoKSA6IF8uZXh0ZW5kKHt9LCBvYmopOwogIH07CgogIC8vIEludm9rZXMgaW50ZXJjZXB0b3Igd2l0aCB0aGUgb2JqLCBhbmQgdGhlbiByZXR1cm5zIG9iai4KICAvLyBUaGUgcHJpbWFyeSBwdXJwb3NlIG9mIHRoaXMgbWV0aG9kIGlzIHRvICJ0YXAgaW50byIgYSBtZXRob2QgY2hhaW4sIGluCiAgLy8gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbiB0aGUgY2hhaW4uCiAgXy50YXAgPSBmdW5jdGlvbihvYmosIGludGVyY2VwdG9yKSB7CiAgICBpbnRlcmNlcHRvcihvYmopOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBJbnRlcm5hbCByZWN1cnNpdmUgY29tcGFyaXNvbiBmdW5jdGlvbiBmb3IgYGlzRXF1YWxgLgogIHZhciBlcSA9IGZ1bmN0aW9uKGEsIGIsIGFTdGFjaywgYlN0YWNrKSB7CiAgICAvLyBJZGVudGljYWwgb2JqZWN0cyBhcmUgZXF1YWwuIGAwID09PSAtMGAsIGJ1dCB0aGV5IGFyZW4ndCBpZGVudGljYWwuCiAgICAvLyBTZWUgdGhlIFtIYXJtb255IGBlZ2FsYCBwcm9wb3NhbF0oaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsKS4KICAgIGlmIChhID09PSBiKSByZXR1cm4gYSAhPT0gMCB8fCAxIC8gYSA9PT0gMSAvIGI7CiAgICAvLyBBIHN0cmljdCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIGBudWxsID09IHVuZGVmaW5lZGAuCiAgICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgcmV0dXJuIGEgPT09IGI7CiAgICAvLyBVbndyYXAgYW55IHdyYXBwZWQgb2JqZWN0cy4KICAgIGlmIChhIGluc3RhbmNlb2YgXykgYSA9IGEuX3dyYXBwZWQ7CiAgICBpZiAoYiBpbnN0YW5jZW9mIF8pIGIgPSBiLl93cmFwcGVkOwogICAgLy8gQ29tcGFyZSBgW1tDbGFzc11dYCBuYW1lcy4KICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKGEpOwogICAgaWYgKGNsYXNzTmFtZSAhPT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgcmVndWxhciBleHByZXNzaW9ucywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgUmVnRXhwXSc6CiAgICAgIC8vIFJlZ0V4cHMgYXJlIGNvZXJjZWQgdG8gc3RyaW5ncyBmb3IgY29tcGFyaXNvbiAoTm90ZTogJycgKyAvYS9pID09PSAnL2EvaScpCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gJycgKyBhID09PSAnJyArIGI7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4KICAgICAgICAvLyBPYmplY3QoTmFOKSBpcyBlcXVpdmFsZW50IHRvIE5hTgogICAgICAgIGlmICgrYSAhPT0gK2EpIHJldHVybiArYiAhPT0gK2I7CiAgICAgICAgLy8gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvciBvdGhlciBudW1lcmljIHZhbHVlcy4KICAgICAgICByZXR1cm4gK2EgPT09IDAgPyAxIC8gK2EgPT09IDEgLyBiIDogK2EgPT09ICtiOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09PSArYjsKICAgIH0KICAgIGlmICh0eXBlb2YgYSAhPSAnb2JqZWN0JyB8fCB0eXBlb2YgYiAhPSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlOwogICAgLy8gQXNzdW1lIGVxdWFsaXR5IGZvciBjeWNsaWMgc3RydWN0dXJlcy4gVGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYwogICAgLy8gc3RydWN0dXJlcyBpcyBhZGFwdGVkIGZyb20gRVMgNS4xIHNlY3Rpb24gMTUuMTIuMywgYWJzdHJhY3Qgb3BlcmF0aW9uIGBKT2AuCiAgICB2YXIgbGVuZ3RoID0gYVN0YWNrLmxlbmd0aDsKICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAvLyBMaW5lYXIgc2VhcmNoLiBQZXJmb3JtYW5jZSBpcyBpbnZlcnNlbHkgcHJvcG9ydGlvbmFsIHRvIHRoZSBudW1iZXIgb2YKICAgICAgLy8gdW5pcXVlIG5lc3RlZCBzdHJ1Y3R1cmVzLgogICAgICBpZiAoYVN0YWNrW2xlbmd0aF0gPT09IGEpIHJldHVybiBiU3RhY2tbbGVuZ3RoXSA9PT0gYjsKICAgIH0KICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgLy8gZnJvbSBkaWZmZXJlbnQgZnJhbWVzIGFyZS4KICAgIHZhciBhQ3RvciA9IGEuY29uc3RydWN0b3IsIGJDdG9yID0gYi5jb25zdHJ1Y3RvcjsKICAgIGlmICgKICAgICAgYUN0b3IgIT09IGJDdG9yICYmCiAgICAgIC8vIEhhbmRsZSBPYmplY3QuY3JlYXRlKHgpIGNhc2VzCiAgICAgICdjb25zdHJ1Y3RvcicgaW4gYSAmJiAnY29uc3RydWN0b3InIGluIGIgJiYKICAgICAgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIGFDdG9yIGluc3RhbmNlb2YgYUN0b3IgJiYKICAgICAgICBfLmlzRnVuY3Rpb24oYkN0b3IpICYmIGJDdG9yIGluc3RhbmNlb2YgYkN0b3IpCiAgICApIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgLy8gQWRkIHRoZSBmaXJzdCBvYmplY3QgdG8gdGhlIHN0YWNrIG9mIHRyYXZlcnNlZCBvYmplY3RzLgogICAgYVN0YWNrLnB1c2goYSk7CiAgICBiU3RhY2sucHVzaChiKTsKICAgIHZhciBzaXplLCByZXN1bHQ7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgLy8gQ29tcGFyZSBhcnJheSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkuCiAgICAgIHNpemUgPSBhLmxlbmd0aDsKICAgICAgcmVzdWx0ID0gc2l6ZSA9PT0gYi5sZW5ndGg7CiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICAvLyBEZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9IGVxKGFbc2l6ZV0sIGJbc2l6ZV0sIGFTdGFjaywgYlN0YWNrKSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gRGVlcCBjb21wYXJlIG9iamVjdHMuCiAgICAgIHZhciBrZXlzID0gXy5rZXlzKGEpLCBrZXk7CiAgICAgIHNpemUgPSBrZXlzLmxlbmd0aDsKICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMgYmVmb3JlIGNvbXBhcmluZyBkZWVwIGVxdWFsaXR5LgogICAgICByZXN1bHQgPSBfLmtleXMoYikubGVuZ3RoID09PSBzaXplOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgLy8gRGVlcCBjb21wYXJlIGVhY2ggbWVtYmVyCiAgICAgICAgICBrZXkgPSBrZXlzW3NpemVdOwogICAgICAgICAgaWYgKCEocmVzdWx0ID0gXy5oYXMoYiwga2V5KSAmJiBlcShhW2tleV0sIGJba2V5XSwgYVN0YWNrLCBiU3RhY2spKSkgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBSZW1vdmUgdGhlIGZpcnN0IG9iamVjdCBmcm9tIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wb3AoKTsKICAgIGJTdGFjay5wb3AoKTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUGVyZm9ybSBhIGRlZXAgY29tcGFyaXNvbiB0byBjaGVjayBpZiB0d28gb2JqZWN0cyBhcmUgZXF1YWwuCiAgXy5pc0VxdWFsID0gZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGVxKGEsIGIsIFtdLCBbXSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiBhcnJheSwgc3RyaW5nLCBvciBvYmplY3QgZW1wdHk/CiAgLy8gQW4gImVtcHR5IiBvYmplY3QgaGFzIG5vIGVudW1lcmFibGUgb3duLXByb3BlcnRpZXMuCiAgXy5pc0VtcHR5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlOwogICAgaWYgKF8uaXNBcnJheShvYmopIHx8IF8uaXNTdHJpbmcob2JqKSB8fCBfLmlzQXJndW1lbnRzKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBBcnJheV0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgYW4gb2JqZWN0PwogIF8uaXNPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciB0eXBlID0gdHlwZW9mIG9iajsKICAgIHJldHVybiB0eXBlID09PSAnZnVuY3Rpb24nIHx8IHR5cGUgPT09ICdvYmplY3QnICYmICEhb2JqOwogIH07CgogIC8vIEFkZCBzb21lIGlzVHlwZSBtZXRob2RzOiBpc0FyZ3VtZW50cywgaXNGdW5jdGlvbiwgaXNTdHJpbmcsIGlzTnVtYmVyLCBpc0RhdGUsIGlzUmVnRXhwLgogIF8uZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0ICcgKyBuYW1lICsgJ10nOwogICAgfTsKICB9KTsKCiAgLy8gRGVmaW5lIGEgZmFsbGJhY2sgdmVyc2lvbiBvZiB0aGUgbWV0aG9kIGluIGJyb3dzZXJzIChhaGVtLCBJRSksIHdoZXJlCiAgLy8gdGhlcmUgaXNuJ3QgYW55IGluc3BlY3RhYmxlICJBcmd1bWVudHMiIHR5cGUuCiAgaWYgKCFfLmlzQXJndW1lbnRzKGFyZ3VtZW50cykpIHsKICAgIF8uaXNBcmd1bWVudHMgPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIF8uaGFzKG9iaiwgJ2NhbGxlZScpOwogICAgfTsKICB9CgogIC8vIE9wdGltaXplIGBpc0Z1bmN0aW9uYCBpZiBhcHByb3ByaWF0ZS4gV29yayBhcm91bmQgYW4gSUUgMTEgYnVnLgogIGlmICh0eXBlb2YgLy4vICE9PSAnZnVuY3Rpb24nKSB7CiAgICBfLmlzRnVuY3Rpb24gPSBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIHR5cGVvZiBvYmogPT0gJ2Z1bmN0aW9uJyB8fCBmYWxzZTsKICAgIH07CiAgfQoKICAvLyBJcyBhIGdpdmVuIG9iamVjdCBhIGZpbml0ZSBudW1iZXI/CiAgXy5pc0Zpbml0ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIGlzRmluaXRlKG9iaikgJiYgIWlzTmFOKHBhcnNlRmxvYXQob2JqKSk7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9PSArb2JqOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgYSBib29sZWFuPwogIF8uaXNCb29sZWFuID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB0cnVlIHx8IG9iaiA9PT0gZmFsc2UgfHwgdG9TdHJpbmcuY2FsbChvYmopID09PSAnW29iamVjdCBCb29sZWFuXSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBlcXVhbCB0byBudWxsPwogIF8uaXNOdWxsID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSBudWxsOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFyaWFibGUgdW5kZWZpbmVkPwogIF8uaXNVbmRlZmluZWQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHZvaWQgMDsKICB9OwoKICAvLyBTaG9ydGN1dCBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYW4gb2JqZWN0IGhhcyBhIGdpdmVuIHByb3BlcnR5IGRpcmVjdGx5CiAgLy8gb24gaXRzZWxmIChpbiBvdGhlciB3b3Jkcywgbm90IG9uIGEgcHJvdG90eXBlKS4KICBfLmhhcyA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gb2JqICE9IG51bGwgJiYgaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSk7CiAgfTsKCiAgLy8gVXRpbGl0eSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSdW4gVW5kZXJzY29yZS5qcyBpbiAqbm9Db25mbGljdCogbW9kZSwgcmV0dXJuaW5nIHRoZSBgX2AgdmFyaWFibGUgdG8gaXRzCiAgLy8gcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhlIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8ubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5fID0gcHJldmlvdXNVbmRlcnNjb3JlOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgLy8gS2VlcCB0aGUgaWRlbnRpdHkgZnVuY3Rpb24gYXJvdW5kIGZvciBkZWZhdWx0IGl0ZXJhdGVlcy4KICBfLmlkZW50aXR5ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9OwoKICBfLmNvbnN0YW50ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfTsKICB9OwoKICBfLm5vb3AgPSBmdW5jdGlvbigpe307CgogIF8ucHJvcGVydHkgPSBmdW5jdGlvbihrZXkpIHsKICAgIHJldHVybiBmdW5jdGlvbihvYmopIHsKICAgICAgcmV0dXJuIG9ialtrZXldOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgcHJlZGljYXRlIGZvciBjaGVja2luZyB3aGV0aGVyIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBzZXQgb2YgYGtleTp2YWx1ZWAgcGFpcnMuCiAgXy5tYXRjaGVzID0gZnVuY3Rpb24oYXR0cnMpIHsKICAgIHZhciBwYWlycyA9IF8ucGFpcnMoYXR0cnMpLCBsZW5ndGggPSBwYWlycy5sZW5ndGg7CiAgICByZXR1cm4gZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuICFsZW5ndGg7CiAgICAgIG9iaiA9IG5ldyBPYmplY3Qob2JqKTsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwYWlyID0gcGFpcnNbaV0sIGtleSA9IHBhaXJbMF07CiAgICAgICAgaWYgKHBhaXJbMV0gIT09IG9ialtrZXldIHx8ICEoa2V5IGluIG9iaikpIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdGVlLCBjb250ZXh0KSB7CiAgICB2YXIgYWNjdW0gPSBBcnJheShNYXRoLm1heCgwLCBuKSk7CiAgICBpdGVyYXRlZSA9IGNyZWF0ZUNhbGxiYWNrKGl0ZXJhdGVlLCBjb250ZXh0LCAxKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgaSsrKSBhY2N1bVtpXSA9IGl0ZXJhdGVlKGkpOwogICAgcmV0dXJuIGFjY3VtOwogIH07CgogIC8vIFJldHVybiBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXggKGluY2x1c2l2ZSkuCiAgXy5yYW5kb20gPSBmdW5jdGlvbihtaW4sIG1heCkgewogICAgaWYgKG1heCA9PSBudWxsKSB7CiAgICAgIG1heCA9IG1pbjsKICAgICAgbWluID0gMDsKICAgIH0KICAgIHJldHVybiBtaW4gKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkpOwogIH07CgogIC8vIEEgKHBvc3NpYmx5IGZhc3Rlcikgd2F5IHRvIGdldCB0aGUgY3VycmVudCB0aW1lc3RhbXAgYXMgYW4gaW50ZWdlci4KICBfLm5vdyA9IERhdGUubm93IHx8IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogIH07CgogICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlc2NhcGVNYXAgPSB7CiAgICAnJic6ICcmYW1wOycsCiAgICAnPCc6ICcmbHQ7JywKICAgICc+JzogJyZndDsnLAogICAgJyInOiAnJnF1b3Q7JywKICAgICInIjogJyYjeDI3OycsCiAgICAnYCc6ICcmI3g2MDsnCiAgfTsKICB2YXIgdW5lc2NhcGVNYXAgPSBfLmludmVydChlc2NhcGVNYXApOwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgdmFyIGNyZWF0ZUVzY2FwZXIgPSBmdW5jdGlvbihtYXApIHsKICAgIHZhciBlc2NhcGVyID0gZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgcmV0dXJuIG1hcFttYXRjaF07CiAgICB9OwogICAgLy8gUmVnZXhlcyBmb3IgaWRlbnRpZnlpbmcgYSBrZXkgdGhhdCBuZWVkcyB0byBiZSBlc2NhcGVkCiAgICB2YXIgc291cmNlID0gJyg/OicgKyBfLmtleXMobWFwKS5qb2luKCd8JykgKyAnKSc7CiAgICB2YXIgdGVzdFJlZ2V4cCA9IFJlZ0V4cChzb3VyY2UpOwogICAgdmFyIHJlcGxhY2VSZWdleHAgPSBSZWdFeHAoc291cmNlLCAnZycpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICBzdHJpbmcgPSBzdHJpbmcgPT0gbnVsbCA/ICcnIDogJycgKyBzdHJpbmc7CiAgICAgIHJldHVybiB0ZXN0UmVnZXhwLnRlc3Qoc3RyaW5nKSA/IHN0cmluZy5yZXBsYWNlKHJlcGxhY2VSZWdleHAsIGVzY2FwZXIpIDogc3RyaW5nOwogICAgfTsKICB9OwogIF8uZXNjYXBlID0gY3JlYXRlRXNjYXBlcihlc2NhcGVNYXApOwogIF8udW5lc2NhcGUgPSBjcmVhdGVFc2NhcGVyKHVuZXNjYXBlTWFwKTsKCiAgLy8gSWYgdGhlIHZhbHVlIG9mIHRoZSBuYW1lZCBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQgd2l0aCB0aGUKICAvLyBgb2JqZWN0YCBhcyBjb250ZXh0OyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICByZXR1cm4gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IG9iamVjdFtwcm9wZXJ0eV0oKSA6IHZhbHVlOwogIH07CgogIC8vIEdlbmVyYXRlIGEgdW5pcXVlIGludGVnZXIgaWQgKHVuaXF1ZSB3aXRoaW4gdGhlIGVudGlyZSBjbGllbnQgc2Vzc2lvbikuCiAgLy8gVXNlZnVsIGZvciB0ZW1wb3JhcnkgRE9NIGlkcy4KICB2YXIgaWRDb3VudGVyID0gMDsKICBfLnVuaXF1ZUlkID0gZnVuY3Rpb24ocHJlZml4KSB7CiAgICB2YXIgaWQgPSArK2lkQ291bnRlciArICcnOwogICAgcmV0dXJuIHByZWZpeCA/IHByZWZpeCArIGlkIDogaWQ7CiAgfTsKCiAgLy8gQnkgZGVmYXVsdCwgVW5kZXJzY29yZSB1c2VzIEVSQi1zdHlsZSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzLCBjaGFuZ2UgdGhlCiAgLy8gZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZSBkZWxpbWl0ZXJzLgogIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgIGV2YWx1YXRlICAgIDogLzwlKFtcc1xTXSs/KSU+L2csCiAgICBpbnRlcnBvbGF0ZSA6IC88JT0oW1xzXFNdKz8pJT4vZywKICAgIGVzY2FwZSAgICAgIDogLzwlLShbXHNcU10rPyklPi9nCiAgfTsKCiAgLy8gV2hlbiBjdXN0b21pemluZyBgdGVtcGxhdGVTZXR0aW5nc2AsIGlmIHlvdSBkb24ndCB3YW50IHRvIGRlZmluZSBhbgogIC8vIGludGVycG9sYXRpb24sIGV2YWx1YXRpb24gb3IgZXNjYXBpbmcgcmVnZXgsIHdlIG5lZWQgb25lIHRoYXQgaXMKICAvLyBndWFyYW50ZWVkIG5vdCB0byBtYXRjaC4KICB2YXIgbm9NYXRjaCA9IC8oLileLzsKCiAgLy8gQ2VydGFpbiBjaGFyYWN0ZXJzIG5lZWQgdG8gYmUgZXNjYXBlZCBzbyB0aGF0IHRoZXkgY2FuIGJlIHB1dCBpbnRvIGEKICAvLyBzdHJpbmcgbGl0ZXJhbC4KICB2YXIgZXNjYXBlcyA9IHsKICAgICInIjogICAgICAiJyIsCiAgICAnXFwnOiAgICAgJ1xcJywKICAgICdccic6ICAgICAncicsCiAgICAnXG4nOiAgICAgJ24nLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHUyMDI4fFx1MjAyOS9nOwoKICB2YXIgZXNjYXBlQ2hhciA9IGZ1bmN0aW9uKG1hdGNoKSB7CiAgICByZXR1cm4gJ1xcJyArIGVzY2FwZXNbbWF0Y2hdOwogIH07CgogIC8vIEphdmFTY3JpcHQgbWljcm8tdGVtcGxhdGluZywgc2ltaWxhciB0byBKb2huIFJlc2lnJ3MgaW1wbGVtZW50YXRpb24uCiAgLy8gVW5kZXJzY29yZSB0ZW1wbGF0aW5nIGhhbmRsZXMgYXJiaXRyYXJ5IGRlbGltaXRlcnMsIHByZXNlcnZlcyB3aGl0ZXNwYWNlLAogIC8vIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogIC8vIE5COiBgb2xkU2V0dGluZ3NgIG9ubHkgZXhpc3RzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgc2V0dGluZ3MsIG9sZFNldHRpbmdzKSB7CiAgICBpZiAoIXNldHRpbmdzICYmIG9sZFNldHRpbmdzKSBzZXR0aW5ncyA9IG9sZFNldHRpbmdzOwogICAgc2V0dGluZ3MgPSBfLmRlZmF1bHRzKHt9LCBzZXR0aW5ncywgXy50ZW1wbGF0ZVNldHRpbmdzKTsKCiAgICAvLyBDb21iaW5lIGRlbGltaXRlcnMgaW50byBvbmUgcmVndWxhciBleHByZXNzaW9uIHZpYSBhbHRlcm5hdGlvbi4KICAgIHZhciBtYXRjaGVyID0gUmVnRXhwKFsKICAgICAgKHNldHRpbmdzLmVzY2FwZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5pbnRlcnBvbGF0ZSB8fCBub01hdGNoKS5zb3VyY2UsCiAgICAgIChzZXR0aW5ncy5ldmFsdWF0ZSB8fCBub01hdGNoKS5zb3VyY2UKICAgIF0uam9pbignfCcpICsgJ3wkJywgJ2cnKTsKCiAgICAvLyBDb21waWxlIHRoZSB0ZW1wbGF0ZSBzb3VyY2UsIGVzY2FwaW5nIHN0cmluZyBsaXRlcmFscyBhcHByb3ByaWF0ZWx5LgogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzb3VyY2UgPSAiX19wKz0nIjsKICAgIHRleHQucmVwbGFjZShtYXRjaGVyLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlLCBpbnRlcnBvbGF0ZSwgZXZhbHVhdGUsIG9mZnNldCkgewogICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKGVzY2FwZXIsIGVzY2FwZUNoYXIpOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKCiAgICAgIGlmIChlc2NhcGUpIHsKICAgICAgICBzb3VyY2UgKz0gIicrXG4oKF9fdD0oIiArIGVzY2FwZSArICIpKT09bnVsbD8nJzpfLmVzY2FwZShfX3QpKStcbiciOwogICAgICB9IGVsc2UgaWYgKGludGVycG9sYXRlKSB7CiAgICAgICAgc291cmNlICs9ICInK1xuKChfX3Q9KCIgKyBpbnRlcnBvbGF0ZSArICIpKT09bnVsbD8nJzpfX3QpK1xuJyI7CiAgICAgIH0gZWxzZSBpZiAoZXZhbHVhdGUpIHsKICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGUgKyAiXG5fX3ArPSciOwogICAgICB9CgogICAgICAvLyBBZG9iZSBWTXMgbmVlZCB0aGUgbWF0Y2ggcmV0dXJuZWQgdG8gcHJvZHVjZSB0aGUgY29ycmVjdCBvZmZlc3QuCiAgICAgIHJldHVybiBtYXRjaDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgJ3JldHVybiBfX3A7XG4nOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgdmFyIHRlbXBsYXRlID0gZnVuY3Rpb24oZGF0YSkgewogICAgICByZXR1cm4gcmVuZGVyLmNhbGwodGhpcywgZGF0YSwgXyk7CiAgICB9OwoKICAgIC8vIFByb3ZpZGUgdGhlIGNvbXBpbGVkIHNvdXJjZSBhcyBhIGNvbnZlbmllbmNlIGZvciBwcmVjb21waWxhdGlvbi4KICAgIHZhciBhcmd1bWVudCA9IHNldHRpbmdzLnZhcmlhYmxlIHx8ICdvYmonOwogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyBhcmd1bWVudCArICcpe1xuJyArIHNvdXJjZSArICd9JzsKCiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfTsKCiAgLy8gQWRkIGEgImNoYWluIiBmdW5jdGlvbi4gU3RhcnQgY2hhaW5pbmcgYSB3cmFwcGVkIFVuZGVyc2NvcmUgb2JqZWN0LgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBpbnN0YW5jZSA9IF8ob2JqKTsKICAgIGluc3RhbmNlLl9jaGFpbiA9IHRydWU7CiAgICByZXR1cm4gaW5zdGFuY2U7CiAgfTsKCiAgLy8gT09QCiAgLy8gLS0tLS0tLS0tLS0tLS0tCiAgLy8gSWYgVW5kZXJzY29yZSBpcyBjYWxsZWQgYXMgYSBmdW5jdGlvbiwgaXQgcmV0dXJucyBhIHdyYXBwZWQgb2JqZWN0IHRoYXQKICAvLyBjYW4gYmUgdXNlZCBPTy1zdHlsZS4gVGhpcyB3cmFwcGVyIGhvbGRzIGFsdGVyZWQgdmVyc2lvbnMgb2YgYWxsIHRoZQogIC8vIHVuZGVyc2NvcmUgZnVuY3Rpb25zLiBXcmFwcGVkIG9iamVjdHMgbWF5IGJlIGNoYWluZWQuCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb250aW51ZSBjaGFpbmluZyBpbnRlcm1lZGlhdGUgcmVzdWx0cy4KICB2YXIgcmVzdWx0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdGhpcy5fY2hhaW4gPyBfKG9iaikuY2hhaW4oKSA6IG9iajsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgXy5lYWNoKF8uZnVuY3Rpb25zKG9iaiksIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBBZGQgYWxsIG9mIHRoZSBVbmRlcnNjb3JlIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlciBvYmplY3QuCiAgXy5taXhpbihfKTsKCiAgLy8gQWRkIGFsbCBtdXRhdG9yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBfLmVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09PSAnc2hpZnQnIHx8IG5hbWUgPT09ICdzcGxpY2UnKSAmJiBvYmoubGVuZ3RoID09PSAwKSBkZWxldGUgb2JqWzBdOwogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgb2JqKTsKICAgIH07CiAgfSk7CgogIC8vIEFkZCBhbGwgYWNjZXNzb3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIF8uZWFjaChbJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIHZhciBtZXRob2QgPSBBcnJheVByb3RvW25hbWVdOwogICAgXy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG1ldGhvZC5hcHBseSh0aGlzLl93cmFwcGVkLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfSk7CgogIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogIF8ucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICB9OwoKICAvLyBBTUQgcmVnaXN0cmF0aW9uIGhhcHBlbnMgYXQgdGhlIGVuZCBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIEFNRCBsb2FkZXJzCiAgLy8gdGhhdCBtYXkgbm90IGVuZm9yY2UgbmV4dC10dXJuIHNlbWFudGljcyBvbiBtb2R1bGVzLiBFdmVuIHRob3VnaCBnZW5lcmFsCiAgLy8gcHJhY3RpY2UgZm9yIEFNRCByZWdpc3RyYXRpb24gaXMgdG8gYmUgYW5vbnltb3VzLCB1bmRlcnNjb3JlIHJlZ2lzdGVycwogIC8vIGFzIGEgbmFtZWQgbW9kdWxlIGJlY2F1c2UsIGxpa2UgalF1ZXJ5LCBpdCBpcyBhIGJhc2UgbGlicmFyeSB0aGF0IGlzCiAgLy8gcG9wdWxhciBlbm91Z2ggdG8gYmUgYnVuZGxlZCBpbiBhIHRoaXJkIHBhcnR5IGxpYiwgYnV0IG5vdCBiZSBwYXJ0IG9mCiAgLy8gYW4gQU1EIGxvYWQgcmVxdWVzdC4gVGhvc2UgY2FzZXMgY291bGQgZ2VuZXJhdGUgYW4gZXJyb3Igd2hlbiBhbgogIC8vIGFub255bW91cyBkZWZpbmUoKSBpcyBjYWxsZWQgb3V0c2lkZSBvZiBhIGxvYWRlciByZXF1ZXN0LgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZSgndW5kZXJzY29yZScsIFtdLCBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF87CiAgICB9KTsKICB9Cn0uY2FsbCh0aGlzKSk7Cgp9LHt9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKdmFyIFNvbWVQcm9taXNlQXJyYXkgPSBQcm9taXNlLl9Tb21lUHJvbWlzZUFycmF5OwpmdW5jdGlvbiBQcm9taXNlJF9BbnkocHJvbWlzZXMpIHsKICAgIHZhciByZXQgPSBuZXcgU29tZVByb21pc2VBcnJheShwcm9taXNlcyk7CiAgICB2YXIgcHJvbWlzZSA9IHJldC5wcm9taXNlKCk7CiAgICBpZiAocHJvbWlzZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIHJldC5zZXRIb3dNYW55KDEpOwogICAgcmV0LnNldFVud3JhcCgpOwogICAgcmV0LmluaXQoKTsKICAgIHJldHVybiBwcm9taXNlOwp9CgpQcm9taXNlLmFueSA9IGZ1bmN0aW9uIFByb21pc2UkQW55KHByb21pc2VzKSB7CiAgICByZXR1cm4gUHJvbWlzZSRfQW55KHByb21pc2VzKTsKfTsKClByb21pc2UucHJvdG90eXBlLmFueSA9IGZ1bmN0aW9uIFByb21pc2UkYW55KCkgewogICAgcmV0dXJuIFByb21pc2UkX0FueSh0aGlzKTsKfTsKCn07Cgp9LHt9XSwxODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgc2NoZWR1bGUgPSByZXF1aXJlKCIuL3NjaGVkdWxlLmpzIik7CnZhciBRdWV1ZSA9IHJlcXVpcmUoIi4vcXVldWUuanMiKTsKdmFyIGVycm9yT2JqID0gcmVxdWlyZSgiLi91dGlsLmpzIikuZXJyb3JPYmo7CnZhciB0cnlDYXRjaDEgPSByZXF1aXJlKCIuL3V0aWwuanMiKS50cnlDYXRjaDE7CnZhciBfcHJvY2VzcyA9IHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiA/IHByb2Nlc3MgOiB2b2lkIDA7CgpmdW5jdGlvbiBBc3luYygpIHsKICAgIHRoaXMuX2lzVGlja1VzZWQgPSBmYWxzZTsKICAgIHRoaXMuX3NjaGVkdWxlID0gc2NoZWR1bGU7CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fbGF0ZUJ1ZmZlciA9IG5ldyBRdWV1ZSgxNik7CiAgICB0aGlzLl9mdW5jdGlvbkJ1ZmZlciA9IG5ldyBRdWV1ZSg2NTUzNik7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICB0aGlzLmNvbnN1bWVGdW5jdGlvbkJ1ZmZlciA9IGZ1bmN0aW9uIEFzeW5jJGNvbnN1bWVGdW5jdGlvbkJ1ZmZlcigpIHsKICAgICAgICBzZWxmLl9jb25zdW1lRnVuY3Rpb25CdWZmZXIoKTsKICAgIH07Cn0KCkFzeW5jLnByb3RvdHlwZS5oYXZlSXRlbXNRdWV1ZWQgPSBmdW5jdGlvbiBBc3luYyRoYXZlSXRlbXNRdWV1ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5fbGVuZ3RoID4gMDsKfTsKCkFzeW5jLnByb3RvdHlwZS5pbnZva2VMYXRlciA9IGZ1bmN0aW9uIEFzeW5jJGludm9rZUxhdGVyKGZuLCByZWNlaXZlciwgYXJnKSB7CiAgICBpZiAoX3Byb2Nlc3MgIT09IHZvaWQgMCAmJgogICAgICAgIF9wcm9jZXNzLmRvbWFpbiAhPSBudWxsICYmCiAgICAgICAgIWZuLmRvbWFpbikgewogICAgICAgIGZuID0gX3Byb2Nlc3MuZG9tYWluLmJpbmQoZm4pOwogICAgfQogICAgdGhpcy5fbGF0ZUJ1ZmZlci5wdXNoKGZuLCByZWNlaXZlciwgYXJnKTsKICAgIHRoaXMuX3F1ZXVlVGljaygpOwp9OwoKQXN5bmMucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uIEFzeW5jJGludm9rZShmbiwgcmVjZWl2ZXIsIGFyZykgewogICAgaWYgKF9wcm9jZXNzICE9PSB2b2lkIDAgJiYKICAgICAgICBfcHJvY2Vzcy5kb21haW4gIT0gbnVsbCAmJgogICAgICAgICFmbi5kb21haW4pIHsKICAgICAgICBmbiA9IF9wcm9jZXNzLmRvbWFpbi5iaW5kKGZuKTsKICAgIH0KICAgIHZhciBmdW5jdGlvbkJ1ZmZlciA9IHRoaXMuX2Z1bmN0aW9uQnVmZmVyOwogICAgZnVuY3Rpb25CdWZmZXIucHVzaChmbiwgcmVjZWl2ZXIsIGFyZyk7CiAgICB0aGlzLl9sZW5ndGggPSBmdW5jdGlvbkJ1ZmZlci5sZW5ndGgoKTsKICAgIHRoaXMuX3F1ZXVlVGljaygpOwp9OwoKQXN5bmMucHJvdG90eXBlLl9jb25zdW1lRnVuY3Rpb25CdWZmZXIgPQpmdW5jdGlvbiBBc3luYyRfY29uc3VtZUZ1bmN0aW9uQnVmZmVyKCkgewogICAgdmFyIGZ1bmN0aW9uQnVmZmVyID0gdGhpcy5fZnVuY3Rpb25CdWZmZXI7CiAgICB3aGlsZSAoZnVuY3Rpb25CdWZmZXIubGVuZ3RoKCkgPiAwKSB7CiAgICAgICAgdmFyIGZuID0gZnVuY3Rpb25CdWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSBmdW5jdGlvbkJ1ZmZlci5zaGlmdCgpOwogICAgICAgIHZhciBhcmcgPSBmdW5jdGlvbkJ1ZmZlci5zaGlmdCgpOwogICAgICAgIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7CiAgICB9CiAgICB0aGlzLl9yZXNldCgpOwogICAgdGhpcy5fY29uc3VtZUxhdGVCdWZmZXIoKTsKfTsKCkFzeW5jLnByb3RvdHlwZS5fY29uc3VtZUxhdGVCdWZmZXIgPSBmdW5jdGlvbiBBc3luYyRfY29uc3VtZUxhdGVCdWZmZXIoKSB7CiAgICB2YXIgYnVmZmVyID0gdGhpcy5fbGF0ZUJ1ZmZlcjsKICAgIHdoaWxlKGJ1ZmZlci5sZW5ndGgoKSA+IDApIHsKICAgICAgICB2YXIgZm4gPSBidWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSBidWZmZXIuc2hpZnQoKTsKICAgICAgICB2YXIgYXJnID0gYnVmZmVyLnNoaWZ0KCk7CiAgICAgICAgdmFyIHJlcyA9IHRyeUNhdGNoMShmbiwgcmVjZWl2ZXIsIGFyZyk7CiAgICAgICAgaWYgKHJlcyA9PT0gZXJyb3JPYmopIHsKICAgICAgICAgICAgdGhpcy5fcXVldWVUaWNrKCk7CiAgICAgICAgICAgIGlmIChmbi5kb21haW4gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm4uZG9tYWluLmVtaXQoImVycm9yIiwgcmVzLmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgcmVzLmU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn07CgpBc3luYy5wcm90b3R5cGUuX3F1ZXVlVGljayA9IGZ1bmN0aW9uIEFzeW5jJF9xdWV1ZSgpIHsKICAgIGlmICghdGhpcy5faXNUaWNrVXNlZCkgewogICAgICAgIHRoaXMuX3NjaGVkdWxlKHRoaXMuY29uc3VtZUZ1bmN0aW9uQnVmZmVyKTsKICAgICAgICB0aGlzLl9pc1RpY2tVc2VkID0gdHJ1ZTsKICAgIH0KfTsKCkFzeW5jLnByb3RvdHlwZS5fcmVzZXQgPSBmdW5jdGlvbiBBc3luYyRfcmVzZXQoKSB7CiAgICB0aGlzLl9pc1RpY2tVc2VkID0gZmFsc2U7CiAgICB0aGlzLl9sZW5ndGggPSAwOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBuZXcgQXN5bmMoKTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9xdWV1ZS5qcyI6NDAsIi4vc2NoZWR1bGUuanMiOjQzLCIuL3V0aWwuanMiOjUwLCJfcHJvY2VzcyI6NjB9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgY3IgPSBPYmplY3QuY3JlYXRlOwppZiAoY3IpIHsKICAgIHZhciBjYWxsZXJDYWNoZSA9IGNyKG51bGwpOwogICAgdmFyIGdldHRlckNhY2hlID0gY3IobnVsbCk7CiAgICBjYWxsZXJDYWNoZVsiIHNpemUiXSA9IGdldHRlckNhY2hlWyIgc2l6ZSJdID0gMDsKfQoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciBpc0lkZW50aWZpZXIgPSB1dGlsLmlzSWRlbnRpZmllcjsKCmZ1bmN0aW9uIG1ha2VNZXRob2RDYWxsZXIgKG1ldGhvZE5hbWUpIHsKICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIm9iaiIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAndXNlIHN0cmljdCcgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICB2YXIgbGVuID0gdGhpcy5sZW5ndGg7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICBzd2l0Y2gobGVuKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSk7ICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSwgdGhpc1sxXSk7ICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAzOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUodGhpc1swXSwgdGhpc1sxXSwgdGhpc1syXSk7ICAgICAgICBcblwKICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gb2JqLm1ldGhvZE5hbWUoKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG9iai5tZXRob2ROYW1lLmFwcGx5KG9iaiwgdGhpcyk7ICAgICAgICAgICAgICAgICBcblwKICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoL21ldGhvZE5hbWUvZywgbWV0aG9kTmFtZSkpOwp9CgpmdW5jdGlvbiBtYWtlR2V0dGVyIChwcm9wZXJ0eU5hbWUpIHsKICAgIHJldHVybiBuZXcgRnVuY3Rpb24oIm9iaiIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICByZXR1cm4gb2JqLnByb3BlcnR5TmFtZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoInByb3BlcnR5TmFtZSIsIHByb3BlcnR5TmFtZSkpOwp9CgpmdW5jdGlvbiBnZXRDb21waWxlZChuYW1lLCBjb21waWxlciwgY2FjaGUpIHsKICAgIHZhciByZXQgPSBjYWNoZVtuYW1lXTsKICAgIGlmICh0eXBlb2YgcmV0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgaWYgKCFpc0lkZW50aWZpZXIobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHJldCA9IGNvbXBpbGVyKG5hbWUpOwogICAgICAgIGNhY2hlW25hbWVdID0gcmV0OwogICAgICAgIGNhY2hlWyIgc2l6ZSJdKys7CiAgICAgICAgaWYgKGNhY2hlWyIgc2l6ZSJdID4gNTEyKSB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoY2FjaGUpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDI1NjsgKytpKSBkZWxldGUgY2FjaGVba2V5c1tpXV07CiAgICAgICAgICAgIGNhY2hlWyIgc2l6ZSJdID0ga2V5cy5sZW5ndGggLSAyNTY7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZ2V0TWV0aG9kQ2FsbGVyKG5hbWUpIHsKICAgIHJldHVybiBnZXRDb21waWxlZChuYW1lLCBtYWtlTWV0aG9kQ2FsbGVyLCBjYWxsZXJDYWNoZSk7Cn0KCmZ1bmN0aW9uIGdldEdldHRlcihuYW1lKSB7CiAgICByZXR1cm4gZ2V0Q29tcGlsZWQobmFtZSwgbWFrZUdldHRlciwgZ2V0dGVyQ2FjaGUpOwp9CgpmdW5jdGlvbiBjYWxsZXIob2JqKSB7CiAgICByZXR1cm4gb2JqW3RoaXMucG9wKCldLmFwcGx5KG9iaiwgdGhpcyk7Cn0KUHJvbWlzZS5wcm90b3R5cGUuY2FsbCA9IGZ1bmN0aW9uIFByb21pc2UkY2FsbChtZXRob2ROYW1lKSB7CiAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuIC0gMSk7IGZvcih2YXIgJF9pID0gMTsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2kgLSAxXSA9IGFyZ3VtZW50c1skX2ldO30KICAgIGlmIChjYW5FdmFsdWF0ZSkgewogICAgICAgIHZhciBtYXliZUNhbGxlciA9IGdldE1ldGhvZENhbGxlcihtZXRob2ROYW1lKTsKICAgICAgICBpZiAobWF5YmVDYWxsZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RoZW4obWF5YmVDYWxsZXIsIHZvaWQgMCwgdm9pZCAwLCBhcmdzLCB2b2lkIDApOwogICAgICAgIH0KICAgIH0KICAgIGFyZ3MucHVzaChtZXRob2ROYW1lKTsKICAgIHJldHVybiB0aGlzLl90aGVuKGNhbGxlciwgdm9pZCAwLCB2b2lkIDAsIGFyZ3MsIHZvaWQgMCk7Cn07CgpmdW5jdGlvbiBuYW1lZEdldHRlcihvYmopIHsKICAgIHJldHVybiBvYmpbdGhpc107Cn0KZnVuY3Rpb24gaW5kZXhlZEdldHRlcihvYmopIHsKICAgIHJldHVybiBvYmpbdGhpc107Cn0KUHJvbWlzZS5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gUHJvbWlzZSRnZXQocHJvcGVydHlOYW1lKSB7CiAgICB2YXIgaXNJbmRleCA9ICh0eXBlb2YgcHJvcGVydHlOYW1lID09PSAibnVtYmVyIik7CiAgICB2YXIgZ2V0dGVyOwogICAgaWYgKCFpc0luZGV4KSB7CiAgICAgICAgaWYgKGNhbkV2YWx1YXRlKSB7CiAgICAgICAgICAgIHZhciBtYXliZUdldHRlciA9IGdldEdldHRlcihwcm9wZXJ0eU5hbWUpOwogICAgICAgICAgICBnZXR0ZXIgPSBtYXliZUdldHRlciAhPT0gbnVsbCA/IG1heWJlR2V0dGVyIDogbmFtZWRHZXR0ZXI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0dGVyID0gbmFtZWRHZXR0ZXI7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBnZXR0ZXIgPSBpbmRleGVkR2V0dGVyOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3RoZW4oZ2V0dGVyLCB2b2lkIDAsIHZvaWQgMCwgcHJvcGVydHlOYW1lLCB2b2lkIDApOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwyMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgY2FuQXR0YWNoID0gZXJyb3JzLmNhbkF0dGFjaDsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgQ2FuY2VsbGF0aW9uRXJyb3IgPSBlcnJvcnMuQ2FuY2VsbGF0aW9uRXJyb3I7CgpQcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsID0gZnVuY3Rpb24gUHJvbWlzZSRfY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLmlzQ2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICB2YXIgcGFyZW50OwogICAgdmFyIHByb21pc2VUb1JlamVjdCA9IHRoaXM7CiAgICB3aGlsZSAoKHBhcmVudCA9IHByb21pc2VUb1JlamVjdC5fY2FuY2VsbGF0aW9uUGFyZW50KSAhPT0gdm9pZCAwICYmCiAgICAgICAgcGFyZW50LmlzQ2FuY2VsbGFibGUoKSkgewogICAgICAgIHByb21pc2VUb1JlamVjdCA9IHBhcmVudDsKICAgIH0KICAgIHRoaXMuX3Vuc2V0Q2FuY2VsbGFibGUoKTsKICAgIHByb21pc2VUb1JlamVjdC5fYXR0YWNoRXh0cmFUcmFjZShyZWFzb24pOwogICAgcHJvbWlzZVRvUmVqZWN0Ll9yZWplY3RVbmNoZWNrZWQocmVhc29uKTsKfTsKClByb21pc2UucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uIFByb21pc2UkY2FuY2VsKHJlYXNvbikgewogICAgaWYgKCF0aGlzLmlzQ2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICByZWFzb24gPSByZWFzb24gIT09IHZvaWQgMAogICAgICAgID8gKGNhbkF0dGFjaChyZWFzb24pID8gcmVhc29uIDogbmV3IEVycm9yKHJlYXNvbiArICIiKSkKICAgICAgICA6IG5ldyBDYW5jZWxsYXRpb25FcnJvcigpOwogICAgYXN5bmMuaW52b2tlTGF0ZXIodGhpcy5fY2FuY2VsLCB0aGlzLCByZWFzb24pOwogICAgcmV0dXJuIHRoaXM7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5jYW5jZWxsYWJsZSA9IGZ1bmN0aW9uIFByb21pc2UkY2FuY2VsbGFibGUoKSB7CiAgICBpZiAodGhpcy5fY2FuY2VsbGFibGUoKSkgcmV0dXJuIHRoaXM7CiAgICB0aGlzLl9zZXRDYW5jZWxsYWJsZSgpOwogICAgdGhpcy5fY2FuY2VsbGF0aW9uUGFyZW50ID0gdm9pZCAwOwogICAgcmV0dXJuIHRoaXM7Cn07CgpQcm9taXNlLnByb3RvdHlwZS51bmNhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSR1bmNhbmNlbGxhYmxlKCkgewogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fcHJvcGFnYXRlRnJvbSh0aGlzLCAyIHwgNCk7CiAgICByZXQuX2ZvbGxvdyh0aGlzKTsKICAgIHJldC5fdW5zZXRDYW5jZWxsYWJsZSgpOwogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UucHJvdG90eXBlLmZvcmsgPQpmdW5jdGlvbiBQcm9taXNlJGZvcmsoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcykgewogICAgdmFyIHJldCA9IHRoaXMuX3RoZW4oZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcywKICAgICAgICAgICAgICAgICAgICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKCiAgICByZXQuX3NldENhbmNlbGxhYmxlKCk7CiAgICByZXQuX2NhbmNlbGxhdGlvblBhcmVudCA9IHZvaWQgMDsKICAgIHJldHVybiByZXQ7Cn07Cn07Cgp9LHsiLi9hc3luYy5qcyI6MTgsIi4vZXJyb3JzLmpzIjoyNX1dLDIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmluaGVyaXRzOwp2YXIgZGVmaW5lUHJvcGVydHkgPSByZXF1aXJlKCIuL2VzNS5qcyIpLmRlZmluZVByb3BlcnR5OwoKdmFyIHJpZ25vcmUgPSBuZXcgUmVnRXhwKAogICAgIlxcYig/OlthLXpBLVowLTkuXStcXCRfXFx3K3wiICsKICAgICJ0cnlDYXRjaCg/OjF8MnwzfDR8QXBwbHkpfG5ldyBcXHcqUHJvbWlzZUFycmF5fCIgKwogICAgIlxcdypQcm9taXNlQXJyYXlcXC5cXHcqUHJvbWlzZUFycmF5fCIgKwogICAgInNldFRpbWVvdXR8Q2F0Y2hGaWx0ZXJcXCRfXFx3K3xtYWtlTm9kZVByb21pc2lmaWVkfHByb2Nlc3NJbW1lZGlhdGV8IiArCiAgICAicHJvY2Vzcy5fdGlja0NhbGxiYWNrfG5leHRUaWNrfEFzeW5jXFwkXFx3KylcXGIiCik7Cgp2YXIgcnRyYWNlbGluZSA9IG51bGw7CnZhciBmb3JtYXRTdGFjayA9IG51bGw7CgpmdW5jdGlvbiBmb3JtYXROb25FcnJvcihvYmopIHsKICAgIHZhciBzdHI7CiAgICBpZiAodHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHN0ciA9ICJbZnVuY3Rpb24gIiArCiAgICAgICAgICAgIChvYmoubmFtZSB8fCAiYW5vbnltb3VzIikgKwogICAgICAgICAgICAiXSI7CiAgICB9IGVsc2UgewogICAgICAgIHN0ciA9IG9iai50b1N0cmluZygpOwogICAgICAgIHZhciBydXNlbGVzc1RvU3RyaW5nID0gL1xbb2JqZWN0IFthLXpBLVowLTkkX10rXF0vOwogICAgICAgIGlmIChydXNlbGVzc1RvU3RyaW5nLnRlc3Qoc3RyKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIG5ld1N0ciA9IEpTT04uc3RyaW5naWZ5KG9iaik7CiAgICAgICAgICAgICAgICBzdHIgPSBuZXdTdHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2goZSkgewoKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoc3RyLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBzdHIgPSAiKGVtcHR5IGFycmF5KSI7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuICgiKDwiICsgc25pcChzdHIpICsgIj4sIG5vIHN0YWNrIHRyYWNlKSIpOwp9CgpmdW5jdGlvbiBzbmlwKHN0cikgewogICAgdmFyIG1heENoYXJzID0gNDE7CiAgICBpZiAoc3RyLmxlbmd0aCA8IG1heENoYXJzKSB7CiAgICAgICAgcmV0dXJuIHN0cjsKICAgIH0KICAgIHJldHVybiBzdHIuc3Vic3RyKDAsIG1heENoYXJzIC0gMykgKyAiLi4uIjsKfQoKZnVuY3Rpb24gQ2FwdHVyZWRUcmFjZShpZ25vcmVVbnRpbCwgaXNUb3BMZXZlbCkgewogICAgdGhpcy5jYXB0dXJlU3RhY2tUcmFjZShDYXB0dXJlZFRyYWNlLCBpc1RvcExldmVsKTsKCn0KaW5oZXJpdHMoQ2FwdHVyZWRUcmFjZSwgRXJyb3IpOwoKQ2FwdHVyZWRUcmFjZS5wcm90b3R5cGUuY2FwdHVyZVN0YWNrVHJhY2UgPQpmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJGNhcHR1cmVTdGFja1RyYWNlKGlnbm9yZVVudGlsLCBpc1RvcExldmVsKSB7CiAgICBjYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCBpZ25vcmVVbnRpbCwgaXNUb3BMZXZlbCk7Cn07CgpDYXB0dXJlZFRyYWNlLnBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gQ2FwdHVyZWRUcmFjZSRQb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbihyZWFzb24pIHsKICAgIGlmICh0eXBlb2YgY29uc29sZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICB2YXIgbWVzc2FnZTsKICAgICAgICBpZiAodHlwZW9mIHJlYXNvbiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHJlYXNvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc3RhY2sgPSByZWFzb24uc3RhY2s7CiAgICAgICAgICAgIG1lc3NhZ2UgPSAiUG9zc2libHkgdW5oYW5kbGVkICIgKyBmb3JtYXRTdGFjayhzdGFjaywgcmVhc29uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtZXNzYWdlID0gIlBvc3NpYmx5IHVuaGFuZGxlZCAiICsgU3RyaW5nKHJlYXNvbik7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIiB8fAogICAgICAgICAgICB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb25zb2xlLmxvZyA9PT0gImZ1bmN0aW9uIiB8fAogICAgICAgICAgICB0eXBlb2YgY29uc29sZS5sb2cgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKG1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KfTsKCkNhcHR1cmVkVHJhY2UuY29tYmluZSA9IGZ1bmN0aW9uIENhcHR1cmVkVHJhY2UkQ29tYmluZShjdXJyZW50LCBwcmV2KSB7CiAgICB2YXIgY3VycmVudExhc3RJbmRleCA9IGN1cnJlbnQubGVuZ3RoIC0gMTsKICAgIHZhciBjdXJyZW50TGFzdExpbmUgPSBjdXJyZW50W2N1cnJlbnRMYXN0SW5kZXhdOwogICAgdmFyIGNvbW1vblJvb3RNZWV0UG9pbnQgPSAtMTsKICAgIGZvciAodmFyIGkgPSBwcmV2Lmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7CiAgICAgICAgaWYgKHByZXZbaV0gPT09IGN1cnJlbnRMYXN0TGluZSkgewogICAgICAgICAgICBjb21tb25Sb290TWVldFBvaW50ID0gaTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIGkgPSBjb21tb25Sb290TWVldFBvaW50OyBpID49IDA7IC0taSkgewogICAgICAgIHZhciBsaW5lID0gcHJldltpXTsKICAgICAgICBpZiAoY3VycmVudFtjdXJyZW50TGFzdEluZGV4XSA9PT0gbGluZSkgewogICAgICAgICAgICBjdXJyZW50LnBvcCgpOwogICAgICAgICAgICBjdXJyZW50TGFzdEluZGV4LS07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGN1cnJlbnQucHVzaCgiRnJvbSBwcmV2aW91cyBldmVudDoiKTsKICAgIHZhciBsaW5lcyA9IGN1cnJlbnQuY29uY2F0KHByZXYpOwoKICAgIHZhciByZXQgPSBbXTsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbGluZXMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKCiAgICAgICAgaWYgKCgocmlnbm9yZS50ZXN0KGxpbmVzW2ldKSAmJiBydHJhY2VsaW5lLnRlc3QobGluZXNbaV0pKSB8fAogICAgICAgICAgICAoaSA+IDAgJiYgIXJ0cmFjZWxpbmUudGVzdChsaW5lc1tpXSkpICYmCiAgICAgICAgICAgIGxpbmVzW2ldICE9PSAiRnJvbSBwcmV2aW91cyBldmVudDoiKQogICAgICAgKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICByZXQucHVzaChsaW5lc1tpXSk7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9OwoKQ2FwdHVyZWRUcmFjZS5wcm90ZWN0RXJyb3JNZXNzYWdlTmV3bGluZXMgPSBmdW5jdGlvbihzdGFjaykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdGFjay5sZW5ndGg7ICsraSkgewogICAgICAgIGlmIChydHJhY2VsaW5lLnRlc3Qoc3RhY2tbaV0pKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoaSA8PSAxKSByZXR1cm47CgogICAgdmFyIGVycm9yTWVzc2FnZUxpbmVzID0gW107CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGk7ICsraikgewogICAgICAgIGVycm9yTWVzc2FnZUxpbmVzLnB1c2goc3RhY2suc2hpZnQoKSk7CiAgICB9CiAgICBzdGFjay51bnNoaWZ0KGVycm9yTWVzc2FnZUxpbmVzLmpvaW4oIlx1MDAwMlx1MDAwMFx1MDAwMSIpKTsKfTsKCkNhcHR1cmVkVHJhY2UuaXNTdXBwb3J0ZWQgPSBmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJElzU3VwcG9ydGVkKCkgewogICAgcmV0dXJuIHR5cGVvZiBjYXB0dXJlU3RhY2tUcmFjZSA9PT0gImZ1bmN0aW9uIjsKfTsKCnZhciBjYXB0dXJlU3RhY2tUcmFjZSA9IChmdW5jdGlvbiBzdGFja0RldGVjdGlvbigpIHsKICAgIGlmICh0eXBlb2YgRXJyb3Iuc3RhY2tUcmFjZUxpbWl0ID09PSAibnVtYmVyIiAmJgogICAgICAgIHR5cGVvZiBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJ0cmFjZWxpbmUgPSAvXlxzKmF0XHMqLzsKICAgICAgICBmb3JtYXRTdGFjayA9IGZ1bmN0aW9uKHN0YWNrLCBlcnJvcikgewogICAgICAgICAgICBpZiAodHlwZW9mIHN0YWNrID09PSAic3RyaW5nIikgcmV0dXJuIHN0YWNrOwoKICAgICAgICAgICAgaWYgKGVycm9yLm5hbWUgIT09IHZvaWQgMCAmJgogICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3IubmFtZSArICIuICIgKyBlcnJvci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7CgoKICAgICAgICB9OwogICAgICAgIHZhciBjYXB0dXJlU3RhY2tUcmFjZSA9IEVycm9yLmNhcHR1cmVTdGFja1RyYWNlOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBDYXB0dXJlZFRyYWNlJF9jYXB0dXJlU3RhY2tUcmFjZSgKICAgICAgICAgICAgcmVjZWl2ZXIsIGlnbm9yZVVudGlsKSB7CiAgICAgICAgICAgIGNhcHR1cmVTdGFja1RyYWNlKHJlY2VpdmVyLCBpZ25vcmVVbnRpbCk7CiAgICAgICAgfTsKICAgIH0KICAgIHZhciBlcnIgPSBuZXcgRXJyb3IoKTsKCiAgICBpZiAodHlwZW9mIGVyci5zdGFjayA9PT0gInN0cmluZyIgJiYKICAgICAgICB0eXBlb2YgIiIuc3RhcnRzV2l0aCA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgIChlcnIuc3RhY2suc3RhcnRzV2l0aCgic3RhY2tEZXRlY3Rpb25AIikpICYmCiAgICAgICAgc3RhY2tEZXRlY3Rpb24ubmFtZSA9PT0gInN0YWNrRGV0ZWN0aW9uIikgewoKICAgICAgICBkZWZpbmVQcm9wZXJ0eShFcnJvciwgInN0YWNrVHJhY2VMaW1pdCIsIHsKICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICB2YWx1ZTogMjUKICAgICAgICB9KTsKICAgICAgICBydHJhY2VsaW5lID0gL0AvOwogICAgICAgIHZhciBybGluZSA9IC9bQFxuXS87CgogICAgICAgIGZvcm1hdFN0YWNrID0gZnVuY3Rpb24oc3RhY2ssIGVycm9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gKGVycm9yLm5hbWUgKyAiLiAiICsgZXJyb3IubWVzc2FnZSArICJcbiIgKyBzdGFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChlcnJvci5uYW1lICE9PSB2b2lkIDAgJiYKICAgICAgICAgICAgICAgIGVycm9yLm1lc3NhZ2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVycm9yLm5hbWUgKyAiLiAiICsgZXJyb3IubWVzc2FnZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZm9ybWF0Tm9uRXJyb3IoZXJyb3IpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBmdW5jdGlvbiBjYXB0dXJlU3RhY2tUcmFjZShvKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrOwogICAgICAgICAgICB2YXIgc3BsaXQgPSBzdGFjay5zcGxpdChybGluZSk7CiAgICAgICAgICAgIHZhciBsZW4gPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgICAgIHZhciByZXQgPSAiIjsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkgKz0gMikgewogICAgICAgICAgICAgICAgcmV0ICs9IHNwbGl0W2ldOwogICAgICAgICAgICAgICAgcmV0ICs9ICJAIjsKICAgICAgICAgICAgICAgIHJldCArPSBzcGxpdFtpICsgMV07CiAgICAgICAgICAgICAgICByZXQgKz0gIlxuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBvLnN0YWNrID0gcmV0OwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIGZvcm1hdFN0YWNrID0gZnVuY3Rpb24oc3RhY2ssIGVycm9yKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhY2sgPT09ICJzdHJpbmciKSByZXR1cm4gc3RhY2s7CgogICAgICAgICAgICBpZiAoKHR5cGVvZiBlcnJvciA9PT0gIm9iamVjdCIgfHwKICAgICAgICAgICAgICAgIHR5cGVvZiBlcnJvciA9PT0gImZ1bmN0aW9uIikgJiYKICAgICAgICAgICAgICAgIGVycm9yLm5hbWUgIT09IHZvaWQgMCAmJgogICAgICAgICAgICAgICAgZXJyb3IubWVzc2FnZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3IubmFtZSArICIuICIgKyBlcnJvci5tZXNzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmb3JtYXROb25FcnJvcihlcnJvcik7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9Cn0pKCk7CgpyZXR1cm4gQ2FwdHVyZWRUcmFjZTsKfTsKCn0seyIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKE5FWFRfRklMVEVSKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgdHJ5Q2F0Y2gxID0gdXRpbC50cnlDYXRjaDE7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CnZhciBrZXlzID0gcmVxdWlyZSgiLi9lczUuanMiKS5rZXlzOwp2YXIgVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjsKCmZ1bmN0aW9uIENhdGNoRmlsdGVyKGluc3RhbmNlcywgY2FsbGJhY2ssIHByb21pc2UpIHsKICAgIHRoaXMuX2luc3RhbmNlcyA9IGluc3RhbmNlczsKICAgIHRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZTsKfQoKZnVuY3Rpb24gQ2F0Y2hGaWx0ZXIkX3NhZmVQcmVkaWNhdGUocHJlZGljYXRlLCBlKSB7CiAgICB2YXIgc2FmZU9iamVjdCA9IHt9OwogICAgdmFyIHJldGZpbHRlciA9IHRyeUNhdGNoMShwcmVkaWNhdGUsIHNhZmVPYmplY3QsIGUpOwoKICAgIGlmIChyZXRmaWx0ZXIgPT09IGVycm9yT2JqKSByZXR1cm4gcmV0ZmlsdGVyOwoKICAgIHZhciBzYWZlS2V5cyA9IGtleXMoc2FmZU9iamVjdCk7CiAgICBpZiAoc2FmZUtleXMubGVuZ3RoKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IG5ldyBUeXBlRXJyb3IoCiAgICAgICAgICAgICJDYXRjaCBmaWx0ZXIgbXVzdCBpbmhlcml0IGZyb20gRXJyb3IgIgogICAgICAgICAgKyAib3IgYmUgYSBzaW1wbGUgcHJlZGljYXRlIGZ1bmN0aW9uIik7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQogICAgcmV0dXJuIHJldGZpbHRlcjsKfQoKQ2F0Y2hGaWx0ZXIucHJvdG90eXBlLmRvRmlsdGVyID0gZnVuY3Rpb24gQ2F0Y2hGaWx0ZXIkX2RvRmlsdGVyKGUpIHsKICAgIHZhciBjYiA9IHRoaXMuX2NhbGxiYWNrOwogICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlOwogICAgdmFyIGJvdW5kVG8gPSBwcm9taXNlLl9ib3VuZFRvOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2luc3RhbmNlcy5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBpdGVtID0gdGhpcy5faW5zdGFuY2VzW2ldOwogICAgICAgIHZhciBpdGVtSXNFcnJvclR5cGUgPSBpdGVtID09PSBFcnJvciB8fAogICAgICAgICAgICAoaXRlbSAhPSBudWxsICYmIGl0ZW0ucHJvdG90eXBlIGluc3RhbmNlb2YgRXJyb3IpOwoKICAgICAgICBpZiAoaXRlbUlzRXJyb3JUeXBlICYmIGUgaW5zdGFuY2VvZiBpdGVtKSB7CiAgICAgICAgICAgIHZhciByZXQgPSB0cnlDYXRjaDEoY2IsIGJvdW5kVG8sIGUpOwogICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgTkVYVF9GSUxURVIuZSA9IHJldC5lOwogICAgICAgICAgICAgICAgcmV0dXJuIE5FWFRfRklMVEVSOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiAmJiAhaXRlbUlzRXJyb3JUeXBlKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRIYW5kbGUgPSBDYXRjaEZpbHRlciRfc2FmZVByZWRpY2F0ZShpdGVtLCBlKTsKICAgICAgICAgICAgaWYgKHNob3VsZEhhbmRsZSA9PT0gZXJyb3JPYmopIHsKICAgICAgICAgICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2goZXJyb3JPYmouZSkKICAgICAgICAgICAgICAgICAgICA/IGVycm9yT2JqLmUKICAgICAgICAgICAgICAgICAgICA6IG5ldyBFcnJvcihlcnJvck9iai5lICsgIiIpOwogICAgICAgICAgICAgICAgdGhpcy5fcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgICAgICAgICBlID0gZXJyb3JPYmouZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgaWYgKHNob3VsZEhhbmRsZSkgewogICAgICAgICAgICAgICAgdmFyIHJldCA9IHRyeUNhdGNoMShjYiwgYm91bmRUbywgZSk7CiAgICAgICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgICAgIE5FWFRfRklMVEVSLmUgPSByZXQuZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTkVYVF9GSUxURVI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgTkVYVF9GSUxURVIuZSA9IGU7CiAgICByZXR1cm4gTkVYVF9GSUxURVI7Cn07CgpyZXR1cm4gQ2F0Y2hGaWx0ZXI7Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwyMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwp2YXIgaXNQcmltaXRpdmUgPSB1dGlsLmlzUHJpbWl0aXZlOwp2YXIgd3JhcHNQcmltaXRpdmVSZWNlaXZlciA9IHV0aWwud3JhcHNQcmltaXRpdmVSZWNlaXZlcjsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSkgewp2YXIgcmV0dXJuZXIgPSBmdW5jdGlvbiBQcm9taXNlJF9yZXR1cm5lcigpIHsKICAgIHJldHVybiB0aGlzOwp9Owp2YXIgdGhyb3dlciA9IGZ1bmN0aW9uIFByb21pc2UkX3Rocm93ZXIoKSB7CiAgICB0aHJvdyB0aGlzOwp9OwoKdmFyIHdyYXBwZXIgPSBmdW5jdGlvbiBQcm9taXNlJF93cmFwcGVyKHZhbHVlLCBhY3Rpb24pIHsKICAgIGlmIChhY3Rpb24gPT09IDEpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfdGhyb3dlcigpIHsKICAgICAgICAgICAgdGhyb3cgdmFsdWU7CiAgICAgICAgfTsKICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAyKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIFByb21pc2UkX3JldHVybmVyKCkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfTsKICAgIH0KfTsKCgpQcm9taXNlLnByb3RvdHlwZVsicmV0dXJuIl0gPQpQcm9taXNlLnByb3RvdHlwZS50aGVuUmV0dXJuID0KZnVuY3Rpb24gUHJvbWlzZSR0aGVuUmV0dXJuKHZhbHVlKSB7CiAgICBpZiAod3JhcHNQcmltaXRpdmVSZWNlaXZlciAmJiBpc1ByaW1pdGl2ZSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdGhlbigKICAgICAgICAgICAgd3JhcHBlcih2YWx1ZSwgMiksCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMAogICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl90aGVuKHJldHVybmVyLCB2b2lkIDAsIHZvaWQgMCwgdmFsdWUsIHZvaWQgMCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZVsidGhyb3ciXSA9ClByb21pc2UucHJvdG90eXBlLnRoZW5UaHJvdyA9CmZ1bmN0aW9uIFByb21pc2UkdGhlblRocm93KHJlYXNvbikgewogICAgaWYgKHdyYXBzUHJpbWl0aXZlUmVjZWl2ZXIgJiYgaXNQcmltaXRpdmUocmVhc29uKSkgewogICAgICAgIHJldHVybiB0aGlzLl90aGVuKAogICAgICAgICAgICB3cmFwcGVyKHJlYXNvbiwgMSksCiAgICAgICAgICAgIHZvaWQgMCwKICAgICAgICAgICAgdm9pZCAwLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHZvaWQgMAogICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl90aGVuKHRocm93ZXIsIHZvaWQgMCwgdm9pZCAwLCByZWFzb24sIHZvaWQgMCk7Cn07Cn07Cgp9LHsiLi91dGlsLmpzIjo1MH1dLDI0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHsKdmFyIFByb21pc2VSZWR1Y2UgPSBQcm9taXNlLnJlZHVjZTsKClByb21pc2UucHJvdG90eXBlLmVhY2ggPSBmdW5jdGlvbiBQcm9taXNlJGVhY2goZm4pIHsKICAgIHJldHVybiBQcm9taXNlUmVkdWNlKHRoaXMsIGZuLCBudWxsLCBJTlRFUk5BTCk7Cn07CgpQcm9taXNlLmVhY2ggPSBmdW5jdGlvbiBQcm9taXNlJEVhY2gocHJvbWlzZXMsIGZuKSB7CiAgICByZXR1cm4gUHJvbWlzZVJlZHVjZShwcm9taXNlcywgZm4sIG51bGwsIElOVEVSTkFMKTsKfTsKfTsKCn0se31dLDI1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7CnZhciBPYmplY3RmcmVlemUgPSByZXF1aXJlKCIuL2VzNS5qcyIpLmZyZWV6ZTsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGluaGVyaXRzID0gdXRpbC5pbmhlcml0czsKdmFyIG5vdEVudW1lcmFibGVQcm9wID0gdXRpbC5ub3RFbnVtZXJhYmxlUHJvcDsKCmZ1bmN0aW9uIG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihlKSB7CiAgICB0cnkgewogICAgICAgIG5vdEVudW1lcmFibGVQcm9wKGUsICJpc09wZXJhdGlvbmFsIiwgdHJ1ZSk7CiAgICB9CiAgICBjYXRjaChpZ25vcmUpIHt9Cn0KCmZ1bmN0aW9uIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uKGUpIHsKICAgIGlmIChlID09IG51bGwpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiAoKGUgaW5zdGFuY2VvZiBPcGVyYXRpb25hbEVycm9yKSB8fAogICAgICAgIGVbImlzT3BlcmF0aW9uYWwiXSA9PT0gdHJ1ZSk7Cn0KCmZ1bmN0aW9uIGlzRXJyb3Iob2JqKSB7CiAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgRXJyb3I7Cn0KCmZ1bmN0aW9uIGNhbkF0dGFjaChvYmopIHsKICAgIHJldHVybiBpc0Vycm9yKG9iaik7Cn0KCmZ1bmN0aW9uIHN1YkVycm9yKG5hbWVQcm9wZXJ0eSwgZGVmYXVsdE1lc3NhZ2UpIHsKICAgIGZ1bmN0aW9uIFN1YkVycm9yKG1lc3NhZ2UpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU3ViRXJyb3IpKSByZXR1cm4gbmV3IFN1YkVycm9yKG1lc3NhZ2UpOwogICAgICAgIHRoaXMubWVzc2FnZSA9IHR5cGVvZiBtZXNzYWdlID09PSAic3RyaW5nIiA/IG1lc3NhZ2UgOiBkZWZhdWx0TWVzc2FnZTsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lUHJvcGVydHk7CiAgICAgICAgaWYgKEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKSB7CiAgICAgICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIHRoaXMuY29uc3RydWN0b3IpOwogICAgICAgIH0KICAgIH0KICAgIGluaGVyaXRzKFN1YkVycm9yLCBFcnJvcik7CiAgICByZXR1cm4gU3ViRXJyb3I7Cn0KCnZhciBfVHlwZUVycm9yLCBfUmFuZ2VFcnJvcjsKdmFyIENhbmNlbGxhdGlvbkVycm9yID0gc3ViRXJyb3IoIkNhbmNlbGxhdGlvbkVycm9yIiwgImNhbmNlbGxhdGlvbiBlcnJvciIpOwp2YXIgVGltZW91dEVycm9yID0gc3ViRXJyb3IoIlRpbWVvdXRFcnJvciIsICJ0aW1lb3V0IGVycm9yIik7CnZhciBBZ2dyZWdhdGVFcnJvciA9IHN1YkVycm9yKCJBZ2dyZWdhdGVFcnJvciIsICJhZ2dyZWdhdGUgZXJyb3IiKTsKdHJ5IHsKICAgIF9UeXBlRXJyb3IgPSBUeXBlRXJyb3I7CiAgICBfUmFuZ2VFcnJvciA9IFJhbmdlRXJyb3I7Cn0gY2F0Y2goZSkgewogICAgX1R5cGVFcnJvciA9IHN1YkVycm9yKCJUeXBlRXJyb3IiLCAidHlwZSBlcnJvciIpOwogICAgX1JhbmdlRXJyb3IgPSBzdWJFcnJvcigiUmFuZ2VFcnJvciIsICJyYW5nZSBlcnJvciIpOwp9Cgp2YXIgbWV0aG9kcyA9ICgiam9pbiBwb3AgcHVzaCBzaGlmdCB1bnNoaWZ0IHNsaWNlIGZpbHRlciBmb3JFYWNoIHNvbWUgIiArCiAgICAiZXZlcnkgbWFwIGluZGV4T2YgbGFzdEluZGV4T2YgcmVkdWNlIHJlZHVjZVJpZ2h0IHNvcnQgcmV2ZXJzZSIpLnNwbGl0KCIgIik7Cgpmb3IgKHZhciBpID0gMDsgaSA8IG1ldGhvZHMubGVuZ3RoOyArK2kpIHsKICAgIGlmICh0eXBlb2YgQXJyYXkucHJvdG90eXBlW21ldGhvZHNbaV1dID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgQWdncmVnYXRlRXJyb3IucHJvdG90eXBlW21ldGhvZHNbaV1dID0gQXJyYXkucHJvdG90eXBlW21ldGhvZHNbaV1dOwogICAgfQp9CgpBZ2dyZWdhdGVFcnJvci5wcm90b3R5cGUubGVuZ3RoID0gMDsKQWdncmVnYXRlRXJyb3IucHJvdG90eXBlWyJpc09wZXJhdGlvbmFsIl0gPSB0cnVlOwp2YXIgbGV2ZWwgPSAwOwpBZ2dyZWdhdGVFcnJvci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBpbmRlbnQgPSBBcnJheShsZXZlbCAqIDQgKyAxKS5qb2luKCIgIik7CiAgICB2YXIgcmV0ID0gIlxuIiArIGluZGVudCArICJBZ2dyZWdhdGVFcnJvciBvZjoiICsgIlxuIjsKICAgIGxldmVsKys7CiAgICBpbmRlbnQgPSBBcnJheShsZXZlbCAqIDQgKyAxKS5qb2luKCIgIik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyArK2kpIHsKICAgICAgICB2YXIgc3RyID0gdGhpc1tpXSA9PT0gdGhpcyA/ICJbQ2lyY3VsYXIgQWdncmVnYXRlRXJyb3JdIiA6IHRoaXNbaV0gKyAiIjsKICAgICAgICB2YXIgbGluZXMgPSBzdHIuc3BsaXQoIlxuIik7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBsaW5lcy5sZW5ndGg7ICsraikgewogICAgICAgICAgICBsaW5lc1tqXSA9IGluZGVudCArIGxpbmVzW2pdOwogICAgICAgIH0KICAgICAgICBzdHIgPSBsaW5lcy5qb2luKCJcbiIpOwogICAgICAgIHJldCArPSBzdHIgKyAiXG4iOwogICAgfQogICAgbGV2ZWwtLTsKICAgIHJldHVybiByZXQ7Cn07CgpmdW5jdGlvbiBPcGVyYXRpb25hbEVycm9yKG1lc3NhZ2UpIHsKICAgIHRoaXMubmFtZSA9ICJPcGVyYXRpb25hbEVycm9yIjsKICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2U7CiAgICB0aGlzLmNhdXNlID0gbWVzc2FnZTsKICAgIHRoaXNbImlzT3BlcmF0aW9uYWwiXSA9IHRydWU7CgogICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2UubWVzc2FnZTsKICAgICAgICB0aGlzLnN0YWNrID0gbWVzc2FnZS5zdGFjazsKICAgIH0gZWxzZSBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgICBFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSh0aGlzLCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIH0KCn0KaW5oZXJpdHMoT3BlcmF0aW9uYWxFcnJvciwgRXJyb3IpOwoKdmFyIGtleSA9ICJfX0JsdWViaXJkRXJyb3JUeXBlc19fIjsKdmFyIGVycm9yVHlwZXMgPSBFcnJvcltrZXldOwppZiAoIWVycm9yVHlwZXMpIHsKICAgIGVycm9yVHlwZXMgPSBPYmplY3RmcmVlemUoewogICAgICAgIENhbmNlbGxhdGlvbkVycm9yOiBDYW5jZWxsYXRpb25FcnJvciwKICAgICAgICBUaW1lb3V0RXJyb3I6IFRpbWVvdXRFcnJvciwKICAgICAgICBPcGVyYXRpb25hbEVycm9yOiBPcGVyYXRpb25hbEVycm9yLAogICAgICAgIFJlamVjdGlvbkVycm9yOiBPcGVyYXRpb25hbEVycm9yLAogICAgICAgIEFnZ3JlZ2F0ZUVycm9yOiBBZ2dyZWdhdGVFcnJvcgogICAgfSk7CiAgICBub3RFbnVtZXJhYmxlUHJvcChFcnJvciwga2V5LCBlcnJvclR5cGVzKTsKfQoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgICBFcnJvcjogRXJyb3IsCiAgICBUeXBlRXJyb3I6IF9UeXBlRXJyb3IsCiAgICBSYW5nZUVycm9yOiBfUmFuZ2VFcnJvciwKICAgIENhbmNlbGxhdGlvbkVycm9yOiBlcnJvclR5cGVzLkNhbmNlbGxhdGlvbkVycm9yLAogICAgT3BlcmF0aW9uYWxFcnJvcjogZXJyb3JUeXBlcy5PcGVyYXRpb25hbEVycm9yLAogICAgVGltZW91dEVycm9yOiBlcnJvclR5cGVzLlRpbWVvdXRFcnJvciwKICAgIEFnZ3JlZ2F0ZUVycm9yOiBlcnJvclR5cGVzLkFnZ3JlZ2F0ZUVycm9yLAogICAgb3JpZ2luYXRlc0Zyb21SZWplY3Rpb246IG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uLAogICAgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uOiBtYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24sCiAgICBjYW5BdHRhY2g6IGNhbkF0dGFjaAp9OwoKfSx7Ii4vZXM1LmpzIjoyNywiLi91dGlsLmpzIjo1MH1dLDI2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSkgewp2YXIgVHlwZUVycm9yID0gcmVxdWlyZSgnLi9lcnJvcnMuanMnKS5UeXBlRXJyb3I7CgpmdW5jdGlvbiBhcGlSZWplY3Rpb24obXNnKSB7CiAgICB2YXIgZXJyb3IgPSBuZXcgVHlwZUVycm9yKG1zZyk7CiAgICB2YXIgcmV0ID0gUHJvbWlzZS5yZWplY3RlZChlcnJvcik7CiAgICB2YXIgcGFyZW50ID0gcmV0Ll9wZWVrQ29udGV4dCgpOwogICAgaWYgKHBhcmVudCAhPSBudWxsKSB7CiAgICAgICAgcGFyZW50Ll9hdHRhY2hFeHRyYVRyYWNlKGVycm9yKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KCnJldHVybiBhcGlSZWplY3Rpb247Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1fV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCnZhciBpc0VTNSA9IChmdW5jdGlvbigpewogICAgInVzZSBzdHJpY3QiOwogICAgcmV0dXJuIHRoaXMgPT09IHZvaWQgMDsKfSkoKTsKCmlmIChpc0VTNSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgICAgZnJlZXplOiBPYmplY3QuZnJlZXplLAogICAgICAgIGRlZmluZVByb3BlcnR5OiBPYmplY3QuZGVmaW5lUHJvcGVydHksCiAgICAgICAga2V5czogT2JqZWN0LmtleXMsCiAgICAgICAgZ2V0UHJvdG90eXBlT2Y6IE9iamVjdC5nZXRQcm90b3R5cGVPZiwKICAgICAgICBpc0FycmF5OiBBcnJheS5pc0FycmF5LAogICAgICAgIGlzRVM1OiBpc0VTNQogICAgfTsKfSBlbHNlIHsKICAgIHZhciBoYXMgPSB7fS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBzdHIgPSB7fS50b1N0cmluZzsKICAgIHZhciBwcm90byA9IHt9LmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKCiAgICB2YXIgT2JqZWN0S2V5cyA9IGZ1bmN0aW9uIE9iamVjdEtleXMobykgewogICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gbykgewogICAgICAgICAgICBpZiAoaGFzLmNhbGwobywga2V5KSkgewogICAgICAgICAgICAgICAgcmV0LnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHZhciBPYmplY3REZWZpbmVQcm9wZXJ0eSA9IGZ1bmN0aW9uIE9iamVjdERlZmluZVByb3BlcnR5KG8sIGtleSwgZGVzYykgewogICAgICAgIG9ba2V5XSA9IGRlc2MudmFsdWU7CiAgICAgICAgcmV0dXJuIG87CiAgICB9CgogICAgdmFyIE9iamVjdEZyZWV6ZSA9IGZ1bmN0aW9uIE9iamVjdEZyZWV6ZShvYmopIHsKICAgICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIHZhciBPYmplY3RHZXRQcm90b3R5cGVPZiA9IGZ1bmN0aW9uIE9iamVjdEdldFByb3RvdHlwZU9mKG9iaikgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBPYmplY3Qob2JqKS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBwcm90bzsKICAgICAgICB9CiAgICB9CgogICAgdmFyIEFycmF5SXNBcnJheSA9IGZ1bmN0aW9uIEFycmF5SXNBcnJheShvYmopIHsKICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gc3RyLmNhbGwob2JqKSA9PT0gIltvYmplY3QgQXJyYXldIjsKICAgICAgICB9CiAgICAgICAgY2F0Y2goZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIG1vZHVsZS5leHBvcnRzID0gewogICAgICAgIGlzQXJyYXk6IEFycmF5SXNBcnJheSwKICAgICAgICBrZXlzOiBPYmplY3RLZXlzLAogICAgICAgIGRlZmluZVByb3BlcnR5OiBPYmplY3REZWZpbmVQcm9wZXJ0eSwKICAgICAgICBmcmVlemU6IE9iamVjdEZyZWV6ZSwKICAgICAgICBnZXRQcm90b3R5cGVPZjogT2JqZWN0R2V0UHJvdG90eXBlT2YsCiAgICAgICAgaXNFUzU6IGlzRVM1CiAgICB9Owp9Cgp9LHt9XSwyODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBQcm9taXNlTWFwID0gUHJvbWlzZS5tYXA7CgpQcm9taXNlLnByb3RvdHlwZS5maWx0ZXIgPSBmdW5jdGlvbiBQcm9taXNlJGZpbHRlcihmbiwgb3B0aW9ucykgewogICAgcmV0dXJuIFByb21pc2VNYXAodGhpcywgZm4sIG9wdGlvbnMsIElOVEVSTkFMKTsKfTsKClByb21pc2UuZmlsdGVyID0gZnVuY3Rpb24gUHJvbWlzZSRGaWx0ZXIocHJvbWlzZXMsIGZuLCBvcHRpb25zKSB7CiAgICByZXR1cm4gUHJvbWlzZU1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIElOVEVSTkFMKTsKfTsKfTsKCn0se31dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgTkVYVF9GSUxURVIsIGNhc3QpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIHdyYXBzUHJpbWl0aXZlUmVjZWl2ZXIgPSB1dGlsLndyYXBzUHJpbWl0aXZlUmVjZWl2ZXI7CnZhciBpc1ByaW1pdGl2ZSA9IHV0aWwuaXNQcmltaXRpdmU7CnZhciB0aHJvd2VyID0gdXRpbC50aHJvd2VyOwoKZnVuY3Rpb24gcmV0dXJuVGhpcygpIHsKICAgIHJldHVybiB0aGlzOwp9CmZ1bmN0aW9uIHRocm93VGhpcygpIHsKICAgIHRocm93IHRoaXM7Cn0KZnVuY3Rpb24gcmV0dXJuJChyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfcmV0dXJuZXIoKSB7CiAgICAgICAgcmV0dXJuIHI7CiAgICB9Owp9CmZ1bmN0aW9uIHRocm93JChyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gUHJvbWlzZSRfdGhyb3dlcigpIHsKICAgICAgICB0aHJvdyByOwogICAgfTsKfQpmdW5jdGlvbiBwcm9taXNlZEZpbmFsbHkocmV0LCByZWFzb25PclZhbHVlLCBpc0Z1bGZpbGxlZCkgewogICAgdmFyIHRoZW47CiAgICBpZiAod3JhcHNQcmltaXRpdmVSZWNlaXZlciAmJiBpc1ByaW1pdGl2ZShyZWFzb25PclZhbHVlKSkgewogICAgICAgIHRoZW4gPSBpc0Z1bGZpbGxlZCA/IHJldHVybiQocmVhc29uT3JWYWx1ZSkgOiB0aHJvdyQocmVhc29uT3JWYWx1ZSk7CiAgICB9IGVsc2UgewogICAgICAgIHRoZW4gPSBpc0Z1bGZpbGxlZCA/IHJldHVyblRoaXMgOiB0aHJvd1RoaXM7CiAgICB9CiAgICByZXR1cm4gcmV0Ll90aGVuKHRoZW4sIHRocm93ZXIsIHZvaWQgMCwgcmVhc29uT3JWYWx1ZSwgdm9pZCAwKTsKfQoKZnVuY3Rpb24gZmluYWxseUhhbmRsZXIocmVhc29uT3JWYWx1ZSkgewogICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CiAgICB2YXIgaGFuZGxlciA9IHRoaXMuaGFuZGxlcjsKCiAgICB2YXIgcmV0ID0gcHJvbWlzZS5faXNCb3VuZCgpCiAgICAgICAgICAgICAgICAgICAgPyBoYW5kbGVyLmNhbGwocHJvbWlzZS5fYm91bmRUbykKICAgICAgICAgICAgICAgICAgICA6IGhhbmRsZXIoKTsKCiAgICBpZiAocmV0ICE9PSB2b2lkIDApIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXQsIHZvaWQgMCk7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2VkRmluYWxseShtYXliZVByb21pc2UsIHJlYXNvbk9yVmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb21pc2UuaXNGdWxmaWxsZWQoKSk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChwcm9taXNlLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIE5FWFRfRklMVEVSLmUgPSByZWFzb25PclZhbHVlOwogICAgICAgIHJldHVybiBORVhUX0ZJTFRFUjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHJlYXNvbk9yVmFsdWU7CiAgICB9Cn0KCmZ1bmN0aW9uIHRhcEhhbmRsZXIodmFsdWUpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5wcm9taXNlOwogICAgdmFyIGhhbmRsZXIgPSB0aGlzLmhhbmRsZXI7CgogICAgdmFyIHJldCA9IHByb21pc2UuX2lzQm91bmQoKQogICAgICAgICAgICAgICAgICAgID8gaGFuZGxlci5jYWxsKHByb21pc2UuX2JvdW5kVG8sIHZhbHVlKQogICAgICAgICAgICAgICAgICAgIDogaGFuZGxlcih2YWx1ZSk7CgogICAgaWYgKHJldCAhPT0gdm9pZCAwKSB7CiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocmV0LCB2b2lkIDApOwogICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlZEZpbmFsbHkobWF5YmVQcm9taXNlLCB2YWx1ZSwgdHJ1ZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHZhbHVlOwp9CgpQcm9taXNlLnByb3RvdHlwZS5fcGFzc1Rocm91Z2hIYW5kbGVyID0KZnVuY3Rpb24gUHJvbWlzZSRfcGFzc1Rocm91Z2hIYW5kbGVyKGhhbmRsZXIsIGlzRmluYWxseSkgewogICAgaWYgKHR5cGVvZiBoYW5kbGVyICE9PSAiZnVuY3Rpb24iKSByZXR1cm4gdGhpcy50aGVuKCk7CgogICAgdmFyIHByb21pc2VBbmRIYW5kbGVyID0gewogICAgICAgIHByb21pc2U6IHRoaXMsCiAgICAgICAgaGFuZGxlcjogaGFuZGxlcgogICAgfTsKCiAgICByZXR1cm4gdGhpcy5fdGhlbigKICAgICAgICAgICAgaXNGaW5hbGx5ID8gZmluYWxseUhhbmRsZXIgOiB0YXBIYW5kbGVyLAogICAgICAgICAgICBpc0ZpbmFsbHkgPyBmaW5hbGx5SGFuZGxlciA6IHZvaWQgMCwgdm9pZCAwLAogICAgICAgICAgICBwcm9taXNlQW5kSGFuZGxlciwgdm9pZCAwKTsKfTsKClByb21pc2UucHJvdG90eXBlLmxhc3RseSA9ClByb21pc2UucHJvdG90eXBlWyJmaW5hbGx5Il0gPSBmdW5jdGlvbiBQcm9taXNlJGZpbmFsbHkoaGFuZGxlcikgewogICAgcmV0dXJuIHRoaXMuX3Bhc3NUaHJvdWdoSGFuZGxlcihoYW5kbGVyLCB0cnVlKTsKfTsKClByb21pc2UucHJvdG90eXBlLnRhcCA9IGZ1bmN0aW9uIFByb21pc2UkdGFwKGhhbmRsZXIpIHsKICAgIHJldHVybiB0aGlzLl9wYXNzVGhyb3VnaEhhbmRsZXIoaGFuZGxlciwgZmFsc2UpOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIGFwaVJlamVjdGlvbiwgSU5URVJOQUwsIGNhc3QpIHsKdmFyIGVycm9ycyA9IHJlcXVpcmUoIi4vZXJyb3JzLmpzIik7CnZhciBUeXBlRXJyb3IgPSBlcnJvcnMuVHlwZUVycm9yOwp2YXIgZGVwcmVjYXRlZCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmRlcHJlY2F0ZWQ7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIHlpZWxkSGFuZGxlcnMgPSBbXTsKCmZ1bmN0aW9uIHByb21pc2VGcm9tWWllbGRIYW5kbGVyKHZhbHVlLCB5aWVsZEhhbmRsZXJzKSB7CiAgICB2YXIgX2Vycm9yT2JqID0gZXJyb3JPYmo7CiAgICB2YXIgX1Byb21pc2UgPSBQcm9taXNlOwogICAgdmFyIGxlbiA9IHlpZWxkSGFuZGxlcnMubGVuZ3RoOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciByZXN1bHQgPSB0cnlDYXRjaDEoeWllbGRIYW5kbGVyc1tpXSwgdm9pZCAwLCB2YWx1ZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gX2Vycm9yT2JqKSB7CiAgICAgICAgICAgIHJldHVybiBfUHJvbWlzZS5yZWplY3QoX2Vycm9yT2JqLmUpOwogICAgICAgIH0KICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXN1bHQsIHByb21pc2VGcm9tWWllbGRIYW5kbGVyKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgX1Byb21pc2UpIHJldHVybiBtYXliZVByb21pc2U7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gUHJvbWlzZVNwYXduKGdlbmVyYXRvckZ1bmN0aW9uLCByZWNlaXZlciwgeWllbGRIYW5kbGVyKSB7CiAgICB2YXIgcHJvbWlzZSA9IHRoaXMuX3Byb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICBwcm9taXNlLl9zZXRUcmFjZSh2b2lkIDApOwogICAgdGhpcy5fZ2VuZXJhdG9yRnVuY3Rpb24gPSBnZW5lcmF0b3JGdW5jdGlvbjsKICAgIHRoaXMuX3JlY2VpdmVyID0gcmVjZWl2ZXI7CiAgICB0aGlzLl9nZW5lcmF0b3IgPSB2b2lkIDA7CiAgICB0aGlzLl95aWVsZEhhbmRsZXJzID0gdHlwZW9mIHlpZWxkSGFuZGxlciA9PT0gImZ1bmN0aW9uIgogICAgICAgID8gW3lpZWxkSGFuZGxlcl0uY29uY2F0KHlpZWxkSGFuZGxlcnMpCiAgICAgICAgOiB5aWVsZEhhbmRsZXJzOwp9CgpQcm9taXNlU3Bhd24ucHJvdG90eXBlLnByb21pc2UgPSBmdW5jdGlvbiBQcm9taXNlU3Bhd24kcHJvbWlzZSgpIHsKICAgIHJldHVybiB0aGlzLl9wcm9taXNlOwp9OwoKUHJvbWlzZVNwYXduLnByb3RvdHlwZS5fcnVuID0gZnVuY3Rpb24gUHJvbWlzZVNwYXduJF9ydW4oKSB7CiAgICB0aGlzLl9nZW5lcmF0b3IgPSB0aGlzLl9nZW5lcmF0b3JGdW5jdGlvbi5jYWxsKHRoaXMuX3JlY2VpdmVyKTsKICAgIHRoaXMuX3JlY2VpdmVyID0KICAgICAgICB0aGlzLl9nZW5lcmF0b3JGdW5jdGlvbiA9IHZvaWQgMDsKICAgIHRoaXMuX25leHQodm9pZCAwKTsKfTsKClByb21pc2VTcGF3bi5wcm90b3R5cGUuX2NvbnRpbnVlID0gZnVuY3Rpb24gUHJvbWlzZVNwYXduJF9jb250aW51ZShyZXN1bHQpIHsKICAgIGlmIChyZXN1bHQgPT09IGVycm9yT2JqKSB7CiAgICAgICAgdGhpcy5fZ2VuZXJhdG9yID0gdm9pZCAwOwogICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmVzdWx0LmUpCiAgICAgICAgICAgID8gcmVzdWx0LmUgOiBuZXcgRXJyb3IocmVzdWx0LmUgKyAiIik7CiAgICAgICAgdGhpcy5fcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgdGhpcy5fcHJvbWlzZS5fcmVqZWN0KHJlc3VsdC5lLCB0cmFjZSk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciB2YWx1ZSA9IHJlc3VsdC52YWx1ZTsKICAgIGlmIChyZXN1bHQuZG9uZSA9PT0gdHJ1ZSkgewogICAgICAgIHRoaXMuX2dlbmVyYXRvciA9IHZvaWQgMDsKICAgICAgICBpZiAoIXRoaXMuX3Byb21pc2UuX3RyeUZvbGxvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgICAgICBpZiAoIShtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UgPQogICAgICAgICAgICAgICAgcHJvbWlzZUZyb21ZaWVsZEhhbmRsZXIobWF5YmVQcm9taXNlLCB0aGlzLl95aWVsZEhhbmRsZXJzKTsKICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5fdGhyb3cobmV3IFR5cGVFcnJvcigiQSB2YWx1ZSB3YXMgeWllbGRlZCB0aGF0IGNvdWxkIG5vdCBiZSB0cmVhdGVkIGFzIGEgcHJvbWlzZSIpKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oCiAgICAgICAgICAgIHRoaXMuX25leHQsCiAgICAgICAgICAgIHRoaXMuX3Rocm93LAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIG51bGwKICAgICAgICk7CiAgICB9Cn07CgpQcm9taXNlU3Bhd24ucHJvdG90eXBlLl90aHJvdyA9IGZ1bmN0aW9uIFByb21pc2VTcGF3biRfdGhyb3cocmVhc29uKSB7CiAgICBpZiAoZXJyb3JzLmNhbkF0dGFjaChyZWFzb24pKQogICAgICAgIHRoaXMuX3Byb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UocmVhc29uKTsKICAgIHRoaXMuX2NvbnRpbnVlKAogICAgICAgIHRyeUNhdGNoMSh0aGlzLl9nZW5lcmF0b3JbInRocm93Il0sIHRoaXMuX2dlbmVyYXRvciwgcmVhc29uKQogICApOwp9OwoKUHJvbWlzZVNwYXduLnByb3RvdHlwZS5fbmV4dCA9IGZ1bmN0aW9uIFByb21pc2VTcGF3biRfbmV4dCh2YWx1ZSkgewogICAgdGhpcy5fY29udGludWUoCiAgICAgICAgdHJ5Q2F0Y2gxKHRoaXMuX2dlbmVyYXRvci5uZXh0LCB0aGlzLl9nZW5lcmF0b3IsIHZhbHVlKQogICApOwp9OwoKUHJvbWlzZS5jb3JvdXRpbmUgPQpmdW5jdGlvbiBQcm9taXNlJENvcm91dGluZShnZW5lcmF0b3JGdW5jdGlvbiwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBnZW5lcmF0b3JGdW5jdGlvbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImdlbmVyYXRvckZ1bmN0aW9uIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgdmFyIHlpZWxkSGFuZGxlciA9IE9iamVjdChvcHRpb25zKS55aWVsZEhhbmRsZXI7CiAgICB2YXIgUHJvbWlzZVNwYXduJCA9IFByb21pc2VTcGF3bjsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGdlbmVyYXRvciA9IGdlbmVyYXRvckZ1bmN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgdmFyIHNwYXduID0gbmV3IFByb21pc2VTcGF3biQodm9pZCAwLCB2b2lkIDAsIHlpZWxkSGFuZGxlcik7CiAgICAgICAgc3Bhd24uX2dlbmVyYXRvciA9IGdlbmVyYXRvcjsKICAgICAgICBzcGF3bi5fbmV4dCh2b2lkIDApOwogICAgICAgIHJldHVybiBzcGF3bi5wcm9taXNlKCk7CiAgICB9Owp9OwoKUHJvbWlzZS5jb3JvdXRpbmUuYWRkWWllbGRIYW5kbGVyID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgeWllbGRIYW5kbGVycy5wdXNoKGZuKTsKfTsKClByb21pc2Uuc3Bhd24gPSBmdW5jdGlvbiBQcm9taXNlJFNwYXduKGdlbmVyYXRvckZ1bmN0aW9uKSB7CiAgICBkZXByZWNhdGVkKCJQcm9taXNlLnNwYXduIGlzIGRlcHJlY2F0ZWQuIFVzZSBQcm9taXNlLmNvcm91dGluZSBpbnN0ZWFkLiIpOwogICAgaWYgKHR5cGVvZiBnZW5lcmF0b3JGdW5jdGlvbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImdlbmVyYXRvckZ1bmN0aW9uIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgdmFyIHNwYXduID0gbmV3IFByb21pc2VTcGF3bihnZW5lcmF0b3JGdW5jdGlvbiwgdGhpcyk7CiAgICB2YXIgcmV0ID0gc3Bhd24ucHJvbWlzZSgpOwogICAgc3Bhd24uX3J1bihQcm9taXNlLnNwYXduKTsKICAgIHJldHVybiByZXQ7Cn07Cn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sMzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPQpmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXksIGNhc3QsIElOVEVSTkFMKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKCgppZiAoY2FuRXZhbHVhdGUpIHsKICAgIHZhciB0aGVuQ2FsbGJhY2sgPSBmdW5jdGlvbihpKSB7CiAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbigidmFsdWUiLCAiaG9sZGVyIiwgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICd1c2Ugc3RyaWN0JzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIGhvbGRlci5wSW5kZXggPSB2YWx1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIGhvbGRlci5jaGVja0Z1bGZpbGxtZW50KHRoaXMpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICIucmVwbGFjZSgvSW5kZXgvZywgaSkpOwogICAgfTsKCiAgICB2YXIgY2FsbGVyID0gZnVuY3Rpb24oY291bnQpIHsKICAgICAgICB2YXIgdmFsdWVzID0gW107CiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gY291bnQ7ICsraSkgdmFsdWVzLnB1c2goImhvbGRlci5wIiArIGkpOwogICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oImhvbGRlciIsICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAndXNlIHN0cmljdCc7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBob2xkZXIuZm47ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICByZXR1cm4gY2FsbGJhY2sodmFsdWVzKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiLnJlcGxhY2UoL3ZhbHVlcy9nLCB2YWx1ZXMuam9pbigiLCAiKSkpOwogICAgfTsKICAgIHZhciB0aGVuQ2FsbGJhY2tzID0gW107CiAgICB2YXIgY2FsbGVycyA9IFt2b2lkIDBdOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gNTsgKytpKSB7CiAgICAgICAgdGhlbkNhbGxiYWNrcy5wdXNoKHRoZW5DYWxsYmFjayhpKSk7CiAgICAgICAgY2FsbGVycy5wdXNoKGNhbGxlcihpKSk7CiAgICB9CgogICAgdmFyIEhvbGRlciA9IGZ1bmN0aW9uKHRvdGFsLCBmbikgewogICAgICAgIHRoaXMucDEgPSB0aGlzLnAyID0gdGhpcy5wMyA9IHRoaXMucDQgPSB0aGlzLnA1ID0gbnVsbDsKICAgICAgICB0aGlzLmZuID0gZm47CiAgICAgICAgdGhpcy50b3RhbCA9IHRvdGFsOwogICAgICAgIHRoaXMubm93ID0gMDsKICAgIH07CgogICAgSG9sZGVyLnByb3RvdHlwZS5jYWxsZXJzID0gY2FsbGVyczsKICAgIEhvbGRlci5wcm90b3R5cGUuY2hlY2tGdWxmaWxsbWVudCA9IGZ1bmN0aW9uKHByb21pc2UpIHsKICAgICAgICB2YXIgbm93ID0gdGhpcy5ub3c7CiAgICAgICAgbm93Kys7CiAgICAgICAgdmFyIHRvdGFsID0gdGhpcy50b3RhbDsKICAgICAgICBpZiAobm93ID49IHRvdGFsKSB7CiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5jYWxsZXJzW3RvdGFsXTsKICAgICAgICAgICAgdmFyIHJldCA9IHRyeUNhdGNoMShoYW5kbGVyLCB2b2lkIDAsIHRoaXMpOwogICAgICAgICAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0VW5jaGVja2VkKHJldC5lKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvbWlzZS5fdHJ5Rm9sbG93KHJldCkpIHsKICAgICAgICAgICAgICAgIHByb21pc2UuX2Z1bGZpbGxVbmNoZWNrZWQocmV0KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMubm93ID0gbm93OwogICAgICAgIH0KICAgIH07Cn0KCgoKClByb21pc2Uuam9pbiA9IGZ1bmN0aW9uIFByb21pc2UkSm9pbigpIHsKICAgIHZhciBsYXN0ID0gYXJndW1lbnRzLmxlbmd0aCAtIDE7CiAgICB2YXIgZm47CiAgICBpZiAobGFzdCA+IDAgJiYgdHlwZW9mIGFyZ3VtZW50c1tsYXN0XSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGZuID0gYXJndW1lbnRzW2xhc3RdOwogICAgICAgIGlmIChsYXN0IDwgNiAmJiBjYW5FdmFsdWF0ZSkgewogICAgICAgICAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgICAgICByZXQuX3NldFRyYWNlKHZvaWQgMCk7CiAgICAgICAgICAgIHZhciBob2xkZXIgPSBuZXcgSG9sZGVyKGxhc3QsIGZuKTsKICAgICAgICAgICAgdmFyIHJlamVjdCA9IHJldC5fcmVqZWN0OwogICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gdGhlbkNhbGxiYWNrczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsYXN0OyArK2kpIHsKICAgICAgICAgICAgICAgIHZhciBtYXliZVByb21pc2UgPSBjYXN0KGFyZ3VtZW50c1tpXSwgdm9pZCAwKTsKICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3RoZW4oY2FsbGJhY2tzW2ldLCByZWplY3QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2b2lkIDAsIHJldCwgaG9sZGVyKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXS5jYWxsKHJldCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlLl9zZXR0bGVkVmFsdWUsIGhvbGRlcik7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0Ll9yZWplY3QobWF5YmVQcm9taXNlLl9zZXR0bGVkVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrc1tpXS5jYWxsKHJldCwgbWF5YmVQcm9taXNlLCBob2xkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfQogICAgfQogICAgdmFyICRfbGVuID0gYXJndW1lbnRzLmxlbmd0aDt2YXIgYXJncyA9IG5ldyBBcnJheSgkX2xlbik7IGZvcih2YXIgJF9pID0gMDsgJF9pIDwgJF9sZW47ICsrJF9pKSB7YXJnc1skX2ldID0gYXJndW1lbnRzWyRfaV07fQogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlQXJyYXkoYXJncykucHJvbWlzZSgpOwogICAgcmV0dXJuIGZuICE9PSB2b2lkIDAgPyByZXQuc3ByZWFkKGZuKSA6IHJldDsKfTsKCn07Cgp9LHsiLi91dGlsLmpzIjo1MH1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgUHJvbWlzZUFycmF5LCBhcGlSZWplY3Rpb24sIGNhc3QsIElOVEVSTkFMKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciB0cnlDYXRjaDMgPSB1dGlsLnRyeUNhdGNoMzsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKdmFyIFBFTkRJTkcgPSB7fTsKdmFyIEVNUFRZX0FSUkFZID0gW107CgpmdW5jdGlvbiBNYXBwaW5nUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgbGltaXQsIF9maWx0ZXIpIHsKICAgIHRoaXMuY29uc3RydWN0b3IkKHByb21pc2VzKTsKICAgIHRoaXMuX2NhbGxiYWNrID0gZm47CiAgICB0aGlzLl9wcmVzZXJ2ZWRWYWx1ZXMgPSBfZmlsdGVyID09PSBJTlRFUk5BTAogICAgICAgID8gbmV3IEFycmF5KHRoaXMubGVuZ3RoKCkpCiAgICAgICAgOiBudWxsOwogICAgdGhpcy5fbGltaXQgPSBsaW1pdDsKICAgIHRoaXMuX2luRmxpZ2h0ID0gMDsKICAgIHRoaXMuX3F1ZXVlID0gbGltaXQgPj0gMSA/IFtdIDogRU1QVFlfQVJSQVk7CiAgICB0aGlzLl9pbml0JCh2b2lkIDAsIC0yKTsKfQp1dGlsLmluaGVyaXRzKE1hcHBpbmdQcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpNYXBwaW5nUHJvbWlzZUFycmF5LnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIE1hcHBpbmdQcm9taXNlQXJyYXkkX2luaXQoKSB7fTsKCk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gTWFwcGluZ1Byb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIHZhciB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7CiAgICBpZiAodmFsdWVzID09PSBudWxsKSByZXR1cm47CgogICAgdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoKCk7CiAgICB2YXIgcHJlc2VydmVkVmFsdWVzID0gdGhpcy5fcHJlc2VydmVkVmFsdWVzOwogICAgdmFyIGxpbWl0ID0gdGhpcy5fbGltaXQ7CiAgICBpZiAodmFsdWVzW2luZGV4XSA9PT0gUEVORElORykgewogICAgICAgIHZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICBpZiAobGltaXQgPj0gMSkgewogICAgICAgICAgICB0aGlzLl9pbkZsaWdodC0tOwogICAgICAgICAgICB0aGlzLl9kcmFpblF1ZXVlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmIChsaW1pdCA+PSAxICYmIHRoaXMuX2luRmxpZ2h0ID49IGxpbWl0KSB7CiAgICAgICAgICAgIHZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5fcXVldWUucHVzaChpbmRleCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHByZXNlcnZlZFZhbHVlcyAhPT0gbnVsbCkgcHJlc2VydmVkVmFsdWVzW2luZGV4XSA9IHZhbHVlOwoKICAgICAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLl9jYWxsYmFjazsKICAgICAgICB2YXIgcmVjZWl2ZXIgPSB0aGlzLl9wcm9taXNlLl9ib3VuZFRvOwogICAgICAgIHZhciByZXQgPSB0cnlDYXRjaDMoY2FsbGJhY2ssIHJlY2VpdmVyLCB2YWx1ZSwgaW5kZXgsIGxlbmd0aCk7CiAgICAgICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHJldHVybiB0aGlzLl9yZWplY3QocmV0LmUpOwoKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChyZXQsIHZvaWQgMCk7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICAgICAgaWYgKGxpbWl0ID49IDEpIHRoaXMuX2luRmxpZ2h0Kys7CiAgICAgICAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gUEVORElORzsKICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGluZGV4KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXliZVByb21pc2UuaXNGdWxmaWxsZWQoKSkgewogICAgICAgICAgICAgICAgcmV0ID0gbWF5YmVQcm9taXNlLnZhbHVlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZWplY3QobWF5YmVQcm9taXNlLnJlYXNvbigpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YWx1ZXNbaW5kZXhdID0gcmV0OwogICAgfQogICAgdmFyIHRvdGFsUmVzb2x2ZWQgPSArK3RoaXMuX3RvdGFsUmVzb2x2ZWQ7CiAgICBpZiAodG90YWxSZXNvbHZlZCA+PSBsZW5ndGgpIHsKICAgICAgICBpZiAocHJlc2VydmVkVmFsdWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ZpbHRlcih2YWx1ZXMsIHByZXNlcnZlZFZhbHVlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh2YWx1ZXMpOwogICAgICAgIH0KCiAgICB9Cn07CgpNYXBwaW5nUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fZHJhaW5RdWV1ZSA9CmZ1bmN0aW9uIE1hcHBpbmdQcm9taXNlQXJyYXkkX2RyYWluUXVldWUoKSB7CiAgICB2YXIgcXVldWUgPSB0aGlzLl9xdWV1ZTsKICAgIHZhciBsaW1pdCA9IHRoaXMuX2xpbWl0OwogICAgdmFyIHZhbHVlcyA9IHRoaXMuX3ZhbHVlczsKICAgIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwICYmIHRoaXMuX2luRmxpZ2h0IDwgbGltaXQpIHsKICAgICAgICB2YXIgaW5kZXggPSBxdWV1ZS5wb3AoKTsKICAgICAgICB0aGlzLl9wcm9taXNlRnVsZmlsbGVkKHZhbHVlc1tpbmRleF0sIGluZGV4KTsKICAgIH0KfTsKCk1hcHBpbmdQcm9taXNlQXJyYXkucHJvdG90eXBlLl9maWx0ZXIgPQpmdW5jdGlvbiBNYXBwaW5nUHJvbWlzZUFycmF5JF9maWx0ZXIoYm9vbGVhbnMsIHZhbHVlcykgewogICAgdmFyIGxlbiA9IHZhbHVlcy5sZW5ndGg7CiAgICB2YXIgcmV0ID0gbmV3IEFycmF5KGxlbik7CiAgICB2YXIgaiA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgaWYgKGJvb2xlYW5zW2ldKSByZXRbaisrXSA9IHZhbHVlc1tpXTsKICAgIH0KICAgIHJldC5sZW5ndGggPSBqOwogICAgdGhpcy5fcmVzb2x2ZShyZXQpOwp9OwoKTWFwcGluZ1Byb21pc2VBcnJheS5wcm90b3R5cGUucHJlc2VydmVkVmFsdWVzID0KZnVuY3Rpb24gTWFwcGluZ1Byb21pc2VBcnJheSRwcmVzZXJ2ZVZhbHVlcygpIHsKICAgIHJldHVybiB0aGlzLl9wcmVzZXJ2ZWRWYWx1ZXM7Cn07CgpmdW5jdGlvbiBtYXAocHJvbWlzZXMsIGZuLCBvcHRpb25zLCBfZmlsdGVyKSB7CiAgICB2YXIgbGltaXQgPSB0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbAogICAgICAgID8gb3B0aW9ucy5jb25jdXJyZW5jeQogICAgICAgIDogMDsKICAgIGxpbWl0ID0gdHlwZW9mIGxpbWl0ID09PSAibnVtYmVyIiAmJgogICAgICAgIGlzRmluaXRlKGxpbWl0KSAmJiBsaW1pdCA+PSAxID8gbGltaXQgOiAwOwogICAgcmV0dXJuIG5ldyBNYXBwaW5nUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgbGltaXQsIF9maWx0ZXIpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5tYXAgPSBmdW5jdGlvbiBQcm9taXNlJG1hcChmbiwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CgogICAgcmV0dXJuIG1hcCh0aGlzLCBmbiwgb3B0aW9ucywgbnVsbCkucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5tYXAgPSBmdW5jdGlvbiBQcm9taXNlJE1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIF9maWx0ZXIpIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHJldHVybiBhcGlSZWplY3Rpb24oImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgcmV0dXJuIG1hcChwcm9taXNlcywgZm4sIG9wdGlvbnMsIF9maWx0ZXIpLnByb21pc2UoKTsKfTsKCgp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgdHJ5Q2F0Y2gyID0gdXRpbC50cnlDYXRjaDI7CnZhciB0cnlDYXRjaDEgPSB1dGlsLnRyeUNhdGNoMTsKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKCmZ1bmN0aW9uIHRocm93ZXIocikgewogICAgdGhyb3cgcjsKfQoKZnVuY3Rpb24gUHJvbWlzZSRfc3ByZWFkQWRhcHRlcih2YWwsIHJlY2VpdmVyKSB7CiAgICBpZiAoIXV0aWwuaXNBcnJheSh2YWwpKSByZXR1cm4gUHJvbWlzZSRfc3VjY2Vzc0FkYXB0ZXIodmFsLCByZWNlaXZlcik7CiAgICB2YXIgcmV0ID0gdXRpbC50cnlDYXRjaEFwcGx5KHRoaXMsIFtudWxsXS5jb25jYXQodmFsKSwgcmVjZWl2ZXIpOwogICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHsKICAgICAgICBhc3luYy5pbnZva2VMYXRlcih0aHJvd2VyLCB2b2lkIDAsIHJldC5lKTsKICAgIH0KfQoKZnVuY3Rpb24gUHJvbWlzZSRfc3VjY2Vzc0FkYXB0ZXIodmFsLCByZWNlaXZlcikgewogICAgdmFyIG5vZGViYWNrID0gdGhpczsKICAgIHZhciByZXQgPSB2YWwgPT09IHZvaWQgMAogICAgICAgID8gdHJ5Q2F0Y2gxKG5vZGViYWNrLCByZWNlaXZlciwgbnVsbCkKICAgICAgICA6IHRyeUNhdGNoMihub2RlYmFjaywgcmVjZWl2ZXIsIG51bGwsIHZhbCk7CiAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgcmV0LmUpOwogICAgfQp9CmZ1bmN0aW9uIFByb21pc2UkX2Vycm9yQWRhcHRlcihyZWFzb24sIHJlY2VpdmVyKSB7CiAgICB2YXIgbm9kZWJhY2sgPSB0aGlzOwogICAgdmFyIHJldCA9IHRyeUNhdGNoMShub2RlYmFjaywgcmVjZWl2ZXIsIHJlYXNvbik7CiAgICBpZiAocmV0ID09PSBlcnJvck9iaikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgcmV0LmUpOwogICAgfQp9CgpQcm9taXNlLnByb3RvdHlwZS5ub2RlaWZ5ID0gZnVuY3Rpb24gUHJvbWlzZSRub2RlaWZ5KG5vZGViYWNrLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIG5vZGViYWNrID09ICJmdW5jdGlvbiIpIHsKICAgICAgICB2YXIgYWRhcHRlciA9IFByb21pc2UkX3N1Y2Nlc3NBZGFwdGVyOwogICAgICAgIGlmIChvcHRpb25zICE9PSB2b2lkIDAgJiYgT2JqZWN0KG9wdGlvbnMpLnNwcmVhZCkgewogICAgICAgICAgICBhZGFwdGVyID0gUHJvbWlzZSRfc3ByZWFkQWRhcHRlcjsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdGhlbigKICAgICAgICAgICAgYWRhcHRlciwKICAgICAgICAgICAgUHJvbWlzZSRfZXJyb3JBZGFwdGVyLAogICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgIG5vZGViYWNrLAogICAgICAgICAgICB0aGlzLl9ib3VuZFRvCiAgICAgICAgKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9Owp9OwoKfSx7Ii4vYXN5bmMuanMiOjE4LCIuL3V0aWwuanMiOjUwfV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXkpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGFzeW5jID0gcmVxdWlyZSgiLi9hc3luYy5qcyIpOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKTsKdmFyIHRyeUNhdGNoMSA9IHV0aWwudHJ5Q2F0Y2gxOwp2YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqOwoKUHJvbWlzZS5wcm90b3R5cGUucHJvZ3Jlc3NlZCA9IGZ1bmN0aW9uIFByb21pc2UkcHJvZ3Jlc3NlZChoYW5kbGVyKSB7CiAgICByZXR1cm4gdGhpcy5fdGhlbih2b2lkIDAsIHZvaWQgMCwgaGFuZGxlciwgdm9pZCAwLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Byb2dyZXNzID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJvZ3Jlc3MocHJvZ3Jlc3NWYWx1ZSkgewogICAgaWYgKHRoaXMuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkKCkpIHJldHVybjsKICAgIHRoaXMuX3Byb2dyZXNzVW5jaGVja2VkKHByb2dyZXNzVmFsdWUpOwoKfTsKClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGEkQmFzZSA9ClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGE7ClByb21pc2UucHJvdG90eXBlLl9jbGVhckZpcnN0SGFuZGxlckRhdGEgPQpmdW5jdGlvbiBQcm9taXNlJF9jbGVhckZpcnN0SGFuZGxlckRhdGEoKSB7CiAgICB0aGlzLl9jbGVhckZpcnN0SGFuZGxlckRhdGEkQmFzZSgpOwogICAgdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyMCA9IHZvaWQgMDsKfTsKClByb21pc2UucHJvdG90eXBlLl9wcm9ncmVzc0hhbmRsZXJBdCA9CmZ1bmN0aW9uIFByb21pc2UkX3Byb2dyZXNzSGFuZGxlckF0KGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3Byb2dyZXNzSGFuZGxlcjAKICAgICAgICA6IHRoaXNbKGluZGV4IDw8IDIpICsgaW5kZXggLSA1ICsgMl07Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZG9Qcm9ncmVzc1dpdGggPQpmdW5jdGlvbiBQcm9taXNlJF9kb1Byb2dyZXNzV2l0aChwcm9ncmVzc2lvbikgewogICAgdmFyIHByb2dyZXNzVmFsdWUgPSBwcm9ncmVzc2lvbi52YWx1ZTsKICAgIHZhciBoYW5kbGVyID0gcHJvZ3Jlc3Npb24uaGFuZGxlcjsKICAgIHZhciBwcm9taXNlID0gcHJvZ3Jlc3Npb24ucHJvbWlzZTsKICAgIHZhciByZWNlaXZlciA9IHByb2dyZXNzaW9uLnJlY2VpdmVyOwoKICAgIHZhciByZXQgPSB0cnlDYXRjaDEoaGFuZGxlciwgcmVjZWl2ZXIsIHByb2dyZXNzVmFsdWUpOwogICAgaWYgKHJldCA9PT0gZXJyb3JPYmopIHsKICAgICAgICBpZiAocmV0LmUgIT0gbnVsbCAmJgogICAgICAgICAgICByZXQuZS5uYW1lICE9PSAiU3RvcFByb2dyZXNzUHJvcGFnYXRpb24iKSB7CiAgICAgICAgICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmV0LmUpCiAgICAgICAgICAgICAgICA/IHJldC5lIDogbmV3IEVycm9yKHJldC5lICsgIiIpOwogICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgICAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3MocmV0LmUpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAocmV0IGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHJldC5fdGhlbihwcm9taXNlLl9wcm9ncmVzcywgbnVsbCwgbnVsbCwgcHJvbWlzZSwgdm9pZCAwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3MocmV0KTsKICAgIH0KfTsKCgpQcm9taXNlLnByb3RvdHlwZS5fcHJvZ3Jlc3NVbmNoZWNrZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9wcm9ncmVzc1VuY2hlY2tlZChwcm9ncmVzc1ZhbHVlKSB7CiAgICBpZiAoIXRoaXMuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIHZhciBsZW4gPSB0aGlzLl9sZW5ndGgoKTsKICAgIHZhciBwcm9ncmVzcyA9IHRoaXMuX3Byb2dyZXNzOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyQXQoaSk7CiAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlQXQoaSk7CiAgICAgICAgaWYgKCEocHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSB7CiAgICAgICAgICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3JlY2VpdmVyQXQoaSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaGFuZGxlci5jYWxsKHJlY2VpdmVyLCBwcm9ncmVzc1ZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciBpbnN0YW5jZW9mIFByb21pc2UgJiYgcmVjZWl2ZXIuX2lzUHJveGllZCgpKSB7CiAgICAgICAgICAgICAgICByZWNlaXZlci5fcHJvZ3Jlc3NVbmNoZWNrZWQocHJvZ3Jlc3NWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVjZWl2ZXIgaW5zdGFuY2VvZiBQcm9taXNlQXJyYXkpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVyLl9wcm9taXNlUHJvZ3Jlc3NlZChwcm9ncmVzc1ZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhc3luYy5pbnZva2UodGhpcy5fZG9Qcm9ncmVzc1dpdGgsIHRoaXMsIHsKICAgICAgICAgICAgICAgIGhhbmRsZXI6IGhhbmRsZXIsCiAgICAgICAgICAgICAgICBwcm9taXNlOiBwcm9taXNlLAogICAgICAgICAgICAgICAgcmVjZWl2ZXI6IHRoaXMuX3JlY2VpdmVyQXQoaSksCiAgICAgICAgICAgICAgICB2YWx1ZTogcHJvZ3Jlc3NWYWx1ZQogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3luYy5pbnZva2UocHJvZ3Jlc3MsIHByb21pc2UsIHByb2dyZXNzVmFsdWUpOwogICAgICAgIH0KICAgIH0KfTsKfTsKCn0seyIuL2FzeW5jLmpzIjoxOCwiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sMzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIG9sZDsKaWYgKHR5cGVvZiBQcm9taXNlICE9PSAidW5kZWZpbmVkIikgb2xkID0gUHJvbWlzZTsKZnVuY3Rpb24gbm9Db25mbGljdChibHVlYmlyZCkgewogICAgdHJ5IHsgaWYgKFByb21pc2UgPT09IGJsdWViaXJkKSBQcm9taXNlID0gb2xkOyB9CiAgICBjYXRjaCAoZSkge30KICAgIHJldHVybiBibHVlYmlyZDsKfQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKCkgewp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwp2YXIgYXN5bmMgPSByZXF1aXJlKCIuL2FzeW5jLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwoKdmFyIElOVEVSTkFMID0gZnVuY3Rpb24oKXt9Owp2YXIgQVBQTFkgPSB7fTsKdmFyIE5FWFRfRklMVEVSID0ge2U6IG51bGx9OwoKdmFyIGNhc3QgPSByZXF1aXJlKCIuL3RoZW5hYmxlcy5qcyIpKFByb21pc2UsIElOVEVSTkFMKTsKdmFyIFByb21pc2VBcnJheSA9IHJlcXVpcmUoIi4vcHJvbWlzZV9hcnJheS5qcyIpKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KTsKdmFyIENhcHR1cmVkVHJhY2UgPSByZXF1aXJlKCIuL2NhcHR1cmVkX3RyYWNlLmpzIikoKTsKdmFyIENhdGNoRmlsdGVyID0gcmVxdWlyZSgiLi9jYXRjaF9maWx0ZXIuanMiKShORVhUX0ZJTFRFUik7CnZhciBQcm9taXNlUmVzb2x2ZXIgPSByZXF1aXJlKCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiKTsKCnZhciBpc0FycmF5ID0gdXRpbC5pc0FycmF5OwoKdmFyIGVycm9yT2JqID0gdXRpbC5lcnJvck9iajsKdmFyIHRyeUNhdGNoMSA9IHV0aWwudHJ5Q2F0Y2gxOwp2YXIgdHJ5Q2F0Y2gyID0gdXRpbC50cnlDYXRjaDI7CnZhciB0cnlDYXRjaEFwcGx5ID0gdXRpbC50cnlDYXRjaEFwcGx5Owp2YXIgUmFuZ2VFcnJvciA9IGVycm9ycy5SYW5nZUVycm9yOwp2YXIgVHlwZUVycm9yID0gZXJyb3JzLlR5cGVFcnJvcjsKdmFyIENhbmNlbGxhdGlvbkVycm9yID0gZXJyb3JzLkNhbmNlbGxhdGlvbkVycm9yOwp2YXIgVGltZW91dEVycm9yID0gZXJyb3JzLlRpbWVvdXRFcnJvcjsKdmFyIE9wZXJhdGlvbmFsRXJyb3IgPSBlcnJvcnMuT3BlcmF0aW9uYWxFcnJvcjsKdmFyIG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uID0gZXJyb3JzLm9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uOwp2YXIgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uID0gZXJyb3JzLm1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbjsKdmFyIGNhbkF0dGFjaCA9IGVycm9ycy5jYW5BdHRhY2g7CnZhciB0aHJvd2VyID0gdXRpbC50aHJvd2VyOwp2YXIgYXBpUmVqZWN0aW9uID0gcmVxdWlyZSgiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiIpKFByb21pc2UpOwoKCnZhciBtYWtlU2VsZlJlc29sdXRpb25FcnJvciA9IGZ1bmN0aW9uIFByb21pc2UkX21ha2VTZWxmUmVzb2x1dGlvbkVycm9yKCkgewogICAgcmV0dXJuIG5ldyBUeXBlRXJyb3IoImNpcmN1bGFyIHByb21pc2UgcmVzb2x1dGlvbiBjaGFpbiIpOwp9OwoKZnVuY3Rpb24gUHJvbWlzZShyZXNvbHZlcikgewogICAgaWYgKHR5cGVvZiByZXNvbHZlciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoInRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIHJlcXVpcmVzIGEgcmVzb2x2ZXIgZnVuY3Rpb24iKTsKICAgIH0KICAgIGlmICh0aGlzLmNvbnN0cnVjdG9yICE9PSBQcm9taXNlKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidGhlIHByb21pc2UgY29uc3RydWN0b3IgY2Fubm90IGJlIGludm9rZWQgZGlyZWN0bHkiKTsKICAgIH0KICAgIHRoaXMuX2JpdEZpZWxkID0gMDsKICAgIHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjAgPSB2b2lkIDA7CiAgICB0aGlzLl9yZWplY3Rpb25IYW5kbGVyMCA9IHZvaWQgMDsKICAgIHRoaXMuX3Byb21pc2UwID0gdm9pZCAwOwogICAgdGhpcy5fcmVjZWl2ZXIwID0gdm9pZCAwOwogICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdm9pZCAwOwogICAgdGhpcy5fYm91bmRUbyA9IHZvaWQgMDsKICAgIGlmIChyZXNvbHZlciAhPT0gSU5URVJOQUwpIHRoaXMuX3Jlc29sdmVGcm9tUmVzb2x2ZXIocmVzb2x2ZXIpOwp9CgpmdW5jdGlvbiByZXR1cm5GaXJzdEVsZW1lbnQoZWxlbWVudHMpIHsKICAgIHJldHVybiBlbGVtZW50c1swXTsKfQoKUHJvbWlzZS5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uIFByb21pc2UkYmluZCh0aGlzQXJnKSB7CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGlzQXJnLCB2b2lkIDApOwogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgdmFyIGJpbmRlciA9IG1heWJlUHJvbWlzZS50aGVuKGZ1bmN0aW9uKHRoaXNBcmcpIHsKICAgICAgICAgICAgcmV0Ll9zZXRCb3VuZFRvKHRoaXNBcmcpOwogICAgICAgIH0pOwogICAgICAgIHZhciBwID0gUHJvbWlzZS5hbGwoW3RoaXMsIGJpbmRlcl0pLnRoZW4ocmV0dXJuRmlyc3RFbGVtZW50KTsKICAgICAgICByZXQuX2ZvbGxvdyhwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0Ll9mb2xsb3codGhpcyk7CiAgICAgICAgcmV0Ll9zZXRCb3VuZFRvKHRoaXNBcmcpOwogICAgfQogICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHRoaXMsIDIgfCAxKTsKICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uIFByb21pc2UkdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIltvYmplY3QgUHJvbWlzZV0iOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuY2F1Z2h0ID0gUHJvbWlzZS5wcm90b3R5cGVbImNhdGNoIl0gPQpmdW5jdGlvbiBQcm9taXNlJGNhdGNoKGZuKSB7CiAgICB2YXIgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIGlmIChsZW4gPiAxKSB7CiAgICAgICAgdmFyIGNhdGNoSW5zdGFuY2VzID0gbmV3IEFycmF5KGxlbiAtIDEpLAogICAgICAgICAgICBqID0gMCwgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuIC0gMTsgKytpKSB7CiAgICAgICAgICAgIHZhciBpdGVtID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGNhdGNoSW5zdGFuY2VzW2orK10gPSBpdGVtOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGNhdGNoRmlsdGVyVHlwZUVycm9yID0KICAgICAgICAgICAgICAgICAgICBuZXcgVHlwZUVycm9yKAogICAgICAgICAgICAgICAgICAgICAgICAiQSBjYXRjaCBmaWx0ZXIgbXVzdCBiZSBhbiBlcnJvciBjb25zdHJ1Y3RvciAiCiAgICAgICAgICAgICAgICAgICAgICAgICsgIm9yIGEgZmlsdGVyIGZ1bmN0aW9uIik7CgogICAgICAgICAgICAgICAgdGhpcy5fYXR0YWNoRXh0cmFUcmFjZShjYXRjaEZpbHRlclR5cGVFcnJvcik7CiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoY2F0Y2hGaWx0ZXJUeXBlRXJyb3IpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoSW5zdGFuY2VzLmxlbmd0aCA9IGo7CiAgICAgICAgZm4gPSBhcmd1bWVudHNbaV07CgogICAgICAgIHRoaXMuX3Jlc2V0VHJhY2UoKTsKICAgICAgICB2YXIgY2F0Y2hGaWx0ZXIgPSBuZXcgQ2F0Y2hGaWx0ZXIoY2F0Y2hJbnN0YW5jZXMsIGZuLCB0aGlzKTsKICAgICAgICByZXR1cm4gdGhpcy5fdGhlbih2b2lkIDAsIGNhdGNoRmlsdGVyLmRvRmlsdGVyLCB2b2lkIDAsCiAgICAgICAgICAgIGNhdGNoRmlsdGVyLCB2b2lkIDApOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3RoZW4odm9pZCAwLCBmbiwgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCk7Cn07CgpmdW5jdGlvbiByZWZsZWN0KCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlLlByb21pc2VJbnNwZWN0aW9uKHRoaXMpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5yZWZsZWN0ID0gZnVuY3Rpb24gUHJvbWlzZSRyZWZsZWN0KCkgewogICAgcmV0dXJuIHRoaXMuX3RoZW4ocmVmbGVjdCwgcmVmbGVjdCwgdm9pZCAwLCB0aGlzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUudGhlbiA9CmZ1bmN0aW9uIFByb21pc2UkdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzKSB7CiAgICByZXR1cm4gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLAogICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKfTsKCgpQcm9taXNlLnByb3RvdHlwZS5kb25lID0KZnVuY3Rpb24gUHJvbWlzZSRkb25lKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCwgZGlkUHJvZ3Jlc3MpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5fdGhlbihkaWRGdWxmaWxsLCBkaWRSZWplY3QsIGRpZFByb2dyZXNzLAogICAgICAgIHZvaWQgMCwgdm9pZCAwKTsKICAgIHByb21pc2UuX3NldElzRmluYWwoKTsKfTsKClByb21pc2UucHJvdG90eXBlLnNwcmVhZCA9IGZ1bmN0aW9uIFByb21pc2Ukc3ByZWFkKGRpZEZ1bGZpbGwsIGRpZFJlamVjdCkgewogICAgcmV0dXJuIHRoaXMuX3RoZW4oZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCB2b2lkIDAsCiAgICAgICAgQVBQTFksIHZvaWQgMCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5pc0NhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRpc0NhbmNlbGxhYmxlKCkgewogICAgcmV0dXJuICF0aGlzLmlzUmVzb2x2ZWQoKSAmJgogICAgICAgIHRoaXMuX2NhbmNlbGxhYmxlKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiBQcm9taXNlJHRvSlNPTigpIHsKICAgIHZhciByZXQgPSB7CiAgICAgICAgaXNGdWxmaWxsZWQ6IGZhbHNlLAogICAgICAgIGlzUmVqZWN0ZWQ6IGZhbHNlLAogICAgICAgIGZ1bGZpbGxtZW50VmFsdWU6IHZvaWQgMCwKICAgICAgICByZWplY3Rpb25SZWFzb246IHZvaWQgMAogICAgfTsKICAgIGlmICh0aGlzLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICByZXQuZnVsZmlsbG1lbnRWYWx1ZSA9IHRoaXMuX3NldHRsZWRWYWx1ZTsKICAgICAgICByZXQuaXNGdWxmaWxsZWQgPSB0cnVlOwogICAgfSBlbHNlIGlmICh0aGlzLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIHJldC5yZWplY3Rpb25SZWFzb24gPSB0aGlzLl9zZXR0bGVkVmFsdWU7CiAgICAgICAgcmV0LmlzUmVqZWN0ZWQgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UucHJvdG90eXBlLmFsbCA9IGZ1bmN0aW9uIFByb21pc2UkYWxsKCkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlQXJyYXkodGhpcykucHJvbWlzZSgpOwp9OwoKClByb21pc2UuaXMgPSBmdW5jdGlvbiBQcm9taXNlJElzKHZhbCkgewogICAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIFByb21pc2U7Cn07CgpQcm9taXNlLmFsbCA9IGZ1bmN0aW9uIFByb21pc2UkQWxsKHByb21pc2VzKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2VBcnJheShwcm9taXNlcykucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuZXJyb3IgPSBmdW5jdGlvbiBQcm9taXNlJF9lcnJvcihmbikgewogICAgcmV0dXJuIHRoaXMuY2F1Z2h0KG9yaWdpbmF0ZXNGcm9tUmVqZWN0aW9uLCBmbik7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVzb2x2ZUZyb21TeW5jVmFsdWUgPQpmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVN5bmNWYWx1ZSh2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSBlcnJvck9iaikgewogICAgICAgIHRoaXMuX2NsZWFuVmFsdWVzKCk7CiAgICAgICAgdGhpcy5fc2V0UmVqZWN0ZWQoKTsKICAgICAgICB2YXIgcmVhc29uID0gdmFsdWUuZTsKICAgICAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSByZWFzb247CiAgICAgICAgdGhpcy5fdHJ5QXR0YWNoRXh0cmFUcmFjZShyZWFzb24pOwogICAgICAgIHRoaXMuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICB0aGlzLl9mb2xsb3cobWF5YmVQcm9taXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9jbGVhblZhbHVlcygpOwogICAgICAgICAgICB0aGlzLl9zZXRGdWxmaWxsZWQoKTsKICAgICAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgfQp9OwoKUHJvbWlzZS5tZXRob2QgPSBmdW5jdGlvbiBQcm9taXNlJF9NZXRob2QoZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJmbiBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgIH0KICAgIHJldHVybiBmdW5jdGlvbiBQcm9taXNlJF9tZXRob2QoKSB7CiAgICAgICAgdmFyIHZhbHVlOwogICAgICAgIHN3aXRjaChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgY2FzZSAwOiB2YWx1ZSA9IHRyeUNhdGNoMShmbiwgdGhpcywgdm9pZCAwKTsgYnJlYWs7CiAgICAgICAgY2FzZSAxOiB2YWx1ZSA9IHRyeUNhdGNoMShmbiwgdGhpcywgYXJndW1lbnRzWzBdKTsgYnJlYWs7CiAgICAgICAgY2FzZSAyOiB2YWx1ZSA9IHRyeUNhdGNoMihmbiwgdGhpcywgYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMV0pOyBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICB2YXIgJF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoO3ZhciBhcmdzID0gbmV3IEFycmF5KCRfbGVuKTsgZm9yKHZhciAkX2kgPSAwOyAkX2kgPCAkX2xlbjsgKyskX2kpIHthcmdzWyRfaV0gPSBhcmd1bWVudHNbJF9pXTt9CiAgICAgICAgICAgIHZhbHVlID0gdHJ5Q2F0Y2hBcHBseShmbiwgYXJncywgdGhpcyk7IGJyZWFrOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICByZXQuX3Jlc29sdmVGcm9tU3luY1ZhbHVlKHZhbHVlKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfTsKfTsKClByb21pc2UuYXR0ZW1wdCA9IFByb21pc2VbInRyeSJdID0gZnVuY3Rpb24gUHJvbWlzZSRfVHJ5KGZuLCBhcmdzLCBjdHgpIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gYXBpUmVqZWN0aW9uKCJmbiBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICAgIH0KICAgIHZhciB2YWx1ZSA9IGlzQXJyYXkoYXJncykKICAgICAgICA/IHRyeUNhdGNoQXBwbHkoZm4sIGFyZ3MsIGN0eCkKICAgICAgICA6IHRyeUNhdGNoMShmbiwgY3R4LCBhcmdzKTsKCiAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgcmV0Ll9zZXRUcmFjZSh2b2lkIDApOwogICAgcmV0Ll9yZXNvbHZlRnJvbVN5bmNWYWx1ZSh2YWx1ZSk7CiAgICByZXR1cm4gcmV0Owp9OwoKUHJvbWlzZS5kZWZlciA9IFByb21pc2UucGVuZGluZyA9IGZ1bmN0aW9uIFByb21pc2UkRGVmZXIoKSB7CiAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7CiAgICByZXR1cm4gbmV3IFByb21pc2VSZXNvbHZlcihwcm9taXNlKTsKfTsKClByb21pc2UuYmluZCA9IGZ1bmN0aW9uIFByb21pc2UkQmluZCh0aGlzQXJnKSB7CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGlzQXJnLCB2b2lkIDApOwogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKCiAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHZhciBwID0gbWF5YmVQcm9taXNlLnRoZW4oZnVuY3Rpb24odGhpc0FyZykgewogICAgICAgICAgICByZXQuX3NldEJvdW5kVG8odGhpc0FyZyk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0Ll9mb2xsb3cocCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldC5fc2V0Qm91bmRUbyh0aGlzQXJnKTsKICAgICAgICByZXQuX3NldEZ1bGZpbGxlZCgpOwogICAgfQogICAgcmV0dXJuIHJldDsKfTsKClByb21pc2UuY2FzdCA9IGZ1bmN0aW9uIFByb21pc2UkX0Nhc3Qob2JqKSB7CiAgICB2YXIgcmV0ID0gY2FzdChvYmosIHZvaWQgMCk7CiAgICBpZiAoIShyZXQgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgIHZhciB2YWwgPSByZXQ7CiAgICAgICAgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICByZXQuX3NldEZ1bGZpbGxlZCgpOwogICAgICAgIHJldC5fY2xlYW5WYWx1ZXMoKTsKICAgICAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHZhbDsKICAgIH0KICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnJlc29sdmUgPSBQcm9taXNlLmZ1bGZpbGxlZCA9IFByb21pc2UuY2FzdDsKClByb21pc2UucmVqZWN0ID0gUHJvbWlzZS5yZWplY3RlZCA9IGZ1bmN0aW9uIFByb21pc2UkUmVqZWN0KHJlYXNvbikgewogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgIG1hcmtBc09yaWdpbmF0aW5nRnJvbVJlamVjdGlvbihyZWFzb24pOwogICAgcmV0Ll9jbGVhblZhbHVlcygpOwogICAgcmV0Ll9zZXRSZWplY3RlZCgpOwogICAgcmV0Ll9zZXR0bGVkVmFsdWUgPSByZWFzb247CiAgICBpZiAoIWNhbkF0dGFjaChyZWFzb24pKSB7CiAgICAgICAgdmFyIHRyYWNlID0gbmV3IEVycm9yKHJlYXNvbiArICIiKTsKICAgICAgICByZXQuX3NldENhcnJpZWRTdGFja1RyYWNlKHRyYWNlKTsKICAgIH0KICAgIHJldC5fZW5zdXJlUG9zc2libGVSZWplY3Rpb25IYW5kbGVkKCk7CiAgICByZXR1cm4gcmV0Owp9OwoKUHJvbWlzZS5vblBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gUHJvbWlzZSRPblBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uKGZuKSB7CiAgICAgICAgQ2FwdHVyZWRUcmFjZS5wb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbiA9IHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBmbiA6IHZvaWQgMDsKfTsKCnZhciB1bmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkOwpQcm9taXNlLm9uVW5oYW5kbGVkUmVqZWN0aW9uSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2Ukb25VbmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkKGZuKSB7CiAgICB1bmhhbmRsZWRSZWplY3Rpb25IYW5kbGVkID0gdHlwZW9mIGZuID09PSAiZnVuY3Rpb24iID8gZm4gOiB2b2lkIDA7Cn07Cgp2YXIgZGVidWdnaW5nID0gZmFsc2UgfHwgISEoCiAgICB0eXBlb2YgcHJvY2VzcyAhPT0gInVuZGVmaW5lZCIgJiYKICAgIHR5cGVvZiBwcm9jZXNzLmV4ZWNQYXRoID09PSAic3RyaW5nIiAmJgogICAgdHlwZW9mIHByb2Nlc3MuZW52ID09PSAib2JqZWN0IiAmJgogICAgKHByb2Nlc3MuZW52WyJCTFVFQklSRF9ERUJVRyJdIHx8CiAgICAgICAgcHJvY2Vzcy5lbnZbIk5PREVfRU5WIl0gPT09ICJkZXZlbG9wbWVudCIpCik7CgoKUHJvbWlzZS5sb25nU3RhY2tUcmFjZXMgPSBmdW5jdGlvbiBQcm9taXNlJExvbmdTdGFja1RyYWNlcygpIHsKICAgIGlmIChhc3luYy5oYXZlSXRlbXNRdWV1ZWQoKSAmJgogICAgICAgIGRlYnVnZ2luZyA9PT0gZmFsc2UKICAgKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgZW5hYmxlIGxvbmcgc3RhY2sgdHJhY2VzIGFmdGVyIHByb21pc2VzIGhhdmUgYmVlbiBjcmVhdGVkIik7CiAgICB9CiAgICBkZWJ1Z2dpbmcgPSBDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCk7Cn07CgpQcm9taXNlLmhhc0xvbmdTdGFja1RyYWNlcyA9IGZ1bmN0aW9uIFByb21pc2UkSGFzTG9uZ1N0YWNrVHJhY2VzKCkgewogICAgcmV0dXJuIGRlYnVnZ2luZyAmJiBDYXB0dXJlZFRyYWNlLmlzU3VwcG9ydGVkKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdGhlbiA9CmZ1bmN0aW9uIFByb21pc2UkX3RoZW4oCiAgICBkaWRGdWxmaWxsLAogICAgZGlkUmVqZWN0LAogICAgZGlkUHJvZ3Jlc3MsCiAgICByZWNlaXZlciwKICAgIGludGVybmFsRGF0YQopIHsKICAgIHZhciBoYXZlSW50ZXJuYWxEYXRhID0gaW50ZXJuYWxEYXRhICE9PSB2b2lkIDA7CiAgICB2YXIgcmV0ID0gaGF2ZUludGVybmFsRGF0YSA/IGludGVybmFsRGF0YSA6IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKCiAgICBpZiAoIWhhdmVJbnRlcm5hbERhdGEpIHsKICAgICAgICBpZiAoZGVidWdnaW5nKSB7CiAgICAgICAgICAgIHZhciBoYXZlU2FtZUNvbnRleHQgPSB0aGlzLl9wZWVrQ29udGV4dCgpID09PSB0aGlzLl90cmFjZVBhcmVudDsKICAgICAgICAgICAgcmV0Ll90cmFjZVBhcmVudCA9IGhhdmVTYW1lQ29udGV4dCA/IHRoaXMuX3RyYWNlUGFyZW50IDogdGhpczsKICAgICAgICB9CiAgICAgICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHRoaXMsIDcpOwogICAgfQoKICAgIHZhciBjYWxsYmFja0luZGV4ID0KICAgICAgICB0aGlzLl9hZGRDYWxsYmFja3MoZGlkRnVsZmlsbCwgZGlkUmVqZWN0LCBkaWRQcm9ncmVzcywgcmV0LCByZWNlaXZlcik7CgogICAgaWYgKHRoaXMuaXNSZXNvbHZlZCgpKSB7CiAgICAgICAgYXN5bmMuaW52b2tlKHRoaXMuX3F1ZXVlU2V0dGxlQXQsIHRoaXMsIGNhbGxiYWNrSW5kZXgpOwogICAgfQoKICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fbGVuZ3RoID0gZnVuY3Rpb24gUHJvbWlzZSRfbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2JpdEZpZWxkICYgMjYyMTQzOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzRm9sbG93aW5nT3JGdWxmaWxsZWRPclJlamVjdGVkID0KZnVuY3Rpb24gUHJvbWlzZSRfaXNGb2xsb3dpbmdPckZ1bGZpbGxlZE9yUmVqZWN0ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgOTM5NTI0MDk2KSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNGb2xsb3dpbmcgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0ZvbGxvd2luZygpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA1MzY4NzA5MTIpID09PSA1MzY4NzA5MTI7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0TGVuZ3RoID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0TGVuZ3RoKGxlbikgewogICAgdGhpcy5fYml0RmllbGQgPSAodGhpcy5fYml0RmllbGQgJiAtMjYyMTQ0KSB8CiAgICAgICAgKGxlbiAmIDI2MjE0Myk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0RnVsZmlsbGVkID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0RnVsZmlsbGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDI2ODQzNTQ1NjsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRSZWplY3RlZCA9IGZ1bmN0aW9uIFByb21pc2UkX3NldFJlamVjdGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDEzNDIxNzcyODsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRGb2xsb3dpbmcgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRGb2xsb3dpbmcoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNTM2ODcwOTEyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldElzRmluYWwgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRJc0ZpbmFsKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDMzNTU0NDMyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzRmluYWwgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0ZpbmFsKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDMzNTU0NDMyKSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FuY2VsbGFibGUgPSBmdW5jdGlvbiBQcm9taXNlJF9jYW5jZWxsYWJsZSgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA2NzEwODg2NCkgPiAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldENhbmNlbGxhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0Q2FuY2VsbGFibGUoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNjcxMDg4NjQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdW5zZXRDYW5jZWxsYWJsZSA9IGZ1bmN0aW9uIFByb21pc2UkX3Vuc2V0Q2FuY2VsbGFibGUoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkICYgKH42NzEwODg2NCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpIHsKICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCAyMDk3MTUyOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+MjA5NzE1Mik7CiAgICBpZiAodGhpcy5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCgpKSB7CiAgICAgICAgdGhpcy5fdW5zZXRVbmhhbmRsZWRSZWplY3Rpb25Jc05vdGlmaWVkKCk7CiAgICAgICAgdGhpcy5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uSXNIYW5kbGVkKCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNSZWplY3Rpb25VbmhhbmRsZWQgPQpmdW5jdGlvbiBQcm9taXNlJF9pc1JlamVjdGlvblVuaGFuZGxlZCgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiAyMDk3MTUyKSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX3NldFVuaGFuZGxlZFJlamVjdGlvbklzTm90aWZpZWQoKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgNTI0Mjg4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX3Vuc2V0VW5oYW5kbGVkUmVqZWN0aW9uSXNOb3RpZmllZCgpIHsKICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjUyNDI4OCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNVbmhhbmRsZWRSZWplY3Rpb25Ob3RpZmllZCA9CmZ1bmN0aW9uIFByb21pc2UkX2lzVW5oYW5kbGVkUmVqZWN0aW9uTm90aWZpZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNTI0Mjg4KSA+IDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0Q2FycmllZFN0YWNrVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRDYXJyaWVkU3RhY2tUcmFjZShjYXB0dXJlZFRyYWNlKSB7CiAgICB0aGlzLl9iaXRGaWVsZCA9IHRoaXMuX2JpdEZpZWxkIHwgMTA0ODU3NjsKICAgIHRoaXMuX2Z1bGZpbGxtZW50SGFuZGxlcjAgPSBjYXB0dXJlZFRyYWNlOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0Q2FycmllZFN0YWNrVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF91bnNldENhcnJpZWRTdGFja1RyYWNlKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+MTA0ODU3Nik7CiAgICB0aGlzLl9mdWxmaWxsbWVudEhhbmRsZXIwID0gdm9pZCAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzQ2FycnlpbmdTdGFja1RyYWNlID0KZnVuY3Rpb24gUHJvbWlzZSRfaXNDYXJyeWluZ1N0YWNrVHJhY2UoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTA0ODU3NikgPiAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2dldENhcnJpZWRTdGFja1RyYWNlID0KZnVuY3Rpb24gUHJvbWlzZSRfZ2V0Q2FycmllZFN0YWNrVHJhY2UoKSB7CiAgICByZXR1cm4gdGhpcy5faXNDYXJyeWluZ1N0YWNrVHJhY2UoKQogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMAogICAgICAgIDogdm9pZCAwOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlY2VpdmVyQXQgPSBmdW5jdGlvbiBQcm9taXNlJF9yZWNlaXZlckF0KGluZGV4KSB7CiAgICB2YXIgcmV0ID0gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3JlY2VpdmVyMAogICAgICAgIDogdGhpc1soaW5kZXggPDwgMikgKyBpbmRleCAtIDUgKyA0XTsKICAgIGlmICh0aGlzLl9pc0JvdW5kKCkgJiYgcmV0ID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gdGhpcy5fYm91bmRUbzsKICAgIH0KICAgIHJldHVybiByZXQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHJvbWlzZUF0ID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJvbWlzZUF0KGluZGV4KSB7CiAgICByZXR1cm4gaW5kZXggPT09IDAKICAgICAgICA/IHRoaXMuX3Byb21pc2UwCiAgICAgICAgOiB0aGlzWyhpbmRleCA8PCAyKSArIGluZGV4IC0gNSArIDNdOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Z1bGZpbGxtZW50SGFuZGxlckF0ID0KZnVuY3Rpb24gUHJvbWlzZSRfZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpIHsKICAgIHJldHVybiBpbmRleCA9PT0gMAogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMAogICAgICAgIDogdGhpc1soaW5kZXggPDwgMikgKyBpbmRleCAtIDUgKyAwXTsKfTsKClByb21pc2UucHJvdG90eXBlLl9yZWplY3Rpb25IYW5kbGVyQXQgPQpmdW5jdGlvbiBQcm9taXNlJF9yZWplY3Rpb25IYW5kbGVyQXQoaW5kZXgpIHsKICAgIHJldHVybiBpbmRleCA9PT0gMAogICAgICAgID8gdGhpcy5fcmVqZWN0aW9uSGFuZGxlcjAKICAgICAgICA6IHRoaXNbKGluZGV4IDw8IDIpICsgaW5kZXggLSA1ICsgMV07Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fYWRkQ2FsbGJhY2tzID0gZnVuY3Rpb24gUHJvbWlzZSRfYWRkQ2FsbGJhY2tzKAogICAgZnVsZmlsbCwKICAgIHJlamVjdCwKICAgIHByb2dyZXNzLAogICAgcHJvbWlzZSwKICAgIHJlY2VpdmVyCikgewogICAgdmFyIGluZGV4ID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKGluZGV4ID49IDI2MjE0MyAtIDUpIHsKICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgdGhpcy5fc2V0TGVuZ3RoKDApOwogICAgfQoKICAgIGlmIChpbmRleCA9PT0gMCkgewogICAgICAgIHRoaXMuX3Byb21pc2UwID0gcHJvbWlzZTsKICAgICAgICBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgdGhpcy5fcmVjZWl2ZXIwID0gcmVjZWl2ZXI7CiAgICAgICAgaWYgKHR5cGVvZiBmdWxmaWxsID09PSAiZnVuY3Rpb24iICYmICF0aGlzLl9pc0NhcnJ5aW5nU3RhY2tUcmFjZSgpKQogICAgICAgICAgICB0aGlzLl9mdWxmaWxsbWVudEhhbmRsZXIwID0gZnVsZmlsbDsKICAgICAgICBpZiAodHlwZW9mIHJlamVjdCA9PT0gImZ1bmN0aW9uIikgdGhpcy5fcmVqZWN0aW9uSGFuZGxlcjAgPSByZWplY3Q7CiAgICAgICAgaWYgKHR5cGVvZiBwcm9ncmVzcyA9PT0gImZ1bmN0aW9uIikgdGhpcy5fcHJvZ3Jlc3NIYW5kbGVyMCA9IHByb2dyZXNzOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgYmFzZSA9IChpbmRleCA8PCAyKSArIGluZGV4IC0gNTsKICAgICAgICB0aGlzW2Jhc2UgKyAzXSA9IHByb21pc2U7CiAgICAgICAgdGhpc1tiYXNlICsgNF0gPSByZWNlaXZlcjsKICAgICAgICB0aGlzW2Jhc2UgKyAwXSA9IHR5cGVvZiBmdWxmaWxsID09PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBmdWxmaWxsIDogdm9pZCAwOwogICAgICAgIHRoaXNbYmFzZSArIDFdID0gdHlwZW9mIHJlamVjdCA9PT0gImZ1bmN0aW9uIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gcmVqZWN0IDogdm9pZCAwOwogICAgICAgIHRoaXNbYmFzZSArIDJdID0gdHlwZW9mIHByb2dyZXNzID09PSAiZnVuY3Rpb24iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwcm9ncmVzcyA6IHZvaWQgMDsKICAgIH0KICAgIHRoaXMuX3NldExlbmd0aChpbmRleCArIDEpOwogICAgcmV0dXJuIGluZGV4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldFByb3h5SGFuZGxlcnMgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXRQcm94eUhhbmRsZXJzKHJlY2VpdmVyLCBwcm9taXNlU2xvdFZhbHVlKSB7CiAgICB2YXIgaW5kZXggPSB0aGlzLl9sZW5ndGgoKTsKCiAgICBpZiAoaW5kZXggPj0gMjYyMTQzIC0gNSkgewogICAgICAgIGluZGV4ID0gMDsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoMCk7CiAgICB9CiAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICB0aGlzLl9wcm9taXNlMCA9IHByb21pc2VTbG90VmFsdWU7CiAgICAgICAgdGhpcy5fcmVjZWl2ZXIwID0gcmVjZWl2ZXI7CiAgICB9IGVsc2UgewogICAgICAgIHZhciBiYXNlID0gKGluZGV4IDw8IDIpICsgaW5kZXggLSA1OwogICAgICAgIHRoaXNbYmFzZSArIDNdID0gcHJvbWlzZVNsb3RWYWx1ZTsKICAgICAgICB0aGlzW2Jhc2UgKyA0XSA9IHJlY2VpdmVyOwogICAgICAgIHRoaXNbYmFzZSArIDBdID0KICAgICAgICB0aGlzW2Jhc2UgKyAxXSA9CiAgICAgICAgdGhpc1tiYXNlICsgMl0gPSB2b2lkIDA7CiAgICB9CiAgICB0aGlzLl9zZXRMZW5ndGgoaW5kZXggKyAxKTsKfTsKClByb21pc2UucHJvdG90eXBlLl9wcm94eVByb21pc2VBcnJheSA9CmZ1bmN0aW9uIFByb21pc2UkX3Byb3h5UHJvbWlzZUFycmF5KHByb21pc2VBcnJheSwgaW5kZXgpIHsKICAgIHRoaXMuX3NldFByb3h5SGFuZGxlcnMocHJvbWlzZUFycmF5LCBpbmRleCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHJveHlQcm9taXNlID0gZnVuY3Rpb24gUHJvbWlzZSRfcHJveHlQcm9taXNlKHByb21pc2UpIHsKICAgIHByb21pc2UuX3NldFByb3hpZWQoKTsKICAgIHRoaXMuX3NldFByb3h5SGFuZGxlcnMocHJvbWlzZSwgLTE1KTsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRCb3VuZFRvID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0Qm91bmRUbyhvYmopIHsKICAgIGlmIChvYmogIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgfCA4Mzg4NjA4OwogICAgICAgIHRoaXMuX2JvdW5kVG8gPSBvYmo7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjgzODg2MDgpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2lzQm91bmQgPSBmdW5jdGlvbiBQcm9taXNlJF9pc0JvdW5kKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDgzODg2MDgpID09PSA4Mzg4NjA4Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Jlc29sdmVGcm9tUmVzb2x2ZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVJlc29sdmVyKHJlc29sdmVyKSB7CiAgICB2YXIgcHJvbWlzZSA9IHRoaXM7CiAgICB0aGlzLl9zZXRUcmFjZSh2b2lkIDApOwogICAgdGhpcy5fcHVzaENvbnRleHQoKTsKCiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlcih2YWwpIHsKICAgICAgICBpZiAocHJvbWlzZS5fdHJ5Rm9sbG93KHZhbCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwcm9taXNlLl9mdWxmaWxsKHZhbCk7CiAgICB9CiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZWplY3Rlcih2YWwpIHsKICAgICAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2godmFsKSA/IHZhbCA6IG5ldyBFcnJvcih2YWwgKyAiIik7CiAgICAgICAgcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgbWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKHZhbCk7CiAgICAgICAgcHJvbWlzZS5fcmVqZWN0KHZhbCwgdHJhY2UgPT09IHZhbCA/IHZvaWQgMCA6IHRyYWNlKTsKICAgIH0KICAgIHZhciByID0gdHJ5Q2F0Y2gyKHJlc29sdmVyLCB2b2lkIDAsIFByb21pc2UkX3Jlc29sdmVyLCBQcm9taXNlJF9yZWplY3Rlcik7CiAgICB0aGlzLl9wb3BDb250ZXh0KCk7CgogICAgaWYgKHIgIT09IHZvaWQgMCAmJiByID09PSBlcnJvck9iaikgewogICAgICAgIHZhciBlID0gci5lOwogICAgICAgIHZhciB0cmFjZSA9IGNhbkF0dGFjaChlKSA/IGUgOiBuZXcgRXJyb3IoZSArICIiKTsKICAgICAgICBwcm9taXNlLl9yZWplY3QoZSwgdHJhY2UpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NwcmVhZFNsb3dDYXNlID0KZnVuY3Rpb24gUHJvbWlzZSRfc3ByZWFkU2xvd0Nhc2UodGFyZ2V0Rm4sIHByb21pc2UsIHZhbHVlcywgYm91bmRUbykgewogICAgdmFyIHByb21pc2VGb3JBbGwgPSBuZXcgUHJvbWlzZUFycmF5KHZhbHVlcykucHJvbWlzZSgpOwogICAgdmFyIHByb21pc2UyID0gcHJvbWlzZUZvckFsbC5fdGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGFyZ2V0Rm4uYXBwbHkoYm91bmRUbywgYXJndW1lbnRzKTsKICAgIH0sIHZvaWQgMCwgdm9pZCAwLCBBUFBMWSwgdm9pZCAwKTsKICAgIHByb21pc2UuX2ZvbGxvdyhwcm9taXNlMik7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FsbFNwcmVhZCA9CmZ1bmN0aW9uIFByb21pc2UkX2NhbGxTcHJlYWQoaGFuZGxlciwgcHJvbWlzZSwgdmFsdWUpIHsKICAgIHZhciBib3VuZFRvID0gdGhpcy5fYm91bmRUbzsKICAgIGlmIChpc0FycmF5KHZhbHVlKSkgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB2YWx1ZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgICBpZiAoY2FzdCh2YWx1ZVtpXSwgdm9pZCAwKSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NwcmVhZFNsb3dDYXNlKGhhbmRsZXIsIHByb21pc2UsIHZhbHVlLCBib3VuZFRvKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHByb21pc2UuX3B1c2hDb250ZXh0KCk7CiAgICByZXR1cm4gdHJ5Q2F0Y2hBcHBseShoYW5kbGVyLCB2YWx1ZSwgYm91bmRUbyk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2FsbEhhbmRsZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9jYWxsSGFuZGxlcigKICAgIGhhbmRsZXIsIHJlY2VpdmVyLCBwcm9taXNlLCB2YWx1ZSkgewogICAgdmFyIHg7CiAgICBpZiAocmVjZWl2ZXIgPT09IEFQUExZICYmICF0aGlzLmlzUmVqZWN0ZWQoKSkgewogICAgICAgIHggPSB0aGlzLl9jYWxsU3ByZWFkKGhhbmRsZXIsIHByb21pc2UsIHZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcHJvbWlzZS5fcHVzaENvbnRleHQoKTsKICAgICAgICB4ID0gdHJ5Q2F0Y2gxKGhhbmRsZXIsIHJlY2VpdmVyLCB2YWx1ZSk7CiAgICB9CiAgICBwcm9taXNlLl9wb3BDb250ZXh0KCk7CiAgICByZXR1cm4geDsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXR0bGVQcm9taXNlRnJvbUhhbmRsZXIgPQpmdW5jdGlvbiBQcm9taXNlJF9zZXR0bGVQcm9taXNlRnJvbUhhbmRsZXIoCiAgICBoYW5kbGVyLCByZWNlaXZlciwgdmFsdWUsIHByb21pc2UKKSB7CiAgICBpZiAoIShwcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkpIHsKICAgICAgICBoYW5kbGVyLmNhbGwocmVjZWl2ZXIsIHZhbHVlLCBwcm9taXNlKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJvbWlzZS5pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciB4ID0gdGhpcy5fY2FsbEhhbmRsZXIoaGFuZGxlciwgcmVjZWl2ZXIsIHByb21pc2UsIHZhbHVlKTsKICAgIGlmIChwcm9taXNlLl9pc0ZvbGxvd2luZygpKSByZXR1cm47CgogICAgaWYgKHggPT09IGVycm9yT2JqIHx8IHggPT09IHByb21pc2UgfHwgeCA9PT0gTkVYVF9GSUxURVIpIHsKICAgICAgICB2YXIgZXJyID0geCA9PT0gcHJvbWlzZQogICAgICAgICAgICAgICAgICAgID8gbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IoKQogICAgICAgICAgICAgICAgICAgIDogeC5lOwogICAgICAgIHZhciB0cmFjZSA9IGNhbkF0dGFjaChlcnIpID8gZXJyIDogbmV3IEVycm9yKGVyciArICIiKTsKICAgICAgICBpZiAoeCAhPT0gTkVYVF9GSUxURVIpIHByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UodHJhY2UpOwogICAgICAgIHByb21pc2UuX3JlamVjdFVuY2hlY2tlZChlcnIsIHRyYWNlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGNhc3RWYWx1ZSA9IGNhc3QoeCwgcHJvbWlzZSk7CiAgICAgICAgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICAgICAgaWYgKGNhc3RWYWx1ZS5pc1JlamVjdGVkKCkgJiYKICAgICAgICAgICAgICAgICFjYXN0VmFsdWUuX2lzQ2FycnlpbmdTdGFja1RyYWNlKCkgJiYKICAgICAgICAgICAgICAgICFjYW5BdHRhY2goY2FzdFZhbHVlLl9zZXR0bGVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgdHJhY2UgPSBuZXcgRXJyb3IoY2FzdFZhbHVlLl9zZXR0bGVkVmFsdWUgKyAiIik7CiAgICAgICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgICAgICAgICAgICAgIGNhc3RWYWx1ZS5fc2V0Q2FycmllZFN0YWNrVHJhY2UodHJhY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb21pc2UuX2ZvbGxvdyhjYXN0VmFsdWUpOwogICAgICAgICAgICBwcm9taXNlLl9wcm9wYWdhdGVGcm9tKGNhc3RWYWx1ZSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvbWlzZS5fZnVsZmlsbFVuY2hlY2tlZCh4KTsKICAgICAgICB9CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZm9sbG93ID0KZnVuY3Rpb24gUHJvbWlzZSRfZm9sbG93KHByb21pc2UpIHsKICAgIHRoaXMuX3NldEZvbGxvd2luZygpOwoKICAgIGlmIChwcm9taXNlLmlzUGVuZGluZygpKSB7CiAgICAgICAgdGhpcy5fcHJvcGFnYXRlRnJvbShwcm9taXNlLCAxKTsKICAgICAgICBwcm9taXNlLl9wcm94eVByb21pc2UodGhpcyk7CiAgICB9IGVsc2UgaWYgKHByb21pc2UuaXNGdWxmaWxsZWQoKSkgewogICAgICAgIHRoaXMuX2Z1bGZpbGxVbmNoZWNrZWQocHJvbWlzZS5fc2V0dGxlZFZhbHVlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fcmVqZWN0VW5jaGVja2VkKHByb21pc2UuX3NldHRsZWRWYWx1ZSwKICAgICAgICAgICAgcHJvbWlzZS5fZ2V0Q2FycmllZFN0YWNrVHJhY2UoKSk7CiAgICB9CgogICAgaWYgKHByb21pc2UuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKCiAgICBpZiAoZGVidWdnaW5nICYmCiAgICAgICAgcHJvbWlzZS5fdHJhY2VQYXJlbnQgPT0gbnVsbCkgewogICAgICAgIHByb21pc2UuX3RyYWNlUGFyZW50ID0gdGhpczsKICAgIH0KfTsKClByb21pc2UucHJvdG90eXBlLl90cnlGb2xsb3cgPQpmdW5jdGlvbiBQcm9taXNlJF90cnlGb2xsb3codmFsdWUpIHsKICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpIHx8CiAgICAgICAgdmFsdWUgPT09IHRoaXMpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh2YWx1ZSwgdm9pZCAwKTsKICAgIGlmICghKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fZm9sbG93KG1heWJlUHJvbWlzZSk7CiAgICByZXR1cm4gdHJ1ZTsKfTsKClByb21pc2UucHJvdG90eXBlLl9yZXNldFRyYWNlID0gZnVuY3Rpb24gUHJvbWlzZSRfcmVzZXRUcmFjZSgpIHsKICAgIGlmIChkZWJ1Z2dpbmcpIHsKICAgICAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKHRoaXMuX3BlZWtDb250ZXh0KCkgPT09IHZvaWQgMCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0VHJhY2UgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRUcmFjZShwYXJlbnQpIHsKICAgIGlmIChkZWJ1Z2dpbmcpIHsKICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMuX3BlZWtDb250ZXh0KCk7CiAgICAgICAgdGhpcy5fdHJhY2VQYXJlbnQgPSBjb250ZXh0OwogICAgICAgIHZhciBpc1RvcExldmVsID0gY29udGV4dCA9PT0gdm9pZCAwOwogICAgICAgIGlmIChwYXJlbnQgIT09IHZvaWQgMCAmJgogICAgICAgICAgICBwYXJlbnQuX3RyYWNlUGFyZW50ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgIHRoaXMuX3RyYWNlID0gcGFyZW50Ll90cmFjZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl90cmFjZSA9IG5ldyBDYXB0dXJlZFRyYWNlKGlzVG9wTGV2ZWwpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3RyeUF0dGFjaEV4dHJhVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF90cnlBdHRhY2hFeHRyYVRyYWNlKGVycm9yKSB7CiAgICBpZiAoY2FuQXR0YWNoKGVycm9yKSkgewogICAgICAgIHRoaXMuX2F0dGFjaEV4dHJhVHJhY2UoZXJyb3IpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2F0dGFjaEV4dHJhVHJhY2UgPQpmdW5jdGlvbiBQcm9taXNlJF9hdHRhY2hFeHRyYVRyYWNlKGVycm9yKSB7CiAgICBpZiAoZGVidWdnaW5nKSB7CiAgICAgICAgdmFyIHByb21pc2UgPSB0aGlzOwogICAgICAgIHZhciBzdGFjayA9IGVycm9yLnN0YWNrOwogICAgICAgIHN0YWNrID0gdHlwZW9mIHN0YWNrID09PSAic3RyaW5nIiA/IHN0YWNrLnNwbGl0KCJcbiIpIDogW107CiAgICAgICAgQ2FwdHVyZWRUcmFjZS5wcm90ZWN0RXJyb3JNZXNzYWdlTmV3bGluZXMoc3RhY2spOwogICAgICAgIHZhciBoZWFkZXJMaW5lQ291bnQgPSAxOwogICAgICAgIHZhciBjb21iaW5lZFRyYWNlcyA9IDE7CiAgICAgICAgd2hpbGUocHJvbWlzZSAhPSBudWxsICYmCiAgICAgICAgICAgIHByb21pc2UuX3RyYWNlICE9IG51bGwpIHsKICAgICAgICAgICAgc3RhY2sgPSBDYXB0dXJlZFRyYWNlLmNvbWJpbmUoCiAgICAgICAgICAgICAgICBzdGFjaywKICAgICAgICAgICAgICAgIHByb21pc2UuX3RyYWNlLnN0YWNrLnNwbGl0KCJcbiIpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHByb21pc2UgPSBwcm9taXNlLl90cmFjZVBhcmVudDsKICAgICAgICAgICAgY29tYmluZWRUcmFjZXMrKzsKICAgICAgICB9CgogICAgICAgIHZhciBzdGFja1RyYWNlTGltaXQgPSBFcnJvci5zdGFja1RyYWNlTGltaXQgfHwgMTA7CiAgICAgICAgdmFyIG1heCA9IChzdGFja1RyYWNlTGltaXQgKyBoZWFkZXJMaW5lQ291bnQpICogY29tYmluZWRUcmFjZXM7CiAgICAgICAgdmFyIGxlbiA9IHN0YWNrLmxlbmd0aDsKICAgICAgICBpZiAobGVuID4gbWF4KSB7CiAgICAgICAgICAgIHN0YWNrLmxlbmd0aCA9IG1heDsKICAgICAgICB9CgogICAgICAgIGlmIChsZW4gPiAwKQogICAgICAgICAgICBzdGFja1swXSA9IHN0YWNrWzBdLnNwbGl0KCJcdTAwMDJcdTAwMDBcdTAwMDEiKS5qb2luKCJcbiIpOwoKICAgICAgICBpZiAoc3RhY2subGVuZ3RoIDw9IGhlYWRlckxpbmVDb3VudCkgewogICAgICAgICAgICBlcnJvci5zdGFjayA9ICIoTm8gc3RhY2sgdHJhY2UpIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlcnJvci5zdGFjayA9IHN0YWNrLmpvaW4oIlxuIik7CiAgICAgICAgfQogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2NsZWFuVmFsdWVzID0gZnVuY3Rpb24gUHJvbWlzZSRfY2xlYW5WYWx1ZXMoKSB7CiAgICBpZiAodGhpcy5fY2FuY2VsbGFibGUoKSkgewogICAgICAgIHRoaXMuX2NhbmNlbGxhdGlvblBhcmVudCA9IHZvaWQgMDsKICAgIH0KfTsKClByb21pc2UucHJvdG90eXBlLl9wcm9wYWdhdGVGcm9tID0KZnVuY3Rpb24gUHJvbWlzZSRfcHJvcGFnYXRlRnJvbShwYXJlbnQsIGZsYWdzKSB7CiAgICBpZiAoKGZsYWdzICYgMSkgPiAwICYmIHBhcmVudC5fY2FuY2VsbGFibGUoKSkgewogICAgICAgIHRoaXMuX3NldENhbmNlbGxhYmxlKCk7CiAgICAgICAgdGhpcy5fY2FuY2VsbGF0aW9uUGFyZW50ID0gcGFyZW50OwogICAgfQogICAgaWYgKChmbGFncyAmIDQpID4gMCkgewogICAgICAgIHRoaXMuX3NldEJvdW5kVG8ocGFyZW50Ll9ib3VuZFRvKTsKICAgIH0KICAgIGlmICgoZmxhZ3MgJiAyKSA+IDApIHsKICAgICAgICB0aGlzLl9zZXRUcmFjZShwYXJlbnQpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Z1bGZpbGwgPSBmdW5jdGlvbiBQcm9taXNlJF9mdWxmaWxsKHZhbHVlKSB7CiAgICBpZiAodGhpcy5faXNGb2xsb3dpbmdPckZ1bGZpbGxlZE9yUmVqZWN0ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fZnVsZmlsbFVuY2hlY2tlZCh2YWx1ZSk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVqZWN0ID0KZnVuY3Rpb24gUHJvbWlzZSRfcmVqZWN0KHJlYXNvbiwgY2FycmllZFN0YWNrVHJhY2UpIHsKICAgIGlmICh0aGlzLl9pc0ZvbGxvd2luZ09yRnVsZmlsbGVkT3JSZWplY3RlZCgpKSByZXR1cm47CiAgICB0aGlzLl9yZWplY3RVbmNoZWNrZWQocmVhc29uLCBjYXJyaWVkU3RhY2tUcmFjZSk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fc2V0dGxlUHJvbWlzZUF0ID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0dGxlUHJvbWlzZUF0KGluZGV4KSB7CiAgICB2YXIgaGFuZGxlciA9IHRoaXMuaXNGdWxmaWxsZWQoKQogICAgICAgID8gdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyQXQoaW5kZXgpCiAgICAgICAgOiB0aGlzLl9yZWplY3Rpb25IYW5kbGVyQXQoaW5kZXgpOwoKICAgIHZhciB2YWx1ZSA9IHRoaXMuX3NldHRsZWRWYWx1ZTsKICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3JlY2VpdmVyQXQoaW5kZXgpOwogICAgdmFyIHByb21pc2UgPSB0aGlzLl9wcm9taXNlQXQoaW5kZXgpOwoKICAgIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHRoaXMuX3NldHRsZVByb21pc2VGcm9tSGFuZGxlcihoYW5kbGVyLCByZWNlaXZlciwgdmFsdWUsIHByb21pc2UpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgZG9uZSA9IGZhbHNlOwogICAgICAgIHZhciBpc0Z1bGZpbGxlZCA9IHRoaXMuaXNGdWxmaWxsZWQoKTsKICAgICAgICBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAocmVjZWl2ZXIgaW5zdGFuY2VvZiBQcm9taXNlICYmCiAgICAgICAgICAgICAgICByZWNlaXZlci5faXNQcm94aWVkKCkpIHsKICAgICAgICAgICAgICAgIHJlY2VpdmVyLl91bnNldFByb3hpZWQoKTsKCiAgICAgICAgICAgICAgICBpZiAoaXNGdWxmaWxsZWQpIHJlY2VpdmVyLl9mdWxmaWxsVW5jaGVja2VkKHZhbHVlKTsKICAgICAgICAgICAgICAgIGVsc2UgcmVjZWl2ZXIuX3JlamVjdFVuY2hlY2tlZCh2YWx1ZSwKICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSgpKTsKICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHJlY2VpdmVyIGluc3RhbmNlb2YgUHJvbWlzZUFycmF5KSB7CiAgICAgICAgICAgICAgICBpZiAoaXNGdWxmaWxsZWQpIHJlY2VpdmVyLl9wcm9taXNlRnVsZmlsbGVkKHZhbHVlLCBwcm9taXNlKTsKICAgICAgICAgICAgICAgIGVsc2UgcmVjZWl2ZXIuX3Byb21pc2VSZWplY3RlZCh2YWx1ZSwgcHJvbWlzZSk7CiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFkb25lKSB7CiAgICAgICAgICAgIGlmIChpc0Z1bGZpbGxlZCkgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgICAgIGVsc2UgcHJvbWlzZS5fcmVqZWN0KHZhbHVlLCB0aGlzLl9nZXRDYXJyaWVkU3RhY2tUcmFjZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKGluZGV4ID49IDQpIHsKICAgICAgICB0aGlzLl9xdWV1ZUdDKCk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNQcm94aWVkID0gZnVuY3Rpb24gUHJvbWlzZSRfaXNQcm94aWVkKCkgewogICAgcmV0dXJuICh0aGlzLl9iaXRGaWVsZCAmIDQxOTQzMDQpID09PSA0MTk0MzA0Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldFByb3hpZWQgPSBmdW5jdGlvbiBQcm9taXNlJF9zZXRQcm94aWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDQxOTQzMDQ7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fdW5zZXRQcm94aWVkID0gZnVuY3Rpb24gUHJvbWlzZSRfdW5zZXRQcm94aWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+NDE5NDMwNCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5faXNHY1F1ZXVlZCA9IGZ1bmN0aW9uIFByb21pc2UkX2lzR2NRdWV1ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgLTEwNzM3NDE4MjQpID09PSAtMTA3Mzc0MTgyNDsKfTsKClByb21pc2UucHJvdG90eXBlLl9zZXRHY1F1ZXVlZCA9IGZ1bmN0aW9uIFByb21pc2UkX3NldEdjUXVldWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IC0xMDczNzQxODI0Owp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3Vuc2V0R2NRdWV1ZWQgPSBmdW5jdGlvbiBQcm9taXNlJF91bnNldEdjUXVldWVkKCkgewogICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCAmICh+LTEwNzM3NDE4MjQpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3F1ZXVlR0MgPSBmdW5jdGlvbiBQcm9taXNlJF9xdWV1ZUdDKCkgewogICAgaWYgKHRoaXMuX2lzR2NRdWV1ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fc2V0R2NRdWV1ZWQoKTsKICAgIGFzeW5jLmludm9rZUxhdGVyKHRoaXMuX2djLCB0aGlzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2djID0gZnVuY3Rpb24gUHJvbWlzZSRnYygpIHsKICAgIHZhciBsZW4gPSB0aGlzLl9sZW5ndGgoKSAqIDUgLSA1OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgIGRlbGV0ZSB0aGlzW2ldOwogICAgfQogICAgdGhpcy5fY2xlYXJGaXJzdEhhbmRsZXJEYXRhKCk7CiAgICB0aGlzLl9zZXRMZW5ndGgoMCk7CiAgICB0aGlzLl91bnNldEdjUXVldWVkKCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fY2xlYXJGaXJzdEhhbmRsZXJEYXRhID0KZnVuY3Rpb24gUHJvbWlzZSRfY2xlYXJGaXJzdEhhbmRsZXJEYXRhKCkgewogICAgdGhpcy5fZnVsZmlsbG1lbnRIYW5kbGVyMCA9IHZvaWQgMDsKICAgIHRoaXMuX3JlamVjdGlvbkhhbmRsZXIwID0gdm9pZCAwOwogICAgdGhpcy5fcHJvbWlzZTAgPSB2b2lkIDA7CiAgICB0aGlzLl9yZWNlaXZlcjAgPSB2b2lkIDA7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcXVldWVTZXR0bGVBdCA9IGZ1bmN0aW9uIFByb21pc2UkX3F1ZXVlU2V0dGxlQXQoaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1JlamVjdGlvblVuaGFuZGxlZCgpKSB0aGlzLl91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICBhc3luYy5pbnZva2UodGhpcy5fc2V0dGxlUHJvbWlzZUF0LCB0aGlzLCBpbmRleCk7Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fZnVsZmlsbFVuY2hlY2tlZCA9CmZ1bmN0aW9uIFByb21pc2UkX2Z1bGZpbGxVbmNoZWNrZWQodmFsdWUpIHsKICAgIGlmICghdGhpcy5pc1BlbmRpbmcoKSkgcmV0dXJuOwogICAgaWYgKHZhbHVlID09PSB0aGlzKSB7CiAgICAgICAgdmFyIGVyciA9IG1ha2VTZWxmUmVzb2x1dGlvbkVycm9yKCk7CiAgICAgICAgdGhpcy5fYXR0YWNoRXh0cmFUcmFjZShlcnIpOwogICAgICAgIHJldHVybiB0aGlzLl9yZWplY3RVbmNoZWNrZWQoZXJyLCB2b2lkIDApOwogICAgfQogICAgdGhpcy5fY2xlYW5WYWx1ZXMoKTsKICAgIHRoaXMuX3NldEZ1bGZpbGxlZCgpOwogICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKGxlbiA+IDApIHsKICAgICAgICBhc3luYy5pbnZva2UodGhpcy5fc2V0dGxlUHJvbWlzZXMsIHRoaXMsIGxlbik7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fcmVqZWN0VW5jaGVja2VkQ2hlY2tFcnJvciA9CmZ1bmN0aW9uIFByb21pc2UkX3JlamVjdFVuY2hlY2tlZENoZWNrRXJyb3IocmVhc29uKSB7CiAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICB0aGlzLl9yZWplY3RVbmNoZWNrZWQocmVhc29uLCB0cmFjZSA9PT0gcmVhc29uID8gdm9pZCAwIDogdHJhY2UpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdFVuY2hlY2tlZCA9CmZ1bmN0aW9uIFByb21pc2UkX3JlamVjdFVuY2hlY2tlZChyZWFzb24sIHRyYWNlKSB7CiAgICBpZiAoIXRoaXMuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIGlmIChyZWFzb24gPT09IHRoaXMpIHsKICAgICAgICB2YXIgZXJyID0gbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IoKTsKICAgICAgICB0aGlzLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdFVuY2hlY2tlZChlcnIpOwogICAgfQogICAgdGhpcy5fY2xlYW5WYWx1ZXMoKTsKICAgIHRoaXMuX3NldFJlamVjdGVkKCk7CiAgICB0aGlzLl9zZXR0bGVkVmFsdWUgPSByZWFzb247CgogICAgaWYgKHRoaXMuX2lzRmluYWwoKSkgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHRocm93ZXIsIHZvaWQgMCwgdHJhY2UgPT09IHZvaWQgMCA/IHJlYXNvbiA6IHRyYWNlKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CgogICAgaWYgKHRyYWNlICE9PSB2b2lkIDApIHRoaXMuX3NldENhcnJpZWRTdGFja1RyYWNlKHRyYWNlKTsKCiAgICBpZiAobGVuID4gMCkgewogICAgICAgIGFzeW5jLmludm9rZSh0aGlzLl9yZWplY3RQcm9taXNlcywgdGhpcywgbnVsbCk7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3JlamVjdFByb21pc2VzID0gZnVuY3Rpb24gUHJvbWlzZSRfcmVqZWN0UHJvbWlzZXMoKSB7CiAgICB0aGlzLl9zZXR0bGVQcm9taXNlcygpOwogICAgdGhpcy5fdW5zZXRDYXJyaWVkU3RhY2tUcmFjZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VzID0gZnVuY3Rpb24gUHJvbWlzZSRfc2V0dGxlUHJvbWlzZXMoKSB7CiAgICB2YXIgbGVuID0gdGhpcy5fbGVuZ3RoKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgdGhpcy5fc2V0dGxlUHJvbWlzZUF0KGkpOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2UkX2Vuc3VyZVBvc3NpYmxlUmVqZWN0aW9uSGFuZGxlZCgpIHsKICAgIHRoaXMuX3NldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICBpZiAoQ2FwdHVyZWRUcmFjZS5wb3NzaWJseVVuaGFuZGxlZFJlamVjdGlvbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgYXN5bmMuaW52b2tlTGF0ZXIodGhpcy5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uLCB0aGlzLCB2b2lkIDApOwogICAgfQp9OwoKUHJvbWlzZS5wcm90b3R5cGUuX25vdGlmeVVuaGFuZGxlZFJlamVjdGlvbklzSGFuZGxlZCA9CmZ1bmN0aW9uIFByb21pc2UkX25vdGlmeVVuaGFuZGxlZFJlamVjdGlvbklzSGFuZGxlZCgpIHsKICAgIGlmICh0eXBlb2YgdW5oYW5kbGVkUmVqZWN0aW9uSGFuZGxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGFzeW5jLmludm9rZUxhdGVyKHVuaGFuZGxlZFJlamVjdGlvbkhhbmRsZWQsIHZvaWQgMCwgdGhpcyk7CiAgICB9Cn07CgpQcm9taXNlLnByb3RvdHlwZS5fbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uID0KZnVuY3Rpb24gUHJvbWlzZSRfbm90aWZ5VW5oYW5kbGVkUmVqZWN0aW9uKCkgewogICAgaWYgKHRoaXMuX2lzUmVqZWN0aW9uVW5oYW5kbGVkKCkpIHsKICAgICAgICB2YXIgcmVhc29uID0gdGhpcy5fc2V0dGxlZFZhbHVlOwogICAgICAgIHZhciB0cmFjZSA9IHRoaXMuX2dldENhcnJpZWRTdGFja1RyYWNlKCk7CgogICAgICAgIHRoaXMuX3NldFVuaGFuZGxlZFJlamVjdGlvbklzTm90aWZpZWQoKTsKCiAgICAgICAgaWYgKHRyYWNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdGhpcy5fdW5zZXRDYXJyaWVkU3RhY2tUcmFjZSgpOwogICAgICAgICAgICByZWFzb24gPSB0cmFjZTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBDYXB0dXJlZFRyYWNlLnBvc3NpYmx5VW5oYW5kbGVkUmVqZWN0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIENhcHR1cmVkVHJhY2UucG9zc2libHlVbmhhbmRsZWRSZWplY3Rpb24ocmVhc29uLCB0aGlzKTsKICAgICAgICB9CiAgICB9Cn07Cgp2YXIgY29udGV4dFN0YWNrID0gW107ClByb21pc2UucHJvdG90eXBlLl9wZWVrQ29udGV4dCA9IGZ1bmN0aW9uIFByb21pc2UkX3BlZWtDb250ZXh0KCkgewogICAgdmFyIGxhc3RJbmRleCA9IGNvbnRleHRTdGFjay5sZW5ndGggLSAxOwogICAgaWYgKGxhc3RJbmRleCA+PSAwKSB7CiAgICAgICAgcmV0dXJuIGNvbnRleHRTdGFja1tsYXN0SW5kZXhdOwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKCn07CgpQcm9taXNlLnByb3RvdHlwZS5fcHVzaENvbnRleHQgPSBmdW5jdGlvbiBQcm9taXNlJF9wdXNoQ29udGV4dCgpIHsKICAgIGlmICghZGVidWdnaW5nKSByZXR1cm47CiAgICBjb250ZXh0U3RhY2sucHVzaCh0aGlzKTsKfTsKClByb21pc2UucHJvdG90eXBlLl9wb3BDb250ZXh0ID0gZnVuY3Rpb24gUHJvbWlzZSRfcG9wQ29udGV4dCgpIHsKICAgIGlmICghZGVidWdnaW5nKSByZXR1cm47CiAgICBjb250ZXh0U3RhY2sucG9wKCk7Cn07CgpQcm9taXNlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbiBQcm9taXNlJE5vQ29uZmxpY3QoKSB7CiAgICByZXR1cm4gbm9Db25mbGljdChQcm9taXNlKTsKfTsKClByb21pc2Uuc2V0U2NoZWR1bGVyID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgYXN5bmMuX3NjaGVkdWxlID0gZm47Cn07CgppZiAoIUNhcHR1cmVkVHJhY2UuaXNTdXBwb3J0ZWQoKSkgewogICAgUHJvbWlzZS5sb25nU3RhY2tUcmFjZXMgPSBmdW5jdGlvbigpe307CiAgICBkZWJ1Z2dpbmcgPSBmYWxzZTsKfQoKUHJvbWlzZS5fbWFrZVNlbGZSZXNvbHV0aW9uRXJyb3IgPSBtYWtlU2VsZlJlc29sdXRpb25FcnJvcjsKcmVxdWlyZSgiLi9maW5hbGx5LmpzIikoUHJvbWlzZSwgTkVYVF9GSUxURVIsIGNhc3QpOwpyZXF1aXJlKCIuL2RpcmVjdF9yZXNvbHZlLmpzIikoUHJvbWlzZSk7CnJlcXVpcmUoIi4vc3luY2hyb25vdXNfaW5zcGVjdGlvbi5qcyIpKFByb21pc2UpOwpyZXF1aXJlKCIuL2pvaW4uanMiKShQcm9taXNlLCBQcm9taXNlQXJyYXksIGNhc3QsIElOVEVSTkFMKTsKUHJvbWlzZS5SYW5nZUVycm9yID0gUmFuZ2VFcnJvcjsKUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvciA9IENhbmNlbGxhdGlvbkVycm9yOwpQcm9taXNlLlRpbWVvdXRFcnJvciA9IFRpbWVvdXRFcnJvcjsKUHJvbWlzZS5UeXBlRXJyb3IgPSBUeXBlRXJyb3I7ClByb21pc2UuT3BlcmF0aW9uYWxFcnJvciA9IE9wZXJhdGlvbmFsRXJyb3I7ClByb21pc2UuUmVqZWN0aW9uRXJyb3IgPSBPcGVyYXRpb25hbEVycm9yOwpQcm9taXNlLkFnZ3JlZ2F0ZUVycm9yID0gZXJyb3JzLkFnZ3JlZ2F0ZUVycm9yOwoKdXRpbC50b0Zhc3RQcm9wZXJ0aWVzKFByb21pc2UpOwp1dGlsLnRvRmFzdFByb3BlcnRpZXMoUHJvbWlzZS5wcm90b3R5cGUpOwpQcm9taXNlLlByb21pc2UgPSBQcm9taXNlOwpyZXF1aXJlKCcuL3RpbWVycy5qcycpKFByb21pc2UsSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vcmFjZS5qcycpKFByb21pc2UsSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vY2FsbF9nZXQuanMnKShQcm9taXNlKTsKcmVxdWlyZSgnLi9nZW5lcmF0b3JzLmpzJykoUHJvbWlzZSxhcGlSZWplY3Rpb24sSU5URVJOQUwsY2FzdCk7CnJlcXVpcmUoJy4vbWFwLmpzJykoUHJvbWlzZSxQcm9taXNlQXJyYXksYXBpUmVqZWN0aW9uLGNhc3QsSU5URVJOQUwpOwpyZXF1aXJlKCcuL25vZGVpZnkuanMnKShQcm9taXNlKTsKcmVxdWlyZSgnLi9wcm9taXNpZnkuanMnKShQcm9taXNlLElOVEVSTkFMKTsKcmVxdWlyZSgnLi9wcm9wcy5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGNhc3QpOwpyZXF1aXJlKCcuL3JlZHVjZS5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGFwaVJlamVjdGlvbixjYXN0LElOVEVSTkFMKTsKcmVxdWlyZSgnLi9zZXR0bGUuanMnKShQcm9taXNlLFByb21pc2VBcnJheSk7CnJlcXVpcmUoJy4vc29tZS5qcycpKFByb21pc2UsUHJvbWlzZUFycmF5LGFwaVJlamVjdGlvbik7CnJlcXVpcmUoJy4vcHJvZ3Jlc3MuanMnKShQcm9taXNlLFByb21pc2VBcnJheSk7CnJlcXVpcmUoJy4vY2FuY2VsLmpzJykoUHJvbWlzZSxJTlRFUk5BTCk7CnJlcXVpcmUoJy4vZmlsdGVyLmpzJykoUHJvbWlzZSxJTlRFUk5BTCk7CnJlcXVpcmUoJy4vYW55LmpzJykoUHJvbWlzZSxQcm9taXNlQXJyYXkpOwpyZXF1aXJlKCcuL2VhY2guanMnKShQcm9taXNlLElOVEVSTkFMKTsKcmVxdWlyZSgnLi91c2luZy5qcycpKFByb21pc2UsYXBpUmVqZWN0aW9uLGNhc3QpOwoKUHJvbWlzZS5wcm90b3R5cGUgPSBQcm9taXNlLnByb3RvdHlwZTsKcmV0dXJuIFByb21pc2U7Cgp9OwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL2FueS5qcyI6MTcsIi4vYXN5bmMuanMiOjE4LCIuL2NhbGxfZ2V0LmpzIjoxOSwiLi9jYW5jZWwuanMiOjIwLCIuL2NhcHR1cmVkX3RyYWNlLmpzIjoyMSwiLi9jYXRjaF9maWx0ZXIuanMiOjIyLCIuL2RpcmVjdF9yZXNvbHZlLmpzIjoyMywiLi9lYWNoLmpzIjoyNCwiLi9lcnJvcnMuanMiOjI1LCIuL2Vycm9yc19hcGlfcmVqZWN0aW9uIjoyNiwiLi9maWx0ZXIuanMiOjI4LCIuL2ZpbmFsbHkuanMiOjI5LCIuL2dlbmVyYXRvcnMuanMiOjMwLCIuL2pvaW4uanMiOjMxLCIuL21hcC5qcyI6MzIsIi4vbm9kZWlmeS5qcyI6MzMsIi4vcHJvZ3Jlc3MuanMiOjM0LCIuL3Byb21pc2VfYXJyYXkuanMiOjM2LCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiOjM3LCIuL3Byb21pc2lmeS5qcyI6MzgsIi4vcHJvcHMuanMiOjM5LCIuL3JhY2UuanMiOjQxLCIuL3JlZHVjZS5qcyI6NDIsIi4vc2V0dGxlLmpzIjo0NCwiLi9zb21lLmpzIjo0NSwiLi9zeW5jaHJvbm91c19pbnNwZWN0aW9uLmpzIjo0NiwiLi90aGVuYWJsZXMuanMiOjQ3LCIuL3RpbWVycy5qcyI6NDgsIi4vdXNpbmcuanMiOjQ5LCIuL3V0aWwuanMiOjUwLCJfcHJvY2VzcyI6NjB9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KSB7CnZhciBjYW5BdHRhY2ggPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLmNhbkF0dGFjaDsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGlzQXJyYXkgPSB1dGlsLmlzQXJyYXk7CgpmdW5jdGlvbiB0b1Jlc29sdXRpb25WYWx1ZSh2YWwpIHsKICAgIHN3aXRjaCh2YWwpIHsKICAgIGNhc2UgLTE6IHJldHVybiB2b2lkIDA7CiAgICBjYXNlIC0yOiByZXR1cm4gW107CiAgICBjYXNlIC0zOiByZXR1cm4ge307CiAgICB9Cn0KCmZ1bmN0aW9uIFByb21pc2VBcnJheSh2YWx1ZXMpIHsKICAgIHZhciBwcm9taXNlID0gdGhpcy5fcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHZhciBwYXJlbnQgPSB2b2lkIDA7CiAgICBpZiAodmFsdWVzIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHBhcmVudCA9IHZhbHVlczsKICAgICAgICBwcm9taXNlLl9wcm9wYWdhdGVGcm9tKHBhcmVudCwgMSB8IDQpOwogICAgfQogICAgcHJvbWlzZS5fc2V0VHJhY2UocGFyZW50KTsKICAgIHRoaXMuX3ZhbHVlcyA9IHZhbHVlczsKICAgIHRoaXMuX2xlbmd0aCA9IDA7CiAgICB0aGlzLl90b3RhbFJlc29sdmVkID0gMDsKICAgIHRoaXMuX2luaXQodm9pZCAwLCAtMik7Cn0KUHJvbWlzZUFycmF5LnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkbGVuZ3RoKCkgewogICAgcmV0dXJuIHRoaXMuX2xlbmd0aDsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUucHJvbWlzZSA9IGZ1bmN0aW9uIFByb21pc2VBcnJheSRwcm9taXNlKCkgewogICAgcmV0dXJuIHRoaXMuX3Byb21pc2U7Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9pbml0KF8sIHJlc29sdmVWYWx1ZUlmRW1wdHkpIHsKICAgIHZhciB2YWx1ZXMgPSBjYXN0KHRoaXMuX3ZhbHVlcywgdm9pZCAwKTsKICAgIGlmICh2YWx1ZXMgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgdGhpcy5fdmFsdWVzID0gdmFsdWVzOwogICAgICAgIHZhbHVlcy5fc2V0Qm91bmRUbyh0aGlzLl9wcm9taXNlLl9ib3VuZFRvKTsKICAgICAgICBpZiAodmFsdWVzLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICAgICAgdmFsdWVzID0gdmFsdWVzLl9zZXR0bGVkVmFsdWU7CiAgICAgICAgICAgIGlmICghaXNBcnJheSh2YWx1ZXMpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyID0gbmV3IFByb21pc2UuVHlwZUVycm9yKCJleHBlY3RpbmcgYW4gYXJyYXksIGEgcHJvbWlzZSBvciBhIHRoZW5hYmxlIik7CiAgICAgICAgICAgICAgICB0aGlzLl9faGFyZFJlamVjdF9fKGVycik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHZhbHVlcy5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICB2YWx1ZXMuX3RoZW4oCiAgICAgICAgICAgICAgICBQcm9taXNlQXJyYXkkX2luaXQsCiAgICAgICAgICAgICAgICB0aGlzLl9yZWplY3QsCiAgICAgICAgICAgICAgICB2b2lkIDAsCiAgICAgICAgICAgICAgICB0aGlzLAogICAgICAgICAgICAgICAgcmVzb2x2ZVZhbHVlSWZFbXB0eQogICAgICAgICAgICk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZXMuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgdGhpcy5fcmVqZWN0KHZhbHVlcy5fc2V0dGxlZFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoIWlzQXJyYXkodmFsdWVzKSkgewogICAgICAgIHZhciBlcnIgPSBuZXcgUHJvbWlzZS5UeXBlRXJyb3IoImV4cGVjdGluZyBhbiBhcnJheSwgYSBwcm9taXNlIG9yIGEgdGhlbmFibGUiKTsKICAgICAgICB0aGlzLl9faGFyZFJlamVjdF9fKGVycik7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGlmICh2YWx1ZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKHJlc29sdmVWYWx1ZUlmRW1wdHkgPT09IC01KSB7CiAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVFbXB0eUFycmF5KCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLl9yZXNvbHZlKHRvUmVzb2x1dGlvblZhbHVlKHJlc29sdmVWYWx1ZUlmRW1wdHkpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGxlbiA9IHRoaXMuZ2V0QWN0dWFsTGVuZ3RoKHZhbHVlcy5sZW5ndGgpOwogICAgdmFyIG5ld0xlbiA9IGxlbjsKICAgIHZhciBuZXdWYWx1ZXMgPSB0aGlzLnNob3VsZENvcHlWYWx1ZXMoKSA/IG5ldyBBcnJheShsZW4pIDogdGhpcy5fdmFsdWVzOwogICAgdmFyIGlzRGlyZWN0U2Nhbk5lZWRlZCA9IGZhbHNlOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHZhciBtYXliZVByb21pc2UgPSBjYXN0KHZhbHVlc1tpXSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICBpZiAobWF5YmVQcm9taXNlLmlzUGVuZGluZygpKSB7CiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWF5YmVQcm9taXNlLl91bnNldFJlamVjdGlvbklzVW5oYW5kbGVkKCk7CiAgICAgICAgICAgICAgICBpc0RpcmVjdFNjYW5OZWVkZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNEaXJlY3RTY2FuTmVlZGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgbmV3VmFsdWVzW2ldID0gbWF5YmVQcm9taXNlOwogICAgfQogICAgdGhpcy5fdmFsdWVzID0gbmV3VmFsdWVzOwogICAgdGhpcy5fbGVuZ3RoID0gbmV3TGVuOwogICAgaWYgKGlzRGlyZWN0U2Nhbk5lZWRlZCkgewogICAgICAgIHRoaXMuX3NjYW5EaXJlY3RWYWx1ZXMobGVuKTsKICAgIH0KfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3NldHRsZVByb21pc2VBdCA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfc2V0dGxlUHJvbWlzZUF0KGluZGV4KSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLl92YWx1ZXNbaW5kZXhdOwogICAgaWYgKCEodmFsdWUgaW5zdGFuY2VvZiBQcm9taXNlKSkgewogICAgICAgIHRoaXMuX3Byb21pc2VGdWxmaWxsZWQodmFsdWUsIGluZGV4KTsKICAgIH0gZWxzZSBpZiAodmFsdWUuaXNGdWxmaWxsZWQoKSkgewogICAgICAgIHRoaXMuX3Byb21pc2VGdWxmaWxsZWQodmFsdWUuX3NldHRsZWRWYWx1ZSwgaW5kZXgpOwogICAgfSBlbHNlIGlmICh2YWx1ZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICB0aGlzLl9wcm9taXNlUmVqZWN0ZWQodmFsdWUuX3NldHRsZWRWYWx1ZSwgaW5kZXgpOwogICAgfQp9OwoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fc2NhbkRpcmVjdFZhbHVlcyA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfc2NhbkRpcmVjdFZhbHVlcyhsZW4pIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zZXR0bGVQcm9taXNlQXQoaSk7CiAgICB9Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pc1Jlc29sdmVkID0gZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9pc1Jlc29sdmVkKCkgewogICAgcmV0dXJuIHRoaXMuX3ZhbHVlcyA9PT0gbnVsbDsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3Jlc29sdmUgPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3Jlc29sdmUodmFsdWUpIHsKICAgIHRoaXMuX3ZhbHVlcyA9IG51bGw7CiAgICB0aGlzLl9wcm9taXNlLl9mdWxmaWxsKHZhbHVlKTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX19oYXJkUmVqZWN0X18gPQpQcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZWplY3QgPSBmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3JlamVjdChyZWFzb24pIHsKICAgIHRoaXMuX3ZhbHVlcyA9IG51bGw7CiAgICB2YXIgdHJhY2UgPSBjYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICB0aGlzLl9wcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgIHRoaXMuX3Byb21pc2UuX3JlamVjdChyZWFzb24sIHRyYWNlKTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VQcm9ncmVzc2VkID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9wcm9taXNlUHJvZ3Jlc3NlZChwcm9ncmVzc1ZhbHVlLCBpbmRleCkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fcHJvbWlzZS5fcHJvZ3Jlc3MoewogICAgICAgIGluZGV4OiBpbmRleCwKICAgICAgICB2YWx1ZTogcHJvZ3Jlc3NWYWx1ZQogICAgfSk7Cn07CgoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZUZ1bGZpbGxlZCA9CmZ1bmN0aW9uIFByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHRoaXMuX3ZhbHVlc1tpbmRleF0gPSB2YWx1ZTsKICAgIHZhciB0b3RhbFJlc29sdmVkID0gKyt0aGlzLl90b3RhbFJlc29sdmVkOwogICAgaWYgKHRvdGFsUmVzb2x2ZWQgPj0gdGhpcy5fbGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fcmVzb2x2ZSh0aGlzLl92YWx1ZXMpOwogICAgfQp9OwoKUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVJlamVjdGVkID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JF9wcm9taXNlUmVqZWN0ZWQocmVhc29uLCBpbmRleCkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fdG90YWxSZXNvbHZlZCsrOwogICAgdGhpcy5fcmVqZWN0KHJlYXNvbik7Cn07CgpQcm9taXNlQXJyYXkucHJvdG90eXBlLnNob3VsZENvcHlWYWx1ZXMgPQpmdW5jdGlvbiBQcm9taXNlQXJyYXkkX3Nob3VsZENvcHlWYWx1ZXMoKSB7CiAgICByZXR1cm4gdHJ1ZTsKfTsKClByb21pc2VBcnJheS5wcm90b3R5cGUuZ2V0QWN0dWFsTGVuZ3RoID0KZnVuY3Rpb24gUHJvbWlzZUFycmF5JGdldEFjdHVhbExlbmd0aChsZW4pIHsKICAgIHJldHVybiBsZW47Cn07CgpyZXR1cm4gUHJvbWlzZUFycmF5Owp9OwoKfSx7Ii4vZXJyb3JzLmpzIjoyNSwiLi91dGlsLmpzIjo1MH1dLDM3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBtYXliZVdyYXBBc0Vycm9yID0gdXRpbC5tYXliZVdyYXBBc0Vycm9yOwp2YXIgZXJyb3JzID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKTsKdmFyIFRpbWVvdXRFcnJvciA9IGVycm9ycy5UaW1lb3V0RXJyb3I7CnZhciBPcGVyYXRpb25hbEVycm9yID0gZXJyb3JzLk9wZXJhdGlvbmFsRXJyb3I7CnZhciBhc3luYyA9IHJlcXVpcmUoIi4vYXN5bmMuanMiKTsKdmFyIGhhdmVHZXR0ZXJzID0gdXRpbC5oYXZlR2V0dGVyczsKdmFyIGVzNSA9IHJlcXVpcmUoIi4vZXM1LmpzIik7CgpmdW5jdGlvbiBpc1VudHlwZWRFcnJvcihvYmopIHsKICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBFcnJvciAmJgogICAgICAgIGVzNS5nZXRQcm90b3R5cGVPZihvYmopID09PSBFcnJvci5wcm90b3R5cGU7Cn0KCmZ1bmN0aW9uIHdyYXBBc09wZXJhdGlvbmFsRXJyb3Iob2JqKSB7CiAgICB2YXIgcmV0OwogICAgaWYgKGlzVW50eXBlZEVycm9yKG9iaikpIHsKICAgICAgICByZXQgPSBuZXcgT3BlcmF0aW9uYWxFcnJvcihvYmopOwogICAgfSBlbHNlIHsKICAgICAgICByZXQgPSBvYmo7CiAgICB9CiAgICBlcnJvcnMubWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKHJldCk7CiAgICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSkgewogICAgZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJF9jYWxsYmFjayhlcnIsIHZhbHVlKSB7CiAgICAgICAgaWYgKHByb21pc2UgPT09IG51bGwpIHJldHVybjsKCiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgICB2YXIgd3JhcHBlZCA9IHdyYXBBc09wZXJhdGlvbmFsRXJyb3IobWF5YmVXcmFwQXNFcnJvcihlcnIpKTsKICAgICAgICAgICAgcHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh3cmFwcGVkKTsKICAgICAgICAgICAgcHJvbWlzZS5fcmVqZWN0KHdyYXBwZWQpOwogICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHsKICAgICAgICAgICAgdmFyICRfbGVuID0gYXJndW1lbnRzLmxlbmd0aDt2YXIgYXJncyA9IG5ldyBBcnJheSgkX2xlbiAtIDEpOyBmb3IodmFyICRfaSA9IDE7ICRfaSA8ICRfbGVuOyArKyRfaSkge2FyZ3NbJF9pIC0gMV0gPSBhcmd1bWVudHNbJF9pXTt9CiAgICAgICAgICAgIHByb21pc2UuX2Z1bGZpbGwoYXJncyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICBwcm9taXNlID0gbnVsbDsKICAgIH0KICAgIHJldHVybiBQcm9taXNlUmVzb2x2ZXIkX2NhbGxiYWNrOwp9CgoKdmFyIFByb21pc2VSZXNvbHZlcjsKaWYgKCFoYXZlR2V0dGVycykgewogICAgUHJvbWlzZVJlc29sdmVyID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyKHByb21pc2UpIHsKICAgICAgICB0aGlzLnByb21pc2UgPSBwcm9taXNlOwogICAgICAgIHRoaXMuYXNDYWxsYmFjayA9IG5vZGViYWNrRm9yUHJvbWlzZShwcm9taXNlKTsKICAgICAgICB0aGlzLmNhbGxiYWNrID0gdGhpcy5hc0NhbGxiYWNrOwogICAgfTsKfQplbHNlIHsKICAgIFByb21pc2VSZXNvbHZlciA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlcihwcm9taXNlKSB7CiAgICAgICAgdGhpcy5wcm9taXNlID0gcHJvbWlzZTsKICAgIH07Cn0KaWYgKGhhdmVHZXR0ZXJzKSB7CiAgICB2YXIgcHJvcCA9IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbm9kZWJhY2tGb3JQcm9taXNlKHRoaXMucHJvbWlzZSk7CiAgICAgICAgfQogICAgfTsKICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLCAiYXNDYWxsYmFjayIsIHByb3ApOwogICAgZXM1LmRlZmluZVByb3BlcnR5KFByb21pc2VSZXNvbHZlci5wcm90b3R5cGUsICJjYWxsYmFjayIsIHByb3ApOwp9CgpQcm9taXNlUmVzb2x2ZXIuX25vZGViYWNrRm9yUHJvbWlzZSA9IG5vZGViYWNrRm9yUHJvbWlzZTsKClByb21pc2VSZXNvbHZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbiBQcm9taXNlUmVzb2x2ZXIkdG9TdHJpbmcoKSB7CiAgICByZXR1cm4gIltvYmplY3QgUHJvbWlzZVJlc29sdmVyXSI7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLnJlc29sdmUgPQpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmZ1bGZpbGwgPSBmdW5jdGlvbiBQcm9taXNlUmVzb2x2ZXIkcmVzb2x2ZSh2YWx1ZSkgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFByb21pc2VSZXNvbHZlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuIik7CiAgICB9CgogICAgdmFyIHByb21pc2UgPSB0aGlzLnByb21pc2U7CiAgICBpZiAocHJvbWlzZS5fdHJ5Rm9sbG93KHZhbHVlKSkgewogICAgICAgIHJldHVybjsKICAgIH0KICAgIGFzeW5jLmludm9rZShwcm9taXNlLl9mdWxmaWxsLCBwcm9taXNlLCB2YWx1ZSk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLnJlamVjdCA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRyZWplY3QocmVhc29uKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUHJvbWlzZVJlc29sdmVyKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIklsbGVnYWwgaW52b2NhdGlvbiwgcmVzb2x2ZXIgcmVzb2x2ZS9yZWplY3QgbXVzdCBiZSBjYWxsZWQgd2l0aGluIGEgcmVzb2x2ZXIgY29udGV4dC4gQ29uc2lkZXIgdXNpbmcgdGhlIHByb21pc2UgY29uc3RydWN0b3IgaW5zdGVhZC4iKTsKICAgIH0KCiAgICB2YXIgcHJvbWlzZSA9IHRoaXMucHJvbWlzZTsKICAgIGVycm9ycy5tYXJrQXNPcmlnaW5hdGluZ0Zyb21SZWplY3Rpb24ocmVhc29uKTsKICAgIHZhciB0cmFjZSA9IGVycm9ycy5jYW5BdHRhY2gocmVhc29uKSA/IHJlYXNvbiA6IG5ldyBFcnJvcihyZWFzb24gKyAiIik7CiAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRyYWNlKTsKICAgIGFzeW5jLmludm9rZShwcm9taXNlLl9yZWplY3QsIHByb21pc2UsIHJlYXNvbik7CiAgICBpZiAodHJhY2UgIT09IHJlYXNvbikgewogICAgICAgIGFzeW5jLmludm9rZSh0aGlzLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSwgdGhpcywgdHJhY2UpOwogICAgfQp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5wcm9ncmVzcyA9CmZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRwcm9ncmVzcyh2YWx1ZSkgewogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFByb21pc2VSZXNvbHZlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbGxlZ2FsIGludm9jYXRpb24sIHJlc29sdmVyIHJlc29sdmUvcmVqZWN0IG11c3QgYmUgY2FsbGVkIHdpdGhpbiBhIHJlc29sdmVyIGNvbnRleHQuIENvbnNpZGVyIHVzaW5nIHRoZSBwcm9taXNlIGNvbnN0cnVjdG9yIGluc3RlYWQuIik7CiAgICB9CiAgICBhc3luYy5pbnZva2UodGhpcy5wcm9taXNlLl9wcm9ncmVzcywgdGhpcy5wcm9taXNlLCB2YWx1ZSk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLmNhbmNlbCA9IGZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRjYW5jZWwoKSB7CiAgICBhc3luYy5pbnZva2UodGhpcy5wcm9taXNlLmNhbmNlbCwgdGhpcy5wcm9taXNlLCB2b2lkIDApOwp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS50aW1lb3V0ID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJHRpbWVvdXQoKSB7CiAgICB0aGlzLnJlamVjdChuZXcgVGltZW91dEVycm9yKCJ0aW1lb3V0IikpOwp9OwoKUHJvbWlzZVJlc29sdmVyLnByb3RvdHlwZS5pc1Jlc29sdmVkID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJGlzUmVzb2x2ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5wcm9taXNlLmlzUmVzb2x2ZWQoKTsKfTsKClByb21pc2VSZXNvbHZlci5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24gUHJvbWlzZVJlc29sdmVyJHRvSlNPTigpIHsKICAgIHJldHVybiB0aGlzLnByb21pc2UudG9KU09OKCk7Cn07CgpQcm9taXNlUmVzb2x2ZXIucHJvdG90eXBlLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSA9CmZ1bmN0aW9uIFByb21pc2VSZXNvbHZlciRfc2V0Q2FycmllZFN0YWNrVHJhY2UodHJhY2UpIHsKICAgIGlmICh0aGlzLnByb21pc2UuaXNSZWplY3RlZCgpKSB7CiAgICAgICAgdGhpcy5wcm9taXNlLl9zZXRDYXJyaWVkU3RhY2tUcmFjZSh0cmFjZSk7CiAgICB9Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFByb21pc2VSZXNvbHZlcjsKCn0seyIuL2FzeW5jLmpzIjoxOCwiLi9lcnJvcnMuanMiOjI1LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMKSB7CnZhciBUSElTID0ge307CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBub2RlYmFja0ZvclByb21pc2UgPSByZXF1aXJlKCIuL3Byb21pc2VfcmVzb2x2ZXIuanMiKQogICAgLl9ub2RlYmFja0ZvclByb21pc2U7CnZhciB3aXRoQXBwZW5kZWQgPSB1dGlsLndpdGhBcHBlbmRlZDsKdmFyIG1heWJlV3JhcEFzRXJyb3IgPSB1dGlsLm1heWJlV3JhcEFzRXJyb3I7CnZhciBjYW5FdmFsdWF0ZSA9IHV0aWwuY2FuRXZhbHVhdGU7CnZhciBUeXBlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycyIpLlR5cGVFcnJvcjsKdmFyIGRlZmF1bHRTdWZmaXggPSAiQXN5bmMiOwp2YXIgZGVmYXVsdEZpbHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKICAgIHJldHVybiB1dGlsLmlzSWRlbnRpZmllcihuYW1lKSAmJgogICAgICAgIG5hbWUuY2hhckF0KDApICE9PSAiXyIgJiYKICAgICAgICAhdXRpbC5pc0NsYXNzKGZ1bmMpOwp9Owp2YXIgZGVmYXVsdFByb21pc2lmaWVkID0ge19faXNQcm9taXNpZmllZF9fOiB0cnVlfTsKCgpmdW5jdGlvbiBlc2NhcGVJZGVudFJlZ2V4KHN0cikgewogICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8oWyRdKS8sICJcXCQiKTsKfQoKZnVuY3Rpb24gaXNQcm9taXNpZmllZChmbikgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4uX19pc1Byb21pc2lmaWVkX18gPT09IHRydWU7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQoKZnVuY3Rpb24gaGFzUHJvbWlzaWZpZWQob2JqLCBrZXksIHN1ZmZpeCkgewogICAgdmFyIHZhbCA9IHV0aWwuZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0KG9iaiwga2V5ICsgc3VmZml4LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9taXNpZmllZCk7CiAgICByZXR1cm4gdmFsID8gaXNQcm9taXNpZmllZCh2YWwpIDogZmFsc2U7Cn0KZnVuY3Rpb24gY2hlY2tWYWxpZChyZXQsIHN1ZmZpeCwgc3VmZml4UmVnZXhwKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldC5sZW5ndGg7IGkgKz0gMikgewogICAgICAgIHZhciBrZXkgPSByZXRbaV07CiAgICAgICAgaWYgKHN1ZmZpeFJlZ2V4cC50ZXN0KGtleSkpIHsKICAgICAgICAgICAgdmFyIGtleVdpdGhvdXRBc3luY1N1ZmZpeCA9IGtleS5yZXBsYWNlKHN1ZmZpeFJlZ2V4cCwgIiIpOwogICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJldC5sZW5ndGg7IGogKz0gMikgewogICAgICAgICAgICAgICAgaWYgKHJldFtqXSA9PT0ga2V5V2l0aG91dEFzeW5jU3VmZml4KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IHByb21pc2lmeSBhbiBBUEkgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aGF0IGhhcyBub3JtYWwgbWV0aG9kcyB3aXRoICciK3N1ZmZpeCsiJy1zdWZmaXgiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZnVuY3Rpb24gcHJvbWlzaWZpYWJsZU1ldGhvZHMob2JqLCBzdWZmaXgsIHN1ZmZpeFJlZ2V4cCwgZmlsdGVyKSB7CiAgICB2YXIga2V5cyA9IHV0aWwuaW5oZXJpdGVkRGF0YUtleXMob2JqKTsKICAgIHZhciByZXQgPSBbXTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgIHZhciB2YWx1ZSA9IG9ialtrZXldOwogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIgJiYKICAgICAgICAgICAgIWlzUHJvbWlzaWZpZWQodmFsdWUpICYmCiAgICAgICAgICAgICFoYXNQcm9taXNpZmllZChvYmosIGtleSwgc3VmZml4KSAmJgogICAgICAgICAgICBmaWx0ZXIoa2V5LCB2YWx1ZSwgb2JqKSkgewogICAgICAgICAgICByZXQucHVzaChrZXksIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBjaGVja1ZhbGlkKHJldCwgc3VmZml4LCBzdWZmaXhSZWdleHApOwogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gc3dpdGNoQ2FzZUFyZ3VtZW50T3JkZXIobGlrZWx5QXJndW1lbnRDb3VudCkgewogICAgdmFyIHJldCA9IFtsaWtlbHlBcmd1bWVudENvdW50XTsKICAgIHZhciBtaW4gPSBNYXRoLm1heCgwLCBsaWtlbHlBcmd1bWVudENvdW50IC0gMSAtIDUpOwogICAgZm9yKHZhciBpID0gbGlrZWx5QXJndW1lbnRDb3VudCAtIDE7IGkgPj0gbWluOyAtLWkpIHsKICAgICAgICBpZiAoaSA9PT0gbGlrZWx5QXJndW1lbnRDb3VudCkgY29udGludWU7CiAgICAgICAgcmV0LnB1c2goaSk7CiAgICB9CiAgICBmb3IodmFyIGkgPSBsaWtlbHlBcmd1bWVudENvdW50ICsgMTsgaSA8PSA1OyArK2kpIHsKICAgICAgICByZXQucHVzaChpKTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGFyZ3VtZW50U2VxdWVuY2UoYXJndW1lbnRDb3VudCkgewogICAgcmV0dXJuIHV0aWwuZmlsbGVkUmFuZ2UoYXJndW1lbnRDb3VudCwgImFyZ3VtZW50c1siLCAiXSIpOwp9CgpmdW5jdGlvbiBwYXJhbWV0ZXJEZWNsYXJhdGlvbihwYXJhbWV0ZXJDb3VudCkgewogICAgcmV0dXJuIHV0aWwuZmlsbGVkUmFuZ2UocGFyYW1ldGVyQ291bnQsICJfYXJnIiwgIiIpOwp9CgpmdW5jdGlvbiBwYXJhbWV0ZXJDb3VudChmbikgewogICAgaWYgKHR5cGVvZiBmbi5sZW5ndGggPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIE1hdGgubWF4KE1hdGgubWluKGZuLmxlbmd0aCwgMTAyMyArIDEpLCAwKTsKICAgIH0KICAgIHJldHVybiAwOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGtleSkgewogICAgaWYgKHV0aWwuaXNJZGVudGlmaWVyKGtleSkpIHsKICAgICAgICByZXR1cm4gIi4iICsga2V5OwogICAgfQogICAgZWxzZSByZXR1cm4gIlsnIiArIGtleS5yZXBsYWNlKC8oWydcXF0pL2csICJcXCQxIikgKyAiJ10iOwp9CgpmdW5jdGlvbiBtYWtlTm9kZVByb21pc2lmaWVkRXZhbChjYWxsYmFjaywgcmVjZWl2ZXIsIG9yaWdpbmFsTmFtZSwgZm4sIHN1ZmZpeCkgewogICAgdmFyIG5ld1BhcmFtZXRlckNvdW50ID0gTWF0aC5tYXgoMCwgcGFyYW1ldGVyQ291bnQoZm4pIC0gMSk7CiAgICB2YXIgYXJndW1lbnRPcmRlciA9IHN3aXRjaENhc2VBcmd1bWVudE9yZGVyKG5ld1BhcmFtZXRlckNvdW50KTsKICAgIHZhciBjYWxsYmFja05hbWUgPQogICAgICAgICh0eXBlb2Ygb3JpZ2luYWxOYW1lID09PSAic3RyaW5nIiAmJiB1dGlsLmlzSWRlbnRpZmllcihvcmlnaW5hbE5hbWUpCiAgICAgICAgICAgID8gb3JpZ2luYWxOYW1lICsgc3VmZml4CiAgICAgICAgICAgIDogInByb21pc2lmaWVkIik7CgogICAgZnVuY3Rpb24gZ2VuZXJhdGVDYWxsRm9yQXJndW1lbnRDb3VudChjb3VudCkgewogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRTZXF1ZW5jZShjb3VudCkuam9pbigiLCAiKTsKICAgICAgICB2YXIgY29tbWEgPSBjb3VudCA+IDAgPyAiLCAiIDogIiI7CiAgICAgICAgdmFyIHJldDsKICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXQgPSAiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgdGhpcy5tZXRob2Qoe3thcmdzfX0sIGZuKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiLnJlcGxhY2UoIi5tZXRob2QiLCBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGNhbGxiYWNrKSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciA9PT0gVEhJUykgewogICAgICAgICAgICByZXQgPSAgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzLCB7e2FyZ3N9fSwgZm4pOyAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSBpZiAocmVjZWl2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXQgPSAgIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbChyZWNlaXZlciwge3thcmdzfX0sIGZuKTsgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldCA9ICAiICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBjYWxsYmFjayh7e2FyZ3N9fSwgZm4pOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBicmVhazsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICI7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXQucmVwbGFjZSgie3thcmdzfX0iLCBhcmdzKS5yZXBsYWNlKCIsICIsIGNvbW1hKTsKICAgIH0KCiAgICBmdW5jdGlvbiBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpIHsKICAgICAgICB2YXIgcmV0ID0gIiI7CiAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGFyZ3VtZW50T3JkZXIubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgcmV0ICs9ICJjYXNlICIgKyBhcmd1bWVudE9yZGVyW2ldICsiOiIgKwogICAgICAgICAgICAgICAgZ2VuZXJhdGVDYWxsRm9yQXJndW1lbnRDb3VudChhcmd1bWVudE9yZGVyW2ldKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvZGVGb3JDYWxsOwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGNvZGVGb3JDYWxsID0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5LmFwcGx5KHRoaXMsIGFyZ3MpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICIKICAgICAgICAgICAgICAgIC5yZXBsYWNlKCIucHJvcGVydHkiLCBnZW5lcmF0ZVByb3BlcnR5QWNjZXNzKGNhbGxiYWNrKSk7CiAgICAgICAgfSBlbHNlIGlmIChyZWNlaXZlciA9PT0gVEhJUykgewogICAgICAgICAgICBjb2RlRm9yQ2FsbCA9ICIgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuXAogICAgICAgICAgICAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvZGVGb3JDYWxsID0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBjYWxsYmFjay5hcHBseShyZWNlaXZlciwgYXJncyk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICI7CiAgICAgICAgfQoKICAgICAgICByZXQgKz0gIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICBkZWZhdWx0OiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkobGVuICsgMSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgdmFyIGkgPSAwOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgfSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgYXJnc1tpXSA9IGZuOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgW0NvZGVGb3JDYWxsXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAgICAgYnJlYWs7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcblwKICAgICAgICAiLnJlcGxhY2UoIltDb2RlRm9yQ2FsbF0iLCBjb2RlRm9yQ2FsbCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KCiAgICByZXR1cm4gbmV3IEZ1bmN0aW9uKCJQcm9taXNlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImNhbGxiYWNrIiwKICAgICAgICAgICAgICAgICAgICAgICAgInJlY2VpdmVyIiwKICAgICAgICAgICAgICAgICAgICAgICAgIndpdGhBcHBlbmRlZCIsCiAgICAgICAgICAgICAgICAgICAgICAgICJtYXliZVdyYXBBc0Vycm9yIiwKICAgICAgICAgICAgICAgICAgICAgICAgIm5vZGViYWNrRm9yUHJvbWlzZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJJTlRFUk5BTCIsIiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgdmFyIHJldCA9IGZ1bmN0aW9uIEZ1bmN0aW9uTmFtZShQYXJhbWV0ZXJzKSB7ICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICd1c2Ugc3RyaWN0JzsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoSU5URVJOQUwpOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHZhciBmbiA9IG5vZGViYWNrRm9yUHJvbWlzZShwcm9taXNlKTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHRyeSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBzd2l0Y2gobGVuKSB7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICAgICAgW0NvZGVGb3JTd2l0Y2hDYXNlXSAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB9ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICB2YXIgd3JhcHBlZCA9IG1heWJlV3JhcEFzRXJyb3IoZSk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHdyYXBwZWQpOyAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgICAgICBwcm9taXNlLl9yZWplY3Qod3JhcHBlZCk7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIH0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgICAgIHJldHVybiBwcm9taXNlOyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgfTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgcmV0Ll9faXNQcm9taXNpZmllZF9fID0gdHJ1ZTsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgcmV0dXJuIHJldDsgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5cCiAgICAgICAgIgogICAgICAgIC5yZXBsYWNlKCJGdW5jdGlvbk5hbWUiLCBjYWxsYmFja05hbWUpCiAgICAgICAgLnJlcGxhY2UoIlBhcmFtZXRlcnMiLCBwYXJhbWV0ZXJEZWNsYXJhdGlvbihuZXdQYXJhbWV0ZXJDb3VudCkpCiAgICAgICAgLnJlcGxhY2UoIltDb2RlRm9yU3dpdGNoQ2FzZV0iLCBnZW5lcmF0ZUFyZ3VtZW50U3dpdGNoQ2FzZSgpKSkoCiAgICAgICAgICAgIFByb21pc2UsCiAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICByZWNlaXZlciwKICAgICAgICAgICAgd2l0aEFwcGVuZGVkLAogICAgICAgICAgICBtYXliZVdyYXBBc0Vycm9yLAogICAgICAgICAgICBub2RlYmFja0ZvclByb21pc2UsCiAgICAgICAgICAgIElOVEVSTkFMCiAgICAgICAgKTsKfQoKZnVuY3Rpb24gbWFrZU5vZGVQcm9taXNpZmllZENsb3N1cmUoY2FsbGJhY2ssIHJlY2VpdmVyKSB7CiAgICBmdW5jdGlvbiBwcm9taXNpZmllZCgpIHsKICAgICAgICB2YXIgX3JlY2VpdmVyID0gcmVjZWl2ZXI7CiAgICAgICAgaWYgKHJlY2VpdmVyID09PSBUSElTKSBfcmVjZWl2ZXIgPSB0aGlzOwogICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIGNhbGxiYWNrID0gX3JlY2VpdmVyW2NhbGxiYWNrXTsKICAgICAgICB9CiAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICAgICAgcHJvbWlzZS5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICB2YXIgZm4gPSBub2RlYmFja0ZvclByb21pc2UocHJvbWlzZSk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbGJhY2suYXBwbHkoX3JlY2VpdmVyLCB3aXRoQXBwZW5kZWQoYXJndW1lbnRzLCBmbikpOwogICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICB2YXIgd3JhcHBlZCA9IG1heWJlV3JhcEFzRXJyb3IoZSk7CiAgICAgICAgICAgIHByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2Uod3JhcHBlZCk7CiAgICAgICAgICAgIHByb21pc2UuX3JlamVjdCh3cmFwcGVkKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb21pc2U7CiAgICB9CiAgICBwcm9taXNpZmllZC5fX2lzUHJvbWlzaWZpZWRfXyA9IHRydWU7CiAgICByZXR1cm4gcHJvbWlzaWZpZWQ7Cn0KCnZhciBtYWtlTm9kZVByb21pc2lmaWVkID0gY2FuRXZhbHVhdGUKICAgID8gbWFrZU5vZGVQcm9taXNpZmllZEV2YWwKICAgIDogbWFrZU5vZGVQcm9taXNpZmllZENsb3N1cmU7CgpmdW5jdGlvbiBwcm9taXNpZnlBbGwob2JqLCBzdWZmaXgsIGZpbHRlciwgcHJvbWlzaWZpZXIpIHsKICAgIHZhciBzdWZmaXhSZWdleHAgPSBuZXcgUmVnRXhwKGVzY2FwZUlkZW50UmVnZXgoc3VmZml4KSArICIkIik7CiAgICB2YXIgbWV0aG9kcyA9CiAgICAgICAgcHJvbWlzaWZpYWJsZU1ldGhvZHMob2JqLCBzdWZmaXgsIHN1ZmZpeFJlZ2V4cCwgZmlsdGVyKTsKCiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsZW47IGkrPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IG1ldGhvZHNbaV07CiAgICAgICAgdmFyIGZuID0gbWV0aG9kc1tpKzFdOwogICAgICAgIHZhciBwcm9taXNpZmllZEtleSA9IGtleSArIHN1ZmZpeDsKICAgICAgICBvYmpbcHJvbWlzaWZpZWRLZXldID0gcHJvbWlzaWZpZXIgPT09IG1ha2VOb2RlUHJvbWlzaWZpZWQKICAgICAgICAgICAgICAgID8gbWFrZU5vZGVQcm9taXNpZmllZChrZXksIFRISVMsIGtleSwgZm4sIHN1ZmZpeCkKICAgICAgICAgICAgICAgIDogcHJvbWlzaWZpZXIoZm4pOwogICAgfQogICAgdXRpbC50b0Zhc3RQcm9wZXJ0aWVzKG9iaik7CiAgICByZXR1cm4gb2JqOwp9CgpmdW5jdGlvbiBwcm9taXNpZnkoY2FsbGJhY2ssIHJlY2VpdmVyKSB7CiAgICByZXR1cm4gbWFrZU5vZGVQcm9taXNpZmllZChjYWxsYmFjaywgcmVjZWl2ZXIsIHZvaWQgMCwgY2FsbGJhY2spOwp9CgpQcm9taXNlLnByb21pc2lmeSA9IGZ1bmN0aW9uIFByb21pc2UkUHJvbWlzaWZ5KGZuLCByZWNlaXZlcikgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoImZuIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgfQogICAgaWYgKGlzUHJvbWlzaWZpZWQoZm4pKSB7CiAgICAgICAgcmV0dXJuIGZuOwogICAgfQogICAgcmV0dXJuIHByb21pc2lmeShmbiwgYXJndW1lbnRzLmxlbmd0aCA8IDIgPyBUSElTIDogcmVjZWl2ZXIpOwp9OwoKUHJvbWlzZS5wcm9taXNpZnlBbGwgPSBmdW5jdGlvbiBQcm9taXNlJFByb21pc2lmeUFsbCh0YXJnZXQsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB0YXJnZXQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigidGhlIHRhcmdldCBvZiBwcm9taXNpZnlBbGwgbXVzdCBiZSBhbiBvYmplY3Qgb3IgYSBmdW5jdGlvbiIpOwogICAgfQogICAgb3B0aW9ucyA9IE9iamVjdChvcHRpb25zKTsKICAgIHZhciBzdWZmaXggPSBvcHRpb25zLnN1ZmZpeDsKICAgIGlmICh0eXBlb2Ygc3VmZml4ICE9PSAic3RyaW5nIikgc3VmZml4ID0gZGVmYXVsdFN1ZmZpeDsKICAgIHZhciBmaWx0ZXIgPSBvcHRpb25zLmZpbHRlcjsKICAgIGlmICh0eXBlb2YgZmlsdGVyICE9PSAiZnVuY3Rpb24iKSBmaWx0ZXIgPSBkZWZhdWx0RmlsdGVyOwogICAgdmFyIHByb21pc2lmaWVyID0gb3B0aW9ucy5wcm9taXNpZmllcjsKICAgIGlmICh0eXBlb2YgcHJvbWlzaWZpZXIgIT09ICJmdW5jdGlvbiIpIHByb21pc2lmaWVyID0gbWFrZU5vZGVQcm9taXNpZmllZDsKCiAgICBpZiAoIXV0aWwuaXNJZGVudGlmaWVyKHN1ZmZpeCkpIHsKICAgICAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcigic3VmZml4IG11c3QgYmUgYSB2YWxpZCBpZGVudGlmaWVyIik7CiAgICB9CgogICAgdmFyIGtleXMgPSB1dGlsLmluaGVyaXRlZERhdGFLZXlzKHRhcmdldCwge2luY2x1ZGVIaWRkZW46IHRydWV9KTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7ICsraSkgewogICAgICAgIHZhciB2YWx1ZSA9IHRhcmdldFtrZXlzW2ldXTsKICAgICAgICBpZiAoa2V5c1tpXSAhPT0gImNvbnN0cnVjdG9yIiAmJgogICAgICAgICAgICB1dGlsLmlzQ2xhc3ModmFsdWUpKSB7CiAgICAgICAgICAgIHByb21pc2lmeUFsbCh2YWx1ZS5wcm90b3R5cGUsIHN1ZmZpeCwgZmlsdGVyLCBwcm9taXNpZmllcik7CiAgICAgICAgICAgIHByb21pc2lmeUFsbCh2YWx1ZSwgc3VmZml4LCBmaWx0ZXIsIHByb21pc2lmaWVyKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHByb21pc2lmeUFsbCh0YXJnZXQsIHN1ZmZpeCwgZmlsdGVyLCBwcm9taXNpZmllcik7Cn07Cn07CgoKfSx7Ii4vZXJyb3JzIjoyNSwiLi9wcm9taXNlX3Jlc29sdmVyLmpzIjozNywiLi91dGlsLmpzIjo1MH1dLDM5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgUHJvbWlzZUFycmF5LCBjYXN0KSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBhcGlSZWplY3Rpb24gPSByZXF1aXJlKCIuL2Vycm9yc19hcGlfcmVqZWN0aW9uIikoUHJvbWlzZSk7CnZhciBpc09iamVjdCA9IHV0aWwuaXNPYmplY3Q7CnZhciBlczUgPSByZXF1aXJlKCIuL2VzNS5qcyIpOwoKZnVuY3Rpb24gUHJvcGVydGllc1Byb21pc2VBcnJheShvYmopIHsKICAgIHZhciBrZXlzID0gZXM1LmtleXMob2JqKTsKICAgIHZhciBsZW4gPSBrZXlzLmxlbmd0aDsKICAgIHZhciB2YWx1ZXMgPSBuZXcgQXJyYXkobGVuICogMik7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgdmFsdWVzW2ldID0gb2JqW2tleV07CiAgICAgICAgdmFsdWVzW2kgKyBsZW5dID0ga2V5OwogICAgfQogICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTsKfQp1dGlsLmluaGVyaXRzKFByb3BlcnRpZXNQcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5faW5pdCA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX2luaXQoKSB7CiAgICB0aGlzLl9pbml0JCh2b2lkIDAsIC0zKSA7Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZUZ1bGZpbGxlZCA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX3Byb21pc2VGdWxmaWxsZWQodmFsdWUsIGluZGV4KSB7CiAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSByZXR1cm47CiAgICB0aGlzLl92YWx1ZXNbaW5kZXhdID0gdmFsdWU7CiAgICB2YXIgdG90YWxSZXNvbHZlZCA9ICsrdGhpcy5fdG90YWxSZXNvbHZlZDsKICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkgewogICAgICAgIHZhciB2YWwgPSB7fTsKICAgICAgICB2YXIga2V5T2Zmc2V0ID0gdGhpcy5sZW5ndGgoKTsKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5sZW5ndGgoKTsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgIHZhbFt0aGlzLl92YWx1ZXNbaSArIGtleU9mZnNldF1dID0gdGhpcy5fdmFsdWVzW2ldOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZXNvbHZlKHZhbCk7CiAgICB9Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVByb2dyZXNzZWQgPQpmdW5jdGlvbiBQcm9wZXJ0aWVzUHJvbWlzZUFycmF5JF9wcm9taXNlUHJvZ3Jlc3NlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKCiAgICB0aGlzLl9wcm9taXNlLl9wcm9ncmVzcyh7CiAgICAgICAga2V5OiB0aGlzLl92YWx1ZXNbaW5kZXggKyB0aGlzLmxlbmd0aCgpXSwKICAgICAgICB2YWx1ZTogdmFsdWUKICAgIH0pOwp9OwoKUHJvcGVydGllc1Byb21pc2VBcnJheS5wcm90b3R5cGUuc2hvdWxkQ29weVZhbHVlcyA9CmZ1bmN0aW9uIFByb3BlcnRpZXNQcm9taXNlQXJyYXkkX3Nob3VsZENvcHlWYWx1ZXMoKSB7CiAgICByZXR1cm4gZmFsc2U7Cn07CgpQcm9wZXJ0aWVzUHJvbWlzZUFycmF5LnByb3RvdHlwZS5nZXRBY3R1YWxMZW5ndGggPQpmdW5jdGlvbiBQcm9wZXJ0aWVzUHJvbWlzZUFycmF5JGdldEFjdHVhbExlbmd0aChsZW4pIHsKICAgIHJldHVybiBsZW4gPj4gMTsKfTsKCmZ1bmN0aW9uIFByb21pc2UkX1Byb3BzKHByb21pc2VzKSB7CiAgICB2YXIgcmV0OwogICAgdmFyIGNhc3RWYWx1ZSA9IGNhc3QocHJvbWlzZXMsIHZvaWQgMCk7CgogICAgaWYgKCFpc09iamVjdChjYXN0VmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIGFwaVJlamVjdGlvbigiY2Fubm90IGF3YWl0IHByb3BlcnRpZXMgb2YgYSBub24tb2JqZWN0Iik7CiAgICB9IGVsc2UgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXQgPSBjYXN0VmFsdWUuX3RoZW4oUHJvbWlzZS5wcm9wcywgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgdm9pZCAwKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0ID0gbmV3IFByb3BlcnRpZXNQcm9taXNlQXJyYXkoY2FzdFZhbHVlKS5wcm9taXNlKCk7CiAgICB9CgogICAgaWYgKGNhc3RWYWx1ZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXQuX3Byb3BhZ2F0ZUZyb20oY2FzdFZhbHVlLCA0KTsKICAgIH0KICAgIHJldHVybiByZXQ7Cn0KClByb21pc2UucHJvdG90eXBlLnByb3BzID0gZnVuY3Rpb24gUHJvbWlzZSRwcm9wcygpIHsKICAgIHJldHVybiBQcm9taXNlJF9Qcm9wcyh0aGlzKTsKfTsKClByb21pc2UucHJvcHMgPSBmdW5jdGlvbiBQcm9taXNlJFByb3BzKHByb21pc2VzKSB7CiAgICByZXR1cm4gUHJvbWlzZSRfUHJvcHMocHJvbWlzZXMpOwp9Owp9OwoKfSx7Ii4vZXJyb3JzX2FwaV9yZWplY3Rpb24iOjI2LCIuL2VzNS5qcyI6MjcsIi4vdXRpbC5qcyI6NTB9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwpmdW5jdGlvbiBhcnJheUNvcHkoc3JjLCBzcmNJbmRleCwgZHN0LCBkc3RJbmRleCwgbGVuKSB7CiAgICBmb3IgKHZhciBqID0gMDsgaiA8IGxlbjsgKytqKSB7CiAgICAgICAgZHN0W2ogKyBkc3RJbmRleF0gPSBzcmNbaiArIHNyY0luZGV4XTsKICAgIH0KfQoKZnVuY3Rpb24gUXVldWUoY2FwYWNpdHkpIHsKICAgIHRoaXMuX2NhcGFjaXR5ID0gY2FwYWNpdHk7CiAgICB0aGlzLl9sZW5ndGggPSAwOwogICAgdGhpcy5fZnJvbnQgPSAwOwogICAgdGhpcy5fbWFrZUNhcGFjaXR5KCk7Cn0KClF1ZXVlLnByb3RvdHlwZS5fd2lsbEJlT3ZlckNhcGFjaXR5ID0KZnVuY3Rpb24gUXVldWUkX3dpbGxCZU92ZXJDYXBhY2l0eShzaXplKSB7CiAgICByZXR1cm4gdGhpcy5fY2FwYWNpdHkgPCBzaXplOwp9OwoKUXVldWUucHJvdG90eXBlLl9wdXNoT25lID0gZnVuY3Rpb24gUXVldWUkX3B1c2hPbmUoYXJnKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKTsKICAgIHRoaXMuX2NoZWNrQ2FwYWNpdHkobGVuZ3RoICsgMSk7CiAgICB2YXIgaSA9ICh0aGlzLl9mcm9udCArIGxlbmd0aCkgJiAodGhpcy5fY2FwYWNpdHkgLSAxKTsKICAgIHRoaXNbaV0gPSBhcmc7CiAgICB0aGlzLl9sZW5ndGggPSBsZW5ndGggKyAxOwp9OwoKUXVldWUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbiBRdWV1ZSRwdXNoKGZuLCByZWNlaXZlciwgYXJnKSB7CiAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGgoKSArIDM7CiAgICBpZiAodGhpcy5fd2lsbEJlT3ZlckNhcGFjaXR5KGxlbmd0aCkpIHsKICAgICAgICB0aGlzLl9wdXNoT25lKGZuKTsKICAgICAgICB0aGlzLl9wdXNoT25lKHJlY2VpdmVyKTsKICAgICAgICB0aGlzLl9wdXNoT25lKGFyZyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGogPSB0aGlzLl9mcm9udCArIGxlbmd0aCAtIDM7CiAgICB0aGlzLl9jaGVja0NhcGFjaXR5KGxlbmd0aCk7CiAgICB2YXIgd3JhcE1hc2sgPSB0aGlzLl9jYXBhY2l0eSAtIDE7CiAgICB0aGlzWyhqICsgMCkgJiB3cmFwTWFza10gPSBmbjsKICAgIHRoaXNbKGogKyAxKSAmIHdyYXBNYXNrXSA9IHJlY2VpdmVyOwogICAgdGhpc1soaiArIDIpICYgd3JhcE1hc2tdID0gYXJnOwogICAgdGhpcy5fbGVuZ3RoID0gbGVuZ3RoOwp9OwoKUXVldWUucHJvdG90eXBlLnNoaWZ0ID0gZnVuY3Rpb24gUXVldWUkc2hpZnQoKSB7CiAgICB2YXIgZnJvbnQgPSB0aGlzLl9mcm9udCwKICAgICAgICByZXQgPSB0aGlzW2Zyb250XTsKCiAgICB0aGlzW2Zyb250XSA9IHZvaWQgMDsKICAgIHRoaXMuX2Zyb250ID0gKGZyb250ICsgMSkgJiAodGhpcy5fY2FwYWNpdHkgLSAxKTsKICAgIHRoaXMuX2xlbmd0aC0tOwogICAgcmV0dXJuIHJldDsKfTsKClF1ZXVlLnByb3RvdHlwZS5sZW5ndGggPSBmdW5jdGlvbiBRdWV1ZSRsZW5ndGgoKSB7CiAgICByZXR1cm4gdGhpcy5fbGVuZ3RoOwp9OwoKUXVldWUucHJvdG90eXBlLl9tYWtlQ2FwYWNpdHkgPSBmdW5jdGlvbiBRdWV1ZSRfbWFrZUNhcGFjaXR5KCkgewogICAgdmFyIGxlbiA9IHRoaXMuX2NhcGFjaXR5OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHRoaXNbaV0gPSB2b2lkIDA7CiAgICB9Cn07CgpRdWV1ZS5wcm90b3R5cGUuX2NoZWNrQ2FwYWNpdHkgPSBmdW5jdGlvbiBRdWV1ZSRfY2hlY2tDYXBhY2l0eShzaXplKSB7CiAgICBpZiAodGhpcy5fY2FwYWNpdHkgPCBzaXplKSB7CiAgICAgICAgdGhpcy5fcmVzaXplVG8odGhpcy5fY2FwYWNpdHkgPDwgMyk7CiAgICB9Cn07CgpRdWV1ZS5wcm90b3R5cGUuX3Jlc2l6ZVRvID0gZnVuY3Rpb24gUXVldWUkX3Jlc2l6ZVRvKGNhcGFjaXR5KSB7CiAgICB2YXIgb2xkRnJvbnQgPSB0aGlzLl9mcm9udDsKICAgIHZhciBvbGRDYXBhY2l0eSA9IHRoaXMuX2NhcGFjaXR5OwogICAgdmFyIG9sZFF1ZXVlID0gbmV3IEFycmF5KG9sZENhcGFjaXR5KTsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwoKICAgIGFycmF5Q29weSh0aGlzLCAwLCBvbGRRdWV1ZSwgMCwgb2xkQ2FwYWNpdHkpOwogICAgdGhpcy5fY2FwYWNpdHkgPSBjYXBhY2l0eTsKICAgIHRoaXMuX21ha2VDYXBhY2l0eSgpOwogICAgdGhpcy5fZnJvbnQgPSAwOwogICAgaWYgKG9sZEZyb250ICsgbGVuZ3RoIDw9IG9sZENhcGFjaXR5KSB7CiAgICAgICAgYXJyYXlDb3B5KG9sZFF1ZXVlLCBvbGRGcm9udCwgdGhpcywgMCwgbGVuZ3RoKTsKICAgIH0gZWxzZSB7ICAgICAgICB2YXIgbGVuZ3RoQmVmb3JlV3JhcHBpbmcgPQogICAgICAgICAgICBsZW5ndGggLSAoKG9sZEZyb250ICsgbGVuZ3RoKSAmIChvbGRDYXBhY2l0eSAtIDEpKTsKCiAgICAgICAgYXJyYXlDb3B5KG9sZFF1ZXVlLCBvbGRGcm9udCwgdGhpcywgMCwgbGVuZ3RoQmVmb3JlV3JhcHBpbmcpOwogICAgICAgIGFycmF5Q29weShvbGRRdWV1ZSwgMCwgdGhpcywgbGVuZ3RoQmVmb3JlV3JhcHBpbmcsCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoIC0gbGVuZ3RoQmVmb3JlV3JhcHBpbmcpOwogICAgfQp9OwoKbW9kdWxlLmV4cG9ydHMgPSBRdWV1ZTsKCn0se31dLDQxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwsIGNhc3QpIHsKdmFyIGFwaVJlamVjdGlvbiA9IHJlcXVpcmUoIi4vZXJyb3JzX2FwaV9yZWplY3Rpb24uanMiKShQcm9taXNlKTsKdmFyIGlzQXJyYXkgPSByZXF1aXJlKCIuL3V0aWwuanMiKS5pc0FycmF5OwoKdmFyIHJhY2VMYXRlciA9IGZ1bmN0aW9uIFByb21pc2UkX3JhY2VMYXRlcihwcm9taXNlKSB7CiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGFycmF5KSB7CiAgICAgICAgcmV0dXJuIFByb21pc2UkX1JhY2UoYXJyYXksIHByb21pc2UpOwogICAgfSk7Cn07Cgp2YXIgaGFzT3duID0ge30uaGFzT3duUHJvcGVydHk7CmZ1bmN0aW9uIFByb21pc2UkX1JhY2UocHJvbWlzZXMsIHBhcmVudCkgewogICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocHJvbWlzZXMsIHZvaWQgMCk7CgogICAgaWYgKG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UpIHsKICAgICAgICByZXR1cm4gcmFjZUxhdGVyKG1heWJlUHJvbWlzZSk7CiAgICB9IGVsc2UgaWYgKCFpc0FycmF5KHByb21pc2VzKSkgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImV4cGVjdGluZyBhbiBhcnJheSwgYSBwcm9taXNlIG9yIGEgdGhlbmFibGUiKTsKICAgIH0KCiAgICB2YXIgcmV0ID0gbmV3IFByb21pc2UoSU5URVJOQUwpOwogICAgaWYgKHBhcmVudCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0Ll9wcm9wYWdhdGVGcm9tKHBhcmVudCwgNyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgIH0KICAgIHZhciBmdWxmaWxsID0gcmV0Ll9mdWxmaWxsOwogICAgdmFyIHJlamVjdCA9IHJldC5fcmVqZWN0OwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHByb21pc2VzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIHZhbCA9IHByb21pc2VzW2ldOwoKICAgICAgICBpZiAodmFsID09PSB2b2lkIDAgJiYgIShoYXNPd24uY2FsbChwcm9taXNlcywgaSkpKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgUHJvbWlzZS5jYXN0KHZhbCkuX3RoZW4oZnVsZmlsbCwgcmVqZWN0LCB2b2lkIDAsIHJldCwgbnVsbCk7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9CgpQcm9taXNlLnJhY2UgPSBmdW5jdGlvbiBQcm9taXNlJFJhY2UocHJvbWlzZXMpIHsKICAgIHJldHVybiBQcm9taXNlJF9SYWNlKHByb21pc2VzLCB2b2lkIDApOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUucmFjZSA9IGZ1bmN0aW9uIFByb21pc2UkcmFjZSgpIHsKICAgIHJldHVybiBQcm9taXNlJF9SYWNlKHRoaXMsIHZvaWQgMCk7Cn07Cgp9OwoKfSx7Ii4vZXJyb3JzX2FwaV9yZWplY3Rpb24uanMiOjI2LCIuL3V0aWwuanMiOjUwfV0sNDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihQcm9taXNlLCBQcm9taXNlQXJyYXksIGFwaVJlamVjdGlvbiwgY2FzdCwgSU5URVJOQUwpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIHRyeUNhdGNoNCA9IHV0aWwudHJ5Q2F0Y2g0Owp2YXIgdHJ5Q2F0Y2gzID0gdXRpbC50cnlDYXRjaDM7CnZhciBlcnJvck9iaiA9IHV0aWwuZXJyb3JPYmo7CmZ1bmN0aW9uIFJlZHVjdGlvblByb21pc2VBcnJheShwcm9taXNlcywgZm4sIGFjY3VtLCBfZWFjaCkgewogICAgdGhpcy5jb25zdHJ1Y3RvciQocHJvbWlzZXMpOwogICAgdGhpcy5fcHJlc2VydmVkVmFsdWVzID0gX2VhY2ggPT09IElOVEVSTkFMID8gW10gOiBudWxsOwogICAgdGhpcy5femVyb3RoSXNBY2N1bSA9IChhY2N1bSA9PT0gdm9pZCAwKTsKICAgIHRoaXMuX2dvdEFjY3VtID0gZmFsc2U7CiAgICB0aGlzLl9yZWR1Y2luZ0luZGV4ID0gKHRoaXMuX3plcm90aElzQWNjdW0gPyAxIDogMCk7CiAgICB0aGlzLl92YWx1ZXNQaGFzZSA9IHVuZGVmaW5lZDsKCiAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdChhY2N1bSwgdm9pZCAwKTsKICAgIHZhciByZWplY3RlZCA9IGZhbHNlOwogICAgdmFyIGlzUHJvbWlzZSA9IG1heWJlUHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2U7CiAgICBpZiAoaXNQcm9taXNlKSB7CiAgICAgICAgaWYgKG1heWJlUHJvbWlzZS5pc1BlbmRpbmcoKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIC0xKTsKICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgIGFjY3VtID0gbWF5YmVQcm9taXNlLnZhbHVlKCk7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3Vuc2V0UmVqZWN0aW9uSXNVbmhhbmRsZWQoKTsKICAgICAgICAgICAgdGhpcy5fcmVqZWN0KG1heWJlUHJvbWlzZS5yZWFzb24oKSk7CiAgICAgICAgICAgIHJlamVjdGVkID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoIShpc1Byb21pc2UgfHwgdGhpcy5femVyb3RoSXNBY2N1bSkpIHRoaXMuX2dvdEFjY3VtID0gdHJ1ZTsKICAgIHRoaXMuX2NhbGxiYWNrID0gZm47CiAgICB0aGlzLl9hY2N1bSA9IGFjY3VtOwogICAgaWYgKCFyZWplY3RlZCkgdGhpcy5faW5pdCQodm9pZCAwLCAtNSk7Cn0KdXRpbC5pbmhlcml0cyhSZWR1Y3Rpb25Qcm9taXNlQXJyYXksIFByb21pc2VBcnJheSk7CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0KZnVuY3Rpb24gUmVkdWN0aW9uUHJvbWlzZUFycmF5JF9pbml0KCkge307CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9yZXNvbHZlRW1wdHlBcnJheSA9CmZ1bmN0aW9uIFJlZHVjdGlvblByb21pc2VBcnJheSRfcmVzb2x2ZUVtcHR5QXJyYXkoKSB7CiAgICBpZiAodGhpcy5fZ290QWNjdW0gfHwgdGhpcy5femVyb3RoSXNBY2N1bSkgewogICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fcHJlc2VydmVkVmFsdWVzICE9PSBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgID8gW10gOiB0aGlzLl9hY2N1bSk7CiAgICB9Cn07CgpSZWR1Y3Rpb25Qcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gUmVkdWN0aW9uUHJvbWlzZUFycmF5JF9wcm9taXNlRnVsZmlsbGVkKHZhbHVlLCBpbmRleCkgewogICAgdmFyIHZhbHVlcyA9IHRoaXMuX3ZhbHVlczsKICAgIGlmICh2YWx1ZXMgPT09IG51bGwpIHJldHVybjsKICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aCgpOwogICAgdmFyIHByZXNlcnZlZFZhbHVlcyA9IHRoaXMuX3ByZXNlcnZlZFZhbHVlczsKICAgIHZhciBpc0VhY2ggPSBwcmVzZXJ2ZWRWYWx1ZXMgIT09IG51bGw7CiAgICB2YXIgZ290QWNjdW0gPSB0aGlzLl9nb3RBY2N1bTsKICAgIHZhciB2YWx1ZXNQaGFzZSA9IHRoaXMuX3ZhbHVlc1BoYXNlOwogICAgdmFyIHZhbHVlc1BoYXNlSW5kZXg7CiAgICBpZiAoIXZhbHVlc1BoYXNlKSB7CiAgICAgICAgdmFsdWVzUGhhc2UgPSB0aGlzLl92YWx1ZXNQaGFzZSA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgZm9yICh2YWx1ZXNQaGFzZUluZGV4PTA7IHZhbHVlc1BoYXNlSW5kZXg8bGVuZ3RoOyArK3ZhbHVlc1BoYXNlSW5kZXgpIHsKICAgICAgICAgICAgdmFsdWVzUGhhc2VbdmFsdWVzUGhhc2VJbmRleF0gPSAwOwogICAgICAgIH0KICAgIH0KICAgIHZhbHVlc1BoYXNlSW5kZXggPSB2YWx1ZXNQaGFzZVtpbmRleF07CgogICAgaWYgKGluZGV4ID09PSAwICYmIHRoaXMuX3plcm90aElzQWNjdW0pIHsKICAgICAgICBpZiAoIWdvdEFjY3VtKSB7CiAgICAgICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gZ290QWNjdW0gPSB0cnVlOwogICAgICAgIH0KICAgICAgICB2YWx1ZXNQaGFzZVtpbmRleF0gPSAoKHZhbHVlc1BoYXNlSW5kZXggPT09IDApCiAgICAgICAgICAgID8gMSA6IDIpOwogICAgfSBlbHNlIGlmIChpbmRleCA9PT0gLTEpIHsKICAgICAgICBpZiAoIWdvdEFjY3VtKSB7CiAgICAgICAgICAgIHRoaXMuX2FjY3VtID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuX2dvdEFjY3VtID0gZ290QWNjdW0gPSB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggPT09IDApIHsKICAgICAgICAgICAgdmFsdWVzUGhhc2VbaW5kZXhdID0gMTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhbHVlc1BoYXNlW2luZGV4XSA9IDI7CiAgICAgICAgICAgIGlmIChnb3RBY2N1bSkgewogICAgICAgICAgICAgICAgdGhpcy5fYWNjdW0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmICghZ290QWNjdW0pIHJldHVybjsKCiAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLl9jYWxsYmFjazsKICAgIHZhciByZWNlaXZlciA9IHRoaXMuX3Byb21pc2UuX2JvdW5kVG87CiAgICB2YXIgcmV0OwoKICAgIGZvciAodmFyIGkgPSB0aGlzLl9yZWR1Y2luZ0luZGV4OyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICB2YWx1ZXNQaGFzZUluZGV4ID0gdmFsdWVzUGhhc2VbaV07CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggPT09IDIpIHsKICAgICAgICAgICAgdGhpcy5fcmVkdWNpbmdJbmRleCA9IGkgKyAxOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlc1BoYXNlSW5kZXggIT09IDEpIHJldHVybjsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZXNbaV07CiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICBpZiAodmFsdWUuaXNGdWxmaWxsZWQoKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5fc2V0dGxlZFZhbHVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmlzUGVuZGluZygpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWx1ZS5fdW5zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdCh2YWx1ZS5yZWFzb24oKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChpc0VhY2gpIHsKICAgICAgICAgICAgcHJlc2VydmVkVmFsdWVzLnB1c2godmFsdWUpOwogICAgICAgICAgICByZXQgPSB0cnlDYXRjaDMoY2FsbGJhY2ssIHJlY2VpdmVyLCB2YWx1ZSwgaSwgbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldCA9IHRyeUNhdGNoNChjYWxsYmFjaywgcmVjZWl2ZXIsIHRoaXMuX2FjY3VtLCB2YWx1ZSwgaSwgbGVuZ3RoKTsKICAgICAgICB9CgogICAgICAgIGlmIChyZXQgPT09IGVycm9yT2JqKSByZXR1cm4gdGhpcy5fcmVqZWN0KHJldC5lKTsKCiAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QocmV0LCB2b2lkIDApOwogICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UuaXNQZW5kaW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhbHVlc1BoYXNlW2ldID0gNDsKICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVByb21pc2UuX3Byb3h5UHJvbWlzZUFycmF5KHRoaXMsIGkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1heWJlUHJvbWlzZS5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgICAgICAgICByZXQgPSBtYXliZVByb21pc2UudmFsdWUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZS5fdW5zZXRSZWplY3Rpb25Jc1VuaGFuZGxlZCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdChtYXliZVByb21pc2UucmVhc29uKCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZWR1Y2luZ0luZGV4ID0gaSArIDE7CiAgICAgICAgdGhpcy5fYWNjdW0gPSByZXQ7CiAgICB9CgogICAgaWYgKHRoaXMuX3JlZHVjaW5nSW5kZXggPCBsZW5ndGgpIHJldHVybjsKICAgIHRoaXMuX3Jlc29sdmUoaXNFYWNoID8gcHJlc2VydmVkVmFsdWVzIDogdGhpcy5fYWNjdW0pOwp9OwoKZnVuY3Rpb24gcmVkdWNlKHByb21pc2VzLCBmbiwgaW5pdGlhbFZhbHVlLCBfZWFjaCkgewogICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICB2YXIgYXJyYXkgPSBuZXcgUmVkdWN0aW9uUHJvbWlzZUFycmF5KHByb21pc2VzLCBmbiwgaW5pdGlhbFZhbHVlLCBfZWFjaCk7CiAgICByZXR1cm4gYXJyYXkucHJvbWlzZSgpOwp9CgpQcm9taXNlLnByb3RvdHlwZS5yZWR1Y2UgPSBmdW5jdGlvbiBQcm9taXNlJHJlZHVjZShmbiwgaW5pdGlhbFZhbHVlKSB7CiAgICByZXR1cm4gcmVkdWNlKHRoaXMsIGZuLCBpbml0aWFsVmFsdWUsIG51bGwpOwp9OwoKUHJvbWlzZS5yZWR1Y2UgPSBmdW5jdGlvbiBQcm9taXNlJFJlZHVjZShwcm9taXNlcywgZm4sIGluaXRpYWxWYWx1ZSwgX2VhY2gpIHsKICAgIHJldHVybiByZWR1Y2UocHJvbWlzZXMsIGZuLCBpbml0aWFsVmFsdWUsIF9lYWNoKTsKfTsKfTsKCn0seyIuL3V0aWwuanMiOjUwfV0sNDM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIHNjaGVkdWxlOwp2YXIgX011dGF0aW9uT2JzZXJ2ZXI7CmlmICh0eXBlb2YgcHJvY2VzcyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb2Nlc3MudmVyc2lvbiA9PT0gInN0cmluZyIpIHsKICAgIHNjaGVkdWxlID0gZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKGZuKSB7CiAgICAgICAgcHJvY2Vzcy5uZXh0VGljayhmbik7CiAgICB9Owp9CmVsc2UgaWYgKCh0eXBlb2YgTXV0YXRpb25PYnNlcnZlciAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgKF9NdXRhdGlvbk9ic2VydmVyID0gTXV0YXRpb25PYnNlcnZlcikpIHx8CiAgICAgICAgICh0eXBlb2YgV2ViS2l0TXV0YXRpb25PYnNlcnZlciAhPT0gInVuZGVmaW5lZCIgJiYKICAgICAgICAgKF9NdXRhdGlvbk9ic2VydmVyID0gV2ViS2l0TXV0YXRpb25PYnNlcnZlcikpKSB7CiAgICBzY2hlZHVsZSA9IChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgdmFyIHF1ZXVlZEZuID0gdm9pZCAwOwogICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBfTXV0YXRpb25PYnNlcnZlcigKICAgICAgICAgICAgZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKCkgewogICAgICAgICAgICAgICAgdmFyIGZuID0gcXVldWVkRm47CiAgICAgICAgICAgICAgICBxdWV1ZWRGbiA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICk7CiAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShkaXYsIHsKICAgICAgICAgICAgYXR0cmlidXRlczogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBQcm9taXNlJF9TY2hlZHVsZXIoZm4pIHsKICAgICAgICAgICAgcXVldWVkRm4gPSBmbjsKICAgICAgICAgICAgZGl2LmNsYXNzTGlzdC50b2dnbGUoImZvbyIpOwogICAgICAgIH07CgogICAgfSkoKTsKfQplbHNlIGlmICh0eXBlb2Ygc2V0VGltZW91dCAhPT0gInVuZGVmaW5lZCIpIHsKICAgIHNjaGVkdWxlID0gZnVuY3Rpb24gUHJvbWlzZSRfU2NoZWR1bGVyKGZuKSB7CiAgICAgICAgc2V0VGltZW91dChmbiwgMCk7CiAgICB9Owp9CmVsc2UgdGhyb3cgbmV3IEVycm9yKCJubyBhc3luYyBzY2hlZHVsZXIgYXZhaWxhYmxlIik7Cm1vZHVsZS5leHBvcnRzID0gc2NoZWR1bGU7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Il9wcm9jZXNzIjo2MH1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0KICAgIGZ1bmN0aW9uKFByb21pc2UsIFByb21pc2VBcnJheSkgewp2YXIgUHJvbWlzZUluc3BlY3Rpb24gPSBQcm9taXNlLlByb21pc2VJbnNwZWN0aW9uOwp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpOwoKZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSh2YWx1ZXMpIHsKICAgIHRoaXMuY29uc3RydWN0b3IkKHZhbHVlcyk7Cn0KdXRpbC5pbmhlcml0cyhTZXR0bGVkUHJvbWlzZUFycmF5LCBQcm9taXNlQXJyYXkpOwoKU2V0dGxlZFByb21pc2VBcnJheS5wcm90b3R5cGUuX3Byb21pc2VSZXNvbHZlZCA9CmZ1bmN0aW9uIFNldHRsZWRQcm9taXNlQXJyYXkkX3Byb21pc2VSZXNvbHZlZChpbmRleCwgaW5zcGVjdGlvbikgewogICAgdGhpcy5fdmFsdWVzW2luZGV4XSA9IGluc3BlY3Rpb247CiAgICB2YXIgdG90YWxSZXNvbHZlZCA9ICsrdGhpcy5fdG90YWxSZXNvbHZlZDsKICAgIGlmICh0b3RhbFJlc29sdmVkID49IHRoaXMuX2xlbmd0aCkgewogICAgICAgIHRoaXMuX3Jlc29sdmUodGhpcy5fdmFsdWVzKTsKICAgIH0KfTsKClNldHRsZWRQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZUluc3BlY3Rpb24oKTsKICAgIHJldC5fYml0RmllbGQgPSAyNjg0MzU0NTY7CiAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHZhbHVlOwogICAgdGhpcy5fcHJvbWlzZVJlc29sdmVkKGluZGV4LCByZXQpOwp9OwpTZXR0bGVkUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcHJvbWlzZVJlamVjdGVkID0KZnVuY3Rpb24gU2V0dGxlZFByb21pc2VBcnJheSRfcHJvbWlzZVJlamVjdGVkKHJlYXNvbiwgaW5kZXgpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZUluc3BlY3Rpb24oKTsKICAgIHJldC5fYml0RmllbGQgPSAxMzQyMTc3Mjg7CiAgICByZXQuX3NldHRsZWRWYWx1ZSA9IHJlYXNvbjsKICAgIHRoaXMuX3Byb21pc2VSZXNvbHZlZChpbmRleCwgcmV0KTsKfTsKClByb21pc2Uuc2V0dGxlID0gZnVuY3Rpb24gUHJvbWlzZSRTZXR0bGUocHJvbWlzZXMpIHsKICAgIHJldHVybiBuZXcgU2V0dGxlZFByb21pc2VBcnJheShwcm9taXNlcykucHJvbWlzZSgpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuc2V0dGxlID0gZnVuY3Rpb24gUHJvbWlzZSRzZXR0bGUoKSB7CiAgICByZXR1cm4gbmV3IFNldHRsZWRQcm9taXNlQXJyYXkodGhpcykucHJvbWlzZSgpOwp9Owp9OwoKfSx7Ii4vdXRpbC5qcyI6NTB9XSw0NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9CmZ1bmN0aW9uKFByb21pc2UsIFByb21pc2VBcnJheSwgYXBpUmVqZWN0aW9uKSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBSYW5nZUVycm9yID0gcmVxdWlyZSgiLi9lcnJvcnMuanMiKS5SYW5nZUVycm9yOwp2YXIgQWdncmVnYXRlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLkFnZ3JlZ2F0ZUVycm9yOwp2YXIgaXNBcnJheSA9IHV0aWwuaXNBcnJheTsKCgpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5KHZhbHVlcykgewogICAgdGhpcy5jb25zdHJ1Y3RvciQodmFsdWVzKTsKICAgIHRoaXMuX2hvd01hbnkgPSAwOwogICAgdGhpcy5fdW53cmFwID0gZmFsc2U7CiAgICB0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlOwp9CnV0aWwuaW5oZXJpdHMoU29tZVByb21pc2VBcnJheSwgUHJvbWlzZUFycmF5KTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9pbml0ID0gZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfaW5pdCgpIHsKICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpIHsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5faG93TWFueSA9PT0gMCkgewogICAgICAgIHRoaXMuX3Jlc29sdmUoW10pOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2luaXQkKHZvaWQgMCwgLTUpOwogICAgdmFyIGlzQXJyYXlSZXNvbHZlZCA9IGlzQXJyYXkodGhpcy5fdmFsdWVzKTsKICAgIGlmICghdGhpcy5faXNSZXNvbHZlZCgpICYmCiAgICAgICAgaXNBcnJheVJlc29sdmVkICYmCiAgICAgICAgdGhpcy5faG93TWFueSA+IHRoaXMuX2NhblBvc3NpYmx5RnVsZmlsbCgpKSB7CiAgICAgICAgdGhpcy5fcmVqZWN0KHRoaXMuX2dldFJhbmdlRXJyb3IodGhpcy5sZW5ndGgoKSkpOwogICAgfQp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkaW5pdCgpIHsKICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsKICAgIHRoaXMuX2luaXQoKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldFVud3JhcCA9IGZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkc2V0VW53cmFwKCkgewogICAgdGhpcy5fdW53cmFwID0gdHJ1ZTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLmhvd01hbnkgPSBmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JGhvd01hbnkoKSB7CiAgICByZXR1cm4gdGhpcy5faG93TWFueTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLnNldEhvd01hbnkgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JHNldEhvd01hbnkoY291bnQpIHsKICAgIGlmICh0aGlzLl9pc1Jlc29sdmVkKCkpIHJldHVybjsKICAgIHRoaXMuX2hvd01hbnkgPSBjb3VudDsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlRnVsZmlsbGVkID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfcHJvbWlzZUZ1bGZpbGxlZCh2YWx1ZSkgewogICAgaWYgKHRoaXMuX2lzUmVzb2x2ZWQoKSkgcmV0dXJuOwogICAgdGhpcy5fYWRkRnVsZmlsbGVkKHZhbHVlKTsKICAgIGlmICh0aGlzLl9mdWxmaWxsZWQoKSA9PT0gdGhpcy5ob3dNYW55KCkpIHsKICAgICAgICB0aGlzLl92YWx1ZXMubGVuZ3RoID0gdGhpcy5ob3dNYW55KCk7CiAgICAgICAgaWYgKHRoaXMuaG93TWFueSgpID09PSAxICYmIHRoaXMuX3Vud3JhcCkgewogICAgICAgICAgICB0aGlzLl9yZXNvbHZlKHRoaXMuX3ZhbHVlc1swXSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZSh0aGlzLl92YWx1ZXMpOwogICAgICAgIH0KICAgIH0KCn07ClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9wcm9taXNlUmVqZWN0ZWQgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9wcm9taXNlUmVqZWN0ZWQocmVhc29uKSB7CiAgICBpZiAodGhpcy5faXNSZXNvbHZlZCgpKSByZXR1cm47CiAgICB0aGlzLl9hZGRSZWplY3RlZChyZWFzb24pOwogICAgaWYgKHRoaXMuaG93TWFueSgpID4gdGhpcy5fY2FuUG9zc2libHlGdWxmaWxsKCkpIHsKICAgICAgICB2YXIgZSA9IG5ldyBBZ2dyZWdhdGVFcnJvcigpOwogICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmxlbmd0aCgpOyBpIDwgdGhpcy5fdmFsdWVzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICAgIGUucHVzaCh0aGlzLl92YWx1ZXNbaV0pOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZWplY3QoZSk7CiAgICB9Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fZnVsZmlsbGVkID0gZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfZnVsZmlsbGVkKCkgewogICAgcmV0dXJuIHRoaXMuX3RvdGFsUmVzb2x2ZWQ7Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fcmVqZWN0ZWQgPSBmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9yZWplY3RlZCgpIHsKICAgIHJldHVybiB0aGlzLl92YWx1ZXMubGVuZ3RoIC0gdGhpcy5sZW5ndGgoKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9hZGRSZWplY3RlZCA9CmZ1bmN0aW9uIFNvbWVQcm9taXNlQXJyYXkkX2FkZFJlamVjdGVkKHJlYXNvbikgewogICAgdGhpcy5fdmFsdWVzLnB1c2gocmVhc29uKTsKfTsKClNvbWVQcm9taXNlQXJyYXkucHJvdG90eXBlLl9hZGRGdWxmaWxsZWQgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9hZGRGdWxmaWxsZWQodmFsdWUpIHsKICAgIHRoaXMuX3ZhbHVlc1t0aGlzLl90b3RhbFJlc29sdmVkKytdID0gdmFsdWU7Cn07CgpTb21lUHJvbWlzZUFycmF5LnByb3RvdHlwZS5fY2FuUG9zc2libHlGdWxmaWxsID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfY2FuUG9zc2libHlGdWxmaWxsKCkgewogICAgcmV0dXJuIHRoaXMubGVuZ3RoKCkgLSB0aGlzLl9yZWplY3RlZCgpOwp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX2dldFJhbmdlRXJyb3IgPQpmdW5jdGlvbiBTb21lUHJvbWlzZUFycmF5JF9nZXRSYW5nZUVycm9yKGNvdW50KSB7CiAgICB2YXIgbWVzc2FnZSA9ICJJbnB1dCBhcnJheSBtdXN0IGNvbnRhaW4gYXQgbGVhc3QgIiArCiAgICAgICAgICAgIHRoaXMuX2hvd01hbnkgKyAiIGl0ZW1zIGJ1dCBjb250YWlucyBvbmx5ICIgKyBjb3VudCArICIgaXRlbXMiOwogICAgcmV0dXJuIG5ldyBSYW5nZUVycm9yKG1lc3NhZ2UpOwp9OwoKU29tZVByb21pc2VBcnJheS5wcm90b3R5cGUuX3Jlc29sdmVFbXB0eUFycmF5ID0KZnVuY3Rpb24gU29tZVByb21pc2VBcnJheSRfcmVzb2x2ZUVtcHR5QXJyYXkoKSB7CiAgICB0aGlzLl9yZWplY3QodGhpcy5fZ2V0UmFuZ2VFcnJvcigwKSk7Cn07CgpmdW5jdGlvbiBQcm9taXNlJF9Tb21lKHByb21pc2VzLCBob3dNYW55KSB7CiAgICBpZiAoKGhvd01hbnkgfCAwKSAhPT0gaG93TWFueSB8fCBob3dNYW55IDwgMCkgewogICAgICAgIHJldHVybiBhcGlSZWplY3Rpb24oImV4cGVjdGluZyBhIHBvc2l0aXZlIGludGVnZXIiKTsKICAgIH0KICAgIHZhciByZXQgPSBuZXcgU29tZVByb21pc2VBcnJheShwcm9taXNlcyk7CiAgICB2YXIgcHJvbWlzZSA9IHJldC5wcm9taXNlKCk7CiAgICBpZiAocHJvbWlzZS5pc1JlamVjdGVkKCkpIHsKICAgICAgICByZXR1cm4gcHJvbWlzZTsKICAgIH0KICAgIHJldC5zZXRIb3dNYW55KGhvd01hbnkpOwogICAgcmV0LmluaXQoKTsKICAgIHJldHVybiBwcm9taXNlOwp9CgpQcm9taXNlLnNvbWUgPSBmdW5jdGlvbiBQcm9taXNlJFNvbWUocHJvbWlzZXMsIGhvd01hbnkpIHsKICAgIHJldHVybiBQcm9taXNlJF9Tb21lKHByb21pc2VzLCBob3dNYW55KTsKfTsKClByb21pc2UucHJvdG90eXBlLnNvbWUgPSBmdW5jdGlvbiBQcm9taXNlJHNvbWUoaG93TWFueSkgewogICAgcmV0dXJuIFByb21pc2UkX1NvbWUodGhpcywgaG93TWFueSk7Cn07CgpQcm9taXNlLl9Tb21lUHJvbWlzZUFycmF5ID0gU29tZVByb21pc2VBcnJheTsKfTsKCn0seyIuL2Vycm9ycy5qcyI6MjUsIi4vdXRpbC5qcyI6NTB9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UpIHsKZnVuY3Rpb24gUHJvbWlzZUluc3BlY3Rpb24ocHJvbWlzZSkgewogICAgaWYgKHByb21pc2UgIT09IHZvaWQgMCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gcHJvbWlzZS5fYml0RmllbGQ7CiAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gcHJvbWlzZS5pc1Jlc29sdmVkKCkKICAgICAgICAgICAgPyBwcm9taXNlLl9zZXR0bGVkVmFsdWUKICAgICAgICAgICAgOiB2b2lkIDA7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0aGlzLl9iaXRGaWVsZCA9IDA7CiAgICAgICAgdGhpcy5fc2V0dGxlZFZhbHVlID0gdm9pZCAwOwogICAgfQp9CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNGdWxmaWxsZWQgPQpQcm9taXNlLnByb3RvdHlwZS5pc0Z1bGZpbGxlZCA9IGZ1bmN0aW9uIFByb21pc2UkaXNGdWxmaWxsZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMjY4NDM1NDU2KSA+IDA7Cn07CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNSZWplY3RlZCA9ClByb21pc2UucHJvdG90eXBlLmlzUmVqZWN0ZWQgPSBmdW5jdGlvbiBQcm9taXNlJGlzUmVqZWN0ZWQoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgMTM0MjE3NzI4KSA+IDA7Cn07CgpQcm9taXNlSW5zcGVjdGlvbi5wcm90b3R5cGUuaXNQZW5kaW5nID0KUHJvbWlzZS5wcm90b3R5cGUuaXNQZW5kaW5nID0gZnVuY3Rpb24gUHJvbWlzZSRpc1BlbmRpbmcoKSB7CiAgICByZXR1cm4gKHRoaXMuX2JpdEZpZWxkICYgNDAyNjUzMTg0KSA9PT0gMDsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS52YWx1ZSA9ClByb21pc2UucHJvdG90eXBlLnZhbHVlID0gZnVuY3Rpb24gUHJvbWlzZSR2YWx1ZSgpIHsKICAgIGlmICghdGhpcy5pc0Z1bGZpbGxlZCgpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiY2Fubm90IGdldCBmdWxmaWxsbWVudCB2YWx1ZSBvZiBhIG5vbi1mdWxmaWxsZWQgcHJvbWlzZSIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3NldHRsZWRWYWx1ZTsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5lcnJvciA9ClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5yZWFzb24gPQpQcm9taXNlLnByb3RvdHlwZS5yZWFzb24gPSBmdW5jdGlvbiBQcm9taXNlJHJlYXNvbigpIHsKICAgIGlmICghdGhpcy5pc1JlamVjdGVkKCkpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJjYW5ub3QgZ2V0IHJlamVjdGlvbiByZWFzb24gb2YgYSBub24tcmVqZWN0ZWQgcHJvbWlzZSIpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX3NldHRsZWRWYWx1ZTsKfTsKClByb21pc2VJbnNwZWN0aW9uLnByb3RvdHlwZS5pc1Jlc29sdmVkID0KUHJvbWlzZS5wcm90b3R5cGUuaXNSZXNvbHZlZCA9IGZ1bmN0aW9uIFByb21pc2UkaXNSZXNvbHZlZCgpIHsKICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiA0MDI2NTMxODQpID4gMDsKfTsKClByb21pc2UuUHJvbWlzZUluc3BlY3Rpb24gPSBQcm9taXNlSW5zcGVjdGlvbjsKfTsKCn0se31dLDQ3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoqCiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKQogKiAKICogQ29weXJpZ2h0IChjKSAyMDE0IFBldGthIEFudG9ub3YKICogCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwogKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOjwvcD4KICogCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKiAKICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuICBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgogKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCiAqIFRIRSBTT0ZUV0FSRS4KICogCiAqLwoidXNlIHN0cmljdCI7Cm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUHJvbWlzZSwgSU5URVJOQUwpIHsKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwuanMiKTsKdmFyIGNhbkF0dGFjaCA9IHJlcXVpcmUoIi4vZXJyb3JzLmpzIikuY2FuQXR0YWNoOwp2YXIgZXJyb3JPYmogPSB1dGlsLmVycm9yT2JqOwp2YXIgaXNPYmplY3QgPSB1dGlsLmlzT2JqZWN0OwoKZnVuY3Rpb24gZ2V0VGhlbihvYmopIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG9iai50aGVuOwogICAgfQogICAgY2F0Y2goZSkgewogICAgICAgIGVycm9yT2JqLmUgPSBlOwogICAgICAgIHJldHVybiBlcnJvck9iajsKICAgIH0KfQoKZnVuY3Rpb24gUHJvbWlzZSRfQ2FzdChvYmosIG9yaWdpbmFsUHJvbWlzZSkgewogICAgaWYgKGlzT2JqZWN0KG9iaikpIHsKICAgICAgICBpZiAob2JqIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChpc0FueUJsdWViaXJkUHJvbWlzZShvYmopKSB7CiAgICAgICAgICAgIHZhciByZXQgPSBuZXcgUHJvbWlzZShJTlRFUk5BTCk7CiAgICAgICAgICAgIHJldC5fc2V0VHJhY2Uodm9pZCAwKTsKICAgICAgICAgICAgb2JqLl90aGVuKAogICAgICAgICAgICAgICAgcmV0Ll9mdWxmaWxsVW5jaGVja2VkLAogICAgICAgICAgICAgICAgcmV0Ll9yZWplY3RVbmNoZWNrZWRDaGVja0Vycm9yLAogICAgICAgICAgICAgICAgcmV0Ll9wcm9ncmVzc1VuY2hlY2tlZCwKICAgICAgICAgICAgICAgIHJldCwKICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgKTsKICAgICAgICAgICAgcmV0Ll9zZXRGb2xsb3dpbmcoKTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgdmFyIHRoZW4gPSBnZXRUaGVuKG9iaik7CiAgICAgICAgaWYgKHRoZW4gPT09IGVycm9yT2JqKSB7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbFByb21pc2UgIT09IHZvaWQgMCAmJiBjYW5BdHRhY2godGhlbi5lKSkgewogICAgICAgICAgICAgICAgb3JpZ2luYWxQcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKHRoZW4uZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KHRoZW4uZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gUHJvbWlzZSRfZG9UaGVuYWJsZShvYmosIHRoZW4sIG9yaWdpbmFsUHJvbWlzZSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKfQoKdmFyIGhhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eTsKZnVuY3Rpb24gaXNBbnlCbHVlYmlyZFByb21pc2Uob2JqKSB7CiAgICByZXR1cm4gaGFzUHJvcC5jYWxsKG9iaiwgIl9wcm9taXNlMCIpOwp9CgpmdW5jdGlvbiBQcm9taXNlJF9kb1RoZW5hYmxlKHgsIHRoZW4sIG9yaWdpbmFsUHJvbWlzZSkgewogICAgdmFyIHJlc29sdmVyID0gUHJvbWlzZS5kZWZlcigpOwogICAgdmFyIGNhbGxlZCA9IGZhbHNlOwogICAgdHJ5IHsKICAgICAgICB0aGVuLmNhbGwoCiAgICAgICAgICAgIHgsCiAgICAgICAgICAgIFByb21pc2UkX3Jlc29sdmVGcm9tVGhlbmFibGUsCiAgICAgICAgICAgIFByb21pc2UkX3JlamVjdEZyb21UaGVuYWJsZSwKICAgICAgICAgICAgUHJvbWlzZSRfcHJvZ3Jlc3NGcm9tVGhlbmFibGUKICAgICAgICApOwogICAgfSBjYXRjaChlKSB7CiAgICAgICAgaWYgKCFjYWxsZWQpIHsKICAgICAgICAgICAgY2FsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRyYWNlID0gY2FuQXR0YWNoKGUpID8gZSA6IG5ldyBFcnJvcihlICsgIiIpOwogICAgICAgICAgICBpZiAob3JpZ2luYWxQcm9taXNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG9yaWdpbmFsUHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZSh0cmFjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb2x2ZXIucHJvbWlzZS5fcmVqZWN0KGUsIHRyYWNlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzb2x2ZXIucHJvbWlzZTsKCiAgICBmdW5jdGlvbiBQcm9taXNlJF9yZXNvbHZlRnJvbVRoZW5hYmxlKHkpIHsKICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47CiAgICAgICAgY2FsbGVkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHggPT09IHkpIHsKICAgICAgICAgICAgdmFyIGUgPSBQcm9taXNlLl9tYWtlU2VsZlJlc29sdXRpb25FcnJvcigpOwogICAgICAgICAgICBpZiAob3JpZ2luYWxQcm9taXNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG9yaWdpbmFsUHJvbWlzZS5fYXR0YWNoRXh0cmFUcmFjZShlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNvbHZlci5wcm9taXNlLl9yZWplY3QoZSwgdm9pZCAwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICByZXNvbHZlci5yZXNvbHZlKHkpOwogICAgfQoKICAgIGZ1bmN0aW9uIFByb21pc2UkX3JlamVjdEZyb21UaGVuYWJsZShyKSB7CiAgICAgICAgaWYgKGNhbGxlZCkgcmV0dXJuOwogICAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgICAgdmFyIHRyYWNlID0gY2FuQXR0YWNoKHIpID8gciA6IG5ldyBFcnJvcihyICsgIiIpOwogICAgICAgIGlmIChvcmlnaW5hbFByb21pc2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICBvcmlnaW5hbFByb21pc2UuX2F0dGFjaEV4dHJhVHJhY2UodHJhY2UpOwogICAgICAgIH0KICAgICAgICByZXNvbHZlci5wcm9taXNlLl9yZWplY3QociwgdHJhY2UpOwogICAgfQoKICAgIGZ1bmN0aW9uIFByb21pc2UkX3Byb2dyZXNzRnJvbVRoZW5hYmxlKHYpIHsKICAgICAgICBpZiAoY2FsbGVkKSByZXR1cm47CiAgICAgICAgdmFyIHByb21pc2UgPSByZXNvbHZlci5wcm9taXNlOwogICAgICAgIGlmICh0eXBlb2YgcHJvbWlzZS5fcHJvZ3Jlc3MgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcHJvbWlzZS5fcHJvZ3Jlc3Modik7CiAgICAgICAgfQogICAgfQp9CgpyZXR1cm4gUHJvbWlzZSRfQ2FzdDsKfTsKCn0seyIuL2Vycm9ycy5qcyI6MjUsIi4vdXRpbC5qcyI6NTB9XSw0ODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwp2YXIgX3NldFRpbWVvdXQgPSBmdW5jdGlvbihmbiwgbXMpIHsKICAgIHZhciBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwogICAgdmFyIGFyZzAgPSBhcmd1bWVudHNbMl07CiAgICB2YXIgYXJnMSA9IGFyZ3VtZW50c1szXTsKICAgIHZhciBhcmcyID0gbGVuID49IDUgPyBhcmd1bWVudHNbNF0gOiB2b2lkIDA7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGZuKGFyZzAsIGFyZzEsIGFyZzIpOwogICAgfSwgbXN8MCk7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKFByb21pc2UsIElOVEVSTkFMLCBjYXN0KSB7CnZhciB1dGlsID0gcmVxdWlyZSgiLi91dGlsLmpzIik7CnZhciBlcnJvcnMgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpOwp2YXIgYXBpUmVqZWN0aW9uID0gcmVxdWlyZSgiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiIpKFByb21pc2UpOwp2YXIgVGltZW91dEVycm9yID0gUHJvbWlzZS5UaW1lb3V0RXJyb3I7Cgp2YXIgYWZ0ZXJUaW1lb3V0ID0gZnVuY3Rpb24gUHJvbWlzZSRfYWZ0ZXJUaW1lb3V0KHByb21pc2UsIG1lc3NhZ2UsIG1zKSB7CiAgICBpZiAoIXByb21pc2UuaXNQZW5kaW5nKCkpIHJldHVybjsKICAgIGlmICh0eXBlb2YgbWVzc2FnZSAhPT0gInN0cmluZyIpIHsKICAgICAgICBtZXNzYWdlID0gIm9wZXJhdGlvbiB0aW1lZCBvdXQgYWZ0ZXIiICsgIiAiICsgbXMgKyAiIG1zIgogICAgfQogICAgdmFyIGVyciA9IG5ldyBUaW1lb3V0RXJyb3IobWVzc2FnZSk7CiAgICBlcnJvcnMubWFya0FzT3JpZ2luYXRpbmdGcm9tUmVqZWN0aW9uKGVycik7CiAgICBwcm9taXNlLl9hdHRhY2hFeHRyYVRyYWNlKGVycik7CiAgICBwcm9taXNlLl9jYW5jZWwoZXJyKTsKfTsKCnZhciBhZnRlckRlbGF5ID0gZnVuY3Rpb24gUHJvbWlzZSRfYWZ0ZXJEZWxheSh2YWx1ZSwgcHJvbWlzZSkgewogICAgcHJvbWlzZS5fZnVsZmlsbCh2YWx1ZSk7Cn07Cgp2YXIgZGVsYXkgPSBQcm9taXNlLmRlbGF5ID0gZnVuY3Rpb24gUHJvbWlzZSREZWxheSh2YWx1ZSwgbXMpIHsKICAgIGlmIChtcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgbXMgPSB2YWx1ZTsKICAgICAgICB2YWx1ZSA9IHZvaWQgMDsKICAgIH0KICAgIG1zID0gK21zOwogICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3QodmFsdWUsIHZvaWQgMCk7CiAgICB2YXIgcHJvbWlzZSA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKCiAgICBpZiAobWF5YmVQcm9taXNlIGluc3RhbmNlb2YgUHJvbWlzZSkgewogICAgICAgIHByb21pc2UuX3Byb3BhZ2F0ZUZyb20obWF5YmVQcm9taXNlLCA3KTsKICAgICAgICBwcm9taXNlLl9mb2xsb3cobWF5YmVQcm9taXNlKTsKICAgICAgICByZXR1cm4gcHJvbWlzZS50aGVuKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmRlbGF5KHZhbHVlLCBtcyk7CiAgICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICAgIHByb21pc2UuX3NldFRyYWNlKHZvaWQgMCk7CiAgICAgICAgX3NldFRpbWVvdXQoYWZ0ZXJEZWxheSwgbXMsIHZhbHVlLCBwcm9taXNlKTsKICAgIH0KICAgIHJldHVybiBwcm9taXNlOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUuZGVsYXkgPSBmdW5jdGlvbiBQcm9taXNlJGRlbGF5KG1zKSB7CiAgICByZXR1cm4gZGVsYXkodGhpcywgbXMpOwp9OwoKUHJvbWlzZS5wcm90b3R5cGUudGltZW91dCA9IGZ1bmN0aW9uIFByb21pc2UkdGltZW91dChtcywgbWVzc2FnZSkgewogICAgbXMgPSArbXM7CgogICAgdmFyIHJldCA9IG5ldyBQcm9taXNlKElOVEVSTkFMKTsKICAgIHJldC5fcHJvcGFnYXRlRnJvbSh0aGlzLCA3KTsKICAgIHJldC5fZm9sbG93KHRoaXMpOwogICAgX3NldFRpbWVvdXQoYWZ0ZXJUaW1lb3V0LCBtcywgcmV0LCBtZXNzYWdlLCBtcyk7CiAgICByZXR1cm4gcmV0LmNhbmNlbGxhYmxlKCk7Cn07Cgp9OwoKfSx7Ii4vZXJyb3JzLmpzIjoyNSwiLi9lcnJvcnNfYXBpX3JlamVjdGlvbiI6MjYsIi4vdXRpbC5qcyI6NTB9XSw0OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qKgogKiBUaGUgTUlUIExpY2Vuc2UgKE1JVCkKICogCiAqIENvcHlyaWdodCAoYykgMjAxNCBQZXRrYSBBbnRvbm92CiAqIAogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczo8L3A+CiAqIAogKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbgogKiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KICogCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiAgSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqIAogKi8KInVzZSBzdHJpY3QiOwptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIChQcm9taXNlLCBhcGlSZWplY3Rpb24sIGNhc3QpIHsKICAgIHZhciBUeXBlRXJyb3IgPSByZXF1aXJlKCIuL2Vycm9ycy5qcyIpLlR5cGVFcnJvcjsKICAgIHZhciBpbmhlcml0cyA9IHJlcXVpcmUoIi4vdXRpbC5qcyIpLmluaGVyaXRzOwogICAgdmFyIFByb21pc2VJbnNwZWN0aW9uID0gUHJvbWlzZS5Qcm9taXNlSW5zcGVjdGlvbjsKCiAgICBmdW5jdGlvbiBpbnNwZWN0aW9uTWFwcGVyKGluc3BlY3Rpb25zKSB7CiAgICAgICAgdmFyIGxlbiA9IGluc3BlY3Rpb25zLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgICAgIHZhciBpbnNwZWN0aW9uID0gaW5zcGVjdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChpbnNwZWN0aW9uLmlzUmVqZWN0ZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGluc3BlY3Rpb24uZXJyb3IoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zcGVjdGlvbnNbaV0gPSBpbnNwZWN0aW9uLnZhbHVlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpbnNwZWN0aW9uczsKICAgIH0KCiAgICBmdW5jdGlvbiB0aHJvd2VyKGUpIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7dGhyb3cgZTt9LCAwKTsKICAgIH0KCiAgICBmdW5jdGlvbiBjYXN0UHJlc2VydmluZ0Rpc3Bvc2FibGUodGhlbmFibGUpIHsKICAgICAgICB2YXIgbWF5YmVQcm9taXNlID0gY2FzdCh0aGVuYWJsZSwgdm9pZCAwKTsKICAgICAgICBpZiAobWF5YmVQcm9taXNlICE9PSB0aGVuYWJsZSAmJgogICAgICAgICAgICB0eXBlb2YgdGhlbmFibGUuX2lzRGlzcG9zYWJsZSA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgICAgICB0eXBlb2YgdGhlbmFibGUuX2dldERpc3Bvc2VyID09PSAiZnVuY3Rpb24iICYmCiAgICAgICAgICAgIHRoZW5hYmxlLl9pc0Rpc3Bvc2FibGUoKSkgewogICAgICAgICAgICBtYXliZVByb21pc2UuX3NldERpc3Bvc2FibGUodGhlbmFibGUuX2dldERpc3Bvc2VyKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF5YmVQcm9taXNlOwogICAgfQogICAgZnVuY3Rpb24gZGlzcG9zZShyZXNvdXJjZXMsIGluc3BlY3Rpb24pIHsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgdmFyIGxlbiA9IHJlc291cmNlcy5sZW5ndGg7CiAgICAgICAgdmFyIHJldCA9IFByb21pc2UuZGVmZXIoKTsKICAgICAgICBmdW5jdGlvbiBpdGVyYXRvcigpIHsKICAgICAgICAgICAgaWYgKGkgPj0gbGVuKSByZXR1cm4gcmV0LnJlc29sdmUoKTsKICAgICAgICAgICAgdmFyIG1heWJlUHJvbWlzZSA9IGNhc3RQcmVzZXJ2aW5nRGlzcG9zYWJsZShyZXNvdXJjZXNbaSsrXSk7CiAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlICYmCiAgICAgICAgICAgICAgICBtYXliZVByb21pc2UuX2lzRGlzcG9zYWJsZSgpKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIG1heWJlUHJvbWlzZSA9IGNhc3QobWF5YmVQcm9taXNlLl9nZXREaXNwb3NlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJ5RGlzcG9zZShpbnNwZWN0aW9uKSwgdm9pZCAwKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dlcihlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChtYXliZVByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heWJlUHJvbWlzZS5fdGhlbihpdGVyYXRvciwgdGhyb3dlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsIG51bGwsIG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZXJhdG9yKCk7CiAgICAgICAgfQogICAgICAgIGl0ZXJhdG9yKCk7CiAgICAgICAgcmV0dXJuIHJldC5wcm9taXNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGRpc3Bvc2VyU3VjY2Vzcyh2YWx1ZSkgewogICAgICAgIHZhciBpbnNwZWN0aW9uID0gbmV3IFByb21pc2VJbnNwZWN0aW9uKCk7CiAgICAgICAgaW5zcGVjdGlvbi5fc2V0dGxlZFZhbHVlID0gdmFsdWU7CiAgICAgICAgaW5zcGVjdGlvbi5fYml0RmllbGQgPSAyNjg0MzU0NTY7CiAgICAgICAgcmV0dXJuIGRpc3Bvc2UodGhpcywgaW5zcGVjdGlvbikudGhlblJldHVybih2YWx1ZSk7CiAgICB9CgogICAgZnVuY3Rpb24gZGlzcG9zZXJGYWlsKHJlYXNvbikgewogICAgICAgIHZhciBpbnNwZWN0aW9uID0gbmV3IFByb21pc2VJbnNwZWN0aW9uKCk7CiAgICAgICAgaW5zcGVjdGlvbi5fc2V0dGxlZFZhbHVlID0gcmVhc29uOwogICAgICAgIGluc3BlY3Rpb24uX2JpdEZpZWxkID0gMTM0MjE3NzI4OwogICAgICAgIHJldHVybiBkaXNwb3NlKHRoaXMsIGluc3BlY3Rpb24pLnRoZW5UaHJvdyhyZWFzb24pOwogICAgfQoKICAgIGZ1bmN0aW9uIERpc3Bvc2VyKGRhdGEsIHByb21pc2UpIHsKICAgICAgICB0aGlzLl9kYXRhID0gZGF0YTsKICAgICAgICB0aGlzLl9wcm9taXNlID0gcHJvbWlzZTsKICAgIH0KCiAgICBEaXNwb3Nlci5wcm90b3R5cGUuZGF0YSA9IGZ1bmN0aW9uIERpc3Bvc2VyJGRhdGEoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgICB9OwoKICAgIERpc3Bvc2VyLnByb3RvdHlwZS5wcm9taXNlID0gZnVuY3Rpb24gRGlzcG9zZXIkcHJvbWlzZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcHJvbWlzZTsKICAgIH07CgogICAgRGlzcG9zZXIucHJvdG90eXBlLnJlc291cmNlID0gZnVuY3Rpb24gRGlzcG9zZXIkcmVzb3VyY2UoKSB7CiAgICAgICAgaWYgKHRoaXMucHJvbWlzZSgpLmlzRnVsZmlsbGVkKCkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucHJvbWlzZSgpLnZhbHVlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgfTsKCiAgICBEaXNwb3Nlci5wcm90b3R5cGUudHJ5RGlzcG9zZSA9IGZ1bmN0aW9uKGluc3BlY3Rpb24pIHsKICAgICAgICB2YXIgcmVzb3VyY2UgPSB0aGlzLnJlc291cmNlKCk7CiAgICAgICAgdmFyIHJldCA9IHJlc291cmNlICE9PSBudWxsCiAgICAgICAgICAgID8gdGhpcy5kb0Rpc3Bvc2UocmVzb3VyY2UsIGluc3BlY3Rpb24pIDogbnVsbDsKICAgICAgICB0aGlzLl9wcm9taXNlLl91bnNldERpc3Bvc2FibGUoKTsKICAgICAgICB0aGlzLl9kYXRhID0gdGhpcy5fcHJvbWlzZSA9IG51bGw7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgRGlzcG9zZXIuaXNEaXNwb3NlciA9IGZ1bmN0aW9uIERpc3Bvc2VyJGlzRGlzcG9zZXIoZCkgewogICAgICAgIHJldHVybiAoZCAhPSBudWxsICYmCiAgICAgICAgICAgICAgICB0eXBlb2YgZC5yZXNvdXJjZSA9PT0gImZ1bmN0aW9uIiAmJgogICAgICAgICAgICAgICAgdHlwZW9mIGQudHJ5RGlzcG9zZSA9PT0gImZ1bmN0aW9uIik7CiAgICB9OwoKICAgIGZ1bmN0aW9uIEZ1bmN0aW9uRGlzcG9zZXIoZm4sIHByb21pc2UpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yJChmbiwgcHJvbWlzZSk7CiAgICB9CiAgICBpbmhlcml0cyhGdW5jdGlvbkRpc3Bvc2VyLCBEaXNwb3Nlcik7CgogICAgRnVuY3Rpb25EaXNwb3Nlci5wcm90b3R5cGUuZG9EaXNwb3NlID0gZnVuY3Rpb24gKHJlc291cmNlLCBpbnNwZWN0aW9uKSB7CiAgICAgICAgdmFyIGZuID0gdGhpcy5kYXRhKCk7CiAgICAgICAgcmV0dXJuIGZuLmNhbGwocmVzb3VyY2UsIHJlc291cmNlLCBpbnNwZWN0aW9uKTsKICAgIH07CgogICAgUHJvbWlzZS51c2luZyA9IGZ1bmN0aW9uIFByb21pc2UkdXNpbmcoKSB7CiAgICAgICAgdmFyIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgICAgaWYgKGxlbiA8IDIpIHJldHVybiBhcGlSZWplY3Rpb24oCiAgICAgICAgICAgICAgICAgICAgICAgICJ5b3UgbXVzdCBwYXNzIGF0IGxlYXN0IDIgYXJndW1lbnRzIHRvIFByb21pc2UudXNpbmciKTsKICAgICAgICB2YXIgZm4gPSBhcmd1bWVudHNbbGVuIC0gMV07CiAgICAgICAgaWYgKHR5cGVvZiBmbiAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIGFwaVJlamVjdGlvbigiZm4gbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgbGVuLS07CiAgICAgICAgdmFyIHJlc291cmNlcyA9IG5ldyBBcnJheShsZW4pOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICAgICAgdmFyIHJlc291cmNlID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICBpZiAoRGlzcG9zZXIuaXNEaXNwb3NlcihyZXNvdXJjZSkpIHsKICAgICAgICAgICAgICAgIHZhciBkaXNwb3NlciA9IHJlc291cmNlOwogICAgICAgICAgICAgICAgcmVzb3VyY2UgPSByZXNvdXJjZS5wcm9taXNlKCk7CiAgICAgICAgICAgICAgICByZXNvdXJjZS5fc2V0RGlzcG9zYWJsZShkaXNwb3Nlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb3VyY2VzW2ldID0gcmVzb3VyY2U7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gUHJvbWlzZS5zZXR0bGUocmVzb3VyY2VzKQogICAgICAgICAgICAudGhlbihpbnNwZWN0aW9uTWFwcGVyKQogICAgICAgICAgICAuc3ByZWFkKGZuKQogICAgICAgICAgICAuX3RoZW4oZGlzcG9zZXJTdWNjZXNzLCBkaXNwb3NlckZhaWwsIHZvaWQgMCwgcmVzb3VyY2VzLCB2b2lkIDApOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5fc2V0RGlzcG9zYWJsZSA9CiAgICBmdW5jdGlvbiBQcm9taXNlJF9zZXREaXNwb3NhYmxlKGRpc3Bvc2VyKSB7CiAgICAgICAgdGhpcy5fYml0RmllbGQgPSB0aGlzLl9iaXRGaWVsZCB8IDI2MjE0NDsKICAgICAgICB0aGlzLl9kaXNwb3NlciA9IGRpc3Bvc2VyOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5faXNEaXNwb3NhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfaXNEaXNwb3NhYmxlKCkgewogICAgICAgIHJldHVybiAodGhpcy5fYml0RmllbGQgJiAyNjIxNDQpID4gMDsKICAgIH07CgogICAgUHJvbWlzZS5wcm90b3R5cGUuX2dldERpc3Bvc2VyID0gZnVuY3Rpb24gUHJvbWlzZSRfZ2V0RGlzcG9zZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Rpc3Bvc2VyOwogICAgfTsKCiAgICBQcm9taXNlLnByb3RvdHlwZS5fdW5zZXREaXNwb3NhYmxlID0gZnVuY3Rpb24gUHJvbWlzZSRfdW5zZXREaXNwb3NhYmxlKCkgewogICAgICAgIHRoaXMuX2JpdEZpZWxkID0gdGhpcy5fYml0RmllbGQgJiAofjI2MjE0NCk7CiAgICAgICAgdGhpcy5fZGlzcG9zZXIgPSB2b2lkIDA7CiAgICB9OwoKICAgIFByb21pc2UucHJvdG90eXBlLmRpc3Bvc2VyID0gZnVuY3Rpb24gUHJvbWlzZSRkaXNwb3NlcihmbikgewogICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBGdW5jdGlvbkRpc3Bvc2VyKGZuLCB0aGlzKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigpOwogICAgfTsKCn07Cgp9LHsiLi9lcnJvcnMuanMiOjI1LCIuL3V0aWwuanMiOjUwfV0sNTA6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKioKICogVGhlIE1JVCBMaWNlbnNlIChNSVQpCiAqIAogKiBDb3B5cmlnaHQgKGMpIDIwMTQgUGV0a2EgQW50b25vdgogKiAKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6PC9wPgogKiAKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KICogYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqIAogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gIElOIE5PIEVWRU5UIFNIQUxMIFRIRQogKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KICogVEhFIFNPRlRXQVJFLgogKiAKICovCiJ1c2Ugc3RyaWN0IjsKdmFyIGVzNSA9IHJlcXVpcmUoIi4vZXM1LmpzIik7CnZhciBoYXZlR2V0dGVycyA9IChmdW5jdGlvbigpewogICAgdHJ5IHsKICAgICAgICB2YXIgbyA9IHt9OwogICAgICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShvLCAiZiIsIHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gMzsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBvLmYgPT09IDM7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCn0pKCk7CnZhciBjYW5FdmFsdWF0ZSA9IHR5cGVvZiBuYXZpZ2F0b3IgPT0gInVuZGVmaW5lZCI7CnZhciBlcnJvck9iaiA9IHtlOiB7fX07CmZ1bmN0aW9uIHRyeUNhdGNoMShmbiwgcmVjZWl2ZXIsIGFyZykgewogICAgdHJ5IHsgcmV0dXJuIGZuLmNhbGwocmVjZWl2ZXIsIGFyZyk7IH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IGU7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQp9CgpmdW5jdGlvbiB0cnlDYXRjaDIoZm4sIHJlY2VpdmVyLCBhcmcsIGFyZzIpIHsKICAgIHRyeSB7IHJldHVybiBmbi5jYWxsKHJlY2VpdmVyLCBhcmcsIGFyZzIpOyB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIGVycm9yT2JqLmUgPSBlOwogICAgICAgIHJldHVybiBlcnJvck9iajsKICAgIH0KfQoKZnVuY3Rpb24gdHJ5Q2F0Y2gzKGZuLCByZWNlaXZlciwgYXJnLCBhcmcyLCBhcmczKSB7CiAgICB0cnkgeyByZXR1cm4gZm4uY2FsbChyZWNlaXZlciwgYXJnLCBhcmcyLCBhcmczKTsgfQogICAgY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvck9iai5lID0gZTsKICAgICAgICByZXR1cm4gZXJyb3JPYmo7CiAgICB9Cn0KCmZ1bmN0aW9uIHRyeUNhdGNoNChmbiwgcmVjZWl2ZXIsIGFyZywgYXJnMiwgYXJnMywgYXJnNCkgewogICAgdHJ5IHsgcmV0dXJuIGZuLmNhbGwocmVjZWl2ZXIsIGFyZywgYXJnMiwgYXJnMywgYXJnNCk7IH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgZXJyb3JPYmouZSA9IGU7CiAgICAgICAgcmV0dXJuIGVycm9yT2JqOwogICAgfQp9CgpmdW5jdGlvbiB0cnlDYXRjaEFwcGx5KGZuLCBhcmdzLCByZWNlaXZlcikgewogICAgdHJ5IHsgcmV0dXJuIGZuLmFwcGx5KHJlY2VpdmVyLCBhcmdzKTsgfQogICAgY2F0Y2ggKGUpIHsKICAgICAgICBlcnJvck9iai5lID0gZTsKICAgICAgICByZXR1cm4gZXJyb3JPYmo7CiAgICB9Cn0KCnZhciBpbmhlcml0cyA9IGZ1bmN0aW9uKENoaWxkLCBQYXJlbnQpIHsKICAgIHZhciBoYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHk7CgogICAgZnVuY3Rpb24gVCgpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yID0gQ2hpbGQ7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3RvciQgPSBQYXJlbnQ7CiAgICAgICAgZm9yICh2YXIgcHJvcGVydHlOYW1lIGluIFBhcmVudC5wcm90b3R5cGUpIHsKICAgICAgICAgICAgaWYgKGhhc1Byb3AuY2FsbChQYXJlbnQucHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUpICYmCiAgICAgICAgICAgICAgICBwcm9wZXJ0eU5hbWUuY2hhckF0KHByb3BlcnR5TmFtZS5sZW5ndGgtMSkgIT09ICIkIgogICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdGhpc1twcm9wZXJ0eU5hbWUgKyAiJCJdID0gUGFyZW50LnByb3RvdHlwZVtwcm9wZXJ0eU5hbWVdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgVC5wcm90b3R5cGUgPSBQYXJlbnQucHJvdG90eXBlOwogICAgQ2hpbGQucHJvdG90eXBlID0gbmV3IFQoKTsKICAgIHJldHVybiBDaGlsZC5wcm90b3R5cGU7Cn07CgpmdW5jdGlvbiBhc1N0cmluZyh2YWwpIHsKICAgIHJldHVybiB0eXBlb2YgdmFsID09PSAic3RyaW5nIiA/IHZhbCA6ICgiIiArIHZhbCk7Cn0KCmZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbCkgewogICAgcmV0dXJuIHZhbCA9PSBudWxsIHx8IHZhbCA9PT0gdHJ1ZSB8fCB2YWwgPT09IGZhbHNlIHx8CiAgICAgICAgdHlwZW9mIHZhbCA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHZhbCA9PT0gIm51bWJlciI7Cgp9CgpmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgcmV0dXJuICFpc1ByaW1pdGl2ZSh2YWx1ZSk7Cn0KCmZ1bmN0aW9uIG1heWJlV3JhcEFzRXJyb3IobWF5YmVFcnJvcikgewogICAgaWYgKCFpc1ByaW1pdGl2ZShtYXliZUVycm9yKSkgcmV0dXJuIG1heWJlRXJyb3I7CgogICAgcmV0dXJuIG5ldyBFcnJvcihhc1N0cmluZyhtYXliZUVycm9yKSk7Cn0KCmZ1bmN0aW9uIHdpdGhBcHBlbmRlZCh0YXJnZXQsIGFwcGVuZGVlKSB7CiAgICB2YXIgbGVuID0gdGFyZ2V0Lmxlbmd0aDsKICAgIHZhciByZXQgPSBuZXcgQXJyYXkobGVuICsgMSk7CiAgICB2YXIgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgICAgIHJldFtpXSA9IHRhcmdldFtpXTsKICAgIH0KICAgIHJldFtpXSA9IGFwcGVuZGVlOwogICAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0KG9iaiwga2V5LCBkZWZhdWx0VmFsdWUpIHsKICAgIGlmIChlczUuaXNFUzUpIHsKICAgICAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwogICAgICAgIGlmIChkZXNjICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2MuZ2V0ID09IG51bGwgJiYgZGVzYy5zZXQgPT0gbnVsbAogICAgICAgICAgICAgICAgICAgID8gZGVzYy52YWx1ZQogICAgICAgICAgICAgICAgICAgIDogZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHt9Lmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpID8gb2JqW2tleV0gOiB2b2lkIDA7CiAgICB9Cn0KCmZ1bmN0aW9uIG5vdEVudW1lcmFibGVQcm9wKG9iaiwgbmFtZSwgdmFsdWUpIHsKICAgIGlmIChpc1ByaW1pdGl2ZShvYmopKSByZXR1cm4gb2JqOwogICAgdmFyIGRlc2NyaXB0b3IgPSB7CiAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgfTsKICAgIGVzNS5kZWZpbmVQcm9wZXJ0eShvYmosIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgcmV0dXJuIG9iajsKfQoKCnZhciB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyID0gKGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMgIT09ICJzdHJpbmciOwp9KS5jYWxsKCJzdHJpbmciKTsKCmZ1bmN0aW9uIHRocm93ZXIocikgewogICAgdGhyb3cgcjsKfQoKdmFyIGluaGVyaXRlZERhdGFLZXlzID0gKGZ1bmN0aW9uKCkgewogICAgaWYgKGVzNS5pc0VTNSkgewogICAgICAgIHJldHVybiBmdW5jdGlvbihvYmosIG9wdHMpIHsKICAgICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgICB2YXIgdmlzaXRlZEtleXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICAgICAgICB2YXIgZ2V0S2V5cyA9IE9iamVjdChvcHRzKS5pbmNsdWRlSGlkZGVuCiAgICAgICAgICAgICAgICA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzCiAgICAgICAgICAgICAgICA6IE9iamVjdC5rZXlzOwogICAgICAgICAgICB3aGlsZSAob2JqICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBrZXlzOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBrZXlzID0gZ2V0S2V5cyhvYmopOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyArK2kpIHsKICAgICAgICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmlzaXRlZEtleXNba2V5XSkgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgdmlzaXRlZEtleXNba2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iaiwga2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzYyAhPSBudWxsICYmIGRlc2MuZ2V0ID09IG51bGwgJiYgZGVzYy5zZXQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG9iaiA9IGVzNS5nZXRQcm90b3R5cGVPZihvYmopOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iaikgewogICAgICAgICAgICB2YXIgcmV0ID0gW107CiAgICAgICAgICAgIC8qanNoaW50IGZvcmluOmZhbHNlICovCiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgIHJldC5wdXNoKGtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9OwogICAgfQoKfSkoKTsKCmZ1bmN0aW9uIGlzQ2xhc3MoZm4pIHsKICAgIHRyeSB7CiAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIga2V5cyA9IGVzNS5rZXlzKGZuLnByb3RvdHlwZSk7CiAgICAgICAgICAgIHJldHVybiBrZXlzLmxlbmd0aCA+IDAgJiYKICAgICAgICAgICAgICAgICAgICEoa2V5cy5sZW5ndGggPT09IDEgJiYga2V5c1swXSA9PT0gImNvbnN0cnVjdG9yIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KCmZ1bmN0aW9uIHRvRmFzdFByb3BlcnRpZXMob2JqKSB7CiAgICAvKmpzaGludCAtVzAyNyovCiAgICBmdW5jdGlvbiBmKCkge30KICAgIGYucHJvdG90eXBlID0gb2JqOwogICAgcmV0dXJuIGY7CiAgICBldmFsKG9iaik7Cn0KCnZhciByaWRlbnQgPSAvXlthLXokX11bYS16JF8wLTldKiQvaTsKZnVuY3Rpb24gaXNJZGVudGlmaWVyKHN0cikgewogICAgcmV0dXJuIHJpZGVudC50ZXN0KHN0cik7Cn0KCmZ1bmN0aW9uIGZpbGxlZFJhbmdlKGNvdW50LCBwcmVmaXgsIHN1ZmZpeCkgewogICAgdmFyIHJldCA9IG5ldyBBcnJheShjb3VudCk7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewogICAgICAgIHJldFtpXSA9IHByZWZpeCArIGkgKyBzdWZmaXg7CiAgICB9CiAgICByZXR1cm4gcmV0Owp9Cgp2YXIgcmV0ID0gewogICAgaXNDbGFzczogaXNDbGFzcywKICAgIGlzSWRlbnRpZmllcjogaXNJZGVudGlmaWVyLAogICAgaW5oZXJpdGVkRGF0YUtleXM6IGluaGVyaXRlZERhdGFLZXlzLAogICAgZ2V0RGF0YVByb3BlcnR5T3JEZWZhdWx0OiBnZXREYXRhUHJvcGVydHlPckRlZmF1bHQsCiAgICB0aHJvd2VyOiB0aHJvd2VyLAogICAgaXNBcnJheTogZXM1LmlzQXJyYXksCiAgICBoYXZlR2V0dGVyczogaGF2ZUdldHRlcnMsCiAgICBub3RFbnVtZXJhYmxlUHJvcDogbm90RW51bWVyYWJsZVByb3AsCiAgICBpc1ByaW1pdGl2ZTogaXNQcmltaXRpdmUsCiAgICBpc09iamVjdDogaXNPYmplY3QsCiAgICBjYW5FdmFsdWF0ZTogY2FuRXZhbHVhdGUsCiAgICBlcnJvck9iajogZXJyb3JPYmosCiAgICB0cnlDYXRjaDE6IHRyeUNhdGNoMSwKICAgIHRyeUNhdGNoMjogdHJ5Q2F0Y2gyLAogICAgdHJ5Q2F0Y2gzOiB0cnlDYXRjaDMsCiAgICB0cnlDYXRjaDQ6IHRyeUNhdGNoNCwKICAgIHRyeUNhdGNoQXBwbHk6IHRyeUNhdGNoQXBwbHksCiAgICBpbmhlcml0czogaW5oZXJpdHMsCiAgICB3aXRoQXBwZW5kZWQ6IHdpdGhBcHBlbmRlZCwKICAgIGFzU3RyaW5nOiBhc1N0cmluZywKICAgIG1heWJlV3JhcEFzRXJyb3I6IG1heWJlV3JhcEFzRXJyb3IsCiAgICB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyOiB3cmFwc1ByaW1pdGl2ZVJlY2VpdmVyLAogICAgdG9GYXN0UHJvcGVydGllczogdG9GYXN0UHJvcGVydGllcywKICAgIGZpbGxlZFJhbmdlOiBmaWxsZWRSYW5nZQp9OwoKbW9kdWxlLmV4cG9ydHMgPSByZXQ7Cgp9LHsiLi9lczUuanMiOjI3fV0sNTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoKfSx7fV0sNTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDUxKQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9saWIvX2VtcHR5LmpzIjo1MX1dLDUzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KCnZhciBiYXNlNjQgPSByZXF1aXJlKCdiYXNlNjQtanMnKQp2YXIgaWVlZTc1NCA9IHJlcXVpcmUoJ2llZWU3NTQnKQp2YXIgaXNBcnJheSA9IHJlcXVpcmUoJ2lzLWFycmF5JykKCmV4cG9ydHMuQnVmZmVyID0gQnVmZmVyCmV4cG9ydHMuU2xvd0J1ZmZlciA9IEJ1ZmZlcgpleHBvcnRzLklOU1BFQ1RfTUFYX0JZVEVTID0gNTAKQnVmZmVyLnBvb2xTaXplID0gODE5MiAvLyBub3QgdXNlZCBieSB0aGlzIGltcGxlbWVudGF0aW9uCgp2YXIga01heExlbmd0aCA9IDB4M2ZmZmZmZmYKCi8qKgogKiBJZiBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgOgogKiAgID09PSB0cnVlICAgIFVzZSBVaW50OEFycmF5IGltcGxlbWVudGF0aW9uIChmYXN0ZXN0KQogKiAgID09PSBmYWxzZSAgIFVzZSBPYmplY3QgaW1wbGVtZW50YXRpb24gKG1vc3QgY29tcGF0aWJsZSwgZXZlbiBJRTYpCiAqCiAqIEJyb3dzZXJzIHRoYXQgc3VwcG9ydCB0eXBlZCBhcnJheXMgYXJlIElFIDEwKywgRmlyZWZveCA0KywgQ2hyb21lIDcrLCBTYWZhcmkgNS4xKywKICogT3BlcmEgMTEuNissIGlPUyA0LjIrLgogKgogKiBOb3RlOgogKgogKiAtIEltcGxlbWVudGF0aW9uIG11c3Qgc3VwcG9ydCBhZGRpbmcgbmV3IHByb3BlcnRpZXMgdG8gYFVpbnQ4QXJyYXlgIGluc3RhbmNlcy4KICogICBGaXJlZm94IDQtMjkgbGFja2VkIHN1cHBvcnQsIGZpeGVkIGluIEZpcmVmb3ggMzArLgogKiAgIFNlZTogaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9Njk1NDM4LgogKgogKiAgLSBDaHJvbWUgOS0xMCBpcyBtaXNzaW5nIHRoZSBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uLgogKgogKiAgLSBJRTEwIGhhcyBhIGJyb2tlbiBgVHlwZWRBcnJheS5wcm90b3R5cGUuc3ViYXJyYXlgIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYXJyYXlzIG9mCiAqICAgIGluY29ycmVjdCBsZW5ndGggaW4gc29tZSBzaXR1YXRpb25zLgogKgogKiBXZSBkZXRlY3QgdGhlc2UgYnVnZ3kgYnJvd3NlcnMgYW5kIHNldCBgQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlRgIHRvIGBmYWxzZWAgc28gdGhleSB3aWxsCiAqIGdldCB0aGUgT2JqZWN0IGltcGxlbWVudGF0aW9uLCB3aGljaCBpcyBzbG93ZXIgYnV0IHdpbGwgd29yayBjb3JyZWN0bHkuCiAqLwpCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCA9IChmdW5jdGlvbiAoKSB7CiAgdHJ5IHsKICAgIHZhciBidWYgPSBuZXcgQXJyYXlCdWZmZXIoMCkKICAgIHZhciBhcnIgPSBuZXcgVWludDhBcnJheShidWYpCiAgICBhcnIuZm9vID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gNDIgfQogICAgcmV0dXJuIDQyID09PSBhcnIuZm9vKCkgJiYgLy8gdHlwZWQgYXJyYXkgaW5zdGFuY2VzIGNhbiBiZSBhdWdtZW50ZWQKICAgICAgICB0eXBlb2YgYXJyLnN1YmFycmF5ID09PSAnZnVuY3Rpb24nICYmIC8vIGNocm9tZSA5LTEwIGxhY2sgYHN1YmFycmF5YAogICAgICAgIG5ldyBVaW50OEFycmF5KDEpLnN1YmFycmF5KDEsIDEpLmJ5dGVMZW5ndGggPT09IDAgLy8gaWUxMCBoYXMgYnJva2VuIGBzdWJhcnJheWAKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gZmFsc2UKICB9Cn0pKCkKCi8qKgogKiBDbGFzczogQnVmZmVyCiAqID09PT09PT09PT09PT0KICoKICogVGhlIEJ1ZmZlciBjb25zdHJ1Y3RvciByZXR1cm5zIGluc3RhbmNlcyBvZiBgVWludDhBcnJheWAgdGhhdCBhcmUgYXVnbWVudGVkCiAqIHdpdGggZnVuY3Rpb24gcHJvcGVydGllcyBmb3IgYWxsIHRoZSBub2RlIGBCdWZmZXJgIEFQSSBmdW5jdGlvbnMuIFdlIHVzZQogKiBgVWludDhBcnJheWAgc28gdGhhdCBzcXVhcmUgYnJhY2tldCBub3RhdGlvbiB3b3JrcyBhcyBleHBlY3RlZCAtLSBpdCByZXR1cm5zCiAqIGEgc2luZ2xlIG9jdGV0LgogKgogKiBCeSBhdWdtZW50aW5nIHRoZSBpbnN0YW5jZXMsIHdlIGNhbiBhdm9pZCBtb2RpZnlpbmcgdGhlIGBVaW50OEFycmF5YAogKiBwcm90b3R5cGUuCiAqLwpmdW5jdGlvbiBCdWZmZXIgKHN1YmplY3QsIGVuY29kaW5nLCBub1plcm8pIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgQnVmZmVyKSkKICAgIHJldHVybiBuZXcgQnVmZmVyKHN1YmplY3QsIGVuY29kaW5nLCBub1plcm8pCgogIHZhciB0eXBlID0gdHlwZW9mIHN1YmplY3QKCiAgLy8gRmluZCB0aGUgbGVuZ3RoCiAgdmFyIGxlbmd0aAogIGlmICh0eXBlID09PSAnbnVtYmVyJykKICAgIGxlbmd0aCA9IHN1YmplY3QgPiAwID8gc3ViamVjdCA+Pj4gMCA6IDAKICBlbHNlIGlmICh0eXBlID09PSAnc3RyaW5nJykgewogICAgaWYgKGVuY29kaW5nID09PSAnYmFzZTY0JykKICAgICAgc3ViamVjdCA9IGJhc2U2NGNsZWFuKHN1YmplY3QpCiAgICBsZW5ndGggPSBCdWZmZXIuYnl0ZUxlbmd0aChzdWJqZWN0LCBlbmNvZGluZykKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdvYmplY3QnICYmIHN1YmplY3QgIT09IG51bGwpIHsgLy8gYXNzdW1lIG9iamVjdCBpcyBhcnJheS1saWtlCiAgICBpZiAoc3ViamVjdC50eXBlID09PSAnQnVmZmVyJyAmJiBpc0FycmF5KHN1YmplY3QuZGF0YSkpCiAgICAgIHN1YmplY3QgPSBzdWJqZWN0LmRhdGEKICAgIGxlbmd0aCA9ICtzdWJqZWN0Lmxlbmd0aCA+IDAgPyBNYXRoLmZsb29yKCtzdWJqZWN0Lmxlbmd0aCkgOiAwCiAgfSBlbHNlCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdtdXN0IHN0YXJ0IHdpdGggbnVtYmVyLCBidWZmZXIsIGFycmF5IG9yIHN0cmluZycpCgogIGlmICh0aGlzLmxlbmd0aCA+IGtNYXhMZW5ndGgpCiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignQXR0ZW1wdCB0byBhbGxvY2F0ZSBCdWZmZXIgbGFyZ2VyIHRoYW4gbWF4aW11bSAnICsKICAgICAgJ3NpemU6IDB4JyArIGtNYXhMZW5ndGgudG9TdHJpbmcoMTYpICsgJyBieXRlcycpCgogIHZhciBidWYKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIC8vIFByZWZlcnJlZDogUmV0dXJuIGFuIGF1Z21lbnRlZCBgVWludDhBcnJheWAgaW5zdGFuY2UgZm9yIGJlc3QgcGVyZm9ybWFuY2UKICAgIGJ1ZiA9IEJ1ZmZlci5fYXVnbWVudChuZXcgVWludDhBcnJheShsZW5ndGgpKQogIH0gZWxzZSB7CiAgICAvLyBGYWxsYmFjazogUmV0dXJuIFRISVMgaW5zdGFuY2Ugb2YgQnVmZmVyIChjcmVhdGVkIGJ5IGBuZXdgKQogICAgYnVmID0gdGhpcwogICAgYnVmLmxlbmd0aCA9IGxlbmd0aAogICAgYnVmLl9pc0J1ZmZlciA9IHRydWUKICB9CgogIHZhciBpCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUICYmIHR5cGVvZiBzdWJqZWN0LmJ5dGVMZW5ndGggPT09ICdudW1iZXInKSB7CiAgICAvLyBTcGVlZCBvcHRpbWl6YXRpb24gLS0gdXNlIHNldCBpZiB3ZSdyZSBjb3B5aW5nIGZyb20gYSB0eXBlZCBhcnJheQogICAgYnVmLl9zZXQoc3ViamVjdCkKICB9IGVsc2UgaWYgKGlzQXJyYXlpc2goc3ViamVjdCkpIHsKICAgIC8vIFRyZWF0IGFycmF5LWlzaCBvYmplY3RzIGFzIGEgYnl0ZSBhcnJheQogICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihzdWJqZWN0KSkgewogICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspCiAgICAgICAgYnVmW2ldID0gc3ViamVjdC5yZWFkVUludDgoaSkKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykKICAgICAgICBidWZbaV0gPSAoKHN1YmplY3RbaV0gJSAyNTYpICsgMjU2KSAlIDI1NgogICAgfQogIH0gZWxzZSBpZiAodHlwZSA9PT0gJ3N0cmluZycpIHsKICAgIGJ1Zi53cml0ZShzdWJqZWN0LCAwLCBlbmNvZGluZykKICB9IGVsc2UgaWYgKHR5cGUgPT09ICdudW1iZXInICYmICFCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCAmJiAhbm9aZXJvKSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgYnVmW2ldID0gMAogICAgfQogIH0KCiAgcmV0dXJuIGJ1Zgp9CgpCdWZmZXIuaXNCdWZmZXIgPSBmdW5jdGlvbiAoYikgewogIHJldHVybiAhIShiICE9IG51bGwgJiYgYi5faXNCdWZmZXIpCn0KCkJ1ZmZlci5jb21wYXJlID0gZnVuY3Rpb24gKGEsIGIpIHsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihhKSB8fCAhQnVmZmVyLmlzQnVmZmVyKGIpKQogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIG11c3QgYmUgQnVmZmVycycpCgogIHZhciB4ID0gYS5sZW5ndGgKICB2YXIgeSA9IGIubGVuZ3RoCiAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IE1hdGgubWluKHgsIHkpOyBpIDwgbGVuICYmIGFbaV0gPT09IGJbaV07IGkrKykge30KICBpZiAoaSAhPT0gbGVuKSB7CiAgICB4ID0gYVtpXQogICAgeSA9IGJbaV0KICB9CiAgaWYgKHggPCB5KSByZXR1cm4gLTEKICBpZiAoeSA8IHgpIHJldHVybiAxCiAgcmV0dXJuIDAKfQoKQnVmZmVyLmlzRW5jb2RpbmcgPSBmdW5jdGlvbiAoZW5jb2RpbmcpIHsKICBzd2l0Y2ggKFN0cmluZyhlbmNvZGluZykudG9Mb3dlckNhc2UoKSkgewogICAgY2FzZSAnaGV4JzoKICAgIGNhc2UgJ3V0ZjgnOgogICAgY2FzZSAndXRmLTgnOgogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICBjYXNlICdyYXcnOgogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0dXJuIHRydWUKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBmYWxzZQogIH0KfQoKQnVmZmVyLmNvbmNhdCA9IGZ1bmN0aW9uIChsaXN0LCB0b3RhbExlbmd0aCkgewogIGlmICghaXNBcnJheShsaXN0KSkgdGhyb3cgbmV3IFR5cGVFcnJvcignVXNhZ2U6IEJ1ZmZlci5jb25jYXQobGlzdFssIGxlbmd0aF0pJykKCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbmV3IEJ1ZmZlcigwKQogIH0gZWxzZSBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiBsaXN0WzBdCiAgfQoKICB2YXIgaQogIGlmICh0b3RhbExlbmd0aCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0b3RhbExlbmd0aCA9IDAKICAgIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIHRvdGFsTGVuZ3RoICs9IGxpc3RbaV0ubGVuZ3RoCiAgICB9CiAgfQoKICB2YXIgYnVmID0gbmV3IEJ1ZmZlcih0b3RhbExlbmd0aCkKICB2YXIgcG9zID0gMAogIGZvciAoaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICB2YXIgaXRlbSA9IGxpc3RbaV0KICAgIGl0ZW0uY29weShidWYsIHBvcykKICAgIHBvcyArPSBpdGVtLmxlbmd0aAogIH0KICByZXR1cm4gYnVmCn0KCkJ1ZmZlci5ieXRlTGVuZ3RoID0gZnVuY3Rpb24gKHN0ciwgZW5jb2RpbmcpIHsKICB2YXIgcmV0CiAgc3RyID0gc3RyICsgJycKICBzd2l0Y2ggKGVuY29kaW5nIHx8ICd1dGY4JykgewogICAgY2FzZSAnYXNjaWknOgogICAgY2FzZSAnYmluYXJ5JzoKICAgIGNhc2UgJ3Jhdyc6CiAgICAgIHJldCA9IHN0ci5sZW5ndGgKICAgICAgYnJlYWsKICAgIGNhc2UgJ3VjczInOgogICAgY2FzZSAndWNzLTInOgogICAgY2FzZSAndXRmMTZsZSc6CiAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgIHJldCA9IHN0ci5sZW5ndGggKiAyCiAgICAgIGJyZWFrCiAgICBjYXNlICdoZXgnOgogICAgICByZXQgPSBzdHIubGVuZ3RoID4+PiAxCiAgICAgIGJyZWFrCiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgcmV0ID0gdXRmOFRvQnl0ZXMoc3RyKS5sZW5ndGgKICAgICAgYnJlYWsKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIHJldCA9IGJhc2U2NFRvQnl0ZXMoc3RyKS5sZW5ndGgKICAgICAgYnJlYWsKICAgIGRlZmF1bHQ6CiAgICAgIHJldCA9IHN0ci5sZW5ndGgKICB9CiAgcmV0dXJuIHJldAp9CgovLyBwcmUtc2V0IGZvciB2YWx1ZXMgdGhhdCBtYXkgZXhpc3QgaW4gdGhlIGZ1dHVyZQpCdWZmZXIucHJvdG90eXBlLmxlbmd0aCA9IHVuZGVmaW5lZApCdWZmZXIucHJvdG90eXBlLnBhcmVudCA9IHVuZGVmaW5lZAoKLy8gdG9TdHJpbmcoZW5jb2RpbmcsIHN0YXJ0PTAsIGVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24gKGVuY29kaW5nLCBzdGFydCwgZW5kKSB7CiAgdmFyIGxvd2VyZWRDYXNlID0gZmFsc2UKCiAgc3RhcnQgPSBzdGFydCA+Pj4gMAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkIHx8IGVuZCA9PT0gSW5maW5pdHkgPyB0aGlzLmxlbmd0aCA6IGVuZCA+Pj4gMAoKICBpZiAoIWVuY29kaW5nKSBlbmNvZGluZyA9ICd1dGY4JwogIGlmIChzdGFydCA8IDApIHN0YXJ0ID0gMAogIGlmIChlbmQgPiB0aGlzLmxlbmd0aCkgZW5kID0gdGhpcy5sZW5ndGgKICBpZiAoZW5kIDw9IHN0YXJ0KSByZXR1cm4gJycKCiAgd2hpbGUgKHRydWUpIHsKICAgIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgICAgY2FzZSAnaGV4JzoKICAgICAgICByZXR1cm4gaGV4U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3V0ZjgnOgogICAgICBjYXNlICd1dGYtOCc6CiAgICAgICAgcmV0dXJuIHV0ZjhTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYXNjaWknOgogICAgICAgIHJldHVybiBhc2NpaVNsaWNlKHRoaXMsIHN0YXJ0LCBlbmQpCgogICAgICBjYXNlICdiaW5hcnknOgogICAgICAgIHJldHVybiBiaW5hcnlTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgY2FzZSAnYmFzZTY0JzoKICAgICAgICByZXR1cm4gYmFzZTY0U2xpY2UodGhpcywgc3RhcnQsIGVuZCkKCiAgICAgIGNhc2UgJ3VjczInOgogICAgICBjYXNlICd1Y3MtMic6CiAgICAgIGNhc2UgJ3V0ZjE2bGUnOgogICAgICBjYXNlICd1dGYtMTZsZSc6CiAgICAgICAgcmV0dXJuIHV0ZjE2bGVTbGljZSh0aGlzLCBzdGFydCwgZW5kKQoKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAobG93ZXJlZENhc2UpCiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgICAgICAgZW5jb2RpbmcgPSAoZW5jb2RpbmcgKyAnJykudG9Mb3dlckNhc2UoKQogICAgICAgIGxvd2VyZWRDYXNlID0gdHJ1ZQogICAgfQogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS5lcXVhbHMgPSBmdW5jdGlvbiAoYikgewogIGlmKCFCdWZmZXIuaXNCdWZmZXIoYikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ0FyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXInKQogIHJldHVybiBCdWZmZXIuY29tcGFyZSh0aGlzLCBiKSA9PT0gMAp9CgpCdWZmZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIHN0ciA9ICcnCiAgdmFyIG1heCA9IGV4cG9ydHMuSU5TUEVDVF9NQVhfQllURVMKICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICBzdHIgPSB0aGlzLnRvU3RyaW5nKCdoZXgnLCAwLCBtYXgpLm1hdGNoKC8uezJ9L2cpLmpvaW4oJyAnKQogICAgaWYgKHRoaXMubGVuZ3RoID4gbWF4KQogICAgICBzdHIgKz0gJyAuLi4gJwogIH0KICByZXR1cm4gJzxCdWZmZXIgJyArIHN0ciArICc+Jwp9CgpCdWZmZXIucHJvdG90eXBlLmNvbXBhcmUgPSBmdW5jdGlvbiAoYikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGIpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudCBtdXN0IGJlIGEgQnVmZmVyJykKICByZXR1cm4gQnVmZmVyLmNvbXBhcmUodGhpcywgYikKfQoKLy8gYGdldGAgd2lsbCBiZSByZW1vdmVkIGluIE5vZGUgMC4xMysKQnVmZmVyLnByb3RvdHlwZS5nZXQgPSBmdW5jdGlvbiAob2Zmc2V0KSB7CiAgY29uc29sZS5sb2coJy5nZXQoKSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdXNpbmcgYXJyYXkgaW5kZXhlcyBpbnN0ZWFkLicpCiAgcmV0dXJuIHRoaXMucmVhZFVJbnQ4KG9mZnNldCkKfQoKLy8gYHNldGAgd2lsbCBiZSByZW1vdmVkIGluIE5vZGUgMC4xMysKQnVmZmVyLnByb3RvdHlwZS5zZXQgPSBmdW5jdGlvbiAodiwgb2Zmc2V0KSB7CiAgY29uc29sZS5sb2coJy5zZXQoKSBpcyBkZXByZWNhdGVkLiBBY2Nlc3MgdXNpbmcgYXJyYXkgaW5kZXhlcyBpbnN0ZWFkLicpCiAgcmV0dXJuIHRoaXMud3JpdGVVSW50OCh2LCBvZmZzZXQpCn0KCmZ1bmN0aW9uIGhleFdyaXRlIChidWYsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpIHsKICBvZmZzZXQgPSBOdW1iZXIob2Zmc2V0KSB8fCAwCiAgdmFyIHJlbWFpbmluZyA9IGJ1Zi5sZW5ndGggLSBvZmZzZXQKICBpZiAoIWxlbmd0aCkgewogICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgfSBlbHNlIHsKICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfQogIH0KCiAgLy8gbXVzdCBiZSBhbiBldmVuIG51bWJlciBvZiBkaWdpdHMKICB2YXIgc3RyTGVuID0gc3RyaW5nLmxlbmd0aAogIGlmIChzdHJMZW4gJSAyICE9PSAwKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCgogIGlmIChsZW5ndGggPiBzdHJMZW4gLyAyKSB7CiAgICBsZW5ndGggPSBzdHJMZW4gLyAyCiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIHZhciBieXRlID0gcGFyc2VJbnQoc3RyaW5nLnN1YnN0cihpICogMiwgMiksIDE2KQogICAgaWYgKGlzTmFOKGJ5dGUpKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaGV4IHN0cmluZycpCiAgICBidWZbb2Zmc2V0ICsgaV0gPSBieXRlCiAgfQogIHJldHVybiBpCn0KCmZ1bmN0aW9uIHV0ZjhXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgdmFyIGNoYXJzV3JpdHRlbiA9IGJsaXRCdWZmZXIodXRmOFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCmZ1bmN0aW9uIGFzY2lpV3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHZhciBjaGFyc1dyaXR0ZW4gPSBibGl0QnVmZmVyKGFzY2lpVG9CeXRlcyhzdHJpbmcpLCBidWYsIG9mZnNldCwgbGVuZ3RoKQogIHJldHVybiBjaGFyc1dyaXR0ZW4KfQoKZnVuY3Rpb24gYmluYXJ5V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHJldHVybiBhc2NpaVdyaXRlKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKfQoKZnVuY3Rpb24gYmFzZTY0V3JpdGUgKGJ1Ziwgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkgewogIHZhciBjaGFyc1dyaXR0ZW4gPSBibGl0QnVmZmVyKGJhc2U2NFRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCmZ1bmN0aW9uIHV0ZjE2bGVXcml0ZSAoYnVmLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKSB7CiAgdmFyIGNoYXJzV3JpdHRlbiA9IGJsaXRCdWZmZXIodXRmMTZsZVRvQnl0ZXMoc3RyaW5nKSwgYnVmLCBvZmZzZXQsIGxlbmd0aCkKICByZXR1cm4gY2hhcnNXcml0dGVuCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbiAoc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCwgZW5jb2RpbmcpIHsKICAvLyBTdXBwb3J0IGJvdGggKHN0cmluZywgb2Zmc2V0LCBsZW5ndGgsIGVuY29kaW5nKQogIC8vIGFuZCB0aGUgbGVnYWN5IChzdHJpbmcsIGVuY29kaW5nLCBvZmZzZXQsIGxlbmd0aCkKICBpZiAoaXNGaW5pdGUob2Zmc2V0KSkgewogICAgaWYgKCFpc0Zpbml0ZShsZW5ndGgpKSB7CiAgICAgIGVuY29kaW5nID0gbGVuZ3RoCiAgICAgIGxlbmd0aCA9IHVuZGVmaW5lZAogICAgfQogIH0gZWxzZSB7ICAvLyBsZWdhY3kKICAgIHZhciBzd2FwID0gZW5jb2RpbmcKICAgIGVuY29kaW5nID0gb2Zmc2V0CiAgICBvZmZzZXQgPSBsZW5ndGgKICAgIGxlbmd0aCA9IHN3YXAKICB9CgogIG9mZnNldCA9IE51bWJlcihvZmZzZXQpIHx8IDAKICB2YXIgcmVtYWluaW5nID0gdGhpcy5sZW5ndGggLSBvZmZzZXQKICBpZiAoIWxlbmd0aCkgewogICAgbGVuZ3RoID0gcmVtYWluaW5nCiAgfSBlbHNlIHsKICAgIGxlbmd0aCA9IE51bWJlcihsZW5ndGgpCiAgICBpZiAobGVuZ3RoID4gcmVtYWluaW5nKSB7CiAgICAgIGxlbmd0aCA9IHJlbWFpbmluZwogICAgfQogIH0KICBlbmNvZGluZyA9IFN0cmluZyhlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCkKCiAgdmFyIHJldAogIHN3aXRjaCAoZW5jb2RpbmcpIHsKICAgIGNhc2UgJ2hleCc6CiAgICAgIHJldCA9IGhleFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICd1dGY4JzoKICAgIGNhc2UgJ3V0Zi04JzoKICAgICAgcmV0ID0gdXRmOFdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICdhc2NpaSc6CiAgICAgIHJldCA9IGFzY2lpV3JpdGUodGhpcywgc3RyaW5nLCBvZmZzZXQsIGxlbmd0aCkKICAgICAgYnJlYWsKICAgIGNhc2UgJ2JpbmFyeSc6CiAgICAgIHJldCA9IGJpbmFyeVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBjYXNlICdiYXNlNjQnOgogICAgICByZXQgPSBiYXNlNjRXcml0ZSh0aGlzLCBzdHJpbmcsIG9mZnNldCwgbGVuZ3RoKQogICAgICBicmVhawogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1Y3MtMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgIGNhc2UgJ3V0Zi0xNmxlJzoKICAgICAgcmV0ID0gdXRmMTZsZVdyaXRlKHRoaXMsIHN0cmluZywgb2Zmc2V0LCBsZW5ndGgpCiAgICAgIGJyZWFrCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdVbmtub3duIGVuY29kaW5nOiAnICsgZW5jb2RpbmcpCiAgfQogIHJldHVybiByZXQKfQoKQnVmZmVyLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHsKICAgIHR5cGU6ICdCdWZmZXInLAogICAgZGF0YTogQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5fYXJyIHx8IHRoaXMsIDApCiAgfQp9CgpmdW5jdGlvbiBiYXNlNjRTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgaWYgKHN0YXJ0ID09PSAwICYmIGVuZCA9PT0gYnVmLmxlbmd0aCkgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1ZikKICB9IGVsc2UgewogICAgcmV0dXJuIGJhc2U2NC5mcm9tQnl0ZUFycmF5KGJ1Zi5zbGljZShzdGFydCwgZW5kKSkKICB9Cn0KCmZ1bmN0aW9uIHV0ZjhTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJlcyA9ICcnCiAgdmFyIHRtcCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgaWYgKGJ1ZltpXSA8PSAweDdGKSB7CiAgICAgIHJlcyArPSBkZWNvZGVVdGY4Q2hhcih0bXApICsgU3RyaW5nLmZyb21DaGFyQ29kZShidWZbaV0pCiAgICAgIHRtcCA9ICcnCiAgICB9IGVsc2UgewogICAgICB0bXAgKz0gJyUnICsgYnVmW2ldLnRvU3RyaW5nKDE2KQogICAgfQogIH0KCiAgcmV0dXJuIHJlcyArIGRlY29kZVV0ZjhDaGFyKHRtcCkKfQoKZnVuY3Rpb24gYXNjaWlTbGljZSAoYnVmLCBzdGFydCwgZW5kKSB7CiAgdmFyIHJldCA9ICcnCiAgZW5kID0gTWF0aC5taW4oYnVmLmxlbmd0aCwgZW5kKQoKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgcmV0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYnVmW2ldKQogIH0KICByZXR1cm4gcmV0Cn0KCmZ1bmN0aW9uIGJpbmFyeVNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICByZXR1cm4gYXNjaWlTbGljZShidWYsIHN0YXJ0LCBlbmQpCn0KCmZ1bmN0aW9uIGhleFNsaWNlIChidWYsIHN0YXJ0LCBlbmQpIHsKICB2YXIgbGVuID0gYnVmLmxlbmd0aAoKICBpZiAoIXN0YXJ0IHx8IHN0YXJ0IDwgMCkgc3RhcnQgPSAwCiAgaWYgKCFlbmQgfHwgZW5kIDwgMCB8fCBlbmQgPiBsZW4pIGVuZCA9IGxlbgoKICB2YXIgb3V0ID0gJycKICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgb3V0ICs9IHRvSGV4KGJ1ZltpXSkKICB9CiAgcmV0dXJuIG91dAp9CgpmdW5jdGlvbiB1dGYxNmxlU2xpY2UgKGJ1Ziwgc3RhcnQsIGVuZCkgewogIHZhciBieXRlcyA9IGJ1Zi5zbGljZShzdGFydCwgZW5kKQogIHZhciByZXMgPSAnJwogIGZvciAodmFyIGkgPSAwOyBpIDwgYnl0ZXMubGVuZ3RoOyBpICs9IDIpIHsKICAgIHJlcyArPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGJ5dGVzW2ldICsgYnl0ZXNbaSArIDFdICogMjU2KQogIH0KICByZXR1cm4gcmVzCn0KCkJ1ZmZlci5wcm90b3R5cGUuc2xpY2UgPSBmdW5jdGlvbiAoc3RhcnQsIGVuZCkgewogIHZhciBsZW4gPSB0aGlzLmxlbmd0aAogIHN0YXJ0ID0gfn5zdGFydAogIGVuZCA9IGVuZCA9PT0gdW5kZWZpbmVkID8gbGVuIDogfn5lbmQKCiAgaWYgKHN0YXJ0IDwgMCkgewogICAgc3RhcnQgKz0gbGVuOwogICAgaWYgKHN0YXJ0IDwgMCkKICAgICAgc3RhcnQgPSAwCiAgfSBlbHNlIGlmIChzdGFydCA+IGxlbikgewogICAgc3RhcnQgPSBsZW4KICB9CgogIGlmIChlbmQgPCAwKSB7CiAgICBlbmQgKz0gbGVuCiAgICBpZiAoZW5kIDwgMCkKICAgICAgZW5kID0gMAogIH0gZWxzZSBpZiAoZW5kID4gbGVuKSB7CiAgICBlbmQgPSBsZW4KICB9CgogIGlmIChlbmQgPCBzdGFydCkKICAgIGVuZCA9IHN0YXJ0CgogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgcmV0dXJuIEJ1ZmZlci5fYXVnbWVudCh0aGlzLnN1YmFycmF5KHN0YXJ0LCBlbmQpKQogIH0gZWxzZSB7CiAgICB2YXIgc2xpY2VMZW4gPSBlbmQgLSBzdGFydAogICAgdmFyIG5ld0J1ZiA9IG5ldyBCdWZmZXIoc2xpY2VMZW4sIHVuZGVmaW5lZCwgdHJ1ZSkKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpY2VMZW47IGkrKykgewogICAgICBuZXdCdWZbaV0gPSB0aGlzW2kgKyBzdGFydF0KICAgIH0KICAgIHJldHVybiBuZXdCdWYKICB9Cn0KCi8qCiAqIE5lZWQgdG8gbWFrZSBzdXJlIHRoYXQgYnVmZmVyIGlzbid0IHRyeWluZyB0byB3cml0ZSBvdXQgb2YgYm91bmRzLgogKi8KZnVuY3Rpb24gY2hlY2tPZmZzZXQgKG9mZnNldCwgZXh0LCBsZW5ndGgpIHsKICBpZiAoKG9mZnNldCAlIDEpICE9PSAwIHx8IG9mZnNldCA8IDApCiAgICB0aHJvdyBuZXcgUmFuZ2VFcnJvcignb2Zmc2V0IGlzIG5vdCB1aW50JykKICBpZiAob2Zmc2V0ICsgZXh0ID4gbGVuZ3RoKQogICAgdGhyb3cgbmV3IFJhbmdlRXJyb3IoJ1RyeWluZyB0byBhY2Nlc3MgYmV5b25kIGJ1ZmZlciBsZW5ndGgnKQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50OCA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRVSW50MTZMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQxNkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSA8PCA4KSB8IHRoaXNbb2Zmc2V0ICsgMV0KfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkVUludDMyTEUgPSBmdW5jdGlvbiAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKCh0aGlzW29mZnNldF0pIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAyXSA8PCAxNikpICsKICAgICAgKHRoaXNbb2Zmc2V0ICsgM10gKiAweDEwMDAwMDApCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZFVJbnQzMkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gKiAweDEwMDAwMDApICsKICAgICAgKCh0aGlzW29mZnNldCArIDFdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDgpIHwKICAgICAgdGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50OCA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMSwgdGhpcy5sZW5ndGgpCiAgaWYgKCEodGhpc1tvZmZzZXRdICYgMHg4MCkpCiAgICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkKICByZXR1cm4gKCgweGZmIC0gdGhpc1tvZmZzZXRdICsgMSkgKiAtMSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkSW50MTZMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgMiwgdGhpcy5sZW5ndGgpCiAgdmFyIHZhbCA9IHRoaXNbb2Zmc2V0XSB8ICh0aGlzW29mZnNldCArIDFdIDw8IDgpCiAgcmV0dXJuICh2YWwgJiAweDgwMDApID8gdmFsIHwgMHhGRkZGMDAwMCA6IHZhbAp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQxNkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCAyLCB0aGlzLmxlbmd0aCkKICB2YXIgdmFsID0gdGhpc1tvZmZzZXQgKyAxXSB8ICh0aGlzW29mZnNldF0gPDwgOCkKICByZXR1cm4gKHZhbCAmIDB4ODAwMCkgPyB2YWwgfCAweEZGRkYwMDAwIDogdmFsCn0KCkJ1ZmZlci5wcm90b3R5cGUucmVhZEludDMyTEUgPSBmdW5jdGlvbiAob2Zmc2V0LCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja09mZnNldChvZmZzZXQsIDQsIHRoaXMubGVuZ3RoKQoKICByZXR1cm4gKHRoaXNbb2Zmc2V0XSkgfAogICAgICAodGhpc1tvZmZzZXQgKyAxXSA8PCA4KSB8CiAgICAgICh0aGlzW29mZnNldCArIDJdIDw8IDE2KSB8CiAgICAgICh0aGlzW29mZnNldCArIDNdIDw8IDI0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRJbnQzMkJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKCiAgcmV0dXJuICh0aGlzW29mZnNldF0gPDwgMjQpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMV0gPDwgMTYpIHwKICAgICAgKHRoaXNbb2Zmc2V0ICsgMl0gPDwgOCkgfAogICAgICAodGhpc1tvZmZzZXQgKyAzXSkKfQoKQnVmZmVyLnByb3RvdHlwZS5yZWFkRmxvYXRMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgNCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWRGbG9hdEJFID0gZnVuY3Rpb24gKG9mZnNldCwgbm9Bc3NlcnQpIHsKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tPZmZzZXQob2Zmc2V0LCA0LCB0aGlzLmxlbmd0aCkKICByZXR1cm4gaWVlZTc1NC5yZWFkKHRoaXMsIG9mZnNldCwgZmFsc2UsIDIzLCA0KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVMRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIHRydWUsIDUyLCA4KQp9CgpCdWZmZXIucHJvdG90eXBlLnJlYWREb3VibGVCRSA9IGZ1bmN0aW9uIChvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrT2Zmc2V0KG9mZnNldCwgOCwgdGhpcy5sZW5ndGgpCiAgcmV0dXJuIGllZWU3NTQucmVhZCh0aGlzLCBvZmZzZXQsIGZhbHNlLCA1MiwgOCkKfQoKZnVuY3Rpb24gY2hlY2tJbnQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmICghQnVmZmVyLmlzQnVmZmVyKGJ1ZikpIHRocm93IG5ldyBUeXBlRXJyb3IoJ2J1ZmZlciBtdXN0IGJlIGEgQnVmZmVyIGluc3RhbmNlJykKICBpZiAodmFsdWUgPiBtYXggfHwgdmFsdWUgPCBtaW4pIHRocm93IG5ldyBUeXBlRXJyb3IoJ3ZhbHVlIGlzIG91dCBvZiBib3VuZHMnKQogIGlmIChvZmZzZXQgKyBleHQgPiBidWYubGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdpbmRleCBvdXQgb2YgcmFuZ2UnKQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDggPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAxLCAweGZmLCAwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICB0aGlzW29mZnNldF0gPSB2YWx1ZQogIHJldHVybiBvZmZzZXQgKyAxCn0KCmZ1bmN0aW9uIG9iamVjdFdyaXRlVUludDE2IChidWYsIHZhbHVlLCBvZmZzZXQsIGxpdHRsZUVuZGlhbikgewogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCAyKTsgaSA8IGo7IGkrKykgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlICYgKDB4ZmYgPDwgKDggKiAobGl0dGxlRW5kaWFuID8gaSA6IDEgLSBpKSkpKSA+Pj4KICAgICAgKGxpdHRsZUVuZGlhbiA/IGkgOiAxIC0gaSkgKiA4CiAgfQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2TEUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSB2YWx1ZQogICAgdGhpc1tvZmZzZXQgKyAxXSA9ICh2YWx1ZSA+Pj4gOCkKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgMgp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDE2QkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweGZmZmYsIDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKZnVuY3Rpb24gb2JqZWN0V3JpdGVVSW50MzIgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuKSB7CiAgaWYgKHZhbHVlIDwgMCkgdmFsdWUgPSAweGZmZmZmZmZmICsgdmFsdWUgKyAxCiAgZm9yICh2YXIgaSA9IDAsIGogPSBNYXRoLm1pbihidWYubGVuZ3RoIC0gb2Zmc2V0LCA0KTsgaSA8IGo7IGkrKykgewogICAgYnVmW29mZnNldCArIGldID0gKHZhbHVlID4+PiAobGl0dGxlRW5kaWFuID8gaSA6IDMgLSBpKSAqIDgpICYgMHhmZgogIH0KfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZVVJbnQzMkxFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgPj4+IDAKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgNCwgMHhmZmZmZmZmZiwgMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSAodmFsdWUgPj4+IDI0KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlVUludDMyQkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweGZmZmZmZmZmLCAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZQogIH0gZWxzZSBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50OCA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwCiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDEsIDB4N2YsIC0weDgwKQogIGlmICghQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHZhbHVlID0gTWF0aC5mbG9vcih2YWx1ZSkKICBpZiAodmFsdWUgPCAwKSB2YWx1ZSA9IDB4ZmYgKyB2YWx1ZSArIDEKICB0aGlzW29mZnNldF0gPSB2YWx1ZQogIHJldHVybiBvZmZzZXQgKyAxCn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVJbnQxNkxFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgdmFsdWUgPSArdmFsdWUKICBvZmZzZXQgPSBvZmZzZXQgPj4+IDAKICBpZiAoIW5vQXNzZXJ0KQogICAgY2hlY2tJbnQodGhpcywgdmFsdWUsIG9mZnNldCwgMiwgMHg3ZmZmLCAtMHg4MDAwKQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gdmFsdWUKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDgpCiAgfSBlbHNlIG9iamVjdFdyaXRlVUludDE2KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDE2QkUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCAyLCAweDdmZmYsIC0weDgwMDApCiAgaWYgKEJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICB0aGlzW29mZnNldF0gPSAodmFsdWUgPj4+IDgpCiAgICB0aGlzW29mZnNldCArIDFdID0gdmFsdWUKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MTYodGhpcywgdmFsdWUsIG9mZnNldCwgZmFsc2UpCiAgcmV0dXJuIG9mZnNldCArIDIKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZUludDMyTEUgPSBmdW5jdGlvbiAodmFsdWUsIG9mZnNldCwgbm9Bc3NlcnQpIHsKICB2YWx1ZSA9ICt2YWx1ZQogIG9mZnNldCA9IG9mZnNldCA+Pj4gMAogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0ludCh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCA0LCAweDdmZmZmZmZmLCAtMHg4MDAwMDAwMCkKICBpZiAoQnVmZmVyLlRZUEVEX0FSUkFZX1NVUFBPUlQpIHsKICAgIHRoaXNbb2Zmc2V0XSA9IHZhbHVlCiAgICB0aGlzW29mZnNldCArIDFdID0gKHZhbHVlID4+PiA4KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gMTYpCiAgICB0aGlzW29mZnNldCArIDNdID0gKHZhbHVlID4+PiAyNCkKICB9IGVsc2Ugb2JqZWN0V3JpdGVVSW50MzIodGhpcywgdmFsdWUsIG9mZnNldCwgdHJ1ZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlSW50MzJCRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHZhbHVlID0gK3ZhbHVlCiAgb2Zmc2V0ID0gb2Zmc2V0ID4+PiAwCiAgaWYgKCFub0Fzc2VydCkKICAgIGNoZWNrSW50KHRoaXMsIHZhbHVlLCBvZmZzZXQsIDQsIDB4N2ZmZmZmZmYsIC0weDgwMDAwMDAwKQogIGlmICh2YWx1ZSA8IDApIHZhbHVlID0gMHhmZmZmZmZmZiArIHZhbHVlICsgMQogIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgdGhpc1tvZmZzZXRdID0gKHZhbHVlID4+PiAyNCkKICAgIHRoaXNbb2Zmc2V0ICsgMV0gPSAodmFsdWUgPj4+IDE2KQogICAgdGhpc1tvZmZzZXQgKyAyXSA9ICh2YWx1ZSA+Pj4gOCkKICAgIHRoaXNbb2Zmc2V0ICsgM10gPSB2YWx1ZQogIH0gZWxzZSBvYmplY3RXcml0ZVVJbnQzMih0aGlzLCB2YWx1ZSwgb2Zmc2V0LCBmYWxzZSkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpmdW5jdGlvbiBjaGVja0lFRUU3NTQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgZXh0LCBtYXgsIG1pbikgewogIGlmICh2YWx1ZSA+IG1heCB8fCB2YWx1ZSA8IG1pbikgdGhyb3cgbmV3IFR5cGVFcnJvcigndmFsdWUgaXMgb3V0IG9mIGJvdW5kcycpCiAgaWYgKG9mZnNldCArIGV4dCA+IGJ1Zi5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ2luZGV4IG91dCBvZiByYW5nZScpCn0KCmZ1bmN0aW9uIHdyaXRlRmxvYXQgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA0LCAzLjQwMjgyMzQ2NjM4NTI4ODZlKzM4LCAtMy40MDI4MjM0NjYzODUyODg2ZSszOCkKICBpZWVlNzU0LndyaXRlKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCAyMywgNCkKICByZXR1cm4gb2Zmc2V0ICsgNAp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRMRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIHRydWUsIG5vQXNzZXJ0KQp9CgpCdWZmZXIucHJvdG90eXBlLndyaXRlRmxvYXRCRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZUZsb2F0KHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKZnVuY3Rpb24gd3JpdGVEb3VibGUgKGJ1ZiwgdmFsdWUsIG9mZnNldCwgbGl0dGxlRW5kaWFuLCBub0Fzc2VydCkgewogIGlmICghbm9Bc3NlcnQpCiAgICBjaGVja0lFRUU3NTQoYnVmLCB2YWx1ZSwgb2Zmc2V0LCA4LCAxLjc5NzY5MzEzNDg2MjMxNTdFKzMwOCwgLTEuNzk3NjkzMTM0ODYyMzE1N0UrMzA4KQogIGllZWU3NTQud3JpdGUoYnVmLCB2YWx1ZSwgb2Zmc2V0LCBsaXR0bGVFbmRpYW4sIDUyLCA4KQogIHJldHVybiBvZmZzZXQgKyA4Cn0KCkJ1ZmZlci5wcm90b3R5cGUud3JpdGVEb3VibGVMRSA9IGZ1bmN0aW9uICh2YWx1ZSwgb2Zmc2V0LCBub0Fzc2VydCkgewogIHJldHVybiB3cml0ZURvdWJsZSh0aGlzLCB2YWx1ZSwgb2Zmc2V0LCB0cnVlLCBub0Fzc2VydCkKfQoKQnVmZmVyLnByb3RvdHlwZS53cml0ZURvdWJsZUJFID0gZnVuY3Rpb24gKHZhbHVlLCBvZmZzZXQsIG5vQXNzZXJ0KSB7CiAgcmV0dXJuIHdyaXRlRG91YmxlKHRoaXMsIHZhbHVlLCBvZmZzZXQsIGZhbHNlLCBub0Fzc2VydCkKfQoKLy8gY29weSh0YXJnZXRCdWZmZXIsIHRhcmdldFN0YXJ0PTAsIHNvdXJjZVN0YXJ0PTAsIHNvdXJjZUVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLmNvcHkgPSBmdW5jdGlvbiAodGFyZ2V0LCB0YXJnZXRfc3RhcnQsIHN0YXJ0LCBlbmQpIHsKICB2YXIgc291cmNlID0gdGhpcwoKICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICBpZiAoIWVuZCAmJiBlbmQgIT09IDApIGVuZCA9IHRoaXMubGVuZ3RoCiAgaWYgKCF0YXJnZXRfc3RhcnQpIHRhcmdldF9zdGFydCA9IDAKCiAgLy8gQ29weSAwIGJ5dGVzOyB3ZSdyZSBkb25lCiAgaWYgKGVuZCA9PT0gc3RhcnQpIHJldHVybgogIGlmICh0YXJnZXQubGVuZ3RoID09PSAwIHx8IHNvdXJjZS5sZW5ndGggPT09IDApIHJldHVybgoKICAvLyBGYXRhbCBlcnJvciBjb25kaXRpb25zCiAgaWYgKGVuZCA8IHN0YXJ0KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzb3VyY2VFbmQgPCBzb3VyY2VTdGFydCcpCiAgaWYgKHRhcmdldF9zdGFydCA8IDAgfHwgdGFyZ2V0X3N0YXJ0ID49IHRhcmdldC5sZW5ndGgpCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd0YXJnZXRTdGFydCBvdXQgb2YgYm91bmRzJykKICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHNvdXJjZS5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3NvdXJjZVN0YXJ0IG91dCBvZiBib3VuZHMnKQogIGlmIChlbmQgPCAwIHx8IGVuZCA+IHNvdXJjZS5sZW5ndGgpIHRocm93IG5ldyBUeXBlRXJyb3IoJ3NvdXJjZUVuZCBvdXQgb2YgYm91bmRzJykKCiAgLy8gQXJlIHdlIG9vYj8KICBpZiAoZW5kID4gdGhpcy5sZW5ndGgpCiAgICBlbmQgPSB0aGlzLmxlbmd0aAogIGlmICh0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0X3N0YXJ0IDwgZW5kIC0gc3RhcnQpCiAgICBlbmQgPSB0YXJnZXQubGVuZ3RoIC0gdGFyZ2V0X3N0YXJ0ICsgc3RhcnQKCiAgdmFyIGxlbiA9IGVuZCAtIHN0YXJ0CgogIGlmIChsZW4gPCAxMDAgfHwgIUJ1ZmZlci5UWVBFRF9BUlJBWV9TVVBQT1JUKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHRhcmdldFtpICsgdGFyZ2V0X3N0YXJ0XSA9IHRoaXNbaSArIHN0YXJ0XQogICAgfQogIH0gZWxzZSB7CiAgICB0YXJnZXQuX3NldCh0aGlzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIGxlbiksIHRhcmdldF9zdGFydCkKICB9Cn0KCi8vIGZpbGwodmFsdWUsIHN0YXJ0PTAsIGVuZD1idWZmZXIubGVuZ3RoKQpCdWZmZXIucHJvdG90eXBlLmZpbGwgPSBmdW5jdGlvbiAodmFsdWUsIHN0YXJ0LCBlbmQpIHsKICBpZiAoIXZhbHVlKSB2YWx1ZSA9IDAKICBpZiAoIXN0YXJ0KSBzdGFydCA9IDAKICBpZiAoIWVuZCkgZW5kID0gdGhpcy5sZW5ndGgKCiAgaWYgKGVuZCA8IHN0YXJ0KSB0aHJvdyBuZXcgVHlwZUVycm9yKCdlbmQgPCBzdGFydCcpCgogIC8vIEZpbGwgMCBieXRlczsgd2UncmUgZG9uZQogIGlmIChlbmQgPT09IHN0YXJ0KSByZXR1cm4KICBpZiAodGhpcy5sZW5ndGggPT09IDApIHJldHVybgoKICBpZiAoc3RhcnQgPCAwIHx8IHN0YXJ0ID49IHRoaXMubGVuZ3RoKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdzdGFydCBvdXQgb2YgYm91bmRzJykKICBpZiAoZW5kIDwgMCB8fCBlbmQgPiB0aGlzLmxlbmd0aCkgdGhyb3cgbmV3IFR5cGVFcnJvcignZW5kIG91dCBvZiBib3VuZHMnKQoKICB2YXIgaQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7CiAgICBmb3IgKGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7CiAgICAgIHRoaXNbaV0gPSB2YWx1ZQogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgYnl0ZXMgPSB1dGY4VG9CeXRlcyh2YWx1ZS50b1N0cmluZygpKQogICAgdmFyIGxlbiA9IGJ5dGVzLmxlbmd0aAogICAgZm9yIChpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICB0aGlzW2ldID0gYnl0ZXNbaSAlIGxlbl0KICAgIH0KICB9CgogIHJldHVybiB0aGlzCn0KCi8qKgogKiBDcmVhdGVzIGEgbmV3IGBBcnJheUJ1ZmZlcmAgd2l0aCB0aGUgKmNvcGllZCogbWVtb3J5IG9mIHRoZSBidWZmZXIgaW5zdGFuY2UuCiAqIEFkZGVkIGluIE5vZGUgMC4xMi4gT25seSBhdmFpbGFibGUgaW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IEFycmF5QnVmZmVyLgogKi8KQnVmZmVyLnByb3RvdHlwZS50b0FycmF5QnVmZmVyID0gZnVuY3Rpb24gKCkgewogIGlmICh0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIGlmIChCdWZmZXIuVFlQRURfQVJSQVlfU1VQUE9SVCkgewogICAgICByZXR1cm4gKG5ldyBCdWZmZXIodGhpcykpLmJ1ZmZlcgogICAgfSBlbHNlIHsKICAgICAgdmFyIGJ1ZiA9IG5ldyBVaW50OEFycmF5KHRoaXMubGVuZ3RoKQogICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gYnVmLmxlbmd0aDsgaSA8IGxlbjsgaSArPSAxKSB7CiAgICAgICAgYnVmW2ldID0gdGhpc1tpXQogICAgICB9CiAgICAgIHJldHVybiBidWYuYnVmZmVyCiAgICB9CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0J1ZmZlci50b0FycmF5QnVmZmVyIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyJykKICB9Cn0KCi8vIEhFTFBFUiBGVU5DVElPTlMKLy8gPT09PT09PT09PT09PT09PQoKdmFyIEJQID0gQnVmZmVyLnByb3RvdHlwZQoKLyoqCiAqIEF1Z21lbnQgYSBVaW50OEFycmF5ICppbnN0YW5jZSogKG5vdCB0aGUgVWludDhBcnJheSBjbGFzcyEpIHdpdGggQnVmZmVyIG1ldGhvZHMKICovCkJ1ZmZlci5fYXVnbWVudCA9IGZ1bmN0aW9uIChhcnIpIHsKICBhcnIuX2lzQnVmZmVyID0gdHJ1ZQoKICAvLyBzYXZlIHJlZmVyZW5jZSB0byBvcmlnaW5hbCBVaW50OEFycmF5IGdldC9zZXQgbWV0aG9kcyBiZWZvcmUgb3ZlcndyaXRpbmcKICBhcnIuX2dldCA9IGFyci5nZXQKICBhcnIuX3NldCA9IGFyci5zZXQKCiAgLy8gZGVwcmVjYXRlZCwgd2lsbCBiZSByZW1vdmVkIGluIG5vZGUgMC4xMysKICBhcnIuZ2V0ID0gQlAuZ2V0CiAgYXJyLnNldCA9IEJQLnNldAoKICBhcnIud3JpdGUgPSBCUC53cml0ZQogIGFyci50b1N0cmluZyA9IEJQLnRvU3RyaW5nCiAgYXJyLnRvTG9jYWxlU3RyaW5nID0gQlAudG9TdHJpbmcKICBhcnIudG9KU09OID0gQlAudG9KU09OCiAgYXJyLmVxdWFscyA9IEJQLmVxdWFscwogIGFyci5jb21wYXJlID0gQlAuY29tcGFyZQogIGFyci5jb3B5ID0gQlAuY29weQogIGFyci5zbGljZSA9IEJQLnNsaWNlCiAgYXJyLnJlYWRVSW50OCA9IEJQLnJlYWRVSW50OAogIGFyci5yZWFkVUludDE2TEUgPSBCUC5yZWFkVUludDE2TEUKICBhcnIucmVhZFVJbnQxNkJFID0gQlAucmVhZFVJbnQxNkJFCiAgYXJyLnJlYWRVSW50MzJMRSA9IEJQLnJlYWRVSW50MzJMRQogIGFyci5yZWFkVUludDMyQkUgPSBCUC5yZWFkVUludDMyQkUKICBhcnIucmVhZEludDggPSBCUC5yZWFkSW50OAogIGFyci5yZWFkSW50MTZMRSA9IEJQLnJlYWRJbnQxNkxFCiAgYXJyLnJlYWRJbnQxNkJFID0gQlAucmVhZEludDE2QkUKICBhcnIucmVhZEludDMyTEUgPSBCUC5yZWFkSW50MzJMRQogIGFyci5yZWFkSW50MzJCRSA9IEJQLnJlYWRJbnQzMkJFCiAgYXJyLnJlYWRGbG9hdExFID0gQlAucmVhZEZsb2F0TEUKICBhcnIucmVhZEZsb2F0QkUgPSBCUC5yZWFkRmxvYXRCRQogIGFyci5yZWFkRG91YmxlTEUgPSBCUC5yZWFkRG91YmxlTEUKICBhcnIucmVhZERvdWJsZUJFID0gQlAucmVhZERvdWJsZUJFCiAgYXJyLndyaXRlVUludDggPSBCUC53cml0ZVVJbnQ4CiAgYXJyLndyaXRlVUludDE2TEUgPSBCUC53cml0ZVVJbnQxNkxFCiAgYXJyLndyaXRlVUludDE2QkUgPSBCUC53cml0ZVVJbnQxNkJFCiAgYXJyLndyaXRlVUludDMyTEUgPSBCUC53cml0ZVVJbnQzMkxFCiAgYXJyLndyaXRlVUludDMyQkUgPSBCUC53cml0ZVVJbnQzMkJFCiAgYXJyLndyaXRlSW50OCA9IEJQLndyaXRlSW50OAogIGFyci53cml0ZUludDE2TEUgPSBCUC53cml0ZUludDE2TEUKICBhcnIud3JpdGVJbnQxNkJFID0gQlAud3JpdGVJbnQxNkJFCiAgYXJyLndyaXRlSW50MzJMRSA9IEJQLndyaXRlSW50MzJMRQogIGFyci53cml0ZUludDMyQkUgPSBCUC53cml0ZUludDMyQkUKICBhcnIud3JpdGVGbG9hdExFID0gQlAud3JpdGVGbG9hdExFCiAgYXJyLndyaXRlRmxvYXRCRSA9IEJQLndyaXRlRmxvYXRCRQogIGFyci53cml0ZURvdWJsZUxFID0gQlAud3JpdGVEb3VibGVMRQogIGFyci53cml0ZURvdWJsZUJFID0gQlAud3JpdGVEb3VibGVCRQogIGFyci5maWxsID0gQlAuZmlsbAogIGFyci5pbnNwZWN0ID0gQlAuaW5zcGVjdAogIGFyci50b0FycmF5QnVmZmVyID0gQlAudG9BcnJheUJ1ZmZlcgoKICByZXR1cm4gYXJyCn0KCnZhciBJTlZBTElEX0JBU0U2NF9SRSA9IC9bXitcLzAtOUEtel0vZwoKZnVuY3Rpb24gYmFzZTY0Y2xlYW4gKHN0cikgewogIC8vIE5vZGUgc3RyaXBzIG91dCBpbnZhbGlkIGNoYXJhY3RlcnMgbGlrZSBcbiBhbmQgXHQgZnJvbSB0aGUgc3RyaW5nLCBiYXNlNjQtanMgZG9lcyBub3QKICBzdHIgPSBzdHJpbmd0cmltKHN0cikucmVwbGFjZShJTlZBTElEX0JBU0U2NF9SRSwgJycpCiAgLy8gTm9kZSBhbGxvd3MgZm9yIG5vbi1wYWRkZWQgYmFzZTY0IHN0cmluZ3MgKG1pc3NpbmcgdHJhaWxpbmcgPT09KSwgYmFzZTY0LWpzIGRvZXMgbm90CiAgd2hpbGUgKHN0ci5sZW5ndGggJSA0ICE9PSAwKSB7CiAgICBzdHIgPSBzdHIgKyAnPScKICB9CiAgcmV0dXJuIHN0cgp9CgpmdW5jdGlvbiBzdHJpbmd0cmltIChzdHIpIHsKICBpZiAoc3RyLnRyaW0pIHJldHVybiBzdHIudHJpbSgpCiAgcmV0dXJuIHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpCn0KCmZ1bmN0aW9uIGlzQXJyYXlpc2ggKHN1YmplY3QpIHsKICByZXR1cm4gaXNBcnJheShzdWJqZWN0KSB8fCBCdWZmZXIuaXNCdWZmZXIoc3ViamVjdCkgfHwKICAgICAgc3ViamVjdCAmJiB0eXBlb2Ygc3ViamVjdCA9PT0gJ29iamVjdCcgJiYKICAgICAgdHlwZW9mIHN1YmplY3QubGVuZ3RoID09PSAnbnVtYmVyJwp9CgpmdW5jdGlvbiB0b0hleCAobikgewogIGlmIChuIDwgMTYpIHJldHVybiAnMCcgKyBuLnRvU3RyaW5nKDE2KQogIHJldHVybiBuLnRvU3RyaW5nKDE2KQp9CgpmdW5jdGlvbiB1dGY4VG9CeXRlcyAoc3RyKSB7CiAgdmFyIGJ5dGVBcnJheSA9IFtdCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgIHZhciBiID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgIGlmIChiIDw9IDB4N0YpIHsKICAgICAgYnl0ZUFycmF5LnB1c2goYikKICAgIH0gZWxzZSB7CiAgICAgIHZhciBzdGFydCA9IGkKICAgICAgaWYgKGIgPj0gMHhEODAwICYmIGIgPD0gMHhERkZGKSBpKysKICAgICAgdmFyIGggPSBlbmNvZGVVUklDb21wb25lbnQoc3RyLnNsaWNlKHN0YXJ0LCBpKzEpKS5zdWJzdHIoMSkuc3BsaXQoJyUnKQogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGgubGVuZ3RoOyBqKyspIHsKICAgICAgICBieXRlQXJyYXkucHVzaChwYXJzZUludChoW2pdLCAxNikpCiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiBhc2NpaVRvQnl0ZXMgKHN0cikgewogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICAvLyBOb2RlJ3MgY29kZSBzZWVtcyB0byBiZSBkb2luZyB0aGlzIGFuZCBub3QgJiAweDdGLi4KICAgIGJ5dGVBcnJheS5wdXNoKHN0ci5jaGFyQ29kZUF0KGkpICYgMHhGRikKICB9CiAgcmV0dXJuIGJ5dGVBcnJheQp9CgpmdW5jdGlvbiB1dGYxNmxlVG9CeXRlcyAoc3RyKSB7CiAgdmFyIGMsIGhpLCBsbwogIHZhciBieXRlQXJyYXkgPSBbXQogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICBjID0gc3RyLmNoYXJDb2RlQXQoaSkKICAgIGhpID0gYyA+PiA4CiAgICBsbyA9IGMgJSAyNTYKICAgIGJ5dGVBcnJheS5wdXNoKGxvKQogICAgYnl0ZUFycmF5LnB1c2goaGkpCiAgfQoKICByZXR1cm4gYnl0ZUFycmF5Cn0KCmZ1bmN0aW9uIGJhc2U2NFRvQnl0ZXMgKHN0cikgewogIHJldHVybiBiYXNlNjQudG9CeXRlQXJyYXkoc3RyKQp9CgpmdW5jdGlvbiBibGl0QnVmZmVyIChzcmMsIGRzdCwgb2Zmc2V0LCBsZW5ndGgpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBpZiAoKGkgKyBvZmZzZXQgPj0gZHN0Lmxlbmd0aCkgfHwgKGkgPj0gc3JjLmxlbmd0aCkpCiAgICAgIGJyZWFrCiAgICBkc3RbaSArIG9mZnNldF0gPSBzcmNbaV0KICB9CiAgcmV0dXJuIGkKfQoKZnVuY3Rpb24gZGVjb2RlVXRmOENoYXIgKHN0cikgewogIHRyeSB7CiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHN0cikKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4RkZGRCkgLy8gVVRGIDggaW52YWxpZCBjaGFyCiAgfQp9Cgp9LHsiYmFzZTY0LWpzIjo1NCwiaWVlZTc1NCI6NTUsImlzLWFycmF5Ijo1Nn1dLDU0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGxvb2t1cCA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OSsvJzsKCjsoZnVuY3Rpb24gKGV4cG9ydHMpIHsKCSd1c2Ugc3RyaWN0JzsKCiAgdmFyIEFyciA9ICh0eXBlb2YgVWludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpCiAgICA/IFVpbnQ4QXJyYXkKICAgIDogQXJyYXkKCgl2YXIgUExVUyAgID0gJysnLmNoYXJDb2RlQXQoMCkKCXZhciBTTEFTSCAgPSAnLycuY2hhckNvZGVBdCgwKQoJdmFyIE5VTUJFUiA9ICcwJy5jaGFyQ29kZUF0KDApCgl2YXIgTE9XRVIgID0gJ2EnLmNoYXJDb2RlQXQoMCkKCXZhciBVUFBFUiAgPSAnQScuY2hhckNvZGVBdCgwKQoKCWZ1bmN0aW9uIGRlY29kZSAoZWx0KSB7CgkJdmFyIGNvZGUgPSBlbHQuY2hhckNvZGVBdCgwKQoJCWlmIChjb2RlID09PSBQTFVTKQoJCQlyZXR1cm4gNjIgLy8gJysnCgkJaWYgKGNvZGUgPT09IFNMQVNIKQoJCQlyZXR1cm4gNjMgLy8gJy8nCgkJaWYgKGNvZGUgPCBOVU1CRVIpCgkJCXJldHVybiAtMSAvL25vIG1hdGNoCgkJaWYgKGNvZGUgPCBOVU1CRVIgKyAxMCkKCQkJcmV0dXJuIGNvZGUgLSBOVU1CRVIgKyAyNiArIDI2CgkJaWYgKGNvZGUgPCBVUFBFUiArIDI2KQoJCQlyZXR1cm4gY29kZSAtIFVQUEVSCgkJaWYgKGNvZGUgPCBMT1dFUiArIDI2KQoJCQlyZXR1cm4gY29kZSAtIExPV0VSICsgMjYKCX0KCglmdW5jdGlvbiBiNjRUb0J5dGVBcnJheSAoYjY0KSB7CgkJdmFyIGksIGosIGwsIHRtcCwgcGxhY2VIb2xkZXJzLCBhcnIKCgkJaWYgKGI2NC5sZW5ndGggJSA0ID4gMCkgewoJCQl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc3RyaW5nLiBMZW5ndGggbXVzdCBiZSBhIG11bHRpcGxlIG9mIDQnKQoJCX0KCgkJLy8gdGhlIG51bWJlciBvZiBlcXVhbCBzaWducyAocGxhY2UgaG9sZGVycykKCQkvLyBpZiB0aGVyZSBhcmUgdHdvIHBsYWNlaG9sZGVycywgdGhhbiB0aGUgdHdvIGNoYXJhY3RlcnMgYmVmb3JlIGl0CgkJLy8gcmVwcmVzZW50IG9uZSBieXRlCgkJLy8gaWYgdGhlcmUgaXMgb25seSBvbmUsIHRoZW4gdGhlIHRocmVlIGNoYXJhY3RlcnMgYmVmb3JlIGl0IHJlcHJlc2VudCAyIGJ5dGVzCgkJLy8gdGhpcyBpcyBqdXN0IGEgY2hlYXAgaGFjayB0byBub3QgZG8gaW5kZXhPZiB0d2ljZQoJCXZhciBsZW4gPSBiNjQubGVuZ3RoCgkJcGxhY2VIb2xkZXJzID0gJz0nID09PSBiNjQuY2hhckF0KGxlbiAtIDIpID8gMiA6ICc9JyA9PT0gYjY0LmNoYXJBdChsZW4gLSAxKSA/IDEgOiAwCgoJCS8vIGJhc2U2NCBpcyA0LzMgKyB1cCB0byB0d28gY2hhcmFjdGVycyBvZiB0aGUgb3JpZ2luYWwgZGF0YQoJCWFyciA9IG5ldyBBcnIoYjY0Lmxlbmd0aCAqIDMgLyA0IC0gcGxhY2VIb2xkZXJzKQoKCQkvLyBpZiB0aGVyZSBhcmUgcGxhY2Vob2xkZXJzLCBvbmx5IGdldCB1cCB0byB0aGUgbGFzdCBjb21wbGV0ZSA0IGNoYXJzCgkJbCA9IHBsYWNlSG9sZGVycyA+IDAgPyBiNjQubGVuZ3RoIC0gNCA6IGI2NC5sZW5ndGgKCgkJdmFyIEwgPSAwCgoJCWZ1bmN0aW9uIHB1c2ggKHYpIHsKCQkJYXJyW0wrK10gPSB2CgkJfQoKCQlmb3IgKGkgPSAwLCBqID0gMDsgaSA8IGw7IGkgKz0gNCwgaiArPSAzKSB7CgkJCXRtcCA9IChkZWNvZGUoYjY0LmNoYXJBdChpKSkgPDwgMTgpIHwgKGRlY29kZShiNjQuY2hhckF0KGkgKyAxKSkgPDwgMTIpIHwgKGRlY29kZShiNjQuY2hhckF0KGkgKyAyKSkgPDwgNikgfCBkZWNvZGUoYjY0LmNoYXJBdChpICsgMykpCgkJCXB1c2goKHRtcCAmIDB4RkYwMDAwKSA+PiAxNikKCQkJcHVzaCgodG1wICYgMHhGRjAwKSA+PiA4KQoJCQlwdXNoKHRtcCAmIDB4RkYpCgkJfQoKCQlpZiAocGxhY2VIb2xkZXJzID09PSAyKSB7CgkJCXRtcCA9IChkZWNvZGUoYjY0LmNoYXJBdChpKSkgPDwgMikgfCAoZGVjb2RlKGI2NC5jaGFyQXQoaSArIDEpKSA+PiA0KQoJCQlwdXNoKHRtcCAmIDB4RkYpCgkJfSBlbHNlIGlmIChwbGFjZUhvbGRlcnMgPT09IDEpIHsKCQkJdG1wID0gKGRlY29kZShiNjQuY2hhckF0KGkpKSA8PCAxMCkgfCAoZGVjb2RlKGI2NC5jaGFyQXQoaSArIDEpKSA8PCA0KSB8IChkZWNvZGUoYjY0LmNoYXJBdChpICsgMikpID4+IDIpCgkJCXB1c2goKHRtcCA+PiA4KSAmIDB4RkYpCgkJCXB1c2godG1wICYgMHhGRikKCQl9CgoJCXJldHVybiBhcnIKCX0KCglmdW5jdGlvbiB1aW50OFRvQmFzZTY0ICh1aW50OCkgewoJCXZhciBpLAoJCQlleHRyYUJ5dGVzID0gdWludDgubGVuZ3RoICUgMywgLy8gaWYgd2UgaGF2ZSAxIGJ5dGUgbGVmdCwgcGFkIDIgYnl0ZXMKCQkJb3V0cHV0ID0gIiIsCgkJCXRlbXAsIGxlbmd0aAoKCQlmdW5jdGlvbiBlbmNvZGUgKG51bSkgewoJCQlyZXR1cm4gbG9va3VwLmNoYXJBdChudW0pCgkJfQoKCQlmdW5jdGlvbiB0cmlwbGV0VG9CYXNlNjQgKG51bSkgewoJCQlyZXR1cm4gZW5jb2RlKG51bSA+PiAxOCAmIDB4M0YpICsgZW5jb2RlKG51bSA+PiAxMiAmIDB4M0YpICsgZW5jb2RlKG51bSA+PiA2ICYgMHgzRikgKyBlbmNvZGUobnVtICYgMHgzRikKCQl9CgoJCS8vIGdvIHRocm91Z2ggdGhlIGFycmF5IGV2ZXJ5IHRocmVlIGJ5dGVzLCB3ZSdsbCBkZWFsIHdpdGggdHJhaWxpbmcgc3R1ZmYgbGF0ZXIKCQlmb3IgKGkgPSAwLCBsZW5ndGggPSB1aW50OC5sZW5ndGggLSBleHRyYUJ5dGVzOyBpIDwgbGVuZ3RoOyBpICs9IDMpIHsKCQkJdGVtcCA9ICh1aW50OFtpXSA8PCAxNikgKyAodWludDhbaSArIDFdIDw8IDgpICsgKHVpbnQ4W2kgKyAyXSkKCQkJb3V0cHV0ICs9IHRyaXBsZXRUb0Jhc2U2NCh0ZW1wKQoJCX0KCgkJLy8gcGFkIHRoZSBlbmQgd2l0aCB6ZXJvcywgYnV0IG1ha2Ugc3VyZSB0byBub3QgZm9yZ2V0IHRoZSBleHRyYSBieXRlcwoJCXN3aXRjaCAoZXh0cmFCeXRlcykgewoJCQljYXNlIDE6CgkJCQl0ZW1wID0gdWludDhbdWludDgubGVuZ3RoIC0gMV0KCQkJCW91dHB1dCArPSBlbmNvZGUodGVtcCA+PiAyKQoJCQkJb3V0cHV0ICs9IGVuY29kZSgodGVtcCA8PCA0KSAmIDB4M0YpCgkJCQlvdXRwdXQgKz0gJz09JwoJCQkJYnJlYWsKCQkJY2FzZSAyOgoJCQkJdGVtcCA9ICh1aW50OFt1aW50OC5sZW5ndGggLSAyXSA8PCA4KSArICh1aW50OFt1aW50OC5sZW5ndGggLSAxXSkKCQkJCW91dHB1dCArPSBlbmNvZGUodGVtcCA+PiAxMCkKCQkJCW91dHB1dCArPSBlbmNvZGUoKHRlbXAgPj4gNCkgJiAweDNGKQoJCQkJb3V0cHV0ICs9IGVuY29kZSgodGVtcCA8PCAyKSAmIDB4M0YpCgkJCQlvdXRwdXQgKz0gJz0nCgkJCQlicmVhawoJCX0KCgkJcmV0dXJuIG91dHB1dAoJfQoKCWV4cG9ydHMudG9CeXRlQXJyYXkgPSBiNjRUb0J5dGVBcnJheQoJZXhwb3J0cy5mcm9tQnl0ZUFycmF5ID0gdWludDhUb0Jhc2U2NAp9KHR5cGVvZiBleHBvcnRzID09PSAndW5kZWZpbmVkJyA/ICh0aGlzLmJhc2U2NGpzID0ge30pIDogZXhwb3J0cykpCgp9LHt9XSw1NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMucmVhZCA9IGZ1bmN0aW9uKGJ1ZmZlciwgb2Zmc2V0LCBpc0xFLCBtTGVuLCBuQnl0ZXMpIHsKICB2YXIgZSwgbSwKICAgICAgZUxlbiA9IG5CeXRlcyAqIDggLSBtTGVuIC0gMSwKICAgICAgZU1heCA9ICgxIDw8IGVMZW4pIC0gMSwKICAgICAgZUJpYXMgPSBlTWF4ID4+IDEsCiAgICAgIG5CaXRzID0gLTcsCiAgICAgIGkgPSBpc0xFID8gKG5CeXRlcyAtIDEpIDogMCwKICAgICAgZCA9IGlzTEUgPyAtMSA6IDEsCiAgICAgIHMgPSBidWZmZXJbb2Zmc2V0ICsgaV07CgogIGkgKz0gZDsKCiAgZSA9IHMgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgcyA+Pj0gKC1uQml0cyk7CiAgbkJpdHMgKz0gZUxlbjsKICBmb3IgKDsgbkJpdHMgPiAwOyBlID0gZSAqIDI1NiArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KTsKCiAgbSA9IGUgJiAoKDEgPDwgKC1uQml0cykpIC0gMSk7CiAgZSA+Pj0gKC1uQml0cyk7CiAgbkJpdHMgKz0gbUxlbjsKICBmb3IgKDsgbkJpdHMgPiAwOyBtID0gbSAqIDI1NiArIGJ1ZmZlcltvZmZzZXQgKyBpXSwgaSArPSBkLCBuQml0cyAtPSA4KTsKCiAgaWYgKGUgPT09IDApIHsKICAgIGUgPSAxIC0gZUJpYXM7CiAgfSBlbHNlIGlmIChlID09PSBlTWF4KSB7CiAgICByZXR1cm4gbSA/IE5hTiA6ICgocyA/IC0xIDogMSkgKiBJbmZpbml0eSk7CiAgfSBlbHNlIHsKICAgIG0gPSBtICsgTWF0aC5wb3coMiwgbUxlbik7CiAgICBlID0gZSAtIGVCaWFzOwogIH0KICByZXR1cm4gKHMgPyAtMSA6IDEpICogbSAqIE1hdGgucG93KDIsIGUgLSBtTGVuKTsKfTsKCmV4cG9ydHMud3JpdGUgPSBmdW5jdGlvbihidWZmZXIsIHZhbHVlLCBvZmZzZXQsIGlzTEUsIG1MZW4sIG5CeXRlcykgewogIHZhciBlLCBtLCBjLAogICAgICBlTGVuID0gbkJ5dGVzICogOCAtIG1MZW4gLSAxLAogICAgICBlTWF4ID0gKDEgPDwgZUxlbikgLSAxLAogICAgICBlQmlhcyA9IGVNYXggPj4gMSwKICAgICAgcnQgPSAobUxlbiA9PT0gMjMgPyBNYXRoLnBvdygyLCAtMjQpIC0gTWF0aC5wb3coMiwgLTc3KSA6IDApLAogICAgICBpID0gaXNMRSA/IDAgOiAobkJ5dGVzIC0gMSksCiAgICAgIGQgPSBpc0xFID8gMSA6IC0xLAogICAgICBzID0gdmFsdWUgPCAwIHx8ICh2YWx1ZSA9PT0gMCAmJiAxIC8gdmFsdWUgPCAwKSA/IDEgOiAwOwoKICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKCiAgaWYgKGlzTmFOKHZhbHVlKSB8fCB2YWx1ZSA9PT0gSW5maW5pdHkpIHsKICAgIG0gPSBpc05hTih2YWx1ZSkgPyAxIDogMDsKICAgIGUgPSBlTWF4OwogIH0gZWxzZSB7CiAgICBlID0gTWF0aC5mbG9vcihNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMik7CiAgICBpZiAodmFsdWUgKiAoYyA9IE1hdGgucG93KDIsIC1lKSkgPCAxKSB7CiAgICAgIGUtLTsKICAgICAgYyAqPSAyOwogICAgfQogICAgaWYgKGUgKyBlQmlhcyA+PSAxKSB7CiAgICAgIHZhbHVlICs9IHJ0IC8gYzsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlICs9IHJ0ICogTWF0aC5wb3coMiwgMSAtIGVCaWFzKTsKICAgIH0KICAgIGlmICh2YWx1ZSAqIGMgPj0gMikgewogICAgICBlKys7CiAgICAgIGMgLz0gMjsKICAgIH0KCiAgICBpZiAoZSArIGVCaWFzID49IGVNYXgpIHsKICAgICAgbSA9IDA7CiAgICAgIGUgPSBlTWF4OwogICAgfSBlbHNlIGlmIChlICsgZUJpYXMgPj0gMSkgewogICAgICBtID0gKHZhbHVlICogYyAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgIGUgPSBlICsgZUJpYXM7CiAgICB9IGVsc2UgewogICAgICBtID0gdmFsdWUgKiBNYXRoLnBvdygyLCBlQmlhcyAtIDEpICogTWF0aC5wb3coMiwgbUxlbik7CiAgICAgIGUgPSAwOwogICAgfQogIH0KCiAgZm9yICg7IG1MZW4gPj0gODsgYnVmZmVyW29mZnNldCArIGldID0gbSAmIDB4ZmYsIGkgKz0gZCwgbSAvPSAyNTYsIG1MZW4gLT0gOCk7CgogIGUgPSAoZSA8PCBtTGVuKSB8IG07CiAgZUxlbiArPSBtTGVuOwogIGZvciAoOyBlTGVuID4gMDsgYnVmZmVyW29mZnNldCArIGldID0gZSAmIDB4ZmYsIGkgKz0gZCwgZSAvPSAyNTYsIGVMZW4gLT0gOCk7CgogIGJ1ZmZlcltvZmZzZXQgKyBpIC0gZF0gfD0gcyAqIDEyODsKfTsKCn0se31dLDU2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKCi8qKgogKiBpc0FycmF5CiAqLwoKdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5OwoKLyoqCiAqIHRvU3RyaW5nCiAqLwoKdmFyIHN0ciA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmc7CgovKioKICogV2hldGhlciBvciBub3QgdGhlIGdpdmVuIGB2YWxgCiAqIGlzIGFuIGFycmF5LgogKgogKiBleGFtcGxlOgogKgogKiAgICAgICAgaXNBcnJheShbXSk7CiAqICAgICAgICAvLyA+IHRydWUKICogICAgICAgIGlzQXJyYXkoYXJndW1lbnRzKTsKICogICAgICAgIC8vID4gZmFsc2UKICogICAgICAgIGlzQXJyYXkoJycpOwogKiAgICAgICAgLy8gPiBmYWxzZQogKgogKiBAcGFyYW0ge21peGVkfSB2YWwKICogQHJldHVybiB7Ym9vbH0KICovCgptb2R1bGUuZXhwb3J0cyA9IGlzQXJyYXkgfHwgZnVuY3Rpb24gKHZhbCkgewogIHJldHVybiAhISB2YWwgJiYgJ1tvYmplY3QgQXJyYXldJyA9PSBzdHIuY2FsbCh2YWwpOwp9OwoKfSx7fV0sNTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgpmdW5jdGlvbiBFdmVudEVtaXR0ZXIoKSB7CiAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9OwogIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7Cn0KbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7CgovLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKRXZlbnRFbWl0dGVyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuX2V2ZW50cyA9IHVuZGVmaW5lZDsKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwoKLy8gQnkgZGVmYXVsdCBFdmVudEVtaXR0ZXJzIHdpbGwgcHJpbnQgYSB3YXJuaW5nIGlmIG1vcmUgdGhhbiAxMCBsaXN0ZW5lcnMgYXJlCi8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuCkV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CgovLyBPYnZpb3VzbHkgbm90IGFsbCBFbWl0dGVycyBzaG91bGQgYmUgbGltaXRlZCB0byAxMC4gVGhpcyBmdW5jdGlvbiBhbGxvd3MKLy8gdGhhdCB0byBiZSBpbmNyZWFzZWQuIFNldCB0byB6ZXJvIGZvciB1bmxpbWl0ZWQuCkV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewogIGlmICghaXNOdW1iZXIobikgfHwgbiA8IDAgfHwgaXNOYU4obikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ24gbXVzdCBiZSBhIHBvc2l0aXZlIG51bWJlcicpOwogIHRoaXMuX21heExpc3RlbmVycyA9IG47CiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsKCiAgaWYgKCF0aGlzLl9ldmVudHMpCiAgICB0aGlzLl9ldmVudHMgPSB7fTsKCiAgLy8gSWYgdGhlcmUgaXMgbm8gJ2Vycm9yJyBldmVudCBsaXN0ZW5lciB0aGVuIHRocm93LgogIGlmICh0eXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAogICAgICAgIChpc09iamVjdCh0aGlzLl9ldmVudHMuZXJyb3IpICYmICF0aGlzLl9ldmVudHMuZXJyb3IubGVuZ3RoKSkgewogICAgICBlciA9IGFyZ3VtZW50c1sxXTsKICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICB0aHJvdyBlcjsgLy8gVW5oYW5kbGVkICdlcnJvcicgZXZlbnQKICAgICAgfQogICAgICB0aHJvdyBUeXBlRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LicpOwogICAgfQogIH0KCiAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCiAgaWYgKGlzVW5kZWZpbmVkKGhhbmRsZXIpKQogICAgcmV0dXJuIGZhbHNlOwoKICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewogICAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIC8vIGZhc3QgY2FzZXMKICAgICAgY2FzZSAxOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0pOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdKTsKICAgICAgICBicmVhazsKICAgICAgLy8gc2xvd2VyCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgICAgICBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOwogICAgICAgIGZvciAoaSA9IDE7IGkgPCBsZW47IGkrKykKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9CiAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgewogICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKICAgIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7CiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuOyBpKyspCiAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwoKICAgIGxpc3RlbmVycyA9IGhhbmRsZXIuc2xpY2UoKTsKICAgIGxlbiA9IGxpc3RlbmVycy5sZW5ndGg7CiAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICB9CgogIHJldHVybiB0cnVlOwp9OwoKRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgdmFyIG07CgogIGlmICghaXNGdW5jdGlvbihsaXN0ZW5lcikpCiAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKICBpZiAoIXRoaXMuX2V2ZW50cykKICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoKICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUKICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgogIGlmICh0aGlzLl9ldmVudHMubmV3TGlzdGVuZXIpCiAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwKICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CiAgICAgICAgICAgICAgbGlzdGVuZXIubGlzdGVuZXIgOiBsaXN0ZW5lcik7CgogIGlmICghdGhpcy5fZXZlbnRzW3R5cGVdKQogICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCiAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBsaXN0ZW5lcjsKICBlbHNlIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pKQogICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgogICAgdGhpcy5fZXZlbnRzW3R5cGVdLnB1c2gobGlzdGVuZXIpOwogIGVsc2UKICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgogICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gW3RoaXMuX2V2ZW50c1t0eXBlXSwgbGlzdGVuZXJdOwoKICAvLyBDaGVjayBmb3IgbGlzdGVuZXIgbGVhawogIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CiAgICB2YXIgbTsKICAgIGlmICghaXNVbmRlZmluZWQodGhpcy5fbWF4TGlzdGVuZXJzKSkgewogICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwogICAgfSBlbHNlIHsKICAgICAgbSA9IEV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzOwogICAgfQoKICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7CiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlXS53YXJuZWQgPSB0cnVlOwogICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsKICAgICAgICAgICAgICAgICAgICAnVXNlIGVtaXR0ZXIuc2V0TWF4TGlzdGVuZXJzKCkgdG8gaW5jcmVhc2UgbGltaXQuJywKICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgLy8gbm90IHN1cHBvcnRlZCBpbiBJRSAxMAogICAgICAgIGNvbnNvbGUudHJhY2UoKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CiAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgogIHZhciBmaXJlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBnKCkgewogICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKCiAgICBpZiAoIWZpcmVkKSB7CiAgICAgIGZpcmVkID0gdHJ1ZTsKICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9CgogIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKICB0aGlzLm9uKHR5cGUsIGcpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkCkV2ZW50RW1pdHRlci5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewogIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwoKICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQogICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsKCiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldHVybiB0aGlzOwoKICBsaXN0ID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwogIHBvc2l0aW9uID0gLTE7CgogIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fAogICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoKICB9IGVsc2UgaWYgKGlzT2JqZWN0KGxpc3QpKSB7CiAgICBmb3IgKGkgPSBsZW5ndGg7IGktLSA+IDA7KSB7CiAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAogICAgICAgICAgKGxpc3RbaV0ubGlzdGVuZXIgJiYgbGlzdFtpXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpKSB7CiAgICAgICAgcG9zaXRpb24gPSBpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYgKHBvc2l0aW9uIDwgMCkKICAgICAgcmV0dXJuIHRoaXM7CgogICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7CiAgICAgIGxpc3QubGVuZ3RoID0gMDsKICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgIH0gZWxzZSB7CiAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKICAgIH0KCiAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQogICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwogIH0KCiAgcmV0dXJuIHRoaXM7Cn07CgpFdmVudEVtaXR0ZXIucHJvdG90eXBlLnJlbW92ZUFsbExpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKICB2YXIga2V5LCBsaXN0ZW5lcnM7CgogIGlmICghdGhpcy5fZXZlbnRzKQogICAgcmV0dXJuIHRoaXM7CgogIC8vIG5vdCBsaXN0ZW5pbmcgZm9yIHJlbW92ZUxpc3RlbmVyLCBubyBuZWVkIHRvIGVtaXQKICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewogICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApCiAgICAgIHRoaXMuX2V2ZW50cyA9IHt9OwogICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQogICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyBlbWl0IHJlbW92ZUxpc3RlbmVyIGZvciBhbGwgbGlzdGVuZXJzIG9uIGFsbCBldmVudHMKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CiAgICAgIGlmIChrZXkgPT09ICdyZW1vdmVMaXN0ZW5lcicpIGNvbnRpbnVlOwogICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOwogICAgfQogICAgdGhpcy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3JlbW92ZUxpc3RlbmVyJyk7CiAgICB0aGlzLl9ldmVudHMgPSB7fTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CiAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7CiAgfSBlbHNlIHsKICAgIC8vIExJRk8gb3JkZXIKICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVyc1tsaXN0ZW5lcnMubGVuZ3RoIC0gMV0pOwogIH0KICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwoKICByZXR1cm4gdGhpczsKfTsKCkV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24odHlwZSkgewogIHZhciByZXQ7CiAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKICAgIHJldCA9IFtdOwogIGVsc2UgaWYgKGlzRnVuY3Rpb24odGhpcy5fZXZlbnRzW3R5cGVdKSkKICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwogIGVsc2UKICAgIHJldCA9IHRoaXMuX2V2ZW50c1t0eXBlXS5zbGljZSgpOwogIHJldHVybiByZXQ7Cn07CgpFdmVudEVtaXR0ZXIubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKGVtaXR0ZXIsIHR5cGUpIHsKICB2YXIgcmV0OwogIGlmICghZW1pdHRlci5fZXZlbnRzIHx8ICFlbWl0dGVyLl9ldmVudHNbdHlwZV0pCiAgICByZXQgPSAwOwogIGVsc2UgaWYgKGlzRnVuY3Rpb24oZW1pdHRlci5fZXZlbnRzW3R5cGVdKSkKICAgIHJldCA9IDE7CiAgZWxzZQogICAgcmV0ID0gZW1pdHRlci5fZXZlbnRzW3R5cGVdLmxlbmd0aDsKICByZXR1cm4gcmV0Owp9OwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CgpmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwp9CgpmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09PSB2b2lkIDA7Cn0KCn0se31dLDU4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSBBcnJheS5pc0FycmF5IHx8IGZ1bmN0aW9uIChhcnIpIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGFycikgPT0gJ1tvYmplY3QgQXJyYXldJzsKfTsKCn0se31dLDU5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKLy8gcmVzb2x2ZXMgLiBhbmQgLi4gZWxlbWVudHMgaW4gYSBwYXRoIGFycmF5IHdpdGggZGlyZWN0b3J5IG5hbWVzIHRoZXJlCi8vIG11c3QgYmUgbm8gc2xhc2hlcywgZW1wdHkgZWxlbWVudHMsIG9yIGRldmljZSBuYW1lcyAoYzpcKSBpbiB0aGUgYXJyYXkKLy8gKHNvIGFsc28gbm8gbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcyAtIGl0IGRvZXMgbm90IGRpc3Rpbmd1aXNoCi8vIHJlbGF0aXZlIGFuZCBhYnNvbHV0ZSBwYXRocykKZnVuY3Rpb24gbm9ybWFsaXplQXJyYXkocGFydHMsIGFsbG93QWJvdmVSb290KSB7CiAgLy8gaWYgdGhlIHBhdGggdHJpZXMgdG8gZ28gYWJvdmUgdGhlIHJvb3QsIGB1cGAgZW5kcyB1cCA+IDAKICB2YXIgdXAgPSAwOwogIGZvciAodmFyIGkgPSBwYXJ0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgdmFyIGxhc3QgPSBwYXJ0c1tpXTsKICAgIGlmIChsYXN0ID09PSAnLicpIHsKICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgfSBlbHNlIGlmIChsYXN0ID09PSAnLi4nKSB7CiAgICAgIHBhcnRzLnNwbGljZShpLCAxKTsKICAgICAgdXArKzsKICAgIH0gZWxzZSBpZiAodXApIHsKICAgICAgcGFydHMuc3BsaWNlKGksIDEpOwogICAgICB1cC0tOwogICAgfQogIH0KCiAgLy8gaWYgdGhlIHBhdGggaXMgYWxsb3dlZCB0byBnbyBhYm92ZSB0aGUgcm9vdCwgcmVzdG9yZSBsZWFkaW5nIC4ucwogIGlmIChhbGxvd0Fib3ZlUm9vdCkgewogICAgZm9yICg7IHVwLS07IHVwKSB7CiAgICAgIHBhcnRzLnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgfQoKICByZXR1cm4gcGFydHM7Cn0KCi8vIFNwbGl0IGEgZmlsZW5hbWUgaW50byBbcm9vdCwgZGlyLCBiYXNlbmFtZSwgZXh0XSwgdW5peCB2ZXJzaW9uCi8vICdyb290JyBpcyBqdXN0IGEgc2xhc2gsIG9yIG5vdGhpbmcuCnZhciBzcGxpdFBhdGhSZSA9CiAgICAvXihcLz98KShbXHNcU10qPykoKD86XC57MSwyfXxbXlwvXSs/fCkoXC5bXi5cL10qfCkpKD86W1wvXSopJC87CnZhciBzcGxpdFBhdGggPSBmdW5jdGlvbihmaWxlbmFtZSkgewogIHJldHVybiBzcGxpdFBhdGhSZS5leGVjKGZpbGVuYW1lKS5zbGljZSgxKTsKfTsKCi8vIHBhdGgucmVzb2x2ZShbZnJvbSAuLi5dLCB0bykKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLnJlc29sdmUgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVzb2x2ZWRQYXRoID0gJycsCiAgICAgIHJlc29sdmVkQWJzb2x1dGUgPSBmYWxzZTsKCiAgZm9yICh2YXIgaSA9IGFyZ3VtZW50cy5sZW5ndGggLSAxOyBpID49IC0xICYmICFyZXNvbHZlZEFic29sdXRlOyBpLS0pIHsKICAgIHZhciBwYXRoID0gKGkgPj0gMCkgPyBhcmd1bWVudHNbaV0gOiBwcm9jZXNzLmN3ZCgpOwoKICAgIC8vIFNraXAgZW1wdHkgYW5kIGludmFsaWQgZW50cmllcwogICAgaWYgKHR5cGVvZiBwYXRoICE9PSAnc3RyaW5nJykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdBcmd1bWVudHMgdG8gcGF0aC5yZXNvbHZlIG11c3QgYmUgc3RyaW5ncycpOwogICAgfSBlbHNlIGlmICghcGF0aCkgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICByZXNvbHZlZFBhdGggPSBwYXRoICsgJy8nICsgcmVzb2x2ZWRQYXRoOwogICAgcmVzb2x2ZWRBYnNvbHV0ZSA9IHBhdGguY2hhckF0KDApID09PSAnLyc7CiAgfQoKICAvLyBBdCB0aGlzIHBvaW50IHRoZSBwYXRoIHNob3VsZCBiZSByZXNvbHZlZCB0byBhIGZ1bGwgYWJzb2x1dGUgcGF0aCwgYnV0CiAgLy8gaGFuZGxlIHJlbGF0aXZlIHBhdGhzIHRvIGJlIHNhZmUgKG1pZ2h0IGhhcHBlbiB3aGVuIHByb2Nlc3MuY3dkKCkgZmFpbHMpCgogIC8vIE5vcm1hbGl6ZSB0aGUgcGF0aAogIHJlc29sdmVkUGF0aCA9IG5vcm1hbGl6ZUFycmF5KGZpbHRlcihyZXNvbHZlZFBhdGguc3BsaXQoJy8nKSwgZnVuY3Rpb24ocCkgewogICAgcmV0dXJuICEhcDsKICB9KSwgIXJlc29sdmVkQWJzb2x1dGUpLmpvaW4oJy8nKTsKCiAgcmV0dXJuICgocmVzb2x2ZWRBYnNvbHV0ZSA/ICcvJyA6ICcnKSArIHJlc29sdmVkUGF0aCkgfHwgJy4nOwp9OwoKLy8gcGF0aC5ub3JtYWxpemUocGF0aCkKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLm5vcm1hbGl6ZSA9IGZ1bmN0aW9uKHBhdGgpIHsKICB2YXIgaXNBYnNvbHV0ZSA9IGV4cG9ydHMuaXNBYnNvbHV0ZShwYXRoKSwKICAgICAgdHJhaWxpbmdTbGFzaCA9IHN1YnN0cihwYXRoLCAtMSkgPT09ICcvJzsKCiAgLy8gTm9ybWFsaXplIHRoZSBwYXRoCiAgcGF0aCA9IG5vcm1hbGl6ZUFycmF5KGZpbHRlcihwYXRoLnNwbGl0KCcvJyksIGZ1bmN0aW9uKHApIHsKICAgIHJldHVybiAhIXA7CiAgfSksICFpc0Fic29sdXRlKS5qb2luKCcvJyk7CgogIGlmICghcGF0aCAmJiAhaXNBYnNvbHV0ZSkgewogICAgcGF0aCA9ICcuJzsKICB9CiAgaWYgKHBhdGggJiYgdHJhaWxpbmdTbGFzaCkgewogICAgcGF0aCArPSAnLyc7CiAgfQoKICByZXR1cm4gKGlzQWJzb2x1dGUgPyAnLycgOiAnJykgKyBwYXRoOwp9OwoKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLmlzQWJzb2x1dGUgPSBmdW5jdGlvbihwYXRoKSB7CiAgcmV0dXJuIHBhdGguY2hhckF0KDApID09PSAnLyc7Cn07CgovLyBwb3NpeCB2ZXJzaW9uCmV4cG9ydHMuam9pbiA9IGZ1bmN0aW9uKCkgewogIHZhciBwYXRocyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CiAgcmV0dXJuIGV4cG9ydHMubm9ybWFsaXplKGZpbHRlcihwYXRocywgZnVuY3Rpb24ocCwgaW5kZXgpIHsKICAgIGlmICh0eXBlb2YgcCAhPT0gJ3N0cmluZycpIHsKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignQXJndW1lbnRzIHRvIHBhdGguam9pbiBtdXN0IGJlIHN0cmluZ3MnKTsKICAgIH0KICAgIHJldHVybiBwOwogIH0pLmpvaW4oJy8nKSk7Cn07CgoKLy8gcGF0aC5yZWxhdGl2ZShmcm9tLCB0bykKLy8gcG9zaXggdmVyc2lvbgpleHBvcnRzLnJlbGF0aXZlID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICBmcm9tID0gZXhwb3J0cy5yZXNvbHZlKGZyb20pLnN1YnN0cigxKTsKICB0byA9IGV4cG9ydHMucmVzb2x2ZSh0bykuc3Vic3RyKDEpOwoKICBmdW5jdGlvbiB0cmltKGFycikgewogICAgdmFyIHN0YXJ0ID0gMDsKICAgIGZvciAoOyBzdGFydCA8IGFyci5sZW5ndGg7IHN0YXJ0KyspIHsKICAgICAgaWYgKGFycltzdGFydF0gIT09ICcnKSBicmVhazsKICAgIH0KCiAgICB2YXIgZW5kID0gYXJyLmxlbmd0aCAtIDE7CiAgICBmb3IgKDsgZW5kID49IDA7IGVuZC0tKSB7CiAgICAgIGlmIChhcnJbZW5kXSAhPT0gJycpIGJyZWFrOwogICAgfQoKICAgIGlmIChzdGFydCA+IGVuZCkgcmV0dXJuIFtdOwogICAgcmV0dXJuIGFyci5zbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKTsKICB9CgogIHZhciBmcm9tUGFydHMgPSB0cmltKGZyb20uc3BsaXQoJy8nKSk7CiAgdmFyIHRvUGFydHMgPSB0cmltKHRvLnNwbGl0KCcvJykpOwoKICB2YXIgbGVuZ3RoID0gTWF0aC5taW4oZnJvbVBhcnRzLmxlbmd0aCwgdG9QYXJ0cy5sZW5ndGgpOwogIHZhciBzYW1lUGFydHNMZW5ndGggPSBsZW5ndGg7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgaWYgKGZyb21QYXJ0c1tpXSAhPT0gdG9QYXJ0c1tpXSkgewogICAgICBzYW1lUGFydHNMZW5ndGggPSBpOwogICAgICBicmVhazsKICAgIH0KICB9CgogIHZhciBvdXRwdXRQYXJ0cyA9IFtdOwogIGZvciAodmFyIGkgPSBzYW1lUGFydHNMZW5ndGg7IGkgPCBmcm9tUGFydHMubGVuZ3RoOyBpKyspIHsKICAgIG91dHB1dFBhcnRzLnB1c2goJy4uJyk7CiAgfQoKICBvdXRwdXRQYXJ0cyA9IG91dHB1dFBhcnRzLmNvbmNhdCh0b1BhcnRzLnNsaWNlKHNhbWVQYXJ0c0xlbmd0aCkpOwoKICByZXR1cm4gb3V0cHV0UGFydHMuam9pbignLycpOwp9OwoKZXhwb3J0cy5zZXAgPSAnLyc7CmV4cG9ydHMuZGVsaW1pdGVyID0gJzonOwoKZXhwb3J0cy5kaXJuYW1lID0gZnVuY3Rpb24ocGF0aCkgewogIHZhciByZXN1bHQgPSBzcGxpdFBhdGgocGF0aCksCiAgICAgIHJvb3QgPSByZXN1bHRbMF0sCiAgICAgIGRpciA9IHJlc3VsdFsxXTsKCiAgaWYgKCFyb290ICYmICFkaXIpIHsKICAgIC8vIE5vIGRpcm5hbWUgd2hhdHNvZXZlcgogICAgcmV0dXJuICcuJzsKICB9CgogIGlmIChkaXIpIHsKICAgIC8vIEl0IGhhcyBhIGRpcm5hbWUsIHN0cmlwIHRyYWlsaW5nIHNsYXNoCiAgICBkaXIgPSBkaXIuc3Vic3RyKDAsIGRpci5sZW5ndGggLSAxKTsKICB9CgogIHJldHVybiByb290ICsgZGlyOwp9OwoKCmV4cG9ydHMuYmFzZW5hbWUgPSBmdW5jdGlvbihwYXRoLCBleHQpIHsKICB2YXIgZiA9IHNwbGl0UGF0aChwYXRoKVsyXTsKICAvLyBUT0RPOiBtYWtlIHRoaXMgY29tcGFyaXNvbiBjYXNlLWluc2Vuc2l0aXZlIG9uIHdpbmRvd3M/CiAgaWYgKGV4dCAmJiBmLnN1YnN0cigtMSAqIGV4dC5sZW5ndGgpID09PSBleHQpIHsKICAgIGYgPSBmLnN1YnN0cigwLCBmLmxlbmd0aCAtIGV4dC5sZW5ndGgpOwogIH0KICByZXR1cm4gZjsKfTsKCgpleHBvcnRzLmV4dG5hbWUgPSBmdW5jdGlvbihwYXRoKSB7CiAgcmV0dXJuIHNwbGl0UGF0aChwYXRoKVszXTsKfTsKCmZ1bmN0aW9uIGZpbHRlciAoeHMsIGYpIHsKICAgIGlmICh4cy5maWx0ZXIpIHJldHVybiB4cy5maWx0ZXIoZik7CiAgICB2YXIgcmVzID0gW107CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHhzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKGYoeHNbaV0sIGksIHhzKSkgcmVzLnB1c2goeHNbaV0pOwogICAgfQogICAgcmV0dXJuIHJlczsKfQoKLy8gU3RyaW5nLnByb3RvdHlwZS5zdWJzdHIgLSBuZWdhdGl2ZSBpbmRleCBkb24ndCB3b3JrIGluIElFOAp2YXIgc3Vic3RyID0gJ2FiJy5zdWJzdHIoLTEpID09PSAnYicKICAgID8gZnVuY3Rpb24gKHN0ciwgc3RhcnQsIGxlbikgeyByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuKSB9CiAgICA6IGZ1bmN0aW9uIChzdHIsIHN0YXJ0LCBsZW4pIHsKICAgICAgICBpZiAoc3RhcnQgPCAwKSBzdGFydCA9IHN0ci5sZW5ndGggKyBzdGFydDsKICAgICAgICByZXR1cm4gc3RyLnN1YnN0cihzdGFydCwgbGVuKTsKICAgIH0KOwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyJfcHJvY2VzcyI6NjB9XSw2MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNoaW0gZm9yIHVzaW5nIHByb2Nlc3MgaW4gYnJvd3NlcgoKdmFyIHByb2Nlc3MgPSBtb2R1bGUuZXhwb3J0cyA9IHt9OwoKcHJvY2Vzcy5uZXh0VGljayA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgY2FuU2V0SW1tZWRpYXRlID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICYmIHdpbmRvdy5zZXRJbW1lZGlhdGU7CiAgICB2YXIgY2FuTXV0YXRpb25PYnNlcnZlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnCiAgICAmJiB3aW5kb3cuTXV0YXRpb25PYnNlcnZlcjsKICAgIHZhciBjYW5Qb3N0ID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcKICAgICYmIHdpbmRvdy5wb3N0TWVzc2FnZSAmJiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcgogICAgOwoKICAgIGlmIChjYW5TZXRJbW1lZGlhdGUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGYpIHsgcmV0dXJuIHdpbmRvdy5zZXRJbW1lZGlhdGUoZikgfTsKICAgIH0KCiAgICB2YXIgcXVldWUgPSBbXTsKCiAgICBpZiAoY2FuTXV0YXRpb25PYnNlcnZlcikgewogICAgICAgIHZhciBoaWRkZW5EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxpc3QgPSBxdWV1ZS5zbGljZSgpOwogICAgICAgICAgICBxdWV1ZS5sZW5ndGggPSAwOwogICAgICAgICAgICBxdWV1ZUxpc3QuZm9yRWFjaChmdW5jdGlvbiAoZm4pIHsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICBvYnNlcnZlci5vYnNlcnZlKGhpZGRlbkRpdiwgeyBhdHRyaWJ1dGVzOiB0cnVlIH0pOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgICAgICAgaWYgKCFxdWV1ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpZGRlbkRpdi5zZXRBdHRyaWJ1dGUoJ3llcycsICdubycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLnB1c2goZm4pOwogICAgICAgIH07CiAgICB9CgogICAgaWYgKGNhblBvc3QpIHsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChldikgewogICAgICAgICAgICB2YXIgc291cmNlID0gZXYuc291cmNlOwogICAgICAgICAgICBpZiAoKHNvdXJjZSA9PT0gd2luZG93IHx8IHNvdXJjZSA9PT0gbnVsbCkgJiYgZXYuZGF0YSA9PT0gJ3Byb2Nlc3MtdGljaycpIHsKICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZm4gPSBxdWV1ZS5zaGlmdCgpOwogICAgICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIG5leHRUaWNrKGZuKSB7CiAgICAgICAgICAgIHF1ZXVlLnB1c2goZm4pOwogICAgICAgICAgICB3aW5kb3cucG9zdE1lc3NhZ2UoJ3Byb2Nlc3MtdGljaycsICcqJyk7CiAgICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gbmV4dFRpY2soZm4pIHsKICAgICAgICBzZXRUaW1lb3V0KGZuLCAwKTsKICAgIH07Cn0pKCk7Cgpwcm9jZXNzLnRpdGxlID0gJ2Jyb3dzZXInOwpwcm9jZXNzLmJyb3dzZXIgPSB0cnVlOwpwcm9jZXNzLmVudiA9IHt9Owpwcm9jZXNzLmFyZ3YgPSBbXTsKCmZ1bmN0aW9uIG5vb3AoKSB7fQoKcHJvY2Vzcy5vbiA9IG5vb3A7CnByb2Nlc3MuYWRkTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLm9uY2UgPSBub29wOwpwcm9jZXNzLm9mZiA9IG5vb3A7CnByb2Nlc3MucmVtb3ZlTGlzdGVuZXIgPSBub29wOwpwcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycyA9IG5vb3A7CnByb2Nlc3MuZW1pdCA9IG5vb3A7Cgpwcm9jZXNzLmJpbmRpbmcgPSBmdW5jdGlvbiAobmFtZSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdwcm9jZXNzLmJpbmRpbmcgaXMgbm90IHN1cHBvcnRlZCcpOwp9OwoKLy8gVE9ETyhzaHR5bG1hbikKcHJvY2Vzcy5jd2QgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAnLycgfTsKcHJvY2Vzcy5jaGRpciA9IGZ1bmN0aW9uIChkaXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigncHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkJyk7Cn07Cgp9LHt9XSw2MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgiLi9saWIvX3N0cmVhbV9kdXBsZXguanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fZHVwbGV4LmpzIjo2Mn1dLDYyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKLy8gQ29weXJpZ2h0IEpveWVudCwgSW5jLiBhbmQgb3RoZXIgTm9kZSBjb250cmlidXRvcnMuCi8vCi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCi8vIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwovLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCi8vIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQKLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlCi8vIGZvbGxvd2luZyBjb25kaXRpb25zOgovLwovLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZAovLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KLy8KLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MKLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgovLyBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOCi8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLAovLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKLy8gT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRQovLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKLy8gYSBkdXBsZXggc3RyZWFtIGlzIGp1c3QgYSBzdHJlYW0gdGhhdCBpcyBib3RoIHJlYWRhYmxlIGFuZCB3cml0YWJsZS4KLy8gU2luY2UgSlMgZG9lc24ndCBoYXZlIG11bHRpcGxlIHByb3RvdHlwYWwgaW5oZXJpdGFuY2UsIHRoaXMgY2xhc3MKLy8gcHJvdG90eXBhbGx5IGluaGVyaXRzIGZyb20gUmVhZGFibGUsIGFuZCB0aGVuIHBhcmFzaXRpY2FsbHkgZnJvbQovLyBXcml0YWJsZS4KCm1vZHVsZS5leHBvcnRzID0gRHVwbGV4OwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIG9iamVjdEtleXMgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAob2JqKSB7CiAgdmFyIGtleXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSBrZXlzLnB1c2goa2V5KTsKICByZXR1cm4ga2V5czsKfQovKjwvcmVwbGFjZW1lbnQ+Ki8KCgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgUmVhZGFibGUgPSByZXF1aXJlKCcuL19zdHJlYW1fcmVhZGFibGUnKTsKdmFyIFdyaXRhYmxlID0gcmVxdWlyZSgnLi9fc3RyZWFtX3dyaXRhYmxlJyk7Cgp1dGlsLmluaGVyaXRzKER1cGxleCwgUmVhZGFibGUpOwoKZm9yRWFjaChvYmplY3RLZXlzKFdyaXRhYmxlLnByb3RvdHlwZSksIGZ1bmN0aW9uKG1ldGhvZCkgewogIGlmICghRHVwbGV4LnByb3RvdHlwZVttZXRob2RdKQogICAgRHVwbGV4LnByb3RvdHlwZVttZXRob2RdID0gV3JpdGFibGUucHJvdG90eXBlW21ldGhvZF07Cn0pOwoKZnVuY3Rpb24gRHVwbGV4KG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgRHVwbGV4KSkKICAgIHJldHVybiBuZXcgRHVwbGV4KG9wdGlvbnMpOwoKICBSZWFkYWJsZS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIFdyaXRhYmxlLmNhbGwodGhpcywgb3B0aW9ucyk7CgogIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmVhZGFibGUgPT09IGZhbHNlKQogICAgdGhpcy5yZWFkYWJsZSA9IGZhbHNlOwoKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLndyaXRhYmxlID09PSBmYWxzZSkKICAgIHRoaXMud3JpdGFibGUgPSBmYWxzZTsKCiAgdGhpcy5hbGxvd0hhbGZPcGVuID0gdHJ1ZTsKICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmFsbG93SGFsZk9wZW4gPT09IGZhbHNlKQogICAgdGhpcy5hbGxvd0hhbGZPcGVuID0gZmFsc2U7CgogIHRoaXMub25jZSgnZW5kJywgb25lbmQpOwp9CgovLyB0aGUgbm8taGFsZi1vcGVuIGVuZm9yY2VyCmZ1bmN0aW9uIG9uZW5kKCkgewogIC8vIGlmIHdlIGFsbG93IGhhbGYtb3BlbiBzdGF0ZSwgb3IgaWYgdGhlIHdyaXRhYmxlIHNpZGUgZW5kZWQsCiAgLy8gdGhlbiB3ZSdyZSBvay4KICBpZiAodGhpcy5hbGxvd0hhbGZPcGVuIHx8IHRoaXMuX3dyaXRhYmxlU3RhdGUuZW5kZWQpCiAgICByZXR1cm47CgogIC8vIG5vIG1vcmUgZGF0YSBjYW4gYmUgd3JpdHRlbi4KICAvLyBCdXQgYWxsb3cgbW9yZSB3cml0ZXMgdG8gaGFwcGVuIGluIHRoaXMgdGljay4KICBwcm9jZXNzLm5leHRUaWNrKHRoaXMuZW5kLmJpbmQodGhpcykpOwp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiLi9fc3RyZWFtX3JlYWRhYmxlIjo2NCwiLi9fc3RyZWFtX3dyaXRhYmxlIjo2NiwiX3Byb2Nlc3MiOjYwLCJjb3JlLXV0aWwtaXMiOjY3LCJpbmhlcml0cyI6NzZ9XSw2MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIGEgcGFzc3Rocm91Z2ggc3RyZWFtLgovLyBiYXNpY2FsbHkganVzdCB0aGUgbW9zdCBtaW5pbWFsIHNvcnQgb2YgVHJhbnNmb3JtIHN0cmVhbS4KLy8gRXZlcnkgd3JpdHRlbiBjaHVuayBnZXRzIG91dHB1dCBhcy1pcy4KCm1vZHVsZS5leHBvcnRzID0gUGFzc1Rocm91Z2g7Cgp2YXIgVHJhbnNmb3JtID0gcmVxdWlyZSgnLi9fc3RyZWFtX3RyYW5zZm9ybScpOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIHV0aWwgPSByZXF1aXJlKCdjb3JlLXV0aWwtaXMnKTsKdXRpbC5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKdXRpbC5pbmhlcml0cyhQYXNzVGhyb3VnaCwgVHJhbnNmb3JtKTsKCmZ1bmN0aW9uIFBhc3NUaHJvdWdoKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUGFzc1Rocm91Z2gpKQogICAgcmV0dXJuIG5ldyBQYXNzVGhyb3VnaChvcHRpb25zKTsKCiAgVHJhbnNmb3JtLmNhbGwodGhpcywgb3B0aW9ucyk7Cn0KClBhc3NUaHJvdWdoLnByb3RvdHlwZS5fdHJhbnNmb3JtID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIGNiKG51bGwsIGNodW5rKTsKfTsKCn0seyIuL19zdHJlYW1fdHJhbnNmb3JtIjo2NSwiY29yZS11dGlsLWlzIjo2NywiaW5oZXJpdHMiOjc2fV0sNjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFJlYWRhYmxlOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5Jyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXInKS5CdWZmZXI7Ci8qPC9yZXBsYWNlbWVudD4qLwoKUmVhZGFibGUuUmVhZGFibGVTdGF0ZSA9IFJlYWRhYmxlU3RhdGU7Cgp2YXIgRUUgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovKjxyZXBsYWNlbWVudD4qLwppZiAoIUVFLmxpc3RlbmVyQ291bnQpIEVFLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJzKHR5cGUpLmxlbmd0aDsKfTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyaW5nRGVjb2RlcjsKCnV0aWwuaW5oZXJpdHMoUmVhZGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBSZWFkYWJsZVN0YXRlKG9wdGlvbnMsIHN0cmVhbSkgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAvLyB0aGUgcG9pbnQgYXQgd2hpY2ggaXQgc3RvcHMgY2FsbGluZyBfcmVhZCgpIHRvIGZpbGwgdGhlIGJ1ZmZlcgogIC8vIE5vdGU6IDAgaXMgYSB2YWxpZCB2YWx1ZSwgbWVhbnMgImRvbid0IGNhbGwgX3JlYWQgcHJlZW1wdGl2ZWx5IGV2ZXIiCiAgdmFyIGh3bSA9IG9wdGlvbnMuaGlnaFdhdGVyTWFyazsKICB0aGlzLmhpZ2hXYXRlck1hcmsgPSAoaHdtIHx8IGh3bSA9PT0gMCkgPyBod20gOiAxNiAqIDEwMjQ7CgogIC8vIGNhc3QgdG8gaW50cy4KICB0aGlzLmhpZ2hXYXRlck1hcmsgPSB+fnRoaXMuaGlnaFdhdGVyTWFyazsKCiAgdGhpcy5idWZmZXIgPSBbXTsKICB0aGlzLmxlbmd0aCA9IDA7CiAgdGhpcy5waXBlcyA9IG51bGw7CiAgdGhpcy5waXBlc0NvdW50ID0gMDsKICB0aGlzLmZsb3dpbmcgPSBmYWxzZTsKICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgdGhpcy5lbmRFbWl0dGVkID0gZmFsc2U7CiAgdGhpcy5yZWFkaW5nID0gZmFsc2U7CgogIC8vIEluIHN0cmVhbXMgdGhhdCBuZXZlciBoYXZlIGFueSBkYXRhLCBhbmQgZG8gcHVzaChudWxsKSByaWdodCBhd2F5LAogIC8vIHRoZSBjb25zdW1lciBjYW4gbWlzcyB0aGUgJ2VuZCcgZXZlbnQgaWYgdGhleSBkbyBzb21lIEkvTyBiZWZvcmUKICAvLyBjb25zdW1pbmcgdGhlIHN0cmVhbS4gIFNvLCB3ZSBkb24ndCBlbWl0KCdlbmQnKSB1bnRpbCBzb21lIHJlYWRpbmcKICAvLyBoYXBwZW5zLgogIHRoaXMuY2FsbGVkUmVhZCA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWN1YXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gd2hlbmV2ZXIgd2UgcmV0dXJuIG51bGwsIHRoZW4gd2Ugc2V0IGEgZmxhZyB0byBzYXkKICAvLyB0aGF0IHdlJ3JlIGF3YWl0aW5nIGEgJ3JlYWRhYmxlJyBldmVudCBlbWlzc2lvbi4KICB0aGlzLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIHRoaXMuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgdGhpcy5yZWFkYWJsZUxpc3RlbmluZyA9IGZhbHNlOwoKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnLiBVc2VkIHRvIG1ha2UgcmVhZChuKSBpZ25vcmUgbiBhbmQgdG8KICAvLyBtYWtlIGFsbCB0aGUgYnVmZmVyIG1lcmdpbmcgYW5kIGxlbmd0aCBjaGVja3MgZ28gYXdheQogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICAvLyBDcnlwdG8gaXMga2luZCBvZiBvbGQgYW5kIGNydXN0eS4gIEhpc3RvcmljYWxseSwgaXRzIGRlZmF1bHQgc3RyaW5nCiAgLy8gZW5jb2RpbmcgaXMgJ2JpbmFyeScgc28gd2UgaGF2ZSB0byBtYWtlIHRoaXMgY29uZmlndXJhYmxlLgogIC8vIEV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgdW5pdmVyc2UgdXNlcyAndXRmOCcsIHRob3VnaC4KICB0aGlzLmRlZmF1bHRFbmNvZGluZyA9IG9wdGlvbnMuZGVmYXVsdEVuY29kaW5nIHx8ICd1dGY4JzsKCiAgLy8gd2hlbiBwaXBpbmcsIHdlIG9ubHkgY2FyZSBhYm91dCAncmVhZGFibGUnIGV2ZW50cyB0aGF0IGhhcHBlbgogIC8vIGFmdGVyIHJlYWQoKWluZyBhbGwgdGhlIGJ5dGVzIGFuZCBub3QgZ2V0dGluZyBhbnkgcHVzaGJhY2suCiAgdGhpcy5yYW5PdXQgPSBmYWxzZTsKCiAgLy8gdGhlIG51bWJlciBvZiB3cml0ZXJzIHRoYXQgYXJlIGF3YWl0aW5nIGEgZHJhaW4gZXZlbnQgaW4gLnBpcGUoKXMKICB0aGlzLmF3YWl0RHJhaW4gPSAwOwoKICAvLyBpZiB0cnVlLCBhIG1heWJlUmVhZE1vcmUgaGFzIGJlZW4gc2NoZWR1bGVkCiAgdGhpcy5yZWFkaW5nTW9yZSA9IGZhbHNlOwoKICB0aGlzLmRlY29kZXIgPSBudWxsOwogIHRoaXMuZW5jb2RpbmcgPSBudWxsOwogIGlmIChvcHRpb25zLmVuY29kaW5nKSB7CiAgICBpZiAoIVN0cmluZ0RlY29kZXIpCiAgICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogICAgdGhpcy5kZWNvZGVyID0gbmV3IFN0cmluZ0RlY29kZXIob3B0aW9ucy5lbmNvZGluZyk7CiAgICB0aGlzLmVuY29kaW5nID0gb3B0aW9ucy5lbmNvZGluZzsKICB9Cn0KCmZ1bmN0aW9uIFJlYWRhYmxlKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUmVhZGFibGUpKQogICAgcmV0dXJuIG5ldyBSZWFkYWJsZShvcHRpb25zKTsKCiAgdGhpcy5fcmVhZGFibGVTdGF0ZSA9IG5ldyBSZWFkYWJsZVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyBsZWdhY3kKICB0aGlzLnJlYWRhYmxlID0gdHJ1ZTsKCiAgU3RyZWFtLmNhbGwodGhpcyk7Cn0KCi8vIE1hbnVhbGx5IHNob3ZlIHNvbWV0aGluZyBpbnRvIHRoZSByZWFkKCkgYnVmZmVyLgovLyBUaGlzIHJldHVybnMgdHJ1ZSBpZiB0aGUgaGlnaFdhdGVyTWFyayBoYXMgbm90IGJlZW4gaGl0IHlldCwKLy8gc2ltaWxhciB0byBob3cgV3JpdGFibGUud3JpdGUoKSByZXR1cm5zIHRydWUgaWYgeW91IHNob3VsZAovLyB3cml0ZSgpIHNvbWUgbW9yZS4KUmVhZGFibGUucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwoKICBpZiAodHlwZW9mIGNodW5rID09PSAnc3RyaW5nJyAmJiAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBzdGF0ZS5kZWZhdWx0RW5jb2Rpbmc7CiAgICBpZiAoZW5jb2RpbmcgIT09IHN0YXRlLmVuY29kaW5nKSB7CiAgICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogICAgICBlbmNvZGluZyA9ICcnOwogICAgfQogIH0KCiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgZmFsc2UpOwp9OwoKLy8gVW5zaGlmdCBzaG91bGQgKmFsd2F5cyogYmUgc29tZXRoaW5nIGRpcmVjdGx5IG91dCBvZiByZWFkKCkKUmVhZGFibGUucHJvdG90eXBlLnVuc2hpZnQgPSBmdW5jdGlvbihjaHVuaykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCAnJywgdHJ1ZSk7Cn07CgpmdW5jdGlvbiByZWFkYWJsZUFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgYWRkVG9Gcm9udCkgewogIHZhciBlciA9IGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspOwogIGlmIChlcikgewogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIH0gZWxzZSBpZiAoY2h1bmsgPT09IG51bGwgfHwgY2h1bmsgPT09IHVuZGVmaW5lZCkgewogICAgc3RhdGUucmVhZGluZyA9IGZhbHNlOwogICAgaWYgKCFzdGF0ZS5lbmRlZCkKICAgICAgb25Fb2ZDaHVuayhzdHJlYW0sIHN0YXRlKTsKICB9IGVsc2UgaWYgKHN0YXRlLm9iamVjdE1vZGUgfHwgY2h1bmsgJiYgY2h1bmsubGVuZ3RoID4gMCkgewogICAgaWYgKHN0YXRlLmVuZGVkICYmICFhZGRUb0Zyb250KSB7CiAgICAgIHZhciBlID0gbmV3IEVycm9yKCdzdHJlYW0ucHVzaCgpIGFmdGVyIEVPRicpOwogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlKTsKICAgIH0gZWxzZSBpZiAoc3RhdGUuZW5kRW1pdHRlZCAmJiBhZGRUb0Zyb250KSB7CiAgICAgIHZhciBlID0gbmV3IEVycm9yKCdzdHJlYW0udW5zaGlmdCgpIGFmdGVyIGVuZCBldmVudCcpOwogICAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlKTsKICAgIH0gZWxzZSB7CiAgICAgIGlmIChzdGF0ZS5kZWNvZGVyICYmICFhZGRUb0Zyb250ICYmICFlbmNvZGluZykKICAgICAgICBjaHVuayA9IHN0YXRlLmRlY29kZXIud3JpdGUoY2h1bmspOwoKICAgICAgLy8gdXBkYXRlIHRoZSBidWZmZXIgaW5mby4KICAgICAgc3RhdGUubGVuZ3RoICs9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwogICAgICBpZiAoYWRkVG9Gcm9udCkgewogICAgICAgIHN0YXRlLmJ1ZmZlci51bnNoaWZ0KGNodW5rKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgICAgICAgc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICB9CgogICAgICBpZiAoc3RhdGUubmVlZFJlYWRhYmxlKQogICAgICAgIGVtaXRSZWFkYWJsZShzdHJlYW0pOwoKICAgICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICAgIH0KICB9IGVsc2UgaWYgKCFhZGRUb0Zyb250KSB7CiAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgfQoKICByZXR1cm4gbmVlZE1vcmVEYXRhKHN0YXRlKTsKfQoKCgovLyBpZiBpdCdzIHBhc3QgdGhlIGhpZ2ggd2F0ZXIgbWFyaywgd2UgY2FuIHB1c2ggaW4gc29tZSBtb3JlLgovLyBBbHNvLCBpZiB3ZSBoYXZlIG5vIGRhdGEgeWV0LCB3ZSBjYW4gc3RhbmQgc29tZQovLyBtb3JlIGJ5dGVzLiAgVGhpcyBpcyB0byB3b3JrIGFyb3VuZCBjYXNlcyB3aGVyZSBod209MCwKLy8gc3VjaCBhcyB0aGUgcmVwbC4gIEFsc28sIGlmIHRoZSBwdXNoKCkgdHJpZ2dlcmVkIGEKLy8gcmVhZGFibGUgZXZlbnQsIGFuZCB0aGUgdXNlciBjYWxsZWQgcmVhZChsYXJnZU51bWJlcikgc3VjaCB0aGF0Ci8vIG5lZWRSZWFkYWJsZSB3YXMgc2V0LCB0aGVuIHdlIG91Z2h0IHRvIHB1c2ggbW9yZSwgc28gdGhhdCBhbm90aGVyCi8vICdyZWFkYWJsZScgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQuCmZ1bmN0aW9uIG5lZWRNb3JlRGF0YShzdGF0ZSkgewogIHJldHVybiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgKHN0YXRlLm5lZWRSZWFkYWJsZSB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyayB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwKTsKfQoKLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuClJlYWRhYmxlLnByb3RvdHlwZS5zZXRFbmNvZGluZyA9IGZ1bmN0aW9uKGVuYykgewogIGlmICghU3RyaW5nRGVjb2RlcikKICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogIHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuYyk7CiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA9IGVuYzsKfTsKCi8vIERvbid0IHJhaXNlIHRoZSBod20gPiAxMjhNQgp2YXIgTUFYX0hXTSA9IDB4ODAwMDAwOwpmdW5jdGlvbiByb3VuZFVwVG9OZXh0UG93ZXJPZjIobikgewogIGlmIChuID49IE1BWF9IV00pIHsKICAgIG4gPSBNQVhfSFdNOwogIH0gZWxzZSB7CiAgICAvLyBHZXQgdGhlIG5leHQgaGlnaGVzdCBwb3dlciBvZiAyCiAgICBuLS07CiAgICBmb3IgKHZhciBwID0gMTsgcCA8IDMyOyBwIDw8PSAxKSBuIHw9IG4gPj4gcDsKICAgIG4rKzsKICB9CiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uIGhvd011Y2hUb1JlYWQobiwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLmVuZGVkKQogICAgcmV0dXJuIDA7CgogIGlmIChzdGF0ZS5vYmplY3RNb2RlKQogICAgcmV0dXJuIG4gPT09IDAgPyAwIDogMTsKCiAgaWYgKG4gPT09IG51bGwgfHwgaXNOYU4obikpIHsKICAgIC8vIG9ubHkgZmxvdyBvbmUgYnVmZmVyIGF0IGEgdGltZQogICAgaWYgKHN0YXRlLmZsb3dpbmcgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgcmV0dXJuIHN0YXRlLmJ1ZmZlclswXS5sZW5ndGg7CiAgICBlbHNlCiAgICAgIHJldHVybiBzdGF0ZS5sZW5ndGg7CiAgfQoKICBpZiAobiA8PSAwKQogICAgcmV0dXJuIDA7CgogIC8vIElmIHdlJ3JlIGFza2luZyBmb3IgbW9yZSB0aGFuIHRoZSB0YXJnZXQgYnVmZmVyIGxldmVsLAogIC8vIHRoZW4gcmFpc2UgdGhlIHdhdGVyIG1hcmsuICBCdW1wIHVwIHRvIHRoZSBuZXh0IGhpZ2hlc3QKICAvLyBwb3dlciBvZiAyLCB0byBwcmV2ZW50IGluY3JlYXNpbmcgaXQgZXhjZXNzaXZlbHkgaW4gdGlueQogIC8vIGFtb3VudHMuCiAgaWYgKG4gPiBzdGF0ZS5oaWdoV2F0ZXJNYXJrKQogICAgc3RhdGUuaGlnaFdhdGVyTWFyayA9IHJvdW5kVXBUb05leHRQb3dlck9mMihuKTsKCiAgLy8gZG9uJ3QgaGF2ZSB0aGF0IG11Y2guICByZXR1cm4gbnVsbCwgdW5sZXNzIHdlJ3ZlIGVuZGVkLgogIGlmIChuID4gc3RhdGUubGVuZ3RoKSB7CiAgICBpZiAoIXN0YXRlLmVuZGVkKSB7CiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIHJldHVybiAwOwogICAgfSBlbHNlCiAgICAgIHJldHVybiBzdGF0ZS5sZW5ndGg7CiAgfQoKICByZXR1cm4gbjsKfQoKLy8geW91IGNhbiBvdmVycmlkZSBlaXRoZXIgdGhpcyBtZXRob2QsIG9yIHRoZSBhc3luYyBfcmVhZChuKSBiZWxvdy4KUmVhZGFibGUucHJvdG90eXBlLnJlYWQgPSBmdW5jdGlvbihuKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICBzdGF0ZS5jYWxsZWRSZWFkID0gdHJ1ZTsKICB2YXIgbk9yaWcgPSBuOwogIHZhciByZXQ7CgogIGlmICh0eXBlb2YgbiAhPT0gJ251bWJlcicgfHwgbiA+IDApCiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSBmYWxzZTsKCiAgLy8gaWYgd2UncmUgZG9pbmcgcmVhZCgwKSB0byB0cmlnZ2VyIGEgcmVhZGFibGUgZXZlbnQsIGJ1dCB3ZQogIC8vIGFscmVhZHkgaGF2ZSBhIGJ1bmNoIG9mIGRhdGEgaW4gdGhlIGJ1ZmZlciwgdGhlbiBqdXN0IHRyaWdnZXIKICAvLyB0aGUgJ3JlYWRhYmxlJyBldmVudCBhbmQgbW92ZSBvbi4KICBpZiAobiA9PT0gMCAmJgogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgJiYKICAgICAgKHN0YXRlLmxlbmd0aCA+PSBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmVuZGVkKSkgewogICAgZW1pdFJlYWRhYmxlKHRoaXMpOwogICAgcmV0dXJuIG51bGw7CiAgfQoKICBuID0gaG93TXVjaFRvUmVhZChuLCBzdGF0ZSk7CgogIC8vIGlmIHdlJ3ZlIGVuZGVkLCBhbmQgd2UncmUgbm93IGNsZWFyLCB0aGVuIGZpbmlzaCBpdCB1cC4KICBpZiAobiA9PT0gMCAmJiBzdGF0ZS5lbmRlZCkgewogICAgcmV0ID0gbnVsbDsKCiAgICAvLyBJbiBjYXNlcyB3aGVyZSB0aGUgZGVjb2RlciBkaWQgbm90IHJlY2VpdmUgZW5vdWdoIGRhdGEKICAgIC8vIHRvIHByb2R1Y2UgYSBmdWxsIGNodW5rLCB0aGVuIGltbWVkaWF0ZWx5IHJlY2VpdmVkIGFuCiAgICAvLyBFT0YsIHN0YXRlLmJ1ZmZlciB3aWxsIGNvbnRhaW4gWzxCdWZmZXIgPiwgPEJ1ZmZlciAwMCAuLi4+XS4KICAgIC8vIGhvd011Y2hUb1JlYWQgd2lsbCBzZWUgdGhpcyBhbmQgY29lcmNlIHRoZSBhbW91bnQgdG8KICAgIC8vIHJlYWQgdG8gemVybyAoYmVjYXVzZSBpdCdzIGxvb2tpbmcgYXQgdGhlIGxlbmd0aCBvZiB0aGUKICAgIC8vIGZpcnN0IDxCdWZmZXIgPiBpbiBzdGF0ZS5idWZmZXIpLCBhbmQgd2UnbGwgZW5kIHVwIGhlcmUuCiAgICAvLwogICAgLy8gVGhpcyBjYW4gb25seSBoYXBwZW4gdmlhIHN0YXRlLmRlY29kZXIgLS0gbm8gb3RoZXIgdmVudWUKICAgIC8vIGV4aXN0cyBmb3IgcHVzaGluZyBhIHplcm8tbGVuZ3RoIGNodW5rIGludG8gc3RhdGUuYnVmZmVyCiAgICAvLyBhbmQgdHJpZ2dlcmluZyB0aGlzIGJlaGF2aW9yLiBJbiB0aGlzIGNhc2UsIHdlIHJldHVybiBvdXIKICAgIC8vIHJlbWFpbmluZyBkYXRhIGFuZCBlbmQgdGhlIHN0cmVhbSwgaWYgYXBwcm9wcmlhdGUuCiAgICBpZiAoc3RhdGUubGVuZ3RoID4gMCAmJiBzdGF0ZS5kZWNvZGVyKSB7CiAgICAgIHJldCA9IGZyb21MaXN0KG4sIHN0YXRlKTsKICAgICAgc3RhdGUubGVuZ3RoIC09IHJldC5sZW5ndGg7CiAgICB9CgogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkKICAgICAgZW5kUmVhZGFibGUodGhpcyk7CgogICAgcmV0dXJuIHJldDsKICB9CgogIC8vIEFsbCB0aGUgYWN0dWFsIGNodW5rIGdlbmVyYXRpb24gbG9naWMgbmVlZHMgdG8gYmUKICAvLyAqYmVsb3cqIHRoZSBjYWxsIHRvIF9yZWFkLiAgVGhlIHJlYXNvbiBpcyB0aGF0IGluIGNlcnRhaW4KICAvLyBzeW50aGV0aWMgc3RyZWFtIGNhc2VzLCBzdWNoIGFzIHBhc3N0aHJvdWdoIHN0cmVhbXMsIF9yZWFkCiAgLy8gbWF5IGJlIGEgY29tcGxldGVseSBzeW5jaHJvbm91cyBvcGVyYXRpb24gd2hpY2ggbWF5IGNoYW5nZQogIC8vIHRoZSBzdGF0ZSBvZiB0aGUgcmVhZCBidWZmZXIsIHByb3ZpZGluZyBlbm91Z2ggZGF0YSB3aGVuCiAgLy8gYmVmb3JlIHRoZXJlIHdhcyAqbm90KiBlbm91Z2guCiAgLy8KICAvLyBTbywgdGhlIHN0ZXBzIGFyZToKICAvLyAxLiBGaWd1cmUgb3V0IHdoYXQgdGhlIHN0YXRlIG9mIHRoaW5ncyB3aWxsIGJlIGFmdGVyIHdlIGRvCiAgLy8gYSByZWFkIGZyb20gdGhlIGJ1ZmZlci4KICAvLwogIC8vIDIuIElmIHRoYXQgcmVzdWx0aW5nIHN0YXRlIHdpbGwgdHJpZ2dlciBhIF9yZWFkLCB0aGVuIGNhbGwgX3JlYWQuCiAgLy8gTm90ZSB0aGF0IHRoaXMgbWF5IGJlIGFzeW5jaHJvbm91cywgb3Igc3luY2hyb25vdXMuICBZZXMsIGl0IGlzCiAgLy8gZGVlcGx5IHVnbHkgdG8gd3JpdGUgQVBJcyB0aGlzIHdheSwgYnV0IHRoYXQgc3RpbGwgZG9lc24ndCBtZWFuCiAgLy8gdGhhdCB0aGUgUmVhZGFibGUgY2xhc3Mgc2hvdWxkIGJlaGF2ZSBpbXByb3Blcmx5LCBhcyBzdHJlYW1zIGFyZQogIC8vIGRlc2lnbmVkIHRvIGJlIHN5bmMvYXN5bmMgYWdub3N0aWMuCiAgLy8gVGFrZSBub3RlIGlmIHRoZSBfcmVhZCBjYWxsIGlzIHN5bmMgb3IgYXN5bmMgKGllLCBpZiB0aGUgcmVhZCBjYWxsCiAgLy8gaGFzIHJldHVybmVkIHlldCksIHNvIHRoYXQgd2Uga25vdyB3aGV0aGVyIG9yIG5vdCBpdCdzIHNhZmUgdG8gZW1pdAogIC8vICdyZWFkYWJsZScgZXRjLgogIC8vCiAgLy8gMy4gQWN0dWFsbHkgcHVsbCB0aGUgcmVxdWVzdGVkIGNodW5rcyBvdXQgb2YgdGhlIGJ1ZmZlciBhbmQgcmV0dXJuLgoKICAvLyBpZiB3ZSBuZWVkIGEgcmVhZGFibGUgZXZlbnQsIHRoZW4gd2UgbmVlZCB0byBkbyBzb21lIHJlYWRpbmcuCiAgdmFyIGRvUmVhZCA9IHN0YXRlLm5lZWRSZWFkYWJsZTsKCiAgLy8gaWYgd2UgY3VycmVudGx5IGhhdmUgbGVzcyB0aGFuIHRoZSBoaWdoV2F0ZXJNYXJrLCB0aGVuIGFsc28gcmVhZCBzb21lCiAgaWYgKHN0YXRlLmxlbmd0aCAtIG4gPD0gc3RhdGUuaGlnaFdhdGVyTWFyaykKICAgIGRvUmVhZCA9IHRydWU7CgogIC8vIGhvd2V2ZXIsIGlmIHdlJ3ZlIGVuZGVkLCB0aGVuIHRoZXJlJ3Mgbm8gcG9pbnQsIGFuZCBpZiB3ZSdyZSBhbHJlYWR5CiAgLy8gcmVhZGluZywgdGhlbiBpdCdzIHVubmVjZXNzYXJ5LgogIGlmIChzdGF0ZS5lbmRlZCB8fCBzdGF0ZS5yZWFkaW5nKQogICAgZG9SZWFkID0gZmFsc2U7CgogIGlmIChkb1JlYWQpIHsKICAgIHN0YXRlLnJlYWRpbmcgPSB0cnVlOwogICAgc3RhdGUuc3luYyA9IHRydWU7CiAgICAvLyBpZiB0aGUgbGVuZ3RoIGlzIGN1cnJlbnRseSB6ZXJvLCB0aGVuIHdlICpuZWVkKiBhIHJlYWRhYmxlIGV2ZW50LgogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCkKICAgICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKICAgIC8vIGNhbGwgaW50ZXJuYWwgcmVhZCBtZXRob2QKICAgIHRoaXMuX3JlYWQoc3RhdGUuaGlnaFdhdGVyTWFyayk7CiAgICBzdGF0ZS5zeW5jID0gZmFsc2U7CiAgfQoKICAvLyBJZiBfcmVhZCBjYWxsZWQgaXRzIGNhbGxiYWNrIHN5bmNocm9ub3VzbHksIHRoZW4gYHJlYWRpbmdgCiAgLy8gd2lsbCBiZSBmYWxzZSwgYW5kIHdlIG5lZWQgdG8gcmUtZXZhbHVhdGUgaG93IG11Y2ggZGF0YSB3ZQogIC8vIGNhbiByZXR1cm4gdG8gdGhlIHVzZXIuCiAgaWYgKGRvUmVhZCAmJiAhc3RhdGUucmVhZGluZykKICAgIG4gPSBob3dNdWNoVG9SZWFkKG5PcmlnLCBzdGF0ZSk7CgogIGlmIChuID4gMCkKICAgIHJldCA9IGZyb21MaXN0KG4sIHN0YXRlKTsKICBlbHNlCiAgICByZXQgPSBudWxsOwoKICBpZiAocmV0ID09PSBudWxsKSB7CiAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgbiA9IDA7CiAgfQoKICBzdGF0ZS5sZW5ndGggLT0gbjsKCiAgLy8gSWYgd2UgaGF2ZSBub3RoaW5nIGluIHRoZSBidWZmZXIsIHRoZW4gd2Ugd2FudCB0byBrbm93CiAgLy8gYXMgc29vbiBhcyB3ZSAqZG8qIGdldCBzb21ldGhpbmcgaW50byB0aGUgYnVmZmVyLgogIGlmIChzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLmVuZGVkKQogICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gSWYgd2UgaGFwcGVuZWQgdG8gcmVhZCgpIGV4YWN0bHkgdGhlIHJlbWFpbmluZyBhbW91bnQgaW4gdGhlCiAgLy8gYnVmZmVyLCBhbmQgdGhlIEVPRiBoYXMgYmVlbiBzZWVuIGF0IHRoaXMgcG9pbnQsIHRoZW4gbWFrZSBzdXJlCiAgLy8gdGhhdCB3ZSBlbWl0ICdlbmQnIG9uIHRoZSB2ZXJ5IG5leHQgdGljay4KICBpZiAoc3RhdGUuZW5kZWQgJiYgIXN0YXRlLmVuZEVtaXR0ZWQgJiYgc3RhdGUubGVuZ3RoID09PSAwKQogICAgZW5kUmVhZGFibGUodGhpcyk7CgogIHJldHVybiByZXQ7Cn07CgpmdW5jdGlvbiBjaHVua0ludmFsaWQoc3RhdGUsIGNodW5rKSB7CiAgdmFyIGVyID0gbnVsbDsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgJ3N0cmluZycgIT09IHR5cGVvZiBjaHVuayAmJgogICAgICBjaHVuayAhPT0gbnVsbCAmJgogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmCiAgICAgICFzdGF0ZS5vYmplY3RNb2RlKSB7CiAgICBlciA9IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgbm9uLXN0cmluZy9idWZmZXIgY2h1bmsnKTsKICB9CiAgcmV0dXJuIGVyOwp9CgoKZnVuY3Rpb24gb25Fb2ZDaHVuayhzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKHN0YXRlLmRlY29kZXIgJiYgIXN0YXRlLmVuZGVkKSB7CiAgICB2YXIgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLmVuZCgpOwogICAgaWYgKGNodW5rICYmIGNodW5rLmxlbmd0aCkgewogICAgICBzdGF0ZS5idWZmZXIucHVzaChjaHVuayk7CiAgICAgIHN0YXRlLmxlbmd0aCArPSBzdGF0ZS5vYmplY3RNb2RlID8gMSA6IGNodW5rLmxlbmd0aDsKICAgIH0KICB9CiAgc3RhdGUuZW5kZWQgPSB0cnVlOwoKICAvLyBpZiB3ZSd2ZSBlbmRlZCBhbmQgd2UgaGF2ZSBzb21lIGRhdGEgbGVmdCwgdGhlbiBlbWl0CiAgLy8gJ3JlYWRhYmxlJyBub3cgdG8gbWFrZSBzdXJlIGl0IGdldHMgcGlja2VkIHVwLgogIGlmIChzdGF0ZS5sZW5ndGggPiAwKQogICAgZW1pdFJlYWRhYmxlKHN0cmVhbSk7CiAgZWxzZQogICAgZW5kUmVhZGFibGUoc3RyZWFtKTsKfQoKLy8gRG9uJ3QgZW1pdCByZWFkYWJsZSByaWdodCBhd2F5IGluIHN5bmMgbW9kZSwgYmVjYXVzZSB0aGlzIGNhbiB0cmlnZ2VyCi8vIGFub3RoZXIgcmVhZCgpIGNhbGwgPT4gc3RhY2sgb3ZlcmZsb3cuICBUaGlzIHdheSwgaXQgbWlnaHQgdHJpZ2dlcgovLyBhIG5leHRUaWNrIHJlY3Vyc2lvbiB3YXJuaW5nLCBidXQgdGhhdCdzIG5vdCBzbyBiYWQuCmZ1bmN0aW9uIGVtaXRSZWFkYWJsZShzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgc3RhdGUubmVlZFJlYWRhYmxlID0gZmFsc2U7CiAgaWYgKHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSkKICAgIHJldHVybjsKCiAgc3RhdGUuZW1pdHRlZFJlYWRhYmxlID0gdHJ1ZTsKICBpZiAoc3RhdGUuc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIGVtaXRSZWFkYWJsZV8oc3RyZWFtKTsKICAgIH0pOwogIGVsc2UKICAgIGVtaXRSZWFkYWJsZV8oc3RyZWFtKTsKfQoKZnVuY3Rpb24gZW1pdFJlYWRhYmxlXyhzdHJlYW0pIHsKICBzdHJlYW0uZW1pdCgncmVhZGFibGUnKTsKfQoKCi8vIGF0IHRoaXMgcG9pbnQsIHRoZSB1c2VyIGhhcyBwcmVzdW1hYmx5IHNlZW4gdGhlICdyZWFkYWJsZScgZXZlbnQsCi8vIGFuZCBjYWxsZWQgcmVhZCgpIHRvIGNvbnN1bWUgc29tZSBkYXRhLiAgdGhhdCBtYXkgaGF2ZSB0cmlnZ2VyZWQKLy8gaW4gdHVybiBhbm90aGVyIF9yZWFkKG4pIGNhbGwsIGluIHdoaWNoIGNhc2UgcmVhZGluZyA9IHRydWUgaWYKLy8gaXQncyBpbiBwcm9ncmVzcy4KLy8gSG93ZXZlciwgaWYgd2UncmUgbm90IGVuZGVkLCBvciByZWFkaW5nLCBhbmQgdGhlIGxlbmd0aCA8IGh3bSwKLy8gdGhlbiBnbyBhaGVhZCBhbmQgdHJ5IHRvIHJlYWQgc29tZSBtb3JlIHByZWVtcHRpdmVseS4KZnVuY3Rpb24gbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5yZWFkaW5nTW9yZSkgewogICAgc3RhdGUucmVhZGluZ01vcmUgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgbWF5YmVSZWFkTW9yZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG1heWJlUmVhZE1vcmVfKHN0cmVhbSwgc3RhdGUpIHsKICB2YXIgbGVuID0gc3RhdGUubGVuZ3RoOwogIHdoaWxlICghc3RhdGUucmVhZGluZyAmJiAhc3RhdGUuZmxvd2luZyAmJiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyaykgewogICAgc3RyZWFtLnJlYWQoMCk7CiAgICBpZiAobGVuID09PSBzdGF0ZS5sZW5ndGgpCiAgICAgIC8vIGRpZG4ndCBnZXQgYW55IGRhdGEsIHN0b3Agc3Bpbm5pbmcuCiAgICAgIGJyZWFrOwogICAgZWxzZQogICAgICBsZW4gPSBzdGF0ZS5sZW5ndGg7CiAgfQogIHN0YXRlLnJlYWRpbmdNb3JlID0gZmFsc2U7Cn0KCi8vIGFic3RyYWN0IG1ldGhvZC4gIHRvIGJlIG92ZXJyaWRkZW4gaW4gc3BlY2lmaWMgaW1wbGVtZW50YXRpb24gY2xhc3Nlcy4KLy8gY2FsbCBjYihlciwgZGF0YSkgd2hlcmUgZGF0YSBpcyA8PSBuIGluIGxlbmd0aC4KLy8gZm9yIHZpcnR1YWwgKG5vbi1zdHJpbmcsIG5vbi1idWZmZXIpIHN0cmVhbXMsICJsZW5ndGgiIGlzIHNvbWV3aGF0Ci8vIGFyYml0cmFyeSwgYW5kIHBlcmhhcHMgbm90IHZlcnkgbWVhbmluZ2Z1bC4KUmVhZGFibGUucHJvdG90eXBlLl9yZWFkID0gZnVuY3Rpb24obikgewogIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpKTsKfTsKClJlYWRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oZGVzdCwgcGlwZU9wdHMpIHsKICB2YXIgc3JjID0gdGhpczsKICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwoKICBzd2l0Y2ggKHN0YXRlLnBpcGVzQ291bnQpIHsKICAgIGNhc2UgMDoKICAgICAgc3RhdGUucGlwZXMgPSBkZXN0OwogICAgICBicmVhazsKICAgIGNhc2UgMToKICAgICAgc3RhdGUucGlwZXMgPSBbc3RhdGUucGlwZXMsIGRlc3RdOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHN0YXRlLnBpcGVzLnB1c2goZGVzdCk7CiAgICAgIGJyZWFrOwogIH0KICBzdGF0ZS5waXBlc0NvdW50ICs9IDE7CgogIHZhciBkb0VuZCA9ICghcGlwZU9wdHMgfHwgcGlwZU9wdHMuZW5kICE9PSBmYWxzZSkgJiYKICAgICAgICAgICAgICBkZXN0ICE9PSBwcm9jZXNzLnN0ZG91dCAmJgogICAgICAgICAgICAgIGRlc3QgIT09IHByb2Nlc3Muc3RkZXJyOwoKICB2YXIgZW5kRm4gPSBkb0VuZCA/IG9uZW5kIDogY2xlYW51cDsKICBpZiAoc3RhdGUuZW5kRW1pdHRlZCkKICAgIHByb2Nlc3MubmV4dFRpY2soZW5kRm4pOwogIGVsc2UKICAgIHNyYy5vbmNlKCdlbmQnLCBlbmRGbik7CgogIGRlc3Qub24oJ3VucGlwZScsIG9udW5waXBlKTsKICBmdW5jdGlvbiBvbnVucGlwZShyZWFkYWJsZSkgewogICAgaWYgKHJlYWRhYmxlICE9PSBzcmMpIHJldHVybjsKICAgIGNsZWFudXAoKTsKICB9CgogIGZ1bmN0aW9uIG9uZW5kKCkgewogICAgZGVzdC5lbmQoKTsKICB9CgogIC8vIHdoZW4gdGhlIGRlc3QgZHJhaW5zLCBpdCByZWR1Y2VzIHRoZSBhd2FpdERyYWluIGNvdW50ZXIKICAvLyBvbiB0aGUgc291cmNlLiAgVGhpcyB3b3VsZCBiZSBtb3JlIGVsZWdhbnQgd2l0aCBhIC5vbmNlKCkKICAvLyBoYW5kbGVyIGluIGZsb3coKSwgYnV0IGFkZGluZyBhbmQgcmVtb3ZpbmcgcmVwZWF0ZWRseSBpcwogIC8vIHRvbyBzbG93LgogIHZhciBvbmRyYWluID0gcGlwZU9uRHJhaW4oc3JjKTsKICBkZXN0Lm9uKCdkcmFpbicsIG9uZHJhaW4pOwoKICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgLy8gY2xlYW51cCBldmVudCBoYW5kbGVycyBvbmNlIHRoZSBwaXBlIGlzIGJyb2tlbgogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2RyYWluJywgb25kcmFpbik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcigndW5waXBlJywgb251bnBpcGUpOwogICAgc3JjLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCBvbmVuZCk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIGNsZWFudXApOwoKICAgIC8vIGlmIHRoZSByZWFkZXIgaXMgd2FpdGluZyBmb3IgYSBkcmFpbiBldmVudCBmcm9tIHRoaXMKICAgIC8vIHNwZWNpZmljIHdyaXRlciwgdGhlbiBpdCB3b3VsZCBjYXVzZSBpdCB0byBuZXZlciBzdGFydAogICAgLy8gZmxvd2luZyBhZ2Fpbi4KICAgIC8vIFNvLCBpZiB0aGlzIGlzIGF3YWl0aW5nIGEgZHJhaW4sIHRoZW4gd2UganVzdCBjYWxsIGl0IG5vdy4KICAgIC8vIElmIHdlIGRvbid0IGtub3csIHRoZW4gYXNzdW1lIHRoYXQgd2UgYXJlIHdhaXRpbmcgZm9yIG9uZS4KICAgIGlmICghZGVzdC5fd3JpdGFibGVTdGF0ZSB8fCBkZXN0Ll93cml0YWJsZVN0YXRlLm5lZWREcmFpbikKICAgICAgb25kcmFpbigpOwogIH0KCiAgLy8gaWYgdGhlIGRlc3QgaGFzIGFuIGVycm9yLCB0aGVuIHN0b3AgcGlwaW5nIGludG8gaXQuCiAgLy8gaG93ZXZlciwgZG9uJ3Qgc3VwcHJlc3MgdGhlIHRocm93aW5nIGJlaGF2aW9yIGZvciB0aGlzLgogIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgIHVucGlwZSgpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZXJyb3InLCBvbmVycm9yKTsKICAgIGlmIChFRS5saXN0ZW5lckNvdW50KGRlc3QsICdlcnJvcicpID09PSAwKQogICAgICBkZXN0LmVtaXQoJ2Vycm9yJywgZXIpOwogIH0KICAvLyBUaGlzIGlzIGEgYnJ1dGFsbHkgdWdseSBoYWNrIHRvIG1ha2Ugc3VyZSB0aGF0IG91ciBlcnJvciBoYW5kbGVyCiAgLy8gaXMgYXR0YWNoZWQgYmVmb3JlIGFueSB1c2VybGFuZCBvbmVzLiAgTkVWRVIgRE8gVEhJUy4KICBpZiAoIWRlc3QuX2V2ZW50cyB8fCAhZGVzdC5fZXZlbnRzLmVycm9yKQogICAgZGVzdC5vbignZXJyb3InLCBvbmVycm9yKTsKICBlbHNlIGlmIChpc0FycmF5KGRlc3QuX2V2ZW50cy5lcnJvcikpCiAgICBkZXN0Ll9ldmVudHMuZXJyb3IudW5zaGlmdChvbmVycm9yKTsKICBlbHNlCiAgICBkZXN0Ll9ldmVudHMuZXJyb3IgPSBbb25lcnJvciwgZGVzdC5fZXZlbnRzLmVycm9yXTsKCgoKICAvLyBCb3RoIGNsb3NlIGFuZCBmaW5pc2ggc2hvdWxkIHRyaWdnZXIgdW5waXBlLCBidXQgb25seSBvbmNlLgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdmaW5pc2gnLCBvbmZpbmlzaCk7CiAgICB1bnBpcGUoKTsKICB9CiAgZGVzdC5vbmNlKCdjbG9zZScsIG9uY2xvc2UpOwogIGZ1bmN0aW9uIG9uZmluaXNoKCkgewogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKICAgIHVucGlwZSgpOwogIH0KICBkZXN0Lm9uY2UoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKCiAgZnVuY3Rpb24gdW5waXBlKCkgewogICAgc3JjLnVucGlwZShkZXN0KTsKICB9CgogIC8vIHRlbGwgdGhlIGRlc3QgdGhhdCBpdCdzIGJlaW5nIHBpcGVkIHRvCiAgZGVzdC5lbWl0KCdwaXBlJywgc3JjKTsKCiAgLy8gc3RhcnQgdGhlIGZsb3cgaWYgaXQgaGFzbid0IGJlZW4gc3RhcnRlZCBhbHJlYWR5LgogIGlmICghc3RhdGUuZmxvd2luZykgewogICAgLy8gdGhlIGhhbmRsZXIgdGhhdCB3YWl0cyBmb3IgcmVhZGFibGUgZXZlbnRzIGFmdGVyIGFsbAogICAgLy8gdGhlIGRhdGEgZ2V0cyBzdWNrZWQgb3V0IGluIGZsb3cuCiAgICAvLyBUaGlzIHdvdWxkIGJlIGVhc2llciB0byBmb2xsb3cgd2l0aCBhIC5vbmNlKCkgaGFuZGxlcgogICAgLy8gaW4gZmxvdygpLCBidXQgdGhhdCBpcyB0b28gc2xvdy4KICAgIHRoaXMub24oJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwoKICAgIHN0YXRlLmZsb3dpbmcgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgZmxvdyhzcmMpOwogICAgfSk7CiAgfQoKICByZXR1cm4gZGVzdDsKfTsKCmZ1bmN0aW9uIHBpcGVPbkRyYWluKHNyYykgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHZhciBkZXN0ID0gdGhpczsKICAgIHZhciBzdGF0ZSA9IHNyYy5fcmVhZGFibGVTdGF0ZTsKICAgIHN0YXRlLmF3YWl0RHJhaW4tLTsKICAgIGlmIChzdGF0ZS5hd2FpdERyYWluID09PSAwKQogICAgICBmbG93KHNyYyk7CiAgfTsKfQoKZnVuY3Rpb24gZmxvdyhzcmMpIHsKICB2YXIgc3RhdGUgPSBzcmMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIGNodW5rOwogIHN0YXRlLmF3YWl0RHJhaW4gPSAwOwoKICBmdW5jdGlvbiB3cml0ZShkZXN0LCBpLCBsaXN0KSB7CiAgICB2YXIgd3JpdHRlbiA9IGRlc3Qud3JpdGUoY2h1bmspOwogICAgaWYgKGZhbHNlID09PSB3cml0dGVuKSB7CiAgICAgIHN0YXRlLmF3YWl0RHJhaW4rKzsKICAgIH0KICB9CgogIHdoaWxlIChzdGF0ZS5waXBlc0NvdW50ICYmIG51bGwgIT09IChjaHVuayA9IHNyYy5yZWFkKCkpKSB7CgogICAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICAgIHdyaXRlKHN0YXRlLnBpcGVzLCAwLCBudWxsKTsKICAgIGVsc2UKICAgICAgZm9yRWFjaChzdGF0ZS5waXBlcywgd3JpdGUpOwoKICAgIHNyYy5lbWl0KCdkYXRhJywgY2h1bmspOwoKICAgIC8vIGlmIGFueW9uZSBuZWVkcyBhIGRyYWluLCB0aGVuIHdlIGhhdmUgdG8gd2FpdCBmb3IgdGhhdC4KICAgIGlmIChzdGF0ZS5hd2FpdERyYWluID4gMCkKICAgICAgcmV0dXJuOwogIH0KCiAgLy8gaWYgZXZlcnkgZGVzdGluYXRpb24gd2FzIHVucGlwZWQsIGVpdGhlciBiZWZvcmUgZW50ZXJpbmcgdGhpcwogIC8vIGZ1bmN0aW9uLCBvciBpbiB0aGUgd2hpbGUgbG9vcCwgdGhlbiBzdG9wIGZsb3dpbmcuCiAgLy8KICAvLyBOQjogVGhpcyBpcyBhIHByZXR0eSByYXJlIGVkZ2UgY2FzZS4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMCkgewogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIC8vIGlmIHRoZXJlIHdlcmUgZGF0YSBldmVudCBsaXN0ZW5lcnMgYWRkZWQsIHRoZW4gc3dpdGNoIHRvIG9sZCBtb2RlLgogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQoc3JjLCAnZGF0YScpID4gMCkKICAgICAgZW1pdERhdGFFdmVudHMoc3JjKTsKICAgIHJldHVybjsKICB9CgogIC8vIGF0IHRoaXMgcG9pbnQsIG5vIG9uZSBuZWVkZWQgYSBkcmFpbiwgc28gd2UganVzdCByYW4gb3V0IG9mIGRhdGEKICAvLyBvbiB0aGUgbmV4dCByZWFkYWJsZSBldmVudCwgc3RhcnQgaXQgb3ZlciBhZ2Fpbi4KICBzdGF0ZS5yYW5PdXQgPSB0cnVlOwp9CgpmdW5jdGlvbiBwaXBlT25SZWFkYWJsZSgpIHsKICBpZiAodGhpcy5fcmVhZGFibGVTdGF0ZS5yYW5PdXQpIHsKICAgIHRoaXMuX3JlYWRhYmxlU3RhdGUucmFuT3V0ID0gZmFsc2U7CiAgICBmbG93KHRoaXMpOwogIH0KfQoKClJlYWRhYmxlLnByb3RvdHlwZS51bnBpcGUgPSBmdW5jdGlvbihkZXN0KSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKCiAgLy8gaWYgd2UncmUgbm90IHBpcGluZyBhbnl3aGVyZSwgdGhlbiBkbyBub3RoaW5nLgogIGlmIChzdGF0ZS5waXBlc0NvdW50ID09PSAwKQogICAgcmV0dXJuIHRoaXM7CgogIC8vIGp1c3Qgb25lIGRlc3RpbmF0aW9uLiAgbW9zdCBjb21tb24gY2FzZS4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMSkgewogICAgLy8gcGFzc2VkIGluIG9uZSwgYnV0IGl0J3Mgbm90IHRoZSByaWdodCBvbmUuCiAgICBpZiAoZGVzdCAmJiBkZXN0ICE9PSBzdGF0ZS5waXBlcykKICAgICAgcmV0dXJuIHRoaXM7CgogICAgaWYgKCFkZXN0KQogICAgICBkZXN0ID0gc3RhdGUucGlwZXM7CgogICAgLy8gZ290IGEgbWF0Y2guCiAgICBzdGF0ZS5waXBlcyA9IG51bGw7CiAgICBzdGF0ZS5waXBlc0NvdW50ID0gMDsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwogICAgaWYgKGRlc3QpCiAgICAgIGRlc3QuZW1pdCgndW5waXBlJywgdGhpcyk7CiAgICByZXR1cm4gdGhpczsKICB9CgogIC8vIHNsb3cgY2FzZS4gbXVsdGlwbGUgcGlwZSBkZXN0aW5hdGlvbnMuCgogIGlmICghZGVzdCkgewogICAgLy8gcmVtb3ZlIGFsbC4KICAgIHZhciBkZXN0cyA9IHN0YXRlLnBpcGVzOwogICAgdmFyIGxlbiA9IHN0YXRlLnBpcGVzQ291bnQ7CiAgICBzdGF0ZS5waXBlcyA9IG51bGw7CiAgICBzdGF0ZS5waXBlc0NvdW50ID0gMDsKICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3JlYWRhYmxlJywgcGlwZU9uUmVhZGFibGUpOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGRlc3RzW2ldLmVtaXQoJ3VucGlwZScsIHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyB0cnkgdG8gZmluZCB0aGUgcmlnaHQgb25lLgogIHZhciBpID0gaW5kZXhPZihzdGF0ZS5waXBlcywgZGVzdCk7CiAgaWYgKGkgPT09IC0xKQogICAgcmV0dXJuIHRoaXM7CgogIHN0YXRlLnBpcGVzLnNwbGljZShpLCAxKTsKICBzdGF0ZS5waXBlc0NvdW50IC09IDE7CiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICBzdGF0ZS5waXBlcyA9IHN0YXRlLnBpcGVzWzBdOwoKICBkZXN0LmVtaXQoJ3VucGlwZScsIHRoaXMpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIHNldCB1cCBkYXRhIGV2ZW50cyBpZiB0aGV5IGFyZSBhc2tlZCBmb3IKLy8gRW5zdXJlIHJlYWRhYmxlIGxpc3RlbmVycyBldmVudHVhbGx5IGdldCBzb21ldGhpbmcKUmVhZGFibGUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXYsIGZuKSB7CiAgdmFyIHJlcyA9IFN0cmVhbS5wcm90b3R5cGUub24uY2FsbCh0aGlzLCBldiwgZm4pOwoKICBpZiAoZXYgPT09ICdkYXRhJyAmJiAhdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nKQogICAgZW1pdERhdGFFdmVudHModGhpcyk7CgogIGlmIChldiA9PT0gJ3JlYWRhYmxlJyAmJiB0aGlzLnJlYWRhYmxlKSB7CiAgICB2YXIgc3RhdGUgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKCFzdGF0ZS5yZWFkYWJsZUxpc3RlbmluZykgewogICAgICBzdGF0ZS5yZWFkYWJsZUxpc3RlbmluZyA9IHRydWU7CiAgICAgIHN0YXRlLmVtaXR0ZWRSZWFkYWJsZSA9IGZhbHNlOwogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgICBpZiAoIXN0YXRlLnJlYWRpbmcpIHsKICAgICAgICB0aGlzLnJlYWQoMCk7CiAgICAgIH0gZWxzZSBpZiAoc3RhdGUubGVuZ3RoKSB7CiAgICAgICAgZW1pdFJlYWRhYmxlKHRoaXMsIHN0YXRlKTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfTsKUmVhZGFibGUucHJvdG90eXBlLmFkZExpc3RlbmVyID0gUmVhZGFibGUucHJvdG90eXBlLm9uOwoKLy8gcGF1c2UoKSBhbmQgcmVzdW1lKCkgYXJlIHJlbW5hbnRzIG9mIHRoZSBsZWdhY3kgcmVhZGFibGUgc3RyZWFtIEFQSQovLyBJZiB0aGUgdXNlciB1c2VzIHRoZW0sIHRoZW4gc3dpdGNoIGludG8gb2xkIG1vZGUuClJlYWRhYmxlLnByb3RvdHlwZS5yZXN1bWUgPSBmdW5jdGlvbigpIHsKICBlbWl0RGF0YUV2ZW50cyh0aGlzKTsKICB0aGlzLnJlYWQoMCk7CiAgdGhpcy5lbWl0KCdyZXN1bWUnKTsKfTsKClJlYWRhYmxlLnByb3RvdHlwZS5wYXVzZSA9IGZ1bmN0aW9uKCkgewogIGVtaXREYXRhRXZlbnRzKHRoaXMsIHRydWUpOwogIHRoaXMuZW1pdCgncGF1c2UnKTsKfTsKCmZ1bmN0aW9uIGVtaXREYXRhRXZlbnRzKHN0cmVhbSwgc3RhcnRQYXVzZWQpIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CgogIGlmIChzdGF0ZS5mbG93aW5nKSB7CiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vaXNhYWNzL3JlYWRhYmxlLXN0cmVhbS9pc3N1ZXMvMTYKICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHN3aXRjaCB0byBvbGQgbW9kZSBub3cuJyk7CiAgfQoKICB2YXIgcGF1c2VkID0gc3RhcnRQYXVzZWQgfHwgZmFsc2U7CiAgdmFyIHJlYWRhYmxlID0gZmFsc2U7CgogIC8vIGNvbnZlcnQgdG8gYW4gb2xkLXN0eWxlIHN0cmVhbS4KICBzdHJlYW0ucmVhZGFibGUgPSB0cnVlOwogIHN0cmVhbS5waXBlID0gU3RyZWFtLnByb3RvdHlwZS5waXBlOwogIHN0cmVhbS5vbiA9IHN0cmVhbS5hZGRMaXN0ZW5lciA9IFN0cmVhbS5wcm90b3R5cGUub247CgogIHN0cmVhbS5vbigncmVhZGFibGUnLCBmdW5jdGlvbigpIHsKICAgIHJlYWRhYmxlID0gdHJ1ZTsKCiAgICB2YXIgYzsKICAgIHdoaWxlICghcGF1c2VkICYmIChudWxsICE9PSAoYyA9IHN0cmVhbS5yZWFkKCkpKSkKICAgICAgc3RyZWFtLmVtaXQoJ2RhdGEnLCBjKTsKCiAgICBpZiAoYyA9PT0gbnVsbCkgewogICAgICByZWFkYWJsZSA9IGZhbHNlOwogICAgICBzdHJlYW0uX3JlYWRhYmxlU3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKICAgIH0KICB9KTsKCiAgc3RyZWFtLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgICBwYXVzZWQgPSB0cnVlOwogICAgdGhpcy5lbWl0KCdwYXVzZScpOwogIH07CgogIHN0cmVhbS5yZXN1bWUgPSBmdW5jdGlvbigpIHsKICAgIHBhdXNlZCA9IGZhbHNlOwogICAgaWYgKHJlYWRhYmxlKQogICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgdGhpcy5yZWFkKDApOwogICAgdGhpcy5lbWl0KCdyZXN1bWUnKTsKICB9OwoKICAvLyBub3cgbWFrZSBpdCBzdGFydCwganVzdCBpbiBjYXNlIGl0IGhhZG4ndCBhbHJlYWR5LgogIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwp9CgovLyB3cmFwIGFuIG9sZC1zdHlsZSBzdHJlYW0gYXMgdGhlIGFzeW5jIGRhdGEgc291cmNlLgovLyBUaGlzIGlzICpub3QqIHBhcnQgb2YgdGhlIHJlYWRhYmxlIHN0cmVhbSBpbnRlcmZhY2UuCi8vIEl0IGlzIGFuIHVnbHkgdW5mb3J0dW5hdGUgbWVzcyBvZiBoaXN0b3J5LgpSZWFkYWJsZS5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIHBhdXNlZCA9IGZhbHNlOwoKICB2YXIgc2VsZiA9IHRoaXM7CiAgc3RyZWFtLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgIGlmIChzdGF0ZS5kZWNvZGVyICYmICFzdGF0ZS5lbmRlZCkgewogICAgICB2YXIgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLmVuZCgpOwogICAgICBpZiAoY2h1bmsgJiYgY2h1bmsubGVuZ3RoKQogICAgICAgIHNlbGYucHVzaChjaHVuayk7CiAgICB9CgogICAgc2VsZi5wdXNoKG51bGwpOwogIH0pOwoKICBzdHJlYW0ub24oJ2RhdGEnLCBmdW5jdGlvbihjaHVuaykgewogICAgaWYgKHN0YXRlLmRlY29kZXIpCiAgICAgIGNodW5rID0gc3RhdGUuZGVjb2Rlci53cml0ZShjaHVuayk7CgogICAgLy8gZG9uJ3Qgc2tpcCBvdmVyIGZhbHN5IHZhbHVlcyBpbiBvYmplY3RNb2RlCiAgICAvL2lmIChzdGF0ZS5vYmplY3RNb2RlICYmIHV0aWwuaXNOdWxsT3JVbmRlZmluZWQoY2h1bmspKQogICAgaWYgKHN0YXRlLm9iamVjdE1vZGUgJiYgKGNodW5rID09PSBudWxsIHx8IGNodW5rID09PSB1bmRlZmluZWQpKQogICAgICByZXR1cm47CiAgICBlbHNlIGlmICghc3RhdGUub2JqZWN0TW9kZSAmJiAoIWNodW5rIHx8ICFjaHVuay5sZW5ndGgpKQogICAgICByZXR1cm47CgogICAgdmFyIHJldCA9IHNlbGYucHVzaChjaHVuayk7CiAgICBpZiAoIXJldCkgewogICAgICBwYXVzZWQgPSB0cnVlOwogICAgICBzdHJlYW0ucGF1c2UoKTsKICAgIH0KICB9KTsKCiAgLy8gcHJveHkgYWxsIHRoZSBvdGhlciBtZXRob2RzLgogIC8vIGltcG9ydGFudCB3aGVuIHdyYXBwaW5nIGZpbHRlcnMgYW5kIGR1cGxleGVzLgogIGZvciAodmFyIGkgaW4gc3RyZWFtKSB7CiAgICBpZiAodHlwZW9mIHN0cmVhbVtpXSA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgIHR5cGVvZiB0aGlzW2ldID09PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzW2ldID0gZnVuY3Rpb24obWV0aG9kKSB7IHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3RyZWFtW21ldGhvZF0uYXBwbHkoc3RyZWFtLCBhcmd1bWVudHMpOwogICAgICB9fShpKTsKICAgIH0KICB9CgogIC8vIHByb3h5IGNlcnRhaW4gaW1wb3J0YW50IGV2ZW50cy4KICB2YXIgZXZlbnRzID0gWydlcnJvcicsICdjbG9zZScsICdkZXN0cm95JywgJ3BhdXNlJywgJ3Jlc3VtZSddOwogIGZvckVhY2goZXZlbnRzLCBmdW5jdGlvbihldikgewogICAgc3RyZWFtLm9uKGV2LCBzZWxmLmVtaXQuYmluZChzZWxmLCBldikpOwogIH0pOwoKICAvLyB3aGVuIHdlIHRyeSB0byBjb25zdW1lIHNvbWUgbW9yZSBieXRlcywgc2ltcGx5IHVucGF1c2UgdGhlCiAgLy8gdW5kZXJseWluZyBzdHJlYW0uCiAgc2VsZi5fcmVhZCA9IGZ1bmN0aW9uKG4pIHsKICAgIGlmIChwYXVzZWQpIHsKICAgICAgcGF1c2VkID0gZmFsc2U7CiAgICAgIHN0cmVhbS5yZXN1bWUoKTsKICAgIH0KICB9OwoKICByZXR1cm4gc2VsZjsKfTsKCgoKLy8gZXhwb3NlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LgpSZWFkYWJsZS5fZnJvbUxpc3QgPSBmcm9tTGlzdDsKCi8vIFBsdWNrIG9mZiBuIGJ5dGVzIGZyb20gYW4gYXJyYXkgb2YgYnVmZmVycy4KLy8gTGVuZ3RoIGlzIHRoZSBjb21iaW5lZCBsZW5ndGhzIG9mIGFsbCB0aGUgYnVmZmVycyBpbiB0aGUgbGlzdC4KZnVuY3Rpb24gZnJvbUxpc3Qobiwgc3RhdGUpIHsKICB2YXIgbGlzdCA9IHN0YXRlLmJ1ZmZlcjsKICB2YXIgbGVuZ3RoID0gc3RhdGUubGVuZ3RoOwogIHZhciBzdHJpbmdNb2RlID0gISFzdGF0ZS5kZWNvZGVyOwogIHZhciBvYmplY3RNb2RlID0gISFzdGF0ZS5vYmplY3RNb2RlOwogIHZhciByZXQ7CgogIC8vIG5vdGhpbmcgaW4gdGhlIGxpc3QsIGRlZmluaXRlbHkgZW1wdHkuCiAgaWYgKGxpc3QubGVuZ3RoID09PSAwKQogICAgcmV0dXJuIG51bGw7CgogIGlmIChsZW5ndGggPT09IDApCiAgICByZXQgPSBudWxsOwogIGVsc2UgaWYgKG9iamVjdE1vZGUpCiAgICByZXQgPSBsaXN0LnNoaWZ0KCk7CiAgZWxzZSBpZiAoIW4gfHwgbiA+PSBsZW5ndGgpIHsKICAgIC8vIHJlYWQgaXQgYWxsLCB0cnVuY2F0ZSB0aGUgYXJyYXkuCiAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgcmV0ID0gbGlzdC5qb2luKCcnKTsKICAgIGVsc2UKICAgICAgcmV0ID0gQnVmZmVyLmNvbmNhdChsaXN0LCBsZW5ndGgpOwogICAgbGlzdC5sZW5ndGggPSAwOwogIH0gZWxzZSB7CiAgICAvLyByZWFkIGp1c3Qgc29tZSBvZiBpdC4KICAgIGlmIChuIDwgbGlzdFswXS5sZW5ndGgpIHsKICAgICAgLy8ganVzdCB0YWtlIGEgcGFydCBvZiB0aGUgZmlyc3QgbGlzdCBpdGVtLgogICAgICAvLyBzbGljZSBpcyB0aGUgc2FtZSBmb3IgYnVmZmVycyBhbmQgc3RyaW5ncy4KICAgICAgdmFyIGJ1ZiA9IGxpc3RbMF07CiAgICAgIHJldCA9IGJ1Zi5zbGljZSgwLCBuKTsKICAgICAgbGlzdFswXSA9IGJ1Zi5zbGljZShuKTsKICAgIH0gZWxzZSBpZiAobiA9PT0gbGlzdFswXS5sZW5ndGgpIHsKICAgICAgLy8gZmlyc3QgbGlzdCBpcyBhIHBlcmZlY3QgbWF0Y2gKICAgICAgcmV0ID0gbGlzdC5zaGlmdCgpOwogICAgfSBlbHNlIHsKICAgICAgLy8gY29tcGxleCBjYXNlLgogICAgICAvLyB3ZSBoYXZlIGVub3VnaCB0byBjb3ZlciBpdCwgYnV0IGl0IHNwYW5zIHBhc3QgdGhlIGZpcnN0IGJ1ZmZlci4KICAgICAgaWYgKHN0cmluZ01vZGUpCiAgICAgICAgcmV0ID0gJyc7CiAgICAgIGVsc2UKICAgICAgICByZXQgPSBuZXcgQnVmZmVyKG4pOwoKICAgICAgdmFyIGMgPSAwOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IGxpc3QubGVuZ3RoOyBpIDwgbCAmJiBjIDwgbjsgaSsrKSB7CiAgICAgICAgdmFyIGJ1ZiA9IGxpc3RbMF07CiAgICAgICAgdmFyIGNweSA9IE1hdGgubWluKG4gLSBjLCBidWYubGVuZ3RoKTsKCiAgICAgICAgaWYgKHN0cmluZ01vZGUpCiAgICAgICAgICByZXQgKz0gYnVmLnNsaWNlKDAsIGNweSk7CiAgICAgICAgZWxzZQogICAgICAgICAgYnVmLmNvcHkocmV0LCBjLCAwLCBjcHkpOwoKICAgICAgICBpZiAoY3B5IDwgYnVmLmxlbmd0aCkKICAgICAgICAgIGxpc3RbMF0gPSBidWYuc2xpY2UoY3B5KTsKICAgICAgICBlbHNlCiAgICAgICAgICBsaXN0LnNoaWZ0KCk7CgogICAgICAgIGMgKz0gY3B5OwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gcmV0Owp9CgpmdW5jdGlvbiBlbmRSZWFkYWJsZShzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CgogIC8vIElmIHdlIGdldCBoZXJlIGJlZm9yZSBjb25zdW1pbmcgYWxsIHRoZSBieXRlcywgdGhlbiB0aGF0IGlzIGEKICAvLyBidWcgaW4gbm9kZS4gIFNob3VsZCBuZXZlciBoYXBwZW4uCiAgaWYgKHN0YXRlLmxlbmd0aCA+IDApCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2VuZFJlYWRhYmxlIGNhbGxlZCBvbiBub24tZW1wdHkgc3RyZWFtJyk7CgogIGlmICghc3RhdGUuZW5kRW1pdHRlZCAmJiBzdGF0ZS5jYWxsZWRSZWFkKSB7CiAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAvLyBDaGVjayB0aGF0IHdlIGRpZG4ndCBnZXQgb25lIGxhc3QgdW5zaGlmdC4KICAgICAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkICYmIHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCmZ1bmN0aW9uIGluZGV4T2YgKHhzLCB4KSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSB4cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmICh4c1tpXSA9PT0geCkgcmV0dXJuIGk7CiAgfQogIHJldHVybiAtMTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyJfcHJvY2VzcyI6NjAsImJ1ZmZlciI6NTMsImNvcmUtdXRpbC1pcyI6NjcsImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwiaXNhcnJheSI6NTgsInN0cmVhbSI6NzIsInN0cmluZ19kZWNvZGVyLyI6NzN9XSw2NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCgovLyBhIHRyYW5zZm9ybSBzdHJlYW0gaXMgYSByZWFkYWJsZS93cml0YWJsZSBzdHJlYW0gd2hlcmUgeW91IGRvCi8vIHNvbWV0aGluZyB3aXRoIHRoZSBkYXRhLiAgU29tZXRpbWVzIGl0J3MgY2FsbGVkIGEgImZpbHRlciIsCi8vIGJ1dCB0aGF0J3Mgbm90IGEgZ3JlYXQgbmFtZSBmb3IgaXQsIHNpbmNlIHRoYXQgaW1wbGllcyBhIHRoaW5nIHdoZXJlCi8vIHNvbWUgYml0cyBwYXNzIHRocm91Z2gsIGFuZCBvdGhlcnMgYXJlIHNpbXBseSBpZ25vcmVkLiAgKFRoYXQgd291bGQKLy8gYmUgYSB2YWxpZCBleGFtcGxlIG9mIGEgdHJhbnNmb3JtLCBvZiBjb3Vyc2UuKQovLwovLyBXaGlsZSB0aGUgb3V0cHV0IGlzIGNhdXNhbGx5IHJlbGF0ZWQgdG8gdGhlIGlucHV0LCBpdCdzIG5vdCBhCi8vIG5lY2Vzc2FyaWx5IHN5bW1ldHJpYyBvciBzeW5jaHJvbm91cyB0cmFuc2Zvcm1hdGlvbi4gIEZvciBleGFtcGxlLAovLyBhIHpsaWIgc3RyZWFtIG1pZ2h0IHRha2UgbXVsdGlwbGUgcGxhaW4tdGV4dCB3cml0ZXMoKSwgYW5kIHRoZW4KLy8gZW1pdCBhIHNpbmdsZSBjb21wcmVzc2VkIGNodW5rIHNvbWUgdGltZSBpbiB0aGUgZnV0dXJlLgovLwovLyBIZXJlJ3MgaG93IHRoaXMgd29ya3M6Ci8vCi8vIFRoZSBUcmFuc2Zvcm0gc3RyZWFtIGhhcyBhbGwgdGhlIGFzcGVjdHMgb2YgdGhlIHJlYWRhYmxlIGFuZCB3cml0YWJsZQovLyBzdHJlYW0gY2xhc3Nlcy4gIFdoZW4geW91IHdyaXRlKGNodW5rKSwgdGhhdCBjYWxscyBfd3JpdGUoY2h1bmssY2IpCi8vIGludGVybmFsbHksIGFuZCByZXR1cm5zIGZhbHNlIGlmIHRoZXJlJ3MgYSBsb3Qgb2YgcGVuZGluZyB3cml0ZXMKLy8gYnVmZmVyZWQgdXAuICBXaGVuIHlvdSBjYWxsIHJlYWQoKSwgdGhhdCBjYWxscyBfcmVhZChuKSB1bnRpbAovLyB0aGVyZSdzIGVub3VnaCBwZW5kaW5nIHJlYWRhYmxlIGRhdGEgYnVmZmVyZWQgdXAuCi8vCi8vIEluIGEgdHJhbnNmb3JtIHN0cmVhbSwgdGhlIHdyaXR0ZW4gZGF0YSBpcyBwbGFjZWQgaW4gYSBidWZmZXIuICBXaGVuCi8vIF9yZWFkKG4pIGlzIGNhbGxlZCwgaXQgdHJhbnNmb3JtcyB0aGUgcXVldWVkIHVwIGRhdGEsIGNhbGxpbmcgdGhlCi8vIGJ1ZmZlcmVkIF93cml0ZSBjYidzIGFzIGl0IGNvbnN1bWVzIGNodW5rcy4gIElmIGNvbnN1bWluZyBhIHNpbmdsZQovLyB3cml0dGVuIGNodW5rIHdvdWxkIHJlc3VsdCBpbiBtdWx0aXBsZSBvdXRwdXQgY2h1bmtzLCB0aGVuIHRoZSBmaXJzdAovLyBvdXRwdXR0ZWQgYml0IGNhbGxzIHRoZSByZWFkY2IsIGFuZCBzdWJzZXF1ZW50IGNodW5rcyBqdXN0IGdvIGludG8KLy8gdGhlIHJlYWQgYnVmZmVyLCBhbmQgd2lsbCBjYXVzZSBpdCB0byBlbWl0ICdyZWFkYWJsZScgaWYgbmVjZXNzYXJ5LgovLwovLyBUaGlzIHdheSwgYmFjay1wcmVzc3VyZSBpcyBhY3R1YWxseSBkZXRlcm1pbmVkIGJ5IHRoZSByZWFkaW5nIHNpZGUsCi8vIHNpbmNlIF9yZWFkIGhhcyB0byBiZSBjYWxsZWQgdG8gc3RhcnQgcHJvY2Vzc2luZyBhIG5ldyBjaHVuay4gIEhvd2V2ZXIsCi8vIGEgcGF0aG9sb2dpY2FsIGluZmxhdGUgdHlwZSBvZiB0cmFuc2Zvcm0gY2FuIGNhdXNlIGV4Y2Vzc2l2ZSBidWZmZXJpbmcKLy8gaGVyZS4gIEZvciBleGFtcGxlLCBpbWFnaW5lIGEgc3RyZWFtIHdoZXJlIGV2ZXJ5IGJ5dGUgb2YgaW5wdXQgaXMKLy8gaW50ZXJwcmV0ZWQgYXMgYW4gaW50ZWdlciBmcm9tIDAtMjU1LCBhbmQgdGhlbiByZXN1bHRzIGluIHRoYXQgbWFueQovLyBieXRlcyBvZiBvdXRwdXQuICBXcml0aW5nIHRoZSA0IGJ5dGVzIHtmZixmZixmZixmZn0gd291bGQgcmVzdWx0IGluCi8vIDFrYiBvZiBkYXRhIGJlaW5nIG91dHB1dC4gIEluIHRoaXMgY2FzZSwgeW91IGNvdWxkIHdyaXRlIGEgdmVyeSBzbWFsbAovLyBhbW91bnQgb2YgaW5wdXQsIGFuZCBlbmQgdXAgd2l0aCBhIHZlcnkgbGFyZ2UgYW1vdW50IG9mIG91dHB1dC4gIEluCi8vIHN1Y2ggYSBwYXRob2xvZ2ljYWwgaW5mbGF0aW5nIG1lY2hhbmlzbSwgdGhlcmUnZCBiZSBubyB3YXkgdG8gdGVsbAovLyB0aGUgc3lzdGVtIHRvIHN0b3AgZG9pbmcgdGhlIHRyYW5zZm9ybS4gIEEgc2luZ2xlIDRNQiB3cml0ZSBjb3VsZAovLyBjYXVzZSB0aGUgc3lzdGVtIHRvIHJ1biBvdXQgb2YgbWVtb3J5LgovLwovLyBIb3dldmVyLCBldmVuIGluIHN1Y2ggYSBwYXRob2xvZ2ljYWwgY2FzZSwgb25seSBhIHNpbmdsZSB3cml0dGVuIGNodW5rCi8vIHdvdWxkIGJlIGNvbnN1bWVkLCBhbmQgdGhlbiB0aGUgcmVzdCB3b3VsZCB3YWl0ICh1bi10cmFuc2Zvcm1lZCkgdW50aWwKLy8gdGhlIHJlc3VsdHMgb2YgdGhlIHByZXZpb3VzIHRyYW5zZm9ybWVkIGNodW5rIHdlcmUgY29uc3VtZWQuCgptb2R1bGUuZXhwb3J0cyA9IFRyYW5zZm9ybTsKCnZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp1dGlsLmluaGVyaXRzKFRyYW5zZm9ybSwgRHVwbGV4KTsKCgpmdW5jdGlvbiBUcmFuc2Zvcm1TdGF0ZShvcHRpb25zLCBzdHJlYW0pIHsKICB0aGlzLmFmdGVyVHJhbnNmb3JtID0gZnVuY3Rpb24oZXIsIGRhdGEpIHsKICAgIHJldHVybiBhZnRlclRyYW5zZm9ybShzdHJlYW0sIGVyLCBkYXRhKTsKICB9OwoKICB0aGlzLm5lZWRUcmFuc2Zvcm0gPSBmYWxzZTsKICB0aGlzLnRyYW5zZm9ybWluZyA9IGZhbHNlOwogIHRoaXMud3JpdGVjYiA9IG51bGw7CiAgdGhpcy53cml0ZWNodW5rID0gbnVsbDsKfQoKZnVuY3Rpb24gYWZ0ZXJUcmFuc2Zvcm0oc3RyZWFtLCBlciwgZGF0YSkgewogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CiAgdHMudHJhbnNmb3JtaW5nID0gZmFsc2U7CgogIHZhciBjYiA9IHRzLndyaXRlY2I7CgogIGlmICghY2IpCiAgICByZXR1cm4gc3RyZWFtLmVtaXQoJ2Vycm9yJywgbmV3IEVycm9yKCdubyB3cml0ZWNiIGluIFRyYW5zZm9ybSBjbGFzcycpKTsKCiAgdHMud3JpdGVjaHVuayA9IG51bGw7CiAgdHMud3JpdGVjYiA9IG51bGw7CgogIGlmIChkYXRhICE9PSBudWxsICYmIGRhdGEgIT09IHVuZGVmaW5lZCkKICAgIHN0cmVhbS5wdXNoKGRhdGEpOwoKICBpZiAoY2IpCiAgICBjYihlcik7CgogIHZhciBycyA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKICBycy5yZWFkaW5nID0gZmFsc2U7CiAgaWYgKHJzLm5lZWRSZWFkYWJsZSB8fCBycy5sZW5ndGggPCBycy5oaWdoV2F0ZXJNYXJrKSB7CiAgICBzdHJlYW0uX3JlYWQocnMuaGlnaFdhdGVyTWFyayk7CiAgfQp9CgoKZnVuY3Rpb24gVHJhbnNmb3JtKG9wdGlvbnMpIHsKICBpZiAoISh0aGlzIGluc3RhbmNlb2YgVHJhbnNmb3JtKSkKICAgIHJldHVybiBuZXcgVHJhbnNmb3JtKG9wdGlvbnMpOwoKICBEdXBsZXguY2FsbCh0aGlzLCBvcHRpb25zKTsKCiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGUgPSBuZXcgVHJhbnNmb3JtU3RhdGUob3B0aW9ucywgdGhpcyk7CgogIC8vIHdoZW4gdGhlIHdyaXRhYmxlIHNpZGUgZmluaXNoZXMsIHRoZW4gZmx1c2ggb3V0IGFueXRoaW5nIHJlbWFpbmluZy4KICB2YXIgc3RyZWFtID0gdGhpczsKCiAgLy8gc3RhcnQgb3V0IGFza2luZyBmb3IgYSByZWFkYWJsZSBldmVudCBvbmNlIGRhdGEgaXMgdHJhbnNmb3JtZWQuCiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwoKICAvLyB3ZSBoYXZlIGltcGxlbWVudGVkIHRoZSBfcmVhZCBtZXRob2QsIGFuZCBkb25lIHRoZSBvdGhlciB0aGluZ3MKICAvLyB0aGF0IFJlYWRhYmxlIHdhbnRzIGJlZm9yZSB0aGUgZmlyc3QgX3JlYWQgY2FsbCwgc28gdW5zZXQgdGhlCiAgLy8gc3luYyBndWFyZCBmbGFnLgogIHRoaXMuX3JlYWRhYmxlU3RhdGUuc3luYyA9IGZhbHNlOwoKICB0aGlzLm9uY2UoJ2ZpbmlzaCcsIGZ1bmN0aW9uKCkgewogICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiB0aGlzLl9mbHVzaCkKICAgICAgdGhpcy5fZmx1c2goZnVuY3Rpb24oZXIpIHsKICAgICAgICBkb25lKHN0cmVhbSwgZXIpOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgZG9uZShzdHJlYW0pOwogIH0pOwp9CgpUcmFuc2Zvcm0ucHJvdG90eXBlLnB1c2ggPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcpIHsKICB0aGlzLl90cmFuc2Zvcm1TdGF0ZS5uZWVkVHJhbnNmb3JtID0gZmFsc2U7CiAgcmV0dXJuIER1cGxleC5wcm90b3R5cGUucHVzaC5jYWxsKHRoaXMsIGNodW5rLCBlbmNvZGluZyk7Cn07CgovLyBUaGlzIGlzIHRoZSBwYXJ0IHdoZXJlIHlvdSBkbyBzdHVmZiEKLy8gb3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiBpbiBpbXBsZW1lbnRhdGlvbiBjbGFzc2VzLgovLyAnY2h1bmsnIGlzIGFuIGlucHV0IGNodW5rLgovLwovLyBDYWxsIGBwdXNoKG5ld0NodW5rKWAgdG8gcGFzcyBhbG9uZyB0cmFuc2Zvcm1lZCBvdXRwdXQKLy8gdG8gdGhlIHJlYWRhYmxlIHNpZGUuICBZb3UgbWF5IGNhbGwgJ3B1c2gnIHplcm8gb3IgbW9yZSB0aW1lcy4KLy8KLy8gQ2FsbCBgY2IoZXJyKWAgd2hlbiB5b3UgYXJlIGRvbmUgd2l0aCB0aGlzIGNodW5rLiAgSWYgeW91IHBhc3MKLy8gYW4gZXJyb3IsIHRoZW4gdGhhdCdsbCBwdXQgdGhlIGh1cnQgb24gdGhlIHdob2xlIG9wZXJhdGlvbi4gIElmIHlvdQovLyBuZXZlciBjYWxsIGNiKCksIHRoZW4geW91J2xsIG5ldmVyIGdldCBhbm90aGVyIGNodW5rLgpUcmFuc2Zvcm0ucHJvdG90eXBlLl90cmFuc2Zvcm0gPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhyb3cgbmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKTsKfTsKClRyYW5zZm9ybS5wcm90b3R5cGUuX3dyaXRlID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIHZhciB0cyA9IHRoaXMuX3RyYW5zZm9ybVN0YXRlOwogIHRzLndyaXRlY2IgPSBjYjsKICB0cy53cml0ZWNodW5rID0gY2h1bms7CiAgdHMud3JpdGVlbmNvZGluZyA9IGVuY29kaW5nOwogIGlmICghdHMudHJhbnNmb3JtaW5nKSB7CiAgICB2YXIgcnMgPSB0aGlzLl9yZWFkYWJsZVN0YXRlOwogICAgaWYgKHRzLm5lZWRUcmFuc2Zvcm0gfHwKICAgICAgICBycy5uZWVkUmVhZGFibGUgfHwKICAgICAgICBycy5sZW5ndGggPCBycy5oaWdoV2F0ZXJNYXJrKQogICAgICB0aGlzLl9yZWFkKHJzLmhpZ2hXYXRlck1hcmspOwogIH0KfTsKCi8vIERvZXNuJ3QgbWF0dGVyIHdoYXQgdGhlIGFyZ3MgYXJlIGhlcmUuCi8vIF90cmFuc2Zvcm0gZG9lcyBhbGwgdGhlIHdvcmsuCi8vIFRoYXQgd2UgZ290IGhlcmUgbWVhbnMgdGhhdCB0aGUgcmVhZGFibGUgc2lkZSB3YW50cyBtb3JlIGRhdGEuClRyYW5zZm9ybS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh0cy53cml0ZWNodW5rICE9PSBudWxsICYmIHRzLndyaXRlY2IgJiYgIXRzLnRyYW5zZm9ybWluZykgewogICAgdHMudHJhbnNmb3JtaW5nID0gdHJ1ZTsKICAgIHRoaXMuX3RyYW5zZm9ybSh0cy53cml0ZWNodW5rLCB0cy53cml0ZWVuY29kaW5nLCB0cy5hZnRlclRyYW5zZm9ybSk7CiAgfSBlbHNlIHsKICAgIC8vIG1hcmsgdGhhdCB3ZSBuZWVkIGEgdHJhbnNmb3JtLCBzbyB0aGF0IGFueSBkYXRhIHRoYXQgY29tZXMgaW4KICAgIC8vIHdpbGwgZ2V0IHByb2Nlc3NlZCwgbm93IHRoYXQgd2UndmUgYXNrZWQgZm9yIGl0LgogICAgdHMubmVlZFRyYW5zZm9ybSA9IHRydWU7CiAgfQp9OwoKCmZ1bmN0aW9uIGRvbmUoc3RyZWFtLCBlcikgewogIGlmIChlcikKICAgIHJldHVybiBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CgogIC8vIGlmIHRoZXJlJ3Mgbm90aGluZyBpbiB0aGUgd3JpdGUgYnVmZmVyLCB0aGVuIHRoYXQgbWVhbnMKICAvLyB0aGF0IG5vdGhpbmcgbW9yZSB3aWxsIGV2ZXIgYmUgcHJvdmlkZWQKICB2YXIgd3MgPSBzdHJlYW0uX3dyaXRhYmxlU3RhdGU7CiAgdmFyIHJzID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh3cy5sZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbGxpbmcgdHJhbnNmb3JtIGRvbmUgd2hlbiB3cy5sZW5ndGggIT0gMCcpOwoKICBpZiAodHMudHJhbnNmb3JtaW5nKQogICAgdGhyb3cgbmV3IEVycm9yKCdjYWxsaW5nIHRyYW5zZm9ybSBkb25lIHdoZW4gc3RpbGwgdHJhbnNmb3JtaW5nJyk7CgogIHJldHVybiBzdHJlYW0ucHVzaChudWxsKTsKfQoKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjYyLCJjb3JlLXV0aWwtaXMiOjY3LCJpbmhlcml0cyI6NzZ9XSw2NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIEEgYml0IHNpbXBsZXIgdGhhbiByZWFkYWJsZSBzdHJlYW1zLgovLyBJbXBsZW1lbnQgYW4gYXN5bmMgLl93cml0ZShjaHVuaywgY2IpLCBhbmQgaXQnbGwgaGFuZGxlIGFsbAovLyB0aGUgZHJhaW4gZXZlbnQgZW1pc3Npb24gYW5kIGJ1ZmZlcmluZy4KCm1vZHVsZS5leHBvcnRzID0gV3JpdGFibGU7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCldyaXRhYmxlLldyaXRhYmxlU3RhdGUgPSBXcml0YWJsZVN0YXRlOwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciB1dGlsID0gcmVxdWlyZSgnY29yZS11dGlsLWlzJyk7CnV0aWwuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCnZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTsKCnV0aWwuaW5oZXJpdHMoV3JpdGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhpcy5jaHVuayA9IGNodW5rOwogIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZzsKICB0aGlzLmNhbGxiYWNrID0gY2I7Cn0KCmZ1bmN0aW9uIFdyaXRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCB3cml0ZSgpIHN0YXJ0cyByZXR1cm5pbmcgZmFsc2UKICAvLyBOb3RlOiAwIGlzIGEgdmFsaWQgdmFsdWUsIG1lYW5zIHRoYXQgd2UgYWx3YXlzIHJldHVybiBmYWxzZSBpZgogIC8vIHRoZSBlbnRpcmUgYnVmZmVyIGlzIG5vdCBmbHVzaGVkIGltbWVkaWF0ZWx5IG9uIHdyaXRlKCkKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHRoaXMuaGlnaFdhdGVyTWFyayA9IChod20gfHwgaHdtID09PSAwKSA/IGh3bSA6IDE2ICogMTAyNDsKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnIHRvIGluZGljYXRlIHdoZXRoZXIgb3Igbm90IHRoaXMgc3RyZWFtCiAgLy8gY29udGFpbnMgYnVmZmVycyBvciBvYmplY3RzLgogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICAvLyBjYXN0IHRvIGludHMuCiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gfn50aGlzLmhpZ2hXYXRlck1hcms7CgogIHRoaXMubmVlZERyYWluID0gZmFsc2U7CiAgLy8gYXQgdGhlIHN0YXJ0IG9mIGNhbGxpbmcgZW5kKCkKICB0aGlzLmVuZGluZyA9IGZhbHNlOwogIC8vIHdoZW4gZW5kKCkgaGFzIGJlZW4gY2FsbGVkLCBhbmQgcmV0dXJuZWQKICB0aGlzLmVuZGVkID0gZmFsc2U7CiAgLy8gd2hlbiAnZmluaXNoJyBpcyBlbWl0dGVkCiAgdGhpcy5maW5pc2hlZCA9IGZhbHNlOwoKICAvLyBzaG91bGQgd2UgZGVjb2RlIHN0cmluZ3MgaW50byBidWZmZXJzIGJlZm9yZSBwYXNzaW5nIHRvIF93cml0ZT8KICAvLyB0aGlzIGlzIGhlcmUgc28gdGhhdCBzb21lIG5vZGUtY29yZSBzdHJlYW1zIGNhbiBvcHRpbWl6ZSBzdHJpbmcKICAvLyBoYW5kbGluZyBhdCBhIGxvd2VyIGxldmVsLgogIHZhciBub0RlY29kZSA9IG9wdGlvbnMuZGVjb2RlU3RyaW5ncyA9PT0gZmFsc2U7CiAgdGhpcy5kZWNvZGVTdHJpbmdzID0gIW5vRGVjb2RlOwoKICAvLyBDcnlwdG8gaXMga2luZCBvZiBvbGQgYW5kIGNydXN0eS4gIEhpc3RvcmljYWxseSwgaXRzIGRlZmF1bHQgc3RyaW5nCiAgLy8gZW5jb2RpbmcgaXMgJ2JpbmFyeScgc28gd2UgaGF2ZSB0byBtYWtlIHRoaXMgY29uZmlndXJhYmxlLgogIC8vIEV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgdW5pdmVyc2UgdXNlcyAndXRmOCcsIHRob3VnaC4KICB0aGlzLmRlZmF1bHRFbmNvZGluZyA9IG9wdGlvbnMuZGVmYXVsdEVuY29kaW5nIHx8ICd1dGY4JzsKCiAgLy8gbm90IGFuIGFjdHVhbCBidWZmZXIgd2Uga2VlcCB0cmFjayBvZiwgYnV0IGEgbWVhc3VyZW1lbnQKICAvLyBvZiBob3cgbXVjaCB3ZSdyZSB3YWl0aW5nIHRvIGdldCBwdXNoZWQgdG8gc29tZSB1bmRlcmx5aW5nCiAgLy8gc29ja2V0IG9yIGZpbGUuCiAgdGhpcy5sZW5ndGggPSAwOwoKICAvLyBhIGZsYWcgdG8gc2VlIHdoZW4gd2UncmUgaW4gdGhlIG1pZGRsZSBvZiBhIHdyaXRlLgogIHRoaXMud3JpdGluZyA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWN1YXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gYSBmbGFnIHRvIGtub3cgaWYgd2UncmUgcHJvY2Vzc2luZyBwcmV2aW91c2x5IGJ1ZmZlcmVkIGl0ZW1zLCB3aGljaAogIC8vIG1heSBjYWxsIHRoZSBfd3JpdGUoKSBjYWxsYmFjayBpbiB0aGUgc2FtZSB0aWNrLCBzbyB0aGF0IHdlIGRvbid0CiAgLy8gZW5kIHVwIGluIGFuIG92ZXJsYXBwZWQgb253cml0ZSBzaXR1YXRpb24uCiAgdGhpcy5idWZmZXJQcm9jZXNzaW5nID0gZmFsc2U7CgogIC8vIHRoZSBjYWxsYmFjayB0aGF0J3MgcGFzc2VkIHRvIF93cml0ZShjaHVuayxjYikKICB0aGlzLm9ud3JpdGUgPSBmdW5jdGlvbihlcikgewogICAgb253cml0ZShzdHJlYW0sIGVyKTsKICB9OwoKICAvLyB0aGUgY2FsbGJhY2sgdGhhdCB0aGUgdXNlciBzdXBwbGllcyB0byB3cml0ZShjaHVuayxlbmNvZGluZyxjYikKICB0aGlzLndyaXRlY2IgPSBudWxsOwoKICAvLyB0aGUgYW1vdW50IHRoYXQgaXMgYmVpbmcgd3JpdHRlbiB3aGVuIF93cml0ZSBpcyBjYWxsZWQuCiAgdGhpcy53cml0ZWxlbiA9IDA7CgogIHRoaXMuYnVmZmVyID0gW107CgogIC8vIFRydWUgaWYgdGhlIGVycm9yIHdhcyBhbHJlYWR5IGVtaXR0ZWQgYW5kIHNob3VsZCBub3QgYmUgdGhyb3duIGFnYWluCiAgdGhpcy5lcnJvckVtaXR0ZWQgPSBmYWxzZTsKfQoKZnVuY3Rpb24gV3JpdGFibGUob3B0aW9ucykgewogIHZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgogIC8vIFdyaXRhYmxlIGN0b3IgaXMgYXBwbGllZCB0byBEdXBsZXhlcywgdGhvdWdoIHRoZXkncmUgbm90CiAgLy8gaW5zdGFuY2VvZiBXcml0YWJsZSwgdGhleSdyZSBpbnN0YW5jZW9mIFJlYWRhYmxlLgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBXcml0YWJsZSkgJiYgISh0aGlzIGluc3RhbmNlb2YgRHVwbGV4KSkKICAgIHJldHVybiBuZXcgV3JpdGFibGUob3B0aW9ucyk7CgogIHRoaXMuX3dyaXRhYmxlU3RhdGUgPSBuZXcgV3JpdGFibGVTdGF0ZShvcHRpb25zLCB0aGlzKTsKCiAgLy8gbGVnYWN5LgogIHRoaXMud3JpdGFibGUgPSB0cnVlOwoKICBTdHJlYW0uY2FsbCh0aGlzKTsKfQoKLy8gT3RoZXJ3aXNlIHBlb3BsZSBjYW4gcGlwZSBXcml0YWJsZSBzdHJlYW1zLCB3aGljaCBpcyBqdXN0IHdyb25nLgpXcml0YWJsZS5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoJ0Nhbm5vdCBwaXBlLiBOb3QgcmVhZGFibGUuJykpOwp9OwoKCmZ1bmN0aW9uIHdyaXRlQWZ0ZXJFbmQoc3RyZWFtLCBzdGF0ZSwgY2IpIHsKICB2YXIgZXIgPSBuZXcgRXJyb3IoJ3dyaXRlIGFmdGVyIGVuZCcpOwogIC8vIFRPRE86IGRlZmVyIGVycm9yIGV2ZW50cyBjb25zaXN0ZW50bHkgZXZlcnl3aGVyZSwgbm90IGp1c3QgdGhlIGNiCiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICBjYihlcik7CiAgfSk7Cn0KCi8vIElmIHdlIGdldCBzb21ldGhpbmcgdGhhdCBpcyBub3QgYSBidWZmZXIsIHN0cmluZywgbnVsbCwgb3IgdW5kZWZpbmVkLAovLyBhbmQgd2UncmUgbm90IGluIG9iamVjdE1vZGUsIHRoZW4gdGhhdCdzIGFuIGVycm9yLgovLyBPdGhlcndpc2Ugc3RyZWFtIGNodW5rcyBhcmUgYWxsIGNvbnNpZGVyZWQgdG8gYmUgb2YgbGVuZ3RoPTEsIGFuZCB0aGUKLy8gd2F0ZXJtYXJrcyBkZXRlcm1pbmUgaG93IG1hbnkgb2JqZWN0cyB0byBrZWVwIGluIHRoZSBidWZmZXIsIHJhdGhlciB0aGFuCi8vIGhvdyBtYW55IGJ5dGVzIG9yIGNoYXJhY3RlcnMuCmZ1bmN0aW9uIHZhbGlkQ2h1bmsoc3RyZWFtLCBzdGF0ZSwgY2h1bmssIGNiKSB7CiAgdmFyIHZhbGlkID0gdHJ1ZTsKICBpZiAoIUJ1ZmZlci5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgJ3N0cmluZycgIT09IHR5cGVvZiBjaHVuayAmJgogICAgICBjaHVuayAhPT0gbnVsbCAmJgogICAgICBjaHVuayAhPT0gdW5kZWZpbmVkICYmCiAgICAgICFzdGF0ZS5vYmplY3RNb2RlKSB7CiAgICB2YXIgZXIgPSBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG5vbi1zdHJpbmcvYnVmZmVyIGNodW5rJyk7CiAgICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICBjYihlcik7CiAgICB9KTsKICAgIHZhbGlkID0gZmFsc2U7CiAgfQogIHJldHVybiB2YWxpZDsKfQoKV3JpdGFibGUucHJvdG90eXBlLndyaXRlID0gZnVuY3Rpb24oY2h1bmssIGVuY29kaW5nLCBjYikgewogIHZhciBzdGF0ZSA9IHRoaXMuX3dyaXRhYmxlU3RhdGU7CiAgdmFyIHJldCA9IGZhbHNlOwoKICBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7CiAgICBjYiA9IGVuY29kaW5nOwogICAgZW5jb2RpbmcgPSBudWxsOwogIH0KCiAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihjaHVuaykpCiAgICBlbmNvZGluZyA9ICdidWZmZXInOwogIGVsc2UgaWYgKCFlbmNvZGluZykKICAgIGVuY29kaW5nID0gc3RhdGUuZGVmYXVsdEVuY29kaW5nOwoKICBpZiAodHlwZW9mIGNiICE9PSAnZnVuY3Rpb24nKQogICAgY2IgPSBmdW5jdGlvbigpIHt9OwoKICBpZiAoc3RhdGUuZW5kZWQpCiAgICB3cml0ZUFmdGVyRW5kKHRoaXMsIHN0YXRlLCBjYik7CiAgZWxzZSBpZiAodmFsaWRDaHVuayh0aGlzLCBzdGF0ZSwgY2h1bmssIGNiKSkKICAgIHJldCA9IHdyaXRlT3JCdWZmZXIodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICByZXR1cm4gcmV0Owp9OwoKZnVuY3Rpb24gZGVjb2RlQ2h1bmsoc3RhdGUsIGNodW5rLCBlbmNvZGluZykgewogIGlmICghc3RhdGUub2JqZWN0TW9kZSAmJgogICAgICBzdGF0ZS5kZWNvZGVTdHJpbmdzICE9PSBmYWxzZSAmJgogICAgICB0eXBlb2YgY2h1bmsgPT09ICdzdHJpbmcnKSB7CiAgICBjaHVuayA9IG5ldyBCdWZmZXIoY2h1bmssIGVuY29kaW5nKTsKICB9CiAgcmV0dXJuIGNodW5rOwp9CgovLyBpZiB3ZSdyZSBhbHJlYWR5IHdyaXRpbmcgc29tZXRoaW5nLCB0aGVuIGp1c3QgcHV0IHRoaXMKLy8gaW4gdGhlIHF1ZXVlLCBhbmQgd2FpdCBvdXIgdHVybi4gIE90aGVyd2lzZSwgY2FsbCBfd3JpdGUKLy8gSWYgd2UgcmV0dXJuIGZhbHNlLCB0aGVuIHdlIG5lZWQgYSBkcmFpbiBldmVudCwgc28gc2V0IHRoYXQgZmxhZy4KZnVuY3Rpb24gd3JpdGVPckJ1ZmZlcihzdHJlYW0sIHN0YXRlLCBjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgY2h1bmsgPSBkZWNvZGVDaHVuayhzdGF0ZSwgY2h1bmssIGVuY29kaW5nKTsKICBpZiAoQnVmZmVyLmlzQnVmZmVyKGNodW5rKSkKICAgIGVuY29kaW5nID0gJ2J1ZmZlcic7CiAgdmFyIGxlbiA9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwoKICBzdGF0ZS5sZW5ndGggKz0gbGVuOwoKICB2YXIgcmV0ID0gc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyazsKICAvLyB3ZSBtdXN0IGVuc3VyZSB0aGF0IHByZXZpb3VzIG5lZWREcmFpbiB3aWxsIG5vdCBiZSByZXNldCB0byBmYWxzZS4KICBpZiAoIXJldCkKICAgIHN0YXRlLm5lZWREcmFpbiA9IHRydWU7CgogIGlmIChzdGF0ZS53cml0aW5nKQogICAgc3RhdGUuYnVmZmVyLnB1c2gobmV3IFdyaXRlUmVxKGNodW5rLCBlbmNvZGluZywgY2IpKTsKICBlbHNlCiAgICBkb1dyaXRlKHN0cmVhbSwgc3RhdGUsIGxlbiwgY2h1bmssIGVuY29kaW5nLCBjYik7CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgbGVuLCBjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgc3RhdGUud3JpdGVsZW4gPSBsZW47CiAgc3RhdGUud3JpdGVjYiA9IGNiOwogIHN0YXRlLndyaXRpbmcgPSB0cnVlOwogIHN0YXRlLnN5bmMgPSB0cnVlOwogIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICBzdGF0ZS5zeW5jID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIG9ud3JpdGVFcnJvcihzdHJlYW0sIHN0YXRlLCBzeW5jLCBlciwgY2IpIHsKICBpZiAoc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIGNiKGVyKTsKICAgIH0pOwogIGVsc2UKICAgIGNiKGVyKTsKCiAgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVycm9yRW1pdHRlZCA9IHRydWU7CiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwp9CgpmdW5jdGlvbiBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpIHsKICBzdGF0ZS53cml0aW5nID0gZmFsc2U7CiAgc3RhdGUud3JpdGVjYiA9IG51bGw7CiAgc3RhdGUubGVuZ3RoIC09IHN0YXRlLndyaXRlbGVuOwogIHN0YXRlLndyaXRlbGVuID0gMDsKfQoKZnVuY3Rpb24gb253cml0ZShzdHJlYW0sIGVyKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciBzeW5jID0gc3RhdGUuc3luYzsKICB2YXIgY2IgPSBzdGF0ZS53cml0ZWNiOwoKICBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpOwoKICBpZiAoZXIpCiAgICBvbndyaXRlRXJyb3Ioc3RyZWFtLCBzdGF0ZSwgc3luYywgZXIsIGNiKTsKICBlbHNlIHsKICAgIC8vIENoZWNrIGlmIHdlJ3JlIGFjdHVhbGx5IHJlYWR5IHRvIGZpbmlzaCwgYnV0IGRvbid0IGVtaXQgeWV0CiAgICB2YXIgZmluaXNoZWQgPSBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpOwoKICAgIGlmICghZmluaXNoZWQgJiYgIXN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgY2xlYXJCdWZmZXIoc3RyZWFtLCBzdGF0ZSk7CgogICAgaWYgKHN5bmMpIHsKICAgICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgICBhZnRlcldyaXRlKHN0cmVhbSwgc3RhdGUsIGZpbmlzaGVkLCBjYik7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpOwogICAgfQogIH0KfQoKZnVuY3Rpb24gYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpIHsKICBpZiAoIWZpbmlzaGVkKQogICAgb253cml0ZURyYWluKHN0cmVhbSwgc3RhdGUpOwogIGNiKCk7CiAgaWYgKGZpbmlzaGVkKQogICAgZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSk7Cn0KCi8vIE11c3QgZm9yY2UgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIG9uIG5leHRUaWNrLCBzbyB0aGF0IHdlIGRvbid0Ci8vIGVtaXQgJ2RyYWluJyBiZWZvcmUgdGhlIHdyaXRlKCkgY29uc3VtZXIgZ2V0cyB0aGUgJ2ZhbHNlJyByZXR1cm4KLy8gdmFsdWUsIGFuZCBoYXMgYSBjaGFuY2UgdG8gYXR0YWNoIGEgJ2RyYWluJyBsaXN0ZW5lci4KZnVuY3Rpb24gb253cml0ZURyYWluKHN0cmVhbSwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLm5lZWREcmFpbikgewogICAgc3RhdGUubmVlZERyYWluID0gZmFsc2U7CiAgICBzdHJlYW0uZW1pdCgnZHJhaW4nKTsKICB9Cn0KCgovLyBpZiB0aGVyZSdzIHNvbWV0aGluZyBpbiB0aGUgYnVmZmVyIHdhaXRpbmcsIHRoZW4gcHJvY2VzcyBpdApmdW5jdGlvbiBjbGVhckJ1ZmZlcihzdHJlYW0sIHN0YXRlKSB7CiAgc3RhdGUuYnVmZmVyUHJvY2Vzc2luZyA9IHRydWU7CgogIGZvciAodmFyIGMgPSAwOyBjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aDsgYysrKSB7CiAgICB2YXIgZW50cnkgPSBzdGF0ZS5idWZmZXJbY107CiAgICB2YXIgY2h1bmsgPSBlbnRyeS5jaHVuazsKICAgIHZhciBlbmNvZGluZyA9IGVudHJ5LmVuY29kaW5nOwogICAgdmFyIGNiID0gZW50cnkuY2FsbGJhY2s7CiAgICB2YXIgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CgogICAgZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCBsZW4sIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICAgIC8vIGlmIHdlIGRpZG4ndCBjYWxsIHRoZSBvbndyaXRlIGltbWVkaWF0ZWx5LCB0aGVuCiAgICAvLyBpdCBtZWFucyB0aGF0IHdlIG5lZWQgdG8gd2FpdCB1bnRpbCBpdCBkb2VzLgogICAgLy8gYWxzbywgdGhhdCBtZWFucyB0aGF0IHRoZSBjaHVuayBhbmQgY2IgYXJlIGN1cnJlbnRseQogICAgLy8gYmVpbmcgcHJvY2Vzc2VkLCBzbyBtb3ZlIHRoZSBidWZmZXIgY291bnRlciBwYXN0IHRoZW0uCiAgICBpZiAoc3RhdGUud3JpdGluZykgewogICAgICBjKys7CiAgICAgIGJyZWFrOwogICAgfQogIH0KCiAgc3RhdGUuYnVmZmVyUHJvY2Vzc2luZyA9IGZhbHNlOwogIGlmIChjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgIHN0YXRlLmJ1ZmZlciA9IHN0YXRlLmJ1ZmZlci5zbGljZShjKTsKICBlbHNlCiAgICBzdGF0ZS5idWZmZXIubGVuZ3RoID0gMDsKfQoKV3JpdGFibGUucHJvdG90eXBlLl93cml0ZSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICBjYihuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpKTsKfTsKCldyaXRhYmxlLnByb3RvdHlwZS5lbmQgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgaWYgKHR5cGVvZiBjaHVuayA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBjaHVuazsKICAgIGNodW5rID0gbnVsbDsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9IGVsc2UgaWYgKHR5cGVvZiBlbmNvZGluZyA9PT0gJ2Z1bmN0aW9uJykgewogICAgY2IgPSBlbmNvZGluZzsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9CgogIGlmICh0eXBlb2YgY2h1bmsgIT09ICd1bmRlZmluZWQnICYmIGNodW5rICE9PSBudWxsKQogICAgdGhpcy53cml0ZShjaHVuaywgZW5jb2RpbmcpOwoKICAvLyBpZ25vcmUgdW5uZWNlc3NhcnkgZW5kKCkgY2FsbHMuCiAgaWYgKCFzdGF0ZS5lbmRpbmcgJiYgIXN0YXRlLmZpbmlzaGVkKQogICAgZW5kV3JpdGFibGUodGhpcywgc3RhdGUsIGNiKTsKfTsKCgpmdW5jdGlvbiBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpIHsKICByZXR1cm4gKHN0YXRlLmVuZGluZyAmJgogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwICYmCiAgICAgICAgICAhc3RhdGUuZmluaXNoZWQgJiYKICAgICAgICAgICFzdGF0ZS53cml0aW5nKTsKfQoKZnVuY3Rpb24gZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSkgewogIHZhciBuZWVkID0gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICBpZiAobmVlZCkgewogICAgc3RhdGUuZmluaXNoZWQgPSB0cnVlOwogICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpOwogIH0KICByZXR1cm4gbmVlZDsKfQoKZnVuY3Rpb24gZW5kV3JpdGFibGUoc3RyZWFtLCBzdGF0ZSwgY2IpIHsKICBzdGF0ZS5lbmRpbmcgPSB0cnVlOwogIGZpbmlzaE1heWJlKHN0cmVhbSwgc3RhdGUpOwogIGlmIChjYikgewogICAgaWYgKHN0YXRlLmZpbmlzaGVkKQogICAgICBwcm9jZXNzLm5leHRUaWNrKGNiKTsKICAgIGVsc2UKICAgICAgc3RyZWFtLm9uY2UoJ2ZpbmlzaCcsIGNiKTsKICB9CiAgc3RhdGUuZW5kZWQgPSB0cnVlOwp9Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSkKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjYyLCJfcHJvY2VzcyI6NjAsImJ1ZmZlciI6NTMsImNvcmUtdXRpbC1pcyI6NjcsImluaGVyaXRzIjo3Niwic3RyZWFtIjo3Mn1dLDY3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChCdWZmZXIpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgovLyBOT1RFOiBUaGVzZSB0eXBlIGNoZWNraW5nIGZ1bmN0aW9ucyBpbnRlbnRpb25hbGx5IGRvbid0IHVzZSBgaW5zdGFuY2VvZmAKLy8gYmVjYXVzZSBpdCBpcyBmcmFnaWxlIGFuZCBjYW4gYmUgZWFzaWx5IGZha2VkIHdpdGggYE9iamVjdC5jcmVhdGUoKWAuCmZ1bmN0aW9uIGlzQXJyYXkoYXIpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShhcik7Cn0KZXhwb3J0cy5pc0FycmF5ID0gaXNBcnJheTsKCmZ1bmN0aW9uIGlzQm9vbGVhbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Jvb2xlYW4nOwp9CmV4cG9ydHMuaXNCb29sZWFuID0gaXNCb29sZWFuOwoKZnVuY3Rpb24gaXNOdWxsKGFyZykgewogIHJldHVybiBhcmcgPT09IG51bGw7Cn0KZXhwb3J0cy5pc051bGwgPSBpc051bGw7CgpmdW5jdGlvbiBpc051bGxPclVuZGVmaW5lZChhcmcpIHsKICByZXR1cm4gYXJnID09IG51bGw7Cn0KZXhwb3J0cy5pc051bGxPclVuZGVmaW5lZCA9IGlzTnVsbE9yVW5kZWZpbmVkOwoKZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CiAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwp9CmV4cG9ydHMuaXNOdW1iZXIgPSBpc051bWJlcjsKCmZ1bmN0aW9uIGlzU3RyaW5nKGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJzsKfQpleHBvcnRzLmlzU3RyaW5nID0gaXNTdHJpbmc7CgpmdW5jdGlvbiBpc1N5bWJvbChhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCc7Cn0KZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwoKZnVuY3Rpb24gaXNVbmRlZmluZWQoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwp9CmV4cG9ydHMuaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKCmZ1bmN0aW9uIGlzUmVnRXhwKHJlKSB7CiAgcmV0dXJuIGlzT2JqZWN0KHJlKSAmJiBvYmplY3RUb1N0cmluZyhyZSkgPT09ICdbb2JqZWN0IFJlZ0V4cF0nOwp9CmV4cG9ydHMuaXNSZWdFeHAgPSBpc1JlZ0V4cDsKCmZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewogIHJldHVybiB0eXBlb2YgYXJnID09PSAnb2JqZWN0JyAmJiBhcmcgIT09IG51bGw7Cn0KZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwoKZnVuY3Rpb24gaXNEYXRlKGQpIHsKICByZXR1cm4gaXNPYmplY3QoZCkgJiYgb2JqZWN0VG9TdHJpbmcoZCkgPT09ICdbb2JqZWN0IERhdGVdJzsKfQpleHBvcnRzLmlzRGF0ZSA9IGlzRGF0ZTsKCmZ1bmN0aW9uIGlzRXJyb3IoZSkgewogIHJldHVybiBpc09iamVjdChlKSAmJgogICAgICAob2JqZWN0VG9TdHJpbmcoZSkgPT09ICdbb2JqZWN0IEVycm9yXScgfHwgZSBpbnN0YW5jZW9mIEVycm9yKTsKfQpleHBvcnRzLmlzRXJyb3IgPSBpc0Vycm9yOwoKZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKfQpleHBvcnRzLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwoKZnVuY3Rpb24gaXNQcmltaXRpdmUoYXJnKSB7CiAgcmV0dXJuIGFyZyA9PT0gbnVsbCB8fAogICAgICAgICB0eXBlb2YgYXJnID09PSAnYm9vbGVhbicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ251bWJlcicgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycgfHwKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3N5bWJvbCcgfHwgIC8vIEVTNiBzeW1ib2wKICAgICAgICAgdHlwZW9mIGFyZyA9PT0gJ3VuZGVmaW5lZCc7Cn0KZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwoKZnVuY3Rpb24gaXNCdWZmZXIoYXJnKSB7CiAgcmV0dXJuIEJ1ZmZlci5pc0J1ZmZlcihhcmcpOwp9CmV4cG9ydHMuaXNCdWZmZXIgPSBpc0J1ZmZlcjsKCmZ1bmN0aW9uIG9iamVjdFRvU3RyaW5nKG8pIHsKICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG8pOwp9Cn0pLmNhbGwodGhpcyxyZXF1aXJlKCJidWZmZXIiKS5CdWZmZXIpCn0seyJidWZmZXIiOjUzfV0sNjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoIi4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiOjYzfV0sNjk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7IC8vIGhhY2sgdG8gZml4IGEgY2lyY3VsYXIgZGVwZW5kZW5jeSBpc3N1ZSB3aGVuIHVzZWQgd2l0aCBicm93c2VyaWZ5CmV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fcmVhZGFibGUuanMnKTsKZXhwb3J0cy5TdHJlYW0gPSBTdHJlYW07CmV4cG9ydHMuUmVhZGFibGUgPSBleHBvcnRzOwpleHBvcnRzLldyaXRhYmxlID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV93cml0YWJsZS5qcycpOwpleHBvcnRzLkR1cGxleCA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fZHVwbGV4LmpzJyk7CmV4cG9ydHMuVHJhbnNmb3JtID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMnKTsKZXhwb3J0cy5QYXNzVGhyb3VnaCA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMnKTsKCn0seyIuL2xpYi9fc3RyZWFtX2R1cGxleC5qcyI6NjIsIi4vbGliL19zdHJlYW1fcGFzc3Rocm91Z2guanMiOjYzLCIuL2xpYi9fc3RyZWFtX3JlYWRhYmxlLmpzIjo2NCwiLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMiOjY1LCIuL2xpYi9fc3RyZWFtX3dyaXRhYmxlLmpzIjo2Niwic3RyZWFtIjo3Mn1dLDcwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCIuL2xpYi9fc3RyZWFtX3RyYW5zZm9ybS5qcyIpCgp9LHsiLi9saWIvX3N0cmVhbV90cmFuc2Zvcm0uanMiOjY1fV0sNzE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmUoIi4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiKQoKfSx7Ii4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiOjY2fV0sNzI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFN0cmVhbTsKCnZhciBFRSA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCmluaGVyaXRzKFN0cmVhbSwgRUUpOwpTdHJlYW0uUmVhZGFibGUgPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vcmVhZGFibGUuanMnKTsKU3RyZWFtLldyaXRhYmxlID0gcmVxdWlyZSgncmVhZGFibGUtc3RyZWFtL3dyaXRhYmxlLmpzJyk7ClN0cmVhbS5EdXBsZXggPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vZHVwbGV4LmpzJyk7ClN0cmVhbS5UcmFuc2Zvcm0gPSByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0vdHJhbnNmb3JtLmpzJyk7ClN0cmVhbS5QYXNzVGhyb3VnaCA9IHJlcXVpcmUoJ3JlYWRhYmxlLXN0cmVhbS9wYXNzdGhyb3VnaC5qcycpOwoKLy8gQmFja3dhcmRzLWNvbXBhdCB3aXRoIG5vZGUgMC40LngKU3RyZWFtLlN0cmVhbSA9IFN0cmVhbTsKCgoKLy8gb2xkLXN0eWxlIHN0cmVhbXMuICBOb3RlIHRoYXQgdGhlIHBpcGUgbWV0aG9kICh0aGUgb25seSByZWxldmFudAovLyBwYXJ0IG9mIHRoaXMgY2xhc3MpIGlzIG92ZXJyaWRkZW4gaW4gdGhlIFJlYWRhYmxlIGNsYXNzLgoKZnVuY3Rpb24gU3RyZWFtKCkgewogIEVFLmNhbGwodGhpcyk7Cn0KClN0cmVhbS5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKGRlc3QsIG9wdGlvbnMpIHsKICB2YXIgc291cmNlID0gdGhpczsKCiAgZnVuY3Rpb24gb25kYXRhKGNodW5rKSB7CiAgICBpZiAoZGVzdC53cml0YWJsZSkgewogICAgICBpZiAoZmFsc2UgPT09IGRlc3Qud3JpdGUoY2h1bmspICYmIHNvdXJjZS5wYXVzZSkgewogICAgICAgIHNvdXJjZS5wYXVzZSgpOwogICAgICB9CiAgICB9CiAgfQoKICBzb3VyY2Uub24oJ2RhdGEnLCBvbmRhdGEpOwoKICBmdW5jdGlvbiBvbmRyYWluKCkgewogICAgaWYgKHNvdXJjZS5yZWFkYWJsZSAmJiBzb3VyY2UucmVzdW1lKSB7CiAgICAgIHNvdXJjZS5yZXN1bWUoKTsKICAgIH0KICB9CgogIGRlc3Qub24oJ2RyYWluJywgb25kcmFpbik7CgogIC8vIElmIHRoZSAnZW5kJyBvcHRpb24gaXMgbm90IHN1cHBsaWVkLCBkZXN0LmVuZCgpIHdpbGwgYmUgY2FsbGVkIHdoZW4KICAvLyBzb3VyY2UgZ2V0cyB0aGUgJ2VuZCcgb3IgJ2Nsb3NlJyBldmVudHMuICBPbmx5IGRlc3QuZW5kKCkgb25jZS4KICBpZiAoIWRlc3QuX2lzU3RkaW8gJiYgKCFvcHRpb25zIHx8IG9wdGlvbnMuZW5kICE9PSBmYWxzZSkpIHsKICAgIHNvdXJjZS5vbignZW5kJywgb25lbmQpOwogICAgc291cmNlLm9uKCdjbG9zZScsIG9uY2xvc2UpOwogIH0KCiAgdmFyIGRpZE9uRW5kID0gZmFsc2U7CiAgZnVuY3Rpb24gb25lbmQoKSB7CiAgICBpZiAoZGlkT25FbmQpIHJldHVybjsKICAgIGRpZE9uRW5kID0gdHJ1ZTsKCiAgICBkZXN0LmVuZCgpOwogIH0KCgogIGZ1bmN0aW9uIG9uY2xvc2UoKSB7CiAgICBpZiAoZGlkT25FbmQpIHJldHVybjsKICAgIGRpZE9uRW5kID0gdHJ1ZTsKCiAgICBpZiAodHlwZW9mIGRlc3QuZGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykgZGVzdC5kZXN0cm95KCk7CiAgfQoKICAvLyBkb24ndCBsZWF2ZSBkYW5nbGluZyBwaXBlcyB3aGVuIHRoZXJlIGFyZSBlcnJvcnMuCiAgZnVuY3Rpb24gb25lcnJvcihlcikgewogICAgY2xlYW51cCgpOwogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQodGhpcywgJ2Vycm9yJykgPT09IDApIHsKICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCBzdHJlYW0gZXJyb3IgaW4gcGlwZS4KICAgIH0KICB9CgogIHNvdXJjZS5vbignZXJyb3InLCBvbmVycm9yKTsKICBkZXN0Lm9uKCdlcnJvcicsIG9uZXJyb3IpOwoKICAvLyByZW1vdmUgYWxsIHRoZSBldmVudCBsaXN0ZW5lcnMgdGhhdCB3ZXJlIGFkZGVkLgogIGZ1bmN0aW9uIGNsZWFudXAoKSB7CiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZHJhaW4nLCBvbmRyYWluKTsKCiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBvbmNsb3NlKTsKCiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwoKICAgIHNvdXJjZS5yZW1vdmVMaXN0ZW5lcignZW5kJywgY2xlYW51cCk7CiAgICBzb3VyY2UucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgY2xlYW51cCk7CgogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignY2xvc2UnLCBjbGVhbnVwKTsKICB9CgogIHNvdXJjZS5vbignZW5kJywgY2xlYW51cCk7CiAgc291cmNlLm9uKCdjbG9zZScsIGNsZWFudXApOwoKICBkZXN0Lm9uKCdjbG9zZScsIGNsZWFudXApOwoKICBkZXN0LmVtaXQoJ3BpcGUnLCBzb3VyY2UpOwoKICAvLyBBbGxvdyBmb3IgdW5peC1saWtlIHVzYWdlOiBBLnBpcGUoQikucGlwZShDKQogIHJldHVybiBkZXN0Owp9OwoKfSx7ImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwicmVhZGFibGUtc3RyZWFtL2R1cGxleC5qcyI6NjEsInJlYWRhYmxlLXN0cmVhbS9wYXNzdGhyb3VnaC5qcyI6NjgsInJlYWRhYmxlLXN0cmVhbS9yZWFkYWJsZS5qcyI6NjksInJlYWRhYmxlLXN0cmVhbS90cmFuc2Zvcm0uanMiOjcwLCJyZWFkYWJsZS1zdHJlYW0vd3JpdGFibGUuanMiOjcxfV0sNzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwoKdmFyIGlzQnVmZmVyRW5jb2RpbmcgPSBCdWZmZXIuaXNFbmNvZGluZwogIHx8IGZ1bmN0aW9uKGVuY29kaW5nKSB7CiAgICAgICBzd2l0Y2ggKGVuY29kaW5nICYmIGVuY29kaW5nLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgY2FzZSAnaGV4JzogY2FzZSAndXRmOCc6IGNhc2UgJ3V0Zi04JzogY2FzZSAnYXNjaWknOiBjYXNlICdiaW5hcnknOiBjYXNlICdiYXNlNjQnOiBjYXNlICd1Y3MyJzogY2FzZSAndWNzLTInOiBjYXNlICd1dGYxNmxlJzogY2FzZSAndXRmLTE2bGUnOiBjYXNlICdyYXcnOiByZXR1cm4gdHJ1ZTsKICAgICAgICAgZGVmYXVsdDogcmV0dXJuIGZhbHNlOwogICAgICAgfQogICAgIH0KCgpmdW5jdGlvbiBhc3NlcnRFbmNvZGluZyhlbmNvZGluZykgewogIGlmIChlbmNvZGluZyAmJiAhaXNCdWZmZXJFbmNvZGluZyhlbmNvZGluZykpIHsKICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBlbmNvZGluZzogJyArIGVuY29kaW5nKTsKICB9Cn0KCi8vIFN0cmluZ0RlY29kZXIgcHJvdmlkZXMgYW4gaW50ZXJmYWNlIGZvciBlZmZpY2llbnRseSBzcGxpdHRpbmcgYSBzZXJpZXMgb2YKLy8gYnVmZmVycyBpbnRvIGEgc2VyaWVzIG9mIEpTIHN0cmluZ3Mgd2l0aG91dCBicmVha2luZyBhcGFydCBtdWx0aS1ieXRlCi8vIGNoYXJhY3RlcnMuIENFU1UtOCBpcyBoYW5kbGVkIGFzIHBhcnQgb2YgdGhlIFVURi04IGVuY29kaW5nLgovLwovLyBAVE9ETyBIYW5kbGluZyBhbGwgZW5jb2RpbmdzIGluc2lkZSBhIHNpbmdsZSBvYmplY3QgbWFrZXMgaXQgdmVyeSBkaWZmaWN1bHQKLy8gdG8gcmVhc29uIGFib3V0IHRoaXMgY29kZSwgc28gaXQgc2hvdWxkIGJlIHNwbGl0IHVwIGluIHRoZSBmdXR1cmUuCi8vIEBUT0RPIFRoZXJlIHNob3VsZCBiZSBhIHV0Zjgtc3RyaWN0IGVuY29kaW5nIHRoYXQgcmVqZWN0cyBpbnZhbGlkIFVURi04IGNvZGUKLy8gcG9pbnRzIGFzIHVzZWQgYnkgQ0VTVS04Lgp2YXIgU3RyaW5nRGVjb2RlciA9IGV4cG9ydHMuU3RyaW5nRGVjb2RlciA9IGZ1bmN0aW9uKGVuY29kaW5nKSB7CiAgdGhpcy5lbmNvZGluZyA9IChlbmNvZGluZyB8fCAndXRmOCcpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvWy1fXS8sICcnKTsKICBhc3NlcnRFbmNvZGluZyhlbmNvZGluZyk7CiAgc3dpdGNoICh0aGlzLmVuY29kaW5nKSB7CiAgICBjYXNlICd1dGY4JzoKICAgICAgLy8gQ0VTVS04IHJlcHJlc2VudHMgZWFjaCBvZiBTdXJyb2dhdGUgUGFpciBieSAzLWJ5dGVzCiAgICAgIHRoaXMuc3Vycm9nYXRlU2l6ZSA9IDM7CiAgICAgIGJyZWFrOwogICAgY2FzZSAndWNzMic6CiAgICBjYXNlICd1dGYxNmxlJzoKICAgICAgLy8gVVRGLTE2IHJlcHJlc2VudHMgZWFjaCBvZiBTdXJyb2dhdGUgUGFpciBieSAyLWJ5dGVzCiAgICAgIHRoaXMuc3Vycm9nYXRlU2l6ZSA9IDI7CiAgICAgIHRoaXMuZGV0ZWN0SW5jb21wbGV0ZUNoYXIgPSB1dGYxNkRldGVjdEluY29tcGxldGVDaGFyOwogICAgICBicmVhazsKICAgIGNhc2UgJ2Jhc2U2NCc6CiAgICAgIC8vIEJhc2UtNjQgc3RvcmVzIDMgYnl0ZXMgaW4gNCBjaGFycywgYW5kIHBhZHMgdGhlIHJlbWFpbmRlci4KICAgICAgdGhpcy5zdXJyb2dhdGVTaXplID0gMzsKICAgICAgdGhpcy5kZXRlY3RJbmNvbXBsZXRlQ2hhciA9IGJhc2U2NERldGVjdEluY29tcGxldGVDaGFyOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRoaXMud3JpdGUgPSBwYXNzVGhyb3VnaFdyaXRlOwogICAgICByZXR1cm47CiAgfQoKICAvLyBFbm91Z2ggc3BhY2UgdG8gc3RvcmUgYWxsIGJ5dGVzIG9mIGEgc2luZ2xlIGNoYXJhY3Rlci4gVVRGLTggbmVlZHMgNAogIC8vIGJ5dGVzLCBidXQgQ0VTVS04IG1heSByZXF1aXJlIHVwIHRvIDYgKDMgYnl0ZXMgcGVyIHN1cnJvZ2F0ZSkuCiAgdGhpcy5jaGFyQnVmZmVyID0gbmV3IEJ1ZmZlcig2KTsKICAvLyBOdW1iZXIgb2YgYnl0ZXMgcmVjZWl2ZWQgZm9yIHRoZSBjdXJyZW50IGluY29tcGxldGUgbXVsdGktYnl0ZSBjaGFyYWN0ZXIuCiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSAwOwogIC8vIE51bWJlciBvZiBieXRlcyBleHBlY3RlZCBmb3IgdGhlIGN1cnJlbnQgaW5jb21wbGV0ZSBtdWx0aS1ieXRlIGNoYXJhY3Rlci4KICB0aGlzLmNoYXJMZW5ndGggPSAwOwp9OwoKCi8vIHdyaXRlIGRlY29kZXMgdGhlIGdpdmVuIGJ1ZmZlciBhbmQgcmV0dXJucyBpdCBhcyBKUyBzdHJpbmcgdGhhdCBpcwovLyBndWFyYW50ZWVkIHRvIG5vdCBjb250YWluIGFueSBwYXJ0aWFsIG11bHRpLWJ5dGUgY2hhcmFjdGVycy4gQW55IHBhcnRpYWwKLy8gY2hhcmFjdGVyIGZvdW5kIGF0IHRoZSBlbmQgb2YgdGhlIGJ1ZmZlciBpcyBidWZmZXJlZCB1cCwgYW5kIHdpbGwgYmUKLy8gcmV0dXJuZWQgd2hlbiBjYWxsaW5nIHdyaXRlIGFnYWluIHdpdGggdGhlIHJlbWFpbmluZyBieXRlcy4KLy8KLy8gTm90ZTogQ29udmVydGluZyBhIEJ1ZmZlciBjb250YWluaW5nIGFuIG9ycGhhbiBzdXJyb2dhdGUgdG8gYSBTdHJpbmcKLy8gY3VycmVudGx5IHdvcmtzLCBidXQgY29udmVydGluZyBhIFN0cmluZyB0byBhIEJ1ZmZlciAodmlhIGBuZXcgQnVmZmVyYCwgb3IKLy8gQnVmZmVyI3dyaXRlKSB3aWxsIHJlcGxhY2UgaW5jb21wbGV0ZSBzdXJyb2dhdGVzIHdpdGggdGhlIHVuaWNvZGUKLy8gcmVwbGFjZW1lbnQgY2hhcmFjdGVyLiBTZWUgaHR0cHM6Ly9jb2RlcmV2aWV3LmNocm9taXVtLm9yZy8xMjExNzMwMDkvIC4KU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUud3JpdGUgPSBmdW5jdGlvbihidWZmZXIpIHsKICB2YXIgY2hhclN0ciA9ICcnOwogIC8vIGlmIG91ciBsYXN0IHdyaXRlIGVuZGVkIHdpdGggYW4gaW5jb21wbGV0ZSBtdWx0aWJ5dGUgY2hhcmFjdGVyCiAgd2hpbGUgKHRoaXMuY2hhckxlbmd0aCkgewogICAgLy8gZGV0ZXJtaW5lIGhvdyBtYW55IHJlbWFpbmluZyBieXRlcyB0aGlzIGJ1ZmZlciBoYXMgdG8gb2ZmZXIgZm9yIHRoaXMgY2hhcgogICAgdmFyIGF2YWlsYWJsZSA9IChidWZmZXIubGVuZ3RoID49IHRoaXMuY2hhckxlbmd0aCAtIHRoaXMuY2hhclJlY2VpdmVkKSA/CiAgICAgICAgdGhpcy5jaGFyTGVuZ3RoIC0gdGhpcy5jaGFyUmVjZWl2ZWQgOgogICAgICAgIGJ1ZmZlci5sZW5ndGg7CgogICAgLy8gYWRkIHRoZSBuZXcgYnl0ZXMgdG8gdGhlIGNoYXIgYnVmZmVyCiAgICBidWZmZXIuY29weSh0aGlzLmNoYXJCdWZmZXIsIHRoaXMuY2hhclJlY2VpdmVkLCAwLCBhdmFpbGFibGUpOwogICAgdGhpcy5jaGFyUmVjZWl2ZWQgKz0gYXZhaWxhYmxlOwoKICAgIGlmICh0aGlzLmNoYXJSZWNlaXZlZCA8IHRoaXMuY2hhckxlbmd0aCkgewogICAgICAvLyBzdGlsbCBub3QgZW5vdWdoIGNoYXJzIGluIHRoaXMgYnVmZmVyPyB3YWl0IGZvciBtb3JlIC4uLgogICAgICByZXR1cm4gJyc7CiAgICB9CgogICAgLy8gcmVtb3ZlIGJ5dGVzIGJlbG9uZ2luZyB0byB0aGUgY3VycmVudCBjaGFyYWN0ZXIgZnJvbSB0aGUgYnVmZmVyCiAgICBidWZmZXIgPSBidWZmZXIuc2xpY2UoYXZhaWxhYmxlLCBidWZmZXIubGVuZ3RoKTsKCiAgICAvLyBnZXQgdGhlIGNoYXJhY3RlciB0aGF0IHdhcyBzcGxpdAogICAgY2hhclN0ciA9IHRoaXMuY2hhckJ1ZmZlci5zbGljZSgwLCB0aGlzLmNoYXJMZW5ndGgpLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcpOwoKICAgIC8vIENFU1UtODogbGVhZCBzdXJyb2dhdGUgKEQ4MDAtREJGRikgaXMgYWxzbyB0aGUgaW5jb21wbGV0ZSBjaGFyYWN0ZXIKICAgIHZhciBjaGFyQ29kZSA9IGNoYXJTdHIuY2hhckNvZGVBdChjaGFyU3RyLmxlbmd0aCAtIDEpOwogICAgaWYgKGNoYXJDb2RlID49IDB4RDgwMCAmJiBjaGFyQ29kZSA8PSAweERCRkYpIHsKICAgICAgdGhpcy5jaGFyTGVuZ3RoICs9IHRoaXMuc3Vycm9nYXRlU2l6ZTsKICAgICAgY2hhclN0ciA9ICcnOwogICAgICBjb250aW51ZTsKICAgIH0KICAgIHRoaXMuY2hhclJlY2VpdmVkID0gdGhpcy5jaGFyTGVuZ3RoID0gMDsKCiAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbW9yZSBieXRlcyBpbiB0aGlzIGJ1ZmZlciwganVzdCBlbWl0IG91ciBjaGFyCiAgICBpZiAoYnVmZmVyLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gY2hhclN0cjsKICAgIH0KICAgIGJyZWFrOwogIH0KCiAgLy8gZGV0ZXJtaW5lIGFuZCBzZXQgY2hhckxlbmd0aCAvIGNoYXJSZWNlaXZlZAogIHRoaXMuZGV0ZWN0SW5jb21wbGV0ZUNoYXIoYnVmZmVyKTsKCiAgdmFyIGVuZCA9IGJ1ZmZlci5sZW5ndGg7CiAgaWYgKHRoaXMuY2hhckxlbmd0aCkgewogICAgLy8gYnVmZmVyIHRoZSBpbmNvbXBsZXRlIGNoYXJhY3RlciBieXRlcyB3ZSBnb3QKICAgIGJ1ZmZlci5jb3B5KHRoaXMuY2hhckJ1ZmZlciwgMCwgYnVmZmVyLmxlbmd0aCAtIHRoaXMuY2hhclJlY2VpdmVkLCBlbmQpOwogICAgZW5kIC09IHRoaXMuY2hhclJlY2VpdmVkOwogIH0KCiAgY2hhclN0ciArPSBidWZmZXIudG9TdHJpbmcodGhpcy5lbmNvZGluZywgMCwgZW5kKTsKCiAgdmFyIGVuZCA9IGNoYXJTdHIubGVuZ3RoIC0gMTsKICB2YXIgY2hhckNvZGUgPSBjaGFyU3RyLmNoYXJDb2RlQXQoZW5kKTsKICAvLyBDRVNVLTg6IGxlYWQgc3Vycm9nYXRlIChEODAwLURCRkYpIGlzIGFsc28gdGhlIGluY29tcGxldGUgY2hhcmFjdGVyCiAgaWYgKGNoYXJDb2RlID49IDB4RDgwMCAmJiBjaGFyQ29kZSA8PSAweERCRkYpIHsKICAgIHZhciBzaXplID0gdGhpcy5zdXJyb2dhdGVTaXplOwogICAgdGhpcy5jaGFyTGVuZ3RoICs9IHNpemU7CiAgICB0aGlzLmNoYXJSZWNlaXZlZCArPSBzaXplOwogICAgdGhpcy5jaGFyQnVmZmVyLmNvcHkodGhpcy5jaGFyQnVmZmVyLCBzaXplLCAwLCBzaXplKTsKICAgIGJ1ZmZlci5jb3B5KHRoaXMuY2hhckJ1ZmZlciwgMCwgMCwgc2l6ZSk7CiAgICByZXR1cm4gY2hhclN0ci5zdWJzdHJpbmcoMCwgZW5kKTsKICB9CgogIC8vIG9yIGp1c3QgZW1pdCB0aGUgY2hhclN0cgogIHJldHVybiBjaGFyU3RyOwp9OwoKLy8gZGV0ZWN0SW5jb21wbGV0ZUNoYXIgZGV0ZXJtaW5lcyBpZiB0aGVyZSBpcyBhbiBpbmNvbXBsZXRlIFVURi04IGNoYXJhY3RlciBhdAovLyB0aGUgZW5kIG9mIHRoZSBnaXZlbiBidWZmZXIuIElmIHNvLCBpdCBzZXRzIHRoaXMuY2hhckxlbmd0aCB0byB0aGUgYnl0ZQovLyBsZW5ndGggdGhhdCBjaGFyYWN0ZXIsIGFuZCBzZXRzIHRoaXMuY2hhclJlY2VpdmVkIHRvIHRoZSBudW1iZXIgb2YgYnl0ZXMKLy8gdGhhdCBhcmUgYXZhaWxhYmxlIGZvciB0aGlzIGNoYXJhY3Rlci4KU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUuZGV0ZWN0SW5jb21wbGV0ZUNoYXIgPSBmdW5jdGlvbihidWZmZXIpIHsKICAvLyBkZXRlcm1pbmUgaG93IG1hbnkgYnl0ZXMgd2UgaGF2ZSB0byBjaGVjayBhdCB0aGUgZW5kIG9mIHRoaXMgYnVmZmVyCiAgdmFyIGkgPSAoYnVmZmVyLmxlbmd0aCA+PSAzKSA/IDMgOiBidWZmZXIubGVuZ3RoOwoKICAvLyBGaWd1cmUgb3V0IGlmIG9uZSBvZiB0aGUgbGFzdCBpIGJ5dGVzIG9mIG91ciBidWZmZXIgYW5ub3VuY2VzIGFuCiAgLy8gaW5jb21wbGV0ZSBjaGFyLgogIGZvciAoOyBpID4gMDsgaS0tKSB7CiAgICB2YXIgYyA9IGJ1ZmZlcltidWZmZXIubGVuZ3RoIC0gaV07CgogICAgLy8gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVVRGLTgjRGVzY3JpcHRpb24KCiAgICAvLyAxMTBYWFhYWAogICAgaWYgKGkgPT0gMSAmJiBjID4+IDUgPT0gMHgwNikgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSAyOwogICAgICBicmVhazsKICAgIH0KCiAgICAvLyAxMTEwWFhYWAogICAgaWYgKGkgPD0gMiAmJiBjID4+IDQgPT0gMHgwRSkgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSAzOwogICAgICBicmVhazsKICAgIH0KCiAgICAvLyAxMTExMFhYWAogICAgaWYgKGkgPD0gMyAmJiBjID4+IDMgPT0gMHgxRSkgewogICAgICB0aGlzLmNoYXJMZW5ndGggPSA0OwogICAgICBicmVhazsKICAgIH0KICB9CiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSBpOwp9OwoKU3RyaW5nRGVjb2Rlci5wcm90b3R5cGUuZW5kID0gZnVuY3Rpb24oYnVmZmVyKSB7CiAgdmFyIHJlcyA9ICcnOwogIGlmIChidWZmZXIgJiYgYnVmZmVyLmxlbmd0aCkKICAgIHJlcyA9IHRoaXMud3JpdGUoYnVmZmVyKTsKCiAgaWYgKHRoaXMuY2hhclJlY2VpdmVkKSB7CiAgICB2YXIgY3IgPSB0aGlzLmNoYXJSZWNlaXZlZDsKICAgIHZhciBidWYgPSB0aGlzLmNoYXJCdWZmZXI7CiAgICB2YXIgZW5jID0gdGhpcy5lbmNvZGluZzsKICAgIHJlcyArPSBidWYuc2xpY2UoMCwgY3IpLnRvU3RyaW5nKGVuYyk7CiAgfQoKICByZXR1cm4gcmVzOwp9OwoKZnVuY3Rpb24gcGFzc1Rocm91Z2hXcml0ZShidWZmZXIpIHsKICByZXR1cm4gYnVmZmVyLnRvU3RyaW5nKHRoaXMuZW5jb2RpbmcpOwp9CgpmdW5jdGlvbiB1dGYxNkRldGVjdEluY29tcGxldGVDaGFyKGJ1ZmZlcikgewogIHRoaXMuY2hhclJlY2VpdmVkID0gYnVmZmVyLmxlbmd0aCAlIDI7CiAgdGhpcy5jaGFyTGVuZ3RoID0gdGhpcy5jaGFyUmVjZWl2ZWQgPyAyIDogMDsKfQoKZnVuY3Rpb24gYmFzZTY0RGV0ZWN0SW5jb21wbGV0ZUNoYXIoYnVmZmVyKSB7CiAgdGhpcy5jaGFyUmVjZWl2ZWQgPSBidWZmZXIubGVuZ3RoICUgMzsKICB0aGlzLmNoYXJMZW5ndGggPSB0aGlzLmNoYXJSZWNlaXZlZCA/IDMgOiAwOwp9Cgp9LHsiYnVmZmVyIjo1M31dLDc0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gICAgIGNyZWF0ZS1lcnJvci5qcyAwLjMuMQovLyAgICAgKGMpIDIwMTMgVGltIEdyaWVzc2VyCi8vICAgICBUaGlzIHNvdXJjZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKGZ1bmN0aW9uKGZhY3RvcnkpIHsKCiJ1c2Ugc3RyaWN0IjsKCi8vIEEgc2ltcGxlIHV0aWxpdHkgZm9yIHN1YmNsYXNzaW5nIHRoZSAiRXJyb3IiCi8vIG9iamVjdCBpbiBtdWx0aXBsZSBlbnZpcm9ubWVudHMsIHdoaWxlIG1haW50YWluaW5nCi8vIHJlbGV2YW50IHN0YWNrIHRyYWNlcywgbWVzc2FnZXMsIGFuZCBwcm90b3R5cGVzLgpmYWN0b3J5KGZ1bmN0aW9uKCkgewoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCi8vIENyZWF0ZXMgYW4gbmV3IGVycm9yIHR5cGUgd2l0aCBhICJuYW1lIiwKLy8gYW5kIGFueSBhZGRpdGlvbmFsIHByb3BlcnRpZXMgdGhhdCBzaG91bGQgYmUgc2V0Ci8vIG9uIHRoZSBlcnJvciBpbnN0YW5jZS4KcmV0dXJuIGZ1bmN0aW9uKCkgewogIHZhciBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7ICsraSkgewogICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICB9CiAgdmFyIG5hbWUgICAgICAgPSBnZXROYW1lKGFyZ3MpOwogIHZhciB0YXJnZXQgICAgID0gZ2V0VGFyZ2V0KGFyZ3MpOwogIHZhciBwcm9wZXJ0aWVzID0gZ2V0UHJvcHMoYXJncyk7CiAgZnVuY3Rpb24gRXJyb3JDdG9yKG1lc3NhZ2UsIG9iaikgewogICAgYXR0YWNoUHJvcHModGhpcywgcHJvcGVydGllcyk7CiAgICBhdHRhY2hQcm9wcyh0aGlzLCBvYmopOwogICAgdGhpcy5tZXNzYWdlID0gKG1lc3NhZ2UgfHwgdGhpcy5tZXNzYWdlKTsKICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgdGhpcy5tZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlOwogICAgICB0aGlzLnN0YWNrID0gbWVzc2FnZS5zdGFjazsKICAgIH0gZWxzZSBpZiAoRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UpIHsKICAgICAgRXJyb3IuY2FwdHVyZVN0YWNrVHJhY2UodGhpcywgdGhpcy5jb25zdHJ1Y3Rvcik7CiAgICB9CiAgfQogIGZ1bmN0aW9uIEVycigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IEVycm9yQ3RvcjsgfQogIEVyci5wcm90b3R5cGUgPSB0YXJnZXRbJ3Byb3RvdHlwZSddOwogIEVycm9yQ3Rvci5wcm90b3R5cGUgPSBuZXcgRXJyKCk7CiAgRXJyb3JDdG9yLnByb3RvdHlwZS5uYW1lID0gKCcnICsgbmFtZSkgfHwgJ0N1c3RvbUVycm9yJzsKICByZXR1cm4gRXJyb3JDdG9yOwp9OwoKLy8gSnVzdCBhIGZldyBoZWxwZXJzIHRvIGNsZWFuIHVwIHRoZSBmdW5jdGlvbiBhYm92ZQovLyBodHRwczovL2dpdGh1Yi5jb20vcGV0a2FhbnRvbm92L2JsdWViaXJkL3dpa2kvT3B0aW1pemF0aW9uLWtpbGxlcnMKZnVuY3Rpb24gZ2V0TmFtZShhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gJyc7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyAoYXJnc1sxXSB8fCAnJykgOiBhcmdzWzBdOwp9CmZ1bmN0aW9uIGdldFRhcmdldChhcmdzKSB7CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAwKSByZXR1cm4gRXJyb3I7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyBhcmdzWzBdIDogRXJyb3I7Cn0KZnVuY3Rpb24gZ2V0UHJvcHMoYXJncykgewogIGlmIChhcmdzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgcmV0dXJuIGlzRXJyb3IoYXJnc1swXSkgPyBhcmdzWzJdIDogYXJnc1sxXTsKfQpmdW5jdGlvbiBpbmhlcml0ZWRLZXlzKG9iaikgewogIHZhciByZXQgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICByZXQucHVzaChrZXkpOwogIH0KICByZXR1cm4gcmV0Owp9CgovLyBSaWdodCBub3cgd2UncmUganVzdCBhc3N1bWluZyB0aGF0IGEgZnVuY3Rpb24gaW4gdGhlIGZpcnN0IGFyZ3VtZW50IGlzIGFuIGVycm9yLgpmdW5jdGlvbiBpc0Vycm9yKG9iaikgewogIHJldHVybiAodHlwZW9mIG9iaiA9PT0gImZ1bmN0aW9uIik7Cn0KCi8vIFdlIGRvbid0IG5lZWQgdGhlIGZ1bGwgdW5kZXJzY29yZSBjaGVjayBoZXJlLCBzaW5jZSBpdCBzaG91bGQgZWl0aGVyIGJlCi8vIGFuIG9iamVjdC1saXRlcmFsLCBvciBub3RoaW5nIGF0IGFsbC4KZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7CiAgcmV0dXJuIChvYmogJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdG9TdHJpbmcuY2FsbChvYmopID09PSAiW29iamVjdCBPYmplY3RdIik7Cn0KCi8vIFVzZWQgdG8gYXR0YWNoIGF0dHJpYnV0ZXMgdG8gdGhlIGVycm9yIG9iamVjdCBpbiB0aGUgY29uc3RydWN0b3IuCmZ1bmN0aW9uIGF0dGFjaFByb3BzKGNvbnRleHQsIHRhcmdldCkgewogIGlmIChpc09iamVjdCh0YXJnZXQpKSB7CiAgICB2YXIga2V5cyA9IGluaGVyaXRlZEtleXModGFyZ2V0KTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgY29udGV4dFtrZXlzW2ldXSA9IGNsb25lKHRhcmdldFtrZXlzW2ldXSk7CiAgICB9CiAgfQp9CgovLyBEb24ndCBuZWVkIHRoZSBmdWxsLW91dCAiY2xvbmUiIG1lY2hhbmlzbSBoZXJlLCBzaW5jZSBpZiB5b3UncmUKLy8gdHJ5aW5nIHRvIHNldCB0aGluZ3Mgb3RoZXIgdGhhbiBlbXB0eSBhcnJheXMvb2JqZWN0cyBvbiB5b3VyCi8vIHN1Yi1jbGFzc2VkIGBFcnJvcmAgb2JqZWN0LCB5b3UncmUgcHJvYmFibHkgZG9pbmcgaXQgd3JvbmcuCmZ1bmN0aW9uIGNsb25lKHRhcmdldCkgewogIGlmICh0YXJnZXQgPT0gbnVsbCB8fCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IikgcmV0dXJuIHRhcmdldDsKICB2YXIgY2xvbmVkID0gdGFyZ2V0LmNvbnN0cnVjdG9yID8gdGFyZ2V0LmNvbnN0cnVjdG9yKCkgOiBPYmplY3QuY3JlYXRlKG51bGwpOwogIGZvciAodmFyIGF0dHIgaW4gdGFyZ2V0KSB7CiAgICBpZiAodGFyZ2V0Lmhhc093blByb3BlcnR5KGF0dHIpKSB7CiAgICAgIGNsb25lZFthdHRyXSA9IHRhcmdldFthdHRyXTsKICAgIH0KICB9CiAgcmV0dXJuIGNsb25lZDsKfQoKfSk7CgovLyBCb2lsZXJwbGF0ZSBVTUQgZGVmaW5pdGlvbiBibG9jay4uLgp9KShmdW5jdGlvbihjcmVhdGVFcnJvckxpYikgewogIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZShjcmVhdGVFcnJvckxpYik7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gY3JlYXRlRXJyb3JMaWIoKTsKICB9IGVsc2UgewogICAgdmFyIHJvb3QgPSB0aGlzOwogICAgdmFyIGxhc3RjcmVhdGVFcnJvciA9IHJvb3QuY3JlYXRlRXJyb3I7CiAgICB2YXIgY3JlYXRlRXJyb3IgPSByb290LmNyZWF0ZUVycm9yID0gY3JlYXRlRXJyb3JMaWIoKTsKICAgIGNyZWF0ZUVycm9yLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgcm9vdC5jcmVhdGVFcnJvciA9IGxhc3RjcmVhdGVFcnJvcjsKICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yOwogICAgfTsKICB9Cn0pOwoKfSx7fV0sNzU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiEKICogaW5mbGVjdGlvbgogKiBDb3B5cmlnaHQoYykgMjAxMSBCZW4gTGluIDxiZW5AZHJlYW1lcnNsYWIuY29tPgogKiBNSVQgTGljZW5zZWQKICoKICogQGZpbGVvdmVydmlldwogKiBBIHBvcnQgb2YgaW5mbGVjdGlvbi1qcyB0byBub2RlLmpzIG1vZHVsZS4KICovCgooIGZ1bmN0aW9uICggcm9vdCwgZmFjdG9yeSApewogIGlmKCB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgKXsKICAgIGRlZmluZShbXSwgZmFjdG9yeSApOwogIH1lbHNlIGlmKCB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgKXsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH1lbHNlewogICAgcm9vdC5pbmZsZWN0aW9uID0gZmFjdG9yeSgpOwogIH0KfSggdGhpcywgZnVuY3Rpb24gKCl7CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGlzIGlzIGEgbGlzdCBvZiBub3VucyB0aGF0IHVzZSB0aGUgc2FtZSBmb3JtIGZvciBib3RoIHNpbmd1bGFyIGFuZCBwbHVyYWwuCiAgICogICAgICAgICAgICAgIFRoaXMgbGlzdCBzaG91bGQgcmVtYWluIGVudGlyZWx5IGluIGxvd2VyIGNhc2UgdG8gY29ycmVjdGx5IG1hdGNoIFN0cmluZ3MuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgdW5jb3VudGFibGVfd29yZHMgPSBbCiAgICAnYWNjZXNzJywKICAgICdhY2NvbW1vZGF0aW9uJywKICAgICdhZHVsdGhvb2QnLAogICAgJ2FkdmVydGlzaW5nJywKICAgICdhZHZpY2UnLAogICAgJ2FnZ3Jlc3Npb24nLAogICAgJ2FpZCcsCiAgICAnYWlyJywKICAgICdhaXJjcmFmdCcsCiAgICAnYWxjb2hvbCcsCiAgICAnYW5nZXInLAogICAgJ2FwcGxhdXNlJywKICAgICdhcml0aG1ldGljJywKICAgICdhcnQnLAogICAgJ2Fzc2lzdGFuY2UnLAogICAgJ2F0aGxldGljcycsCiAgICAnYXR0ZW50aW9uJywKCiAgICAnYmFjb24nLAogICAgJ2JhZ2dhZ2UnLAogICAgJ2JhbGxldCcsCiAgICAnYmVhdXR5JywKICAgICdiZWVmJywKICAgICdiZWVyJywKICAgICdiZWhhdmlvcicsCiAgICAnYmlvbG9neScsCiAgICAvLyAnYmlsbGlhcmRzJywKICAgICdibG9vZCcsCiAgICAnYm90YW55JywKICAgIC8vICdib3dlbHMnLAogICAgJ2JyZWFkJywKICAgICdidXNpbmVzcycsCiAgICAnYnV0dGVyJywKCiAgICAnY2FyYm9uJywKICAgICdjYXJkYm9hcmQnLAogICAgJ2Nhc2gnLAogICAgJ2NoYWxrJywKICAgICdjaGFvcycsCiAgICAnY2hlc3MnLAogICAgJ2Nyb3Nzcm9hZHMnLAogICAgJ2NvdW50cnlzaWRlJywKCiAgICAnZGFtYWdlJywKICAgICdkYW5jaW5nJywKICAgICdkYW5nZXInLAogICAgJ2RlZXInLAogICAgJ2RlbGlnaHQnLAogICAgJ2Rlc3NlcnQnLAogICAgJ2RpZ25pdHknLAogICAgJ2RpcnQnLAogICAgJ2Rpc3RyaWJ1dGlvbicsCiAgICAnZHVzdCcsCgogICAgJ2Vjb25vbWljcycsCiAgICAnZWR1Y2F0aW9uJywKICAgICdlbGVjdHJpY2l0eScsCiAgICAnZW1wbG95bWVudCcsCiAgICAnZW5lcmd5JywKICAgICdlbmdpbmVlcmluZycsCiAgICAnZW5qb3ltZW50JywKICAgICdlbnRlcnRhaW5tZW50JywKICAgICdlbnZ5JywKICAgICdlcXVpcG1lbnQnLAogICAgJ2V0aGljcycsCiAgICAnZXZpZGVuY2UnLAogICAgJ2V2b2x1dGlvbicsCgogICAgJ2ZhaWx1cmUnLAogICAgJ2ZhaXRoJywKICAgICdmYW1lJywKICAgICdmaWN0aW9uJywKICAgIC8vICdmaXNoJywKICAgICdmbG91cicsCiAgICAnZmx1JywKICAgICdmb29kJywKICAgICdmcmVlZG9tJywKICAgICdmcnVpdCcsCiAgICAnZnVlbCcsCiAgICAnZnVuJywKICAgIC8vICdmdW5lcmFsJywKICAgICdmdXJuaXR1cmUnLAoKICAgICdnYWxsb3dzJywKICAgICdnYXJiYWdlJywKICAgICdnYXJsaWMnLAogICAgJ2dhcycsCiAgICAnZ2VuZXRpY3MnLAogICAgJ2dsYXNzJywKICAgICdnb2xkJywKICAgICdnb2xmJywKICAgICdnb3NzaXAnLAogICAgJ2dyYW1tYXInLAogICAgJ2dyYXNzJywKICAgICdncmF0aXR1ZGUnLAogICAgJ2dyaWVmJywKICAgICdncm91bmQnLAogICAgJ2d1aWx0JywKICAgICdneW1uYXN0aWNzJywKCiAgICAnaGFpcicsCiAgICAnaGFwcGluZXNzJywKICAgICdoYXJkd2FyZScsCiAgICAnaGFybScsCiAgICAnaGF0ZScsCiAgICAnaGF0cmVkJywKICAgICdoZWFsdGgnLAogICAgJ2hlYXQnLAogICAgJ2hlaWdodCcsCiAgICAnaGVscCcsCiAgICAnaG9tZXdvcmsnLAogICAgJ2hvbmVzdHknLAogICAgJ2hvbmV5JywKICAgICdob3NwaXRhbGl0eScsCiAgICAnaG91c2V3b3JrJywKICAgICdodW1vdXInLAogICAgJ2h1bmdlcicsCiAgICAnaHlkcm9nZW4nLAoKICAgICdpY2UnLAogICAgJ2ltcG9ydGFuY2UnLAogICAgJ2luZmxhdGlvbicsCiAgICAnaW5mb3JtYXRpb24nLAogICAgJ2luanVzdGljZScsCiAgICAnaW5ub2NlbmNlJywKICAgICdpbnRlbGxpZ2VuY2UnLAogICAgJ2lyb24nLAogICAgJ2lyb255JywKCiAgICAnamFtJywKICAgICdqZWFsb3VzeScsCiAgICAnamVsbHknLAogICAgJ2pld2VscnknLAogICAgJ2pveScsCiAgICAnanVkbycsCiAgICAnanVpY2UnLAogICAgJ2p1c3RpY2UnLAoKICAgICdrYXJhdGUnLAogICAgJ2tpbmRuZXNzJywKICAgICdrbm93bGVkZ2UnLAoKICAgICdsYWJvdXInLAogICAgJ2xhY2snLAogICAgJ2xhbmQnLAogICAgJ2xhdWdodGVyJywKICAgICdsYXZhJywKICAgICdsZWF0aGVyJywKICAgICdsZWlzdXJlJywKICAgICdsaWdodG5pbmcnLAogICAgJ2xpbmd1aW5lJywKICAgICdsaW5ndWluaScsCiAgICAnbGluZ3Vpc3RpY3MnLAogICAgJ2xpdGVyYXR1cmUnLAogICAgJ2xpdHRlcicsCiAgICAnbGl2ZXN0b2NrJywKICAgICdsb2dpYycsCiAgICAnbG9uZWxpbmVzcycsCiAgICAnbG92ZScsCiAgICAnbHVjaycsCiAgICAnbHVnZ2FnZScsCgogICAgJ21hY2Fyb25pJywKICAgICdtYWNoaW5lcnknLAogICAgJ21hZ2ljJywKICAgICdtYWlsJywKICAgICdtYW5hZ2VtZW50JywKICAgICdtYW5raW5kJywKICAgICdtYXJibGUnLAogICAgJ21hdGhlbWF0aWNzJywKICAgICdtYXlvbm5haXNlJywKICAgICdtZWFzbGVzJywKICAgICdtZWF0JywKICAgICdtZXRhbCcsCiAgICAnbWV0aGFuZScsCiAgICAnbWlsaycsCiAgICAnbW9uZXknLAogICAgLy8gJ21vb3NlJywKICAgICdtdWQnLAogICAgJ211c2ljJywKICAgICdtdW1wcycsCgogICAgJ25hdHVyZScsCiAgICAnbmV3cycsCiAgICAnbml0cm9nZW4nLAogICAgJ25vbnNlbnNlJywKICAgICdudXJ0dXJlJywKICAgICdudXRyaXRpb24nLAoKICAgICdvYmVkaWVuY2UnLAogICAgJ29iZXNpdHknLAogICAgJ29pbCcsCiAgICAnb3h5Z2VuJywKCiAgICAncGFwZXInLAogICAgJ3Bhc3Npb24nLAogICAgJ3Bhc3RhJywKICAgICdwYXRpZW5jZScsCiAgICAncGVybWlzc2lvbicsCiAgICAncGh5c2ljcycsCiAgICAncG9ldHJ5JywKICAgICdwb2xsdXRpb24nLAogICAgJ3BvdmVydHknLAogICAgJ3Bvd2VyJywKICAgICdwcmlkZScsCiAgICAncHJvZHVjdGlvbicsCiAgICAncHJvZ3Jlc3MnLAogICAgJ3Byb251bmNpYXRpb24nLAogICAgJ3BzeWNob2xvZ3knLAogICAgJ3B1YmxpY2l0eScsCiAgICAncHVuY3R1YXRpb24nLAoKICAgICdxdWFsaXR5JywKICAgICdxdWFudGl0eScsCiAgICAncXVhcnR6JywKCiAgICAncmFjaXNtJywKICAgICdyYWluJywKICAgICdyZWNyZWF0aW9uJywKICAgICdyZWxheGF0aW9uJywKICAgICdyZWxpYWJpbGl0eScsCiAgICAncmVzZWFyY2gnLAogICAgJ3Jlc3BlY3QnLAogICAgJ3JldmVuZ2UnLAogICAgJ3JpY2UnLAogICAgJ3J1YmJpc2gnLAogICAgJ3J1bScsCgogICAgJ3NhZmV0eScsCiAgICAnc2FsYWQnLAogICAgJ3NhbHQnLAogICAgJ3NhbmQnLAogICAgJ3NhdGlyZScsCiAgICAnc2NlbmVyeScsCiAgICAnc2VhZm9vZCcsCiAgICAnc2Vhc2lkZScsCiAgICAnc2VyaWVzJywKICAgICdzaGFtZScsCiAgICAnc2hlZXAnLAogICAgJ3Nob3BwaW5nJywKICAgICdzaWxlbmNlJywKICAgICdzbGVlcCcsCiAgICAvLyAnc2xhbmcnCiAgICAnc21va2UnLAogICAgJ3Ntb2tpbmcnLAogICAgJ3Nub3cnLAogICAgJ3NvYXAnLAogICAgJ3NvZnR3YXJlJywKICAgICdzb2lsJywKICAgICdzb3Jyb3cnLAogICAgJ3NvdXAnLAogICAgJ3NwYWdoZXR0aScsCiAgICAnc3BlZWQnLAogICAgJ3NwZWNpZXMnLAogICAgJ3NwZWxsaW5nJywKICAgICdzcG9ydCcsCiAgICAnc3RlYW0nLAogICAgJ3N0cmVuZ3RoJywKICAgICdzdHVmZicsCiAgICAnc3R1cGlkaXR5JywKICAgICdzdWNjZXNzJywKICAgICdzdWdhcicsCiAgICAnc3Vuc2hpbmUnLAogICAgJ3N5bW1ldHJ5JywKCiAgICAndGVhJywKICAgICd0ZW5uaXMnLAogICAgJ3RoaXJzdCcsCiAgICAndGh1bmRlcicsCiAgICAndGltYmVyJywKICAgICd0aW1lJywKICAgICd0b2FzdCcsCiAgICAndG9sZXJhbmNlJywKICAgICd0cmFkZScsCiAgICAndHJhZmZpYycsCiAgICAndHJhbnNwb3J0YXRpb24nLAogICAgJ3RyYXZlbCcsCiAgICAndHJ1c3QnLAoKICAgICd1bmRlcnN0YW5kaW5nJywKICAgICd1bmRlcndlYXInLAogICAgJ3VuZW1wbG95bWVudCcsCiAgICAndW5pdHknLAogICAgJ3VzYWdlJywKCiAgICAndmFsaWRpdHknLAogICAgJ3ZlYWwnLAogICAgJ3ZlZ2V0YXRpb24nLAogICAgJ3ZlZ2V0YXJpYW5pc20nLAogICAgJ3ZlbmdlYW5jZScsCiAgICAndmlvbGVuY2UnLAogICAgJ3Zpc2lvbicsCiAgICAndml0YWxpdHknLAoKICAgICd3YXJtdGgnLAogICAgJ3dhdGVyJywKICAgICd3ZWFsdGgnLAogICAgJ3dlYXRoZXInLAogICAgJ3dlaWdodCcsCiAgICAnd2VsZmFyZScsCiAgICAnd2hlYXQnLAogICAgJ3doaXNrZXknLAogICAgJ3dpZHRoJywKICAgICd3aWxkbGlmZScsCiAgICAnd2luZScsCiAgICAnd2lzZG9tJywKICAgICd3b29kJywKICAgICd3b29sJywKICAgICd3b3JrJywKCiAgICAneWVhc3QnLAogICAgJ3lvZ2EnLAoKICAgICd6aW5jJywKICAgICd6b29sb2d5JwogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBydWxlcyB0cmFuc2xhdGUgZnJvbSB0aGUgc2luZ3VsYXIgZm9ybSBvZiBhIG5vdW4gdG8gaXRzIHBsdXJhbCBmb3JtLgogICAqIEBwcml2YXRlCiAgICovCgogIHZhciByZWdleCA9IHsKICAgIHBsdXJhbCA6IHsKICAgICAgbWVuICAgICAgIDogbmV3IFJlZ0V4cCggJ14obSllbiQnICAgICwgJ2dpJyApLAogICAgICBwZW9wbGUgICAgOiBuZXcgUmVnRXhwKCAnKHBlKW9wbGUkJyAgLCAnZ2knICksCiAgICAgIGNoaWxkcmVuICA6IG5ldyBSZWdFeHAoICcoY2hpbGQpcmVuJCcsICdnaScgKSwKICAgICAgdGlhICAgICAgIDogbmV3IFJlZ0V4cCggJyhbdGldKWEkJyAgICwgJ2dpJyApLAogICAgICBhbmFseXNlcyAgOiBuZXcgUmVnRXhwKCAnKChhKW5hbHl8KGIpYXwoZClpYWdub3wocClhcmVudGhlfChwKXJvZ25vfChzKXlub3B8KHQpaGUpc2VzJCcsJ2dpJyApLAogICAgICBoaXZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKGhpfHRpKXZlcyQnICAgICAgICwgJ2dpJyApLAogICAgICBjdXJ2ZXMgICAgOiBuZXcgUmVnRXhwKCAnKGN1cnZlKXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBscnZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKFtscl0pdmVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICBmb3ZlcyAgICAgOiBuZXcgUmVnRXhwKCAnKFteZm9dKXZlcyQnICAgICAgICwgJ2dpJyApLAogICAgICBtb3ZpZXMgICAgOiBuZXcgUmVnRXhwKCAnKG0pb3ZpZXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBhZWlvdXlpZXMgOiBuZXcgUmVnRXhwKCAnKFteYWVpb3V5XXxxdSlpZXMkJywgJ2dpJyApLAogICAgICBzZXJpZXMgICAgOiBuZXcgUmVnRXhwKCAnKHMpZXJpZXMkJyAgICAgICAgICwgJ2dpJyApLAogICAgICB4ZXMgICAgICAgOiBuZXcgUmVnRXhwKCAnKHh8Y2h8c3N8c2gpZXMkJyAgICwgJ2dpJyApLAogICAgICBtaWNlICAgICAgOiBuZXcgUmVnRXhwKCAnKFttfGxdKWljZSQnICAgICAgICwgJ2dpJyApLAogICAgICBidXNlcyAgICAgOiBuZXcgUmVnRXhwKCAnKGJ1cyllcyQnICAgICAgICAgICwgJ2dpJyApLAogICAgICBvZXMgICAgICAgOiBuZXcgUmVnRXhwKCAnKG8pZXMkJyAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzaG9lcyAgICAgOiBuZXcgUmVnRXhwKCAnKHNob2UpcyQnICAgICAgICAgICwgJ2dpJyApLAogICAgICBjcmlzZXMgICAgOiBuZXcgUmVnRXhwKCAnKGNyaXN8YXh8dGVzdCllcyQnICwgJ2dpJyApLAogICAgICBvY3RvcGkgICAgOiBuZXcgUmVnRXhwKCAnKG9jdG9wfHZpcilpJCcgICAgICwgJ2dpJyApLAogICAgICBhbGlhc2VzICAgOiBuZXcgUmVnRXhwKCAnKGFsaWFzfHN0YXR1cyllcyQnICwgJ2dpJyApLAogICAgICBzdW1tb25zZXMgOiBuZXcgUmVnRXhwKCAnXihzdW1tb25zKWVzJCcgICAgICwgJ2dpJyApLAogICAgICBveGVuICAgICAgOiBuZXcgUmVnRXhwKCAnXihveCllbicgICAgICAgICAgICwgJ2dpJyApLAogICAgICBtYXRyaWNlcyAgOiBuZXcgUmVnRXhwKCAnKG1hdHIpaWNlcyQnICAgICAgICwgJ2dpJyApLAogICAgICB2ZXJ0aWNlcyAgOiBuZXcgUmVnRXhwKCAnKHZlcnR8aW5kKWljZXMkJyAgICwgJ2dpJyApLAogICAgICBmZWV0ICAgICAgOiBuZXcgUmVnRXhwKCAnXmZlZXQkJyAgICAgICAgICAgICwgJ2dpJyApLAogICAgICB0ZWV0aCAgICAgOiBuZXcgUmVnRXhwKCAnXnRlZXRoJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBnZWVzZSAgICAgOiBuZXcgUmVnRXhwKCAnXmdlZXNlJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBxdWl6emVzICAgOiBuZXcgUmVnRXhwKCAnKHF1aXopemVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICB3aGVyZWFzZXMgOiBuZXcgUmVnRXhwKCAnXih3aGVyZWFzKWVzJCcgICAgICwgJ2dpJyApLAogICAgICBzcyAgICAgICAgOiBuZXcgUmVnRXhwKCAnc3MkJyAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzICAgICAgICAgOiBuZXcgUmVnRXhwKCAncyQnICAgICAgICAgICAgICAgICwgJ2dpJyApCiAgICB9LAoKICAgIHNpbmd1bGFyIDogewogICAgICBtYW4gICAgIDogbmV3IFJlZ0V4cCggJ14obSlhbiQnICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIHBlcnNvbiAgOiBuZXcgUmVnRXhwKCAnKHBlKXJzb24kJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgY2hpbGQgICA6IG5ldyBSZWdFeHAoICcoY2hpbGQpJCcgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBveCAgICAgIDogbmV3IFJlZ0V4cCggJ14ob3gpJCcgICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIGF4aXMgICAgOiBuZXcgUmVnRXhwKCAnKGF4fHRlc3QpaXMkJyAgICAgICAgICAsICdnaScgKSwKICAgICAgb2N0b3B1cyA6IG5ldyBSZWdFeHAoICcob2N0b3B8dmlyKXVzJCcgICAgICAgICwgJ2dpJyApLAogICAgICBhbGlhcyAgIDogbmV3IFJlZ0V4cCggJyhhbGlhc3xzdGF0dXMpJCcgICAgICAgLCAnZ2knICksCiAgICAgIHN1bW1vbnMgOiBuZXcgUmVnRXhwKCAnXihzdW1tb25zKSQnICAgICAgICAgICAsICdnaScgKSwKICAgICAgYnVzICAgICA6IG5ldyBSZWdFeHAoICcoYnUpcyQnICAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBidWZmYWxvIDogbmV3IFJlZ0V4cCggJyhidWZmYWx8dG9tYXR8cG90YXQpbyQnLCAnZ2knICksCiAgICAgIHRpdW0gICAgOiBuZXcgUmVnRXhwKCAnKFt0aV0pdW0kJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgc2lzICAgICA6IG5ldyBSZWdFeHAoICdzaXMkJyAgICAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBmZmUgICAgIDogbmV3IFJlZ0V4cCggJyg/OihbXmZdKWZlfChbbHJdKWYpJCcgLCAnZ2knICksCiAgICAgIGhpdmUgICAgOiBuZXcgUmVnRXhwKCAnKGhpfHRpKXZlJCcgICAgICAgICAgICAsICdnaScgKSwKICAgICAgYWVpb3V5eSA6IG5ldyBSZWdFeHAoICcoW15hZWlvdXldfHF1KXkkJyAgICAgICwgJ2dpJyApLAogICAgICB4ICAgICAgIDogbmV3IFJlZ0V4cCggJyh4fGNofHNzfHNoKSQnICAgICAgICAgLCAnZ2knICksCiAgICAgIG1hdHJpeCAgOiBuZXcgUmVnRXhwKCAnKG1hdHIpaXgkJyAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgdmVydGV4ICA6IG5ldyBSZWdFeHAoICcodmVydHxpbmQpZXgkJyAgICAgICAgICwgJ2dpJyApLAogICAgICBtb3VzZSAgIDogbmV3IFJlZ0V4cCggJyhbbXxsXSlvdXNlJCcgICAgICAgICAgLCAnZ2knICksCiAgICAgIGZvb3QgICAgOiBuZXcgUmVnRXhwKCAnXmZvb3QkJyAgICAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgdG9vdGggICA6IG5ldyBSZWdFeHAoICdedG9vdGgkJyAgICAgICAgICAgICAgICwgJ2dpJyApLAogICAgICBnb29zZSAgIDogbmV3IFJlZ0V4cCggJ15nb29zZSQnICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIHF1aXogICAgOiBuZXcgUmVnRXhwKCAnKHF1aXopJCcgICAgICAgICAgICAgICAsICdnaScgKSwKICAgICAgd2hlcmVhcyA6IG5ldyBSZWdFeHAoICdeKHdoZXJlYXMpJCcgICAgICAgICAgICwgJ2dpJyApLAogICAgICBzICAgICAgIDogbmV3IFJlZ0V4cCggJ3MkJyAgICAgICAgICAgICAgICAgICAgLCAnZ2knICksCiAgICAgIGNvbW1vbiAgOiBuZXcgUmVnRXhwKCAnJCcgICAgICAgICAgICAgICAgICAgICAsICdnaScgKQogICAgfQogIH07CgogIHZhciBwbHVyYWxfcnVsZXMgPSBbCgogICAgLy8gZG8gbm90IHJlcGxhY2UgaWYgaXRzIGFscmVhZHkgYSBwbHVyYWwgd29yZAogICAgWyByZWdleC5wbHVyYWwubWVuICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5wZW9wbGUgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmNoaWxkcmVuICBdLAogICAgWyByZWdleC5wbHVyYWwudGlhICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hbmFseXNlcyAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmhpdmVzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwuY3VydmVzICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5scnZlcyAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZvdmVzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwuYWVpb3V5aWVzIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zZXJpZXMgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLm1vdmllcyAgICBdLAogICAgWyByZWdleC5wbHVyYWwueGVzICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5taWNlICAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmJ1c2VzICAgICBdLAogICAgWyByZWdleC5wbHVyYWwub2VzICAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zaG9lcyAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmNyaXNlcyAgICBdLAogICAgWyByZWdleC5wbHVyYWwub2N0b3BpICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hbGlhc2VzICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLnN1bW1vbnNlcyBdLAogICAgWyByZWdleC5wbHVyYWwub3hlbiAgICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5tYXRyaWNlcyAgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZlZXQgICAgICBdLAogICAgWyByZWdleC5wbHVyYWwudGVldGggICAgIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5nZWVzZSAgICAgXSwKICAgIFsgcmVnZXgucGx1cmFsLnF1aXp6ZXMgICBdLAogICAgWyByZWdleC5wbHVyYWwud2hlcmVhc2VzIF0sCgogICAgLy8gb3JpZ2luYWwgcnVsZQogICAgWyByZWdleC5zaW5ndWxhci5tYW4gICAgLCAnJDFlbicgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIucGVyc29uICwgJyQxb3BsZScgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY2hpbGQgICwgJyQxcmVuJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5veCAgICAgLCAnJDFlbicgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYXhpcyAgICwgJyQxZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm9jdG9wdXMsICckMWknIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmFsaWFzICAsICckMWVzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5zdW1tb25zLCAnJDFlcycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYnVzICAgICwgJyQxc2VzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5idWZmYWxvLCAnJDFvZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRpdW0gICAsICckMWEnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnNpcyAgICAsICdzZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmZmZSAgICAsICckMSQydmVzJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5oaXZlICAgLCAnJDF2ZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmFlaW91eXksICckMWllcycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIueCAgICAgICwgJyQxZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1hdHJpeCAsICckMWljZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnZlcnRleCAsICckMWljZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1vdXNlICAsICckMWljZScgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZm9vdCAgICwgJ2ZlZXQnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRvb3RoICAsICd0ZWV0aCcgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZ29vc2UgICwgJ2dlZXNlJyBdLAogICAgWyByZWdleC5zaW5ndWxhci5xdWl6ICAgLCAnJDF6ZXMnIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLndoZXJlYXMsICckMWVzJyBdLAoKICAgIFsgcmVnZXguc2luZ3VsYXIucyAgICAgLCAncycgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY29tbW9uLCAncycgXQogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBydWxlcyB0cmFuc2xhdGUgZnJvbSB0aGUgcGx1cmFsIGZvcm0gb2YgYSBub3VuIHRvIGl0cyBzaW5ndWxhciBmb3JtLgogICAqIEBwcml2YXRlCiAgICovCiAgdmFyIHNpbmd1bGFyX3J1bGVzID0gWwoKICAgIC8vIGRvIG5vdCByZXBsYWNlIGlmIGl0cyBhbHJlYWR5IGEgc2luZ3VsYXIgd29yZAogICAgWyByZWdleC5zaW5ndWxhci5tYW4gICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnBlcnNvbiAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuY2hpbGQgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5veCAgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmF4aXMgICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIub2N0b3B1cyBdLAogICAgWyByZWdleC5zaW5ndWxhci5hbGlhcyAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnN1bW1vbnMgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYnVzICAgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5idWZmYWxvIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRpdW0gICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuc2lzICAgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5mZmUgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLmhpdmUgICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuYWVpb3V5eSBdLAogICAgWyByZWdleC5zaW5ndWxhci54ICAgICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLm1hdHJpeCAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIubW91c2UgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5mb290ICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLnRvb3RoICAgXSwKICAgIFsgcmVnZXguc2luZ3VsYXIuZ29vc2UgICBdLAogICAgWyByZWdleC5zaW5ndWxhci5xdWl6ICAgIF0sCiAgICBbIHJlZ2V4LnNpbmd1bGFyLndoZXJlYXMgXSwKCiAgICAvLyBvcmlnaW5hbCBydWxlCiAgICBbIHJlZ2V4LnBsdXJhbC5tZW4gICAgICAsICckMWFuJyBdLAogICAgWyByZWdleC5wbHVyYWwucGVvcGxlICAgLCAnJDFyc29uJyBdLAogICAgWyByZWdleC5wbHVyYWwuY2hpbGRyZW4gLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC50aWEgICAgICAsICckMXVtJyBdLAogICAgWyByZWdleC5wbHVyYWwuYW5hbHlzZXMgLCAnJDEkMnNpcycgXSwKICAgIFsgcmVnZXgucGx1cmFsLmhpdmVzICAgICwgJyQxdmUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5jdXJ2ZXMgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLmxydmVzICAgICwgJyQxZicgXSwKICAgIFsgcmVnZXgucGx1cmFsLmZvdmVzICAgICwgJyQxZmUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5tb3ZpZXMgICAsICckMW92aWUnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5hZWlvdXlpZXMsICckMXknIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zZXJpZXMgICAsICckMWVyaWVzJyBdLAogICAgWyByZWdleC5wbHVyYWwueGVzICAgICAgLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5taWNlICAgICAsICckMW91c2UnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5idXNlcyAgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLm9lcyAgICAgICwgJyQxJyBdLAogICAgWyByZWdleC5wbHVyYWwuc2hvZXMgICAgLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5jcmlzZXMgICAsICckMWlzJyBdLAogICAgWyByZWdleC5wbHVyYWwub2N0b3BpICAgLCAnJDF1cycgXSwKICAgIFsgcmVnZXgucGx1cmFsLmFsaWFzZXMgICwgJyQxJyBdLAogICAgWyByZWdleC5wbHVyYWwuc3VtbW9uc2VzLCAnJDEnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5veGVuICAgICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLm1hdHJpY2VzICwgJyQxaXgnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC52ZXJ0aWNlcyAsICckMWV4JyBdLAogICAgWyByZWdleC5wbHVyYWwuZmVldCAgICAgLCAnZm9vdCcgXSwKICAgIFsgcmVnZXgucGx1cmFsLnRlZXRoICAgICwgJ3Rvb3RoJyBdLAogICAgWyByZWdleC5wbHVyYWwuZ2Vlc2UgICAgLCAnZ29vc2UnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5xdWl6emVzICAsICckMScgXSwKICAgIFsgcmVnZXgucGx1cmFsLndoZXJlYXNlcywgJyQxJyBdLAoKICAgIFsgcmVnZXgucGx1cmFsLnNzLCAnc3MnIF0sCiAgICBbIHJlZ2V4LnBsdXJhbC5zICwgJycgXQogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGlzIGlzIGEgbGlzdCBvZiB3b3JkcyB0aGF0IHNob3VsZCBub3QgYmUgY2FwaXRhbGl6ZWQgZm9yIHRpdGxlIGNhc2UuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgbm9uX3RpdGxlY2FzZWRfd29yZHMgPSBbCiAgICAnYW5kJywgJ29yJywgJ25vcicsICdhJywgJ2FuJywgJ3RoZScsICdzbycsICdidXQnLCAndG8nLCAnb2YnLCAnYXQnLCdieScsCiAgICAnZnJvbScsICdpbnRvJywgJ29uJywgJ29udG8nLCAnb2ZmJywgJ291dCcsICdpbicsICdvdmVyJywgJ3dpdGgnLCAnZm9yJwogIF07CgogIC8qKgogICAqIEBkZXNjcmlwdGlvbiBUaGVzZSBhcmUgcmVndWxhciBleHByZXNzaW9ucyB1c2VkIGZvciBjb252ZXJ0aW5nIGJldHdlZW4gU3RyaW5nIGZvcm1hdHMuCiAgICogQHByaXZhdGUKICAgKi8KICB2YXIgaWRfc3VmZml4ICAgICAgICAgPSBuZXcgUmVnRXhwKCAnKF9pZHN8X2lkKSQnLCAnZycgKTsKICB2YXIgdW5kZXJiYXIgICAgICAgICAgPSBuZXcgUmVnRXhwKCAnXycsICdnJyApOwogIHZhciBzcGFjZV9vcl91bmRlcmJhciA9IG5ldyBSZWdFeHAoICdbXCBfXScsICdnJyApOwogIHZhciB1cHBlcmNhc2UgICAgICAgICA9IG5ldyBSZWdFeHAoICcoW0EtWl0pJywgJ2cnICk7CiAgdmFyIHVuZGVyYmFyX3ByZWZpeCAgID0gbmV3IFJlZ0V4cCggJ15fJyApOwoKICB2YXIgaW5mbGVjdG9yID0gewoKICAvKioKICAgKiBBIGhlbHBlciBtZXRob2QgdGhhdCBhcHBsaWVzIHJ1bGVzIGJhc2VkIHJlcGxhY2VtZW50IHRvIGEgU3RyaW5nLgogICAqIEBwcml2YXRlCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBTdHJpbmcgdG8gbW9kaWZ5IGFuZCByZXR1cm4gYmFzZWQgb24gdGhlIHBhc3NlZCBydWxlcy4KICAgKiBAcGFyYW0ge0FycmF5OiBbUmVnRXhwLCBTdHJpbmddfSBydWxlcyBSZWdleHAgdG8gbWF0Y2ggcGFpcmVkIHdpdGggU3RyaW5nIHRvIHVzZSBmb3IgcmVwbGFjZW1lbnQKICAgKiBAcGFyYW0ge0FycmF5OiBbU3RyaW5nXX0gc2tpcCBTdHJpbmdzIHRvIHNraXAgaWYgdGhleSBtYXRjaAogICAqIEBwYXJhbSB7U3RyaW5nfSBvdmVycmlkZSBTdHJpbmcgdG8gcmV0dXJuIGFzIHRob3VnaCB0aGlzIG1ldGhvZCBzdWNjZWVkZWQgKHVzZWQgdG8gY29uZm9ybSB0byBBUElzKQogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBwYXNzZWQgU3RyaW5nIG1vZGlmaWVkIGJ5IHBhc3NlZCBydWxlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHRoaXMuX2FwcGx5X3J1bGVzKCAnY293cycsIHNpbmd1bGFyX3J1bGVzICk7IC8vID09PSAnY293JwogICAqLwogICAgX2FwcGx5X3J1bGVzIDogZnVuY3Rpb24gKCBzdHIsIHJ1bGVzLCBza2lwLCBvdmVycmlkZSApewogICAgICBpZiggb3ZlcnJpZGUgKXsKICAgICAgICBzdHIgPSBvdmVycmlkZTsKICAgICAgfWVsc2V7CiAgICAgICAgdmFyIGlnbm9yZSA9ICggaW5mbGVjdG9yLmluZGV4T2YoIHNraXAsIHN0ci50b0xvd2VyQ2FzZSgpKSA+IC0xICk7CgogICAgICAgIGlmKCAhaWdub3JlICl7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICB2YXIgaiA9IHJ1bGVzLmxlbmd0aDsKCiAgICAgICAgICBmb3IoIDsgaSA8IGo7IGkrKyApewogICAgICAgICAgICBpZiggc3RyLm1hdGNoKCBydWxlc1sgaSBdWyAwIF0pKXsKICAgICAgICAgICAgICBpZiggcnVsZXNbIGkgXVsgMSBdICE9PSB1bmRlZmluZWQgKXsKICAgICAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCBydWxlc1sgaSBdWyAwIF0sIHJ1bGVzWyBpIF1bIDEgXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGxldHMgdXMgZGV0ZWN0IGlmIGFuIEFycmF5IGNvbnRhaW5zIGEgZ2l2ZW4gZWxlbWVudC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtBcnJheX0gYXJyIFRoZSBzdWJqZWN0IGFycmF5LgogICAqIEBwYXJhbSB7T2JqZWN0fSBpdGVtIE9iamVjdCB0byBsb2NhdGUgaW4gdGhlIEFycmF5LgogICAqIEBwYXJhbSB7TnVtYmVyfSBmcm9tX2luZGV4IFN0YXJ0cyBjaGVja2luZyBmcm9tIHRoaXMgcG9zaXRpb24gaW4gdGhlIEFycmF5LihvcHRpb25hbCkKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjb21wYXJlX2Z1bmMgRnVuY3Rpb24gdXNlZCB0byBjb21wYXJlIEFycmF5IGl0ZW0gdnMgcGFzc2VkIGl0ZW0uKG9wdGlvbmFsKQogICAqIEByZXR1cm5zIHtOdW1iZXJ9IFJldHVybiBpbmRleCBwb3NpdGlvbiBpbiB0aGUgQXJyYXkgb2YgdGhlIHBhc3NlZCBpdGVtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLmluZGV4T2YoWyAnaGknLCd0aGVyZScgXSwgJ2d1eXMnICk7IC8vID09PSAtMQogICAqICAgICBpbmZsZWN0aW9uLmluZGV4T2YoWyAnaGknLCd0aGVyZScgXSwgJ2hpJyApOyAvLyA9PT0gMAogICAqLwogICAgaW5kZXhPZiA6IGZ1bmN0aW9uICggYXJyLCBpdGVtLCBmcm9tX2luZGV4LCBjb21wYXJlX2Z1bmMgKXsKICAgICAgaWYoICFmcm9tX2luZGV4ICl7CiAgICAgICAgZnJvbV9pbmRleCA9IC0xOwogICAgICB9CgogICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgdmFyIGkgICAgID0gZnJvbV9pbmRleDsKICAgICAgdmFyIGogICAgID0gYXJyLmxlbmd0aDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgaWYoIGFyclsgaSBdICA9PT0gaXRlbSB8fCBjb21wYXJlX2Z1bmMgJiYgY29tcGFyZV9mdW5jKCBhcnJbIGkgXSwgaXRlbSApKXsKICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGluZGV4OwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgcGx1cmFsaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7U3RyaW5nfSBwbHVyYWwgT3ZlcnJpZGVzIG5vcm1hbCBvdXRwdXQgd2l0aCBzYWlkIFN0cmluZy4ob3B0aW9uYWwpCiAgICogQHJldHVybnMge1N0cmluZ30gU2luZ3VsYXIgRW5nbGlzaCBsYW5ndWFnZSBub3VucyBhcmUgcmV0dXJuZWQgaW4gcGx1cmFsIGZvcm0uCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24ucGx1cmFsaXplKCAncGVyc29uJyApOyAvLyA9PT0gJ3Blb3BsZScKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdvY3RvcHVzJyApOyAvLyA9PT0gJ29jdG9waScKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdIYXQnICk7IC8vID09PSAnSGF0cycKICAgKiAgICAgaW5mbGVjdGlvbi5wbHVyYWxpemUoICdwZXJzb24nLCAnZ3V5cycgKTsgLy8gPT09ICdndXlzJwogICAqLwogICAgcGx1cmFsaXplIDogZnVuY3Rpb24gKCBzdHIsIHBsdXJhbCApewogICAgICByZXR1cm4gaW5mbGVjdG9yLl9hcHBseV9ydWxlcyggc3RyLCBwbHVyYWxfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBwbHVyYWwgKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIHNpbmd1bGFyaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7U3RyaW5nfSBzaW5ndWxhciBPdmVycmlkZXMgbm9ybWFsIG91dHB1dCB3aXRoIHNhaWQgU3RyaW5nLihvcHRpb25hbCkKICAgKiBAcmV0dXJucyB7U3RyaW5nfSBQbHVyYWwgRW5nbGlzaCBsYW5ndWFnZSBub3VucyBhcmUgcmV0dXJuZWQgaW4gc2luZ3VsYXIgZm9ybS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5zaW5ndWxhcml6ZSggJ3Blb3BsZScgKTsgLy8gPT09ICdwZXJzb24nCiAgICogICAgIGluZmxlY3Rpb24uc2luZ3VsYXJpemUoICdvY3RvcGknICk7IC8vID09PSAnb2N0b3B1cycKICAgKiAgICAgaW5mbGVjdGlvbi5zaW5ndWxhcml6ZSggJ0hhdHMnICk7IC8vID09PSAnSGF0JwogICAqICAgICBpbmZsZWN0aW9uLnNpbmd1bGFyaXplKCAnZ3V5cycsICdwZXJzb24nICk7IC8vID09PSAncGVyc29uJwogICAqLwogICAgc2luZ3VsYXJpemUgOiBmdW5jdGlvbiAoIHN0ciwgc2luZ3VsYXIgKXsKICAgICAgcmV0dXJuIGluZmxlY3Rvci5fYXBwbHlfcnVsZXMoIHN0ciwgc2luZ3VsYXJfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBzaW5ndWxhciApOwogICAgfSwKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gd2lsbCBwbHVyYWxpemUgb3Igc2luZ3VsYXJsaXplIGEgU3RyaW5nIGFwcHJvcHJpYXRlbHkgYmFzZWQgb24gYW4gaW50ZWdlciB2YWx1ZQogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge051bWJlcn0gY291bnQgVGhlIG51bWJlciB0byBiYXNlIHBsdXJhbGl6YXRpb24gb2ZmIG9mLgogICAqIEBwYXJhbSB7U3RyaW5nfSBzaW5ndWxhciBPdmVycmlkZXMgbm9ybWFsIG91dHB1dCB3aXRoIHNhaWQgU3RyaW5nLihvcHRpb25hbCkKICAgKiBAcGFyYW0ge1N0cmluZ30gcGx1cmFsIE92ZXJyaWRlcyBub3JtYWwgb3V0cHV0IHdpdGggc2FpZCBTdHJpbmcuKG9wdGlvbmFsKQogICAqIEByZXR1cm5zIHtTdHJpbmd9IEVuZ2xpc2ggbGFuZ3VhZ2Ugbm91bnMgYXJlIHJldHVybmVkIGluIHRoZSBwbHVyYWwgb3Igc2luZ3VsYXIgZm9ybSBiYXNlZCBvbiB0aGUgY291bnQuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uaW5mbGVjdCggJ3Blb3BsZScgMSApOyAvLyA9PT0gJ3BlcnNvbicKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnb2N0b3BpJyAxICk7IC8vID09PSAnb2N0b3B1cycKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnSGF0cycgMSApOyAvLyA9PT0gJ0hhdCcKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnZ3V5cycsIDEgLCAncGVyc29uJyApOyAvLyA9PT0gJ3BlcnNvbicKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAncGVyc29uJywgMiApOyAvLyA9PT0gJ3Blb3BsZScKICAgKiAgICAgaW5mbGVjdGlvbi5pbmZsZWN0KCAnb2N0b3B1cycsIDIgKTsgLy8gPT09ICdvY3RvcGknCiAgICogICAgIGluZmxlY3Rpb24uaW5mbGVjdCggJ0hhdCcsIDIgKTsgLy8gPT09ICdIYXRzJwogICAqICAgICBpbmZsZWN0aW9uLmluZmxlY3QoICdwZXJzb24nLCAyLCBudWxsLCAnZ3V5cycgKTsgLy8gPT09ICdndXlzJwogICAqLwogICAgaW5mbGVjdCA6IGZ1bmN0aW9uICggc3RyLCBjb3VudCwgc2luZ3VsYXIsIHBsdXJhbCApewogICAgICBjb3VudCA9IHBhcnNlSW50KCBjb3VudCwgMTAgKTsKCiAgICAgIGlmKCBpc05hTiggY291bnQgKSkgcmV0dXJuIHN0cjsKCiAgICAgIGlmKCBjb3VudCA9PT0gMCB8fCBjb3VudCA+IDEgKXsKICAgICAgICByZXR1cm4gaW5mbGVjdG9yLl9hcHBseV9ydWxlcyggc3RyLCBwbHVyYWxfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBwbHVyYWwgKTsKICAgICAgfWVsc2V7CiAgICAgICAgcmV0dXJuIGluZmxlY3Rvci5fYXBwbHlfcnVsZXMoIHN0ciwgc2luZ3VsYXJfcnVsZXMsIHVuY291bnRhYmxlX3dvcmRzLCBzaW5ndWxhciApOwogICAgICB9CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyBjYW1lbGl6YXRpb24gc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGxvd19maXJzdF9sZXR0ZXIgRGVmYXVsdCBpcyB0byBjYXBpdGFsaXplIHRoZSBmaXJzdCBsZXR0ZXIgb2YgdGhlIHJlc3VsdHMuKG9wdGlvbmFsKQogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgUGFzc2luZyB0cnVlIHdpbGwgbG93ZXJjYXNlIGl0LgogICAqIEByZXR1cm5zIHtTdHJpbmd9IExvd2VyIGNhc2UgdW5kZXJzY29yZWQgd29yZHMgd2lsbCBiZSByZXR1cm5lZCBpbiBjYW1lbCBjYXNlLgogICAqICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbGx5ICcvJyBpcyB0cmFuc2xhdGVkIHRvICc6OicKICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5jYW1lbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlUHJvcGVydGllcycKICAgKiAgICAgaW5mbGVjdGlvbi5jYW1lbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycsIHRydWUgKTsgLy8gPT09ICdtZXNzYWdlUHJvcGVydGllcycKICAgKi8KICAgIGNhbWVsaXplIDogZnVuY3Rpb24gKCBzdHIsIGxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgdmFyIHN0cl9wYXRoID0gc3RyLnNwbGl0KCAnLycgKTsKICAgICAgdmFyIGkgICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgID0gc3RyX3BhdGgubGVuZ3RoOwogICAgICB2YXIgc3RyX2FyciwgaW5pdF94LCBrLCBsLCBmaXJzdDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgc3RyX2FyciA9IHN0cl9wYXRoWyBpIF0uc3BsaXQoICdfJyApOwogICAgICAgIGsgICAgICAgPSAwOwogICAgICAgIGwgICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKCiAgICAgICAgZm9yKCA7IGsgPCBsOyBrKysgKXsKICAgICAgICAgIGlmKCBrICE9PSAwICl7CiAgICAgICAgICAgIHN0cl9hcnJbIGsgXSA9IHN0cl9hcnJbIGsgXS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgfQoKICAgICAgICAgIGZpcnN0ID0gc3RyX2FyclsgayBdLmNoYXJBdCggMCApOwogICAgICAgICAgZmlyc3QgPSBsb3dfZmlyc3RfbGV0dGVyICYmIGkgPT09IDAgJiYgayA9PT0gMAogICAgICAgICAgICA/IGZpcnN0LnRvTG93ZXJDYXNlKCkgOiBmaXJzdC50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgc3RyX2FyclsgayBdID0gZmlyc3QgKyBzdHJfYXJyWyBrIF0uc3Vic3RyaW5nKCAxICk7CiAgICAgICAgfQoKICAgICAgICBzdHJfcGF0aFsgaSBdID0gc3RyX2Fyci5qb2luKCAnJyApOwogICAgICB9CgogICAgICByZXR1cm4gc3RyX3BhdGguam9pbiggJzo6JyApOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgdW5kZXJzY29yZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEBwYXJhbSB7Qm9vbGVhbn0gYWxsX3VwcGVyX2Nhc2UgRGVmYXVsdCBpcyB0byBsb3dlcmNhc2UgYW5kIGFkZCB1bmRlcnNjb3JlIHByZWZpeC4ob3B0aW9uYWwpCiAgICogICAgICAgICAgICAgICAgICBQYXNzaW5nIHRydWUgd2lsbCByZXR1cm4gYXMgZW50ZXJlZC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBDYW1lbCBjYXNlZCB3b3JkcyBhcmUgcmV0dXJuZWQgYXMgbG93ZXIgY2FzZWQgYW5kIHVuZGVyc2NvcmVkLgogICAqICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbGx5ICc6OicgaXMgdHJhbnNsYXRlZCB0byAnLycuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24udW5kZXJzY29yZSggJ01lc3NhZ2VQcm9wZXJ0aWVzJyApOyAvLyA9PT0gJ21lc3NhZ2VfcHJvcGVydGllcycKICAgKiAgICAgaW5mbGVjdGlvbi51bmRlcnNjb3JlKCAnbWVzc2FnZVByb3BlcnRpZXMnICk7IC8vID09PSAnbWVzc2FnZV9wcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLnVuZGVyc2NvcmUoICdNUCcsIHRydWUgKTsgLy8gPT09ICdNUCcKICAgKi8KICAgIHVuZGVyc2NvcmUgOiBmdW5jdGlvbiAoIHN0ciwgYWxsX3VwcGVyX2Nhc2UgKXsKICAgICAgaWYoIGFsbF91cHBlcl9jYXNlICYmIHN0ciA9PT0gc3RyLnRvVXBwZXJDYXNlKCkpIHJldHVybiBzdHI7CgogICAgICB2YXIgc3RyX3BhdGggPSBzdHIuc3BsaXQoICc6OicgKTsKICAgICAgdmFyIGkgICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgID0gc3RyX3BhdGgubGVuZ3RoOwoKICAgICAgZm9yKCA7IGkgPCBqOyBpKysgKXsKICAgICAgICBzdHJfcGF0aFsgaSBdID0gc3RyX3BhdGhbIGkgXS5yZXBsYWNlKCB1cHBlcmNhc2UsICdfJDEnICk7CiAgICAgICAgc3RyX3BhdGhbIGkgXSA9IHN0cl9wYXRoWyBpIF0ucmVwbGFjZSggdW5kZXJiYXJfcHJlZml4LCAnJyApOwogICAgICB9CgogICAgICByZXR1cm4gc3RyX3BhdGguam9pbiggJy8nICkudG9Mb3dlckNhc2UoKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIGh1bWFuaXplIHN1cHBvcnQgdG8gZXZlcnkgU3RyaW5nIG9iamVjdC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHBhcmFtIHtCb29sZWFufSBsb3dfZmlyc3RfbGV0dGVyIERlZmF1bHQgaXMgdG8gY2FwaXRhbGl6ZSB0aGUgZmlyc3QgbGV0dGVyIG9mIHRoZSByZXN1bHRzLihvcHRpb25hbCkKICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBhc3NpbmcgdHJ1ZSB3aWxsIGxvd2VyY2FzZSBpdC4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBMb3dlciBjYXNlIHVuZGVyc2NvcmVkIHdvcmRzIHdpbGwgYmUgcmV0dXJuZWQgaW4gaHVtYW5pemVkIGZvcm0uCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uaHVtYW5pemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnTWVzc2FnZSBwcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLmh1bWFuaXplKCAnbWVzc2FnZV9wcm9wZXJ0aWVzJywgdHJ1ZSApOyAvLyA9PT0gJ21lc3NhZ2UgcHJvcGVydGllcycKICAgKi8KICAgIGh1bWFuaXplIDogZnVuY3Rpb24gKCBzdHIsIGxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCBpZF9zdWZmaXgsICcnICk7CiAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKCB1bmRlcmJhciwgJyAnICk7CgogICAgICBpZiggIWxvd19maXJzdF9sZXR0ZXIgKXsKICAgICAgICBzdHIgPSBpbmZsZWN0b3IuY2FwaXRhbGl6ZSggc3RyICk7CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHI7CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyBjYXBpdGFsaXphdGlvbiBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IEFsbCBjaGFyYWN0ZXJzIHdpbGwgYmUgbG93ZXIgY2FzZSBhbmQgdGhlIGZpcnN0IHdpbGwgYmUgdXBwZXIuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uY2FwaXRhbGl6ZSggJ21lc3NhZ2VfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlX3Byb3BlcnRpZXMnCiAgICogICAgIGluZmxlY3Rpb24uY2FwaXRhbGl6ZSggJ21lc3NhZ2UgcHJvcGVydGllcycsIHRydWUgKTsgLy8gPT09ICdNZXNzYWdlIHByb3BlcnRpZXMnCiAgICovCiAgICBjYXBpdGFsaXplIDogZnVuY3Rpb24gKCBzdHIgKXsKICAgICAgc3RyID0gc3RyLnRvTG93ZXJDYXNlKCk7CgogICAgICByZXR1cm4gc3RyLnN1YnN0cmluZyggMCwgMSApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc3Vic3RyaW5nKCAxICk7CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gcmVwbGFjZXMgdW5kZXJzY29yZXMgd2l0aCBkYXNoZXMgaW4gdGhlIHN0cmluZy4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHJldHVybnMge1N0cmluZ30gUmVwbGFjZXMgYWxsIHNwYWNlcyBvciB1bmRlcnNjb3JlcyB3aXRoIGRhc2hlcy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5kYXNoZXJpemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnbWVzc2FnZS1wcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLmRhc2hlcml6ZSggJ01lc3NhZ2UgUHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlLVByb3BlcnRpZXMnCiAgICovCiAgICBkYXNoZXJpemUgOiBmdW5jdGlvbiAoIHN0ciApewogICAgICByZXR1cm4gc3RyLnJlcGxhY2UoIHNwYWNlX29yX3VuZGVyYmFyLCAnLScgKTsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIHRpdGxlaXplIHN1cHBvcnQgdG8gZXZlcnkgU3RyaW5nIG9iamVjdC4KICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHJldHVybnMge1N0cmluZ30gQ2FwaXRhbGl6ZXMgd29yZHMgYXMgeW91IHdvdWxkIGZvciBhIGJvb2sgdGl0bGUuCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24udGl0bGVpemUoICdtZXNzYWdlX3Byb3BlcnRpZXMnICk7IC8vID09PSAnTWVzc2FnZSBQcm9wZXJ0aWVzJwogICAqICAgICBpbmZsZWN0aW9uLnRpdGxlaXplKCAnbWVzc2FnZSBwcm9wZXJ0aWVzIHRvIGtlZXAnICk7IC8vID09PSAnTWVzc2FnZSBQcm9wZXJ0aWVzIHRvIEtlZXAnCiAgICovCiAgICB0aXRsZWl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciAgICAgICAgID0gc3RyLnRvTG93ZXJDYXNlKCkucmVwbGFjZSggdW5kZXJiYXIsICcgJyApOwogICAgICB2YXIgc3RyX2FyciA9IHN0ci5zcGxpdCggJyAnICk7CiAgICAgIHZhciBpICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKICAgICAgdmFyIGQsIGssIGw7CgogICAgICBmb3IoIDsgaSA8IGo7IGkrKyApewogICAgICAgIGQgPSBzdHJfYXJyWyBpIF0uc3BsaXQoICctJyApOwogICAgICAgIGsgPSAwOwogICAgICAgIGwgPSBkLmxlbmd0aDsKCiAgICAgICAgZm9yKCA7IGsgPCBsOyBrKyspewogICAgICAgICAgaWYoIGluZmxlY3Rvci5pbmRleE9mKCBub25fdGl0bGVjYXNlZF93b3JkcywgZFsgayBdLnRvTG93ZXJDYXNlKCkpIDwgMCApewogICAgICAgICAgICBkWyBrIF0gPSBpbmZsZWN0b3IuY2FwaXRhbGl6ZSggZFsgayBdKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHN0cl9hcnJbIGkgXSA9IGQuam9pbiggJy0nICk7CiAgICAgIH0KCiAgICAgIHN0ciA9IHN0cl9hcnIuam9pbiggJyAnICk7CiAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoIDAsIDEgKS50b1VwcGVyQ2FzZSgpICsgc3RyLnN1YnN0cmluZyggMSApOwoKICAgICAgcmV0dXJuIHN0cjsKICAgIH0sCgoKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBhZGRzIGRlbW9kdWxpemUgc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBSZW1vdmVzIG1vZHVsZSBuYW1lcyBsZWF2aW5nIG9ubHkgY2xhc3MgbmFtZXMuKFJ1Ynkgc3R5bGUpCiAgICogQGV4YW1wbGUKICAgKgogICAqICAgICB2YXIgaW5mbGVjdGlvbiA9IHJlcXVpcmUoICdpbmZsZWN0aW9uJyApOwogICAqCiAgICogICAgIGluZmxlY3Rpb24uZGVtb2R1bGl6ZSggJ01lc3NhZ2U6OkJ1czo6UHJvcGVydGllcycgKTsgLy8gPT09ICdQcm9wZXJ0aWVzJwogICAqLwogICAgZGVtb2R1bGl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHZhciBzdHJfYXJyID0gc3RyLnNwbGl0KCAnOjonICk7CgogICAgICByZXR1cm4gc3RyX2Fyclsgc3RyX2Fyci5sZW5ndGggLSAxIF07CiAgICB9LAoKCgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gYWRkcyB0YWJsZWl6ZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBjYW1lbCBjYXNlZCB3b3JkcyBpbnRvIHRoZWlyIHVuZGVyc2NvcmVkIHBsdXJhbCBmb3JtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLnRhYmxlaXplKCAnTWVzc2FnZUJ1c1Byb3BlcnR5JyApOyAvLyA9PT0gJ21lc3NhZ2VfYnVzX3Byb3BlcnRpZXMnCiAgICovCiAgICB0YWJsZWl6ZSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci51bmRlcnNjb3JlKCBzdHIgKTsKICAgICAgc3RyID0gaW5mbGVjdG9yLnBsdXJhbGl6ZSggc3RyICk7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgY2xhc3NpZmljYXRpb24gc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfSBVbmRlcnNjb3JlZCBwbHVyYWwgbm91bnMgYmVjb21lIHRoZSBjYW1lbCBjYXNlZCBzaW5ndWxhciBmb3JtLgogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLmNsYXNzaWZ5KCAnbWVzc2FnZV9idXNfcHJvcGVydGllcycgKTsgLy8gPT09ICdNZXNzYWdlQnVzUHJvcGVydHknCiAgICovCiAgICBjbGFzc2lmeSA6IGZ1bmN0aW9uICggc3RyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5jYW1lbGl6ZSggc3RyICk7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5zaW5ndWxhcml6ZSggc3RyICk7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgZm9yZWlnbiBrZXkgc3VwcG9ydCB0byBldmVyeSBTdHJpbmcgb2JqZWN0LgogICAqIEBwdWJsaWMKICAgKiBAZnVuY3Rpb24KICAgKiBAcGFyYW0ge1N0cmluZ30gc3RyIFRoZSBzdWJqZWN0IHN0cmluZy4KICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRyb3BfaWRfdWJhciBEZWZhdWx0IGlzIHRvIHNlcGVyYXRlIGlkIHdpdGggYW4gdW5kZXJiYXIgYXQgdGhlIGVuZCBvZiB0aGUgY2xhc3MgbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeW91IGNhbiBwYXNzIHRydWUgdG8gc2tpcCBpdC4ob3B0aW9uYWwpCiAgICogQHJldHVybnMge1N0cmluZ30gVW5kZXJzY29yZWQgcGx1cmFsIG5vdW5zIGJlY29tZSB0aGUgY2FtZWwgY2FzZWQgc2luZ3VsYXIgZm9ybS4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5mb3JlaWduX2tleSggJ01lc3NhZ2VCdXNQcm9wZXJ0eScgKTsgLy8gPT09ICdtZXNzYWdlX2J1c19wcm9wZXJ0eV9pZCcKICAgKiAgICAgaW5mbGVjdGlvbi5mb3JlaWduX2tleSggJ01lc3NhZ2VCdXNQcm9wZXJ0eScsIHRydWUgKTsgLy8gPT09ICdtZXNzYWdlX2J1c19wcm9wZXJ0eWlkJwogICAqLwogICAgZm9yZWlnbl9rZXkgOiBmdW5jdGlvbiAoIHN0ciwgZHJvcF9pZF91YmFyICl7CiAgICAgIHN0ciA9IGluZmxlY3Rvci5kZW1vZHVsaXplKCBzdHIgKTsKICAgICAgc3RyID0gaW5mbGVjdG9yLnVuZGVyc2NvcmUoIHN0ciApICsgKCggZHJvcF9pZF91YmFyICkgPyAoICcnICkgOiAoICdfJyApKSArICdpZCc7CgogICAgICByZXR1cm4gc3RyOwogICAgfSwKCgoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGFkZHMgb3JkaW5hbGl6ZSBzdXBwb3J0IHRvIGV2ZXJ5IFN0cmluZyBvYmplY3QuCiAgICogQHB1YmxpYwogICAqIEBmdW5jdGlvbgogICAqIEBwYXJhbSB7U3RyaW5nfSBzdHIgVGhlIHN1YmplY3Qgc3RyaW5nLgogICAqIEByZXR1cm5zIHtTdHJpbmd9IFJldHVybiBhbGwgZm91bmQgbnVtYmVycyB0aGVpciBzZXF1ZW5jZSBsaWtlICcyMm5kJy4KICAgKiBAZXhhbXBsZQogICAqCiAgICogICAgIHZhciBpbmZsZWN0aW9uID0gcmVxdWlyZSggJ2luZmxlY3Rpb24nICk7CiAgICoKICAgKiAgICAgaW5mbGVjdGlvbi5vcmRpbmFsaXplKCAndGhlIDEgcGl0Y2gnICk7IC8vID09PSAndGhlIDFzdCBwaXRjaCcKICAgKi8KICAgIG9yZGluYWxpemUgOiBmdW5jdGlvbiAoIHN0ciApewogICAgICB2YXIgc3RyX2FyciA9IHN0ci5zcGxpdCggJyAnICk7CiAgICAgIHZhciBpICAgICAgID0gMDsKICAgICAgdmFyIGogICAgICAgPSBzdHJfYXJyLmxlbmd0aDsKCiAgICAgIGZvciggOyBpIDwgajsgaSsrICl7CiAgICAgICAgdmFyIGsgPSBwYXJzZUludCggc3RyX2FyclsgaSBdLCAxMCApOwoKICAgICAgICBpZiggIWlzTmFOKCBrICkpewogICAgICAgICAgdmFyIGx0ZCA9IHN0cl9hcnJbIGkgXS5zdWJzdHJpbmcoIHN0cl9hcnJbIGkgXS5sZW5ndGggLSAyICk7CiAgICAgICAgICB2YXIgbGQgID0gc3RyX2FyclsgaSBdLnN1YnN0cmluZyggc3RyX2FyclsgaSBdLmxlbmd0aCAtIDEgKTsKICAgICAgICAgIHZhciBzdWYgPSAndGgnOwoKICAgICAgICAgIGlmKCBsdGQgIT0gJzExJyAmJiBsdGQgIT0gJzEyJyAmJiBsdGQgIT0gJzEzJyApewogICAgICAgICAgICBpZiggbGQgPT09ICcxJyApewogICAgICAgICAgICAgIHN1ZiA9ICdzdCc7CiAgICAgICAgICAgIH1lbHNlIGlmKCBsZCA9PT0gJzInICl7CiAgICAgICAgICAgICAgc3VmID0gJ25kJzsKICAgICAgICAgICAgfWVsc2UgaWYoIGxkID09PSAnMycgKXsKICAgICAgICAgICAgICBzdWYgPSAncmQnOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgc3RyX2FyclsgaSBdICs9IHN1ZjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBzdHJfYXJyLmpvaW4oICcgJyApOwogICAgfSwKCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBwZXJmb3JtcyBtdWx0aXBsZSBpbmZsZWN0aW9uIG1ldGhvZHMgb24gYSBzdHJpbmcKICAgKiBAcHVibGljCiAgICogQGZ1bmN0aW9uCiAgICogQHBhcmFtIHtTdHJpbmd9IHN0ciBUaGUgc3ViamVjdCBzdHJpbmcuCiAgICogQHBhcmFtIHtBcnJheX0gYXJyIEFuIGFycmF5IG9mIGluZmxlY3Rpb24gbWV0aG9kcy4KICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAqIEBleGFtcGxlCiAgICoKICAgKiAgICAgdmFyIGluZmxlY3Rpb24gPSByZXF1aXJlKCAnaW5mbGVjdGlvbicgKTsKICAgKgogICAqICAgICBpbmZsZWN0aW9uLnRyYW5zZm9ybSggJ2FsbCBqb2InLCBbICdwbHVyYWxpemUnLCAnY2FwaXRhbGl6ZScsICdkYXNoZXJpemUnIF0pOyAvLyA9PT0gJ0FsbC1qb2JzJwogICAqLwogICAgdHJhbnNmb3JtIDogZnVuY3Rpb24gKCBzdHIsIGFyciApewogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBqID0gYXJyLmxlbmd0aDsKCiAgICAgIGZvciggO2kgPCBqOyBpKysgKXsKICAgICAgICB2YXIgbWV0aG9kID0gYXJyWyBpIF07CgogICAgICAgIGlmKCB0aGlzLmhhc093blByb3BlcnR5KCBtZXRob2QgKSl7CiAgICAgICAgICBzdHIgPSB0aGlzWyBtZXRob2QgXSggc3RyICk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gc3RyOwogICAgfQogIH07CgovKioKICogQHB1YmxpYwogKi8KICBpbmZsZWN0b3IudmVyc2lvbiA9ICcxLjUuMSc7CgogIHJldHVybiBpbmZsZWN0b3I7Cn0pKTsKCn0se31dLDc2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKaWYgKHR5cGVvZiBPYmplY3QuY3JlYXRlID09PSAnZnVuY3Rpb24nKSB7CiAgLy8gaW1wbGVtZW50YXRpb24gZnJvbSBzdGFuZGFyZCBub2RlLmpzICd1dGlsJyBtb2R1bGUKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIGN0b3IucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckN0b3IucHJvdG90eXBlLCB7CiAgICAgIGNvbnN0cnVjdG9yOiB7CiAgICAgICAgdmFsdWU6IGN0b3IsCiAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgIH0KICAgIH0pOwogIH07Cn0gZWxzZSB7CiAgLy8gb2xkIHNjaG9vbCBzaGltIGZvciBvbGQgYnJvd3NlcnMKICBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIGluaGVyaXRzKGN0b3IsIHN1cGVyQ3RvcikgewogICAgY3Rvci5zdXBlcl8gPSBzdXBlckN0b3IKICAgIHZhciBUZW1wQ3RvciA9IGZ1bmN0aW9uICgpIHt9CiAgICBUZW1wQ3Rvci5wcm90b3R5cGUgPSBzdXBlckN0b3IucHJvdG90eXBlCiAgICBjdG9yLnByb3RvdHlwZSA9IG5ldyBUZW1wQ3RvcigpCiAgICBjdG9yLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGN0b3IKICB9Cn0KCn0se31dLDc3OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gS25leC5qcyAgMC43LjMKLy8gLS0tLS0tLS0tLS0tLS0KCid1c2Ugc3RyaWN0JzsKCi8vICAgICAoYykgMjAxNCBUaW0gR3JpZXNzZXIKLy8gICAgIEtuZXggbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgZGV0YWlscyBhbmQgZG9jdW1lbnRhdGlvbjoKLy8gICAgIGh0dHA6Ly9rbmV4anMub3JnCgovLyBUaGUgIktuZXgiIG9iamVjdCB3ZSdyZSBleHBvcnRpbmcgaXMganVzdCBhIHBhc3N0aHJvdWdoIHRvIGBLbmV4LmluaXRpYWxpemVgLgpmdW5jdGlvbiBLbmV4KCkgewogIHJldHVybiBLbmV4LmluaXRpYWxpemUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQoKLy8gUmVxdWlyZSB0aGUgbWFpbiBjb25zdHJ1Y3RvcnMgbmVjZXNzYXJ5IGZvciBhIGBLbmV4YCBpbnN0YW5jZSwKLy8gZWFjaCBvZiB3aGljaCBhcmUgaW5qZWN0ZWQgd2l0aCB0aGUgY3VycmVudCBpbnN0YW5jZSwgc28gdGhleSBtYWludGFpbgovLyB0aGUgY29ycmVjdCBjbGllbnQgcmVmZXJlbmNlICYgZ3JhbW1hci4KdmFyIFJhdyA9IHJlcXVpcmUoJy4vbGliL3JhdycpOwoKLy8gUnVuIGEgInJhdyIgcXVlcnksIHRob3VnaCB3ZSBjYW4ndCBkbyBhbnl0aGluZyB3aXRoIGl0IG90aGVyIHRoYW4gcHV0Ci8vIGl0IGluIGEgcXVlcnkgc3RhdGVtZW50LgpLbmV4LnJhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICByZXR1cm4gbmV3IFJhdyhzcWwsIGJpbmRpbmdzKTsKfTsKCi8vIERvaW5nIGl0IHRoaXMgd2F5IG1ha2VzIGl0IGVhc2llciB0byBidWlsZCBmb3IgYnJvd3NlcmlmeS4KdmFyIG15c3FsID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9teXNxbCcpOyB9Owp2YXIgbXlzcWwyID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9teXNxbDInKTsgfTsKdmFyIG1hcmlhID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9tYXJpYScpOyB9Owp2YXIgb3JhY2xlID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9vcmFjbGUnKTsgfTsKdmFyIHBnID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy9wb3N0Z3JlcycpOyB9Owp2YXIgc3FsaXRlMyA9IGZ1bmN0aW9uKCkgeyByZXR1cm4gcmVxdWlyZSgnLi9saWIvZGlhbGVjdHMvc3FsaXRlMycpOyB9Owp2YXIgd2Vic3FsID0gZnVuY3Rpb24oKSB7IHJldHVybiByZXF1aXJlKCcuL2xpYi9kaWFsZWN0cy93ZWJzcWwnKTsgfTsKCi8vIFRoZSBjbGllbnQgbmFtZXMgd2UnbGwgYWxsb3cgaW4gdGhlIGB7bmFtZTogbGlifWAgcGFpcmluZy4KdmFyIENsaWVudHMgPSBLbmV4LkNsaWVudHMgPSB7CiAgJ215c3FsJyAgICAgIDogbXlzcWwsCiAgJ215c3FsMicgICAgIDogbXlzcWwyLAogICdtYXJpYScgICAgICA6IG1hcmlhLAogICdtYXJpYWRiJyAgICA6IG1hcmlhLAogICdtYXJpYXNxbCcgICA6IG1hcmlhLAogICdvcmFjbGUnICAgICA6IG9yYWNsZSwKICAncGcnICAgICAgICAgOiBwZywKICAncG9zdGdyZXMnICAgOiBwZywKICAncG9zdGdyZXNxbCcgOiBwZywKICAnc3FsaXRlJyAgICAgOiBzcWxpdGUzLAogICdzcWxpdGUzJyAgICA6IHNxbGl0ZTMsCiAgJ3dlYnNxbCcgICAgIDogd2Vic3FsCn07CgovLyBFYWNoIG9mIHRoZSBtZXRob2RzIHdoaWNoIG1heSBiZSBzdGF0aWNhbGx5IGNoYWluZWQgZnJvbSBrbmV4Lgp2YXIgUXVlcnlJbnRlcmZhY2UgICA9IHJlcXVpcmUoJy4vbGliL3F1ZXJ5L21ldGhvZHMnKTsKCi8vIENyZWF0ZSBhIG5ldyAia25leCIgaW5zdGFuY2Ugd2l0aCB0aGUgYXBwcm9wcmlhdGUgY29uZmlndXJlZCBjbGllbnQuCktuZXguaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKGNvbmZpZykgewogIHZhciBEaWFsZWN0LCBjbGllbnQ7CiAgdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCiAgLy8gVGhlIG9iamVjdCB3ZSdyZSBwb3RlbnRpYWxseSB1c2luZyB0byBraWNrIG9mZiBhbgogIC8vIGluaXRpYWwgY2hhaW4uIEl0IGlzIGFzc3VtZWQgdGhhdCBga25leGAgaXNuJ3QgYQogIC8vIGNvbnN0cnVjdG9yLCBzbyB3ZSBoYXZlIG5vIHJlZmVyZW5jZSB0byAndGhpcycganVzdAogIC8vIGluIGNhc2UgaXQncyBjYWxsZWQgd2l0aCBgbmV3YC4KICBmdW5jdGlvbiBrbmV4KHRhYmxlTmFtZSkgewogICAgdmFyIHFiID0gbmV3IGNsaWVudC5RdWVyeUJ1aWxkZXIoKTsKICAgIGlmIChjb25maWcuX190cmFuc2FjdG9yX18pIHFiLnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICByZXR1cm4gdGFibGVOYW1lID8gcWIudGFibGUodGFibGVOYW1lKSA6IHFiOwogIH0KCiAgLy8gSG9vayB1cCB0aGUgImtuZXgiIG9iamVjdCBhcyBhbiBFdmVudEVtaXR0ZXIuCiAgdmFyIGVlID0gbmV3IEV2ZW50RW1pdHRlcigpOwogIGZvciAodmFyIGtleSBpbiBlZSkgewogICAga25leFtrZXldID0gZWVba2V5XTsKICB9CgogIC8vIFRoZSBgX19rbmV4X19gIGlzIHVzZWQgaWYgeW91IG5lZWQgdG8gZHVjay10eXBlIGNoZWNrIHdoZXRoZXIgdGhpcwogIC8vIGlzIGEga25leCBidWlsZGVyLCB3aXRob3V0IGEgZnVsbCBvbiBgaW5zdGFuY2VvZmAgY2hlY2suCiAga25leC5WRVJTSU9OID0ga25leC5fX2tuZXhfXyAgPSAnMC43LjMnOwogIGtuZXgucmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogICAgdmFyIHJhdyA9IG5ldyBjbGllbnQuUmF3KHNxbCwgYmluZGluZ3MpOwogICAgaWYgKGNvbmZpZy5fX3RyYW5zYWN0b3JfXykgcmF3LnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICByZXR1cm4gcmF3OwogIH07CgogIC8vIFJ1bnMgYSBuZXcgdHJhbnNhY3Rpb24sIHRha2luZyBhIGNvbnRhaW5lciBhbmQgcmV0dXJuaW5nIGEgcHJvbWlzZQogIC8vIGZvciB3aGVuIHRoZSB0cmFuc2FjdGlvbiBpcyByZXNvbHZlZC4KICBrbmV4LnRyYW5zYWN0aW9uID0gZnVuY3Rpb24oY29udGFpbmVyKSB7CiAgICByZXR1cm4gbmV3IGNsaWVudC5UcmFuc2FjdGlvbihjb250YWluZXIpOwogIH07CgogIC8vIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgdGVhcmluZyBkb3duIHRoZSBwb29sLgogIGtuZXguZGVzdHJveSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgcmV0dXJuIHRoaXMuY2xpZW50LmRlc3Ryb3koY2FsbGJhY2spOwogIH07CgogIGlmIChjb25maWcuX19jbGllbnRfXykgewogICAgY2xpZW50ID0gY29uZmlnLl9fY2xpZW50X187CiAgfSBlbHNlIHsKCiAgICAvLyBCdWlsZCB0aGUgImNsaWVudCIKICAgIHZhciBjbGllbnROYW1lID0gY29uZmlnLmNsaWVudCB8fCBjb25maWcuZGlhbGVjdDsKICAgIGlmICghQ2xpZW50c1tjbGllbnROYW1lXSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoY2xpZW50TmFtZSArICcgaXMgbm90IGEgdmFsaWQgS25leCBjbGllbnQsIGRpZCB5b3UgbWlzc3BlbGwgaXQ/Jyk7CiAgICB9CiAgICBrbmV4LnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiAnW29iamVjdCBLbmV4OicgKyBjbGllbnROYW1lICsgJ10nOwogICAgfTsKICAgIERpYWxlY3QgPSBDbGllbnRzW2NsaWVudE5hbWVdKCk7CiAgICBjbGllbnQgID0gbmV3IERpYWxlY3QoY29uZmlnKTsKCiAgICAvLyBQYXNzdGhyb3VnaCBhbGwgInN0YXJ0IiBhbmQgInF1ZXJ5IiBldmVudHMgdG8gdGhlIGtuZXggb2JqZWN0LgogICAgY2xpZW50Lm9uKCdzdGFydCcsIGZ1bmN0aW9uKG9iaikgewogICAgICBrbmV4LmVtaXQoJ3N0YXJ0Jywgb2JqKTsKICAgIH0pOwogICAgY2xpZW50Lm9uKCdxdWVyeScsIGZ1bmN0aW9uKG9iaikgewogICAgICBrbmV4LmVtaXQoJ3F1ZXJ5Jywgb2JqKTsKICAgIH0pOwogIH0KCiAgLy8gQWxsb3cgY2hhaW5pbmcgbWV0aG9kcyBmcm9tIHRoZSByb290IG9iamVjdCwgYmVmb3JlCiAgLy8gYW55IG90aGVyIGluZm9ybWF0aW9uIGlzIHNwZWNpZmllZC4KICBRdWVyeUludGVyZmFjZS5mb3JFYWNoKGZ1bmN0aW9uKG1ldGhvZCkgewogICAga25leFttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBidWlsZGVyID0ga25leCgpOwogICAgICByZXR1cm4gYnVpbGRlclttZXRob2RdLmFwcGx5KGJ1aWxkZXIsIGFyZ3VtZW50cyk7CiAgICB9OwogIH0pOwogIGtuZXguY2xpZW50ID0gY2xpZW50OwoKICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhrbmV4LCB7CgogICAgLy8gTGF6eS1sb2FkIC8gcmV0dXJuIGEgInNjaGVtYSIgYnVpbGRlciBvYmplY3QsIGVuc3VyaW5nIGl0J3MgY29udGV4dC1hd2FyZS4KICAgIHNjaGVtYTogewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghY2xpZW50LlNjaGVtYUJ1aWxkZXIpIGNsaWVudC5pbml0U2NoZW1hKCk7CiAgICAgICAgdmFyIGJ1aWxkZXIgPSBuZXcgY2xpZW50LlNjaGVtYUJ1aWxkZXIoKTsKICAgICAgICBpZiAoY29uZmlnLl9fdHJhbnNhY3Rvcl9fKSBidWlsZGVyLnRyYW5zYWN0aW5nKGNvbmZpZy5fX3RyYW5zYWN0b3JfXyk7CiAgICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICAgIH0KICAgIH0sCgogICAgLy8gTGF6eS1sb2FkIC8gcmV0dXJuIGEgYE1pZ3JhdG9yYCBvYmplY3QuCiAgICBtaWdyYXRlOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuTWlncmF0b3IpIGNsaWVudC5pbml0TWlncmF0b3IoKTsKICAgICAgICByZXR1cm4gbmV3IGNsaWVudC5NaWdyYXRvcihrbmV4KTsKICAgICAgfQogICAgfSwKCiAgICAvLyBMYXp5LWxvYWQgLyByZXR1cm4gYSBgU2VlZGVyYCBvYmplY3QuCiAgICBzZWVkOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuU2VlZGVyKSBjbGllbnQuaW5pdFNlZWRlcigpOwogICAgICAgIHJldHVybiBuZXcgY2xpZW50LlNlZWRlcihrbmV4KTsKICAgICAgfQogICAgfSwKCiAgICAvLyBMYXp5LWxvYWQgLyByZXR1cm4gYSBgRnVuY3Rpb25IZWxwZXJgIG9iamVjdC4KICAgIGZuOiB7CiAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFjbGllbnQuRnVuY3Rpb25IZWxwZXIpIGNsaWVudC5pbml0RnVuY3Rpb25IZWxwZXIoKTsKICAgICAgICByZXR1cm4gY2xpZW50LkZ1bmN0aW9uSGVscGVyOwogICAgICB9CiAgICB9CiAgfSk7CgogIHJldHVybiBrbmV4Owp9OwoKbW9kdWxlLmV4cG9ydHMgPSBLbmV4OwoKfSx7Ii4vbGliL2RpYWxlY3RzL21hcmlhIjo1MiwiLi9saWIvZGlhbGVjdHMvbXlzcWwiOjUyLCIuL2xpYi9kaWFsZWN0cy9teXNxbDIiOjUyLCIuL2xpYi9kaWFsZWN0cy9vcmFjbGUiOjUyLCIuL2xpYi9kaWFsZWN0cy9wb3N0Z3JlcyI6NTIsIi4vbGliL2RpYWxlY3RzL3NxbGl0ZTMiOjUyLCIuL2xpYi9kaWFsZWN0cy93ZWJzcWwiOjk1LCIuL2xpYi9xdWVyeS9tZXRob2RzIjoxMDcsIi4vbGliL3JhdyI6MTA4LCJldmVudHMiOjU3fV0sNzg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyAiQmFzZSBDbGllbnQiCi8vIC0tLS0tLQp2YXIgUHJvbWlzZSAgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwp2YXIgXyAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgICA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBFdmVudEVtaXR0ZXIgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovLyBUaGUgYmFzZSBjbGllbnQgcHJvdmlkZXMgdGhlIGdlbmVyYWwgc3RydWN0dXJlCi8vIGZvciBhIGRpYWxlY3Qgc3BlY2lmaWMgY2xpZW50IG9iamVjdC4gVGhlIGNsaWVudAovLyBvYmplY3QgYXR0YWNoZXMgZnJlc2ggY29uc3RydWN0b3JzIGZvciBlYWNoIGNvbXBvbmVudAovLyBvZiB0aGUgbGlicmFyeS4KZnVuY3Rpb24gQ2xpZW50KGNvbmZpZykgewogIHRoaXMuaW5pdEZvcm1hdHRlcigpOwogIHRoaXMuaW5pdFJhdygpOwogIHRoaXMuaW5pdFRyYW5zYWN0aW9uKCk7CiAgdGhpcy5pbml0UXVlcnkoKTsKICB0aGlzLm1pZ3JhdGlvbkNvbmZpZyA9IF8uY2xvbmUoY29uZmlnICYmIGNvbmZpZy5taWdyYXRpb25zKTsKICB0aGlzLnNlZWRDb25maWcgPSBfLmNsb25lKGNvbmZpZyAmJiBjb25maWcuc2VlZHMpOwp9CmluaGVyaXRzKENsaWVudCwgRXZlbnRFbWl0dGVyKTsKCi8vIFNldCB0aGUgImlzRGVidWdnaW5nIiBmbGFnIG9uIHRoZSBjbGllbnQgdG8gInRydWUiIHRvIGxvZwovLyBhbGwgcXVlcmllcyBydW4gYnkgdGhlIGNsaWVudC4KQ2xpZW50LnByb3RvdHlwZS5pc0RlYnVnZ2luZyA9IGZhbHNlOwoKLy8gQWNxdWlyZSBhIGNvbm5lY3Rpb24gZnJvbSB0aGUgcG9vbC4KQ2xpZW50LnByb3RvdHlwZS5hY3F1aXJlQ29ubmVjdGlvbiA9IGZ1bmN0aW9uKCkgewogIHZhciBwb29sID0gdGhpcy5wb29sOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIGlmICghcG9vbCkgcmV0dXJuIHJlamVjdGVyKG5ldyBFcnJvcignVGhlcmUgaXMgbm8gcG9vbCBkZWZpbmVkIG9uIHRoZSBjdXJyZW50IGNsaWVudCcpKTsKICAgIHBvb2wuYWNxdWlyZShmdW5jdGlvbihlcnIsIGNvbm5lY3Rpb24pIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdGVyKGVycik7CiAgICAgIHJlc29sdmVyKGNvbm5lY3Rpb24pOwogICAgfSk7CiAgfSk7Cn07CgovLyBSZWxlYXNlcyBhIGNvbm5lY3Rpb24gZnJvbSB0aGUgY29ubmVjdGlvbiBwb29sLAovLyByZXR1cm5pbmcgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIGNvbm5lY3Rpb24gaXMgcmVsZWFzZWQuCkNsaWVudC5wcm90b3R5cGUucmVsZWFzZUNvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgdmFyIHBvb2wgPSB0aGlzLnBvb2w7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3RlcikgewogICAgcG9vbC5yZWxlYXNlKGNvbm5lY3Rpb24sIGZ1bmN0aW9uKGVycikgewogICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0ZXIoZXJyKTsKICAgICAgcmVzb2x2ZXIoY29ubmVjdGlvbik7CiAgICB9KTsKICB9KTsKfTsKCi8vIERlc3Ryb3kgdGhlIGN1cnJlbnQgY29ubmVjdGlvbiBwb29sIGZvciB0aGUgY2xpZW50LgpDbGllbnQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihjYWxsYmFjaykgewogIHZhciBwb29sID0gdGhpcy5wb29sOwogIHZhciBwcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZXIsIHJlamVjdGVyKSB7CiAgICBpZiAoIXBvb2wpIHJlc29sdmVyKCk7CiAgICBwb29sLmRlc3Ryb3koZnVuY3Rpb24oZXJyKSB7CiAgICAgIGlmIChlcnIpIHJldHVybiByZWplY3RlcihlcnIpOwogICAgICByZXNvbHZlcigpOwogICAgfSk7CiAgfSk7CiAgLy8gQWxsb3cgZWl0aGVyIGEgY2FsbGJhY2sgb3IgcHJvbWlzZSBpbnRlcmZhY2UgZm9yIGRlc3RydWN0aW9uLgogIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgIHByb21pc2UuZXhlYyhjYWxsYmFjayk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBwcm9taXNlOwogIH0KfTsKCi8vIFJldHVybiB0aGUgZGF0YWJhc2UgYmVpbmcgdXNlZCBieSB0aGlzIGNsaWVudC4KQ2xpZW50LnByb3RvdHlwZS5kYXRhYmFzZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLmRhdGFiYXNlTmFtZSB8fCB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncy5kYXRhYmFzZTsKfTsKCm1vZHVsZS5leHBvcnRzID0gQ2xpZW50OwoKfSx7Ii4vcHJvbWlzZSI6MTAzLCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sNzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKEJ1ZmZlcil7Cid1c2Ugc3RyaWN0JzsKCmZ1bmN0aW9uIHplcm9QYWQobnVtYmVyLCBsZW5ndGgpIHsKICBudW1iZXIgPSBudW1iZXIudG9TdHJpbmcoKTsKICB3aGlsZSAobnVtYmVyLmxlbmd0aCA8IGxlbmd0aCkgewogICAgbnVtYmVyID0gJzAnICsgbnVtYmVyOwogIH0KCiAgcmV0dXJuIG51bWJlcjsKfQoKZnVuY3Rpb24gY29udmVydFRpbWV6b25lKHR6KSB7CiAgaWYgKHR6ID09PSAiWiIpIHJldHVybiAwOwoKICB2YXIgbSA9IHR6Lm1hdGNoKC8oW1wrXC1cc10pKFxkXGQpOj8oXGRcZCk/Lyk7CiAgaWYgKG0pIHsKICAgIHJldHVybiAobVsxXSA9PT0gJy0nID8gLTEgOiAxKSAqIChwYXJzZUludChtWzJdLCAxMCkgKyAoKG1bM10gPyBwYXJzZUludChtWzNdLCAxMCkgOiAwKSAvIDYwKSkgKiA2MDsKICB9CiAgcmV0dXJuIGZhbHNlOwp9Cgp2YXIgU3FsU3RyaW5nID0gZXhwb3J0czsKClNxbFN0cmluZy5lc2NhcGVJZCA9IGZ1bmN0aW9uICh2YWwsIGZvcmJpZFF1YWxpZmllZCkgewogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgIHJldHVybiB2YWwubWFwKGZ1bmN0aW9uKHYpIHsKICAgICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGVJZCh2LCBmb3JiaWRRdWFsaWZpZWQpOwogICAgfSkuam9pbignLCAnKTsKICB9CgogIGlmIChmb3JiaWRRdWFsaWZpZWQpIHsKICAgIHJldHVybiAnYCcgKyB2YWwucmVwbGFjZSgvYC9nLCAnYGAnKSArICdgJzsKICB9CiAgcmV0dXJuICdgJyArIHZhbC5yZXBsYWNlKC9gL2csICdgYCcpLnJlcGxhY2UoL1wuL2csICdgLmAnKSArICdgJzsKfTsKClNxbFN0cmluZy5lc2NhcGUgPSBmdW5jdGlvbih2YWwsIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKSB7CiAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gbnVsbCkgewogICAgcmV0dXJuICdOVUxMJzsKICB9CgogIHN3aXRjaCAodHlwZW9mIHZhbCkgewogICAgY2FzZSAnYm9vbGVhbic6IHJldHVybiAodmFsKSA/ICd0cnVlJyA6ICdmYWxzZSc7CiAgICBjYXNlICdudW1iZXInOiByZXR1cm4gdmFsKycnOwogIH0KCiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHZhbCA9IFNxbFN0cmluZy5kYXRlVG9TdHJpbmcodmFsLCB0aW1lWm9uZSB8fCAnbG9jYWwnKTsKICB9CgogIGlmIChCdWZmZXIuaXNCdWZmZXIodmFsKSkgewogICAgcmV0dXJuIFNxbFN0cmluZy5idWZmZXJUb1N0cmluZyh2YWwpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgcmV0dXJuIFNxbFN0cmluZy5hcnJheVRvTGlzdCh2YWwsIHRpbWVab25lKTsKICB9CgogIGlmICh0eXBlb2YgdmFsID09PSAnb2JqZWN0JykgewogICAgaWYgKHN0cmluZ2lmeU9iamVjdHMpIHsKICAgICAgdmFsID0gdmFsLnRvU3RyaW5nKCk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gU3FsU3RyaW5nLm9iamVjdFRvVmFsdWVzKHZhbCwgdGltZVpvbmUpOwogICAgfQogIH0KCiAgdmFsID0gdmFsLnJlcGxhY2UoL1tcMFxuXHJcYlx0XFxcJ1wiXHgxYV0vZywgZnVuY3Rpb24ocykgewogICAgc3dpdGNoKHMpIHsKICAgICAgY2FzZSAiXDAiOiByZXR1cm4gIlxcMCI7CiAgICAgIGNhc2UgIlxuIjogcmV0dXJuICJcXG4iOwogICAgICBjYXNlICJcciI6IHJldHVybiAiXFxyIjsKICAgICAgY2FzZSAiXGIiOiByZXR1cm4gIlxcYiI7CiAgICAgIGNhc2UgIlx0IjogcmV0dXJuICJcXHQiOwogICAgICBjYXNlICJceDFhIjogcmV0dXJuICJcXFoiOwogICAgICBkZWZhdWx0OiByZXR1cm4gIlxcIitzOwogICAgfQogIH0pOwogIHJldHVybiAiJyIrdmFsKyInIjsKfTsKClNxbFN0cmluZy5hcnJheVRvTGlzdCA9IGZ1bmN0aW9uKGFycmF5LCB0aW1lWm9uZSkgewogIHJldHVybiBhcnJheS5tYXAoZnVuY3Rpb24odikgewogICAgaWYgKEFycmF5LmlzQXJyYXkodikpIHJldHVybiAnKCcgKyBTcWxTdHJpbmcuYXJyYXlUb0xpc3QodiwgdGltZVpvbmUpICsgJyknOwogICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGUodiwgdHJ1ZSwgdGltZVpvbmUpOwogIH0pLmpvaW4oJywgJyk7Cn07CgpTcWxTdHJpbmcuZm9ybWF0ID0gZnVuY3Rpb24oc3FsLCB2YWx1ZXMsIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKSB7CiAgdmFsdWVzID0gIXZhbHVlcyA/IFtdIDogW10uY29uY2F0KHZhbHVlcyk7CgogIHJldHVybiBzcWwucmVwbGFjZSgvXD9cPz8vZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgIGlmICghdmFsdWVzLmxlbmd0aCkgewogICAgICByZXR1cm4gbWF0Y2g7CiAgICB9CgogICAgaWYgKG1hdGNoID09PSAiPz8iKSB7CiAgICAgIHJldHVybiBTcWxTdHJpbmcuZXNjYXBlSWQodmFsdWVzLnNoaWZ0KCkpOwogICAgfQogICAgcmV0dXJuIFNxbFN0cmluZy5lc2NhcGUodmFsdWVzLnNoaWZ0KCksIHN0cmluZ2lmeU9iamVjdHMsIHRpbWVab25lKTsKICB9KTsKfTsKClNxbFN0cmluZy5kYXRlVG9TdHJpbmcgPSBmdW5jdGlvbihkYXRlLCB0aW1lWm9uZSkgewogIHZhciBkdCA9IG5ldyBEYXRlKGRhdGUpOwoKICBpZiAodGltZVpvbmUgIT09ICdsb2NhbCcpIHsKICAgIHZhciB0eiA9IGNvbnZlcnRUaW1lem9uZSh0aW1lWm9uZSk7CgogICAgZHQuc2V0VGltZShkdC5nZXRUaW1lKCkgKyAoZHQuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKSk7CiAgICBpZiAodHogIT09IGZhbHNlKSB7CiAgICAgIGR0LnNldFRpbWUoZHQuZ2V0VGltZSgpICsgKHR6ICogNjAwMDApKTsKICAgIH0KICB9CgogIHZhciB5ZWFyICAgPSBkdC5nZXRGdWxsWWVhcigpOwogIHZhciBtb250aCAgPSB6ZXJvUGFkKGR0LmdldE1vbnRoKCkgKyAxLCAyKTsKICB2YXIgZGF5ICAgID0gemVyb1BhZChkdC5nZXREYXRlKCksIDIpOwogIHZhciBob3VyICAgPSB6ZXJvUGFkKGR0LmdldEhvdXJzKCksIDIpOwogIHZhciBtaW51dGUgPSB6ZXJvUGFkKGR0LmdldE1pbnV0ZXMoKSwgMik7CiAgdmFyIHNlY29uZCA9IHplcm9QYWQoZHQuZ2V0U2Vjb25kcygpLCAyKTsKICB2YXIgbWlsbGlzZWNvbmQgPSB6ZXJvUGFkKGR0LmdldE1pbGxpc2Vjb25kcygpLCAzKTsKCiAgcmV0dXJuIHllYXIgKyAnLScgKyBtb250aCArICctJyArIGRheSArICcgJyArIGhvdXIgKyAnOicgKyBtaW51dGUgKyAnOicgKyBzZWNvbmQgKyAnLicgKyBtaWxsaXNlY29uZDsKfTsKClNxbFN0cmluZy5idWZmZXJUb1N0cmluZyA9IGZ1bmN0aW9uKGJ1ZmZlcikgewogIHZhciBoZXggPSAnJzsKICB0cnkgewogICAgaGV4ID0gYnVmZmVyLnRvU3RyaW5nKCdoZXgnKTsKICB9IGNhdGNoIChlcnIpIHsKICAgIC8vIG5vZGUgdjAuNC54IGRvZXMgbm90IHN1cHBvcnQgaGV4IC8gdGhyb3dzIHVua25vd24gZW5jb2RpbmcgZXJyb3IKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYnVmZmVyLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBieXRlID0gYnVmZmVyW2ldOwogICAgICBoZXggKz0gemVyb1BhZChieXRlLnRvU3RyaW5nKDE2KSk7CiAgICB9CiAgfQoKICByZXR1cm4gIlgnIiArIGhleCsgIiciOwp9OwoKU3FsU3RyaW5nLm9iamVjdFRvVmFsdWVzID0gZnVuY3Rpb24ob2JqZWN0LCB0aW1lWm9uZSkgewogIHZhciB2YWx1ZXMgPSBbXTsKICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB7CiAgICB2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKICAgIGlmKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBjb250aW51ZTsKICAgIH0KCiAgICB2YWx1ZXMucHVzaCh0aGlzLmVzY2FwZUlkKGtleSkgKyAnID0gJyArIFNxbFN0cmluZy5lc2NhcGUodmFsdWUsIHRydWUsIHRpbWVab25lKSk7CiAgfQoKICByZXR1cm4gdmFsdWVzLmpvaW4oJywgJyk7Cn07Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgiYnVmZmVyIikuQnVmZmVyKQp9LHsiYnVmZmVyIjo1M31dLDgwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMyBGb3JtYXR0ZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIEZvcm1hdHRlciA9IHJlcXVpcmUoJy4uLy4uL2Zvcm1hdHRlcicpOwp2YXIgaW5oZXJpdHMgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCi8vIFRoZSAiZm9ybWF0dGVyIiBpcyB1c2VkIHRvIGVuc3VyZSBhbGwgb3V0cHV0IGlzIHByb3Blcmx5Ci8vIGVzY2FwZWQgJiBwYXJhbWV0ZXJpemVkLgpmdW5jdGlvbiBGb3JtYXR0ZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBGb3JtYXR0ZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhGb3JtYXR0ZXJfU1FMaXRlMywgRm9ybWF0dGVyKTsKCkZvcm1hdHRlcl9TUUxpdGUzLnByb3RvdHlwZS5vcGVyYXRvcnMgPSBbCiAgJz0nLCAnPCcsICc+JywgJzw9JywgJz49JywgJzw+JywgJyE9JywKICAnbGlrZScsICdub3QgbGlrZScsICdiZXR3ZWVuJywgJ2lsaWtlJywKICAnJicsICd8JywgJzw8JywgJz4+JwpdOwoKLy8gV3JhcHMgYSB2YWx1ZSAoY29sdW1uLCB0YWJsZU5hbWUpIHdpdGggdGhlIGNvcnJlY3QgdGlja3MuCkZvcm1hdHRlcl9TUUxpdGUzLnByb3RvdHlwZS53cmFwVmFsdWUgPSBmdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiAodmFsdWUgIT09ICcqJyA/ICciJyArIHZhbHVlICsgJyInIDogJyonKTsKfTsKCi8vIE1lbW9pemUgdGhlIGNhbGxzIHRvICJ3cmFwIiBmb3IgYSBsaXR0bGUgZXh0cmEgcGVyZi4KdmFyIHdyYXBwZXJNZW1vID0gKGZ1bmN0aW9uKCl7CiAgdmFyIG1lbW8gPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHJldHVybiBmdW5jdGlvbihrZXkpIHsKICAgIGlmIChtZW1vW2tleV0gPT09IHZvaWQgMCkgewogICAgICBtZW1vW2tleV0gPSB0aGlzLl93cmFwU3RyaW5nKGtleSk7CiAgICB9CiAgICByZXR1cm4gbWVtb1trZXldOwogIH07Cn0oKSk7CgpGb3JtYXR0ZXJfU1FMaXRlMy5wcm90b3R5cGUuX3dyYXAgPSB3cmFwcGVyTWVtbzsKCi8vIEFzc2lnbiB0aGUgZm9ybWF0dGVyIHRvIHRoZSB0aGUgY2xpZW50LgpjbGllbnQuRm9ybWF0dGVyID0gRm9ybWF0dGVyX1NRTGl0ZTM7Cgp9Owp9LHsiLi4vLi4vZm9ybWF0dGVyIjo5NywiaW5oZXJpdHMiOjc2fV0sODE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIEZ1bmN0aW9uSGVscGVyID0gcmVxdWlyZSgnLi4vLi4vZnVuY3Rpb25oZWxwZXInKTsKCnZhciBGdW5jdGlvbkhlbHBlcl9TUUxpdGUzID0gT2JqZWN0LmNyZWF0ZShGdW5jdGlvbkhlbHBlcik7CkZ1bmN0aW9uSGVscGVyX1NRTGl0ZTMuY2xpZW50ID0gY2xpZW50OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgRnVuY3Rpb25IZWxwZXJgIGNvbnN0cnVjdG9yIHRvIHRoZSBjbGllbnQgb2JqZWN0LgpjbGllbnQuRnVuY3Rpb25IZWxwZXIgPSBGdW5jdGlvbkhlbHBlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL2Z1bmN0aW9uaGVscGVyIjo5OH1dLDgyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMwovLyAtLS0tLS0tCgp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwoKdmFyIENsaWVudCAgPSByZXF1aXJlKCcuLi8uLi9jbGllbnQnKTsKdmFyIFByb21pc2UgPSByZXF1aXJlKCcuLi8uLi9wcm9taXNlJyk7CgpmdW5jdGlvbiBDbGllbnRfU1FMaXRlMyhjb25maWcpIHsKICBDbGllbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoY29uZmlnLmRlYnVnKSB0aGlzLmlzRGVidWdnaW5nID0gdHJ1ZTsKICBpZiAoY29uZmlnLmNvbm5lY3Rpb24pIHsKICAgIHRoaXMuaW5pdERyaXZlcigpOwogICAgdGhpcy5pbml0UnVubmVyKCk7CiAgICB0aGlzLmNvbm5lY3Rpb25TZXR0aW5ncyA9IGNvbmZpZy5jb25uZWN0aW9uOwogICAgdGhpcy5pbml0UG9vbCgpOwogICAgdGhpcy5wb29sID0gbmV3IHRoaXMuUG9vbChjb25maWcucG9vbCk7CiAgfQogIC8vIFRvZG86IFBsdWdpbnMgaGVyZSBwb3NzaWJseT8/Cn0KaW5oZXJpdHMoQ2xpZW50X1NRTGl0ZTMsIENsaWVudCk7CgovLyBMYXp5IGxvYWQgdGhlIHNxbGl0ZTMgbW9kdWxlLCBzaW5jZSB3ZSBtaWdodCBqdXN0IGJlIHVzaW5nCi8vIHRoZSBjbGllbnQgdG8gZ2VuZXJhdGUgU1FMIHN0cmluZ3MuCnZhciBzcWxpdGUzOwoKQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmRpYWxlY3QgPSAnc3FsaXRlMyc7CgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi90cmFuc2FjdGlvbicpKHRoaXMpOwp9OwoKQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRGb3JtYXR0ZXIgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL2Zvcm1hdHRlcicpKHRoaXMpOwp9OwoKLy8gTGF6eS1sb2FkIHRoZSBzcWxpdGUzIGRlcGVuZGVuY3kuCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0RHJpdmVyID0gZnVuY3Rpb24oKSB7CiAgc3FsaXRlMyA9IHNxbGl0ZTMgfHwgcmVxdWlyZSgnc3FsaXRlMycpOwp9OwoKLy8gSW5pdGlhbGl6ZSB0aGUgcmF3IGNvbm5lY3Rpb24gb24gdGhlIGNsaWVudC4KQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRSYXcgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3JhdycpKHRoaXMpOwp9OwoKLy8gQXR0YWNoZXMgdGhlIGBGdW5jdGlvbkhlbHBlcmAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0RnVuY3Rpb25IZWxwZXIgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL2Z1bmN0aW9uaGVscGVyJykodGhpcyk7Cn07CgovLyBBbHdheXMgaW5pdGlhbGl6ZSB3aXRoIHRoZSAiUXVlcnkiIGFuZCAiUXVlcnlDb21waWxlciIKLy8gb2JqZWN0cywgZWFjaCBvZiB3aGljaCBpcyB1bmlxdWUgdG8gdGhpcyBjbGllbnQgKGFuZCB0aHVzKQovLyBjYW4gYmUgYWx0ZXJlZCB3aXRob3V0IG1lc3NpbmcgdXAgYW55dGhpbmcgZm9yIGFueW9uZSBlbHNlLgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFF1ZXJ5ID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi9xdWVyeScpKHRoaXMpOwp9OwoKLy8gSW5pdGlhbGl6ZXMgYSBuZXcgcG9vbCBpbnN0YW5jZSBmb3IgdGhlIGN1cnJlbnQgY2xpZW50LgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFBvb2wgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3Bvb2wnKSh0aGlzKTsKfTsKCi8vIEluaXRpYWxpemUgdGhlIHF1ZXJ5ICJydW5uZXIiCkNsaWVudF9TUUxpdGUzLnByb3RvdHlwZS5pbml0UnVubmVyID0gZnVuY3Rpb24oKSB7CiAgcmVxdWlyZSgnLi9ydW5uZXInKSh0aGlzKTsKfTsKCi8vIExhenktbG9hZCB0aGUgc2NoZW1hIGRlcGVuZGVuY2llcy4KQ2xpZW50X1NRTGl0ZTMucHJvdG90eXBlLmluaXRTY2hlbWEgPSBmdW5jdGlvbigpIHsKICByZXF1aXJlKCcuL3NjaGVtYScpKHRoaXMpOwp9OwoKLy8gTGF6eS1sb2FkIHRoZSBtaWdyYXRpb24gZGVwZW5kZW5jeQpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdE1pZ3JhdG9yID0gZnVuY3Rpb24oKSB7CiAgICByZXF1aXJlKCcuL21pZ3JhdG9yJykodGhpcyk7Cn07CgovLyBMYXp5LWxvYWQgdGhlIHNlZWRpbmcgZGVwZW5kZW5jeQpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuaW5pdFNlZWRlciA9IGZ1bmN0aW9uKCkgewogICAgcmVxdWlyZSgnLi9zZWVkZXInKSh0aGlzKTsKfTsKCi8vIEdldCBhIHJhdyBjb25uZWN0aW9uIGZyb20gdGhlIGRhdGFiYXNlLCByZXR1cm5pbmcgYSBwcm9taXNlIHdpdGggdGhlIGNvbm5lY3Rpb24gb2JqZWN0LgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuYWNxdWlyZVJhd0Nvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHsKICB2YXIgZHJpdmVyID0gdGhpczsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICB2YXIgZGIgPSBuZXcgc3FsaXRlMy5EYXRhYmFzZShkcml2ZXIuY29ubmVjdGlvblNldHRpbmdzLmZpbGVuYW1lLCBmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpOwogICAgICByZXNvbHZlKGRiKTsKICAgIH0pOwogIH0pOwp9OwoKLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2wKLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLgpDbGllbnRfU1FMaXRlMy5wcm90b3R5cGUuZGVzdHJveVJhd0Nvbm5lY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgY29ubmVjdGlvbi5jbG9zZSgpOwp9KTsKCm1vZHVsZS5leHBvcnRzID0gQ2xpZW50X1NRTGl0ZTM7Cn0seyIuLi8uLi9jbGllbnQiOjc4LCIuLi8uLi9wcm9taXNlIjoxMDMsIi4vZm9ybWF0dGVyIjo4MCwiLi9mdW5jdGlvbmhlbHBlciI6ODEsIi4vbWlncmF0b3IiOjgzLCIuL3Bvb2wiOjg0LCIuL3F1ZXJ5Ijo4NSwiLi9yYXciOjg2LCIuL3J1bm5lciI6ODcsIi4vc2NoZW1hIjo5MCwiLi9zZWVkZXIiOjkzLCIuL3RyYW5zYWN0aW9uIjo5NCwiaW5oZXJpdHMiOjc2LCJzcWxpdGUzIjo1Mn1dLDgzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBNaWdyYXRvciA9IHJlcXVpcmUoJy4uLy4uL21pZ3JhdGUnKTsKdmFyIGluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKCi8vIEluaGVyaXQgZnJvbSB0aGUgYE1pZ3JhdG9yYCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBNaWdyYXRvcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIE1pZ3JhdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoTWlncmF0b3JfU1FMaXRlMywgTWlncmF0b3IpOwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgTWlncmF0b3JgIGNvbnN0cnVjdG9yIHRvIHRoZSBjbGllbnQgb2JqZWN0LgpjbGllbnQuTWlncmF0b3IgPSBNaWdyYXRvcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL21pZ3JhdGUiOjEwMSwiaW5oZXJpdHMiOjc2fV0sODQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7Cgptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFBvb2wgICAgID0gcmVxdWlyZSgnLi4vLi4vcG9vbCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKCi8vIEluaGVyaXQgZnJvbSB0aGUgYFBvb2xgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLgpmdW5jdGlvbiBQb29sX1NRTGl0ZTMoKSB7CiAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgUG9vbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFBvb2xfU1FMaXRlMywgUG9vbCk7CgpQb29sX1NRTGl0ZTMucHJvdG90eXBlLmRlZmF1bHRzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIF8uZXh0ZW5kKFBvb2wucHJvdG90eXBlLmRlZmF1bHRzLmNhbGwodGhpcyksIHsKICAgIG1heDogMSwKICAgIG1pbjogMSwKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKGNsaWVudCkgeyBjbGllbnQuY2xvc2UoKTsgfQogIH0pOwp9OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgUG9vbGAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5Qb29sID0gUG9vbF9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL3Bvb2wiOjEwMiwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDg1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMyBRdWVyeSBCdWlsZGVyICYgQ29tcGlsZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Cgp2YXIgUXVlcnlCdWlsZGVyICA9IHJlcXVpcmUoJy4uLy4uL3F1ZXJ5L2J1aWxkZXInKTsKdmFyIFF1ZXJ5Q29tcGlsZXIgPSByZXF1aXJlKCcuLi8uLi9xdWVyeS9jb21waWxlcicpOwoKLy8gUXVlcnkgQnVpbGRlcgovLyAtLS0tLS0tCmZ1bmN0aW9uIFF1ZXJ5QnVpbGRlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFF1ZXJ5QnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFF1ZXJ5QnVpbGRlcl9TUUxpdGUzLCBRdWVyeUJ1aWxkZXIpOwoKLy8gUXVlcnkgQ29tcGlsZXIKLy8gLS0tLS0tLQpmdW5jdGlvbiBRdWVyeUNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5mb3JtYXR0ZXIgPSBuZXcgY2xpZW50LkZvcm1hdHRlcigpOwogIFF1ZXJ5Q29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhRdWVyeUNvbXBpbGVyX1NRTGl0ZTMsIFF1ZXJ5Q29tcGlsZXIpOwoKLy8gVGhlIGxvY2tzIGFyZSBub3QgYXBwbGljYWJsZSBpbiBTUUxpdGUzClF1ZXJ5Q29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZm9yU2hhcmUgPQpRdWVyeUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmZvclVwZGF0ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAnJzsKfTsKCi8vIFNRTGl0ZSByZXF1aXJlcyB1cyB0byBidWlsZCB0aGUgbXVsdGktcm93IGluc2VydCBhcyBhIGxpc3Rpbmcgb2Ygc2VsZWN0IHdpdGgKLy8gdW5pb25zIGpvaW5pbmcgdGhlbSB0b2dldGhlci4gU28gd2UnbGwgYnVpbGQgb3V0IHRoaXMgbGlzdCBvZiBjb2x1bW5zIGFuZAovLyB0aGVuIGpvaW4gdGhlbSBhbGwgdG9nZXRoZXIgd2l0aCBzZWxlY3QgdW5pb25zIHRvIGNvbXBsZXRlIHRoZSBxdWVyaWVzLgpRdWVyeUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmluc2VydCA9IGZ1bmN0aW9uKCkgewogIHZhciBpbnNlcnQgPSB0aGlzLnNpbmdsZS5pbnNlcnQ7CiAgdmFyIHNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7CgogIGlmIChfLmlzQXJyYXkoaW5zZXJ0KSAmJiAoaW5zZXJ0Lmxlbmd0aCA9PT0gMSkgJiYgXy5pc0VtcHR5KGluc2VydFswXSkpIHsKICAgIGluc2VydCA9IFtdOwogIH0KCiAgaWYgKF8uaXNFbXB0eShpbnNlcnQpICYmICFfLmlzRnVuY3Rpb24oaW5zZXJ0KSkgewogICAgcmV0dXJuIHNxbCArICdkZWZhdWx0IHZhbHVlcyc7CiAgfQogIHZhciBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnQpOwogIGlmIChfLmlzU3RyaW5nKGluc2VydERhdGEpKSByZXR1cm4gc3FsICsgaW5zZXJ0RGF0YTsKICBzcWwgKz0gJygnICsgdGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKGluc2VydERhdGEuY29sdW1ucykgKyAnKSc7CiAgaWYgKGluc2VydERhdGEudmFsdWVzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIHNxbCArICcgdmFsdWVzICgnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKGluc2VydERhdGEudmFsdWVzWzBdKSArICcpJzsKICB9CiAgdmFyIGJsb2NrcyA9IFtdOwogIGZvciAodmFyIGkgPSAwLCBsID0gaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgYmxvY2sgPSBibG9ja3NbaV0gPSBbXTsKICAgIHZhciBjdXJyZW50ID0gaW5zZXJ0RGF0YS52YWx1ZXNbaV07CiAgICBmb3IgKHZhciBpMiA9IDAsIGwyID0gaW5zZXJ0RGF0YS5jb2x1bW5zLmxlbmd0aDsgaTIgPCBsMjsgaTIrKykgewogICAgICBibG9jay5wdXNoKHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihjdXJyZW50W2kyXSkgKyAnIGFzICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGluc2VydERhdGEuY29sdW1uc1tpMl0pKTsKICAgIH0KICAgIGJsb2Nrc1tpXSA9IGJsb2NrLmpvaW4oJywgJyk7CiAgfQogIHJldHVybiBzcWwgKyAnIHNlbGVjdCAnICsgYmxvY2tzLmpvaW4oJyB1bmlvbiBhbGwgc2VsZWN0ICcpOwp9OwoKLy8gQ29tcGlsZSBhIHRydW5jYXRlIHRhYmxlIHN0YXRlbWVudCBpbnRvIFNRTC4KUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHZhciB0YWJsZSA9IHRoaXMudGFibGVOYW1lOwogIHJldHVybiB7CiAgICBzcWw6ICdkZWxldGUgZnJvbSBzcWxpdGVfc2VxdWVuY2Ugd2hlcmUgbmFtZSA9ICcgKyB0aGlzLnRhYmxlTmFtZSwKICAgIG91dHB1dDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHtzcWw6ICdkZWxldGUgZnJvbSAnICsgdGFibGV9KTsKICAgIH0KICB9Owp9OwoKLy8gQ29tcGlsZXMgYSBgY29sdW1uSW5mb2AgcXVlcnkKUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5jb2x1bW5JbmZvID0gZnVuY3Rpb24oKSB7CiAgdmFyIGNvbHVtbiA9IHRoaXMuc2luZ2xlLmNvbHVtbkluZm87CiAgcmV0dXJuIHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLnNpbmdsZS50YWJsZSArJyknLAogICAgb3V0cHV0OiBmdW5jdGlvbihyZXNwKSB7CiAgICAgIHZhciBtYXhMZW5ndGhSZWdleCA9IC8uKlwoKFxkKylcKS87CiAgICAgIHZhciBvdXQgPSBfLnJlZHVjZShyZXNwLCBmdW5jdGlvbiAoY29sdW1ucywgdmFsKSB7CiAgICAgICAgdmFyIHR5cGUgPSB2YWwudHlwZTsKICAgICAgICB2YXIgbWF4TGVuZ3RoID0gKG1heExlbmd0aCA9IHR5cGUubWF0Y2gobWF4TGVuZ3RoUmVnZXgpKSAmJiBtYXhMZW5ndGhbMV07CiAgICAgICAgdHlwZSA9IG1heExlbmd0aCA/IHR5cGUuc3BsaXQoJygnKVswXSA6IHR5cGU7CiAgICAgICAgY29sdW1uc1t2YWwubmFtZV0gPSB7CiAgICAgICAgICB0eXBlOiB0eXBlLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICBtYXhMZW5ndGg6IG1heExlbmd0aCwKICAgICAgICAgIG51bGxhYmxlOiAhdmFsLm5vdG51bGwsCiAgICAgICAgICBkZWZhdWx0VmFsdWU6IHZhbC5kZmx0X3ZhbHVlCiAgICAgICAgfTsKICAgICAgICByZXR1cm4gY29sdW1uczsKICAgICAgfSwge30pOwogICAgICByZXR1cm4gY29sdW1uICYmIG91dFtjb2x1bW5dIHx8IG91dDsKICAgIH0KICB9Owp9OwoKUXVlcnlDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5saW1pdCA9IGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5zaW5nbGUubGltaXQgJiYgIXRoaXMuc2luZ2xlLm9mZnNldCkgcmV0dXJuICcnOwoKICAvLyBXb3JrYXJvdW5kIGZvciBvZmZzZXQgb25seSwgc2VlIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTA0OTE0OTIvc3FsbGl0ZS13aXRoLXNraXAtb2Zmc2V0LW9ubHktbm90LWxpbWl0CiAgcmV0dXJuICdsaW1pdCAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKCh0aGlzLnNpbmdsZS5vZmZzZXQgJiYgIXRoaXMuc2luZ2xlLmxpbWl0KSA/IC0xIDogdGhpcy5zaW5nbGUubGltaXQpOwp9OwoKY2xpZW50LlF1ZXJ5QnVpbGRlciA9IFF1ZXJ5QnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuUXVlcnlDb21waWxlciA9IFF1ZXJ5Q29tcGlsZXJfU1FMaXRlMzsKCn07Cgp9LHsiLi4vLi4vcXVlcnkvYnVpbGRlciI6MTA0LCIuLi8uLi9xdWVyeS9jb21waWxlciI6MTA1LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sODY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSYXcKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFJhdyA9IHJlcXVpcmUoJy4uLy4uL3JhdycpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwoKLy8gSW5oZXJpdCBmcm9tIHRoZSBgUmF3YCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBSYXdfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBSYXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhSYXdfU1FMaXRlMywgUmF3KTsKCi8vIEFzc2lnbiB0aGUgbmV3bHkgZXh0ZW5kZWQgYFJhd2AgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5SYXcgPSBSYXdfU1FMaXRlMzsKCn07Cn0seyIuLi8uLi9yYXciOjEwOCwiaW5oZXJpdHMiOjc2fV0sODc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSdW5uZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTsKdmFyIFJ1bm5lciAgID0gcmVxdWlyZSgnLi4vLi4vcnVubmVyJyk7CnZhciBoZWxwZXJzICA9IHJlcXVpcmUoJy4uLy4uL2hlbHBlcnMnKTsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CgovLyBJbmhlcml0IGZyb20gdGhlIGBSdW5uZXJgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLAovLyBzbyB3ZSBjYW4gYWRkIHRoZSBjb3JyZWN0IGB0aGVuYCBtZXRob2QuCmZ1bmN0aW9uIFJ1bm5lcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFJ1bm5lci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFJ1bm5lcl9TUUxpdGUzLCBSdW5uZXIpOwoKUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLl9iZWdpblRyYW5zYWN0aW9uID0gJ2JlZ2luIHRyYW5zYWN0aW9uOyc7CgovLyBSdW5zIHRoZSBxdWVyeSBvbiB0aGUgc3BlY2lmaWVkIGNvbm5lY3Rpb24sIHByb3ZpZGluZyB0aGUgYmluZGluZ3MgYW5kIGFueSBvdGhlciBuZWNlc3NhcnkgcHJlcCB3b3JrLgpSdW5uZXJfU1FMaXRlMy5wcm90b3R5cGUuX3F1ZXJ5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ob2JqKSB7CiAgdmFyIG1ldGhvZCA9IG9iai5tZXRob2Q7CiAgaWYgKHRoaXMuaXNEZWJ1Z2dpbmcoKSkgdGhpcy5kZWJ1ZyhvYmopOwogIHZhciBjYWxsTWV0aG9kOwogIHN3aXRjaCAobWV0aG9kKSB7CiAgICBjYXNlICdpbnNlcnQnOgogICAgY2FzZSAndXBkYXRlJzoKICAgIGNhc2UgJ2NvdW50ZXInOgogICAgY2FzZSAnZGVsJzoKICAgICAgY2FsbE1ldGhvZCA9ICdydW4nOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIGNhbGxNZXRob2QgPSAnYWxsJzsKICB9CiAgdmFyIGNvbm5lY3Rpb24gPSB0aGlzLmNvbm5lY3Rpb247CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmVyLCByZWplY3RlcikgewogICAgaWYgKCFjb25uZWN0aW9uIHx8ICFjb25uZWN0aW9uW2NhbGxNZXRob2RdKSB7CiAgICAgIHJldHVybiByZWplY3RlcihuZXcgRXJyb3IoJ0Vycm9yIGNhbGxpbmcgJyArIGNhbGxNZXRob2QgKyAnIG9uIGNvbm5lY3Rpb24uJykpOwogICAgfQogICAgY29ubmVjdGlvbltjYWxsTWV0aG9kXShvYmouc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uKGVyciwgcmVzcG9uc2UpIHsKICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdGVyKGVycik7CiAgICAgIG9iai5yZXNwb25zZSA9IHJlc3BvbnNlOwoKICAgICAgLy8gV2UgbmVlZCB0aGUgY29udGV4dCBoZXJlLCBhcyBpdCBjb250YWlucwogICAgICAvLyB0aGUgInRoaXMubGFzdElEIiBvciAidGhpcy5jaGFuZ2VzIgogICAgICBvYmouY29udGV4dCAgPSB0aGlzOwogICAgICByZXR1cm4gcmVzb2x2ZXIob2JqKTsKICAgIH0pOwogIH0pOwp9KTsKCi8vIFNvdW5kcyBsaWtlIC5lYWNoIGRvZXNuJ3Qgd29yayBncmVhdCBmb3IKUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLl9zdHJlYW0gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihzcWwsIHN0cmVhbSwgb3B0aW9ucykgewogIC8qanNoaW50IHVudXNlZDogZmFsc2UqLwogIHZhciBydW5uZXIgPSB0aGlzOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3Rlcik7CiAgICBzdHJlYW0ub24oJ2VuZCcsIHJlc29sdmVyKTsKICAgIHJldHVybiBydW5uZXIucXVlcnkoc3FsKS5tYXAoZnVuY3Rpb24ocm93KSB7CiAgICAgIHN0cmVhbS53cml0ZShyb3cpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7CiAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBzdHJlYW0uZW5kKCk7CiAgICB9KTsKICB9KTsKfSk7CgovLyBFbnN1cmVzIHRoZSByZXNwb25zZSBpcyByZXR1cm5lZCBpbiB0aGUgc2FtZSBmb3JtYXQgYXMgb3RoZXIgY2xpZW50cy4KUnVubmVyX1NRTGl0ZTMucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaikgewogIHZhciBjdHggICAgICA9IG9iai5jb250ZXh0OwogIHZhciByZXNwb25zZSA9IG9iai5yZXNwb25zZTsKICBpZiAob2JqLm91dHB1dCkgcmV0dXJuIG9iai5vdXRwdXQuY2FsbCh0aGlzLCByZXNwb25zZSk7CiAgc3dpdGNoIChvYmoubWV0aG9kKSB7CiAgICBjYXNlICdzZWxlY3QnOgogICAgY2FzZSAncGx1Y2snOgogICAgY2FzZSAnZmlyc3QnOgogICAgICByZXNwb25zZSA9IGhlbHBlcnMuc2tpbShyZXNwb25zZSk7CiAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXNwb25zZSA9IF8ucGx1Y2socmVzcG9uc2UsIG9iai5wbHVjayk7CiAgICAgIHJldHVybiBvYmoubWV0aG9kID09PSAnZmlyc3QnID8gcmVzcG9uc2VbMF0gOiByZXNwb25zZTsKICAgIGNhc2UgJ2luc2VydCc6CiAgICAgIHJldHVybiBbY3R4Lmxhc3RJRF07CiAgICBjYXNlICdkZWwnOgogICAgY2FzZSAndXBkYXRlJzoKICAgIGNhc2UgJ2NvdW50ZXInOgogICAgICByZXR1cm4gY3R4LmNoYW5nZXM7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gcmVzcG9uc2U7CiAgfQp9OwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgUnVubmVyYCBjb25zdHJ1Y3RvciB0byB0aGUgY2xpZW50IG9iamVjdC4KY2xpZW50LlJ1bm5lciA9IFJ1bm5lcl9TUUxpdGUzOwoKfTsKCn0seyIuLi8uLi9oZWxwZXJzIjo5OSwiLi4vLi4vcHJvbWlzZSI6MTAzLCIuLi8uLi9ydW5uZXIiOjEwOSwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDg4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gU1FMaXRlMzogQ29sdW1uIEJ1aWxkZXIgJiBDb21waWxlcgovLyAtLS0tLS0tCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY2xpZW50KSB7Cgp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgU2NoZW1hICAgPSByZXF1aXJlKCcuLi8uLi8uLi9zY2hlbWEnKTsKCi8vIENvbHVtbiBCdWlsZGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIENvbHVtbkJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuQ29sdW1uQnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKENvbHVtbkJ1aWxkZXJfU1FMaXRlMywgU2NoZW1hLkNvbHVtbkJ1aWxkZXIpOwoKLy8gQ29sdW1uIENvbXBpbGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIENvbHVtbkNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5tb2RpZmllcnMgPSBbJ251bGxhYmxlJywgJ2RlZmF1bHRUbyddOwogIHRoaXMuRm9ybWF0dGVyID0gY2xpZW50LkZvcm1hdHRlcjsKICBTY2hlbWEuQ29sdW1uQ29tcGlsZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfQppbmhlcml0cyhDb2x1bW5Db21waWxlcl9TUUxpdGUzLCBTY2hlbWEuQ29sdW1uQ29tcGlsZXIpOwoKLy8gVHlwZXMKLy8gLS0tLS0tLQoKQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZG91YmxlID0KQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZGVjaW1hbCA9CkNvbHVtbkNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmZsb2F0aW5nID0gJ2Zsb2F0JzsKQ29sdW1uQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUudGltZXN0YW1wID0gJ2RhdGV0aW1lJzsKCmNsaWVudC5Db2x1bW5CdWlsZGVyID0gQ29sdW1uQnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuQ29sdW1uQ29tcGlsZXIgPSBDb2x1bW5Db21waWxlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uLy4uL3NjaGVtYSI6MTE0LCJpbmhlcml0cyI6NzZ9XSw4OTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFNRTGl0ZTNfRERMCi8vCi8vIEFsbCBvZiB0aGUgU1FMaXRlMyBzcGVjaWZpYyBEREwgaGVscGVycyBmb3IgcmVuYW1pbmcvZHJvcHBpbmcKLy8gY29sdW1ucyBhbmQgY2hhbmdpbmcgZGF0YXR5cGVzLgovLyAtLS0tLS0tCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY2xpZW50KSB7Cgp2YXIgXyAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uLy4uL3Byb21pc2UnKTsKCi8vIFNvIGFsdGVyaW5nIHRoZSBzY2hlbWEgaW4gU1FMaXRlMyBpcyBhIG1ham9yIHBhaW4uCi8vIFdlIGhhdmUgb3VyIG93biBvYmplY3QgdG8gZGVhbCB3aXRoIHRoZSByZW5hbWluZyBhbmQgYWx0ZXJpbmcgdGhlIHR5cGVzCi8vIGZvciBzcWxpdGUzIHRoaW5ncy4KZnVuY3Rpb24gU1FMaXRlM19EREwocnVubmVyLCB0YWJsZUNvbXBpbGVyLCBwcmFnbWEpIHsKICB0aGlzLnRhYmxlQ29tcGlsZXIgPSB0YWJsZUNvbXBpbGVyOwogIHRoaXMucHJhZ21hID0gcHJhZ21hOwogIHRoaXMucnVubmVyID0gcnVubmVyOwogIHRoaXMuZm9ybWF0dGVyID0gbmV3IGNsaWVudC5Gb3JtYXR0ZXIoKTsKICB0aGlzLnRhYmxlTmFtZSA9IHRoaXMudGFibGVDb21waWxlci50YWJsZU5hbWVSYXc7CiAgdGhpcy5hbHRlcmVkTmFtZSA9ICdfa25leF90ZW1wX2FsdGVyJyArIF8udW5pcXVlSWQoKTsKfQoKU1FMaXRlM19EREwucHJvdG90eXBlLmdldENvbHVtbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbHVtbikgewogIHZhciBjdXJyZW50Q29sID0gXy5maW5kV2hlcmUodGhpcy5wcmFnbWEsIHtuYW1lOiBjb2x1bW59KTsKICBpZiAoIWN1cnJlbnRDb2wpIHRocm93IG5ldyBFcnJvcignVGhlIGNvbHVtbiAnICsgY29sdW1uICsgJyBpcyBub3QgaW4gdGhlICcgKyB0aGlzLnRhYmxlTmFtZSArICcgdGFibGUnKTsKICByZXR1cm4gY3VycmVudENvbDsKfSk7CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZW5zdXJlVHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5ydW5uZXIuYmVnaW5UcmFuc2FjdGlvbigpOwogIH0KfSk7CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuY29tbWl0VHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5ydW5uZXIuY29tbWl0VHJhbnNhY3Rpb24oKTsKICB9Cn0pOwoKU1FMaXRlM19EREwucHJvdG90eXBlLnJvbGxiYWNrVHJhbnNhY3Rpb24gPSBmdW5jdGlvbihlKSB7CiAgaWYgKHRoaXMucnVubmVyLnRyYW5zYWN0aW9uKSB0aHJvdyBlOwogIHJldHVybiB0aGlzLnJ1bm5lci5yb2xsYmFja1RyYW5zYWN0aW9uKCkudGhyb3coZSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZ2V0VGFibGVTcWwgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogJ1NFTEVDVCBuYW1lLCBzcWwgRlJPTSBzcWxpdGVfbWFzdGVyIFdIRVJFIHR5cGU9InRhYmxlIiBBTkQgbmFtZT0iJyArIHRoaXMudGFibGVOYW1lICsgJyInfSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUucmVuYW1lVGFibGUgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogJ0FMVEVSIFRBQkxFICInICsgdGhpcy50YWJsZU5hbWUgKyAnIiBSRU5BTUUgVE8gIicgKyB0aGlzLmFsdGVyZWROYW1lICsgJyInfSk7Cn0pOwoKU1FMaXRlM19EREwucHJvdG90eXBlLmRyb3BPcmlnaW5hbCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnRFJPUCBUQUJMRSAiJyArIHRoaXMudGFibGVOYW1lICsgJyInfSk7Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuZHJvcFRlbXBUYWJsZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnRFJPUCBUQUJMRSAiJyArIHRoaXMuYWx0ZXJlZE5hbWUgKyAnIid9KTsKfTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5jb3B5RGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnU0VMRUNUICogRlJPTSAiJyArIHRoaXMudGFibGVOYW1lICsgJyInfSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmluc2VydENodW5rZWQoMjAsIHRoaXMuYWx0ZXJlZE5hbWUpKTsKfTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5yZWluc2VydERhdGEgPSBmdW5jdGlvbihpdGVyYXRvcikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiAnU0VMRUNUICogRlJPTSAiJyArIHRoaXMuYWx0ZXJlZE5hbWUgKyAnIid9KQogICAgICAuYmluZCh0aGlzKQogICAgICAudGhlbih0aGlzLmluc2VydENodW5rZWQoMjAsIHRoaXMudGFibGVOYW1lLCBpdGVyYXRvcikpOwogIH07Cn07CgpTUUxpdGUzX0RETC5wcm90b3R5cGUuaW5zZXJ0Q2h1bmtlZCA9IGZ1bmN0aW9uKGFtb3VudCwgdGFyZ2V0LCBpdGVyYXRvcikgewogIGl0ZXJhdG9yID0gaXRlcmF0b3IgfHwgZnVuY3Rpb24obm9vcCkgeyByZXR1cm4gbm9vcDsgfTsKICByZXR1cm4gZnVuY3Rpb24ocmVzdWx0KSB7CiAgICB2YXIgYmF0Y2ggPSBbXTsKICAgIHZhciBkZGwgPSB0aGlzOwogICAgcmV0dXJuIFByb21pc2UucmVkdWNlKHJlc3VsdCwgZnVuY3Rpb24obWVtbywgcm93KSB7CiAgICAgIG1lbW8rKzsKICAgICAgYmF0Y2gucHVzaChyb3cpOwogICAgICBpZiAobWVtbyAlIDIwID09PSAwIHx8IG1lbW8gPT09IHJlc3VsdC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gbmV3IGNsaWVudC5RdWVyeUJ1aWxkZXIoKQogICAgICAgICAgLmNvbm5lY3Rpb24oZGRsLnJ1bm5lci5jb25uZWN0aW9uKQogICAgICAgICAgLnRhYmxlKHRhcmdldCkKICAgICAgICAgIC5pbnNlcnQoXy5tYXAoYmF0Y2gsIGl0ZXJhdG9yKSkKICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKCkgeyBiYXRjaCA9IFtdOyB9KQogICAgICAgICAgLnRoZW5SZXR1cm4obWVtbyk7CiAgICAgIH0KICAgICAgcmV0dXJuIG1lbW87CiAgICB9LCAwKTsKICB9Owp9OwoKU1FMaXRlM19EREwucHJvdG90eXBlLmNyZWF0ZVRlbXBUYWJsZSA9IGZ1bmN0aW9uKGNyZWF0ZVRhYmxlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMucnVubmVyLnF1ZXJ5KHtzcWw6IGNyZWF0ZVRhYmxlLnNxbC5yZXBsYWNlKHRoaXMudGFibGVOYW1lLCB0aGlzLmFsdGVyZWROYW1lKX0pOwogIH07Cn07CgovLyBCb3ksIHRoaXMgaXMgcXVpdGUgYSBtZXRob2QuClNRTGl0ZTNfRERMLnByb3RvdHlwZS5yZW5hbWVDb2x1bW4gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihmcm9tLCB0bykgewogIHZhciBjdXJyZW50Q29sOwogIHJldHVybiB0aGlzLmVuc3VyZVRyYW5zYWN0aW9uKCkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29sdW1uKGZyb20pOwogICAgfSkKICAgIC50YXAoZnVuY3Rpb24oY29sKSB7IGN1cnJlbnRDb2wgPSBjb2w7IH0pCiAgICAudGhlbih0aGlzLmdldFRhYmxlU3FsKQogICAgLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHZhciBjcmVhdGVUYWJsZSA9IHNxbFswXTsKICAgICAgdmFyIGEgPSB0aGlzLmZvcm1hdHRlci53cmFwKGZyb20pICsgJyAnICsgY3VycmVudENvbC50eXBlOwogICAgICB2YXIgYiA9IHRoaXMuZm9ybWF0dGVyLndyYXAodG8pICAgKyAnICcgKyBjdXJyZW50Q29sLnR5cGU7CiAgICAgIGlmIChjcmVhdGVUYWJsZS5zcWwuaW5kZXhPZihhKSA9PT0gLTEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBmaW5kIHRoZSBjb2x1bW4gdG8gY2hhbmdlJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2UuYmluZCh0aGlzKQogICAgICAudGhlbih0aGlzLmNyZWF0ZVRlbXBUYWJsZShjcmVhdGVUYWJsZSkpCiAgICAgIC50aGVuKHRoaXMuY29weURhdGEpCiAgICAgIC50aGVuKHRoaXMuZHJvcE9yaWdpbmFsKQogICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5ydW5uZXIucXVlcnkoe3NxbDogY3JlYXRlVGFibGUuc3FsLnJlcGxhY2UoYSwgYil9KTsKICAgICAgfSkKICAgICAgLnRoZW4odGhpcy5yZWluc2VydERhdGEoZnVuY3Rpb24ocm93KSB7CiAgICAgICAgcm93W3RvXSA9IHJvd1tmcm9tXTsKICAgICAgICByZXR1cm4gXy5vbWl0KHJvdywgZnJvbSk7CiAgICAgIH0pKQogICAgICAudGhlbih0aGlzLmRyb3BUZW1wVGFibGUpOwogICAgfSkKICAgIC50YXAodGhpcy5jb21taXRUcmFuc2FjdGlvbikKICAgIC5jYXRjaCh0aGlzLnJvbGxiYWNrVHJhbnNhY3Rpb24pOwp9KTsKClNRTGl0ZTNfRERMLnByb3RvdHlwZS5kcm9wQ29sdW1uID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29sdW1uKSB7CiAgIHZhciBjdXJyZW50Q29sOwogICByZXR1cm4gdGhpcy5lbnN1cmVUcmFuc2FjdGlvbigpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldENvbHVtbihjb2x1bW4pOwogICAgfSkKICAgIC50YXAoZnVuY3Rpb24oY29sKSB7IGN1cnJlbnRDb2wgPSBjb2w7IH0pCiAgICAudGhlbih0aGlzLmdldFRhYmxlU3FsKQogICAgLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHZhciBjcmVhdGVUYWJsZSA9IHNxbFswXTsKICAgICAgdmFyIGEgPSB0aGlzLmZvcm1hdHRlci53cmFwKGNvbHVtbikgKyAnICcgKyBjdXJyZW50Q29sLnR5cGUgKyAnLCAnOwogICAgICBpZiAoY3JlYXRlVGFibGUuc3FsLmluZGV4T2YoYSkgPT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmFibGUgdG8gZmluZCB0aGUgY29sdW1uIHRvIGNoYW5nZScpOwogICAgICB9CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbih0aGlzLmNyZWF0ZVRlbXBUYWJsZShjcmVhdGVUYWJsZSkpCiAgICAgICAgLnRoZW4odGhpcy5jb3B5RGF0YSkKICAgICAgICAudGhlbih0aGlzLmRyb3BPcmlnaW5hbCkKICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLnJ1bm5lci5xdWVyeSh7c3FsOiBjcmVhdGVUYWJsZS5zcWwucmVwbGFjZShhLCAnJyl9KTsKICAgICAgICB9KQogICAgICAgIC50aGVuKHRoaXMucmVpbnNlcnREYXRhKGZ1bmN0aW9uKHJvdykgewogICAgICAgICAgcmV0dXJuIF8ub21pdChyb3csIGNvbHVtbik7CiAgICAgICAgfSkpCiAgICAgICAgLnRoZW4odGhpcy5kcm9wVGVtcFRhYmxlKTsKICAgIH0pCiAgICAudGFwKHRoaXMuY29tbWl0VHJhbnNhY3Rpb24pCiAgICAuY2F0Y2godGhpcy5yb2xsYmFja1RyYW5zYWN0aW9uKTsKfSk7CgpjbGllbnQuU1FMaXRlM19EREwgPSBTUUxpdGUzX0RETDsKCn07Cgp9LHsiLi4vLi4vLi4vcHJvbWlzZSI6MTAzLCJsb2Rhc2giOjEzMH1dLDkwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKICByZXF1aXJlKCcuL2RkbCcpKGNsaWVudCk7CiAgcmVxdWlyZSgnLi9zY2hlbWEnKShjbGllbnQpOwogIHJlcXVpcmUoJy4vdGFibGUnKShjbGllbnQpOwogIHJlcXVpcmUoJy4vY29sdW1uJykoY2xpZW50KTsKfTsKfSx7Ii4vY29sdW1uIjo4OCwiLi9kZGwiOjg5LCIuL3NjaGVtYSI6OTEsIi4vdGFibGUiOjkyfV0sOTE6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBTUUxpdGUzOiBDb2x1bW4gQnVpbGRlciAmIENvbXBpbGVyCi8vIC0tLS0tLS0KbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgU2NoZW1hICAgPSByZXF1aXJlKCcuLi8uLi8uLi9zY2hlbWEnKTsKCi8vIFNjaGVtYSBCdWlsZGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIFNjaGVtYUJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuQnVpbGRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNjaGVtYUJ1aWxkZXJfU1FMaXRlMywgU2NoZW1hLkJ1aWxkZXIpOwoKLy8gU2NoZW1hIENvbXBpbGVyCi8vIC0tLS0tLS0KCmZ1bmN0aW9uIFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMoKSB7CiAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgdGhpcy5Gb3JtYXR0ZXIgPSBjbGllbnQuRm9ybWF0dGVyOwogIFNjaGVtYS5Db21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMsIFNjaGVtYS5Db21waWxlcik7CgovLyBDb21waWxlIHRoZSBxdWVyeSB0byBkZXRlcm1pbmUgaWYgYSB0YWJsZSBleGlzdHMuClNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmhhc1RhYmxlID0gZnVuY3Rpb24odGFibGVOYW1lKSB7CiAgdGhpcy5wdXNoUXVlcnkoewogICAgc3FsOiAic2VsZWN0ICogZnJvbSBzcWxpdGVfbWFzdGVyIHdoZXJlIHR5cGUgPSAndGFibGUnIGFuZCBuYW1lID0gIiArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0YWJsZU5hbWUpLAogICAgb3V0cHV0OiBmdW5jdGlvbihyZXNwKSB7CiAgICAgIHJldHVybiByZXNwLmxlbmd0aCA+IDA7CiAgICB9CiAgfSk7Cn07CgovLyBDb21waWxlIHRoZSBxdWVyeSB0byBkZXRlcm1pbmUgaWYgYSBjb2x1bW4gZXhpc3RzLgpTY2hlbWFDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5oYXNDb2x1bW4gPSBmdW5jdGlvbih0YWJsZU5hbWUsIGNvbHVtbikgewogIHRoaXMucHVzaFF1ZXJ5KHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRhYmxlTmFtZSkgKyAnKScsCiAgICBvdXRwdXQ6IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgcmV0dXJuIF8uc29tZShyZXNwLCB7bmFtZTogY29sdW1ufSk7CiAgICB9CiAgfSk7Cn07CgovLyBDb21waWxlIGEgcmVuYW1lIHRhYmxlIGNvbW1hbmQuClNjaGVtYUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLnJlbmFtZVRhYmxlID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoZnJvbSkgKyAnIHJlbmFtZSB0byAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcCh0bykpOwp9OwoKY2xpZW50LlNjaGVtYUJ1aWxkZXIgPSBTY2hlbWFCdWlsZGVyX1NRTGl0ZTM7CmNsaWVudC5TY2hlbWFDb21waWxlciA9IFNjaGVtYUNvbXBpbGVyX1NRTGl0ZTM7Cgp9Owp9LHsiLi4vLi4vLi4vc2NoZW1hIjoxMTQsImluaGVyaXRzIjo3NiwibG9kYXNoIjoxMzB9XSw5MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFNRTGl0ZTM6IENvbHVtbiBCdWlsZGVyICYgQ29tcGlsZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBTY2hlbWEgICA9IHJlcXVpcmUoJy4uLy4uLy4uL3NjaGVtYScpOwoKLy8gVGFibGUgQnVpbGRlcgovLyAtLS0tLS0tCgpmdW5jdGlvbiBUYWJsZUJ1aWxkZXJfU1FMaXRlMygpIHsKICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICBTY2hlbWEuVGFibGVCdWlsZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoVGFibGVCdWlsZGVyX1NRTGl0ZTMsIFNjaGVtYS5UYWJsZUJ1aWxkZXIpOwoKLy8gVGFibGUgQ29tcGlsZXIKLy8gLS0tLS0tLQoKZnVuY3Rpb24gVGFibGVDb21waWxlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIHRoaXMuRm9ybWF0dGVyID0gY2xpZW50LkZvcm1hdHRlcjsKICB0aGlzLlNRTGl0ZTNfRERMID0gY2xpZW50LlNRTGl0ZTNfRERMOwogIHRoaXMucHJpbWFyeUtleSA9IHZvaWQgMDsKICBTY2hlbWEuVGFibGVDb21waWxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFRhYmxlQ29tcGlsZXJfU1FMaXRlMywgU2NoZW1hLlRhYmxlQ29tcGlsZXIpOwoKLy8gQ3JlYXRlIGEgbmV3IHRhYmxlLgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmNyZWF0ZVF1ZXJ5ID0gZnVuY3Rpb24oY29sdW1ucywgaWZOb3QpIHsKICB2YXIgY3JlYXRlU3RhdGVtZW50ID0gaWZOb3QgPyAnY3JlYXRlIHRhYmxlIGlmIG5vdCBleGlzdHMgJyA6ICdjcmVhdGUgdGFibGUgJzsKICB2YXIgc3FsID0gY3JlYXRlU3RhdGVtZW50ICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zLnNxbC5qb2luKCcsICcpOwoKICAvLyBTUUxpdGUgZm9yY2VzIHByaW1hcnkga2V5cyB0byBiZSBhZGRlZCB3aGVuIHRoZSB0YWJsZSBpcyBpbml0aWFsbHkgY3JlYXRlZAogIC8vIHNvIHdlIHdpbGwgbmVlZCB0byBjaGVjayBmb3IgYSBwcmltYXJ5IGtleSBjb21tYW5kcyBhbmQgYWRkIHRoZSBjb2x1bW5zCiAgLy8gdG8gdGhlIHRhYmxlJ3MgZGVjbGFyYXRpb24gaGVyZSBzbyB0aGV5IGNhbiBiZSBjcmVhdGVkIG9uIHRoZSB0YWJsZXMuCiAgc3FsICs9IHRoaXMuZm9yZWlnbktleXMoKSB8fCAnJzsKICBzcWwgKz0gdGhpcy5wcmltYXJ5S2V5cygpIHx8ICcnOwogIHNxbCArPSAnKSc7CgogIHRoaXMucHVzaFF1ZXJ5KHNxbCk7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmFkZENvbHVtbnMgPSBmdW5jdGlvbihjb2x1bW5zKSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBjb2x1bW5zLnNxbC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHRoaXMucHVzaFF1ZXJ5KHsKICAgICAgc3FsOiAnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGFkZCBjb2x1bW4gJyArIGNvbHVtbnMuc3FsW2ldLAogICAgICBiaW5kaW5nczogY29sdW1ucy5iaW5kaW5nc1tpXQogICAgfSk7CiAgfQp9OwoKLy8gQ29tcGlsZSBhIGRyb3AgdW5pcXVlIGtleSBjb21tYW5kLgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmRyb3BVbmlxdWUgPSBmdW5jdGlvbihjb2x1bW5zLCBpbmRleE5hbWUpIHsKICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2Ryb3AgaW5kZXggJyArIGluZGV4TmFtZSk7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmRyb3BJbmRleCA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkgewogIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpOwogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIGluZGV4ICcgKyBpbmRleE5hbWUpOwp9OwoKLy8gQ29tcGlsZSBhIHVuaXF1ZSBrZXkgY29tbWFuZC4KVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS51bmlxdWUgPSBmdW5jdGlvbihjb2x1bW5zLCBpbmRleE5hbWUpIHsKICBpbmRleE5hbWUgPSBpbmRleE5hbWUgfHwgdGhpcy5faW5kZXhDb21tYW5kKCd1bmlxdWUnLCB0aGlzLnRhYmxlTmFtZVJhdywgY29sdW1ucyk7CiAgY29sdW1ucyA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShjb2x1bW5zKTsKICB0aGlzLnB1c2hRdWVyeSgnY3JlYXRlIHVuaXF1ZSBpbmRleCAnICsgaW5kZXhOYW1lICsgJyBvbiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zICsgJyknKTsKfTsKCi8vIENvbXBpbGUgYSBwbGFpbiBpbmRleCBrZXkgY29tbWFuZC4KVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5pbmRleCA9IGZ1bmN0aW9uKGNvbHVtbnMsIGluZGV4TmFtZSkgewogIGluZGV4TmFtZSA9IGluZGV4TmFtZSB8fCB0aGlzLl9pbmRleENvbW1hbmQoJ2luZGV4JywgdGhpcy50YWJsZU5hbWVSYXcsIGNvbHVtbnMpOwogIGNvbHVtbnMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoY29sdW1ucyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2NyZWF0ZSBpbmRleCAnICsgaW5kZXhOYW1lICsgJyBvbiAnICsgdGhpcy50YWJsZU5hbWUoKSArICcgKCcgKyBjb2x1bW5zICsgJyknKTsKfTsKClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucHJpbWFyeSA9ClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUuZm9yZWlnbiA9IGZ1bmN0aW9uKCkgewogIGlmICh0aGlzLm1ldGhvZCAhPT0gJ2NyZWF0ZScpIHsKICAgIGNvbnNvbGUud2FybignU1FMaXRlMyBGb3JlaWduICYgUHJpbWFyeSBrZXlzIG1heSBvbmx5IGJlIGFkZGVkIG9uIGNyZWF0ZScpOwogIH0KfTsKClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucHJpbWFyeUtleXMgPSBmdW5jdGlvbigpIHsKICB2YXIgcGtzID0gXy53aGVyZSh0aGlzLmdyb3VwZWQuYWx0ZXJUYWJsZSB8fCBbXSwge21ldGhvZDogJ3ByaW1hcnknfSk7CiAgaWYgKHBrcy5sZW5ndGggPiAwICYmIHBrc1swXS5hcmdzLmxlbmd0aCA+IDApIHsKICAgIHZhciBhcmdzID0gXy5pc0FycmF5KHBrc1swXS5hcmdzWzBdKSA/IHBrc1swXS5hcmdzWzBdIDogcGtzWzBdLmFyZ3M7CiAgICByZXR1cm4gJywgcHJpbWFyeSBrZXkgKCcgKyB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoYXJncykgKyAnKSc7CiAgfQp9OwoKVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5mb3JlaWduS2V5cyA9IGZ1bmN0aW9uKCkgewogIHZhciBzcWwgPSAnJzsKICB2YXIgZm9yZWlnbktleXMgPSBfLndoZXJlKHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdLCB7bWV0aG9kOiAnZm9yZWlnbid9KTsKICBmb3IgKHZhciBpID0gMCwgbCA9IGZvcmVpZ25LZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGZvcmVpZ24gICAgICAgPSBmb3JlaWduS2V5c1tpXS5hcmdzWzBdOwogICAgdmFyIGNvbHVtbiAgICAgICAgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbi5jb2x1bW4pOwogICAgdmFyIHJlZmVyZW5jZXMgICAgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbi5yZWZlcmVuY2VzKTsKICAgIHZhciBmb3JlaWduVGFibGUgID0gdGhpcy5mb3JtYXR0ZXIud3JhcChmb3JlaWduLmluVGFibGUpOwogICAgc3FsICs9ICcsIGZvcmVpZ24ga2V5KCcgKyBjb2x1bW4gKyAnKSByZWZlcmVuY2VzICcgKyBmb3JlaWduVGFibGUgKyAnKCcgKyByZWZlcmVuY2VzICsgJyknOwogICAgaWYgKGZvcmVpZ24ub25EZWxldGUpIHNxbCArPSAnIG9uIGRlbGV0ZSAnICsgZm9yZWlnbi5vbkRlbGV0ZTsKICAgIGlmIChmb3JlaWduLm9uVXBkYXRlKSBzcWwgKz0gJyBvbiB1cGRhdGUgJyArIGZvcmVpZ24ub25VcGRhdGU7CiAgfQogIHJldHVybiBzcWw7Cn07CgpUYWJsZUNvbXBpbGVyX1NRTGl0ZTMucHJvdG90eXBlLmNyZWF0ZVRhYmxlQmxvY2sgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5nZXRDb2x1bW5zKCkuY29uY2F0KCkuam9pbignLCcpOwp9OwoKLy8gQ29tcGlsZSBhIHJlbmFtZSBjb2x1bW4gY29tbWFuZC4uLiB2ZXJ5IGNvbXBsZXggaW4gc3FsaXRlClRhYmxlQ29tcGlsZXJfU1FMaXRlMy5wcm90b3R5cGUucmVuYW1lQ29sdW1uID0gZnVuY3Rpb24oZnJvbSwgdG8pIHsKICB2YXIgY29tcGlsZXIgPSB0aGlzOwogIHRoaXMucHVzaFF1ZXJ5KHsKICAgIHNxbDogJ1BSQUdNQSB0YWJsZV9pbmZvKCcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyknLAogICAgb3V0cHV0OiBmdW5jdGlvbihwcmFnbWEpIHsKICAgICAgcmV0dXJuIG5ldyBjb21waWxlci5TUUxpdGUzX0RETCh0aGlzLCBjb21waWxlciwgcHJhZ21hKS5yZW5hbWVDb2x1bW4oZnJvbSwgdG8pOwogICAgfQogIH0pOwp9OwoKVGFibGVDb21waWxlcl9TUUxpdGUzLnByb3RvdHlwZS5kcm9wQ29sdW1uID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdmFyIGNvbXBpbGVyID0gdGhpczsKICB0aGlzLnB1c2hRdWVyeSh7CiAgICBzcWw6ICdQUkFHTUEgdGFibGVfaW5mbygnICsgdGhpcy50YWJsZU5hbWUoKSArICcpJywKICAgIG91dHB1dDogZnVuY3Rpb24ocHJhZ21hKSB7CiAgICAgIHJldHVybiBuZXcgY29tcGlsZXIuU1FMaXRlM19EREwodGhpcywgY29tcGlsZXIsIHByYWdtYSkuZHJvcENvbHVtbihjb2x1bW4pOwogICAgfQogIH0pOwp9OwoKY2xpZW50LlRhYmxlQnVpbGRlciA9IFRhYmxlQnVpbGRlcl9TUUxpdGUzOwpjbGllbnQuVGFibGVDb21waWxlciA9IFRhYmxlQ29tcGlsZXJfU1FMaXRlMzsKCn07Cn0seyIuLi8uLi8uLi9zY2hlbWEiOjExNCwiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDkzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBTZWVkZXIgPSByZXF1aXJlKCcuLi8uLi9zZWVkJyk7CnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CgovLyBJbmhlcml0IGZyb20gdGhlIGBTZWVkZXJgIGNvbnN0cnVjdG9yJ3MgcHJvdG90eXBlLAovLyBzbyB3ZSBjYW4gYWRkIHRoZSBjb3JyZWN0IGB0aGVuYCBtZXRob2QuCmZ1bmN0aW9uIFNlZWRlcl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFNlZWRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9CmluaGVyaXRzKFNlZWRlcl9TUUxpdGUzLCBTZWVkZXIpOwoKLy8gQXNzaWduIHRoZSBuZXdseSBleHRlbmRlZCBgU2VlZGVyYCBjb25zdHJ1Y3RvciB0byB0aGUgY2xpZW50IG9iamVjdC4KY2xpZW50LlNlZWRlciA9IFNlZWRlcl9TUUxpdGUzOwoKfTsKfSx7Ii4uLy4uL3NlZWQiOjExNywiaW5oZXJpdHMiOjc2fV0sOTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBTUUxpdGUzIFRyYW5zYWN0aW9uCi8vIC0tLS0tLS0KbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihjbGllbnQpIHsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBUcmFuc2FjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zYWN0aW9uJyk7CgpmdW5jdGlvbiBUcmFuc2FjdGlvbl9TUUxpdGUzKCkgewogIHRoaXMuY2xpZW50ID0gY2xpZW50OwogIFRyYW5zYWN0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoVHJhbnNhY3Rpb25fU1FMaXRlMywgVHJhbnNhY3Rpb24pOwoKY2xpZW50LlRyYW5zYWN0aW9uID0gVHJhbnNhY3Rpb25fU1FMaXRlMzsKCn07Cn0seyIuLi8uLi90cmFuc2FjdGlvbiI6MTE4LCJpbmhlcml0cyI6NzZ9XSw5NTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFdlYlNRTAovLyAtLS0tLS0tCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKdmFyIENsaWVudF9TUUxpdGUzID0gcmVxdWlyZSgnLi4vc3FsaXRlMy9pbmRleCcpOwp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4uLy4uL3Byb21pc2UnKTsKCmZ1bmN0aW9uIENsaWVudF9XZWJTUUwoY29uZmlnKSB7CiAgY29uZmlnID0gY29uZmlnIHx8IHt9OwogIENsaWVudF9TUUxpdGUzLnN1cGVyXy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmIChjb25maWcuZGVidWcpIHRoaXMuaXNEZWJ1Z2dpbmcgPSB0cnVlOwogIHRoaXMubmFtZSA9IGNvbmZpZy5uYW1lIHx8ICdrbmV4X2RhdGFiYXNlJzsKICB0aGlzLnZlcnNpb24gPSBjb25maWcudmVyc2lvbiB8fCAnMS4wJzsKICB0aGlzLmRpc3BsYXlOYW1lID0gY29uZmlnLmRpc3BsYXlOYW1lIHx8IHRoaXMubmFtZTsKICB0aGlzLmVzdGltYXRlZFNpemUgPSBjb25maWcuZXN0aW1hdGVkU2l6ZSB8fCA1ICogMTAyNCAqIDEwMjQ7CiAgdGhpcy5pbml0RHJpdmVyKCk7CiAgdGhpcy5pbml0UnVubmVyKCk7CiAgdGhpcy50cmFuc2FjdGlvbiA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KaW5oZXJpdHMoQ2xpZW50X1dlYlNRTCwgQ2xpZW50X1NRTGl0ZTMpOwoKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuZGlhbGVjdCA9ICd3ZWJzcWwnOwpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5pbml0RHJpdmVyID0gZnVuY3Rpb24oKSB7fTsKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuaW5pdFBvb2wgPSBmdW5jdGlvbigpIHt9OwpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5pbml0TWlncmF0b3IgPSBmdW5jdGlvbigpIHt9OwoKLy8gSW5pdGlhbGl6ZSB0aGUgcXVlcnkgInJ1bm5lciIKQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuaW5pdFJ1bm5lciA9IGZ1bmN0aW9uKCkgewogIHJlcXVpcmUoJy4vcnVubmVyJykodGhpcyk7Cn07CgovLyBHZXQgYSByYXcgY29ubmVjdGlvbiBmcm9tIHRoZSBkYXRhYmFzZSwgcmV0dXJuaW5nIGEgcHJvbWlzZSB3aXRoIHRoZSBjb25uZWN0aW9uIG9iamVjdC4KQ2xpZW50X1dlYlNRTC5wcm90b3R5cGUuYWNxdWlyZUNvbm5lY3Rpb24gPSBmdW5jdGlvbigpIHsKICB2YXIgY2xpZW50ID0gdGhpczsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICB0cnkgewogICAgICAvKmpzbGludCBicm93c2VyOiB0cnVlKi8KICAgICAgdmFyIGRiID0gb3BlbkRhdGFiYXNlKGNsaWVudC5uYW1lLCBjbGllbnQudmVyc2lvbiwgY2xpZW50LmRpc3BsYXlOYW1lLCBjbGllbnQuZXN0aW1hdGVkU2l6ZSk7CiAgICAgIGRiLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICB0Ll9fY2lkID0gXy51bmlxdWVJZCgnX19jaWQnKTsKICAgICAgICByZXNvbHZlKHQpOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmVqZWN0KGUpOwogICAgfQogIH0pOwp9OwoKLy8gVXNlZCB0byBleHBsaWNpdGx5IGNsb3NlIGEgY29ubmVjdGlvbiwgY2FsbGVkIGludGVybmFsbHkgYnkgdGhlIHBvb2wKLy8gd2hlbiBhIGNvbm5lY3Rpb24gdGltZXMgb3V0IG9yIHRoZSBwb29sIGlzIHNodXRkb3duLgpDbGllbnRfV2ViU1FMLnByb3RvdHlwZS5yZWxlYXNlQ29ubmVjdGlvbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkge30pOwoKbW9kdWxlLmV4cG9ydHMgPSBDbGllbnRfV2ViU1FMOwp9LHsiLi4vLi4vcHJvbWlzZSI6MTAzLCIuLi9zcWxpdGUzL2luZGV4Ijo4MiwiLi9ydW5uZXIiOjk2LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSdW5uZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNsaWVudCkgewoKdmFyIFByb21pc2UgID0gcmVxdWlyZSgnLi4vLi4vcHJvbWlzZScpOwoKLy8gUmVxdWlyZSB0aGUgU1FMaXRlMyBSdW5uZXIuCnJlcXVpcmUoJy4uL3NxbGl0ZTMvcnVubmVyJykoY2xpZW50KTsKdmFyIFJ1bm5lcl9TUUxpdGUzID0gY2xpZW50LlJ1bm5lcjsKCnZhciBpbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7CnZhciBfICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwoKLy8gSW5oZXJpdCBmcm9tIHRoZSBgUnVubmVyYCBjb25zdHJ1Y3RvcidzIHByb3RvdHlwZSwKLy8gc28gd2UgY2FuIGFkZCB0aGUgY29ycmVjdCBgdGhlbmAgbWV0aG9kLgpmdW5jdGlvbiBSdW5uZXJfV2ViU1FMKCkgewogIFJ1bm5lcl9TUUxpdGUzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn0KaW5oZXJpdHMoUnVubmVyX1dlYlNRTCwgUnVubmVyX1NRTGl0ZTMpOwoKLy8gUnVucyB0aGUgcXVlcnkgb24gdGhlIHNwZWNpZmllZCBjb25uZWN0aW9uLCBwcm92aWRpbmcgdGhlIGJpbmRpbmdzIGFuZCBhbnkgb3RoZXIgbmVjZXNzYXJ5IHByZXAgd29yay4KUnVubmVyX1dlYlNRTC5wcm90b3R5cGUuX3F1ZXJ5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ob2JqKSB7CiAgaWYgKHRoaXMuaXNEZWJ1Z2dpbmcoKSkgdGhpcy5kZWJ1ZyhvYmopOwogIHZhciBjb25uZWN0aW9uID0gdGhpcy5jb25uZWN0aW9uOwogIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlciwgcmVqZWN0ZXIpIHsKICAgIGlmICghY29ubmVjdGlvbikgewogICAgICByZXR1cm4gcmVqZWN0ZXIobmV3IEVycm9yKCdObyBjb25uZWN0aW9uIHByb3ZpZGVkLicpKTsKICAgIH0KICAgIGNvbm5lY3Rpb24uZXhlY3V0ZVNxbChvYmouc3FsLCBvYmouYmluZGluZ3MsIGZ1bmN0aW9uKHRyeCwgcmVzcG9uc2UpIHsKICAgICAgb2JqLnJlc3BvbnNlID0gcmVzcG9uc2U7CiAgICAgIHJldHVybiByZXNvbHZlcihvYmopOwogICAgfSwgZnVuY3Rpb24odHJ4LCBlcnIpIHsKICAgICAgY29uc29sZS5lcnJvcihlcnIpOwogICAgICByZWplY3RlcihlcnIpOwogICAgfSk7CiAgfSk7Cn0pOwoKLy8gTnVsbCBvdXQgdGhlIHRyYW5zYWN0aW9uIHN0YXRlbWVudHMgc28gdGhleSBhcmVuJ3QgcnVuLgpSdW5uZXJfV2ViU1FMLnByb3RvdHlwZS5fYmVnaW5UcmFuc2FjdGlvbiAgICA9IG51bGw7ClJ1bm5lcl9XZWJTUUwucHJvdG90eXBlLl9jb21taXRUcmFuc2FjdGlvbiAgID0gbnVsbDsKUnVubmVyX1dlYlNRTC5wcm90b3R5cGUuX3JvbGxiYWNrVHJhbnNhY3Rpb24gPSBudWxsOwoKLy8gRW5zdXJlcyB0aGUgcmVzcG9uc2UgaXMgcmV0dXJuZWQgaW4gdGhlIHNhbWUgZm9ybWF0IGFzIG90aGVyIGNsaWVudHMuClJ1bm5lcl9XZWJTUUwucHJvdG90eXBlLnByb2Nlc3NSZXNwb25zZSA9IGZ1bmN0aW9uKG9iaikgewogIHZhciByZXNwID0gb2JqLnJlc3BvbnNlOwogIGlmIChvYmoub3V0cHV0KSByZXR1cm4gb2JqLm91dHB1dC5jYWxsKHRoaXMsIHJlc3ApOwogIHN3aXRjaCAob2JqLm1ldGhvZCkgewogICAgY2FzZSAncGx1Y2snOgogICAgY2FzZSAnZmlyc3QnOgogICAgY2FzZSAnc2VsZWN0JzoKICAgICAgdmFyIHJlc3VsdHMgPSBbXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSByZXNwLnJvd3MubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcmVzdWx0c1tpXSA9IF8uY2xvbmUocmVzcC5yb3dzLml0ZW0oaSkpOwogICAgICB9CiAgICAgIGlmIChvYmoubWV0aG9kID09PSAncGx1Y2snKSByZXN1bHRzID0gXy5wbHVjayhyZXN1bHRzLCBvYmoucGx1Y2spOwogICAgICByZXR1cm4gb2JqLm1ldGhvZCA9PT0gJ2ZpcnN0JyA/IHJlc3VsdHNbMF0gOiByZXN1bHRzOwogICAgY2FzZSAnaW5zZXJ0JzoKICAgICAgcmV0dXJuIFtyZXNwLmluc2VydElkXTsKICAgIGNhc2UgJ2RlbGV0ZSc6CiAgICBjYXNlICd1cGRhdGUnOgogICAgY2FzZSAnY291bnRlcic6CiAgICAgIHJldHVybiByZXNwLnJvd3NBZmZlY3RlZDsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiByZXNwOwogIH0KfTsKCi8vIEFzc2lnbiB0aGUgbmV3bHkgZXh0ZW5kZWQgYFJ1bm5lcmAgY29uc3RydWN0b3IgdG8gdGhlIGNsaWVudCBvYmplY3QuCmNsaWVudC5SdW5uZXIgPSBSdW5uZXJfV2ViU1FMOwoKfTsKfSx7Ii4uLy4uL3Byb21pc2UiOjEwMywiLi4vc3FsaXRlMy9ydW5uZXIiOjg3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sOTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBNaXhlZCBpbnRvIHRoZSBxdWVyeSBjb21waWxlciAmIHNjaGVtYSBwaWVjZXMuIEFzc3VtZXMgYSBgZ3JhbW1hcmAKLy8gcHJvcGVydHkgZXhpc3RzIG9uIHRoZSBjdXJyZW50IG9iamVjdC4KdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUXVlcnlCdWlsZGVyID0gcmVxdWlyZSgnLi9xdWVyeS9idWlsZGVyJyk7Cgp2YXIgUmF3ICA9IHJlcXVpcmUoJy4vcmF3Jyk7CnZhciBwdXNoID0gQXJyYXkucHJvdG90eXBlLnB1c2g7CgovLyBWYWxpZCB2YWx1ZXMgZm9yIHRoZSBgb3JkZXIgYnlgIGNsYXVzZSBnZW5lcmF0aW9uLgp2YXIgb3JkZXJCeXMgID0gWydhc2MnLCAnZGVzYyddOwoKLy8gQSAiZm9ybWF0dGVyIiBpbnN0YW5jZSBpcyB1c2VkIHRvIGJvdGggZGV0ZXJtaW5lIGhvdyB3cmFwLCBiaW5kLCBhbmQKLy8gcGFyYW1ldGVyaXplIHZhbHVlcyB3aXRoaW4gYSBxdWVyeSwga2VlcGluZyB0cmFjayBvZiBhbGwgYmluZGluZ3MKLy8gYWRkZWQgdG8gdGhlIHF1ZXJ5LiBUaGlzIGFsbG93cyB1cyB0byBlYXNpbHkga2VlcCB0cmFjayBvZiByYXcgc3RhdGVtZW50cwovLyBhcmJpdHJhcmlseSBhZGRlZCB0byBxdWVyaWVzLgpmdW5jdGlvbiBGb3JtYXR0ZXIoKSB7CiAgdGhpcy5iaW5kaW5ncyA9IFtdOwp9CgovLyBUdXJucyBhIGxpc3Qgb2YgdmFsdWVzIGludG8gYSBsaXN0IG9mID8ncywgam9pbmluZyB0aGVtIHdpdGggY29tbWFzIHVubGVzcwovLyBhICJqb2luaW5nIiB2YWx1ZSBpcyBzcGVjaWZpZWQgKGUuZy4gJyBhbmQgJykKRm9ybWF0dGVyLnByb3RvdHlwZS5wYXJhbWV0ZXJpemUgPSBmdW5jdGlvbih2YWx1ZXMpIHsKICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlcykpIHJldHVybiB0aGlzLnBhcmFtZXRlcih2YWx1ZXMpOwogIHZhbHVlcyA9IF8uaXNBcnJheSh2YWx1ZXMpID8gdmFsdWVzIDogW3ZhbHVlc107CiAgcmV0dXJuIF8ubWFwKHZhbHVlcywgdGhpcy5wYXJhbWV0ZXIsIHRoaXMpLmpvaW4oJywgJyk7Cn07CgovLyBDaGVja3Mgd2hldGhlciBhIHZhbHVlIGlzIGEgZnVuY3Rpb24uLi4gaWYgaXQgaXMsIHdlIGNvbXBpbGUgaXQKLy8gb3RoZXJ3aXNlIHdlIGNoZWNrIHdoZXRoZXIgaXQncyBhIHJhdwpGb3JtYXR0ZXIucHJvdG90eXBlLnBhcmFtZXRlciA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlKSwgdHJ1ZSk7CiAgfQogIHJldHVybiB0aGlzLmNoZWNrUmF3KHZhbHVlLCB0cnVlKSB8fCAnPyc7Cn07CgpGb3JtYXR0ZXIucHJvdG90eXBlLmNoZWNrUmF3ID0gZnVuY3Rpb24odmFsdWUsIHBhcmFtZXRlcikgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFF1ZXJ5QnVpbGRlcikgewogICAgdmFyIHF1ZXJ5ID0gdmFsdWUudG9TUUwoKTsKICAgIGlmIChxdWVyeS5iaW5kaW5ncykgcHVzaC5hcHBseSh0aGlzLmJpbmRpbmdzLCBxdWVyeS5iaW5kaW5ncyk7CiAgICByZXR1cm4gdGhpcy5vdXRwdXRRdWVyeShxdWVyeSk7CiAgfQogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJhdykgewogICAgaWYgKHZhbHVlLmJpbmRpbmdzKSBwdXNoLmFwcGx5KHRoaXMuYmluZGluZ3MsIHZhbHVlLmJpbmRpbmdzKTsKICAgIHJldHVybiB2YWx1ZS5zcWw7CiAgfQogIGlmIChwYXJhbWV0ZXIpIHRoaXMuYmluZGluZ3MucHVzaCh2YWx1ZSk7Cn07CgpGb3JtYXR0ZXIucHJvdG90eXBlLnJhd09yRm4gPSBmdW5jdGlvbih2YWx1ZSwgbWV0aG9kKSB7CiAgaWYgKF8uaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgIHJldHVybiB0aGlzLm91dHB1dFF1ZXJ5KHRoaXMuY29tcGlsZUNhbGxiYWNrKHZhbHVlLCBtZXRob2QpKTsKICB9CiAgcmV0dXJuIHRoaXMuY2hlY2tSYXcodmFsdWUpIHx8ICcnOwp9OwoKLy8gUHV0cyB0aGUgYXBwcm9wcmlhdGUgd3JhcHBlciBhcm91bmQgYSB2YWx1ZSBkZXBlbmRpbmcgb24gdGhlIGRhdGFiYXNlCi8vIGVuZ2luZSwgdW5sZXNzIGl0J3MgYSBrbmV4LnJhdyB2YWx1ZSwgaW4gd2hpY2ggY2FzZSBpdCdzIGxlZnQgYWxvbmUuCkZvcm1hdHRlci5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgdmFyIHJhdzsKICBpZiAoXy5pc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgcmV0dXJuIHRoaXMub3V0cHV0UXVlcnkodGhpcy5jb21waWxlQ2FsbGJhY2sodmFsdWUpLCB0cnVlKTsKICB9CiAgcmF3ID0gdGhpcy5jaGVja1Jhdyh2YWx1ZSk7CiAgaWYgKHJhdykgcmV0dXJuIHJhdzsKICBpZiAoXy5pc051bWJlcih2YWx1ZSkpIHJldHVybiB2YWx1ZTsKICByZXR1cm4gdGhpcy5fd3JhcCh2YWx1ZSArICcnKTsKfTsKCi8vIENvZXJjZSB0byBzdHJpbmcgdG8gcHJldmVudCBzdHJhbmdlIGVycm9ycyB3aGVuIGl0J3Mgbm90IGEgc3RyaW5nLgpGb3JtYXR0ZXIucHJvdG90eXBlLl93cmFwU3RyaW5nID0gZnVuY3Rpb24odmFsdWUpIHsKICB2YXIgc2VnbWVudHMsIGFzSW5kZXggPSB2YWx1ZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJyBhcyAnKTsKICBpZiAoYXNJbmRleCAhPT0gLTEpIHsKICAgIHZhciBmaXJzdCAgPSB2YWx1ZS5zbGljZSgwLCBhc0luZGV4KTsKICAgIHZhciBzZWNvbmQgPSB2YWx1ZS5zbGljZShhc0luZGV4ICsgNCk7CiAgICByZXR1cm4gdGhpcy53cmFwKGZpcnN0KSArICcgYXMgJyArIHRoaXMud3JhcChzZWNvbmQpOwogIH0KICB2YXIgd3JhcHBlZCA9IFtdOwogIHNlZ21lbnRzID0gdmFsdWUuc3BsaXQoJy4nKTsKICBmb3IgKHZhciBpID0gMCwgbCA9IHNlZ21lbnRzLmxlbmd0aDsgaSA8IGw7IGkgPSArK2kpIHsKICAgIHZhbHVlID0gc2VnbWVudHNbaV07CiAgICBpZiAoaSA9PT0gMCAmJiBzZWdtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgIHdyYXBwZWQucHVzaCh0aGlzLndyYXAoKHZhbHVlIHx8ICcnKS50cmltKCkpKTsKICAgIH0gZWxzZSB7CiAgICAgIHdyYXBwZWQucHVzaCh0aGlzLndyYXBWYWx1ZSgodmFsdWUgfHwgJycpLnRyaW0oKSkpOwogICAgfQogIH0KICByZXR1cm4gd3JhcHBlZC5qb2luKCcuJyk7Cn07CgovLyBBY2NlcHRzIGEgc3RyaW5nIG9yIGFycmF5IG9mIGNvbHVtbnMgdG8gd3JhcCBhcyBhcHByb3ByaWF0ZS4KRm9ybWF0dGVyLnByb3RvdHlwZS5jb2x1bW5pemUgPSBmdW5jdGlvbih0YXJnZXQpIHsKICB2YXIgY29sdW1ucyA9IChfLmlzU3RyaW5nKHRhcmdldCkgPyBbdGFyZ2V0XSA6IHRhcmdldCk7CiAgcmV0dXJuIF8ubWFwKGNvbHVtbnMsIHRoaXMud3JhcCwgdGhpcykuam9pbignLCAnKTsKfTsKCi8vIFRoZSBvcGVyYXRvciBtZXRob2QgdGFrZXMgYSB2YWx1ZSBhbmQgcmV0dXJucyBzb21ldGhpbmcgb3Igb3RoZXIuCkZvcm1hdHRlci5wcm90b3R5cGUub3BlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogIHZhciByYXcgPSB0aGlzLmNoZWNrUmF3KHZhbHVlKTsKICBpZiAocmF3KSByZXR1cm4gcmF3OwogIGlmICghXy5jb250YWlucyh0aGlzLm9wZXJhdG9ycywgKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSkgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignVGhlIG9wZXJhdG9yICInICsgdmFsdWUgKyAnIiBpcyBub3QgcGVybWl0dGVkJyk7CiAgfQogIHJldHVybiB2YWx1ZTsKfTsKCi8vIFNwZWNpZnkgdGhlIGRpcmVjdGlvbiBvZiB0aGUgb3JkZXJpbmcuCkZvcm1hdHRlci5wcm90b3R5cGUuZGlyZWN0aW9uID0gZnVuY3Rpb24odmFsdWUpIHsKICB2YXIgcmF3ID0gdGhpcy5jaGVja1Jhdyh2YWx1ZSk7CiAgaWYgKHJhdykgcmV0dXJuIHJhdzsKICByZXR1cm4gXy5jb250YWlucyhvcmRlckJ5cywgKHZhbHVlIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSA/IHZhbHVlIDogJ2FzYyc7Cn07CgovLyBDb21waWxlcyBhIGNhbGxiYWNrIHVzaW5nIHRoZSBxdWVyeSBidWlsZGVyLgpGb3JtYXR0ZXIucHJvdG90eXBlLmNvbXBpbGVDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBtZXRob2QpIHsKICB2YXIgY2xpZW50ID0gdGhpcy5jbGllbnQ7CgogIC8vIEJ1aWxkIHRoZSBjYWxsYmFjawogIHZhciBidWlsZGVyICA9IG5ldyBjbGllbnQuUXVlcnlCdWlsZGVyKCk7CiAgY2FsbGJhY2suY2FsbChidWlsZGVyLCBidWlsZGVyKTsKCiAgLy8gQ29tcGlsZSB0aGUgY2FsbGJhY2ssIHVzaW5nIHRoZSBjdXJyZW50IGZvcm1hdHRlciAodG8gdHJhY2sgYWxsIGJpbmRpbmdzKS4KICB2YXIgY29tcGlsZXIgPSBuZXcgY2xpZW50LlF1ZXJ5Q29tcGlsZXIoYnVpbGRlcik7CiAgY29tcGlsZXIuZm9ybWF0dGVyID0gdGhpczsKCiAgLy8gUmV0dXJuIHRoZSBjb21waWxlZCAmIHBhcmFtZXRlcml6ZWQgc3FsLgogIHJldHVybiBjb21waWxlci50b1NRTChtZXRob2QgfHwgJ3NlbGVjdCcpOwp9OwoKLy8gRW5zdXJlcyB0aGUgcXVlcnkgaXMgYWxpYXNlZCBpZiBuZWNlc3NhcnkuCkZvcm1hdHRlci5wcm90b3R5cGUub3V0cHV0UXVlcnkgPSBmdW5jdGlvbihjb21waWxlZCwgYWx3YXlzV3JhcHBlZCkgewogIHZhciBzcWwgPSBjb21waWxlZC5zcWwgfHwgJyc7CiAgaWYgKHNxbCkgewogICAgaWYgKGNvbXBpbGVkLm1ldGhvZCA9PT0gJ3NlbGVjdCcgJiYgYWx3YXlzV3JhcHBlZCB8fCBjb21waWxlZC5hcykgewogICAgICBzcWwgPSAnKCcgKyBzcWwgKyAnKSc7CiAgICAgIGlmIChjb21waWxlZC5hcykgc3FsICs9ICcgYXMgJyArIHRoaXMud3JhcChjb21waWxlZC5hcyk7CiAgICB9CiAgfQogIHJldHVybiBzcWw7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IEZvcm1hdHRlcjsKfSx7Ii4vcXVlcnkvYnVpbGRlciI6MTA0LCIuL3JhdyI6MTA4LCJsb2Rhc2giOjEzMH1dLDk4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gRnVuY3Rpb25IZWxwZXIKLy8gLS0tLS0tLQptb2R1bGUuZXhwb3J0cyA9IHsKCiAgbm93OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBuZXcgdGhpcy5jbGllbnQuUmF3KCdDVVJSRU5UX1RJTUVTVEFNUCcpOwogIH0KCn07Cn0se31dLDk5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gaGVscGVycy5qcwovLyAtLS0tLS0tCgovLyBKdXN0IHNvbWUgY29tbW9uIGZ1bmN0aW9ucyBuZWVkZWQgaW4gbXVsdGlwbGUgcGxhY2VzIHdpdGhpbiB0aGUgbGlicmFyeS4KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKCnZhciBoZWxwZXJzID0gewoKICAvLyBQaWNrIG9mZiB0aGUgYXR0cmlidXRlcyBmcm9tIG9ubHkgdGhlIGN1cnJlbnQgbGF5ZXIgb2YgdGhlIG9iamVjdC4KICBza2ltOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy5tYXAoZGF0YSwgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBfLnBpY2sob2JqLCBfLmtleXMob2JqKSk7CiAgICB9KTsKICB9LAoKICAvLyBDaGVjayBpZiB0aGUgZmlyc3QgYXJndW1lbnQgaXMgYW4gYXJyYXksIG90aGVyd2lzZQogIC8vIHVzZXMgYWxsIGFyZ3VtZW50cyBhcyBhbiBhcnJheS4KICBub3JtYWxpemVBcnI6IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgIH0KICAgIGlmIChfLmlzQXJyYXkoYXJnc1swXSkpIHsKICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICB9CiAgICByZXR1cm4gYXJnczsKICB9LAoKICAvLyBVc2VkIHRvIHNpZ25pZnkgZGVwcmVjYXRlZCBmdW5jdGlvbmFsaXR5LgogIGRlcHJlY2F0ZTogZnVuY3Rpb24obXNnKSB7CiAgICB0aGlzLndhcm4obXNnKTsKICB9LAoKICAvLyBVc2VkIHRvIHdhcm4gYWJvdXQgaW5jb3JyZWN0IHVzZSwgd2l0aG91dCBlcnJvcidpbmcKICB3YXJuOiBmdW5jdGlvbihtc2cpIHsKICAgIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZSAhPT0gbnVsbCAmJgogICAgICB0eXBlb2YgY29uc29sZS53YXJuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGNvbnNvbGUud2FybigiS25leDogIiArIG1zZyk7CiAgICB9CiAgfSwKCiAgLy8gU29ydCB0aGUga2V5cyBmb3IgdGhlIGluc2VydAogIHNvcnRPYmplY3Q6IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIF8uc29ydEJ5KF8ucGFpcnMob2JqKSwgZnVuY3Rpb24oYSkgewogICAgICByZXR1cm4gYVswXTsKICAgIH0pOwogIH0KCn07Cgptb2R1bGUuZXhwb3J0cyA9IGhlbHBlcnM7Cn0seyJsb2Rhc2giOjEzMH1dLDEwMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oVGFyZ2V0KSB7CnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBTcWxTdHJpbmcgPSByZXF1aXJlKCcuL2RpYWxlY3RzL215c3FsL3N0cmluZycpOwoKVGFyZ2V0LnByb3RvdHlwZS50b1F1ZXJ5ID0gZnVuY3Rpb24odHopIHsKICB2YXIgZGF0YSA9IHRoaXMudG9TUUwodGhpcy5fbWV0aG9kKTsKICBpZiAodGhpcy5fZXJyb3JzICYmIHRoaXMuX2Vycm9ycy5sZW5ndGggPiAwKSB0aHJvdyB0aGlzLl9lcnJvcnNbMF07CiAgaWYgKCFfLmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBbZGF0YV07CiAgcmV0dXJuIF8ubWFwKGRhdGEsIGZ1bmN0aW9uKHN0YXRlbWVudCkgewogICAgcmV0dXJuIHRoaXMuX2Zvcm1hdFF1ZXJ5KHN0YXRlbWVudC5zcWwsIHN0YXRlbWVudC5iaW5kaW5ncywgdHopOwogIH0sIHRoaXMpLmpvaW4oJztcbicpOwp9OwoKLy8gRm9ybWF0IHRoZSBxdWVyeSBhcyBzcWwsIHByZXBwaW5nIGJpbmRpbmdzIGFzIG5lY2Vzc2FyeS4KVGFyZ2V0LnByb3RvdHlwZS5fZm9ybWF0UXVlcnkgPSBmdW5jdGlvbihzcWwsIGJpbmRpbmdzLCB0eikgewogIGlmICh0aGlzLmNsaWVudCAmJiB0aGlzLmNsaWVudC5wcmVwQmluZGluZ3MpIHsKICAgIGJpbmRpbmdzID0gdGhpcy5jbGllbnQucHJlcEJpbmRpbmdzKGJpbmRpbmdzLCB0eik7CiAgfQogIHJldHVybiBTcWxTdHJpbmcuZm9ybWF0KHNxbCwgYmluZGluZ3MsIHRydWUsIHR6KTsKfTsKCi8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgYFJ1bm5lcmAsIHBhc3NpbmcgaW4gdGhlIGN1cnJlbnQgb2JqZWN0LgpUYXJnZXQucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCkgewogIHZhciBSdW5uZXIgPSB0aGlzLmNsaWVudC5SdW5uZXI7CiAgcmV0dXJuIG5ldyBSdW5uZXIodGhpcykucnVuKCkudGhlbihvbkZ1bGZpbGxlZCwgb25SZWplY3RlZCk7Cn07CgovLyBBZGQgYWRkaXRpb25hbCAib3B0aW9ucyIgdG8gdGhlIGJ1aWxkZXIuIFR5cGljYWxseSB1c2VkIGZvciBjbGllbnQgc3BlY2lmaWMKLy8gaXRlbXMsIGxpa2UgdGhlIGBteXNxbGAgYW5kIGBzcWxpdGUzYCBkcml2ZXJzLgpUYXJnZXQucHJvdG90eXBlLm9wdGlvbnMgPSBmdW5jdGlvbihvcHRzKSB7CiAgdGhpcy5fb3B0aW9ucyA9IHRoaXMuX29wdGlvbnMgfHwgW107CiAgdGhpcy5fb3B0aW9ucy5wdXNoKF8uY2xvbmUob3B0cykgfHwge30pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU2V0cyBhbiBleHBsaWNpdCAiY29ubm5lY3Rpb24iIHdlIHdpc2ggdG8gdXNlIGZvciB0aGlzIHF1ZXJ5LgpUYXJnZXQucHJvdG90eXBlLmNvbm5lY3Rpb24gPSBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXQgYSBkZWJ1ZyBmbGFnIGZvciB0aGUgY3VycmVudCBzY2hlbWEgcXVlcnkgc3RhY2suClRhcmdldC5wcm90b3R5cGUuZGVidWcgPSBmdW5jdGlvbih2YWwpIHsKICB0aGlzLl9kZWJ1ZyA9ICh2YWwgPT09IHVuZGVmaW5lZCB8fCB2YWwgPT09IG51bGwpID8gdHJ1ZSA6IHZhbDsKICByZXR1cm4gdGhpczsKfTsKCi8vIFNldCB0aGUgdHJhbnNhY3Rpb24gb2JqZWN0IGZvciB0aGlzIHF1ZXJ5LgpUYXJnZXQucHJvdG90eXBlLnRyYW5zYWN0aW5nID0gZnVuY3Rpb24odCkgewogIHRoaXMuX3RyYW5zYWN0aW5nID0gdDsKICByZXR1cm4gdGhpczsKfTsKCi8vIEluaXRpYWxpemVzIGEgc3RyZWFtLgpUYXJnZXQucHJvdG90eXBlLnN0cmVhbSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgUnVubmVyID0gdGhpcy5jbGllbnQuUnVubmVyOwogIHJldHVybiBuZXcgUnVubmVyKHRoaXMpLnN0cmVhbShvcHRpb25zKTsKfTsKCi8vIEluaXRpYWxpemUgYSBzdHJlYW0gJiBwaXBlIGF1dG9tYXRpY2FsbHkuClRhcmdldC5wcm90b3R5cGUucGlwZSA9IGZ1bmN0aW9uKHdyaXRhYmxlKSB7CiAgdmFyIFJ1bm5lciA9IHRoaXMuY2xpZW50LlJ1bm5lcjsKICByZXR1cm4gbmV3IFJ1bm5lcih0aGlzKS5waXBlKHdyaXRhYmxlKTsKfTsKCi8vIENyZWF0ZXMgYSBtZXRob2Qgd2hpY2ggImNvZXJjZXMiIHRvIGEgcHJvbWlzZSwgYnkgY2FsbGluZyBhCi8vICJ0aGVuIiBtZXRob2Qgb24gdGhlIGN1cnJlbnQgYFRhcmdldGAKXy5lYWNoKFsnYmluZCcsICdjYXRjaCcsICdzcHJlYWQnLCAnb3RoZXJ3aXNlJywgJ21hcCcsICdyZWR1Y2UnLCAndGFwJywgJ3RoZW5SZXR1cm4nLAogICdyZXR1cm4nLCAneWllbGQnLCAnZW5zdXJlJywgJ25vZGVpZnknLCAnZXhlYyddLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYXJnZXQucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgIHZhciB0aGVuID0gdGhpcy50aGVuKCk7CiAgICByZXR1cm4gdGhlblttZXRob2RdLmFwcGx5KHRoZW4sIGFyZ3VtZW50cyk7CiAgfTsKfSk7Cgp9Owp9LHsiLi9kaWFsZWN0cy9teXNxbC9zdHJpbmciOjc5LCJsb2Rhc2giOjEzMH1dLDEwMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2VzcyxfX2Rpcm5hbWUpewovLyBNaWdyYXRvcgovLyAtLS0tLS0tCiJ1c2Ugc3RyaWN0IjsKCnZhciBmcyAgICAgICA9IHJlcXVpcmUoJ2ZzJyk7CnZhciBwYXRoICAgICA9IHJlcXVpcmUoJ3BhdGgnKTsKdmFyIF8gICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBta2RpcnAgICA9IHJlcXVpcmUoJ21rZGlycCcpOwp2YXIgUHJvbWlzZSAgPSByZXF1aXJlKCcuLi9wcm9taXNlJyk7CgovLyBWYWxpZGF0ZXMgdGhhdCBtaWdyYXRpb25zIGFyZSBwcmVzZW50IGluIHRoZSBhcHByb3ByaWF0ZSBkaXJlY3Rvcmllcy4KZnVuY3Rpb24gdmFsaWRhdGVNaWdyYXRpb25MaXN0KGFsbCwgY29tcGxldGVkKSB7CiAgdmFyIGRpZmYgPSBfLmRpZmZlcmVuY2UoY29tcGxldGVkLCBhbGwpOwogIGlmICghXy5pc0VtcHR5KGRpZmYpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICdUaGUgbWlncmF0aW9uIGRpcmVjdG9yeSBpcyBjb3JydXB0LCB0aGUgZm9sbG93aW5nIGZpbGVzIGFyZSBtaXNzaW5nOiAnICsgZGlmZi5qb2luKCcsICcpCiAgICApOwogIH0KfQoKLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSAyIHBsYWNlcyBmb3IgZWFjaCBvZiB0aGUgZGF0ZSBzZWdtZW50cwp2YXIgcGFkRGF0ZSA9IGZ1bmN0aW9uKHNlZ21lbnQpIHsKICBzZWdtZW50ID0gc2VnbWVudC50b1N0cmluZygpOwogIHJldHVybiBzZWdtZW50WzFdID8gc2VnbWVudCA6ICcwJyArIHNlZ21lbnQ7Cn07CgovLyBHZXQgYSBkYXRlIG9iamVjdCBpbiB0aGUgY29ycmVjdCBmb3JtYXQsIHdpdGhvdXQgcmVxdWlyaW5nCi8vIGEgZnVsbCBvdXQgbGlicmFyeSBsaWtlICJtb21lbnQuanMiLgp2YXIgeXl5eW1tZGRoaG1tc3MgPSBmdW5jdGlvbigpIHsKICB2YXIgZCA9IG5ldyBEYXRlKCk7CiAgcmV0dXJuIGQuZ2V0RnVsbFllYXIoKS50b1N0cmluZygpICsKICAgICAgcGFkRGF0ZShkLmdldE1vbnRoKCkgKyAxKSArCiAgICAgIHBhZERhdGUoZC5nZXREYXRlKCkpICsKICAgICAgcGFkRGF0ZShkLmdldEhvdXJzKCkpICsKICAgICAgcGFkRGF0ZShkLmdldE1pbnV0ZXMoKSkgKwogICAgICBwYWREYXRlKGQuZ2V0U2Vjb25kcygpKTsKfTsKCi8vIFRoZSBuZXcgbWlncmF0aW9uIHdlJ3JlIHBlcmZvcm1pbmcsIHR5cGljYWxseSBjYWxsZWQgZnJvbSB0aGUgYGtuZXgubWlncmF0ZWAKLy8gaW50ZXJmYWNlIG9uIHRoZSBtYWluIGBrbmV4YCBvYmplY3QuIFBhc3NlcyB0aGUgYGtuZXhgIGluc3RhbmNlIHBlcmZvcm1pbmcKLy8gdGhlIG1pZ3JhdGlvbi4KZnVuY3Rpb24gTWlncmF0b3Ioa25leCkgewogIHRoaXMua25leCAgID0ga25leDsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGtuZXguY2xpZW50Lm1pZ3JhdGlvbkNvbmZpZyk7Cn0KCi8vIE1pZ3JhdG9ycyB0byB0aGUgbGF0ZXN0IGNvbmZpZ3VyYXRpb24uCk1pZ3JhdG9yLnByb3RvdHlwZS5sYXRlc3QgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgcmV0dXJuIHRoaXMuX21pZ3JhdGlvbkRhdGEoKQogICAgLnRhcCh2YWxpZGF0ZU1pZ3JhdGlvbkxpc3QpCiAgICAuYmluZCh0aGlzKQogICAgLnNwcmVhZChmdW5jdGlvbihhbGwsIGNvbXBsZXRlZCkgewogICAgICByZXR1cm4gdGhpcy5fcnVuQmF0Y2goXy5kaWZmZXJlbmNlKGFsbCwgY29tcGxldGVkKSwgJ3VwJyk7CiAgICB9KTsKfSk7CgovLyBSb2xsYmFjayB0aGUgbGFzdCAiYmF0Y2giIG9mIG1pZ3JhdGlvbnMgdGhhdCB3ZXJlIHJ1bi4KTWlncmF0b3IucHJvdG90eXBlLnJvbGxiYWNrID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIHJldHVybiB0aGlzLl9taWdyYXRpb25EYXRhKCkKICAgIC50YXAodmFsaWRhdGVNaWdyYXRpb25MaXN0KQogICAgLmJpbmQodGhpcykKICAgIC50aGVuKHRoaXMuX2dldExhc3RCYXRjaCkKICAgIC50aGVuKGZ1bmN0aW9uKG1pZ3JhdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3J1bkJhdGNoKF8ucGx1Y2sobWlncmF0aW9ucywgJ25hbWUnKSwgJ2Rvd24nKTsKICAgIH0pOwp9KTsKCi8vIFJldHJpZXZlcyBhbmQgcmV0dXJucyB0aGUgY3VycmVudCBtaWdyYXRpb24gdmVyc2lvbgovLyB3ZSdyZSBvbiwgYXMgYSBwcm9taXNlLiBJZiB0aGVyZSBhcmVuJ3QgYW55IG1pZ3JhdGlvbnMgcnVuIHlldCwKLy8gcmV0dXJuICJub25lIiBhcyB0aGUgdmFsdWUgZm9yIHRoZSBgY3VycmVudFZlcnNpb25gLgpNaWdyYXRvci5wcm90b3R5cGUuY3VycmVudFZlcnNpb24gPSBmdW5jdGlvbihjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgcmV0dXJuIHRoaXMuX2xpc3RDb21wbGV0ZWQoY29uZmlnKS50aGVuKGZ1bmN0aW9uKGNvbXBsZXRlZCkgewogICAgdmFyIHZhbCA9IF8uY2hhaW4oY29tcGxldGVkKS5tYXAoZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlLnNwbGl0KCdfJylbMF07CiAgICB9KS5tYXgoKS52YWx1ZSgpOwogICAgcmV0dXJuICh2YWwgPT09IC1JbmZpbml0eSA/ICdub25lJyA6IHZhbCk7CiAgfSk7Cn07CgovLyBDcmVhdGVzIGEgbmV3IG1pZ3JhdGlvbiwgd2l0aCBhIGdpdmVuIG5hbWUuCk1pZ3JhdG9yLnByb3RvdHlwZS5tYWtlID0gZnVuY3Rpb24obmFtZSwgY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIGlmICghbmFtZSkgUHJvbWlzZS5yZWplY3RlZChuZXcgRXJyb3IoJ0EgbmFtZSBtdXN0IGJlIHNwZWNpZmllZCBmb3IgdGhlIGdlbmVyYXRlZCBtaWdyYXRpb24nKSk7CiAgcmV0dXJuIHRoaXMuX2Vuc3VyZUZvbGRlcihjb25maWcpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4odGhpcy5fZ2VuZXJhdGVTdHViVGVtcGxhdGUpCiAgICAudGhlbih0aGlzLl93cml0ZU5ld01pZ3JhdGlvbihuYW1lKSk7Cn07CgovLyBMaXN0cyBhbGwgYXZhaWxhYmxlIG1pZ3JhdGlvbiB2ZXJzaW9ucywgYXMgYSBzb3J0ZWQgYXJyYXkuCk1pZ3JhdG9yLnByb3RvdHlwZS5fbGlzdEFsbCA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbmZpZykgewogIHRoaXMuY29uZmlnID0gdGhpcy5zZXRDb25maWcoY29uZmlnKTsKICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMucmVhZGRpciwgZnMpKHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCkpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24obWlncmF0aW9ucykgewogICAgICByZXR1cm4gXy5maWx0ZXIobWlncmF0aW9ucywgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgZXh0ZW5zaW9uID0gcGF0aC5leHRuYW1lKHZhbHVlKTsKICAgICAgICByZXR1cm4gXy5jb250YWlucyhbJy5jbycsICcuY29mZmVlJywgJy5pY2VkJywgJy5qcycsICcubGl0Y29mZmVlJywgJy5scyddLCBleHRlbnNpb24pOwogICAgICB9KS5zb3J0KCk7CiAgICB9KTsKfSk7CgovLyBFbnN1cmVzIGEgZm9sZGVyIGZvciB0aGUgbWlncmF0aW9ucyBleGlzdCwgZGVwZW5kZW50IG9uIHRoZQovLyBtaWdyYXRpb24gY29uZmlnIHNldHRpbmdzLgpNaWdyYXRvci5wcm90b3R5cGUuX2Vuc3VyZUZvbGRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBkaXIgPSB0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5zdGF0LCBmcykoZGlyKQogICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkobWtkaXJwKShkaXIpOwogICAgfSk7Cn07CgovLyBFbnN1cmVzIHRoYXQgdGhlIHByb3BlciB0YWJsZSBoYXMgYmVlbiBjcmVhdGVkLAovLyBkZXBlbmRlbnQgb24gdGhlIG1pZ3JhdGlvbiBjb25maWcgc2V0dGluZ3MuCk1pZ3JhdG9yLnByb3RvdHlwZS5fZW5zdXJlVGFibGUgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgdGFibGUgPSB0aGlzLmNvbmZpZy50YWJsZU5hbWU7CiAgcmV0dXJuIHRoaXMua25leC5zY2hlbWEuaGFzVGFibGUodGFibGUpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24oZXhpc3RzKSB7CiAgICAgIGlmICghZXhpc3RzKSByZXR1cm4gdGhpcy5fY3JlYXRlTWlncmF0aW9uVGFibGUodGFibGUpOwogICAgfSk7Cn0pOwoKLy8gQ3JlYXRlIHRoZSBtaWdyYXRpb24gdGFibGUsIGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC4KTWlncmF0b3IucHJvdG90eXBlLl9jcmVhdGVNaWdyYXRpb25UYWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHJldHVybiB0aGlzLmtuZXguc2NoZW1hLmNyZWF0ZVRhYmxlKHRhYmxlTmFtZSwgZnVuY3Rpb24odCkgewogICAgdC5pbmNyZW1lbnRzKCk7CiAgICB0LnN0cmluZygnbmFtZScpOwogICAgdC5pbnRlZ2VyKCdiYXRjaCcpOwogICAgdC50aW1lc3RhbXAoJ21pZ3JhdGlvbl90aW1lJyk7CiAgfSk7Cn07CgovLyBSdW4gYSBiYXRjaCBvZiBjdXJyZW50IG1pZ3JhdGlvbnMsIGluIHNlcXVlbmNlLgpNaWdyYXRvci5wcm90b3R5cGUuX3J1bkJhdGNoID0gZnVuY3Rpb24obWlncmF0aW9ucywgZGlyZWN0aW9uKSB7CiAgcmV0dXJuIFByb21pc2UuYWxsKF8ubWFwKG1pZ3JhdGlvbnMsIHRoaXMuX3ZhbGlkYXRlTWlncmF0aW9uU3RydWN0dXJlLCB0aGlzKSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbihtaWdyYXRpb25zKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbih0aGlzLl9sYXRlc3RCYXRjaE51bWJlcikKICAgICAgICAudGhlbihmdW5jdGlvbihiYXRjaE5vKSB7CiAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndXAnKSBiYXRjaE5vKys7CiAgICAgICAgICByZXR1cm4gYmF0Y2hObzsKICAgICAgICB9KQogICAgICAgIC50aGVuKGZ1bmN0aW9uKGJhdGNoTm8pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl93YXRlcmZhbGxCYXRjaChiYXRjaE5vLCBtaWdyYXRpb25zLCBkaXJlY3Rpb24pOwogICAgICAgIH0pOwogICAgfSk7Cn07CgovLyBWYWxpZGF0ZXMgc29tZSBtaWdyYXRpb25zIGJ5IHJlcXVpcmluZyBhbmQgY2hlY2tpbmcgZm9yIGFuIGB1cGAgYW5kIGBkb3duYCBmdW5jdGlvbi4KTWlncmF0b3IucHJvdG90eXBlLl92YWxpZGF0ZU1pZ3JhdGlvblN0cnVjdHVyZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgbWlncmF0aW9uID0gcmVxdWlyZShwYXRoLmpvaW4odGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKSwgbmFtZSkpOwogIGlmICghXy5pc0Z1bmN0aW9uKG1pZ3JhdGlvbi51cCkgfHwgIV8uaXNGdW5jdGlvbihtaWdyYXRpb24uZG93bikpIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBtaWdyYXRpb246ICcgKyBuYW1lICsgJyBtdXN0IGhhdmUgYm90aCBhbiB1cCBhbmQgZG93biBmdW5jdGlvbicpOwogIH0KICByZXR1cm4gbmFtZTsKfTsKCi8vIExpc3RzIGFsbCBtaWdyYXRpb25zIHRoYXQgaGF2ZSBiZWVuIGNvbXBsZXRlZCBmb3IgdGhlIGN1cnJlbnQgZGIsIGFzIGFuIGFycmF5LgpNaWdyYXRvci5wcm90b3R5cGUuX2xpc3RDb21wbGV0ZWQgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgdGFibGVOYW1lID0gdGhpcy5jb25maWcudGFibGVOYW1lOwogIHJldHVybiB0aGlzLl9lbnN1cmVUYWJsZSh0YWJsZU5hbWUpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5rbmV4KHRhYmxlTmFtZSkub3JkZXJCeSgnaWQnKS5zZWxlY3QoJ25hbWUnKTsKICAgIH0pCiAgICAudGhlbihmdW5jdGlvbihtaWdyYXRpb25zKSB7CiAgICAgIHJldHVybiBfLnBsdWNrKG1pZ3JhdGlvbnMsICduYW1lJyk7CiAgICB9KTsKfSk7CgovLyBHZXRzIHRoZSBtaWdyYXRpb24gbGlzdCBmcm9tIHRoZSBzcGVjaWZpZWQgbWlncmF0aW9uIGRpcmVjdG9yeSwKLy8gYXMgd2VsbCBhcyB0aGUgbGlzdCBvZiBjb21wbGV0ZWQgbWlncmF0aW9ucyB0byBjaGVjayB3aGF0Ci8vIHNob3VsZCBiZSBydW4uCk1pZ3JhdG9yLnByb3RvdHlwZS5fbWlncmF0aW9uRGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBQcm9taXNlLmFsbChbCiAgICB0aGlzLl9saXN0QWxsKCksCiAgICB0aGlzLl9saXN0Q29tcGxldGVkKCkKICBdKTsKfTsKCi8vIEdlbmVyYXRlcyB0aGUgc3R1YiB0ZW1wbGF0ZSBmb3IgdGhlIGN1cnJlbnQgbWlncmF0aW9uLCByZXR1cm5pbmcgYSBjb21waWxlZCB0ZW1wbGF0ZS4KTWlncmF0b3IucHJvdG90eXBlLl9nZW5lcmF0ZVN0dWJUZW1wbGF0ZSA9IGZ1bmN0aW9uKCkgewogIHZhciBzdHViUGF0aCA9IHRoaXMuY29uZmlnLnN0dWIgfHwgcGF0aC5qb2luKF9fZGlybmFtZSwgJ3N0dWInLCB0aGlzLmNvbmZpZy5leHRlbnNpb24gKyAnLnN0dWInKTsKICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMucmVhZEZpbGUsIGZzKShzdHViUGF0aCkudGhlbihmdW5jdGlvbihzdHViKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZShzdHViLnRvU3RyaW5nKCksIG51bGwsIHt2YXJpYWJsZTogJ2QnfSk7CiAgfSk7Cn07CgovLyBXcml0ZSBhIG5ldyBtaWdyYXRpb24gdG8gZGlzaywgdXNpbmcgdGhlIGNvbmZpZyBhbmQgZ2VuZXJhdGVkIGZpbGVuYW1lLAovLyBwYXNzaW5nIGFueSBgdmFyaWFibGVzYCBnaXZlbiBpbiB0aGUgY29uZmlnIHRvIHRoZSB0ZW1wbGF0ZS4KTWlncmF0b3IucHJvdG90eXBlLl93cml0ZU5ld01pZ3JhdGlvbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICB2YXIgY29uZmlnID0gdGhpcy5jb25maWc7CiAgdmFyIGRpciA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKHRtcGwpIHsKICAgIGlmIChuYW1lWzBdID09PSAnLScpIG5hbWUgPSBuYW1lLnNsaWNlKDEpOwogICAgdmFyIGZpbGVuYW1lICA9IHl5eXltbWRkaGhtbXNzKCkgKyAnXycgKyBuYW1lICsgJy4nICsgY29uZmlnLmV4dGVuc2lvbjsKICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy53cml0ZUZpbGUsIGZzKSgKICAgICAgcGF0aC5qb2luKGRpciwgZmlsZW5hbWUpLAogICAgICB0bXBsKGNvbmZpZy52YXJpYWJsZXMgfHwge30pCiAgICApLnJldHVybihwYXRoLmpvaW4oZGlyLCBmaWxlbmFtZSkpOwogIH07Cn07CgovLyBHZXQgdGhlIGxhc3QgYmF0Y2ggb2YgbWlncmF0aW9ucywgYnkgbmFtZSwgb3JkZXJlZCBieSBpbnNlcnQgaWQKLy8gaW4gcmV2ZXJzZSBvcmRlci4KTWlncmF0b3IucHJvdG90eXBlLl9nZXRMYXN0QmF0Y2ggPSBmdW5jdGlvbigpIHsKICB2YXIga25leCA9IHRoaXMua25leDsKICB2YXIgdGFibGVOYW1lID0gdGhpcy5jb25maWcudGFibGVOYW1lOwogIHJldHVybiB0aGlzLmtuZXgodGFibGVOYW1lKQogICAgLndoZXJlKCdiYXRjaCcsIGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnNlbGVjdChrbmV4LnJhdygnTUFYKGJhdGNoKScpKS5mcm9tKHRhYmxlTmFtZSk7CiAgICB9KQogICAgLm9yZGVyQnkoJ2lkJywgJ2Rlc2MnKTsKfTsKCi8vIFJldHVybnMgdGhlIGxhdGVzdCBiYXRjaCBudW1iZXIuCk1pZ3JhdG9yLnByb3RvdHlwZS5fbGF0ZXN0QmF0Y2hOdW1iZXIgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5rbmV4KHRoaXMuY29uZmlnLnRhYmxlTmFtZSkKICAgIC5tYXgoJ2JhdGNoIGFzIGJhdGNoTm8nKS50aGVuKGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gKG9ialswXS5iYXRjaE5vIHx8IDApOwogICAgfSk7Cn07CgovLyBSdW5zIGEgYmF0Y2ggb2YgYG1pZ3JhdGlvbnNgIGluIGEgc3BlY2lmaWVkIGBkaXJlY3Rpb25gLAovLyBzYXZpbmcgdGhlIGFwcHJvcHJpYXRlIGRhdGFiYXNlIGluZm9ybWF0aW9uIGFzIHRoZSBtaWdyYXRpb25zIGFyZSBydW4uCk1pZ3JhdG9yLnByb3RvdHlwZS5fd2F0ZXJmYWxsQmF0Y2ggPSBmdW5jdGlvbihiYXRjaE5vLCBtaWdyYXRpb25zLCBkaXJlY3Rpb24pIHsKICB2YXIga25leCAgICAgID0gdGhpcy5rbmV4OwogIHZhciB0YWJsZU5hbWUgPSB0aGlzLmNvbmZpZy50YWJsZU5hbWU7CiAgdmFyIGRpcmVjdG9yeSA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgdmFyIGN1cnJlbnQgICA9IFByb21pc2UuYmluZCh7ZmFpbGVkOiBmYWxzZSwgZmFpbGVkT246IDB9KTsKICB2YXIgbG9nICAgICAgID0gW107CiAgXy5lYWNoKG1pZ3JhdGlvbnMsIGZ1bmN0aW9uKG1pZ3JhdGlvbikgewogICAgdmFyIG5hbWUgID0gbWlncmF0aW9uOwogICAgbWlncmF0aW9uID0gcmVxdWlyZShkaXJlY3RvcnkgKyAnLycgKyBuYW1lKTsKCiAgICAvLyBXZSdyZSBnb2luZyB0byBydW4gZWFjaCBvZiB0aGUgbWlncmF0aW9ucyBpbiB0aGUgY3VycmVudCAidXAiCiAgICBjdXJyZW50ID0gY3VycmVudC50aGVuKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbWlncmF0aW9uW2RpcmVjdGlvbl0oa25leCwgUHJvbWlzZSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBsb2cucHVzaChwYXRoLmpvaW4oZGlyZWN0b3J5LCBuYW1lKSk7CiAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd1cCcpIHsKICAgICAgICByZXR1cm4ga25leCh0YWJsZU5hbWUpLmluc2VydCh7CiAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgYmF0Y2g6IGJhdGNoTm8sCiAgICAgICAgICBtaWdyYXRpb25fdGltZTogbmV3IERhdGUoKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChkaXJlY3Rpb24gPT09ICdkb3duJykgewogICAgICAgIHJldHVybiBrbmV4KHRhYmxlTmFtZSkud2hlcmUoe25hbWU6IG5hbWV9KS5kZWwoKTsKICAgICAgfQogICAgfSk7CiAgfSk7CgogIHJldHVybiBjdXJyZW50LnRoZW5SZXR1cm4oW2JhdGNoTm8sIGxvZ10pOwp9OwoKTWlncmF0b3IucHJvdG90eXBlLl9hYnNvbHV0ZUNvbmZpZ0RpciA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgdGhpcy5jb25maWcuZGlyZWN0b3J5KTsKfTsKCk1pZ3JhdG9yLnByb3RvdHlwZS5zZXRDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICByZXR1cm4gXy5leHRlbmQoewogICAgZXh0ZW5zaW9uOiAnanMnLAogICAgdGFibGVOYW1lOiAna25leF9taWdyYXRpb25zJywKICAgIGRpcmVjdG9yeTogJy4vbWlncmF0aW9ucycKICB9LCB0aGlzLmNvbmZpZyB8fCB7fSwgY29uZmlnKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gTWlncmF0b3I7Cgp9KS5jYWxsKHRoaXMscmVxdWlyZSgnX3Byb2Nlc3MnKSwiL25vZGVfbW9kdWxlcy9rbmV4L2xpYi9taWdyYXRlIikKfSx7Ii4uL3Byb21pc2UiOjEwMywiX3Byb2Nlc3MiOjYwLCJmcyI6NTEsImxvZGFzaCI6MTMwLCJta2RpcnAiOjEyMCwicGF0aCI6NTl9XSwxMDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBQb29sCi8vIC0tLS0tLS0KdmFyIF8gICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBHZW5lcmljUG9vbCA9IHJlcXVpcmUoJ2dlbmVyaWMtcG9vbC1yZWR1eCcpLlBvb2w7CnZhciBQcm9taXNlICAgICA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwoKLy8gVGhlICJQb29sIiBvYmplY3QgaXMgYSB0aGluIHdyYXBwZXIgYXJvdW5kIHRoZQovLyAiZ2VuZXJpYy1wb29sLXJlZHV4IiBsaWJyYXJ5LCBleHBvc2luZyBhIGBkZXN0cm95YAovLyBtZXRob2QgZm9yIGV4cGxpY2l0bHkgZHJhaW5pbmcgdGhlIHBvb2wuIFRoZQovLyBgaW5pdGAgbWV0aG9kIGlzIGNhbGxlZCBpbnRlcm5hbGx5IGFuZCBpbml0aWFsaXplcwovLyB0aGUgcG9vbCBpZiBpdCBkb2Vzbid0IGFscmVhZHkgZXhpc3QuCmZ1bmN0aW9uIFBvb2woY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSBfLmNsb25lKGNvbmZpZykgfHwge307CiAgdGhpcy5nZW5lcmljUG9vbCA9IHRoaXMuaW5pdGlhbGl6ZSgpOwp9CgovLyBUeXBpY2FsbHkgb25seSBjYWxsZWQgaW50ZXJuYWxseSwgdGhpcyBpbml0aWFsaXplcwovLyBhIG5ldyBgR2VuZXJpY1Bvb2xgIGluc3RhbmNlLCBiYXNlZCBvbiB0aGUgYGNvbmZpZ2AKLy8gb3B0aW9ucyBwYXNzZWQgaW50byB0aGUgY29uc3RydWN0b3IuClBvb2wucHJvdG90eXBlLmluaXRpYWxpemUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gbmV3IEdlbmVyaWNQb29sKF8uZGVmYXVsdHModGhpcy5jb25maWcsIF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKSk7Cn07CgovLyBTb21lIGJhc2ljIGRlZmF1bHRzIGZvciB0aGUgcG9vbC4uLgpQb29sLnByb3RvdHlwZS5kZWZhdWx0cyA9IGZ1bmN0aW9uKCkgewogIHZhciBwb29sID0gdGhpczsKICByZXR1cm4gewogICAgbWluOiAyLAogICAgbWF4OiAxMCwKICAgIGNyZWF0ZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgcG9vbC5jbGllbnQuYWNxdWlyZVJhd0Nvbm5lY3Rpb24oKQogICAgICAgIC50YXAoZnVuY3Rpb24oY29ubmVjdGlvbikgewogICAgICAgICAgY29ubmVjdGlvbi5fX2NpZCA9IF8udW5pcXVlSWQoJ19fY2lkJyk7CiAgICAgICAgICBpZiAocG9vbC5jb25maWcuYWZ0ZXJDcmVhdGUpIHsKICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucHJvbWlzaWZ5KHBvb2wuY29uZmlnLmFmdGVyQ3JlYXRlKShjb25uZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9KS5leGVjKGNhbGxiYWNrKTsKICAgIH0sCiAgICBkZXN0cm95OiBmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIGlmIChwb29sLmNvbmZpZy5iZWZvcmVEZXN0cm95KSB7CiAgICAgICAgcmV0dXJuIHBvb2wuY29uZmlnLmJlZm9yZURlc3Ryb3koY29ubmVjdGlvbiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoY29ubmVjdGlvbiAhPT0gdm9pZCAwKSBjb25uZWN0aW9uLmVuZCgpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChjb25uZWN0aW9uICE9PSB2b2lkIDApIGNvbm5lY3Rpb24uZW5kKCk7CiAgICB9CiAgfTsKfTsKCi8vIEFjcXVpcmVzIGEgY29ubmVjdGlvbiBmcm9tIHRoZSBwb29sLgpQb29sLnByb3RvdHlwZS5hY3F1aXJlID0gZnVuY3Rpb24oY2FsbGJhY2ssIHByaW9yaXR5KSB7CiAgaWYgKHRoaXMuZ2VuZXJpY1Bvb2wpIHsKICAgIHRoaXMuZ2VuZXJpY1Bvb2wuYWNxdWlyZShjYWxsYmFjaywgcHJpb3JpdHkpOwogIH0gZWxzZSB7CiAgICBjYWxsYmFjayhuZXcgRXJyb3IoJ1RoZSBnZW5lcmljUG9vbCBpcyBub3QgaW5pdGlhbGl6ZWQuJykpOwogIH0KfTsKCi8vIFJlbGVhc2UgYSBjb25uZWN0aW9uIGJhY2sgdG8gdGhlIGNvbm5lY3Rpb24gcG9vbC4KUG9vbC5wcm90b3R5cGUucmVsZWFzZSA9IGZ1bmN0aW9uKGNvbm5lY3Rpb24sIGNhbGxiYWNrKSB7CiAgaWYgKHRoaXMuZ2VuZXJpY1Bvb2wpIHsKICAgIHRoaXMuZ2VuZXJpY1Bvb2wucmVsZWFzZShjb25uZWN0aW9uLCBjYWxsYmFjayk7CiAgfSBlbHNlIHsKICAgIGNhbGxiYWNrKG5ldyBFcnJvcignVGhlIGdlbmVyaWNQb29sIGlzIG5vdCBpbml0aWFsaXplZC4nKSk7CiAgfQp9OwoKLy8gVGVhciBkb3duIHRoZSBwb29sLCBvbmx5IG5lY2Vzc2FyeSBpZiB5b3UgbmVlZCBpdC4KUG9vbC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgdmFyIGdlbmVyaWNQb29sID0gdGhpcy5nZW5lcmljUG9vbDsKICBpZiAoZ2VuZXJpY1Bvb2wpIHsKICAgIGdlbmVyaWNQb29sLmRyYWluKGZ1bmN0aW9uKCkgewogICAgICBnZW5lcmljUG9vbC5kZXN0cm95QWxsTm93KGNhbGxiYWNrKTsKICAgIH0pOwogICAgdGhpcy5nZW5lcmljUG9vbCA9IHZvaWQgMDsKICB9IGVsc2UgewogICAgY2FsbGJhY2soKTsKICB9CiAgcmV0dXJuIHRoaXM7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFBvb2w7Cn0seyIuL3Byb21pc2UiOjEwMywiZ2VuZXJpYy1wb29sLXJlZHV4IjoxMTksImxvZGFzaCI6MTMwfV0sMTAzOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZC9qcy9tYWluL3Byb21pc2UnKSgpOwoKUHJvbWlzZS5wcm90b3R5cGUueWllbGQgICAgID0gUHJvbWlzZS5wcm90b3R5cGUudGhlblJldHVybjsKUHJvbWlzZS5wcm90b3R5cGUuZW5zdXJlICAgID0gUHJvbWlzZS5wcm90b3R5cGUubGFzdGx5OwpQcm9taXNlLnByb3RvdHlwZS5vdGhlcndpc2UgPSBQcm9taXNlLnByb3RvdHlwZS5jYXVnaHQ7ClByb21pc2UucHJvdG90eXBlLmV4ZWMgICAgICA9IFByb21pc2UucHJvdG90eXBlLm5vZGVpZnk7Cgptb2R1bGUuZXhwb3J0cyA9IFByb21pc2U7Cgp9LHsiYmx1ZWJpcmQvanMvbWFpbi9wcm9taXNlIjozNX1dLDEwNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIEJ1aWxkZXIKLy8gLS0tLS0tLQp2YXIgXyAgICAgICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBpbmhlcml0cyAgICAgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKdmFyIFJhdyAgICAgICAgICA9IHJlcXVpcmUoJy4uL3JhdycpOwp2YXIgaGVscGVycyAgICAgID0gcmVxdWlyZSgnLi4vaGVscGVycycpOwoKdmFyIEpvaW5DbGF1c2UgID0gcmVxdWlyZSgnLi9qb2luY2xhdXNlJyk7CgovLyBUeXBpY2FsbHkgY2FsbGVkIGZyb20gYGtuZXguYnVpbGRlcmAsCi8vIHN0YXJ0IGEgbmV3IHF1ZXJ5IGJ1aWxkaW5nIGNoYWluLgpmdW5jdGlvbiBRdWVyeUJ1aWxkZXIoKSB7CiAgdGhpcy5fc2luZ2xlICAgICA9IHt9OwogIHRoaXMuX3N0YXRlbWVudHMgPSBbXTsKICB0aGlzLl9lcnJvcnMgICAgID0gW107CgogIC8vIEludGVybmFsIGZsYWdzIHVzZWQgaW4gdGhlIGJ1aWxkZXIuCiAgdGhpcy5fam9pbkZsYWcgID0gJ2lubmVyJzsKICB0aGlzLl9ib29sRmxhZyAgPSAnYW5kJzsKICB0aGlzLl9ub3RGbGFnICAgPSBmYWxzZTsKCiAgdGhpcy5hbmQgPSB0aGlzOwp9CmluaGVyaXRzKFF1ZXJ5QnVpbGRlciwgRXZlbnRFbWl0dGVyKTsKClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy50b1F1ZXJ5KCk7Cn07CgovLyBDb252ZXJ0IHRoZSBjdXJyZW50IHF1ZXJ5ICJ0b1NRTCIKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHZhciBRdWVyeUNvbXBpbGVyID0gdGhpcy5jbGllbnQuUXVlcnlDb21waWxlcjsKICByZXR1cm4gbmV3IFF1ZXJ5Q29tcGlsZXIodGhpcykudG9TUUwodGhpcy5fbWV0aG9kIHx8ICdzZWxlY3QnKTsKfTsKCi8vIENyZWF0ZSBhIHNoYWxsb3cgY2xvbmUgb2YgdGhlIGN1cnJlbnQgcXVlcnkgYnVpbGRlci4KLy8gVE9ETzogVGVzdCB0aGlzISEKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkgewogIHZhciBjbG9uZWQgICAgICAgICAgICA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCk7CiAgICBjbG9uZWQuX21ldGhvZCAgICAgID0gdGhpcy5fbWV0aG9kOwogICAgY2xvbmVkLl9zaW5nbGUgICAgICA9IF8uY2xvbmUodGhpcy5fc2luZ2xlKTsKICAgIGNsb25lZC5fb3B0aW9ucyAgICAgPSBfLmNsb25lKHRoaXMuX29wdGlvbnMpOwogICAgY2xvbmVkLl9zdGF0ZW1lbnRzICA9IHRoaXMuX3N0YXRlbWVudHMuc2xpY2UoKTsKICAgIGNsb25lZC5fZXJyb3JzICAgICAgPSB0aGlzLl9lcnJvcnMuc2xpY2UoKTsKICAgIGNsb25lZC5fZGVidWcgICAgICAgPSB0aGlzLl9kZWJ1ZzsKICAgIGNsb25lZC5fdHJhbnNhY3RpbmcgPSB0aGlzLl90cmFuc2FjdGluZzsKICAgIGNsb25lZC5fY29ubmVjdGlvbiAgPSB0aGlzLl9jb25uZWN0aW9uOwogIHJldHVybiBjbG9uZWQ7Cn07CgovLyBTZWxlY3QKLy8gLS0tLS0tCgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGEgYHNlbGVjdGAgcXVlcnksCi8vIHdoaWNoIGlzIHRoZSBzYW1lIGFzIHNwZWNpZnlpbmcgdGhlIGNvbHVtbnMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuc2VsZWN0ID0KCi8vIEFkZHMgYSBjb2x1bW4gb3IgY29sdW1ucyB0byB0aGUgbGlzdCBvZiAiY29sdW1ucyIKLy8gYmVpbmcgc2VsZWN0ZWQgb24gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbnMgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbiA9IGZ1bmN0aW9uKGNvbHVtbikgewogIGlmICghY29sdW1uKSByZXR1cm4gdGhpczsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdjb2x1bW5zJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBbGxvdyBmb3IgYSBzdWItc2VsZWN0IHRvIGJlIGV4cGxpY2l0bHkgYWxpYXNlZCBhcyBhIGNvbHVtbiwKLy8gd2l0aG91dCBuZWVkaW5nIHRvIGNvbXBpbGUgdGhlIHF1ZXJ5IGluIGEgd2hlcmUuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuYXMgPSBmdW5jdGlvbihjb2x1bW4pIHsKICB0aGlzLl9zaW5nbGUuYXMgPSBjb2x1bW47CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXRzIHRoZSBgdGFibGVOYW1lYCBvbiB0aGUgcXVlcnkuCi8vIEFsaWFzIHRvICJmcm9tIiBmb3Igc2VsZWN0IGFuZCAiaW50byIgZm9yIGluc2VydCBzdGF0ZW1lbnRzCi8vIGUuZy4gYnVpbGRlci5pbnNlcnQoe2E6IHZhbHVlfSkuaW50bygndGFibGVOYW1lJykKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHRoaXMuX3NpbmdsZS50YWJsZSA9IHRhYmxlTmFtZTsKICByZXR1cm4gdGhpczsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mcm9tID0gUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5pbnRvID0gUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50YWJsZTsKCi8vIEFkZHMgYSBgZGlzdGluY3RgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZGlzdGluY3QgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdjb2x1bW5zJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpLAogICAgZGlzdGluY3Q6IHRydWUKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBqb2luIGNsYXVzZSB0byB0aGUgcXVlcnksIGFsbG93aW5nIGZvciBhZHZhbmNlZCBqb2lucwovLyB3aXRoIGFuIGFub255bW91cyBmdW5jdGlvbiBhcyB0aGUgc2Vjb25kIGFyZ3VtZW50LgovLyBmdW5jdGlvbih0YWJsZSwgZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmQpClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuam9pbiA9IGZ1bmN0aW9uKHRhYmxlLCBmaXJzdCkgewogIHZhciBqb2luOwogIHZhciBqb2luVHlwZSA9IHRoaXMuX2pvaW5UeXBlKCk7CiAgaWYgKF8uaXNGdW5jdGlvbihmaXJzdCkpIHsKICAgIGpvaW4gPSBuZXcgSm9pbkNsYXVzZSh0YWJsZSwgam9pblR5cGUpOwogICAgZmlyc3QuY2FsbChqb2luLCBqb2luKTsKICB9IGVsc2UgaWYgKGpvaW5UeXBlID09PSAncmF3JykgewogICAgam9pbiA9IG5ldyBKb2luQ2xhdXNlKG5ldyBSYXcodGFibGUsIGZpcnN0KSwgJ3JhdycpOwogIH0gZWxzZSB7CiAgICBqb2luID0gbmV3IEpvaW5DbGF1c2UodGFibGUsIGpvaW5UeXBlKTsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICBqb2luLm9uLmFwcGx5KGpvaW4sIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpKTsKICAgIH0KICB9CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKGpvaW4pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gSk9JTiBibG9ja3M6ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaW5uZXJKb2luID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2pvaW5UeXBlKCdpbm5lcicpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5sZWZ0Sm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnbGVmdCcpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5sZWZ0T3V0ZXJKb2luID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2pvaW5UeXBlKCdsZWZ0IG91dGVyJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLnJpZ2h0Sm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgncmlnaHQnKS5qb2luLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUucmlnaHRPdXRlckpvaW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ3JpZ2h0IG91dGVyJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm91dGVySm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnb3V0ZXInKS5qb2luLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZnVsbE91dGVySm9pbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9qb2luVHlwZSgnZnVsbCBvdXRlcicpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5jcm9zc0pvaW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ2Nyb3NzJykuam9pbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmpvaW5SYXcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fam9pblR5cGUoJ3JhdycpLmpvaW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCi8vIFRoZSB3aGVyZSBmdW5jdGlvbiBjYW4gYmUgdXNlZCBpbiBzZXZlcmFsIHdheXM6Ci8vIFRoZSBtb3N0IGJhc2ljIGlzIGB3aGVyZShrZXksIHZhbHVlKWAsIHdoaWNoIGV4cGFuZHMgdG8KLy8gd2hlcmUga2V5ID0gdmFsdWUuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmUgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZFdoZXJlID0gZnVuY3Rpb24oY29sdW1uLCBvcGVyYXRvciwgdmFsdWUpIHsKCiAgLy8gU3VwcG9ydCAid2hlcmUgdHJ1ZSB8fCB3aGVyZSBmYWxzZSIKICBpZiAoY29sdW1uID09PSBmYWxzZSB8fCBjb2x1bW4gPT09IHRydWUpIHsKICAgIHJldHVybiB0aGlzLndoZXJlUmF3KGNvbHVtbik7CiAgfQoKICAvLyBDaGVjayBpZiB0aGUgY29sdW1uIGlzIGEgZnVuY3Rpb24sIGluIHdoaWNoIGNhc2UgaXQncwogIC8vIGEgd2hlcmUgc3RhdGVtZW50IHdyYXBwZWQgaW4gcGFyZW5zLgogIGlmIChfLmlzRnVuY3Rpb24oY29sdW1uKSkgewogICAgcmV0dXJuIHRoaXMud2hlcmVXcmFwcGVkKGNvbHVtbik7CiAgfQoKICAvLyBBbGxvdyBhIHJhdyBzdGF0ZW1lbnQgdG8gYmUgcGFzc2VkIGFsb25nIHRvIHRoZSBxdWVyeS4KICBpZiAoY29sdW1uIGluc3RhbmNlb2YgUmF3KSByZXR1cm4gdGhpcy53aGVyZVJhdyhjb2x1bW4pOwoKICAvLyBBbGxvd3MgYHdoZXJlKHtpZDogMn0pYCBzeW50YXguCiAgaWYgKF8uaXNPYmplY3QoY29sdW1uKSkgcmV0dXJuIHRoaXMuX29iamVjdFdoZXJlKGNvbHVtbik7CgogIC8vIEVuYWJsZSB0aGUgd2hlcmUoJ2tleScsIHZhbHVlKSBzeW50YXgsIG9ubHkgd2hlbiB0aGVyZQogIC8vIGFyZSBleHBsaWNpdGx5IHR3byBhcmd1bWVudHMgcGFzc2VkLCBzbyBpdCdzIG5vdCBwb3NzaWJsZSB0bwogIC8vIGRvIHdoZXJlKCdrZXknLCAnIT0nKSBhbmQgaGF2ZSB0aGF0IHR1cm4gaW50byB3aGVyZSBrZXkgIT0gbnVsbAogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICB2YWx1ZSAgICA9IG9wZXJhdG9yOwogICAgb3BlcmF0b3IgPSAnPSc7CgogICAgLy8gSWYgdGhlIHZhbHVlIGlzIG51bGwsIGFuZCBpdCdzIGEgdHdvIGFyZ3VtZW50IHF1ZXJ5LAogICAgLy8gd2UgYXNzdW1lIHdlJ3JlIGdvaW5nIGZvciBhIGB3aGVyZU51bGxgLgogICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlTnVsbChjb2x1bW4pOwogICAgfQogIH0KCiAgLy8gbG93ZXIgY2FzZSB0aGUgb3BlcmF0b3IgZm9yIGNvbXBhcmlzb24gcHVycG9zZXMKICB2YXIgY2hlY2tPcGVyYXRvciA9ICgnJyArIG9wZXJhdG9yKS50b0xvd2VyQ2FzZSgpLnRyaW0oKTsKCiAgLy8gSWYgdGhlcmUgYXJlIDMgYXJndW1lbnRzLCBjaGVjayB3aGV0aGVyICdpbicgaXMgb25lIG9mIHRoZW0uCiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMpIHsKICAgIGlmIChjaGVja09wZXJhdG9yID09PSAnaW4nIHx8IGNoZWNrT3BlcmF0b3IgPT09ICdub3QgaW4nKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3QoY2hlY2tPcGVyYXRvciA9PT0gJ25vdCBpbicpLndoZXJlSW4oYXJndW1lbnRzWzBdLCBhcmd1bWVudHNbMl0pOwogICAgfQogICAgaWYgKGNoZWNrT3BlcmF0b3IgPT09ICdiZXR3ZWVuJyB8fCBjaGVja09wZXJhdG9yID09PSAnbm90IGJldHdlZW4nKSB7CiAgICAgIHJldHVybiB0aGlzLl9ub3QoY2hlY2tPcGVyYXRvciA9PT0gJ25vdCBiZXR3ZWVuJykud2hlcmVCZXR3ZWVuKGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzJdKTsKICAgIH0KICB9CgogIC8vIElmIHRoZSB2YWx1ZSBpcyBzdGlsbCBudWxsLCBjaGVjayB3aGV0aGVyIHRoZXkncmUgbWVhbmluZwogIC8vIHdoZXJlIHZhbHVlIGlzIG51bGwKICBpZiAodmFsdWUgPT09IG51bGwpIHsKCiAgICAvLyBDaGVjayBmb3IgLndoZXJlKGtleSwgJ2lzJywgbnVsbCkgb3IgLndoZXJlKGtleSwgJ2lzIG5vdCcsICdudWxsJyk7CiAgICBpZiAoY2hlY2tPcGVyYXRvciA9PT0gJ2lzJyB8fCBjaGVja09wZXJhdG9yID09PSAnaXMgbm90JykgewogICAgICByZXR1cm4gdGhpcy5fbm90KGNoZWNrT3BlcmF0b3IgPT09ICdpcyBub3QnKS53aGVyZU51bGwoY29sdW1uKTsKICAgIH0KICB9CgogIC8vIFB1c2ggb250byB0aGUgd2hlcmUgc3RhdGVtZW50IHN0YWNrLgogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZUJhc2ljJywKICAgIGNvbHVtbjogY29sdW1uLAogICAgb3BlcmF0b3I6IG9wZXJhdG9yLAogICAgdmFsdWU6IHZhbHVlLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07Ci8vIEFkZHMgYW4gYG9yIHdoZXJlYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9yV2hlcmUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKLy8gUHJvY2Vzc2VzIGFuIG9iamVjdCBsaXRlcmFsIHByb3ZpZGVkIGluIGEgIndoZXJlIiBjbGF1c2UuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX29iamVjdFdoZXJlID0gZnVuY3Rpb24ob2JqKSB7CiAgdmFyIGJvb2xWYWwgPSB0aGlzLl9ib29sKCk7CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgdGhpc1tib29sVmFsICsgJ1doZXJlJ10oa2V5LCBvYmpba2V5XSk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkcyBhIHJhdyBgd2hlcmVgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmVSYXcgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZFdoZXJlUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlUmF3JywKICAgIHZhbHVlOiByYXcsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlUmF3KHNxbCwgYmluZGluZ3MpOwp9OwoKLy8gSGVscGVyIGZvciBjb21waWxpbmcgYW55IGFkdmFuY2VkIGB3aGVyZWAgcXVlcmllcy4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZVdyYXBwZWQgPSBmdW5jdGlvbihjYWxsYmFjaykgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZVdyYXBwZWQnLAogICAgdmFsdWU6IGNhbGxiYWNrLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYHdoZXJlIGV4aXN0c2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZUV4aXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlRXhpc3RzJywKICAgIHZhbHVlOiBjYWxsYmFjaywKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCksCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGFuIGBvciB3aGVyZSBleGlzdHNgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JXaGVyZUV4aXN0cyA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykud2hlcmVFeGlzdHMoY2FsbGJhY2spOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBub3QgZXhpc3RzYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90RXhpc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICByZXR1cm4gdGhpcy5fbm90KHRydWUpLndoZXJlRXhpc3RzKGNhbGxiYWNrKTsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgbm90IGV4aXN0c2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90RXhpc3RzID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZU5vdEV4aXN0cyhjYWxsYmFjayk7Cn07CgovLyBBZGRzIGEgYHdoZXJlIGluYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlSW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIGlmIChfLmlzQXJyYXkodmFsdWVzKSAmJiBfLmlzRW1wdHkodmFsdWVzKSkgcmV0dXJuIHRoaXMud2hlcmUodGhpcy5fbm90KCkpOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3doZXJlJywKICAgIHR5cGU6ICd3aGVyZUluJywKICAgIGNvbHVtbjogY29sdW1uLAogICAgdmFsdWU6IHZhbHVlcywKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgaW5gIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JXaGVyZUluID0gZnVuY3Rpb24oY29sdW1uLCB2YWx1ZXMpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZUluKGNvbHVtbiwgdmFsdWVzKTsKfTsKCi8vIEFkZHMgYSBgd2hlcmUgbm90IGluYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90SW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIHJldHVybiB0aGlzLl9ub3QodHJ1ZSkud2hlcmVJbihjb2x1bW4sIHZhbHVlcyk7Cn07CgovLyBBZGRzIGEgYG9yIHdoZXJlIG5vdCBpbmAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90SW4gPSBmdW5jdGlvbihjb2x1bW4sIHZhbHVlcykgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLl9ub3QodHJ1ZSkud2hlcmVJbihjb2x1bW4sIHZhbHVlcyk7Cn07CgovLyBBZGRzIGEgYHdoZXJlIG51bGxgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUud2hlcmVOdWxsID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlTnVsbCcsCiAgICBjb2x1bW46IGNvbHVtbiwKICAgIG5vdDogdGhpcy5fbm90KCksCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSBgb3Igd2hlcmUgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTnVsbCA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlTnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBub3QgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS53aGVyZU5vdE51bGwgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fbm90KHRydWUpLndoZXJlTnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBub3QgbnVsbGAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90TnVsbCA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHJldHVybiB0aGlzLl9ib29sKCdvcicpLndoZXJlTm90TnVsbChjb2x1bW4pOwp9OwoKLy8gQWRkcyBhIGB3aGVyZSBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlQmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgaWYgKCFfLmlzQXJyYXkodmFsdWVzKSkgewogICAgcmV0dXJuIHRoaXMuX2Vycm9ycy5wdXNoKG5ldyBFcnJvcignVGhlIHNlY29uZCBhcmd1bWVudCB0byB3aGVyZUJldHdlZW4gbXVzdCBiZSBhbiBhcnJheS4nKSk7CiAgfQogIGlmICh2YWx1ZXMubGVuZ3RoICE9PSAyKSB7CiAgICByZXR1cm4gdGhpcy5fZXJyb3JzLnB1c2gobmV3IEVycm9yKCdZb3UgbXVzdCBzcGVjaWZ5IDIgdmFsdWVzIGZvciB0aGUgd2hlcmVCZXR3ZWVuIGNsYXVzZScpKTsKICB9CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnd2hlcmUnLAogICAgdHlwZTogJ3doZXJlQmV0d2VlbicsCiAgICBjb2x1bW46IGNvbHVtbiwKICAgIHZhbHVlOiB2YWx1ZXMsCiAgICBub3Q6IHRoaXMuX25vdCgpLAogICAgYm9vbDogdGhpcy5fYm9vbCgpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYHdoZXJlIG5vdCBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLndoZXJlTm90QmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgcmV0dXJuIHRoaXMuX25vdCh0cnVlKS53aGVyZUJldHdlZW4oY29sdW1uLCB2YWx1ZXMpOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBiZXR3ZWVuYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9yV2hlcmVCZXR3ZWVuID0gZnVuY3Rpb24oY29sdW1uLCB2YWx1ZXMpIHsKICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKS53aGVyZUJldHdlZW4oY29sdW1uLCB2YWx1ZXMpOwp9OwoKLy8gQWRkcyBhIGBvciB3aGVyZSBub3QgYmV0d2VlbmAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcldoZXJlTm90QmV0d2VlbiA9IGZ1bmN0aW9uKGNvbHVtbiwgdmFsdWVzKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykud2hlcmVOb3RCZXR3ZWVuKGNvbHVtbiwgdmFsdWVzKTsKfTsKCi8vIEFkZHMgYSBgZ3JvdXAgYnlgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZ3JvdXBCeSA9IGZ1bmN0aW9uKGl0ZW0pIHsKICBpZiAoaXRlbSBpbnN0YW5jZW9mIFJhdykgewogICAgcmV0dXJuIHRoaXMuZ3JvdXBCeVJhdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0KICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdncm91cCcsCiAgICB0eXBlOiAnZ3JvdXBCeUJhc2ljJywKICAgIHZhbHVlOiBoZWxwZXJzLm5vcm1hbGl6ZUFyci5hcHBseShudWxsLCBhcmd1bWVudHMpCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgcmF3IGBncm91cCBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5ncm91cEJ5UmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnZ3JvdXAnLAogICAgdHlwZTogJ2dyb3VwQnlSYXcnLAogICAgdmFsdWU6IHJhdwogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkcyBhIGBvcmRlciBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcmRlckJ5ID0gZnVuY3Rpb24oY29sdW1uLCBkaXJlY3Rpb24pIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdvcmRlcicsCiAgICB0eXBlOiAnb3JkZXJCeUJhc2ljJywKICAgIHZhbHVlOiBjb2x1bW4sCiAgICBkaXJlY3Rpb246IGRpcmVjdGlvbgogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkIGEgcmF3IGBvcmRlciBieWAgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vcmRlckJ5UmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHZhciByYXcgPSAoc3FsIGluc3RhbmNlb2YgUmF3ID8gc3FsIDogbmV3IFJhdyhzcWwsIGJpbmRpbmdzKSk7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnb3JkZXInLAogICAgdHlwZTogJ29yZGVyQnlSYXcnLAogICAgdmFsdWU6IHJhdwogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWRkIGEgdW5pb24gc3RhdGVtZW50IHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS51bmlvbiA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB3cmFwKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICB2YXIgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gYXJncy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgdGhpcy51bmlvbihhcmdzW2ldKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICd1bmlvbicsCiAgICBjbGF1c2U6ICd1bmlvbicsCiAgICB2YWx1ZTogY2FsbGJhY2ssCiAgICB3cmFwOiB3cmFwIHx8IGZhbHNlCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgdW5pb24gYWxsIHN0YXRlbWVudCB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudW5pb25BbGwgPSBmdW5jdGlvbihjYWxsYmFjaywgd3JhcCkgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ3VuaW9uJywKICAgIGNsYXVzZTogJ3VuaW9uIGFsbCcsCiAgICB2YWx1ZTogY2FsbGJhY2ssCiAgICB3cmFwOiB3cmFwIHx8IGZhbHNlCiAgfSk7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBBZGRzIGEgYGhhdmluZ2AgY2xhdXNlIHRvIHRoZSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5oYXZpbmcgPQpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmFuZEhhdmluZyA9IGZ1bmN0aW9uKGNvbHVtbiwgb3BlcmF0b3IsIHZhbHVlKSB7CiAgaWYgKGNvbHVtbiBpbnN0YW5jZW9mIFJhdyAmJiBhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gdGhpcy5faGF2aW5nUmF3KGNvbHVtbik7CiAgfQogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2hhdmluZycsCiAgICB0eXBlOiAnaGF2aW5nQmFzaWMnLAogICAgY29sdW1uOiBjb2x1bW4sCiAgICBvcGVyYXRvcjogb3BlcmF0b3IsCiAgICB2YWx1ZTogdmFsdWUsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKLy8gQWRkcyBhbiBgb3IgaGF2aW5nYCBjbGF1c2UgdG8gdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLm9ySGF2aW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykuaGF2aW5nLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaGF2aW5nUmF3ID0gZnVuY3Rpb24oc3FsLCBiaW5kaW5ncykgewogIHJldHVybiB0aGlzLl9oYXZpbmdSYXcoc3FsLCBiaW5kaW5ncyk7Cn07ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUub3JIYXZpbmdSYXcgPSBmdW5jdGlvbihzcWwsIGJpbmRpbmdzKSB7CiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykuaGF2aW5nUmF3KHNxbCwgYmluZGluZ3MpOwp9OwovLyBBZGRzIGEgcmF3IGBoYXZpbmdgIGNsYXVzZSB0byB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX2hhdmluZ1JhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICB2YXIgcmF3ID0gKHNxbCBpbnN0YW5jZW9mIFJhdyA/IHNxbCA6IG5ldyBSYXcoc3FsLCBiaW5kaW5ncykpOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2hhdmluZycsCiAgICB0eXBlOiAnaGF2aW5nUmF3JywKICAgIHZhbHVlOiByYXcsCiAgICBib29sOiB0aGlzLl9ib29sKCkKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIE9ubHkgYWxsb3cgYSBzaW5nbGUgIm9mZnNldCIgdG8gYmUgc2V0IGZvciB0aGUgY3VycmVudCBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5vZmZzZXQgPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMuX3NpbmdsZS5vZmZzZXQgPSB2YWx1ZTsKICByZXR1cm4gdGhpczsKfTsKCi8vIE9ubHkgYWxsb3cgYSBzaW5nbGUgImxpbWl0IiB0byBiZSBzZXQgZm9yIHRoZSBjdXJyZW50IHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmxpbWl0ID0gZnVuY3Rpb24odmFsdWUpIHsKICB0aGlzLl9zaW5nbGUubGltaXQgPSB2YWx1ZTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFJldHJpZXZlIHRoZSAiY291bnQiIHJlc3VsdCBvZiB0aGUgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuY291bnQgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdjb3VudCcsIChjb2x1bW4gfHwgJyonKSk7Cn07CgovLyBSZXRyaWV2ZSB0aGUgbWluaW11bSB2YWx1ZSBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5taW4gPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdtaW4nLCBjb2x1bW4pOwp9OwoKLy8gUmV0cmlldmUgdGhlIG1heGltdW0gdmFsdWUgb2YgYSBnaXZlbiBjb2x1bW4uClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUubWF4ID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgcmV0dXJuIHRoaXMuX2FnZ3JlZ2F0ZSgnbWF4JywgY29sdW1uKTsKfTsKCi8vIFJldHJpZXZlIHRoZSBzdW0gb2YgdGhlIHZhbHVlcyBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5zdW0gPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdzdW0nLCBjb2x1bW4pOwp9OwoKLy8gUmV0cmlldmUgdGhlIGF2ZXJhZ2Ugb2YgdGhlIHZhbHVlcyBvZiBhIGdpdmVuIGNvbHVtbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5hdmcgPSBmdW5jdGlvbihjb2x1bW4pIHsKICByZXR1cm4gdGhpcy5fYWdncmVnYXRlKCdhdmcnLCBjb2x1bW4pOwp9OwoKLy8gSW5jcmVtZW50cyBhIGNvbHVtbidzIHZhbHVlIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmluY3JlbWVudCA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50KSB7CiAgcmV0dXJuIHRoaXMuX2NvdW50ZXIoY29sdW1uLCBhbW91bnQpOwp9OwoKLy8gRGVjcmVtZW50cyBhIGNvbHVtbidzIHZhbHVlIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmRlY3JlbWVudCA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50KSB7CiAgcmV0dXJuIHRoaXMuX2NvdW50ZXIoY29sdW1uLCBhbW91bnQsICctJyk7Cn07CgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGEgYHNlbGVjdGAgcXVlcnksIGluZm9ybWluZyB0aGF0IG9ubHkgdGhlIGZpcnN0Ci8vIHJvdyBzaG91bGQgYmUgcmV0dXJuZWQgKGxpbWl0IDEpLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmZpcnN0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIGksIGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCk7CiAgZm9yIChpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbaV07CiAgfQogIHRoaXMuc2VsZWN0LmFwcGx5KHRoaXMsIGFyZ3MpOwogIHRoaXMuX21ldGhvZCA9ICdmaXJzdCc7CiAgdGhpcy5saW1pdCgxKTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFBsdWNrIGEgY29sdW1uIGZyb20gYSBxdWVyeS4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5wbHVjayA9IGZ1bmN0aW9uKGNvbHVtbikgewogIHRoaXMuX21ldGhvZCA9ICdwbHVjayc7CiAgdGhpcy5fc2luZ2xlLnBsdWNrID0gY29sdW1uOwogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2NvbHVtbnMnLAogICAgdHlwZTogJ3BsdWNrJywKICAgIHZhbHVlOiBjb2x1bW4KICB9KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEluc2VydCAmIFVwZGF0ZQovLyAtLS0tLS0KCi8vIFNldHMgdGhlIHZhbHVlcyBmb3IgYW4gYGluc2VydGAgcXVlcnkuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuaW5zZXJ0ID0gZnVuY3Rpb24odmFsdWVzLCByZXR1cm5pbmcpIHsKICB0aGlzLl9tZXRob2QgPSAnaW5zZXJ0JzsKICBpZiAoIV8uaXNFbXB0eShyZXR1cm5pbmcpKSB0aGlzLnJldHVybmluZyhyZXR1cm5pbmcpOwogIHRoaXMuX3NpbmdsZS5pbnNlcnQgPSB2YWx1ZXM7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXRzIHRoZSB2YWx1ZXMgZm9yIGFuIGB1cGRhdGVgLCBhbGxvd2luZyBmb3IgYm90aAovLyBgLnVwZGF0ZShrZXksIHZhbHVlLCBbcmV0dXJuaW5nXSlgIGFuZCBgLnVwZGF0ZShvYmosIFtyZXR1cm5pbmddKWAgc3ludGF4ZXMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24odmFsdWVzLCByZXR1cm5pbmcpIHsKICB2YXIgcmV0LCBvYmogPSB7fTsKICB0aGlzLl9tZXRob2QgPSAndXBkYXRlJzsKICB2YXIgaSwgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTsKICBmb3IgKGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTsKICB9CiAgaWYgKF8uaXNTdHJpbmcodmFsdWVzKSkgewogICAgb2JqW3ZhbHVlc10gPSByZXR1cm5pbmc7CiAgICBpZiAoYXJncy5sZW5ndGggPiAyKSB7CiAgICAgIHJldCA9IGFyZ3NbMl07CiAgICB9CiAgfSBlbHNlIHsKICAgIG9iaiA9IHZhbHVlczsKICAgIHJldCA9IGFyZ3NbMV07CiAgfQogIGlmICghXy5pc0VtcHR5KHJldCkpIHRoaXMucmV0dXJuaW5nKHJldCk7CiAgdGhpcy5fc2luZ2xlLnVwZGF0ZSA9IG9iajsKICByZXR1cm4gdGhpczsKfTsKCi8vIFNldHMgdGhlIHJldHVybmluZyB2YWx1ZSBmb3IgdGhlIHF1ZXJ5LgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLnJldHVybmluZyA9IGZ1bmN0aW9uKHJldHVybmluZykgewogIHRoaXMuX3NpbmdsZS5yZXR1cm5pbmcgPSByZXR1cm5pbmc7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBEZWxldGUKLy8gLS0tLS0tCgovLyBFeGVjdXRlcyBhIGRlbGV0ZSBzdGF0ZW1lbnQgb24gdGhlIHF1ZXJ5OwpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmRlbCA9ClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuZGVsZXRlID0gZnVuY3Rpb24ocmV0KSB7CiAgdGhpcy5fbWV0aG9kID0gJ2RlbCc7CiAgaWYgKCFfLmlzRW1wdHkocmV0KSkgdGhpcy5yZXR1cm5pbmcocmV0KTsKICByZXR1cm4gdGhpczsKfTsKCi8vIFRydW5jYXRlcyBhIHRhYmxlLCBlbmRzIHRoZSBxdWVyeSBjaGFpbi4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuX21ldGhvZCA9ICd0cnVuY2F0ZSc7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBSZXRyaWV2ZXMgY29sdW1ucyBmb3IgdGhlIHRhYmxlIHNwZWNpZmllZCBieSBga25leCh0YWJsZU5hbWUpYApRdWVyeUJ1aWxkZXIucHJvdG90eXBlLmNvbHVtbkluZm8gPSBmdW5jdGlvbihjb2x1bW4pIHsKICB0aGlzLl9tZXRob2QgPSAnY29sdW1uSW5mbyc7CiAgdGhpcy5fc2luZ2xlLmNvbHVtbkluZm8gPSBjb2x1bW47CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBTZXQgYSBsb2NrIGZvciB1cGRhdGUgY29uc3RyYWludC4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mb3JVcGRhdGUgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zaW5nbGUubG9jayA9ICdmb3JVcGRhdGUnOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU2V0IGEgbG9jayBmb3Igc2hhcmUgY29uc3RyYWludC4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5mb3JTaGFyZSA9IGZ1bmN0aW9uKCkgewogIHRoaXMuX3NpbmdsZS5sb2NrID0gJ2ZvclNoYXJlJzsKICByZXR1cm4gdGhpczsKfTsKCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIEhlbHBlciBmb3IgdGhlIGluY3JlbWVudGluZy9kZWNyZW1lbnRpbmcgcXVlcmllcy4KUXVlcnlCdWlsZGVyLnByb3RvdHlwZS5fY291bnRlciA9IGZ1bmN0aW9uKGNvbHVtbiwgYW1vdW50LCBzeW1ib2wpIHsKICB2YXIgYW10ID0gcGFyc2VJbnQoYW1vdW50LCAxMCk7CiAgaWYgKGlzTmFOKGFtdCkpIGFtdCA9IDE7CiAgdGhpcy5fbWV0aG9kID0gJ2NvdW50ZXInOwogIHRoaXMuX3NpbmdsZS5jb3VudGVyID0gewogICAgY29sdW1uOiBjb2x1bW4sCiAgICBhbW91bnQ6IGFtdCwKICAgIHN5bWJvbDogKHN5bWJvbCB8fCAnKycpCiAgfTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEhlbHBlciB0byBnZXQgb3Igc2V0IHRoZSAiYm9vbEZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9ib29sID0gZnVuY3Rpb24odmFsKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHRoaXMuX2Jvb2xGbGFnID0gdmFsOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHZhciByZXQgPSB0aGlzLl9ib29sRmxhZzsKICB0aGlzLl9ib29sRmxhZyA9ICdhbmQnOwogIHJldHVybiByZXQ7Cn07CgovLyBIZWxwZXIgdG8gZ2V0IG9yIHNldCB0aGUgIm5vdEZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9ub3QgPSBmdW5jdGlvbih2YWwpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdGhpcy5fbm90RmxhZyA9IHZhbDsKICAgIHJldHVybiB0aGlzOwogIH0KICB2YXIgcmV0ID0gdGhpcy5fbm90RmxhZzsKICB0aGlzLl9ub3RGbGFnID0gZmFsc2U7CiAgcmV0dXJuIHJldDsKfTsKCi8vIEhlbHBlciB0byBnZXQgb3Igc2V0IHRoZSAiam9pbkZsYWciIHZhbHVlLgpRdWVyeUJ1aWxkZXIucHJvdG90eXBlLl9qb2luVHlwZSA9IGZ1bmN0aW9uICh2YWwpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgdGhpcy5fam9pbkZsYWcgPSB2YWw7CiAgICByZXR1cm4gdGhpczsKICB9CiAgdmFyIHJldCA9IHRoaXMuX2pvaW5GbGFnIHx8ICdpbm5lcic7CiAgdGhpcy5fam9pbkZsYWcgPSAnaW5uZXInOwogIHJldHVybiByZXQ7Cn07CgovLyBIZWxwZXIgZm9yIGNvbXBpbGluZyBhbnkgYWdncmVnYXRlIHF1ZXJpZXMuClF1ZXJ5QnVpbGRlci5wcm90b3R5cGUuX2FnZ3JlZ2F0ZSA9IGZ1bmN0aW9uKG1ldGhvZCwgY29sdW1uKSB7CiAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgIGdyb3VwaW5nOiAnY29sdW1ucycsCiAgICB0eXBlOiAnYWdncmVnYXRlJywKICAgIG1ldGhvZDogbWV0aG9kLAogICAgdmFsdWU6IGNvbHVtbgogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFF1ZXJ5QnVpbGRlci5wcm90b3R5cGUsICdvcicsIHsKICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9ib29sKCdvcicpOwogIH0KfSk7CgoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFF1ZXJ5QnVpbGRlci5wcm90b3R5cGUsICdub3QnLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fbm90KHRydWUpOwogIH0KfSk7CgovLyBBdHRhY2ggYWxsIG9mIHRoZSB0b3AgbGV2ZWwgcHJvbWlzZSBtZXRob2RzIHRoYXQgc2hvdWxkIGJlIGNoYWluYWJsZS4KcmVxdWlyZSgnLi4vaW50ZXJmYWNlJykoUXVlcnlCdWlsZGVyKTsKCm1vZHVsZS5leHBvcnRzID0gUXVlcnlCdWlsZGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCIuLi9pbnRlcmZhY2UiOjEwMCwiLi4vcmF3IjoxMDgsIi4vam9pbmNsYXVzZSI6MTA2LCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTA1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gUXVlcnkgQ29tcGlsZXIKLy8gLS0tLS0tLQoKdmFyIF8gICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuLi9oZWxwZXJzJyk7CnZhciBSYXcgICAgID0gcmVxdWlyZSgnLi4vcmF3Jyk7CgovLyBUaGUgIlF1ZXJ5Q29tcGlsZXIiIHRha2VzIGFsbCBvZiB0aGUgcXVlcnkgc3RhdGVtZW50cyB3aGljaCBoYXZlIGJlZW4KLy8gZ2F0aGVyZWQgaW4gdGhlICJRdWVyeUJ1aWxkZXIiIGFuZCB0dXJucyB0aGVtIGludG8gYSBwcm9wZXJseSBmb3JtYXR0ZWQgLyBib3VuZAovLyBxdWVyeSBzdHJpbmcuCmZ1bmN0aW9uIFF1ZXJ5Q29tcGlsZXIocXVlcnlCdWlsZGVyKSB7CiAgdGhpcy5tZXRob2QgICAgICA9IHF1ZXJ5QnVpbGRlci5fbWV0aG9kIHx8ICdzZWxlY3QnOwogIHRoaXMub3B0aW9ucyAgICAgPSBxdWVyeUJ1aWxkZXIuX29wdGlvbnM7CiAgdGhpcy5zaW5nbGUgICAgICA9IHF1ZXJ5QnVpbGRlci5fc2luZ2xlOwogIHRoaXMudHJhbnNhY3RpbmcgPSBxdWVyeUJ1aWxkZXIuX3RyYW5zYWN0aW5nOwogIHRoaXMuZ3JvdXBlZCAgICAgPSBfLmdyb3VwQnkocXVlcnlCdWlsZGVyLl9zdGF0ZW1lbnRzLCAnZ3JvdXBpbmcnKTsKICB0aGlzLnRhYmxlTmFtZSAgID0gdGhpcy5zaW5nbGUudGFibGUgPyB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMuc2luZ2xlLnRhYmxlKSA6ICcnOwp9CgovLyBDb2xsYXBzZSB0aGUgYnVpbGRlciBpbnRvIGEgc2luZ2xlIG9iamVjdApRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKG1ldGhvZCkgewogIHZhciB2YWwgPSB0aGlzW21ldGhvZF0oKTsKICB2YXIgZGVmYXVsdHMgPSB7CiAgICBtZXRob2Q6IG1ldGhvZCwKICAgIG9wdGlvbnM6IHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMubGVuZ3RoID4gMCA/CiAgICAgIF8uZXh0ZW5kLmFwcGx5KF8sIHRoaXMub3B0aW9ucykgOiB2b2lkIDAsCiAgICBiaW5kaW5nczogdGhpcy5mb3JtYXR0ZXIuYmluZGluZ3MKICB9OwogIGlmIChfLmlzU3RyaW5nKHZhbCkpIHsKICAgIHZhbCA9IHtzcWw6IHZhbH07CiAgfQogIGlmIChtZXRob2QgPT09ICdzZWxlY3QnICYmIHRoaXMuc2luZ2xlLmFzKSB7CiAgICBkZWZhdWx0cy5hcyA9IHRoaXMuc2luZ2xlLmFzOwogIH0KICByZXR1cm4gXy5leHRlbmQoZGVmYXVsdHMsIHZhbCk7Cn07Cgp2YXIgY29tcG9uZW50cyA9IFsKICAnY29sdW1ucycsICdqb2luJywgJ3doZXJlJywgJ3VuaW9uJywgJ2dyb3VwJywKICAnaGF2aW5nJywgJ29yZGVyJywgJ2xpbWl0JywgJ29mZnNldCcsICdsb2NrJwpdOwoKLy8gQ29tcGlsZXMgdGhlIGBzZWxlY3RgIHN0YXRlbWVudCwgb3IgbmVzdGVkIHN1Yi1zZWxlY3RzCi8vIGJ5IGNhbGxpbmcgZWFjaCBvZiB0aGUgY29tcG9uZW50IGNvbXBpbGVycywgdHJpbW1pbmcgb3V0Ci8vIHRoZSBlbXB0aWVzLCBhbmQgcmV0dXJuaW5nIGEgZ2VuZXJhdGVkIHF1ZXJ5IHN0cmluZy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuc2VsZWN0ID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlbWVudHMgPSBbXTsKICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbXBvbmVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YXIgY29tcG9uZW50ID0gY29tcG9uZW50c1tpXTsKICAgIHN0YXRlbWVudHMucHVzaCh0aGlzW2NvbXBvbmVudF0odGhpcykpOwogIH0KICByZXR1cm4gXy5jb21wYWN0KHN0YXRlbWVudHMpLmpvaW4oJyAnKTsKfTsKUXVlcnlDb21waWxlci5wcm90b3R5cGUuZmlyc3QgPSBRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5zZWxlY3Q7ClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLnBsdWNrID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHNxbDogdGhpcy5zZWxlY3QoKSwKICAgIHBsdWNrOiB0aGlzLnNpbmdsZS5wbHVjawogIH07Cn07CgovLyBDb21waWxlcyBhbiAiaW5zZXJ0IiBxdWVyeSwgYWxsb3dpbmcgZm9yIG11bHRpcGxlCi8vIGluc2VydHMgdXNpbmcgYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5pbnNlcnQgPSBmdW5jdGlvbigpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgdmFyIGluc2VydFZhbHVlcyA9IHRoaXMuc2luZ2xlLmluc2VydDsKCiAgdmFyIHNxbCA9ICdpbnNlcnQgaW50byAnICsgdGhpcy50YWJsZU5hbWUgKyAnICc7CgogIGlmIChfLmlzQXJyYXkoaW5zZXJ0VmFsdWVzKSAmJiAoaW5zZXJ0VmFsdWVzLmxlbmd0aCA9PT0gMSkgJiYgXy5pc0VtcHR5KGluc2VydFZhbHVlc1swXSkpIHsKICAgIGluc2VydFZhbHVlcyA9IFtdOwogIH0KCiAgaWYgKF8uaXNFbXB0eShpbnNlcnRWYWx1ZXMpICYmICFfLmlzRnVuY3Rpb24oaW5zZXJ0VmFsdWVzKSkgewogICAgc3FsICs9IHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWU7CiAgfSBlbHNlIHsKICAgIHZhciBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnRWYWx1ZXMpOwoKICAgIGlmIChfLmlzU3RyaW5nKGluc2VydERhdGEpKSB7CiAgICAgIHNxbCArPSBpbnNlcnREYXRhOwogICAgfSBlbHNlICB7CiAgICAgIGlmIChpbnNlcnREYXRhLmNvbHVtbnMubGVuZ3RoKSB7CiAgICAgICAgc3FsICs9ICcoJyArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShpbnNlcnREYXRhLmNvbHVtbnMpICsgJykgdmFsdWVzICgnICsKICAgICAgICAgIF8ubWFwKGluc2VydERhdGEudmFsdWVzLCB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXJpemUsIHRoaXMuZm9ybWF0dGVyKS5qb2luKCcpLCAoJykgKyAnKSc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaWYgdGhlcmUgaXMgbm8gdGFyZ2V0IGNvbHVtbiBvbmx5IGluc2VydCBkZWZhdWx0IHZhbHVlcwogICAgICAgIHNxbCArPSAnKCkgdmFsdWVzICcgKyBfLm1hcChpbnNlcnREYXRhLnZhbHVlcywgZnVuY3Rpb24gKCkgeyByZXR1cm4gJygnICsgKHNlbGYuX2RlZmF1bHRJbnNlcnRWYWx1ZSB8fCAnJykgKyAnKSc7IH0pLmpvaW4oJywgJyk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHNxbDsKfTsKCi8vIENvbXBpbGVzIHRoZSAidXBkYXRlIiBxdWVyeS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKSB7CiAgdmFyIHVwZGF0ZURhdGEgPSB0aGlzLl9wcmVwVXBkYXRlKHRoaXMuc2luZ2xlLnVwZGF0ZSk7CiAgdmFyIHdoZXJlcyAgICAgPSB0aGlzLndoZXJlKCk7CiAgcmV0dXJuICd1cGRhdGUgJyArIHRoaXMudGFibGVOYW1lICsKICAgICcgc2V0ICcgKyB1cGRhdGVEYXRhLmpvaW4oJywgJykgKwogICAgKHdoZXJlcyA/ICcgJyArIHdoZXJlcyA6ICcnKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBjb2x1bW5zIGluIHRoZSBxdWVyeSwgc3BlY2lmeWluZyBpZiBhbiBpdGVtIHdhcyBkaXN0aW5jdC4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuY29sdW1ucyA9IGZ1bmN0aW9uKCkgewogIHZhciBkaXN0aW5jdCA9IGZhbHNlOwogIGlmICh0aGlzLm9ubHlVbmlvbnMoKSkgcmV0dXJuICcnOwogIHZhciBjb2x1bW5zID0gdGhpcy5ncm91cGVkLmNvbHVtbnMgfHwgW107CiAgdmFyIHNxbCA9IFtdOwogIGlmIChjb2x1bW5zKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbHVtbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHZhciBzdG10ID0gY29sdW1uc1tpXTsKICAgICAgaWYgKHN0bXQuZGlzdGluY3QpIGRpc3RpbmN0ID0gdHJ1ZTsKICAgICAgaWYgKHN0bXQudHlwZSA9PT0gJ2FnZ3JlZ2F0ZScpIHsKICAgICAgICBzcWwucHVzaCh0aGlzLmFnZ3JlZ2F0ZShzdG10KSk7CiAgICAgIH0gZWxzZSBpZiAoc3RtdC52YWx1ZSAmJiBzdG10LnZhbHVlLmxlbmd0aCA+IDApIHsKICAgICAgICBzcWwucHVzaCh0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoc3RtdC52YWx1ZSkpOwogICAgICB9CiAgICB9CiAgfQogIGlmIChzcWwubGVuZ3RoID09PSAwKSBzcWwucHVzaCgnKicpOwogIHJldHVybiAnc2VsZWN0ICcgKyAoZGlzdGluY3QgPyAnZGlzdGluY3QgJyA6ICcnKSArCiAgICAgIChzcWwuam9pbignLCAnKSB8fCAnKicpICsgKHRoaXMudGFibGVOYW1lID8gJyBmcm9tICcgKyB0aGlzLnRhYmxlTmFtZSA6ICcnKTsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLmFnZ3JlZ2F0ZSA9IGZ1bmN0aW9uKHN0bXQpIHsKICB2YXIgdmFsID0gc3RtdC52YWx1ZTsKICB2YXIgc3BsaXRPbiA9IHZhbC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJyBhcyAnKTsKICAvLyBBbGxvd3MgdXMgdG8gc3BlY2l5IGFuIGFsaWFzIGZvciB0aGUgYWdncmVnYXRlIHR5cGVzLgogIGlmIChzcGxpdE9uICE9PSAtMSkgewogICAgdmFyIGNvbCA9IHZhbC5zbGljZSgwLCBzcGxpdE9uKTsKICAgIHZhciBhbGlhcyA9IHZhbC5zbGljZShzcGxpdE9uICsgNCk7CiAgICByZXR1cm4gc3RtdC5tZXRob2QgKyAnKCcgKyB0aGlzLmZvcm1hdHRlci53cmFwKGNvbCkgKyAnKSBhcyAnICsgdGhpcy5mb3JtYXR0ZXIud3JhcChhbGlhcyk7CiAgfQogIHJldHVybiBzdG10Lm1ldGhvZCArICcoJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodmFsKSArICcpJzsKfTsKCi8vIENvbXBpbGVzIGFsbCBlYWNoIG9mIHRoZSBgam9pbmAgY2xhdXNlcyBvbiB0aGUgcXVlcnksCi8vIGluY2x1ZGluZyBhbnkgbmVzdGVkIGpvaW4gcXVlcmllcy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuam9pbiA9IGZ1bmN0aW9uKCkgewogIHZhciBqb2lucyA9IHRoaXMuZ3JvdXBlZC5qb2luOwogIGlmICgham9pbnMpIHJldHVybiAnJzsKICB2YXIgc3FsID0gXy5yZWR1Y2Uoam9pbnMsIGZ1bmN0aW9uKGFjYywgam9pbikgewogICAgaWYgKGpvaW4uam9pblR5cGUgPT09ICdyYXcnKSB7CiAgICAgIGFjYy5wdXNoKHRoaXMuZm9ybWF0dGVyLmNoZWNrUmF3KGpvaW4udGFibGUpKTsKICAgIH0gZWxzZSB7CiAgICAgIGFjYy5wdXNoKGpvaW4uam9pblR5cGUgKyAnIGpvaW4gJyArIHRoaXMuZm9ybWF0dGVyLndyYXAoam9pbi50YWJsZSkpOwogICAgICBfLmVhY2goam9pbi5jbGF1c2VzLCBmdW5jdGlvbihjbGF1c2UsIGkpIHsKICAgICAgICBhY2MucHVzaChpID4gMCA/IGNsYXVzZVsxXSA6IGNsYXVzZVswXSk7CiAgICAgICAgYWNjLnB1c2godGhpcy5mb3JtYXR0ZXIud3JhcChjbGF1c2VbMl0pKTsKICAgICAgICBpZiAoY2xhdXNlWzNdKSBhY2MucHVzaCh0aGlzLmZvcm1hdHRlci5vcGVyYXRvcihjbGF1c2VbM10pKTsKICAgICAgICBpZiAoY2xhdXNlWzRdKSBhY2MucHVzaCh0aGlzLmZvcm1hdHRlci53cmFwKGNsYXVzZVs0XSkpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgW10sIHRoaXMpOwogIHJldHVybiBzcWwubGVuZ3RoID4gMCA/IHNxbC5qb2luKCcgJykgOiAnJzsKfTsKCi8vIENvbXBpbGVzIGFsbCBgd2hlcmVgIHN0YXRlbWVudHMgb24gdGhlIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZSA9IGZ1bmN0aW9uKCkgewogIHZhciB3aGVyZXMgPSB0aGlzLmdyb3VwZWQud2hlcmU7CiAgaWYgKCF3aGVyZXMpIHJldHVybjsKICB2YXIgc3FsID0gW107CiAgc3FsWzBdID0gJ3doZXJlJzsKICBmb3IgKHZhciBpID0gMCwgbCA9IHdoZXJlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBzdG10ID0gd2hlcmVzW2ldOwogICAgaWYgKGkgIT09IDApIHNxbC5wdXNoKHN0bXQuYm9vbCk7CiAgICBzcWwucHVzaCh0aGlzW3N0bXQudHlwZV0oc3RtdCkpOwogIH0KICByZXR1cm4gc3FsLmxlbmd0aCA+IDEgPyBzcWwuam9pbignICcpIDogJyc7Cn07CgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5ncm91cCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9ncm91cHNPcmRlcnMoJ2dyb3VwJyk7Cn07ClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLm9yZGVyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2dyb3Vwc09yZGVycygnb3JkZXInKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBgaGF2aW5nYCBzdGF0ZW1lbnRzLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5oYXZpbmcgPSBmdW5jdGlvbigpIHsKICB2YXIgaGF2aW5ncyA9IHRoaXMuZ3JvdXBlZC5oYXZpbmc7CiAgaWYgKCFoYXZpbmdzKSByZXR1cm4gJyc7CiAgdmFyIHNxbCA9IFsnaGF2aW5nJ107CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBoYXZpbmdzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIHN0ciA9ICcnLCBzID0gaGF2aW5nc1tpXTsKICAgIGlmIChpICE9PSAwKSBzdHIgPSBzLmJvb2wgKyAnICc7CiAgICBpZiAocy50eXBlID09PSAnaGF2aW5nQmFzaWMnKSB7CiAgICAgIHNxbC5wdXNoKHN0ciArIHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShzLmNvbHVtbikgKyAnICcgKwogICAgICAgIHRoaXMuZm9ybWF0dGVyLm9wZXJhdG9yKHMub3BlcmF0b3IpICsgJyAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHMudmFsdWUpKTsKICAgIH0gZWxzZSB7CiAgICAgIHNxbC5wdXNoKHN0ciArIHRoaXMuZm9ybWF0dGVyLmNoZWNrUmF3KHMudmFsdWUpKTsKICAgIH0KICB9CiAgcmV0dXJuIHNxbC5sZW5ndGggPiAxID8gc3FsLmpvaW4oJyAnKSA6ICcnOwp9OwoKLy8gQ29tcGlsZSB0aGUgInVuaW9uIiBxdWVyaWVzIGF0dGFjaGVkIHRvIHRoZSBtYWluIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS51bmlvbiA9IGZ1bmN0aW9uKCkgewogIHZhciBvbmx5VW5pb25zID0gdGhpcy5vbmx5VW5pb25zKCk7CiAgdmFyIHVuaW9ucyA9IHRoaXMuZ3JvdXBlZC51bmlvbjsKICBpZiAoIXVuaW9ucykgcmV0dXJuICcnOwogIHZhciBzcWwgPSAnJzsKICBmb3IgKHZhciBpID0gMCwgbCA9IHVuaW9ucy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciB1bmlvbiA9IHVuaW9uc1tpXTsKICAgIGlmIChpID4gMCkgc3FsICs9ICcgJzsKICAgIGlmIChpID4gMCB8fCAhb25seVVuaW9ucykgc3FsICs9IHVuaW9uLmNsYXVzZSArICcgJzsKICAgIHZhciBzdGF0ZW1lbnQgPSB0aGlzLmZvcm1hdHRlci5yYXdPckZuKHVuaW9uLnZhbHVlKTsKICAgIGlmIChzdGF0ZW1lbnQpIHsKICAgICAgaWYgKHVuaW9uLndyYXApIHNxbCArPSAnKCc7CiAgICAgIHNxbCArPSBzdGF0ZW1lbnQ7CiAgICAgIGlmICh1bmlvbi53cmFwKSBzcWwgKz0gJyknOwogICAgfQogIH0KICByZXR1cm4gc3FsOwp9OwoKLy8gSWYgd2UgaGF2ZW4ndCBzcGVjaWZpZWQgYW55IGNvbHVtbnMgb3IgYSBgdGFibGVOYW1lYCwgd2UncmUgYXNzdW1pbmcgdGhpcwovLyBpcyBvbmx5IGJlaW5nIHVzZWQgZm9yIHVuaW9ucy4KUXVlcnlDb21waWxlci5wcm90b3R5cGUub25seVVuaW9ucyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAoIXRoaXMuZ3JvdXBlZC5jb2x1bW5zICYmIHRoaXMuZ3JvdXBlZC51bmlvbiAmJiAhdGhpcy50YWJsZU5hbWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUubGltaXQgPSBmdW5jdGlvbigpIHsKICBpZiAoIXRoaXMuc2luZ2xlLmxpbWl0KSByZXR1cm4gJyc7CiAgcmV0dXJuICdsaW1pdCAnICsgdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMuc2luZ2xlLmxpbWl0KTsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLm9mZnNldCA9IGZ1bmN0aW9uKCkgewogIGlmICghdGhpcy5zaW5nbGUub2Zmc2V0KSByZXR1cm4gJyc7CiAgcmV0dXJuICdvZmZzZXQgJyArIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5vZmZzZXQpOwp9OwoKLy8gQ29tcGlsZXMgYSBgZGVsZXRlYCBxdWVyeS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuZGVsID0gZnVuY3Rpb24oKSB7CiAgdmFyIHdoZXJlcyA9IHRoaXMud2hlcmUoKTsKICByZXR1cm4gJ2RlbGV0ZSBmcm9tICcgKyB0aGlzLnRhYmxlTmFtZSArCiAgICAod2hlcmVzID8gJyAnICsgd2hlcmVzIDogJycpOwp9OwoKLy8gQ29tcGlsZXMgYSBgdHJ1bmNhdGVgIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS50cnVuY2F0ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAndHJ1bmNhdGUgJyArIHRoaXMudGFibGVOYW1lOwp9OwoKLy8gQ29tcGlsZXMgdGhlICJsb2NrcyIuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLmxvY2sgPSBmdW5jdGlvbigpIHsKICBpZiAodGhpcy5zaW5nbGUubG9jaykgewogICAgaWYgKCF0aGlzLnRyYW5zYWN0aW5nKSB7CiAgICAgIGhlbHBlcnMud2FybignWW91IGFyZSBhdHRlbXB0aW5nIHRvIHBlcmZvcm0gYSAibG9jayIgY29tbWFuZCBvdXRzaWRlIG9mIGEgdHJhbnNhY3Rpb24uJyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpc1t0aGlzLnNpbmdsZS5sb2NrXSgpOwogICAgfQogIH0KfTsKCi8vIENvbXBpbGUgdGhlICJjb3VudGVyIi4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuY291bnRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBjb3VudGVyID0gdGhpcy5zaW5nbGUuY291bnRlcjsKICB2YXIgdG9VcGRhdGUgPSB7fTsKICB0b1VwZGF0ZVtjb3VudGVyLmNvbHVtbl0gPSBuZXcgUmF3KHRoaXMuZm9ybWF0dGVyLndyYXAoY291bnRlci5jb2x1bW4pICsKICAgICcgJyArIChjb3VudGVyLnN5bWJvbCB8fCAnKycpICsKICAgICcgJyArIGNvdW50ZXIuYW1vdW50KTsKICB0aGlzLnNpbmdsZS51cGRhdGUgPSB0b1VwZGF0ZTsKICByZXR1cm4gdGhpcy51cGRhdGUoKTsKfTsKCi8vIENvbXBpbGVzIHRoZSBgb3JkZXIgYnlgIHN0YXRlbWVudHMuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLl9ncm91cHNPcmRlcnMgPSBmdW5jdGlvbih0eXBlKSB7CiAgdmFyIGl0ZW1zID0gdGhpcy5ncm91cGVkW3R5cGVdOwogIGlmICghaXRlbXMpIHJldHVybiAnJzsKICB2YXIgZm9ybWF0dGVyID0gdGhpcy5mb3JtYXR0ZXI7CiAgdmFyIHNxbCA9IGl0ZW1zLm1hcChmdW5jdGlvbiAoaXRlbSkgewogICAgcmV0dXJuIChpdGVtLnZhbHVlIGluc3RhbmNlb2YgUmF3ID8gZm9ybWF0dGVyLmNoZWNrUmF3KGl0ZW0udmFsdWUpIDogZm9ybWF0dGVyLmNvbHVtbml6ZShpdGVtLnZhbHVlKSkgKwogICAgICAoKHR5cGUgPT09ICdvcmRlcicgJiYgaXRlbS50eXBlICE9PSAnb3JkZXJCeVJhdycpID8gJyAnICsgZm9ybWF0dGVyLmRpcmVjdGlvbihpdGVtLmRpcmVjdGlvbikgOiAnJyk7CiAgfSk7CiAgcmV0dXJuIHNxbC5sZW5ndGggPyB0eXBlICsgJyBieSAnICsgc3FsLmpvaW4oJywgJykgOiAnJzsKfTsKCi8vIFdoZXJlIENsYXVzZQovLyAtLS0tLS0KClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlSW4gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICBpZiAoXy5pc0FycmF5KHN0YXRlbWVudC5jb2x1bW4pKSByZXR1cm4gdGhpcy5tdWx0aVdoZXJlSW4oc3RhdGVtZW50KTsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArIHRoaXMuX25vdChzdGF0ZW1lbnQsICdpbiAnKSArCiAgICB0aGlzLndyYXAodGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKHN0YXRlbWVudC52YWx1ZSkpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUubXVsdGlXaGVyZUluID0gZnVuY3Rpb24oc3RhdGVtZW50KSB7CiAgcmV0dXJuICcoJyArIF8ubWFwKHN0YXRlbWVudC5jb2x1bW4sIHRoaXMuZm9ybWF0dGVyLndyYXAsIHRoaXMuZm9ybWF0dGVyKSArICcpICcgKwogICAgdGhpcy5fbm90KHN0YXRlbWVudCwgJ2luICcpICsgJygoJyArCiAgICBfLm1hcChzdGF0ZW1lbnQudmFsdWUsIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcml6ZSwgdGhpcy5mb3JtYXR0ZXIpLmpvaW4oJyksKCcpICsgJykpJzsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlTnVsbCA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKHN0YXRlbWVudC5jb2x1bW4pICsgJyBpcyAnICsgdGhpcy5fbm90KHN0YXRlbWVudCwgJ251bGwnKTsKfTsKCi8vIENvbXBpbGVzIGEgYmFzaWMgIndoZXJlIiBjbGF1c2UuClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlQmFzaWMgPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArCiAgICB0aGlzLmZvcm1hdHRlci5vcGVyYXRvcihzdGF0ZW1lbnQub3BlcmF0b3IpICsgJyAnICsKICAgIHRoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcihzdGF0ZW1lbnQudmFsdWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUud2hlcmVFeGlzdHMgPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5fbm90KHN0YXRlbWVudCwgJ2V4aXN0cycpICsgJyAoJyArIHRoaXMuZm9ybWF0dGVyLnJhd09yRm4oc3RhdGVtZW50LnZhbHVlKSArICcpJzsKfTsKClF1ZXJ5Q29tcGlsZXIucHJvdG90eXBlLndoZXJlV3JhcHBlZCA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiAnKCcgKyB0aGlzLmZvcm1hdHRlci5yYXdPckZuKHN0YXRlbWVudC52YWx1ZSwgJ3doZXJlJykuc2xpY2UoNikgKyAnKSc7Cn07CgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZUJldHdlZW4gPSBmdW5jdGlvbihzdGF0ZW1lbnQpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcChzdGF0ZW1lbnQuY29sdW1uKSArICcgJyArIHRoaXMuX25vdChzdGF0ZW1lbnQsICdiZXR3ZWVuJykgKyAnICcgKwogICAgXy5tYXAoc3RhdGVtZW50LnZhbHVlLCB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIsIHRoaXMuZm9ybWF0dGVyKS5qb2luKCcgYW5kICcpOwp9OwoKLy8gQ29tcGlsZXMgYSAid2hlcmVSYXciIHF1ZXJ5LgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS53aGVyZVJhdyA9IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci5jaGVja1JhdyhzdGF0ZW1lbnQudmFsdWUpOwp9OwoKUXVlcnlDb21waWxlci5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cikgewogIGlmIChzdHIuY2hhckF0KDApICE9PSAnKCcpIHJldHVybiAnKCcgKyBzdHIgKyAnKSc7CiAgcmV0dXJuIHN0cjsKfTsKCi8vIERldGVybWluZXMgd2hldGhlciB0byBhZGQgYSAibm90IiBwcmVmaXggdG8gdGhlIHdoZXJlIGNsYXVzZS4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuX25vdCA9IGZ1bmN0aW9uKHN0YXRlbWVudCwgc3RyKSB7CiAgaWYgKHN0YXRlbWVudC5ub3QpIHJldHVybiAnbm90ICcgKyBzdHI7CiAgcmV0dXJuIHN0cjsKfTsKCi8vICJQcmVwcyIgdGhlIGluc2VydC4KUXVlcnlDb21waWxlci5wcm90b3R5cGUuX3ByZXBJbnNlcnQgPSBmdW5jdGlvbihkYXRhKSB7CiAgdmFyIGlzUmF3ID0gdGhpcy5mb3JtYXR0ZXIucmF3T3JGbihkYXRhKTsKICBpZiAoaXNSYXcpIHJldHVybiBpc1JhdzsKICB2YXIgdmFsdWVzID0gW107CiAgdmFyIGNvbHVtbnMsIGNvbExpc3Q7CiAgaWYgKCFfLmlzQXJyYXkoZGF0YSkpIGRhdGEgPSBkYXRhID8gW2RhdGFdIDogW107CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBkYXRhLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgIHZhciBzb3J0ZWQgPSBoZWxwZXJzLnNvcnRPYmplY3QoZGF0YVtpXSk7CiAgICBjb2x1bW5zID0gXy5wbHVjayhzb3J0ZWQsIDApOwogICAgY29sTGlzdCA9IGNvbExpc3QgfHwgY29sdW1uczsKICAgIGlmICghXy5pc0VxdWFsKGNvbHVtbnMsIGNvbExpc3QpKSB7CiAgICAgIHJldHVybiB0aGlzLl9wcmVwSW5zZXJ0KHRoaXMuX25vcm1hbGl6ZUluc2VydChkYXRhKSk7CiAgICB9CiAgICB2YWx1ZXMucHVzaChfLnBsdWNrKHNvcnRlZCwgMSkpOwogIH0KICByZXR1cm4gewogICAgY29sdW1uczogY29sdW1ucywKICAgIHZhbHVlczogdmFsdWVzCiAgfTsKfTsKCi8vIElmIHdlIGFyZSBydW5uaW5nIGFuIGluc2VydCB3aXRoIHZhcmlhYmxlIG9iamVjdCBrZXlzLCB3ZSBuZWVkIHRvIG5vcm1hbGl6ZQovLyBmb3IgdGhlIG1pc3Npbmcga2V5cywgcHJlc3VtYWJseSBzZXR0aW5nIHRoZSB2YWx1ZXMgdG8gdW5kZWZpbmVkLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5fbm9ybWFsaXplSW5zZXJ0ID0gZnVuY3Rpb24oZGF0YSkgewogIGlmICghXy5pc0FycmF5KGRhdGEpKSByZXR1cm4gXy5jbG9uZShkYXRhKTsKICB2YXIgZGVmYXVsdE9iaiA9IF8ucmVkdWNlKF8udW5pb24uYXBwbHkoXywgXy5tYXAoZGF0YSwgZnVuY3Rpb24odmFsKSB7CiAgICByZXR1cm4gXy5rZXlzKHZhbCk7CiAgfSkpLCBmdW5jdGlvbihtZW1vLCBrZXkpIHsKICAgIG1lbW9ba2V5XSA9IHZvaWQgMDsKICAgIHJldHVybiBtZW1vOwogIH0sIHt9KTsKICByZXR1cm4gXy5tYXAoZGF0YSwgZnVuY3Rpb24ocm93KSB7IHJldHVybiBfLmRlZmF1bHRzKHJvdywgZGVmYXVsdE9iaik7IH0pOwp9OwoKLy8gIlByZXBzIiB0aGUgdXBkYXRlLgpRdWVyeUNvbXBpbGVyLnByb3RvdHlwZS5fcHJlcFVwZGF0ZSA9IGZ1bmN0aW9uKGRhdGEpIHsKICB2YXIgdmFscyA9IFtdOwogIHZhciBzb3J0ZWQgPSBoZWxwZXJzLnNvcnRPYmplY3QoZGF0YSk7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBzb3J0ZWQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICB2YWxzLnB1c2godGhpcy5mb3JtYXR0ZXIud3JhcChzb3J0ZWRbaV1bMF0pICsgJyA9ICcgKyB0aGlzLmZvcm1hdHRlci5wYXJhbWV0ZXIoc29ydGVkW2ldWzFdKSk7CiAgfQogIHJldHVybiB2YWxzOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBRdWVyeUNvbXBpbGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCIuLi9yYXciOjEwOCwibG9kYXNoIjoxMzB9XSwxMDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBKb2luQ2xhdXNlCi8vIC0tLS0tLS0KCi8vIFRoZSAiSm9pbkNsYXVzZSIgaXMgYW4gb2JqZWN0IGhvbGRpbmcgYW55IG5lY2Vzc2FyeSBpbmZvIGFib3V0IGEgam9pbiwKLy8gaW5jbHVkaW5nIHRoZSB0eXBlLCBhbmQgYW55IGFzc29jaWF0ZWQgdGFibGVzICYgY29sdW1ucyBiZWluZyBqb2luZWQuCmZ1bmN0aW9uIEpvaW5DbGF1c2UodGFibGUsIHR5cGUpIHsKICB0aGlzLnRhYmxlICAgID0gdGFibGU7CiAgdGhpcy5qb2luVHlwZSA9IHR5cGU7CiAgdGhpcy5jbGF1c2VzICA9IFtdOwogIHRoaXMuYW5kICAgICAgPSB0aGlzOwp9CgpKb2luQ2xhdXNlLnByb3RvdHlwZS5ncm91cGluZyA9ICdqb2luJzsKCi8vIEFkZHMgYW4gIm9uIiBjbGF1c2UgdG8gdGhlIGN1cnJlbnQgam9pbiBvYmplY3QuCkpvaW5DbGF1c2UucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmQpIHsKICB2YXIgZGF0YTsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMTogIGRhdGEgPSBbJ29uJywgdGhpcy5fYm9vbCgpLCBmaXJzdF07IGJyZWFrOwogICAgY2FzZSAyOiAgZGF0YSA9IFsnb24nLCB0aGlzLl9ib29sKCksIGZpcnN0LCAnPScsIG9wZXJhdG9yXTsgYnJlYWs7CiAgICBkZWZhdWx0OiBkYXRhID0gWydvbicsIHRoaXMuX2Jvb2woKSwgZmlyc3QsIG9wZXJhdG9yLCBzZWNvbmRdOwogIH0KICB0aGlzLmNsYXVzZXMucHVzaChkYXRhKTsKICByZXR1cm4gdGhpczsKfTsKCi8vIEFkZHMgYSAidXNpbmciIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luLgpKb2luQ2xhdXNlLnByb3RvdHlwZS51c2luZyA9IGZ1bmN0aW9uKHRhYmxlKSB7CiAgcmV0dXJuIHRoaXMuY2xhdXNlcy5wdXNoKFsndXNpbmcnLCB0aGlzLl9ib29sKCksIHRhYmxlXSk7Cn07CgovLyBBZGRzIGFuICJhbmQgb24iIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luIG9iamVjdC4KSm9pbkNsYXVzZS5wcm90b3R5cGUuYW5kT24gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5vbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKLy8gQWRkcyBhbiAib3Igb24iIGNsYXVzZSB0byB0aGUgY3VycmVudCBqb2luIG9iamVjdC4KSm9pbkNsYXVzZS5wcm90b3R5cGUub3JPbiA9IGZ1bmN0aW9uKGZpcnN0LCBvcGVyYXRvciwgc2Vjb25kKSB7CiAgLypqc2hpbnQgdW51c2VkOiBmYWxzZSovCiAgcmV0dXJuIHRoaXMuX2Jvb2woJ29yJykub24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKfTsKCi8vIEV4cGxpY2l0bHkgc2V0IHRoZSB0eXBlIG9mIGpvaW4sIHVzZWZ1bCB3aXRoaW4gYSBmdW5jdGlvbiB3aGVuIGNyZWF0aW5nIGEgZ3JvdXBlZCBqb2luLgpKb2luQ2xhdXNlLnByb3RvdHlwZS50eXBlID0gZnVuY3Rpb24odHlwZSkgewogIHRoaXMuam9pblR5cGUgPSB0eXBlOwogIHJldHVybiB0aGlzOwp9OwoKSm9pbkNsYXVzZS5wcm90b3R5cGUuX2Jvb2wgPSBmdW5jdGlvbihib29sKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHRoaXMuX2Jvb2xGbGFnID0gYm9vbDsKICAgIHJldHVybiB0aGlzOwogIH0KICB2YXIgcmV0ID0gdGhpcy5fYm9vbEZsYWcgfHwgJ2FuZCc7CiAgdGhpcy5fYm9vbEZsYWcgPSAnYW5kJzsKICByZXR1cm4gcmV0Owp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KEpvaW5DbGF1c2UucHJvdG90eXBlLCAnb3InLCB7CiAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fYm9vbCgnb3InKTsKICB9Cn0pOwoKbW9kdWxlLmV4cG9ydHMgPSBKb2luQ2xhdXNlOwp9LHt9XSwxMDc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBBbGwgcHJvcGVydGllcyB3ZSBjYW4gdXNlIHRvIHN0YXJ0IGEgcXVlcnkgY2hhaW4KLy8gZnJvbSB0aGUgYGtuZXhgIG9iamVjdCwgZS5nLiBga25leC5zZWxlY3QoJyonKS5mcm9tKC4uLmAKbW9kdWxlLmV4cG9ydHMgPSBbCiAgJ3NlbGVjdCcsCiAgJ2FzJywKICAnY29sdW1ucycsCiAgJ2NvbHVtbicsCiAgJ2Zyb20nLAogICdpbnRvJywKICAndGFibGUnLAogICdkaXN0aW5jdCcsCiAgJ2pvaW4nLAogICdqb2luUmF3JywKICAnaW5uZXJKb2luJywKICAnbGVmdEpvaW4nLAogICdsZWZ0T3V0ZXJKb2luJywKICAncmlnaHRKb2luJywKICAncmlnaHRPdXRlckpvaW4nLAogICdvdXRlckpvaW4nLAogICdmdWxsT3V0ZXJKb2luJywKICAnY3Jvc3NKb2luJywKICAnd2hlcmUnLAogICdhbmRXaGVyZScsCiAgJ29yV2hlcmUnLAogICd3aGVyZVJhdycsCiAgJ3doZXJlV3JhcHBlZCcsCiAgJ29yV2hlcmVSYXcnLAogICd3aGVyZUV4aXN0cycsCiAgJ29yV2hlcmVFeGlzdHMnLAogICd3aGVyZU5vdEV4aXN0cycsCiAgJ29yV2hlcmVOb3RFeGlzdHMnLAogICd3aGVyZUluJywKICAnb3JXaGVyZUluJywKICAnd2hlcmVOb3RJbicsCiAgJ29yV2hlcmVOb3RJbicsCiAgJ3doZXJlTnVsbCcsCiAgJ29yV2hlcmVOdWxsJywKICAnd2hlcmVOb3ROdWxsJywKICAnb3JXaGVyZU5vdE51bGwnLAogICd3aGVyZUJldHdlZW4nLAogICd3aGVyZU5vdEJldHdlZW4nLAogICdvcldoZXJlQmV0d2VlbicsCiAgJ29yV2hlcmVOb3RCZXR3ZWVuJywKICAnZ3JvdXBCeScsCiAgJ2dyb3VwQnlSYXcnLAogICdvcmRlckJ5JywKICAnb3JkZXJCeVJhdycsCiAgJ3VuaW9uJywKICAndW5pb25BbGwnLAogICdoYXZpbmcnLAogICdoYXZpbmdSYXcnLAogICdvckhhdmluZycsCiAgJ29ySGF2aW5nUmF3JywKICAnb2Zmc2V0JywKICAnbGltaXQnLAogICdjb3VudCcsCiAgJ21pbicsCiAgJ21heCcsCiAgJ3N1bScsCiAgJ2F2ZycsCiAgJ2luY3JlbWVudCcsCiAgJ2RlY3JlbWVudCcsCiAgJ2ZpcnN0JywKICAnZGVidWcnLAogICdwbHVjaycsCiAgJ2luc2VydCcsCiAgJ3VwZGF0ZScsCiAgJ3JldHVybmluZycsCiAgJ2RlbCcsCiAgJ2RlbGV0ZScsCiAgJ3RydW5jYXRlJywKICAndHJhbnNhY3RpbmcnLAogICdjb25uZWN0aW9uJwpdOwp9LHt9XSwxMDg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewondXNlIHN0cmljdCc7CgovLyBSYXcKLy8gLS0tLS0tLQp2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKZnVuY3Rpb24gUmF3KHNxbCwgYmluZGluZ3MpIHsKICBpZiAoc3FsICYmIHNxbC50b1NRTCkgewogICAgdmFyIG91dHB1dCA9IHNxbC50b1NRTCgpOwogICAgc3FsID0gb3V0cHV0LnNxbDsKICAgIGJpbmRpbmdzID0gb3V0cHV0LmJpbmRpbmdzOwogIH0KICB0aGlzLnNxbCA9IHNxbCArICcnOwogIHRoaXMuYmluZGluZ3MgPSBfLmlzQXJyYXkoYmluZGluZ3MpID8gYmluZGluZ3MgOgogICAgYmluZGluZ3MgPyBbYmluZGluZ3NdIDogW107CiAgdGhpcy5pbnRlcnBvbGF0ZUJpbmRpbmdzKCk7CiAgdGhpcy5fZGVidWcgICAgICAgPSB2b2lkIDA7CiAgdGhpcy5fdHJhbnNhY3RpbmcgPSB2b2lkIDA7Cn0KaW5oZXJpdHMoUmF3LCBFdmVudEVtaXR0ZXIpOwoKLy8gV3JhcHMgdGhlIGN1cnJlbnQgc3FsIHdpdGggYGJlZm9yZWAgYW5kIGBhZnRlcmAuClJhdy5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKGJlZm9yZSwgYWZ0ZXIpIHsKICB0aGlzLnNxbCA9IGJlZm9yZSArIHRoaXMuc3FsICsgYWZ0ZXI7CiAgcmV0dXJuIHRoaXM7Cn07CgovLyBDYWxscyBgdG9TdHJpbmdgIG9uIHRoZSBLbmV4IG9iamVjdC4KUmF3LnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnRvUXVlcnkoKTsKfTsKCi8vIEVuc3VyZSBhbGwgUmF3IC8gYnVpbGRlciBiaW5kaW5ncyBhcmUgbWl4ZWQtaW4gdG8gdGhlID8gcGxhY2Vob2xkZXJzCi8vIGFzIGFwcHJvcHJpYXRlLgpSYXcucHJvdG90eXBlLmludGVycG9sYXRlQmluZGluZ3MgPSBmdW5jdGlvbigpIHsKICB2YXIgcmVwbGFjZW1lbnRzID0gW107CiAgdGhpcy5iaW5kaW5ncyA9IF8ucmVkdWNlKHRoaXMuYmluZGluZ3MsIGZ1bmN0aW9uKGFjY3VtLCBwYXJhbSwgaW5kZXgpIHsKICAgIHZhciBpbm5lckJpbmRpbmdzID0gW3BhcmFtXTsKICAgIGlmIChwYXJhbSAmJiBwYXJhbS50b1NRTCkgewogICAgICB2YXIgcmVzdWx0ICAgID0gdGhpcy5zcGxpY2VyKHBhcmFtLCBpbmRleCk7CiAgICAgIGlubmVyQmluZGluZ3MgPSByZXN1bHQuYmluZGluZ3M7CiAgICAgIHJlcGxhY2VtZW50cy5wdXNoKHJlc3VsdC5yZXBsYWNlcik7CiAgICB9CiAgICByZXR1cm4gYWNjdW0uY29uY2F0KGlubmVyQmluZGluZ3MpOwogIH0sIFtdLCB0aGlzKTsKCiAgLy8gd2UgcnVuIHRoaXMgaW4gcmV2ZXJzZSBvcmRlciwgYmVjYXVzZSA/IGNvbmNhdHMgZWFybGllciBpbiB0aGUKICAvLyBxdWVyeSBzdHJpbmcgd2lsbCBkaXNydXB0IGluZGljZXMgZm9yIGxhdGVyIG9uZXMKICB0aGlzLnNxbCA9IF8ucmVkdWNlKHJlcGxhY2VtZW50cy5yZXZlcnNlKCksIGZ1bmN0aW9uKGFjY3VtLCBmbikgewogICAgcmV0dXJuIGZuKGFjY3VtKTsKICB9LCB0aGlzLnNxbC5zcGxpdCgnPycpKS5qb2luKCc/Jyk7Cn07CgovLyBSZXR1cm5zIGEgcmVwbGFjZXIgZnVuY3Rpb24gdGhhdCBzcGxpY2VzIGludG8gdGhlIGkndGgKLy8gPyBpbiB0aGUgc3FsIHN0cmluZyB0aGUgaW5uZXIgcmF3J3Mgc3FsLAovLyBhbmQgdGhlIGJpbmRpbmdzIGFzc29jaWF0ZWQgd2l0aCBpdApSYXcucHJvdG90eXBlLnNwbGljZXIgPSBmdW5jdGlvbihyYXcsIGkpIHsKICB2YXIgb2JqID0gcmF3LnRvU1FMKCk7CgogIC8vIHRoZSByZXBsYWNlciBmdW5jdGlvbiBhc3N1bWVzIHRoYXQgdGhlIHNxbCBoYXMgYmVlbgogIC8vIGFscmVhZHkgc3FsLnNwbGl0KCc/JykgYW5kIHdpbGwgYmUgYXJyLmpvaW4oJz8nKQogIHZhciByZXBsYWNlciA9IGZ1bmN0aW9uKGFycikgewogICAgYXJyW2ldID0gYXJyW2ldICsgb2JqLnNxbCArIGFycltpICsgMV07CiAgICBhcnIuc3BsaWNlKGkgKyAxLCAxKTsKICAgIHJldHVybiBhcnI7CiAgfTsKCiAgcmV0dXJuIHsKICAgIHJlcGxhY2VyOiByZXBsYWNlciwKICAgIGJpbmRpbmdzOiBvYmouYmluZGluZ3MKICB9Owp9OwoKLy8gUmV0dXJucyB0aGUgcmF3IHNxbCBmb3IgdGhlIHF1ZXJ5LgpSYXcucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHsKICAgIHNxbDogdGhpcy5zcWwsCiAgICBtZXRob2Q6ICdyYXcnLAogICAgYmluZGluZ3M6IHRoaXMuYmluZGluZ3MKICB9Owp9OwoKLy8gQWxsb3cgdGhlIGBSYXdgIG9iamVjdCB0byBiZSB1dGlsaXplZCB3aXRoIGZ1bGwgYWNjZXNzIHRvIHRoZSByZWxldmFudAovLyBwcm9taXNlIEFQSS4KcmVxdWlyZSgnLi9pbnRlcmZhY2UnKShSYXcpOwoKbW9kdWxlLmV4cG9ydHMgPSBSYXc7Cn0seyIuL2ludGVyZmFjZSI6MTAwLCJldmVudHMiOjU3LCJpbmhlcml0cyI6NzYsImxvZGFzaCI6MTMwfV0sMTA5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgUHJvbWlzZSAgICAgID0gcmVxdWlyZSgnLi9wcm9taXNlJyk7CgovLyBUaGUgIlJ1bm5lciIgY29uc3RydWN0b3IgdGFrZXMgYSAiYnVpbGRlciIgKHF1ZXJ5LCBzY2hlbWEsIG9yIHJhdykKLy8gYW5kIHJ1bnMgdGhyb3VnaCBlYWNoIG9mIHRoZSBxdWVyeSBzdGF0ZW1lbnRzLCBjYWxsaW5nIGFueSBhZGRpdGlvbmFsCi8vICJvdXRwdXQiIG1ldGhvZCBwcm92aWRlZCBhbG9uZ3NpZGUgdGhlIHF1ZXJ5IGFuZCBiaW5kaW5ncy4KZnVuY3Rpb24gUnVubmVyKGJ1aWxkZXIpIHsKICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogIHRoaXMucXVlcmllcyA9IFtdOwoKICAvLyBUaGUgImNvbm5lY3Rpb24iIG9iamVjdCBpcyBzZXQgb24gdGhlIHJ1bm5lciB3aGVuCiAgLy8gInJ1biIgaXMgY2FsbGVkLgogIHRoaXMuY29ubmVjdGlvbiA9IHZvaWQgMDsKfQoKUnVubmVyLnByb3RvdHlwZS5fYmVnaW5UcmFuc2FjdGlvbiA9ICdiZWdpbjsnOwpSdW5uZXIucHJvdG90eXBlLl9jb21taXRUcmFuc2FjdGlvbiA9ICdjb21taXQ7JzsKUnVubmVyLnByb3RvdHlwZS5fcm9sbGJhY2tUcmFuc2FjdGlvbiA9ICdyb2xsYmFjazsnOwoKLy8gIlJ1biIgdGhlIHRhcmdldCwgY2FsbGluZyAidG9TUUwiIG9uIHRoZSBidWlsZGVyLCByZXR1cm5pbmcKLy8gYW4gb2JqZWN0IG9yIGFycmF5IG9mIHF1ZXJpZXMgdG8gcnVuLCBlYWNoIG9mIHdoaWNoIGFyZSBydW4gb24KLy8gYSBzaW5nbGUgY29ubmVjdGlvbi4KUnVubmVyLnByb3RvdHlwZS5ydW4gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICBpZiAodGhpcy5idWlsZGVyLl90cmFuc2FjdGluZykgewogICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb25RdWVyeSgpOwogIH0KICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CgogICAgICAvLyBFbWl0IGEgInN0YXJ0IiBldmVudCBvbiBib3RoIHRoZSBidWlsZGVyIGFuZCB0aGUgY2xpZW50LAogICAgICAvLyBhbGxvd2luZyB1cyB0byBsaXN0ZW4gaW4gb24gYW55IGV2ZW50cy4gV2UgZmlyZSBvbiB0aGUgImNsaWVudCIKICAgICAgLy8gYmVmb3JlIGJ1aWxkaW5nIHRoZSBTUUwsIGFuZCBvbiB0aGUgYnVpbGRlciBhZnRlciBidWlsZGluZyB0aGUgU1FMCiAgICAgIC8vIGluIGNhc2Ugd2Ugd2FudCB0byBkZXRlcm1pbmUgYXQgaG93IGxvbmcgaXQgYWN0dWFsbHkKICAgICAgLy8gdG9vayB0byBidWlsZCB0aGUgcXVlcnkuCiAgICAgIHRoaXMuY2xpZW50LmVtaXQoJ3N0YXJ0JywgdGhpcy5idWlsZGVyKTsKICAgICAgdmFyIHNxbCA9IHRoaXMuYnVpbGRlci50b1NRTCgpOwogICAgICB0aGlzLmJ1aWxkZXIuZW1pdCgnc3RhcnQnLCB0aGlzLmJ1aWxkZXIpOwoKICAgICAgaWYgKF8uaXNBcnJheShzcWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlBcnJheShzcWwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHNxbCk7CiAgICB9KQoKICAgIC8vIElmIHRoZXJlIGFyZSBhbnkgImVycm9yIiBsaXN0ZW5lcnMsIHdlIGZpcmUgYW4gZXJyb3IgZXZlbnQKICAgIC8vIGFuZCB0aGVuIHJlLXRocm93IHRoZSBlcnJvciB0byBiZSBldmVudHVhbGx5IGhhbmRsZWQgYnkKICAgIC8vIHRoZSBwcm9taXNlIGNoYWluLiBVc2VmdWwgaWYgeW91J3JlIHdyYXBwaW5nIGluIGEgY3VzdG9tIGBQcm9taXNlYC4KICAgIC5jYXRjaChmdW5jdGlvbihlcnIpIHsKICAgICAgaWYgKHRoaXMuYnVpbGRlci5fZXZlbnRzICYmIHRoaXMuYnVpbGRlci5fZXZlbnRzLmVycm9yKSB7CiAgICAgICAgdGhpcy5idWlsZGVyLmVtaXQoJ2Vycm9yJywgZXJyKTsKICAgICAgfQogICAgICB0aHJvdyBlcnI7CiAgICB9KQoKICAgIC8vIEZpcmUgYSBzaW5nbGUgImVuZCIgZXZlbnQgb24gdGhlIGJ1aWxkZXIgd2hlbgogICAgLy8gYWxsIHF1ZXJpZXMgaGF2ZSBzdWNjZXNzZnVsbHkgY29tcGxldGVkLgogICAgLnRhcChmdW5jdGlvbigpIHsKICAgICAgdGhpcy5idWlsZGVyLmVtaXQoJ2VuZCcpOwogICAgfSkKICAgIC5maW5hbGx5KHRoaXMuY2xlYW51cENvbm5lY3Rpb24pOwp9KTsKCi8vIFN0cmVhbSB0aGUgcmVzdWx0IHNldCwgYnkgcGFzc2luZyB0aHJvdWdoIHRvIHRoZSBkaWFsZWN0J3Mgc3RyZWFtaW5nCi8vIGNhcGFiaWxpdGllcy4gSWYgdGhlIG9wdGlvbnMgYXJlCnZhciBQYXNzVGhyb3VnaDsKUnVubmVyLnByb3RvdHlwZS5zdHJlYW0gPSBmdW5jdGlvbihvcHRpb25zLCBoYW5kbGVyKSB7CiAgLy8gSWYgd2Ugc3BlY2lmeSBzdHJlYW0oaGFuZGxlcikudGhlbiguLi4KICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgaWYgKF8uaXNGdW5jdGlvbihvcHRpb25zKSkgewogICAgICBoYW5kbGVyID0gb3B0aW9uczsKICAgICAgb3B0aW9ucyA9IHt9OwogICAgfQogIH0KCiAgLy8gRGV0ZXJtaW5lcyB3aGV0aGVyIHdlIGVtaXQgYW4gZXJyb3Igb3IgdGhyb3cgaGVyZS4KICB2YXIgaGFzSGFuZGxlciA9IF8uaXNGdW5jdGlvbihoYW5kbGVyKTsKCiAgLy8gTGF6eS1sb2FkIHRoZSAiUGFzc1Rocm91Z2giIGRlcGVuZGVuY3kuCiAgUGFzc1Rocm91Z2ggPSBQYXNzVGhyb3VnaCB8fCByZXF1aXJlKCdyZWFkYWJsZS1zdHJlYW0nKS5QYXNzVGhyb3VnaDsKICB2YXIgc3RyZWFtICA9IG5ldyBQYXNzVGhyb3VnaCh7b2JqZWN0TW9kZTogdHJ1ZX0pOwogIHZhciBwcm9taXNlID0gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247CiAgICAgIHZhciBzcWwgPSB0aGlzLmJ1aWxkZXIudG9TUUwoKTsKICAgICAgdmFyIGVyciA9IG5ldyBFcnJvcignVGhlIHN0cmVhbSBtYXkgb25seSBiZSB1c2VkIHdpdGggYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LicpOwogICAgICBpZiAoXy5pc0FycmF5KHNxbCkpIHsKICAgICAgICBpZiAoaGFzSGFuZGxlcikgdGhyb3cgZXJyOwogICAgICAgIHN0cmVhbS5lbWl0KCdlcnJvcicsIGVycik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNxbDsKICAgIH0pLnRoZW4oZnVuY3Rpb24oc3FsKSB7CiAgICAgIHJldHVybiB0aGlzLl9zdHJlYW0oc3FsLCBzdHJlYW0sIG9wdGlvbnMpOwogICAgfSkuZmluYWxseSh0aGlzLmNsZWFudXBDb25uZWN0aW9uKTsKCiAgLy8gSWYgYSBmdW5jdGlvbiBpcyBwYXNzZWQgdG8gaGFuZGxlIHRoZSBzdHJlYW0sIHNlbmQgdGhlIHN0cmVhbQogIC8vIHRoZXJlIGFuZCByZXR1cm4gdGhlIHByb21pc2UsIG90aGVyd2lzZSBqdXN0IHJldHVybiB0aGUgc3RyZWFtCiAgLy8gYW5kIHRoZSBwcm9taXNlIHdpbGwgdGFrZSBjYXJlIG9mIGl0c3NlbGYuCiAgaWYgKGhhc0hhbmRsZXIpIHsKICAgIGhhbmRsZXIoc3RyZWFtKTsKICAgIHJldHVybiBwcm9taXNlOwogIH0KICByZXR1cm4gc3RyZWFtOwp9OwoKLy8gQWxsb3cgeW91IHRvIHBpcGUgdGhlIHN0cmVhbSB0byBhIHdyaXRhYmxlIHN0cmVhbS4KUnVubmVyLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24od3JpdGFibGUpIHsKICByZXR1cm4gdGhpcy5zdHJlYW0oKS5waXBlKHdyaXRhYmxlKTsKfTsKCi8vICJSdW5zIiBhIHF1ZXJ5LCByZXR1cm5pbmcgYSBwcm9taXNlLiBBbGwgcXVlcmllcyBzcGVjaWZpZWQgYnkgdGhlIGJ1aWxkZXIgYXJlIGd1YXJhbnRlZWQKLy8gdG8gcnVuIGluIHNlcXVlbmNlLCBhbmQgb24gdGhlIHNhbWUgY29ubmVjdGlvbiwgZXNwZWNpYWxseSBoZWxwZnVsIHdoZW4gc2NoZW1hIGJ1aWxkaW5nCi8vIGFuZCBkZWFsaW5nIHdpdGggZm9yZWlnbiBrZXkgY29uc3RyYWludHMsIGV0Yy4KUnVubmVyLnByb3RvdHlwZS5xdWVyeSA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKG9iaikgewogIGlmICghdGhpcy5jb25uZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIGFuIGVycm9yIHdpdGggdGhlIGRhdGFiYXNlIGNvbm5lY3Rpb24uIFBsZWFzZSBjaGVjayB5b3VyIGNvbmZpZy4nKTsKICB9CiAgb2JqLl9fY2lkID0gdGhpcy5jb25uZWN0aW9uLl9fY2lkOwogIHRoaXMuYnVpbGRlci5lbWl0KCdxdWVyeScsIG9iaik7CiAgdGhpcy5jbGllbnQuZW1pdCgncXVlcnknLCBvYmopOwogIHJldHVybiB0aGlzLl9xdWVyeShvYmopLmJpbmQodGhpcykudGhlbih0aGlzLnByb2Nlc3NSZXNwb25zZSk7Cn0pOwoKLy8gSW4gdGhlIGNhc2Ugb2YgdGhlICJzY2hlbWEgYnVpbGRlciIgd2UgY2FsbCBgcXVlcnlBcnJheWAsIHdoaWNoIHJ1bnMgZWFjaAovLyBvZiB0aGUgcXVlcmllcyBpbiBzZXF1ZW5jZS4KUnVubmVyLnByb3RvdHlwZS5xdWVyeUFycmF5ID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24ocXVlcmllcykgewogIHJldHVybiBxdWVyaWVzLmxlbmd0aCA9PT0gMSA/IHRoaXMucXVlcnkocXVlcmllc1swXSkgOiBQcm9taXNlLmJpbmQodGhpcykKICAgIC50aGVuUmV0dXJuKHF1ZXJpZXMpCiAgICAucmVkdWNlKGZ1bmN0aW9uKG1lbW8sIHF1ZXJ5KSB7CiAgICAgIHJldHVybiB0aGlzLnF1ZXJ5KHF1ZXJ5KS50aGVuKGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBtZW1vLnB1c2gocmVzcCk7CiAgICAgICAgcmV0dXJuIG1lbW87CiAgICAgIH0pOwogICAgfSwgW10pOwp9KTsKCi8vIENoZWNrIHdoZXRoZXIgdGhlcmUncyBhIHRyYW5zYWN0aW9uIGZsYWcsIGFuZCB0aGF0IGl0IGhhcyBhIGNvbm5lY3Rpb24uClJ1bm5lci5wcm90b3R5cGUuZW5zdXJlQ29ubmVjdGlvbiA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKCkgewogIGlmICh0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb24pIHsKICAgIHJldHVybiB0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb247CiAgfQogIHJldHVybiB0aGlzLmNsaWVudC5hY3F1aXJlQ29ubmVjdGlvbigpOwp9KTsKCi8vICJEZWJ1ZyIgdGhlIHF1ZXJ5IGJlaW5nIHJ1bi4KUnVubmVyLnByb3RvdHlwZS5kZWJ1ZyA9IGZ1bmN0aW9uKG9iaikgewogIGNvbnNvbGUuZGlyKF8uZXh0ZW5kKHtfX2NpZDogdGhpcy5jb25uZWN0aW9uLl9fY2lkfSwgb2JqKSk7Cn07CgovLyBDaGVjayB3aGV0aGVyIHdlJ3JlICJkZWJ1Z2dpbmciLCBiYXNlZCBvbiBlaXRoZXIgY2FsbGluZyBgZGVidWdgIG9uIHRoZSBxdWVyeS4KUnVubmVyLnByb3RvdHlwZS5pc0RlYnVnZ2luZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAodGhpcy5jbGllbnQuaXNEZWJ1Z2dpbmcgPT09IHRydWUgfHwgdGhpcy5idWlsZGVyLl9kZWJ1ZyA9PT0gdHJ1ZSk7Cn07CgovLyBUcmFuc2FjdGlvbiBNZXRob2RzOgovLyAtLS0tLS0tCgovLyBSdW4gdGhlIHRyYW5zYWN0aW9uIG9uIHRoZSBjb3JyZWN0ICJydW5uZXIiIGluc3RhbmNlLgpSdW5uZXIucHJvdG90eXBlLnRyYW5zYWN0aW9uUXVlcnkgPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICB2YXIgcnVubmVyID0gdGhpcy5idWlsZGVyLl90cmFuc2FjdGluZy5fcnVubmVyOwogIGlmICghKHJ1bm5lciBpbnN0YW5jZW9mIFJ1bm5lcikpIHsKICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB0cmFuc2FjdGlvbiBvYmplY3QgcHJvdmlkZWQuJyk7CiAgfQogIHZhciBzcWwgPSB0aGlzLmJ1aWxkZXIudG9TUUwoKTsKICBpZiAoXy5pc0FycmF5KHNxbCkpIHsKICAgIHJldHVybiBydW5uZXIucXVlcnlBcnJheShzcWwpOwogIH0KICByZXR1cm4gcnVubmVyLnF1ZXJ5KHNxbCk7Cn0pOwoKLy8gQmVnaW5zIGEgdHJhbnNhY3Rpb24gc3RhdGVtZW50IG9uIHRoZSBpbnN0YW5jZSwKLy8gcmVzb2x2aW5nIHdpdGggdGhlIGN1cnJlbnQgcnVubmVyLgpSdW5uZXIucHJvdG90eXBlLnN0YXJ0VHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbigpIHsKICByZXR1cm4gUHJvbWlzZS5iaW5kKHRoaXMpCiAgICAudGhlbih0aGlzLmVuc3VyZUNvbm5lY3Rpb24pCiAgICAudGhlbihmdW5jdGlvbihjb25uZWN0aW9uKSB7CiAgICAgIHRoaXMuY29ubmVjdGlvbiAgPSBjb25uZWN0aW9uOwogICAgICB0aGlzLnRyYW5zYWN0aW9uID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXMuYmVnaW5UcmFuc2FjdGlvbigpOwogICAgfSkudGhlblJldHVybih0aGlzKTsKfSk7CgovLyBGaW5pc2hlcyB0aGUgdHJhbnNhY3Rpb24gc3RhdGVtZW50IGFuZCBoYW5kbGVzIGRpc3Bvc2luZyBvZiB0aGUgY29ubmVjdGlvbiwKLy8gcmVzb2x2aW5nIC8gcmVqZWN0aW5nIHRoZSB0cmFuc2FjdGlvbidzIHByb21pc2UsIGFuZCBlbnN1cmluZyB0aGUgdHJhbnNhY3Rpb24gb2JqZWN0J3MKLy8gYF9ydW5uZXJgIHByb3BlcnR5IGlzIGBudWxsYCdlZCBvdXQgc28gaXQgY2Fubm90IGNvbnRpbnVlIHRvIGJlIHVzZWQuClJ1bm5lci5wcm90b3R5cGUuZmluaXNoVHJhbnNhY3Rpb24gPSBQcm9taXNlLm1ldGhvZChmdW5jdGlvbihhY3Rpb24sIGNvbnRhaW5lck9iamVjdCwgbXNnKSB7CiAgdmFyIHF1ZXJ5LCBkZmQgPSBjb250YWluZXJPYmplY3QuX19kZmRfXzsKCiAgLy8gUnVuIHRoZSBxdWVyeSB0byBjb21taXQgLyByb2xsYmFjayB0aGUgdHJhbnNhY3Rpb24uCiAgc3dpdGNoIChhY3Rpb24pIHsKICAgIGNhc2UgMDoKICAgICAgcXVlcnkgPSB0aGlzLmNvbW1pdFRyYW5zYWN0aW9uKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICBxdWVyeSA9IHRoaXMucm9sbGJhY2tUcmFuc2FjdGlvbigpOwogICAgICBicmVhazsKICB9CgogIHJldHVybiBxdWVyeS50aGVuKGZ1bmN0aW9uKHJlc3ApIHsKICAgIG1zZyA9IChtc2cgPT09IHZvaWQgMCkgPyByZXNwIDogbXNnOwogICAgc3dpdGNoIChhY3Rpb24pIHsKICAgICAgY2FzZSAwOgogICAgICAgIGRmZC5mdWxmaWxsKG1zZyk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICBkZmQucmVqZWN0KG1zZyk7CiAgICAgICAgYnJlYWs7CiAgICB9CgogIC8vIElmIHRoZXJlIHdhcyBhIHByb2JsZW0gY29tbWl0dGluZyB0aGUgdHJhbnNhY3Rpb24sCiAgLy8gcmVqZWN0IHRoZSB0cmFuc2FjdGlvbiBibG9jayAodG8gcmVqZWN0IHRoZSBlbnRpcmUgdHJhbnNhY3Rpb24gYmxvY2spLAogIC8vIHRoZW4gcmUtdGhyb3cgdGhlIGVycm9yIGZvciBhbnkgcHJvbWlzZXMgY2hhaW5lZCBvZmYgdGhlIGNvbW1pdC4KICB9KS5jYXRjaChmdW5jdGlvbihlKSB7CiAgICBkZmQucmVqZWN0KGUpOwogICAgdGhyb3cgZTsKICB9KS5iaW5kKHRoaXMpLmZpbmFsbHkoZnVuY3Rpb24oKSB7CgogICAgLy8gS2lsbCB0aGUgIl9ydW5uZXIiIG9iamVjdCBvbiB0aGUgY29udGFpbmVyT2JqZWN0LAogICAgLy8gc28gaXQncyBub3QgcG9zc2libGUgdG8gY29udGludWUgdXNpbmcgdGhlIHRyYW5zYWN0aW9uIG9iamVjdC4KICAgIGNvbnRhaW5lck9iamVjdC5fcnVubmVyID0gdm9pZCAwOwoKICAgIHJldHVybiB0aGlzLmNsZWFudXBDb25uZWN0aW9uKCk7CiAgfSk7Cn0pOwoKUnVubmVyLnByb3RvdHlwZS5iZWdpblRyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2JlZ2luVHJhbnNhY3Rpb24gICAmJiB0aGlzLnF1ZXJ5KHtzcWw6IHRoaXMuX2JlZ2luVHJhbnNhY3Rpb259KTsKfTsKUnVubmVyLnByb3RvdHlwZS5jb21taXRUcmFuc2FjdGlvbiA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9jb21taXRUcmFuc2FjdGlvbiAgICYmIHRoaXMucXVlcnkoe3NxbDogdGhpcy5fY29tbWl0VHJhbnNhY3Rpb259KTsKfTsKUnVubmVyLnByb3RvdHlwZS5yb2xsYmFja1RyYW5zYWN0aW9uID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX3JvbGxiYWNrVHJhbnNhY3Rpb24gJiYgdGhpcy5xdWVyeSh7c3FsOiB0aGlzLl9yb2xsYmFja1RyYW5zYWN0aW9ufSk7Cn07CgovLyBDbGVhbnVwIHRoZSBjb25uZWN0aW9uIGFzIG5lY2Vzc2FyeSwgaWYgdGhlIGBfY29ubmVjdGlvbmAgd2FzCi8vIGV4cGxpY2l0bHkgc2V0IG9uIHRoZSBxdWVyeSB3ZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nIGhlcmUsCi8vIG90aGVyd2lzZSB3ZQpSdW5uZXIucHJvdG90eXBlLmNsZWFudXBDb25uZWN0aW9uID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oKSB7CiAgaWYgKCF0aGlzLmJ1aWxkZXIuX2Nvbm5lY3Rpb24gJiYgdHlwZW9mIHRoaXMuY29ubmVjdGlvbiAhPT0gInVuZGVmaW5lZCIpIHsKICAgIHJldHVybiB0aGlzLmNsaWVudC5yZWxlYXNlQ29ubmVjdGlvbih0aGlzLmNvbm5lY3Rpb24pOwogIH0KfSk7Cgptb2R1bGUuZXhwb3J0cyA9IFJ1bm5lcjsKCn0seyIuL3Byb21pc2UiOjEwMywibG9kYXNoIjoxMzAsInJlYWRhYmxlLXN0cmVhbSI6MTI5fV0sMTEwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKdmFyIF8gICAgICAgICAgICA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp2YXIgaW5oZXJpdHMgICAgID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKdmFyIEV2ZW50RW1pdHRlciA9IHJlcXVpcmUoJ2V2ZW50cycpLkV2ZW50RW1pdHRlcjsKCi8vIENvbnN0cnVjdG9yIGZvciB0aGUgYnVpbGRlciBpbnN0YW5jZSwgdHlwaWNhbGx5IGNhbGxlZCBmcm9tCi8vIGBrbmV4LmJ1aWxkZXJgLCBhY2NlcHRpbmcgdGhlIGN1cnJlbnQgYGtuZXhgIGluc3RhbmNlLAovLyBhbmQgcHVsbGluZyBvdXQgdGhlIGBjbGllbnRgIGFuZCBgZ3JhbW1hcmAgZnJvbSB0aGUgY3VycmVudAovLyBrbmV4IGluc3RhbmNlLgpmdW5jdGlvbiBTY2hlbWFCdWlsZGVyKCkgewogIHRoaXMuX3NlcXVlbmNlID0gW107CiAgdGhpcy5fZXJyb3JzID0gW107Cn0KaW5oZXJpdHMoU2NoZW1hQnVpbGRlciwgRXZlbnRFbWl0dGVyKTsKCi8vIEVhY2ggb2YgdGhlIHNjaGVtYSBidWlsZGVyIG1ldGhvZHMganVzdCBhZGQgdG8gdGhlCi8vICJfc2VxdWVuY2UiIGFycmF5IGZvciBjb25zaXN0ZW5jeS4KXy5lYWNoKFsKICAnY3JlYXRlVGFibGUnLCAnY3JlYXRlVGFibGVJZk5vdEV4aXN0cycsICdjcmVhdGVTY2hlbWEnLAogICdjcmVhdGVTY2hlbWFJZk5vdEV4aXN0cycsICdkcm9wU2NoZW1hJywgJ2Ryb3BTY2hlbWFJZkV4aXN0cycsCiAgJ3RhYmxlJywgJ2FsdGVyVGFibGUnLCAnaGFzVGFibGUnLCAnaGFzQ29sdW1uJywKICAnZHJvcFRhYmxlJywgJ3JlbmFtZVRhYmxlJywgJ2Ryb3BUYWJsZUlmRXhpc3RzJywgJ3JhdycsICdkZWJ1ZycKXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgU2NoZW1hQnVpbGRlci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKG1ldGhvZCA9PT0gJ3RhYmxlJykgbWV0aG9kID0gJ2FsdGVyVGFibGUnOwogICAgdGhpcy5fc2VxdWVuY2UucHVzaCh7CiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBhcmdzOiBfLnRvQXJyYXkoYXJndW1lbnRzKQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKClNjaGVtYUJ1aWxkZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMudG9RdWVyeSgpOwp9OwoKU2NoZW1hQnVpbGRlci5wcm90b3R5cGUudG9TUUwgPSBmdW5jdGlvbigpIHsKICB2YXIgU2NoZW1hQ29tcGlsZXIgPSB0aGlzLmNsaWVudC5TY2hlbWFDb21waWxlcjsKICByZXR1cm4gbmV3IFNjaGVtYUNvbXBpbGVyKHRoaXMpLnRvU1FMKCk7Cn07CgpyZXF1aXJlKCcuLi9pbnRlcmZhY2UnKShTY2hlbWFCdWlsZGVyKTsKCm1vZHVsZS5leHBvcnRzID0gU2NoZW1hQnVpbGRlcjsKCn0seyIuLi9pbnRlcmZhY2UiOjEwMCwiZXZlbnRzIjo1NywiaW5oZXJpdHMiOjc2LCJsb2Rhc2giOjEzMH1dLDExMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cgp2YXIgQWx0ZXJNZXRob2RzID0ge307CgovLyBTcGVjaWZ5IHRoYXQgdGhlIGNvbHVtbiBpcyB0byBiZSBkcm9wcGVkLiBUaGlzIHRha2VzIHByZWNlZGVuY2UKLy8gb3ZlciBhbGwgb3RoZXIgcnVsZXMgZm9yIHRoZSBjb2x1bW4uCkFsdGVyTWV0aG9kcy5kcm9wID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5fc2luZ2xlLmRyb3AgPSB0cnVlOwogIHJldHVybiB0aGlzOwp9OwoKLy8gU3BlY2lmeSB0aGUgInR5cGUiIHRoYXQgd2UncmUgbG9va2luZyB0byBzZXQgdGhlCi8vIEtuZXggdGFrZXMgbm8gcmVzcG9uc2liaWxpdHkgZm9yIGFueSBkYXRhLWxvc3MgdGhhdCBtYXkKLy8gb2NjdXIgd2hlbiBjaGFuZ2luZyBkYXRhIHR5cGVzLgpBbHRlck1ldGhvZHMuYWx0ZXJUeXBlID0gZnVuY3Rpb24odHlwZSkgewogIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICBncm91cGluZzogJ2FsdGVyVHlwZScsCiAgICB2YWx1ZTogdHlwZQogIH0pOwogIHJldHVybiB0aGlzOwp9OwoKLy8gQWxsIG9mIHRoZSBtb2RpZmllciBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgdG8gbW9kaWZ5IHRoZSBjdXJyZW50IHF1ZXJ5Lgp2YXIgbW9kaWZpZXJzID0gWwogICdkZWZhdWx0JywgJ2RlZmF1bHRzVG8nLCAnZGVmYXVsdFRvJywgJ3Vuc2lnbmVkJywKICAnbnVsbGFibGUnLCAnbm90TnVsbCcsICdub3ROdWxsYWJsZScsCiAgJ2ZpcnN0JywgJ2FmdGVyJywgJ2NvbW1lbnQnCl07CgovLyBBbGlhc2VzIGZvciBjb252ZW5pZW5jZS4KdmFyIGFsaWFzTWV0aG9kID0gewogIGRlZmF1bHQ6ICdkZWZhdWx0VG8nLAogIGRlZmF1bHRzVG86ICdkZWZhdWx0VG8nLAogIG5vdE51bGw6ICdub3ROdWxsYWJsZScKfTsKCi8vIEFsaWFzIGEgZmV3IG1ldGhvZHMgZm9yIGNsYXJpdHkgd2hlbiBwcm9jZXNzaW5nLgp2YXIgY29sdW1uQWxpYXMgPSB7CiAgJ2Zsb2F0JyAgOiAnZmxvYXRpbmcnLAogICdlbnVtJyAgIDogJ2VudScsCiAgJ2Jvb2xlYW4nOiAnYm9vbCcsCiAgJ3N0cmluZycgOiAndmFyY2hhcicsCiAgJ2JpZ2ludCcgOiAnYmlnSW50ZWdlcicKfTsKCi8vIFRoZSBjaGFpbmFibGUgaW50ZXJmYWNlIG9mZiB0aGUgb3JpZ2luYWwgImNvbHVtbiIgbWV0aG9kLgpmdW5jdGlvbiBDb2x1bW5CdWlsZGVyKHRhYmxlQnVpbGRlciwgdHlwZSwgYXJncykgewogIHRoaXMuX3NpbmdsZSAgICAgICA9IHt9OwogIHRoaXMuX21vZGlmaWVycyAgICA9IHt9OwogIHRoaXMuX3N0YXRlbWVudHMgICA9IFtdOwogIHRoaXMuX3R5cGUgICAgICAgICA9IGNvbHVtbkFsaWFzW3R5cGVdIHx8IHR5cGU7CiAgdGhpcy5fYXJncyAgICAgICAgID0gYXJnczsKICB0aGlzLl90YWJsZUJ1aWxkZXIgPSB0YWJsZUJ1aWxkZXI7CgogIC8vIElmIHdlJ3JlIGFsdGVyaW5nIHRoZSB0YWJsZSwgZXh0ZW5kIHRoZSBvYmplY3QKICAvLyB3aXRoIHRoZSBhdmFpbGFibGUgImFsdGVyIiBtZXRob2RzLgogIGlmICh0YWJsZUJ1aWxkZXIuX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgXy5leHRlbmQodGhpcywgQWx0ZXJNZXRob2RzKTsKICB9Cn0KCi8vIElmIHdlIGNhbGwgYW55IG9mIHRoZSBtb2RpZmllcnMgKGluZGV4IG9yIG90aGVyd2lzZSkgb24gdGhlIGNoYWluYWJsZSwgd2UgcHJldGVuZAovLyBhcyB0aG91Z2ggd2UncmUgY2FsbGluZyBgdGFibGUubWV0aG9kKGNvbHVtbilgIGRpcmVjdGx5LgpfLmVhY2gobW9kaWZpZXJzLCBmdW5jdGlvbihtZXRob2QpIHsKICBDb2x1bW5CdWlsZGVyLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoYWxpYXNNZXRob2RbbWV0aG9kXSkgewogICAgICBtZXRob2QgPSBhbGlhc01ldGhvZFttZXRob2RdOwogICAgfQogICAgaWYgKG1ldGhvZCA9PT0gJ25vdE51bGxhYmxlJykgcmV0dXJuIHRoaXMubnVsbGFibGUoZmFsc2UpOwogICAgdGhpcy5fbW9kaWZpZXJzW21ldGhvZF0gPSBfLnRvQXJyYXkoYXJndW1lbnRzKTsKICAgIHJldHVybiB0aGlzOwogIH07Cn0pOwoKXy5lYWNoKFsnaW5kZXgnLCAncHJpbWFyeScsICd1bmlxdWUnXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgQ29sdW1uQnVpbGRlci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX3R5cGUudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpbmNyZW1lbnRzJykgPT09IC0xKSB7CiAgICAgIHRoaXMuX3RhYmxlQnVpbGRlclttZXRob2RdLmFwcGx5KHRoaXMuX3RhYmxlQnVpbGRlciwKICAgICAgICBbdGhpcy5fYXJnc1swXV0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKCi8vIFNwZWNpZnkgdGhhdCB0aGUgY3VycmVudCBjb2x1bW4gInJlZmVyZW5jZXMiIGEgY29sdW1uLAovLyB3aGljaCBtYXkgYmUgdGFibGVOYW1lLmNvbHVtbiBvciBqdXN0ICJjb2x1bW4iCkNvbHVtbkJ1aWxkZXIucHJvdG90eXBlLnJlZmVyZW5jZXMgPSBmdW5jdGlvbih2YWx1ZSkgewogIHJldHVybiB0aGlzLl90YWJsZUJ1aWxkZXIuZm9yZWlnbi5jYWxsKHRoaXMuX3RhYmxlQnVpbGRlciwgdGhpcy5fYXJnc1swXSwgdGhpcykKICAgIC5fY29sdW1uQnVpbGRlcih0aGlzKQogICAgLnJlZmVyZW5jZXModmFsdWUpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBDb2x1bW5CdWlsZGVyOwoKfSx7ImxvZGFzaCI6MTMwfV0sMTEyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gQ29sdW1uIENvbXBpbGVyCi8vIFVzZWQgZm9yIGRlc2lnbmF0aW5nIGNvbHVtbiBkZWZpbml0aW9ucwovLyBkdXJpbmcgdGhlIHRhYmxlICJjcmVhdGUiIC8gImFsdGVyIiBzdGF0ZW1lbnRzLgovLyAtLS0tLS0tCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CnZhciBSYXcgPSByZXF1aXJlKCcuLi9yYXcnKTsKCmZ1bmN0aW9uIENvbHVtbkNvbXBpbGVyKHRhYmxlQ29tcGlsZXIsIGNvbHVtbkJ1aWxkZXIpIHsKICB0aGlzLnRhYmxlQ29tcGlsZXIgPSB0YWJsZUNvbXBpbGVyOwogIHRoaXMuY29sdW1uQnVpbGRlciA9IGNvbHVtbkJ1aWxkZXI7CiAgdGhpcy5hcmdzID0gY29sdW1uQnVpbGRlci5fYXJnczsKICB0aGlzLnR5cGUgPSBjb2x1bW5CdWlsZGVyLl90eXBlLnRvTG93ZXJDYXNlKCk7CiAgdGhpcy5ncm91cGVkID0gXy5ncm91cEJ5KGNvbHVtbkJ1aWxkZXIuX3N0YXRlbWVudHMsICdncm91cGluZycpOwogIHRoaXMubW9kaWZpZWQgPSBjb2x1bW5CdWlsZGVyLl9tb2RpZmllcnM7CiAgdGhpcy5pc0luY3JlbWVudHMgPSAodGhpcy50eXBlLmluZGV4T2YoJ2luY3JlbWVudHMnKSAhPT0gLTEpOwogIHRoaXMuaW5pdENvbXBpbGVyKCk7Cn0KCi8vIFRvIGNvbnZlcnQgdG8gc3FsLCB3ZSBmaXJzdCBnbyB0aHJvdWdoIGFuZCBidWlsZCB0aGUKLy8gY29sdW1uIGFzIGl0IHdvdWxkIGJlIGluIHRoZSBpbnNlcnQgc3RhdGVtZW50CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHRoaXMucHVzaFF1ZXJ5KHRoaXMuY29tcGlsZUNvbHVtbigpKTsKICBpZiAodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsKSB7CiAgICB0aGlzLnNlcXVlbmNlID0gdGhpcy5zZXF1ZW5jZS5jb25jYXQodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsKTsKICB9CiAgcmV0dXJuIHRoaXMuc2VxdWVuY2U7Cn07CgovLyBDb21waWxlcyBhIGNvbHVtbi4KQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmNvbXBpbGVDb2x1bW4gPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5mb3JtYXR0ZXIud3JhcCh0aGlzLmdldENvbHVtbk5hbWUoKSkgKyAnICcgKwogICAgdGhpcy5nZXRDb2x1bW5UeXBlKCkgKyB0aGlzLmdldE1vZGlmaWVycygpOwp9OwoKLy8gQXNzdW1lcyB0aGUgYXV0b2luY3JlbWVudGluZyBrZXkgaXMgbmFtZWQgYGlkYCBpZiBub3Qgb3RoZXJ3aXNlIHNwZWNpZmllZC4KQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbk5hbWUgPSBmdW5jdGlvbigpIHsKICB2YXIgdmFsdWUgPSBfLmZpcnN0KHRoaXMuYXJncyk7CiAgaWYgKHZhbHVlKSByZXR1cm4gdmFsdWU7CiAgaWYgKHRoaXMuaXNJbmNyZW1lbnRzKSB7CiAgICByZXR1cm4gJ2lkJzsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgZGlkIG5vdCBzcGVjaWZ5IGEgY29sdW1uIG5hbWUgZm9yIHRoZSAnICsgdGhpcy50eXBlICsgJ2NvbHVtbi4nKTsKICB9Cn07CgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZ2V0Q29sdW1uVHlwZSA9IGZ1bmN0aW9uKCkgewogIHZhciB0eXBlID0gdGhpc1t0aGlzLnR5cGVdOwogIHJldHVybiBfLmlzRnVuY3Rpb24odHlwZSkgPyB0eXBlLmFwcGx5KHRoaXMsIF8ucmVzdCh0aGlzLmFyZ3MpKSA6IHR5cGU7Cn07CgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZ2V0TW9kaWZpZXJzID0gZnVuY3Rpb24oKSB7CiAgdmFyIG1vZGlmaWVycyA9IFtdOwogIGlmICh0aGlzLnR5cGUuaW5kZXhPZignaW5jcmVtZW50cycpID09PSAtMSkgewogICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGlmaWVycy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgdmFyIG1vZGlmaWVyID0gdGhpcy5tb2RpZmllcnNbaV07CiAgICAgIGlmIChfLmhhcyh0aGlzLm1vZGlmaWVkLCBtb2RpZmllcikpIHsKICAgICAgICB2YXIgdmFsID0gdGhpc1ttb2RpZmllcl0uYXBwbHkodGhpcywgdGhpcy5tb2RpZmllZFttb2RpZmllcl0pOwogICAgICAgIGlmICh2YWwpIG1vZGlmaWVycy5wdXNoKHZhbCk7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1vZGlmaWVycy5sZW5ndGggPiAwID8gJyAnICsgbW9kaWZpZXJzLmpvaW4oJyAnKSA6ICcnOwp9OwoKLy8gVHlwZXMKLy8gLS0tLS0tCgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuaW5jcmVtZW50cyA9ICdpbnRlZ2VyIG5vdCBudWxsIHByaW1hcnkga2V5IGF1dG9pbmNyZW1lbnQnOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuYmlnaW5jcmVtZW50cyA9ICdpbnRlZ2VyIG5vdCBudWxsIHByaW1hcnkga2V5IGF1dG9pbmNyZW1lbnQnOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuaW50ZWdlciA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5zbWFsbGludCA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5tZWRpdW1pbnQgPSAnaW50ZWdlcic7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaWdpbnRlZ2VyID0gJ2JpZ2ludCc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS52YXJjaGFyID0gZnVuY3Rpb24obGVuZ3RoKSB7CiAgcmV0dXJuICd2YXJjaGFyKCcgKyB0aGlzLl9udW0obGVuZ3RoLCAyNTUpICsgJyknOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUudGV4dCA9ICd0ZXh0JzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnRpbnlpbnQgPSAndGlueWludCc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5mbG9hdGluZyA9IGZ1bmN0aW9uKHByZWNpc2lvbiwgc2NhbGUpIHsKICByZXR1cm4gJ2Zsb2F0KCcgKyB0aGlzLl9udW0ocHJlY2lzaW9uLCA4KSArICcsICcgKyB0aGlzLl9udW0oc2NhbGUsIDIpICsgJyknOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZGVjaW1hbCA9IGZ1bmN0aW9uKHByZWNpc2lvbiwgc2NhbGUpIHsKICByZXR1cm4gJ2RlY2ltYWwoJyArIHRoaXMuX251bShwcmVjaXNpb24sIDgpICsgJywgJyArIHRoaXMuX251bShzY2FsZSwgMikgKyAnKSc7Cn07CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaW5hcnkgPSAnYmxvYic7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5ib29sID0gJ2Jvb2xlYW4nOwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuZGF0ZSA9ICdkYXRlJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmRhdGV0aW1lID0gJ2RhdGV0aW1lJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnRpbWUgPSAndGltZSc7CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS50aW1lc3RhbXAgPSAndGltZXN0YW1wJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLmVudSA9ICd2YXJjaGFyJzsKCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5iaXQgPQpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuanNvbiA9ICd0ZXh0JzsKCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS51dWlkID0gJ2NoYXIoMzYpJzsKQ29sdW1uQ29tcGlsZXIucHJvdG90eXBlLnNwZWNpZmljdHlwZSA9IGZ1bmN0aW9uKHR5cGUpIHsKICByZXR1cm4gdHlwZTsKfTsKCi8vIE1vZGlmaWVycwovLyAtLS0tLS0tCgpDb2x1bW5Db21waWxlci5wcm90b3R5cGUubnVsbGFibGUgPSBmdW5jdGlvbihudWxsYWJsZSkgewogIHJldHVybiBudWxsYWJsZSA9PT0gZmFsc2UgPyAnbm90IG51bGwnIDogJ251bGwnOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUubm90TnVsbGFibGUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5udWxsYWJsZShmYWxzZSk7Cn07CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5kZWZhdWx0VG8gPSBmdW5jdGlvbih2YWx1ZSkgewogIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gJyc7CiAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgdmFsdWUgPSAibnVsbCI7CiAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJhdykgewogICAgdmFsdWUgPSB2YWx1ZS50b1F1ZXJ5KCk7CiAgfSBlbHNlIGlmICh0aGlzLnR5cGUgPT09ICdib29sJykgewogICAgaWYgKHZhbHVlID09PSAnZmFsc2UnKSB2YWx1ZSA9IDA7CiAgICB2YWx1ZSA9ICInIiArICh2YWx1ZSA/IDEgOiAwKSArICInIjsKICB9IGVsc2UgaWYgKHRoaXMudHlwZSA9PT0gJ2pzb24nICYmIF8uaXNPYmplY3QodmFsdWUpKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB2YWx1ZSA9ICInIiArIHZhbHVlICsgIiciOwogIH0KICByZXR1cm4gJ2RlZmF1bHQgJyArIHZhbHVlOwp9OwpDb2x1bW5Db21waWxlci5wcm90b3R5cGUuX251bSA9IGZ1bmN0aW9uKHZhbCwgZmFsbGJhY2spIHsKICBpZiAodmFsID09PSB1bmRlZmluZWQgfHwgdmFsID09PSBudWxsKSByZXR1cm4gZmFsbGJhY2s7CiAgdmFyIG51bWJlciA9IHBhcnNlSW50KHZhbCwgMTApOwogIHJldHVybiBpc05hTihudW1iZXIpID8gZmFsbGJhY2sgOiBudW1iZXI7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IENvbHVtbkNvbXBpbGVyOwoKfSx7Ii4uL3JhdyI6MTA4LCJsb2Rhc2giOjEzMH1dLDExMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFRoZSAiU2NoZW1hQ29tcGlsZXIiIHRha2VzIGFsbCBvZiB0aGUgcXVlcnkgc3RhdGVtZW50cyB3aGljaCBoYXZlIGJlZW4KLy8gZ2F0aGVyZWQgaW4gdGhlICJTY2hlbWFCdWlsZGVyIiBhbmQgdHVybnMgdGhlbSBpbnRvIGFuIGFycmF5IG9mCi8vIHByb3Blcmx5IGZvcm1hdHRlZCAvIGJvdW5kIHF1ZXJ5IHN0cmluZ3MuCmZ1bmN0aW9uIFNjaGVtYUNvbXBpbGVyKGJ1aWxkZXIpIHsKICB0aGlzLmJ1aWxkZXIgPSBidWlsZGVyOwogIHRoaXMuaW5pdENvbXBpbGVyKCk7Cn0KCmZ1bmN0aW9uIGJ1aWxkVGFibGUodHlwZSkgewogIHJldHVybiBmdW5jdGlvbih0YWJsZU5hbWUsIGZuKSB7CiAgICB2YXIgVGFibGVCdWlsZGVyID0gdGhpcy5jbGllbnQuVGFibGVCdWlsZGVyOwogICAgdmFyIHNxbCA9IG5ldyBUYWJsZUJ1aWxkZXIodHlwZSwgdGFibGVOYW1lLCBmbikudG9TUUwoKTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gc3FsLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB0aGlzLnNlcXVlbmNlLnB1c2goc3FsW2ldKTsKICAgIH0KICB9Owp9CgpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuY3JlYXRlVGFibGUgPSBidWlsZFRhYmxlKCdjcmVhdGUnKTsKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZVRhYmxlSWZOb3RFeGlzdHMgPSBidWlsZFRhYmxlKCdjcmVhdGVJZk5vdCcpOwpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuYWx0ZXJUYWJsZSAgPSBidWlsZFRhYmxlKCdhbHRlcicpOwoKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLmRyb3BUYWJsZSA9IGZ1bmN0aW9uKHRhYmxlTmFtZSkgewogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIHRhYmxlICcgKyB0aGlzLmZvcm1hdHRlci53cmFwKHRhYmxlTmFtZSkpOwp9OwpTY2hlbWFDb21waWxlci5wcm90b3R5cGUuZHJvcFRhYmxlSWZFeGlzdHMgPSBmdW5jdGlvbih0YWJsZU5hbWUpIHsKICB0aGlzLnB1c2hRdWVyeSgnZHJvcCB0YWJsZSBpZiBleGlzdHMgJyArIHRoaXMuZm9ybWF0dGVyLndyYXAodGFibGVOYW1lKSk7Cn07ClNjaGVtYUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHZhciBzZXF1ZW5jZSA9IHRoaXMuYnVpbGRlci5fc2VxdWVuY2U7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBzZXF1ZW5jZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBxdWVyeSA9IHNlcXVlbmNlW2ldOwogICAgdGhpc1txdWVyeS5tZXRob2RdLmFwcGx5KHRoaXMsIHF1ZXJ5LmFyZ3MpOwogIH0KICByZXR1cm4gdGhpcy5zZXF1ZW5jZTsKfTsKU2NoZW1hQ29tcGlsZXIucHJvdG90eXBlLnJhdyA9IGZ1bmN0aW9uKHNxbCwgYmluZGluZ3MpIHsKICB0aGlzLnNlcXVlbmNlLnB1c2gobmV3IHRoaXMuY2xpZW50LlJhdyhzcWwsIGJpbmRpbmdzKS50b1NRTCgpKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gU2NoZW1hQ29tcGlsZXI7Cn0se31dLDExNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cgp2YXIgQnVpbGRlciA9IHJlcXVpcmUoJy4vYnVpbGRlcicpOwp2YXIgQ29tcGlsZXIgPSByZXF1aXJlKCcuL2NvbXBpbGVyJyk7CnZhciBUYWJsZUJ1aWxkZXIgPSByZXF1aXJlKCcuL3RhYmxlYnVpbGRlcicpOwp2YXIgVGFibGVDb21waWxlciA9IHJlcXVpcmUoJy4vdGFibGVjb21waWxlcicpOwp2YXIgQ29sdW1uQnVpbGRlciA9IHJlcXVpcmUoJy4vY29sdW1uYnVpbGRlcicpOwp2YXIgQ29sdW1uQ29tcGlsZXIgPSByZXF1aXJlKCcuL2NvbHVtbmNvbXBpbGVyJyk7CgovLyBJbml0aWFsaXplIHRoZSBjb21waWxlci4KQ29tcGlsZXIucHJvdG90eXBlLmluaXRDb21waWxlciA9ClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmluaXRDb21waWxlciA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5pbml0Q29tcGlsZXIgPSBmdW5jdGlvbigpIHsKICB0aGlzLmZvcm1hdHRlciA9IG5ldyB0aGlzLkZvcm1hdHRlcigpOwogIHRoaXMuc2VxdWVuY2UgID0gW107Cn07CgovLyBQdXNoIGEgbmV3IHF1ZXJ5IG9udG8gdGhlIGNvbXBpbGVkICJzZXF1ZW5jZSIgc3RhY2ssCi8vIGNyZWF0aW5nIGEgbmV3IGZvcm1hdHRlciwgcmV0dXJuaW5nIHRoZSBjb21waWxlci4KQ29tcGlsZXIucHJvdG90eXBlLnB1c2hRdWVyeSA9ClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnB1c2hRdWVyeSA9CkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5wdXNoUXVlcnkgPSBmdW5jdGlvbihxdWVyeSkgewogIGlmICghcXVlcnkpIHJldHVybjsKICBpZiAoXy5pc1N0cmluZyhxdWVyeSkpIHsKICAgIHF1ZXJ5ID0ge3NxbDogcXVlcnl9OwogIH0gZWxzZSB7CiAgICBxdWVyeSA9IHF1ZXJ5OwogIH0KICBpZiAoIXF1ZXJ5LmJpbmRpbmdzKSB7CiAgICBxdWVyeS5iaW5kaW5ncyA9IHRoaXMuZm9ybWF0dGVyLmJpbmRpbmdzOwogIH0KICB0aGlzLnNlcXVlbmNlLnB1c2gocXVlcnkpOwogIHRoaXMuZm9ybWF0dGVyID0gbmV3IHRoaXMuRm9ybWF0dGVyKCk7Cn07CgovLyBVc2VkIGluIGNhc2VzIHdoZXJlIHdlIG5lZWQgdG8gcHVzaCBzb21lIGFkZGl0aW9uYWwgY29sdW1uIHNwZWNpZmljIHN0YXRlbWVudHMuCkNvbHVtbkNvbXBpbGVyLnByb3RvdHlwZS5wdXNoQWRkaXRpb25hbCA9IGZ1bmN0aW9uKGZuKSB7CiAgdmFyIGNoaWxkID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy50YWJsZUNvbXBpbGVyLCB0aGlzLmNvbHVtbkJ1aWxkZXIpOwogIGZuLmNhbGwoY2hpbGQsIF8ucmVzdChhcmd1bWVudHMpKTsKICB0aGlzLnNlcXVlbmNlLmFkZGl0aW9uYWwgPSAodGhpcy5zZXF1ZW5jZS5hZGRpdGlvbmFsIHx8IFtdKS5jb25jYXQoY2hpbGQuc2VxdWVuY2UpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSB7CiAgQnVpbGRlcjogQnVpbGRlciwKICBDb21waWxlcjogQ29tcGlsZXIsCiAgVGFibGVCdWlsZGVyOiBUYWJsZUJ1aWxkZXIsCiAgVGFibGVDb21waWxlcjogVGFibGVDb21waWxlciwKICBDb2x1bW5CdWlsZGVyOiBDb2x1bW5CdWlsZGVyLAogIENvbHVtbkNvbXBpbGVyOiBDb2x1bW5Db21waWxlcgp9Owp9LHsiLi9idWlsZGVyIjoxMTAsIi4vY29sdW1uYnVpbGRlciI6MTExLCIuL2NvbHVtbmNvbXBpbGVyIjoxMTIsIi4vY29tcGlsZXIiOjExMywiLi90YWJsZWJ1aWxkZXIiOjExNSwiLi90YWJsZWNvbXBpbGVyIjoxMTYsImxvZGFzaCI6MTMwfV0sMTE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gVGFibGVCdWlsZGVyCgovLyBUYWtlcyB0aGUgZnVuY3Rpb24gcGFzc2VkIHRvIHRoZSAiY3JlYXRlVGFibGUiIG9yICJ0YWJsZS9lZGl0VGFibGUiCi8vIGZ1bmN0aW9ucyBhbmQgY2FsbHMgaXQgd2l0aCB0aGUgIlRhYmxlQnVpbGRlciIgYXMgYm90aCB0aGUgY29udGV4dCBhbmQKLy8gdGhlIGZpcnN0IGFyZ3VtZW50LiBJbnNpZGUgdGhpcyBmdW5jdGlvbiB3ZSBjYW4gc3BlY2lmeSB3aGF0IGhhcHBlbnMgdG8gdGhlCi8vIG1ldGhvZCwgcHVzaGluZyBldmVyeXRoaW5nIHdlIHdhbnQgdG8gZG8gb250byB0aGUgImFsbFN0YXRlbWVudHMiIGFycmF5LAovLyB3aGljaCBpcyB0aGVuIGNvbXBpbGVkIGludG8gc3FsLgovLyAtLS0tLS0KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIGhlbHBlcnMgPSByZXF1aXJlKCcuLi9oZWxwZXJzJyk7Cgp2YXIgQWx0ZXJNZXRob2RzID0gewoKICAvLyBSZW5hbWVzIHRoZSBjdXJyZW50IGNvbHVtbiBgZnJvbWAgdGhlIGN1cnJlbnQKICAvLyBUT0RPOiB0aGlzLmNvbHVtbihmcm9tKS5yZW5hbWUodG8pCiAgcmVuYW1lQ29sdW1uOiBmdW5jdGlvbihmcm9tLCB0bykgewogICAgdGhpcy5fc3RhdGVtZW50cy5wdXNoKHsKICAgICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgICAgbWV0aG9kOiAncmVuYW1lQ29sdW1uJywKICAgICAgYXJnczogW2Zyb20sIHRvXQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9LAoKICBkcm9wVGltZXN0YW1wczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5kcm9wQ29sdW1ucyhbJ2NyZWF0ZWRfYXQnLCAndXBkYXRlZF9hdCddKTsKICB9CgogIC8vIFRPRE86IGNoYW5nZVR5cGUKfTsKCi8vIERyb3AgYSBjb2x1bW4gZnJvbSB0aGUgY3VycmVudCB0YWJsZS4KLy8gVE9ETzogRW5hYmxlIHRoaXMuY29sdW1uKGNvbHVtbk5hbWUpLmRyb3AoKTsKQWx0ZXJNZXRob2RzLmRyb3BDb2x1bW4gPQpBbHRlck1ldGhvZHMuZHJvcENvbHVtbnMgPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgIG1ldGhvZDogJ2Ryb3BDb2x1bW4nLAogICAgYXJnczogXy50b0FycmF5KGFyZ3VtZW50cykKICB9KTsKICByZXR1cm4gdGhpczsKfTsKCmZ1bmN0aW9uIFRhYmxlQnVpbGRlcihtZXRob2QsIHRhYmxlTmFtZSwgZm4pIHsKICB0aGlzLl9mbiAgICAgICAgID0gZm47CiAgdGhpcy5fbWV0aG9kICAgICA9IG1ldGhvZDsKICB0aGlzLl90YWJsZU5hbWUgID0gdGFibGVOYW1lOwogIHRoaXMuX3N0YXRlbWVudHMgPSBbXTsKICB0aGlzLl9zaW5nbGUgICAgID0ge307Cn0KCi8vIENvbnZlcnQgdGhlIGN1cnJlbnQgdGFibGVCdWlsZGVyIG9iamVjdCAidG9TUUwiCi8vIGdpdmluZyB1cyBhZGRpdGlvbmFsIG1ldGhvZHMgaWYgd2UncmUgYWx0ZXJpbmcKLy8gcmF0aGVyIHRoYW4gY3JlYXRpbmcgdGhlIHRhYmxlLgpUYWJsZUJ1aWxkZXIucHJvdG90eXBlLnRvU1FMID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgXy5leHRlbmQodGhpcywgQWx0ZXJNZXRob2RzKTsKICB9CiAgdGhpcy5fZm4uY2FsbCh0aGlzLCB0aGlzKTsKICB2YXIgVGFibGVDb21waWxlciA9IHRoaXMuY2xpZW50LlRhYmxlQ29tcGlsZXI7CiAgcmV0dXJuIG5ldyBUYWJsZUNvbXBpbGVyKHRoaXMpLnRvU1FMKCk7Cn07CgpfLmVhY2goWwoKICAvLyBFYWNoIG9mIHRoZSBpbmRleCBtZXRob2RzIGNhbiBiZSBjYWxsZWQgaW5kaXZpZHVhbGx5LCB3aXRoIHRoZQogIC8vIGNvbHVtbiBuYW1lIHRvIGJlIHVzZWQsIGUuZy4gdGFibGUudW5pcXVlKCdjb2x1bW4nKS4KICAnaW5kZXgnLCAncHJpbWFyeScsICd1bmlxdWUnLAoKICAvLyBLZXkgc3BlY2lmaWMKICAnZHJvcFByaW1hcnknLCAnZHJvcFVuaXF1ZScsICdkcm9wSW5kZXgnLCAnZHJvcEZvcmVpZ24nCgpdLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3N0YXRlbWVudHMucHVzaCh7CiAgICAgIGdyb3VwaW5nOiAnYWx0ZXJUYWJsZScsCiAgICAgIG1ldGhvZDogbWV0aG9kLAogICAgICBhcmdzOiBfLnRvQXJyYXkoYXJndW1lbnRzKQogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9Owp9KTsKCi8vIFdhcm4gaWYgd2UncmUgbm90IGluIE15U1FMLCBzaW5jZSB0aGF0J3MgdGhlIG9ubHkgdGltZSB0aGVzZQovLyB0aHJlZSBhcmUgc3VwcG9ydGVkLgp2YXIgc3BlY2lhbE1ldGhvZHMgPSBbJ2VuZ2luZScsICdjaGFyc2V0JywgJ2NvbGxhdGUnXTsKXy5lYWNoKHNwZWNpYWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKGZhbHNlKSB7CiAgICAgIGhlbHBlcnMud2FybignS25leCBvbmx5IHN1cHBvcnRzICcgKyBtZXRob2QgKyAnIHN0YXRlbWVudCB3aXRoIG15c3FsLicpOwogICAgfSBpZiAodGhpcy5fX21ldGhvZCA9PT0gJ2FsdGVyJykgewogICAgICBoZWxwZXJzLndhcm4oJ0tuZXggZG9lcyBub3Qgc3VwcG9ydCBhbHRlcmluZyB0aGUgJyArIG1ldGhvZCArICcgb3V0c2lkZSBvZiB0aGUgY3JlYXRlIHRhYmxlLCBwbGVhc2UgdXNlIGtuZXgucmF3IHN0YXRlbWVudC4nKTsKICAgIH0KICAgIHRoaXMuX3NpbmdsZVttZXRob2RdID0gdmFsdWU7CiAgfTsKfSk7CgovLyBFYWNoIG9mIHRoZSBjb2x1bW4gdHlwZXMgdGhhdCB3ZSBjYW4gYWRkLCB3ZSBjcmVhdGUgYSBuZXcgQ29sdW1uQnVpbGRlcgovLyBpbnN0YW5jZSBhbmQgcHVzaCBpdCBvbnRvIHRoZSBzdGF0ZW1lbnRzIGFycmF5Lgp2YXIgY29sdW1uVHlwZXMgPSBbCgogIC8vIE51bWVyaWMKICAndGlueWludCcsCiAgJ3NtYWxsaW50JywKICAnbWVkaXVtaW50JywKICAnaW50JywKICAnYmlnaW50JywKICAnZGVjaW1hbCcsCiAgJ2Zsb2F0JywKICAnZG91YmxlJywKICAncmVhbCcsCiAgJ2JpdCcsCiAgJ2Jvb2xlYW4nLAogICdzZXJpYWwnLAoKICAvLyBEYXRlIC8gVGltZQogICdkYXRlJywKICAnZGF0ZXRpbWUnLAogICd0aW1lc3RhbXAnLAogICd0aW1lJywKICAneWVhcicsCgogIC8vIFN0cmluZwogICdjaGFyJywKICAndmFyY2hhcicsCiAgJ3Rpbnl0ZXh0JywKICAndGlueVRleHQnLAogICd0ZXh0JywKICAnbWVkaXVtdGV4dCcsCiAgJ21lZGl1bVRleHQnLAogICdsb25ndGV4dCcsCiAgJ2xvbmdUZXh0JywKICAnYmluYXJ5JywKICAndmFyYmluYXJ5JywKICAndGlueWJsb2InLAogICd0aW55QmxvYicsCiAgJ21lZGl1bWJsb2InLAogICdtZWRpdW1CbG9iJywKICAnYmxvYicsCiAgJ2xvbmdibG9iJywKICAnbG9uZ0Jsb2InLAogICdlbnVtJywKICAnc2V0JywKCiAgLy8gSW5jcmVtZW50cywgQWxpYXNlcywgYW5kIEFkZGl0aW9uYWwKICAnYm9vbCcsCiAgJ2RhdGVUaW1lJywKICAnaW5jcmVtZW50cycsCiAgJ2JpZ2luY3JlbWVudHMnLAogICdiaWdJbmNyZW1lbnRzJywKICAnaW50ZWdlcicsCiAgJ2JpZ2ludGVnZXInLAogICdiaWdJbnRlZ2VyJywKICAnc3RyaW5nJywKICAndGltZXN0YW1wcycsCiAgJ2pzb24nLAogICd1dWlkJywKICAnZW51JywKICAnc3BlY2lmaWNUeXBlJwpdOwoKLy8gRm9yIGVhY2ggb2YgdGhlIGNvbHVtbiBtZXRob2RzLCBjcmVhdGUgYSBuZXcgIkNvbHVtbkJ1aWxkZXIiIGludGVyZmFjZSwKLy8gcHVzaCBpdCBvbnRvIHRoZSAiYWxsU3RhdGVtZW50cyIgc3RhY2ssIGFuZCB0aGVuIHJldHVybiB0aGUgaW50ZXJmYWNlLAovLyB3aXRoIHdoaWNoIHdlIGNhbiBhZGQgaW5kZXhlcywgZXRjLgpfLmVhY2goY29sdW1uVHlwZXMsIGZ1bmN0aW9uKHR5cGUpIHsKICBUYWJsZUJ1aWxkZXIucHJvdG90eXBlW3R5cGVdID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpOwoKICAgIC8vIFRoZSAidGltZXN0YW1wcyIgY2FsbCBpcyByZWFsbHkgYSBjb21wb3VuZCBjYWxsIHRvIHNldCB0aGUKICAgIC8vIGBjcmVhdGVkX2F0YCBhbmQgYHVwZGF0ZWRfYXRgIGNvbHVtbnMuCiAgICBpZiAodHlwZSA9PT0gJ3RpbWVzdGFtcHMnKSB7CiAgICAgIGlmIChhcmdzWzBdID09PSB0cnVlKSB7CiAgICAgICAgdGhpcy50aW1lc3RhbXAoJ2NyZWF0ZWRfYXQnKTsKICAgICAgICB0aGlzLnRpbWVzdGFtcCgndXBkYXRlZF9hdCcpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuZGF0ZXRpbWUoJ2NyZWF0ZWRfYXQnKTsKICAgICAgICB0aGlzLmRhdGV0aW1lKCd1cGRhdGVkX2F0Jyk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIENvbHVtbkJ1aWxkZXIgPSB0aGlzLmNsaWVudC5Db2x1bW5CdWlsZGVyOwogICAgdmFyIGJ1aWxkZXIgICAgICAgPSBuZXcgQ29sdW1uQnVpbGRlcih0aGlzLCB0eXBlLCBhcmdzKTsKCiAgICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgICBncm91cGluZzogJ2NvbHVtbnMnLAogICAgICBidWlsZGVyOiBidWlsZGVyCiAgICB9KTsKICAgIHJldHVybiBidWlsZGVyOwogIH07Cgp9KTsKCi8vIFNldCB0aGUgY29tbWVudCB2YWx1ZSBmb3IgYSB0YWJsZSwgdGhleSdyZSBvbmx5IGFsbG93ZWQgdG8gYmUgY2FsbGVkCi8vIG9uY2UgcGVyIHRhYmxlLgpUYWJsZUJ1aWxkZXIucHJvdG90eXBlLmNvbW1lbnQgPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMuX3NpbmdsZS5jb21tZW50ID0gdmFsdWU7Cn07CgovLyBTZXQgYSBmb3JlaWduIGtleSBvbiB0aGUgdGFibGUsIGNhbGxpbmcKLy8gYHRhYmxlLmZvcmVpZ24oJ2NvbHVtbl9uYW1lJykucmVmZXJlbmNlcygnY29sdW1uJykub24oJ3RhYmxlJykub25EZWxldGUoKS4uLgovLyBBbHNvIGNhbGxlZCBmcm9tIHRoZSBDb2x1bW5CdWlsZGVyIGNvbnRleHQgd2hlbiBjaGFpbmluZy4KVGFibGVCdWlsZGVyLnByb3RvdHlwZS5mb3JlaWduID0gZnVuY3Rpb24oY29sdW1uKSB7CiAgdmFyIGZvcmVpZ25EYXRhID0ge2NvbHVtbjogY29sdW1ufTsKICB0aGlzLl9zdGF0ZW1lbnRzLnB1c2goewogICAgZ3JvdXBpbmc6ICdhbHRlclRhYmxlJywKICAgIG1ldGhvZDogJ2ZvcmVpZ24nLAogICAgYXJnczogW2ZvcmVpZ25EYXRhXQogIH0pOwogIHZhciByZXR1cm5PYmogPSB7CiAgICByZWZlcmVuY2VzOiBmdW5jdGlvbih0YWJsZUNvbHVtbikgewogICAgICB2YXIgcGllY2VzOwogICAgICBpZiAoXy5pc1N0cmluZyh0YWJsZUNvbHVtbikpIHsKICAgICAgICBwaWVjZXMgPSB0YWJsZUNvbHVtbi5zcGxpdCgnLicpOwogICAgICB9CiAgICAgIGlmICghcGllY2VzIHx8IHBpZWNlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBmb3JlaWduRGF0YS5yZWZlcmVuY2VzID0gcGllY2VzID8gcGllY2VzWzBdIDogdGFibGVDb2x1bW47CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIG9uOiBmdW5jdGlvbih0YWJsZU5hbWUpIHsKICAgICAgICAgICAgZm9yZWlnbkRhdGEuaW5UYWJsZSA9IHRhYmxlTmFtZTsKICAgICAgICAgICAgcmV0dXJuIHJldHVybk9iajsKICAgICAgICAgIH0sCiAgICAgICAgICBpblRhYmxlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMub24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIGZvcmVpZ25EYXRhLmluVGFibGUgPSBwaWVjZXNbMF07CiAgICAgIGZvcmVpZ25EYXRhLnJlZmVyZW5jZXMgPSBwaWVjZXNbMV07CiAgICAgIHJldHVybiByZXR1cm5PYmo7CiAgICB9LAogICAgb25VcGRhdGU6IGZ1bmN0aW9uKHN0YXRlbWVudCkgewogICAgICBmb3JlaWduRGF0YS5vblVwZGF0ZSA9IHN0YXRlbWVudDsKICAgICAgcmV0dXJuIHJldHVybk9iajsKICAgIH0sCiAgICBvbkRlbGV0ZTogZnVuY3Rpb24oc3RhdGVtZW50KSB7CiAgICAgIGZvcmVpZ25EYXRhLm9uRGVsZXRlID0gc3RhdGVtZW50OwogICAgICByZXR1cm4gcmV0dXJuT2JqOwogICAgfSwKICAgIF9jb2x1bW5CdWlsZGVyOiBmdW5jdGlvbihidWlsZGVyKSB7CiAgICAgIF8uZXh0ZW5kKGJ1aWxkZXIsIHJldHVybk9iaik7CiAgICAgIHJldHVybk9iaiA9IGJ1aWxkZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfQogIH07CiAgcmV0dXJuIHJldHVybk9iajsKfTsKCm1vZHVsZS5leHBvcnRzID0gVGFibGVCdWlsZGVyOwoKfSx7Ii4uL2hlbHBlcnMiOjk5LCJsb2Rhc2giOjEzMH1dLDExNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cid1c2Ugc3RyaWN0JzsKCi8vIFRhYmxlIENvbXBpbGVyCi8vIC0tLS0tLS0KdmFyIF8gPSByZXF1aXJlKCdsb2Rhc2gnKTsKCnZhciBoZWxwZXJzID0gcmVxdWlyZSgnLi4vaGVscGVycycpOwoKZnVuY3Rpb24gVGFibGVDb21waWxlcih0YWJsZUJ1aWxkZXIpIHsKICB0aGlzLm1ldGhvZCAgICAgICAgID0gdGFibGVCdWlsZGVyLl9tZXRob2Q7CiAgdGhpcy50YWJsZU5hbWVSYXcgICA9IHRhYmxlQnVpbGRlci5fdGFibGVOYW1lOwogIHRoaXMuc2luZ2xlICAgICAgICAgPSB0YWJsZUJ1aWxkZXIuX3NpbmdsZTsKICB0aGlzLmdyb3VwZWQgICAgICAgID0gXy5ncm91cEJ5KHRhYmxlQnVpbGRlci5fc3RhdGVtZW50cywgJ2dyb3VwaW5nJyk7CiAgdGhpcy5pbml0Q29tcGlsZXIoKTsKfQoKLy8gQ29udmVydCB0aGUgdGFibGVDb21waWxlciB0b1NRTApUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS50b1NRTCA9IGZ1bmN0aW9uKCkgewogIHRoaXNbdGhpcy5tZXRob2RdKCk7CiAgcmV0dXJuIHRoaXMuc2VxdWVuY2U7Cn07CgovLyBDb2x1bW4gQ29tcGlsYXRpb24KLy8gLS0tLS0tLQoKLy8gSWYgdGhpcyBpcyBhIHRhYmxlICJjcmVhdGlvbiIsIHdlIG5lZWQgdG8gZmlyc3QgcnVuIHRocm91Z2ggYWxsCi8vIG9mIHRoZSBjb2x1bW5zIHRvIGJ1aWxkIHRoZW0gaW50byBhIHNpbmdsZSBzdHJpbmcsCi8vIGFuZCB0aGVuIHJ1biB0aHJvdWdoIGFueXRoaW5nIGVsc2UgYW5kIHB1c2ggaXQgdG8gdGhlIHF1ZXJ5IHNlcXVlbmNlLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5jcmVhdGUgPSBmdW5jdGlvbihpZk5vdCkgewogIHZhciBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKCk7CiAgdmFyIGNvbHVtblR5cGVzID0gdGhpcy5nZXRDb2x1bW5UeXBlcyhjb2x1bW5zKTsKICB0aGlzLmNyZWF0ZVF1ZXJ5KGNvbHVtblR5cGVzLCBpZk5vdCk7CiAgdGhpcy5jb2x1bW5RdWVyaWVzKGNvbHVtbnMpOwogIGRlbGV0ZSB0aGlzLnNpbmdsZS5jb21tZW50OwogIHRoaXMuYWx0ZXJUYWJsZSgpOwp9OwoKLy8gT25seSBjcmVhdGUgdGhlIHRhYmxlIGlmIGl0IGRvZXNuJ3QgZXhpc3QuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmNyZWF0ZUlmTm90ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5jcmVhdGUodHJ1ZSk7Cn07CgovLyBJZiB3ZSdyZSBhbHRlcmluZyB0aGUgdGFibGUsIHdlIG5lZWQgdG8gb25lLWJ5LW9uZQovLyBnbyB0aHJvdWdoIGFuZCBoYW5kbGUgZWFjaCBvZiB0aGUgcXVlcmllcyBhc3NvY2lhdGVkCi8vIHdpdGggYWx0ZXJpbmcgdGhlIHRhYmxlJ3Mgc2NoZW1hLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hbHRlciA9IGZ1bmN0aW9uKCkgewogIHZhciBjb2x1bW5zID0gdGhpcy5nZXRDb2x1bW5zKCk7CiAgdmFyIGNvbHVtblR5cGVzID0gdGhpcy5nZXRDb2x1bW5UeXBlcyhjb2x1bW5zKTsKICB0aGlzLmFkZENvbHVtbnMoY29sdW1uVHlwZXMpOwogIHRoaXMuY29sdW1uUXVlcmllcyhjb2x1bW5zKTsKICB0aGlzLmFsdGVyVGFibGUoKTsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmZvcmVpZ24gPSBmdW5jdGlvbihmb3JlaWduRGF0YSkgewogIGlmIChmb3JlaWduRGF0YS5pblRhYmxlICYmIGZvcmVpZ25EYXRhLnJlZmVyZW5jZXMpIHsKICAgIHZhciBrZXlOYW1lICAgID0gdGhpcy5faW5kZXhDb21tYW5kKCdmb3JlaWduJywgdGhpcy50YWJsZU5hbWVSYXcsIGZvcmVpZ25EYXRhLmNvbHVtbik7CiAgICB2YXIgY29sdW1uICAgICA9IHRoaXMuZm9ybWF0dGVyLmNvbHVtbml6ZShmb3JlaWduRGF0YS5jb2x1bW4pOwogICAgdmFyIHJlZmVyZW5jZXMgPSB0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoZm9yZWlnbkRhdGEucmVmZXJlbmNlcyk7CiAgICB2YXIgaW5UYWJsZSAgICA9IHRoaXMuZm9ybWF0dGVyLndyYXAoZm9yZWlnbkRhdGEuaW5UYWJsZSk7CiAgICB2YXIgb25VcGRhdGUgICA9IGZvcmVpZ25EYXRhLm9uVXBkYXRlID8gJyBvbiB1cGRhdGUgJyArIGZvcmVpZ25EYXRhLm9uVXBkYXRlIDogJyc7CiAgICB2YXIgb25EZWxldGUgICA9IGZvcmVpZ25EYXRhLm9uRGVsZXRlID8gJyBvbiBkZWxldGUgJyArIGZvcmVpZ25EYXRhLm9uRGVsZXRlIDogJyc7CiAgICB0aGlzLnB1c2hRdWVyeSgnYWx0ZXIgdGFibGUgJyArIHRoaXMudGFibGVOYW1lKCkgKyAnIGFkZCBjb25zdHJhaW50ICcgKyBrZXlOYW1lICsgJyAnICsKICAgICAgJ2ZvcmVpZ24ga2V5ICgnICsgY29sdW1uICsgJykgcmVmZXJlbmNlcyAnICsgaW5UYWJsZSArICcgKCcgKyByZWZlcmVuY2VzICsgJyknICsgb25VcGRhdGUgKyBvbkRlbGV0ZSk7CiAgfQp9OwoKLy8gR2V0IGFsbCBvZiB0aGUgY29sdW1uIHNxbCAmIGJpbmRpbmdzIGluZGl2aWR1YWxseSBmb3IgYnVpbGRpbmcgdGhlIHRhYmxlIHF1ZXJpZXMuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtblR5cGVzID0gZnVuY3Rpb24oY29sdW1ucykgewogIHJldHVybiBfLnJlZHVjZShfLm1hcChjb2x1bW5zLCBfLmZpcnN0KSwgZnVuY3Rpb24obWVtbywgY29sdW1uKSB7CiAgICBtZW1vLnNxbC5wdXNoKGNvbHVtbi5zcWwpOwogICAgbWVtby5iaW5kaW5ncy5jb25jYXQoY29sdW1uLmJpbmRpbmdzKTsKICAgIHJldHVybiBtZW1vOwogIH0sIHtzcWw6IFtdLCBiaW5kaW5nczogW119KTsKfTsKCi8vIEFkZHMgYWxsIG9mIHRoZSBhZGRpdGlvbmFsIHF1ZXJpZXMgZnJvbSB0aGUgImNvbHVtbiIKVGFibGVDb21waWxlci5wcm90b3R5cGUuY29sdW1uUXVlcmllcyA9IGZ1bmN0aW9uKGNvbHVtbnMpIHsKICB2YXIgcXVlcmllcyA9IF8ucmVkdWNlKF8ubWFwKGNvbHVtbnMsIF8ucmVzdCksIGZ1bmN0aW9uKG1lbW8sIGNvbHVtbikgewogICAgaWYgKCFfLmlzRW1wdHkoY29sdW1uKSkgcmV0dXJuIG1lbW8uY29uY2F0KGNvbHVtbik7CiAgICByZXR1cm4gbWVtbzsKICB9LCBbXSk7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSBxdWVyaWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdGhpcy5wdXNoUXVlcnkocXVlcmllc1tpXSk7CiAgfQp9OwoKLy8gQWRkIGEgbmV3IGNvbHVtbi4KVGFibGVDb21waWxlci5wcm90b3R5cGUuYWRkQ29sdW1uc1ByZWZpeCA9ICdhZGQgY29sdW1uICc7CgovLyBBbGwgb2YgdGhlIGNvbHVtbnMgdG8gImFkZCIgZm9yIHRoZSBxdWVyeQpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5hZGRDb2x1bW5zID0gZnVuY3Rpb24oY29sdW1ucykgewogIGlmIChjb2x1bW5zLnNxbC5sZW5ndGggPiAwKSB7CiAgICB2YXIgY29sdW1uU3FsID0gXy5tYXAoY29sdW1ucy5zcWwsIGZ1bmN0aW9uKGNvbHVtbikgewogICAgICByZXR1cm4gdGhpcy5hZGRDb2x1bW5zUHJlZml4ICsgY29sdW1uOwogICAgfSwgdGhpcyk7CiAgICB0aGlzLnB1c2hRdWVyeSh7CiAgICAgIHNxbDogJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgY29sdW1uU3FsLmpvaW4oJywgJyksCiAgICAgIGJpbmRpbmdzOiBjb2x1bW5zLmJpbmRpbmdzCiAgICB9KTsKICB9Cn07CgovLyBDb21waWxlIHRoZSBjb2x1bW5zIGFzIG5lZWRlZCBmb3IgdGhlIGN1cnJlbnQgY3JlYXRlIG9yIGFsdGVyIHRhYmxlClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmdldENvbHVtbnMgPSBmdW5jdGlvbigpIHsKICB2YXIgY29tcGlsZWRDb2x1bW5zID0gW10sIGNvbHVtbnMgPSB0aGlzLmdyb3VwZWQuY29sdW1ucyB8fCBbXTsKICB2YXIgQ29sdW1uQ29tcGlsZXIgPSB0aGlzLmNsaWVudC5Db2x1bW5Db21waWxlcjsKICBmb3IgKHZhciBpID0gMCwgbCA9IGNvbHVtbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBjb21waWxlZENvbHVtbnMucHVzaChuZXcgQ29sdW1uQ29tcGlsZXIodGhpcywgY29sdW1uc1tpXS5idWlsZGVyKS50b1NRTCgpKTsKICB9CiAgcmV0dXJuIGNvbXBpbGVkQ29sdW1uczsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLnRhYmxlTmFtZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLmZvcm1hdHRlci53cmFwKHRoaXMudGFibGVOYW1lUmF3KTsKfTsKCi8vIEdlbmVyYXRlIGFsbCBvZiB0aGUgYWx0ZXIgY29sdW1uIHN0YXRlbWVudHMgbmVjZXNzYXJ5IGZvciB0aGUgcXVlcnkuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmFsdGVyVGFibGUgPSBmdW5jdGlvbigpIHsKICB2YXIgYWx0ZXJUYWJsZSA9IHRoaXMuZ3JvdXBlZC5hbHRlclRhYmxlIHx8IFtdOwogIGZvciAodmFyIGkgPSAwLCBsID0gYWx0ZXJUYWJsZS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBzdGF0ZW1lbnQgPSBhbHRlclRhYmxlW2ldOwogICAgaWYgKHRoaXNbc3RhdGVtZW50Lm1ldGhvZF0pIHsKICAgICAgdGhpc1tzdGF0ZW1lbnQubWV0aG9kXS5hcHBseSh0aGlzLCBzdGF0ZW1lbnQuYXJncyk7CiAgICB9IGVsc2UgewogICAgICBjb25zb2xlLmVycm9yKCdEZWJ1ZzogJyArIHN0YXRlbWVudC5tZXRob2QgKyAnIGRvZXMgbm90IGV4aXN0Jyk7CiAgICB9CiAgfQogIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5zaW5nbGUpIHsKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpc1tpdGVtXSkpIHRoaXNbaXRlbV0odGhpcy5zaW5nbGVbaXRlbV0pOwogIH0KfTsKCi8vIERyb3AgdGhlIGluZGV4IG9uIHRoZSBjdXJyZW50IHRhYmxlLgpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wSW5kZXggPSBmdW5jdGlvbih2YWx1ZSkgewogIHRoaXMucHVzaFF1ZXJ5KCdkcm9wIGluZGV4JyArIHZhbHVlKTsKfTsKCi8vIERyb3AgdGhlIHVuaXF1ZQpUYWJsZUNvbXBpbGVyLnByb3RvdHlwZS5kcm9wVW5pcXVlID0KVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcEZvcmVpZ24gPSBmdW5jdGlvbigpIHsKICB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCBpbXBsZW1lbnRlZCBpbiB0aGUgZGlhbGVjdCBkcml2ZXInKTsKfTsKClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLmRyb3BDb2x1bW5QcmVmaXggPSAnZHJvcCBjb2x1bW4gJzsKVGFibGVDb21waWxlci5wcm90b3R5cGUuZHJvcENvbHVtbiA9IGZ1bmN0aW9uKCkgewogIHZhciBjb2x1bW5zID0gaGVscGVycy5ub3JtYWxpemVBcnIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICB2YXIgZHJvcHMgPSBfLm1hcChfLmlzQXJyYXkoY29sdW1ucykgPyBjb2x1bW5zIDogW2NvbHVtbnNdLCBmdW5jdGlvbihjb2x1bW4pIHsKICAgIHJldHVybiB0aGlzLmRyb3BDb2x1bW5QcmVmaXggKyB0aGlzLmZvcm1hdHRlci53cmFwKGNvbHVtbik7CiAgfSwgdGhpcyk7CiAgdGhpcy5wdXNoUXVlcnkoJ2FsdGVyIHRhYmxlICcgKyB0aGlzLnRhYmxlTmFtZSgpICsgJyAnICsgZHJvcHMuam9pbignLCAnKSk7Cn07CgovLyBJZiBubyBuYW1lIHdhcyBzcGVjaWZpZWQgZm9yIHRoaXMgaW5kZXgsIHdlIHdpbGwgY3JlYXRlIG9uZSB1c2luZyBhIGJhc2ljCi8vIGNvbnZlbnRpb24gb2YgdGhlIHRhYmxlIG5hbWUsIGZvbGxvd2VkIGJ5IHRoZSBjb2x1bW5zLCBmb2xsb3dlZCBieSBhbgovLyBpbmRleCB0eXBlLCBzdWNoIGFzIHByaW1hcnkgb3IgaW5kZXgsIHdoaWNoIG1ha2VzIHRoZSBpbmRleCB1bmlxdWUuClRhYmxlQ29tcGlsZXIucHJvdG90eXBlLl9pbmRleENvbW1hbmQgPSBmdW5jdGlvbih0eXBlLCB0YWJsZU5hbWUsIGNvbHVtbnMpIHsKICBpZiAoIV8uaXNBcnJheShjb2x1bW5zKSkgY29sdW1ucyA9IGNvbHVtbnMgPyBbY29sdW1uc10gOiBbXTsKICB2YXIgdGFibGUgPSB0YWJsZU5hbWUucmVwbGFjZSgvXC58LS9nLCAnXycpOwogIHJldHVybiAodGFibGUgKyAnXycgKyBjb2x1bW5zLmpvaW4oJ18nKSArICdfJyArIHR5cGUpLnRvTG93ZXJDYXNlKCk7Cn07Cgptb2R1bGUuZXhwb3J0cyA9IFRhYmxlQ29tcGlsZXI7Cn0seyIuLi9oZWxwZXJzIjo5OSwibG9kYXNoIjoxMzB9XSwxMTc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MsX19kaXJuYW1lKXsKLy8gU2VlZGVyCi8vIC0tLS0tLS0KJ3VzZSBzdHJpY3QnOwoKdmFyIGZzICAgICAgID0gcmVxdWlyZSgnZnMnKTsKdmFyIHBhdGggICAgID0gcmVxdWlyZSgncGF0aCcpOwp2YXIgXyAgICAgICAgPSByZXF1aXJlKCdsb2Rhc2gnKTsKdmFyIG1rZGlycCAgID0gcmVxdWlyZSgnbWtkaXJwJyk7CnZhciBQcm9taXNlICA9IHJlcXVpcmUoJy4uL3Byb21pc2UnKTsKCgoKLy8gVGhlIG5ldyBzZWVkcyB3ZSdyZSBwZXJmb3JtaW5nLCB0eXBpY2FsbHkgY2FsbGVkIGZyb20gdGhlIGBrbmV4LnNlZWRgCi8vIGludGVyZmFjZSBvbiB0aGUgbWFpbiBga25leGAgb2JqZWN0LiBQYXNzZXMgdGhlIGBrbmV4YCBpbnN0YW5jZSBwZXJmb3JtaW5nCi8vIHRoZSBzZWVkcy4KZnVuY3Rpb24gU2VlZGVyKGtuZXgpIHsKICB0aGlzLmtuZXggICA9IGtuZXg7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhrbmV4LmNsaWVudC5zZWVkQ29uZmlnKTsKfQoKLy8gUnVucyBhbGwgc2VlZCBmaWxlcyBmb3IgdGhlIGdpdmVuIGVudmlyb25tZW50LgpTZWVkZXIucHJvdG90eXBlLnJ1biA9IFByb21pc2UubWV0aG9kKGZ1bmN0aW9uKGNvbmZpZykgewogIHRoaXMuY29uZmlnID0gdGhpcy5zZXRDb25maWcoY29uZmlnKTsKICByZXR1cm4gdGhpcy5fc2VlZERhdGEoKQogICAgLmJpbmQodGhpcykKICAgIC5zcHJlYWQoZnVuY3Rpb24oYWxsKSB7CiAgICAgIHJldHVybiB0aGlzLl9ydW5TZWVkcyhhbGwpOwogICAgfSk7Cn0pOwoKLy8gQ3JlYXRlcyBhIG5ldyBzZWVkIGZpbGUsIHdpdGggYSBnaXZlbiBuYW1lLgpTZWVkZXIucHJvdG90eXBlLm1ha2UgPSBmdW5jdGlvbihuYW1lLCBjb25maWcpIHsKICB0aGlzLmNvbmZpZyA9IHRoaXMuc2V0Q29uZmlnKGNvbmZpZyk7CiAgaWYgKCFuYW1lKSBQcm9taXNlLnJlamVjdGVkKG5ldyBFcnJvcignQSBuYW1lIG11c3QgYmUgc3BlY2lmaWVkIGZvciB0aGUgZ2VuZXJhdGVkIHNlZWQnKSk7CiAgcmV0dXJuIHRoaXMuX2Vuc3VyZUZvbGRlcihjb25maWcpCiAgICAuYmluZCh0aGlzKQogICAgLnRoZW4odGhpcy5fZ2VuZXJhdGVTdHViVGVtcGxhdGUpCiAgICAudGhlbih0aGlzLl93cml0ZU5ld1NlZWQobmFtZSkpOwp9OwoKLy8gTGlzdHMgYWxsIGF2YWlsYWJsZSBzZWVkIGZpbGVzIGFzIGEgc29ydGVkIGFycmF5LgpTZWVkZXIucHJvdG90eXBlLl9saXN0QWxsID0gUHJvbWlzZS5tZXRob2QoZnVuY3Rpb24oY29uZmlnKSB7CiAgdGhpcy5jb25maWcgPSB0aGlzLnNldENvbmZpZyhjb25maWcpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5yZWFkZGlyLCBmcykodGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKSkKICAgIC5iaW5kKHRoaXMpCiAgICAudGhlbihmdW5jdGlvbihzZWVkcykgewogICAgICByZXR1cm4gXy5maWx0ZXIoc2VlZHMsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdmFyIGV4dGVuc2lvbiA9IHBhdGguZXh0bmFtZSh2YWx1ZSk7CiAgICAgICAgcmV0dXJuIF8uY29udGFpbnMoWycuY28nLCAnLmNvZmZlZScsICcuaWNlZCcsICcuanMnLCAnLmxpdGNvZmZlZScsICcubHMnXSwgZXh0ZW5zaW9uKTsKICAgICAgfSkuc29ydCgpOwogICAgfSk7Cn0pOwoKLy8gR2V0cyB0aGUgc2VlZCBmaWxlIGxpc3QgZnJvbSB0aGUgc3BlY2lmaWVkIHNlZWQgZGlyZWN0b3J5LgpTZWVkZXIucHJvdG90eXBlLl9zZWVkRGF0YSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBQcm9taXNlLmpvaW4odGhpcy5fbGlzdEFsbCgpKTsKfTsKCgovLyBFbnN1cmVzIGEgZm9sZGVyIGZvciB0aGUgc2VlZHMgZXhpc3QsIGRlcGVuZGVudCBvbiB0aGUKLy8gc2VlZCBjb25maWcgc2V0dGluZ3MuClNlZWRlci5wcm90b3R5cGUuX2Vuc3VyZUZvbGRlciA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGRpciA9IHRoaXMuX2Fic29sdXRlQ29uZmlnRGlyKCk7CiAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMuc3RhdCwgZnMpKGRpcikKICAgICAgLmNhdGNoKGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQcm9taXNlLnByb21pc2lmeShta2RpcnApKGRpcik7CiAgICAgIH0pOwp9OwoKLy8gUnVuIHNlZWQgZmlsZXMsIGluIHNlcXVlbmNlLgpTZWVkZXIucHJvdG90eXBlLl9ydW5TZWVkcyA9IGZ1bmN0aW9uKHNlZWRzKSB7CiAgcmV0dXJuIFByb21pc2UuYWxsKF8ubWFwKHNlZWRzLCB0aGlzLl92YWxpZGF0ZVNlZWRTdHJ1Y3R1cmUsIHRoaXMpKQogICAgLmJpbmQodGhpcykKICAgIC50aGVuKGZ1bmN0aW9uKHNlZWRzKSB7CiAgICAgIHJldHVybiBQcm9taXNlLmJpbmQodGhpcykKICAgICAgICAudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl93YXRlcmZhbGxCYXRjaChzZWVkcyk7CiAgICAgICAgfSk7CiAgICB9KTsKfTsKCi8vIFZhbGlkYXRlcyBzZWVkIGZpbGVzIGJ5IHJlcXVpcmluZyBhbmQgY2hlY2tpbmcgZm9yIGEgYHNlZWRgIGZ1bmN0aW9uLgpTZWVkZXIucHJvdG90eXBlLl92YWxpZGF0ZVNlZWRTdHJ1Y3R1cmUgPSBmdW5jdGlvbihuYW1lKSB7CiAgdmFyIHNlZWQgPSByZXF1aXJlKHBhdGguam9pbih0aGlzLl9hYnNvbHV0ZUNvbmZpZ0RpcigpLCBuYW1lKSk7CiAgaWYgKCFfLmlzRnVuY3Rpb24oc2VlZC5zZWVkKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHNlZWQgZmlsZTogJyArIG5hbWUgKyAnIG11c3QgaGF2ZSBhIHNlZWQgZnVuY3Rpb24nKTsKICB9CiAgcmV0dXJuIG5hbWU7Cn07CgovLyBHZW5lcmF0ZXMgdGhlIHN0dWIgdGVtcGxhdGUgZm9yIHRoZSBjdXJyZW50IHNlZWQgZmlsZSwgcmV0dXJuaW5nIGEgY29tcGlsZWQgdGVtcGxhdGUuClNlZWRlci5wcm90b3R5cGUuX2dlbmVyYXRlU3R1YlRlbXBsYXRlID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0dWJQYXRoID0gdGhpcy5jb25maWcuc3R1YiB8fCBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc3R1YicsIHRoaXMuY29uZmlnLmV4dGVuc2lvbiArICcuc3R1YicpOwogIHJldHVybiBQcm9taXNlLnByb21pc2lmeShmcy5yZWFkRmlsZSwgZnMpKHN0dWJQYXRoKS50aGVuKGZ1bmN0aW9uKHN0dWIpIHsKICAgIHJldHVybiBfLnRlbXBsYXRlKHN0dWIudG9TdHJpbmcoKSwgbnVsbCwge3ZhcmlhYmxlOiAnZCd9KTsKICB9KTsKfTsKCi8vIFdyaXRlIGEgbmV3IHNlZWQgdG8gZGlzaywgdXNpbmcgdGhlIGNvbmZpZyBhbmQgZ2VuZXJhdGVkIGZpbGVuYW1lLAovLyBwYXNzaW5nIGFueSBgdmFyaWFibGVzYCBnaXZlbiBpbiB0aGUgY29uZmlnIHRvIHRoZSB0ZW1wbGF0ZS4KU2VlZGVyLnByb3RvdHlwZS5fd3JpdGVOZXdTZWVkID0gZnVuY3Rpb24obmFtZSkgewogIHZhciBjb25maWcgPSB0aGlzLmNvbmZpZzsKICB2YXIgZGlyID0gdGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKTsKICByZXR1cm4gZnVuY3Rpb24odG1wbCkgewogICAgaWYgKG5hbWVbMF0gPT09ICctJykgbmFtZSA9IG5hbWUuc2xpY2UoMSk7CiAgICB2YXIgZmlsZW5hbWUgID0gbmFtZSArICcuJyArIGNvbmZpZy5leHRlbnNpb247CiAgICByZXR1cm4gUHJvbWlzZS5wcm9taXNpZnkoZnMud3JpdGVGaWxlLCBmcykoCiAgICAgIHBhdGguam9pbihkaXIsIGZpbGVuYW1lKSwKICAgICAgdG1wbChjb25maWcudmFyaWFibGVzIHx8IHt9KQogICAgKS5yZXR1cm4ocGF0aC5qb2luKGRpciwgZmlsZW5hbWUpKTsKICB9Owp9OwoKLy8gUnVucyBhIGJhdGNoIG9mIHNlZWQgZmlsZXMuClNlZWRlci5wcm90b3R5cGUuX3dhdGVyZmFsbEJhdGNoID0gZnVuY3Rpb24oc2VlZHMpIHsKICB2YXIga25leCAgICAgID0gdGhpcy5rbmV4OwogIHZhciBzZWVkRGlyZWN0b3J5ID0gdGhpcy5fYWJzb2x1dGVDb25maWdEaXIoKTsKICB2YXIgY3VycmVudCAgID0gUHJvbWlzZS5iaW5kKHtmYWlsZWQ6IGZhbHNlLCBmYWlsZWRPbjogMH0pOwogIHZhciBsb2cgICAgICAgPSBbXTsKICBfLmVhY2goc2VlZHMsIGZ1bmN0aW9uKHNlZWQpIHsKICAgIHZhciBuYW1lICA9IHBhdGguam9pbihzZWVkRGlyZWN0b3J5LCBzZWVkKTsKICAgIHNlZWQgPSByZXF1aXJlKG5hbWUpOwoKICAgIC8vIFJ1biBlYWNoIHNlZWQgZmlsZS4KICAgIGN1cnJlbnQgPSBjdXJyZW50LnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzZWVkLnNlZWQoa25leCwgUHJvbWlzZSk7CiAgICB9KS50aGVuKGZ1bmN0aW9uKCkgewogICAgICBsb2cucHVzaChuYW1lKTsKICAgIH0pOwogIH0pOwoKICByZXR1cm4gY3VycmVudC50aGVuUmV0dXJuKFtsb2ddKTsKfTsKClNlZWRlci5wcm90b3R5cGUuX2Fic29sdXRlQ29uZmlnRGlyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCB0aGlzLmNvbmZpZy5kaXJlY3RvcnkpOwp9OwoKU2VlZGVyLnByb3RvdHlwZS5zZXRDb25maWcgPSBmdW5jdGlvbihjb25maWcpIHsKICByZXR1cm4gXy5leHRlbmQoewogICAgZXh0ZW5zaW9uOiAnanMnLAogICAgZGlyZWN0b3J5OiAnLi9zZWVkcycKICB9LCB0aGlzLmNvbmZpZyB8fCB7fSwgY29uZmlnKTsKfTsKCm1vZHVsZS5leHBvcnRzID0gU2VlZGVyOwoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJyksIi9ub2RlX21vZHVsZXMva25leC9saWIvc2VlZCIpCn0seyIuLi9wcm9taXNlIjoxMDMsIl9wcm9jZXNzIjo2MCwiZnMiOjUxLCJsb2Rhc2giOjEzMCwibWtkaXJwIjoxMjAsInBhdGgiOjU5fV0sMTE4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKJ3VzZSBzdHJpY3QnOwoKLy8gVHJhbnNhY3Rpb24KLy8gLS0tLS0tLQp2YXIgUHJvbWlzZSA9IHJlcXVpcmUoJy4vcHJvbWlzZScpOwp2YXIgaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwp2YXIgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJykuRXZlbnRFbWl0dGVyOwoKLy8gQ3JlYXRlcyBhIG5ldyB3cmFwcGVyIG9iamVjdCBmb3IgY29uc3RydWN0aW5nIGEgdHJhbnNhY3Rpb24uCi8vIENhbGxlZCBieSB0aGUgYGtuZXgudHJhbnNhY3Rpb25gLCB3aGljaCBzZXRzIHRoZSBjb3JyZWN0IGNsaWVudAovLyBhbmQgaGFuZGxlcyB0aGUgYGNvbnRhaW5lcmAgb2JqZWN0LCBwYXNzaW5nIGFsb25nIHRoZSBjb3JyZWN0Ci8vIGBjb25uZWN0aW9uYCB0byBrZWVwIGFsbCBvZiB0aGUgdHJhbnNhY3Rpb25zIG9uIHRoZSBjb3JyZWN0IGNvbm5lY3Rpb24uCmZ1bmN0aW9uIFRyYW5zYWN0aW9uKGNvbnRhaW5lcikgewogIHRoaXMuY29udGFpbmVyID0gY29udGFpbmVyOwp9CmluaGVyaXRzKFRyYW5zYWN0aW9uLCBFdmVudEVtaXR0ZXIpOwoKLy8gQnVpbGQgdGhlIGtuZXggaW5zdGFuY2UgcGFzc2VkIGFyb3VuZCBpbnNpZGUgdGhlIHRyYW5zYWN0aW9uIGNvbnRhaW5lci4KLy8gSXQgY2FuIGJlIHVzZWQgYm90aCBhcyBhIGZ1bGx5IGZ1bmN0aW9uYWwga25leCBpbnN0YW5jZSwgb3IgYXNzaW1pbGF0ZWQKLy8gaW50byBleGlzdGluZyBrbmV4IGNoYWlucyB2aWEgdGhlICIudHJhbnNhY3RpbmciIG1ldGhvZCBjYWxsLgpUcmFuc2FjdGlvbi5wcm90b3R5cGUuY29udGFpbmVyT2JqZWN0ID0gZnVuY3Rpb24ocnVubmVyKSB7CiAgdmFyIEtuZXggPSByZXF1aXJlKCcuLi9rbmV4Jyk7CgogIC8vIENyZWF0ZSBhbiBlbnRpcmVseSBuZXcga25leCBpbnN0YW5jZSBqdXN0IGZvciB0aGlzIHRyYW5zYWN0aW9uCiAgdmFyIHRyYW5zYWN0b3IgPSBLbmV4LmluaXRpYWxpemUoewogICAgX19jbGllbnRfXyAgICAgOiB0aGlzLmNsaWVudCwKICAgIF9fdHJhbnNhY3Rvcl9fIDoge19ydW5uZXI6IHJ1bm5lcn0KICB9KTsKCiAgLy8gUmVtb3ZlIHRoZSBhYmlsaXR5IHRvIHN0YXJ0IGEgdHJhbnNhY3Rpb24gb3IgZGVzdHJveQogIC8vIHRoZSBlbnRpcmUgcG9vbCB3aXRoaW4gYSB0cmFuc2FjdGlvbi4KICB0cmFuc2FjdG9yLmRlc3Ryb3kgPSB0cmFuc2FjdG9yLnRyYW5zYWN0aW9uID0gdm9pZCAwOwoKICAvLyBDb21taXRzIHRoZSB0cmFuc2FjdGlvbjoKICB0cmFuc2FjdG9yLmNvbW1pdCA9IGZ1bmN0aW9uKG1lc3NhZ2UpIHsKICAgIHJ1bm5lci5maW5pc2hUcmFuc2FjdGlvbigwLCB0cmFuc2FjdG9yLCBtZXNzYWdlKTsKICB9OwoKICAvLyBSb2xscyBiYWNrIHRoZSB0cmFuc2FjdGlvbi4KICB0cmFuc2FjdG9yLnJvbGxiYWNrID0gZnVuY3Rpb24oZXJyb3IpIHsKICAgIHJ1bm5lci5maW5pc2hUcmFuc2FjdGlvbigxLCB0cmFuc2FjdG9yLCBlcnJvcik7CiAgfTsKCiAgdHJhbnNhY3Rvci5fcnVubmVyID0gcnVubmVyOwoKICByZXR1cm4gdHJhbnNhY3RvcjsKfTsKClRyYW5zYWN0aW9uLnByb3RvdHlwZS5pbml0aWF0ZURlZmVycmVkID0gZnVuY3Rpb24odHJhbnNhY3RvcikgewoKICAvLyBJbml0aWF0ZSBhIGRlZmVycmVkIG9iamVjdCwgYm91bmQgdG8gdGhlIGNvbnRhaW5lciBvYmplY3QsCiAgLy8gc28gd2Uga25vdyB3aGVuIHRoZSB0cmFuc2FjdGlvbiBjb21wbGV0ZXMgb3IgZmFpbHMKICAvLyBhbmQgY2FuIGNvbnRpbnVlIGZyb20gdGhlcmUuCiAgdmFyIGRmZCA9IHRyYW5zYWN0b3IuX19kZmRfXyA9IFByb21pc2UucGVuZGluZygpOwoKICAvLyBDYWxsIHRoZSBjb250YWluZXIgd2l0aCB0aGUgdHJhbnNhY3Rpb24KICAvLyBjb21taXQgJiByb2xsYmFjayBvYmplY3RzLgogIHZhciByZXN1bHQgPSB0aGlzLmNvbnRhaW5lcih0cmFuc2FjdG9yKTsKCiAgLy8gSWYgd2UndmUgcmV0dXJuZWQgYSAidGhlbmFibGUiIGZyb20gdGhlIHRyYW5zYWN0aW9uIGNvbnRhaW5lciwKICAvLyBhbmQgaXQncyBnb3QgdGhlIHRyYW5zYWN0aW9uIG9iamVjdCB3ZSdyZSBydW5uaW5nIGZvciB0aGlzLCBhc3N1bWUKICAvLyB0aGUgcm9sbGJhY2sgYW5kIGNvbW1pdCBhcmUgY2hhaW5lZCB0byB0aGlzIG9iamVjdCdzIHN1Y2Nlc3MgLyBmYWlsdXJlLgogIGlmIChyZXN1bHQgJiYgcmVzdWx0LnRoZW4gJiYgdHlwZW9mIHJlc3VsdC50aGVuID09PSAnZnVuY3Rpb24nKSB7CiAgICByZXN1bHQudGhlbihmdW5jdGlvbih2YWwpIHsgdHJhbnNhY3Rvci5jb21taXQodmFsKTsgfSkuY2F0Y2goZnVuY3Rpb24oZXJyKSB7IHRyYW5zYWN0b3Iucm9sbGJhY2soZXJyKTsgfSk7CiAgfQoKICAvLyBSZXR1cm4gdGhlIHByb21pc2UgZm9yIHRoZSBlbnRpcmUgdHJhbnNhY3Rpb24uCiAgcmV0dXJuIGRmZC5wcm9taXNlOwp9OwoKLy8gQWxsb3cgdGhlIGBUcmFuc2FjdGlvbmAgb2JqZWN0IHRvIGJlIHV0aWxpemVkIHdpdGggZnVsbCBhY2Nlc3MgdG8gdGhlIHJlbGV2YW50Ci8vIHByb21pc2UgQVBJLgpyZXF1aXJlKCcuL2ludGVyZmFjZScpKFRyYW5zYWN0aW9uKTsKCi8vIFBhc3NlZCBhIGBjb250YWluZXJgIGZ1bmN0aW9uLCB0aGlzIG1ldGhvZCBydW5zIHRoZSBjdXJyZW50Ci8vIHRyYW5zYWN0aW9uLCByZXR1cm5pbmcgYSBwcm9taXNlLgpUcmFuc2FjdGlvbi5wcm90b3R5cGUudGhlbiA9IGZ1bmN0aW9uKG9uRnVsZmlsbGVkLCBvblJlamVjdGVkKSB7CiAgdmFyIFJ1bm5lciAgPSB0aGlzLmNsaWVudC5SdW5uZXI7CiAgdmFyIHByb21pc2UgPSB0aGlzOwogIAogIC8vIENyZWF0ZSBhIG5ldyAicnVubmVyIiBvYmplY3QsIHBhc3NpbmcgdGhlICJydW5uZXIiCiAgLy8gb2JqZWN0IGFsb25nLCBzbyB3ZSBjYW4gZWFzaWx5IGtlZXAgdHJhY2sgb2YgZXZlcnkKICAvLyBxdWVyeSBydW4gb24gdGhlIGN1cnJlbnQgY29ubmVjdGlvbi4KICByZXR1cm4gbmV3IFJ1bm5lcih0aGlzKQogICAgLnN0YXJ0VHJhbnNhY3Rpb24oKQogICAgLnRoZW4oZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiBwcm9taXNlLmNvbnRhaW5lck9iamVjdChvYmopOwogICAgfSkKICAgIC50aGVuKGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gcHJvbWlzZS5pbml0aWF0ZURlZmVycmVkKG9iaik7CiAgICB9KQogICAgLnRoZW4ob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQpOwp9OwoKbW9kdWxlLmV4cG9ydHMgPSBUcmFuc2FjdGlvbjsKfSx7Ii4uL2tuZXgiOjc3LCIuL2ludGVyZmFjZSI6MTAwLCIuL3Byb21pc2UiOjEwMywiZXZlbnRzIjo1NywiaW5oZXJpdHMiOjc2fV0sMTE5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLy8gR2VuZXJpYyBQb29sIFJlZHV4Ci8vCi8vIEZvcmsgb2YgaHR0cHM6Ly9naXRodWIuY29tL2Nvb3Blcm51cnNlL25vZGUtcG9vbAovLyB3aXRoIHByb3RvdHlwZXMsIGFwaSBjaGFuZ2VzLCBhbmQgc3VwcG9ydCBmb3IgdGhlIGNsaWVudC4KLy8gTGljZW5zZTogTUlUCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQooZnVuY3Rpb24oZGVmaW5lKSB7CgoidXNlIHN0cmljdCI7CgpkZWZpbmUoZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7CgogIC8vIEluaXRpYWxpemUgYXJyYXlzIHRvIGhvbGQgcXVldWUgZWxlbWVudHMuCiAgdmFyIFByaW9yaXR5UXVldWUgPSBmdW5jdGlvbihzaXplKSB7CiAgICB0aGlzLnNsb3RzID0gW107CiAgICB0aGlzLnF1ZXVlU2l6ZSA9IE1hdGgubWF4KCtzaXplIHwgMCwgMSk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucXVldWVTaXplOyBpICs9IDEpIHsKICAgICAgdGhpcy5zbG90cy5wdXNoKFtdKTsKICAgIH0KICB9OwoKICBQcmlvcml0eVF1ZXVlLnByb3RvdHlwZSA9IHsKCiAgICB0b3RhbDogbnVsbCwKCiAgICAvLyBDYWxjdWxhdGVzIHRoZSBzaXplIG9mIHRoZSBxdWV1ZSwgYW5kIHNldHMKICAgIC8vIHRoZSB2YWx1ZSB0byB0b3RhbC4KICAgIHNpemU6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy50b3RhbCA9PT0gbnVsbCkgewogICAgICAgIHRoaXMudG90YWwgPSAwOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5xdWV1ZVNpemU7IGkgKz0gMSkgewogICAgICAgICAgdGhpcy50b3RhbCArPSB0aGlzLnNsb3RzW2ldLmxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMudG90YWw7CiAgICB9LAoKICAgIC8vIENsZWFycyB0aGUgY2FjaGUgZm9yIHRvdGFsIGFuZCBhZGRzIGFuCiAgICAvLyBvYmplY3QgdG8gdGhlIHF1ZXVlLCBiYXNlZCBvbiBhbiBvcHRpb25hbCBwcmlvcml0eS4KICAgIGVucXVldWU6IGZ1bmN0aW9uKG9iaiwgcHJpb3JpdHkpIHsKICAgICAgcHJpb3JpdHkgPSBwcmlvcml0eSAmJiArcHJpb3JpdHkgfCAwIHx8IDA7CiAgICAgIHRoaXMudG90YWwgPSBudWxsOwogICAgICBpZiAocHJpb3JpdHkpIHsKICAgICAgICB2YXIgcHJpb3JpdHlPcmlnID0gcHJpb3JpdHk7CiAgICAgICAgaWYgKHByaW9yaXR5IDwgMCB8fCBwcmlvcml0eSA+PSB0aGlzLnF1ZXVlU2l6ZSkgewogICAgICAgICAgcHJpb3JpdHkgPSAodGhpcy5zaXplIC0gMSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuc2xvdHNbcHJpb3JpdHldLnB1c2gob2JqKTsKICAgIH0sCgogICAgLy8gQ2xlYXJzIHRoZSBjYWNoZSBmb3IgdG90YWwgYW5kIHJlbW92ZXMgYW4gb2JqZWN0CiAgICAvLyBmcm9tIHRoZSBxdWV1ZS4KICAgIGRlcXVldWU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gbnVsbCwgaSwgc2wgPSB0aGlzLnNsb3RzLmxlbmd0aDsKICAgICAgdGhpcy50b3RhbCA9IG51bGw7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBzbDsgaSArPSAxKSB7CiAgICAgICAgaWYgKHRoaXMuc2xvdHNbaV0ubGVuZ3RoKSB7CiAgICAgICAgICBvYmogPSB0aGlzLnNsb3RzW2ldLnNoaWZ0KCk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIG9iajsKICAgIH0KCiAgfTsKCiAgLy8gQ29uc3RydWN0b3IgZm9yIGEgbmV3IHBvb2wuCiAgdmFyIFBvb2wgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgUG9vbCkpIHJldHVybiBuZXcgUG9vbChvcHRpb25zKTsKICAgIHRoaXMuaWRsZVRpbWVvdXRNaWxsaXMgPSBvcHRpb25zLmlkbGVUaW1lb3V0TWlsbGlzICB8fCAzMDAwMDsKICAgIHRoaXMucmVhcEludGVydmFsICAgICAgPSBvcHRpb25zLnJlYXBJbnRlcnZhbE1pbGxpcyB8fCAxMDAwOwogICAgdGhpcy5kZXN0cm95SGFuZGxlciAgICA9IG9wdGlvbnMuZGVzdHJveSB8fCBmdW5jdGlvbigpIHt9OwogICAgdGhpcy5yZWZyZXNoSWRsZSAgICAgICA9ICgncmVmcmVzaElkbGUnIGluIG9wdGlvbnMpID8gb3B0aW9ucy5yZWZyZXNoSWRsZSA6IHRydWU7CiAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgID0gW107CiAgICB0aGlzLndhaXRpbmdDbGllbnRzICAgID0gbmV3IFByaW9yaXR5UXVldWUob3B0aW9ucy5wcmlvcml0eVJhbmdlIHx8IDEpOwogICAgdGhpcy5jcmVhdGUgICAgICAgICAgICA9IG9wdGlvbnMuY3JlYXRlIHx8IChmdW5jdGlvbigpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCdBIGNyZWF0ZSBtZXRob2QgbXVzdCBiZSBkZWZpbmVkIGZvciB0aGUgY29ubmVjdGlvbiBwb29sLicpOwogICAgfSkoKTsKCiAgICAvLyBJZiBhIHZhbGlkYXRlIG1ldGhvZCBpcyBwcm92aWRlZCwgdXNlIHRoYXQgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdC4KICAgIGlmIChvcHRpb25zLnZhbGlkYXRlKSB0aGlzLnZhbGlkYXRlID0gb3B0aW9ucy52YWxpZGF0ZTsKCiAgICAvLyBTZXQgdGhlIG1heCAmIG1pbidzIG9uIHRoZSBvcHRpb25zLgogICAgdmFyIG1heCA9IHBhcnNlSW50KG9wdGlvbnMubWF4LCAxMCk7CiAgICB2YXIgbWluID0gcGFyc2VJbnQob3B0aW9ucy5taW4sIDEwKTsKICAgIHRoaXMubWF4ID0gTWF0aC5tYXgoaXNOYU4obWF4KSA/IDEgOiBtYXgsIDEpOwogICAgdGhpcy5taW4gPSBNYXRoLm1pbihpc05hTihtaW4pID8gMCA6IG1pbiwgdGhpcy5tYXggLSAxKTsKCiAgICAvLyBFbnN1cmUgdGhlIG1pbmltdW0gaXMgY3JlYXRlZC4KICAgIHRoaXMuZW5zdXJlTWluaW11bSgpOwogIH07CgogIFBvb2wucHJvdG90eXBlID0gewoKICAgIGNvdW50OiAwLAoKICAgIGRyYWluaW5nOiBmYWxzZSwKCiAgICByZW1vdmVJZGxlVGltZXI6IG51bGwsCgogICAgcmVtb3ZlSWRsZVNjaGVkdWxlZDogZmFsc2UsCgogICAgLy8gRGVmYXVsdCB2YWxpZGF0ZS4KICAgIHZhbGlkYXRlOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIC8vIFJlcXVlc3QgYSBuZXcgY2xpZW50LiBUaGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQsCiAgICAvLyB3aGVuIGEgbmV3IGNsaWVudCB3aWxsIGJlIGF2YWlsYWJlLCBwYXNzaW5nIHRoZSBjbGllbnQgdG8gaXQuCiAgICAvLyBPcHRpb25hbGx5LCB5b3kgbWF5IHNwZWNpZnkgYSBwcmlvcml0eSBvZiB0aGUgY2FsbGVyIGlmIHRoZXJlIGFyZSBubwogICAgLy8gYXZhaWxhYmxlIHJlc291cmNlcy4gIExvd2VyIG51bWJlcnMgbWVhbiBoaWdoZXIgcHJpb3JpdHkuCiAgICBhY3F1aXJlOiBmdW5jdGlvbihjYWxsYmFjaywgcHJpb3JpdHkpIHsKICAgICAgaWYgKHRoaXMuZHJhaW5pbmcpIHJldHVybiBjYWxsYmFjayhuZXcgRXJyb3IoIlBvb2wgaXMgZHJhaW5pbmcgYW5kIGNhbm5vdCBhY2NlcHQgd29yayIpKTsKICAgICAgdGhpcy53YWl0aW5nQ2xpZW50cy5lbnF1ZXVlKGNhbGxiYWNrLCBwcmlvcml0eSk7CiAgICAgIHRoaXMuZGlzcGVuc2UoKTsKICAgICAgcmV0dXJuICh0aGlzLmNvdW50IDwgdGhpcy5tYXgpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGNsaWVudCB0byB0aGUgcG9vbCwgaW4gY2FzZSBpdCBpcyBubyBsb25nZXIgcmVxdWlyZWQuCiAgICByZWxlYXNlOiBmdW5jdGlvbihvYmosIGNhbGxiYWNrKSB7CiAgICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGlzIG9iamVjdCBoYXMgYWxyZWFkeSBiZWVuIHJlbGVhc2VkIChpLmUuLCBpcyBiYWNrIGluIHRoZSBwb29sIG9mIGF2YWlsYWJsZU9iamVjdHMpCiAgICAgIGlmICh0aGlzLmF2YWlsYWJsZU9iamVjdHMuc29tZShmdW5jdGlvbihvYmpXaXRoVGltZW91dCkgewogICAgICAgIHJldHVybiAob2JqV2l0aFRpbWVvdXQub2JqID09PSBvYmopOwogICAgICB9KSkgewogICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2sobmV3IEVycm9yKCdSZWxlYXNlIGNhbGxlZCBtdWx0aXBsZSB0aW1lcyBvbiB0aGUgc2FtZSBvYmplY3QnKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBvYmpXaXRoVGltZW91dCA9IHsKICAgICAgICBvYmo6IG9iaiwKICAgICAgICB0aW1lb3V0OiAobmV3IERhdGUoKS5nZXRUaW1lKCkgKyB0aGlzLmlkbGVUaW1lb3V0TWlsbGlzKQogICAgICB9OwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMucHVzaChvYmpXaXRoVGltZW91dCk7CiAgICAgIHRoaXMuZGlzcGVuc2UoKTsKICAgICAgdGhpcy5zY2hlZHVsZVJlbW92ZUlkbGUoKTsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsKTsKICAgIH0sCgogICAgLy8gVHJ5IHRvIGdldCBhIG5ldyBjbGllbnQgdG8gd29yaywgYW5kIGNsZWFuIHVwIHBvb2wgdW51c2VkIChpZGxlKSBpdGVtcy4KICAgIC8vCiAgICAvLyAtIElmIHRoZXJlIGFyZSBhdmFpbGFibGUgY2xpZW50cyB3YWl0aW5nLCBzaGlmdCB0aGUgZmlyc3Qgb25lIG91dCAoTElGTyksCiAgICAvLyAgIGFuZCBjYWxsIGl0cyBjYWxsYmFjay4KICAgIC8vIC0gSWYgdGhlcmUgYXJlIG5vIHdhaXRpbmcgY2xpZW50cywgdHJ5IHRvIGNyZWF0ZSBvbmUgaWYgaXQgd29uJ3QgZXhjZWVkCiAgICAvLyAgIHRoZSBtYXhpbXVtIG51bWJlciBvZiBjbGllbnRzLgogICAgLy8gLSBJZiBjcmVhdGluZyBhIG5ldyBjbGllbnQgd291bGQgZXhjZWVkIHRoZSBtYXhpbXVtLCBhZGQgdGhlIGNsaWVudCB0bwogICAgLy8gICB0aGUgd2FpdCBsaXN0LgogICAgZGlzcGVuc2U6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gbnVsbCwKICAgICAgICBvYmpXaXRoVGltZW91dCA9IG51bGwsCiAgICAgICAgZXJyID0gbnVsbCwKICAgICAgICBjbGllbnRDYiA9IG51bGwsCiAgICAgICAgd2FpdGluZ0NvdW50ID0gdGhpcy53YWl0aW5nQ2xpZW50cy5zaXplKCk7CgogICAgICBpZiAod2FpdGluZ0NvdW50ID4gMCkgewogICAgICAgIHdoaWxlICh0aGlzLmF2YWlsYWJsZU9iamVjdHMubGVuZ3RoID4gMCkgewogICAgICAgICAgb2JqV2l0aFRpbWVvdXQgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHNbMF07CiAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGUob2JqV2l0aFRpbWVvdXQub2JqKSkgewogICAgICAgICAgICB0aGlzLmRlc3Ryb3kob2JqV2l0aFRpbWVvdXQub2JqKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMuc2hpZnQoKTsKICAgICAgICAgIGNsaWVudENiID0gdGhpcy53YWl0aW5nQ2xpZW50cy5kZXF1ZXVlKCk7CiAgICAgICAgICByZXR1cm4gY2xpZW50Q2IoZXJyLCBvYmpXaXRoVGltZW91dC5vYmopOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5jb3VudCA8IHRoaXMubWF4KSB7CiAgICAgICAgICB0aGlzLmNyZWF0ZVJlc291cmNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8vIERpc2FsbG93IGFueSBuZXcgcmVxdWVzdHMgYW5kIGxldCB0aGUgcmVxdWVzdCBiYWNrbG9nIGRpc3NhcGF0ZSwKICAgIC8vIFNldHRpbmcgdGhlIGBkcmFpbmluZ2AgZmxhZyBzbyBhcyB0byBsZXQgYW55IGFkZGl0aW9uYWwgd29yayBvbiB0aGUgcXVldWUKICAgIC8vIGRpc3NhcGF0ZS4KICAgIGRyYWluOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICB0aGlzLmRyYWluaW5nID0gdHJ1ZTsKICAgICAgdmFyIHBvb2wgPSB0aGlzOwogICAgICB2YXIgY2hlY2tpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAocG9vbC53YWl0aW5nQ2xpZW50cy5zaXplKCkgPiAwIHx8IHBvb2wuYXZhaWxhYmxlT2JqZWN0cy5sZW5ndGggIT0gcG9vbC5jb3VudCkgewogICAgICAgICAgc2V0VGltZW91dChjaGVja2luZywgMTAwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgY2hlY2tpbmcoKTsKICAgIH0sCgogICAgLy8gRm9yY2libHkgZGVzdHJveXMgYWxsIGNsaWVudHMgcmVnYXJkbGVzcyBvZiB0aW1lb3V0LiBJbnRlbmRlZCB0byBiZQogICAgLy8gaW52b2tlZCBhcyBwYXJ0IG9mIGEgZHJhaW4uIERvZXMgbm90IHByZXZlbnQgdGhlIGNyZWF0aW9uIG9mIG5ldwogICAgLy8gY2xpZW50cyBhcyBhIHJlc3VsdCBvZiBzdWJzZXF1ZW50IGNhbGxzIHRvIGFjcXVpcmUuCiAgICAvLwogICAgLy8gTm90ZSB0aGF0IGlmIHRoaXMubWluID4gMCwgdGhlIHBvb2wgd2lsbCBkZXN0cm95IGFsbCBpZGxlIHJlc291cmNlcwogICAgLy8gaW4gdGhlIHBvb2wsIGJ1dCByZXBsYWNlIHRoZW0gd2l0aCBuZXdseSBjcmVhdGVkIHJlc291cmNlcyB1cCB0byB0aGUKICAgIC8vIHNwZWNpZmllZCB0aGlzLm1pbiB2YWx1ZS4gIElmIHRoaXMgaXMgbm90IGRlc2lyZWQsIHNldCB0aGlzLm1pbgogICAgLy8gdG8gemVybyBiZWZvcmUgY2FsbGluZyBkZXN0cm95QWxsTm93KCkKICAgIGRlc3Ryb3lBbGxOb3c6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciB3aWxsRGllID0gdGhpcy5hdmFpbGFibGVPYmplY3RzOwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgPSBbXTsKICAgICAgdmFyIG9iaiA9IHdpbGxEaWUuc2hpZnQoKTsKICAgICAgd2hpbGUgKG9iaiAhPT0gbnVsbCAmJiBvYmogIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuZGVzdHJveShvYmoub2JqKTsKICAgICAgICBvYmogPSB3aWxsRGllLnNoaWZ0KCk7CiAgICAgIH0KICAgICAgdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJlbW92ZUlkbGVUaW1lcik7CiAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKICAgIH0sCgogICAgLy8gRGVjb3JhdGVzIGEgZnVuY3Rpb24gdG8gdXNlIGEgYWNxdWlyZWQgY2xpZW50IGZyb20gdGhlIG9iamVjdCBwb29sIHdoZW4gY2FsbGVkLgogICAgcG9vbGVkOiBmdW5jdGlvbihkZWNvcmF0ZWQsIHByaW9yaXR5KSB7CiAgICAgIHZhciBwb29sID0gdGhpczsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWxsZXJBcmdzID0gYXJndW1lbnRzOwogICAgICAgIHZhciBjYWxsZXJDYWxsYmFjayA9IGNhbGxlckFyZ3NbY2FsbGVyQXJncy5sZW5ndGggLSAxXTsKICAgICAgICB2YXIgY2FsbGVySGFzQ2FsbGJhY2sgPSB0eXBlb2YgY2FsbGVyQ2FsbGJhY2sgPT09ICdmdW5jdGlvbic7CiAgICAgICAgcG9vbC5hY3F1aXJlKGZ1bmN0aW9uKGVyciwgY2xpZW50KSB7CiAgICAgICAgICBpZiAoZXJyKSB7CiAgICAgICAgICAgIGlmIChjYWxsZXJIYXNDYWxsYmFjaykgY2FsbGVyQ2FsbGJhY2soZXJyLCBudWxsKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFyZ3MgPSBbY2xpZW50XS5jb25jYXQoc2xpY2UuY2FsbChjYWxsZXJBcmdzLCAwLCBjYWxsZXJIYXNDYWxsYmFjayA/IC0xIDogdW5kZWZpbmVkKSk7CiAgICAgICAgICBhcmdzLnB1c2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvb2wucmVsZWFzZS5jYWxsKHBvb2wsIGNsaWVudCk7CiAgICAgICAgICAgIGlmIChjYWxsZXJIYXNDYWxsYmFjaykgY2FsbGVyQ2FsbGJhY2suYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZGVjb3JhdGVkLmFwcGx5KG51bGwsIGFyZ3MpOwogICAgICAgIH0sIHByaW9yaXR5KTsKICAgICAgfTsKICAgIH0sCgogICAgLy8gUmVxdWVzdCB0aGUgY2xpZW50IHRvIGJlIGRlc3Ryb3llZC4gVGhlIGZhY3RvcnkncyBkZXN0cm95IGhhbmRsZXIKICAgIC8vIHdpbGwgYWxzbyBiZSBjYWxsZWQuIFRoaXMgc2hvdWxkIGJlIGNhbGxlZCB3aXRoaW4gYW4gYWNxdWlyZSgpCiAgICAvLyBibG9jayBhcyBhbiBhbHRlcm5hdGl2ZSB0byByZWxlYXNlKCkuCiAgICBkZXN0cm95OiBmdW5jdGlvbihvYmopIHsKICAgICAgdGhpcy5jb3VudCAtPSAxOwogICAgICB0aGlzLmF2YWlsYWJsZU9iamVjdHMgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHMuZmlsdGVyKGZ1bmN0aW9uKG9ialdpdGhUaW1lb3V0KSB7CiAgICAgICAgcmV0dXJuIChvYmpXaXRoVGltZW91dC5vYmogIT09IG9iaik7CiAgICAgIH0pOwogICAgICB0aGlzLmRlc3Ryb3lIYW5kbGVyKG9iaik7CiAgICAgIHRoaXMuZW5zdXJlTWluaW11bSgpOwogICAgfSwKCiAgICAvLyBDaGVja3MgYW5kIHJlbW92ZXMgdGhlIGF2YWlsYWJsZSAoaWRsZSkgY2xpZW50cyB0aGF0IGhhdmUgdGltZWQgb3V0LgogICAgcmVtb3ZlSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0b1JlbW92ZSA9IFtdLAogICAgICAgIG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAogICAgICAgIGksIGF2YWlsYWJsZUxlbmd0aCwgdHIsIHRpbWVvdXQ7CgogICAgICB0aGlzLnJlbW92ZUlkbGVTY2hlZHVsZWQgPSBmYWxzZTsKCiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGF2YWlsYWJsZSAoaWRsZSkgaXRlbXMsCiAgICAgIC8vIGNoZWNrIGlmIHRoZXkgaGF2ZSB0aW1lZCBvdXQKICAgICAgZm9yIChpID0gMCwgYXZhaWxhYmxlTGVuZ3RoID0gdGhpcy5hdmFpbGFibGVPYmplY3RzLmxlbmd0aDsgaSA8IGF2YWlsYWJsZUxlbmd0aCAmJiAodGhpcy5yZWZyZXNoSWRsZSB8fCAodGhpcy5jb3VudCAtIHRoaXMubWluID4gdG9SZW1vdmUubGVuZ3RoKSk7IGkgKz0gMSkgewogICAgICAgIHRpbWVvdXQgPSB0aGlzLmF2YWlsYWJsZU9iamVjdHNbaV0udGltZW91dDsKICAgICAgICBpZiAobm93ID49IHRpbWVvdXQpIHsKICAgICAgICAgIC8vIENsaWVudCB0aW1lZCBvdXQsIHNvIGRlc3Ryb3kgaXQuCiAgICAgICAgICB0b1JlbW92ZS5wdXNoKHRoaXMuYXZhaWxhYmxlT2JqZWN0c1tpXS5vYmopOwogICAgICAgIH0KICAgICAgfQoKICAgICAgZm9yIChpID0gMCwgdHIgPSB0b1JlbW92ZS5sZW5ndGg7IGkgPCB0cjsgaSArPSAxKSB7CiAgICAgICAgdGhpcy5kZXN0cm95KHRvUmVtb3ZlW2ldKTsKICAgICAgfQoKICAgICAgLy8gUmVwbGFjZSB0aGUgYXZhaWxhYmxlIGl0ZW1zIHdpdGggdGhlIG9uZXMgdG8ga2VlcC4KICAgICAgYXZhaWxhYmxlTGVuZ3RoID0gdGhpcy5hdmFpbGFibGVPYmplY3RzLmxlbmd0aDsKCiAgICAgIGlmIChhdmFpbGFibGVMZW5ndGggPiAwKSB7CiAgICAgICAgdGhpcy5zY2hlZHVsZVJlbW92ZUlkbGUoKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBTY2hlZHVsZSByZW1vdmFsIG9mIGlkbGUgaXRlbXMgaW4gdGhlIHBvb2wuCiAgICAvLyBNb3JlIHNjaGVkdWxlcyBjYW5ub3QgcnVuIGNvbmN1cnJlbnRseS4KICAgIHNjaGVkdWxlUmVtb3ZlSWRsZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkKSB7CiAgICAgICAgdGhpcy5yZW1vdmVJZGxlU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgICB2YXIgcG9vbCA9IHRoaXM7CiAgICAgICAgdGhpcy5yZW1vdmVJZGxlVGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgcG9vbC5yZW1vdmVJZGxlLmNhbGwocG9vbCk7CiAgICAgICAgfSwgdGhpcy5yZWFwSW50ZXJ2YWwpOwogICAgICB9CiAgICB9LAoKICAgIC8vIENyZWF0ZXMgYSBuZXcgcmVzb3VyY2UsIGFkZGluZyBhbiBvYmplY3QgdG8gdGhlIHBvb2wKICAgIGNyZWF0ZVJlc291cmNlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBvb2wgPSB0aGlzOwogICAgICB0aGlzLmNvdW50ICs9IDE7CiAgICAgIHRoaXMuY3JlYXRlKGZ1bmN0aW9uKGVyciwgb2JqKSB7CiAgICAgICAgdmFyIGNsaWVudENiID0gcG9vbC53YWl0aW5nQ2xpZW50cy5kZXF1ZXVlKCk7CiAgICAgICAgaWYgKGVycikgewogICAgICAgICAgcG9vbC5jb3VudCAtPSAxOwogICAgICAgICAgaWYgKGNsaWVudENiKSBjbGllbnRDYihlcnIsIG51bGwpOwogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9vbC5kaXNwZW5zZS5jYWxsKHBvb2wpOwogICAgICAgICAgfSwgMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjbGllbnRDYikgcmV0dXJuIGNsaWVudENiKG51bGwsIG9iaik7CiAgICAgICAgICBwb29sLnJlbGVhc2Uob2JqKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBJZiB0aGUgY2xpZW50IGlzbid0IGluIHRoZSBwcm9jZXNzIG9mIGRyYWluaW5nLCB0aGlzIGVuc3VyZXMKICAgIC8vIHRoYXQgdGhlIG1pbmltdW0gbnVtYmVyIG9mIHJlc291cmNlcyBhcmUgYWx3YXlzIGFyb3VuZC4KICAgIGVuc3VyZU1pbmltdW06IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaSwgZGlmZjsKICAgICAgaWYgKCF0aGlzLmRyYWluaW5nICYmICh0aGlzLmNvdW50IDwgdGhpcy5taW4pKSB7CiAgICAgICAgZGlmZiA9IHRoaXMubWluIC0gdGhpcy5jb3VudDsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZGlmZjsgaSsrKSB7CiAgICAgICAgICB0aGlzLmNyZWF0ZVJlc291cmNlKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKICBtb2R1bGUuZXhwb3J0cyA9IHsKCiAgICAvLyBFeHBvcnQgdGhlIGBQb29sYCBjb25zdHJ1Y3Rvci4KICAgIFBvb2w6IFBvb2wsCgogICAgLy8gRXhwb3J0IHRoZSBQcmlvcml0eVF1ZXVlIGNvbnN0cnVjdG9yLCBpbiBjYXNlIGFueW9uZSB3YW50cyB0byBmaWRkbGUgd2l0aCB0aGF0LgogICAgUHJpb3JpdHlRdWV1ZTogUHJpb3JpdHlRdWV1ZQoKICB9OwoKfSk7Cgp9KSgKICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUgOiBmdW5jdGlvbiAoZmFjdG9yeSkgeyBmYWN0b3J5KHJlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZSk7IH0KKTsKfSx7fV0sMTIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKKGZ1bmN0aW9uIChwcm9jZXNzKXsKdmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7CnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7Cgptb2R1bGUuZXhwb3J0cyA9IG1rZGlyUC5ta2RpcnAgPSBta2RpclAubWtkaXJQID0gbWtkaXJQOwoKZnVuY3Rpb24gbWtkaXJQIChwLCBvcHRzLCBmLCBtYWRlKSB7CiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICBmID0gb3B0czsKICAgICAgICBvcHRzID0ge307CiAgICB9CiAgICBlbHNlIGlmICghb3B0cyB8fCB0eXBlb2Ygb3B0cyAhPT0gJ29iamVjdCcpIHsKICAgICAgICBvcHRzID0geyBtb2RlOiBvcHRzIH07CiAgICB9CiAgICAKICAgIHZhciBtb2RlID0gb3B0cy5tb2RlOwogICAgdmFyIHhmcyA9IG9wdHMuZnMgfHwgZnM7CiAgICAKICAgIGlmIChtb2RlID09PSB1bmRlZmluZWQpIHsKICAgICAgICBtb2RlID0gMDc3NyAmICh+cHJvY2Vzcy51bWFzaygpKTsKICAgIH0KICAgIGlmICghbWFkZSkgbWFkZSA9IG51bGw7CiAgICAKICAgIHZhciBjYiA9IGYgfHwgZnVuY3Rpb24gKCkge307CiAgICBwID0gcGF0aC5yZXNvbHZlKHApOwogICAgCiAgICB4ZnMubWtkaXIocCwgbW9kZSwgZnVuY3Rpb24gKGVyKSB7CiAgICAgICAgaWYgKCFlcikgewogICAgICAgICAgICBtYWRlID0gbWFkZSB8fCBwOwogICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbWFkZSk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoZXIuY29kZSkgewogICAgICAgICAgICBjYXNlICdFTk9FTlQnOgogICAgICAgICAgICAgICAgbWtkaXJQKHBhdGguZGlybmFtZShwKSwgb3B0cywgZnVuY3Rpb24gKGVyLCBtYWRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVyKSBjYihlciwgbWFkZSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBta2RpclAocCwgb3B0cywgY2IsIG1hZGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIC8vIEluIHRoZSBjYXNlIG9mIGFueSBvdGhlciBlcnJvciwganVzdCBzZWUgaWYgdGhlcmUncyBhIGRpcgogICAgICAgICAgICAvLyB0aGVyZSBhbHJlYWR5LiAgSWYgc28sIHRoZW4gaG9vcmF5ISAgSWYgbm90LCB0aGVuIHNvbWV0aGluZwogICAgICAgICAgICAvLyBpcyBib3JrZWQuCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB4ZnMuc3RhdChwLCBmdW5jdGlvbiAoZXIyLCBzdGF0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHN0YXQgZmFpbHMsIHRoZW4gdGhhdCdzIHN1cGVyIHdlaXJkLgogICAgICAgICAgICAgICAgICAgIC8vIGxldCB0aGUgb3JpZ2luYWwgZXJyb3IgYmUgdGhlIGZhaWx1cmUgcmVhc29uLgogICAgICAgICAgICAgICAgICAgIGlmIChlcjIgfHwgIXN0YXQuaXNEaXJlY3RvcnkoKSkgY2IoZXIsIG1hZGUpCiAgICAgICAgICAgICAgICAgICAgZWxzZSBjYihudWxsLCBtYWRlKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfSk7Cn0KCm1rZGlyUC5zeW5jID0gZnVuY3Rpb24gc3luYyAocCwgb3B0cywgbWFkZSkgewogICAgaWYgKCFvcHRzIHx8IHR5cGVvZiBvcHRzICE9PSAnb2JqZWN0JykgewogICAgICAgIG9wdHMgPSB7IG1vZGU6IG9wdHMgfTsKICAgIH0KICAgIAogICAgdmFyIG1vZGUgPSBvcHRzLm1vZGU7CiAgICB2YXIgeGZzID0gb3B0cy5mcyB8fCBmczsKICAgIAogICAgaWYgKG1vZGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIG1vZGUgPSAwNzc3ICYgKH5wcm9jZXNzLnVtYXNrKCkpOwogICAgfQogICAgaWYgKCFtYWRlKSBtYWRlID0gbnVsbDsKCiAgICBwID0gcGF0aC5yZXNvbHZlKHApOwoKICAgIHRyeSB7CiAgICAgICAgeGZzLm1rZGlyU3luYyhwLCBtb2RlKTsKICAgICAgICBtYWRlID0gbWFkZSB8fCBwOwogICAgfQogICAgY2F0Y2ggKGVycjApIHsKICAgICAgICBzd2l0Y2ggKGVycjAuY29kZSkgewogICAgICAgICAgICBjYXNlICdFTk9FTlQnIDoKICAgICAgICAgICAgICAgIG1hZGUgPSBzeW5jKHBhdGguZGlybmFtZShwKSwgb3B0cywgbWFkZSk7CiAgICAgICAgICAgICAgICBzeW5jKHAsIG9wdHMsIG1hZGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICAvLyBJbiB0aGUgY2FzZSBvZiBhbnkgb3RoZXIgZXJyb3IsIGp1c3Qgc2VlIGlmIHRoZXJlJ3MgYSBkaXIKICAgICAgICAgICAgLy8gdGhlcmUgYWxyZWFkeS4gIElmIHNvLCB0aGVuIGhvb3JheSEgIElmIG5vdCwgdGhlbiBzb21ldGhpbmcKICAgICAgICAgICAgLy8gaXMgYm9ya2VkLgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdmFyIHN0YXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXQgPSB4ZnMuc3RhdFN5bmMocCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXRjaCAoZXJyMSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXN0YXQuaXNEaXJlY3RvcnkoKSkgdGhyb3cgZXJyMDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbWFkZTsKfTsKCn0pLmNhbGwodGhpcyxyZXF1aXJlKCdfcHJvY2VzcycpKQp9LHsiX3Byb2Nlc3MiOjYwLCJmcyI6NTEsInBhdGgiOjU5fV0sMTIxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKYXJndW1lbnRzWzRdWzYyXVswXS5hcHBseShleHBvcnRzLGFyZ3VtZW50cykKfSx7Ii4vX3N0cmVhbV9yZWFkYWJsZSI6MTIzLCIuL19zdHJlYW1fd3JpdGFibGUiOjEyNSwiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvcmVhZGFibGUtc3RyZWFtL2xpYi9fc3RyZWFtX2R1cGxleC5qcyI6NjIsIl9wcm9jZXNzIjo2MCwiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Nn1dLDEyMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmFyZ3VtZW50c1s0XVs2M11bMF0uYXBwbHkoZXhwb3J0cyxhcmd1bWVudHMpCn0seyIuL19zdHJlYW1fdHJhbnNmb3JtIjoxMjQsIi9Vc2Vycy90Z3JpZXNzZXIvR2l0aHViL2Jvb2tzaGVsZi9ib29rc2hlbGYvbm9kZV9tb2R1bGVzL2Jyb3dzZXJpZnkvbm9kZV9tb2R1bGVzL3JlYWRhYmxlLXN0cmVhbS9saWIvX3N0cmVhbV9wYXNzdGhyb3VnaC5qcyI6NjMsImNvcmUtdXRpbC1pcyI6MTI2LCJpbmhlcml0cyI6NzZ9XSwxMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewooZnVuY3Rpb24gKHByb2Nlc3MpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgptb2R1bGUuZXhwb3J0cyA9IFJlYWRhYmxlOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIGlzQXJyYXkgPSByZXF1aXJlKCdpc2FycmF5Jyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciBCdWZmZXIgPSByZXF1aXJlKCdidWZmZXInKS5CdWZmZXI7Ci8qPC9yZXBsYWNlbWVudD4qLwoKUmVhZGFibGUuUmVhZGFibGVTdGF0ZSA9IFJlYWRhYmxlU3RhdGU7Cgp2YXIgRUUgPSByZXF1aXJlKCdldmVudHMnKS5FdmVudEVtaXR0ZXI7CgovKjxyZXBsYWNlbWVudD4qLwppZiAoIUVFLmxpc3RlbmVyQ291bnQpIEVFLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbihlbWl0dGVyLCB0eXBlKSB7CiAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJzKHR5cGUpLmxlbmd0aDsKfTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgdXRpbCA9IHJlcXVpcmUoJ2NvcmUtdXRpbC1pcycpOwp1dGlsLmluaGVyaXRzID0gcmVxdWlyZSgnaW5oZXJpdHMnKTsKLyo8L3JlcGxhY2VtZW50PiovCgp2YXIgU3RyaW5nRGVjb2RlcjsKCgovKjxyZXBsYWNlbWVudD4qLwp2YXIgZGVidWcgPSByZXF1aXJlKCd1dGlsJyk7CmlmIChkZWJ1ZyAmJiBkZWJ1Zy5kZWJ1Z2xvZykgewogIGRlYnVnID0gZGVidWcuZGVidWdsb2coJ3N0cmVhbScpOwp9IGVsc2UgewogIGRlYnVnID0gZnVuY3Rpb24gKCkge307Cn0KLyo8L3JlcGxhY2VtZW50PiovCgoKdXRpbC5pbmhlcml0cyhSZWFkYWJsZSwgU3RyZWFtKTsKCmZ1bmN0aW9uIFJlYWRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCBpdCBzdG9wcyBjYWxsaW5nIF9yZWFkKCkgdG8gZmlsbCB0aGUgYnVmZmVyCiAgLy8gTm90ZTogMCBpcyBhIHZhbGlkIHZhbHVlLCBtZWFucyAiZG9uJ3QgY2FsbCBfcmVhZCBwcmVlbXB0aXZlbHkgZXZlciIKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHZhciBkZWZhdWx0SHdtID0gb3B0aW9ucy5vYmplY3RNb2RlID8gMTYgOiAxNiAqIDEwMjQ7CiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gKGh3bSB8fCBod20gPT09IDApID8gaHdtIDogZGVmYXVsdEh3bTsKCiAgLy8gY2FzdCB0byBpbnRzLgogIHRoaXMuaGlnaFdhdGVyTWFyayA9IH5+dGhpcy5oaWdoV2F0ZXJNYXJrOwoKICB0aGlzLmJ1ZmZlciA9IFtdOwogIHRoaXMubGVuZ3RoID0gMDsKICB0aGlzLnBpcGVzID0gbnVsbDsKICB0aGlzLnBpcGVzQ291bnQgPSAwOwogIHRoaXMuZmxvd2luZyA9IG51bGw7CiAgdGhpcy5lbmRlZCA9IGZhbHNlOwogIHRoaXMuZW5kRW1pdHRlZCA9IGZhbHNlOwogIHRoaXMucmVhZGluZyA9IGZhbHNlOwoKICAvLyBhIGZsYWcgdG8gYmUgYWJsZSB0byB0ZWxsIGlmIHRoZSBvbndyaXRlIGNiIGlzIGNhbGxlZCBpbW1lZGlhdGVseSwKICAvLyBvciBvbiBhIGxhdGVyIHRpY2suICBXZSBzZXQgdGhpcyB0byB0cnVlIGF0IGZpcnN0LCBiZWNhdXNlIGFueQogIC8vIGFjdGlvbnMgdGhhdCBzaG91bGRuJ3QgaGFwcGVuIHVudGlsICJsYXRlciIgc2hvdWxkIGdlbmVyYWxseSBhbHNvCiAgLy8gbm90IGhhcHBlbiBiZWZvcmUgdGhlIGZpcnN0IHdyaXRlIGNhbGwuCiAgdGhpcy5zeW5jID0gdHJ1ZTsKCiAgLy8gd2hlbmV2ZXIgd2UgcmV0dXJuIG51bGwsIHRoZW4gd2Ugc2V0IGEgZmxhZyB0byBzYXkKICAvLyB0aGF0IHdlJ3JlIGF3YWl0aW5nIGEgJ3JlYWRhYmxlJyBldmVudCBlbWlzc2lvbi4KICB0aGlzLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIHRoaXMuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgdGhpcy5yZWFkYWJsZUxpc3RlbmluZyA9IGZhbHNlOwoKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnLiBVc2VkIHRvIG1ha2UgcmVhZChuKSBpZ25vcmUgbiBhbmQgdG8KICAvLyBtYWtlIGFsbCB0aGUgYnVmZmVyIG1lcmdpbmcgYW5kIGxlbmd0aCBjaGVja3MgZ28gYXdheQogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICBpZiAoc3RyZWFtIGluc3RhbmNlb2YgRHVwbGV4KQogICAgdGhpcy5vYmplY3RNb2RlID0gdGhpcy5vYmplY3RNb2RlIHx8ICEhb3B0aW9ucy5yZWFkYWJsZU9iamVjdE1vZGU7CgogIC8vIENyeXB0byBpcyBraW5kIG9mIG9sZCBhbmQgY3J1c3R5LiAgSGlzdG9yaWNhbGx5LCBpdHMgZGVmYXVsdCBzdHJpbmcKICAvLyBlbmNvZGluZyBpcyAnYmluYXJ5JyBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhpcyBjb25maWd1cmFibGUuCiAgLy8gRXZlcnl0aGluZyBlbHNlIGluIHRoZSB1bml2ZXJzZSB1c2VzICd1dGY4JywgdGhvdWdoLgogIHRoaXMuZGVmYXVsdEVuY29kaW5nID0gb3B0aW9ucy5kZWZhdWx0RW5jb2RpbmcgfHwgJ3V0ZjgnOwoKICAvLyB3aGVuIHBpcGluZywgd2Ugb25seSBjYXJlIGFib3V0ICdyZWFkYWJsZScgZXZlbnRzIHRoYXQgaGFwcGVuCiAgLy8gYWZ0ZXIgcmVhZCgpaW5nIGFsbCB0aGUgYnl0ZXMgYW5kIG5vdCBnZXR0aW5nIGFueSBwdXNoYmFjay4KICB0aGlzLnJhbk91dCA9IGZhbHNlOwoKICAvLyB0aGUgbnVtYmVyIG9mIHdyaXRlcnMgdGhhdCBhcmUgYXdhaXRpbmcgYSBkcmFpbiBldmVudCBpbiAucGlwZSgpcwogIHRoaXMuYXdhaXREcmFpbiA9IDA7CgogIC8vIGlmIHRydWUsIGEgbWF5YmVSZWFkTW9yZSBoYXMgYmVlbiBzY2hlZHVsZWQKICB0aGlzLnJlYWRpbmdNb3JlID0gZmFsc2U7CgogIHRoaXMuZGVjb2RlciA9IG51bGw7CiAgdGhpcy5lbmNvZGluZyA9IG51bGw7CiAgaWYgKG9wdGlvbnMuZW5jb2RpbmcpIHsKICAgIGlmICghU3RyaW5nRGVjb2RlcikKICAgICAgU3RyaW5nRGVjb2RlciA9IHJlcXVpcmUoJ3N0cmluZ19kZWNvZGVyLycpLlN0cmluZ0RlY29kZXI7CiAgICB0aGlzLmRlY29kZXIgPSBuZXcgU3RyaW5nRGVjb2RlcihvcHRpb25zLmVuY29kaW5nKTsKICAgIHRoaXMuZW5jb2RpbmcgPSBvcHRpb25zLmVuY29kaW5nOwogIH0KfQoKZnVuY3Rpb24gUmVhZGFibGUob3B0aW9ucykgewogIHZhciBEdXBsZXggPSByZXF1aXJlKCcuL19zdHJlYW1fZHVwbGV4Jyk7CgogIGlmICghKHRoaXMgaW5zdGFuY2VvZiBSZWFkYWJsZSkpCiAgICByZXR1cm4gbmV3IFJlYWRhYmxlKG9wdGlvbnMpOwoKICB0aGlzLl9yZWFkYWJsZVN0YXRlID0gbmV3IFJlYWRhYmxlU3RhdGUob3B0aW9ucywgdGhpcyk7CgogIC8vIGxlZ2FjeQogIHRoaXMucmVhZGFibGUgPSB0cnVlOwoKICBTdHJlYW0uY2FsbCh0aGlzKTsKfQoKLy8gTWFudWFsbHkgc2hvdmUgc29tZXRoaW5nIGludG8gdGhlIHJlYWQoKSBidWZmZXIuCi8vIFRoaXMgcmV0dXJucyB0cnVlIGlmIHRoZSBoaWdoV2F0ZXJNYXJrIGhhcyBub3QgYmVlbiBoaXQgeWV0LAovLyBzaW1pbGFyIHRvIGhvdyBXcml0YWJsZS53cml0ZSgpIHJldHVybnMgdHJ1ZSBpZiB5b3Ugc2hvdWxkCi8vIHdyaXRlKCkgc29tZSBtb3JlLgpSZWFkYWJsZS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIGlmICh1dGlsLmlzU3RyaW5nKGNodW5rKSAmJiAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZW5jb2RpbmcgPSBlbmNvZGluZyB8fCBzdGF0ZS5kZWZhdWx0RW5jb2Rpbmc7CiAgICBpZiAoZW5jb2RpbmcgIT09IHN0YXRlLmVuY29kaW5nKSB7CiAgICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogICAgICBlbmNvZGluZyA9ICcnOwogICAgfQogIH0KCiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgZmFsc2UpOwp9OwoKLy8gVW5zaGlmdCBzaG91bGQgKmFsd2F5cyogYmUgc29tZXRoaW5nIGRpcmVjdGx5IG91dCBvZiByZWFkKCkKUmVhZGFibGUucHJvdG90eXBlLnVuc2hpZnQgPSBmdW5jdGlvbihjaHVuaykgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgcmV0dXJuIHJlYWRhYmxlQWRkQ2h1bmsodGhpcywgc3RhdGUsIGNodW5rLCAnJywgdHJ1ZSk7Cn07CgpmdW5jdGlvbiByZWFkYWJsZUFkZENodW5rKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgYWRkVG9Gcm9udCkgewogIHZhciBlciA9IGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspOwogIGlmIChlcikgewogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogIH0gZWxzZSBpZiAodXRpbC5pc051bGxPclVuZGVmaW5lZChjaHVuaykpIHsKICAgIHN0YXRlLnJlYWRpbmcgPSBmYWxzZTsKICAgIGlmICghc3RhdGUuZW5kZWQpCiAgICAgIG9uRW9mQ2h1bmsoc3RyZWFtLCBzdGF0ZSk7CiAgfSBlbHNlIGlmIChzdGF0ZS5vYmplY3RNb2RlIHx8IGNodW5rICYmIGNodW5rLmxlbmd0aCA+IDApIHsKICAgIGlmIChzdGF0ZS5lbmRlZCAmJiAhYWRkVG9Gcm9udCkgewogICAgICB2YXIgZSA9IG5ldyBFcnJvcignc3RyZWFtLnB1c2goKSBhZnRlciBFT0YnKTsKICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZSk7CiAgICB9IGVsc2UgaWYgKHN0YXRlLmVuZEVtaXR0ZWQgJiYgYWRkVG9Gcm9udCkgewogICAgICB2YXIgZSA9IG5ldyBFcnJvcignc3RyZWFtLnVuc2hpZnQoKSBhZnRlciBlbmQgZXZlbnQnKTsKICAgICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZSk7CiAgICB9IGVsc2UgewogICAgICBpZiAoc3RhdGUuZGVjb2RlciAmJiAhYWRkVG9Gcm9udCAmJiAhZW5jb2RpbmcpCiAgICAgICAgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLndyaXRlKGNodW5rKTsKCiAgICAgIGlmICghYWRkVG9Gcm9udCkKICAgICAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CgogICAgICAvLyBpZiB3ZSB3YW50IHRoZSBkYXRhIG5vdywganVzdCBlbWl0IGl0LgogICAgICBpZiAoc3RhdGUuZmxvd2luZyAmJiBzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLnN5bmMpIHsKICAgICAgICBzdHJlYW0uZW1pdCgnZGF0YScsIGNodW5rKTsKICAgICAgICBzdHJlYW0ucmVhZCgwKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyB1cGRhdGUgdGhlIGJ1ZmZlciBpbmZvLgogICAgICAgIHN0YXRlLmxlbmd0aCArPSBzdGF0ZS5vYmplY3RNb2RlID8gMSA6IGNodW5rLmxlbmd0aDsKICAgICAgICBpZiAoYWRkVG9Gcm9udCkKICAgICAgICAgIHN0YXRlLmJ1ZmZlci51bnNoaWZ0KGNodW5rKTsKICAgICAgICBlbHNlCiAgICAgICAgICBzdGF0ZS5idWZmZXIucHVzaChjaHVuayk7CgogICAgICAgIGlmIChzdGF0ZS5uZWVkUmVhZGFibGUpCiAgICAgICAgICBlbWl0UmVhZGFibGUoc3RyZWFtKTsKICAgICAgfQoKICAgICAgbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKTsKICAgIH0KICB9IGVsc2UgaWYgKCFhZGRUb0Zyb250KSB7CiAgICBzdGF0ZS5yZWFkaW5nID0gZmFsc2U7CiAgfQoKICByZXR1cm4gbmVlZE1vcmVEYXRhKHN0YXRlKTsKfQoKCgovLyBpZiBpdCdzIHBhc3QgdGhlIGhpZ2ggd2F0ZXIgbWFyaywgd2UgY2FuIHB1c2ggaW4gc29tZSBtb3JlLgovLyBBbHNvLCBpZiB3ZSBoYXZlIG5vIGRhdGEgeWV0LCB3ZSBjYW4gc3RhbmQgc29tZQovLyBtb3JlIGJ5dGVzLiAgVGhpcyBpcyB0byB3b3JrIGFyb3VuZCBjYXNlcyB3aGVyZSBod209MCwKLy8gc3VjaCBhcyB0aGUgcmVwbC4gIEFsc28sIGlmIHRoZSBwdXNoKCkgdHJpZ2dlcmVkIGEKLy8gcmVhZGFibGUgZXZlbnQsIGFuZCB0aGUgdXNlciBjYWxsZWQgcmVhZChsYXJnZU51bWJlcikgc3VjaCB0aGF0Ci8vIG5lZWRSZWFkYWJsZSB3YXMgc2V0LCB0aGVuIHdlIG91Z2h0IHRvIHB1c2ggbW9yZSwgc28gdGhhdCBhbm90aGVyCi8vICdyZWFkYWJsZScgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQuCmZ1bmN0aW9uIG5lZWRNb3JlRGF0YShzdGF0ZSkgewogIHJldHVybiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgKHN0YXRlLm5lZWRSZWFkYWJsZSB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyayB8fAogICAgICAgICAgc3RhdGUubGVuZ3RoID09PSAwKTsKfQoKLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuClJlYWRhYmxlLnByb3RvdHlwZS5zZXRFbmNvZGluZyA9IGZ1bmN0aW9uKGVuYykgewogIGlmICghU3RyaW5nRGVjb2RlcikKICAgIFN0cmluZ0RlY29kZXIgPSByZXF1aXJlKCdzdHJpbmdfZGVjb2Rlci8nKS5TdHJpbmdEZWNvZGVyOwogIHRoaXMuX3JlYWRhYmxlU3RhdGUuZGVjb2RlciA9IG5ldyBTdHJpbmdEZWNvZGVyKGVuYyk7CiAgdGhpcy5fcmVhZGFibGVTdGF0ZS5lbmNvZGluZyA9IGVuYzsKICByZXR1cm4gdGhpczsKfTsKCi8vIERvbid0IHJhaXNlIHRoZSBod20gPiAxMjhNQgp2YXIgTUFYX0hXTSA9IDB4ODAwMDAwOwpmdW5jdGlvbiByb3VuZFVwVG9OZXh0UG93ZXJPZjIobikgewogIGlmIChuID49IE1BWF9IV00pIHsKICAgIG4gPSBNQVhfSFdNOwogIH0gZWxzZSB7CiAgICAvLyBHZXQgdGhlIG5leHQgaGlnaGVzdCBwb3dlciBvZiAyCiAgICBuLS07CiAgICBmb3IgKHZhciBwID0gMTsgcCA8IDMyOyBwIDw8PSAxKSBuIHw9IG4gPj4gcDsKICAgIG4rKzsKICB9CiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uIGhvd011Y2hUb1JlYWQobiwgc3RhdGUpIHsKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwICYmIHN0YXRlLmVuZGVkKQogICAgcmV0dXJuIDA7CgogIGlmIChzdGF0ZS5vYmplY3RNb2RlKQogICAgcmV0dXJuIG4gPT09IDAgPyAwIDogMTsKCiAgaWYgKGlzTmFOKG4pIHx8IHV0aWwuaXNOdWxsKG4pKSB7CiAgICAvLyBvbmx5IGZsb3cgb25lIGJ1ZmZlciBhdCBhIHRpbWUKICAgIGlmIChzdGF0ZS5mbG93aW5nICYmIHN0YXRlLmJ1ZmZlci5sZW5ndGgpCiAgICAgIHJldHVybiBzdGF0ZS5idWZmZXJbMF0ubGVuZ3RoOwogICAgZWxzZQogICAgICByZXR1cm4gc3RhdGUubGVuZ3RoOwogIH0KCiAgaWYgKG4gPD0gMCkKICAgIHJldHVybiAwOwoKICAvLyBJZiB3ZSdyZSBhc2tpbmcgZm9yIG1vcmUgdGhhbiB0aGUgdGFyZ2V0IGJ1ZmZlciBsZXZlbCwKICAvLyB0aGVuIHJhaXNlIHRoZSB3YXRlciBtYXJrLiAgQnVtcCB1cCB0byB0aGUgbmV4dCBoaWdoZXN0CiAgLy8gcG93ZXIgb2YgMiwgdG8gcHJldmVudCBpbmNyZWFzaW5nIGl0IGV4Y2Vzc2l2ZWx5IGluIHRpbnkKICAvLyBhbW91bnRzLgogIGlmIChuID4gc3RhdGUuaGlnaFdhdGVyTWFyaykKICAgIHN0YXRlLmhpZ2hXYXRlck1hcmsgPSByb3VuZFVwVG9OZXh0UG93ZXJPZjIobik7CgogIC8vIGRvbid0IGhhdmUgdGhhdCBtdWNoLiAgcmV0dXJuIG51bGwsIHVubGVzcyB3ZSd2ZSBlbmRlZC4KICBpZiAobiA+IHN0YXRlLmxlbmd0aCkgewogICAgaWYgKCFzdGF0ZS5lbmRlZCkgewogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgICByZXR1cm4gMDsKICAgIH0gZWxzZQogICAgICByZXR1cm4gc3RhdGUubGVuZ3RoOwogIH0KCiAgcmV0dXJuIG47Cn0KCi8vIHlvdSBjYW4gb3ZlcnJpZGUgZWl0aGVyIHRoaXMgbWV0aG9kLCBvciB0aGUgYXN5bmMgX3JlYWQobikgYmVsb3cuClJlYWRhYmxlLnByb3RvdHlwZS5yZWFkID0gZnVuY3Rpb24obikgewogIGRlYnVnKCdyZWFkJywgbik7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICB2YXIgbk9yaWcgPSBuOwoKICBpZiAoIXV0aWwuaXNOdW1iZXIobikgfHwgbiA+IDApCiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSBmYWxzZTsKCiAgLy8gaWYgd2UncmUgZG9pbmcgcmVhZCgwKSB0byB0cmlnZ2VyIGEgcmVhZGFibGUgZXZlbnQsIGJ1dCB3ZQogIC8vIGFscmVhZHkgaGF2ZSBhIGJ1bmNoIG9mIGRhdGEgaW4gdGhlIGJ1ZmZlciwgdGhlbiBqdXN0IHRyaWdnZXIKICAvLyB0aGUgJ3JlYWRhYmxlJyBldmVudCBhbmQgbW92ZSBvbi4KICBpZiAobiA9PT0gMCAmJgogICAgICBzdGF0ZS5uZWVkUmVhZGFibGUgJiYKICAgICAgKHN0YXRlLmxlbmd0aCA+PSBzdGF0ZS5oaWdoV2F0ZXJNYXJrIHx8IHN0YXRlLmVuZGVkKSkgewogICAgZGVidWcoJ3JlYWQ6IGVtaXRSZWFkYWJsZScsIHN0YXRlLmxlbmd0aCwgc3RhdGUuZW5kZWQpOwogICAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCAmJiBzdGF0ZS5lbmRlZCkKICAgICAgZW5kUmVhZGFibGUodGhpcyk7CiAgICBlbHNlCiAgICAgIGVtaXRSZWFkYWJsZSh0aGlzKTsKICAgIHJldHVybiBudWxsOwogIH0KCiAgbiA9IGhvd011Y2hUb1JlYWQobiwgc3RhdGUpOwoKICAvLyBpZiB3ZSd2ZSBlbmRlZCwgYW5kIHdlJ3JlIG5vdyBjbGVhciwgdGhlbiBmaW5pc2ggaXQgdXAuCiAgaWYgKG4gPT09IDAgJiYgc3RhdGUuZW5kZWQpIHsKICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDApCiAgICAgIGVuZFJlYWRhYmxlKHRoaXMpOwogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvLyBBbGwgdGhlIGFjdHVhbCBjaHVuayBnZW5lcmF0aW9uIGxvZ2ljIG5lZWRzIHRvIGJlCiAgLy8gKmJlbG93KiB0aGUgY2FsbCB0byBfcmVhZC4gIFRoZSByZWFzb24gaXMgdGhhdCBpbiBjZXJ0YWluCiAgLy8gc3ludGhldGljIHN0cmVhbSBjYXNlcywgc3VjaCBhcyBwYXNzdGhyb3VnaCBzdHJlYW1zLCBfcmVhZAogIC8vIG1heSBiZSBhIGNvbXBsZXRlbHkgc3luY2hyb25vdXMgb3BlcmF0aW9uIHdoaWNoIG1heSBjaGFuZ2UKICAvLyB0aGUgc3RhdGUgb2YgdGhlIHJlYWQgYnVmZmVyLCBwcm92aWRpbmcgZW5vdWdoIGRhdGEgd2hlbgogIC8vIGJlZm9yZSB0aGVyZSB3YXMgKm5vdCogZW5vdWdoLgogIC8vCiAgLy8gU28sIHRoZSBzdGVwcyBhcmU6CiAgLy8gMS4gRmlndXJlIG91dCB3aGF0IHRoZSBzdGF0ZSBvZiB0aGluZ3Mgd2lsbCBiZSBhZnRlciB3ZSBkbwogIC8vIGEgcmVhZCBmcm9tIHRoZSBidWZmZXIuCiAgLy8KICAvLyAyLiBJZiB0aGF0IHJlc3VsdGluZyBzdGF0ZSB3aWxsIHRyaWdnZXIgYSBfcmVhZCwgdGhlbiBjYWxsIF9yZWFkLgogIC8vIE5vdGUgdGhhdCB0aGlzIG1heSBiZSBhc3luY2hyb25vdXMsIG9yIHN5bmNocm9ub3VzLiAgWWVzLCBpdCBpcwogIC8vIGRlZXBseSB1Z2x5IHRvIHdyaXRlIEFQSXMgdGhpcyB3YXksIGJ1dCB0aGF0IHN0aWxsIGRvZXNuJ3QgbWVhbgogIC8vIHRoYXQgdGhlIFJlYWRhYmxlIGNsYXNzIHNob3VsZCBiZWhhdmUgaW1wcm9wZXJseSwgYXMgc3RyZWFtcyBhcmUKICAvLyBkZXNpZ25lZCB0byBiZSBzeW5jL2FzeW5jIGFnbm9zdGljLgogIC8vIFRha2Ugbm90ZSBpZiB0aGUgX3JlYWQgY2FsbCBpcyBzeW5jIG9yIGFzeW5jIChpZSwgaWYgdGhlIHJlYWQgY2FsbAogIC8vIGhhcyByZXR1cm5lZCB5ZXQpLCBzbyB0aGF0IHdlIGtub3cgd2hldGhlciBvciBub3QgaXQncyBzYWZlIHRvIGVtaXQKICAvLyAncmVhZGFibGUnIGV0Yy4KICAvLwogIC8vIDMuIEFjdHVhbGx5IHB1bGwgdGhlIHJlcXVlc3RlZCBjaHVua3Mgb3V0IG9mIHRoZSBidWZmZXIgYW5kIHJldHVybi4KCiAgLy8gaWYgd2UgbmVlZCBhIHJlYWRhYmxlIGV2ZW50LCB0aGVuIHdlIG5lZWQgdG8gZG8gc29tZSByZWFkaW5nLgogIHZhciBkb1JlYWQgPSBzdGF0ZS5uZWVkUmVhZGFibGU7CiAgZGVidWcoJ25lZWQgcmVhZGFibGUnLCBkb1JlYWQpOwoKICAvLyBpZiB3ZSBjdXJyZW50bHkgaGF2ZSBsZXNzIHRoYW4gdGhlIGhpZ2hXYXRlck1hcmssIHRoZW4gYWxzbyByZWFkIHNvbWUKICBpZiAoc3RhdGUubGVuZ3RoID09PSAwIHx8IHN0YXRlLmxlbmd0aCAtIG4gPCBzdGF0ZS5oaWdoV2F0ZXJNYXJrKSB7CiAgICBkb1JlYWQgPSB0cnVlOwogICAgZGVidWcoJ2xlbmd0aCBsZXNzIHRoYW4gd2F0ZXJtYXJrJywgZG9SZWFkKTsKICB9CgogIC8vIGhvd2V2ZXIsIGlmIHdlJ3ZlIGVuZGVkLCB0aGVuIHRoZXJlJ3Mgbm8gcG9pbnQsIGFuZCBpZiB3ZSdyZSBhbHJlYWR5CiAgLy8gcmVhZGluZywgdGhlbiBpdCdzIHVubmVjZXNzYXJ5LgogIGlmIChzdGF0ZS5lbmRlZCB8fCBzdGF0ZS5yZWFkaW5nKSB7CiAgICBkb1JlYWQgPSBmYWxzZTsKICAgIGRlYnVnKCdyZWFkaW5nIG9yIGVuZGVkJywgZG9SZWFkKTsKICB9CgogIGlmIChkb1JlYWQpIHsKICAgIGRlYnVnKCdkbyByZWFkJyk7CiAgICBzdGF0ZS5yZWFkaW5nID0gdHJ1ZTsKICAgIHN0YXRlLnN5bmMgPSB0cnVlOwogICAgLy8gaWYgdGhlIGxlbmd0aCBpcyBjdXJyZW50bHkgemVybywgdGhlbiB3ZSAqbmVlZCogYSByZWFkYWJsZSBldmVudC4KICAgIGlmIChzdGF0ZS5sZW5ndGggPT09IDApCiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAvLyBjYWxsIGludGVybmFsIHJlYWQgbWV0aG9kCiAgICB0aGlzLl9yZWFkKHN0YXRlLmhpZ2hXYXRlck1hcmspOwogICAgc3RhdGUuc3luYyA9IGZhbHNlOwogIH0KCiAgLy8gSWYgX3JlYWQgcHVzaGVkIGRhdGEgc3luY2hyb25vdXNseSwgdGhlbiBgcmVhZGluZ2Agd2lsbCBiZSBmYWxzZSwKICAvLyBhbmQgd2UgbmVlZCB0byByZS1ldmFsdWF0ZSBob3cgbXVjaCBkYXRhIHdlIGNhbiByZXR1cm4gdG8gdGhlIHVzZXIuCiAgaWYgKGRvUmVhZCAmJiAhc3RhdGUucmVhZGluZykKICAgIG4gPSBob3dNdWNoVG9SZWFkKG5PcmlnLCBzdGF0ZSk7CgogIHZhciByZXQ7CiAgaWYgKG4gPiAwKQogICAgcmV0ID0gZnJvbUxpc3Qobiwgc3RhdGUpOwogIGVsc2UKICAgIHJldCA9IG51bGw7CgogIGlmICh1dGlsLmlzTnVsbChyZXQpKSB7CiAgICBzdGF0ZS5uZWVkUmVhZGFibGUgPSB0cnVlOwogICAgbiA9IDA7CiAgfQoKICBzdGF0ZS5sZW5ndGggLT0gbjsKCiAgLy8gSWYgd2UgaGF2ZSBub3RoaW5nIGluIHRoZSBidWZmZXIsIHRoZW4gd2Ugd2FudCB0byBrbm93CiAgLy8gYXMgc29vbiBhcyB3ZSAqZG8qIGdldCBzb21ldGhpbmcgaW50byB0aGUgYnVmZmVyLgogIGlmIChzdGF0ZS5sZW5ndGggPT09IDAgJiYgIXN0YXRlLmVuZGVkKQogICAgc3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gSWYgd2UgdHJpZWQgdG8gcmVhZCgpIHBhc3QgdGhlIEVPRiwgdGhlbiBlbWl0IGVuZCBvbiB0aGUgbmV4dCB0aWNrLgogIGlmIChuT3JpZyAhPT0gbiAmJiBzdGF0ZS5lbmRlZCAmJiBzdGF0ZS5sZW5ndGggPT09IDApCiAgICBlbmRSZWFkYWJsZSh0aGlzKTsKCiAgaWYgKCF1dGlsLmlzTnVsbChyZXQpKQogICAgdGhpcy5lbWl0KCdkYXRhJywgcmV0KTsKCiAgcmV0dXJuIHJldDsKfTsKCmZ1bmN0aW9uIGNodW5rSW52YWxpZChzdGF0ZSwgY2h1bmspIHsKICB2YXIgZXIgPSBudWxsOwogIGlmICghdXRpbC5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgIXV0aWwuaXNTdHJpbmcoY2h1bmspICYmCiAgICAgICF1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNodW5rKSAmJgogICAgICAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgZXIgPSBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG5vbi1zdHJpbmcvYnVmZmVyIGNodW5rJyk7CiAgfQogIHJldHVybiBlcjsKfQoKCmZ1bmN0aW9uIG9uRW9mQ2h1bmsoc3RyZWFtLCBzdGF0ZSkgewogIGlmIChzdGF0ZS5kZWNvZGVyICYmICFzdGF0ZS5lbmRlZCkgewogICAgdmFyIGNodW5rID0gc3RhdGUuZGVjb2Rlci5lbmQoKTsKICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpIHsKICAgICAgc3RhdGUuYnVmZmVyLnB1c2goY2h1bmspOwogICAgICBzdGF0ZS5sZW5ndGggKz0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CiAgICB9CiAgfQogIHN0YXRlLmVuZGVkID0gdHJ1ZTsKCiAgLy8gZW1pdCAncmVhZGFibGUnIG5vdyB0byBtYWtlIHN1cmUgaXQgZ2V0cyBwaWNrZWQgdXAuCiAgZW1pdFJlYWRhYmxlKHN0cmVhbSk7Cn0KCi8vIERvbid0IGVtaXQgcmVhZGFibGUgcmlnaHQgYXdheSBpbiBzeW5jIG1vZGUsIGJlY2F1c2UgdGhpcyBjYW4gdHJpZ2dlcgovLyBhbm90aGVyIHJlYWQoKSBjYWxsID0+IHN0YWNrIG92ZXJmbG93LiAgVGhpcyB3YXksIGl0IG1pZ2h0IHRyaWdnZXIKLy8gYSBuZXh0VGljayByZWN1cnNpb24gd2FybmluZywgYnV0IHRoYXQncyBub3Qgc28gYmFkLgpmdW5jdGlvbiBlbWl0UmVhZGFibGUoc3RyZWFtKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl9yZWFkYWJsZVN0YXRlOwogIHN0YXRlLm5lZWRSZWFkYWJsZSA9IGZhbHNlOwogIGlmICghc3RhdGUuZW1pdHRlZFJlYWRhYmxlKSB7CiAgICBkZWJ1ZygnZW1pdFJlYWRhYmxlJywgc3RhdGUuZmxvd2luZyk7CiAgICBzdGF0ZS5lbWl0dGVkUmVhZGFibGUgPSB0cnVlOwogICAgaWYgKHN0YXRlLnN5bmMpCiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgZW1pdFJlYWRhYmxlXyhzdHJlYW0pOwogICAgICB9KTsKICAgIGVsc2UKICAgICAgZW1pdFJlYWRhYmxlXyhzdHJlYW0pOwogIH0KfQoKZnVuY3Rpb24gZW1pdFJlYWRhYmxlXyhzdHJlYW0pIHsKICBkZWJ1ZygnZW1pdCByZWFkYWJsZScpOwogIHN0cmVhbS5lbWl0KCdyZWFkYWJsZScpOwogIGZsb3coc3RyZWFtKTsKfQoKCi8vIGF0IHRoaXMgcG9pbnQsIHRoZSB1c2VyIGhhcyBwcmVzdW1hYmx5IHNlZW4gdGhlICdyZWFkYWJsZScgZXZlbnQsCi8vIGFuZCBjYWxsZWQgcmVhZCgpIHRvIGNvbnN1bWUgc29tZSBkYXRhLiAgdGhhdCBtYXkgaGF2ZSB0cmlnZ2VyZWQKLy8gaW4gdHVybiBhbm90aGVyIF9yZWFkKG4pIGNhbGwsIGluIHdoaWNoIGNhc2UgcmVhZGluZyA9IHRydWUgaWYKLy8gaXQncyBpbiBwcm9ncmVzcy4KLy8gSG93ZXZlciwgaWYgd2UncmUgbm90IGVuZGVkLCBvciByZWFkaW5nLCBhbmQgdGhlIGxlbmd0aCA8IGh3bSwKLy8gdGhlbiBnbyBhaGVhZCBhbmQgdHJ5IHRvIHJlYWQgc29tZSBtb3JlIHByZWVtcHRpdmVseS4KZnVuY3Rpb24gbWF5YmVSZWFkTW9yZShzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5yZWFkaW5nTW9yZSkgewogICAgc3RhdGUucmVhZGluZ01vcmUgPSB0cnVlOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgbWF5YmVSZWFkTW9yZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIG1heWJlUmVhZE1vcmVfKHN0cmVhbSwgc3RhdGUpIHsKICB2YXIgbGVuID0gc3RhdGUubGVuZ3RoOwogIHdoaWxlICghc3RhdGUucmVhZGluZyAmJiAhc3RhdGUuZmxvd2luZyAmJiAhc3RhdGUuZW5kZWQgJiYKICAgICAgICAgc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyaykgewogICAgZGVidWcoJ21heWJlUmVhZE1vcmUgcmVhZCAwJyk7CiAgICBzdHJlYW0ucmVhZCgwKTsKICAgIGlmIChsZW4gPT09IHN0YXRlLmxlbmd0aCkKICAgICAgLy8gZGlkbid0IGdldCBhbnkgZGF0YSwgc3RvcCBzcGlubmluZy4KICAgICAgYnJlYWs7CiAgICBlbHNlCiAgICAgIGxlbiA9IHN0YXRlLmxlbmd0aDsKICB9CiAgc3RhdGUucmVhZGluZ01vcmUgPSBmYWxzZTsKfQoKLy8gYWJzdHJhY3QgbWV0aG9kLiAgdG8gYmUgb3ZlcnJpZGRlbiBpbiBzcGVjaWZpYyBpbXBsZW1lbnRhdGlvbiBjbGFzc2VzLgovLyBjYWxsIGNiKGVyLCBkYXRhKSB3aGVyZSBkYXRhIGlzIDw9IG4gaW4gbGVuZ3RoLgovLyBmb3IgdmlydHVhbCAobm9uLXN0cmluZywgbm9uLWJ1ZmZlcikgc3RyZWFtcywgImxlbmd0aCIgaXMgc29tZXdoYXQKLy8gYXJiaXRyYXJ5LCBhbmQgcGVyaGFwcyBub3QgdmVyeSBtZWFuaW5nZnVsLgpSZWFkYWJsZS5wcm90b3R5cGUuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignbm90IGltcGxlbWVudGVkJykpOwp9OwoKUmVhZGFibGUucHJvdG90eXBlLnBpcGUgPSBmdW5jdGlvbihkZXN0LCBwaXBlT3B0cykgewogIHZhciBzcmMgPSB0aGlzOwogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIHN3aXRjaCAoc3RhdGUucGlwZXNDb3VudCkgewogICAgY2FzZSAwOgogICAgICBzdGF0ZS5waXBlcyA9IGRlc3Q7CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOgogICAgICBzdGF0ZS5waXBlcyA9IFtzdGF0ZS5waXBlcywgZGVzdF07CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgc3RhdGUucGlwZXMucHVzaChkZXN0KTsKICAgICAgYnJlYWs7CiAgfQogIHN0YXRlLnBpcGVzQ291bnQgKz0gMTsKICBkZWJ1ZygncGlwZSBjb3VudD0lZCBvcHRzPSVqJywgc3RhdGUucGlwZXNDb3VudCwgcGlwZU9wdHMpOwoKICB2YXIgZG9FbmQgPSAoIXBpcGVPcHRzIHx8IHBpcGVPcHRzLmVuZCAhPT0gZmFsc2UpICYmCiAgICAgICAgICAgICAgZGVzdCAhPT0gcHJvY2Vzcy5zdGRvdXQgJiYKICAgICAgICAgICAgICBkZXN0ICE9PSBwcm9jZXNzLnN0ZGVycjsKCiAgdmFyIGVuZEZuID0gZG9FbmQgPyBvbmVuZCA6IGNsZWFudXA7CiAgaWYgKHN0YXRlLmVuZEVtaXR0ZWQpCiAgICBwcm9jZXNzLm5leHRUaWNrKGVuZEZuKTsKICBlbHNlCiAgICBzcmMub25jZSgnZW5kJywgZW5kRm4pOwoKICBkZXN0Lm9uKCd1bnBpcGUnLCBvbnVucGlwZSk7CiAgZnVuY3Rpb24gb251bnBpcGUocmVhZGFibGUpIHsKICAgIGRlYnVnKCdvbnVucGlwZScpOwogICAgaWYgKHJlYWRhYmxlID09PSBzcmMpIHsKICAgICAgY2xlYW51cCgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25lbmQoKSB7CiAgICBkZWJ1Zygnb25lbmQnKTsKICAgIGRlc3QuZW5kKCk7CiAgfQoKICAvLyB3aGVuIHRoZSBkZXN0IGRyYWlucywgaXQgcmVkdWNlcyB0aGUgYXdhaXREcmFpbiBjb3VudGVyCiAgLy8gb24gdGhlIHNvdXJjZS4gIFRoaXMgd291bGQgYmUgbW9yZSBlbGVnYW50IHdpdGggYSAub25jZSgpCiAgLy8gaGFuZGxlciBpbiBmbG93KCksIGJ1dCBhZGRpbmcgYW5kIHJlbW92aW5nIHJlcGVhdGVkbHkgaXMKICAvLyB0b28gc2xvdy4KICB2YXIgb25kcmFpbiA9IHBpcGVPbkRyYWluKHNyYyk7CiAgZGVzdC5vbignZHJhaW4nLCBvbmRyYWluKTsKCiAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgIGRlYnVnKCdjbGVhbnVwJyk7CiAgICAvLyBjbGVhbnVwIGV2ZW50IGhhbmRsZXJzIG9uY2UgdGhlIHBpcGUgaXMgYnJva2VuCiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdjbG9zZScsIG9uY2xvc2UpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZmluaXNoJywgb25maW5pc2gpOwogICAgZGVzdC5yZW1vdmVMaXN0ZW5lcignZHJhaW4nLCBvbmRyYWluKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgb25lcnJvcik7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCd1bnBpcGUnLCBvbnVucGlwZSk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uZW5kKTsKICAgIHNyYy5yZW1vdmVMaXN0ZW5lcignZW5kJywgY2xlYW51cCk7CiAgICBzcmMucmVtb3ZlTGlzdGVuZXIoJ2RhdGEnLCBvbmRhdGEpOwoKICAgIC8vIGlmIHRoZSByZWFkZXIgaXMgd2FpdGluZyBmb3IgYSBkcmFpbiBldmVudCBmcm9tIHRoaXMKICAgIC8vIHNwZWNpZmljIHdyaXRlciwgdGhlbiBpdCB3b3VsZCBjYXVzZSBpdCB0byBuZXZlciBzdGFydAogICAgLy8gZmxvd2luZyBhZ2Fpbi4KICAgIC8vIFNvLCBpZiB0aGlzIGlzIGF3YWl0aW5nIGEgZHJhaW4sIHRoZW4gd2UganVzdCBjYWxsIGl0IG5vdy4KICAgIC8vIElmIHdlIGRvbid0IGtub3csIHRoZW4gYXNzdW1lIHRoYXQgd2UgYXJlIHdhaXRpbmcgZm9yIG9uZS4KICAgIGlmIChzdGF0ZS5hd2FpdERyYWluICYmCiAgICAgICAgKCFkZXN0Ll93cml0YWJsZVN0YXRlIHx8IGRlc3QuX3dyaXRhYmxlU3RhdGUubmVlZERyYWluKSkKICAgICAgb25kcmFpbigpOwogIH0KCiAgc3JjLm9uKCdkYXRhJywgb25kYXRhKTsKICBmdW5jdGlvbiBvbmRhdGEoY2h1bmspIHsKICAgIGRlYnVnKCdvbmRhdGEnKTsKICAgIHZhciByZXQgPSBkZXN0LndyaXRlKGNodW5rKTsKICAgIGlmIChmYWxzZSA9PT0gcmV0KSB7CiAgICAgIGRlYnVnKCdmYWxzZSB3cml0ZSByZXNwb25zZSwgcGF1c2UnLAogICAgICAgICAgICBzcmMuX3JlYWRhYmxlU3RhdGUuYXdhaXREcmFpbik7CiAgICAgIHNyYy5fcmVhZGFibGVTdGF0ZS5hd2FpdERyYWluKys7CiAgICAgIHNyYy5wYXVzZSgpOwogICAgfQogIH0KCiAgLy8gaWYgdGhlIGRlc3QgaGFzIGFuIGVycm9yLCB0aGVuIHN0b3AgcGlwaW5nIGludG8gaXQuCiAgLy8gaG93ZXZlciwgZG9uJ3Qgc3VwcHJlc3MgdGhlIHRocm93aW5nIGJlaGF2aW9yIGZvciB0aGlzLgogIGZ1bmN0aW9uIG9uZXJyb3IoZXIpIHsKICAgIGRlYnVnKCdvbmVycm9yJywgZXIpOwogICAgdW5waXBlKCk7CiAgICBkZXN0LnJlbW92ZUxpc3RlbmVyKCdlcnJvcicsIG9uZXJyb3IpOwogICAgaWYgKEVFLmxpc3RlbmVyQ291bnQoZGVzdCwgJ2Vycm9yJykgPT09IDApCiAgICAgIGRlc3QuZW1pdCgnZXJyb3InLCBlcik7CiAgfQogIC8vIFRoaXMgaXMgYSBicnV0YWxseSB1Z2x5IGhhY2sgdG8gbWFrZSBzdXJlIHRoYXQgb3VyIGVycm9yIGhhbmRsZXIKICAvLyBpcyBhdHRhY2hlZCBiZWZvcmUgYW55IHVzZXJsYW5kIG9uZXMuICBORVZFUiBETyBUSElTLgogIGlmICghZGVzdC5fZXZlbnRzIHx8ICFkZXN0Ll9ldmVudHMuZXJyb3IpCiAgICBkZXN0Lm9uKCdlcnJvcicsIG9uZXJyb3IpOwogIGVsc2UgaWYgKGlzQXJyYXkoZGVzdC5fZXZlbnRzLmVycm9yKSkKICAgIGRlc3QuX2V2ZW50cy5lcnJvci51bnNoaWZ0KG9uZXJyb3IpOwogIGVsc2UKICAgIGRlc3QuX2V2ZW50cy5lcnJvciA9IFtvbmVycm9yLCBkZXN0Ll9ldmVudHMuZXJyb3JdOwoKCgogIC8vIEJvdGggY2xvc2UgYW5kIGZpbmlzaCBzaG91bGQgdHJpZ2dlciB1bnBpcGUsIGJ1dCBvbmx5IG9uY2UuCiAgZnVuY3Rpb24gb25jbG9zZSgpIHsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2ZpbmlzaCcsIG9uZmluaXNoKTsKICAgIHVucGlwZSgpOwogIH0KICBkZXN0Lm9uY2UoJ2Nsb3NlJywgb25jbG9zZSk7CiAgZnVuY3Rpb24gb25maW5pc2goKSB7CiAgICBkZWJ1Zygnb25maW5pc2gnKTsKICAgIGRlc3QucmVtb3ZlTGlzdGVuZXIoJ2Nsb3NlJywgb25jbG9zZSk7CiAgICB1bnBpcGUoKTsKICB9CiAgZGVzdC5vbmNlKCdmaW5pc2gnLCBvbmZpbmlzaCk7CgogIGZ1bmN0aW9uIHVucGlwZSgpIHsKICAgIGRlYnVnKCd1bnBpcGUnKTsKICAgIHNyYy51bnBpcGUoZGVzdCk7CiAgfQoKICAvLyB0ZWxsIHRoZSBkZXN0IHRoYXQgaXQncyBiZWluZyBwaXBlZCB0bwogIGRlc3QuZW1pdCgncGlwZScsIHNyYyk7CgogIC8vIHN0YXJ0IHRoZSBmbG93IGlmIGl0IGhhc24ndCBiZWVuIHN0YXJ0ZWQgYWxyZWFkeS4KICBpZiAoIXN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdwaXBlIHJlc3VtZScpOwogICAgc3JjLnJlc3VtZSgpOwogIH0KCiAgcmV0dXJuIGRlc3Q7Cn07CgpmdW5jdGlvbiBwaXBlT25EcmFpbihzcmMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgc3RhdGUgPSBzcmMuX3JlYWRhYmxlU3RhdGU7CiAgICBkZWJ1ZygncGlwZU9uRHJhaW4nLCBzdGF0ZS5hd2FpdERyYWluKTsKICAgIGlmIChzdGF0ZS5hd2FpdERyYWluKQogICAgICBzdGF0ZS5hd2FpdERyYWluLS07CiAgICBpZiAoc3RhdGUuYXdhaXREcmFpbiA9PT0gMCAmJiBFRS5saXN0ZW5lckNvdW50KHNyYywgJ2RhdGEnKSkgewogICAgICBzdGF0ZS5mbG93aW5nID0gdHJ1ZTsKICAgICAgZmxvdyhzcmMpOwogICAgfQogIH07Cn0KCgpSZWFkYWJsZS5wcm90b3R5cGUudW5waXBlID0gZnVuY3Rpb24oZGVzdCkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CgogIC8vIGlmIHdlJ3JlIG5vdCBwaXBpbmcgYW55d2hlcmUsIHRoZW4gZG8gbm90aGluZy4KICBpZiAoc3RhdGUucGlwZXNDb3VudCA9PT0gMCkKICAgIHJldHVybiB0aGlzOwoKICAvLyBqdXN0IG9uZSBkZXN0aW5hdGlvbi4gIG1vc3QgY29tbW9uIGNhc2UuCiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpIHsKICAgIC8vIHBhc3NlZCBpbiBvbmUsIGJ1dCBpdCdzIG5vdCB0aGUgcmlnaHQgb25lLgogICAgaWYgKGRlc3QgJiYgZGVzdCAhPT0gc3RhdGUucGlwZXMpCiAgICAgIHJldHVybiB0aGlzOwoKICAgIGlmICghZGVzdCkKICAgICAgZGVzdCA9IHN0YXRlLnBpcGVzOwoKICAgIC8vIGdvdCBhIG1hdGNoLgogICAgc3RhdGUucGlwZXMgPSBudWxsOwogICAgc3RhdGUucGlwZXNDb3VudCA9IDA7CiAgICBzdGF0ZS5mbG93aW5nID0gZmFsc2U7CiAgICBpZiAoZGVzdCkKICAgICAgZGVzdC5lbWl0KCd1bnBpcGUnLCB0aGlzKTsKICAgIHJldHVybiB0aGlzOwogIH0KCiAgLy8gc2xvdyBjYXNlLiBtdWx0aXBsZSBwaXBlIGRlc3RpbmF0aW9ucy4KCiAgaWYgKCFkZXN0KSB7CiAgICAvLyByZW1vdmUgYWxsLgogICAgdmFyIGRlc3RzID0gc3RhdGUucGlwZXM7CiAgICB2YXIgbGVuID0gc3RhdGUucGlwZXNDb3VudDsKICAgIHN0YXRlLnBpcGVzID0gbnVsbDsKICAgIHN0YXRlLnBpcGVzQ291bnQgPSAwOwogICAgc3RhdGUuZmxvd2luZyA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspCiAgICAgIGRlc3RzW2ldLmVtaXQoJ3VucGlwZScsIHRoaXMpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICAvLyB0cnkgdG8gZmluZCB0aGUgcmlnaHQgb25lLgogIHZhciBpID0gaW5kZXhPZihzdGF0ZS5waXBlcywgZGVzdCk7CiAgaWYgKGkgPT09IC0xKQogICAgcmV0dXJuIHRoaXM7CgogIHN0YXRlLnBpcGVzLnNwbGljZShpLCAxKTsKICBzdGF0ZS5waXBlc0NvdW50IC09IDE7CiAgaWYgKHN0YXRlLnBpcGVzQ291bnQgPT09IDEpCiAgICBzdGF0ZS5waXBlcyA9IHN0YXRlLnBpcGVzWzBdOwoKICBkZXN0LmVtaXQoJ3VucGlwZScsIHRoaXMpOwoKICByZXR1cm4gdGhpczsKfTsKCi8vIHNldCB1cCBkYXRhIGV2ZW50cyBpZiB0aGV5IGFyZSBhc2tlZCBmb3IKLy8gRW5zdXJlIHJlYWRhYmxlIGxpc3RlbmVycyBldmVudHVhbGx5IGdldCBzb21ldGhpbmcKUmVhZGFibGUucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXYsIGZuKSB7CiAgdmFyIHJlcyA9IFN0cmVhbS5wcm90b3R5cGUub24uY2FsbCh0aGlzLCBldiwgZm4pOwoKICAvLyBJZiBsaXN0ZW5pbmcgdG8gZGF0YSwgYW5kIGl0IGhhcyBub3QgZXhwbGljaXRseSBiZWVuIHBhdXNlZCwKICAvLyB0aGVuIGNhbGwgcmVzdW1lIHRvIHN0YXJ0IHRoZSBmbG93IG9mIGRhdGEgb24gdGhlIG5leHQgdGljay4KICBpZiAoZXYgPT09ICdkYXRhJyAmJiBmYWxzZSAhPT0gdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nKSB7CiAgICB0aGlzLnJlc3VtZSgpOwogIH0KCiAgaWYgKGV2ID09PSAncmVhZGFibGUnICYmIHRoaXMucmVhZGFibGUpIHsKICAgIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgICBpZiAoIXN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nKSB7CiAgICAgIHN0YXRlLnJlYWRhYmxlTGlzdGVuaW5nID0gdHJ1ZTsKICAgICAgc3RhdGUuZW1pdHRlZFJlYWRhYmxlID0gZmFsc2U7CiAgICAgIHN0YXRlLm5lZWRSZWFkYWJsZSA9IHRydWU7CiAgICAgIGlmICghc3RhdGUucmVhZGluZykgewogICAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgZGVidWcoJ3JlYWRhYmxlIG5leHR0aWNrIHJlYWQgMCcpOwogICAgICAgICAgc2VsZi5yZWFkKDApOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHN0YXRlLmxlbmd0aCkgewogICAgICAgIGVtaXRSZWFkYWJsZSh0aGlzLCBzdGF0ZSk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXM7Cn07ClJlYWRhYmxlLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IFJlYWRhYmxlLnByb3RvdHlwZS5vbjsKCi8vIHBhdXNlKCkgYW5kIHJlc3VtZSgpIGFyZSByZW1uYW50cyBvZiB0aGUgbGVnYWN5IHJlYWRhYmxlIHN0cmVhbSBBUEkKLy8gSWYgdGhlIHVzZXIgdXNlcyB0aGVtLCB0aGVuIHN3aXRjaCBpbnRvIG9sZCBtb2RlLgpSZWFkYWJsZS5wcm90b3R5cGUucmVzdW1lID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fcmVhZGFibGVTdGF0ZTsKICBpZiAoIXN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdyZXN1bWUnKTsKICAgIHN0YXRlLmZsb3dpbmcgPSB0cnVlOwogICAgaWYgKCFzdGF0ZS5yZWFkaW5nKSB7CiAgICAgIGRlYnVnKCdyZXN1bWUgcmVhZCAwJyk7CiAgICAgIHRoaXMucmVhZCgwKTsKICAgIH0KICAgIHJlc3VtZSh0aGlzLCBzdGF0ZSk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gcmVzdW1lKHN0cmVhbSwgc3RhdGUpIHsKICBpZiAoIXN0YXRlLnJlc3VtZVNjaGVkdWxlZCkgewogICAgc3RhdGUucmVzdW1lU2NoZWR1bGVkID0gdHJ1ZTsKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIHJlc3VtZV8oc3RyZWFtLCBzdGF0ZSk7CiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIHJlc3VtZV8oc3RyZWFtLCBzdGF0ZSkgewogIHN0YXRlLnJlc3VtZVNjaGVkdWxlZCA9IGZhbHNlOwogIHN0cmVhbS5lbWl0KCdyZXN1bWUnKTsKICBmbG93KHN0cmVhbSk7CiAgaWYgKHN0YXRlLmZsb3dpbmcgJiYgIXN0YXRlLnJlYWRpbmcpCiAgICBzdHJlYW0ucmVhZCgwKTsKfQoKUmVhZGFibGUucHJvdG90eXBlLnBhdXNlID0gZnVuY3Rpb24oKSB7CiAgZGVidWcoJ2NhbGwgcGF1c2UgZmxvd2luZz0laicsIHRoaXMuX3JlYWRhYmxlU3RhdGUuZmxvd2luZyk7CiAgaWYgKGZhbHNlICE9PSB0aGlzLl9yZWFkYWJsZVN0YXRlLmZsb3dpbmcpIHsKICAgIGRlYnVnKCdwYXVzZScpOwogICAgdGhpcy5fcmVhZGFibGVTdGF0ZS5mbG93aW5nID0gZmFsc2U7CiAgICB0aGlzLmVtaXQoJ3BhdXNlJyk7CiAgfQogIHJldHVybiB0aGlzOwp9OwoKZnVuY3Rpb24gZmxvdyhzdHJlYW0pIHsKICB2YXIgc3RhdGUgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgZGVidWcoJ2Zsb3cnLCBzdGF0ZS5mbG93aW5nKTsKICBpZiAoc3RhdGUuZmxvd2luZykgewogICAgZG8gewogICAgICB2YXIgY2h1bmsgPSBzdHJlYW0ucmVhZCgpOwogICAgfSB3aGlsZSAobnVsbCAhPT0gY2h1bmsgJiYgc3RhdGUuZmxvd2luZyk7CiAgfQp9CgovLyB3cmFwIGFuIG9sZC1zdHlsZSBzdHJlYW0gYXMgdGhlIGFzeW5jIGRhdGEgc291cmNlLgovLyBUaGlzIGlzICpub3QqIHBhcnQgb2YgdGhlIHJlYWRhYmxlIHN0cmVhbSBpbnRlcmZhY2UuCi8vIEl0IGlzIGFuIHVnbHkgdW5mb3J0dW5hdGUgbWVzcyBvZiBoaXN0b3J5LgpSZWFkYWJsZS5wcm90b3R5cGUud3JhcCA9IGZ1bmN0aW9uKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgdmFyIHBhdXNlZCA9IGZhbHNlOwoKICB2YXIgc2VsZiA9IHRoaXM7CiAgc3RyZWFtLm9uKCdlbmQnLCBmdW5jdGlvbigpIHsKICAgIGRlYnVnKCd3cmFwcGVkIGVuZCcpOwogICAgaWYgKHN0YXRlLmRlY29kZXIgJiYgIXN0YXRlLmVuZGVkKSB7CiAgICAgIHZhciBjaHVuayA9IHN0YXRlLmRlY29kZXIuZW5kKCk7CiAgICAgIGlmIChjaHVuayAmJiBjaHVuay5sZW5ndGgpCiAgICAgICAgc2VsZi5wdXNoKGNodW5rKTsKICAgIH0KCiAgICBzZWxmLnB1c2gobnVsbCk7CiAgfSk7CgogIHN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uKGNodW5rKSB7CiAgICBkZWJ1Zygnd3JhcHBlZCBkYXRhJyk7CiAgICBpZiAoc3RhdGUuZGVjb2RlcikKICAgICAgY2h1bmsgPSBzdGF0ZS5kZWNvZGVyLndyaXRlKGNodW5rKTsKICAgIGlmICghY2h1bmsgfHwgIXN0YXRlLm9iamVjdE1vZGUgJiYgIWNodW5rLmxlbmd0aCkKICAgICAgcmV0dXJuOwoKICAgIHZhciByZXQgPSBzZWxmLnB1c2goY2h1bmspOwogICAgaWYgKCFyZXQpIHsKICAgICAgcGF1c2VkID0gdHJ1ZTsKICAgICAgc3RyZWFtLnBhdXNlKCk7CiAgICB9CiAgfSk7CgogIC8vIHByb3h5IGFsbCB0aGUgb3RoZXIgbWV0aG9kcy4KICAvLyBpbXBvcnRhbnQgd2hlbiB3cmFwcGluZyBmaWx0ZXJzIGFuZCBkdXBsZXhlcy4KICBmb3IgKHZhciBpIGluIHN0cmVhbSkgewogICAgaWYgKHV0aWwuaXNGdW5jdGlvbihzdHJlYW1baV0pICYmIHV0aWwuaXNVbmRlZmluZWQodGhpc1tpXSkpIHsKICAgICAgdGhpc1tpXSA9IGZ1bmN0aW9uKG1ldGhvZCkgeyByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHN0cmVhbVttZXRob2RdLmFwcGx5KHN0cmVhbSwgYXJndW1lbnRzKTsKICAgICAgfX0oaSk7CiAgICB9CiAgfQoKICAvLyBwcm94eSBjZXJ0YWluIGltcG9ydGFudCBldmVudHMuCiAgdmFyIGV2ZW50cyA9IFsnZXJyb3InLCAnY2xvc2UnLCAnZGVzdHJveScsICdwYXVzZScsICdyZXN1bWUnXTsKICBmb3JFYWNoKGV2ZW50cywgZnVuY3Rpb24oZXYpIHsKICAgIHN0cmVhbS5vbihldiwgc2VsZi5lbWl0LmJpbmQoc2VsZiwgZXYpKTsKICB9KTsKCiAgLy8gd2hlbiB3ZSB0cnkgdG8gY29uc3VtZSBzb21lIG1vcmUgYnl0ZXMsIHNpbXBseSB1bnBhdXNlIHRoZQogIC8vIHVuZGVybHlpbmcgc3RyZWFtLgogIHNlbGYuX3JlYWQgPSBmdW5jdGlvbihuKSB7CiAgICBkZWJ1Zygnd3JhcHBlZCBfcmVhZCcsIG4pOwogICAgaWYgKHBhdXNlZCkgewogICAgICBwYXVzZWQgPSBmYWxzZTsKICAgICAgc3RyZWFtLnJlc3VtZSgpOwogICAgfQogIH07CgogIHJldHVybiBzZWxmOwp9OwoKCgovLyBleHBvc2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzIG9ubHkuClJlYWRhYmxlLl9mcm9tTGlzdCA9IGZyb21MaXN0OwoKLy8gUGx1Y2sgb2ZmIG4gYnl0ZXMgZnJvbSBhbiBhcnJheSBvZiBidWZmZXJzLgovLyBMZW5ndGggaXMgdGhlIGNvbWJpbmVkIGxlbmd0aHMgb2YgYWxsIHRoZSBidWZmZXJzIGluIHRoZSBsaXN0LgpmdW5jdGlvbiBmcm9tTGlzdChuLCBzdGF0ZSkgewogIHZhciBsaXN0ID0gc3RhdGUuYnVmZmVyOwogIHZhciBsZW5ndGggPSBzdGF0ZS5sZW5ndGg7CiAgdmFyIHN0cmluZ01vZGUgPSAhIXN0YXRlLmRlY29kZXI7CiAgdmFyIG9iamVjdE1vZGUgPSAhIXN0YXRlLm9iamVjdE1vZGU7CiAgdmFyIHJldDsKCiAgLy8gbm90aGluZyBpbiB0aGUgbGlzdCwgZGVmaW5pdGVseSBlbXB0eS4KICBpZiAobGlzdC5sZW5ndGggPT09IDApCiAgICByZXR1cm4gbnVsbDsKCiAgaWYgKGxlbmd0aCA9PT0gMCkKICAgIHJldCA9IG51bGw7CiAgZWxzZSBpZiAob2JqZWN0TW9kZSkKICAgIHJldCA9IGxpc3Quc2hpZnQoKTsKICBlbHNlIGlmICghbiB8fCBuID49IGxlbmd0aCkgewogICAgLy8gcmVhZCBpdCBhbGwsIHRydW5jYXRlIHRoZSBhcnJheS4KICAgIGlmIChzdHJpbmdNb2RlKQogICAgICByZXQgPSBsaXN0LmpvaW4oJycpOwogICAgZWxzZQogICAgICByZXQgPSBCdWZmZXIuY29uY2F0KGxpc3QsIGxlbmd0aCk7CiAgICBsaXN0Lmxlbmd0aCA9IDA7CiAgfSBlbHNlIHsKICAgIC8vIHJlYWQganVzdCBzb21lIG9mIGl0LgogICAgaWYgKG4gPCBsaXN0WzBdLmxlbmd0aCkgewogICAgICAvLyBqdXN0IHRha2UgYSBwYXJ0IG9mIHRoZSBmaXJzdCBsaXN0IGl0ZW0uCiAgICAgIC8vIHNsaWNlIGlzIHRoZSBzYW1lIGZvciBidWZmZXJzIGFuZCBzdHJpbmdzLgogICAgICB2YXIgYnVmID0gbGlzdFswXTsKICAgICAgcmV0ID0gYnVmLnNsaWNlKDAsIG4pOwogICAgICBsaXN0WzBdID0gYnVmLnNsaWNlKG4pOwogICAgfSBlbHNlIGlmIChuID09PSBsaXN0WzBdLmxlbmd0aCkgewogICAgICAvLyBmaXJzdCBsaXN0IGlzIGEgcGVyZmVjdCBtYXRjaAogICAgICByZXQgPSBsaXN0LnNoaWZ0KCk7CiAgICB9IGVsc2UgewogICAgICAvLyBjb21wbGV4IGNhc2UuCiAgICAgIC8vIHdlIGhhdmUgZW5vdWdoIHRvIGNvdmVyIGl0LCBidXQgaXQgc3BhbnMgcGFzdCB0aGUgZmlyc3QgYnVmZmVyLgogICAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgICByZXQgPSAnJzsKICAgICAgZWxzZQogICAgICAgIHJldCA9IG5ldyBCdWZmZXIobik7CgogICAgICB2YXIgYyA9IDA7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsICYmIGMgPCBuOyBpKyspIHsKICAgICAgICB2YXIgYnVmID0gbGlzdFswXTsKICAgICAgICB2YXIgY3B5ID0gTWF0aC5taW4obiAtIGMsIGJ1Zi5sZW5ndGgpOwoKICAgICAgICBpZiAoc3RyaW5nTW9kZSkKICAgICAgICAgIHJldCArPSBidWYuc2xpY2UoMCwgY3B5KTsKICAgICAgICBlbHNlCiAgICAgICAgICBidWYuY29weShyZXQsIGMsIDAsIGNweSk7CgogICAgICAgIGlmIChjcHkgPCBidWYubGVuZ3RoKQogICAgICAgICAgbGlzdFswXSA9IGJ1Zi5zbGljZShjcHkpOwogICAgICAgIGVsc2UKICAgICAgICAgIGxpc3Quc2hpZnQoKTsKCiAgICAgICAgYyArPSBjcHk7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiByZXQ7Cn0KCmZ1bmN0aW9uIGVuZFJlYWRhYmxlKHN0cmVhbSkgewogIHZhciBzdGF0ZSA9IHN0cmVhbS5fcmVhZGFibGVTdGF0ZTsKCiAgLy8gSWYgd2UgZ2V0IGhlcmUgYmVmb3JlIGNvbnN1bWluZyBhbGwgdGhlIGJ5dGVzLCB0aGVuIHRoYXQgaXMgYQogIC8vIGJ1ZyBpbiBub2RlLiAgU2hvdWxkIG5ldmVyIGhhcHBlbi4KICBpZiAoc3RhdGUubGVuZ3RoID4gMCkKICAgIHRocm93IG5ldyBFcnJvcignZW5kUmVhZGFibGUgY2FsbGVkIG9uIG5vbi1lbXB0eSBzdHJlYW0nKTsKCiAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkKSB7CiAgICBzdGF0ZS5lbmRlZCA9IHRydWU7CiAgICBwcm9jZXNzLm5leHRUaWNrKGZ1bmN0aW9uKCkgewogICAgICAvLyBDaGVjayB0aGF0IHdlIGRpZG4ndCBnZXQgb25lIGxhc3QgdW5zaGlmdC4KICAgICAgaWYgKCFzdGF0ZS5lbmRFbWl0dGVkICYmIHN0YXRlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHN0YXRlLmVuZEVtaXR0ZWQgPSB0cnVlOwogICAgICAgIHN0cmVhbS5yZWFkYWJsZSA9IGZhbHNlOwogICAgICAgIHN0cmVhbS5lbWl0KCdlbmQnKTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBmb3JFYWNoICh4cywgZikgewogIGZvciAodmFyIGkgPSAwLCBsID0geHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBmKHhzW2ldLCBpKTsKICB9Cn0KCmZ1bmN0aW9uIGluZGV4T2YgKHhzLCB4KSB7CiAgZm9yICh2YXIgaSA9IDAsIGwgPSB4cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIGlmICh4c1tpXSA9PT0geCkgcmV0dXJuIGk7CiAgfQogIHJldHVybiAtMTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL19zdHJlYW1fZHVwbGV4IjoxMjEsIl9wcm9jZXNzIjo2MCwiYnVmZmVyIjo1MywiY29yZS11dGlsLWlzIjoxMjYsImV2ZW50cyI6NTcsImluaGVyaXRzIjo3NiwiaXNhcnJheSI6MTI3LCJzdHJlYW0iOjcyLCJzdHJpbmdfZGVjb2Rlci8iOjEyOCwidXRpbCI6NTJ9XSwxMjQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBDb3B5cmlnaHQgSm95ZW50LCBJbmMuIGFuZCBvdGhlciBOb2RlIGNvbnRyaWJ1dG9ycy4KLy8KLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEKLy8gY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZQovLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCi8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKLy8gZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdAovLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6Ci8vCi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCi8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgovLwovLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwovLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCi8vIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4KLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCi8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUgovLyBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFCi8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgoKLy8gYSB0cmFuc2Zvcm0gc3RyZWFtIGlzIGEgcmVhZGFibGUvd3JpdGFibGUgc3RyZWFtIHdoZXJlIHlvdSBkbwovLyBzb21ldGhpbmcgd2l0aCB0aGUgZGF0YS4gIFNvbWV0aW1lcyBpdCdzIGNhbGxlZCBhICJmaWx0ZXIiLAovLyBidXQgdGhhdCdzIG5vdCBhIGdyZWF0IG5hbWUgZm9yIGl0LCBzaW5jZSB0aGF0IGltcGxpZXMgYSB0aGluZyB3aGVyZQovLyBzb21lIGJpdHMgcGFzcyB0aHJvdWdoLCBhbmQgb3RoZXJzIGFyZSBzaW1wbHkgaWdub3JlZC4gIChUaGF0IHdvdWxkCi8vIGJlIGEgdmFsaWQgZXhhbXBsZSBvZiBhIHRyYW5zZm9ybSwgb2YgY291cnNlLikKLy8KLy8gV2hpbGUgdGhlIG91dHB1dCBpcyBjYXVzYWxseSByZWxhdGVkIHRvIHRoZSBpbnB1dCwgaXQncyBub3QgYQovLyBuZWNlc3NhcmlseSBzeW1tZXRyaWMgb3Igc3luY2hyb25vdXMgdHJhbnNmb3JtYXRpb24uICBGb3IgZXhhbXBsZSwKLy8gYSB6bGliIHN0cmVhbSBtaWdodCB0YWtlIG11bHRpcGxlIHBsYWluLXRleHQgd3JpdGVzKCksIGFuZCB0aGVuCi8vIGVtaXQgYSBzaW5nbGUgY29tcHJlc3NlZCBjaHVuayBzb21lIHRpbWUgaW4gdGhlIGZ1dHVyZS4KLy8KLy8gSGVyZSdzIGhvdyB0aGlzIHdvcmtzOgovLwovLyBUaGUgVHJhbnNmb3JtIHN0cmVhbSBoYXMgYWxsIHRoZSBhc3BlY3RzIG9mIHRoZSByZWFkYWJsZSBhbmQgd3JpdGFibGUKLy8gc3RyZWFtIGNsYXNzZXMuICBXaGVuIHlvdSB3cml0ZShjaHVuayksIHRoYXQgY2FsbHMgX3dyaXRlKGNodW5rLGNiKQovLyBpbnRlcm5hbGx5LCBhbmQgcmV0dXJucyBmYWxzZSBpZiB0aGVyZSdzIGEgbG90IG9mIHBlbmRpbmcgd3JpdGVzCi8vIGJ1ZmZlcmVkIHVwLiAgV2hlbiB5b3UgY2FsbCByZWFkKCksIHRoYXQgY2FsbHMgX3JlYWQobikgdW50aWwKLy8gdGhlcmUncyBlbm91Z2ggcGVuZGluZyByZWFkYWJsZSBkYXRhIGJ1ZmZlcmVkIHVwLgovLwovLyBJbiBhIHRyYW5zZm9ybSBzdHJlYW0sIHRoZSB3cml0dGVuIGRhdGEgaXMgcGxhY2VkIGluIGEgYnVmZmVyLiAgV2hlbgovLyBfcmVhZChuKSBpcyBjYWxsZWQsIGl0IHRyYW5zZm9ybXMgdGhlIHF1ZXVlZCB1cCBkYXRhLCBjYWxsaW5nIHRoZQovLyBidWZmZXJlZCBfd3JpdGUgY2IncyBhcyBpdCBjb25zdW1lcyBjaHVua3MuICBJZiBjb25zdW1pbmcgYSBzaW5nbGUKLy8gd3JpdHRlbiBjaHVuayB3b3VsZCByZXN1bHQgaW4gbXVsdGlwbGUgb3V0cHV0IGNodW5rcywgdGhlbiB0aGUgZmlyc3QKLy8gb3V0cHV0dGVkIGJpdCBjYWxscyB0aGUgcmVhZGNiLCBhbmQgc3Vic2VxdWVudCBjaHVua3MganVzdCBnbyBpbnRvCi8vIHRoZSByZWFkIGJ1ZmZlciwgYW5kIHdpbGwgY2F1c2UgaXQgdG8gZW1pdCAncmVhZGFibGUnIGlmIG5lY2Vzc2FyeS4KLy8KLy8gVGhpcyB3YXksIGJhY2stcHJlc3N1cmUgaXMgYWN0dWFsbHkgZGV0ZXJtaW5lZCBieSB0aGUgcmVhZGluZyBzaWRlLAovLyBzaW5jZSBfcmVhZCBoYXMgdG8gYmUgY2FsbGVkIHRvIHN0YXJ0IHByb2Nlc3NpbmcgYSBuZXcgY2h1bmsuICBIb3dldmVyLAovLyBhIHBhdGhvbG9naWNhbCBpbmZsYXRlIHR5cGUgb2YgdHJhbnNmb3JtIGNhbiBjYXVzZSBleGNlc3NpdmUgYnVmZmVyaW5nCi8vIGhlcmUuICBGb3IgZXhhbXBsZSwgaW1hZ2luZSBhIHN0cmVhbSB3aGVyZSBldmVyeSBieXRlIG9mIGlucHV0IGlzCi8vIGludGVycHJldGVkIGFzIGFuIGludGVnZXIgZnJvbSAwLTI1NSwgYW5kIHRoZW4gcmVzdWx0cyBpbiB0aGF0IG1hbnkKLy8gYnl0ZXMgb2Ygb3V0cHV0LiAgV3JpdGluZyB0aGUgNCBieXRlcyB7ZmYsZmYsZmYsZmZ9IHdvdWxkIHJlc3VsdCBpbgovLyAxa2Igb2YgZGF0YSBiZWluZyBvdXRwdXQuICBJbiB0aGlzIGNhc2UsIHlvdSBjb3VsZCB3cml0ZSBhIHZlcnkgc21hbGwKLy8gYW1vdW50IG9mIGlucHV0LCBhbmQgZW5kIHVwIHdpdGggYSB2ZXJ5IGxhcmdlIGFtb3VudCBvZiBvdXRwdXQuICBJbgovLyBzdWNoIGEgcGF0aG9sb2dpY2FsIGluZmxhdGluZyBtZWNoYW5pc20sIHRoZXJlJ2QgYmUgbm8gd2F5IHRvIHRlbGwKLy8gdGhlIHN5c3RlbSB0byBzdG9wIGRvaW5nIHRoZSB0cmFuc2Zvcm0uICBBIHNpbmdsZSA0TUIgd3JpdGUgY291bGQKLy8gY2F1c2UgdGhlIHN5c3RlbSB0byBydW4gb3V0IG9mIG1lbW9yeS4KLy8KLy8gSG93ZXZlciwgZXZlbiBpbiBzdWNoIGEgcGF0aG9sb2dpY2FsIGNhc2UsIG9ubHkgYSBzaW5nbGUgd3JpdHRlbiBjaHVuawovLyB3b3VsZCBiZSBjb25zdW1lZCwgYW5kIHRoZW4gdGhlIHJlc3Qgd291bGQgd2FpdCAodW4tdHJhbnNmb3JtZWQpIHVudGlsCi8vIHRoZSByZXN1bHRzIG9mIHRoZSBwcmV2aW91cyB0cmFuc2Zvcm1lZCBjaHVuayB3ZXJlIGNvbnN1bWVkLgoKbW9kdWxlLmV4cG9ydHMgPSBUcmFuc2Zvcm07Cgp2YXIgRHVwbGV4ID0gcmVxdWlyZSgnLi9fc3RyZWFtX2R1cGxleCcpOwoKLyo8cmVwbGFjZW1lbnQ+Ki8KdmFyIHV0aWwgPSByZXF1aXJlKCdjb3JlLXV0aWwtaXMnKTsKdXRpbC5pbmhlcml0cyA9IHJlcXVpcmUoJ2luaGVyaXRzJyk7Ci8qPC9yZXBsYWNlbWVudD4qLwoKdXRpbC5pbmhlcml0cyhUcmFuc2Zvcm0sIER1cGxleCk7CgoKZnVuY3Rpb24gVHJhbnNmb3JtU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdGhpcy5hZnRlclRyYW5zZm9ybSA9IGZ1bmN0aW9uKGVyLCBkYXRhKSB7CiAgICByZXR1cm4gYWZ0ZXJUcmFuc2Zvcm0oc3RyZWFtLCBlciwgZGF0YSk7CiAgfTsKCiAgdGhpcy5uZWVkVHJhbnNmb3JtID0gZmFsc2U7CiAgdGhpcy50cmFuc2Zvcm1pbmcgPSBmYWxzZTsKICB0aGlzLndyaXRlY2IgPSBudWxsOwogIHRoaXMud3JpdGVjaHVuayA9IG51bGw7Cn0KCmZ1bmN0aW9uIGFmdGVyVHJhbnNmb3JtKHN0cmVhbSwgZXIsIGRhdGEpIHsKICB2YXIgdHMgPSBzdHJlYW0uX3RyYW5zZm9ybVN0YXRlOwogIHRzLnRyYW5zZm9ybWluZyA9IGZhbHNlOwoKICB2YXIgY2IgPSB0cy53cml0ZWNiOwoKICBpZiAoIWNiKQogICAgcmV0dXJuIHN0cmVhbS5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignbm8gd3JpdGVjYiBpbiBUcmFuc2Zvcm0gY2xhc3MnKSk7CgogIHRzLndyaXRlY2h1bmsgPSBudWxsOwogIHRzLndyaXRlY2IgPSBudWxsOwoKICBpZiAoIXV0aWwuaXNOdWxsT3JVbmRlZmluZWQoZGF0YSkpCiAgICBzdHJlYW0ucHVzaChkYXRhKTsKCiAgaWYgKGNiKQogICAgY2IoZXIpOwoKICB2YXIgcnMgPSBzdHJlYW0uX3JlYWRhYmxlU3RhdGU7CiAgcnMucmVhZGluZyA9IGZhbHNlOwogIGlmIChycy5uZWVkUmVhZGFibGUgfHwgcnMubGVuZ3RoIDwgcnMuaGlnaFdhdGVyTWFyaykgewogICAgc3RyZWFtLl9yZWFkKHJzLmhpZ2hXYXRlck1hcmspOwogIH0KfQoKCmZ1bmN0aW9uIFRyYW5zZm9ybShvcHRpb25zKSB7CiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFRyYW5zZm9ybSkpCiAgICByZXR1cm4gbmV3IFRyYW5zZm9ybShvcHRpb25zKTsKCiAgRHVwbGV4LmNhbGwodGhpcywgb3B0aW9ucyk7CgogIHRoaXMuX3RyYW5zZm9ybVN0YXRlID0gbmV3IFRyYW5zZm9ybVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyB3aGVuIHRoZSB3cml0YWJsZSBzaWRlIGZpbmlzaGVzLCB0aGVuIGZsdXNoIG91dCBhbnl0aGluZyByZW1haW5pbmcuCiAgdmFyIHN0cmVhbSA9IHRoaXM7CgogIC8vIHN0YXJ0IG91dCBhc2tpbmcgZm9yIGEgcmVhZGFibGUgZXZlbnQgb25jZSBkYXRhIGlzIHRyYW5zZm9ybWVkLgogIHRoaXMuX3JlYWRhYmxlU3RhdGUubmVlZFJlYWRhYmxlID0gdHJ1ZTsKCiAgLy8gd2UgaGF2ZSBpbXBsZW1lbnRlZCB0aGUgX3JlYWQgbWV0aG9kLCBhbmQgZG9uZSB0aGUgb3RoZXIgdGhpbmdzCiAgLy8gdGhhdCBSZWFkYWJsZSB3YW50cyBiZWZvcmUgdGhlIGZpcnN0IF9yZWFkIGNhbGwsIHNvIHVuc2V0IHRoZQogIC8vIHN5bmMgZ3VhcmQgZmxhZy4KICB0aGlzLl9yZWFkYWJsZVN0YXRlLnN5bmMgPSBmYWxzZTsKCiAgdGhpcy5vbmNlKCdwcmVmaW5pc2gnLCBmdW5jdGlvbigpIHsKICAgIGlmICh1dGlsLmlzRnVuY3Rpb24odGhpcy5fZmx1c2gpKQogICAgICB0aGlzLl9mbHVzaChmdW5jdGlvbihlcikgewogICAgICAgIGRvbmUoc3RyZWFtLCBlcik7CiAgICAgIH0pOwogICAgZWxzZQogICAgICBkb25lKHN0cmVhbSk7CiAgfSk7Cn0KClRyYW5zZm9ybS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZykgewogIHRoaXMuX3RyYW5zZm9ybVN0YXRlLm5lZWRUcmFuc2Zvcm0gPSBmYWxzZTsKICByZXR1cm4gRHVwbGV4LnByb3RvdHlwZS5wdXNoLmNhbGwodGhpcywgY2h1bmssIGVuY29kaW5nKTsKfTsKCi8vIFRoaXMgaXMgdGhlIHBhcnQgd2hlcmUgeW91IGRvIHN0dWZmIQovLyBvdmVycmlkZSB0aGlzIGZ1bmN0aW9uIGluIGltcGxlbWVudGF0aW9uIGNsYXNzZXMuCi8vICdjaHVuaycgaXMgYW4gaW5wdXQgY2h1bmsuCi8vCi8vIENhbGwgYHB1c2gobmV3Q2h1bmspYCB0byBwYXNzIGFsb25nIHRyYW5zZm9ybWVkIG91dHB1dAovLyB0byB0aGUgcmVhZGFibGUgc2lkZS4gIFlvdSBtYXkgY2FsbCAncHVzaCcgemVybyBvciBtb3JlIHRpbWVzLgovLwovLyBDYWxsIGBjYihlcnIpYCB3aGVuIHlvdSBhcmUgZG9uZSB3aXRoIHRoaXMgY2h1bmsuICBJZiB5b3UgcGFzcwovLyBhbiBlcnJvciwgdGhlbiB0aGF0J2xsIHB1dCB0aGUgaHVydCBvbiB0aGUgd2hvbGUgb3BlcmF0aW9uLiAgSWYgeW91Ci8vIG5ldmVyIGNhbGwgY2IoKSwgdGhlbiB5b3UnbGwgbmV2ZXIgZ2V0IGFub3RoZXIgY2h1bmsuClRyYW5zZm9ybS5wcm90b3R5cGUuX3RyYW5zZm9ybSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBpbXBsZW1lbnRlZCcpOwp9OwoKVHJhbnNmb3JtLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdmFyIHRzID0gdGhpcy5fdHJhbnNmb3JtU3RhdGU7CiAgdHMud3JpdGVjYiA9IGNiOwogIHRzLndyaXRlY2h1bmsgPSBjaHVuazsKICB0cy53cml0ZWVuY29kaW5nID0gZW5jb2Rpbmc7CiAgaWYgKCF0cy50cmFuc2Zvcm1pbmcpIHsKICAgIHZhciBycyA9IHRoaXMuX3JlYWRhYmxlU3RhdGU7CiAgICBpZiAodHMubmVlZFRyYW5zZm9ybSB8fAogICAgICAgIHJzLm5lZWRSZWFkYWJsZSB8fAogICAgICAgIHJzLmxlbmd0aCA8IHJzLmhpZ2hXYXRlck1hcmspCiAgICAgIHRoaXMuX3JlYWQocnMuaGlnaFdhdGVyTWFyayk7CiAgfQp9OwoKLy8gRG9lc24ndCBtYXR0ZXIgd2hhdCB0aGUgYXJncyBhcmUgaGVyZS4KLy8gX3RyYW5zZm9ybSBkb2VzIGFsbCB0aGUgd29yay4KLy8gVGhhdCB3ZSBnb3QgaGVyZSBtZWFucyB0aGF0IHRoZSByZWFkYWJsZSBzaWRlIHdhbnRzIG1vcmUgZGF0YS4KVHJhbnNmb3JtLnByb3RvdHlwZS5fcmVhZCA9IGZ1bmN0aW9uKG4pIHsKICB2YXIgdHMgPSB0aGlzLl90cmFuc2Zvcm1TdGF0ZTsKCiAgaWYgKCF1dGlsLmlzTnVsbCh0cy53cml0ZWNodW5rKSAmJiB0cy53cml0ZWNiICYmICF0cy50cmFuc2Zvcm1pbmcpIHsKICAgIHRzLnRyYW5zZm9ybWluZyA9IHRydWU7CiAgICB0aGlzLl90cmFuc2Zvcm0odHMud3JpdGVjaHVuaywgdHMud3JpdGVlbmNvZGluZywgdHMuYWZ0ZXJUcmFuc2Zvcm0pOwogIH0gZWxzZSB7CiAgICAvLyBtYXJrIHRoYXQgd2UgbmVlZCBhIHRyYW5zZm9ybSwgc28gdGhhdCBhbnkgZGF0YSB0aGF0IGNvbWVzIGluCiAgICAvLyB3aWxsIGdldCBwcm9jZXNzZWQsIG5vdyB0aGF0IHdlJ3ZlIGFza2VkIGZvciBpdC4KICAgIHRzLm5lZWRUcmFuc2Zvcm0gPSB0cnVlOwogIH0KfTsKCgpmdW5jdGlvbiBkb25lKHN0cmVhbSwgZXIpIHsKICBpZiAoZXIpCiAgICByZXR1cm4gc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwoKICAvLyBpZiB0aGVyZSdzIG5vdGhpbmcgaW4gdGhlIHdyaXRlIGJ1ZmZlciwgdGhlbiB0aGF0IG1lYW5zCiAgLy8gdGhhdCBub3RoaW5nIG1vcmUgd2lsbCBldmVyIGJlIHByb3ZpZGVkCiAgdmFyIHdzID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciB0cyA9IHN0cmVhbS5fdHJhbnNmb3JtU3RhdGU7CgogIGlmICh3cy5sZW5ndGgpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ2NhbGxpbmcgdHJhbnNmb3JtIGRvbmUgd2hlbiB3cy5sZW5ndGggIT0gMCcpOwoKICBpZiAodHMudHJhbnNmb3JtaW5nKQogICAgdGhyb3cgbmV3IEVycm9yKCdjYWxsaW5nIHRyYW5zZm9ybSBkb25lIHdoZW4gc3RpbGwgdHJhbnNmb3JtaW5nJyk7CgogIHJldHVybiBzdHJlYW0ucHVzaChudWxsKTsKfQoKfSx7Ii4vX3N0cmVhbV9kdXBsZXgiOjEyMSwiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Nn1dLDEyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAocHJvY2Vzcyl7Ci8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYQovLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCi8vICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcKLy8gd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAovLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0Ci8vIHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZQovLyBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQKLy8gaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTCi8vIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgovLyBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwKLy8gREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SCi8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKLy8gVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS4KCi8vIEEgYml0IHNpbXBsZXIgdGhhbiByZWFkYWJsZSBzdHJlYW1zLgovLyBJbXBsZW1lbnQgYW4gYXN5bmMgLl93cml0ZShjaHVuaywgY2IpLCBhbmQgaXQnbGwgaGFuZGxlIGFsbAovLyB0aGUgZHJhaW4gZXZlbnQgZW1pc3Npb24gYW5kIGJ1ZmZlcmluZy4KCm1vZHVsZS5leHBvcnRzID0gV3JpdGFibGU7CgovKjxyZXBsYWNlbWVudD4qLwp2YXIgQnVmZmVyID0gcmVxdWlyZSgnYnVmZmVyJykuQnVmZmVyOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCldyaXRhYmxlLldyaXRhYmxlU3RhdGUgPSBXcml0YWJsZVN0YXRlOwoKCi8qPHJlcGxhY2VtZW50PiovCnZhciB1dGlsID0gcmVxdWlyZSgnY29yZS11dGlsLWlzJyk7CnV0aWwuaW5oZXJpdHMgPSByZXF1aXJlKCdpbmhlcml0cycpOwovKjwvcmVwbGFjZW1lbnQ+Ki8KCnZhciBTdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTsKCnV0aWwuaW5oZXJpdHMoV3JpdGFibGUsIFN0cmVhbSk7CgpmdW5jdGlvbiBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgdGhpcy5jaHVuayA9IGNodW5rOwogIHRoaXMuZW5jb2RpbmcgPSBlbmNvZGluZzsKICB0aGlzLmNhbGxiYWNrID0gY2I7Cn0KCmZ1bmN0aW9uIFdyaXRhYmxlU3RhdGUob3B0aW9ucywgc3RyZWFtKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogIC8vIHRoZSBwb2ludCBhdCB3aGljaCB3cml0ZSgpIHN0YXJ0cyByZXR1cm5pbmcgZmFsc2UKICAvLyBOb3RlOiAwIGlzIGEgdmFsaWQgdmFsdWUsIG1lYW5zIHRoYXQgd2UgYWx3YXlzIHJldHVybiBmYWxzZSBpZgogIC8vIHRoZSBlbnRpcmUgYnVmZmVyIGlzIG5vdCBmbHVzaGVkIGltbWVkaWF0ZWx5IG9uIHdyaXRlKCkKICB2YXIgaHdtID0gb3B0aW9ucy5oaWdoV2F0ZXJNYXJrOwogIHZhciBkZWZhdWx0SHdtID0gb3B0aW9ucy5vYmplY3RNb2RlID8gMTYgOiAxNiAqIDEwMjQ7CiAgdGhpcy5oaWdoV2F0ZXJNYXJrID0gKGh3bSB8fCBod20gPT09IDApID8gaHdtIDogZGVmYXVsdEh3bTsKCiAgLy8gb2JqZWN0IHN0cmVhbSBmbGFnIHRvIGluZGljYXRlIHdoZXRoZXIgb3Igbm90IHRoaXMgc3RyZWFtCiAgLy8gY29udGFpbnMgYnVmZmVycyBvciBvYmplY3RzLgogIHRoaXMub2JqZWN0TW9kZSA9ICEhb3B0aW9ucy5vYmplY3RNb2RlOwoKICBpZiAoc3RyZWFtIGluc3RhbmNlb2YgRHVwbGV4KQogICAgdGhpcy5vYmplY3RNb2RlID0gdGhpcy5vYmplY3RNb2RlIHx8ICEhb3B0aW9ucy53cml0YWJsZU9iamVjdE1vZGU7CgogIC8vIGNhc3QgdG8gaW50cy4KICB0aGlzLmhpZ2hXYXRlck1hcmsgPSB+fnRoaXMuaGlnaFdhdGVyTWFyazsKCiAgdGhpcy5uZWVkRHJhaW4gPSBmYWxzZTsKICAvLyBhdCB0aGUgc3RhcnQgb2YgY2FsbGluZyBlbmQoKQogIHRoaXMuZW5kaW5nID0gZmFsc2U7CiAgLy8gd2hlbiBlbmQoKSBoYXMgYmVlbiBjYWxsZWQsIGFuZCByZXR1cm5lZAogIHRoaXMuZW5kZWQgPSBmYWxzZTsKICAvLyB3aGVuICdmaW5pc2gnIGlzIGVtaXR0ZWQKICB0aGlzLmZpbmlzaGVkID0gZmFsc2U7CgogIC8vIHNob3VsZCB3ZSBkZWNvZGUgc3RyaW5ncyBpbnRvIGJ1ZmZlcnMgYmVmb3JlIHBhc3NpbmcgdG8gX3dyaXRlPwogIC8vIHRoaXMgaXMgaGVyZSBzbyB0aGF0IHNvbWUgbm9kZS1jb3JlIHN0cmVhbXMgY2FuIG9wdGltaXplIHN0cmluZwogIC8vIGhhbmRsaW5nIGF0IGEgbG93ZXIgbGV2ZWwuCiAgdmFyIG5vRGVjb2RlID0gb3B0aW9ucy5kZWNvZGVTdHJpbmdzID09PSBmYWxzZTsKICB0aGlzLmRlY29kZVN0cmluZ3MgPSAhbm9EZWNvZGU7CgogIC8vIENyeXB0byBpcyBraW5kIG9mIG9sZCBhbmQgY3J1c3R5LiAgSGlzdG9yaWNhbGx5LCBpdHMgZGVmYXVsdCBzdHJpbmcKICAvLyBlbmNvZGluZyBpcyAnYmluYXJ5JyBzbyB3ZSBoYXZlIHRvIG1ha2UgdGhpcyBjb25maWd1cmFibGUuCiAgLy8gRXZlcnl0aGluZyBlbHNlIGluIHRoZSB1bml2ZXJzZSB1c2VzICd1dGY4JywgdGhvdWdoLgogIHRoaXMuZGVmYXVsdEVuY29kaW5nID0gb3B0aW9ucy5kZWZhdWx0RW5jb2RpbmcgfHwgJ3V0ZjgnOwoKICAvLyBub3QgYW4gYWN0dWFsIGJ1ZmZlciB3ZSBrZWVwIHRyYWNrIG9mLCBidXQgYSBtZWFzdXJlbWVudAogIC8vIG9mIGhvdyBtdWNoIHdlJ3JlIHdhaXRpbmcgdG8gZ2V0IHB1c2hlZCB0byBzb21lIHVuZGVybHlpbmcKICAvLyBzb2NrZXQgb3IgZmlsZS4KICB0aGlzLmxlbmd0aCA9IDA7CgogIC8vIGEgZmxhZyB0byBzZWUgd2hlbiB3ZSdyZSBpbiB0aGUgbWlkZGxlIG9mIGEgd3JpdGUuCiAgdGhpcy53cml0aW5nID0gZmFsc2U7CgogIC8vIHdoZW4gdHJ1ZSBhbGwgd3JpdGVzIHdpbGwgYmUgYnVmZmVyZWQgdW50aWwgLnVuY29yaygpIGNhbGwKICB0aGlzLmNvcmtlZCA9IDA7CgogIC8vIGEgZmxhZyB0byBiZSBhYmxlIHRvIHRlbGwgaWYgdGhlIG9ud3JpdGUgY2IgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LAogIC8vIG9yIG9uIGEgbGF0ZXIgdGljay4gIFdlIHNldCB0aGlzIHRvIHRydWUgYXQgZmlyc3QsIGJlY2F1c2UgYW55CiAgLy8gYWN0aW9ucyB0aGF0IHNob3VsZG4ndCBoYXBwZW4gdW50aWwgImxhdGVyIiBzaG91bGQgZ2VuZXJhbGx5IGFsc28KICAvLyBub3QgaGFwcGVuIGJlZm9yZSB0aGUgZmlyc3Qgd3JpdGUgY2FsbC4KICB0aGlzLnN5bmMgPSB0cnVlOwoKICAvLyBhIGZsYWcgdG8ga25vdyBpZiB3ZSdyZSBwcm9jZXNzaW5nIHByZXZpb3VzbHkgYnVmZmVyZWQgaXRlbXMsIHdoaWNoCiAgLy8gbWF5IGNhbGwgdGhlIF93cml0ZSgpIGNhbGxiYWNrIGluIHRoZSBzYW1lIHRpY2ssIHNvIHRoYXQgd2UgZG9uJ3QKICAvLyBlbmQgdXAgaW4gYW4gb3ZlcmxhcHBlZCBvbndyaXRlIHNpdHVhdGlvbi4KICB0aGlzLmJ1ZmZlclByb2Nlc3NpbmcgPSBmYWxzZTsKCiAgLy8gdGhlIGNhbGxiYWNrIHRoYXQncyBwYXNzZWQgdG8gX3dyaXRlKGNodW5rLGNiKQogIHRoaXMub253cml0ZSA9IGZ1bmN0aW9uKGVyKSB7CiAgICBvbndyaXRlKHN0cmVhbSwgZXIpOwogIH07CgogIC8vIHRoZSBjYWxsYmFjayB0aGF0IHRoZSB1c2VyIHN1cHBsaWVzIHRvIHdyaXRlKGNodW5rLGVuY29kaW5nLGNiKQogIHRoaXMud3JpdGVjYiA9IG51bGw7CgogIC8vIHRoZSBhbW91bnQgdGhhdCBpcyBiZWluZyB3cml0dGVuIHdoZW4gX3dyaXRlIGlzIGNhbGxlZC4KICB0aGlzLndyaXRlbGVuID0gMDsKCiAgdGhpcy5idWZmZXIgPSBbXTsKCiAgLy8gbnVtYmVyIG9mIHBlbmRpbmcgdXNlci1zdXBwbGllZCB3cml0ZSBjYWxsYmFja3MKICAvLyB0aGlzIG11c3QgYmUgMCBiZWZvcmUgJ2ZpbmlzaCcgY2FuIGJlIGVtaXR0ZWQKICB0aGlzLnBlbmRpbmdjYiA9IDA7CgogIC8vIGVtaXQgcHJlZmluaXNoIGlmIHRoZSBvbmx5IHRoaW5nIHdlJ3JlIHdhaXRpbmcgZm9yIGlzIF93cml0ZSBjYnMKICAvLyBUaGlzIGlzIHJlbGV2YW50IGZvciBzeW5jaHJvbm91cyBUcmFuc2Zvcm0gc3RyZWFtcwogIHRoaXMucHJlZmluaXNoZWQgPSBmYWxzZTsKCiAgLy8gVHJ1ZSBpZiB0aGUgZXJyb3Igd2FzIGFscmVhZHkgZW1pdHRlZCBhbmQgc2hvdWxkIG5vdCBiZSB0aHJvd24gYWdhaW4KICB0aGlzLmVycm9yRW1pdHRlZCA9IGZhbHNlOwp9CgpmdW5jdGlvbiBXcml0YWJsZShvcHRpb25zKSB7CiAgdmFyIER1cGxleCA9IHJlcXVpcmUoJy4vX3N0cmVhbV9kdXBsZXgnKTsKCiAgLy8gV3JpdGFibGUgY3RvciBpcyBhcHBsaWVkIHRvIER1cGxleGVzLCB0aG91Z2ggdGhleSdyZSBub3QKICAvLyBpbnN0YW5jZW9mIFdyaXRhYmxlLCB0aGV5J3JlIGluc3RhbmNlb2YgUmVhZGFibGUuCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFdyaXRhYmxlKSAmJiAhKHRoaXMgaW5zdGFuY2VvZiBEdXBsZXgpKQogICAgcmV0dXJuIG5ldyBXcml0YWJsZShvcHRpb25zKTsKCiAgdGhpcy5fd3JpdGFibGVTdGF0ZSA9IG5ldyBXcml0YWJsZVN0YXRlKG9wdGlvbnMsIHRoaXMpOwoKICAvLyBsZWdhY3kuCiAgdGhpcy53cml0YWJsZSA9IHRydWU7CgogIFN0cmVhbS5jYWxsKHRoaXMpOwp9CgovLyBPdGhlcndpc2UgcGVvcGxlIGNhbiBwaXBlIFdyaXRhYmxlIHN0cmVhbXMsIHdoaWNoIGlzIGp1c3Qgd3JvbmcuCldyaXRhYmxlLnByb3RvdHlwZS5waXBlID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5lbWl0KCdlcnJvcicsIG5ldyBFcnJvcignQ2Fubm90IHBpcGUuIE5vdCByZWFkYWJsZS4nKSk7Cn07CgoKZnVuY3Rpb24gd3JpdGVBZnRlckVuZChzdHJlYW0sIHN0YXRlLCBjYikgewogIHZhciBlciA9IG5ldyBFcnJvcignd3JpdGUgYWZ0ZXIgZW5kJyk7CiAgLy8gVE9ETzogZGVmZXIgZXJyb3IgZXZlbnRzIGNvbnNpc3RlbnRseSBldmVyeXdoZXJlLCBub3QganVzdCB0aGUgY2IKICBzdHJlYW0uZW1pdCgnZXJyb3InLCBlcik7CiAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgIGNiKGVyKTsKICB9KTsKfQoKLy8gSWYgd2UgZ2V0IHNvbWV0aGluZyB0aGF0IGlzIG5vdCBhIGJ1ZmZlciwgc3RyaW5nLCBudWxsLCBvciB1bmRlZmluZWQsCi8vIGFuZCB3ZSdyZSBub3QgaW4gb2JqZWN0TW9kZSwgdGhlbiB0aGF0J3MgYW4gZXJyb3IuCi8vIE90aGVyd2lzZSBzdHJlYW0gY2h1bmtzIGFyZSBhbGwgY29uc2lkZXJlZCB0byBiZSBvZiBsZW5ndGg9MSwgYW5kIHRoZQovLyB3YXRlcm1hcmtzIGRldGVybWluZSBob3cgbWFueSBvYmplY3RzIHRvIGtlZXAgaW4gdGhlIGJ1ZmZlciwgcmF0aGVyIHRoYW4KLy8gaG93IG1hbnkgYnl0ZXMgb3IgY2hhcmFjdGVycy4KZnVuY3Rpb24gdmFsaWRDaHVuayhzdHJlYW0sIHN0YXRlLCBjaHVuaywgY2IpIHsKICB2YXIgdmFsaWQgPSB0cnVlOwogIGlmICghdXRpbC5pc0J1ZmZlcihjaHVuaykgJiYKICAgICAgIXV0aWwuaXNTdHJpbmcoY2h1bmspICYmCiAgICAgICF1dGlsLmlzTnVsbE9yVW5kZWZpbmVkKGNodW5rKSAmJgogICAgICAhc3RhdGUub2JqZWN0TW9kZSkgewogICAgdmFyIGVyID0gbmV3IFR5cGVFcnJvcignSW52YWxpZCBub24tc3RyaW5nL2J1ZmZlciBjaHVuaycpOwogICAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwogICAgcHJvY2Vzcy5uZXh0VGljayhmdW5jdGlvbigpIHsKICAgICAgY2IoZXIpOwogICAgfSk7CiAgICB2YWxpZCA9IGZhbHNlOwogIH0KICByZXR1cm4gdmFsaWQ7Cn0KCldyaXRhYmxlLnByb3RvdHlwZS53cml0ZSA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwogIHZhciByZXQgPSBmYWxzZTsKCiAgaWYgKHV0aWwuaXNGdW5jdGlvbihlbmNvZGluZykpIHsKICAgIGNiID0gZW5jb2Rpbmc7CiAgICBlbmNvZGluZyA9IG51bGw7CiAgfQoKICBpZiAodXRpbC5pc0J1ZmZlcihjaHVuaykpCiAgICBlbmNvZGluZyA9ICdidWZmZXInOwogIGVsc2UgaWYgKCFlbmNvZGluZykKICAgIGVuY29kaW5nID0gc3RhdGUuZGVmYXVsdEVuY29kaW5nOwoKICBpZiAoIXV0aWwuaXNGdW5jdGlvbihjYikpCiAgICBjYiA9IGZ1bmN0aW9uKCkge307CgogIGlmIChzdGF0ZS5lbmRlZCkKICAgIHdyaXRlQWZ0ZXJFbmQodGhpcywgc3RhdGUsIGNiKTsKICBlbHNlIGlmICh2YWxpZENodW5rKHRoaXMsIHN0YXRlLCBjaHVuaywgY2IpKSB7CiAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgIHJldCA9IHdyaXRlT3JCdWZmZXIodGhpcywgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpOwogIH0KCiAgcmV0dXJuIHJldDsKfTsKCldyaXRhYmxlLnByb3RvdHlwZS5jb3JrID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgc3RhdGUuY29ya2VkKys7Cn07CgpXcml0YWJsZS5wcm90b3R5cGUudW5jb3JrID0gZnVuY3Rpb24oKSB7CiAgdmFyIHN0YXRlID0gdGhpcy5fd3JpdGFibGVTdGF0ZTsKCiAgaWYgKHN0YXRlLmNvcmtlZCkgewogICAgc3RhdGUuY29ya2VkLS07CgogICAgaWYgKCFzdGF0ZS53cml0aW5nICYmCiAgICAgICAgIXN0YXRlLmNvcmtlZCAmJgogICAgICAgICFzdGF0ZS5maW5pc2hlZCAmJgogICAgICAgICFzdGF0ZS5idWZmZXJQcm9jZXNzaW5nICYmCiAgICAgICAgc3RhdGUuYnVmZmVyLmxlbmd0aCkKICAgICAgY2xlYXJCdWZmZXIodGhpcywgc3RhdGUpOwogIH0KfTsKCmZ1bmN0aW9uIGRlY29kZUNodW5rKHN0YXRlLCBjaHVuaywgZW5jb2RpbmcpIHsKICBpZiAoIXN0YXRlLm9iamVjdE1vZGUgJiYKICAgICAgc3RhdGUuZGVjb2RlU3RyaW5ncyAhPT0gZmFsc2UgJiYKICAgICAgdXRpbC5pc1N0cmluZyhjaHVuaykpIHsKICAgIGNodW5rID0gbmV3IEJ1ZmZlcihjaHVuaywgZW5jb2RpbmcpOwogIH0KICByZXR1cm4gY2h1bms7Cn0KCi8vIGlmIHdlJ3JlIGFscmVhZHkgd3JpdGluZyBzb21ldGhpbmcsIHRoZW4ganVzdCBwdXQgdGhpcwovLyBpbiB0aGUgcXVldWUsIGFuZCB3YWl0IG91ciB0dXJuLiAgT3RoZXJ3aXNlLCBjYWxsIF93cml0ZQovLyBJZiB3ZSByZXR1cm4gZmFsc2UsIHRoZW4gd2UgbmVlZCBhIGRyYWluIGV2ZW50LCBzbyBzZXQgdGhhdCBmbGFnLgpmdW5jdGlvbiB3cml0ZU9yQnVmZmVyKHN0cmVhbSwgc3RhdGUsIGNodW5rLCBlbmNvZGluZywgY2IpIHsKICBjaHVuayA9IGRlY29kZUNodW5rKHN0YXRlLCBjaHVuaywgZW5jb2RpbmcpOwogIGlmICh1dGlsLmlzQnVmZmVyKGNodW5rKSkKICAgIGVuY29kaW5nID0gJ2J1ZmZlcic7CiAgdmFyIGxlbiA9IHN0YXRlLm9iamVjdE1vZGUgPyAxIDogY2h1bmsubGVuZ3RoOwoKICBzdGF0ZS5sZW5ndGggKz0gbGVuOwoKICB2YXIgcmV0ID0gc3RhdGUubGVuZ3RoIDwgc3RhdGUuaGlnaFdhdGVyTWFyazsKICAvLyB3ZSBtdXN0IGVuc3VyZSB0aGF0IHByZXZpb3VzIG5lZWREcmFpbiB3aWxsIG5vdCBiZSByZXNldCB0byBmYWxzZS4KICBpZiAoIXJldCkKICAgIHN0YXRlLm5lZWREcmFpbiA9IHRydWU7CgogIGlmIChzdGF0ZS53cml0aW5nIHx8IHN0YXRlLmNvcmtlZCkKICAgIHN0YXRlLmJ1ZmZlci5wdXNoKG5ldyBXcml0ZVJlcShjaHVuaywgZW5jb2RpbmcsIGNiKSk7CiAgZWxzZQogICAgZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCBmYWxzZSwgbGVuLCBjaHVuaywgZW5jb2RpbmcsIGNiKTsKCiAgcmV0dXJuIHJldDsKfQoKZnVuY3Rpb24gZG9Xcml0ZShzdHJlYW0sIHN0YXRlLCB3cml0ZXYsIGxlbiwgY2h1bmssIGVuY29kaW5nLCBjYikgewogIHN0YXRlLndyaXRlbGVuID0gbGVuOwogIHN0YXRlLndyaXRlY2IgPSBjYjsKICBzdGF0ZS53cml0aW5nID0gdHJ1ZTsKICBzdGF0ZS5zeW5jID0gdHJ1ZTsKICBpZiAod3JpdGV2KQogICAgc3RyZWFtLl93cml0ZXYoY2h1bmssIHN0YXRlLm9ud3JpdGUpOwogIGVsc2UKICAgIHN0cmVhbS5fd3JpdGUoY2h1bmssIGVuY29kaW5nLCBzdGF0ZS5vbndyaXRlKTsKICBzdGF0ZS5zeW5jID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIG9ud3JpdGVFcnJvcihzdHJlYW0sIHN0YXRlLCBzeW5jLCBlciwgY2IpIHsKICBpZiAoc3luYykKICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgICBjYihlcik7CiAgICB9KTsKICBlbHNlIHsKICAgIHN0YXRlLnBlbmRpbmdjYi0tOwogICAgY2IoZXIpOwogIH0KCiAgc3RyZWFtLl93cml0YWJsZVN0YXRlLmVycm9yRW1pdHRlZCA9IHRydWU7CiAgc3RyZWFtLmVtaXQoJ2Vycm9yJywgZXIpOwp9CgpmdW5jdGlvbiBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpIHsKICBzdGF0ZS53cml0aW5nID0gZmFsc2U7CiAgc3RhdGUud3JpdGVjYiA9IG51bGw7CiAgc3RhdGUubGVuZ3RoIC09IHN0YXRlLndyaXRlbGVuOwogIHN0YXRlLndyaXRlbGVuID0gMDsKfQoKZnVuY3Rpb24gb253cml0ZShzdHJlYW0sIGVyKSB7CiAgdmFyIHN0YXRlID0gc3RyZWFtLl93cml0YWJsZVN0YXRlOwogIHZhciBzeW5jID0gc3RhdGUuc3luYzsKICB2YXIgY2IgPSBzdGF0ZS53cml0ZWNiOwoKICBvbndyaXRlU3RhdGVVcGRhdGUoc3RhdGUpOwoKICBpZiAoZXIpCiAgICBvbndyaXRlRXJyb3Ioc3RyZWFtLCBzdGF0ZSwgc3luYywgZXIsIGNiKTsKICBlbHNlIHsKICAgIC8vIENoZWNrIGlmIHdlJ3JlIGFjdHVhbGx5IHJlYWR5IHRvIGZpbmlzaCwgYnV0IGRvbid0IGVtaXQgeWV0CiAgICB2YXIgZmluaXNoZWQgPSBuZWVkRmluaXNoKHN0cmVhbSwgc3RhdGUpOwoKICAgIGlmICghZmluaXNoZWQgJiYKICAgICAgICAhc3RhdGUuY29ya2VkICYmCiAgICAgICAgIXN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgJiYKICAgICAgICBzdGF0ZS5idWZmZXIubGVuZ3RoKSB7CiAgICAgIGNsZWFyQnVmZmVyKHN0cmVhbSwgc3RhdGUpOwogICAgfQoKICAgIGlmIChzeW5jKSB7CiAgICAgIHByb2Nlc3MubmV4dFRpY2soZnVuY3Rpb24oKSB7CiAgICAgICAgYWZ0ZXJXcml0ZShzdHJlYW0sIHN0YXRlLCBmaW5pc2hlZCwgY2IpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGFmdGVyV3JpdGUoc3RyZWFtLCBzdGF0ZSwgZmluaXNoZWQsIGNiKTsKICAgIH0KICB9Cn0KCmZ1bmN0aW9uIGFmdGVyV3JpdGUoc3RyZWFtLCBzdGF0ZSwgZmluaXNoZWQsIGNiKSB7CiAgaWYgKCFmaW5pc2hlZCkKICAgIG9ud3JpdGVEcmFpbihzdHJlYW0sIHN0YXRlKTsKICBzdGF0ZS5wZW5kaW5nY2ItLTsKICBjYigpOwogIGZpbmlzaE1heWJlKHN0cmVhbSwgc3RhdGUpOwp9CgovLyBNdXN0IGZvcmNlIGNhbGxiYWNrIHRvIGJlIGNhbGxlZCBvbiBuZXh0VGljaywgc28gdGhhdCB3ZSBkb24ndAovLyBlbWl0ICdkcmFpbicgYmVmb3JlIHRoZSB3cml0ZSgpIGNvbnN1bWVyIGdldHMgdGhlICdmYWxzZScgcmV0dXJuCi8vIHZhbHVlLCBhbmQgaGFzIGEgY2hhbmNlIHRvIGF0dGFjaCBhICdkcmFpbicgbGlzdGVuZXIuCmZ1bmN0aW9uIG9ud3JpdGVEcmFpbihzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKHN0YXRlLmxlbmd0aCA9PT0gMCAmJiBzdGF0ZS5uZWVkRHJhaW4pIHsKICAgIHN0YXRlLm5lZWREcmFpbiA9IGZhbHNlOwogICAgc3RyZWFtLmVtaXQoJ2RyYWluJyk7CiAgfQp9CgoKLy8gaWYgdGhlcmUncyBzb21ldGhpbmcgaW4gdGhlIGJ1ZmZlciB3YWl0aW5nLCB0aGVuIHByb2Nlc3MgaXQKZnVuY3Rpb24gY2xlYXJCdWZmZXIoc3RyZWFtLCBzdGF0ZSkgewogIHN0YXRlLmJ1ZmZlclByb2Nlc3NpbmcgPSB0cnVlOwoKICBpZiAoc3RyZWFtLl93cml0ZXYgJiYgc3RhdGUuYnVmZmVyLmxlbmd0aCA+IDEpIHsKICAgIC8vIEZhc3QgY2FzZSwgd3JpdGUgZXZlcnl0aGluZyB1c2luZyBfd3JpdGV2KCkKICAgIHZhciBjYnMgPSBbXTsKICAgIGZvciAodmFyIGMgPSAwOyBjIDwgc3RhdGUuYnVmZmVyLmxlbmd0aDsgYysrKQogICAgICBjYnMucHVzaChzdGF0ZS5idWZmZXJbY10uY2FsbGJhY2spOwoKICAgIC8vIGNvdW50IHRoZSBvbmUgd2UgYXJlIGFkZGluZywgYXMgd2VsbC4KICAgIC8vIFRPRE8oaXNhYWNzKSBjbGVhbiB0aGlzIHVwCiAgICBzdGF0ZS5wZW5kaW5nY2IrKzsKICAgIGRvV3JpdGUoc3RyZWFtLCBzdGF0ZSwgdHJ1ZSwgc3RhdGUubGVuZ3RoLCBzdGF0ZS5idWZmZXIsICcnLCBmdW5jdGlvbihlcnIpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBzdGF0ZS5wZW5kaW5nY2ItLTsKICAgICAgICBjYnNbaV0oZXJyKTsKICAgICAgfQogICAgfSk7CgogICAgLy8gQ2xlYXIgYnVmZmVyCiAgICBzdGF0ZS5idWZmZXIgPSBbXTsKICB9IGVsc2UgewogICAgLy8gU2xvdyBjYXNlLCB3cml0ZSBjaHVua3Mgb25lLWJ5LW9uZQogICAgZm9yICh2YXIgYyA9IDA7IGMgPCBzdGF0ZS5idWZmZXIubGVuZ3RoOyBjKyspIHsKICAgICAgdmFyIGVudHJ5ID0gc3RhdGUuYnVmZmVyW2NdOwogICAgICB2YXIgY2h1bmsgPSBlbnRyeS5jaHVuazsKICAgICAgdmFyIGVuY29kaW5nID0gZW50cnkuZW5jb2Rpbmc7CiAgICAgIHZhciBjYiA9IGVudHJ5LmNhbGxiYWNrOwogICAgICB2YXIgbGVuID0gc3RhdGUub2JqZWN0TW9kZSA/IDEgOiBjaHVuay5sZW5ndGg7CgogICAgICBkb1dyaXRlKHN0cmVhbSwgc3RhdGUsIGZhbHNlLCBsZW4sIGNodW5rLCBlbmNvZGluZywgY2IpOwoKICAgICAgLy8gaWYgd2UgZGlkbid0IGNhbGwgdGhlIG9ud3JpdGUgaW1tZWRpYXRlbHksIHRoZW4KICAgICAgLy8gaXQgbWVhbnMgdGhhdCB3ZSBuZWVkIHRvIHdhaXQgdW50aWwgaXQgZG9lcy4KICAgICAgLy8gYWxzbywgdGhhdCBtZWFucyB0aGF0IHRoZSBjaHVuayBhbmQgY2IgYXJlIGN1cnJlbnRseQogICAgICAvLyBiZWluZyBwcm9jZXNzZWQsIHNvIG1vdmUgdGhlIGJ1ZmZlciBjb3VudGVyIHBhc3QgdGhlbS4KICAgICAgaWYgKHN0YXRlLndyaXRpbmcpIHsKICAgICAgICBjKys7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoYyA8IHN0YXRlLmJ1ZmZlci5sZW5ndGgpCiAgICAgIHN0YXRlLmJ1ZmZlciA9IHN0YXRlLmJ1ZmZlci5zbGljZShjKTsKICAgIGVsc2UKICAgICAgc3RhdGUuYnVmZmVyLmxlbmd0aCA9IDA7CiAgfQoKICBzdGF0ZS5idWZmZXJQcm9jZXNzaW5nID0gZmFsc2U7Cn0KCldyaXRhYmxlLnByb3RvdHlwZS5fd3JpdGUgPSBmdW5jdGlvbihjaHVuaywgZW5jb2RpbmcsIGNiKSB7CiAgY2IobmV3IEVycm9yKCdub3QgaW1wbGVtZW50ZWQnKSk7Cgp9OwoKV3JpdGFibGUucHJvdG90eXBlLl93cml0ZXYgPSBudWxsOwoKV3JpdGFibGUucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uKGNodW5rLCBlbmNvZGluZywgY2IpIHsKICB2YXIgc3RhdGUgPSB0aGlzLl93cml0YWJsZVN0YXRlOwoKICBpZiAodXRpbC5pc0Z1bmN0aW9uKGNodW5rKSkgewogICAgY2IgPSBjaHVuazsKICAgIGNodW5rID0gbnVsbDsKICAgIGVuY29kaW5nID0gbnVsbDsKICB9IGVsc2UgaWYgKHV0aWwuaXNGdW5jdGlvbihlbmNvZGluZykpIHsKICAgIGNiID0gZW5jb2Rpbmc7CiAgICBlbmNvZGluZyA9IG51bGw7CiAgfQoKICBpZiAoIXV0aWwuaXNOdWxsT3JVbmRlZmluZWQoY2h1bmspKQogICAgdGhpcy53cml0ZShjaHVuaywgZW5jb2RpbmcpOwoKICAvLyAuZW5kKCkgZnVsbHkgdW5jb3JrcwogIGlmIChzdGF0ZS5jb3JrZWQpIHsKICAgIHN0YXRlLmNvcmtlZCA9IDE7CiAgICB0aGlzLnVuY29yaygpOwogIH0KCiAgLy8gaWdub3JlIHVubmVjZXNzYXJ5IGVuZCgpIGNhbGxzLgogIGlmICghc3RhdGUuZW5kaW5nICYmICFzdGF0ZS5maW5pc2hlZCkKICAgIGVuZFdyaXRhYmxlKHRoaXMsIHN0YXRlLCBjYik7Cn07CgoKZnVuY3Rpb24gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKSB7CiAgcmV0dXJuIChzdGF0ZS5lbmRpbmcgJiYKICAgICAgICAgIHN0YXRlLmxlbmd0aCA9PT0gMCAmJgogICAgICAgICAgIXN0YXRlLmZpbmlzaGVkICYmCiAgICAgICAgICAhc3RhdGUud3JpdGluZyk7Cn0KCmZ1bmN0aW9uIHByZWZpbmlzaChzdHJlYW0sIHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5wcmVmaW5pc2hlZCkgewogICAgc3RhdGUucHJlZmluaXNoZWQgPSB0cnVlOwogICAgc3RyZWFtLmVtaXQoJ3ByZWZpbmlzaCcpOwogIH0KfQoKZnVuY3Rpb24gZmluaXNoTWF5YmUoc3RyZWFtLCBzdGF0ZSkgewogIHZhciBuZWVkID0gbmVlZEZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICBpZiAobmVlZCkgewogICAgaWYgKHN0YXRlLnBlbmRpbmdjYiA9PT0gMCkgewogICAgICBwcmVmaW5pc2goc3RyZWFtLCBzdGF0ZSk7CiAgICAgIHN0YXRlLmZpbmlzaGVkID0gdHJ1ZTsKICAgICAgc3RyZWFtLmVtaXQoJ2ZpbmlzaCcpOwogICAgfSBlbHNlCiAgICAgIHByZWZpbmlzaChzdHJlYW0sIHN0YXRlKTsKICB9CiAgcmV0dXJuIG5lZWQ7Cn0KCmZ1bmN0aW9uIGVuZFdyaXRhYmxlKHN0cmVhbSwgc3RhdGUsIGNiKSB7CiAgc3RhdGUuZW5kaW5nID0gdHJ1ZTsKICBmaW5pc2hNYXliZShzdHJlYW0sIHN0YXRlKTsKICBpZiAoY2IpIHsKICAgIGlmIChzdGF0ZS5maW5pc2hlZCkKICAgICAgcHJvY2Vzcy5uZXh0VGljayhjYik7CiAgICBlbHNlCiAgICAgIHN0cmVhbS5vbmNlKCdmaW5pc2gnLCBjYik7CiAgfQogIHN0YXRlLmVuZGVkID0gdHJ1ZTsKfQoKfSkuY2FsbCh0aGlzLHJlcXVpcmUoJ19wcm9jZXNzJykpCn0seyIuL19zdHJlYW1fZHVwbGV4IjoxMjEsIl9wcm9jZXNzIjo2MCwiYnVmZmVyIjo1MywiY29yZS11dGlsLWlzIjoxMjYsImluaGVyaXRzIjo3Niwic3RyZWFtIjo3Mn1dLDEyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzPXJlcXVpcmUoNjcpCn0seyIvVXNlcnMvdGdyaWVzc2VyL0dpdGh1Yi9ib29rc2hlbGYvYm9va3NoZWxmL25vZGVfbW9kdWxlcy9icm93c2VyaWZ5L25vZGVfbW9kdWxlcy9yZWFkYWJsZS1zdHJlYW0vbm9kZV9tb2R1bGVzL2NvcmUtdXRpbC1pcy9saWIvdXRpbC5qcyI6NjcsImJ1ZmZlciI6NTN9XSwxMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDU4KQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvaXNhcnJheS9pbmRleC5qcyI6NTh9XSwxMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cz1yZXF1aXJlKDczKQp9LHsiL1VzZXJzL3Rncmllc3Nlci9HaXRodWIvYm9va3NoZWxmL2Jvb2tzaGVsZi9ub2RlX21vZHVsZXMvYnJvd3NlcmlmeS9ub2RlX21vZHVsZXMvc3RyaW5nX2RlY29kZXIvaW5kZXguanMiOjczLCJidWZmZXIiOjUzfV0sMTI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZSgnLi9saWIvX3N0cmVhbV9yZWFkYWJsZS5qcycpOwpleHBvcnRzLlN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpOwpleHBvcnRzLlJlYWRhYmxlID0gZXhwb3J0czsKZXhwb3J0cy5Xcml0YWJsZSA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fd3JpdGFibGUuanMnKTsKZXhwb3J0cy5EdXBsZXggPSByZXF1aXJlKCcuL2xpYi9fc3RyZWFtX2R1cGxleC5qcycpOwpleHBvcnRzLlRyYW5zZm9ybSA9IHJlcXVpcmUoJy4vbGliL19zdHJlYW1fdHJhbnNmb3JtLmpzJyk7CmV4cG9ydHMuUGFzc1Rocm91Z2ggPSByZXF1aXJlKCcuL2xpYi9fc3RyZWFtX3Bhc3N0aHJvdWdoLmpzJyk7Cgp9LHsiLi9saWIvX3N0cmVhbV9kdXBsZXguanMiOjEyMSwiLi9saWIvX3N0cmVhbV9wYXNzdGhyb3VnaC5qcyI6MTIyLCIuL2xpYi9fc3RyZWFtX3JlYWRhYmxlLmpzIjoxMjMsIi4vbGliL19zdHJlYW1fdHJhbnNmb3JtLmpzIjoxMjQsIi4vbGliL19zdHJlYW1fd3JpdGFibGUuanMiOjEyNSwic3RyZWFtIjo3Mn1dLDEzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CihmdW5jdGlvbiAoZ2xvYmFsKXsKLyoqCiAqIEBsaWNlbnNlCiAqIExvLURhc2ggMi40LjEgKEN1c3RvbSBCdWlsZCkgPGh0dHA6Ly9sb2Rhc2guY29tLz4KICogQnVpbGQ6IGBsb2Rhc2ggbW9kZXJuIC1vIC4vZGlzdC9sb2Rhc2guanNgCiAqIENvcHlyaWdodCAyMDEyLTIwMTMgVGhlIERvam8gRm91bmRhdGlvbiA8aHR0cDovL2Rvam9mb3VuZGF0aW9uLm9yZy8+CiAqIEJhc2VkIG9uIFVuZGVyc2NvcmUuanMgMS41LjIgPGh0dHA6Ly91bmRlcnNjb3JlanMub3JnL0xJQ0VOU0U+CiAqIENvcHlyaWdodCAyMDA5LTIwMTMgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKICogQXZhaWxhYmxlIHVuZGVyIE1JVCBsaWNlbnNlIDxodHRwOi8vbG9kYXNoLmNvbS9saWNlbnNlPgogKi8KOyhmdW5jdGlvbigpIHsKCiAgLyoqIFVzZWQgYXMgYSBzYWZlIHJlZmVyZW5jZSBmb3IgYHVuZGVmaW5lZGAgaW4gcHJlIEVTNSBlbnZpcm9ubWVudHMgKi8KICB2YXIgdW5kZWZpbmVkOwoKICAvKiogVXNlZCB0byBwb29sIGFycmF5cyBhbmQgb2JqZWN0cyB1c2VkIGludGVybmFsbHkgKi8KICB2YXIgYXJyYXlQb29sID0gW10sCiAgICAgIG9iamVjdFBvb2wgPSBbXTsKCiAgLyoqIFVzZWQgdG8gZ2VuZXJhdGUgdW5pcXVlIElEcyAqLwogIHZhciBpZENvdW50ZXIgPSAwOwoKICAvKiogVXNlZCB0byBwcmVmaXgga2V5cyB0byBhdm9pZCBpc3N1ZXMgd2l0aCBgX19wcm90b19fYCBhbmQgcHJvcGVydGllcyBvbiBgT2JqZWN0LnByb3RvdHlwZWAgKi8KICB2YXIga2V5UHJlZml4ID0gK25ldyBEYXRlICsgJyc7CgogIC8qKiBVc2VkIGFzIHRoZSBzaXplIHdoZW4gb3B0aW1pemF0aW9ucyBhcmUgZW5hYmxlZCBmb3IgbGFyZ2UgYXJyYXlzICovCiAgdmFyIGxhcmdlQXJyYXlTaXplID0gNzU7CgogIC8qKiBVc2VkIGFzIHRoZSBtYXggc2l6ZSBvZiB0aGUgYGFycmF5UG9vbGAgYW5kIGBvYmplY3RQb29sYCAqLwogIHZhciBtYXhQb29sU2l6ZSA9IDQwOwoKICAvKiogVXNlZCB0byBkZXRlY3QgYW5kIHRlc3Qgd2hpdGVzcGFjZSAqLwogIHZhciB3aGl0ZXNwYWNlID0gKAogICAgLy8gd2hpdGVzcGFjZQogICAgJyBcdFx4MEJcZlx4QTBcdWZlZmYnICsKCiAgICAvLyBsaW5lIHRlcm1pbmF0b3JzCiAgICAnXG5cclx1MjAyOFx1MjAyOScgKwoKICAgIC8vIHVuaWNvZGUgY2F0ZWdvcnkgIlpzIiBzcGFjZSBzZXBhcmF0b3JzCiAgICAnXHUxNjgwXHUxODBlXHUyMDAwXHUyMDAxXHUyMDAyXHUyMDAzXHUyMDA0XHUyMDA1XHUyMDA2XHUyMDA3XHUyMDA4XHUyMDA5XHUyMDBhXHUyMDJmXHUyMDVmXHUzMDAwJwogICk7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGVtcHR5IHN0cmluZyBsaXRlcmFscyBpbiBjb21waWxlZCB0ZW1wbGF0ZSBzb3VyY2UgKi8KICB2YXIgcmVFbXB0eVN0cmluZ0xlYWRpbmcgPSAvXGJfX3AgXCs9ICcnOy9nLAogICAgICByZUVtcHR5U3RyaW5nTWlkZGxlID0gL1xiKF9fcCBcKz0pICcnIFwrL2csCiAgICAgIHJlRW1wdHlTdHJpbmdUcmFpbGluZyA9IC8oX19lXCguKj9cKXxcYl9fdFwpKSBcK1xuJyc7L2c7CgogIC8qKgogICAqIFVzZWQgdG8gbWF0Y2ggRVM2IHRlbXBsYXRlIGRlbGltaXRlcnMKICAgKiBodHRwOi8vcGVvcGxlLm1vemlsbGEub3JnL35qb3JlbmRvcmZmL2VzNi1kcmFmdC5odG1sI3NlYy1saXRlcmFscy1zdHJpbmctbGl0ZXJhbHMKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoW15cXH1dKig/OlxcLlteXFx9XSopKilcfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0ZWQgbmFtZWQgZnVuY3Rpb25zICovCiAgdmFyIHJlRnVuY05hbWUgPSAvXlxzKmZ1bmN0aW9uWyBcblxyXHRdK1x3LzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggImludGVycG9sYXRlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlSW50ZXJwb2xhdGUgPSAvPCU9KFtcc1xTXSs/KSU+L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGxlYWRpbmcgd2hpdGVzcGFjZSBhbmQgemVyb3MgdG8gYmUgcmVtb3ZlZCAqLwogIHZhciByZUxlYWRpbmdTcGFjZXNBbmRaZXJvcyA9IFJlZ0V4cCgnXlsnICsgd2hpdGVzcGFjZSArICddKjArKD89LiQpJyk7CgogIC8qKiBVc2VkIHRvIGVuc3VyZSBjYXB0dXJpbmcgb3JkZXIgb2YgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZU5vTWF0Y2ggPSAvKCReKS87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBmdW5jdGlvbnMgY29udGFpbmluZyBhIGB0aGlzYCByZWZlcmVuY2UgKi8KICB2YXIgcmVUaGlzID0gL1xidGhpc1xiLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGFzc2lnbiBkZWZhdWx0IGBjb250ZXh0YCBvYmplY3QgcHJvcGVydGllcyAqLwogIHZhciBjb250ZXh0UHJvcHMgPSBbCiAgICAnQXJyYXknLCAnQm9vbGVhbicsICdEYXRlJywgJ0Z1bmN0aW9uJywgJ01hdGgnLCAnTnVtYmVyJywgJ09iamVjdCcsCiAgICAnUmVnRXhwJywgJ1N0cmluZycsICdfJywgJ2F0dGFjaEV2ZW50JywgJ2NsZWFyVGltZW91dCcsICdpc0Zpbml0ZScsICdpc05hTicsCiAgICAncGFyc2VJbnQnLCAnc2V0VGltZW91dCcKICBdOwoKICAvKiogVXNlZCB0byBtYWtlIHRlbXBsYXRlIHNvdXJjZVVSTHMgZWFzaWVyIHRvIGlkZW50aWZ5ICovCiAgdmFyIHRlbXBsYXRlQ291bnRlciA9IDA7CgogIC8qKiBgT2JqZWN0I3RvU3RyaW5nYCByZXN1bHQgc2hvcnRjdXRzICovCiAgdmFyIGFyZ3NDbGFzcyA9ICdbb2JqZWN0IEFyZ3VtZW50c10nLAogICAgICBhcnJheUNsYXNzID0gJ1tvYmplY3QgQXJyYXldJywKICAgICAgYm9vbENsYXNzID0gJ1tvYmplY3QgQm9vbGVhbl0nLAogICAgICBkYXRlQ2xhc3MgPSAnW29iamVjdCBEYXRlXScsCiAgICAgIGZ1bmNDbGFzcyA9ICdbb2JqZWN0IEZ1bmN0aW9uXScsCiAgICAgIG51bWJlckNsYXNzID0gJ1tvYmplY3QgTnVtYmVyXScsCiAgICAgIG9iamVjdENsYXNzID0gJ1tvYmplY3QgT2JqZWN0XScsCiAgICAgIHJlZ2V4cENsYXNzID0gJ1tvYmplY3QgUmVnRXhwXScsCiAgICAgIHN0cmluZ0NsYXNzID0gJ1tvYmplY3QgU3RyaW5nXSc7CgogIC8qKiBVc2VkIHRvIGlkZW50aWZ5IG9iamVjdCBjbGFzc2lmaWNhdGlvbnMgdGhhdCBgXy5jbG9uZWAgc3VwcG9ydHMgKi8KICB2YXIgY2xvbmVhYmxlQ2xhc3NlcyA9IHt9OwogIGNsb25lYWJsZUNsYXNzZXNbZnVuY0NsYXNzXSA9IGZhbHNlOwogIGNsb25lYWJsZUNsYXNzZXNbYXJnc0NsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbYXJyYXlDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbYm9vbENsYXNzXSA9IGNsb25lYWJsZUNsYXNzZXNbZGF0ZUNsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tudW1iZXJDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW29iamVjdENsYXNzXSA9CiAgY2xvbmVhYmxlQ2xhc3Nlc1tyZWdleHBDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW3N0cmluZ0NsYXNzXSA9IHRydWU7CgogIC8qKiBVc2VkIGFzIGFuIGludGVybmFsIGBfLmRlYm91bmNlYCBvcHRpb25zIG9iamVjdCAqLwogIHZhciBkZWJvdW5jZU9wdGlvbnMgPSB7CiAgICAnbGVhZGluZyc6IGZhbHNlLAogICAgJ21heFdhaXQnOiAwLAogICAgJ3RyYWlsaW5nJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCBhcyB0aGUgcHJvcGVydHkgZGVzY3JpcHRvciBmb3IgYF9fYmluZERhdGFfX2AgKi8KICB2YXIgZGVzY3JpcHRvciA9IHsKICAgICdjb25maWd1cmFibGUnOiBmYWxzZSwKICAgICdlbnVtZXJhYmxlJzogZmFsc2UsCiAgICAndmFsdWUnOiBudWxsLAogICAgJ3dyaXRhYmxlJzogZmFsc2UKICB9OwoKICAvKiogVXNlZCB0byBkZXRlcm1pbmUgaWYgdmFsdWVzIGFyZSBvZiB0aGUgbGFuZ3VhZ2UgdHlwZSBPYmplY3QgKi8KICB2YXIgb2JqZWN0VHlwZXMgPSB7CiAgICAnYm9vbGVhbic6IGZhbHNlLAogICAgJ2Z1bmN0aW9uJzogdHJ1ZSwKICAgICdvYmplY3QnOiB0cnVlLAogICAgJ251bWJlcic6IGZhbHNlLAogICAgJ3N0cmluZyc6IGZhbHNlLAogICAgJ3VuZGVmaW5lZCc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZCBzdHJpbmcgbGl0ZXJhbHMgKi8KICB2YXIgc3RyaW5nRXNjYXBlcyA9IHsKICAgICdcXCc6ICdcXCcsCiAgICAiJyI6ICInIiwKICAgICdcbic6ICduJywKICAgICdccic6ICdyJywKICAgICdcdCc6ICd0JywKICAgICdcdTIwMjgnOiAndTIwMjgnLAogICAgJ1x1MjAyOSc6ICd1MjAyOScKICB9OwoKICAvKiogVXNlZCBhcyBhIHJlZmVyZW5jZSB0byB0aGUgZ2xvYmFsIG9iamVjdCAqLwogIHZhciByb290ID0gKG9iamVjdFR5cGVzW3R5cGVvZiB3aW5kb3ddICYmIHdpbmRvdykgfHwgdGhpczsKCiAgLyoqIERldGVjdCBmcmVlIHZhcmlhYmxlIGBleHBvcnRzYCAqLwogIHZhciBmcmVlRXhwb3J0cyA9IG9iamVjdFR5cGVzW3R5cGVvZiBleHBvcnRzXSAmJiBleHBvcnRzICYmICFleHBvcnRzLm5vZGVUeXBlICYmIGV4cG9ydHM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgbW9kdWxlYCAqLwogIHZhciBmcmVlTW9kdWxlID0gb2JqZWN0VHlwZXNbdHlwZW9mIG1vZHVsZV0gJiYgbW9kdWxlICYmICFtb2R1bGUubm9kZVR5cGUgJiYgbW9kdWxlOwoKICAvKiogRGV0ZWN0IHRoZSBwb3B1bGFyIENvbW1vbkpTIGV4dGVuc2lvbiBgbW9kdWxlLmV4cG9ydHNgICovCiAgdmFyIG1vZHVsZUV4cG9ydHMgPSBmcmVlTW9kdWxlICYmIGZyZWVNb2R1bGUuZXhwb3J0cyA9PT0gZnJlZUV4cG9ydHMgJiYgZnJlZUV4cG9ydHM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZ2xvYmFsYCBmcm9tIE5vZGUuanMgb3IgQnJvd3NlcmlmaWVkIGNvZGUgYW5kIHVzZSBpdCBhcyBgcm9vdGAgKi8KICB2YXIgZnJlZUdsb2JhbCA9IG9iamVjdFR5cGVzW3R5cGVvZiBnbG9iYWxdICYmIGdsb2JhbDsKICBpZiAoZnJlZUdsb2JhbCAmJiAoZnJlZUdsb2JhbC5nbG9iYWwgPT09IGZyZWVHbG9iYWwgfHwgZnJlZUdsb2JhbC53aW5kb3cgPT09IGZyZWVHbG9iYWwpKSB7CiAgICByb290ID0gZnJlZUdsb2JhbDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvKioKICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pbmRleE9mYCB3aXRob3V0IHN1cHBvcnQgZm9yIGJpbmFyeSBzZWFyY2hlcwogICAqIG9yIGBmcm9tSW5kZXhgIGNvbnN0cmFpbnRzLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICovCiAgZnVuY3Rpb24gYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgIHZhciBpbmRleCA9IChmcm9tSW5kZXggfHwgMCkgLSAxLAogICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgIHJldHVybiBpbmRleDsKICAgICAgfQogICAgfQogICAgcmV0dXJuIC0xOwogIH0KCiAgLyoqCiAgICogQW4gaW1wbGVtZW50YXRpb24gb2YgYF8uY29udGFpbnNgIGZvciBjYWNoZSBvYmplY3RzIHRoYXQgbWltaWNzIHRoZSByZXR1cm4KICAgKiBzaWduYXR1cmUgb2YgYF8uaW5kZXhPZmAgYnkgcmV0dXJuaW5nIGAwYCBpZiB0aGUgdmFsdWUgaXMgZm91bmQsIGVsc2UgYC0xYC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGNhY2hlIFRoZSBjYWNoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgYDBgIGlmIGB2YWx1ZWAgaXMgZm91bmQsIGVsc2UgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKICAgIGNhY2hlID0gY2FjaGUuY2FjaGU7CgogICAgaWYgKHR5cGUgPT0gJ2Jvb2xlYW4nIHx8IHZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGNhY2hlW3ZhbHVlXSA/IDAgOiAtMTsKICAgIH0KICAgIGlmICh0eXBlICE9ICdudW1iZXInICYmIHR5cGUgIT0gJ3N0cmluZycpIHsKICAgICAgdHlwZSA9ICdvYmplY3QnOwogICAgfQogICAgdmFyIGtleSA9IHR5cGUgPT0gJ251bWJlcicgPyB2YWx1ZSA6IGtleVByZWZpeCArIHZhbHVlOwogICAgY2FjaGUgPSAoY2FjaGUgPSBjYWNoZVt0eXBlXSkgJiYgY2FjaGVba2V5XTsKCiAgICByZXR1cm4gdHlwZSA9PSAnb2JqZWN0JwogICAgICA/IChjYWNoZSAmJiBiYXNlSW5kZXhPZihjYWNoZSwgdmFsdWUpID4gLTEgPyAwIDogLTEpCiAgICAgIDogKGNhY2hlID8gMCA6IC0xKTsKICB9CgogIC8qKgogICAqIEFkZHMgYSBnaXZlbiB2YWx1ZSB0byB0aGUgY29ycmVzcG9uZGluZyBjYWNoZSBvYmplY3QuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGFkZCB0byB0aGUgY2FjaGUuCiAgICovCiAgZnVuY3Rpb24gY2FjaGVQdXNoKHZhbHVlKSB7CiAgICB2YXIgY2FjaGUgPSB0aGlzLmNhY2hlLAogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgogICAgaWYgKHR5cGUgPT0gJ2Jvb2xlYW4nIHx8IHZhbHVlID09IG51bGwpIHsKICAgICAgY2FjaGVbdmFsdWVdID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIGlmICh0eXBlICE9ICdudW1iZXInICYmIHR5cGUgIT0gJ3N0cmluZycpIHsKICAgICAgICB0eXBlID0gJ29iamVjdCc7CiAgICAgIH0KICAgICAgdmFyIGtleSA9IHR5cGUgPT0gJ251bWJlcicgPyB2YWx1ZSA6IGtleVByZWZpeCArIHZhbHVlLAogICAgICAgICAgdHlwZUNhY2hlID0gY2FjaGVbdHlwZV0gfHwgKGNhY2hlW3R5cGVdID0ge30pOwoKICAgICAgaWYgKHR5cGUgPT0gJ29iamVjdCcpIHsKICAgICAgICAodHlwZUNhY2hlW2tleV0gfHwgKHR5cGVDYWNoZVtrZXldID0gW10pKS5wdXNoKHZhbHVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0eXBlQ2FjaGVba2V5XSA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9CgogIC8qKgogICAqIFVzZWQgYnkgYF8ubWF4YCBhbmQgYF8ubWluYCBhcyB0aGUgZGVmYXVsdCBjYWxsYmFjayB3aGVuIGEgZ2l2ZW4KICAgKiBjb2xsZWN0aW9uIGlzIGEgc3RyaW5nIHZhbHVlLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgVGhlIGNoYXJhY3RlciB0byBpbnNwZWN0LgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGNvZGUgdW5pdCBvZiBnaXZlbiBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gY2hhckF0Q2FsbGJhY2sodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5jaGFyQ29kZUF0KDApOwogIH0KCiAgLyoqCiAgICogVXNlZCBieSBgc29ydEJ5YCB0byBjb21wYXJlIHRyYW5zZm9ybWVkIGBjb2xsZWN0aW9uYCBlbGVtZW50cywgc3RhYmxlIHNvcnRpbmcKICAgKiB0aGVtIGluIGFzY2VuZGluZyBvcmRlci4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtPYmplY3R9IGEgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBiYC4KICAgKiBAcGFyYW0ge09iamVjdH0gYiBUaGUgb2JqZWN0IHRvIGNvbXBhcmUgdG8gYGFgLgogICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHNvcnQgb3JkZXIgaW5kaWNhdG9yIG9mIGAxYCBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGNvbXBhcmVBc2NlbmRpbmcoYSwgYikgewogICAgdmFyIGFjID0gYS5jcml0ZXJpYSwKICAgICAgICBiYyA9IGIuY3JpdGVyaWEsCiAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBhYy5sZW5ndGg7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgdmFyIHZhbHVlID0gYWNbaW5kZXhdLAogICAgICAgICAgb3RoZXIgPSBiY1tpbmRleF07CgogICAgICBpZiAodmFsdWUgIT09IG90aGVyKSB7CiAgICAgICAgaWYgKHZhbHVlID4gb3RoZXIgfHwgdHlwZW9mIHZhbHVlID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9CiAgICAgICAgaWYgKHZhbHVlIDwgb3RoZXIgfHwgdHlwZW9mIG90aGVyID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICAvLyBGaXhlcyBhbiBgQXJyYXkjc29ydGAgYnVnIGluIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgYXBwbGljYXRpb25zCiAgICAvLyB0aGF0IGNhdXNlcyBpdCwgdW5kZXIgY2VydGFpbiBjaXJjdW1zdGFuY2VzLCB0byByZXR1cm4gdGhlIHNhbWUgdmFsdWUgZm9yCiAgICAvLyBgYWAgYW5kIGBiYC4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qYXNoa2VuYXMvdW5kZXJzY29yZS9wdWxsLzEyNDcKICAgIC8vCiAgICAvLyBUaGlzIGFsc28gZW5zdXJlcyBhIHN0YWJsZSBzb3J0IGluIFY4IGFuZCBvdGhlciBlbmdpbmVzLgogICAgLy8gU2VlIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTkwCiAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgY2FjaGUgb2JqZWN0IHRvIG9wdGltaXplIGxpbmVhciBzZWFyY2hlcyBvZiBsYXJnZSBhcnJheXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheT1bXV0gVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcmV0dXJucyB7bnVsbHxPYmplY3R9IFJldHVybnMgdGhlIGNhY2hlIG9iamVjdCBvciBgbnVsbGAgaWYgY2FjaGluZyBzaG91bGQgbm90IGJlIHVzZWQuCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGUoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBmaXJzdCA9IGFycmF5WzBdLAogICAgICAgIG1pZCA9IGFycmF5WyhsZW5ndGggLyAyKSB8IDBdLAogICAgICAgIGxhc3QgPSBhcnJheVtsZW5ndGggLSAxXTsKCiAgICBpZiAoZmlyc3QgJiYgdHlwZW9mIGZpcnN0ID09ICdvYmplY3QnICYmCiAgICAgICAgbWlkICYmIHR5cGVvZiBtaWQgPT0gJ29iamVjdCcgJiYgbGFzdCAmJiB0eXBlb2YgbGFzdCA9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgY2FjaGUgPSBnZXRPYmplY3QoKTsKICAgIGNhY2hlWydmYWxzZSddID0gY2FjaGVbJ251bGwnXSA9IGNhY2hlWyd0cnVlJ10gPSBjYWNoZVsndW5kZWZpbmVkJ10gPSBmYWxzZTsKCiAgICB2YXIgcmVzdWx0ID0gZ2V0T2JqZWN0KCk7CiAgICByZXN1bHQuYXJyYXkgPSBhcnJheTsKICAgIHJlc3VsdC5jYWNoZSA9IGNhY2hlOwogICAgcmVzdWx0LnB1c2ggPSBjYWNoZVB1c2g7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZAogICAqIHN0cmluZyBsaXRlcmFscy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlU3RyaW5nQ2hhcihtYXRjaCkgewogICAgcmV0dXJuICdcXCcgKyBzdHJpbmdFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIEdldHMgYW4gYXJyYXkgZnJvbSB0aGUgYXJyYXkgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge0FycmF5fSBUaGUgYXJyYXkgZnJvbSB0aGUgcG9vbC4KICAgKi8KICBmdW5jdGlvbiBnZXRBcnJheSgpIHsKICAgIHJldHVybiBhcnJheVBvb2wucG9wKCkgfHwgW107CiAgfQoKICAvKioKICAgKiBHZXRzIGFuIG9iamVjdCBmcm9tIHRoZSBvYmplY3QgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge09iamVjdH0gVGhlIG9iamVjdCBmcm9tIHRoZSBwb29sLgogICAqLwogIGZ1bmN0aW9uIGdldE9iamVjdCgpIHsKICAgIHJldHVybiBvYmplY3RQb29sLnBvcCgpIHx8IHsKICAgICAgJ2FycmF5JzogbnVsbCwKICAgICAgJ2NhY2hlJzogbnVsbCwKICAgICAgJ2NyaXRlcmlhJzogbnVsbCwKICAgICAgJ2ZhbHNlJzogZmFsc2UsCiAgICAgICdpbmRleCc6IDAsCiAgICAgICdudWxsJzogZmFsc2UsCiAgICAgICdudW1iZXInOiBudWxsLAogICAgICAnb2JqZWN0JzogbnVsbCwKICAgICAgJ3B1c2gnOiBudWxsLAogICAgICAnc3RyaW5nJzogbnVsbCwKICAgICAgJ3RydWUnOiBmYWxzZSwKICAgICAgJ3VuZGVmaW5lZCc6IGZhbHNlLAogICAgICAndmFsdWUnOiBudWxsCiAgICB9OwogIH0KCiAgLyoqCiAgICogUmVsZWFzZXMgdGhlIGdpdmVuIGFycmF5IGJhY2sgdG8gdGhlIGFycmF5IHBvb2wuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheV0gVGhlIGFycmF5IHRvIHJlbGVhc2UuCiAgICovCiAgZnVuY3Rpb24gcmVsZWFzZUFycmF5KGFycmF5KSB7CiAgICBhcnJheS5sZW5ndGggPSAwOwogICAgaWYgKGFycmF5UG9vbC5sZW5ndGggPCBtYXhQb29sU2l6ZSkgewogICAgICBhcnJheVBvb2wucHVzaChhcnJheSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBSZWxlYXNlcyB0aGUgZ2l2ZW4gb2JqZWN0IGJhY2sgdG8gdGhlIG9iamVjdCBwb29sLgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0ge09iamVjdH0gW29iamVjdF0gVGhlIG9iamVjdCB0byByZWxlYXNlLgogICAqLwogIGZ1bmN0aW9uIHJlbGVhc2VPYmplY3Qob2JqZWN0KSB7CiAgICB2YXIgY2FjaGUgPSBvYmplY3QuY2FjaGU7CiAgICBpZiAoY2FjaGUpIHsKICAgICAgcmVsZWFzZU9iamVjdChjYWNoZSk7CiAgICB9CiAgICBvYmplY3QuYXJyYXkgPSBvYmplY3QuY2FjaGUgPSBvYmplY3QuY3JpdGVyaWEgPSBvYmplY3Qub2JqZWN0ID0gb2JqZWN0Lm51bWJlciA9IG9iamVjdC5zdHJpbmcgPSBvYmplY3QudmFsdWUgPSBudWxsOwogICAgaWYgKG9iamVjdFBvb2wubGVuZ3RoIDwgbWF4UG9vbFNpemUpIHsKICAgICAgb2JqZWN0UG9vbC5wdXNoKG9iamVjdCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBTbGljZXMgdGhlIGBjb2xsZWN0aW9uYCBmcm9tIHRoZSBgc3RhcnRgIGluZGV4IHVwIHRvLCBidXQgbm90IGluY2x1ZGluZywKICAgKiB0aGUgYGVuZGAgaW5kZXguCiAgICoKICAgKiBOb3RlOiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgaW5zdGVhZCBvZiBgQXJyYXkjc2xpY2VgIHRvIHN1cHBvcnQgbm9kZSBsaXN0cwogICAqIGluIElFIDwgOSBhbmQgdG8gZW5zdXJlIGRlbnNlIGFycmF5cyBhcmUgcmV0dXJuZWQuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBzbGljZS4KICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgVGhlIHN0YXJ0IGluZGV4LgogICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBpbmRleC4KICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBzbGljZShhcnJheSwgc3RhcnQsIGVuZCkgewogICAgc3RhcnQgfHwgKHN0YXJ0ID0gMCk7CiAgICBpZiAodHlwZW9mIGVuZCA9PSAndW5kZWZpbmVkJykgewogICAgICBlbmQgPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICB9CiAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICBsZW5ndGggPSBlbmQgLSBzdGFydCB8fCAwLAogICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCA8IDAgPyAwIDogbGVuZ3RoKTsKCiAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICByZXN1bHRbaW5kZXhdID0gYXJyYXlbc3RhcnQgKyBpbmRleF07CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBgbG9kYXNoYCBmdW5jdGlvbiB1c2luZyB0aGUgZ2l2ZW4gY29udGV4dCBvYmplY3QuCiAgICoKICAgKiBAc3RhdGljCiAgICogQG1lbWJlck9mIF8KICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICogQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0PXJvb3RdIFRoZSBjb250ZXh0IG9iamVjdC4KICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAqLwogIGZ1bmN0aW9uIHJ1bkluQ29udGV4dChjb250ZXh0KSB7CiAgICAvLyBBdm9pZCBpc3N1ZXMgd2l0aCBzb21lIEVTMyBlbnZpcm9ubWVudHMgdGhhdCBhdHRlbXB0IHRvIHVzZSB2YWx1ZXMsIG5hbWVkCiAgICAvLyBhZnRlciBidWlsdC1pbiBjb25zdHJ1Y3RvcnMgbGlrZSBgT2JqZWN0YCwgZm9yIHRoZSBjcmVhdGlvbiBvZiBsaXRlcmFscy4KICAgIC8vIEVTNSBjbGVhcnMgdGhpcyB1cCBieSBzdGF0aW5nIHRoYXQgbGl0ZXJhbHMgbXVzdCB1c2UgYnVpbHQtaW4gY29uc3RydWN0b3JzLgogICAgLy8gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTEuMS41LgogICAgY29udGV4dCA9IGNvbnRleHQgPyBfLmRlZmF1bHRzKHJvb3QuT2JqZWN0KCksIGNvbnRleHQsIF8ucGljayhyb290LCBjb250ZXh0UHJvcHMpKSA6IHJvb3Q7CgogICAgLyoqIE5hdGl2ZSBjb25zdHJ1Y3RvciByZWZlcmVuY2VzICovCiAgICB2YXIgQXJyYXkgPSBjb250ZXh0LkFycmF5LAogICAgICAgIEJvb2xlYW4gPSBjb250ZXh0LkJvb2xlYW4sCiAgICAgICAgRGF0ZSA9IGNvbnRleHQuRGF0ZSwKICAgICAgICBGdW5jdGlvbiA9IGNvbnRleHQuRnVuY3Rpb24sCiAgICAgICAgTWF0aCA9IGNvbnRleHQuTWF0aCwKICAgICAgICBOdW1iZXIgPSBjb250ZXh0Lk51bWJlciwKICAgICAgICBPYmplY3QgPSBjb250ZXh0Lk9iamVjdCwKICAgICAgICBSZWdFeHAgPSBjb250ZXh0LlJlZ0V4cCwKICAgICAgICBTdHJpbmcgPSBjb250ZXh0LlN0cmluZywKICAgICAgICBUeXBlRXJyb3IgPSBjb250ZXh0LlR5cGVFcnJvcjsKCiAgICAvKioKICAgICAqIFVzZWQgZm9yIGBBcnJheWAgbWV0aG9kIHJlZmVyZW5jZXMuCiAgICAgKgogICAgICogTm9ybWFsbHkgYEFycmF5LnByb3RvdHlwZWAgd291bGQgc3VmZmljZSwgaG93ZXZlciwgdXNpbmcgYW4gYXJyYXkgbGl0ZXJhbAogICAgICogYXZvaWRzIGlzc3VlcyBpbiBOYXJ3aGFsLgogICAgICovCiAgICB2YXIgYXJyYXlSZWYgPSBbXTsKCiAgICAvKiogVXNlZCBmb3IgbmF0aXZlIG1ldGhvZCByZWZlcmVuY2VzICovCiAgICB2YXIgb2JqZWN0UHJvdG8gPSBPYmplY3QucHJvdG90eXBlOwoKICAgIC8qKiBVc2VkIHRvIHJlc3RvcmUgdGhlIG9yaWdpbmFsIGBfYCByZWZlcmVuY2UgaW4gYG5vQ29uZmxpY3RgICovCiAgICB2YXIgb2xkRGFzaCA9IGNvbnRleHQuXzsKCiAgICAvKiogVXNlZCB0byByZXNvbHZlIHRoZSBpbnRlcm5hbCBbW0NsYXNzXV0gb2YgdmFsdWVzICovCiAgICB2YXIgdG9TdHJpbmcgPSBvYmplY3RQcm90by50b1N0cmluZzsKCiAgICAvKiogVXNlZCB0byBkZXRlY3QgaWYgYSBtZXRob2QgaXMgbmF0aXZlICovCiAgICB2YXIgcmVOYXRpdmUgPSBSZWdFeHAoJ14nICsKICAgICAgU3RyaW5nKHRvU3RyaW5nKQogICAgICAgIC5yZXBsYWNlKC9bLiorP14ke30oKXxbXF1cXF0vZywgJ1xcJCYnKQogICAgICAgIC5yZXBsYWNlKC90b1N0cmluZ3wgZm9yIFteXF1dKy9nLCAnLio/JykgKyAnJCcKICAgICk7CgogICAgLyoqIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzICovCiAgICB2YXIgY2VpbCA9IE1hdGguY2VpbCwKICAgICAgICBjbGVhclRpbWVvdXQgPSBjb250ZXh0LmNsZWFyVGltZW91dCwKICAgICAgICBmbG9vciA9IE1hdGguZmxvb3IsCiAgICAgICAgZm5Ub1N0cmluZyA9IEZ1bmN0aW9uLnByb3RvdHlwZS50b1N0cmluZywKICAgICAgICBnZXRQcm90b3R5cGVPZiA9IGlzTmF0aXZlKGdldFByb3RvdHlwZU9mID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKSAmJiBnZXRQcm90b3R5cGVPZiwKICAgICAgICBoYXNPd25Qcm9wZXJ0eSA9IG9iamVjdFByb3RvLmhhc093blByb3BlcnR5LAogICAgICAgIHB1c2ggPSBhcnJheVJlZi5wdXNoLAogICAgICAgIHNldFRpbWVvdXQgPSBjb250ZXh0LnNldFRpbWVvdXQsCiAgICAgICAgc3BsaWNlID0gYXJyYXlSZWYuc3BsaWNlLAogICAgICAgIHVuc2hpZnQgPSBhcnJheVJlZi51bnNoaWZ0OwoKICAgIC8qKiBVc2VkIHRvIHNldCBtZXRhIGRhdGEgb24gZnVuY3Rpb25zICovCiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIElFIDggb25seSBhY2NlcHRzIERPTSBlbGVtZW50cwogICAgICB0cnkgewogICAgICAgIHZhciBvID0ge30sCiAgICAgICAgICAgIGZ1bmMgPSBpc05hdGl2ZShmdW5jID0gT2JqZWN0LmRlZmluZVByb3BlcnR5KSAmJiBmdW5jLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jKG8sIG8sIG8pICYmIGZ1bmM7CiAgICAgIH0gY2F0Y2goZSkgeyB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9KCkpOwoKICAgIC8qIE5hdGl2ZSBtZXRob2Qgc2hvcnRjdXRzIGZvciBtZXRob2RzIHdpdGggdGhlIHNhbWUgbmFtZSBhcyBvdGhlciBgbG9kYXNoYCBtZXRob2RzICovCiAgICB2YXIgbmF0aXZlQ3JlYXRlID0gaXNOYXRpdmUobmF0aXZlQ3JlYXRlID0gT2JqZWN0LmNyZWF0ZSkgJiYgbmF0aXZlQ3JlYXRlLAogICAgICAgIG5hdGl2ZUlzQXJyYXkgPSBpc05hdGl2ZShuYXRpdmVJc0FycmF5ID0gQXJyYXkuaXNBcnJheSkgJiYgbmF0aXZlSXNBcnJheSwKICAgICAgICBuYXRpdmVJc0Zpbml0ZSA9IGNvbnRleHQuaXNGaW5pdGUsCiAgICAgICAgbmF0aXZlSXNOYU4gPSBjb250ZXh0LmlzTmFOLAogICAgICAgIG5hdGl2ZUtleXMgPSBpc05hdGl2ZShuYXRpdmVLZXlzID0gT2JqZWN0LmtleXMpICYmIG5hdGl2ZUtleXMsCiAgICAgICAgbmF0aXZlTWF4ID0gTWF0aC5tYXgsCiAgICAgICAgbmF0aXZlTWluID0gTWF0aC5taW4sCiAgICAgICAgbmF0aXZlUGFyc2VJbnQgPSBjb250ZXh0LnBhcnNlSW50LAogICAgICAgIG5hdGl2ZVJhbmRvbSA9IE1hdGgucmFuZG9tOwoKICAgIC8qKiBVc2VkIHRvIGxvb2t1cCBhIGJ1aWx0LWluIGNvbnN0cnVjdG9yIGJ5IFtbQ2xhc3NdXSAqLwogICAgdmFyIGN0b3JCeUNsYXNzID0ge307CiAgICBjdG9yQnlDbGFzc1thcnJheUNsYXNzXSA9IEFycmF5OwogICAgY3RvckJ5Q2xhc3NbYm9vbENsYXNzXSA9IEJvb2xlYW47CiAgICBjdG9yQnlDbGFzc1tkYXRlQ2xhc3NdID0gRGF0ZTsKICAgIGN0b3JCeUNsYXNzW2Z1bmNDbGFzc10gPSBGdW5jdGlvbjsKICAgIGN0b3JCeUNsYXNzW29iamVjdENsYXNzXSA9IE9iamVjdDsKICAgIGN0b3JCeUNsYXNzW251bWJlckNsYXNzXSA9IE51bWJlcjsKICAgIGN0b3JCeUNsYXNzW3JlZ2V4cENsYXNzXSA9IFJlZ0V4cDsKICAgIGN0b3JCeUNsYXNzW3N0cmluZ0NsYXNzXSA9IFN0cmluZzsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBgbG9kYXNoYCBvYmplY3Qgd2hpY2ggd3JhcHMgdGhlIGdpdmVuIHZhbHVlIHRvIGVuYWJsZSBpbnR1aXRpdmUKICAgICAqIG1ldGhvZCBjaGFpbmluZy4KICAgICAqCiAgICAgKiBJbiBhZGRpdGlvbiB0byBMby1EYXNoIG1ldGhvZHMsIHdyYXBwZXJzIGFsc28gaGF2ZSB0aGUgZm9sbG93aW5nIGBBcnJheWAgbWV0aG9kczoKICAgICAqIGBjb25jYXRgLCBgam9pbmAsIGBwb3BgLCBgcHVzaGAsIGByZXZlcnNlYCwgYHNoaWZ0YCwgYHNsaWNlYCwgYHNvcnRgLCBgc3BsaWNlYCwKICAgICAqIGFuZCBgdW5zaGlmdGAKICAgICAqCiAgICAgKiBDaGFpbmluZyBpcyBzdXBwb3J0ZWQgaW4gY3VzdG9tIGJ1aWxkcyBhcyBsb25nIGFzIHRoZSBgdmFsdWVgIG1ldGhvZCBpcwogICAgICogaW1wbGljaXRseSBvciBleHBsaWNpdGx5IGluY2x1ZGVkIGluIHRoZSBidWlsZC4KICAgICAqCiAgICAgKiBUaGUgY2hhaW5hYmxlIHdyYXBwZXIgZnVuY3Rpb25zIGFyZToKICAgICAqIGBhZnRlcmAsIGBhc3NpZ25gLCBgYmluZGAsIGBiaW5kQWxsYCwgYGJpbmRLZXlgLCBgY2hhaW5gLCBgY29tcGFjdGAsCiAgICAgKiBgY29tcG9zZWAsIGBjb25jYXRgLCBgY291bnRCeWAsIGBjcmVhdGVgLCBgY3JlYXRlQ2FsbGJhY2tgLCBgY3VycnlgLAogICAgICogYGRlYm91bmNlYCwgYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLCBgZmlsdGVyYCwgYGZsYXR0ZW5gLAogICAgICogYGZvckVhY2hgLCBgZm9yRWFjaFJpZ2h0YCwgYGZvckluYCwgYGZvckluUmlnaHRgLCBgZm9yT3duYCwgYGZvck93blJpZ2h0YCwKICAgICAqIGBmdW5jdGlvbnNgLCBgZ3JvdXBCeWAsIGBpbmRleEJ5YCwgYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsCiAgICAgKiBgaW52b2tlYCwgYGtleXNgLCBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwgYG1lcmdlYCwgYG1pbmAsIGBvYmplY3RgLCBgb21pdGAsCiAgICAgKiBgb25jZWAsIGBwYWlyc2AsIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsIGBwaWNrYCwgYHBsdWNrYCwgYHB1bGxgLCBgcHVzaGAsCiAgICAgKiBgcmFuZ2VgLCBgcmVqZWN0YCwgYHJlbW92ZWAsIGByZXN0YCwgYHJldmVyc2VgLCBgc2h1ZmZsZWAsIGBzbGljZWAsIGBzb3J0YCwKICAgICAqIGBzb3J0QnlgLCBgc3BsaWNlYCwgYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwgYHRyYW5zZm9ybWAsCiAgICAgKiBgdW5pb25gLCBgdW5pcWAsIGB1bnNoaWZ0YCwgYHVuemlwYCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLAogICAgICogYW5kIGB6aXBgCiAgICAgKgogICAgICogVGhlIG5vbi1jaGFpbmFibGUgd3JhcHBlciBmdW5jdGlvbnMgYXJlOgogICAgICogYGNsb25lYCwgYGNsb25lRGVlcGAsIGBjb250YWluc2AsIGBlc2NhcGVgLCBgZXZlcnlgLCBgZmluZGAsIGBmaW5kSW5kZXhgLAogICAgICogYGZpbmRLZXlgLCBgZmluZExhc3RgLCBgZmluZExhc3RJbmRleGAsIGBmaW5kTGFzdEtleWAsIGBoYXNgLCBgaWRlbnRpdHlgLAogICAgICogYGluZGV4T2ZgLCBgaXNBcmd1bWVudHNgLCBgaXNBcnJheWAsIGBpc0Jvb2xlYW5gLCBgaXNEYXRlYCwgYGlzRWxlbWVudGAsCiAgICAgKiBgaXNFbXB0eWAsIGBpc0VxdWFsYCwgYGlzRmluaXRlYCwgYGlzRnVuY3Rpb25gLCBgaXNOYU5gLCBgaXNOdWxsYCwgYGlzTnVtYmVyYCwKICAgICAqIGBpc09iamVjdGAsIGBpc1BsYWluT2JqZWN0YCwgYGlzUmVnRXhwYCwgYGlzU3RyaW5nYCwgYGlzVW5kZWZpbmVkYCwgYGpvaW5gLAogICAgICogYGxhc3RJbmRleE9mYCwgYG1peGluYCwgYG5vQ29uZmxpY3RgLCBgcGFyc2VJbnRgLCBgcG9wYCwgYHJhbmRvbWAsIGByZWR1Y2VgLAogICAgICogYHJlZHVjZVJpZ2h0YCwgYHJlc3VsdGAsIGBzaGlmdGAsIGBzaXplYCwgYHNvbWVgLCBgc29ydGVkSW5kZXhgLCBgcnVuSW5Db250ZXh0YCwKICAgICAqIGB0ZW1wbGF0ZWAsIGB1bmVzY2FwZWAsIGB1bmlxdWVJZGAsIGFuZCBgdmFsdWVgCiAgICAgKgogICAgICogVGhlIHdyYXBwZXIgZnVuY3Rpb25zIGBmaXJzdGAgYW5kIGBsYXN0YCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBgbmAgaXMKICAgICAqIHByb3ZpZGVkLCBvdGhlcndpc2UgdGhleSByZXR1cm4gdW53cmFwcGVkIHZhbHVlcy4KICAgICAqCiAgICAgKiBFeHBsaWNpdCBjaGFpbmluZyBjYW4gYmUgZW5hYmxlZCBieSB1c2luZyB0aGUgYF8uY2hhaW5gIG1ldGhvZC4KICAgICAqCiAgICAgKiBAbmFtZSBfCiAgICAgKiBAY29uc3RydWN0b3IKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcCBpbiBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhIGBsb2Rhc2hgIGluc3RhbmNlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgd3JhcHBlZCA9IF8oWzEsIDIsIDNdKTsKICAgICAqCiAgICAgKiAvLyByZXR1cm5zIGFuIHVud3JhcHBlZCB2YWx1ZQogICAgICogd3JhcHBlZC5yZWR1Y2UoZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIC8vIHJldHVybnMgYSB3cmFwcGVkIHZhbHVlCiAgICAgKiB2YXIgc3F1YXJlcyA9IHdyYXBwZWQubWFwKGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICogbnVtOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5pc0FycmF5KHNxdWFyZXMpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoc3F1YXJlcy52YWx1ZSgpKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gbG9kYXNoKHZhbHVlKSB7CiAgICAgIC8vIGRvbid0IHdyYXAgaWYgYWxyZWFkeSB3cmFwcGVkLCBldmVuIGlmIHdyYXBwZWQgYnkgYSBkaWZmZXJlbnQgYGxvZGFzaGAgY29uc3RydWN0b3IKICAgICAgcmV0dXJuICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgIWlzQXJyYXkodmFsdWUpICYmIGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdfX3dyYXBwZWRfXycpKQogICAgICAgPyB2YWx1ZQogICAgICAgOiBuZXcgbG9kYXNoV3JhcHBlcih2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBIGZhc3QgcGF0aCBmb3IgY3JlYXRpbmcgYGxvZGFzaGAgd3JhcHBlciBvYmplY3RzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoYWluQWxsIEEgZmxhZyB0byBlbmFibGUgY2hhaW5pbmcgZm9yIGFsbCBtZXRob2RzCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxvZGFzaFdyYXBwZXIodmFsdWUsIGNoYWluQWxsKSB7CiAgICAgIHRoaXMuX19jaGFpbl9fID0gISFjaGFpbkFsbDsKICAgICAgdGhpcy5fX3dyYXBwZWRfXyA9IHZhbHVlOwogICAgfQogICAgLy8gZW5zdXJlIGBuZXcgbG9kYXNoV3JhcHBlcmAgaXMgYW4gaW5zdGFuY2Ugb2YgYGxvZGFzaGAKICAgIGxvZGFzaFdyYXBwZXIucHJvdG90eXBlID0gbG9kYXNoLnByb3RvdHlwZTsKCiAgICAvKioKICAgICAqIEFuIG9iamVjdCB1c2VkIHRvIGZsYWcgZW52aXJvbm1lbnRzIGZlYXR1cmVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBPYmplY3QKICAgICAqLwogICAgdmFyIHN1cHBvcnQgPSBsb2Rhc2guc3VwcG9ydCA9IHt9OwoKICAgIC8qKgogICAgICogRGV0ZWN0IGlmIGZ1bmN0aW9ucyBjYW4gYmUgZGVjb21waWxlZCBieSBgRnVuY3Rpb24jdG9TdHJpbmdgCiAgICAgKiAoYWxsIGJ1dCBQUzMgYW5kIG9sZGVyIE9wZXJhIG1vYmlsZSBicm93c2VycyAmIGF2b2lkZWQgaW4gV2luZG93cyA4IGFwcHMpLgogICAgICoKICAgICAqIEBtZW1iZXJPZiBfLnN1cHBvcnQKICAgICAqIEB0eXBlIGJvb2xlYW4KICAgICAqLwogICAgc3VwcG9ydC5mdW5jRGVjb21wID0gIWlzTmF0aXZlKGNvbnRleHQuV2luUlRFcnJvcikgJiYgcmVUaGlzLnRlc3QocnVuSW5Db250ZXh0KTsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBgRnVuY3Rpb24jbmFtZWAgaXMgc3VwcG9ydGVkIChhbGwgYnV0IElFKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY05hbWVzID0gdHlwZW9mIEZ1bmN0aW9uLm5hbWUgPT0gJ3N0cmluZyc7CgogICAgLyoqCiAgICAgKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgZGVsaW1pdGVycyB1c2VkIGJ5IExvLURhc2ggYXJlIHNpbWlsYXIgdG8gdGhvc2UgaW4KICAgICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAgICogZGVsaW1pdGVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2VzY2FwZSc6IC88JS0oW1xzXFNdKz8pJT4vZywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAgICovCiAgICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gaW5qZWN0LgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgc3RyaW5nCiAgICAgICAqLwogICAgICAndmFyaWFibGUnOiAnJywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAnaW1wb3J0cyc6IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICAnXyc6IGxvZGFzaAogICAgICB9CiAgICB9OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uYmluZGAgdGhhdCBjcmVhdGVzIHRoZSBib3VuZCBmdW5jdGlvbiBhbmQKICAgICAqIHNldHMgaXRzIG1ldGEgZGF0YS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYmluZERhdGEgVGhlIGJpbmQgZGF0YSBhcnJheS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlQmluZChiaW5kRGF0YSkgewogICAgICB2YXIgZnVuYyA9IGJpbmREYXRhWzBdLAogICAgICAgICAgcGFydGlhbEFyZ3MgPSBiaW5kRGF0YVsyXSwKICAgICAgICAgIHRoaXNBcmcgPSBiaW5kRGF0YVs0XTsKCiAgICAgIGZ1bmN0aW9uIGJvdW5kKCkgewogICAgICAgIC8vIGBGdW5jdGlvbiNiaW5kYCBzcGVjCiAgICAgICAgLy8gaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4zLjQuNQogICAgICAgIGlmIChwYXJ0aWFsQXJncykgewogICAgICAgICAgLy8gYXZvaWQgYGFyZ3VtZW50c2Agb2JqZWN0IGRlb3B0aW1pemF0aW9ucyBieSB1c2luZyBgc2xpY2VgIGluc3RlYWQKICAgICAgICAgIC8vIG9mIGBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbGAgYW5kIG5vdCBhc3NpZ25pbmcgYGFyZ3VtZW50c2AgdG8gYQogICAgICAgICAgLy8gdmFyaWFibGUgYXMgYSB0ZXJuYXJ5IGV4cHJlc3Npb24KICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UocGFydGlhbEFyZ3MpOwogICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICAvLyBtaW1pYyB0aGUgY29uc3RydWN0b3IncyBgcmV0dXJuYCBiZWhhdmlvcgogICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTMuMi4yCiAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgICAgLy8gZW5zdXJlIGBuZXcgYm91bmRgIGlzIGFuIGluc3RhbmNlIG9mIGBmdW5jYAogICAgICAgICAgdmFyIHRoaXNCaW5kaW5nID0gYmFzZUNyZWF0ZShmdW5jLnByb3RvdHlwZSksCiAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyB8fCBhcmd1bWVudHMpOwogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyB8fCBhcmd1bWVudHMpOwogICAgICB9CiAgICAgIHNldEJpbmREYXRhKGJvdW5kLCBiaW5kRGF0YSk7CiAgICAgIHJldHVybiBib3VuZDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmNsb25lYCB3aXRob3V0IGFyZ3VtZW50IGp1Z2dsaW5nIG9yIHN1cHBvcnQKICAgICAqIGZvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2xvbmUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc0RlZXA9ZmFsc2VdIFNwZWNpZnkgYSBkZWVwIGNsb25lLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNsb25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgY2xvbmVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDbG9uZSh2YWx1ZSwgaXNEZWVwLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlKTsKICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gaW5zcGVjdCBbW0NsYXNzXV0KICAgICAgdmFyIGlzT2JqID0gaXNPYmplY3QodmFsdWUpOwogICAgICBpZiAoaXNPYmopIHsKICAgICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSk7CiAgICAgICAgaWYgKCFjbG9uZWFibGVDbGFzc2VzW2NsYXNzTmFtZV0pIHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGN0b3IgPSBjdG9yQnlDbGFzc1tjbGFzc05hbWVdOwogICAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgICAgICBjYXNlIGJvb2xDbGFzczoKICAgICAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgICAgICByZXR1cm4gbmV3IGN0b3IoK3ZhbHVlKTsKCiAgICAgICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgICAgY2FzZSBzdHJpbmdDbGFzczoKICAgICAgICAgICAgcmV0dXJuIG5ldyBjdG9yKHZhbHVlKTsKCiAgICAgICAgICBjYXNlIHJlZ2V4cENsYXNzOgogICAgICAgICAgICByZXN1bHQgPSBjdG9yKHZhbHVlLnNvdXJjZSwgcmVGbGFncy5leGVjKHZhbHVlKSk7CiAgICAgICAgICAgIHJlc3VsdC5sYXN0SW5kZXggPSB2YWx1ZS5sYXN0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBpc0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGlzRGVlcCkgewogICAgICAgIC8vIGNoZWNrIGZvciBjaXJjdWxhciByZWZlcmVuY2VzIGFuZCByZXR1cm4gY29ycmVzcG9uZGluZyBjbG9uZQogICAgICAgIHZhciBpbml0ZWRTdGFjayA9ICFzdGFja0E7CiAgICAgICAgc3RhY2tBIHx8IChzdGFja0EgPSBnZXRBcnJheSgpKTsKICAgICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgICB2YXIgbGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlc3VsdCA9IGlzQXJyID8gY3Rvcih2YWx1ZS5sZW5ndGgpIDoge307CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gaXNBcnIgPyBzbGljZSh2YWx1ZSkgOiBhc3NpZ24oe30sIHZhbHVlKTsKICAgICAgfQogICAgICAvLyBhZGQgYXJyYXkgcHJvcGVydGllcyBhc3NpZ25lZCBieSBgUmVnRXhwI2V4ZWNgCiAgICAgIGlmIChpc0FycikgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5kZXgnKSkgewogICAgICAgICAgcmVzdWx0LmluZGV4ID0gdmFsdWUuaW5kZXg7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCAnaW5wdXQnKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWUuaW5wdXQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZm9yIHNoYWxsb3cgY2xvbmUKICAgICAgaWYgKCFpc0RlZXApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGFkZCB0aGUgc291cmNlIHZhbHVlIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgICAgc3RhY2tCLnB1c2gocmVzdWx0KTsKCiAgICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGJhc2VDbG9uZShvYmpWYWx1ZSwgaXNEZWVwLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpOwogICAgICB9KTsKCiAgICAgIGlmIChpbml0ZWRTdGFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0EpOwogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5jcmVhdGVgIHdpdGhvdXQgc3VwcG9ydCBmb3IgYXNzaWduaW5nCiAgICAgKiBwcm9wZXJ0aWVzIHRvIHRoZSBjcmVhdGVkIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IHByb3RvdHlwZSBUaGUgb2JqZWN0IHRvIGluaGVyaXQgZnJvbS4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDcmVhdGUocHJvdG90eXBlLCBwcm9wZXJ0aWVzKSB7CiAgICAgIHJldHVybiBpc09iamVjdChwcm90b3R5cGUpID8gbmF0aXZlQ3JlYXRlKHByb3RvdHlwZSkgOiB7fTsKICAgIH0KICAgIC8vIGZhbGxiYWNrIGZvciBicm93c2VycyB3aXRob3V0IGBPYmplY3QuY3JlYXRlYAogICAgaWYgKCFuYXRpdmVDcmVhdGUpIHsKICAgICAgYmFzZUNyZWF0ZSA9IChmdW5jdGlvbigpIHsKICAgICAgICBmdW5jdGlvbiBPYmplY3QoKSB7fQogICAgICAgIHJldHVybiBmdW5jdGlvbihwcm90b3R5cGUpIHsKICAgICAgICAgIGlmIChpc09iamVjdChwcm90b3R5cGUpKSB7CiAgICAgICAgICAgIE9iamVjdC5wcm90b3R5cGUgPSBwcm90b3R5cGU7CiAgICAgICAgICAgIHZhciByZXN1bHQgPSBuZXcgT2JqZWN0OwogICAgICAgICAgICBPYmplY3QucHJvdG90eXBlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQgfHwgY29udGV4dC5PYmplY3QoKTsKICAgICAgICB9OwogICAgICB9KCkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY3JlYXRlQ2FsbGJhY2tgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY3JlYXRpbmcKICAgICAqICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2tzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IFtmdW5jPWlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcmdDb3VudF0gVGhlIG51bWJlciBvZiBhcmd1bWVudHMgdGhlIGNhbGxiYWNrIGFjY2VwdHMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KSB7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIG5vIGB0aGlzQXJnYCBvciBhbHJlYWR5IGJvdW5kIGJ5IGBGdW5jdGlvbiNiaW5kYAogICAgICBpZiAodHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgfHwgISgncHJvdG90eXBlJyBpbiBmdW5jKSkgewogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIHZhciBiaW5kRGF0YSA9IGZ1bmMuX19iaW5kRGF0YV9fOwogICAgICBpZiAodHlwZW9mIGJpbmREYXRhID09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKHN1cHBvcnQuZnVuY05hbWVzKSB7CiAgICAgICAgICBiaW5kRGF0YSA9ICFmdW5jLm5hbWU7CiAgICAgICAgfQogICAgICAgIGJpbmREYXRhID0gYmluZERhdGEgfHwgIXN1cHBvcnQuZnVuY0RlY29tcDsKICAgICAgICBpZiAoIWJpbmREYXRhKSB7CiAgICAgICAgICB2YXIgc291cmNlID0gZm5Ub1N0cmluZy5jYWxsKGZ1bmMpOwogICAgICAgICAgaWYgKCFzdXBwb3J0LmZ1bmNOYW1lcykgewogICAgICAgICAgICBiaW5kRGF0YSA9ICFyZUZ1bmNOYW1lLnRlc3Qoc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghYmluZERhdGEpIHsKICAgICAgICAgICAgLy8gY2hlY2tzIGlmIGBmdW5jYCByZWZlcmVuY2VzIHRoZSBgdGhpc2Aga2V5d29yZCBhbmQgc3RvcmVzIHRoZSByZXN1bHQKICAgICAgICAgICAgYmluZERhdGEgPSByZVRoaXMudGVzdChzb3VyY2UpOwogICAgICAgICAgICBzZXRCaW5kRGF0YShmdW5jLCBiaW5kRGF0YSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgYXJlIG5vIGB0aGlzYCByZWZlcmVuY2VzIG9yIGBmdW5jYCBpcyBib3VuZAogICAgICBpZiAoYmluZERhdGEgPT09IGZhbHNlIHx8IChiaW5kRGF0YSAhPT0gdHJ1ZSAmJiBiaW5kRGF0YVsxXSAmIDEpKSB7CiAgICAgICAgcmV0dXJuIGZ1bmM7CiAgICAgIH0KICAgICAgc3dpdGNoIChhcmdDb3VudCkgewogICAgICAgIGNhc2UgMTogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKHRoaXNBcmcsIHZhbHVlKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgMjogcmV0dXJuIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgYSwgYik7CiAgICAgICAgfTsKICAgICAgICBjYXNlIDM6IHJldHVybiBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgNDogcmV0dXJuIGZ1bmN0aW9uKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gYmluZChmdW5jLCB0aGlzQXJnKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBjcmVhdGVXcmFwcGVyYCB0aGF0IGNyZWF0ZXMgdGhlIHdyYXBwZXIgYW5kCiAgICAgKiBzZXRzIGl0cyBtZXRhIGRhdGEuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGJpbmREYXRhIFRoZSBiaW5kIGRhdGEgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZVdyYXBwZXIoYmluZERhdGEpIHsKICAgICAgdmFyIGZ1bmMgPSBiaW5kRGF0YVswXSwKICAgICAgICAgIGJpdG1hc2sgPSBiaW5kRGF0YVsxXSwKICAgICAgICAgIHBhcnRpYWxBcmdzID0gYmluZERhdGFbMl0sCiAgICAgICAgICBwYXJ0aWFsUmlnaHRBcmdzID0gYmluZERhdGFbM10sCiAgICAgICAgICB0aGlzQXJnID0gYmluZERhdGFbNF0sCiAgICAgICAgICBhcml0eSA9IGJpbmREYXRhWzVdOwoKICAgICAgdmFyIGlzQmluZCA9IGJpdG1hc2sgJiAxLAogICAgICAgICAgaXNCaW5kS2V5ID0gYml0bWFzayAmIDIsCiAgICAgICAgICBpc0N1cnJ5ID0gYml0bWFzayAmIDQsCiAgICAgICAgICBpc0N1cnJ5Qm91bmQgPSBiaXRtYXNrICYgOCwKICAgICAgICAgIGtleSA9IGZ1bmM7CgogICAgICBmdW5jdGlvbiBib3VuZCgpIHsKICAgICAgICB2YXIgdGhpc0JpbmRpbmcgPSBpc0JpbmQgPyB0aGlzQXJnIDogdGhpczsKICAgICAgICBpZiAocGFydGlhbEFyZ3MpIHsKICAgICAgICAgIHZhciBhcmdzID0gc2xpY2UocGFydGlhbEFyZ3MpOwogICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBpZiAocGFydGlhbFJpZ2h0QXJncyB8fCBpc0N1cnJ5KSB7CiAgICAgICAgICBhcmdzIHx8IChhcmdzID0gc2xpY2UoYXJndW1lbnRzKSk7CiAgICAgICAgICBpZiAocGFydGlhbFJpZ2h0QXJncykgewogICAgICAgICAgICBwdXNoLmFwcGx5KGFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VycnkgJiYgYXJncy5sZW5ndGggPCBhcml0eSkgewogICAgICAgICAgICBiaXRtYXNrIHw9IDE2ICYgfjMyOwogICAgICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZVdyYXBwZXIoW2Z1bmMsIChpc0N1cnJ5Qm91bmQgPyBiaXRtYXNrIDogYml0bWFzayAmIH4zKSwgYXJncywgbnVsbCwgdGhpc0FyZywgYXJpdHldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXJncyB8fCAoYXJncyA9IGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGlzQmluZEtleSkgewogICAgICAgICAgZnVuYyA9IHRoaXNCaW5kaW5nW2tleV07CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgYm91bmQpIHsKICAgICAgICAgIHRoaXNCaW5kaW5nID0gYmFzZUNyZWF0ZShmdW5jLnByb3RvdHlwZSk7CiAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgICAgICByZXR1cm4gaXNPYmplY3QocmVzdWx0KSA/IHJlc3VsdCA6IHRoaXNCaW5kaW5nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzQmluZGluZywgYXJncyk7CiAgICAgIH0KICAgICAgc2V0QmluZERhdGEoYm91bmQsIGJpbmREYXRhKTsKICAgICAgcmV0dXJuIGJvdW5kOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZGlmZmVyZW5jZWAgdGhhdCBhY2NlcHRzIGEgc2luZ2xlIGFycmF5CiAgICAgKiBvZiB2YWx1ZXMgdG8gZXhjbHVkZS4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzXSBUaGUgYXJyYXkgb2YgdmFsdWVzIHRvIGV4Y2x1ZGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZmlsdGVyZWQgdmFsdWVzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlRGlmZmVyZW5jZShhcnJheSwgdmFsdWVzKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIGlzTGFyZ2UgPSBsZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYgaW5kZXhPZiA9PT0gYmFzZUluZGV4T2YsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgdmFyIGNhY2hlID0gY3JlYXRlQ2FjaGUodmFsdWVzKTsKICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgIGluZGV4T2YgPSBjYWNoZUluZGV4T2Y7CiAgICAgICAgICB2YWx1ZXMgPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAoaW5kZXhPZih2YWx1ZXMsIHZhbHVlKSA8IDApIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICByZWxlYXNlT2JqZWN0KHZhbHVlcyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLmZsYXR0ZW5gIHdpdGhvdXQgc3VwcG9ydCBmb3IgY2FsbGJhY2sKICAgICAqIHNob3J0aGFuZHMgb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmbGF0dGVuLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTaGFsbG93PWZhbHNlXSBBIGZsYWcgdG8gcmVzdHJpY3QgZmxhdHRlbmluZyB0byBhIHNpbmdsZSBsZXZlbC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzU3RyaWN0PWZhbHNlXSBBIGZsYWcgdG8gcmVzdHJpY3QgZmxhdHRlbmluZyB0byBhcnJheXMgYW5kIGBhcmd1bWVudHNgIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc3RhcnQgZnJvbS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBmbGF0dGVuZWQgYXJyYXkuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VGbGF0dGVuKGFycmF5LCBpc1NoYWxsb3csIGlzU3RyaWN0LCBmcm9tSW5kZXgpIHsKICAgICAgdmFyIGluZGV4ID0gKGZyb21JbmRleCB8fCAwKSAtIDEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicKICAgICAgICAgICAgJiYgKGlzQXJyYXkodmFsdWUpIHx8IGlzQXJndW1lbnRzKHZhbHVlKSkpIHsKICAgICAgICAgIC8vIHJlY3Vyc2l2ZWx5IGZsYXR0ZW4gYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgIGlmICghaXNTaGFsbG93KSB7CiAgICAgICAgICAgIHZhbHVlID0gYmFzZUZsYXR0ZW4odmFsdWUsIGlzU2hhbGxvdywgaXNTdHJpY3QpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbEluZGV4ID0gLTEsCiAgICAgICAgICAgICAgdmFsTGVuZ3RoID0gdmFsdWUubGVuZ3RoLAogICAgICAgICAgICAgIHJlc0luZGV4ID0gcmVzdWx0Lmxlbmd0aDsKCiAgICAgICAgICByZXN1bHQubGVuZ3RoICs9IHZhbExlbmd0aDsKICAgICAgICAgIHdoaWxlICgrK3ZhbEluZGV4IDwgdmFsTGVuZ3RoKSB7CiAgICAgICAgICAgIHJlc3VsdFtyZXNJbmRleCsrXSA9IHZhbHVlW3ZhbEluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFpc1N0cmljdCkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaXNFcXVhbGAsIHdpdGhvdXQgc3VwcG9ydCBmb3IgYHRoaXNBcmdgIGJpbmRpbmcsCiAgICAgKiB0aGF0IGFsbG93cyBwYXJ0aWFsICJfLndoZXJlIiBzdHlsZSBjb21wYXJpc29ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaXNXaGVyZT1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHBlcmZvcm1pbmcgcGFydGlhbCBjb21wYXJpc29ucy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0E9W11dIFRyYWNrcyB0cmF2ZXJzZWQgYGFgIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc3RhY2tCPVtdXSBUcmFja3MgdHJhdmVyc2VkIGBiYCBvYmplY3RzLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSB2YWx1ZXMgYXJlIGVxdWl2YWxlbnQsIGVsc2UgYGZhbHNlYC4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUlzRXF1YWwoYSwgYiwgY2FsbGJhY2ssIGlzV2hlcmUsIHN0YWNrQSwgc3RhY2tCKSB7CiAgICAgIC8vIHVzZWQgdG8gaW5kaWNhdGUgdGhhdCB3aGVuIGNvbXBhcmluZyBvYmplY3RzLCBgYWAgaGFzIGF0IGxlYXN0IHRoZSBwcm9wZXJ0aWVzIG9mIGBiYAogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICB2YXIgcmVzdWx0ID0gY2FsbGJhY2soYSwgYik7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZXhpdCBlYXJseSBmb3IgaWRlbnRpY2FsIHZhbHVlcwogICAgICBpZiAoYSA9PT0gYikgewogICAgICAgIC8vIHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgICAgcmV0dXJuIGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKTsKICAgICAgfQogICAgICB2YXIgdHlwZSA9IHR5cGVvZiBhLAogICAgICAgICAgb3RoZXJUeXBlID0gdHlwZW9mIGI7CgogICAgICAvLyBleGl0IGVhcmx5IGZvciB1bmxpa2UgcHJpbWl0aXZlIHZhbHVlcwogICAgICBpZiAoYSA9PT0gYSAmJgogICAgICAgICAgIShhICYmIG9iamVjdFR5cGVzW3R5cGVdKSAmJgogICAgICAgICAgIShiICYmIG9iamVjdFR5cGVzW290aGVyVHlwZV0pKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIGBudWxsYCBhbmQgYHVuZGVmaW5lZGAgYXZvaWRpbmcgRVMzJ3MgRnVuY3Rpb24jY2FsbCBiZWhhdmlvcgogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjMuNC40CiAgICAgIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgIH0KICAgICAgLy8gY29tcGFyZSBbW0NsYXNzXV0gbmFtZXMKICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwoYSksCiAgICAgICAgICBvdGhlckNsYXNzID0gdG9TdHJpbmcuY2FsbChiKTsKCiAgICAgIGlmIChjbGFzc05hbWUgPT0gYXJnc0NsYXNzKSB7CiAgICAgICAgY2xhc3NOYW1lID0gb2JqZWN0Q2xhc3M7CiAgICAgIH0KICAgICAgaWYgKG90aGVyQ2xhc3MgPT0gYXJnc0NsYXNzKSB7CiAgICAgICAgb3RoZXJDbGFzcyA9IG9iamVjdENsYXNzOwogICAgICB9CiAgICAgIGlmIChjbGFzc05hbWUgIT0gb3RoZXJDbGFzcykgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAgIGNhc2UgYm9vbENsYXNzOgogICAgICAgIGNhc2UgZGF0ZUNsYXNzOgogICAgICAgICAgLy8gY29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1iZXJzLCBkYXRlcyB0byBtaWxsaXNlY29uZHMgYW5kIGJvb2xlYW5zCiAgICAgICAgICAvLyB0byBgMWAgb3IgYDBgIHRyZWF0aW5nIGludmFsaWQgZGF0ZXMgY29lcmNlZCB0byBgTmFOYCBhcyBub3QgZXF1YWwKICAgICAgICAgIHJldHVybiArYSA9PSArYjsKCiAgICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAgIC8vIHRyZWF0IGBOYU5gIHZzLiBgTmFOYCBhcyBlcXVhbAogICAgICAgICAgcmV0dXJuIChhICE9ICthKQogICAgICAgICAgICA/IGIgIT0gK2IKICAgICAgICAgICAgLy8gYnV0IHRyZWF0IGArMGAgdnMuIGAtMGAgYXMgbm90IGVxdWFsCiAgICAgICAgICAgIDogKGEgPT0gMCA/ICgxIC8gYSA9PSAxIC8gYikgOiBhID09ICtiKTsKCiAgICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICBjYXNlIHN0cmluZ0NsYXNzOgogICAgICAgICAgLy8gY29lcmNlIHJlZ2V4ZXMgdG8gc3RyaW5ncyAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMC42LjQpCiAgICAgICAgICAvLyB0cmVhdCBzdHJpbmcgcHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3QgaW5zdGFuY2VzIGFzIGVxdWFsCiAgICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gY2xhc3NOYW1lID09IGFycmF5Q2xhc3M7CiAgICAgIGlmICghaXNBcnIpIHsKICAgICAgICAvLyB1bndyYXAgYW55IGBsb2Rhc2hgIHdyYXBwZWQgdmFsdWVzCiAgICAgICAgdmFyIGFXcmFwcGVkID0gaGFzT3duUHJvcGVydHkuY2FsbChhLCAnX193cmFwcGVkX18nKSwKICAgICAgICAgICAgYldyYXBwZWQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsICdfX3dyYXBwZWRfXycpOwoKICAgICAgICBpZiAoYVdyYXBwZWQgfHwgYldyYXBwZWQpIHsKICAgICAgICAgIHJldHVybiBiYXNlSXNFcXVhbChhV3JhcHBlZCA/IGEuX193cmFwcGVkX18gOiBhLCBiV3JhcHBlZCA/IGIuX193cmFwcGVkX18gOiBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpOwogICAgICAgIH0KICAgICAgICAvLyBleGl0IGZvciBmdW5jdGlvbnMgYW5kIERPTSBub2RlcwogICAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICAgIHZhciBjdG9yQSA9IGEuY29uc3RydWN0b3IsCiAgICAgICAgICAgIGN0b3JCID0gYi5jb25zdHJ1Y3RvcjsKCiAgICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYKICAgICAgICAgICAgICAhKGlzRnVuY3Rpb24oY3RvckEpICYmIGN0b3JBIGluc3RhbmNlb2YgY3RvckEgJiYgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQikgJiYKICAgICAgICAgICAgICAoJ2NvbnN0cnVjdG9yJyBpbiBhICYmICdjb25zdHJ1Y3RvcicgaW4gYikKICAgICAgICAgICAgKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGFzc3VtZSBjeWNsaWMgc3RydWN0dXJlcyBhcmUgZXF1YWwKICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMi4zKQogICAgICB2YXIgaW5pdGVkU3RhY2sgPSAhc3RhY2tBOwogICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHNpemUgPSAwOwogICAgICByZXN1bHQgPSB0cnVlOwoKICAgICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICBzdGFja0EucHVzaChhKTsKICAgICAgc3RhY2tCLnB1c2goYik7CgogICAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycikgewogICAgICAgIC8vIGNvbXBhcmUgbGVuZ3RocyB0byBkZXRlcm1pbmUgaWYgYSBkZWVwIGNvbXBhcmlzb24gaXMgbmVjZXNzYXJ5CiAgICAgICAgbGVuZ3RoID0gYS5sZW5ndGg7CiAgICAgICAgc2l6ZSA9IGIubGVuZ3RoOwogICAgICAgIHJlc3VsdCA9IHNpemUgPT0gbGVuZ3RoOwoKICAgICAgICBpZiAocmVzdWx0IHx8IGlzV2hlcmUpIHsKICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSB0aGUgY29udGVudHMsIGlnbm9yaW5nIG5vbi1udW1lcmljIHByb3BlcnRpZXMKICAgICAgICAgIHdoaWxlIChzaXplLS0pIHsKICAgICAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoLAogICAgICAgICAgICAgICAgdmFsdWUgPSBiW3NpemVdOwoKICAgICAgICAgICAgaWYgKGlzV2hlcmUpIHsKICAgICAgICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgICAgICAgaWYgKChyZXN1bHQgPSBiYXNlSXNFcXVhbChhW2luZGV4XSwgdmFsdWUsIGNhbGxiYWNrLCBpc1doZXJlLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghKHJlc3VsdCA9IGJhc2VJc0VxdWFsKGFbc2l6ZV0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIC8vIGRlZXAgY29tcGFyZSBvYmplY3RzIHVzaW5nIGBmb3JJbmAsIGluc3RlYWQgb2YgYGZvck93bmAsIHRvIGF2b2lkIGBPYmplY3Qua2V5c2AKICAgICAgICAvLyB3aGljaCwgaW4gdGhpcyBjYXNlLCBpcyBtb3JlIGNvc3RseQogICAgICAgIGZvckluKGIsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGIpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkpIHsKICAgICAgICAgICAgLy8gY291bnQgdGhlIG51bWJlciBvZiBwcm9wZXJ0aWVzLgogICAgICAgICAgICBzaXplKys7CiAgICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSBlYWNoIHByb3BlcnR5IHZhbHVlLgogICAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGhhc093blByb3BlcnR5LmNhbGwoYSwga2V5KSAmJiBiYXNlSXNFcXVhbChhW2tleV0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKHJlc3VsdCAmJiAhaXNXaGVyZSkgewogICAgICAgICAgLy8gZW5zdXJlIGJvdGggb2JqZWN0cyBoYXZlIHRoZSBzYW1lIG51bWJlciBvZiBwcm9wZXJ0aWVzCiAgICAgICAgICBmb3JJbihhLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBhKSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkpIHsKICAgICAgICAgICAgICAvLyBgc2l6ZWAgd2lsbCBiZSBgLTFgIGlmIGBhYCBoYXMgbW9yZSBwcm9wZXJ0aWVzIHRoYW4gYGJgCiAgICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBzdGFja0EucG9wKCk7CiAgICAgIHN0YWNrQi5wb3AoKTsKCiAgICAgIGlmIChpbml0ZWRTdGFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0EpOwogICAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5tZXJnZWAgd2l0aG91dCBhcmd1bWVudCBqdWdnbGluZyBvciBzdXBwb3J0CiAgICAgKiBmb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzb3VyY2UgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgbWVyZ2luZyBwcm9wZXJ0aWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgdmFsdWVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZU1lcmdlKG9iamVjdCwgc291cmNlLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgKGlzQXJyYXkoc291cmNlKSA/IGZvckVhY2ggOiBmb3JPd24pKHNvdXJjZSwgZnVuY3Rpb24oc291cmNlLCBrZXkpIHsKICAgICAgICB2YXIgZm91bmQsCiAgICAgICAgICAgIGlzQXJyLAogICAgICAgICAgICByZXN1bHQgPSBzb3VyY2UsCiAgICAgICAgICAgIHZhbHVlID0gb2JqZWN0W2tleV07CgogICAgICAgIGlmIChzb3VyY2UgJiYgKChpc0FyciA9IGlzQXJyYXkoc291cmNlKSkgfHwgaXNQbGFpbk9iamVjdChzb3VyY2UpKSkgewogICAgICAgICAgLy8gYXZvaWQgbWVyZ2luZyBwcmV2aW91c2x5IG1lcmdlZCBjeWNsaWMgc291cmNlcwogICAgICAgICAgdmFyIHN0YWNrTGVuZ3RoID0gc3RhY2tBLmxlbmd0aDsKICAgICAgICAgIHdoaWxlIChzdGFja0xlbmd0aC0tKSB7CiAgICAgICAgICAgIGlmICgoZm91bmQgPSBzdGFja0Fbc3RhY2tMZW5ndGhdID09IHNvdXJjZSkpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IHN0YWNrQltzdGFja0xlbmd0aF07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgdmFyIGlzU2hhbGxvdzsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2sodmFsdWUsIHNvdXJjZSk7CiAgICAgICAgICAgICAgaWYgKChpc1NoYWxsb3cgPSB0eXBlb2YgcmVzdWx0ICE9ICd1bmRlZmluZWQnKSkgewogICAgICAgICAgICAgICAgdmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNTaGFsbG93KSB7CiAgICAgICAgICAgICAgdmFsdWUgPSBpc0FycgogICAgICAgICAgICAgICAgPyAoaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IFtdKQogICAgICAgICAgICAgICAgOiAoaXNQbGFpbk9iamVjdCh2YWx1ZSkgPyB2YWx1ZSA6IHt9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBhZGQgYHNvdXJjZWAgYW5kIGFzc29jaWF0ZWQgYHZhbHVlYCB0byB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMKICAgICAgICAgICAgc3RhY2tBLnB1c2goc291cmNlKTsKICAgICAgICAgICAgc3RhY2tCLnB1c2godmFsdWUpOwoKICAgICAgICAgICAgLy8gcmVjdXJzaXZlbHkgbWVyZ2Ugb2JqZWN0cyBhbmQgYXJyYXlzIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgICBiYXNlTWVyZ2UodmFsdWUsIHNvdXJjZSwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICByZXN1bHQgPSBzb3VyY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0ICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIHZhbHVlID0gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnJhbmRvbWAgd2l0aG91dCBhcmd1bWVudCBqdWdnbGluZyBvciBzdXBwb3J0CiAgICAgKiBmb3IgcmV0dXJuaW5nIGZsb2F0aW5nLXBvaW50IG51bWJlcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gVGhlIG1pbmltdW0gcG9zc2libGUgdmFsdWUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyBhIHJhbmRvbSBudW1iZXIuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VSYW5kb20obWluLCBtYXgpIHsKICAgICAgcmV0dXJuIG1pbiArIGZsb29yKG5hdGl2ZVJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLnVuaXFgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICogb3IgYHRoaXNBcmdgIGJpbmRpbmcuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTb3J0ZWQ9ZmFsc2VdIEEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGBhcnJheWAgaXMgc29ydGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZVVuaXEoYXJyYXksIGlzU29ydGVkLCBjYWxsYmFjaykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICByZXN1bHQgPSBbXTsKCiAgICAgIHZhciBpc0xhcmdlID0gIWlzU29ydGVkICYmIGxlbmd0aCA+PSBsYXJnZUFycmF5U2l6ZSAmJiBpbmRleE9mID09PSBiYXNlSW5kZXhPZiwKICAgICAgICAgIHNlZW4gPSAoY2FsbGJhY2sgfHwgaXNMYXJnZSkgPyBnZXRBcnJheSgpIDogcmVzdWx0OwoKICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICB2YXIgY2FjaGUgPSBjcmVhdGVDYWNoZShzZWVuKTsKICAgICAgICBpbmRleE9mID0gY2FjaGVJbmRleE9mOwogICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XSwKICAgICAgICAgICAgY29tcHV0ZWQgPSBjYWxsYmFjayA/IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgYXJyYXkpIDogdmFsdWU7CgogICAgICAgIGlmIChpc1NvcnRlZAogICAgICAgICAgICAgID8gIWluZGV4IHx8IHNlZW5bc2Vlbi5sZW5ndGggLSAxXSAhPT0gY29tcHV0ZWQKICAgICAgICAgICAgICA6IGluZGV4T2Yoc2VlbiwgY29tcHV0ZWQpIDwgMAogICAgICAgICAgICApIHsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBpc0xhcmdlKSB7CiAgICAgICAgICAgIHNlZW4ucHVzaChjb21wdXRlZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgcmVsZWFzZUFycmF5KHNlZW4uYXJyYXkpOwogICAgICAgIHJlbGVhc2VPYmplY3Qoc2Vlbik7CiAgICAgIH0gZWxzZSBpZiAoY2FsbGJhY2spIHsKICAgICAgICByZWxlYXNlQXJyYXkoc2Vlbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGFnZ3JlZ2F0ZXMgYSBjb2xsZWN0aW9uLCBjcmVhdGluZyBhbiBvYmplY3QgY29tcG9zZWQKICAgICAqIG9mIGtleXMgZ2VuZXJhdGVkIGZyb20gdGhlIHJlc3VsdHMgb2YgcnVubmluZyBlYWNoIGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24KICAgICAqIHRocm91Z2ggYSBjYWxsYmFjay4gVGhlIGdpdmVuIGBzZXR0ZXJgIGZ1bmN0aW9uIHNldHMgdGhlIGtleXMgYW5kIHZhbHVlcwogICAgICogb2YgdGhlIGNvbXBvc2VkIG9iamVjdC4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gc2V0dGVyIFRoZSBzZXR0ZXIgZnVuY3Rpb24uCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBhZ2dyZWdhdG9yIGZ1bmN0aW9uLgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVBZ2dyZWdhdG9yKHNldHRlcikgewogICAgICByZXR1cm4gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgICBzZXR0ZXIocmVzdWx0LCB2YWx1ZSwgY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSwgY29sbGVjdGlvbik7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICAgIHNldHRlcihyZXN1bHQsIHZhbHVlLCBjYWxsYmFjayh2YWx1ZSwga2V5LCBjb2xsZWN0aW9uKSwgY29sbGVjdGlvbik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgZWl0aGVyIGN1cnJpZXMgb3IgaW52b2tlcyBgZnVuY2AKICAgICAqIHdpdGggYW4gb3B0aW9uYWwgYHRoaXNgIGJpbmRpbmcgYW5kIHBhcnRpYWxseSBhcHBsaWVkIGFyZ3VtZW50cy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IGZ1bmMgVGhlIGZ1bmN0aW9uIG9yIG1ldGhvZCBuYW1lIHRvIHJlZmVyZW5jZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBiaXRtYXNrIFRoZSBiaXRtYXNrIG9mIG1ldGhvZCBmbGFncyB0byBjb21wb3NlLgogICAgICogIFRoZSBiaXRtYXNrIG1heSBiZSBjb21wb3NlZCBvZiB0aGUgZm9sbG93aW5nIGZsYWdzOgogICAgICogIDEgLSBgXy5iaW5kYAogICAgICogIDIgLSBgXy5iaW5kS2V5YAogICAgICogIDQgLSBgXy5jdXJyeWAKICAgICAqICA4IC0gYF8uY3VycnlgIChib3VuZCkKICAgICAqICAxNiAtIGBfLnBhcnRpYWxgCiAgICAgKiAgMzIgLSBgXy5wYXJ0aWFsUmlnaHRgCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbcGFydGlhbEFyZ3NdIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBwcmVwZW5kIHRvIHRob3NlCiAgICAgKiAgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwYXJ0aWFsUmlnaHRBcmdzXSBBbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gYXBwZW5kIHRvIHRob3NlCiAgICAgKiAgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgZnVuY2AuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyaXR5XSBUaGUgYXJpdHkgb2YgYGZ1bmNgLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVdyYXBwZXIoZnVuYywgYml0bWFzaywgcGFydGlhbEFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MsIHRoaXNBcmcsIGFyaXR5KSB7CiAgICAgIHZhciBpc0JpbmQgPSBiaXRtYXNrICYgMSwKICAgICAgICAgIGlzQmluZEtleSA9IGJpdG1hc2sgJiAyLAogICAgICAgICAgaXNDdXJyeSA9IGJpdG1hc2sgJiA0LAogICAgICAgICAgaXNDdXJyeUJvdW5kID0gYml0bWFzayAmIDgsCiAgICAgICAgICBpc1BhcnRpYWwgPSBiaXRtYXNrICYgMTYsCiAgICAgICAgICBpc1BhcnRpYWxSaWdodCA9IGJpdG1hc2sgJiAzMjsKCiAgICAgIGlmICghaXNCaW5kS2V5ICYmICFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICBpZiAoaXNQYXJ0aWFsICYmICFwYXJ0aWFsQXJncy5sZW5ndGgpIHsKICAgICAgICBiaXRtYXNrICY9IH4xNjsKICAgICAgICBpc1BhcnRpYWwgPSBwYXJ0aWFsQXJncyA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChpc1BhcnRpYWxSaWdodCAmJiAhcGFydGlhbFJpZ2h0QXJncy5sZW5ndGgpIHsKICAgICAgICBiaXRtYXNrICY9IH4zMjsKICAgICAgICBpc1BhcnRpYWxSaWdodCA9IHBhcnRpYWxSaWdodEFyZ3MgPSBmYWxzZTsKICAgICAgfQogICAgICB2YXIgYmluZERhdGEgPSBmdW5jICYmIGZ1bmMuX19iaW5kRGF0YV9fOwogICAgICBpZiAoYmluZERhdGEgJiYgYmluZERhdGEgIT09IHRydWUpIHsKICAgICAgICAvLyBjbG9uZSBgYmluZERhdGFgCiAgICAgICAgYmluZERhdGEgPSBzbGljZShiaW5kRGF0YSk7CiAgICAgICAgaWYgKGJpbmREYXRhWzJdKSB7CiAgICAgICAgICBiaW5kRGF0YVsyXSA9IHNsaWNlKGJpbmREYXRhWzJdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGJpbmREYXRhWzNdKSB7CiAgICAgICAgICBiaW5kRGF0YVszXSA9IHNsaWNlKGJpbmREYXRhWzNdKTsKICAgICAgICB9CiAgICAgICAgLy8gc2V0IGB0aGlzQmluZGluZ2AgaXMgbm90IHByZXZpb3VzbHkgYm91bmQKICAgICAgICBpZiAoaXNCaW5kICYmICEoYmluZERhdGFbMV0gJiAxKSkgewogICAgICAgICAgYmluZERhdGFbNF0gPSB0aGlzQXJnOwogICAgICAgIH0KICAgICAgICAvLyBzZXQgaWYgcHJldmlvdXNseSBib3VuZCBidXQgbm90IGN1cnJlbnRseSAoc3Vic2VxdWVudCBjdXJyaWVkIGZ1bmN0aW9ucykKICAgICAgICBpZiAoIWlzQmluZCAmJiBiaW5kRGF0YVsxXSAmIDEpIHsKICAgICAgICAgIGJpdG1hc2sgfD0gODsKICAgICAgICB9CiAgICAgICAgLy8gc2V0IGN1cnJpZWQgYXJpdHkgaWYgbm90IHlldCBzZXQKICAgICAgICBpZiAoaXNDdXJyeSAmJiAhKGJpbmREYXRhWzFdICYgNCkpIHsKICAgICAgICAgIGJpbmREYXRhWzVdID0gYXJpdHk7CiAgICAgICAgfQogICAgICAgIC8vIGFwcGVuZCBwYXJ0aWFsIGxlZnQgYXJndW1lbnRzCiAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgcHVzaC5hcHBseShiaW5kRGF0YVsyXSB8fCAoYmluZERhdGFbMl0gPSBbXSksIHBhcnRpYWxBcmdzKTsKICAgICAgICB9CiAgICAgICAgLy8gYXBwZW5kIHBhcnRpYWwgcmlnaHQgYXJndW1lbnRzCiAgICAgICAgaWYgKGlzUGFydGlhbFJpZ2h0KSB7CiAgICAgICAgICB1bnNoaWZ0LmFwcGx5KGJpbmREYXRhWzNdIHx8IChiaW5kRGF0YVszXSA9IFtdKSwgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgfQogICAgICAgIC8vIG1lcmdlIGZsYWdzCiAgICAgICAgYmluZERhdGFbMV0gfD0gYml0bWFzazsKICAgICAgICByZXR1cm4gY3JlYXRlV3JhcHBlci5hcHBseShudWxsLCBiaW5kRGF0YSk7CiAgICAgIH0KICAgICAgLy8gZmFzdCBwYXRoIGZvciBgXy5iaW5kYAogICAgICB2YXIgY3JlYXRlciA9IChiaXRtYXNrID09IDEgfHwgYml0bWFzayA9PT0gMTcpID8gYmFzZUJpbmQgOiBiYXNlQ3JlYXRlV3JhcHBlcjsKICAgICAgcmV0dXJuIGNyZWF0ZXIoW2Z1bmMsIGJpdG1hc2ssIHBhcnRpYWxBcmdzLCBwYXJ0aWFsUmlnaHRBcmdzLCB0aGlzQXJnLCBhcml0eV0pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGFwcHJvcHJpYXRlICJpbmRleE9mIiBmdW5jdGlvbi4gSWYgdGhlIGBfLmluZGV4T2ZgIG1ldGhvZCBpcwogICAgICogY3VzdG9taXplZCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgY3VzdG9tIG1ldGhvZCwgb3RoZXJ3aXNlIGl0IHJldHVybnMKICAgICAqIHRoZSBgYmFzZUluZGV4T2ZgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlICJpbmRleE9mIiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SW5kZXhPZigpIHsKICAgICAgdmFyIHJlc3VsdCA9IChyZXN1bHQgPSBsb2Rhc2guaW5kZXhPZikgPT09IGluZGV4T2YgPyBiYXNlSW5kZXhPZiA6IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgbmF0aXZlIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIG5hdGl2ZSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBpc05hdGl2ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbicgJiYgcmVOYXRpdmUudGVzdCh2YWx1ZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBTZXRzIGB0aGlzYCBiaW5kaW5nIGRhdGEgb24gYSBnaXZlbiBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gc2V0IGRhdGEgb24uCiAgICAgKiBAcGFyYW0ge0FycmF5fSB2YWx1ZSBUaGUgZGF0YSBhcnJheSB0byBzZXQuCiAgICAgKi8KICAgIHZhciBzZXRCaW5kRGF0YSA9ICFkZWZpbmVQcm9wZXJ0eSA/IG5vb3AgOiBmdW5jdGlvbihmdW5jLCB2YWx1ZSkgewogICAgICBkZXNjcmlwdG9yLnZhbHVlID0gdmFsdWU7CiAgICAgIGRlZmluZVByb3BlcnR5KGZ1bmMsICdfX2JpbmREYXRhX18nLCBkZXNjcmlwdG9yKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBIGZhbGxiYWNrIGltcGxlbWVudGF0aW9uIG9mIGBpc1BsYWluT2JqZWN0YCB3aGljaCBjaGVja3MgaWYgYSBnaXZlbiB2YWx1ZQogICAgICogaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLCBhc3N1bWluZyBvYmplY3RzIGNyZWF0ZWQKICAgICAqIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3RvciBoYXZlIG5vIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYW5kIHRoYXQKICAgICAqIHRoZXJlIGFyZSBubyBgT2JqZWN0LnByb3RvdHlwZWAgZXh0ZW5zaW9ucy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSkgewogICAgICB2YXIgY3RvciwKICAgICAgICAgIHJlc3VsdDsKCiAgICAgIC8vIGF2b2lkIG5vbiBPYmplY3Qgb2JqZWN0cywgYGFyZ3VtZW50c2Agb2JqZWN0cywgYW5kIERPTSBlbGVtZW50cwogICAgICBpZiAoISh2YWx1ZSAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBvYmplY3RDbGFzcykgfHwKICAgICAgICAgIChjdG9yID0gdmFsdWUuY29uc3RydWN0b3IsIGlzRnVuY3Rpb24oY3RvcikgJiYgIShjdG9yIGluc3RhbmNlb2YgY3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIEluIG1vc3QgZW52aXJvbm1lbnRzIGFuIG9iamVjdCdzIG93biBwcm9wZXJ0aWVzIGFyZSBpdGVyYXRlZCBiZWZvcmUKICAgICAgLy8gaXRzIGluaGVyaXRlZCBwcm9wZXJ0aWVzLiBJZiB0aGUgbGFzdCBpdGVyYXRlZCBwcm9wZXJ0eSBpcyBhbiBvYmplY3QncwogICAgICAvLyBvd24gcHJvcGVydHkgdGhlbiB0aGVyZSBhcmUgbm8gaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAgZm9ySW4odmFsdWUsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHQgPSBrZXk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdHlwZW9mIHJlc3VsdCA9PSAndW5kZWZpbmVkJyB8fCBoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCByZXN1bHQpOwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgdW5lc2NhcGVgIHRvIGNvbnZlcnQgSFRNTCBlbnRpdGllcyB0byBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbWF0Y2ggVGhlIG1hdGNoZWQgY2hhcmFjdGVyIHRvIHVuZXNjYXBlLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdW5lc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gdW5lc2NhcGVIdG1sQ2hhcihtYXRjaCkgewogICAgICByZXR1cm4gaHRtbFVuZXNjYXBlc1ttYXRjaF07CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBgYXJndW1lbnRzYCBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogKGZ1bmN0aW9uKCkgeyByZXR1cm4gXy5pc0FyZ3VtZW50cyhhcmd1bWVudHMpOyB9KSgxLCAyLCAzKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzQXJndW1lbnRzKFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicgJiYKICAgICAgICB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcmdzQ2xhc3MgfHwgZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhbiBhcnJheS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhbiBhcnJheSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJyYXkoYXJndW1lbnRzKTsgfSkoKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0FycmF5KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIHZhciBpc0FycmF5ID0gbmF0aXZlSXNBcnJheSB8fCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHR5cGVvZiB2YWx1ZS5sZW5ndGggPT0gJ251bWJlcicgJiYKICAgICAgICB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBhcnJheUNsYXNzIHx8IGZhbHNlOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgZmFsbGJhY2sgaW1wbGVtZW50YXRpb24gb2YgYE9iamVjdC5rZXlzYCB3aGljaCBwcm9kdWNlcyBhbiBhcnJheSBvZiB0aGUKICAgICAqIGdpdmVuIG9iamVjdCdzIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKi8KICAgIHZhciBzaGltS2V5cyA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBbXTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgaWYgKCEob2JqZWN0VHlwZXNbdHlwZW9mIG9iamVjdF0pKSByZXR1cm4gcmVzdWx0OwogICAgICAgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGl0ZXJhYmxlLCBpbmRleCkpIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgY29tcG9zZWQgb2YgdGhlIG93biBlbnVtZXJhYmxlIHByb3BlcnR5IG5hbWVzIG9mIGFuIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHByb3BlcnR5IG5hbWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmtleXMoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSk7CiAgICAgKiAvLyA9PiBbJ29uZScsICd0d28nLCAndGhyZWUnXSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgdmFyIGtleXMgPSAhbmF0aXZlS2V5cyA/IHNoaW1LZXlzIDogZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICByZXR1cm4gbmF0aXZlS2V5cyhvYmplY3QpOwogICAgfTsKCiAgICAvKioKICAgICAqIFVzZWQgdG8gY29udmVydCBjaGFyYWN0ZXJzIHRvIEhUTUwgZW50aXRpZXM6CiAgICAgKgogICAgICogVGhvdWdoIHRoZSBgPmAgY2hhcmFjdGVyIGlzIGVzY2FwZWQgZm9yIHN5bW1ldHJ5LCBjaGFyYWN0ZXJzIGxpa2UgYD5gIGFuZCBgL2AKICAgICAqIGRvbid0IHJlcXVpcmUgZXNjYXBpbmcgaW4gSFRNTCBhbmQgaGF2ZSBubyBzcGVjaWFsIG1lYW5pbmcgdW5sZXNzIHRoZXkncmUgcGFydAogICAgICogb2YgYSB0YWcgb3IgYW4gdW5xdW90ZWQgYXR0cmlidXRlIHZhbHVlLgogICAgICogaHR0cDovL21hdGhpYXNieW5lbnMuYmUvbm90ZXMvYW1iaWd1b3VzLWFtcGVyc2FuZHMgKHVuZGVyICJzZW1pLXJlbGF0ZWQgZnVuIGZhY3QiKQogICAgICovCiAgICB2YXIgaHRtbEVzY2FwZXMgPSB7CiAgICAgICcmJzogJyZhbXA7JywKICAgICAgJzwnOiAnJmx0OycsCiAgICAgICc+JzogJyZndDsnLAogICAgICAnIic6ICcmcXVvdDsnLAogICAgICAiJyI6ICcmIzM5OycKICAgIH07CgogICAgLyoqIFVzZWQgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMgKi8KICAgIHZhciBodG1sVW5lc2NhcGVzID0gaW52ZXJ0KGh0bWxFc2NhcGVzKTsKCiAgICAvKiogVXNlZCB0byBtYXRjaCBIVE1MIGVudGl0aWVzIGFuZCBIVE1MIGNoYXJhY3RlcnMgKi8KICAgIHZhciByZUVzY2FwZWRIdG1sID0gUmVnRXhwKCcoJyArIGtleXMoaHRtbFVuZXNjYXBlcykuam9pbignfCcpICsgJyknLCAnZycpLAogICAgICAgIHJlVW5lc2NhcGVkSHRtbCA9IFJlZ0V4cCgnWycgKyBrZXlzKGh0bWxFc2NhcGVzKS5qb2luKCcnKSArICddJywgJ2cnKTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIEFzc2lnbnMgb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBvZiBzb3VyY2Ugb2JqZWN0KHMpIHRvIHRoZSBkZXN0aW5hdGlvbgogICAgICogb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMgd2lsbCBvdmVyd3JpdGUgcHJvcGVydHkgYXNzaWdubWVudHMgb2YgcHJldmlvdXMKICAgICAqIHNvdXJjZXMuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCB0byBwcm9kdWNlIHRoZQogICAgICogYXNzaWduZWQgdmFsdWVzLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdHdvCiAgICAgKiBhcmd1bWVudHM7IChvYmplY3RWYWx1ZSwgc291cmNlVmFsdWUpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGFsaWFzIGV4dGVuZAogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgYXNzaWduaW5nIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmFzc2lnbih7ICduYW1lJzogJ2ZyZWQnIH0sIHsgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnZnJlZCcsICdlbXBsb3llcic6ICdzbGF0ZScgfQogICAgICoKICAgICAqIHZhciBkZWZhdWx0cyA9IF8ucGFydGlhbFJpZ2h0KF8uYXNzaWduLCBmdW5jdGlvbihhLCBiKSB7CiAgICAgKiAgIHJldHVybiB0eXBlb2YgYSA9PSAndW5kZWZpbmVkJyA/IGIgOiBhOwogICAgICogfSk7CiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsgJ25hbWUnOiAnYmFybmV5JyB9OwogICAgICogZGVmYXVsdHMob2JqZWN0LCB7ICduYW1lJzogJ2ZyZWQnLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdiYXJuZXknLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0KICAgICAqLwogICAgdmFyIGFzc2lnbiA9IGZ1bmN0aW9uKG9iamVjdCwgc291cmNlLCBndWFyZCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmdzLmxlbmd0aDsKICAgICAgaWYgKGFyZ3NMZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2FyZ3NMZW5ndGggLSAyXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgdmFyIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGFyZ3NbLS1hcmdzTGVuZ3RoIC0gMV0sIGFyZ3NbYXJnc0xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAoYXJnc0xlbmd0aCA+IDIgJiYgdHlwZW9mIGFyZ3NbYXJnc0xlbmd0aCAtIDFdID09ICdmdW5jdGlvbicpIHsKICAgICAgICBjYWxsYmFjayA9IGFyZ3NbLS1hcmdzTGVuZ3RoXTsKICAgICAgfQogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgaXRlcmFibGUgPSBhcmdzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGl0ZXJhYmxlICYmIG9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHsKICAgICAgICB2YXIgb3duSW5kZXggPSAtMSwKICAgICAgICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdICYmIGtleXMoaXRlcmFibGUpLAogICAgICAgICAgICBsZW5ndGggPSBvd25Qcm9wcyA/IG93blByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK293bkluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayA/IGNhbGxiYWNrKHJlc3VsdFtpbmRleF0sIGl0ZXJhYmxlW2luZGV4XSkgOiBpdGVyYWJsZVtpbmRleF07CiAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGNsb25lIG9mIGB2YWx1ZWAuIElmIGBpc0RlZXBgIGlzIGB0cnVlYCBuZXN0ZWQgb2JqZWN0cyB3aWxsIGFsc28KICAgICAqIGJlIGNsb25lZCwgb3RoZXJ3aXNlIHRoZXkgd2lsbCBiZSBhc3NpZ25lZCBieSByZWZlcmVuY2UuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgY2xvbmVkIHZhbHVlcy4gSWYgdGhlCiAgICAgKiBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIGNsb25pbmcgd2lsbCBiZSBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzRGVlcD1mYWxzZV0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIHZhciBzaGFsbG93ID0gXy5jbG9uZShjaGFyYWN0ZXJzKTsKICAgICAqIHNoYWxsb3dbMF0gPT09IGNoYXJhY3RlcnNbMF07CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogdmFyIGRlZXAgPSBfLmNsb25lKGNoYXJhY3RlcnMsIHRydWUpOwogICAgICogZGVlcFswXSA9PT0gY2hhcmFjdGVyc1swXTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5taXhpbih7CiAgICAgKiAgICdjbG9uZSc6IF8ucGFydGlhbFJpZ2h0KF8uY2xvbmUsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgICAgcmV0dXJuIF8uaXNFbGVtZW50KHZhbHVlKSA/IHZhbHVlLmNsb25lTm9kZShmYWxzZSkgOiB1bmRlZmluZWQ7CiAgICAgKiAgIH0pCiAgICAgKiB9KTsKICAgICAqCiAgICAgKiB2YXIgY2xvbmUgPSBfLmNsb25lKGRvY3VtZW50LmJvZHkpOwogICAgICogY2xvbmUuY2hpbGROb2Rlcy5sZW5ndGg7CiAgICAgKiAvLyA9PiAwCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lKHZhbHVlLCBpc0RlZXAsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggIkNvbGxlY3Rpb25zIiBtZXRob2RzIHdpdGhvdXQgdXNpbmcgdGhlaXIgYGluZGV4YAogICAgICAvLyBhbmQgYGNvbGxlY3Rpb25gIGFyZ3VtZW50cyBmb3IgYGlzRGVlcGAgYW5kIGBjYWxsYmFja2AKICAgICAgaWYgKHR5cGVvZiBpc0RlZXAgIT0gJ2Jvb2xlYW4nICYmIGlzRGVlcCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gaXNEZWVwOwogICAgICAgIGlzRGVlcCA9IGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIGlzRGVlcCwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjbG9uZSBvZiBgdmFsdWVgLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUKICAgICAqIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIGNsb25lZCB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgCiAgICAgKiBjbG9uaW5nIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIGxvb3NlbHkgYmFzZWQgb24gdGhlIHN0cnVjdHVyZWQgY2xvbmUgYWxnb3JpdGhtLiBGdW5jdGlvbnMKICAgICAqIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kCiAgICAgKiBvYmplY3RzIGNyZWF0ZWQgYnkgY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIGRlZXAgPSBfLmNsb25lRGVlcChjaGFyYWN0ZXJzKTsKICAgICAqIGRlZXBbMF0gPT09IGNoYXJhY3RlcnNbMF07CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIHZhciB2aWV3ID0gewogICAgICogICAnbGFiZWwnOiAnZG9jcycsCiAgICAgKiAgICdub2RlJzogZWxlbWVudAogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgY2xvbmUgPSBfLmNsb25lRGVlcCh2aWV3LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICByZXR1cm4gXy5pc0VsZW1lbnQodmFsdWUpID8gdmFsdWUuY2xvbmVOb2RlKHRydWUpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKgogICAgICogY2xvbmUubm9kZSA9PSB2aWV3Lm5vZGU7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBjbG9uZURlZXAodmFsdWUsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBiYXNlQ2xvbmUodmFsdWUsIHRydWUsIHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nICYmIGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgdGhhdCBpbmhlcml0cyBmcm9tIHRoZSBnaXZlbiBgcHJvdG90eXBlYCBvYmplY3QuIElmIGEKICAgICAqIGBwcm9wZXJ0aWVzYCBvYmplY3QgaXMgcHJvdmlkZWQgaXRzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGFzc2lnbmVkCiAgICAgKiB0byB0aGUgY3JlYXRlZCBvYmplY3QuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvdG90eXBlIFRoZSBvYmplY3QgdG8gaW5oZXJpdCBmcm9tLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtwcm9wZXJ0aWVzXSBUaGUgcHJvcGVydGllcyB0byBhc3NpZ24gdG8gdGhlIG9iamVjdC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIG5ldyBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIFNoYXBlKCkgewogICAgICogICB0aGlzLnggPSAwOwogICAgICogICB0aGlzLnkgPSAwOwogICAgICogfQogICAgICoKICAgICAqIGZ1bmN0aW9uIENpcmNsZSgpIHsKICAgICAqICAgU2hhcGUuY2FsbCh0aGlzKTsKICAgICAqIH0KICAgICAqCiAgICAgKiBDaXJjbGUucHJvdG90eXBlID0gXy5jcmVhdGUoU2hhcGUucHJvdG90eXBlLCB7ICdjb25zdHJ1Y3Rvcic6IENpcmNsZSB9KTsKICAgICAqCiAgICAgKiB2YXIgY2lyY2xlID0gbmV3IENpcmNsZTsKICAgICAqIGNpcmNsZSBpbnN0YW5jZW9mIENpcmNsZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBjaXJjbGUgaW5zdGFuY2VvZiBTaGFwZTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlKHByb3RvdHlwZSwgcHJvcGVydGllcykgewogICAgICB2YXIgcmVzdWx0ID0gYmFzZUNyZWF0ZShwcm90b3R5cGUpOwogICAgICByZXR1cm4gcHJvcGVydGllcyA/IGFzc2lnbihyZXN1bHQsIHByb3BlcnRpZXMpIDogcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBvYmplY3QgZm9yIGFsbCBkZXN0aW5hdGlvbiBwcm9wZXJ0aWVzIHRoYXQgcmVzb2x2ZSB0byBgdW5kZWZpbmVkYC4gT25jZSBhCiAgICAgKiBwcm9wZXJ0eSBpcyBzZXQsIGFkZGl0aW9uYWwgZGVmYXVsdHMgb2YgdGhlIHNhbWUgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gQWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIHdpdGhvdXQgdXNpbmcgaXRzCiAgICAgKiAgYGtleWAgYW5kIGBvYmplY3RgIGFyZ3VtZW50cyBhcyBzb3VyY2VzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdiYXJuZXknIH07CiAgICAgKiBfLmRlZmF1bHRzKG9iamVjdCwgeyAnbmFtZSc6ICdmcmVkJywgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFybmV5JywgJ2VtcGxveWVyJzogJ3NsYXRlJyB9CiAgICAgKi8KICAgIHZhciBkZWZhdWx0cyA9IGZ1bmN0aW9uKG9iamVjdCwgc291cmNlLCBndWFyZCkgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gb2JqZWN0LCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IHR5cGVvZiBndWFyZCA9PSAnbnVtYmVyJyA/IDIgOiBhcmdzLmxlbmd0aDsKICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIGl0ZXJhYmxlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGlmIChpdGVyYWJsZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSB7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdFtpbmRleF0gPT0gJ3VuZGVmaW5lZCcpIHJlc3VsdFtpbmRleF0gPSBpdGVyYWJsZVtpbmRleF07CiAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kSW5kZXhgIGV4Y2VwdCB0aGF0IGl0IHJldHVybnMgdGhlIGtleSBvZiB0aGUKICAgICAqIGZpcnN0IGVsZW1lbnQgdGhhdCBwYXNzZXMgdGhlIGNhbGxiYWNrIGNoZWNrLCBpbnN0ZWFkIG9mIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2Jhcm5leSc6IHsgICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiBmYWxzZSB9LAogICAgICogICAnZnJlZCc6IHsgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZmluZEtleShjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsKICAgICAqICAgcmV0dXJuIGNoci5hZ2UgPCA0MDsKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2Jhcm5leScgKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kS2V5KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDEgfSk7CiAgICAgKiAvLyA9PiAncGViYmxlcycKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmRLZXkoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKTsKICAgICAqIC8vID0+ICdmcmVkJwogICAgICovCiAgICBmdW5jdGlvbiBmaW5kS2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRLZXlgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2Jhcm5leSc6IHsgICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiB0cnVlIH0sCiAgICAgKiAgICdmcmVkJzogeyAgICAnYWdlJzogNDAsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiB0cnVlIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5maW5kTGFzdEtleShjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsKICAgICAqICAgcmV0dXJuIGNoci5hZ2UgPCA0MDsKICAgICAqIH0pOwogICAgICogLy8gPT4gcmV0dXJucyBgcGViYmxlc2AsIGFzc3VtaW5nIGBfLmZpbmRLZXlgIHJldHVybnMgYGJhcm5leWAKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmRMYXN0S2V5KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDQwIH0pOwogICAgICogLy8gPT4gJ2ZyZWQnCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kTGFzdEtleShjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gJ3BlYmJsZXMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRMYXN0S2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd25SaWdodChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICByZXN1bHQgPSBrZXk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgb3duIGFuZCBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGFuIG9iamVjdCwKICAgICAqIGV4ZWN1dGluZyB0aGUgY2FsbGJhY2sgZm9yIGVhY2ggcHJvcGVydHkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AKICAgICAqIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0CiAgICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIGZ1bmN0aW9uIFNoYXBlKCkgewogICAgICogICB0aGlzLnggPSAwOwogICAgICogICB0aGlzLnkgPSAwOwogICAgICogfQogICAgICoKICAgICAqIFNoYXBlLnByb3RvdHlwZS5tb3ZlID0gZnVuY3Rpb24oeCwgeSkgewogICAgICogICB0aGlzLnggKz0geDsKICAgICAqICAgdGhpcy55ICs9IHk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW4obmV3IFNoYXBlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ3gnLCAneScsIGFuZCAnbW92ZScgKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKi8KICAgIHZhciBmb3JJbiA9IGZ1bmN0aW9uKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBjb2xsZWN0aW9uLCByZXN1bHQgPSBpdGVyYWJsZTsKICAgICAgaWYgKCFpdGVyYWJsZSkgcmV0dXJuIHJlc3VsdDsKICAgICAgaWYgKCFvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSByZXR1cm4gcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIGZvciAoaW5kZXggaW4gaXRlcmFibGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhpdGVyYWJsZVtpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5mb3JJbmAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgaW4gdGhlIG9wcG9zaXRlIG9yZGVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBTaGFwZSgpIHsKICAgICAqICAgdGhpcy54ID0gMDsKICAgICAqICAgdGhpcy55ID0gMDsKICAgICAqIH0KICAgICAqCiAgICAgKiBTaGFwZS5wcm90b3R5cGUubW92ZSA9IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAqICAgdGhpcy54ICs9IHg7CiAgICAgKiAgIHRoaXMueSArPSB5OwogICAgICogfTsKICAgICAqCiAgICAgKiBfLmZvckluUmlnaHQobmV3IFNoYXBlLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ21vdmUnLCAneScsIGFuZCAneCcgYXNzdW1pbmcgYF8uZm9ySW4gYCBsb2dzICd4JywgJ3knLCBhbmQgJ21vdmUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckluUmlnaHQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcGFpcnMgPSBbXTsKCiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHBhaXJzLnB1c2goa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBpZiAoY2FsbGJhY2socGFpcnNbbGVuZ3RoLS1dLCBwYWlyc1tsZW5ndGhdLCBvYmplY3QpID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LCBleGVjdXRpbmcgdGhlIGNhbGxiYWNrCiAgICAgKiBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5CiAgICAgKiBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mb3JPd24oeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9yT3duID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIW9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHJldHVybiByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yT3duYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yT3duUmlnaHQoeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnbGVuZ3RoJywgJzEnLCBhbmQgJzAnIGFzc3VtaW5nIGBfLmZvck93bmAgbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvck93blJpZ2h0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbbGVuZ3RoXTsKICAgICAgICBpZiAoY2FsbGJhY2sob2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLAogICAgICogb3duIGFuZCBpbmhlcml0ZWQsIG9mIGBvYmplY3RgIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBtZXRob2RzCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mdW5jdGlvbnMoXyk7CiAgICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgICAqLwogICAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIHByb3BlcnR5IG5hbWUgZXhpc3RzIGFzIGEgZGlyZWN0IHByb3BlcnR5IG9mIGBvYmplY3RgLAogICAgICogaW5zdGVhZCBvZiBhbiBpbmhlcml0ZWQgcHJvcGVydHkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIG5hbWUgb2YgdGhlIHByb3BlcnR5IHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaGFzKG9iamVjdCwga2V5KSB7CiAgICAgIHJldHVybiBvYmplY3QgPyBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSA6IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGludmVydGVkIGtleXMgYW5kIHZhbHVlcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGludmVydC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNyZWF0ZWQgaW52ZXJ0ZWQgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludmVydCh7ICdmaXJzdCc6ICdmcmVkJywgJ3NlY29uZCc6ICdiYXJuZXknIH0pOwogICAgICogLy8gPT4geyAnZnJlZCc6ICdmaXJzdCcsICdiYXJuZXknOiAnc2Vjb25kJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIGludmVydChvYmplY3QpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IHt9OwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICAgIHJlc3VsdFtvYmplY3Rba2V5XV0gPSBrZXk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgYm9vbGVhbiB2YWx1ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzQm9vbGVhbihudWxsKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQm9vbGVhbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRydWUgfHwgdmFsdWUgPT09IGZhbHNlIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGJvb2xDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZGF0ZS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZGF0ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRGF0ZShuZXcgRGF0ZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRGF0ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGRhdGVDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgRE9NIGVsZW1lbnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbGVtZW50KGRvY3VtZW50LmJvZHkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VsZW1lbnQodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICYmIHZhbHVlLm5vZGVUeXBlID09PSAxIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgZW1wdHkuIEFycmF5cywgc3RyaW5ncywgb3IgYGFyZ3VtZW50c2Agb2JqZWN0cyB3aXRoIGEKICAgICAqIGxlbmd0aCBvZiBgMGAgYW5kIG9iamVjdHMgd2l0aCBubyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIGFyZSBjb25zaWRlcmVkCiAgICAgKiAiZW1wdHkiLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBlbXB0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0VtcHR5KHt9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoJycpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VtcHR5KHZhbHVlKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbCh2YWx1ZSksCiAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CgogICAgICBpZiAoKGNsYXNzTmFtZSA9PSBhcnJheUNsYXNzIHx8IGNsYXNzTmFtZSA9PSBzdHJpbmdDbGFzcyB8fCBjbGFzc05hbWUgPT0gYXJnc0NsYXNzICkgfHwKICAgICAgICAgIChjbGFzc05hbWUgPT0gb2JqZWN0Q2xhc3MgJiYgdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyAmJiBpc0Z1bmN0aW9uKHZhbHVlLnNwbGljZSkpKSB7CiAgICAgICAgcmV0dXJuICFsZW5ndGg7CiAgICAgIH0KICAgICAgZm9yT3duKHZhbHVlLCBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKHJlc3VsdCA9IGZhbHNlKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBiZXR3ZWVuIHR3byB2YWx1ZXMgdG8gZGV0ZXJtaW5lIGlmIHRoZXkgYXJlCiAgICAgKiBlcXVpdmFsZW50IHRvIGVhY2ggb3RoZXIuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZAogICAgICogdG8gY29tcGFyZSB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIGNvbXBhcmlzb25zIHdpbGwKICAgICAqIGJlIGhhbmRsZWQgYnkgdGhlIG1ldGhvZCBpbnN0ZWFkLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAgICogaW52b2tlZCB3aXRoIHR3byBhcmd1bWVudHM7IChhLCBiKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gYSBUaGUgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7Kn0gYiBUaGUgb3RoZXIgdmFsdWUgdG8gY29tcGFyZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBjb21wYXJpbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdmcmVkJyB9OwogICAgICogdmFyIGNvcHkgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKgogICAgICogb2JqZWN0ID09IGNvcHk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNFcXVhbChvYmplY3QsIGNvcHkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIHZhciB3b3JkcyA9IFsnaGVsbG8nLCAnZ29vZGJ5ZSddOwogICAgICogdmFyIG90aGVyV29yZHMgPSBbJ2hpJywgJ2dvb2RieWUnXTsKICAgICAqCiAgICAgKiBfLmlzRXF1YWwod29yZHMsIG90aGVyV29yZHMsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgdmFyIHJlR3JlZXQgPSAvXig/OmhlbGxvfGhpKSQvaSwKICAgICAqICAgICAgIGFHcmVldCA9IF8uaXNTdHJpbmcoYSkgJiYgcmVHcmVldC50ZXN0KGEpLAogICAgICogICAgICAgYkdyZWV0ID0gXy5pc1N0cmluZyhiKSAmJiByZUdyZWV0LnRlc3QoYik7CiAgICAgKgogICAgICogICByZXR1cm4gKGFHcmVldCB8fCBiR3JlZXQpID8gKGFHcmVldCA9PSBiR3JlZXQpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRXF1YWwoYSwgYiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsKGEsIGIsIHR5cGVvZiBjYWxsYmFjayA9PSAnZnVuY3Rpb24nICYmIGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMikpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMsIG9yIGNhbiBiZSBjb2VyY2VkIHRvLCBhIGZpbml0ZSBudW1iZXIuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc0Zpbml0ZWAgd2hpY2ggd2lsbCByZXR1cm4gdHJ1ZSBmb3IKICAgICAqIGJvb2xlYW5zIGFuZCBlbXB0eSBzdHJpbmdzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xLjIuNS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGZpbml0ZSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKC0xMDEpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoJzEwJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSh0cnVlKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSgnJyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoSW5maW5pdHkpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNGaW5pdGUodmFsdWUpIHsKICAgICAgcmV0dXJuIG5hdGl2ZUlzRmluaXRlKHZhbHVlKSAmJiAhbmF0aXZlSXNOYU4ocGFyc2VGbG9hdCh2YWx1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgZnVuY3Rpb24sIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Z1bmN0aW9uKF8pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ2Z1bmN0aW9uJzsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIHRoZSBsYW5ndWFnZSB0eXBlIG9mIE9iamVjdC4KICAgICAqIChlLmcuIGFycmF5cywgZnVuY3Rpb25zLCBvYmplY3RzLCByZWdleGVzLCBgbmV3IE51bWJlcigwKWAsIGFuZCBgbmV3IFN0cmluZygnJylgKQogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNPYmplY3Qoe30pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNPYmplY3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KDEpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsKICAgICAgLy8gY2hlY2sgaWYgdGhlIHZhbHVlIGlzIHRoZSBFQ01BU2NyaXB0IGxhbmd1YWdlIHR5cGUgb2YgT2JqZWN0CiAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4OAogICAgICAvLyBhbmQgYXZvaWQgYSBWOCBidWcKICAgICAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9MjI5MQogICAgICByZXR1cm4gISEodmFsdWUgJiYgb2JqZWN0VHlwZXNbdHlwZW9mIHZhbHVlXSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgTmFOYC4KICAgICAqCiAgICAgKiBOb3RlOiBUaGlzIGlzIG5vdCB0aGUgc2FtZSBhcyBuYXRpdmUgYGlzTmFOYCB3aGljaCB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yCiAgICAgKiBgdW5kZWZpbmVkYCBhbmQgb3RoZXIgbm9uLW51bWVyaWMgdmFsdWVzLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xLjIuNC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGBOYU5gLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOYU4oTmFOKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmFOKG5ldyBOdW1iZXIoTmFOKSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogaXNOYU4odW5kZWZpbmVkKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzTmFOKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc05hTih2YWx1ZSkgewogICAgICAvLyBgTmFOYCBhcyBhIHByaW1pdGl2ZSBpcyB0aGUgb25seSB2YWx1ZSB0aGF0IGlzIG5vdCBlcXVhbCB0byBpdHNlbGYKICAgICAgLy8gKHBlcmZvcm0gdGhlIFtbQ2xhc3NdXSBjaGVjayBmaXJzdCB0byBhdm9pZCBlcnJvcnMgd2l0aCBzb21lIGhvc3Qgb2JqZWN0cyBpbiBJRSkKICAgICAgcmV0dXJuIGlzTnVtYmVyKHZhbHVlKSAmJiB2YWx1ZSAhPSArdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgbnVsbGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgbnVsbGAsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc051bGwobnVsbCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc051bGwodW5kZWZpbmVkKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzTnVsbCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIG51bWJlci4KICAgICAqCiAgICAgKiBOb3RlOiBgTmFOYCBpcyBjb25zaWRlcmVkIGEgbnVtYmVyLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3g4LjUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIG51bWJlciwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTnVtYmVyKDguNCAqIDUpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bWJlcih2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG51bWJlckNsYXNzIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYW4gb2JqZWN0IGNyZWF0ZWQgYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgYHZhbHVlYCBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBmdW5jdGlvbiBTaGFwZSgpIHsKICAgICAqICAgdGhpcy54ID0gMDsKICAgICAqICAgdGhpcy55ID0gMDsKICAgICAqIH0KICAgICAqCiAgICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFNoYXBlKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNQbGFpbk9iamVjdCh7ICd4JzogMCwgJ3knOiAwIH0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICB2YXIgaXNQbGFpbk9iamVjdCA9ICFnZXRQcm90b3R5cGVPZiA/IHNoaW1Jc1BsYWluT2JqZWN0IDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKCEodmFsdWUgJiYgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gb2JqZWN0Q2xhc3MpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHZhciB2YWx1ZU9mID0gdmFsdWUudmFsdWVPZiwKICAgICAgICAgIG9ialByb3RvID0gaXNOYXRpdmUodmFsdWVPZikgJiYgKG9ialByb3RvID0gZ2V0UHJvdG90eXBlT2YodmFsdWVPZikpICYmIGdldFByb3RvdHlwZU9mKG9ialByb3RvKTsKCiAgICAgIHJldHVybiBvYmpQcm90bwogICAgICAgID8gKHZhbHVlID09IG9ialByb3RvIHx8IGdldFByb3RvdHlwZU9mKHZhbHVlKSA9PSBvYmpQcm90bykKICAgICAgICA6IHNoaW1Jc1BsYWluT2JqZWN0KHZhbHVlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGEgcmVndWxhciBleHByZXNzaW9uLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNSZWdFeHAoL2ZyZWQvKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1N0cmluZygnZnJlZCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc1N0cmluZyh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdzdHJpbmcnIHx8CiAgICAgICAgdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IHN0cmluZ0NsYXNzIHx8IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYHVuZGVmaW5lZGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzVW5kZWZpbmVkKHZvaWQgMCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzVW5kZWZpbmVkKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3VuZGVmaW5lZCc7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCB3aXRoIHRoZSBzYW1lIGtleXMgYXMgYG9iamVjdGAgYW5kIHZhbHVlcyBnZW5lcmF0ZWQgYnkKICAgICAqIHJ1bm5pbmcgZWFjaCBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSBvZiBgb2JqZWN0YCB0aHJvdWdoIHRoZSBjYWxsYmFjay4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgb2JqZWN0IHdpdGggdmFsdWVzIG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWFwVmFsdWVzKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogM30gLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAgICogLy8gPT4geyAnYSc6IDMsICdiJzogNiwgJ2MnOiA5IH0KICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IHsKICAgICAqICAgJ2ZyZWQnOiB7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfSwKICAgICAqICAgJ3BlYmJsZXMnOiB7ICduYW1lJzogJ3BlYmJsZXMnLCAnYWdlJzogMSB9CiAgICAgKiB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWFwVmFsdWVzKGNoYXJhY3RlcnMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ2ZyZWQnOiA0MCwgJ3BlYmJsZXMnOiAxIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWFwVmFsdWVzKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVjdXJzaXZlbHkgbWVyZ2VzIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgdGhlIHNvdXJjZSBvYmplY3QocyksIHRoYXQKICAgICAqIGRvbid0IHJlc29sdmUgdG8gYHVuZGVmaW5lZGAgaW50byB0aGUgZGVzdGluYXRpb24gb2JqZWN0LiBTdWJzZXF1ZW50IHNvdXJjZXMKICAgICAqIHdpbGwgb3ZlcndyaXRlIHByb3BlcnR5IGFzc2lnbm1lbnRzIG9mIHByZXZpb3VzIHNvdXJjZXMuIElmIGEgY2FsbGJhY2sgaXMKICAgICAqIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgdG8gcHJvZHVjZSB0aGUgbWVyZ2VkIHZhbHVlcyBvZiB0aGUgZGVzdGluYXRpb24KICAgICAqIGFuZCBzb3VyY2UgcHJvcGVydGllcy4gSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgbWVyZ2luZyB3aWxsCiAgICAgKiBiZSBoYW5kbGVkIGJ5IHRoZSBtZXRob2QgaW5zdGVhZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0d28gYXJndW1lbnRzOyAob2JqZWN0VmFsdWUsIHNvdXJjZVZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIGRlc3RpbmF0aW9uIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Li4uT2JqZWN0fSBbc291cmNlXSBUaGUgc291cmNlIG9iamVjdHMuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgbWVyZ2luZyBwcm9wZXJ0aWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBuYW1lcyA9IHsKICAgICAqICAgJ2NoYXJhY3RlcnMnOiBbCiAgICAgKiAgICAgeyAnbmFtZSc6ICdiYXJuZXknIH0sCiAgICAgKiAgICAgeyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKiAgIF0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGFnZXMgPSB7CiAgICAgKiAgICdjaGFyYWN0ZXJzJzogWwogICAgICogICAgIHsgJ2FnZSc6IDM2IH0sCiAgICAgKiAgICAgeyAnYWdlJzogNDAgfQogICAgICogICBdCiAgICAgKiB9OwogICAgICoKICAgICAqIF8ubWVyZ2UobmFtZXMsIGFnZXMpOwogICAgICogLy8gPT4geyAnY2hhcmFjdGVycyc6IFt7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LCB7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfV0gfQogICAgICoKICAgICAqIHZhciBmb29kID0gewogICAgICogICAnZnJ1aXRzJzogWydhcHBsZSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnYmVldCddCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBvdGhlckZvb2QgPSB7CiAgICAgKiAgICdmcnVpdHMnOiBbJ2JhbmFuYSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnY2Fycm90J10KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShmb29kLCBvdGhlckZvb2QsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgcmV0dXJuIF8uaXNBcnJheShhKSA/IGEuY29uY2F0KGIpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdmcnVpdHMnOiBbJ2FwcGxlJywgJ2JhbmFuYSddLCAndmVnZXRhYmxlcyc6IFsnYmVldCcsICdjYXJyb3RdIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0KSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gMjsKCiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0KICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIGFuZCBgXy5yZWR1Y2VSaWdodGAgd2l0aG91dCB1c2luZwogICAgICAvLyB0aGVpciBgaW5kZXhgIGFuZCBgY29sbGVjdGlvbmAgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgYXJnc1syXSAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2xlbmd0aCAtIDJdID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soYXJnc1stLWxlbmd0aCAtIDFdLCBhcmdzW2xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiB0eXBlb2YgYXJnc1tsZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tbGVuZ3RoXTsKICAgICAgfQogICAgICB2YXIgc291cmNlcyA9IHNsaWNlKGFyZ3VtZW50cywgMSwgbGVuZ3RoKSwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBzdGFja0EgPSBnZXRBcnJheSgpLAogICAgICAgICAgc3RhY2tCID0gZ2V0QXJyYXkoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgYmFzZU1lcmdlKG9iamVjdCwgc291cmNlc1tpbmRleF0sIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQik7CiAgICAgIH0KICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQSk7CiAgICAgIHJlbGVhc2VBcnJheShzdGFja0IpOwogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgZXhjbHVkaW5nIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4KICAgICAqIFByb3BlcnR5IG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzIG9mCiAgICAgKiBwcm9wZXJ0eSBuYW1lcy4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIGZvciBlYWNoCiAgICAgKiBwcm9wZXJ0eSBvZiBgb2JqZWN0YCBvbWl0dGluZyB0aGUgcHJvcGVydGllcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleQogICAgICogZm9yLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnwuLi5zdHJpbmd8c3RyaW5nW119IFtjYWxsYmFja10gVGhlIHByb3BlcnRpZXMgdG8gb21pdCBvciB0aGUKICAgICAqICBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3Qgd2l0aG91dCB0aGUgb21pdHRlZCBwcm9wZXJ0aWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm9taXQoeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH0sICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnZnJlZCcgfQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIG9taXQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBwcm9wcyA9IFtdOwogICAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgICAgcHJvcHMucHVzaChrZXkpOwogICAgICAgIH0pOwogICAgICAgIHByb3BzID0gYmFzZURpZmZlcmVuY2UocHJvcHMsIGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgZmFsc2UsIDEpKTsKCiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgICByZXN1bHRba2V5XSA9IG9iamVjdFtrZXldOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIGlmICghY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgdHdvIGRpbWVuc2lvbmFsIGFycmF5IG9mIGFuIG9iamVjdCdzIGtleS12YWx1ZSBwYWlycywKICAgICAqIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIG5ldyBhcnJheSBvZiBrZXktdmFsdWUgcGFpcnMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFpcnMoeyAnYmFybmV5JzogMzYsICdmcmVkJzogNDAgfSk7CiAgICAgKiAvLyA9PiBbWydiYXJuZXknLCAzNl0sIFsnZnJlZCcsIDQwXV0gKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhaXJzKG9iamVjdCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gW2tleSwgb2JqZWN0W2tleV1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBjb21wb3NlZCBvZiB0aGUgc3BlY2lmaWVkIHByb3BlcnRpZXMuCiAgICAgKiBQcm9wZXJ0eSBuYW1lcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cyBvZgogICAgICogcHJvcGVydHkgbmFtZXMuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IgZWFjaAogICAgICogcHJvcGVydHkgb2YgYG9iamVjdGAgcGlja2luZyB0aGUgcHJvcGVydGllcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleQogICAgICogZm9yLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBzb3VyY2Ugb2JqZWN0LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnwuLi5zdHJpbmd8c3RyaW5nW119IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24gb3IgcHJvcGVydHkgbmFtZXMgdG8gcGljaywgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgcHJvcGVydHkKICAgICAqICBuYW1lcyBvciBhcnJheXMgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBwaWNrZWQgcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5waWNrKHsgJ25hbWUnOiAnZnJlZCcsICdfdXNlcmlkJzogJ2ZyZWQxJyB9LCAnbmFtZScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKgogICAgICogXy5waWNrKHsgJ25hbWUnOiAnZnJlZCcsICdfdXNlcmlkJzogJ2ZyZWQxJyB9LCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIHJldHVybiBrZXkuY2hhckF0KDApICE9ICdfJzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJyB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBpY2sob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0ID0ge307CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBwcm9wcyA9IGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgZmFsc2UsIDEpLAogICAgICAgICAgICBsZW5ndGggPSBpc09iamVjdChvYmplY3QpID8gcHJvcHMubGVuZ3RoIDogMDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgICBpZiAoa2V5IGluIG9iamVjdCkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IG9iamVjdFtrZXldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgZm9ySW4ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpKSB7CiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEFuIGFsdGVybmF0aXZlIHRvIGBfLnJlZHVjZWAgdGhpcyBtZXRob2QgdHJhbnNmb3JtcyBgb2JqZWN0YCB0byBhIG5ldwogICAgICogYGFjY3VtdWxhdG9yYCBvYmplY3Qgd2hpY2ggaXMgdGhlIHJlc3VsdCBvZiBydW5uaW5nIGVhY2ggb2YgaXRzIG93bgogICAgICogZW51bWVyYWJsZSBwcm9wZXJ0aWVzIHRocm91Z2ggYSBjYWxsYmFjaywgd2l0aCBlYWNoIGNhbGxiYWNrIGV4ZWN1dGlvbgogICAgICogcG90ZW50aWFsbHkgbXV0YXRpbmcgdGhlIGBhY2N1bXVsYXRvcmAgb2JqZWN0LiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8KICAgICAqIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBrZXksIG9iamVjdCkuCiAgICAgKiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5IGV4cGxpY2l0bHkgcmV0dXJuaW5nIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gVGhlIGN1c3RvbSBhY2N1bXVsYXRvciB2YWx1ZS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGFjY3VtdWxhdGVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3F1YXJlcyA9IF8udHJhbnNmb3JtKFsxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAxMF0sIGZ1bmN0aW9uKHJlc3VsdCwgbnVtKSB7CiAgICAgKiAgIG51bSAqPSBudW07CiAgICAgKiAgIGlmIChudW0gJSAyKSB7CiAgICAgKiAgICAgcmV0dXJuIHJlc3VsdC5wdXNoKG51bSkgPCAzOwogICAgICogICB9CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsxLCA5LCAyNV0KICAgICAqCiAgICAgKiB2YXIgbWFwcGVkID0gXy50cmFuc2Zvcm0oeyAnYSc6IDEsICdiJzogMiwgJ2MnOiAzIH0sIGZ1bmN0aW9uKHJlc3VsdCwgbnVtLCBrZXkpIHsKICAgICAqICAgcmVzdWx0W2tleV0gPSBudW0gKiAzOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiB0cmFuc2Zvcm0ob2JqZWN0LCBjYWxsYmFjaywgYWNjdW11bGF0b3IsIHRoaXNBcmcpIHsKICAgICAgdmFyIGlzQXJyID0gaXNBcnJheShvYmplY3QpOwogICAgICBpZiAoYWNjdW11bGF0b3IgPT0gbnVsbCkgewogICAgICAgIGlmIChpc0FycikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBbXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGN0b3IgPSBvYmplY3QgJiYgb2JqZWN0LmNvbnN0cnVjdG9yLAogICAgICAgICAgICAgIHByb3RvID0gY3RvciAmJiBjdG9yLnByb3RvdHlwZTsKCiAgICAgICAgICBhY2N1bXVsYXRvciA9IGJhc2VDcmVhdGUocHJvdG8pOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CiAgICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgdmFsdWVzIG9mIGBvYmplY3RgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnZhbHVlcyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IFsxLCAyLCAzXSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgZnVuY3Rpb24gdmFsdWVzKG9iamVjdCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IG9iamVjdFtwcm9wc1tpbmRleF1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzIGZyb20gdGhlIHNwZWNpZmllZCBpbmRleGVzLCBvciBrZXlzLCBvZiB0aGUKICAgICAqIGBjb2xsZWN0aW9uYC4gSW5kZXhlcyBtYXkgYmUgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgYXJndW1lbnRzIG9yIGFzIGFycmF5cwogICAgICogb2YgaW5kZXhlcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsuLi4obnVtYmVyfG51bWJlcltdfHN0cmluZ3xzdHJpbmdbXSl9IFtpbmRleF0gVGhlIGluZGV4ZXMgb2YgYGNvbGxlY3Rpb25gCiAgICAgKiAgIHRvIHJldHJpZXZlLCBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBpbmRleGVzIG9yIGFycmF5cyBvZiBpbmRleGVzLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIGNvcnJlc3BvbmRpbmcgdG8gdGhlCiAgICAgKiAgcHJvdmlkZWQgaW5kZXhlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5hdChbJ2EnLCAnYicsICdjJywgJ2QnLCAnZSddLCBbMCwgMiwgNF0pOwogICAgICogLy8gPT4gWydhJywgJ2MnLCAnZSddCiAgICAgKgogICAgICogXy5hdChbJ2ZyZWQnLCAnYmFybmV5JywgJ3BlYmJsZXMnXSwgMCwgMik7CiAgICAgKiAvLyA9PiBbJ2ZyZWQnLCAncGViYmxlcyddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGF0KGNvbGxlY3Rpb24pIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmdzLCB0cnVlLCBmYWxzZSwgMSksCiAgICAgICAgICBsZW5ndGggPSAoYXJnc1syXSAmJiBhcmdzWzJdW2FyZ3NbMV1dID09PSBjb2xsZWN0aW9uKSA/IDEgOiBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBjb2xsZWN0aW9uW3Byb3BzW2luZGV4XV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBhIGdpdmVuIHZhbHVlIGlzIHByZXNlbnQgaW4gYSBjb2xsZWN0aW9uIHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiBgZnJvbUluZGV4YCBpcyBuZWdhdGl2ZSwgaXQgaXMgdXNlZCBhcyB0aGUKICAgICAqIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBpbmNsdWRlCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0geyp9IHRhcmdldCBUaGUgdmFsdWUgdG8gY2hlY2sgZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9MF0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdGFyZ2V0YCBlbGVtZW50IGlzIGZvdW5kLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29udGFpbnMoWzEsIDIsIDNdLCAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSwgMik7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uY29udGFpbnMoeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH0sICdmcmVkJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5jb250YWlucygncGViYmxlcycsICdlYicpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHJlc3VsdCA9IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpID4gLTE7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHJlc3VsdCA9IChpc1N0cmluZyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSkgPiAtMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICgrK2luZGV4ID49IGZyb21JbmRleCkgewogICAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IHdhcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2suCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiAyLCAnNSc6IDEgfQogICAgICovCiAgICB2YXIgY291bnRCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YKICAgICAqIGEgY29sbGVjdGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGFsbAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ldmVyeShjaGFyYWN0ZXJzLCAnYWdlJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ldmVyeShjaGFyYWN0ZXJzLCB7ICdhZ2UnOiAzNiB9KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGV2ZXJ5KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSAhIWNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gKHJlc3VsdCA9ICEhY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEl0ZXJhdGVzIG92ZXIgZWxlbWVudHMgb2YgYSBjb2xsZWN0aW9uLCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzCiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBzZWxlY3QKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBlbGVtZW50cyB0aGF0IHBhc3NlZCB0aGUgY2FsbGJhY2sgY2hlY2suCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBldmVucyA9IF8uZmlsdGVyKFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzIsIDQsIDZdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbHRlcihjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCwgJ2Jsb2NrZWQnOiB0cnVlIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maWx0ZXIoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyB0aGUgZmlyc3QgZWxlbWVudCB0aGF0CiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkZXRlY3QsIGZpbmRXaGVyZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2FnZSc6IDEsICAnYmxvY2tlZCc6IGZhbHNlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5maW5kKGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA8IDQwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiwgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kKGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDEgfSk7CiAgICAgKiAvLyA9PiAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2FnZSc6IDEsICdibG9ja2VkJzogZmFsc2UgfQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0KFsxLCAyLCAzLCA0XSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gJSAyID09IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDMKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3QoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVsZW1lbnRzIG9mIGEgY29sbGVjdGlvbiwgZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaAogICAgICogZWxlbWVudC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieQogICAgICogZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBOb3RlOiBBcyB3aXRoIG90aGVyICJDb2xsZWN0aW9ucyIgbWV0aG9kcywgb2JqZWN0cyB3aXRoIGEgYGxlbmd0aGAgcHJvcGVydHkKICAgICAqIGFyZSBpdGVyYXRlZCBsaWtlIGFycmF5cy4gVG8gYXZvaWQgdGhpcyBiZWhhdmlvciBgXy5mb3JJbmAgb3IgYF8uZm9yT3duYAogICAgICogbWF5IGJlIHVzZWQgZm9yIG9iamVjdCBpdGVyYXRpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBlYWNoCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxzdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzXSkuZm9yRWFjaChmdW5jdGlvbihudW0pIHsgY29uc29sZS5sb2cobnVtKTsgfSkuam9pbignLCcpOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBhbmQgcmV0dXJucyAnMSwyLDMnCiAgICAgKgogICAgICogXy5mb3JFYWNoKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KTsKICAgICAqIC8vID0+IGxvZ3MgZWFjaCBudW1iZXIgYW5kIHJldHVybnMgdGhlIG9iamVjdCAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqLwogICAgZnVuY3Rpb24gZm9yRWFjaChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrICYmIHR5cGVvZiB0aGlzQXJnID09ICd1bmRlZmluZWQnID8gY2FsbGJhY2sgOiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBjYWxsYmFjayk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZvckVhY2hgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGZyb20gcmlnaHQgdG8gbGVmdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGVhY2hSaWdodAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheXxPYmplY3R8c3RyaW5nfSBSZXR1cm5zIGBjb2xsZWN0aW9uYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLmZvckVhY2hSaWdodChmdW5jdGlvbihudW0pIHsgY29uc29sZS5sb2cobnVtKTsgfSkuam9pbignLCcpOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBmcm9tIHJpZ2h0IHRvIGxlZnQgYW5kIHJldHVybnMgJzMsMiwxJwogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soY29sbGVjdGlvbltsZW5ndGhdLCBsZW5ndGgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHByb3BzID0ga2V5cyhjb2xsZWN0aW9uKTsKICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGg7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGtleSA9IHByb3BzID8gcHJvcHNbLS1sZW5ndGhdIDogLS1sZW5ndGg7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soY29sbGVjdGlvbltrZXldLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBjb2xsZWN0aW9uOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYSBjb2xsZWN0aW9uIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgYW4gYXJyYXkgb2YgdGhlIGVsZW1lbnRzIHJlc3BvbnNpYmxlIGZvciBnZW5lcmF0aW5nIHRoZSBrZXkuCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNvbXBvc2VkIGFnZ3JlZ2F0ZSBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5mbG9vcihudW0pOyB9KTsKICAgICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgICAqCiAgICAgKiBfLmdyb3VwQnkoWzQuMiwgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogWzQuMl0sICc2JzogWzYuMSwgNi40XSB9CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5ncm91cEJ5KFsnb25lJywgJ3R3bycsICd0aHJlZSddLCAnbGVuZ3RoJyk7CiAgICAgKiAvLyA9PiB7ICczJzogWydvbmUnLCAndHdvJ10sICc1JzogWyd0aHJlZSddIH0KICAgICAqLwogICAgdmFyIGdyb3VwQnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICAoaGFzT3duUHJvcGVydHkuY2FsbChyZXN1bHQsIGtleSkgPyByZXN1bHRba2V5XSA6IHJlc3VsdFtrZXldID0gW10pLnB1c2godmFsdWUpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiBrZXlzIGdlbmVyYXRlZCBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBvZiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBnaXZlbiBjYWxsYmFjay4gVGhlIGNvcnJlc3BvbmRpbmcKICAgICAqIHZhbHVlIG9mIGVhY2gga2V5IGlzIHRoZSBsYXN0IGVsZW1lbnQgcmVzcG9uc2libGUgZm9yIGdlbmVyYXRpbmcgdGhlIGtleS4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIGNvbXBvc2VkIGFnZ3JlZ2F0ZSBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBrZXlzID0gWwogICAgICogICB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwKICAgICAqICAgeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLmluZGV4Qnkoa2V5cywgJ2RpcicpOwogICAgICogLy8gPT4geyAnbGVmdCc6IHsgJ2Rpcic6ICdsZWZ0JywgJ2NvZGUnOiA5NyB9LCAncmlnaHQnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqCiAgICAgKiBfLmluZGV4Qnkoa2V5cywgZnVuY3Rpb24oa2V5KSB7IHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGtleS5jb2RlKTsgfSk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdkJzogeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfSB9CiAgICAgKgogICAgICogXy5pbmRleEJ5KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGtleSkgeyB0aGlzLmZyb21DaGFyQ29kZShrZXkuY29kZSk7IH0sIFN0cmluZyk7CiAgICAgKiAvLyA9PiB7ICdhJzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdkJzogeyAnZGlyJzogJ3JpZ2h0JywgJ2NvZGUnOiAxMDAgfSB9CiAgICAgKi8KICAgIHZhciBpbmRleEJ5ID0gY3JlYXRlQWdncmVnYXRvcihmdW5jdGlvbihyZXN1bHQsIHZhbHVlLCBrZXkpIHsKICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgIH0pOwoKICAgIC8qKgogICAgICogSW52b2tlcyB0aGUgbWV0aG9kIG5hbWVkIGJ5IGBtZXRob2ROYW1lYCBvbiBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYAogICAgICogcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICAgKiB3aWxsIGJlIHByb3ZpZGVkIHRvIGVhY2ggaW52b2tlZCBtZXRob2QuIElmIGBtZXRob2ROYW1lYCBpcyBhIGZ1bmN0aW9uIGl0CiAgICAgKiB3aWxsIGJlIGludm9rZWQgZm9yLCBhbmQgYHRoaXNgIGJvdW5kIHRvLCBlYWNoIGVsZW1lbnQgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxzdHJpbmd9IG1ldGhvZE5hbWUgVGhlIG5hbWUgb2YgdGhlIG1ldGhvZCB0byBpbnZva2Ugb3IKICAgICAqICB0aGUgZnVuY3Rpb24gaW52b2tlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBtZXRob2Qgd2l0aC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGludm9rZWQgbWV0aG9kLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludm9rZShbWzUsIDEsIDddLCBbMywgMiwgMV1dLCAnc29ydCcpOwogICAgICogLy8gPT4gW1sxLCA1LCA3XSwgWzEsIDIsIDNdXQogICAgICoKICAgICAqIF8uaW52b2tlKFsxMjMsIDQ1Nl0sIFN0cmluZy5wcm90b3R5cGUuc3BsaXQsICcnKTsKICAgICAqIC8vID0+IFtbJzEnLCAnMicsICczJ10sIFsnNCcsICc1JywgJzYnXV0KICAgICAqLwogICAgZnVuY3Rpb24gaW52b2tlKGNvbGxlY3Rpb24sIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGlzRnVuYyA9IHR5cGVvZiBtZXRob2ROYW1lID09ICdmdW5jdGlvbicsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IChpc0Z1bmMgPyBtZXRob2ROYW1lIDogdmFsdWVbbWV0aG9kTmFtZV0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHZhbHVlcyBieSBydW5uaW5nIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbgogICAgICogdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aAogICAgICogdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBjb2xsZWN0CiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5tYXAoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAqIDM7IH0pOwogICAgICogLy8gPT4gWzMsIDYsIDldCiAgICAgKgogICAgICogXy5tYXAoeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgICAqIC8vID0+IFszLCA2LCA5XSAocHJvcGVydHkgb3JkZXIgaXMgbm90IGd1YXJhbnRlZWQgYWNyb3NzIGVudmlyb25tZW50cykKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1hcChjaGFyYWN0ZXJzLCAnbmFtZScpOwogICAgICogLy8gPT4gWydiYXJuZXknLCAnZnJlZCddCiAgICAgKi8KICAgIGZ1bmN0aW9uIG1hcChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHJlc3VsdFtpbmRleF0gPSBjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICAgICAgcmVzdWx0WysraW5kZXhdID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgbWF4aW11bSB2YWx1ZSBvZiBhIGNvbGxlY3Rpb24uIElmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IG9yCiAgICAgKiBmYWxzZXkgYC1JbmZpbml0eWAgaXMgcmV0dXJuZWQuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZAogICAgICogZm9yIGVhY2ggdmFsdWUgaW4gdGhlIGNvbGxlY3Rpb24gdG8gZ2VuZXJhdGUgdGhlIGNyaXRlcmlvbiBieSB3aGljaCB0aGUgdmFsdWUKICAgICAqIGlzIHJhbmtlZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgbWF4aW11bSB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5tYXgoWzQsIDIsIDgsIDZdKTsKICAgICAqIC8vID0+IDgKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1heChjaGFyYWN0ZXJzLCBmdW5jdGlvbihjaHIpIHsgcmV0dXJuIGNoci5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5tYXgoY2hhcmFjdGVycywgJ2FnZScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwIH07CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1heChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgY29tcHV0ZWQgPSAtSW5maW5pdHksCiAgICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggZnVuY3Rpb25zIGxpa2UgYF8ubWFwYCB3aXRob3V0IHVzaW5nCiAgICAgIC8vIHRoZWlyIGBpbmRleGAgYXJndW1lbnQgYXMgYSBjYWxsYmFjawogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicgJiYgdGhpc0FyZyAmJiB0aGlzQXJnW2NhbGxiYWNrXSA9PT0gY29sbGVjdGlvbikgewogICAgICAgIGNhbGxiYWNrID0gbnVsbDsKICAgICAgfQogICAgICBpZiAoY2FsbGJhY2sgPT0gbnVsbCAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrID0gKGNhbGxiYWNrID09IG51bGwgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpCiAgICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgICA6IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgICBpZiAoY3VycmVudCA+IGNvbXB1dGVkKSB7CiAgICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgbWluaW11bSB2YWx1ZSBvZiBhIGNvbGxlY3Rpb24uIElmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5IG9yCiAgICAgKiBmYWxzZXkgYEluZmluaXR5YCBpcyByZXR1cm5lZC4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkCiAgICAgKiBmb3IgZWFjaCB2YWx1ZSBpbiB0aGUgY29sbGVjdGlvbiB0byBnZW5lcmF0ZSB0aGUgY3JpdGVyaW9uIGJ5IHdoaWNoIHRoZSB2YWx1ZQogICAgICogaXMgcmFua2VkLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBtaW5pbXVtIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLm1pbihbNCwgMiwgOCwgNl0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8ubWluKGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgeyByZXR1cm4gY2hyLmFnZTsgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzNiB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWluKGNoYXJhY3RlcnMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH07CiAgICAgKi8KICAgIGZ1bmN0aW9uIG1pbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgY29tcHV0ZWQgPSBJbmZpbml0eSwKICAgICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBmdW5jdGlvbnMgbGlrZSBgXy5tYXBgIHdpdGhvdXQgdXNpbmcKICAgICAgLy8gdGhlaXIgYGluZGV4YCBhcmd1bWVudCBhcyBhIGNhbGxiYWNrCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ2Z1bmN0aW9uJyAmJiB0aGlzQXJnICYmIHRoaXNBcmdbY2FsbGJhY2tdID09PSBjb2xsZWN0aW9uKSB7CiAgICAgICAgY2FsbGJhY2sgPSBudWxsOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayA9PSBudWxsICYmIGlzQXJyYXkoY29sbGVjdGlvbikpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbi5sZW5ndGg7CgogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb2xsZWN0aW9uW2luZGV4XTsKICAgICAgICAgIGlmICh2YWx1ZSA8IHJlc3VsdCkgewogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSAoY2FsbGJhY2sgPT0gbnVsbCAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkKICAgICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICAgIDogbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICAgIGlmIChjdXJyZW50IDwgY29tcHV0ZWQpIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSB2YWx1ZSBvZiBhIHNwZWNpZmllZCBwcm9wZXJ0eSBmcm9tIGFsbCBlbGVtZW50cyBpbiB0aGUgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgbmFtZSBvZiB0aGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLnBsdWNrKGNoYXJhY3RlcnMsICduYW1lJyk7CiAgICAgKiAvLyA9PiBbJ2Jhcm5leScsICdmcmVkJ10KICAgICAqLwogICAgdmFyIHBsdWNrID0gbWFwOwoKICAgIC8qKgogICAgICogUmVkdWNlcyBhIGNvbGxlY3Rpb24gdG8gYSB2YWx1ZSB3aGljaCBpcyB0aGUgYWNjdW11bGF0ZWQgcmVzdWx0IG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjaywgd2hlcmUgZWFjaCBzdWNjZXNzaXZlCiAgICAgKiBjYWxsYmFjayBleGVjdXRpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJldmlvdXMgZXhlY3V0aW9uLiBJZgogICAgICogYGFjY3VtdWxhdG9yYCBpcyBub3QgcHJvdmlkZWQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24gd2lsbCBiZQogICAgICogdXNlZCBhcyB0aGUgaW5pdGlhbCBgYWNjdW11bGF0b3JgIHZhbHVlLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICAgKiBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIHZhciBtYXBwZWQgPSBfLnJlZHVjZSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgZnVuY3Rpb24ocmVzdWx0LCBudW0sIGtleSkgewogICAgICogICByZXN1bHRba2V5XSA9IG51bSAqIDM7CiAgICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICAgKiB9LCB7fSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICBpZiAobm9hY2N1bSkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBub2FjY3VtCiAgICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnJlZHVjZWAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZHIKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAgICogdmFyIGZsYXQgPSBfLnJlZHVjZVJpZ2h0KGxpc3QsIGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEuY29uY2F0KGIpOyB9LCBbXSk7CiAgICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVkdWNlUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCA0KTsKICAgICAgZm9yRWFjaFJpZ2h0KGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSBlbGVtZW50cyBvZiBhCiAgICAgKiBjb2xsZWN0aW9uIHRoYXQgdGhlIGNhbGxiYWNrIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1ZXkgZm9yLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBmYWlsZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzEsIDMsIDVdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlamVjdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5yZWplY3QoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdmcmVkJywgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IHRydWUgfV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVqZWN0KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgcmV0dXJuIGZpbHRlcihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICByZXR1cm4gIWNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIGEgcmFuZG9tIGVsZW1lbnQgb3IgYG5gIHJhbmRvbSBlbGVtZW50cyBmcm9tIGEgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gc2FtcGxlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtuXSBUaGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBBbGxvd3Mgd29ya2luZyB3aXRoIGZ1bmN0aW9ucyBsaWtlIGBfLm1hcGAKICAgICAqICB3aXRob3V0IHVzaW5nIHRoZWlyIGBpbmRleGAgYXJndW1lbnRzIGFzIGBuYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZG9tIHNhbXBsZShzKSBvZiBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2FtcGxlKFsxLCAyLCAzLCA0XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zYW1wbGUoWzEsIDIsIDMsIDRdLCAyKTsKICAgICAqIC8vID0+IFszLCAxXQogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGUoY29sbGVjdGlvbiwgbiwgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoICE9ICdudW1iZXInKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlcyhjb2xsZWN0aW9uKTsKICAgICAgfQogICAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uW2Jhc2VSYW5kb20oMCwgY29sbGVjdGlvbi5sZW5ndGggLSAxKV0gOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHNodWZmbGUoY29sbGVjdGlvbik7CiAgICAgIHJlc3VsdC5sZW5ndGggPSBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCByZXN1bHQubGVuZ3RoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgdmFsdWVzLCB1c2luZyBhIHZlcnNpb24gb2YgdGhlIEZpc2hlci1ZYXRlcwogICAgICogc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgICAqLwogICAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgcmFuZCA9IGJhc2VSYW5kb20oMCwgKytpbmRleCk7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IHJlc3VsdFtyYW5kXTsKICAgICAgICByZXN1bHRbcmFuZF0gPSB2YWx1ZTsKICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBzaXplIG9mIHRoZSBgY29sbGVjdGlvbmAgYnkgcmV0dXJuaW5nIGBjb2xsZWN0aW9uLmxlbmd0aGAgZm9yIGFycmF5cwogICAgICogYW5kIGFycmF5LWxpa2Ugb2JqZWN0cyBvciB0aGUgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgZm9yIG9iamVjdHMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGBjb2xsZWN0aW9uLmxlbmd0aGAgb3IgbnVtYmVyIG9mIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2l6ZShbMSwgMl0pOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIF8uc2l6ZSh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IDMKICAgICAqCiAgICAgKiBfLnNpemUoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+IDcKICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZXkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICAgKiBjb2xsZWN0aW9uLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGEgcGFzc2luZyB2YWx1ZSBhbmQKICAgICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGNvbGxlY3Rpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBhbnkKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbnkgZWxlbWVudCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYsICdibG9ja2VkJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAsICdibG9ja2VkJzogdHJ1ZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29tZShjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29tZShjaGFyYWN0ZXJzLCB7ICdhZ2UnOiAxIH0pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gc29tZShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoKHJlc3VsdCA9IGNhbGxiYWNrKGNvbGxlY3Rpb25baW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gISFyZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGVsZW1lbnRzLCBzb3J0ZWQgaW4gYXNjZW5kaW5nIG9yZGVyIGJ5IHRoZSByZXN1bHRzIG9mCiAgICAgKiBydW5uaW5nIGVhY2ggZWxlbWVudCBpbiBhIGNvbGxlY3Rpb24gdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoaXMgbWV0aG9kCiAgICAgKiBwZXJmb3JtcyBhIHN0YWJsZSBzb3J0LCB0aGF0IGlzLCBpdCB3aWxsIHByZXNlcnZlIHRoZSBvcmlnaW5hbCBzb3J0IG9yZGVyCiAgICAgKiBvZiBlcXVhbCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoCiAgICAgKiB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNvbGxlY3Rpb24KICAgICAqIHdpbGwgYmUgc29ydGVkIGJ5IGVhY2ggcHJvcGVydHkgdmFsdWUuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHNvcnRlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguc2luKG51bSk7IH0pOwogICAgICogLy8gPT4gWzMsIDEsIDJdCiAgICAgKgogICAgICogXy5zb3J0QnkoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuc2luKG51bSk7IH0sIE1hdGgpOwogICAgICogLy8gPT4gWzMsIDEsIDJdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdhZ2UnOiAzNiB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDI2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdhZ2UnOiAzMCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWFwKF8uc29ydEJ5KGNoYXJhY3RlcnMsICdhZ2UnKSwgXy52YWx1ZXMpOwogICAgICogLy8gPT4gW1snYmFybmV5JywgMjZdLCBbJ2ZyZWQnLCAzMF0sIFsnYmFybmV5JywgMzZdLCBbJ2ZyZWQnLCA0MF1dCiAgICAgKgogICAgICogLy8gc29ydGluZyBieSBtdWx0aXBsZSBwcm9wZXJ0aWVzCiAgICAgKiBfLm1hcChfLnNvcnRCeShjaGFyYWN0ZXJzLCBbJ25hbWUnLCAnYWdlJ10pLCBfLnZhbHVlcyk7CiAgICAgKiAvLyA9ID4gW1snYmFybmV5JywgMjZdLCBbJ2Jhcm5leScsIDM2XSwgWydmcmVkJywgMzBdLCBbJ2ZyZWQnLCA0MF1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRCeShjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGlzQXJyID0gaXNBcnJheShjYWxsYmFjayksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgaWYgKCFpc0FycikgewogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgfQogICAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgb2JqZWN0ID0gcmVzdWx0WysraW5kZXhdID0gZ2V0T2JqZWN0KCk7CiAgICAgICAgaWYgKGlzQXJyKSB7CiAgICAgICAgICBvYmplY3QuY3JpdGVyaWEgPSBtYXAoY2FsbGJhY2ssIGZ1bmN0aW9uKGtleSkgeyByZXR1cm4gdmFsdWVba2V5XTsgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIChvYmplY3QuY3JpdGVyaWEgPSBnZXRBcnJheSgpKVswXSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0KICAgICAgICBvYmplY3QuaW5kZXggPSBpbmRleDsKICAgICAgICBvYmplY3QudmFsdWUgPSB2YWx1ZTsKICAgICAgfSk7CgogICAgICBsZW5ndGggPSByZXN1bHQubGVuZ3RoOwogICAgICByZXN1bHQuc29ydChjb21wYXJlQXNjZW5kaW5nKTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgdmFyIG9iamVjdCA9IHJlc3VsdFtsZW5ndGhdOwogICAgICAgIHJlc3VsdFtsZW5ndGhdID0gb2JqZWN0LnZhbHVlOwogICAgICAgIGlmICghaXNBcnIpIHsKICAgICAgICAgIHJlbGVhc2VBcnJheShvYmplY3QuY3JpdGVyaWEpOwogICAgICAgIH0KICAgICAgICByZWxlYXNlT2JqZWN0KG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgICAqIC8vID0+IFsyLCAzLCA0XQogICAgICovCiAgICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHNsaWNlKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXMoY29sbGVjdGlvbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBvZiBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAgdG8gdGhlIGdpdmVuCiAgICAgKiBgcHJvcGVydGllc2Agb2JqZWN0LCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzIHRoYXQgaGF2ZSBlcXVpdmFsZW50CiAgICAgKiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcHMgVGhlIG9iamVjdCBvZiBwcm9wZXJ0eSB2YWx1ZXMgdG8gZmlsdGVyIGJ5LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgZ2l2ZW4gcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAncGV0cyc6IFsnaG9wcHknXSB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICdhZ2UnOiA0MCwgJ3BldHMnOiBbJ2JhYnkgcHVzcycsICdkaW5vJ10gfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLndoZXJlKGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDM2IH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2LCAncGV0cyc6IFsnaG9wcHknXSB9XQogICAgICoKICAgICAqIF8ud2hlcmUoY2hhcmFjdGVycywgeyAncGV0cyc6IFsnZGlubyddIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCwgJ3BldHMnOiBbJ2JhYnkgcHVzcycsICdkaW5vJ10gfV0KICAgICAqLwogICAgdmFyIHdoZXJlID0gZmlsdGVyOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIHJlbW92ZWQuIFRoZSB2YWx1ZXMgYGZhbHNlYCwgYG51bGxgLAogICAgICogYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCwgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGV4Y2x1ZGluZyBhbGwgdmFsdWVzIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW3ZhbHVlc10gVGhlIGFycmF5cyBvZiB2YWx1ZXMgdG8gZXhjbHVkZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGlmZmVyZW5jZShbMSwgMiwgMywgNCwgNV0sIFs1LCAyLCAxMF0pOwogICAgICogLy8gPT4gWzEsIDMsIDRdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpZmZlcmVuY2UoYXJyYXkpIHsKICAgICAgcmV0dXJuIGJhc2VEaWZmZXJlbmNlKGFycmF5LCBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmluZGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGZpcnN0CiAgICAgKiBlbGVtZW50IHRoYXQgcGFzc2VzIHRoZSBjYWxsYmFjayBjaGVjaywgaW5zdGVhZCBvZiB0aGUgZWxlbWVudCBpdHNlbGYuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZm91bmQgZWxlbWVudCwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdhZ2UnOiA0MCwgJ2Jsb2NrZWQnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiBmYWxzZSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uZmluZEluZGV4KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA8IDIwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kSW5kZXgoY2hhcmFjdGVycywgeyAnYWdlJzogMzYgfSk7CiAgICAgKiAvLyA9PiAwCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kSW5kZXgoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKTsKICAgICAqIC8vID0+IDEKICAgICAqLwogICAgZnVuY3Rpb24gZmluZEluZGV4KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBpZiAoY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZmluZEluZGV4YCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZm91bmQgZWxlbWVudCwgZWxzZSBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2FnZSc6IDM2LCAnYmxvY2tlZCc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwLCAnYmxvY2tlZCc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxLCAgJ2Jsb2NrZWQnOiB0cnVlIH0KICAgICAqIF07CiAgICAgKgogICAgICogXy5maW5kTGFzdEluZGV4KGNoYXJhY3RlcnMsIGZ1bmN0aW9uKGNocikgewogICAgICogICByZXR1cm4gY2hyLmFnZSA+IDMwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maW5kTGFzdEluZGV4KGNoYXJhY3RlcnMsIHsgJ2FnZSc6IDM2IH0pOwogICAgICogLy8gPT4gMAogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZExhc3RJbmRleChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gMgogICAgICovCiAgICBmdW5jdGlvbiBmaW5kTGFzdEluZGV4KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChjYWxsYmFjayhhcnJheVtsZW5ndGhdLCBsZW5ndGgsIGFycmF5KSkgewogICAgICAgICAgcmV0dXJuIGxlbmd0aDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgZmlyc3QgZWxlbWVudCBvciBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSByZXR1cm5lZCBhcyBsb25nCiAgICAgKiBhcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGhlYWQsIHRha2UKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgZmlyc3QgZWxlbWVudChzKSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKgogICAgICogXy5maXJzdChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogXy5maXJzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2Jsb2NrZWQnOiBmYWxzZSwgJ2VtcGxveWVyJzogJ3NsYXRlJyB9LAogICAgICogICB7ICduYW1lJzogJ3BlYmJsZXMnLCAnYmxvY2tlZCc6IHRydWUsICAnZW1wbG95ZXInOiAnbmEnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maXJzdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnc2xhdGUnIH1dCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5wbHVjayhfLmZpcnN0KGNoYXJhY3RlcnMsIHsgJ2VtcGxveWVyJzogJ3NsYXRlJyB9KSwgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICovCiAgICBmdW5jdGlvbiBmaXJzdChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnbnVtYmVyJyAmJiBjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkgPyBhcnJheVswXSA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCBsZW5ndGgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIEZsYXR0ZW5zIGEgbmVzdGVkIGFycmF5ICh0aGUgbmVzdGluZyBjYW4gYmUgdG8gYW55IGRlcHRoKS4gSWYgYGlzU2hhbGxvd2AKICAgICAqIGlzIHRydWV5LCB0aGUgYXJyYXkgd2lsbCBvbmx5IGJlIGZsYXR0ZW5lZCBhIHNpbmdsZSBsZXZlbC4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgZWFjaCBlbGVtZW50IG9mIHRoZSBhcnJheSBpcyBwYXNzZWQgdGhyb3VnaCB0aGUgY2FsbGJhY2sgYmVmb3JlCiAgICAgKiBmbGF0dGVuaW5nLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUKICAgICAqIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gZmxhdHRlbi4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzU2hhbGxvdz1mYWxzZV0gQSBmbGFnIHRvIHJlc3RyaWN0IGZsYXR0ZW5pbmcgdG8gYSBzaW5nbGUgbGV2ZWwuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgZmxhdHRlbmVkIGFycmF5LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0pOwogICAgICogLy8gPT4gWzEsIDIsIDMsIDRdOwogICAgICoKICAgICAqIF8uZmxhdHRlbihbMSwgWzJdLCBbMywgW1s0XV1dXSwgdHJ1ZSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgW1s0XV1dOwogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICdhZ2UnOiAzMCwgJ3BldHMnOiBbJ2hvcHB5J10gfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAsICdwZXRzJzogWydiYWJ5IHB1c3MnLCAnZGlubyddIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5mbGF0dGVuKGNoYXJhY3RlcnMsICdwZXRzJyk7CiAgICAgKiAvLyA9PiBbJ2hvcHB5JywgJ2JhYnkgcHVzcycsICdkaW5vJ10KICAgICAqLwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSwgaXNTaGFsbG93LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgaXNTaGFsbG93ICE9ICdib29sZWFuJyAmJiBpc1NoYWxsb3cgIT0gbnVsbCkgewogICAgICAgIHRoaXNBcmcgPSBjYWxsYmFjazsKICAgICAgICBjYWxsYmFjayA9ICh0eXBlb2YgaXNTaGFsbG93ICE9ICdmdW5jdGlvbicgJiYgdGhpc0FyZyAmJiB0aGlzQXJnW2lzU2hhbGxvd10gPT09IGFycmF5KSA/IG51bGwgOiBpc1NoYWxsb3c7CiAgICAgICAgaXNTaGFsbG93ID0gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICBhcnJheSA9IG1hcChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlRmxhdHRlbihhcnJheSwgaXNTaGFsbG93KTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBhcnJheSBpcyBhbHJlYWR5IHNvcnRlZAogICAgICogcHJvdmlkaW5nIGB0cnVlYCBmb3IgYGZyb21JbmRleGAgd2lsbCBydW4gYSBmYXN0ZXIgYmluYXJ5IHNlYXJjaC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW58bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbSBvciBgdHJ1ZWAKICAgICAqICB0byBwZXJmb3JtIGEgYmluYXJ5IHNlYXJjaCBvbiBhIHNvcnRlZCBhcnJheS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gMQogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIsIDMpOwogICAgICogLy8gPT4gNAogICAgICoKICAgICAqIF8uaW5kZXhPZihbMSwgMSwgMiwgMiwgMywgM10sIDIsIHRydWUpOwogICAgICogLy8gPT4gMgogICAgICovCiAgICBmdW5jdGlvbiBpbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4IHx8IDApOwogICAgICB9IGVsc2UgaWYgKGZyb21JbmRleCkgewogICAgICAgIHZhciBpbmRleCA9IHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSk7CiAgICAgICAgcmV0dXJuIGFycmF5W2luZGV4XSA9PT0gdmFsdWUgPyBpbmRleCA6IC0xOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlSW5kZXhPZihhcnJheSwgdmFsdWUsIGZyb21JbmRleCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIGFsbCBidXQgdGhlIGxhc3QgZWxlbWVudCBvciBsYXN0IGBuYCBlbGVtZW50cyBvZiBhbiBhcnJheS4gSWYgYQogICAgICogY2FsbGJhY2sgaXMgcHJvdmlkZWQgZWxlbWVudHMgYXQgdGhlIGVuZCBvZiB0aGUgYXJyYXkgYXJlIGV4Y2x1ZGVkIGZyb20KICAgICAqIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kCiAgICAgKiB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrPTFdIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgZWxlbWVudCBvciB0aGUgbnVtYmVyIG9mIGVsZW1lbnRzIHRvIGV4Y2x1ZGUuIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIHNsaWNlIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW5pdGlhbChbMSwgMiwgM10pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKgogICAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqCiAgICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsxXQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYmxvY2tlZCc6IGZhbHNlLCAnZW1wbG95ZXInOiAnc2xhdGUnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAgJ2VtcGxveWVyJzogJ25hJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uaW5pdGlhbChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogZmFsc2UsICdlbXBsb3llcic6ICdzbGF0ZScgfV0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnBsdWNrKF8uaW5pdGlhbChjaGFyYWN0ZXJzLCB7ICdlbXBsb3llcic6ICduYScgfSksICduYW1lJyk7CiAgICAgKiAvLyA9PiBbJ2Jhcm5leScsICdmcmVkJ10KICAgICAqLwogICAgZnVuY3Rpb24gaW5pdGlhbChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIG4gPSAwLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPSAnbnVtYmVyJyAmJiBjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoOwogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICB3aGlsZSAoaW5kZXgtLSAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IChjYWxsYmFjayA9PSBudWxsIHx8IHRoaXNBcmcpID8gMSA6IGNhbGxiYWNrIHx8IG47CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCAwLCBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIGxlbmd0aCAtIG4pLCBsZW5ndGgpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdW5pcXVlIHZhbHVlcyBwcmVzZW50IGluIGFsbCBwcm92aWRlZCBhcnJheXMgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHNoYXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW50ZXJzZWN0aW9uKFsxLCAyLCAzXSwgWzUsIDIsIDEsIDRdLCBbMiwgMV0pOwogICAgICogLy8gPT4gWzEsIDJdCiAgICAgKi8KICAgIGZ1bmN0aW9uIGludGVyc2VjdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbXSwKICAgICAgICAgIGFyZ3NJbmRleCA9IC0xLAogICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgICBjYWNoZXMgPSBnZXRBcnJheSgpLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIHRydXN0SW5kZXhPZiA9IGluZGV4T2YgPT09IGJhc2VJbmRleE9mLAogICAgICAgICAgc2VlbiA9IGdldEFycmF5KCk7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJndW1lbnRzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGlzQXJyYXkodmFsdWUpIHx8IGlzQXJndW1lbnRzKHZhbHVlKSkgewogICAgICAgICAgYXJncy5wdXNoKHZhbHVlKTsKICAgICAgICAgIGNhY2hlcy5wdXNoKHRydXN0SW5kZXhPZiAmJiB2YWx1ZS5sZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYKICAgICAgICAgICAgY3JlYXRlQ2FjaGUoYXJnc0luZGV4ID8gYXJnc1thcmdzSW5kZXhdIDogc2VlbikpOwogICAgICAgIH0KICAgICAgfQogICAgICB2YXIgYXJyYXkgPSBhcmdzWzBdLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgb3V0ZXI6CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGNhY2hlID0gY2FjaGVzWzBdOwogICAgICAgIHZhbHVlID0gYXJyYXlbaW5kZXhdOwoKICAgICAgICBpZiAoKGNhY2hlID8gY2FjaGVJbmRleE9mKGNhY2hlLCB2YWx1ZSkgOiBpbmRleE9mKHNlZW4sIHZhbHVlKSkgPCAwKSB7CiAgICAgICAgICBhcmdzSW5kZXggPSBhcmdzTGVuZ3RoOwogICAgICAgICAgKGNhY2hlIHx8IHNlZW4pLnB1c2godmFsdWUpOwogICAgICAgICAgd2hpbGUgKC0tYXJnc0luZGV4KSB7CiAgICAgICAgICAgIGNhY2hlID0gY2FjaGVzW2FyZ3NJbmRleF07CiAgICAgICAgICAgIGlmICgoY2FjaGUgPyBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA6IGluZGV4T2YoYXJnc1thcmdzSW5kZXhdLCB2YWx1ZSkpIDwgMCkgewogICAgICAgICAgICAgIGNvbnRpbnVlIG91dGVyOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlIChhcmdzTGVuZ3RoLS0pIHsKICAgICAgICBjYWNoZSA9IGNhY2hlc1thcmdzTGVuZ3RoXTsKICAgICAgICBpZiAoY2FjaGUpIHsKICAgICAgICAgIHJlbGVhc2VPYmplY3QoY2FjaGUpOwogICAgICAgIH0KICAgICAgfQogICAgICByZWxlYXNlQXJyYXkoY2FjaGVzKTsKICAgICAgcmVsZWFzZUFycmF5KHNlZW4pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgbGFzdCBlbGVtZW50IG9yIGxhc3QgYG5gIGVsZW1lbnRzIG9mIGFuIGFycmF5LiBJZiBhIGNhbGxiYWNrIGlzCiAgICAgKiBwcm92aWRlZCBlbGVtZW50cyBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheSBhcmUgcmV0dXJuZWQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gcmV0dXJuLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgbGFzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubGFzdChbMSwgMiwgM10pOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8ubGFzdChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzIsIDNdCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPiAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAgJ2Jsb2NrZWQnOiBmYWxzZSwgJ2VtcGxveWVyJzogJ3NsYXRlJyB9LAogICAgICogICB7ICduYW1lJzogJ2ZyZWQnLCAgICAnYmxvY2tlZCc6IHRydWUsICAnZW1wbG95ZXInOiAnc2xhdGUnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICduYScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnBsdWNrKF8ubGFzdChjaGFyYWN0ZXJzLCAnYmxvY2tlZCcpLCAnbmFtZScpOwogICAgICogLy8gPT4gWydmcmVkJywgJ3BlYmJsZXMnXQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubGFzdChjaGFyYWN0ZXJzLCB7ICdlbXBsb3llcic6ICduYScgfSk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnbmEnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSBjYWxsYmFjazsKICAgICAgICBpZiAobiA9PSBudWxsIHx8IHRoaXNBcmcpIHsKICAgICAgICAgIHJldHVybiBhcnJheSA/IGFycmF5W2xlbmd0aCAtIDFdIDogdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIG5hdGl2ZU1heCgwLCBsZW5ndGggLSBuKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgbGFzdCBvY2N1cnJlbmNlIG9mIGB2YWx1ZWAgaXMgZm91bmQgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIGBmcm9tSW5kZXhgIGlzIG5lZ2F0aXZlLCBpdCBpcyB1c2VkCiAgICAgKiBhcyB0aGUgb2Zmc2V0IGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2Zyb21JbmRleD1hcnJheS5sZW5ndGgtMV0gVGhlIGluZGV4IHRvIHNlYXJjaCBmcm9tLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIG1hdGNoZWQgdmFsdWUgb3IgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sYXN0SW5kZXhPZihbMSwgMiwgMywgMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gNAogICAgICoKICAgICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgICAqIC8vID0+IDEKICAgICAqLwogICAgZnVuY3Rpb24gbGFzdEluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpIHsKICAgICAgdmFyIGluZGV4ID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwogICAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICAgIGluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgaW5kZXggKyBmcm9tSW5kZXgpIDogbmF0aXZlTWluKGZyb21JbmRleCwgaW5kZXggLSAxKSkgKyAxOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleC0tKSB7CiAgICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICAgIHJldHVybiBpbmRleDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgcHJvdmlkZWQgdmFsdWVzIGZyb20gdGhlIGdpdmVuIGFycmF5IHVzaW5nIHN0cmljdCBlcXVhbGl0eSBmb3IKICAgICAqIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gbW9kaWZ5LgogICAgICogQHBhcmFtIHsuLi4qfSBbdmFsdWVdIFRoZSB2YWx1ZXMgdG8gcmVtb3ZlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBhcnJheSA9IFsxLCAyLCAzLCAxLCAyLCAzXTsKICAgICAqIF8ucHVsbChhcnJheSwgMiwgMyk7CiAgICAgKiBjb25zb2xlLmxvZyhhcnJheSk7CiAgICAgKiAvLyA9PiBbMSwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcHVsbChhcnJheSkgewogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIGFyZ3NJbmRleCA9IDAsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIHZhbHVlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpZiAoYXJyYXlbaW5kZXhdID09PSB2YWx1ZSkgewogICAgICAgICAgICBzcGxpY2UuY2FsbChhcnJheSwgaW5kZXgtLSwgMSk7CiAgICAgICAgICAgIGxlbmd0aC0tOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJyYXk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIG51bWJlcnMgKHBvc2l0aXZlIGFuZC9vciBuZWdhdGl2ZSkgcHJvZ3Jlc3NpbmcgZnJvbQogICAgICogYHN0YXJ0YCB1cCB0byBidXQgbm90IGluY2x1ZGluZyBgZW5kYC4gSWYgYHN0YXJ0YCBpcyBsZXNzIHRoYW4gYHN0b3BgIGEKICAgICAqIHplcm8tbGVuZ3RoIHJhbmdlIGlzIGNyZWF0ZWQgdW5sZXNzIGEgbmVnYXRpdmUgYHN0ZXBgIGlzIHNwZWNpZmllZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydD0wXSBUaGUgc3RhcnQgb2YgdGhlIHJhbmdlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RlcD0xXSBUaGUgdmFsdWUgdG8gaW5jcmVtZW50IG9yIGRlY3JlbWVudCBieS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyByYW5nZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yYW5nZSg0KTsKICAgICAqIC8vID0+IFswLCAxLCAyLCAzXQogICAgICoKICAgICAqIF8ucmFuZ2UoMSwgNSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNF0KICAgICAqCiAgICAgKiBfLnJhbmdlKDAsIDIwLCA1KTsKICAgICAqIC8vID0+IFswLCA1LCAxMCwgMTVdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAtNCwgLTEpOwogICAgICogLy8gPT4gWzAsIC0xLCAtMiwgLTNdCiAgICAgKgogICAgICogXy5yYW5nZSgxLCA0LCAwKTsKICAgICAqIC8vID0+IFsxLCAxLCAxXQogICAgICoKICAgICAqIF8ucmFuZ2UoMCk7CiAgICAgKiAvLyA9PiBbXQogICAgICovCiAgICBmdW5jdGlvbiByYW5nZShzdGFydCwgZW5kLCBzdGVwKSB7CiAgICAgIHN0YXJ0ID0gK3N0YXJ0IHx8IDA7CiAgICAgIHN0ZXAgPSB0eXBlb2Ygc3RlcCA9PSAnbnVtYmVyJyA/IHN0ZXAgOiAoK3N0ZXAgfHwgMSk7CgogICAgICBpZiAoZW5kID09IG51bGwpIHsKICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0KICAgICAgLy8gdXNlIGBBcnJheShsZW5ndGgpYCBzbyBlbmdpbmVzIGxpa2UgQ2hha3JhIGFuZCBWOCBhdm9pZCBzbG93ZXIgbW9kZXMKICAgICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWF4KDAsIGNlaWwoKGVuZCAtIHN0YXJ0KSAvIChzdGVwIHx8IDEpKSksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgZWxlbWVudHMgZnJvbSBhbiBhcnJheSB0aGF0IHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvcgogICAgICogYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgcmVtb3ZlZCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgNCwgNSwgNl07CiAgICAgKiB2YXIgZXZlbnMgPSBfLnJlbW92ZShhcnJheSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxLCAzLCA1XQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGV2ZW5zKTsKICAgICAqIC8vID0+IFsyLCA0LCA2XQogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmUoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gW107CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uaW5pdGlhbGAgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCBlbGVtZW50IG9yCiAgICAgKiBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZWxlbWVudHMKICAgICAqIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxudW1iZXJ8c3RyaW5nfSBbY2FsbGJhY2s9MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gZXhjbHVkZS4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yCiAgICAgKiAgb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiCiAgICAgKiAgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLnJlc3QoWzEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IFszXQogICAgICoKICAgICAqIF8ucmVzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzNdCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgICdibG9ja2VkJzogdHJ1ZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2Jsb2NrZWQnOiBmYWxzZSwgICdlbXBsb3llcic6ICdzbGF0ZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdwZWJibGVzJywgJ2Jsb2NrZWQnOiB0cnVlLCAnZW1wbG95ZXInOiAnbmEnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5wbHVjayhfLnJlc3QoY2hhcmFjdGVycywgJ2Jsb2NrZWQnKSwgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnZnJlZCcsICdwZWJibGVzJ10KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlc3QoY2hhcmFjdGVycywgeyAnZW1wbG95ZXInOiAnc2xhdGUnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAncGViYmxlcycsICdibG9ja2VkJzogdHJ1ZSwgJ2VtcGxveWVyJzogJ25hJyB9XQogICAgICovCiAgICBmdW5jdGlvbiByZXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdudW1iZXInICYmIGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICB2YXIgbiA9IDAsCiAgICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gKGNhbGxiYWNrID09IG51bGwgfHwgdGhpc0FyZykgPyAxIDogbmF0aXZlTWF4KDAsIGNhbGxiYWNrKTsKICAgICAgfQogICAgICByZXR1cm4gc2xpY2UoYXJyYXksIG4pOwogICAgfQoKICAgIC8qKgogICAgICogVXNlcyBhIGJpbmFyeSBzZWFyY2ggdG8gZGV0ZXJtaW5lIHRoZSBzbWFsbGVzdCBpbmRleCBhdCB3aGljaCBhIHZhbHVlCiAgICAgKiBzaG91bGQgYmUgaW5zZXJ0ZWQgaW50byBhIGdpdmVuIHNvcnRlZCBhcnJheSBpbiBvcmRlciB0byBtYWludGFpbiB0aGUgc29ydAogICAgICogb3JkZXIgb2YgdGhlIGFycmF5LiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yCiAgICAgKiBgdmFsdWVgIGFuZCBlYWNoIGVsZW1lbnQgb2YgYGFycmF5YCB0byBjb21wdXRlIHRoZWlyIHNvcnQgcmFua2luZy4gVGhlCiAgICAgKiBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCBvbmUgYXJndW1lbnQ7ICh2YWx1ZSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gZXZhbHVhdGUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBhdCB3aGljaCBgdmFsdWVgIHNob3VsZCBiZSBpbnNlcnRlZAogICAgICogIGludG8gYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbMjAsIDMwLCA1MF0sIDQwKTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnNvcnRlZEluZGV4KFt7ICd4JzogMjAgfSwgeyAneCc6IDMwIH0sIHsgJ3gnOiA1MCB9XSwgeyAneCc6IDQwIH0sICd4Jyk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIGRpY3QgPSB7CiAgICAgKiAgICd3b3JkVG9OdW1iZXInOiB7ICd0d2VudHknOiAyMCwgJ3RoaXJ0eSc6IDMwLCAnZm91cnR5JzogNDAsICdmaWZ0eSc6IDUwIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgICAqICAgcmV0dXJuIGRpY3Qud29yZFRvTnVtYmVyW3dvcmRdOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zb3J0ZWRJbmRleChbJ3R3ZW50eScsICd0aGlydHknLCAnZmlmdHknXSwgJ2ZvdXJ0eScsIGZ1bmN0aW9uKHdvcmQpIHsKICAgICAqICAgcmV0dXJuIHRoaXMud29yZFRvTnVtYmVyW3dvcmRdOwogICAgICogfSwgZGljdCk7CiAgICAgKiAvLyA9PiAyCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNvcnRlZEluZGV4KGFycmF5LCB2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGxvdyA9IDAsCiAgICAgICAgICBoaWdoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiBsb3c7CgogICAgICAvLyBleHBsaWNpdGx5IHJlZmVyZW5jZSBgaWRlbnRpdHlgIGZvciBiZXR0ZXIgaW5saW5pbmcgaW4gRmlyZWZveAogICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID8gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSA6IGlkZW50aXR5OwogICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlKTsKCiAgICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+Pj4gMTsKICAgICAgICAoY2FsbGJhY2soYXJyYXlbbWlkXSkgPCB2YWx1ZSkKICAgICAgICAgID8gbG93ID0gbWlkICsgMQogICAgICAgICAgOiBoaWdoID0gbWlkOwogICAgICB9CiAgICAgIHJldHVybiBsb3c7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMsIGluIG9yZGVyLCBvZiB0aGUgcHJvdmlkZWQgYXJyYXlzIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXldIFRoZSBhcnJheXMgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBjb21iaW5lZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pb24oWzEsIDIsIDNdLCBbNSwgMiwgMSwgNF0sIFsyLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNSwgNF0KICAgICAqLwogICAgZnVuY3Rpb24gdW5pb24oKSB7CiAgICAgIHJldHVybiBiYXNlVW5pcShiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIHRydWUpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSB2ZXJzaW9uIG9mIGFuIGFycmF5IHVzaW5nIHN0cmljdCBlcXVhbGl0eQogICAgICogZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYXJyYXkgaXMgc29ydGVkLCBwcm92aWRpbmcKICAgICAqIGB0cnVlYCBmb3IgYGlzU29ydGVkYCB3aWxsIHVzZSBhIGZhc3RlciBhbGdvcml0aG0uIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQKICAgICAqIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIGlzIHBhc3NlZCB0aHJvdWdoIHRoZSBjYWxsYmFjayBiZWZvcmUgdW5pcXVlbmVzcwogICAgICogaXMgY29tcHV0ZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyB1bmlxdWUKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNTb3J0ZWQ9ZmFsc2VdIEEgZmxhZyB0byBpbmRpY2F0ZSB0aGF0IGBhcnJheWAgaXMgc29ydGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgZHVwbGljYXRlLXZhbHVlLWZyZWUgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pcShbMSwgMiwgMSwgMywgMV0pOwogICAgICogLy8gPT4gWzEsIDIsIDNdCiAgICAgKgogICAgICogXy51bmlxKFsxLCAxLCAyLCAyLCAzXSwgdHJ1ZSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiBfLnVuaXEoWydBJywgJ2InLCAnQycsICdhJywgJ0InLCAnYyddLCBmdW5jdGlvbihsZXR0ZXIpIHsgcmV0dXJuIGxldHRlci50b0xvd2VyQ2FzZSgpOyB9KTsKICAgICAqIC8vID0+IFsnQScsICdiJywgJ0MnXQogICAgICoKICAgICAqIF8udW5pcShbMSwgMi41LCAzLCAxLjUsIDIsIDMuNV0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgICAqIC8vID0+IFsxLCAyLjUsIDNdCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy51bmlxKFt7ICd4JzogMSB9LCB7ICd4JzogMiB9LCB7ICd4JzogMSB9XSwgJ3gnKTsKICAgICAqIC8vID0+IFt7ICd4JzogMSB9LCB7ICd4JzogMiB9XQogICAgICovCiAgICBmdW5jdGlvbiB1bmlxKGFycmF5LCBpc1NvcnRlZCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgICBpZiAodHlwZW9mIGlzU29ydGVkICE9ICdib29sZWFuJyAmJiBpc1NvcnRlZCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gKHR5cGVvZiBpc1NvcnRlZCAhPSAnZnVuY3Rpb24nICYmIHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NvcnRlZF0gPT09IGFycmF5KSA/IG51bGwgOiBpc1NvcnRlZDsKICAgICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgZXhjbHVkaW5nIGFsbCBwcm92aWRlZCB2YWx1ZXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAgICogY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFt2YWx1ZV0gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy53aXRob3V0KFsxLCAyLCAxLCAwLCAzLCAxLCA0XSwgMCwgMSk7CiAgICAgKiAvLyA9PiBbMiwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gd2l0aG91dChhcnJheSkgewogICAgICByZXR1cm4gYmFzZURpZmZlcmVuY2UoYXJyYXksIHNsaWNlKGFyZ3VtZW50cywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB0aGF0IGlzIHRoZSBzeW1tZXRyaWMgZGlmZmVyZW5jZSBvZiB0aGUgcHJvdmlkZWQgYXJyYXlzLgogICAgICogU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3ltbWV0cmljX2RpZmZlcmVuY2UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy54b3IoWzEsIDIsIDNdLCBbNSwgMiwgMSwgNF0pOwogICAgICogLy8gPT4gWzMsIDUsIDRdCiAgICAgKgogICAgICogXy54b3IoWzEsIDIsIDVdLCBbMiwgMywgNV0sIFszLCA0LCA1XSk7CiAgICAgKiAvLyA9PiBbMSwgNCwgNV0KICAgICAqLwogICAgZnVuY3Rpb24geG9yKCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBhcnJheSA9IGFyZ3VtZW50c1tpbmRleF07CiAgICAgICAgaWYgKGlzQXJyYXkoYXJyYXkpIHx8IGlzQXJndW1lbnRzKGFycmF5KSkgewogICAgICAgICAgdmFyIHJlc3VsdCA9IHJlc3VsdAogICAgICAgICAgICA/IGJhc2VVbmlxKGJhc2VEaWZmZXJlbmNlKHJlc3VsdCwgYXJyYXkpLmNvbmNhdChiYXNlRGlmZmVyZW5jZShhcnJheSwgcmVzdWx0KSkpCiAgICAgICAgICAgIDogYXJyYXk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQgfHwgW107CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIGdyb3VwZWQgZWxlbWVudHMsIHRoZSBmaXJzdCBvZiB3aGljaCBjb250YWlucyB0aGUgZmlyc3QKICAgICAqIGVsZW1lbnRzIG9mIHRoZSBnaXZlbiBhcnJheXMsIHRoZSBzZWNvbmQgb2Ygd2hpY2ggY29udGFpbnMgdGhlIHNlY29uZAogICAgICogZWxlbWVudHMgb2YgdGhlIGdpdmVuIGFycmF5cywgYW5kIHNvIG9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdW56aXAKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gQXJyYXlzIHRvIHByb2Nlc3MuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy56aXAoWydmcmVkJywgJ2Jhcm5leSddLCBbMzAsIDQwXSwgW3RydWUsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiBbWydmcmVkJywgMzAsIHRydWVdLCBbJ2Jhcm5leScsIDQwLCBmYWxzZV1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcCgpIHsKICAgICAgdmFyIGFycmF5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHMgOiBhcmd1bWVudHNbMF0sCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBtYXgocGx1Y2soYXJyYXksICdsZW5ndGgnKSkgOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gcGx1Y2soYXJyYXksIGluZGV4KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgZnJvbSBhcnJheXMgb2YgYGtleXNgIGFuZCBgdmFsdWVzYC4gUHJvdmlkZQogICAgICogZWl0aGVyIGEgc2luZ2xlIHR3byBkaW1lbnNpb25hbCBhcnJheSwgaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gCiAgICAgKiBvciB0d28gYXJyYXlzLCBvbmUgb2YgYGtleXNgIGFuZCBvbmUgb2YgY29ycmVzcG9uZGluZyBgdmFsdWVzYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIG9iamVjdAogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0ga2V5cyBUaGUgYXJyYXkgb2Yga2V5cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFt2YWx1ZXM9W11dIFRoZSBhcnJheSBvZiB2YWx1ZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgZ2l2ZW4ga2V5cyBhbmQKICAgICAqICBjb3JyZXNwb25kaW5nIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy56aXBPYmplY3QoWydmcmVkJywgJ2Jhcm5leSddLCBbMzAsIDQwXSk7CiAgICAgKiAvLyA9PiB7ICdmcmVkJzogMzAsICdiYXJuZXknOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcE9iamVjdChrZXlzLCB2YWx1ZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICBpZiAoIXZhbHVlcyAmJiBsZW5ndGggJiYgIWlzQXJyYXkoa2V5c1swXSkpIHsKICAgICAgICB2YWx1ZXMgPSBbXTsKICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgICAgfSBlbHNlIGlmIChrZXkpIHsKICAgICAgICAgIHJlc3VsdFtrZXlbMF1dID0ga2V5WzFdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgZXhlY3V0ZXMgYGZ1bmNgLCB3aXRoICB0aGUgYHRoaXNgIGJpbmRpbmcgYW5kCiAgICAgKiBhcmd1bWVudHMgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24sIG9ubHkgYWZ0ZXIgYmVpbmcgY2FsbGVkIGBuYCB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZnVuY3Rpb24gbXVzdCBiZSBjYWxsZWQgYmVmb3JlCiAgICAgKiAgYGZ1bmNgIGlzIGV4ZWN1dGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F2ZXMgPSBbJ3Byb2ZpbGUnLCAnc2V0dGluZ3MnXTsKICAgICAqCiAgICAgKiB2YXIgZG9uZSA9IF8uYWZ0ZXIoc2F2ZXMubGVuZ3RoLCBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ0RvbmUgc2F2aW5nIScpOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5mb3JFYWNoKHNhdmVzLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgKiAgIGFzeW5jU2F2ZSh7ICd0eXBlJzogdHlwZSwgJ2NvbXBsZXRlJzogZG9uZSB9KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnRG9uZSBzYXZpbmchJywgYWZ0ZXIgYWxsIHNhdmVzIGhhdmUgY29tcGxldGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKC0tbiA8IDEpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICAgKiBwcm92aWRlZCB0byB0aGUgYm91bmQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiB9OwogICAgICoKICAgICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdmcmVkJyB9LCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBmcmVkJwogICAgICovCiAgICBmdW5jdGlvbiBiaW5kKGZ1bmMsIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAyCiAgICAgICAgPyBjcmVhdGVXcmFwcGVyKGZ1bmMsIDE3LCBzbGljZShhcmd1bWVudHMsIDIpLCBudWxsLCB0aGlzQXJnKQogICAgICAgIDogY3JlYXRlV3JhcHBlcihmdW5jLCAxLCBudWxsLCBudWxsLCB0aGlzQXJnKTsKICAgIH0KCiAgICAvKioKICAgICAqIEJpbmRzIG1ldGhvZHMgb2YgYW4gb2JqZWN0IHRvIHRoZSBvYmplY3QgaXRzZWxmLCBvdmVyd3JpdGluZyB0aGUgZXhpc3RpbmcKICAgICAqIG1ldGhvZC4gTWV0aG9kIG5hbWVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICAgKiBvZiBtZXRob2QgbmFtZXMuIElmIG5vIG1ldGhvZCBuYW1lcyBhcmUgcHJvdmlkZWQgYWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJ0aWVzCiAgICAgKiBvZiBgb2JqZWN0YCB3aWxsIGJlIGJvdW5kLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gYmluZCBhbmQgYXNzaWduIHRoZSBib3VuZCBtZXRob2RzIHRvLgogICAgICogQHBhcmFtIHsuLi5zdHJpbmd9IFttZXRob2ROYW1lXSBUaGUgb2JqZWN0IG1ldGhvZCBuYW1lcyB0bwogICAgICogIGJpbmQsIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIG1ldGhvZCBuYW1lcyBvciBhcnJheXMgb2YgbWV0aG9kIG5hbWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHZpZXcgPSB7CiAgICAgKiAgICdsYWJlbCc6ICdkb2NzJywKICAgICAqICAgJ29uQ2xpY2snOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2NsaWNrZWQgJyArIHRoaXMubGFiZWwpOyB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uYmluZEFsbCh2aWV3KTsKICAgICAqIGpRdWVyeSgnI2RvY3MnKS5vbignY2xpY2snLCB2aWV3Lm9uQ2xpY2spOwogICAgICogLy8gPT4gbG9ncyAnY2xpY2tlZCBkb2NzJywgd2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSA6IGZ1bmN0aW9ucyhvYmplY3QpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgICBvYmplY3Rba2V5XSA9IGNyZWF0ZVdyYXBwZXIob2JqZWN0W2tleV0sIDEsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGNhbGxlZCwgaW52b2tlcyB0aGUgbWV0aG9kIGF0IGBvYmplY3Rba2V5XWAKICAgICAqIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZEtleWAgYXJndW1lbnRzIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBib3VuZAogICAgICogZnVuY3Rpb24uIFRoaXMgbWV0aG9kIGRpZmZlcnMgZnJvbSBgXy5iaW5kYCBieSBhbGxvd2luZyBib3VuZCBmdW5jdGlvbnMgdG8KICAgICAqIHJlZmVyZW5jZSBtZXRob2RzIHRoYXQgd2lsbCBiZSByZWRlZmluZWQgb3IgZG9uJ3QgeWV0IGV4aXN0LgogICAgICogU2VlIGh0dHA6Ly9taWNoYXV4LmNhL2FydGljbGVzL2xhenktZnVuY3Rpb24tZGVmaW5pdGlvbi1wYXR0ZXJuLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdGhlIG1ldGhvZCBiZWxvbmdzIHRvLgogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSBUaGUga2V5IG9mIHRoZSBtZXRob2QuCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBiZSBwYXJ0aWFsbHkgYXBwbGllZC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGJvdW5kIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnbmFtZSc6ICdmcmVkJywKICAgICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBmcmVkJwogICAgICoKICAgICAqIG9iamVjdC5ncmVldCA9IGZ1bmN0aW9uKGdyZWV0aW5nKSB7CiAgICAgKiAgIHJldHVybiBncmVldGluZyArICd5YSAnICsgdGhpcy5uYW1lICsgJyEnOwogICAgICogfTsKICAgICAqCiAgICAgKiBmdW5jKCk7CiAgICAgKiAvLyA9PiAnaGl5YSBmcmVkIScKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEtleShvYmplY3QsIGtleSkgewogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDIKICAgICAgICA/IGNyZWF0ZVdyYXBwZXIoa2V5LCAxOSwgc2xpY2UoYXJndW1lbnRzLCAyKSwgbnVsbCwgb2JqZWN0KQogICAgICAgIDogY3JlYXRlV3JhcHBlcihrZXksIDMsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGZ1bmN0aW9ucywKICAgICAqIHdoZXJlIGVhY2ggZnVuY3Rpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogICAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Li4uRnVuY3Rpb259IFtmdW5jXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNvbXBvc2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcmVhbE5hbWVNYXAgPSB7CiAgICAgKiAgICdwZWJibGVzJzogJ3BlbmVsb3BlJwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgZm9ybWF0ID0gZnVuY3Rpb24obmFtZSkgewogICAgICogICBuYW1lID0gcmVhbE5hbWVNYXBbbmFtZS50b0xvd2VyQ2FzZSgpXSB8fCBuYW1lOwogICAgICogICByZXR1cm4gbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkudG9Mb3dlckNhc2UoKTsKICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZm9ybWF0dGVkKSB7CiAgICAgKiAgIHJldHVybiAnSGl5YSAnICsgZm9ybWF0dGVkICsgJyEnOwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgd2VsY29tZSA9IF8uY29tcG9zZShncmVldCwgZm9ybWF0KTsKICAgICAqIHdlbGNvbWUoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+ICdIaXlhIFBlbmVsb3BlIScKICAgICAqLwogICAgZnVuY3Rpb24gY29tcG9zZSgpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gZnVuY3MubGVuZ3RoOwoKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmNzW2xlbmd0aF0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgICBhcmdzID0gW2Z1bmNzW2xlbmd0aF0uYXBwbHkodGhpcywgYXJncyldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJnc1swXTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB3aGljaCBhY2NlcHRzIG9uZSBvciBtb3JlIGFyZ3VtZW50cyBvZiBgZnVuY2AgdGhhdCB3aGVuCiAgICAgKiBpbnZva2VkIGVpdGhlciBleGVjdXRlcyBgZnVuY2AgcmV0dXJuaW5nIGl0cyByZXN1bHQsIGlmIGFsbCBgZnVuY2AgYXJndW1lbnRzCiAgICAgKiBoYXZlIGJlZW4gcHJvdmlkZWQsIG9yIHJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgb25lIG9yIG1vcmUgb2YgdGhlCiAgICAgKiByZW1haW5pbmcgYGZ1bmNgIGFyZ3VtZW50cywgYW5kIHNvIG9uLiBUaGUgYXJpdHkgb2YgYGZ1bmNgIGNhbiBiZSBzcGVjaWZpZWQKICAgICAqIGlmIGBmdW5jLmxlbmd0aGAgaXMgbm90IHN1ZmZpY2llbnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGN1cnJ5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcml0eT1mdW5jLmxlbmd0aF0gVGhlIGFyaXR5IG9mIGBmdW5jYC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGN1cnJpZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjdXJyaWVkID0gXy5jdXJyeShmdW5jdGlvbihhLCBiLCBjKSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGEgKyBiICsgYyk7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBjdXJyaWVkKDEpKDIpKDMpOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMikoMyk7CiAgICAgKiAvLyA9PiA2CiAgICAgKgogICAgICogY3VycmllZCgxLCAyLCAzKTsKICAgICAqIC8vID0+IDYKICAgICAqLwogICAgZnVuY3Rpb24gY3VycnkoZnVuYywgYXJpdHkpIHsKICAgICAgYXJpdHkgPSB0eXBlb2YgYXJpdHkgPT0gJ251bWJlcicgPyBhcml0eSA6ICgrYXJpdHkgfHwgZnVuYy5sZW5ndGgpOwogICAgICByZXR1cm4gY3JlYXRlV3JhcHBlcihmdW5jLCA0LCBudWxsLCBudWxsLCBudWxsLCBhcml0eSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGRlbGF5IHRoZSBleGVjdXRpb24gb2YgYGZ1bmNgIHVudGlsIGFmdGVyCiAgICAgKiBgd2FpdGAgbWlsbGlzZWNvbmRzIGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgbGFzdCB0aW1lIGl0IHdhcyBpbnZva2VkLgogICAgICogUHJvdmlkZSBhbiBvcHRpb25zIG9iamVjdCB0byBpbmRpY2F0ZSB0aGF0IGBmdW5jYCBzaG91bGQgYmUgaW52b2tlZCBvbgogICAgICogdGhlIGxlYWRpbmcgYW5kL29yIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIGB3YWl0YCB0aW1lb3V0LiBTdWJzZXF1ZW50IGNhbGxzCiAgICAgKiB0byB0aGUgZGVib3VuY2VkIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICAgKgogICAgICogTm90ZTogSWYgYGxlYWRpbmdgIGFuZCBgdHJhaWxpbmdgIG9wdGlvbnMgYXJlIGB0cnVlYCBgZnVuY2Agd2lsbCBiZSBjYWxsZWQKICAgICAqIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0IG9ubHkgaWYgdGhlIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gaXMKICAgICAqIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVib3VuY2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheS4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgb2JqZWN0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5sZWFkaW5nPWZhbHNlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm1heFdhaXRdIFRoZSBtYXhpbXVtIHRpbWUgYGZ1bmNgIGlzIGFsbG93ZWQgdG8gYmUgZGVsYXllZCBiZWZvcmUgaXQncyBjYWxsZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnRyYWlsaW5nPXRydWVdIFNwZWNpZnkgZXhlY3V0aW9uIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZGVib3VuY2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyBhdm9pZCBjb3N0bHkgY2FsY3VsYXRpb25zIHdoaWxlIHRoZSB3aW5kb3cgc2l6ZSBpcyBpbiBmbHV4CiAgICAgKiB2YXIgbGF6eUxheW91dCA9IF8uZGVib3VuY2UoY2FsY3VsYXRlTGF5b3V0LCAxNTApOwogICAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Jlc2l6ZScsIGxhenlMYXlvdXQpOwogICAgICoKICAgICAqIC8vIGV4ZWN1dGUgYHNlbmRNYWlsYCB3aGVuIHRoZSBjbGljayBldmVudCBpcyBmaXJlZCwgZGVib3VuY2luZyBzdWJzZXF1ZW50IGNhbGxzCiAgICAgKiBqUXVlcnkoJyNwb3N0Ym94Jykub24oJ2NsaWNrJywgXy5kZWJvdW5jZShzZW5kTWFpbCwgMzAwLCB7CiAgICAgKiAgICdsZWFkaW5nJzogdHJ1ZSwKICAgICAqICAgJ3RyYWlsaW5nJzogZmFsc2UKICAgICAqIH0pOwogICAgICoKICAgICAqIC8vIGVuc3VyZSBgYmF0Y2hMb2dgIGlzIGV4ZWN1dGVkIG9uY2UgYWZ0ZXIgMSBzZWNvbmQgb2YgZGVib3VuY2VkIGNhbGxzCiAgICAgKiB2YXIgc291cmNlID0gbmV3IEV2ZW50U291cmNlKCcvc3RyZWFtJyk7CiAgICAgKiBzb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIF8uZGVib3VuY2UoYmF0Y2hMb2csIDI1MCwgewogICAgICogICAnbWF4V2FpdCc6IDEwMDAKICAgICAqIH0sIGZhbHNlKTsKICAgICAqLwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgYXJncywKICAgICAgICAgIG1heFRpbWVvdXRJZCwKICAgICAgICAgIHJlc3VsdCwKICAgICAgICAgIHN0YW1wLAogICAgICAgICAgdGhpc0FyZywKICAgICAgICAgIHRpbWVvdXRJZCwKICAgICAgICAgIHRyYWlsaW5nQ2FsbCwKICAgICAgICAgIGxhc3RDYWxsZWQgPSAwLAogICAgICAgICAgbWF4V2FpdCA9IGZhbHNlLAogICAgICAgICAgdHJhaWxpbmcgPSB0cnVlOwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICB3YWl0ID0gbmF0aXZlTWF4KDAsIHdhaXQpIHx8IDA7CiAgICAgIGlmIChvcHRpb25zID09PSB0cnVlKSB7CiAgICAgICAgdmFyIGxlYWRpbmcgPSB0cnVlOwogICAgICAgIHRyYWlsaW5nID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykpIHsKICAgICAgICBsZWFkaW5nID0gb3B0aW9ucy5sZWFkaW5nOwogICAgICAgIG1heFdhaXQgPSAnbWF4V2FpdCcgaW4gb3B0aW9ucyAmJiAobmF0aXZlTWF4KHdhaXQsIG9wdGlvbnMubWF4V2FpdCkgfHwgMCk7CiAgICAgICAgdHJhaWxpbmcgPSAndHJhaWxpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLnRyYWlsaW5nIDogdHJhaWxpbmc7CiAgICAgIH0KICAgICAgdmFyIGRlbGF5ZWQgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgcmVtYWluaW5nID0gd2FpdCAtIChub3coKSAtIHN0YW1wKTsKICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApIHsKICAgICAgICAgIGlmIChtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgY2xlYXJUaW1lb3V0KG1heFRpbWVvdXRJZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDYWxsZWQgPSB0cmFpbGluZ0NhbGw7CiAgICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgICBpZiAoaXNDYWxsZWQpIHsKICAgICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgICBpZiAoIXRpbWVvdXRJZCAmJiAhbWF4VGltZW91dElkKSB7CiAgICAgICAgICAgICAgYXJncyA9IHRoaXNBcmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgbWF4RGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aW1lb3V0SWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHRyYWlsaW5nIHx8IChtYXhXYWl0ICE9PSB3YWl0KSkgewogICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICAgIGlmICghdGltZW91dElkICYmICFtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgYXJncyA9IHRoaXNBcmcgPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICBhcmdzID0gYXJndW1lbnRzOwogICAgICAgIHN0YW1wID0gbm93KCk7CiAgICAgICAgdGhpc0FyZyA9IHRoaXM7CiAgICAgICAgdHJhaWxpbmdDYWxsID0gdHJhaWxpbmcgJiYgKHRpbWVvdXRJZCB8fCAhbGVhZGluZyk7CgogICAgICAgIGlmIChtYXhXYWl0ID09PSBmYWxzZSkgewogICAgICAgICAgdmFyIGxlYWRpbmdDYWxsID0gbGVhZGluZyAmJiAhdGltZW91dElkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoIW1heFRpbWVvdXRJZCAmJiAhbGVhZGluZykgewogICAgICAgICAgICBsYXN0Q2FsbGVkID0gc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVtYWluaW5nID0gbWF4V2FpdCAtIChzdGFtcCAtIGxhc3RDYWxsZWQpLAogICAgICAgICAgICAgIGlzQ2FsbGVkID0gcmVtYWluaW5nIDw9IDA7CgogICAgICAgICAgaWYgKGlzQ2FsbGVkKSB7CiAgICAgICAgICAgIGlmIChtYXhUaW1lb3V0SWQpIHsKICAgICAgICAgICAgICBtYXhUaW1lb3V0SWQgPSBjbGVhclRpbWVvdXQobWF4VGltZW91dElkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0Q2FsbGVkID0gc3RhbXA7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIGlmICghbWF4VGltZW91dElkKSB7CiAgICAgICAgICAgIG1heFRpbWVvdXRJZCA9IHNldFRpbWVvdXQobWF4RGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGlzQ2FsbGVkICYmIHRpbWVvdXRJZCkgewogICAgICAgICAgdGltZW91dElkID0gY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCF0aW1lb3V0SWQgJiYgd2FpdCAhPT0gbWF4V2FpdCkgewogICAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dChkZWxheWVkLCB3YWl0KTsKICAgICAgICB9CiAgICAgICAgaWYgKGxlYWRpbmdDYWxsKSB7CiAgICAgICAgICBpc0NhbGxlZCA9IHRydWU7CiAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgIH0KICAgICAgICBpZiAoaXNDYWxsZWQgJiYgIXRpbWVvdXRJZCAmJiAhbWF4VGltZW91dElkKSB7CiAgICAgICAgICBhcmdzID0gdGhpc0FyZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBEZWZlcnMgZXhlY3V0aW5nIHRoZSBgZnVuY2AgZnVuY3Rpb24gdW50aWwgdGhlIGN1cnJlbnQgY2FsbCBzdGFjayBoYXMgY2xlYXJlZC4KICAgICAqIEFkZGl0aW9uYWwgYXJndW1lbnRzIHdpbGwgYmUgcHJvdmlkZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVmZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSB0aW1lciBpZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kZWZlcihmdW5jdGlvbih0ZXh0KSB7IGNvbnNvbGUubG9nKHRleHQpOyB9LCAnZGVmZXJyZWQnKTsKICAgICAqIC8vIGxvZ3MgJ2RlZmVycmVkJyBhZnRlciBvbmUgb3IgbW9yZSBtaWxsaXNlY29uZHMKICAgICAqLwogICAgZnVuY3Rpb24gZGVmZXIoZnVuYykgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBhcmdzID0gc2xpY2UoYXJndW1lbnRzLCAxKTsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgMSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBFeGVjdXRlcyB0aGUgYGZ1bmNgIGZ1bmN0aW9uIGFmdGVyIGB3YWl0YCBtaWxsaXNlY29uZHMuIEFkZGl0aW9uYWwgYXJndW1lbnRzCiAgICAgKiB3aWxsIGJlIHByb3ZpZGVkIHRvIGBmdW5jYCB3aGVuIGl0IGlzIGludm9rZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdhaXQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZGVsYXkgZXhlY3V0aW9uLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gaW52b2tlIHRoZSBmdW5jdGlvbiB3aXRoLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgdGltZXIgaWQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZGVsYXkoZnVuY3Rpb24odGV4dCkgeyBjb25zb2xlLmxvZyh0ZXh0KTsgfSwgMTAwMCwgJ2xhdGVyJyk7CiAgICAgKiAvLyA9PiBsb2dzICdsYXRlcicgYWZ0ZXIgb25lIHNlY29uZAogICAgICovCiAgICBmdW5jdGlvbiBkZWxheShmdW5jLCB3YWl0KSB7CiAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgdmFyIGFyZ3MgPSBzbGljZShhcmd1bWVudHMsIDIpOwogICAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpIHsgZnVuYy5hcHBseSh1bmRlZmluZWQsIGFyZ3MpOyB9LCB3YWl0KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IG1lbW9pemVzIHRoZSByZXN1bHQgb2YgYGZ1bmNgLiBJZiBgcmVzb2x2ZXJgIGlzCiAgICAgKiBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSBjYWNoZSBrZXkgZm9yIHN0b3JpbmcgdGhlIHJlc3VsdAogICAgICogYmFzZWQgb24gdGhlIGFyZ3VtZW50cyBwcm92aWRlZCB0byB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uIEJ5IGRlZmF1bHQsIHRoZQogICAgICogZmlyc3QgYXJndW1lbnQgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGNhY2hlIGtleS4KICAgICAqIFRoZSBgZnVuY2AgaXMgZXhlY3V0ZWQgd2l0aCB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIG1lbW9pemVkIGZ1bmN0aW9uLgogICAgICogVGhlIHJlc3VsdCBjYWNoZSBpcyBleHBvc2VkIGFzIHRoZSBgY2FjaGVgIHByb3BlcnR5IG9uIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gaGF2ZSBpdHMgb3V0cHV0IG1lbW9pemVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW3Jlc29sdmVyXSBBIGZ1bmN0aW9uIHVzZWQgdG8gcmVzb2x2ZSB0aGUgY2FjaGUga2V5LgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgbWVtb2l6aW5nIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZmlib25hY2NpID0gXy5tZW1vaXplKGZ1bmN0aW9uKG4pIHsKICAgICAqICAgcmV0dXJuIG4gPCAyID8gbiA6IGZpYm9uYWNjaShuIC0gMSkgKyBmaWJvbmFjY2kobiAtIDIpOwogICAgICogfSk7CiAgICAgKgogICAgICogZmlib25hY2NpKDkpCiAgICAgKiAvLyA9PiAzNAogICAgICoKICAgICAqIHZhciBkYXRhID0gewogICAgICogICAnZnJlZCc6IHsgJ25hbWUnOiAnZnJlZCcsICdhZ2UnOiA0MCB9LAogICAgICogICAncGViYmxlcyc6IHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqIH07CiAgICAgKgogICAgICogLy8gbW9kaWZ5aW5nIHRoZSByZXN1bHQgY2FjaGUKICAgICAqIHZhciBnZXQgPSBfLm1lbW9pemUoZnVuY3Rpb24obmFtZSkgeyByZXR1cm4gZGF0YVtuYW1lXTsgfSwgXy5pZGVudGl0eSk7CiAgICAgKiBnZXQoJ3BlYmJsZXMnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqCiAgICAgKiBnZXQuY2FjaGUucGViYmxlcy5uYW1lID0gJ3BlbmVsb3BlJzsKICAgICAqIGdldCgncGViYmxlcycpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdwZW5lbG9wZScsICdhZ2UnOiAxIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBtZW1vaXplZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWNoZSA9IG1lbW9pemVkLmNhY2hlLAogICAgICAgICAgICBrZXkgPSByZXNvbHZlciA/IHJlc29sdmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBrZXlQcmVmaXggKyBhcmd1bWVudHNbMF07CgogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICB9CiAgICAgIG1lbW9pemVkLmNhY2hlID0ge307CiAgICAgIHJldHVybiBtZW1vaXplZDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICAgKiB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHZhbHVlIG9mIHRoZSBmaXJzdCBjYWxsLiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkCiAgICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9uY2UoZnVuYykgewogICAgICB2YXIgcmFuLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHJhbikgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmFuID0gdHJ1ZTsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBuZXcgZnVuY3Rpb24uIFRoaXMKICAgICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgbmFtZTsgfTsKICAgICAqIHZhciBoaSA9IF8ucGFydGlhbChncmVldCwgJ2hpJyk7CiAgICAgKiBoaSgnZnJlZCcpOwogICAgICogLy8gPT4gJ2hpIGZyZWQnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnRpYWwoZnVuYykgewogICAgICByZXR1cm4gY3JlYXRlV3JhcHBlcihmdW5jLCAxNiwgc2xpY2UoYXJndW1lbnRzLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnBhcnRpYWxgIGV4Y2VwdCB0aGF0IGBwYXJ0aWFsYCBhcmd1bWVudHMgYXJlCiAgICAgKiBhcHBlbmRlZCB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGRlZmF1bHRzRGVlcCA9IF8ucGFydGlhbFJpZ2h0KF8ubWVyZ2UsIF8uZGVmYXVsdHMpOwogICAgICoKICAgICAqIHZhciBvcHRpb25zID0gewogICAgICogICAndmFyaWFibGUnOiAnZGF0YScsCiAgICAgKiAgICdpbXBvcnRzJzogeyAnanEnOiAkIH0KICAgICAqIH07CiAgICAgKgogICAgICogZGVmYXVsdHNEZWVwKG9wdGlvbnMsIF8udGVtcGxhdGVTZXR0aW5ncyk7CiAgICAgKgogICAgICogb3B0aW9ucy52YXJpYWJsZQogICAgICogLy8gPT4gJ2RhdGEnCiAgICAgKgogICAgICogb3B0aW9ucy5pbXBvcnRzCiAgICAgKiAvLyA9PiB7ICdfJzogXywgJ2pxJzogJCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnRpYWxSaWdodChmdW5jKSB7CiAgICAgIHJldHVybiBjcmVhdGVXcmFwcGVyKGZ1bmMsIDMyLCBudWxsLCBzbGljZShhcmd1bWVudHMsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0LCB3aGVuIGV4ZWN1dGVkLCB3aWxsIG9ubHkgY2FsbCB0aGUgYGZ1bmNgIGZ1bmN0aW9uCiAgICAgKiBhdCBtb3N0IG9uY2UgcGVyIGV2ZXJ5IGB3YWl0YCBtaWxsaXNlY29uZHMuIFByb3ZpZGUgYW4gb3B0aW9ucyBvYmplY3QgdG8KICAgICAqIGluZGljYXRlIHRoYXQgYGZ1bmNgIHNob3VsZCBiZSBpbnZva2VkIG9uIHRoZSBsZWFkaW5nIGFuZC9vciB0cmFpbGluZyBlZGdlCiAgICAgKiBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMgdG8gdGhlIHRocm90dGxlZCBmdW5jdGlvbiB3aWxsCiAgICAgKiByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgICAqCiAgICAgKiBOb3RlOiBJZiBgbGVhZGluZ2AgYW5kIGB0cmFpbGluZ2Agb3B0aW9ucyBhcmUgYHRydWVgIGBmdW5jYCB3aWxsIGJlIGNhbGxlZAogICAgICogb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQgb25seSBpZiB0aGUgdGhlIHRocm90dGxlZCBmdW5jdGlvbiBpcwogICAgICogaW52b2tlZCBtb3JlIHRoYW4gb25jZSBkdXJpbmcgdGhlIGB3YWl0YCB0aW1lb3V0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byB0aHJvdHRsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHRocm90dGxlIGV4ZWN1dGlvbnMgdG8uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMubGVhZGluZz10cnVlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgbGVhZGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0LgogICAgICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy50cmFpbGluZz10cnVlXSBTcGVjaWZ5IGV4ZWN1dGlvbiBvbiB0aGUgdHJhaWxpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IHRocm90dGxlZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogLy8gYXZvaWQgZXhjZXNzaXZlbHkgdXBkYXRpbmcgdGhlIHBvc2l0aW9uIHdoaWxlIHNjcm9sbGluZwogICAgICogdmFyIHRocm90dGxlZCA9IF8udGhyb3R0bGUodXBkYXRlUG9zaXRpb24sIDEwMCk7CiAgICAgKiBqUXVlcnkod2luZG93KS5vbignc2Nyb2xsJywgdGhyb3R0bGVkKTsKICAgICAqCiAgICAgKiAvLyBleGVjdXRlIGByZW5ld1Rva2VuYCB3aGVuIHRoZSBjbGljayBldmVudCBpcyBmaXJlZCwgYnV0IG5vdCBtb3JlIHRoYW4gb25jZSBldmVyeSA1IG1pbnV0ZXMKICAgICAqIGpRdWVyeSgnLmludGVyYWN0aXZlJykub24oJ2NsaWNrJywgXy50aHJvdHRsZShyZW5ld1Rva2VuLCAzMDAwMDAsIHsKICAgICAqICAgJ3RyYWlsaW5nJzogZmFsc2UKICAgICAqIH0pKTsKICAgICAqLwogICAgZnVuY3Rpb24gdGhyb3R0bGUoZnVuYywgd2FpdCwgb3B0aW9ucykgewogICAgICB2YXIgbGVhZGluZyA9IHRydWUsCiAgICAgICAgICB0cmFpbGluZyA9IHRydWU7CgogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zID09PSBmYWxzZSkgewogICAgICAgIGxlYWRpbmcgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIGxlYWRpbmcgPSAnbGVhZGluZycgaW4gb3B0aW9ucyA/IG9wdGlvbnMubGVhZGluZyA6IGxlYWRpbmc7CiAgICAgICAgdHJhaWxpbmcgPSAndHJhaWxpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLnRyYWlsaW5nIDogdHJhaWxpbmc7CiAgICAgIH0KICAgICAgZGVib3VuY2VPcHRpb25zLmxlYWRpbmcgPSBsZWFkaW5nOwogICAgICBkZWJvdW5jZU9wdGlvbnMubWF4V2FpdCA9IHdhaXQ7CiAgICAgIGRlYm91bmNlT3B0aW9ucy50cmFpbGluZyA9IHRyYWlsaW5nOwoKICAgICAgcmV0dXJuIGRlYm91bmNlKGZ1bmMsIHdhaXQsIGRlYm91bmNlT3B0aW9ucyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBwcm92aWRlcyBgdmFsdWVgIHRvIHRoZSB3cmFwcGVyIGZ1bmN0aW9uIGFzIGl0cwogICAgICogZmlyc3QgYXJndW1lbnQuIEFkZGl0aW9uYWwgYXJndW1lbnRzIHByb3ZpZGVkIHRvIHRoZSBmdW5jdGlvbiBhcmUgYXBwZW5kZWQKICAgICAqIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSB3cmFwcGVyIGZ1bmN0aW9uLiBUaGUgd3JhcHBlciBpcyBleGVjdXRlZCB3aXRoCiAgICAgKiB0aGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSB3cmFwcGVyIFRoZSB3cmFwcGVyIGZ1bmN0aW9uLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBwID0gXy53cmFwKF8uZXNjYXBlLCBmdW5jdGlvbihmdW5jLCB0ZXh0KSB7CiAgICAgKiAgIHJldHVybiAnPHA+JyArIGZ1bmModGV4dCkgKyAnPC9wPic7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBwKCdGcmVkLCBXaWxtYSwgJiBQZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnPHA+RnJlZCwgV2lsbWEsICZhbXA7IFBlYmJsZXM8L3A+JwogICAgICovCiAgICBmdW5jdGlvbiB3cmFwKHZhbHVlLCB3cmFwcGVyKSB7CiAgICAgIHJldHVybiBjcmVhdGVXcmFwcGVyKHdyYXBwZXIsIDE2LCBbdmFsdWVdKTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYHZhbHVlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcmV0dXJuIGZyb20gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0geyAnbmFtZSc6ICdmcmVkJyB9OwogICAgICogdmFyIGdldHRlciA9IF8uY29uc3RhbnQob2JqZWN0KTsKICAgICAqIGdldHRlcigpID09PSBvYmplY3Q7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbnN0YW50KHZhbHVlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIGNhbGxiYWNrIGJvdW5kIHRvIGFuIG9wdGlvbmFsIGB0aGlzQXJnYC4gSWYgYGZ1bmNgIGlzIGEgcHJvcGVydHkKICAgICAqIG5hbWUgdGhlIGNyZWF0ZWQgY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIGZvciBhIGdpdmVuIGVsZW1lbnQuCiAgICAgKiBJZiBgZnVuY2AgaXMgYW4gb2JqZWN0IHRoZSBjcmVhdGVkIGNhbGxiYWNrIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMKICAgICAqIHRoYXQgY29udGFpbiB0aGUgZXF1aXZhbGVudCBvYmplY3QgcHJvcGVydGllcywgb3RoZXJ3aXNlIGl0IHdpbGwgcmV0dXJuIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7Kn0gW2Z1bmM9aWRlbnRpdHldIFRoZSB2YWx1ZSB0byBjb252ZXJ0IHRvIGEgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyZ0NvdW50XSBUaGUgbnVtYmVyIG9mIGFyZ3VtZW50cyB0aGUgY2FsbGJhY2sgYWNjZXB0cy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBhIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB3cmFwIHRvIGNyZWF0ZSBjdXN0b20gY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICogXy5jcmVhdGVDYWxsYmFjayA9IF8ud3JhcChfLmNyZWF0ZUNhbGxiYWNrLCBmdW5jdGlvbihmdW5jLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICogICB2YXIgbWF0Y2ggPSAvXiguKz8pX18oW2dsXXQpKC4rKSQvLmV4ZWMoY2FsbGJhY2spOwogICAgICogICByZXR1cm4gIW1hdGNoID8gZnVuYyhjYWxsYmFjaywgdGhpc0FyZykgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAqICAgICByZXR1cm4gbWF0Y2hbMl0gPT0gJ2d0JyA/IG9iamVjdFttYXRjaFsxXV0gPiBtYXRjaFszXSA6IG9iamVjdFttYXRjaFsxXV0gPCBtYXRjaFszXTsKICAgICAqICAgfTsKICAgICAqIH0pOwogICAgICoKICAgICAqIF8uZmlsdGVyKGNoYXJhY3RlcnMsICdhZ2VfX2d0MzgnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2ZyZWQnLCAnYWdlJzogNDAgfV0KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYXJnQ291bnQpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgICAgaWYgKGZ1bmMgPT0gbnVsbCB8fCB0eXBlID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KTsKICAgICAgfQogICAgICAvLyBoYW5kbGUgIl8ucGx1Y2siIHN0eWxlIGNhbGxiYWNrIHNob3J0aGFuZHMKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gcHJvcGVydHkoZnVuYyk7CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKSwKICAgICAgICAgIGtleSA9IHByb3BzWzBdLAogICAgICAgICAgYSA9IGZ1bmNba2V5XTsKCiAgICAgIC8vIGhhbmRsZSAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICBpZiAocHJvcHMubGVuZ3RoID09IDEgJiYgYSA9PT0gYSAmJiAhaXNPYmplY3QoYSkpIHsKICAgICAgICAvLyBmYXN0IHBhdGggdGhlIGNvbW1vbiBjYXNlIG9mIHByb3ZpZGluZyBhbiBvYmplY3Qgd2l0aCBhIHNpbmdsZQogICAgICAgIC8vIHByb3BlcnR5IGNvbnRhaW5pbmcgYSBwcmltaXRpdmUgdmFsdWUKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB2YXIgYiA9IG9iamVjdFtrZXldOwogICAgICAgICAgcmV0dXJuIGEgPT09IGIgJiYgKGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwob2JqZWN0W3Byb3BzW2xlbmd0aF1dLCBmdW5jW3Byb3BzW2xlbmd0aF1dLCBudWxsLCB0cnVlKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgY2hhcmFjdGVycyBgJmAsIGA8YCwgYD5gLCBgImAsIGFuZCBgJ2AgaW4gYHN0cmluZ2AgdG8gdGhlaXIKICAgICAqIGNvcnJlc3BvbmRpbmcgSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IHN0cmluZyBUaGUgc3RyaW5nIHRvIGVzY2FwZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIGVzY2FwZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmVzY2FwZSgnRnJlZCwgV2lsbWEsICYgUGViYmxlcycpOwogICAgICogLy8gPT4gJ0ZyZWQsIFdpbG1hLCAmYW1wOyBQZWJibGVzJwogICAgICovCiAgICBmdW5jdGlvbiBlc2NhcGUoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZShyZVVuZXNjYXBlZEh0bWwsIGVzY2FwZUh0bWxDaGFyKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIHJldHVybnMgdGhlIGZpcnN0IGFyZ3VtZW50IHByb3ZpZGVkIHRvIGl0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIEFueSB2YWx1ZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKiBfLmlkZW50aXR5KG9iamVjdCkgPT09IG9iamVjdDsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaWRlbnRpdHkodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQWRkcyBmdW5jdGlvbiBwcm9wZXJ0aWVzIG9mIGEgc291cmNlIG9iamVjdCB0byB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogSWYgYG9iamVjdGAgaXMgYSBmdW5jdGlvbiBtZXRob2RzIHdpbGwgYmUgYWRkZWQgdG8gaXRzIHByb3RvdHlwZSBhcyB3ZWxsLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdH0gW29iamVjdD1sb2Rhc2hdIG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgb2JqZWN0IG9mIGZ1bmN0aW9ucyB0byBhZGQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMuY2hhaW49dHJ1ZV0gU3BlY2lmeSB3aGV0aGVyIHRoZSBmdW5jdGlvbnMgYWRkZWQgYXJlIGNoYWluYWJsZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gY2FwaXRhbGl6ZShzdHJpbmcpIHsKICAgICAqICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogfQogICAgICoKICAgICAqIF8ubWl4aW4oeyAnY2FwaXRhbGl6ZSc6IGNhcGl0YWxpemUgfSk7CiAgICAgKiBfLmNhcGl0YWxpemUoJ2ZyZWQnKTsKICAgICAqIC8vID0+ICdGcmVkJwogICAgICoKICAgICAqIF8oJ2ZyZWQnKS5jYXBpdGFsaXplKCkudmFsdWUoKTsKICAgICAqIC8vID0+ICdGcmVkJwogICAgICoKICAgICAqIF8ubWl4aW4oeyAnY2FwaXRhbGl6ZSc6IGNhcGl0YWxpemUgfSwgeyAnY2hhaW4nOiBmYWxzZSB9KTsKICAgICAqIF8oJ2ZyZWQnKS5jYXBpdGFsaXplKCk7CiAgICAgKiAvLyA9PiAnRnJlZCcKICAgICAqLwogICAgZnVuY3Rpb24gbWl4aW4ob2JqZWN0LCBzb3VyY2UsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNoYWluID0gdHJ1ZSwKICAgICAgICAgIG1ldGhvZE5hbWVzID0gc291cmNlICYmIGZ1bmN0aW9ucyhzb3VyY2UpOwoKICAgICAgaWYgKCFzb3VyY2UgfHwgKCFvcHRpb25zICYmICFtZXRob2ROYW1lcy5sZW5ndGgpKSB7CiAgICAgICAgaWYgKG9wdGlvbnMgPT0gbnVsbCkgewogICAgICAgICAgb3B0aW9ucyA9IHNvdXJjZTsKICAgICAgICB9CiAgICAgICAgY3RvciA9IGxvZGFzaFdyYXBwZXI7CiAgICAgICAgc291cmNlID0gb2JqZWN0OwogICAgICAgIG9iamVjdCA9IGxvZGFzaDsKICAgICAgICBtZXRob2ROYW1lcyA9IGZ1bmN0aW9ucyhzb3VyY2UpOwogICAgICB9CiAgICAgIGlmIChvcHRpb25zID09PSBmYWxzZSkgewogICAgICAgIGNoYWluID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykgJiYgJ2NoYWluJyBpbiBvcHRpb25zKSB7CiAgICAgICAgY2hhaW4gPSBvcHRpb25zLmNoYWluOwogICAgICB9CiAgICAgIHZhciBjdG9yID0gb2JqZWN0LAogICAgICAgICAgaXNGdW5jID0gaXNGdW5jdGlvbihjdG9yKTsKCiAgICAgIGZvckVhY2gobWV0aG9kTmFtZXMsIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgICB2YXIgZnVuYyA9IG9iamVjdFttZXRob2ROYW1lXSA9IHNvdXJjZVttZXRob2ROYW1lXTsKICAgICAgICBpZiAoaXNGdW5jKSB7CiAgICAgICAgICBjdG9yLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY2hhaW5BbGwgPSB0aGlzLl9fY2hhaW5fXywKICAgICAgICAgICAgICAgIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXywKICAgICAgICAgICAgICAgIGFyZ3MgPSBbdmFsdWVdOwoKICAgICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShvYmplY3QsIGFyZ3MpOwogICAgICAgICAgICBpZiAoY2hhaW4gfHwgY2hhaW5BbGwpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IHJlc3VsdCAmJiBpc09iamVjdChyZXN1bHQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IGN0b3IocmVzdWx0KTsKICAgICAgICAgICAgICByZXN1bHQuX19jaGFpbl9fID0gY2hhaW5BbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldmVydHMgdGhlICdfJyB2YXJpYWJsZSB0byBpdHMgcHJldmlvdXMgdmFsdWUgYW5kIHJldHVybnMgYSByZWZlcmVuY2UgdG8KICAgICAqIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBgbG9kYXNoYCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGxvZGFzaCA9IF8ubm9Db25mbGljdCgpOwogICAgICovCiAgICBmdW5jdGlvbiBub0NvbmZsaWN0KCkgewogICAgICBjb250ZXh0Ll8gPSBvbGREYXNoOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIEEgbm8tb3BlcmF0aW9uIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBvYmplY3QgPSB7ICduYW1lJzogJ2ZyZWQnIH07CiAgICAgKiBfLm5vb3Aob2JqZWN0KSA9PT0gdW5kZWZpbmVkOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBub29wKCkgewogICAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgaGF2ZSBlbGFwc2VkIHNpbmNlIHRoZSBVbml4IGVwb2NoCiAgICAgKiAoMSBKYW51YXJ5IDE5NzAgMDA6MDA6MDAgVVRDKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3RhbXAgPSBfLm5vdygpOwogICAgICogXy5kZWZlcihmdW5jdGlvbigpIHsgY29uc29sZS5sb2coXy5ub3coKSAtIHN0YW1wKTsgfSk7CiAgICAgKiAvLyA9PiBsb2dzIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGl0IHRvb2sgZm9yIHRoZSBkZWZlcnJlZCBmdW5jdGlvbiB0byBiZSBjYWxsZWQKICAgICAqLwogICAgdmFyIG5vdyA9IGlzTmF0aXZlKG5vdyA9IERhdGUubm93KSAmJiBub3cgfHwgZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gdmFsdWUgaW50byBhbiBpbnRlZ2VyIG9mIHRoZSBzcGVjaWZpZWQgcmFkaXguCiAgICAgKiBJZiBgcmFkaXhgIGlzIGB1bmRlZmluZWRgIG9yIGAwYCBhIGByYWRpeGAgb2YgYDEwYCBpcyB1c2VkIHVubGVzcyB0aGUKICAgICAqIGB2YWx1ZWAgaXMgYSBoZXhhZGVjaW1hbCwgaW4gd2hpY2ggY2FzZSBhIGByYWRpeGAgb2YgYDE2YCBpcyB1c2VkLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGF2b2lkcyBkaWZmZXJlbmNlcyBpbiBuYXRpdmUgRVMzIGFuZCBFUzUgYHBhcnNlSW50YAogICAgICogaW1wbGVtZW50YXRpb25zLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI0UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFyc2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl4XSBUaGUgcmFkaXggdXNlZCB0byBpbnRlcnByZXQgdGhlIHZhbHVlIHRvIHBhcnNlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbmV3IGludGVnZXIgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFyc2VJbnQoJzA4Jyk7CiAgICAgKiAvLyA9PiA4CiAgICAgKi8KICAgIHZhciBwYXJzZUludCA9IG5hdGl2ZVBhcnNlSW50KHdoaXRlc3BhY2UgKyAnMDgnKSA9PSA4ID8gbmF0aXZlUGFyc2VJbnQgOiBmdW5jdGlvbih2YWx1ZSwgcmFkaXgpIHsKICAgICAgLy8gRmlyZWZveCA8IDIxIGFuZCBPcGVyYSA8IDE1IGZvbGxvdyB0aGUgRVMzIHNwZWNpZmllZCBpbXBsZW1lbnRhdGlvbiBvZiBgcGFyc2VJbnRgCiAgICAgIHJldHVybiBuYXRpdmVQYXJzZUludChpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKHJlTGVhZGluZ1NwYWNlc0FuZFplcm9zLCAnJykgOiB2YWx1ZSwgcmFkaXggfHwgMCk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhICJfLnBsdWNrIiBzdHlsZSBmdW5jdGlvbiwgd2hpY2ggcmV0dXJucyB0aGUgYGtleWAgdmFsdWUgb2YgYQogICAgICogZ2l2ZW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byByZXRyaWV2ZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY2hhcmFjdGVycyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfQogICAgICogXTsKICAgICAqCiAgICAgKiB2YXIgZ2V0TmFtZSA9IF8ucHJvcGVydHkoJ25hbWUnKTsKICAgICAqCiAgICAgKiBfLm1hcChjaGFyYWN0ZXJzLCBnZXROYW1lKTsKICAgICAqIC8vID0+IFsnYmFybmV5JywgJ2ZyZWQnXQogICAgICoKICAgICAqIF8uc29ydEJ5KGNoYXJhY3RlcnMsIGdldE5hbWUpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHByb3BlcnR5KGtleSkgewogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIG9iamVjdFtrZXldOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUHJvZHVjZXMgYSByYW5kb20gbnVtYmVyIGJldHdlZW4gYG1pbmAgYW5kIGBtYXhgIChpbmNsdXNpdmUpLiBJZiBvbmx5IG9uZQogICAgICogYXJndW1lbnQgaXMgcHJvdmlkZWQgYSBudW1iZXIgYmV0d2VlbiBgMGAgYW5kIHRoZSBnaXZlbiBudW1iZXIgd2lsbCBiZQogICAgICogcmV0dXJuZWQuIElmIGBmbG9hdGluZ2AgaXMgdHJ1ZXkgb3IgZWl0aGVyIGBtaW5gIG9yIGBtYXhgIGFyZSBmbG9hdHMgYQogICAgICogZmxvYXRpbmctcG9pbnQgbnVtYmVyIHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZCBvZiBhbiBpbnRlZ2VyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW21pbj0wXSBUaGUgbWluaW11bSBwb3NzaWJsZSB2YWx1ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4PTFdIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHBhcmFtIHtib29sZWFufSBbZmxvYXRpbmc9ZmFsc2VdIFNwZWNpZnkgcmV0dXJuaW5nIGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyBhIHJhbmRvbSBudW1iZXIuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZG9tKDAsIDUpOwogICAgICogLy8gPT4gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1KTsKICAgICAqIC8vID0+IGFsc28gYW4gaW50ZWdlciBiZXR3ZWVuIDAgYW5kIDUKICAgICAqCiAgICAgKiBfLnJhbmRvbSg1LCB0cnVlKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDEuMiwgNS4yKTsKICAgICAqIC8vID0+IGEgZmxvYXRpbmctcG9pbnQgbnVtYmVyIGJldHdlZW4gMS4yIGFuZCA1LjIKICAgICAqLwogICAgZnVuY3Rpb24gcmFuZG9tKG1pbiwgbWF4LCBmbG9hdGluZykgewogICAgICB2YXIgbm9NaW4gPSBtaW4gPT0gbnVsbCwKICAgICAgICAgIG5vTWF4ID0gbWF4ID09IG51bGw7CgogICAgICBpZiAoZmxvYXRpbmcgPT0gbnVsbCkgewogICAgICAgIGlmICh0eXBlb2YgbWluID09ICdib29sZWFuJyAmJiBub01heCkgewogICAgICAgICAgZmxvYXRpbmcgPSBtaW47CiAgICAgICAgICBtaW4gPSAxOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghbm9NYXggJiYgdHlwZW9mIG1heCA9PSAnYm9vbGVhbicpIHsKICAgICAgICAgIGZsb2F0aW5nID0gbWF4OwogICAgICAgICAgbm9NYXggPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAobm9NaW4gJiYgbm9NYXgpIHsKICAgICAgICBtYXggPSAxOwogICAgICB9CiAgICAgIG1pbiA9ICttaW4gfHwgMDsKICAgICAgaWYgKG5vTWF4KSB7CiAgICAgICAgbWF4ID0gbWluOwogICAgICAgIG1pbiA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWF4ID0gK21heCB8fCAwOwogICAgICB9CiAgICAgIGlmIChmbG9hdGluZyB8fCBtaW4gJSAxIHx8IG1heCAlIDEpIHsKICAgICAgICB2YXIgcmFuZCA9IG5hdGl2ZVJhbmRvbSgpOwogICAgICAgIHJldHVybiBuYXRpdmVNaW4obWluICsgKHJhbmQgKiAobWF4IC0gbWluICsgcGFyc2VGbG9hdCgnMWUtJyArICgocmFuZCArJycpLmxlbmd0aCAtIDEpKSkpLCBtYXgpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlUmFuZG9tKG1pbiwgbWF4KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSB2YWx1ZSBvZiBwcm9wZXJ0eSBga2V5YCBvbiBgb2JqZWN0YC4gSWYgYGtleWAgaXMgYSBmdW5jdGlvbgogICAgICogaXQgd2lsbCBiZSBpbnZva2VkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBvYmplY3RgIGFuZCBpdHMgcmVzdWx0IHJldHVybmVkLAogICAgICogZWxzZSB0aGUgcHJvcGVydHkgdmFsdWUgaXMgcmV0dXJuZWQuIElmIGBvYmplY3RgIGlzIGZhbHNleSB0aGVuIGB1bmRlZmluZWRgCiAgICAgKiBpcyByZXR1cm5lZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IFRoZSBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB0byByZXNvbHZlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgcmV0dXJuICdub25zZW5zZSc7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgICAqIC8vID0+ICdub25zZW5zZScKICAgICAqLwogICAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwga2V5KSB7CiAgICAgIGlmIChvYmplY3QpIHsKICAgICAgICB2YXIgdmFsdWUgPSBvYmplY3Rba2V5XTsKICAgICAgICByZXR1cm4gaXNGdW5jdGlvbih2YWx1ZSkgPyBvYmplY3Rba2V5XSgpIDogdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgICAqIHdoaXRlc3BhY2UsIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogICAgICoKICAgICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCwgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHByZWNvbXBpbGluZyB0ZW1wbGF0ZXMgc2VlOgogICAgICogaHR0cDovL2xvZGFzaC5jb20vY3VzdG9tLWJ1aWxkcwogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIENocm9tZSBleHRlbnNpb24gc2FuZGJveGVzIHNlZToKICAgICAqIGh0dHA6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS9zdGFibGUvZXh0ZW5zaW9ucy9zYW5kYm94aW5nRXZhbC5odG1sCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IFRoZSB0ZW1wbGF0ZSB0ZXh0LgogICAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgVGhlIGRhdGEgb2JqZWN0IHVzZWQgdG8gcG9wdWxhdGUgdGhlIHRleHQuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIG9iamVjdC4KICAgICAqIEBwYXJhbSB7UmVnRXhwfSBbb3B0aW9ucy5lc2NhcGVdIFRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuZXZhbHVhdGVdIFRoZSAiZXZhbHVhdGUiIGRlbGltaXRlci4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy5pbXBvcnRzXSBBbiBvYmplY3QgdG8gaW1wb3J0IGludG8gdGhlIHRlbXBsYXRlIGFzIGxvY2FsIHZhcmlhYmxlcy4KICAgICAqIEBwYXJhbSB7UmVnRXhwfSBbb3B0aW9ucy5pbnRlcnBvbGF0ZV0gVGhlICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFtzb3VyY2VVUkxdIFRoZSBzb3VyY2VVUkwgb2YgdGhlIHRlbXBsYXRlJ3MgY29tcGlsZWQgc291cmNlLgogICAgICogQHBhcmFtIHtzdHJpbmd9IFt2YXJpYWJsZV0gVGhlIGRhdGEgb2JqZWN0IHZhcmlhYmxlIG5hbWUuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb258c3RyaW5nfSBSZXR1cm5zIGEgY29tcGlsZWQgZnVuY3Rpb24gd2hlbiBubyBgZGF0YWAgb2JqZWN0CiAgICAgKiAgaXMgZ2l2ZW4sIGVsc2UgaXQgcmV0dXJucyB0aGUgaW50ZXJwb2xhdGVkIHRleHQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiaW50ZXJwb2xhdGUiIGRlbGltaXRlciB0byBjcmVhdGUgYSBjb21waWxlZCB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nKTsKICAgICAqIGNvbXBpbGVkKHsgJ25hbWUnOiAnZnJlZCcgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gZnJlZCcKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImVzY2FwZSIgZGVsaW1pdGVyIHRvIGVzY2FwZSBIVE1MIGluIGRhdGEgcHJvcGVydHkgdmFsdWVzCiAgICAgKiBfLnRlbXBsYXRlKCc8Yj48JS0gdmFsdWUgJT48L2I+JywgeyAndmFsdWUnOiAnPHNjcmlwdD4nIH0pOwogICAgICogLy8gPT4gJzxiPiZsdDtzY3JpcHQmZ3Q7PC9iPicKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImV2YWx1YXRlIiBkZWxpbWl0ZXIgdG8gZ2VuZXJhdGUgSFRNTAogICAgICogdmFyIGxpc3QgPSAnPCUgXy5mb3JFYWNoKHBlb3BsZSwgZnVuY3Rpb24obmFtZSkgeyAlPjxsaT48JS0gbmFtZSAlPjwvbGk+PCUgfSk7ICU+JzsKICAgICAqIF8udGVtcGxhdGUobGlzdCwgeyAncGVvcGxlJzogWydmcmVkJywgJ2Jhcm5leSddIH0pOwogICAgICogLy8gPT4gJzxsaT5mcmVkPC9saT48bGk+YmFybmV5PC9saT4nCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIEVTNiBkZWxpbWl0ZXIgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmF1bHQgImludGVycG9sYXRlIiBkZWxpbWl0ZXIKICAgICAqIF8udGVtcGxhdGUoJ2hlbGxvICR7IG5hbWUgfScsIHsgJ25hbWUnOiAncGViYmxlcycgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gcGViYmxlcycKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGUoJzwlIHByaW50KCJoZWxsbyAiICsgbmFtZSk7ICU+IScsIHsgJ25hbWUnOiAnYmFybmV5JyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBiYXJuZXkhJwogICAgICoKICAgICAqIC8vIHVzaW5nIGEgY3VzdG9tIHRlbXBsYXRlIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGVTZXR0aW5ncyA9IHsKICAgICAqICAgJ2ludGVycG9sYXRlJzogL3t7KFtcc1xTXSs/KX19L2cKICAgICAqIH07CiAgICAgKgogICAgICogXy50ZW1wbGF0ZSgnaGVsbG8ge3sgbmFtZSB9fSEnLCB7ICduYW1lJzogJ211c3RhY2hlJyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBtdXN0YWNoZSEnCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGBpbXBvcnRzYCBvcHRpb24gdG8gaW1wb3J0IGpRdWVyeQogICAgICogdmFyIGxpc3QgPSAnPCUganEuZWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCUtIG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnZnJlZCcsICdiYXJuZXknXSB9LCB7ICdpbXBvcnRzJzogeyAnanEnOiBqUXVlcnkgfSB9KTsKICAgICAqIC8vID0+ICc8bGk+ZnJlZDwvbGk+PGxpPmJhcm5leTwvbGk+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgc291cmNlVVJMYCBvcHRpb24gdG8gc3BlY2lmeSBhIGN1c3RvbSBzb3VyY2VVUkwgZm9yIHRoZSB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGVsbG8gPCU9IG5hbWUgJT4nLCBudWxsLCB7ICdzb3VyY2VVUkwnOiAnL2Jhc2ljL2dyZWV0aW5nLmpzdCcgfSk7CiAgICAgKiBjb21waWxlZChkYXRhKTsKICAgICAqIC8vID0+IGZpbmQgdGhlIHNvdXJjZSBvZiAiZ3JlZXRpbmcuanN0IiB1bmRlciB0aGUgU291cmNlcyB0YWIgb3IgUmVzb3VyY2VzIHBhbmVsIG9mIHRoZSB3ZWIgaW5zcGVjdG9yCiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGB2YXJpYWJsZWAgb3B0aW9uIHRvIGVuc3VyZSBhIHdpdGgtc3RhdGVtZW50IGlzbid0IHVzZWQgaW4gdGhlIGNvbXBpbGVkIHRlbXBsYXRlCiAgICAgKiB2YXIgY29tcGlsZWQgPSBfLnRlbXBsYXRlKCdoaSA8JT0gZGF0YS5uYW1lICU+IScsIG51bGwsIHsgJ3ZhcmlhYmxlJzogJ2RhdGEnIH0pOwogICAgICogY29tcGlsZWQuc291cmNlOwogICAgICogLy8gPT4gZnVuY3Rpb24oZGF0YSkgewogICAgICogICB2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGU7CiAgICAgKiAgIF9fcCArPSAnaGkgJyArICgoX190ID0gKCBkYXRhLm5hbWUgKSkgPT0gbnVsbCA/ICcnIDogX190KSArICchJzsKICAgICAqICAgcmV0dXJuIF9fcDsKICAgICAqIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZWAgcHJvcGVydHkgdG8gaW5saW5lIGNvbXBpbGVkIHRlbXBsYXRlcyBmb3IgbWVhbmluZ2Z1bAogICAgICogLy8gbGluZSBudW1iZXJzIGluIGVycm9yIG1lc3NhZ2VzIGFuZCBhIHN0YWNrIHRyYWNlCiAgICAgKiBmcy53cml0ZUZpbGVTeW5jKHBhdGguam9pbihjd2QsICdqc3QuanMnKSwgJ1wKICAgICAqICAgdmFyIEpTVCA9IHtcCiAgICAgKiAgICAgIm1haW4iOiAnICsgXy50ZW1wbGF0ZShtYWluVGV4dCkuc291cmNlICsgJ1wKICAgICAqICAgfTtcCiAgICAgKiAnKTsKICAgICAqLwogICAgZnVuY3Rpb24gdGVtcGxhdGUodGV4dCwgZGF0YSwgb3B0aW9ucykgewogICAgICAvLyBiYXNlZCBvbiBKb2huIFJlc2lnJ3MgYHRtcGxgIGltcGxlbWVudGF0aW9uCiAgICAgIC8vIGh0dHA6Ly9lam9obi5vcmcvYmxvZy9qYXZhc2NyaXB0LW1pY3JvLXRlbXBsYXRpbmcvCiAgICAgIC8vIGFuZCBMYXVyYSBEb2t0b3JvdmEncyBkb1QuanMKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL29sYWRvL2RvVAogICAgICB2YXIgc2V0dGluZ3MgPSBsb2Rhc2gudGVtcGxhdGVTZXR0aW5nczsKICAgICAgdGV4dCA9IFN0cmluZyh0ZXh0IHx8ICcnKTsKCiAgICAgIC8vIGF2b2lkIG1pc3NpbmcgZGVwZW5kZW5jaWVzIHdoZW4gYGl0ZXJhdG9yVGVtcGxhdGVgIGlzIG5vdCBkZWZpbmVkCiAgICAgIG9wdGlvbnMgPSBkZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0dGluZ3MpOwoKICAgICAgdmFyIGltcG9ydHMgPSBkZWZhdWx0cyh7fSwgb3B0aW9ucy5pbXBvcnRzLCBzZXR0aW5ncy5pbXBvcnRzKSwKICAgICAgICAgIGltcG9ydHNLZXlzID0ga2V5cyhpbXBvcnRzKSwKICAgICAgICAgIGltcG9ydHNWYWx1ZXMgPSB2YWx1ZXMoaW1wb3J0cyk7CgogICAgICB2YXIgaXNFdmFsdWF0aW5nLAogICAgICAgICAgaW5kZXggPSAwLAogICAgICAgICAgaW50ZXJwb2xhdGUgPSBvcHRpb25zLmludGVycG9sYXRlIHx8IHJlTm9NYXRjaCwKICAgICAgICAgIHNvdXJjZSA9ICJfX3AgKz0gJyI7CgogICAgICAvLyBjb21waWxlIHRoZSByZWdleHAgdG8gbWF0Y2ggZWFjaCBkZWxpbWl0ZXIKICAgICAgdmFyIHJlRGVsaW1pdGVycyA9IFJlZ0V4cCgKICAgICAgICAob3B0aW9ucy5lc2NhcGUgfHwgcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICAgIGludGVycG9sYXRlLnNvdXJjZSArICd8JyArCiAgICAgICAgKGludGVycG9sYXRlID09PSByZUludGVycG9sYXRlID8gcmVFc1RlbXBsYXRlIDogcmVOb01hdGNoKS5zb3VyY2UgKyAnfCcgKwogICAgICAgIChvcHRpb25zLmV2YWx1YXRlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wkJwogICAgICAsICdnJyk7CgogICAgICB0ZXh0LnJlcGxhY2UocmVEZWxpbWl0ZXJzLCBmdW5jdGlvbihtYXRjaCwgZXNjYXBlVmFsdWUsIGludGVycG9sYXRlVmFsdWUsIGVzVGVtcGxhdGVWYWx1ZSwgZXZhbHVhdGVWYWx1ZSwgb2Zmc2V0KSB7CiAgICAgICAgaW50ZXJwb2xhdGVWYWx1ZSB8fCAoaW50ZXJwb2xhdGVWYWx1ZSA9IGVzVGVtcGxhdGVWYWx1ZSk7CgogICAgICAgIC8vIGVzY2FwZSBjaGFyYWN0ZXJzIHRoYXQgY2Fubm90IGJlIGluY2x1ZGVkIGluIHN0cmluZyBsaXRlcmFscwogICAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpLnJlcGxhY2UocmVVbmVzY2FwZWRTdHJpbmcsIGVzY2FwZVN0cmluZ0NoYXIpOwoKICAgICAgICAvLyByZXBsYWNlIGRlbGltaXRlcnMgd2l0aCBzbmlwcGV0cwogICAgICAgIGlmIChlc2NhcGVWYWx1ZSkgewogICAgICAgICAgc291cmNlICs9ICInICtcbl9fZSgiICsgZXNjYXBlVmFsdWUgKyAiKSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaWYgKGV2YWx1YXRlVmFsdWUpIHsKICAgICAgICAgIGlzRXZhbHVhdGluZyA9IHRydWU7CiAgICAgICAgICBzb3VyY2UgKz0gIic7XG4iICsgZXZhbHVhdGVWYWx1ZSArICI7XG5fX3AgKz0gJyI7CiAgICAgICAgfQogICAgICAgIGlmIChpbnRlcnBvbGF0ZVZhbHVlKSB7CiAgICAgICAgICBzb3VyY2UgKz0gIicgK1xuKChfX3QgPSAoIiArIGludGVycG9sYXRlVmFsdWUgKyAiKSkgPT0gbnVsbCA/ICcnIDogX190KSArXG4nIjsKICAgICAgICB9CiAgICAgICAgaW5kZXggPSBvZmZzZXQgKyBtYXRjaC5sZW5ndGg7CgogICAgICAgIC8vIHRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgcHJvZHVjdHMgcmVxdWlyZXMgcmV0dXJuaW5nIHRoZSBgbWF0Y2hgCiAgICAgICAgLy8gc3RyaW5nIGluIG9yZGVyIHRvIHByb2R1Y2UgdGhlIGNvcnJlY3QgYG9mZnNldGAgdmFsdWUKICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgIH0pOwoKICAgICAgc291cmNlICs9ICInO1xuIjsKCiAgICAgIC8vIGlmIGB2YXJpYWJsZWAgaXMgbm90IHNwZWNpZmllZCwgd3JhcCBhIHdpdGgtc3RhdGVtZW50IGFyb3VuZCB0aGUgZ2VuZXJhdGVkCiAgICAgIC8vIGNvZGUgdG8gYWRkIHRoZSBkYXRhIG9iamVjdCB0byB0aGUgdG9wIG9mIHRoZSBzY29wZSBjaGFpbgogICAgICB2YXIgdmFyaWFibGUgPSBvcHRpb25zLnZhcmlhYmxlLAogICAgICAgICAgaGFzVmFyaWFibGUgPSB2YXJpYWJsZTsKCiAgICAgIGlmICghaGFzVmFyaWFibGUpIHsKICAgICAgICB2YXJpYWJsZSA9ICdvYmonOwogICAgICAgIHNvdXJjZSA9ICd3aXRoICgnICsgdmFyaWFibGUgKyAnKSB7XG4nICsgc291cmNlICsgJ1xufVxuJzsKICAgICAgfQogICAgICAvLyBjbGVhbnVwIGNvZGUgYnkgc3RyaXBwaW5nIGVtcHR5IHN0cmluZ3MKICAgICAgc291cmNlID0gKGlzRXZhbHVhdGluZyA/IHNvdXJjZS5yZXBsYWNlKHJlRW1wdHlTdHJpbmdMZWFkaW5nLCAnJykgOiBzb3VyY2UpCiAgICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ01pZGRsZSwgJyQxJykKICAgICAgICAucmVwbGFjZShyZUVtcHR5U3RyaW5nVHJhaWxpbmcsICckMTsnKTsKCiAgICAgIC8vIGZyYW1lIGNvZGUgYXMgdGhlIGZ1bmN0aW9uIGJvZHkKICAgICAgc291cmNlID0gJ2Z1bmN0aW9uKCcgKyB2YXJpYWJsZSArICcpIHtcbicgKwogICAgICAgIChoYXNWYXJpYWJsZSA/ICcnIDogdmFyaWFibGUgKyAnIHx8ICgnICsgdmFyaWFibGUgKyAnID0ge30pO1xuJykgKwogICAgICAgICJ2YXIgX190LCBfX3AgPSAnJywgX19lID0gXy5lc2NhcGUiICsKICAgICAgICAoaXNFdmFsdWF0aW5nCiAgICAgICAgICA/ICcsIF9faiA9IEFycmF5LnByb3RvdHlwZS5qb2luO1xuJyArCiAgICAgICAgICAgICJmdW5jdGlvbiBwcmludCgpIHsgX19wICs9IF9fai5jYWxsKGFyZ3VtZW50cywgJycpIH1cbiIKICAgICAgICAgIDogJztcbicKICAgICAgICApICsKICAgICAgICBzb3VyY2UgKwogICAgICAgICdyZXR1cm4gX19wXG59JzsKCiAgICAgIC8vIFVzZSBhIHNvdXJjZVVSTCBmb3IgZWFzaWVyIGRlYnVnZ2luZy4KICAgICAgLy8gaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICB2YXIgc291cmNlVVJMID0gJ1xuLypcbi8vIyBzb3VyY2VVUkw9JyArIChvcHRpb25zLnNvdXJjZVVSTCB8fCAnL2xvZGFzaC90ZW1wbGF0ZS9zb3VyY2VbJyArICh0ZW1wbGF0ZUNvdW50ZXIrKykgKyAnXScpICsgJ1xuKi8nOwoKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcmVzdWx0ID0gRnVuY3Rpb24oaW1wb3J0c0tleXMsICdyZXR1cm4gJyArIHNvdXJjZSArIHNvdXJjZVVSTCkuYXBwbHkodW5kZWZpbmVkLCBpbXBvcnRzVmFsdWVzKTsKICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgICBpZiAoZGF0YSkgewogICAgICAgIHJldHVybiByZXN1bHQoZGF0YSk7CiAgICAgIH0KICAgICAgLy8gcHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24ncyBzb3VyY2UgYnkgaXRzIGB0b1N0cmluZ2AgbWV0aG9kLCBpbgogICAgICAvLyBzdXBwb3J0ZWQgZW52aXJvbm1lbnRzLCBvciB0aGUgYHNvdXJjZWAgcHJvcGVydHkgYXMgYSBjb252ZW5pZW5jZSBmb3IKICAgICAgLy8gaW5saW5pbmcgY29tcGlsZWQgdGVtcGxhdGVzIGR1cmluZyB0aGUgYnVpbGQgcHJvY2VzcwogICAgICByZXN1bHQuc291cmNlID0gc291cmNlOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogRXhlY3V0ZXMgdGhlIGNhbGxiYWNrIGBuYCB0aW1lcywgcmV0dXJuaW5nIGFuIGFycmF5IG9mIHRoZSByZXN1bHRzCiAgICAgKiBvZiBlYWNoIGNhbGxiYWNrIGV4ZWN1dGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAgICogd2l0aCBvbmUgYXJndW1lbnQ7IChpbmRleCkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBuIFRoZSBudW1iZXIgb2YgdGltZXMgdG8gZXhlY3V0ZSB0aGUgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cyBvZiBlYWNoIGBjYWxsYmFja2AgZXhlY3V0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgZGljZVJvbGxzID0gXy50aW1lcygzLCBfLnBhcnRpYWwoXy5yYW5kb20sIDEsIDYpKTsKICAgICAqIC8vID0+IFszLCA2LCA0XQogICAgICoKICAgICAqIF8udGltZXMoMywgZnVuY3Rpb24obikgeyBtYWdlLmNhc3RTcGVsbChuKTsgfSk7CiAgICAgKiAvLyA9PiBjYWxscyBgbWFnZS5jYXN0U3BlbGwobilgIHRocmVlIHRpbWVzLCBwYXNzaW5nIGBuYCBvZiBgMGAsIGAxYCwgYW5kIGAyYCByZXNwZWN0aXZlbHkKICAgICAqCiAgICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgdGhpcy5jYXN0KG4pOyB9LCBtYWdlKTsKICAgICAqIC8vID0+IGFsc28gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcwogICAgICovCiAgICBmdW5jdGlvbiB0aW1lcyhuLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBuID0gKG4gPSArbikgPiAtMSA/IG4gOiAwOwogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KG4pOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDEpOwogICAgICB3aGlsZSAoKytpbmRleCA8IG4pIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soaW5kZXgpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgaW52ZXJzZSBvZiBgXy5lc2NhcGVgIHRoaXMgbWV0aG9kIGNvbnZlcnRzIHRoZSBIVE1MIGVudGl0aWVzCiAgICAgKiBgJmFtcDtgLCBgJmx0O2AsIGAmZ3Q7YCwgYCZxdW90O2AsIGFuZCBgJiMzOTtgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICAgKiBjb3JyZXNwb25kaW5nIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byB1bmVzY2FwZS4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFJldHVybnMgdGhlIHVuZXNjYXBlZCBzdHJpbmcuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5lc2NhcGUoJ0ZyZWQsIEJhcm5leSAmYW1wOyBQZWJibGVzJyk7CiAgICAgKiAvLyA9PiAnRnJlZCwgQmFybmV5ICYgUGViYmxlcycKICAgICAqLwogICAgZnVuY3Rpb24gdW5lc2NhcGUoc3RyaW5nKSB7CiAgICAgIHJldHVybiBzdHJpbmcgPT0gbnVsbCA/ICcnIDogU3RyaW5nKHN0cmluZykucmVwbGFjZShyZUVzY2FwZWRIdG1sLCB1bmVzY2FwZUh0bWxDaGFyKTsKICAgIH0KCiAgICAvKioKICAgICAqIEdlbmVyYXRlcyBhIHVuaXF1ZSBJRC4gSWYgYHByZWZpeGAgaXMgcHJvdmlkZWQgdGhlIElEIHdpbGwgYmUgYXBwZW5kZWQgdG8gaXQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcHJlZml4XSBUaGUgdmFsdWUgdG8gcHJlZml4IHRoZSBJRCB3aXRoLgogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgdW5pcXVlIElELgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuaXF1ZUlkKCdjb250YWN0XycpOwogICAgICogLy8gPT4gJ2NvbnRhY3RfMTA0JwogICAgICoKICAgICAqIF8udW5pcXVlSWQoKTsKICAgICAqIC8vID0+ICcxMDUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVuaXF1ZUlkKHByZWZpeCkgewogICAgICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICAgICAgcmV0dXJuIFN0cmluZyhwcmVmaXggPT0gbnVsbCA/ICcnIDogcHJlZml4KSArIGlkOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGBsb2Rhc2hgIG9iamVjdCB0aGF0IHdyYXBzIHRoZSBnaXZlbiB2YWx1ZSB3aXRoIGV4cGxpY2l0CiAgICAgKiBtZXRob2QgY2hhaW5pbmcgZW5hYmxlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgd3JhcHBlciBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBjaGFyYWN0ZXJzID0gWwogICAgICogICB7ICduYW1lJzogJ2Jhcm5leScsICAnYWdlJzogMzYgfSwKICAgICAqICAgeyAnbmFtZSc6ICdmcmVkJywgICAgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAncGViYmxlcycsICdhZ2UnOiAxIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIHlvdW5nZXN0ID0gXy5jaGFpbihjaGFyYWN0ZXJzKQogICAgICogICAgIC5zb3J0QnkoJ2FnZScpCiAgICAgKiAgICAgLm1hcChmdW5jdGlvbihjaHIpIHsgcmV0dXJuIGNoci5uYW1lICsgJyBpcyAnICsgY2hyLmFnZTsgfSkKICAgICAqICAgICAuZmlyc3QoKQogICAgICogICAgIC52YWx1ZSgpOwogICAgICogLy8gPT4gJ3BlYmJsZXMgaXMgMScKICAgICAqLwogICAgZnVuY3Rpb24gY2hhaW4odmFsdWUpIHsKICAgICAgdmFsdWUgPSBuZXcgbG9kYXNoV3JhcHBlcih2YWx1ZSk7CiAgICAgIHZhbHVlLl9fY2hhaW5fXyA9IHRydWU7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEludm9rZXMgYGludGVyY2VwdG9yYCB3aXRoIHRoZSBgdmFsdWVgIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBhbmQgdGhlbgogICAgICogcmV0dXJucyBgdmFsdWVgLiBUaGUgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kCiAgICAgKiBjaGFpbiBpbiBvcmRlciB0byBwZXJmb3JtIG9wZXJhdGlvbnMgb24gaW50ZXJtZWRpYXRlIHJlc3VsdHMgd2l0aGluCiAgICAgKiB0aGUgY2hhaW4uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcHJvdmlkZSB0byBgaW50ZXJjZXB0b3JgLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gaW50ZXJjZXB0b3IgVGhlIGZ1bmN0aW9uIHRvIGludm9rZS4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIGB2YWx1ZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDMsIDRdKQogICAgICogIC50YXAoZnVuY3Rpb24oYXJyYXkpIHsgYXJyYXkucG9wKCk7IH0pCiAgICAgKiAgLnJldmVyc2UoKQogICAgICogIC52YWx1ZSgpOwogICAgICogLy8gPT4gWzMsIDIsIDFdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHRhcCh2YWx1ZSwgaW50ZXJjZXB0b3IpIHsKICAgICAgaW50ZXJjZXB0b3IodmFsdWUpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBFbmFibGVzIGV4cGxpY2l0IG1ldGhvZCBjaGFpbmluZyBvbiB0aGUgd3JhcHBlciBvYmplY3QuCiAgICAgKgogICAgICogQG5hbWUgY2hhaW4KICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGNoYXJhY3RlcnMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFybmV5JywgJ2FnZSc6IDM2IH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnZnJlZCcsICAgJ2FnZSc6IDQwIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gd2l0aG91dCBleHBsaWNpdCBjaGFpbmluZwogICAgICogXyhjaGFyYWN0ZXJzKS5maXJzdCgpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdiYXJuZXknLCAnYWdlJzogMzYgfQogICAgICoKICAgICAqIC8vIHdpdGggZXhwbGljaXQgY2hhaW5pbmcKICAgICAqIF8oY2hhcmFjdGVycykuY2hhaW4oKQogICAgICogICAuZmlyc3QoKQogICAgICogICAucGljaygnYWdlJykKICAgICAqICAgLnZhbHVlKCk7CiAgICAgKiAvLyA9PiB7ICdhZ2UnOiAzNiB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbmFtZSB0b1N0cmluZwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlc3VsdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLnRvU3RyaW5nKCk7CiAgICAgKiAvLyA9PiAnMSwyLDMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJUb1N0cmluZygpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLl9fd3JhcHBlZF9fKTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAgICoKICAgICAqIEBuYW1lIHZhbHVlT2YKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdmFsdWUKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICAgIHJldHVybiB0aGlzLl9fd3JhcHBlZF9fOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogICAgbG9kYXNoLmF0ID0gYXQ7CiAgICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgICBsb2Rhc2guYmluZEtleSA9IGJpbmRLZXk7CiAgICBsb2Rhc2guY2hhaW4gPSBjaGFpbjsKICAgIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICAgIGxvZGFzaC5jb21wb3NlID0gY29tcG9zZTsKICAgIGxvZGFzaC5jb25zdGFudCA9IGNvbnN0YW50OwogICAgbG9kYXNoLmNvdW50QnkgPSBjb3VudEJ5OwogICAgbG9kYXNoLmNyZWF0ZSA9IGNyZWF0ZTsKICAgIGxvZGFzaC5jcmVhdGVDYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrOwogICAgbG9kYXNoLmN1cnJ5ID0gY3Vycnk7CiAgICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgbG9kYXNoLmRlZmVyID0gZGVmZXI7CiAgICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICAgIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICAgIGxvZGFzaC5maWx0ZXIgPSBmaWx0ZXI7CiAgICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZm9yRWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgICBsb2Rhc2guZm9ySW5SaWdodCA9IGZvckluUmlnaHQ7CiAgICBsb2Rhc2guZm9yT3duID0gZm9yT3duOwogICAgbG9kYXNoLmZvck93blJpZ2h0ID0gZm9yT3duUmlnaHQ7CiAgICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLmdyb3VwQnkgPSBncm91cEJ5OwogICAgbG9kYXNoLmluZGV4QnkgPSBpbmRleEJ5OwogICAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogICAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICAgIGxvZGFzaC5pbnZlcnQgPSBpbnZlcnQ7CiAgICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogICAgbG9kYXNoLmtleXMgPSBrZXlzOwogICAgbG9kYXNoLm1hcCA9IG1hcDsKICAgIGxvZGFzaC5tYXBWYWx1ZXMgPSBtYXBWYWx1ZXM7CiAgICBsb2Rhc2gubWF4ID0gbWF4OwogICAgbG9kYXNoLm1lbW9pemUgPSBtZW1vaXplOwogICAgbG9kYXNoLm1lcmdlID0gbWVyZ2U7CiAgICBsb2Rhc2gubWluID0gbWluOwogICAgbG9kYXNoLm9taXQgPSBvbWl0OwogICAgbG9kYXNoLm9uY2UgPSBvbmNlOwogICAgbG9kYXNoLnBhaXJzID0gcGFpcnM7CiAgICBsb2Rhc2gucGFydGlhbCA9IHBhcnRpYWw7CiAgICBsb2Rhc2gucGFydGlhbFJpZ2h0ID0gcGFydGlhbFJpZ2h0OwogICAgbG9kYXNoLnBpY2sgPSBwaWNrOwogICAgbG9kYXNoLnBsdWNrID0gcGx1Y2s7CiAgICBsb2Rhc2gucHJvcGVydHkgPSBwcm9wZXJ0eTsKICAgIGxvZGFzaC5wdWxsID0gcHVsbDsKICAgIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogICAgbG9kYXNoLnJlamVjdCA9IHJlamVjdDsKICAgIGxvZGFzaC5yZW1vdmUgPSByZW1vdmU7CiAgICBsb2Rhc2gucmVzdCA9IHJlc3Q7CiAgICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogICAgbG9kYXNoLnRhcCA9IHRhcDsKICAgIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogICAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgICBsb2Rhc2gudG9BcnJheSA9IHRvQXJyYXk7CiAgICBsb2Rhc2gudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogICAgbG9kYXNoLndoZXJlID0gd2hlcmU7CiAgICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgICBsb2Rhc2gueG9yID0geG9yOwogICAgbG9kYXNoLnppcCA9IHppcDsKICAgIGxvZGFzaC56aXBPYmplY3QgPSB6aXBPYmplY3Q7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC5jb2xsZWN0ID0gbWFwOwogICAgbG9kYXNoLmRyb3AgPSByZXN0OwogICAgbG9kYXNoLmVhY2ggPSBmb3JFYWNoOwogICAgbG9kYXNoLmVhY2hSaWdodCA9IGZvckVhY2hSaWdodDsKICAgIGxvZGFzaC5leHRlbmQgPSBhc3NpZ247CiAgICBsb2Rhc2gubWV0aG9kcyA9IGZ1bmN0aW9uczsKICAgIGxvZGFzaC5vYmplY3QgPSB6aXBPYmplY3Q7CiAgICBsb2Rhc2guc2VsZWN0ID0gZmlsdGVyOwogICAgbG9kYXNoLnRhaWwgPSByZXN0OwogICAgbG9kYXNoLnVuaXF1ZSA9IHVuaXE7CiAgICBsb2Rhc2gudW56aXAgPSB6aXA7CgogICAgLy8gYWRkIGZ1bmN0aW9ucyB0byBgbG9kYXNoLnByb3RvdHlwZWAKICAgIG1peGluKGxvZGFzaCk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLy8gYWRkIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzIHdoZW4gY2hhaW5pbmcKICAgIGxvZGFzaC5jbG9uZSA9IGNsb25lOwogICAgbG9kYXNoLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICAgIGxvZGFzaC5jb250YWlucyA9IGNvbnRhaW5zOwogICAgbG9kYXNoLmVzY2FwZSA9IGVzY2FwZTsKICAgIGxvZGFzaC5ldmVyeSA9IGV2ZXJ5OwogICAgbG9kYXNoLmZpbmQgPSBmaW5kOwogICAgbG9kYXNoLmZpbmRJbmRleCA9IGZpbmRJbmRleDsKICAgIGxvZGFzaC5maW5kS2V5ID0gZmluZEtleTsKICAgIGxvZGFzaC5maW5kTGFzdCA9IGZpbmRMYXN0OwogICAgbG9kYXNoLmZpbmRMYXN0SW5kZXggPSBmaW5kTGFzdEluZGV4OwogICAgbG9kYXNoLmZpbmRMYXN0S2V5ID0gZmluZExhc3RLZXk7CiAgICBsb2Rhc2guaGFzID0gaGFzOwogICAgbG9kYXNoLmlkZW50aXR5ID0gaWRlbnRpdHk7CiAgICBsb2Rhc2guaW5kZXhPZiA9IGluZGV4T2Y7CiAgICBsb2Rhc2guaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICAgIGxvZGFzaC5pc0FycmF5ID0gaXNBcnJheTsKICAgIGxvZGFzaC5pc0Jvb2xlYW4gPSBpc0Jvb2xlYW47CiAgICBsb2Rhc2guaXNEYXRlID0gaXNEYXRlOwogICAgbG9kYXNoLmlzRWxlbWVudCA9IGlzRWxlbWVudDsKICAgIGxvZGFzaC5pc0VtcHR5ID0gaXNFbXB0eTsKICAgIGxvZGFzaC5pc0VxdWFsID0gaXNFcXVhbDsKICAgIGxvZGFzaC5pc0Zpbml0ZSA9IGlzRmluaXRlOwogICAgbG9kYXNoLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogICAgbG9kYXNoLmlzTmFOID0gaXNOYU47CiAgICBsb2Rhc2guaXNOdWxsID0gaXNOdWxsOwogICAgbG9kYXNoLmlzTnVtYmVyID0gaXNOdW1iZXI7CiAgICBsb2Rhc2guaXNPYmplY3QgPSBpc09iamVjdDsKICAgIGxvZGFzaC5pc1BsYWluT2JqZWN0ID0gaXNQbGFpbk9iamVjdDsKICAgIGxvZGFzaC5pc1JlZ0V4cCA9IGlzUmVnRXhwOwogICAgbG9kYXNoLmlzU3RyaW5nID0gaXNTdHJpbmc7CiAgICBsb2Rhc2guaXNVbmRlZmluZWQgPSBpc1VuZGVmaW5lZDsKICAgIGxvZGFzaC5sYXN0SW5kZXhPZiA9IGxhc3RJbmRleE9mOwogICAgbG9kYXNoLm1peGluID0gbWl4aW47CiAgICBsb2Rhc2gubm9Db25mbGljdCA9IG5vQ29uZmxpY3Q7CiAgICBsb2Rhc2gubm9vcCA9IG5vb3A7CiAgICBsb2Rhc2gubm93ID0gbm93OwogICAgbG9kYXNoLnBhcnNlSW50ID0gcGFyc2VJbnQ7CiAgICBsb2Rhc2gucmFuZG9tID0gcmFuZG9tOwogICAgbG9kYXNoLnJlZHVjZSA9IHJlZHVjZTsKICAgIGxvZGFzaC5yZWR1Y2VSaWdodCA9IHJlZHVjZVJpZ2h0OwogICAgbG9kYXNoLnJlc3VsdCA9IHJlc3VsdDsKICAgIGxvZGFzaC5ydW5JbkNvbnRleHQgPSBydW5JbkNvbnRleHQ7CiAgICBsb2Rhc2guc2l6ZSA9IHNpemU7CiAgICBsb2Rhc2guc29tZSA9IHNvbWU7CiAgICBsb2Rhc2guc29ydGVkSW5kZXggPSBzb3J0ZWRJbmRleDsKICAgIGxvZGFzaC50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgbG9kYXNoLnVuZXNjYXBlID0gdW5lc2NhcGU7CiAgICBsb2Rhc2gudW5pcXVlSWQgPSB1bmlxdWVJZDsKCiAgICAvLyBhZGQgYWxpYXNlcwogICAgbG9kYXNoLmFsbCA9IGV2ZXJ5OwogICAgbG9kYXNoLmFueSA9IHNvbWU7CiAgICBsb2Rhc2guZGV0ZWN0ID0gZmluZDsKICAgIGxvZGFzaC5maW5kV2hlcmUgPSBmaW5kOwogICAgbG9kYXNoLmZvbGRsID0gcmVkdWNlOwogICAgbG9kYXNoLmZvbGRyID0gcmVkdWNlUmlnaHQ7CiAgICBsb2Rhc2guaW5jbHVkZSA9IGNvbnRhaW5zOwogICAgbG9kYXNoLmluamVjdCA9IHJlZHVjZTsKCiAgICBtaXhpbihmdW5jdGlvbigpIHsKICAgICAgdmFyIHNvdXJjZSA9IHt9CiAgICAgIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICAgIHNvdXJjZVttZXRob2ROYW1lXSA9IGZ1bmM7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0oKSwgZmFsc2UpOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgY2FwYWJsZSBvZiByZXR1cm5pbmcgd3JhcHBlZCBhbmQgdW53cmFwcGVkIHZhbHVlcyB3aGVuIGNoYWluaW5nCiAgICBsb2Rhc2guZmlyc3QgPSBmaXJzdDsKICAgIGxvZGFzaC5sYXN0ID0gbGFzdDsKICAgIGxvZGFzaC5zYW1wbGUgPSBzYW1wbGU7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC50YWtlID0gZmlyc3Q7CiAgICBsb2Rhc2guaGVhZCA9IGZpcnN0OwoKICAgIGZvck93bihsb2Rhc2gsIGZ1bmN0aW9uKGZ1bmMsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGNhbGxiYWNrYWJsZSA9IG1ldGhvZE5hbWUgIT09ICdzYW1wbGUnOwogICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdPSBmdW5jdGlvbihuLCBndWFyZCkgewogICAgICAgICAgdmFyIGNoYWluQWxsID0gdGhpcy5fX2NoYWluX18sCiAgICAgICAgICAgICAgcmVzdWx0ID0gZnVuYyh0aGlzLl9fd3JhcHBlZF9fLCBuLCBndWFyZCk7CgogICAgICAgICAgcmV0dXJuICFjaGFpbkFsbCAmJiAobiA9PSBudWxsIHx8IChndWFyZCAmJiAhKGNhbGxiYWNrYWJsZSAmJiB0eXBlb2YgbiA9PSAnZnVuY3Rpb24nKSkpCiAgICAgICAgICAgID8gcmVzdWx0CiAgICAgICAgICAgIDogbmV3IGxvZGFzaFdyYXBwZXIocmVzdWx0LCBjaGFpbkFsbCk7CiAgICAgICAgfTsKICAgICAgfQogICAgfSk7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBUaGUgc2VtYW50aWMgdmVyc2lvbiBudW1iZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIHN0cmluZwogICAgICovCiAgICBsb2Rhc2guVkVSU0lPTiA9ICcyLjQuMSc7CgogICAgLy8gYWRkICJDaGFpbmluZyIgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyCiAgICBsb2Rhc2gucHJvdG90eXBlLmNoYWluID0gd3JhcHBlckNoYWluOwogICAgbG9kYXNoLnByb3RvdHlwZS50b1N0cmluZyA9IHdyYXBwZXJUb1N0cmluZzsKICAgIGxvZGFzaC5wcm90b3R5cGUudmFsdWUgPSB3cmFwcGVyVmFsdWVPZjsKICAgIGxvZGFzaC5wcm90b3R5cGUudmFsdWVPZiA9IHdyYXBwZXJWYWx1ZU9mOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB1bndyYXBwZWQgdmFsdWVzCiAgICBmb3JFYWNoKFsnam9pbicsICdwb3AnLCAnc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGNoYWluQWxsID0gdGhpcy5fX2NoYWluX18sCiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKCiAgICAgICAgcmV0dXJuIGNoYWluQWxsCiAgICAgICAgICA/IG5ldyBsb2Rhc2hXcmFwcGVyKHJlc3VsdCwgY2hhaW5BbGwpCiAgICAgICAgICA6IHJlc3VsdDsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiB0aGUgZXhpc3Rpbmcgd3JhcHBlZCB2YWx1ZQogICAgZm9yRWFjaChbJ3B1c2gnLCAncmV2ZXJzZScsICdzb3J0JywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuYy5hcHBseSh0aGlzLl9fd3JhcHBlZF9fLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9OwogICAgfSk7CgogICAgLy8gYWRkIGBBcnJheWAgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIG5ldyB3cmFwcGVkIHZhbHVlcwogICAgZm9yRWFjaChbJ2NvbmNhdCcsICdzbGljZScsICdzcGxpY2UnXSwgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogICAgICB2YXIgZnVuYyA9IGFycmF5UmVmW21ldGhvZE5hbWVdOwogICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIG5ldyBsb2Rhc2hXcmFwcGVyKGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKSwgdGhpcy5fX2NoYWluX18pOwogICAgICB9OwogICAgfSk7CgogICAgcmV0dXJuIGxvZGFzaDsKICB9CgogIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAvLyBleHBvc2UgTG8tRGFzaAogIHZhciBfID0gcnVuSW5Db250ZXh0KCk7CgogIC8vIHNvbWUgQU1EIGJ1aWxkIG9wdGltaXplcnMgbGlrZSByLmpzIGNoZWNrIGZvciBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIGlzIGxvYWRlZCB3aXRoIGEgUmVxdWlyZUpTIHNoaW0gY29uZmlnLgogICAgLy8gU2VlIGh0dHA6Ly9yZXF1aXJlanMub3JnL2RvY3MvYXBpLmh0bWwjY29uZmlnLXNoaW0KICAgIHJvb3QuXyA9IF87CgogICAgLy8gZGVmaW5lIGFzIGFuIGFub255bW91cyBtb2R1bGUgc28sIHRocm91Z2ggcGF0aCBtYXBwaW5nLCBpdCBjYW4gYmUKICAgIC8vIHJlZmVyZW5jZWQgYXMgdGhlICJ1bmRlcnNjb3JlIiBtb2R1bGUKICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIF87CiAgICB9KTsKICB9CiAgLy8gY2hlY2sgZm9yIGBleHBvcnRzYCBhZnRlciBgZGVmaW5lYCBpbiBjYXNlIGEgYnVpbGQgb3B0aW1pemVyIGFkZHMgYW4gYGV4cG9ydHNgIG9iamVjdAogIGVsc2UgaWYgKGZyZWVFeHBvcnRzICYmIGZyZWVNb2R1bGUpIHsKICAgIC8vIGluIE5vZGUuanMgb3IgUmluZ29KUwogICAgaWYgKG1vZHVsZUV4cG9ydHMpIHsKICAgICAgKGZyZWVNb2R1bGUuZXhwb3J0cyA9IF8pLl8gPSBfOwogICAgfQogICAgLy8gaW4gTmFyd2hhbCBvciBSaGlubyAtcmVxdWlyZQogICAgZWxzZSB7CiAgICAgIGZyZWVFeHBvcnRzLl8gPSBfOwogICAgfQogIH0KICBlbHNlIHsKICAgIC8vIGluIGEgYnJvd3NlciBvciBSaGlubwogICAgcm9vdC5fID0gXzsKICB9Cn0uY2FsbCh0aGlzKSk7Cgp9KS5jYWxsKHRoaXMsdHlwZW9mIGdsb2JhbCAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWwgOiB0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIgPyBzZWxmIDogdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB7fSkKfSx7fV0sMTMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKOyhmdW5jdGlvbihleHBvcnRzKSB7CgovLyBleHBvcnQgdGhlIGNsYXNzIGlmIHdlIGFyZSBpbiBhIE5vZGUtbGlrZSBzeXN0ZW0uCmlmICh0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiBtb2R1bGUuZXhwb3J0cyA9PT0gZXhwb3J0cykKICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBTZW1WZXI7CgovLyBUaGUgZGVidWcgZnVuY3Rpb24gaXMgZXhjbHVkZWQgZW50aXJlbHkgZnJvbSB0aGUgbWluaWZpZWQgdmVyc2lvbi4KCi8vIE5vdGU6IHRoaXMgaXMgdGhlIHNlbXZlci5vcmcgdmVyc2lvbiBvZiB0aGUgc3BlYyB0aGF0IGl0IGltcGxlbWVudHMKLy8gTm90IG5lY2Vzc2FyaWx5IHRoZSBwYWNrYWdlIHZlcnNpb24gb2YgdGhpcyBjb2RlLgpleHBvcnRzLlNFTVZFUl9TUEVDX1ZFUlNJT04gPSAnMi4wLjAnOwoKLy8gVGhlIGFjdHVhbCByZWdleHBzIGdvIG9uIGV4cG9ydHMucmUKdmFyIHJlID0gZXhwb3J0cy5yZSA9IFtdOwp2YXIgc3JjID0gZXhwb3J0cy5zcmMgPSBbXTsKdmFyIFIgPSAwOwoKLy8gVGhlIGZvbGxvd2luZyBSZWd1bGFyIEV4cHJlc3Npb25zIGNhbiBiZSB1c2VkIGZvciB0b2tlbml6aW5nLAovLyB2YWxpZGF0aW5nLCBhbmQgcGFyc2luZyBTZW1WZXIgdmVyc2lvbiBzdHJpbmdzLgoKLy8gIyMgTnVtZXJpYyBJZGVudGlmaWVyCi8vIEEgc2luZ2xlIGAwYCwgb3IgYSBub24temVybyBkaWdpdCBmb2xsb3dlZCBieSB6ZXJvIG9yIG1vcmUgZGlnaXRzLgoKdmFyIE5VTUVSSUNJREVOVElGSUVSID0gUisrOwpzcmNbTlVNRVJJQ0lERU5USUZJRVJdID0gJzB8WzEtOV1cXGQqJzsKdmFyIE5VTUVSSUNJREVOVElGSUVSTE9PU0UgPSBSKys7CnNyY1tOVU1FUklDSURFTlRJRklFUkxPT1NFXSA9ICdbMC05XSsnOwoKCi8vICMjIE5vbi1udW1lcmljIElkZW50aWZpZXIKLy8gWmVybyBvciBtb3JlIGRpZ2l0cywgZm9sbG93ZWQgYnkgYSBsZXR0ZXIgb3IgaHlwaGVuLCBhbmQgdGhlbiB6ZXJvIG9yCi8vIG1vcmUgbGV0dGVycywgZGlnaXRzLCBvciBoeXBoZW5zLgoKdmFyIE5PTk5VTUVSSUNJREVOVElGSUVSID0gUisrOwpzcmNbTk9OTlVNRVJJQ0lERU5USUZJRVJdID0gJ1xcZCpbYS16QS1aLV1bYS16QS1aMC05LV0qJzsKCgovLyAjIyBNYWluIFZlcnNpb24KLy8gVGhyZWUgZG90LXNlcGFyYXRlZCBudW1lcmljIGlkZW50aWZpZXJzLgoKdmFyIE1BSU5WRVJTSU9OID0gUisrOwpzcmNbTUFJTlZFUlNJT05dID0gJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSXSArICcpXFwuJyArCiAgICAgICAgICAgICAgICAgICAnKCcgKyBzcmNbTlVNRVJJQ0lERU5USUZJRVJdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICcoJyArIHNyY1tOVU1FUklDSURFTlRJRklFUl0gKyAnKSc7Cgp2YXIgTUFJTlZFUlNJT05MT09TRSA9IFIrKzsKc3JjW01BSU5WRVJTSU9OTE9PU0VdID0gJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJylcXC4nICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW05VTUVSSUNJREVOVElGSUVSTE9PU0VdICsgJyknOwoKLy8gIyMgUHJlLXJlbGVhc2UgVmVyc2lvbiBJZGVudGlmaWVyCi8vIEEgbnVtZXJpYyBpZGVudGlmaWVyLCBvciBhIG5vbi1udW1lcmljIGlkZW50aWZpZXIuCgp2YXIgUFJFUkVMRUFTRUlERU5USUZJRVIgPSBSKys7CnNyY1tQUkVSRUxFQVNFSURFTlRJRklFUl0gPSAnKD86JyArIHNyY1tOVU1FUklDSURFTlRJRklFUl0gKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3wnICsgc3JjW05PTk5VTUVSSUNJREVOVElGSUVSXSArICcpJzsKCnZhciBQUkVSRUxFQVNFSURFTlRJRklFUkxPT1NFID0gUisrOwpzcmNbUFJFUkVMRUFTRUlERU5USUZJRVJMT09TRV0gPSAnKD86JyArIHNyY1tOVU1FUklDSURFTlRJRklFUkxPT1NFXSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd8JyArIHNyY1tOT05OVU1FUklDSURFTlRJRklFUl0gKyAnKSc7CgoKLy8gIyMgUHJlLXJlbGVhc2UgVmVyc2lvbgovLyBIeXBoZW4sIGZvbGxvd2VkIGJ5IG9uZSBvciBtb3JlIGRvdC1zZXBhcmF0ZWQgcHJlLXJlbGVhc2UgdmVyc2lvbgovLyBpZGVudGlmaWVycy4KCnZhciBQUkVSRUxFQVNFID0gUisrOwpzcmNbUFJFUkVMRUFTRV0gPSAnKD86LSgnICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSXSArCiAgICAgICAgICAgICAgICAgICcoPzpcXC4nICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSXSArICcpKikpJzsKCnZhciBQUkVSRUxFQVNFTE9PU0UgPSBSKys7CnNyY1tQUkVSRUxFQVNFTE9PU0VdID0gJyg/Oi0/KCcgKyBzcmNbUFJFUkVMRUFTRUlERU5USUZJRVJMT09TRV0gKwogICAgICAgICAgICAgICAgICAgICAgICcoPzpcXC4nICsgc3JjW1BSRVJFTEVBU0VJREVOVElGSUVSTE9PU0VdICsgJykqKSknOwoKLy8gIyMgQnVpbGQgTWV0YWRhdGEgSWRlbnRpZmllcgovLyBBbnkgY29tYmluYXRpb24gb2YgZGlnaXRzLCBsZXR0ZXJzLCBvciBoeXBoZW5zLgoKdmFyIEJVSUxESURFTlRJRklFUiA9IFIrKzsKc3JjW0JVSUxESURFTlRJRklFUl0gPSAnWzAtOUEtWmEtei1dKyc7CgovLyAjIyBCdWlsZCBNZXRhZGF0YQovLyBQbHVzIHNpZ24sIGZvbGxvd2VkIGJ5IG9uZSBvciBtb3JlIHBlcmlvZC1zZXBhcmF0ZWQgYnVpbGQgbWV0YWRhdGEKLy8gaWRlbnRpZmllcnMuCgp2YXIgQlVJTEQgPSBSKys7CnNyY1tCVUlMRF0gPSAnKD86XFwrKCcgKyBzcmNbQlVJTERJREVOVElGSUVSXSArCiAgICAgICAgICAgICAnKD86XFwuJyArIHNyY1tCVUlMRElERU5USUZJRVJdICsgJykqKSknOwoKCi8vICMjIEZ1bGwgVmVyc2lvbiBTdHJpbmcKLy8gQSBtYWluIHZlcnNpb24sIGZvbGxvd2VkIG9wdGlvbmFsbHkgYnkgYSBwcmUtcmVsZWFzZSB2ZXJzaW9uIGFuZAovLyBidWlsZCBtZXRhZGF0YS4KCi8vIE5vdGUgdGhhdCB0aGUgb25seSBtYWpvciwgbWlub3IsIHBhdGNoLCBhbmQgcHJlLXJlbGVhc2Ugc2VjdGlvbnMgb2YKLy8gdGhlIHZlcnNpb24gc3RyaW5nIGFyZSBjYXB0dXJpbmcgZ3JvdXBzLiAgVGhlIGJ1aWxkIG1ldGFkYXRhIGlzIG5vdCBhCi8vIGNhcHR1cmluZyBncm91cCwgYmVjYXVzZSBpdCBzaG91bGQgbm90IGV2ZXIgYmUgdXNlZCBpbiB2ZXJzaW9uCi8vIGNvbXBhcmlzb24uCgp2YXIgRlVMTCA9IFIrKzsKdmFyIEZVTExQTEFJTiA9ICd2PycgKyBzcmNbTUFJTlZFUlNJT05dICsKICAgICAgICAgICAgICAgIHNyY1tQUkVSRUxFQVNFXSArICc/JyArCiAgICAgICAgICAgICAgICBzcmNbQlVJTERdICsgJz8nOwoKc3JjW0ZVTExdID0gJ14nICsgRlVMTFBMQUlOICsgJyQnOwoKLy8gbGlrZSBmdWxsLCBidXQgYWxsb3dzIHYxLjIuMyBhbmQgPTEuMi4zLCB3aGljaCBwZW9wbGUgZG8gc29tZXRpbWVzLgovLyBhbHNvLCAxLjAuMGFscGhhMSAocHJlcmVsZWFzZSB3aXRob3V0IHRoZSBoeXBoZW4pIHdoaWNoIGlzIHByZXR0eQovLyBjb21tb24gaW4gdGhlIG5wbSByZWdpc3RyeS4KdmFyIExPT1NFUExBSU4gPSAnW3Y9XFxzXSonICsgc3JjW01BSU5WRVJTSU9OTE9PU0VdICsKICAgICAgICAgICAgICAgICBzcmNbUFJFUkVMRUFTRUxPT1NFXSArICc/JyArCiAgICAgICAgICAgICAgICAgc3JjW0JVSUxEXSArICc/JzsKCnZhciBMT09TRSA9IFIrKzsKc3JjW0xPT1NFXSA9ICdeJyArIExPT1NFUExBSU4gKyAnJCc7Cgp2YXIgR1RMVCA9IFIrKzsKc3JjW0dUTFRdID0gJygoPzo8fD4pPz0/KSc7CgovLyBTb21ldGhpbmcgbGlrZSAiMi4qIiBvciAiMS4yLngiLgovLyBOb3RlIHRoYXQgIngueCIgaXMgYSB2YWxpZCB4UmFuZ2UgaWRlbnRpZmVyLCBtZWFuaW5nICJhbnkgdmVyc2lvbiIKLy8gT25seSB0aGUgZmlyc3QgaXRlbSBpcyBzdHJpY3RseSByZXF1aXJlZC4KdmFyIFhSQU5HRUlERU5USUZJRVJMT09TRSA9IFIrKzsKc3JjW1hSQU5HRUlERU5USUZJRVJMT09TRV0gPSBzcmNbTlVNRVJJQ0lERU5USUZJRVJMT09TRV0gKyAnfHh8WHxcXConOwp2YXIgWFJBTkdFSURFTlRJRklFUiA9IFIrKzsKc3JjW1hSQU5HRUlERU5USUZJRVJdID0gc3JjW05VTUVSSUNJREVOVElGSUVSXSArICd8eHxYfFxcKic7Cgp2YXIgWFJBTkdFUExBSU4gPSBSKys7CnNyY1tYUkFOR0VQTEFJTl0gPSAnW3Y9XFxzXSooJyArIHNyY1tYUkFOR0VJREVOVElGSUVSXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAnKD86XFwuKCcgKyBzcmNbWFJBTkdFSURFTlRJRklFUl0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgJyg/OlxcLignICsgc3JjW1hSQU5HRUlERU5USUZJRVJdICsgJyknICsKICAgICAgICAgICAgICAgICAgICcoPzonICsgc3JjW1BSRVJFTEVBU0VdICsgJyk/JyArCiAgICAgICAgICAgICAgICAgICBzcmNbQlVJTERdICsgJz8nICsKICAgICAgICAgICAgICAgICAgICcpPyk/JzsKCnZhciBYUkFOR0VQTEFJTkxPT1NFID0gUisrOwpzcmNbWFJBTkdFUExBSU5MT09TRV0gPSAnW3Y9XFxzXSooJyArIHNyY1tYUkFOR0VJREVOVElGSUVSTE9PU0VdICsgJyknICsKICAgICAgICAgICAgICAgICAgICAgICAgJyg/OlxcLignICsgc3JjW1hSQU5HRUlERU5USUZJRVJMT09TRV0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgICAgICAnKD86XFwuKCcgKyBzcmNbWFJBTkdFSURFTlRJRklFUkxPT1NFXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAgICAgICcoPzonICsgc3JjW1BSRVJFTEVBU0VMT09TRV0gKyAnKT8nICsKICAgICAgICAgICAgICAgICAgICAgICAgc3JjW0JVSUxEXSArICc/JyArCiAgICAgICAgICAgICAgICAgICAgICAgICcpPyk/JzsKCnZhciBYUkFOR0UgPSBSKys7CnNyY1tYUkFOR0VdID0gJ14nICsgc3JjW0dUTFRdICsgJ1xccyonICsgc3JjW1hSQU5HRVBMQUlOXSArICckJzsKdmFyIFhSQU5HRUxPT1NFID0gUisrOwpzcmNbWFJBTkdFTE9PU0VdID0gJ14nICsgc3JjW0dUTFRdICsgJ1xccyonICsgc3JjW1hSQU5HRVBMQUlOTE9PU0VdICsgJyQnOwoKLy8gVGlsZGUgcmFuZ2VzLgovLyBNZWFuaW5nIGlzICJyZWFzb25hYmx5IGF0IG9yIGdyZWF0ZXIgdGhhbiIKdmFyIExPTkVUSUxERSA9IFIrKzsKc3JjW0xPTkVUSUxERV0gPSAnKD86fj4/KSc7Cgp2YXIgVElMREVUUklNID0gUisrOwpzcmNbVElMREVUUklNXSA9ICcoXFxzKiknICsgc3JjW0xPTkVUSUxERV0gKyAnXFxzKyc7CnJlW1RJTERFVFJJTV0gPSBuZXcgUmVnRXhwKHNyY1tUSUxERVRSSU1dLCAnZycpOwp2YXIgdGlsZGVUcmltUmVwbGFjZSA9ICckMX4nOwoKdmFyIFRJTERFID0gUisrOwpzcmNbVElMREVdID0gJ14nICsgc3JjW0xPTkVUSUxERV0gKyBzcmNbWFJBTkdFUExBSU5dICsgJyQnOwp2YXIgVElMREVMT09TRSA9IFIrKzsKc3JjW1RJTERFTE9PU0VdID0gJ14nICsgc3JjW0xPTkVUSUxERV0gKyBzcmNbWFJBTkdFUExBSU5MT09TRV0gKyAnJCc7CgovLyBDYXJldCByYW5nZXMuCi8vIE1lYW5pbmcgaXMgImF0IGxlYXN0IGFuZCBiYWNrd2FyZHMgY29tcGF0aWJsZSB3aXRoIgp2YXIgTE9ORUNBUkVUID0gUisrOwpzcmNbTE9ORUNBUkVUXSA9ICcoPzpcXF4pJzsKCnZhciBDQVJFVFRSSU0gPSBSKys7CnNyY1tDQVJFVFRSSU1dID0gJyhcXHMqKScgKyBzcmNbTE9ORUNBUkVUXSArICdcXHMrJzsKcmVbQ0FSRVRUUklNXSA9IG5ldyBSZWdFeHAoc3JjW0NBUkVUVFJJTV0sICdnJyk7CnZhciBjYXJldFRyaW1SZXBsYWNlID0gJyQxXic7Cgp2YXIgQ0FSRVQgPSBSKys7CnNyY1tDQVJFVF0gPSAnXicgKyBzcmNbTE9ORUNBUkVUXSArIHNyY1tYUkFOR0VQTEFJTl0gKyAnJCc7CnZhciBDQVJFVExPT1NFID0gUisrOwpzcmNbQ0FSRVRMT09TRV0gPSAnXicgKyBzcmNbTE9ORUNBUkVUXSArIHNyY1tYUkFOR0VQTEFJTkxPT1NFXSArICckJzsKCi8vIEEgc2ltcGxlIGd0L2x0L2VxIHRoaW5nLCBvciBqdXN0ICIiIHRvIGluZGljYXRlICJhbnkgdmVyc2lvbiIKdmFyIENPTVBBUkFUT1JMT09TRSA9IFIrKzsKc3JjW0NPTVBBUkFUT1JMT09TRV0gPSAnXicgKyBzcmNbR1RMVF0gKyAnXFxzKignICsgTE9PU0VQTEFJTiArICcpJHxeJCc7CnZhciBDT01QQVJBVE9SID0gUisrOwpzcmNbQ09NUEFSQVRPUl0gPSAnXicgKyBzcmNbR1RMVF0gKyAnXFxzKignICsgRlVMTFBMQUlOICsgJykkfF4kJzsKCgovLyBBbiBleHByZXNzaW9uIHRvIHN0cmlwIGFueSB3aGl0ZXNwYWNlIGJldHdlZW4gdGhlIGd0bHQgYW5kIHRoZSB0aGluZwovLyBpdCBtb2RpZmllcywgc28gdGhhdCBgPiAxLjIuM2AgPT0+IGA+MS4yLjNgCnZhciBDT01QQVJBVE9SVFJJTSA9IFIrKzsKc3JjW0NPTVBBUkFUT1JUUklNXSA9ICcoXFxzKiknICsgc3JjW0dUTFRdICsKICAgICAgICAgICAgICAgICAgICAgICdcXHMqKCcgKyBMT09TRVBMQUlOICsgJ3wnICsgc3JjW1hSQU5HRVBMQUlOXSArICcpJzsKCi8vIHRoaXMgb25lIGhhcyB0byB1c2UgdGhlIC9nIGZsYWcKcmVbQ09NUEFSQVRPUlRSSU1dID0gbmV3IFJlZ0V4cChzcmNbQ09NUEFSQVRPUlRSSU1dLCAnZycpOwp2YXIgY29tcGFyYXRvclRyaW1SZXBsYWNlID0gJyQxJDIkMyc7CgoKLy8gU29tZXRoaW5nIGxpa2UgYDEuMi4zIC0gMS4yLjRgCi8vIE5vdGUgdGhhdCB0aGVzZSBhbGwgdXNlIHRoZSBsb29zZSBmb3JtLCBiZWNhdXNlIHRoZXknbGwgYmUKLy8gY2hlY2tlZCBhZ2FpbnN0IGVpdGhlciB0aGUgc3RyaWN0IG9yIGxvb3NlIGNvbXBhcmF0b3IgZm9ybQovLyBsYXRlci4KdmFyIEhZUEhFTlJBTkdFID0gUisrOwpzcmNbSFlQSEVOUkFOR0VdID0gJ15cXHMqKCcgKyBzcmNbWFJBTkdFUExBSU5dICsgJyknICsKICAgICAgICAgICAgICAgICAgICdcXHMrLVxccysnICsKICAgICAgICAgICAgICAgICAgICcoJyArIHNyY1tYUkFOR0VQTEFJTl0gKyAnKScgKwogICAgICAgICAgICAgICAgICAgJ1xccyokJzsKCnZhciBIWVBIRU5SQU5HRUxPT1NFID0gUisrOwpzcmNbSFlQSEVOUkFOR0VMT09TRV0gPSAnXlxccyooJyArIHNyY1tYUkFOR0VQTEFJTkxPT1NFXSArICcpJyArCiAgICAgICAgICAgICAgICAgICAgICAgICdcXHMrLVxccysnICsKICAgICAgICAgICAgICAgICAgICAgICAgJygnICsgc3JjW1hSQU5HRVBMQUlOTE9PU0VdICsgJyknICsKICAgICAgICAgICAgICAgICAgICAgICAgJ1xccyokJzsKCi8vIFN0YXIgcmFuZ2VzIGJhc2ljYWxseSBqdXN0IGFsbG93IGFueXRoaW5nIGF0IGFsbC4KdmFyIFNUQVIgPSBSKys7CnNyY1tTVEFSXSA9ICcoPHw+KT89P1xccypcXConOwoKLy8gQ29tcGlsZSB0byBhY3R1YWwgcmVnZXhwIG9iamVjdHMuCi8vIEFsbCBhcmUgZmxhZy1mcmVlLCB1bmxlc3MgdGhleSB3ZXJlIGNyZWF0ZWQgYWJvdmUgd2l0aCBhIGZsYWcuCmZvciAodmFyIGkgPSAwOyBpIDwgUjsgaSsrKSB7CiAgOwogIGlmICghcmVbaV0pCiAgICByZVtpXSA9IG5ldyBSZWdFeHAoc3JjW2ldKTsKfQoKZXhwb3J0cy5wYXJzZSA9IHBhcnNlOwpmdW5jdGlvbiBwYXJzZSh2ZXJzaW9uLCBsb29zZSkgewogIHZhciByID0gbG9vc2UgPyByZVtMT09TRV0gOiByZVtGVUxMXTsKICByZXR1cm4gKHIudGVzdCh2ZXJzaW9uKSkgPyBuZXcgU2VtVmVyKHZlcnNpb24sIGxvb3NlKSA6IG51bGw7Cn0KCmV4cG9ydHMudmFsaWQgPSB2YWxpZDsKZnVuY3Rpb24gdmFsaWQodmVyc2lvbiwgbG9vc2UpIHsKICB2YXIgdiA9IHBhcnNlKHZlcnNpb24sIGxvb3NlKTsKICByZXR1cm4gdiA/IHYudmVyc2lvbiA6IG51bGw7Cn0KCgpleHBvcnRzLmNsZWFuID0gY2xlYW47CmZ1bmN0aW9uIGNsZWFuKHZlcnNpb24sIGxvb3NlKSB7CiAgdmFyIHMgPSBwYXJzZSh2ZXJzaW9uLnRyaW0oKS5yZXBsYWNlKC9eWz12XSsvLCAnJyksIGxvb3NlKTsKICByZXR1cm4gcyA/IHMudmVyc2lvbiA6IG51bGw7Cn0KCmV4cG9ydHMuU2VtVmVyID0gU2VtVmVyOwoKZnVuY3Rpb24gU2VtVmVyKHZlcnNpb24sIGxvb3NlKSB7CiAgaWYgKHZlcnNpb24gaW5zdGFuY2VvZiBTZW1WZXIpIHsKICAgIGlmICh2ZXJzaW9uLmxvb3NlID09PSBsb29zZSkKICAgICAgcmV0dXJuIHZlcnNpb247CiAgICBlbHNlCiAgICAgIHZlcnNpb24gPSB2ZXJzaW9uLnZlcnNpb247CiAgfSBlbHNlIGlmICh0eXBlb2YgdmVyc2lvbiAhPT0gJ3N0cmluZycpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgVmVyc2lvbjogJyArIHZlcnNpb24pOwogIH0KCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFNlbVZlcikpCiAgICByZXR1cm4gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSk7CgogIDsKICB0aGlzLmxvb3NlID0gbG9vc2U7CiAgdmFyIG0gPSB2ZXJzaW9uLnRyaW0oKS5tYXRjaChsb29zZSA/IHJlW0xPT1NFXSA6IHJlW0ZVTExdKTsKCiAgaWYgKCFtKQogICAgdGhyb3cgbmV3IFR5cGVFcnJvcignSW52YWxpZCBWZXJzaW9uOiAnICsgdmVyc2lvbik7CgogIHRoaXMucmF3ID0gdmVyc2lvbjsKCiAgLy8gdGhlc2UgYXJlIGFjdHVhbGx5IG51bWJlcnMKICB0aGlzLm1ham9yID0gK21bMV07CiAgdGhpcy5taW5vciA9ICttWzJdOwogIHRoaXMucGF0Y2ggPSArbVszXTsKCiAgLy8gbnVtYmVyaWZ5IGFueSBwcmVyZWxlYXNlIG51bWVyaWMgaWRzCiAgaWYgKCFtWzRdKQogICAgdGhpcy5wcmVyZWxlYXNlID0gW107CiAgZWxzZQogICAgdGhpcy5wcmVyZWxlYXNlID0gbVs0XS5zcGxpdCgnLicpLm1hcChmdW5jdGlvbihpZCkgewogICAgICByZXR1cm4gKC9eWzAtOV0rJC8udGVzdChpZCkpID8gK2lkIDogaWQ7CiAgICB9KTsKCiAgdGhpcy5idWlsZCA9IG1bNV0gPyBtWzVdLnNwbGl0KCcuJykgOiBbXTsKICB0aGlzLmZvcm1hdCgpOwp9CgpTZW1WZXIucHJvdG90eXBlLmZvcm1hdCA9IGZ1bmN0aW9uKCkgewogIHRoaXMudmVyc2lvbiA9IHRoaXMubWFqb3IgKyAnLicgKyB0aGlzLm1pbm9yICsgJy4nICsgdGhpcy5wYXRjaDsKICBpZiAodGhpcy5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHRoaXMudmVyc2lvbiArPSAnLScgKyB0aGlzLnByZXJlbGVhc2Uuam9pbignLicpOwogIHJldHVybiB0aGlzLnZlcnNpb247Cn07CgpTZW1WZXIucHJvdG90eXBlLmluc3BlY3QgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gJzxTZW1WZXIgIicgKyB0aGlzICsgJyI+JzsKfTsKClNlbVZlci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy52ZXJzaW9uOwp9OwoKU2VtVmVyLnByb3RvdHlwZS5jb21wYXJlID0gZnVuY3Rpb24ob3RoZXIpIHsKICA7CiAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBTZW1WZXIpKQogICAgb3RoZXIgPSBuZXcgU2VtVmVyKG90aGVyLCB0aGlzLmxvb3NlKTsKCiAgcmV0dXJuIHRoaXMuY29tcGFyZU1haW4ob3RoZXIpIHx8IHRoaXMuY29tcGFyZVByZShvdGhlcik7Cn07CgpTZW1WZXIucHJvdG90eXBlLmNvbXBhcmVNYWluID0gZnVuY3Rpb24ob3RoZXIpIHsKICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIFNlbVZlcikpCiAgICBvdGhlciA9IG5ldyBTZW1WZXIob3RoZXIsIHRoaXMubG9vc2UpOwoKICByZXR1cm4gY29tcGFyZUlkZW50aWZpZXJzKHRoaXMubWFqb3IsIG90aGVyLm1ham9yKSB8fAogICAgICAgICBjb21wYXJlSWRlbnRpZmllcnModGhpcy5taW5vciwgb3RoZXIubWlub3IpIHx8CiAgICAgICAgIGNvbXBhcmVJZGVudGlmaWVycyh0aGlzLnBhdGNoLCBvdGhlci5wYXRjaCk7Cn07CgpTZW1WZXIucHJvdG90eXBlLmNvbXBhcmVQcmUgPSBmdW5jdGlvbihvdGhlcikgewogIGlmICghKG90aGVyIGluc3RhbmNlb2YgU2VtVmVyKSkKICAgIG90aGVyID0gbmV3IFNlbVZlcihvdGhlciwgdGhpcy5sb29zZSk7CgogIC8vIE5PVCBoYXZpbmcgYSBwcmVyZWxlYXNlIGlzID4gaGF2aW5nIG9uZQogIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoICYmICFvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAtMTsKICBlbHNlIGlmICghdGhpcy5wcmVyZWxlYXNlLmxlbmd0aCAmJiBvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAxOwogIGVsc2UgaWYgKCF0aGlzLnByZXJlbGVhc2UubGVuZ3RoICYmICFvdGhlci5wcmVyZWxlYXNlLmxlbmd0aCkKICAgIHJldHVybiAwOwoKICB2YXIgaSA9IDA7CiAgZG8gewogICAgdmFyIGEgPSB0aGlzLnByZXJlbGVhc2VbaV07CiAgICB2YXIgYiA9IG90aGVyLnByZXJlbGVhc2VbaV07CiAgICA7CiAgICBpZiAoYSA9PT0gdW5kZWZpbmVkICYmIGIgPT09IHVuZGVmaW5lZCkKICAgICAgcmV0dXJuIDA7CiAgICBlbHNlIGlmIChiID09PSB1bmRlZmluZWQpCiAgICAgIHJldHVybiAxOwogICAgZWxzZSBpZiAoYSA9PT0gdW5kZWZpbmVkKQogICAgICByZXR1cm4gLTE7CiAgICBlbHNlIGlmIChhID09PSBiKQogICAgICBjb250aW51ZTsKICAgIGVsc2UKICAgICAgcmV0dXJuIGNvbXBhcmVJZGVudGlmaWVycyhhLCBiKTsKICB9IHdoaWxlICgrK2kpOwp9OwoKLy8gcHJlbWlub3Igd2lsbCBidW1wIHRoZSB2ZXJzaW9uIHVwIHRvIHRoZSBuZXh0IG1pbm9yIHJlbGVhc2UsIGFuZCBpbW1lZGlhdGVseQovLyBkb3duIHRvIHByZS1yZWxlYXNlLiBwcmVtYWpvciBhbmQgcHJlcGF0Y2ggd29yayB0aGUgc2FtZSB3YXkuClNlbVZlci5wcm90b3R5cGUuaW5jID0gZnVuY3Rpb24ocmVsZWFzZSwgaWRlbnRpZmllcikgewogIHN3aXRjaCAocmVsZWFzZSkgewogICAgY2FzZSAncHJlbWFqb3InOgogICAgICB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID0gMDsKICAgICAgdGhpcy5wYXRjaCA9IDA7CiAgICAgIHRoaXMubWlub3IgPSAwOwogICAgICB0aGlzLm1ham9yKys7CiAgICAgIHRoaXMuaW5jKCdwcmUnLCBpZGVudGlmaWVyKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdwcmVtaW5vcic6CiAgICAgIHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPSAwOwogICAgICB0aGlzLnBhdGNoID0gMDsKICAgICAgdGhpcy5taW5vcisrOwogICAgICB0aGlzLmluYygncHJlJywgaWRlbnRpZmllcik7CiAgICAgIGJyZWFrOwogICAgY2FzZSAncHJlcGF0Y2gnOgogICAgICAvLyBJZiB0aGlzIGlzIGFscmVhZHkgYSBwcmVyZWxlYXNlLCBpdCB3aWxsIGJ1bXAgdG8gdGhlIG5leHQgdmVyc2lvbgogICAgICAvLyBkcm9wIGFueSBwcmVyZWxlYXNlcyB0aGF0IG1pZ2h0IGFscmVhZHkgZXhpc3QsIHNpbmNlIHRoZXkgYXJlIG5vdAogICAgICAvLyByZWxldmFudCBhdCB0aGlzIHBvaW50LgogICAgICB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID0gMDsKICAgICAgdGhpcy5pbmMoJ3BhdGNoJywgaWRlbnRpZmllcik7CiAgICAgIHRoaXMuaW5jKCdwcmUnLCBpZGVudGlmaWVyKTsKICAgICAgYnJlYWs7CiAgICAvLyBJZiB0aGUgaW5wdXQgaXMgYSBub24tcHJlcmVsZWFzZSB2ZXJzaW9uLCB0aGlzIGFjdHMgdGhlIHNhbWUgYXMKICAgIC8vIHByZXBhdGNoLgogICAgY2FzZSAncHJlcmVsZWFzZSc6CiAgICAgIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMuaW5jKCdwYXRjaCcsIGlkZW50aWZpZXIpOwogICAgICB0aGlzLmluYygncHJlJywgaWRlbnRpZmllcik7CiAgICAgIGJyZWFrOwoKICAgIGNhc2UgJ21ham9yJzoKICAgICAgLy8gSWYgdGhpcyBpcyBhIHByZS1tYWpvciB2ZXJzaW9uLCBidW1wIHVwIHRvIHRoZSBzYW1lIG1ham9yIHZlcnNpb24uCiAgICAgIC8vIE90aGVyd2lzZSBpbmNyZW1lbnQgbWFqb3IuCiAgICAgIC8vIDEuMC4wLTUgYnVtcHMgdG8gMS4wLjAKICAgICAgLy8gMS4xLjAgYnVtcHMgdG8gMi4wLjAKICAgICAgaWYgKHRoaXMubWlub3IgIT09IDAgfHwgdGhpcy5wYXRjaCAhPT0gMCB8fCB0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMubWFqb3IrKzsKICAgICAgdGhpcy5taW5vciA9IDA7CiAgICAgIHRoaXMucGF0Y2ggPSAwOwogICAgICB0aGlzLnByZXJlbGVhc2UgPSBbXTsKICAgICAgYnJlYWs7CiAgICBjYXNlICdtaW5vcic6CiAgICAgIC8vIElmIHRoaXMgaXMgYSBwcmUtbWlub3IgdmVyc2lvbiwgYnVtcCB1cCB0byB0aGUgc2FtZSBtaW5vciB2ZXJzaW9uLgogICAgICAvLyBPdGhlcndpc2UgaW5jcmVtZW50IG1pbm9yLgogICAgICAvLyAxLjIuMC01IGJ1bXBzIHRvIDEuMi4wCiAgICAgIC8vIDEuMi4xIGJ1bXBzIHRvIDEuMy4wCiAgICAgIGlmICh0aGlzLnBhdGNoICE9PSAwIHx8IHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5taW5vcisrOwogICAgICB0aGlzLnBhdGNoID0gMDsKICAgICAgdGhpcy5wcmVyZWxlYXNlID0gW107CiAgICAgIGJyZWFrOwogICAgY2FzZSAncGF0Y2gnOgogICAgICAvLyBJZiB0aGlzIGlzIG5vdCBhIHByZS1yZWxlYXNlIHZlcnNpb24sIGl0IHdpbGwgaW5jcmVtZW50IHRoZSBwYXRjaC4KICAgICAgLy8gSWYgaXQgaXMgYSBwcmUtcmVsZWFzZSBpdCB3aWxsIGJ1bXAgdXAgdG8gdGhlIHNhbWUgcGF0Y2ggdmVyc2lvbi4KICAgICAgLy8gMS4yLjAtNSBwYXRjaGVzIHRvIDEuMi4wCiAgICAgIC8vIDEuMi4wIHBhdGNoZXMgdG8gMS4yLjEKICAgICAgaWYgKHRoaXMucHJlcmVsZWFzZS5sZW5ndGggPT09IDApCiAgICAgICAgdGhpcy5wYXRjaCsrOwogICAgICB0aGlzLnByZXJlbGVhc2UgPSBbXTsKICAgICAgYnJlYWs7CiAgICAvLyBUaGlzIHByb2JhYmx5IHNob3VsZG4ndCBiZSB1c2VkIHB1YmxpY2x5LgogICAgLy8gMS4wLjAgInByZSIgd291bGQgYmVjb21lIDEuMC4wLTAgd2hpY2ggaXMgdGhlIHdyb25nIGRpcmVjdGlvbi4KICAgIGNhc2UgJ3ByZSc6CiAgICAgIGlmICh0aGlzLnByZXJlbGVhc2UubGVuZ3RoID09PSAwKQogICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFswXTsKICAgICAgZWxzZSB7CiAgICAgICAgdmFyIGkgPSB0aGlzLnByZXJlbGVhc2UubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkgPj0gMCkgewogICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnByZXJlbGVhc2VbaV0gPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHRoaXMucHJlcmVsZWFzZVtpXSsrOwogICAgICAgICAgICBpID0gLTI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChpID09PSAtMSkgLy8gZGlkbid0IGluY3JlbWVudCBhbnl0aGluZwogICAgICAgICAgdGhpcy5wcmVyZWxlYXNlLnB1c2goMCk7CiAgICAgIH0KICAgICAgaWYgKGlkZW50aWZpZXIpIHsKICAgICAgICAvLyAxLjIuMC1iZXRhLjEgYnVtcHMgdG8gMS4yLjAtYmV0YS4yLAogICAgICAgIC8vIDEuMi4wLWJldGEuZm9vYmx6IG9yIDEuMi4wLWJldGEgYnVtcHMgdG8gMS4yLjAtYmV0YS4wCiAgICAgICAgaWYgKHRoaXMucHJlcmVsZWFzZVswXSA9PT0gaWRlbnRpZmllcikgewogICAgICAgICAgaWYgKGlzTmFOKHRoaXMucHJlcmVsZWFzZVsxXSkpCiAgICAgICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFtpZGVudGlmaWVyLCAwXTsKICAgICAgICB9IGVsc2UKICAgICAgICAgIHRoaXMucHJlcmVsZWFzZSA9IFtpZGVudGlmaWVyLCAwXTsKICAgICAgfQogICAgICBicmVhazsKCiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgaW5jcmVtZW50IGFyZ3VtZW50OiAnICsgcmVsZWFzZSk7CiAgfQogIHRoaXMuZm9ybWF0KCk7CiAgcmV0dXJuIHRoaXM7Cn07CgpleHBvcnRzLmluYyA9IGluYzsKZnVuY3Rpb24gaW5jKHZlcnNpb24sIHJlbGVhc2UsIGxvb3NlLCBpZGVudGlmaWVyKSB7CiAgaWYgKHR5cGVvZihsb29zZSkgPT09ICdzdHJpbmcnKSB7CiAgICBpZGVudGlmaWVyID0gbG9vc2U7CiAgICBsb29zZSA9IHVuZGVmaW5lZDsKICB9CgogIHRyeSB7CiAgICByZXR1cm4gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSkuaW5jKHJlbGVhc2UsIGlkZW50aWZpZXIpLnZlcnNpb247CiAgfSBjYXRjaCAoZXIpIHsKICAgIHJldHVybiBudWxsOwogIH0KfQoKZXhwb3J0cy5jb21wYXJlSWRlbnRpZmllcnMgPSBjb21wYXJlSWRlbnRpZmllcnM7Cgp2YXIgbnVtZXJpYyA9IC9eWzAtOV0rJC87CmZ1bmN0aW9uIGNvbXBhcmVJZGVudGlmaWVycyhhLCBiKSB7CiAgdmFyIGFudW0gPSBudW1lcmljLnRlc3QoYSk7CiAgdmFyIGJudW0gPSBudW1lcmljLnRlc3QoYik7CgogIGlmIChhbnVtICYmIGJudW0pIHsKICAgIGEgPSArYTsKICAgIGIgPSArYjsKICB9CgogIHJldHVybiAoYW51bSAmJiAhYm51bSkgPyAtMSA6CiAgICAgICAgIChibnVtICYmICFhbnVtKSA/IDEgOgogICAgICAgICBhIDwgYiA/IC0xIDoKICAgICAgICAgYSA+IGIgPyAxIDoKICAgICAgICAgMDsKfQoKZXhwb3J0cy5yY29tcGFyZUlkZW50aWZpZXJzID0gcmNvbXBhcmVJZGVudGlmaWVyczsKZnVuY3Rpb24gcmNvbXBhcmVJZGVudGlmaWVycyhhLCBiKSB7CiAgcmV0dXJuIGNvbXBhcmVJZGVudGlmaWVycyhiLCBhKTsKfQoKZXhwb3J0cy5jb21wYXJlID0gY29tcGFyZTsKZnVuY3Rpb24gY29tcGFyZShhLCBiLCBsb29zZSkgewogIHJldHVybiBuZXcgU2VtVmVyKGEsIGxvb3NlKS5jb21wYXJlKGIpOwp9CgpleHBvcnRzLmNvbXBhcmVMb29zZSA9IGNvbXBhcmVMb29zZTsKZnVuY3Rpb24gY29tcGFyZUxvb3NlKGEsIGIpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCB0cnVlKTsKfQoKZXhwb3J0cy5yY29tcGFyZSA9IHJjb21wYXJlOwpmdW5jdGlvbiByY29tcGFyZShhLCBiLCBsb29zZSkgewogIHJldHVybiBjb21wYXJlKGIsIGEsIGxvb3NlKTsKfQoKZXhwb3J0cy5zb3J0ID0gc29ydDsKZnVuY3Rpb24gc29ydChsaXN0LCBsb29zZSkgewogIHJldHVybiBsaXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGV4cG9ydHMuY29tcGFyZShhLCBiLCBsb29zZSk7CiAgfSk7Cn0KCmV4cG9ydHMucnNvcnQgPSByc29ydDsKZnVuY3Rpb24gcnNvcnQobGlzdCwgbG9vc2UpIHsKICByZXR1cm4gbGlzdC5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBleHBvcnRzLnJjb21wYXJlKGEsIGIsIGxvb3NlKTsKICB9KTsKfQoKZXhwb3J0cy5ndCA9IGd0OwpmdW5jdGlvbiBndChhLCBiLCBsb29zZSkgewogIHJldHVybiBjb21wYXJlKGEsIGIsIGxvb3NlKSA+IDA7Cn0KCmV4cG9ydHMubHQgPSBsdDsKZnVuY3Rpb24gbHQoYSwgYiwgbG9vc2UpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCBsb29zZSkgPCAwOwp9CgpleHBvcnRzLmVxID0gZXE7CmZ1bmN0aW9uIGVxKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpID09PSAwOwp9CgpleHBvcnRzLm5lcSA9IG5lcTsKZnVuY3Rpb24gbmVxKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpICE9PSAwOwp9CgpleHBvcnRzLmd0ZSA9IGd0ZTsKZnVuY3Rpb24gZ3RlKGEsIGIsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXBhcmUoYSwgYiwgbG9vc2UpID49IDA7Cn0KCmV4cG9ydHMubHRlID0gbHRlOwpmdW5jdGlvbiBsdGUoYSwgYiwgbG9vc2UpIHsKICByZXR1cm4gY29tcGFyZShhLCBiLCBsb29zZSkgPD0gMDsKfQoKZXhwb3J0cy5jbXAgPSBjbXA7CmZ1bmN0aW9uIGNtcChhLCBvcCwgYiwgbG9vc2UpIHsKICB2YXIgcmV0OwogIHN3aXRjaCAob3ApIHsKICAgIGNhc2UgJz09PSc6CiAgICAgIGlmICh0eXBlb2YgYSA9PT0gJ29iamVjdCcpIGEgPSBhLnZlcnNpb247CiAgICAgIGlmICh0eXBlb2YgYiA9PT0gJ29iamVjdCcpIGIgPSBiLnZlcnNpb247CiAgICAgIHJldCA9IGEgPT09IGI7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnIT09JzoKICAgICAgaWYgKHR5cGVvZiBhID09PSAnb2JqZWN0JykgYSA9IGEudmVyc2lvbjsKICAgICAgaWYgKHR5cGVvZiBiID09PSAnb2JqZWN0JykgYiA9IGIudmVyc2lvbjsKICAgICAgcmV0ID0gYSAhPT0gYjsKICAgICAgYnJlYWs7CiAgICBjYXNlICcnOiBjYXNlICc9JzogY2FzZSAnPT0nOiByZXQgPSBlcShhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnIT0nOiByZXQgPSBuZXEoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGNhc2UgJz4nOiByZXQgPSBndChhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnPj0nOiByZXQgPSBndGUoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGNhc2UgJzwnOiByZXQgPSBsdChhLCBiLCBsb29zZSk7IGJyZWFrOwogICAgY2FzZSAnPD0nOiByZXQgPSBsdGUoYSwgYiwgbG9vc2UpOyBicmVhazsKICAgIGRlZmF1bHQ6IHRocm93IG5ldyBUeXBlRXJyb3IoJ0ludmFsaWQgb3BlcmF0b3I6ICcgKyBvcCk7CiAgfQogIHJldHVybiByZXQ7Cn0KCmV4cG9ydHMuQ29tcGFyYXRvciA9IENvbXBhcmF0b3I7CmZ1bmN0aW9uIENvbXBhcmF0b3IoY29tcCwgbG9vc2UpIHsKICBpZiAoY29tcCBpbnN0YW5jZW9mIENvbXBhcmF0b3IpIHsKICAgIGlmIChjb21wLmxvb3NlID09PSBsb29zZSkKICAgICAgcmV0dXJuIGNvbXA7CiAgICBlbHNlCiAgICAgIGNvbXAgPSBjb21wLnZhbHVlOwogIH0KCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIENvbXBhcmF0b3IpKQogICAgcmV0dXJuIG5ldyBDb21wYXJhdG9yKGNvbXAsIGxvb3NlKTsKCiAgOwogIHRoaXMubG9vc2UgPSBsb29zZTsKICB0aGlzLnBhcnNlKGNvbXApOwoKICBpZiAodGhpcy5zZW12ZXIgPT09IEFOWSkKICAgIHRoaXMudmFsdWUgPSAnJzsKICBlbHNlCiAgICB0aGlzLnZhbHVlID0gdGhpcy5vcGVyYXRvciArIHRoaXMuc2VtdmVyLnZlcnNpb247CgogIDsKfQoKdmFyIEFOWSA9IHt9OwpDb21wYXJhdG9yLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGNvbXApIHsKICB2YXIgciA9IHRoaXMubG9vc2UgPyByZVtDT01QQVJBVE9STE9PU0VdIDogcmVbQ09NUEFSQVRPUl07CiAgdmFyIG0gPSBjb21wLm1hdGNoKHIpOwoKICBpZiAoIW0pCiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIGNvbXBhcmF0b3I6ICcgKyBjb21wKTsKCiAgdGhpcy5vcGVyYXRvciA9IG1bMV07CiAgaWYgKHRoaXMub3BlcmF0b3IgPT09ICc9JykKICAgIHRoaXMub3BlcmF0b3IgPSAnJzsKCiAgLy8gaWYgaXQgbGl0ZXJhbGx5IGlzIGp1c3QgJz4nIG9yICcnIHRoZW4gYWxsb3cgYW55dGhpbmcuCiAgaWYgKCFtWzJdKQogICAgdGhpcy5zZW12ZXIgPSBBTlk7CiAgZWxzZQogICAgdGhpcy5zZW12ZXIgPSBuZXcgU2VtVmVyKG1bMl0sIHRoaXMubG9vc2UpOwp9OwoKQ29tcGFyYXRvci5wcm90b3R5cGUuaW5zcGVjdCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAnPFNlbVZlciBDb21wYXJhdG9yICInICsgdGhpcyArICciPic7Cn07CgpDb21wYXJhdG9yLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLnZhbHVlOwp9OwoKQ29tcGFyYXRvci5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uKHZlcnNpb24pIHsKICA7CgogIGlmICh0aGlzLnNlbXZlciA9PT0gQU5ZKQogICAgcmV0dXJuIHRydWU7CgogIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpCiAgICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCB0aGlzLmxvb3NlKTsKCiAgcmV0dXJuIGNtcCh2ZXJzaW9uLCB0aGlzLm9wZXJhdG9yLCB0aGlzLnNlbXZlciwgdGhpcy5sb29zZSk7Cn07CgoKZXhwb3J0cy5SYW5nZSA9IFJhbmdlOwpmdW5jdGlvbiBSYW5nZShyYW5nZSwgbG9vc2UpIHsKICBpZiAoKHJhbmdlIGluc3RhbmNlb2YgUmFuZ2UpICYmIHJhbmdlLmxvb3NlID09PSBsb29zZSkKICAgIHJldHVybiByYW5nZTsKCiAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIFJhbmdlKSkKICAgIHJldHVybiBuZXcgUmFuZ2UocmFuZ2UsIGxvb3NlKTsKCiAgdGhpcy5sb29zZSA9IGxvb3NlOwoKICAvLyBGaXJzdCwgc3BsaXQgYmFzZWQgb24gYm9vbGVhbiBvciB8fAogIHRoaXMucmF3ID0gcmFuZ2U7CiAgdGhpcy5zZXQgPSByYW5nZS5zcGxpdCgvXHMqXHxcfFxzKi8pLm1hcChmdW5jdGlvbihyYW5nZSkgewogICAgcmV0dXJuIHRoaXMucGFyc2VSYW5nZShyYW5nZS50cmltKCkpOwogIH0sIHRoaXMpLmZpbHRlcihmdW5jdGlvbihjKSB7CiAgICAvLyB0aHJvdyBvdXQgYW55IHRoYXQgYXJlIG5vdCByZWxldmFudCBmb3Igd2hhdGV2ZXIgcmVhc29uCiAgICByZXR1cm4gYy5sZW5ndGg7CiAgfSk7CgogIGlmICghdGhpcy5zZXQubGVuZ3RoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIFNlbVZlciBSYW5nZTogJyArIHJhbmdlKTsKICB9CgogIHRoaXMuZm9ybWF0KCk7Cn0KClJhbmdlLnByb3RvdHlwZS5pbnNwZWN0ID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuICc8U2VtVmVyIFJhbmdlICInICsgdGhpcy5yYW5nZSArICciPic7Cn07CgpSYW5nZS5wcm90b3R5cGUuZm9ybWF0ID0gZnVuY3Rpb24oKSB7CiAgdGhpcy5yYW5nZSA9IHRoaXMuc2V0Lm1hcChmdW5jdGlvbihjb21wcykgewogICAgcmV0dXJuIGNvbXBzLmpvaW4oJyAnKS50cmltKCk7CiAgfSkuam9pbignfHwnKS50cmltKCk7CiAgcmV0dXJuIHRoaXMucmFuZ2U7Cn07CgpSYW5nZS5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5yYW5nZTsKfTsKClJhbmdlLnByb3RvdHlwZS5wYXJzZVJhbmdlID0gZnVuY3Rpb24ocmFuZ2UpIHsKICB2YXIgbG9vc2UgPSB0aGlzLmxvb3NlOwogIHJhbmdlID0gcmFuZ2UudHJpbSgpOwogIDsKICAvLyBgMS4yLjMgLSAxLjIuNGAgPT4gYD49MS4yLjMgPD0xLjIuNGAKICB2YXIgaHIgPSBsb29zZSA/IHJlW0hZUEhFTlJBTkdFTE9PU0VdIDogcmVbSFlQSEVOUkFOR0VdOwogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShociwgaHlwaGVuUmVwbGFjZSk7CiAgOwogIC8vIGA+IDEuMi4zIDwgMS4yLjVgID0+IGA+MS4yLjMgPDEuMi41YAogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShyZVtDT01QQVJBVE9SVFJJTV0sIGNvbXBhcmF0b3JUcmltUmVwbGFjZSk7CiAgOwoKICAvLyBgfiAxLjIuM2AgPT4gYH4xLjIuM2AKICByYW5nZSA9IHJhbmdlLnJlcGxhY2UocmVbVElMREVUUklNXSwgdGlsZGVUcmltUmVwbGFjZSk7CgogIC8vIGBeIDEuMi4zYCA9PiBgXjEuMi4zYAogIHJhbmdlID0gcmFuZ2UucmVwbGFjZShyZVtDQVJFVFRSSU1dLCBjYXJldFRyaW1SZXBsYWNlKTsKCiAgLy8gbm9ybWFsaXplIHNwYWNlcwogIHJhbmdlID0gcmFuZ2Uuc3BsaXQoL1xzKy8pLmpvaW4oJyAnKTsKCiAgLy8gQXQgdGhpcyBwb2ludCwgdGhlIHJhbmdlIGlzIGNvbXBsZXRlbHkgdHJpbW1lZCBhbmQKICAvLyByZWFkeSB0byBiZSBzcGxpdCBpbnRvIGNvbXBhcmF0b3JzLgoKICB2YXIgY29tcFJlID0gbG9vc2UgPyByZVtDT01QQVJBVE9STE9PU0VdIDogcmVbQ09NUEFSQVRPUl07CiAgdmFyIHNldCA9IHJhbmdlLnNwbGl0KCcgJykubWFwKGZ1bmN0aW9uKGNvbXApIHsKICAgIHJldHVybiBwYXJzZUNvbXBhcmF0b3IoY29tcCwgbG9vc2UpOwogIH0pLmpvaW4oJyAnKS5zcGxpdCgvXHMrLyk7CiAgaWYgKHRoaXMubG9vc2UpIHsKICAgIC8vIGluIGxvb3NlIG1vZGUsIHRocm93IG91dCBhbnkgdGhhdCBhcmUgbm90IHZhbGlkIGNvbXBhcmF0b3JzCiAgICBzZXQgPSBzZXQuZmlsdGVyKGZ1bmN0aW9uKGNvbXApIHsKICAgICAgcmV0dXJuICEhY29tcC5tYXRjaChjb21wUmUpOwogICAgfSk7CiAgfQogIHNldCA9IHNldC5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIG5ldyBDb21wYXJhdG9yKGNvbXAsIGxvb3NlKTsKICB9KTsKCiAgcmV0dXJuIHNldDsKfTsKCi8vIE1vc3RseSBqdXN0IGZvciB0ZXN0aW5nIGFuZCBsZWdhY3kgQVBJIHJlYXNvbnMKZXhwb3J0cy50b0NvbXBhcmF0b3JzID0gdG9Db21wYXJhdG9yczsKZnVuY3Rpb24gdG9Db21wYXJhdG9ycyhyYW5nZSwgbG9vc2UpIHsKICByZXR1cm4gbmV3IFJhbmdlKHJhbmdlLCBsb29zZSkuc2V0Lm1hcChmdW5jdGlvbihjb21wKSB7CiAgICByZXR1cm4gY29tcC5tYXAoZnVuY3Rpb24oYykgewogICAgICByZXR1cm4gYy52YWx1ZTsKICAgIH0pLmpvaW4oJyAnKS50cmltKCkuc3BsaXQoJyAnKTsKICB9KTsKfQoKLy8gY29tcHJpc2VkIG9mIHhyYW5nZXMsIHRpbGRlcywgc3RhcnMsIGFuZCBndGx0J3MgYXQgdGhpcyBwb2ludC4KLy8gYWxyZWFkeSByZXBsYWNlZCB0aGUgaHlwaGVuIHJhbmdlcwovLyB0dXJuIGludG8gYSBzZXQgb2YgSlVTVCBjb21wYXJhdG9ycy4KZnVuY3Rpb24gcGFyc2VDb21wYXJhdG9yKGNvbXAsIGxvb3NlKSB7CiAgOwogIGNvbXAgPSByZXBsYWNlQ2FyZXRzKGNvbXAsIGxvb3NlKTsKICA7CiAgY29tcCA9IHJlcGxhY2VUaWxkZXMoY29tcCwgbG9vc2UpOwogIDsKICBjb21wID0gcmVwbGFjZVhSYW5nZXMoY29tcCwgbG9vc2UpOwogIDsKICBjb21wID0gcmVwbGFjZVN0YXJzKGNvbXAsIGxvb3NlKTsKICA7CiAgcmV0dXJuIGNvbXA7Cn0KCmZ1bmN0aW9uIGlzWChpZCkgewogIHJldHVybiAhaWQgfHwgaWQudG9Mb3dlckNhc2UoKSA9PT0gJ3gnIHx8IGlkID09PSAnKic7Cn0KCi8vIH4sIH4+IC0tPiAqIChhbnksIGtpbmRhIHNpbGx5KQovLyB+MiwgfjIueCwgfjIueC54LCB+PjIsIH4+Mi54IH4+Mi54LnggLS0+ID49Mi4wLjAgPDMuMC4wCi8vIH4yLjAsIH4yLjAueCwgfj4yLjAsIH4+Mi4wLnggLS0+ID49Mi4wLjAgPDIuMS4wCi8vIH4xLjIsIH4xLjIueCwgfj4xLjIsIH4+MS4yLnggLS0+ID49MS4yLjAgPDEuMy4wCi8vIH4xLjIuMywgfj4xLjIuMyAtLT4gPj0xLjIuMyA8MS4zLjAKLy8gfjEuMi4wLCB+PjEuMi4wIC0tPiA+PTEuMi4wIDwxLjMuMApmdW5jdGlvbiByZXBsYWNlVGlsZGVzKGNvbXAsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXAudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIHJlcGxhY2VUaWxkZShjb21wLCBsb29zZSk7CiAgfSkuam9pbignICcpOwp9CgpmdW5jdGlvbiByZXBsYWNlVGlsZGUoY29tcCwgbG9vc2UpIHsKICB2YXIgciA9IGxvb3NlID8gcmVbVElMREVMT09TRV0gOiByZVtUSUxERV07CiAgcmV0dXJuIGNvbXAucmVwbGFjZShyLCBmdW5jdGlvbihfLCBNLCBtLCBwLCBwcikgewogICAgOwogICAgdmFyIHJldDsKCiAgICBpZiAoaXNYKE0pKQogICAgICByZXQgPSAnJzsKICAgIGVsc2UgaWYgKGlzWChtKSkKICAgICAgcmV0ID0gJz49JyArIE0gKyAnLjAuMCA8JyArICgrTSArIDEpICsgJy4wLjAnOwogICAgZWxzZSBpZiAoaXNYKHApKQogICAgICAvLyB+MS4yID09ID49MS4yLjAtIDwxLjMuMC0KICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4wIDwnICsgTSArICcuJyArICgrbSArIDEpICsgJy4wJzsKICAgIGVsc2UgaWYgKHByKSB7CiAgICAgIDsKICAgICAgaWYgKHByLmNoYXJBdCgwKSAhPT0gJy0nKQogICAgICAgIHByID0gJy0nICsgcHI7CiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKyBwciArCiAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgKCttICsgMSkgKyAnLjAnOwogICAgfSBlbHNlCiAgICAgIC8vIH4xLjIuMyA9PSA+PTEuMi4zIDwxLjMuMAogICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsKICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CgogICAgOwogICAgcmV0dXJuIHJldDsKICB9KTsKfQoKLy8gXiAtLT4gKiAoYW55LCBraW5kYSBzaWxseSkKLy8gXjIsIF4yLngsIF4yLngueCAtLT4gPj0yLjAuMCA8My4wLjAKLy8gXjIuMCwgXjIuMC54IC0tPiA+PTIuMC4wIDwzLjAuMAovLyBeMS4yLCBeMS4yLnggLS0+ID49MS4yLjAgPDIuMC4wCi8vIF4xLjIuMyAtLT4gPj0xLjIuMyA8Mi4wLjAKLy8gXjEuMi4wIC0tPiA+PTEuMi4wIDwyLjAuMApmdW5jdGlvbiByZXBsYWNlQ2FyZXRzKGNvbXAsIGxvb3NlKSB7CiAgcmV0dXJuIGNvbXAudHJpbSgpLnNwbGl0KC9ccysvKS5tYXAoZnVuY3Rpb24oY29tcCkgewogICAgcmV0dXJuIHJlcGxhY2VDYXJldChjb21wLCBsb29zZSk7CiAgfSkuam9pbignICcpOwp9CgpmdW5jdGlvbiByZXBsYWNlQ2FyZXQoY29tcCwgbG9vc2UpIHsKICA7CiAgdmFyIHIgPSBsb29zZSA/IHJlW0NBUkVUTE9PU0VdIDogcmVbQ0FSRVRdOwogIHJldHVybiBjb21wLnJlcGxhY2UociwgZnVuY3Rpb24oXywgTSwgbSwgcCwgcHIpIHsKICAgIDsKICAgIHZhciByZXQ7CgogICAgaWYgKGlzWChNKSkKICAgICAgcmV0ID0gJyc7CiAgICBlbHNlIGlmIChpc1gobSkpCiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4wLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIGVsc2UgaWYgKGlzWChwKSkgewogICAgICBpZiAoTSA9PT0gJzAnKQogICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuMCA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CiAgICAgIGVsc2UKICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSBpZiAocHIpIHsKICAgICAgOwogICAgICBpZiAocHIuY2hhckF0KDApICE9PSAnLScpCiAgICAgICAgcHIgPSAnLScgKyBwcjsKICAgICAgaWYgKE0gPT09ICcwJykgewogICAgICAgIGlmIChtID09PSAnMCcpCiAgICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsgcHIgKwogICAgICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyBtICsgJy4nICsgKCtwICsgMSk7CiAgICAgICAgZWxzZQogICAgICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4nICsgcCArIHByICsKICAgICAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgKCttICsgMSkgKyAnLjAnOwogICAgICB9IGVsc2UKICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsgcHIgKwogICAgICAgICAgICAgICcgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSB7CiAgICAgIDsKICAgICAgaWYgKE0gPT09ICcwJykgewogICAgICAgIGlmIChtID09PSAnMCcpCiAgICAgICAgICByZXQgPSAnPj0nICsgTSArICcuJyArIG0gKyAnLicgKyBwICsKICAgICAgICAgICAgICAgICcgPCcgKyBNICsgJy4nICsgbSArICcuJyArICgrcCArIDEpOwogICAgICAgIGVsc2UKICAgICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKwogICAgICAgICAgICAgICAgJyA8JyArIE0gKyAnLicgKyAoK20gKyAxKSArICcuMCc7CiAgICAgIH0gZWxzZQogICAgICAgIHJldCA9ICc+PScgKyBNICsgJy4nICsgbSArICcuJyArIHAgKwogICAgICAgICAgICAgICcgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0KCiAgICA7CiAgICByZXR1cm4gcmV0OwogIH0pOwp9CgpmdW5jdGlvbiByZXBsYWNlWFJhbmdlcyhjb21wLCBsb29zZSkgewogIDsKICByZXR1cm4gY29tcC5zcGxpdCgvXHMrLykubWFwKGZ1bmN0aW9uKGNvbXApIHsKICAgIHJldHVybiByZXBsYWNlWFJhbmdlKGNvbXAsIGxvb3NlKTsKICB9KS5qb2luKCcgJyk7Cn0KCmZ1bmN0aW9uIHJlcGxhY2VYUmFuZ2UoY29tcCwgbG9vc2UpIHsKICBjb21wID0gY29tcC50cmltKCk7CiAgdmFyIHIgPSBsb29zZSA/IHJlW1hSQU5HRUxPT1NFXSA6IHJlW1hSQU5HRV07CiAgcmV0dXJuIGNvbXAucmVwbGFjZShyLCBmdW5jdGlvbihyZXQsIGd0bHQsIE0sIG0sIHAsIHByKSB7CiAgICA7CiAgICB2YXIgeE0gPSBpc1goTSk7CiAgICB2YXIgeG0gPSB4TSB8fCBpc1gobSk7CiAgICB2YXIgeHAgPSB4bSB8fCBpc1gocCk7CiAgICB2YXIgYW55WCA9IHhwOwoKICAgIGlmIChndGx0ID09PSAnPScgJiYgYW55WCkKICAgICAgZ3RsdCA9ICcnOwoKICAgIGlmICh4TSkgewogICAgICBpZiAoZ3RsdCA9PT0gJz4nIHx8IGd0bHQgPT09ICc8JykgewogICAgICAgIC8vIG5vdGhpbmcgaXMgYWxsb3dlZAogICAgICAgIHJldCA9ICc8MC4wLjAnOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIG5vdGhpbmcgaXMgZm9yYmlkZGVuCiAgICAgICAgcmV0ID0gJyonOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGd0bHQgJiYgYW55WCkgewogICAgICAvLyByZXBsYWNlIFggd2l0aCAwCiAgICAgIGlmICh4bSkKICAgICAgICBtID0gMDsKICAgICAgaWYgKHhwKQogICAgICAgIHAgPSAwOwoKICAgICAgaWYgKGd0bHQgPT09ICc+JykgewogICAgICAgIC8vID4xID0+ID49Mi4wLjAKICAgICAgICAvLyA+MS4yID0+ID49MS4zLjAKICAgICAgICAvLyA+MS4yLjMgPT4gPj0gMS4yLjQKICAgICAgICBndGx0ID0gJz49JzsKICAgICAgICBpZiAoeG0pIHsKICAgICAgICAgIE0gPSArTSArIDE7CiAgICAgICAgICBtID0gMDsKICAgICAgICAgIHAgPSAwOwogICAgICAgIH0gZWxzZSBpZiAoeHApIHsKICAgICAgICAgIG0gPSArbSArIDE7CiAgICAgICAgICBwID0gMDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZ3RsdCA9PT0gJzw9JykgewogICAgICAgIC8vIDw9MC43LnggaXMgYWN0dWFsbHkgPDAuOC4wLCBzaW5jZSBhbnkgMC43Lnggc2hvdWxkCiAgICAgICAgLy8gcGFzcy4gIFNpbWlsYXJseSwgPD03LnggaXMgYWN0dWFsbHkgPDguMC4wLCBldGMuCiAgICAgICAgZ3RsdCA9ICc8JwogICAgICAgIGlmICh4bSkKICAgICAgICAgIE0gPSArTSArIDEKICAgICAgICBlbHNlCiAgICAgICAgICBtID0gK20gKyAxCiAgICAgIH0KCiAgICAgIHJldCA9IGd0bHQgKyBNICsgJy4nICsgbSArICcuJyArIHA7CiAgICB9IGVsc2UgaWYgKHhtKSB7CiAgICAgIHJldCA9ICc+PScgKyBNICsgJy4wLjAgPCcgKyAoK00gKyAxKSArICcuMC4wJzsKICAgIH0gZWxzZSBpZiAoeHApIHsKICAgICAgcmV0ID0gJz49JyArIE0gKyAnLicgKyBtICsgJy4wIDwnICsgTSArICcuJyArICgrbSArIDEpICsgJy4wJzsKICAgIH0KCiAgICA7CgogICAgcmV0dXJuIHJldDsKICB9KTsKfQoKLy8gQmVjYXVzZSAqIGlzIEFORC1lZCB3aXRoIGV2ZXJ5dGhpbmcgZWxzZSBpbiB0aGUgY29tcGFyYXRvciwKLy8gYW5kICcnIG1lYW5zICJhbnkgdmVyc2lvbiIsIGp1c3QgcmVtb3ZlIHRoZSAqcyBlbnRpcmVseS4KZnVuY3Rpb24gcmVwbGFjZVN0YXJzKGNvbXAsIGxvb3NlKSB7CiAgOwogIC8vIExvb3NlbmVzcyBpcyBpZ25vcmVkIGhlcmUuICBzdGFyIGlzIGFsd2F5cyBhcyBsb29zZSBhcyBpdCBnZXRzIQogIHJldHVybiBjb21wLnRyaW0oKS5yZXBsYWNlKHJlW1NUQVJdLCAnJyk7Cn0KCi8vIFRoaXMgZnVuY3Rpb24gaXMgcGFzc2VkIHRvIHN0cmluZy5yZXBsYWNlKHJlW0hZUEhFTlJBTkdFXSkKLy8gTSwgbSwgcGF0Y2gsIHByZXJlbGVhc2UsIGJ1aWxkCi8vIDEuMiAtIDMuNC41ID0+ID49MS4yLjAgPD0zLjQuNQovLyAxLjIuMyAtIDMuNCA9PiA+PTEuMi4wIDwzLjUuMCBBbnkgMy40Lnggd2lsbCBkbwovLyAxLjIgLSAzLjQgPT4gPj0xLjIuMCA8My41LjAKZnVuY3Rpb24gaHlwaGVuUmVwbGFjZSgkMCwKICAgICAgICAgICAgICAgICAgICAgICBmcm9tLCBmTSwgZm0sIGZwLCBmcHIsIGZiLAogICAgICAgICAgICAgICAgICAgICAgIHRvLCB0TSwgdG0sIHRwLCB0cHIsIHRiKSB7CgogIGlmIChpc1goZk0pKQogICAgZnJvbSA9ICcnOwogIGVsc2UgaWYgKGlzWChmbSkpCiAgICBmcm9tID0gJz49JyArIGZNICsgJy4wLjAnOwogIGVsc2UgaWYgKGlzWChmcCkpCiAgICBmcm9tID0gJz49JyArIGZNICsgJy4nICsgZm0gKyAnLjAnOwogIGVsc2UKICAgIGZyb20gPSAnPj0nICsgZnJvbTsKCiAgaWYgKGlzWCh0TSkpCiAgICB0byA9ICcnOwogIGVsc2UgaWYgKGlzWCh0bSkpCiAgICB0byA9ICc8JyArICgrdE0gKyAxKSArICcuMC4wJzsKICBlbHNlIGlmIChpc1godHApKQogICAgdG8gPSAnPCcgKyB0TSArICcuJyArICgrdG0gKyAxKSArICcuMCc7CiAgZWxzZSBpZiAodHByKQogICAgdG8gPSAnPD0nICsgdE0gKyAnLicgKyB0bSArICcuJyArIHRwICsgJy0nICsgdHByOwogIGVsc2UKICAgIHRvID0gJzw9JyArIHRvOwoKICByZXR1cm4gKGZyb20gKyAnICcgKyB0bykudHJpbSgpOwp9CgoKLy8gaWYgQU5ZIG9mIHRoZSBzZXRzIG1hdGNoIEFMTCBvZiBpdHMgY29tcGFyYXRvcnMsIHRoZW4gcGFzcwpSYW5nZS5wcm90b3R5cGUudGVzdCA9IGZ1bmN0aW9uKHZlcnNpb24pIHsKICBpZiAoIXZlcnNpb24pCiAgICByZXR1cm4gZmFsc2U7CgogIGlmICh0eXBlb2YgdmVyc2lvbiA9PT0gJ3N0cmluZycpCiAgICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCB0aGlzLmxvb3NlKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNldC5sZW5ndGg7IGkrKykgewogICAgaWYgKHRlc3RTZXQodGhpcy5zZXRbaV0sIHZlcnNpb24pKQogICAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKZnVuY3Rpb24gdGVzdFNldChzZXQsIHZlcnNpb24pIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKykgewogICAgaWYgKCFzZXRbaV0udGVzdCh2ZXJzaW9uKSkKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgaWYgKHZlcnNpb24ucHJlcmVsZWFzZS5sZW5ndGgpIHsKICAgIC8vIEZpbmQgdGhlIHNldCBvZiB2ZXJzaW9ucyB0aGF0IGFyZSBhbGxvd2VkIHRvIGhhdmUgcHJlcmVsZWFzZXMKICAgIC8vIEZvciBleGFtcGxlLCBeMS4yLjMtcHIuMSBkZXN1Z2FycyB0byA+PTEuMi4zLXByLjEgPDIuMC4wCiAgICAvLyBUaGF0IHNob3VsZCBhbGxvdyBgMS4yLjMtcHIuMmAgdG8gcGFzcy4KICAgIC8vIEhvd2V2ZXIsIGAxLjIuNC1hbHBoYS5ub3RyZWFkeWAgc2hvdWxkIE5PVCBiZSBhbGxvd2VkLAogICAgLy8gZXZlbiB0aG91Z2ggaXQncyB3aXRoaW4gdGhlIHJhbmdlIHNldCBieSB0aGUgY29tcGFyYXRvcnMuCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKykgewogICAgICA7CiAgICAgIGlmIChzZXRbaV0uc2VtdmVyID09PSBBTlkpCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICBpZiAoc2V0W2ldLnNlbXZlci5wcmVyZWxlYXNlLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgYWxsb3dlZCA9IHNldFtpXS5zZW12ZXI7CiAgICAgICAgaWYgKGFsbG93ZWQubWFqb3IgPT09IHZlcnNpb24ubWFqb3IgJiYKICAgICAgICAgICAgYWxsb3dlZC5taW5vciA9PT0gdmVyc2lvbi5taW5vciAmJgogICAgICAgICAgICBhbGxvd2VkLnBhdGNoID09PSB2ZXJzaW9uLnBhdGNoKQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KCiAgICAvLyBWZXJzaW9uIGhhcyBhIC1wcmUsIGJ1dCBpdCdzIG5vdCBvbmUgb2YgdGhlIG9uZXMgd2UgbGlrZS4KICAgIHJldHVybiBmYWxzZTsKICB9CgogIHJldHVybiB0cnVlOwp9CgpleHBvcnRzLnNhdGlzZmllcyA9IHNhdGlzZmllczsKZnVuY3Rpb24gc2F0aXNmaWVzKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHRyeSB7CiAgICByYW5nZSA9IG5ldyBSYW5nZShyYW5nZSwgbG9vc2UpOwogIH0gY2F0Y2ggKGVyKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiByYW5nZS50ZXN0KHZlcnNpb24pOwp9CgpleHBvcnRzLm1heFNhdGlzZnlpbmcgPSBtYXhTYXRpc2Z5aW5nOwpmdW5jdGlvbiBtYXhTYXRpc2Z5aW5nKHZlcnNpb25zLCByYW5nZSwgbG9vc2UpIHsKICByZXR1cm4gdmVyc2lvbnMuZmlsdGVyKGZ1bmN0aW9uKHZlcnNpb24pIHsKICAgIHJldHVybiBzYXRpc2ZpZXModmVyc2lvbiwgcmFuZ2UsIGxvb3NlKTsKICB9KS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiByY29tcGFyZShhLCBiLCBsb29zZSk7CiAgfSlbMF0gfHwgbnVsbDsKfQoKZXhwb3J0cy52YWxpZFJhbmdlID0gdmFsaWRSYW5nZTsKZnVuY3Rpb24gdmFsaWRSYW5nZShyYW5nZSwgbG9vc2UpIHsKICB0cnkgewogICAgLy8gUmV0dXJuICcqJyBpbnN0ZWFkIG9mICcnIHNvIHRoYXQgdHJ1dGhpbmVzcyB3b3Jrcy4KICAgIC8vIFRoaXMgd2lsbCB0aHJvdyBpZiBpdCdzIGludmFsaWQgYW55d2F5CiAgICByZXR1cm4gbmV3IFJhbmdlKHJhbmdlLCBsb29zZSkucmFuZ2UgfHwgJyonOwogIH0gY2F0Y2ggKGVyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KCi8vIERldGVybWluZSBpZiB2ZXJzaW9uIGlzIGxlc3MgdGhhbiBhbGwgdGhlIHZlcnNpb25zIHBvc3NpYmxlIGluIHRoZSByYW5nZQpleHBvcnRzLmx0ciA9IGx0cjsKZnVuY3Rpb24gbHRyKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHJldHVybiBvdXRzaWRlKHZlcnNpb24sIHJhbmdlLCAnPCcsIGxvb3NlKTsKfQoKLy8gRGV0ZXJtaW5lIGlmIHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIGFsbCB0aGUgdmVyc2lvbnMgcG9zc2libGUgaW4gdGhlIHJhbmdlLgpleHBvcnRzLmd0ciA9IGd0cjsKZnVuY3Rpb24gZ3RyKHZlcnNpb24sIHJhbmdlLCBsb29zZSkgewogIHJldHVybiBvdXRzaWRlKHZlcnNpb24sIHJhbmdlLCAnPicsIGxvb3NlKTsKfQoKZXhwb3J0cy5vdXRzaWRlID0gb3V0c2lkZTsKZnVuY3Rpb24gb3V0c2lkZSh2ZXJzaW9uLCByYW5nZSwgaGlsbywgbG9vc2UpIHsKICB2ZXJzaW9uID0gbmV3IFNlbVZlcih2ZXJzaW9uLCBsb29zZSk7CiAgcmFuZ2UgPSBuZXcgUmFuZ2UocmFuZ2UsIGxvb3NlKTsKCiAgdmFyIGd0Zm4sIGx0ZWZuLCBsdGZuLCBjb21wLCBlY29tcDsKICBzd2l0Y2ggKGhpbG8pIHsKICAgIGNhc2UgJz4nOgogICAgICBndGZuID0gZ3Q7CiAgICAgIGx0ZWZuID0gbHRlOwogICAgICBsdGZuID0gbHQ7CiAgICAgIGNvbXAgPSAnPic7CiAgICAgIGVjb21wID0gJz49JzsKICAgICAgYnJlYWs7CiAgICBjYXNlICc8JzoKICAgICAgZ3RmbiA9IGx0OwogICAgICBsdGVmbiA9IGd0ZTsKICAgICAgbHRmbiA9IGd0OwogICAgICBjb21wID0gJzwnOwogICAgICBlY29tcCA9ICc8PSc7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcignTXVzdCBwcm92aWRlIGEgaGlsbyB2YWwgb2YgIjwiIG9yICI+IicpOwogIH0KCiAgLy8gSWYgaXQgc2F0aXNpZmVzIHRoZSByYW5nZSBpdCBpcyBub3Qgb3V0c2lkZQogIGlmIChzYXRpc2ZpZXModmVyc2lvbiwgcmFuZ2UsIGxvb3NlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gRnJvbSBub3cgb24sIHZhcmlhYmxlIHRlcm1zIGFyZSBhcyBpZiB3ZSdyZSBpbiAiZ3RyIiBtb2RlLgogIC8vIGJ1dCBub3RlIHRoYXQgZXZlcnl0aGluZyBpcyBmbGlwcGVkIGZvciB0aGUgImx0ciIgZnVuY3Rpb24uCgogIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2Uuc2V0Lmxlbmd0aDsgKytpKSB7CiAgICB2YXIgY29tcGFyYXRvcnMgPSByYW5nZS5zZXRbaV07CgogICAgdmFyIGhpZ2ggPSBudWxsOwogICAgdmFyIGxvdyA9IG51bGw7CgogICAgY29tcGFyYXRvcnMuZm9yRWFjaChmdW5jdGlvbihjb21wYXJhdG9yKSB7CiAgICAgIGhpZ2ggPSBoaWdoIHx8IGNvbXBhcmF0b3I7CiAgICAgIGxvdyA9IGxvdyB8fCBjb21wYXJhdG9yOwogICAgICBpZiAoZ3Rmbihjb21wYXJhdG9yLnNlbXZlciwgaGlnaC5zZW12ZXIsIGxvb3NlKSkgewogICAgICAgIGhpZ2ggPSBjb21wYXJhdG9yOwogICAgICB9IGVsc2UgaWYgKGx0Zm4oY29tcGFyYXRvci5zZW12ZXIsIGxvdy5zZW12ZXIsIGxvb3NlKSkgewogICAgICAgIGxvdyA9IGNvbXBhcmF0b3I7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIElmIHRoZSBlZGdlIHZlcnNpb24gY29tcGFyYXRvciBoYXMgYSBvcGVyYXRvciB0aGVuIG91ciB2ZXJzaW9uCiAgICAvLyBpc24ndCBvdXRzaWRlIGl0CiAgICBpZiAoaGlnaC5vcGVyYXRvciA9PT0gY29tcCB8fCBoaWdoLm9wZXJhdG9yID09PSBlY29tcCkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgdGhlIGxvd2VzdCB2ZXJzaW9uIGNvbXBhcmF0b3IgaGFzIGFuIG9wZXJhdG9yIGFuZCBvdXIgdmVyc2lvbgogICAgLy8gaXMgbGVzcyB0aGFuIGl0IHRoZW4gaXQgaXNuJ3QgaGlnaGVyIHRoYW4gdGhlIHJhbmdlCiAgICBpZiAoKCFsb3cub3BlcmF0b3IgfHwgbG93Lm9wZXJhdG9yID09PSBjb21wKSAmJgogICAgICAgIGx0ZWZuKHZlcnNpb24sIGxvdy5zZW12ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSBpZiAobG93Lm9wZXJhdG9yID09PSBlY29tcCAmJiBsdGZuKHZlcnNpb24sIGxvdy5zZW12ZXIpKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIFVzZSB0aGUgZGVmaW5lKCkgZnVuY3Rpb24gaWYgd2UncmUgaW4gQU1EIGxhbmQKaWYgKHR5cGVvZiBkZWZpbmUgPT09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkKICBkZWZpbmUoZXhwb3J0cyk7Cgp9KSgKICB0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgPyBleHBvcnRzIDoKICB0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyB7fSA6CiAgc2VtdmVyID0ge30KKTsKCn0se31dLDEzMjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIHNpbXBsZS1leHRlbmQuanMgMC4xLjAKLy8gQSBzaW1wbGUgJ2V4dGVuZCcgaGVscGVyLCBhZGFwdGVkIGZyb20gdGhlIEJhY2tib25lLmpzIGxpYnJhcnkuCi8vIGh0dHA6Ly9naXRodWIuY29tL3Rncmllc3Nlci9zaW1wbGUtZXh0ZW5kCnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CgovLyBTaGFyZWQgZW1wdHkgY29uc3RydWN0b3IgZnVuY3Rpb24gdG8gYWlkIGluIHByb3RvdHlwZS1jaGFpbiBjcmVhdGlvbi4KdmFyIGN0b3IgPSBmdW5jdGlvbigpIHt9OwoKLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCi8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCi8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICB2YXIgcGFyZW50ID0gdGhpczsKICB2YXIgY2hpbGQ7CgogIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogIGlmIChwcm90b1Byb3BzICYmIHByb3RvUHJvcHMuaGFzT3duUHJvcGVydHkoJ2NvbnN0cnVjdG9yJykpIHsKICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICB9IGVsc2UgewogICAgY2hpbGQgPSBmdW5jdGlvbigpeyBwYXJlbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsgfTsKICB9CgogIC8vIEluaGVyaXQgY2xhc3MgKHN0YXRpYykgcHJvcGVydGllcyBmcm9tIHBhcmVudC4KICBfLmV4dGVuZChjaGlsZCwgcGFyZW50KTsKCiAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogIGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsKICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOwoKICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAvLyBpZiBzdXBwbGllZC4KICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgaWYgKHN0YXRpY1Byb3BzKSBfLmV4dGVuZChjaGlsZCwgc3RhdGljUHJvcHMpOwoKICAvLyBDb3JyZWN0bHkgc2V0IGNoaWxkJ3MgYHByb3RvdHlwZS5jb25zdHJ1Y3RvcmAuCiAgY2hpbGQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gY2hpbGQ7CgogIC8vIElmIHRoZXJlIGlzIGFuICJleHRlbmRlZCIgZnVuY3Rpb24gc2V0IG9uIHRoZSBwYXJlbnQsCiAgLy8gY2FsbCBpdCB3aXRoIHRoZSBleHRlbmRlZCBjaGlsZCBvYmplY3QuCiAgaWYgKHR5cGVvZiBwYXJlbnQuZXh0ZW5kZWQgPT09ICJmdW5jdGlvbiIpIHBhcmVudC5leHRlbmRlZChjaGlsZCk7CgogIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQgbGF0ZXIuCiAgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsKCiAgcmV0dXJuIGNoaWxkOwp9Owp9LHsibG9kYXNoIjoxMzB9XSwxMzM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyAgICAgdHJpZ2dlci10aGVuLmpzIDAuMy4wCi8vICAgICAoYykgMjAxMyBUaW0gR3JpZXNzZXIKLy8gICAgIHRyaWdnZXItdGhlbiBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCi8vIEV4cG9ydHMgdGhlIGZ1bmN0aW9uIHdoaWNoIG1peGVzIGB0cmlnZ2VyVGhlbmAKLy8gaW50byB0aGUgc3BlY2lmaWVkIGBCYWNrYm9uZWAgY29weSdzIGBFdmVudHNgIG9iamVjdCwKLy8gdXNpbmcgdGhlIHByb21pc2UtbGliJ3MgImFsbCIgaW1wbGVtZW50YXRpb24gcHJvdmlkZWQKLy8gaW4gdGhlIHNlY29uZCBhcmd1bWVudC4KKGZ1bmN0aW9uKHJvb3QsIG1peGluRm4pIHsKICBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IG1peGluRm47CiAgfSBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZSgndHJpZ2dlci10aGVuJywgW10sIGZ1bmN0aW9uKCkgeyByZXR1cm4gbWl4aW5GbjsgfSk7CiAgfSBlbHNlIHsKICAgIHJvb3RbJ3RyaWdnZXItdGhlbiddID0gbWl4aW5GbjsKICB9Cn0pKHRoaXMsIGZ1bmN0aW9uKEJhY2tib25lLCBQcm9taXNlTGliKSB7CgogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHM7CiAgdmFyIHB1c2ggICA9IEFycmF5LnByb3RvdHlwZS5wdXNoOwogIHZhciBzbGljZSAgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLiBSZXR1cm5zIGFuIGFycmF5IGNvbnRhaW5pbmcgYWxsIG9mIHRoZQogIC8vIGV2ZW50IHRyaWdnZXIgY2FsbHMsIGluIGNhc2UgYW55IHJldHVybiBkZWZlcnJlZHMuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHZhciBkZmRzID0gW107CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KSk7IHJldHVybiBkZmRzOwogICAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSBkZmRzLnB1c2goKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpKTsgcmV0dXJuIGRmZHM7CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpKTsgcmV0dXJuIGRmZHM7CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIGRmZHMucHVzaCgoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIsIGEzKSk7IHJldHVybiBkZmRzOwogICAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgZGZkcy5wdXNoKChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKSk7IHJldHVybiBkZmRzOwogICAgfQogIH07CgogIC8vIEZpcmVzIGV2ZW50cyBhcyBgdHJpZ2dlcmAgbm9ybWFsbHkgd291bGQsIGJ1dCBhc3N1bWVzIHRoYXQgc29tZSBvZiB0aGUgYHJldHVybmAKICAvLyB2YWx1ZXMgZnJvbSB0aGUgZXZlbnRzIG1heSBiZSBwcm9taXNlcywgYW5kIGFuZCByZXR1cm5zIGEgcHJvbWlzZSB3aGVuIGFsbCBvZiB0aGUKICAvLyBldmVudHMgYXJlIHJlc29sdmVkLgogIHZhciB0cmlnZ2VyVGhlbiA9IEV2ZW50cy50cmlnZ2VyVGhlbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gUHJvbWlzZUxpYi5hbGwoW10pOwogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICB2YXIgZGZkcyA9IFtdOwogICAgdmFyIGV2dHM7CiAgICBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgcHVzaC5jYWxsKGRmZHMsIHRyaWdnZXJUaGVuLmFwcGx5KHRoaXMsIFtuYW1lc1tpXV0uY29uY2F0KGFyZ3MpKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIFByb21pc2VMaWIuYWxsKGRmZHMpOwogICAgfSBlbHNlIHsKICAgICAgZXZ0cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgIH0KICAgIHZhciBhbGxFdmVudHMgPSB0aGlzLl9ldmVudHMuYWxsOwoKICAgIC8vIFdyYXAgaW4gYSB0cnkvY2F0Y2ggdG8gcmVqZWN0IHRoZSBwcm9taXNlIGlmIGFueSBlcnJvcnMgYXJlIHRocm93biB3aXRoaW4gdGhlIGhhbmRsZXJzLgogICAgdHJ5ICB7CiAgICAgIGlmIChldnRzKSBwdXNoLmFwcGx5KGRmZHMsIHRyaWdnZXJFdmVudHMoZXZ0cywgYXJncykpOwogICAgICBpZiAoYWxsRXZlbnRzKSBwdXNoLmFwcGx5KGRmZHMsIHRyaWdnZXJFdmVudHMoYWxsRXZlbnRzLCBhcmd1bWVudHMpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIFByb21pc2VMaWIucmVqZWN0KGUpOwogICAgfQogICAgcmV0dXJuIFByb21pc2VMaWIuYWxsKGRmZHMpOwogIH07CgogIC8vIE1peGluIGB0cmlnZ2VyVGhlbmAgdG8gdGhlIGFwcHJvcHJpYXRlIG9iamVjdHMgYW5kIHByb3RvdHlwZXMuCiAgQmFja2JvbmUudHJpZ2dlclRoZW4gPSB0cmlnZ2VyVGhlbjsKCiAgdmFyIG9ianMgPSBbJ01vZGVsJywgJ0NvbGxlY3Rpb24nLCAnUm91dGVyJywgJ1ZpZXcnLCAnSGlzdG9yeSddOwoKICBmb3IgKHZhciBpPTAsIGw9b2Jqcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBCYWNrYm9uZVtvYmpzW2ldXS5wcm90b3R5cGUudHJpZ2dlclRoZW4gPSB0cmlnZ2VyVGhlbjsKICB9Cn0pOwp9LHt9XX0se30sWzFdKSgxKQp9KTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:59:24 GMT",
                    "Content-Length": "976892",
                    "Date": "Thu, 06 Nov 2014 12:59:27 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}