{
    "url": "http://localhost:9999/x-tag/slidemenu/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI || document.URL);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/slidemenu/demo/x-tag-components.js",
                "path": "/x-tag/slidemenu/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy9zbGlkZW1lbnUvZGVtby94LXRhZy1jb21wb25lbnRzLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTU2NDkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDQ6NTQgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ0OjU0IEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwoKCgovLyBET01Ub2tlbkxpc3QgcG9seWZpbGwgZmlyIElFOQooZnVuY3Rpb24gKCkgewoKaWYgKHR5cGVvZiB3aW5kb3cuRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgfHwgImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSByZXR1cm47Cgp2YXIgcHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAogICAgaW5kZXhPZiA9IHByb3RvdHlwZS5pbmRleE9mLAogICAgc2xpY2UgPSBwcm90b3R5cGUuc2xpY2UsCiAgICBwdXNoID0gcHJvdG90eXBlLnB1c2gsCiAgICBzcGxpY2UgPSBwcm90b3R5cGUuc3BsaWNlLAogICAgam9pbiA9IHByb3RvdHlwZS5qb2luOwoKZnVuY3Rpb24gRE9NVG9rZW5MaXN0KGVsKSB7CiAgdGhpcy5fZWxlbWVudCA9IGVsOwogIGlmIChlbC5jbGFzc05hbWUgIT0gdGhpcy5fY2xhc3NDYWNoZSkgewogICAgdGhpcy5fY2xhc3NDYWNoZSA9IGVsLmNsYXNzTmFtZTsKCiAgICBpZiAoIXRoaXMuX2NsYXNzQ2FjaGUpIHJldHVybjsKCiAgICAgIC8vIFRoZSBjbGFzc05hbWUgbmVlZHMgdG8gYmUgdHJpbW1lZCBhbmQgc3BsaXQgb24gd2hpdGVzcGFjZQogICAgICAvLyB0byByZXRyaWV2ZSBhIGxpc3Qgb2YgY2xhc3Nlcy4KICAgICAgdmFyIGNsYXNzZXMgPSB0aGlzLl9jbGFzc0NhY2hlLnJlcGxhY2UoL15ccyt8XHMrJC9nLCcnKS5zcGxpdCgvXHMrLyksCiAgICAgICAgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHB1c2guY2FsbCh0aGlzLCBjbGFzc2VzW2ldKTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRUb0NsYXNzTmFtZShlbCwgY2xhc3NlcykgewogIGVsLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwp9CgpET01Ub2tlbkxpc3QucHJvdG90eXBlID0gewogIGFkZDogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmKHRoaXMuY29udGFpbnModG9rZW4pKSByZXR1cm47CiAgICBwdXNoLmNhbGwodGhpcywgdG9rZW4pOwogICAgc2V0VG9DbGFzc05hbWUodGhpcy5fZWxlbWVudCwgc2xpY2UuY2FsbCh0aGlzLCAwKSk7CiAgfSwKICBjb250YWluczogZnVuY3Rpb24odG9rZW4pIHsKICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pICE9PSAtMTsKICB9LAogIGl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpc1tpbmRleF0gfHwgbnVsbDsKICB9LAogIHJlbW92ZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIHZhciBpID0gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKTsKICAgICBpZiAoaSA9PT0gLTEpIHsKICAgICAgIHJldHVybjsKICAgICB9CiAgICBzcGxpY2UuY2FsbCh0aGlzLCBpLCAxKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGpvaW4uY2FsbCh0aGlzLCAnICcpOwogIH0sCiAgdG9nZ2xlOiBmdW5jdGlvbih0b2tlbikgewogICAgaWYgKGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbikgPT09IC0xKSB7CiAgICAgIHRoaXMuYWRkKHRva2VuKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlKHRva2VuKTsKICAgIH0KICB9Cn07Cgp3aW5kb3cuRE9NVG9rZW5MaXN0ID0gRE9NVG9rZW5MaXN0OwoKZnVuY3Rpb24gZGVmaW5lRWxlbWVudEdldHRlciAob2JqLCBwcm9wLCBnZXR0ZXIpIHsKICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBwcm9wLHsKICAgICAgZ2V0IDogZ2V0dGVyCiAgICB9KQogIH0gZWxzZSB7CiAgICBvYmouX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCBnZXR0ZXIpOwogIH0KfQoKZGVmaW5lRWxlbWVudEdldHRlcihFbGVtZW50LnByb3RvdHlwZSwgJ2NsYXNzTGlzdCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IERPTVRva2VuTGlzdCh0aGlzKTsKfSk7Cgp9KSgpOwoKCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgppZiAodHlwZW9mIFdlYWtNYXAgPT09ICd1bmRlZmluZWQnKSB7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIGNvdW50ZXIgPSBEYXRlLm5vdygpICUgMWU5OwoKICAgIHZhciBXZWFrTWFwID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgV2Vha01hcC5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBlbnRyeSA9IGtleVt0aGlzLm5hbWVdOwogICAgICAgIGlmIChlbnRyeSAmJiBlbnRyeVswXSA9PT0ga2V5KQogICAgICAgICAgZW50cnlbMV0gPSB2YWx1ZTsKICAgICAgICBlbHNlCiAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShrZXksIHRoaXMubmFtZSwge3ZhbHVlOiBba2V5LCB2YWx1ZV0sIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdmFyIGVudHJ5OwogICAgICAgIHJldHVybiAoZW50cnkgPSBrZXlbdGhpcy5uYW1lXSkgJiYgZW50cnlbMF0gPT09IGtleSA/CiAgICAgICAgICAgIGVudHJ5WzFdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfTsKCiAgICB3aW5kb3cuV2Vha01hcCA9IFdlYWtNYXA7CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovLyBTaWRlVGFibGUgaXMgYSB3ZWFrIG1hcCB3aGVyZSBwb3NzaWJsZS4gSWYgV2Vha01hcCBpcyBub3QgYXZhaWxhYmxlIHRoZQovLyBhc3NvY2lhdGlvbiBpcyBzdG9yZWQgYXMgYW4gZXhwYW5kbyBwcm9wZXJ0eS4KdmFyIFNpZGVUYWJsZTsKLy8gVE9ETyhhcnYpOiBXZWFrTWFwIGRvZXMgbm90IGFsbG93IGZvciBOb2RlIGV0YyB0byBiZSBrZXlzIGluIEZpcmVmb3gKaWYgKHR5cGVvZiBXZWFrTWFwICE9PSAndW5kZWZpbmVkJyAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0ZpcmVmb3gvJykgPCAwKSB7CiAgU2lkZVRhYmxlID0gV2Vha01hcDsKfSBlbHNlIHsKICAoZnVuY3Rpb24oKSB7CiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSBPYmplY3QuZGVmaW5lUHJvcGVydHk7CiAgICB2YXIgY291bnRlciA9IERhdGUubm93KCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgdmFyIGVudHJ5ID0ga2V5W3RoaXMubmFtZV07CiAgICAgICAgaWYgKGVudHJ5ICYmIGVudHJ5WzBdID09PSBrZXkpCiAgICAgICAgICBlbnRyeVsxXSA9IHZhbHVlOwogICAgICAgIGVsc2UKICAgICAgICAgIGRlZmluZVByb3BlcnR5KGtleSwgdGhpcy5uYW1lLCB7dmFsdWU6IFtrZXksIHZhbHVlXSwgd3JpdGFibGU6IHRydWV9KTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB2YXIgZW50cnk7CiAgICAgICAgcmV0dXJuIChlbnRyeSA9IGtleVt0aGlzLm5hbWVdKSAmJiBlbnRyeVswXSA9PT0ga2V5ID8KICAgICAgICAgICAgZW50cnlbMV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oZ2xvYmFsKSB7CgogIHZhciByZWdpc3RyYXRpb25zVGFibGUgPSBuZXcgU2lkZVRhYmxlKCk7CgogIC8vIFdlIHVzZSBzZXRJbW1lZGlhdGUgb3IgcG9zdE1lc3NhZ2UgZm9yIG91ciBmdXR1cmUgY2FsbGJhY2suCiAgdmFyIHNldEltbWVkaWF0ZSA9IHdpbmRvdy5tc1NldEltbWVkaWF0ZTsKCiAgLy8gVXNlIHBvc3QgbWVzc2FnZSB0byBlbXVsYXRlIHNldEltbWVkaWF0ZS4KICBpZiAoIXNldEltbWVkaWF0ZSkgewogICAgdmFyIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICB2YXIgc2VudGluZWwgPSBTdHJpbmcoTWF0aC5yYW5kb20oKSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKGUuZGF0YSA9PT0gc2VudGluZWwpIHsKICAgICAgICB2YXIgcXVldWUgPSBzZXRJbW1lZGlhdGVRdWV1ZTsKICAgICAgICBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgZnVuYygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgc2V0SW1tZWRpYXRlUXVldWUucHVzaChmdW5jKTsKICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHNlbnRpbmVsLCAnKicpOwogICAgfTsKICB9CgogIC8vIFRoaXMgaXMgdXNlZCB0byBlbnN1cmUgdGhhdCB3ZSBuZXZlciBzY2hlZHVsZSAyIGNhbGxhcyB0byBzZXRJbW1lZGlhdGUKICB2YXIgaXNTY2hlZHVsZWQgPSBmYWxzZTsKCiAgLy8gS2VlcCB0cmFjayBvZiBvYnNlcnZlcnMgdGhhdCBuZWVkcyB0byBiZSBub3RpZmllZCBuZXh0IHRpbWUuCiAgdmFyIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwoKICAvKioKICAgKiBTY2hlZHVsZXMgfGRpc3BhdGNoQ2FsbGJhY2t8IHRvIGJlIGNhbGxlZCBpbiB0aGUgZnV0dXJlLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKi8KICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrKG9ic2VydmVyKSB7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMucHVzaChvYnNlcnZlcik7CiAgICBpZiAoIWlzU2NoZWR1bGVkKSB7CiAgICAgIGlzU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgc2V0SW1tZWRpYXRlKGRpc3BhdGNoQ2FsbGJhY2tzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHdyYXBJZk5lZWRlZChub2RlKSB7CiAgICByZXR1cm4gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsICYmCiAgICAgICAgd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsLndyYXBJZk5lZWRlZChub2RlKSB8fAogICAgICAgIG5vZGU7CiAgfQoKICBmdW5jdGlvbiBkaXNwYXRjaENhbGxiYWNrcygpIHsKICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbi1vYnNlcnZlcnMKCiAgICBpc1NjaGVkdWxlZCA9IGZhbHNlOyAvLyBVc2VkIHRvIGFsbG93IGEgbmV3IHNldEltbWVkaWF0ZSBjYWxsIGFib3ZlLgoKICAgIHZhciBvYnNlcnZlcnMgPSBzY2hlZHVsZWRPYnNlcnZlcnM7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKICAgIC8vIFNvcnQgb2JzZXJ2ZXJzIGJhc2VkIG9uIHRoZWlyIGNyZWF0aW9uIFVJRCAoaW5jcmVtZW50YWwpLgogICAgb2JzZXJ2ZXJzLnNvcnQoZnVuY3Rpb24obzEsIG8yKSB7CiAgICAgIHJldHVybiBvMS51aWRfIC0gbzIudWlkXzsKICAgIH0pOwoKICAgIHZhciBhbnlOb25FbXB0eSA9IGZhbHNlOwogICAgb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24ob2JzZXJ2ZXIpIHsKCiAgICAgIC8vIDIuMSwgMi4yCiAgICAgIHZhciBxdWV1ZSA9IG9ic2VydmVyLnRha2VSZWNvcmRzKCk7CiAgICAgIC8vIDIuMy4gUmVtb3ZlIGFsbCB0cmFuc2llbnQgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgd2hvc2Ugb2JzZXJ2ZXIgaXMgbW8uCiAgICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcik7CgogICAgICAvLyAyLjQKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgIG9ic2VydmVyLmNhbGxiYWNrXyhxdWV1ZSwgb2JzZXJ2ZXIpOwogICAgICAgIGFueU5vbkVtcHR5ID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgLy8gMy4KICAgIGlmIChhbnlOb25FbXB0eSkKICAgICAgZGlzcGF0Y2hDYWxsYmFja3MoKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcikgewogICAgb2JzZXJ2ZXIubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZXR1cm47CiAgICAgIHJlZ2lzdHJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWdpc3RyYXRpb24pIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSBvYnNlcnZlcikKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVUcmFuc2llbnRPYnNlcnZlcnMoKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgdGhlICJGb3IgZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoCiAgICogb2JzZXJ2ZXIncyBvcHRpb25zIGFzIG9wdGlvbnMpIGluIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsCiAgICogcnVuIHRoZXNlIHN1YnN0ZXBzOiIgYW5kIHRoZSAiRm9yIGVhY2ggYW5jZXN0b3IgYW5jZXN0b3Igb2YgdGFyZ2V0LCBhbmQgZm9yCiAgICogZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoIG9wdGlvbnMgb3B0aW9ucykgaW4gYW5jZXN0b3IncyBsaXN0CiAgICogb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsIHJ1biB0aGVzZSBzdWJzdGVwczoiIHBhcnQgb2YgdGhlIGFsZ29yaXRobXMuIFRoZQogICAqIHxvcHRpb25zLnN1YnRyZWV8IGlzIGNoZWNrZWQgdG8gZW5zdXJlIHRoYXQgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAqIGNvcnJlY3RseS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtmdW5jdGlvbihNdXRhdGlvbk9ic2VydmVySW5pdCk6TXV0YXRpb25SZWNvcmR9IGNhbGxiYWNrCiAgICovCiAgZnVuY3Rpb24gZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIG5vZGUgPSB0YXJnZXQ7IG5vZGU7IG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwoKICAgICAgaWYgKHJlZ2lzdHJhdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2pdOwogICAgICAgICAgdmFyIG9wdGlvbnMgPSByZWdpc3RyYXRpb24ub3B0aW9uczsKCiAgICAgICAgICAvLyBPbmx5IHRhcmdldCBpZ25vcmVzIHN1YnRyZWUuCiAgICAgICAgICBpZiAobm9kZSAhPT0gdGFyZ2V0ICYmICFvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIHZhciByZWNvcmQgPSBjYWxsYmFjayhvcHRpb25zKTsKICAgICAgICAgIGlmIChyZWNvcmQpCiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5lbnF1ZXVlKHJlY29yZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgdWlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIFRoZSBjbGFzcyB0aGF0IG1hcHMgdG8gdGhlIERPTSBNdXRhdGlvbk9ic2VydmVyIGludGVyZmFjZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjay4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBKc011dGF0aW9uT2JzZXJ2ZXIoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGJhY2tfID0gY2FsbGJhY2s7CiAgICB0aGlzLm5vZGVzXyA9IFtdOwogICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgdGhpcy51aWRfID0gKyt1aWRDb3VudGVyOwogIH0KCiAgSnNNdXRhdGlvbk9ic2VydmVyLnByb3RvdHlwZSA9IHsKICAgIG9ic2VydmU6IGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucykgewogICAgICB0YXJnZXQgPSB3cmFwSWZOZWVkZWQodGFyZ2V0KTsKCiAgICAgIC8vIDEuMQogICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0ICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSB8fAoKICAgICAgICAgIC8vIDEuMgogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS4zCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS40CiAgICAgICAgICBvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKSB7CgogICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigpOwogICAgICB9CgogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQodGFyZ2V0KTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQodGFyZ2V0LCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gMgogICAgICAvLyBJZiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIGFscmVhZHkgaW5jbHVkZXMgYSByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgY29udGV4dCBvYmplY3QsIHJlcGxhY2UgdGhhdCByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyJ3Mgb3B0aW9ucyB3aXRoIG9wdGlvbnMuCiAgICAgIHZhciByZWdpc3RyYXRpb247CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgcmVnaXN0cmF0aW9uLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyAzLgogICAgICAvLyBPdGhlcndpc2UsIGFkZCBhIG5ldyByZWdpc3RlcmVkIG9ic2VydmVyIHRvIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcnMgd2l0aCB0aGUgY29udGV4dCBvYmplY3QgYXMgdGhlIG9ic2VydmVyIGFuZCBvcHRpb25zIGFzIHRoZQogICAgICAvLyBvcHRpb25zLCBhbmQgYWRkIHRhcmdldCB0byBjb250ZXh0IG9iamVjdCdzIGxpc3Qgb2Ygbm9kZXMgb24gd2hpY2ggaXQKICAgICAgLy8gaXMgcmVnaXN0ZXJlZC4KICAgICAgaWYgKCFyZWdpc3RyYXRpb24pIHsKICAgICAgICByZWdpc3RyYXRpb24gPSBuZXcgUmVnaXN0cmF0aW9uKHRoaXMsIHRhcmdldCwgb3B0aW9ucyk7CiAgICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHJlZ2lzdHJhdGlvbik7CiAgICAgICAgdGhpcy5ub2Rlc18ucHVzaCh0YXJnZXQpOwogICAgICB9CgogICAgICByZWdpc3RyYXRpb24uYWRkTGlzdGVuZXJzKCk7CiAgICB9LAoKICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIH0sCgogICAgdGFrZVJlY29yZHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29weU9mUmVjb3JkcyA9IHRoaXMucmVjb3Jkc187CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgICAgcmV0dXJuIGNvcHlPZlJlY29yZHM7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5hZGRlZE5vZGVzID0gW107CiAgICB0aGlzLnJlbW92ZWROb2RlcyA9IFtdOwogICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBudWxsOwogICAgdGhpcy5vbGRWYWx1ZSA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiBjb3B5TXV0YXRpb25SZWNvcmQob3JpZ2luYWwpIHsKICAgIHZhciByZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQob3JpZ2luYWwudHlwZSwgb3JpZ2luYWwudGFyZ2V0KTsKICAgIHJlY29yZC5hZGRlZE5vZGVzID0gb3JpZ2luYWwuYWRkZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IG9yaWdpbmFsLnJlbW92ZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IG9yaWdpbmFsLnByZXZpb3VzU2libGluZzsKICAgIHJlY29yZC5uZXh0U2libGluZyA9IG9yaWdpbmFsLm5leHRTaWJsaW5nOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgIHJlY29yZC5vbGRWYWx1ZSA9IG9yaWdpbmFsLm9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZDsKICB9OwoKICAvLyBXZSBrZWVwIHRyYWNrIG9mIHRoZSB0d28gKHBvc3NpYmx5IG9uZSkgcmVjb3JkcyB1c2VkIGluIGEgc2luZ2xlIG11dGF0aW9uLgogIHZhciBjdXJyZW50UmVjb3JkLCByZWNvcmRXaXRoT2xkVmFsdWU7CgogIC8qKgogICAqIENyZWF0ZXMgYSByZWNvcmQgd2l0aG91dCB8b2xkVmFsdWV8IGFuZCBjYWNoZXMgaXQgYXMgfGN1cnJlbnRSZWNvcmR8IGZvcgogICAqIGxhdGVyIHVzZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICByZXR1cm4gY3VycmVudFJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpOwogIH0KCiAgLyoqCiAgICogR2V0cyBvciBjcmVhdGVzIGEgcmVjb3JkIHdpdGggfG9sZFZhbHVlfCBiYXNlZCBpbiB0aGUgfGN1cnJlbnRSZWNvcmR8CiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKSB7CiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlID0gY29weU11dGF0aW9uUmVjb3JkKGN1cnJlbnRSZWNvcmQpOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogIH0KCiAgZnVuY3Rpb24gY2xlYXJSZWNvcmRzKCkgewogICAgY3VycmVudFJlY29yZCA9IHJlY29yZFdpdGhPbGRWYWx1ZSA9IHVuZGVmaW5lZDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IHJlY29yZAogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlY29yZCByZXByZXNlbnRzIGEgcmVjb3JkIGZyb20gdGhlIGN1cnJlbnQKICAgKiBtdXRhdGlvbiBldmVudC4KICAgKi8KICBmdW5jdGlvbiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIHJlY29yZCA9PT0gcmVjb3JkV2l0aE9sZFZhbHVlIHx8IHJlY29yZCA9PT0gY3VycmVudFJlY29yZDsKICB9CgogIC8qKgogICAqIFNlbGVjdHMgd2hpY2ggcmVjb3JkLCBpZiBhbnksIHRvIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIGluIHRoZSBxdWV1ZS4KICAgKiBUaGlzIHJldHVybnMgfG51bGx8IGlmIG5vIHJlY29yZCBzaG91bGQgYmUgcmVwbGFjZWQuCiAgICoKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBsYXN0UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbmV3UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgbmV3UmVjb3JkKSB7CiAgICBpZiAobGFzdFJlY29yZCA9PT0gbmV3UmVjb3JkKQogICAgICByZXR1cm4gbGFzdFJlY29yZDsKCiAgICAvLyBDaGVjayBpZiB0aGUgdGhlIHJlY29yZCB3ZSBhcmUgYWRkaW5nIHJlcHJlc2VudHMgdGhlIHNhbWUgcmVjb3JkLiBJZgogICAgLy8gc28sIHdlIGtlZXAgdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZSBpbiBpdC4KICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUgJiYgcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihsYXN0UmVjb3JkKSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAqIENsYXNzIHVzZWQgdG8gcmVwcmVzZW50IGEgcmVnaXN0ZXJlZCBvYnNlcnZlci4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJJbml0fSBvcHRpb25zCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gUmVnaXN0cmF0aW9uKG9ic2VydmVyLCB0YXJnZXQsIG9wdGlvbnMpIHsKICAgIHRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZlcjsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwogIH0KCiAgUmVnaXN0cmF0aW9uLnByb3RvdHlwZSA9IHsKICAgIGVucXVldWU6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMub2JzZXJ2ZXIucmVjb3Jkc187CiAgICAgIHZhciBsZW5ndGggPSByZWNvcmRzLmxlbmd0aDsKCiAgICAgIC8vIFRoZXJlIGFyZSBjYXNlcyB3aGVyZSB3ZSByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCB3aXRoIHRoZSBuZXcgcmVjb3JkLgogICAgICAvLyBGb3IgZXhhbXBsZSBpZiB0aGUgcmVjb3JkIHJlcHJlc2VudHMgdGhlIHNhbWUgbXV0YXRpb24gd2UgbmVlZCB0byB1c2UKICAgICAgLy8gdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZS4gSWYgd2UgZ2V0IHNhbWUgcmVjb3JkICh0aGlzIGNhbiBoYXBwZW4gYXMgd2UKICAgICAgLy8gd2FsayB1cCB0aGUgdHJlZSkgd2UgaWdub3JlIHRoZSBuZXcgcmVjb3JkLgogICAgICBpZiAocmVjb3Jkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxhc3RSZWNvcmQgPSByZWNvcmRzW2xlbmd0aCAtIDFdOwogICAgICAgIHZhciByZWNvcmRUb1JlcGxhY2VMYXN0ID0gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIHJlY29yZCk7CiAgICAgICAgaWYgKHJlY29yZFRvUmVwbGFjZUxhc3QpIHsKICAgICAgICAgIHJlY29yZHNbbGVuZ3RoIC0gMV0gPSByZWNvcmRUb1JlcGxhY2VMYXN0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKHRoaXMub2JzZXJ2ZXIpOwogICAgICB9CgogICAgICByZWNvcmRzW2xlbmd0aF0gPSByZWNvcmQ7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQWRkcyBhIHRyYW5zaWVudCBvYnNlcnZlciBvbiBub2RlLiBUaGUgdHJhbnNpZW50IG9ic2VydmVyIGdldHMgcmVtb3ZlZAogICAgICogbmV4dCB0aW1lIHdlIGRlbGl2ZXIgdGhlIGNoYW5nZSByZWNvcmRzLgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKi8KICAgIGFkZFRyYW5zaWVudE9ic2VydmVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIC8vIERvbid0IGFkZCB0cmFuc2llbnQgb2JzZXJ2ZXJzIG9uIHRoZSB0YXJnZXQgaXRzZWxmLiBXZSBhbHJlYWR5IGhhdmUgYWxsCiAgICAgIC8vIHRoZSByZXF1aXJlZCBsaXN0ZW5lcnMgc2V0IHVwIG9uIHRoZSB0YXJnZXQuCiAgICAgIGlmIChub2RlID09PSB0aGlzLnRhcmdldCkKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLmFkZExpc3RlbmVyc18obm9kZSk7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KG5vZGUsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyBXZSBrbm93IHRoYXQgcmVnaXN0cmF0aW9ucyBkb2VzIG5vdCBjb250YWluIHRoaXMgYmVjYXVzZSB3ZSBhbHJlYWR5CiAgICAgIC8vIGNoZWNrZWQgaWYgbm9kZSA9PT0gdGhpcy50YXJnZXQuCiAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaCh0aGlzKTsKICAgIH0sCgogICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXM7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwoKICAgICAgdHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBUcmFuc2llbnQgb2JzZXJ2ZXJzIGFyZSBuZXZlciBhZGRlZCB0byB0aGUgdGFyZ2V0LgogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyhub2RlKTsKCiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0gPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgICAvLyBTdG9wIHByb3BhZ2F0aW9uIHNpbmNlIHdlIGFyZSBtYW5hZ2luZyB0aGUgcHJvcGFnYXRpb24gbWFudWFsbHkuCiAgICAgIC8vIFRoaXMgbWVhbnMgdGhhdCBvdGhlciBtdXRhdGlvbiBldmVudHMgb24gdGhlIHBhZ2Ugd2lsbCBub3Qgd29yawogICAgICAvLyBjb3JyZWN0bHkgYnV0IHRoYXQgaXMgYnkgZGVzaWduLgogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICdET01BdHRyTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtYXR0cmlidXRlcwoKICAgICAgICAgIHZhciBuYW1lID0gZS5hdHRyTmFtZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBlLnJlbGF0ZWROb2RlLm5hbWVzcGFjZVVSSTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyBnZXRSZWNvcmQoJ2F0dHJpYnV0ZXMnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0KICAgICAgICAgICAgICBlLmF0dHJDaGFuZ2UgPT09IE11dGF0aW9uRXZlbnQuQURESVRJT04gPyBudWxsIDogZS5wcmV2VmFsdWU7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWUpID09PSAtMSAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lc3BhY2UpID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuNCwgNC41CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoYXJhY3RlcmRhdGEKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hhcmFjdGVyRGF0YScsIHRhcmdldCk7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IGUucHJldlZhbHVlOwoKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NTm9kZVJlbW92ZWQnOgogICAgICAgICAgdGhpcy5hZGRUcmFuc2llbnRPYnNlcnZlcihlLnRhcmdldCk7CiAgICAgICAgICAvLyBGYWxsIHRocm91Z2guCiAgICAgICAgY2FzZSAnRE9NTm9kZUluc2VydGVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoaWxkbGlzdAogICAgICAgICAgdmFyIHRhcmdldCA9IGUucmVsYXRlZE5vZGU7CiAgICAgICAgICB2YXIgY2hhbmdlZE5vZGUgPSBlLnRhcmdldDsKICAgICAgICAgIHZhciBhZGRlZE5vZGVzLCByZW1vdmVkTm9kZXM7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAnRE9NTm9kZUluc2VydGVkJykgewogICAgICAgICAgICBhZGRlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW107CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzU2libGluZyA9IGNoYW5nZWROb2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGNoYW5nZWROb2RlLm5leHRTaWJsaW5nOwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGlsZExpc3QnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBhZGRlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IHJlbW92ZWROb2RlczsKICAgICAgICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDIuMSwgMy4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4yLCAzLjMKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgfQoKICAgICAgY2xlYXJSZWNvcmRzKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsLkpzTXV0YXRpb25PYnNlcnZlciA9IEpzTXV0YXRpb25PYnNlcnZlcjsKCn0pKHRoaXMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9IAogICAgICB3aW5kb3cuV2ViS2l0TXV0YXRpb25PYnNlcnZlciB8fCAKICAgICAgd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcjsKICBpZiAoIU11dGF0aW9uT2JzZXJ2ZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigibm8gbXV0YXRpb24gb2JzZXJ2ZXIgc3VwcG9ydCIpOwogIH0KfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8qKgogKiBJbXBsZW1lbnRzIGBkb2N1bWVudC5yZWdpc3RlcmAKICogQG1vZHVsZSBDdXN0b21FbGVtZW50cwoqLwoKLyoqCiAqIFBvbHlmaWxsZWQgZXh0ZW5zaW9ucyB0byB0aGUgYGRvY3VtZW50YCBvYmplY3QuCiAqIEBjbGFzcyBEb2N1bWVudAoqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgovLyBpbXBvcnRzCgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuQ3VzdG9tRWxlbWVudHMgPSB7ZmxhZ3M6e319Owp9CnZhciBmbGFncyA9IHNjb3BlLmZsYWdzOwoKLy8gbmF0aXZlIGRvY3VtZW50LnJlZ2lzdGVyPwoKdmFyIGhhc05hdGl2ZSA9IEJvb2xlYW4oZG9jdW1lbnQucmVnaXN0ZXIpOwp2YXIgdXNlTmF0aXZlID0gIWZsYWdzLnJlZ2lzdGVyICYmIGhhc05hdGl2ZTsKCmlmICh1c2VOYXRpdmUpIHsKCiAgLy8gc3R1YgogIHZhciBub3AgPSBmdW5jdGlvbigpIHt9OwoKICAvLyBleHBvcnRzCiAgc2NvcGUucmVnaXN0cnkgPSB7fTsKICBzY29wZS51cGdyYWRlRWxlbWVudCA9IG5vcDsKICAKICBzY29wZS53YXRjaFNoYWRvdyA9IG5vcDsKICBzY29wZS51cGdyYWRlID0gbm9wOwogIHNjb3BlLnVwZ3JhZGVBbGwgPSBub3A7CiAgc2NvcGUudXBncmFkZVN1YnRyZWUgPSBub3A7CiAgc2NvcGUub2JzZXJ2ZURvY3VtZW50ID0gbm9wOwogIHNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IG5vcDsKICBzY29wZS50YWtlUmVjb3JkcyA9IG5vcDsKCn0gZWxzZSB7CgogIC8qKgogICAqIFJlZ2lzdGVycyBhIGN1c3RvbSB0YWcgbmFtZSB3aXRoIHRoZSBkb2N1bWVudC4KICAgKgogICAqIFdoZW4gYSByZWdpc3RlcmVkIGVsZW1lbnQgaXMgY3JlYXRlZCwgYSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGlzIGNhbGxlZAogICAqIGluIHRoZSBzY29wZSBvZiB0aGUgZWxlbWVudC4gVGhlIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgY2FuIGJlIHNwZWNpZmllZCBvbgogICAqIGVpdGhlciBgb3B0aW9ucy5wcm90b3R5cGVgIG9yIGBvcHRpb25zLmxpZmVjeWNsZWAgd2l0aCB0aGUgbGF0dGVyIHRha2luZwogICAqIHByZWNlZGVuY2UuCiAgICoKICAgKiBAbWV0aG9kIHJlZ2lzdGVyCiAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIHRhZyBuYW1lIHRvIHJlZ2lzdGVyLiBNdXN0IGluY2x1ZGUgYSBkYXNoICgnLScpLAogICAqICAgIGZvciBleGFtcGxlICd4LWNvbXBvbmVudCcuCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiAgICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuZXh0ZW5kc10KICAgKiAgICAgIChfb2ZmIHNwZWNfKSBUYWcgbmFtZSBvZiBhbiBlbGVtZW50IHRvIGV4dGVuZCAob3IgYmxhbmsgZm9yIGEgbmV3CiAgICogICAgICBlbGVtZW50KS4gVGhpcyBwYXJhbWV0ZXIgaXMgbm90IHBhcnQgb2YgdGhlIHNwZWNpZmljYXRpb24sIGJ1dCBpbnN0ZWFkCiAgICogICAgICBpcyBhIGhpbnQgZm9yIHRoZSBwb2x5ZmlsbCBiZWNhdXNlIHRoZSBleHRlbmRlZSBpcyBkaWZmaWN1bHQgdG8gaW5mZXIuCiAgICogICAgICBSZW1lbWJlciB0aGF0IHRoZSBpbnB1dCBwcm90b3R5cGUgbXVzdCBjaGFpbiB0byB0aGUgZXh0ZW5kZWQgZWxlbWVudCdzCiAgICogICAgICBwcm90b3R5cGUgKG9yIEhUTUxFbGVtZW50LnByb3RvdHlwZSkgcmVnYXJkbGVzcyBvZiB0aGUgdmFsdWUgb2YKICAgKiAgICAgIGBleHRlbmRzYC4KICAgKiAgICBAcGFyYW0ge09iamVjdH0gb3B0aW9ucy5wcm90b3R5cGUgVGhlIHByb3RvdHlwZSB0byB1c2UgZm9yIHRoZSBuZXcKICAgKiAgICAgIGVsZW1lbnQuIFRoZSBwcm90b3R5cGUgbXVzdCBpbmhlcml0IGZyb20gSFRNTEVsZW1lbnQuCiAgICogICAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zLmxpZmVjeWNsZV0KICAgKiAgICAgIENhbGxiYWNrcyB0aGF0IGZpcmUgYXQgaW1wb3J0YW50IHBoYXNlcyBpbiB0aGUgbGlmZSBvZiB0aGUgY3VzdG9tCiAgICogICAgICBlbGVtZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgKiAgICAgIEZhbmN5QnV0dG9uID0gZG9jdW1lbnQucmVnaXN0ZXIoImZhbmN5LWJ1dHRvbiIsIHsKICAgKiAgICAgICAgZXh0ZW5kczogJ2J1dHRvbicsCiAgICogICAgICAgIHByb3RvdHlwZTogT2JqZWN0LmNyZWF0ZShIVE1MQnV0dG9uRWxlbWVudC5wcm90b3R5cGUsIHsKICAgKiAgICAgICAgICByZWFkeUNhbGxiYWNrOiB7CiAgICogICAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJhIGZhbmN5LWJ1dHRvbiB3YXMgY3JlYXRlZCIsCiAgICogICAgICAgICAgICB9CiAgICogICAgICAgICAgfQogICAqICAgICAgICB9KQogICAqICAgICAgfSk7CiAgICogQHJldHVybiB7RnVuY3Rpb259IENvbnN0cnVjdG9yIGZvciB0aGUgbmV3bHkgcmVnaXN0ZXJlZCB0eXBlLgogICAqLwogIGZ1bmN0aW9uIHJlZ2lzdGVyKG5hbWUsIG9wdGlvbnMpIHsKICAgIC8vY29uc29sZS53YXJuKCdkb2N1bWVudC5yZWdpc3RlcigiJyArIG5hbWUgKyAnIiwgJywgb3B0aW9ucywgJyknKTsKICAgIC8vIGNvbnN0cnVjdCBhIGRlZmludGlvbiBvdXQgb2Ygb3B0aW9ucwogICAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIGNsb25lIG9wdGlvbnMgaW5zdGVhZCBvZiBtdXRhdGluZyBpdAogICAgdmFyIGRlZmluaXRpb24gPSBvcHRpb25zIHx8IHt9OwogICAgaWYgKCFuYW1lKSB7CiAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmljQiBjYW4gcHJvYmFibHkKICAgICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICAgIHRocm93IG5ldyBFcnJvcignZG9jdW1lbnQucmVnaXN0ZXI6IGZpcnN0IGFyZ3VtZW50IGBuYW1lYCBtdXN0IG5vdCBiZSBlbXB0eScpOwogICAgfQogICAgaWYgKG5hbWUuaW5kZXhPZignLScpIDwgMCkgewogICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpY0IgY2FuIHByb2JhYmx5CiAgICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RvY3VtZW50LnJlZ2lzdGVyOiBmaXJzdCBhcmd1bWVudCAoXCduYW1lXCcpIG11c3QgY29udGFpbiBhIGRhc2ggKFwnLVwnKS4gQXJndW1lbnQgcHJvdmlkZWQgd2FzIFwnJyArIFN0cmluZyhuYW1lKSArICdcJy4nKTsKICAgIH0KICAgIC8vIHJlY29yZCBuYW1lCiAgICBkZWZpbml0aW9uLm5hbWUgPSBuYW1lOwogICAgLy8gbXVzdCBoYXZlIGEgcHJvdG90eXBlLCBkZWZhdWx0IHRvIGFuIGV4dGVuc2lvbiBvZiBIVE1MRWxlbWVudAogICAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIHRocm93IGlmIG5vIHByb3RvdHlwZSwgY2hlY2sgc3BlYwogICAgaWYgKCFkZWZpbml0aW9uLnByb3RvdHlwZSkgewogICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpY0IgY2FuIHByb2JhYmx5CiAgICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbnMgbWlzc2luZyByZXF1aXJlZCBwcm90b3R5cGUgcHJvcGVydHknKTsKICAgIH0KICAgIC8vIGVuc3VyZSBhIGxpZmVjeWNsZSBvYmplY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBudWxsIHRlc3QgaXQKICAgIGRlZmluaXRpb24ubGlmZWN5Y2xlID0gZGVmaW5pdGlvbi5saWZlY3ljbGUgfHwge307CiAgICAvLyBidWlsZCBhIGxpc3Qgb2YgYW5jZXN0cmFsIGN1c3RvbSBlbGVtZW50cyAoZm9yIG5hdGl2ZSBiYXNlIGRldGVjdGlvbikKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHdlIHVzZWQgdG8gbmVlZCB0byBzdG9yZSB0aGlzLCBidXQgY3VycmVudCBjb2RlIG9ubHkKICAgIC8vIHVzZXMgaXQgaW4gJ3Jlc29sdmVUYWdOYW1lJzogaXQgc2hvdWxkIHByb2JhYmx5IGJlIGlubGluZWQKICAgIGRlZmluaXRpb24uYW5jZXN0cnkgPSBhbmNlc3RyeShkZWZpbml0aW9uLmV4dGVuZHMpOwogICAgLy8gZXh0ZW5zaW9ucyBvZiBuYXRpdmUgc3BlY2lhbGl6YXRpb25zIG9mIEhUTUxFbGVtZW50IHJlcXVpcmUgbG9jYWxOYW1lCiAgICAvLyB0byByZW1haW4gbmF0aXZlLCBhbmQgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllciBmb3IgZXh0ZW5zaW9uIHR5cGUKICAgIHJlc29sdmVUYWdOYW1lKGRlZmluaXRpb24pOwogICAgLy8gc29tZSBwbGF0Zm9ybXMgcmVxdWlyZSBtb2RpZmljYXRpb25zIHRvIHRoZSB1c2VyLXN1cHBsaWVkIHByb3RvdHlwZQogICAgLy8gY2hhaW4KICAgIHJlc29sdmVQcm90b3R5cGVDaGFpbihkZWZpbml0aW9uKTsKICAgIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgYXR0cmlidXRlQ2hhbmdlZCBjYWxsYmFjawogICAgb3ZlcnJpZGVBdHRyaWJ1dGVBcGkoZGVmaW5pdGlvbi5wcm90b3R5cGUpOwogICAgLy8gNy4xLjU6IFJlZ2lzdGVyIHRoZSBERUZJTklUSU9OIHdpdGggRE9DVU1FTlQKICAgIHJlZ2lzdGVyRGVmaW5pdGlvbihuYW1lLCBkZWZpbml0aW9uKTsKICAgIC8vIDcuMS43LiBSdW4gY3VzdG9tIGVsZW1lbnQgY29uc3RydWN0b3IgZ2VuZXJhdGlvbiBhbGdvcml0aG0gd2l0aCBQUk9UT1RZUEUKICAgIC8vIDcuMS44LiBSZXR1cm4gdGhlIG91dHB1dCBvZiB0aGUgcHJldmlvdXMgc3RlcC4KICAgIGRlZmluaXRpb24uY3RvciA9IGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbik7CiAgICBkZWZpbml0aW9uLmN0b3IucHJvdG90eXBlID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgICAvLyBmb3JjZSBvdXIgLmNvbnN0cnVjdG9yIHRvIGJlIG91ciBhY3R1YWwgY29uc3RydWN0b3IKICAgIGRlZmluaXRpb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gZGVmaW5pdGlvbi5jdG9yOwogICAgLy8gaWYgaW5pdGlhbCBwYXJzaW5nIGlzIGNvbXBsZXRlCiAgICBpZiAoc2NvcGUucmVhZHkpIHsKICAgICAgLy8gdXBncmFkZSBhbnkgcHJlLWV4aXN0aW5nIG5vZGVzIG9mIHRoaXMgdHlwZQogICAgICBzY29wZS51cGdyYWRlQWxsKGRvY3VtZW50KTsKICAgIH0KICAgIHJldHVybiBkZWZpbml0aW9uLmN0b3I7CiAgfQoKICBmdW5jdGlvbiBhbmNlc3RyeShleHRuZHMpIHsKICAgIHZhciBleHRlbmRlZSA9IHJlZ2lzdHJ5W2V4dG5kc107CiAgICBpZiAoZXh0ZW5kZWUpIHsKICAgICAgcmV0dXJuIGFuY2VzdHJ5KGV4dGVuZGVlLmV4dGVuZHMpLmNvbmNhdChbZXh0ZW5kZWVdKTsKICAgIH0KICAgIHJldHVybiBbXTsKICB9CgogIGZ1bmN0aW9uIHJlc29sdmVUYWdOYW1lKGRlZmluaXRpb24pIHsKICAgIC8vIGlmIHdlIGFyZSBleHBsaWNpdGx5IGV4dGVuZGluZyBzb21ldGhpbmcsIHRoYXQgdGhpbmcgaXMgb3VyCiAgICAvLyBiYXNlVGFnLCB1bmxlc3MgaXQgcmVwcmVzZW50cyBhIGN1c3RvbSBjb21wb25lbnQKICAgIHZhciBiYXNlVGFnID0gZGVmaW5pdGlvbi5leHRlbmRzOwogICAgLy8gaWYgb3VyIGFuY2VzdHJ5IGluY2x1ZGVzIGN1c3RvbSBjb21wb25lbnRzLCB3ZSBvbmx5IGhhdmUgYQogICAgLy8gYmFzZVRhZyBpZiBvbmUgb2YgdGhlbSBkb2VzCiAgICBmb3IgKHZhciBpPTAsIGE7IChhPWRlZmluaXRpb24uYW5jZXN0cnlbaV0pOyBpKyspIHsKICAgICAgYmFzZVRhZyA9IGEuaXMgJiYgYS50YWc7CiAgICB9CiAgICAvLyBvdXIgdGFnIGlzIG91ciBiYXNlVGFnLCBpZiBpdCBleGlzdHMsIGFuZCBvdGhlcndpc2UganVzdCBvdXIgbmFtZQogICAgZGVmaW5pdGlvbi50YWcgPSBiYXNlVGFnIHx8IGRlZmluaXRpb24ubmFtZTsKICAgIGlmIChiYXNlVGFnKSB7CiAgICAgIC8vIGlmIHRoZXJlIGlzIGEgYmFzZSB0YWcsIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIKICAgICAgZGVmaW5pdGlvbi5pcyA9IGRlZmluaXRpb24ubmFtZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlc29sdmVQcm90b3R5cGVDaGFpbihkZWZpbml0aW9uKSB7CiAgICAvLyBpZiB3ZSBkb24ndCBzdXBwb3J0IF9fcHJvdG9fXyB3ZSBuZWVkIHRvIGxvY2F0ZSB0aGUgbmF0aXZlIGxldmVsCiAgICAvLyBwcm90b3R5cGUgZm9yIHByZWNpc2UgbWl4aW5nIGluCiAgICBpZiAoIU9iamVjdC5fX3Byb3RvX18pIHsKICAgICAgLy8gZGVmYXVsdCBwcm90b3R5cGUKICAgICAgdmFyIG5hdGl2ZVByb3RvdHlwZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAgICAgLy8gd29yayBvdXQgcHJvdG90eXBlIHdoZW4gdXNpbmcgdHlwZS1leHRlbnNpb24KICAgICAgaWYgKGRlZmluaXRpb24uaXMpIHsKICAgICAgICB2YXIgaW5zdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoZGVmaW5pdGlvbi50YWcpOwogICAgICAgIG5hdGl2ZVByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihpbnN0KTsKICAgICAgfQogICAgICAvLyBlbnN1cmUgX19wcm90b19fIHJlZmVyZW5jZSBpcyBpbnN0YWxsZWQgYXQgZWFjaCBwb2ludCBvbiB0aGUgcHJvdG90eXBlCiAgICAgIC8vIGNoYWluLgogICAgICAvLyBOT1RFOiBPbiBwbGF0Zm9ybXMgd2l0aG91dCBfX3Byb3RvX18sIGEgbWl4aW4gc3RyYXRlZ3kgaXMgdXNlZCBpbnN0ZWFkCiAgICAgIC8vIG9mIHByb3RvdHlwZSBzd2l6emxpbmcuIEluIHRoaXMgY2FzZSwgdGhpcyBnZW5lcmF0ZWQgX19wcm90b19fIHByb3ZpZGVzCiAgICAgIC8vIGxpbWl0ZWQgc3VwcG9ydCBmb3IgcHJvdG90eXBlIHRyYXZlcnNhbC4KICAgICAgdmFyIHByb3RvID0gZGVmaW5pdGlvbi5wcm90b3R5cGUsIGFuY2VzdG9yOwogICAgICB3aGlsZSAocHJvdG8gJiYgKHByb3RvICE9PSBuYXRpdmVQcm90b3R5cGUpKSB7CiAgICAgICAgdmFyIGFuY2VzdG9yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvKTsKICAgICAgICBwcm90by5fX3Byb3RvX18gPSBhbmNlc3RvcjsKICAgICAgICBwcm90byA9IGFuY2VzdG9yOwogICAgICB9CiAgICB9CiAgICAvLyBjYWNoZSB0aGlzIGluIGNhc2Ugb2YgbWl4aW4KICAgIGRlZmluaXRpb24ubmF0aXZlID0gbmF0aXZlUHJvdG90eXBlOwogIH0KCiAgLy8gU0VDVElPTiA0CgogIGZ1bmN0aW9uIGluc3RhbnRpYXRlKGRlZmluaXRpb24pIHsKICAgIC8vIDQuYS4xLiBDcmVhdGUgYSBuZXcgb2JqZWN0IHRoYXQgaW1wbGVtZW50cyBQUk9UT1RZUEUKICAgIC8vIDQuYS4yLiBMZXQgRUxFTUVOVCBieSB0aGlzIG5ldyBvYmplY3QKICAgIC8vCiAgICAvLyB0aGUgY3VzdG9tIGVsZW1lbnQgaW5zdGFudGlhdGlvbiBhbGdvcml0aG0gbXVzdCBhbHNvIGVuc3VyZSB0aGF0IHRoZQogICAgLy8gb3V0cHV0IGlzIGEgdmFsaWQgRE9NIGVsZW1lbnQgd2l0aCB0aGUgcHJvcGVyIHdyYXBwZXIgaW4gcGxhY2UuCiAgICAvLwogICAgcmV0dXJuIHVwZ3JhZGUoZG9tQ3JlYXRlRWxlbWVudChkZWZpbml0aW9uLnRhZyksIGRlZmluaXRpb24pOwogIH0KCiAgZnVuY3Rpb24gdXBncmFkZShlbGVtZW50LCBkZWZpbml0aW9uKSB7CiAgICAvLyBzb21lIGRlZmluaXRpb25zIHNwZWNpZnkgYW4gJ2lzJyBhdHRyaWJ1dGUKICAgIGlmIChkZWZpbml0aW9uLmlzKSB7CiAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdpcycsIGRlZmluaXRpb24uaXMpOwogICAgfQogICAgLy8gbWFrZSAnZWxlbWVudCcgaW1wbGVtZW50IGRlZmluaXRpb24ucHJvdG90eXBlCiAgICBpbXBsZW1lbnQoZWxlbWVudCwgZGVmaW5pdGlvbik7CiAgICAvLyBmbGFnIGFzIHVwZ3JhZGVkCiAgICBlbGVtZW50Ll9fdXBncmFkZWRfXyA9IHRydWU7CiAgICAvLyB0aGVyZSBzaG91bGQgbmV2ZXIgYmUgYSBzaGFkb3cgcm9vdCBvbiBlbGVtZW50IGF0IHRoaXMgcG9pbnQKICAgIC8vIHdlIHJlcXVpcmUgY2hpbGQgbm9kZXMgYmUgdXBncmFkZWQgYmVmb3JlIGBjcmVhdGVkYAogICAgc2NvcGUudXBncmFkZVN1YnRyZWUoZWxlbWVudCk7CiAgICAvLyBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgY3JlYXRlZChlbGVtZW50KTsKICAgIC8vIE9VVFBVVAogICAgcmV0dXJuIGVsZW1lbnQ7CiAgfQoKICBmdW5jdGlvbiBpbXBsZW1lbnQoZWxlbWVudCwgZGVmaW5pdGlvbikgewogICAgLy8gcHJvdG90eXBlIHN3aXp6bGluZyBpcyBiZXN0CiAgICBpZiAoT2JqZWN0Ll9fcHJvdG9fXykgewogICAgICBlbGVtZW50Ll9fcHJvdG9fXyA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogICAgfSBlbHNlIHsKICAgICAgLy8gd2hlcmUgYWJvdmUgd2UgY2FuIHJlLWFjcXVpcmUgaW5Qcm90b3R5cGUgdmlhCiAgICAgIC8vIGdldFByb3RvdHlwZU9mKEVsZW1lbnQpLCB3ZSBjYW5ub3QgZG8gc28gd2hlbgogICAgICAvLyB3ZSB1c2UgbWl4aW4sIHNvIHdlIGluc3RhbGwgYSBtYWdpYyByZWZlcmVuY2UKICAgICAgY3VzdG9tTWl4aW4oZWxlbWVudCwgZGVmaW5pdGlvbi5wcm90b3R5cGUsIGRlZmluaXRpb24ubmF0aXZlKTsKICAgICAgZWxlbWVudC5fX3Byb3RvX18gPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGN1c3RvbU1peGluKGluVGFyZ2V0LCBpblNyYywgaW5OYXRpdmUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6ICd1c2VkJyBhbGxvd3MgdXMgdG8gb25seSBjb3B5IHRoZSAneW91bmdlc3QnIHZlcnNpb24gb2YKICAgIC8vIGFueSBwcm9wZXJ0eS4gVGhpcyBzZXQgc2hvdWxkIGJlIHByZWNhbGN1bGF0ZWQuIFdlIGFsc28gbmVlZCB0bwogICAgLy8gY29uc2lkZXIgdGhpcyBmb3Igc3VwcG9ydGluZyAnc3VwZXInLgogICAgdmFyIHVzZWQgPSB7fTsKICAgIC8vIHN0YXJ0IHdpdGggaW5TcmMKICAgIHZhciBwID0gaW5TcmM7CiAgICAvLyBzb21ldGltZXMgdGhlIGRlZmF1bHQgaXMgSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSBpbnN0ZWFkIG9mCiAgICAvLyBIVE1MRWxlbWVudC5wcm90b3R5cGUsIHNvIHdlIGFkZCBhIHRlc3QKICAgIC8vIHRoZSBpZGVhIGlzIHRvIGF2b2lkIG1peGluZyBpbiBuYXRpdmUgcHJvdG90eXBlcywgc28gYWRkaW5nCiAgICAvLyB0aGUgc2Vjb25kIHRlc3QgaXMgV0xPRwogICAgd2hpbGUgKHAgIT09IGluTmF0aXZlICYmIHAgIT09IEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUpIHsKICAgICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwKTsKICAgICAgZm9yICh2YXIgaT0wLCBrOyBrPWtleXNbaV07IGkrKykgewogICAgICAgIGlmICghdXNlZFtrXSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGluVGFyZ2V0LCBrLAogICAgICAgICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocCwgaykpOwogICAgICAgICAgdXNlZFtrXSA9IDE7CiAgICAgICAgfQogICAgICB9CiAgICAgIHAgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVkKGVsZW1lbnQpIHsKICAgIC8vIGludm9rZSBjcmVhdGVkQ2FsbGJhY2sKICAgIGlmIChlbGVtZW50LmNyZWF0ZWRDYWxsYmFjaykgewogICAgICBlbGVtZW50LmNyZWF0ZWRDYWxsYmFjaygpOwogICAgfQogIH0KCiAgLy8gYXR0cmlidXRlIHdhdGNoaW5nCgogIGZ1bmN0aW9uIG92ZXJyaWRlQXR0cmlidXRlQXBpKHByb3RvdHlwZSkgewogICAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBjYWxsYmFja3MKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHNob3VsZCBzdXBwb3J0IGFjY2VzcyB2aWEgLmF0dHJpYnV0ZXMgTmFtZWROb2RlTWFwCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBwcmVzZXJ2ZXMgdXNlciBkZWZpbmVkIG92ZXJyaWRlcywgaWYgYW55CiAgICB2YXIgc2V0QXR0cmlidXRlID0gcHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICAgIHByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgc2V0QXR0cmlidXRlKTsKICAgIH0KICAgIHZhciByZW1vdmVBdHRyaWJ1dGUgPSBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogICAgcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCByZW1vdmVBdHRyaWJ1dGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hhbmdlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcGVyYXRpb24pIHsKICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgb3BlcmF0aW9uLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBpZiAodGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgCiAgICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgICAgdGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUpOwogICAgfQogIH0KCiAgLy8gZWxlbWVudCByZWdpc3RyeSAobWFwcyB0YWcgbmFtZXMgdG8gZGVmaW5pdGlvbnMpCgogIHZhciByZWdpc3RyeSA9IHt9OwoKICBmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24obmFtZSwgZGVmaW5pdGlvbikgewogICAgcmVnaXN0cnlbbmFtZV0gPSBkZWZpbml0aW9uOwogIH0KCiAgZnVuY3Rpb24gZ2VuZXJhdGVDb25zdHJ1Y3RvcihkZWZpbml0aW9uKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBpbnN0YW50aWF0ZShkZWZpbml0aW9uKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KHRhZywgdHlwZUV4dGVuc2lvbikgewogICAgLy8gVE9ETyhzam1pbGVzKTogaWdub3JlICd0YWcnIHdoZW4gdXNpbmcgJ3R5cGVFeHRlbnNpb24nLCB3ZSBjb3VsZAogICAgLy8gZXJyb3IgY2hlY2sgaXQsIG9yIHBlcmhhcHMgdGhlcmUgc2hvdWxkIG9ubHkgZXZlciBiZSBvbmUgYXJndW1lbnQKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZUV4dGVuc2lvbiB8fCB0YWddOwogICAgaWYgKGRlZmluaXRpb24pIHsKICAgICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICAgIH0KICAgIHJldHVybiBkb21DcmVhdGVFbGVtZW50KHRhZyk7CiAgfQoKICBmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChlbGVtZW50KSB7CiAgICBpZiAoIWVsZW1lbnQuX191cGdyYWRlZF9fICYmIChlbGVtZW50Lm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkpIHsKICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBlbGVtZW50LmxvY2FsTmFtZTsKICAgICAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVt0eXBlXTsKICAgICAgcmV0dXJuIGRlZmluaXRpb24gJiYgdXBncmFkZShlbGVtZW50LCBkZWZpbml0aW9uKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNsb25lTm9kZShkZWVwKSB7CiAgICAvLyBjYWxsIG9yaWdpbmFsIGNsb25lCiAgICB2YXIgbiA9IGRvbUNsb25lTm9kZS5jYWxsKHRoaXMsIGRlZXApOwogICAgLy8gdXBncmFkZSB0aGUgZWxlbWVudCBhbmQgc3VidHJlZQogICAgc2NvcGUudXBncmFkZUFsbChuKTsKICAgIC8vIHJldHVybiB0aGUgY2xvbmUKICAgIHJldHVybiBuOwogIH0KICAvLyBjYXB0dXJlIG5hdGl2ZSBjcmVhdGVFbGVtZW50IGJlZm9yZSB3ZSBvdmVycmlkZSBpdAoKICB2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgogIC8vIGNhcHR1cmUgbmF0aXZlIGNsb25lTm9kZSBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCiAgdmFyIGRvbUNsb25lTm9kZSA9IE5vZGUucHJvdG90eXBlLmNsb25lTm9kZTsKCiAgLy8gZXhwb3J0cwoKICBkb2N1bWVudC5yZWdpc3RlciA9IHJlZ2lzdGVyOwogIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50OyAvLyBvdmVycmlkZQogIE5vZGUucHJvdG90eXBlLmNsb25lTm9kZSA9IGNsb25lTm9kZTsgLy8gb3ZlcnJpZGUKCiAgc2NvcGUucmVnaXN0cnkgPSByZWdpc3RyeTsKCiAgLyoqCiAgICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAgICogY2F1c2VzIHRoZSBjdXN0b20gcHJvdG90eXBlIHRvIGJlIGFwcGxpZWQsIGFuIGBpc2AgYXR0cmlidXRlIAogICAqIHRvIGJlIGF0dGFjaGVkIChhcyBuZWVkZWQpLCBhbmQgaW52b2NhdGlvbiBvZiB0aGUgYHJlYWR5Q2FsbGJhY2tgLgogICAqIGB1cGdyYWRlYCBkb2VzIG5vdGhpbmcgaWYgdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSB1cGdyYWRlZCwgb3IKICAgKiBpZiBpdCBtYXRjaGVzIG5vIHJlZ2lzdGVyZWQgY3VzdG9tIHRhZyBuYW1lLgogICAqCiAgICogQG1ldGhvZCB1Z3ByYWRlCiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IFRoZSBlbGVtZW50IHRvIHVwZ3JhZGUuCiAgICogQHJldHVybiB7RWxlbWVudH0gVGhlIHVwZ3JhZGVkIGVsZW1lbnQuCiAgICovCiAgc2NvcGUudXBncmFkZSA9IHVwZ3JhZGVFbGVtZW50Owp9CgpzY29wZS5oYXNOYXRpdmUgPSBoYXNOYXRpdmU7CnNjb3BlLnVzZU5hdGl2ZSA9IHVzZU5hdGl2ZTsKCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7CgogLyoNCkNvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuDQpVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQ0KbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLg0KKi8NCg0KKGZ1bmN0aW9uKHNjb3BlKXsNCg0KdmFyIGxvZ0ZsYWdzID0gd2luZG93LmxvZ0ZsYWdzIHx8IHt9Ow0KDQovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBhcHBseWluZyAnZmluZChlbGVtZW50LCBkYXRhKScgZnVuY3Rpb24NCi8vIHRvIGVhY2ggZWxlbWVudA0KLy8gaWYgJ2ZpbmQnIHJldHVybnMgdHJ1ZSBmb3IgJ2VsZW1lbnQnLCBkbyBub3Qgc2VhcmNoIGVsZW1lbnQncyBzdWJ0cmVlDQpmdW5jdGlvbiBmaW5kQWxsKG5vZGUsIGZpbmQsIGRhdGEpIHsNCiAgdmFyIGUgPSBub2RlLmZpcnN0RWxlbWVudENoaWxkOw0KICBpZiAoIWUpIHsNCiAgICBlID0gbm9kZS5maXJzdENoaWxkOw0KICAgIHdoaWxlIChlICYmIGUubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7DQogICAgICBlID0gZS5uZXh0U2libGluZzsNCiAgICB9DQogIH0NCiAgd2hpbGUgKGUpIHsNCiAgICBpZiAoZmluZChlLCBkYXRhKSAhPT0gdHJ1ZSkgew0KICAgICAgZmluZEFsbChlLCBmaW5kLCBkYXRhKTsNCiAgICB9DQogICAgZSA9IGUubmV4dEVsZW1lbnRTaWJsaW5nOw0KICB9DQogIHJldHVybiBudWxsOw0KfQ0KDQovLyB3YWxrIGFsbCBzaGFkb3dSb290cyBvbiBhIGdpdmVuIG5vZGUuDQpmdW5jdGlvbiBmb3JSb290cyhub2RlLCBjYikgew0KICB2YXIgcm9vdCA9IG5vZGUuc2hhZG93Um9vdDsNCiAgd2hpbGUocm9vdCkgew0KICAgIGZvclN1YnRyZWUocm9vdCwgY2IpOw0KICAgIHJvb3QgPSByb290Lm9sZGVyU2hhZG93Um9vdDsNCiAgfQ0KfQ0KDQovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBpbmNsdWRpbmcgZGVzY2VudCBpbnRvIHNoYWRvdy1yb290cywNCi8vIGFwcGx5aW5nICdjYicgdG8gZWFjaCBlbGVtZW50DQpmdW5jdGlvbiBmb3JTdWJ0cmVlKG5vZGUsIGNiKSB7DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXAoJ3N1YlRyZWU6ICcsIG5vZGUpOw0KICBmaW5kQWxsKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoY2IoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgICBmb3JSb290cyhlLCBjYik7DQogIH0pOw0KICBmb3JSb290cyhub2RlLCBjYik7DQogIC8vbG9nRmxhZ3MuZG9tICYmIG5vZGUuY2hpbGROb2RlcyAmJiBub2RlLmNoaWxkTm9kZXMubGVuZ3RoICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlDQpmdW5jdGlvbiBhZGRlZChub2RlKSB7DQogIGlmICh1cGdyYWRlKG5vZGUpKSB7DQogICAgaW5zZXJ0ZWROb2RlKG5vZGUpOw0KICAgIHJldHVybiB0cnVlOw0KICB9DQogIGluc2VydGVkKG5vZGUpOw0KfQ0KDQovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUncyBzdWJ0cmVlIG9ubHkNCmZ1bmN0aW9uIGFkZGVkU3VidHJlZShub2RlKSB7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIGlmIChhZGRlZChlKSkgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICB9KTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlIGFuZCBpdCdzIHN1YnRyZWUNCmZ1bmN0aW9uIGFkZGVkTm9kZShub2RlKSB7DQogIHJldHVybiBhZGRlZChub2RlKSB8fCBhZGRlZFN1YnRyZWUobm9kZSk7DQp9DQoNCi8vIHVwZ3JhZGUgY3VzdG9tIGVsZW1lbnRzIGF0IG5vZGUsIGlmIGFwcGxpY2FibGUNCmZ1bmN0aW9uIHVwZ3JhZGUobm9kZSkgew0KICBpZiAoIW5vZGUuX191cGdyYWRlZF9fICYmIG5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7DQogICAgdmFyIHR5cGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBub2RlLmxvY2FsTmFtZTsNCiAgICB2YXIgZGVmaW5pdGlvbiA9IHNjb3BlLnJlZ2lzdHJ5W3R5cGVdOw0KICAgIGlmIChkZWZpbml0aW9uKSB7DQogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZTonLCBub2RlLmxvY2FsTmFtZSk7DQogICAgICBzY29wZS51cGdyYWRlKG5vZGUpOw0KICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgfQ0KfQ0KDQpmdW5jdGlvbiBpbnNlcnRlZE5vZGUobm9kZSkgew0KICBpbnNlcnRlZChub2RlKTsNCiAgaWYgKGluRG9jdW1lbnQobm9kZSkpIHsNCiAgICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICAgIGluc2VydGVkKGUpOw0KICAgIH0pOw0KICB9DQp9DQoNCg0KLy8gVE9ETyhzb3J2ZWxsKTogb24gcGxhdGZvcm1zIHdpdGhvdXQgTXV0YXRpb25PYnNlcnZlciwgbXV0YXRpb25zIG1heSBub3QgYmUgDQovLyByZWxpYWJsZSBhbmQgdGhlcmVmb3JlIGVudGVyZWQvbGVmdFZpZXcgYXJlIG5vdCByZWxpYWJsZS4NCi8vIFRvIG1ha2UgdGhlc2UgY2FsbGJhY2tzIGxlc3MgbGlrZWx5IHRvIGZhaWwsIHdlIGRlZmVyIGFsbCBpbnNlcnRzIGFuZCByZW1vdmVzDQovLyB0byBnaXZlIGEgY2hhbmNlIGZvciBlbGVtZW50cyB0byBiZSBpbnNlcnRlZCBpbnRvIGRvbS4gDQovLyBUaGlzIGVuc3VyZXMgZW50ZXJlZFZpZXdDYWxsYmFjayBmaXJlcyBmb3IgZWxlbWVudHMgdGhhdCBhcmUgY3JlYXRlZCBhbmQgDQovLyBpbW1lZGlhdGVseSBhZGRlZCB0byBkb20uDQp2YXIgaGFzUG9seWZpbGxNdXRhdGlvbnMgPSAoIXdpbmRvdy5NdXRhdGlvbk9ic2VydmVyIHx8DQogICAgKHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyID09PSB3aW5kb3cuSnNNdXRhdGlvbk9ic2VydmVyKSk7DQpzY29wZS5oYXNQb2x5ZmlsbE11dGF0aW9ucyA9IGhhc1BvbHlmaWxsTXV0YXRpb25zOw0KDQp2YXIgaXNQZW5kaW5nTXV0YXRpb25zID0gZmFsc2U7DQp2YXIgcGVuZGluZ011dGF0aW9ucyA9IFtdOw0KZnVuY3Rpb24gZGVmZXJNdXRhdGlvbihmbikgew0KICBwZW5kaW5nTXV0YXRpb25zLnB1c2goZm4pOw0KICBpZiAoIWlzUGVuZGluZ011dGF0aW9ucykgew0KICAgIGlzUGVuZGluZ011dGF0aW9ucyA9IHRydWU7DQogICAgdmFyIGFzeW5jID0gKHdpbmRvdy5QbGF0Zm9ybSAmJiB3aW5kb3cuUGxhdGZvcm0uZW5kT2ZNaWNyb3Rhc2spIHx8DQogICAgICAgIHNldFRpbWVvdXQ7DQogICAgYXN5bmModGFrZU11dGF0aW9ucyk7DQogIH0NCn0NCg0KZnVuY3Rpb24gdGFrZU11dGF0aW9ucygpIHsNCiAgaXNQZW5kaW5nTXV0YXRpb25zID0gZmFsc2U7DQogIHZhciAkcCA9IHBlbmRpbmdNdXRhdGlvbnM7DQogIGZvciAodmFyIGk9MCwgbD0kcC5sZW5ndGgsIHA7IChpPGwpICYmIChwPSRwW2ldKTsgaSsrKSB7DQogICAgcCgpOw0KICB9DQogIHBlbmRpbmdNdXRhdGlvbnMgPSBbXTsNCn0NCg0KZnVuY3Rpb24gaW5zZXJ0ZWQoZWxlbWVudCkgew0KICBpZiAoaGFzUG9seWZpbGxNdXRhdGlvbnMpIHsNCiAgICBkZWZlck11dGF0aW9uKGZ1bmN0aW9uKCkgew0KICAgICAgX2luc2VydGVkKGVsZW1lbnQpOw0KICAgIH0pOw0KICB9IGVsc2Ugew0KICAgIF9pbnNlcnRlZChlbGVtZW50KTsNCiAgfQ0KfQ0KDQovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMNCmZ1bmN0aW9uIF9pbnNlcnRlZChlbGVtZW50KSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IGl0J3MgcG9zc2libGUgd2Ugd2VyZSBpbnNlcnRlZCBhbmQgcmVtb3ZlZCBpbiB0aGUgc3BhY2UNCiAgLy8gb2Ygb25lIG1pY3JvdGFzaywgaW4gd2hpY2ggY2FzZSB3ZSB3b24ndCBiZSAnaW5Eb2N1bWVudCcgaGVyZQ0KICAvLyBCdXQgdGhlcmUgYXJlIG90aGVyIGNhc2VzIHdoZXJlIHdlIGFyZSB0ZXN0aW5nIGZvciBpbnNlcnRlZCB3aXRob3V0DQogIC8vIHNwZWNpZmljIGtub3dsZWRnZSBvZiBtdXRhdGlvbnMsIGFuZCBtdXN0IHRlc3QgJ2luRG9jdW1lbnQnIHRvIGRldGVybWluZQ0KICAvLyB3aGV0aGVyIHRvIGNhbGwgaW5zZXJ0ZWQNCiAgLy8gSWYgd2UgY2FuIGZhY3RvciB0aGVzZSBjYXNlcyBpbnRvIHNlcGFyYXRlIGNvZGUgcGF0aHMgd2UgY2FuIGhhdmUNCiAgLy8gYmV0dGVyIGRpYWdub3N0aWNzLg0KICAvLyBUT0RPKHNqbWlsZXMpOiB3aGVuIGxvZ2dpbmcsIGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4NCiAgLy8gdHJhY2sgYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZA0KICAvL2NvbnNvbGUubG9nKCdpbnNlcnRlZDogJywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICBpZiAoZWxlbWVudC5lbnRlcmVkVmlld0NhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgICBpZiAoaW5Eb2N1bWVudChlbGVtZW50KSkgew0KICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSArIDE7DQogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAncmVtb3ZlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdpbnNlcnRlZCcgc3RhdGUNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAxKSB7DQogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDE7DQogICAgICB9DQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgaW5zZXJ0ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjaw0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDEpIHsNCiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybignaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsDQogICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQ0KICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmVudGVyZWRWaWV3Q2FsbGJhY2spIHsNCiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgICAgIGVsZW1lbnQuZW50ZXJlZFZpZXdDYWxsYmFjaygpOw0KICAgICAgfQ0KICAgIH0NCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICB9DQp9DQoNCmZ1bmN0aW9uIHJlbW92ZWROb2RlKG5vZGUpIHsNCiAgcmVtb3ZlZChub2RlKTsNCiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgcmVtb3ZlZChlKTsNCiAgfSk7DQp9DQoNCg0KZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7DQogIGlmIChoYXNQb2x5ZmlsbE11dGF0aW9ucykgew0KICAgIGRlZmVyTXV0YXRpb24oZnVuY3Rpb24oKSB7DQogICAgICBfcmVtb3ZlZChlbGVtZW50KTsNCiAgICB9KTsNCiAgfSBlbHNlIHsNCiAgICBfcmVtb3ZlZChlbGVtZW50KTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkKGVsZW1lbnQpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrDQogIC8vIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgaWYgKGVsZW1lbnQubGVmdFZpZXdDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKCFpbkRvY3VtZW50KGVsZW1lbnQpKSB7DQogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsNCiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdpbnNlcnRlZCcgc3RhdGUsIGJsdW50bHkgYWRqdXN0IHRvIGFuICdyZW1vdmVkJyBzdGF0ZQ0KICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDApIHsNCiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsNCiAgICAgIH0NCiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciByZW1vdmVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUsDQogICAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpDQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQubGVmdFZpZXdDYWxsYmFjaykgew0KICAgICAgICBlbGVtZW50LmxlZnRWaWV3Q2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7DQogIHZhciBwID0gZWxlbWVudDsNCiAgdmFyIGRvYyA9IHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCAmJg0KICAgICAgd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsLndyYXBJZk5lZWRlZChkb2N1bWVudCkgfHwgZG9jdW1lbnQ7DQogIHdoaWxlIChwKSB7DQogICAgaWYgKHAgPT0gZG9jKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgcCA9IHAucGFyZW50Tm9kZSB8fCBwLmhvc3Q7DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hTaGFkb3cobm9kZSkgew0KICBpZiAobm9kZS5zaGFkb3dSb290ICYmICFub2RlLnNoYWRvd1Jvb3QuX193YXRjaGVkKSB7DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCd3YXRjaGluZyBzaGFkb3ctcm9vdCBmb3I6ICcsIG5vZGUubG9jYWxOYW1lKTsNCiAgICAvLyB3YXRjaCBhbGwgdW53YXRjaGVkIHJvb3RzLi4uDQogICAgdmFyIHJvb3QgPSBub2RlLnNoYWRvd1Jvb3Q7DQogICAgd2hpbGUgKHJvb3QpIHsNCiAgICAgIHdhdGNoUm9vdChyb290KTsNCiAgICAgIHJvb3QgPSByb290Lm9sZGVyU2hhZG93Um9vdDsNCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gd2F0Y2hSb290KHJvb3QpIHsNCiAgaWYgKCFyb290Ll9fd2F0Y2hlZCkgew0KICAgIG9ic2VydmUocm9vdCk7DQogICAgcm9vdC5fX3dhdGNoZWQgPSB0cnVlOw0KICB9DQp9DQoNCmZ1bmN0aW9uIGZpbHRlcihpbk5vZGUpIHsNCiAgc3dpdGNoIChpbk5vZGUubG9jYWxOYW1lKSB7DQogICAgY2FzZSAnc3R5bGUnOg0KICAgIGNhc2UgJ3NjcmlwdCc6DQogICAgY2FzZSAndGVtcGxhdGUnOg0KICAgIGNhc2UgdW5kZWZpbmVkOg0KICAgICAgcmV0dXJuIHRydWU7DQogIH0NCn0NCg0KZnVuY3Rpb24gaGFuZGxlcihtdXRhdGlvbnMpIHsNCiAgLy8NCiAgaWYgKGxvZ0ZsYWdzLmRvbSkgew0KICAgIHZhciBteCA9IG11dGF0aW9uc1swXTsNCiAgICBpZiAobXggJiYgbXgudHlwZSA9PT0gJ2NoaWxkTGlzdCcgJiYgbXguYWRkZWROb2Rlcykgew0KICAgICAgICBpZiAobXguYWRkZWROb2Rlcykgew0KICAgICAgICAgIHZhciBkID0gbXguYWRkZWROb2Rlc1swXTsNCiAgICAgICAgICB3aGlsZSAoZCAmJiBkICE9PSBkb2N1bWVudCAmJiAhZC5ob3N0KSB7DQogICAgICAgICAgICBkID0gZC5wYXJlbnROb2RlOw0KICAgICAgICAgIH0NCiAgICAgICAgICB2YXIgdSA9IGQgJiYgKGQuVVJMIHx8IGQuX1VSTCB8fCAoZC5ob3N0ICYmIGQuaG9zdC5sb2NhbE5hbWUpKSB8fCAnJzsNCiAgICAgICAgICB1ID0gdS5zcGxpdCgnLz8nKS5zaGlmdCgpLnNwbGl0KCcvJykucG9wKCk7DQogICAgICAgIH0NCiAgICB9DQogICAgY29uc29sZS5ncm91cCgnbXV0YXRpb25zICglZCkgWyVzXScsIG11dGF0aW9ucy5sZW5ndGgsIHUgfHwgJycpOw0KICB9DQogIC8vDQogIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG14KSB7DQogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnbXV0YXRpb24nKTsNCiAgICBpZiAobXgudHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHsNCiAgICAgIGZvckVhY2gobXguYWRkZWROb2RlcywgZnVuY3Rpb24obikgew0KICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7DQogICAgICAgIGlmIChmaWx0ZXIobikpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgLy8gbm9kZXMgYWRkZWQgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQNCiAgICAgICAgYWRkZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgICAvLyByZW1vdmVkIG5vZGVzIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgew0KICAgICAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZyhuLmxvY2FsTmFtZSk7DQogICAgICAgIGlmIChmaWx0ZXIobikpIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgICAgcmVtb3ZlZE5vZGUobik7DQogICAgICB9KTsNCiAgICB9DQogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KICB9KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn07DQoNCnZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGhhbmRsZXIpOw0KDQpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsNCiAgLy8gVE9ETyhzam1pbGVzKTogYXNrIFJhZiB3aHkgd2UgaGF2ZSB0byBjYWxsIGhhbmRsZXIgb3Vyc2VsdmVzDQogIGhhbmRsZXIob2JzZXJ2ZXIudGFrZVJlY29yZHMoKSk7DQogIHRha2VNdXRhdGlvbnMoKTsNCn0NCg0KdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOw0KDQpmdW5jdGlvbiBvYnNlcnZlKGluUm9vdCkgew0KICBvYnNlcnZlci5vYnNlcnZlKGluUm9vdCwge2NoaWxkTGlzdDogdHJ1ZSwgc3VidHJlZTogdHJ1ZX0pOw0KfQ0KDQpmdW5jdGlvbiBvYnNlcnZlRG9jdW1lbnQoZG9jdW1lbnQpIHsNCiAgb2JzZXJ2ZShkb2N1bWVudCk7DQp9DQoNCmZ1bmN0aW9uIHVwZ3JhZGVEb2N1bWVudChkb2N1bWVudCkgew0KICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZURvY3VtZW50OiAnLCAoZG9jdW1lbnQuVVJMIHx8IGRvY3VtZW50Ll9VUkwgfHwgJycpLnNwbGl0KCcvJykucG9wKCkpOw0KICBhZGRlZE5vZGUoZG9jdW1lbnQpOw0KICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOw0KfQ0KDQovLyBleHBvcnRzDQoNCnNjb3BlLndhdGNoU2hhZG93ID0gd2F0Y2hTaGFkb3c7DQpzY29wZS51cGdyYWRlQWxsID0gYWRkZWROb2RlOw0Kc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7DQoNCnNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG9ic2VydmVEb2N1bWVudDsNCnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsNCg0Kc2NvcGUudGFrZVJlY29yZHMgPSB0YWtlUmVjb3JkczsNCg0KfSkod2luZG93LkN1c3RvbUVsZW1lbnRzKTsNCgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuSFRNTEltcG9ydHMgPSB7ZmxhZ3M6e319Owp9CgovLyBpbXBvcnRzCgp2YXIgeGhyID0gc2NvcGUueGhyOwoKLy8gaW1wb3J0ZXIKCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CnZhciBTVFlMRV9MSU5LX1RZUEUgPSAnc3R5bGVzaGVldCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCByZXByZXNlbnRzIGEgcHJpbWFyeSBkb2N1bWVudCAodGhlIGFyZ3VtZW50IHRvICdsb2FkJykKLy8gYXQgdGhlIHJvb3Qgb2YgYSB0cmVlIG9mIGRvY3VtZW50cwoKLy8gZm9yIGFueSBkb2N1bWVudCwgaW1wb3J0ZXI6Ci8vIC0gbG9hZHMgYW55IGxpbmtlZCBkb2N1bWVudHMgKHdpdGggZGVkdXBpbmcpLCBtb2RpZmllcyBwYXRocyBhbmQgZmVlZHMgdGhlbSBiYWNrIGludG8gaW1wb3J0ZXIKLy8gLSBsb2FkcyB0ZXh0IG9mIGV4dGVybmFsIHNjcmlwdCB0YWdzCi8vIC0gbG9hZHMgdGV4dCBvZiBleHRlcm5hbCBzdHlsZSB0YWdzIGluc2lkZSBvZiA8ZWxlbWVudD4sIG1vZGlmaWVzIHBhdGhzCgovLyB3aGVuIGltcG9ydGVyICdtb2RpZmllcyBwYXRocycgaW4gYSBkb2N1bWVudCwgdGhpcyBpbmNsdWRlcwovLyAtIGhyZWYvc3JjL2FjdGlvbiBpbiBub2RlIGF0dHJpYnV0ZXMKLy8gLSBwYXRocyBpbiBpbmxpbmUgc3R5bGVzaGVldHMKLy8gLSBhbGwgY29udGVudCBpbnNpZGUgdGVtcGxhdGVzCgovLyBsaW5rZWQgc3R5bGUgc2hlZXRzIGluIGFuIGltcG9ydCBoYXZlIHRoZWlyIG93biBwYXRoIGZpeGVkIHVwIHdoZW4gdGhlaXIgY29udGFpbmluZyBpbXBvcnQgbW9kaWZpZXMgcGF0aHMKLy8gbGlua2VkIHN0eWxlIHNoZWV0cyBpbiBhbiA8ZWxlbWVudD4gYXJlIGxvYWRlZCwgYW5kIHRoZSBjb250ZW50IGdldHMgcGF0aCBmaXh1cHMKLy8gaW5saW5lIHN0eWxlIHNoZWV0cyBnZXQgcGF0aCBmaXh1cHMgd2hlbiB0aGVpciBjb250YWluaW5nIGltcG9ydCBtb2RpZmllcyBwYXRocwoKdmFyIGxvYWRlcjsKCnZhciBpbXBvcnRlciA9IHsKICBkb2N1bWVudHM6IHt9LAogIGNhY2hlOiB7fSwKICBwcmVsb2FkU2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnZWxlbWVudCBsaW5rW3JlbD0nICsgU1RZTEVfTElOS19UWVBFICsgJ10nLAogICAgJ3RlbXBsYXRlJywKICAgICdzY3JpcHRbc3JjXTpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3NyY11bdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0nCiAgXS5qb2luKCcsJyksCiAgbG9hZGVyOiBmdW5jdGlvbihuZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBuZXh0KTsKICAgIC8vIGFsaWFzIHRoZSBsb2FkZXIgY2FjaGUgKGZvciBkZWJ1Z2dpbmcpCiAgICBsb2FkZXIuY2FjaGUgPSBpbXBvcnRlci5jYWNoZTsKICAgIHJldHVybiBsb2FkZXI7CiAgfSwKICBsb2FkOiBmdW5jdGlvbihkb2MsIG5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gaW1wb3J0ZXIubG9hZGVyKG5leHQpOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoZG9jKTsKICB9LAogIHByZWxvYWQ6IGZ1bmN0aW9uKGRvYykgewogICAgLy8gYWxsIHByZWxvYWRhYmxlIG5vZGVzIGluIGluRG9jdW1lbnQKICAgIHZhciBub2RlcyA9IGRvYy5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gZnJvbSB0aGUgbWFpbiBkb2N1bWVudCwgb25seSBsb2FkIGltcG9ydHMKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGRvIHRoaXMgYnkgYWx0ZXJpbmcgdGhlIHNlbGVjdG9yIGxpc3QgaW5zdGVhZAogICAgbm9kZXMgPSB0aGlzLmZpbHRlck1haW5Eb2N1bWVudE5vZGVzKGRvYywgbm9kZXMpOwogICAgLy8gZXh0cmEgbGluayBub2RlcyBmcm9tIHRlbXBsYXRlcywgZmlsdGVyIHRlbXBsYXRlcyBvdXQgb2YgdGhlIG5vZGVzIGxpc3QKICAgIG5vZGVzID0gdGhpcy5leHRyYWN0VGVtcGxhdGVOb2Rlcyhub2Rlcyk7CiAgICAvLyBhZGQgdGhlc2Ugbm9kZXMgdG8gbG9hZGVyJ3MgcXVldWUKICAgIGxvYWRlci5hZGROb2Rlcyhub2Rlcyk7CiAgfSwKICBmaWx0ZXJNYWluRG9jdW1lbnROb2RlczogZnVuY3Rpb24oZG9jLCBub2RlcykgewogICAgaWYgKGRvYyA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gIWlzU2NyaXB0KG4pOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBub2RlczsKICB9LAogIGV4dHJhY3RUZW1wbGF0ZU5vZGVzOiBmdW5jdGlvbihub2RlcykgewogICAgdmFyIGV4dHJhID0gW107CiAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICBpZiAobi5sb2NhbE5hbWUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICBpZiAobi5jb250ZW50KSB7CiAgICAgICAgICB2YXIgbCQgPSBuLmNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArCiAgICAgICAgICAgICddJyk7CiAgICAgICAgICBpZiAobCQubGVuZ3RoKSB7CiAgICAgICAgICAgIGV4dHJhID0gZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGwkLCAwKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogICAgaWYgKGV4dHJhLmxlbmd0aCkgewogICAgICBub2RlcyA9IG5vZGVzLmNvbmNhdChleHRyYSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBsb2FkZWQ6IGZ1bmN0aW9uKHVybCwgZWx0LCByZXNvdXJjZSkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF07CiAgICAgIC8vIGlmIHdlJ3ZlIG5ldmVyIHNlZW4gYSBkb2N1bWVudCBhdCB0aGlzIHVybAogICAgICBpZiAoIWRvY3VtZW50KSB7CiAgICAgICAgLy8gZ2VuZXJhdGUgYW4gSFRNTERvY3VtZW50IGZyb20gZGF0YQogICAgICAgIGRvY3VtZW50ID0gbWFrZURvY3VtZW50KHJlc291cmNlLCB1cmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1t1cmxdID0gZG9jdW1lbnQ7CiAgICAgICAgLy8gYWRkIG5vZGVzIGZyb20gdGhpcyBkb2N1bWVudCB0byB0aGUgbG9hZGVyIHF1ZXVlCiAgICAgICAgaW1wb3J0ZXIucHJlbG9hZChkb2N1bWVudCk7CiAgICAgIH0KICAgICAgLy8gc3RvcmUgaW1wb3J0IHJlY29yZAogICAgICBlbHQuaW1wb3J0ID0gewogICAgICAgIGhyZWY6IHVybCwKICAgICAgICBvd25lck5vZGU6IGVsdCwKICAgICAgICBjb250ZW50OiBkb2N1bWVudAogICAgICB9OwogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBlbHQuY29udGVudCA9IHJlc291cmNlID0gZG9jdW1lbnQ7CiAgICB9CiAgICAvLyBzdG9yZSBnZW5lcmljIHJlc291cmNlCiAgICAvLyBUT0RPKHNvcnZlbGwpOiBmYWlscyBmb3Igbm9kZXMgaW5zaWRlIDx0ZW1wbGF0ZT4uY29udGVudAogICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0yNDkzODEuCiAgICBlbHQuX19yZXNvdXJjZSA9IHJlc291cmNlOwogICAgLy8gY3NzIHBhdGggZml4dXBzCiAgICBpZiAoaXNTdHlsZXNoZWV0TGluayhlbHQpKSB7CiAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGVsdCk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc1N0eWxlc2hlZXRMaW5rKGVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoZWx0LCBTVFlMRV9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoZWx0LCByZWwpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIGVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSByZWw7Cn0KCmZ1bmN0aW9uIGlzU2NyaXB0KGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnc2NyaXB0JzsKfQoKZnVuY3Rpb24gbWFrZURvY3VtZW50KHJlc291cmNlLCB1cmwpIHsKICAvLyBjcmVhdGUgYSBuZXcgSFRNTCBkb2N1bWVudAogIHZhciBkb2MgPSByZXNvdXJjZTsKICBpZiAoIShkb2MgaW5zdGFuY2VvZiBEb2N1bWVudCkpIHsKICAgIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudChJTVBPUlRfTElOS19UWVBFKTsKICAgIC8vIGluc3RhbGwgaHRtbAogICAgZG9jLmJvZHkuaW5uZXJIVE1MID0gcmVzb3VyY2U7CiAgfQogIC8vIGNhY2hlIHRoZSBuZXcgZG9jdW1lbnQncyBzb3VyY2UgdXJsCiAgZG9jLl9VUkwgPSB1cmw7CiAgLy8gZXN0YWJsaXNoIGEgcmVsYXRpdmUgcGF0aCB2aWEgPGJhc2U+CiAgdmFyIGJhc2UgPSBkb2MuY3JlYXRlRWxlbWVudCgnYmFzZScpOwogIGJhc2Uuc2V0QXR0cmlidXRlKCdocmVmJywgZG9jdW1lbnQuYmFzZVVSSSB8fCBkb2N1bWVudC5VUkwpOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogIC8vIFRPRE8oc29ydmVsbCk6IGlkZWFsbHkgdGhpcyBjb2RlIGlzIG5vdCBhd2FyZSBvZiBUZW1wbGF0ZSBwb2x5ZmlsbCwKICAvLyBidXQgZm9yIG5vdyB0aGUgcG9seWZpbGwgbmVlZHMgaGVscCB0byBib290c3RyYXAgdGhlc2UgdGVtcGxhdGVzCiAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcChkb2MpOwogIH0KICByZXR1cm4gZG9jOwp9Cgp2YXIgTG9hZGVyID0gZnVuY3Rpb24ob25Mb2FkLCBvbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBvbkxvYWQ7CiAgdGhpcy5vbmNvbXBsZXRlID0gb25Db21wbGV0ZTsKICB0aGlzLmluZmxpZ2h0ID0gMDsKICB0aGlzLnBlbmRpbmcgPSB7fTsKICB0aGlzLmNhY2hlID0ge307Cn07CgpMb2FkZXIucHJvdG90eXBlID0gewogIGFkZE5vZGVzOiBmdW5jdGlvbihub2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBub2Rlcy5sZW5ndGg7CiAgICAvLyBjb21tZW5jZSB0cmFuc2FjdGlvbnMKICAgIGZvckVhY2gobm9kZXMsIHRoaXMucmVxdWlyZSwgdGhpcyk7CiAgICAvLyBhbnl0aGluZyB0byBkbz8KICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICByZXF1aXJlOiBmdW5jdGlvbihlbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoZWx0KTsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGFkLWhvYwogICAgZWx0Ll9fbm9kZVVybCA9IHVybDsKICAgIC8vIGRlZHVwbGljYXRpb24KICAgIGlmICghdGhpcy5kZWR1cGUodXJsLCBlbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGVsdCk7CiAgICB9CiAgfSwKICBkZWR1cGU6IGZ1bmN0aW9uKHVybCwgZWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW3VybF0pIHsKICAgICAgLy8gYWRkIHRvIGxpc3Qgb2Ygbm9kZXMgd2FpdGluZyBmb3IgaW5VcmwKICAgICAgdGhpcy5wZW5kaW5nW3VybF0ucHVzaChlbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbdXJsXSkgewogICAgICAvLyBjb21wbGV0ZSBsb2FkIHVzaW5nIGNhY2hlIGRhdGEKICAgICAgdGhpcy5vbmxvYWQodXJsLCBlbHQsIGxvYWRlci5jYWNoZVt1cmxdKTsKICAgICAgLy8gZmluaXNoZWQgdGhpcyB0cmFuc2FjdGlvbgogICAgICB0aGlzLnRhaWwoKTsKICAgICAgLy8gZG9uJ3QgbmVlZCBmZXRjaAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIC8vIGZpcnN0IG5vZGUgd2FpdGluZyBmb3IgaW5VcmwKICAgIHRoaXMucGVuZGluZ1t1cmxdID0gW2VsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKHVybCwgZWx0KSB7CiAgICB2YXIgcmVjZWl2ZVhociA9IGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKHVybCwgZWx0LCBlcnIsIHJlc291cmNlKTsKICAgIH0uYmluZCh0aGlzKTsKICAgIHhoci5sb2FkKHVybCwgcmVjZWl2ZVhocik7CiAgICAvLyBUT0RPKHNvcnZlbGwpOiBibG9ja2VkIG9uCiAgICAvLyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MjU3MjIxCiAgICAvLyB4aHInaW5nIGZvciBhIGRvY3VtZW50IG1ha2VzIHNjcmlwdHMgaW4gaW1wb3J0cyBydW5uYWJsZTsgb3RoZXJ3aXNlCiAgICAvLyB0aGV5IGFyZSBub3Q7IGhvd2V2ZXIsIGl0IHJlcXVpcmVzIHRoYXQgd2UgaGF2ZSBkb2N0eXBlPWh0bWwgaW4KICAgIC8vIHRoZSBpbXBvcnQgd2hpY2ggaXMgdW5hY2NlcHRhYmxlLiBUaGlzIGlzIG9ubHkgbmVlZGVkIG9uIENocm9tZQogICAgLy8gdG8gYXZvaWQgdGhlIGJ1ZyBhYm92ZS4KICAgIC8qCiAgICBpZiAoaXNEb2N1bWVudExpbmsoZWx0KSkgewogICAgICB4aHIubG9hZERvY3VtZW50KHVybCwgcmVjZWl2ZVhocik7CiAgICB9IGVsc2UgewogICAgICB4aHIubG9hZCh1cmwsIHJlY2VpdmVYaHIpOwogICAgfQogICAgKi8KICB9LAogIHJlY2VpdmU6IGZ1bmN0aW9uKHVybCwgZWx0LCBlcnIsIHJlc291cmNlKSB7CiAgICBpZiAoIWVycikgewogICAgICBsb2FkZXIuY2FjaGVbdXJsXSA9IHJlc291cmNlOwogICAgfQogICAgbG9hZGVyLnBlbmRpbmdbdXJsXS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKCFlcnIpIHsKICAgICAgICB0aGlzLm9ubG9hZCh1cmwsIGUsIHJlc291cmNlKTsKICAgICAgfQogICAgICB0aGlzLnRhaWwoKTsKICAgIH0sIHRoaXMpOwogICAgbG9hZGVyLnBlbmRpbmdbdXJsXSA9IG51bGw7CiAgfSwKICB0YWlsOiBmdW5jdGlvbigpIHsKICAgIC0tdGhpcy5pbmZsaWdodDsKICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICBjaGVja0RvbmU6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHRoaXMub25jb21wbGV0ZSgpOwogICAgfQogIH0KfTsKCnZhciBVUkxfQVRUUlMgPSBbJ2hyZWYnLCAnc3JjJywgJ2FjdGlvbiddOwp2YXIgVVJMX0FUVFJTX1NFTEVDVE9SID0gJ1snICsgVVJMX0FUVFJTLmpvaW4oJ10sWycpICsgJ10nOwp2YXIgVVJMX1RFTVBMQVRFX1NFQVJDSCA9ICd7ey4qfX0nOwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24obm9kZSkgewogICAgcmV0dXJuIHBhdGgucmVzb2x2ZVVybChwYXRoLmRvY3VtZW50VVJMLCBwYXRoLmhyZWZPclNyYyhub2RlKSk7CiAgfSwKICBocmVmT3JTcmM6IGZ1bmN0aW9uKG5vZGUpIHsKICAgIHJldHVybiBub2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IG5vZGUuZ2V0QXR0cmlidXRlKCJzcmMiKTsKICB9LAogIGRvY3VtZW50VXJsRnJvbU5vZGU6IGZ1bmN0aW9uKG5vZGUpIHsKICAgIHJldHVybiBwYXRoLmdldERvY3VtZW50VXJsKG5vZGUub3duZXJEb2N1bWVudCB8fCBub2RlKTsKICB9LAogIGdldERvY3VtZW50VXJsOiBmdW5jdGlvbihkb2MpIHsKICAgIHZhciB1cmwgPSBkb2MgJiYKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgICAgICAoZG9jLl9VUkwgfHwgKGRvYy5pbXBsICYmIGRvYy5pbXBsLl9VUkwpCiAgICAgICAgICAgIHx8IGRvYy5iYXNlVVJJIHx8IGRvYy5VUkwpCiAgICAgICAgICAgICAgICB8fCAnJzsKICAgIC8vIHRha2Ugb25seSB0aGUgbGVmdCBzaWRlIGlmIHRoZXJlIGlzIGEgIwogICAgcmV0dXJuIHVybC5zcGxpdCgnIycpWzBdOwogIH0sCiAgcmVzb2x2ZVVybDogZnVuY3Rpb24oYmFzZVVybCwgdXJsKSB7CiAgICBpZiAodGhpcy5pc0Fic1VybCh1cmwpKSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgICByZXR1cm4gdGhpcy5jb21wcmVzc1VybCh0aGlzLnVybFRvUGF0aChiYXNlVXJsKSArIHVybCk7CiAgfSwKICByZXNvbHZlUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKGJhc2VVcmwsIHVybCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwodXJsKSkgewogICAgICByZXR1cm4gdXJsOwogICAgfQogICAgcmV0dXJuIHRoaXMubWFrZURvY3VtZW50UmVsUGF0aCh0aGlzLnJlc29sdmVVcmwoYmFzZVVybCwgdXJsKSk7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24odXJsKSB7CiAgICByZXR1cm4gLyheZGF0YTopfCheaHR0cFtzXT86KXwoXlwvKS8udGVzdCh1cmwpOwogIH0sCiAgdXJsVG9QYXRoOiBmdW5jdGlvbihiYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBiYXNlVXJsLnNwbGl0KCIvIik7CiAgICBwYXJ0cy5wb3AoKTsKICAgIHBhcnRzLnB1c2goJycpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIGNvbXByZXNzVXJsOiBmdW5jdGlvbih1cmwpIHsKICAgIHZhciBzZWFyY2ggPSAnJzsKICAgIHZhciBzZWFyY2hQb3MgPSB1cmwuaW5kZXhPZignPycpOwogICAgLy8gcXVlcnkgc3RyaW5nIGlzIG5vdCBwYXJ0IG9mIHRoZSBwYXRoCiAgICBpZiAoc2VhcmNoUG9zID4gLTEpIHsKICAgICAgc2VhcmNoID0gdXJsLnN1YnN0cmluZyhzZWFyY2hQb3MpOwogICAgICB1cmwgPSB1cmwuc3Vic3RyaW5nKHNlYXJjaFBvcywgMCk7CiAgICB9CiAgICB2YXIgcGFydHMgPSB1cmwuc3BsaXQoJy8nKTsKICAgIGZvciAodmFyIGk9MCwgcDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICBwID0gcGFydHNbaV07CiAgICAgIGlmIChwID09PSAnLi4nKSB7CiAgICAgICAgcGFydHMuc3BsaWNlKGktMSwgMik7CiAgICAgICAgaSAtPSAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMuam9pbignLycpICsgc2VhcmNoOwogIH0sCiAgbWFrZURvY3VtZW50UmVsUGF0aDogZnVuY3Rpb24odXJsKSB7CiAgICAvLyB0ZXN0IHVybCBhZ2FpbnN0IGRvY3VtZW50IHRvIHNlZSBpZiB3ZSBjYW4gY29uc3RydWN0IGEgcmVsYXRpdmUgcGF0aAogICAgcGF0aC51cmxFbHQuaHJlZiA9IHVybDsKICAgIC8vIElFIGRvZXMgbm90IHNldCBob3N0IGlmIHNhbWUgYXMgZG9jdW1lbnQKICAgIGlmICghcGF0aC51cmxFbHQuaG9zdCB8fCAKICAgICAgICAocGF0aC51cmxFbHQuaG9zdCA9PT0gd2luZG93LmxvY2F0aW9uLmhvc3QgJiYKICAgICAgICBwYXRoLnVybEVsdC5wcm90b2NvbCA9PT0gd2luZG93LmxvY2F0aW9uLnByb3RvY29sKSkgewogICAgICByZXR1cm4gdGhpcy5tYWtlUmVsUGF0aChwYXRoLmRvY3VtZW50VVJMLCBwYXRoLnVybEVsdC5ocmVmKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB1cmw7CiAgICB9CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oc291cmNlLCB0YXJnZXQpIHsKICAgIHZhciBzID0gc291cmNlLnNwbGl0KCcvJyk7CiAgICB2YXIgdCA9IHRhcmdldC5zcGxpdCgnLycpOwogICAgd2hpbGUgKHMubGVuZ3RoICYmIHNbMF0gPT09IHRbMF0pewogICAgICBzLnNoaWZ0KCk7CiAgICAgIHQuc2hpZnQoKTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGwgPSBzLmxlbmd0aC0xOyBpIDwgbDsgaSsrKSB7CiAgICAgIHQudW5zaGlmdCgnLi4nKTsKICAgIH0KICAgIHZhciByID0gdC5qb2luKCcvJyk7CiAgICByZXR1cm4gcjsKICB9LAogIHJlc29sdmVQYXRoc0luSFRNTDogZnVuY3Rpb24ocm9vdCwgdXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgcGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHJvb3QpCiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKHJvb3QsIHVybCk7CiAgICBwYXRoLnJlc29sdmVTdHlsZUVsdHMocm9vdCwgdXJsKTsKICAgIC8vIGhhbmRsZSB0ZW1wbGF0ZS5jb250ZW50CiAgICB2YXIgdGVtcGxhdGVzID0gcm9vdC5xdWVyeVNlbGVjdG9yQWxsKCd0ZW1wbGF0ZScpOwogICAgaWYgKHRlbXBsYXRlcykgewogICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgIGlmICh0LmNvbnRlbnQpIHsKICAgICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKHQuY29udGVudCwgdXJsKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0OiBmdW5jdGlvbihzaGVldCkgewogICAgdmFyIGRvY1VybCA9IHBhdGgubm9kZVVybChzaGVldCk7CiAgICBzaGVldC5fX3Jlc291cmNlID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChzaGVldC5fX3Jlc291cmNlLCBkb2NVcmwpOwogIH0sCiAgcmVzb2x2ZVN0eWxlRWx0czogZnVuY3Rpb24ocm9vdCwgdXJsKSB7CiAgICB2YXIgc3R5bGVzID0gcm9vdC5xdWVyeVNlbGVjdG9yQWxsKCdzdHlsZScpOwogICAgaWYgKHN0eWxlcykgewogICAgICBmb3JFYWNoKHN0eWxlcywgZnVuY3Rpb24oc3R5bGUpIHsKICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHBhdGgucmVzb2x2ZUNzc1RleHQoc3R5bGUudGV4dENvbnRlbnQsIHVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGNzc1RleHQsIGJhc2VVcmwpIHsKICAgIHJldHVybiBjc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihtYXRjaCkgewogICAgICAvLyBmaW5kIHRoZSB1cmwgcGF0aCwgaWdub3JlIHF1b3RlcyBpbiB1cmwgc3RyaW5nCiAgICAgIHZhciB1cmxQYXRoID0gbWF0Y2gucmVwbGFjZSgvWyInXS9nLCAiIikuc2xpY2UoNCwgLTEpOwogICAgICB1cmxQYXRoID0gcGF0aC5yZXNvbHZlUmVsYXRpdmVVcmwoYmFzZVVybCwgdXJsUGF0aCk7CiAgICAgIHJldHVybiAidXJsKCIgKyB1cmxQYXRoICsgIikiOwogICAgfSk7CiAgfSwKICByZXNvbHZlQXR0cmlidXRlczogZnVuY3Rpb24ocm9vdCwgdXJsKSB7CiAgICAvLyBzZWFyY2ggZm9yIGF0dHJpYnV0ZXMgdGhhdCBob3N0IHVybHMKICAgIHZhciBub2RlcyA9IHJvb3QgJiYgcm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIHVybCk7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCiAgcmVzb2x2ZU5vZGVBdHRyaWJ1dGVzOiBmdW5jdGlvbihub2RlLCB1cmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBub2RlLmF0dHJpYnV0ZXNbdl07CiAgICAgIGlmIChhdHRyICYmIGF0dHIudmFsdWUgJiYKICAgICAgICAgKGF0dHIudmFsdWUuc2VhcmNoKFVSTF9URU1QTEFURV9TRUFSQ0gpIDwgMCkpIHsKICAgICAgICB2YXIgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVJlbGF0aXZlVXJsKHVybCwgYXR0ci52YWx1ZSk7CiAgICAgICAgYXR0ci52YWx1ZSA9IHVybFBhdGg7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCnBhdGguZG9jdW1lbnRVUkwgPSBwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KTsKcGF0aC51cmxFbHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7Cgp4aHIgPSB4aHIgfHwgewogIGFzeW5jOiB0cnVlLAogIG9rOiBmdW5jdGlvbihyZXF1ZXN0KSB7CiAgICByZXR1cm4gKHJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiByZXF1ZXN0LnN0YXR1cyA8IDMwMCkKICAgICAgICB8fCAocmVxdWVzdC5zdGF0dXMgPT09IDMwNCkKICAgICAgICB8fCAocmVxdWVzdC5zdGF0dXMgPT09IDApOwogIH0sCiAgbG9hZDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGlmIChzY29wZS5mbGFncy5kZWJ1ZyB8fCBzY29wZS5mbGFncy5idXN0KSB7CiAgICAgIHVybCArPSAnPycgKyBNYXRoLnJhbmRvbSgpOwogICAgfQogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHhoci5hc3luYyk7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICBuZXh0LmNhbGwobmV4dENvbnRleHQsICF4aHIub2socmVxdWVzdCkgJiYgcmVxdWVzdCwKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UsIHVybCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVxdWVzdC5zZW5kKCk7CiAgICByZXR1cm4gcmVxdWVzdDsKICB9LAogIGxvYWREb2N1bWVudDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdGhpcy5sb2FkKHVybCwgbmV4dCwgbmV4dENvbnRleHQpLnJlc3BvbnNlVHlwZSA9ICdkb2N1bWVudCc7CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKc2NvcGUucGF0aCA9IHBhdGg7CnNjb3BlLnhociA9IHhocjsKc2NvcGUuaW1wb3J0ZXIgPSBpbXBvcnRlcjsKc2NvcGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwpzY29wZS5JTVBPUlRfTElOS19UWVBFID0gSU1QT1JUX0xJTktfVFlQRTsKCn0pKHdpbmRvdy5IVE1MSW1wb3J0cyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgaW1wb3J0UGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJywKICAgICdzdHlsZScsCiAgICAnc2NyaXB0Om5vdChbdHlwZV0pJywKICAgICdzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0nCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgc2NyaXB0OiAncGFyc2VTY3JpcHQnLAogICAgc3R5bGU6ICdwYXJzZUdlbmVyaWMnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydFBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpbXBvcnRQYXJzZXJbaW1wb3J0UGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24obGlua0VsdCkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGxpbmtFbHQpKSB7CiAgICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgICBpbXBvcnRQYXJzZXIucGFyc2UobGlua0VsdC5jb250ZW50KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJzZUdlbmVyaWMobGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZUdlbmVyaWM6IGZ1bmN0aW9uKGVsdCkgewogICAgaWYgKG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChlbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoZWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihzY3JpcHRFbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoc2NyaXB0RWx0KSkgewogICAgICAvLyBhY3F1aXJlIGNvZGUgdG8gZXhlY3V0ZQogICAgICB2YXIgY29kZSA9IChzY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBzY3JpcHRFbHQudGV4dENvbnRlbnQpLnRyaW0oKTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAvLyBjYWxjdWxhdGUgc291cmNlIG1hcCBoaW50CiAgICAgICAgdmFyIG1vbmlrZXIgPSBzY3JpcHRFbHQuX19ub2RlVXJsOwogICAgICAgIGlmICghbW9uaWtlcikgewogICAgICAgICAgdmFyIG1vbmlrZXIgPSBzY29wZS5wYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoc2NyaXB0RWx0KTsKICAgICAgICAgIC8vIHRoZXJlIGNvdWxkIGJlIG1vcmUgdGhhbiBvbmUgc2NyaXB0IHRoaXMgdXJsCiAgICAgICAgICB2YXIgdGFnID0gJ1snICsgTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSsxKSoxMDAwKSArICddJzsKICAgICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFBvbHltZXIgaGFjaywgc2hvdWxkIGJlIHBsdWdnYWJsZSBpZiB3ZSBuZWVkIHRvIGFsbG93IAogICAgICAgICAgLy8gdGhpcyBzb3J0IG9mIHRoaW5nCiAgICAgICAgICB2YXIgbWF0Y2hlcyA9IGNvZGUubWF0Y2goL1BvbHltZXJcKFsnIl0oW14nIl0qKS8pOwogICAgICAgICAgdGFnID0gbWF0Y2hlcyAmJiBtYXRjaGVzWzFdIHx8IHRhZzsKICAgICAgICAgIC8vIHRhZyB0aGUgbW9uaWtlcgogICAgICAgICAgbW9uaWtlciArPSAnLycgKyB0YWcgKyAnLmpzJzsKICAgICAgICB9CiAgICAgICAgLy8gc291cmNlIG1hcCBoaW50CiAgICAgICAgY29kZSArPSAiXG4vLyMgc291cmNlVVJMPSIgKyBtb25pa2VyICsgIlxuIjsKICAgICAgICAvLyBldmFsdWF0ZSB0aGUgY29kZQogICAgICAgIGV2YWwuY2FsbCh3aW5kb3csIGNvZGUpOwogICAgICB9CiAgICB9CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBlbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRTsKfQoKZnVuY3Rpb24gbmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KG5vZGUpIHsKICAvLyBub2RlcyBjYW4gYmUgbW92ZWQgdG8gdGhlIG1haW4gZG9jdW1lbnQ6CiAgLy8gaWYgdGhleSBhcmUgaW4gYSB0cmVlIGJ1dCBub3QgaW4gdGhlIG1haW4gZG9jdW1lbnQgYW5kIG5vdCBjaGlsZHJlbiBvZiA8ZWxlbWVudD4KICByZXR1cm4gbm9kZS5wYXJlbnROb2RlICYmICFpbk1haW5Eb2N1bWVudChub2RlKSAKICAgICAgJiYgIWlzRWxlbWVudEVsZW1lbnRDaGlsZChub2RlKTsKfQoKZnVuY3Rpb24gaW5NYWluRG9jdW1lbnQoZWx0KSB7CiAgcmV0dXJuIGVsdC5vd25lckRvY3VtZW50ID09PSBkb2N1bWVudCB8fAogICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICBlbHQub3duZXJEb2N1bWVudC5pbXBsID09PSBkb2N1bWVudDsKfQoKZnVuY3Rpb24gaXNFbGVtZW50RWxlbWVudENoaWxkKGVsdCkgewogIHJldHVybiBlbHQucGFyZW50Tm9kZSAmJiBlbHQucGFyZW50Tm9kZS5sb2NhbE5hbWUgPT09ICdlbGVtZW50JzsKfQoKLy8gZXhwb3J0cwoKc2NvcGUucGFyc2VyID0gaW1wb3J0UGFyc2VyOwoKfSkoSFRNTEltcG9ydHMpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcAoKLy8gSUUgc2hpbSBmb3IgQ3VzdG9tRXZlbnQKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gcHJlbG9hZCBkb2N1bWVudCByZXNvdXJjZSB0cmVlcwogIEhUTUxJbXBvcnRzLmltcG9ydGVyLmxvYWQoZG9jdW1lbnQsIGZ1bmN0aW9uKCkgewogICAgSFRNTEltcG9ydHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIEhUTUxJbXBvcnRzLnJlYWR5VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpOwogICAgLy8gc2VuZCBIVE1MSW1wb3J0c0xvYWRlZCB3aGVuIGZpbmlzaGVkCiAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ0hUTUxJbXBvcnRzTG9hZGVkJywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9KTsKfTsKCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgYm9vdHN0cmFwKCk7Cn0gZWxzZSB7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBib290c3RyYXApOwp9Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpIHsKCi8vIGltcG9ydAoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSB3aW5kb3cuSFRNTEltcG9ydHMgPyBIVE1MSW1wb3J0cy5JTVBPUlRfTElOS19UWVBFIDogJ25vbmUnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgcGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9fcGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9fcGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBwYXJzZXJbcGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgICAgLy8gdXBncmFkZSBhbGwgdXBncmFkZWFibGUgc3RhdGljIGVsZW1lbnRzLCBhbnl0aGluZyBkeW5hbWljYWxseQogICAgICAvLyBjcmVhdGVkIHNob3VsZCBiZSBjYXVnaHQgYnkgb2JzZXJ2ZXIKICAgICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgICAvLyBvYnNlcnZlIGRvY3VtZW50IGZvciBkb20gY2hhbmdlcwogICAgICBDdXN0b21FbGVtZW50cy5vYnNlcnZlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIC8vIGltcG9ydHMKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICB0aGlzLnBhcnNlSW1wb3J0KGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VJbXBvcnQ6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgcGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoaW5FbHQpIHsKICByZXR1cm4gKGluRWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGluRWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEUpOwp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpDdXN0b21FbGVtZW50cy5wYXJzZXIgPSBwYXJzZXI7Cgp9KSgpOwovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwooZnVuY3Rpb24oKXsKCi8vIGJvb3RzdHJhcCBwYXJzaW5nCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBwYXJzZSBkb2N1bWVudAogIEN1c3RvbUVsZW1lbnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgLy8gb25lIG1vcmUgcGFzcyBiZWZvcmUgcmVnaXN0ZXIgaXMgJ2xpdmUnCiAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGRvY3VtZW50KTsgIAogIC8vIGNob29zZSBhc3luYwogIHZhciBhc3luYyA9IHdpbmRvdy5QbGF0Zm9ybSAmJiBQbGF0Zm9ybS5lbmRPZk1pY3JvdGFzayA/IAogICAgUGxhdGZvcm0uZW5kT2ZNaWNyb3Rhc2sgOgogICAgc2V0VGltZW91dDsKICBhc3luYyhmdW5jdGlvbigpIHsKICAgIC8vIHNldCBpbnRlcm5hbCAncmVhZHknIGZsYWcsIG5vdyBkb2N1bWVudC5yZWdpc3RlciB3aWxsIHRyaWdnZXIgCiAgICAvLyBzeW5jaHJvbm91cyB1cGdyYWRlcwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHkgPSB0cnVlOwogICAgLy8gY2FwdHVyZSBibHVudCBwcm9maWxpbmcgZGF0YQogICAgQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lID0gRGF0ZS5ub3coKTsKICAgIGlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICAgICAgQ3VzdG9tRWxlbWVudHMuZWxhcHNlZCA9IEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSAtIEhUTUxJbXBvcnRzLnJlYWR5VGltZTsKICAgIH0KICAgIC8vIG5vdGlmeSB0aGUgc3lzdGVtIHRoYXQgd2UgYXJlIGJvb3RzdHJhcHBlZAogICAgZG9jdW1lbnQuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ1dlYkNvbXBvbmVudHNSZWFkeScsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn0KCi8vIEN1c3RvbUV2ZW50IHNoaW0gZm9yIElFCmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICBib290c3RyYXAoKTsKfSBlbHNlIHsKICB2YXIgbG9hZEV2ZW50ID0gd2luZG93LkhUTUxJbXBvcnRzID8gJ0hUTUxJbXBvcnRzTG9hZGVkJyA6ICdET01Db250ZW50TG9hZGVkJzsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihsb2FkRXZlbnQsIGJvb3RzdHJhcCk7Cn0KCn0pKCk7Cg0KKGZ1bmN0aW9uICgpIHsKCi8qKiogVmFyaWFibGVzICoqKi8KCiAgdmFyIHdpbiA9IHdpbmRvdywKICAgIGRvYyA9IGRvY3VtZW50LAogICAgbm9vcCA9IGZ1bmN0aW9uKCl7fSwKICAgIHRydWVvcCA9IGZ1bmN0aW9uKCl7IHJldHVybiB0cnVlOyB9LAogICAgcmVnZXhQc2V1ZG9TcGxpdCA9IC8oW1x3LV0rKD86XChbXlwpXStcKSk/KS9nLAogICAgcmVnZXhQc2V1ZG9SZXBsYWNlID0gLyhcdyopKD86XCgoW15cKV0qKVwpKT8vLAogICAgcmVnZXhEaWdpdHMgPSAvKFxkKykvZywKICAgIGtleXBzZXVkbyA9IHsKICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgIHJldHVybiBwc2V1ZG8udmFsdWUubWF0Y2gocmVnZXhEaWdpdHMpLmluZGV4T2YoU3RyaW5nKGV2ZW50LmtleUNvZGUpKSA+IC0xID09IChwc2V1ZG8ubmFtZSA9PSAna2V5cGFzcycpIHx8IG51bGw7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gJ01TJyA6IHByZSwKICAgICAgICBsb3dlcmNhc2U6IHByZSwKICAgICAgICBjc3M6ICctJyArIHByZSArICctJywKICAgICAgICBqczogcHJlID09ICdtcycgPyBwcmUgOiBwcmVbMF0udG9VcHBlckNhc2UoKSArIHByZS5zdWJzdHIoMSkKICAgICAgfTsKICAgIH0pKCksCiAgICBtYXRjaFNlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlW3ByZWZpeC5sb3dlcmNhc2UgKyAnTWF0Y2hlc1NlbGVjdG9yJ10sCiAgICBtdXRhdGlvbiA9IHdpbi5NdXRhdGlvbk9ic2VydmVyIHx8IHdpbltwcmVmaXguanMgKyAnTXV0YXRpb25PYnNlcnZlciddOwoKLyoqKiBGdW5jdGlvbnMgKioqLwoKLy8gVXRpbGl0aWVzCgogIHZhciB0eXBlQ2FjaGUgPSB7fSwKICAgICAgdHlwZVN0cmluZyA9IHR5cGVDYWNoZS50b1N0cmluZywKICAgICAgdHlwZVJlZ2V4cCA9IC9ccyhbYS16QS1aXSspLzsKICBmdW5jdGlvbiB0eXBlT2Yob2JqKSB7CiAgICB2YXIgdHlwZSA9IHR5cGVTdHJpbmcuY2FsbChvYmopOwogICAgcmV0dXJuIHR5cGVDYWNoZVt0eXBlXSB8fCAodHlwZUNhY2hlW3R5cGVdID0gdHlwZS5tYXRjaCh0eXBlUmVnZXhwKVsxXS50b0xvd2VyQ2FzZSgpKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKGl0ZW0sIHR5cGUpewogICAgdmFyIGZuID0gY2xvbmVbdHlwZSB8fCB0eXBlT2YoaXRlbSldOwogICAgcmV0dXJuIGZuID8gZm4oaXRlbSkgOiBpdGVtOwogIH0KICAgIGNsb25lLm9iamVjdCA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBvYmogPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgb2JqW2tleV0gPSBjbG9uZShzcmNba2V5XSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY2xvbmUuYXJyYXkgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgaSA9IHNyYy5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwogICAgICB3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGNsb25lKHNyY1tpXSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CgogIHZhciB1bnNsaWNlYWJsZSA9IFsndW5kZWZpbmVkJywgJ251bGwnLCAnbnVtYmVyJywgJ2Jvb2xlYW4nLCAnc3RyaW5nJywgJ2Z1bmN0aW9uJ107CiAgZnVuY3Rpb24gdG9BcnJheShvYmopewogICAgcmV0dXJuIHVuc2xpY2VhYmxlLmluZGV4T2YodHlwZU9mKG9iaikpID09IC0xID8KICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG9iaiwgMCkgOgogICAgW29ial07CiAgfQoKLy8gRE9NCgogIHZhciBzdHIgPSAnJzsKICBmdW5jdGlvbiBxdWVyeShlbGVtZW50LCBzZWxlY3Rvcil7CiAgICByZXR1cm4gKHNlbGVjdG9yIHx8IHN0cikubGVuZ3RoID8gdG9BcnJheShlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpKSA6IFtdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKSB7CiAgICB2YXIgZGlmZiA9IHsgYWRkZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVjb3JkKXsKICAgICAgcmVjb3JkLl9tdXRhdGlvbiA9IHRydWU7CiAgICAgIGZvciAodmFyIHogaW4gZGlmZikgewogICAgICAgIHZhciB0eXBlID0gZWxlbWVudC5fcmVjb3Jkc1soeiA9PSAnYWRkZWQnKSA/ICdpbnNlcnRlZCcgOiAncmVtb3ZlZCddLAogICAgICAgICAgbm9kZXMgPSByZWNvcmRbeiArICdOb2RlcyddLCBsZW5ndGggPSBub2Rlcy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGggJiYgZGlmZlt6XS5pbmRleE9mKG5vZGVzW2ldKSA9PSAtMTsgaSsrKXsKICAgICAgICAgIGRpZmZbel0ucHVzaChub2Rlc1tpXSk7CiAgICAgICAgICB0eXBlLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICBmbihub2Rlc1tpXSwgcmVjb3JkKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKLy8gTWl4aW5zCgogIGZ1bmN0aW9uIG1lcmdlT25lKHNvdXJjZSwga2V5LCBjdXJyZW50KXsKICAgIHZhciB0eXBlID0gdHlwZU9mKGN1cnJlbnQpOwogICAgaWYgKHR5cGUgPT0gJ29iamVjdCcgJiYgdHlwZU9mKHNvdXJjZVtrZXldKSA9PSAnb2JqZWN0JykgeHRhZy5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CiAgICBlbHNlIHNvdXJjZVtrZXldID0gY2xvbmUoY3VycmVudCwgdHlwZSk7CiAgICByZXR1cm4gc291cmNlOwogIH0KCiAgZnVuY3Rpb24gd3JhcE1peGluKHRhZywga2V5LCBwc2V1ZG8sIHZhbHVlLCBvcmlnaW5hbCl7CiAgICBpZiAodHlwZW9mIG9yaWdpbmFsW2tleV0gIT0gJ2Z1bmN0aW9uJykgb3JpZ2luYWxba2V5XSA9IHZhbHVlOwogICAgZWxzZSB7CiAgICAgIG9yaWdpbmFsW2tleV0gPSB4dGFnLndyYXAob3JpZ2luYWxba2V5XSwgeHRhZy5hcHBseVBzZXVkb3MocHNldWRvLCB2YWx1ZSwgdGFnLnBzZXVkb3MpKTsKICAgIH0KICB9CgogIHZhciB1bmlxdWVNaXhpbkNvdW50ID0gMDsKICBmdW5jdGlvbiBtZXJnZU1peGluKHRhZywgbWl4aW4sIG9yaWdpbmFsLCBtaXgpIHsKICAgIGlmIChtaXgpIHsKICAgICAgdmFyIHVuaXF1ZXMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBvcmlnaW5hbCkgdW5pcXVlc1t6LnNwbGl0KCc6JylbMF1dID0gejsKICAgICAgZm9yICh6IGluIG1peGluKSB7CiAgICAgICAgd3JhcE1peGluKHRhZywgdW5pcXVlc1t6LnNwbGl0KCc6JylbMF1dIHx8IHosIHosIG1peGluW3pdLCBvcmlnaW5hbCk7CiAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICBmb3IgKHZhciB6eiBpbiBtaXhpbil7CiAgICAgICAgd3JhcE1peGluKHRhZywgenogKyAnOl9fbWl4aW5fXygnICsgKHVuaXF1ZU1peGluQ291bnQrKykgKyAnKScsIHp6LCBtaXhpblt6el0sIG9yaWdpbmFsKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gYXBwbHlNaXhpbnModGFnKSB7CiAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIG1peGluID0geHRhZy5taXhpbnNbbmFtZV07CiAgICAgIGZvciAodmFyIHR5cGUgaW4gbWl4aW4pIHsKICAgICAgICB2YXIgaXRlbSA9IG1peGluW3R5cGVdLAogICAgICAgICAgICBvcmlnaW5hbCA9IHRhZ1t0eXBlXTsKICAgICAgICBpZiAoIW9yaWdpbmFsKSB0YWdbdHlwZV0gPSBpdGVtOwogICAgICAgIGVsc2UgewogICAgICAgICAgc3dpdGNoICh0eXBlKXsKICAgICAgICAgICAgY2FzZSAnYWNjZXNzb3JzJzogY2FzZSAncHJvdG90eXBlJzoKICAgICAgICAgICAgICBmb3IgKHZhciB6IGluIGl0ZW0pIHsKICAgICAgICAgICAgICAgIGlmICghb3JpZ2luYWxbel0pIG9yaWdpbmFsW3pdID0gaXRlbVt6XTsKICAgICAgICAgICAgICAgIGVsc2UgbWVyZ2VNaXhpbih0YWcsIGl0ZW1bel0sIG9yaWdpbmFsW3pdLCB0cnVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6IG1lcmdlTWl4aW4odGFnLCBpdGVtLCBvcmlnaW5hbCwgdHlwZSAhPSAnZXZlbnRzJyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0YWc7CiAgfQoKLy8gRXZlbnRzCgogIGZ1bmN0aW9uIGRlbGVnYXRlQWN0aW9uKHBzZXVkbywgZXZlbnQpIHsKICAgIHZhciBtYXRjaCwgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0OwogICAgaWYgKHh0YWcubWF0Y2hTZWxlY3Rvcih0YXJnZXQsIHBzZXVkby52YWx1ZSkpIG1hdGNoID0gdGFyZ2V0OwogICAgZWxzZSBpZiAoeHRhZy5tYXRjaFNlbGVjdG9yKHRhcmdldCwgcHNldWRvLnZhbHVlICsgJyAqJykpIHsKICAgICAgdmFyIHBhcmVudCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICB3aGlsZSAoIW1hdGNoKSB7CiAgICAgICAgaWYgKHh0YWcubWF0Y2hTZWxlY3RvcihwYXJlbnQsIHBzZXVkby52YWx1ZSkpIG1hdGNoID0gcGFyZW50OwogICAgICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnROb2RlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbWF0Y2ggPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZChtYXRjaCkgOiBudWxsOwogIH0KCiAgZnVuY3Rpb24gdG91Y2hGaWx0ZXIoZXZlbnQpIHsKICAgIGlmIChldmVudC50eXBlLm1hdGNoKCd0b3VjaCcpKXsKICAgICAgZXZlbnQudGFyZ2V0Ll9fdG91Y2hlZF9fID0gdHJ1ZTsKICAgIH0KICAgIGVsc2UgaWYgKGV2ZW50LnRhcmdldC5fX3RvdWNoZWRfXyAmJiBldmVudC50eXBlLm1hdGNoKCdtb3VzZScpKXsKICAgICAgZGVsZXRlIGV2ZW50LnRhcmdldC5fX3RvdWNoZWRfXzsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGbG93RXZlbnQodHlwZSkgewogICAgdmFyIGZsb3cgPSB0eXBlID09ICdvdmVyJzsKICAgIHJldHVybiB7CiAgICAgIGF0dGFjaDogJ092ZXJmbG93RXZlbnQnIGluIHdpbiA/ICdvdmVyZmxvd2NoYW5nZWQnIDogW10sCiAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24gKGV2ZW50LCBjdXN0b20pIHsKICAgICAgICBldmVudC5mbG93ID0gdHlwZTsKICAgICAgICByZXR1cm4gZXZlbnQudHlwZSA9PSAodHlwZSArICdmbG93JykgfHwKICAgICAgICAoKGV2ZW50Lm9yaWVudCA9PT0gMCAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDEgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMiAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdyAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpKTsKICAgICAgfQogICAgfTsKICB9CgogIGZ1bmN0aW9uIHdyaXRlUHJvcGVydHkoa2V5LCBldmVudCwgYmFzZSwgZGVzYyl7CiAgICBpZiAoZGVzYykgZXZlbnRba2V5XSA9IGJhc2Vba2V5XTsKICAgIGVsc2UgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV2ZW50LCBrZXksIHsKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiBiYXNlW2tleV0KICAgIH0pOwogIH0KCiAgdmFyIHNraXBQcm9wcyA9IHt9OwogIGZvciAodmFyIHogaW4gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50JykpIHNraXBQcm9wc1t6XSA9IDE7CiAgZnVuY3Rpb24gaW5oZXJpdEV2ZW50KGV2ZW50LCBiYXNlKXsKICAgIHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihldmVudCwgJ3RhcmdldCcpOwogICAgZm9yICh2YXIgeiBpbiBiYXNlKSB7CiAgICAgIGlmICghc2tpcFByb3BzW3pdKSB3cml0ZVByb3BlcnR5KHosIGV2ZW50LCBiYXNlLCBkZXNjKTsKICAgIH0KICAgIGV2ZW50LmJhc2VFdmVudCA9IGJhc2U7CiAgfQoKLy8gQWNjZXNzb3JzCgogIGZ1bmN0aW9uIGdldEFyZ3MoYXR0ciwgdmFsdWUpewogICAgcmV0dXJuIHsKICAgICAgdmFsdWU6IGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsCiAgICAgIG1ldGhvZDogYXR0ci5ib29sZWFuICYmICF2YWx1ZSA/ICdyZW1vdmVBdHRyaWJ1dGUnIDogJ3NldEF0dHJpYnV0ZScKICAgIH07CiAgfQoKICBmdW5jdGlvbiBtb2RBdHRyKGVsZW1lbnQsIGF0dHIsIG5hbWUsIHZhbHVlKXsKICAgIHZhciBhcmdzID0gZ2V0QXJncyhhdHRyLCB2YWx1ZSk7CiAgICBlbGVtZW50W2FyZ3MubWV0aG9kXShuYW1lLCBhcmdzLnZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHN5bmNBdHRyKGVsZW1lbnQsIGF0dHIsIG5hbWUsIHZhbHVlLCBtZXRob2QpewogICAgdmFyIG5vZGVzID0gYXR0ci5wcm9wZXJ0eSA/IFtlbGVtZW50Lnh0YWdbYXR0ci5wcm9wZXJ0eV1dIDogYXR0ci5zZWxlY3RvciA/IHh0YWcucXVlcnkoZWxlbWVudCwgYXR0ci5zZWxlY3RvcikgOiBbXSwKICAgICAgICBpbmRleCA9IG5vZGVzLmxlbmd0aDsKICAgIHdoaWxlIChpbmRleC0tKSBub2Rlc1tpbmRleF1bbWV0aG9kXShuYW1lLCB2YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVWaWV3KGVsZW1lbnQsIG5hbWUsIHZhbHVlKXsKICAgIGlmIChlbGVtZW50Ll9fdmlld19fKXsKICAgICAgZWxlbWVudC5fX3ZpZXdfXy51cGRhdGVCaW5kaW5nVmFsdWUoZWxlbWVudCwgbmFtZSwgdmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKXsKICAgIHZhciBrZXkgPSB6LnNwbGl0KCc6JyksIHR5cGUgPSBrZXlbMF07CiAgICBpZiAodHlwZSA9PSAnZ2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09ICdzZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHZhciBzZXR0ZXIgPSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy54dGFnLl9za2lwU2V0ID0gdHJ1ZTsKICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIG1vZEF0dHIodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIGlmICh0aGlzLnh0YWcuX3NraXBBdHRyICYmIGF0dHIuc2tpcCkgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyAhIXZhbHVlIDogdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBTZXQ7CiAgICAgIH0gOiBhY2Nlc3Nvclt6XSA/IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfSA6IG51bGwsIHRhZy5wc2V1ZG9zKTsKCiAgICAgIGlmIChhdHRyKSBhdHRyLnNldHRlciA9IHNldHRlcjsKICAgIH0KICAgIGVsc2UgdGFnLnByb3RvdHlwZVtwcm9wXVt6XSA9IGFjY2Vzc29yW3pdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBY2Nlc3Nvcih0YWcsIHByb3ApewogICAgdGFnLnByb3RvdHlwZVtwcm9wXSA9IHt9OwogICAgdmFyIGFjY2Vzc29yID0gdGFnLmFjY2Vzc29yc1twcm9wXSwKICAgICAgICBhdHRyID0gYWNjZXNzb3IuYXR0cmlidXRlLAogICAgICAgIG5hbWUgPSBhdHRyICYmIGF0dHIubmFtZSA/IGF0dHIubmFtZS50b0xvd2VyQ2FzZSgpIDogcHJvcDsKCiAgICBpZiAoYXR0cikgewogICAgICBhdHRyLmtleSA9IHByb3A7CiAgICAgIHRhZy5hdHRyaWJ1dGVzW25hbWVdID0gYXR0cjsKICAgIH0KCiAgICBmb3IgKHZhciB6IGluIGFjY2Vzc29yKSBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQpIHsKICAgICAgICB2YXIgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiA/ICdoYXMnIDogJ2dldCcpICsgJ0F0dHJpYnV0ZSc7CiAgICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXNbbWV0aG9kXShuYW1lKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQpIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0gZnVuY3Rpb24odmFsdWUpewogICAgICAgIG1vZEF0dHIodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9OwogICAgfQogIH0KCiAgdmFyIHJlYWR5VGFncyA9IHt9OwogIGZ1bmN0aW9uIGZpcmVSZWFkeShuYW1lKXsKICAgIHJlYWR5VGFnc1tuYW1lXSA9IChyZWFkeVRhZ3NbbmFtZV0gfHwgW10pLmZpbHRlcihmdW5jdGlvbihvYmopewogICAgICByZXR1cm4gKG9iai50YWdzID0gb2JqLnRhZ3MuZmlsdGVyKGZ1bmN0aW9uKHopewogICAgICAgIHJldHVybiB6ICE9IG5hbWUgJiYgIXh0YWcudGFnc1t6XTsKICAgICAgfSkpLmxlbmd0aCB8fCBvYmouZm4oKTsKICAgIH0pOwogIH0KCi8qKiogWC1UYWcgT2JqZWN0IERlZmluaXRpb24gKioqLwoKICB2YXIgeHRhZyA9IHsKICAgIHRhZ3M6IHt9LAogICAgZGVmYXVsdE9wdGlvbnM6IHsKICAgICAgcHNldWRvczogW10sCiAgICAgIG1peGluczogW10sCiAgICAgIGV2ZW50czoge30sCiAgICAgIG1ldGhvZHM6IHt9LAogICAgICBhY2Nlc3NvcnM6IHt9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWdpc3RlcjogZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIF9uYW1lOwogICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpIHsKICAgICAgICBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIHNhdmUgcHJvdG90eXBlIGZvciBhY3R1YWwgb2JqZWN0IGNyZWF0aW9uIGJlbG93CiAgICAgIHZhciBiYXNlUHJvdG90eXBlID0gb3B0aW9ucy5wcm90b3R5cGU7CiAgICAgIGRlbGV0ZSBvcHRpb25zLnByb3RvdHlwZTsKCiAgICAgIHZhciB0YWcgPSB4dGFnLnRhZ3NbX25hbWVdID0gYXBwbHlNaXhpbnMoeHRhZy5tZXJnZSh7fSwgeHRhZy5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwoKICAgICAgZm9yICh2YXIgeiBpbiB0YWcuZXZlbnRzKSB0YWcuZXZlbnRzW3pdID0geHRhZy5wYXJzZUV2ZW50KHosIHRhZy5ldmVudHNbel0pOwogICAgICBmb3IgKHogaW4gdGFnLmxpZmVjeWNsZSkgdGFnLmxpZmVjeWNsZVt6LnNwbGl0KCc6JylbMF1dID0geHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLmxpZmVjeWNsZVt6XSwgdGFnLnBzZXVkb3MpOwogICAgICBmb3IgKHogaW4gdGFnLm1ldGhvZHMpIHRhZy5wcm90b3R5cGVbei5zcGxpdCgnOicpWzBdXSA9IHsgdmFsdWU6IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5tZXRob2RzW3pdLCB0YWcucHNldWRvcyksIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgZm9yICh6IGluIHRhZy5hY2Nlc3NvcnMpIHBhcnNlQWNjZXNzb3IodGFnLCB6KTsKCiAgICAgIHZhciByZWFkeSA9IHRhZy5saWZlY3ljbGUuY3JlYXRlZCB8fCB0YWcubGlmZWN5Y2xlLnJlYWR5OwogICAgICB0YWcucHJvdG90eXBlLmNyZWF0ZWRDYWxsYmFjayA9IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgeHRhZy5hZGRFdmVudHModGhpcywgdGFnLmV2ZW50cyk7CiAgICAgICAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24obWl4aW4pewogICAgICAgICAgICBpZiAoeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cykgeHRhZy5hZGRFdmVudHMoZWxlbWVudCwgeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBvdXRwdXQgPSByZWFkeSA/IHJlYWR5LmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSkgOiBudWxsOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0YWcuYXR0cmlidXRlcykgewogICAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWVdLAogICAgICAgICAgICAgICAgaGFzQXR0ciA9IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICBpZiAoaGFzQXR0ciB8fCBhdHRyLmJvb2xlYW4pIHsKICAgICAgICAgICAgICB0aGlzW2F0dHIua2V5XSA9IGF0dHIuYm9vbGVhbiA/IGhhc0F0dHIgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFnLnBzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmluc2VydGVkKSB0YWcucHJvdG90eXBlLmVudGVyZWRWaWV3Q2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmluc2VydGVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLnJlbW92ZWQpIHRhZy5wcm90b3R5cGUubGVmdERvY3VtZW50Q2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLnJlbW92ZWQsIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgaWYgKHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCkgdGFnLnByb3RvdHlwZS5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQsIGVudW1lcmFibGU6IHRydWUgfTsKCiAgICAgIHZhciBzZXRBdHRyaWJ1dGUgPSB0YWcucHJvdG90eXBlLnNldEF0dHJpYnV0ZSB8fCBIVE1MRWxlbWVudC5wcm90b3R5cGUuc2V0QXR0cmlidXRlOwogICAgICB0YWcucHJvdG90eXBlLnNldEF0dHJpYnV0ZSA9IHsKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBlbnVtYmVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKXsKICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgIGlmICghdGhpcy54dGFnLl9za2lwQXR0cikgc2V0QXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgYXR0ciAmJiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlKTsKICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgIGlmIChhdHRyLnNldHRlciAmJiAhdGhpcy54dGFnLl9za2lwU2V0KSB7CiAgICAgICAgICAgICAgdGhpcy54dGFnLl9za2lwQXR0ciA9IHRydWU7CiAgICAgICAgICAgICAgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyB0cnVlIDogdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhbHVlID0gYXR0ci5za2lwID8gYXR0ci5ib29sZWFuID8gdGhpcy5oYXNBdHRyaWJ1dGUobmFtZSkgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSA6IHZhbHVlOwogICAgICAgICAgICBzeW5jQXR0cih0aGlzLCBhdHRyLCBuYW1lLCBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLCAnc2V0QXR0cmlidXRlJyk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgcmVtb3ZlQXR0cmlidXRlID0gdGFnLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZTsKICAgICAgdGFnLnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSB7CiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lKXsKICAgICAgICAgIHZhciBhdHRyID0gdGFnLmF0dHJpYnV0ZXNbbmFtZS50b0xvd2VyQ2FzZSgpXTsKICAgICAgICAgIGlmICghdGhpcy54dGFnLl9za2lwQXR0cikgcmVtb3ZlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSk7CiAgICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIgJiYgIXRoaXMueHRhZy5fc2tpcFNldCkgewogICAgICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gZmFsc2UgOiB1bmRlZmluZWQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN5bmNBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIHVuZGVmaW5lZCwgJ3JlbW92ZUF0dHJpYnV0ZScpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIGVsZW1lbnRQcm90byA9IGJhc2VQcm90b3R5cGUgPwogICAgICAgICAgICBiYXNlUHJvdG90eXBlIDoKICAgICAgICAgICAgb3B0aW9uc1snZXh0ZW5kcyddID8KICAgICAgICAgICAgT2JqZWN0LmNyZWF0ZShkb2MuY3JlYXRlRWxlbWVudChvcHRpb25zWydleHRlbmRzJ10pLmNvbnN0cnVjdG9yKS5wcm90b3R5cGUgOgogICAgICAgICAgICB3aW4uSFRNTEVsZW1lbnQucHJvdG90eXBlOwoKICAgICAgdmFyIGRlZmluaXRpb24gPSB7CiAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoZWxlbWVudFByb3RvLCB0YWcucHJvdG90eXBlKQogICAgICB9OwogICAgICBpZiAob3B0aW9uc1snZXh0ZW5kcyddKSB7CiAgICAgICAgZGVmaW5pdGlvblsnZXh0ZW5kcyddID0gb3B0aW9uc1snZXh0ZW5kcyddOwogICAgICB9CiAgICAgIHZhciByZWcgPSBkb2MucmVnaXN0ZXIoX25hbWUsIGRlZmluaXRpb24pOwogICAgICBmaXJlUmVhZHkoX25hbWUpOwogICAgICByZXR1cm4gcmVnOwogICAgfSwKICAgIAogICAgcmVhZHk6IGZ1bmN0aW9uKG5hbWVzLCBmbil7CiAgICAgIHZhciBvYmogPSB7IHRhZ3M6IHRvQXJyYXkobmFtZXMpLCBmbjogZm4gfTsKICAgICAgaWYgKG9iai50YWdzLnJlZHVjZShmdW5jdGlvbihsYXN0LCBuYW1lKXsKICAgICAgICBpZiAoeHRhZy50YWdzW25hbWVdKSByZXR1cm4gbGFzdDsKICAgICAgICAocmVhZHlUYWdzW25hbWVdID0gcmVhZHlUYWdzW25hbWVdIHx8IFtdKS5wdXNoKG9iaik7CiAgICAgIH0sIHRydWUpKSBmbigpOwogICAgfSwKICAgIAogICAgLyogRXhwb3NlZCBWYXJpYWJsZXMgKi8KCiAgICBtaXhpbnM6IHt9LAogICAgcHJlZml4OiBwcmVmaXgsCiAgICBjYXB0dXJlRXZlbnRzOiBbJ2ZvY3VzJywgJ2JsdXInLCAnc2Nyb2xsJywgJ3VuZGVyZmxvdycsICdvdmVyZmxvdycsICdvdmVyZmxvd2NoYW5nZWQnLCAnRE9NTW91c2VTY3JvbGwnXSwKICAgIGN1c3RvbUV2ZW50czogewogICAgICBvdmVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCdvdmVyJyksCiAgICAgIHVuZGVyZmxvdzogY3JlYXRlRmxvd0V2ZW50KCd1bmRlcicpLAogICAgICBhbmltYXRpb25zdGFydDogewogICAgICAgIGF0dGFjaDogW3ByZWZpeC5kb20gKyAnQW5pbWF0aW9uU3RhcnQnXQogICAgICB9LAogICAgICBhbmltYXRpb25lbmQ6IHsKICAgICAgICBhdHRhY2g6IFtwcmVmaXguZG9tICsgJ0FuaW1hdGlvbkVuZCddCiAgICAgIH0sCiAgICAgIHRyYW5zaXRpb25lbmQ6IHsKICAgICAgICBhdHRhY2g6IFtwcmVmaXguZG9tICsgJ1RyYW5zaXRpb25FbmQnXQogICAgICB9LAogICAgICBtb3ZlOiB7CiAgICAgICAgYXR0YWNoOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIGVudGVyOiB7CiAgICAgICAgYXR0YWNoOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICBsZWF2ZTogewogICAgICAgIGF0dGFjaDogWydtb3VzZW91dCcsICd0b3VjaGxlYXZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICBzY3JvbGx3aGVlbDogewogICAgICAgIGF0dGFjaDogWydET01Nb3VzZVNjcm9sbCcsICdtb3VzZXdoZWVsJ10sCiAgICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbihldmVudCl7CiAgICAgICAgICBldmVudC5kZWx0YSA9IGV2ZW50LndoZWVsRGVsdGEgPyBldmVudC53aGVlbERlbHRhIC8gNDAgOiBNYXRoLnJvdW5kKGV2ZW50LmRldGFpbCAvIDMuNSAqIC0xKTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgdGFwc3RhcnQ6IHsKICAgICAgICBvYnNlcnZlOiB7CiAgICAgICAgICBtb3VzZWRvd246IGRvYywKICAgICAgICAgIHRvdWNoc3RhcnQ6IGRvYwogICAgICAgIH0sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbmQ6IHsKICAgICAgICBvYnNlcnZlOiB7CiAgICAgICAgICBtb3VzZXVwOiBkb2MsCiAgICAgICAgICB0b3VjaGVuZDogZG9jCiAgICAgICAgfSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcG1vdmU6IHsKICAgICAgICBhdHRhY2g6IFsndGFwc3RhcnQnLCAnZHJhZ2VuZCcsICd0b3VjaGNhbmNlbCddLAogICAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQsIGN1c3RvbSl7CiAgICAgICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAnbW92ZSc6ICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgY2FzZSAnZHJhZ292ZXInOgogICAgICAgICAgICAgIHZhciBsYXN0ID0gY3VzdG9tLmxhc3REcmFnIHx8IHt9OwogICAgICAgICAgICAgIGN1c3RvbS5sYXN0RHJhZyA9IGV2ZW50OwogICAgICAgICAgICAgIHJldHVybiAobGFzdC5wYWdlWCAhPSBldmVudC5wYWdlWCAmJiBsYXN0LnBhZ2VZICE9IGV2ZW50LnBhZ2VZKSB8fCBudWxsOwogICAgICAgICAgICBjYXNlICd0YXBzdGFydCc6CiAgICAgICAgICAgICAgaWYgKCFjdXN0b20ubW92ZSkgewogICAgICAgICAgICAgICAgY3VzdG9tLmN1cnJlbnQgPSB0aGlzOwogICAgICAgICAgICAgICAgY3VzdG9tLm1vdmUgPSB4dGFnLmFkZEV2ZW50cyh0aGlzLCB7CiAgICAgICAgICAgICAgICAgIG1vdmU6IGN1c3RvbS5saXN0ZW5lciwKICAgICAgICAgICAgICAgICAgZHJhZ292ZXI6IGN1c3RvbS5saXN0ZW5lcgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBjdXN0b20udGFwZW5kID0geHRhZy5hZGRFdmVudChkb2MsICd0YXBlbmQnLCBjdXN0b20ubGlzdGVuZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAndGFwZW5kJzogY2FzZSAnZHJhZ2VuZCc6IGNhc2UgJ3RvdWNoY2FuY2VsJzoKICAgICAgICAgICAgICBpZiAoIWV2ZW50LnRvdWNoZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VzdG9tLm1vdmUpIHh0YWcucmVtb3ZlRXZlbnRzKGN1c3RvbS5jdXJyZW50ICwgY3VzdG9tLm1vdmUgfHwge30pOwogICAgICAgICAgICAgICAgaWYgKGN1c3RvbS50YXBlbmQpIHh0YWcucmVtb3ZlRXZlbnQoZG9jLCBjdXN0b20udGFwZW5kIHx8IHt9KTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjdXN0b20ubGFzdERyYWc7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLnRhcGVuZDsKICAgICAgICAgICAgICAgIGRlbGV0ZSBjdXN0b20ubW92ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcHNldWRvczogewogICAgICBfX21peGluX186IHt9LAogICAgICBrZXlwYXNzOiBrZXlwc2V1ZG8sCiAgICAgIGtleWZhaWw6IGtleXBzZXVkbywKICAgICAgZGVsZWdhdGU6IHsgYWN0aW9uOiBkZWxlZ2F0ZUFjdGlvbiB9LAogICAgICB3aXRoaW46IHsKICAgICAgICBhY3Rpb246IGRlbGVnYXRlQWN0aW9uLAogICAgICAgIG9uQWRkOiBmdW5jdGlvbihwc2V1ZG8pewogICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IHBzZXVkby5zb3VyY2UuY29uZGl0aW9uOwogICAgICAgICAgaWYgKGNvbmRpdGlvbikgcHNldWRvLnNvdXJjZS5jb25kaXRpb24gPSBmdW5jdGlvbihldmVudCwgY3VzdG9tKXsKICAgICAgICAgICAgcmV0dXJuIHh0YWcucXVlcnkodGhpcywgcHNldWRvLnZhbHVlKS5maWx0ZXIoZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUgPT0gZXZlbnQudGFyZ2V0IHx8IG5vZGUuY29udGFpbnMgPyBub2RlLmNvbnRhaW5zKGV2ZW50LnRhcmdldCkgOiBudWxsOwogICAgICAgICAgICB9KVswXSA/IGNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50LCBjdXN0b20pIDogbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmV2ZW50YWJsZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHJldHVybiAhZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyogVVRJTElUSUVTICovCgogICAgY2xvbmU6IGNsb25lLAogICAgdHlwZU9mOiB0eXBlT2YsCiAgICB0b0FycmF5OiB0b0FycmF5LAoKICAgIHdyYXA6IGZ1bmN0aW9uIChvcmlnaW5hbCwgZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG91dHB1dCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgdWlkOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsMTApOwogICAgfSwKCiAgICAvKiBET00gKi8KCiAgICBxdWVyeTogcXVlcnksCgogICAgc2tpcFRyYW5zaXRpb246IGZ1bmN0aW9uKGVsZW1lbnQsIGZuKXsKICAgICAgdmFyIHByb3AgPSBwcmVmaXguanMgKyAnVHJhbnNpdGlvblByb3BlcnR5JzsKICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ25vbmUnOwogICAgICB2YXIgY2FsbGJhY2sgPSBmbigpOwogICAgICByZXR1cm4geHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJyc7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHh0YWcucmVxdWVzdEZyYW1lKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVlc3RGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciByYWYgPSB3aW4ucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgICAgICAgICB3aW5bcHJlZml4Lmxvd2VyY2FzZSArICdSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXSB8fAogICAgICAgICAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsgcmV0dXJuIHJhZihmbik7IH07CiAgICB9KSgpLAoKICAgIGNhbmNlbEZyYW1lOiAoZnVuY3Rpb24oKXsKICAgICAgdmFyIGNhbmNlbCA9IHdpbi5jYW5jZWxBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnQ2FuY2VsQW5pbWF0aW9uRnJhbWUnXSB8fAogICAgICAgICAgICAgICAgICAgd2luLmNsZWFyVGltZW91dDsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGlkKXsgcmV0dXJuIGNhbmNlbChpZCk7IH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyB4dGFnLnVpZCgpLAogICAgICAgIGF0dHIgPSAnIycgKyBndWlkICsgJyA+ICc7CiAgICAgIHNlbGVjdG9yID0gYXR0ciArIChzZWxlY3RvciArICcnKS5yZXBsYWNlKCcsJywgJywnICsgYXR0ciwgJ2cnKTsKICAgICAgdmFyIHJlc3VsdCA9IGVsZW1lbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgaWYgKCFpZCkgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgIHJldHVybiB0b0FycmF5KHJlc3VsdCk7CiAgICB9LAoKICAgIGNyZWF0ZUZyYWdtZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICB2YXIgZGl2ID0gZnJhZy5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudCgnZGl2JykpLAogICAgICAgICAgbm9kZXMgPSB0b0FycmF5KGNvbnRlbnQubm9kZU5hbWUgPyBhcmd1bWVudHMgOiAhKGRpdi5pbm5lckhUTUwgPSBjb250ZW50KSB8fCBkaXYuY2hpbGRyZW4pLAogICAgICAgICAgbGVuZ3RoID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgZnJhZy5pbnNlcnRCZWZvcmUobm9kZXNbaW5kZXgrK10sIGRpdik7CiAgICAgICAgZnJhZy5yZW1vdmVDaGlsZChkaXYpOwogICAgICB9CiAgICAgIHJldHVybiBmcmFnOwogICAgfSwKCiAgICBtYW5pcHVsYXRlOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBuZXh0ID0gZWxlbWVudC5uZXh0U2libGluZywKICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsCiAgICAgICAgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgcmV0dXJuZWQgPSBmbi5jYWxsKGZyYWcuYXBwZW5kQ2hpbGQoZWxlbWVudCksIGZyYWcpIHx8IGVsZW1lbnQ7CiAgICAgIGlmIChuZXh0KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKHJldHVybmVkLCBuZXh0KTsKICAgICAgZWxzZSBwYXJlbnQuYXBwZW5kQ2hpbGQocmV0dXJuZWQpOwogICAgfSwKCiAgICAvKiBQU0VVRE9TICovCgogICAgYXBwbHlQc2V1ZG9zOiBmdW5jdGlvbihrZXksIGZuLCB0YXJnZXQsIHNvdXJjZSkgewogICAgICB2YXIgbGlzdGVuZXIgPSBmbiwKICAgICAgICAgIHBzZXVkb3MgPSB7fTsKICAgICAgaWYgKGtleS5tYXRjaCgnOicpKSB7CiAgICAgICAgdmFyIHNwbGl0ID0ga2V5Lm1hdGNoKHJlZ2V4UHNldWRvU3BsaXQpLAogICAgICAgICAgICBpID0gc3BsaXQubGVuZ3RoOwogICAgICAgIHdoaWxlICgtLWkpIHsKICAgICAgICAgIHNwbGl0W2ldLnJlcGxhY2UocmVnZXhQc2V1ZG9SZXBsYWNlLCBmdW5jdGlvbiAobWF0Y2gsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICgheHRhZy5wc2V1ZG9zW25hbWVdKSB0aHJvdyAicHNldWRvIG5vdCBmb3VuZDogIiArIG5hbWUgKyAiICIgKyBzcGxpdDsKICAgICAgICAgICAgdmFyIHBzZXVkbyA9IHBzZXVkb3NbaV0gPSBPYmplY3QuY3JlYXRlKHh0YWcucHNldWRvc1tuYW1lXSk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ua2V5ID0ga2V5OwogICAgICAgICAgICAgICAgcHNldWRvLm5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgcHNldWRvLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgICAgICBwc2V1ZG9bJ2FyZ3VtZW50cyddID0gKHZhbHVlIHx8ICcnKS5zcGxpdCgnLCcpOwogICAgICAgICAgICAgICAgcHNldWRvLmFjdGlvbiA9IHBzZXVkby5hY3Rpb24gfHwgdHJ1ZW9wOwogICAgICAgICAgICAgICAgcHNldWRvLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICAgICAgdmFyIGxhc3QgPSBsaXN0ZW5lcjsKICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICBvYmogPSB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgc291cmNlOiBzb3VyY2UsCiAgICAgICAgICAgICAgICAgICAgJ2FyZ3VtZW50cyc6IHBzZXVkb1snYXJndW1lbnRzJ10sCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXI6IGxhc3QKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB2YXIgb3V0cHV0ID0gcHNldWRvLmFjdGlvbi5hcHBseSh0aGlzLCBbb2JqXS5jb25jYXQoYXJncykpOwogICAgICAgICAgICAgIGlmIChvdXRwdXQgPT09IG51bGwgfHwgb3V0cHV0ID09PSBmYWxzZSkgcmV0dXJuIG91dHB1dDsKICAgICAgICAgICAgICByZXR1cm4gb2JqLmxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHBzZXVkby5vbkFkZCkgewogICAgICAgICAgICAgIGlmICh0YXJnZXQubm9kZU5hbWUpIHBzZXVkby5vbkFkZC5jYWxsKHRhcmdldCwgcHNldWRvKTsKICAgICAgICAgICAgICBlbHNlIHRhcmdldC5wdXNoKHBzZXVkbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSkgfHwgbGlzdGVuZXI7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbih0YXJnZXQsIHBzZXVkb3MpewogICAgICBwc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBpZiAob2JqLm9uUmVtb3ZlKSBvYmoub25SZW1vdmUuY2FsbCh0YXJnZXQsIG9iaik7CiAgICAgIH0pOwogICAgfSwKCiAgLyoqKiBFdmVudHMgKioqLwoKICAgIHBhcnNlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKSB7CiAgICAgIHZhciBwc2V1ZG9zID0gdHlwZS5zcGxpdCgnOicpLAogICAgICAgICAga2V5ID0gcHNldWRvcy5zaGlmdCgpLAogICAgICAgICAgY3VzdG9tID0geHRhZy5jdXN0b21FdmVudHNba2V5XSwKICAgICAgICAgIGV2ZW50ID0geHRhZy5tZXJnZSh7CiAgICAgICAgICAgIHR5cGU6IGtleSwKICAgICAgICAgICAgc3RhY2s6IG5vb3AsCiAgICAgICAgICAgIGNvbmRpdGlvbjogdHJ1ZW9wLAogICAgICAgICAgICBhdHRhY2g6IFtdLAogICAgICAgICAgICBfYXR0YWNoOiBbXSwKICAgICAgICAgICAgcHNldWRvczogJycsCiAgICAgICAgICAgIF9wc2V1ZG9zOiBbXSwKICAgICAgICAgICAgb25BZGQ6IG5vb3AsCiAgICAgICAgICAgIG9uUmVtb3ZlOiBub29wCiAgICAgICAgICB9LCBjdXN0b20gfHwge30pOwogICAgICBldmVudC5hdHRhY2ggPSB0b0FycmF5KGV2ZW50LmJhc2UgfHwgZXZlbnQuYXR0YWNoKTsKICAgICAgZXZlbnQuY2hhaW4gPSBrZXkgKyAoZXZlbnQucHNldWRvcy5sZW5ndGggPyAnOicgKyBldmVudC5wc2V1ZG9zIDogJycpICsgKHBzZXVkb3MubGVuZ3RoID8gJzonICsgcHNldWRvcy5qb2luKCc6JykgOiAnJyk7CiAgICAgIHZhciBjb25kaXRpb24gPSBldmVudC5jb25kaXRpb247CiAgICAgIGV2ZW50LmNvbmRpdGlvbiA9IGZ1bmN0aW9uKGUpewogICAgICAgIHZhciB0ID0gZS50b3VjaGVzLCB0dCA9IGUudGFyZ2V0VG91Y2hlczsKICAgICAgICByZXR1cm4gY29uZGl0aW9uLmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgIH07CiAgICAgIHZhciBzdGFjayA9IHh0YWcuYXBwbHlQc2V1ZG9zKGV2ZW50LmNoYWluLCBmbiwgZXZlbnQuX3BzZXVkb3MsIGV2ZW50KTsKICAgICAgZXZlbnQuc3RhY2sgPSBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgdCA9IGUudG91Y2hlcywgdHQgPSBlLnRhcmdldFRvdWNoZXM7CiAgICAgICAgdmFyIGRldGFpbCA9IGUuZGV0YWlsIHx8IHt9OwogICAgICAgIGlmICghZGV0YWlsLl9fc3RhY2tfXykgcmV0dXJuIHN0YWNrLmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgZWxzZSBpZiAoZGV0YWlsLl9fc3RhY2tfXyA9PSBzdGFjaykgewogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIGUuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBzdGFjay5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgZXZlbnQubGlzdGVuZXIgPSBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgb3V0cHV0ID0gZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIGFyZ3MuY29uY2F0KFtldmVudF0pKTsKICAgICAgICBpZiAoIW91dHB1dCkgcmV0dXJuIG91dHB1dDsKICAgICAgICBpZiAoZS50eXBlICE9IGtleSkgewogICAgICAgICAgeHRhZy5maXJlRXZlbnQoZS50YXJnZXQsIGtleSwgewogICAgICAgICAgICBiYXNlRXZlbnQ6IGUsCiAgICAgICAgICAgIGRldGFpbDogb3V0cHV0ICE9PSB0cnVlICYmIChvdXRwdXQuX19zdGFja19fID0gc3RhY2spID8gb3V0cHV0IDogeyBfX3N0YWNrX186IHN0YWNrIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIHJldHVybiBldmVudC5zdGFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfTsKICAgICAgZXZlbnQuYXR0YWNoLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgIGV2ZW50Ll9hdHRhY2gucHVzaCh4dGFnLnBhcnNlRXZlbnQobmFtZSwgZXZlbnQubGlzdGVuZXIpKTsKICAgICAgfSk7CiAgICAgIGlmIChjdXN0b20gJiYgY3VzdG9tLm9ic2VydmUgJiYgIWN1c3RvbS5fX29ic2VydmluZ19fKSB7CiAgICAgICAgY3VzdG9tLm9ic2VydmVyID0gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKS5jb25jYXQoW2N1c3RvbV0pKTsKICAgICAgICAgIGlmICghb3V0cHV0KSByZXR1cm4gb3V0cHV0OwogICAgICAgICAgeHRhZy5maXJlRXZlbnQoZS50YXJnZXQsIGtleSwgewogICAgICAgICAgICBiYXNlRXZlbnQ6IGUsCiAgICAgICAgICAgIGRldGFpbDogb3V0cHV0ICE9PSB0cnVlID8gb3V0cHV0IDoge30KICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICAgICAgZm9yICh2YXIgeiBpbiBjdXN0b20ub2JzZXJ2ZSkgeHRhZy5hZGRFdmVudChjdXN0b20ub2JzZXJ2ZVt6XSB8fCBkb2N1bWVudCwgeiwgY3VzdG9tLm9ic2VydmVyLCB0cnVlKTsKICAgICAgICBjdXN0b20uX19vYnNlcnZpbmdfXyA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuLCBjYXB0dXJlKSB7CiAgICAgIHZhciBldmVudCA9ICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgPyB4dGFnLnBhcnNlRXZlbnQodHlwZSwgZm4pIDogZm47CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQuX2F0dGFjaC5mb3JFYWNoKGZ1bmN0aW9uKG9iaikgewogICAgICAgIHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgb2JqLnR5cGUsIG9iaik7CiAgICAgIH0pOwogICAgICBldmVudC5vbkFkZC5jYWxsKGVsZW1lbnQsIGV2ZW50LCBldmVudC5saXN0ZW5lcik7CiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudC50eXBlLCBldmVudC5zdGFjaywgY2FwdHVyZSB8fCB4dGFnLmNhcHR1cmVFdmVudHMuaW5kZXhPZihldmVudC50eXBlKSA+IC0xKTsKICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudHM6IGZ1bmN0aW9uIChlbGVtZW50LCBvYmopIHsKICAgICAgdmFyIGV2ZW50cyA9IHt9OwogICAgICBmb3IgKHZhciB6IGluIG9iaikgewogICAgICAgIGV2ZW50c1t6XSA9IHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgeiwgb2JqW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnRzOwogICAgfSwKCiAgICByZW1vdmVFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGV2ZW50KSB7CiAgICAgIGV2ZW50ID0gZXZlbnQgfHwgdHlwZTsKICAgICAgZXZlbnQub25SZW1vdmUuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICB4dGFnLnJlbW92ZVBzZXVkb3MoZWxlbWVudCwgZXZlbnQuX3BzZXVkb3MpOwogICAgICBldmVudC5fYXR0YWNoLmZvckVhY2goZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgeHRhZy5yZW1vdmVFdmVudChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LnR5cGUsIGV2ZW50LnN0YWNrKTsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihlbGVtZW50LCBvYmopewogICAgICBmb3IgKHZhciB6IGluIG9iaikgeHRhZy5yZW1vdmVFdmVudChlbGVtZW50LCBvYmpbel0pOwogICAgfSwKCiAgICBmaXJlRXZlbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIG9wdGlvbnMsIHdhcm4pewogICAgICB2YXIgZXZlbnQgPSBkb2MuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50Jyk7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBpZiAod2FybikgY29uc29sZS53YXJuKCdmaXJlRXZlbnQgaGFzIGJlZW4gbW9kaWZpZWQnKTsKICAgICAgZXZlbnQuaW5pdEN1c3RvbUV2ZW50KHR5cGUsCiAgICAgICAgb3B0aW9ucy5idWJibGVzICE9PSBmYWxzZSwKICAgICAgICBvcHRpb25zLmNhbmNlbGFibGUgIT09IGZhbHNlLAogICAgICAgIG9wdGlvbnMuZGV0YWlsCiAgICAgICk7CiAgICAgIGlmIChvcHRpb25zLmJhc2VFdmVudCkgaW5oZXJpdEV2ZW50KGV2ZW50LCBvcHRpb25zLmJhc2VFdmVudCk7CiAgICAgIHRyeSB7IGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7IH0KICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ1RoaXMgZXJyb3IgbWF5IGhhdmUgYmVlbiBjYXVzZWQgYnkgYSBjaGFuZ2UgaW4gdGhlIGZpcmVFdmVudCBtZXRob2QnLCBlKTsKICAgICAgfQogICAgfSwKCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICBpZiAoIWVsZW1lbnQuX3JlY29yZHMpIHsKICAgICAgICBlbGVtZW50Ll9yZWNvcmRzID0geyBpbnNlcnRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICAgICAgaWYgKG11dGF0aW9uKXsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyID0gbmV3IG11dGF0aW9uKGZ1bmN0aW9uKG11dGF0aW9ucykgewogICAgICAgICAgICBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICAgICAgc3VidHJlZTogdHJ1ZSwKICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICBhdHRyaWJ1dGVzOiAhdHJ1ZSwKICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIFsnSW5zZXJ0ZWQnLCAnUmVtb3ZlZCddLmZvckVhY2goZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGUnICsgdHlwZSwgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICBldmVudC5fbXV0YXRpb24gPSB0cnVlOwogICAgICAgICAgICBlbGVtZW50Ll9yZWNvcmRzW3R5cGUudG9Mb3dlckNhc2UoKV0uZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgICAgZm4oZXZlbnQudGFyZ2V0LCBldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLmluZGV4T2YoZm4pID09IC0xKSBlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLnB1c2goZm4pOwogICAgfSwKCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICB2YXIgb2JqID0gZWxlbWVudC5fcmVjb3JkczsKICAgICAgaWYgKG9iaiAmJiBmbil7CiAgICAgICAgb2JqW3R5cGVdLnNwbGljZShvYmpbdHlwZV0uaW5kZXhPZihmbiksIDEpOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgb2JqW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0KICAgIAogIH07CgovKioqIFVuaXZlcnNhbCBUb3VjaCAqKiovCgp2YXIgdG91Y2hpbmcgPSBmYWxzZSwKICAgIHRvdWNoVGFyZ2V0ID0gbnVsbDsKCmRvYy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBmdW5jdGlvbihlKXsKICB0b3VjaGluZyA9IHRydWU7CiAgdG91Y2hUYXJnZXQgPSBlLnRhcmdldDsKfSwgdHJ1ZSk7Cgpkb2MuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGZ1bmN0aW9uKCl7CiAgdG91Y2hpbmcgPSBmYWxzZTsKICB0b3VjaFRhcmdldCA9IG51bGw7Cn0sIHRydWUpOwoKZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ2RyYWdlbmQnLCBmdW5jdGlvbigpewogIHRvdWNoaW5nID0gZmFsc2U7CiAgdG91Y2hUYXJnZXQgPSBudWxsOwp9LCB0cnVlKTsKCnZhciBVSUV2ZW50UHJvdG8gPSB7CiAgdG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5fX3RvdWNoZXNfXyB8fAogICAgICAgICh0aGlzLmlkZW50aWZpZXIgPSAwKSB8fAogICAgICAgICh0aGlzLl9fdG91Y2hlc19fID0gdG91Y2hpbmcgPyBbdGhpc10gOiBbXSk7CiAgICB9CiAgfSwKICB0YXJnZXRUb3VjaGVzOiB7CiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLl9fdGFyZ2V0VG91Y2hlc19fIHx8ICh0aGlzLl9fdGFyZ2V0VG91Y2hlc19fID0KICAgICAgICAodG91Y2hpbmcgJiYgdGhpcy5jdXJyZW50VGFyZ2V0ICYmCiAgICAgICAgKHRoaXMuY3VycmVudFRhcmdldCA9PSB0b3VjaFRhcmdldCB8fAogICAgICAgICh0aGlzLmN1cnJlbnRUYXJnZXQuY29udGFpbnMgJiYgdGhpcy5jdXJyZW50VGFyZ2V0LmNvbnRhaW5zKHRvdWNoVGFyZ2V0KSkpKSA/ICh0aGlzLmlkZW50aWZpZXIgPSAwKSB8fCBbdGhpc10gOiBbXSk7CiAgICB9CiAgfSwKICBjaGFuZ2VkVG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5fX2NoYW5nZWRUb3VjaGVzX18gfHwgKHRoaXMuaWRlbnRpZmllciA9IDApIHx8ICh0aGlzLl9fY2hhbmdlZFRvdWNoZXNfXyA9IFt0aGlzXSk7CiAgICB9CiAgfQp9OwoKZm9yICh6IGluIFVJRXZlbnRQcm90byl7CiAgVUlFdmVudC5wcm90b3R5cGVbel0gPSBVSUV2ZW50UHJvdG9bel07CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KFVJRXZlbnQucHJvdG90eXBlLCB6LCBVSUV2ZW50UHJvdG9bel0pOwp9Cgp2YXIgdG91Y2hSZXNldCA9IHsKICAgIHZhbHVlOiBudWxsLAogICAgd3JpdGFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUKICB9LAogIFRvdWNoRXZlbnRQcm90byA9IHsKICAgIHRvdWNoZXM6IHRvdWNoUmVzZXQsCiAgICB0YXJnZXRUb3VjaGVzOiB0b3VjaFJlc2V0LAogICAgY2hhbmdlZFRvdWNoZXM6IHRvdWNoUmVzZXQKICB9OwoKaWYgKHdpbi5Ub3VjaEV2ZW50KSB7CiAgZm9yICh6IGluIFRvdWNoRXZlbnRQcm90bykgewogICAgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZSwgeik7CiAgICBpZiAoZGVzYykgd2luLlRvdWNoRXZlbnQucHJvdG90eXBlW3pdID0gVG91Y2hFdmVudFByb3RvW3pdOwogICAgZWxzZSBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luLlRvdWNoRXZlbnQucHJvdG90eXBlLCB6LCBUb3VjaEV2ZW50UHJvdG9bel0pOwogIH0KfQoKLyoqKiBDdXN0b20gRXZlbnQgRGVmaW5pdGlvbnMgKioqLwoKICBmdW5jdGlvbiBhZGRUYXAoZWwsIHRhcCwgZSl7CiAgICBpZiAoIWVsLl9fdGFwX18pIHsKICAgICAgZWwuX190YXBfXyA9IHsgY2xpY2s6IGUudHlwZSA9PSAnbW91c2Vkb3duJyB9OwogICAgICBpZiAoZWwuX190YXBfXy5jbGljaykgZWwuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0YXAub2JzZXJ2ZXIpOwogICAgICBlbHNlIHsKICAgICAgICBlbC5fX3RhcF9fLnNjcm9sbCA9IHRhcC5vYnNlcnZlci5iaW5kKGVsKTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgZWwuX190YXBfXy5zY3JvbGwsIHRydWUpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRhcC5vYnNlcnZlcik7CiAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGFwLm9ic2VydmVyKTsKICAgICAgfQogICAgfQogICAgaWYgKCFlbC5fX3RhcF9fLmNsaWNrKSB7CiAgICAgIGVsLl9fdGFwX18ueCA9IGUudG91Y2hlc1swXS5wYWdlWDsKICAgICAgZWwuX190YXBfXy55ID0gZS50b3VjaGVzWzBdLnBhZ2VZOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVGFwKGVsLCB0YXApewogICAgaWYgKGVsLl9fdGFwX18pIHsKICAgICAgaWYgKGVsLl9fdGFwX18uY2xpY2spIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGFwLm9ic2VydmVyKTsKICAgICAgZWxzZSB7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGVsLl9fdGFwX18uc2Nyb2xsLCB0cnVlKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRhcC5vYnNlcnZlcik7CiAgICAgIH0KICAgICAgZGVsZXRlIGVsLl9fdGFwX187CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjaGVja1RhcFBvc2l0aW9uKGVsLCB0YXAsIGUpewogICAgdmFyIHRvdWNoID0gZS5jaGFuZ2VkVG91Y2hlc1swXSwKICAgICAgICB0b2wgPSB0YXAuZ2VzdHVyZS50b2xlcmFuY2U7CiAgICBpZiAoCiAgICAgIHRvdWNoLnBhZ2VYIDwgZWwuX190YXBfXy54ICsgdG9sICYmCiAgICAgIHRvdWNoLnBhZ2VYID4gZWwuX190YXBfXy54IC0gdG9sICYmCiAgICAgIHRvdWNoLnBhZ2VZIDwgZWwuX190YXBfXy55ICsgdG9sICYmCiAgICAgIHRvdWNoLnBhZ2VZID4gZWwuX190YXBfXy55IC0gdG9sCiAgICApIHJldHVybiB0cnVlOwogIH0KCiAgeHRhZy5jdXN0b21FdmVudHMudGFwID0gewogICAgb2JzZXJ2ZTogewogICAgICBtb3VzZWRvd246IGRvY3VtZW50LAogICAgICB0b3VjaHN0YXJ0OiBkb2N1bWVudAogICAgfSwKICAgIGdlc3R1cmU6IHsKICAgICAgdG9sZXJhbmNlOiA4CiAgICB9LAogICAgY29uZGl0aW9uOiBmdW5jdGlvbihlLCB0YXApewogICAgICB2YXIgZWwgPSBlLnRhcmdldDsKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICd0b3VjaHN0YXJ0JzoKICAgICAgICAgIGlmIChlbC5fX3RhcF9fICYmIGVsLl9fdGFwX18uY2xpY2spIHJlbW92ZVRhcChlbCwgdGFwKTsKICAgICAgICAgIGFkZFRhcChlbCwgdGFwLCBlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICBjYXNlICdtb3VzZWRvd24nOgogICAgICAgICAgaWYgKCFlbC5fX3RhcF9fKSBhZGRUYXAoZWwsIHRhcCwgZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgY2FzZSAnc2Nyb2xsJzoKICAgICAgICBjYXNlICd0b3VjaGNhbmNlbCc6CiAgICAgICAgICByZW1vdmVUYXAodGhpcywgdGFwKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICBjYXNlICd0b3VjaG1vdmUnOgogICAgICAgIGNhc2UgJ3RvdWNoZW5kJzoKICAgICAgICAgIGlmICh0aGlzLl9fdGFwX18gJiYgIWNoZWNrVGFwUG9zaXRpb24odGhpcywgdGFwLCBlKSkgewogICAgICAgICAgICByZW1vdmVUYXAodGhpcywgdGFwKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGUudHlwZSA9PSAndG91Y2hlbmQnIHx8IG51bGw7CiAgICAgICAgY2FzZSAnY2xpY2snOgogICAgICAgICAgcmVtb3ZlVGFwKHRoaXMsIHRhcCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH07CgogIHdpbi54dGFnID0geHRhZzsKICBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIGRlZmluZSh4dGFnKTsKICAKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTs=",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKCgoKLy8gRE9NVG9rZW5MaXN0IHBvbHlmaWxsIGZpciBJRTkKKGZ1bmN0aW9uICgpIHsKCmlmICh0eXBlb2Ygd2luZG93LkVsZW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8ICJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgcmV0dXJuOwoKdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKICAgIGluZGV4T2YgPSBwcm90b3R5cGUuaW5kZXhPZiwKICAgIHNsaWNlID0gcHJvdG90eXBlLnNsaWNlLAogICAgcHVzaCA9IHByb3RvdHlwZS5wdXNoLAogICAgc3BsaWNlID0gcHJvdG90eXBlLnNwbGljZSwKICAgIGpvaW4gPSBwcm90b3R5cGUuam9pbjsKCmZ1bmN0aW9uIERPTVRva2VuTGlzdChlbCkgewogIHRoaXMuX2VsZW1lbnQgPSBlbDsKICBpZiAoZWwuY2xhc3NOYW1lICE9IHRoaXMuX2NsYXNzQ2FjaGUpIHsKICAgIHRoaXMuX2NsYXNzQ2FjaGUgPSBlbC5jbGFzc05hbWU7CgogICAgaWYgKCF0aGlzLl9jbGFzc0NhY2hlKSByZXR1cm47CgogICAgICAvLyBUaGUgY2xhc3NOYW1lIG5lZWRzIHRvIGJlIHRyaW1tZWQgYW5kIHNwbGl0IG9uIHdoaXRlc3BhY2UKICAgICAgLy8gdG8gcmV0cmlldmUgYSBsaXN0IG9mIGNsYXNzZXMuCiAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5fY2xhc3NDYWNoZS5yZXBsYWNlKC9eXHMrfFxzKyQvZywnJykuc3BsaXQoL1xzKy8pLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICBwdXNoLmNhbGwodGhpcywgY2xhc3Nlc1tpXSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gc2V0VG9DbGFzc05hbWUoZWwsIGNsYXNzZXMpIHsKICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKfQoKRE9NVG9rZW5MaXN0LnByb3RvdHlwZSA9IHsKICBhZGQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICBpZih0aGlzLmNvbnRhaW5zKHRva2VuKSkgcmV0dXJuOwogICAgcHVzaC5jYWxsKHRoaXMsIHRva2VuKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgY29udGFpbnM6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKSAhPT0gLTE7CiAgfSwKICBpdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgcmV0dXJuIHRoaXNbaW5kZXhdIHx8IG51bGw7CiAgfSwKICByZW1vdmU6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICB2YXIgaSA9IGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbik7CiAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICByZXR1cm47CiAgICAgfQogICAgc3BsaWNlLmNhbGwodGhpcywgaSwgMSk7CiAgICBzZXRUb0NsYXNzTmFtZSh0aGlzLl9lbGVtZW50LCBzbGljZS5jYWxsKHRoaXMsIDApKTsKICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBqb2luLmNhbGwodGhpcywgJyAnKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmIChpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pID09PSAtMSkgewogICAgICB0aGlzLmFkZCh0b2tlbik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlbW92ZSh0b2tlbik7CiAgICB9CiAgfQp9OwoKd2luZG93LkRPTVRva2VuTGlzdCA9IERPTVRva2VuTGlzdDsKCmZ1bmN0aW9uIGRlZmluZUVsZW1lbnRHZXR0ZXIgKG9iaiwgcHJvcCwgZ2V0dGVyKSB7CiAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCx7CiAgICAgIGdldCA6IGdldHRlcgogICAgfSkKICB9IGVsc2UgewogICAgb2JqLl9fZGVmaW5lR2V0dGVyX18ocHJvcCwgZ2V0dGVyKTsKICB9Cn0KCmRlZmluZUVsZW1lbnRHZXR0ZXIoRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIG5ldyBET01Ub2tlbkxpc3QodGhpcyk7Cn0pOwoKfSkoKTsKCgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKaWYgKHR5cGVvZiBXZWFrTWFwID09PSAndW5kZWZpbmVkJykgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gRGF0ZS5ub3coKSAlIDFlOTsKCiAgICB2YXIgV2Vha01hcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFdlYWtNYXAucHJvdG90eXBlID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICB2YXIgZW50cnkgPSBrZXlbdGhpcy5uYW1lXTsKICAgICAgICBpZiAoZW50cnkgJiYgZW50cnlbMF0gPT09IGtleSkKICAgICAgICAgIGVudHJ5WzFdID0gdmFsdWU7CiAgICAgICAgZWxzZQogICAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogW2tleSwgdmFsdWVdLCB3cml0YWJsZTogdHJ1ZX0pOwogICAgICB9LAogICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBlbnRyeTsKICAgICAgICByZXR1cm4gKGVudHJ5ID0ga2V5W3RoaXMubmFtZV0pICYmIGVudHJ5WzBdID09PSBrZXkgPwogICAgICAgICAgICBlbnRyeVsxXSA6IHVuZGVmaW5lZDsKICAgICAgfSwKICAgICAgZGVsZXRlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB0aGlzLnNldChrZXksIHVuZGVmaW5lZCk7CiAgICAgIH0KICAgIH07CgogICAgd2luZG93LldlYWtNYXAgPSBXZWFrTWFwOwogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gU2lkZVRhYmxlIGlzIGEgd2VhayBtYXAgd2hlcmUgcG9zc2libGUuIElmIFdlYWtNYXAgaXMgbm90IGF2YWlsYWJsZSB0aGUKLy8gYXNzb2NpYXRpb24gaXMgc3RvcmVkIGFzIGFuIGV4cGFuZG8gcHJvcGVydHkuCnZhciBTaWRlVGFibGU7Ci8vIFRPRE8oYXJ2KTogV2Vha01hcCBkb2VzIG5vdCBhbGxvdyBmb3IgTm9kZSBldGMgdG8gYmUga2V5cyBpbiBGaXJlZm94CmlmICh0eXBlb2YgV2Vha01hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94LycpIDwgMCkgewogIFNpZGVUYWJsZSA9IFdlYWtNYXA7Cn0gZWxzZSB7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIGNvdW50ZXIgPSBEYXRlLm5vdygpICUgMWU5OwoKICAgIFNpZGVUYWJsZSA9IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5hbWUgPSAnX19zdCcgKyAoTWF0aC5yYW5kb20oKSAqIDFlOSA+Pj4gMCkgKyAoY291bnRlcisrICsgJ19fJyk7CiAgICB9OwoKICAgIFNpZGVUYWJsZS5wcm90b3R5cGUgPSB7CiAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHZhciBlbnRyeSA9IGtleVt0aGlzLm5hbWVdOwogICAgICAgIGlmIChlbnRyeSAmJiBlbnRyeVswXSA9PT0ga2V5KQogICAgICAgICAgZW50cnlbMV0gPSB2YWx1ZTsKICAgICAgICBlbHNlCiAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShrZXksIHRoaXMubmFtZSwge3ZhbHVlOiBba2V5LCB2YWx1ZV0sIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdmFyIGVudHJ5OwogICAgICAgIHJldHVybiAoZW50cnkgPSBrZXlbdGhpcy5uYW1lXSkgJiYgZW50cnlbMF0gPT09IGtleSA/CiAgICAgICAgICAgIGVudHJ5WzFdIDogdW5kZWZpbmVkOwogICAgICB9LAogICAgICBkZWxldGU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgIHRoaXMuc2V0KGtleSwgdW5kZWZpbmVkKTsKICAgICAgfQogICAgfQogIH0pKCk7Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKGdsb2JhbCkgewoKICB2YXIgcmVnaXN0cmF0aW9uc1RhYmxlID0gbmV3IFNpZGVUYWJsZSgpOwoKICAvLyBXZSB1c2Ugc2V0SW1tZWRpYXRlIG9yIHBvc3RNZXNzYWdlIGZvciBvdXIgZnV0dXJlIGNhbGxiYWNrLgogIHZhciBzZXRJbW1lZGlhdGUgPSB3aW5kb3cubXNTZXRJbW1lZGlhdGU7CgogIC8vIFVzZSBwb3N0IG1lc3NhZ2UgdG8gZW11bGF0ZSBzZXRJbW1lZGlhdGUuCiAgaWYgKCFzZXRJbW1lZGlhdGUpIHsKICAgIHZhciBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgdmFyIHNlbnRpbmVsID0gU3RyaW5nKE1hdGgucmFuZG9tKCkpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChlLmRhdGEgPT09IHNlbnRpbmVsKSB7CiAgICAgICAgdmFyIHF1ZXVlID0gc2V0SW1tZWRpYXRlUXVldWU7CiAgICAgICAgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgICAgICBxdWV1ZS5mb3JFYWNoKGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICAgIGZ1bmMoKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICBzZXRJbW1lZGlhdGUgPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgIHNldEltbWVkaWF0ZVF1ZXVlLnB1c2goZnVuYyk7CiAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZShzZW50aW5lbCwgJyonKTsKICAgIH07CiAgfQoKICAvLyBUaGlzIGlzIHVzZWQgdG8gZW5zdXJlIHRoYXQgd2UgbmV2ZXIgc2NoZWR1bGUgMiBjYWxsYXMgdG8gc2V0SW1tZWRpYXRlCiAgdmFyIGlzU2NoZWR1bGVkID0gZmFsc2U7CgogIC8vIEtlZXAgdHJhY2sgb2Ygb2JzZXJ2ZXJzIHRoYXQgbmVlZHMgdG8gYmUgbm90aWZpZWQgbmV4dCB0aW1lLgogIHZhciBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKCiAgLyoqCiAgICogU2NoZWR1bGVzIHxkaXNwYXRjaENhbGxiYWNrfCB0byBiZSBjYWxsZWQgaW4gdGhlIGZ1dHVyZS4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICovCiAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFjayhvYnNlcnZlcikgewogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzLnB1c2gob2JzZXJ2ZXIpOwogICAgaWYgKCFpc1NjaGVkdWxlZCkgewogICAgICBpc1NjaGVkdWxlZCA9IHRydWU7CiAgICAgIHNldEltbWVkaWF0ZShkaXNwYXRjaENhbGxiYWNrcyk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB3cmFwSWZOZWVkZWQobm9kZSkgewogICAgcmV0dXJuIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbCAmJgogICAgICAgIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbC53cmFwSWZOZWVkZWQobm9kZSkgfHwKICAgICAgICBub2RlOwogIH0KCiAgZnVuY3Rpb24gZGlzcGF0Y2hDYWxsYmFja3MoKSB7CiAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jbXV0YXRpb24tb2JzZXJ2ZXJzCgogICAgaXNTY2hlZHVsZWQgPSBmYWxzZTsgLy8gVXNlZCB0byBhbGxvdyBhIG5ldyBzZXRJbW1lZGlhdGUgY2FsbCBhYm92ZS4KCiAgICB2YXIgb2JzZXJ2ZXJzID0gc2NoZWR1bGVkT2JzZXJ2ZXJzOwogICAgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CiAgICAvLyBTb3J0IG9ic2VydmVycyBiYXNlZCBvbiB0aGVpciBjcmVhdGlvbiBVSUQgKGluY3JlbWVudGFsKS4KICAgIG9ic2VydmVycy5zb3J0KGZ1bmN0aW9uKG8xLCBvMikgewogICAgICByZXR1cm4gbzEudWlkXyAtIG8yLnVpZF87CiAgICB9KTsKCiAgICB2YXIgYW55Tm9uRW1wdHkgPSBmYWxzZTsKICAgIG9ic2VydmVycy5mb3JFYWNoKGZ1bmN0aW9uKG9ic2VydmVyKSB7CgogICAgICAvLyAyLjEsIDIuMgogICAgICB2YXIgcXVldWUgPSBvYnNlcnZlci50YWtlUmVjb3JkcygpOwogICAgICAvLyAyLjMuIFJlbW92ZSBhbGwgdHJhbnNpZW50IHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIHdob3NlIG9ic2VydmVyIGlzIG1vLgogICAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpOwoKICAgICAgLy8gMi40CiAgICAgIGlmIChxdWV1ZS5sZW5ndGgpIHsKICAgICAgICBvYnNlcnZlci5jYWxsYmFja18ocXVldWUsIG9ic2VydmVyKTsKICAgICAgICBhbnlOb25FbXB0eSA9IHRydWU7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIDMuCiAgICBpZiAoYW55Tm9uRW1wdHkpCiAgICAgIGRpc3BhdGNoQ2FsbGJhY2tzKCk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnNGb3Iob2JzZXJ2ZXIpIHsKICAgIG9ic2VydmVyLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmV0dXJuOwogICAgICByZWdpc3RyYXRpb25zLmZvckVhY2goZnVuY3Rpb24ocmVnaXN0cmF0aW9uKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gb2JzZXJ2ZXIpCiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzKCk7CiAgICAgIH0pOwogICAgfSk7CiAgfQoKICAvKioKICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgZm9yIHRoZSAiRm9yIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aAogICAqIG9ic2VydmVyJ3Mgb3B0aW9ucyBhcyBvcHRpb25zKSBpbiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLAogICAqIHJ1biB0aGVzZSBzdWJzdGVwczoiIGFuZCB0aGUgIkZvciBlYWNoIGFuY2VzdG9yIGFuY2VzdG9yIG9mIHRhcmdldCwgYW5kIGZvcgogICAqIGVhY2ggcmVnaXN0ZXJlZCBvYnNlcnZlciBvYnNlcnZlciAod2l0aCBvcHRpb25zIG9wdGlvbnMpIGluIGFuY2VzdG9yJ3MgbGlzdAogICAqIG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzLCBydW4gdGhlc2Ugc3Vic3RlcHM6IiBwYXJ0IG9mIHRoZSBhbGdvcml0aG1zLiBUaGUKICAgKiB8b3B0aW9ucy5zdWJ0cmVlfCBpcyBjaGVja2VkIHRvIGVuc3VyZSB0aGF0IHRoZSBjYWxsYmFjayBpcyBjYWxsZWQKICAgKiBjb3JyZWN0bHkuCiAgICoKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7ZnVuY3Rpb24oTXV0YXRpb25PYnNlcnZlckluaXQpOk11dGF0aW9uUmVjb3JkfSBjYWxsYmFjawogICAqLwogIGZ1bmN0aW9uIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGNhbGxiYWNrKSB7CiAgICBmb3IgKHZhciBub2RlID0gdGFyZ2V0OyBub2RlOyBub2RlID0gbm9kZS5wYXJlbnROb2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKCiAgICAgIGlmIChyZWdpc3RyYXRpb25zKSB7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tqXTsKICAgICAgICAgIHZhciBvcHRpb25zID0gcmVnaXN0cmF0aW9uLm9wdGlvbnM7CgogICAgICAgICAgLy8gT25seSB0YXJnZXQgaWdub3JlcyBzdWJ0cmVlLgogICAgICAgICAgaWYgKG5vZGUgIT09IHRhcmdldCAmJiAhb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgICB2YXIgcmVjb3JkID0gY2FsbGJhY2sob3B0aW9ucyk7CiAgICAgICAgICBpZiAocmVjb3JkKQogICAgICAgICAgICByZWdpc3RyYXRpb24uZW5xdWV1ZShyZWNvcmQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgdmFyIHVpZENvdW50ZXIgPSAwOwoKICAvKioKICAgKiBUaGUgY2xhc3MgdGhhdCBtYXBzIHRvIHRoZSBET00gTXV0YXRpb25PYnNlcnZlciBpbnRlcmZhY2UuCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2suCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gSnNNdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNhbGxiYWNrXyA9IGNhbGxiYWNrOwogICAgdGhpcy5ub2Rlc18gPSBbXTsKICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIHRoaXMudWlkXyA9ICsrdWlkQ291bnRlcjsKICB9CgogIEpzTXV0YXRpb25PYnNlcnZlci5wcm90b3R5cGUgPSB7CiAgICBvYnNlcnZlOiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMpIHsKICAgICAgdGFyZ2V0ID0gd3JhcElmTmVlZGVkKHRhcmdldCk7CgogICAgICAvLyAxLjEKICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEgfHwKCiAgICAgICAgICAvLyAxLjIKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuMwogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgIW9wdGlvbnMuYXR0cmlidXRlcyB8fAoKICAgICAgICAgIC8vIDEuNAogICAgICAgICAgb3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkgewoKICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoKTsKICAgICAgfQoKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KHRhcmdldCk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KHRhcmdldCwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIDIKICAgICAgLy8gSWYgdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycyBhbHJlYWR5IGluY2x1ZGVzIGEgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0LCByZXBsYWNlIHRoYXQgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcidzIG9wdGlvbnMgd2l0aCBvcHRpb25zLgogICAgICB2YXIgcmVnaXN0cmF0aW9uOwogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXS5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5vcHRpb25zID0gb3B0aW9uczsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gMy4KICAgICAgLy8gT3RoZXJ3aXNlLCBhZGQgYSBuZXcgcmVnaXN0ZXJlZCBvYnNlcnZlciB0byB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXJzIHdpdGggdGhlIGNvbnRleHQgb2JqZWN0IGFzIHRoZSBvYnNlcnZlciBhbmQgb3B0aW9ucyBhcyB0aGUKICAgICAgLy8gb3B0aW9ucywgYW5kIGFkZCB0YXJnZXQgdG8gY29udGV4dCBvYmplY3QncyBsaXN0IG9mIG5vZGVzIG9uIHdoaWNoIGl0CiAgICAgIC8vIGlzIHJlZ2lzdGVyZWQuCiAgICAgIGlmICghcmVnaXN0cmF0aW9uKSB7CiAgICAgICAgcmVnaXN0cmF0aW9uID0gbmV3IFJlZ2lzdHJhdGlvbih0aGlzLCB0YXJnZXQsIG9wdGlvbnMpOwogICAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaChyZWdpc3RyYXRpb24pOwogICAgICAgIHRoaXMubm9kZXNfLnB1c2godGFyZ2V0KTsKICAgICAgfQoKICAgICAgcmVnaXN0cmF0aW9uLmFkZExpc3RlbmVycygpOwogICAgfSwKCiAgICBkaXNjb25uZWN0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVMaXN0ZW5lcnMoKTsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB9LAoKICAgIHRha2VSZWNvcmRzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvcHlPZlJlY29yZHMgPSB0aGlzLnJlY29yZHNfOwogICAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICAgIHJldHVybiBjb3B5T2ZSZWNvcmRzOwogICAgfQogIH07CgogIC8qKgogICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMuYWRkZWROb2RlcyA9IFtdOwogICAgdGhpcy5yZW1vdmVkTm9kZXMgPSBbXTsKICAgIHRoaXMucHJldmlvdXNTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMubmV4dFNpYmxpbmcgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZXNwYWNlID0gbnVsbDsKICAgIHRoaXMub2xkVmFsdWUgPSBudWxsOwogIH0KCiAgZnVuY3Rpb24gY29weU11dGF0aW9uUmVjb3JkKG9yaWdpbmFsKSB7CiAgICB2YXIgcmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKG9yaWdpbmFsLnR5cGUsIG9yaWdpbmFsLnRhcmdldCk7CiAgICByZWNvcmQuYWRkZWROb2RlcyA9IG9yaWdpbmFsLmFkZGVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSBvcmlnaW5hbC5yZW1vdmVkTm9kZXMuc2xpY2UoKTsKICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBvcmlnaW5hbC5wcmV2aW91c1NpYmxpbmc7CiAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBvcmlnaW5hbC5uZXh0U2libGluZzsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZTsKICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICByZWNvcmQub2xkVmFsdWUgPSBvcmlnaW5hbC5vbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmQ7CiAgfTsKCiAgLy8gV2Uga2VlcCB0cmFjayBvZiB0aGUgdHdvIChwb3NzaWJseSBvbmUpIHJlY29yZHMgdXNlZCBpbiBhIHNpbmdsZSBtdXRhdGlvbi4KICB2YXIgY3VycmVudFJlY29yZCwgcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAvKioKICAgKiBDcmVhdGVzIGEgcmVjb3JkIHdpdGhvdXQgfG9sZFZhbHVlfCBhbmQgY2FjaGVzIGl0IGFzIHxjdXJyZW50UmVjb3JkfCBmb3IKICAgKiBsYXRlciB1c2UuCiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgcmV0dXJuIGN1cnJlbnRSZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KTsKICB9CgogIC8qKgogICAqIEdldHMgb3IgY3JlYXRlcyBhIHJlY29yZCB3aXRoIHxvbGRWYWx1ZXwgYmFzZWQgaW4gdGhlIHxjdXJyZW50UmVjb3JkfAogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSkgewogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZSA9IGNvcHlNdXRhdGlvblJlY29yZChjdXJyZW50UmVjb3JkKTsKICAgIHJlY29yZFdpdGhPbGRWYWx1ZS5vbGRWYWx1ZSA9IG9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKICB9CgogIGZ1bmN0aW9uIGNsZWFyUmVjb3JkcygpIHsKICAgIGN1cnJlbnRSZWNvcmQgPSByZWNvcmRXaXRoT2xkVmFsdWUgPSB1bmRlZmluZWQ7CiAgfQoKICAvKioKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSByZWNvcmQKICAgKiBAcmV0dXJuIHtib29sZWFufSBXaGV0aGVyIHRoZSByZWNvcmQgcmVwcmVzZW50cyBhIHJlY29yZCBmcm9tIHRoZSBjdXJyZW50CiAgICogbXV0YXRpb24gZXZlbnQuCiAgICovCiAgZnVuY3Rpb24gcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihyZWNvcmQpIHsKICAgIHJldHVybiByZWNvcmQgPT09IHJlY29yZFdpdGhPbGRWYWx1ZSB8fCByZWNvcmQgPT09IGN1cnJlbnRSZWNvcmQ7CiAgfQoKICAvKioKICAgKiBTZWxlY3RzIHdoaWNoIHJlY29yZCwgaWYgYW55LCB0byByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCBpbiB0aGUgcXVldWUuCiAgICogVGhpcyByZXR1cm5zIHxudWxsfCBpZiBubyByZWNvcmQgc2hvdWxkIGJlIHJlcGxhY2VkLgogICAqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbGFzdFJlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IG5ld1JlY29yZAogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIG5ld1JlY29yZCkgewogICAgaWYgKGxhc3RSZWNvcmQgPT09IG5ld1JlY29yZCkKICAgICAgcmV0dXJuIGxhc3RSZWNvcmQ7CgogICAgLy8gQ2hlY2sgaWYgdGhlIHRoZSByZWNvcmQgd2UgYXJlIGFkZGluZyByZXByZXNlbnRzIHRoZSBzYW1lIHJlY29yZC4gSWYKICAgIC8vIHNvLCB3ZSBrZWVwIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUgaW4gaXQuCiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlICYmIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24obGFzdFJlY29yZCkpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CgogICAgcmV0dXJuIG51bGw7CiAgfQoKICAvKioKICAgKiBDbGFzcyB1c2VkIHRvIHJlcHJlc2VudCBhIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVySW5pdH0gb3B0aW9ucwogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFJlZ2lzdHJhdGlvbihvYnNlcnZlciwgdGFyZ2V0LCBvcHRpb25zKSB7CiAgICB0aGlzLm9ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICB0aGlzLnRhcmdldCA9IHRhcmdldDsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKICB9CgogIFJlZ2lzdHJhdGlvbi5wcm90b3R5cGUgPSB7CiAgICBlbnF1ZXVlOiBmdW5jdGlvbihyZWNvcmQpIHsKICAgICAgdmFyIHJlY29yZHMgPSB0aGlzLm9ic2VydmVyLnJlY29yZHNfOwogICAgICB2YXIgbGVuZ3RoID0gcmVjb3Jkcy5sZW5ndGg7CgogICAgICAvLyBUaGVyZSBhcmUgY2FzZXMgd2hlcmUgd2UgcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgd2l0aCB0aGUgbmV3IHJlY29yZC4KICAgICAgLy8gRm9yIGV4YW1wbGUgaWYgdGhlIHJlY29yZCByZXByZXNlbnRzIHRoZSBzYW1lIG11dGF0aW9uIHdlIG5lZWQgdG8gdXNlCiAgICAgIC8vIHRoZSBvbmUgd2l0aCB0aGUgb2xkVmFsdWUuIElmIHdlIGdldCBzYW1lIHJlY29yZCAodGhpcyBjYW4gaGFwcGVuIGFzIHdlCiAgICAgIC8vIHdhbGsgdXAgdGhlIHRyZWUpIHdlIGlnbm9yZSB0aGUgbmV3IHJlY29yZC4KICAgICAgaWYgKHJlY29yZHMubGVuZ3RoID4gMCkgewogICAgICAgIHZhciBsYXN0UmVjb3JkID0gcmVjb3Jkc1tsZW5ndGggLSAxXTsKICAgICAgICB2YXIgcmVjb3JkVG9SZXBsYWNlTGFzdCA9IHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCByZWNvcmQpOwogICAgICAgIGlmIChyZWNvcmRUb1JlcGxhY2VMYXN0KSB7CiAgICAgICAgICByZWNvcmRzW2xlbmd0aCAtIDFdID0gcmVjb3JkVG9SZXBsYWNlTGFzdDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2NoZWR1bGVDYWxsYmFjayh0aGlzLm9ic2VydmVyKTsKICAgICAgfQoKICAgICAgcmVjb3Jkc1tsZW5ndGhdID0gcmVjb3JkOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmFkZExpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICBhZGRMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18odGhpcy50YXJnZXQpOwogICAgfSwKCiAgICByZW1vdmVMaXN0ZW5lcnNfOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQXR0ck1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlSW5zZXJ0ZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCB8fCBvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01Ob2RlUmVtb3ZlZCcsIHRoaXMsIHRydWUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFkZHMgYSB0cmFuc2llbnQgb2JzZXJ2ZXIgb24gbm9kZS4gVGhlIHRyYW5zaWVudCBvYnNlcnZlciBnZXRzIHJlbW92ZWQKICAgICAqIG5leHQgdGltZSB3ZSBkZWxpdmVyIHRoZSBjaGFuZ2UgcmVjb3Jkcy4KICAgICAqIEBwYXJhbSB7Tm9kZX0gbm9kZQogICAgICovCiAgICBhZGRUcmFuc2llbnRPYnNlcnZlcjogZnVuY3Rpb24obm9kZSkgewogICAgICAvLyBEb24ndCBhZGQgdHJhbnNpZW50IG9ic2VydmVycyBvbiB0aGUgdGFyZ2V0IGl0c2VsZi4gV2UgYWxyZWFkeSBoYXZlIGFsbAogICAgICAvLyB0aGUgcmVxdWlyZWQgbGlzdGVuZXJzIHNldCB1cCBvbiB0aGUgdGFyZ2V0LgogICAgICBpZiAobm9kZSA9PT0gdGhpcy50YXJnZXQpCiAgICAgICAgcmV0dXJuOwoKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKG5vZGUpOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMucHVzaChub2RlKTsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldChub2RlLCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gV2Uga25vdyB0aGF0IHJlZ2lzdHJhdGlvbnMgZG9lcyBub3QgY29udGFpbiB0aGlzIGJlY2F1c2Ugd2UgYWxyZWFkeQogICAgICAvLyBjaGVja2VkIGlmIG5vZGUgPT09IHRoaXMudGFyZ2V0LgogICAgICByZWdpc3RyYXRpb25zLnB1c2godGhpcyk7CiAgICB9LAoKICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzOwogICAgICB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSBbXTsKCiAgICAgIHRyYW5zaWVudE9ic2VydmVkTm9kZXMuZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgICAgLy8gVHJhbnNpZW50IG9ic2VydmVycyBhcmUgbmV2ZXIgYWRkZWQgdG8gdGhlIHRhcmdldC4KICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyc18obm9kZSk7CgogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldID09PSB0aGlzKSB7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uKGUpIHsKICAgICAgLy8gU3RvcCBwcm9wYWdhdGlvbiBzaW5jZSB3ZSBhcmUgbWFuYWdpbmcgdGhlIHByb3BhZ2F0aW9uIG1hbnVhbGx5LgogICAgICAvLyBUaGlzIG1lYW5zIHRoYXQgb3RoZXIgbXV0YXRpb24gZXZlbnRzIG9uIHRoZSBwYWdlIHdpbGwgbm90IHdvcmsKICAgICAgLy8gY29ycmVjdGx5IGJ1dCB0aGF0IGlzIGJ5IGRlc2lnbi4KICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCiAgICAgIHN3aXRjaCAoZS50eXBlKSB7CiAgICAgICAgY2FzZSAnRE9NQXR0ck1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWF0dHJpYnV0ZXMKCiAgICAgICAgICB2YXIgbmFtZSA9IGUuYXR0ck5hbWU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlID0gZS5yZWxhdGVkTm9kZS5uYW1lc3BhY2VVUkk7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBuZXcgZ2V0UmVjb3JkKCdhdHRyaWJ1dGVzJywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgIHJlY29yZC5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBuYW1lc3BhY2U7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9CiAgICAgICAgICAgICAgZS5hdHRyQ2hhbmdlID09PSBNdXRhdGlvbkV2ZW50LkFERElUSU9OID8gbnVsbCA6IGUucHJldlZhbHVlOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lKSA9PT0gLTEgJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZXNwYWNlKSA9PT0gLTEpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjQsIDQuNQogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGFyYWN0ZXJkYXRhCiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS50YXJnZXQ7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoYXJhY3RlckRhdGEnLCB0YXJnZXQpOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBlLnByZXZWYWx1ZTsKCgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5jaGFyYWN0ZXJEYXRhT2xkVmFsdWUpCiAgICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZFdpdGhPbGRWYWx1ZShvbGRWYWx1ZSk7CgogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ0RPTU5vZGVSZW1vdmVkJzoKICAgICAgICAgIHRoaXMuYWRkVHJhbnNpZW50T2JzZXJ2ZXIoZS50YXJnZXQpOwogICAgICAgICAgLy8gRmFsbCB0aHJvdWdoLgogICAgICAgIGNhc2UgJ0RPTU5vZGVJbnNlcnRlZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1jaGlsZGxpc3QKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnJlbGF0ZWROb2RlOwogICAgICAgICAgdmFyIGNoYW5nZWROb2RlID0gZS50YXJnZXQ7CiAgICAgICAgICB2YXIgYWRkZWROb2RlcywgcmVtb3ZlZE5vZGVzOwogICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ0RPTU5vZGVJbnNlcnRlZCcpIHsKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtdOwogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSBjaGFuZ2VkTm9kZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgbmV4dFNpYmxpbmcgPSBjaGFuZ2VkTm9kZS5uZXh0U2libGluZzsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hpbGRMaXN0JywgdGFyZ2V0KTsKICAgICAgICAgIHJlY29yZC5hZGRlZE5vZGVzID0gYWRkZWROb2RlczsKICAgICAgICAgIHJlY29yZC5yZW1vdmVkTm9kZXMgPSByZW1vdmVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gcHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgcmVjb3JkLm5leHRTaWJsaW5nID0gbmV4dFNpYmxpbmc7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAyLjEsIDMuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDIuMiwgMy4zCiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgIH0KCiAgICAgIGNsZWFyUmVjb3JkcygpOwogICAgfQogIH07CgogIGdsb2JhbC5Kc011dGF0aW9uT2JzZXJ2ZXIgPSBKc011dGF0aW9uT2JzZXJ2ZXI7Cgp9KSh0aGlzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgppZiAoIXdpbmRvdy5NdXRhdGlvbk9ic2VydmVyKSB7CiAgd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgPSAKICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHwgCiAgICAgIHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXI7CiAgaWYgKCFNdXRhdGlvbk9ic2VydmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIG11dGF0aW9uIG9ic2VydmVyIHN1cHBvcnQiKTsKICB9Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovKioKICogSW1wbGVtZW50cyBgZG9jdW1lbnQucmVnaXN0ZXJgCiAqIEBtb2R1bGUgQ3VzdG9tRWxlbWVudHMKKi8KCi8qKgogKiBQb2x5ZmlsbGVkIGV4dGVuc2lvbnMgdG8gdGhlIGBkb2N1bWVudGAgb2JqZWN0LgogKiBAY2xhc3MgRG9jdW1lbnQKKi8KCihmdW5jdGlvbihzY29wZSkgewoKLy8gaW1wb3J0cwoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkN1c3RvbUVsZW1lbnRzID0ge2ZsYWdzOnt9fTsKfQp2YXIgZmxhZ3MgPSBzY29wZS5mbGFnczsKCi8vIG5hdGl2ZSBkb2N1bWVudC5yZWdpc3Rlcj8KCnZhciBoYXNOYXRpdmUgPSBCb29sZWFuKGRvY3VtZW50LnJlZ2lzdGVyKTsKdmFyIHVzZU5hdGl2ZSA9ICFmbGFncy5yZWdpc3RlciAmJiBoYXNOYXRpdmU7CgppZiAodXNlTmF0aXZlKSB7CgogIC8vIHN0dWIKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7CiAgCiAgc2NvcGUud2F0Y2hTaGFkb3cgPSBub3A7CiAgc2NvcGUudXBncmFkZSA9IG5vcDsKICBzY29wZS51cGdyYWRlQWxsID0gbm9wOwogIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gbm9wOwogIHNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG5vcDsKICBzY29wZS51cGdyYWRlRG9jdW1lbnQgPSBub3A7CiAgc2NvcGUudGFrZVJlY29yZHMgPSBub3A7Cgp9IGVsc2UgewoKICAvKioKICAgKiBSZWdpc3RlcnMgYSBjdXN0b20gdGFnIG5hbWUgd2l0aCB0aGUgZG9jdW1lbnQuCiAgICoKICAgKiBXaGVuIGEgcmVnaXN0ZXJlZCBlbGVtZW50IGlzIGNyZWF0ZWQsIGEgYHJlYWR5Q2FsbGJhY2tgIG1ldGhvZCBpcyBjYWxsZWQKICAgKiBpbiB0aGUgc2NvcGUgb2YgdGhlIGVsZW1lbnQuIFRoZSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGNhbiBiZSBzcGVjaWZpZWQgb24KICAgKiBlaXRoZXIgYG9wdGlvbnMucHJvdG90eXBlYCBvciBgb3B0aW9ucy5saWZlY3ljbGVgIHdpdGggdGhlIGxhdHRlciB0YWtpbmcKICAgKiBwcmVjZWRlbmNlLgogICAqCiAgICogQG1ldGhvZCByZWdpc3RlcgogICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSB0YWcgbmFtZSB0byByZWdpc3Rlci4gTXVzdCBpbmNsdWRlIGEgZGFzaCAoJy0nKSwKICAgKiAgICBmb3IgZXhhbXBsZSAneC1jb21wb25lbnQnLgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogICAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmV4dGVuZHNdCiAgICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogICAqICAgICAgZWxlbWVudCkuIFRoaXMgcGFyYW1ldGVyIGlzIG5vdCBwYXJ0IG9mIHRoZSBzcGVjaWZpY2F0aW9uLCBidXQgaW5zdGVhZAogICAqICAgICAgaXMgYSBoaW50IGZvciB0aGUgcG9seWZpbGwgYmVjYXVzZSB0aGUgZXh0ZW5kZWUgaXMgZGlmZmljdWx0IHRvIGluZmVyLgogICAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogICAqICAgICAgcHJvdG90eXBlIChvciBIVE1MRWxlbWVudC5wcm90b3R5cGUpIHJlZ2FyZGxlc3Mgb2YgdGhlIHZhbHVlIG9mCiAgICogICAgICBgZXh0ZW5kc2AuCiAgICogICAgQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMucHJvdG90eXBlIFRoZSBwcm90b3R5cGUgdG8gdXNlIGZvciB0aGUgbmV3CiAgICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogICAqICAgIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9ucy5saWZlY3ljbGVdCiAgICogICAgICBDYWxsYmFja3MgdGhhdCBmaXJlIGF0IGltcG9ydGFudCBwaGFzZXMgaW4gdGhlIGxpZmUgb2YgdGhlIGN1c3RvbQogICAqICAgICAgZWxlbWVudC4KICAgKgogICAqIEBleGFtcGxlCiAgICogICAgICBGYW5jeUJ1dHRvbiA9IGRvY3VtZW50LnJlZ2lzdGVyKCJmYW5jeS1idXR0b24iLCB7CiAgICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogICAqICAgICAgICBwcm90b3R5cGU6IE9iamVjdC5jcmVhdGUoSFRNTEJ1dHRvbkVsZW1lbnQucHJvdG90eXBlLCB7CiAgICogICAgICAgICAgcmVhZHlDYWxsYmFjazogewogICAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAqICAgICAgICAgICAgICBjb25zb2xlLmxvZygiYSBmYW5jeS1idXR0b24gd2FzIGNyZWF0ZWQiLAogICAqICAgICAgICAgICAgfQogICAqICAgICAgICAgIH0KICAgKiAgICAgICAgfSkKICAgKiAgICAgIH0pOwogICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICAgKi8KICBmdW5jdGlvbiByZWdpc3RlcihuYW1lLCBvcHRpb25zKSB7CiAgICAvL2NvbnNvbGUud2FybignZG9jdW1lbnQucmVnaXN0ZXIoIicgKyBuYW1lICsgJyIsICcsIG9wdGlvbnMsICcpJyk7CiAgICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCBjbG9uZSBvcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICAgIHZhciBkZWZpbml0aW9uID0gb3B0aW9ucyB8fCB7fTsKICAgIGlmICghbmFtZSkgewogICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpY0IgY2FuIHByb2JhYmx5CiAgICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgICB0aHJvdyBuZXcgRXJyb3IoJ2RvY3VtZW50LnJlZ2lzdGVyOiBmaXJzdCBhcmd1bWVudCBgbmFtZWAgbXVzdCBub3QgYmUgZW1wdHknKTsKICAgIH0KICAgIGlmIChuYW1lLmluZGV4T2YoJy0nKSA8IDApIHsKICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWNCIGNhbiBwcm9iYWJseQogICAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdkb2N1bWVudC5yZWdpc3RlcjogZmlyc3QgYXJndW1lbnQgKFwnbmFtZVwnKSBtdXN0IGNvbnRhaW4gYSBkYXNoIChcJy1cJykuIEFyZ3VtZW50IHByb3ZpZGVkIHdhcyBcJycgKyBTdHJpbmcobmFtZSkgKyAnXCcuJyk7CiAgICB9CiAgICAvLyByZWNvcmQgbmFtZQogICAgZGVmaW5pdGlvbi5uYW1lID0gbmFtZTsKICAgIC8vIG11c3QgaGF2ZSBhIHByb3RvdHlwZSwgZGVmYXVsdCB0byBhbiBleHRlbnNpb24gb2YgSFRNTEVsZW1lbnQKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCB0aHJvdyBpZiBubyBwcm90b3R5cGUsIGNoZWNrIHNwZWMKICAgIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWNCIGNhbiBwcm9iYWJseQogICAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgICAgdGhyb3cgbmV3IEVycm9yKCdPcHRpb25zIG1pc3NpbmcgcmVxdWlyZWQgcHJvdG90eXBlIHByb3BlcnR5Jyk7CiAgICB9CiAgICAvLyBlbnN1cmUgYSBsaWZlY3ljbGUgb2JqZWN0IHNvIHdlIGRvbid0IGhhdmUgdG8gbnVsbCB0ZXN0IGl0CiAgICBkZWZpbml0aW9uLmxpZmVjeWNsZSA9IGRlZmluaXRpb24ubGlmZWN5Y2xlIHx8IHt9OwogICAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgICAvLyBUT0RPKHNqbWlsZXMpOiB3ZSB1c2VkIHRvIG5lZWQgdG8gc3RvcmUgdGhpcywgYnV0IGN1cnJlbnQgY29kZSBvbmx5CiAgICAvLyB1c2VzIGl0IGluICdyZXNvbHZlVGFnTmFtZSc6IGl0IHNob3VsZCBwcm9iYWJseSBiZSBpbmxpbmVkCiAgICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAgIC8vIGV4dGVuc2lvbnMgb2YgbmF0aXZlIHNwZWNpYWxpemF0aW9ucyBvZiBIVE1MRWxlbWVudCByZXF1aXJlIGxvY2FsTmFtZQogICAgLy8gdG8gcmVtYWluIG5hdGl2ZSwgYW5kIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIgZm9yIGV4dGVuc2lvbiB0eXBlCiAgICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAgIC8vIHNvbWUgcGxhdGZvcm1zIHJlcXVpcmUgbW9kaWZpY2F0aW9ucyB0byB0aGUgdXNlci1zdXBwbGllZCBwcm90b3R5cGUKICAgIC8vIGNoYWluCiAgICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGF0dHJpYnV0ZUNoYW5nZWQgY2FsbGJhY2sKICAgIG92ZXJyaWRlQXR0cmlidXRlQXBpKGRlZmluaXRpb24ucHJvdG90eXBlKTsKICAgIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgICByZWdpc3RlckRlZmluaXRpb24obmFtZSwgZGVmaW5pdGlvbik7CiAgICAvLyA3LjEuNy4gUnVuIGN1c3RvbSBlbGVtZW50IGNvbnN0cnVjdG9yIGdlbmVyYXRpb24gYWxnb3JpdGhtIHdpdGggUFJPVE9UWVBFCiAgICAvLyA3LjEuOC4gUmV0dXJuIHRoZSBvdXRwdXQgb2YgdGhlIHByZXZpb3VzIHN0ZXAuCiAgICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogICAgZGVmaW5pdGlvbi5jdG9yLnByb3RvdHlwZSA9IGRlZmluaXRpb24ucHJvdG90eXBlOwogICAgLy8gZm9yY2Ugb3VyIC5jb25zdHJ1Y3RvciB0byBiZSBvdXIgYWN0dWFsIGNvbnN0cnVjdG9yCiAgICBkZWZpbml0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGRlZmluaXRpb24uY3RvcjsKICAgIC8vIGlmIGluaXRpYWwgcGFyc2luZyBpcyBjb21wbGV0ZQogICAgaWYgKHNjb3BlLnJlYWR5KSB7CiAgICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgICAgc2NvcGUudXBncmFkZUFsbChkb2N1bWVudCk7CiAgICB9CiAgICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwogIH0KCiAgZnVuY3Rpb24gYW5jZXN0cnkoZXh0bmRzKSB7CiAgICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtleHRuZHNdOwogICAgaWYgKGV4dGVuZGVlKSB7CiAgICAgIHJldHVybiBhbmNlc3RyeShleHRlbmRlZS5leHRlbmRzKS5jb25jYXQoW2V4dGVuZGVlXSk7CiAgICB9CiAgICByZXR1cm4gW107CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKSB7CiAgICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogICAgLy8gYmFzZVRhZywgdW5sZXNzIGl0IHJlcHJlc2VudHMgYSBjdXN0b20gY29tcG9uZW50CiAgICB2YXIgYmFzZVRhZyA9IGRlZmluaXRpb24uZXh0ZW5kczsKICAgIC8vIGlmIG91ciBhbmNlc3RyeSBpbmNsdWRlcyBjdXN0b20gY29tcG9uZW50cywgd2Ugb25seSBoYXZlIGEKICAgIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogICAgZm9yICh2YXIgaT0wLCBhOyAoYT1kZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICAgIGJhc2VUYWcgPSBhLmlzICYmIGEudGFnOwogICAgfQogICAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICAgIGRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBkZWZpbml0aW9uLm5hbWU7CiAgICBpZiAoYmFzZVRhZykgewogICAgICAvLyBpZiB0aGVyZSBpcyBhIGJhc2UgdGFnLCB1c2Ugc2Vjb25kYXJ5ICdpcycgc3BlY2lmaWVyCiAgICAgIGRlZmluaXRpb24uaXMgPSBkZWZpbml0aW9uLm5hbWU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbikgewogICAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogICAgLy8gcHJvdG90eXBlIGZvciBwcmVjaXNlIG1peGluZyBpbgogICAgaWYgKCFPYmplY3QuX19wcm90b19fKSB7CiAgICAgIC8vIGRlZmF1bHQgcHJvdG90eXBlCiAgICAgIHZhciBuYXRpdmVQcm90b3R5cGUgPSBIVE1MRWxlbWVudC5wcm90b3R5cGU7CiAgICAgIC8vIHdvcmsgb3V0IHByb3RvdHlwZSB3aGVuIHVzaW5nIHR5cGUtZXh0ZW5zaW9uCiAgICAgIGlmIChkZWZpbml0aW9uLmlzKSB7CiAgICAgICAgdmFyIGluc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGRlZmluaXRpb24udGFnKTsKICAgICAgICBuYXRpdmVQcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICAgIH0KICAgICAgLy8gZW5zdXJlIF9fcHJvdG9fXyByZWZlcmVuY2UgaXMgaW5zdGFsbGVkIGF0IGVhY2ggcG9pbnQgb24gdGhlIHByb3RvdHlwZQogICAgICAvLyBjaGFpbi4KICAgICAgLy8gTk9URTogT24gcGxhdGZvcm1zIHdpdGhvdXQgX19wcm90b19fLCBhIG1peGluIHN0cmF0ZWd5IGlzIHVzZWQgaW5zdGVhZAogICAgICAvLyBvZiBwcm90b3R5cGUgc3dpenpsaW5nLiBJbiB0aGlzIGNhc2UsIHRoaXMgZ2VuZXJhdGVkIF9fcHJvdG9fXyBwcm92aWRlcwogICAgICAvLyBsaW1pdGVkIHN1cHBvcnQgZm9yIHByb3RvdHlwZSB0cmF2ZXJzYWwuCiAgICAgIHZhciBwcm90byA9IGRlZmluaXRpb24ucHJvdG90eXBlLCBhbmNlc3RvcjsKICAgICAgd2hpbGUgKHByb3RvICYmIChwcm90byAhPT0gbmF0aXZlUHJvdG90eXBlKSkgewogICAgICAgIHZhciBhbmNlc3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90byk7CiAgICAgICAgcHJvdG8uX19wcm90b19fID0gYW5jZXN0b3I7CiAgICAgICAgcHJvdG8gPSBhbmNlc3RvcjsKICAgICAgfQogICAgfQogICAgLy8gY2FjaGUgdGhpcyBpbiBjYXNlIG9mIG1peGluCiAgICBkZWZpbml0aW9uLm5hdGl2ZSA9IG5hdGl2ZVByb3RvdHlwZTsKICB9CgogIC8vIFNFQ1RJT04gNAoKICBmdW5jdGlvbiBpbnN0YW50aWF0ZShkZWZpbml0aW9uKSB7CiAgICAvLyA0LmEuMS4gQ3JlYXRlIGEgbmV3IG9iamVjdCB0aGF0IGltcGxlbWVudHMgUFJPVE9UWVBFCiAgICAvLyA0LmEuMi4gTGV0IEVMRU1FTlQgYnkgdGhpcyBuZXcgb2JqZWN0CiAgICAvLwogICAgLy8gdGhlIGN1c3RvbSBlbGVtZW50IGluc3RhbnRpYXRpb24gYWxnb3JpdGhtIG11c3QgYWxzbyBlbnN1cmUgdGhhdCB0aGUKICAgIC8vIG91dHB1dCBpcyBhIHZhbGlkIERPTSBlbGVtZW50IHdpdGggdGhlIHByb3BlciB3cmFwcGVyIGluIHBsYWNlLgogICAgLy8KICAgIHJldHVybiB1cGdyYWRlKGRvbUNyZWF0ZUVsZW1lbnQoZGVmaW5pdGlvbi50YWcpLCBkZWZpbml0aW9uKTsKICB9CgogIGZ1bmN0aW9uIHVwZ3JhZGUoZWxlbWVudCwgZGVmaW5pdGlvbikgewogICAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgICBpZiAoZGVmaW5pdGlvbi5pcykgewogICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBkZWZpbml0aW9uLmlzKTsKICAgIH0KICAgIC8vIG1ha2UgJ2VsZW1lbnQnIGltcGxlbWVudCBkZWZpbml0aW9uLnByb3RvdHlwZQogICAgaW1wbGVtZW50KGVsZW1lbnQsIGRlZmluaXRpb24pOwogICAgLy8gZmxhZyBhcyB1cGdyYWRlZAogICAgZWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogICAgLy8gdGhlcmUgc2hvdWxkIG5ldmVyIGJlIGEgc2hhZG93IHJvb3Qgb24gZWxlbWVudCBhdCB0aGlzIHBvaW50CiAgICAvLyB3ZSByZXF1aXJlIGNoaWxkIG5vZGVzIGJlIHVwZ3JhZGVkIGJlZm9yZSBgY3JlYXRlZGAKICAgIHNjb3BlLnVwZ3JhZGVTdWJ0cmVlKGVsZW1lbnQpOwogICAgLy8gbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICAgIGNyZWF0ZWQoZWxlbWVudCk7CiAgICAvLyBPVVRQVVQKICAgIHJldHVybiBlbGVtZW50OwogIH0KCiAgZnVuY3Rpb24gaW1wbGVtZW50KGVsZW1lbnQsIGRlZmluaXRpb24pIHsKICAgIC8vIHByb3RvdHlwZSBzd2l6emxpbmcgaXMgYmVzdAogICAgaWYgKE9iamVjdC5fX3Byb3RvX18pIHsKICAgICAgZWxlbWVudC5fX3Byb3RvX18gPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgICAvLyBnZXRQcm90b3R5cGVPZihFbGVtZW50KSwgd2UgY2Fubm90IGRvIHNvIHdoZW4KICAgICAgLy8gd2UgdXNlIG1peGluLCBzbyB3ZSBpbnN0YWxsIGEgbWFnaWMgcmVmZXJlbmNlCiAgICAgIGN1c3RvbU1peGluKGVsZW1lbnQsIGRlZmluaXRpb24ucHJvdG90eXBlLCBkZWZpbml0aW9uLm5hdGl2ZSk7CiAgICAgIGVsZW1lbnQuX19wcm90b19fID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjdXN0b21NaXhpbihpblRhcmdldCwgaW5TcmMsIGluTmF0aXZlKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgICAvLyBhbnkgcHJvcGVydHkuIFRoaXMgc2V0IHNob3VsZCBiZSBwcmVjYWxjdWxhdGVkLiBXZSBhbHNvIG5lZWQgdG8KICAgIC8vIGNvbnNpZGVyIHRoaXMgZm9yIHN1cHBvcnRpbmcgJ3N1cGVyJy4KICAgIHZhciB1c2VkID0ge307CiAgICAvLyBzdGFydCB3aXRoIGluU3JjCiAgICB2YXIgcCA9IGluU3JjOwogICAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogICAgLy8gSFRNTEVsZW1lbnQucHJvdG90eXBlLCBzbyB3ZSBhZGQgYSB0ZXN0CiAgICAvLyB0aGUgaWRlYSBpcyB0byBhdm9pZCBtaXhpbmcgaW4gbmF0aXZlIHByb3RvdHlwZXMsIHNvIGFkZGluZwogICAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICAgIHdoaWxlIChwICE9PSBpbk5hdGl2ZSAmJiBwICE9PSBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlKSB7CiAgICAgIHZhciBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocCk7CiAgICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgICBpZiAoIXVzZWRba10pIHsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpblRhcmdldCwgaywKICAgICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICAgIHVzZWRba10gPSAxOwogICAgICAgIH0KICAgICAgfQogICAgICBwID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHApOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY3JlYXRlZChlbGVtZW50KSB7CiAgICAvLyBpbnZva2UgY3JlYXRlZENhbGxiYWNrCiAgICBpZiAoZWxlbWVudC5jcmVhdGVkQ2FsbGJhY2spIHsKICAgICAgZWxlbWVudC5jcmVhdGVkQ2FsbGJhY2soKTsKICAgIH0KICB9CgogIC8vIGF0dHJpYnV0ZSB3YXRjaGluZwoKICBmdW5jdGlvbiBvdmVycmlkZUF0dHJpYnV0ZUFwaShwcm90b3R5cGUpIHsKICAgIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgY2FsbGJhY2tzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBzaG91bGQgc3VwcG9ydCBhY2Nlc3MgdmlhIC5hdHRyaWJ1dGVzIE5hbWVkTm9kZU1hcAogICAgLy8gVE9ETyhzam1pbGVzKTogcHJlc2VydmVzIHVzZXIgZGVmaW5lZCBvdmVycmlkZXMsIGlmIGFueQogICAgdmFyIHNldEF0dHJpYnV0ZSA9IHByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgICBwcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHNldEF0dHJpYnV0ZSk7CiAgICB9CiAgICB2YXIgcmVtb3ZlQXR0cmlidXRlID0gcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZTsKICAgIHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICBjaGFuZ2VBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCB2YWx1ZSwgcmVtb3ZlQXR0cmlidXRlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoYW5nZUF0dHJpYnV0ZShuYW1lLCB2YWx1ZSwgb3BlcmF0aW9uKSB7CiAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrIAogICAgICAgICYmICh0aGlzLmdldEF0dHJpYnV0ZShuYW1lKSAhPT0gb2xkVmFsdWUpKSB7CiAgICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICAgIH0KICB9CgogIC8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKICB2YXIgcmVnaXN0cnkgPSB7fTsKCiAgZnVuY3Rpb24gcmVnaXN0ZXJEZWZpbml0aW9uKG5hbWUsIGRlZmluaXRpb24pIHsKICAgIHJlZ2lzdHJ5W25hbWVdID0gZGVmaW5pdGlvbjsKICB9CgogIGZ1bmN0aW9uIGdlbmVyYXRlQ29uc3RydWN0b3IoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gaW5zdGFudGlhdGUoZGVmaW5pdGlvbik7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudCh0YWcsIHR5cGVFeHRlbnNpb24pIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGlnbm9yZSAndGFnJyB3aGVuIHVzaW5nICd0eXBlRXh0ZW5zaW9uJywgd2UgY291bGQKICAgIC8vIGVycm9yIGNoZWNrIGl0LCBvciBwZXJoYXBzIHRoZXJlIHNob3VsZCBvbmx5IGV2ZXIgYmUgb25lIGFyZ3VtZW50CiAgICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W3R5cGVFeHRlbnNpb24gfHwgdGFnXTsKICAgIGlmIChkZWZpbml0aW9uKSB7CiAgICAgIHJldHVybiBuZXcgZGVmaW5pdGlvbi5jdG9yKCk7CiAgICB9CiAgICByZXR1cm4gZG9tQ3JlYXRlRWxlbWVudCh0YWcpOwogIH0KCiAgZnVuY3Rpb24gdXBncmFkZUVsZW1lbnQoZWxlbWVudCkgewogICAgaWYgKCFlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiAoZWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICAgIHZhciB0eXBlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgZWxlbWVudC5sb2NhbE5hbWU7CiAgICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICAgIHJldHVybiBkZWZpbml0aW9uICYmIHVwZ3JhZGUoZWxlbWVudCwgZGVmaW5pdGlvbik7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogICAgLy8gY2FsbCBvcmlnaW5hbCBjbG9uZQogICAgdmFyIG4gPSBkb21DbG9uZU5vZGUuY2FsbCh0aGlzLCBkZWVwKTsKICAgIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICAgIHNjb3BlLnVwZ3JhZGVBbGwobik7CiAgICAvLyByZXR1cm4gdGhlIGNsb25lCiAgICByZXR1cm4gbjsKICB9CiAgLy8gY2FwdHVyZSBuYXRpdmUgY3JlYXRlRWxlbWVudCBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCiAgdmFyIGRvbUNyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50LmJpbmQoZG9jdW1lbnQpOwoKICAvLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0CgogIHZhciBkb21DbG9uZU5vZGUgPSBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGU7CgogIC8vIGV4cG9ydHMKCiAgZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKICBkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKICBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGUgPSBjbG9uZU5vZGU7IC8vIG92ZXJyaWRlCgogIHNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgogIC8qKgogICAqIFVwZ3JhZGUgYW4gZWxlbWVudCB0byBhIGN1c3RvbSBlbGVtZW50LiBVcGdyYWRpbmcgYW4gZWxlbWVudAogICAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZSAKICAgKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICAgKiBgdXBncmFkZWAgZG9lcyBub3RoaW5nIGlmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgdXBncmFkZWQsIG9yCiAgICogaWYgaXQgbWF0Y2hlcyBubyByZWdpc3RlcmVkIGN1c3RvbSB0YWcgbmFtZS4KICAgKgogICAqIEBtZXRob2QgdWdwcmFkZQogICAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbWVudCBUaGUgZWxlbWVudCB0byB1cGdyYWRlLgogICAqIEByZXR1cm4ge0VsZW1lbnR9IFRoZSB1cGdyYWRlZCBlbGVtZW50LgogICAqLwogIHNjb3BlLnVwZ3JhZGUgPSB1cGdyYWRlRWxlbWVudDsKfQoKc2NvcGUuaGFzTmF0aXZlID0gaGFzTmF0aXZlOwpzY29wZS51c2VOYXRpdmUgPSB1c2VOYXRpdmU7Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qDQpDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLg0KVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUNCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4NCiovDQoNCihmdW5jdGlvbihzY29wZSl7DQoNCnZhciBsb2dGbGFncyA9IHdpbmRvdy5sb2dGbGFncyB8fCB7fTsNCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uDQovLyB0byBlYWNoIGVsZW1lbnQNCi8vIGlmICdmaW5kJyByZXR1cm5zIHRydWUgZm9yICdlbGVtZW50JywgZG8gbm90IHNlYXJjaCBlbGVtZW50J3Mgc3VidHJlZQ0KZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7DQogIHZhciBlID0gbm9kZS5maXJzdEVsZW1lbnRDaGlsZDsNCiAgaWYgKCFlKSB7DQogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsNCiAgICB3aGlsZSAoZSAmJiBlLm5vZGVUeXBlICE9PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgICAgZSA9IGUubmV4dFNpYmxpbmc7DQogICAgfQ0KICB9DQogIHdoaWxlIChlKSB7DQogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsNCiAgICAgIGZpbmRBbGwoZSwgZmluZCwgZGF0YSk7DQogICAgfQ0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsNCiAgfQ0KICByZXR1cm4gbnVsbDsNCn0NCg0KLy8gd2FsayBhbGwgc2hhZG93Um9vdHMgb24gYSBnaXZlbiBub2RlLg0KZnVuY3Rpb24gZm9yUm9vdHMobm9kZSwgY2IpIHsNCiAgdmFyIHJvb3QgPSBub2RlLnNoYWRvd1Jvb3Q7DQogIHdoaWxlKHJvb3QpIHsNCiAgICBmb3JTdWJ0cmVlKHJvb3QsIGNiKTsNCiAgICByb290ID0gcm9vdC5vbGRlclNoYWRvd1Jvb3Q7DQogIH0NCn0NCg0KLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgaW5jbHVkaW5nIGRlc2NlbnQgaW50byBzaGFkb3ctcm9vdHMsDQovLyBhcHBseWluZyAnY2InIHRvIGVhY2ggZWxlbWVudA0KZnVuY3Rpb24gZm9yU3VidHJlZShub2RlLCBjYikgew0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwKCdzdWJUcmVlOiAnLCBub2RlKTsNCiAgZmluZEFsbChub2RlLCBmdW5jdGlvbihlKSB7DQogICAgaWYgKGNiKGUpKSB7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogICAgZm9yUm9vdHMoZSwgY2IpOw0KICB9KTsNCiAgZm9yUm9vdHMobm9kZSwgY2IpOw0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZQ0KZnVuY3Rpb24gYWRkZWQobm9kZSkgew0KICBpZiAodXBncmFkZShub2RlKSkgew0KICAgIGluc2VydGVkTm9kZShub2RlKTsNCiAgICByZXR1cm4gdHJ1ZTsNCiAgfQ0KICBpbnNlcnRlZChub2RlKTsNCn0NCg0KLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5DQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgew0KICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsNCiAgICBpZiAoYWRkZWQoZSkpIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgfSk7DQp9DQoNCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSBhbmQgaXQncyBzdWJ0cmVlDQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgew0KICByZXR1cm4gYWRkZWQobm9kZSkgfHwgYWRkZWRTdWJ0cmVlKG5vZGUpOw0KfQ0KDQovLyB1cGdyYWRlIGN1c3RvbSBlbGVtZW50cyBhdCBub2RlLCBpZiBhcHBsaWNhYmxlDQpmdW5jdGlvbiB1cGdyYWRlKG5vZGUpIHsNCiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgew0KICAgIHZhciB0eXBlID0gbm9kZS5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgbm9kZS5sb2NhbE5hbWU7DQogICAgdmFyIGRlZmluaXRpb24gPSBzY29wZS5yZWdpc3RyeVt0eXBlXTsNCiAgICBpZiAoZGVmaW5pdGlvbikgew0KICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGU6Jywgbm9kZS5sb2NhbE5hbWUpOw0KICAgICAgc2NvcGUudXBncmFkZShub2RlKTsNCiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQogIH0NCn0NCg0KZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsNCiAgaW5zZXJ0ZWQobm9kZSk7DQogIGlmIChpbkRvY3VtZW50KG5vZGUpKSB7DQogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7DQogICAgICBpbnNlcnRlZChlKTsNCiAgICB9KTsNCiAgfQ0KfQ0KDQoNCi8vIFRPRE8oc29ydmVsbCk6IG9uIHBsYXRmb3JtcyB3aXRob3V0IE11dGF0aW9uT2JzZXJ2ZXIsIG11dGF0aW9ucyBtYXkgbm90IGJlIA0KLy8gcmVsaWFibGUgYW5kIHRoZXJlZm9yZSBlbnRlcmVkL2xlZnRWaWV3IGFyZSBub3QgcmVsaWFibGUuDQovLyBUbyBtYWtlIHRoZXNlIGNhbGxiYWNrcyBsZXNzIGxpa2VseSB0byBmYWlsLCB3ZSBkZWZlciBhbGwgaW5zZXJ0cyBhbmQgcmVtb3Zlcw0KLy8gdG8gZ2l2ZSBhIGNoYW5jZSBmb3IgZWxlbWVudHMgdG8gYmUgaW5zZXJ0ZWQgaW50byBkb20uIA0KLy8gVGhpcyBlbnN1cmVzIGVudGVyZWRWaWV3Q2FsbGJhY2sgZmlyZXMgZm9yIGVsZW1lbnRzIHRoYXQgYXJlIGNyZWF0ZWQgYW5kIA0KLy8gaW1tZWRpYXRlbHkgYWRkZWQgdG8gZG9tLg0KdmFyIGhhc1BvbHlmaWxsTXV0YXRpb25zID0gKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlciB8fA0KICAgICh3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9PT0gd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcikpOw0Kc2NvcGUuaGFzUG9seWZpbGxNdXRhdGlvbnMgPSBoYXNQb2x5ZmlsbE11dGF0aW9uczsNCg0KdmFyIGlzUGVuZGluZ011dGF0aW9ucyA9IGZhbHNlOw0KdmFyIHBlbmRpbmdNdXRhdGlvbnMgPSBbXTsNCmZ1bmN0aW9uIGRlZmVyTXV0YXRpb24oZm4pIHsNCiAgcGVuZGluZ011dGF0aW9ucy5wdXNoKGZuKTsNCiAgaWYgKCFpc1BlbmRpbmdNdXRhdGlvbnMpIHsNCiAgICBpc1BlbmRpbmdNdXRhdGlvbnMgPSB0cnVlOw0KICAgIHZhciBhc3luYyA9ICh3aW5kb3cuUGxhdGZvcm0gJiYgd2luZG93LlBsYXRmb3JtLmVuZE9mTWljcm90YXNrKSB8fA0KICAgICAgICBzZXRUaW1lb3V0Ow0KICAgIGFzeW5jKHRha2VNdXRhdGlvbnMpOw0KICB9DQp9DQoNCmZ1bmN0aW9uIHRha2VNdXRhdGlvbnMoKSB7DQogIGlzUGVuZGluZ011dGF0aW9ucyA9IGZhbHNlOw0KICB2YXIgJHAgPSBwZW5kaW5nTXV0YXRpb25zOw0KICBmb3IgKHZhciBpPTAsIGw9JHAubGVuZ3RoLCBwOyAoaTxsKSAmJiAocD0kcFtpXSk7IGkrKykgew0KICAgIHAoKTsNCiAgfQ0KICBwZW5kaW5nTXV0YXRpb25zID0gW107DQp9DQoNCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsNCiAgaWYgKGhhc1BvbHlmaWxsTXV0YXRpb25zKSB7DQogICAgZGVmZXJNdXRhdGlvbihmdW5jdGlvbigpIHsNCiAgICAgIF9pbnNlcnRlZChlbGVtZW50KTsNCiAgICB9KTsNCiAgfSBlbHNlIHsNCiAgICBfaW5zZXJ0ZWQoZWxlbWVudCk7DQogIH0NCn0NCg0KLy8gVE9ETyhzam1pbGVzKTogaWYgdGhlcmUgYXJlIGRlc2NlbnRzIGludG8gdHJlZXMgdGhhdCBjYW4gbmV2ZXIgaGF2ZSBpbkRvY3VtZW50KCopIHRydWUsIGZpeCB0aGlzDQpmdW5jdGlvbiBfaW5zZXJ0ZWQoZWxlbWVudCkgew0KICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlDQogIC8vIG9mIG9uZSBtaWNyb3Rhc2ssIGluIHdoaWNoIGNhc2Ugd2Ugd29uJ3QgYmUgJ2luRG9jdW1lbnQnIGhlcmUNCiAgLy8gQnV0IHRoZXJlIGFyZSBvdGhlciBjYXNlcyB3aGVyZSB3ZSBhcmUgdGVzdGluZyBmb3IgaW5zZXJ0ZWQgd2l0aG91dA0KICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUNCiAgLy8gd2hldGhlciB0byBjYWxsIGluc2VydGVkDQogIC8vIElmIHdlIGNhbiBmYWN0b3IgdGhlc2UgY2FzZXMgaW50byBzZXBhcmF0ZSBjb2RlIHBhdGhzIHdlIGNhbiBoYXZlDQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4NCiAgLy8gVE9ETyhzam1pbGVzKTogd2hlbiBsb2dnaW5nLCBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuDQogIC8vIHRyYWNrIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQNCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsNCiAgaWYgKGVsZW1lbnQuZW50ZXJlZFZpZXdDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7DQogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsNCiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgKyAxOw0KICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ3JlbW92ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAnaW5zZXJ0ZWQnIHN0YXRlDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgew0KICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAxOw0KICAgICAgfQ0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAxKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkNCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5lbnRlcmVkVmlld0NhbGxiYWNrKSB7DQogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgICAgICBlbGVtZW50LmVudGVyZWRWaWV3Q2FsbGJhY2soKTsNCiAgICAgIH0NCiAgICB9DQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiByZW1vdmVkTm9kZShub2RlKSB7DQogIHJlbW92ZWQobm9kZSk7DQogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgew0KICAgIHJlbW92ZWQoZSk7DQogIH0pOw0KfQ0KDQoNCmZ1bmN0aW9uIHJlbW92ZWQoZWxlbWVudCkgew0KICBpZiAoaGFzUG9seWZpbGxNdXRhdGlvbnMpIHsNCiAgICBkZWZlck11dGF0aW9uKGZ1bmN0aW9uKCkgew0KICAgICAgX3JlbW92ZWQoZWxlbWVudCk7DQogICAgfSk7DQogIH0gZWxzZSB7DQogICAgX3JlbW92ZWQoZWxlbWVudCk7DQogIH0NCn0NCg0KZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IHRlbXBvcmFyeTogZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbiB0cmFjaw0KICAvLyBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkDQogIGlmIChlbGVtZW50LmxlZnRWaWV3Q2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsNCiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOw0KICAgIGlmICghaW5Eb2N1bWVudChlbGVtZW50KSkgew0KICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSAtIDE7DQogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAnaW5zZXJ0ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAncmVtb3ZlZCcgc3RhdGUNCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAwKSB7DQogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDA7DQogICAgICB9DQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgcmVtb3ZlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrDQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMCkgew0KICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lLA0KICAgICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQ0KICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmxlZnRWaWV3Q2FsbGJhY2spIHsNCiAgICAgICAgZWxlbWVudC5sZWZ0Vmlld0NhbGxiYWNrKCk7DQogICAgICB9DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIGluRG9jdW1lbnQoZWxlbWVudCkgew0KICB2YXIgcCA9IGVsZW1lbnQ7DQogIHZhciBkb2MgPSB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgJiYNCiAgICAgIHdpbmRvdy5TaGFkb3dET01Qb2x5ZmlsbC53cmFwSWZOZWVkZWQoZG9jdW1lbnQpIHx8IGRvY3VtZW50Ow0KICB3aGlsZSAocCkgew0KICAgIGlmIChwID09IGRvYykgew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICAgIHAgPSBwLnBhcmVudE5vZGUgfHwgcC5ob3N0Ow0KICB9DQp9DQoNCmZ1bmN0aW9uIHdhdGNoU2hhZG93KG5vZGUpIHsNCiAgaWYgKG5vZGUuc2hhZG93Um9vdCAmJiAhbm9kZS5zaGFkb3dSb290Ll9fd2F0Y2hlZCkgew0KICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnd2F0Y2hpbmcgc2hhZG93LXJvb3QgZm9yOiAnLCBub2RlLmxvY2FsTmFtZSk7DQogICAgLy8gd2F0Y2ggYWxsIHVud2F0Y2hlZCByb290cy4uLg0KICAgIHZhciByb290ID0gbm9kZS5zaGFkb3dSb290Ow0KICAgIHdoaWxlIChyb290KSB7DQogICAgICB3YXRjaFJvb3Qocm9vdCk7DQogICAgICByb290ID0gcm9vdC5vbGRlclNoYWRvd1Jvb3Q7DQogICAgfQ0KICB9DQp9DQoNCmZ1bmN0aW9uIHdhdGNoUm9vdChyb290KSB7DQogIGlmICghcm9vdC5fX3dhdGNoZWQpIHsNCiAgICBvYnNlcnZlKHJvb3QpOw0KICAgIHJvb3QuX193YXRjaGVkID0gdHJ1ZTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBmaWx0ZXIoaW5Ob2RlKSB7DQogIHN3aXRjaCAoaW5Ob2RlLmxvY2FsTmFtZSkgew0KICAgIGNhc2UgJ3N0eWxlJzoNCiAgICBjYXNlICdzY3JpcHQnOg0KICAgIGNhc2UgJ3RlbXBsYXRlJzoNCiAgICBjYXNlIHVuZGVmaW5lZDoNCiAgICAgIHJldHVybiB0cnVlOw0KICB9DQp9DQoNCmZ1bmN0aW9uIGhhbmRsZXIobXV0YXRpb25zKSB7DQogIC8vDQogIGlmIChsb2dGbGFncy5kb20pIHsNCiAgICB2YXIgbXggPSBtdXRhdGlvbnNbMF07DQogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgaWYgKG14LmFkZGVkTm9kZXMpIHsNCiAgICAgICAgICB2YXIgZCA9IG14LmFkZGVkTm9kZXNbMF07DQogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgew0KICAgICAgICAgICAgZCA9IGQucGFyZW50Tm9kZTsNCiAgICAgICAgICB9DQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7DQogICAgICAgICAgdSA9IHUuc3BsaXQoJy8/Jykuc2hpZnQoKS5zcGxpdCgnLycpLnBvcCgpOw0KICAgICAgICB9DQogICAgfQ0KICAgIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9ucyAoJWQpIFslc10nLCBtdXRhdGlvbnMubGVuZ3RoLCB1IHx8ICcnKTsNCiAgfQ0KICAvLw0KICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihteCkgew0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9uJyk7DQogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7DQogICAgICBmb3JFYWNoKG14LmFkZGVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50DQogICAgICAgIGFkZGVkTm9kZShuKTsNCiAgICAgIH0pOw0KICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudA0KICAgICAgZm9yRWFjaChteC5yZW1vdmVkTm9kZXMsIGZ1bmN0aW9uKG4pIHsNCiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOw0KICAgICAgICBpZiAoZmlsdGVyKG4pKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQogICAgICAgIHJlbW92ZWROb2RlKG4pOw0KICAgICAgfSk7DQogICAgfQ0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCiAgfSk7DQogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7DQp9Ow0KDQp2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihoYW5kbGVyKTsNCg0KZnVuY3Rpb24gdGFrZVJlY29yZHMoKSB7DQogIC8vIFRPRE8oc2ptaWxlcyk6IGFzayBSYWYgd2h5IHdlIGhhdmUgdG8gY2FsbCBoYW5kbGVyIG91cnNlbHZlcw0KICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOw0KICB0YWtlTXV0YXRpb25zKCk7DQp9DQoNCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsNCg0KZnVuY3Rpb24gb2JzZXJ2ZShpblJvb3QpIHsNCiAgb2JzZXJ2ZXIub2JzZXJ2ZShpblJvb3QsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9KTsNCn0NCg0KZnVuY3Rpb24gb2JzZXJ2ZURvY3VtZW50KGRvY3VtZW50KSB7DQogIG9ic2VydmUoZG9jdW1lbnQpOw0KfQ0KDQpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ3VwZ3JhZGVEb2N1bWVudDogJywgKGRvY3VtZW50LlVSTCB8fCBkb2N1bWVudC5fVVJMIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpKTsNCiAgYWRkZWROb2RlKGRvY3VtZW50KTsNCiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsNCn0NCg0KLy8gZXhwb3J0cw0KDQpzY29wZS53YXRjaFNoYWRvdyA9IHdhdGNoU2hhZG93Ow0Kc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsNCnNjb3BlLnVwZ3JhZGVTdWJ0cmVlID0gYWRkZWRTdWJ0cmVlOw0KDQpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7DQpzY29wZS51cGdyYWRlRG9jdW1lbnQgPSB1cGdyYWRlRG9jdW1lbnQ7DQoNCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7DQoNCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7DQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gaW1wb3J0cwoKdmFyIHhociA9IHNjb3BlLnhocjsKCi8vIGltcG9ydGVyCgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwp2YXIgU1RZTEVfTElOS19UWVBFID0gJ3N0eWxlc2hlZXQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAnbG9hZCcpCi8vIGF0IHRoZSByb290IG9mIGEgdHJlZSBvZiBkb2N1bWVudHMKCi8vIGZvciBhbnkgZG9jdW1lbnQsIGltcG9ydGVyOgovLyAtIGxvYWRzIGFueSBsaW5rZWQgZG9jdW1lbnRzICh3aXRoIGRlZHVwaW5nKSwgbW9kaWZpZXMgcGF0aHMgYW5kIGZlZWRzIHRoZW0gYmFjayBpbnRvIGltcG9ydGVyCi8vIC0gbG9hZHMgdGV4dCBvZiBleHRlcm5hbCBzY3JpcHQgdGFncwovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc3R5bGUgdGFncyBpbnNpZGUgb2YgPGVsZW1lbnQ+LCBtb2RpZmllcyBwYXRocwoKLy8gd2hlbiBpbXBvcnRlciAnbW9kaWZpZXMgcGF0aHMnIGluIGEgZG9jdW1lbnQsIHRoaXMgaW5jbHVkZXMKLy8gLSBocmVmL3NyYy9hY3Rpb24gaW4gbm9kZSBhdHRyaWJ1dGVzCi8vIC0gcGF0aHMgaW4gaW5saW5lIHN0eWxlc2hlZXRzCi8vIC0gYWxsIGNvbnRlbnQgaW5zaWRlIHRlbXBsYXRlcwoKLy8gbGlua2VkIHN0eWxlIHNoZWV0cyBpbiBhbiBpbXBvcnQgaGF2ZSB0aGVpciBvd24gcGF0aCBmaXhlZCB1cCB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gPGVsZW1lbnQ+IGFyZSBsb2FkZWQsIGFuZCB0aGUgY29udGVudCBnZXRzIHBhdGggZml4dXBzCi8vIGlubGluZSBzdHlsZSBzaGVldHMgZ2V0IHBhdGggZml4dXBzIHdoZW4gdGhlaXIgY29udGFpbmluZyBpbXBvcnQgbW9kaWZpZXMgcGF0aHMKCnZhciBsb2FkZXI7Cgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2VsZW1lbnQgbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArICddJywKICAgICd0ZW1wbGF0ZScsCiAgICAnc2NyaXB0W3NyY106bm90KFt0eXBlXSknLAogICAgJ3NjcmlwdFtzcmNdW3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0uam9pbignLCcpLAogIGxvYWRlcjogZnVuY3Rpb24obmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBuZXcgTG9hZGVyKGltcG9ydGVyLmxvYWRlZCwgbmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICByZXR1cm4gbG9hZGVyOwogIH0sCiAgbG9hZDogZnVuY3Rpb24oZG9jLCBuZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IGltcG9ydGVyLmxvYWRlcihuZXh0KTsKICAgIC8vIGFkZCBub2RlcyBmcm9tIGRvY3VtZW50IGludG8gbG9hZGVyIHF1ZXVlCiAgICBpbXBvcnRlci5wcmVsb2FkKGRvYyk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihkb2MpIHsKICAgIC8vIGFsbCBwcmVsb2FkYWJsZSBub2RlcyBpbiBpbkRvY3VtZW50CiAgICB2YXIgbm9kZXMgPSBkb2MucXVlcnlTZWxlY3RvckFsbChpbXBvcnRlci5wcmVsb2FkU2VsZWN0b3JzKTsKICAgIC8vIGZyb20gdGhlIG1haW4gZG9jdW1lbnQsIG9ubHkgbG9hZCBpbXBvcnRzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIG5vZGVzID0gdGhpcy5maWx0ZXJNYWluRG9jdW1lbnROb2Rlcyhkb2MsIG5vZGVzKTsKICAgIC8vIGV4dHJhIGxpbmsgbm9kZXMgZnJvbSB0ZW1wbGF0ZXMsIGZpbHRlciB0ZW1wbGF0ZXMgb3V0IG9mIHRoZSBub2RlcyBsaXN0CiAgICBub2RlcyA9IHRoaXMuZXh0cmFjdFRlbXBsYXRlTm9kZXMobm9kZXMpOwogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgZmlsdGVyTWFpbkRvY3VtZW50Tm9kZXM6IGZ1bmN0aW9uKGRvYywgbm9kZXMpIHsKICAgIGlmIChkb2MgPT09IGRvY3VtZW50KSB7CiAgICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgcmV0dXJuICFpc1NjcmlwdChuKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBleHRyYWN0VGVtcGxhdGVOb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIHZhciBleHRyYSA9IFtdOwogICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgaWYgKG4ubG9jYWxOYW1lID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgaWYgKG4uY29udGVudCkgewogICAgICAgICAgdmFyIGwkID0gbi5jb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpbmtbcmVsPScgKyBTVFlMRV9MSU5LX1RZUEUgKwogICAgICAgICAgICAnXScpOwogICAgICAgICAgaWYgKGwkLmxlbmd0aCkgewogICAgICAgICAgICBleHRyYSA9IGV4dHJhLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsJCwgMCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGlmIChleHRyYS5sZW5ndGgpIHsKICAgICAgbm9kZXMgPSBub2Rlcy5jb25jYXQoZXh0cmEpOwogICAgfQogICAgcmV0dXJuIG5vZGVzOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbih1cmwsIGVsdCwgcmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhlbHQpKSB7CiAgICAgIHZhciBkb2N1bWVudCA9IGltcG9ydGVyLmRvY3VtZW50c1t1cmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKTsKICAgICAgICAvLyByZXNvbHZlIHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTChkb2N1bWVudCk7CiAgICAgICAgLy8gY2FjaGUgZG9jdW1lbnQKICAgICAgICBpbXBvcnRlci5kb2N1bWVudHNbdXJsXSA9IGRvY3VtZW50OwogICAgICAgIC8vIGFkZCBub2RlcyBmcm9tIHRoaXMgZG9jdW1lbnQgdG8gdGhlIGxvYWRlciBxdWV1ZQogICAgICAgIGltcG9ydGVyLnByZWxvYWQoZG9jdW1lbnQpOwogICAgICB9CiAgICAgIC8vIHN0b3JlIGltcG9ydCByZWNvcmQKICAgICAgZWx0LmltcG9ydCA9IHsKICAgICAgICBocmVmOiB1cmwsCiAgICAgICAgb3duZXJOb2RlOiBlbHQsCiAgICAgICAgY29udGVudDogZG9jdW1lbnQKICAgICAgfTsKICAgICAgLy8gc3RvcmUgZG9jdW1lbnQgcmVzb3VyY2UKICAgICAgZWx0LmNvbnRlbnQgPSByZXNvdXJjZSA9IGRvY3VtZW50OwogICAgfQogICAgLy8gc3RvcmUgZ2VuZXJpYyByZXNvdXJjZQogICAgLy8gVE9ETyhzb3J2ZWxsKTogZmFpbHMgZm9yIG5vZGVzIGluc2lkZSA8dGVtcGxhdGU+LmNvbnRlbnQKICAgIC8vIHNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MjQ5MzgxLgogICAgZWx0Ll9fcmVzb3VyY2UgPSByZXNvdXJjZTsKICAgIC8vIGNzcyBwYXRoIGZpeHVwcwogICAgaWYgKGlzU3R5bGVzaGVldExpbmsoZWx0KSkgewogICAgICBwYXRoLnJlc29sdmVQYXRoc0luU3R5bGVzaGVldChlbHQpOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoZWx0LCBJTVBPUlRfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNTdHlsZXNoZWV0TGluayhlbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGVsdCwgU1RZTEVfTElOS19UWVBFKTsKfQoKZnVuY3Rpb24gaXNMaW5rUmVsKGVsdCwgcmVsKSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJyAmJiBlbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gcmVsOwp9CgpmdW5jdGlvbiBpc1NjcmlwdChlbHQpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ3NjcmlwdCc7Cn0KCmZ1bmN0aW9uIG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKSB7CiAgLy8gY3JlYXRlIGEgbmV3IEhUTUwgZG9jdW1lbnQKICB2YXIgZG9jID0gcmVzb3VyY2U7CiAgaWYgKCEoZG9jIGluc3RhbmNlb2YgRG9jdW1lbnQpKSB7CiAgICBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgICAvLyBpbnN0YWxsIGh0bWwKICAgIGRvYy5ib2R5LmlubmVySFRNTCA9IHJlc291cmNlOwogIH0KICAvLyBjYWNoZSB0aGUgbmV3IGRvY3VtZW50J3Mgc291cmNlIHVybAogIGRvYy5fVVJMID0gdXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkgfHwgZG9jdW1lbnQuVVJMKTsKICBkb2MuaGVhZC5hcHBlbmRDaGlsZChiYXNlKTsKICAvLyBUT0RPKHNvcnZlbGwpOiBpZGVhbGx5IHRoaXMgY29kZSBpcyBub3QgYXdhcmUgb2YgVGVtcGxhdGUgcG9seWZpbGwsCiAgLy8gYnV0IGZvciBub3cgdGhlIHBvbHlmaWxsIG5lZWRzIGhlbHAgdG8gYm9vdHN0cmFwIHRoZXNlIHRlbXBsYXRlcwogIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoZG9jKTsKICB9CiAgcmV0dXJuIGRvYzsKfQoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKG9uTG9hZCwgb25Db21wbGV0ZSkgewogIHRoaXMub25sb2FkID0gb25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IG9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIC8vIG51bWJlciBvZiB0cmFuc2FjdGlvbnMgdG8gY29tcGxldGUKICAgIHRoaXMuaW5mbGlnaHQgKz0gbm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKG5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oZWx0KSB7CiAgICB2YXIgdXJsID0gcGF0aC5ub2RlVXJsKGVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgZWx0KSkgewogICAgICAvLyBmZXRjaCB0aGlzIHJlc291cmNlCiAgICAgIHRoaXMuZmV0Y2godXJsLCBlbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbih1cmwsIGVsdCkgewogICAgaWYgKHRoaXMucGVuZGluZ1t1cmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1t1cmxdLnB1c2goZWx0KTsKICAgICAgLy8gZG9uJ3QgbmVlZCBmZXRjaAogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICh0aGlzLmNhY2hlW3VybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKHVybCwgZWx0LCBsb2FkZXIuY2FjaGVbdXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbdXJsXSA9IFtlbHRdOwogICAgLy8gbmVlZCBmZXRjaCAobm90IGEgZHVwZSkKICAgIHJldHVybiBmYWxzZTsKICB9LAogIGZldGNoOiBmdW5jdGlvbih1cmwsIGVsdCkgewogICAgdmFyIHJlY2VpdmVYaHIgPSBmdW5jdGlvbihlcnIsIHJlc291cmNlKSB7CiAgICAgIHRoaXMucmVjZWl2ZSh1cmwsIGVsdCwgZXJyLCByZXNvdXJjZSk7CiAgICB9LmJpbmQodGhpcyk7CiAgICB4aHIubG9hZCh1cmwsIHJlY2VpdmVYaHIpOwogICAgLy8gVE9ETyhzb3J2ZWxsKTogYmxvY2tlZCBvbgogICAgLy8gaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTI1NzIyMQogICAgLy8geGhyJ2luZyBmb3IgYSBkb2N1bWVudCBtYWtlcyBzY3JpcHRzIGluIGltcG9ydHMgcnVubmFibGU7IG90aGVyd2lzZQogICAgLy8gdGhleSBhcmUgbm90OyBob3dldmVyLCBpdCByZXF1aXJlcyB0aGF0IHdlIGhhdmUgZG9jdHlwZT1odG1sIGluCiAgICAvLyB0aGUgaW1wb3J0IHdoaWNoIGlzIHVuYWNjZXB0YWJsZS4gVGhpcyBpcyBvbmx5IG5lZWRlZCBvbiBDaHJvbWUKICAgIC8vIHRvIGF2b2lkIHRoZSBidWcgYWJvdmUuCiAgICAvKgogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGVsdCkpIHsKICAgICAgeGhyLmxvYWREb2N1bWVudCh1cmwsIHJlY2VpdmVYaHIpOwogICAgfSBlbHNlIHsKICAgICAgeGhyLmxvYWQodXJsLCByZWNlaXZlWGhyKTsKICAgIH0KICAgICovCiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbih1cmwsIGVsdCwgZXJyLCByZXNvdXJjZSkgewogICAgaWYgKCFlcnIpIHsKICAgICAgbG9hZGVyLmNhY2hlW3VybF0gPSByZXNvdXJjZTsKICAgIH0KICAgIGxvYWRlci5wZW5kaW5nW3VybF0uZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmICghZXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQodXJsLCBlLCByZXNvdXJjZSk7CiAgICAgIH0KICAgICAgdGhpcy50YWlsKCk7CiAgICB9LCB0aGlzKTsKICAgIGxvYWRlci5wZW5kaW5nW3VybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciBwYXRoID0gewogIG5vZGVVcmw6IGZ1bmN0aW9uKG5vZGUpIHsKICAgIHJldHVybiBwYXRoLnJlc29sdmVVcmwocGF0aC5kb2N1bWVudFVSTCwgcGF0aC5ocmVmT3JTcmMobm9kZSkpOwogIH0sCiAgaHJlZk9yU3JjOiBmdW5jdGlvbihub2RlKSB7CiAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoImhyZWYiKSB8fCBub2RlLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgfSwKICBkb2N1bWVudFVybEZyb21Ob2RlOiBmdW5jdGlvbihub2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oZG9jKSB7CiAgICB2YXIgdXJsID0gZG9jICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGRvYy5fVVJMIHx8IChkb2MuaW1wbCAmJiBkb2MuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBkb2MuYmFzZVVSSSB8fCBkb2MuVVJMKQogICAgICAgICAgICAgICAgfHwgJyc7CiAgICAvLyB0YWtlIG9ubHkgdGhlIGxlZnQgc2lkZSBpZiB0aGVyZSBpcyBhICMKICAgIHJldHVybiB1cmwuc3BsaXQoJyMnKVswXTsKICB9LAogIHJlc29sdmVVcmw6IGZ1bmN0aW9uKGJhc2VVcmwsIHVybCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwodXJsKSkgewogICAgICByZXR1cm4gdXJsOwogICAgfQogICAgcmV0dXJuIHRoaXMuY29tcHJlc3NVcmwodGhpcy51cmxUb1BhdGgoYmFzZVVybCkgKyB1cmwpOwogIH0sCiAgcmVzb2x2ZVJlbGF0aXZlVXJsOiBmdW5jdGlvbihiYXNlVXJsLCB1cmwpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKHVybCkpIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIHJldHVybiB0aGlzLm1ha2VEb2N1bWVudFJlbFBhdGgodGhpcy5yZXNvbHZlVXJsKGJhc2VVcmwsIHVybCkpOwogIH0sCiAgaXNBYnNVcmw6IGZ1bmN0aW9uKHVybCkgewogICAgcmV0dXJuIC8oXmRhdGE6KXwoXmh0dHBbc10/Oil8KF5cLykvLnRlc3QodXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oYmFzZVVybCkgewogICAgdmFyIHBhcnRzID0gYmFzZVVybC5zcGxpdCgiLyIpOwogICAgcGFydHMucG9wKCk7CiAgICBwYXJ0cy5wdXNoKCcnKTsKICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICBjb21wcmVzc1VybDogZnVuY3Rpb24odXJsKSB7CiAgICB2YXIgc2VhcmNoID0gJyc7CiAgICB2YXIgc2VhcmNoUG9zID0gdXJsLmluZGV4T2YoJz8nKTsKICAgIC8vIHF1ZXJ5IHN0cmluZyBpcyBub3QgcGFydCBvZiB0aGUgcGF0aAogICAgaWYgKHNlYXJjaFBvcyA+IC0xKSB7CiAgICAgIHNlYXJjaCA9IHVybC5zdWJzdHJpbmcoc2VhcmNoUG9zKTsKICAgICAgdXJsID0gdXJsLnN1YnN0cmluZyhzZWFyY2hQb3MsIDApOwogICAgfQogICAgdmFyIHBhcnRzID0gdXJsLnNwbGl0KCcvJyk7CiAgICBmb3IgKHZhciBpPTAsIHA7IGk8cGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgcCA9IHBhcnRzW2ldOwogICAgICBpZiAocCA9PT0gJy4uJykgewogICAgICAgIHBhcnRzLnNwbGljZShpLTEsIDIpOwogICAgICAgIGkgLT0gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHBhcnRzLmpvaW4oJy8nKSArIHNlYXJjaDsKICB9LAogIG1ha2VEb2N1bWVudFJlbFBhdGg6IGZ1bmN0aW9uKHVybCkgewogICAgLy8gdGVzdCB1cmwgYWdhaW5zdCBkb2N1bWVudCB0byBzZWUgaWYgd2UgY2FuIGNvbnN0cnVjdCBhIHJlbGF0aXZlIHBhdGgKICAgIHBhdGgudXJsRWx0LmhyZWYgPSB1cmw7CiAgICAvLyBJRSBkb2VzIG5vdCBzZXQgaG9zdCBpZiBzYW1lIGFzIGRvY3VtZW50CiAgICBpZiAoIXBhdGgudXJsRWx0Lmhvc3QgfHwgCiAgICAgICAgKHBhdGgudXJsRWx0Lmhvc3QgPT09IHdpbmRvdy5sb2NhdGlvbi5ob3N0ICYmCiAgICAgICAgcGF0aC51cmxFbHQucHJvdG9jb2wgPT09IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCkpIHsKICAgICAgcmV0dXJuIHRoaXMubWFrZVJlbFBhdGgocGF0aC5kb2N1bWVudFVSTCwgcGF0aC51cmxFbHQuaHJlZik7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdXJsOwogICAgfQogIH0sCiAgLy8gbWFrZSBhIHJlbGF0aXZlIHBhdGggZnJvbSBzb3VyY2UgdG8gdGFyZ2V0CiAgbWFrZVJlbFBhdGg6IGZ1bmN0aW9uKHNvdXJjZSwgdGFyZ2V0KSB7CiAgICB2YXIgcyA9IHNvdXJjZS5zcGxpdCgnLycpOwogICAgdmFyIHQgPSB0YXJnZXQuc3BsaXQoJy8nKTsKICAgIHdoaWxlIChzLmxlbmd0aCAmJiBzWzBdID09PSB0WzBdKXsKICAgICAgcy5zaGlmdCgpOwogICAgICB0LnNoaWZ0KCk7CiAgICB9CiAgICBmb3IodmFyIGkgPSAwLCBsID0gcy5sZW5ndGgtMTsgaSA8IGw7IGkrKykgewogICAgICB0LnVuc2hpZnQoJy4uJyk7CiAgICB9CiAgICB2YXIgciA9IHQuam9pbignLycpOwogICAgcmV0dXJuIHI7CiAgfSwKICByZXNvbHZlUGF0aHNJbkhUTUw6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgdXJsID0gdXJsIHx8IHBhdGguZG9jdW1lbnRVcmxGcm9tTm9kZShyb290KQogICAgcGF0aC5yZXNvbHZlQXR0cmlidXRlcyhyb290LCB1cmwpOwogICAgcGF0aC5yZXNvbHZlU3R5bGVFbHRzKHJvb3QsIHVybCk7CiAgICAvLyBoYW5kbGUgdGVtcGxhdGUuY29udGVudAogICAgdmFyIHRlbXBsYXRlcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbCgndGVtcGxhdGUnKTsKICAgIGlmICh0ZW1wbGF0ZXMpIHsKICAgICAgZm9yRWFjaCh0ZW1wbGF0ZXMsIGZ1bmN0aW9uKHQpIHsKICAgICAgICBpZiAodC5jb250ZW50KSB7CiAgICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTCh0LmNvbnRlbnQsIHVybCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVQYXRoc0luU3R5bGVzaGVldDogZnVuY3Rpb24oc2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoc2hlZXQpOwogICAgc2hlZXQuX19yZXNvdXJjZSA9IHBhdGgucmVzb2x2ZUNzc1RleHQoc2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgdmFyIHN0eWxlcyA9IHJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCB1cmwpOwogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVDc3NUZXh0OiBmdW5jdGlvbihjc3NUZXh0LCBiYXNlVXJsKSB7CiAgICByZXR1cm4gY3NzVGV4dC5yZXBsYWNlKC91cmxcKFteKV0qXCkvZywgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgLy8gZmluZCB0aGUgdXJsIHBhdGgsIGlnbm9yZSBxdW90ZXMgaW4gdXJsIHN0cmluZwogICAgICB2YXIgdXJsUGF0aCA9IG1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVJlbGF0aXZlVXJsKGJhc2VVcmwsIHVybFBhdGgpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKHJvb3QsIHVybCkgewogICAgLy8gc2VhcmNoIGZvciBhdHRyaWJ1dGVzIHRoYXQgaG9zdCB1cmxzCiAgICB2YXIgbm9kZXMgPSByb290ICYmIHJvb3QucXVlcnlTZWxlY3RvckFsbChVUkxfQVRUUlNfU0VMRUNUT1IpOwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICB0aGlzLnJlc29sdmVOb2RlQXR0cmlidXRlcyhuLCB1cmwpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9LAogIHJlc29sdmVOb2RlQXR0cmlidXRlczogZnVuY3Rpb24obm9kZSwgdXJsKSB7CiAgICBVUkxfQVRUUlMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBhdHRyID0gbm9kZS5hdHRyaWJ1dGVzW3ZdOwogICAgICBpZiAoYXR0ciAmJiBhdHRyLnZhbHVlICYmCiAgICAgICAgIChhdHRyLnZhbHVlLnNlYXJjaChVUkxfVEVNUExBVEVfU0VBUkNIKSA8IDApKSB7CiAgICAgICAgdmFyIHVybFBhdGggPSBwYXRoLnJlc29sdmVSZWxhdGl2ZVVybCh1cmwsIGF0dHIudmFsdWUpOwogICAgICAgIGF0dHIudmFsdWUgPSB1cmxQYXRoOwogICAgICB9CiAgICB9KTsKICB9Cn07CgpwYXRoLmRvY3VtZW50VVJMID0gcGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCk7CnBhdGgudXJsRWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwoKeGhyID0geGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24ocmVxdWVzdCkgewogICAgcmV0dXJuIChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKHJlcXVlc3Quc3RhdHVzID09PSAzMDQpCiAgICAgICAgfHwgKHJlcXVlc3Quc3RhdHVzID09PSAwKTsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHZhciByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBpZiAoc2NvcGUuZmxhZ3MuZGVidWcgfHwgc2NvcGUuZmxhZ3MuYnVzdCkgewogICAgICB1cmwgKz0gJz8nICsgTWF0aC5yYW5kb20oKTsKICAgIH0KICAgIHJlcXVlc3Qub3BlbignR0VUJywgdXJsLCB4aHIuYXN5bmMpOwogICAgcmVxdWVzdC5hZGRFdmVudExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09PSA0KSB7CiAgICAgICAgbmV4dC5jYWxsKG5leHRDb250ZXh0LCAheGhyLm9rKHJlcXVlc3QpICYmIHJlcXVlc3QsCiAgICAgICAgICByZXF1ZXN0LnJlc3BvbnNlLCB1cmwpOwogICAgICB9CiAgICB9KTsKICAgIHJlcXVlc3Quc2VuZCgpOwogICAgcmV0dXJuIHJlcXVlc3Q7CiAgfSwKICBsb2FkRG9jdW1lbnQ6IGZ1bmN0aW9uKHVybCwgbmV4dCwgbmV4dENvbnRleHQpIHsKICAgIHRoaXMubG9hZCh1cmwsIG5leHQsIG5leHRDb250ZXh0KS5yZXNwb25zZVR5cGUgPSAnZG9jdW1lbnQnOwogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCnNjb3BlLnBhdGggPSBwYXRoOwpzY29wZS54aHIgPSB4aHI7CnNjb3BlLmltcG9ydGVyID0gaW1wb3J0ZXI7CnNjb3BlLmdldERvY3VtZW50VXJsID0gcGF0aC5nZXREb2N1bWVudFVybDsKc2NvcGUuSU1QT1JUX0xJTktfVFlQRSA9IElNUE9SVF9MSU5LX1RZUEU7Cgp9KSh3aW5kb3cuSFRNTEltcG9ydHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIGltcG9ydFBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdsaW5rW3JlbD1zdHlsZXNoZWV0XScsCiAgICAnc3R5bGUnLAogICAgJ3NjcmlwdDpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIHN0eWxlOiAncGFyc2VHZW5lcmljJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRQYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgaW1wb3J0UGFyc2VyW2ltcG9ydFBhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgaW1wb3J0UGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyc2VHZW5lcmljKGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VHZW5lcmljOiBmdW5jdGlvbihlbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoZWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsdCk7CiAgICB9CiAgfSwKICBwYXJzZVNjcmlwdDogZnVuY3Rpb24oc2NyaXB0RWx0KSB7CiAgICBpZiAobmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KHNjcmlwdEVsdCkpIHsKICAgICAgLy8gYWNxdWlyZSBjb2RlIHRvIGV4ZWN1dGUKICAgICAgdmFyIGNvZGUgPSAoc2NyaXB0RWx0Ll9fcmVzb3VyY2UgfHwgc2NyaXB0RWx0LnRleHRDb250ZW50KS50cmltKCk7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgLy8gY2FsY3VsYXRlIHNvdXJjZSBtYXAgaGludAogICAgICAgIHZhciBtb25pa2VyID0gc2NyaXB0RWx0Ll9fbm9kZVVybDsKICAgICAgICBpZiAoIW1vbmlrZXIpIHsKICAgICAgICAgIHZhciBtb25pa2VyID0gc2NvcGUucGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHNjcmlwdEVsdCk7CiAgICAgICAgICAvLyB0aGVyZSBjb3VsZCBiZSBtb3JlIHRoYW4gb25lIHNjcmlwdCB0aGlzIHVybAogICAgICAgICAgdmFyIHRhZyA9ICdbJyArIE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkrMSkqMTAwMCkgKyAnXSc7CiAgICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBQb2x5bWVyIGhhY2ssIHNob3VsZCBiZSBwbHVnZ2FibGUgaWYgd2UgbmVlZCB0byBhbGxvdyAKICAgICAgICAgIC8vIHRoaXMgc29ydCBvZiB0aGluZwogICAgICAgICAgdmFyIG1hdGNoZXMgPSBjb2RlLm1hdGNoKC9Qb2x5bWVyXChbJyJdKFteJyJdKikvKTsKICAgICAgICAgIHRhZyA9IG1hdGNoZXMgJiYgbWF0Y2hlc1sxXSB8fCB0YWc7CiAgICAgICAgICAvLyB0YWcgdGhlIG1vbmlrZXIKICAgICAgICAgIG1vbmlrZXIgKz0gJy8nICsgdGFnICsgJy5qcyc7CiAgICAgICAgfQogICAgICAgIC8vIHNvdXJjZSBtYXAgaGludAogICAgICAgIGNvZGUgKz0gIlxuLy8jIHNvdXJjZVVSTD0iICsgbW9uaWtlciArICJcbiI7CiAgICAgICAgLy8gZXZhbHVhdGUgdGhlIGNvZGUKICAgICAgICBldmFsLmNhbGwod2luZG93LCBjb2RlKTsKICAgICAgfQogICAgfQogIH0KfTsKCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IElNUE9SVF9MSU5LX1RZUEU7Cn0KCmZ1bmN0aW9uIG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChub2RlKSB7CiAgLy8gbm9kZXMgY2FuIGJlIG1vdmVkIHRvIHRoZSBtYWluIGRvY3VtZW50OgogIC8vIGlmIHRoZXkgYXJlIGluIGEgdHJlZSBidXQgbm90IGluIHRoZSBtYWluIGRvY3VtZW50IGFuZCBub3QgY2hpbGRyZW4gb2YgPGVsZW1lbnQ+CiAgcmV0dXJuIG5vZGUucGFyZW50Tm9kZSAmJiAhaW5NYWluRG9jdW1lbnQobm9kZSkgCiAgICAgICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQobm9kZSk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGVsdCkgewogIHJldHVybiBlbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgZWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChlbHQpIHsKICByZXR1cm4gZWx0LnBhcmVudE5vZGUgJiYgZWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCc7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLnBhcnNlciA9IGltcG9ydFBhcnNlcjsKCn0pKEhUTUxJbXBvcnRzKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBIVE1MSW1wb3J0cy5pbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn07CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7CgovLyBpbXBvcnQKCnZhciBJTVBPUlRfTElOS19UWVBFID0gd2luZG93LkhUTUxJbXBvcnRzID8gSFRNTEltcG9ydHMuSU1QT1JUX0xJTktfVFlQRSA6ICdub25lJzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIHBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX3BhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX3BhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChwYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgcGFyc2VyW3BhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICAgIC8vIHVwZ3JhZGUgYWxsIHVwZ3JhZGVhYmxlIHN0YXRpYyBlbGVtZW50cywgYW55dGhpbmcgZHluYW1pY2FsbHkKICAgICAgLy8gY3JlYXRlZCBzaG91bGQgYmUgY2F1Z2h0IGJ5IG9ic2VydmVyCiAgICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgICAgLy8gb2JzZXJ2ZSBkb2N1bWVudCBmb3IgZG9tIGNoYW5nZXMKICAgICAgQ3VzdG9tRWxlbWVudHMub2JzZXJ2ZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICAvLyBpbXBvcnRzCiAgICBpZiAoaXNEb2N1bWVudExpbmsobGlua0VsdCkpIHsKICAgICAgdGhpcy5wYXJzZUltcG9ydChsaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlSW1wb3J0OiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgIHBhcnNlci5wYXJzZShsaW5rRWx0LmNvbnRlbnQpOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gcGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwpmdW5jdGlvbiBib290c3RyYXAoKSB7CiAgLy8gcGFyc2UgZG9jdW1lbnQKICBDdXN0b21FbGVtZW50cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogIC8vIG9uZSBtb3JlIHBhc3MgYmVmb3JlIHJlZ2lzdGVyIGlzICdsaXZlJwogIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChkb2N1bWVudCk7ICAKICAvLyBjaG9vc2UgYXN5bmMKICB2YXIgYXN5bmMgPSB3aW5kb3cuUGxhdGZvcm0gJiYgUGxhdGZvcm0uZW5kT2ZNaWNyb3Rhc2sgPyAKICAgIFBsYXRmb3JtLmVuZE9mTWljcm90YXNrIDoKICAgIHNldFRpbWVvdXQ7CiAgYXN5bmMoZnVuY3Rpb24oKSB7CiAgICAvLyBzZXQgaW50ZXJuYWwgJ3JlYWR5JyBmbGFnLCBub3cgZG9jdW1lbnQucmVnaXN0ZXIgd2lsbCB0cmlnZ2VyIAogICAgLy8gc3luY2hyb25vdXMgdXBncmFkZXMKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5ID0gdHJ1ZTsKICAgIC8vIGNhcHR1cmUgYmx1bnQgcHJvZmlsaW5nIGRhdGEKICAgIEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSA9IERhdGUubm93KCk7CiAgICBpZiAod2luZG93LkhUTUxJbXBvcnRzKSB7CiAgICAgIEN1c3RvbUVsZW1lbnRzLmVsYXBzZWQgPSBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgLSBIVE1MSW1wb3J0cy5yZWFkeVRpbWU7CiAgICB9CiAgICAvLyBub3RpZnkgdGhlIHN5c3RlbSB0aGF0IHdlIGFyZSBib290c3RyYXBwZWQKICAgIGRvY3VtZW50LmJvZHkuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdXZWJDb21wb25lbnRzUmVhZHknLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0pOwp9CgovLyBDdXN0b21FdmVudCBzaGltIGZvciBJRQppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgYm9vdHN0cmFwKCk7Cn0gZWxzZSB7CiAgdmFyIGxvYWRFdmVudCA9IHdpbmRvdy5IVE1MSW1wb3J0cyA/ICdIVE1MSW1wb3J0c0xvYWRlZCcgOiAnRE9NQ29udGVudExvYWRlZCc7CiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIobG9hZEV2ZW50LCBib290c3RyYXApOwp9Cgp9KSgpOwoNCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICB0cnVlb3AgPSBmdW5jdGlvbigpeyByZXR1cm4gdHJ1ZTsgfSwKICAgIHJlZ2V4UHNldWRvU3BsaXQgPSAvKFtcdy1dKyg/OlwoW15cKV0rXCkpPykvZywKICAgIHJlZ2V4UHNldWRvUmVwbGFjZSA9IC8oXHcqKSg/OlwoKFteXCldKilcKSk/LywKICAgIHJlZ2V4RGlnaXRzID0gLyhcZCspL2csCiAgICBrZXlwc2V1ZG8gPSB7CiAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICByZXR1cm4gcHNldWRvLnZhbHVlLm1hdGNoKHJlZ2V4RGlnaXRzKS5pbmRleE9mKFN0cmluZyhldmVudC5rZXlDb2RlKSkgPiAtMSA9PSAocHNldWRvLm5hbWUgPT0gJ2tleXBhc3MnKSB8fCBudWxsOwogICAgICB9CiAgICB9LAogICAgcHJlZml4ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHN0eWxlcyA9IHdpbi5nZXRDb21wdXRlZFN0eWxlKGRvYy5kb2N1bWVudEVsZW1lbnQsICcnKSwKICAgICAgICAgIHByZSA9IChBcnJheS5wcm90b3R5cGUuc2xpY2UKICAgICAgICAgICAgLmNhbGwoc3R5bGVzKQogICAgICAgICAgICAuam9pbignJykKICAgICAgICAgICAgLm1hdGNoKC8tKG1venx3ZWJraXR8bXMpLS8pIHx8IChzdHlsZXMuT0xpbmsgPT09ICcnICYmIFsnJywgJ28nXSkKICAgICAgICAgIClbMV07CiAgICAgIHJldHVybiB7CiAgICAgICAgZG9tOiBwcmUgPT0gJ21zJyA/ICdNUycgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZSA9PSAnbXMnID8gcHJlIDogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CiAgICB9KSgpLAogICAgbWF0Y2hTZWxlY3RvciA9IEVsZW1lbnQucHJvdG90eXBlLm1hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50LnByb3RvdHlwZVtwcmVmaXgubG93ZXJjYXNlICsgJ01hdGNoZXNTZWxlY3RvciddLAogICAgbXV0YXRpb24gPSB3aW4uTXV0YXRpb25PYnNlcnZlciB8fCB3aW5bcHJlZml4LmpzICsgJ011dGF0aW9uT2JzZXJ2ZXInXTsKCi8qKiogRnVuY3Rpb25zICoqKi8KCi8vIFV0aWxpdGllcwoKICB2YXIgdHlwZUNhY2hlID0ge30sCiAgICAgIHR5cGVTdHJpbmcgPSB0eXBlQ2FjaGUudG9TdHJpbmcsCiAgICAgIHR5cGVSZWdleHAgPSAvXHMoW2EtekEtWl0rKS87CiAgZnVuY3Rpb24gdHlwZU9mKG9iaikgewogICAgdmFyIHR5cGUgPSB0eXBlU3RyaW5nLmNhbGwob2JqKTsKICAgIHJldHVybiB0eXBlQ2FjaGVbdHlwZV0gfHwgKHR5cGVDYWNoZVt0eXBlXSA9IHR5cGUubWF0Y2godHlwZVJlZ2V4cClbMV0udG9Mb3dlckNhc2UoKSk7CiAgfQoKICBmdW5jdGlvbiBjbG9uZShpdGVtLCB0eXBlKXsKICAgIHZhciBmbiA9IGNsb25lW3R5cGUgfHwgdHlwZU9mKGl0ZW0pXTsKICAgIHJldHVybiBmbiA/IGZuKGl0ZW0pIDogaXRlbTsKICB9CiAgICBjbG9uZS5vYmplY3QgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgb2JqID0ge307CiAgICAgIGZvciAodmFyIGtleSBpbiBzcmMpIG9ialtrZXldID0gY2xvbmUoc3JjW2tleV0pOwogICAgICByZXR1cm4gb2JqOwogICAgfTsKICAgIGNsb25lLmFycmF5ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIGkgPSBzcmMubGVuZ3RoLCBhcnJheSA9IG5ldyBBcnJheShpKTsKICAgICAgd2hpbGUgKGktLSkgYXJyYXlbaV0gPSBjbG9uZShzcmNbaV0pOwogICAgICByZXR1cm4gYXJyYXk7CiAgICB9OwoKICB2YXIgdW5zbGljZWFibGUgPSBbJ3VuZGVmaW5lZCcsICdudWxsJywgJ251bWJlcicsICdib29sZWFuJywgJ3N0cmluZycsICdmdW5jdGlvbiddOwogIGZ1bmN0aW9uIHRvQXJyYXkob2JqKXsKICAgIHJldHVybiB1bnNsaWNlYWJsZS5pbmRleE9mKHR5cGVPZihvYmopKSA9PSAtMSA/CiAgICBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChvYmosIDApIDoKICAgIFtvYmpdOwogIH0KCi8vIERPTQoKICB2YXIgc3RyID0gJyc7CiAgZnVuY3Rpb24gcXVlcnkoZWxlbWVudCwgc2VsZWN0b3IpewogICAgcmV0dXJuIChzZWxlY3RvciB8fCBzdHIpLmxlbmd0aCA/IHRvQXJyYXkoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSkgOiBbXTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucykgewogICAgdmFyIGRpZmYgPSB7IGFkZGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgIHJlY29yZC5fbXV0YXRpb24gPSB0cnVlOwogICAgICBmb3IgKHZhciB6IGluIGRpZmYpIHsKICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQuX3JlY29yZHNbKHogPT0gJ2FkZGVkJykgPyAnaW5zZXJ0ZWQnIDogJ3JlbW92ZWQnXSwKICAgICAgICAgIG5vZGVzID0gcmVjb3JkW3ogKyAnTm9kZXMnXSwgbGVuZ3RoID0gbm9kZXMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoICYmIGRpZmZbel0uaW5kZXhPZihub2Rlc1tpXSkgPT0gLTE7IGkrKyl7CiAgICAgICAgICBkaWZmW3pdLnB1c2gobm9kZXNbaV0pOwogICAgICAgICAgdHlwZS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgZm4obm9kZXNbaV0sIHJlY29yZCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCi8vIE1peGlucwoKICBmdW5jdGlvbiBtZXJnZU9uZShzb3VyY2UsIGtleSwgY3VycmVudCl7CiAgICB2YXIgdHlwZSA9IHR5cGVPZihjdXJyZW50KTsKICAgIGlmICh0eXBlID09ICdvYmplY3QnICYmIHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIHh0YWcubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwogICAgZWxzZSBzb3VyY2Vba2V5XSA9IGNsb25lKGN1cnJlbnQsIHR5cGUpOwogICAgcmV0dXJuIHNvdXJjZTsKICB9CgogIGZ1bmN0aW9uIHdyYXBNaXhpbih0YWcsIGtleSwgcHNldWRvLCB2YWx1ZSwgb3JpZ2luYWwpewogICAgaWYgKHR5cGVvZiBvcmlnaW5hbFtrZXldICE9ICdmdW5jdGlvbicpIG9yaWdpbmFsW2tleV0gPSB2YWx1ZTsKICAgIGVsc2UgewogICAgICBvcmlnaW5hbFtrZXldID0geHRhZy53cmFwKG9yaWdpbmFsW2tleV0sIHh0YWcuYXBwbHlQc2V1ZG9zKHBzZXVkbywgdmFsdWUsIHRhZy5wc2V1ZG9zKSk7CiAgICB9CiAgfQoKICB2YXIgdW5pcXVlTWl4aW5Db3VudCA9IDA7CiAgZnVuY3Rpb24gbWVyZ2VNaXhpbih0YWcsIG1peGluLCBvcmlnaW5hbCwgbWl4KSB7CiAgICBpZiAobWl4KSB7CiAgICAgIHZhciB1bmlxdWVzID0ge307CiAgICAgIGZvciAodmFyIHogaW4gb3JpZ2luYWwpIHVuaXF1ZXNbei5zcGxpdCgnOicpWzBdXSA9IHo7CiAgICAgIGZvciAoeiBpbiBtaXhpbikgewogICAgICAgIHdyYXBNaXhpbih0YWcsIHVuaXF1ZXNbei5zcGxpdCgnOicpWzBdXSB8fCB6LCB6LCBtaXhpblt6XSwgb3JpZ2luYWwpOwogICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgZm9yICh2YXIgenogaW4gbWl4aW4pewogICAgICAgIHdyYXBNaXhpbih0YWcsIHp6ICsgJzpfX21peGluX18oJyArICh1bmlxdWVNaXhpbkNvdW50KyspICsgJyknLCB6eiwgbWl4aW5benpdLCBvcmlnaW5hbCk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGFwcGx5TWl4aW5zKHRhZykgewogICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBtaXhpbiA9IHh0YWcubWl4aW5zW25hbWVdOwogICAgICBmb3IgKHZhciB0eXBlIGluIG1peGluKSB7CiAgICAgICAgdmFyIGl0ZW0gPSBtaXhpblt0eXBlXSwKICAgICAgICAgICAgb3JpZ2luYWwgPSB0YWdbdHlwZV07CiAgICAgICAgaWYgKCFvcmlnaW5hbCkgdGFnW3R5cGVdID0gaXRlbTsKICAgICAgICBlbHNlIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSl7CiAgICAgICAgICAgIGNhc2UgJ2FjY2Vzc29ycyc6IGNhc2UgJ3Byb3RvdHlwZSc6CiAgICAgICAgICAgICAgZm9yICh2YXIgeiBpbiBpdGVtKSB7CiAgICAgICAgICAgICAgICBpZiAoIW9yaWdpbmFsW3pdKSBvcmlnaW5hbFt6XSA9IGl0ZW1bel07CiAgICAgICAgICAgICAgICBlbHNlIG1lcmdlTWl4aW4odGFnLCBpdGVtW3pdLCBvcmlnaW5hbFt6XSwgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OiBtZXJnZU1peGluKHRhZywgaXRlbSwgb3JpZ2luYWwsIHR5cGUgIT0gJ2V2ZW50cycpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gdGFnOwogIH0KCi8vIEV2ZW50cwoKICBmdW5jdGlvbiBkZWxlZ2F0ZUFjdGlvbihwc2V1ZG8sIGV2ZW50KSB7CiAgICB2YXIgbWF0Y2gsIHRhcmdldCA9IGV2ZW50LnRhcmdldDsKICAgIGlmICh4dGFnLm1hdGNoU2VsZWN0b3IodGFyZ2V0LCBwc2V1ZG8udmFsdWUpKSBtYXRjaCA9IHRhcmdldDsKICAgIGVsc2UgaWYgKHh0YWcubWF0Y2hTZWxlY3Rvcih0YXJnZXQsIHBzZXVkby52YWx1ZSArICcgKicpKSB7CiAgICAgIHZhciBwYXJlbnQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgd2hpbGUgKCFtYXRjaCkgewogICAgICAgIGlmICh4dGFnLm1hdGNoU2VsZWN0b3IocGFyZW50LCBwc2V1ZG8udmFsdWUpKSBtYXRjaCA9IHBhcmVudDsKICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hdGNoID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQobWF0Y2gpIDogbnVsbDsKICB9CgogIGZ1bmN0aW9uIHRvdWNoRmlsdGVyKGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZS5tYXRjaCgndG91Y2gnKSl7CiAgICAgIGV2ZW50LnRhcmdldC5fX3RvdWNoZWRfXyA9IHRydWU7CiAgICB9CiAgICBlbHNlIGlmIChldmVudC50YXJnZXQuX190b3VjaGVkX18gJiYgZXZlbnQudHlwZS5tYXRjaCgnbW91c2UnKSl7CiAgICAgIGRlbGV0ZSBldmVudC50YXJnZXQuX190b3VjaGVkX187CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmxvd0V2ZW50KHR5cGUpIHsKICAgIHZhciBmbG93ID0gdHlwZSA9PSAnb3Zlcic7CiAgICByZXR1cm4gewogICAgICBhdHRhY2g6ICdPdmVyZmxvd0V2ZW50JyBpbiB3aW4gPyAnb3ZlcmZsb3djaGFuZ2VkJyA6IFtdLAogICAgICBjb25kaXRpb246IGZ1bmN0aW9uIChldmVudCwgY3VzdG9tKSB7CiAgICAgICAgZXZlbnQuZmxvdyA9IHR5cGU7CiAgICAgICAgcmV0dXJuIGV2ZW50LnR5cGUgPT0gKHR5cGUgKyAnZmxvdycpIHx8CiAgICAgICAgKChldmVudC5vcmllbnQgPT09IDAgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAxICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDIgJiYgZXZlbnQuaG9yaXpvbnRhbE92ZXJmbG93ID09IGZsb3cgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiB3cml0ZVByb3BlcnR5KGtleSwgZXZlbnQsIGJhc2UsIGRlc2MpewogICAgaWYgKGRlc2MpIGV2ZW50W2tleV0gPSBiYXNlW2tleV07CiAgICBlbHNlIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShldmVudCwga2V5LCB7CiAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICB2YWx1ZTogYmFzZVtrZXldCiAgICB9KTsKICB9CgogIHZhciBza2lwUHJvcHMgPSB7fTsKICBmb3IgKHZhciB6IGluIGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpKSBza2lwUHJvcHNbel0gPSAxOwogIGZ1bmN0aW9uIGluaGVyaXRFdmVudChldmVudCwgYmFzZSl7CiAgICB2YXIgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZXZlbnQsICd0YXJnZXQnKTsKICAgIGZvciAodmFyIHogaW4gYmFzZSkgewogICAgICBpZiAoIXNraXBQcm9wc1t6XSkgd3JpdGVQcm9wZXJ0eSh6LCBldmVudCwgYmFzZSwgZGVzYyk7CiAgICB9CiAgICBldmVudC5iYXNlRXZlbnQgPSBiYXNlOwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBnZXRBcmdzKGF0dHIsIHZhbHVlKXsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLAogICAgICBtZXRob2Q6IGF0dHIuYm9vbGVhbiAmJiAhdmFsdWUgPyAncmVtb3ZlQXR0cmlidXRlJyA6ICdzZXRBdHRyaWJ1dGUnCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbW9kQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpOwogICAgZWxlbWVudFthcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzeW5jQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSwgbWV0aG9kKXsKICAgIHZhciBub2RlcyA9IGF0dHIucHJvcGVydHkgPyBbZWxlbWVudC54dGFnW2F0dHIucHJvcGVydHldXSA6IGF0dHIuc2VsZWN0b3IgPyB4dGFnLnF1ZXJ5KGVsZW1lbnQsIGF0dHIuc2VsZWN0b3IpIDogW10sCiAgICAgICAgaW5kZXggPSBub2Rlcy5sZW5ndGg7CiAgICB3aGlsZSAoaW5kZXgtLSkgbm9kZXNbaW5kZXhdW21ldGhvZF0obmFtZSwgdmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlVmlldyhlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICBpZiAoZWxlbWVudC5fX3ZpZXdfXyl7CiAgICAgIGVsZW1lbnQuX192aWV3X18udXBkYXRlQmluZGluZ1ZhbHVlKGVsZW1lbnQsIG5hbWUsIHZhbHVlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSl7CiAgICB2YXIga2V5ID0gei5zcGxpdCgnOicpLCB0eXBlID0ga2V5WzBdOwogICAgaWYgKHR5cGUgPT0gJ2dldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhY2Nlc3Nvclt6XSwgdGFnLnBzZXVkb3MpOwogICAgfQogICAgZWxzZSBpZiAodHlwZSA9PSAnc2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB2YXIgc2V0dGVyID0gdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSB4dGFnLmFwcGx5UHNldWRvcyhrZXkuam9pbignOicpLCBhdHRyID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIHRoaXMueHRhZy5fc2tpcFNldCA9IHRydWU7CiAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSBtb2RBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICBpZiAodGhpcy54dGFnLl9za2lwQXR0ciAmJiBhdHRyLnNraXApIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gISF2YWx1ZSA6IHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwU2V0OwogICAgICB9IDogYWNjZXNzb3Jbel0gPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH0gOiBudWxsLCB0YWcucHNldWRvcyk7CgogICAgICBpZiAoYXR0cikgYXR0ci5zZXR0ZXIgPSBzZXR0ZXI7CiAgICB9CiAgICBlbHNlIHRhZy5wcm90b3R5cGVbcHJvcF1bel0gPSBhY2Nlc3Nvclt6XTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQWNjZXNzb3IodGFnLCBwcm9wKXsKICAgIHRhZy5wcm90b3R5cGVbcHJvcF0gPSB7fTsKICAgIHZhciBhY2Nlc3NvciA9IHRhZy5hY2Nlc3NvcnNbcHJvcF0sCiAgICAgICAgYXR0ciA9IGFjY2Vzc29yLmF0dHJpYnV0ZSwKICAgICAgICBuYW1lID0gYXR0ciAmJiBhdHRyLm5hbWUgPyBhdHRyLm5hbWUudG9Mb3dlckNhc2UoKSA6IHByb3A7CgogICAgaWYgKGF0dHIpIHsKICAgICAgYXR0ci5rZXkgPSBwcm9wOwogICAgICB0YWcuYXR0cmlidXRlc1tuYW1lXSA9IGF0dHI7CiAgICB9CgogICAgZm9yICh2YXIgeiBpbiBhY2Nlc3NvcikgYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKTsKCiAgICBpZiAoYXR0cikgewogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0KSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IChhdHRyLmJvb2xlYW4gPyAnaGFzJyA6ICdnZXQnKSArICdBdHRyaWJ1dGUnOwogICAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiB0aGlzW21ldGhvZF0obmFtZSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIXRhZy5wcm90b3R5cGVbcHJvcF0uc2V0KSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBtb2RBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfTsKICAgIH0KICB9CgogIHZhciByZWFkeVRhZ3MgPSB7fTsKICBmdW5jdGlvbiBmaXJlUmVhZHkobmFtZSl7CiAgICByZWFkeVRhZ3NbbmFtZV0gPSAocmVhZHlUYWdzW25hbWVdIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24ob2JqKXsKICAgICAgcmV0dXJuIChvYmoudGFncyA9IG9iai50YWdzLmZpbHRlcihmdW5jdGlvbih6KXsKICAgICAgICByZXR1cm4geiAhPSBuYW1lICYmICF4dGFnLnRhZ3Nbel07CiAgICAgIH0pKS5sZW5ndGggfHwgb2JqLmZuKCk7CiAgICB9KTsKICB9CgovKioqIFgtVGFnIE9iamVjdCBEZWZpbml0aW9uICoqKi8KCiAgdmFyIHh0YWcgPSB7CiAgICB0YWdzOiB7fSwKICAgIGRlZmF1bHRPcHRpb25zOiB7CiAgICAgIHBzZXVkb3M6IFtdLAogICAgICBtaXhpbnM6IFtdLAogICAgICBldmVudHM6IHt9LAogICAgICBtZXRob2RzOiB7fSwKICAgICAgYWNjZXNzb3JzOiB7fSwKICAgICAgbGlmZWN5Y2xlOiB7fSwKICAgICAgYXR0cmlidXRlczoge30sCiAgICAgICdwcm90b3R5cGUnOiB7CiAgICAgICAgeHRhZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3h0YWdfXyA/IHRoaXMuX194dGFnX18gOiAodGhpcy5fX3h0YWdfXyA9IHsgZGF0YToge30gfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBfbmFtZTsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09ICdzdHJpbmcnKSB7CiAgICAgICAgX25hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBzYXZlIHByb3RvdHlwZSBmb3IgYWN0dWFsIG9iamVjdCBjcmVhdGlvbiBiZWxvdwogICAgICB2YXIgYmFzZVByb3RvdHlwZSA9IG9wdGlvbnMucHJvdG90eXBlOwogICAgICBkZWxldGUgb3B0aW9ucy5wcm90b3R5cGU7CgogICAgICB2YXIgdGFnID0geHRhZy50YWdzW19uYW1lXSA9IGFwcGx5TWl4aW5zKHh0YWcubWVyZ2Uoe30sIHh0YWcuZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKCiAgICAgIGZvciAodmFyIHogaW4gdGFnLmV2ZW50cykgdGFnLmV2ZW50c1t6XSA9IHh0YWcucGFyc2VFdmVudCh6LCB0YWcuZXZlbnRzW3pdKTsKICAgICAgZm9yICh6IGluIHRhZy5saWZlY3ljbGUpIHRhZy5saWZlY3ljbGVbei5zcGxpdCgnOicpWzBdXSA9IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5saWZlY3ljbGVbel0sIHRhZy5wc2V1ZG9zKTsKICAgICAgZm9yICh6IGluIHRhZy5tZXRob2RzKSB0YWcucHJvdG90eXBlW3ouc3BsaXQoJzonKVswXV0gPSB7IHZhbHVlOiB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubWV0aG9kc1t6XSwgdGFnLnBzZXVkb3MpLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGZvciAoeiBpbiB0YWcuYWNjZXNzb3JzKSBwYXJzZUFjY2Vzc29yKHRhZywgeik7CgogICAgICB2YXIgcmVhZHkgPSB0YWcubGlmZWN5Y2xlLmNyZWF0ZWQgfHwgdGFnLmxpZmVjeWNsZS5yZWFkeTsKICAgICAgdGFnLnByb3RvdHlwZS5jcmVhdGVkQ2FsbGJhY2sgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpczsKICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGFnLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lXSwKICAgICAgICAgICAgICAgIGhhc0F0dHIgPSB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgaWYgKGhhc0F0dHIgfHwgYXR0ci5ib29sZWFuKSB7CiAgICAgICAgICAgICAgdGhpc1thdHRyLmtleV0gPSBhdHRyLmJvb2xlYW4gPyBoYXNBdHRyIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhZy5wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5lbnRlcmVkVmlld0NhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLmxlZnREb2N1bWVudENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkLCBlbnVtZXJhYmxlOiB0cnVlIH07CgogICAgICB2YXIgc2V0QXR0cmlidXRlID0gdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICAgICAgdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSB7CiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHNldEF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIgJiYgIXRoaXMueHRhZy5fc2tpcFNldCkgewogICAgICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gdHJ1ZSA6IHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YWx1ZSA9IGF0dHIuc2tpcCA/IGF0dHIuYm9vbGVhbiA/IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgOiB2YWx1ZTsKICAgICAgICAgICAgc3luY0F0dHIodGhpcywgYXR0ciwgbmFtZSwgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwgJ3NldEF0dHJpYnV0ZScpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgICAgIHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gewogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHJlbW92ZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUpOwogICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyICYmICF0aGlzLnh0YWcuX3NraXBTZXQpIHsKICAgICAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IGZhbHNlIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzeW5jQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB1bmRlZmluZWQsICdyZW1vdmVBdHRyaWJ1dGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciBlbGVtZW50UHJvdG8gPSBiYXNlUHJvdG90eXBlID8KICAgICAgICAgICAgYmFzZVByb3RvdHlwZSA6CiAgICAgICAgICAgIG9wdGlvbnNbJ2V4dGVuZHMnXSA/CiAgICAgICAgICAgIE9iamVjdC5jcmVhdGUoZG9jLmNyZWF0ZUVsZW1lbnQob3B0aW9uc1snZXh0ZW5kcyddKS5jb25zdHJ1Y3RvcikucHJvdG90eXBlIDoKICAgICAgICAgICAgd2luLkhUTUxFbGVtZW50LnByb3RvdHlwZTsKCiAgICAgIHZhciBkZWZpbml0aW9uID0gewogICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKGVsZW1lbnRQcm90bywgdGFnLnByb3RvdHlwZSkKICAgICAgfTsKICAgICAgaWYgKG9wdGlvbnNbJ2V4dGVuZHMnXSkgewogICAgICAgIGRlZmluaXRpb25bJ2V4dGVuZHMnXSA9IG9wdGlvbnNbJ2V4dGVuZHMnXTsKICAgICAgfQogICAgICB2YXIgcmVnID0gZG9jLnJlZ2lzdGVyKF9uYW1lLCBkZWZpbml0aW9uKTsKICAgICAgZmlyZVJlYWR5KF9uYW1lKTsKICAgICAgcmV0dXJuIHJlZzsKICAgIH0sCiAgICAKICAgIHJlYWR5OiBmdW5jdGlvbihuYW1lcywgZm4pewogICAgICB2YXIgb2JqID0geyB0YWdzOiB0b0FycmF5KG5hbWVzKSwgZm46IGZuIH07CiAgICAgIGlmIChvYmoudGFncy5yZWR1Y2UoZnVuY3Rpb24obGFzdCwgbmFtZSl7CiAgICAgICAgaWYgKHh0YWcudGFnc1tuYW1lXSkgcmV0dXJuIGxhc3Q7CiAgICAgICAgKHJlYWR5VGFnc1tuYW1lXSA9IHJlYWR5VGFnc1tuYW1lXSB8fCBbXSkucHVzaChvYmopOwogICAgICB9LCB0cnVlKSkgZm4oKTsKICAgIH0sCiAgICAKICAgIC8qIEV4cG9zZWQgVmFyaWFibGVzICovCgogICAgbWl4aW5zOiB7fSwKICAgIHByZWZpeDogcHJlZml4LAogICAgY2FwdHVyZUV2ZW50czogWydmb2N1cycsICdibHVyJywgJ3Njcm9sbCcsICd1bmRlcmZsb3cnLCAnb3ZlcmZsb3cnLCAnb3ZlcmZsb3djaGFuZ2VkJywgJ0RPTU1vdXNlU2Nyb2xsJ10sCiAgICBjdXN0b21FdmVudHM6IHsKICAgICAgb3ZlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgnb3ZlcicpLAogICAgICB1bmRlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgndW5kZXInKSwKICAgICAgYW5pbWF0aW9uc3RhcnQ6IHsKICAgICAgICBhdHRhY2g6IFtwcmVmaXguZG9tICsgJ0FuaW1hdGlvblN0YXJ0J10KICAgICAgfSwKICAgICAgYW5pbWF0aW9uZW5kOiB7CiAgICAgICAgYXR0YWNoOiBbcHJlZml4LmRvbSArICdBbmltYXRpb25FbmQnXQogICAgICB9LAogICAgICB0cmFuc2l0aW9uZW5kOiB7CiAgICAgICAgYXR0YWNoOiBbcHJlZml4LmRvbSArICdUcmFuc2l0aW9uRW5kJ10KICAgICAgfSwKICAgICAgbW92ZTogewogICAgICAgIGF0dGFjaDogWydtb3VzZW1vdmUnLCAndG91Y2htb3ZlJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICBlbnRlcjogewogICAgICAgIGF0dGFjaDogWydtb3VzZW92ZXInLCAndG91Y2hlbnRlciddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgbGVhdmU6IHsKICAgICAgICBhdHRhY2g6IFsnbW91c2VvdXQnLCAndG91Y2hsZWF2ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgc2Nyb2xsd2hlZWw6IHsKICAgICAgICBhdHRhY2g6IFsnRE9NTW91c2VTY3JvbGwnLCAnbW91c2V3aGVlbCddLAogICAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgZXZlbnQuZGVsdGEgPSBldmVudC53aGVlbERlbHRhID8gZXZlbnQud2hlZWxEZWx0YSAvIDQwIDogTWF0aC5yb3VuZChldmVudC5kZXRhaWwgLyAzLjUgKiAtMSk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHRhcHN0YXJ0OiB7CiAgICAgICAgb2JzZXJ2ZTogewogICAgICAgICAgbW91c2Vkb3duOiBkb2MsCiAgICAgICAgICB0b3VjaHN0YXJ0OiBkb2MKICAgICAgICB9LAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW5kOiB7CiAgICAgICAgb2JzZXJ2ZTogewogICAgICAgICAgbW91c2V1cDogZG9jLAogICAgICAgICAgdG91Y2hlbmQ6IGRvYwogICAgICAgIH0sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBtb3ZlOiB7CiAgICAgICAgYXR0YWNoOiBbJ3RhcHN0YXJ0JywgJ2RyYWdlbmQnLCAndG91Y2hjYW5jZWwnXSwKICAgICAgICBjb25kaXRpb246IGZ1bmN0aW9uKGV2ZW50LCBjdXN0b20pewogICAgICAgICAgc3dpdGNoIChldmVudC50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgJ21vdmUnOiAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGNhc2UgJ2RyYWdvdmVyJzoKICAgICAgICAgICAgICB2YXIgbGFzdCA9IGN1c3RvbS5sYXN0RHJhZyB8fCB7fTsKICAgICAgICAgICAgICBjdXN0b20ubGFzdERyYWcgPSBldmVudDsKICAgICAgICAgICAgICByZXR1cm4gKGxhc3QucGFnZVggIT0gZXZlbnQucGFnZVggJiYgbGFzdC5wYWdlWSAhPSBldmVudC5wYWdlWSkgfHwgbnVsbDsKICAgICAgICAgICAgY2FzZSAndGFwc3RhcnQnOgogICAgICAgICAgICAgIGlmICghY3VzdG9tLm1vdmUpIHsKICAgICAgICAgICAgICAgIGN1c3RvbS5jdXJyZW50ID0gdGhpczsKICAgICAgICAgICAgICAgIGN1c3RvbS5tb3ZlID0geHRhZy5hZGRFdmVudHModGhpcywgewogICAgICAgICAgICAgICAgICBtb3ZlOiBjdXN0b20ubGlzdGVuZXIsCiAgICAgICAgICAgICAgICAgIGRyYWdvdmVyOiBjdXN0b20ubGlzdGVuZXIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgY3VzdG9tLnRhcGVuZCA9IHh0YWcuYWRkRXZlbnQoZG9jLCAndGFwZW5kJywgY3VzdG9tLmxpc3RlbmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3RhcGVuZCc6IGNhc2UgJ2RyYWdlbmQnOiBjYXNlICd0b3VjaGNhbmNlbCc6CiAgICAgICAgICAgICAgaWYgKCFldmVudC50b3VjaGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKGN1c3RvbS5tb3ZlKSB4dGFnLnJlbW92ZUV2ZW50cyhjdXN0b20uY3VycmVudCAsIGN1c3RvbS5tb3ZlIHx8IHt9KTsKICAgICAgICAgICAgICAgIGlmIChjdXN0b20udGFwZW5kKSB4dGFnLnJlbW92ZUV2ZW50KGRvYywgY3VzdG9tLnRhcGVuZCB8fCB7fSk7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLmxhc3REcmFnOwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS5jdXJyZW50OwogICAgICAgICAgICAgICAgZGVsZXRlIGN1c3RvbS50YXBlbmQ7CiAgICAgICAgICAgICAgICBkZWxldGUgY3VzdG9tLm1vdmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAgX19taXhpbl9fOiB7fSwKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7IGFjdGlvbjogZGVsZWdhdGVBY3Rpb24gfSwKICAgICAgd2l0aGluOiB7CiAgICAgICAgYWN0aW9uOiBkZWxlZ2F0ZUFjdGlvbiwKICAgICAgICBvbkFkZDogZnVuY3Rpb24ocHNldWRvKXsKICAgICAgICAgIHZhciBjb25kaXRpb24gPSBwc2V1ZG8uc291cmNlLmNvbmRpdGlvbjsKICAgICAgICAgIGlmIChjb25kaXRpb24pIHBzZXVkby5zb3VyY2UuY29uZGl0aW9uID0gZnVuY3Rpb24oZXZlbnQsIGN1c3RvbSl7CiAgICAgICAgICAgIHJldHVybiB4dGFnLnF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uKG5vZGUpewogICAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogbnVsbDsKICAgICAgICAgICAgfSlbMF0gPyBjb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCwgY3VzdG9tKSA6IG51bGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICBvdXRwdXQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICBmbi5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIHVpZDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDEwKTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgdmFyIGNhbGxiYWNrID0gZm4oKTsKICAgICAgcmV0dXJuIHh0YWcucmVxdWVzdEZyYW1lKGZ1bmN0aW9uKCl7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgICAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uKGZuKXsgcmV0dXJuIHdpbi5zZXRUaW1lb3V0KGZuLCAyMCk7IH07CiAgICAgIHJldHVybiBmdW5jdGlvbihmbil7IHJldHVybiByYWYoZm4pOyB9OwogICAgfSkoKSwKCiAgICBjYW5jZWxGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciBjYW5jZWwgPSB3aW4uY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ0NhbmNlbEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICAgICAgICAgICAgIHdpbi5jbGVhclRpbWVvdXQ7CiAgICAgIHJldHVybiBmdW5jdGlvbihpZCl7IHJldHVybiBjYW5jZWwoaWQpOyB9OwogICAgfSkoKSwKCiAgICBtYXRjaFNlbGVjdG9yOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIG1hdGNoU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3Rvcik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKGVsZW1lbnQsIG1ldGhvZCwgdmFsdWUpIHsKICAgICAgZWxlbWVudFttZXRob2RdID0gdmFsdWU7CiAgICAgIGlmICh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVBbGwoZWxlbWVudCk7CiAgICB9LAoKICAgIGlubmVySFRNTDogZnVuY3Rpb24oZWwsIGh0bWwpewogICAgICB4dGFnLnNldChlbCwgJ2lubmVySFRNTCcsIGh0bWwpOwogICAgfSwKCiAgICBoYXNDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiBlbGVtZW50LmNsYXNzTmFtZS5zcGxpdCgnICcpLmluZGV4T2Yoa2xhc3MudHJpbSgpKT4tMTsKICAgIH0sCgogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgbGlzdCA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBrbGFzcy50cmltKCkuc3BsaXQoJyAnKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgaWYgKCF+bGlzdC5pbmRleE9mKG5hbWUpKSBsaXN0LnB1c2gobmFtZSk7CiAgICAgIH0pOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGxpc3Quam9pbignICcpLnRyaW0oKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHJlbW92ZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGNsYXNzZXMgPSBrbGFzcy50cmltKCkuc3BsaXQoJyAnKTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKS5maWx0ZXIoZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gbmFtZSAmJiAhfmNsYXNzZXMuaW5kZXhPZihuYW1lKTsKICAgICAgfSkuam9pbignICcpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4geHRhZ1t4dGFnLmhhc0NsYXNzKGVsZW1lbnQsIGtsYXNzKSA/ICdyZW1vdmVDbGFzcycgOiAnYWRkQ2xhc3MnXS5jYWxsKG51bGwsIGVsZW1lbnQsIGtsYXNzKTsKICAgIH0sCgogICAgcXVlcnlDaGlsZHJlbjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBpZCA9IGVsZW1lbnQuaWQsCiAgICAgICAgZ3VpZCA9IGVsZW1lbnQuaWQgPSBpZCB8fCAneF8nICsgeHRhZy51aWQoKSwKICAgICAgICBhdHRyID0gJyMnICsgZ3VpZCArICcgPiAnOwogICAgICBzZWxlY3RvciA9IGF0dHIgKyAoc2VsZWN0b3IgKyAnJykucmVwbGFjZSgnLCcsICcsJyArIGF0dHIsICdnJyk7CiAgICAgIHZhciByZXN1bHQgPSBlbGVtZW50LnBhcmVudE5vZGUucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7CiAgICAgIGlmICghaWQpIGVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKCdpZCcpOwogICAgICByZXR1cm4gdG9BcnJheShyZXN1bHQpOwogICAgfSwKCiAgICBjcmVhdGVGcmFnbWVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB2YXIgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIGlmIChjb250ZW50KSB7CiAgICAgICAgdmFyIGRpdiA9IGZyYWcuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpKSwKICAgICAgICAgIG5vZGVzID0gdG9BcnJheShjb250ZW50Lm5vZGVOYW1lID8gYXJndW1lbnRzIDogIShkaXYuaW5uZXJIVE1MID0gY29udGVudCkgfHwgZGl2LmNoaWxkcmVuKSwKICAgICAgICAgIGxlbmd0aCA9IG5vZGVzLmxlbmd0aCwKICAgICAgICAgIGluZGV4ID0gMDsKICAgICAgICB3aGlsZSAoaW5kZXggPCBsZW5ndGgpIGZyYWcuaW5zZXJ0QmVmb3JlKG5vZGVzW2luZGV4KytdLCBkaXYpOwogICAgICAgIGZyYWcucmVtb3ZlQ2hpbGQoZGl2KTsKICAgICAgfQogICAgICByZXR1cm4gZnJhZzsKICAgIH0sCgogICAgbWFuaXB1bGF0ZTogZnVuY3Rpb24oZWxlbWVudCwgZm4pewogICAgICB2YXIgbmV4dCA9IGVsZW1lbnQubmV4dFNpYmxpbmcsCiAgICAgICAgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlLAogICAgICAgIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgIHJldHVybmVkID0gZm4uY2FsbChmcmFnLmFwcGVuZENoaWxkKGVsZW1lbnQpLCBmcmFnKSB8fCBlbGVtZW50OwogICAgICBpZiAobmV4dCkgcGFyZW50Lmluc2VydEJlZm9yZShyZXR1cm5lZCwgbmV4dCk7CiAgICAgIGVsc2UgcGFyZW50LmFwcGVuZENoaWxkKHJldHVybmVkKTsKICAgIH0sCgogICAgLyogUFNFVURPUyAqLwoKICAgIGFwcGx5UHNldWRvczogZnVuY3Rpb24oa2V5LCBmbiwgdGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXh0YWcucHNldWRvc1tuYW1lXSkgdGhyb3cgInBzZXVkbyBub3QgZm91bmQ6ICIgKyBuYW1lICsgIiAiICsgc3BsaXQ7CiAgICAgICAgICAgIHZhciBwc2V1ZG8gPSBwc2V1ZG9zW2ldID0gT2JqZWN0LmNyZWF0ZSh4dGFnLnBzZXVkb3NbbmFtZV0pOwogICAgICAgICAgICAgICAgcHNldWRvLmtleSA9IGtleTsKICAgICAgICAgICAgICAgIHBzZXVkby5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHBzZXVkby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgcHNldWRvWydhcmd1bWVudHMnXSA9ICh2YWx1ZSB8fCAnJykuc3BsaXQoJywnKTsKICAgICAgICAgICAgICAgIHBzZXVkby5hY3Rpb24gPSBwc2V1ZG8uYWN0aW9uIHx8IHRydWVvcDsKICAgICAgICAgICAgICAgIHBzZXVkby5zb3VyY2UgPSBzb3VyY2U7CiAgICAgICAgICAgIHZhciBsYXN0ID0gbGlzdGVuZXI7CiAgICAgICAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgICAgICAgb2JqID0gewogICAgICAgICAgICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgICAgICAgIHNvdXJjZTogc291cmNlLAogICAgICAgICAgICAgICAgICAgICdhcmd1bWVudHMnOiBwc2V1ZG9bJ2FyZ3VtZW50cyddLAogICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyOiBsYXN0CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdmFyIG91dHB1dCA9IHBzZXVkby5hY3Rpb24uYXBwbHkodGhpcywgW29ial0uY29uY2F0KGFyZ3MpKTsKICAgICAgICAgICAgICBpZiAob3V0cHV0ID09PSBudWxsIHx8IG91dHB1dCA9PT0gZmFsc2UpIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiBwc2V1ZG8ub25BZGQpIHsKICAgICAgICAgICAgICBpZiAodGFyZ2V0Lm5vZGVOYW1lKSBwc2V1ZG8ub25BZGQuY2FsbCh0YXJnZXQsIHBzZXVkbyk7CiAgICAgICAgICAgICAgZWxzZSB0YXJnZXQucHVzaChwc2V1ZG8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZm9yICh2YXIgeiBpbiBwc2V1ZG9zKSB7CiAgICAgICAgaWYgKHBzZXVkb3Nbel0ub25Db21waWxlZCkgbGlzdGVuZXIgPSBwc2V1ZG9zW3pdLm9uQ29tcGlsZWQobGlzdGVuZXIsIHBzZXVkb3Nbel0pIHx8IGxpc3RlbmVyOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcjsKICAgIH0sCgogICAgcmVtb3ZlUHNldWRvczogZnVuY3Rpb24odGFyZ2V0LCBwc2V1ZG9zKXsKICAgICAgcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgaWYgKG9iai5vblJlbW92ZSkgb2JqLm9uUmVtb3ZlLmNhbGwodGFyZ2V0LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICAgIGtleSA9IHBzZXVkb3Muc2hpZnQoKSwKICAgICAgICAgIGN1c3RvbSA9IHh0YWcuY3VzdG9tRXZlbnRzW2tleV0sCiAgICAgICAgICBldmVudCA9IHh0YWcubWVyZ2UoewogICAgICAgICAgICB0eXBlOiBrZXksCiAgICAgICAgICAgIHN0YWNrOiBub29wLAogICAgICAgICAgICBjb25kaXRpb246IHRydWVvcCwKICAgICAgICAgICAgYXR0YWNoOiBbXSwKICAgICAgICAgICAgX2F0dGFjaDogW10sCiAgICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgICBfcHNldWRvczogW10sCiAgICAgICAgICAgIG9uQWRkOiBub29wLAogICAgICAgICAgICBvblJlbW92ZTogbm9vcAogICAgICAgICAgfSwgY3VzdG9tIHx8IHt9KTsKICAgICAgZXZlbnQuYXR0YWNoID0gdG9BcnJheShldmVudC5iYXNlIHx8IGV2ZW50LmF0dGFjaCk7CiAgICAgIGV2ZW50LmNoYWluID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICB2YXIgY29uZGl0aW9uID0gZXZlbnQuY29uZGl0aW9uOwogICAgICBldmVudC5jb25kaXRpb24gPSBmdW5jdGlvbihlKXsKICAgICAgICB2YXIgdCA9IGUudG91Y2hlcywgdHQgPSBlLnRhcmdldFRvdWNoZXM7CiAgICAgICAgcmV0dXJuIGNvbmRpdGlvbi5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpOwogICAgICB9OwogICAgICB2YXIgc3RhY2sgPSB4dGFnLmFwcGx5UHNldWRvcyhldmVudC5jaGFpbiwgZm4sIGV2ZW50Ll9wc2V1ZG9zLCBldmVudCk7CiAgICAgIGV2ZW50LnN0YWNrID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIHQgPSBlLnRvdWNoZXMsIHR0ID0gZS50YXJnZXRUb3VjaGVzOwogICAgICAgIHZhciBkZXRhaWwgPSBlLmRldGFpbCB8fCB7fTsKICAgICAgICBpZiAoIWRldGFpbC5fX3N0YWNrX18pIHJldHVybiBzdGFjay5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpOwogICAgICAgIGVsc2UgaWYgKGRldGFpbC5fX3N0YWNrX18gPT0gc3RhY2spIHsKICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7CiAgICAgICAgICByZXR1cm4gc3RhY2suYXBwbHkodGhpcywgdG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGV2ZW50Lmxpc3RlbmVyID0gZnVuY3Rpb24oZSl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgIG91dHB1dCA9IGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCBhcmdzLmNvbmNhdChbZXZlbnRdKSk7CiAgICAgICAgaWYgKCFvdXRwdXQpIHJldHVybiBvdXRwdXQ7CiAgICAgICAgaWYgKGUudHlwZSAhPSBrZXkpIHsKICAgICAgICAgIHh0YWcuZmlyZUV2ZW50KGUudGFyZ2V0LCBrZXksIHsKICAgICAgICAgICAgYmFzZUV2ZW50OiBlLAogICAgICAgICAgICBkZXRhaWw6IG91dHB1dCAhPT0gdHJ1ZSAmJiAob3V0cHV0Ll9fc3RhY2tfXyA9IHN0YWNrKSA/IG91dHB1dCA6IHsgX19zdGFja19fOiBzdGFjayB9CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSByZXR1cm4gZXZlbnQuc3RhY2suYXBwbHkodGhpcywgYXJncyk7CiAgICAgIH07CiAgICAgIGV2ZW50LmF0dGFjaC5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICBldmVudC5fYXR0YWNoLnB1c2goeHRhZy5wYXJzZUV2ZW50KG5hbWUsIGV2ZW50Lmxpc3RlbmVyKSk7CiAgICAgIH0pOwogICAgICBpZiAoY3VzdG9tICYmIGN1c3RvbS5vYnNlcnZlICYmICFjdXN0b20uX19vYnNlcnZpbmdfXykgewogICAgICAgIGN1c3RvbS5vYnNlcnZlciA9IGZ1bmN0aW9uKGUpewogICAgICAgICAgdmFyIG91dHB1dCA9IGV2ZW50LmNvbmRpdGlvbi5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykuY29uY2F0KFtjdXN0b21dKSk7CiAgICAgICAgICBpZiAoIW91dHB1dCkgcmV0dXJuIG91dHB1dDsKICAgICAgICAgIHh0YWcuZmlyZUV2ZW50KGUudGFyZ2V0LCBrZXksIHsKICAgICAgICAgICAgYmFzZUV2ZW50OiBlLAogICAgICAgICAgICBkZXRhaWw6IG91dHB1dCAhPT0gdHJ1ZSA/IG91dHB1dCA6IHt9CiAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgICAgIGZvciAodmFyIHogaW4gY3VzdG9tLm9ic2VydmUpIHh0YWcuYWRkRXZlbnQoY3VzdG9tLm9ic2VydmVbel0gfHwgZG9jdW1lbnQsIHosIGN1c3RvbS5vYnNlcnZlciwgdHJ1ZSk7CiAgICAgICAgY3VzdG9tLl9fb2JzZXJ2aW5nX18gPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBmbiwgY2FwdHVyZSkgewogICAgICB2YXIgZXZlbnQgPSAodHlwZW9mIGZuID09ICdmdW5jdGlvbicpID8geHRhZy5wYXJzZUV2ZW50KHR5cGUsIGZuKSA6IGZuOwogICAgICBldmVudC5fcHNldWRvcy5mb3JFYWNoKGZ1bmN0aW9uKG9iail7CiAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGV2ZW50Ll9hdHRhY2guZm9yRWFjaChmdW5jdGlvbihvYmopIHsKICAgICAgICB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIG9iai50eXBlLCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQudHlwZSwgZXZlbnQuc3RhY2ssIGNhcHR1cmUgfHwgeHRhZy5jYXB0dXJlRXZlbnRzLmluZGV4T2YoZXZlbnQudHlwZSkgPiAtMSk7CiAgICAgIHJldHVybiBldmVudDsKICAgIH0sCgogICAgYWRkRXZlbnRzOiBmdW5jdGlvbiAoZWxlbWVudCwgb2JqKSB7CiAgICAgIHZhciBldmVudHMgPSB7fTsKICAgICAgZm9yICh2YXIgeiBpbiBvYmopIHsKICAgICAgICBldmVudHNbel0gPSB4dGFnLmFkZEV2ZW50KGVsZW1lbnQsIHosIG9ialt6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50czsKICAgIH0sCgogICAgcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uIChlbGVtZW50LCB0eXBlLCBldmVudCkgewogICAgICBldmVudCA9IGV2ZW50IHx8IHR5cGU7CiAgICAgIGV2ZW50Lm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgZXZlbnQsIGV2ZW50Lmxpc3RlbmVyKTsKICAgICAgeHRhZy5yZW1vdmVQc2V1ZG9zKGVsZW1lbnQsIGV2ZW50Ll9wc2V1ZG9zKTsKICAgICAgZXZlbnQuX2F0dGFjaC5mb3JFYWNoKGZ1bmN0aW9uKG9iaikgewogICAgICAgIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgb2JqKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudC50eXBlLCBldmVudC5zdGFjayk7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50czogZnVuY3Rpb24oZWxlbWVudCwgb2JqKXsKICAgICAgZm9yICh2YXIgeiBpbiBvYmopIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgb2JqW3pdKTsKICAgIH0sCgogICAgZmlyZUV2ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBvcHRpb25zLCB3YXJuKXsKICAgICAgdmFyIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpOwogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKHdhcm4pIGNvbnNvbGUud2FybignZmlyZUV2ZW50IGhhcyBiZWVuIG1vZGlmaWVkJyk7CiAgICAgIGV2ZW50LmluaXRDdXN0b21FdmVudCh0eXBlLAogICAgICAgIG9wdGlvbnMuYnViYmxlcyAhPT0gZmFsc2UsCiAgICAgICAgb3B0aW9ucy5jYW5jZWxhYmxlICE9PSBmYWxzZSwKICAgICAgICBvcHRpb25zLmRldGFpbAogICAgICApOwogICAgICBpZiAob3B0aW9ucy5iYXNlRXZlbnQpIGluaGVyaXRFdmVudChldmVudCwgb3B0aW9ucy5iYXNlRXZlbnQpOwogICAgICB0cnkgeyBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOyB9CiAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdUaGlzIGVycm9yIG1heSBoYXZlIGJlZW4gY2F1c2VkIGJ5IGEgY2hhbmdlIGluIHRoZSBmaXJlRXZlbnQgbWV0aG9kJywgZSk7CiAgICAgIH0KICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CiAgICAKICB9OwoKLyoqKiBVbml2ZXJzYWwgVG91Y2ggKioqLwoKdmFyIHRvdWNoaW5nID0gZmFsc2UsCiAgICB0b3VjaFRhcmdldCA9IG51bGw7Cgpkb2MuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZnVuY3Rpb24oZSl7CiAgdG91Y2hpbmcgPSB0cnVlOwogIHRvdWNoVGFyZ2V0ID0gZS50YXJnZXQ7Cn0sIHRydWUpOwoKZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBmdW5jdGlvbigpewogIHRvdWNoaW5nID0gZmFsc2U7CiAgdG91Y2hUYXJnZXQgPSBudWxsOwp9LCB0cnVlKTsKCmRvYy5hZGRFdmVudExpc3RlbmVyKCdkcmFnZW5kJywgZnVuY3Rpb24oKXsKICB0b3VjaGluZyA9IGZhbHNlOwogIHRvdWNoVGFyZ2V0ID0gbnVsbDsKfSwgdHJ1ZSk7Cgp2YXIgVUlFdmVudFByb3RvID0gewogIHRvdWNoZXM6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMuX190b3VjaGVzX18gfHwKICAgICAgICAodGhpcy5pZGVudGlmaWVyID0gMCkgfHwKICAgICAgICAodGhpcy5fX3RvdWNoZXNfXyA9IHRvdWNoaW5nID8gW3RoaXNdIDogW10pOwogICAgfQogIH0sCiAgdGFyZ2V0VG91Y2hlczogewogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5fX3RhcmdldFRvdWNoZXNfXyB8fCAodGhpcy5fX3RhcmdldFRvdWNoZXNfXyA9CiAgICAgICAgKHRvdWNoaW5nICYmIHRoaXMuY3VycmVudFRhcmdldCAmJgogICAgICAgICh0aGlzLmN1cnJlbnRUYXJnZXQgPT0gdG91Y2hUYXJnZXQgfHwKICAgICAgICAodGhpcy5jdXJyZW50VGFyZ2V0LmNvbnRhaW5zICYmIHRoaXMuY3VycmVudFRhcmdldC5jb250YWlucyh0b3VjaFRhcmdldCkpKSkgPyAodGhpcy5pZGVudGlmaWVyID0gMCkgfHwgW3RoaXNdIDogW10pOwogICAgfQogIH0sCiAgY2hhbmdlZFRvdWNoZXM6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGdldDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMuX19jaGFuZ2VkVG91Y2hlc19fIHx8ICh0aGlzLmlkZW50aWZpZXIgPSAwKSB8fCAodGhpcy5fX2NoYW5nZWRUb3VjaGVzX18gPSBbdGhpc10pOwogICAgfQogIH0KfTsKCmZvciAoeiBpbiBVSUV2ZW50UHJvdG8pewogIFVJRXZlbnQucHJvdG90eXBlW3pdID0gVUlFdmVudFByb3RvW3pdOwogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShVSUV2ZW50LnByb3RvdHlwZSwgeiwgVUlFdmVudFByb3RvW3pdKTsKfQoKdmFyIHRvdWNoUmVzZXQgPSB7CiAgICB2YWx1ZTogbnVsbCwKICAgIHdyaXRhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlCiAgfSwKICBUb3VjaEV2ZW50UHJvdG8gPSB7CiAgICB0b3VjaGVzOiB0b3VjaFJlc2V0LAogICAgdGFyZ2V0VG91Y2hlczogdG91Y2hSZXNldCwKICAgIGNoYW5nZWRUb3VjaGVzOiB0b3VjaFJlc2V0CiAgfTsKCmlmICh3aW4uVG91Y2hFdmVudCkgewogIGZvciAoeiBpbiBUb3VjaEV2ZW50UHJvdG8pIHsKICAgIHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW4uVG91Y2hFdmVudC5wcm90b3R5cGUsIHopOwogICAgaWYgKGRlc2MpIHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZVt6XSA9IFRvdWNoRXZlbnRQcm90b1t6XTsKICAgIGVsc2UgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbi5Ub3VjaEV2ZW50LnByb3RvdHlwZSwgeiwgVG91Y2hFdmVudFByb3RvW3pdKTsKICB9Cn0KCi8qKiogQ3VzdG9tIEV2ZW50IERlZmluaXRpb25zICoqKi8KCiAgZnVuY3Rpb24gYWRkVGFwKGVsLCB0YXAsIGUpewogICAgaWYgKCFlbC5fX3RhcF9fKSB7CiAgICAgIGVsLl9fdGFwX18gPSB7IGNsaWNrOiBlLnR5cGUgPT0gJ21vdXNlZG93bicgfTsKICAgICAgaWYgKGVsLl9fdGFwX18uY2xpY2spIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGFwLm9ic2VydmVyKTsKICAgICAgZWxzZSB7CiAgICAgICAgZWwuX190YXBfXy5zY3JvbGwgPSB0YXAub2JzZXJ2ZXIuYmluZChlbCk7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIGVsLl9fdGFwX18uc2Nyb2xsLCB0cnVlKTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0YXAub2JzZXJ2ZXIpOwogICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRhcC5vYnNlcnZlcik7CiAgICAgIH0KICAgIH0KICAgIGlmICghZWwuX190YXBfXy5jbGljaykgewogICAgICBlbC5fX3RhcF9fLnggPSBlLnRvdWNoZXNbMF0ucGFnZVg7CiAgICAgIGVsLl9fdGFwX18ueSA9IGUudG91Y2hlc1swXS5wYWdlWTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRhcChlbCwgdGFwKXsKICAgIGlmIChlbC5fX3RhcF9fKSB7CiAgICAgIGlmIChlbC5fX3RhcF9fLmNsaWNrKSBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRhcC5vYnNlcnZlcik7CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCBlbC5fX3RhcF9fLnNjcm9sbCwgdHJ1ZSk7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGFwLm9ic2VydmVyKTsKICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRhcC5vYnNlcnZlcik7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0YXAub2JzZXJ2ZXIpOwogICAgICB9CiAgICAgIGRlbGV0ZSBlbC5fX3RhcF9fOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY2hlY2tUYXBQb3NpdGlvbihlbCwgdGFwLCBlKXsKICAgIHZhciB0b3VjaCA9IGUuY2hhbmdlZFRvdWNoZXNbMF0sCiAgICAgICAgdG9sID0gdGFwLmdlc3R1cmUudG9sZXJhbmNlOwogICAgaWYgKAogICAgICB0b3VjaC5wYWdlWCA8IGVsLl9fdGFwX18ueCArIHRvbCAmJgogICAgICB0b3VjaC5wYWdlWCA+IGVsLl9fdGFwX18ueCAtIHRvbCAmJgogICAgICB0b3VjaC5wYWdlWSA8IGVsLl9fdGFwX18ueSArIHRvbCAmJgogICAgICB0b3VjaC5wYWdlWSA+IGVsLl9fdGFwX18ueSAtIHRvbAogICAgKSByZXR1cm4gdHJ1ZTsKICB9CgogIHh0YWcuY3VzdG9tRXZlbnRzLnRhcCA9IHsKICAgIG9ic2VydmU6IHsKICAgICAgbW91c2Vkb3duOiBkb2N1bWVudCwKICAgICAgdG91Y2hzdGFydDogZG9jdW1lbnQKICAgIH0sCiAgICBnZXN0dXJlOiB7CiAgICAgIHRvbGVyYW5jZTogOAogICAgfSwKICAgIGNvbmRpdGlvbjogZnVuY3Rpb24oZSwgdGFwKXsKICAgICAgdmFyIGVsID0gZS50YXJnZXQ7CiAgICAgIHN3aXRjaCAoZS50eXBlKSB7CiAgICAgICAgY2FzZSAndG91Y2hzdGFydCc6CiAgICAgICAgICBpZiAoZWwuX190YXBfXyAmJiBlbC5fX3RhcF9fLmNsaWNrKSByZW1vdmVUYXAoZWwsIHRhcCk7CiAgICAgICAgICBhZGRUYXAoZWwsIHRhcCwgZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgY2FzZSAnbW91c2Vkb3duJzoKICAgICAgICAgIGlmICghZWwuX190YXBfXykgYWRkVGFwKGVsLCB0YXAsIGUpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIGNhc2UgJ3Njcm9sbCc6CiAgICAgICAgY2FzZSAndG91Y2hjYW5jZWwnOgogICAgICAgICAgcmVtb3ZlVGFwKHRoaXMsIHRhcCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgY2FzZSAndG91Y2htb3ZlJzoKICAgICAgICBjYXNlICd0b3VjaGVuZCc6CiAgICAgICAgICBpZiAodGhpcy5fX3RhcF9fICYmICFjaGVja1RhcFBvc2l0aW9uKHRoaXMsIHRhcCwgZSkpIHsKICAgICAgICAgICAgcmVtb3ZlVGFwKHRoaXMsIHRhcCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlLnR5cGUgPT0gJ3RvdWNoZW5kJyB8fCBudWxsOwogICAgICAgIGNhc2UgJ2NsaWNrJzoKICAgICAgICAgIHJlbW92ZVRhcCh0aGlzLCB0YXApOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgIH0KICB9OwoKICB3aW4ueHRhZyA9IHh0YWc7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoeHRhZyk7CiAgCiAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ1dlYkNvbXBvbmVudHNSZWFkeScsIGZ1bmN0aW9uKCl7CiAgICB4dGFnLmZpcmVFdmVudChkb2MuYm9keSwgJ0RPTUNvbXBvbmVudHNMb2FkZWQnKTsKICB9KTsKCn0pKCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:44:54 GMT",
                    "Content-Length": "95649",
                    "Date": "Sun, 09 Nov 2014 03:44:54 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}