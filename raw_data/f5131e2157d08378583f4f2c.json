{
    "url": "http://localhost:9999/janpaepke/ScrollMagic/docs/jquery.scrollmagic.js.html",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location.hash</b> and written to <b>$()</b> via the following statement:<ul><li>$(\"dt h4.member-collapsed[id='\" + window.location.hash.substring(1).replace(\":\", \"\\\\:\") +\"']\").trigger(\"click\", skipAni);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/janpaepke/ScrollMagic/docs/jquery.scrollmagic.js.html",
                "path": "/janpaepke/ScrollMagic/docs/jquery.scrollmagic.js.html",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qYW5wYWVwa2UvU2Nyb2xsTWFnaWMvZG9jcy9qcXVlcnkuc2Nyb2xsbWFnaWMuanMuaHRtbCBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTA1ODIxDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiB0ZXh0L2h0bWw7IGNoYXJzZXQ9dXRmLTgNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDQ6MDg6NTYgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjA4OjU1IEdNVA0KDQo8IURPQ1RZUEUgaHRtbD4KCjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+Cgk8bWV0YSBjaGFyc2V0PSJ1dGYtOCI+Cgk8dGl0bGU+U2Nyb2xsTWFnaWMgU291cmNlOiBqcXVlcnkuc2Nyb2xsbWFnaWMuanM8L3RpdGxlPgoJCiAgPHNjcmlwdCBzcmM9InNjcmlwdHMvcHJldHRpZnkvcHJldHRpZnkuanMiPiA8L3NjcmlwdD4KICA8c2NyaXB0IHNyYz0ic2NyaXB0cy9wcmV0dGlmeS9sYW5nLWNzcy5qcyI+IDwvc2NyaXB0PgoJPCEtLVtpZiBsdCBJRSA5XT4KCTxzY3JpcHQgc3JjPSIvL2h0bWw1c2hpdi5nb29nbGVjb2RlLmNvbS9zdm4vdHJ1bmsvaHRtbDUuanMiPjwvc2NyaXB0PgoJPCFbZW5kaWZdLS0+Cgk8bGluayB0eXBlPSJ0ZXh0L2NzcyIgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJzdHlsZXMvc3VubGlnaHQuZGVmYXVsdC5jc3MiPgoJPGxpbmsgdHlwZT0idGV4dC9jc3MiIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0ic3R5bGVzL3ByZXR0aWZ5LXRvbW9ycm93LmNzcyI+Cgk8bGluayByZWw9InNob3J0Y3V0IGljb24iIGhyZWY9Ii4uL2ltZy9mYXZpY29uLmljbyIgdHlwZT0iaW1hZ2UveC1pY29uIj4KCgkKCTxsaW5rIHR5cGU9InRleHQvY3NzIiByZWw9InN0eWxlc2hlZXQiIGhyZWY9InN0eWxlcy9zaXRlLmNvc21vLmNzcyI+CgkKPC9oZWFkPgoKPGJvZHk+CjxkaXYgY2xhc3M9ImNvbnRhaW5lci1mbHVpZCI+Cgk8ZGl2IGNsYXNzPSJuYXZiYXIgbmF2YmFyLWZpeGVkLXRvcCBuYXZiYXItaW52ZXJzZSI+CgkJPGRpdiBjbGFzcz0ibmF2YmFyLWlubmVyIj4KCQkJPGEgY2xhc3M9ImJyYW5kIiBocmVmPSJpbmRleC5odG1sIj5TY3JvbGxNYWdpYzwvYT4KCQkJPHVsIGNsYXNzPSJuYXYiPgoJCQkJCgkJCQk8bGkgY2xhc3M9ImRyb3Bkb3duIj4KCQkJCQk8YSBocmVmPSJjbGFzc2VzLmxpc3QuaHRtbCIgY2xhc3M9ImRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj5DbGFzc2VzPGIKCQkJCQkJY2xhc3M9ImNhcmV0Ij48L2I+PC9hPgoKCQkJCQk8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUgIj4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbE1hZ2ljLmh0bWwiPlNjcm9sbE1hZ2ljPC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCI+U2Nyb2xsU2NlbmU8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoKCQkJCQk8L3VsPgoJCQkJPC9saT4KCQkJCQoJCQkJPGxpIGNsYXNzPSJkcm9wZG93biI+CgkJCQkJPGEgaHJlZj0iZXZlbnRzLmxpc3QuaHRtbCIgY2xhc3M9ImRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj5FdmVudHM8YgoJCQkJCQljbGFzcz0iY2FyZXQiPjwvYj48L2E+CgoJCQkJCTx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSAiPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCNldmVudDpjaGFuZ2UiPmNoYW5nZTwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6ZGVzdHJveSI+ZGVzdHJveTwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6ZW5kIj5lbmQ8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OmVudGVyIj5lbnRlcjwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6bGVhdmUiPmxlYXZlPC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCNldmVudDpwcm9ncmVzcyI+cHJvZ3Jlc3M8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OnNoaWZ0Ij5zaGlmdDwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6c3RhcnQiPnN0YXJ0PC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCNldmVudDp1cGRhdGUiPnVwZGF0ZTwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgoJCQkJCTwvdWw+CgkJCQk8L2xpPgoJCQkJCgkJCTwvdWw+CgkJPC9kaXY+Cgk8L2Rpdj4KCgk8ZGl2IGNsYXNzPSJyb3ctZmx1aWQiPgoKCQkKCQkJPGRpdiBjbGFzcz0ic3BhbjEyIj4KCQkJCQoJCQkJPGRpdiBpZD0ibWFpbiI+CgkJCQkJCgoKCQk8aDEgY2xhc3M9InBhZ2UtdGl0bGUiPlNvdXJjZToganF1ZXJ5LnNjcm9sbG1hZ2ljLmpzPC9oMT4KICAgIAogICAgPHNlY3Rpb24+CiAgICAgICAgPGFydGljbGU+CiAgICAgICAgICAgIDxwcmUgY2xhc3M9InN1bmxpZ2h0LWhpZ2hsaWdodC1qYXZhc2NyaXB0IGxpbmVudW1zIj4vKg0KU2Nyb2xsTWFnaWMgdjEuMi4zDQpUaGUgalF1ZXJ5IHBsdWdpbiBmb3IgZG9pbmcgbWFnaWNhbCBzY3JvbGwgaW50ZXJhY3Rpb25zLg0KKGMpIDIwMTQgSmFuIFBhZXBrZSAoQGphbnBhZXBrZSkNCkxpY2Vuc2UgJmFtcDsgSW5mbzogaHR0cDovL2phbnBhZXBrZS5naXRodWIuaW8vU2Nyb2xsTWFnaWMNCgkNCkluc3BpcmVkIGJ5IGFuZCBwYXJ0aWFsbHkgYmFzZWQgb24gU1VQRVJTQ1JPTExPUkFNQSBieSBKb2huIFBvbGFjZWsgKEBqb2hucG9sYWNlaykNCmh0dHA6Ly9qb2hucG9sYWNlay5naXRodWIuY29tL3N1cGVyc2Nyb2xsb3JhbWEvDQoNClBvd2VyZWQgYnkgdGhlIEdyZWVuc29jayBUd2VlbmluZyBQbGF0Zm9ybSAoR1NBUCk6IGh0dHA6Ly93d3cuZ3JlZW5zb2NrLmNvbS9qcw0KR3JlZW5zb2NrIExpY2Vuc2UgaW5mbyBhdCBodHRwOi8vd3d3LmdyZWVuc29jay5jb20vbGljZW5zaW5nLw0KKi8KLyoqDQpAb3ZlcnZpZXcJIyNJbmZvDQpAdmVyc2lvbgkxLjIuMw0KQGxpY2Vuc2UJRHVhbCBsaWNlbnNlZCB1bmRlciBNSVQgbGljZW5zZSBhbmQgR1BMLg0KQGF1dGhvcgkJSmFuIFBhZXBrZSAtIGUtbWFpbEBqYW5wYWVwa2UuZGUNCg0KQHRvZG86IGVuaGFuY2VtZW50OiByZW1vdmUgZGVwZW5kZW5jaWVzIGFuZCBtb3ZlIHRvIHBsdWdpbnMgLT4gMi4wDQpAdG9kbzogYnVnOiB3aGVuIGNhc2NhZGluZyBwaW5zIChwaW5uaW5nIG9uZSBlbGVtZW50IG11bHRpcGxlIHRpbWVzKSBhbmQgbGF0ZXIgcmVtb3ZpbmcgdGhlbSB3aXRob3V0IHJlc2V0LCBwb3NpdGlvbmluZyBlcnJvcnMgb2NjdXIuDQpAdG9kbzogYnVnOiBoYXZpbmcgbXVsdGlwbGUgc2Nyb2xsIGRpcmVjdGlvbnMgd2l0aCBjYXNjYWRlZCBwaW5zIGRvZXNuJ3Qgd29yayAob25lIHNjcm9sbCB2ZXJ0aWNhbCwgb25lIGhvcml6b250YWwpDQpAdG9kbzogZmVhdHVyZTogb3B0aW1pemUgcGVyZm9ybWFuY2Ugb24gZGVidWcgcGx1Z2luIChodWdlIGRyYXdiYWNrcywgd2hlbiB1c2luZyBtYW55IHNjZW5lcykNCiovDQooZnVuY3Rpb24ocm9vdCkgew0KCQ0KCSJ1c2Ugc3RyaWN0IjsNCg0KCXZhciBkZWZpbmUgPSByb290LmRlZmluZSwgU2Nyb2xsTWFnaWMsIFNjcm9sbFNjZW5lOw0KICBTY3JvbGxTY2VuZSA9IFNjcm9sbE1hZ2ljID0gZnVuY3Rpb24gKCkge307DQogIGlmICh0eXBlb2YgZGVmaW5lICE9PSAnZnVuY3Rpb24nIHx8ICFkZWZpbmUuYW1kKSB7DQogIAkvLyBObyBBTUQgbG9hZGVyIC0+IFByb3ZpZGUgY3VzdG9tIG1ldGhvZCB0byB0byByZWdpc3RlciBicm93c2VyIGdsb2JhbHMgaW5zdGVhZA0KICAJZGVmaW5lID0gZnVuY3Rpb24gKG1vZHVsZU5hbWUsIGRlcGVuZGVuY2llcywgZmFjdG9yeSkgew0KICAJCWZvciAodmFyIHggPSAwLCBkZXBlbmRlbmN5OyB4Jmx0O2RlcGVuZGVuY2llcy5sZW5ndGg7IHgrKykgew0KICAJCQlkZXBlbmRlbmN5ID0gZGVwZW5kZW5jaWVzW3hdOw0KICAJCQlpZiAoZGVwZW5kZW5jeSA9PT0gJ2pxdWVyeScpIHsgLy8gbG93ZXJjYXNlIHdpdGggcmVxdWlyZSwgYnV0IGNhbWVsIGNhc2UgYXMgZ2xvYmFsDQogIAkJCQlkZXBlbmRlbmN5ID0gJ2pRdWVyeSc7DQogIAkJCX0NCiAgCQkJZGVwZW5kZW5jaWVzW3hdID0gcm9vdFtkZXBlbmRlbmN5XTsNCiAgCQl9DQogIAkJcm9vdFttb2R1bGVOYW1lXSA9IGZhY3RvcnkuYXBwbHkocm9vdCwgZGVwZW5kZW5jaWVzKTsNCiAgCX07DQogIH0NCg0KZGVmaW5lKCdTY3JvbGxNYWdpYycsIFsnanF1ZXJ5JywgJ1R3ZWVuTWF4JywgJ1RpbWVsaW5lTWF4J10sIGZ1bmN0aW9uICgkLCBUd2Vlbk1heCwgVGltZWxpbmVNYXgpIHsNCgkvKioNCgkgKiBUaGUgbWFpbiBjbGFzcyB0aGF0IGlzIG5lZWRlZCBvbmNlIHBlciBzY3JvbGwgY29udGFpbmVyLg0KCSAqDQoJICogQGNsYXNzDQoJICogQGdsb2JhbA0KCSAqDQoJICogQGV4YW1wbGUNCgkgKiAvLyBiYXNpYyBpbml0aWFsaXphdGlvbg0KCSAqIHZhciBjb250cm9sbGVyID0gbmV3IFNjcm9sbE1hZ2ljKCk7DQoJICoNCgkgKiAvLyBwYXNzaW5nIG9wdGlvbnMNCgkgKiB2YXIgY29udHJvbGxlciA9IG5ldyBTY3JvbGxNYWdpYyh7Y29udGFpbmVyOiAiI215Q29udGFpbmVyIiwgbG9nbGV2ZWw6IDN9KTsNCgkgKg0KCSAqIEBwYXJhbSB7b2JqZWN0fSBbb3B0aW9uc10gLSBBbiBvYmplY3QgY29udGFpbmluZyBvbmUgb3IgbW9yZSBvcHRpb25zIGZvciB0aGUgY29udHJvbGxlci4NCgkgKiBAcGFyYW0geyhzdHJpbmd8b2JqZWN0KX0gW29wdGlvbnMuY29udGFpbmVyPXdpbmRvd10gLSBBIHNlbGVjdG9yLCBET00gb2JqZWN0IG9yIGEgalF1ZXJ5IG9iamVjdCB0aGF0IHJlZmVyZW5jZXMgdGhlIG1haW4gY29udGFpbmVyIGZvciBzY3JvbGxpbmcuDQoJICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy52ZXJ0aWNhbD10cnVlXSAtIFNldHMgdGhlIHNjcm9sbCBtb2RlIHRvIHZlcnRpY2FsIChgdHJ1ZWApIG9yIGhvcml6b250YWwgKGBmYWxzZWApIHNjcm9sbGluZy4NCgkgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnMuZ2xvYmFsU2NlbmVPcHRpb25zPXt9XSAtIFRoZXNlIG9wdGlvbnMgd2lsbCBiZSBwYXNzZWQgdG8gZXZlcnkgU2NlbmUgdGhhdCBpcyBhZGRlZCB0byB0aGUgY29udHJvbGxlciB1c2luZyB0aGUgYWRkU2NlbmUgbWV0aG9kLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBTY2VuZSBvcHRpb25zIHNlZSB7QGxpbmsgU2Nyb2xsU2NlbmV9Lg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5sb2dsZXZlbD0yXSBMb2dsZXZlbCBmb3IgZGVidWdnaW5nLiBOb3RlIHRoYXQgbG9nZ2luZyBpcyBkaXNhYmxlZCBpbiB0aGUgbWluaWZpZWQgdmVyc2lvbiBvZiBTY3JvbGxNYWdpYy4NCgkJCQkJCQkJCQkJICoqIGAwYCA9PiBzaWxlbnQNCgkJCQkJCQkJCQkJICoqIGAxYCA9PiBlcnJvcnMNCgkJCQkJCQkJCQkJICoqIGAyYCA9PiBlcnJvcnMsIHdhcm5pbmdzDQoJCQkJCQkJCQkJCSAqKiBgM2AgPT4gZXJyb3JzLCB3YXJuaW5ncywgZGVidWdpbmZvDQoJICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5yZWZyZXNoSW50ZXJ2YWw9MTAwXSAtIFNvbWUgY2hhbmdlcyBkb24ndCBjYWxsIGV2ZW50cyBieSBkZWZhdWx0LCBsaWtlIGNoYW5naW5nIHRoZSBjb250YWluZXIgc2l6ZSBvciBtb3ZpbmcgYSBzY2VuZSB0cmlnZ2VyIGVsZW1lbnQuICANCgkgCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkgVGhpcyBpbnRlcnZhbCBwb2xscyB0aGVzZSBwYXJhbWV0ZXJzIHRvIGZpcmUgdGhlIG5lY2Vzc2FyeSBldmVudHMuICANCgkgCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkgSWYgeW91IGRvbid0IHVzZSBjdXN0b20gY29udGFpbmVycywgdHJpZ2dlciBlbGVtZW50cyBvciBoYXZlIHN0YXRpYyBsYXlvdXRzLCB3aGVyZSB0aGUgcG9zaXRpb25zIG9mIHRoZSB0cmlnZ2VyIGVsZW1lbnRzIGRvbid0IGNoYW5nZSwgeW91IGNhbiBzZXQgdGhpcyB0byAwIGRpc2FibGUgaW50ZXJ2YWwgY2hlY2tpbmcgYW5kIGltcHJvdmUgcGVyZm9ybWFuY2UuDQoJICoNCgkgKi8NCglTY3JvbGxNYWdpYyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHNldHRpbmdzDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICovDQoJCXZhcg0KCQkJTkFNRVNQQUNFID0gIlNjcm9sbE1hZ2ljIiwNCgkJCURFRkFVTFRfT1BUSU9OUyA9IHsNCgkJCQljb250YWluZXI6IHdpbmRvdywNCgkJCQl2ZXJ0aWNhbDogdHJ1ZSwNCgkJCQlnbG9iYWxTY2VuZU9wdGlvbnM6IHt9LA0KCQkJCWxvZ2xldmVsOiAyLA0KCQkJCXJlZnJlc2hJbnRlcnZhbDogMTAwDQoJCQl9Ow0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHJpdmF0ZSB2YXJzDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICovDQoNCgkJdmFyDQoJCQlTY3JvbGxNYWdpYyA9IHRoaXMsDQoJCQlfb3B0aW9ucyA9ICQuZXh0ZW5kKHt9LCBERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpLA0KCQkJX3NjZW5lT2JqZWN0cyA9IFtdLA0KCQkJX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlID0gZmFsc2UsCQkvLyBjYW4gYmUgYm9vbGVhbiAodHJ1ZSA9PiBhbGwgc2NlbmVzKSBvciBhbiBhcnJheSBvZiBzY2VuZXMgdG8gYmUgdXBkYXRlZA0KCQkJX3Njcm9sbFBvcyA9IDAsDQoJCQlfc2Nyb2xsRGlyZWN0aW9uID0gIlBBVVNFRCIsDQoJCQlfaXNEb2N1bWVudCA9IHRydWUsDQoJCQlfdmlld1BvcnRTaXplID0gMCwNCgkJCV9lbmFibGVkID0gdHJ1ZSwNCgkJCV91cGRhdGVDeWNsZSwNCgkJCV9yZWZyZXNoSW50ZXJ2YWw7DQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBwcml2YXRlIGZ1bmN0aW9ucw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCS8qKg0KCQkgKiBJbnRlcm5hbCBjb25zdHJ1Y3RvciBmdW5jdGlvbiBvZiBTY3JvbGxNYWdpYw0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIGNvbnN0cnVjdCA9IGZ1bmN0aW9uICgpIHsNCgkJCVNjcm9sbE1hZ2ljLnZlcnNpb24gPSBTY3JvbGxNYWdpYy5jb25zdHJ1Y3Rvci52ZXJzaW9uOw0KCQkJJC5lYWNoKF9vcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgew0KCQkJCWlmICghREVGQVVMVF9PUFRJT05TLmhhc093blByb3BlcnR5KGtleSkpIHsNCgkJCQkJbG9nKDIsICJXQVJOSU5HOiBVbmtub3duIG9wdGlvbiBcIiIgKyBrZXkgKyAiXCIiKTsNCgkJCQkJZGVsZXRlIF9vcHRpb25zW2tleV07DQoJCQkJfQ0KCQkJfSk7DQoJCQlfb3B0aW9ucy5jb250YWluZXIgPSAkKF9vcHRpb25zLmNvbnRhaW5lcikuZmlyc3QoKTsNCgkJCS8vIGNoZWNrIFNjcm9sbENvbnRhaW5lcg0KCQkJaWYgKF9vcHRpb25zLmNvbnRhaW5lci5sZW5ndGggPT09IDApIHsNCgkJCQlsb2coMSwgIkVSUk9SIGNyZWF0aW5nIG9iamVjdCAiICsgTkFNRVNQQUNFICsgIjogTm8gdmFsaWQgc2Nyb2xsIGNvbnRhaW5lciBzdXBwbGllZCIpOw0KCQkJCXRocm93IE5BTUVTUEFDRSArICIgaW5pdCBmYWlsZWQuIjsgLy8gY2FuY2VsDQoJCQl9DQoJCQlfaXNEb2N1bWVudCA9ICEkLmNvbnRhaW5zKGRvY3VtZW50LCBfb3B0aW9ucy5jb250YWluZXIuZ2V0KDApKTsNCgkJCS8vIHByZXZlbnQgYnViYmxpbmcgb2YgZmFrZSByZXNpemUgZXZlbnQgdG8gd2luZG93DQoJCQlpZiAoIV9pc0RvY3VtZW50KSB7DQoJCQkJX29wdGlvbnMuY29udGFpbmVyLm9uKCdyZXNpemUnLCBmdW5jdGlvbiAoIGUgKSB7DQogICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsNCiAgICAgICAgfSk7DQoJCQl9DQoJCQkvLyB1cGRhdGUgY29udGFpbmVyIHNpemUgaW1tZWRpYXRlbHkNCgkJCV92aWV3UG9ydFNpemUgPSBfb3B0aW9ucy52ZXJ0aWNhbCA/IF9vcHRpb25zLmNvbnRhaW5lci5oZWlnaHQoKSA6IF9vcHRpb25zLmNvbnRhaW5lci53aWR0aCgpOw0KCQkJLy8gc2V0IGV2ZW50IGhhbmRsZXJzDQoJCQlfb3B0aW9ucy5jb250YWluZXIub24oInNjcm9sbCByZXNpemUiLCBvbkNoYW5nZSk7DQoNCgkJCV9vcHRpb25zLnJlZnJlc2hJbnRlcnZhbCA9IHBhcnNlSW50KF9vcHRpb25zLnJlZnJlc2hJbnRlcnZhbCk7DQoJCQlpZiAoX29wdGlvbnMucmVmcmVzaEludGVydmFsID4gMCkgew0KCQkJCV9yZWZyZXNoSW50ZXJ2YWwgPSB3aW5kb3cuc2V0SW50ZXJ2YWwocmVmcmVzaCwgX29wdGlvbnMucmVmcmVzaEludGVydmFsKTsNCgkJCX0NCg0KCQkJLy8gc3RhcnQgY2hlY2tpbmcgZm9yIGNoYW5nZXMNCgkJCV91cGRhdGVDeWNsZSA9IGFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sodXBkYXRlU2NlbmVzKTsNCgkJCWxvZygzLCAiYWRkZWQgbmV3ICIgKyBOQU1FU1BBQ0UgKyAiIGNvbnRyb2xsZXIgKHYiICsgU2Nyb2xsTWFnaWMudmVyc2lvbiArICIpIik7DQoJCX07DQoNCgkJLyoqDQoJCSogRGVmYXVsdCBmdW5jdGlvbiB0byBnZXQgc2Nyb2xsIHBvcyAtIG92ZXJ3cml0ZWFibGUgdXNpbmcgYFNjcm9sbE1hZ2ljLnNjcm9sbFBvcyhuZXdGdW5jdGlvbilgDQoJCSogQHByaXZhdGUNCgkJKi8NCgkJdmFyIGdldFNjcm9sbFBvcyA9IGZ1bmN0aW9uICgpIHsNCgkJCXJldHVybiBfb3B0aW9ucy52ZXJ0aWNhbCA/IF9vcHRpb25zLmNvbnRhaW5lci5zY3JvbGxUb3AoKSA6IF9vcHRpb25zLmNvbnRhaW5lci5zY3JvbGxMZWZ0KCk7DQoJCX07DQoJCS8qKg0KCQkqIERlZmF1bHQgZnVuY3Rpb24gdG8gc2V0IHNjcm9sbCBwb3MgLSBvdmVyd3JpdGVhYmxlIHVzaW5nIGBTY3JvbGxNYWdpYy5zY3JvbGxUbyhuZXdGdW5jdGlvbilgDQoJCSogQHByaXZhdGUNCgkJKi8NCgkJdmFyIHNldFNjcm9sbFBvcyA9IGZ1bmN0aW9uIChwb3MpIHsNCgkJCWlmIChfb3B0aW9ucy52ZXJ0aWNhbCkgew0KCQkJCV9vcHRpb25zLmNvbnRhaW5lci5zY3JvbGxUb3AocG9zKTsNCgkJCX0gZWxzZSB7DQoJCQkJX29wdGlvbnMuY29udGFpbmVyLnNjcm9sbExlZnQocG9zKTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJKiBIYW5kbGUgdXBkYXRlcyBpbiBjeWNsZXMgaW5zdGVhZCBvZiBvbiBzY3JvbGwgKHBlcmZvcm1hbmNlKQ0KCQkqIEBwcml2YXRlDQoJCSovDQoJCXZhciB1cGRhdGVTY2VuZXMgPSBmdW5jdGlvbiAoKSB7DQoJCQlfdXBkYXRlQ3ljbGUgPSBhbmltYXRpb25GcmFtZUNhbGxiYWNrKHVwZGF0ZVNjZW5lcyk7DQoJCQlpZiAoX2VuYWJsZWQgJmFtcDsmYW1wOyBfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUpIHsNCgkJCQl2YXINCgkJCQkJc2NlbmVzVG9VcGRhdGUgPSAkLmlzQXJyYXkoX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlKSA/IF91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSA6IF9zY2VuZU9iamVjdHMuc2xpY2UoMCksDQoJCQkJCW9sZFNjcm9sbFBvcyA9IF9zY3JvbGxQb3M7DQoJCQkJLy8gdXBkYXRlIHNjcm9sbCBwb3MgJmFtcDsgZGlyZWN0aW9uDQoJCQkJX3Njcm9sbFBvcyA9IFNjcm9sbE1hZ2ljLnNjcm9sbFBvcygpOw0KCQkJCXZhciBkZWx0YVNjcm9sbCA9IF9zY3JvbGxQb3MgLSBvbGRTY3JvbGxQb3M7DQoJCQkJX3Njcm9sbERpcmVjdGlvbiA9IChkZWx0YVNjcm9sbCA9PT0gMCkgPyAiUEFVU0VEIiA6IChkZWx0YVNjcm9sbCA+IDApID8gIkZPUldBUkQiIDogIlJFVkVSU0UiOw0KCQkJCWlmIChkZWx0YVNjcm9sbCAmbHQ7IDApIHsgLy8gcmV2ZXJzZSBvcmRlciBpZiBzY3JvbGxpbmcgcmV2ZXJzZQ0KCQkJCQlzY2VuZXNUb1VwZGF0ZS5yZXZlcnNlKCk7DQoJCQkJfQ0KCQkJCS8vIHVwZGF0ZSBzY2VuZXMNCgkJCQkkLmVhY2goc2NlbmVzVG9VcGRhdGUsIGZ1bmN0aW9uIChpbmRleCwgc2NlbmUpIHsNCgkJCQkJbG9nKDMsICJ1cGRhdGluZyBTY2VuZSAiICsgKGluZGV4ICsgMSkgKyAiLyIgKyBzY2VuZXNUb1VwZGF0ZS5sZW5ndGggKyAiICgiICsgX3NjZW5lT2JqZWN0cy5sZW5ndGggKyAiIHRvdGFsKSIpOw0KCQkJCQlzY2VuZS51cGRhdGUodHJ1ZSk7DQoJCQkJfSk7DQoJCQkJaWYgKHNjZW5lc1RvVXBkYXRlLmxlbmd0aCA9PT0gMCAmYW1wOyZhbXA7IF9vcHRpb25zLmxvZ2xldmVsID49IDMpIHsNCgkJCQkJbG9nKDMsICJ1cGRhdGluZyAwIFNjZW5lcyAobm90aGluZyBhZGRlZCB0byBjb250cm9sbGVyKSIpOw0KCQkJCX0NCgkJCQlfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUgPSBmYWxzZTsNCgkJCX0NCgkJfTsNCgkJDQoJCS8qKg0KCQkqIEhhbmRsZXMgQ29udGFpbmVyIGNoYW5nZXMNCgkJKiBAcHJpdmF0ZQ0KCQkqLw0KCQl2YXIgb25DaGFuZ2UgPSBmdW5jdGlvbiAoZSkgew0KCQkJaWYgKGUudHlwZSA9PSAicmVzaXplIikgew0KCQkJCV92aWV3UG9ydFNpemUgPSBfb3B0aW9ucy52ZXJ0aWNhbCA/IF9vcHRpb25zLmNvbnRhaW5lci5oZWlnaHQoKSA6IF9vcHRpb25zLmNvbnRhaW5lci53aWR0aCgpOw0KCQkJfQ0KCQkJX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlID0gdHJ1ZTsNCgkJfTsNCg0KCQl2YXIgcmVmcmVzaCA9IGZ1bmN0aW9uICgpIHsNCgkJCWlmICghX2lzRG9jdW1lbnQpIHsNCgkJCQkvLyBzaW11bGF0ZSByZXNpemUgZXZlbnQuIE9ubHkgd29ya3MgZm9yIHZpZXdwb3J0IHJlbGV2YW50IHBhcmFtDQoJCQkJaWYgKF92aWV3UG9ydFNpemUgIT0gKF9vcHRpb25zLnZlcnRpY2FsID8gX29wdGlvbnMuY29udGFpbmVyLmhlaWdodCgpIDogX29wdGlvbnMuY29udGFpbmVyLndpZHRoKCkpKSB7DQoJCQkJCV9vcHRpb25zLmNvbnRhaW5lci50cmlnZ2VyKCJyZXNpemUiKTsNCgkJCQl9DQoJCQl9DQoJCQkkLmVhY2goX3NjZW5lT2JqZWN0cywgZnVuY3Rpb24gKGluZGV4LCBzY2VuZSkgey8vIHJlZnJlc2ggYWxsIHNjZW5lcw0KCQkJCXNjZW5lLnJlZnJlc2goKTsNCgkJCX0pOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBTZW5kIGEgZGVidWcgbWVzc2FnZSB0byB0aGUgY29uc29sZS4NCgkJICogQHByaXZhdGUNCgkJICoNCgkJICogQHBhcmFtIHtudW1iZXJ9IGxvZ2xldmVsIC0gVGhlIGxvZ2xldmVsIHJlcXVpcmVkIHRvIGluaXRpYXRlIG91dHB1dCBmb3IgdGhlIG1lc3NhZ2UuDQoJCSAqIEBwYXJhbSB7Li4ubWl4ZWR9IG91dHB1dCAtIE9uZSBvciBtb3JlIHZhcmlhYmxlcyB0aGF0IHNob3VsZCBiZSBwYXNzZWQgdG8gdGhlIGNvbnNvbGUuDQoJCSAqLw0KCQl2YXIgbG9nID0gZnVuY3Rpb24gKGxvZ2xldmVsLCBvdXRwdXQpIHsNCgkJCWlmIChfb3B0aW9ucy5sb2dsZXZlbCA+PSBsb2dsZXZlbCkgew0KCQkJCXZhcg0KCQkJCQlwcmVmaXggPSAiKCIgKyBOQU1FU1BBQ0UgKyAiKSAtPiIsDQoJCQkJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsNCgkJCQlhcmdzLnVuc2hpZnQobG9nbGV2ZWwsIHByZWZpeCk7DQoJCQkJZGVidWcuYXBwbHkod2luZG93LCBhcmdzKTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogU29ydCBzY2VuZXMgaW4gYXNjZW5kaW5nIG9yZGVyIG9mIHRoZWlyIHN0YXJ0IG9mZnNldC4NCgkJICogQHByaXZhdGUNCgkJICoNCgkJICogQHBhcmFtIHthcnJheX0gU2Nyb2xsU2NlbmVzQXJyYXkgLSBhbiBhcnJheSBvZiBTY3JvbGxTY2VuZXMgdGhhdCBzaG91bGQgYmUgc29ydGVkDQoJCSAqIEByZXR1cm4ge2FycmF5fSBUaGUgc29ydGVkIGFycmF5IG9mIFNjcm9sbFNjZW5lcy4NCgkJICovDQoJCXZhciBzb3J0U2NlbmVzID0gZnVuY3Rpb24gKFNjcm9sbFNjZW5lc0FycmF5KSB7DQoJCQlpZiAoU2Nyb2xsU2NlbmVzQXJyYXkubGVuZ3RoICZsdDs9IDEpIHsNCgkJCQlyZXR1cm4gU2Nyb2xsU2NlbmVzQXJyYXk7DQoJCQl9IGVsc2Ugew0KCQkJCXZhciBzY2VuZXMgPSBTY3JvbGxTY2VuZXNBcnJheS5zbGljZSgwKTsNCgkJCQlzY2VuZXMuc29ydChmdW5jdGlvbihhLCBiKSB7DQoJCQkJCXJldHVybiBhLnNjcm9sbE9mZnNldCgpID4gYi5zY3JvbGxPZmZzZXQoKSA/IDEgOiAtMTsNCgkJCQl9KTsNCgkJCQlyZXR1cm4gc2NlbmVzOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHVibGljIGZ1bmN0aW9ucw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCS8qKg0KCQkgKiBBZGQgb25lIG9yZSBtb3JlIHNjZW5lKHMpIHRvIHRoZSBjb250cm9sbGVyLiAgDQoJCSAqIFRoaXMgaXMgdGhlIGVxdWl2YWxlbnQgdG8gYFNjcm9sbFNjZW5lLmFkZFRvKGNvbnRyb2xsZXIpYC4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyB3aXRoIGEgcHJldmlvdXNseSBkZWZpbmVkIHNjZW5lDQoJCSAqIGNvbnRyb2xsZXIuYWRkU2NlbmUoc2NlbmUpOw0KCQkgKg0KCSAJICogLy8gd2l0aCBhIG5ld2x5IGNyZWF0ZWQgc2NlbmUuDQoJCSAqIGNvbnRyb2xsZXIuYWRkU2NlbmUobmV3IFNjcm9sbFNjZW5lKHtkdXJhdGlvbiA6IDB9KSk7DQoJCSAqDQoJIAkgKiAvLyBhZGRpbmcgbXVsdGlwbGUgc2NlbmVzDQoJCSAqIGNvbnRyb2xsZXIuYWRkU2NlbmUoW3NjZW5lLCBzY2VuZTIsIG5ldyBTY3JvbGxTY2VuZSh7ZHVyYXRpb24gOiAwfSldKTsNCgkJICoNCgkJICogQHBhcmFtIHsoU2Nyb2xsU2NlbmV8YXJyYXkpfSBTY3JvbGxTY2VuZSAtIFNjcm9sbFNjZW5lIG9yIEFycmF5IG9mIFNjcm9sbFNjZW5lcyB0byBiZSBhZGRlZCB0byB0aGUgY29udHJvbGxlci4NCgkJICogQHJldHVybiB7U2Nyb2xsTWFnaWN9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5hZGRTY2VuZSA9IGZ1bmN0aW9uIChuZXdTY2VuZSkgew0KCQkJaWYgKCQuaXNBcnJheShuZXdTY2VuZSkpIHsNCgkJCQkkLmVhY2gobmV3U2NlbmUsIGZ1bmN0aW9uIChpbmRleCwgc2NlbmUpIHsNCgkJCQkJU2Nyb2xsTWFnaWMuYWRkU2NlbmUoc2NlbmUpOw0KCQkJCX0pOw0KCQkJfSBlbHNlIGlmIChuZXdTY2VuZSBpbnN0YW5jZW9mIFNjcm9sbFNjZW5lKSB7DQoJCQkJaWYgKG5ld1NjZW5lLnBhcmVudCgpICE9IFNjcm9sbE1hZ2ljKSB7DQoJCQkJCW5ld1NjZW5lLmFkZFRvKFNjcm9sbE1hZ2ljKTsNCgkJCQl9IGVsc2UgaWYgKCQuaW5BcnJheShuZXdTY2VuZSwgX3NjZW5lT2JqZWN0cykgJmx0OyAwKXsNCgkJCQkJLy8gbmV3IHNjZW5lDQoJCQkJCV9zY2VuZU9iamVjdHMucHVzaChuZXdTY2VuZSk7IC8vIGFkZCB0byBhcnJheQ0KCQkJCQlfc2NlbmVPYmplY3RzID0gc29ydFNjZW5lcyhfc2NlbmVPYmplY3RzKTsgLy8gc29ydA0KCQkJCQluZXdTY2VuZS5vbigic2hpZnQuIiArIE5BTUVTUEFDRSArICJfc29ydCIsIGZ1bmN0aW9uKCkgeyAvLyByZXNvcnQgd2hlbmV2ZXIgc2NlbmUgbW92ZXMNCgkJCQkJCV9zY2VuZU9iamVjdHMgPSBzb3J0U2NlbmVzKF9zY2VuZU9iamVjdHMpOw0KCQkJCQl9KTsNCgkJCQkJLy8gaW5zZXJ0IEdsb2JhbCBkZWZhdWx0cy4NCgkJCQkJJC5lYWNoKF9vcHRpb25zLmdsb2JhbFNjZW5lT3B0aW9ucywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsNCgkJCQkJCWlmIChuZXdTY2VuZVtrZXldKSB7DQoJCQkJCQkJbmV3U2NlbmVba2V5XS5jYWxsKG5ld1NjZW5lLCB2YWx1ZSk7DQoJCQkJCQl9DQoJCQkJCX0pOw0KCQkJCQlsb2coMywgImFkZGVkIFNjZW5lICgiICsgX3NjZW5lT2JqZWN0cy5sZW5ndGggKyAiIHRvdGFsKSIpOw0KCQkJCX0NCgkJCX0gZWxzZSB7DQoJCQkJbG9nKDEsICJFUlJPUjogaW52YWxpZCBhcmd1bWVudCBzdXBwbGllZCBmb3IgJy5hZGRTY2VuZSgpJyIpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBSZW1vdmUgb25lIG9yZSBtb3JlIHNjZW5lKHMpIGZyb20gdGhlIGNvbnRyb2xsZXIuICANCgkJICogVGhpcyBpcyB0aGUgZXF1aXZhbGVudCB0byBgU2Nyb2xsU2NlbmUucmVtb3ZlKClgLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHJlbW92ZSBhIHNjZW5lIGZyb20gdGhlIGNvbnRyb2xsZXINCgkJICogY29udHJvbGxlci5yZW1vdmVTY2VuZShzY2VuZSk7DQoJCSAqDQoJCSAqIC8vIHJlbW92ZSBtdWx0aXBsZSBzY2VuZXMgZnJvbSB0aGUgY29udHJvbGxlcg0KCQkgKiBjb250cm9sbGVyLnJlbW92ZVNjZW5lKFtzY2VuZSwgc2NlbmUyLCBzY2VuZTNdKTsNCgkJICoNCgkJICogQHBhcmFtIHsoU2Nyb2xsU2NlbmV8YXJyYXkpfSBTY3JvbGxTY2VuZSAtIFNjcm9sbFNjZW5lIG9yIEFycmF5IG9mIFNjcm9sbFNjZW5lcyB0byBiZSByZW1vdmVkIGZyb20gdGhlIGNvbnRyb2xsZXIuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxNYWdpY30gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJlbW92ZVNjZW5lID0gZnVuY3Rpb24gKFNjcm9sbFNjZW5lKSB7DQoJCQlpZiAoJC5pc0FycmF5KFNjcm9sbFNjZW5lKSkgew0KCQkJCSQuZWFjaChTY3JvbGxTY2VuZSwgZnVuY3Rpb24gKGluZGV4LCBzY2VuZSkgew0KCQkJCQlTY3JvbGxNYWdpYy5yZW1vdmVTY2VuZShzY2VuZSk7DQoJCQkJfSk7DQoJCQl9IGVsc2Ugew0KCQkJCXZhciBpbmRleCA9ICQuaW5BcnJheShTY3JvbGxTY2VuZSwgX3NjZW5lT2JqZWN0cyk7DQoJCQkJaWYgKGluZGV4ID4gLTEpIHsNCgkJCQkJU2Nyb2xsU2NlbmUub2ZmKCJzaGlmdC4iICsgTkFNRVNQQUNFICsgIl9zb3J0Iik7DQoJCQkJCV9zY2VuZU9iamVjdHMuc3BsaWNlKGluZGV4LCAxKTsNCgkJCQkJU2Nyb2xsU2NlbmUucmVtb3ZlKCk7DQoJCQkJCWxvZygzLCAicmVtb3ZlZCBTY2VuZSAoIiArIF9zY2VuZU9iamVjdHMubGVuZ3RoICsgIiB0b3RhbCkiKTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZSBvbmUgb3JlIG1vcmUgc2NlbmUocykgYWNjb3JkaW5nIHRvIHRoZSBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGNvbnRhaW5lci4gIA0KCQkgKiBUaGlzIGlzIHRoZSBlcXVpdmFsZW50IHRvIGBTY3JvbGxTY2VuZS51cGRhdGUoKWAuICANCgkJICogVGhlIHVwZGF0ZSBtZXRob2QgY2FsY3VsYXRlcyB0aGUgc2NlbmUncyBzdGFydCBhbmQgZW5kIHBvc2l0aW9uIChiYXNlZCBvbiB0aGUgdHJpZ2dlciBlbGVtZW50LCB0cmlnZ2VyIGhvb2ssIGR1cmF0aW9uIGFuZCBvZmZzZXQpIGFuZCBjaGVja3MgaXQgYWdhaW5zdCB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGNvbnRhaW5lci4gIA0KCQkgKiBJdCB0aGVuIHVwZGF0ZXMgdGhlIGN1cnJlbnQgc2NlbmUgc3RhdGUgYWNjb3JkaW5nbHkgKG9yIGRvZXMgbm90aGluZywgaWYgdGhlIHN0YXRlIGlzIGFscmVhZHkgY29ycmVjdCkg4oCTIFBpbnMgd2lsbCBiZSBzZXQgdG8gdGhlaXIgY29ycmVjdCBwb3NpdGlvbiBhbmQgdHdlZW5zIHdpbGwgYmUgdXBkYXRlZCB0byB0aGVpciBjb3JyZWN0IHByb2dyZXNzLiAgDQoJCSAqIF8qKk5vdGU6KiogVGhpcyBtZXRob2QgZ2V0cyBjYWxsZWQgY29uc3RhbnRseSB3aGVuZXZlciBTY3JvbGxNYWdpYyBkZXRlY3RzIGEgY2hhbmdlLiBUaGUgb25seSBhcHBsaWNhdGlvbiBmb3IgeW91IGlzIGlmIHlvdSBjaGFuZ2Ugc29tZXRoaW5nIG91dHNpZGUgb2YgdGhlIHJlYWxtIG9mIFNjcm9sbE1hZ2ljLCBsaWtlIG1vdmluZyB0aGUgdHJpZ2dlciBvciBjaGFuZ2luZyB0d2VlbiBwYXJhbWV0ZXJzLl8NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyB1cGRhdGUgYSBzcGVjaWZpYyBzY2VuZSBvbiBuZXh0IGN5Y2xlDQoJIAkgKiBjb250cm9sbGVyLnVwZGF0ZVNjZW5lKHNjZW5lKTsNCgkgCSAqDQoJCSAqIC8vIHVwZGF0ZSBhIHNwZWNpZmljIHNjZW5lIGltbWVkaWF0ZWx5DQoJCSAqIGNvbnRyb2xsZXIudXBkYXRlU2NlbmUoc2NlbmUsIHRydWUpOw0KCSAJICoNCgkJICogLy8gdXBkYXRlIG11bHRpcGxlIHNjZW5lcyBzY2VuZSBvbiBuZXh0IGN5Y2xlDQoJCSAqIGNvbnRyb2xsZXIudXBkYXRlU2NlbmUoW3NjZW5lMSwgc2NlbmUyLCBzY2VuZTNdKTsNCgkJICoNCgkJICogQHBhcmFtIHtTY3JvbGxTY2VuZX0gU2Nyb2xsU2NlbmUgLSBTY3JvbGxTY2VuZSBvciBBcnJheSBvZiBTY3JvbGxTY2VuZXMgdGhhdCBpcy9hcmUgc3VwcG9zZWQgdG8gYmUgdXBkYXRlZC4NCgkJICogQHBhcmFtIHtib29sZWFufSBbaW1tZWRpYXRlbHk9ZmFsc2VdIC0gSWYgYHRydWVgIHRoZSB1cGRhdGUgd2lsbCBiZSBpbnN0YW50LCBpZiBgZmFsc2VgIGl0IHdpbGwgd2FpdCB1bnRpbCBuZXh0IHVwZGF0ZSBjeWNsZS4gIA0KCQkgCQkJCQkJCQkJCSAgVGhpcyBpcyB1c2VmdWwgd2hlbiBjaGFuZ2luZyBtdWx0aXBsZSBwcm9wZXJ0aWVzIG9mIHRoZSBzY2VuZSAtIHRoaXMgd2F5IGl0IHdpbGwgb25seSBiZSB1cGRhdGVkIG9uY2UgYWxsIG5ldyBwcm9wZXJ0aWVzIGFyZSBzZXQgKHVwZGF0ZVNjZW5lcykuDQoJCSAqIEByZXR1cm4ge1Njcm9sbE1hZ2ljfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudXBkYXRlU2NlbmUgPSBmdW5jdGlvbiAoU2Nyb2xsU2NlbmUsIGltbWVkaWF0ZWx5KSB7DQoJCQlpZiAoJC5pc0FycmF5KFNjcm9sbFNjZW5lKSkgew0KCQkJCSQuZWFjaChTY3JvbGxTY2VuZSwgZnVuY3Rpb24gKGluZGV4LCBzY2VuZSkgew0KCQkJCQlTY3JvbGxNYWdpYy51cGRhdGVTY2VuZShzY2VuZSwgaW1tZWRpYXRlbHkpOw0KCQkJCX0pOw0KCQkJfSBlbHNlIHsNCgkJCQlpZiAoaW1tZWRpYXRlbHkpIHsNCgkJCQkJU2Nyb2xsU2NlbmUudXBkYXRlKHRydWUpOw0KCQkJCX0gZWxzZSB7DQoJCQkJCS8vIHByZXAgYXJyYXkgZm9yIG5leHQgdXBkYXRlIGN5Y2xlDQoJCQkJCWlmICghJC5pc0FycmF5KF91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSkpIHsNCgkJCQkJCV91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSA9IFtdOw0KCQkJCQl9DQoJCQkJCWlmICgkLmluQXJyYXkoU2Nyb2xsU2NlbmUsIF91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSkgPT0gLTEpIHsNCgkJCQkJCV91cGRhdGVTY2VuZXNPbk5leHRDeWNsZS5wdXNoKFNjcm9sbFNjZW5lKTsJDQoJCQkJCX0NCgkJCQkJX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlID0gc29ydFNjZW5lcyhfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUpOyAvLyBzb3J0DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGVzIHRoZSBjb250cm9sbGVyIHBhcmFtcyBhbmQgY2FsbHMgdXBkYXRlU2NlbmUgb24gZXZlcnkgc2NlbmUsIHRoYXQgaXMgYXR0YWNoZWQgdG8gdGhlIGNvbnRyb2xsZXIuICANCgkJICogU2VlIGBTY3JvbGxNYWdpYy51cGRhdGVTY2VuZSgpYCBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCB3aGF0IHRoaXMgbWVhbnMuICANCgkJICogSW4gbW9zdCBjYXNlcyB5b3Ugd2lsbCBub3QgbmVlZCB0aGlzIGZ1bmN0aW9uLCBhcyBpdCBpcyBjYWxsZWQgY29uc3RhbnRseSwgd2hlbmV2ZXIgU2Nyb2xsTWFnaWMgZGV0ZWN0cyBhIHN0YXRlIGNoYW5nZSBldmVudCwgbGlrZSByZXNpemUgb3Igc2Nyb2xsLiAgDQoJCSAqIFRoZSBvbmx5IGFwcGxpY2F0aW9uIGZvciB0aGlzIG1ldGhvZCBpcyB3aGVuIFNjcm9sbE1hZ2ljIGZhaWxzIHRvIGRldGVjdCB0aGVzZSBldmVudHMuICANCgkJICogT25lIGFwcGxpY2F0aW9uIGlzIHdpdGggc29tZSBleHRlcm5hbCBzY3JvbGwgbGlicmFyaWVzIChsaWtlIGlTY3JvbGwpIHRoYXQgbW92ZSBhbiBpbnRlcm5hbCBjb250YWluZXIgdG8gYSBuZWdhdGl2ZSBvZmZzZXQgaW5zdGVhZCBvZiBhY3R1YWxseSBzY3JvbGxpbmcuIEluIHRoaXMgY2FzZSB0aGUgdXBkYXRlIG9uIHRoZSBjb250cm9sbGVyIG5lZWRzIHRvIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgY2hpbGQgY29udGFpbmVyJ3MgcG9zaXRpb24gY2hhbmdlcy4NCgkJICogRm9yIHRoaXMgY2FzZSB0aGVyZSB3aWxsIGFsc28gYmUgdGhlIG5lZWQgdG8gcHJvdmlkZSBhIGN1c3RvbSBmdW5jdGlvbiB0byBjYWxjdWxhdGUgdGhlIGNvcnJlY3Qgc2Nyb2xsIHBvc2l0aW9uLiBTZWUgYFNjcm9sbE1hZ2ljLnNjcm9sbFBvcygpYCBmb3IgZGV0YWlscy4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyB1cGRhdGUgdGhlIGNvbnRyb2xsZXIgb24gbmV4dCBjeWNsZSAoc2F2ZXMgcGVyZm9ybWFuY2UgZHVlIHRvIGVsaW1pbmF0aW9uIG9mIHJlZHVuZGFudCB1cGRhdGVzKQ0KCQkgKiBjb250cm9sbGVyLnVwZGF0ZSgpOw0KCQkgKg0KCSAJICogLy8gdXBkYXRlIHRoZSBjb250cm9sbGVyIGltbWVkaWF0ZWx5DQoJCSAqIGNvbnRyb2xsZXIudXBkYXRlKHRydWUpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtpbW1lZGlhdGVseT1mYWxzZV0gLSBJZiBgdHJ1ZWAgdGhlIHVwZGF0ZSB3aWxsIGJlIGluc3RhbnQsIGlmIGBmYWxzZWAgaXQgd2lsbCB3YWl0IHVudGlsIG5leHQgdXBkYXRlIGN5Y2xlIChiZXR0ZXIgcGVyZm9ybWFuY2UpDQoJCSAqIEByZXR1cm4ge1Njcm9sbE1hZ2ljfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudXBkYXRlID0gZnVuY3Rpb24gKGltbWVkaWF0ZWx5KSB7DQoJCQlvbkNoYW5nZSh7dHlwZTogInJlc2l6ZSJ9KTsgLy8gd2lsbCB1cGRhdGUgc2l6ZSBhbmQgc2V0IF91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSB0byB0cnVlDQoJCQlpZiAoaW1tZWRpYXRlbHkpIHsNCgkJCQl1cGRhdGVTY2VuZXMoKTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxNYWdpYzsNCgkJfTsNCg0KCQkvKioNCgkJICogU2Nyb2xsIHRvIGEgbnVtZXJpYyBzY3JvbGwgb2Zmc2V0LCBhIERPTSBlbGVtZW50LCB0aGUgc3RhcnQgb2YgYSBzY2VuZSBvciBwcm92aWRlIGFuIGFsdGVybmF0ZSBtZXRob2QgZm9yIHNjcm9sbGluZy4gIA0KCQkgKiBGb3IgdmVydGljYWwgY29udHJvbGxlcnMgaXQgd2lsbCBjaGFuZ2UgdGhlIHRvcCBzY3JvbGwgb2Zmc2V0IGFuZCBmb3IgaG9yaXpvbnRhbCBhcHBsaWNhdGlvbnMgaXQgd2lsbCBjaGFuZ2UgdGhlIGxlZnQgb2Zmc2V0Lg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBzaW5jZSAxLjEuMA0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBzY3JvbGwgdG8gYW4gb2Zmc2V0IG9mIDEwMA0KCQkgKiBjb250cm9sbGVyLnNjcm9sbFRvKDEwMCk7DQoJCSAqDQoJCSAqIC8vIHNjcm9sbCB0byBhIERPTSBlbGVtZW50DQoJCSAqIGNvbnRyb2xsZXIuc2Nyb2xsVG8oIiNhbmNob3IiKTsNCgkJICoNCgkJICogLy8gc2Nyb2xsIHRvIHRoZSBiZWdpbm5pbmcgb2YgYSBzY2VuZQ0KCQkgKiB2YXIgc2NlbmUgPSBuZXcgU2Nyb2xsU2NlbmUoe29mZnNldDogMjAwfSk7DQoJCSAqIGNvbnRyb2xsZXIuc2Nyb2xsVG8oc2NlbmUpOw0KCQkgKg0KCSAJICogLy8gZGVmaW5lIGEgbmV3IHNjcm9sbCBwb3NpdGlvbiBtb2RpZmljYXRpb24gZnVuY3Rpb24gKGFuaW1hdGUgaW5zdGVhZCBvZiBqdW1wKQ0KCQkgKiBjb250cm9sbGVyLnNjcm9sbFRvKGZ1bmN0aW9uIChuZXdTY3JvbGxQb3MpIHsNCgkJICoJJCgiYm9keSIpLmFuaW1hdGUoe3Njcm9sbFRvcDogbmV3U2Nyb2xsUG9zfSk7DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcGFyYW0ge21peGVkfSBbc2Nyb2xsVGFyZ2V0XSAtIFRoZSBzdXBwbGllZCBhcmd1bWVudCBjYW4gYmUgb25lIG9mIHRoZXNlIHR5cGVzOg0KCQkgKiAxLiBgbnVtYmVyYCAtPiBUaGUgY29udGFpbmVyIHdpbGwgc2Nyb2xsIHRvIHRoaXMgbmV3IHNjcm9sbCBvZmZzZXQuDQoJCSAqIDIuIGBzdHJpbmdgIG9yIGBvYmplY3RgIC0+IENhbiBiZSBhIHNlbGVjdG9yLCBhIERPTSBvYmplY3Qgb3IgYSBqUXVlcnkgZWxlbWVudC4gIA0KCQkgKiAgVGhlIGNvbnRhaW5lciB3aWxsIHNjcm9sbCB0byB0aGUgcG9zaXRpb24gb2YgdGhpcyBlbGVtZW50Lg0KCQkgKiAzLiBgU2Nyb2xsU2NlbmVgIC0+IFRoZSBjb250YWluZXIgd2lsbCBzY3JvbGwgdG8gdGhlIHN0YXJ0IG9mIHRoaXMgc2NlbmUuDQoJCSAqIDQuIGBmdW5jdGlvbmAgLT4gVGhpcyBmdW5jdGlvbiB3aWxsIGJlIHVzZWQgYXMgYSBjYWxsYmFjayBmb3IgZnV0dXJlIHNjcm9sbCBwb3NpdGlvbiBtb2RpZmljYXRpb25zLiAgDQoJCSAqICBUaGlzIHByb3ZpZGVzIGEgd2F5IGZvciB5b3UgdG8gY2hhbmdlIHRoZSBiZWhhdmlvdXIgb2Ygc2Nyb2xsaW5nIGFuZCBhZGRpbmcgbmV3IGJlaGF2aW91ciBsaWtlIGFuaW1hdGlvbi4gVGhlIGNhbGxiYWNrIHJlY2VpdmVzIHRoZSBuZXcgc2Nyb2xsIHBvc2l0aW9uIGFzIGEgcGFyYW1ldGVyIGFuZCBhIHJlZmVyZW5jZSB0byB0aGUgY29udGFpbmVyIGVsZW1lbnQgdXNpbmcgYHRoaXNgLiAgDQoJCSAqICBfKipOT1RFOioqIEFsbCBvdGhlciBvcHRpb25zIHdpbGwgc3RpbGwgd29yayBhcyBleHBlY3RlZCwgdXNpbmcgdGhlIG5ldyBmdW5jdGlvbiB0byBzY3JvbGwuXw0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsTWFnaWN9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5zY3JvbGxUbyA9IGZ1bmN0aW9uIChzY3JvbGxUYXJnZXQpIHsNCgkJCWlmIChzY3JvbGxUYXJnZXQgaW5zdGFuY2VvZiBTY3JvbGxTY2VuZSkgew0KCQkJCWlmIChzY3JvbGxUYXJnZXQucGFyZW50KCkgPT09IFNjcm9sbE1hZ2ljKSB7IC8vIGNoZWNrIGlmIHRoaXMgY29udHJvbGxlciBpcyB0aGUgcGFyZW50DQoJCQkJCVNjcm9sbE1hZ2ljLnNjcm9sbFRvKHNjcm9sbFRhcmdldC5zY3JvbGxPZmZzZXQoKSk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJbG9nICgyLCAic2Nyb2xsVG8oKTogVGhlIHN1cHBsaWVkIHNjZW5lIGRvZXMgbm90IGJlbG9uZyB0byB0aGlzIGNvbnRyb2xsZXIuIFNjcm9sbCBjYW5jZWxsZWQuIiwgc2Nyb2xsVGFyZ2V0KTsNCgkJCQl9DQoJCQl9IGVsc2UgaWYgKCQudHlwZShzY3JvbGxUYXJnZXQpID09PSAic3RyaW5nIiB8fCBpc0RvbUVsZW1lbnQoc2Nyb2xsVGFyZ2V0KSB8fCBzY3JvbGxUYXJnZXQgaW5zdGFuY2VvZiAkKSB7DQoJCQkJdmFyICRlbG0gPSAkKHNjcm9sbFRhcmdldCkuZmlyc3QoKTsNCgkJCQlpZiAoJGVsbVswXSkgew0KCQkJCQl2YXINCgkJCQkJCXBhcmFtID0gX29wdGlvbnMudmVydGljYWwgPyAidG9wIiA6ICJsZWZ0IiwgLy8gd2hpY2ggcGFyYW0gaXMgb2YgaW50ZXJlc3QgPw0KCQkJCQkJY29udGFpbmVyT2Zmc2V0ID0gZ2V0T2Zmc2V0KF9vcHRpb25zLmNvbnRhaW5lciksIC8vIGNvbnRhaW5lciBwb3NpdGlvbiBpcyBuZWVkZWQgYmVjYXVzZSBlbGVtZW50IG9mZnNldCBpcyByZXR1cm5lZCBpbiByZWxhdGlvbiB0byBkb2N1bWVudCwgbm90IGluIHJlbGF0aW9uIHRvIGNvbnRhaW5lci4NCgkJCQkJCWVsZW1lbnRPZmZzZXQgPSBnZXRPZmZzZXQoJGVsbSk7DQoNCgkJCQkJaWYgKCFfaXNEb2N1bWVudCkgeyAvLyBjb250YWluZXIgaXMgbm90IHRoZSBkb2N1bWVudCByb290LCBzbyBzdWJzdHJhY3Qgc2Nyb2xsIFBvc2l0aW9uIHRvIGdldCBjb3JyZWN0IHRyaWdnZXIgZWxlbWVudCBwb3NpdGlvbiByZWxhdGl2ZSB0byBzY3JvbGxjb250ZW50DQoJCQkJCQljb250YWluZXJPZmZzZXRbcGFyYW1dIC09IFNjcm9sbE1hZ2ljLnNjcm9sbFBvcygpOw0KCQkJCQl9DQoNCgkJCQkJU2Nyb2xsTWFnaWMuc2Nyb2xsVG8oZWxlbWVudE9mZnNldFtwYXJhbV0gLSBjb250YWluZXJPZmZzZXRbcGFyYW1dKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQlsb2cgKDIsICJzY3JvbGxUbygpOiBUaGUgc3VwcGxpZWQgZWxlbWVudCBjb3VsZCBub3QgYmUgZm91bmQuIFNjcm9sbCBjYW5jZWxsZWQuIiwgc2Nyb2xsVGFyZ2V0KTsNCgkJCQl9DQoJCQl9IGVsc2UgaWYgKCQuaXNGdW5jdGlvbihzY3JvbGxUYXJnZXQpKSB7DQoJCQkJc2V0U2Nyb2xsUG9zID0gc2Nyb2xsVGFyZ2V0Ow0KCQkJfSBlbHNlIHsNCgkJCQlzZXRTY3JvbGxQb3MuY2FsbChfb3B0aW9ucy5jb250YWluZXJbMF0sIHNjcm9sbFRhcmdldCk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIGN1cnJlbnQgc2Nyb2xsUG9zaXRpb24gb3IgKipTZXQqKiBhIG5ldyBtZXRob2QgdG8gY2FsY3VsYXRlIGl0LiAgDQoJCSAqIC0+ICoqR0VUKio6DQoJCSAqIFdoZW4gdXNlZCBhcyBhIGdldHRlciB0aGlzIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbi4gIA0KCQkgKiBUbyBnZXQgYSBjYWNoZWQgdmFsdWUgdXNlIFNjcm9sbE1hZ2ljLmluZm8oInNjcm9sbFBvcyIpLCB3aGljaCB3aWxsIGJlIHVwZGF0ZWQgaW4gdGhlIHVwZGF0ZSBjeWNsZS4gIA0KCQkgKiBGb3IgdmVydGljYWwgY29udHJvbGxlcnMgaXQgd2lsbCByZXR1cm4gdGhlIHRvcCBzY3JvbGwgb2Zmc2V0IGFuZCBmb3IgaG9yaXpvbnRhbCBhcHBsaWNhdGlvbnMgaXQgd2lsbCByZXR1cm4gdGhlIGxlZnQgb2Zmc2V0Lg0KCQkgKg0KCQkgKiAtPiAqKlNFVCoqOg0KCQkgKiBXaGVuIHVzZWQgYXMgYSBzZXR0ZXIgdGhpcyBtZXRob2QgcHJvZGVzIGEgd2F5IHRvIHBlcm1hbmVudGx5IG92ZXJ3cml0ZSB0aGUgY29udHJvbGxlcidzIHNjcm9sbCBwb3NpdGlvbiBjYWxjdWxhdGlvbi4gIA0KCQkgKiBBIHR5cGljYWwgdXNlY2FzZSBpcyB3aGVuIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgbm90IHJlZmxlY3RlZCBieSB0aGUgY29udGFpbmVycyBzY3JvbGxUb3Agb3Igc2Nyb2xsTGVmdCB2YWx1ZXMsIGJ1dCBmb3IgZXhhbXBsZSBieSB0aGUgaW5uZXIgb2Zmc2V0IG9mIGEgY2hpbGQgY29udGFpbmVyLiAgDQoJCSAqIE1vdmluZyBhIGNoaWxkIGNvbnRhaW5lciBpbnNpZGUgYSBwYXJlbnQgaXMgYSBjb21tb25seSB1c2VkIG1ldGhvZCBmb3Igc2V2ZXJhbCBzY3JvbGxpbmcgZnJhbWV3b3JrcywgaW5jbHVkaW5nIGlTY3JvbGwuICANCgkJICogQnkgcHJvdmlkaW5nIGFuIGFsdGVybmF0ZSBjYWxjdWxhdGlvbiBmdW5jdGlvbiB5b3UgY2FuIG1ha2Ugc3VyZSBTY3JvbGxNYWdpYyByZWNlaXZlcyB0aGUgY29ycmVjdCBzY3JvbGwgcG9zaXRpb24uICANCgkJICogUGxlYXNlIGFsc28gYmVhciBpbiBtaW5kIHRoYXQgeW91ciBmdW5jdGlvbiBzaG91bGQgcmV0dXJuIHkgdmFsdWVzIGZvciB2ZXJ0aWNhbCBzY3JvbGxzIGFuIHggZm9yIGhvcml6b250YWxzLg0KCQkgKg0KCQkgKiBUbyBjaGFuZ2UgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIHBsZWFzZSB1c2UgYFNjcm9sbE1hZ2ljLnNjcm9sbFRvKClgLg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCBzY3JvbGwgUG9zaXRpb24NCgkJICogdmFyIHNjcm9sbFBvcyA9IGNvbnRyb2xsZXIuc2Nyb2xsUG9zKCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgc2Nyb2xsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIG1ldGhvZA0KCQkgKiBjb250cm9sbGVyLnNjcm9sbFBvcyhmdW5jdGlvbiAoKSB7DQoJCSAqCXJldHVybiB0aGlzLmluZm8oInZlcnRpY2FsIikgPyAtJG15Y2hpbGRjb250YWluZXIueSA6IC0kbXljaGlsZGNvbnRhaW5lci54DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbc2Nyb2xsUG9zTWV0aG9kXSAtIFRoZSBmdW5jdGlvbiB0byBiZSB1c2VkIGZvciB0aGUgc2Nyb2xsIHBvc2l0aW9uIGNhbGN1bGF0aW9uIG9mIHRoZSBjb250YWluZXIuDQoJCSAqIEByZXR1cm5zIHsobnVtYmVyfFNjcm9sbE1hZ2ljKX0gQ3VycmVudCBzY3JvbGwgcG9zaXRpb24gb3IgcGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnNjcm9sbFBvcyA9IGZ1bmN0aW9uIChzY3JvbGxQb3NNZXRob2QpIHsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gZ2V0U2Nyb2xsUG9zLmNhbGwoU2Nyb2xsTWFnaWMpOw0KCQkJfSBlbHNlIHsgLy8gc2V0DQoJCQkJaWYgKCQuaXNGdW5jdGlvbihzY3JvbGxQb3NNZXRob2QpKSB7DQoJCQkJCWdldFNjcm9sbFBvcyA9IHNjcm9sbFBvc01ldGhvZDsNCgkJCQl9IGVsc2Ugew0KCQkJCQlsb2coMiwgIlByb3ZpZGVkIHZhbHVlIGZvciBtZXRob2QgJ3Njcm9sbFBvcycgaXMgbm90IGEgZnVuY3Rpb24uIFRvIGNoYW5nZSB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gdXNlICdzY3JvbGxUbygpJy4iKTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0KiogYWxsIGluZm9zIG9yIG9uZSBpbiBwYXJ0aWN1bGFyIGFib3V0IHRoZSBjb250cm9sbGVyLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHJldHVybnMgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIChudW1iZXIpDQoJCSAqIHZhciBzY3JvbGxQb3MgPSBjb250cm9sbGVyLmluZm8oInNjcm9sbFBvcyIpOw0KCQkgKg0KCQkgKiAvLyByZXR1cm5zIGFsbCBpbmZvcyBhcyBhbiBvYmplY3QNCgkJICogdmFyIGluZm9zID0gY29udHJvbGxlci5pbmZvKCk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbYWJvdXRdIC0gSWYgcGFzc2VkIG9ubHkgdGhpcyBpbmZvIHdpbGwgYmUgcmV0dXJuZWQgaW5zdGVhZCBvZiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwuICANCgkJIAkJCQkJCQkgVmFsaWQgb3B0aW9ucyBhcmU6DQoJCSAJCQkJCQkJICoqIGAic2l6ZSJgID0+IHRoZSBjdXJyZW50IHZpZXdwb3J0IHNpemUgb2YgdGhlIGNvbnRhaW5lcg0KCQkgCQkJCQkJCSAqKiBgInZlcnRpY2FsImAgPT4gdHJ1ZSBpZiB2ZXJ0aWNhbCBzY3JvbGxpbmcsIG90aGVyd2lzZSBmYWxzZQ0KCQkgCQkJCQkJCSAqKiBgInNjcm9sbFBvcyJgID0+IHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbg0KCQkgCQkJCQkJCSAqKiBgInNjcm9sbERpcmVjdGlvbiJgID0+IHRoZSBsYXN0IGtub3duIGRpcmVjdGlvbiBvZiB0aGUgc2Nyb2xsDQoJCSAJCQkJCQkJICoqIGAiY29udGFpbmVyImAgPT4gdGhlIGNvbnRhaW5lciBlbGVtZW50DQoJCSAJCQkJCQkJICoqIGAiaXNEb2N1bWVudCJgID0+IHRydWUgaWYgY29udGFpbmVyIGVsZW1lbnQgaXMgdGhlIGRvY3VtZW50Lg0KCQkgKiBAcmV0dXJucyB7KG1peGVkfG9iamVjdCl9IFRoZSByZXF1ZXN0ZWQgaW5mbyhzKS4NCgkJICovDQoJCXRoaXMuaW5mbyA9IGZ1bmN0aW9uIChhYm91dCkgew0KCQkJdmFyIHZhbHVlcyA9IHsNCgkJCQlzaXplOiBfdmlld1BvcnRTaXplLCAvLyBjb250YWlucyBoZWlnaHQgb3Igd2lkdGggKGluIHJlZ2FyZCB0byBvcmllbnRhdGlvbik7DQoJCQkJdmVydGljYWw6IF9vcHRpb25zLnZlcnRpY2FsLA0KCQkJCXNjcm9sbFBvczogX3Njcm9sbFBvcywNCgkJCQlzY3JvbGxEaXJlY3Rpb246IF9zY3JvbGxEaXJlY3Rpb24sDQoJCQkJY29udGFpbmVyOiBfb3B0aW9ucy5jb250YWluZXIsDQoJCQkJaXNEb2N1bWVudDogX2lzRG9jdW1lbnQNCgkJCX07DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0IGFsbCBhcyBhbiBvYmplY3QNCgkJCQlyZXR1cm4gdmFsdWVzOw0KCQkJfSBlbHNlIGlmICh2YWx1ZXNbYWJvdXRdICE9PSB1bmRlZmluZWQpIHsNCgkJCQlyZXR1cm4gdmFsdWVzW2Fib3V0XTsNCgkJCX0gZWxzZSB7DQoJCQkJbG9nKDEsICJFUlJPUjogb3B0aW9uIFwiIiArIGFib3V0ICsgIlwiIGlzIG5vdCBhdmFpbGFibGUiKTsNCgkJCQlyZXR1cm47DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0Kiogb3IgKipTZXQqKiB0aGUgY3VycmVudCBsb2dsZXZlbCBvcHRpb24gdmFsdWUuDQoJCSAqIEBwdWJsaWMNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHZhbHVlDQoJCSAqIHZhciBsb2dsZXZlbCA9IGNvbnRyb2xsZXIubG9nbGV2ZWwoKTsNCgkJICoNCgkgCSAqIC8vIHNldCBhIG5ldyB2YWx1ZQ0KCQkgKiBjb250cm9sbGVyLmxvZ2xldmVsKDMpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge251bWJlcn0gW25ld0xvZ2xldmVsXSAtIFRoZSBuZXcgbG9nbGV2ZWwgc2V0dGluZyBvZiB0aGUgU2Nyb2xsTWFnaWMgY29udHJvbGxlci4gYFswLTNdYA0KCQkgKiBAcmV0dXJucyB7KG51bWJlcnxTY3JvbGxNYWdpYyl9IEN1cnJlbnQgbG9nbGV2ZWwgb3IgcGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLmxvZ2xldmVsID0gZnVuY3Rpb24gKG5ld0xvZ2xldmVsKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9vcHRpb25zLmxvZ2xldmVsOw0KCQkJfSBlbHNlIGlmIChfb3B0aW9ucy5sb2dsZXZlbCAhPSBuZXdMb2dsZXZlbCkgeyAvLyBzZXQNCgkJCQlfb3B0aW9ucy5sb2dsZXZlbCA9IG5ld0xvZ2xldmVsOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIGN1cnJlbnQgZW5hYmxlZCBzdGF0ZSBvZiB0aGUgY29udHJvbGxlci4gIA0KCQkgKiBUaGlzIGNhbiBiZSB1c2VkIHRvIGRpc2FibGUgYWxsIFNjZW5lcyBjb25uZWN0ZWQgdG8gdGhlIGNvbnRyb2xsZXIgd2l0aG91dCBkZXN0cm95aW5nIG9yIHJlbW92aW5nIHRoZW0uDQoJCSAqIEBwdWJsaWMNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHZhbHVlDQoJCSAqIHZhciBlbmFibGVkID0gY29udHJvbGxlci5lbmFibGVkKCk7DQoJCSAqDQoJIAkgKiAvLyBkaXNhYmxlIHRoZSBjb250cm9sbGVyDQoJCSAqIGNvbnRyb2xsZXIuZW5hYmxlZChmYWxzZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW25ld1N0YXRlXSAtIFRoZSBuZXcgZW5hYmxlZCBzdGF0ZSBvZiB0aGUgY29udHJvbGxlciBgdHJ1ZWAgb3IgYGZhbHNlYC4NCgkJICogQHJldHVybnMgeyhib29sZWFufFNjcm9sbE1hZ2ljKX0gQ3VycmVudCBlbmFibGVkIHN0YXRlIG9yIHBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5lbmFibGVkID0gZnVuY3Rpb24gKG5ld1N0YXRlKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9lbmFibGVkOw0KCQkJfSBlbHNlIGlmIChfZW5hYmxlZCAhPSBuZXdTdGF0ZSkgeyAvLyBzZXQNCgkJCQlfZW5hYmxlZCA9ICEhbmV3U3RhdGU7DQoJCQkJU2Nyb2xsTWFnaWMudXBkYXRlU2NlbmUoX3NjZW5lT2JqZWN0cywgdHJ1ZSk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJCX07DQoJCQ0KCQkvKioNCgkJICogRGVzdHJveSB0aGUgQ29udHJvbGxlciwgYWxsIFNjZW5lcyBhbmQgZXZlcnl0aGluZy4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyB3aXRob3V0IHJlc2V0dGluZyB0aGUgc2NlbmVzDQoJCSAqIGNvbnRyb2xsZXIgPSBjb250cm9sbGVyLmRlc3Ryb3koKTsNCgkJICoNCgkgCSAqIC8vIHdpdGggc2NlbmUgcmVzZXQNCgkJICogY29udHJvbGxlciA9IGNvbnRyb2xsZXIuZGVzdHJveSh0cnVlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbcmVzZXRTY2VuZXM9ZmFsc2VdIC0gSWYgYHRydWVgIHRoZSBwaW5zIGFuZCB0d2VlbnMgKGlmIGV4aXN0ZW50KSBvZiBhbGwgc2NlbmVzIHdpbGwgYmUgcmVzZXQuDQoJCSAqIEByZXR1cm5zIHtudWxsfSBOdWxsIHRvIHVuc2V0IGhhbmRsZXIgdmFyaWFibGVzLg0KCQkgKi8NCgkJdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24gKHJlc2V0U2NlbmVzKSB7DQoJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KF9yZWZyZXNoSW50ZXJ2YWwpOw0KCQkJdmFyIGkgPSBfc2NlbmVPYmplY3RzLmxlbmd0aDsNCgkJCXdoaWxlIChpLS0pIHsNCgkJCQlfc2NlbmVPYmplY3RzW2ldLmRlc3Ryb3kocmVzZXRTY2VuZXMpOw0KCQkJfQ0KCQkJX29wdGlvbnMuY29udGFpbmVyLm9mZigic2Nyb2xsIHJlc2l6ZSIsIG9uQ2hhbmdlKTsNCgkJCWFuaW1hdGlvbkZyYW1lQ2FuY2VsQ2FsbGJhY2soX3VwZGF0ZUN5Y2xlKTsNCgkJCWxvZygzLCAiZGVzdHJveWVkICIgKyBOQU1FU1BBQ0UgKyAiIChyZXNldDogIiArIChyZXNldFNjZW5lcyA/ICJ0cnVlIiA6ICJmYWxzZSIpICsgIikiKTsNCgkJCXJldHVybiBudWxsOw0KCQl9Ow0KDQoJCS8vIElOSVQNCgkJY29uc3RydWN0KCk7DQoJCXJldHVybiBTY3JvbGxNYWdpYzsNCgl9Ow0KCVNjcm9sbE1hZ2ljLnZlcnNpb24gPSAiMS4yLjMiOyAvLyB2ZXJzaW9uIG51bWJlciBmb3IgYnJvd3NlciBnbG9iYWwNCglyZXR1cm4gU2Nyb2xsTWFnaWM7DQp9KTsNCg0KZGVmaW5lKCdTY3JvbGxTY2VuZScsIFsnanF1ZXJ5JywgJ1R3ZWVuTWF4JywgJ1RpbWVsaW5lTWF4J10sIGZ1bmN0aW9uICgkLCBUd2Vlbk1heCwgVGltZWxpbmVNYXgpIHsNCgkvKioNCgkgKiBBIFNjcm9sbFNjZW5lIGRlZmluZXMgd2hlcmUgdGhlIGNvbnRyb2xsZXIgc2hvdWxkIHJlYWN0IGFuZCBob3cuDQoJICoNCgkgKiBAY2xhc3MNCgkgKiBAZ2xvYmFsDQoJICoNCgkgKiBAZXhhbXBsZQ0KCSAqIC8vIGNyZWF0ZSBhIHN0YW5kYXJkIHNjZW5lIGFuZCBhZGQgaXQgdG8gYSBjb250cm9sbGVyDQoJICogbmV3IFNjcm9sbFNjZW5lKCkNCgkgKgkJLmFkZFRvKGNvbnRyb2xsZXIpOw0KCSAqDQoJICogLy8gY3JlYXRlIGEgc2NlbmUgd2l0aCBjdXN0b20gb3B0aW9ucyBhbmQgYXNzaWduIGEgaGFuZGxlciB0byBpdC4NCgkgKiB2YXIgc2NlbmUgPSBuZXcgU2Nyb2xsU2NlbmUoew0KCSAqIAkJZHVyYXRpb246IDEwMCwNCgkgKgkJb2Zmc2V0OiAyMDAsDQoJICoJCXRyaWdnZXJIb29rOiAib25FbnRlciIsDQoJICoJCXJldmVyc2U6IGZhbHNlDQoJICogfSk7DQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gT3B0aW9ucyBmb3IgdGhlIFNjZW5lLiBUaGUgb3B0aW9ucyBjYW4gYmUgdXBkYXRlZCBhdCBhbnkgdGltZS4gIA0KCSAJCQkJCQkJICAgSW5zdGVhZCBvZiBzZXR0aW5nIHRoZSBvcHRpb25zIGZvciBlYWNoIHNjZW5lIGluZGl2aWR1YWxseSB5b3UgY2FuIGFsc28gc2V0IHRoZW0gZ2xvYmFsbHkgaW4gdGhlIGNvbnRyb2xsZXIgYXMgdGhlIGNvbnRyb2xsZXJzIGBnbG9iYWxTY2VuZU9wdGlvbnNgIG9wdGlvbi4gVGhlIG9iamVjdCBhY2NlcHRzIHRoZSBzYW1lIHByb3BlcnRpZXMgYXMgdGhlIG9uZXMgYmVsb3cuICANCgkgCQkJCQkJCSAgIFdoZW4gYSBzY2VuZSBpcyBhZGRlZCB0byB0aGUgY29udHJvbGxlciB0aGUgb3B0aW9ucyBkZWZpbmVkIHVzaW5nIHRoZSBTY3JvbGxTY2VuZSBjb25zdHJ1Y3RvciB3aWxsIGJlIG92ZXJ3cml0dGVuIGJ5IHRob3NlIHNldCBpbiBgZ2xvYmFsU2NlbmVPcHRpb25zYC4NCgkgKiBAcGFyYW0geyhudW1iZXJ8ZnVuY3Rpb24pfSBbb3B0aW9ucy5kdXJhdGlvbj0wXSAtIFRoZSBkdXJhdGlvbiBvZiB0aGUgc2NlbmUuIA0KCSAJCQkJCQkJCQkJICBJZiBgMGAgdHdlZW5zIHdpbGwgYXV0by1wbGF5IHdoZW4gcmVhY2hpbmcgdGhlIHNjZW5lIHN0YXJ0IHBvaW50LCBwaW5zIHdpbGwgYmUgcGlubmVkIGluZGVmaW5ldGx5IHN0YXJ0aW5nIGF0IHRoZSBzdGFydCBwb3NpdGlvbi4gIA0KCSAJCQkJCQkJCQkJICBBIGZ1bmN0aW9uIHJldHVuaW5nIHRoZSBkdXJhdGlvbiB2YWx1ZSBpcyBhbHNvIHN1cHBvcnRlZC4gUGxlYXNlIHNlZSBgU2Nyb2xsU2NlbmUuZHVyYXRpb24oKWAgZm9yIGRldGFpbHMuDQoJICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLm9mZnNldD0wXSAtIE9mZnNldCBWYWx1ZSBmb3IgdGhlIFRyaWdnZXIgUG9zaXRpb24uIElmIG5vIHRyaWdnZXJFbGVtZW50IGlzIGRlZmluZWQgdGhpcyB3aWxsIGJlIHRoZSBzY3JvbGwgZGlzdGFuY2UgZnJvbSB0aGUgc3RhcnQgb2YgdGhlIHBhZ2UsIGFmdGVyIHdoaWNoIHRoZSBzY2VuZSB3aWxsIHN0YXJ0Lg0KCSAqIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpfSBbb3B0aW9ucy50cmlnZ2VyRWxlbWVudD1udWxsXSAtIFNlbGVjdG9yLCBET00gb2JqZWN0IG9yIGpRdWVyeSBPYmplY3QgdGhhdCBkZWZpbmVzIHRoZSBzdGFydCBvZiB0aGUgc2NlbmUuIElmIHVuZGVmaW5lZCB0aGUgc2NlbmUgd2lsbCBzdGFydCByaWdodCBhdCB0aGUgc3RhcnQgb2YgdGhlIHBhZ2UgKHVubGVzcyBhbiBvZmZzZXQgaXMgc2V0KS4NCgkgKiBAcGFyYW0geyhudW1iZXJ8c3RyaW5nKX0gW29wdGlvbnMudHJpZ2dlckhvb2s9Im9uQ2VudGVyIl0gLSBDYW4gYmUgYSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxIGRlZmluaW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdHJpZ2dlciBIb29rIGluIHJlbGF0aW9uIHRvIHRoZSB2aWV3cG9ydC4gIA0KCSAJCQkJCQkJCQkJCQkJCQkgIENhbiBhbHNvIGJlIGRlZmluZWQgdXNpbmcgYSBzdHJpbmc6DQoJIAkJCQkJCQkJCQkJCQkJCSAgKiogYCJvbkVudGVyImAgPT4gYDFgDQoJIAkJCQkJCQkJCQkJCQkJCSAgKiogYCJvbkNlbnRlciJgID0+IGAwLjVgDQoJIAkJCQkJCQkJCQkJCQkJCSAgKiogYCJvbkxlYXZlImAgPT4gYDBgDQoJICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy5yZXZlcnNlPXRydWVdIC0gU2hvdWxkIHRoZSBzY2VuZSByZXZlcnNlLCB3aGVuIHNjcm9sbGluZyB1cD8NCgkgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLnR3ZWVuQ2hhbmdlcz1mYWxzZV0gLSBUd2VlbnMgQW5pbWF0aW9uIHRvIHRoZSBwcm9ncmVzcyB0YXJnZXQgaW5zdGVhZCBvZiBzZXR0aW5nIGl0LiAgDQoJIAkJCQkJCQkJCQkJCSAgIERvZXMgbm90IGFmZmVjdCBhbmltYXRpb25zIHdoZXJlIGR1cmF0aW9uIGlzIGAwYC4NCgkgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMubG9nbGV2ZWw9Ml0gLSBMb2dsZXZlbCBmb3IgZGVidWdnaW5nLiBOb3RlIHRoYXQgbG9nZ2luZyBpcyBkaXNhYmxlZCBpbiB0aGUgbWluaWZpZWQgdmVyc2lvbiBvZiBTY3JvbGxNYWdpYy4NCgkgCQkJCQkJCQkJCSAgKiogYDBgID0+IHNpbGVudA0KCSAJCQkJCQkJCQkJICAqKiBgMWAgPT4gZXJyb3JzDQoJIAkJCQkJCQkJCQkgICoqIGAyYCA9PiBlcnJvcnMsIHdhcm5pbmdzDQoJIAkJCQkJCQkJCQkgICoqIGAzYCA9PiBlcnJvcnMsIHdhcm5pbmdzLCBkZWJ1Z2luZm8NCgkgKiANCgkgKi8NCglTY3JvbGxTY2VuZSA9IGZ1bmN0aW9uIChvcHRpb25zKSB7DQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBzZXR0aW5ncw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCXZhcg0KCQkJVFJJR0dFUl9IT09LX1ZBTFVFUyA9IHsib25DZW50ZXIiIDogMC41LCAib25FbnRlciIgOiAxLCAib25MZWF2ZSIgOiAwfSwNCgkJCU5BTUVTUEFDRSA9ICJTY3JvbGxTY2VuZSIsDQoJCQlERUZBVUxUX09QVElPTlMgPSB7DQoJCQkJZHVyYXRpb246IDAsDQoJCQkJb2Zmc2V0OiAwLA0KCQkJCXRyaWdnZXJFbGVtZW50OiBudWxsLA0KCQkJCXRyaWdnZXJIb29rOiAib25DZW50ZXIiLA0KCQkJCXJldmVyc2U6IHRydWUsDQoJCQkJdHdlZW5DaGFuZ2VzOiBmYWxzZSwNCgkJCQlsb2dsZXZlbDogMg0KCQkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHByaXZhdGUgdmFycw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCXZhcg0KCQkJU2Nyb2xsU2NlbmUgPSB0aGlzLA0KCQkJX29wdGlvbnMgPSAkLmV4dGVuZCh7fSwgREVGQVVMVF9PUFRJT05TLCBvcHRpb25zKSwNCgkJCV9zdGF0ZSA9ICdCRUZPUkUnLA0KCQkJX3Byb2dyZXNzID0gMCwNCgkJCV9zY3JvbGxPZmZzZXQgPSB7c3RhcnQ6IDAsIGVuZDogMH0sIC8vIHJlZmxlY3RzIHRoZSBwYXJlbnQncyBzY3JvbGwgcG9zaXRpb24gZm9yIHRoZSBzdGFydCBhbmQgZW5kIG9mIHRoZSBzY2VuZSByZXNwZWN0aXZlbHkNCgkJCV90cmlnZ2VyUG9zID0gMCwNCgkJCV9lbmFibGVkID0gdHJ1ZSwNCgkJCV9kdXJhdGlvblVwZGF0ZU1ldGhvZCwNCgkJCV9wYXJlbnQsDQoJCQlfdHdlZW4sDQoJCQlfcGluLA0KCQkJX3Bpbk9wdGlvbnMsDQoJCQlfY3NzQ2xhc3NlcywNCgkJCV9jc3NDbGFzc0VsbTsNCg0KCQkvLyBvYmplY3QgY29udGFpbmluZyB2YWxpZGF0b3IgZnVuY3Rpb25zIGZvciB2YXJpb3VzIG9wdGlvbnMNCgkJdmFyIF92YWxpZGF0ZSA9IHsNCgkJCSJ1bmtub3duT3B0aW9uU3VwcGxpZWQiIDogZnVuY3Rpb24gKCkgew0KCQkJCQkkLmVhY2goX29wdGlvbnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7DQoJCQkJCWlmICghREVGQVVMVF9PUFRJT05TLmhhc093blByb3BlcnR5KGtleSkpIHsNCgkJCQkJCWxvZygyLCAiV0FSTklORzogVW5rbm93biBvcHRpb24gXCIiICsga2V5ICsgIlwiIik7DQoJCQkJCQlkZWxldGUgX29wdGlvbnNba2V5XTsNCgkJCQkJfQ0KCQkJCX0pOw0KCQkJfSwNCgkJCSJkdXJhdGlvbiIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJaWYgKCQuaXNGdW5jdGlvbihfb3B0aW9ucy5kdXJhdGlvbikpIHsNCgkJCQkJX2R1cmF0aW9uVXBkYXRlTWV0aG9kID0gX29wdGlvbnMuZHVyYXRpb247DQoJCQkJCXRyeSB7DQoJCQkJCQlfb3B0aW9ucy5kdXJhdGlvbiA9IHBhcnNlRmxvYXQoX2R1cmF0aW9uVXBkYXRlTWV0aG9kKCkpOw0KCQkJCQl9IGNhdGNoIChlKSB7DQoJCQkJCQlsb2coMSwgIkVSUk9SOiBJbnZhbGlkIHJldHVybiB2YWx1ZSBvZiBzdXBwbGllZCBmdW5jdGlvbiBmb3Igb3B0aW9uIFwiZHVyYXRpb25cIjoiLCBfb3B0aW9ucy5kdXJhdGlvbik7DQoJCQkJCQlfZHVyYXRpb25VcGRhdGVNZXRob2QgPSB1bmRlZmluZWQ7DQoJCQkJCQlfb3B0aW9ucy5kdXJhdGlvbiA9IERFRkFVTFRfT1BUSU9OUy5kdXJhdGlvbjsNCgkJCQkJfQ0KCQkJCX0gZWxzZSB7DQoJCQkJCV9vcHRpb25zLmR1cmF0aW9uID0gcGFyc2VGbG9hdChfb3B0aW9ucy5kdXJhdGlvbik7DQoJCQkJCWlmICghJC5pc051bWVyaWMoX29wdGlvbnMuZHVyYXRpb24pIHx8IF9vcHRpb25zLmR1cmF0aW9uICZsdDsgMCkgew0KCQkJCQkJbG9nKDEsICJFUlJPUjogSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwiZHVyYXRpb25cIjoiLCBfb3B0aW9ucy5kdXJhdGlvbik7DQoJCQkJCQlfb3B0aW9ucy5kdXJhdGlvbiA9IERFRkFVTFRfT1BUSU9OUy5kdXJhdGlvbjsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0sDQoJCQkib2Zmc2V0IiA6IGZ1bmN0aW9uICgpIHsNCgkJCQlfb3B0aW9ucy5vZmZzZXQgPSBwYXJzZUZsb2F0KF9vcHRpb25zLm9mZnNldCk7DQoJCQkJaWYgKCEkLmlzTnVtZXJpYyhfb3B0aW9ucy5vZmZzZXQpKSB7DQoJCQkJCWxvZygxLCAiRVJST1I6IEludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcIm9mZnNldFwiOiIsIF9vcHRpb25zLm9mZnNldCk7DQoJCQkJCV9vcHRpb25zLm9mZnNldCA9IERFRkFVTFRfT1BUSU9OUy5vZmZzZXQ7DQoJCQkJfQ0KCQkJfSwNCgkJCSJ0cmlnZ2VyRWxlbWVudCIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJaWYgKF9vcHRpb25zLnRyaWdnZXJFbGVtZW50ICE9PSBudWxsICZhbXA7JmFtcDsgJChfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCkubGVuZ3RoID09PSAwKSB7DQoJCQkJCWxvZygxLCAiRVJST1I6IEVsZW1lbnQgZGVmaW5lZCBpbiBvcHRpb24gXCJ0cmlnZ2VyRWxlbWVudFwiIHdhcyBub3QgZm91bmQ6IiwgX29wdGlvbnMudHJpZ2dlckVsZW1lbnQpOw0KCQkJCQlfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCA9IERFRkFVTFRfT1BUSU9OUy50cmlnZ2VyRWxlbWVudDsNCgkJCQl9DQoJCQl9LA0KCQkJInRyaWdnZXJIb29rIiA6IGZ1bmN0aW9uICgpIHsNCgkJCQlpZiAoIShfb3B0aW9ucy50cmlnZ2VySG9vayBpbiBUUklHR0VSX0hPT0tfVkFMVUVTKSkgew0KCQkJCQlpZiAoJC5pc051bWVyaWMoX29wdGlvbnMudHJpZ2dlckhvb2spKSB7DQoJCQkJCQlfb3B0aW9ucy50cmlnZ2VySG9vayA9IE1hdGgubWF4KDAsIE1hdGgubWluKHBhcnNlRmxvYXQoX29wdGlvbnMudHJpZ2dlckhvb2spLCAxKSk7IC8vICBtYWtlIHN1cmUgaXRzIGJldHdlZWVuIDAgYW5kIDENCgkJCQkJfSBlbHNlIHsNCgkJCQkJCWxvZygxLCAiRVJST1I6IEludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcInRyaWdnZXJIb29rXCI6ICIsIF9vcHRpb25zLnRyaWdnZXJIb29rKTsNCgkJCQkJCV9vcHRpb25zLnRyaWdnZXJIb29rID0gREVGQVVMVF9PUFRJT05TLnRyaWdnZXJIb29rOw0KCQkJCQl9DQoJCQkJfQ0KCQkJfSwNCgkJCSJyZXZlcnNlIiA6IGZ1bmN0aW9uICgpIHsNCgkJCQlfb3B0aW9ucy5yZXZlcnNlID0gISFfb3B0aW9ucy5yZXZlcnNlOyAvLyBmb3JjZSBib29sZWFuDQoJCQl9LA0KCQkJInR3ZWVuQ2hhbmdlcyIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJX29wdGlvbnMudHdlZW5DaGFuZ2VzID0gISFfb3B0aW9ucy50d2VlbkNoYW5nZXM7IC8vIGZvcmNlIGJvb2xlYW4NCgkJCX0sDQoJCQkibG9nbGV2ZWwiIDogZnVuY3Rpb24gKCkgew0KCQkJCV9vcHRpb25zLmxvZ2xldmVsID0gcGFyc2VJbnQoX29wdGlvbnMubG9nbGV2ZWwpOw0KCQkJCWlmICghJC5pc051bWVyaWMoX29wdGlvbnMubG9nbGV2ZWwpIHx8IF9vcHRpb25zLmxvZ2xldmVsICZsdDsgMCB8fCBfb3B0aW9ucy5sb2dsZXZlbCA+IDMpIHsNCgkJCQkJdmFyIHdyb25ndmFsID0gX29wdGlvbnMubG9nbGV2ZWw7DQoJCQkJCV9vcHRpb25zLmxvZ2xldmVsID0gREVGQVVMVF9PUFRJT05TLmxvZ2xldmVsOw0KCQkJCQlsb2coMSwgIkVSUk9SOiBJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJsb2dsZXZlbFwiOiIsIHdyb25ndmFsKTsNCgkJCQl9DQoJCQl9LA0KCQl9Ow0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHJpdmF0ZSBmdW5jdGlvbnMNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQkvKioNCgkJICogSW50ZXJuYWwgY29uc3RydWN0b3IgZnVuY3Rpb24gb2YgU2Nyb2xsTWFnaWMNCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciBjb25zdHJ1Y3QgPSBmdW5jdGlvbiAoKSB7DQoJCQl2YWxpZGF0ZU9wdGlvbigpOw0KDQoJCQkvLyBldmVudCBsaXN0ZW5lcnMNCgkJCVNjcm9sbFNjZW5lDQoJCQkJLm9uKCJjaGFuZ2UuaW50ZXJuYWwiLCBmdW5jdGlvbiAoZSkgew0KCQkJCQlpZiAoZS53aGF0ICE9PSAibG9nbGV2ZWwiICZhbXA7JmFtcDsgZS53aGF0ICE9PSAidHdlZW5DaGFuZ2VzIikgeyAvLyBubyBuZWVkIGZvciBhIHNjZW5lIHVwZGF0ZSBzY2VuZSB3aXRoIHRoZXNlIG9wdGlvbnMuLi4NCgkJCQkJCWlmIChlLndoYXQgPT09ICJ0cmlnZ2VyRWxlbWVudCIpIHsNCgkJCQkJCQl1cGRhdGVUcmlnZ2VyRWxlbWVudFBvc2l0aW9uKCk7DQoJCQkJCQl9IGVsc2UgaWYgKGUud2hhdCA9PT0gInJldmVyc2UiKSB7IC8vIHRoZSBvbmx5IHByb3BlcnR5IGxlZnQgdGhhdCBtYXkgaGF2ZSBhbiBpbXBhY3Qgb24gdGhlIGN1cnJlbnQgc2NlbmUgc3RhdGUuIEV2ZXJ5dGhpbmcgZWxzZSBpcyBoYW5kbGVkIGJ5IHRoZSBzaGlmdCBldmVudC4NCgkJCQkJCQlTY3JvbGxTY2VuZS51cGRhdGUoKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0pDQoJCQkJLm9uKCJzaGlmdC5pbnRlcm5hbCIsIGZ1bmN0aW9uIChlKSB7DQoJCQkJCXVwZGF0ZVNjcm9sbE9mZnNldCgpOw0KCQkJCQlTY3JvbGxTY2VuZS51cGRhdGUoKTsgLy8gdXBkYXRlIHNjZW5lIHRvIHJlZmxlY3QgbmV3IHBvc2l0aW9uDQoJCQkJCWlmICgoX3N0YXRlID09PSAiQUZURVIiICZhbXA7JmFtcDsgZS5yZWFzb24gPT09ICJkdXJhdGlvbiIpIHx8IChfc3RhdGUgPT09ICdEVVJJTkcnICZhbXA7JmFtcDsgX29wdGlvbnMuZHVyYXRpb24gPT09IDApKSB7DQoJCQkJCQkvLyBpZiBbZHVyYXRpb24gY2hhbmdlZCBhZnRlciBhIHNjZW5lIChpbnNpZGUgc2NlbmUgcHJvZ3Jlc3MgdXBkYXRlcyBwaW4gcG9zaXRpb24pXSBvciBbZHVyYXRpb24gaXMgMCwgd2UgYXJlIGluIHBpbiBwaGFzZSBhbmQgc29tZSBvdGhlciB2YWx1ZSBjaGFuZ2VkXS4NCgkJCQkJCXVwZGF0ZVBpblN0YXRlKCk7DQoJCQkJCX0NCgkJCQl9KQ0KCQkJCS5vbigicHJvZ3Jlc3MuaW50ZXJuYWwiLCBmdW5jdGlvbiAoZSkgew0KCQkJCQl1cGRhdGVUd2VlblByb2dyZXNzKCk7DQoJCQkJCXVwZGF0ZVBpblN0YXRlKCk7DQoJCQkJfSkNCgkJCQkub24oImRlc3Ryb3kiLCBmdW5jdGlvbiAoZSkgew0KCQkJCQllLnByZXZlbnREZWZhdWx0KCk7IC8vIG90aGVyd2lzZSBqUXVlcnkgd291bGQgY2FsbCB0YXJnZXQuZGVzdHJveSgpIGJ5IGRlZmF1bHQuDQoJCQkJfSk7DQoJCX07DQoJCQ0KCQkvKioNCgkJICogU2VuZCBhIGRlYnVnIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUuDQoJCSAqIEBwcml2YXRlDQoJCSAqDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBsb2dsZXZlbCAtIFRoZSBsb2dsZXZlbCByZXF1aXJlZCB0byBpbml0aWF0ZSBvdXRwdXQgZm9yIHRoZSBtZXNzYWdlLg0KCQkgKiBAcGFyYW0gey4uLm1peGVkfSBvdXRwdXQgLSBPbmUgb3IgbW9yZSB2YXJpYWJsZXMgdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBjb25zb2xlLg0KCQkgKi8NCgkJdmFyIGxvZyA9IGZ1bmN0aW9uIChsb2dsZXZlbCwgb3V0cHV0KSB7DQoJCQlpZiAoX29wdGlvbnMubG9nbGV2ZWwgPj0gbG9nbGV2ZWwpIHsNCgkJCQl2YXINCgkJCQkJcHJlZml4ID0gIigiICsgTkFNRVNQQUNFICsgIikgLT4iLA0KCQkJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7DQoJCQkJYXJncy51bnNoaWZ0KGxvZ2xldmVsLCBwcmVmaXgpOw0KCQkJCWRlYnVnLmFwcGx5KHdpbmRvdywgYXJncyk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIENoZWNrcyB0aGUgdmFsaWRpdHkgb2YgYSBzcGVjaWZpYyBvciBhbGwgb3B0aW9ucyBhbmQgcmVzZXQgdG8gZGVmYXVsdCBpZiBuZWNjZXNzYXJ5Lg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIHZhbGlkYXRlT3B0aW9uID0gZnVuY3Rpb24gKGNoZWNrKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsNCgkJCQljaGVjayA9IFtdOw0KCQkJCWZvciAodmFyIGtleSBpbiBfdmFsaWRhdGUpew0KCQkJCQljaGVjay5wdXNoKGtleSk7DQoJCQkJfQ0KCQkJfSBlbHNlIGlmICghJC5pc0FycmF5KGNoZWNrKSkgew0KCQkJCWNoZWNrID0gW2NoZWNrXTsNCgkJCX0NCgkJCSQuZWFjaChjaGVjaywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsNCgkJCQlpZiAoX3ZhbGlkYXRlW3ZhbHVlXSkgew0KCQkJCQlfdmFsaWRhdGVbdmFsdWVdKCk7DQoJCQkJfQ0KCQkJfSk7DQoJCX07DQoNCgkJLyoqDQoJCSAqIEhlbHBlciB1c2VkIGJ5IHRoZSBzZXR0ZXIvZ2V0dGVycyBmb3Igc2NlbmUgb3B0aW9ucw0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIGNoYW5nZU9wdGlvbiA9IGZ1bmN0aW9uKHZhcm5hbWUsIG5ld3ZhbCkgew0KCQkJdmFyDQoJCQkJY2hhbmdlZCA9IGZhbHNlLA0KCQkJCW9sZHZhbCA9IF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJaWYgKF9vcHRpb25zW3Zhcm5hbWVdICE9IG5ld3ZhbCkgew0KCQkJCV9vcHRpb25zW3Zhcm5hbWVdID0gbmV3dmFsOw0KCQkJCXZhbGlkYXRlT3B0aW9uKHZhcm5hbWUpOyAvLyByZXNldHMgdG8gZGVmYXVsdCBpZiBuZWNlc3NhcnkNCgkJCQljaGFuZ2VkID0gb2xkdmFsICE9IF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJfQ0KCQkJcmV0dXJuIGNoYW5nZWQ7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZSB0aGUgc3RhcnQgYW5kIGVuZCBzY3JvbGxPZmZzZXQgb2YgdGhlIGNvbnRhaW5lci4NCgkJICogVGhlIHBvc2l0aW9ucyByZWZsZWN0IHdoYXQgdGhlIHBhcmVudCdzIHNjcm9sbCBwb3NpdGlvbiB3aWxsIGJlIGF0IHRoZSBzdGFydCBhbmQgZW5kIHJlc3BlY3RpdmVseS4NCgkJICogSXMgY2FsbGVkLCB3aGVuOg0KCQkgKiAgIC0gU2Nyb2xsU2NlbmUgZXZlbnQgImNoYW5nZSIgaXMgY2FsbGVkIHdpdGg6IG9mZnNldCwgdHJpZ2dlckhvb2ssIGR1cmF0aW9uIA0KCQkgKiAgIC0gc2Nyb2xsIGNvbnRhaW5lciBldmVudCAicmVzaXplIiBpcyBjYWxsZWQNCgkJICogICAtIHRoZSBwb3NpdGlvbiBvZiB0aGUgdHJpZ2dlckVsZW1lbnQgY2hhbmdlcw0KCQkgKiAgIC0gdGhlIHBhcmVudCBjaGFuZ2VzIC0+IGFkZFRvKCkNCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB1cGRhdGVTY3JvbGxPZmZzZXQgPSBmdW5jdGlvbiAoKSB7DQoJCQlfc2Nyb2xsT2Zmc2V0ID0ge3N0YXJ0OiBfdHJpZ2dlclBvcyArIF9vcHRpb25zLm9mZnNldH07DQoJCQlpZiAoX3BhcmVudCAmYW1wOyZhbXA7IF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KSB7DQoJCQkJLy8gdGFrZSBhd2F5IHRyaWdnZXJIb29rIHBvcnRpb24gdG8gZ2V0IHJlbGF0aXZlIHRvIHRvcA0KCQkJCV9zY3JvbGxPZmZzZXQuc3RhcnQgLT0gX3BhcmVudC5pbmZvKCJzaXplIikgKiBTY3JvbGxTY2VuZS50cmlnZ2VySG9vaygpOw0KCQkJfQ0KCQkJX3Njcm9sbE9mZnNldC5lbmQgPSBfc2Nyb2xsT2Zmc2V0LnN0YXJ0ICsgX29wdGlvbnMuZHVyYXRpb247DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZXMgdGhlIGR1cmF0aW9uIGlmIHNldCB0byBhIGR5bmFtaWMgZnVuY3Rpb24uDQoJCSAqIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCB3aGVuIHRoZSBzY2VuZSBpcyBhZGRlZCB0byBhIGNvbnRyb2xsZXIgYW5kIGluIHJlZ3VsYXIgaW50ZXJ2YWxzIGZyb20gdGhlIGNvbnRyb2xsZXIgdGhyb3VnaCBzY2VuZS5yZWZyZXNoKCkuDQoJCSAqIA0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIGlmIHRoZSBkdXJhdGlvbiBjaGFuZ2VkDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuc2hpZnR9LCBpZiB0aGUgZHVyYXRpb24gY2hhbmdlZA0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtzdXBwcmVzc0V2ZW50cz1mYWxzZV0gLSBJZiB0cnVlIHRoZSBzaGlmdCBldmVudCB3aWxsIGJlIHN1cHByZXNzZWQuDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgdXBkYXRlRHVyYXRpb24gPSBmdW5jdGlvbiAoc3VwcHJlc3NFdmVudHMpIHsNCgkJCS8vIHVwZGF0ZSBkdXJhdGlvbg0KCQkJaWYgKF9kdXJhdGlvblVwZGF0ZU1ldGhvZCkgew0KCQkJCXZhciB2YXJuYW1lID0gImR1cmF0aW9uIjsNCgkJCQlpZiAoY2hhbmdlT3B0aW9uKHZhcm5hbWUsIF9kdXJhdGlvblVwZGF0ZU1ldGhvZC5jYWxsKFNjcm9sbFNjZW5lKSkgJmFtcDsmYW1wOyAhc3VwcHJlc3NFdmVudHMpIHsgLy8gc2V0DQoJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoImNoYW5nZSIsIHt3aGF0OiB2YXJuYW1lLCBuZXd2YWw6IF9vcHRpb25zW3Zhcm5hbWVdfSk7DQoJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogdmFybmFtZX0pOw0KCQkJCX0NCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlcyB0aGUgcG9zaXRpb24gb2YgdGhlIHRyaWdnZXJFbGVtZW50LCBpZiBwcmVzZW50Lg0KCQkgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgLi4uDQoJCSAqICAtIC4uLiB3aGVuIHRoZSB0cmlnZ2VyRWxlbWVudCBpcyBjaGFuZ2VkDQoJCSAqICAtIC4uLiB3aGVuIHRoZSBzY2VuZSBpcyBhZGRlZCB0byBhIChuZXcpIGNvbnRyb2xsZXINCgkJICogIC0gLi4uIGluIHJlZ3VsYXIgaW50ZXJ2YWxzIGZyb20gdGhlIGNvbnRyb2xsZXIgdGhyb3VnaCBzY2VuZS5yZWZyZXNoKCkuDQoJCSAqIA0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLnNoaWZ0fSwgaWYgdGhlIHBvc2l0aW9uIGNoYW5nZWQNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbc3VwcHJlc3NFdmVudHM9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgc2hpZnQgZXZlbnQgd2lsbCBiZSBzdXBwcmVzc2VkLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIHVwZGF0ZVRyaWdnZXJFbGVtZW50UG9zaXRpb24gPSBmdW5jdGlvbiAoc3VwcHJlc3NFdmVudHMpIHsNCgkJCXZhciBlbGVtZW50UG9zID0gMDsNCgkJCWlmIChfcGFyZW50ICZhbXA7JmFtcDsgX29wdGlvbnMudHJpZ2dlckVsZW1lbnQpIHsNCgkJCQl2YXINCgkJCQkJZWxlbWVudCA9ICQoX29wdGlvbnMudHJpZ2dlckVsZW1lbnQpLmZpcnN0KCksDQoJCQkJCWNvbnRyb2xsZXJJbmZvID0gX3BhcmVudC5pbmZvKCksDQoJCQkJCWNvbnRhaW5lck9mZnNldCA9IGdldE9mZnNldChjb250cm9sbGVySW5mby5jb250YWluZXIpLCAvLyBjb250YWluZXIgcG9zaXRpb24gaXMgbmVlZGVkIGJlY2F1c2UgZWxlbWVudCBvZmZzZXQgaXMgcmV0dXJuZWQgaW4gcmVsYXRpb24gdG8gZG9jdW1lbnQsIG5vdCBpbiByZWxhdGlvbiB0byBjb250YWluZXIuDQoJCQkJCXBhcmFtID0gY29udHJvbGxlckluZm8udmVydGljYWwgPyAidG9wIiA6ICJsZWZ0IjsgLy8gd2hpY2ggcGFyYW0gaXMgb2YgaW50ZXJlc3QgPw0KCQkJCQkNCgkJCQkvLyBpZiBwYXJlbnQgaXMgc3BhY2VyLCB1c2Ugc3BhY2VyIHBvc2l0aW9uIGluc3RlYWQgc28gY29ycmVjdCBzdGFydCBwb3NpdGlvbiBpcyByZXR1cm5lZCBmb3IgcGlubmVkIGVsZW1lbnRzLg0KCQkJCXdoaWxlIChlbGVtZW50LnBhcmVudCgpLmRhdGEoIlNjcm9sbE1hZ2ljUGluU3BhY2VyIikpIHsNCgkJCQkJZWxlbWVudCA9IGVsZW1lbnQucGFyZW50KCk7DQoJCQkJfQ0KDQoJCQkJdmFyIGVsZW1lbnRPZmZzZXQgPSBnZXRPZmZzZXQoZWxlbWVudCk7DQoNCgkJCQlpZiAoIWNvbnRyb2xsZXJJbmZvLmlzRG9jdW1lbnQpIHsgLy8gY29udGFpbmVyIGlzIG5vdCB0aGUgZG9jdW1lbnQgcm9vdCwgc28gc3Vic3RyYWN0IHNjcm9sbCBQb3NpdGlvbiB0byBnZXQgY29ycmVjdCB0cmlnZ2VyIGVsZW1lbnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gc2Nyb2xsY29udGVudA0KCQkJCQljb250YWluZXJPZmZzZXRbcGFyYW1dIC09IF9wYXJlbnQuc2Nyb2xsUG9zKCk7DQoJCQkJfQ0KDQoJCQkJZWxlbWVudFBvcyA9IGVsZW1lbnRPZmZzZXRbcGFyYW1dIC0gY29udGFpbmVyT2Zmc2V0W3BhcmFtXTsNCgkJCX0NCgkJCXZhciBjaGFuZ2VkID0gZWxlbWVudFBvcyAhPSBfdHJpZ2dlclBvczsNCgkJCV90cmlnZ2VyUG9zID0gZWxlbWVudFBvczsNCgkJCWlmIChjaGFuZ2VkICZhbXA7JmFtcDsgIXN1cHByZXNzRXZlbnRzKSB7DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigic2hpZnQiLCB7cmVhc29uOiAidHJpZ2dlckVsZW1lbnRQb3NpdGlvbiJ9KTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlIHRoZSB0d2VlbiBwcm9ncmVzcy4NCgkJICogQHByaXZhdGUNCgkJICoNCgkJICogQHBhcmFtIHtudW1iZXJ9IFt0b10gLSBJZiBub3Qgc2V0IHRoZSBzY2VuZSBQcm9ncmVzcyB3aWxsIGJlIHVzZWQuIChtb3N0IGNhc2VzKQ0KCQkgKiBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHRoZSBUd2VlbiB3YXMgdXBkYXRlZC4gDQoJCSAqLw0KCQl2YXIgdXBkYXRlVHdlZW5Qcm9ncmVzcyA9IGZ1bmN0aW9uICh0bykgew0KCQkJaWYgKF90d2Vlbikgew0KCQkJCXZhciBwcm9ncmVzcyA9ICh0byA+PSAwICZhbXA7JmFtcDsgdG8gJmx0Oz0gMSkgPyB0byA6IF9wcm9ncmVzczsNCgkJCQlpZiAoX3R3ZWVuLnJlcGVhdCgpID09PSAtMSkgew0KCQkJCQkvLyBpbmZpbml0ZSBsb29wLCBzbyBub3QgaW4gcmVsYXRpb24gdG8gcHJvZ3Jlc3MNCgkJCQkJaWYgKF9zdGF0ZSA9PT0gIkRVUklORyIgJmFtcDsmYW1wOyBfdHdlZW4ucGF1c2VkKCkpIHsNCgkJCQkJCV90d2Vlbi5wbGF5KCk7DQoJCQkJCX0gZWxzZSBpZiAoX3N0YXRlICE9PSAiRFVSSU5HIiAmYW1wOyZhbXA7ICFfdHdlZW4ucGF1c2VkKCkpIHsNCgkJCQkJCV90d2Vlbi5wYXVzZSgpOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQl9DQoJCQkJfSBlbHNlIGlmIChwcm9ncmVzcyAhPSBfdHdlZW4ucHJvZ3Jlc3MoKSkgeyAvLyBkbyB3ZSBldmVuIG5lZWQgdG8gdXBkYXRlIHRoZSBwcm9ncmVzcz8NCgkJCQkJLy8gbm8gaW5maW5pdGUgbG9vcCAtIHNvIHNob3VsZCB3ZSBqdXN0IHBsYXkgb3IgZ28gdG8gYSBzcGVjaWZpYyBwb2ludCBpbiB0aW1lPw0KCQkJCQlpZiAoX29wdGlvbnMuZHVyYXRpb24gPT09IDApIHsNCgkJCQkJCS8vIHBsYXkgdGhlIGFuaW1hdGlvbg0KCQkJCQkJaWYgKF9zdGF0ZSA9PT0gIkRVUklORyIpIHsgLy8gcGxheSBmcm9tIDAgdG8gMQ0KCQkJCQkJCV90d2Vlbi5wbGF5KCk7DQoJCQkJCQl9IGVsc2UgeyAvLyBwbGF5IGZyb20gMSB0byAwDQoJCQkJCQkJX3R3ZWVuLnJldmVyc2UoKTsNCgkJCQkJCX0NCgkJCQkJfSBlbHNlIHsNCgkJCQkJCS8vIGdvIHRvIGEgc3BlY2lmaWMgcG9pbnQgaW4gdGltZQ0KCQkJCQkJaWYgKF9vcHRpb25zLnR3ZWVuQ2hhbmdlcykgew0KCQkJCQkJCS8vIGdvIHNtb290aA0KCQkJCQkJCV90d2Vlbi50d2VlblRvKHByb2dyZXNzICogX3R3ZWVuLmR1cmF0aW9uKCkpOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkvLyBqdXN0IGhhcmQgc2V0IGl0DQoJCQkJCQkJX3R3ZWVuLnByb2dyZXNzKHByb2dyZXNzKS5wYXVzZSgpOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfSBlbHNlIHsNCgkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCX0NCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0gZWxzZSB7DQoJCQkJcmV0dXJuIGZhbHNlOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGUgdGhlIHBpbiBzdGF0ZS4NCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB1cGRhdGVQaW5TdGF0ZSA9IGZ1bmN0aW9uIChmb3JjZVVucGluKSB7DQoJCQlpZiAoX3BpbiAmYW1wOyZhbXA7IF9wYXJlbnQpIHsNCgkJCQl2YXIgDQoJCQkJCWNvbnRhaW5lckluZm8gPSBfcGFyZW50LmluZm8oKTsNCg0KCQkJCWlmICghZm9yY2VVbnBpbiAmYW1wOyZhbXA7IF9zdGF0ZSA9PT0gIkRVUklORyIpIHsgLy8gZHVyaW5nIHNjZW5lIG9yIGlmIGR1cmF0aW9uIGlzIDAgYW5kIHdlIGFyZSBwYXN0IHRoZSB0cmlnZ2VyDQoJCQkJCS8vIHBpbm5lZCBzdGF0ZQ0KCQkJCQlpZiAoX3Bpbi5jc3MoInBvc2l0aW9uIikgIT0gImZpeGVkIikgew0KCQkJCQkJLy8gY2hhbmdlIHN0YXRlIGJlZm9yZSB1cGRhdGluZyBwaW4gc3BhY2VyIChwb3NpdGlvbiBjaGFuZ2VzIGR1ZSB0byBmaXhlZCBjb2xsYXBzaW5nIG1pZ2h0IG9jY3VyLikNCgkJCQkJCV9waW4uY3NzKCJwb3NpdGlvbiIsICJmaXhlZCIpOw0KCQkJCQkJLy8gdXBkYXRlIHBpbiBzcGFjZXINCgkJCQkJCXVwZGF0ZVBpblNwYWNlclNpemUoKTsNCgkJCQkJCS8vIGFkZCBwaW5uZWQgY2xhc3MNCgkJCQkJCV9waW4uYWRkQ2xhc3MoX3Bpbk9wdGlvbnMucGlubmVkQ2xhc3MpOw0KCQkJCQl9DQoNCgkJCQkJdmFyDQoJCQkJCQlmaXhlZFBvcyA9IGdldE9mZnNldChfcGluT3B0aW9ucy5zcGFjZXIsIHRydWUpLCAvLyBnZXQgdmlld3BvcnQgcG9zaXRpb24gb2Ygc3BhY2VyDQogCQkJCQkJc2Nyb2xsRGlzdGFuY2UgPSBfb3B0aW9ucy5yZXZlcnNlIHx8IF9vcHRpb25zLmR1cmF0aW9uID09PSAwID8NCiAJCQkJCQkJCQkJIAkgY29udGFpbmVySW5mby5zY3JvbGxQb3MgLSBfc2Nyb2xsT2Zmc2V0LnN0YXJ0IC8vIHF1aWNrZXINCiAJCQkJCQkJCQkJIDogTWF0aC5yb3VuZChfcHJvZ3Jlc3MgKiBfb3B0aW9ucy5kdXJhdGlvbiAqIDEwKS8xMDsgLy8gaWYgbm8gcmV2ZXJzZSBhbmQgZHVyaW5nIHBpbiB0aGUgcG9zaXRpb24gbmVlZHMgdG8gYmUgcmVjYWxjdWxhdGVkIHVzaW5nIHRoZSBwcm9ncmVzcw0KIAkJCQkJDQogCQkJCQkvLyByZW1vdmUgc3BhY2VyIG1hcmdpbiB0byBnZXQgcmVhbCBwb3NpdGlvbiAoaW4gY2FzZSBtYXJnaW5Db2xsYXBzZSBtb2RlKQ0KIAkJCQkJZml4ZWRQb3MudG9wIC09IHBhcnNlRmxvYXQoX3Bpbk9wdGlvbnMuc3BhY2VyLmNzcygibWFyZ2luLXRvcCIpKTsNCg0KIAkJCQkJLy8gYWRkIHNjcm9sbERpc3RhbmNlDQogCQkJCQlmaXhlZFBvc1tjb250YWluZXJJbmZvLnZlcnRpY2FsID8gInRvcCIgOiAibGVmdCJdICs9IHNjcm9sbERpc3RhbmNlOw0KDQoJCQkJCS8vIHNldCBuZXcgdmFsdWVzDQoJCQkJCV9waW4uY3NzKHsNCgkJCQkJCXRvcDogZml4ZWRQb3MudG9wLA0KCQkJCQkJbGVmdDogZml4ZWRQb3MubGVmdA0KCQkJCQl9KTsNCgkJCQl9IGVsc2Ugew0KCQkJCQkvLyB1bnBpbm5lZCBzdGF0ZQ0KCQkJCQl2YXINCgkJCQkJCW5ld0NTUyA9IHsNCgkJCQkJCQlwb3NpdGlvbjogX3Bpbk9wdGlvbnMuaW5GbG93ID8gInJlbGF0aXZlIiA6ICJhYnNvbHV0ZSIsDQoJCQkJCQkJdG9wOiAgMCwNCgkJCQkJCQlsZWZ0OiAwDQoJCQkJCQl9LA0KCQkJCQkJY2hhbmdlID0gX3Bpbi5jc3MoInBvc2l0aW9uIikgIT0gbmV3Q1NTLnBvc2l0aW9uOw0KCQkJCQkNCgkJCQkJaWYgKCFfcGluT3B0aW9ucy5wdXNoRm9sbG93ZXJzKSB7DQoJCQkJCQluZXdDU1NbY29udGFpbmVySW5mby52ZXJ0aWNhbCA/ICJ0b3AiIDogImxlZnQiXSA9IF9vcHRpb25zLmR1cmF0aW9uICogX3Byb2dyZXNzOw0KCQkJCQl9IGVsc2UgaWYgKF9vcHRpb25zLmR1cmF0aW9uID4gMCkgeyAvLyBvbmx5IGNvbmNlcm5zIHNjZW5lcyB3aXRoIGR1cmF0aW9uDQoJCQkJCQlpZiAoX3N0YXRlID09PSAiQUZURVIiICZhbXA7JmFtcDsgcGFyc2VGbG9hdChfcGluT3B0aW9ucy5zcGFjZXIuY3NzKCJwYWRkaW5nLXRvcCIpKSA9PT0gMCkgew0KCQkJCQkJCWNoYW5nZSA9IHRydWU7IC8vIGlmIGluIGFmdGVyIHN0YXRlIGJ1dCBoYXZlbnQgdXBkYXRlZCBzcGFjZXIgeWV0IChqdW1wZWQgcGFzdCBwaW4pDQoJCQkJCQl9IGVsc2UgaWYgKF9zdGF0ZSA9PT0gIkJFRk9SRSIgJmFtcDsmYW1wOyBwYXJzZUZsb2F0KF9waW5PcHRpb25zLnNwYWNlci5jc3MoInBhZGRpbmctYm90dG9tIikpID09PSAwKSB7IC8vIGJlZm9yZQ0KCQkJCQkJCWNoYW5nZSA9IHRydWU7IC8vIGp1bXBlZCBwYXN0IGZpeGVkIHN0YXRlIHVwd2FyZCBkaXJlY3Rpb24NCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQkvLyBzZXQgbmV3IHZhbHVlcw0KCQkJCQlfcGluLmNzcyhuZXdDU1MpOw0KCQkJCQlpZiAoY2hhbmdlKSB7DQoJCQkJCQkvLyByZW1vdmUgcGlubmVkIGNsYXNzDQoJCQkJCQlfcGluLnJlbW92ZUNsYXNzKF9waW5PcHRpb25zLnBpbm5lZENsYXNzKTsNCgkJCQkJCS8vIHVwZGF0ZSBwaW4gc3BhY2VyIGlmIHN0YXRlIGNoYW5nZWQNCgkJCQkJCXVwZGF0ZVBpblNwYWNlclNpemUoKTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlIHRoZSBwaW4gc3BhY2VyIHNpemUuDQoJCSAqIFRoZSBzaXplIG9mIHRoZSBzcGFjZXIgbmVlZHMgdG8gYmUgdXBkYXRlZCB3aGVuZXZlciB0aGUgZHVyYXRpb24gb2YgdGhlIHNjZW5lIGNoYW5nZXMsIGlmIGl0IGlzIHRvIHB1c2ggZG93biBmb2xsb3dpbmcgZWxlbWVudHMuDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgdXBkYXRlUGluU3BhY2VyU2l6ZSA9IGZ1bmN0aW9uICgpIHsNCgkJCWlmIChfcGluICZhbXA7JmFtcDsgX3BhcmVudCAmYW1wOyZhbXA7IF9waW5PcHRpb25zLmluRmxvdykgeyAvLyBubyBzcGFjZXJyZXNpemUsIGlmIG9yaWdpbmFsIHBvc2l0aW9uIGlzIGFic29sdXRlDQoJCQkJdmFyDQoJCQkJCWFmdGVyID0gKF9zdGF0ZSA9PT0gIkFGVEVSIiksDQoJCQkJCWJlZm9yZSA9IChfc3RhdGUgPT09ICJCRUZPUkUiKSwNCgkJCQkJZHVyaW5nID0gKF9zdGF0ZSA9PT0gIkRVUklORyIpLA0KCQkJCQlwaW5uZWQgPSAoX3Bpbi5jc3MoInBvc2l0aW9uIikgPT0gImZpeGVkIiksDQoJCQkJCXZlcnRpY2FsID0gX3BhcmVudC5pbmZvKCJ2ZXJ0aWNhbCIpLA0KCQkJCQkkc3BhY2VyY29udGVudCA9IF9waW5PcHRpb25zLnNwYWNlci5jaGlsZHJlbigpLmZpcnN0KCksIC8vIHVzdWFsbHkgdGhlIHBpbmVkIGVsZW1lbnQgYnV0IGNhbiBhbHNvIGJlIGFub3RoZXIgc3BhY2VyIChjYXNjYWRlZCBwaW5zKQ0KCQkJCQltYXJnaW5Db2xsYXBzZSA9IGlzTWFyZ2luQ29sbGFwc2VUeXBlKF9waW5PcHRpb25zLnNwYWNlci5jc3MoImRpc3BsYXkiKSksDQoJCQkJCWNzcyA9IHt9Ow0KDQoJCQkJaWYgKG1hcmdpbkNvbGxhcHNlKSB7DQoJCQkJCWNzc1sibWFyZ2luLXRvcCJdID0gYmVmb3JlIHx8IChkdXJpbmcgJmFtcDsmYW1wOyBwaW5uZWQpID8gX3Bpbi5jc3MoIm1hcmdpbi10b3AiKSA6ICJhdXRvIjsNCgkJCQkJY3NzWyJtYXJnaW4tYm90dG9tIl0gPSBhZnRlciB8fCAoZHVyaW5nICZhbXA7JmFtcDsgcGlubmVkKSA/IF9waW4uY3NzKCJtYXJnaW4tYm90dG9tIikgOiAiYXV0byI7DQoJCQkJfSBlbHNlIHsNCgkJCQkJY3NzWyJtYXJnaW4tdG9wIl0gPSBjc3NbIm1hcmdpbi1ib3R0b20iXSA9ICJhdXRvIjsNCgkJCQl9DQoNCgkJCQkvLyBzZXQgbmV3IHNpemUNCgkJCQkvLyBpZiByZWxzaXplOiBzcGFjZXIgLT4gcGluIHwgZWxzZTogcGluIC0+IHNwYWNlcg0KCQkJCWlmIChfcGluT3B0aW9ucy5yZWxTaXplLndpZHRoIHx8IF9waW5PcHRpb25zLnJlbFNpemUuYXV0b0Z1bGxXaWR0aCkgew0KCQkJCQlpZiAocGlubmVkKSB7DQoJCQkJCQlpZiAoJCh3aW5kb3cpLndpZHRoKCkgPT0gX3Bpbk9wdGlvbnMuc3BhY2VyLnBhcmVudCgpLndpZHRoKCkpIHsNCgkJCQkJCQkvLyByZWxhdGl2ZSB0byBib2R5DQoJCQkJCQkJX3Bpbi5jc3MoIndpZHRoIiwgX3Bpbk9wdGlvbnMucmVsU2l6ZS5hdXRvRnVsbFdpZHRoID8gIjEwMCUiIDogImluaGVyaXQiKTsNCgkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJLy8gbm90IHJlbGF0aXZlIHRvIGJvZHkgLT4gbmVlZCB0byBjYWxjdWxhdGUNCgkJCQkJCQlfcGluLmNzcygid2lkdGgiLCBfcGluT3B0aW9ucy5zcGFjZXIud2lkdGgoKSk7DQoJCQkJCQl9DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQlfcGluLmNzcygid2lkdGgiLCAiMTAwJSIpOw0KCQkJCQl9DQoJCQkJfSBlbHNlIHsNCgkJCQkJLy8gbWlud2lkdGggaXMgbmVlZGVkIGZvciBjYXNjYWRpbmcgcGlucy4NCgkJCQkJLy8gbWFyZ2luIGlzIG9ubHkgaW5jbHVkZWQgaWYgaXQncyBhIGNhc2NhZGVkIHBpbiB0byByZXNvbHZlIGFuIElFOSBidWcNCgkJCQkJY3NzWyJtaW4td2lkdGgiXSA9ICRzcGFjZXJjb250ZW50Lm91dGVyV2lkdGgoISRzcGFjZXJjb250ZW50LmlzKF9waW4pKTsNCgkJCQkJY3NzLndpZHRoID0gcGlubmVkID8gY3NzWyJtaW4td2lkdGgiXSA6ICJhdXRvIjsNCgkJCQl9DQoJCQkJaWYgKF9waW5PcHRpb25zLnJlbFNpemUuaGVpZ2h0KSB7DQoJCQkJCWlmIChwaW5uZWQpIHsNCgkJCQkJCWlmICgkKHdpbmRvdykuaGVpZ2h0KCkgPT0gX3Bpbk9wdGlvbnMuc3BhY2VyLnBhcmVudCgpLmhlaWdodCgpKSB7DQoJCQkJCQkJLy8gcmVsYXRpdmUgdG8gYm9keQ0KCQkJCQkJCV9waW4uY3NzKCJoZWlnaHQiLCAiaW5oZXJpdCIpOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQkvLyBub3QgcmVsYXRpdmUgdG8gYm9keSAtPiBuZWVkIHRvIGNhbGN1bGF0ZQ0KCQkJCQkJCV9waW4uY3NzKCJoZWlnaHQiLCBfcGluT3B0aW9ucy5zcGFjZXIuaGVpZ2h0KCkpOw0KCQkJCQkJfQ0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJX3Bpbi5jc3MoImhlaWdodCIsICIxMDAlIik7DQoJCQkJCX0NCgkJCQl9IGVsc2Ugew0KCQkJCQljc3NbIm1pbi1oZWlnaHQiXSA9ICRzcGFjZXJjb250ZW50Lm91dGVySGVpZ2h0KCFtYXJnaW5Db2xsYXBzZSk7IC8vIG5lZWRlZCBmb3IgY2FzY2FkaW5nIHBpbnMNCgkJCQkJY3NzLmhlaWdodCA9IHBpbm5lZCA/IGNzc1sibWluLWhlaWdodCJdIDogImF1dG8iOw0KCQkJCX0NCg0KCQkJCS8vIGFkZCBzcGFjZSBmb3IgZHVyYXRpb24gaWYgcHVzaEZvbGxvd2VycyBpcyB0cnVlDQoJCQkJaWYgKF9waW5PcHRpb25zLnB1c2hGb2xsb3dlcnMpIHsNCgkJCQkJY3NzWyJwYWRkaW5nIiArICh2ZXJ0aWNhbCA/ICJUb3AiIDogIkxlZnQiKV0gPSBfb3B0aW9ucy5kdXJhdGlvbiAqIF9wcm9ncmVzczsNCgkJCQkJY3NzWyJwYWRkaW5nIiArICh2ZXJ0aWNhbCA/ICJCb3R0b20iIDogIlJpZ2h0IildID0gX29wdGlvbnMuZHVyYXRpb24gKiAoMSAtIF9wcm9ncmVzcyk7DQoJCQkJfQ0KCQkJCV9waW5PcHRpb25zLnNwYWNlci5jc3MoY3NzKTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlcyB0aGUgUGluIHN0YXRlIChpbiBjZXJ0YWluIHNjZW5hcmlvcykNCgkJICogSWYgdGhlIGNvbnRyb2xsZXIgY29udGFpbmVyIGlzIG5vdCB0aGUgZG9jdW1lbnQgYW5kIHdlIGFyZSBtaWQtcGluLXBoYXNlIHNjcm9sbGluZyBvciByZXNpemluZyB0aGUgbWFpbiBkb2N1bWVudCBjYW4gcmVzdWx0IHRvIHdyb25nIHBpbiBwb3NpdGlvbnMuDQoJCSAqIFNvIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIG9uIHJlc2l6ZSBhbmQgc2Nyb2xsIG9mIHRoZSBkb2N1bWVudC4NCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB1cGRhdGVQaW5JbkNvbnRhaW5lciA9IGZ1bmN0aW9uICgpIHsNCgkJCWlmIChfcGFyZW50ICZhbXA7JmFtcDsgX3BpbiAmYW1wOyZhbXA7IF9zdGF0ZSA9PT0gIkRVUklORyIgJmFtcDsmYW1wOyAhX3BhcmVudC5pbmZvKCJpc0RvY3VtZW50IikpIHsNCgkJCQl1cGRhdGVQaW5TdGF0ZSgpOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGVzIHRoZSBQaW4gc3BhY2VyIHNpemUgc3RhdGUgKGluIGNlcnRhaW4gc2NlbmFyaW9zKQ0KCQkgKiBJZiBjb250YWluZXIgaXMgcmVzaXplZCBkdXJpbmcgcGluIGFuZCByZWxhdGl2ZWx5IHNpemVkIHRoZSBzaXplIG9mIHRoZSBwaW4gbWlnaHQgbmVlZCB0byBiZSB1cGRhdGVkLi4uDQoJCSAqIFNvIHRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIG9uIHJlc2l6ZSBvZiB0aGUgY29udGFpbmVyLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIHVwZGF0ZVJlbGF0aXZlUGluU3BhY2VyID0gZnVuY3Rpb24gKCkgew0KCQkJaWYgKCBfcGFyZW50ICZhbXA7JmFtcDsgX3BpbiAmYW1wOyZhbXA7IC8vIHdlbGwsIGR1aA0KCQkJCQlfc3RhdGUgPT09ICJEVVJJTkciICZhbXA7JmFtcDsgLy8gZWxlbWVudCBpbiBwaW5uZWQgc3RhdGU/DQoJCQkJCSggLy8gaXMgd2lkdGggb3IgaGVpZ2h0IHJlbGF0aXZlbHkgc2l6ZWQsIGJ1dCBub3QgaW4gcmVsYXRpb24gdG8gYm9keT8gdGhlbiB3ZSBuZWVkIHRvIHJlY2FsYy4NCgkJCQkJCSgoX3Bpbk9wdGlvbnMucmVsU2l6ZS53aWR0aCB8fCBfcGluT3B0aW9ucy5yZWxTaXplLmF1dG9GdWxsV2lkdGgpICZhbXA7JmFtcDsgJCh3aW5kb3cpLndpZHRoKCkgIT0gX3Bpbk9wdGlvbnMuc3BhY2VyLnBhcmVudCgpLndpZHRoKCkpIHx8DQoJCQkJCQkoX3Bpbk9wdGlvbnMucmVsU2l6ZS5oZWlnaHQgJmFtcDsmYW1wOyAkKHdpbmRvdykuaGVpZ2h0KCkgIT0gX3Bpbk9wdGlvbnMuc3BhY2VyLnBhcmVudCgpLmhlaWdodCgpKQ0KCQkJCQkpDQoJCQkpIHsNCgkJCQl1cGRhdGVQaW5TcGFjZXJTaXplKCk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIElzIGNhbGxlZCwgd2hlbiB0aGUgbW91c2V3aGVsIGlzIHVzZWQgd2hpbGUgb3ZlciBhIHBpbm5lZCBlbGVtZW50IGluc2lkZSBhIGRpdiBjb250YWluZXIuDQoJCSAqIElmIHRoZSBzY2VuZSBpcyBpbiBmaXhlZCBzdGF0ZSBzY3JvbGwgZXZlbnRzIHdvdWxkIGJlIGNvdW50ZWQgdG93YXJkcyB0aGUgYm9keS4gVGhpcyBmb3J3YXJkcyB0aGUgZXZlbnQgdG8gdGhlIHNjcm9sbCBjb250YWluZXIuDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgb25Nb3VzZXdoZWVsT3ZlclBpbiA9IGZ1bmN0aW9uIChlKSB7DQoJCQlpZiAoX3BhcmVudCAmYW1wOyZhbXA7IF9waW4gJmFtcDsmYW1wOyBfc3RhdGUgPT09ICJEVVJJTkciICZhbXA7JmFtcDsgIV9wYXJlbnQuaW5mbygiaXNEb2N1bWVudCIpKSB7IC8vIGluIHBpbiBzdGF0ZQ0KCQkJCWUucHJldmVudERlZmF1bHQoKTsNCgkJCQlfcGFyZW50LnNjcm9sbFRvKF9wYXJlbnQuaW5mbygic2Nyb2xsUG9zIikgLSAoZS5vcmlnaW5hbEV2ZW50LndoZWVsRGVsdGEvMyB8fCAtZS5vcmlnaW5hbEV2ZW50LmRldGFpbCozMCkpOw0KCQkJfQ0KCQl9Ow0KDQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBwdWJsaWMgZnVuY3Rpb25zIChnZXR0ZXJzL3NldHRlcnMpDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICovDQoNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIHBhcmVudCBjb250cm9sbGVyLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgcGFyZW50IGNvbnRyb2xsZXIgb2YgYSBzY2VuZQ0KCQkgKiB2YXIgY29udHJvbGxlciA9IHNjZW5lLnBhcmVudCgpOw0KCQkgKg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsTWFnaWN9IFBhcmVudCBjb250cm9sbGVyIG9yIGB1bmRlZmluZWRgDQoJCSAqLw0KCQl0aGlzLnBhcmVudCA9IGZ1bmN0aW9uICgpIHsNCgkJCXJldHVybiBfcGFyZW50Ow0KCQl9Ow0KDQoNCgkJLyoqDQoJCSAqICoqR2V0Kiogb3IgKipTZXQqKiB0aGUgZHVyYXRpb24gb3B0aW9uIHZhbHVlLg0KCQkgKiBBcyBhIHNldHRlciBpdCBhbHNvIGFjY2VwdHMgYSBmdW5jdGlvbiByZXR1cm5pbmcgYSBudW1lcmljIHZhbHVlLiAgDQoJCSAqIFRoaXMgaXMgcGFydGljdWxhcmx5IHVzZWZ1bCBmb3IgcmVzcG9uc2l2ZSBzZXR1cHMuDQoJCSAqDQoJCSAqIFRoZSBkdXJhdGlvbiBpcyB1cGRhdGVkIHVzaW5nIHRoZSBzdXBwbGllZCBmdW5jdGlvbiBldmVyeSB0aW1lIGBTY3JvbGxTY2VuZS5yZWZyZXNoKClgIGlzIGNhbGxlZCwgd2hpY2ggaGFwcGVucyBwZXJpb2RpY2FsbHkgZnJvbSB0aGUgY29udHJvbGxlciAoc2VlIFNjcm9sbE1hZ2ljIG9wdGlvbiBgcmVmcmVzaEludGVydmFsYCkuICANCgkJICogXyoqTk9URToqKiBCZSBhd2FyZSB0aGF0IGl0J3MgYW4gZWFzeSB3YXkgdG8ga2lsbCBwZXJmb3JtYW5jZSwgaWYgeW91IHN1cHBseSBhIGZ1bmN0aW9uIHRoYXQgaGFzIGhpZ2ggQ1BVIGRlbWFuZC4gIA0KCQkgKiBFdmVuIGZvciBzaXplIGFuZCBwb3NpdGlvbiBjYWxjdWxhdGlvbnMgaXQgaXMgcmVjb21tZW5kZWQgdG8gdXNlIGEgdmFyaWFibGUgdG8gY2FjaGUgdGhlIHZhbHVlLiAoc2VlIGV4YW1wbGUpICANCgkJICogVGhpcyBjb3VudHMgZG91YmxlIGlmIHlvdSB1c2UgdGhlIHNhbWUgZnVuY3Rpb24gZm9yIG11bHRpcGxlIHNjZW5lcy5fDQoJCSAqDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IGR1cmF0aW9uIHZhbHVlDQoJCSAqIHZhciBkdXJhdGlvbiA9IHNjZW5lLmR1cmF0aW9uKCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgZHVyYXRpb24NCgkJICogc2NlbmUuZHVyYXRpb24oMzAwKTsNCgkJICoNCgkJICogLy8gdXNlIGEgZnVuY3Rpb24gdG8gYXV0b21hdGljYWxseSBhZGp1c3QgdGhlIGR1cmF0aW9uIHRvIHRoZSB3aW5kb3cgaGVpZ2h0Lg0KCQkgKiB2YXIgZHVyYXRpb25WYWx1ZUNhY2hlOw0KCQkgKiBmdW5jdGlvbiBnZXREdXJhdGlvbiAoKSB7DQoJCSAqICAgcmV0dXJuIGR1cmF0aW9uVmFsdWVDYWNoZTsNCgkJICogfQ0KCQkgKiBmdW5jdGlvbiB1cGRhdGVEdXJhdGlvbiAoZSkgew0KCQkgKiAgIGR1cmF0aW9uVmFsdWVDYWNoZSA9ICQod2luZG93KS5pbm5lckhlaWdodCgpOw0KCQkgKiB9DQoJCSAqICQod2luZG93KS5vbigicmVzaXplIiwgdXBkYXRlRHVyYXRpb24pOyAvLyB1cGRhdGUgdGhlIGR1cmF0aW9uIHdoZW4gdGhlIHdpbmRvdyBzaXplIGNoYW5nZXMNCgkJICogJCh3aW5kb3cpLnRyaWdnZXJIYW5kbGVyKCJyZXNpemUiKTsgLy8gc2V0IHRvIGluaXRpYWwgdmFsdWUNCgkJICogc2NlbmUuZHVyYXRpb24oZ2V0RHVyYXRpb24pOyAvLyBzdXBwbHkgZHVyYXRpb24gbWV0aG9kDQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuY2hhbmdlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLnNoaWZ0fSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAcGFyYW0geyhudW1iZXJ8ZnVuY3Rpb24pfSBbbmV3RHVyYXRpb25dIC0gVGhlIG5ldyBkdXJhdGlvbiBvZiB0aGUgc2NlbmUuDQoJCSAqIEByZXR1cm5zIHtudW1iZXJ9IGBnZXRgIC0gIEN1cnJlbnQgc2NlbmUgZHVyYXRpb24uDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gYHNldGAgLSAgUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLmR1cmF0aW9uID0gZnVuY3Rpb24gKG5ld0R1cmF0aW9uKSB7DQoJCQl2YXIgdmFybmFtZSA9ICJkdXJhdGlvbiI7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJfSBlbHNlIHsNCgkJCQlpZiAoISQuaXNGdW5jdGlvbihuZXdEdXJhdGlvbikpIHsNCgkJCQkJX2R1cmF0aW9uVXBkYXRlTWV0aG9kID0gdW5kZWZpbmVkOw0KCQkJCX0NCgkJCQlpZiAoY2hhbmdlT3B0aW9uKHZhcm5hbWUsIG5ld0R1cmF0aW9uKSkgeyAvLyBzZXQNCgkJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigiY2hhbmdlIiwge3doYXQ6IHZhcm5hbWUsIG5ld3ZhbDogX29wdGlvbnNbdmFybmFtZV19KTsNCgkJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigic2hpZnQiLCB7cmVhc29uOiB2YXJuYW1lfSk7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIG9mZnNldCBvcHRpb24gdmFsdWUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IG9mZnNldA0KCQkgKiB2YXIgb2Zmc2V0ID0gc2NlbmUub2Zmc2V0KCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgb2Zmc2V0DQoJCSAqIHNjZW5lLm9mZnNldCgxMDApOw0KCQkgKg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zaGlmdH0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQHBhcmFtIHtudW1iZXJ9IFtuZXdPZmZzZXRdIC0gVGhlIG5ldyBvZmZzZXQgb2YgdGhlIHNjZW5lLg0KCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBgZ2V0YCAtICBDdXJyZW50IHNjZW5lIG9mZnNldC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMub2Zmc2V0ID0gZnVuY3Rpb24gKG5ld09mZnNldCkgew0KCQkJdmFyIHZhcm5hbWUgPSAib2Zmc2V0IjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX29wdGlvbnNbdmFybmFtZV07DQoJCQl9IGVsc2UgaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdPZmZzZXQpKSB7IC8vIHNldA0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoImNoYW5nZSIsIHt3aGF0OiB2YXJuYW1lLCBuZXd2YWw6IF9vcHRpb25zW3Zhcm5hbWVdfSk7DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigic2hpZnQiLCB7cmVhc29uOiB2YXJuYW1lfSk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0Kiogb3IgKipTZXQqKiB0aGUgdHJpZ2dlckVsZW1lbnQgb3B0aW9uIHZhbHVlLg0KCQkgKiBEb2VzICoqbm90KiogZmlyZSBgU2Nyb2xsU2NlbmUuc2hpZnRgLCBiZWNhdXNlIGNoYW5naW5nIHRoZSB0cmlnZ2VyIEVsZW1lbnQgZG9lc24ndCBuZWNlc3NhcmlseSBtZWFuIHRoZSBzdGFydCBwb3NpdGlvbiBjaGFuZ2VzLiBUaGlzIHdpbGwgYmUgZGV0ZXJtaW5lZCBpbiBgU2Nyb2xsU2NlbmUucmVmcmVzaCgpYCwgd2hpY2ggaXMgYXV0b21hdGljYWxseSB0cmlnZ2VyZWQuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHRyaWdnZXJFbGVtZW50DQoJCSAqIHZhciB0cmlnZ2VyRWxlbWVudCA9IHNjZW5lLnRyaWdnZXJFbGVtZW50KCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgdHJpZ2dlckVsZW1lbnQgdXNpbmcgYSBzZWxlY3Rvcg0KCQkgKiBzY2VuZS50cmlnZ2VyRWxlbWVudCgiI3RyaWdnZXIiKTsNCgkgCSAqIC8vIHNldCBhIG5ldyB0cmlnZ2VyRWxlbWVudCB1c2luZyBhIGpRdWVyeSBPYmplY3QNCgkJICogc2NlbmUudHJpZ2dlckVsZW1lbnQoJCgiI3RyaWdnZXIiKSk7DQoJIAkgKiAvLyBzZXQgYSBuZXcgdHJpZ2dlckVsZW1lbnQgdXNpbmcgYSBET00gb2JqZWN0DQoJCSAqIHNjZW5lLnRyaWdnZXJFbGVtZW50KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJ0cmlnZ2VyIikpOw0KCQkgKg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQHBhcmFtIHsoc3RyaW5nfG9iamVjdCl9IFtuZXdUcmlnZ2VyRWxlbWVudF0gLSBUaGUgbmV3IHRyaWdnZXIgZWxlbWVudCBmb3IgdGhlIHNjZW5lLg0KCQkgKiBAcmV0dXJucyB7KHN0cmluZ3xvYmplY3QpfSBgZ2V0YCAtICBDdXJyZW50IHRyaWdnZXJFbGVtZW50Lg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IGBzZXRgIC0gIFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy50cmlnZ2VyRWxlbWVudCA9IGZ1bmN0aW9uIChuZXdUcmlnZ2VyRWxlbWVudCkgew0KCQkJdmFyIHZhcm5hbWUgPSAidHJpZ2dlckVsZW1lbnQiOw0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiBfb3B0aW9uc1t2YXJuYW1lXTsNCgkJCX0gZWxzZSBpZiAoY2hhbmdlT3B0aW9uKHZhcm5hbWUsIG5ld1RyaWdnZXJFbGVtZW50KSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIHRyaWdnZXJIb29rIG9wdGlvbiB2YWx1ZS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgdHJpZ2dlckhvb2sgdmFsdWUNCgkJICogdmFyIHRyaWdnZXJIb29rID0gc2NlbmUudHJpZ2dlckhvb2soKTsNCgkJICoNCgkgCSAqIC8vIHNldCBhIG5ldyB0cmlnZ2VySG9vayB1c2luZyBhIHN0cmluZw0KCQkgKiBzY2VuZS50cmlnZ2VySG9vaygib25MZWF2ZSIpOw0KCSAJICogLy8gc2V0IGEgbmV3IHRyaWdnZXJIb29rIHVzaW5nIGEgbnVtYmVyDQoJCSAqIHNjZW5lLnRyaWdnZXJIb29rKDAuNyk7DQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuY2hhbmdlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLnNoaWZ0fSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAcGFyYW0geyhudW1iZXJ8c3RyaW5nKX0gW25ld1RyaWdnZXJIb29rXSAtIFRoZSBuZXcgdHJpZ2dlckhvb2sgb2YgdGhlIHNjZW5lLiBTZWUge0BsaW5rIFNjcm9sbFNjZW5lfSBwYXJhbWV0ZXIgZGVzY3JpcHRpb24gZm9yIHZhbHVlIG9wdGlvbnMuDQoJCSAqIEByZXR1cm5zIHtudW1iZXJ9IGBnZXRgIC0gIEN1cnJlbnQgdHJpZ2dlckhvb2sgKEFMV0FZUyBudW1lcmljYWwpLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IGBzZXRgIC0gIFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy50cmlnZ2VySG9vayA9IGZ1bmN0aW9uIChuZXdUcmlnZ2VySG9vaykgew0KCQkJdmFyIHZhcm5hbWUgPSAidHJpZ2dlckhvb2siOw0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiAkLmlzTnVtZXJpYyhfb3B0aW9uc1t2YXJuYW1lXSkgPyBfb3B0aW9uc1t2YXJuYW1lXSA6IFRSSUdHRVJfSE9PS19WQUxVRVNbX29wdGlvbnNbdmFybmFtZV1dOw0KCQkJfSBlbHNlIGlmIChjaGFuZ2VPcHRpb24odmFybmFtZSwgbmV3VHJpZ2dlckhvb2spKSB7IC8vIHNldA0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoImNoYW5nZSIsIHt3aGF0OiB2YXJuYW1lLCBuZXd2YWw6IF9vcHRpb25zW3Zhcm5hbWVdfSk7DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigic2hpZnQiLCB7cmVhc29uOiB2YXJuYW1lfSk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0Kiogb3IgKipTZXQqKiB0aGUgcmV2ZXJzZSBvcHRpb24gdmFsdWUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHJldmVyc2Ugb3B0aW9uDQoJCSAqIHZhciByZXZlcnNlID0gc2NlbmUucmV2ZXJzZSgpOw0KCQkgKg0KCSAJICogLy8gc2V0IG5ldyByZXZlcnNlIG9wdGlvbg0KCQkgKiBzY2VuZS5yZXZlcnNlKGZhbHNlKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW25ld1JldmVyc2VdIC0gVGhlIG5ldyByZXZlcnNlIHNldHRpbmcgb2YgdGhlIHNjZW5lLg0KCQkgKiBAcmV0dXJucyB7Ym9vbGVhbn0gYGdldGAgLSAgQ3VycmVudCByZXZlcnNlIG9wdGlvbiB2YWx1ZS4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMucmV2ZXJzZSA9IGZ1bmN0aW9uIChuZXdSZXZlcnNlKSB7DQoJCQl2YXIgdmFybmFtZSA9ICJyZXZlcnNlIjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX29wdGlvbnNbdmFybmFtZV07DQoJCQl9IGVsc2UgaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdSZXZlcnNlKSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIHR3ZWVuQ2hhbmdlcyBvcHRpb24gdmFsdWUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHR3ZWVuQ2hhbmdlcyBvcHRpb24NCgkJICogdmFyIHR3ZWVuQ2hhbmdlcyA9IHNjZW5lLnR3ZWVuQ2hhbmdlcygpOw0KCQkgKg0KCSAJICogLy8gc2V0IG5ldyB0d2VlbkNoYW5nZXMgb3B0aW9uDQoJCSAqIHNjZW5lLnR3ZWVuQ2hhbmdlcyh0cnVlKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW25ld1R3ZWVuQ2hhbmdlc10gLSBUaGUgbmV3IHR3ZWVuQ2hhbmdlcyBzZXR0aW5nIG9mIHRoZSBzY2VuZS4NCgkJICogQHJldHVybnMge2Jvb2xlYW59IGBnZXRgIC0gIEN1cnJlbnQgdHdlZW5DaGFuZ2VzIG9wdGlvbiB2YWx1ZS4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudHdlZW5DaGFuZ2VzID0gZnVuY3Rpb24gKG5ld1R3ZWVuQ2hhbmdlcykgew0KCQkJdmFyIHZhcm5hbWUgPSAidHdlZW5DaGFuZ2VzIjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX29wdGlvbnNbdmFybmFtZV07DQoJCQl9IGVsc2UgaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdUd2VlbkNoYW5nZXMpKSB7IC8vIHNldA0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoImNoYW5nZSIsIHt3aGF0OiB2YXJuYW1lLCBuZXd2YWw6IF9vcHRpb25zW3Zhcm5hbWVdfSk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0Kiogb3IgKipTZXQqKiB0aGUgbG9nbGV2ZWwgb3B0aW9uIHZhbHVlLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCBsb2dsZXZlbA0KCQkgKiB2YXIgbG9nbGV2ZWwgPSBzY2VuZS5sb2dsZXZlbCgpOw0KCQkgKg0KCSAJICogLy8gc2V0IG5ldyBsb2dsZXZlbA0KCQkgKiBzY2VuZS5sb2dsZXZlbCgzKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBbbmV3TG9nbGV2ZWxdIC0gVGhlIG5ldyBsb2dsZXZlbCBzZXR0aW5nIG9mIHRoZSBzY2VuZS4gYFswLTNdYA0KCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBgZ2V0YCAtICBDdXJyZW50IGxvZ2xldmVsLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IGBzZXRgIC0gIFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5sb2dsZXZlbCA9IGZ1bmN0aW9uIChuZXdMb2dsZXZlbCkgew0KCQkJdmFyIHZhcm5hbWUgPSAibG9nbGV2ZWwiOw0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiBfb3B0aW9uc1t2YXJuYW1lXTsNCgkJCX0gZWxzZSBpZiAoY2hhbmdlT3B0aW9uKHZhcm5hbWUsIG5ld0xvZ2xldmVsKSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KCQkNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIGN1cnJlbnQgc3RhdGUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHN0YXRlDQoJCSAqIHZhciBzdGF0ZSA9IHNjZW5lLnN0YXRlKCk7DQoJCSAqDQoJCSAqIEByZXR1cm5zIHtzdHJpbmd9IGAiQkVGT1JFImAsIGAiRFVSSU5HImAgb3IgYCJBRlRFUiJgDQoJCSAqLw0KCQl0aGlzLnN0YXRlID0gZnVuY3Rpb24gKCkgew0KCQkJcmV0dXJuIF9zdGF0ZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiB0aGUgdHJpZ2dlciBwb3NpdGlvbiBvZiB0aGUgc2NlbmUgKGluY2x1ZGluZyB0aGUgdmFsdWUgb2YgdGhlIGBvZmZzZXRgIG9wdGlvbikuICANCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIHNjZW5lJ3MgdHJpZ2dlciBwb3NpdGlvbg0KCQkgKiB2YXIgdHJpZ2dlclBvc2l0aW9uID0gc2NlbmUudHJpZ2dlclBvc2l0aW9uKCk7DQoJCSAqDQoJCSAqIEByZXR1cm5zIHtudW1iZXJ9IFN0YXJ0IHBvc2l0aW9uIG9mIHRoZSBzY2VuZS4gVG9wIHBvc2l0aW9uIHZhbHVlIGZvciB2ZXJ0aWNhbCBhbmQgbGVmdCBwb3NpdGlvbiB2YWx1ZSBmb3IgaG9yaXpvbnRhbCBzY3JvbGxzLg0KCQkgKi8NCgkJdGhpcy50cmlnZ2VyUG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7DQoJCQl2YXIgcG9zID0gX29wdGlvbnMub2Zmc2V0OyAvLyB0aGUgb2Zmc2V0IGlzIHRoZSBiYXNpcw0KCQkJaWYgKF9wYXJlbnQpIHsNCgkJCQkvLyBnZXQgdGhlIHRyaWdnZXIgcG9zaXRpb24NCgkJCQlpZiAoX29wdGlvbnMudHJpZ2dlckVsZW1lbnQpIHsNCgkJCQkJLy8gRWxlbWVudCBhcyB0cmlnZ2VyDQoJCQkJCXBvcyArPSBfdHJpZ2dlclBvczsNCgkJCQl9IGVsc2Ugew0KCQkJCQkvLyByZXR1cm4gdGhlIGhlaWdodCBvZiB0aGUgdHJpZ2dlckhvb2sgdG8gc3RhcnQgYXQgdGhlIGJlZ2lubmluZw0KCQkJCQlwb3MgKz0gX3BhcmVudC5pbmZvKCJzaXplIikgKiBTY3JvbGxTY2VuZS50cmlnZ2VySG9vaygpOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBwb3M7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIHRyaWdnZXIgb2Zmc2V0IG9mIHRoZSBzY2VuZSAoaW5jbHVkaW5nIHRoZSB2YWx1ZSBvZiB0aGUgYG9mZnNldGAgb3B0aW9uKS4gIA0KCQkgKiBAcHVibGljDQoJCSAqIEBkZXByZWNhdGVkIE1ldGhvZCBpcyBkZXByZWNhdGVkIHNpbmNlIDEuMS4wLiBZb3Ugc2hvdWxkIG5vdyB1c2Uge0BsaW5rIFNjcm9sbFNjZW5lLnRyaWdnZXJQb3NpdGlvbn0NCgkJICovDQoJCXRoaXMudHJpZ2dlck9mZnNldCA9IGZ1bmN0aW9uICgpIHsNCgkJCXJldHVybiBTY3JvbGxTY2VuZS50cmlnZ2VyUG9zaXRpb24oKTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiB0aGUgY3VycmVudCBzY3JvbGwgb2Zmc2V0IGZvciB0aGUgc3RhcnQgb2YgdGhlIHNjZW5lLiAgDQoJCSAqIE1pbmQsIHRoYXQgdGhlIHNjcm9sbE9mZnNldCBpcyByZWxhdGVkIHRvIHRoZSBzaXplIG9mIHRoZSBjb250YWluZXIsIGlmIGB0cmlnZ2VySG9va2AgaXMgYmlnZ2VyIHRoYW4gYDBgIChvciBgIm9uTGVhdmUiYCkuICANCgkJICogVGhpcyBtZWFucywgdGhhdCByZXNpemluZyB0aGUgY29udGFpbmVyIG9yIGNoYW5naW5nIHRoZSBgdHJpZ2dlckhvb2tgIHdpbGwgaW5mbHVlbmNlIHRoZSBzY2VuZSdzIHN0YXJ0IG9mZnNldC4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgc2Nyb2xsIG9mZnNldCBmb3IgdGhlIHN0YXJ0IGFuZCBlbmQgb2YgdGhlIHNjZW5lLg0KCQkgKiB2YXIgc3RhcnQgPSBzY2VuZS5zY3JvbGxPZmZzZXQoKTsNCgkJICogdmFyIGVuZCA9IHNjZW5lLnNjcm9sbE9mZnNldCgpICsgc2NlbmUuZHVyYXRpb24oKTsNCgkJICogY29uc29sZS5sb2coInRoZSBzY2VuZSBzdGFydHMgYXQiLCBzdGFydCwgImFuZCBlbmRzIGF0IiwgZW5kKTsNCgkJICoNCgkJICogQHJldHVybnMge251bWJlcn0gVGhlIHNjcm9sbCBvZmZzZXQgKG9mIHRoZSBjb250YWluZXIpIGF0IHdoaWNoIHRoZSBzY2VuZSB3aWxsIHRyaWdnZXIuIFkgdmFsdWUgZm9yIHZlcnRpY2FsIGFuZCBYIHZhbHVlIGZvciBob3Jpem9udGFsIHNjcm9sbHMuDQoJCSAqLw0KCQl0aGlzLnNjcm9sbE9mZnNldCA9IGZ1bmN0aW9uICgpIHsNCgkJCXJldHVybiBfc2Nyb2xsT2Zmc2V0LnN0YXJ0Ow0KCQl9Ow0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHVibGljIGZ1bmN0aW9ucyAoc2NlbmUgbW9kaWZpY2F0aW9uKQ0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCS8qKg0KCQkgKiBVcGRhdGVzIHRoZSBTY2VuZSBpbiB0aGUgcGFyZW50IENvbnRyb2xsZXIgdG8gcmVmbGVjdCB0aGUgY3VycmVudCBzdGF0ZS4gIA0KCQkgKiBUaGlzIGlzIHRoZSBlcXVpdmFsZW50IHRvIGBTY3JvbGxNYWdpYy51cGRhdGVTY2VuZShzY2VuZSwgaW1tZWRpYXRlbHkpYC4gIA0KCQkgKiBUaGUgdXBkYXRlIG1ldGhvZCBjYWxjdWxhdGVzIHRoZSBzY2VuZSdzIHN0YXJ0IGFuZCBlbmQgcG9zaXRpb24gKGJhc2VkIG9uIHRoZSB0cmlnZ2VyIGVsZW1lbnQsIHRyaWdnZXIgaG9vaywgZHVyYXRpb24gYW5kIG9mZnNldCkgYW5kIGNoZWNrcyBpdCBhZ2FpbnN0IHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbiBvZiB0aGUgY29udGFpbmVyLiAgDQoJCSAqIEl0IHRoZW4gdXBkYXRlcyB0aGUgY3VycmVudCBzY2VuZSBzdGF0ZSBhY2NvcmRpbmdseSAob3IgZG9lcyBub3RoaW5nLCBpZiB0aGUgc3RhdGUgaXMgYWxyZWFkeSBjb3JyZWN0KSDigJMgUGlucyB3aWxsIGJlIHNldCB0byB0aGVpciBjb3JyZWN0IHBvc2l0aW9uIGFuZCB0d2VlbnMgd2lsbCBiZSB1cGRhdGVkIHRvIHRoZWlyIGNvcnJlY3QgcHJvZ3Jlc3MuDQoJCSAqIFRoaXMgbWVhbnMgYW4gdXBkYXRlIGRvZXNuJ3QgbmVjZXNzYXJpbHkgcmVzdWx0IGluIGEgcHJvZ3Jlc3MgY2hhbmdlLiBUaGUgYHByb2dyZXNzYCBldmVudCB3aWxsIGJlIGZpcmVkIGlmIHRoZSBwcm9ncmVzcyBoYXMgaW5kZWVkIGNoYW5nZWQgYmV0d2VlbiB0aGlzIHVwZGF0ZSBhbmQgdGhlIGxhc3QuICANCgkJICogXyoqTk9URToqKiBUaGlzIG1ldGhvZCBnZXRzIGNhbGxlZCBjb25zdGFudGx5IHdoZW5ldmVyIFNjcm9sbE1hZ2ljIGRldGVjdHMgYSBjaGFuZ2UuIFRoZSBvbmx5IGFwcGxpY2F0aW9uIGZvciB5b3UgaXMgaWYgeW91IGNoYW5nZSBzb21ldGhpbmcgb3V0c2lkZSBvZiB0aGUgcmVhbG0gb2YgU2Nyb2xsTWFnaWMsIGxpa2UgbW92aW5nIHRoZSB0cmlnZ2VyIG9yIGNoYW5naW5nIHR3ZWVuIHBhcmFtZXRlcnMuXw0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHVwZGF0ZSB0aGUgc2NlbmUgb24gbmV4dCB0aWNrDQoJCSAqIHNjZW5lLnVwZGF0ZSgpOw0KCQkgKg0KCQkgKiAvLyB1cGRhdGUgdGhlIHNjZW5lIGltbWVkaWF0ZWx5DQoJCSAqIHNjZW5lLnVwZGF0ZSh0cnVlKTsNCgkJICoNCgkJICogQGZpcmVzIFNjcm9sbFNjZW5lLnVwZGF0ZQ0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtpbW1lZGlhdGVseT1mYWxzZV0gLSBJZiBgdHJ1ZWAgdGhlIHVwZGF0ZSB3aWxsIGJlIGluc3RhbnQsIGlmIGBmYWxzZWAgaXQgd2lsbCB3YWl0IHVudGlsIG5leHQgdXBkYXRlIGN5Y2xlIChiZXR0ZXIgcGVyZm9ybWFuY2UpLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy51cGRhdGUgPSBmdW5jdGlvbiAoaW1tZWRpYXRlbHkpIHsNCgkJCWlmIChfcGFyZW50KSB7DQoJCQkJaWYgKGltbWVkaWF0ZWx5KSB7DQoJCQkJCWlmIChfcGFyZW50LmVuYWJsZWQoKSAmYW1wOyZhbXA7IF9lbmFibGVkKSB7DQoJCQkJCQl2YXINCgkJCQkJCQlzY3JvbGxQb3MgPSBfcGFyZW50LmluZm8oInNjcm9sbFBvcyIpLA0KCQkJCQkJCW5ld1Byb2dyZXNzOw0KDQoJCQkJCQlpZiAoX29wdGlvbnMuZHVyYXRpb24gPiAwKSB7DQoJCQkJCQkJbmV3UHJvZ3Jlc3MgPSAoc2Nyb2xsUG9zIC0gX3Njcm9sbE9mZnNldC5zdGFydCkvKF9zY3JvbGxPZmZzZXQuZW5kIC0gX3Njcm9sbE9mZnNldC5zdGFydCk7DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCW5ld1Byb2dyZXNzID0gc2Nyb2xsUG9zID49IF9zY3JvbGxPZmZzZXQuc3RhcnQgPyAxIDogMDsNCgkJCQkJCX0NCg0KCQkJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigidXBkYXRlIiwge3N0YXJ0UG9zOiBfc2Nyb2xsT2Zmc2V0LnN0YXJ0LCBlbmRQb3M6IF9zY3JvbGxPZmZzZXQuZW5kLCBzY3JvbGxQb3M6IHNjcm9sbFBvc30pOw0KDQoJCQkJCQlTY3JvbGxTY2VuZS5wcm9ncmVzcyhuZXdQcm9ncmVzcyk7DQoJCQkJCX0gZWxzZSBpZiAoX3BpbiAmYW1wOyZhbXA7IF9zdGF0ZSA9PT0gIkRVUklORyIpIHsNCgkJCQkJCXVwZGF0ZVBpblN0YXRlKHRydWUpOyAvLyB1bnBpbiBpbiBwb3NpdGlvbg0KCQkJCQl9DQoJCQkJfSBlbHNlIHsNCgkJCQkJX3BhcmVudC51cGRhdGVTY2VuZShTY3JvbGxTY2VuZSwgZmFsc2UpOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlcyBkeW5hbWljIHNjZW5lIHZhcmlhYmxlcyBsaWtlIHRoZSB0cmlnZ2VyIGVsZW1lbnQgcG9zaXRpb24gb3IgdGhlIGR1cmF0aW9uLg0KCQkgKiBUaGlzIG1ldGhvZCBpcyBhdXRvbWF0aWNhbGx5IGNhbGxlZCBpbiByZWd1bGFyIGludGVydmFscyBmcm9tIHRoZSBjb250cm9sbGVyLiBTZWUge0BsaW5rIFNjcm9sbE1hZ2ljfSBvcHRpb24gYHJlZnJlc2hJbnRlcnZhbGAuDQoJCSAqIA0KCQkgKiBZb3UgY2FuIGNhbGwgaXQgdG8gbWluaW1pemUgbGFnLCBmb3IgZXhhbXBsZSB3aGVuIHlvdSBpbnRlbnRpb25hbGx5IGNoYW5nZSB0aGUgcG9zaXRpb24gb2YgdGhlIHRyaWdnZXJFbGVtZW50Lg0KCQkgKiBJZiB5b3UgZG9uJ3QgaXQgd2lsbCBzaW1wbHkgYmUgdXBkYXRlZCBpbiB0aGUgbmV4dCByZWZyZXNoIGludGVydmFsIG9mIHRoZSBjb250YWluZXIsIHdoaWNoIGlzIHVzdWFsbHkgc3VmZmljaWVudC4NCgkJICoNCgkJICogQHB1YmxpYw0KCQkgKiBAc2luY2UgMS4xLjANCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUgPSBuZXcgU2Nyb2xsU2NlbmUoe3RyaWdnZXJFbGVtZW50OiAiI3RyaWdnZXIifSk7DQoJCSAqIA0KCQkgKiAvLyBjaGFuZ2UgdGhlIHBvc2l0aW9uIG9mIHRoZSB0cmlnZ2VyDQoJCSAqICQoIiN0cmlnZ2VyIikuY3NzKCJ0b3AiLCA1MDApOw0KCQkgKiAvLyBpbW1lZGlhdGVseSBsZXQgdGhlIHNjZW5lIGtub3cgb2YgdGhpcyBjaGFuZ2UNCgkJICogc2NlbmUucmVmcmVzaCgpOw0KCQkgKg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLnNoaWZ0fSwgaWYgdGhlIHRyaWdnZXIgZWxlbWVudCBwb3NpdGlvbiBvciB0aGUgZHVyYXRpb24gY2hhbmdlZA0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIGlmIHRoZSBkdXJhdGlvbiBjaGFuZ2VkDQoJCSAqDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJlZnJlc2ggPSBmdW5jdGlvbiAoKSB7DQoJCQl1cGRhdGVEdXJhdGlvbigpOw0KCQkJdXBkYXRlVHJpZ2dlckVsZW1lbnRQb3NpdGlvbigpOw0KCQkJLy8gdXBkYXRlIHRyaWdnZXIgZWxlbWVudCBwb3NpdGlvbg0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIHNjZW5lJ3MgcHJvZ3Jlc3MuICANCgkJICogVXN1YWxseSBpdCBzaG91bGRuJ3QgYmUgbmVjZXNzYXJ5IHRvIHVzZSB0aGlzIGFzIGEgc2V0dGVyLCBhcyBpdCBpcyBzZXQgYXV0b21hdGljYWxseSBieSBzY2VuZS51cGRhdGUoKS4gIA0KCQkgKiBUaGUgb3JkZXIgaW4gd2hpY2ggdGhlIGV2ZW50cyBhcmUgZmlyZWQgZGVwZW5kcyBvbiB0aGUgZHVyYXRpb24gb2YgdGhlIHNjZW5lOg0KCQkgKiAgMS4gU2NlbmVzIHdpdGggYGR1cmF0aW9uID09IDBgOiAgDQoJCSAqICBTY2VuZXMgdGhhdCBoYXZlIG5vIGR1cmF0aW9uIGJ5IGRlZmluaXRpb24gaGF2ZSBubyBlbmRpbmcuIFRodXMgdGhlIGBlbmRgIGV2ZW50IHdpbGwgbmV2ZXIgYmUgZmlyZWQuICANCgkJICogIFdoZW4gdGhlIHRyaWdnZXIgcG9zaXRpb24gb2YgdGhlIHNjZW5lIGlzIHBhc3NlZCB0aGUgZXZlbnRzIGFyZSBhbHdheXMgZmlyZWQgaW4gdGhpcyBvcmRlcjogIA0KCQkgKiAgYGVudGVyYCwgYHN0YXJ0YCwgYHByb2dyZXNzYCB3aGVuIHNjcm9sbGluZyBmb3J3YXJkICANCgkJICogIGFuZCAgDQoJCSAqICBgcHJvZ3Jlc3NgLCBgc3RhcnRgLCBgbGVhdmVgIHdoZW4gc2Nyb2xsaW5nIGluIHJldmVyc2UNCgkJICogIDIuIFNjZW5lcyB3aXRoIGBkdXJhdGlvbiA+IDBgOiAgDQoJCSAqICBTY2VuZXMgd2l0aCBhIHNldCBkdXJhdGlvbiBoYXZlIGEgZGVmaW5lZCBzdGFydCBhbmQgZW5kIHBvaW50LiAgDQoJCSAqICBXaGVuIHNjcm9sbGluZyBwYXN0IHRoZSBzdGFydCBwb3NpdGlvbiBvZiB0aGUgc2NlbmUgaXQgd2lsbCBmaXJlIHRoZXNlIGV2ZW50cyBpbiB0aGlzIG9yZGVyOiAgDQoJCSAqICBgZW50ZXJgLCBgc3RhcnRgLCBgcHJvZ3Jlc3NgICANCgkJICogIFdoZW4gY29udGludWluZyB0byBzY3JvbGwgYW5kIHBhc3NpbmcgdGhlIGVuZCBwb2ludCBpdCB3aWxsIGZpcmUgdGhlc2UgZXZlbnRzOiAgDQoJCSAqICBgcHJvZ3Jlc3NgLCBgZW5kYCwgYGxlYXZlYCAgDQoJCSAqICBXaGVuIHJldmVyc2luZyB0aHJvdWdoIHRoZSBlbmQgcG9pbnQgdGhlc2UgZXZlbnRzIGFyZSBmaXJlZDogIA0KCQkgKiAgYGVudGVyYCwgYGVuZGAsIGBwcm9ncmVzc2AgIA0KCQkgKiAgQW5kIHdoZW4gY29udGludWluZyB0byBzY3JvbGwgcGFzdCB0aGUgc3RhcnQgcG9zaXRpb24gaW4gcmV2ZXJzZSBpdCB3aWxsIGZpcmU6ICANCgkJICogIGBwcm9ncmVzc2AsIGBzdGFydGAsIGBsZWF2ZWAgIA0KCQkgKiAgSW4gYmV0d2VlbiBzdGFydCBhbmQgZW5kIHRoZSBgcHJvZ3Jlc3NgIGV2ZW50IHdpbGwgYmUgY2FsbGVkIGNvbnN0YW50bHksIHdoZW5ldmVyIHRoZSBwcm9ncmVzcyBjaGFuZ2VzLg0KCQkgKiANCgkJICogSW4gc2hvcnQ6ICANCgkJICogYGVudGVyYCBldmVudHMgd2lsbCBhbHdheXMgdHJpZ2dlciAqKmJlZm9yZSoqIHRoZSBwcm9ncmVzcyB1cGRhdGUgYW5kIGBsZWF2ZWAgZW52ZW50cyB3aWxsIHRyaWdnZXIgKiphZnRlcioqIHRoZSBwcm9ncmVzcyB1cGRhdGUuICANCgkJICogYHN0YXJ0YCBhbmQgYGVuZGAgd2lsbCBhbHdheXMgdHJpZ2dlciBhdCB0aGVpciByZXNwZWN0aXZlIHBvc2l0aW9uLg0KCQkgKiANCgkJICogUGxlYXNlIHJldmlldyB0aGUgZXZlbnQgZGVzY3JpcHRpb25zIGZvciBkZXRhaWxzIG9uIHRoZSBldmVudHMgYW5kIHRoZSBldmVudCBvYmplY3QgdGhhdCBpcyBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLg0KCQkgKiANCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgc2NlbmUgcHJvZ3Jlc3MNCgkJICogdmFyIHByb2dyZXNzID0gc2NlbmUucHJvZ3Jlc3MoKTsNCgkJICoNCgkgCSAqIC8vIHNldCBuZXcgc2NlbmUgcHJvZ3Jlc3MNCgkJICogc2NlbmUucHJvZ3Jlc3MoMC4zKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5lbnRlcn0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zdGFydH0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5wcm9ncmVzc30sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5lbmR9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUubGVhdmV9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBbcHJvZ3Jlc3NdIC0gVGhlIG5ldyBwcm9ncmVzcyB2YWx1ZSBvZiB0aGUgc2NlbmUgYFswLTFdYC4NCgkJICogQHJldHVybnMge251bWJlcn0gYGdldGAgLSAgQ3VycmVudCBzY2VuZSBwcm9ncmVzcy4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMucHJvZ3Jlc3MgPSBmdW5jdGlvbiAocHJvZ3Jlc3MpIHsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX3Byb2dyZXNzOw0KCQkJfSBlbHNlIHsgLy8gc2V0DQoJCQkJdmFyDQoJCQkJCWRvVXBkYXRlID0gZmFsc2UsDQoJCQkJCW9sZFN0YXRlID0gX3N0YXRlLA0KCQkJCQlzY3JvbGxEaXJlY3Rpb24gPSBfcGFyZW50ID8gX3BhcmVudC5pbmZvKCJzY3JvbGxEaXJlY3Rpb24iKSA6ICdQQVVTRUQnLA0KCQkJCQlyZXZlcnNlT3JGb3J3YXJkID0gX29wdGlvbnMucmV2ZXJzZSB8fCBwcm9ncmVzcyA+PSBfcHJvZ3Jlc3M7DQoJCQkJaWYgKF9vcHRpb25zLmR1cmF0aW9uID09PSAwKSB7DQoJCQkJCS8vIHplcm8gZHVyYXRpb24gc2NlbmVzDQoJCQkJCWRvVXBkYXRlID0gX3Byb2dyZXNzICE9IHByb2dyZXNzOw0KCQkJCQlfcHJvZ3Jlc3MgPSBwcm9ncmVzcyAmbHQ7IDEgJmFtcDsmYW1wOyByZXZlcnNlT3JGb3J3YXJkID8gMCA6IDE7DQoJCQkJCV9zdGF0ZSA9IF9wcm9ncmVzcyA9PT0gMCA/ICdCRUZPUkUnIDogJ0RVUklORyc7DQoJCQkJfSBlbHNlIHsNCgkJCQkJLy8gc2NlbmVzIHdpdGggc3RhcnQgYW5kIGVuZA0KCQkJCQlpZiAocHJvZ3Jlc3MgJmx0Oz0gMCAmYW1wOyZhbXA7IF9zdGF0ZSAhPT0gJ0JFRk9SRScgJmFtcDsmYW1wOyByZXZlcnNlT3JGb3J3YXJkKSB7DQoJCQkJCQkvLyBnbyBiYWNrIHRvIGluaXRpYWwgc3RhdGUNCgkJCQkJCV9wcm9ncmVzcyA9IDA7DQoJCQkJCQlfc3RhdGUgPSAnQkVGT1JFJzsNCgkJCQkJCWRvVXBkYXRlID0gdHJ1ZTsNCgkJCQkJfSBlbHNlIGlmIChwcm9ncmVzcyA+IDAgJmFtcDsmYW1wOyBwcm9ncmVzcyAmbHQ7IDEgJmFtcDsmYW1wOyByZXZlcnNlT3JGb3J3YXJkKSB7DQoJCQkJCQlfcHJvZ3Jlc3MgPSBwcm9ncmVzczsNCgkJCQkJCV9zdGF0ZSA9ICdEVVJJTkcnOw0KCQkJCQkJZG9VcGRhdGUgPSB0cnVlOw0KCQkJCQl9IGVsc2UgaWYgKHByb2dyZXNzID49IDEgJmFtcDsmYW1wOyBfc3RhdGUgIT09ICdBRlRFUicpIHsNCgkJCQkJCV9wcm9ncmVzcyA9IDE7DQoJCQkJCQlfc3RhdGUgPSAnQUZURVInOw0KCQkJCQkJZG9VcGRhdGUgPSB0cnVlOw0KCQkJCQl9IGVsc2UgaWYgKF9zdGF0ZSA9PT0gJ0RVUklORycgJmFtcDsmYW1wOyAhcmV2ZXJzZU9yRm9yd2FyZCkgew0KCQkJCQkJdXBkYXRlUGluU3RhdGUoKTsgLy8gaW4gY2FzZSB3ZSBzY3JvbGxlZCBiYWNrd2FyZHMgbWlkLXNjZW5lIGFuZCByZXZlcnNlIGlzIGRpc2FibGVkID0+IHVwZGF0ZSB0aGUgcGluIHBvc2l0aW9uLCBzbyBpdCBkb2Vzbid0IG1vdmUgYmFjayBhcyB3ZWxsLg0KCQkJCQl9DQoJCQkJfQ0KCQkJCWlmIChkb1VwZGF0ZSkgew0KCQkJCQkvLyBmaXJlIGV2ZW50cw0KCQkJCQl2YXINCgkJCQkJCWV2ZW50VmFycyA9IHtwcm9ncmVzczogX3Byb2dyZXNzLCBzdGF0ZTogX3N0YXRlLCBzY3JvbGxEaXJlY3Rpb246IHNjcm9sbERpcmVjdGlvbn0sDQoJCQkJCQlzdGF0ZUNoYW5nZWQgPSBfc3RhdGUgIT0gb2xkU3RhdGU7DQoNCgkJCQkJdmFyIHRyaWdnZXIgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7IC8vIHRtcCBoZWxwZXIgdG8gc2ltcGxpZnkgY29kZQ0KCQkJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50VmFycyk7DQoJCQkJCX07DQoNCgkJCQkJaWYgKHN0YXRlQ2hhbmdlZCkgeyAvLyBlbnRlciBldmVudHMNCgkJCQkJCWlmIChvbGRTdGF0ZSAhPT0gJ0RVUklORycpIHsNCgkJCQkJCQl0cmlnZ2VyKCJlbnRlciIpOw0KCQkJCQkJCXRyaWdnZXIob2xkU3RhdGUgPT09ICdCRUZPUkUnID8gInN0YXJ0IiA6ICJlbmQiKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCQl0cmlnZ2VyKCJwcm9ncmVzcyIpOw0KCQkJCQlpZiAoc3RhdGVDaGFuZ2VkKSB7IC8vIGxlYXZlIGV2ZW50cw0KCQkJCQkJaWYgKF9zdGF0ZSAhPT0gJ0RVUklORycpIHsNCgkJCQkJCQl0cmlnZ2VyKF9zdGF0ZSA9PT0gJ0JFRk9SRScgPyAic3RhcnQiIDogImVuZCIpOw0KCQkJCQkJCXRyaWdnZXIoImxlYXZlIik7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIEFkZCBhIHR3ZWVuIHRvIHRoZSBzY2VuZS4gIA0KCQkgKiBJZiB5b3Ugd2FudCB0byBhZGQgbXVsdGlwbGUgdHdlZW5zLCB3cmFwIHRoZW0gaW50byBvbmUgVGltZWxpbmVNYXggb2JqZWN0IGFuZCBhZGQgaXQuICANCgkJICogVGhlIGR1cmF0aW9uIG9mIHRoZSB0d2VlbiBpcyBzdHJlY2hlZCB0byB0aGUgc2Nyb2xsIGR1cmF0aW9uIG9mIHRoZSBzY2VuZSwgdW5sZXNzIHRoZSBzY2VuZSBoYXMgYSBkdXJhdGlvbiBvZiBgMGAuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gYWRkIGEgc2luZ2xlIHR3ZWVuDQoJCSAqIHNjZW5lLnNldFR3ZWVuKFR3ZWVuTWF4LnRvKCJvYmoiKSwgMSwge3g6IDEwMH0pOw0KCQkgKg0KCQkgKiAvLyBhZGQgbXVsdGlwbGUgdHdlZW5zLCB3cmFwcGVkIGluIGEgdGltZWxpbmUuDQoJCSAqIHZhciB0aW1lbGluZSA9IG5ldyBUaW1lbGluZU1heCgpOw0KCQkgKiB2YXIgdHdlZW4xID0gVHdlZW5NYXguZnJvbSgib2JqMSIsIDEsIHt4OiAxMDB9KTsNCgkJICogdmFyIHR3ZWVuMiA9IFR3ZWVuTWF4LnRvKCJvYmoyIiwgMSwge3k6IDEwMH0pOw0KCQkgKiB0aW1lbGluZQ0KCQkgKgkJLmFkZCh0d2VlbjEpDQoJCSAqCQkuYWRkKHR3ZWVuMik7DQoJCSAqIHNjZW5lLmFkZFR3ZWVuKHRpbWVsaW5lKTsNCgkJICoNCgkJICogQHBhcmFtIHtvYmplY3R9IFR3ZWVuT2JqZWN0IC0gQSBUd2Vlbk1heCwgVHdlZW5MaXRlLCBUaW1lbGluZU1heCBvciBUaW1lbGluZUxpdGUgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIGFuaW1hdGVkIGluIHRoZSBzY2VuZS4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuc2V0VHdlZW4gPSBmdW5jdGlvbiAoVHdlZW5PYmplY3QpIHsNCgkJCWlmICghVGltZWxpbmVNYXgpIHsNCgkJCQlsb2coMSwgIkVSUk9SOiBUaW1lbGluZU1heCB3YXNuJ3QgZm91bmQuIFBsZWFzZSBtYWtlIHN1cmUgR1NBUCBpcyBsb2FkZWQgYmVmb3JlIFNjcm9sbE1hZ2ljIG9yIHVzZSBhc3luY2hyb25vdXMgbG9hZGluZy4iKTsNCgkJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCQl9DQoJCQlpZiAoX3R3ZWVuKSB7IC8vIGtpbGwgb2xkIHR3ZWVuPw0KCQkJCVNjcm9sbFNjZW5lLnJlbW92ZVR3ZWVuKCk7DQoJCQl9DQoJCQl0cnkgew0KCQkJCS8vIHdyYXAgVHdlZW4gaW50byBhIFRpbWVsaW5lTWF4IE9iamVjdCB0byBpbmNsdWRlIGRlbGF5IGFuZCByZXBlYXRzIGluIHRoZSBkdXJhdGlvbiBhbmQgc3RhbmRhcmRpemUgbWV0aG9kcy4NCgkJCQlfdHdlZW4gPSBuZXcgVGltZWxpbmVNYXgoe3Ntb290aENoaWxkVGltaW5nOiB0cnVlfSkNCgkJCQkJLmFkZChUd2Vlbk9iamVjdCkNCgkJCQkJLnBhdXNlKCk7DQoJCQl9IGNhdGNoIChlKSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjYWxsaW5nIG1ldGhvZCAnc2V0VHdlZW4oKSc6IFN1cHBsaWVkIGFyZ3VtZW50IGlzIG5vdCBhIHZhbGlkIFR3ZWVuT2JqZWN0Iik7DQoJCQl9IGZpbmFsbHkgew0KCQkJCS8vIHNvbWUgcHJvcGVydGllcyBuZWVkIHRvIGJlIHRyYW5zZmVycmVkIGl0IHRvIHRoZSB3cmFwcGVyLCBvdGhlcndpc2UgdGhleSB3b3VsZCBnZXQgbG9zdC4NCgkJCQlpZiAoVHdlZW5PYmplY3QucmVwZWF0ICZhbXA7JmFtcDsgVHdlZW5PYmplY3QucmVwZWF0KCkgPT09IC0xKSB7Ly8gVHdlZW5NYXggb3IgVGltZWxpbmVNYXggT2JqZWN0Pw0KCQkJCQlfdHdlZW4ucmVwZWF0KC0xKTsNCgkJCQkJX3R3ZWVuLnlveW8oVHdlZW5PYmplY3QueW95bygpKTsNCgkJCQl9DQoJCQl9DQoJCQkvLyBTb21lIHR3ZWVuIHZhbGlkYXRpb25zIGFuZCBkZWJ1Z2dpbmcgaGVscGVycw0KDQoJCQkvLyBjaGVjayBpZiB0aGVyZSBhcmUgcG9zaXRpb24gdHdlZW5zIGRlZmluZWQgZm9yIHRoZSB0cmlnZ2VyIGFuZCB3YXJuIGFib3V0IGl0IDopDQoJCQlpZiAoX3R3ZWVuICZhbXA7JmFtcDsgX3BhcmVudCAgJmFtcDsmYW1wOyBfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCAmYW1wOyZhbXA7IF9vcHRpb25zLmxvZ2xldmVsID49IDIpIHsvLyBwYXJlbnQgaXMgbmVlZGVkIHRvIGtub3cgc2Nyb2xsIGRpcmVjdGlvbi4NCgkJCQl2YXINCgkJCQkJdHJpZ2dlclR3ZWVucyA9IF90d2Vlbi5nZXRUd2VlbnNPZigkKF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KSksDQoJCQkJCXZlcnRpY2FsID0gX3BhcmVudC5pbmZvKCJ2ZXJ0aWNhbCIpOw0KCQkJCSQuZWFjaCh0cmlnZ2VyVHdlZW5zLCBmdW5jdGlvbiAoaW5kZXgsIHZhbHVlKSB7DQoJCQkJCXZhcg0KCQkJCQkJdHdlZW52YXJzID0gdmFsdWUudmFycy5jc3MgfHwgdmFsdWUudmFycywNCgkJCQkJCWNvbmRpdGlvbiA9IHZlcnRpY2FsID8gKHR3ZWVudmFycy50b3AgIT09IHVuZGVmaW5lZCB8fCB0d2VlbnZhcnMuYm90dG9tICE9PSB1bmRlZmluZWQpIDogKHR3ZWVudmFycy5sZWZ0ICE9PSB1bmRlZmluZWQgfHwgdHdlZW52YXJzLnJpZ2h0ICE9PSB1bmRlZmluZWQpOw0KCQkJCQlpZiAoY29uZGl0aW9uKSB7DQoJCQkJCQlsb2coMiwgIldBUk5JTkc6IFR3ZWVuaW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdHJpZ2dlciBlbGVtZW50IGFmZmVjdHMgdGhlIHNjZW5lIHRpbWluZyBhbmQgc2hvdWxkIGJlIGF2b2lkZWQhIik7DQoJCQkJCQlyZXR1cm4gZmFsc2U7DQoJCQkJCX0NCgkJCQl9KTsNCgkJCX0NCg0KCQkJLy8gd2FybiBhYm91dCB0d2VlbiBvdmVyd3JpdGVzLCB3aGVuIGFuIGVsZW1lbnQgaXMgdHdlZW5lZCBtdWx0aXBsZSB0aW1lcw0KCQkJaWYgKHBhcnNlRmxvYXQoVHdlZW5MaXRlLnZlcnNpb24pID49IDEuMTQpIHsgLy8gb25PdmVyd3JpdGUgb25seSBwcmVzZW50IHNpbmNlIEdTQVAgdjEuMTQuMA0KCQkJCXZhcg0KCQkJCQlsaXN0ID0gX3R3ZWVuLmdldENoaWxkcmVuKHRydWUsIHRydWUsIGZhbHNlKSwgLy8gZ2V0IGFsbCBuZXN0ZWQgdHdlZW4gb2JqZWN0cw0KCQkJCQluZXdDYWxsYmFjayA9IGZ1bmN0aW9uICgpIHsNCgkJCQkJCWxvZygyLCAiV0FSTklORzogdHdlZW4gd2FzIG92ZXJ3cml0dGVuIGJ5IGFub3RoZXIuIFRvIGxlYXJuIGhvdyB0byBhdm9pZCB0aGlzIGlzc3VlIHNlZSBoZXJlOiBodHRwczovL2dpdGh1Yi5jb20vamFucGFlcGtlL1Njcm9sbE1hZ2ljL3dpa2kvV0FSTklORzotdHdlZW4td2FzLW92ZXJ3cml0dGVuLWJ5LWFub3RoZXIiKTsNCgkJCQkJfTsNCgkJCQlmb3IgKHZhciBpPTAsIHRoaXNUd2Vlbiwgb2xkQ2FsbGJhY2s7IGkmbHQ7bGlzdC5sZW5ndGg7IGkrKykgew0KCQkJCQkvKmpzaGludCBsb29wZnVuYzogdHJ1ZSAqLw0KCQkJCQl0aGlzVHdlZW4gPSBsaXN0W2ldOw0KCQkJCQlpZiAob2xkQ2FsbGJhY2sgIT09IG5ld0NhbGxiYWNrKSB7IC8vIGlmIHR3ZWVucyBpcyBhZGRlZCBtb3JlIHRoYW4gb25jZQ0KCQkJCQkJb2xkQ2FsbGJhY2sgPSB0aGlzVHdlZW4udmFycy5vbk92ZXJ3cml0ZTsNCgkJCQkJCXRoaXNUd2Vlbi52YXJzLm9uT3ZlcndyaXRlID0gZnVuY3Rpb24gKCkgew0KCQkJCQkJCWlmIChvbGRDYWxsYmFjaykgew0KCQkJCQkJCQlvbGRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KCQkJCQkJCX0NCgkJCQkJCQluZXdDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KCQkJCQkJfTsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJCWxvZygzLCAiYWRkZWQgdHdlZW4iKTsNCgkJCXVwZGF0ZVR3ZWVuUHJvZ3Jlc3MoKTsNCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogUmVtb3ZlIHRoZSB0d2VlbiBmcm9tIHRoZSBzY2VuZS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZW1vdmUgdGhlIHR3ZWVuIGZyb20gdGhlIHNjZW5lIHdpdGhvdXQgcmVzZXR0aW5nIGl0DQoJCSAqIHNjZW5lLnJlbW92ZVR3ZWVuKCk7DQoJCSAqDQoJCSAqIC8vIHJlbW92ZSB0aGUgdHdlZW4gZnJvbSB0aGUgc2NlbmUgYW5kIHJlc2V0IGl0IHRvIGluaXRpYWwgcG9zaXRpb24NCgkJICogc2NlbmUucmVtb3ZlVHdlZW4odHJ1ZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0PWZhbHNlXSAtIElmIGB0cnVlYCB0aGUgdHdlZW4gd2lsbCBiZSByZXNldCB0byBpdHMgaW5pdGlhbCB2YWx1ZXMuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJlbW92ZVR3ZWVuID0gZnVuY3Rpb24gKHJlc2V0KSB7DQoJCQlpZiAoX3R3ZWVuKSB7DQoJCQkJaWYgKHJlc2V0KSB7DQoJCQkJCXVwZGF0ZVR3ZWVuUHJvZ3Jlc3MoMCk7DQoJCQkJfQ0KCQkJCV90d2Vlbi5raWxsKCk7DQoJCQkJX3R3ZWVuID0gdW5kZWZpbmVkOw0KCQkJCWxvZygzLCAicmVtb3ZlZCB0d2VlbiAocmVzZXQ6ICIgKyAocmVzZXQgPyAidHJ1ZSIgOiAiZmFsc2UiKSArICIpIik7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFBpbiBhbiBlbGVtZW50IGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIHR3ZWVuLiAgDQoJCSAqIElmIHRoZSBzY2VuZSBkdXJhdGlvbiBpcyAwIHRoZSBlbGVtZW50IHdpbGwgb25seSBiZSB1bnBpbm5lZCwgaWYgdGhlIHVzZXIgc2Nyb2xscyBiYWNrIHBhc3QgdGhlIHN0YXJ0IHBvc2l0aW9uLiAgDQoJCSAqIF8qKk5PVEU6KiogVGhlIG9wdGlvbiBgcHVzaEZvbGxvd2Vyc2AgaGFzIG5vIGVmZmVjdCwgd2hlbiB0aGUgc2NlbmUgZHVyYXRpb24gaXMgMC5fDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gcGluIGVsZW1lbnQgYW5kIHB1c2ggYWxsIGZvbGxvd2luZyBlbGVtZW50cyBkb3duIGJ5IHRoZSBhbW91bnQgb2YgdGhlIHBpbiBkdXJhdGlvbi4NCgkJICogc2NlbmUuc2V0UGluKCIjcGluIik7DQoJCSAqDQoJCSAqIC8vIHBpbiBlbGVtZW50IGFuZCBrZWVwaW5nIGFsbCBmb2xsb3dpbmcgZWxlbWVudHMgaW4gdGhlaXIgcGxhY2UuIFRoZSBwaW5uZWQgZWxlbWVudCB3aWxsIG1vdmUgcGFzdCB0aGVtLg0KCQkgKiBzY2VuZS5zZXRQaW4oIiNwaW4iLCB7cHVzaEZvbGxvd2VyczogZmFsc2V9KTsNCgkJICoNCgkJICogQHBhcmFtIHsoc3RyaW5nfG9iamVjdCl9IGVsZW1lbnQgLSBBIFNlbGVjdG9yIHRhcmdldGluZyBhbiBlbGVtZW50LCBhIERPTSBvYmplY3Qgb3IgYSBqUXVlcnkgb2JqZWN0IHRoYXQgaXMgc3VwcG9zZWQgdG8gYmUgcGlubmVkLg0KCQkgKiBAcGFyYW0ge29iamVjdH0gW3NldHRpbmdzXSAtIHNldHRpbmdzIGZvciB0aGUgcGluDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3NldHRpbmdzLnB1c2hGb2xsb3dlcnM9dHJ1ZV0gLSBJZiBgdHJ1ZWAgZm9sbG93aW5nIGVsZW1lbnRzIHdpbGwgYmUgInB1c2hlZCIgZG93biBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBwaW4sIGlmIGBmYWxzZWAgdGhlIHBpbm5lZCBlbGVtZW50IHdpbGwganVzdCBzY3JvbGwgcGFzdCB0aGVtLiAgDQoJCSAJCQkJCQkJCQkJCQkgICBJZ25vcmVkLCB3aGVuIGR1cmF0aW9uIGlzIGAwYC4NCgkJICogQHBhcmFtIHtzdHJpbmd9IFtzZXR0aW5ncy5zcGFjZXJDbGFzcz0ic2Nyb2xsbWFnaWMtcGluLXNwYWNlciJdIC0gQ2xhc3NuYW1lIG9mIHRoZSBwaW4gc3BhY2VyIGVsZW1lbnQsIHdoaWNoIGlzIHVzZWQgdG8gcmVwbGFjZSB0aGUgZWxlbWVudC4gIA0KCQkgKiBAcGFyYW0ge3N0cmluZ30gW3NldHRpbmdzLnBpbm5lZENsYXNzPSIiXSAtIENsYXNzbmFtZSB0aGF0IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgcGlubmVkIGVsZW1lbnQgZHVyaW5nIHBpbiBwaGFzZSAoYW5kIHJlbW92ZWQgYWZ0ZXIpLg0KCQkgKg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5zZXRQaW4gPSBmdW5jdGlvbiAoZWxlbWVudCwgc2V0dGluZ3MpIHsNCgkJCXZhcg0KCQkJCWRlZmF1bHRTZXR0aW5ncyA9IHsNCgkJCQkJcHVzaEZvbGxvd2VyczogdHJ1ZSwNCgkJCQkJc3BhY2VyQ2xhc3M6ICJzY3JvbGxtYWdpYy1waW4tc3BhY2VyIiwNCgkJCQkJcGlubmVkQ2xhc3M6ICIiDQoJCQkJfTsNCgkJCXNldHRpbmdzID0gJC5leHRlbmQoe30sIGRlZmF1bHRTZXR0aW5ncywgc2V0dGluZ3MpOw0KDQoJCQkvLyB2YWxpZGF0ZSBFbGVtZW50DQoJCQllbGVtZW50ID0gJChlbGVtZW50KS5maXJzdCgpOw0KCQkJaWYgKGVsZW1lbnQubGVuZ3RoID09PSAwKSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjYWxsaW5nIG1ldGhvZCAnc2V0UGluKCknOiBJbnZhbGlkIHBpbiBlbGVtZW50IHN1cHBsaWVkLiIpOw0KCQkJCXJldHVybiBTY3JvbGxTY2VuZTsgLy8gY2FuY2VsDQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQuY3NzKCJwb3NpdGlvbiIpID09ICJmaXhlZCIpIHsNCgkJCQlsb2coMSwgIkVSUk9SIGNhbGxpbmcgbWV0aG9kICdzZXRQaW4oKSc6IFBpbiBkb2VzIG5vdCB3b3JrIHdpdGggZWxlbWVudHMgdGhhdCBhcmUgcG9zaXRpb25lZCAnZml4ZWQnLiIpOw0KCQkJCXJldHVybiBTY3JvbGxTY2VuZTsgLy8gY2FuY2VsDQoJCQl9DQoNCgkJCWlmIChfcGluKSB7IC8vIHByZWV4aXN0aW5nIHBpbj8NCgkJCQlpZiAoX3BpbiA9PT0gZWxlbWVudCkgew0KCQkJCQkvLyBzYW1lIHBpbiB3ZSBhbHJlYWR5IGhhdmUgLT4gZG8gbm90aGluZw0KCQkJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7IC8vIGNhbmNlbA0KCQkJCX0gZWxzZSB7DQoJCQkJCS8vIGtpbGwgb2xkIHBpbg0KCQkJCQlTY3JvbGxTY2VuZS5yZW1vdmVQaW4oKTsNCgkJCQl9DQoJCQkJDQoJCQl9DQoJCQlfcGluID0gZWxlbWVudDsNCgkJCQ0KCQkJX3Bpbi5wYXJlbnQoKS5oaWRlKCk7IC8vIGhhY2sgc3RhcnQgdG8gZm9yY2UgalF1ZXJ5IGNzcyB0byByZXR1cm4gc3R5bGVzaGVldCB2YWx1ZXMgaW5zdGVhZCBvZiBjYWxjdWxhdGVkIHB4IHZhbHVlcy4NCgkJCXZhcg0KCQkJCWluRmxvdyA9IF9waW4uY3NzKCJwb3NpdGlvbiIpICE9ICJhYnNvbHV0ZSIsDQoJCQkJcGluQ1NTID0gX3Bpbi5jc3MoWyJkaXNwbGF5IiwgInRvcCIsICJsZWZ0IiwgImJvdHRvbSIsICJyaWdodCJdKSwNCgkJCQlzaXplQ1NTID0gX3Bpbi5jc3MoWyJ3aWR0aCIsICJoZWlnaHQiXSk7DQoJCQlfcGluLnBhcmVudCgpLnNob3coKTsgLy8gaGFjayBlbmQuDQoNCgkJCWlmIChzaXplQ1NTLndpZHRoID09PSAiMHB4IiAmYW1wOyZhbXA7ICBpbkZsb3cgJmFtcDsmYW1wOyBpc01hcmdpbkNvbGxhcHNlVHlwZShwaW5DU1MuZGlzcGxheSkpIHsNCgkJCQkvLyBsb2cgKDIsICJXQVJOSU5HOiBZb3VyIHBpbm5lZCBlbGVtZW50IHByb2JhYmx5IG5lZWRzIGEgZGVmaW5lZCB3aWR0aCBvciBpdCBtaWdodCBjb2xsYXBzZSBkdXJpbmcgcGluLiIpOw0KCQkJfQ0KCQkJaWYgKCFpbkZsb3cgJmFtcDsmYW1wOyBzZXR0aW5ncy5wdXNoRm9sbG93ZXJzKSB7DQoJCQkJbG9nKDIsICJXQVJOSU5HOiBJZiB0aGUgcGlubmVkIGVsZW1lbnQgaXMgcG9zaXRpb25lZCBhYnNvbHV0ZWx5IHB1c2hGb2xsb3dlcnMgaXMgZGlzYWJsZWQuIik7DQoJCQkJc2V0dGluZ3MucHVzaEZvbGxvd2VycyA9IGZhbHNlOw0KCQkJfQ0KDQoJCQkvLyBjcmVhdGUgc3BhY2VyDQoJCQl2YXIgc3BhY2VyID0gJCgiJmx0O2Rpdj4mbHQ7L2Rpdj4iKQ0KCQkJCQkuYWRkQ2xhc3Moc2V0dGluZ3Muc3BhY2VyQ2xhc3MpDQoJCQkJCS5jc3MocGluQ1NTKQ0KCQkJCQkuZGF0YSgiU2Nyb2xsTWFnaWNQaW5TcGFjZXIiLCB0cnVlKQ0KCQkJCQkuY3NzKHsNCgkJCQkJCXBvc2l0aW9uOiBpbkZsb3cgPyAicmVsYXRpdmUiIDogImFic29sdXRlIiwNCgkJCQkJCSJtYXJnaW4tbGVmdCI6ICJhdXRvIiwNCgkJCQkJCSJtYXJnaW4tcmlnaHQiOiAiYXV0byIsDQoJCQkJCQkiYm94LXNpemluZyI6ICJjb250ZW50LWJveCINCgkJCQkJfSk7DQoNCgkJCS8vIHNldCB0aGUgcGluIE9wdGlvbnMNCgkJCXZhciBwaW5JbmxpbmVDU1MgPSBfcGluWzBdLnN0eWxlOw0KCQkJX3Bpbk9wdGlvbnMgPSB7DQoJCQkJc3BhY2VyOiBzcGFjZXIsDQoJCQkJcmVsU2l6ZTogeyAvLyBzYXZlIGlmIHNpemUgaXMgZGVmaW5lZCB1c2luZyAlIHZhbHVlcy4gaWYgc28sIGhhbmRsZSBzcGFjZXIgcmVzaXplIGRpZmZlcmVudGx5Li4uDQoJCQkJCXdpZHRoOiBzaXplQ1NTLndpZHRoLnNsaWNlKC0xKSA9PT0gIiUiLA0KCQkJCQloZWlnaHQ6IHNpemVDU1MuaGVpZ2h0LnNsaWNlKC0xKSA9PT0gIiUiLA0KCQkJCQlhdXRvRnVsbFdpZHRoOiBzaXplQ1NTLndpZHRoID09PSAiMHB4IiAmYW1wOyZhbXA7ICBpbkZsb3cgJmFtcDsmYW1wOyBpc01hcmdpbkNvbGxhcHNlVHlwZShwaW5DU1MuZGlzcGxheSkNCgkJCQl9LA0KCQkJCXB1c2hGb2xsb3dlcnM6IHNldHRpbmdzLnB1c2hGb2xsb3dlcnMsDQoJCQkJaW5GbG93OiBpbkZsb3csIC8vIHN0b3JlcyBpZiB0aGUgZWxlbWVudCB0YWtlcyB1cCBzcGFjZSBpbiB0aGUgZG9jdW1lbnQgZmxvdw0KCQkJCW9yaWdTdHlsZTogew0KCQkJCQl3aWR0aDogcGluSW5saW5lQ1NTLndpZHRoIHx8ICIiLA0KCQkJCQlwb3NpdGlvbjogcGluSW5saW5lQ1NTLnBvc2l0aW9uIHx8ICIiLA0KCQkJCQl0b3A6IHBpbklubGluZUNTUy50b3AgfHwgIiIsDQoJCQkJCWxlZnQ6IHBpbklubGluZUNTUy5sZWZ0IHx8ICIiLA0KCQkJCQlib3R0b206IHBpbklubGluZUNTUy5ib3R0b20gfHwgIiIsDQoJCQkJCXJpZ2h0OiBwaW5JbmxpbmVDU1MucmlnaHQgfHwgIiIsDQoJCQkJCSJib3gtc2l6aW5nIjogcGluSW5saW5lQ1NTWyJib3gtc2l6aW5nIl0gfHwgIiIsDQoJCQkJCSItbW96LWJveC1zaXppbmciOiBwaW5JbmxpbmVDU1NbIi1tb3otYm94LXNpemluZyJdIHx8ICIiLA0KCQkJCQkiLXdlYmtpdC1ib3gtc2l6aW5nIjogcGluSW5saW5lQ1NTWyItd2Via2l0LWJveC1zaXppbmciXSB8fCAiIg0KCQkJCX0sIC8vIHNhdmUgb2xkIHN0eWxlcyAoZm9yIHJlc2V0KQ0KCQkJCXBpbm5lZENsYXNzOiBzZXR0aW5ncy5waW5uZWRDbGFzcyAvLyB0aGUgY2xhc3MgdGhhdCBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgd2hlbiBwaW5uZWQNCgkJCX07DQoNCgkJCS8vIGlmIHJlbGF0aXZlIHNpemUsIHRyYW5zZmVyIGl0IHRvIHNwYWNlciBhbmQgbWFrZSBwaW4gY2FsY3VsYXRlIGl0Li4uDQoJCQlpZiAoX3Bpbk9wdGlvbnMucmVsU2l6ZS53aWR0aCkgew0KCQkJCXNwYWNlci5jc3MoIndpZHRoIiwgc2l6ZUNTUy53aWR0aCk7DQoJCQl9DQoJCQlpZiAoX3Bpbk9wdGlvbnMucmVsU2l6ZS5oZWlnaHQpIHsNCgkJCQlzcGFjZXIuY3NzKCJoZWlnaHQiLCBzaXplQ1NTLmhlaWdodCk7DQoJCQl9DQoNCgkJCS8vIG5vdyBwbGFjZSB0aGUgcGluIGVsZW1lbnQgaW5zaWRlIHRoZSBzcGFjZXIJDQoJCQlfcGluLmJlZm9yZShzcGFjZXIpDQoJCQkJCS5hcHBlbmRUbyhzcGFjZXIpDQoJCQkJCS8vIGFuZCBzZXQgbmV3IGNzcw0KCQkJCQkuY3NzKHsNCgkJCQkJCXBvc2l0aW9uOiBpbkZsb3cgPyAicmVsYXRpdmUiIDogImFic29sdXRlIiwNCgkJCQkJCXRvcDogImF1dG8iLA0KCQkJCQkJbGVmdDogImF1dG8iLA0KCQkJCQkJYm90dG9tOiAiYXV0byIsDQoJCQkJCQlyaWdodDogImF1dG8iDQoJCQkJCX0pOw0KCQkJDQoJCQlpZiAoX3Bpbk9wdGlvbnMucmVsU2l6ZS53aWR0aCB8fCBfcGluT3B0aW9ucy5yZWxTaXplLmF1dG9GdWxsV2lkdGgpIHsNCgkJCQlfcGluLmNzcygiYm94LXNpemluZyIsICJib3JkZXItYm94Iik7DQoJCQl9DQoNCgkJCS8vIGFkZCBsaXN0ZW5lciB0byBkb2N1bWVudCB0byB1cGRhdGUgcGluIHBvc2l0aW9uIGluIGNhc2UgY29udHJvbGxlciBpcyBub3QgdGhlIGRvY3VtZW50Lg0KCQkJJCh3aW5kb3cpLm9uKCJzY3JvbGwuIiArIE5BTUVTUEFDRSArICJfcGluIHJlc2l6ZS4iICsgTkFNRVNQQUNFICsgIl9waW4iLCB1cGRhdGVQaW5JbkNvbnRhaW5lcik7DQoJCQkvLyBhZGQgbW91c2V3aGVlbCBsaXN0ZW5lciB0byBjYXRjaCBzY3JvbGxzIG92ZXIgZml4ZWQgZWxlbWVudHMNCgkJCV9waW4ub24oIm1vdXNld2hlZWwgRE9NTW91c2VTY3JvbGwiLCBvbk1vdXNld2hlZWxPdmVyUGluKTsNCg0KCQkJbG9nKDMsICJhZGRlZCBwaW4iKTsNCg0KCQkJLy8gZmluYWxseSB1cGRhdGUgdGhlIHBpbiB0byBpbml0DQoJCQl1cGRhdGVQaW5TdGF0ZSgpOw0KDQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFJlbW92ZSB0aGUgcGluIGZyb20gdGhlIHNjZW5lLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHJlbW92ZSB0aGUgcGluIGZyb20gdGhlIHNjZW5lIHdpdGhvdXQgcmVzZXR0aW5nIGl0ICh0aGUgc3BhY2VyIGlzIG5vdCByZW1vdmVkKQ0KCQkgKiBzY2VuZS5yZW1vdmVQaW4oKTsNCgkJICoNCgkJICogLy8gcmVtb3ZlIHRoZSBwaW4gZnJvbSB0aGUgc2NlbmUgYW5kIHJlc2V0IHRoZSBwaW4gZWxlbWVudCB0byBpdHMgaW5pdGlhbCBwb3NpdGlvbiAoc3BhY2VyIGlzIHJlbW92ZWQpDQoJCSAqIHNjZW5lLnJlbW92ZVBpbih0cnVlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbcmVzZXQ9ZmFsc2VdIC0gSWYgYGZhbHNlYCB0aGUgc3BhY2VyIHdpbGwgbm90IGJlIHJlbW92ZWQgYW5kIHRoZSBlbGVtZW50J3MgcG9zaXRpb24gd2lsbCBub3QgYmUgcmVzZXQuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJlbW92ZVBpbiA9IGZ1bmN0aW9uIChyZXNldCkgew0KCQkJaWYgKF9waW4pIHsNCgkJCQlpZiAocmVzZXQgfHwgIV9wYXJlbnQpIHsgLy8gaWYgdGhlcmUncyBubyBwYXJlbnQgbm8gcHJvZ3Jlc3Mgd2FzIG1hZGUgYW55d2F5Li4uDQoJCQkJCV9waW4uaW5zZXJ0QmVmb3JlKF9waW5PcHRpb25zLnNwYWNlcikNCgkJCQkJCS5jc3MoX3Bpbk9wdGlvbnMub3JpZ1N0eWxlKTsNCgkJCQkJX3Bpbk9wdGlvbnMuc3BhY2VyLnJlbW92ZSgpOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWlmIChfc3RhdGUgPT09ICJEVVJJTkciKSB7DQoJCQkJCQl1cGRhdGVQaW5TdGF0ZSh0cnVlKTsgLy8gZm9yY2UgdW5waW4gYXQgcG9zaXRpb24NCgkJCQkJfQ0KCQkJCX0NCgkJCQkkKHdpbmRvdykub2ZmKCJzY3JvbGwuIiArIE5BTUVTUEFDRSArICJfcGluIHJlc2l6ZS4iICsgTkFNRVNQQUNFICsgIl9waW4iKTsNCgkJCQlfcGluLm9mZigibW91c2V3aGVlbCBET01Nb3VzZVNjcm9sbCIsIG9uTW91c2V3aGVlbE92ZXJQaW4pOw0KCQkJCV9waW4gPSB1bmRlZmluZWQ7DQoJCQkJbG9nKDMsICJyZW1vdmVkIHBpbiAocmVzZXQ6ICIgKyAocmVzZXQgPyAidHJ1ZSIgOiAiZmFsc2UiKSArICIpIik7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIERlZmluZSBhIGNzcyBjbGFzcyBtb2RpZmljYXRpb24gd2hpbGUgdGhlIHNjZW5lIGlzIGFjdGl2ZS4gIA0KCQkgKiBXaGVuIHRoZSBzY2VuZSB0cmlnZ2VycyB0aGUgY2xhc3NlcyB3aWxsIGJlIGFkZGVkIHRvIHRoZSBzdXBwbGllZCBlbGVtZW50IGFuZCByZW1vdmVkLCB3aGVuIHRoZSBzY2VuZSBpcyBvdmVyLg0KCQkgKiBJZiB0aGUgc2NlbmUgZHVyYXRpb24gaXMgMCB0aGUgY2xhc3NlcyB3aWxsIG9ubHkgYmUgcmVtb3ZlZCBpZiB0aGUgdXNlciBzY3JvbGxzIGJhY2sgcGFzdCB0aGUgc3RhcnQgcG9zaXRpb24uDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gYWRkIHRoZSBjbGFzcyAnbXljbGFzcycgdG8gdGhlIGVsZW1lbnQgd2l0aCB0aGUgaWQgJ215LWVsZW0nIGZvciB0aGUgZHVyYXRpb24gb2YgdGhlIHNjZW5lDQoJCSAqIHNjZW5lLnNldENsYXNzVG9nZ2xlKCIjbXktZWxlbSIsICJteWNsYXNzIik7DQoJCSAqDQoJCSAqIC8vIGFkZCBtdWx0aXBsZSBjbGFzc2VzIHRvIG11bHRpcGxlIGVsZW1lbnRzIGRlZmluZWQgYnkgdGhlIHNlbGVjdG9yICcuY2xhc3NDaGFuZ2UnDQoJCSAqIHNjZW5lLnNldENsYXNzVG9nZ2xlKCIuY2xhc3NDaGFuZ2UiLCAiY2xhc3MxIGNsYXNzMiBjbGFzczMiKTsNCgkJICoNCgkJICogQHBhcmFtIHsoc3RyaW5nfG9iamVjdCl9IGVsZW1lbnQgLSBBIFNlbGVjdG9yIHRhcmdldGluZyBvbmUgb3IgbW9yZSBlbGVtZW50cywgYSBET00gb2JqZWN0IG9yIGEgalF1ZXJ5IG9iamVjdCB0aGF0IGlzIHN1cHBvc2VkIHRvIGJlIG1vZGlmaWVkLg0KCQkgKiBAcGFyYW0ge3N0cmluZ30gY2xhc3NlcyAtIE9uZSBvciBtb3JlIENsYXNzbmFtZXMgKHNlcGFyYXRlZCBieSBzcGFjZSkgdGhhdCBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIGVsZW1lbnQgZHVyaW5nIHRoZSBzY2VuZS4NCgkJICoNCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuc2V0Q2xhc3NUb2dnbGUgPSBmdW5jdGlvbiAoZWxlbWVudCwgY2xhc3Nlcykgew0KCQkJdmFyICRlbG0gPSAkKGVsZW1lbnQpOw0KCQkJaWYgKCRlbG0ubGVuZ3RoID09PSAwIHx8ICQudHlwZShjbGFzc2VzKSAhPT0gInN0cmluZyIpIHsNCgkJCQlsb2coMSwgIkVSUk9SIGNhbGxpbmcgbWV0aG9kICdzZXRDbGFzc1RvZ2dsZSgpJzogSW52YWxpZCAiICsgKCRlbG0ubGVuZ3RoID09PSAwID8gImVsZW1lbnQiIDogImNsYXNzZXMiKSArICIgc3VwcGxpZWQuIik7DQoJCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQkJfQ0KCQkJX2Nzc0NsYXNzZXMgPSBjbGFzc2VzOw0KCQkJX2Nzc0NsYXNzRWxtID0gJGVsbTsNCgkJCVNjcm9sbFNjZW5lLm9uKCJlbnRlci5pbnRlcm5hbF9jbGFzcyBsZWF2ZS5pbnRlcm5hbF9jbGFzcyIsIGZ1bmN0aW9uIChlKSB7DQoJCQkJX2Nzc0NsYXNzRWxtLnRvZ2dsZUNsYXNzKF9jc3NDbGFzc2VzLCBlLnR5cGUgPT09ICJlbnRlciIpOw0KCQkJfSk7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFJlbW92ZSB0aGUgY2xhc3MgYmluZGluZyBmcm9tIHRoZSBzY2VuZS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZW1vdmUgY2xhc3MgYmluZGluZyBmcm9tIHRoZSBzY2VuZSB3aXRob3V0IHJlc2V0DQoJCSAqIHNjZW5lLnJlbW92ZUNsYXNzVG9nZ2xlKCk7DQoJCSAqDQoJCSAqIC8vIHJlbW92ZSBjbGFzcyBiaW5kaW5nIGFuZCByZW1vdmUgdGhlIGNoYW5nZXMgaXQgY2F1c2VkDQoJCSAqIHNjZW5lLnJlbW92ZUNsYXNzVG9nZ2xlKHRydWUpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldD1mYWxzZV0gLSBJZiBgZmFsc2VgIGFuZCB0aGUgY2xhc3NlcyBhcmUgY3VycmVudGx5IGFjdGl2ZSwgdGhleSB3aWxsIHJlbWFpbiBvbiB0aGUgZWxlbWVudC4gSWYgYHRydWVgIHRoZXkgd2lsbCBiZSByZW1vdmVkLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZW1vdmVDbGFzc1RvZ2dsZSA9IGZ1bmN0aW9uIChyZXNldCkgew0KCQkJaWYgKF9jc3NDbGFzc0VsbSAmYW1wOyZhbXA7IHJlc2V0KSB7DQoJCQkJX2Nzc0NsYXNzRWxtLnJlbW92ZUNsYXNzKF9jc3NDbGFzc2VzKTsNCgkJCX0NCgkJCVNjcm9sbFNjZW5lLm9mZigic3RhcnQuaW50ZXJuYWxfY2xhc3MgZW5kLmludGVybmFsX2NsYXNzIik7DQoJCQlfY3NzQ2xhc3NlcyA9IHVuZGVmaW5lZDsNCgkJCV9jc3NDbGFzc0VsbSA9IHVuZGVmaW5lZDsNCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogQWRkIHRoZSBzY2VuZSB0byBhIGNvbnRyb2xsZXIuICANCgkJICogVGhpcyBpcyB0aGUgZXF1aXZhbGVudCB0byBgU2Nyb2xsTWFnaWMuYWRkU2NlbmUoc2NlbmUpYC4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBhZGQgYSBzY2VuZSB0byBhIFNjcm9sbE1hZ2ljIGNvbnRyb2xsZXINCgkJICogc2NlbmUuYWRkVG8oY29udHJvbGxlcik7DQoJCSAqDQoJCSAqIEBwYXJhbSB7U2Nyb2xsTWFnaWN9IGNvbnRyb2xsZXIgLSBUaGUgY29udHJvbGxlciB0byB3aGljaCB0aGUgc2NlbmUgc2hvdWxkIGJlIGFkZGVkLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5hZGRUbyA9IGZ1bmN0aW9uIChjb250cm9sbGVyKSB7DQoJCQlpZiAoIShjb250cm9sbGVyIGluc3RhbmNlb2YgU2Nyb2xsTWFnaWMpKSB7DQoJCQkJbG9nKDEsICJFUlJPUjogc3VwcGxpZWQgYXJndW1lbnQgb2YgJ2FkZFRvKCknIGlzIG5vdCBhIHZhbGlkIFNjcm9sbE1hZ2ljIGNvbnRyb2xsZXIiKTsNCgkJCX0gZWxzZSBpZiAoX3BhcmVudCAhPSBjb250cm9sbGVyKSB7DQoJCQkJLy8gbmV3IHBhcmVudA0KCQkJCWlmIChfcGFyZW50KSB7IC8vIEkgaGFkIGEgcGFyZW50IGJlZm9yZSwgc28gcmVtb3ZlIGl0Li4uDQoJCQkJCV9wYXJlbnQucmVtb3ZlU2NlbmUoU2Nyb2xsU2NlbmUpOw0KCQkJCX0NCgkJCQlfcGFyZW50ID0gY29udHJvbGxlcjsNCgkJCQl2YWxpZGF0ZU9wdGlvbigpOw0KCQkJCXVwZGF0ZUR1cmF0aW9uKHRydWUpOw0KCQkJCXVwZGF0ZVRyaWdnZXJFbGVtZW50UG9zaXRpb24odHJ1ZSk7DQoJCQkJdXBkYXRlU2Nyb2xsT2Zmc2V0KCk7DQoJCQkJdXBkYXRlUGluU3BhY2VyU2l6ZSgpOw0KCQkJCV9wYXJlbnQuaW5mbygiY29udGFpbmVyIikub24oInJlc2l6ZS4iICsgTkFNRVNQQUNFLCBmdW5jdGlvbiAoKSB7DQoJCQkJCXVwZGF0ZVJlbGF0aXZlUGluU3BhY2VyKCk7DQoJCQkJCWlmIChTY3JvbGxTY2VuZS50cmlnZ2VySG9vaygpID4gMCkgew0KCQkJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigic2hpZnQiLCB7cmVhc29uOiAiY29udGFpbmVyU2l6ZSJ9KTsNCgkJCQkJfQ0KCQkJCX0pOw0KCQkJCWxvZygzLCAiYWRkZWQgIiArIE5BTUVTUEFDRSArICIgdG8gY29udHJvbGxlciIpOw0KCQkJCWNvbnRyb2xsZXIuYWRkU2NlbmUoU2Nyb2xsU2NlbmUpOw0KCQkJCVNjcm9sbFNjZW5lLnVwZGF0ZSgpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIGN1cnJlbnQgZW5hYmxlZCBzdGF0ZSBvZiB0aGUgc2NlbmUuICANCgkJICogVGhpcyBjYW4gYmUgdXNlZCB0byBkaXNhYmxlIHRoaXMgc2NlbmUgd2l0aG91dCByZW1vdmluZyBvciBkZXN0cm95aW5nIGl0Lg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCB2YWx1ZQ0KCQkgKiB2YXIgZW5hYmxlZCA9IHNjZW5lLmVuYWJsZWQoKTsNCgkJICoNCgkgCSAqIC8vIGRpc2FibGUgdGhlIHNjZW5lDQoJCSAqIHNjZW5lLmVuYWJsZWQoZmFsc2UpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZXdTdGF0ZV0gLSBUaGUgbmV3IGVuYWJsZWQgc3RhdGUgb2YgdGhlIHNjZW5lIGB0cnVlYCBvciBgZmFsc2VgLg0KCQkgKiBAcmV0dXJucyB7KGJvb2xlYW58U2Nyb2xsU2NlbmUpfSBDdXJyZW50IGVuYWJsZWQgc3RhdGUgb3IgcGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLmVuYWJsZWQgPSBmdW5jdGlvbiAobmV3U3RhdGUpIHsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX2VuYWJsZWQ7DQoJCQl9IGVsc2UgaWYgKF9lbmFibGVkICE9IG5ld1N0YXRlKSB7IC8vIHNldA0KCQkJCV9lbmFibGVkID0gISFuZXdTdGF0ZTsNCgkJCQlTY3JvbGxTY2VuZS51cGRhdGUodHJ1ZSk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoJCQ0KCQkvKioNCgkJICogUmVtb3ZlIHRoZSBzY2VuZSBmcm9tIGl0cyBwYXJlbnQgY29udHJvbGxlci4gIA0KCQkgKiBUaGlzIGlzIHRoZSBlcXVpdmFsZW50IHRvIGBTY3JvbGxNYWdpYy5yZW1vdmVTY2VuZShzY2VuZSlgLg0KCQkgKiBUaGUgc2NlbmUgd2lsbCBub3QgYmUgdXBkYXRlZCBhbnltb3JlIHVudGlsIHlvdSByZWFkZCBpdCB0byBhIGNvbnRyb2xsZXIuDQoJCSAqIFRvIHJlbW92ZSB0aGUgcGluIG9yIHRoZSB0d2VlbiB5b3UgbmVlZCB0byBjYWxsIHJlbW92ZVR3ZWVuKCkgb3IgcmVtb3ZlUGluKCkgcmVzcGVjdGl2ZWx5Lg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHJlbW92ZSB0aGUgc2NlbmUgZnJvbSBpdHMgcGFyZW50IGNvbnRyb2xsZXINCgkJICogc2NlbmUucmVtb3ZlKCk7DQoJCSAqDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uICgpIHsNCgkJCWlmIChfcGFyZW50KSB7DQoJCQkJX3BhcmVudC5pbmZvKCJjb250YWluZXIiKS5vZmYoInJlc2l6ZS4iICsgTkFNRVNQQUNFKTsNCgkJCQl2YXIgdG1wUGFyZW50ID0gX3BhcmVudDsNCgkJCQlfcGFyZW50ID0gdW5kZWZpbmVkOw0KCQkJCWxvZygzLCAicmVtb3ZlZCAiICsgTkFNRVNQQUNFICsgIiBmcm9tIGNvbnRyb2xsZXIiKTsNCgkJCQl0bXBQYXJlbnQucmVtb3ZlU2NlbmUoU2Nyb2xsU2NlbmUpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBEZXN0cm95IHRoZSBzY2VuZSBhbmQgZXZlcnl0aGluZy4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBkZXN0cm95IHRoZSBzY2VuZSB3aXRob3V0IHJlc2V0dGluZyB0aGUgcGluIGFuZCB0d2VlbiB0byB0aGVpciBpbml0aWFsIHBvc2l0aW9ucw0KCQkgKiBzY2VuZSA9IHNjZW5lLmRlc3Ryb3koKTsNCgkJICoNCgkJICogLy8gZGVzdHJveSB0aGUgc2NlbmUgYW5kIHJlc2V0IHRoZSBwaW4gYW5kIHR3ZWVuDQoJCSAqIHNjZW5lID0gc2NlbmUuZGVzdHJveSh0cnVlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbcmVzZXQ9ZmFsc2VdIC0gSWYgYHRydWVgIHRoZSBwaW4gYW5kIHR3ZWVuIChpZiBleGlzdGVudCkgd2lsbCBiZSByZXNldC4NCgkJICogQHJldHVybnMge251bGx9IE51bGwgdG8gdW5zZXQgaGFuZGxlciB2YXJpYWJsZXMuDQoJCSAqLw0KCQl0aGlzLmRlc3Ryb3kgPSBmdW5jdGlvbiAocmVzZXQpIHsNCgkJCVNjcm9sbFNjZW5lLnJlbW92ZVR3ZWVuKHJlc2V0KTsNCgkJCVNjcm9sbFNjZW5lLnJlbW92ZVBpbihyZXNldCk7DQoJCQlTY3JvbGxTY2VuZS5yZW1vdmVDbGFzc1RvZ2dsZShyZXNldCk7DQoJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJkZXN0cm95Iiwge3Jlc2V0OiByZXNldH0pOw0KCQkJU2Nyb2xsU2NlbmUucmVtb3ZlKCk7DQoJCQlTY3JvbGxTY2VuZS5vZmYoInN0YXJ0IGVuZCBlbnRlciBsZWF2ZSBwcm9ncmVzcyBjaGFuZ2UgdXBkYXRlIHNoaWZ0IGRlc3Ryb3kgc2hpZnQuaW50ZXJuYWwgY2hhbmdlLmludGVybmFsIHByb2dyZXNzLmludGVybmFsIik7DQoJCQlsb2coMywgImRlc3Ryb3llZCAiICsgTkFNRVNQQUNFICsgIiAocmVzZXQ6ICIgKyAocmVzZXQgPyAidHJ1ZSIgOiAiZmFsc2UiKSArICIpIik7DQoJCQlyZXR1cm4gbnVsbDsNCgkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIEVWRU5UUw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KCQkNCgkJLyoqDQoJCSAqIFNjZW5lIHN0YXJ0IGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW5ldmVyIHRoZSBzY3JvbGwgcG9zaXRpb24gaXRzIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgc2NlbmUuICANCgkJICogSXQgd2lsbCBhbHNvIGZpcmUgd2hlbiBzY3JvbGxpbmcgYmFjayB1cCBnb2luZyBvdmVyIHRoZSBzdGFydCBwb3NpdGlvbiBvZiB0aGUgc2NlbmUuIElmIHlvdSB3YW50IHNvbWV0aGluZyB0byBoYXBwZW4gb25seSB3aGVuIHNjcm9sbGluZyBkb3duL3JpZ2h0LCB1c2UgdGhlIHNjcm9sbERpcmVjdGlvbiBwYXJhbWV0ZXIgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4NCgkJICoNCgkJICogRm9yIGRldGFpbHMgb24gdGhpcyBldmVudCBhbmQgdGhlIG9yZGVyIGluIHdoaWNoIGl0IGlzIGZpcmVkLCBwbGVhc2UgcmV2aWV3IHRoZSB7QGxpbmsgU2Nyb2xsU2NlbmUucHJvZ3Jlc3N9IG1ldGhvZC4NCgkJICoNCgkJICogQGV2ZW50IFNjcm9sbFNjZW5lLnN0YXJ0DQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJzdGFydCIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWFsZXJ0KCJIaXQgc3RhcnQgcG9pbnQgb2Ygc2NlbmUuIik7DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcHJvcGVydHkge29iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgT2JqZWN0IHBhc3NlZCB0byBlYWNoIGNhbGxiYWNrDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC50eXBlIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7U2Nyb2xsU2NlbmV9IGV2ZW50LnRhcmdldCAtIFRoZSBTY3JvbGxTY2VuZSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhpcyBldmVudA0KCQkgKiBAcHJvcGVydHkge251bWJlcn0gZXZlbnQucHJvZ3Jlc3MgLSBSZWZsZWN0cyB0aGUgY3VycmVudCBwcm9ncmVzcyBvZiB0aGUgc2NlbmUNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnN0YXRlIC0gVGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHNjZW5lIGAiQkVGT1JFImAsIGAiRFVSSU5HImAgb3IgYCJBRlRFUiJgDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zY3JvbGxEaXJlY3Rpb24gLSBJbmRpY2F0ZXMgd2hpY2ggd2F5IHdlIGFyZSBzY3JvbGxpbmcgYCJQQVVTRUQiYCwgYCJGT1JXQVJEImAgb3IgYCJSRVZFUlNFImANCgkJICovDQoJCS8qKg0KCQkgKiBTY2VuZSBlbmQgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbmV2ZXIgdGhlIHNjcm9sbCBwb3NpdGlvbiBpdHMgdGhlIGVuZGluZyBwb2ludCBvZiB0aGUgc2NlbmUuICANCgkJICogSXQgd2lsbCBhbHNvIGZpcmUgd2hlbiBzY3JvbGxpbmcgYmFjayB1cCBmcm9tIGFmdGVyIHRoZSBzY2VuZSBhbmQgZ29pbmcgb3ZlciBpdHMgZW5kIHBvc2l0aW9uLiBJZiB5b3Ugd2FudCBzb21ldGhpbmcgdG8gaGFwcGVuIG9ubHkgd2hlbiBzY3JvbGxpbmcgZG93bi9yaWdodCwgdXNlIHRoZSBzY3JvbGxEaXJlY3Rpb24gcGFyYW1ldGVyIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suDQoJCSAqDQoJCSAqIEZvciBkZXRhaWxzIG9uIHRoaXMgZXZlbnQgYW5kIHRoZSBvcmRlciBpbiB3aGljaCBpdCBpcyBmaXJlZCwgcGxlYXNlIHJldmlldyB0aGUge0BsaW5rIFNjcm9sbFNjZW5lLnByb2dyZXNzfSBtZXRob2QuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS5lbmQNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oImVuZCIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWFsZXJ0KCJIaXQgZW5kIHBvaW50IG9mIHNjZW5lLiIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnByb2dyZXNzIC0gUmVmbGVjdHMgdGhlIGN1cnJlbnQgcHJvZ3Jlc3Mgb2YgdGhlIHNjZW5lDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zdGF0ZSAtIFRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBzY2VuZSBgIkJFRk9SRSJgLCBgIkRVUklORyJgIG9yIGAiQUZURVIiYA0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc2Nyb2xsRGlyZWN0aW9uIC0gSW5kaWNhdGVzIHdoaWNoIHdheSB3ZSBhcmUgc2Nyb2xsaW5nIGAiUEFVU0VEImAsIGAiRk9SV0FSRCJgIG9yIGAiUkVWRVJTRSJgDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgZW50ZXIgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbmV2ZXIgdGhlIHNjZW5lIGVudGVycyB0aGUgIkRVUklORyIgc3RhdGUuICANCgkJICogS2VlcCBpbiBtaW5kIHRoYXQgaXQgZG9lc24ndCBtYXR0ZXIgaWYgdGhlIHNjZW5lIHBsYXlzIGZvcndhcmQgb3IgYmFja3dhcmQ6IFRoaXMgZXZlbnQgYWx3YXlzIGZpcmVzIHdoZW4gdGhlIHNjZW5lIGVudGVycyBpdHMgYWN0aXZlIHNjcm9sbCB0aW1lZnJhbWUsIHJlZ2FyZGxlc3Mgb2YgdGhlIHNjcm9sbC1kaXJlY3Rpb24uDQoJCSAqDQoJCSAqIEZvciBkZXRhaWxzIG9uIHRoaXMgZXZlbnQgYW5kIHRoZSBvcmRlciBpbiB3aGljaCBpdCBpcyBmaXJlZCwgcGxlYXNlIHJldmlldyB0aGUge0BsaW5rIFNjcm9sbFNjZW5lLnByb2dyZXNzfSBtZXRob2QuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS5lbnRlcg0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiBzY2VuZS5vbigiZW50ZXIiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQlhbGVydCgiRW50ZXJlZCBhIHNjZW5lLiIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnByb2dyZXNzIC0gUmVmbGVjdHMgdGhlIGN1cnJlbnQgcHJvZ3Jlc3Mgb2YgdGhlIHNjZW5lDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zdGF0ZSAtIFRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBzY2VuZSBgIkJFRk9SRSJgLCBgIkRVUklORyJgIG9yIGAiQUZURVIiYA0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc2Nyb2xsRGlyZWN0aW9uIC0gSW5kaWNhdGVzIHdoaWNoIHdheSB3ZSBhcmUgc2Nyb2xsaW5nIGAiUEFVU0VEImAsIGAiRk9SV0FSRCJgIG9yIGAiUkVWRVJTRSJgDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgbGVhdmUgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbmV2ZXIgdGhlIHNjZW5lJ3Mgc3RhdGUgZ29lcyBmcm9tICJEVVJJTkciIHRvIGVpdGhlciAiQkVGT1JFIiBvciAiQUZURVIiLiAgDQoJCSAqIEtlZXAgaW4gbWluZCB0aGF0IGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHRoZSBzY2VuZSBwbGF5cyBmb3J3YXJkIG9yIGJhY2t3YXJkOiBUaGlzIGV2ZW50IGFsd2F5cyBmaXJlcyB3aGVuIHRoZSBzY2VuZSBsZWF2ZXMgaXRzIGFjdGl2ZSBzY3JvbGwgdGltZWZyYW1lLCByZWdhcmRsZXNzIG9mIHRoZSBzY3JvbGwtZGlyZWN0aW9uLg0KCQkgKg0KCQkgKiBGb3IgZGV0YWlscyBvbiB0aGlzIGV2ZW50IGFuZCB0aGUgb3JkZXIgaW4gd2hpY2ggaXQgaXMgZmlyZWQsIHBsZWFzZSByZXZpZXcgdGhlIHtAbGluayBTY3JvbGxTY2VuZS5wcm9ncmVzc30gbWV0aG9kLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUubGVhdmUNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oImxlYXZlIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQoJCSAqIAkJYWxlcnQoIkxlZnQgYSBzY2VuZS4iKTsNCgkJICogfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBldmVudC5wcm9ncmVzcyAtIFJlZmxlY3RzIHRoZSBjdXJyZW50IHByb2dyZXNzIG9mIHRoZSBzY2VuZQ0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc3RhdGUgLSBUaGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgc2NlbmUgYCJCRUZPUkUiYCwgYCJEVVJJTkciYCBvciBgIkFGVEVSImANCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnNjcm9sbERpcmVjdGlvbiAtIEluZGljYXRlcyB3aGljaCB3YXkgd2UgYXJlIHNjcm9sbGluZyBgIlBBVVNFRCJgLCBgIkZPUldBUkQiYCBvciBgIlJFVkVSU0UiYA0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIHVwZGF0ZSBldmVudC4gIA0KCQkgKiBGaXJlcyB3aGVuZXZlciB0aGUgc2NlbmUgaXMgdXBkYXRlZCAoYnV0IG5vdCBuZWNlc3NhcmlseSBjaGFuZ2VzIHRoZSBwcm9ncmVzcykuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS51cGRhdGUNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oInVwZGF0ZSIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJTY2VuZSB1cGRhdGVkLiIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnN0YXJ0UG9zIC0gVGhlIHN0YXJ0aW5nIHBvc2l0aW9uIG9mIHRoZSBzY2VuZSAoaW4gcmVsYXRpb24gdG8gdGhlIGNvbmFpbmVyKQ0KCQkgKiBAcHJvcGVydHkge251bWJlcn0gZXZlbnQuZW5kUG9zIC0gVGhlIGVuZGluZyBwb3NpdGlvbiBvZiB0aGUgc2NlbmUgKGluIHJlbGF0aW9uIHRvIHRoZSBjb25haW5lcikNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnNjcm9sbFBvcyAtIFRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbiBvZiB0aGUgY29udGFpbmVyDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgcHJvZ3Jlc3MgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbmV2ZXIgdGhlIHByb2dyZXNzIG9mIHRoZSBzY2VuZSBjaGFuZ2VzLg0KCQkgKg0KCQkgKiBGb3IgZGV0YWlscyBvbiB0aGlzIGV2ZW50IGFuZCB0aGUgb3JkZXIgaW4gd2hpY2ggaXQgaXMgZmlyZWQsIHBsZWFzZSByZXZpZXcgdGhlIHtAbGluayBTY3JvbGxTY2VuZS5wcm9ncmVzc30gbWV0aG9kLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUucHJvZ3Jlc3MNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oInByb2dyZXNzIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQoJCSAqIAkJY29uc29sZS5sb2coIlNjZW5lIHByb2dyZXNzIGNoYW5nZWQuIik7DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcHJvcGVydHkge29iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgT2JqZWN0IHBhc3NlZCB0byBlYWNoIGNhbGxiYWNrDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC50eXBlIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7U2Nyb2xsU2NlbmV9IGV2ZW50LnRhcmdldCAtIFRoZSBTY3JvbGxTY2VuZSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhpcyBldmVudA0KCQkgKiBAcHJvcGVydHkge251bWJlcn0gZXZlbnQucHJvZ3Jlc3MgLSBSZWZsZWN0cyB0aGUgY3VycmVudCBwcm9ncmVzcyBvZiB0aGUgc2NlbmUNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnN0YXRlIC0gVGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHNjZW5lIGAiQkVGT1JFImAsIGAiRFVSSU5HImAgb3IgYCJBRlRFUiJgDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zY3JvbGxEaXJlY3Rpb24gLSBJbmRpY2F0ZXMgd2hpY2ggd2F5IHdlIGFyZSBzY3JvbGxpbmcgYCJQQVVTRUQiYCwgYCJGT1JXQVJEImAgb3IgYCJSRVZFUlNFImANCgkJICovDQoJCS8qKg0KCQkgKiBTY2VuZSBjaGFuZ2UgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbnZldmVyIGEgcHJvcGVydHkgb2YgdGhlIHNjZW5lIGlzIGNoYW5nZWQuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS5jaGFuZ2UNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oImNoYW5nZSIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJTY2VuZSBQcm9wZXJ0eSBcIiIgKyBldmVudC53aGF0ICsgIlwiIGNoYW5nZWQgdG8gIiArIGV2ZW50Lm5ld3ZhbCk7DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcHJvcGVydHkge29iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgT2JqZWN0IHBhc3NlZCB0byBlYWNoIGNhbGxiYWNrDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC50eXBlIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7U2Nyb2xsU2NlbmV9IGV2ZW50LnRhcmdldCAtIFRoZSBTY3JvbGxTY2VuZSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhpcyBldmVudA0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQud2hhdCAtIEluZGljYXRlcyB3aGF0IHZhbHVlIGhhcyBiZWVuIGNoYW5nZWQNCgkJICogQHByb3BlcnR5IHttaXhlZH0gZXZlbnQubmV3dmFsIC0gVGhlIG5ldyB2YWx1ZSBvZiB0aGUgY2hhbmdlZCBwcm9wZXJ0eQ0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIHNoaWZ0IGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW52ZXZlciB0aGUgc3RhcnQgb3IgZW5kICoqc2Nyb2xsIG9mZnNldCoqIG9mIHRoZSBzY2VuZSBjaGFuZ2UuDQoJCSAqIFRoaXMgaGFwcGVucyBleHBsaWNpdGVseSwgd2hlbiBvbmUgb2YgdGhlc2UgdmFsdWVzIGNoYW5nZTogYG9mZnNldGAsIGBkdXJhdGlvbmAgb3IgYHRyaWdnZXJIb29rYC4NCgkJICogSXQgd2lsbCBmaXJlIGltcGxpY2l0bHkgd2hlbiB0aGUgYHRyaWdnZXJFbGVtZW50YCBjaGFuZ2VzLCBpZiB0aGUgbmV3IGVsZW1lbnQgaGFzIGEgZGlmZmVyZW50IHBvc2l0aW9uIChtb3N0IGNhc2VzKS4NCgkJICogSXQgd2lsbCBhbHNvIGZpcmUgaW1wbGljaXRseSB3aGVuIHRoZSBzaXplIG9mIHRoZSBjb250YWluZXIgY2hhbmdlcyBhbmQgdGhlIHRyaWdnZXJIb29rIGlzIGFueXRoaW5nIG90aGVyIHRoYW4gYG9uTGVhdmVgLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUuc2hpZnQNCgkJICogQHNpbmNlIDEuMS4wDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJzaGlmdCIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJTY2VuZSBtb3ZlZCwgYmVjYXVzZSB0aGUgIiArIGV2ZW50LnJlYXNvbiArICIgaGFzIGNoYW5nZWQuKSIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnJlYXNvbiAtIEluZGljYXRlcyB3aHkgdGhlIHNjZW5lIGhhcyBzaGlmdGVkDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgZGVzdHJveSBldmVudC4gIA0KCQkgKiBGaXJlcyB3aGVudmV2ZXIgdGhlIHNjZW5lIGlzIGRlc3Ryb3llZC4NCgkJICogVGhpcyBjYW4gYmUgdXNlZCB0byB0aWR5IHVwIGN1c3RvbSBiZWhhdmlvdXIgdXNlZCBpbiBldmVudHMuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS5kZXN0cm95DQoJCSAqIEBzaW5jZSAxLjEuMA0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiBzY2VuZS5vbigiZW50ZXIiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogICAgICAgIC8vIGFkZCBjdXN0b20gYWN0aW9uDQoJCSAqICAgICAgICAkKCIjbXktZWxlbSIpLmxlZnQoIjIwMCIpOw0KCQkgKiAgICAgIH0pDQoJCSAqICAgICAgLm9uKCJkZXN0cm95IiwgZnVuY3Rpb24gKGV2ZW50KSB7DQoJCSAqICAgICAgICAvLyByZXNldCBteSBlbGVtZW50IHRvIHN0YXJ0IHBvc2l0aW9uDQoJCSAqICAgICAgICBpZiAoZXZlbnQucmVzZXQpIHsNCgkJICogICAgICAgICAgJCgiI215LWVsZW0iKS5sZWZ0KCIwIik7DQoJCSAqICAgICAgICB9DQoJCSAqICAgICAgfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXZlbnQucmVzZXQgLSBJbmRpY2F0ZXMgaWYgdGhlIGRlc3Ryb3kgbWV0aG9kIHdhcyBjYWxsZWQgd2l0aCByZXNldCBgdHJ1ZWAgb3IgYGZhbHNlYC4NCgkJICovDQoJCSANCgkJIC8qKg0KCQkgKiBBZGQgb25lIG9yZSBtb3JlIGV2ZW50IGxpc3RlbmVyLiAgDQoJCSAqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aWxsIGJlIGZpcmVkIGF0IHRoZSByZXNwZWN0aXZlIGV2ZW50LCBhbmQgYW4gb2JqZWN0IGNvbnRhaW5pbmcgcmVsZXZhbnQgZGF0YSB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suDQoJCSAqIEBwdWJsaWMNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogZnVuY3Rpb24gY2FsbGJhY2sgKGV2ZW50KSB7DQoJCSAqIAkJY29uc29sZS5sb2coIkV2ZW50IGZpcmVkISAoIiArIGV2ZW50LnR5cGUgKyAiKSIpOw0KCQkgKiB9DQoJCSAqIC8vIGFkZCBsaXN0ZW5lcnMNCgkJICogc2NlbmUub24oImNoYW5nZSB1cGRhdGUgcHJvZ3Jlc3Mgc3RhcnQgZW5kIGVudGVyIGxlYXZlIiwgY2FsbGJhY2spOw0KCQkgKg0KCQkgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9yIG5hbWVzIG9mIHRoZSBldmVudCB0aGUgY2FsbGJhY2sgc2hvdWxkIGJlIGF0dGFjaGVkIHRvLg0KCQkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIEEgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWQsIHdoZW4gdGhlIGV2ZW50IGlzIGRpc3BhdGNoZWQuIEFuIGV2ZW50IG9iamVjdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQkgdGhpcy5vbiA9IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykgew0KCQkJaWYgKCQuaXNGdW5jdGlvbihjYWxsYmFjaykpIHsNCgkJCQl2YXIgbmFtZXMgPSAkLnRyaW0obmFtZSkudG9Mb3dlckNhc2UoKQ0KCQkJCQkJCS5yZXBsYWNlKC8oXHcrKVwuKFx3KykvZywgJyQxLicgKyBOQU1FU1BBQ0UgKyAnXyQyJykgLy8gYWRkIGN1c3RvbSBuYW1lc3BhY2UsIGlmIG9uZSBpcyBkZWZpbmVkDQoJCQkJCQkJLnJlcGxhY2UoLyggfF4pKFx3KykoPz0gfCQpL2csICckMSQyLicgKyBOQU1FU1BBQ0UgKTsgLy8gYWRkIG5hbWVzcGFjZSB0byByZWd1bGFycy4NCgkJCQkkKFNjcm9sbFNjZW5lKS5vbihuYW1lcywgY2FsbGJhY2spOw0KCQkJfSBlbHNlIHsNCgkJCQlsb2coMSwgIkVSUk9SIGNhbGxpbmcgbWV0aG9kICdvbigpJzogU3VwcGxpZWQgYXJndW1lbnQgaXMgbm90IGEgdmFsaWQgY2FsbGJhY2shIik7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCSB9Ow0KDQoJCSAvKioNCgkJICogUmVtb3ZlIG9uZSBvciBtb3JlIGV2ZW50IGxpc3RlbmVyLg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIGZ1bmN0aW9uIGNhbGxiYWNrIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJFdmVudCBmaXJlZCEgKCIgKyBldmVudC50eXBlICsgIikiKTsNCgkJICogfQ0KCQkgKiAvLyBhZGQgbGlzdGVuZXJzDQoJCSAqIHNjZW5lLm9uKCJjaGFuZ2UgdXBkYXRlIiwgY2FsbGJhY2spOw0KCQkgKiAvLyByZW1vdmUgbGlzdGVuZXJzDQoJCSAqIHNjZW5lLm9mZigiY2hhbmdlIHVwZGF0ZSIsIGNhbGxiYWNrKTsNCgkJICoNCgkJICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvciBuYW1lcyBvZiB0aGUgZXZlbnQgdGhhdCBzaG91bGQgYmUgcmVtb3ZlZC4NCgkJICogQHBhcmFtIHtmdW5jdGlvbn0gW2NhbGxiYWNrXSAtIEEgc3BlY2lmaWMgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgcmVtb3ZlZC4gSWYgbm9uZSBpcyBwYXNzZWQgYWxsIGNhbGxiYWNrcyB0byB0aGUgZXZlbnQgbGlzdGVuZXIgd2lsbCBiZSByZW1vdmVkLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJIHRoaXMub2ZmID0gZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrKSB7DQoJCQl2YXIgbmFtZXMgPSAkLnRyaW0obmFtZSkudG9Mb3dlckNhc2UoKQ0KCQkJCQkJLnJlcGxhY2UoLyhcdyspXC4oXHcrKS9nLCAnJDEuJyArIE5BTUVTUEFDRSArICdfJDInKSAvLyBhZGQgY3VzdG9tIG5hbWVzcGFjZSwgaWYgb25lIGlzIGRlZmluZWQNCgkJCQkJCS5yZXBsYWNlKC8oIHxeKShcdyspKD89IHwkKS9nLCAnJDEkMi4nICsgTkFNRVNQQUNFICsgJyQzJyk7IC8vIGFkZCBuYW1lc3BhY2UgdG8gcmVndWxhcnMuDQoJCQkkKFNjcm9sbFNjZW5lKS5vZmYobmFtZXMsIGNhbGxiYWNrKTsNCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJIH07DQoNCgkJIC8qKg0KCQkgKiBUcmlnZ2VyIGFuIGV2ZW50Lg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHRoaXMudHJpZ2dlcigiY2hhbmdlIik7DQoJCSAqDQoJCSAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRoYXQgc2hvdWxkIGJlIHRyaWdnZXJlZC4NCgkJICogQHBhcmFtIHtvYmplY3R9IFt2YXJzXSAtIEFuIG9iamVjdCBjb250YWluaW5nIGluZm8gdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCSB0aGlzLnRyaWdnZXIgPSBmdW5jdGlvbiAobmFtZSwgdmFycykgew0KCQkJbG9nKDMsICdldmVudCBmaXJlZDonLCBuYW1lLCAiLT4iLCB2YXJzKTsNCgkJCXZhciBldmVudCA9ICQuRXZlbnQoJC50cmltKG5hbWUpLnRvTG93ZXJDYXNlKCksIHZhcnMpOw0KCQkJJChTY3JvbGxTY2VuZSkudHJpZ2dlcihldmVudCk7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCSB9Ow0KDQoJCS8vIElOSVQNCgkJY29uc3RydWN0KCk7DQoJCXJldHVybiBTY3JvbGxTY2VuZTsNCgl9Ow0KCXJldHVybiBTY3JvbGxTY2VuZTsNCn0pOw0KDQoJLyoNCgkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJICogZ2xvYmFsIGxvZ2dpbmcgZnVuY3Rpb25zIGFuZCBtYWtpbmcgc3VyZSBubyBjb25zb2xlIGVycm9ycyBvY2N1cg0KCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkgKi8NCg0KCXZhciBkZWJ1ZyA9IChmdW5jdGlvbiAoY29uc29sZSkgew0KCQl2YXIgbG9nbGV2ZWxzID0gWyJlcnJvciIsICJ3YXJuIiwgImxvZyJdOw0KCQlpZiAoIWNvbnNvbGUubG9nKSB7DQoJCQljb25zb2xlLmxvZyA9IGZ1bmN0aW9uKCl7fTsgLy8gbm8gY29uc29sZSBsb2csIHdlbGwgLSBkbyBub3RoaW5nIHRoZW4uLi4NCgkJfQ0KCQlmb3IodmFyIGkgPSAwLCBtZXRob2Q7IGkmbHQ7bG9nbGV2ZWxzLmxlbmd0aDsgaSsrKSB7IC8vIG1ha2Ugc3VyZSBtZXRob2RzIGZvciBhbGwgbGV2ZWxzIGV4aXN0Lg0KCQkJbWV0aG9kID0gbG9nbGV2ZWxzW2ldOw0KCQkJaWYgKCFjb25zb2xlW21ldGhvZF0pIHsNCgkJCQljb25zb2xlW21ldGhvZF0gPSBjb25zb2xlLmxvZzsgLy8gcHJlZmVyIC5sb2cgb3ZlciBub3RoaW5nDQoJCQl9DQoJCX0NCgkJLy8gZGVidWdnaW5nIGZ1bmN0aW9uDQoJCXJldHVybiBmdW5jdGlvbiAobG9nbGV2ZWwpIHsNCgkJCWlmIChsb2dsZXZlbCA+IGxvZ2xldmVscy5sZW5ndGggfHwgbG9nbGV2ZWwgJmx0Oz0gMCkgbG9nbGV2ZWwgPSBsb2dsZXZlbHMubGVuZ3RoOw0KCQkJdmFyIG5vdyA9IG5ldyBEYXRlKCksDQoJCQkJdGltZSA9ICgiMCIrbm93LmdldEhvdXJzKCkpLnNsaWNlKC0yKSArICI6IiArICgiMCIrbm93LmdldE1pbnV0ZXMoKSkuc2xpY2UoLTIpICsgIjoiICsgKCIwIitub3cuZ2V0U2Vjb25kcygpKS5zbGljZSgtMikgKyAiOiIgKyAoIjAwIitub3cuZ2V0TWlsbGlzZWNvbmRzKCkpLnNsaWNlKC0zKSwNCgkJCQltZXRob2QgPSBsb2dsZXZlbHNbbG9nbGV2ZWwtMV0sDQoJCQkJYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDEpLA0KCQkJCWZ1bmMgPSBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGVbbWV0aG9kXSwgY29uc29sZSk7DQoNCgkJCWFyZ3MudW5zaGlmdCh0aW1lKTsNCgkJCWZ1bmMuYXBwbHkoY29uc29sZSwgYXJncyk7DQoJCX07DQoJfSh3aW5kb3cuY29uc29sZSA9IHdpbmRvdy5jb25zb2xlIHx8IHt9KSk7DQoJLy8gYSBoZWxwZXIgZnVuY3Rpb24gdGhhdCBzaG91bGQgZ2VuZXJhbGx5IGJlIGZhc3RlciB0aGFuIGpRdWVyeS5vZmZzZXQoKSBhbmQgY2FuIGFsc28gcmV0dXJuIHBvc2l0aW9uIGluIHJlbGF0aW9uIHRvIHZpZXdwb3J0Lg0KCXZhciBnZXRPZmZzZXQgPSBmdW5jdGlvbiAoZWxlbSwgcmVsYXRpdmVUb1ZpZXdwb3J0KSB7DQoJCXZhciBvZmZzZXQgPSB7dG9wOiAwLCBsZWZ0OiAwfTsNCgkJZWxlbSA9IGVsZW1bMF07IC8vIHRtcCB3b3JrYXJvdW5kIHVudGlsIGpRdWVyeSBkZXBlbmRlbmN5IGlzIHJlbW92ZWQuDQoJCWlmIChlbGVtICZhbXA7JmFtcDsgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QpIHsgLy8gY2hlY2sgaWYgYXZhaWxhYmxlDQoJCQl2YXIgcmVjdCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7DQoJCQlvZmZzZXQudG9wID0gcmVjdC50b3A7DQoJCQlvZmZzZXQubGVmdCA9IHJlY3QubGVmdDsNCgkJCWlmICghcmVsYXRpdmVUb1ZpZXdwb3J0KSB7IC8vIGNsaWVudFJlY3QgaXMgYnkgZGVmYXVsdCByZWxhdGl2ZSB0byB2aWV3cG9ydC4uLg0KCQkJCW9mZnNldC50b3AgKz0gKHdpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2N1bWVudC5zY3JvbGxUb3AgIHx8IDApIC0gKGRvY3VtZW50LmNsaWVudFRvcCAgfHwgMCk7DQoJCQkJb2Zmc2V0LmxlZnQgKz0gKHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5zY3JvbGxMZWZ0ICB8fCAwKSAtIChkb2N1bWVudC5jbGllbnRMZWZ0IHx8IDApOw0KCQkJfQ0KCQl9DQoJCXJldHVybiBvZmZzZXQ7DQoJfTsNCgl2YXIgaXNEb21FbGVtZW50ID0gZnVuY3Rpb24gKG8pew0KCQlyZXR1cm4gKA0KCQkJdHlwZW9mIEhUTUxFbGVtZW50ID09PSAib2JqZWN0IiA/IG8gaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA6IC8vRE9NMg0KCQkJbyAmYW1wOyZhbXA7IHR5cGVvZiBvID09PSAib2JqZWN0IiAmYW1wOyZhbXA7IG8gIT09IG51bGwgJmFtcDsmYW1wOyBvLm5vZGVUeXBlID09PSAxICZhbXA7JmFtcDsgdHlwZW9mIG8ubm9kZU5hbWU9PT0ic3RyaW5nIg0KCQkpOw0KCX07DQoJdmFyIGlzTWFyZ2luQ29sbGFwc2VUeXBlID0gZnVuY3Rpb24gKHN0cikgew0KCQlyZXR1cm4gWyJibG9jayIsICJmbGV4IiwgImxpc3QtaXRlbSIsICJ0YWJsZSIsICItd2Via2l0LWJveCJdLmluZGV4T2Yoc3RyKSA+IC0xOw0KCX07DQoJLy8gaW1wbGVtZW50YXRpb24gb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lDQoJdmFyIGFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lOw0KCXZhciBhbmltYXRpb25GcmFtZUNhbmNlbENhbGxiYWNrID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lOw0KDQoJLy8gcG9seWZpbGwgLT4gYmFzZWQgb24gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vcGF1bGlyaXNoLzE1Nzk2NzENCgkoZnVuY3Rpb24gKHdpbmRvdykgew0KCQl2YXINCgkJCWxhc3RUaW1lID0gMCwNCgkJCXZlbmRvcnMgPSBbJ21zJywgJ21veicsICd3ZWJraXQnLCAnbyddLA0KCQkJaTsNCg0KCQkvLyB0cnkgdmVuZG9yIHByZWZpeGVzIGlmIHRoZSBhYm92ZSBkb2Vzbid0IHdvcmsNCgkJZm9yIChpID0gMDsgIWFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sgJmFtcDsmYW1wOyBpICZsdDsgdmVuZG9ycy5sZW5ndGg7ICsraSkgew0KCQkJYW5pbWF0aW9uRnJhbWVDYWxsYmFjayA9IHdpbmRvd1t2ZW5kb3JzW2ldICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOw0KCQkJYW5pbWF0aW9uRnJhbWVDYW5jZWxDYWxsYmFjayA9IHdpbmRvd1t2ZW5kb3JzW2ldICsgJ0NhbmNlbEFuaW1hdGlvbkZyYW1lJ10gfHwgd2luZG93W3ZlbmRvcnNbaV0gKyAnQ2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ107DQoJCX0NCg0KCQkvLyBmYWxsYmFja3MNCgkJaWYgKCFhbmltYXRpb25GcmFtZUNhbGxiYWNrKSB7DQoJCQlhbmltYXRpb25GcmFtZUNhbGxiYWNrID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7DQoJCQkJdmFyDQoJCQkJCWN1cnJUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCksDQoJCQkJCXRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSksDQoJCQkJCWlkID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgeyBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOyB9LCB0aW1lVG9DYWxsKTsNCgkJCQlsYXN0VGltZSA9IGN1cnJUaW1lICsgdGltZVRvQ2FsbDsNCgkJCQlyZXR1cm4gaWQ7DQoJCQl9Ow0KCQl9DQoJCWlmICghYW5pbWF0aW9uRnJhbWVDYW5jZWxDYWxsYmFjaykgew0KCQkJYW5pbWF0aW9uRnJhbWVDYW5jZWxDYWxsYmFjayA9IGZ1bmN0aW9uIChpZCkgew0KCQkJCXdpbmRvdy5jbGVhclRpbWVvdXQoaWQpOw0KCQkJfTsNCgkJfQ0KCX0od2luZG93KSk7DQoNCn0pKHRoaXMgfHwgd2luZG93KTs8L3ByZT4KICAgICAgICA8L2FydGljbGU+CiAgICA8L3NlY3Rpb24+CgoKCgoKCQkJCTwvZGl2PgoKCQkJCTxkaXYgY2xhc3M9ImNsZWFyZml4Ij48L2Rpdj4KCQkJCTxmb290ZXI+CgkJCQkJCgkJCQkJCgkJPHNwYW4gY2xhc3M9ImNvcHlyaWdodCI+CgkJwqkgSmFuIFBhZXBrZSAyMDE0CgkJPC9zcGFuPgoJCQkJCTxiciAvPgoJCQkJCQoJCTxzcGFuIGNsYXNzPSJqc2RvYy1tZXNzYWdlIj4KCQlEb2N1bWVudGF0aW9uIGdlbmVyYXRlZCBieSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vanNkb2MzL2pzZG9jIiB0YXJnZXQ9Il9ibGFuayI+SlNEb2MgMy4zLjAtYWxwaGE5PC9hPgoJCXVzaW5nIGEgY3VzdG9taXplZCB2ZXJzaW9uIG9mIHRoZSA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vdGVycnl3ZWlzcy9kb2NzdHJhcCIgdGFyZ2V0PSJfYmxhbmsiPkRvY1N0cmFwIHRlbXBsYXRlPC9hPi4KCQk8L3NwYW4+CgkJCQk8L2Zvb3Rlcj4KCQkJPC9kaXY+CgoJCQkKCQkJPGJyIGNsZWFyPSJib3RoIj4KCQk8L2Rpdj4KCgk8L2Rpdj4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL3N1bmxpZ2h0LmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL3N1bmxpZ2h0LmphdmFzY3JpcHQuanMiPjwvc2NyaXB0PgoJPHNjcmlwdCBzcmM9InNjcmlwdHMvc3VubGlnaHQtcGx1Z2luLmRvY2xpbmtzLmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL3N1bmxpZ2h0LXBsdWdpbi5saW5lbnVtYmVycy5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9zdW5saWdodC1wbHVnaW4ubWVudS5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9qcXVlcnkubWluLmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL2pxdWVyeS5zY3JvbGxUby5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9qcXVlcnkubG9jYWxTY3JvbGwuanMiPjwvc2NyaXB0PgoJPHNjcmlwdCBzcmM9InNjcmlwdHMvYm9vdHN0cmFwLWRyb3Bkb3duLmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL3RvYy5qcyI+PC9zY3JpcHQ+CgoJPHNjcmlwdD4gcHJldHR5UHJpbnQoKTsgPC9zY3JpcHQ+Cgk8c2NyaXB0PiAgU3VubGlnaHQuaGlnaGxpZ2h0QWxsKHtsaW5lTnVtYmVyczp0cnVlLCAgc2hvd01lbnU6IHRydWUsIGVuYWJsZURvY2xpbmtzIDp0cnVlfSk7IDwvc2NyaXB0PgoKCTxzY3JpcHQ+CgkJZnVuY3Rpb24gb3BlbkRlZXBsaW5rZWRFbGVtZW50IChza2lwQW5pKSB7CgkJCSQoImR0IGg0Lm1lbWJlci1jb2xsYXBzZWRbaWQ9JyIgKyB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkucmVwbGFjZSgiOiIsICJcXDoiKSArIiddIikudHJpZ2dlcigiY2xpY2siLCBza2lwQW5pKTsKCQl9CgkJJCggZnVuY3Rpb24gKCkgewoJCQkkKCAiI3RvYyIgKS50b2MoIHsKCQkJICAgIGFuY2hvck5hbWUgIDogZnVuY3Rpb24oaSwgaGVhZGluZywgcHJlZml4KSB7CgkJCQkJcmV0dXJuICQoaGVhZGluZykuYXR0cigiaWQiKSB8fCAoIHByZWZpeCArIGkgKTsKCQkJCX0sCgkJCQlzZWxlY3RvcnMgICA6ICJoMTp2aXNpYmxlLGgyOnZpc2libGUsaDM6dmlzaWJsZSxoNDp2aXNpYmxlIiwKCQkJCW9uU2Nyb2xsRmluaXNoIDogb3BlbkRlZXBsaW5rZWRFbGVtZW50LAoJCQkJaGlnaGxpZ2h0T2Zmc2V0IDogMTAsCgkJCQlzY3JvbGxPZmZzZXQ6IDYwCgkJCX0gKTsKCQkJJCggIiN0b2M+dWwiICkuYWRkQ2xhc3MoICJuYXYgbmF2LXBpbGxzIG5hdi1zdGFja2VkIiApOwoJCQkkKCAiI21haW4gc3BhbltpZF49J3RvYyddIiApLmFkZENsYXNzKCAidG9jLXNoaW0iICk7CgoJCX0gKTsKCTwvc2NyaXB0PgoKCQoJPHNjcmlwdD4KCQkkKCBmdW5jdGlvbiAoKSB7CgkJCS8vICQoJyNtYWluJykubG9jYWxTY3JvbGwoewoJCQkvLyAJb2Zmc2V0OiB7IHRvcDogNTYgfSAvL29mZnNldCBieSB0aGUgaGVpZ2h0IG9mIHlvdXIgaGVhZGVyIChnaXZlIG9yIHRha2UgYSBmZXcgcHgsIHNlZSB3aGF0IHdvcmtzIGZvciB5b3UpCgkJCS8vIH0pOwoJCQkvLyB3b3JrYXJvdW5kIGZvciBhbmNob3JzIGJlbG93IGhlYWRlci4uLgoJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CgkJCQkkKGRvY3VtZW50KS5zY3JvbGxUb3AoJChkb2N1bWVudCkuc2Nyb2xsVG9wKCktNjApOwoJCQl9LCAxKQoJCQkKCQkJdmFyIGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSkucmVwbGFjZSgiOiIsICJcXDoiKTsKCQkJJCggImR0IGg0Lm5hbWUiICkuZWFjaCggZnVuY3Rpb24gKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoJCQkJdmFyIGljb24gPSAkKCAiPGkvPiIgKS5hZGRDbGFzcyggImljb24tcGx1cy1zaWduIiApLmFkZENsYXNzKCAicHVsbC1yaWdodCIgKS5hZGRDbGFzcyggImljb24td2hpdGUiICk7CgkJCQl2YXIgZHQgPSAkdGhpcy5wYXJlbnRzKCAiZHQiICk7CgkJCQl2YXIgY2hpbGRyZW4gPSBkdC5uZXh0KCAiZGQiICk7CgoJCQkJJHRoaXMuYXBwZW5kKCBpY29uICkuY3NzKCB7Y3Vyc29yIDogInBvaW50ZXIifSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJtZW1iZXItY29sbGFwc2VkIiApLmFkZENsYXNzKCAibWVtYmVyIiApOwoJCQkJaWYgKGhhc2ggIT0gJHRoaXMuYXR0cigiaWQiKSkgewoJCQkJCWNoaWxkcmVuLmhpZGUoKTsKCQkJCX0KCQkJCSR0aGlzLnRvZ2dsZSggZnVuY3Rpb24gKGUsIHNraXBBbmkpIHsKCQkJCQl2YXIgc2Nyb2xsUG9zID0gJChkb2N1bWVudCkuc2Nyb2xsVG9wKCk7CgkJCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSAkKHRoaXMpLmF0dHIoImlkIik7CgkJCQkJJChkb2N1bWVudCkuc2Nyb2xsVG9wKHNjcm9sbFBvcyk7CgkJCQkJaWNvbi5hZGRDbGFzcyggImljb24tbWludXMtc2lnbiIgKS5yZW1vdmVDbGFzcyggImljb24tcGx1cy1zaWduIiApLnJlbW92ZUNsYXNzKCAiaWNvbi13aGl0ZSIgKTsKCQkJCQkkdGhpcy5hZGRDbGFzcyggIm1lbWJlci1vcGVuIiApLnJlbW92ZUNsYXNzKCAibWVtYmVyLWNvbGxhcHNlZCIgKTsKCQkJCQljaGlsZHJlbi5zbGlkZURvd24oc2tpcEFuaSA/IDAgOiB1bmRlZmluZWQpOwoJCQkJfSwgZnVuY3Rpb24gKCkgewoJCQkJCWljb24uYWRkQ2xhc3MoICJpY29uLXBsdXMtc2lnbiIgKS5yZW1vdmVDbGFzcyggImljb24tbWludXMtc2lnbiIgKS5hZGRDbGFzcyggImljb24td2hpdGUiICk7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJtZW1iZXItY29sbGFwc2VkIiApLnJlbW92ZUNsYXNzKCAibWVtYmVyLW9wZW4iICk7CgkJCQkJY2hpbGRyZW4uc2xpZGVVcCgpOwoJCQkJfSApOwoJCQl9ICk7CgkJCS8vIG9wZW4gaWYgZGVlcGxpbmtlZAoJCQlpZiAoaGFzaC5sZW5ndGggPiAwKQoJCQkJb3BlbkRlZXBsaW5rZWRFbGVtZW50KHRydWUpOwoJCX0gKTsKCTwvc2NyaXB0PgoJCgoJPHNjcmlwdD4KCQkoZnVuY3Rpb24oaSxzLG8sZyxyLGEsbSl7aVsnR29vZ2xlQW5hbHl0aWNzT2JqZWN0J109cjtpW3JdPWlbcl18fGZ1bmN0aW9uKCl7CgkJKGlbcl0ucT1pW3JdLnF8fFtdKS5wdXNoKGFyZ3VtZW50cyl9LGlbcl0ubD0xKm5ldyBEYXRlKCk7YT1zLmNyZWF0ZUVsZW1lbnQobyksCgkJbT1zLmdldEVsZW1lbnRzQnlUYWdOYW1lKG8pWzBdO2EuYXN5bmM9MTthLnNyYz1nO20ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoYSxtKQoJCX0pKHdpbmRvdyxkb2N1bWVudCwnc2NyaXB0JywnLy93d3cuZ29vZ2xlLWFuYWx5dGljcy5jb20vYW5hbHl0aWNzLmpzJywnZ2EnKTsKCQlnYSgnY3JlYXRlJywgJ1VBLTM3NTI0MzQ0LTMnLCAnamFucGFlcGtlLmdpdGh1Yi5pbycpOwoJCWdhKCdzZW5kJywgJ3BhZ2V2aWV3Jyk7Cgk8L3NjcmlwdD4KPC9ib2R5Pgo8L2h0bWw+Cg==",
                "body": "PCFET0NUWVBFIGh0bWw+Cgo8aHRtbCBsYW5nPSJlbiI+CjxoZWFkPgoJPG1ldGEgY2hhcnNldD0idXRmLTgiPgoJPHRpdGxlPlNjcm9sbE1hZ2ljIFNvdXJjZToganF1ZXJ5LnNjcm9sbG1hZ2ljLmpzPC90aXRsZT4KCQogIDxzY3JpcHQgc3JjPSJzY3JpcHRzL3ByZXR0aWZ5L3ByZXR0aWZ5LmpzIj4gPC9zY3JpcHQ+CiAgPHNjcmlwdCBzcmM9InNjcmlwdHMvcHJldHRpZnkvbGFuZy1jc3MuanMiPiA8L3NjcmlwdD4KCTwhLS1baWYgbHQgSUUgOV0+Cgk8c2NyaXB0IHNyYz0iLy9odG1sNXNoaXYuZ29vZ2xlY29kZS5jb20vc3ZuL3RydW5rL2h0bWw1LmpzIj48L3NjcmlwdD4KCTwhW2VuZGlmXS0tPgoJPGxpbmsgdHlwZT0idGV4dC9jc3MiIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0ic3R5bGVzL3N1bmxpZ2h0LmRlZmF1bHQuY3NzIj4KCTxsaW5rIHR5cGU9InRleHQvY3NzIiByZWw9InN0eWxlc2hlZXQiIGhyZWY9InN0eWxlcy9wcmV0dGlmeS10b21vcnJvdy5jc3MiPgoJPGxpbmsgcmVsPSJzaG9ydGN1dCBpY29uIiBocmVmPSIuLi9pbWcvZmF2aWNvbi5pY28iIHR5cGU9ImltYWdlL3gtaWNvbiI+CgoJCgk8bGluayB0eXBlPSJ0ZXh0L2NzcyIgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJzdHlsZXMvc2l0ZS5jb3Ntby5jc3MiPgoJCjwvaGVhZD4KCjxib2R5Pgo8ZGl2IGNsYXNzPSJjb250YWluZXItZmx1aWQiPgoJPGRpdiBjbGFzcz0ibmF2YmFyIG5hdmJhci1maXhlZC10b3AgbmF2YmFyLWludmVyc2UiPgoJCTxkaXYgY2xhc3M9Im5hdmJhci1pbm5lciI+CgkJCTxhIGNsYXNzPSJicmFuZCIgaHJlZj0iaW5kZXguaHRtbCI+U2Nyb2xsTWFnaWM8L2E+CgkJCTx1bCBjbGFzcz0ibmF2Ij4KCQkJCQoJCQkJPGxpIGNsYXNzPSJkcm9wZG93biI+CgkJCQkJPGEgaHJlZj0iY2xhc3Nlcy5saXN0Lmh0bWwiIGNsYXNzPSJkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+Q2xhc3NlczxiCgkJCQkJCWNsYXNzPSJjYXJldCI+PC9iPjwvYT4KCgkJCQkJPHVsIGNsYXNzPSJkcm9wZG93bi1tZW51ICI+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxNYWdpYy5odG1sIj5TY3JvbGxNYWdpYzwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwiPlNjcm9sbFNjZW5lPC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCgkJCQkJPC91bD4KCQkJCTwvbGk+CgkJCQkKCQkJCTxsaSBjbGFzcz0iZHJvcGRvd24iPgoJCQkJCTxhIGhyZWY9ImV2ZW50cy5saXN0Lmh0bWwiIGNsYXNzPSJkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+RXZlbnRzPGIKCQkJCQkJY2xhc3M9ImNhcmV0Ij48L2I+PC9hPgoKCQkJCQk8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUgIj4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6Y2hhbmdlIj5jaGFuZ2U8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OmRlc3Ryb3kiPmRlc3Ryb3k8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OmVuZCI+ZW5kPC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCNldmVudDplbnRlciI+ZW50ZXI8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OmxlYXZlIj5sZWF2ZTwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6cHJvZ3Jlc3MiPnByb2dyZXNzPC9hPgoJCQkJCQk8L2xpPgoJCQkJCQkKCQkJCQkJPGxpPgoJCQkJCQkJPGEgaHJlZj0iU2Nyb2xsU2NlbmUuaHRtbCNldmVudDpzaGlmdCI+c2hpZnQ8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoJCQkJCQk8bGk+CgkJCQkJCQk8YSBocmVmPSJTY3JvbGxTY2VuZS5odG1sI2V2ZW50OnN0YXJ0Ij5zdGFydDwvYT4KCQkJCQkJPC9saT4KCQkJCQkJCgkJCQkJCTxsaT4KCQkJCQkJCTxhIGhyZWY9IlNjcm9sbFNjZW5lLmh0bWwjZXZlbnQ6dXBkYXRlIj51cGRhdGU8L2E+CgkJCQkJCTwvbGk+CgkJCQkJCQoKCQkJCQk8L3VsPgoJCQkJPC9saT4KCQkJCQoJCQk8L3VsPgoJCTwvZGl2PgoJPC9kaXY+CgoJPGRpdiBjbGFzcz0icm93LWZsdWlkIj4KCgkJCgkJCTxkaXYgY2xhc3M9InNwYW4xMiI+CgkJCQkKCQkJCTxkaXYgaWQ9Im1haW4iPgoJCQkJCQoKCgkJPGgxIGNsYXNzPSJwYWdlLXRpdGxlIj5Tb3VyY2U6IGpxdWVyeS5zY3JvbGxtYWdpYy5qczwvaDE+CiAgICAKICAgIDxzZWN0aW9uPgogICAgICAgIDxhcnRpY2xlPgogICAgICAgICAgICA8cHJlIGNsYXNzPSJzdW5saWdodC1oaWdobGlnaHQtamF2YXNjcmlwdCBsaW5lbnVtcyI+LyoNClNjcm9sbE1hZ2ljIHYxLjIuMw0KVGhlIGpRdWVyeSBwbHVnaW4gZm9yIGRvaW5nIG1hZ2ljYWwgc2Nyb2xsIGludGVyYWN0aW9ucy4NCihjKSAyMDE0IEphbiBQYWVwa2UgKEBqYW5wYWVwa2UpDQpMaWNlbnNlICZhbXA7IEluZm86IGh0dHA6Ly9qYW5wYWVwa2UuZ2l0aHViLmlvL1Njcm9sbE1hZ2ljDQoJDQpJbnNwaXJlZCBieSBhbmQgcGFydGlhbGx5IGJhc2VkIG9uIFNVUEVSU0NST0xMT1JBTUEgYnkgSm9obiBQb2xhY2VrIChAam9obnBvbGFjZWspDQpodHRwOi8vam9obnBvbGFjZWsuZ2l0aHViLmNvbS9zdXBlcnNjcm9sbG9yYW1hLw0KDQpQb3dlcmVkIGJ5IHRoZSBHcmVlbnNvY2sgVHdlZW5pbmcgUGxhdGZvcm0gKEdTQVApOiBodHRwOi8vd3d3LmdyZWVuc29jay5jb20vanMNCkdyZWVuc29jayBMaWNlbnNlIGluZm8gYXQgaHR0cDovL3d3dy5ncmVlbnNvY2suY29tL2xpY2Vuc2luZy8NCiovCi8qKg0KQG92ZXJ2aWV3CSMjSW5mbw0KQHZlcnNpb24JMS4yLjMNCkBsaWNlbnNlCUR1YWwgbGljZW5zZWQgdW5kZXIgTUlUIGxpY2Vuc2UgYW5kIEdQTC4NCkBhdXRob3IJCUphbiBQYWVwa2UgLSBlLW1haWxAamFucGFlcGtlLmRlDQoNCkB0b2RvOiBlbmhhbmNlbWVudDogcmVtb3ZlIGRlcGVuZGVuY2llcyBhbmQgbW92ZSB0byBwbHVnaW5zIC0+IDIuMA0KQHRvZG86IGJ1Zzogd2hlbiBjYXNjYWRpbmcgcGlucyAocGlubmluZyBvbmUgZWxlbWVudCBtdWx0aXBsZSB0aW1lcykgYW5kIGxhdGVyIHJlbW92aW5nIHRoZW0gd2l0aG91dCByZXNldCwgcG9zaXRpb25pbmcgZXJyb3JzIG9jY3VyLg0KQHRvZG86IGJ1ZzogaGF2aW5nIG11bHRpcGxlIHNjcm9sbCBkaXJlY3Rpb25zIHdpdGggY2FzY2FkZWQgcGlucyBkb2Vzbid0IHdvcmsgKG9uZSBzY3JvbGwgdmVydGljYWwsIG9uZSBob3Jpem9udGFsKQ0KQHRvZG86IGZlYXR1cmU6IG9wdGltaXplIHBlcmZvcm1hbmNlIG9uIGRlYnVnIHBsdWdpbiAoaHVnZSBkcmF3YmFja3MsIHdoZW4gdXNpbmcgbWFueSBzY2VuZXMpDQoqLw0KKGZ1bmN0aW9uKHJvb3QpIHsNCgkNCgkidXNlIHN0cmljdCI7DQoNCgl2YXIgZGVmaW5lID0gcm9vdC5kZWZpbmUsIFNjcm9sbE1hZ2ljLCBTY3JvbGxTY2VuZTsNCiAgU2Nyb2xsU2NlbmUgPSBTY3JvbGxNYWdpYyA9IGZ1bmN0aW9uICgpIHt9Ow0KICBpZiAodHlwZW9mIGRlZmluZSAhPT0gJ2Z1bmN0aW9uJyB8fCAhZGVmaW5lLmFtZCkgew0KICAJLy8gTm8gQU1EIGxvYWRlciAtPiBQcm92aWRlIGN1c3RvbSBtZXRob2QgdG8gdG8gcmVnaXN0ZXIgYnJvd3NlciBnbG9iYWxzIGluc3RlYWQNCiAgCWRlZmluZSA9IGZ1bmN0aW9uIChtb2R1bGVOYW1lLCBkZXBlbmRlbmNpZXMsIGZhY3RvcnkpIHsNCiAgCQlmb3IgKHZhciB4ID0gMCwgZGVwZW5kZW5jeTsgeCZsdDtkZXBlbmRlbmNpZXMubGVuZ3RoOyB4KyspIHsNCiAgCQkJZGVwZW5kZW5jeSA9IGRlcGVuZGVuY2llc1t4XTsNCiAgCQkJaWYgKGRlcGVuZGVuY3kgPT09ICdqcXVlcnknKSB7IC8vIGxvd2VyY2FzZSB3aXRoIHJlcXVpcmUsIGJ1dCBjYW1lbCBjYXNlIGFzIGdsb2JhbA0KICAJCQkJZGVwZW5kZW5jeSA9ICdqUXVlcnknOw0KICAJCQl9DQogIAkJCWRlcGVuZGVuY2llc1t4XSA9IHJvb3RbZGVwZW5kZW5jeV07DQogIAkJfQ0KICAJCXJvb3RbbW9kdWxlTmFtZV0gPSBmYWN0b3J5LmFwcGx5KHJvb3QsIGRlcGVuZGVuY2llcyk7DQogIAl9Ow0KICB9DQoNCmRlZmluZSgnU2Nyb2xsTWFnaWMnLCBbJ2pxdWVyeScsICdUd2Vlbk1heCcsICdUaW1lbGluZU1heCddLCBmdW5jdGlvbiAoJCwgVHdlZW5NYXgsIFRpbWVsaW5lTWF4KSB7DQoJLyoqDQoJICogVGhlIG1haW4gY2xhc3MgdGhhdCBpcyBuZWVkZWQgb25jZSBwZXIgc2Nyb2xsIGNvbnRhaW5lci4NCgkgKg0KCSAqIEBjbGFzcw0KCSAqIEBnbG9iYWwNCgkgKg0KCSAqIEBleGFtcGxlDQoJICogLy8gYmFzaWMgaW5pdGlhbGl6YXRpb24NCgkgKiB2YXIgY29udHJvbGxlciA9IG5ldyBTY3JvbGxNYWdpYygpOw0KCSAqDQoJICogLy8gcGFzc2luZyBvcHRpb25zDQoJICogdmFyIGNvbnRyb2xsZXIgPSBuZXcgU2Nyb2xsTWFnaWMoe2NvbnRhaW5lcjogIiNteUNvbnRhaW5lciIsIGxvZ2xldmVsOiAzfSk7DQoJICoNCgkgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgb25lIG9yIG1vcmUgb3B0aW9ucyBmb3IgdGhlIGNvbnRyb2xsZXIuDQoJICogQHBhcmFtIHsoc3RyaW5nfG9iamVjdCl9IFtvcHRpb25zLmNvbnRhaW5lcj13aW5kb3ddIC0gQSBzZWxlY3RvciwgRE9NIG9iamVjdCBvciBhIGpRdWVyeSBvYmplY3QgdGhhdCByZWZlcmVuY2VzIHRoZSBtYWluIGNvbnRhaW5lciBmb3Igc2Nyb2xsaW5nLg0KCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudmVydGljYWw9dHJ1ZV0gLSBTZXRzIHRoZSBzY3JvbGwgbW9kZSB0byB2ZXJ0aWNhbCAoYHRydWVgKSBvciBob3Jpem9udGFsIChgZmFsc2VgKSBzY3JvbGxpbmcuDQoJICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zLmdsb2JhbFNjZW5lT3B0aW9ucz17fV0gLSBUaGVzZSBvcHRpb25zIHdpbGwgYmUgcGFzc2VkIHRvIGV2ZXJ5IFNjZW5lIHRoYXQgaXMgYWRkZWQgdG8gdGhlIGNvbnRyb2xsZXIgdXNpbmcgdGhlIGFkZFNjZW5lIG1ldGhvZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24gb24gU2NlbmUgb3B0aW9ucyBzZWUge0BsaW5rIFNjcm9sbFNjZW5lfS4NCgkgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMubG9nbGV2ZWw9Ml0gTG9nbGV2ZWwgZm9yIGRlYnVnZ2luZy4gTm90ZSB0aGF0IGxvZ2dpbmcgaXMgZGlzYWJsZWQgaW4gdGhlIG1pbmlmaWVkIHZlcnNpb24gb2YgU2Nyb2xsTWFnaWMuDQoJCQkJCQkJCQkJCSAqKiBgMGAgPT4gc2lsZW50DQoJCQkJCQkJCQkJCSAqKiBgMWAgPT4gZXJyb3JzDQoJCQkJCQkJCQkJCSAqKiBgMmAgPT4gZXJyb3JzLCB3YXJuaW5ncw0KCQkJCQkJCQkJCQkgKiogYDNgID0+IGVycm9ycywgd2FybmluZ3MsIGRlYnVnaW5mbw0KCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMucmVmcmVzaEludGVydmFsPTEwMF0gLSBTb21lIGNoYW5nZXMgZG9uJ3QgY2FsbCBldmVudHMgYnkgZGVmYXVsdCwgbGlrZSBjaGFuZ2luZyB0aGUgY29udGFpbmVyIHNpemUgb3IgbW92aW5nIGEgc2NlbmUgdHJpZ2dlciBlbGVtZW50LiAgDQoJIAkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJIFRoaXMgaW50ZXJ2YWwgcG9sbHMgdGhlc2UgcGFyYW1ldGVycyB0byBmaXJlIHRoZSBuZWNlc3NhcnkgZXZlbnRzLiAgDQoJIAkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJIElmIHlvdSBkb24ndCB1c2UgY3VzdG9tIGNvbnRhaW5lcnMsIHRyaWdnZXIgZWxlbWVudHMgb3IgaGF2ZSBzdGF0aWMgbGF5b3V0cywgd2hlcmUgdGhlIHBvc2l0aW9ucyBvZiB0aGUgdHJpZ2dlciBlbGVtZW50cyBkb24ndCBjaGFuZ2UsIHlvdSBjYW4gc2V0IHRoaXMgdG8gMCBkaXNhYmxlIGludGVydmFsIGNoZWNraW5nIGFuZCBpbXByb3ZlIHBlcmZvcm1hbmNlLg0KCSAqDQoJICovDQoJU2Nyb2xsTWFnaWMgPSBmdW5jdGlvbihvcHRpb25zKSB7DQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBzZXR0aW5ncw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KCQl2YXINCgkJCU5BTUVTUEFDRSA9ICJTY3JvbGxNYWdpYyIsDQoJCQlERUZBVUxUX09QVElPTlMgPSB7DQoJCQkJY29udGFpbmVyOiB3aW5kb3csDQoJCQkJdmVydGljYWw6IHRydWUsDQoJCQkJZ2xvYmFsU2NlbmVPcHRpb25zOiB7fSwNCgkJCQlsb2dsZXZlbDogMiwNCgkJCQlyZWZyZXNoSW50ZXJ2YWw6IDEwMA0KCQkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHByaXZhdGUgdmFycw0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCXZhcg0KCQkJU2Nyb2xsTWFnaWMgPSB0aGlzLA0KCQkJX29wdGlvbnMgPSAkLmV4dGVuZCh7fSwgREVGQVVMVF9PUFRJT05TLCBvcHRpb25zKSwNCgkJCV9zY2VuZU9iamVjdHMgPSBbXSwNCgkJCV91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSA9IGZhbHNlLAkJLy8gY2FuIGJlIGJvb2xlYW4gKHRydWUgPT4gYWxsIHNjZW5lcykgb3IgYW4gYXJyYXkgb2Ygc2NlbmVzIHRvIGJlIHVwZGF0ZWQNCgkJCV9zY3JvbGxQb3MgPSAwLA0KCQkJX3Njcm9sbERpcmVjdGlvbiA9ICJQQVVTRUQiLA0KCQkJX2lzRG9jdW1lbnQgPSB0cnVlLA0KCQkJX3ZpZXdQb3J0U2l6ZSA9IDAsDQoJCQlfZW5hYmxlZCA9IHRydWUsDQoJCQlfdXBkYXRlQ3ljbGUsDQoJCQlfcmVmcmVzaEludGVydmFsOw0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHJpdmF0ZSBmdW5jdGlvbnMNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQkvKioNCgkJICogSW50ZXJuYWwgY29uc3RydWN0b3IgZnVuY3Rpb24gb2YgU2Nyb2xsTWFnaWMNCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciBjb25zdHJ1Y3QgPSBmdW5jdGlvbiAoKSB7DQoJCQlTY3JvbGxNYWdpYy52ZXJzaW9uID0gU2Nyb2xsTWFnaWMuY29uc3RydWN0b3IudmVyc2lvbjsNCgkJCSQuZWFjaChfb3B0aW9ucywgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsNCgkJCQlpZiAoIURFRkFVTFRfT1BUSU9OUy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQoJCQkJCWxvZygyLCAiV0FSTklORzogVW5rbm93biBvcHRpb24gXCIiICsga2V5ICsgIlwiIik7DQoJCQkJCWRlbGV0ZSBfb3B0aW9uc1trZXldOw0KCQkJCX0NCgkJCX0pOw0KCQkJX29wdGlvbnMuY29udGFpbmVyID0gJChfb3B0aW9ucy5jb250YWluZXIpLmZpcnN0KCk7DQoJCQkvLyBjaGVjayBTY3JvbGxDb250YWluZXINCgkJCWlmIChfb3B0aW9ucy5jb250YWluZXIubGVuZ3RoID09PSAwKSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjcmVhdGluZyBvYmplY3QgIiArIE5BTUVTUEFDRSArICI6IE5vIHZhbGlkIHNjcm9sbCBjb250YWluZXIgc3VwcGxpZWQiKTsNCgkJCQl0aHJvdyBOQU1FU1BBQ0UgKyAiIGluaXQgZmFpbGVkLiI7IC8vIGNhbmNlbA0KCQkJfQ0KCQkJX2lzRG9jdW1lbnQgPSAhJC5jb250YWlucyhkb2N1bWVudCwgX29wdGlvbnMuY29udGFpbmVyLmdldCgwKSk7DQoJCQkvLyBwcmV2ZW50IGJ1YmJsaW5nIG9mIGZha2UgcmVzaXplIGV2ZW50IHRvIHdpbmRvdw0KCQkJaWYgKCFfaXNEb2N1bWVudCkgew0KCQkJCV9vcHRpb25zLmNvbnRhaW5lci5vbigncmVzaXplJywgZnVuY3Rpb24gKCBlICkgew0KICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7DQogICAgICAgIH0pOw0KCQkJfQ0KCQkJLy8gdXBkYXRlIGNvbnRhaW5lciBzaXplIGltbWVkaWF0ZWx5DQoJCQlfdmlld1BvcnRTaXplID0gX29wdGlvbnMudmVydGljYWwgPyBfb3B0aW9ucy5jb250YWluZXIuaGVpZ2h0KCkgOiBfb3B0aW9ucy5jb250YWluZXIud2lkdGgoKTsNCgkJCS8vIHNldCBldmVudCBoYW5kbGVycw0KCQkJX29wdGlvbnMuY29udGFpbmVyLm9uKCJzY3JvbGwgcmVzaXplIiwgb25DaGFuZ2UpOw0KDQoJCQlfb3B0aW9ucy5yZWZyZXNoSW50ZXJ2YWwgPSBwYXJzZUludChfb3B0aW9ucy5yZWZyZXNoSW50ZXJ2YWwpOw0KCQkJaWYgKF9vcHRpb25zLnJlZnJlc2hJbnRlcnZhbCA+IDApIHsNCgkJCQlfcmVmcmVzaEludGVydmFsID0gd2luZG93LnNldEludGVydmFsKHJlZnJlc2gsIF9vcHRpb25zLnJlZnJlc2hJbnRlcnZhbCk7DQoJCQl9DQoNCgkJCS8vIHN0YXJ0IGNoZWNraW5nIGZvciBjaGFuZ2VzDQoJCQlfdXBkYXRlQ3ljbGUgPSBhbmltYXRpb25GcmFtZUNhbGxiYWNrKHVwZGF0ZVNjZW5lcyk7DQoJCQlsb2coMywgImFkZGVkIG5ldyAiICsgTkFNRVNQQUNFICsgIiBjb250cm9sbGVyICh2IiArIFNjcm9sbE1hZ2ljLnZlcnNpb24gKyAiKSIpOw0KCQl9Ow0KDQoJCS8qKg0KCQkqIERlZmF1bHQgZnVuY3Rpb24gdG8gZ2V0IHNjcm9sbCBwb3MgLSBvdmVyd3JpdGVhYmxlIHVzaW5nIGBTY3JvbGxNYWdpYy5zY3JvbGxQb3MobmV3RnVuY3Rpb24pYA0KCQkqIEBwcml2YXRlDQoJCSovDQoJCXZhciBnZXRTY3JvbGxQb3MgPSBmdW5jdGlvbiAoKSB7DQoJCQlyZXR1cm4gX29wdGlvbnMudmVydGljYWwgPyBfb3B0aW9ucy5jb250YWluZXIuc2Nyb2xsVG9wKCkgOiBfb3B0aW9ucy5jb250YWluZXIuc2Nyb2xsTGVmdCgpOw0KCQl9Ow0KCQkvKioNCgkJKiBEZWZhdWx0IGZ1bmN0aW9uIHRvIHNldCBzY3JvbGwgcG9zIC0gb3ZlcndyaXRlYWJsZSB1c2luZyBgU2Nyb2xsTWFnaWMuc2Nyb2xsVG8obmV3RnVuY3Rpb24pYA0KCQkqIEBwcml2YXRlDQoJCSovDQoJCXZhciBzZXRTY3JvbGxQb3MgPSBmdW5jdGlvbiAocG9zKSB7DQoJCQlpZiAoX29wdGlvbnMudmVydGljYWwpIHsNCgkJCQlfb3B0aW9ucy5jb250YWluZXIuc2Nyb2xsVG9wKHBvcyk7DQoJCQl9IGVsc2Ugew0KCQkJCV9vcHRpb25zLmNvbnRhaW5lci5zY3JvbGxMZWZ0KHBvcyk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSogSGFuZGxlIHVwZGF0ZXMgaW4gY3ljbGVzIGluc3RlYWQgb2Ygb24gc2Nyb2xsIChwZXJmb3JtYW5jZSkNCgkJKiBAcHJpdmF0ZQ0KCQkqLw0KCQl2YXIgdXBkYXRlU2NlbmVzID0gZnVuY3Rpb24gKCkgew0KCQkJX3VwZGF0ZUN5Y2xlID0gYW5pbWF0aW9uRnJhbWVDYWxsYmFjayh1cGRhdGVTY2VuZXMpOw0KCQkJaWYgKF9lbmFibGVkICZhbXA7JmFtcDsgX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlKSB7DQoJCQkJdmFyDQoJCQkJCXNjZW5lc1RvVXBkYXRlID0gJC5pc0FycmF5KF91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSkgPyBfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUgOiBfc2NlbmVPYmplY3RzLnNsaWNlKDApLA0KCQkJCQlvbGRTY3JvbGxQb3MgPSBfc2Nyb2xsUG9zOw0KCQkJCS8vIHVwZGF0ZSBzY3JvbGwgcG9zICZhbXA7IGRpcmVjdGlvbg0KCQkJCV9zY3JvbGxQb3MgPSBTY3JvbGxNYWdpYy5zY3JvbGxQb3MoKTsNCgkJCQl2YXIgZGVsdGFTY3JvbGwgPSBfc2Nyb2xsUG9zIC0gb2xkU2Nyb2xsUG9zOw0KCQkJCV9zY3JvbGxEaXJlY3Rpb24gPSAoZGVsdGFTY3JvbGwgPT09IDApID8gIlBBVVNFRCIgOiAoZGVsdGFTY3JvbGwgPiAwKSA/ICJGT1JXQVJEIiA6ICJSRVZFUlNFIjsNCgkJCQlpZiAoZGVsdGFTY3JvbGwgJmx0OyAwKSB7IC8vIHJldmVyc2Ugb3JkZXIgaWYgc2Nyb2xsaW5nIHJldmVyc2UNCgkJCQkJc2NlbmVzVG9VcGRhdGUucmV2ZXJzZSgpOw0KCQkJCX0NCgkJCQkvLyB1cGRhdGUgc2NlbmVzDQoJCQkJJC5lYWNoKHNjZW5lc1RvVXBkYXRlLCBmdW5jdGlvbiAoaW5kZXgsIHNjZW5lKSB7DQoJCQkJCWxvZygzLCAidXBkYXRpbmcgU2NlbmUgIiArIChpbmRleCArIDEpICsgIi8iICsgc2NlbmVzVG9VcGRhdGUubGVuZ3RoICsgIiAoIiArIF9zY2VuZU9iamVjdHMubGVuZ3RoICsgIiB0b3RhbCkiKTsNCgkJCQkJc2NlbmUudXBkYXRlKHRydWUpOw0KCQkJCX0pOw0KCQkJCWlmIChzY2VuZXNUb1VwZGF0ZS5sZW5ndGggPT09IDAgJmFtcDsmYW1wOyBfb3B0aW9ucy5sb2dsZXZlbCA+PSAzKSB7DQoJCQkJCWxvZygzLCAidXBkYXRpbmcgMCBTY2VuZXMgKG5vdGhpbmcgYWRkZWQgdG8gY29udHJvbGxlcikiKTsNCgkJCQl9DQoJCQkJX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlID0gZmFsc2U7DQoJCQl9DQoJCX07DQoJCQ0KCQkvKioNCgkJKiBIYW5kbGVzIENvbnRhaW5lciBjaGFuZ2VzDQoJCSogQHByaXZhdGUNCgkJKi8NCgkJdmFyIG9uQ2hhbmdlID0gZnVuY3Rpb24gKGUpIHsNCgkJCWlmIChlLnR5cGUgPT0gInJlc2l6ZSIpIHsNCgkJCQlfdmlld1BvcnRTaXplID0gX29wdGlvbnMudmVydGljYWwgPyBfb3B0aW9ucy5jb250YWluZXIuaGVpZ2h0KCkgOiBfb3B0aW9ucy5jb250YWluZXIud2lkdGgoKTsNCgkJCX0NCgkJCV91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSA9IHRydWU7DQoJCX07DQoNCgkJdmFyIHJlZnJlc2ggPSBmdW5jdGlvbiAoKSB7DQoJCQlpZiAoIV9pc0RvY3VtZW50KSB7DQoJCQkJLy8gc2ltdWxhdGUgcmVzaXplIGV2ZW50LiBPbmx5IHdvcmtzIGZvciB2aWV3cG9ydCByZWxldmFudCBwYXJhbQ0KCQkJCWlmIChfdmlld1BvcnRTaXplICE9IChfb3B0aW9ucy52ZXJ0aWNhbCA/IF9vcHRpb25zLmNvbnRhaW5lci5oZWlnaHQoKSA6IF9vcHRpb25zLmNvbnRhaW5lci53aWR0aCgpKSkgew0KCQkJCQlfb3B0aW9ucy5jb250YWluZXIudHJpZ2dlcigicmVzaXplIik7DQoJCQkJfQ0KCQkJfQ0KCQkJJC5lYWNoKF9zY2VuZU9iamVjdHMsIGZ1bmN0aW9uIChpbmRleCwgc2NlbmUpIHsvLyByZWZyZXNoIGFsbCBzY2VuZXMNCgkJCQlzY2VuZS5yZWZyZXNoKCk7DQoJCQl9KTsNCgkJfTsNCg0KCQkvKioNCgkJICogU2VuZCBhIGRlYnVnIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUuDQoJCSAqIEBwcml2YXRlDQoJCSAqDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBsb2dsZXZlbCAtIFRoZSBsb2dsZXZlbCByZXF1aXJlZCB0byBpbml0aWF0ZSBvdXRwdXQgZm9yIHRoZSBtZXNzYWdlLg0KCQkgKiBAcGFyYW0gey4uLm1peGVkfSBvdXRwdXQgLSBPbmUgb3IgbW9yZSB2YXJpYWJsZXMgdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBjb25zb2xlLg0KCQkgKi8NCgkJdmFyIGxvZyA9IGZ1bmN0aW9uIChsb2dsZXZlbCwgb3V0cHV0KSB7DQoJCQlpZiAoX29wdGlvbnMubG9nbGV2ZWwgPj0gbG9nbGV2ZWwpIHsNCgkJCQl2YXINCgkJCQkJcHJlZml4ID0gIigiICsgTkFNRVNQQUNFICsgIikgLT4iLA0KCQkJCQlhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7DQoJCQkJYXJncy51bnNoaWZ0KGxvZ2xldmVsLCBwcmVmaXgpOw0KCQkJCWRlYnVnLmFwcGx5KHdpbmRvdywgYXJncyk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIFNvcnQgc2NlbmVzIGluIGFzY2VuZGluZyBvcmRlciBvZiB0aGVpciBzdGFydCBvZmZzZXQuDQoJCSAqIEBwcml2YXRlDQoJCSAqDQoJCSAqIEBwYXJhbSB7YXJyYXl9IFNjcm9sbFNjZW5lc0FycmF5IC0gYW4gYXJyYXkgb2YgU2Nyb2xsU2NlbmVzIHRoYXQgc2hvdWxkIGJlIHNvcnRlZA0KCQkgKiBAcmV0dXJuIHthcnJheX0gVGhlIHNvcnRlZCBhcnJheSBvZiBTY3JvbGxTY2VuZXMuDQoJCSAqLw0KCQl2YXIgc29ydFNjZW5lcyA9IGZ1bmN0aW9uIChTY3JvbGxTY2VuZXNBcnJheSkgew0KCQkJaWYgKFNjcm9sbFNjZW5lc0FycmF5Lmxlbmd0aCAmbHQ7PSAxKSB7DQoJCQkJcmV0dXJuIFNjcm9sbFNjZW5lc0FycmF5Ow0KCQkJfSBlbHNlIHsNCgkJCQl2YXIgc2NlbmVzID0gU2Nyb2xsU2NlbmVzQXJyYXkuc2xpY2UoMCk7DQoJCQkJc2NlbmVzLnNvcnQoZnVuY3Rpb24oYSwgYikgew0KCQkJCQlyZXR1cm4gYS5zY3JvbGxPZmZzZXQoKSA+IGIuc2Nyb2xsT2Zmc2V0KCkgPyAxIDogLTE7DQoJCQkJfSk7DQoJCQkJcmV0dXJuIHNjZW5lczsNCgkJCX0NCgkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHB1YmxpYyBmdW5jdGlvbnMNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQkvKioNCgkJICogQWRkIG9uZSBvcmUgbW9yZSBzY2VuZShzKSB0byB0aGUgY29udHJvbGxlci4gIA0KCQkgKiBUaGlzIGlzIHRoZSBlcXVpdmFsZW50IHRvIGBTY3JvbGxTY2VuZS5hZGRUbyhjb250cm9sbGVyKWAuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gd2l0aCBhIHByZXZpb3VzbHkgZGVmaW5lZCBzY2VuZQ0KCQkgKiBjb250cm9sbGVyLmFkZFNjZW5lKHNjZW5lKTsNCgkJICoNCgkgCSAqIC8vIHdpdGggYSBuZXdseSBjcmVhdGVkIHNjZW5lLg0KCQkgKiBjb250cm9sbGVyLmFkZFNjZW5lKG5ldyBTY3JvbGxTY2VuZSh7ZHVyYXRpb24gOiAwfSkpOw0KCQkgKg0KCSAJICogLy8gYWRkaW5nIG11bHRpcGxlIHNjZW5lcw0KCQkgKiBjb250cm9sbGVyLmFkZFNjZW5lKFtzY2VuZSwgc2NlbmUyLCBuZXcgU2Nyb2xsU2NlbmUoe2R1cmF0aW9uIDogMH0pXSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7KFNjcm9sbFNjZW5lfGFycmF5KX0gU2Nyb2xsU2NlbmUgLSBTY3JvbGxTY2VuZSBvciBBcnJheSBvZiBTY3JvbGxTY2VuZXMgdG8gYmUgYWRkZWQgdG8gdGhlIGNvbnRyb2xsZXIuDQoJCSAqIEByZXR1cm4ge1Njcm9sbE1hZ2ljfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuYWRkU2NlbmUgPSBmdW5jdGlvbiAobmV3U2NlbmUpIHsNCgkJCWlmICgkLmlzQXJyYXkobmV3U2NlbmUpKSB7DQoJCQkJJC5lYWNoKG5ld1NjZW5lLCBmdW5jdGlvbiAoaW5kZXgsIHNjZW5lKSB7DQoJCQkJCVNjcm9sbE1hZ2ljLmFkZFNjZW5lKHNjZW5lKTsNCgkJCQl9KTsNCgkJCX0gZWxzZSBpZiAobmV3U2NlbmUgaW5zdGFuY2VvZiBTY3JvbGxTY2VuZSkgew0KCQkJCWlmIChuZXdTY2VuZS5wYXJlbnQoKSAhPSBTY3JvbGxNYWdpYykgew0KCQkJCQluZXdTY2VuZS5hZGRUbyhTY3JvbGxNYWdpYyk7DQoJCQkJfSBlbHNlIGlmICgkLmluQXJyYXkobmV3U2NlbmUsIF9zY2VuZU9iamVjdHMpICZsdDsgMCl7DQoJCQkJCS8vIG5ldyBzY2VuZQ0KCQkJCQlfc2NlbmVPYmplY3RzLnB1c2gobmV3U2NlbmUpOyAvLyBhZGQgdG8gYXJyYXkNCgkJCQkJX3NjZW5lT2JqZWN0cyA9IHNvcnRTY2VuZXMoX3NjZW5lT2JqZWN0cyk7IC8vIHNvcnQNCgkJCQkJbmV3U2NlbmUub24oInNoaWZ0LiIgKyBOQU1FU1BBQ0UgKyAiX3NvcnQiLCBmdW5jdGlvbigpIHsgLy8gcmVzb3J0IHdoZW5ldmVyIHNjZW5lIG1vdmVzDQoJCQkJCQlfc2NlbmVPYmplY3RzID0gc29ydFNjZW5lcyhfc2NlbmVPYmplY3RzKTsNCgkJCQkJfSk7DQoJCQkJCS8vIGluc2VydCBHbG9iYWwgZGVmYXVsdHMuDQoJCQkJCSQuZWFjaChfb3B0aW9ucy5nbG9iYWxTY2VuZU9wdGlvbnMsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7DQoJCQkJCQlpZiAobmV3U2NlbmVba2V5XSkgew0KCQkJCQkJCW5ld1NjZW5lW2tleV0uY2FsbChuZXdTY2VuZSwgdmFsdWUpOw0KCQkJCQkJfQ0KCQkJCQl9KTsNCgkJCQkJbG9nKDMsICJhZGRlZCBTY2VuZSAoIiArIF9zY2VuZU9iamVjdHMubGVuZ3RoICsgIiB0b3RhbCkiKTsNCgkJCQl9DQoJCQl9IGVsc2Ugew0KCQkJCWxvZygxLCAiRVJST1I6IGludmFsaWQgYXJndW1lbnQgc3VwcGxpZWQgZm9yICcuYWRkU2NlbmUoKSciKTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxNYWdpYzsNCgkJfTsNCg0KCQkvKioNCgkJICogUmVtb3ZlIG9uZSBvcmUgbW9yZSBzY2VuZShzKSBmcm9tIHRoZSBjb250cm9sbGVyLiAgDQoJCSAqIFRoaXMgaXMgdGhlIGVxdWl2YWxlbnQgdG8gYFNjcm9sbFNjZW5lLnJlbW92ZSgpYC4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZW1vdmUgYSBzY2VuZSBmcm9tIHRoZSBjb250cm9sbGVyDQoJCSAqIGNvbnRyb2xsZXIucmVtb3ZlU2NlbmUoc2NlbmUpOw0KCQkgKg0KCQkgKiAvLyByZW1vdmUgbXVsdGlwbGUgc2NlbmVzIGZyb20gdGhlIGNvbnRyb2xsZXINCgkJICogY29udHJvbGxlci5yZW1vdmVTY2VuZShbc2NlbmUsIHNjZW5lMiwgc2NlbmUzXSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7KFNjcm9sbFNjZW5lfGFycmF5KX0gU2Nyb2xsU2NlbmUgLSBTY3JvbGxTY2VuZSBvciBBcnJheSBvZiBTY3JvbGxTY2VuZXMgdG8gYmUgcmVtb3ZlZCBmcm9tIHRoZSBjb250cm9sbGVyLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsTWFnaWN9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZW1vdmVTY2VuZSA9IGZ1bmN0aW9uIChTY3JvbGxTY2VuZSkgew0KCQkJaWYgKCQuaXNBcnJheShTY3JvbGxTY2VuZSkpIHsNCgkJCQkkLmVhY2goU2Nyb2xsU2NlbmUsIGZ1bmN0aW9uIChpbmRleCwgc2NlbmUpIHsNCgkJCQkJU2Nyb2xsTWFnaWMucmVtb3ZlU2NlbmUoc2NlbmUpOw0KCQkJCX0pOw0KCQkJfSBlbHNlIHsNCgkJCQl2YXIgaW5kZXggPSAkLmluQXJyYXkoU2Nyb2xsU2NlbmUsIF9zY2VuZU9iamVjdHMpOw0KCQkJCWlmIChpbmRleCA+IC0xKSB7DQoJCQkJCVNjcm9sbFNjZW5lLm9mZigic2hpZnQuIiArIE5BTUVTUEFDRSArICJfc29ydCIpOw0KCQkJCQlfc2NlbmVPYmplY3RzLnNwbGljZShpbmRleCwgMSk7DQoJCQkJCVNjcm9sbFNjZW5lLnJlbW92ZSgpOw0KCQkJCQlsb2coMywgInJlbW92ZWQgU2NlbmUgKCIgKyBfc2NlbmVPYmplY3RzLmxlbmd0aCArICIgdG90YWwpIik7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGUgb25lIG9yZSBtb3JlIHNjZW5lKHMpIGFjY29yZGluZyB0byB0aGUgc2Nyb2xsIHBvc2l0aW9uIG9mIHRoZSBjb250YWluZXIuICANCgkJICogVGhpcyBpcyB0aGUgZXF1aXZhbGVudCB0byBgU2Nyb2xsU2NlbmUudXBkYXRlKClgLiAgDQoJCSAqIFRoZSB1cGRhdGUgbWV0aG9kIGNhbGN1bGF0ZXMgdGhlIHNjZW5lJ3Mgc3RhcnQgYW5kIGVuZCBwb3NpdGlvbiAoYmFzZWQgb24gdGhlIHRyaWdnZXIgZWxlbWVudCwgdHJpZ2dlciBob29rLCBkdXJhdGlvbiBhbmQgb2Zmc2V0KSBhbmQgY2hlY2tzIGl0IGFnYWluc3QgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIG9mIHRoZSBjb250YWluZXIuICANCgkJICogSXQgdGhlbiB1cGRhdGVzIHRoZSBjdXJyZW50IHNjZW5lIHN0YXRlIGFjY29yZGluZ2x5IChvciBkb2VzIG5vdGhpbmcsIGlmIHRoZSBzdGF0ZSBpcyBhbHJlYWR5IGNvcnJlY3QpIOKAkyBQaW5zIHdpbGwgYmUgc2V0IHRvIHRoZWlyIGNvcnJlY3QgcG9zaXRpb24gYW5kIHR3ZWVucyB3aWxsIGJlIHVwZGF0ZWQgdG8gdGhlaXIgY29ycmVjdCBwcm9ncmVzcy4gIA0KCQkgKiBfKipOb3RlOioqIFRoaXMgbWV0aG9kIGdldHMgY2FsbGVkIGNvbnN0YW50bHkgd2hlbmV2ZXIgU2Nyb2xsTWFnaWMgZGV0ZWN0cyBhIGNoYW5nZS4gVGhlIG9ubHkgYXBwbGljYXRpb24gZm9yIHlvdSBpcyBpZiB5b3UgY2hhbmdlIHNvbWV0aGluZyBvdXRzaWRlIG9mIHRoZSByZWFsbSBvZiBTY3JvbGxNYWdpYywgbGlrZSBtb3ZpbmcgdGhlIHRyaWdnZXIgb3IgY2hhbmdpbmcgdHdlZW4gcGFyYW1ldGVycy5fDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gdXBkYXRlIGEgc3BlY2lmaWMgc2NlbmUgb24gbmV4dCBjeWNsZQ0KCSAJICogY29udHJvbGxlci51cGRhdGVTY2VuZShzY2VuZSk7DQoJIAkgKg0KCQkgKiAvLyB1cGRhdGUgYSBzcGVjaWZpYyBzY2VuZSBpbW1lZGlhdGVseQ0KCQkgKiBjb250cm9sbGVyLnVwZGF0ZVNjZW5lKHNjZW5lLCB0cnVlKTsNCgkgCSAqDQoJCSAqIC8vIHVwZGF0ZSBtdWx0aXBsZSBzY2VuZXMgc2NlbmUgb24gbmV4dCBjeWNsZQ0KCQkgKiBjb250cm9sbGVyLnVwZGF0ZVNjZW5lKFtzY2VuZTEsIHNjZW5lMiwgc2NlbmUzXSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7U2Nyb2xsU2NlbmV9IFNjcm9sbFNjZW5lIC0gU2Nyb2xsU2NlbmUgb3IgQXJyYXkgb2YgU2Nyb2xsU2NlbmVzIHRoYXQgaXMvYXJlIHN1cHBvc2VkIHRvIGJlIHVwZGF0ZWQuDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ltbWVkaWF0ZWx5PWZhbHNlXSAtIElmIGB0cnVlYCB0aGUgdXBkYXRlIHdpbGwgYmUgaW5zdGFudCwgaWYgYGZhbHNlYCBpdCB3aWxsIHdhaXQgdW50aWwgbmV4dCB1cGRhdGUgY3ljbGUuICANCgkJIAkJCQkJCQkJCQkgIFRoaXMgaXMgdXNlZnVsIHdoZW4gY2hhbmdpbmcgbXVsdGlwbGUgcHJvcGVydGllcyBvZiB0aGUgc2NlbmUgLSB0aGlzIHdheSBpdCB3aWxsIG9ubHkgYmUgdXBkYXRlZCBvbmNlIGFsbCBuZXcgcHJvcGVydGllcyBhcmUgc2V0ICh1cGRhdGVTY2VuZXMpLg0KCQkgKiBAcmV0dXJuIHtTY3JvbGxNYWdpY30gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnVwZGF0ZVNjZW5lID0gZnVuY3Rpb24gKFNjcm9sbFNjZW5lLCBpbW1lZGlhdGVseSkgew0KCQkJaWYgKCQuaXNBcnJheShTY3JvbGxTY2VuZSkpIHsNCgkJCQkkLmVhY2goU2Nyb2xsU2NlbmUsIGZ1bmN0aW9uIChpbmRleCwgc2NlbmUpIHsNCgkJCQkJU2Nyb2xsTWFnaWMudXBkYXRlU2NlbmUoc2NlbmUsIGltbWVkaWF0ZWx5KTsNCgkJCQl9KTsNCgkJCX0gZWxzZSB7DQoJCQkJaWYgKGltbWVkaWF0ZWx5KSB7DQoJCQkJCVNjcm9sbFNjZW5lLnVwZGF0ZSh0cnVlKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQkvLyBwcmVwIGFycmF5IGZvciBuZXh0IHVwZGF0ZSBjeWNsZQ0KCQkJCQlpZiAoISQuaXNBcnJheShfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUpKSB7DQoJCQkJCQlfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUgPSBbXTsNCgkJCQkJfQ0KCQkJCQlpZiAoJC5pbkFycmF5KFNjcm9sbFNjZW5lLCBfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUpID09IC0xKSB7DQoJCQkJCQlfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUucHVzaChTY3JvbGxTY2VuZSk7CQ0KCQkJCQl9DQoJCQkJCV91cGRhdGVTY2VuZXNPbk5leHRDeWNsZSA9IHNvcnRTY2VuZXMoX3VwZGF0ZVNjZW5lc09uTmV4dEN5Y2xlKTsgLy8gc29ydA0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBTY3JvbGxNYWdpYzsNCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlcyB0aGUgY29udHJvbGxlciBwYXJhbXMgYW5kIGNhbGxzIHVwZGF0ZVNjZW5lIG9uIGV2ZXJ5IHNjZW5lLCB0aGF0IGlzIGF0dGFjaGVkIHRvIHRoZSBjb250cm9sbGVyLiAgDQoJCSAqIFNlZSBgU2Nyb2xsTWFnaWMudXBkYXRlU2NlbmUoKWAgZm9yIG1vcmUgaW5mb3JtYXRpb24gYWJvdXQgd2hhdCB0aGlzIG1lYW5zLiAgDQoJCSAqIEluIG1vc3QgY2FzZXMgeW91IHdpbGwgbm90IG5lZWQgdGhpcyBmdW5jdGlvbiwgYXMgaXQgaXMgY2FsbGVkIGNvbnN0YW50bHksIHdoZW5ldmVyIFNjcm9sbE1hZ2ljIGRldGVjdHMgYSBzdGF0ZSBjaGFuZ2UgZXZlbnQsIGxpa2UgcmVzaXplIG9yIHNjcm9sbC4gIA0KCQkgKiBUaGUgb25seSBhcHBsaWNhdGlvbiBmb3IgdGhpcyBtZXRob2QgaXMgd2hlbiBTY3JvbGxNYWdpYyBmYWlscyB0byBkZXRlY3QgdGhlc2UgZXZlbnRzLiAgDQoJCSAqIE9uZSBhcHBsaWNhdGlvbiBpcyB3aXRoIHNvbWUgZXh0ZXJuYWwgc2Nyb2xsIGxpYnJhcmllcyAobGlrZSBpU2Nyb2xsKSB0aGF0IG1vdmUgYW4gaW50ZXJuYWwgY29udGFpbmVyIHRvIGEgbmVnYXRpdmUgb2Zmc2V0IGluc3RlYWQgb2YgYWN0dWFsbHkgc2Nyb2xsaW5nLiBJbiB0aGlzIGNhc2UgdGhlIHVwZGF0ZSBvbiB0aGUgY29udHJvbGxlciBuZWVkcyB0byBiZSBjYWxsZWQgd2hlbmV2ZXIgdGhlIGNoaWxkIGNvbnRhaW5lcidzIHBvc2l0aW9uIGNoYW5nZXMuDQoJCSAqIEZvciB0aGlzIGNhc2UgdGhlcmUgd2lsbCBhbHNvIGJlIHRoZSBuZWVkIHRvIHByb3ZpZGUgYSBjdXN0b20gZnVuY3Rpb24gdG8gY2FsY3VsYXRlIHRoZSBjb3JyZWN0IHNjcm9sbCBwb3NpdGlvbi4gU2VlIGBTY3JvbGxNYWdpYy5zY3JvbGxQb3MoKWAgZm9yIGRldGFpbHMuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gdXBkYXRlIHRoZSBjb250cm9sbGVyIG9uIG5leHQgY3ljbGUgKHNhdmVzIHBlcmZvcm1hbmNlIGR1ZSB0byBlbGltaW5hdGlvbiBvZiByZWR1bmRhbnQgdXBkYXRlcykNCgkJICogY29udHJvbGxlci51cGRhdGUoKTsNCgkJICoNCgkgCSAqIC8vIHVwZGF0ZSB0aGUgY29udHJvbGxlciBpbW1lZGlhdGVseQ0KCQkgKiBjb250cm9sbGVyLnVwZGF0ZSh0cnVlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbaW1tZWRpYXRlbHk9ZmFsc2VdIC0gSWYgYHRydWVgIHRoZSB1cGRhdGUgd2lsbCBiZSBpbnN0YW50LCBpZiBgZmFsc2VgIGl0IHdpbGwgd2FpdCB1bnRpbCBuZXh0IHVwZGF0ZSBjeWNsZSAoYmV0dGVyIHBlcmZvcm1hbmNlKQ0KCQkgKiBAcmV0dXJuIHtTY3JvbGxNYWdpY30gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnVwZGF0ZSA9IGZ1bmN0aW9uIChpbW1lZGlhdGVseSkgew0KCQkJb25DaGFuZ2Uoe3R5cGU6ICJyZXNpemUifSk7IC8vIHdpbGwgdXBkYXRlIHNpemUgYW5kIHNldCBfdXBkYXRlU2NlbmVzT25OZXh0Q3ljbGUgdG8gdHJ1ZQ0KCQkJaWYgKGltbWVkaWF0ZWx5KSB7DQoJCQkJdXBkYXRlU2NlbmVzKCk7DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFNjcm9sbCB0byBhIG51bWVyaWMgc2Nyb2xsIG9mZnNldCwgYSBET00gZWxlbWVudCwgdGhlIHN0YXJ0IG9mIGEgc2NlbmUgb3IgcHJvdmlkZSBhbiBhbHRlcm5hdGUgbWV0aG9kIGZvciBzY3JvbGxpbmcuICANCgkJICogRm9yIHZlcnRpY2FsIGNvbnRyb2xsZXJzIGl0IHdpbGwgY2hhbmdlIHRoZSB0b3Agc2Nyb2xsIG9mZnNldCBhbmQgZm9yIGhvcml6b250YWwgYXBwbGljYXRpb25zIGl0IHdpbGwgY2hhbmdlIHRoZSBsZWZ0IG9mZnNldC4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAc2luY2UgMS4xLjANCgkJICogQGV4YW1wbGUNCgkJICogLy8gc2Nyb2xsIHRvIGFuIG9mZnNldCBvZiAxMDANCgkJICogY29udHJvbGxlci5zY3JvbGxUbygxMDApOw0KCQkgKg0KCQkgKiAvLyBzY3JvbGwgdG8gYSBET00gZWxlbWVudA0KCQkgKiBjb250cm9sbGVyLnNjcm9sbFRvKCIjYW5jaG9yIik7DQoJCSAqDQoJCSAqIC8vIHNjcm9sbCB0byB0aGUgYmVnaW5uaW5nIG9mIGEgc2NlbmUNCgkJICogdmFyIHNjZW5lID0gbmV3IFNjcm9sbFNjZW5lKHtvZmZzZXQ6IDIwMH0pOw0KCQkgKiBjb250cm9sbGVyLnNjcm9sbFRvKHNjZW5lKTsNCgkJICoNCgkgCSAqIC8vIGRlZmluZSBhIG5ldyBzY3JvbGwgcG9zaXRpb24gbW9kaWZpY2F0aW9uIGZ1bmN0aW9uIChhbmltYXRlIGluc3RlYWQgb2YganVtcCkNCgkJICogY29udHJvbGxlci5zY3JvbGxUbyhmdW5jdGlvbiAobmV3U2Nyb2xsUG9zKSB7DQoJCSAqCSQoImJvZHkiKS5hbmltYXRlKHtzY3JvbGxUb3A6IG5ld1Njcm9sbFBvc30pOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHBhcmFtIHttaXhlZH0gW3Njcm9sbFRhcmdldF0gLSBUaGUgc3VwcGxpZWQgYXJndW1lbnQgY2FuIGJlIG9uZSBvZiB0aGVzZSB0eXBlczoNCgkJICogMS4gYG51bWJlcmAgLT4gVGhlIGNvbnRhaW5lciB3aWxsIHNjcm9sbCB0byB0aGlzIG5ldyBzY3JvbGwgb2Zmc2V0Lg0KCQkgKiAyLiBgc3RyaW5nYCBvciBgb2JqZWN0YCAtPiBDYW4gYmUgYSBzZWxlY3RvciwgYSBET00gb2JqZWN0IG9yIGEgalF1ZXJ5IGVsZW1lbnQuICANCgkJICogIFRoZSBjb250YWluZXIgd2lsbCBzY3JvbGwgdG8gdGhlIHBvc2l0aW9uIG9mIHRoaXMgZWxlbWVudC4NCgkJICogMy4gYFNjcm9sbFNjZW5lYCAtPiBUaGUgY29udGFpbmVyIHdpbGwgc2Nyb2xsIHRvIHRoZSBzdGFydCBvZiB0aGlzIHNjZW5lLg0KCQkgKiA0LiBgZnVuY3Rpb25gIC0+IFRoaXMgZnVuY3Rpb24gd2lsbCBiZSB1c2VkIGFzIGEgY2FsbGJhY2sgZm9yIGZ1dHVyZSBzY3JvbGwgcG9zaXRpb24gbW9kaWZpY2F0aW9ucy4gIA0KCQkgKiAgVGhpcyBwcm92aWRlcyBhIHdheSBmb3IgeW91IHRvIGNoYW5nZSB0aGUgYmVoYXZpb3VyIG9mIHNjcm9sbGluZyBhbmQgYWRkaW5nIG5ldyBiZWhhdmlvdXIgbGlrZSBhbmltYXRpb24uIFRoZSBjYWxsYmFjayByZWNlaXZlcyB0aGUgbmV3IHNjcm9sbCBwb3NpdGlvbiBhcyBhIHBhcmFtZXRlciBhbmQgYSByZWZlcmVuY2UgdG8gdGhlIGNvbnRhaW5lciBlbGVtZW50IHVzaW5nIGB0aGlzYC4gIA0KCQkgKiAgXyoqTk9URToqKiBBbGwgb3RoZXIgb3B0aW9ucyB3aWxsIHN0aWxsIHdvcmsgYXMgZXhwZWN0ZWQsIHVzaW5nIHRoZSBuZXcgZnVuY3Rpb24gdG8gc2Nyb2xsLl8NCgkJICogQHJldHVybnMge1Njcm9sbE1hZ2ljfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuc2Nyb2xsVG8gPSBmdW5jdGlvbiAoc2Nyb2xsVGFyZ2V0KSB7DQoJCQlpZiAoc2Nyb2xsVGFyZ2V0IGluc3RhbmNlb2YgU2Nyb2xsU2NlbmUpIHsNCgkJCQlpZiAoc2Nyb2xsVGFyZ2V0LnBhcmVudCgpID09PSBTY3JvbGxNYWdpYykgeyAvLyBjaGVjayBpZiB0aGlzIGNvbnRyb2xsZXIgaXMgdGhlIHBhcmVudA0KCQkJCQlTY3JvbGxNYWdpYy5zY3JvbGxUbyhzY3JvbGxUYXJnZXQuc2Nyb2xsT2Zmc2V0KCkpOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWxvZyAoMiwgInNjcm9sbFRvKCk6IFRoZSBzdXBwbGllZCBzY2VuZSBkb2VzIG5vdCBiZWxvbmcgdG8gdGhpcyBjb250cm9sbGVyLiBTY3JvbGwgY2FuY2VsbGVkLiIsIHNjcm9sbFRhcmdldCk7DQoJCQkJfQ0KCQkJfSBlbHNlIGlmICgkLnR5cGUoc2Nyb2xsVGFyZ2V0KSA9PT0gInN0cmluZyIgfHwgaXNEb21FbGVtZW50KHNjcm9sbFRhcmdldCkgfHwgc2Nyb2xsVGFyZ2V0IGluc3RhbmNlb2YgJCkgew0KCQkJCXZhciAkZWxtID0gJChzY3JvbGxUYXJnZXQpLmZpcnN0KCk7DQoJCQkJaWYgKCRlbG1bMF0pIHsNCgkJCQkJdmFyDQoJCQkJCQlwYXJhbSA9IF9vcHRpb25zLnZlcnRpY2FsID8gInRvcCIgOiAibGVmdCIsIC8vIHdoaWNoIHBhcmFtIGlzIG9mIGludGVyZXN0ID8NCgkJCQkJCWNvbnRhaW5lck9mZnNldCA9IGdldE9mZnNldChfb3B0aW9ucy5jb250YWluZXIpLCAvLyBjb250YWluZXIgcG9zaXRpb24gaXMgbmVlZGVkIGJlY2F1c2UgZWxlbWVudCBvZmZzZXQgaXMgcmV0dXJuZWQgaW4gcmVsYXRpb24gdG8gZG9jdW1lbnQsIG5vdCBpbiByZWxhdGlvbiB0byBjb250YWluZXIuDQoJCQkJCQllbGVtZW50T2Zmc2V0ID0gZ2V0T2Zmc2V0KCRlbG0pOw0KDQoJCQkJCWlmICghX2lzRG9jdW1lbnQpIHsgLy8gY29udGFpbmVyIGlzIG5vdCB0aGUgZG9jdW1lbnQgcm9vdCwgc28gc3Vic3RyYWN0IHNjcm9sbCBQb3NpdGlvbiB0byBnZXQgY29ycmVjdCB0cmlnZ2VyIGVsZW1lbnQgcG9zaXRpb24gcmVsYXRpdmUgdG8gc2Nyb2xsY29udGVudA0KCQkJCQkJY29udGFpbmVyT2Zmc2V0W3BhcmFtXSAtPSBTY3JvbGxNYWdpYy5zY3JvbGxQb3MoKTsNCgkJCQkJfQ0KDQoJCQkJCVNjcm9sbE1hZ2ljLnNjcm9sbFRvKGVsZW1lbnRPZmZzZXRbcGFyYW1dIC0gY29udGFpbmVyT2Zmc2V0W3BhcmFtXSk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJbG9nICgyLCAic2Nyb2xsVG8oKTogVGhlIHN1cHBsaWVkIGVsZW1lbnQgY291bGQgbm90IGJlIGZvdW5kLiBTY3JvbGwgY2FuY2VsbGVkLiIsIHNjcm9sbFRhcmdldCk7DQoJCQkJfQ0KCQkJfSBlbHNlIGlmICgkLmlzRnVuY3Rpb24oc2Nyb2xsVGFyZ2V0KSkgew0KCQkJCXNldFNjcm9sbFBvcyA9IHNjcm9sbFRhcmdldDsNCgkJCX0gZWxzZSB7DQoJCQkJc2V0U2Nyb2xsUG9zLmNhbGwoX29wdGlvbnMuY29udGFpbmVyWzBdLCBzY3JvbGxUYXJnZXQpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIHRoZSBjdXJyZW50IHNjcm9sbFBvc2l0aW9uIG9yICoqU2V0KiogYSBuZXcgbWV0aG9kIHRvIGNhbGN1bGF0ZSBpdC4gIA0KCQkgKiAtPiAqKkdFVCoqOg0KCQkgKiBXaGVuIHVzZWQgYXMgYSBnZXR0ZXIgdGhpcyBmdW5jdGlvbiB3aWxsIHJldHVybiB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24uICANCgkJICogVG8gZ2V0IGEgY2FjaGVkIHZhbHVlIHVzZSBTY3JvbGxNYWdpYy5pbmZvKCJzY3JvbGxQb3MiKSwgd2hpY2ggd2lsbCBiZSB1cGRhdGVkIGluIHRoZSB1cGRhdGUgY3ljbGUuICANCgkJICogRm9yIHZlcnRpY2FsIGNvbnRyb2xsZXJzIGl0IHdpbGwgcmV0dXJuIHRoZSB0b3Agc2Nyb2xsIG9mZnNldCBhbmQgZm9yIGhvcml6b250YWwgYXBwbGljYXRpb25zIGl0IHdpbGwgcmV0dXJuIHRoZSBsZWZ0IG9mZnNldC4NCgkJICoNCgkJICogLT4gKipTRVQqKjoNCgkJICogV2hlbiB1c2VkIGFzIGEgc2V0dGVyIHRoaXMgbWV0aG9kIHByb2RlcyBhIHdheSB0byBwZXJtYW5lbnRseSBvdmVyd3JpdGUgdGhlIGNvbnRyb2xsZXIncyBzY3JvbGwgcG9zaXRpb24gY2FsY3VsYXRpb24uICANCgkJICogQSB0eXBpY2FsIHVzZWNhc2UgaXMgd2hlbiB0aGUgc2Nyb2xsIHBvc2l0aW9uIGlzIG5vdCByZWZsZWN0ZWQgYnkgdGhlIGNvbnRhaW5lcnMgc2Nyb2xsVG9wIG9yIHNjcm9sbExlZnQgdmFsdWVzLCBidXQgZm9yIGV4YW1wbGUgYnkgdGhlIGlubmVyIG9mZnNldCBvZiBhIGNoaWxkIGNvbnRhaW5lci4gIA0KCQkgKiBNb3ZpbmcgYSBjaGlsZCBjb250YWluZXIgaW5zaWRlIGEgcGFyZW50IGlzIGEgY29tbW9ubHkgdXNlZCBtZXRob2QgZm9yIHNldmVyYWwgc2Nyb2xsaW5nIGZyYW1ld29ya3MsIGluY2x1ZGluZyBpU2Nyb2xsLiAgDQoJCSAqIEJ5IHByb3ZpZGluZyBhbiBhbHRlcm5hdGUgY2FsY3VsYXRpb24gZnVuY3Rpb24geW91IGNhbiBtYWtlIHN1cmUgU2Nyb2xsTWFnaWMgcmVjZWl2ZXMgdGhlIGNvcnJlY3Qgc2Nyb2xsIHBvc2l0aW9uLiAgDQoJCSAqIFBsZWFzZSBhbHNvIGJlYXIgaW4gbWluZCB0aGF0IHlvdXIgZnVuY3Rpb24gc2hvdWxkIHJldHVybiB5IHZhbHVlcyBmb3IgdmVydGljYWwgc2Nyb2xscyBhbiB4IGZvciBob3Jpem9udGFscy4NCgkJICoNCgkJICogVG8gY2hhbmdlIHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbiBwbGVhc2UgdXNlIGBTY3JvbGxNYWdpYy5zY3JvbGxUbygpYC4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgc2Nyb2xsIFBvc2l0aW9uDQoJCSAqIHZhciBzY3JvbGxQb3MgPSBjb250cm9sbGVyLnNjcm9sbFBvcygpOw0KCQkgKg0KCSAJICogLy8gc2V0IGEgbmV3IHNjcm9sbCBwb3NpdGlvbiBjYWxjdWxhdGlvbiBtZXRob2QNCgkJICogY29udHJvbGxlci5zY3JvbGxQb3MoZnVuY3Rpb24gKCkgew0KCQkgKglyZXR1cm4gdGhpcy5pbmZvKCJ2ZXJ0aWNhbCIpID8gLSRteWNoaWxkY29udGFpbmVyLnkgOiAtJG15Y2hpbGRjb250YWluZXIueA0KCQkgKiB9KTsNCgkJICoNCgkJICogQHBhcmFtIHtmdW5jdGlvbn0gW3Njcm9sbFBvc01ldGhvZF0gLSBUaGUgZnVuY3Rpb24gdG8gYmUgdXNlZCBmb3IgdGhlIHNjcm9sbCBwb3NpdGlvbiBjYWxjdWxhdGlvbiBvZiB0aGUgY29udGFpbmVyLg0KCQkgKiBAcmV0dXJucyB7KG51bWJlcnxTY3JvbGxNYWdpYyl9IEN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIG9yIHBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5zY3JvbGxQb3MgPSBmdW5jdGlvbiAoc2Nyb2xsUG9zTWV0aG9kKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIGdldFNjcm9sbFBvcy5jYWxsKFNjcm9sbE1hZ2ljKTsNCgkJCX0gZWxzZSB7IC8vIHNldA0KCQkJCWlmICgkLmlzRnVuY3Rpb24oc2Nyb2xsUG9zTWV0aG9kKSkgew0KCQkJCQlnZXRTY3JvbGxQb3MgPSBzY3JvbGxQb3NNZXRob2Q7DQoJCQkJfSBlbHNlIHsNCgkJCQkJbG9nKDIsICJQcm92aWRlZCB2YWx1ZSBmb3IgbWV0aG9kICdzY3JvbGxQb3MnIGlzIG5vdCBhIGZ1bmN0aW9uLiBUbyBjaGFuZ2UgdGhlIGN1cnJlbnQgc2Nyb2xsIHBvc2l0aW9uIHVzZSAnc2Nyb2xsVG8oKScuIik7DQoJCQkJfQ0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIGFsbCBpbmZvcyBvciBvbmUgaW4gcGFydGljdWxhciBhYm91dCB0aGUgY29udHJvbGxlci4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZXR1cm5zIHRoZSBjdXJyZW50IHNjcm9sbCBwb3NpdGlvbiAobnVtYmVyKQ0KCQkgKiB2YXIgc2Nyb2xsUG9zID0gY29udHJvbGxlci5pbmZvKCJzY3JvbGxQb3MiKTsNCgkJICoNCgkJICogLy8gcmV0dXJucyBhbGwgaW5mb3MgYXMgYW4gb2JqZWN0DQoJCSAqIHZhciBpbmZvcyA9IGNvbnRyb2xsZXIuaW5mbygpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge3N0cmluZ30gW2Fib3V0XSAtIElmIHBhc3NlZCBvbmx5IHRoaXMgaW5mbyB3aWxsIGJlIHJldHVybmVkIGluc3RlYWQgb2YgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsLiAgDQoJCSAJCQkJCQkJIFZhbGlkIG9wdGlvbnMgYXJlOg0KCQkgCQkJCQkJCSAqKiBgInNpemUiYCA9PiB0aGUgY3VycmVudCB2aWV3cG9ydCBzaXplIG9mIHRoZSBjb250YWluZXINCgkJIAkJCQkJCQkgKiogYCJ2ZXJ0aWNhbCJgID0+IHRydWUgaWYgdmVydGljYWwgc2Nyb2xsaW5nLCBvdGhlcndpc2UgZmFsc2UNCgkJIAkJCQkJCQkgKiogYCJzY3JvbGxQb3MiYCA9PiB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24NCgkJIAkJCQkJCQkgKiogYCJzY3JvbGxEaXJlY3Rpb24iYCA9PiB0aGUgbGFzdCBrbm93biBkaXJlY3Rpb24gb2YgdGhlIHNjcm9sbA0KCQkgCQkJCQkJCSAqKiBgImNvbnRhaW5lciJgID0+IHRoZSBjb250YWluZXIgZWxlbWVudA0KCQkgCQkJCQkJCSAqKiBgImlzRG9jdW1lbnQiYCA9PiB0cnVlIGlmIGNvbnRhaW5lciBlbGVtZW50IGlzIHRoZSBkb2N1bWVudC4NCgkJICogQHJldHVybnMgeyhtaXhlZHxvYmplY3QpfSBUaGUgcmVxdWVzdGVkIGluZm8ocykuDQoJCSAqLw0KCQl0aGlzLmluZm8gPSBmdW5jdGlvbiAoYWJvdXQpIHsNCgkJCXZhciB2YWx1ZXMgPSB7DQoJCQkJc2l6ZTogX3ZpZXdQb3J0U2l6ZSwgLy8gY29udGFpbnMgaGVpZ2h0IG9yIHdpZHRoIChpbiByZWdhcmQgdG8gb3JpZW50YXRpb24pOw0KCQkJCXZlcnRpY2FsOiBfb3B0aW9ucy52ZXJ0aWNhbCwNCgkJCQlzY3JvbGxQb3M6IF9zY3JvbGxQb3MsDQoJCQkJc2Nyb2xsRGlyZWN0aW9uOiBfc2Nyb2xsRGlyZWN0aW9uLA0KCQkJCWNvbnRhaW5lcjogX29wdGlvbnMuY29udGFpbmVyLA0KCQkJCWlzRG9jdW1lbnQ6IF9pc0RvY3VtZW50DQoJCQl9Ow0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldCBhbGwgYXMgYW4gb2JqZWN0DQoJCQkJcmV0dXJuIHZhbHVlczsNCgkJCX0gZWxzZSBpZiAodmFsdWVzW2Fib3V0XSAhPT0gdW5kZWZpbmVkKSB7DQoJCQkJcmV0dXJuIHZhbHVlc1thYm91dF07DQoJCQl9IGVsc2Ugew0KCQkJCWxvZygxLCAiRVJST1I6IG9wdGlvbiBcIiIgKyBhYm91dCArICJcIiBpcyBub3QgYXZhaWxhYmxlIik7DQoJCQkJcmV0dXJuOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIGN1cnJlbnQgbG9nbGV2ZWwgb3B0aW9uIHZhbHVlLg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCB2YWx1ZQ0KCQkgKiB2YXIgbG9nbGV2ZWwgPSBjb250cm9sbGVyLmxvZ2xldmVsKCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgdmFsdWUNCgkJICogY29udHJvbGxlci5sb2dsZXZlbCgzKTsNCgkJICoNCgkJICogQHBhcmFtIHtudW1iZXJ9IFtuZXdMb2dsZXZlbF0gLSBUaGUgbmV3IGxvZ2xldmVsIHNldHRpbmcgb2YgdGhlIFNjcm9sbE1hZ2ljIGNvbnRyb2xsZXIuIGBbMC0zXWANCgkJICogQHJldHVybnMgeyhudW1iZXJ8U2Nyb2xsTWFnaWMpfSBDdXJyZW50IGxvZ2xldmVsIG9yIHBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5sb2dsZXZlbCA9IGZ1bmN0aW9uIChuZXdMb2dsZXZlbCkgew0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiBfb3B0aW9ucy5sb2dsZXZlbDsNCgkJCX0gZWxzZSBpZiAoX29wdGlvbnMubG9nbGV2ZWwgIT0gbmV3TG9nbGV2ZWwpIHsgLy8gc2V0DQoJCQkJX29wdGlvbnMubG9nbGV2ZWwgPSBuZXdMb2dsZXZlbDsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxNYWdpYzsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSBjdXJyZW50IGVuYWJsZWQgc3RhdGUgb2YgdGhlIGNvbnRyb2xsZXIuICANCgkJICogVGhpcyBjYW4gYmUgdXNlZCB0byBkaXNhYmxlIGFsbCBTY2VuZXMgY29ubmVjdGVkIHRvIHRoZSBjb250cm9sbGVyIHdpdGhvdXQgZGVzdHJveWluZyBvciByZW1vdmluZyB0aGVtLg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCB2YWx1ZQ0KCQkgKiB2YXIgZW5hYmxlZCA9IGNvbnRyb2xsZXIuZW5hYmxlZCgpOw0KCQkgKg0KCSAJICogLy8gZGlzYWJsZSB0aGUgY29udHJvbGxlcg0KCQkgKiBjb250cm9sbGVyLmVuYWJsZWQoZmFsc2UpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZXdTdGF0ZV0gLSBUaGUgbmV3IGVuYWJsZWQgc3RhdGUgb2YgdGhlIGNvbnRyb2xsZXIgYHRydWVgIG9yIGBmYWxzZWAuDQoJCSAqIEByZXR1cm5zIHsoYm9vbGVhbnxTY3JvbGxNYWdpYyl9IEN1cnJlbnQgZW5hYmxlZCBzdGF0ZSBvciBwYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuZW5hYmxlZCA9IGZ1bmN0aW9uIChuZXdTdGF0ZSkgew0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiBfZW5hYmxlZDsNCgkJCX0gZWxzZSBpZiAoX2VuYWJsZWQgIT0gbmV3U3RhdGUpIHsgLy8gc2V0DQoJCQkJX2VuYWJsZWQgPSAhIW5ld1N0YXRlOw0KCQkJCVNjcm9sbE1hZ2ljLnVwZGF0ZVNjZW5lKF9zY2VuZU9iamVjdHMsIHRydWUpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KCQl9Ow0KCQkNCgkJLyoqDQoJCSAqIERlc3Ryb3kgdGhlIENvbnRyb2xsZXIsIGFsbCBTY2VuZXMgYW5kIGV2ZXJ5dGhpbmcuDQoJCSAqIEBwdWJsaWMNCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogLy8gd2l0aG91dCByZXNldHRpbmcgdGhlIHNjZW5lcw0KCQkgKiBjb250cm9sbGVyID0gY29udHJvbGxlci5kZXN0cm95KCk7DQoJCSAqDQoJIAkgKiAvLyB3aXRoIHNjZW5lIHJlc2V0DQoJCSAqIGNvbnRyb2xsZXIgPSBjb250cm9sbGVyLmRlc3Ryb3kodHJ1ZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0U2NlbmVzPWZhbHNlXSAtIElmIGB0cnVlYCB0aGUgcGlucyBhbmQgdHdlZW5zIChpZiBleGlzdGVudCkgb2YgYWxsIHNjZW5lcyB3aWxsIGJlIHJlc2V0Lg0KCQkgKiBAcmV0dXJucyB7bnVsbH0gTnVsbCB0byB1bnNldCBoYW5kbGVyIHZhcmlhYmxlcy4NCgkJICovDQoJCXRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uIChyZXNldFNjZW5lcykgew0KCQkJd2luZG93LmNsZWFyVGltZW91dChfcmVmcmVzaEludGVydmFsKTsNCgkJCXZhciBpID0gX3NjZW5lT2JqZWN0cy5sZW5ndGg7DQoJCQl3aGlsZSAoaS0tKSB7DQoJCQkJX3NjZW5lT2JqZWN0c1tpXS5kZXN0cm95KHJlc2V0U2NlbmVzKTsNCgkJCX0NCgkJCV9vcHRpb25zLmNvbnRhaW5lci5vZmYoInNjcm9sbCByZXNpemUiLCBvbkNoYW5nZSk7DQoJCQlhbmltYXRpb25GcmFtZUNhbmNlbENhbGxiYWNrKF91cGRhdGVDeWNsZSk7DQoJCQlsb2coMywgImRlc3Ryb3llZCAiICsgTkFNRVNQQUNFICsgIiAocmVzZXQ6ICIgKyAocmVzZXRTY2VuZXMgPyAidHJ1ZSIgOiAiZmFsc2UiKSArICIpIik7DQoJCQlyZXR1cm4gbnVsbDsNCgkJfTsNCg0KCQkvLyBJTklUDQoJCWNvbnN0cnVjdCgpOw0KCQlyZXR1cm4gU2Nyb2xsTWFnaWM7DQoJfTsNCglTY3JvbGxNYWdpYy52ZXJzaW9uID0gIjEuMi4zIjsgLy8gdmVyc2lvbiBudW1iZXIgZm9yIGJyb3dzZXIgZ2xvYmFsDQoJcmV0dXJuIFNjcm9sbE1hZ2ljOw0KfSk7DQoNCmRlZmluZSgnU2Nyb2xsU2NlbmUnLCBbJ2pxdWVyeScsICdUd2Vlbk1heCcsICdUaW1lbGluZU1heCddLCBmdW5jdGlvbiAoJCwgVHdlZW5NYXgsIFRpbWVsaW5lTWF4KSB7DQoJLyoqDQoJICogQSBTY3JvbGxTY2VuZSBkZWZpbmVzIHdoZXJlIHRoZSBjb250cm9sbGVyIHNob3VsZCByZWFjdCBhbmQgaG93Lg0KCSAqDQoJICogQGNsYXNzDQoJICogQGdsb2JhbA0KCSAqDQoJICogQGV4YW1wbGUNCgkgKiAvLyBjcmVhdGUgYSBzdGFuZGFyZCBzY2VuZSBhbmQgYWRkIGl0IHRvIGEgY29udHJvbGxlcg0KCSAqIG5ldyBTY3JvbGxTY2VuZSgpDQoJICoJCS5hZGRUbyhjb250cm9sbGVyKTsNCgkgKg0KCSAqIC8vIGNyZWF0ZSBhIHNjZW5lIHdpdGggY3VzdG9tIG9wdGlvbnMgYW5kIGFzc2lnbiBhIGhhbmRsZXIgdG8gaXQuDQoJICogdmFyIHNjZW5lID0gbmV3IFNjcm9sbFNjZW5lKHsNCgkgKiAJCWR1cmF0aW9uOiAxMDAsDQoJICoJCW9mZnNldDogMjAwLA0KCSAqCQl0cmlnZ2VySG9vazogIm9uRW50ZXIiLA0KCSAqCQlyZXZlcnNlOiBmYWxzZQ0KCSAqIH0pOw0KCSAqDQoJICogQHBhcmFtIHtvYmplY3R9IFtvcHRpb25zXSAtIE9wdGlvbnMgZm9yIHRoZSBTY2VuZS4gVGhlIG9wdGlvbnMgY2FuIGJlIHVwZGF0ZWQgYXQgYW55IHRpbWUuICANCgkgCQkJCQkJCSAgIEluc3RlYWQgb2Ygc2V0dGluZyB0aGUgb3B0aW9ucyBmb3IgZWFjaCBzY2VuZSBpbmRpdmlkdWFsbHkgeW91IGNhbiBhbHNvIHNldCB0aGVtIGdsb2JhbGx5IGluIHRoZSBjb250cm9sbGVyIGFzIHRoZSBjb250cm9sbGVycyBgZ2xvYmFsU2NlbmVPcHRpb25zYCBvcHRpb24uIFRoZSBvYmplY3QgYWNjZXB0cyB0aGUgc2FtZSBwcm9wZXJ0aWVzIGFzIHRoZSBvbmVzIGJlbG93LiAgDQoJIAkJCQkJCQkgICBXaGVuIGEgc2NlbmUgaXMgYWRkZWQgdG8gdGhlIGNvbnRyb2xsZXIgdGhlIG9wdGlvbnMgZGVmaW5lZCB1c2luZyB0aGUgU2Nyb2xsU2NlbmUgY29uc3RydWN0b3Igd2lsbCBiZSBvdmVyd3JpdHRlbiBieSB0aG9zZSBzZXQgaW4gYGdsb2JhbFNjZW5lT3B0aW9uc2AuDQoJICogQHBhcmFtIHsobnVtYmVyfGZ1bmN0aW9uKX0gW29wdGlvbnMuZHVyYXRpb249MF0gLSBUaGUgZHVyYXRpb24gb2YgdGhlIHNjZW5lLiANCgkgCQkJCQkJCQkJCSAgSWYgYDBgIHR3ZWVucyB3aWxsIGF1dG8tcGxheSB3aGVuIHJlYWNoaW5nIHRoZSBzY2VuZSBzdGFydCBwb2ludCwgcGlucyB3aWxsIGJlIHBpbm5lZCBpbmRlZmluZXRseSBzdGFydGluZyBhdCB0aGUgc3RhcnQgcG9zaXRpb24uICANCgkgCQkJCQkJCQkJCSAgQSBmdW5jdGlvbiByZXR1bmluZyB0aGUgZHVyYXRpb24gdmFsdWUgaXMgYWxzbyBzdXBwb3J0ZWQuIFBsZWFzZSBzZWUgYFNjcm9sbFNjZW5lLmR1cmF0aW9uKClgIGZvciBkZXRhaWxzLg0KCSAqIEBwYXJhbSB7bnVtYmVyfSBbb3B0aW9ucy5vZmZzZXQ9MF0gLSBPZmZzZXQgVmFsdWUgZm9yIHRoZSBUcmlnZ2VyIFBvc2l0aW9uLiBJZiBubyB0cmlnZ2VyRWxlbWVudCBpcyBkZWZpbmVkIHRoaXMgd2lsbCBiZSB0aGUgc2Nyb2xsIGRpc3RhbmNlIGZyb20gdGhlIHN0YXJ0IG9mIHRoZSBwYWdlLCBhZnRlciB3aGljaCB0aGUgc2NlbmUgd2lsbCBzdGFydC4NCgkgKiBAcGFyYW0geyhzdHJpbmd8b2JqZWN0KX0gW29wdGlvbnMudHJpZ2dlckVsZW1lbnQ9bnVsbF0gLSBTZWxlY3RvciwgRE9NIG9iamVjdCBvciBqUXVlcnkgT2JqZWN0IHRoYXQgZGVmaW5lcyB0aGUgc3RhcnQgb2YgdGhlIHNjZW5lLiBJZiB1bmRlZmluZWQgdGhlIHNjZW5lIHdpbGwgc3RhcnQgcmlnaHQgYXQgdGhlIHN0YXJ0IG9mIHRoZSBwYWdlICh1bmxlc3MgYW4gb2Zmc2V0IGlzIHNldCkuDQoJICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyl9IFtvcHRpb25zLnRyaWdnZXJIb29rPSJvbkNlbnRlciJdIC0gQ2FuIGJlIGEgbnVtYmVyIGJldHdlZW4gMCBhbmQgMSBkZWZpbmluZyB0aGUgcG9zaXRpb24gb2YgdGhlIHRyaWdnZXIgSG9vayBpbiByZWxhdGlvbiB0byB0aGUgdmlld3BvcnQuICANCgkgCQkJCQkJCQkJCQkJCQkJICBDYW4gYWxzbyBiZSBkZWZpbmVkIHVzaW5nIGEgc3RyaW5nOg0KCSAJCQkJCQkJCQkJCQkJCQkgICoqIGAib25FbnRlciJgID0+IGAxYA0KCSAJCQkJCQkJCQkJCQkJCQkgICoqIGAib25DZW50ZXIiYCA9PiBgMC41YA0KCSAJCQkJCQkJCQkJCQkJCQkgICoqIGAib25MZWF2ZSJgID0+IGAwYA0KCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMucmV2ZXJzZT10cnVlXSAtIFNob3VsZCB0aGUgc2NlbmUgcmV2ZXJzZSwgd2hlbiBzY3JvbGxpbmcgdXA/DQoJICogQHBhcmFtIHtib29sZWFufSBbb3B0aW9ucy50d2VlbkNoYW5nZXM9ZmFsc2VdIC0gVHdlZW5zIEFuaW1hdGlvbiB0byB0aGUgcHJvZ3Jlc3MgdGFyZ2V0IGluc3RlYWQgb2Ygc2V0dGluZyBpdC4gIA0KCSAJCQkJCQkJCQkJCQkgICBEb2VzIG5vdCBhZmZlY3QgYW5pbWF0aW9ucyB3aGVyZSBkdXJhdGlvbiBpcyBgMGAuDQoJICogQHBhcmFtIHtudW1iZXJ9IFtvcHRpb25zLmxvZ2xldmVsPTJdIC0gTG9nbGV2ZWwgZm9yIGRlYnVnZ2luZy4gTm90ZSB0aGF0IGxvZ2dpbmcgaXMgZGlzYWJsZWQgaW4gdGhlIG1pbmlmaWVkIHZlcnNpb24gb2YgU2Nyb2xsTWFnaWMuDQoJIAkJCQkJCQkJCQkgICoqIGAwYCA9PiBzaWxlbnQNCgkgCQkJCQkJCQkJCSAgKiogYDFgID0+IGVycm9ycw0KCSAJCQkJCQkJCQkJICAqKiBgMmAgPT4gZXJyb3JzLCB3YXJuaW5ncw0KCSAJCQkJCQkJCQkJICAqKiBgM2AgPT4gZXJyb3JzLCB3YXJuaW5ncywgZGVidWdpbmZvDQoJICogDQoJICovDQoJU2Nyb2xsU2NlbmUgPSBmdW5jdGlvbiAob3B0aW9ucykgew0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogc2V0dGluZ3MNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQl2YXINCgkJCVRSSUdHRVJfSE9PS19WQUxVRVMgPSB7Im9uQ2VudGVyIiA6IDAuNSwgIm9uRW50ZXIiIDogMSwgIm9uTGVhdmUiIDogMH0sDQoJCQlOQU1FU1BBQ0UgPSAiU2Nyb2xsU2NlbmUiLA0KCQkJREVGQVVMVF9PUFRJT05TID0gew0KCQkJCWR1cmF0aW9uOiAwLA0KCQkJCW9mZnNldDogMCwNCgkJCQl0cmlnZ2VyRWxlbWVudDogbnVsbCwNCgkJCQl0cmlnZ2VySG9vazogIm9uQ2VudGVyIiwNCgkJCQlyZXZlcnNlOiB0cnVlLA0KCQkJCXR3ZWVuQ2hhbmdlczogZmFsc2UsDQoJCQkJbG9nbGV2ZWw6IDINCgkJCX07DQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBwcml2YXRlIHZhcnMNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQl2YXINCgkJCVNjcm9sbFNjZW5lID0gdGhpcywNCgkJCV9vcHRpb25zID0gJC5leHRlbmQoe30sIERFRkFVTFRfT1BUSU9OUywgb3B0aW9ucyksDQoJCQlfc3RhdGUgPSAnQkVGT1JFJywNCgkJCV9wcm9ncmVzcyA9IDAsDQoJCQlfc2Nyb2xsT2Zmc2V0ID0ge3N0YXJ0OiAwLCBlbmQ6IDB9LCAvLyByZWZsZWN0cyB0aGUgcGFyZW50J3Mgc2Nyb2xsIHBvc2l0aW9uIGZvciB0aGUgc3RhcnQgYW5kIGVuZCBvZiB0aGUgc2NlbmUgcmVzcGVjdGl2ZWx5DQoJCQlfdHJpZ2dlclBvcyA9IDAsDQoJCQlfZW5hYmxlZCA9IHRydWUsDQoJCQlfZHVyYXRpb25VcGRhdGVNZXRob2QsDQoJCQlfcGFyZW50LA0KCQkJX3R3ZWVuLA0KCQkJX3BpbiwNCgkJCV9waW5PcHRpb25zLA0KCQkJX2Nzc0NsYXNzZXMsDQoJCQlfY3NzQ2xhc3NFbG07DQoNCgkJLy8gb2JqZWN0IGNvbnRhaW5pbmcgdmFsaWRhdG9yIGZ1bmN0aW9ucyBmb3IgdmFyaW91cyBvcHRpb25zDQoJCXZhciBfdmFsaWRhdGUgPSB7DQoJCQkidW5rbm93bk9wdGlvblN1cHBsaWVkIiA6IGZ1bmN0aW9uICgpIHsNCgkJCQkJJC5lYWNoKF9vcHRpb25zLCBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgew0KCQkJCQlpZiAoIURFRkFVTFRfT1BUSU9OUy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7DQoJCQkJCQlsb2coMiwgIldBUk5JTkc6IFVua25vd24gb3B0aW9uIFwiIiArIGtleSArICJcIiIpOw0KCQkJCQkJZGVsZXRlIF9vcHRpb25zW2tleV07DQoJCQkJCX0NCgkJCQl9KTsNCgkJCX0sDQoJCQkiZHVyYXRpb24iIDogZnVuY3Rpb24gKCkgew0KCQkJCWlmICgkLmlzRnVuY3Rpb24oX29wdGlvbnMuZHVyYXRpb24pKSB7DQoJCQkJCV9kdXJhdGlvblVwZGF0ZU1ldGhvZCA9IF9vcHRpb25zLmR1cmF0aW9uOw0KCQkJCQl0cnkgew0KCQkJCQkJX29wdGlvbnMuZHVyYXRpb24gPSBwYXJzZUZsb2F0KF9kdXJhdGlvblVwZGF0ZU1ldGhvZCgpKTsNCgkJCQkJfSBjYXRjaCAoZSkgew0KCQkJCQkJbG9nKDEsICJFUlJPUjogSW52YWxpZCByZXR1cm4gdmFsdWUgb2Ygc3VwcGxpZWQgZnVuY3Rpb24gZm9yIG9wdGlvbiBcImR1cmF0aW9uXCI6IiwgX29wdGlvbnMuZHVyYXRpb24pOw0KCQkJCQkJX2R1cmF0aW9uVXBkYXRlTWV0aG9kID0gdW5kZWZpbmVkOw0KCQkJCQkJX29wdGlvbnMuZHVyYXRpb24gPSBERUZBVUxUX09QVElPTlMuZHVyYXRpb247DQoJCQkJCX0NCgkJCQl9IGVsc2Ugew0KCQkJCQlfb3B0aW9ucy5kdXJhdGlvbiA9IHBhcnNlRmxvYXQoX29wdGlvbnMuZHVyYXRpb24pOw0KCQkJCQlpZiAoISQuaXNOdW1lcmljKF9vcHRpb25zLmR1cmF0aW9uKSB8fCBfb3B0aW9ucy5kdXJhdGlvbiAmbHQ7IDApIHsNCgkJCQkJCWxvZygxLCAiRVJST1I6IEludmFsaWQgdmFsdWUgZm9yIG9wdGlvbiBcImR1cmF0aW9uXCI6IiwgX29wdGlvbnMuZHVyYXRpb24pOw0KCQkJCQkJX29wdGlvbnMuZHVyYXRpb24gPSBERUZBVUxUX09QVElPTlMuZHVyYXRpb247DQoJCQkJCX0NCgkJCQl9DQoJCQl9LA0KCQkJIm9mZnNldCIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJX29wdGlvbnMub2Zmc2V0ID0gcGFyc2VGbG9hdChfb3B0aW9ucy5vZmZzZXQpOw0KCQkJCWlmICghJC5pc051bWVyaWMoX29wdGlvbnMub2Zmc2V0KSkgew0KCQkJCQlsb2coMSwgIkVSUk9SOiBJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJvZmZzZXRcIjoiLCBfb3B0aW9ucy5vZmZzZXQpOw0KCQkJCQlfb3B0aW9ucy5vZmZzZXQgPSBERUZBVUxUX09QVElPTlMub2Zmc2V0Ow0KCQkJCX0NCgkJCX0sDQoJCQkidHJpZ2dlckVsZW1lbnQiIDogZnVuY3Rpb24gKCkgew0KCQkJCWlmIChfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCAhPT0gbnVsbCAmYW1wOyZhbXA7ICQoX29wdGlvbnMudHJpZ2dlckVsZW1lbnQpLmxlbmd0aCA9PT0gMCkgew0KCQkJCQlsb2coMSwgIkVSUk9SOiBFbGVtZW50IGRlZmluZWQgaW4gb3B0aW9uIFwidHJpZ2dlckVsZW1lbnRcIiB3YXMgbm90IGZvdW5kOiIsIF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KTsNCgkJCQkJX29wdGlvbnMudHJpZ2dlckVsZW1lbnQgPSBERUZBVUxUX09QVElPTlMudHJpZ2dlckVsZW1lbnQ7DQoJCQkJfQ0KCQkJfSwNCgkJCSJ0cmlnZ2VySG9vayIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJaWYgKCEoX29wdGlvbnMudHJpZ2dlckhvb2sgaW4gVFJJR0dFUl9IT09LX1ZBTFVFUykpIHsNCgkJCQkJaWYgKCQuaXNOdW1lcmljKF9vcHRpb25zLnRyaWdnZXJIb29rKSkgew0KCQkJCQkJX29wdGlvbnMudHJpZ2dlckhvb2sgPSBNYXRoLm1heCgwLCBNYXRoLm1pbihwYXJzZUZsb2F0KF9vcHRpb25zLnRyaWdnZXJIb29rKSwgMSkpOyAvLyAgbWFrZSBzdXJlIGl0cyBiZXR3ZWVlbiAwIGFuZCAxDQoJCQkJCX0gZWxzZSB7DQoJCQkJCQlsb2coMSwgIkVSUk9SOiBJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJ0cmlnZ2VySG9va1wiOiAiLCBfb3B0aW9ucy50cmlnZ2VySG9vayk7DQoJCQkJCQlfb3B0aW9ucy50cmlnZ2VySG9vayA9IERFRkFVTFRfT1BUSU9OUy50cmlnZ2VySG9vazsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0sDQoJCQkicmV2ZXJzZSIgOiBmdW5jdGlvbiAoKSB7DQoJCQkJX29wdGlvbnMucmV2ZXJzZSA9ICEhX29wdGlvbnMucmV2ZXJzZTsgLy8gZm9yY2UgYm9vbGVhbg0KCQkJfSwNCgkJCSJ0d2VlbkNoYW5nZXMiIDogZnVuY3Rpb24gKCkgew0KCQkJCV9vcHRpb25zLnR3ZWVuQ2hhbmdlcyA9ICEhX29wdGlvbnMudHdlZW5DaGFuZ2VzOyAvLyBmb3JjZSBib29sZWFuDQoJCQl9LA0KCQkJImxvZ2xldmVsIiA6IGZ1bmN0aW9uICgpIHsNCgkJCQlfb3B0aW9ucy5sb2dsZXZlbCA9IHBhcnNlSW50KF9vcHRpb25zLmxvZ2xldmVsKTsNCgkJCQlpZiAoISQuaXNOdW1lcmljKF9vcHRpb25zLmxvZ2xldmVsKSB8fCBfb3B0aW9ucy5sb2dsZXZlbCAmbHQ7IDAgfHwgX29wdGlvbnMubG9nbGV2ZWwgPiAzKSB7DQoJCQkJCXZhciB3cm9uZ3ZhbCA9IF9vcHRpb25zLmxvZ2xldmVsOw0KCQkJCQlfb3B0aW9ucy5sb2dsZXZlbCA9IERFRkFVTFRfT1BUSU9OUy5sb2dsZXZlbDsNCgkJCQkJbG9nKDEsICJFUlJPUjogSW52YWxpZCB2YWx1ZSBmb3Igb3B0aW9uIFwibG9nbGV2ZWxcIjoiLCB3cm9uZ3ZhbCk7DQoJCQkJfQ0KCQkJfSwNCgkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHByaXZhdGUgZnVuY3Rpb25zDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICovDQoNCgkJLyoqDQoJCSAqIEludGVybmFsIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIG9mIFNjcm9sbE1hZ2ljDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgY29uc3RydWN0ID0gZnVuY3Rpb24gKCkgew0KCQkJdmFsaWRhdGVPcHRpb24oKTsNCg0KCQkJLy8gZXZlbnQgbGlzdGVuZXJzDQoJCQlTY3JvbGxTY2VuZQ0KCQkJCS5vbigiY2hhbmdlLmludGVybmFsIiwgZnVuY3Rpb24gKGUpIHsNCgkJCQkJaWYgKGUud2hhdCAhPT0gImxvZ2xldmVsIiAmYW1wOyZhbXA7IGUud2hhdCAhPT0gInR3ZWVuQ2hhbmdlcyIpIHsgLy8gbm8gbmVlZCBmb3IgYSBzY2VuZSB1cGRhdGUgc2NlbmUgd2l0aCB0aGVzZSBvcHRpb25zLi4uDQoJCQkJCQlpZiAoZS53aGF0ID09PSAidHJpZ2dlckVsZW1lbnQiKSB7DQoJCQkJCQkJdXBkYXRlVHJpZ2dlckVsZW1lbnRQb3NpdGlvbigpOw0KCQkJCQkJfSBlbHNlIGlmIChlLndoYXQgPT09ICJyZXZlcnNlIikgeyAvLyB0aGUgb25seSBwcm9wZXJ0eSBsZWZ0IHRoYXQgbWF5IGhhdmUgYW4gaW1wYWN0IG9uIHRoZSBjdXJyZW50IHNjZW5lIHN0YXRlLiBFdmVyeXRoaW5nIGVsc2UgaXMgaGFuZGxlZCBieSB0aGUgc2hpZnQgZXZlbnQuDQoJCQkJCQkJU2Nyb2xsU2NlbmUudXBkYXRlKCk7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQl9KQ0KCQkJCS5vbigic2hpZnQuaW50ZXJuYWwiLCBmdW5jdGlvbiAoZSkgew0KCQkJCQl1cGRhdGVTY3JvbGxPZmZzZXQoKTsNCgkJCQkJU2Nyb2xsU2NlbmUudXBkYXRlKCk7IC8vIHVwZGF0ZSBzY2VuZSB0byByZWZsZWN0IG5ldyBwb3NpdGlvbg0KCQkJCQlpZiAoKF9zdGF0ZSA9PT0gIkFGVEVSIiAmYW1wOyZhbXA7IGUucmVhc29uID09PSAiZHVyYXRpb24iKSB8fCAoX3N0YXRlID09PSAnRFVSSU5HJyAmYW1wOyZhbXA7IF9vcHRpb25zLmR1cmF0aW9uID09PSAwKSkgew0KCQkJCQkJLy8gaWYgW2R1cmF0aW9uIGNoYW5nZWQgYWZ0ZXIgYSBzY2VuZSAoaW5zaWRlIHNjZW5lIHByb2dyZXNzIHVwZGF0ZXMgcGluIHBvc2l0aW9uKV0gb3IgW2R1cmF0aW9uIGlzIDAsIHdlIGFyZSBpbiBwaW4gcGhhc2UgYW5kIHNvbWUgb3RoZXIgdmFsdWUgY2hhbmdlZF0uDQoJCQkJCQl1cGRhdGVQaW5TdGF0ZSgpOw0KCQkJCQl9DQoJCQkJfSkNCgkJCQkub24oInByb2dyZXNzLmludGVybmFsIiwgZnVuY3Rpb24gKGUpIHsNCgkJCQkJdXBkYXRlVHdlZW5Qcm9ncmVzcygpOw0KCQkJCQl1cGRhdGVQaW5TdGF0ZSgpOw0KCQkJCX0pDQoJCQkJLm9uKCJkZXN0cm95IiwgZnVuY3Rpb24gKGUpIHsNCgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOyAvLyBvdGhlcndpc2UgalF1ZXJ5IHdvdWxkIGNhbGwgdGFyZ2V0LmRlc3Ryb3koKSBieSBkZWZhdWx0Lg0KCQkJCX0pOw0KCQl9Ow0KCQkNCgkJLyoqDQoJCSAqIFNlbmQgYSBkZWJ1ZyBtZXNzYWdlIHRvIHRoZSBjb25zb2xlLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKg0KCQkgKiBAcGFyYW0ge251bWJlcn0gbG9nbGV2ZWwgLSBUaGUgbG9nbGV2ZWwgcmVxdWlyZWQgdG8gaW5pdGlhdGUgb3V0cHV0IGZvciB0aGUgbWVzc2FnZS4NCgkJICogQHBhcmFtIHsuLi5taXhlZH0gb3V0cHV0IC0gT25lIG9yIG1vcmUgdmFyaWFibGVzIHRoYXQgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgY29uc29sZS4NCgkJICovDQoJCXZhciBsb2cgPSBmdW5jdGlvbiAobG9nbGV2ZWwsIG91dHB1dCkgew0KCQkJaWYgKF9vcHRpb25zLmxvZ2xldmVsID49IGxvZ2xldmVsKSB7DQoJCQkJdmFyDQoJCQkJCXByZWZpeCA9ICIoIiArIE5BTUVTUEFDRSArICIpIC0+IiwNCgkJCQkJYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDEpOw0KCQkJCWFyZ3MudW5zaGlmdChsb2dsZXZlbCwgcHJlZml4KTsNCgkJCQlkZWJ1Zy5hcHBseSh3aW5kb3csIGFyZ3MpOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBDaGVja3MgdGhlIHZhbGlkaXR5IG9mIGEgc3BlY2lmaWMgb3IgYWxsIG9wdGlvbnMgYW5kIHJlc2V0IHRvIGRlZmF1bHQgaWYgbmVjY2Vzc2FyeS4NCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB2YWxpZGF0ZU9wdGlvbiA9IGZ1bmN0aW9uIChjaGVjaykgew0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7DQoJCQkJY2hlY2sgPSBbXTsNCgkJCQlmb3IgKHZhciBrZXkgaW4gX3ZhbGlkYXRlKXsNCgkJCQkJY2hlY2sucHVzaChrZXkpOw0KCQkJCX0NCgkJCX0gZWxzZSBpZiAoISQuaXNBcnJheShjaGVjaykpIHsNCgkJCQljaGVjayA9IFtjaGVja107DQoJCQl9DQoJCQkkLmVhY2goY2hlY2ssIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7DQoJCQkJaWYgKF92YWxpZGF0ZVt2YWx1ZV0pIHsNCgkJCQkJX3ZhbGlkYXRlW3ZhbHVlXSgpOw0KCQkJCX0NCgkJCX0pOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBIZWxwZXIgdXNlZCBieSB0aGUgc2V0dGVyL2dldHRlcnMgZm9yIHNjZW5lIG9wdGlvbnMNCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciBjaGFuZ2VPcHRpb24gPSBmdW5jdGlvbih2YXJuYW1lLCBuZXd2YWwpIHsNCgkJCXZhcg0KCQkJCWNoYW5nZWQgPSBmYWxzZSwNCgkJCQlvbGR2YWwgPSBfb3B0aW9uc1t2YXJuYW1lXTsNCgkJCWlmIChfb3B0aW9uc1t2YXJuYW1lXSAhPSBuZXd2YWwpIHsNCgkJCQlfb3B0aW9uc1t2YXJuYW1lXSA9IG5ld3ZhbDsNCgkJCQl2YWxpZGF0ZU9wdGlvbih2YXJuYW1lKTsgLy8gcmVzZXRzIHRvIGRlZmF1bHQgaWYgbmVjZXNzYXJ5DQoJCQkJY2hhbmdlZCA9IG9sZHZhbCAhPSBfb3B0aW9uc1t2YXJuYW1lXTsNCgkJCX0NCgkJCXJldHVybiBjaGFuZ2VkOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGUgdGhlIHN0YXJ0IGFuZCBlbmQgc2Nyb2xsT2Zmc2V0IG9mIHRoZSBjb250YWluZXIuDQoJCSAqIFRoZSBwb3NpdGlvbnMgcmVmbGVjdCB3aGF0IHRoZSBwYXJlbnQncyBzY3JvbGwgcG9zaXRpb24gd2lsbCBiZSBhdCB0aGUgc3RhcnQgYW5kIGVuZCByZXNwZWN0aXZlbHkuDQoJCSAqIElzIGNhbGxlZCwgd2hlbjoNCgkJICogICAtIFNjcm9sbFNjZW5lIGV2ZW50ICJjaGFuZ2UiIGlzIGNhbGxlZCB3aXRoOiBvZmZzZXQsIHRyaWdnZXJIb29rLCBkdXJhdGlvbiANCgkJICogICAtIHNjcm9sbCBjb250YWluZXIgZXZlbnQgInJlc2l6ZSIgaXMgY2FsbGVkDQoJCSAqICAgLSB0aGUgcG9zaXRpb24gb2YgdGhlIHRyaWdnZXJFbGVtZW50IGNoYW5nZXMNCgkJICogICAtIHRoZSBwYXJlbnQgY2hhbmdlcyAtPiBhZGRUbygpDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgdXBkYXRlU2Nyb2xsT2Zmc2V0ID0gZnVuY3Rpb24gKCkgew0KCQkJX3Njcm9sbE9mZnNldCA9IHtzdGFydDogX3RyaWdnZXJQb3MgKyBfb3B0aW9ucy5vZmZzZXR9Ow0KCQkJaWYgKF9wYXJlbnQgJmFtcDsmYW1wOyBfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCkgew0KCQkJCS8vIHRha2UgYXdheSB0cmlnZ2VySG9vayBwb3J0aW9uIHRvIGdldCByZWxhdGl2ZSB0byB0b3ANCgkJCQlfc2Nyb2xsT2Zmc2V0LnN0YXJ0IC09IF9wYXJlbnQuaW5mbygic2l6ZSIpICogU2Nyb2xsU2NlbmUudHJpZ2dlckhvb2soKTsNCgkJCX0NCgkJCV9zY3JvbGxPZmZzZXQuZW5kID0gX3Njcm9sbE9mZnNldC5zdGFydCArIF9vcHRpb25zLmR1cmF0aW9uOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBVcGRhdGVzIHRoZSBkdXJhdGlvbiBpZiBzZXQgdG8gYSBkeW5hbWljIGZ1bmN0aW9uLg0KCQkgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiB0aGUgc2NlbmUgaXMgYWRkZWQgdG8gYSBjb250cm9sbGVyIGFuZCBpbiByZWd1bGFyIGludGVydmFscyBmcm9tIHRoZSBjb250cm9sbGVyIHRocm91Z2ggc2NlbmUucmVmcmVzaCgpLg0KCQkgKiANCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCBpZiB0aGUgZHVyYXRpb24gY2hhbmdlZA0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLnNoaWZ0fSwgaWYgdGhlIGR1cmF0aW9uIGNoYW5nZWQNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbc3VwcHJlc3NFdmVudHM9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgc2hpZnQgZXZlbnQgd2lsbCBiZSBzdXBwcmVzc2VkLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIHVwZGF0ZUR1cmF0aW9uID0gZnVuY3Rpb24gKHN1cHByZXNzRXZlbnRzKSB7DQoJCQkvLyB1cGRhdGUgZHVyYXRpb24NCgkJCWlmIChfZHVyYXRpb25VcGRhdGVNZXRob2QpIHsNCgkJCQl2YXIgdmFybmFtZSA9ICJkdXJhdGlvbiI7DQoJCQkJaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBfZHVyYXRpb25VcGRhdGVNZXRob2QuY2FsbChTY3JvbGxTY2VuZSkpICZhbXA7JmFtcDsgIXN1cHByZXNzRXZlbnRzKSB7IC8vIHNldA0KCQkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJzaGlmdCIsIHtyZWFzb246IHZhcm5hbWV9KTsNCgkJCQl9DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZXMgdGhlIHBvc2l0aW9uIG9mIHRoZSB0cmlnZ2VyRWxlbWVudCwgaWYgcHJlc2VudC4NCgkJICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIC4uLg0KCQkgKiAgLSAuLi4gd2hlbiB0aGUgdHJpZ2dlckVsZW1lbnQgaXMgY2hhbmdlZA0KCQkgKiAgLSAuLi4gd2hlbiB0aGUgc2NlbmUgaXMgYWRkZWQgdG8gYSAobmV3KSBjb250cm9sbGVyDQoJCSAqICAtIC4uLiBpbiByZWd1bGFyIGludGVydmFscyBmcm9tIHRoZSBjb250cm9sbGVyIHRocm91Z2ggc2NlbmUucmVmcmVzaCgpLg0KCQkgKiANCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zaGlmdH0sIGlmIHRoZSBwb3NpdGlvbiBjaGFuZ2VkDQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3N1cHByZXNzRXZlbnRzPWZhbHNlXSAtIElmIHRydWUgdGhlIHNoaWZ0IGV2ZW50IHdpbGwgYmUgc3VwcHJlc3NlZC4NCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB1cGRhdGVUcmlnZ2VyRWxlbWVudFBvc2l0aW9uID0gZnVuY3Rpb24gKHN1cHByZXNzRXZlbnRzKSB7DQoJCQl2YXIgZWxlbWVudFBvcyA9IDA7DQoJCQlpZiAoX3BhcmVudCAmYW1wOyZhbXA7IF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KSB7DQoJCQkJdmFyDQoJCQkJCWVsZW1lbnQgPSAkKF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KS5maXJzdCgpLA0KCQkJCQljb250cm9sbGVySW5mbyA9IF9wYXJlbnQuaW5mbygpLA0KCQkJCQljb250YWluZXJPZmZzZXQgPSBnZXRPZmZzZXQoY29udHJvbGxlckluZm8uY29udGFpbmVyKSwgLy8gY29udGFpbmVyIHBvc2l0aW9uIGlzIG5lZWRlZCBiZWNhdXNlIGVsZW1lbnQgb2Zmc2V0IGlzIHJldHVybmVkIGluIHJlbGF0aW9uIHRvIGRvY3VtZW50LCBub3QgaW4gcmVsYXRpb24gdG8gY29udGFpbmVyLg0KCQkJCQlwYXJhbSA9IGNvbnRyb2xsZXJJbmZvLnZlcnRpY2FsID8gInRvcCIgOiAibGVmdCI7IC8vIHdoaWNoIHBhcmFtIGlzIG9mIGludGVyZXN0ID8NCgkJCQkJDQoJCQkJLy8gaWYgcGFyZW50IGlzIHNwYWNlciwgdXNlIHNwYWNlciBwb3NpdGlvbiBpbnN0ZWFkIHNvIGNvcnJlY3Qgc3RhcnQgcG9zaXRpb24gaXMgcmV0dXJuZWQgZm9yIHBpbm5lZCBlbGVtZW50cy4NCgkJCQl3aGlsZSAoZWxlbWVudC5wYXJlbnQoKS5kYXRhKCJTY3JvbGxNYWdpY1BpblNwYWNlciIpKSB7DQoJCQkJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudCgpOw0KCQkJCX0NCg0KCQkJCXZhciBlbGVtZW50T2Zmc2V0ID0gZ2V0T2Zmc2V0KGVsZW1lbnQpOw0KDQoJCQkJaWYgKCFjb250cm9sbGVySW5mby5pc0RvY3VtZW50KSB7IC8vIGNvbnRhaW5lciBpcyBub3QgdGhlIGRvY3VtZW50IHJvb3QsIHNvIHN1YnN0cmFjdCBzY3JvbGwgUG9zaXRpb24gdG8gZ2V0IGNvcnJlY3QgdHJpZ2dlciBlbGVtZW50IHBvc2l0aW9uIHJlbGF0aXZlIHRvIHNjcm9sbGNvbnRlbnQNCgkJCQkJY29udGFpbmVyT2Zmc2V0W3BhcmFtXSAtPSBfcGFyZW50LnNjcm9sbFBvcygpOw0KCQkJCX0NCg0KCQkJCWVsZW1lbnRQb3MgPSBlbGVtZW50T2Zmc2V0W3BhcmFtXSAtIGNvbnRhaW5lck9mZnNldFtwYXJhbV07DQoJCQl9DQoJCQl2YXIgY2hhbmdlZCA9IGVsZW1lbnRQb3MgIT0gX3RyaWdnZXJQb3M7DQoJCQlfdHJpZ2dlclBvcyA9IGVsZW1lbnRQb3M7DQoJCQlpZiAoY2hhbmdlZCAmYW1wOyZhbXA7ICFzdXBwcmVzc0V2ZW50cykgew0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogInRyaWdnZXJFbGVtZW50UG9zaXRpb24ifSk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZSB0aGUgdHdlZW4gcHJvZ3Jlc3MuDQoJCSAqIEBwcml2YXRlDQoJCSAqDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBbdG9dIC0gSWYgbm90IHNldCB0aGUgc2NlbmUgUHJvZ3Jlc3Mgd2lsbCBiZSB1c2VkLiAobW9zdCBjYXNlcykNCgkJICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUgVHdlZW4gd2FzIHVwZGF0ZWQuIA0KCQkgKi8NCgkJdmFyIHVwZGF0ZVR3ZWVuUHJvZ3Jlc3MgPSBmdW5jdGlvbiAodG8pIHsNCgkJCWlmIChfdHdlZW4pIHsNCgkJCQl2YXIgcHJvZ3Jlc3MgPSAodG8gPj0gMCAmYW1wOyZhbXA7IHRvICZsdDs9IDEpID8gdG8gOiBfcHJvZ3Jlc3M7DQoJCQkJaWYgKF90d2Vlbi5yZXBlYXQoKSA9PT0gLTEpIHsNCgkJCQkJLy8gaW5maW5pdGUgbG9vcCwgc28gbm90IGluIHJlbGF0aW9uIHRvIHByb2dyZXNzDQoJCQkJCWlmIChfc3RhdGUgPT09ICJEVVJJTkciICZhbXA7JmFtcDsgX3R3ZWVuLnBhdXNlZCgpKSB7DQoJCQkJCQlfdHdlZW4ucGxheSgpOw0KCQkJCQl9IGVsc2UgaWYgKF9zdGF0ZSAhPT0gIkRVUklORyIgJmFtcDsmYW1wOyAhX3R3ZWVuLnBhdXNlZCgpKSB7DQoJCQkJCQlfdHdlZW4ucGF1c2UoKTsNCgkJCQkJfSBlbHNlIHsNCgkJCQkJCXJldHVybiBmYWxzZTsNCgkJCQkJfQ0KCQkJCX0gZWxzZSBpZiAocHJvZ3Jlc3MgIT0gX3R3ZWVuLnByb2dyZXNzKCkpIHsgLy8gZG8gd2UgZXZlbiBuZWVkIHRvIHVwZGF0ZSB0aGUgcHJvZ3Jlc3M/DQoJCQkJCS8vIG5vIGluZmluaXRlIGxvb3AgLSBzbyBzaG91bGQgd2UganVzdCBwbGF5IG9yIGdvIHRvIGEgc3BlY2lmaWMgcG9pbnQgaW4gdGltZT8NCgkJCQkJaWYgKF9vcHRpb25zLmR1cmF0aW9uID09PSAwKSB7DQoJCQkJCQkvLyBwbGF5IHRoZSBhbmltYXRpb24NCgkJCQkJCWlmIChfc3RhdGUgPT09ICJEVVJJTkciKSB7IC8vIHBsYXkgZnJvbSAwIHRvIDENCgkJCQkJCQlfdHdlZW4ucGxheSgpOw0KCQkJCQkJfSBlbHNlIHsgLy8gcGxheSBmcm9tIDEgdG8gMA0KCQkJCQkJCV90d2Vlbi5yZXZlcnNlKCk7DQoJCQkJCQl9DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQkvLyBnbyB0byBhIHNwZWNpZmljIHBvaW50IGluIHRpbWUNCgkJCQkJCWlmIChfb3B0aW9ucy50d2VlbkNoYW5nZXMpIHsNCgkJCQkJCQkvLyBnbyBzbW9vdGgNCgkJCQkJCQlfdHdlZW4udHdlZW5Ubyhwcm9ncmVzcyAqIF90d2Vlbi5kdXJhdGlvbigpKTsNCgkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJLy8ganVzdCBoYXJkIHNldCBpdA0KCQkJCQkJCV90d2Vlbi5wcm9ncmVzcyhwcm9ncmVzcykucGF1c2UoKTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0gZWxzZSB7DQoJCQkJCXJldHVybiBmYWxzZTsNCgkJCQl9DQoJCQkJcmV0dXJuIHRydWU7DQoJCQl9IGVsc2Ugew0KCQkJCXJldHVybiBmYWxzZTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlIHRoZSBwaW4gc3RhdGUuDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgdXBkYXRlUGluU3RhdGUgPSBmdW5jdGlvbiAoZm9yY2VVbnBpbikgew0KCQkJaWYgKF9waW4gJmFtcDsmYW1wOyBfcGFyZW50KSB7DQoJCQkJdmFyIA0KCQkJCQljb250YWluZXJJbmZvID0gX3BhcmVudC5pbmZvKCk7DQoNCgkJCQlpZiAoIWZvcmNlVW5waW4gJmFtcDsmYW1wOyBfc3RhdGUgPT09ICJEVVJJTkciKSB7IC8vIGR1cmluZyBzY2VuZSBvciBpZiBkdXJhdGlvbiBpcyAwIGFuZCB3ZSBhcmUgcGFzdCB0aGUgdHJpZ2dlcg0KCQkJCQkvLyBwaW5uZWQgc3RhdGUNCgkJCQkJaWYgKF9waW4uY3NzKCJwb3NpdGlvbiIpICE9ICJmaXhlZCIpIHsNCgkJCQkJCS8vIGNoYW5nZSBzdGF0ZSBiZWZvcmUgdXBkYXRpbmcgcGluIHNwYWNlciAocG9zaXRpb24gY2hhbmdlcyBkdWUgdG8gZml4ZWQgY29sbGFwc2luZyBtaWdodCBvY2N1ci4pDQoJCQkJCQlfcGluLmNzcygicG9zaXRpb24iLCAiZml4ZWQiKTsNCgkJCQkJCS8vIHVwZGF0ZSBwaW4gc3BhY2VyDQoJCQkJCQl1cGRhdGVQaW5TcGFjZXJTaXplKCk7DQoJCQkJCQkvLyBhZGQgcGlubmVkIGNsYXNzDQoJCQkJCQlfcGluLmFkZENsYXNzKF9waW5PcHRpb25zLnBpbm5lZENsYXNzKTsNCgkJCQkJfQ0KDQoJCQkJCXZhcg0KCQkJCQkJZml4ZWRQb3MgPSBnZXRPZmZzZXQoX3Bpbk9wdGlvbnMuc3BhY2VyLCB0cnVlKSwgLy8gZ2V0IHZpZXdwb3J0IHBvc2l0aW9uIG9mIHNwYWNlcg0KIAkJCQkJCXNjcm9sbERpc3RhbmNlID0gX29wdGlvbnMucmV2ZXJzZSB8fCBfb3B0aW9ucy5kdXJhdGlvbiA9PT0gMCA/DQogCQkJCQkJCQkJCSAJIGNvbnRhaW5lckluZm8uc2Nyb2xsUG9zIC0gX3Njcm9sbE9mZnNldC5zdGFydCAvLyBxdWlja2VyDQogCQkJCQkJCQkJCSA6IE1hdGgucm91bmQoX3Byb2dyZXNzICogX29wdGlvbnMuZHVyYXRpb24gKiAxMCkvMTA7IC8vIGlmIG5vIHJldmVyc2UgYW5kIGR1cmluZyBwaW4gdGhlIHBvc2l0aW9uIG5lZWRzIHRvIGJlIHJlY2FsY3VsYXRlZCB1c2luZyB0aGUgcHJvZ3Jlc3MNCiAJCQkJCQ0KIAkJCQkJLy8gcmVtb3ZlIHNwYWNlciBtYXJnaW4gdG8gZ2V0IHJlYWwgcG9zaXRpb24gKGluIGNhc2UgbWFyZ2luQ29sbGFwc2UgbW9kZSkNCiAJCQkJCWZpeGVkUG9zLnRvcCAtPSBwYXJzZUZsb2F0KF9waW5PcHRpb25zLnNwYWNlci5jc3MoIm1hcmdpbi10b3AiKSk7DQoNCiAJCQkJCS8vIGFkZCBzY3JvbGxEaXN0YW5jZQ0KIAkJCQkJZml4ZWRQb3NbY29udGFpbmVySW5mby52ZXJ0aWNhbCA/ICJ0b3AiIDogImxlZnQiXSArPSBzY3JvbGxEaXN0YW5jZTsNCg0KCQkJCQkvLyBzZXQgbmV3IHZhbHVlcw0KCQkJCQlfcGluLmNzcyh7DQoJCQkJCQl0b3A6IGZpeGVkUG9zLnRvcCwNCgkJCQkJCWxlZnQ6IGZpeGVkUG9zLmxlZnQNCgkJCQkJfSk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJLy8gdW5waW5uZWQgc3RhdGUNCgkJCQkJdmFyDQoJCQkJCQluZXdDU1MgPSB7DQoJCQkJCQkJcG9zaXRpb246IF9waW5PcHRpb25zLmluRmxvdyA/ICJyZWxhdGl2ZSIgOiAiYWJzb2x1dGUiLA0KCQkJCQkJCXRvcDogIDAsDQoJCQkJCQkJbGVmdDogMA0KCQkJCQkJfSwNCgkJCQkJCWNoYW5nZSA9IF9waW4uY3NzKCJwb3NpdGlvbiIpICE9IG5ld0NTUy5wb3NpdGlvbjsNCgkJCQkJDQoJCQkJCWlmICghX3Bpbk9wdGlvbnMucHVzaEZvbGxvd2Vycykgew0KCQkJCQkJbmV3Q1NTW2NvbnRhaW5lckluZm8udmVydGljYWwgPyAidG9wIiA6ICJsZWZ0Il0gPSBfb3B0aW9ucy5kdXJhdGlvbiAqIF9wcm9ncmVzczsNCgkJCQkJfSBlbHNlIGlmIChfb3B0aW9ucy5kdXJhdGlvbiA+IDApIHsgLy8gb25seSBjb25jZXJucyBzY2VuZXMgd2l0aCBkdXJhdGlvbg0KCQkJCQkJaWYgKF9zdGF0ZSA9PT0gIkFGVEVSIiAmYW1wOyZhbXA7IHBhcnNlRmxvYXQoX3Bpbk9wdGlvbnMuc3BhY2VyLmNzcygicGFkZGluZy10b3AiKSkgPT09IDApIHsNCgkJCQkJCQljaGFuZ2UgPSB0cnVlOyAvLyBpZiBpbiBhZnRlciBzdGF0ZSBidXQgaGF2ZW50IHVwZGF0ZWQgc3BhY2VyIHlldCAoanVtcGVkIHBhc3QgcGluKQ0KCQkJCQkJfSBlbHNlIGlmIChfc3RhdGUgPT09ICJCRUZPUkUiICZhbXA7JmFtcDsgcGFyc2VGbG9hdChfcGluT3B0aW9ucy5zcGFjZXIuY3NzKCJwYWRkaW5nLWJvdHRvbSIpKSA9PT0gMCkgeyAvLyBiZWZvcmUNCgkJCQkJCQljaGFuZ2UgPSB0cnVlOyAvLyBqdW1wZWQgcGFzdCBmaXhlZCBzdGF0ZSB1cHdhcmQgZGlyZWN0aW9uDQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJLy8gc2V0IG5ldyB2YWx1ZXMNCgkJCQkJX3Bpbi5jc3MobmV3Q1NTKTsNCgkJCQkJaWYgKGNoYW5nZSkgew0KCQkJCQkJLy8gcmVtb3ZlIHBpbm5lZCBjbGFzcw0KCQkJCQkJX3Bpbi5yZW1vdmVDbGFzcyhfcGluT3B0aW9ucy5waW5uZWRDbGFzcyk7DQoJCQkJCQkvLyB1cGRhdGUgcGluIHNwYWNlciBpZiBzdGF0ZSBjaGFuZ2VkDQoJCQkJCQl1cGRhdGVQaW5TcGFjZXJTaXplKCk7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZSB0aGUgcGluIHNwYWNlciBzaXplLg0KCQkgKiBUaGUgc2l6ZSBvZiB0aGUgc3BhY2VyIG5lZWRzIHRvIGJlIHVwZGF0ZWQgd2hlbmV2ZXIgdGhlIGR1cmF0aW9uIG9mIHRoZSBzY2VuZSBjaGFuZ2VzLCBpZiBpdCBpcyB0byBwdXNoIGRvd24gZm9sbG93aW5nIGVsZW1lbnRzLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIHVwZGF0ZVBpblNwYWNlclNpemUgPSBmdW5jdGlvbiAoKSB7DQoJCQlpZiAoX3BpbiAmYW1wOyZhbXA7IF9wYXJlbnQgJmFtcDsmYW1wOyBfcGluT3B0aW9ucy5pbkZsb3cpIHsgLy8gbm8gc3BhY2VycmVzaXplLCBpZiBvcmlnaW5hbCBwb3NpdGlvbiBpcyBhYnNvbHV0ZQ0KCQkJCXZhcg0KCQkJCQlhZnRlciA9IChfc3RhdGUgPT09ICJBRlRFUiIpLA0KCQkJCQliZWZvcmUgPSAoX3N0YXRlID09PSAiQkVGT1JFIiksDQoJCQkJCWR1cmluZyA9IChfc3RhdGUgPT09ICJEVVJJTkciKSwNCgkJCQkJcGlubmVkID0gKF9waW4uY3NzKCJwb3NpdGlvbiIpID09ICJmaXhlZCIpLA0KCQkJCQl2ZXJ0aWNhbCA9IF9wYXJlbnQuaW5mbygidmVydGljYWwiKSwNCgkJCQkJJHNwYWNlcmNvbnRlbnQgPSBfcGluT3B0aW9ucy5zcGFjZXIuY2hpbGRyZW4oKS5maXJzdCgpLCAvLyB1c3VhbGx5IHRoZSBwaW5lZCBlbGVtZW50IGJ1dCBjYW4gYWxzbyBiZSBhbm90aGVyIHNwYWNlciAoY2FzY2FkZWQgcGlucykNCgkJCQkJbWFyZ2luQ29sbGFwc2UgPSBpc01hcmdpbkNvbGxhcHNlVHlwZShfcGluT3B0aW9ucy5zcGFjZXIuY3NzKCJkaXNwbGF5IikpLA0KCQkJCQljc3MgPSB7fTsNCg0KCQkJCWlmIChtYXJnaW5Db2xsYXBzZSkgew0KCQkJCQljc3NbIm1hcmdpbi10b3AiXSA9IGJlZm9yZSB8fCAoZHVyaW5nICZhbXA7JmFtcDsgcGlubmVkKSA/IF9waW4uY3NzKCJtYXJnaW4tdG9wIikgOiAiYXV0byI7DQoJCQkJCWNzc1sibWFyZ2luLWJvdHRvbSJdID0gYWZ0ZXIgfHwgKGR1cmluZyAmYW1wOyZhbXA7IHBpbm5lZCkgPyBfcGluLmNzcygibWFyZ2luLWJvdHRvbSIpIDogImF1dG8iOw0KCQkJCX0gZWxzZSB7DQoJCQkJCWNzc1sibWFyZ2luLXRvcCJdID0gY3NzWyJtYXJnaW4tYm90dG9tIl0gPSAiYXV0byI7DQoJCQkJfQ0KDQoJCQkJLy8gc2V0IG5ldyBzaXplDQoJCQkJLy8gaWYgcmVsc2l6ZTogc3BhY2VyIC0+IHBpbiB8IGVsc2U6IHBpbiAtPiBzcGFjZXINCgkJCQlpZiAoX3Bpbk9wdGlvbnMucmVsU2l6ZS53aWR0aCB8fCBfcGluT3B0aW9ucy5yZWxTaXplLmF1dG9GdWxsV2lkdGgpIHsNCgkJCQkJaWYgKHBpbm5lZCkgew0KCQkJCQkJaWYgKCQod2luZG93KS53aWR0aCgpID09IF9waW5PcHRpb25zLnNwYWNlci5wYXJlbnQoKS53aWR0aCgpKSB7DQoJCQkJCQkJLy8gcmVsYXRpdmUgdG8gYm9keQ0KCQkJCQkJCV9waW4uY3NzKCJ3aWR0aCIsIF9waW5PcHRpb25zLnJlbFNpemUuYXV0b0Z1bGxXaWR0aCA/ICIxMDAlIiA6ICJpbmhlcml0Iik7DQoJCQkJCQl9IGVsc2Ugew0KCQkJCQkJCS8vIG5vdCByZWxhdGl2ZSB0byBib2R5IC0+IG5lZWQgdG8gY2FsY3VsYXRlDQoJCQkJCQkJX3Bpbi5jc3MoIndpZHRoIiwgX3Bpbk9wdGlvbnMuc3BhY2VyLndpZHRoKCkpOw0KCQkJCQkJfQ0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJX3Bpbi5jc3MoIndpZHRoIiwgIjEwMCUiKTsNCgkJCQkJfQ0KCQkJCX0gZWxzZSB7DQoJCQkJCS8vIG1pbndpZHRoIGlzIG5lZWRlZCBmb3IgY2FzY2FkaW5nIHBpbnMuDQoJCQkJCS8vIG1hcmdpbiBpcyBvbmx5IGluY2x1ZGVkIGlmIGl0J3MgYSBjYXNjYWRlZCBwaW4gdG8gcmVzb2x2ZSBhbiBJRTkgYnVnDQoJCQkJCWNzc1sibWluLXdpZHRoIl0gPSAkc3BhY2VyY29udGVudC5vdXRlcldpZHRoKCEkc3BhY2VyY29udGVudC5pcyhfcGluKSk7DQoJCQkJCWNzcy53aWR0aCA9IHBpbm5lZCA/IGNzc1sibWluLXdpZHRoIl0gOiAiYXV0byI7DQoJCQkJfQ0KCQkJCWlmIChfcGluT3B0aW9ucy5yZWxTaXplLmhlaWdodCkgew0KCQkJCQlpZiAocGlubmVkKSB7DQoJCQkJCQlpZiAoJCh3aW5kb3cpLmhlaWdodCgpID09IF9waW5PcHRpb25zLnNwYWNlci5wYXJlbnQoKS5oZWlnaHQoKSkgew0KCQkJCQkJCS8vIHJlbGF0aXZlIHRvIGJvZHkNCgkJCQkJCQlfcGluLmNzcygiaGVpZ2h0IiwgImluaGVyaXQiKTsNCgkJCQkJCX0gZWxzZSB7DQoJCQkJCQkJLy8gbm90IHJlbGF0aXZlIHRvIGJvZHkgLT4gbmVlZCB0byBjYWxjdWxhdGUNCgkJCQkJCQlfcGluLmNzcygiaGVpZ2h0IiwgX3Bpbk9wdGlvbnMuc3BhY2VyLmhlaWdodCgpKTsNCgkJCQkJCX0NCgkJCQkJfSBlbHNlIHsNCgkJCQkJCV9waW4uY3NzKCJoZWlnaHQiLCAiMTAwJSIpOw0KCQkJCQl9DQoJCQkJfSBlbHNlIHsNCgkJCQkJY3NzWyJtaW4taGVpZ2h0Il0gPSAkc3BhY2VyY29udGVudC5vdXRlckhlaWdodCghbWFyZ2luQ29sbGFwc2UpOyAvLyBuZWVkZWQgZm9yIGNhc2NhZGluZyBwaW5zDQoJCQkJCWNzcy5oZWlnaHQgPSBwaW5uZWQgPyBjc3NbIm1pbi1oZWlnaHQiXSA6ICJhdXRvIjsNCgkJCQl9DQoNCgkJCQkvLyBhZGQgc3BhY2UgZm9yIGR1cmF0aW9uIGlmIHB1c2hGb2xsb3dlcnMgaXMgdHJ1ZQ0KCQkJCWlmIChfcGluT3B0aW9ucy5wdXNoRm9sbG93ZXJzKSB7DQoJCQkJCWNzc1sicGFkZGluZyIgKyAodmVydGljYWwgPyAiVG9wIiA6ICJMZWZ0IildID0gX29wdGlvbnMuZHVyYXRpb24gKiBfcHJvZ3Jlc3M7DQoJCQkJCWNzc1sicGFkZGluZyIgKyAodmVydGljYWwgPyAiQm90dG9tIiA6ICJSaWdodCIpXSA9IF9vcHRpb25zLmR1cmF0aW9uICogKDEgLSBfcHJvZ3Jlc3MpOw0KCQkJCX0NCgkJCQlfcGluT3B0aW9ucy5zcGFjZXIuY3NzKGNzcyk7DQoJCQl9DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZXMgdGhlIFBpbiBzdGF0ZSAoaW4gY2VydGFpbiBzY2VuYXJpb3MpDQoJCSAqIElmIHRoZSBjb250cm9sbGVyIGNvbnRhaW5lciBpcyBub3QgdGhlIGRvY3VtZW50IGFuZCB3ZSBhcmUgbWlkLXBpbi1waGFzZSBzY3JvbGxpbmcgb3IgcmVzaXppbmcgdGhlIG1haW4gZG9jdW1lbnQgY2FuIHJlc3VsdCB0byB3cm9uZyBwaW4gcG9zaXRpb25zLg0KCQkgKiBTbyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbiByZXNpemUgYW5kIHNjcm9sbCBvZiB0aGUgZG9jdW1lbnQuDQoJCSAqIEBwcml2YXRlDQoJCSAqLw0KCQl2YXIgdXBkYXRlUGluSW5Db250YWluZXIgPSBmdW5jdGlvbiAoKSB7DQoJCQlpZiAoX3BhcmVudCAmYW1wOyZhbXA7IF9waW4gJmFtcDsmYW1wOyBfc3RhdGUgPT09ICJEVVJJTkciICZhbXA7JmFtcDsgIV9wYXJlbnQuaW5mbygiaXNEb2N1bWVudCIpKSB7DQoJCQkJdXBkYXRlUGluU3RhdGUoKTsNCgkJCX0NCgkJfTsNCg0KCQkvKioNCgkJICogVXBkYXRlcyB0aGUgUGluIHNwYWNlciBzaXplIHN0YXRlIChpbiBjZXJ0YWluIHNjZW5hcmlvcykNCgkJICogSWYgY29udGFpbmVyIGlzIHJlc2l6ZWQgZHVyaW5nIHBpbiBhbmQgcmVsYXRpdmVseSBzaXplZCB0aGUgc2l6ZSBvZiB0aGUgcGluIG1pZ2h0IG5lZWQgdG8gYmUgdXBkYXRlZC4uLg0KCQkgKiBTbyB0aGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbiByZXNpemUgb2YgdGhlIGNvbnRhaW5lci4NCgkJICogQHByaXZhdGUNCgkJICovDQoJCXZhciB1cGRhdGVSZWxhdGl2ZVBpblNwYWNlciA9IGZ1bmN0aW9uICgpIHsNCgkJCWlmICggX3BhcmVudCAmYW1wOyZhbXA7IF9waW4gJmFtcDsmYW1wOyAvLyB3ZWxsLCBkdWgNCgkJCQkJX3N0YXRlID09PSAiRFVSSU5HIiAmYW1wOyZhbXA7IC8vIGVsZW1lbnQgaW4gcGlubmVkIHN0YXRlPw0KCQkJCQkoIC8vIGlzIHdpZHRoIG9yIGhlaWdodCByZWxhdGl2ZWx5IHNpemVkLCBidXQgbm90IGluIHJlbGF0aW9uIHRvIGJvZHk/IHRoZW4gd2UgbmVlZCB0byByZWNhbGMuDQoJCQkJCQkoKF9waW5PcHRpb25zLnJlbFNpemUud2lkdGggfHwgX3Bpbk9wdGlvbnMucmVsU2l6ZS5hdXRvRnVsbFdpZHRoKSAmYW1wOyZhbXA7ICQod2luZG93KS53aWR0aCgpICE9IF9waW5PcHRpb25zLnNwYWNlci5wYXJlbnQoKS53aWR0aCgpKSB8fA0KCQkJCQkJKF9waW5PcHRpb25zLnJlbFNpemUuaGVpZ2h0ICZhbXA7JmFtcDsgJCh3aW5kb3cpLmhlaWdodCgpICE9IF9waW5PcHRpb25zLnNwYWNlci5wYXJlbnQoKS5oZWlnaHQoKSkNCgkJCQkJKQ0KCQkJKSB7DQoJCQkJdXBkYXRlUGluU3BhY2VyU2l6ZSgpOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBJcyBjYWxsZWQsIHdoZW4gdGhlIG1vdXNld2hlbCBpcyB1c2VkIHdoaWxlIG92ZXIgYSBwaW5uZWQgZWxlbWVudCBpbnNpZGUgYSBkaXYgY29udGFpbmVyLg0KCQkgKiBJZiB0aGUgc2NlbmUgaXMgaW4gZml4ZWQgc3RhdGUgc2Nyb2xsIGV2ZW50cyB3b3VsZCBiZSBjb3VudGVkIHRvd2FyZHMgdGhlIGJvZHkuIFRoaXMgZm9yd2FyZHMgdGhlIGV2ZW50IHRvIHRoZSBzY3JvbGwgY29udGFpbmVyLg0KCQkgKiBAcHJpdmF0ZQ0KCQkgKi8NCgkJdmFyIG9uTW91c2V3aGVlbE92ZXJQaW4gPSBmdW5jdGlvbiAoZSkgew0KCQkJaWYgKF9wYXJlbnQgJmFtcDsmYW1wOyBfcGluICZhbXA7JmFtcDsgX3N0YXRlID09PSAiRFVSSU5HIiAmYW1wOyZhbXA7ICFfcGFyZW50LmluZm8oImlzRG9jdW1lbnQiKSkgeyAvLyBpbiBwaW4gc3RhdGUNCgkJCQllLnByZXZlbnREZWZhdWx0KCk7DQoJCQkJX3BhcmVudC5zY3JvbGxUbyhfcGFyZW50LmluZm8oInNjcm9sbFBvcyIpIC0gKGUub3JpZ2luYWxFdmVudC53aGVlbERlbHRhLzMgfHwgLWUub3JpZ2luYWxFdmVudC5kZXRhaWwqMzApKTsNCgkJCX0NCgkJfTsNCg0KDQoJCS8qDQoJCSAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0NCgkJICogcHVibGljIGZ1bmN0aW9ucyAoZ2V0dGVycy9zZXR0ZXJzKQ0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqLw0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIHRoZSBwYXJlbnQgY29udHJvbGxlci4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIHBhcmVudCBjb250cm9sbGVyIG9mIGEgc2NlbmUNCgkJICogdmFyIGNvbnRyb2xsZXIgPSBzY2VuZS5wYXJlbnQoKTsNCgkJICoNCgkJICogQHJldHVybnMge1Njcm9sbE1hZ2ljfSBQYXJlbnQgY29udHJvbGxlciBvciBgdW5kZWZpbmVkYA0KCQkgKi8NCgkJdGhpcy5wYXJlbnQgPSBmdW5jdGlvbiAoKSB7DQoJCQlyZXR1cm4gX3BhcmVudDsNCgkJfTsNCg0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIGR1cmF0aW9uIG9wdGlvbiB2YWx1ZS4NCgkJICogQXMgYSBzZXR0ZXIgaXQgYWxzbyBhY2NlcHRzIGEgZnVuY3Rpb24gcmV0dXJuaW5nIGEgbnVtZXJpYyB2YWx1ZS4gIA0KCQkgKiBUaGlzIGlzIHBhcnRpY3VsYXJseSB1c2VmdWwgZm9yIHJlc3BvbnNpdmUgc2V0dXBzLg0KCQkgKg0KCQkgKiBUaGUgZHVyYXRpb24gaXMgdXBkYXRlZCB1c2luZyB0aGUgc3VwcGxpZWQgZnVuY3Rpb24gZXZlcnkgdGltZSBgU2Nyb2xsU2NlbmUucmVmcmVzaCgpYCBpcyBjYWxsZWQsIHdoaWNoIGhhcHBlbnMgcGVyaW9kaWNhbGx5IGZyb20gdGhlIGNvbnRyb2xsZXIgKHNlZSBTY3JvbGxNYWdpYyBvcHRpb24gYHJlZnJlc2hJbnRlcnZhbGApLiAgDQoJCSAqIF8qKk5PVEU6KiogQmUgYXdhcmUgdGhhdCBpdCdzIGFuIGVhc3kgd2F5IHRvIGtpbGwgcGVyZm9ybWFuY2UsIGlmIHlvdSBzdXBwbHkgYSBmdW5jdGlvbiB0aGF0IGhhcyBoaWdoIENQVSBkZW1hbmQuICANCgkJICogRXZlbiBmb3Igc2l6ZSBhbmQgcG9zaXRpb24gY2FsY3VsYXRpb25zIGl0IGlzIHJlY29tbWVuZGVkIHRvIHVzZSBhIHZhcmlhYmxlIHRvIGNhY2hlIHRoZSB2YWx1ZS4gKHNlZSBleGFtcGxlKSAgDQoJCSAqIFRoaXMgY291bnRzIGRvdWJsZSBpZiB5b3UgdXNlIHRoZSBzYW1lIGZ1bmN0aW9uIGZvciBtdWx0aXBsZSBzY2VuZXMuXw0KCQkgKg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCBkdXJhdGlvbiB2YWx1ZQ0KCQkgKiB2YXIgZHVyYXRpb24gPSBzY2VuZS5kdXJhdGlvbigpOw0KCQkgKg0KCSAJICogLy8gc2V0IGEgbmV3IGR1cmF0aW9uDQoJCSAqIHNjZW5lLmR1cmF0aW9uKDMwMCk7DQoJCSAqDQoJCSAqIC8vIHVzZSBhIGZ1bmN0aW9uIHRvIGF1dG9tYXRpY2FsbHkgYWRqdXN0IHRoZSBkdXJhdGlvbiB0byB0aGUgd2luZG93IGhlaWdodC4NCgkJICogdmFyIGR1cmF0aW9uVmFsdWVDYWNoZTsNCgkJICogZnVuY3Rpb24gZ2V0RHVyYXRpb24gKCkgew0KCQkgKiAgIHJldHVybiBkdXJhdGlvblZhbHVlQ2FjaGU7DQoJCSAqIH0NCgkJICogZnVuY3Rpb24gdXBkYXRlRHVyYXRpb24gKGUpIHsNCgkJICogICBkdXJhdGlvblZhbHVlQ2FjaGUgPSAkKHdpbmRvdykuaW5uZXJIZWlnaHQoKTsNCgkJICogfQ0KCQkgKiAkKHdpbmRvdykub24oInJlc2l6ZSIsIHVwZGF0ZUR1cmF0aW9uKTsgLy8gdXBkYXRlIHRoZSBkdXJhdGlvbiB3aGVuIHRoZSB3aW5kb3cgc2l6ZSBjaGFuZ2VzDQoJCSAqICQod2luZG93KS50cmlnZ2VySGFuZGxlcigicmVzaXplIik7IC8vIHNldCB0byBpbml0aWFsIHZhbHVlDQoJCSAqIHNjZW5lLmR1cmF0aW9uKGdldER1cmF0aW9uKTsgLy8gc3VwcGx5IGR1cmF0aW9uIG1ldGhvZA0KCQkgKg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zaGlmdH0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQHBhcmFtIHsobnVtYmVyfGZ1bmN0aW9uKX0gW25ld0R1cmF0aW9uXSAtIFRoZSBuZXcgZHVyYXRpb24gb2YgdGhlIHNjZW5lLg0KCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBgZ2V0YCAtICBDdXJyZW50IHNjZW5lIGR1cmF0aW9uLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IGBzZXRgIC0gIFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5kdXJhdGlvbiA9IGZ1bmN0aW9uIChuZXdEdXJhdGlvbikgew0KCQkJdmFyIHZhcm5hbWUgPSAiZHVyYXRpb24iOw0KCQkJaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7IC8vIGdldA0KCQkJCXJldHVybiBfb3B0aW9uc1t2YXJuYW1lXTsNCgkJCX0gZWxzZSB7DQoJCQkJaWYgKCEkLmlzRnVuY3Rpb24obmV3RHVyYXRpb24pKSB7DQoJCQkJCV9kdXJhdGlvblVwZGF0ZU1ldGhvZCA9IHVuZGVmaW5lZDsNCgkJCQl9DQoJCQkJaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdEdXJhdGlvbikpIHsgLy8gc2V0DQoJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoImNoYW5nZSIsIHt3aGF0OiB2YXJuYW1lLCBuZXd2YWw6IF9vcHRpb25zW3Zhcm5hbWVdfSk7DQoJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogdmFybmFtZX0pOw0KCQkJCX0NCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSBvZmZzZXQgb3B0aW9uIHZhbHVlLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCBvZmZzZXQNCgkJICogdmFyIG9mZnNldCA9IHNjZW5lLm9mZnNldCgpOw0KCQkgKg0KCSAJICogLy8gc2V0IGEgbmV3IG9mZnNldA0KCQkgKiBzY2VuZS5vZmZzZXQoMTAwKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuc2hpZnR9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBwYXJhbSB7bnVtYmVyfSBbbmV3T2Zmc2V0XSAtIFRoZSBuZXcgb2Zmc2V0IG9mIHRoZSBzY2VuZS4NCgkJICogQHJldHVybnMge251bWJlcn0gYGdldGAgLSAgQ3VycmVudCBzY2VuZSBvZmZzZXQuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gYHNldGAgLSAgUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLm9mZnNldCA9IGZ1bmN0aW9uIChuZXdPZmZzZXQpIHsNCgkJCXZhciB2YXJuYW1lID0gIm9mZnNldCI7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJfSBlbHNlIGlmIChjaGFuZ2VPcHRpb24odmFybmFtZSwgbmV3T2Zmc2V0KSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogdmFybmFtZX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIHRyaWdnZXJFbGVtZW50IG9wdGlvbiB2YWx1ZS4NCgkJICogRG9lcyAqKm5vdCoqIGZpcmUgYFNjcm9sbFNjZW5lLnNoaWZ0YCwgYmVjYXVzZSBjaGFuZ2luZyB0aGUgdHJpZ2dlciBFbGVtZW50IGRvZXNuJ3QgbmVjZXNzYXJpbHkgbWVhbiB0aGUgc3RhcnQgcG9zaXRpb24gY2hhbmdlcy4gVGhpcyB3aWxsIGJlIGRldGVybWluZWQgaW4gYFNjcm9sbFNjZW5lLnJlZnJlc2goKWAsIHdoaWNoIGlzIGF1dG9tYXRpY2FsbHkgdHJpZ2dlcmVkLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCB0cmlnZ2VyRWxlbWVudA0KCQkgKiB2YXIgdHJpZ2dlckVsZW1lbnQgPSBzY2VuZS50cmlnZ2VyRWxlbWVudCgpOw0KCQkgKg0KCSAJICogLy8gc2V0IGEgbmV3IHRyaWdnZXJFbGVtZW50IHVzaW5nIGEgc2VsZWN0b3INCgkJICogc2NlbmUudHJpZ2dlckVsZW1lbnQoIiN0cmlnZ2VyIik7DQoJIAkgKiAvLyBzZXQgYSBuZXcgdHJpZ2dlckVsZW1lbnQgdXNpbmcgYSBqUXVlcnkgT2JqZWN0DQoJCSAqIHNjZW5lLnRyaWdnZXJFbGVtZW50KCQoIiN0cmlnZ2VyIikpOw0KCSAJICogLy8gc2V0IGEgbmV3IHRyaWdnZXJFbGVtZW50IHVzaW5nIGEgRE9NIG9iamVjdA0KCQkgKiBzY2VuZS50cmlnZ2VyRWxlbWVudChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgidHJpZ2dlciIpKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpfSBbbmV3VHJpZ2dlckVsZW1lbnRdIC0gVGhlIG5ldyB0cmlnZ2VyIGVsZW1lbnQgZm9yIHRoZSBzY2VuZS4NCgkJICogQHJldHVybnMgeyhzdHJpbmd8b2JqZWN0KX0gYGdldGAgLSAgQ3VycmVudCB0cmlnZ2VyRWxlbWVudC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudHJpZ2dlckVsZW1lbnQgPSBmdW5jdGlvbiAobmV3VHJpZ2dlckVsZW1lbnQpIHsNCgkJCXZhciB2YXJuYW1lID0gInRyaWdnZXJFbGVtZW50IjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX29wdGlvbnNbdmFybmFtZV07DQoJCQl9IGVsc2UgaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdUcmlnZ2VyRWxlbWVudCkpIHsgLy8gc2V0DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigiY2hhbmdlIiwge3doYXQ6IHZhcm5hbWUsIG5ld3ZhbDogX29wdGlvbnNbdmFybmFtZV19KTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSB0cmlnZ2VySG9vayBvcHRpb24gdmFsdWUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHRyaWdnZXJIb29rIHZhbHVlDQoJCSAqIHZhciB0cmlnZ2VySG9vayA9IHNjZW5lLnRyaWdnZXJIb29rKCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgYSBuZXcgdHJpZ2dlckhvb2sgdXNpbmcgYSBzdHJpbmcNCgkJICogc2NlbmUudHJpZ2dlckhvb2soIm9uTGVhdmUiKTsNCgkgCSAqIC8vIHNldCBhIG5ldyB0cmlnZ2VySG9vayB1c2luZyBhIG51bWJlcg0KCQkgKiBzY2VuZS50cmlnZ2VySG9vaygwLjcpOw0KCQkgKg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmNoYW5nZX0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zaGlmdH0sIHdoZW4gdXNlZCBhcyBzZXR0ZXINCgkJICogQHBhcmFtIHsobnVtYmVyfHN0cmluZyl9IFtuZXdUcmlnZ2VySG9va10gLSBUaGUgbmV3IHRyaWdnZXJIb29rIG9mIHRoZSBzY2VuZS4gU2VlIHtAbGluayBTY3JvbGxTY2VuZX0gcGFyYW1ldGVyIGRlc2NyaXB0aW9uIGZvciB2YWx1ZSBvcHRpb25zLg0KCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBgZ2V0YCAtICBDdXJyZW50IHRyaWdnZXJIb29rIChBTFdBWVMgbnVtZXJpY2FsKS4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudHJpZ2dlckhvb2sgPSBmdW5jdGlvbiAobmV3VHJpZ2dlckhvb2spIHsNCgkJCXZhciB2YXJuYW1lID0gInRyaWdnZXJIb29rIjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gJC5pc051bWVyaWMoX29wdGlvbnNbdmFybmFtZV0pID8gX29wdGlvbnNbdmFybmFtZV0gOiBUUklHR0VSX0hPT0tfVkFMVUVTW19vcHRpb25zW3Zhcm5hbWVdXTsNCgkJCX0gZWxzZSBpZiAoY2hhbmdlT3B0aW9uKHZhcm5hbWUsIG5ld1RyaWdnZXJIb29rKSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogdmFybmFtZX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIHJldmVyc2Ugb3B0aW9uIHZhbHVlLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCByZXZlcnNlIG9wdGlvbg0KCQkgKiB2YXIgcmV2ZXJzZSA9IHNjZW5lLnJldmVyc2UoKTsNCgkJICoNCgkgCSAqIC8vIHNldCBuZXcgcmV2ZXJzZSBvcHRpb24NCgkJICogc2NlbmUucmV2ZXJzZShmYWxzZSk7DQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuY2hhbmdlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZXdSZXZlcnNlXSAtIFRoZSBuZXcgcmV2ZXJzZSBzZXR0aW5nIG9mIHRoZSBzY2VuZS4NCgkJICogQHJldHVybnMge2Jvb2xlYW59IGBnZXRgIC0gIEN1cnJlbnQgcmV2ZXJzZSBvcHRpb24gdmFsdWUuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gYHNldGAgLSAgUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnJldmVyc2UgPSBmdW5jdGlvbiAobmV3UmV2ZXJzZSkgew0KCQkJdmFyIHZhcm5hbWUgPSAicmV2ZXJzZSI7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJfSBlbHNlIGlmIChjaGFuZ2VPcHRpb24odmFybmFtZSwgbmV3UmV2ZXJzZSkpIHsgLy8gc2V0DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigiY2hhbmdlIiwge3doYXQ6IHZhcm5hbWUsIG5ld3ZhbDogX29wdGlvbnNbdmFybmFtZV19KTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSB0d2VlbkNoYW5nZXMgb3B0aW9uIHZhbHVlLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCB0d2VlbkNoYW5nZXMgb3B0aW9uDQoJCSAqIHZhciB0d2VlbkNoYW5nZXMgPSBzY2VuZS50d2VlbkNoYW5nZXMoKTsNCgkJICoNCgkgCSAqIC8vIHNldCBuZXcgdHdlZW5DaGFuZ2VzIG9wdGlvbg0KCQkgKiBzY2VuZS50d2VlbkNoYW5nZXModHJ1ZSk7DQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuY2hhbmdlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZXdUd2VlbkNoYW5nZXNdIC0gVGhlIG5ldyB0d2VlbkNoYW5nZXMgc2V0dGluZyBvZiB0aGUgc2NlbmUuDQoJCSAqIEByZXR1cm5zIHtib29sZWFufSBgZ2V0YCAtICBDdXJyZW50IHR3ZWVuQ2hhbmdlcyBvcHRpb24gdmFsdWUuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gYHNldGAgLSAgUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnR3ZWVuQ2hhbmdlcyA9IGZ1bmN0aW9uIChuZXdUd2VlbkNoYW5nZXMpIHsNCgkJCXZhciB2YXJuYW1lID0gInR3ZWVuQ2hhbmdlcyI7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9vcHRpb25zW3Zhcm5hbWVdOw0KCQkJfSBlbHNlIGlmIChjaGFuZ2VPcHRpb24odmFybmFtZSwgbmV3VHdlZW5DaGFuZ2VzKSkgeyAvLyBzZXQNCgkJCQlTY3JvbGxTY2VuZS50cmlnZ2VyKCJjaGFuZ2UiLCB7d2hhdDogdmFybmFtZSwgbmV3dmFsOiBfb3B0aW9uc1t2YXJuYW1lXX0pOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIG9yICoqU2V0KiogdGhlIGxvZ2xldmVsIG9wdGlvbiB2YWx1ZS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgbG9nbGV2ZWwNCgkJICogdmFyIGxvZ2xldmVsID0gc2NlbmUubG9nbGV2ZWwoKTsNCgkJICoNCgkgCSAqIC8vIHNldCBuZXcgbG9nbGV2ZWwNCgkJICogc2NlbmUubG9nbGV2ZWwoMyk7DQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuY2hhbmdlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAcGFyYW0ge251bWJlcn0gW25ld0xvZ2xldmVsXSAtIFRoZSBuZXcgbG9nbGV2ZWwgc2V0dGluZyBvZiB0aGUgc2NlbmUuIGBbMC0zXWANCgkJICogQHJldHVybnMge251bWJlcn0gYGdldGAgLSAgQ3VycmVudCBsb2dsZXZlbC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBgc2V0YCAtICBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMubG9nbGV2ZWwgPSBmdW5jdGlvbiAobmV3TG9nbGV2ZWwpIHsNCgkJCXZhciB2YXJuYW1lID0gImxvZ2xldmVsIjsNCgkJCWlmICghYXJndW1lbnRzLmxlbmd0aCkgeyAvLyBnZXQNCgkJCQlyZXR1cm4gX29wdGlvbnNbdmFybmFtZV07DQoJCQl9IGVsc2UgaWYgKGNoYW5nZU9wdGlvbih2YXJuYW1lLCBuZXdMb2dsZXZlbCkpIHsgLy8gc2V0DQoJCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigiY2hhbmdlIiwge3doYXQ6IHZhcm5hbWUsIG5ld3ZhbDogX29wdGlvbnNbdmFybmFtZV19KTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCgkJDQoJCS8qKg0KCQkgKiAqKkdldCoqIHRoZSBjdXJyZW50IHN0YXRlLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGdldCB0aGUgY3VycmVudCBzdGF0ZQ0KCQkgKiB2YXIgc3RhdGUgPSBzY2VuZS5zdGF0ZSgpOw0KCQkgKg0KCQkgKiBAcmV0dXJucyB7c3RyaW5nfSBgIkJFRk9SRSJgLCBgIkRVUklORyJgIG9yIGAiQUZURVIiYA0KCQkgKi8NCgkJdGhpcy5zdGF0ZSA9IGZ1bmN0aW9uICgpIHsNCgkJCXJldHVybiBfc3RhdGU7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIHRyaWdnZXIgcG9zaXRpb24gb2YgdGhlIHNjZW5lIChpbmNsdWRpbmcgdGhlIHZhbHVlIG9mIHRoZSBgb2Zmc2V0YCBvcHRpb24pLiAgDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBzY2VuZSdzIHRyaWdnZXIgcG9zaXRpb24NCgkJICogdmFyIHRyaWdnZXJQb3NpdGlvbiA9IHNjZW5lLnRyaWdnZXJQb3NpdGlvbigpOw0KCQkgKg0KCQkgKiBAcmV0dXJucyB7bnVtYmVyfSBTdGFydCBwb3NpdGlvbiBvZiB0aGUgc2NlbmUuIFRvcCBwb3NpdGlvbiB2YWx1ZSBmb3IgdmVydGljYWwgYW5kIGxlZnQgcG9zaXRpb24gdmFsdWUgZm9yIGhvcml6b250YWwgc2Nyb2xscy4NCgkJICovDQoJCXRoaXMudHJpZ2dlclBvc2l0aW9uID0gZnVuY3Rpb24gKCkgew0KCQkJdmFyIHBvcyA9IF9vcHRpb25zLm9mZnNldDsgLy8gdGhlIG9mZnNldCBpcyB0aGUgYmFzaXMNCgkJCWlmIChfcGFyZW50KSB7DQoJCQkJLy8gZ2V0IHRoZSB0cmlnZ2VyIHBvc2l0aW9uDQoJCQkJaWYgKF9vcHRpb25zLnRyaWdnZXJFbGVtZW50KSB7DQoJCQkJCS8vIEVsZW1lbnQgYXMgdHJpZ2dlcg0KCQkJCQlwb3MgKz0gX3RyaWdnZXJQb3M7DQoJCQkJfSBlbHNlIHsNCgkJCQkJLy8gcmV0dXJuIHRoZSBoZWlnaHQgb2YgdGhlIHRyaWdnZXJIb29rIHRvIHN0YXJ0IGF0IHRoZSBiZWdpbm5pbmcNCgkJCQkJcG9zICs9IF9wYXJlbnQuaW5mbygic2l6ZSIpICogU2Nyb2xsU2NlbmUudHJpZ2dlckhvb2soKTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gcG9zOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiAqKkdldCoqIHRoZSB0cmlnZ2VyIG9mZnNldCBvZiB0aGUgc2NlbmUgKGluY2x1ZGluZyB0aGUgdmFsdWUgb2YgdGhlIGBvZmZzZXRgIG9wdGlvbikuICANCgkJICogQHB1YmxpYw0KCQkgKiBAZGVwcmVjYXRlZCBNZXRob2QgaXMgZGVwcmVjYXRlZCBzaW5jZSAxLjEuMC4gWW91IHNob3VsZCBub3cgdXNlIHtAbGluayBTY3JvbGxTY2VuZS50cmlnZ2VyUG9zaXRpb259DQoJCSAqLw0KCQl0aGlzLnRyaWdnZXJPZmZzZXQgPSBmdW5jdGlvbiAoKSB7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmUudHJpZ2dlclBvc2l0aW9uKCk7DQoJCX07DQoNCgkJLyoqDQoJCSAqICoqR2V0KiogdGhlIGN1cnJlbnQgc2Nyb2xsIG9mZnNldCBmb3IgdGhlIHN0YXJ0IG9mIHRoZSBzY2VuZS4gIA0KCQkgKiBNaW5kLCB0aGF0IHRoZSBzY3JvbGxPZmZzZXQgaXMgcmVsYXRlZCB0byB0aGUgc2l6ZSBvZiB0aGUgY29udGFpbmVyLCBpZiBgdHJpZ2dlckhvb2tgIGlzIGJpZ2dlciB0aGFuIGAwYCAob3IgYCJvbkxlYXZlImApLiAgDQoJCSAqIFRoaXMgbWVhbnMsIHRoYXQgcmVzaXppbmcgdGhlIGNvbnRhaW5lciBvciBjaGFuZ2luZyB0aGUgYHRyaWdnZXJIb29rYCB3aWxsIGluZmx1ZW5jZSB0aGUgc2NlbmUncyBzdGFydCBvZmZzZXQuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHNjcm9sbCBvZmZzZXQgZm9yIHRoZSBzdGFydCBhbmQgZW5kIG9mIHRoZSBzY2VuZS4NCgkJICogdmFyIHN0YXJ0ID0gc2NlbmUuc2Nyb2xsT2Zmc2V0KCk7DQoJCSAqIHZhciBlbmQgPSBzY2VuZS5zY3JvbGxPZmZzZXQoKSArIHNjZW5lLmR1cmF0aW9uKCk7DQoJCSAqIGNvbnNvbGUubG9nKCJ0aGUgc2NlbmUgc3RhcnRzIGF0Iiwgc3RhcnQsICJhbmQgZW5kcyBhdCIsIGVuZCk7DQoJCSAqDQoJCSAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzY3JvbGwgb2Zmc2V0IChvZiB0aGUgY29udGFpbmVyKSBhdCB3aGljaCB0aGUgc2NlbmUgd2lsbCB0cmlnZ2VyLiBZIHZhbHVlIGZvciB2ZXJ0aWNhbCBhbmQgWCB2YWx1ZSBmb3IgaG9yaXpvbnRhbCBzY3JvbGxzLg0KCQkgKi8NCgkJdGhpcy5zY3JvbGxPZmZzZXQgPSBmdW5jdGlvbiAoKSB7DQoJCQlyZXR1cm4gX3Njcm9sbE9mZnNldC5zdGFydDsNCgkJfTsNCg0KCQkvKg0KCQkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJCSAqIHB1YmxpYyBmdW5jdGlvbnMgKHNjZW5lIG1vZGlmaWNhdGlvbikNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCg0KCQkvKioNCgkJICogVXBkYXRlcyB0aGUgU2NlbmUgaW4gdGhlIHBhcmVudCBDb250cm9sbGVyIHRvIHJlZmxlY3QgdGhlIGN1cnJlbnQgc3RhdGUuICANCgkJICogVGhpcyBpcyB0aGUgZXF1aXZhbGVudCB0byBgU2Nyb2xsTWFnaWMudXBkYXRlU2NlbmUoc2NlbmUsIGltbWVkaWF0ZWx5KWAuICANCgkJICogVGhlIHVwZGF0ZSBtZXRob2QgY2FsY3VsYXRlcyB0aGUgc2NlbmUncyBzdGFydCBhbmQgZW5kIHBvc2l0aW9uIChiYXNlZCBvbiB0aGUgdHJpZ2dlciBlbGVtZW50LCB0cmlnZ2VyIGhvb2ssIGR1cmF0aW9uIGFuZCBvZmZzZXQpIGFuZCBjaGVja3MgaXQgYWdhaW5zdCB0aGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGNvbnRhaW5lci4gIA0KCQkgKiBJdCB0aGVuIHVwZGF0ZXMgdGhlIGN1cnJlbnQgc2NlbmUgc3RhdGUgYWNjb3JkaW5nbHkgKG9yIGRvZXMgbm90aGluZywgaWYgdGhlIHN0YXRlIGlzIGFscmVhZHkgY29ycmVjdCkg4oCTIFBpbnMgd2lsbCBiZSBzZXQgdG8gdGhlaXIgY29ycmVjdCBwb3NpdGlvbiBhbmQgdHdlZW5zIHdpbGwgYmUgdXBkYXRlZCB0byB0aGVpciBjb3JyZWN0IHByb2dyZXNzLg0KCQkgKiBUaGlzIG1lYW5zIGFuIHVwZGF0ZSBkb2Vzbid0IG5lY2Vzc2FyaWx5IHJlc3VsdCBpbiBhIHByb2dyZXNzIGNoYW5nZS4gVGhlIGBwcm9ncmVzc2AgZXZlbnQgd2lsbCBiZSBmaXJlZCBpZiB0aGUgcHJvZ3Jlc3MgaGFzIGluZGVlZCBjaGFuZ2VkIGJldHdlZW4gdGhpcyB1cGRhdGUgYW5kIHRoZSBsYXN0LiAgDQoJCSAqIF8qKk5PVEU6KiogVGhpcyBtZXRob2QgZ2V0cyBjYWxsZWQgY29uc3RhbnRseSB3aGVuZXZlciBTY3JvbGxNYWdpYyBkZXRlY3RzIGEgY2hhbmdlLiBUaGUgb25seSBhcHBsaWNhdGlvbiBmb3IgeW91IGlzIGlmIHlvdSBjaGFuZ2Ugc29tZXRoaW5nIG91dHNpZGUgb2YgdGhlIHJlYWxtIG9mIFNjcm9sbE1hZ2ljLCBsaWtlIG1vdmluZyB0aGUgdHJpZ2dlciBvciBjaGFuZ2luZyB0d2VlbiBwYXJhbWV0ZXJzLl8NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyB1cGRhdGUgdGhlIHNjZW5lIG9uIG5leHQgdGljaw0KCQkgKiBzY2VuZS51cGRhdGUoKTsNCgkJICoNCgkJICogLy8gdXBkYXRlIHRoZSBzY2VuZSBpbW1lZGlhdGVseQ0KCQkgKiBzY2VuZS51cGRhdGUodHJ1ZSk7DQoJCSAqDQoJCSAqIEBmaXJlcyBTY3JvbGxTY2VuZS51cGRhdGUNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbaW1tZWRpYXRlbHk9ZmFsc2VdIC0gSWYgYHRydWVgIHRoZSB1cGRhdGUgd2lsbCBiZSBpbnN0YW50LCBpZiBgZmFsc2VgIGl0IHdpbGwgd2FpdCB1bnRpbCBuZXh0IHVwZGF0ZSBjeWNsZSAoYmV0dGVyIHBlcmZvcm1hbmNlKS4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMudXBkYXRlID0gZnVuY3Rpb24gKGltbWVkaWF0ZWx5KSB7DQoJCQlpZiAoX3BhcmVudCkgew0KCQkJCWlmIChpbW1lZGlhdGVseSkgew0KCQkJCQlpZiAoX3BhcmVudC5lbmFibGVkKCkgJmFtcDsmYW1wOyBfZW5hYmxlZCkgew0KCQkJCQkJdmFyDQoJCQkJCQkJc2Nyb2xsUG9zID0gX3BhcmVudC5pbmZvKCJzY3JvbGxQb3MiKSwNCgkJCQkJCQluZXdQcm9ncmVzczsNCg0KCQkJCQkJaWYgKF9vcHRpb25zLmR1cmF0aW9uID4gMCkgew0KCQkJCQkJCW5ld1Byb2dyZXNzID0gKHNjcm9sbFBvcyAtIF9zY3JvbGxPZmZzZXQuc3RhcnQpLyhfc2Nyb2xsT2Zmc2V0LmVuZCAtIF9zY3JvbGxPZmZzZXQuc3RhcnQpOw0KCQkJCQkJfSBlbHNlIHsNCgkJCQkJCQluZXdQcm9ncmVzcyA9IHNjcm9sbFBvcyA+PSBfc2Nyb2xsT2Zmc2V0LnN0YXJ0ID8gMSA6IDA7DQoJCQkJCQl9DQoNCgkJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInVwZGF0ZSIsIHtzdGFydFBvczogX3Njcm9sbE9mZnNldC5zdGFydCwgZW5kUG9zOiBfc2Nyb2xsT2Zmc2V0LmVuZCwgc2Nyb2xsUG9zOiBzY3JvbGxQb3N9KTsNCg0KCQkJCQkJU2Nyb2xsU2NlbmUucHJvZ3Jlc3MobmV3UHJvZ3Jlc3MpOw0KCQkJCQl9IGVsc2UgaWYgKF9waW4gJmFtcDsmYW1wOyBfc3RhdGUgPT09ICJEVVJJTkciKSB7DQoJCQkJCQl1cGRhdGVQaW5TdGF0ZSh0cnVlKTsgLy8gdW5waW4gaW4gcG9zaXRpb24NCgkJCQkJfQ0KCQkJCX0gZWxzZSB7DQoJCQkJCV9wYXJlbnQudXBkYXRlU2NlbmUoU2Nyb2xsU2NlbmUsIGZhbHNlKTsNCgkJCQl9DQoJCQl9DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFVwZGF0ZXMgZHluYW1pYyBzY2VuZSB2YXJpYWJsZXMgbGlrZSB0aGUgdHJpZ2dlciBlbGVtZW50IHBvc2l0aW9uIG9yIHRoZSBkdXJhdGlvbi4NCgkJICogVGhpcyBtZXRob2QgaXMgYXV0b21hdGljYWxseSBjYWxsZWQgaW4gcmVndWxhciBpbnRlcnZhbHMgZnJvbSB0aGUgY29udHJvbGxlci4gU2VlIHtAbGluayBTY3JvbGxNYWdpY30gb3B0aW9uIGByZWZyZXNoSW50ZXJ2YWxgLg0KCQkgKiANCgkJICogWW91IGNhbiBjYWxsIGl0IHRvIG1pbmltaXplIGxhZywgZm9yIGV4YW1wbGUgd2hlbiB5b3UgaW50ZW50aW9uYWxseSBjaGFuZ2UgdGhlIHBvc2l0aW9uIG9mIHRoZSB0cmlnZ2VyRWxlbWVudC4NCgkJICogSWYgeW91IGRvbid0IGl0IHdpbGwgc2ltcGx5IGJlIHVwZGF0ZWQgaW4gdGhlIG5leHQgcmVmcmVzaCBpbnRlcnZhbCBvZiB0aGUgY29udGFpbmVyLCB3aGljaCBpcyB1c3VhbGx5IHN1ZmZpY2llbnQuDQoJCSAqDQoJCSAqIEBwdWJsaWMNCgkJICogQHNpbmNlIDEuMS4wDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lID0gbmV3IFNjcm9sbFNjZW5lKHt0cmlnZ2VyRWxlbWVudDogIiN0cmlnZ2VyIn0pOw0KCQkgKiANCgkJICogLy8gY2hhbmdlIHRoZSBwb3NpdGlvbiBvZiB0aGUgdHJpZ2dlcg0KCQkgKiAkKCIjdHJpZ2dlciIpLmNzcygidG9wIiwgNTAwKTsNCgkJICogLy8gaW1tZWRpYXRlbHkgbGV0IHRoZSBzY2VuZSBrbm93IG9mIHRoaXMgY2hhbmdlDQoJCSAqIHNjZW5lLnJlZnJlc2goKTsNCgkJICoNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5zaGlmdH0sIGlmIHRoZSB0cmlnZ2VyIGVsZW1lbnQgcG9zaXRpb24gb3IgdGhlIGR1cmF0aW9uIGNoYW5nZWQNCgkJICogQGZpcmVzIHtAbGluayBTY3JvbGxTY2VuZS5jaGFuZ2V9LCBpZiB0aGUgZHVyYXRpb24gY2hhbmdlZA0KCQkgKg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZWZyZXNoID0gZnVuY3Rpb24gKCkgew0KCQkJdXBkYXRlRHVyYXRpb24oKTsNCgkJCXVwZGF0ZVRyaWdnZXJFbGVtZW50UG9zaXRpb24oKTsNCgkJCS8vIHVwZGF0ZSB0cmlnZ2VyIGVsZW1lbnQgcG9zaXRpb24NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSBzY2VuZSdzIHByb2dyZXNzLiAgDQoJCSAqIFVzdWFsbHkgaXQgc2hvdWxkbid0IGJlIG5lY2Vzc2FyeSB0byB1c2UgdGhpcyBhcyBhIHNldHRlciwgYXMgaXQgaXMgc2V0IGF1dG9tYXRpY2FsbHkgYnkgc2NlbmUudXBkYXRlKCkuICANCgkJICogVGhlIG9yZGVyIGluIHdoaWNoIHRoZSBldmVudHMgYXJlIGZpcmVkIGRlcGVuZHMgb24gdGhlIGR1cmF0aW9uIG9mIHRoZSBzY2VuZToNCgkJICogIDEuIFNjZW5lcyB3aXRoIGBkdXJhdGlvbiA9PSAwYDogIA0KCQkgKiAgU2NlbmVzIHRoYXQgaGF2ZSBubyBkdXJhdGlvbiBieSBkZWZpbml0aW9uIGhhdmUgbm8gZW5kaW5nLiBUaHVzIHRoZSBgZW5kYCBldmVudCB3aWxsIG5ldmVyIGJlIGZpcmVkLiAgDQoJCSAqICBXaGVuIHRoZSB0cmlnZ2VyIHBvc2l0aW9uIG9mIHRoZSBzY2VuZSBpcyBwYXNzZWQgdGhlIGV2ZW50cyBhcmUgYWx3YXlzIGZpcmVkIGluIHRoaXMgb3JkZXI6ICANCgkJICogIGBlbnRlcmAsIGBzdGFydGAsIGBwcm9ncmVzc2Agd2hlbiBzY3JvbGxpbmcgZm9yd2FyZCAgDQoJCSAqICBhbmQgIA0KCQkgKiAgYHByb2dyZXNzYCwgYHN0YXJ0YCwgYGxlYXZlYCB3aGVuIHNjcm9sbGluZyBpbiByZXZlcnNlDQoJCSAqICAyLiBTY2VuZXMgd2l0aCBgZHVyYXRpb24gPiAwYDogIA0KCQkgKiAgU2NlbmVzIHdpdGggYSBzZXQgZHVyYXRpb24gaGF2ZSBhIGRlZmluZWQgc3RhcnQgYW5kIGVuZCBwb2ludC4gIA0KCQkgKiAgV2hlbiBzY3JvbGxpbmcgcGFzdCB0aGUgc3RhcnQgcG9zaXRpb24gb2YgdGhlIHNjZW5lIGl0IHdpbGwgZmlyZSB0aGVzZSBldmVudHMgaW4gdGhpcyBvcmRlcjogIA0KCQkgKiAgYGVudGVyYCwgYHN0YXJ0YCwgYHByb2dyZXNzYCAgDQoJCSAqICBXaGVuIGNvbnRpbnVpbmcgdG8gc2Nyb2xsIGFuZCBwYXNzaW5nIHRoZSBlbmQgcG9pbnQgaXQgd2lsbCBmaXJlIHRoZXNlIGV2ZW50czogIA0KCQkgKiAgYHByb2dyZXNzYCwgYGVuZGAsIGBsZWF2ZWAgIA0KCQkgKiAgV2hlbiByZXZlcnNpbmcgdGhyb3VnaCB0aGUgZW5kIHBvaW50IHRoZXNlIGV2ZW50cyBhcmUgZmlyZWQ6ICANCgkJICogIGBlbnRlcmAsIGBlbmRgLCBgcHJvZ3Jlc3NgICANCgkJICogIEFuZCB3aGVuIGNvbnRpbnVpbmcgdG8gc2Nyb2xsIHBhc3QgdGhlIHN0YXJ0IHBvc2l0aW9uIGluIHJldmVyc2UgaXQgd2lsbCBmaXJlOiAgDQoJCSAqICBgcHJvZ3Jlc3NgLCBgc3RhcnRgLCBgbGVhdmVgICANCgkJICogIEluIGJldHdlZW4gc3RhcnQgYW5kIGVuZCB0aGUgYHByb2dyZXNzYCBldmVudCB3aWxsIGJlIGNhbGxlZCBjb25zdGFudGx5LCB3aGVuZXZlciB0aGUgcHJvZ3Jlc3MgY2hhbmdlcy4NCgkJICogDQoJCSAqIEluIHNob3J0OiAgDQoJCSAqIGBlbnRlcmAgZXZlbnRzIHdpbGwgYWx3YXlzIHRyaWdnZXIgKipiZWZvcmUqKiB0aGUgcHJvZ3Jlc3MgdXBkYXRlIGFuZCBgbGVhdmVgIGVudmVudHMgd2lsbCB0cmlnZ2VyICoqYWZ0ZXIqKiB0aGUgcHJvZ3Jlc3MgdXBkYXRlLiAgDQoJCSAqIGBzdGFydGAgYW5kIGBlbmRgIHdpbGwgYWx3YXlzIHRyaWdnZXIgYXQgdGhlaXIgcmVzcGVjdGl2ZSBwb3NpdGlvbi4NCgkJICogDQoJCSAqIFBsZWFzZSByZXZpZXcgdGhlIGV2ZW50IGRlc2NyaXB0aW9ucyBmb3IgZGV0YWlscyBvbiB0aGUgZXZlbnRzIGFuZCB0aGUgZXZlbnQgb2JqZWN0IHRoYXQgaXMgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4NCgkJICogDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZ2V0IHRoZSBjdXJyZW50IHNjZW5lIHByb2dyZXNzDQoJCSAqIHZhciBwcm9ncmVzcyA9IHNjZW5lLnByb2dyZXNzKCk7DQoJCSAqDQoJIAkgKiAvLyBzZXQgbmV3IHNjZW5lIHByb2dyZXNzDQoJCSAqIHNjZW5lLnByb2dyZXNzKDAuMyk7DQoJCSAqDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuZW50ZXJ9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuc3RhcnR9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUucHJvZ3Jlc3N9LCB3aGVuIHVzZWQgYXMgc2V0dGVyDQoJCSAqIEBmaXJlcyB7QGxpbmsgU2Nyb2xsU2NlbmUuZW5kfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKiBAZmlyZXMge0BsaW5rIFNjcm9sbFNjZW5lLmxlYXZlfSwgd2hlbiB1c2VkIGFzIHNldHRlcg0KCQkgKg0KCQkgKiBAcGFyYW0ge251bWJlcn0gW3Byb2dyZXNzXSAtIFRoZSBuZXcgcHJvZ3Jlc3MgdmFsdWUgb2YgdGhlIHNjZW5lIGBbMC0xXWAuDQoJCSAqIEByZXR1cm5zIHtudW1iZXJ9IGBnZXRgIC0gIEN1cnJlbnQgc2NlbmUgcHJvZ3Jlc3MuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gYHNldGAgLSAgUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnByb2dyZXNzID0gZnVuY3Rpb24gKHByb2dyZXNzKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9wcm9ncmVzczsNCgkJCX0gZWxzZSB7IC8vIHNldA0KCQkJCXZhcg0KCQkJCQlkb1VwZGF0ZSA9IGZhbHNlLA0KCQkJCQlvbGRTdGF0ZSA9IF9zdGF0ZSwNCgkJCQkJc2Nyb2xsRGlyZWN0aW9uID0gX3BhcmVudCA/IF9wYXJlbnQuaW5mbygic2Nyb2xsRGlyZWN0aW9uIikgOiAnUEFVU0VEJywNCgkJCQkJcmV2ZXJzZU9yRm9yd2FyZCA9IF9vcHRpb25zLnJldmVyc2UgfHwgcHJvZ3Jlc3MgPj0gX3Byb2dyZXNzOw0KCQkJCWlmIChfb3B0aW9ucy5kdXJhdGlvbiA9PT0gMCkgew0KCQkJCQkvLyB6ZXJvIGR1cmF0aW9uIHNjZW5lcw0KCQkJCQlkb1VwZGF0ZSA9IF9wcm9ncmVzcyAhPSBwcm9ncmVzczsNCgkJCQkJX3Byb2dyZXNzID0gcHJvZ3Jlc3MgJmx0OyAxICZhbXA7JmFtcDsgcmV2ZXJzZU9yRm9yd2FyZCA/IDAgOiAxOw0KCQkJCQlfc3RhdGUgPSBfcHJvZ3Jlc3MgPT09IDAgPyAnQkVGT1JFJyA6ICdEVVJJTkcnOw0KCQkJCX0gZWxzZSB7DQoJCQkJCS8vIHNjZW5lcyB3aXRoIHN0YXJ0IGFuZCBlbmQNCgkJCQkJaWYgKHByb2dyZXNzICZsdDs9IDAgJmFtcDsmYW1wOyBfc3RhdGUgIT09ICdCRUZPUkUnICZhbXA7JmFtcDsgcmV2ZXJzZU9yRm9yd2FyZCkgew0KCQkJCQkJLy8gZ28gYmFjayB0byBpbml0aWFsIHN0YXRlDQoJCQkJCQlfcHJvZ3Jlc3MgPSAwOw0KCQkJCQkJX3N0YXRlID0gJ0JFRk9SRSc7DQoJCQkJCQlkb1VwZGF0ZSA9IHRydWU7DQoJCQkJCX0gZWxzZSBpZiAocHJvZ3Jlc3MgPiAwICZhbXA7JmFtcDsgcHJvZ3Jlc3MgJmx0OyAxICZhbXA7JmFtcDsgcmV2ZXJzZU9yRm9yd2FyZCkgew0KCQkJCQkJX3Byb2dyZXNzID0gcHJvZ3Jlc3M7DQoJCQkJCQlfc3RhdGUgPSAnRFVSSU5HJzsNCgkJCQkJCWRvVXBkYXRlID0gdHJ1ZTsNCgkJCQkJfSBlbHNlIGlmIChwcm9ncmVzcyA+PSAxICZhbXA7JmFtcDsgX3N0YXRlICE9PSAnQUZURVInKSB7DQoJCQkJCQlfcHJvZ3Jlc3MgPSAxOw0KCQkJCQkJX3N0YXRlID0gJ0FGVEVSJzsNCgkJCQkJCWRvVXBkYXRlID0gdHJ1ZTsNCgkJCQkJfSBlbHNlIGlmIChfc3RhdGUgPT09ICdEVVJJTkcnICZhbXA7JmFtcDsgIXJldmVyc2VPckZvcndhcmQpIHsNCgkJCQkJCXVwZGF0ZVBpblN0YXRlKCk7IC8vIGluIGNhc2Ugd2Ugc2Nyb2xsZWQgYmFja3dhcmRzIG1pZC1zY2VuZSBhbmQgcmV2ZXJzZSBpcyBkaXNhYmxlZCA9PiB1cGRhdGUgdGhlIHBpbiBwb3NpdGlvbiwgc28gaXQgZG9lc24ndCBtb3ZlIGJhY2sgYXMgd2VsbC4NCgkJCQkJfQ0KCQkJCX0NCgkJCQlpZiAoZG9VcGRhdGUpIHsNCgkJCQkJLy8gZmlyZSBldmVudHMNCgkJCQkJdmFyDQoJCQkJCQlldmVudFZhcnMgPSB7cHJvZ3Jlc3M6IF9wcm9ncmVzcywgc3RhdGU6IF9zdGF0ZSwgc2Nyb2xsRGlyZWN0aW9uOiBzY3JvbGxEaXJlY3Rpb259LA0KCQkJCQkJc3RhdGVDaGFuZ2VkID0gX3N0YXRlICE9IG9sZFN0YXRlOw0KDQoJCQkJCXZhciB0cmlnZ2VyID0gZnVuY3Rpb24gKGV2ZW50TmFtZSkgeyAvLyB0bXAgaGVscGVyIHRvIHNpbXBsaWZ5IGNvZGUNCgkJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoZXZlbnROYW1lLCBldmVudFZhcnMpOw0KCQkJCQl9Ow0KDQoJCQkJCWlmIChzdGF0ZUNoYW5nZWQpIHsgLy8gZW50ZXIgZXZlbnRzDQoJCQkJCQlpZiAob2xkU3RhdGUgIT09ICdEVVJJTkcnKSB7DQoJCQkJCQkJdHJpZ2dlcigiZW50ZXIiKTsNCgkJCQkJCQl0cmlnZ2VyKG9sZFN0YXRlID09PSAnQkVGT1JFJyA/ICJzdGFydCIgOiAiZW5kIik7DQoJCQkJCQl9DQoJCQkJCX0NCgkJCQkJdHJpZ2dlcigicHJvZ3Jlc3MiKTsNCgkJCQkJaWYgKHN0YXRlQ2hhbmdlZCkgeyAvLyBsZWF2ZSBldmVudHMNCgkJCQkJCWlmIChfc3RhdGUgIT09ICdEVVJJTkcnKSB7DQoJCQkJCQkJdHJpZ2dlcihfc3RhdGUgPT09ICdCRUZPUkUnID8gInN0YXJ0IiA6ICJlbmQiKTsNCgkJCQkJCQl0cmlnZ2VyKCJsZWF2ZSIpOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfQ0KDQoJCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQkJfQ0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBBZGQgYSB0d2VlbiB0byB0aGUgc2NlbmUuICANCgkJICogSWYgeW91IHdhbnQgdG8gYWRkIG11bHRpcGxlIHR3ZWVucywgd3JhcCB0aGVtIGludG8gb25lIFRpbWVsaW5lTWF4IG9iamVjdCBhbmQgYWRkIGl0LiAgDQoJCSAqIFRoZSBkdXJhdGlvbiBvZiB0aGUgdHdlZW4gaXMgc3RyZWNoZWQgdG8gdGhlIHNjcm9sbCBkdXJhdGlvbiBvZiB0aGUgc2NlbmUsIHVubGVzcyB0aGUgc2NlbmUgaGFzIGEgZHVyYXRpb24gb2YgYDBgLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGFkZCBhIHNpbmdsZSB0d2Vlbg0KCQkgKiBzY2VuZS5zZXRUd2VlbihUd2Vlbk1heC50bygib2JqIiksIDEsIHt4OiAxMDB9KTsNCgkJICoNCgkJICogLy8gYWRkIG11bHRpcGxlIHR3ZWVucywgd3JhcHBlZCBpbiBhIHRpbWVsaW5lLg0KCQkgKiB2YXIgdGltZWxpbmUgPSBuZXcgVGltZWxpbmVNYXgoKTsNCgkJICogdmFyIHR3ZWVuMSA9IFR3ZWVuTWF4LmZyb20oIm9iajEiLCAxLCB7eDogMTAwfSk7DQoJCSAqIHZhciB0d2VlbjIgPSBUd2Vlbk1heC50bygib2JqMiIsIDEsIHt5OiAxMDB9KTsNCgkJICogdGltZWxpbmUNCgkJICoJCS5hZGQodHdlZW4xKQ0KCQkgKgkJLmFkZCh0d2VlbjIpOw0KCQkgKiBzY2VuZS5hZGRUd2Vlbih0aW1lbGluZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7b2JqZWN0fSBUd2Vlbk9iamVjdCAtIEEgVHdlZW5NYXgsIFR3ZWVuTGl0ZSwgVGltZWxpbmVNYXggb3IgVGltZWxpbmVMaXRlIG9iamVjdCB0aGF0IHNob3VsZCBiZSBhbmltYXRlZCBpbiB0aGUgc2NlbmUuDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnNldFR3ZWVuID0gZnVuY3Rpb24gKFR3ZWVuT2JqZWN0KSB7DQoJCQlpZiAoIVRpbWVsaW5lTWF4KSB7DQoJCQkJbG9nKDEsICJFUlJPUjogVGltZWxpbmVNYXggd2Fzbid0IGZvdW5kLiBQbGVhc2UgbWFrZSBzdXJlIEdTQVAgaXMgbG9hZGVkIGJlZm9yZSBTY3JvbGxNYWdpYyBvciB1c2UgYXN5bmNocm9ub3VzIGxvYWRpbmcuIik7DQoJCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQkJfQ0KCQkJaWYgKF90d2VlbikgeyAvLyBraWxsIG9sZCB0d2Vlbj8NCgkJCQlTY3JvbGxTY2VuZS5yZW1vdmVUd2VlbigpOw0KCQkJfQ0KCQkJdHJ5IHsNCgkJCQkvLyB3cmFwIFR3ZWVuIGludG8gYSBUaW1lbGluZU1heCBPYmplY3QgdG8gaW5jbHVkZSBkZWxheSBhbmQgcmVwZWF0cyBpbiB0aGUgZHVyYXRpb24gYW5kIHN0YW5kYXJkaXplIG1ldGhvZHMuDQoJCQkJX3R3ZWVuID0gbmV3IFRpbWVsaW5lTWF4KHtzbW9vdGhDaGlsZFRpbWluZzogdHJ1ZX0pDQoJCQkJCS5hZGQoVHdlZW5PYmplY3QpDQoJCQkJCS5wYXVzZSgpOw0KCQkJfSBjYXRjaCAoZSkgew0KCQkJCWxvZygxLCAiRVJST1IgY2FsbGluZyBtZXRob2QgJ3NldFR3ZWVuKCknOiBTdXBwbGllZCBhcmd1bWVudCBpcyBub3QgYSB2YWxpZCBUd2Vlbk9iamVjdCIpOw0KCQkJfSBmaW5hbGx5IHsNCgkJCQkvLyBzb21lIHByb3BlcnRpZXMgbmVlZCB0byBiZSB0cmFuc2ZlcnJlZCBpdCB0byB0aGUgd3JhcHBlciwgb3RoZXJ3aXNlIHRoZXkgd291bGQgZ2V0IGxvc3QuDQoJCQkJaWYgKFR3ZWVuT2JqZWN0LnJlcGVhdCAmYW1wOyZhbXA7IFR3ZWVuT2JqZWN0LnJlcGVhdCgpID09PSAtMSkgey8vIFR3ZWVuTWF4IG9yIFRpbWVsaW5lTWF4IE9iamVjdD8NCgkJCQkJX3R3ZWVuLnJlcGVhdCgtMSk7DQoJCQkJCV90d2Vlbi55b3lvKFR3ZWVuT2JqZWN0LnlveW8oKSk7DQoJCQkJfQ0KCQkJfQ0KCQkJLy8gU29tZSB0d2VlbiB2YWxpZGF0aW9ucyBhbmQgZGVidWdnaW5nIGhlbHBlcnMNCg0KCQkJLy8gY2hlY2sgaWYgdGhlcmUgYXJlIHBvc2l0aW9uIHR3ZWVucyBkZWZpbmVkIGZvciB0aGUgdHJpZ2dlciBhbmQgd2FybiBhYm91dCBpdCA6KQ0KCQkJaWYgKF90d2VlbiAmYW1wOyZhbXA7IF9wYXJlbnQgICZhbXA7JmFtcDsgX29wdGlvbnMudHJpZ2dlckVsZW1lbnQgJmFtcDsmYW1wOyBfb3B0aW9ucy5sb2dsZXZlbCA+PSAyKSB7Ly8gcGFyZW50IGlzIG5lZWRlZCB0byBrbm93IHNjcm9sbCBkaXJlY3Rpb24uDQoJCQkJdmFyDQoJCQkJCXRyaWdnZXJUd2VlbnMgPSBfdHdlZW4uZ2V0VHdlZW5zT2YoJChfb3B0aW9ucy50cmlnZ2VyRWxlbWVudCkpLA0KCQkJCQl2ZXJ0aWNhbCA9IF9wYXJlbnQuaW5mbygidmVydGljYWwiKTsNCgkJCQkkLmVhY2godHJpZ2dlclR3ZWVucywgZnVuY3Rpb24gKGluZGV4LCB2YWx1ZSkgew0KCQkJCQl2YXINCgkJCQkJCXR3ZWVudmFycyA9IHZhbHVlLnZhcnMuY3NzIHx8IHZhbHVlLnZhcnMsDQoJCQkJCQljb25kaXRpb24gPSB2ZXJ0aWNhbCA/ICh0d2VlbnZhcnMudG9wICE9PSB1bmRlZmluZWQgfHwgdHdlZW52YXJzLmJvdHRvbSAhPT0gdW5kZWZpbmVkKSA6ICh0d2VlbnZhcnMubGVmdCAhPT0gdW5kZWZpbmVkIHx8IHR3ZWVudmFycy5yaWdodCAhPT0gdW5kZWZpbmVkKTsNCgkJCQkJaWYgKGNvbmRpdGlvbikgew0KCQkJCQkJbG9nKDIsICJXQVJOSU5HOiBUd2VlbmluZyB0aGUgcG9zaXRpb24gb2YgdGhlIHRyaWdnZXIgZWxlbWVudCBhZmZlY3RzIHRoZSBzY2VuZSB0aW1pbmcgYW5kIHNob3VsZCBiZSBhdm9pZGVkISIpOw0KCQkJCQkJcmV0dXJuIGZhbHNlOw0KCQkJCQl9DQoJCQkJfSk7DQoJCQl9DQoNCgkJCS8vIHdhcm4gYWJvdXQgdHdlZW4gb3ZlcndyaXRlcywgd2hlbiBhbiBlbGVtZW50IGlzIHR3ZWVuZWQgbXVsdGlwbGUgdGltZXMNCgkJCWlmIChwYXJzZUZsb2F0KFR3ZWVuTGl0ZS52ZXJzaW9uKSA+PSAxLjE0KSB7IC8vIG9uT3ZlcndyaXRlIG9ubHkgcHJlc2VudCBzaW5jZSBHU0FQIHYxLjE0LjANCgkJCQl2YXINCgkJCQkJbGlzdCA9IF90d2Vlbi5nZXRDaGlsZHJlbih0cnVlLCB0cnVlLCBmYWxzZSksIC8vIGdldCBhbGwgbmVzdGVkIHR3ZWVuIG9iamVjdHMNCgkJCQkJbmV3Q2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7DQoJCQkJCQlsb2coMiwgIldBUk5JTkc6IHR3ZWVuIHdhcyBvdmVyd3JpdHRlbiBieSBhbm90aGVyLiBUbyBsZWFybiBob3cgdG8gYXZvaWQgdGhpcyBpc3N1ZSBzZWUgaGVyZTogaHR0cHM6Ly9naXRodWIuY29tL2phbnBhZXBrZS9TY3JvbGxNYWdpYy93aWtpL1dBUk5JTkc6LXR3ZWVuLXdhcy1vdmVyd3JpdHRlbi1ieS1hbm90aGVyIik7DQoJCQkJCX07DQoJCQkJZm9yICh2YXIgaT0wLCB0aGlzVHdlZW4sIG9sZENhbGxiYWNrOyBpJmx0O2xpc3QubGVuZ3RoOyBpKyspIHsNCgkJCQkJLypqc2hpbnQgbG9vcGZ1bmM6IHRydWUgKi8NCgkJCQkJdGhpc1R3ZWVuID0gbGlzdFtpXTsNCgkJCQkJaWYgKG9sZENhbGxiYWNrICE9PSBuZXdDYWxsYmFjaykgeyAvLyBpZiB0d2VlbnMgaXMgYWRkZWQgbW9yZSB0aGFuIG9uY2UNCgkJCQkJCW9sZENhbGxiYWNrID0gdGhpc1R3ZWVuLnZhcnMub25PdmVyd3JpdGU7DQoJCQkJCQl0aGlzVHdlZW4udmFycy5vbk92ZXJ3cml0ZSA9IGZ1bmN0aW9uICgpIHsNCgkJCQkJCQlpZiAob2xkQ2FsbGJhY2spIHsNCgkJCQkJCQkJb2xkQ2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCgkJCQkJCQl9DQoJCQkJCQkJbmV3Q2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCgkJCQkJCX07DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoJCQlsb2coMywgImFkZGVkIHR3ZWVuIik7DQoJCQl1cGRhdGVUd2VlblByb2dyZXNzKCk7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIFJlbW92ZSB0aGUgdHdlZW4gZnJvbSB0aGUgc2NlbmUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gcmVtb3ZlIHRoZSB0d2VlbiBmcm9tIHRoZSBzY2VuZSB3aXRob3V0IHJlc2V0dGluZyBpdA0KCQkgKiBzY2VuZS5yZW1vdmVUd2VlbigpOw0KCQkgKg0KCQkgKiAvLyByZW1vdmUgdGhlIHR3ZWVuIGZyb20gdGhlIHNjZW5lIGFuZCByZXNldCBpdCB0byBpbml0aWFsIHBvc2l0aW9uDQoJCSAqIHNjZW5lLnJlbW92ZVR3ZWVuKHRydWUpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldD1mYWxzZV0gLSBJZiBgdHJ1ZWAgdGhlIHR3ZWVuIHdpbGwgYmUgcmVzZXQgdG8gaXRzIGluaXRpYWwgdmFsdWVzLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZW1vdmVUd2VlbiA9IGZ1bmN0aW9uIChyZXNldCkgew0KCQkJaWYgKF90d2Vlbikgew0KCQkJCWlmIChyZXNldCkgew0KCQkJCQl1cGRhdGVUd2VlblByb2dyZXNzKDApOw0KCQkJCX0NCgkJCQlfdHdlZW4ua2lsbCgpOw0KCQkJCV90d2VlbiA9IHVuZGVmaW5lZDsNCgkJCQlsb2coMywgInJlbW92ZWQgdHdlZW4gKHJlc2V0OiAiICsgKHJlc2V0ID8gInRydWUiIDogImZhbHNlIikgKyAiKSIpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBQaW4gYW4gZWxlbWVudCBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSB0d2Vlbi4gIA0KCQkgKiBJZiB0aGUgc2NlbmUgZHVyYXRpb24gaXMgMCB0aGUgZWxlbWVudCB3aWxsIG9ubHkgYmUgdW5waW5uZWQsIGlmIHRoZSB1c2VyIHNjcm9sbHMgYmFjayBwYXN0IHRoZSBzdGFydCBwb3NpdGlvbi4gIA0KCQkgKiBfKipOT1RFOioqIFRoZSBvcHRpb24gYHB1c2hGb2xsb3dlcnNgIGhhcyBubyBlZmZlY3QsIHdoZW4gdGhlIHNjZW5lIGR1cmF0aW9uIGlzIDAuXw0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIHBpbiBlbGVtZW50IGFuZCBwdXNoIGFsbCBmb2xsb3dpbmcgZWxlbWVudHMgZG93biBieSB0aGUgYW1vdW50IG9mIHRoZSBwaW4gZHVyYXRpb24uDQoJCSAqIHNjZW5lLnNldFBpbigiI3BpbiIpOw0KCQkgKg0KCQkgKiAvLyBwaW4gZWxlbWVudCBhbmQga2VlcGluZyBhbGwgZm9sbG93aW5nIGVsZW1lbnRzIGluIHRoZWlyIHBsYWNlLiBUaGUgcGlubmVkIGVsZW1lbnQgd2lsbCBtb3ZlIHBhc3QgdGhlbS4NCgkJICogc2NlbmUuc2V0UGluKCIjcGluIiwge3B1c2hGb2xsb3dlcnM6IGZhbHNlfSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpfSBlbGVtZW50IC0gQSBTZWxlY3RvciB0YXJnZXRpbmcgYW4gZWxlbWVudCwgYSBET00gb2JqZWN0IG9yIGEgalF1ZXJ5IG9iamVjdCB0aGF0IGlzIHN1cHBvc2VkIHRvIGJlIHBpbm5lZC4NCgkJICogQHBhcmFtIHtvYmplY3R9IFtzZXR0aW5nc10gLSBzZXR0aW5ncyBmb3IgdGhlIHBpbg0KCQkgKiBAcGFyYW0ge2Jvb2xlYW59IFtzZXR0aW5ncy5wdXNoRm9sbG93ZXJzPXRydWVdIC0gSWYgYHRydWVgIGZvbGxvd2luZyBlbGVtZW50cyB3aWxsIGJlICJwdXNoZWQiIGRvd24gZm9yIHRoZSBkdXJhdGlvbiBvZiB0aGUgcGluLCBpZiBgZmFsc2VgIHRoZSBwaW5uZWQgZWxlbWVudCB3aWxsIGp1c3Qgc2Nyb2xsIHBhc3QgdGhlbS4gIA0KCQkgCQkJCQkJCQkJCQkJICAgSWdub3JlZCwgd2hlbiBkdXJhdGlvbiBpcyBgMGAuDQoJCSAqIEBwYXJhbSB7c3RyaW5nfSBbc2V0dGluZ3Muc3BhY2VyQ2xhc3M9InNjcm9sbG1hZ2ljLXBpbi1zcGFjZXIiXSAtIENsYXNzbmFtZSBvZiB0aGUgcGluIHNwYWNlciBlbGVtZW50LCB3aGljaCBpcyB1c2VkIHRvIHJlcGxhY2UgdGhlIGVsZW1lbnQuICANCgkJICogQHBhcmFtIHtzdHJpbmd9IFtzZXR0aW5ncy5waW5uZWRDbGFzcz0iIl0gLSBDbGFzc25hbWUgdGhhdCBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIHBpbm5lZCBlbGVtZW50IGR1cmluZyBwaW4gcGhhc2UgKGFuZCByZW1vdmVkIGFmdGVyKS4NCgkJICoNCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuc2V0UGluID0gZnVuY3Rpb24gKGVsZW1lbnQsIHNldHRpbmdzKSB7DQoJCQl2YXINCgkJCQlkZWZhdWx0U2V0dGluZ3MgPSB7DQoJCQkJCXB1c2hGb2xsb3dlcnM6IHRydWUsDQoJCQkJCXNwYWNlckNsYXNzOiAic2Nyb2xsbWFnaWMtcGluLXNwYWNlciIsDQoJCQkJCXBpbm5lZENsYXNzOiAiIg0KCQkJCX07DQoJCQlzZXR0aW5ncyA9ICQuZXh0ZW5kKHt9LCBkZWZhdWx0U2V0dGluZ3MsIHNldHRpbmdzKTsNCg0KCQkJLy8gdmFsaWRhdGUgRWxlbWVudA0KCQkJZWxlbWVudCA9ICQoZWxlbWVudCkuZmlyc3QoKTsNCgkJCWlmIChlbGVtZW50Lmxlbmd0aCA9PT0gMCkgew0KCQkJCWxvZygxLCAiRVJST1IgY2FsbGluZyBtZXRob2QgJ3NldFBpbigpJzogSW52YWxpZCBwaW4gZWxlbWVudCBzdXBwbGllZC4iKTsNCgkJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7IC8vIGNhbmNlbA0KCQkJfSBlbHNlIGlmIChlbGVtZW50LmNzcygicG9zaXRpb24iKSA9PSAiZml4ZWQiKSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjYWxsaW5nIG1ldGhvZCAnc2V0UGluKCknOiBQaW4gZG9lcyBub3Qgd29yayB3aXRoIGVsZW1lbnRzIHRoYXQgYXJlIHBvc2l0aW9uZWQgJ2ZpeGVkJy4iKTsNCgkJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7IC8vIGNhbmNlbA0KCQkJfQ0KDQoJCQlpZiAoX3BpbikgeyAvLyBwcmVleGlzdGluZyBwaW4/DQoJCQkJaWYgKF9waW4gPT09IGVsZW1lbnQpIHsNCgkJCQkJLy8gc2FtZSBwaW4gd2UgYWxyZWFkeSBoYXZlIC0+IGRvIG5vdGhpbmcNCgkJCQkJcmV0dXJuIFNjcm9sbFNjZW5lOyAvLyBjYW5jZWwNCgkJCQl9IGVsc2Ugew0KCQkJCQkvLyBraWxsIG9sZCBwaW4NCgkJCQkJU2Nyb2xsU2NlbmUucmVtb3ZlUGluKCk7DQoJCQkJfQ0KCQkJCQ0KCQkJfQ0KCQkJX3BpbiA9IGVsZW1lbnQ7DQoJCQkNCgkJCV9waW4ucGFyZW50KCkuaGlkZSgpOyAvLyBoYWNrIHN0YXJ0IHRvIGZvcmNlIGpRdWVyeSBjc3MgdG8gcmV0dXJuIHN0eWxlc2hlZXQgdmFsdWVzIGluc3RlYWQgb2YgY2FsY3VsYXRlZCBweCB2YWx1ZXMuDQoJCQl2YXINCgkJCQlpbkZsb3cgPSBfcGluLmNzcygicG9zaXRpb24iKSAhPSAiYWJzb2x1dGUiLA0KCQkJCXBpbkNTUyA9IF9waW4uY3NzKFsiZGlzcGxheSIsICJ0b3AiLCAibGVmdCIsICJib3R0b20iLCAicmlnaHQiXSksDQoJCQkJc2l6ZUNTUyA9IF9waW4uY3NzKFsid2lkdGgiLCAiaGVpZ2h0Il0pOw0KCQkJX3Bpbi5wYXJlbnQoKS5zaG93KCk7IC8vIGhhY2sgZW5kLg0KDQoJCQlpZiAoc2l6ZUNTUy53aWR0aCA9PT0gIjBweCIgJmFtcDsmYW1wOyAgaW5GbG93ICZhbXA7JmFtcDsgaXNNYXJnaW5Db2xsYXBzZVR5cGUocGluQ1NTLmRpc3BsYXkpKSB7DQoJCQkJLy8gbG9nICgyLCAiV0FSTklORzogWW91ciBwaW5uZWQgZWxlbWVudCBwcm9iYWJseSBuZWVkcyBhIGRlZmluZWQgd2lkdGggb3IgaXQgbWlnaHQgY29sbGFwc2UgZHVyaW5nIHBpbi4iKTsNCgkJCX0NCgkJCWlmICghaW5GbG93ICZhbXA7JmFtcDsgc2V0dGluZ3MucHVzaEZvbGxvd2Vycykgew0KCQkJCWxvZygyLCAiV0FSTklORzogSWYgdGhlIHBpbm5lZCBlbGVtZW50IGlzIHBvc2l0aW9uZWQgYWJzb2x1dGVseSBwdXNoRm9sbG93ZXJzIGlzIGRpc2FibGVkLiIpOw0KCQkJCXNldHRpbmdzLnB1c2hGb2xsb3dlcnMgPSBmYWxzZTsNCgkJCX0NCg0KCQkJLy8gY3JlYXRlIHNwYWNlcg0KCQkJdmFyIHNwYWNlciA9ICQoIiZsdDtkaXY+Jmx0Oy9kaXY+IikNCgkJCQkJLmFkZENsYXNzKHNldHRpbmdzLnNwYWNlckNsYXNzKQ0KCQkJCQkuY3NzKHBpbkNTUykNCgkJCQkJLmRhdGEoIlNjcm9sbE1hZ2ljUGluU3BhY2VyIiwgdHJ1ZSkNCgkJCQkJLmNzcyh7DQoJCQkJCQlwb3NpdGlvbjogaW5GbG93ID8gInJlbGF0aXZlIiA6ICJhYnNvbHV0ZSIsDQoJCQkJCQkibWFyZ2luLWxlZnQiOiAiYXV0byIsDQoJCQkJCQkibWFyZ2luLXJpZ2h0IjogImF1dG8iLA0KCQkJCQkJImJveC1zaXppbmciOiAiY29udGVudC1ib3giDQoJCQkJCX0pOw0KDQoJCQkvLyBzZXQgdGhlIHBpbiBPcHRpb25zDQoJCQl2YXIgcGluSW5saW5lQ1NTID0gX3BpblswXS5zdHlsZTsNCgkJCV9waW5PcHRpb25zID0gew0KCQkJCXNwYWNlcjogc3BhY2VyLA0KCQkJCXJlbFNpemU6IHsgLy8gc2F2ZSBpZiBzaXplIGlzIGRlZmluZWQgdXNpbmcgJSB2YWx1ZXMuIGlmIHNvLCBoYW5kbGUgc3BhY2VyIHJlc2l6ZSBkaWZmZXJlbnRseS4uLg0KCQkJCQl3aWR0aDogc2l6ZUNTUy53aWR0aC5zbGljZSgtMSkgPT09ICIlIiwNCgkJCQkJaGVpZ2h0OiBzaXplQ1NTLmhlaWdodC5zbGljZSgtMSkgPT09ICIlIiwNCgkJCQkJYXV0b0Z1bGxXaWR0aDogc2l6ZUNTUy53aWR0aCA9PT0gIjBweCIgJmFtcDsmYW1wOyAgaW5GbG93ICZhbXA7JmFtcDsgaXNNYXJnaW5Db2xsYXBzZVR5cGUocGluQ1NTLmRpc3BsYXkpDQoJCQkJfSwNCgkJCQlwdXNoRm9sbG93ZXJzOiBzZXR0aW5ncy5wdXNoRm9sbG93ZXJzLA0KCQkJCWluRmxvdzogaW5GbG93LCAvLyBzdG9yZXMgaWYgdGhlIGVsZW1lbnQgdGFrZXMgdXAgc3BhY2UgaW4gdGhlIGRvY3VtZW50IGZsb3cNCgkJCQlvcmlnU3R5bGU6IHsNCgkJCQkJd2lkdGg6IHBpbklubGluZUNTUy53aWR0aCB8fCAiIiwNCgkJCQkJcG9zaXRpb246IHBpbklubGluZUNTUy5wb3NpdGlvbiB8fCAiIiwNCgkJCQkJdG9wOiBwaW5JbmxpbmVDU1MudG9wIHx8ICIiLA0KCQkJCQlsZWZ0OiBwaW5JbmxpbmVDU1MubGVmdCB8fCAiIiwNCgkJCQkJYm90dG9tOiBwaW5JbmxpbmVDU1MuYm90dG9tIHx8ICIiLA0KCQkJCQlyaWdodDogcGluSW5saW5lQ1NTLnJpZ2h0IHx8ICIiLA0KCQkJCQkiYm94LXNpemluZyI6IHBpbklubGluZUNTU1siYm94LXNpemluZyJdIHx8ICIiLA0KCQkJCQkiLW1vei1ib3gtc2l6aW5nIjogcGluSW5saW5lQ1NTWyItbW96LWJveC1zaXppbmciXSB8fCAiIiwNCgkJCQkJIi13ZWJraXQtYm94LXNpemluZyI6IHBpbklubGluZUNTU1siLXdlYmtpdC1ib3gtc2l6aW5nIl0gfHwgIiINCgkJCQl9LCAvLyBzYXZlIG9sZCBzdHlsZXMgKGZvciByZXNldCkNCgkJCQlwaW5uZWRDbGFzczogc2V0dGluZ3MucGlubmVkQ2xhc3MgLy8gdGhlIGNsYXNzIHRoYXQgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50IHdoZW4gcGlubmVkDQoJCQl9Ow0KDQoJCQkvLyBpZiByZWxhdGl2ZSBzaXplLCB0cmFuc2ZlciBpdCB0byBzcGFjZXIgYW5kIG1ha2UgcGluIGNhbGN1bGF0ZSBpdC4uLg0KCQkJaWYgKF9waW5PcHRpb25zLnJlbFNpemUud2lkdGgpIHsNCgkJCQlzcGFjZXIuY3NzKCJ3aWR0aCIsIHNpemVDU1Mud2lkdGgpOw0KCQkJfQ0KCQkJaWYgKF9waW5PcHRpb25zLnJlbFNpemUuaGVpZ2h0KSB7DQoJCQkJc3BhY2VyLmNzcygiaGVpZ2h0Iiwgc2l6ZUNTUy5oZWlnaHQpOw0KCQkJfQ0KDQoJCQkvLyBub3cgcGxhY2UgdGhlIHBpbiBlbGVtZW50IGluc2lkZSB0aGUgc3BhY2VyCQ0KCQkJX3Bpbi5iZWZvcmUoc3BhY2VyKQ0KCQkJCQkuYXBwZW5kVG8oc3BhY2VyKQ0KCQkJCQkvLyBhbmQgc2V0IG5ldyBjc3MNCgkJCQkJLmNzcyh7DQoJCQkJCQlwb3NpdGlvbjogaW5GbG93ID8gInJlbGF0aXZlIiA6ICJhYnNvbHV0ZSIsDQoJCQkJCQl0b3A6ICJhdXRvIiwNCgkJCQkJCWxlZnQ6ICJhdXRvIiwNCgkJCQkJCWJvdHRvbTogImF1dG8iLA0KCQkJCQkJcmlnaHQ6ICJhdXRvIg0KCQkJCQl9KTsNCgkJCQ0KCQkJaWYgKF9waW5PcHRpb25zLnJlbFNpemUud2lkdGggfHwgX3Bpbk9wdGlvbnMucmVsU2l6ZS5hdXRvRnVsbFdpZHRoKSB7DQoJCQkJX3Bpbi5jc3MoImJveC1zaXppbmciLCAiYm9yZGVyLWJveCIpOw0KCQkJfQ0KDQoJCQkvLyBhZGQgbGlzdGVuZXIgdG8gZG9jdW1lbnQgdG8gdXBkYXRlIHBpbiBwb3NpdGlvbiBpbiBjYXNlIGNvbnRyb2xsZXIgaXMgbm90IHRoZSBkb2N1bWVudC4NCgkJCSQod2luZG93KS5vbigic2Nyb2xsLiIgKyBOQU1FU1BBQ0UgKyAiX3BpbiByZXNpemUuIiArIE5BTUVTUEFDRSArICJfcGluIiwgdXBkYXRlUGluSW5Db250YWluZXIpOw0KCQkJLy8gYWRkIG1vdXNld2hlZWwgbGlzdGVuZXIgdG8gY2F0Y2ggc2Nyb2xscyBvdmVyIGZpeGVkIGVsZW1lbnRzDQoJCQlfcGluLm9uKCJtb3VzZXdoZWVsIERPTU1vdXNlU2Nyb2xsIiwgb25Nb3VzZXdoZWVsT3ZlclBpbik7DQoNCgkJCWxvZygzLCAiYWRkZWQgcGluIik7DQoNCgkJCS8vIGZpbmFsbHkgdXBkYXRlIHRoZSBwaW4gdG8gaW5pdA0KCQkJdXBkYXRlUGluU3RhdGUoKTsNCg0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBSZW1vdmUgdGhlIHBpbiBmcm9tIHRoZSBzY2VuZS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZW1vdmUgdGhlIHBpbiBmcm9tIHRoZSBzY2VuZSB3aXRob3V0IHJlc2V0dGluZyBpdCAodGhlIHNwYWNlciBpcyBub3QgcmVtb3ZlZCkNCgkJICogc2NlbmUucmVtb3ZlUGluKCk7DQoJCSAqDQoJCSAqIC8vIHJlbW92ZSB0aGUgcGluIGZyb20gdGhlIHNjZW5lIGFuZCByZXNldCB0aGUgcGluIGVsZW1lbnQgdG8gaXRzIGluaXRpYWwgcG9zaXRpb24gKHNwYWNlciBpcyByZW1vdmVkKQ0KCQkgKiBzY2VuZS5yZW1vdmVQaW4odHJ1ZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0PWZhbHNlXSAtIElmIGBmYWxzZWAgdGhlIHNwYWNlciB3aWxsIG5vdCBiZSByZW1vdmVkIGFuZCB0aGUgZWxlbWVudCdzIHBvc2l0aW9uIHdpbGwgbm90IGJlIHJlc2V0Lg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZW1vdmVQaW4gPSBmdW5jdGlvbiAocmVzZXQpIHsNCgkJCWlmIChfcGluKSB7DQoJCQkJaWYgKHJlc2V0IHx8ICFfcGFyZW50KSB7IC8vIGlmIHRoZXJlJ3Mgbm8gcGFyZW50IG5vIHByb2dyZXNzIHdhcyBtYWRlIGFueXdheS4uLg0KCQkJCQlfcGluLmluc2VydEJlZm9yZShfcGluT3B0aW9ucy5zcGFjZXIpDQoJCQkJCQkuY3NzKF9waW5PcHRpb25zLm9yaWdTdHlsZSk7DQoJCQkJCV9waW5PcHRpb25zLnNwYWNlci5yZW1vdmUoKTsNCgkJCQl9IGVsc2Ugew0KCQkJCQlpZiAoX3N0YXRlID09PSAiRFVSSU5HIikgew0KCQkJCQkJdXBkYXRlUGluU3RhdGUodHJ1ZSk7IC8vIGZvcmNlIHVucGluIGF0IHBvc2l0aW9uDQoJCQkJCX0NCgkJCQl9DQoJCQkJJCh3aW5kb3cpLm9mZigic2Nyb2xsLiIgKyBOQU1FU1BBQ0UgKyAiX3BpbiByZXNpemUuIiArIE5BTUVTUEFDRSArICJfcGluIik7DQoJCQkJX3Bpbi5vZmYoIm1vdXNld2hlZWwgRE9NTW91c2VTY3JvbGwiLCBvbk1vdXNld2hlZWxPdmVyUGluKTsNCgkJCQlfcGluID0gdW5kZWZpbmVkOw0KCQkJCWxvZygzLCAicmVtb3ZlZCBwaW4gKHJlc2V0OiAiICsgKHJlc2V0ID8gInRydWUiIDogImZhbHNlIikgKyAiKSIpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBEZWZpbmUgYSBjc3MgY2xhc3MgbW9kaWZpY2F0aW9uIHdoaWxlIHRoZSBzY2VuZSBpcyBhY3RpdmUuICANCgkJICogV2hlbiB0aGUgc2NlbmUgdHJpZ2dlcnMgdGhlIGNsYXNzZXMgd2lsbCBiZSBhZGRlZCB0byB0aGUgc3VwcGxpZWQgZWxlbWVudCBhbmQgcmVtb3ZlZCwgd2hlbiB0aGUgc2NlbmUgaXMgb3Zlci4NCgkJICogSWYgdGhlIHNjZW5lIGR1cmF0aW9uIGlzIDAgdGhlIGNsYXNzZXMgd2lsbCBvbmx5IGJlIHJlbW92ZWQgaWYgdGhlIHVzZXIgc2Nyb2xscyBiYWNrIHBhc3QgdGhlIHN0YXJ0IHBvc2l0aW9uLg0KCQkgKiBAcHVibGljDQoJCSAqIEBleGFtcGxlDQoJCSAqIC8vIGFkZCB0aGUgY2xhc3MgJ215Y2xhc3MnIHRvIHRoZSBlbGVtZW50IHdpdGggdGhlIGlkICdteS1lbGVtJyBmb3IgdGhlIGR1cmF0aW9uIG9mIHRoZSBzY2VuZQ0KCQkgKiBzY2VuZS5zZXRDbGFzc1RvZ2dsZSgiI215LWVsZW0iLCAibXljbGFzcyIpOw0KCQkgKg0KCQkgKiAvLyBhZGQgbXVsdGlwbGUgY2xhc3NlcyB0byBtdWx0aXBsZSBlbGVtZW50cyBkZWZpbmVkIGJ5IHRoZSBzZWxlY3RvciAnLmNsYXNzQ2hhbmdlJw0KCQkgKiBzY2VuZS5zZXRDbGFzc1RvZ2dsZSgiLmNsYXNzQ2hhbmdlIiwgImNsYXNzMSBjbGFzczIgY2xhc3MzIik7DQoJCSAqDQoJCSAqIEBwYXJhbSB7KHN0cmluZ3xvYmplY3QpfSBlbGVtZW50IC0gQSBTZWxlY3RvciB0YXJnZXRpbmcgb25lIG9yIG1vcmUgZWxlbWVudHMsIGEgRE9NIG9iamVjdCBvciBhIGpRdWVyeSBvYmplY3QgdGhhdCBpcyBzdXBwb3NlZCB0byBiZSBtb2RpZmllZC4NCgkJICogQHBhcmFtIHtzdHJpbmd9IGNsYXNzZXMgLSBPbmUgb3IgbW9yZSBDbGFzc25hbWVzIChzZXBhcmF0ZWQgYnkgc3BhY2UpIHRoYXQgc2hvdWxkIGJlIGFkZGVkIHRvIHRoZSBlbGVtZW50IGR1cmluZyB0aGUgc2NlbmUuDQoJCSAqDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQl0aGlzLnNldENsYXNzVG9nZ2xlID0gZnVuY3Rpb24gKGVsZW1lbnQsIGNsYXNzZXMpIHsNCgkJCXZhciAkZWxtID0gJChlbGVtZW50KTsNCgkJCWlmICgkZWxtLmxlbmd0aCA9PT0gMCB8fCAkLnR5cGUoY2xhc3NlcykgIT09ICJzdHJpbmciKSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjYWxsaW5nIG1ldGhvZCAnc2V0Q2xhc3NUb2dnbGUoKSc6IEludmFsaWQgIiArICgkZWxtLmxlbmd0aCA9PT0gMCA/ICJlbGVtZW50IiA6ICJjbGFzc2VzIikgKyAiIHN1cHBsaWVkLiIpOw0KCQkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJCX0NCgkJCV9jc3NDbGFzc2VzID0gY2xhc3NlczsNCgkJCV9jc3NDbGFzc0VsbSA9ICRlbG07DQoJCQlTY3JvbGxTY2VuZS5vbigiZW50ZXIuaW50ZXJuYWxfY2xhc3MgbGVhdmUuaW50ZXJuYWxfY2xhc3MiLCBmdW5jdGlvbiAoZSkgew0KCQkJCV9jc3NDbGFzc0VsbS50b2dnbGVDbGFzcyhfY3NzQ2xhc3NlcywgZS50eXBlID09PSAiZW50ZXIiKTsNCgkJCX0pOw0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KDQoJCS8qKg0KCQkgKiBSZW1vdmUgdGhlIGNsYXNzIGJpbmRpbmcgZnJvbSB0aGUgc2NlbmUuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gcmVtb3ZlIGNsYXNzIGJpbmRpbmcgZnJvbSB0aGUgc2NlbmUgd2l0aG91dCByZXNldA0KCQkgKiBzY2VuZS5yZW1vdmVDbGFzc1RvZ2dsZSgpOw0KCQkgKg0KCQkgKiAvLyByZW1vdmUgY2xhc3MgYmluZGluZyBhbmQgcmVtb3ZlIHRoZSBjaGFuZ2VzIGl0IGNhdXNlZA0KCQkgKiBzY2VuZS5yZW1vdmVDbGFzc1RvZ2dsZSh0cnVlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbcmVzZXQ9ZmFsc2VdIC0gSWYgYGZhbHNlYCBhbmQgdGhlIGNsYXNzZXMgYXJlIGN1cnJlbnRseSBhY3RpdmUsIHRoZXkgd2lsbCByZW1haW4gb24gdGhlIGVsZW1lbnQuIElmIGB0cnVlYCB0aGV5IHdpbGwgYmUgcmVtb3ZlZC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMucmVtb3ZlQ2xhc3NUb2dnbGUgPSBmdW5jdGlvbiAocmVzZXQpIHsNCgkJCWlmIChfY3NzQ2xhc3NFbG0gJmFtcDsmYW1wOyByZXNldCkgew0KCQkJCV9jc3NDbGFzc0VsbS5yZW1vdmVDbGFzcyhfY3NzQ2xhc3Nlcyk7DQoJCQl9DQoJCQlTY3JvbGxTY2VuZS5vZmYoInN0YXJ0LmludGVybmFsX2NsYXNzIGVuZC5pbnRlcm5hbF9jbGFzcyIpOw0KCQkJX2Nzc0NsYXNzZXMgPSB1bmRlZmluZWQ7DQoJCQlfY3NzQ2xhc3NFbG0gPSB1bmRlZmluZWQ7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCX07DQoNCgkJLyoqDQoJCSAqIEFkZCB0aGUgc2NlbmUgdG8gYSBjb250cm9sbGVyLiAgDQoJCSAqIFRoaXMgaXMgdGhlIGVxdWl2YWxlbnQgdG8gYFNjcm9sbE1hZ2ljLmFkZFNjZW5lKHNjZW5lKWAuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gYWRkIGEgc2NlbmUgdG8gYSBTY3JvbGxNYWdpYyBjb250cm9sbGVyDQoJCSAqIHNjZW5lLmFkZFRvKGNvbnRyb2xsZXIpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge1Njcm9sbE1hZ2ljfSBjb250cm9sbGVyIC0gVGhlIGNvbnRyb2xsZXIgdG8gd2hpY2ggdGhlIHNjZW5lIHNob3VsZCBiZSBhZGRlZC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCXRoaXMuYWRkVG8gPSBmdW5jdGlvbiAoY29udHJvbGxlcikgew0KCQkJaWYgKCEoY29udHJvbGxlciBpbnN0YW5jZW9mIFNjcm9sbE1hZ2ljKSkgew0KCQkJCWxvZygxLCAiRVJST1I6IHN1cHBsaWVkIGFyZ3VtZW50IG9mICdhZGRUbygpJyBpcyBub3QgYSB2YWxpZCBTY3JvbGxNYWdpYyBjb250cm9sbGVyIik7DQoJCQl9IGVsc2UgaWYgKF9wYXJlbnQgIT0gY29udHJvbGxlcikgew0KCQkJCS8vIG5ldyBwYXJlbnQNCgkJCQlpZiAoX3BhcmVudCkgeyAvLyBJIGhhZCBhIHBhcmVudCBiZWZvcmUsIHNvIHJlbW92ZSBpdC4uLg0KCQkJCQlfcGFyZW50LnJlbW92ZVNjZW5lKFNjcm9sbFNjZW5lKTsNCgkJCQl9DQoJCQkJX3BhcmVudCA9IGNvbnRyb2xsZXI7DQoJCQkJdmFsaWRhdGVPcHRpb24oKTsNCgkJCQl1cGRhdGVEdXJhdGlvbih0cnVlKTsNCgkJCQl1cGRhdGVUcmlnZ2VyRWxlbWVudFBvc2l0aW9uKHRydWUpOw0KCQkJCXVwZGF0ZVNjcm9sbE9mZnNldCgpOw0KCQkJCXVwZGF0ZVBpblNwYWNlclNpemUoKTsNCgkJCQlfcGFyZW50LmluZm8oImNvbnRhaW5lciIpLm9uKCJyZXNpemUuIiArIE5BTUVTUEFDRSwgZnVuY3Rpb24gKCkgew0KCQkJCQl1cGRhdGVSZWxhdGl2ZVBpblNwYWNlcigpOw0KCQkJCQlpZiAoU2Nyb2xsU2NlbmUudHJpZ2dlckhvb2soKSA+IDApIHsNCgkJCQkJCVNjcm9sbFNjZW5lLnRyaWdnZXIoInNoaWZ0Iiwge3JlYXNvbjogImNvbnRhaW5lclNpemUifSk7DQoJCQkJCX0NCgkJCQl9KTsNCgkJCQlsb2coMywgImFkZGVkICIgKyBOQU1FU1BBQ0UgKyAiIHRvIGNvbnRyb2xsZXIiKTsNCgkJCQljb250cm9sbGVyLmFkZFNjZW5lKFNjcm9sbFNjZW5lKTsNCgkJCQlTY3JvbGxTY2VuZS51cGRhdGUoKTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogKipHZXQqKiBvciAqKlNldCoqIHRoZSBjdXJyZW50IGVuYWJsZWQgc3RhdGUgb2YgdGhlIHNjZW5lLiAgDQoJCSAqIFRoaXMgY2FuIGJlIHVzZWQgdG8gZGlzYWJsZSB0aGlzIHNjZW5lIHdpdGhvdXQgcmVtb3Zpbmcgb3IgZGVzdHJveWluZyBpdC4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyBnZXQgdGhlIGN1cnJlbnQgdmFsdWUNCgkJICogdmFyIGVuYWJsZWQgPSBzY2VuZS5lbmFibGVkKCk7DQoJCSAqDQoJIAkgKiAvLyBkaXNhYmxlIHRoZSBzY2VuZQ0KCQkgKiBzY2VuZS5lbmFibGVkKGZhbHNlKTsNCgkJICoNCgkJICogQHBhcmFtIHtib29sZWFufSBbbmV3U3RhdGVdIC0gVGhlIG5ldyBlbmFibGVkIHN0YXRlIG9mIHRoZSBzY2VuZSBgdHJ1ZWAgb3IgYGZhbHNlYC4NCgkJICogQHJldHVybnMgeyhib29sZWFufFNjcm9sbFNjZW5lKX0gQ3VycmVudCBlbmFibGVkIHN0YXRlIG9yIHBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5lbmFibGVkID0gZnVuY3Rpb24gKG5ld1N0YXRlKSB7DQoJCQlpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsgLy8gZ2V0DQoJCQkJcmV0dXJuIF9lbmFibGVkOw0KCQkJfSBlbHNlIGlmIChfZW5hYmxlZCAhPSBuZXdTdGF0ZSkgeyAvLyBzZXQNCgkJCQlfZW5hYmxlZCA9ICEhbmV3U3RhdGU7DQoJCQkJU2Nyb2xsU2NlbmUudXBkYXRlKHRydWUpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQl9Ow0KCQkNCgkJLyoqDQoJCSAqIFJlbW92ZSB0aGUgc2NlbmUgZnJvbSBpdHMgcGFyZW50IGNvbnRyb2xsZXIuICANCgkJICogVGhpcyBpcyB0aGUgZXF1aXZhbGVudCB0byBgU2Nyb2xsTWFnaWMucmVtb3ZlU2NlbmUoc2NlbmUpYC4NCgkJICogVGhlIHNjZW5lIHdpbGwgbm90IGJlIHVwZGF0ZWQgYW55bW9yZSB1bnRpbCB5b3UgcmVhZGQgaXQgdG8gYSBjb250cm9sbGVyLg0KCQkgKiBUbyByZW1vdmUgdGhlIHBpbiBvciB0aGUgdHdlZW4geW91IG5lZWQgdG8gY2FsbCByZW1vdmVUd2VlbigpIG9yIHJlbW92ZVBpbigpIHJlc3BlY3RpdmVseS4NCgkJICogQHB1YmxpYw0KCQkgKiBAZXhhbXBsZQ0KCQkgKiAvLyByZW1vdmUgdGhlIHNjZW5lIGZyb20gaXRzIHBhcmVudCBjb250cm9sbGVyDQoJCSAqIHNjZW5lLnJlbW92ZSgpOw0KCQkgKg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJdGhpcy5yZW1vdmUgPSBmdW5jdGlvbiAoKSB7DQoJCQlpZiAoX3BhcmVudCkgew0KCQkJCV9wYXJlbnQuaW5mbygiY29udGFpbmVyIikub2ZmKCJyZXNpemUuIiArIE5BTUVTUEFDRSk7DQoJCQkJdmFyIHRtcFBhcmVudCA9IF9wYXJlbnQ7DQoJCQkJX3BhcmVudCA9IHVuZGVmaW5lZDsNCgkJCQlsb2coMywgInJlbW92ZWQgIiArIE5BTUVTUEFDRSArICIgZnJvbSBjb250cm9sbGVyIik7DQoJCQkJdG1wUGFyZW50LnJlbW92ZVNjZW5lKFNjcm9sbFNjZW5lKTsNCgkJCX0NCgkJCXJldHVybiBTY3JvbGxTY2VuZTsNCgkJfTsNCg0KCQkvKioNCgkJICogRGVzdHJveSB0aGUgc2NlbmUgYW5kIGV2ZXJ5dGhpbmcuDQoJCSAqIEBwdWJsaWMNCgkJICogQGV4YW1wbGUNCgkJICogLy8gZGVzdHJveSB0aGUgc2NlbmUgd2l0aG91dCByZXNldHRpbmcgdGhlIHBpbiBhbmQgdHdlZW4gdG8gdGhlaXIgaW5pdGlhbCBwb3NpdGlvbnMNCgkJICogc2NlbmUgPSBzY2VuZS5kZXN0cm95KCk7DQoJCSAqDQoJCSAqIC8vIGRlc3Ryb3kgdGhlIHNjZW5lIGFuZCByZXNldCB0aGUgcGluIGFuZCB0d2Vlbg0KCQkgKiBzY2VuZSA9IHNjZW5lLmRlc3Ryb3kodHJ1ZSk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0PWZhbHNlXSAtIElmIGB0cnVlYCB0aGUgcGluIGFuZCB0d2VlbiAoaWYgZXhpc3RlbnQpIHdpbGwgYmUgcmVzZXQuDQoJCSAqIEByZXR1cm5zIHtudWxsfSBOdWxsIHRvIHVuc2V0IGhhbmRsZXIgdmFyaWFibGVzLg0KCQkgKi8NCgkJdGhpcy5kZXN0cm95ID0gZnVuY3Rpb24gKHJlc2V0KSB7DQoJCQlTY3JvbGxTY2VuZS5yZW1vdmVUd2VlbihyZXNldCk7DQoJCQlTY3JvbGxTY2VuZS5yZW1vdmVQaW4ocmVzZXQpOw0KCQkJU2Nyb2xsU2NlbmUucmVtb3ZlQ2xhc3NUb2dnbGUocmVzZXQpOw0KCQkJU2Nyb2xsU2NlbmUudHJpZ2dlcigiZGVzdHJveSIsIHtyZXNldDogcmVzZXR9KTsNCgkJCVNjcm9sbFNjZW5lLnJlbW92ZSgpOw0KCQkJU2Nyb2xsU2NlbmUub2ZmKCJzdGFydCBlbmQgZW50ZXIgbGVhdmUgcHJvZ3Jlc3MgY2hhbmdlIHVwZGF0ZSBzaGlmdCBkZXN0cm95IHNoaWZ0LmludGVybmFsIGNoYW5nZS5pbnRlcm5hbCBwcm9ncmVzcy5pbnRlcm5hbCIpOw0KCQkJbG9nKDMsICJkZXN0cm95ZWQgIiArIE5BTUVTUEFDRSArICIgKHJlc2V0OiAiICsgKHJlc2V0ID8gInRydWUiIDogImZhbHNlIikgKyAiKSIpOw0KCQkJcmV0dXJuIG51bGw7DQoJCX07DQoNCgkJLyoNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKiBFVkVOVFMNCgkJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCQkgKi8NCgkJDQoJCS8qKg0KCQkgKiBTY2VuZSBzdGFydCBldmVudC4gIA0KCQkgKiBGaXJlcyB3aGVuZXZlciB0aGUgc2Nyb2xsIHBvc2l0aW9uIGl0cyB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgdGhlIHNjZW5lLiAgDQoJCSAqIEl0IHdpbGwgYWxzbyBmaXJlIHdoZW4gc2Nyb2xsaW5nIGJhY2sgdXAgZ29pbmcgb3ZlciB0aGUgc3RhcnQgcG9zaXRpb24gb2YgdGhlIHNjZW5lLiBJZiB5b3Ugd2FudCBzb21ldGhpbmcgdG8gaGFwcGVuIG9ubHkgd2hlbiBzY3JvbGxpbmcgZG93bi9yaWdodCwgdXNlIHRoZSBzY3JvbGxEaXJlY3Rpb24gcGFyYW1ldGVyIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suDQoJCSAqDQoJCSAqIEZvciBkZXRhaWxzIG9uIHRoaXMgZXZlbnQgYW5kIHRoZSBvcmRlciBpbiB3aGljaCBpdCBpcyBmaXJlZCwgcGxlYXNlIHJldmlldyB0aGUge0BsaW5rIFNjcm9sbFNjZW5lLnByb2dyZXNzfSBtZXRob2QuDQoJCSAqDQoJCSAqIEBldmVudCBTY3JvbGxTY2VuZS5zdGFydA0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiBzY2VuZS5vbigic3RhcnQiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQlhbGVydCgiSGl0IHN0YXJ0IHBvaW50IG9mIHNjZW5lLiIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnByb2dyZXNzIC0gUmVmbGVjdHMgdGhlIGN1cnJlbnQgcHJvZ3Jlc3Mgb2YgdGhlIHNjZW5lDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zdGF0ZSAtIFRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBzY2VuZSBgIkJFRk9SRSJgLCBgIkRVUklORyJgIG9yIGAiQUZURVIiYA0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc2Nyb2xsRGlyZWN0aW9uIC0gSW5kaWNhdGVzIHdoaWNoIHdheSB3ZSBhcmUgc2Nyb2xsaW5nIGAiUEFVU0VEImAsIGAiRk9SV0FSRCJgIG9yIGAiUkVWRVJTRSJgDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgZW5kIGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW5ldmVyIHRoZSBzY3JvbGwgcG9zaXRpb24gaXRzIHRoZSBlbmRpbmcgcG9pbnQgb2YgdGhlIHNjZW5lLiAgDQoJCSAqIEl0IHdpbGwgYWxzbyBmaXJlIHdoZW4gc2Nyb2xsaW5nIGJhY2sgdXAgZnJvbSBhZnRlciB0aGUgc2NlbmUgYW5kIGdvaW5nIG92ZXIgaXRzIGVuZCBwb3NpdGlvbi4gSWYgeW91IHdhbnQgc29tZXRoaW5nIHRvIGhhcHBlbiBvbmx5IHdoZW4gc2Nyb2xsaW5nIGRvd24vcmlnaHQsIHVzZSB0aGUgc2Nyb2xsRGlyZWN0aW9uIHBhcmFtZXRlciBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLg0KCQkgKg0KCQkgKiBGb3IgZGV0YWlscyBvbiB0aGlzIGV2ZW50IGFuZCB0aGUgb3JkZXIgaW4gd2hpY2ggaXQgaXMgZmlyZWQsIHBsZWFzZSByZXZpZXcgdGhlIHtAbGluayBTY3JvbGxTY2VuZS5wcm9ncmVzc30gbWV0aG9kLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUuZW5kDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJlbmQiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQlhbGVydCgiSGl0IGVuZCBwb2ludCBvZiBzY2VuZS4iKTsNCgkJICogfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBldmVudC5wcm9ncmVzcyAtIFJlZmxlY3RzIHRoZSBjdXJyZW50IHByb2dyZXNzIG9mIHRoZSBzY2VuZQ0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc3RhdGUgLSBUaGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgc2NlbmUgYCJCRUZPUkUiYCwgYCJEVVJJTkciYCBvciBgIkFGVEVSImANCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnNjcm9sbERpcmVjdGlvbiAtIEluZGljYXRlcyB3aGljaCB3YXkgd2UgYXJlIHNjcm9sbGluZyBgIlBBVVNFRCJgLCBgIkZPUldBUkQiYCBvciBgIlJFVkVSU0UiYA0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIGVudGVyIGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW5ldmVyIHRoZSBzY2VuZSBlbnRlcnMgdGhlICJEVVJJTkciIHN0YXRlLiAgDQoJCSAqIEtlZXAgaW4gbWluZCB0aGF0IGl0IGRvZXNuJ3QgbWF0dGVyIGlmIHRoZSBzY2VuZSBwbGF5cyBmb3J3YXJkIG9yIGJhY2t3YXJkOiBUaGlzIGV2ZW50IGFsd2F5cyBmaXJlcyB3aGVuIHRoZSBzY2VuZSBlbnRlcnMgaXRzIGFjdGl2ZSBzY3JvbGwgdGltZWZyYW1lLCByZWdhcmRsZXNzIG9mIHRoZSBzY3JvbGwtZGlyZWN0aW9uLg0KCQkgKg0KCQkgKiBGb3IgZGV0YWlscyBvbiB0aGlzIGV2ZW50IGFuZCB0aGUgb3JkZXIgaW4gd2hpY2ggaXQgaXMgZmlyZWQsIHBsZWFzZSByZXZpZXcgdGhlIHtAbGluayBTY3JvbGxTY2VuZS5wcm9ncmVzc30gbWV0aG9kLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUuZW50ZXINCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oImVudGVyIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQoJCSAqIAkJYWxlcnQoIkVudGVyZWQgYSBzY2VuZS4iKTsNCgkJICogfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBldmVudC5wcm9ncmVzcyAtIFJlZmxlY3RzIHRoZSBjdXJyZW50IHByb2dyZXNzIG9mIHRoZSBzY2VuZQ0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc3RhdGUgLSBUaGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgc2NlbmUgYCJCRUZPUkUiYCwgYCJEVVJJTkciYCBvciBgIkFGVEVSImANCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnNjcm9sbERpcmVjdGlvbiAtIEluZGljYXRlcyB3aGljaCB3YXkgd2UgYXJlIHNjcm9sbGluZyBgIlBBVVNFRCJgLCBgIkZPUldBUkQiYCBvciBgIlJFVkVSU0UiYA0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIGxlYXZlIGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW5ldmVyIHRoZSBzY2VuZSdzIHN0YXRlIGdvZXMgZnJvbSAiRFVSSU5HIiB0byBlaXRoZXIgIkJFRk9SRSIgb3IgIkFGVEVSIi4gIA0KCQkgKiBLZWVwIGluIG1pbmQgdGhhdCBpdCBkb2Vzbid0IG1hdHRlciBpZiB0aGUgc2NlbmUgcGxheXMgZm9yd2FyZCBvciBiYWNrd2FyZDogVGhpcyBldmVudCBhbHdheXMgZmlyZXMgd2hlbiB0aGUgc2NlbmUgbGVhdmVzIGl0cyBhY3RpdmUgc2Nyb2xsIHRpbWVmcmFtZSwgcmVnYXJkbGVzcyBvZiB0aGUgc2Nyb2xsLWRpcmVjdGlvbi4NCgkJICoNCgkJICogRm9yIGRldGFpbHMgb24gdGhpcyBldmVudCBhbmQgdGhlIG9yZGVyIGluIHdoaWNoIGl0IGlzIGZpcmVkLCBwbGVhc2UgcmV2aWV3IHRoZSB7QGxpbmsgU2Nyb2xsU2NlbmUucHJvZ3Jlc3N9IG1ldGhvZC4NCgkJICoNCgkJICogQGV2ZW50IFNjcm9sbFNjZW5lLmxlYXZlDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJsZWF2ZSIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWFsZXJ0KCJMZWZ0IGEgc2NlbmUuIik7DQoJCSAqIH0pOw0KCQkgKg0KCQkgKiBAcHJvcGVydHkge29iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgT2JqZWN0IHBhc3NlZCB0byBlYWNoIGNhbGxiYWNrDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC50eXBlIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7U2Nyb2xsU2NlbmV9IGV2ZW50LnRhcmdldCAtIFRoZSBTY3JvbGxTY2VuZSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhpcyBldmVudA0KCQkgKiBAcHJvcGVydHkge251bWJlcn0gZXZlbnQucHJvZ3Jlc3MgLSBSZWZsZWN0cyB0aGUgY3VycmVudCBwcm9ncmVzcyBvZiB0aGUgc2NlbmUNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnN0YXRlIC0gVGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIHNjZW5lIGAiQkVGT1JFImAsIGAiRFVSSU5HImAgb3IgYCJBRlRFUiJgDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zY3JvbGxEaXJlY3Rpb24gLSBJbmRpY2F0ZXMgd2hpY2ggd2F5IHdlIGFyZSBzY3JvbGxpbmcgYCJQQVVTRUQiYCwgYCJGT1JXQVJEImAgb3IgYCJSRVZFUlNFImANCgkJICovDQoJCS8qKg0KCQkgKiBTY2VuZSB1cGRhdGUgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbmV2ZXIgdGhlIHNjZW5lIGlzIHVwZGF0ZWQgKGJ1dCBub3QgbmVjZXNzYXJpbHkgY2hhbmdlcyB0aGUgcHJvZ3Jlc3MpLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUudXBkYXRlDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJ1cGRhdGUiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQljb25zb2xlLmxvZygiU2NlbmUgdXBkYXRlZC4iKTsNCgkJICogfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBldmVudC5zdGFydFBvcyAtIFRoZSBzdGFydGluZyBwb3NpdGlvbiBvZiB0aGUgc2NlbmUgKGluIHJlbGF0aW9uIHRvIHRoZSBjb25haW5lcikNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LmVuZFBvcyAtIFRoZSBlbmRpbmcgcG9zaXRpb24gb2YgdGhlIHNjZW5lIChpbiByZWxhdGlvbiB0byB0aGUgY29uYWluZXIpDQoJCSAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBldmVudC5zY3JvbGxQb3MgLSBUaGUgY3VycmVudCBzY3JvbGwgcG9zaXRpb24gb2YgdGhlIGNvbnRhaW5lcg0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIHByb2dyZXNzIGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW5ldmVyIHRoZSBwcm9ncmVzcyBvZiB0aGUgc2NlbmUgY2hhbmdlcy4NCgkJICoNCgkJICogRm9yIGRldGFpbHMgb24gdGhpcyBldmVudCBhbmQgdGhlIG9yZGVyIGluIHdoaWNoIGl0IGlzIGZpcmVkLCBwbGVhc2UgcmV2aWV3IHRoZSB7QGxpbmsgU2Nyb2xsU2NlbmUucHJvZ3Jlc3N9IG1ldGhvZC4NCgkJICoNCgkJICogQGV2ZW50IFNjcm9sbFNjZW5lLnByb2dyZXNzDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJwcm9ncmVzcyIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJTY2VuZSBwcm9ncmVzcyBjaGFuZ2VkLiIpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtudW1iZXJ9IGV2ZW50LnByb2dyZXNzIC0gUmVmbGVjdHMgdGhlIGN1cnJlbnQgcHJvZ3Jlc3Mgb2YgdGhlIHNjZW5lDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5zdGF0ZSAtIFRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBzY2VuZSBgIkJFRk9SRSJgLCBgIkRVUklORyJgIG9yIGAiQUZURVIiYA0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQuc2Nyb2xsRGlyZWN0aW9uIC0gSW5kaWNhdGVzIHdoaWNoIHdheSB3ZSBhcmUgc2Nyb2xsaW5nIGAiUEFVU0VEImAsIGAiRk9SV0FSRCJgIG9yIGAiUkVWRVJTRSJgDQoJCSAqLw0KCQkvKioNCgkJICogU2NlbmUgY2hhbmdlIGV2ZW50LiAgDQoJCSAqIEZpcmVzIHdoZW52ZXZlciBhIHByb3BlcnR5IG9mIHRoZSBzY2VuZSBpcyBjaGFuZ2VkLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUuY2hhbmdlDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIHNjZW5lLm9uKCJjaGFuZ2UiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQljb25zb2xlLmxvZygiU2NlbmUgUHJvcGVydHkgXCIiICsgZXZlbnQud2hhdCArICJcIiBjaGFuZ2VkIHRvICIgKyBldmVudC5uZXd2YWwpOw0KCQkgKiB9KTsNCgkJICoNCgkJICogQHByb3BlcnR5IHtvYmplY3R9IGV2ZW50IC0gVGhlIGV2ZW50IE9iamVjdCBwYXNzZWQgdG8gZWFjaCBjYWxsYmFjaw0KCQkgKiBAcHJvcGVydHkge3N0cmluZ30gZXZlbnQudHlwZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudA0KCQkgKiBAcHJvcGVydHkge1Njcm9sbFNjZW5lfSBldmVudC50YXJnZXQgLSBUaGUgU2Nyb2xsU2NlbmUgb2JqZWN0IHRoYXQgdHJpZ2dlcmVkIHRoaXMgZXZlbnQNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LndoYXQgLSBJbmRpY2F0ZXMgd2hhdCB2YWx1ZSBoYXMgYmVlbiBjaGFuZ2VkDQoJCSAqIEBwcm9wZXJ0eSB7bWl4ZWR9IGV2ZW50Lm5ld3ZhbCAtIFRoZSBuZXcgdmFsdWUgb2YgdGhlIGNoYW5nZWQgcHJvcGVydHkNCgkJICovDQoJCS8qKg0KCQkgKiBTY2VuZSBzaGlmdCBldmVudC4gIA0KCQkgKiBGaXJlcyB3aGVudmV2ZXIgdGhlIHN0YXJ0IG9yIGVuZCAqKnNjcm9sbCBvZmZzZXQqKiBvZiB0aGUgc2NlbmUgY2hhbmdlLg0KCQkgKiBUaGlzIGhhcHBlbnMgZXhwbGljaXRlbHksIHdoZW4gb25lIG9mIHRoZXNlIHZhbHVlcyBjaGFuZ2U6IGBvZmZzZXRgLCBgZHVyYXRpb25gIG9yIGB0cmlnZ2VySG9va2AuDQoJCSAqIEl0IHdpbGwgZmlyZSBpbXBsaWNpdGx5IHdoZW4gdGhlIGB0cmlnZ2VyRWxlbWVudGAgY2hhbmdlcywgaWYgdGhlIG5ldyBlbGVtZW50IGhhcyBhIGRpZmZlcmVudCBwb3NpdGlvbiAobW9zdCBjYXNlcykuDQoJCSAqIEl0IHdpbGwgYWxzbyBmaXJlIGltcGxpY2l0bHkgd2hlbiB0aGUgc2l6ZSBvZiB0aGUgY29udGFpbmVyIGNoYW5nZXMgYW5kIHRoZSB0cmlnZ2VySG9vayBpcyBhbnl0aGluZyBvdGhlciB0aGFuIGBvbkxlYXZlYC4NCgkJICoNCgkJICogQGV2ZW50IFNjcm9sbFNjZW5lLnNoaWZ0DQoJCSAqIEBzaW5jZSAxLjEuMA0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiBzY2VuZS5vbigic2hpZnQiLCBmdW5jdGlvbiAoZXZlbnQpIHsNCgkJICogCQljb25zb2xlLmxvZygiU2NlbmUgbW92ZWQsIGJlY2F1c2UgdGhlICIgKyBldmVudC5yZWFzb24gKyAiIGhhcyBjaGFuZ2VkLikiKTsNCgkJICogfSk7DQoJCSAqDQoJCSAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBldmVudCAtIFRoZSBldmVudCBPYmplY3QgcGFzc2VkIHRvIGVhY2ggY2FsbGJhY2sNCgkJICogQHByb3BlcnR5IHtzdHJpbmd9IGV2ZW50LnR5cGUgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQNCgkJICogQHByb3BlcnR5IHtTY3JvbGxTY2VuZX0gZXZlbnQudGFyZ2V0IC0gVGhlIFNjcm9sbFNjZW5lIG9iamVjdCB0aGF0IHRyaWdnZXJlZCB0aGlzIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC5yZWFzb24gLSBJbmRpY2F0ZXMgd2h5IHRoZSBzY2VuZSBoYXMgc2hpZnRlZA0KCQkgKi8NCgkJLyoqDQoJCSAqIFNjZW5lIGRlc3Ryb3kgZXZlbnQuICANCgkJICogRmlyZXMgd2hlbnZldmVyIHRoZSBzY2VuZSBpcyBkZXN0cm95ZWQuDQoJCSAqIFRoaXMgY2FuIGJlIHVzZWQgdG8gdGlkeSB1cCBjdXN0b20gYmVoYXZpb3VyIHVzZWQgaW4gZXZlbnRzLg0KCQkgKg0KCQkgKiBAZXZlbnQgU2Nyb2xsU2NlbmUuZGVzdHJveQ0KCQkgKiBAc2luY2UgMS4xLjANCgkJICoNCgkJICogQGV4YW1wbGUNCgkJICogc2NlbmUub24oImVudGVyIiwgZnVuY3Rpb24gKGV2ZW50KSB7DQoJCSAqICAgICAgICAvLyBhZGQgY3VzdG9tIGFjdGlvbg0KCQkgKiAgICAgICAgJCgiI215LWVsZW0iKS5sZWZ0KCIyMDAiKTsNCgkJICogICAgICB9KQ0KCQkgKiAgICAgIC5vbigiZGVzdHJveSIsIGZ1bmN0aW9uIChldmVudCkgew0KCQkgKiAgICAgICAgLy8gcmVzZXQgbXkgZWxlbWVudCB0byBzdGFydCBwb3NpdGlvbg0KCQkgKiAgICAgICAgaWYgKGV2ZW50LnJlc2V0KSB7DQoJCSAqICAgICAgICAgICQoIiNteS1lbGVtIikubGVmdCgiMCIpOw0KCQkgKiAgICAgICAgfQ0KCQkgKiAgICAgIH0pOw0KCQkgKg0KCQkgKiBAcHJvcGVydHkge29iamVjdH0gZXZlbnQgLSBUaGUgZXZlbnQgT2JqZWN0IHBhc3NlZCB0byBlYWNoIGNhbGxiYWNrDQoJCSAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBldmVudC50eXBlIC0gVGhlIG5hbWUgb2YgdGhlIGV2ZW50DQoJCSAqIEBwcm9wZXJ0eSB7U2Nyb2xsU2NlbmV9IGV2ZW50LnRhcmdldCAtIFRoZSBTY3JvbGxTY2VuZSBvYmplY3QgdGhhdCB0cmlnZ2VyZWQgdGhpcyBldmVudA0KCQkgKiBAcHJvcGVydHkge2Jvb2xlYW59IGV2ZW50LnJlc2V0IC0gSW5kaWNhdGVzIGlmIHRoZSBkZXN0cm95IG1ldGhvZCB3YXMgY2FsbGVkIHdpdGggcmVzZXQgYHRydWVgIG9yIGBmYWxzZWAuDQoJCSAqLw0KCQkgDQoJCSAvKioNCgkJICogQWRkIG9uZSBvcmUgbW9yZSBldmVudCBsaXN0ZW5lci4gIA0KCQkgKiBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2lsbCBiZSBmaXJlZCBhdCB0aGUgcmVzcGVjdGl2ZSBldmVudCwgYW5kIGFuIG9iamVjdCBjb250YWluaW5nIHJlbGV2YW50IGRhdGEgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLg0KCQkgKiBAcHVibGljDQoJCSAqDQoJCSAqIEBleGFtcGxlDQoJCSAqIGZ1bmN0aW9uIGNhbGxiYWNrIChldmVudCkgew0KCQkgKiAJCWNvbnNvbGUubG9nKCJFdmVudCBmaXJlZCEgKCIgKyBldmVudC50eXBlICsgIikiKTsNCgkJICogfQ0KCQkgKiAvLyBhZGQgbGlzdGVuZXJzDQoJCSAqIHNjZW5lLm9uKCJjaGFuZ2UgdXBkYXRlIHByb2dyZXNzIHN0YXJ0IGVuZCBlbnRlciBsZWF2ZSIsIGNhbGxiYWNrKTsNCgkJICoNCgkJICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvciBuYW1lcyBvZiB0aGUgZXZlbnQgdGhlIGNhbGxiYWNrIHNob3VsZCBiZSBhdHRhY2hlZCB0by4NCgkJICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBBIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIGV4ZWN1dGVkLCB3aGVuIHRoZSBldmVudCBpcyBkaXNwYXRjaGVkLiBBbiBldmVudCBvYmplY3Qgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLg0KCQkgKiBAcmV0dXJucyB7U2Nyb2xsU2NlbmV9IFBhcmVudCBvYmplY3QgZm9yIGNoYWluaW5nLg0KCQkgKi8NCgkJIHRoaXMub24gPSBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2spIHsNCgkJCWlmICgkLmlzRnVuY3Rpb24oY2FsbGJhY2spKSB7DQoJCQkJdmFyIG5hbWVzID0gJC50cmltKG5hbWUpLnRvTG93ZXJDYXNlKCkNCgkJCQkJCQkucmVwbGFjZSgvKFx3KylcLihcdyspL2csICckMS4nICsgTkFNRVNQQUNFICsgJ18kMicpIC8vIGFkZCBjdXN0b20gbmFtZXNwYWNlLCBpZiBvbmUgaXMgZGVmaW5lZA0KCQkJCQkJCS5yZXBsYWNlKC8oIHxeKShcdyspKD89IHwkKS9nLCAnJDEkMi4nICsgTkFNRVNQQUNFICk7IC8vIGFkZCBuYW1lc3BhY2UgdG8gcmVndWxhcnMuDQoJCQkJJChTY3JvbGxTY2VuZSkub24obmFtZXMsIGNhbGxiYWNrKTsNCgkJCX0gZWxzZSB7DQoJCQkJbG9nKDEsICJFUlJPUiBjYWxsaW5nIG1ldGhvZCAnb24oKSc6IFN1cHBsaWVkIGFyZ3VtZW50IGlzIG5vdCBhIHZhbGlkIGNhbGxiYWNrISIpOw0KCQkJfQ0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQkgfTsNCg0KCQkgLyoqDQoJCSAqIFJlbW92ZSBvbmUgb3IgbW9yZSBldmVudCBsaXN0ZW5lci4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiBmdW5jdGlvbiBjYWxsYmFjayAoZXZlbnQpIHsNCgkJICogCQljb25zb2xlLmxvZygiRXZlbnQgZmlyZWQhICgiICsgZXZlbnQudHlwZSArICIpIik7DQoJCSAqIH0NCgkJICogLy8gYWRkIGxpc3RlbmVycw0KCQkgKiBzY2VuZS5vbigiY2hhbmdlIHVwZGF0ZSIsIGNhbGxiYWNrKTsNCgkJICogLy8gcmVtb3ZlIGxpc3RlbmVycw0KCQkgKiBzY2VuZS5vZmYoImNoYW5nZSB1cGRhdGUiLCBjYWxsYmFjayk7DQoJCSAqDQoJCSAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb3IgbmFtZXMgb2YgdGhlIGV2ZW50IHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuDQoJCSAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gLSBBIHNwZWNpZmljIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuIElmIG5vbmUgaXMgcGFzc2VkIGFsbCBjYWxsYmFja3MgdG8gdGhlIGV2ZW50IGxpc3RlbmVyIHdpbGwgYmUgcmVtb3ZlZC4NCgkJICogQHJldHVybnMge1Njcm9sbFNjZW5lfSBQYXJlbnQgb2JqZWN0IGZvciBjaGFpbmluZy4NCgkJICovDQoJCSB0aGlzLm9mZiA9IGZ1bmN0aW9uIChuYW1lLCBjYWxsYmFjaykgew0KCQkJdmFyIG5hbWVzID0gJC50cmltKG5hbWUpLnRvTG93ZXJDYXNlKCkNCgkJCQkJCS5yZXBsYWNlKC8oXHcrKVwuKFx3KykvZywgJyQxLicgKyBOQU1FU1BBQ0UgKyAnXyQyJykgLy8gYWRkIGN1c3RvbSBuYW1lc3BhY2UsIGlmIG9uZSBpcyBkZWZpbmVkDQoJCQkJCQkucmVwbGFjZSgvKCB8XikoXHcrKSg/PSB8JCkvZywgJyQxJDIuJyArIE5BTUVTUEFDRSArICckMycpOyAvLyBhZGQgbmFtZXNwYWNlIHRvIHJlZ3VsYXJzLg0KCQkJJChTY3JvbGxTY2VuZSkub2ZmKG5hbWVzLCBjYWxsYmFjayk7DQoJCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJCSB9Ow0KDQoJCSAvKioNCgkJICogVHJpZ2dlciBhbiBldmVudC4NCgkJICogQHB1YmxpYw0KCQkgKg0KCQkgKiBAZXhhbXBsZQ0KCQkgKiB0aGlzLnRyaWdnZXIoImNoYW5nZSIpOw0KCQkgKg0KCQkgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBldmVudCB0aGF0IHNob3VsZCBiZSB0cmlnZ2VyZWQuDQoJCSAqIEBwYXJhbSB7b2JqZWN0fSBbdmFyc10gLSBBbiBvYmplY3QgY29udGFpbmluZyBpbmZvIHRoYXQgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suDQoJCSAqIEByZXR1cm5zIHtTY3JvbGxTY2VuZX0gUGFyZW50IG9iamVjdCBmb3IgY2hhaW5pbmcuDQoJCSAqLw0KCQkgdGhpcy50cmlnZ2VyID0gZnVuY3Rpb24gKG5hbWUsIHZhcnMpIHsNCgkJCWxvZygzLCAnZXZlbnQgZmlyZWQ6JywgbmFtZSwgIi0+IiwgdmFycyk7DQoJCQl2YXIgZXZlbnQgPSAkLkV2ZW50KCQudHJpbShuYW1lKS50b0xvd2VyQ2FzZSgpLCB2YXJzKTsNCgkJCSQoU2Nyb2xsU2NlbmUpLnRyaWdnZXIoZXZlbnQpOw0KCQkJcmV0dXJuIFNjcm9sbFNjZW5lOw0KCQkgfTsNCg0KCQkvLyBJTklUDQoJCWNvbnN0cnVjdCgpOw0KCQlyZXR1cm4gU2Nyb2xsU2NlbmU7DQoJfTsNCglyZXR1cm4gU2Nyb2xsU2NlbmU7DQp9KTsNCg0KCS8qDQoJICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQ0KCSAqIGdsb2JhbCBsb2dnaW5nIGZ1bmN0aW9ucyBhbmQgbWFraW5nIHN1cmUgbm8gY29uc29sZSBlcnJvcnMgb2NjdXINCgkgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tDQoJICovDQoNCgl2YXIgZGVidWcgPSAoZnVuY3Rpb24gKGNvbnNvbGUpIHsNCgkJdmFyIGxvZ2xldmVscyA9IFsiZXJyb3IiLCAid2FybiIsICJsb2ciXTsNCgkJaWYgKCFjb25zb2xlLmxvZykgew0KCQkJY29uc29sZS5sb2cgPSBmdW5jdGlvbigpe307IC8vIG5vIGNvbnNvbGUgbG9nLCB3ZWxsIC0gZG8gbm90aGluZyB0aGVuLi4uDQoJCX0NCgkJZm9yKHZhciBpID0gMCwgbWV0aG9kOyBpJmx0O2xvZ2xldmVscy5sZW5ndGg7IGkrKykgeyAvLyBtYWtlIHN1cmUgbWV0aG9kcyBmb3IgYWxsIGxldmVscyBleGlzdC4NCgkJCW1ldGhvZCA9IGxvZ2xldmVsc1tpXTsNCgkJCWlmICghY29uc29sZVttZXRob2RdKSB7DQoJCQkJY29uc29sZVttZXRob2RdID0gY29uc29sZS5sb2c7IC8vIHByZWZlciAubG9nIG92ZXIgbm90aGluZw0KCQkJfQ0KCQl9DQoJCS8vIGRlYnVnZ2luZyBmdW5jdGlvbg0KCQlyZXR1cm4gZnVuY3Rpb24gKGxvZ2xldmVsKSB7DQoJCQlpZiAobG9nbGV2ZWwgPiBsb2dsZXZlbHMubGVuZ3RoIHx8IGxvZ2xldmVsICZsdDs9IDApIGxvZ2xldmVsID0gbG9nbGV2ZWxzLmxlbmd0aDsNCgkJCXZhciBub3cgPSBuZXcgRGF0ZSgpLA0KCQkJCXRpbWUgPSAoIjAiK25vdy5nZXRIb3VycygpKS5zbGljZSgtMikgKyAiOiIgKyAoIjAiK25vdy5nZXRNaW51dGVzKCkpLnNsaWNlKC0yKSArICI6IiArICgiMCIrbm93LmdldFNlY29uZHMoKSkuc2xpY2UoLTIpICsgIjoiICsgKCIwMCIrbm93LmdldE1pbGxpc2Vjb25kcygpKS5zbGljZSgtMyksDQoJCQkJbWV0aG9kID0gbG9nbGV2ZWxzW2xvZ2xldmVsLTFdLA0KCQkJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwNCgkJCQlmdW5jID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQuY2FsbChjb25zb2xlW21ldGhvZF0sIGNvbnNvbGUpOw0KDQoJCQlhcmdzLnVuc2hpZnQodGltZSk7DQoJCQlmdW5jLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOw0KCQl9Ow0KCX0od2luZG93LmNvbnNvbGUgPSB3aW5kb3cuY29uc29sZSB8fCB7fSkpOw0KCS8vIGEgaGVscGVyIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGdlbmVyYWxseSBiZSBmYXN0ZXIgdGhhbiBqUXVlcnkub2Zmc2V0KCkgYW5kIGNhbiBhbHNvIHJldHVybiBwb3NpdGlvbiBpbiByZWxhdGlvbiB0byB2aWV3cG9ydC4NCgl2YXIgZ2V0T2Zmc2V0ID0gZnVuY3Rpb24gKGVsZW0sIHJlbGF0aXZlVG9WaWV3cG9ydCkgew0KCQl2YXIgb2Zmc2V0ID0ge3RvcDogMCwgbGVmdDogMH07DQoJCWVsZW0gPSBlbGVtWzBdOyAvLyB0bXAgd29ya2Fyb3VuZCB1bnRpbCBqUXVlcnkgZGVwZW5kZW5jeSBpcyByZW1vdmVkLg0KCQlpZiAoZWxlbSAmYW1wOyZhbXA7IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KSB7IC8vIGNoZWNrIGlmIGF2YWlsYWJsZQ0KCQkJdmFyIHJlY3QgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KCQkJb2Zmc2V0LnRvcCA9IHJlY3QudG9wOw0KCQkJb2Zmc2V0LmxlZnQgPSByZWN0LmxlZnQ7DQoJCQlpZiAoIXJlbGF0aXZlVG9WaWV3cG9ydCkgeyAvLyBjbGllbnRSZWN0IGlzIGJ5IGRlZmF1bHQgcmVsYXRpdmUgdG8gdmlld3BvcnQuLi4NCgkJCQlvZmZzZXQudG9wICs9ICh3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuc2Nyb2xsVG9wICB8fCAwKSAtIChkb2N1bWVudC5jbGllbnRUb3AgIHx8IDApOw0KCQkJCW9mZnNldC5sZWZ0ICs9ICh3aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jdW1lbnQuc2Nyb2xsTGVmdCAgfHwgMCkgLSAoZG9jdW1lbnQuY2xpZW50TGVmdCB8fCAwKTsNCgkJCX0NCgkJfQ0KCQlyZXR1cm4gb2Zmc2V0Ow0KCX07DQoJdmFyIGlzRG9tRWxlbWVudCA9IGZ1bmN0aW9uIChvKXsNCgkJcmV0dXJuICgNCgkJCXR5cGVvZiBIVE1MRWxlbWVudCA9PT0gIm9iamVjdCIgPyBvIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgOiAvL0RPTTINCgkJCW8gJmFtcDsmYW1wOyB0eXBlb2YgbyA9PT0gIm9iamVjdCIgJmFtcDsmYW1wOyBvICE9PSBudWxsICZhbXA7JmFtcDsgby5ub2RlVHlwZSA9PT0gMSAmYW1wOyZhbXA7IHR5cGVvZiBvLm5vZGVOYW1lPT09InN0cmluZyINCgkJKTsNCgl9Ow0KCXZhciBpc01hcmdpbkNvbGxhcHNlVHlwZSA9IGZ1bmN0aW9uIChzdHIpIHsNCgkJcmV0dXJuIFsiYmxvY2siLCAiZmxleCIsICJsaXN0LWl0ZW0iLCAidGFibGUiLCAiLXdlYmtpdC1ib3giXS5pbmRleE9mKHN0cikgPiAtMTsNCgl9Ow0KCS8vIGltcGxlbWVudGF0aW9uIG9mIHJlcXVlc3RBbmltYXRpb25GcmFtZQ0KCXZhciBhbmltYXRpb25GcmFtZUNhbGxiYWNrID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsNCgl2YXIgYW5pbWF0aW9uRnJhbWVDYW5jZWxDYWxsYmFjayA9IHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZTsNCg0KCS8vIHBvbHlmaWxsIC0+IGJhc2VkIG9uIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL3BhdWxpcmlzaC8xNTc5NjcxDQoJKGZ1bmN0aW9uICh3aW5kb3cpIHsNCgkJdmFyDQoJCQlsYXN0VGltZSA9IDAsDQoJCQl2ZW5kb3JzID0gWydtcycsICdtb3onLCAnd2Via2l0JywgJ28nXSwNCgkJCWk7DQoNCgkJLy8gdHJ5IHZlbmRvciBwcmVmaXhlcyBpZiB0aGUgYWJvdmUgZG9lc24ndCB3b3JrDQoJCWZvciAoaSA9IDA7ICFhbmltYXRpb25GcmFtZUNhbGxiYWNrICZhbXA7JmFtcDsgaSAmbHQ7IHZlbmRvcnMubGVuZ3RoOyArK2kpIHsNCgkJCWFuaW1hdGlvbkZyYW1lQ2FsbGJhY2sgPSB3aW5kb3dbdmVuZG9yc1tpXSArICdSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTsNCgkJCWFuaW1hdGlvbkZyYW1lQ2FuY2VsQ2FsbGJhY2sgPSB3aW5kb3dbdmVuZG9yc1tpXSArICdDYW5jZWxBbmltYXRpb25GcmFtZSddIHx8IHdpbmRvd1t2ZW5kb3JzW2ldICsgJ0NhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZSddOw0KCQl9DQoNCgkJLy8gZmFsbGJhY2tzDQoJCWlmICghYW5pbWF0aW9uRnJhbWVDYWxsYmFjaykgew0KCQkJYW5pbWF0aW9uRnJhbWVDYWxsYmFjayA9IGZ1bmN0aW9uIChjYWxsYmFjaykgew0KCQkJCXZhcg0KCQkJCQljdXJyVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpLA0KCQkJCQl0aW1lVG9DYWxsID0gTWF0aC5tYXgoMCwgMTYgLSAoY3VyclRpbWUgLSBsYXN0VGltZSkpLA0KCQkJCQlpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgY2FsbGJhY2soY3VyclRpbWUgKyB0aW1lVG9DYWxsKTsgfSwgdGltZVRvQ2FsbCk7DQoJCQkJbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGw7DQoJCQkJcmV0dXJuIGlkOw0KCQkJfTsNCgkJfQ0KCQlpZiAoIWFuaW1hdGlvbkZyYW1lQ2FuY2VsQ2FsbGJhY2spIHsNCgkJCWFuaW1hdGlvbkZyYW1lQ2FuY2VsQ2FsbGJhY2sgPSBmdW5jdGlvbiAoaWQpIHsNCgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KGlkKTsNCgkJCX07DQoJCX0NCgl9KHdpbmRvdykpOw0KDQp9KSh0aGlzIHx8IHdpbmRvdyk7PC9wcmU+CiAgICAgICAgPC9hcnRpY2xlPgogICAgPC9zZWN0aW9uPgoKCgoKCgkJCQk8L2Rpdj4KCgkJCQk8ZGl2IGNsYXNzPSJjbGVhcmZpeCI+PC9kaXY+CgkJCQk8Zm9vdGVyPgoJCQkJCQoJCQkJCQoJCTxzcGFuIGNsYXNzPSJjb3B5cmlnaHQiPgoJCcKpIEphbiBQYWVwa2UgMjAxNAoJCTwvc3Bhbj4KCQkJCQk8YnIgLz4KCQkJCQkKCQk8c3BhbiBjbGFzcz0ianNkb2MtbWVzc2FnZSI+CgkJRG9jdW1lbnRhdGlvbiBnZW5lcmF0ZWQgYnkgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL2pzZG9jMy9qc2RvYyIgdGFyZ2V0PSJfYmxhbmsiPkpTRG9jIDMuMy4wLWFscGhhOTwvYT4KCQl1c2luZyBhIGN1c3RvbWl6ZWQgdmVyc2lvbiBvZiB0aGUgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL3RlcnJ5d2Vpc3MvZG9jc3RyYXAiIHRhcmdldD0iX2JsYW5rIj5Eb2NTdHJhcCB0ZW1wbGF0ZTwvYT4uCgkJPC9zcGFuPgoJCQkJPC9mb290ZXI+CgkJCTwvZGl2PgoKCQkJCgkJCTxiciBjbGVhcj0iYm90aCI+CgkJPC9kaXY+CgoJPC9kaXY+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9zdW5saWdodC5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9zdW5saWdodC5qYXZhc2NyaXB0LmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL3N1bmxpZ2h0LXBsdWdpbi5kb2NsaW5rcy5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9zdW5saWdodC1wbHVnaW4ubGluZW51bWJlcnMuanMiPjwvc2NyaXB0PgoJPHNjcmlwdCBzcmM9InNjcmlwdHMvc3VubGlnaHQtcGx1Z2luLm1lbnUuanMiPjwvc2NyaXB0PgoJPHNjcmlwdCBzcmM9InNjcmlwdHMvanF1ZXJ5Lm1pbi5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy9qcXVlcnkuc2Nyb2xsVG8uanMiPjwvc2NyaXB0PgoJPHNjcmlwdCBzcmM9InNjcmlwdHMvanF1ZXJ5LmxvY2FsU2Nyb2xsLmpzIj48L3NjcmlwdD4KCTxzY3JpcHQgc3JjPSJzY3JpcHRzL2Jvb3RzdHJhcC1kcm9wZG93bi5qcyI+PC9zY3JpcHQ+Cgk8c2NyaXB0IHNyYz0ic2NyaXB0cy90b2MuanMiPjwvc2NyaXB0PgoKCTxzY3JpcHQ+IHByZXR0eVByaW50KCk7IDwvc2NyaXB0PgoJPHNjcmlwdD4gIFN1bmxpZ2h0LmhpZ2hsaWdodEFsbCh7bGluZU51bWJlcnM6dHJ1ZSwgIHNob3dNZW51OiB0cnVlLCBlbmFibGVEb2NsaW5rcyA6dHJ1ZX0pOyA8L3NjcmlwdD4KCgk8c2NyaXB0PgoJCWZ1bmN0aW9uIG9wZW5EZWVwbGlua2VkRWxlbWVudCAoc2tpcEFuaSkgewoJCQkkKCJkdCBoNC5tZW1iZXItY29sbGFwc2VkW2lkPSciICsgd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpLnJlcGxhY2UoIjoiLCAiXFw6IikgKyInXSIpLnRyaWdnZXIoImNsaWNrIiwgc2tpcEFuaSk7CgkJfQoJCSQoIGZ1bmN0aW9uICgpIHsKCQkJJCggIiN0b2MiICkudG9jKCB7CgkJCSAgICBhbmNob3JOYW1lICA6IGZ1bmN0aW9uKGksIGhlYWRpbmcsIHByZWZpeCkgewoJCQkJCXJldHVybiAkKGhlYWRpbmcpLmF0dHIoImlkIikgfHwgKCBwcmVmaXggKyBpICk7CgkJCQl9LAoJCQkJc2VsZWN0b3JzICAgOiAiaDE6dmlzaWJsZSxoMjp2aXNpYmxlLGgzOnZpc2libGUsaDQ6dmlzaWJsZSIsCgkJCQlvblNjcm9sbEZpbmlzaCA6IG9wZW5EZWVwbGlua2VkRWxlbWVudCwKCQkJCWhpZ2hsaWdodE9mZnNldCA6IDEwLAoJCQkJc2Nyb2xsT2Zmc2V0OiA2MAoJCQl9ICk7CgkJCSQoICIjdG9jPnVsIiApLmFkZENsYXNzKCAibmF2IG5hdi1waWxscyBuYXYtc3RhY2tlZCIgKTsKCQkJJCggIiNtYWluIHNwYW5baWRePSd0b2MnXSIgKS5hZGRDbGFzcyggInRvYy1zaGltIiApOwoKCQl9ICk7Cgk8L3NjcmlwdD4KCgkKCTxzY3JpcHQ+CgkJJCggZnVuY3Rpb24gKCkgewoJCQkvLyAkKCcjbWFpbicpLmxvY2FsU2Nyb2xsKHsKCQkJLy8gCW9mZnNldDogeyB0b3A6IDU2IH0gLy9vZmZzZXQgYnkgdGhlIGhlaWdodCBvZiB5b3VyIGhlYWRlciAoZ2l2ZSBvciB0YWtlIGEgZmV3IHB4LCBzZWUgd2hhdCB3b3JrcyBmb3IgeW91KQoJCQkvLyB9KTsKCQkJLy8gd29ya2Fyb3VuZCBmb3IgYW5jaG9ycyBiZWxvdyBoZWFkZXIuLi4KCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewoJCQkJJChkb2N1bWVudCkuc2Nyb2xsVG9wKCQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpLTYwKTsKCQkJfSwgMSkKCQkJCgkJCXZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpLnJlcGxhY2UoIjoiLCAiXFw6Iik7CgkJCSQoICJkdCBoNC5uYW1lIiApLmVhY2goIGZ1bmN0aW9uICgpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCQkJCXZhciBpY29uID0gJCggIjxpLz4iICkuYWRkQ2xhc3MoICJpY29uLXBsdXMtc2lnbiIgKS5hZGRDbGFzcyggInB1bGwtcmlnaHQiICkuYWRkQ2xhc3MoICJpY29uLXdoaXRlIiApOwoJCQkJdmFyIGR0ID0gJHRoaXMucGFyZW50cyggImR0IiApOwoJCQkJdmFyIGNoaWxkcmVuID0gZHQubmV4dCggImRkIiApOwoKCQkJCSR0aGlzLmFwcGVuZCggaWNvbiApLmNzcygge2N1cnNvciA6ICJwb2ludGVyIn0gKTsKCQkJCSR0aGlzLmFkZENsYXNzKCAibWVtYmVyLWNvbGxhcHNlZCIgKS5hZGRDbGFzcyggIm1lbWJlciIgKTsKCQkJCWlmIChoYXNoICE9ICR0aGlzLmF0dHIoImlkIikpIHsKCQkJCQljaGlsZHJlbi5oaWRlKCk7CgkJCQl9CgkJCQkkdGhpcy50b2dnbGUoIGZ1bmN0aW9uIChlLCBza2lwQW5pKSB7CgkJCQkJdmFyIHNjcm9sbFBvcyA9ICQoZG9jdW1lbnQpLnNjcm9sbFRvcCgpOwoJCQkJCXdpbmRvdy5sb2NhdGlvbi5oYXNoID0gJCh0aGlzKS5hdHRyKCJpZCIpOwoJCQkJCSQoZG9jdW1lbnQpLnNjcm9sbFRvcChzY3JvbGxQb3MpOwoJCQkJCWljb24uYWRkQ2xhc3MoICJpY29uLW1pbnVzLXNpZ24iICkucmVtb3ZlQ2xhc3MoICJpY29uLXBsdXMtc2lnbiIgKS5yZW1vdmVDbGFzcyggImljb24td2hpdGUiICk7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJtZW1iZXItb3BlbiIgKS5yZW1vdmVDbGFzcyggIm1lbWJlci1jb2xsYXBzZWQiICk7CgkJCQkJY2hpbGRyZW4uc2xpZGVEb3duKHNraXBBbmkgPyAwIDogdW5kZWZpbmVkKTsKCQkJCX0sIGZ1bmN0aW9uICgpIHsKCQkJCQlpY29uLmFkZENsYXNzKCAiaWNvbi1wbHVzLXNpZ24iICkucmVtb3ZlQ2xhc3MoICJpY29uLW1pbnVzLXNpZ24iICkuYWRkQ2xhc3MoICJpY29uLXdoaXRlIiApOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAibWVtYmVyLWNvbGxhcHNlZCIgKS5yZW1vdmVDbGFzcyggIm1lbWJlci1vcGVuIiApOwoJCQkJCWNoaWxkcmVuLnNsaWRlVXAoKTsKCQkJCX0gKTsKCQkJfSApOwoJCQkvLyBvcGVuIGlmIGRlZXBsaW5rZWQKCQkJaWYgKGhhc2gubGVuZ3RoID4gMCkKCQkJCW9wZW5EZWVwbGlua2VkRWxlbWVudCh0cnVlKTsKCQl9ICk7Cgk8L3NjcmlwdD4KCQoKCTxzY3JpcHQ+CgkJKGZ1bmN0aW9uKGkscyxvLGcscixhLG0pe2lbJ0dvb2dsZUFuYWx5dGljc09iamVjdCddPXI7aVtyXT1pW3JdfHxmdW5jdGlvbigpewoJCShpW3JdLnE9aVtyXS5xfHxbXSkucHVzaChhcmd1bWVudHMpfSxpW3JdLmw9MSpuZXcgRGF0ZSgpO2E9cy5jcmVhdGVFbGVtZW50KG8pLAoJCW09cy5nZXRFbGVtZW50c0J5VGFnTmFtZShvKVswXTthLmFzeW5jPTE7YS5zcmM9ZzttLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGEsbSkKCQl9KSh3aW5kb3csZG9jdW1lbnQsJ3NjcmlwdCcsJy8vd3d3Lmdvb2dsZS1hbmFseXRpY3MuY29tL2FuYWx5dGljcy5qcycsJ2dhJyk7CgkJZ2EoJ2NyZWF0ZScsICdVQS0zNzUyNDM0NC0zJywgJ2phbnBhZXBrZS5naXRodWIuaW8nKTsKCQlnYSgnc2VuZCcsICdwYWdldmlldycpOwoJPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:08:55 GMT",
                    "Content-Length": "105821",
                    "Date": "Sat, 08 Nov 2014 04:08:56 GMT",
                    "Content-Type": "text/html; charset=utf-8"
                },
                "cookies": [],
                "mimeType": "HTML",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}