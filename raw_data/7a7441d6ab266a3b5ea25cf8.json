{
    "url": "http://localhost:9999/driftyco/graphite/res/jqm/1.2.0/jquery.mobile-1.2.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.replace( /#.*/, '' ) + history_hash;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/driftyco/graphite/res/jqm/1.2.0/jquery.mobile-1.2.0.js",
                "path": "/driftyco/graphite/res/jqm/1.2.0/jquery.mobile-1.2.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kcmlmdHljby9ncmFwaGl0ZS9yZXMvanFtLzEuMi4wL2pxdWVyeS5tb2JpbGUtMS4yLjAuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjkzNTM0DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAyOjM2OjA0IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMjozNjowNCBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayBHaXQgQnVpbGQ6IFNIQTE6IGI0OWNjMDY0OTlhYmY4Zjk4N2NmOTBmMzUzNDljZmFjMDkxOGM5MzkgPD4gRGF0ZTogVHVlIE9jdCAyIDExOjIyOjM0IDIwMTIgLTA3MDAKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwoqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCioKKi8KCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgge30sIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4yLjAiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQoIGRvY3VtZW50ICkudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKSwgOmpxbURhdGEocm9sZT0iZGlhbG9nIiknICkKCQkJCS5kYXRhKCAicGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCk7CgkJfQoJfSwgJC5tb2JpbGUgKTsKCgkvLyBNb2JpbGUgdmVyc2lvbiBvZiBkYXRhIGFuZCByZW1vdmVEYXRhIGFuZCBoYXNEYXRhIG1ldGhvZHMKCS8vIGVuc3VyZXMgYWxsIGRhdGEgaXMgc2V0IGFuZCByZXRyaWV2ZWQgdXNpbmcgalF1ZXJ5IE1vYmlsZSdzIGRhdGEgbmFtZXNwYWNlCgkkLmZuLmpxbURhdGEgPSBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCgkJCS8vIHVuZGVmaW5lZCBpcyBwZXJtaXR0ZWQgYXMgYW4gZXhwbGljaXQgaW5wdXQgZm9yIHRoZSBzZWNvbmQgcGFyYW0KCQkJLy8gaW4gdGhpcyBjYXNlIGl0IHJldHVybnMgdGhlIHZhbHVlIGFuZCBkb2VzIG5vdCBzZXQgaXQgdG8gdW5kZWZpbmVkCgkJCWlmKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKSApLnJlbW92ZSgpOwoJCSRlbGVtLnJlbW92ZSgpOwoJfTsKCgkkLmZuLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkkLmFkZERlcGVuZGVudHMoICQoIHRoaXMgKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycsICQubWVyZ2UoIGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCggdGhpcyApLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IHYxLjkuMC1iZXRhLjEKICoKICogQ29weXJpZ2h0IDIwMTIsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LXVpL2Jsb2IvMS45LjAtYmV0YS4xL0FVVEhPUlMudHh0IChodHRwOi8vanF1ZXJ5dWkuY29tL2Fib3V0KQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1VJL1dpZGdldAogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogbmFtZQoJfSwgcHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJLy8gVE9ETyByZW1vdmUgd2lkZ2V0QmFzZUNsYXNzLCBzZWUgIzgxNTUKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgPyAkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDogdmFsdWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQluZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oeyByZW1vdmU6ICJkZXN0cm95IiB9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlpbnN0YW5jZS53aWRnZXQoKS5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICggJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdIHx8ICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSAmJiAkLmVmZmVjdHNbIGVmZmVjdE5hbWUgXSApICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKLy8gREVQUkVDQVRFRAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZS5fZ2V0Q3JlYXRlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1ldGFkYXRhICYmICQubWV0YWRhdGEuZ2V0KCB0aGlzLmVsZW1lbnRbMF0gKVsgdGhpcy53aWRnZXROYW1lIF07Cgl9Owp9Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCB0aGlzLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAkKCB0YXJnZXQgKSksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKSwgc2VsZiA9IHRoaXM7CgoJCS8vIGlmIGlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCB0byB0cnVlIHRoZSBmcmFtZXdvcmsgc2hvdWxkCgkJLy8gb25seSBlbmhhbmNlIHRoZSBzZWxlY3RlZCBlbGVtZW50cyB3aGVuIHRoZXkgZG8gTk9UIGhhdmUgYQoJCS8vIHBhcmVudCB3aXRoIHRoZSBkYXRhLW5hbWVzcGFjZS1pZ25vcmUgYXR0cmlidXRlCgkJJHdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoICR3aWRnZXRFbGVtZW50cyApOwoKCQlpZiAoIHVzZUtlZXBOYXRpdmUgJiYgJHdpZGdldEVsZW1lbnRzLmxlbmd0aCApIHsKCQkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCQkvLyBDdXJyZW50bHkgdGhlIGtlZXBOYXRpdmUgdmFsdWUgaXMgZGVmaW5lZCBvbiB0aGUgcGFnZSBwcm90b3R5cGUgc28KCQkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJCXBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICR3aWRnZXRFbGVtZW50cyApOwoJCQlrZWVwTmF0aXZlID0gKCBwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdzaG93JywgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdoaWRlJyApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQoIHdpbmRvdyApOwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsICRoZWFkZXIsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUodGhlbWUpID09PSAib2JqZWN0IiApIHsKCQkJCWxvYWRTZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCB0aGVtZSApOwoKCQkJCS8vIHByZWZlciBvYmplY3QgcHJvcGVydHkgZnJvbSB0aGUgcGFyYW0gdGhlbiB0aGUgb2xkIHRoZW1lIHNldHRpbmcKCQkJCXRoZW1lID0gbG9hZFNldHRpbmdzLnRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW0gdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUgfHwgbG9hZFNldHRpbmdzLnRoZW1lOwoJCQl9CgoJCQkvLyBzZXQgdGhlIG1lc3NhZ2UgdGV4dCwgcHJlZmVyIHRoZSBwYXJhbSwgdGhlbiB0aGUgc2V0dGluZ3Mgb2JqZWN0CgkJCS8vIHRoZW4gbG9hZGluZyBtZXNzYWdlCgkJCW1lc3NhZ2UgPSBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIHx8IGxvYWRTZXR0aW5ncy50ZXh0OwoKCQkJLy8gcHJlcGFyZSB0aGUgZG9tCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgIT09IGZhbHNlIHx8IGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJLy8gYm9vbGVhbiB2YWx1ZXMgcmVxdWlyZSBhIGJpdCBtb3JlIHdvcmsgOlAsIHN1cHBvcnRzIG9iamVjdCBwcm9wZXJ0aWVzCgkJCQkvLyBhbmQgb2xkIHNldHRpbmdzCgkJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0ZXh0VmlzaWJsZSA9ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU7CgkJCQl9IGVsc2UgewoJCQkJCXRleHRWaXNpYmxlID0gbG9hZFNldHRpbmdzLnRleHRWaXNpYmxlOwoJCQkJfQoKCQkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJCS8vIGlmIHRoZSB0ZXh0IHdhcyBleHBsaWNpdGx5IHNldCBpbiB0aGUgb2JqZWN0IGFyZ3MKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJCSIgdWktbG9hZGVyLSIgKyAoIHRleHRWaXNpYmxlIHx8IG1zZ1RleHQgfHwgdGhlbWUudGV4dCA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsKCQkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJCS8vICAgICAgdGhpcyBtaWdodCBiZSBvdmVybHkgZGVmZW5zaXZlIGluIHByZXZlbnRpbmcgdW5rbm93aW5nIHhzcwoJCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQkJaWYgKCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICJoMSIgKS50ZXh0KCBtZXNzYWdlICk7CgkJCQl9CgoJCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJCS8vIG9uIHNjcm9sbCBjaGVjayB0aGUgbG9hZGVyIHBvc2l0aW9uCgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzKSApOwoJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggJ3BhZ2Vjb250YWluZXJjcmVhdGUnLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9ICk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEgKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKSB7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlID0gJC5tb2JpbGUgfHwge307CgkJJC5tb2JpbGUuc3VwcG9ydCA9ICQubW9iaWxlLnN1cHBvcnQgfHwge307CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgc3VwcG9ydCApOwoJCSQuZXh0ZW5kKCAkLm1vYmlsZS5zdXBwb3J0LCBzdXBwb3J0ICk7Cgl9KCBqUXVlcnkgKSk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCS8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCgl2YXIgc3VwcG9ydFRvdWNoID0gJC5tb2JpbGUuc3VwcG9ydC50b3VjaCwKCQlzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCQl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCQl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgkJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKCWZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJJC5ldmVudC5oYW5kbGUuY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJCggZG9jdW1lbnQgKS51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLCAgLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJCXN0YXJ0ID0gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9LAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoKCQkJCQlzdG9wID0gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0KCQkJCQl9OwoKCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCgkJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQkJc3RhcnQub3JpZ2luLnRyaWdnZXIoICJzd2lwZSIgKQoJCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgewoJCQlvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdwoJCX0pOwoJfSggalF1ZXJ5ICkpOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCXNwZWNpYWxfZXZlbnQsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9OwoKCS8vIEl0IHNlZW1zIHRoYXQgc29tZSBkZXZpY2UvYnJvd3NlciB2ZW5kb3JzIHVzZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWVzIDAgYW5kIDE4MCB0bwoJLy8gZGVub3RlIHRoZSAiZGVmYXVsdCIgb3JpZW50YXRpb24uIEZvciBpT1MgZGV2aWNlcywgYW5kIG1vc3Qgb3RoZXIgc21hcnQtcGhvbmVzIHRlc3RlZCwKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzIGFsd2F5cyAicG9ydHJhaXQiLCBidXQgaW4gc29tZSBBbmRyb2lkIGFuZCBSSU0gYmFzZWQgdGFibGV0cywKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzICJsYW5kc2NhcGUiLiBUaGUgZm9sbG93aW5nIGNvZGUgYXR0ZW1wdHMgdG8gdXNlIHRoZSB3aW5kb3cKCS8vIGRpbWVuc2lvbnMgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIGlzLCBhbmQgdGhlbiBtYWtlcyBhZGp1c3RtZW50cwoJLy8gdG8gdGhlIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseSBkZWNvZGUgdGhlCgkvLyB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJLy8KCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgb3JpZW50YXRpb24gdGhlIGJyb3dzZXIKCS8vIHRoaW5rcyBpdCBpcyBpbjoKCS8vCgkvLyAgICAgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSAkLm1vYmlsZS5tZWRpYSgiYWxsIGFuZCAob3JpZW50YXRpb246IGxhbmRzY2FwZSkiKTsKCS8vCgkvLyBidXQgdGhlcmUgd2FzIGFuIGlQaG9uZS9pUG9kIFRvdWNoIGJ1ZyBiZWdpbm5pbmcgd2l0aCBpT1MgNC4yLCB1cCB0aHJvdWdoIGlPUyA1LjEsCgkvLyB3aGVyZSB0aGUgYnJvd3NlciAqQUxXQVlTKiBhcHBsaWVkIHRoZSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkuIFRoaXMgYnVnIGRvZXMgbm90CgkvLyBoYXBwZW4gb24gaVBhZC4KCglpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCgkJLy8gQ2hlY2sgdGhlIHdpbmRvdyB3aWR0aCBhbmQgaGVpZ2h0IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbgoJCS8vIG9mIHRoZSBkZXZpY2UgaXMgYXQgdGhpcyBtb21lbnQuIE5vdGUgdGhhdCB3ZSd2ZSBpbml0aWFsaXplZCB0aGUgcG9ydHJhaXQgbWFwCgkJLy8gdmFsdWVzIHRvIDAgYW5kIDE4MCwgKkFORCogd2UgcHVycG9zZWx5IGNoZWNrIGZvciBsYW5kc2NhcGUgc28gdGhhdCBpZiB3ZSBndWVzcwoJCS8vIHdyb25nLCAsIHdlIGRlZmF1bHQgdG8gdGhlIGFzc3VtcHRpb24gdGhhdCBwb3J0cmFpdCBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbi4KCQkvLyBXZSB1c2UgYSB0aHJlc2hvbGQgY2hlY2sgYmVsb3cgYmVjYXVzZSBvbiBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUywgdGhlIGlQaG9uZQoJCS8vIGZvcm0tZmFjdG9yIGNhbiByZXBvcnQgYSBsYXJnZXIgd2lkdGggdGhhbiBoZWlnaHQgaWYgdGhlIHVzZXIgdHVybnMgb24gdGhlCgkJLy8gZGV2ZWxvcGVyIGNvbnNvbGUuIFRoZSBhY3R1YWwgdGhyZXNob2xkIHZhbHVlIGlzIHNvbWV3aGF0IGFyYml0cmFyeSwgd2UganVzdAoJCS8vIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGlzIGxhcmdlIGVub3VnaCB0byBleGNsdWRlIHRoZSBkZXZlbG9wZXIgY29uc29sZSBjYXNlLgoKCQl2YXIgd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkKCB3aW5kb3cgKS53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCAkKCB3aW5kb3cgKS5oZWlnaHQoKSwKCQkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgoJCQloYW5kbGVPYmouaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIE1vZGlmeSBldmVudCBvYmplY3QsIGFkZGluZyB0aGUgLm9yaWVudGF0aW9uIHByb3BlcnR5LgoJCQkJZXZlbnQub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCQkvLyBDYWxsIHRoZSBvcmlnaW5hbGx5LWJvdW5kIGV2ZW50IGhhbmRsZXIgYW5kIHJldHVybiBpdHMgcmVzdWx0LgoJCQkJcmV0dXJuIG9sZF9oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQl9Cgl9KTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCBldmVudF9uYW1lICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKCSQuZm5bIGV2ZW50X25hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIGV2ZW50X25hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCX07CgoJLy8galF1ZXJ5IDwgMS44CglpZiAoICQuYXR0ckZuICkgewoJCSQuYXR0ckZuWyBldmVudF9uYW1lIF0gPSB0cnVlOwoJfQoKfSggalF1ZXJ5LCB0aGlzICkpOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCSRodG1sID0gJCggImh0bWwiICk7CgovKiAkLm1vYmlsZS5tZWRpYSBtZXRob2Q6IHBhc3MgYSBDU1MgbWVkaWEgdHlwZSBvciBxdWVyeSBhbmQgZ2V0IGEgYm9vbCByZXR1cm4KCW5vdGU6IHRoaXMgZmVhdHVyZSByZWxpZXMgb24gYWN0dWFsIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgZm9yIG1lZGlhIHF1ZXJpZXMsIHRob3VnaCB0eXBlcyB3aWxsIHdvcmsgbW9zdCBhbnl3aGVyZQoJZXhhbXBsZXM6CgkJJC5tb2JpbGUubWVkaWEoJ3NjcmVlbicpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZSB3aXRoIHdpbmRvdyB3aWR0aCA+IDQ4MHB4CgkJJC5tb2JpbGUubWVkaWEoJ0BtZWRpYSBzY3JlZW4gYW5kICgtd2Via2l0LW1pbi1kZXZpY2UtcGl4ZWwtcmF0aW86IDIpJykgLy8gdGVzdHMgZm9yIHdlYmtpdCAyeCBwaXhlbCByYXRpbyAoaVBob25lIDQpCiovCiQubW9iaWxlLm1lZGlhID0gKGZ1bmN0aW9uKCkgewoJLy8gVE9ETzogdXNlIHdpbmRvdy5tYXRjaE1lZGlhIG9uY2UgYXQgbGVhc3Qgb25lIFVBIGltcGxlbWVudHMgaXQKCXZhciBjYWNoZSA9IHt9LAoJCXRlc3REaXYgPSAkKCAiPGRpdiBpZD0nanF1ZXJ5LW1lZGlhdGVzdCc+PC9kaXY+IiApLAoJCWZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5hcHBlbmQoIHRlc3REaXYgKTsKCglyZXR1cm4gZnVuY3Rpb24oIHF1ZXJ5ICkgewoJCWlmICggISggcXVlcnkgaW4gY2FjaGUgKSApIHsKCQkJdmFyIHN0eWxlQmxvY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3R5bGUiICksCgkJCQljc3NydWxlID0gIkBtZWRpYSAiICsgcXVlcnkgKyAiIHsgI2pxdWVyeS1tZWRpYXRlc3QgeyBwb3NpdGlvbjphYnNvbHV0ZTsgfSB9IjsKCgkJCS8vbXVzdCBzZXQgdHlwZSBmb3IgSUUhCgkJCXN0eWxlQmxvY2sudHlwZSA9ICJ0ZXh0L2NzcyI7CgoJCQlpZiAoIHN0eWxlQmxvY2suc3R5bGVTaGVldCApIHsKCQkJCXN0eWxlQmxvY2suc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzcnVsZTsKCQkJfSBlbHNlIHsKCQkJCXN0eWxlQmxvY2suYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzc3J1bGUpICk7CgkJCX0KCgkJCSRodG1sLnByZXBlbmQoIGZha2VCb2R5ICkucHJlcGVuZCggc3R5bGVCbG9jayApOwoJCQljYWNoZVsgcXVlcnkgXSA9IHRlc3REaXYuY3NzKCAicG9zaXRpb24iICkgPT09ICJhYnNvbHV0ZSI7CgkJCWZha2VCb2R5LmFkZCggc3R5bGVCbG9jayApLnJlbW92ZSgpOwoJCX0KCQlyZXR1cm4gY2FjaGVbIHF1ZXJ5IF07Cgl9Owp9KSgpOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICkgewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYSA9IHdpbmRvdy5vcGVyYSwKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApOyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXJldHVybiAgIi0iICsgdmVuZC5jaGFyQXQoIDAgKS50b0xvd2VyQ2FzZSgpICsgdmVuZC5zdWJzdHIoIDEgKSArICItIjsKCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyB1YyggcHJvcCApOwoKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgoJCQlpZiAoICEhZGl2LnN0eWxlWyBwcm9wU3R5bGUgXSApIHsKCQkJCXJldCA9IHRydWU7CgkJCX0KCQl9LAoJCWNoZWNrX3ZlbmRzID0gY2hlY2tfdmVuZCA/IFsgY2hlY2tfdmVuZCBdIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gVGhhbmtzIHRvIE1vZGVybml6ciBzcmMgZm9yIHRoaXMgdGVzdCBpZGVhLiBgcGVyc3BlY3RpdmVgIGNoZWNrIGlzIGxpbWl0ZWQgdG8gTW96IHRvIHByZXZlbnQgYSBmYWxzZSBwb3NpdGl2ZSBmb3IgM0QgdHJhbnNmb3JtcyBvbiBBbmRyb2lkLgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgcHJvcCA9ICJ0cmFuc2Zvcm0tM2QiOwoJcmV0dXJuIHZhbGlkU3R5bGUoICdwZXJzcGVjdGl2ZScsICcxMHB4JywgJ21veicgKSB8fCAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgcHJvcCArICIpLCgtIiApICsgIi0iICsgcHJvcCArICIpLCgiICsgcHJvcCArICIpIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICd4JyApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAncG9pbnRlckV2ZW50cycgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgJycgKS5wb2ludGVyRXZlbnRzID09PSAnYXV0byc7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5pZSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fCB2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJyApICYmICFvcGVyYSwKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJiAicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5LAoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCXNjcm9sbFRvcDogKCAicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fCAic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSApICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5pZSAmJiAkLm1vYmlsZS5icm93c2VyLmllID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCS8vIGlmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggc2VsZi5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApCgkJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICk7CgoJfSwKCQoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZSApOwoKCQlpZiAoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApIHsKCQkJcmV0dXJuIFtvcHRpb25zLmtlZXBOYXRpdmUsIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHRdLmpvaW4oICIsICIgKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgICQuYnJvd3Nlci5tc2llICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCkgewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkKCB3aW5kb3cgKS53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQlub25lID0gISQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIW5hbWUgfHwgbmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSwgdG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKSwKCQkJdG9QcmVDbGFzcyA9ICIgdWktcGFnZS1wcmUtaW4iLAoJCQl0b2dnbGVWaWV3cG9ydENsYXNzID0gZnVuY3Rpb24oKSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUgKTsKCQkJfSwKCQkJc2Nyb2xsUGFnZSA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0b1Njcm9sbCApOwoKCQkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQkJfSwgMTUwICk7CgkJCX0sCgkJCWNsZWFuRnJvbSA9IGZ1bmN0aW9uKCkgewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiBpdCdzIG5vdCBzZXF1ZW50aWFsLCBjYWxsIHRoZSBkb25lT3V0IHRyYW5zaXRpb24gdG8gc3RhcnQgdGhlIFRPIHBhZ2UgYW5pbWF0aW5nIGluIHNpbXVsdGFuZW91c2x5CgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCQkvLyBOb3RlOiBzZXR0aW5nIGFuIGV4cGxpY2l0IGhlaWdodCBoZWxwcyBlbGltaW5hdGUgdGlsaW5nIGluIHRoZSB0cmFuc2l0aW9ucwoJCQkJJGZyb20KCQkJCQkuaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpICE9PSB0b1Njcm9sbCApIHsKCQkJCQlzY3JvbGxQYWdlKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgdHJ1ZSApOwoJCQl9OwoKCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCWlmICggJGZyb20gJiYgIW5vbmUgKSB7CgkJCXN0YXJ0T3V0KCk7CgkJfQoJCWVsc2UgewoJCQlkb25lT3V0KCk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKfTsKCi8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQp2YXIgc2VxdWVudGlhbEhhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCksCglzaW11bHRhbmVvdXNIYW5kbGVyID0gY3JlYXRlSGFuZGxlciggZmFsc2UgKSwKCWRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAokLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwp9OwoKLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCiQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoJdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCQkkaHRtbCA9ICQoICdodG1sJyApLAoJCSRoZWFkID0gJCggJ2hlYWQnICksCgoJCS8vdXJsIHBhdGggaGVscGVycyBmb3IgdXNlIGluIHJlbGF0aXZlIHVybCBtYW5hZ2VtZW50CgkJcGF0aCA9IHsKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL14oKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8JZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdXJpID0gdXJsID8gdGhpcy5wYXJzZVVybCggdXJsICkgOiBsb2NhdGlvbiwKCQkJCQloYXNoID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKS5oYXNoOwoKCQkJCS8vIG1pbWljIHRoZSBicm93c2VyIHdpdGggYW4gZW1wdHkgc3RyaW5nIHdoZW4gdGhlIGhhc2ggaXMgZW1wdHkKCQkJCWhhc2ggPSBoYXNoID09PSAiIyIgPyAiIiA6IGhhc2g7CgoJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZyBsb2NhdGlvbi5oYXNoCgkJCQkvLyBpcyBhdXRvZGVjb2RlZCBpbiBmaXJlZm94LCB0aGUgcmVzdCBvZiB0aGUgdXJsIHNob3VsZCBiZSBmcm9tIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcwoJCQkJLy8gd2UncmUgdGVzdGluZykgdG8gYXZvaWQgdGhlIGluY2x1c2lvbiBvZiB0aGUgYXV0aG9yaXR5CgkJCQlyZXR1cm4gdXJpLnByb3RvY29sICsgIi8vIiArIHVyaS5ob3N0ICsgdXJpLnBhdGhuYW1lICsgdXJpLnNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJdmFyIGFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW10sCgkJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCXZhciBkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IGRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaC5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCBkb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQlkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYgKCB1cmxIaXN0b3J5LmdldE5leHQoKSApIHsKCQkJCQl1cmxIaXN0b3J5LmNsZWFyRm9yd2FyZCgpOwoJCQkJfQoKCQkJCXVybEhpc3Rvcnkuc3RhY2sucHVzaCgge3VybCA6IHVybCwgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgdGl0bGU6IHRpdGxlLCBwYWdlVXJsOiBwYWdlVXJsLCByb2xlOiByb2xlIH0gKTsKCgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID0gdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggLSAxOwoJCQl9LAoKCQkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCQl1cmxIaXN0b3J5LnN0YWNrID0gdXJsSGlzdG9yeS5zdGFjay5zbGljZSggMCwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCArIDEgKTsKCQkJfSwKCgkJCWRpcmVjdEhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQkJdmFyIGJhY2sgLCBmb3J3YXJkLCBuZXdBY3RpdmVJbmRleCwgcHJldiA9IHRoaXMuZ2V0QWN0aXZlKCk7CgoJCQkJLy8gY2hlY2sgaWYgdXJsIGlzIGluIGhpc3RvcnkgYW5kIGlmIGl0J3MgYWhlYWQgb3IgYmVoaW5kIGN1cnJlbnQgcGFnZQoJCQkJJC5lYWNoKCB1cmxIaXN0b3J5LnN0YWNrLCBmdW5jdGlvbiggaSwgaGlzdG9yeUVudHJ5ICkgewoKCQkJCQkvL2lmIHRoZSB1cmwgaXMgaW4gdGhlIHN0YWNrLCBpdCdzIGEgZm9yd2FyZCBvciBhIGJhY2sKCQkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCggb3B0cy5jdXJyZW50VXJsICkgPT09IGRlY29kZVVSSUNvbXBvbmVudCggaGlzdG9yeUVudHJ5LnVybCApICkgewoJCQkJCQkvL2RlZmluZSBiYWNrIGFuZCBmb3J3YXJkIGJ5IHdoZXRoZXIgdXJsIGlzIG9sZGVyIG9yIG5ld2VyIHRoYW4gY3VycmVudCBwYWdlCgkJCQkJCWJhY2sgPSBpIDwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleDsKCQkJCQkJZm9yd2FyZCA9ICFiYWNrOwoJCQkJCQluZXdBY3RpdmVJbmRleCA9IGk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgPyBuZXdBY3RpdmVJbmRleCA6IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkJaWYgKCBiYWNrICkgewoJCQkJCSggb3B0cy5laXRoZXIgfHwgb3B0cy5pc0JhY2sgKSggdHJ1ZSApOwoJCQkJfSBlbHNlIGlmICggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgZG9jdW1lbnRVcmwuaHJlZiApICkgOiBkb2N1bWVudFVybCwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSAoIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJaWYgKCBmcm9tUGFnZSApIHsKCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gfHwgImRlZmF1bHQiIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCkgewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50VXJsICkgOiBkb2N1bWVudFVybC5ocmVmOwoJfTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJwYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCQkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCQl9LAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCkgewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCWlmICggYmFzZSApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCAiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIgKS50ZXh0KCkgKTsKCQkJCQl9CgoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYgKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgJC5tb2JpbGUuYWN0aXZlUGFnZTsKCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdG9QYWdlOiB0b1BhZ2UsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkkLm1vYmlsZS5sb2FkUGFnZSggdG9QYWdlLCBzZXR0aW5ncyApCgkJCQkuZG9uZShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBuZXdQYWdlLCBkdXBDYWNoZWRQYWdlICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCQlvcHRpb25zLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgPSBkdXBDYWNoZWRQYWdlOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCgkJCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCQl9KTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQlzZXR0aW5ncy5kYXRhVXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQl9CgoJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJdmFyIGZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UsCgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIHNldHRpbmdzLmRhdGFVcmwgKSApIHx8IHRvUGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZCBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybCwKCQkJZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIHVybCApLAoJCQlhY3RpdmUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCwKCQkJaGlzdG9yeURpciA9IDAsCgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlLAoJCQlpc0RpYWxvZyA9IHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyI7CgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7fSwKCQkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkge30KCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAtMTsgfSwKCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAxOyB9CgkJCX0pOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdib2R5JyApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaCggZSApIHt9CgoJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJdmFyIGFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBoYXNoLgoJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJLy8gYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2ggYW5kCgkJCS8vIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZSBvcmlnaW5hbCBkaWFsb2cKCQkJaWYgKCBhY3RpdmUudXJsLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCX0KCgkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24gb2YgYSBzdGFsZSBkaWFsb2csCgkJCS8vIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICkgKyAoIGFscmVhZHlUaGVyZSA/ICIiIDogZGlhbG9nSGFzaEtleSApOwoKCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgdXJsICkgewoJCQkvL2Rpc2FibGUgaGFzaCBsaXN0ZW5pbmcgdGVtcG9yYXJpbHkKCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHRydWU7CgkJCS8vdXBkYXRlIGhhc2ggYW5kIGhpc3RvcnkKCQkJcGF0aC5zZXQoIHVybCApOwoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkuZ2V0RW5jb2RlZFRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICkgewoJCQkvLyBPdmVyd3JpdGUgdGhlIGN1cnJlbnQgZW50cnkgaWYgaXQncyBhIGxlZnRvdmVyIGZyb20gYSBkaWFsb2cKCQkJaWYgKCBhbHJlYWR5VGhlcmUgKSB7CgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID0gTWF0aC5tYXgoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxICk7CgkJCX0KCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgc2V0dGluZ3MudHJhbnNpdGlvbiwgcGFnZVRpdGxlLCBwYWdlVXJsLCBzZXR0aW5ncy5yb2xlICk7CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQuZG9uZShmdW5jdGlvbigpIHsKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJHRoaXMuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJHRoaXMuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKSApOwoKCQkJaWYgKCAoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCXJldmVyc2U6CSR0aGlzLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKTsKCgkJCS8vIHNwbGl0IGZyb20gdGhlIHByZXZpb3VzIHJldHVybiBsb2dpYyB0byBhdm9pZCBmaW5kIGNsb3Nlc3Qgd2hlcmUgcG9zc2libGUKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICEkKCBsaW5rICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQoIGRvY3VtZW50ICkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIGJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKSwKCgkJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdmFyIHVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKSwKCgkJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoIHBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCggaGFzaCApLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vICJuYXZpZ2F0ZSIgZXZlbnQgZmlyZWQgdG8gYWxsb3cgb3RoZXJzIHRvIHRha2UgYWR2YW50YWdlIG9mIHRoZSBtb3JlIHJvYnVzdCBoYXNoY2hhbmdlIGhhbmRsaW5nCgkJCQluYXZFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQlpZiAoIDAgPT09IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICkgewoJCQkJdXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gdG87CgkJCX0KCgkJCS8vIFdlIHNob3VsZCBwcm9iYWJseSBmaXJlIHRoZSAibmF2aWdhdGUiIGV2ZW50IGZyb20gdGhvc2UgcGxhY2VzIHRoYXQgbWFrZSBjYWxscyB0byBfaGFuZGxlSGFzaENoYW5nZSwKCQkJLy8gYW5kIGhhdmUgX2hhbmRsZUhhc2hDaGFuZ2UgaG9vayBpbnRvIHRoZSAibmF2aWdhdGUiIGV2ZW50IGluc3RlYWQgb2YgdHJpZ2dlcmluZyBpdCBoZXJlCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudHJpZ2dlciggbmF2RXZlbnQgKTsKCQkJaWYgKCBuYXZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQgKGVpdGhlciBnbG9iYWxseSBvciB0ZW1wb3JhcmlseSksIG9yIGl0J3MgYSBkaWFsb2cgaGFzaAoJCQlpZiAoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYgKCB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA+IDEgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgkJCQkJCWlzQmFjazogZnVuY3Rpb24oKSB7ICQubW9iaWxlLmJhY2soKTsgfSwKCQkJCQkJaXNGb3J3YXJkOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOyB9CgkJCQkJfSk7CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSgpCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoKCQkJCQkJLy8gcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBoaXN0b3J5IGNoYW5nZQoJCQkJCQkvLyBkbyB0aGUgZm9sbG93aW5nCgkJCQkJCWVpdGhlcjogZnVuY3Rpb24oIGlzQmFjayApIHsKCQkJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkJCXRvID0gYWN0aXZlLnBhZ2VVcmw7CgoJCQkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEgcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50CgkJCQkvLyBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZCB1cCBpbiB0aGUgaW5pdGlhbCB1cmxIaXN0b3J5IGVudHJ5CgkJCQlpZiAoIHRvID09PSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdXJsSGlzdG9yeS5pbml0aWFsRHN0LCBkb2N1bWVudEJhc2UgKSAmJgoJCQkJCXVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICYmIHVybEhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9ICQubW9iaWxlLmZpcnN0UGFnZTsKCQkJCX0KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCS8vIEZpcmVmb3ggYXV0by1lc2NhcGVzIHRoZSBsb2NhdGlvbi5oYXNoIGFzIGZvciB2MTMgYnV0CgkJCS8vIGxlYXZlcyB0aGUgaHJlZiB1bnRvdWNoZWQKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9KTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCksCgkJbW9iaWxlaW5pdERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJJCggZG9jdW1lbnQgKS5yZWFkeSggJC5wcm94eSggZG9tcmVhZHlEZWZlcnJlZCwgInJlc29sdmUiICkgKTsKCgkkKCBkb2N1bWVudCApLm9uZSggIm1vYmlsZWluaXQiLCAkLnByb3h5KCBtb2JpbGVpbml0RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaGFzaENoYW5nZVRpbWVvdXQ6IDIwMCwKCgkJaGFzaENoYW5nZUVuYWJsZVRpbWVyOiB1bmRlZmluZWQsCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoOiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYgKCBkaWFsb2dJbmRleCA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNsaWNlKCAwLCBkaWFsb2dJbmRleCApICsgIiMiICsgdXJsLnNsaWNlKCBkaWFsb2dJbmRleCApOwoJCQl9IGVsc2UgaWYgKCB1cmwuaW5kZXhPZiggc3Via2V5ICkgPiAtMSApIHsKCQkJCXVybCA9IHVybC5zcGxpdCggc3Via2V5ICkuam9pbiggIiMiICsgc3Via2V5ICk7CgkJCX0KCgkJCXJldHVybiB1cmw7CgkJfSwKCgkJLy8gVE9ETyBzb3J0IG91dCBhIHNpbmdsZSBiYXJyaWVyIHRvIGhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eQoJCW5leHRIYXNoQ2hhbmdlUHJldmVudGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCSQubW9iaWxlLnVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB2YWx1ZTsKCQkJc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCA9IHZhbHVlOwoJCX0sCgoJCS8vIG9uIGhhc2ggY2hhbmdlIHdlIHdhbnQgdG8gY2xlYW4gdXAgdGhlIHVybAoJCS8vIE5PVEUgdGhpcyB0YWtlcyBwbGFjZSAqYWZ0ZXIqIHRoZSB2YW5pbGxhIG5hdmlnYXRpb24gaGFzaCBjaGFuZ2UKCQkvLyBoYW5kbGluZyBoYXMgdGFrZW4gcGxhY2UgYW5kIHNldCB0aGUgc3RhdGUgb2YgdGhlIERPTQoJCW9uSGFzaENoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCS8vIGRpc2FibGUgdGhpcyBoYXNoIGNoYW5nZQoJCQlpZiAoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBocmVmLCBzdGF0ZSwKCQkJCS8vIGZpcmVmb3ggYXV0byBkZWNvZGVzIHRoZSB1cmwgd2hlbiB1c2luZyBsb2NhdGlvbi5oYXNoIGJ1dCBub3QgaHJlZgoJCQkJaGFzaCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gsCgkJCQlpc1BhdGggPSAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApLAoJCQkJcmVzb2x1dGlvblVybCA9IGlzUGF0aCA/ICQubW9iaWxlLnBhdGguZ2V0TG9jYXRpb24oKSA6ICQubW9iaWxlLmdldERvY3VtZW50VXJsKCk7CgoJCQloYXNoID0gaXNQYXRoID8gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiBoYXNoOwoKCgkJCS8vIHByb3B1bGF0ZSB0aGUgaGFzaCB3aGVuIGl0cyBub3QgYXZhaWxhYmxlCgkJCXN0YXRlID0gc2VsZi5zdGF0ZSgpOwoKCQkJLy8gbWFrZSB0aGUgaGFzaCBhYm9sdXRlIHdpdGggdGhlIGN1cnJlbnQgaHJlZgoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhhc2gsIHJlc29sdXRpb25VcmwgKTsKCgkJCWlmICggaXNQYXRoICkgewoJCQkJaHJlZiA9IHNlbGYucmVzZXRVSUtleXMoIGhyZWYgKTsKCQkJfQoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoJCX0sCgoJCS8vIG9uIHBvcHN0YXRlIChpZSBiYWNrIG9yIGZvcndhcmQpIHdlIG5lZWQgdG8gcmVwbGFjZSB0aGUgaGFzaCB0aGF0IHdhcyB0aGVyZSBwcmV2aW91c2x5CgkJLy8gY2xlYW5lZCB1cCBieSB0aGUgYWRkaXRpb25hbCBoYXNoIGhhbmRsaW5nCgkJb25Qb3BTdGF0ZTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBwb3BwZWRTdGF0ZSA9IGUub3JpZ2luYWxFdmVudC5zdGF0ZSwKCQkJCWZyb21IYXNoLCB0b0hhc2gsIGhhc2hDaGFuZ2VkOwoKCQkJLy8gaWYgdGhlcmUncyBubyBzdGF0ZSBpdHMgbm90IGEgcG9wc3RhdGUgd2UgY2FyZSBhYm91dCwgZWcgY2hyb21lJ3MgaW5pdGlhbCBwb3BzdGF0ZQoJCQlpZiAoIHBvcHBlZFN0YXRlICkgewoJCQkJLy8gaWYgd2UgZ2V0IHR3byBwb3Agc3RhdGVzIGluIHVuZGVyIHRoaXMuaGFzaENoYW5nZVRpbWVvdXQKCQkJCS8vIG1ha2Ugc3VyZSB0byBjbGVhciBhbnkgdGltZXIgc2V0IGZvciB0aGUgcHJldmlvdXMgY2hhbmdlCgkJCQljbGVhclRpbWVvdXQoIHNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyICk7CgoJCQkJLy8gbWFrZSBzdXJlIHRvIGVuYWJsZSBoYXNoIGhhbmRsaW5nIGZvciB0aGUgdGhlIF9oYW5kbGVIYXNoQ2hhbmdlIGNhbGwKCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgoJCQkJLy8gY2hhbmdlIHRoZSBwYWdlIGJhc2VkIG9uIHRoZSBoYXNoIGluIHRoZSBwb3BwZWQgc3RhdGUKCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgoJCQkJLy8gcHJldmVudCBhbnkgaGFzaGNoYW5nZSBpbiB0aGUgbmV4dCBzZWxmLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCB0cnVlICk7CgoJCQkJLy8gcmUtZW5hYmxlIGhhc2ggY2hhbmdlIGhhbmRsaW5nIGFmdGVyIHN3YWxsb3dpbmcgYSBwb3NzaWJsZSBoYXNoCgkJCQkvLyBjaGFuZ2UgZXZlbnQgdGhhdCBjb21lcyBvbiBhbGwgcG9wc3RhdGVzIGNvdXJ0ZXN5IG9mIGJyb3dzZXJzIGxpa2UgQW5kcm9pZAoJCQkJc2VsZi5oYXNoQ2hhbmdlRW5hYmxlVGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoJCQkJfSwgc2VsZi5oYXNoQ2hhbmdlVGltZW91dCApOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBXZSBuZWVkIHRvIGluaXQgd2hlbiAibW9iaWxlaW5pdCIsICJkb21yZWFkeSIsIGFuZCAibmF2cmVhZHkiIGhhdmUgYWxsIGhhcHBlbmVkCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsIG1vYmlsZWluaXREZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKSB7CgkJCXB1c2hTdGF0ZUhhbmRsZXIuaW5pdCgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKCgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJaGVhZGVyQ2xvc2VCdXR0b24gPSAkKCAiPGEgaHJlZj0nIycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nZGVsZXRlJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zPSdub3RleHQnPiIrIHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgKyAiPC9hPiIgKSwKCQkJZGlhbG9nV3JhcCA9ICQoICI8ZGl2Lz4iLCB7CgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1jb3JuZXItYWxsIHVpLW92ZXJsYXktc2hhZG93IgoJCQkJfSk7CgoJCSRlbC5hZGRDbGFzcyggInVpLWRpYWxvZyB1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbAoJCQkud3JhcElubmVyKCBkaWFsb2dXcmFwICkKCQkJLmNoaWxkcmVuKCkKCQkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkJLmVuZCgpCgkJCQkuY2hpbGRyZW4oICc6Zmlyc3QtY2hpbGQnKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAiOmxhc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCS8vCgkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQloZWFkZXJDbG9zZUJ1dHRvbi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCQl1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCQkJLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIiBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CgkJKi8KCQkkZWwuYmluZCggInZjbGljayBzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKSwKCQkJCWFjdGl2ZTsKCgkJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgoJCQkJYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fTsKCgkJCQkkdGFyZ2V0LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiwgKCBhY3RpdmUudHJhbnNpdGlvbiB8fCAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiApICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIsICJyZXZlcnNlIiApOwoJCQl9CgkJfSkKCQkuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICkgewoJCQkkKCB0aGlzICkuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5ub3QoICIudWktc2xpZGVyLWJnIiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pCgkJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQkJaWYgKCBzZWxmLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkc3Q7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlkc3QgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldFByZXYoKS51cmw7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCi8vIE5PVEUgYmluZCB1c2VkIHRvIGZvcmNlIHRoaXMgYmluZGluZyB0byBydW4gYmVmb3JlIHRoZSBidXR0b25NYXJrdXAgYmluZGluZwovLyAgICAgIHdoaWNoIGV4cGVjdHMgLnVpLWZvb3RlciB0b3AgYmUgYXBwbGllZCBpbiBpdHMgZ2lnYW50aWMgc2VsZWN0b3IKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gZmlsdGVyIGZ1bmN0aW9uIHJlbW92ZXMgd2hpdGVzcGFjZSBiZXR3ZWVuIGxhYmVsIGFuZCBmb3JtIGVsZW1lbnQgc28gd2UgY2FuIHVzZSBpbmxpbmUtYmxvY2sgKG5vZGVUeXBlIDMgPSB0ZXh0KQokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMKCQkuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICkKCQkuY29udGVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gKCB0aGlzLm5vZGVUeXBlID09PSAzICYmICEvXFMvLnRlc3QoIHRoaXMubm9kZVZhbHVlICkgKTsKCQl9KS5yZW1vdmUoKTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7CgkKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzLAoJCW1hcFRvRGF0YUF0dHIgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJZS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGtleSwgdmFsdWUgKTsKCQkJZWwuanFtRGF0YSgga2V5LCB2YWx1ZSApOwoJCX07CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaCggbywgbWFwVG9EYXRhQXR0ciApOwoKCQlpZiAoIGVsLmpxbURhdGEoICJyZWwiICkgPT09ICJwb3B1cCIgJiYgZWwuYXR0ciggImhyZWYiICkgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBlLmdldEF0dHJpYnV0ZSggImhyZWYiICkgKTsKCQl9CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICggKCBlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIiApID8gZS5wYXJlbnROb2RlIDogZSApLCAiYnV0dG9uRWxlbWVudHMiICk7CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUgPSBidXR0b25FbGVtZW50cy5vdXRlcjsKCQkJZWwgPSAkKCBlICk7CgkJCWJ1dHRvbklubmVyID0gYnV0dG9uRWxlbWVudHMuaW5uZXI7CgkJCWJ1dHRvblRleHQgPSBidXR0b25FbGVtZW50cy50ZXh0OwoJCQkvLyBXZSB3aWxsIHJlY3JlYXRlIHRoaXMgaWNvbiBiZWxvdwoJCQkkKCBidXR0b25FbGVtZW50cy5pY29uICkucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi11cC0iICsgby50aGVtZTsKCQlidXR0b25DbGFzcyArPSBvLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBtaW5pYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5taW5pID09PSB0cnVlID8gIiB1aS1taW5pIiA6ICIgdWktZnVsbHNpemUiOwoJCX0KCgkJaWYgKCBvLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgaW5saW5lYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5pbmxpbmUgPT09IHRydWUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiB1aS1idG4tYmxvY2siOwoJCX0KCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaW5uZXJDbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8uaWNvbnBvcyAmJiBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7Cgl2YXIgaG92ZXJEZWxheSA9ICQubW9iaWxlLmJ1dHRvbk1hcmt1cC5ob3ZlckRlbGF5LCBob3YsIGZvYzsKCgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biB2bW91c2VjYW5jZWwgdm1vdXNldXAgdm1vdXNlb3ZlciB2bW91c2VvdXQgZm9jdXMgYmx1ciBzY3JvbGxzdGFydCI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHRoZW1lLAoJCQkJJGJ0biA9ICQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLAoJCQkJaXNUb3VjaEV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCAmJiAvXnRvdWNoLy50ZXN0KCBldmVudC5vcmlnaW5hbEV2ZW50LnR5cGUgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGV2dCA9PT0gInZtb3VzZWRvd24iICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJaG92ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb24sCgkJCWV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbiwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJCWNvbGxhcHNpYmxlU2V0ID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKTsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0CgkJCWlmICggIW8uY29sbGFwc2VkSWNvbiApIHsKCQkJCW8uY29sbGFwc2VkSWNvbiA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKTsKCQkJfQoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGV4cGFuZGVkIGljb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmV4cGFuZGVkSWNvbiApIHsKCQkJCW8uZXhwYW5kZWRJY29uID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImV4cGFuZGVkLWljb24iICk7CgkJCX0KCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5pY29uUG9zICkgewoJCQkJby5pY29uUG9zID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgcHJlZmVyZW5jZSBmb3IgaW5zZXQgZnJvbSBjb2xsYXBzaWJsZS1zZXQgb3Igc2V0IHRoZSBkZWZhdWx0IHZhbHVlIHRvIGVuc3VyZSBlcXVhbHR5IHdpdGhpbiBhIHNldAoJCQlpZiAoIGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJby5pbnNldCA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKTsKCQkJfSBlbHNlIHsKCQkJCW8uaW5zZXQgPSB0cnVlOwoJCQl9CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgZm9yIG1pbmkgaW4gdGhlIHNldAoJCQlpZiAoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGdldCBpbmhlcml0ZWQgdGhlbWUgaWYgbm90IGEgc2V0IGFuZCBubyB0aGVtZSBoYXMgYmVlbiBzZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQkJfQoJCX0KCQkKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGUuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1pbnNldCIgKTsKCQl9CgkJCgkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAoIG8uY29udGVudFRoZW1lICkgPyAoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApIDogIiIpOwoKCQljb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb24gfHwgInBsdXMiOwoJCWV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbiB8fCAibWludXMiOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25Qb3MgfHwgImxlZnQiLAoJCQkJCWljb246IGNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJaWYgKCAhIW8uaW5zZXQgKSB7CQkJCQoJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggIi51aS1idG4taW5uZXIiLCAkZWwgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQl9CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBleHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgY29sbGFwc2VkSWNvbiwgKCBpc0NvbGxhcHNlIHx8IGV4cGFuZGVkSWNvbiA9PT0gY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWlmICggY29udGVudFRoZW1lICYmICEhby5pbnNldCAmJiAoICFjb2xsYXBzaWJsZVNldC5sZW5ndGggfHwgY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgKSApIHsKCQkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5hZGQoIGNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApOwoJCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgIWlzQ29sbGFwc2UgKTsKCQkJCQl9CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJCQl9CgkJCX0pCgkJCS50cmlnZ2VyKCBvLmNvbGxhcHNlZCA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLmJpbmQoICJ0YXAiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQljb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggImEiICkuZmlyc3QoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQl2YXIgdHlwZSA9IGNvbGxhcHNpYmxlSGVhZGluZy5pcyggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSA/ICJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgoJCWlmICggJGVsLmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQlvLmluc2V0ID0gJGVsLmpxbURhdGEoICJpbnNldCIgKTsKCQl9CgkJby5pbnNldCA9IG8uaW5zZXQgIT09IHVuZGVmaW5lZCA/IG8uaW5zZXQgOiB0cnVlOwoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKSwKCQkJCQkJd2lkZ2V0ID0gY29sbGFwc2libGUuZGF0YSggImNvbGxhcHNpYmxlIiApOwoJCQkJCWlmICggY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgJiYgISFvLmluc2V0ICkgewoJCQkJCQljb2xsYXBzaWJsZS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkuZmlyc3QoKQoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKQoJCQkJCQkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQkJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkJLnRyaWdnZXIoICJjb2xsYXBzZSIgKTsKCQkJCQl9CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb2xsYXBzaWJsZXNJblNldCA9ICRlbC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICksCgkJCWV4cGFuZGVkID0gY29sbGFwc2libGVzSW5TZXQuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApOwoJCXRoaXMucmVmcmVzaCgpOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJZXhwYW5kZWQudHJpZ2dlciggImV4cGFuZCIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCS8vIGNsZWFuIHVwIGJvcmRlcnMKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVzSW5TZXQuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5qcW1SZW1vdmVEYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKQoJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQkJfSk7CgoJCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCQkuZmluZCggImEiICkKCQkJCQkuZmlyc3QoKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCQoJCQljb2xsYXBzaWJsZXNJblNldC5sYXN0KCkKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApCgkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGVzZXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IHVpLWNvcm5lci1hbGwgdWktc2hhZG93ICIgOiAiIjsKCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQkkbGkgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJsaSIgKTsKCQkvLyBBdCBjcmVhdGUgdGltZSBhbmQgd2hlbiBhdXRvZGl2aWRlcnMgY2FsbHMgcmVmcmVzaCB0aGUgbGkgYXJlIG5vdCB2aXNpYmxlIHlldCBzbyB3ZSBuZWVkIHRvIHJlbHkgb24gLnVpLXNjcmVlbi1oaWRkZW4KCQkkdmlzaWJsZWxpID0gY3JlYXRlIHx8ICRsaS5maWx0ZXIoICI6dmlzaWJsZSIgKS5sZW5ndGggPT09IDAgPyAkbGkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICkgOiAkbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCS8vIHVpLWxpLWxhc3QgaXMgdXNlZCBmb3Igc2V0dGluZyBib3JkZXItYm90dG9tIG9uIHRoZSBsYXN0IGxpCQkKCQkkbGkuZmlsdGVyKCAiLnVpLWxpLWxhc3QiICkucmVtb3ZlQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCQkJCQoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLWxpbmstYWx0LCAudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10ciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20gdWktbGktbGFzdCIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ibCIgKTsKCQl9IGVsc2UgewoJCQkkdmlzaWJsZWxpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxpLWxhc3QiICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCWpzQ291bnQgPSAhJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQsCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBvbCAmJiBqc0NvdW50ICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggb2wgKSB7CQoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlRmxvYXQoIHN0YXJ0ICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQkKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktbGktbGluay1hbHQiICkKCQkJCQkJCS5lbXB0eSgpCgkJCQkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQkJCXRoZW1lOiBpdGVtVGhlbWUsCgkJCQkJCQkJaWNvbjogZmFsc2UsCgkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIKCQkJCQkJCX0pCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCQkuYXBwZW5kKAoJCQkJCQkJCQkkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCQkJCQkJdGhlbWU6IHNwbGl0dGhlbWUsCgkJCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQkJCQkJCS8vIGxpbmsgaWNvbiBvdmVycmlkZXMgbGlzdCBpdGVtIGljb24gb3ZlcnJpZGVzIHVsIGVsZW1lbnQgb3ZlcnJpZGVzIG9wdGlvbnMKCQkJCQkJCQkJCWljb246IGxpbmtJY29uIHx8IGljb24gfHwgbGlzdHNwbGl0aWNvbiB8fCBvLnNwbGl0SWNvbgoJCQkJCQkJCQl9KQoJCQkJCQkJCSk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJhci0iICsgZGl2aWRlcnRoZW1lOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsJCgkJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCQkJCW5ld1N0YXJ0Q291bnQgPSBwYXJzZUZsb2F0KCBzdGFydCApIC0gMTsKCQkJCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQkJCQljb3VudGVyID0gMTsKCQkJCQkJfQkKCQkJCQl9CgkJCQkKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCiAgICAvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiAoIHVpLm5leHRQYWdlICkgewoJCQkJCW5wVVJMID0gbmV4dFBhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCQlpZiAoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApIHsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UudHJpZ2dlciggcHJFdmVudCApOwoJCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50VXJsID0gdGhpcy5wYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCXJldHVybiAkKCAiOmpxbURhdGEodXJsXj0nIisgIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiJykiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVycyA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSBlbHQudGV4dCgpIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfTsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHJlcGxhY2VEaXZpZGVycyA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQl2YXIgbGlzID0gbGlzdC5maW5kKCAnbGknICksCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsIGxpLCBkaXZpZGVyVGV4dDsKCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbaV07CgkJCWRpdmlkZXJUZXh0ID0gbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdkYXRhLScgKyAkLm1vYmlsZS5ucyArICdyb2xlJywgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9OwoKCXZhciBhZnRlckxpc3R2aWV3UmVmcmVzaCA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LnVuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCQlyZXBsYWNlRGl2aWRlcnMoKTsKCQlsaXN0dmlldy5yZWZyZXNoKCk7CgkJbGlzdC5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJfTsKCglhZnRlckxpc3R2aWV3UmVmcmVzaCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCIgKS5qcW1EYXRhKCBkYXRhQXR0ciApOwoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJbWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbiA9IGlucHV0LnBhcmVudHMoICI6anFtRGF0YSh0eXBlPSdob3Jpem9udGFsJykiICkubGVuZ3RoID8gdW5kZWZpbmVkIDogdW5jaGVja2VkU3RhdGUsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQlhY3RpdmVCdG4gPSBpY29uID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUgKyBhY3RpdmVCdG4sCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZSwKCQkJY2hlY2tlZGljb24gPSAidWktaWNvbi0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uID0gInVpLWljb24tIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkaWNvbiwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkaWNvbgoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJfSwKCgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbMF0sCgkJCWxhYmVsID0gdGhpcy5sYWJlbCwKCQkJaWNvbiA9IGxhYmVsLmZpbmQoICIudWktaWNvbiIgKTsKCgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5hZGRDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24ucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfQoKCQlpZiAoIGlucHV0LmRpc2FibGVkICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHRydWUgKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApLnBhcmVudCgpLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJJGJ1dHRvbiwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJaW5saW5lID0gby5pbmxpbmUgfHwgJGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvLm1pbmkgfHwgJGVsLmpxbURhdGEoICJtaW5pIiApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoICAkZWwuYXR0ciggInR5cGUiICkgPT09ICJzdWJtaXQiIHx8ICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInJlc2V0IiApIHsKCQkJY2xhc3NlcyA/IGNsYXNzZXMgKz0gIiB1aS1zdWJtaXQiIDogIGNsYXNzZXMgPSAidWktc3VibWl0IjsKCQl9CgkJJCggImxhYmVsW2Zvcj0nIiArICRlbC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1zdWJtaXQiICk7CgoJCS8vIEFkZCBBUklBIHJvbGUKCQl0aGlzLmJ1dHRvbiA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQlbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKQoJCQkuaW5zZXJ0QmVmb3JlKCAkZWwgKQoJCQkuYnV0dG9uTWFya3VwKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJaWNvbjogby5pY29uLAoJCQkJaWNvbnBvczogby5pY29ucG9zLAoJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93LAoJCQkJbWluaTogbWluaQoJCQl9KQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCQl0eXBlID0gJGVsLmF0dHIoICJ0eXBlIiApOwoJCW5hbWUgPSAkZWwuYXR0ciggIm5hbWUiICk7CgoJCS8vIEFkZCBoaWRkZW4gaW5wdXQgZHVyaW5nIHN1Ym1pdCBpZiBpbnB1dCB0eXBlPSJzdWJtaXQiIGhhcyBhIG5hbWUuCgkJaWYgKCB0eXBlICE9PSAiYnV0dG9uIiAmJiB0eXBlICE9PSAicmVzZXQiICYmIG5hbWUgKSB7CgkJCQkkZWwuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJCS8vIEFkZCBoaWRkZW4gaW5wdXQgaWYgaXQgZG9lc24ndCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmICggJGJ1dHRvblBsYWNlaG9sZGVyID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9ICQoICI8aW5wdXQ+IiwgewoJCQkJCQkJdHlwZTogImhpZGRlbiIsCgkJCQkJCQluYW1lOiAkZWwuYXR0ciggIm5hbWUiICksCgkJCQkJCQl2YWx1ZTogJGVsLmF0dHIoICJ2YWx1ZSIgKQoJCQkJCQl9KS5pbnNlcnRCZWZvcmUoICRlbCApOwoKCQkJCQkJLy8gQmluZCB0byBkb2MgdG8gcmVtb3ZlIGFmdGVyIHN1Ym1pdCBoYW5kbGluZwoJCQkJCQkkKCBkb2N1bWVudCApLm9uZSggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoICRlbC5wcm9wKCJkaXNhYmxlZCIpICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCgkJLy8gR3JhYiB0aGUgYnV0dG9uJ3MgdGV4dCBlbGVtZW50IGZyb20gaXRzIGltcGxlbWVudGF0aW9uLWluZGVwZW5kZW50IGRhdGEgaXRlbQoJCSQoIHRoaXMuYnV0dG9uLmRhdGEoICdidXR0b25FbGVtZW50cycgKS50ZXh0IClbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uY29udHJvbGdyb3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglmdW5jdGlvbiBmbGlwQ2xhc3NlcyggZWxzLCBmbENvcm5lcnMgICkgewoJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS1jb3JuZXItbGVmdCB1aS1jb3JuZXItcmlnaHQgdWktY29udHJvbGdyb3VwLWxhc3QgdWktc2hhZG93IiApCgkJCS5lcSggMCApLmFkZENsYXNzKCBmbENvcm5lcnNbIDAgXSApCgkJCS5lbmQoKQoJCQkubGFzdCgpLmFkZENsYXNzKCBmbENvcm5lcnNbIDEgXSApLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLWxhc3QiICk7Cgl9CgoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJCQlkaXJlY3Rpb246ICRlbC5qcW1EYXRhKCAidHlwZSIgKSB8fCAidmVydGljYWwiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQkJCQltaW5pOiAkZWwuanFtRGF0YSggIm1pbmkiICkKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwbGVnZW5kID0gJGVsLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQlncm91cGhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWxhYmVsIiApLAoJCQlncm91cGNvbnRyb2xzID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT09ICJob3Jpem9udGFsIiA/IFsgInVpLWNvcm5lci1sZWZ0IiwgInVpLWNvcm5lci1yaWdodCIgXSA6IFsgInVpLWNvcm5lci10b3AiLCAidWktY29ybmVyLWJvdHRvbSIgXSwKCQkJdHlwZSA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKS5hdHRyKCAidHlwZSIgKTsKCgkJLy8gRmlyc3QgdW53cmFwIHRoZSBjb250cm9scyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJaWYgKCBncm91cGNvbnRyb2xzLmxlbmd0aCApIHsKCQkJZ3JvdXBjb250cm9scy5jb250ZW50cygpLnVud3JhcCgpOwoJCX0KCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgoJCWlmICggZ3JvdXBsZWdlbmQubGVuZ3RoICkgewoJCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGxlZ2VuZC5odG1sKCkgKyAiPC9kaXY+IiApLmluc2VydEJlZm9yZSggJGVsLmNoaWxkcmVuKCAwICkgKTsKCQkJZ3JvdXBsZWdlbmQucmVtb3ZlKCk7CgkJfSBlbHNlIGlmICggZ3JvdXBoZWFkaW5nLmxlbmd0aCApIHsKCQkJLy8gSnVzdCBtb3ZlIHRoZSBoZWFkaW5nIGlmIHRoZSBjb250cm9sZ3JvdXAgd2FzIGFscmVhZHkgZW5oYW5jZWQKCQkJJGVsLnByZXBlbmQoIGdyb3VwaGVhZGluZyApOwoJCX0KCgkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyBvLmRpcmVjdGlvbiApOwoKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuIiArICggby5leGNsdWRlSW52aXNpYmxlID8gIjp2aXNpYmxlIiA6ICIiICkgKS5ub3QoICcudWktc2xpZGVyLWhhbmRsZScgKSwgZmxDb3JuZXJzICk7CgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSwgZmxDb3JuZXJzICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9CgoJCWlmICggby5taW5pICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1taW5pIiApOwoJCX0KCgl9KTsKfTsKCi8vIFRoZSBwYWdlY3JlYXRlIGhhbmRsZXIgZm9yIGNvbnRyb2xncm91cCBpcyBpbiBqcXVlcnkubW9iaWxlLmluaXQgYmVjYXVzZSBvZiB0aGUgc29mdC1kZXBlbmRlbmN5IG9uIHRoZSB3cmFwcGVkIHdpZGdldHMKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpblNpemUsIHNlZ1NpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCQl2YXIgcmV0ID0gZGVzaXJlZDsKCgkJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJCXJldCA9IG9mZnNldCArICggd2luU2l6ZSAtIHNlZ1NpemUgKSAvIDI7CgkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCQlyZXQgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ1NpemUgLyAyICksIG9mZnNldCArIHdpblNpemUgLSBzZWdTaXplICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApOwoKCQlyZXR1cm4gewoJCQl4OiAkd2luLnNjcm9sbExlZnQoKSwKCQkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQkJY3g6ICggd2luZG93LmlubmVyV2lkdGggfHwgJHdpbi53aWR0aCgpICksCgkJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkd2luLmhlaWdodCgpICkKCQl9OwoJfQoKCSQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCQlzaGFkb3c6IHRydWUsCgkJCWNvcm5lcnM6IHRydWUsCgkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJCXRvbGVyYW5jZTogbnVsbCwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIsCgkJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCgkJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJCS8vCgkJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIuaWUKCQl9LAoKCQlfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCWlmICggcG9wdXBIZWlnaHQgPiB0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCkgKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCBlICk7CgkJCX0KCQl9LAoKCQlfbWF5YmVSZWZyZXNoVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXZhciB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCQl3aW5Db29yZHMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueSAmJgoJCQkJCXdpbkNvb3Jkcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3ggJiYKCQkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQkJd2luQ29vcmRzOiB3aW5Db29yZHMKCQkJfTsKCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5fbWF5YmVSZWZyZXNoVGltZW91dCgpICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiApOwoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAid2luZG93IiApICkgKTsKCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl9tYXliZVJlZnJlc2hUaW1lb3V0KCk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoKCQkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCQl9CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciB1aSA9IHsKCQkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1zZWxlY3RtZW51LWhpZGRlbic+PC9kaXY+IiApCgkJCQl9LAoJCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQkJbXlJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQkJdGhpcy5vcHRpb25zLmhpc3RvcnkgPSB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJdGhpc1BhZ2UgPSAkKCAiYm9keSIgKTsKCQkJfQoKCQkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkJLy8gVE9ETyB0aGlzIHdvdWxkIGJlIG5pY2UgYXQgdGhlIHRoZSBtb2JpbGUgd2lkZ2V0IGxldmVsCgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIgPSB0aGlzLm9wdGlvbnMuY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJdGhpc1BhZ2UuYXBwZW5kKCB1aS5zY3JlZW4gKTsKCQkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGlzLmVsZW1lbnQgKTsKCQkJaWYgKCBteUlkICkgewoJCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCQl9CgkJCXVpLmNvbnRhaW5lci5hcHBlbmQoIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gQWRkIGNsYXNzIHRvIHBvcHVwIGVsZW1lbnQKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCQlfdWk6IHVpLAoJCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQkJX3ByZXJlcXM6IG51bGwsCgkJCQlfaXNPcGVuOiBmYWxzZSwKCQkJCV90b2xlcmFuY2U6IG51bGwsCgkJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlLAoJCQkJX2dsb2JhbEhhbmRsZXJzOiBbCgkJCQkJewoJCQkJCQlzcmM6ICQoIHdpbmRvdyApLAoJCQkJCQloYW5kbGVyOiB7CgkJCQkJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJCQkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCQkJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCQkJCQl9CgkJCQkJfQoJCQkJXQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgoJCQl1aS5zY3JlZW4uYmluZCggInZjbGljayIsICQucHJveHkoIHRoaXMsICJfZWF0RXZlbnRBbmRDbG9zZSIgKSApOwoKCQkJJC5lYWNoKCB0aGlzLl9nbG9iYWxIYW5kbGVycywgZnVuY3Rpb24oIGlkeCwgdmFsdWUgKSB7CgkJCQl2YWx1ZS5zcmMuYmluZCggdmFsdWUuaGFuZGxlciApOwoJCQl9KTsKCQl9LAoKCQlfYXBwbHlUaGVtZTogZnVuY3Rpb24oIGRzdCwgdGhlbWUsIHByZWZpeCApIHsKCQkJdmFyIGNsYXNzZXMgPSAoIGRzdC5hdHRyKCAiY2xhc3MiICkgfHwgIiIpLnNwbGl0KCAiICIgKSwKCQkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCQljdXJyZW50VGhlbWUgPSBudWxsLAoJCQkJbWF0Y2hlcywKCQkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQkJd2hpbGUgKCBjbGFzc2VzLmxlbmd0aCA+IDAgKSB7CgkJCQljdXJyZW50VGhlbWUgPSBjbGFzc2VzLnBvcCgpOwoJCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCBtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMSApIHsKCQkJCQljdXJyZW50VGhlbWUgPSBtYXRjaGVzWyAxIF07CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICggdGhlbWUgIT09IGN1cnJlbnRUaGVtZSApIHsKCQkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggISAoIHRoZW1lID09PSBudWxsIHx8IHRoZW1lID09PSAibm9uZSIgKSApIHsKCQkJCQlkc3QuYWRkQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgdGhlbWVTdHIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLmVsZW1lbnQsIHZhbHVlLCAiYm9keSIgKTsKCQl9LAoKCQlfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuX3VpLnNjcmVlbiwgdmFsdWUsICJvdmVybGF5IiApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAmJiB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfSwKCgkJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCX0KCQl9LAoKCQlfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCQlpZiAoIHZhbHVlICkgewoJCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJCWNhc2UgMToKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCQljYXNlIDI6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJCWNhc2UgNDoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJZGVmYXVsdDoKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIGV4Y2x1c2lvbnMsIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJLy8gVE9ETyBSRU1PVkUgRk9SIDEuMi4xIGJ5IG1vdmluZyB0aGVtIG91dCB0byBhIGRlZmF1bHQgb3B0aW9ucyBvYmplY3QKCQkJZXhjbHVzaW9ucyA9IFsKCQkJCSJpbml0U2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua1NlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtFdmVudHMiLAoJCQkJIm5hdmlnYXRlRXZlbnRzIiwKCQkJCSJjbG9zZUV2ZW50cyIsCgkJCQkiaGlzdG9yeSIsCgkJCQkiY29udGFpbmVyIgoJCQldOwoKCQkJJC5tb2JpbGUud2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJaWYgKCAkLmluQXJyYXkoIGtleSwgZXhjbHVzaW9ucyApID09PSAtMSApIHsKCQkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCQlfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJdmFyCgkJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJCXJjID0gewoJCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQkJY3g6IHdpbkNvb3Jkcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQkJY3k6IHdpbkNvb3Jkcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJCX0sCgkJCQltZW51U2l6ZSwgcmV0OwoKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQkJbWVudVNpemUgPSB7CgkJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCQl9OwoKCQkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQkJcmV0ID0gewoJCQkJeDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN4LCBtZW51U2l6ZS5jeCwgcmMueCwgZGVzaXJlZC54ICksCgkJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCQl9OwoKCQkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCQkvLyBmaXggZm9yICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgYnVnIGluIGNvcmUgMS43LjIuCgkJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCQlkb2NIZWlnaHQgPSBNYXRoLm1heCggZG9jRWwuY2xpZW50SGVpZ2h0LCBkb2NCb2R5LnNjcm9sbEhlaWdodCwgZG9jQm9keS5vZmZzZXRIZWlnaHQsIGRvY0VsLnNjcm9sbEhlaWdodCwgZG9jRWwub2Zmc2V0SGVpZ2h0ICk7CgoJCQlyZXQueSAtPSBNYXRoLm1pbiggcmV0LnksIE1hdGgubWF4KCAwLCByZXQueSArIG1lbnVTaXplLmN5IC0gZG9jSGVpZ2h0ICkgKTsKCgkJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07CgkJfSwKCgkJX2NyZWF0ZVByZXJlcXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXEsIGNvbnRhaW5lclByZXJlcSwgd2hlbkRvbmUgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIGFuZCBzZWxmLl9wcmVyZXFzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbgoJCQkvLyB0aGUgY2xvc3VyZSBvZiB0aGUgZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlIGxvY2FsIHZhcmlhYmxlIGFuZAoJCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJCS8vIG5leHQgdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQgdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaAoJCQkvLyAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMgZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdCBjYWxsZWQgZm9yCgkJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJCS8vIC0gbWFraW5nIGl0IHN0YWxlLiBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZSBzZWxmLl9wcmVyZXFzIGVuc3VyZXMgdGhhdAoJCQkvLyBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUgLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJCXByZXJlcXMgPSB7CgkJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJCX07CgoJCQlwcmVyZXFzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQljb250YWluZXJQcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQkkLndoZW4oIHByZXJlcXMuc2NyZWVuLCBwcmVyZXFzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNlbGYuX3ByZXJlcXMgPSBudWxsOwoJCQkJCXdoZW5Eb25lKCk7CgkJCQl9CgkJCX0pOwoKCQkJc2VsZi5fcHJlcmVxcyA9IHByZXJlcXM7CgkJfSwKCgkJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZWxvdmUgdGhlIGRlZmVycmVkCgkJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJCWFyZ3MucHJlcmVxcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJfSBlbHNlIHsKCQkJCWFyZ3MucHJlcmVxcy5jb250YWluZXIucmVzb2x2ZSgpOwoJCQl9CgkJfSwKCgkJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCB4LCB5LCBwb3NpdGlvblRvICkgewoJCQl2YXIgZHN0ID0gbnVsbCwgb2Zmc2V0LCB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCQlpZiAoIHBvc2l0aW9uVG8gJiYgcG9zaXRpb25UbyAhPT0gIm9yaWdpbiIgKSB7CgkJCQlpZiAoIHBvc2l0aW9uVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJCX0gZWxzZSB7CgkJCQkJdHJ5IHsKCQkJCQkJZHN0ID0gJCggcG9zaXRpb25UbyApOwoJCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJCWlmICggZHN0ICkgewoJCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJCWRzdCA9IG51bGw7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCQlpZiAoIGRzdCApIHsKCQkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJfQoJCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJfQoKCQkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJCX0sCgoJCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJc2VsZi5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQlzZWxmLl9pc09wZW4gPSB0cnVlOwoJCQlzZWxmLl9yZXNpemVTY3JlZW4oKTsKCgkJCS8vIEFuZHJvaWQgYXBwZWFycyB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gY29tcGxldGUgYmVmb3JlIHRoZSBwb3B1cAoJCQkvLyBpcyB2aXNpYmxlLiBBbGxvd2luZyB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSBhcHBseWluZyBmb2N1cyBwcmV2ZW50cwoJCQkvLyB0aGUgImJsdWUgZmxhc2giIG9mIGVsZW1lbnQgZm9jdXMgaW4gYW5kcm9pZCA0LjAKCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJc2VsZi5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJCQlzZWxmLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJCQl9KTsKCQl9LAoKCQlfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBjb29yZHMsIHRyYW5zaXRpb24sCgkJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJCWlmKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9KCkpOwoKCQkJLy8gTWFrZSBzdXJlIG9wdGlvbnMgaXMgZGVmaW5lZAoJCQlvcHRpb25zID0gKCBvcHRpb25zIHx8IHt9ICk7CgoJCQkvLyBDb3B5IG91dCB0aGUgdHJhbnNpdGlvbiwgYmVjYXVzZSB3ZSBtYXkgYmUgb3ZlcndyaXRpbmcgaXQgbGF0ZXIgYW5kIHdlIGRvbid0IHdhbnQgdG8gcGFzcyB0aGF0IGNoYW5nZSBiYWNrIHRvIHRoZSBjYWxsZXIKCQkJdHJhbnNpdGlvbiA9IG9wdGlvbnMudHJhbnNpdGlvbiB8fCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iICk7CgoJCQljb29yZHMgPSB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wdGlvbnMueCwgb3B0aW9ucy55LCBvcHRpb25zLnBvc2l0aW9uVG8gfHwgdGhpcy5vcHRpb25zLnBvc2l0aW9uVG8gfHwgIm9yaWdpbiIgKSApOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLm5vb3AsCgkJCQkkLm5vb3AsCgkJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXFzQ29tcGxldGUiICkgKTsKCgkJCWlmICggdHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gdHJhbnNpdGlvbjsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoJCQl9IGVsc2UgewoJCQkJdHJhbnNpdGlvbiA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoJCQl9CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggdGhpcy5fcGFnZS5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuX3BhZ2UsICJjIiApICk7CgkJCX0KCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkub2Zmc2V0KCBjb29yZHMgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkJLyogVE9ETzoKCQkJCVRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkCgkJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQkJdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6CgkJCQlodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgoJCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkJKi8KCgkJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCQl9CgkJCXRoaXMuX2FuaW1hdGUoewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxc0RvbmU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIG9wdHMgPSBzZWxmLm9wdGlvbnM7CgoJCQlzZWxmLl91aS5jb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncyBpZiB0aGV5IGFyZSBzdGlsbCBwcmVzZW50CgkJCW9wdHMuY29udGFpbmVyLnVuYmluZCggb3B0cy5jbG9zZUV2ZW50cyApOwoKCQkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCQlzZWxmLmVsZW1lbnQudW5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMgKTsKCgkJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJCXNlbGYuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJCX0sCgoJCV9jbG9zZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcVNjcmVlbiIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxc0RvbmUiICkgKTsKCgkJCXRoaXMuX2FuaW1hdGUoIHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQkJdHJhbnNpdGlvbjogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiB8fCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiApLAoJCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkvLyBoaWRlIGFuZCByZW1vdmUgYmluZGluZ3MKCQkJc2VsZi5fY2xvc2UoKTsKCgkJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCQlzZWxmLl9zZXRUaGVtZSggIm5vbmUiICk7CgkJCXNlbGYuZWxlbWVudAoJCQkJLmluc2VydEFmdGVyKCBzZWxmLl91aS5wbGFjZWhvbGRlciApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIiApOwoJCQlzZWxmLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJCXNlbGYuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQkJc2VsZi5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgoJCQkvLyBVbmJpbmQgaGFuZGxlcnMgdGhhdCB3ZXJlIGJvdW5kIHRvIGVsZW1lbnRzIG91dHNpZGUgc2VsZi5lbGVtZW50ICh0aGUgd2luZG93LCBpbiBzZWxmIGNhc2UpCgkJCSQuZWFjaCggc2VsZi5fZ2xvYmFsSGFuZGxlcnMsIGZ1bmN0aW9uKCBpZHgsIG9uZVNyYyApIHsKCQkJCSQuZWFjaCggb25lU3JjLmhhbmRsZXIsIGZ1bmN0aW9uKCBldmVudFR5cGUsIGhhbmRsZXIgKSB7CgkJCQkJb25lU3JjLnNyYy51bmJpbmQoIGV2ZW50VHlwZSwgaGFuZGxlciApOwoJCQkJfSk7CgkJCX0pOwoJCX0sCgoJCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCQkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCQkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQlzZWxmLm9wdGlvbnMuY29udGFpbmVyCgkJCQkub25lKCBzZWxmLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHNlbGYuX2Nsb3NlLCBzZWxmICkpOwoJCX0sCgoJCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCQkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCQlvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gdGhpcy5vcHRpb25zLCB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeTsKCgkJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCgkJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQkJaWYoICEoIG9wdHMuaGlzdG9yeSApICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlzZWxmLl9jbG9zZSgpOwoKCQkJCQkJLy8gTk9URSBwcmV2ZW50IHRoZSBicm93c2VyIGFuZCBuYXZpZ2F0aW9uIGhhbmRsZXJzIGZyb20KCQkJCQkJLy8gd29ya2luZyB3aXRoIHRoZSBsaW5rJ3MgcmVsPWJhY2suIFRoaXMgbWF5IGNhdXNlCgkJCQkJCS8vIGlzc3VlcyBmb3IgZGV2ZWxvcGVycyBleHBlY3RpbmcgdGhlIGV2ZW50IHRvIGJ1YmJsZQoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfSk7CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJCXVybCA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nOwoJCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUudXJsSGlzdG9yeTsKCgkJCWlmICggaGFzSGFzaCApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKXsKCQkJCXVybCA9IHVybCArIGhhc2hrZXk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQkJfQoKCQkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBoYXNoa2V5OwoJCQl9CgoJCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkJb3B0cy5jb250YWluZXIub25lKCBvcHRzLm5hdmlnYXRlRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQl9KTsKCgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBjdXJyZW50SXNEaWFsb2c7CgoJCQkvLyBHb3R0YSBsb3ZlIG1ldGhvZHMgd2l0aCAxbW0gYXJncyA6KAoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAiZGlhbG9nIiApOwoKCQkJLy8gc2V0IHRoZSBuZXcgdXJsIHdpdGggKG9yIHdpdGhvdXQpIHRoZSBuZXcgZGlhbG9nIGhhc2gga2V5CgkJCSQubW9iaWxlLnBhdGguc2V0KCB1cmwgKTsKCQl9LAoKCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJCWlmKCAhJC5tb2JpbGUucG9wdXAuYWN0aXZlICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX2Nsb3NlKCk7CgkJCX0KCQl9Cgl9KTsKCgoJLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAoJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCQl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlzY29wZSA9ICggKCBjbG9zZXN0UGFnZS5sZW5ndGggPT09IDAgKSA/ICQoICJib2R5IiApIDogY2xvc2VzdFBhZ2UgKSwKCQkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkJLy8gICAgICBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQkJcG9wdXAgPSAkKCAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCRsaW5rLmF0dHIoICJocmVmIiApKS5oYXNoLCBzY29wZVswXSApLAoJCQlvZmZzZXQ7CgoJCWlmICggcG9wdXAuZGF0YSggInBvcHVwIiApICkgewoJCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICksCgkJCQlsaW5rOiAkbGluawoJCQl9KTsKCQl9CgoJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0sIDMwMCApOwoJfTsKCgkvLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQlpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSk7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSkiLAoJCWNsZWFyU2VhcmNoQnV0dG9uVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmkgPSBpbnB1dC5qcW1EYXRhKCAibWluaSIgKSA9PT0gdHJ1ZSwKCQkJbWluaWNsYXNzID0gbWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZm9jdXNlZEVsLCBjbGVhcmJ0bjsKCgkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJfSwgMCApOwoJCX0KCgkJJCggImxhYmVsW2Zvcj0nIiArIGlucHV0LmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLWlucHV0LXRleHQiICk7CgoJCWZvY3VzZWRFbCA9IGlucHV0LmFkZENsYXNzKCJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgoJCS8vInNlYXJjaCIgaW5wdXQgd2lkZ2V0CgkJaWYgKCBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSApIHsKCgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC1zZWFyY2ggdWktc2hhZG93LWluc2V0IHVpLWJ0bi1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3cgdWktaWNvbi1zZWFyY2hmaWVsZCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCQljbGVhcmJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXInIHRpdGxlPSciICsgby5jbGVhclNlYXJjaEJ1dHRvblRleHQgKyAiJz4iICsgby5jbGVhclNlYXJjaEJ1dHRvblRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0CgkJCQkJCS52YWwoICIiICkKCQkJCQkJLmZvY3VzKCkKCQkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCAncGFzdGUgY3V0IGtleXVwIGZvY3VzIGNoYW5nZSBibHVyJywgdG9nZ2xlQ2xlYXIgKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0KCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQl0aGlzLl9rZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCWlucHV0LmhlaWdodChzY3JvbGxIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQpOwoJCQkJfQoJCQl9OwoKCQkJaW5wdXQua2V5dXAoZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggJChkb2N1bWVudCksIHsicGFnZWNoYW5nZSI6ICJfa2V5dXAiIH0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIGlucHV0LnZhbCgpICkgKSB7CgkJCQkvLyBiaW5kIHRvIHRoZSB3aW5kb3cgbG9hZCB0byBtYWtlIHN1cmUgdGhlIGhlaWdodCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIEJPVEgKCQkJCS8vIHRoZSBET00gYW5kIENTUwoJCQkJdGhpcy5fb24oICQod2luZG93KSwgeyJsb2FkIjogIl9rZXl1cCJ9KTsKCQkJfQoJCX0KCQlpZiAoIGlucHV0LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsOwoJCWlmICggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKS5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsOwoKCQkvLyBUT0RPIHVzaW5nIG1vcmUgdGhhbiBvbmUgbGluZSBvZiBjb2RlIGlzIGFjY2VwdGFibGUgOykKCQlpZiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKLy8gVE9ETyByZW5hbWUgY2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSwgaXRlbSApIHsKCQlyZXR1cm4gdGV4dC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cgl9OwoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXZhbCA9IHRoaXMudmFsdWUudG9Mb3dlckNhc2UoKSwKCQkJCWxpc3RJdGVtcyA9IG51bGwsCgkJCQlsYXN0dmFsID0gJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICkgKyAiIiwKCQkJCWNoaWxkSXRlbXMgPSBmYWxzZSwKCQkJCWl0ZW10ZXh0ID0gIiIsCgkJCQlpdGVtLAoJCQkJLy8gQ2hlY2sgaWYgYSBjdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMKCQkJCWlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgPSBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrICE9PSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgoJCQlsaXN0dmlldy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiB0aGlzIH0gKTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggaXNDdXN0b21GaWx0ZXJDYWxsYmFjayB8fCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgdmFsLmluZGV4T2YoIGxhc3R2YWwgKSAhPT0gMCApIHsKCgkJCQkvLyBDdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMgb3IgcmVtb3ZlZCBjaGFycyBvciBwYXN0ZWQgc29tZXRoaW5nIHRvdGFsbHkgZGlmZmVyZW50LCBjaGVjayBhbGwgaXRlbXMKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oKTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBPbmx5IGNoYXJzIGFkZGVkLCBub3QgcmVtb3ZlZCwgb25seSB1c2UgdmlzaWJsZSBzdWJzZXQKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICI6bm90KC51aS1zY3JlZW4taGlkZGVuKSIgKTsKCQkJfQoKCQkJaWYgKCB2YWwgKSB7CgoJCQkJLy8gVGhpcyBoYW5kbGVzIGhpZGluZyByZWd1bGFyIHJvd3Mgd2l0aG91dCB0aGUgdGV4dCB3ZSBzZWFyY2ggZm9yCgkJCQkvLyBhbmQgYW55IGxpc3QgZGl2aWRlcnMgd2l0aG91dCByZWd1bGFyIHJvd3Mgc2hvd24gdW5kZXIgaXQKCgkJCQlmb3IgKCB2YXIgaSA9IGxpc3RJdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCQlpdGVtID0gJCggbGlzdEl0ZW1zWyBpIF0gKTsKCQkJCQlpdGVtdGV4dCA9IGl0ZW0uanFtRGF0YSggImZpbHRlcnRleHQiICkgfHwgaXRlbS50ZXh0KCk7CgoJCQkJCWlmICggaXRlbS5pcyggImxpOmpxbURhdGEocm9sZT1saXN0LWRpdmlkZXIpIiApICkgewoKCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgIWNoaWxkSXRlbXMgKTsKCgkJCQkJCS8vIE5ldyBidWNrZXQhCgkJCQkJCWNoaWxkSXRlbXMgPSBmYWxzZTsKCgkJCQkJfSBlbHNlIGlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayggaXRlbXRleHQsIHZhbCwgaXRlbSApICkgewoKCQkJCQkJLy9tYXJrIHRvIGJlIGhpZGRlbgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCB0cnVlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vIFRoZXJlJ3MgYSBzaG93biBpdGVtIGluIHRoZSBidWNrZXQKCQkJCQkJY2hpbGRJdGVtcyA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFNob3cgaXRlbXMsIG5vdCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiOm5vdCgudWktZmlsdGVyLWhpZGVxdWV1ZSkiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCgkJCQkvLyBIaWRlIGl0ZW1zLCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiLnVpLWZpbHRlci1oaWRlcXVldWUiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgdHJ1ZSApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIsIGZhbHNlICk7CgoJCQl9IGVsc2UgewoKCQkJCS8vZmlsdGVydmFsdWUgaXMgZW1wdHkgPT4gc2hvdyBhbGwKCQkJCWxpc3RJdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoJCQl9CgkJCWxpc3R2aWV3Ll9yZWZyZXNoQ29ybmVycygpOwoJCX0pCgkJLmFwcGVuZFRvKCB3cmFwcGVyICkKCQkudGV4dGlucHV0KCk7CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmluc2V0ICkgewoJCXdyYXBwZXIuYWRkQ2xhc3MoICJ1aS1saXN0dmlldy1maWx0ZXItaW5zZXQiICk7Cgl9CgoJd3JhcHBlci5iaW5kKCAic3VibWl0IiwgZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSkKCS5pbnNlcnRCZWZvcmUoIGxpc3QgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgoJCQlzZWxlY3RDbGFzcyA9ICggY1R5cGUgPT09ICJzZWxlY3QiICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PT0gImlucHV0IiAgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0sCgoJCQltaW4gPSAgY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgoJCQltYXggPSAgY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlpbmxpbmVDbGFzcyA9ICggdGhpcy5vcHRpb25zLmlubGluZSB8fCBjb250cm9sLmpxbURhdGEoICJpbmxpbmUiICkgPT09IHRydWUgKSA/ICIgdWktc2xpZGVyLWlubGluZSIgOiAiIiwKCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1zbGlkZXItbWluaSIgOiAiIiwKCgoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoKCQkJdmFsdWViZyA9IGNvbnRyb2wuanFtRGF0YSggImhpZ2hsaWdodCIgKSAmJiBjVHlwZSAhPT0gInNlbGVjdCIgPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItYmcgJyArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgJyB1aS1idG4tY29ybmVyLWFsbCc7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgoJCQlvcHRpb25zOwoKCQl0aGlzLl90eXBlID0gY1R5cGU7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICdocmVmJywgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSgncm9sZScsJ2FwcGxpY2F0aW9uJyk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsndWktc2xpZGVyICcsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsJyB1aS1idG4tY29ybmVyLWFsbCcsIGlubGluZUNsYXNzLCBtaW5pQ2xhc3NdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaGFuZGxlJzsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaW5uZXJvZmZzZXQnOwoKCQkJZm9yICggdmFyIGogPSAwLGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDtqIDwgbGVuZ3RoO2orKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggdmFyIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIiA6ICJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6ICggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ3NwYW4nICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0nLHNpZGUsc2xpZGVyVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCJdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCdyb2xlJywnaW1nJyk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKHNsaWRlckltZykucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQkJCWlmICggIXNlbGYubW91c2VNb3ZlZCApIHsKCQkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5rZXl1cChmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJfSk7CgoJCXRoaXMuX3ByZXZlbnREb2N1bWVudERyYWcgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCBzZWxmLmRyYWdnaW5nICYmICFzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgoJCQkJLy8gc2VsZi5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQlzZWxmLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQloYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoKCQkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSBzZWxmLnVzZXJNb2RpZmllZAoJCQkJc2VsZi51c2VyTW9kaWZpZWQgPSBzZWxmLmJlZm9yZVN0YXJ0ICE9PSBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgoJCXRoaXMuX29uKCAkKCBkb2N1bWVudCApLCB7ICJ2bW91c2Vtb3ZlIjogdGhpcy5fcHJldmVudERvY3VtZW50RHJhZyB9KTsKCgkJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJCWNvbnRyb2wuYmluZCggInZtb3VzZXVwIiwgJC5wcm94eSggc2VsZi5fY2hlY2tlZFJlZnJlc2gsIHNlbGYpKTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlzZWxmLmRyYWdnaW5nID0gdHJ1ZTsKCQkJc2VsZi51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCXNlbGYuYmVmb3JlU3RhcnQgPSBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCgkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCQkJc2VsZi5fdHJpZ2dlciggInN0YXJ0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSkKCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX3NsaWRlck1vdXNlVXAgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLmRyYWdnaW5nICkgewoJCQkJc2VsZi5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkgICAgc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJICAgIHNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0KCQkJCX0KCgkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJCXNlbGYuX3RyaWdnZXIoICJzdG9wIiApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfTsKCgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogdGhpcy5fc2xpZGVyTW91c2VVcCB9KTsKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gT25seSBhZGQgZm9jdXMgY2xhc3MgdG8gdG9nZ2xlIHN3aXRjaCwgc2xpZGVycyBnZXQgaXQgYXV0b21hdGljYWxseSBmcm9tIHVpLWJ0bgoJCWlmICggY1R5cGUgPT09ICdzZWxlY3QnICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmZvY3VzKCk7CgkJCX0sCgoJCQl2Y2xpY2s6IGZhbHNlLAoKCQkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGluZGV4ID0gdmFsKCk7CgoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1pbiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1heCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4IC0gc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiggdGhpcy52YWx1ZSAhPSB0aGlzLl92YWx1ZSgpICl7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuX3R5cGUgPT09ICJpbnB1dCIgPwoJCQlwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA6IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgoJCXZhciBjb250cm9sID0gdGhpcy5lbGVtZW50LCBwZXJjZW50LAoJCQljVHlwZSA9IGNvbnRyb2xbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJbWluID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJdmFyIGRhdGEgPSB2YWwsCgkJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCQl0b2wgPSA4OwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCArIHRoaXMuc2xpZGVyLndpZHRoKCkgKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCApIC8gdGhpcy5zbGlkZXIud2lkdGgoKSApICogMTAwICk7CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJdmFyIG5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhciB2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJdmFyIGFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgkJdGhpcy5oYW5kbGUuYXR0ciggewoJCQkJImFyaWEtdmFsdWVub3ciOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApLAoJCQkJImFyaWEtdmFsdWV0ZXh0IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCksCgkJCQl0aXRsZTogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkKCQkJfSk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJdmFyIGhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMCwKCQkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwLAoJCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5pcyggIi51aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBjVHlwZSA9PT0gImlucHV0IiApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImFycm93LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpICkiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWlubGluZSA9IG9wdGlvbnMuaW5saW5lIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvcHRpb25zLm1pbmkgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggIm1pbmkiICksCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQkvLyBJRSB0aHJvd3MgYW4gZXhjZXB0aW9uIGF0IG9wdGlvbnMuaXRlbSgpIGZ1bmN0aW9uIHdoZW4KCQkJLy8gdGhlcmUgaXMgbm8gc2VsZWN0ZWQgaXRlbQoJCQkvLyBzZWxlY3QgZmlyc3QgaW4gdGhpcyBjYXNlCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXggPT09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IGljb25wb3MsCgkJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQkJY29ybmVyczogb3B0aW9ucy5jb3JuZXJzLAoJCQkJCXNoYWRvdzogb3B0aW9ucy5zaGFkb3csCgkJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93LAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KS5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCk7CgkJCX0KCQl9KTsKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNlbGVjdG1lbnUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSIgfSApLmluc2VydEFmdGVyKCB3aWRnZXQuc2VsZWN0ICkucG9wdXAoIHsgdGhlbWU6ICJhIiB9ICksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmICggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCgkJCQkJfSkKCQkJCQkuYmluZCggImZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDM4OgoJCQkJCQkJcHJldiA9IGxpLnByZXYoKS5ub3QoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCgkJCQkJCQlpZiAoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJaWYgKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCWNhc2UgMTM6CgkJCQkJCWNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCQkJfQoKCQkJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJCQl9LAoKCQkJb3BlbjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCQkJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJCQltZW51V2lkdGggPSBzZWxmTGlzdFBhcmVudC5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkd2luZG93LndpZHRoKCk7CgoJCQkJLy9hZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSwgMzAwKTsKCgkJCQlmdW5jdGlvbiBmb2N1c01lbnVJdGVtKCkgewoJCQkJCXZhciBzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgYSIgKTsKCQkJCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggImxpLnVpLWJ0bjpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggc2VsZi5tZW51UGFnZSwgewoJCQkJCQl0cmFuc2l0aW9uOiAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbgoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gKCQkJCQkJLm9uZSggInBvcHVwYWZ0ZXJvcGVuIiwgZm9jdXNNZW51SXRlbSApCgkJCQkJCS5wb3B1cCggIm9wZW4iLCB7CgkJCQkJCQl4OiBzZWxmLmJ1dHRvbi5vZmZzZXQoKS5sZWZ0ICsgc2VsZi5idXR0b24ub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCQkJCXk6IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCArIHNlbGYuYnV0dG9uLm91dGVySGVpZ2h0KCkgLyAyCgkJCQkJCX0pOwoKCQkJCQkvLyBkdXBsaWNhdGUgd2l0aCB2YWx1ZSBzZXQgaW4gcGFnZSBzaG93IGZvciBkaWFsb2cgc2l6ZWQgc2VsZWN0cwoJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCX0KCQkJfSwKCgkJCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQl2YXIgJG9wdGlvbnMgPSBzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLAoJCQkJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGgsCgkJCQkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXSwKCQkJCQlkYXRhUHJlZml4ID0gJ2RhdGEtJyArICQubW9iaWxlLm5zLAoJCQkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgJ29wdGlvbi1pbmRleCcsCgkJCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICdpY29uJywKCQkJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgJ3JvbGUnLAoJCQkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgJ3BsYWNlaG9sZGVyJywKCQkJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQkJCW9wdEdyb3VwOwoKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJCQl2YXIgb3B0aW9uID0gJG9wdGlvbnNbaV0sCgkJCQkJCSRvcHRpb24gPSAkKCBvcHRpb24gKSwKCQkJCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGUsCgkJCQkJCXRleHQgPSAkb3B0aW9uLnRleHQoKSwKCQkJCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdhJyApLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICdocmVmJywgJyMnICk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggJ2xhYmVsJyApOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCBtYXJrIGl0IHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCFwbGFjZWhvbGRlcikgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0cixpICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCX0KCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQkJCX0KCgkJCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggIjxhPiIsIHsKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJCX0pOwoJCQl9CgkJfSk7Cgl9OwoKCS8vIGlzc3VlICMzODk0IC0gY29yZSBkb2Vzbid0IHRyaWdnZXIgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJCggZG9jdW1lbnQgKS5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJzZWxlY3RtZW51IiApOwoKCQlpZiAoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSAmJgoJCQkJc2VsZWN0bWVudVdpZGdldC5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAiLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCQkJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJCQkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCQkJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCgkJCQlpZigKCQkJCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJCQkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJCQkJLy8gT3BlcmEgTWluaQoJCQkJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJCQkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkJCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJCQkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCQkJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCQkJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCQkJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJCQkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJCQkJLy8gTWVlR28KCQkJCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYgKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXNlbGYuZGVzdHJveSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZml4ZWQiICk7CgoJCQkvLyAiZnVsbHNjcmVlbiIgb3ZlcmxheSBwb3NpdGlvbmluZwoJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJCQlzZWxmLmhpZGUoIHRydWUgKTsKCQkJCQl9CgkJCQl9ICkKCQkJCS5iaW5kKCAid2Via2l0QW5pbWF0aW9uU3RhcnQgYW5pbWF0aW9uc3RhcnQgdXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdGhpc1BhZ2UgPSB0aGlzOwoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi51cGRhdGVQYWdlUGFkZGluZyggdGhpc1BhZ2UgKTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCQl9CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUuIiArIHNlbGYud2lkZ2V0TmFtZSApOwoJCQkJCX0KCgkJCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpLAoJCQkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggdGhpcyApOwoJCQkJCQkJCX0pOwoJCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoKCQkJdGJQYWdlID0gdGJQYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGJ0eXBlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGJ0eXBlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQ7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCA1MDAgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGZbICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgc2VsZi5fdmlzaWJsZSApID8gImhpZGUiIDogInNob3ciIF0oKTsKCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCS8vIERFUFJFQ0FURUQgaW4gMS4xOiBzdXBwb3J0IGZvciBkYXRhLWZ1bGxzY3JlZW49dHJ1ZXxmYWxzZSBvbiB0aGUgcGFnZSBlbGVtZW50LgoJCQkvLyBUaGlzIGxpbmUgZW5zdXJlcyBpdCBzdGlsbCB3b3JrcywgYnV0IHdlIHJlY29tbWVuZCBtb3ZpbmcgdGhlIGF0dHJpYnV0ZSB0byB0aGUgdG9vbGJhcnMgdGhlbXNlbHZlcy4KCQkJaWYgKCAkKCBlLnRhcmdldCApLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCglpZiAoICEoL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApIHsKCQlyZXR1cm47Cgl9CgogIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCiAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICkgewoJCWV2dCA9IGUub3JpZ2luYWxFdmVudDsKCQlhaWcgPSBldnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKCgkJeCA9IE1hdGguYWJzKCBhaWcueCApOwoJCXkgPSBNYXRoLmFicyggYWlnLnkgKTsKCQl6ID0gTWF0aC5hYnMoIGFpZy56ICk7CgoJCS8vIElmIHBvcnRyYWl0IG9yaWVudGF0aW9uIGFuZCBpbiBvbmUgb2YgdGhlIGRhbmdlciB6b25lcwogICAgaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZGlzYWJsZSgpOwoJCQl9CiAgICB9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQl6b29tLmVuYWJsZSgpOwogICAgfQogIH0KCiAgJCggd2luZG93ICkKCQkuYmluZCggIm9yaWVudGF0aW9uY2hhbmdlLmlvc29yaWVudGF0aW9uZml4Iiwgem9vbS5lbmFibGUgKQoJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaC5yZXBsYWNlKCIjIiwgIiIpLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICRwYWdlcy5maXJzdCgpLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsgdHJhbnNpdGlvbjogIm5vbmUiLCByZXZlcnNlOiB0cnVlLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJCS8vIG90aGVyd2lzZSwgdHJpZ2dlciBhIGhhc2hjaGFuZ2UgdG8gbG9hZCBhIGRlZXBsaW5rCgkJCWVsc2UgewoJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFsgdHJ1ZSBdICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLnJlc29sdmUoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCgkJLy8gVE9ETzogSW1wbGVtZW50IGEgcHJvcGVyIHJlZ2lzdHJhdGlvbiBtZWNoYW5pc20gd2l0aCBkZXBlbmRlbmN5IGhhbmRsaW5nIGluIG9yZGVyIHRvIG5vdCBoYXZlIGV4Y2VwdGlvbnMgbGlrZSB0aGUgb25lIGJlbG93CgkJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzIGZvciB0aG9zZSB3aWRnZXRzIHRoYXQgaGF2ZSBhIHNvZnQgZGVwZW5kZW5jeSBvbiBvdGhlcnMKCQlpZiAoICQuZm4uY29udHJvbGdyb3VwICkgewoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJJCggIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIiwgZS50YXJnZXQgKQoJCQkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCQkJLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwoJCQl9KTsKCQl9CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKfSkpOwo=",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIEZyYW1ld29yayBHaXQgQnVpbGQ6IFNIQTE6IGI0OWNjMDY0OTlhYmY4Zjk4N2NmOTBmMzUzNDljZmFjMDkxOGM5MzkgPD4gRGF0ZTogVHVlIE9jdCAyIDExOjIyOjM0IDIwMTIgLTA3MDAKKiBodHRwOi8vanF1ZXJ5bW9iaWxlLmNvbQoqCiogQ29weXJpZ2h0IDIwMTIgalF1ZXJ5IEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwoqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCioKKi8KCgooZnVuY3Rpb24gKCByb290LCBkb2MsIGZhY3RvcnkgKSB7CglpZiAoIHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCApIHsKCQkvLyBBTUQuIFJlZ2lzdGVyIGFzIGFuIGFub255bW91cyBtb2R1bGUuCgkJZGVmaW5lKCBbICJqcXVlcnkiIF0sIGZ1bmN0aW9uICggJCApIHsKCQkJZmFjdG9yeSggJCwgcm9vdCwgZG9jICk7CgkJCXJldHVybiAkLm1vYmlsZTsKCQl9KTsKCX0gZWxzZSB7CgkJLy8gQnJvd3NlciBnbG9iYWxzCgkJZmFjdG9yeSggcm9vdC5qUXVlcnksIHJvb3QsIGRvYyApOwoJfQp9KCB0aGlzLCBkb2N1bWVudCwgZnVuY3Rpb24gKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCApIHsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCgl2YXIgbnNOb3JtYWxpemVEaWN0ID0ge307CgoJLy8galF1ZXJ5Lm1vYmlsZSBjb25maWd1cmFibGUgb3B0aW9ucwoJJC5tb2JpbGUgPSAkLmV4dGVuZCgge30sIHsKCgkJLy8gVmVyc2lvbiBvZiB0aGUgalF1ZXJ5IE1vYmlsZSBGcmFtZXdvcmsKCQl2ZXJzaW9uOiAiMS4yLjAiLAoKCQkvLyBOYW1lc3BhY2UgdXNlZCBmcmFtZXdvcmstd2lkZSBmb3IgZGF0YS1hdHRycy4gRGVmYXVsdCBpcyBubyBuYW1lc3BhY2UKCQluczogIiIsCgoJCS8vIERlZmluZSB0aGUgdXJsIHBhcmFtZXRlciB1c2VkIGZvciByZWZlcmVuY2luZyB3aWRnZXQtZ2VuZXJhdGVkIHN1Yi1wYWdlcy4KCQkvLyBUcmFuc2xhdGVzIHRvIHRvIGV4YW1wbGUuaHRtbCZ1aS1wYWdlPXN1YnBhZ2VJZGVudGlmaWVyCgkJLy8gaGFzaCBzZWdtZW50IGJlZm9yZSAmdWktcGFnZT0gaXMgdXNlZCB0byBtYWtlIEFqYXggcmVxdWVzdAoJCXN1YlBhZ2VVcmxLZXk6ICJ1aS1wYWdlIiwKCgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImFjdGl2ZSIgYnV0dG9uIHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlhY3RpdmVCdG5DbGFzczogInVpLWJ0bi1hY3RpdmUiLAoKCQkvLyBDbGFzcyB1c2VkIGZvciAiZm9jdXMiIGZvcm0gZWxlbWVudCBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJZm9jdXNDbGFzczogInVpLWZvY3VzIiwKCgkJLy8gQXV0b21hdGljYWxseSBoYW5kbGUgY2xpY2tzIGFuZCBmb3JtIHN1Ym1pc3Npb25zIHRocm91Z2ggQWpheCwgd2hlbiBzYW1lLWRvbWFpbgoJCWFqYXhFbmFibGVkOiB0cnVlLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGxvYWQgYW5kIHNob3cgcGFnZXMgYmFzZWQgb24gbG9jYXRpb24uaGFzaAoJCWhhc2hMaXN0ZW5pbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBkaXNhYmxlIHRvIHByZXZlbnQganF1ZXJ5IGZyb20gYm90aGVyaW5nIHdpdGggbGlua3MKCQlsaW5rQmluZGluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIFNldCBkZWZhdWx0IHBhZ2UgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0UGFnZVRyYW5zaXRpb246ICJmYWRlIiwKCgkJLy8gU2V0IG1heGltdW0gd2luZG93IHdpZHRoIGZvciB0cmFuc2l0aW9ucyB0byBhcHBseSAtICdmYWxzZScgZm9yIG5vIGxpbWl0CgkJbWF4VHJhbnNpdGlvbldpZHRoOiBmYWxzZSwKCgkJLy8gTWluaW11bSBzY3JvbGwgZGlzdGFuY2UgdGhhdCB3aWxsIGJlIHJlbWVtYmVyZWQgd2hlbiByZXR1cm5pbmcgdG8gYSBwYWdlCgkJbWluU2Nyb2xsQmFjazogMjUwLAoKCQkvLyBERVBSRUNBVEVEOiB0aGUgZm9sbG93aW5nIHByb3BlcnR5IGlzIG5vIGxvbmdlciBpbiB1c2UsIGJ1dCBkZWZpbmVkIHVudGlsIDIuMCB0byBwcmV2ZW50IGNvbmZsaWN0cwoJCXRvdWNoT3ZlcmZsb3dFbmFibGVkOiBmYWxzZSwKCgkJLy8gU2V0IGRlZmF1bHQgZGlhbG9nIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdERpYWxvZ1RyYW5zaXRpb246ICJwb3AiLAoKCQkvLyBFcnJvciByZXNwb25zZSBtZXNzYWdlIC0gYXBwZWFycyB3aGVuIGFuIEFqYXggcGFnZSByZXF1ZXN0IGZhaWxzCgkJcGFnZUxvYWRFcnJvck1lc3NhZ2U6ICJFcnJvciBMb2FkaW5nIFBhZ2UiLAoKCQkvLyBGb3IgZXJyb3IgbWVzc2FnZXMsIHdoaWNoIHRoZW1lIGRvZXMgdGhlIGJveCB1c2VzPwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWU6ICJlIiwKCgkJLy8gcmVwbGFjZSBjYWxscyB0byB3aW5kb3cuaGlzdG9yeS5iYWNrIHdpdGggcGhvbmVnYXBzIG5hdmlnYXRpb24gaGVscGVyCgkJLy8gd2hlcmUgaXQgaXMgcHJvdmlkZWQgb24gdGhlIHdpbmRvdyBvYmplY3QKCQlwaG9uZWdhcE5hdmlnYXRpb25FbmFibGVkOiBmYWxzZSwKCgkJLy9hdXRvbWF0aWNhbGx5IGluaXRpYWxpemUgdGhlIERPTSB3aGVuIGl0J3MgcmVhZHkKCQlhdXRvSW5pdGlhbGl6ZVBhZ2U6IHRydWUsCgoJCXB1c2hTdGF0ZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGFsbG93cyB1c2VycyB0byBvcHQgaW4gdG8gaWdub3JpbmcgY29udGVudCBieSBtYXJraW5nIGEgcGFyZW50IGVsZW1lbnQgYXMKCQkvLyBkYXRhLWlnbm9yZWQKCQlpZ25vcmVDb250ZW50RW5hYmxlZDogZmFsc2UsCgoJCS8vIHR1cm4gb2YgYmluZGluZyB0byB0aGUgbmF0aXZlIG9yaWVudGF0aW9uY2hhbmdlIGR1ZSB0byBhbmRyb2lkIG9yaWVudGF0aW9uIGJlaGF2aW9yCgkJb3JpZW50YXRpb25DaGFuZ2VFbmFibGVkOiB0cnVlLAoKCQlidXR0b25NYXJrdXA6IHsKCQkJaG92ZXJEZWxheTogMjAwCgkJfSwKCgkJLy8gVE9ETyBtaWdodCBiZSB1c2VmdWwgdXBzdHJlYW0gaW4ganF1ZXJ5IGl0c2VsZiA/CgkJa2V5Q29kZTogewoJCQlBTFQ6IDE4LAoJCQlCQUNLU1BBQ0U6IDgsCgkJCUNBUFNfTE9DSzogMjAsCgkJCUNPTU1BOiAxODgsCgkJCUNPTU1BTkQ6IDkxLAoJCQlDT01NQU5EX0xFRlQ6IDkxLCAvLyBDT01NQU5ECgkJCUNPTU1BTkRfUklHSFQ6IDkzLAoJCQlDT05UUk9MOiAxNywKCQkJREVMRVRFOiA0NiwKCQkJRE9XTjogNDAsCgkJCUVORDogMzUsCgkJCUVOVEVSOiAxMywKCQkJRVNDQVBFOiAyNywKCQkJSE9NRTogMzYsCgkJCUlOU0VSVDogNDUsCgkJCUxFRlQ6IDM3LAoJCQlNRU5VOiA5MywgLy8gQ09NTUFORF9SSUdIVAoJCQlOVU1QQURfQUREOiAxMDcsCgkJCU5VTVBBRF9ERUNJTUFMOiAxMTAsCgkJCU5VTVBBRF9ESVZJREU6IDExMSwKCQkJTlVNUEFEX0VOVEVSOiAxMDgsCgkJCU5VTVBBRF9NVUxUSVBMWTogMTA2LAoJCQlOVU1QQURfU1VCVFJBQ1Q6IDEwOSwKCQkJUEFHRV9ET1dOOiAzNCwKCQkJUEFHRV9VUDogMzMsCgkJCVBFUklPRDogMTkwLAoJCQlSSUdIVDogMzksCgkJCVNISUZUOiAxNiwKCQkJU1BBQ0U6IDMyLAoJCQlUQUI6IDksCgkJCVVQOiAzOCwKCQkJV0lORE9XUzogOTEgLy8gQ09NTUFORAoJCX0sCgoJCS8vIFNjcm9sbCBwYWdlIHZlcnRpY2FsbHk6IHNjcm9sbCB0byAwIHRvIGhpZGUgaU9TIGFkZHJlc3MgYmFyLCBvciBwYXNzIGEgWSB2YWx1ZQoJCXNpbGVudFNjcm9sbDogZnVuY3Rpb24oIHlwb3MgKSB7CgkJCWlmICggJC50eXBlKCB5cG9zICkgIT09ICJudW1iZXIiICkgewoJCQkJeXBvcyA9ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCQl9CgoJCQkvLyBwcmV2ZW50IHNjcm9sbHN0YXJ0IGFuZCBzY3JvbGxzdG9wIGV2ZW50cwoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHlwb3MgKTsKCQkJCSQoIGRvY3VtZW50ICkudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKSwgOmpxbURhdGEocm9sZT0iZGlhbG9nIiknICkKCQkJCS5kYXRhKCAicGFnZSIgKTsKCQl9LAoKCQllbmhhbmNlYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggJHNldCApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoICRzZXQsICJhamF4IiApOwoJCX0sCgoJCWhhdmVQYXJlbnRzOiBmdW5jdGlvbiggJHNldCwgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gJHNldDsKCQkJfQoKCQkJdmFyIGNvdW50ID0gJHNldC5sZW5ndGgsCgkJCQkkbmV3U2V0ID0gJCgpLAoJCQkJZSwgJGVsZW1lbnQsIGV4Y2x1ZGVkOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKyApIHsKCQkJCSRlbGVtZW50ID0gJHNldC5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSAkc2V0WyBpIF07CgoJCQkJd2hpbGUgKCBlICkgewoJCQkJCXZhciBjID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJCggd2luZG93ICkuaGVpZ2h0KCk7CgkJfQoJfSwgJC5tb2JpbGUgKTsKCgkvLyBNb2JpbGUgdmVyc2lvbiBvZiBkYXRhIGFuZCByZW1vdmVEYXRhIGFuZCBoYXNEYXRhIG1ldGhvZHMKCS8vIGVuc3VyZXMgYWxsIGRhdGEgaXMgc2V0IGFuZCByZXRyaWV2ZWQgdXNpbmcgalF1ZXJ5IE1vYmlsZSdzIGRhdGEgbmFtZXNwYWNlCgkkLmZuLmpxbURhdGEgPSBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJaWYgKCBwcm9wICkgewoJCQkJcHJvcCA9ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICk7CgkJCX0KCgkJCS8vIHVuZGVmaW5lZCBpcyBwZXJtaXR0ZWQgYXMgYW4gZXhwbGljaXQgaW5wdXQgZm9yIHRoZSBzZWNvbmQgcGFyYW0KCQkJLy8gaW4gdGhpcyBjYXNlIGl0IHJldHVybnMgdGhlIHZhbHVlIGFuZCBkb2VzIG5vdCBzZXQgaXQgdG8gdW5kZWZpbmVkCgkJCWlmKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICl7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AgKTsKCQkJfSBlbHNlIHsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCwgdmFsdWUgKTsKCQkJfQoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmpxbURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCwgdmFsdWUgKSB7CgkJdmFyIHJlc3VsdDsKCQlpZiAoIHR5cGVvZiBwcm9wICE9PSAidW5kZWZpbmVkIiApIHsKCQkJcmVzdWx0ID0gJC5kYXRhKCBlbGVtLCBwcm9wID8gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSA6IHByb3AsIHZhbHVlICk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuZm4uanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBwcm9wICkgewoJCXJldHVybiB0aGlzLnJlbW92ZURhdGEoICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AgKSB7CgkJcmV0dXJuICQucmVtb3ZlRGF0YSggZWxlbSwgJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmZuLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oKSB7CgkJJC5yZW1vdmVXaXRoRGVwZW5kZW50cyggdGhpcyApOwoJfTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyICRlbGVtID0gJCggZWxlbSApOwoKCQkoICRlbGVtLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKSApLnJlbW92ZSgpOwoJCSRlbGVtLnJlbW92ZSgpOwoJfTsKCgkkLmZuLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggbmV3RGVwZW5kZW50cyApIHsKCQkkLmFkZERlcGVuZGVudHMoICQoIHRoaXMgKSwgbmV3RGVwZW5kZW50cyApOwoJfTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgZGVwZW5kZW50cyA9ICQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycgKSB8fCAkKCk7CgoJCSQoIGVsZW0gKS5qcW1EYXRhKCAnZGVwZW5kZW50cycsICQubWVyZ2UoIGRlcGVuZGVudHMsIG5ld0RlcGVuZGVudHMgKSApOwoJfTsKCgkvLyBub3RlIHRoYXQgdGhpcyBoZWxwZXIgZG9lc24ndCBhdHRlbXB0IHRvIGhhbmRsZSB0aGUgY2FsbGJhY2sKCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50cyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCggdGhpcyApLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IHYxLjkuMC1iZXRhLjEKICoKICogQ29weXJpZ2h0IDIwMTIsIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LXVpL2Jsb2IvMS45LjAtYmV0YS4xL0FVVEhPUlMudHh0IChodHRwOi8vanF1ZXJ5dWkuY29tL2Fib3V0KQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgb3IgR1BMIFZlcnNpb24gMiBsaWNlbnNlcy4KICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1VJL1dpZGdldAogKi8KKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgdXVpZCA9IDAsCglzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZSwKCV9jbGVhbkRhdGEgPSAkLmNsZWFuRGF0YTsKJC5jbGVhbkRhdGEgPSBmdW5jdGlvbiggZWxlbXMgKSB7Cglmb3IgKCB2YXIgaSA9IDAsIGVsZW07IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQl0cnkgewoJCQkkKCBlbGVtICkudHJpZ2dlckhhbmRsZXIoICJyZW1vdmUiICk7CgkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvODIzNQoJCX0gY2F0Y2goIGUgKSB7fQoJfQoJX2NsZWFuRGF0YSggZWxlbXMgKTsKfTsKCiQud2lkZ2V0ID0gZnVuY3Rpb24oIG5hbWUsIGJhc2UsIHByb3RvdHlwZSApIHsKCXZhciBmdWxsTmFtZSwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgY29uc3RydWN0b3IsIGJhc2VQcm90b3R5cGUsCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lIF0gPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGZ1bGxOYW1lICk7Cgl9OwoKCSRbIG5hbWVzcGFjZSBdID0gJFsgbmFtZXNwYWNlIF0gfHwge307CglleGlzdGluZ0NvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXTsKCWNvbnN0cnVjdG9yID0gJFsgbmFtZXNwYWNlIF1bIG5hbWUgXSA9IGZ1bmN0aW9uKCBvcHRpb25zLCBlbGVtZW50ICkgewoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCAibmV3IiBrZXl3b3JkCgkJaWYgKCAhdGhpcy5fY3JlYXRlV2lkZ2V0ICkgewoJCQlyZXR1cm4gbmV3IGNvbnN0cnVjdG9yKCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgaW5pdGlhbGl6aW5nIGZvciBzaW1wbGUgaW5oZXJpdGFuY2UKCQkvLyBtdXN0IHVzZSAibmV3IiBrZXl3b3JkICh0aGUgY29kZSBhYm92ZSBhbHdheXMgcGFzc2VzIGFyZ3MpCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQl0aGlzLl9jcmVhdGVXaWRnZXQoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9Cgl9OwoJLy8gZXh0ZW5kIHdpdGggdGhlIGV4aXN0aW5nIGNvbnN0cnVjdG9yIHRvIGNhcnJ5IG92ZXIgYW55IHN0YXRpYyBwcm9wZXJ0aWVzCgkkLmV4dGVuZCggY29uc3RydWN0b3IsIGV4aXN0aW5nQ29uc3RydWN0b3IsIHsKCQl2ZXJzaW9uOiBwcm90b3R5cGUudmVyc2lvbiwKCQkvLyBjb3B5IHRoZSBvYmplY3QgdXNlZCB0byBjcmVhdGUgdGhlIHByb3RvdHlwZSBpbiBjYXNlIHdlIG5lZWQgdG8KCQkvLyByZWRlZmluZSB0aGUgd2lkZ2V0IGxhdGVyCgkJX3Byb3RvOiAkLmV4dGVuZCgge30sIHByb3RvdHlwZSApLAoJCS8vIHRyYWNrIHdpZGdldHMgdGhhdCBpbmhlcml0IGZyb20gdGhpcyB3aWRnZXQgaW4gY2FzZSB0aGlzIHdpZGdldCBpcwoJCS8vIHJlZGVmaW5lZCBhZnRlciBhIHdpZGdldCBpbmhlcml0cyBmcm9tIGl0CgkJX2NoaWxkQ29uc3RydWN0b3JzOiBbXQoJfSk7CgoJYmFzZVByb3RvdHlwZSA9IG5ldyBiYXNlKCk7CgkvLyB3ZSBuZWVkIHRvIG1ha2UgdGhlIG9wdGlvbnMgaGFzaCBhIHByb3BlcnR5IGRpcmVjdGx5IG9uIHRoZSBuZXcgaW5zdGFuY2UKCS8vIG90aGVyd2lzZSB3ZSdsbCBtb2RpZnkgdGhlIG9wdGlvbnMgaGFzaCBvbiB0aGUgcHJvdG90eXBlIHRoYXQgd2UncmUKCS8vIGluaGVyaXRpbmcgZnJvbQoJYmFzZVByb3RvdHlwZS5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgYmFzZVByb3RvdHlwZS5vcHRpb25zICk7CgkkLmVhY2goIHByb3RvdHlwZSwgZnVuY3Rpb24oIHByb3AsIHZhbHVlICkgewoJCWlmICggJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm90b3R5cGVbIHByb3AgXSA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJCX0sCgkJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQkJcmV0dXJuIGJhc2UucHJvdG90eXBlWyBwcm9wIF0uYXBwbHkoIHRoaXMsIGFyZ3MgKTsKCQkJCQl9OwoJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBfX3N1cGVyID0gdGhpcy5fc3VwZXIsCgkJCQkJCV9fc3VwZXJBcHBseSA9IHRoaXMuX3N1cGVyQXBwbHksCgkJCQkJCXJldHVyblZhbHVlOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9zdXBlcjsKCQkJCQl0aGlzLl9zdXBlckFwcGx5ID0gX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCQl0aGlzLl9zdXBlciA9IF9fc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9fc3VwZXJBcHBseTsKCgkJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQkJfTsKCQkJfSkoKTsKCQl9Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogbmFtZQoJfSwgcHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJLy8gVE9ETyByZW1vdmUgd2lkZ2V0QmFzZUNsYXNzLCBzZWUgIzgxNTUKCQl3aWRnZXRCYXNlQ2xhc3M6IGZ1bGxOYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKfTsKCiQud2lkZ2V0LmV4dGVuZCA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7Cgl2YXIgaW5wdXQgPSBzbGljZS5jYWxsKCBhcmd1bWVudHMsIDEgKSwKCQlpbnB1dEluZGV4ID0gMCwKCQlpbnB1dExlbmd0aCA9IGlucHV0Lmxlbmd0aCwKCQlrZXksCgkJdmFsdWU7Cglmb3IgKCA7IGlucHV0SW5kZXggPCBpbnB1dExlbmd0aDsgaW5wdXRJbmRleCsrICkgewoJCWZvciAoIGtleSBpbiBpbnB1dFsgaW5wdXRJbmRleCBdICkgewoJCQl2YWx1ZSA9IGlucHV0WyBpbnB1dEluZGV4IF1bIGtleSBdOwoJCQlpZiAoaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgPyAkLndpZGdldC5leHRlbmQoIHt9LCB0YXJnZXRbIGtleSBdLCB2YWx1ZSApIDogdmFsdWU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gdGFyZ2V0Owp9OwoKJC53aWRnZXQuYnJpZGdlID0gZnVuY3Rpb24oIG5hbWUsIG9iamVjdCApIHsKCXZhciBmdWxsTmFtZSA9IG9iamVjdC5wcm90b3R5cGUud2lkZ2V0RnVsbE5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQluZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0TmFtZSwgdGhpcyApOwoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oeyByZW1vdmU6ICJkZXN0cm95IiB9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkvLyAxLjkgQkMgZm9yICM3ODEwCgkJCS8vIFRPRE8gcmVtb3ZlIGR1YWwgc3RvcmFnZQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXROYW1lICkKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKQoJCQkvLyBzdXBwb3J0OiBqcXVlcnkgPDEuNi4zCgkJCS8vIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0Lzk0MTMKCQkJLnJlbW92ZURhdGEoICQuY2FtZWxDYXNlKCB0aGlzLndpZGdldEZ1bGxOYW1lICkgKTsKCQl0aGlzLndpZGdldCgpCgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlQXR0ciggImFyaWEtZGlzYWJsZWQiICkKCQkJLnJlbW92ZUNsYXNzKAoJCQkJdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgIiArCgkJCQkidWktc3RhdGUtZGlzYWJsZWQiICk7CgoJCS8vIGNsZWFuIHVwIGV2ZW50cyBhbmQgc3RhdGVzCgkJdGhpcy5iaW5kaW5ncy51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKTsKCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7Cgl9LAoJX2Rlc3Ryb3k6ICQubm9vcCwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCW9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdmFyIG9wdGlvbnMgPSBrZXksCgkJCXBhcnRzLAoJCQljdXJPcHRpb24sCgkJCWk7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMCApIHsKCQkJLy8gZG9uJ3QgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnRlcm5hbCBoYXNoCgkJCXJldHVybiAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMgKTsKCQl9CgoJCWlmICggdHlwZW9mIGtleSA9PT0gInN0cmluZyIgKSB7CgkJCS8vIGhhbmRsZSBuZXN0ZWQga2V5cywgZS5nLiwgImZvby5iYXIiID0+IHsgZm9vOiB7IGJhcjogX19fIH0gfQoJCQlvcHRpb25zID0ge307CgkJCXBhcnRzID0ga2V5LnNwbGl0KCAiLiIgKTsKCQkJa2V5ID0gcGFydHMuc2hpZnQoKTsKCQkJaWYgKCBwYXJ0cy5sZW5ndGggKSB7CgkJCQljdXJPcHRpb24gPSBvcHRpb25zWyBrZXkgXSA9ICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9uc1sga2V5IF0gKTsKCQkJCWZvciAoIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoIC0gMTsgaSsrICkgewoJCQkJCWN1ck9wdGlvblsgcGFydHNbIGkgXSBdID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gfHwge307CgkJCQkJY3VyT3B0aW9uID0gY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF07CgkJCQl9CgkJCQlrZXkgPSBwYXJ0cy5wb3AoKTsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gY3VyT3B0aW9uWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IGN1ck9wdGlvblsga2V5IF07CgkJCQl9CgkJCQljdXJPcHRpb25bIGtleSBdID0gdmFsdWU7CgkJCX0gZWxzZSB7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIHRoaXMub3B0aW9uc1sga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiB0aGlzLm9wdGlvbnNbIGtleSBdOwoJCQkJfQoJCQkJb3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCQkJfQoJCX0KCgkJdGhpcy5fc2V0T3B0aW9ucyggb3B0aW9ucyApOwoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGtleTsKCgkJZm9yICgga2V5IGluIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3NldE9wdGlvbigga2V5LCBvcHRpb25zWyBrZXkgXSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJdGhpcy5vcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJdGhpcy53aWRnZXQoKQoJCQkJLnRvZ2dsZUNsYXNzKCB0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCB1aS1zdGF0ZS1kaXNhYmxlZCIsICEhdmFsdWUgKQoJCQkJLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCQkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglfb246IGZ1bmN0aW9uKCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQkvLyBubyBlbGVtZW50IGFyZ3VtZW50LCBzaHVmZmxlIGFuZCB1c2UgdGhpcy5lbGVtZW50CgkJaWYgKCAhaGFuZGxlcnMgKSB7CgkJCWhhbmRsZXJzID0gZWxlbWVudDsKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKCQl9IGVsc2UgewoJCQkvLyBhY2NlcHQgc2VsZWN0b3JzLCBET00gZWxlbWVudHMKCQkJZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQkJdGhpcy5iaW5kaW5ncyA9IHRoaXMuYmluZGluZ3MuYWRkKCBlbGVtZW50ICk7CgkJfQoKCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCSQuZWFjaCggaGFuZGxlcnMsIGZ1bmN0aW9uKCBldmVudCwgaGFuZGxlciApIHsKCQkJZnVuY3Rpb24gaGFuZGxlclByb3h5KCkgewoJCQkJLy8gYWxsb3cgd2lkZ2V0cyB0byBjdXN0b21pemUgdGhlIGRpc2FibGVkIGhhbmRsaW5nCgkJCQkvLyAtIGRpc2FibGVkIGFzIGFuIGFycmF5IGluc3RlYWQgb2YgYm9vbGVhbgoJCQkJLy8gLSBkaXNhYmxlZCBjbGFzcyBhcyBtZXRob2QgZm9yIGRpc2FibGluZyBpbmRpdmlkdWFsIHBhcnRzCgkJCQlpZiAoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJJCggdGhpcyApLmhhc0NsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlpbnN0YW5jZS53aWRnZXQoKS5kZWxlZ2F0ZSggc2VsZWN0b3IsIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0gZWxzZSB7CgkJCQllbGVtZW50LmJpbmQoIGV2ZW50TmFtZSwgaGFuZGxlclByb3h5ICk7CgkJCX0KCQl9KTsKCX0sCgoJX29mZjogZnVuY3Rpb24oIGVsZW1lbnQsIGV2ZW50TmFtZSApIHsKCQlldmVudE5hbWUgPSAoZXZlbnROYW1lIHx8ICIiKS5zcGxpdCggIiAiICkuam9pbiggdGhpcy5ldmVudE5hbWVzcGFjZSArICIgIiApICsgdGhpcy5ldmVudE5hbWVzcGFjZTsKCQllbGVtZW50LnVuYmluZCggZXZlbnROYW1lICkudW5kZWxlZ2F0ZSggZXZlbnROYW1lICk7Cgl9LAoKCV9kZWxheTogZnVuY3Rpb24oIGhhbmRsZXIsIGRlbGF5ICkgewoJCWZ1bmN0aW9uIGhhbmRsZXJQcm94eSgpIHsKCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJLmFwcGx5KCBpbnN0YW5jZSwgYXJndW1lbnRzICk7CgkJfQoJCXZhciBpbnN0YW5jZSA9IHRoaXM7CgkJcmV0dXJuIHNldFRpbWVvdXQoIGhhbmRsZXJQcm94eSwgZGVsYXkgfHwgMCApOwoJfSwKCglfaG92ZXJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmhvdmVyYWJsZSA9IHRoaXMuaG92ZXJhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCW1vdXNlZW50ZXI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl9LAoJCQltb3VzZWxlYXZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfQoJCX0pOwoJfSwKCglfZm9jdXNhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl0aGlzLmZvY3VzYWJsZSA9IHRoaXMuZm9jdXNhYmxlLmFkZCggZWxlbWVudCApOwoJCXRoaXMuX29uKCBlbGVtZW50LCB7CgkJCWZvY3VzaW46IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5hZGRDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9LAoJCQlmb2N1c291dDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJCX0KCQl9KTsKCX0sCgoJX3RyaWdnZXI6IGZ1bmN0aW9uKCB0eXBlLCBldmVudCwgZGF0YSApIHsKCQl2YXIgcHJvcCwgb3JpZywKCQkJY2FsbGJhY2sgPSB0aGlzLm9wdGlvbnNbIHR5cGUgXTsKCgkJZGF0YSA9IGRhdGEgfHwge307CgkJZXZlbnQgPSAkLkV2ZW50KCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSAoIHR5cGUgPT09IHRoaXMud2lkZ2V0RXZlbnRQcmVmaXggPwoJCQl0eXBlIDoKCQkJdGhpcy53aWRnZXRFdmVudFByZWZpeCArIHR5cGUgKS50b0xvd2VyQ2FzZSgpOwoJCS8vIHRoZSBvcmlnaW5hbCBldmVudCBtYXkgY29tZSBmcm9tIGFueSBlbGVtZW50CgkJLy8gc28gd2UgbmVlZCB0byByZXNldCB0aGUgdGFyZ2V0IG9uIHRoZSBuZXcgZXZlbnQKCQlldmVudC50YXJnZXQgPSB0aGlzLmVsZW1lbnRbIDAgXTsKCgkJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJCW9yaWcgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJCWlmICggb3JpZyApIHsKCQkJZm9yICggcHJvcCBpbiBvcmlnICkgewoJCQkJaWYgKCAhKCBwcm9wIGluIGV2ZW50ICkgKSB7CgkJCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdbIHByb3AgXTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoIGV2ZW50LCBkYXRhICk7CgkJcmV0dXJuICEoICQuaXNGdW5jdGlvbiggY2FsbGJhY2sgKSAmJgoJCQljYWxsYmFjay5hcHBseSggdGhpcy5lbGVtZW50WzBdLCBbIGV2ZW50IF0uY29uY2F0KCBkYXRhICkgKSA9PT0gZmFsc2UgfHwKCQkJZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKTsKCX0KfTsKCiQuZWFjaCggeyBzaG93OiAiZmFkZUluIiwgaGlkZTogImZhZGVPdXQiIH0sIGZ1bmN0aW9uKCBtZXRob2QsIGRlZmF1bHRFZmZlY3QgKSB7CgkkLldpZGdldC5wcm90b3R5cGVbICJfIiArIG1ldGhvZCBdID0gZnVuY3Rpb24oIGVsZW1lbnQsIG9wdGlvbnMsIGNhbGxiYWNrICkgewoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciICkgewoJCQlvcHRpb25zID0geyBlZmZlY3Q6IG9wdGlvbnMgfTsKCQl9CgkJdmFyIGhhc09wdGlvbnMsCgkJCWVmZmVjdE5hbWUgPSAhb3B0aW9ucyA/CgkJCQltZXRob2QgOgoJCQkJb3B0aW9ucyA9PT0gdHJ1ZSB8fCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgPwoJCQkJCWRlZmF1bHRFZmZlY3QgOgoJCQkJCW9wdGlvbnMuZWZmZWN0IHx8IGRlZmF1bHRFZmZlY3Q7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJaWYgKCB0eXBlb2Ygb3B0aW9ucyA9PT0gIm51bWJlciIgKSB7CgkJCW9wdGlvbnMgPSB7IGR1cmF0aW9uOiBvcHRpb25zIH07CgkJfQoJCWhhc09wdGlvbnMgPSAhJC5pc0VtcHR5T2JqZWN0KCBvcHRpb25zICk7CgkJb3B0aW9ucy5jb21wbGV0ZSA9IGNhbGxiYWNrOwoJCWlmICggb3B0aW9ucy5kZWxheSApIHsKCQkJZWxlbWVudC5kZWxheSggb3B0aW9ucy5kZWxheSApOwoJCX0KCQlpZiAoIGhhc09wdGlvbnMgJiYgJC5lZmZlY3RzICYmICggJC5lZmZlY3RzLmVmZmVjdFsgZWZmZWN0TmFtZSBdIHx8ICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSAmJiAkLmVmZmVjdHNbIGVmZmVjdE5hbWUgXSApICkgewoJCQllbGVtZW50WyBtZXRob2QgXSggb3B0aW9ucyApOwoJCX0gZWxzZSBpZiAoIGVmZmVjdE5hbWUgIT09IG1ldGhvZCAmJiBlbGVtZW50WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIGVmZmVjdE5hbWUgXSggb3B0aW9ucy5kdXJhdGlvbiwgb3B0aW9ucy5lYXNpbmcsIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJZWxlbWVudC5xdWV1ZShmdW5jdGlvbiggbmV4dCApIHsKCQkJCSQoIHRoaXMgKVsgbWV0aG9kIF0oKTsKCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJY2FsbGJhY2suY2FsbCggZWxlbWVudFsgMCBdICk7CgkJCQl9CgkJCQluZXh0KCk7CgkJCX0pOwoJCX0KCX07Cn0pOwoKLy8gREVQUkVDQVRFRAppZiAoICQudWlCYWNrQ29tcGF0ICE9PSBmYWxzZSApIHsKCSQuV2lkZ2V0LnByb3RvdHlwZS5fZ2V0Q3JlYXRlT3B0aW9ucyA9IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkLm1ldGFkYXRhICYmICQubWV0YWRhdGEuZ2V0KCB0aGlzLmVsZW1lbnRbMF0gKVsgdGhpcy53aWRnZXROYW1lIF07Cgl9Owp9Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCB0aGlzLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAkKCB0YXJnZXQgKSksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKSwgc2VsZiA9IHRoaXM7CgoJCS8vIGlmIGlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCB0byB0cnVlIHRoZSBmcmFtZXdvcmsgc2hvdWxkCgkJLy8gb25seSBlbmhhbmNlIHRoZSBzZWxlY3RlZCBlbGVtZW50cyB3aGVuIHRoZXkgZG8gTk9UIGhhdmUgYQoJCS8vIHBhcmVudCB3aXRoIHRoZSBkYXRhLW5hbWVzcGFjZS1pZ25vcmUgYXR0cmlidXRlCgkJJHdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoICR3aWRnZXRFbGVtZW50cyApOwoKCQlpZiAoIHVzZUtlZXBOYXRpdmUgJiYgJHdpZGdldEVsZW1lbnRzLmxlbmd0aCApIHsKCQkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCQkvLyBDdXJyZW50bHkgdGhlIGtlZXBOYXRpdmUgdmFsdWUgaXMgZGVmaW5lZCBvbiB0aGUgcGFnZSBwcm90b3R5cGUgc28KCQkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJCXBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICR3aWRnZXRFbGVtZW50cyApOwoJCQlrZWVwTmF0aXZlID0gKCBwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdzaG93JywgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdoaWRlJyApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQoIHdpbmRvdyApOwoKCSQud2lkZ2V0KCAibW9iaWxlLmxvYWRlciIsIHsKCQkvLyBOT1RFIGlmIHRoZSBnbG9iYWwgY29uZmlnIHNldHRpbmdzIGFyZSBkZWZpbmVkIHRoZXkgd2lsbCBvdmVycmlkZSB0aGVzZQoJCS8vICAgICAgb3B0aW9ucwoJCW9wdGlvbnM6IHsKCQkJLy8gdGhlIHRoZW1lIGZvciB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCXRoZW1lOiAiYSIsCgoJCQkvLyB3aGV0aGVyIHRoZSB0ZXh0IGluIHRoZSBsb2FkaW5nIG1lc3NhZ2UgaXMgc2hvd24KCQkJdGV4dFZpc2libGU6IGZhbHNlLAoKCQkJLy8gY3VzdG9tIGh0bWwgZm9yIHRoZSBpbm5lciBjb250ZW50IG9mIHRoZSBsb2FkaW5nIG1lc3NhZ2UKCQkJaHRtbDogIiIsCgoJCQkvLyB0aGUgdGV4dCB0byBiZSBkaXNwbGF5ZWQgd2hlbiB0aGUgcG9wdXAgaXMgc2hvd24KCQkJdGV4dDogImxvYWRpbmciCgkJfSwKCgkJZGVmYXVsdEh0bWw6ICI8ZGl2IGNsYXNzPSciICsgbG9hZGVyQ2xhc3MgKyAiJz4iICsKCQkJIjxzcGFuIGNsYXNzPSd1aS1pY29uIHVpLWljb24tbG9hZGluZyc+PC9zcGFuPiIgKwoJCQkiPGgxPjwvaDE+IiArCgkJCSI8L2Rpdj4iLAoKCQkvLyBGb3Igbm9uLWZpeGVkIHN1cHBvcnRpbiBicm93c2Vycy4gUG9zaXRpb24gYXQgeSBjZW50ZXIgKGlmIHNjcm9sbFRvcCBzdXBwb3J0ZWQpLCBhYm92ZSB0aGUgYWN0aXZlQnRuIChpZiBkZWZpbmVkKSwgb3IganVzdCAxMDBweCBmcm9tIHRvcAoJCWZha2VGaXhMb2FkZXI6IGZ1bmN0aW9uKCkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5maXJzdCgpOwoKCQkJdGhpcy5lbGVtZW50CgkJCQkuY3NzKHsKCQkJCQl0b3A6ICQuc3VwcG9ydC5zY3JvbGxUb3AgJiYgJHdpbmRvdy5zY3JvbGxUb3AoKSArICR3aW5kb3cuaGVpZ2h0KCkgLyAyIHx8CgkJCQkJCWFjdGl2ZUJ0bi5sZW5ndGggJiYgYWN0aXZlQnRuLm9mZnNldCgpLnRvcCB8fCAxMDAKCQkJCX0pOwoJCX0sCgoJCS8vIGNoZWNrIHBvc2l0aW9uIG9mIGxvYWRlciB0byBzZWUgaWYgaXQgYXBwZWFycyB0byBiZSAiZml4ZWQiIHRvIGNlbnRlcgoJCS8vIGlmIG5vdCwgdXNlIGFicyBwb3NpdGlvbmluZwoJCWNoZWNrTG9hZGVyUG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0ID0gdGhpcy5lbGVtZW50Lm9mZnNldCgpLAoJCQkJc2Nyb2xsVG9wID0gJHdpbmRvdy5zY3JvbGxUb3AoKSwKCQkJCXNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJaWYgKCBvZmZzZXQudG9wIDwgc2Nyb2xsVG9wIHx8ICggb2Zmc2V0LnRvcCAtIHNjcm9sbFRvcCApID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktbG9hZGVyLWZha2VmaXgiICk7CgkJCQl0aGlzLmZha2VGaXhMb2FkZXIoKTsKCQkJCSR3aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsICRoZWFkZXIsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUodGhlbWUpID09PSAib2JqZWN0IiApIHsKCQkJCWxvYWRTZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCB0aGVtZSApOwoKCQkJCS8vIHByZWZlciBvYmplY3QgcHJvcGVydHkgZnJvbSB0aGUgcGFyYW0gdGhlbiB0aGUgb2xkIHRoZW1lIHNldHRpbmcKCQkJCXRoZW1lID0gbG9hZFNldHRpbmdzLnRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW0gdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUgfHwgbG9hZFNldHRpbmdzLnRoZW1lOwoJCQl9CgoJCQkvLyBzZXQgdGhlIG1lc3NhZ2UgdGV4dCwgcHJlZmVyIHRoZSBwYXJhbSwgdGhlbiB0aGUgc2V0dGluZ3Mgb2JqZWN0CgkJCS8vIHRoZW4gbG9hZGluZyBtZXNzYWdlCgkJCW1lc3NhZ2UgPSBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIHx8IGxvYWRTZXR0aW5ncy50ZXh0OwoKCQkJLy8gcHJlcGFyZSB0aGUgZG9tCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgIT09IGZhbHNlIHx8IGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJLy8gYm9vbGVhbiB2YWx1ZXMgcmVxdWlyZSBhIGJpdCBtb3JlIHdvcmsgOlAsIHN1cHBvcnRzIG9iamVjdCBwcm9wZXJ0aWVzCgkJCQkvLyBhbmQgb2xkIHNldHRpbmdzCgkJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0ZXh0VmlzaWJsZSA9ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU7CgkJCQl9IGVsc2UgewoJCQkJCXRleHRWaXNpYmxlID0gbG9hZFNldHRpbmdzLnRleHRWaXNpYmxlOwoJCQkJfQoKCQkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJCS8vIGlmIHRoZSB0ZXh0IHdhcyBleHBsaWNpdGx5IHNldCBpbiB0aGUgb2JqZWN0IGFyZ3MKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJCSIgdWktbG9hZGVyLSIgKyAoIHRleHRWaXNpYmxlIHx8IG1zZ1RleHQgfHwgdGhlbWUudGV4dCA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsKCQkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJCS8vICAgICAgdGhpcyBtaWdodCBiZSBvdmVybHkgZGVmZW5zaXZlIGluIHByZXZlbnRpbmcgdW5rbm93aW5nIHhzcwoJCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQkJaWYgKCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICJoMSIgKS50ZXh0KCBtZXNzYWdlICk7CgkJCQl9CgoJCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJCS8vIG9uIHNjcm9sbCBjaGVjayB0aGUgbG9hZGVyIHBvc2l0aW9uCgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJCggd2luZG93ICkudW5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5mYWtlRml4TG9hZGVyLCB0aGlzKSApOwoJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCX0KCX0pOwoKCSR3aW5kb3cuYmluZCggJ3BhZ2Vjb250YWluZXJjcmVhdGUnLCBmdW5jdGlvbigpIHsKCQkkLm1vYmlsZS5sb2FkZXJXaWRnZXQgPSAkLm1vYmlsZS5sb2FkZXJXaWRnZXQgfHwgJCggJC5tb2JpbGUubG9hZGVyLnByb3RvdHlwZS5kZWZhdWx0SHRtbCApLmxvYWRlcigpOwoJfSk7Cn0pKGpRdWVyeSwgdGhpcyk7CgoKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9ICk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEgKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKSB7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQl2YXIgc3VwcG9ydCA9IHsKCQkJdG91Y2g6ICJvbnRvdWNoZW5kIiBpbiBkb2N1bWVudAoJCX07CgoJCSQubW9iaWxlID0gJC5tb2JpbGUgfHwge307CgkJJC5tb2JpbGUuc3VwcG9ydCA9ICQubW9iaWxlLnN1cHBvcnQgfHwge307CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgc3VwcG9ydCApOwoJCSQuZXh0ZW5kKCAkLm1vYmlsZS5zdXBwb3J0LCBzdXBwb3J0ICk7Cgl9KCBqUXVlcnkgKSk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCS8vIGFkZCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCgl2YXIgc3VwcG9ydFRvdWNoID0gJC5tb2JpbGUuc3VwcG9ydC50b3VjaCwKCQlzY3JvbGxFdmVudCA9ICJ0b3VjaG1vdmUgc2Nyb2xsIiwKCQl0b3VjaFN0YXJ0RXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hzdGFydCIgOiAibW91c2Vkb3duIiwKCQl0b3VjaFN0b3BFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaGVuZCIgOiAibW91c2V1cCIsCgkJdG91Y2hNb3ZlRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2htb3ZlIiA6ICJtb3VzZW1vdmUiOwoKCWZ1bmN0aW9uIHRyaWdnZXJDdXN0b21FdmVudCggb2JqLCBldmVudFR5cGUsIGV2ZW50ICkgewoJCXZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlOwoJCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgkJJC5ldmVudC5oYW5kbGUuY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlzY3JvbGxpbmcsCgkJCQl0aW1lcjsKCgkJCWZ1bmN0aW9uIHRyaWdnZXIoIGV2ZW50LCBzdGF0ZSApIHsKCQkJCXNjcm9sbGluZyA9IHN0YXRlOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBzY3JvbGxpbmcgPyAic2Nyb2xsc3RhcnQiIDogInNjcm9sbHN0b3AiLCBldmVudCApOwoJCQl9CgoJCQkvLyBpUGhvbmUgdHJpZ2dlcnMgc2Nyb2xsIGFmdGVyIGEgc21hbGwgZGVsYXk7IHVzZSB0b3VjaG1vdmUgaW5zdGVhZAoJCQkkdGhpcy5iaW5kKCBzY3JvbGxFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCWlmICggISQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoICFzY3JvbGxpbmcgKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIHRydWUgKTsKCQkJCX0KCgkJCQljbGVhclRpbWVvdXQoIHRpbWVyICk7CgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCBmYWxzZSApOwoJCQkJfSwgNTAgKTsKCQkJfSk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgdGFwaG9sZAoJJC5ldmVudC5zcGVjaWFsLnRhcCA9IHsKCQl0YXBob2xkVGhyZXNob2xkOiA3NTAsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQlvcmlnRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50LAoJCQkJCXRpbWVyOwoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwVGltZXIoKSB7CgkJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJfQoKCQkJCWZ1bmN0aW9uIGNsZWFyVGFwSGFuZGxlcnMoKSB7CgkJCQkJY2xlYXJUYXBUaW1lcigpOwoKCQkJCQkkdGhpcy51bmJpbmQoICJ2Y2xpY2siLCBjbGlja0hhbmRsZXIgKQoJCQkJCQkudW5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICk7CgkJCQkJJCggZG9jdW1lbnQgKS51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsICJ0YXBob2xkIiwgJC5FdmVudCggInRhcGhvbGQiLCB7IHRhcmdldDogb3JpZ1RhcmdldCB9ICkgKTsKCQkJCX0sICQuZXZlbnQuc3BlY2lhbC50YXAudGFwaG9sZFRocmVzaG9sZCApOwoJCQl9KTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyBzd2lwZWxlZnQsIHN3aXBlcmlnaHQKCSQuZXZlbnQuc3BlY2lhbC5zd2lwZSA9IHsKCQlzY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkOiAzMCwgLy8gTW9yZSB0aGFuIHRoaXMgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQsIGFuZCB3ZSB3aWxsIHN1cHByZXNzIHNjcm9sbGluZy4KCgkJZHVyYXRpb25UaHJlc2hvbGQ6IDEwMDAsIC8vIE1vcmUgdGltZSB0aGFuIHRoaXMsIGFuZCBpdCBpc24ndCBhIHN3aXBlLgoKCQlob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQ6IDMwLCAgLy8gU3dpcGUgaG9yaXpvbnRhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBtb3JlIHRoYW4gdGhpcy4KCgkJdmVydGljYWxEaXN0YW5jZVRocmVzaG9sZDogNzUsICAvLyBTd2lwZSB2ZXJ0aWNhbCBkaXNwbGFjZW1lbnQgbXVzdCBiZSBsZXNzIHRoYW4gdGhpcy4KCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50LAoJCQkJCXN0YXJ0ID0gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9LAoJCQkJCXN0b3A7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoKCQkJCQlzdG9wID0gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0KCQkJCQl9OwoKCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQkJJHRoaXMudW5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKTsKCgkJCQkJCWlmICggc3RhcnQgJiYgc3RvcCApIHsKCQkJCQkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJCQkJCU1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5ob3Jpem9udGFsRGlzdGFuY2VUaHJlc2hvbGQgJiYKCQkJCQkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCgkJCQkJCQkJc3RhcnQub3JpZ2luLnRyaWdnZXIoICJzd2lwZSIgKQoJCQkJCQkJCQkudHJpZ2dlciggc3RhcnQuY29vcmRzWzBdID4gc3RvcC5jb29yZHNbIDAgXSA/ICJzd2lwZWxlZnQiIDogInN3aXBlcmlnaHQiICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJc3RhcnQgPSBzdG9wID0gdW5kZWZpbmVkOwoJCQkJCX0pOwoJCQl9KTsKCQl9Cgl9OwoJJC5lYWNoKHsKCQlzY3JvbGxzdG9wOiAic2Nyb2xsc3RhcnQiLAoJCXRhcGhvbGQ6ICJ0YXAiLAoJCXN3aXBlbGVmdDogInN3aXBlIiwKCQlzd2lwZXJpZ2h0OiAic3dpcGUiCgl9LCBmdW5jdGlvbiggZXZlbnQsIHNvdXJjZUV2ZW50ICkgewoKCQkkLmV2ZW50LnNwZWNpYWxbIGV2ZW50IF0gPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCBzb3VyY2VFdmVudCwgJC5ub29wICk7CgkJCX0KCQl9OwoJfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgewoJCQlvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdwoJCX0pOwoJfSggalF1ZXJ5ICkpOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCXNwZWNpYWxfZXZlbnQsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9OwoKCS8vIEl0IHNlZW1zIHRoYXQgc29tZSBkZXZpY2UvYnJvd3NlciB2ZW5kb3JzIHVzZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWVzIDAgYW5kIDE4MCB0bwoJLy8gZGVub3RlIHRoZSAiZGVmYXVsdCIgb3JpZW50YXRpb24uIEZvciBpT1MgZGV2aWNlcywgYW5kIG1vc3Qgb3RoZXIgc21hcnQtcGhvbmVzIHRlc3RlZCwKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzIGFsd2F5cyAicG9ydHJhaXQiLCBidXQgaW4gc29tZSBBbmRyb2lkIGFuZCBSSU0gYmFzZWQgdGFibGV0cywKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzICJsYW5kc2NhcGUiLiBUaGUgZm9sbG93aW5nIGNvZGUgYXR0ZW1wdHMgdG8gdXNlIHRoZSB3aW5kb3cKCS8vIGRpbWVuc2lvbnMgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIGlzLCBhbmQgdGhlbiBtYWtlcyBhZGp1c3RtZW50cwoJLy8gdG8gdGhlIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseSBkZWNvZGUgdGhlCgkvLyB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJLy8KCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgb3JpZW50YXRpb24gdGhlIGJyb3dzZXIKCS8vIHRoaW5rcyBpdCBpcyBpbjoKCS8vCgkvLyAgICAgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSAkLm1vYmlsZS5tZWRpYSgiYWxsIGFuZCAob3JpZW50YXRpb246IGxhbmRzY2FwZSkiKTsKCS8vCgkvLyBidXQgdGhlcmUgd2FzIGFuIGlQaG9uZS9pUG9kIFRvdWNoIGJ1ZyBiZWdpbm5pbmcgd2l0aCBpT1MgNC4yLCB1cCB0aHJvdWdoIGlPUyA1LjEsCgkvLyB3aGVyZSB0aGUgYnJvd3NlciAqQUxXQVlTKiBhcHBsaWVkIHRoZSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkuIFRoaXMgYnVnIGRvZXMgbm90CgkvLyBoYXBwZW4gb24gaVBhZC4KCglpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCgkJLy8gQ2hlY2sgdGhlIHdpbmRvdyB3aWR0aCBhbmQgaGVpZ2h0IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbgoJCS8vIG9mIHRoZSBkZXZpY2UgaXMgYXQgdGhpcyBtb21lbnQuIE5vdGUgdGhhdCB3ZSd2ZSBpbml0aWFsaXplZCB0aGUgcG9ydHJhaXQgbWFwCgkJLy8gdmFsdWVzIHRvIDAgYW5kIDE4MCwgKkFORCogd2UgcHVycG9zZWx5IGNoZWNrIGZvciBsYW5kc2NhcGUgc28gdGhhdCBpZiB3ZSBndWVzcwoJCS8vIHdyb25nLCAsIHdlIGRlZmF1bHQgdG8gdGhlIGFzc3VtcHRpb24gdGhhdCBwb3J0cmFpdCBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbi4KCQkvLyBXZSB1c2UgYSB0aHJlc2hvbGQgY2hlY2sgYmVsb3cgYmVjYXVzZSBvbiBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUywgdGhlIGlQaG9uZQoJCS8vIGZvcm0tZmFjdG9yIGNhbiByZXBvcnQgYSBsYXJnZXIgd2lkdGggdGhhbiBoZWlnaHQgaWYgdGhlIHVzZXIgdHVybnMgb24gdGhlCgkJLy8gZGV2ZWxvcGVyIGNvbnNvbGUuIFRoZSBhY3R1YWwgdGhyZXNob2xkIHZhbHVlIGlzIHNvbWV3aGF0IGFyYml0cmFyeSwgd2UganVzdAoJCS8vIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGlzIGxhcmdlIGVub3VnaCB0byBleGNsdWRlIHRoZSBkZXZlbG9wZXIgY29uc29sZSBjYXNlLgoKCQl2YXIgd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkKCB3aW5kb3cgKS53aWR0aCgpLAoJCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCAkKCB3aW5kb3cgKS5oZWlnaHQoKSwKCQkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCgkJLy8gTm93IGNoZWNrIHRvIHNlZSBpZiB0aGUgY3VycmVudCB3aW5kb3cub3JpZW50YXRpb24gaXMgMCBvciAxODAuCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCgkJLy8gSWYgdGhlIGluaXRpYWwgb3JpZW50YXRpb24gaXMgbGFuZHNjYXBlLCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgMCBvciAxODAsICpPUioKCQkvLyBpZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBwb3J0cmFpdCwgYnV0IHdpbmRvdy5vcmllbnRhdGlvbiByZXBvcnRzIDkwIG9yIC05MCwgd2UKCQkvLyBuZWVkIHRvIGZsaXAgb3VyIHBvcnRyYWl0X21hcCB2YWx1ZXMgYmVjYXVzZSBsYW5kc2NhcGUgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24gZm9yCgkJLy8gdGhpcyBkZXZpY2UvYnJvd3Nlci4KCQlpZiAoICggaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgfHwgKCAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgJiYgIWluaXRpYWxfb3JpZW50YXRpb25faXNfZGVmYXVsdCApICkgewoJCQlwb3J0cmFpdF9tYXAgPSB7ICItOTAiOiB0cnVlLCAiOTAiOiB0cnVlIH07CgkJfQoJfQoKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZSA9ICQuZXh0ZW5kKCB7fSwgJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLCB7CgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkvLyBJZiB0aGUgZXZlbnQgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdCBqUXVlcnkKCQkJLy8gd2lsbCBiaW5kIHRvIHRoZSBldmVudCB1c2luZyBET00gbWV0aG9kcy4KCQkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gJiYgISQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5kaXNhYmxlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIHRvIGF2b2lkIGluaXRpYWwgZG91YmxlLXRyaWdnZXJpbmcuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHNpbXVsYXRlIHRoZQoJCQkvLyBldmVudCBieSB0ZXN0aW5nIHdpbmRvdyBkaW1lbnNpb25zIG9uIHJlc2l6ZS4KCQkJd2luLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCByZXR1cm4gZmFsc2Ugc28gdGhhdAoJCQkvLyBqUXVlcnkgd2lsbCB1bmJpbmQgdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBCZWNhdXNlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkb2Vzbid0IGV4aXN0LCB1bmJpbmQgdGhlCgkJCS8vIHJlc2l6ZSBldmVudCBoYW5kbGVyLgoJCQl3aW4udW5iaW5kKCAidGhyb3R0bGVkcmVzaXplIiwgaGFuZGxlciApOwoJCX0sCgkJYWRkOiBmdW5jdGlvbiggaGFuZGxlT2JqICkgewoJCQkvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBib3VuZCBldmVudCBoYW5kbGVyLgoJCQl2YXIgb2xkX2hhbmRsZXIgPSBoYW5kbGVPYmouaGFuZGxlcjsKCgoJCQloYW5kbGVPYmouaGFuZGxlciA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIE1vZGlmeSBldmVudCBvYmplY3QsIGFkZGluZyB0aGUgLm9yaWVudGF0aW9uIHByb3BlcnR5LgoJCQkJZXZlbnQub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJCQkvLyBDYWxsIHRoZSBvcmlnaW5hbGx5LWJvdW5kIGV2ZW50IGhhbmRsZXIgYW5kIHJldHVybiBpdHMgcmVzdWx0LgoJCQkJcmV0dXJuIG9sZF9oYW5kbGVyLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfTsKCQl9Cgl9KTsKCgkvLyBJZiB0aGUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBuYXRpdmVseSwgdGhpcyBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8KCS8vIHRoZSB3aW5kb3cgcmVzaXplIGV2ZW50IHRvIHNpbXVsYXRlIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCWZ1bmN0aW9uIGhhbmRsZXIoKSB7CgkJLy8gR2V0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uLgoJCXZhciBvcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQlpZiAoIG9yaWVudGF0aW9uICE9PSBsYXN0X29yaWVudGF0aW9uICkgewoJCQkvLyBUaGUgb3JpZW50YXRpb24gaGFzIGNoYW5nZWQsIHNvIHRyaWdnZXIgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJCQlsYXN0X29yaWVudGF0aW9uID0gb3JpZW50YXRpb247CgkJCXdpbi50cmlnZ2VyKCBldmVudF9uYW1lICk7CgkJfQoJfQoKCS8vIEdldCB0aGUgY3VycmVudCBwYWdlIG9yaWVudGF0aW9uLiBUaGlzIG1ldGhvZCBpcyBleHBvc2VkIHB1YmxpY2x5LCBzaG91bGQgaXQKCS8vIGJlIG5lZWRlZCwgYXMgalF1ZXJ5LmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24oKQoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uID0gZnVuY3Rpb24oKSB7CgkJdmFyIGlzUG9ydHJhaXQgPSB0cnVlLCBlbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwoKCQkvLyBwcmVmZXIgd2luZG93IG9yaWVudGF0aW9uIHRvIHRoZSBjYWxjdWxhdGlvbiBiYXNlZCBvbiBzY3JlZW5zaXplIGFzCgkJLy8gdGhlIGFjdHVhbCBzY3JlZW4gcmVzaXplIHRha2VzIHBsYWNlIGJlZm9yZSBvciBhZnRlciB0aGUgb3JpZW50YXRpb24gY2hhbmdlIGV2ZW50CgkJLy8gaGFzIGJlZW4gZmlyZWQgZGVwZW5kaW5nIG9uIGltcGxlbWVudGF0aW9uIChlZyBhbmRyb2lkIDIuMyBpcyBiZWZvcmUsIGlwaG9uZSBhZnRlcikuCgkJLy8gTW9yZSB0ZXN0aW5nIGlzIHJlcXVpcmVkIHRvIGRldGVybWluZSBpZiBhIG1vcmUgcmVsaWFibGUgbWV0aG9kIG9mIGRldGVybWluaW5nIHRoZSBuZXcgc2NyZWVuc2l6ZQoJCS8vIGlzIHBvc3NpYmxlIHdoZW4gb3JpZW50YXRpb25jaGFuZ2UgaXMgZmlyZWQuIChlZywgdXNlIG1lZGlhIHF1ZXJpZXMgKyBlbGVtZW50ICsgb3BhY2l0eSkKCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCQkJLy8gaWYgdGhlIHdpbmRvdyBvcmllbnRhdGlvbiByZWdpc3RlcnMgYXMgMCBvciAxODAgZGVncmVlcyByZXBvcnQKCQkJLy8gcG9ydHJhaXQsIG90aGVyd2lzZSBsYW5kc2NhcGUKCQkJaXNQb3J0cmFpdCA9IHBvcnRyYWl0X21hcFsgd2luZG93Lm9yaWVudGF0aW9uIF07CgkJfSBlbHNlIHsKCQkJaXNQb3J0cmFpdCA9IGVsZW0gJiYgZWxlbS5jbGllbnRXaWR0aCAvIGVsZW0uY2xpZW50SGVpZ2h0IDwgMS4xOwoJCX0KCgkJcmV0dXJuIGlzUG9ydHJhaXQgPyAicG9ydHJhaXQiIDogImxhbmRzY2FwZSI7Cgl9OwoKCSQuZm5bIGV2ZW50X25hbWUgXSA9IGZ1bmN0aW9uKCBmbiApIHsKCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIGV2ZW50X25hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCX07CgoJLy8galF1ZXJ5IDwgMS44CglpZiAoICQuYXR0ckZuICkgewoJCSQuYXR0ckZuWyBldmVudF9uYW1lIF0gPSB0cnVlOwoJfQoKfSggalF1ZXJ5LCB0aGlzICkpOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCSRodG1sID0gJCggImh0bWwiICk7CgovKiAkLm1vYmlsZS5tZWRpYSBtZXRob2Q6IHBhc3MgYSBDU1MgbWVkaWEgdHlwZSBvciBxdWVyeSBhbmQgZ2V0IGEgYm9vbCByZXR1cm4KCW5vdGU6IHRoaXMgZmVhdHVyZSByZWxpZXMgb24gYWN0dWFsIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgZm9yIG1lZGlhIHF1ZXJpZXMsIHRob3VnaCB0eXBlcyB3aWxsIHdvcmsgbW9zdCBhbnl3aGVyZQoJZXhhbXBsZXM6CgkJJC5tb2JpbGUubWVkaWEoJ3NjcmVlbicpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZQoJCSQubW9iaWxlLm1lZGlhKCdzY3JlZW4gYW5kIChtaW4td2lkdGg6IDQ4MHB4KScpIC8vIHRlc3RzIGZvciBzY3JlZW4gbWVkaWEgdHlwZSB3aXRoIHdpbmRvdyB3aWR0aCA+IDQ4MHB4CgkJJC5tb2JpbGUubWVkaWEoJ0BtZWRpYSBzY3JlZW4gYW5kICgtd2Via2l0LW1pbi1kZXZpY2UtcGl4ZWwtcmF0aW86IDIpJykgLy8gdGVzdHMgZm9yIHdlYmtpdCAyeCBwaXhlbCByYXRpbyAoaVBob25lIDQpCiovCiQubW9iaWxlLm1lZGlhID0gKGZ1bmN0aW9uKCkgewoJLy8gVE9ETzogdXNlIHdpbmRvdy5tYXRjaE1lZGlhIG9uY2UgYXQgbGVhc3Qgb25lIFVBIGltcGxlbWVudHMgaXQKCXZhciBjYWNoZSA9IHt9LAoJCXRlc3REaXYgPSAkKCAiPGRpdiBpZD0nanF1ZXJ5LW1lZGlhdGVzdCc+PC9kaXY+IiApLAoJCWZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5hcHBlbmQoIHRlc3REaXYgKTsKCglyZXR1cm4gZnVuY3Rpb24oIHF1ZXJ5ICkgewoJCWlmICggISggcXVlcnkgaW4gY2FjaGUgKSApIHsKCQkJdmFyIHN0eWxlQmxvY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3R5bGUiICksCgkJCQljc3NydWxlID0gIkBtZWRpYSAiICsgcXVlcnkgKyAiIHsgI2pxdWVyeS1tZWRpYXRlc3QgeyBwb3NpdGlvbjphYnNvbHV0ZTsgfSB9IjsKCgkJCS8vbXVzdCBzZXQgdHlwZSBmb3IgSUUhCgkJCXN0eWxlQmxvY2sudHlwZSA9ICJ0ZXh0L2NzcyI7CgoJCQlpZiAoIHN0eWxlQmxvY2suc3R5bGVTaGVldCApIHsKCQkJCXN0eWxlQmxvY2suc3R5bGVTaGVldC5jc3NUZXh0ID0gY3NzcnVsZTsKCQkJfSBlbHNlIHsKCQkJCXN0eWxlQmxvY2suYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNzc3J1bGUpICk7CgkJCX0KCgkJCSRodG1sLnByZXBlbmQoIGZha2VCb2R5ICkucHJlcGVuZCggc3R5bGVCbG9jayApOwoJCQljYWNoZVsgcXVlcnkgXSA9IHRlc3REaXYuY3NzKCAicG9zaXRpb24iICkgPT09ICJhYnNvbHV0ZSI7CgkJCWZha2VCb2R5LmFkZCggc3R5bGVCbG9jayApLnJlbW92ZSgpOwoJCX0KCQlyZXR1cm4gY2FjaGVbIHF1ZXJ5IF07Cgl9Owp9KSgpOwoKfSkoalF1ZXJ5KTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gdGh4IE1vZGVybml6cgpmdW5jdGlvbiBwcm9wRXhpc3RzKCBwcm9wICkgewoJdmFyIHVjX3Byb3AgPSBwcm9wLmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnN1YnN0ciggMSApLAoJCXByb3BzID0gKCBwcm9wICsgIiAiICsgdmVuZG9ycy5qb2luKCB1Y19wcm9wICsgIiAiICkgKyB1Y19wcm9wICkuc3BsaXQoICIgIiApOwoKCWZvciAoIHZhciB2IGluIHByb3BzICkgewoJCWlmICggZmJDU1NbIHByb3BzWyB2IF0gXSAhPT0gdW5kZWZpbmVkICkgewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9Cn0KCnZhciBmYWtlQm9keSA9ICQoICI8Ym9keT4iICkucHJlcGVuZFRvKCAiaHRtbCIgKSwKCWZiQ1NTID0gZmFrZUJvZHlbIDAgXS5zdHlsZSwKCXZlbmRvcnMgPSBbICJXZWJraXQiLCAiTW96IiwgIk8iIF0sCgl3ZWJvcyA9ICJwYWxtR2V0UmVzb3VyY2UiIGluIHdpbmRvdywgLy9vbmx5IHVzZWQgdG8gcnVsZSBvdXQgc2Nyb2xsVG9wCglvcGVyYSA9IHdpbmRvdy5vcGVyYSwKCW9wZXJhbWluaSA9IHdpbmRvdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3aW5kb3cub3BlcmFtaW5pICkgPT09ICJbb2JqZWN0IE9wZXJhTWluaV0iLAoJYmIgPSB3aW5kb3cuYmxhY2tiZXJyeSAmJiAhcHJvcEV4aXN0cyggIi13ZWJraXQtdHJhbnNmb3JtIiApOyAvL29ubHkgdXNlZCB0byBydWxlIG91dCBib3ggc2hhZG93LCBhcyBpdCdzIGZpbGxlZCBvcGFxdWUgb24gQkIgNSBhbmQgbG93ZXIKCgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnZGl2JyApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXJldHVybiAgIi0iICsgdmVuZC5jaGFyQXQoIDAgKS50b0xvd2VyQ2FzZSgpICsgdmVuZC5zdWJzdHIoIDEgKSArICItIjsKCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyB1YyggcHJvcCApOwoKCQkJZGl2LnNldEF0dHJpYnV0ZSggInN0eWxlIiwgdmVuZF9wcm9wICk7CgoJCQlpZiAoICEhZGl2LnN0eWxlWyBwcm9wU3R5bGUgXSApIHsKCQkJCXJldCA9IHRydWU7CgkJCX0KCQl9LAoJCWNoZWNrX3ZlbmRzID0gY2hlY2tfdmVuZCA/IFsgY2hlY2tfdmVuZCBdIDogdmVuZG9ycywKCQlyZXQ7CgoJZm9yKCB2YXIgaSA9IDA7IGkgPCBjaGVja192ZW5kcy5sZW5ndGg7IGkrKyApIHsKCQljaGVja19zdHlsZSggY2hlY2tfdmVuZHNbaV0gKTsKCX0KCXJldHVybiAhIXJldDsKfQoKLy8gVGhhbmtzIHRvIE1vZGVybml6ciBzcmMgZm9yIHRoaXMgdGVzdCBpZGVhLiBgcGVyc3BlY3RpdmVgIGNoZWNrIGlzIGxpbWl0ZWQgdG8gTW96IHRvIHByZXZlbnQgYSBmYWxzZSBwb3NpdGl2ZSBmb3IgM0QgdHJhbnNmb3JtcyBvbiBBbmRyb2lkLgpmdW5jdGlvbiB0cmFuc2Zvcm0zZFRlc3QoKSB7Cgl2YXIgcHJvcCA9ICJ0cmFuc2Zvcm0tM2QiOwoJcmV0dXJuIHZhbGlkU3R5bGUoICdwZXJzcGVjdGl2ZScsICcxMHB4JywgJ21veicgKSB8fCAkLm1vYmlsZS5tZWRpYSggIigtIiArIHZlbmRvcnMuam9pbiggIi0iICsgcHJvcCArICIpLCgtIiApICsgIi0iICsgcHJvcCArICIpLCgiICsgcHJvcCArICIpIiApOwp9CgovLyBUZXN0IGZvciBkeW5hbWljLXVwZGF0aW5nIGJhc2UgdGFnIHN1cHBvcnQgKCBhbGxvd3MgdXMgdG8gYXZvaWQgaHJlZixzcmMgYXR0ciByZXdyaXRpbmcgKQpmdW5jdGlvbiBiYXNlVGFnVGVzdCgpIHsKCXZhciBmYXV4QmFzZSA9IGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSArICJ1aS1kaXIvIiwKCQliYXNlID0gJCggImhlYWQgYmFzZSIgKSwKCQlmYXV4RWxlID0gbnVsbCwKCQlocmVmID0gIiIsCgkJbGluaywgcmViYXNlOwoKCWlmICggIWJhc2UubGVuZ3RoICkgewoJCWJhc2UgPSBmYXV4RWxlID0gJCggIjxiYXNlPiIsIHsgImhyZWYiOiBmYXV4QmFzZSB9KS5hcHBlbmRUbyggImhlYWQiICk7Cgl9IGVsc2UgewoJCWhyZWYgPSBiYXNlLmF0dHIoICJocmVmIiApOwoJfQoKCWxpbmsgPSAkKCAiPGEgaHJlZj0ndGVzdHVybCcgLz4iICkucHJlcGVuZFRvKCBmYWtlQm9keSApOwoJcmViYXNlID0gbGlua1sgMCBdLmhyZWY7CgliYXNlWyAwIF0uaHJlZiA9IGhyZWYgfHwgbG9jYXRpb24ucGF0aG5hbWU7CgoJaWYgKCBmYXV4RWxlICkgewoJCWZhdXhFbGUucmVtb3ZlKCk7Cgl9CglyZXR1cm4gcmViYXNlLmluZGV4T2YoIGZhdXhCYXNlICkgPT09IDA7Cn0KCi8vIFRoYW5rcyBNb2Rlcm5penIKZnVuY3Rpb24gY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSB7Cgl2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICd4JyApLAoJCWRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwKCQlnZXRDb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUsCgkJc3VwcG9ydHM7CgoJaWYgKCAhKCAncG9pbnRlckV2ZW50cycgaW4gZWxlbWVudC5zdHlsZSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAnYXV0byc7CgllbGVtZW50LnN0eWxlLnBvaW50ZXJFdmVudHMgPSAneCc7Cglkb2N1bWVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoIGVsZW1lbnQgKTsKCXN1cHBvcnRzID0gZ2V0Q29tcHV0ZWRTdHlsZSAmJgoJZ2V0Q29tcHV0ZWRTdHlsZSggZWxlbWVudCwgJycgKS5wb2ludGVyRXZlbnRzID09PSAnYXV0byc7Cglkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQoIGVsZW1lbnQgKTsKCXJldHVybiAhIXN1cHBvcnRzOwp9CgpmdW5jdGlvbiBib3VuZGluZ1JlY3QoKSB7Cgl2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCXJldHVybiB0eXBlb2YgZGl2LmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gInVuZGVmaW5lZCI7Cn0KCi8vIG5vbi1VQS1iYXNlZCBJRSB2ZXJzaW9uIGNoZWNrIGJ5IEphbWVzIFBhZG9sc2V5LCBtb2RpZmllZCBieSBqZGFsdG9uIC0gZnJvbSBodHRwOi8vZ2lzdC5naXRodWIuY29tLzUyNzY4MwovLyBhbGxvd3MgZm9yIGluY2x1c2lvbiBvZiBJRSA2KywgaW5jbHVkaW5nIFdpbmRvd3MgTW9iaWxlIDcKJC5leHRlbmQoICQubW9iaWxlLCB7IGJyb3dzZXI6IHt9IH0gKTsKJC5tb2JpbGUuYnJvd3Nlci5pZSA9IChmdW5jdGlvbigpIHsKCXZhciB2ID0gMywKCQlkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCWEgPSBkaXYuYWxsIHx8IFtdOwoKCWRvIHsKCQlkaXYuaW5uZXJIVE1MID0gIjwhLS1baWYgZ3QgSUUgIiArICggKyt2ICkgKyAiXT48YnI+PCFbZW5kaWZdLS0+IjsKCX0gd2hpbGUoIGFbMF0gKTsKCglyZXR1cm4gdiA+IDQgPyB2IDogIXY7Cn0pKCk7CgoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fCB2YWxpZFN0eWxlKCAndHJhbnNpdGlvbicsICdoZWlnaHQgMTAwbXMgbGluZWFyJyApICYmICFvcGVyYSwKCXB1c2hTdGF0ZTogInB1c2hTdGF0ZSIgaW4gaGlzdG9yeSAmJiAicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5LAoJbWVkaWFxdWVyeTogJC5tb2JpbGUubWVkaWEoICJvbmx5IGFsbCIgKSwKCWNzc1BzZXVkb0VsZW1lbnQ6ICEhcHJvcEV4aXN0cyggImNvbnRlbnQiICksCgl0b3VjaE92ZXJmbG93OiAhIXByb3BFeGlzdHMoICJvdmVyZmxvd1Njcm9sbGluZyIgKSwKCWNzc1RyYW5zZm9ybTNkOiB0cmFuc2Zvcm0zZFRlc3QoKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCXNjcm9sbFRvcDogKCAicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fCAic2Nyb2xsVG9wIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSApICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKQp9KTsKCmZha2VCb2R5LnJlbW92ZSgpOwoKCi8vICQubW9iaWxlLmFqYXhCbGFja2xpc3QgaXMgdXNlZCB0byBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzIChCQjUsIFN5bWJpYW4pCi8vIG9yIHRoYXQgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoT3BlcmEgTWluaSkKLy8gTm90ZTogVGhpcyBkZXRlY3Rpb24gYmVsb3cgaXMgdXNlZCBhcyBhIGxhc3QgcmVzb3J0LgovLyBXZSByZWNvbW1lbmQgb25seSB1c2luZyB0aGVzZSBkZXRlY3Rpb24gbWV0aG9kcyB3aGVuIGFsbCBvdGhlciBtb3JlIHJlbGlhYmxlL2ZvcndhcmQtbG9va2luZyBhcHByb2FjaGVzIGFyZSBub3QgcG9zc2libGUKdmFyIG5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggJC5zdXBwb3J0Lm1lZGlhcXVlcnkgfHwgJC5tb2JpbGUuYnJvd3Nlci5pZSAmJiAkLm1vYmlsZS5icm93c2VyLmllID49IDcgKSAmJiAoICQuc3VwcG9ydC5ib3VuZGluZ1JlY3QgfHwgJC5mbi5qcXVlcnkubWF0Y2goLzFcLlswLTcrXVwuWzAtOStdPy8pICE9PSBudWxsICk7Cn07CgokLm1vYmlsZS5hamF4QmxhY2tsaXN0ID0KCQkJLy8gQmxhY2tCZXJyeSBicm93c2VycywgcHJlLXdlYmtpdAoJCQl3aW5kb3cuYmxhY2tiZXJyeSAmJiAhd2luZG93LldlYktpdFBvaW50IHx8CgkJCS8vIE9wZXJhIE1pbmkKCQkJb3BlcmFtaW5pIHx8CgkJCS8vIFN5bWJpYW4gd2Via2l0cyBwcmUgNy4zCgkJCW5va2lhTFRFN18zOwoKLy8gTGFzdGx5LCB0aGlzIHdvcmthcm91bmQgaXMgdGhlIG9ubHkgd2F5IHdlJ3ZlIGZvdW5kIHNvIGZhciB0byBnZXQgcHJlIDcuMyBTeW1iaWFuIHdlYmtpdCBkZXZpY2VzCi8vIHRvIHJlbmRlciB0aGUgc3R5bGVzaGVldHMgd2hlbiB0aGV5J3JlIHJlZmVyZW5jZWQgYmVmb3JlIHRoaXMgc2NyaXB0LCBhcyB3ZSdkIHJlY29tbWVuZCBkb2luZy4KLy8gVGhpcyBzaW1wbHkgcmVhcHBlbmRzIHRoZSBDU1MgaW4gcGxhY2UsIHdoaWNoIGZvciBzb21lIHJlYXNvbiBtYWtlcyBpdCBhcHBseQppZiAoIG5va2lhTFRFN18zICkgewoJJChmdW5jdGlvbigpIHsKCQkkKCAiaGVhZCBsaW5rW3JlbD0nc3R5bGVzaGVldCddIiApLmF0dHIoICJyZWwiLCAiYWx0ZXJuYXRlIHN0eWxlc2hlZXQiICkuYXR0ciggInJlbCIsICJzdHlsZXNoZWV0IiApOwoJfSk7Cn0KCi8vIEZvciBydWxpbmcgb3V0IHNoYWRvd3MgdmlhIGNzcwppZiAoICEkLnN1cHBvcnQuYm94U2hhZG93ICkgewoJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtbm9zdXBwb3J0LWJveHNoYWRvdyIgKTsKfQoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6ICJjIiwKCQlkb21DYWNoZTogZmFsc2UsCgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICI6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCS8vIGlmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggc2VsZi5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXNlbGYuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKQoJCQkuYmluZCggInBhZ2ViZWZvcmVoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLnJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQoKTsKCQkJfSApCgkJCS5iaW5kKCAicGFnZWJlZm9yZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl9ICk7CgoJfSwKCQoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYWRkQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyAoIHRoZW1lIHx8IHRoaXMub3B0aW9ucy50aGVtZSApICk7CgkJfQoJfSwKCglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlRGVmaW5lZCA9IG9wdGlvbnMua2VlcE5hdGl2ZSAmJiAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZSApOwoKCQlpZiAoIGtlZXBOYXRpdmVEZWZpbmVkICYmIG9wdGlvbnMua2VlcE5hdGl2ZSAhPT0gb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdCApIHsKCQkJcmV0dXJuIFtvcHRpb25zLmtlZXBOYXRpdmUsIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHRdLmpvaW4oICIsICIgKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0OwoJfQp9KTsKfSkoIGpRdWVyeSApOwoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgICQuYnJvd3Nlci5tc2llICYmICFzdXBwb3J0c19vbmhhc2hjaGFuZ2UgJiYgKGZ1bmN0aW9uKCkgewogICAgICAvLyBOb3Qgb25seSBkbyBJRTYvNyBuZWVkIHRoZSAibWFnaWNhbCIgSWZyYW1lIHRyZWF0bWVudCwgYnV0IHNvIGRvZXMgSUU4CiAgICAgIC8vIHdoZW4gcnVubmluZyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUuCiAgICAgIAogICAgICB2YXIgaWZyYW1lLAogICAgICAgIGlmcmFtZV9zcmM7CiAgICAgIAogICAgICAvLyBXaGVuIHRoZSBldmVudCBpcyBib3VuZCBhbmQgcG9sbGluZyBzdGFydHMgaW4gSUUgNi83LCBjcmVhdGUgYSBoaWRkZW4KICAgICAgLy8gSWZyYW1lIGZvciBoaXN0b3J5IGhhbmRsaW5nLgogICAgICBzZWxmLnN0YXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCAhaWZyYW1lICkgewogICAgICAgICAgaWZyYW1lX3NyYyA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uc3JjOwogICAgICAgICAgaWZyYW1lX3NyYyA9IGlmcmFtZV9zcmMgJiYgaWZyYW1lX3NyYyArIGdldF9mcmFnbWVudCgpOwogICAgICAgICAgCiAgICAgICAgICAvLyBDcmVhdGUgaGlkZGVuIElmcmFtZS4gQXR0ZW1wdCB0byBtYWtlIElmcmFtZSBhcyBoaWRkZW4gYXMgcG9zc2libGUKICAgICAgICAgIC8vIGJ5IHVzaW5nIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LgogICAgICAgICAgaWZyYW1lID0gJCgnPGlmcmFtZSB0YWJpbmRleD0iLTEiIHRpdGxlPSJlbXB0eSIvPicpLmhpZGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gV2hlbiBJZnJhbWUgaGFzIGNvbXBsZXRlbHkgbG9hZGVkLCBpbml0aWFsaXplIHRoZSBoaXN0b3J5IGFuZAogICAgICAgICAgICAvLyBzdGFydCBwb2xsaW5nLgogICAgICAgICAgICAub25lKCAnbG9hZCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmcmFtZV9zcmMgfHwgaGlzdG9yeV9zZXQoIGdldF9mcmFnbWVudCgpICk7CiAgICAgICAgICAgICAgcG9sbCgpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gTG9hZCBJZnJhbWUgc3JjIGlmIHNwZWNpZmllZCwgb3RoZXJ3aXNlIG5vdGhpbmcuCiAgICAgICAgICAgIC5hdHRyKCAnc3JjJywgaWZyYW1lX3NyYyB8fCAnamF2YXNjcmlwdDowJyApCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBBcHBlbmQgSWZyYW1lIGFmdGVyIHRoZSBlbmQgb2YgdGhlIGJvZHkgdG8gcHJldmVudCB1bm5lY2Vzc2FyeQogICAgICAgICAgICAvLyBpbml0aWFsIHBhZ2Ugc2Nyb2xsaW5nICh5ZXMsIHRoaXMgd29ya3MpLgogICAgICAgICAgICAuaW5zZXJ0QWZ0ZXIoICdib2R5JyApWzBdLmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAKICAgICAgICAgIC8vIFdoZW5ldmVyIGBkb2N1bWVudC50aXRsZWAgY2hhbmdlcywgdXBkYXRlIHRoZSBJZnJhbWUncyB0aXRsZSB0bwogICAgICAgICAgLy8gcHJldHRpZnkgdGhlIGJhY2svbmV4dCBoaXN0b3J5IG1lbnUgZW50cmllcy4gU2luY2UgSUUgc29tZXRpbWVzCiAgICAgICAgICAvLyBlcnJvcnMgd2l0aCAiVW5zcGVjaWZpZWQgZXJyb3IiIHRoZSB2ZXJ5IGZpcnN0IHRpbWUgdGhpcyBpcyBzZXQKICAgICAgICAgIC8vICh5ZXMsIHZlcnkgdXNlZnVsKSB3cmFwIHRoaXMgd2l0aCBhIHRyeS9jYXRjaCBibG9jay4KICAgICAgICAgIGRvYy5vbnByb3BlcnR5Y2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaWYgKCBldmVudC5wcm9wZXJ0eU5hbWUgPT09ICd0aXRsZScgKSB7CiAgICAgICAgICAgICAgICBpZnJhbWUuZG9jdW1lbnQudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoKGUpIHt9CiAgICAgICAgICB9OwogICAgICAgICAgCiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgICAgLy8gT3ZlcnJpZGUgdGhlICJzdG9wIiBtZXRob2Qgc2luY2UgYW4gSUU2LzcgSWZyYW1lIHdhcyBjcmVhdGVkLiBFdmVuCiAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBsb25nZXIgYW55IGJvdW5kIGV2ZW50IGhhbmRsZXJzLCB0aGUgcG9sbGluZyBsb29wCiAgICAgIC8vIGlzIHN0aWxsIG5lY2Vzc2FyeSBmb3IgYmFjay9uZXh0IHRvIHdvcmsgYXQgYWxsIQogICAgICBzZWxmLnN0b3AgPSBmbl9yZXR2YWw7CiAgICAgIAogICAgICAvLyBHZXQgaGlzdG9yeSBieSBsb29raW5nIGF0IHRoZSBoaWRkZW4gSWZyYW1lJ3MgbG9jYXRpb24uaGFzaC4KICAgICAgaGlzdG9yeV9nZXQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gZ2V0X2ZyYWdtZW50KCBpZnJhbWUubG9jYXRpb24uaHJlZiApOwogICAgICB9OwogICAgICAKICAgICAgLy8gU2V0IGEgbmV3IGhpc3RvcnkgaXRlbSBieSBvcGVuaW5nIGFuZCB0aGVuIGNsb3NpbmcgdGhlIElmcmFtZQogICAgICAvLyBkb2N1bWVudCwgKnRoZW4qIHNldHRpbmcgaXRzIGxvY2F0aW9uLmhhc2guIElmIGRvY3VtZW50LmRvbWFpbiBoYXMKICAgICAgLy8gYmVlbiBzZXQsIHVwZGF0ZSB0aGF0IGFzIHdlbGwuCiAgICAgIGhpc3Rvcnlfc2V0ID0gZnVuY3Rpb24oIGhhc2gsIGhpc3RvcnlfaGFzaCApIHsKICAgICAgICB2YXIgaWZyYW1lX2RvYyA9IGlmcmFtZS5kb2N1bWVudCwKICAgICAgICAgIGRvbWFpbiA9ICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluOwogICAgICAgIAogICAgICAgIGlmICggaGFzaCAhPT0gaGlzdG9yeV9oYXNoICkgewogICAgICAgICAgLy8gVXBkYXRlIElmcmFtZSB3aXRoIGFueSBpbml0aWFsIGBkb2N1bWVudC50aXRsZWAgdGhhdCBtaWdodCBiZSBzZXQuCiAgICAgICAgICBpZnJhbWVfZG9jLnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgCiAgICAgICAgICAvLyBPcGVuaW5nIHRoZSBJZnJhbWUncyBkb2N1bWVudCBhZnRlciBpdCBoYXMgYmVlbiBjbG9zZWQgaXMgd2hhdAogICAgICAgICAgLy8gYWN0dWFsbHkgYWRkcyBhIGhpc3RvcnkgZW50cnkuCiAgICAgICAgICBpZnJhbWVfZG9jLm9wZW4oKTsKICAgICAgICAgIAogICAgICAgICAgLy8gU2V0IGRvY3VtZW50LmRvbWFpbiBmb3IgdGhlIElmcmFtZSBkb2N1bWVudCBhcyB3ZWxsLCBpZiBuZWNlc3NhcnkuCiAgICAgICAgICBkb21haW4gJiYgaWZyYW1lX2RvYy53cml0ZSggJzxzY3JpcHQ+ZG9jdW1lbnQuZG9tYWluPSInICsgZG9tYWluICsgJyI8L3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7Cgp2YXIgY3JlYXRlSGFuZGxlciA9IGZ1bmN0aW9uKCBzZXF1ZW50aWFsICkgewoKCS8vIERlZmF1bHQgdG8gc2VxdWVudGlhbAoJaWYgKCBzZXF1ZW50aWFsID09PSB1bmRlZmluZWQgKSB7CgkJc2VxdWVudGlhbCA9IHRydWU7Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tICkgewoKCQl2YXIgZGVmZXJyZWQgPSBuZXcgJC5EZWZlcnJlZCgpLAoJCQlyZXZlcnNlQ2xhc3MgPSByZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQlhY3RpdmUJPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQl0b1Njcm9sbCA9IGFjdGl2ZS5sYXN0U2Nyb2xsIHx8ICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsLAoJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKSwKCQkJbWF4VHJhbnNpdGlvbk92ZXJyaWRlID0gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoICE9PSBmYWxzZSAmJiAkKCB3aW5kb3cgKS53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQlub25lID0gISQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyB8fCBtYXhUcmFuc2l0aW9uT3ZlcnJpZGUgfHwgIW5hbWUgfHwgbmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSwgdG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKSwKCQkJdG9QcmVDbGFzcyA9ICIgdWktcGFnZS1wcmUtaW4iLAoJCQl0b2dnbGVWaWV3cG9ydENsYXNzID0gZnVuY3Rpb24oKSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUgKTsKCQkJfSwKCQkJc2Nyb2xsUGFnZSA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0b1Njcm9sbCApOwoKCQkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQkJfSwgMTUwICk7CgkJCX0sCgkJCWNsZWFuRnJvbSA9IGZ1bmN0aW9uKCkgewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiBpdCdzIG5vdCBzZXF1ZW50aWFsLCBjYWxsIHRoZSBkb25lT3V0IHRyYW5zaXRpb24gdG8gc3RhcnQgdGhlIFRPIHBhZ2UgYW5pbWF0aW5nIGluIHNpbXVsdGFuZW91c2x5CgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCQkvLyBOb3RlOiBzZXR0aW5nIGFuIGV4cGxpY2l0IGhlaWdodCBoZWxwcyBlbGltaW5hdGUgdGlsaW5nIGluIHRoZSB0cmFuc2l0aW9ucwoJCQkJJGZyb20KCQkJCQkuaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBvdXQiICsgcmV2ZXJzZUNsYXNzICk7CgkJCX0sCgoJCQlkb25lT3V0ID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAkZnJvbSAmJiBzZXF1ZW50aWFsICkgewoJCQkJCWNsZWFuRnJvbSgpOwoJCQkJfQoKCQkJCXN0YXJ0SW4oKTsKCQkJfSwKCgkJCXN0YXJ0SW4gPSBmdW5jdGlvbigpIHsKCgkJCQkvLyBQcmV2ZW50IGZsaWNrZXJpbmcgaW4gcGhvbmVnYXAgY29udGFpbmVyOiBzZWUgY29tbWVudHMgYXQgIzQwMjQgcmVnYXJkaW5nIGlPUwoJCQkJJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCgkJCQkkdG8uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArIHRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoICR0byApOwoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJJHRvLmhlaWdodCggc2NyZWVuSGVpZ2h0ICsgdG9TY3JvbGwgKTsKCgkJCQlzY3JvbGxQYWdlKCk7CgoJCQkJLy8gUmVzdG9yZXMgdmlzaWJpbGl0eSBvZiB0aGUgbmV3IHBhZ2U6IGFkZGVkIHRvZ2V0aGVyIHdpdGggJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCgkJCQlpZiAoICFub25lICkgewoJCQkJCSR0by5hbmltYXRpb25Db21wbGV0ZSggZG9uZUluICk7CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCB0b1ByZUNsYXNzICkKCQkJCQkuYWRkQ2xhc3MoIG5hbWUgKyAiIGluIiArIHJldmVyc2VDbGFzcyApOwoKCQkJCWlmICggbm9uZSApIHsKCQkJCQlkb25lSW4oKTsKCQkJCX0KCgkJCX0sCgoJCQlkb25lSW4gPSBmdW5jdGlvbigpIHsKCgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoKCQkJCQlpZiAoICRmcm9tICkgewoJCQkJCQljbGVhbkZyb20oKTsKCQkJCQl9CgkJCQl9CgoJCQkJJHRvCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgoJCQkJdG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJCS8vIEluIHNvbWUgYnJvd3NlcnMgKGlPUzUpLCAzRCB0cmFuc2l0aW9ucyBibG9jayB0aGUgYWJpbGl0eSB0byBzY3JvbGwgdG8gdGhlIGRlc2lyZWQgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXRpb24KCQkJCS8vIFRoaXMgZW5zdXJlcyB3ZSBqdW1wIHRvIHRoYXQgc3BvdCBhZnRlciB0aGUgZmFjdCwgaWYgd2UgYXJlbid0IHRoZXJlIGFscmVhZHkuCgkJCQlpZiAoICQoIHdpbmRvdyApLnNjcm9sbFRvcCgpICE9PSB0b1Njcm9sbCApIHsKCQkJCQlzY3JvbGxQYWdlKCk7CgkJCQl9CgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgdHJ1ZSApOwoJCQl9OwoKCQl0b2dnbGVWaWV3cG9ydENsYXNzKCk7CgoJCWlmICggJGZyb20gJiYgIW5vbmUgKSB7CgkJCXN0YXJ0T3V0KCk7CgkJfQoJCWVsc2UgewoJCQlkb25lT3V0KCk7CgkJfQoKCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJfTsKfTsKCi8vIGdlbmVyYXRlIHRoZSBoYW5kbGVycyBmcm9tIHRoZSBhYm92ZQp2YXIgc2VxdWVudGlhbEhhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCksCglzaW11bHRhbmVvdXNIYW5kbGVyID0gY3JlYXRlSGFuZGxlciggZmFsc2UgKSwKCWRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpICogMzsKCX07CgovLyBNYWtlIG91ciB0cmFuc2l0aW9uIGhhbmRsZXIgdGhlIHB1YmxpYyBkZWZhdWx0LgokLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSBzZXF1ZW50aWFsSGFuZGxlcjsKCi8vdHJhbnNpdGlvbiBoYW5kbGVyIGRpY3Rpb25hcnkgZm9yIDNyZCBwYXJ0eSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMgPSB7CgkiZGVmYXVsdCI6ICQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciwKCSJzZXF1ZW50aWFsIjogc2VxdWVudGlhbEhhbmRsZXIsCgkic2ltdWx0YW5lb3VzIjogc2ltdWx0YW5lb3VzSGFuZGxlcgp9OwoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcyA9IHt9OwoKLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAokLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCWlmICggdHJhbnNpdGlvbiAmJiAhJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXSApIHsKCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3NbIHRyYW5zaXRpb24gXTsKCQl9CgoJCXJldHVybiB0cmFuc2l0aW9uOwp9OwoKLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCiQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSAkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHx8IGRlZmF1bHRHZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkvL2RlZmluZSB2YXJzIGZvciBpbnRlcmFsIHVzZQoJdmFyICR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCQkkaHRtbCA9ICQoICdodG1sJyApLAoJCSRoZWFkID0gJCggJ2hlYWQnICksCgoJCS8vdXJsIHBhdGggaGVscGVycyBmb3IgdXNlIGluIHJlbGF0aXZlIHVybCBtYW5hZ2VtZW50CgkJcGF0aCA9IHsKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL14oKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8JZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdXJpID0gdXJsID8gdGhpcy5wYXJzZVVybCggdXJsICkgOiBsb2NhdGlvbiwKCQkJCQloYXNoID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKS5oYXNoOwoKCQkJCS8vIG1pbWljIHRoZSBicm93c2VyIHdpdGggYW4gZW1wdHkgc3RyaW5nIHdoZW4gdGhlIGhhc2ggaXMgZW1wdHkKCQkJCWhhc2ggPSBoYXNoID09PSAiIyIgPyAiIiA6IGhhc2g7CgoJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZyBsb2NhdGlvbi5oYXNoCgkJCQkvLyBpcyBhdXRvZGVjb2RlZCBpbiBmaXJlZm94LCB0aGUgcmVzdCBvZiB0aGUgdXJsIHNob3VsZCBiZSBmcm9tIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcwoJCQkJLy8gd2UncmUgdGVzdGluZykgdG8gYXZvaWQgdGhlIGluY2x1c2lvbiBvZiB0aGUgYXV0aG9yaXR5CgkJCQlyZXR1cm4gdXJpLnByb3RvY29sICsgIi8vIiArIHVyaS5ob3N0ICsgdXJpLnBhdGhuYW1lICsgdXJpLnNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJdmFyIGFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW10sCgkJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCXZhciBkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IGRvY3VtZW50QmFzZTsKCQkJCX0KCgkJCQl2YXIgcmVsT2JqID0gcGF0aC5wYXJzZVVybCggcmVsVXJsICksCgkJCQkJYWJzT2JqID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICksCgkJCQkJcHJvdG9jb2wgPSByZWxPYmoucHJvdG9jb2wgfHwgYWJzT2JqLnByb3RvY29sLAoJCQkJCWRvdWJsZVNsYXNoID0gcmVsT2JqLnByb3RvY29sID8gcmVsT2JqLmRvdWJsZVNsYXNoIDogKCByZWxPYmouZG91YmxlU2xhc2ggfHwgYWJzT2JqLmRvdWJsZVNsYXNoICksCgkJCQkJYXV0aG9yaXR5ID0gcmVsT2JqLmF1dGhvcml0eSB8fCBhYnNPYmouYXV0aG9yaXR5LAoJCQkJCWhhc1BhdGggPSByZWxPYmoucGF0aG5hbWUgIT09ICIiLAoJCQkJCXBhdGhuYW1lID0gcGF0aC5tYWtlUGF0aEFic29sdXRlKCByZWxPYmoucGF0aG5hbWUgfHwgYWJzT2JqLmZpbGVuYW1lLCBhYnNPYmoucGF0aG5hbWUgKSwKCQkJCQlzZWFyY2ggPSByZWxPYmouc2VhcmNoIHx8ICggIWhhc1BhdGggJiYgYWJzT2JqLnNlYXJjaCApIHx8ICIiLAoJCQkJCWhhc2ggPSByZWxPYmouaGFzaDsKCgkJCQlyZXR1cm4gcHJvdG9jb2wgKyBkb3VibGVTbGFzaCArIGF1dGhvcml0eSArIHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKCQkJfSwKCgkJCS8vQWRkIHNlYXJjaCAoYWthIHF1ZXJ5KSBwYXJhbXMgdG8gdGhlIHNwZWNpZmllZCB1cmwuCgkJCWFkZFNlYXJjaFBhcmFtczogZnVuY3Rpb24oIHVybCwgcGFyYW1zICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwID0gKCB0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiApID8gJC5wYXJhbSggcGFyYW1zICkgOiBwYXJhbXMsCgkJCQkJcyA9IHUuc2VhcmNoIHx8ICI/IjsKCQkJCXJldHVybiB1LmhyZWZOb1NlYXJjaCArIHMgKyAoIHMuY2hhckF0KCBzLmxlbmd0aCAtIDEgKSAhPT0gIj8iID8gIiYiIDogIiIgKSArIHAgKyAoIHUuaGFzaCB8fCAiIiApOwoJCQl9LAoKCQkJY29udmVydFVybFRvRGF0YVVybDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJCXZhciB1ID0gcGF0aC5wYXJzZVVybCggYWJzVXJsICk7CgkJCQlpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIHUgKSApIHsKCQkJCQkvLyBGb3IgZW1iZWRkZWQgcGFnZXMsIHJlbW92ZSB0aGUgZGlhbG9nIGhhc2gga2V5IGFzIGluIGdldEZpbGVQYXRoKCksCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSBEYXRhIFVybCB3b24ndCBtYXRjaCB0aGUgaWQgb2YgdGhlIGVtYmVkZGVkIFBhZ2UuCgkJCQkJcmV0dXJuIHUuaGFzaC5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgZG9jdW1lbnRCYXNlICkgKSB7CgkJCQkJcmV0dXJuIHUuaHJlZk5vSGFzaC5yZXBsYWNlKCBkb2N1bWVudEJhc2UuZG9tYWluLCAiIiApLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCQl9CgoJCQkJcmV0dXJuIHdpbmRvdy5kZWNvZGVVUklDb21wb25lbnQoYWJzVXJsKTsKCQkJfSwKCgkJCS8vZ2V0IHBhdGggZnJvbSBjdXJyZW50IGhhc2gsIG9yIGZyb20gYSBmaWxlIHBhdGgKCQkJZ2V0OiBmdW5jdGlvbiggbmV3UGF0aCApIHsKCQkJCWlmICggbmV3UGF0aCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCW5ld1BhdGggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQkJfQoJCQkJcmV0dXJuIHBhdGguc3RyaXBIYXNoKCBuZXdQYXRoICkucmVwbGFjZSggL1teXC9dKlwuW15cLypdKyQvLCAnJyApOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKTsKCQkJfSwKCgkJCS8vanVzdCByZXR1cm4gdGhlIHVybCB3aXRob3V0IGFuIGluaXRpYWwgIwoJCQlzdHJpcEhhc2g6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9eIy8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IGRvY3VtZW50VXJsLmRvbWFpbiA/IHRydWUgOiBmYWxzZTsKCQkJfSwKCgkJCWhhc1Byb3RvY29sOiBmdW5jdGlvbiggdXJsICkgewoJCQkJcmV0dXJuICggL14oOj9cdys6KS8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBkb2N1bWVudEJhc2UgKSApLAoKCQkJCQkvLyBEb2VzIHRoZSB1cmwgaGF2ZSB0aGUgc2FtZSBwYXRoIGFzIHRoZSBkb2N1bWVudD8KCQkJCQlzYW1lUGF0aCA9IHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApLAoKCQkJCQkvLyBHZXQgdGhlIGZpcnN0IHBhZ2UgZWxlbWVudC4KCQkJCQlmcCA9ICQubW9iaWxlLmZpcnN0UGFnZSwKCgkJCQkJLy8gR2V0IHRoZSBpZCBvZiB0aGUgZmlyc3QgcGFnZSBlbGVtZW50IGlmIGl0IGhhcyBvbmUuCgkJCQkJZnBJZCA9IGZwICYmIGZwWzBdID8gZnBbMF0uaWQgOiB1bmRlZmluZWQ7CgoJCQkJCS8vIFRoZSB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGlmIHRoZSBwYXRoIG1hdGNoZXMgdGhlIGRvY3VtZW50IGFuZAoJCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkJLy8gZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCXJldHVybiBzYW1lUGF0aCAmJiAoICF1Lmhhc2ggfHwgdS5oYXNoID09PSAiIyIgfHwgKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCWlzRW1iZWRkZWRQYWdlOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCgkJCQkvL2lmIHRoZSBwYXRoIGlzIGFic29sdXRlLCB0aGVuIHdlIG5lZWQgdG8gY29tcGFyZSB0aGUgdXJsIGFnYWluc3QKCQkJCS8vYm90aCB0aGUgZG9jdW1lbnRVcmwgYW5kIHRoZSBkb2N1bWVudEJhc2UuIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcwoJCQkJLy9pcyB0aGF0IGxpbmtzIGVtYmVkZGVkIHdpdGhpbiBleHRlcm5hbCBkb2N1bWVudHMgd2lsbCByZWZlciB0byB0aGUKCQkJCS8vYXBwbGljYXRpb24gZG9jdW1lbnQsIHdoZXJlYXMgbGlua3MgZW1iZWRkZWQgd2l0aGluIHRoZSBhcHBsaWNhdGlvbgoJCQkJLy9kb2N1bWVudCB3aWxsIGJlIHJlc29sdmVkIGFnYWluc3QgdGhlIGRvY3VtZW50IGJhc2UuCgkJCQlpZiAoIHUucHJvdG9jb2wgIT09ICIiICkgewoJCQkJCXJldHVybiAoIHUuaGFzaCAmJiAoIHUuaHJlZk5vSGFzaCA9PT0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIGRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApICkgKTsKCQkJCX0KCQkJCXJldHVybiAoIC9eIy8gKS50ZXN0KCB1LmhyZWYgKTsKCQkJfSwKCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQlkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSwKCgkJLy93aWxsIGJlIGRlZmluZWQgd2hlbiBhIGxpbmsgaXMgY2xpY2tlZCBhbmQgZ2l2ZW4gYW4gYWN0aXZlIGNsYXNzCgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbCwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9IHsKCQkJLy8gQXJyYXkgb2YgcGFnZXMgdGhhdCBhcmUgdmlzaXRlZCBkdXJpbmcgYSBzaW5nbGUgcGFnZSBsb2FkLgoJCQkvLyBFYWNoIGhhcyBhIHVybCBhbmQgb3B0aW9uYWwgdHJhbnNpdGlvbiwgdGl0bGUsIGFuZCBwYWdlVXJsICh3aGljaCByZXByZXNlbnRzIHRoZSBmaWxlIHBhdGgsIGluIGNhc2VzIHdoZXJlIFVSTCBpcyBvYnNjdXJlZCwgc3VjaCBhcyBkaWFsb2dzKQoJCQlzdGFjazogW10sCgoJCQkvL21haW50YWluIGFuIGluZGV4IG51bWJlciBmb3IgdGhlIGFjdGl2ZSBwYWdlIGluIHRoZSBzdGFjawoJCQlhY3RpdmVJbmRleDogMCwKCgkJCS8vZ2V0IGFjdGl2ZQoJCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggXTsKCQkJfSwKCgkJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuIHVybEhpc3Rvcnkuc3RhY2tbIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxIF07CgkJCX0sCgoJCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB1cmxIaXN0b3J5LnN0YWNrWyB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ICsgMSBdOwoJCQl9LAoKCQkJLy8gYWRkTmV3IGlzIHVzZWQgd2hlbmV2ZXIgYSBuZXcgcGFnZSBpcyBhZGRlZAoJCQlhZGROZXc6IGZ1bmN0aW9uKCB1cmwsIHRyYW5zaXRpb24sIHRpdGxlLCBwYWdlVXJsLCByb2xlICkgewoJCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQkJaWYgKCB1cmxIaXN0b3J5LmdldE5leHQoKSApIHsKCQkJCQl1cmxIaXN0b3J5LmNsZWFyRm9yd2FyZCgpOwoJCQkJfQoKCQkJCXVybEhpc3Rvcnkuc3RhY2sucHVzaCgge3VybCA6IHVybCwgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgdGl0bGU6IHRpdGxlLCBwYWdlVXJsOiBwYWdlVXJsLCByb2xlOiByb2xlIH0gKTsKCgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID0gdXJsSGlzdG9yeS5zdGFjay5sZW5ndGggLSAxOwoJCQl9LAoKCQkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCQl1cmxIaXN0b3J5LnN0YWNrID0gdXJsSGlzdG9yeS5zdGFjay5zbGljZSggMCwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleCArIDEgKTsKCQkJfSwKCgkJCWRpcmVjdEhhc2hDaGFuZ2U6IGZ1bmN0aW9uKCBvcHRzICkgewoJCQkJdmFyIGJhY2sgLCBmb3J3YXJkLCBuZXdBY3RpdmVJbmRleCwgcHJldiA9IHRoaXMuZ2V0QWN0aXZlKCk7CgoJCQkJLy8gY2hlY2sgaWYgdXJsIGlzIGluIGhpc3RvcnkgYW5kIGlmIGl0J3MgYWhlYWQgb3IgYmVoaW5kIGN1cnJlbnQgcGFnZQoJCQkJJC5lYWNoKCB1cmxIaXN0b3J5LnN0YWNrLCBmdW5jdGlvbiggaSwgaGlzdG9yeUVudHJ5ICkgewoKCQkJCQkvL2lmIHRoZSB1cmwgaXMgaW4gdGhlIHN0YWNrLCBpdCdzIGEgZm9yd2FyZCBvciBhIGJhY2sKCQkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCggb3B0cy5jdXJyZW50VXJsICkgPT09IGRlY29kZVVSSUNvbXBvbmVudCggaGlzdG9yeUVudHJ5LnVybCApICkgewoJCQkJCQkvL2RlZmluZSBiYWNrIGFuZCBmb3J3YXJkIGJ5IHdoZXRoZXIgdXJsIGlzIG9sZGVyIG9yIG5ld2VyIHRoYW4gY3VycmVudCBwYWdlCgkJCQkJCWJhY2sgPSBpIDwgdXJsSGlzdG9yeS5hY3RpdmVJbmRleDsKCQkJCQkJZm9yd2FyZCA9ICFiYWNrOwoJCQkJCQluZXdBY3RpdmVJbmRleCA9IGk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gc2F2ZSBuZXcgcGFnZSBpbmRleCwgbnVsbCBjaGVjayB0byBwcmV2ZW50IGZhbHNleSAwIHJlc3VsdAoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4ICE9PSB1bmRlZmluZWQgPyBuZXdBY3RpdmVJbmRleCA6IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkJaWYgKCBiYWNrICkgewoJCQkJCSggb3B0cy5laXRoZXIgfHwgb3B0cy5pc0JhY2sgKSggdHJ1ZSApOwoJCQkJfSBlbHNlIGlmICggZm9yd2FyZCApIHsKCQkJCQkoIG9wdHMuZWl0aGVyIHx8IG9wdHMuaXNGb3J3YXJkICkoIGZhbHNlICk7CgkJCQl9CgkJCX0sCgoJCQkvL2Rpc2FibGUgaGFzaGNoYW5nZSBldmVudCBsaXN0ZW5lciBpbnRlcm5hbGx5IHRvIGlnbm9yZSBvbmUgY2hhbmdlCgkJCS8vdG9nZ2xlZCBpbnRlcm5hbGx5IHdoZW4gbG9jYXRpb24uaGFzaCBpcyB1cGRhdGVkIHRvIG1hdGNoIHRoZSB1cmwgb2YgYSBzdWNjZXNzZnVsIHBhZ2UgbG9hZAoJCQlpZ25vcmVOZXh0SGFzaENoYW5nZTogZmFsc2UKCQl9LAoKCQkvL2RlZmluZSBmaXJzdCBzZWxlY3RvciB0byByZWNlaXZlIGZvY3VzIHdoZW4gYSBwYWdlIGlzIHNob3duCgkJZm9jdXNhYmxlID0gIlt0YWJpbmRleF0sYSxidXR0b246dmlzaWJsZSxzZWxlY3Q6dmlzaWJsZSxpbnB1dCIsCgoJCS8vcXVldWUgdG8gaG9sZCBzaW11bHRhbmlvdXMgcGFnZSB0cmFuc2l0aW9ucwoJCXBhZ2VUcmFuc2l0aW9uUXVldWUgPSBbXSwKCgkJLy9pbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2UsCgoJCS8vbm9uc2Vuc2UgaGFzaCBjaGFuZ2Uga2V5IGZvciBkaWFsb2dzLCBzbyB0aGV5IGNyZWF0ZSBhIGhpc3RvcnkgZW50cnkKCQlkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciLAoKCQkvL2V4aXN0aW5nIGJhc2UgdGFnPwoJCSRiYXNlID0gJGhlYWQuY2hpbGRyZW4oICJiYXNlIiApLAoKCQkvL3R1Y2sgYXdheSB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgVVJMIG1pbnVzIGFueSBmcmFnbWVudC4KCQlkb2N1bWVudFVybCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLAoKCQkvL2lmIHRoZSBkb2N1bWVudCBoYXMgYW4gZW1iZWRkZWQgYmFzZSB0YWcsIGRvY3VtZW50QmFzZSBpcyBzZXQgdG8gaXRzCgkJLy9pbml0aWFsIHZhbHVlLiBJZiBhIGJhc2UgdGFnIGRvZXMgbm90IGV4aXN0LCB0aGVuIHdlIGRlZmF1bHQgdG8gdGhlIGRvY3VtZW50VXJsLgoJCWRvY3VtZW50QmFzZSA9ICRiYXNlLmxlbmd0aCA/IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCAkYmFzZS5hdHRyKCAiaHJlZiIgKSwgZG9jdW1lbnRVcmwuaHJlZiApICkgOiBkb2N1bWVudFVybCwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSAoIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggIT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIHBhdGgubWFrZVVybEFic29sdXRlKCBocmVmLCBkb2N1bWVudEJhc2UgKSApOwoJCQl9LAoKCQkJLy9zZXQgdGhlIGdlbmVyYXRlZCBCQVNFIGVsZW1lbnQncyBocmVmIGF0dHJpYnV0ZSB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsIGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYoIHRoaXMucGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZCAmJgoJCQluYXYgJiYKCQkJbmF2LmFwcCAmJgoJCQluYXYuYXBwLmJhY2tIaXN0b3J5ICl7CgkJCW5hdi5hcHAuYmFja0hpc3RvcnkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuaGlzdG9yeS5iYWNrKCk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvL3JlbW92ZSBhY3RpdmUgY2xhc3NlcyBhZnRlciBwYWdlIHRyYW5zaXRpb24gb3IgZXJyb3IKCWZ1bmN0aW9uIHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2VSZW1vdmFsICkgewoJCWlmICggISEkYWN0aXZlQ2xpY2tlZExpbmsgJiYgKCAhJGFjdGl2ZUNsaWNrZWRMaW5rLmNsb3Nlc3QoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLmxlbmd0aCB8fCBmb3JjZVJlbW92YWwgKSApIHsKCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0KCQkkYWN0aXZlQ2xpY2tlZExpbmsgPSBudWxsOwoJfQoKCWZ1bmN0aW9uIHJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKSB7CgkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCWlmICggcGFnZVRyYW5zaXRpb25RdWV1ZS5sZW5ndGggPiAwICkgewoJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJfQoJfQoKCS8vIFNhdmUgdGhlIGxhc3Qgc2Nyb2xsIGRpc3RhbmNlIHBlciBwYWdlLCBiZWZvcmUgaXQgaXMgaGlkZGVuCgl2YXIgc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlLAoJCXNldExhc3RTY3JvbGwsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsOwoKCXNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQkvLyB0aGlzIGJhcnJpZXIgcHJldmVudHMgc2V0dGluZyB0aGUgc2Nyb2xsIHZhbHVlIGJhc2VkIG9uIHRoZSBicm93c2VyCgkJLy8gc2Nyb2xsaW5nIHRoZSB3aW5kb3cgYmFzZWQgb24gYSBoYXNoY2hhbmdlCgkJaWYgKCAhc2V0TGFzdFNjcm9sbEVuYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQlpZiAoIGFjdGl2ZSApIHsKCQkJdmFyIGxhc3RTY3JvbGwgPSAkd2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gU2V0IGFjdGl2ZSBwYWdlJ3MgbGFzdFNjcm9sbCBwcm9wLgoJCQkvLyBJZiB0aGUgbG9jYXRpb24gd2UncmUgc2Nyb2xsaW5nIHRvIGlzIGxlc3MgdGhhbiBtaW5TY3JvbGxCYWNrLCBsZXQgaXQgZ28uCgkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gbGFzdFNjcm9sbCA8ICQubW9iaWxlLm1pblNjcm9sbEJhY2sgPyAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA6IGxhc3RTY3JvbGw7CgkJfQoJfTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgdG8gZ2F0aGVyIHNjcm9sbCBwb3NpdGlvbi4gVGhlIGRlbGF5IGFsbG93cyBmb3IgdGhlIGhhc2hjaGFuZ2UKCS8vIGV2ZW50IHRvIGZpcmUgYW5kIGRpc2FibGUgc2Nyb2xsIHJlY29yZGluZyBpbiB0aGUgY2FzZSB3aGVyZSB0aGUgYnJvd3NlciBzY3JvbGxzCgkvLyB0byB0aGUgaGFzaCB0YXJnZXRzIGxvY2F0aW9uIChzb21ldGltZXMgdGhlIHRvcCBvZiB0aGUgcGFnZSkuIG9uY2UgcGFnZWNoYW5nZSBmaXJlcwoJLy8gZ2V0TGFzdFNjcm9sbCBpcyBhZ2FpbiBwZXJtaXR0ZWQgdG8gb3BlcmF0ZQoJZGVsYXllZFNldExhc3RTY3JvbGwgPSBmdW5jdGlvbigpIHsKCQlzZXRUaW1lb3V0KCBzZXRMYXN0U2Nyb2xsLCAxMDAgKTsKCX07CgoJLy8gZGlzYWJsZSBhbiBzY3JvbGwgc2V0dGluZyB3aGVuIGEgaGFzaGNoYW5nZSBoYXMgYmVlbiBmaXJlZCwgdGhpcyBvbmx5IHdvcmtzCgkvLyBiZWNhdXNlIHRoZSByZWNvcmRpbmcgb2YgdGhlIHNjcm9sbCBwb3NpdGlvbiBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlcgoJLy8gdGhlIGJyb3dzZXIgbWlnaHQgaGF2ZSBjaGFuZ2VkIHRoZSBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkkd2luZG93LmJpbmQoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IGZhbHNlOwoJfSk7CgoJLy8gaGFuZGxlIGluaXRpYWwgaGFzaGNoYW5nZSBmcm9tIGNocm9tZSA6KAoJJHdpbmRvdy5vbmUoICQuc3VwcG9ydC5wdXNoU3RhdGUgPyAicG9wc3RhdGUiIDogImhhc2hjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7Cgl9KTsKCgkvLyB3YWl0IHVudGlsIHRoZSBtb2JpbGUgcGFnZSBjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCB0byBiaW5kIHRvIHBhZ2VjaGFuZ2UKCSR3aW5kb3cub25lKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIuYmluZCggInBhZ2VjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQgZGV0ZXJtaW5lZCBmb3IKCQkJLy8gdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJJHdpbmRvdy51bmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkJCS8vIGRldGVybWluZSBhbmQgYmluZCB0byB0aGUgY3VycmVudCBzY29sbCBlbGVtZW50IHdoaWNoIG1heSBiZSB0aGUgd2luZG93CgkJCS8vIG9yIGluIHRoZSBjYXNlIG9mIHRvdWNoIG92ZXJmbG93IHRoZSBlbGVtZW50IHdpdGggdG91Y2ggb3ZlcmZsb3cKCQkJJHdpbmRvdy5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgkJfSk7Cgl9KTsKCgkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlIGFzICJwYWdlY2hhbmdlIiB3b24ndCBiZSBmaXJlZCBpbiB0aGF0IGNhc2UKCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoKCS8vIE5vLW9wIGltcGxlbWVudGF0aW9uIG9mIHRyYW5zaXRpb24gZGVncmFkYXRpb24KCSQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gfHwgZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJcmV0dXJuIHRyYW5zaXRpb247Cgl9OwoKCS8vZnVuY3Rpb24gZm9yIHRyYW5zaXRpb25pbmcgYmV0d2VlbiB0d28gZXhpc3RpbmcgcGFnZXMKCWZ1bmN0aW9uIHRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgdHJhbnNpdGlvbiwgcmV2ZXJzZSApIHsKCgkJaWYgKCBmcm9tUGFnZSApIHsKCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiYmVmb3JlaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJfQoKCQl0b1BhZ2UuZGF0YSggInBhZ2UiICkuX3RyaWdnZXIoICJiZWZvcmVzaG93IiwgbnVsbCwgeyBwcmV2UGFnZTogZnJvbVBhZ2UgfHwgJCggIiIgKSB9ICk7CgoJCS8vY2xlYXIgcGFnZSBsb2FkZXIKCQkkLm1vYmlsZS5oaWRlUGFnZUxvYWRpbmdNc2coKTsKCgkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB0cmFuc2l0aW9uICk7CgoJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJLy9pc24ndCBvbmUgaW4gb3VyIHRyYW5zaXRpb25IYW5kbGVycyBkaWN0aW9uYXJ5LCB1c2UgdGhlIGRlZmF1bHQgb25lLgoJCS8vY2FsbCB0aGUgaGFuZGxlciBpbW1lZGlhdGVseSB0byBraWNrLW9mZiB0aGUgdHJhbnNpdGlvbi4KCQl2YXIgdGggPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnNbIHRyYW5zaXRpb24gfHwgImRlZmF1bHQiIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJCQlwcm9taXNlID0gdGgoIHRyYW5zaXRpb24sIHJldmVyc2UsIHRvUGFnZSwgZnJvbVBhZ2UgKTsKCgkJcHJvbWlzZS5kb25lKGZ1bmN0aW9uKCkgewoKCQkJLy90cmlnZ2VyIHNob3cvaGlkZSBldmVudHMKCQkJaWYgKCBmcm9tUGFnZSApIHsKCQkJCWZyb21QYWdlLmRhdGEoICJwYWdlIiApLl90cmlnZ2VyKCAiaGlkZSIsIG51bGwsIHsgbmV4dFBhZ2U6IHRvUGFnZSB9ICk7CgkJCX0KCgkJCS8vdHJpZ2dlciBwYWdlc2hvdywgZGVmaW5lIHByZXZQYWdlIGFzIGVpdGhlciBmcm9tUGFnZSBvciBlbXB0eSBqUXVlcnkgb2JqCgkJCXRvUGFnZS5kYXRhKCAicGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCkgewoJCXZhciBhUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQlhUGFnZVBhZFQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLXRvcCIgKSApLAoJCQlhUGFnZVBhZEIgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApLAoJCQlhUGFnZUJvcmRlclQgPSBwYXJzZUZsb2F0KCBhUGFnZS5jc3MoICJib3JkZXItdG9wLXdpZHRoIiApICksCgkJCWFQYWdlQm9yZGVyQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKTsKCgkJYVBhZ2UuY3NzKCAibWluLWhlaWdodCIsIGdldFNjcmVlbkhlaWdodCgpIC0gYVBhZ2VQYWRUIC0gYVBhZ2VQYWRCIC0gYVBhZ2VCb3JkZXJUIC0gYVBhZ2VCb3JkZXJCICk7Cgl9CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICd3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kJywgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkvL2V4cG9zZSBwYXRoIG9iamVjdCBvbiAkLm1vYmlsZQoJJC5tb2JpbGUucGF0aCA9IHBhdGg7CgoJLy9leHBvc2UgYmFzZSBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLmJhc2UgPSBiYXNlOwoKCS8vaGlzdG9yeSBzdGFjawoJJC5tb2JpbGUudXJsSGlzdG9yeSA9IHVybEhpc3Rvcnk7CgoJJC5tb2JpbGUuZGlhbG9nSGFzaEtleSA9IGRpYWxvZ0hhc2hLZXk7CgoKCgkvL2VuYWJsZSBjcm9zcy1kb21haW4gcGFnZSBzdXBwb3J0CgkkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgPSBmYWxzZTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgdXJsCgkkLm1vYmlsZS5nZXREb2N1bWVudFVybCA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50VXJsICkgOiBkb2N1bWVudFVybC5ocmVmOwoJfTsKCgkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCSQubW9iaWxlLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIGRvY3VtZW50QmFzZSApIDogZG9jdW1lbnRCYXNlLmhyZWY7Cgl9OwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJwYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIGRldGVybWluZSB0aGUgY3VycmVudCBiYXNlIHVybAoJCQlmaW5kQmFzZVdpdGhEZWZhdWx0ID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgY2xvc2VzdEJhc2UgPSAoICQubW9iaWxlLmFjdGl2ZVBhZ2UgJiYgZ2V0Q2xvc2VzdEJhc2VVcmwoICQubW9iaWxlLmFjdGl2ZVBhZ2UgKSApOwoJCQkJcmV0dXJuIGNsb3Nlc3RCYXNlIHx8IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCQl9LAoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJLy8gdmVyc2lvbiBvZiB0aGUgVVJMIG1heSBjb250YWluIGRpYWxvZy9zdWJwYWdlIHBhcmFtcyBpbiBpdC4KCQkJYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCgkJLy8gSWYgdGhlIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4gaXMgYWxyZWFkeSBpbiB0aGUgRE9NLAoJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCS8vIHJlbG9hZCBvZiB0aGUgZmlsZSwgd2UgYXJlIGRvbmUuIE90aGVyd2lzZSwgdHJhY2sgdGhlCgkJLy8gZXhpc3RpbmcgcGFnZSBhcyBhIGR1cGxpY2F0ZWQuCgkJaWYgKCBwYWdlLmxlbmd0aCApIHsKCQkJaWYgKCAhc2V0dGluZ3MucmVsb2FkUGFnZSApIHsKCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIG9wdGlvbnMsIHBhZ2UgKTsKCQkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJCX0KCQkJZHVwQ2FjaGVkUGFnZSA9IHBhZ2U7CgkJfQoKCQl2YXIgbXBjID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciwKCQkJcGJsRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVsb2FkIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdXJsOiB1cmwsIGFic1VybDogYWJzVXJsLCBkYXRhVXJsOiBkYXRhVXJsLCBkZWZlcnJlZDogZGVmZXJyZWQsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBsb2FkIGEgcGFnZS4KCQltcGMudHJpZ2dlciggcGJsRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7CgkJfQoKCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJLy8gVGhpcyBjb25maWd1cmFibGUgdGltZW91dCBhbGxvd3MgY2FjaGVkIHBhZ2VzIGEgYnJpZWYgZGVsYXkgdG8gbG9hZCB3aXRob3V0IHNob3dpbmcgYSBtZXNzYWdlCgkJCXZhciBsb2FkTXNnRGVsYXkgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZygpOwoJCQkJfSwgc2V0dGluZ3MubG9hZE1zZ0RlbGF5ICksCgoJCQkJLy8gU2hhcmVkIGxvZ2ljIGZvciBjbGVhcmluZyB0aW1lb3V0IGFuZCByZW1vdmluZyBtZXNzYWdlLgoJCQkJaGlkZU1zZyA9IGZ1bmN0aW9uKCkgewoKCQkJCQkvLyBTdG9wIG1lc3NhZ2Ugc2hvdyB0aW1lcgoJCQkJCWNsZWFyVGltZW91dCggbG9hZE1zZ0RlbGF5ICk7CgoJCQkJCS8vIEhpZGUgbG9hZGluZyBtZXNzYWdlCgkJCQkJJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnKCk7CgkJCQl9OwoJCX0KCgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCWlmICggYmFzZSApIHsKCQkJYmFzZS5yZXNldCgpOwoJCX0KCgkJaWYgKCAhKCAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgfHwgcGF0aC5pc1NhbWVEb21haW4oIGRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCX0gZWxzZSB7CgkJCS8vIExvYWQgdGhlIG5ldyBwYWdlLgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogZnVuY3Rpb24oIGh0bWwsIHRleHRTdGF0dXMsIHhociApIHsKCQkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJCS8vdXNlIGl0IGFzIHRoZSBuZXcgZmlsZVVybCwgYmFzZSBwYXRoLCBldGMKCQkJCQl2YXIgYWxsID0gJCggIjxkaXY+PC9kaXY+IiApLAoKCQkJCQkJLy9wYWdlIHRpdGxlIHJlZ2V4cAoJCQkJCQluZXdQYWdlVGl0bGUgPSBodG1sLm1hdGNoKCAvPHRpdGxlW14+XSo+KFtePF0qKS8gKSAmJiBSZWdFeHAuJDEsCgoJCQkJCQkvLyBUT0RPIGhhbmRsZSBkaWFsb2dzIGFnYWluCgkJCQkJCXBhZ2VFbGVtUmVnZXggPSBuZXcgUmVnRXhwKCAiKDxbXj5dK1xcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgkJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmw9W1wiJ10/KFteXCInPl0qKVtcIiddPyIgKTsKCgoJCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cyBjYW4gYmUgZGlyZWN0ZWQgdG8gdGhlCgkJCQkJLy8gY29ycmVjdCB1cmwuIGxvYWRpbmcgaW50byBhIHRlbXByb3JhcnkgZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJCWlmICggcGFnZUVsZW1SZWdleC50ZXN0KCBodG1sICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCQkJZGF0YVVybFJlZ2V4LnRlc3QoIFJlZ0V4cC4kMSApICYmCgkJCQkJCQlSZWdFeHAuJDEgKSB7CgkJCQkJCXVybCA9IGZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCAkKCAiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIgKS50ZXh0KCkgKTsKCQkJCQl9CgoJCQkJCWlmICggYmFzZSApIHsKCQkJCQkJYmFzZS5zZXQoIGZpbGVVcmwgKTsKCQkJCQl9CgoJCQkJCS8vd29ya2Fyb3VuZCB0byBhbGxvdyBzY3JpcHRzIHRvIGV4ZWN1dGUgd2hlbiBpbmNsdWRlZCBpbiBwYWdlIGRpdnMKCQkJCQlhbGwuZ2V0KCAwICkuaW5uZXJIVE1MID0gaHRtbDsKCQkJCQlwYWdlID0gYWxsLmZpbmQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpcnN0KCk7CgoJCQkJCS8vaWYgcGFnZSBlbGVtIGNvdWxkbid0IGJlIGZvdW5kLCBjcmVhdGUgb25lIGFuZCBpbnNlcnQgdGhlIGJvZHkgZWxlbWVudCdzIGNvbnRlbnRzCgkJCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQkJCXBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz4iICsgaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdICsgIjwvZGl2PiIgKTsKCQkJCQl9CgoJCQkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCQkJaWYgKCB+bmV3UGFnZVRpdGxlLmluZGV4T2YoICImIiApICkgewoJCQkJCQkJbmV3UGFnZVRpdGxlID0gJCggIjxkaXY+IiArIG5ld1BhZ2VUaXRsZSArICI8L2Rpdj4iICkudGV4dCgpOwoJCQkJCQl9CgkJCQkJCXBhZ2UuanFtRGF0YSggInRpdGxlIiwgbmV3UGFnZVRpdGxlICk7CgkJCQkJfQoKCQkJCQkvL3Jld3JpdGUgc3JjIGFuZCBocmVmIGF0dHJzIHRvIHVzZSBhIGJhc2UgdXJsCgkJCQkJaWYgKCAhJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJCQl2YXIgbmV3UGF0aCA9IHBhdGguZ2V0KCBmaWxlVXJsICk7CgkJCQkJCXBhZ2UuZmluZCggIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiApLmVhY2goZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgdGhpc0F0dHIgPSAkKCB0aGlzICkuaXMoICdbaHJlZl0nICkgPyAnaHJlZicgOgoJCQkJCQkJCQkkKCB0aGlzICkuaXMoICdbc3JjXScgKSA/ICdzcmMnIDogJ2FjdGlvbicsCgkJCQkJCQkJdGhpc1VybCA9ICQoIHRoaXMgKS5hdHRyKCB0aGlzQXR0ciApOwoKCQkJCQkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBmaXggdGhpcyBzbyB0aGF0IGl0IHJlbW92ZXMgdGhlIGRvY3VtZW50CgkJCQkJCQkvLyAgICAgICAgICAgIGJhc2UgVVJMLCBhbmQgdGhlbiBwcmVwZW5kcyB3aXRoIHRoZSBuZXcgcGFnZSBVUkwuCgkJCQkJCQkvL2lmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgJy8vJyArIGxvY2F0aW9uLmhvc3QgKyBsb2NhdGlvbi5wYXRobmFtZSwgJycgKTsKCgkJCQkJCQlpZiAoICEvXihcdys6fCN8XC8pLy50ZXN0KCB0aGlzVXJsICkgKSB7CgkJCQkJCQkJJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyLCBuZXdQYXRoICsgdGhpc1VybCApOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgoJCQkJCS8vYXBwZW5kIHRvIHBhZ2UgYW5kIGVuaGFuY2UKCQkJCQkvLyBUT0RPIHRhZ2luZyBhIHBhZ2Ugd2l0aCBleHRlcm5hbCB0byBtYWtlIHN1cmUgdGhhdCBlbWJlZGRlZCBwYWdlcyBhcmVuJ3QgcmVtb3ZlZAoJCQkJCS8vICAgICAgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZSBpbiBtYW55CgkJCQkJLy8gICAgICBwbGFjZXMgaXMgYmFkLiBTb2x1dGlvbnMgcG9zdCAxLjAKCQkJCQlwYWdlCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBmaWxlVXJsICkgKQoJCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImV4dGVybmFsLXBhZ2UiLCB0cnVlICkKCQkJCQkJLmFwcGVuZFRvKCBzZXR0aW5ncy5wYWdlQ29udGFpbmVyICk7CgoJCQkJCS8vIHdhaXQgZm9yIHBhZ2UgY3JlYXRpb24gdG8gbGV2ZXJhZ2Ugb3B0aW9ucyBkZWZpbmVkIG9uIHdpZGdldAoJCQkJCXBhZ2Uub25lKCAncGFnZWNyZWF0ZScsICQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSApOwoKCQkJCQllbmhhbmNlUGFnZSggcGFnZSwgc2V0dGluZ3Mucm9sZSApOwoKCQkJCQkvLyBFbmhhbmNpbmcgdGhlIHBhZ2UgbWF5IHJlc3VsdCBpbiBuZXcgZGlhbG9ncy9zdWIgcGFnZXMgYmVpbmcgaW5zZXJ0ZWQKCQkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLXBhZ2UsIHRoYXQgaXMgdGhlCgkJCQkJLy8gcmVhbCBwYWdlIHdlIGFyZSBpbnRlcmVzdGVkIGluLgoJCQkJCWlmICggYWJzVXJsLmluZGV4T2YoICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSA+IC0xICkgewoJCQkJCQlwYWdlID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lci5jaGlsZHJlbiggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArInVybD0nIiArIGRhdGFVcmwgKyAiJ10iICk7CgkJCQkJfQoKCQkJCQkvL2JpbmQgcGFnZUhpZGUgdG8gcmVtb3ZlUGFnZSBhZnRlciBpdCdzIGhpZGRlbiwgaWYgdGhlIHBhZ2Ugb3B0aW9ucyBzcGVjaWZ5IHRvIGRvIHNvCgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYgKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKTsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBwYWdlQ29udGFpbmVyIHRvIHdvcmsgd2l0aC4KCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyID0gc2V0dGluZ3MucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIGZyb21QYWdlLgoJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgJC5tb2JpbGUuYWN0aXZlUGFnZTsKCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdG9QYWdlOiB0b1BhZ2UsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhYm91dCB0byBjaGFuZ2UgdGhlIGN1cnJlbnQgcGFnZS4KCQltcGMudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCWlmICggcGJjRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIFdlIGFsbG93ICJwYWdlYmVmb3JlY2hhbmdlIiBvYnNlcnZlcnMgdG8gbW9kaWZ5IHRoZSB0b1BhZ2UgaW4gdGhlIHRyaWdnZXIKCQkvLyBkYXRhIHRvIGFsbG93IGZvciByZWRpcmVjdHMuIE1ha2Ugc3VyZSBvdXIgdG9QYWdlIGlzIHVwZGF0ZWQuCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCgkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkvLyBvciB0cmFuc2l0aW9uaW5nLgoKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciICkgewoJCQkkLm1vYmlsZS5sb2FkUGFnZSggdG9QYWdlLCBzZXR0aW5ncyApCgkJCQkuZG9uZShmdW5jdGlvbiggdXJsLCBvcHRpb25zLCBuZXdQYWdlLCBkdXBDYWNoZWRQYWdlICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJCQlvcHRpb25zLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgPSBkdXBDYWNoZWRQYWdlOwoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIG5ld1BhZ2UsIG9wdGlvbnMgKTsKCQkJCX0pCgkJCQkuZmFpbChmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCgkJCQkJLy9jbGVhciBvdXQgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUKCQkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCgkJCQkJLy9yZWxlYXNlIHRyYW5zaXRpb24gbG9jayBzbyBuYXZpZ2F0aW9uIGlzIGZyZWUgYWdhaW4KCQkJCQlyZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQkJc2V0dGluZ3MucGFnZUNvbnRhaW5lci50cmlnZ2VyKCAicGFnZWNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCQl9KTsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gSWYgd2UgYXJlIGdvaW5nIHRvIHRoZSBmaXJzdC1wYWdlIG9mIHRoZSBhcHBsaWNhdGlvbiwgd2UgbmVlZCB0byBtYWtlCgkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCS8vIHVzIHRvIGF2b2lkIGdlbmVyYXRpbmcgYSBkb2N1bWVudCB1cmwgd2l0aCBhbiBpZCBoYXNoIGluIHRoZSBjYXNlIHdoZXJlIHRoZQoJCS8vIGZpcnN0LXBhZ2Ugb2YgdGhlIGRvY3VtZW50IGhhcyBhbiBpZCBhdHRyaWJ1dGUgc3BlY2lmaWVkLgoJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQlzZXR0aW5ncy5kYXRhVXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQl9CgoJCS8vIFRoZSBjYWxsZXIgcGFzc2VkIHVzIGEgcmVhbCBwYWdlIERPTSBlbGVtZW50LiBVcGRhdGUgb3VyCgkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJdmFyIGZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UsCgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIHNldHRpbmdzLmRhdGFVcmwgKSApIHx8IHRvUGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZCBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybCwKCQkJZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIHVybCApLAoJCQlhY3RpdmUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLAoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCwKCQkJaGlzdG9yeURpciA9IDAsCgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlLAoJCQlpc0RpYWxvZyA9IHNldHRpbmdzLnJvbGUgPT09ICJkaWFsb2ciIHx8IHRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyI7CgoJCS8vIEJ5IGRlZmF1bHQsIHdlIHByZXZlbnQgY2hhbmdlUGFnZSByZXF1ZXN0cyB3aGVuIHRoZSBmcm9tUGFnZSBhbmQgdG9QYWdlCgkJLy8gYXJlIHRoZSBzYW1lIGVsZW1lbnQsIGJ1dCBmb2xrcyB0aGF0IGdlbmVyYXRlIGNvbnRlbnQgbWFudWFsbHkvZHluYW1pY2FsbHkKCQkvLyBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cKCQkvLyB0aGlzLCB0aGV5IHdpbGwgbmVlZCB0byBjaGFuZ2UgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb24KCQkvLyB0byB0cnVlLCAqT1IqLCBwYXNzIGl0IGluIGFzIGFuIG9wdGlvbiB3aGVuIHRoZXkgbWFudWFsbHkgY2FsbCBjaGFuZ2VQYWdlKCkuCgkJLy8gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQgb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZQoJCS8vIGZvcm1QYWdlIGFuZCB0b1BhZ2UgYXJlIGRpZmZlcmVudCBlbGVtZW50cywgc28gdGhleSBtYXkgYmVoYXZlIHVuZXhwZWN0ZWRseS4KCQkvLyBJdCBpcyB1cCB0byB0aGUgZGV2ZWxvcGVyIHRoYXQgdHVybnMgb24gdGhlIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uYSBvcHRpb24KCQkvLyB0byBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCS8vIGFuaW1hdGlvbiB0cmFuc2l0aW9uIGlzIHVzZWQuCgkJaWYgKCBmcm9tUGFnZSAmJiBmcm9tUGFnZVswXSA9PT0gdG9QYWdlWzBdICYmICFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IGZhbHNlOwoJCQltcGMudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUgdXJsSGlzdG9yeSBpbiBzeW5jIHdpdGggdGhlIGhhc2ggY2hhbmdlcwoJCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQljdXJyZW50VXJsOgl1cmwsCgkJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7fSwKCQkJCQlpc0ZvcndhcmQ6CWZ1bmN0aW9uKCkge30KCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQl1cmxIaXN0b3J5LmRpcmVjdEhhc2hDaGFuZ2UoewoJCQkJY3VycmVudFVybDoJdXJsLAoJCQkJaXNCYWNrOgkJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAtMTsgfSwKCQkJCWlzRm9yd2FyZDoJZnVuY3Rpb24oKSB7IGhpc3RvcnlEaXIgPSAxOyB9CgkJCX0pOwoJCX0KCgkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIHN0b3AgY3Jhd2xpbmcgdGhlIGVudGlyZSBkb2N1bWVudCB0byBraWxsIGZvY3VzLiBJbnN0ZWFkLAoJCS8vICAgICAgICAgICAgd2Ugc2hvdWxkIGJlIHRyYWNraW5nIGZvY3VzIHdpdGggYSBkZWxlZ2F0ZSgpIGhhbmRsZXIgc28gd2UgYWxyZWFkeSBoYXZlCgkJLy8gICAgICAgICAgICB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMgcG9pbnQuCgkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQKCQkvLyBpcyB1bmRlZmluZWQgd2hlbiB3ZSBhcmUgaW4gYW4gSUZyYW1lLgoJCXRyeSB7CgkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdib2R5JyApIHsKCQkJCSQoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgKS5ibHVyKCk7CgkJCX0gZWxzZSB7CgkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQl9CgkJfSBjYXRjaCggZSApIHt9CgoJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJdmFyIGFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkvLyBJZiB3ZSdyZSBkaXNwbGF5aW5nIHRoZSBwYWdlIGFzIGEgZGlhbG9nLCB3ZSBkb24ndCB3YW50IHRoZSB1cmwKCQkvLyBmb3IgdGhlIGRpYWxvZyBjb250ZW50IHRvIGJlIHVzZWQgaW4gdGhlIGhhc2guIEluc3RlYWQsIHdlIHdhbnQKCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCWlmICggaXNEaWFsb2cgJiYgYWN0aXZlICkgewoJCQkvLyBvbiB0aGUgaW5pdGlhbCBwYWdlIGxvYWQgYWN0aXZlLnVybCBpcyB1bmRlZmluZWQgYW5kIGluIHRoYXQgY2FzZSBzaG91bGQKCQkJLy8gYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjayBpbnRvCgkJCS8vIHVybEhpc3RvcnkuYWRkTmV3IHNlZW1lZCBpbXBydWRlbnQgZ2l2ZW4gdW5kZWZpbmVkIGJldHRlciByZXByZXNlbnRzCgkJCS8vIHRoZSB1cmwgc3RhdGUKCgkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkvLyB0aGlzIHN0YXRlIHdpdGhvdXQgYWRkaW5nIHRvIHVybEhpc3RvcnkgYW5kIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBoYXNoLgoJCQkvLyBIb3dldmVyLCBpZiBhIGRpYWxvZyBpcyBhbHJlYWR5IGRpc3BsYXllZCBhdCB0aGlzIHBvaW50LCBhbmQgd2UncmUKCQkJLy8gYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2ggYW5kCgkJCS8vIGhpc3RvcnkgZW50cnkgb24gdG9wIHNvIHRoYXQgb25lIG1heSBuYXZpZ2F0ZSBiYWNrIHRvIHRoZSBvcmlnaW5hbCBkaWFsb2cKCQkJaWYgKCBhY3RpdmUudXJsLmluZGV4T2YoIGRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCX0KCgkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24gb2YgYSBzdGFsZSBkaWFsb2csCgkJCS8vIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICkgKyAoIGFscmVhZHlUaGVyZSA/ICIiIDogZGlhbG9nSGFzaEtleSApOwoKCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmICggc2V0dGluZ3MuY2hhbmdlSGFzaCAhPT0gZmFsc2UgJiYgdXJsICkgewoJCQkvL2Rpc2FibGUgaGFzaCBsaXN0ZW5pbmcgdGVtcG9yYXJpbHkKCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IHRydWU7CgkJCS8vdXBkYXRlIGhhc2ggYW5kIGhpc3RvcnkKCQkJcGF0aC5zZXQoIHVybCApOwoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkuZ2V0RW5jb2RlZFRleHQoKTsKCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCXBhZ2VUaXRsZSA9IG5ld1BhZ2VUaXRsZTsKCQl9CgkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIsIHBhZ2VUaXRsZSApOwoJCX0KCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJc2V0dGluZ3MudHJhbnNpdGlvbiA9IHNldHRpbmdzLnRyYW5zaXRpb24gfHwKCQkJKCAoIGhpc3RvcnlEaXIgJiYgIWFjdGl2ZUlzSW5pdGlhbFBhZ2UgKSA/IGFjdGl2ZS50cmFuc2l0aW9uIDogdW5kZWZpbmVkICkgfHwKCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCS8vYWRkIHBhZ2UgdG8gaGlzdG9yeSBzdGFjayBpZiBpdCdzIG5vdCBiYWNrIG9yIGZvcndhcmQKCQlpZiAoICFoaXN0b3J5RGlyICkgewoJCQkvLyBPdmVyd3JpdGUgdGhlIGN1cnJlbnQgZW50cnkgaWYgaXQncyBhIGxlZnRvdmVyIGZyb20gYSBkaWFsb2cKCQkJaWYgKCBhbHJlYWR5VGhlcmUgKSB7CgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID0gTWF0aC5tYXgoIDAsIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggLSAxICk7CgkJCX0KCQkJdXJsSGlzdG9yeS5hZGROZXcoIHVybCwgc2V0dGluZ3MudHJhbnNpdGlvbiwgcGFnZVRpdGxlLCBwYWdlVXJsLCBzZXR0aW5ncy5yb2xlICk7CgkJfQoKCQkvL3NldCBwYWdlIHRpdGxlCgkJZG9jdW1lbnQudGl0bGUgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnRpdGxlOwoKCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlCgkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJLy8gSWYgd2UncmUgbmF2aWdhdGluZyBiYWNrIGluIHRoZSBVUkwgaGlzdG9yeSwgc2V0IHJldmVyc2UgYWNjb3JkaW5nbHkuCgkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCXRyYW5zaXRpb25QYWdlcyggdG9QYWdlLCBmcm9tUGFnZSwgc2V0dGluZ3MudHJhbnNpdGlvbiwgc2V0dGluZ3MucmV2ZXJzZSApCgkJCS5kb25lKGZ1bmN0aW9uKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCBhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcygpOwoKCQkJCS8vaWYgdGhlcmUncyBhIGR1cGxpY2F0ZUNhY2hlZFBhZ2UsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gbm93IHRoYXQgaXQncyBoaWRkZW4KCQkJCWlmICggc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZSApIHsKCQkJCQlzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlLnJlbW92ZSgpOwoJCQkJfQoKCQkJCS8vIFNlbmQgZm9jdXMgdG8gdGhlIG5ld2x5IHNob3duIHBhZ2UuIE1vdmVkIGZyb20gcHJvbWlzZSAuZG9uZSBiaW5kaW5nIGluIHRyYW5zaXRpb25QYWdlcwoJCQkJLy8gaXRzZWxmIHRvIGF2b2lkIGllIGJ1ZyB0aGF0IHJlcG9ydHMgb2Zmc2V0V2lkdGggYXMgPiAwIChjb3JlIGNoZWNrIGZvciB2aXNpYmlsaXR5KQoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB3ZSdyZSBhbGwgZG9uZSBjaGFuZ2luZyB0aGUgY3VycmVudCBwYWdlLgoJCQkJbXBjLnRyaWdnZXIoICJwYWdlY2hhbmdlIiwgdHJpZ2dlckRhdGEgKTsKCQkJfSk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCi8qIEV2ZW50IEJpbmRpbmdzIC0gaGFzaGNoYW5nZSwgc3VibWl0LCBhbmQgY2xpY2sgKi8KCWZ1bmN0aW9uIGZpbmRDbG9zZXN0TGluayggZWxlICkKCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCS8vIFRoZSBiYXNlIFVSTCBmb3IgYW55IGdpdmVuIGVsZW1lbnQgZGVwZW5kcyBvbiB0aGUgcGFnZSBpdCByZXNpZGVzIGluLgoJZnVuY3Rpb24gZ2V0Q2xvc2VzdEJhc2VVcmwoIGVsZSApCgl7CgkJLy8gRmluZCB0aGUgY2xvc2VzdCBwYWdlIGFuZCBleHRyYWN0IG91dCBpdHMgdXJsLgoJCXZhciB1cmwgPSAkKCBlbGUgKS5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuanFtRGF0YSggInVybCIgKSwKCQkJYmFzZSA9IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoKCQlpZiAoICF1cmwgfHwgIXBhdGguaXNQYXRoKCB1cmwgKSApIHsKCQkJdXJsID0gYmFzZTsKCQl9CgoJCXJldHVybiBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCBiYXNlKTsKCX0KCgkvL1RoZSBmb2xsb3dpbmcgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvL3RoZSBmb2xsb3dpbmcgZGVmZXJyZWQgaXMgcmVzb2x2ZWQgaW4gdGhlIGluaXQgZmlsZQoJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKTsKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQuZG9uZShmdW5jdGlvbigpIHsKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoICEkLm1vYmlsZS5hamF4RW5hYmxlZCB8fAoJCQkJCS8vIHRlc3QgdGhhdCB0aGUgZm9ybSBpcywgaXRzZWxmLCBhamF4IGZhbHNlCgkJCQkJJHRoaXMuaXMoICI6anFtRGF0YShhamF4PSdmYWxzZScpIiApIHx8CgkJCQkJLy8gdGVzdCB0aGF0ICQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCBhbmQKCQkJCQkvLyB0aGUgZm9ybSBvciBvbmUgb2YgaXQncyBwYXJlbnRzIGlzIGFqYXg9ZmFsc2UKCQkJCQkhJHRoaXMuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIHR5cGUgPSAkdGhpcy5hdHRyKCAibWV0aG9kIiApLAoJCQkJdGFyZ2V0ID0gJHRoaXMuYXR0ciggInRhcmdldCIgKSwKCQkJCXVybCA9ICR0aGlzLmF0dHIoICJhY3Rpb24iICk7CgoJCQkvLyBJZiBubyBhY3Rpb24gaXMgc3BlY2lmaWVkLCBicm93c2VycyBkZWZhdWx0IHRvIHVzaW5nIHRoZQoJCQkvLyBVUkwgb2YgdGhlIGRvY3VtZW50IGNvbnRhaW5pbmcgdGhlIGZvcm0uIFNpbmNlIHdlIGR5bmFtaWNhbGx5CgkJCS8vIHB1bGwgaW4gcGFnZXMgZnJvbSBleHRlcm5hbCBkb2N1bWVudHMsIHRoZSBmb3JtIHNob3VsZCBzdWJtaXQKCQkJLy8gdG8gdGhlIFVSTCBmb3IgdGhlIHNvdXJjZSBkb2N1bWVudCBvZiB0aGUgcGFnZSBjb250YWluaW5nCgkJCS8vIHRoZSBmb3JtLgoJCQlpZiAoICF1cmwgKSB7CgkJCQkvLyBHZXQgdGhlIEBkYXRhLXVybCBmb3IgdGhlIHBhZ2UgY29udGFpbmluZyB0aGUgZm9ybS4KCQkJCXVybCA9IGdldENsb3Nlc3RCYXNlVXJsKCAkdGhpcyApOwoJCQkJaWYgKCB1cmwgPT09IGRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICkgewoJCQkJCS8vIFRoZSB1cmwgd2UgZ290IGJhY2sgbWF0Y2hlcyB0aGUgZG9jdW1lbnQgYmFzZSwKCQkJCQkvLyB3aGljaCBtZWFucyB0aGUgcGFnZSBtdXN0IGJlIGFuIGludGVybmFsL2VtYmVkZGVkIHBhZ2UsCgkJCQkJLy8gc28gZGVmYXVsdCB0byB1c2luZyB0aGUgYWN0dWFsIGRvY3VtZW50IHVybCBhcyBhIGJyb3dzZXIKCQkJCQkvLyB3b3VsZC4KCQkJCQl1cmwgPSBkb2N1bWVudFVybC5ocmVmTm9TZWFyY2g7CgkJCQl9CgkJCX0KCgkJCXVybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCAgdXJsLCBnZXRDbG9zZXN0QmFzZVVybCggJHRoaXMgKSApOwoKCQkJaWYgKCAoIHBhdGguaXNFeHRlcm5hbCggdXJsICkgJiYgIXBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCB1cmwgKSApIHx8IHRhcmdldCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSgKCQkJCXVybCwKCQkJCXsKCQkJCQl0eXBlOgkJdHlwZSAmJiB0eXBlLmxlbmd0aCAmJiB0eXBlLnRvTG93ZXJDYXNlKCkgfHwgImdldCIsCgkJCQkJZGF0YToJCSR0aGlzLnNlcmlhbGl6ZSgpLAoJCQkJCXRyYW5zaXRpb246CSR0aGlzLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCXJldmVyc2U6CSR0aGlzLmpxbURhdGEoICJkaXJlY3Rpb24iICkgPT09ICJyZXZlcnNlIiwKCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQl9CgkJCSk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vYWRkIGFjdGl2ZSBzdGF0ZSBvbiB2Y2xpY2sKCQkkKCBkb2N1bWVudCApLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIGlmIHRoaXMgaXNuJ3QgYSBsZWZ0IGNsaWNrIHdlIGRvbid0IGNhcmUuIEl0cyBpbXBvcnRhbnQgdG8gbm90ZQoJCQkvLyB0aGF0IHdoZW4gdGhlIHZpcnR1YWwgZXZlbnQgaXMgZ2VuZXJhdGVkIGl0IHdpbGwgY3JlYXRlIHRoZSB3aGljaCBhdHRyCgkJCWlmICggZXZlbnQud2hpY2ggPiAxIHx8ICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKTsKCgkJCS8vIHNwbGl0IGZyb20gdGhlIHByZXZpb3VzIHJldHVybiBsb2dpYyB0byBhdm9pZCBmaW5kIGNsb3Nlc3Qgd2hlcmUgcG9zc2libGUKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICEkKCBsaW5rICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBsaW5rICkgewoJCQkJaWYgKCBwYXRoLnBhcnNlVXJsKCBsaW5rLmdldEF0dHJpYnV0ZSggImhyZWYiICkgfHwgIiMiICkuaGFzaCAhPT0gIiMiICkgewoJCQkJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOwoJCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICQoIGxpbmsgKS5jbG9zZXN0KCAiLnVpLWJ0biIgKS5ub3QoICIudWktZGlzYWJsZWQiICk7CgkJCQkJJGFjdGl2ZUNsaWNrZWRMaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfQoJCQl9CgkJfSk7CgoJCS8vIGNsaWNrIHJvdXRpbmcgLSBkaXJlY3QgdG8gSFRUUCBvciBBamF4LCBhY2NvcmRpbmdseQoJCSQoIGRvY3VtZW50ICkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIGJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKSwKCgkJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdmFyIHVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKSwKCgkJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoIHBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJCggZG9jdW1lbnQgKS5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSA9IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCggaGFzaCApLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vICJuYXZpZ2F0ZSIgZXZlbnQgZmlyZWQgdG8gYWxsb3cgb3RoZXJzIHRvIHRha2UgYWR2YW50YWdlIG9mIHRoZSBtb3JlIHJvYnVzdCBoYXNoY2hhbmdlIGhhbmRsaW5nCgkJCQluYXZFdmVudCA9IG5ldyAkLkV2ZW50KCAibmF2aWdhdGUiICksCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nIHRoZSBjdXJyZW50IHN0YXRlCgkJCQkvLyBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gKCQkJCWNoYW5nZVBhZ2VPcHRpb25zID0gewoJCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX07CgoJCQlpZiAoIDAgPT09IHVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICkgewoJCQkJdXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gdG87CgkJCX0KCgkJCS8vIFdlIHNob3VsZCBwcm9iYWJseSBmaXJlIHRoZSAibmF2aWdhdGUiIGV2ZW50IGZyb20gdGhvc2UgcGxhY2VzIHRoYXQgbWFrZSBjYWxscyB0byBfaGFuZGxlSGFzaENoYW5nZSwKCQkJLy8gYW5kIGhhdmUgX2hhbmRsZUhhc2hDaGFuZ2UgaG9vayBpbnRvIHRoZSAibmF2aWdhdGUiIGV2ZW50IGluc3RlYWQgb2YgdHJpZ2dlcmluZyBpdCBoZXJlCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIudHJpZ2dlciggbmF2RXZlbnQgKTsKCQkJaWYgKCBuYXZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQgKGVpdGhlciBnbG9iYWxseSBvciB0ZW1wb3JhcmlseSksIG9yIGl0J3MgYSBkaWFsb2cgaGFzaAoJCQlpZiAoICEkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCB8fCB1cmxIaXN0b3J5Lmlnbm9yZU5leHRIYXNoQ2hhbmdlICkgewoJCQkJdXJsSGlzdG9yeS5pZ25vcmVOZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYgKCB1cmxIaXN0b3J5LnN0YWNrLmxlbmd0aCA+IDEgJiYgdG8uaW5kZXhPZiggZGlhbG9nSGFzaEtleSApID4gLTEgJiYgdXJsSGlzdG9yeS5pbml0aWFsRHN0ICE9PSB0byApIHsKCgkJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCQkvLyBpbiB0aGUgc2FtZSBkaXJlY3Rpb24KCQkJCWlmICggISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICkgewoJCQkJCS8vZGV0ZXJtaW5lIGlmIHdlJ3JlIGhlYWRpbmcgZm9yd2FyZCBvciBiYWNrd2FyZCBhbmQgY29udGludWUgYWNjb3JkaW5nbHkgcGFzdAoJCQkJCS8vdGhlIGN1cnJlbnQgZGlhbG9nCgkJCQkJdXJsSGlzdG9yeS5kaXJlY3RIYXNoQ2hhbmdlKHsKCQkJCQkJY3VycmVudFVybDogdG8sCgkJCQkJCWlzQmFjazogZnVuY3Rpb24oKSB7ICQubW9iaWxlLmJhY2soKTsgfSwKCQkJCQkJaXNGb3J3YXJkOiBmdW5jdGlvbigpIHsgd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOyB9CgkJCQkJfSk7CgoJCQkJCS8vIHByZXZlbnQgY2hhbmdlUGFnZSgpCgkJCQkJcmV0dXJuOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBpZiB0aGUgY3VycmVudCBhY3RpdmUgcGFnZSBpcyBhIGRpYWxvZyBhbmQgd2UncmUgbmF2aWdhdGluZwoJCQkJCS8vIHRvIGEgZGlhbG9nIHVzZSB0aGUgZGlhbG9nIG9iamVjdGVkIHNhdmVkIGluIHRoZSBzdGFjawoJCQkJCXVybEhpc3RvcnkuZGlyZWN0SGFzaENoYW5nZSh7CgkJCQkJCWN1cnJlbnRVcmw6IHRvLAoKCQkJCQkJLy8gcmVnYXJkbGVzcyBvZiB0aGUgZGlyZWN0aW9uIG9mIHRoZSBoaXN0b3J5IGNoYW5nZQoJCQkJCQkvLyBkbyB0aGUgZm9sbG93aW5nCgkJCQkJCWVpdGhlcjogZnVuY3Rpb24oIGlzQmFjayApIHsKCQkJCQkJCXZhciBhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpOwoKCQkJCQkJCXRvID0gYWN0aXZlLnBhZ2VVcmw7CgoJCQkJCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgcm9sZSwgdHJhbnNpdGlvbiBhbmQgcmV2ZXJzYWwKCQkJCQkJCS8vIGFzIG1vc3Qgb2YgdGhpcyBpcyBsb3N0IGJ5IHRoZSBkb21DYWNoZSBjbGVhbmluZwoJCQkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCQkJcm9sZTogYWN0aXZlLnJvbGUsCgkJCQkJCQkJdHJhbnNpdGlvbjogYWN0aXZlLnRyYW5zaXRpb24sCgkJCQkJCQkJcmV2ZXJzZTogaXNCYWNrCgkJCQkJCQl9KTsKCQkJCQkJfQoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gKCB0eXBlb2YgdG8gPT09ICJzdHJpbmciICYmICFwYXRoLmlzUGF0aCggdG8gKSApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEgcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50CgkJCQkvLyBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZCB1cCBpbiB0aGUgaW5pdGlhbCB1cmxIaXN0b3J5IGVudHJ5CgkJCQlpZiAoIHRvID09PSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdXJsSGlzdG9yeS5pbml0aWFsRHN0LCBkb2N1bWVudEJhc2UgKSAmJgoJCQkJCXVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICYmIHVybEhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9ICQubW9iaWxlLmZpcnN0UGFnZTsKCQkJCX0KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIHRvLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CWVsc2UgewoJCQkJLy90aGVyZSdzIG5vIGhhc2gsIGdvIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBkb20KCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoICQubW9iaWxlLmZpcnN0UGFnZSwgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQoJCX07CgoJCS8vaGFzaGNoYW5nZSBldmVudCBoYW5kbGVyCgkJJHdpbmRvdy5iaW5kKCAiaGFzaGNoYW5nZSIsIGZ1bmN0aW9uKCBlLCB0cmlnZ2VyZWQgKSB7CgkJCS8vIEZpcmVmb3ggYXV0by1lc2NhcGVzIHRoZSBsb2NhdGlvbi5oYXNoIGFzIGZvciB2MTMgYnV0CgkJCS8vIGxlYXZlcyB0aGUgaHJlZiB1bnRvdWNoZWQKCQkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UoIHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKTsKCQl9KTsKCgkJLy9zZXQgcGFnZSBtaW4taGVpZ2h0cyB0byBiZSBkZXZpY2Ugc3BlY2lmaWMKCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlc2hvdyIsIHJlc2V0QWN0aXZlUGFnZUhlaWdodCApOwoJCSQoIHdpbmRvdyApLmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCByZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9KTsvL25hdnJlYWR5RGVmZXJyZWQgZG9uZSBjYWxsYmFjawoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgkvLyBGb3Igbm93LCBsZXQncyBNb25rZXlwYXRjaCB0aGlzIG9udG8gdGhlIGVuZCBvZiAkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cwoJLy8gU2NvcGUgc2VsZiB0byBwdXNoU3RhdGVIYW5kbGVyIHNvIHdlIGNhbiByZWZlcmVuY2UgaXQgc2FuZWx5IHdpdGhpbiB0aGUKCS8vIG1ldGhvZHMgaGFuZGVkIG9mZiBhcyBldmVudCBoYW5kbGVycwoJdmFyCXB1c2hTdGF0ZUhhbmRsZXIgPSB7fSwKCQlzZWxmID0gcHVzaFN0YXRlSGFuZGxlciwKCQkkd2luID0gJCggd2luZG93ICksCgkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCksCgkJbW9iaWxlaW5pdERlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvbXJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJJCggZG9jdW1lbnQgKS5yZWFkeSggJC5wcm94eSggZG9tcmVhZHlEZWZlcnJlZCwgInJlc29sdmUiICkgKTsKCgkkKCBkb2N1bWVudCApLm9uZSggIm1vYmlsZWluaXQiLCAkLnByb3h5KCBtb2JpbGVpbml0RGVmZXJyZWQsICJyZXNvbHZlIiApICk7CgoJJC5leHRlbmQoIHB1c2hTdGF0ZUhhbmRsZXIsIHsKCQkvLyBUT0RPIG1vdmUgdG8gYSBwYXRoIGhlbHBlciwgdGhpcyBpcyByYXRoZXIgY29tbW9uIGZ1bmN0aW9uYWxpdHkKCQlpbml0aWFsRmlsZVBhdGg6IChmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHVybC5wYXRobmFtZSArIHVybC5zZWFyY2g7CgkJfSkoKSwKCgkJaGFzaENoYW5nZVRpbWVvdXQ6IDIwMCwKCgkJaGFzaENoYW5nZUVuYWJsZVRpbWVyOiB1bmRlZmluZWQsCgoJCWluaXRpYWxIcmVmOiB1cmwuaHJlZk5vSGFzaCwKCgkJc3RhdGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gewoJCQkJLy8gZmlyZWZveCBhdXRvIGRlY29kZXMgdGhlIHVybCB3aGVuIHVzaW5nIGxvY2F0aW9uLmhhc2ggYnV0IG5vdCBocmVmCgkJCQloYXNoOiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoIHx8ICIjIiArIHNlbGYuaW5pdGlhbEZpbGVQYXRoLAoJCQkJdGl0bGU6IGRvY3VtZW50LnRpdGxlLAoKCQkJCS8vIHBlcnNpc3QgYWNyb3NzIHJlZnJlc2gKCQkJCWluaXRpYWxIcmVmOiBzZWxmLmluaXRpYWxIcmVmCgkJCX07CgkJfSwKCgkJcmVzZXRVSUtleXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBkaWFsb2cgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LAoJCQkJc3Via2V5ID0gIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSwKCQkJCWRpYWxvZ0luZGV4ID0gdXJsLmluZGV4T2YoIGRpYWxvZyApOwoKCQkJaWYgKCBkaWFsb2dJbmRleCA+IC0xICkgewoJCQkJdXJsID0gdXJsLnNsaWNlKCAwLCBkaWFsb2dJbmRleCApICsgIiMiICsgdXJsLnNsaWNlKCBkaWFsb2dJbmRleCApOwoJCQl9IGVsc2UgaWYgKCB1cmwuaW5kZXhPZiggc3Via2V5ICkgPiAtMSApIHsKCQkJCXVybCA9IHVybC5zcGxpdCggc3Via2V5ICkuam9pbiggIiMiICsgc3Via2V5ICk7CgkJCX0KCgkJCXJldHVybiB1cmw7CgkJfSwKCgkJLy8gVE9ETyBzb3J0IG91dCBhIHNpbmdsZSBiYXJyaWVyIHRvIGhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eQoJCW5leHRIYXNoQ2hhbmdlUHJldmVudGVkOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCSQubW9iaWxlLnVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSB2YWx1ZTsKCQkJc2VsZi5vbkhhc2hDaGFuZ2VEaXNhYmxlZCA9IHZhbHVlOwoJCX0sCgoJCS8vIG9uIGhhc2ggY2hhbmdlIHdlIHdhbnQgdG8gY2xlYW4gdXAgdGhlIHVybAoJCS8vIE5PVEUgdGhpcyB0YWtlcyBwbGFjZSAqYWZ0ZXIqIHRoZSB2YW5pbGxhIG5hdmlnYXRpb24gaGFzaCBjaGFuZ2UKCQkvLyBoYW5kbGluZyBoYXMgdGFrZW4gcGxhY2UgYW5kIHNldCB0aGUgc3RhdGUgb2YgdGhlIERPTQoJCW9uSGFzaENoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCS8vIGRpc2FibGUgdGhpcyBoYXNoIGNoYW5nZQoJCQlpZiAoIHNlbGYub25IYXNoQ2hhbmdlRGlzYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBocmVmLCBzdGF0ZSwKCQkJCS8vIGZpcmVmb3ggYXV0byBkZWNvZGVzIHRoZSB1cmwgd2hlbiB1c2luZyBsb2NhdGlvbi5oYXNoIGJ1dCBub3QgaHJlZgoJCQkJaGFzaCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gsCgkJCQlpc1BhdGggPSAkLm1vYmlsZS5wYXRoLmlzUGF0aCggaGFzaCApLAoJCQkJcmVzb2x1dGlvblVybCA9IGlzUGF0aCA/ICQubW9iaWxlLnBhdGguZ2V0TG9jYXRpb24oKSA6ICQubW9iaWxlLmdldERvY3VtZW50VXJsKCk7CgoJCQloYXNoID0gaXNQYXRoID8gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkgOiBoYXNoOwoKCgkJCS8vIHByb3B1bGF0ZSB0aGUgaGFzaCB3aGVuIGl0cyBub3QgYXZhaWxhYmxlCgkJCXN0YXRlID0gc2VsZi5zdGF0ZSgpOwoKCQkJLy8gbWFrZSB0aGUgaGFzaCBhYm9sdXRlIHdpdGggdGhlIGN1cnJlbnQgaHJlZgoJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhhc2gsIHJlc29sdXRpb25VcmwgKTsKCgkJCWlmICggaXNQYXRoICkgewoJCQkJaHJlZiA9IHNlbGYucmVzZXRVSUtleXMoIGhyZWYgKTsKCQkJfQoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJaGlzdG9yeS5yZXBsYWNlU3RhdGUoIHN0YXRlLCBkb2N1bWVudC50aXRsZSwgaHJlZiApOwoJCX0sCgoJCS8vIG9uIHBvcHN0YXRlIChpZSBiYWNrIG9yIGZvcndhcmQpIHdlIG5lZWQgdG8gcmVwbGFjZSB0aGUgaGFzaCB0aGF0IHdhcyB0aGVyZSBwcmV2aW91c2x5CgkJLy8gY2xlYW5lZCB1cCBieSB0aGUgYWRkaXRpb25hbCBoYXNoIGhhbmRsaW5nCgkJb25Qb3BTdGF0ZTogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciBwb3BwZWRTdGF0ZSA9IGUub3JpZ2luYWxFdmVudC5zdGF0ZSwKCQkJCWZyb21IYXNoLCB0b0hhc2gsIGhhc2hDaGFuZ2VkOwoKCQkJLy8gaWYgdGhlcmUncyBubyBzdGF0ZSBpdHMgbm90IGEgcG9wc3RhdGUgd2UgY2FyZSBhYm91dCwgZWcgY2hyb21lJ3MgaW5pdGlhbCBwb3BzdGF0ZQoJCQlpZiAoIHBvcHBlZFN0YXRlICkgewoJCQkJLy8gaWYgd2UgZ2V0IHR3byBwb3Agc3RhdGVzIGluIHVuZGVyIHRoaXMuaGFzaENoYW5nZVRpbWVvdXQKCQkJCS8vIG1ha2Ugc3VyZSB0byBjbGVhciBhbnkgdGltZXIgc2V0IGZvciB0aGUgcHJldmlvdXMgY2hhbmdlCgkJCQljbGVhclRpbWVvdXQoIHNlbGYuaGFzaENoYW5nZUVuYWJsZVRpbWVyICk7CgoJCQkJLy8gbWFrZSBzdXJlIHRvIGVuYWJsZSBoYXNoIGhhbmRsaW5nIGZvciB0aGUgdGhlIF9oYW5kbGVIYXNoQ2hhbmdlIGNhbGwKCQkJCXNlbGYubmV4dEhhc2hDaGFuZ2VQcmV2ZW50ZWQoIGZhbHNlICk7CgoJCQkJLy8gY2hhbmdlIHRoZSBwYWdlIGJhc2VkIG9uIHRoZSBoYXNoIGluIHRoZSBwb3BwZWQgc3RhdGUKCQkJCSQubW9iaWxlLl9oYW5kbGVIYXNoQ2hhbmdlKCBwb3BwZWRTdGF0ZS5oYXNoICk7CgoJCQkJLy8gcHJldmVudCBhbnkgaGFzaGNoYW5nZSBpbiB0aGUgbmV4dCBzZWxmLmhhc2hDaGFuZ2VUaW1lb3V0CgkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCB0cnVlICk7CgoJCQkJLy8gcmUtZW5hYmxlIGhhc2ggY2hhbmdlIGhhbmRsaW5nIGFmdGVyIHN3YWxsb3dpbmcgYSBwb3NzaWJsZSBoYXNoCgkJCQkvLyBjaGFuZ2UgZXZlbnQgdGhhdCBjb21lcyBvbiBhbGwgcG9wc3RhdGVzIGNvdXJ0ZXN5IG9mIGJyb3dzZXJzIGxpa2UgQW5kcm9pZAoJCQkJc2VsZi5oYXNoQ2hhbmdlRW5hYmxlVGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLm5leHRIYXNoQ2hhbmdlUHJldmVudGVkKCBmYWxzZSApOwoJCQkJfSwgc2VsZi5oYXNoQ2hhbmdlVGltZW91dCApOwoJCQl9CgkJfSwKCgkJaW5pdDogZnVuY3Rpb24oKSB7CgkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UiLCBzZWxmLm9uSGFzaENoYW5nZSApOwoKCQkJLy8gSGFuZGxlIHBvcHN0YXRlIGV2ZW50cyB0aGUgb2NjdXIgdGhyb3VnaCBoaXN0b3J5IGNoYW5nZXMKCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUiLCBzZWxmLm9uUG9wU3RhdGUgKTsKCgkJCS8vIGlmIHRoZXJlJ3Mgbm8gaGFzaCwgd2UgbmVlZCB0byByZXBsYWNlc3RhdGUgZm9yIHJldHVybmluZyB0byBob21lCgkJCWlmICggbG9jYXRpb24uaGFzaCA9PT0gIiIgKSB7CgkJCQloaXN0b3J5LnJlcGxhY2VTdGF0ZSggc2VsZi5zdGF0ZSgpLCBkb2N1bWVudC50aXRsZSwgJC5tb2JpbGUucGF0aC5nZXRMb2NhdGlvbigpICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBXZSBuZWVkIHRvIGluaXQgd2hlbiAibW9iaWxlaW5pdCIsICJkb21yZWFkeSIsIGFuZCAibmF2cmVhZHkiIGhhdmUgYWxsIGhhcHBlbmVkCgkkLndoZW4oIGRvbXJlYWR5RGVmZXJyZWQsIG1vYmlsZWluaXREZWZlcnJlZCwgJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZCApLmRvbmUoZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkICYmICQuc3VwcG9ydC5wdXNoU3RhdGUgKSB7CgkJCXB1c2hTdGF0ZUhhbmRsZXIuaW5pdCgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsaXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsaXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBwb3AgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnBvcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFVzZSB0aGUgc2ltdWx0YW5lb3VzIHRyYW5zaXRpb25zIGhhbmRsZXIgZm9yIHNsaWRlIHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zbGlkZSA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycy5zaW11bHRhbmVvdXM7CgovLyBTZXQgdGhlIHNsaWRlIHRyYW5zaXRpb25zJ3MgZmFsbGJhY2sgdG8gImZhZGUiCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVmYWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlZmFkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBzbGlkZXVwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZXVwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuZGVncmFkZUlucHV0cyA9IHsKCWNvbG9yOiBmYWxzZSwKCWRhdGU6IGZhbHNlLAoJZGF0ZXRpbWU6IGZhbHNlLAoJImRhdGV0aW1lLWxvY2FsIjogZmFsc2UsCgllbWFpbDogZmFsc2UsCgltb250aDogZmFsc2UsCgludW1iZXI6IGZhbHNlLAoJcmFuZ2U6ICJudW1iZXIiLAoJc2VhcmNoOiAidGV4dCIsCgl0ZWw6IGZhbHNlLAoJdGltZTogZmFsc2UsCgl1cmw6IGZhbHNlLAoJd2VlazogZmFsc2UKfTsKCgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgl2YXIgcGFnZSA9ICQubW9iaWxlLmNsb3Nlc3RQYWdlRGF0YSggJCggZS50YXJnZXQgKSApLCBvcHRpb25zOwoKCWlmICggIXBhZ2UgKSB7CgkJcmV0dXJuOwoJfQoKCW9wdGlvbnMgPSBwYWdlLm9wdGlvbnM7CgoJLy8gZGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5CgkkKCBlLnRhcmdldCApLmZpbmQoICJpbnB1dCIgKS5ub3QoIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJdHlwZSA9IHRoaXMuZ2V0QXR0cmlidXRlKCAidHlwZSIgKSwKCQkJb3B0VHlwZSA9IG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IjsKCgkJaWYgKCBvcHRpb25zLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJdmFyIGh0bWwgPSAkKCAiPGRpdj4iICkuaHRtbCggJHRoaXMuY2xvbmUoKSApLmh0bWwoKSwKCQkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQkJaGFzVHlwZSA9IGh0bWwuaW5kZXhPZiggIiB0eXBlPSIgKSA+IC0xLAoJCQkJZmluZHN0ciA9IGhhc1R5cGUgPyAvXHMrdHlwZT1bIiddP1x3K1snIl0/LyA6IC9cLz8+LywKCQkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJJHRoaXMucmVwbGFjZVdpdGgoIGh0bWwucmVwbGFjZSggZmluZHN0ciwgcmVwc3RyICkgKTsKCQl9Cgl9KTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWNsb3NlQnRuVGV4dDogIkNsb3NlIiwKCQlvdmVybGF5VGhlbWU6ICJhIiwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHRoaXMuZWxlbWVudCwKCQkJaGVhZGVyQ2xvc2VCdXR0b24gPSAkKCAiPGEgaHJlZj0nIycgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nZGVsZXRlJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zPSdub3RleHQnPiIrIHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgKyAiPC9hPiIgKSwKCQkJZGlhbG9nV3JhcCA9ICQoICI8ZGl2Lz4iLCB7CgkJCQkJInJvbGUiIDogImRpYWxvZyIsCgkJCQkJImNsYXNzIiA6ICJ1aS1kaWFsb2ctY29udGFpbiB1aS1jb3JuZXItYWxsIHVpLW92ZXJsYXktc2hhZG93IgoJCQkJfSk7CgoJCSRlbC5hZGRDbGFzcyggInVpLWRpYWxvZyB1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICk7CgoJCS8vIENsYXNzIHRoZSBtYXJrdXAgZm9yIGRpYWxvZyBzdHlsaW5nCgkJLy8gU2V0IGFyaWEgcm9sZQoJCSRlbAoJCQkud3JhcElubmVyKCBkaWFsb2dXcmFwICkKCQkJLmNoaWxkcmVuKCkKCQkJCS5maW5kKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkKCQkJCQkucHJlcGVuZCggaGVhZGVyQ2xvc2VCdXR0b24gKQoJCQkJLmVuZCgpCgkJCQkuY2hpbGRyZW4oICc6Zmlyc3QtY2hpbGQnKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCS5lbmQoKQoJCQkJLmNoaWxkcmVuKCAiOmxhc3QtY2hpbGQiICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApOwoKCQkvLyB0aGlzIG11c3QgYmUgYW4gYW5vbnltb3VzIGZ1bmN0aW9uIHNvIHRoYXQgc2VsZWN0IG1lbnUgZGlhbG9ncyBjYW4gcmVwbGFjZQoJCS8vIHRoZSBjbG9zZSBtZXRob2QuIFRoaXMgaXMgYSBjaGFuZ2UgZnJvbSBwcmV2aW91c2x5IGp1c3QgZGVmaW5pbmcgZGF0YS1yZWw9YmFjawoJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCS8vCgkJLy8gVXNlIGNsaWNrIHJhdGhlciB0aGFuIHZjbGljayBpbiBvcmRlciB0byBwcmV2ZW50IHRoZSBwb3NzaWJpbGl0eSBvZiB1bmludGVudGlvbmFsbHkKCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQloZWFkZXJDbG9zZUJ1dHRvbi5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJc2VsZi5jbG9zZSgpOwoJCX0pOwoKCQkvKiBiaW5kIGV2ZW50cwoJCQktIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nIG9wZW5lZCB3aXRoCgkJCQl1bmxlc3MgYSBkYXRhLXRyYW5zaXRpb24gaXMgc3BlY2lmaWVkIG9uIHRoZSBsaW5rL2Zvcm0KCQkJLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIiBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CgkJKi8KCQkkZWwuYmluZCggInZjbGljayBzdWJtaXQiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKSwKCQkJCWFjdGl2ZTsKCgkJCWlmICggJHRhcmdldC5sZW5ndGggJiYgISR0YXJnZXQuanFtRGF0YSggInRyYW5zaXRpb24iICkgKSB7CgoJCQkJYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fTsKCgkJCQkkdGFyZ2V0LmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiwgKCBhY3RpdmUudHJhbnNpdGlvbiB8fCAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbiApICkKCQkJCQkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImRpcmVjdGlvbiIsICJyZXZlcnNlIiApOwoJCQl9CgkJfSkKCQkuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oIGUsIHVpICkgewoJCQkkKCB0aGlzICkuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKS5ub3QoICIudWktc2xpZGVyLWJnIiApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0pCgkJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCQkuYmluZCggInBhZ2ViZWZvcmVzaG93IiwgZnVuY3Rpb24oKSB7CgkJCXNlbGYuX2lzQ2xvc2VhYmxlID0gdHJ1ZTsKCQkJaWYgKCBzZWxmLm9wdGlvbnMub3ZlcmxheVRoZW1lICkgewoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLnBhZ2UoICJyZW1vdmVDb250YWluZXJCYWNrZ3JvdW5kIiApCgkJCQkJLnBhZ2UoICJzZXRDb250YWluZXJCYWNrZ3JvdW5kIiwgc2VsZi5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIENsb3NlIG1ldGhvZCBnb2VzIGJhY2sgaW4gaGlzdG9yeQoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCXZhciBkc3Q7CgoJCWlmICggdGhpcy5faXNDbG9zZWFibGUgKSB7CgkJCXRoaXMuX2lzQ2xvc2VhYmxlID0gZmFsc2U7CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlkc3QgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldFByZXYoKS51cmw7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAicGFnZWNyZWF0ZSIsIGZ1bmN0aW9uKCkgewoJJC5tb2JpbGUuZGlhbG9nLnByb3RvdHlwZS5lbmhhbmNlKCB0aGlzICk7Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UZXh0ICA9ICJCYWNrIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5hZGRCYWNrQnRuICAgPSBmYWxzZTsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5iYWNrQnRuVGhlbWUgPSBudWxsOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmhlYWRlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5mb290ZXJUaGVtZSAgPSAiYSI7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuY29udGVudFRoZW1lID0gbnVsbDsKCi8vIE5PVEUgYmluZCB1c2VkIHRvIGZvcmNlIHRoaXMgYmluZGluZyB0byBydW4gYmVmb3JlIHRoZSBidXR0b25NYXJrdXAgYmluZGluZwovLyAgICAgIHdoaWNoIGV4cGVjdHMgLnVpLWZvb3RlciB0b3AgYmUgYXBwbGllZCBpbiBpdHMgZ2lnYW50aWMgc2VsZWN0b3IKLy8gVE9ETyByZW1vdmUgdGhlIGJ1dHRvbk1hcmt1cCBnaWFudCBzZWxlY3RvciBhbmQgbW92ZSBpdCB0byB0aGUgdmFyaW91cyBtb2R1bGVzCi8vICAgICAgb24gd2hpY2ggaXQgZGVwZW5kcwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLAoJCXBhZ2VSb2xlID0gJHBhZ2UuanFtRGF0YSggInJvbGUiICksCgkJcGFnZVRoZW1lID0gby50aGVtZTsKCgkkKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJyksIDpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdjb250ZW50JykiLCAkcGFnZSApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlyb2xlID0gJHRoaXMuanFtRGF0YSggInJvbGUiICksCgkJCXRoZW1lID0gJHRoaXMuanFtRGF0YSggInRoZW1lIiApLAoJCQljb250ZW50VGhlbWUgPSB0aGVtZSB8fCBvLmNvbnRlbnRUaGVtZSB8fCAoIHBhZ2VSb2xlID09PSAiZGlhbG9nIiAmJiBwYWdlVGhlbWUgKSwKCQkJJGhlYWRlcmFuY2hvcnMsCgkJCWxlZnRidG4sCgkJCXJpZ2h0YnRuLAoJCQliYWNrQnRuOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgoJCS8vYXBwbHkgdGhlbWluZyBhbmQgbWFya3VwIG1vZGlmaWNhdGlvbnMgdG8gcGFnZSxoZWFkZXIsY29udGVudCxmb290ZXIKCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiIHx8IHJvbGUgPT09ICJmb290ZXIiICkgewoKCQkJdmFyIHRoaXNUaGVtZSA9IHRoZW1lIHx8ICggcm9sZSA9PT0gImhlYWRlciIgPyBvLmhlYWRlclRoZW1lIDogby5mb290ZXJUaGVtZSApIHx8IHBhZ2VUaGVtZTsKCgkJCSR0aGlzCgkJCQkvL2FkZCB0aGVtZSBjbGFzcwoJCQkJLmFkZENsYXNzKCAidWktYmFyLSIgKyB0aGlzVGhlbWUgKQoJCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkJLmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKTsKCgkJCWlmICggcm9sZSA9PT0gImhlYWRlciIpIHsKCQkJCS8vIFJpZ2h0LGxlZnQgYnV0dG9ucwoJCQkJJGhlYWRlcmFuY2hvcnMJPSAkdGhpcy5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJCWxlZnRidG4JPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1sZWZ0IiApOwoJCQkJcmlnaHRidG4gPSAkaGVhZGVyYW5jaG9ycy5oYXNDbGFzcyggInVpLWJ0bi1yaWdodCIgKTsKCgkJCQlsZWZ0YnRuID0gbGVmdGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMCApLm5vdCggIi51aS1idG4tcmlnaHQiICkuYWRkQ2xhc3MoICJ1aS1idG4tbGVmdCIgKS5sZW5ndGg7CgoJCQkJcmlnaHRidG4gPSByaWdodGJ0biB8fCAkaGVhZGVyYW5jaG9ycy5lcSggMSApLmFkZENsYXNzKCAidWktYnRuLXJpZ2h0IiApLmxlbmd0aDsKCQkJfQoKCQkJLy8gQXV0by1hZGQgYmFjayBidG4gb24gcGFnZXMgYmV5b25kIGZpcnN0IHZpZXcKCQkJaWYgKCBvLmFkZEJhY2tCdG4gJiYKCQkJCXJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkkKCAiLnVpLXBhZ2UiICkubGVuZ3RoID4gMSAmJgoJCQkJJHBhZ2UuanFtRGF0YSggInVybCIgKSAhPT0gJC5tb2JpbGUucGF0aC5zdHJpcEhhc2goIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJIWxlZnRidG4gKSB7CgoJCQkJYmFja0J0biA9ICQoICI8YSBocmVmPSdqYXZhc2NyaXB0OnZvaWQoMCk7JyBjbGFzcz0ndWktYnRuLWxlZnQnIGRhdGEtIisgJC5tb2JpbGUubnMgKyJyZWw9J2JhY2snIGRhdGEtIisgJC5tb2JpbGUubnMgKyJpY29uPSdhcnJvdy1sJz4iKyBvLmJhY2tCdG5UZXh0ICsiPC9hPiIgKQoJCQkJCS8vIElmIHRoZW1lIGlzIHByb3ZpZGVkLCBvdmVycmlkZSBkZWZhdWx0IGluaGVyaXRhbmNlCgkJCQkJLmF0dHIoICJkYXRhLSIrICQubW9iaWxlLm5zICsidGhlbWUiLCBvLmJhY2tCdG5UaGVtZSB8fCB0aGlzVGhlbWUgKQoJCQkJCS5wcmVwZW5kVG8oICR0aGlzICk7CgkJCX0KCgkJCS8vIFBhZ2UgdGl0bGUKCQkJJHRoaXMuY2hpbGRyZW4oICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS10aXRsZSIgKQoJCQkJLy8gUmVnYXJkbGVzcyBvZiBoIGVsZW1lbnQgbnVtYmVyIGluIHNyYywgaXQgYmVjb21lcyBoMSBmb3IgdGhlIGVuaGFuY2VkIHBhZ2UKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJoZWFkaW5nIiwKCQkJCQkiYXJpYS1sZXZlbCI6ICIxIgoJCQkJfSk7CgoJCX0gZWxzZSBpZiAoIHJvbGUgPT09ICJjb250ZW50IiApIHsKCQkJaWYgKCBjb250ZW50VGhlbWUgKSB7CgkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWJvZHktIiArICggY29udGVudFRoZW1lICkgKTsKCQkJfQoKCQkJLy8gQWRkIEFSSUEgcm9sZQoJCQkkdGhpcy5hdHRyKCAicm9sZSIsICJtYWluIiApOwoJCX0KCX0pOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gZmlsdGVyIGZ1bmN0aW9uIHJlbW92ZXMgd2hpdGVzcGFjZSBiZXR3ZWVuIGxhYmVsIGFuZCBmb3JtIGVsZW1lbnQgc28gd2UgY2FuIHVzZSBpbmxpbmUtYmxvY2sgKG5vZGVUeXBlIDMgPSB0ZXh0KQokLmZuLmZpZWxkY29udGFpbiA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMKCQkuYWRkQ2xhc3MoICJ1aS1maWVsZC1jb250YWluIHVpLWJvZHkgdWktYnIiICkKCQkuY29udGVudHMoKS5maWx0ZXIoIGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gKCB0aGlzLm5vZGVUeXBlID09PSAzICYmICEvXFMvLnRlc3QoIHRoaXMubm9kZVZhbHVlICkgKTsKCQl9KS5yZW1vdmUoKTsKfTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJCggIjpqcW1EYXRhKHJvbGU9J2ZpZWxkY29udGFpbicpIiwgZS50YXJnZXQgKS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5mbi5ncmlkID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoKCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCW8gPSAkLmV4dGVuZCh7CgkJCQlncmlkOiBudWxsCgkJCX0sIG9wdGlvbnMgKSwKCQkJJGtpZHMgPSAkdGhpcy5jaGlsZHJlbigpLAoJCQlncmlkQ29scyA9IHsgc29sbzoxLCBhOjIsIGI6MywgYzo0LCBkOjUgfSwKCQkJZ3JpZCA9IG8uZ3JpZCwKCQkJaXRlcmF0b3I7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCB2YXIgbGV0dGVyIGluIGdyaWRDb2xzICkgewoJCQkJCQlpZiAoIGdyaWRDb2xzWyBsZXR0ZXIgXSA9PT0gJGtpZHMubGVuZ3RoICkgewoJCQkJCQkJZ3JpZCA9IGxldHRlcjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJZ3JpZCA9ICJhIjsKCQkJCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtZHVvIiApOwoJCQkJfQoJCQl9CgkJCWl0ZXJhdG9yID0gZ3JpZENvbHNbZ3JpZF07CgoJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC0iICsgZ3JpZCApOwoKCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzEpIiApLmFkZENsYXNzKCAidWktYmxvY2stYSIgKTsKCgkJaWYgKCBpdGVyYXRvciA+IDEgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMikiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1iIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMiApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibiszKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWMiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAzICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzQpIiApLmFkZENsYXNzKCAidWktYmxvY2stZCIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDQgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1lIiApOwoJCX0KCX0pOwp9Owp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7CgkKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uYnV0dG9uTWFya3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7Cgl2YXIgJHdvcmtpbmdTZXQgPSB0aGlzLAoJCW1hcFRvRGF0YUF0dHIgPSBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJZS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGtleSwgdmFsdWUgKTsKCQkJZWwuanFtRGF0YSgga2V5LCB2YWx1ZSApOwoJCX07CgoJLy8gRW5mb3JjZSBvcHRpb25zIHRvIGJlIG9mIHR5cGUgc3RyaW5nCglvcHRpb25zID0gKCBvcHRpb25zICYmICggJC50eXBlKCBvcHRpb25zICkgPT09ICJvYmplY3QiICkgKT8gb3B0aW9ucyA6IHt9OwoJZm9yICggdmFyIGkgPSAwOyBpIDwgJHdvcmtpbmdTZXQubGVuZ3RoOyBpKysgKSB7CgkJdmFyIGVsID0gJHdvcmtpbmdTZXQuZXEoIGkgKSwKCQkJZSA9IGVsWyAwIF0sCgkJCW8gPSAkLmV4dGVuZCgge30sICQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzLCB7CgkJCQlpY29uOiAgICAgICBvcHRpb25zLmljb24gICAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbiAgICAgICA6IGVsLmpxbURhdGEoICJpY29uIiApLAoJCQkJaWNvbnBvczogICAgb3B0aW9ucy5pY29ucG9zICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25wb3MgICAgOiBlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZWwuanFtRGF0YSggInRoZW1lIiApIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICksCgkJCQlpbmxpbmU6ICAgICBvcHRpb25zLmlubGluZSAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaW5saW5lICAgICA6IGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCQlzaGFkb3c6ICAgICBvcHRpb25zLnNoYWRvdyAgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuc2hhZG93ICAgICA6IGVsLmpxbURhdGEoICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGVsLmpxbURhdGEoICJjb3JuZXJzIiApLAoJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93ICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb25zaGFkb3cgOiBlbC5qcW1EYXRhKCAiaWNvbnNoYWRvdyIgKSwKCQkJCW1pbmk6ICAgICAgIG9wdGlvbnMubWluaSAgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5taW5pICAgICAgIDogZWwuanFtRGF0YSggIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJLy8gQnV0dG9uIGlubmVyIG1hcmt1cAoJCQlidXR0b25Jbm5lciwKCQkJYnV0dG9uVGV4dCwKCQkJYnV0dG9uSWNvbiwKCQkJYnV0dG9uRWxlbWVudHM7CgoJCSQuZWFjaCggbywgbWFwVG9EYXRhQXR0ciApOwoKCQlpZiAoIGVsLmpxbURhdGEoICJyZWwiICkgPT09ICJwb3B1cCIgJiYgZWwuYXR0ciggImhyZWYiICkgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBlLmdldEF0dHJpYnV0ZSggImhyZWYiICkgKTsKCQl9CgoJCS8vIENoZWNrIGlmIHRoaXMgZWxlbWVudCBpcyBhbHJlYWR5IGVuaGFuY2VkCgkJYnV0dG9uRWxlbWVudHMgPSAkLmRhdGEoICggKCBlLnRhZ05hbWUgPT09ICJJTlBVVCIgfHwgZS50YWdOYW1lID09PSAiQlVUVE9OIiApID8gZS5wYXJlbnROb2RlIDogZSApLCAiYnV0dG9uRWxlbWVudHMiICk7CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWUgPSBidXR0b25FbGVtZW50cy5vdXRlcjsKCQkJZWwgPSAkKCBlICk7CgkJCWJ1dHRvbklubmVyID0gYnV0dG9uRWxlbWVudHMuaW5uZXI7CgkJCWJ1dHRvblRleHQgPSBidXR0b25FbGVtZW50cy50ZXh0OwoJCQkvLyBXZSB3aWxsIHJlY3JlYXRlIHRoaXMgaWNvbiBiZWxvdwoJCQkkKCBidXR0b25FbGVtZW50cy5pY29uICkucmVtb3ZlKCk7CgkJCWJ1dHRvbkVsZW1lbnRzLmljb24gPSBudWxsOwoJCX0KCQllbHNlIHsKCQkJYnV0dG9uSW5uZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCBvLndyYXBwZXJFbHMgKTsKCQkJYnV0dG9uVGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCX0KCQlidXR0b25JY29uID0gby5pY29uID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgOiBudWxsOwoKCQlpZiAoIGF0dGFjaEV2ZW50cyAmJiAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWF0dGFjaEV2ZW50cygpOwoJCX0KCgkJLy8gaWYgbm90LCB0cnkgdG8gZmluZCBjbG9zZXN0IHRoZW1lIGNvbnRhaW5lcgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApOwoJCX0KCgkJYnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi11cC0iICsgby50aGVtZTsKCQlidXR0b25DbGFzcyArPSBvLnNoYWRvdyA/ICIgdWktc2hhZG93IiA6ICIiOwoJCWJ1dHRvbkNsYXNzICs9IG8uY29ybmVycyA/ICIgdWktYnRuLWNvcm5lci1hbGwiIDogIiI7CgoJCWlmICggby5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBtaW5pYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5taW5pID09PSB0cnVlID8gIiB1aS1taW5pIiA6ICIgdWktZnVsbHNpemUiOwoJCX0KCgkJaWYgKCBvLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQkvLyBVc2VkIHRvIGNvbnRyb2wgc3R5bGluZyBpbiBoZWFkZXJzL2Zvb3RlcnMsIHdoZXJlIGJ1dHRvbnMgZGVmYXVsdCB0byBgaW5saW5lYCBzdHlsZS4KCQkJYnV0dG9uQ2xhc3MgKz0gby5pbmxpbmUgPT09IHRydWUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiB1aS1idG4tYmxvY2siOwoJCX0KCgkJaWYgKCBvLmljb24gKSB7CgkJCW8uaWNvbiA9ICJ1aS1pY29uLSIgKyBvLmljb247CgkJCW8uaWNvbnBvcyA9IG8uaWNvbnBvcyB8fCAibGVmdCI7CgoJCQlpY29uQ2xhc3MgPSAidWktaWNvbiAiICsgby5pY29uOwoKCQkJaWYgKCBvLmljb25zaGFkb3cgKSB7CgkJCQlpY29uQ2xhc3MgKz0gIiB1aS1pY29uLXNoYWRvdyI7CgkJCX0KCQl9CgoJCWlmICggby5pY29ucG9zICkgewoJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi1pY29uLSIgKyBvLmljb25wb3M7CgoJCQlpZiAoIG8uaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgIWVsLmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQkJfQoJCX0KCgkJaW5uZXJDbGFzcyArPSBvLmNvcm5lcnMgPyAiIHVpLWJ0bi1jb3JuZXItYWxsIiA6ICIiOwoKCQlpZiAoIG8uaWNvbnBvcyAmJiBvLmljb25wb3MgPT09ICJub3RleHQiICYmICFlbC5hdHRyKCAidGl0bGUiICkgKSB7CgkJCWVsLmF0dHIoICJ0aXRsZSIsIGVsLmdldEVuY29kZWRUZXh0KCkgKTsKCQl9CgoJCWlmICggYnV0dG9uRWxlbWVudHMgKSB7CgkJCWVsLnJlbW92ZUNsYXNzKCBidXR0b25FbGVtZW50cy5iY2xzIHx8ICIiICk7CgkJfQoJCWVsLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCgkJYnV0dG9uSW5uZXIuY2xhc3NOYW1lID0gaW5uZXJDbGFzczsKCgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9Cgp2YXIgYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7Cgl2YXIgaG92ZXJEZWxheSA9ICQubW9iaWxlLmJ1dHRvbk1hcmt1cC5ob3ZlckRlbGF5LCBob3YsIGZvYzsKCgkkKCBkb2N1bWVudCApLmJpbmQoIHsKCQkidm1vdXNlZG93biB2bW91c2VjYW5jZWwgdm1vdXNldXAgdm1vdXNlb3ZlciB2bW91c2VvdXQgZm9jdXMgYmx1ciBzY3JvbGxzdGFydCI6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHRoZW1lLAoJCQkJJGJ0biA9ICQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLAoJCQkJaXNUb3VjaEV2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCAmJiAvXnRvdWNoLy50ZXN0KCBldmVudC5vcmlnaW5hbEV2ZW50LnR5cGUgKSwKCQkJCWV2dCA9IGV2ZW50LnR5cGU7CgoJCQlpZiAoICRidG4ubGVuZ3RoICkgewoJCQkJdGhlbWUgPSAkYnRuLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIgKTsKCgkJCQlpZiAoIGV2dCA9PT0gInZtb3VzZWRvd24iICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJaG92ID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJCX0sIGhvdmVyRGVsYXkgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHRoZW1lICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlY2FuY2VsIiB8fCBldnQgPT09ICJ2bW91c2V1cCIgKSB7CgkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJJGJ0bi5yZW1vdmVDbGFzcyggInVpLWJ0bi11cC0iICsgdGhlbWUgKS5hZGRDbGFzcyggInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQkkYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSAgKyAiIHVpLWJ0bi1kb3duLSIgKyB0aGVtZSApLmFkZENsYXNzKCAidWktYnRuLXVwLSIgKyB0aGVtZSApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCSQoICI6anFtRGF0YShyb2xlPSdidXR0b24nKSwgLnVpLWJhciA+IGEsIC51aS1oZWFkZXIgPiBhLCAudWktZm9vdGVyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSIsIGUudGFyZ2V0ICkKCQkuanFtRW5oYW5jZWFibGUoKQoJCS5ub3QoICJidXR0b24sIGlucHV0LCAudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5idXR0b25NYXJrdXAoKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCWV4cGFuZEN1ZVRleHQ6ICIgY2xpY2sgdG8gZXhwYW5kIGNvbnRlbnRzIiwKCQljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJCWNvbGxhcHNlZDogdHJ1ZSwKCQloZWFkaW5nOiAiaDEsaDIsaDMsaDQsaDUsaDYsbGVnZW5kIiwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb24sCgkJCWV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbiwKCQkJY29sbGFwc2libGVDb250ZW50ID0gY29sbGFwc2libGUud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCc+PC9kaXY+IiApLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWNvbnRlbnQiICksCgkJCWNvbGxhcHNpYmxlU2V0ID0gJGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLXNldCIgKTsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0CgkJCWlmICggIW8uY29sbGFwc2VkSWNvbiApIHsKCQkJCW8uY29sbGFwc2VkSWNvbiA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKTsKCQkJfQoJCQkvLyBHZXQgdGhlIHByZWZlcmVuY2UgZm9yIGV4cGFuZGVkIGljb24gaW4gdGhlIHNldAoJCQlpZiAoICFvLmV4cGFuZGVkSWNvbiApIHsKCQkJCW8uZXhwYW5kZWRJY29uID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImV4cGFuZGVkLWljb24iICk7CgkJCX0KCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBpY29uIHBvc2l0aW9uIGluIHRoZSBzZXQKCQkJaWYgKCAhby5pY29uUG9zICkgewoJCQkJby5pY29uUG9zID0gY29sbGFwc2libGVTZXQuanFtRGF0YSggImljb25wb3MiICk7CgkJCX0KCQkJLy8gSW5oZXJpdCB0aGUgcHJlZmVyZW5jZSBmb3IgaW5zZXQgZnJvbSBjb2xsYXBzaWJsZS1zZXQgb3Igc2V0IHRoZSBkZWZhdWx0IHZhbHVlIHRvIGVuc3VyZSBlcXVhbHR5IHdpdGhpbiBhIHNldAoJCQlpZiAoIGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJby5pbnNldCA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpbnNldCIgKTsKCQkJfSBlbHNlIHsKCQkJCW8uaW5zZXQgPSB0cnVlOwoJCQl9CgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgZm9yIG1pbmkgaW4gdGhlIHNldAoJCQlpZiAoICFvLm1pbmkgKSB7CgkJCQlvLm1pbmkgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAibWluaSIgKTsKCQkJfQoJCX0gZWxzZSB7CgkJCS8vIGdldCBpbmhlcml0ZWQgdGhlbWUgaWYgbm90IGEgc2V0IGFuZCBubyB0aGVtZSBoYXMgYmVlbiBzZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQkJfQoJCX0KCQkKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGUuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1pbnNldCIgKTsKCQl9CgkJCgkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAoIG8uY29udGVudFRoZW1lICkgPyAoICJ1aS1ib2R5LSIgKyBvLmNvbnRlbnRUaGVtZSApIDogIiIpOwoKCQljb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBvLmNvbGxhcHNlZEljb24gfHwgInBsdXMiOwoJCWV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbiB8fCAibWludXMiOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQkJLmluc2VydEJlZm9yZSggY29sbGFwc2libGVDb250ZW50ICkKCQkJLy9tb2RpZnkgbWFya3VwICYgYXR0cmlidXRlcwoJCQkuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nIiApCgkJCS5hcHBlbmQoICI8c3BhbiBjbGFzcz0ndWktY29sbGFwc2libGUtaGVhZGluZy1zdGF0dXMnPjwvc3Bhbj4iICkKCQkJLndyYXBJbm5lciggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXRvZ2dsZSc+PC9hPiIgKQoJCQkuZmluZCggImEiICkKCQkJCS5maXJzdCgpCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCWljb25wb3M6ICRlbC5qcW1EYXRhKCAiaWNvbnBvcyIgKSB8fCBvLmljb25Qb3MgfHwgImxlZnQiLAoJCQkJCWljb246IGNvbGxhcHNlZEljb24sCgkJCQkJbWluaTogby5taW5pLAoJCQkJCXRoZW1lOiBvLnRoZW1lCgkJCQl9KTsKCgkJaWYgKCAhIW8uaW5zZXQgKSB7CQkJCQoJCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLmFkZCggIi51aS1idG4taW5uZXIiLCAkZWwgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQl9CgoJCS8vZXZlbnRzCgkJY29sbGFwc2libGUKCQkJLmJpbmQoICJleHBhbmQgY29sbGFwc2UiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICFldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICksCgkJCQkJCWlzQ29sbGFwc2UgPSAoIGV2ZW50LnR5cGUgPT09ICJjb2xsYXBzZSIgKSwKCQkJCQkJY29udGVudFRoZW1lID0gby5jb250ZW50VGhlbWU7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBleHBhbmRlZEljb24sICFpc0NvbGxhcHNlICkKCQkJCQkJCS8vIGxvZ2ljIG9yIGNhdXNlIHNhbWUgaWNvbiBmb3IgZXhwYW5kZWQvY29sbGFwc2VkIHN0YXRlIHdvdWxkIHJlbW92ZSB0aGUgdWktaWNvbi1jbGFzcwoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgY29sbGFwc2VkSWNvbiwgKCBpc0NvbGxhcHNlIHx8IGV4cGFuZGVkSWNvbiA9PT0gY29sbGFwc2VkSWNvbiApICkKCQkJCQkJLmVuZCgpCgkJCQkJCS5maW5kKCAiYSIgKS5maXJzdCgpLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQkJCQkkdGhpcy50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKTsKCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKS5hdHRyKCAiYXJpYS1oaWRkZW4iLCBpc0NvbGxhcHNlICk7CgoJCQkJCWlmICggY29udGVudFRoZW1lICYmICEhby5pbnNldCAmJiAoICFjb2xsYXBzaWJsZVNldC5sZW5ndGggfHwgY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgKSApIHsKCQkJCQkJY29sbGFwc2libGVIZWFkaW5nCgkJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5hZGQoIGNvbGxhcHNpYmxlSGVhZGluZy5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgaXNDb2xsYXBzZSApOwoJCQkJCQljb2xsYXBzaWJsZUNvbnRlbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiwgIWlzQ29sbGFwc2UgKTsKCQkJCQl9CgkJCQkJY29sbGFwc2libGVDb250ZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJCQl9CgkJCX0pCgkJCS50cmlnZ2VyKCBvLmNvbGxhcHNlZCA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLmJpbmQoICJ0YXAiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQljb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggImEiICkuZmlyc3QoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQl2YXIgdHlwZSA9IGNvbGxhcHNpYmxlSGVhZGluZy5pcyggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSA/ICJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGVzZXQiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgoJCWlmICggJGVsLmpxbURhdGEoICJpbnNldCIgKSAhPT0gdW5kZWZpbmVkICkgewoJCQlvLmluc2V0ID0gJGVsLmpxbURhdGEoICJpbnNldCIgKTsKCQl9CgkJby5pbnNldCA9IG8uaW5zZXQgIT09IHVuZGVmaW5lZCA/IG8uaW5zZXQgOiB0cnVlOwoKCQkvLyBJbml0aWFsaXplIHRoZSBjb2xsYXBzaWJsZSBzZXQgaWYgaXQncyBub3QgYWxyZWFkeSBpbml0aWFsaXplZAoJCWlmICggISRlbC5qcW1EYXRhKCAiY29sbGFwc2libGVib3VuZCIgKSApIHsKCQkJJGVsCgkJCQkuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiLCB0cnVlICkKCQkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICksCgkJCQkJCWNvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKSwKCQkJCQkJd2lkZ2V0ID0gY29sbGFwc2libGUuZGF0YSggImNvbGxhcHNpYmxlIiApOwoJCQkJCWlmICggY29sbGFwc2libGUuanFtRGF0YSggImNvbGxhcHNpYmxlLWxhc3QiICkgJiYgISFvLmluc2V0ICkgewoJCQkJCQljb2xsYXBzaWJsZS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkuZmlyc3QoKQoJCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkKCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1ib3R0b20iLCBpc0NvbGxhcHNlICkKCQkJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsIGlzQ29sbGFwc2UgKTsKCQkJCQkJY29sbGFwc2libGUuZmluZCggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWJvdHRvbSIsICFpc0NvbGxhcHNlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAiZXhwYW5kIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXZhciBjbG9zZXN0Q29sbGFwc2libGUgPSAkKCBldmVudC50YXJnZXQgKQoJCQkJCQkuY2xvc2VzdCggIi51aS1jb2xsYXBzaWJsZSIgKTsKCQkJCQlpZiAoIGNsb3Nlc3RDb2xsYXBzaWJsZS5wYXJlbnQoKS5pcyggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApICkgewoJCQkJCQljbG9zZXN0Q29sbGFwc2libGUKCQkJCQkJCS5zaWJsaW5ncyggIi51aS1jb2xsYXBzaWJsZSIgKQoJCQkJCQkJLnRyaWdnZXIoICJjb2xsYXBzZSIgKTsKCQkJCQl9CgkJCQl9KTsKCQl9Cgl9LAoKCV9pbml0OiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb2xsYXBzaWJsZXNJblNldCA9ICRlbC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICksCgkJCWV4cGFuZGVkID0gY29sbGFwc2libGVzSW5TZXQuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApOwoJCXRoaXMucmVmcmVzaCgpOwoKCQkvLyBCZWNhdXNlIHRoZSBjb3JuZXJzIGFyZSBoYW5kbGVkIGJ5IHRoZSBjb2xsYXBzaWJsZSBpdHNlbGYgYW5kIHRoZSBkZWZhdWx0IHN0YXRlIGlzIGNvbGxhcHNlZAoJCS8vIFRoYXQgd2FzIGNhdXNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80MTE2CgkJZXhwYW5kZWQudHJpZ2dlciggImV4cGFuZCIgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApOwoKCQkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZSggY29sbGFwc2libGVzSW5TZXQubm90KCAiLnVpLWNvbGxhcHNpYmxlIiApICk7CgoJCS8vIGNsZWFuIHVwIGJvcmRlcnMKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVzSW5TZXQuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5qcW1SZW1vdmVEYXRhKCAiY29sbGFwc2libGUtbGFzdCIgKQoJCQkJCS5maW5kKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJCQkuZmluZCggImEiICkuZmlyc3QoKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkJCS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSIgKTsKCQkJfSk7CgoJCQljb2xsYXBzaWJsZXNJblNldC5maXJzdCgpCgkJCQkuZmluZCggImEiICkKCQkJCQkuZmlyc3QoKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10b3AiICkKCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCQoJCQljb2xsYXBzaWJsZXNJblNldC5sYXN0KCkKCQkJCS5qcW1EYXRhKCAiY29sbGFwc2libGUtbGFzdCIsIHRydWUgKQoJCQkJLmZpbmQoICJhIiApCgkJCQkJLmZpcnN0KCkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYm90dG9tIiApCgkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20iICk7CgkJfQoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuY29sbGFwc2libGVzZXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkKGV2ZW50LnRhcmdldCkuaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSApIHsKCQkJCSRuYXZidG5zLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJJCggdGhpcyApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLm5hdmJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vS2VlcHMgdHJhY2sgb2YgdGhlIG51bWJlciBvZiBsaXN0cyBwZXIgcGFnZSBVSUQKLy9UaGlzIGFsbG93cyBzdXBwb3J0IGZvciBtdWx0aXBsZSBuZXN0ZWQgbGlzdCBpbiB0aGUgc2FtZSBwYWdlCi8vaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8xNjE3CnZhciBsaXN0Q291bnRQZXJQYWdlID0ge307CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLndpZGdldCwgewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiAiYyIsCgkJaGVhZGVyVGhlbWU6ICJiIiwKCQlkaXZpZGVyVGhlbWU6ICJiIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IHVpLWNvcm5lci1hbGwgdWktc2hhZG93ICIgOiAiIjsKCgkJLy8gY3JlYXRlIGxpc3R2aWV3IG1hcmt1cAoJCXQuZWxlbWVudC5hZGRDbGFzcyhmdW5jdGlvbiggaSwgb3JpZyApIHsKCQkJcmV0dXJuIG9yaWcgKyAiIHVpLWxpc3R2aWV3ICIgKyBsaXN0dmlld0NsYXNzZXM7CgkJfSk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfcmVtb3ZlQ29ybmVyczogZnVuY3Rpb24oIGxpLCB3aGljaCApIHsKCQl2YXIgdG9wID0gInVpLWNvcm5lci10b3AgdWktY29ybmVyLXRyIHVpLWNvcm5lci10bCIsCgkJCWJvdCA9ICJ1aS1jb3JuZXItYm90dG9tIHVpLWNvcm5lci1iciB1aS1jb3JuZXItYmwiOwoKCQlsaSA9IGxpLmFkZCggbGkuZmluZCggIi51aS1idG4taW5uZXIsIC51aS1saS1saW5rLWFsdCwgLnVpLWxpLXRodW1iIiApICk7CgoJCWlmICggd2hpY2ggPT09ICJ0b3AiICkgewoJCQlsaS5yZW1vdmVDbGFzcyggdG9wICk7CgkJfSBlbHNlIGlmICggd2hpY2ggPT09ICJib3R0b20iICkgewoJCQlsaS5yZW1vdmVDbGFzcyggYm90ICk7CgkJfSBlbHNlIHsKCQkJbGkucmVtb3ZlQ2xhc3MoIHRvcCArICIgIiArIGJvdCApOwoJCX0KCX0sCgoJX3JlZnJlc2hDb3JuZXJzOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciAkbGksCgkJCSR2aXNpYmxlbGksCgkJCSR0b3BsaSwKCQkJJGJvdHRvbWxpOwoKCQkkbGkgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJsaSIgKTsKCQkvLyBBdCBjcmVhdGUgdGltZSBhbmQgd2hlbiBhdXRvZGl2aWRlcnMgY2FsbHMgcmVmcmVzaCB0aGUgbGkgYXJlIG5vdCB2aXNpYmxlIHlldCBzbyB3ZSBuZWVkIHRvIHJlbHkgb24gLnVpLXNjcmVlbi1oaWRkZW4KCQkkdmlzaWJsZWxpID0gY3JlYXRlIHx8ICRsaS5maWx0ZXIoICI6dmlzaWJsZSIgKS5sZW5ndGggPT09IDAgPyAkbGkubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICkgOiAkbGkuZmlsdGVyKCAiOnZpc2libGUiICk7CgoJCS8vIHVpLWxpLWxhc3QgaXMgdXNlZCBmb3Igc2V0dGluZyBib3JkZXItYm90dG9tIG9uIHRoZSBsYXN0IGxpCQkKCQkkbGkuZmlsdGVyKCAiLnVpLWxpLWxhc3QiICkucmVtb3ZlQ2xhc3MoICJ1aS1saS1sYXN0IiApOwoJCQkJCQoJCWlmICggdGhpcy5vcHRpb25zLmluc2V0ICkgewoJCQl0aGlzLl9yZW1vdmVDb3JuZXJzKCAkbGkgKTsKCgkJCS8vIFNlbGVjdCB0aGUgZmlyc3QgdmlzaWJsZSBsaSBlbGVtZW50CgkJCSR0b3BsaSA9ICR2aXNpYmxlbGkuZmlyc3QoKQoJCQkJLmFkZENsYXNzKCAidWktY29ybmVyLXRvcCIgKTsKCgkJCSR0b3BsaS5hZGQoICR0b3BsaS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKQoJCQkJLm5vdCggIi51aS1saS1saW5rLWFsdCBzcGFuOmZpcnN0LWNoaWxkIiApICkKCQkJCQkuYWRkQ2xhc3MoICJ1aS1jb3JuZXItdG9wIiApCgkJCQkuZW5kKCkKCQkJCS5maW5kKCAiLnVpLWxpLWxpbmstYWx0LCAudWktbGktbGluay1hbHQgc3BhbjpmaXJzdC1jaGlsZCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10ciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci10bCIgKTsKCgkJCS8vIFNlbGVjdCB0aGUgbGFzdCB2aXNpYmxlIGxpIGVsZW1lbnQKCQkJJGJvdHRvbWxpID0gJHZpc2libGVsaS5sYXN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ib3R0b20gdWktbGktbGFzdCIgKTsKCgkJCSRib3R0b21saS5hZGQoICRib3R0b21saS5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSApCgkJCQkuZmluZCggIi51aS1saS1saW5rLWFsdCIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1iciIgKQoJCQkJLmVuZCgpCgkJCQkuZmluZCggIi51aS1saS10aHVtYiIgKQoJCQkJCS5ub3QoICIudWktbGktaWNvbiIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWNvcm5lci1ibCIgKTsKCQl9IGVsc2UgewoJCQkkdmlzaWJsZWxpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxpLWxhc3QiICk7CgkJfQoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfSwKCgkvLyBUaGlzIGlzIGEgZ2VuZXJpYyB1dGlsaXR5IG1ldGhvZCBmb3IgZmluZGluZyB0aGUgZmlyc3QKCS8vIG5vZGUgd2l0aCBhIGdpdmVuIG5vZGVOYW1lLiBJdCB1c2VzIGJhc2ljIERPTSB0cmF2ZXJzYWwKCS8vIHRvIGJlIGZhc3QgYW5kIGlzIG1lYW50IHRvIGJlIGEgc3Vic3RpdHV0ZSBmb3Igc2ltcGxlCgkvLyAkLmZuLmNsb3Nlc3QoKSBhbmQgJC5mbi5jaGlsZHJlbigpIGNhbGxzIG9uIGEgc2luZ2xlCgkvLyBlbGVtZW50LiBOb3RlIHRoYXQgY2FsbGVycyBtdXN0IHBhc3MgYm90aCB0aGUgbG93ZXJDYXNlCgkvLyBhbmQgdXBwZXJDYXNlIHZlcnNpb24gb2YgdGhlIG5vZGVOYW1lIHRoZXkgYXJlIGxvb2tpbmcgZm9yLgoJLy8gVGhlIG1haW4gcmVhc29uIGZvciB0aGlzIGlzIHRoYXQgdGhpcyBmdW5jdGlvbiB3aWxsIGJlCgkvLyBjYWxsZWQgbWFueSB0aW1lcyBhbmQgd2Ugd2FudCB0byBhdm9pZCBoYXZpbmcgdG8gbG93ZXJjYXNlCgkvLyB0aGUgbm9kZU5hbWUgZnJvbSB0aGUgZWxlbWVudCBldmVyeSB0aW1lIHRvIGVuc3VyZSB3ZSBoYXZlCgkvLyBhIG1hdGNoLiBOb3RlIHRoYXQgdGhpcyBmdW5jdGlvbiBsaXZlcyBoZXJlIGZvciBub3csIGJ1dCBtYXkKCS8vIGJlIG1vdmVkIGludG8gJC5tb2JpbGUgaWYgb3RoZXIgY29tcG9uZW50cyBuZWVkIGEgc2ltaWxhciBtZXRob2QuCglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCWltZy5hZGRDbGFzcyggInVpLWxpLXRodW1iIiApOwoJCQkJJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggaW1nWyAwIF0ucGFyZW50Tm9kZSwgInBhcmVudE5vZGUiLCAibGkiLCAiTEkiICkgKS5hZGRDbGFzcyggaW1nLmlzKCAiLnVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl0aGlzLnBhcmVudFBhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCXRoaXMuX2NyZWF0ZVN1YlBhZ2VzKCk7CgoJCXZhciBvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJc2VsZiA9IHRoaXMsCgkJCWRpdmlkZXJ0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJkaXZpZGVydGhlbWUiICkgfHwgby5kaXZpZGVyVGhlbWUsCgkJCWxpc3RzcGxpdHRoZW1lID0gJGxpc3QuanFtRGF0YSggInNwbGl0dGhlbWUiICksCgkJCWxpc3RzcGxpdGljb24gPSAkbGlzdC5qcW1EYXRhKCAic3BsaXRpY29uIiApLAoJCQlsaSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCAkbGlzdFsgMCBdLCAibGkiLCAiTEkiICksCgkJCW9sID0gISEkLm5vZGVOYW1lKCAkbGlzdFsgMCBdLCAib2wiICksCgkJCWpzQ291bnQgPSAhJC5zdXBwb3J0LmNzc1BzZXVkb0VsZW1lbnQsCgkJCXN0YXJ0ID0gJGxpc3QuYXR0ciggInN0YXJ0IiApLAoJCQlpdGVtQ2xhc3NEaWN0ID0ge30sCgkJCWl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLAoJCQlhLCBsYXN0LCBzcGxpdHRoZW1lLCBjb3VudGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCBjb3VudFBhcmVudCwgaWNvbiwgaW1nUGFyZW50cywgaW1nLCBsaW5rSWNvbjsKCgkJaWYgKCBvbCAmJiBqc0NvdW50ICkgewoJCQkkbGlzdC5maW5kKCAiLnVpLWxpLWRlYyIgKS5yZW1vdmUoKTsKCQl9CgoJCWlmICggb2wgKSB7CQoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlRmxvYXQoIHN0YXJ0ICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQkKCQl9CgoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKTsKCQl9CgoJCWZvciAoIHZhciBwb3MgPSAwLCBudW1saSA9IGxpLmxlbmd0aDsgcG9zIDwgbnVtbGk7IHBvcysrICkgewoJCQlpdGVtID0gbGkuZXEoIHBvcyApOwoJCQlpdGVtQ2xhc3MgPSAidWktbGkiOwoKCQkJLy8gSWYgd2UncmUgY3JlYXRpbmcgdGhlIGVsZW1lbnQsIHdlIHVwZGF0ZSBpdCByZWdhcmRsZXNzCgkJCWlmICggY3JlYXRlIHx8ICFpdGVtLmhhc0NsYXNzKCAidWktbGkiICkgKSB7CgkJCQlpdGVtVGhlbWUgPSBpdGVtLmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lOwoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQl2YXIgaXNEaXZpZGVyID0gKCBpdGVtLmpxbURhdGEoICJyb2xlIiApID09PSAibGlzdC1kaXZpZGVyIiApOwoKCQkJCWlmICggYS5sZW5ndGggJiYgIWlzRGl2aWRlciApIHsKCQkJCQlpY29uID0gaXRlbS5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJaXRlbS5idXR0b25NYXJrdXAoewoJCQkJCQl3cmFwcGVyRWxzOiAiZGl2IiwKCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJCWljb25wb3M6ICJyaWdodCIsCgkJCQkJCWljb246IGEubGVuZ3RoID4gMSB8fCBpY29uID09PSBmYWxzZSA/IGZhbHNlIDogaWNvbiB8fCAiYXJyb3ctciIsCgkJCQkJCXRoZW1lOiBpdGVtVGhlbWUKCQkJCQl9KTsKCgkJCQkJaWYgKCAoIGljb24gIT09IGZhbHNlICkgJiYgKCBhLmxlbmd0aCA9PT0gMSApICkgewoJCQkJCQlpdGVtLmFkZENsYXNzKCAidWktbGktaGFzLWFycm93IiApOwoJCQkJCX0KCgkJCQkJYS5maXJzdCgpLnJlbW92ZUNsYXNzKCAidWktbGluayIgKS5hZGRDbGFzcyggInVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyArPSAiIHVpLWxpLWhhcy1hbHQiOwoKCQkJCQkJbGFzdCA9IGEubGFzdCgpOwoJCQkJCQlzcGxpdHRoZW1lID0gbGlzdHNwbGl0dGhlbWUgfHwgbGFzdC5qcW1EYXRhKCAidGhlbWUiICkgfHwgby5zcGxpdFRoZW1lOwoJCQkJCQlsaW5rSWNvbiA9IGxhc3QuanFtRGF0YSggImljb24iICk7CgoJCQkJCQlsYXN0LmFwcGVuZFRvKCBpdGVtICkKCQkJCQkJCS5hdHRyKCAidGl0bGUiLCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKQoJCQkJCQkJLmFkZENsYXNzKCAidWktbGktbGluay1hbHQiICkKCQkJCQkJCS5lbXB0eSgpCgkJCQkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQkJCWNvcm5lcnM6IGZhbHNlLAoJCQkJCQkJCXRoZW1lOiBpdGVtVGhlbWUsCgkJCQkJCQkJaWNvbjogZmFsc2UsCgkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIKCQkJCQkJCX0pCgkJCQkJCQkuZmluZCggIi51aS1idG4taW5uZXIiICkKCQkJCQkJCQkuYXBwZW5kKAoJCQkJCQkJCQkkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJCQlzaGFkb3c6IHRydWUsCgkJCQkJCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCQkJCQkJdGhlbWU6IHNwbGl0dGhlbWUsCgkJCQkJCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQkJCQkJCS8vIGxpbmsgaWNvbiBvdmVycmlkZXMgbGlzdCBpdGVtIGljb24gb3ZlcnJpZGVzIHVsIGVsZW1lbnQgb3ZlcnJpZGVzIG9wdGlvbnMKCQkJCQkJCQkJCWljb246IGxpbmtJY29uIHx8IGljb24gfHwgbGlzdHNwbGl0aWNvbiB8fCBvLnNwbGl0SWNvbgoJCQkJCQkJCQl9KQoJCQkJCQkJCSk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggaXNEaXZpZGVyICkgewoKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1kaXZpZGVyIHVpLWJhci0iICsgZGl2aWRlcnRoZW1lOwoJCQkJCWl0ZW0uYXR0ciggInJvbGUiLCAiaGVhZGluZyIgKTsKCgkJCQkJaWYgKCBvbCApIHsJCgkJCQkJCS8vcmVzZXQgY291bnRlciB3aGVuIGEgZGl2aWRlciBoZWFkaW5nIGlzIGVuY291bnRlcmVkCgkJCQkJCWlmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSB7CgkJCQkJCQlpZiAoICFqc0NvdW50ICkgewoJCQkJCQkJCW5ld1N0YXJ0Q291bnQgPSBwYXJzZUZsb2F0KCBzdGFydCApIC0gMTsKCQkJCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQljb3VudGVyID0gcGFyc2VGbG9hdCggc3RhcnQgKTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQkJCQljb3VudGVyID0gMTsKCQkJCQkJfQkKCQkJCQl9CgkJCQkKCQkJCX0gZWxzZSB7CgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktc3RhdGljIHVpLWJ0bi11cC0iICsgaXRlbVRoZW1lOwoJCQkJfQoJCQl9CgoJCQlpZiAoIG9sICYmIGpzQ291bnQgJiYgaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1kaXZpZGVyIiApIDwgMCApIHsKCQkJCWNvdW50UGFyZW50ID0gaXRlbUNsYXNzLmluZGV4T2YoICJ1aS1saS1zdGF0aWMiICkgPiAwID8gaXRlbSA6IGl0ZW0uZmluZCggIi51aS1saW5rLWluaGVyaXQiICk7CgoJCQkJY291bnRQYXJlbnQuYWRkQ2xhc3MoICJ1aS1saS1qc251bWJlcmluZyIgKQoJCQkJCS5wcmVwZW5kKCAiPHNwYW4gY2xhc3M9J3VpLWxpLWRlYyc+IiArICggY291bnRlcisrICkgKyAiLiA8L3NwYW4+IiApOwoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtIGFuZCBpdHMKCQkJLy8gYnRuLWlubmVyIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtCgkJLy8gYW5kIHRoZWlyIGJ0bi1pbm5lciBlbGVtZW50cy4gVGhlIG1haW4gcmVhc29uIHdlIGRpZG4ndCBkbyB0aGlzCgkJLy8gaW4gdGhlIGZvci1sb29wIGFib3ZlIGlzIGJlY2F1c2Ugd2UgY2FuIGVsaW1pbmF0ZSBwZXItaXRlbSBmdW5jdGlvbiBvdmVyaGVhZAoJCS8vIGJ5IGNhbGxpbmcgYWRkQ2xhc3MoKSBhbmQgY2hpbGRyZW4oKSBvbmNlIG9yIHR3aWNlIGFmdGVyd2FyZHMuIFRoaXMKCQkvLyBjYW4gZ2l2ZSB1cyBhIHNpZ25pZmljYW50IGJvb3N0IG9uIHBsYXRmb3JtcyBsaWtlIFdQNy41LgoKCQlmb3IgKCBpdGVtQ2xhc3MgaW4gaXRlbUNsYXNzRGljdCApIHsKCQkJJCggaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKS5hZGRDbGFzcyggaXRlbUNsYXNzICkuY2hpbGRyZW4oICIudWktYnRuLWlubmVyIiApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKTsKCQl9CgoJCSRsaXN0LmZpbmQoICJoMSwgaDIsIGgzLCBoNCwgaDUsIGg2IiApLmFkZENsYXNzKCAidWktbGktaGVhZGluZyIgKQoJCQkuZW5kKCkKCgkJCS5maW5kKCAicCwgZGwiICkuYWRkQ2xhc3MoICJ1aS1saS1kZXNjIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktYXNpZGUiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgkJCQkJJHRoaXMucHJlcGVuZFRvKCAkdGhpcy5wYXJlbnQoKSApOyAvL3NoaWZ0IGFzaWRlIHRvIGZyb250IGZvciBjc3MgZmxvYXQKCQkJCX0pCgkJCS5lbmQoKQoKCQkJLmZpbmQoICIudWktbGktY291bnQiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCQkJfSkuYWRkQ2xhc3MoICJ1aS1idG4tdXAtIiArICggJGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgdGhpcy5vcHRpb25zLmNvdW50VGhlbWUpICsgIiB1aS1idG4tY29ybmVyLWFsbCIgKTsKCgkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBsb29rIGF0IHRoZSBmaXJzdCBpbWFnZSBpbiB0aGUgbGlzdCBpdGVtCgkJLy8gaXRzZWxmLCBhbmQgYW55IC51aS1saW5rLWluaGVyaXQgZWxlbWVudCBpdCBtYXkgY29udGFpbiwgc28gd2UKCQkvLyBjYW4gcGxhY2UgdGhlIGFwcHJvcHJpYXRlIGNsYXNzZXMgb24gdGhlIGltYWdlIGFuZCBsaXN0IGl0ZW0uCgkJLy8gTm90ZSB0aGF0IHdlIHVzZWQgdG8gdXNlIHNvbWV0aGluZyBsaWtlOgoJCS8vCgkJLy8gICAgbGkuZmluZCgiPmltZzplcSgwKSwgLnVpLWxpbmstaW5oZXJpdD5pbWc6ZXEoMCkiKS5lYWNoKCAuLi4gKTsKCQkvLwoJCS8vIEJ1dCBleGVjdXRpbmcgYSBmaW5kKCkgbGlrZSB0aGF0IG9uIFdpbmRvd3MgUGhvbmUgNy41IHRvb2sgYQoJCS8vIHJlYWxseSBsb25nIHRpbWUuIFdhbGtpbmcgdGhpbmdzIG1hbnVhbGx5IHdpdGggdGhlIGNvZGUgYmVsb3cKCQkvLyBhbGxvd3MgdGhlIDQwMCBsaXN0dmlldyBpdGVtIHBhZ2UgdG8gbG9hZCBpbiBhYm91dCAzIHNlY29uZHMgYXMKCQkvLyBvcHBvc2VkIHRvIDMwIHNlY29uZHMuCgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoICRsaXN0LmZpbmQoICIudWktbGluay1pbmhlcml0IiApICk7CgoJCXRoaXMuX3JlZnJlc2hDb3JuZXJzKCBjcmVhdGUgKTsKCiAgICAvLyBhdXRvZGl2aWRlcnMgYmluZHMgdG8gdGhpcyB0byByZWRyYXcgZGl2aWRlcnMgYWZ0ZXIgdGhlIGxpc3R2aWV3IHJlZnJlc2gKCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJyZWZyZXNoIiApOwoJfSwKCgkvL2NyZWF0ZSBhIHN0cmluZyBmb3IgSUQvc3VicGFnZSB1cmwgY3JlYXRpb24KCV9pZFN0cmluZ0VzY2FwZTogZnVuY3Rpb24oIHN0ciApIHsKCQlyZXR1cm4gc3RyLnJlcGxhY2UoL1teYS16QS1aMC05XS9nLCAnLScpOwoJfSwKCglfY3JlYXRlU3ViUGFnZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYXJlbnRMaXN0ID0gdGhpcy5lbGVtZW50LAoJCQlwYXJlbnRQYWdlID0gcGFyZW50TGlzdC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCXBhcmVudFVybCA9IHBhcmVudFBhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJcGFyZW50SWQgPSBwYXJlbnRVcmwgfHwgcGFyZW50UGFnZVsgMCBdWyAkLmV4cGFuZG8gXSwKCQkJcGFyZW50TGlzdElkID0gcGFyZW50TGlzdC5hdHRyKCAiaWQiICksCgkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCWRucyA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXMsCgkJCXBlcnNpc3RlbnRGb290ZXJJRCA9IHBhcmVudFBhZ2UuZmluZCggIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpIiApLmpxbURhdGEoICJpZCIgKSwKCQkJaGFzU3ViUGFnZXM7CgoJCWlmICggdHlwZW9mIGxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPT09ICJ1bmRlZmluZWQiICkgewoJCQlsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdID0gLTE7CgkJfQoKCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0SWQgfHwgKytsaXN0Q291bnRQZXJQYWdlWyBwYXJlbnRJZCBdOwoKCQkkKCBwYXJlbnRMaXN0LmZpbmQoICJsaT51bCwgbGk+b2wiICkudG9BcnJheSgpLnJldmVyc2UoKSApLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCWxpc3QgPSAkKCB0aGlzICksCgkJCQlsaXN0SWQgPSBsaXN0LmF0dHIoICJpZCIgKSB8fCBwYXJlbnRMaXN0SWQgKyAiLSIgKyBpLAoJCQkJcGFyZW50ID0gbGlzdC5wYXJlbnQoKSwKCQkJCW5vZGVFbHNGdWxsID0gJCggbGlzdC5wcmV2QWxsKCkudG9BcnJheSgpLnJldmVyc2UoKSApLAoJCQkJbm9kZUVscyA9IG5vZGVFbHNGdWxsLmxlbmd0aCA/IG5vZGVFbHNGdWxsIDogJCggIjxzcGFuPiIgKyAkLnRyaW0ocGFyZW50LmNvbnRlbnRzKClbIDAgXS5ub2RlVmFsdWUpICsgIjwvc3Bhbj4iICksCgkJCQl0aXRsZSA9IG5vZGVFbHMuZmlyc3QoKS5nZXRFbmNvZGVkVGV4dCgpLC8vdXJsIGxpbWl0cyB0byBmaXJzdCAzMCBjaGFycyBvZiB0ZXh0CgkJCQlpZCA9ICggcGFyZW50VXJsIHx8ICIiICkgKyAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICsgIj0iICsgbGlzdElkLAoJCQkJdGhlbWUgPSBsaXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnRoZW1lLAoJCQkJY291bnRUaGVtZSA9IGxpc3QuanFtRGF0YSggImNvdW50dGhlbWUiICkgfHwgcGFyZW50TGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBvLmNvdW50VGhlbWUsCgkJCQluZXdQYWdlLCBhbmNob3I7CgoJCQkvL2RlZmluZSBoYXNTdWJQYWdlcyBmb3IgdXNlIGluIGxhdGVyIHJlbW92YWwKCQkJaGFzU3ViUGFnZXMgPSB0cnVlOwoKCQkJbmV3UGFnZSA9IGxpc3QuZGV0YWNoKCkKCQkJCQkJLndyYXAoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0ncGFnZScgIiArIGRucyArICJ1cmw9JyIgKyBpZCArICInICIgKyBkbnMgKyAidGhlbWU9JyIgKyB0aGVtZSArICInICIgKyBkbnMgKyAiY291bnQtdGhlbWU9JyIgKyBjb3VudFRoZW1lICsgIic+PGRpdiAiICsgZG5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PjwvZGl2PiIgKQoJCQkJCQkucGFyZW50KCkKCQkJCQkJCS5iZWZvcmUoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0naGVhZGVyJyAiICsgZG5zICsgInRoZW1lPSciICsgby5oZWFkZXJUaGVtZSArICInPjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgdGl0bGUgKyAiPC9kaXY+PC9kaXY+IiApCgkJCQkJCQkuYWZ0ZXIoIHBlcnNpc3RlbnRGb290ZXJJRCA/ICQoICI8ZGl2ICIgKyBkbnMgKyAicm9sZT0nZm9vdGVyJyAiICsgZG5zICsgImlkPSciKyBwZXJzaXN0ZW50Rm9vdGVySUQgKyInPiIgKSA6ICIiICkKCQkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJCS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJbmV3UGFnZS5wYWdlKCk7CgoJCQlhbmNob3IgPSBwYXJlbnQuZmluZCggJ2E6Zmlyc3QnICk7CgoJCQlpZiAoICFhbmNob3IubGVuZ3RoICkgewoJCQkJYW5jaG9yID0gJCggIjxhLz4iICkuaHRtbCggbm9kZUVscyB8fCB0aXRsZSApLnByZXBlbmRUbyggcGFyZW50LmVtcHR5KCkgKTsKCQkJfQoKCQkJYW5jaG9yLmF0dHIoICJocmVmIiwgIiMiICsgaWQgKTsKCgkJfSkubGlzdHZpZXcoKTsKCgkJLy8gb24gcGFnZWhpZGUsIHJlbW92ZSBhbnkgbmVzdGVkIHBhZ2VzIGFsb25nIHdpdGggdGhlIHBhcmVudCBwYWdlLCBhcyBsb25nIGFzIHRoZXkgYXJlbid0IGFjdGl2ZQoJCS8vIGFuZCBhcmVuJ3QgZW1iZWRkZWQKCQlpZiAoIGhhc1N1YlBhZ2VzICYmCgkJCXBhcmVudFBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgJiYKCQkJcGFyZW50UGFnZS5kYXRhKCAicGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiAoIHVpLm5leHRQYWdlICkgewoJCQkJCW5wVVJMID0gbmV4dFBhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCQlpZiAoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApIHsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UudHJpZ2dlciggcHJFdmVudCApOwoJCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50VXJsID0gdGhpcy5wYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCXJldHVybiAkKCAiOmpxbURhdGEodXJsXj0nIisgIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiJykiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmF1dG9kaXZpZGVycyA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbHQgKSB7CgkvLyBsb29rIGZvciB0aGUgdGV4dCBpbiB0aGUgZ2l2ZW4gZWxlbWVudAoJdmFyIHRleHQgPSBlbHQudGV4dCgpIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfTsKCiQoIGRvY3VtZW50ICkuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggImxpc3R2aWV3IiApOwoKCWlmICggIWxpc3R2aWV3IHx8ICFsaXN0dmlldy5vcHRpb25zLmF1dG9kaXZpZGVycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHJlcGxhY2VEaXZpZGVycyA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LmZpbmQoICJsaTpqcW1EYXRhKHJvbGU9J2xpc3QtZGl2aWRlcicpIiApLnJlbW92ZSgpOwoKCQl2YXIgbGlzID0gbGlzdC5maW5kKCAnbGknICksCgkJCWxhc3REaXZpZGVyVGV4dCA9IG51bGwsIGxpLCBkaXZpZGVyVGV4dDsKCgkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGlzLmxlbmd0aCA7IGkrKyApIHsKCQkJbGkgPSBsaXNbaV07CgkJCWRpdmlkZXJUZXh0ID0gbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJdmFyIGRpdmlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnbGknICk7CgkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggZGl2aWRlclRleHQgKSApOwoJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICdkYXRhLScgKyAkLm1vYmlsZS5ucyArICdyb2xlJywgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCWxpLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBkaXZpZGVyLCBsaSApOwoJCQl9CgoJCQlsYXN0RGl2aWRlclRleHQgPSBkaXZpZGVyVGV4dDsKCQl9Cgl9OwoKCXZhciBhZnRlckxpc3R2aWV3UmVmcmVzaCA9IGZ1bmN0aW9uICgpIHsKCQlsaXN0LnVuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCQlyZXBsYWNlRGl2aWRlcnMoKTsKCQlsaXN0dmlldy5yZWZyZXNoKCk7CgkJbGlzdC5iaW5kKCAnbGlzdHZpZXdhZnRlcnJlZnJlc2gnLCBhZnRlckxpc3R2aWV3UmVmcmVzaCApOwoJfTsKCglhZnRlckxpc3R2aWV3UmVmcmVzaCgpOwp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogImNoZWNrYm94cmFkaW8iIHBsdWdpbgoqLwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jaGVja2JveHJhZGlvIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddIgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJaW5wdXQgPSB0aGlzLmVsZW1lbnQsCgkJCWluaGVyaXRBdHRyID0gZnVuY3Rpb24oIGlucHV0LCBkYXRhQXR0ciApIHsKCQkJCXJldHVybiBpbnB1dC5qcW1EYXRhKCBkYXRhQXR0ciApIHx8IGlucHV0LmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCIgKS5qcW1EYXRhKCBkYXRhQXR0ciApOwoJCQl9LAoJCQkvLyBOT1RFOiBXaW5kb3dzIFBob25lIGNvdWxkIG5vdCBmaW5kIHRoZSBsYWJlbCB0aHJvdWdoIGEgc2VsZWN0b3IKCQkJLy8gZmlsdGVyIHdvcmtzIHRob3VnaC4KCQkJcGFyZW50TGFiZWwgPSAkKCBpbnB1dCApLmNsb3Nlc3QoICJsYWJlbCIgKSwKCQkJbGFiZWwgPSBwYXJlbnRMYWJlbC5sZW5ndGggPyBwYXJlbnRMYWJlbCA6ICQoIGlucHV0ICkuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLmZpbmQoICJsYWJlbCIgKS5maWx0ZXIoICJbZm9yPSciICsgaW5wdXRbMF0uaWQgKyAiJ10iICkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJbWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbiA9IGlucHV0LnBhcmVudHMoICI6anFtRGF0YSh0eXBlPSdob3Jpem9udGFsJykiICkubGVuZ3RoID8gdW5kZWZpbmVkIDogdW5jaGVja2VkU3RhdGUsCgkJCWljb25wb3MgPSBpbmhlcml0QXR0ciggaW5wdXQsICJpY29ucG9zIiApLAoJCQlhY3RpdmVCdG4gPSBpY29uID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcywKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBjaGVja2VkU3RhdGUgKyBhY3RpdmVCdG4sCgkJCXVuY2hlY2tlZENsYXNzID0gInVpLSIgKyB1bmNoZWNrZWRTdGF0ZSwKCQkJY2hlY2tlZGljb24gPSAidWktaWNvbi0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRpY29uID0gInVpLWljb24tIiArIHVuY2hlY2tlZFN0YXRlOwoKCQlpZiAoIGlucHV0dHlwZSAhPT0gImNoZWNrYm94IiAmJiBpbnB1dHR5cGUgIT09ICJyYWRpbyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEV4cG9zZSBmb3Igb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWxhYmVsOiBsYWJlbCwKCQkJaW5wdXR0eXBlOiBpbnB1dHR5cGUsCgkJCWNoZWNrZWRDbGFzczogY2hlY2tlZENsYXNzLAoJCQl1bmNoZWNrZWRDbGFzczogdW5jaGVja2VkQ2xhc3MsCgkJCWNoZWNrZWRpY29uOiBjaGVja2VkaWNvbiwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkaWNvbgoJCX0pOwoKCQkvLyBJZiB0aGVyZSdzIG5vIHNlbGVjdGVkIHRoZW1lIGNoZWNrIHRoZSBkYXRhIGF0dHIKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaWNvbjogaWNvbiwKCQkJc2hhZG93OiBmYWxzZSwKCQkJbWluaTogbWluaSwKCQkJaWNvbnBvczogaWNvbnBvcwoJCX0pOwoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgkJdmFyIHdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS0nICsgaW5wdXR0eXBlOwoKCQlpbnB1dC5hZGQoIGxhYmVsICkud3JhcEFsbCggd3JhcHBlciApOwoKCQlsYWJlbC5iaW5kKHsKCQkJdm1vdXNlb3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAkKCB0aGlzICkucGFyZW50KCkuaXMoICIudWktZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCX0sCgoJCQl2Y2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggaW5wdXQuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJc2VsZi5fY2FjaGVWYWxzKCk7CgoJCQkJaW5wdXQucHJvcCggImNoZWNrZWQiLCBpbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJCQkvLyB0cmlnZ2VyIGNsaWNrIGhhbmRsZXIncyBib3VuZCBkaXJlY3RseSB0byB0aGUgaW5wdXQgYXMgYSBzdWJzdGl0dXRlIGZvcgoJCQkJLy8gaG93IGxhYmVsIGNsaWNrcyBiZWhhdmUgbm9ybWFsbHkgaW4gdGhlIGJyb3dzZXJzCgkJCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkJCS8vICAgICAgIHRocm91Z2ggdG8gdGhlIGFzc29jaWF0ZSBpbnB1dC4gd2UgY2FuIHN3YWxsb3cgdGhhdCBjbGljayBhdCB0aGUgcGFyZW50CgkJCQkvLyAgICAgICB3cmFwcGVyIGVsZW1lbnQgbGV2ZWwKCQkJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAnY2xpY2snICk7CgoJCQkJLy8gSW5wdXQgc2V0IGZvciBjb21tb24gcmFkaW8gYnV0dG9ucyB3aWxsIGNvbnRhaW4gYWxsIHRoZSByYWRpbwoJCQkJLy8gYnV0dG9ucywgYnV0IHdpbGwgbm90IGZvciBjaGVja2JveGVzLiBjbGVhcmluZyB0aGUgY2hlY2tlZCBzdGF0dXMKCQkJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCBpbnB1dCApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCgkJCQlzZWxmLl91cGRhdGVBbGwoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoKCQlpbnB1dAoJCQkuYmluZCh7CgkJCQl2bW91c2Vkb3duOiBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCQkJCX0sCgoJCQkJdmNsaWNrOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFkZHMgY2hlY2tlZCBhdHRyaWJ1dGUgdG8gY2hlY2tlZCBpbnB1dCB3aGVuIGtleWJvYXJkIGlzIHVzZWQKCQkJCQlpZiAoICR0aGlzLmlzKCAiOmNoZWNrZWQiICkgKSB7CgoJCQkJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIHRydWUpOwoJCQkJCQlzZWxmLl9nZXRJbnB1dFNldCgpLm5vdCggJHRoaXMgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJfSwKCgkJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCglfY2FjaGVWYWxzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2FjaGVWYWwiLCB0aGlzLmNoZWNrZWQgKTsKCQl9KTsKCX0sCgoJLy9yZXR1cm5zIGVpdGhlciBhIHNldCBvZiByYWRpb3Mgd2l0aCB0aGUgc2FtZSBuYW1lIGF0dHJpYnV0ZSwgb3IgYSBzaW5nbGUgY2hlY2tib3gKCV9nZXRJbnB1dFNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCQl9CgoJCXJldHVybiB0aGlzLmVsZW1lbnQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0LCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFswXS5uYW1lICsgIiddW3R5cGU9JyIgKyB0aGlzLmlucHV0dHlwZSArICInXSIgKTsKCX0sCgoJX3VwZGF0ZUFsbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLl9nZXRJbnB1dFNldCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5wdXQgPSB0aGlzLmVsZW1lbnRbMF0sCgkJCWxhYmVsID0gdGhpcy5sYWJlbCwKCQkJaWNvbiA9IGxhYmVsLmZpbmQoICIudWktaWNvbiIgKTsKCgkJaWYgKCBpbnB1dC5jaGVja2VkICkgewoJCQlsYWJlbC5hZGRDbGFzcyggdGhpcy5jaGVja2VkQ2xhc3MgKS5yZW1vdmVDbGFzcyggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlpY29uLmFkZENsYXNzKCB0aGlzLmNoZWNrZWRpY29uICkucmVtb3ZlQ2xhc3MoIHRoaXMudW5jaGVja2VkaWNvbiApOwoJCX0gZWxzZSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCB0aGlzLmNoZWNrZWRDbGFzcyApLmFkZENsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICk7CgkJCWljb24ucmVtb3ZlQ2xhc3MoIHRoaXMuY2hlY2tlZGljb24gKS5hZGRDbGFzcyggdGhpcy51bmNoZWNrZWRpY29uICk7CgkJfQoKCQlpZiAoIGlucHV0LmRpc2FibGVkICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIHRydWUgKS5wYXJlbnQoKS5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBmYWxzZSApLnBhcmVudCgpLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0pOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJJGJ1dHRvbiwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdHlwZSwKCQkJbmFtZSwKCQkJaW5saW5lID0gby5pbmxpbmUgfHwgJGVsLmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvLm1pbmkgfHwgJGVsLmpxbURhdGEoICJtaW5pIiApLAoJCQljbGFzc2VzID0gIiIsCgkJCSRidXR0b25QbGFjZWhvbGRlcjsKCgkJLy8gaWYgdGhpcyBpcyBhIGxpbmssIGNoZWNrIGlmIGl0J3MgYmVlbiBlbmhhbmNlZCBhbmQsIGlmIG5vdCwgdXNlIHRoZSByaWdodCBmdW5jdGlvbgoJCWlmICggJGVsWyAwIF0udGFnTmFtZSA9PT0gIkEiICkgewoJCQlpZiAoICEkZWwuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQkkZWwuYnV0dG9uTWFya3VwKCk7CgkJCX0KCgkJCXJldHVybjsKCQl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoICAkZWwuYXR0ciggInR5cGUiICkgPT09ICJzdWJtaXQiIHx8ICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInJlc2V0IiApIHsKCQkJY2xhc3NlcyA/IGNsYXNzZXMgKz0gIiB1aS1zdWJtaXQiIDogIGNsYXNzZXMgPSAidWktc3VibWl0IjsKCQl9CgkJJCggImxhYmVsW2Zvcj0nIiArICRlbC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1zdWJtaXQiICk7CgoJCS8vIEFkZCBBUklBIHJvbGUKCQl0aGlzLmJ1dHRvbiA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQlbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKQoJCQkuaW5zZXJ0QmVmb3JlKCAkZWwgKQoJCQkuYnV0dG9uTWFya3VwKHsKCQkJCXRoZW1lOiBvLnRoZW1lLAoJCQkJaWNvbjogby5pY29uLAoJCQkJaWNvbnBvczogby5pY29ucG9zLAoJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQljb3JuZXJzOiBvLmNvcm5lcnMsCgkJCQlzaGFkb3c6IG8uc2hhZG93LAoJCQkJaWNvbnNoYWRvdzogby5pY29uc2hhZG93LAoJCQkJbWluaTogbWluaQoJCQl9KQoJCQkuYWRkQ2xhc3MoIGNsYXNzZXMgKQoJCQkuYXBwZW5kKCAkZWwuYWRkQ2xhc3MoICJ1aS1idG4taGlkZGVuIiApICk7CgogICAgICAgICRidXR0b24gPSB0aGlzLmJ1dHRvbjsKCQl0eXBlID0gJGVsLmF0dHIoICJ0eXBlIiApOwoJCW5hbWUgPSAkZWwuYXR0ciggIm5hbWUiICk7CgoJCS8vIEFkZCBoaWRkZW4gaW5wdXQgZHVyaW5nIHN1Ym1pdCBpZiBpbnB1dCB0eXBlPSJzdWJtaXQiIGhhcyBhIG5hbWUuCgkJaWYgKCB0eXBlICE9PSAiYnV0dG9uIiAmJiB0eXBlICE9PSAicmVzZXQiICYmIG5hbWUgKSB7CgkJCQkkZWwuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJCS8vIEFkZCBoaWRkZW4gaW5wdXQgaWYgaXQgZG9lc24ndCBhbHJlYWR5IGV4aXN0LgoJCQkJCWlmICggJGJ1dHRvblBsYWNlaG9sZGVyID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSRidXR0b25QbGFjZWhvbGRlciA9ICQoICI8aW5wdXQ+IiwgewoJCQkJCQkJdHlwZTogImhpZGRlbiIsCgkJCQkJCQluYW1lOiAkZWwuYXR0ciggIm5hbWUiICksCgkJCQkJCQl2YWx1ZTogJGVsLmF0dHIoICJ2YWx1ZSIgKQoJCQkJCQl9KS5pbnNlcnRCZWZvcmUoICRlbCApOwoKCQkJCQkJLy8gQmluZCB0byBkb2MgdG8gcmVtb3ZlIGFmdGVyIHN1Ym1pdCBoYW5kbGluZwoJCQkJCQkkKCBkb2N1bWVudCApLm9uZSggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJGJ1dHRvblBsYWNlaG9sZGVyLnJlbW92ZSgpOwoKCQkJCQkJCS8vIHJlc2V0IHRoZSBsb2NhbCB2YXIgc28gdGhhdCB0aGUgaGlkZGVuIGlucHV0CgkJCQkJCQkvLyB3aWxsIGJlIHJlLWFkZGVkIG9uIHN1YnNlcXVlbnQgY2xpY2tzCgkJCQkJCQkkYnV0dG9uUGxhY2Vob2xkZXIgPSB1bmRlZmluZWQ7CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCX0KCgkJJGVsLmJpbmQoewoJCQlmb2N1czogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0sCgoJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCSRidXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLmJ1dHRvbi5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50OwoKCQlpZiAoICRlbC5wcm9wKCJkaXNhYmxlZCIpICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9IGVsc2UgewoJCQl0aGlzLmVuYWJsZSgpOwoJCX0KCgkJLy8gR3JhYiB0aGUgYnV0dG9uJ3MgdGV4dCBlbGVtZW50IGZyb20gaXRzIGltcGxlbWVudGF0aW9uLWluZGVwZW5kZW50IGRhdGEgaXRlbQoJCSQoIHRoaXMuYnV0dG9uLmRhdGEoICdidXR0b25FbGVtZW50cycgKS50ZXh0IClbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uY29udHJvbGdyb3VwID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CglmdW5jdGlvbiBmbGlwQ2xhc3NlcyggZWxzLCBmbENvcm5lcnMgICkgewoJCWVscy5yZW1vdmVDbGFzcyggInVpLWJ0bi1jb3JuZXItYWxsIHVpLWNvcm5lci10b3AgdWktY29ybmVyLWJvdHRvbSB1aS1jb3JuZXItbGVmdCB1aS1jb3JuZXItcmlnaHQgdWktY29udHJvbGdyb3VwLWxhc3QgdWktc2hhZG93IiApCgkJCS5lcSggMCApLmFkZENsYXNzKCBmbENvcm5lcnNbIDAgXSApCgkJCS5lbmQoKQoJCQkubGFzdCgpLmFkZENsYXNzKCBmbENvcm5lcnNbIDEgXSApLmFkZENsYXNzKCAidWktY29udHJvbGdyb3VwLWxhc3QiICk7Cgl9CgoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJCQlkaXJlY3Rpb246ICRlbC5qcW1EYXRhKCAidHlwZSIgKSB8fCAidmVydGljYWwiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCQkJCQltaW5pOiAkZWwuanFtRGF0YSggIm1pbmkiICkKCQkJCQl9LCBvcHRpb25zICksCgkJCWdyb3VwbGVnZW5kID0gJGVsLmNoaWxkcmVuKCAibGVnZW5kIiApLAoJCQlncm91cGhlYWRpbmcgPSAkZWwuY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWxhYmVsIiApLAoJCQlncm91cGNvbnRyb2xzID0gJGVsLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKSwKCQkJZmxDb3JuZXJzID0gby5kaXJlY3Rpb24gPT09ICJob3Jpem9udGFsIiA/IFsgInVpLWNvcm5lci1sZWZ0IiwgInVpLWNvcm5lci1yaWdodCIgXSA6IFsgInVpLWNvcm5lci10b3AiLCAidWktY29ybmVyLWJvdHRvbSIgXSwKCQkJdHlwZSA9ICRlbC5maW5kKCAiaW5wdXQiICkuZmlyc3QoKS5hdHRyKCAidHlwZSIgKTsKCgkJLy8gRmlyc3QgdW53cmFwIHRoZSBjb250cm9scyBpZiB0aGUgY29udHJvbGdyb3VwIHdhcyBhbHJlYWR5IGVuaGFuY2VkCgkJaWYgKCBncm91cGNvbnRyb2xzLmxlbmd0aCApIHsKCQkJZ3JvdXBjb250cm9scy5jb250ZW50cygpLnVud3JhcCgpOwoJCX0KCQkkZWwud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICk7CgoJCWlmICggZ3JvdXBsZWdlbmQubGVuZ3RoICkgewoJCQkvLyBSZXBsYWNlIGxlZ2VuZCB3aXRoIG1vcmUgc3R5bGFibGUgcmVwbGFjZW1lbnQgZGl2CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPiIgKyBncm91cGxlZ2VuZC5odG1sKCkgKyAiPC9kaXY+IiApLmluc2VydEJlZm9yZSggJGVsLmNoaWxkcmVuKCAwICkgKTsKCQkJZ3JvdXBsZWdlbmQucmVtb3ZlKCk7CgkJfSBlbHNlIGlmICggZ3JvdXBoZWFkaW5nLmxlbmd0aCApIHsKCQkJLy8gSnVzdCBtb3ZlIHRoZSBoZWFkaW5nIGlmIHRoZSBjb250cm9sZ3JvdXAgd2FzIGFscmVhZHkgZW5oYW5jZWQKCQkJJGVsLnByZXBlbmQoIGdyb3VwaGVhZGluZyApOwoJCX0KCgkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAgdWktY29udHJvbGdyb3VwLSIgKyBvLmRpcmVjdGlvbiApOwoKCQlmbGlwQ2xhc3NlcyggJGVsLmZpbmQoICIudWktYnRuIiArICggby5leGNsdWRlSW52aXNpYmxlID8gIjp2aXNpYmxlIiA6ICIiICkgKS5ub3QoICcudWktc2xpZGVyLWhhbmRsZScgKSwgZmxDb3JuZXJzICk7CgkJZmxpcENsYXNzZXMoICRlbC5maW5kKCAiLnVpLWJ0bi1pbm5lciIgKSwgZmxDb3JuZXJzICk7CgoJCWlmICggby5zaGFkb3cgKSB7CgkJCSRlbC5hZGRDbGFzcyggInVpLXNoYWRvdyIgKTsKCQl9CgoJCWlmICggby5taW5pICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1taW5pIiApOwoJCX0KCgl9KTsKfTsKCi8vIFRoZSBwYWdlY3JlYXRlIGhhbmRsZXIgZm9yIGNvbnRyb2xncm91cCBpcyBpbiBqcXVlcnkubW9iaWxlLmluaXQgYmVjYXVzZSBvZiB0aGUgc29mdC1kZXBlbmRlbmN5IG9uIHRoZSB3cmFwcGVkIHdpZGdldHMKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpblNpemUsIHNlZ1NpemUsIG9mZnNldCwgZGVzaXJlZCApIHsKCQl2YXIgcmV0ID0gZGVzaXJlZDsKCgkJaWYgKCB3aW5TaXplIDwgc2VnU2l6ZSApIHsKCQkJLy8gQ2VudGVyIHNlZ21lbnQgaWYgaXQncyBiaWdnZXIgdGhhbiB0aGUgd2luZG93CgkJCXJldCA9IG9mZnNldCArICggd2luU2l6ZSAtIHNlZ1NpemUgKSAvIDI7CgkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlIGNlbnRlciBpdCBhdCB0aGUgZGVzaXJlZCBjb29yZGluYXRlIHdoaWxlIGtlZXBpbmcgaXQgY29tcGxldGVseSBpbnNpZGUgdGhlIHdpbmRvdwoJCQlyZXQgPSBNYXRoLm1pbiggTWF0aC5tYXgoIG9mZnNldCwgZGVzaXJlZCAtIHNlZ1NpemUgLyAyICksIG9mZnNldCArIHdpblNpemUgLSBzZWdTaXplICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWZ1bmN0aW9uIHdpbmRvd0Nvb3JkcygpIHsKCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApOwoKCQlyZXR1cm4gewoJCQl4OiAkd2luLnNjcm9sbExlZnQoKSwKCQkJeTogJHdpbi5zY3JvbGxUb3AoKSwKCQkJY3g6ICggd2luZG93LmlubmVyV2lkdGggfHwgJHdpbi53aWR0aCgpICksCgkJCWN5OiAoIHdpbmRvdy5pbm5lckhlaWdodCB8fCAkd2luLmhlaWdodCgpICkKCQl9OwoJfQoKCSQud2lkZ2V0KCAibW9iaWxlLnBvcHVwIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogbnVsbCwKCQkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCQlzaGFkb3c6IHRydWUsCgkJCWNvcm5lcnM6IHRydWUsCgkJCXRyYW5zaXRpb246ICJub25lIiwKCQkJcG9zaXRpb25UbzogIm9yaWdpbiIsCgkJCXRvbGVyYW5jZTogbnVsbCwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSIsCgkJCWNsb3NlTGlua1NlbGVjdG9yOiAiYTpqcW1EYXRhKHJlbD0nYmFjaycpIiwKCQkJY2xvc2VMaW5rRXZlbnRzOiAiY2xpY2sucG9wdXAiLAoJCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQkJY2xvc2VFdmVudHM6ICJuYXZpZ2F0ZS5wb3B1cCBwYWdlYmVmb3JlY2hhbmdlLnBvcHVwIiwKCgkJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJCS8vCgkJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIuaWUKCQl9LAoKCQlfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gc2l6ZSBpcyBpbmNyZWFzZWQgYmV5b25kIHRoZSBwYWdlIGhlaWdodCBpZiB0aGUgcG9wdXAncyBjYXVzZXMgdGhlIGRvY3VtZW50IHRvIGluY3JlYXNlIGluIGhlaWdodAoJCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl2YXIgcG9wdXBIZWlnaHQgPSB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCWlmICggcG9wdXBIZWlnaHQgPiB0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCkgKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gJiYgZS5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVTQ0FQRSApIHsKCQkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCBlICk7CgkJCX0KCQl9LAoKCQlfbWF5YmVSZWZyZXNoVGltZW91dDogZnVuY3Rpb24oKSB7CgkJCXZhciB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCWlmICggdGhpcy5fcmVzaXplRGF0YSApIHsKCQkJCWlmICggd2luQ29vcmRzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLnggJiYKCQkJCQl3aW5Db29yZHMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueSAmJgoJCQkJCXdpbkNvb3Jkcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3ggJiYKCQkJCQl3aW5Db29yZHMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luQ29vcmRzLmN5ICkgewoJCQkJCS8vIHRpbWVvdXQgbm90IHJlZnJlc2hlZAoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY2xlYXIgZXhpc3RpbmcgdGltZW91dCAtIGl0IHdpbGwgYmUgcmVmcmVzaGVkIGJlbG93CgkJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQkJdGltZW91dElkOiBzZXRUaW1lb3V0KCAkLnByb3h5KCB0aGlzLCAiX3Jlc2l6ZVRpbWVvdXQiICksIDIwMCApLAoJCQkJd2luQ29vcmRzOiB3aW5Db29yZHMKCQkJfTsKCgkJCXJldHVybiB0cnVlOwoJCX0sCgoJCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5fbWF5YmVSZWZyZXNoVGltZW91dCgpICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtb3BlbiB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJdGhpcy5fdHJpZ2dlciggImJlZm9yZXBvc2l0aW9uIiApOwoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLnJlbW92ZUNsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCQkub2Zmc2V0KCB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAid2luZG93IiApICkgKTsKCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93UmVzaXplOiBmdW5jdGlvbiggZSApIHsKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl9tYXliZVJlZnJlc2hUaW1lb3V0KCk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlV2luZG93T3JpZW50YXRpb25jaGFuZ2U6IGZ1bmN0aW9uKCBlICkgewoKCQkJaWYgKCAhdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCQl9CgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciB1aSA9IHsKCQkJCQlzY3JlZW46ICQoICI8ZGl2IGNsYXNzPSd1aS1zY3JlZW4taGlkZGVuIHVpLXBvcHVwLXNjcmVlbic+PC9kaXY+IiApLAoJCQkJCXBsYWNlaG9sZGVyOiAkKCAiPGRpdiBzdHlsZT0nZGlzcGxheTogbm9uZTsnPjwhLS0gcGxhY2Vob2xkZXIgLS0+PC9kaXY+IiApLAoJCQkJCWNvbnRhaW5lcjogJCggIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWNvbnRhaW5lciB1aS1zZWxlY3RtZW51LWhpZGRlbic+PC9kaXY+IiApCgkJCQl9LAoJCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQkJbXlJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQkJdGhpcy5vcHRpb25zLmhpc3RvcnkgPSB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJdGhpc1BhZ2UgPSAkKCAiYm9keSIgKTsKCQkJfQoKCQkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkJLy8gVE9ETyB0aGlzIHdvdWxkIGJlIG5pY2UgYXQgdGhlIHRoZSBtb2JpbGUgd2lkZ2V0IGxldmVsCgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIgPSB0aGlzLm9wdGlvbnMuY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJdGhpc1BhZ2UuYXBwZW5kKCB1aS5zY3JlZW4gKTsKCQkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGlzLmVsZW1lbnQgKTsKCQkJaWYgKCBteUlkICkgewoJCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCQl9CgkJCXVpLmNvbnRhaW5lci5hcHBlbmQoIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gQWRkIGNsYXNzIHRvIHBvcHVwIGVsZW1lbnQKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktcG9wdXAiICk7CgoJCQkvLyBEZWZpbmUgaW5zdGFuY2UgdmFyaWFibGVzCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCQlfdWk6IHVpLAoJCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQkJX3ByZXJlcXM6IG51bGwsCgkJCQlfaXNPcGVuOiBmYWxzZSwKCQkJCV90b2xlcmFuY2U6IG51bGwsCgkJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlLAoJCQkJX2dsb2JhbEhhbmRsZXJzOiBbCgkJCQkJewoJCQkJCQlzcmM6ICQoIHdpbmRvdyApLAoJCQkJCQloYW5kbGVyOiB7CgkJCQkJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJCQkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCQkJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCQkJCQl9CgkJCQkJfQoJCQkJXQoJCQl9KTsKCgkJCSQuZWFjaCggdGhpcy5vcHRpb25zLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCS8vIENhdXNlIGluaXRpYWwgb3B0aW9ucyB0byBiZSBhcHBsaWVkIGJ5IHRoZWlyIGhhbmRsZXIgYnkgdGVtcG9yYXJpbHkgc2V0dGluZyB0aGUgb3B0aW9uIHRvIHVuZGVmaW5lZAoJCQkJLy8gLSB0aGUgaGFuZGxlciB0aGVuIHNldHMgaXQgdG8gdGhlIGluaXRpYWwgdmFsdWUKCQkJCXNlbGYub3B0aW9uc1sga2V5IF0gPSB1bmRlZmluZWQ7CgkJCQlzZWxmLl9zZXRPcHRpb24oIGtleSwgdmFsdWUsIHRydWUgKTsKCQkJfSk7CgoJCQl1aS5zY3JlZW4uYmluZCggInZjbGljayIsICQucHJveHkoIHRoaXMsICJfZWF0RXZlbnRBbmRDbG9zZSIgKSApOwoKCQkJJC5lYWNoKCB0aGlzLl9nbG9iYWxIYW5kbGVycywgZnVuY3Rpb24oIGlkeCwgdmFsdWUgKSB7CgkJCQl2YWx1ZS5zcmMuYmluZCggdmFsdWUuaGFuZGxlciApOwoJCQl9KTsKCQl9LAoKCQlfYXBwbHlUaGVtZTogZnVuY3Rpb24oIGRzdCwgdGhlbWUsIHByZWZpeCApIHsKCQkJdmFyIGNsYXNzZXMgPSAoIGRzdC5hdHRyKCAiY2xhc3MiICkgfHwgIiIpLnNwbGl0KCAiICIgKSwKCQkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCQljdXJyZW50VGhlbWUgPSBudWxsLAoJCQkJbWF0Y2hlcywKCQkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQkJd2hpbGUgKCBjbGFzc2VzLmxlbmd0aCA+IDAgKSB7CgkJCQljdXJyZW50VGhlbWUgPSBjbGFzc2VzLnBvcCgpOwoJCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCBtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMSApIHsKCQkJCQljdXJyZW50VGhlbWUgPSBtYXRjaGVzWyAxIF07CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICggdGhlbWUgIT09IGN1cnJlbnRUaGVtZSApIHsKCQkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggISAoIHRoZW1lID09PSBudWxsIHx8IHRoZW1lID09PSAibm9uZSIgKSApIHsKCQkJCQlkc3QuYWRkQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgdGhlbWVTdHIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLmVsZW1lbnQsIHZhbHVlLCAiYm9keSIgKTsKCQl9LAoKCQlfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuX3VpLnNjcmVlbiwgdmFsdWUsICJvdmVybGF5IiApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAmJiB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQl0aGlzLl91aS5jb250YWluZXIuYWRkQ2xhc3MoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiApOwoJCQl9CgkJfSwKCgkJX3NldFRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCX0KCQl9LAoKCQlfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciB0b2wgPSB7IHQ6IDMwLCByOiAxNSwgYjogMzAsIGw6IDE1IH07CgoJCQlpZiAoIHZhbHVlICkgewoJCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJCWNhc2UgMToKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCQljYXNlIDI6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJCWNhc2UgNDoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJZGVmYXVsdDoKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIGV4Y2x1c2lvbnMsIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJLy8gVE9ETyBSRU1PVkUgRk9SIDEuMi4xIGJ5IG1vdmluZyB0aGVtIG91dCB0byBhIGRlZmF1bHQgb3B0aW9ucyBvYmplY3QKCQkJZXhjbHVzaW9ucyA9IFsKCQkJCSJpbml0U2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua1NlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtFdmVudHMiLAoJCQkJIm5hdmlnYXRlRXZlbnRzIiwKCQkJCSJjbG9zZUV2ZW50cyIsCgkJCQkiaGlzdG9yeSIsCgkJCQkiY29udGFpbmVyIgoJCQldOwoKCQkJJC5tb2JpbGUud2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJaWYgKCAkLmluQXJyYXkoIGtleSwgZXhjbHVzaW9ucyApID09PSAtMSApIHsKCQkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCQlfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJdmFyCgkJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJCXJjID0gewoJCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQkJY3g6IHdpbkNvb3Jkcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQkJY3k6IHdpbkNvb3Jkcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJCX0sCgkJCQltZW51U2l6ZSwgcmV0OwoKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQkJbWVudVNpemUgPSB7CgkJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCQl9OwoKCQkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQkJcmV0ID0gewoJCQkJeDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN4LCBtZW51U2l6ZS5jeCwgcmMueCwgZGVzaXJlZC54ICksCgkJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCQl9OwoKCQkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCQkvLyBmaXggZm9yICQoIGRvY3VtZW50ICkuaGVpZ2h0KCkgYnVnIGluIGNvcmUgMS43LjIuCgkJCXZhciBkb2NFbCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgZG9jQm9keSA9IGRvY3VtZW50LmJvZHksCgkJCQlkb2NIZWlnaHQgPSBNYXRoLm1heCggZG9jRWwuY2xpZW50SGVpZ2h0LCBkb2NCb2R5LnNjcm9sbEhlaWdodCwgZG9jQm9keS5vZmZzZXRIZWlnaHQsIGRvY0VsLnNjcm9sbEhlaWdodCwgZG9jRWwub2Zmc2V0SGVpZ2h0ICk7CgoJCQlyZXQueSAtPSBNYXRoLm1pbiggcmV0LnksIE1hdGgubWF4KCAwLCByZXQueSArIG1lbnVTaXplLmN5IC0gZG9jSGVpZ2h0ICkgKTsKCgkJCXJldHVybiB7IGxlZnQ6IHJldC54LCB0b3A6IHJldC55IH07CgkJfSwKCgkJX2NyZWF0ZVByZXJlcXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXEsIGNvbnRhaW5lclByZXJlcSwgd2hlbkRvbmUgKSB7CgkJCXZhciBzZWxmID0gdGhpcywgcHJlcmVxczsKCgkJCS8vIEl0IGlzIGltcG9ydGFudCB0byBtYWludGFpbiBib3RoIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIGFuZCBzZWxmLl9wcmVyZXFzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbgoJCQkvLyB0aGUgY2xvc3VyZSBvZiB0aGUgZnVuY3Rpb25zIHdoaWNoIGNhbGwgdGhlIGNhbGxiYWNrcyBwYXNzZWQgaW4uIFRoZSBjb21wYXJpc29uIGJldHdlZW4gdGhlIGxvY2FsIHZhcmlhYmxlIGFuZAoJCQkvLyBzZWxmLl9wcmVyZXFzIGlzIG5lY2Vzc2FyeSwgYmVjYXVzZSBvbmNlIGEgZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkCgkJCS8vIG5leHQgdGltZSBhbiBhbmltYXRpb24gY29tcGxldGVzLCBldmVuIGlmIHRoYXQncyBub3QgdGhlIGFuaW1hdGlvbiB3aG9zZSBlbmQgdGhlIGZ1bmN0aW9uIHdhcyBzdXBwb3NlZCB0byBjYXRjaAoJCQkvLyAoZm9yIGV4YW1wbGUsIGlmIGFuIGFib3J0IGhhcHBlbnMgZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdCBjYWxsZWQgZm9yCgkJCS8vIHRoYXQgYW5pbWF0aW9uIGFueW1vcmUsIGJ1dCB0aGUgaGFuZGxlciByZW1haW5zIGF0dGFjaGVkLCBzbyBpdCBpcyBjYWxsZWQgdGhlIG5leHQgdGltZSB0aGUgcG9wdXAgaXMgb3BlbmVkCgkJCS8vIC0gbWFraW5nIGl0IHN0YWxlLiBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZSBzZWxmLl9wcmVyZXFzIGVuc3VyZXMgdGhhdAoJCQkvLyBjYWxsYmFja3MgdHJpZ2dlcmVkIGJ5IGEgc3RhbGUgLmFuaW1hdGlvbkNvbXBsZXRlIHdpbGwgYmUgaWdub3JlZC4KCgkJCXByZXJlcXMgPSB7CgkJCQlzY3JlZW46ICQuRGVmZXJyZWQoKSwKCQkJCWNvbnRhaW5lcjogJC5EZWZlcnJlZCgpCgkJCX07CgoJCQlwcmVyZXFzLnNjcmVlbi50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzY3JlZW5QcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQlwcmVyZXFzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQljb250YWluZXJQcmVyZXEoKTsKCQkJCX0KCQkJfSk7CgoJCQkkLndoZW4oIHByZXJlcXMuc2NyZWVuLCBwcmVyZXFzLmNvbnRhaW5lciApLmRvbmUoIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBwcmVyZXFzID09PSBzZWxmLl9wcmVyZXFzICkgewoJCQkJCXNlbGYuX3ByZXJlcXMgPSBudWxsOwoJCQkJCXdoZW5Eb25lKCk7CgkJCQl9CgkJCX0pOwoKCQkJc2VsZi5fcHJlcmVxcyA9IHByZXJlcXM7CgkJfSwKCgkJX2FuaW1hdGU6IGZ1bmN0aW9uKCBhcmdzICkgewoJCQkvLyBOT1RFIGJlZm9yZSByZW1vdmluZyB0aGUgZGVmYXVsdCBhbmltYXRpb24gb2YgdGhlIHNjcmVlbgoJCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZWxvdmUgdGhlIGRlZmVycmVkCgkJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCQkvLyBUT0RPIHJlbW92ZSB0aGUgZGVwZW5kZW5jeSBvbiB0aGUgc2NyZWVuIGRlZmVycmVkCgkJCXRoaXMuX3VpLnNjcmVlbgoJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkJLmFkZENsYXNzKCBhcmdzLnNjcmVlbkNsYXNzVG9BZGQgKTsKCgkJCWFyZ3MucHJlcmVxcy5zY3JlZW4ucmVzb2x2ZSgpOwoKCQkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCQlpZiAoIGFyZ3MuYXBwbHlUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggYXJncy50cmFuc2l0aW9uICk7CgkJCQl9CgkJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkuYWRkQ2xhc3MoIGFyZ3MuY29udGFpbmVyQ2xhc3NUb0FkZCApCgkJCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQkJfSBlbHNlIHsKCQkJCWFyZ3MucHJlcmVxcy5jb250YWluZXIucmVzb2x2ZSgpOwoJCQl9CgkJfSwKCgkJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJCS8vIGRlc2lyZWRQb3NpdGlvbi5wb3NpdGlvblRvLiBOZXZlcnRoZWxlc3MsIHRoaXMgZnVuY3Rpb24gZW5zdXJlcyB0aGF0IGl0cyByZXR1cm4gdmFsdWUgYWx3YXlzIGNvbnRhaW5zIHZhbGlkCgkJLy8geCBhbmQgeSBjb29yZGluYXRlcyBieSBzcGVjaWZ5aW5nIHRoZSBjZW50ZXIgbWlkZGxlIG9mIHRoZSB3aW5kb3cgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSBhYnNlbnQuCgkJX2Rlc2lyZWRDb29yZHM6IGZ1bmN0aW9uKCB4LCB5LCBwb3NpdGlvblRvICkgewoJCQl2YXIgZHN0ID0gbnVsbCwgb2Zmc2V0LCB3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKTsKCgkJCS8vIEVzdGFibGlzaCB3aGljaCBlbGVtZW50IHdpbGwgc2VydmUgYXMgdGhlIHJlZmVyZW5jZQoJCQlpZiAoIHBvc2l0aW9uVG8gJiYgcG9zaXRpb25UbyAhPT0gIm9yaWdpbiIgKSB7CgkJCQlpZiAoIHBvc2l0aW9uVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJCXggPSB3aW5Db29yZHMuY3ggLyAyICsgd2luQ29vcmRzLng7CgkJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJCX0gZWxzZSB7CgkJCQkJdHJ5IHsKCQkJCQkJZHN0ID0gJCggcG9zaXRpb25UbyApOwoJCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJCWlmICggZHN0ICkgewoJCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJCWRzdCA9IG51bGw7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCQlpZiAoIGRzdCApIHsKCQkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJfQoJCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJfQoKCQkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJCX0sCgoJCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJc2VsZi5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQlzZWxmLl9pc09wZW4gPSB0cnVlOwoJCQlzZWxmLl9yZXNpemVTY3JlZW4oKTsKCgkJCS8vIEFuZHJvaWQgYXBwZWFycyB0byB0cmlnZ2VyIHRoZSBhbmltYXRpb24gY29tcGxldGUgYmVmb3JlIHRoZSBwb3B1cAoJCQkvLyBpcyB2aXNpYmxlLiBBbGxvd2luZyB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSBhcHBseWluZyBmb2N1cyBwcmV2ZW50cwoJCQkvLyB0aGUgImJsdWUgZmxhc2giIG9mIGVsZW1lbnQgZm9jdXMgaW4gYW5kcm9pZCA0LjAKCQkJc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJc2VsZi5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJCQlzZWxmLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJCQl9KTsKCQl9LAoKCQlfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXZhciBjb29yZHMsIHRyYW5zaXRpb24sCgkJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQkJdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQkJCQkvLyBSZW5kZXJpbmcgZW5naW5lIGlzIFdlYmtpdCwgYW5kIGNhcHR1cmUgbWFqb3IgdmVyc2lvbgoJCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQkJYW5kcm9pZG1hdGNoID0gdWEubWF0Y2goIC9BbmRyb2lkIChcZCsoPzpcLlxkKykpLyApLAoJCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJCWNocm9tZW1hdGNoID0gdWEuaW5kZXhPZiggIkNocm9tZSIgKSA+IC0xOwoKCQkJCQkvLyBQbGF0Zm9ybSBpcyBBbmRyb2lkLCBXZWJLaXQgdmVyc2lvbiBpcyBncmVhdGVyIHRoYW4gNTM0LjEzICggQW5kcm9pZCAzLjIuMSApIGFuZCBub3QgQ2hyb21lLgoJCQkJCWlmKCBhbmRyb2lkbWF0Y2ggIT09IG51bGwgJiYgYW5kdmVyc2lvbiA9PT0gIjQuMCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA+IDUzNC4xMyAmJiAhY2hyb21lbWF0Y2ggKSB7CgkJCQkJCXJldHVybiB0cnVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9KCkpOwoKCQkJLy8gTWFrZSBzdXJlIG9wdGlvbnMgaXMgZGVmaW5lZAoJCQlvcHRpb25zID0gKCBvcHRpb25zIHx8IHt9ICk7CgoJCQkvLyBDb3B5IG91dCB0aGUgdHJhbnNpdGlvbiwgYmVjYXVzZSB3ZSBtYXkgYmUgb3ZlcndyaXRpbmcgaXQgbGF0ZXIgYW5kIHdlIGRvbid0IHdhbnQgdG8gcGFzcyB0aGF0IGNoYW5nZSBiYWNrIHRvIHRoZSBjYWxsZXIKCQkJdHJhbnNpdGlvbiA9IG9wdGlvbnMudHJhbnNpdGlvbiB8fCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iICk7CgoJCQljb29yZHMgPSB0aGlzLl9wbGFjZW1lbnRDb29yZHMoIHRoaXMuX2Rlc2lyZWRDb29yZHMoIG9wdGlvbnMueCwgb3B0aW9ucy55LCBvcHRpb25zLnBvc2l0aW9uVG8gfHwgdGhpcy5vcHRpb25zLnBvc2l0aW9uVG8gfHwgIm9yaWdpbiIgKSApOwoKCQkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyb3BlbiIgLSB3ZSBoYXZlIHR3byBwcmVyZXF1aXNpdGVzOgoJCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IGFuaW1hdGlvbiBjb21wbGV0ZXMgKGNvbnRhaW5lcigpKQoJCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJCXRoaXMuX2NyZWF0ZVByZXJlcXMoCgkJCQkkLm5vb3AsCgkJCQkkLm5vb3AsCgkJCQkkLnByb3h5KCB0aGlzLCAiX29wZW5QcmVyZXFzQ29tcGxldGUiICkgKTsKCgkJCWlmICggdHJhbnNpdGlvbiApIHsKCQkJCXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uID0gdHJhbnNpdGlvbjsKCQkJCXRoaXMuX2FwcGx5VHJhbnNpdGlvbiggdHJhbnNpdGlvbiApOwoJCQl9IGVsc2UgewoJCQkJdHJhbnNpdGlvbiA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoJCQl9CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggdGhpcy5fcGFnZS5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuX3BhZ2UsICJjIiApICk7CgkJCX0KCgkJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNlbGVjdG1lbnUtaGlkZGVuIiApCgkJCQkub2Zmc2V0KCBjb29yZHMgKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkJLyogVE9ETzoKCQkJCVRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkCgkJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQkJdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6CgkJCQlodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgoJCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkJKi8KCgkJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCQl9CgkJCXRoaXMuX2FuaW1hdGUoewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJCXRyYW5zaXRpb246IHRyYW5zaXRpb24sCgkJCQljbGFzc1RvUmVtb3ZlOiAiIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCQljb250YWluZXJDbGFzc1RvQWRkOiAiaW4iLAoJCQkJYXBwbHlUcmFuc2l0aW9uOiBmYWxzZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoICJvdXQiICkKCQkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxQ29udGFpbmVyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoICJyZXZlcnNlIG91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktc2VsZWN0bWVudS1oaWRkZW4iICkKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxc0RvbmU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIG9wdHMgPSBzZWxmLm9wdGlvbnM7CgoJCQlzZWxmLl91aS5jb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkJLy8gcmVtb3ZlIG5hdiBiaW5kaW5ncyBpZiB0aGV5IGFyZSBzdGlsbCBwcmVzZW50CgkJCW9wdHMuY29udGFpbmVyLnVuYmluZCggb3B0cy5jbG9zZUV2ZW50cyApOwoKCQkJLy8gdW5iaW5kIGNsaWNrIGhhbmRsZXJzIGFkZGVkIHdoZW4gaGlzdG9yeSBpcyBkaXNhYmxlZAoJCQlzZWxmLmVsZW1lbnQudW5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMgKTsKCgkJCS8vIHJlbW92ZSB0aGUgZ2xvYmFsIG11dGV4IGZvciBwb3B1cHMKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkJLy8gYWxlcnQgdXNlcnMgdGhhdCB0aGUgcG9wdXAgaXMgY2xvc2VkCgkJCXNlbGYuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJCX0sCgoJCV9jbG9zZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcVNjcmVlbiIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxc0RvbmUiICkgKTsKCgkJCXRoaXMuX2FuaW1hdGUoIHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQkJdHJhbnNpdGlvbjogKCB0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiB8fCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiApLAoJCQkJY2xhc3NUb1JlbW92ZTogImluIiwKCQkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJvdXQiLAoJCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJCWFwcGx5VHJhbnNpdGlvbjogdHJ1ZSwKCQkJCXByZXJlcXM6IHRoaXMuX3ByZXJlcXMKCQkJfSk7CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkvLyBoaWRlIGFuZCByZW1vdmUgYmluZGluZ3MKCQkJc2VsZi5fY2xvc2UoKTsKCgkJCS8vIFB1dCB0aGUgZWxlbWVudCBiYWNrIHRvIHdoZXJlIHRoZSBwbGFjZWhvbGRlciB3YXMgYW5kIHJlbW92ZSB0aGUgInVpLXBvcHVwIiBjbGFzcwoJCQlzZWxmLl9zZXRUaGVtZSggIm5vbmUiICk7CgkJCXNlbGYuZWxlbWVudAoJCQkJLmluc2VydEFmdGVyKCBzZWxmLl91aS5wbGFjZWhvbGRlciApCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cCB1aS1vdmVybGF5LXNoYWRvdyB1aS1jb3JuZXItYWxsIiApOwoJCQlzZWxmLl91aS5zY3JlZW4ucmVtb3ZlKCk7CgkJCXNlbGYuX3VpLmNvbnRhaW5lci5yZW1vdmUoKTsKCQkJc2VsZi5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7CgoJCQkvLyBVbmJpbmQgaGFuZGxlcnMgdGhhdCB3ZXJlIGJvdW5kIHRvIGVsZW1lbnRzIG91dHNpZGUgc2VsZi5lbGVtZW50ICh0aGUgd2luZG93LCBpbiBzZWxmIGNhc2UpCgkJCSQuZWFjaCggc2VsZi5fZ2xvYmFsSGFuZGxlcnMsIGZ1bmN0aW9uKCBpZHgsIG9uZVNyYyApIHsKCQkJCSQuZWFjaCggb25lU3JjLmhhbmRsZXIsIGZ1bmN0aW9uKCBldmVudFR5cGUsIGhhbmRsZXIgKSB7CgkJCQkJb25lU3JjLnNyYy51bmJpbmQoIGV2ZW50VHlwZSwgaGFuZGxlciApOwoJCQkJfSk7CgkJCX0pOwoJCX0sCgoJCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCQkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCQkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQlzZWxmLm9wdGlvbnMuY29udGFpbmVyCgkJCQkub25lKCBzZWxmLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHNlbGYuX2Nsb3NlLCBzZWxmICkpOwoJCX0sCgoJCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCQkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCQlvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gdGhpcy5vcHRpb25zLCB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeTsKCgkJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCgkJCS8vIGlmIGhpc3RvcnkgYWx0ZXJhdGlvbiBpcyBkaXNhYmxlZCBjbG9zZSBvbiBuYXZpZ2F0ZSBldmVudHMKCQkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQkJaWYoICEoIG9wdHMuaGlzdG9yeSApICkgewoJCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgoJCQkJLy8gV2hlbiBoaXN0b3kgaXMgZGlzYWJsZWQgd2UgaGF2ZSB0byBncmFiIHRoZSBkYXRhLXJlbAoJCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJCS8vIHJlbHlpbmcgb24gaGlzdG9yeSB0byBkbyBpdCBmb3IgdXMKCQkJCXNlbGYuZWxlbWVudAoJCQkJCS5kZWxlZ2F0ZSggb3B0cy5jbG9zZUxpbmtTZWxlY3Rvciwgb3B0cy5jbG9zZUxpbmtFdmVudHMsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQlzZWxmLl9jbG9zZSgpOwoKCQkJCQkJLy8gTk9URSBwcmV2ZW50IHRoZSBicm93c2VyIGFuZCBuYXZpZ2F0aW9uIGhhbmRsZXJzIGZyb20KCQkJCQkJLy8gd29ya2luZyB3aXRoIHRoZSBsaW5rJ3MgcmVsPWJhY2suIFRoaXMgbWF5IGNhdXNlCgkJCQkJCS8vIGlzc3VlcyBmb3IgZGV2ZWxvcGVycyBleHBlY3RpbmcgdGhlIGV2ZW50IHRvIGJ1YmJsZQoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfSk7CgoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBjYWNoZSBzb21lIHZhbHVlcyBmb3IgbWluL3JlYWRhYmlsaXR5CgkJCWhhc2hrZXkgPSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5OwoJCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQkJY3VycmVudElzRGlhbG9nID0gYWN0aXZlUGFnZS5pcyggIi51aS1kaWFsb2ciICk7CgkJCXVybCA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCQloYXNIYXNoID0gKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID4gLTEgKSAmJiAhY3VycmVudElzRGlhbG9nOwoJCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUudXJsSGlzdG9yeTsKCgkJCWlmICggaGFzSGFzaCApIHsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgY3VycmVudCB1cmwgaGFzIG5vIGRpYWxvZyBoYXNoIGtleSBwcm9jZWVkIGFzIG5vcm1hbAoJCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCQlpZiAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPT09IC0xICYmICFjdXJyZW50SXNEaWFsb2cgKXsKCQkJCXVybCA9IHVybCArIGhhc2hrZXk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQkJfQoKCQkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBoYXNoa2V5OwoJCQl9CgoJCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkJb3B0cy5jb250YWluZXIub25lKCBvcHRzLm5hdmlnYXRlRXZlbnRzLCBmdW5jdGlvbiggZSApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCQl9KTsKCgkJCXVybEhpc3RvcnkuaWdub3JlTmV4dEhhc2hDaGFuZ2UgPSBjdXJyZW50SXNEaWFsb2c7CgoJCQkvLyBHb3R0YSBsb3ZlIG1ldGhvZHMgd2l0aCAxbW0gYXJncyA6KAoJCQl1cmxIaXN0b3J5LmFkZE5ldyggdXJsLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAiZGlhbG9nIiApOwoKCQkJLy8gc2V0IHRoZSBuZXcgdXJsIHdpdGggKG9yIHdpdGhvdXQpIHRoZSBuZXcgZGlhbG9nIGhhc2gga2V5CgkJCSQubW9iaWxlLnBhdGguc2V0KCB1cmwgKTsKCQl9LAoKCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJCWlmKCAhJC5tb2JpbGUucG9wdXAuYWN0aXZlICl7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmKCB0aGlzLm9wdGlvbnMuaGlzdG9yeSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX2Nsb3NlKCk7CgkJCX0KCQl9Cgl9KTsKCgoJLy8gVE9ETyB0aGlzIGNhbiBiZSBtb3ZlZCBpbnNpZGUgdGhlIHdpZGdldAoJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCQl2YXIgY2xvc2VzdFBhZ2UgPSAkbGluay5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlzY29wZSA9ICggKCBjbG9zZXN0UGFnZS5sZW5ndGggPT09IDAgKSA/ICQoICJib2R5IiApIDogY2xvc2VzdFBhZ2UgKSwKCQkJLy8gTk9URSBtYWtlIHN1cmUgdG8gZ2V0IG9ubHkgdGhlIGhhc2gsIGllNyAod3A3KSByZXR1cm4gdGhlIGFic29sdXRlIGhyZWYKCQkJLy8gICAgICBpbiB0aGlzIGNhc2UgcnVpbmluZyB0aGUgZWxlbWVudCBzZWxlY3Rpb24KCQkJcG9wdXAgPSAkKCAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCRsaW5rLmF0dHIoICJocmVmIiApKS5oYXNoLCBzY29wZVswXSApLAoJCQlvZmZzZXQ7CgoJCWlmICggcG9wdXAuZGF0YSggInBvcHVwIiApICkgewoJCQlvZmZzZXQgPSAkbGluay5vZmZzZXQoKTsKCQkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQkJeDogb2Zmc2V0LmxlZnQgKyAkbGluay5vdXRlcldpZHRoKCkgLyAyLAoJCQkJeTogb2Zmc2V0LnRvcCArICRsaW5rLm91dGVySGVpZ2h0KCkgLyAyLAoJCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlwb3NpdGlvblRvOiAkbGluay5qcW1EYXRhKCAicG9zaXRpb24tdG8iICksCgkJCQlsaW5rOiAkbGluawoJCQl9KTsKCQl9CgoJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCX0sIDMwMCApOwoJfTsKCgkvLyBUT0RPIG1vdmUgaW5zaWRlIF9jcmVhdGUKCSQoIGRvY3VtZW50ICkuYmluZCggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQlpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSk7CgoJJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApICB7CgkJJC5tb2JpbGUucG9wdXAucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSkiLAoJCWNsZWFyU2VhcmNoQnV0dG9uVGV4dDogImNsZWFyIHRleHQiLAoJCWRpc2FibGVkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJdGhlbWUgPSBvLnRoZW1lIHx8ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApLAoJCQl0aGVtZWNsYXNzICA9ICIgdWktYm9keS0iICsgdGhlbWUsCgkJCW1pbmkgPSBpbnB1dC5qcW1EYXRhKCAibWluaSIgKSA9PT0gdHJ1ZSwKCQkJbWluaWNsYXNzID0gbWluaSA/ICIgdWktbWluaSIgOiAiIiwKCQkJZm9jdXNlZEVsLCBjbGVhcmJ0bjsKCgkJZnVuY3Rpb24gdG9nZ2xlQ2xlYXIoKSB7CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJidG4udG9nZ2xlQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iLCAhaW5wdXQudmFsKCkgKTsKCQkJfSwgMCApOwoJCX0KCgkJJCggImxhYmVsW2Zvcj0nIiArIGlucHV0LmF0dHIoICJpZCIgKSArICInXSIgKS5hZGRDbGFzcyggInVpLWlucHV0LXRleHQiICk7CgoJCWZvY3VzZWRFbCA9IGlucHV0LmFkZENsYXNzKCJ1aS1pbnB1dC10ZXh0IHVpLWJvZHktIisgdGhlbWUgKTsKCgkJLy8gWFhYOiBUZW1wb3Jhcnkgd29ya2Fyb3VuZCBmb3IgaXNzdWUgNzg1IChBcHBsZSBidWcgODkxMDU4OSkuCgkJLy8gICAgICBUdXJuIG9mZiBhdXRvY29ycmVjdCBhbmQgYXV0b2NvbXBsZXRlIG9uIG5vbi1pT1MgNSBkZXZpY2VzCgkJLy8gICAgICBzaW5jZSB0aGUgcG9wdXAgdGhleSB1c2UgY2FuJ3QgYmUgZGlzbWlzc2VkIGJ5IHRoZSB1c2VyLiBOb3RlCgkJLy8gICAgICB0aGF0IHdlIHRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiB0aGUgZmVhdHVyZSBieSBsb29raW5nIGZvcgoJCS8vICAgICAgdGhlIGF1dG9jb3JyZWN0IHByb3BlcnR5IG9uIHRoZSBpbnB1dCBlbGVtZW50LiBXZSBjdXJyZW50bHkKCQkvLyAgICAgIGhhdmUgbm8gdGVzdCBmb3IgaU9TIDUgb3IgbmV3ZXIgc28gd2UncmUgdGVtcG9yYXJpbHkgdXNpbmcKCQkvLyAgICAgIHRoZSB0b3VjaE92ZXJmbG93IHN1cHBvcnQgZmxhZyBmb3IgalFNIDEuMC4gWWVzLCBJIGZlZWwgZGlydHkuIC0gamJsYXMKCQlpZiAoIHR5cGVvZiBpbnB1dFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYgISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoJCQkvLyBTZXQgdGhlIGF0dHJpYnV0ZSBpbnN0ZWFkIG9mIHRoZSBwcm9wZXJ0eSBqdXN0IGluIGNhc2UgdGhlcmUKCQkJLy8gaXMgY29kZSB0aGF0IGF0dGVtcHRzIHRvIG1ha2UgbW9kaWZpY2F0aW9ucyB2aWEgSFRNTC4KCQkJaW5wdXRbMF0uc2V0QXR0cmlidXRlKCAiYXV0b2NvcnJlY3QiLCAib2ZmIiApOwoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCgoJCS8vInNlYXJjaCIgaW5wdXQgd2lkZ2V0CgkJaWYgKCBpbnB1dC5pcyggIlt0eXBlPSdzZWFyY2gnXSw6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSApIHsKCgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC1zZWFyY2ggdWktc2hhZG93LWluc2V0IHVpLWJ0bi1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3cgdWktaWNvbi1zZWFyY2hmaWVsZCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCQljbGVhcmJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXInIHRpdGxlPSciICsgby5jbGVhclNlYXJjaEJ1dHRvblRleHQgKyAiJz4iICsgby5jbGVhclNlYXJjaEJ1dHRvblRleHQgKyAiPC9hPiIgKQoJCQkJLmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0CgkJCQkJCS52YWwoICIiICkKCQkJCQkJLmZvY3VzKCkKCQkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQltaW5pOiBtaW5pCgkJCQl9KTsKCgkJCXRvZ2dsZUNsZWFyKCk7CgoJCQlpbnB1dC5iaW5kKCAncGFzdGUgY3V0IGtleXVwIGZvY3VzIGNoYW5nZSBibHVyJywgdG9nZ2xlQ2xlYXIgKTsKCgkJfSBlbHNlIHsKCQkJaW5wdXQuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIHVpLXNoYWRvdy1pbnNldCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICk7CgkJfQoKCQlpbnB1dC5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCWZvY3VzZWRFbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBvLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCX0KCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQl0aGlzLl9rZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCWlucHV0LmhlaWdodChzY3JvbGxIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQpOwoJCQkJfQoJCQl9OwoKCQkJaW5wdXQua2V5dXAoZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggJChkb2N1bWVudCksIHsicGFnZWNoYW5nZSI6ICJfa2V5dXAiIH0pOwoKCQkJLy8gSXNzdWUgNTA5OiB0aGUgYnJvd3NlciBpcyBub3QgcHJvdmlkaW5nIHNjcm9sbEhlaWdodCBwcm9wZXJseSB1bnRpbCB0aGUgc3R5bGVzIGxvYWQKCQkJaWYgKCAkLnRyaW0oIGlucHV0LnZhbCgpICkgKSB7CgkJCQkvLyBiaW5kIHRvIHRoZSB3aW5kb3cgbG9hZCB0byBtYWtlIHN1cmUgdGhlIGhlaWdodCBpcyBjYWxjdWxhdGVkIGJhc2VkIG9uIEJPVEgKCQkJCS8vIHRoZSBET00gYW5kIENTUwoJCQkJdGhpcy5fb24oICQod2luZG93KSwgeyJsb2FkIjogIl9rZXl1cCJ9KTsKCQkJfQoJCX0KCQlpZiAoIGlucHV0LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsOwoJCWlmICggdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKS5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICkgKSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudC5wYXJlbnQoKTsKCQl9IGVsc2UgewoJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgkJfQoJCSRlbC5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsOwoKCQkvLyBUT0RPIHVzaW5nIG1vcmUgdGhhbiBvbmUgbGluZSBvZiBjb2RlIGlzIGFjY2VwdGFibGUgOykKCQlpZiAoIHRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApLmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRleHRpbnB1dC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlciA9IGZhbHNlOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciA9ICJGaWx0ZXIgaXRlbXMuLi4iOwokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJUaGVtZSA9ICJjIjsKLy8gVE9ETyByZW5hbWUgY2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCB0ZXh0LCBzZWFyY2hWYWx1ZSwgaXRlbSApIHsKCQlyZXR1cm4gdGV4dC50b1N0cmluZygpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTE7Cgl9OwoKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2sgPSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgokKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0nbGlzdHZpZXcnKSIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCWxpc3R2aWV3ID0gbGlzdC5kYXRhKCAibGlzdHZpZXciICk7CgoJaWYgKCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB3cmFwcGVyID0gJCggIjxmb3JtPiIsIHsKCQkJImNsYXNzIjogInVpLWxpc3R2aWV3LWZpbHRlciB1aS1iYXItIiArIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyVGhlbWUsCgkJCSJyb2xlIjogInNlYXJjaCIKCQl9KSwKCQlzZWFyY2ggPSAkKCAiPGlucHV0PiIsIHsKCQkJcGxhY2Vob2xkZXI6IGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIKCQl9KQoJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIsICJzZWFyY2giICkKCQkuanFtRGF0YSggImxhc3R2YWwiLCAiIiApCgkJLmJpbmQoICJrZXl1cCBjaGFuZ2UiLCBmdW5jdGlvbigpIHsKCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXZhbCA9IHRoaXMudmFsdWUudG9Mb3dlckNhc2UoKSwKCQkJCWxpc3RJdGVtcyA9IG51bGwsCgkJCQlsYXN0dmFsID0gJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICkgKyAiIiwKCQkJCWNoaWxkSXRlbXMgPSBmYWxzZSwKCQkJCWl0ZW10ZXh0ID0gIiIsCgkJCQlpdGVtLAoJCQkJLy8gQ2hlY2sgaWYgYSBjdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMKCQkJCWlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgPSBsaXN0dmlldy5vcHRpb25zLmZpbHRlckNhbGxiYWNrICE9PSBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgoJCQlsaXN0dmlldy5fdHJpZ2dlciggImJlZm9yZWZpbHRlciIsICJiZWZvcmVmaWx0ZXIiLCB7IGlucHV0OiB0aGlzIH0gKTsKCgkJCS8vIENoYW5nZSB2YWwgYXMgbGFzdHZhbCBmb3IgbmV4dCBleGVjdXRpb24KCQkJJHRoaXMuanFtRGF0YSggImxhc3R2YWwiICwgdmFsICk7CgkJCWlmICggaXNDdXN0b21GaWx0ZXJDYWxsYmFjayB8fCB2YWwubGVuZ3RoIDwgbGFzdHZhbC5sZW5ndGggfHwgdmFsLmluZGV4T2YoIGxhc3R2YWwgKSAhPT0gMCApIHsKCgkJCQkvLyBDdXN0b20gZmlsdGVyIGNhbGxiYWNrIGFwcGxpZXMgb3IgcmVtb3ZlZCBjaGFycyBvciBwYXN0ZWQgc29tZXRoaW5nIHRvdGFsbHkgZGlmZmVyZW50LCBjaGVjayBhbGwgaXRlbXMKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oKTsKCQkJfSBlbHNlIHsKCgkJCQkvLyBPbmx5IGNoYXJzIGFkZGVkLCBub3QgcmVtb3ZlZCwgb25seSB1c2UgdmlzaWJsZSBzdWJzZXQKCQkJCWxpc3RJdGVtcyA9IGxpc3QuY2hpbGRyZW4oICI6bm90KC51aS1zY3JlZW4taGlkZGVuKSIgKTsKCQkJfQoKCQkJaWYgKCB2YWwgKSB7CgoJCQkJLy8gVGhpcyBoYW5kbGVzIGhpZGluZyByZWd1bGFyIHJvd3Mgd2l0aG91dCB0aGUgdGV4dCB3ZSBzZWFyY2ggZm9yCgkJCQkvLyBhbmQgYW55IGxpc3QgZGl2aWRlcnMgd2l0aG91dCByZWd1bGFyIHJvd3Mgc2hvd24gdW5kZXIgaXQKCgkJCQlmb3IgKCB2YXIgaSA9IGxpc3RJdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSApIHsKCQkJCQlpdGVtID0gJCggbGlzdEl0ZW1zWyBpIF0gKTsKCQkJCQlpdGVtdGV4dCA9IGl0ZW0uanFtRGF0YSggImZpbHRlcnRleHQiICkgfHwgaXRlbS50ZXh0KCk7CgoJCQkJCWlmICggaXRlbS5pcyggImxpOmpxbURhdGEocm9sZT1saXN0LWRpdmlkZXIpIiApICkgewoKCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgIWNoaWxkSXRlbXMgKTsKCgkJCQkJCS8vIE5ldyBidWNrZXQhCgkJCQkJCWNoaWxkSXRlbXMgPSBmYWxzZTsKCgkJCQkJfSBlbHNlIGlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayggaXRlbXRleHQsIHZhbCwgaXRlbSApICkgewoKCQkJCQkJLy9tYXJrIHRvIGJlIGhpZGRlbgoJCQkJCQlpdGVtLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIgLCB0cnVlICk7CgkJCQkJfSBlbHNlIHsKCgkJCQkJCS8vIFRoZXJlJ3MgYSBzaG93biBpdGVtIGluIHRoZSBidWNrZXQKCQkJCQkJY2hpbGRJdGVtcyA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIFNob3cgaXRlbXMsIG5vdCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiOm5vdCgudWktZmlsdGVyLWhpZGVxdWV1ZSkiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgZmFsc2UgKTsKCgkJCQkvLyBIaWRlIGl0ZW1zLCBtYXJrZWQgdG8gYmUgaGlkZGVuCgkJCQlsaXN0SXRlbXMKCQkJCQkuZmlsdGVyKCAiLnVpLWZpbHRlci1oaWRlcXVldWUiICkKCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgdHJ1ZSApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktZmlsdGVyLWhpZGVxdWV1ZSIsIGZhbHNlICk7CgoJCQl9IGVsc2UgewoKCQkJCS8vZmlsdGVydmFsdWUgaXMgZW1wdHkgPT4gc2hvdyBhbGwKCQkJCWxpc3RJdGVtcy50b2dnbGVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iLCBmYWxzZSApOwoJCQl9CgkJCWxpc3R2aWV3Ll9yZWZyZXNoQ29ybmVycygpOwoJCX0pCgkJLmFwcGVuZFRvKCB3cmFwcGVyICkKCQkudGV4dGlucHV0KCk7CgoJaWYgKCBsaXN0dmlldy5vcHRpb25zLmluc2V0ICkgewoJCXdyYXBwZXIuYWRkQ2xhc3MoICJ1aS1saXN0dmlldy1maWx0ZXItaW5zZXQiICk7Cgl9CgoJd3JhcHBlci5iaW5kKCAic3VibWl0IiwgZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGZhbHNlOwoJfSkKCS5pbnNlcnRCZWZvcmUoIGxpc3QgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgewoJd2lkZ2V0RXZlbnRQcmVmaXg6ICJzbGlkZSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCXRyYWNrVGhlbWU6IG51bGwsCgkJZGlzYWJsZWQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3JhbmdlJ10sIDpqcW1EYXRhKHR5cGU9J3JhbmdlJyksIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpIiwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQljb250cm9sID0gdGhpcy5lbGVtZW50LAoKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggY29udHJvbCwgImMiICksCgoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgoJCQlzZWxlY3RDbGFzcyA9ICggY1R5cGUgPT09ICJzZWxlY3QiICkgPyAidWktc2xpZGVyLXN3aXRjaCIgOiAiIiwKCgkJCWNvbnRyb2xJRCA9IGNvbnRyb2wuYXR0ciggImlkIiApLAoKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgoJCQlsYWJlbElEID0gJGxhYmVsLmF0dHIoICJpZCIgKSB8fCBjb250cm9sSUQgKyAiLWxhYmVsIiwKCgkJCWxhYmVsID0gJGxhYmVsLmF0dHIoICJpZCIsIGxhYmVsSUQgKSwKCgkJCXZhbCA9IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICBjVHlwZSA9PT0gImlucHV0IiAgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0sCgoJCQltaW4gPSAgY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgoJCQltYXggPSAgY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCgkJCXN0ZXAgPSB3aW5kb3cucGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSB8fCAxICksCgoJCQlpbmxpbmVDbGFzcyA9ICggdGhpcy5vcHRpb25zLmlubGluZSB8fCBjb250cm9sLmpxbURhdGEoICJpbmxpbmUiICkgPT09IHRydWUgKSA/ICIgdWktc2xpZGVyLWlubGluZSIgOiAiIiwKCgkJCW1pbmlDbGFzcyA9ICggdGhpcy5vcHRpb25zLm1pbmkgfHwgY29udHJvbC5qcW1EYXRhKCAibWluaSIgKSApID8gIiB1aS1zbGlkZXItbWluaSIgOiAiIiwKCgoJCQlkb21IYW5kbGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnYScgKSwKCQkJaGFuZGxlID0gJCggZG9tSGFuZGxlICksCgkJCWRvbVNsaWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJCXNsaWRlciA9ICQoIGRvbVNsaWRlciApLAoKCQkJdmFsdWViZyA9IGNvbnRyb2wuanFtRGF0YSggImhpZ2hsaWdodCIgKSAmJiBjVHlwZSAhPT0gInNlbGVjdCIgPyAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgYmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItYmcgJyArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgJyB1aS1idG4tY29ybmVyLWFsbCc7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgoJCQlvcHRpb25zOwoKCQl0aGlzLl90eXBlID0gY1R5cGU7CgoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICdocmVmJywgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSgncm9sZScsJ2FwcGxpY2F0aW9uJyk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFsndWktc2xpZGVyICcsc2VsZWN0Q2xhc3MsIiB1aS1idG4tZG93bi0iLHRyYWNrVGhlbWUsJyB1aS1idG4tY29ybmVyLWFsbCcsIGlubGluZUNsYXNzLCBtaW5pQ2xhc3NdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaGFuZGxlJzsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdmFsKCksCgkJCQkJImFyaWEtdmFsdWV0ZXh0IjogdmFsKCksCgkJCQkJInRpdGxlIjogdmFsKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCQl3cmFwcGVyLmNsYXNzTmFtZSA9ICd1aS1zbGlkZXItaW5uZXJvZmZzZXQnOwoKCQkJZm9yICggdmFyIGogPSAwLGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDtqIDwgbGVuZ3RoO2orKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggdmFyIGkgPSAwLCBvcHRpb25zQ291bnQgPSBvcHRpb25zLmxlbmd0aDsgaSA8IG9wdGlvbnNDb3VudDsgaSsrICkgewoJCQkJdmFyIHNpZGUgPSAhaSA/ICJiIiA6ICJhIiwKCQkJCQlzbGlkZXJUaGVtZSA9ICFpID8gIiB1aS1idG4tZG93bi0iICsgdHJhY2tUaGVtZSA6ICggIiAiICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKSwKCQkJCQlzbGlkZXJMYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJCQkJc2xpZGVySW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ3NwYW4nICk7CgoJCQkJc2xpZGVySW1nLmNsYXNzTmFtZSA9IFsndWktc2xpZGVyLWxhYmVsIHVpLXNsaWRlci1sYWJlbC0nLHNpZGUsc2xpZGVyVGhlbWUsIiB1aS1idG4tY29ybmVyLWFsbCJdLmpvaW4oICIiICk7CgkJCQlzbGlkZXJJbWcuc2V0QXR0cmlidXRlKCdyb2xlJywnaW1nJyk7CgkJCQlzbGlkZXJJbWcuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBvcHRpb25zW2ldLmlubmVySFRNTCApICk7CgkJCQkkKHNsaWRlckltZykucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfQoKCQkJc2VsZi5fbGFiZWxzID0gJCggIi51aS1zbGlkZXItbGFiZWwiLCBzbGlkZXIgKTsKCgkJfQoKCQlsYWJlbC5hZGRDbGFzcyggInVpLXNsaWRlciIgKTsKCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggY1R5cGUgPT09ICJpbnB1dCIgPyAidWktc2xpZGVyLWlucHV0IiA6ICJ1aS1zbGlkZXItc3dpdGNoIiApCgkJCS5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiB0aGUgdXNlciBkcmFnZ2VkIHRoZSBoYW5kbGUsIHRoZSAiY2hhbmdlIiBldmVudCB3YXMgdHJpZ2dlcmVkIGZyb20gaW5zaWRlIHJlZnJlc2goKTsgZG9uJ3QgY2FsbCByZWZyZXNoKCkgYWdhaW4KCQkJCWlmICggIXNlbGYubW91c2VNb3ZlZCApIHsKCQkJCQlzZWxmLnJlZnJlc2goIHZhbCgpLCB0cnVlICk7CgkJCQl9CgkJCX0pCgkJCS5rZXl1cChmdW5jdGlvbigpIHsgLy8gbmVjZXNzYXJ5PwoJCQkJc2VsZi5yZWZyZXNoKCB2YWwoKSwgdHJ1ZSwgdHJ1ZSApOwoJCQl9KQoJCQkuYmx1cihmdW5jdGlvbigpIHsKCQkJCXNlbGYucmVmcmVzaCggdmFsKCksIHRydWUgKTsKCQkJfSk7CgoJCXRoaXMuX3ByZXZlbnREb2N1bWVudERyYWcgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCS8vIE5PVEU6IHdlIGRvbid0IGRvIHRoaXMgaW4gcmVmcmVzaCBiZWNhdXNlIHdlIHN0aWxsIHdhbnQgdG8KCQkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQkJaWYgKCBzZWxmLmRyYWdnaW5nICYmICFzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgoJCQkJLy8gc2VsZi5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQlzZWxmLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiICkgewoJCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIGluIHN5bmMgd2l0aCB0aGUgbW91c2UKCQkJCQloYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoKCQkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCgkJCQkvLyBvbmx5IGFmdGVyIHJlZnJlc2goKSB5b3UgY2FuIGNhbGN1bGF0ZSBzZWxmLnVzZXJNb2RpZmllZAoJCQkJc2VsZi51c2VyTW9kaWZpZWQgPSBzZWxmLmJlZm9yZVN0YXJ0ICE9PSBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9CgoJCXRoaXMuX29uKCAkKCBkb2N1bWVudCApLCB7ICJ2bW91c2Vtb3ZlIjogdGhpcy5fcHJldmVudERvY3VtZW50RHJhZyB9KTsKCgkJLy8gaXQgYXBwZWFycyB0aGUgY2xpY2tpbmcgdGhlIHVwIGFuZCBkb3duIGJ1dHRvbnMgaW4gY2hyb21lIG9uCgkJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkJLy8gYmx1cnJlZC4gSGVyZSB3ZSBjaGVjayB0aGlmIHRoZSB2YWx1ZSBoYXMgY2hhbmdlZCBhbmQgcmVmcmVzaAoJCWNvbnRyb2wuYmluZCggInZtb3VzZXVwIiwgJC5wcm94eSggc2VsZi5fY2hlY2tlZFJlZnJlc2gsIHNlbGYpKTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQlzZWxmLmRyYWdnaW5nID0gdHJ1ZTsKCQkJc2VsZi51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQkJc2VsZi5tb3VzZU1vdmVkID0gZmFsc2U7CgoJCQlpZiAoIGNUeXBlID09PSAic2VsZWN0IiApIHsKCQkJCXNlbGYuYmVmb3JlU3RhcnQgPSBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCgkJCXNlbGYucmVmcmVzaCggZXZlbnQgKTsKCQkJc2VsZi5fdHJpZ2dlciggInN0YXJ0IiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSkKCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX3NsaWRlck1vdXNlVXAgPSBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLmRyYWdnaW5nICkgewoJCQkJc2VsZi5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJCWlmICggY1R5cGUgPT09ICJzZWxlY3QiKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCQkJaWYgKCBzZWxmLm1vdXNlTW92ZWQgKSB7CgkJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCQlpZiAoIHNlbGYudXNlck1vZGlmaWVkICkgewoJCQkJCQkgICAgc2VsZi5yZWZyZXNoKCBzZWxmLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJICAgIHNlbGYucmVmcmVzaCggc2VsZi5iZWZvcmVTdGFydCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsc2UgewoJCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCQlzZWxmLnJlZnJlc2goIHNlbGYuYmVmb3JlU3RhcnQgPT09IDAgPyAxIDogMCApOwoJCQkJCX0KCQkJCX0KCgkJCQlzZWxmLm1vdXNlTW92ZWQgPSBmYWxzZTsKCQkJCXNlbGYuX3RyaWdnZXIoICJzdG9wIiApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfTsKCgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogdGhpcy5fc2xpZGVyTW91c2VVcCB9KTsKCQlzbGlkZXIuaW5zZXJ0QWZ0ZXIoIGNvbnRyb2wgKTsKCgkJLy8gT25seSBhZGQgZm9jdXMgY2xhc3MgdG8gdG9nZ2xlIHN3aXRjaCwgc2xpZGVycyBnZXQgaXQgYXV0b21hdGljYWxseSBmcm9tIHVpLWJ0bgoJCWlmICggY1R5cGUgPT09ICdzZWxlY3QnICkgewoJCQl0aGlzLmhhbmRsZS5iaW5kKHsKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0sCgoJCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkJc2xpZGVyLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJdGhpcy5oYW5kbGUuYmluZCh7CgkJCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCgkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmZvY3VzKCk7CgkJCX0sCgoJCQl2Y2xpY2s6IGZhbHNlLAoKCQkJa2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIGluZGV4ID0gdmFsKCk7CgoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKCQkJCQkJaWYgKCAhc2VsZi5fa2V5U2xpZGluZyApIHsKCQkJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCQkJJCggdGhpcyApLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1pbiApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQkJCQlzZWxmLnJlZnJlc2goIG1heCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4ICsgc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJCQlzZWxmLnJlZnJlc2goIGluZGV4IC0gc3RlcCApOwoJCQkJCQlicmVhazsKCQkJCX0KCQkJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJCQlrZXl1cDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBzZWxmLl9rZXlTbGlkaW5nICkgewoJCQkJCXNlbGYuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJCQkkKCB0aGlzICkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7CgkJCQl9CgkJCX0KCQkJfSk7CgoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCB1bmRlZmluZWQsIHRydWUgKTsKCX0sCgoJX2NoZWNrZWRSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiggdGhpcy52YWx1ZSAhPSB0aGlzLl92YWx1ZSgpICl7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSApOwoJCX0KCX0sCgoJX3ZhbHVlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gIHRoaXMuX3R5cGUgPT09ICJpbnB1dCIgPwoJCQlwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA6IHRoaXMuZWxlbWVudFswXS5zZWxlY3RlZEluZGV4OwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgoJCS8vIE5PVEU6IHdlIGRvbid0IHJldHVybiBoZXJlIGJlY2F1c2Ugd2Ugd2FudCB0byBzdXBwb3J0IHByb2dyYW1tYXRpYwoJCS8vICAgICAgIGFsdGVyYXRpb24gb2YgdGhlIGlucHV0IHZhbHVlLCB3aGljaCBzaG91bGQgc3RpbGwgdXBkYXRlIHRoZSBzbGlkZXIKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgoJCXZhciBjb250cm9sID0gdGhpcy5lbGVtZW50LCBwZXJjZW50LAoJCQljVHlwZSA9IGNvbnRyb2xbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJbWluID0gY1R5cGUgPT09ICJpbnB1dCIgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWF4IiApICkgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkubGVuZ3RoIC0gMSwKCQkJc3RlcCA9ICggY1R5cGUgPT09ICJpbnB1dCIgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJdmFyIGRhdGEgPSB2YWwsCgkJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCQl0b2wgPSA4OwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCArIHRoaXMuc2xpZGVyLndpZHRoKCkgKyB0b2wgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdCApIC8gdGhpcy5zbGlkZXIud2lkdGgoKSApICogMTAwICk7CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGNUeXBlID09PSAiaW5wdXQiID8gcGFyc2VGbG9hdCggY29udHJvbC52YWwoKSB8fCAwICkgOiBjb250cm9sWzBdLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcGVyY2VudCA9ICggcGFyc2VGbG9hdCggdmFsICkgLSBtaW4gKSAvICggbWF4IC0gbWluICkgKiAxMDA7CgkJfQoKCQlpZiAoIGlzTmFOKCBwZXJjZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJdmFyIG5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhciB2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJdmFyIGFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgkJLy8gU2luY2UgSmF2YVNjcmlwdCBoYXMgcHJvYmxlbXMgd2l0aCBsYXJnZSBmbG9hdHMsIHJvdW5kCgkJLy8gdGhlIGZpbmFsIHZhbHVlIHRvIDUgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50IChzZWUgalF1ZXJ5VUk6ICM0MTI0KQoJCW5ld3ZhbCA9IHBhcnNlRmxvYXQoIGFsaWduVmFsdWUudG9GaXhlZCg1KSApOwoKCQlpZiAoIG5ld3ZhbCA8IG1pbiApIHsKCQkJbmV3dmFsID0gbWluOwoJCX0KCgkJaWYgKCBuZXd2YWwgPiBtYXggKSB7CgkJCW5ld3ZhbCA9IG1heDsKCQl9CgoJCXRoaXMuaGFuZGxlLmNzcyggImxlZnQiLCBwZXJjZW50ICsgIiUiICk7CgkJdGhpcy5oYW5kbGUuYXR0ciggewoJCQkJImFyaWEtdmFsdWVub3ciOiBjVHlwZSA9PT0gImlucHV0IiA/IG5ld3ZhbCA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApLAoJCQkJImFyaWEtdmFsdWV0ZXh0IjogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCksCgkJCQl0aXRsZTogY1R5cGUgPT09ICJpbnB1dCIgPyBuZXd2YWwgOiBjb250cm9sLmZpbmQoICJvcHRpb24iICkuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkKCQkJfSk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJdmFyIGhhbmRsZVBlcmNlbnQgPSB0aGlzLmhhbmRsZS53aWR0aCgpIC8gdGhpcy5zbGlkZXIud2lkdGgoKSAqIDEwMCwKCQkJCWFQZXJjZW50ID0gcGVyY2VudCAmJiBoYW5kbGVQZXJjZW50ICsgKCAxMDAgLSBoYW5kbGVQZXJjZW50ICkgKiBwZXJjZW50IC8gMTAwLAoJCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5pcyggIi51aS1zbGlkZXItbGFiZWwtYSIgKTsKCQkJCSQoIHRoaXMgKS53aWR0aCggKCBhYiA/IGFQZXJjZW50IDogYlBlcmNlbnQgICkgKyAiJSIgKTsKCQkJfSk7CgkJfQoKCQlpZiAoICFwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJCXZhciB2YWx1ZUNoYW5nZWQgPSBmYWxzZTsKCgkJCS8vIHVwZGF0ZSBjb250cm9sInMgdmFsdWUKCQkJaWYgKCBjVHlwZSA9PT0gImlucHV0IiApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoICFpc2Zyb21Db250cm9sICYmIHZhbHVlQ2hhbmdlZCApIHsKCQkJCWNvbnRyb2wudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0KCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgZmFsc2UgKTsKCQl0aGlzLnNsaWRlci5yZW1vdmVDbGFzcyggInVpLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgZmFsc2UgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdHJ1ZSApOwoJCXRoaXMuc2xpZGVyLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfQoKfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImFycm93LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpICkiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICAiIHVpLWJ0bi1sZWZ0IjsKCQl9CgoJCWlmICggICEhfnRoaXMuZWxlbWVudFswXS5jbGFzc05hbWUuaW5kZXhPZiggInVpLWJ0bi1yaWdodCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLXJpZ2h0IjsKCQl9CgoJCXRoaXMuc2VsZWN0ID0gdGhpcy5lbGVtZW50LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1zZWxlY3QiICsgY2xhc3NlcyArICInPiIgKTsKCQl0aGlzLnNlbGVjdElEICA9IHRoaXMuc2VsZWN0LmF0dHIoICJpZCIgKTsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJRCArIiddIiApLmFkZENsYXNzKCAidWktc2VsZWN0IiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7CgkJaWYgKCAhdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQl0aGlzLm9wdGlvbnMudGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5zZWxlY3QsICJjIiApOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWlubGluZSA9IG9wdGlvbnMuaW5saW5lIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvcHRpb25zLm1pbmkgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggIm1pbmkiICksCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQkvLyBJRSB0aHJvd3MgYW4gZXhjZXB0aW9uIGF0IG9wdGlvbnMuaXRlbSgpIGZ1bmN0aW9uIHdoZW4KCQkJLy8gdGhlcmUgaXMgbm8gc2VsZWN0ZWQgaXRlbQoJCQkvLyBzZWxlY3QgZmlyc3QgaW4gdGhpcyBjYXNlCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXggPT09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IGljb25wb3MsCgkJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQkJY29ybmVyczogb3B0aW9ucy5jb3JuZXJzLAoJCQkJCXNoYWRvdzogb3B0aW9ucy5zaGFkb3csCgkJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93LAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQl9KTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KS5iaW5kKCAibW91c2V1cCIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfSwgMCk7CgkJCX0KCQl9KTsKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5maW5kKCAiLnVpLWJ0bi10ZXh0IiApLmh0bWwoZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZWN0ZWQubGVuZ3RoICkgewoJCQkJdGV4dCA9IHNlbGVjdGVkLm1hcChmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gJCggdGhpcyApLnRleHQoKTsKCQkJCX0pLmdldCgpLmpvaW4oICIsICIgKTsKCQkJfSBlbHNlIHsKCQkJCXRleHQgPSBzZWxmLnBsYWNlaG9sZGVyOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4udGV4dCggdGV4dCApCgkJCQkuYWRkQ2xhc3MoIHNlbGYuc2VsZWN0LmF0dHIoICJjbGFzcyIgKSApCgkJCQkuYWRkQ2xhc3MoIHNlbGVjdGVkLmF0dHIoICJjbGFzcyIgKSApOwoJCX0pOwoJfSwKCglzZXRCdXR0b25Db3VudDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdGVkID0gdGhpcy5zZWxlY3RlZCgpOwoKCQkvLyBtdWx0aXBsZSBjb3VudCBpbnNpZGUgYnV0dG9uCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnRbIHNlbGVjdGVkLmxlbmd0aCA+IDEgPyAic2hvdyIgOiAiaGlkZSIgXSgpLnRleHQoIHNlbGVjdGVkLmxlbmd0aCApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5zZXRCdXR0b25UZXh0KCk7CgkJdGhpcy5zZXRCdXR0b25Db3VudCgpOwoJfSwKCgkvLyBvcGVuIGFuZCBjbG9zZSBwcmVzZXJ2ZWQgaW4gbmF0aXZlIHNlbGVjdHMKCS8vIHRvIHNpbXBsaWZ5IHVzZXJzIGNvZGUgd2hlbiBsb29waW5nIG92ZXIgc2VsZWN0cwoJb3BlbjogJC5ub29wLAoJY2xvc2U6ICQubm9vcCwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXREaXNhYmxlZCggdHJ1ZSApOwoJCXRoaXMuYnV0dG9uLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIGZhbHNlICk7CgkJdGhpcy5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNlbGVjdG1lbnUucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQgID0gd2lkZ2V0LnNlbGVjdElELAoJCQlsYWJlbCA9IHdpZGdldC5sYWJlbCwKCQkJdGhpc1BhZ2UgPSB3aWRnZXQuc2VsZWN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJc2VsZWN0T3B0aW9ucyA9IHdpZGdldC5fc2VsZWN0T3B0aW9ucygpLAoJCQlpc011bHRpcGxlID0gd2lkZ2V0LmlzTXVsdGlwbGUgPSB3aWRnZXQuc2VsZWN0WyAwIF0ubXVsdGlwbGUsCgkJCWJ1dHRvbklkID0gc2VsZWN0SUQgKyAiLWJ1dHRvbiIsCgkJCW1lbnVJZCA9IHNlbGVjdElEICsgIi1tZW51IiwKCQkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXY+IiwgeyAiY2xhc3MiOiAidWktc2VsZWN0bWVudSIgfSApLmluc2VydEFmdGVyKCB3aWRnZXQuc2VsZWN0ICkucG9wdXAoIHsgdGhlbWU6ICJhIiB9ICksCgoJCQlsaXN0ID0gJCggIjx1bD4iLCB7CgkJCQkiY2xhc3MiOiAidWktc2VsZWN0bWVudS1saXN0IiwKCQkJCSJpZCI6IG1lbnVJZCwKCQkJCSJyb2xlIjogImxpc3Rib3giLAoJCQkJImFyaWEtbGFiZWxsZWRieSI6IGJ1dHRvbklkCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0aGVtZSIsIHdpZGdldC5vcHRpb25zLnRoZW1lICkuYXBwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlciA9ICQoICI8ZGl2PiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS1oZWFkZXIgdWktYmFyLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZQoJCQl9KS5wcmVwZW5kVG8oIGxpc3Rib3ggKSwKCgkJCWhlYWRlclRpdGxlID0gJCggIjxoMT4iLCB7CgkJCQkiY2xhc3MiOiAidWktdGl0bGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKSwKCgkJCW1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZSwKCQkJaGVhZGVyQ2xvc2U7CgoJCWlmICggd2lkZ2V0LmlzTXVsdGlwbGUgKSB7CgkJCWhlYWRlckNsb3NlID0gJCggIjxhPiIsIHsKCQkJCSJ0ZXh0Ijogd2lkZ2V0Lm9wdGlvbnMuY2xvc2VUZXh0LAoJCQkJImhyZWYiOiAiIyIsCgkJCQkiY2xhc3MiOiAidWktYnRuLWxlZnQiCgkJCX0pLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zIiwgIm5vdGV4dCIgKS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbiIsICJkZWxldGUiICkuYXBwZW5kVG8oIGhlYWRlciApLmJ1dHRvbk1hcmt1cCgpOwoJCX0KCgkJJC5leHRlbmQoIHdpZGdldCwgewoJCQlzZWxlY3Q6IHdpZGdldC5zZWxlY3QsCgkJCXNlbGVjdElEOiBzZWxlY3RJRCwKCQkJYnV0dG9uSWQ6IGJ1dHRvbklkLAoJCQltZW51SWQ6IG1lbnVJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJc2VsZWN0T3B0aW9uczogc2VsZWN0T3B0aW9ucywKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IHdpZGdldC5vcHRpb25zLnRoZW1lLAoJCQlsaXN0Ym94OiBsaXN0Ym94LAoJCQlsaXN0OiBsaXN0LAoJCQloZWFkZXI6IGhlYWRlciwKCQkJaGVhZGVyVGl0bGU6IGhlYWRlclRpdGxlLAoJCQloZWFkZXJDbG9zZTogaGVhZGVyQ2xvc2UsCgkJCW1lbnVQYWdlQ29udGVudDogbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlOiBtZW51UGFnZUNsb3NlLAoJCQlwbGFjZWhvbGRlcjogIiIsCgoJCQlidWlsZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQkJLy8gQ3JlYXRlIGxpc3QgZnJvbSBzZWxlY3QsIHVwZGF0ZSBzdGF0ZQoJCQkJc2VsZi5yZWZyZXNoKCk7CgoJCQkJc2VsZi5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApLmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQkJCX0pOwoKCQkJCS8vIEJ1dHRvbiBldmVudHMKCQkJCXNlbGYuYnV0dG9uLmJpbmQoICJ2Y2xpY2sga2V5ZG93biIgLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKGV2ZW50LnR5cGUgPT09ICJ2Y2xpY2siIHx8CgkJCQkJCQlldmVudC5rZXlDb2RlICYmIChldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLkVOVEVSIHx8CgkJCQkJCQkJCQkJCQkJCQlldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJCQkJc2VsZi5vcGVuKCk7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfSk7CgoJCQkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJCQlzZWxmLmxpc3QuYXR0ciggInJvbGUiLCAibGlzdGJveCIgKQoJCQkJCS5iaW5kKCAiZm9jdXNpbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCgkJCQkJfSkKCQkJCQkuYmluZCggImZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSQoIGUudGFyZ2V0ICkKCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICkKCQkJCQkJCS50cmlnZ2VyKCAidm1vdXNlb3V0IiApOwoJCQkJCX0pCgkJCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwgLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCQkJLy8gaW5kZXggb2Ygb3B0aW9uIHRhZyB0byBiZSBzZWxlY3RlZAoJCQkJCQl2YXIgb2xkSW5kZXggPSBzZWxmLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXgsCgkJCQkJCQluZXdJbmRleCA9IHNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5pbmRleCggdGhpcyApLAoJCQkJCQkJb3B0aW9uID0gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmVxKCBuZXdJbmRleCApWyAwIF07CgoJCQkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCQkJb3B0aW9uLnNlbGVjdGVkID0gc2VsZi5pc011bHRpcGxlID8gIW9wdGlvbi5zZWxlY3RlZCA6IHRydWU7CgoJCQkJCQkvLyB0b2dnbGUgY2hlY2tib3ggY2xhc3MgZm9yIG11bHRpcGxlIHNlbGVjdHMKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJCQkkKCB0aGlzICkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIsIG9wdGlvbi5zZWxlY3RlZCApCgkJCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiLCAhb3B0aW9uLnNlbGVjdGVkICk7CgkJCQkJCX0KCgkJCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgfHwgb2xkSW5kZXggIT09IG5ld0luZGV4ICkgewoJCQkJCQkJc2VsZi5zZWxlY3QudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJCQkJfQoKCQkJCQkJLy8gaGlkZSBjdXN0b20gc2VsZWN0IGZvciBzaW5nbGUgc2VsZWN0cyBvbmx5IC0gb3RoZXJ3aXNlIGZvY3VzIGNsaWNrZWQgaXRlbQoJCQkJCQkvLyBXZSBuZWVkIHRvIGdyYWIgdGhlIGNsaWNrZWQgaXRlbSB0aGUgaGFyZCB3YXksIGJlY2F1c2UgdGhlIGxpc3QgbWF5IGhhdmUgYmVlbiByZWJ1aWx0CgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApLmVxKCBuZXdJbmRleCApCgkJCQkJCQkJLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJCQl9CgkJCQkJCWVsc2UgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQl9CgoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pCgkJCQkJLmtleWRvd24oZnVuY3Rpb24oIGV2ZW50ICkgeyAgLy9rZXlib2FyZCBldmVudHMgZm9yIG1lbnUgaXRlbXMKCQkJCQkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQkJCQkJbGkgPSB0YXJnZXQuY2xvc2VzdCggImxpIiApLAoJCQkJCQkJcHJldiwgbmV4dDsKCgkJCQkJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQkJCQkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJCQkJCS8vIHVwIG9yIGxlZnQgYXJyb3cga2V5cwoJCQkJCQljYXNlIDM4OgoJCQkJCQkJcHJldiA9IGxpLnByZXYoKS5ub3QoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKTsKCgkJCQkJCQlpZiAoIHByZXYuaXMoICIudWktbGktZGl2aWRlciIgKSApIHsKCQkJCQkJCQlwcmV2ID0gcHJldi5wcmV2KCk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gaWYgdGhlcmUncyBhIHByZXZpb3VzIG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggcHJldi5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJcHJldi5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQkJCQkJY2FzZSA0MDoKCQkJCQkJCW5leHQgPSBsaS5uZXh0KCk7CgoJCQkJCQkJaWYgKCBuZXh0LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJbmV4dCA9IG5leHQubmV4dCgpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBuZXh0IG9wdGlvbiwgZm9jdXMgaXQKCQkJCQkJCWlmICggbmV4dC5sZW5ndGggKSB7CgkJCQkJCQkJdGFyZ2V0CgkJCQkJCQkJCS5ibHVyKCkKCQkJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKTsKCgkJCQkJCQkJbmV4dC5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJCX0KCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJCQkJCWNhc2UgMTM6CgkJCQkJCWNhc2UgMzI6CgkJCQkJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoKCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJfQoJCQkJCX0pOwoKCQkJCS8vIGJ1dHRvbiByZWZvY3VzIGVuc3VyZXMgcHJvcGVyIGhlaWdodCBjYWxjdWxhdGlvbgoJCQkJLy8gYnkgcmVtb3ZpbmcgdGhlIGlubGluZSBzdHlsZSBhbmQgZW5zdXJpbmcgcGFnZSBpbmNsdXNpb24KCQkJCXNlbGYubWVudVBhZ2UuYmluZCggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoKCQkJCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJCQkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCQkJCS8vCgkJCQkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkJCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkJCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJCQkJLy8KCQkJCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkJCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCQkJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkJCQkvLwoJCQkJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCQkJCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZS5jYWxsKCBzZWxmLnRoaXNQYWdlICk7CgkJCQl9KTsKCgkJCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJCQlzZWxmLmxpc3Rib3guYmluZCggInBvcHVwYWZ0ZXJjbG9zZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCgkJCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYuaGVhZGVyQ2xvc2UuY2xpY2soZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgoJCQkJLy8gdHJhY2sgdGhpcyBkZXBlbmRlbmN5IHNvIHRoYXQgd2hlbiB0aGUgcGFyZW50IHBhZ2UKCQkJCS8vIGlzIHJlbW92ZWQgb24gcGFnZWhpZGUgaXQgd2lsbCBhbHNvIHJlbW92ZSB0aGUgbWVudXBhZ2UKCQkJCXNlbGYudGhpc1BhZ2UuYWRkRGVwZW5kZW50cyggdGhpcy5tZW51UGFnZSApOwoJCQl9LAoKCQkJX2lzUmVidWlsZFJlcXVpcmVkOiBmdW5jdGlvbigpIHsKCQkJCXZhciBsaXN0ID0gdGhpcy5saXN0LmZpbmQoICJsaSIgKSwKCQkJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoKCQkJCS8vIFRPRE8gZXhjZWVkaW5nbHkgbmFpdmUgbWV0aG9kIHRvIGRldGVybWluZSBkaWZmZXJlbmNlCgkJCQkvLyBpZ25vcmVzIHZhbHVlIGNoYW5nZXMgZXRjIGluIGZhdm9yIG9mIGEgZm9yY2VkUmVidWlsZAoJCQkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQkJCXJldHVybiBvcHRpb25zLnRleHQoKSAhPT0gbGlzdC50ZXh0KCk7CgkJCX0sCgoJCQlzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZDpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSIgKTsKCQkJfSwKCgkJCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZVJlYnVpbGQgLCBmb28gKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlzZWxlY3QgPSB0aGlzLmVsZW1lbnQsCgkJCQlpc011bHRpcGxlID0gdGhpcy5pc011bHRpcGxlLAoJCQkJaW5kaWNpZXM7CgoJCQkJaWYgKCAgZm9yY2VSZWJ1aWxkIHx8IHRoaXMuX2lzUmVidWlsZFJlcXVpcmVkKCkgKSB7CgkJCQkJc2VsZi5fYnVpbGRMaXN0KCk7CgkJCQl9CgoJCQkJaW5kaWNpZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQkJCXNlbGYuc2V0QnV0dG9uVGV4dCgpOwoJCQkJc2VsZi5zZXRCdXR0b25Db3VudCgpOwoKCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKQoJCQkJCS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIGZhbHNlICkKCQkJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQkJCWlmICggJC5pbkFycmF5KCBpLCBpbmRpY2llcyApID4gLTEgKSB7CgkJCQkJCQl2YXIgaXRlbSA9ICQoIHRoaXMgKTsKCgkJCQkJCQkvLyBBcmlhIHNlbGVjdGVkIGF0dHIKCQkJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCQkJLy8gTXVsdGlwbGUgc2VsZWN0czogYWRkIHRoZSAib24iIGNoZWNrYm94IHN0YXRlIHRvIHRoZSBpY29uCgkJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCQlpdGVtLmZpbmQoICIudWktaWNvbiIgKS5yZW1vdmVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktaWNvbi1jaGVja2JveC1vbiIgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKCBpdGVtLmlzKCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICkgKSB7CgkJCQkJCQkJCWl0ZW0ubmV4dCgpLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWl0ZW0uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCX0sCgoJCQljbG9zZTogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCXZhciBzZWxmID0gdGhpczsKCgkJCQlpZiAoIHNlbGYubWVudVR5cGUgPT09ICJwYWdlIiApIHsKCQkJCQkvLyBkb2Vzbid0IHNvbHZlIHRoZSBwb3NzaWJsZSBpc3N1ZSB3aXRoIGNhbGxpbmcgY2hhbmdlIHBhZ2UKCQkJCQkvLyB3aGVyZSB0aGUgb2JqZWN0cyBkb24ndCBkZWZpbmUgZGF0YSB1cmxzIHdoaWNoIHByZXZlbnRzIGRpYWxvZyBrZXkKCQkJCQkvLyBzdHJpcHBpbmcgLSBjaGFuZ2VQYWdlIGhhcyBpbmNvbWluZyByZWZhY3RvcgoJCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCQkJfQoKCQkJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJCQl9LAoKCQkJb3BlbjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKSwKCQkJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJCQltZW51V2lkdGggPSBzZWxmTGlzdFBhcmVudC5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkd2luZG93LndpZHRoKCk7CgoJCQkJLy9hZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy9yZW1vdmUgYWZ0ZXIgZGVsYXkKCQkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJfSwgMzAwKTsKCgkJCQlmdW5jdGlvbiBmb2N1c01lbnVJdGVtKCkgewoJCQkJCXZhciBzZWxlY3RvciA9IHNlbGYubGlzdC5maW5kKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgYSIgKTsKCQkJCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggImxpLnVpLWJ0bjpub3QoIDpqcW1EYXRhKHBsYWNlaG9sZGVyPSd0cnVlJykgKSBhIiApOwoJCQkJCX0KCQkJCQlzZWxlY3Rvci5maXJzdCgpLmZvY3VzKCkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktYnRuLWRvd24tIiArIHdpZGdldC5vcHRpb25zLnRoZW1lICk7CgkJCQl9CgoJCQkJaWYgKCBtZW51SGVpZ2h0ID4gc2NyZWVuSGVpZ2h0IC0gODAgfHwgISQuc3VwcG9ydC5zY3JvbGxUb3AgKSB7CgoJCQkJCXNlbGYubWVudVBhZ2UuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKS5wYWdlKCk7CgkJCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBtZW51UGFnZS5maW5kKCAiLnVpLWNvbnRlbnQiICk7CgkJCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gbWVudVBhZ2UuZmluZCggIi51aS1oZWFkZXIgYSIgKTsKCgkJCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJCQkvLyBvdGhlcndpc2UgdGhlIHJlc3VsdHMgb2Ygc2VsZWN0aW5nIGEgbGlzdCBpdGVtIGluIHRoZSBkaWFsb2cKCQkJCQkvLyBmYWxsIGludG8gYSBibGFjayBob2xlCgkJCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkJCS8vZm9yIFdlYk9TL09wZXJhIE1pbmkgKHNldCBsYXN0c2Nyb2xsIHVzaW5nIGJ1dHRvbiBvZmZzZXQpCgkJCQkJaWYgKCBzY3JvbGxUb3AgPT09IDAgJiYgYnRuT2Zmc2V0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQkkKCB0aGlzICkuanFtRGF0YSggImxhc3RTY3JvbGwiLCBidG5PZmZzZXQgKTsKCQkJCQkJfSk7CgkJCQkJfQoKCQkJCQlzZWxmLm1lbnVQYWdlLm9uZSggInBhZ2VzaG93IiwgZnVuY3Rpb24oKSB7CgkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJc2VsZi5pc09wZW4gPSB0cnVlOwoJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggc2VsZi5tZW51UGFnZSwgewoJCQkJCQl0cmFuc2l0aW9uOiAkLm1vYmlsZS5kZWZhdWx0RGlhbG9nVHJhbnNpdGlvbgoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlzZWxmLm1lbnVUeXBlID0gIm92ZXJsYXkiOwoKCQkJCQlzZWxmLmxpc3Rib3gKCQkJCQkJLm9uZSggInBvcHVwYWZ0ZXJvcGVuIiwgZm9jdXNNZW51SXRlbSApCgkJCQkJCS5wb3B1cCggIm9wZW4iLCB7CgkJCQkJCQl4OiBzZWxmLmJ1dHRvbi5vZmZzZXQoKS5sZWZ0ICsgc2VsZi5idXR0b24ub3V0ZXJXaWR0aCgpIC8gMiwKCQkJCQkJCXk6IHNlbGYuYnV0dG9uLm9mZnNldCgpLnRvcCArIHNlbGYuYnV0dG9uLm91dGVySGVpZ2h0KCkgLyAyCgkJCQkJCX0pOwoKCQkJCQkvLyBkdXBsaWNhdGUgd2l0aCB2YWx1ZSBzZXQgaW4gcGFnZSBzaG93IGZvciBkaWFsb2cgc2l6ZWQgc2VsZWN0cwoJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCX0KCQkJfSwKCgkJCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQl2YXIgJG9wdGlvbnMgPSBzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLAoJCQkJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGgsCgkJCQkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXSwKCQkJCQlkYXRhUHJlZml4ID0gJ2RhdGEtJyArICQubW9iaWxlLm5zLAoJCQkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgJ29wdGlvbi1pbmRleCcsCgkJCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICdpY29uJywKCQkJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgJ3JvbGUnLAoJCQkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgJ3BsYWNlaG9sZGVyJywKCQkJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQkJCW9wdEdyb3VwOwoKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJCQl2YXIgb3B0aW9uID0gJG9wdGlvbnNbaV0sCgkJCQkJCSRvcHRpb24gPSAkKCBvcHRpb24gKSwKCQkJCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGUsCgkJCQkJCXRleHQgPSAkb3B0aW9uLnRleHQoKSwKCQkJCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdhJyApLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICdocmVmJywgJyMnICk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggJ2xhYmVsJyApOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCBtYXJrIGl0IHJldHJvYWN0aXZlbHkgaW4gdGhlIHNlbGVjdCBhcyB3ZWxsCgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCFwbGFjZWhvbGRlcikgewoJCQkJCQkJcGxhY2Vob2xkZXIgPSBzZWxmLnBsYWNlaG9sZGVyID0gdGV4dDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpOwoJCQkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJCQljbGFzc2VzLnB1c2goICJ1aS1kaXNhYmxlZCIgKTsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoJ2FyaWEtZGlzYWJsZWQnLHRydWUpOwoJCQkJCX0KCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YUluZGV4QXR0cixpICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJCQlpZiAoIGlzUGxhY2Vob2xkZXJJdGVtICkgewoJCQkJCQlpdGVtLnNldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciwgdHJ1ZSApOwoJCQkJCX0KCQkJCQlpdGVtLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbiggIiAiICk7CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoICdyb2xlJywgJ29wdGlvbicgKTsKCQkJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAndGFiaW5kZXgnLCAnLTEnICk7CgkJCQkJaXRlbS5hcHBlbmRDaGlsZCggYW5jaG9yICk7CgkJCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQkJCX0KCgkJCQlzZWxmLmxpc3RbMF0uYXBwZW5kQ2hpbGQoIGZyYWdtZW50ICk7CgoJCQkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCQkJaWYgKCAhdGhpcy5pc011bHRpcGxlICYmICFwbGFjZWhvbGRlci5sZW5ndGggKSB7CgkJCQkJdGhpcy5oZWFkZXIuaGlkZSgpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLmhlYWRlclRpdGxlLnRleHQoIHRoaXMucGxhY2Vob2xkZXIgKTsKCQkJCX0KCgkJCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQkJCXNlbGYubGlzdC5saXN0dmlldygpOwoJCQl9LAoKCQkJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggIjxhPiIsIHsKCQkJCQkiaHJlZiI6ICIjIiwKCQkJCQkicm9sZSI6ICJidXR0b24iLAoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCQkiYXJpYS1oYXNwb3B1cCI6ICJ0cnVlIiwKCgkJCQkJLy8gVE9ETyB2YWx1ZSBpcyB1bmRlZmluZWQgYXQgY3JlYXRpb24KCQkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJCX0pOwoJCQl9CgkJfSk7Cgl9OwoKCS8vIGlzc3VlICMzODk0IC0gY29yZSBkb2Vzbid0IHRyaWdnZXIgZXZlbnRzIG9uIGRpc2FibGVkIGRlbGVnYXRlcwoJJCggZG9jdW1lbnQgKS5iaW5kKCAic2VsZWN0bWVudWJlZm9yZWNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgc2VsZWN0bWVudVdpZGdldCA9ICQoIGV2ZW50LnRhcmdldCApLmRhdGEoICJzZWxlY3RtZW51IiApOwoKCQlpZiAoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSAmJgoJCQkJc2VsZWN0bWVudVdpZGdldC5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCgkkLndpZGdldCggIm1vYmlsZS5maXhlZHRvb2xiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXZpc2libGVPblBhZ2VTaG93OiB0cnVlLAoJCQlkaXNhYmxlUGFnZVpvb206IHRydWUsCgkJCXRyYW5zaXRpb246ICJzbGlkZSIsIC8vY2FuIGJlIG5vbmUsIGZhZGUsIHNsaWRlIChzbGlkZSBtYXBzIHRvIHNsaWRldXAgb3Igc2xpZGVkb3duKQoJCQlmdWxsc2NyZWVuOiBmYWxzZSwKCQkJdGFwVG9nZ2xlOiB0cnVlLAoJCQl0YXBUb2dnbGVCbGFja2xpc3Q6ICJhLCBidXR0b24sIGlucHV0LCBzZWxlY3QsIHRleHRhcmVhLCAudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkLCAudWktcG9wdXAiLAoJCQloaWRlRHVyaW5nRm9jdXM6ICJpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCIsCgkJCXVwZGF0ZVBhZ2VQYWRkaW5nOiB0cnVlLAoJCQl0cmFja1BlcnNpc3RlbnRUb29sYmFyczogdHJ1ZSwKCgkJCS8vIEJyb3dzZXIgZGV0ZWN0aW9uISBXZWVlZSwgaGVyZSB3ZSBnby4uLgoJCQkvLyBVbmZvcnR1bmF0ZWx5LCBwb3NpdGlvbjpmaXhlZCBpcyBjb3N0bHksIG5vdCB0byBtZW50aW9uIHByb2JhYmx5IGltcG9zc2libGUsIHRvIGZlYXR1cmUtZGV0ZWN0IGFjY3VyYXRlbHkuCgkJCS8vIFNvbWUgdGVzdHMgZXhpc3QsIGJ1dCB0aGV5IGN1cnJlbnRseSByZXR1cm4gZmFsc2UgcmVzdWx0cyBpbiBjcml0aWNhbCBkZXZpY2VzIGFuZCBicm93c2Vycywgd2hpY2ggY291bGQgbGVhZCB0byBhIGJyb2tlbiBleHBlcmllbmNlLgoJCQkvLyBUZXN0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIGlzIGFsc28gcHJldHR5IG9idHJ1c2l2ZSB0byBwYWdlIGxvYWQsIHJlcXVpcmluZyBpbmplY3RlZCBlbGVtZW50cyBhbmQgc2Nyb2xsaW5nIHRoZSB3aW5kb3cKCQkJLy8gVGhlIGZvbGxvd2luZyBmdW5jdGlvbiBzZXJ2ZXMgdG8gcnVsZSBvdXQgc29tZSBwb3B1bGFyIGJyb3dzZXJzIHdpdGgga25vd24gZml4ZWQtcG9zaXRpb25pbmcgaXNzdWVzCgkJCS8vIFRoaXMgaXMgYSBwbHVnaW4gb3B0aW9uIGxpa2UgYW55IG90aGVyLCBzbyBmZWVsIGZyZWUgdG8gaW1wcm92ZSBvciBvdmVyd3JpdGUgaXQKCQkJc3VwcG9ydEJsYWNrbGlzdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgdyA9IHdpbmRvdywKCQkJCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJCQkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQkJCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCQkJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJCQkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCQkJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCgkJCQlpZigKCQkJCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJCQkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJCQkJLy8gT3BlcmEgTWluaQoJCQkJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJCQkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkJCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJCQkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCQkJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCQkJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCQkJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJCQkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJCQkJLy8gTWVlR28KCQkJCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYgKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXNlbGYuZGVzdHJveSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZml4ZWQiICk7CgoJCQkvLyAiZnVsbHNjcmVlbiIgb3ZlcmxheSBwb3NpdGlvbmluZwoJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJc2VsZi5fYWRkVHJhbnNpdGlvbkNsYXNzKCk7CgkJCXNlbGYuX2JpbmRQYWdlRXZlbnRzKCk7CgkJCXNlbGYuX2JpbmRUb2dnbGVIYW5kbGVycygpOwoJCX0sCgoJCV9hZGRUcmFuc2l0aW9uQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGNsYXNzID0gdGhpcy5vcHRpb25zLnRyYW5zaXRpb247CgoJCQlpZiAoIHRjbGFzcyAmJiB0Y2xhc3MgIT09ICJub25lIiApIHsKCQkJCS8vIHVzZSBhcHByb3ByaWF0ZSBzbGlkZSBmb3IgaGVhZGVyIG9yIGZvb3RlcgoJCQkJaWYgKCB0Y2xhc3MgPT09ICJzbGlkZSIgKSB7CgkJCQkJdGNsYXNzID0gdGhpcy5lbGVtZW50LmlzKCAiLnVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50OwoKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKQoJCQkJLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJCX0KCQkJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJCQlzZWxmLmhpZGUoIHRydWUgKTsKCQkJCQl9CgkJCQl9ICkKCQkJCS5iaW5kKCAid2Via2l0QW5pbWF0aW9uU3RhcnQgYW5pbWF0aW9uc3RhcnQgdXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHRoaXNQYWdlID0gdGhpczsKCQkJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdGhpc1BhZ2UgPSB0aGlzOwoJCQkJCXNlbGYudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXNQYWdlICk7CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQkkKCB3aW5kb3cgKS5iaW5kKCAidGhyb3R0bGVkcmVzaXplLiIgKyBzZWxmLndpZGdldE5hbWUsIGZ1bmN0aW9uKCkgewoJCQkJCQkJc2VsZi51cGRhdGVQYWdlUGFkZGluZyggdGhpc1BhZ2UgKTsKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSkKCQkJCS5iaW5kKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJCQl9CgkJCQkJaWYgKCBvLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJCQkkKCB3aW5kb3cgKS51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUuIiArIHNlbGYud2lkZ2V0TmFtZSApOwoJCQkJCX0KCgkJCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJCQl2YXIgdGhpc0Zvb3RlciA9ICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcyApLAoJCQkJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpLAoJCQkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJCQkJbmV4dEZvb3Rlci5hZGQoIG5leHRIZWFkZXIgKS5hcHBlbmRUbyggdGhpcyApOwoJCQkJCQkJCX0pOwoJCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoJCX0sCgoJCV92aXNpYmxlOiB0cnVlLAoKCQkvLyBUaGlzIHdpbGwgc2V0IHRoZSBjb250ZW50IGVsZW1lbnQncyB0b3Agb3IgYm90dG9tIHBhZGRpbmcgZXF1YWwgdG8gdGhlIHRvb2xiYXIncyBoZWlnaHQKCQl1cGRhdGVQYWdlUGFkZGluZzogZnVuY3Rpb24oIHRiUGFnZSApIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCWhlYWRlciA9ICRlbC5pcyggIi51aS1oZWFkZXIiICk7CgoJCQkvLyBUaGlzIGJlaGF2aW9yIG9ubHkgYXBwbGllcyB0byAiZml4ZWQiLCBub3QgImZ1bGxzY3JlZW4iCgkJCWlmICggdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gKSB7IHJldHVybjsgfQoKCQkJdGJQYWdlID0gdGJQYWdlIHx8ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICk7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9ICQoIHdpbmRvdyApLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGJ0eXBlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGJ0eXBlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQ7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCA1MDAgJiYgJCggZS50YXJnZXQgKS5pcyggby5oaWRlRHVyaW5nRm9jdXMgKSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCAiLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCIgKS5sZW5ndGggKSB7CgkJCQkJCXNlbGZbICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgc2VsZi5fdmlzaWJsZSApID8gImhpZGUiIDogInNob3ciIF0oKTsKCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlkZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJCggZG9jdW1lbnQgKQoJCS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkJCS8vIERFUFJFQ0FURUQgaW4gMS4xOiBzdXBwb3J0IGZvciBkYXRhLWZ1bGxzY3JlZW49dHJ1ZXxmYWxzZSBvbiB0aGUgcGFnZSBlbGVtZW50LgoJCQkvLyBUaGlzIGxpbmUgZW5zdXJlcyBpdCBzdGlsbCB3b3JrcywgYnV0IHdlIHJlY29tbWVuZCBtb3ZpbmcgdGhlIGF0dHJpYnV0ZSB0byB0aGUgdG9vbGJhcnMgdGhlbXNlbHZlcy4KCQkJaWYgKCAkKCBlLnRhcmdldCApLmpxbURhdGEoICJmdWxsc2NyZWVuIiApICkgewoJCQkJJCggJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5vcHRpb25zLmluaXRTZWxlY3RvciwgZS50YXJnZXQgKS5ub3QoICI6anFtRGF0YShmdWxsc2NyZWVuKSIgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIsIHRydWUgKTsKCQkJfQoKCQkJJC5tb2JpbGUuZml4ZWR0b29sYmFyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwoJCX0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCglpZiAoICEoL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgKSApIHsKCQlyZXR1cm47Cgl9CgogIHZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCiAgZnVuY3Rpb24gY2hlY2tUaWx0KCBlICkgewoJCWV2dCA9IGUub3JpZ2luYWxFdmVudDsKCQlhaWcgPSBldnQuYWNjZWxlcmF0aW9uSW5jbHVkaW5nR3Jhdml0eTsKCgkJeCA9IE1hdGguYWJzKCBhaWcueCApOwoJCXkgPSBNYXRoLmFicyggYWlnLnkgKTsKCQl6ID0gTWF0aC5hYnMoIGFpZy56ICk7CgoJCS8vIElmIHBvcnRyYWl0IG9yaWVudGF0aW9uIGFuZCBpbiBvbmUgb2YgdGhlIGRhbmdlciB6b25lcwogICAgaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZGlzYWJsZSgpOwoJCQl9CiAgICB9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQl6b29tLmVuYWJsZSgpOwogICAgfQogIH0KCiAgJCggd2luZG93ICkKCQkuYmluZCggIm9yaWVudGF0aW9uY2hhbmdlLmlvc29yaWVudGF0aW9uZml4Iiwgem9vbS5lbmFibGUgKQoJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJCSRoZWFkID0gJCggImhlYWQiICksCgkJCSR3aW5kb3cgPSAkKCB3aW5kb3cgKTsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgJHBhZ2VzID0gJCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICksCgkJCQloYXNoID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaC5yZXBsYWNlKCIjIiwgIiIpLAoJCQkJaGFzaFBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggaGFzaCApOwoKCQkJLy8gaWYgbm8gcGFnZXMgYXJlIGZvdW5kLCBjcmVhdGUgb25lIHdpdGggYm9keSdzIGlubmVyIGh0bWwKCQkJaWYgKCAhJHBhZ2VzLmxlbmd0aCApIHsKCQkJCSRwYWdlcyA9ICQoICJib2R5IiApLndyYXBJbm5lciggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+PC9kaXY+IiApLmNoaWxkcmVuKCAwICk7CgkJCX0KCgkJCS8vIGFkZCBkaWFsb2dzLCBzZXQgZGF0YS11cmwgYXR0cnMKCQkJJHBhZ2VzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQkJLy8gdW5sZXNzIHRoZSBkYXRhIHVybCBpcyBhbHJlYWR5IHNldCBzZXQgaXQgdG8gdGhlIHBhdGhuYW1lCgkJCQlpZiAoICEkdGhpcy5qcW1EYXRhKCAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICRwYWdlcy5maXJzdCgpLnBhcmVudCgpLmFkZENsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0IiApOwoKCQkJLy8gYWxlcnQgbGlzdGVuZXJzIHRoYXQgdGhlIHBhZ2Vjb250YWluZXIgaGFzIGJlZW4gZGV0ZXJtaW5lZCBmb3IgYmluZGluZwoJCQkvLyB0byBldmVudHMgdHJpZ2dlcmVkIG9uIGl0CgkJCSR3aW5kb3cudHJpZ2dlciggInBhZ2Vjb250YWluZXJjcmVhdGUiICk7CgoJCQkvLyBjdWUgcGFnZSBsb2FkaW5nIG1lc3NhZ2UKCQkJJC5tb2JpbGUuc2hvd1BhZ2VMb2FkaW5nTXNnKCk7CgoJCQkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCgkJCWhpZGVSZW5kZXJpbmdDbGFzcygpOwoKCQkJLy8gaWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZGlzYWJsZWQsIHRoZXJlJ3Mgbm8gaGFzaCBkZWVwbGluaywKCQkJLy8gdGhlIGhhc2ggaXMgbm90IHZhbGlkIChjb250YWlucyBtb3JlIHRoYW4gb25lICMgb3IgZG9lcyBub3Qgc3RhcnQgd2l0aCAjKQoJCQkvLyBvciB0aGVyZSBpcyBubyBwYWdlIHdpdGggdGhhdCBoYXNoLCBjaGFuZ2UgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIERPTQoJCQkvLyBSZW1lbWJlciwgaG93ZXZlciwgdGhhdCB0aGUgaGFzaCBjYW4gYWxzbyBiZSBhIHBhdGghCgkJCWlmICggISAoICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSggJCggaGFzaFBhZ2UgKS5pcyggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKScgKSB8fAoJCQkJCSQubW9iaWxlLnBhdGguaXNQYXRoKCBoYXNoICkgfHwKCQkJCQloYXNoID09PSAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgKSApIHsKCgkJCQkvLyBTdG9yZSB0aGUgaW5pdGlhbCBkZXN0aW5hdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5wYXRoLmlzSGFzaFZhbGlkKCBsb2NhdGlvbi5oYXNoICkgKSB7CgkJCQkJJC5tb2JpbGUudXJsSGlzdG9yeS5pbml0aWFsRHN0ID0gaGFzaC5yZXBsYWNlKCAiIyIsICIiICk7CgkJCQl9CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsgdHJhbnNpdGlvbjogIm5vbmUiLCByZXZlcnNlOiB0cnVlLCBjaGFuZ2VIYXNoOiBmYWxzZSwgZnJvbUhhc2hDaGFuZ2U6IHRydWUgfSApOwoJCQl9CgkJCS8vIG90aGVyd2lzZSwgdHJpZ2dlciBhIGhhc2hjaGFuZ2UgdG8gbG9hZCBhIGRlZXBsaW5rCgkJCWVsc2UgewoJCQkJJHdpbmRvdy50cmlnZ2VyKCAiaGFzaGNoYW5nZSIsIFsgdHJ1ZSBdICk7CgkJCX0KCQl9Cgl9KTsKCgkvLyBpbml0aWFsaXplIGV2ZW50cyBub3csIGFmdGVyIG1vYmlsZWluaXQgaGFzIG9jY3VycmVkCgkkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkLnJlc29sdmUoKTsKCgkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCS8vIHRoZW4gY2hlY2sgd2hhdCB0aGUgc2Nyb2xsIHRvcCBpcy4gQW5kcm9pZCB3aWxsIHJlcG9ydCAwLi4uIG90aGVycyAxCgkvLyBub3RlIHRoYXQgdGhpcyBpbml0aWFsIHNjcm9sbCB3b24ndCBoaWRlIHRoZSBhZGRyZXNzIGJhci4gSXQncyBqdXN0IGZvciB0aGUgY2hlY2suCgkkKGZ1bmN0aW9uKCkgewoJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoKCQkvLyBpZiBkZWZhdWx0SG9tZVNjcm9sbCBoYXNuJ3QgYmVlbiBzZXQgeWV0LCBzZWUgaWYgc2Nyb2xsVG9wIGlzIDEKCQkvLyBpdCBzaG91bGQgYmUgMSBpbiBtb3N0IGJyb3dzZXJzLCBidXQgYW5kcm9pZCB0cmVhdHMgMSBhcyAwIChmb3IgaGlkaW5nIGFkZHIgYmFyKQoJCS8vIHNvIGlmIGl0J3MgMSwgdXNlIDAgZnJvbSBub3cgb24KCQkkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCA9ICggISQuc3VwcG9ydC5zY3JvbGxUb3AgfHwgJCggd2luZG93ICkuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCgkJLy8gVE9ETzogSW1wbGVtZW50IGEgcHJvcGVyIHJlZ2lzdHJhdGlvbiBtZWNoYW5pc20gd2l0aCBkZXBlbmRlbmN5IGhhbmRsaW5nIGluIG9yZGVyIHRvIG5vdCBoYXZlIGV4Y2VwdGlvbnMgbGlrZSB0aGUgb25lIGJlbG93CgkJLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzIGZvciB0aG9zZSB3aWRnZXRzIHRoYXQgaGF2ZSBhIHNvZnQgZGVwZW5kZW5jeSBvbiBvdGhlcnMKCQlpZiAoICQuZm4uY29udHJvbGdyb3VwICkgewoJCQkkKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJJCggIjpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpIiwgZS50YXJnZXQgKQoJCQkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCQkJLmNvbnRyb2xncm91cCh7IGV4Y2x1ZGVJbnZpc2libGU6IGZhbHNlIH0pOwoJCQl9KTsKCQl9CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQKCQkkd2luZG93LmxvYWQoICQubW9iaWxlLnNpbGVudFNjcm9sbCApOwoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkkKCBkb2N1bWVudCApLmRlbGVnYXRlKCAiLnVpLWRpc2FibGVkIiwgInZjbGljayIsCgkJCQlmdW5jdGlvbiggZSApIHsKCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJKTsKCQl9Cgl9KTsKfSggalF1ZXJ5LCB0aGlzICkpOwoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 02:36:04 GMT",
                    "Content-Length": "293534",
                    "Date": "Fri, 07 Nov 2014 02:36:04 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}