{
    "url": "http://localhost:9999/ded/script.js/vendor/mootools.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ded/script.js/vendor/mootools.js",
                "path": "/ded/script.js/vendor/mootools.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kZWQvc2NyaXB0LmpzL3ZlbmRvci9tb290b29scy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQwOTcxDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDA0OjA3OjM0IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwNDowNzozNCBHTVQNCg0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zJywKCWJ1aWxkOiAnYTNlZWQ2OTJkZDg1MDUwZDgwMTY4ZWMyYzcwOGVmZTkwMWJiN2RiMycKfTsKCi8vIHR5cGVPZiwgaW5zdGFuY2VPZgoKdmFyIHR5cGVPZiA9IHRoaXMudHlwZU9mID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gJ251bGwnOwoJaWYgKGl0ZW0uJGZhbWlseSkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CglyZXR1cm4gaXRlbSBpbnN0YW5jZW9mIG9iamVjdDsKfTsKCi8vIEZ1bmN0aW9uIG92ZXJsb2FkaW5nCgp2YXIgRnVuY3Rpb24gPSB0aGlzLkZ1bmN0aW9uOwoKdmFyIGVudW1lcmFibGVzID0gdHJ1ZTsKZm9yICh2YXIgaSBpbiB7dG9TdHJpbmc6IDF9KSBlbnVtZXJhYmxlcyA9IG51bGw7CmlmIChlbnVtZXJhYmxlcykgZW51bWVyYWJsZXMgPSBbJ2hhc093blByb3BlcnR5JywgJ3ZhbHVlT2YnLCAnaXNQcm90b3R5cGVPZicsICdwcm9wZXJ0eUlzRW51bWVyYWJsZScsICd0b0xvY2FsZVN0cmluZycsICd0b1N0cmluZycsICdjb25zdHJ1Y3RvciddOwoKRnVuY3Rpb24ucHJvdG90eXBlLm92ZXJsb2FkU2V0dGVyID0gZnVuY3Rpb24odXNlUGx1cmFsKXsKCXZhciBzZWxmID0gdGhpczsKCXJldHVybiBmdW5jdGlvbihhLCBiKXsKCQlpZiAoYSA9PSBudWxsKSByZXR1cm4gdGhpczsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKXsKCQkJZm9yICh2YXIgayBpbiBhKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCWlmIChlbnVtZXJhYmxlcykgZm9yICh2YXIgaSA9IGVudW1lcmFibGVzLmxlbmd0aDsgaS0tOyl7CgkJCQlrID0gZW51bWVyYWJsZXNbaV07CgkJCQlpZiAoYS5oYXNPd25Qcm9wZXJ0eShrKSkgc2VsZi5jYWxsKHRoaXMsIGssIGFba10pOwoJCQl9CgkJfSBlbHNlIHsKCQkJc2VsZi5jYWxsKHRoaXMsIGEsIGIpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX07Cn07CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRHZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEpewoJCXZhciBhcmdzLCByZXN1bHQ7CgkJaWYgKHVzZVBsdXJhbCB8fCB0eXBlb2YgYSAhPSAnc3RyaW5nJykgYXJncyA9IGE7CgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIGFyZ3MgPSBhcmd1bWVudHM7CgkJaWYgKGFyZ3MpewoJCQlyZXN1bHQgPSB7fTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSByZXN1bHRbYXJnc1tpXV0gPSBzZWxmLmNhbGwodGhpcywgYXJnc1tpXSk7CgkJfSBlbHNlIHsKCQkJcmVzdWx0ID0gc2VsZi5jYWxsKHRoaXMsIGEpOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXNba2V5XSA9IHZhbHVlOwp9Lm92ZXJsb2FkU2V0dGVyKCk7CgpGdW5jdGlvbi5wcm90b3R5cGUuaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSl7Cgl0aGlzLnByb3RvdHlwZVtrZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCi8vIEZyb20KCnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCkZ1bmN0aW9uLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAodHlwZU9mKGl0ZW0pID09ICdmdW5jdGlvbicpID8gaXRlbSA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGl0ZW07Cgl9Owp9OwoKQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuIFtdOwoJcmV0dXJuIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJykgPyAodHlwZU9mKGl0ZW0pID09ICdhcnJheScpID8gaXRlbSA6IHNsaWNlLmNhbGwoaXRlbSkgOiBbaXRlbV07Cn07CgpOdW1iZXIuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJdmFyIG51bWJlciA9IHBhcnNlRmxvYXQoaXRlbSk7CglyZXR1cm4gaXNGaW5pdGUobnVtYmVyKSA/IG51bWJlciA6IG51bGw7Cn07CgpTdHJpbmcuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIGl0ZW0gKyAnJzsKfTsKCi8vIGhpZGUsIHByb3RlY3QKCkZ1bmN0aW9uLmltcGxlbWVudCh7CgoJaGlkZTogZnVuY3Rpb24oKXsKCQl0aGlzLiRoaWRkZW4gPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglwcm90ZWN0OiBmdW5jdGlvbigpewoJCXRoaXMuJHByb3RlY3RlZCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIFR5cGUKCnZhciBUeXBlID0gdGhpcy5UeXBlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0KXsKCWlmIChuYW1lKXsKCQl2YXIgbG93ZXIgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJdmFyIHR5cGVDaGVjayA9IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gKHR5cGVPZihpdGVtKSA9PSBsb3dlcik7CgkJfTsKCgkJVHlwZVsnaXMnICsgbmFtZV0gPSB0eXBlQ2hlY2s7CgkJaWYgKG9iamVjdCAhPSBudWxsKXsKCQkJb2JqZWN0LnByb3RvdHlwZS4kZmFtaWx5ID0gKGZ1bmN0aW9uKCl7CgkJCQlyZXR1cm4gbG93ZXI7CgkJCX0pLmhpZGUoKTsKCQkJLy88MS4yY29tcGF0PgoJCQlvYmplY3QudHlwZSA9IHR5cGVDaGVjazsKCQkJLy88LzEuMmNvbXBhdD4KCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgkKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwoJcmV0dXJuIHRoaXM7Cn07CgpUeXBlLmltcGxlbWVudCh7CgoJaW1wbGVtZW50OiBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSwKCglleHRlbmQ6IGV4dGVuZC5vdmVybG9hZFNldHRlcigpLAoKCWFsaWFzOiBmdW5jdGlvbihuYW1lLCBleGlzdGluZyl7CgkJaW1wbGVtZW50LmNhbGwodGhpcywgbmFtZSwgdGhpcy5wcm90b3R5cGVbZXhpc3RpbmddKTsKCX0ub3ZlcmxvYWRTZXR0ZXIoKSwKCgltaXJyb3I6IGZ1bmN0aW9uKGhvb2spewoJCWhvb2tzT2YodGhpcykucHVzaChob29rKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKbmV3IFR5cGUoJ1R5cGUnLCBUeXBlKTsKCi8vIERlZmF1bHQgVHlwZXMKCnZhciBmb3JjZSA9IGZ1bmN0aW9uKG5hbWUsIG9iamVjdCwgbWV0aG9kcyl7Cgl2YXIgaXNUeXBlID0gKG9iamVjdCAhPSBPYmplY3QpLAoJCXByb3RvdHlwZSA9IG9iamVjdC5wcm90b3R5cGU7CgoJaWYgKGlzVHlwZSkgb2JqZWN0ID0gbmV3IFR5cGUobmFtZSwgb2JqZWN0KTsKCglmb3IgKHZhciBpID0gMCwgbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQl2YXIga2V5ID0gbWV0aG9kc1tpXSwKCQkJZ2VuZXJpYyA9IG9iamVjdFtrZXldLAoJCQlwcm90byA9IHByb3RvdHlwZVtrZXldOwoKCQlpZiAoZ2VuZXJpYykgZ2VuZXJpYy5wcm90ZWN0KCk7CgoJCWlmIChpc1R5cGUgJiYgcHJvdG8pewoJCQlkZWxldGUgcHJvdG90eXBlW2tleV07CgkJCXByb3RvdHlwZVtrZXldID0gcHJvdG8ucHJvdGVjdCgpOwoJCX0KCX0KCglpZiAoaXNUeXBlKSBvYmplY3QuaW1wbGVtZW50KHByb3RvdHlwZSk7CgoJcmV0dXJuIGZvcmNlOwp9OwoKZm9yY2UoJ1N0cmluZycsIFN0cmluZywgWwoJJ2NoYXJBdCcsICdjaGFyQ29kZUF0JywgJ2NvbmNhdCcsICdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ21hdGNoJywgJ3F1b3RlJywgJ3JlcGxhY2UnLCAnc2VhcmNoJywKCSdzbGljZScsICdzcGxpdCcsICdzdWJzdHInLCAnc3Vic3RyaW5nJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCk9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgovLzwxLjJjb21wYXQ+Cgp2YXIgSGFzaCA9IHRoaXMuSGFzaCA9IG5ldyBUeXBlKCdIYXNoJywgZnVuY3Rpb24ob2JqZWN0KXsKCWlmICh0eXBlT2Yob2JqZWN0KSA9PSAnaGFzaCcpIG9iamVjdCA9IE9iamVjdC5jbG9uZShvYmplY3QuZ2V0Q2xlYW4oKSk7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB0aGlzW2tleV0gPSBvYmplY3Rba2V5XTsKCXJldHVybiB0aGlzOwp9KTsKCkhhc2guaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJT2JqZWN0LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRDbGVhbjogZnVuY3Rpb24oKXsKCQl2YXIgY2xlYW4gPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gdGhpcyl7CgkJCWlmICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpIGNsZWFuW2tleV0gPSB0aGlzW2tleV07CgkJfQoJCXJldHVybiBjbGVhbjsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSAwOwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgbGVuZ3RoKys7CgkJfQoJCXJldHVybiBsZW5ndGg7Cgl9Cgp9KTsKCkhhc2guYWxpYXMoJ2VhY2gnLCAnZm9yRWFjaCcpOwoKT2JqZWN0LnR5cGUgPSBUeXBlLmlzT2JqZWN0OwoKdmFyIE5hdGl2ZSA9IHRoaXMuTmF0aXZlID0gZnVuY3Rpb24ocHJvcGVydGllcyl7CglyZXR1cm4gbmV3IFR5cGUocHJvcGVydGllcy5uYW1lLCBwcm9wZXJ0aWVzLmluaXRpYWxpemUpOwp9OwoKTmF0aXZlLnR5cGUgPSBUeXBlLnR5cGU7CgpOYXRpdmUuaW1wbGVtZW50ID0gZnVuY3Rpb24ob2JqZWN0cywgbWV0aG9kcyl7Cglmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIG9iamVjdHNbaV0uaW1wbGVtZW50KG1ldGhvZHMpOwoJcmV0dXJuIE5hdGl2ZTsKfTsKCnZhciBhcnJheVR5cGUgPSBBcnJheS50eXBlOwpBcnJheS50eXBlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaW5zdGFuY2VPZihpdGVtLCBBcnJheSkgfHwgYXJyYXlUeXBlKGl0ZW0pOwp9OwoKdGhpcy4kQSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIEFycmF5LmZyb20oaXRlbSkuc2xpY2UoKTsKfTsKCnRoaXMuJGFyZ3VtZW50cyA9IGZ1bmN0aW9uKGkpewoJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGFyZ3VtZW50c1tpXTsKCX07Cn07Cgp0aGlzLiRjaGsgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKdGhpcy4kY2xlYXIgPSBmdW5jdGlvbih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCnRoaXMuJGRlZmluZWQgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuIChvYmogIT0gbnVsbCk7Cn07Cgp0aGlzLiRlYWNoID0gZnVuY3Rpb24oaXRlcmFibGUsIGZuLCBiaW5kKXsKCXZhciB0eXBlID0gdHlwZU9mKGl0ZXJhYmxlKTsKCSgodHlwZSA9PSAnYXJndW1lbnRzJyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnZWxlbWVudHMnKSA/IEFycmF5IDogT2JqZWN0KS5lYWNoKGl0ZXJhYmxlLCBmbiwgYmluZCk7Cn07Cgp0aGlzLiRlbXB0eSA9IGZ1bmN0aW9uKCl7fTsKCnRoaXMuJGV4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbmFsLCBleHRlbmRlZCl7CglyZXR1cm4gT2JqZWN0LmFwcGVuZChvcmlnaW5hbCwgZXh0ZW5kZWQpOwp9OwoKdGhpcy4kSCA9IGZ1bmN0aW9uKG9iamVjdCl7CglyZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKfTsKCnRoaXMuJG1lcmdlID0gZnVuY3Rpb24oKXsKCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzKTsKCWFyZ3MudW5zaGlmdCh7fSk7CglyZXR1cm4gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIGFyZ3MpOwp9OwoKdGhpcy4kbGFtYmRhID0gRnVuY3Rpb24uZnJvbTsKdGhpcy4kbWl4aW4gPSBPYmplY3QubWVyZ2U7CnRoaXMuJHJhbmRvbSA9IE51bWJlci5yYW5kb207CnRoaXMuJHNwbGF0ID0gQXJyYXkuZnJvbTsKdGhpcy4kdGltZSA9IERhdGUubm93OwoKdGhpcy4kdHlwZSA9IGZ1bmN0aW9uKG9iamVjdCl7Cgl2YXIgdHlwZSA9IHR5cGVPZihvYmplY3QpOwoJaWYgKHR5cGUgPT0gJ2VsZW1lbnRzJykgcmV0dXJuICdhcnJheSc7CglyZXR1cm4gKHR5cGUgPT0gJ251bGwnKSA/IGZhbHNlIDogdHlwZTsKfTsKCnRoaXMuJHVubGluayA9IGZ1bmN0aW9uKG9iamVjdCl7Cglzd2l0Y2ggKHR5cGVPZihvYmplY3QpKXsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKG9iamVjdCk7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gQXJyYXkuY2xvbmUob2JqZWN0KTsKCQljYXNlICdoYXNoJzogcmV0dXJuIG5ldyBIYXNoKG9iamVjdCk7CgkJZGVmYXVsdDogcmV0dXJuIG9iamVjdDsKCX0KfTsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdHMucHVzaCh0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0gIT0gbnVsbDsKCQl9KTsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW47IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IHRoaXMuaW5kZXhPZihzdHJpbmcpID4gLTE7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gKCctJyArIG1hdGNoLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpKTsKCQl9KTsKCX0sCgoJY2FwaXRhbGl6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8oWy0uKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfSwKCgl0b0ludDogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIHBhcnNlSW50KHRoaXMsIGJhc2UgfHwgMTApOwoJfSwKCgl0b0Zsb2F0OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUZsb2F0KHRoaXMpOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IG51bGw7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKHJlZ2V4cCB8fCAoL1xcP1x7KFtee31dKylcfS9nKSwgZnVuY3Rpb24obWF0Y2gsIG5hbWUpewoJCQlpZiAobWF0Y2guY2hhckF0KDApID09ICdcXCcpIHJldHVybiBtYXRjaC5zbGljZSgxKTsKCQkJcmV0dXJuIChvYmplY3RbbmFtZV0gIT0gbnVsbCkgPyBvYmplY3RbbmFtZV0gOiAnJzsKCQl9KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWRlbGF5OiBmdW5jdGlvbihkZWxheSwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldFRpbWVvdXQodGhpcy5wYXNzKGFyZ3MsIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoYXJncywgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKCk9iamVjdC5leHRlbmQoewoKCXN1YnNldDogZnVuY3Rpb24ob2JqZWN0LCBrZXlzKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgayA9IGtleXNbaV07CgkJCXJlc3VsdHNba10gPSBvYmplY3Rba107CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0c1trZXldID0gZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0pOwoJCXJldHVybiByZXN1bHRzOwoJfSwKCglldmVyeTogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJc29tZTogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXkpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglrZXlzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBrZXlzID0gW107CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkga2V5cy5wdXNoKGtleSk7CgkJfQoJCXJldHVybiBrZXlzOwoJfSwKCgl2YWx1ZXM6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIHZhbHVlcyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHZhbHVlcy5wdXNoKG9iamVjdFtrZXldKTsKCQl9CgkJcmV0dXJuIHZhbHVlczsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbihvYmplY3QpewoJCXJldHVybiBPYmplY3Qua2V5cyhvYmplY3QpLmxlbmd0aDsKCX0sCgoJa2V5T2Y6IGZ1bmN0aW9uKG9iamVjdCwgdmFsdWUpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgb2JqZWN0W2tleV0gPT09IHZhbHVlKSByZXR1cm4ga2V5OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKG9iamVjdCwgdmFsdWUpewoJCXJldHVybiBPYmplY3Qua2V5T2Yob2JqZWN0LCB2YWx1ZSkgIT0gbnVsbDsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24ob2JqZWN0LCBiYXNlKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCgkJT2JqZWN0LmVhY2gob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJaWYgKGJhc2UpIGtleSA9IGJhc2UgKyAnWycgKyBrZXkgKyAnXSc7CgkJCXZhciByZXN1bHQ7CgkJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCQljYXNlICdvYmplY3QnOiByZXN1bHQgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YWx1ZSwga2V5KTsgYnJlYWs7CgkJCQljYXNlICdhcnJheSc6CgkJCQkJdmFyIHFzID0ge307CgkJCQkJdmFsdWUuZWFjaChmdW5jdGlvbih2YWwsIGkpewoJCQkJCQlxc1tpXSA9IHZhbDsKCQkJCQl9KTsKCQkJCQlyZXN1bHQgPSBPYmplY3QudG9RdWVyeVN0cmluZyhxcywga2V5KTsKCQkJCWJyZWFrOwoJCQkJZGVmYXVsdDogcmVzdWx0ID0ga2V5ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQkJfQoJCQlpZiAodmFsdWUgIT0gbnVsbCkgcXVlcnlTdHJpbmcucHVzaChyZXN1bHQpOwoJCX0pOwoKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfQoKfSk7CgoKLy88MS4yY29tcGF0PgoKSGFzaC5pbXBsZW1lbnQoewoKCWhhczogT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKCglrZXlPZjogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBPYmplY3Qua2V5T2YodGhpcywgdmFsdWUpOwoJfSwKCgloYXNWYWx1ZTogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBPYmplY3QuY29udGFpbnModGhpcywgdmFsdWUpOwoJfSwKCglleHRlbmQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCUhhc2guZWFjaChwcm9wZXJ0aWVzIHx8IHt9LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJSGFzaC5zZXQodGhpcywga2V5LCB2YWx1ZSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCUhhc2guZWFjaChwcm9wZXJ0aWVzIHx8IHt9LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJSGFzaC5pbmNsdWRlKHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oa2V5KXsKCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBkZWxldGUgdGhpc1trZXldOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKGtleSl7CgkJcmV0dXJuICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpID8gdGhpc1trZXldIDogbnVsbDsKCX0sCgoJc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAoIXRoaXNba2V5XSB8fCB0aGlzLmhhc093blByb3BlcnR5KGtleSkpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlIYXNoLmVhY2godGhpcywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWRlbGV0ZSB0aGlzW2tleV07CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluY2x1ZGU6IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJCWlmICh0aGlzW2tleV0gPT0gbnVsbCkgdGhpc1trZXldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCW1hcDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBuZXcgSGFzaChPYmplY3QubWFwKHRoaXMsIGZuLCBiaW5kKSk7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBuZXcgSGFzaChPYmplY3QuZmlsdGVyKHRoaXMsIGZuLCBiaW5kKSk7Cgl9LAoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5ldmVyeSh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gT2JqZWN0LnNvbWUodGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRLZXlzOiBmdW5jdGlvbigpewoJCXJldHVybiBPYmplY3Qua2V5cyh0aGlzKTsKCX0sCgoJZ2V0VmFsdWVzOiBmdW5jdGlvbigpewoJCXJldHVybiBPYmplY3QudmFsdWVzKHRoaXMpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gT2JqZWN0LnRvUXVlcnlTdHJpbmcodGhpcywgYmFzZSk7Cgl9Cgp9KTsKCkhhc2guZXh0ZW5kID0gT2JqZWN0LmFwcGVuZDsKCkhhc2guYWxpYXMoe2luZGV4T2Y6ICdrZXlPZicsIGNvbnRhaW5zOiAnaGFzVmFsdWUnfSk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCi8vPDEuMmNvbXBhdD4KCmlmIChCcm93c2VyLlBsYXRmb3JtLmlvcykgQnJvd3Nlci5QbGF0Zm9ybS5pcG9kID0gdHJ1ZTsKCkJyb3dzZXIuRW5naW5lID0ge307Cgp2YXIgc2V0RW5naW5lID0gZnVuY3Rpb24obmFtZSwgdmVyc2lvbil7CglCcm93c2VyLkVuZ2luZS5uYW1lID0gbmFtZTsKCUJyb3dzZXIuRW5naW5lW25hbWUgKyB2ZXJzaW9uXSA9IHRydWU7CglCcm93c2VyLkVuZ2luZS52ZXJzaW9uID0gdmVyc2lvbjsKfTsKCmlmIChCcm93c2VyLmllKXsKCUJyb3dzZXIuRW5naW5lLnRyaWRlbnQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDY6IHNldEVuZ2luZSgndHJpZGVudCcsIDQpOyBicmVhazsKCQljYXNlIDc6IHNldEVuZ2luZSgndHJpZGVudCcsIDUpOyBicmVhazsKCQljYXNlIDg6IHNldEVuZ2luZSgndHJpZGVudCcsIDYpOwoJfQp9CgppZiAoQnJvd3Nlci5maXJlZm94KXsKCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDMpIHNldEVuZ2luZSgnZ2Vja28nLCAxOSk7CgllbHNlIHNldEVuZ2luZSgnZ2Vja28nLCAxOCk7Cn0KCmlmIChCcm93c2VyLnNhZmFyaSB8fCBCcm93c2VyLmNocm9tZSl7CglCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDI6IHNldEVuZ2luZSgnd2Via2l0JywgNDE5KTsgYnJlYWs7CgkJY2FzZSAzOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQyMCk7IGJyZWFrOwoJCWNhc2UgNDogc2V0RW5naW5lKCd3ZWJraXQnLCA1MjUpOwoJfQp9CgppZiAoQnJvd3Nlci5vcGVyYSl7CglCcm93c2VyLkVuZ2luZS5wcmVzdG8gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gOS42KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk2MCk7CgllbHNlIGlmIChCcm93c2VyLnZlcnNpb24gPj0gOS41KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk1MCk7CgllbHNlIHNldEVuZ2luZSgncHJlc3RvJywgOTI1KTsKfQoKaWYgKEJyb3dzZXIubmFtZSA9PSAndW5rbm93bicpewoJc3dpdGNoICgodWEubWF0Y2goLyg/OndlYmtpdHxraHRtbHxnZWNrbykvKSB8fCBbXSlbMF0pewoJCWNhc2UgJ3dlYmtpdCc6CgkJY2FzZSAna2h0bWwnOgoJCQlCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoJCWJyZWFrOwoJCWNhc2UgJ2dlY2tvJzoKCQkJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoJfQp9Cgp0aGlzLiRleGVjID0gQnJvd3Nlci5leGVjOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBDbGFzcywgdG8gbWFrZSB0aGUgZXZlbnQgb2JqZWN0IGNyb3NzLWJyb3dzZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIEZ1bmN0aW9uLCBTdHJpbmcsIE9iamVjdF0KCnByb3ZpZGVzOiBFdmVudAoKLi4uCiovCgp2YXIgRXZlbnQgPSBuZXcgVHlwZSgnRXZlbnQnLCBmdW5jdGlvbihldmVudCwgd2luKXsKCWlmICghd2luKSB3aW4gPSB3aW5kb3c7Cgl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJZXZlbnQgPSBldmVudCB8fCB3aW4uZXZlbnQ7CglpZiAoZXZlbnQuJGV4dGVuZGVkKSByZXR1cm4gZXZlbnQ7Cgl0aGlzLiRleHRlbmRlZCA9IHRydWU7Cgl2YXIgdHlwZSA9IGV2ZW50LnR5cGUsCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQsCgkJcGFnZSA9IHt9LAoJCWNsaWVudCA9IHt9OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgIT0gLTEpewoJCXZhciBjb2RlID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZTsKCQl2YXIga2V5ID0gT2JqZWN0LmtleU9mKEV2ZW50LktleXMsIGNvZGUpOwoJCWlmICh0eXBlID09ICdrZXlkb3duJyl7CgkJCXZhciBmS2V5ID0gY29kZSAtIDExMTsKCQkJaWYgKGZLZXkgPiAwICYmIGZLZXkgPCAxMykga2V5ID0gJ2YnICsgZktleTsKCQl9CgkJaWYgKCFrZXkpIGtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZS50ZXN0KC9jbGlja3xtb3VzZXxtZW51L2kpKXsKCQlkb2MgPSAoIWRvYy5jb21wYXRNb2RlIHx8IGRvYy5jb21wYXRNb2RlID09ICdDU1MxQ29tcGF0JykgPyBkb2MuaHRtbCA6IGRvYy5ib2R5OwoJCXBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQljbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZS50ZXN0KC9ET01Nb3VzZVNjcm9sbHxtb3VzZXdoZWVsLykpewoJCQl2YXIgd2hlZWwgPSAoZXZlbnQud2hlZWxEZWx0YSkgPyBldmVudC53aGVlbERlbHRhIC8gMTIwIDogLShldmVudC5kZXRhaWwgfHwgMCkgLyAzOwoJCX0KCQl2YXIgcmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpLAoJCQlyZWxhdGVkID0gbnVsbDsKCQlpZiAodHlwZS50ZXN0KC9vdmVyfG91dC8pKXsKCQkJcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgZXZlbnRbKHR5cGUgPT0gJ21vdXNlb3ZlcicgPyAnZnJvbScgOiAndG8nKSArICdFbGVtZW50J107CgkJCXZhciB0ZXN0UmVsYXRlZCA9IGZ1bmN0aW9uKCl7CgkJCQl3aGlsZSAocmVsYXRlZCAmJiByZWxhdGVkLm5vZGVUeXBlID09IDMpIHJlbGF0ZWQgPSByZWxhdGVkLnBhcmVudE5vZGU7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfTsKCQkJdmFyIGhhc1JlbGF0ZWQgPSAoQnJvd3Nlci5maXJlZm94MikgPyB0ZXN0UmVsYXRlZC5hdHRlbXB0KCkgOiB0ZXN0UmVsYXRlZCgpOwoJCQlyZWxhdGVkID0gKGhhc1JlbGF0ZWQpID8gcmVsYXRlZCA6IG51bGw7CgkJfQoJfSBlbHNlIGlmICh0eXBlLnRlc3QoL2dlc3R1cmV8dG91Y2gvaSkpewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQlwYWdlID0ge3g6IHRvdWNoLnBhZ2VYLCB5OiB0b3VjaC5wYWdlWX07CgkJCWNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJcmV0dXJuIE9iamVjdC5hcHBlbmQodGhpcywgewoJCWV2ZW50OiBldmVudCwKCQl0eXBlOiB0eXBlLAoKCQlwYWdlOiBwYWdlLAoJCWNsaWVudDogY2xpZW50LAoJCXJpZ2h0Q2xpY2s6IHJpZ2h0Q2xpY2ssCgoJCXdoZWVsOiB3aGVlbCwKCgkJcmVsYXRlZFRhcmdldDogZG9jdW1lbnQuaWQocmVsYXRlZCksCgkJdGFyZ2V0OiBkb2N1bWVudC5pZCh0YXJnZXQpLAoKCQljb2RlOiBjb2RlLAoJCWtleToga2V5LAoKCQlzaGlmdDogZXZlbnQuc2hpZnRLZXksCgkJY29udHJvbDogZXZlbnQuY3RybEtleSwKCQlhbHQ6IGV2ZW50LmFsdEtleSwKCQltZXRhOiBldmVudC5tZXRhS2V5Cgl9KTsKfSk7CgpFdmVudC5LZXlzID0gewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfTsKCi8vPDEuMmNvbXBhdD4KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8vPC8xLjJjb21wYXQ+CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgQ2xhc3MgRnVuY3Rpb24gZm9yIGVhc2lseSBjcmVhdGluZywgZXh0ZW5kaW5nLCBhbmQgaW1wbGVtZW50aW5nIHJldXNhYmxlIENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlcl0KCnByb3ZpZGVzOiBDbGFzcwoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBDbGFzcyA9IHRoaXMuQ2xhc3MgPSBuZXcgVHlwZSgnQ2xhc3MnLCBmdW5jdGlvbihwYXJhbXMpewoJaWYgKGluc3RhbmNlT2YocGFyYW1zLCBGdW5jdGlvbikpIHBhcmFtcyA9IHtpbml0aWFsaXplOiBwYXJhbXN9OwoKCXZhciBuZXdDbGFzcyA9IGZ1bmN0aW9uKCl7CgkJcmVzZXQodGhpcyk7CgkJaWYgKG5ld0NsYXNzLiRwcm90b3R5cGluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gbnVsbDsKCQl2YXIgdmFsdWUgPSAodGhpcy5pbml0aWFsaXplKSA/IHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpczsKCQl0aGlzLiRjYWxsZXIgPSB0aGlzLmNhbGxlciA9IG51bGw7CgkJcmV0dXJuIHZhbHVlOwoJfS5leHRlbmQodGhpcykuaW1wbGVtZW50KHBhcmFtcyk7CgoJbmV3Q2xhc3MuJGNvbnN0cnVjdG9yID0gQ2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUucGFyZW50ID0gcGFyZW50OwoKCXJldHVybiBuZXdDbGFzczsKfSk7Cgp2YXIgcGFyZW50ID0gZnVuY3Rpb24oKXsKCWlmICghdGhpcy4kY2FsbGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgInBhcmVudCIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCXZhciBuYW1lID0gdGhpcy4kY2FsbGVyLiRuYW1lLAoJCXBhcmVudCA9IHRoaXMuJGNhbGxlci4kb3duZXIucGFyZW50LAoJCXByZXZpb3VzID0gKHBhcmVudCkgPyBwYXJlbnQucHJvdG90eXBlW25hbWVdIDogbnVsbDsKCWlmICghcHJldmlvdXMpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIG5hbWUgKyAnIiBoYXMgbm8gcGFyZW50LicpOwoJcmV0dXJuIHByZXZpb3VzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07Cgp2YXIgcmVzZXQgPSBmdW5jdGlvbihvYmplY3QpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJc3dpdGNoICh0eXBlT2YodmFsdWUpKXsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCXZhciBGID0gZnVuY3Rpb24oKXt9OwoJCQkJRi5wcm90b3R5cGUgPSB2YWx1ZTsKCQkJCW9iamVjdFtrZXldID0gcmVzZXQobmV3IEYpOwoJCQlicmVhazsKCQkJY2FzZSAnYXJyYXknOiBvYmplY3Rba2V5XSA9IHZhbHVlLmNsb25lKCk7IGJyZWFrOwoJCX0KCX0KCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgd3JhcCA9IGZ1bmN0aW9uKHNlbGYsIGtleSwgbWV0aG9kKXsKCWlmIChtZXRob2QuJG9yaWdpbikgbWV0aG9kID0gbWV0aG9kLiRvcmlnaW47Cgl2YXIgd3JhcHBlciA9IGZ1bmN0aW9uKCl7CgkJaWYgKG1ldGhvZC4kcHJvdGVjdGVkICYmIHRoaXMuJGNhbGxlciA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBrZXkgKyAnIiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJCXZhciBjYWxsZXIgPSB0aGlzLmNhbGxlciwgY3VycmVudCA9IHRoaXMuJGNhbGxlcjsKCQl0aGlzLmNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuJGNhbGxlciA9IHdyYXBwZXI7CgkJdmFyIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCXRoaXMuJGNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuY2FsbGVyID0gY2FsbGVyOwoJCXJldHVybiByZXN1bHQ7Cgl9LmV4dGVuZCh7JG93bmVyOiBzZWxmLCAkb3JpZ2luOiBtZXRob2QsICRuYW1lOiBrZXl9KTsKCXJldHVybiB3cmFwcGVyOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHJldGFpbil7CglpZiAoQ2xhc3MuTXV0YXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSl7CgkJdmFsdWUgPSBDbGFzcy5NdXRhdG9yc1trZXldLmNhbGwodGhpcywgdmFsdWUpOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpczsKCX0KCglpZiAodHlwZU9mKHZhbHVlKSA9PSAnZnVuY3Rpb24nKXsKCQlpZiAodmFsdWUuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcm90b3R5cGVba2V5XSA9IChyZXRhaW4pID8gdmFsdWUgOiB3cmFwKHRoaXMsIGtleSwgdmFsdWUpOwoJfSBlbHNlIHsKCQlPYmplY3QubWVyZ2UodGhpcy5wcm90b3R5cGUsIGtleSwgdmFsdWUpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKdmFyIGdldEluc3RhbmNlID0gZnVuY3Rpb24oa2xhc3MpewoJa2xhc3MuJHByb3RvdHlwaW5nID0gdHJ1ZTsKCXZhciBwcm90byA9IG5ldyBrbGFzczsKCWRlbGV0ZSBrbGFzcy4kcHJvdG90eXBpbmc7CglyZXR1cm4gcHJvdG87Cn07CgpDbGFzcy5pbXBsZW1lbnQoJ2ltcGxlbWVudCcsIGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpKTsKCkNsYXNzLk11dGF0b3JzID0gewoKCUV4dGVuZHM6IGZ1bmN0aW9uKHBhcmVudCl7CgkJdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CgkJdGhpcy5wcm90b3R5cGUgPSBnZXRJbnN0YW5jZShwYXJlbnQpOwoJfSwKCglJbXBsZW1lbnRzOiBmdW5jdGlvbihpdGVtcyl7CgkJQXJyYXkuZnJvbShpdGVtcykuZWFjaChmdW5jdGlvbihpdGVtKXsKCQkJdmFyIGluc3RhbmNlID0gbmV3IGl0ZW07CgkJCWZvciAodmFyIGtleSBpbiBpbnN0YW5jZSkgaW1wbGVtZW50LmNhbGwodGhpcywga2V5LCBpbnN0YW5jZVtrZXldLCB0cnVlKTsKCQl9LCB0aGlzKTsKCX0KfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAoIXRoaXMuYWRkRXZlbnQpIHJldHVybiB0aGlzOwoJCWZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLlBhcnNlcgpkZXNjcmlwdGlvbjogU3RhbmRhbG9uZSBDU1MzIFNlbGVjdG9yIHBhcnNlcgpwcm92aWRlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7U2xpY2s6IHRydWUsIGV4cHJlc3Npb25zOiBbXSwgcmF3OiBleHByZXNzaW9uLCByZXZlcnNlOiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7Cgl9fTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCAiXFwkJiIpOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXw6Kyg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEyXSopXFwxMil8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZQoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge307CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8IChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnKTsKfTsKCmxvY2FsLnNldERvY3VtZW50ID0gZnVuY3Rpb24oZG9jdW1lbnQpewoKCS8vIGNvbnZlcnQgZWxlbWVudHMgLyB3aW5kb3cgYXJndW1lbnRzIHRvIGRvY3VtZW50LiBpZiBkb2N1bWVudCBjYW5ub3QgYmUgZXh0cmFwb2xhdGVkLCB0aGUgZnVuY3Rpb24gcmV0dXJucy4KCglpZiAoZG9jdW1lbnQubm9kZVR5cGUgPT09IDkpOyAvLyBkb2N1bWVudAoJZWxzZSBpZiAoZG9jdW1lbnQub3duZXJEb2N1bWVudCkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7Cgl2YXIgcm9vdCA9IHRoaXMucm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgl0aGlzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCgl0aGlzLmJyb2tlblN0YXJHRUJUTgoJPSB0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IHRoaXMuaWRHZXRzTmFtZQoJPSB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJPSB0aGlzLmJyb2tlbkdFQkNOCgk9IHRoaXMuYnJva2VuQ2hlY2tlZFFTQQoJPSB0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBCgk9IHRoaXMuaXNIVE1MRG9jdW1lbnQKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lOwoKCXZhciBzZWxlY3RlZCwgaWQ7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCXJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQlpZCA9ICdzbGlja19nZXRieWlkX3Rlc3QnOwoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQl0aGlzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMCk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJdGhpcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQlpZiAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCkgdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQl0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBID0gKHNlbGVjdGVkICYmIHNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQlpZCA9ICdzbGlja19pZF9nZXRzX25hbWUnOwoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJytpZCsnIj48L2E+PGIgaWQ9IicraWQrJyI+PC9iPic7CgkJCXRoaXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJNaVhlZENhU2UiPjwvYT4nOwoJCQl0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYZWRDYVNlJykubGVuZ3RoOwoJCX0gY2F0Y2goZSl7fTsKCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCX0gY2F0Y2goZSl7fTsKCgkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJfSBjYXRjaChlKXt9OwoKCQl0aGlzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQkKCQkvLyBXZWJraXQgZG9udCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9ucyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQl0aGlzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJfSBjYXRjaChlKXt9OwoJCQoJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iIj48L2E+JzsKCQkJdGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQl9IGNhdGNoKGUpe307CgkJCgl9CgoJcm9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IG51bGw7CgoJLy8gaGFzQXR0cmlidXRlCgoJdGhpcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXRoaXMuY29udGFpbnMgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSkgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dC5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJdGhpcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJdGhpcy5nZXRVSUQgPSAodGhpcy5pc0hUTUxEb2N1bWVudCkgPyB0aGlzLmdldFVJREhUTUwgOiB0aGlzLmdldFVJRFhNTDsKCn07CgovLyBNYWluIE1ldGhvZAoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJLy8gY29udGV4dCBjaGVja3MKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsgLy8gTm8gY29udGV4dAoJaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7IC8vIFJlamVjdCBtaXNjIGp1bmsgaW5wdXQKCgkvLyBzZXR1cAoKCXZhciBwYXJzZWQsIGk7CgoJdmFyIHVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSkgdGhpcy5zZXREb2N1bWVudChjb250ZXh0KTsKCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCS8vIHNob3VsZCByZW1vdmUgZHVwbGljYXRlcyBpZiBhcHBlbmQgYWxyZWFkeSBoYXMgaXRlbXMKCXZhciBzaG91bGRVbmlxdWVzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKHNob3VsZFVuaXF1ZXMpIGZvciAoaSA9IGZvdW5kLmxlbmd0aDsgaS0tOykgdGhpcy51bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvLyBPdmVycmlkZXMKCgkJZm9yIChpID0gdGhpcy5vdmVycmlkZXMubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG92ZXJyaWRlID0gdGhpcy5vdmVycmlkZXNbaV07CgkJCWlmIChvdmVycmlkZS5yZWdleHAudGVzdChleHByZXNzaW9uKSl7CgkJCQl2YXIgcmVzdWx0ID0gb3ZlcnJpZGUubWV0aG9kLmNhbGwoY29udGV4dCwgZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KTsKCQkJCWlmIChyZXN1bHQgPT09IGZhbHNlKSBjb250aW51ZTsKCQkJCWlmIChyZXN1bHQgPT09IHRydWUpIHJldHVybiBmb3VuZDsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQl9CgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghc2hvdWxkVW5pcXVlcyAmJiAoZmlyc3QgfHwgKHBhcnNlZC5sZW5ndGggPT0gMSAmJiBwYXJzZWQuZXhwcmVzc2lvbnNbMF0ubGVuZ3RoID09IDEpKSkgPyB0aGlzLnB1c2hBcnJheSA6IHRoaXMucHVzaFVJRDsKCglpZiAoZm91bmQgPT0gbnVsbCkgZm91bmQgPSBbXTsKCgkvLyBkZWZhdWx0IGVuZ2luZQoKCXZhciBqLCBtLCBuOwoJdmFyIGNvbWJpbmF0b3IsIHRhZywgaWQsIGNsYXNzTGlzdCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvczsKCXZhciBjdXJyZW50SXRlbXMsIGN1cnJlbnRFeHByZXNzaW9uLCBjdXJyZW50Qml0LCBsYXN0Qml0LCBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9uczsKCglzZWFyY2g6IGZvciAoaSA9IDA7IChjdXJyZW50RXhwcmVzc2lvbiA9IGV4cHJlc3Npb25zW2ldKTsgaSsrKSBmb3IgKGogPSAwOyAoY3VycmVudEJpdCA9IGN1cnJlbnRFeHByZXNzaW9uW2pdKTsgaisrKXsKCgkJY29tYmluYXRvciA9ICdjb21iaW5hdG9yOicgKyBjdXJyZW50Qml0LmNvbWJpbmF0b3I7CgkJaWYgKCF0aGlzW2NvbWJpbmF0b3JdKSBjb250aW51ZSBzZWFyY2g7CgoJCXRhZyAgICAgICAgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IGN1cnJlbnRCaXQudGFnIDogY3VycmVudEJpdC50YWcudG9VcHBlckNhc2UoKTsKCQlpZCAgICAgICAgID0gY3VycmVudEJpdC5pZDsKCQljbGFzc0xpc3QgID0gY3VycmVudEJpdC5jbGFzc0xpc3Q7CgkJY2xhc3NlcyAgICA9IGN1cnJlbnRCaXQuY2xhc3NlczsKCQlhdHRyaWJ1dGVzID0gY3VycmVudEJpdC5hdHRyaWJ1dGVzOwoJCXBzZXVkb3MgICAgPSBjdXJyZW50Qml0LnBzZXVkb3M7CgkJbGFzdEJpdCAgICA9IChqID09PSAoY3VycmVudEV4cHJlc3Npb24ubGVuZ3RoIC0gMSkpOwoKCQl0aGlzLmJpdFVuaXF1ZXMgPSB7fTsKCgkJaWYgKGxhc3RCaXQpewoJCQl0aGlzLnVuaXF1ZXMgPSB1bmlxdWVzOwoJCQl0aGlzLmZvdW5kID0gZm91bmQ7CgkJfSBlbHNlIHsKCQkJdGhpcy51bmlxdWVzID0ge307CgkJCXRoaXMuZm91bmQgPSBbXTsKCQl9CgoJCWlmIChqID09PSAwKXsKCQkJdGhpc1tjb21iaW5hdG9yXShjb250ZXh0LCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCAmJiBmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQl9IGVsc2UgewoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCkgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspewoJCQkJdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCQlpZiAoZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJCX0gZWxzZSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKykgdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJfQoKCQljdXJyZW50SXRlbXMgPSB0aGlzLmZvdW5kOwoJfQoKCWlmIChzaG91bGRVbmlxdWVzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljazp1bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPT0gbm9kZU5hbWUpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0gZWxzZSB7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7Cgl2YXIgcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShzZWxlY3Rvcik7CglpZiAoIXBhcnNlZCkgcmV0dXJuIHRydWU7CgoJLy8gc2ltcGxlIChzaW5nbGUpIHNlbGVjdG9ycwoJaWYocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSl7CgkJdmFyIGV4cCA9IHBhcnNlZC5leHByZXNzaW9uc1swXVswXTsKCQlyZXR1cm4gdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKTsKCX0KCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpOwoJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBub2Rlc1tpKytdOyl7CgkJaWYgKGl0ZW0gPT09IG5vZGUpIHJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKbG9jYWwubWF0Y2hQc2V1ZG8gPSBmdW5jdGlvbihub2RlLCBuYW1lLCBhcmd1bWVudCl7Cgl2YXIgcHNldWRvTmFtZSA9ICdwc2V1ZG86JyArIG5hbWU7CglpZiAodGhpc1twc2V1ZG9OYW1lXSkgcmV0dXJuIHRoaXNbcHNldWRvTmFtZV0obm9kZSwgYXJndW1lbnQpOwoJdmFyIGF0dHJpYnV0ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwoJcmV0dXJuIChhcmd1bWVudCkgPyBhcmd1bWVudCA9PSBhdHRyaWJ1dGUgOiAhIWF0dHJpYnV0ZTsKfTsKCmxvY2FsLm1hdGNoU2VsZWN0b3IgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0YWcpewoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGUubm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZS5ub2RlTmFtZSAhPSB0YWcpIHJldHVybiBmYWxzZTsKCQl9Cgl9CgoJaWYgKGlkICYmIG5vZGUuZ2V0QXR0cmlidXRlKCdpZCcpICE9IGlkKSByZXR1cm4gZmFsc2U7CgoJdmFyIGksIHBhcnQsIGNsczsKCWlmIChjbGFzc2VzKSBmb3IgKGkgPSBjbGFzc2VzLmxlbmd0aDsgaS0tOyl7CgkJY2xzID0gKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgaWYgKGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgPT0gaWQpewoJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJYnJlYWs7CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT09IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlLmRpc2FibGVkID09PSBmYWxzZSk7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZS5kaXNhYmxlZCA9PT0gdHJ1ZSk7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gdGhpcykgPyB0aGlzLmNsYXNzTmFtZSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdodG1sRm9yJyBpbiB0aGlzKSA/IHRoaXMuaHRtbEZvciA6IHRoaXMuZ2V0QXR0cmlidXRlKCdmb3InKTsKCX0sCgoJJ2hyZWYnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2hyZWYnIGluIHRoaXMpID8gdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJyk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnN0eWxlKSA/IHRoaXMuc3R5bGUuY3NzVGV4dCA6IHRoaXMuZ2V0QXR0cmlidXRlKCdzdHlsZScpOwoJfQoKfTsKCmxvY2FsLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJLy8gRklYTUU6IGNoZWNrIGlmIGdldEF0dHJpYnV0ZSgpIHdpbGwgZ2V0IGlucHV0IGVsZW1lbnRzIG9uIGEgZm9ybSBvbiB0aGlzIGJyb3dzZXIKCS8vIGdldEF0dHJpYnV0ZSBpcyBmYXN0ZXIgdGhhbiBnZXRBdHRyaWJ1dGVOb2RlKCkubm9kZVZhbHVlCgl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJdmFyIGF0dHJpYnV0ZU5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CglyZXR1cm4gYXR0cmlidXRlTm9kZSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKfTsKCi8vIG92ZXJyaWRlcwoKbG9jYWwub3ZlcnJpZGVzID0gW107Cgpsb2NhbC5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgbWV0aG9kKXsKCXRoaXMub3ZlcnJpZGVzLnB1c2goe3JlZ2V4cDogcmVnZXhwLCBtZXRob2Q6IG1ldGhvZH0pOwp9OwoKLyo8b3ZlcnJpZGVzPiovCgovKjxxdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKdmFyIHJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuKlsqJF5dPSg/OlsiJ117Mn0pP1xdLzsKCmxvY2FsLm92ZXJyaWRlKC8uLywgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KXsgLy9xdWVyeVNlbGVjdG9yQWxsIG92ZXJyaWRlCgoJaWYgKCF0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwgfHwgdGhpcy5ub2RlVHlwZSAhPSA5IHx8ICFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCBsb2NhbC5icm9rZW5NaXhlZENhc2VRU0EgfHwKCShsb2NhbC5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJKGxvY2FsLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkgfHwgU2xpY2suZGlzYWJsZVFTQSkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2Rlcywgbm9kZTsKCXRyeSB7CgkJaWYgKGZpcnN0KSByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKGV4cHJlc3Npb24pIHx8IG51bGw7CgkJZWxzZSBub2RlcyA9IHRoaXMucXVlcnlTZWxlY3RvckFsbChleHByZXNzaW9uKTsKCX0gY2F0Y2goZXJyb3IpewoJCXJldHVybiBmYWxzZTsKCX0KCgl2YXIgaSwgaGFzT3RoZXJzID0gISEoZm91bmQubGVuZ3RoKTsKCglpZiAobG9jYWwuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKG5vZGUubm9kZU5hbWUgPiAnQCcgJiYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7Cgl9CgoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CgoJcmV0dXJuIHRydWU7Cgp9KTsKCi8qPC9xdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKLyo8dGFnLW92ZXJyaWRlPiovCgpsb2NhbC5vdmVycmlkZSgvXltcdy1dKyR8XlwqJC8sIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGZvdW5kLCBmaXJzdCl7IC8vIHRhZyBvdmVycmlkZQoJdmFyIHRhZyA9IGV4cHJlc3Npb247CglpZiAodGFnID09ICcqJyAmJiBsb2NhbC5icm9rZW5TdGFyR0VCVE4pIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgoJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCXZhciBpLCBub2RlLCBoYXNPdGhlcnMgPSAhIShmb3VuZC5sZW5ndGgpOwoKCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlEKG5vZGUpXSkgZm91bmQucHVzaChub2RlKTsKCX0KCglpZiAoaGFzT3RoZXJzKSBsb2NhbC5zb3J0KGZvdW5kKTsKCglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvdGFnLW92ZXJyaWRlPiovCgovKjxjbGFzcy1vdmVycmlkZT4qLwoKbG9jYWwub3ZlcnJpZGUoL15cLltcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBjbGFzcyBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCAoIXRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiB0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwpKSByZXR1cm4gZmFsc2U7CgoJdmFyIG5vZGVzLCBub2RlLCBpLCBoYXNPdGhlcnMgPSAhIShmb3VuZCAmJiBmb3VuZC5sZW5ndGgpLCBjbGFzc05hbWUgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKTsKCWlmICh0aGlzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIWxvY2FsLmJyb2tlbkdFQkNOKXsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwoJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfSBlbHNlIHsKCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArJyhcXHN8JCknKTsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQljbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKCQkJaWYgKCFjbGFzc05hbWUgfHwgIW1hdGNoQ2xhc3MudGVzdChjbGFzc05hbWUpKSBjb250aW51ZTsKCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfQoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiB0cnVlOwp9KTsKCi8qPC9jbGFzcy1vdmVycmlkZT4qLwoKLyo8aWQtb3ZlcnJpZGU+Ki8KCmxvY2FsLm92ZXJyaWRlKC9eI1tcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBJRCBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCB0aGlzLm5vZGVUeXBlICE9IDkpIHJldHVybiBmYWxzZTsKCgl2YXIgaWQgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKSwgZWwgPSB0aGlzLmdldEVsZW1lbnRCeUlkKGlkKTsKCWlmICghZWwpIHJldHVybiBmb3VuZDsKCWlmIChsb2NhbC5pZEdldHNOYW1lICYmIGVsLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSByZXR1cm4gZmFsc2U7CglpZiAoZmlyc3QpIHJldHVybiBlbCB8fCBudWxsOwoJdmFyIGhhc090aGVycyA9ICEhKGZvdW5kLmxlbmd0aCk7CglpZiAoIWhhc090aGVycyB8fCAhbG9jYWwudW5pcXVlc1tsb2NhbC5nZXRVSURIVE1MKGVsKV0pIGZvdW5kLnB1c2goZWwpOwoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvaWQtb3ZlcnJpZGU+Ki8KCi8qPC9vdmVycmlkZXM+Ki8KCmlmICh0eXBlb2YgZG9jdW1lbnQgIT0gJ3VuZGVmaW5lZCcpIGxvY2FsLnNldERvY3VtZW50KGRvY3VtZW50KTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMC45ZGV2JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCXJldHVybiBsb2NhbC5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWlmICh0eXBlb2Ygc2VsZWN0b3IgIT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoIXRhZy50ZXN0KC9eW1x3LV0rJC8pKXsKCQl2YXIgcGFyc2VkID0gU2xpY2sucGFyc2UodGFnKS5leHByZXNzaW9uc1swXVswXTsKCQl0YWcgPSAocGFyc2VkLnRhZyA9PSAnKicpID8gJ2RpdicgOiBwYXJzZWQudGFnOwoJCWlmIChwYXJzZWQuaWQgJiYgcHJvcHMuaWQgPT0gbnVsbCkgcHJvcHMuaWQgPSBwYXJzZWQuaWQ7CgoJCXZhciBhdHRyaWJ1dGVzID0gcGFyc2VkLmF0dHJpYnV0ZXM7CgkJaWYgKGF0dHJpYnV0ZXMpIGZvciAodmFyIGkgPSAwLCBsID0gYXR0cmlidXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChhdHRyLnZhbHVlICE9IG51bGwgJiYgYXR0ci5vcGVyYXRvciA9PSAnPScgJiYgcHJvcHNbYXR0ci5rZXldID09IG51bGwpCgkJCQlwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCX0KCgkJaWYgKHBhcnNlZC5jbGFzc0xpc3QgJiYgcHJvcHNbJ2NsYXNzJ10gPT0gbnVsbCkgcHJvcHNbJ2NsYXNzJ10gPSBwYXJzZWQuY2xhc3NMaXN0LmpvaW4oJyAnKTsKCX0KCglyZXR1cm4gZG9jdW1lbnQubmV3RWxlbWVudCh0YWcsIHByb3BzKTsKfTsKCmlmIChCcm93c2VyLkVsZW1lbnQpIEVsZW1lbnQucHJvdG90eXBlID0gQnJvd3Nlci5FbGVtZW50LnByb3RvdHlwZTsKCm5ldyBUeXBlKCdFbGVtZW50JywgRWxlbWVudCkubWlycm9yKGZ1bmN0aW9uKG5hbWUpewoJaWYgKEFycmF5LnByb3RvdHlwZVtuYW1lXSkgcmV0dXJuOwoKCXZhciBvYmogPSB7fTsKCW9ialtuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdHMgPSBbXSwgYXJncyA9IGFyZ3VtZW50cywgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IHRoaXNbaV0sIHJlc3VsdCA9IHJlc3VsdHNbaV0gPSBlbGVtZW50W25hbWVdLmFwcGx5KGVsZW1lbnQsIGFyZ3MpOwoJCQllbGVtZW50cyA9IChlbGVtZW50cyAmJiB0eXBlT2YocmVzdWx0KSA9PSAnZWxlbWVudCcpOwoJCX0KCQlyZXR1cm4gKGVsZW1lbnRzKSA/IG5ldyBFbGVtZW50cyhyZXN1bHRzKSA6IHJlc3VsdHM7Cgl9OwoKCUVsZW1lbnRzLmltcGxlbWVudChvYmopOwp9KTsKCmlmICghQnJvd3Nlci5FbGVtZW50KXsKCUVsZW1lbnQucGFyZW50ID0gT2JqZWN0OwoKCUVsZW1lbnQuUHJvdG90eXBlID0geyckZmFtaWx5JzogRnVuY3Rpb24uZnJvbSgnZWxlbWVudCcpLmhpZGUoKX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSBuZXcgSGFzaDsKCi8vPC8xLjJjb21wYXQ+Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCQoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL15vYmplY3R8ZW1iZWQkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgooZnVuY3Rpb24oc2VhcmNoLCBmaW5kLCBtYXRjaCl7CgoJdGhpcy5TZWxlY3RvcnMgPSB7fTsKCXZhciBwc2V1ZG9zID0gdGhpcy5TZWxlY3RvcnMuUHNldWRvID0gbmV3IEhhc2goKTsKCgl2YXIgYWRkU2xpY2tQc2V1ZG9zID0gZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBuYW1lIGluIHBzZXVkb3MpIGlmIChwc2V1ZG9zLmhhc093blByb3BlcnR5KG5hbWUpKXsKCQkJU2xpY2suZGVmaW5lUHNldWRvKG5hbWUsIHBzZXVkb3NbbmFtZV0pOwoJCQlkZWxldGUgcHNldWRvc1tuYW1lXTsKCQl9Cgl9OwoKCVNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIHNlYXJjaC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cgl9OwoKCVNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gZmluZC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24pOwoJfTsKCglTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gbWF0Y2guY2FsbCh0aGlzLCBub2RlLCBzZWxlY3Rvcik7Cgl9OwoKfSkoU2xpY2suc2VhcmNoLCBTbGljay5maW5kLCBTbGljay5tYXRjaCk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJdmFyIGVsZW1lbnRzID0gbmV3IEVsZW1lbnRzOwoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIGVsZW1lbnRzKTsKCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmdzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGl0ZW0gPSBhcmdzW2ldOwoJCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goaXRlbSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgaXRlbSwgZWxlbWVudHMpOwoJCX0KCX0KCXJldHVybiBlbGVtZW50czsKfSk7CgovLzwvMS4yY29tcGF0PgoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCWlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIG5ldyBFbGVtZW50cyk7CgkJZWxzZSBpZiAoVHlwZS5pc0VudW1lcmFibGUoc2VsZWN0b3IpKSByZXR1cm4gbmV3IEVsZW1lbnRzKHNlbGVjdG9yKTsKCX0KCXJldHVybiBuZXcgRWxlbWVudHMoYXJndW1lbnRzKTsKfSk7CgooZnVuY3Rpb24oKXsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9Owp2YXIgcHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLmlubmVyVGV4dCA9PSBudWxsKSA/ICd0ZXh0Q29udGVudCcgOiAnaW5uZXJUZXh0JzsKCX0pKCkKfTsKdmFyIHJlYWRPbmx5ID0gWyd0eXBlJ107CnZhciBleHBhbmRvcyA9IFsndmFsdWUnLCAnZGVmYXVsdFZhbHVlJ107CnZhciB1cmlBdHRycyA9IC9eKD86aHJlZnxzcmN8dXNlbWFwKSQvaTsKCmJvb2xzID0gYm9vbHMuYXNzb2NpYXRlKGJvb2xzKTsKY2FtZWxzID0gY2FtZWxzLmFzc29jaWF0ZShjYW1lbHMubWFwKFN0cmluZy50b0xvd2VyQ2FzZSkpOwpyZWFkT25seSA9IHJlYWRPbmx5LmFzc29jaWF0ZShyZWFkT25seSk7CgpPYmplY3QuYXBwZW5kKGF0dHJpYnV0ZXMsIGV4cGFuZG9zLmFzc29jaWF0ZShleHBhbmRvcykpOwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpOwoJCXZhciBjbGVhbiA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQpewoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCWlmIChCcm93c2VyLmllKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQl2YXIgcHJvcCA9IHByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfTsKCgkJdmFyIGk7CgkJaWYgKGNvbnRlbnRzKXsKCQkJdmFyIGNlID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSwgdGUgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCWZvciAoaSA9IGNlLmxlbmd0aDsgaS0tOykgY2xlYW4oY2VbaV0sIHRlW2ldKTsKCQl9CgoJCWNsZWFuKGNsb25lLCB0aGlzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXZhciB0cyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLAoJCQkJY3MgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksCgkJCQl0bCA9IHRzLmxlbmd0aCwgY2wgPSBjcy5sZW5ndGg7CgkJCWZvciAoaSA9IDA7IGkgPCB0bCAmJiBpIDwgY2w7IGkrKykKCQkJCWNzW2ldLm91dGVySFRNTCA9IHRzW2ldLm91dGVySFRNTDsKCQl9CgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0sCgoJZGVzdHJveTogZnVuY3Rpb24oKXsKCQl2YXIgY2hpbGRyZW4gPSBjbGVhbih0aGlzKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCUFycmF5LmVhY2goY2hpbGRyZW4sIGNsZWFuKTsKCQlFbGVtZW50LmRpc3Bvc2UodGhpcyk7CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUFycmF5LmZyb20odGhpcy5jaGlsZE5vZGVzKS5lYWNoKEVsZW1lbnQuZGlzcG9zZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRpc3Bvc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnBhcmVudE5vZGUpID8gdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpIDogdGhpczsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkW3RoaXMudWlkXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKSwgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldOwoJCWlmIChkZmx0ICE9IG51bGwgJiYgcHJvcCA9PSBudWxsKSBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV0gPSBkZmx0OwoJCXJldHVybiBwcm9wICE9IG51bGwgPyBwcm9wIDogbnVsbDsKCX0sCgoJc3RvcmU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQodGhpcy51aWQpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKTsKdmFyIHJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldE9wYWNpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCWlmIChoYXNPcGFjaXR5KXsKCQllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwoJfSBlbHNlIHsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgPT0gMSkgPyAnJyA6ICdhbHBoYShvcGFjaXR5PScgKyBvcGFjaXR5ICogMTAwICsgJyknOwoJCXZhciBmaWx0ZXIgPSBlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpIHx8ICcnOwoJCWVsZW1lbnQuc3R5bGUuZmlsdGVyID0gZmlsdGVyLnRlc3QocmVBbHBoYSkgPyBmaWx0ZXIucmVwbGFjZShyZUFscGhhLCBvcGFjaXR5KSA6IGZpbHRlciArIG9wYWNpdHk7Cgl9Cn07CgpFbGVtZW50LlByb3BlcnRpZXMub3BhY2l0eSA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wYWNpdHkpewoJCXZhciB2aXNpYmlsaXR5ID0gdGhpcy5zdHlsZS52aXNpYmlsaXR5OwoJCWlmIChvcGFjaXR5ID09IDAgJiYgdmlzaWJpbGl0eSAhPSAnaGlkZGVuJykgdGhpcy5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJZWxzZSBpZiAob3BhY2l0eSAhPSAwICYmIHZpc2liaWxpdHkgIT0gJ3Zpc2libGUnKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCXNldE9wYWNpdHkodGhpcywgb3BhY2l0eSk7Cgl9LAoKCWdldDogKGhhc09wYWNpdHkpID8gZnVuY3Rpb24oKXsKCQl2YXIgb3BhY2l0eSA9IHRoaXMuc3R5bGUub3BhY2l0eSB8fCB0aGlzLmdldENvbXB1dGVkU3R5bGUoJ29wYWNpdHknKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHk7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgb3BhY2l0eSwgZmlsdGVyID0gKHRoaXMuc3R5bGUuZmlsdGVyIHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykpOwoJCWlmIChmaWx0ZXIpIG9wYWNpdHkgPSBmaWx0ZXIubWF0Y2gocmVBbHBoYSk7CgkJcmV0dXJuIChvcGFjaXR5ID09IG51bGwgfHwgZmlsdGVyID09IG51bGwpID8gMSA6IChvcGFjaXR5WzFdIC8gMTAwKTsKCX0KCn07Cgp2YXIgZmxvYXROYW1lID0gKGh0bWwuc3R5bGUuY3NzRmxvYXQgPT0gbnVsbCkgPyAnc3R5bGVGbG9hdCcgOiAnY3NzRmxvYXQnOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldENvbXB1dGVkU3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQlpZiAodGhpcy5jdXJyZW50U3R5bGUpIHJldHVybiB0aGlzLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eS5jYW1lbENhc2UoKV07CgkJdmFyIGRlZmF1bHRWaWV3ID0gRWxlbWVudC5nZXREb2N1bWVudCh0aGlzKS5kZWZhdWx0VmlldywKCQkJY29tcHV0ZWQgPSBkZWZhdWx0VmlldyA/IGRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUodGhpcywgbnVsbCkgOiBudWxsOwoJCXJldHVybiAoY29tcHV0ZWQpID8gY29tcHV0ZWQuZ2V0UHJvcGVydHlWYWx1ZSgocHJvcGVydHkgPT0gZmxvYXROYW1lKSA/ICdmbG9hdCcgOiBwcm9wZXJ0eS5oeXBoZW5hdGUoKSkgOiBudWxsOwoJfSwKCglzZXRPcGFjaXR5OiBmdW5jdGlvbih2YWx1ZSl7CgkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldE9wYWNpdHk6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0KCdvcGFjaXR5Jyk7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXN3aXRjaCAocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuc2V0KCdvcGFjaXR5JywgcGFyc2VGbG9hdCh2YWx1ZSkpOwoJCQljYXNlICdmbG9hdCc6IHByb3BlcnR5ID0gZmxvYXROYW1lOwoJCX0KCQlwcm9wZXJ0eSA9IHByb3BlcnR5LmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXN3aXRjaCAocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuZ2V0KCdvcGFjaXR5Jyk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5vcGVyYSB8fCAoQnJvd3Nlci5pZSAmJiBpc05hTihwYXJzZUZsb2F0KHJlc3VsdCkpKSl7CgkJCWlmIChwcm9wZXJ0eS50ZXN0KC9eKGhlaWdodHx3aWR0aCkkLykpewoJCQkJdmFyIHZhbHVlcyA9IChwcm9wZXJ0eSA9PSAnd2lkdGgnKSA/IFsnbGVmdCcsICdyaWdodCddIDogWyd0b3AnLCAnYm90dG9tJ10sIHNpemUgPSAwOwoJCQkJdmFsdWVzLmVhY2goZnVuY3Rpb24odmFsdWUpewoJCQkJCXNpemUgKz0gdGhpcy5nZXRTdHlsZSgnYm9yZGVyLScgKyB2YWx1ZSArICctd2lkdGgnKS50b0ludCgpICsgdGhpcy5nZXRTdHlsZSgncGFkZGluZy0nICsgdmFsdWUpLnRvSW50KCk7CgkJCQl9LCB0aGlzKTsKCQkJCXJldHVybiB0aGlzWydvZmZzZXQnICsgcHJvcGVydHkuY2FwaXRhbGl6ZSgpXSAtIHNpemUgKyAncHgnOwoJCQl9CgkJCWlmIChCcm93c2VyLm9wZXJhICYmIFN0cmluZyhyZXN1bHQpLmluZGV4T2YoJ3B4JykgIT0gLTEpIHJldHVybiByZXN1bHQ7CgkJCWlmIChwcm9wZXJ0eS50ZXN0KC8oYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nKS8pKSByZXR1cm4gJzBweCc7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCXNldFN0eWxlczogZnVuY3Rpb24oc3R5bGVzKXsKCQlmb3IgKHZhciBzdHlsZSBpbiBzdHlsZXMpIHRoaXMuc2V0U3R5bGUoc3R5bGUsIHN0eWxlc1tzdHlsZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCUFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKS5lYWNoKGZ1bmN0aW9uKGtleSl7CgkJCXJlc3VsdFtrZXldID0gdGhpcy5nZXRTdHlsZShrZXkpOwoJCX0sIHRoaXMpOwoJCXJldHVybiByZXN1bHQ7Cgl9Cgp9KTsKCkVsZW1lbnQuU3R5bGVzID0gewoJbGVmdDogJ0BweCcsIHRvcDogJ0BweCcsIGJvdHRvbTogJ0BweCcsIHJpZ2h0OiAnQHB4JywKCXdpZHRoOiAnQHB4JywgaGVpZ2h0OiAnQHB4JywgbWF4V2lkdGg6ICdAcHgnLCBtYXhIZWlnaHQ6ICdAcHgnLCBtaW5XaWR0aDogJ0BweCcsIG1pbkhlaWdodDogJ0BweCcsCgliYWNrZ3JvdW5kQ29sb3I6ICdyZ2IoQCwgQCwgQCknLCBiYWNrZ3JvdW5kUG9zaXRpb246ICdAcHggQHB4JywgY29sb3I6ICdyZ2IoQCwgQCwgQCknLAoJZm9udFNpemU6ICdAcHgnLCBsZXR0ZXJTcGFjaW5nOiAnQHB4JywgbGluZUhlaWdodDogJ0BweCcsIGNsaXA6ICdyZWN0KEBweCBAcHggQHB4IEBweCknLAoJbWFyZ2luOiAnQHB4IEBweCBAcHggQHB4JywgcGFkZGluZzogJ0BweCBAcHggQHB4IEBweCcsIGJvcmRlcjogJ0BweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCkgQHB4IEAgcmdiKEAsIEAsIEApJywKCWJvcmRlcldpZHRoOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyU3R5bGU6ICdAIEAgQCBAJywgYm9yZGVyQ29sb3I6ICdyZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKSByZ2IoQCwgQCwgQCknLAoJekluZGV4OiAnQCcsICd6b29tJzogJ0AnLCBmb250V2VpZ2h0OiAnQCcsIHRleHRJbmRlbnQ6ICdAcHgnLCBvcGFjaXR5OiAnQCcKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuU3R5bGVzID0gbmV3IEhhc2goRWxlbWVudC5TdHlsZXMpOwoKLy88LzEuMmNvbXBhdD4KCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFdmVudF0KCnByb3ZpZGVzOiBFbGVtZW50LkV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpewoKRWxlbWVudC5Qcm9wZXJ0aWVzLmV2ZW50cyA9IHtzZXQ6IGZ1bmN0aW9uKGV2ZW50cyl7Cgl0aGlzLmFkZEV2ZW50cyhldmVudHMpOwp9fTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnLCB7fSk7CgkJaWYgKCFldmVudHNbdHlwZV0pIGV2ZW50c1t0eXBlXSA9IHtrZXlzOiBbXSwgdmFsdWVzOiBbXX07CgkJaWYgKGV2ZW50c1t0eXBlXS5rZXlzLmNvbnRhaW5zKGZuKSkgcmV0dXJuIHRoaXM7CgkJZXZlbnRzW3R5cGVdLmtleXMucHVzaChmbik7CgkJdmFyIHJlYWxUeXBlID0gdHlwZSwKCQkJY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV0sCgkJCWNvbmRpdGlvbiA9IGZuLAoJCQlzZWxmID0gdGhpczsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vbkFkZCkgY3VzdG9tLm9uQWRkLmNhbGwodGhpcywgZm4pOwoJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbil7CgkJCQljb25kaXRpb24gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJaWYgKGN1c3RvbS5jb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRoaXMsIGV2ZW50KTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX07CgkJCX0KCQkJcmVhbFR5cGUgPSBjdXN0b20uYmFzZSB8fCByZWFsVHlwZTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBJRTkKdHJ5IHsKCWlmICh0eXBlb2YgSFRNTEVsZW1lbnQgIT0gJ3VuZGVmaW5lZCcpCgkJSFRNTEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudCA9IEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudDsKfSBjYXRjaChlKXt9CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRpbWVuc2lvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBtZXRob2RzIHRvIHdvcmsgd2l0aCBzaXplLCBzY3JvbGwsIG9yIHBvc2l0aW9uaW5nIG9mIEVsZW1lbnRzIGFuZCB0aGUgd2luZG93IG9iamVjdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVsZW1lbnQgcG9zaXRpb25pbmcgYmFzZWQgb24gdGhlIFtxb294ZG9vXShodHRwOi8vcW9veGRvby5vcmcvKSBjb2RlIGFuZCBzbWFydCBicm93c2VyIGZpeGVzLCBbTEdQTCBMaWNlbnNlXShodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sKS4KICAtIFZpZXdwb3J0IGRpbWVuc2lvbnMgYmFzZWQgb24gW1lVSV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpLykgY29kZSwgW0JTRCBMaWNlbnNlXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvbGljZW5zZS5odG1sKS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBbRWxlbWVudC5EaW1lbnNpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJaWYgKGlzQm9keSh0aGlzKSl7CgkJCXRoaXMuZ2V0V2luZG93KCkuc2Nyb2xsVG8oeCwgeSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQkJdGhpcy5zY3JvbGxUb3AgPSB5OwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLm9mZnNldFdpZHRoLCB5OiB0aGlzLm9mZnNldEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsU2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxXaWR0aCwgeTogdGhpcy5zY3JvbGxIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbExlZnQsIHk6IHRoaXMuc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsczogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXMucGFyZW50Tm9kZSwgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5zY3JvbGxMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQuc2Nyb2xsVG9wOwoJCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldE9mZnNldFBhcmVudDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSkgcmV0dXJuIG51bGw7CgkJaWYgKCFCcm93c2VyLmllKSByZXR1cm4gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWxlbWVudCkpIHJldHVybiBlbGVtZW50OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHt4OiAwLCB5OiAwfTsKCQl2YXIgb2Zmc2V0ID0gdGhpcy5nZXRPZmZzZXRzKCksCgkJCXNjcm9sbCA9IHRoaXMuZ2V0U2Nyb2xscygpOwoJCXZhciBwb3NpdGlvbiA9IHsKCQkJeDogb2Zmc2V0LnggLSBzY3JvbGwueCwKCQkJeTogb2Zmc2V0LnkgLSBzY3JvbGwueQoJCX07CgkJCgkJaWYgKHJlbGF0aXZlICYmIChyZWxhdGl2ZSA9IGRvY3VtZW50LmlkKHJlbGF0aXZlKSkpewoJCQl2YXIgcmVsYXRpdmVQb3NpdGlvbiA9IHJlbGF0aXZlLmdldFBvc2l0aW9uKCk7CgkJCXJldHVybiB7eDogcG9zaXRpb24ueCAtIHJlbGF0aXZlUG9zaXRpb24ueCAtIGxlZnRCb3JkZXIocmVsYXRpdmUpLCB5OiBwb3NpdGlvbi55IC0gcmVsYXRpdmVQb3NpdGlvbi55IC0gdG9wQm9yZGVyKHJlbGF0aXZlKX07CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldENvb3JkaW5hdGVzKCk7CgkJdmFyIHBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbihlbGVtZW50KSwKCQkJc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXZhciBvYmogPSB7CgkJCWxlZnQ6IHBvc2l0aW9uLngsCgkJCXRvcDogcG9zaXRpb24ueSwKCQkJd2lkdGg6IHNpemUueCwKCQkJaGVpZ2h0OiBzaXplLnkKCQl9OwoJCW9iai5yaWdodCA9IG9iai5sZWZ0ICsgb2JqLndpZHRoOwoJCW9iai5ib3R0b20gPSBvYmoudG9wICsgb2JqLmhlaWdodDsKCQlyZXR1cm4gb2JqOwoJfSwKCgljb21wdXRlUG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHsKCQkJbGVmdDogb2JqLnggLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLWxlZnQnKSwKCQkJdG9wOiBvYmoueSAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tdG9wJykKCQl9OwoJfSwKCglzZXRQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5zZXRTdHlsZXModGhpcy5jb21wdXRlUG9zaXRpb24ob2JqKSk7Cgl9Cgp9KTsKCgpbRG9jdW1lbnQsIFdpbmRvd10uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQl2YXIgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKTsKCQlyZXR1cm4ge3g6IGRvYy5jbGllbnRXaWR0aCwgeTogZG9jLmNsaWVudEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbDogZnVuY3Rpb24oKXsKCQl2YXIgd2luID0gdGhpcy5nZXRXaW5kb3coKSwgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKTsKCQlyZXR1cm4ge3g6IHdpbi5wYWdlWE9mZnNldCB8fCBkb2Muc2Nyb2xsTGVmdCwgeTogd2luLnBhZ2VZT2Zmc2V0IHx8IGRvYy5zY3JvbGxUb3B9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpLAoJCQltaW4gPSB0aGlzLmdldFNpemUoKSwKCQkJYm9keSA9IHRoaXMuZ2V0RG9jdW1lbnQoKS5ib2R5OwoKCQlyZXR1cm4ge3g6IE1hdGgubWF4KGRvYy5zY3JvbGxXaWR0aCwgYm9keS5zY3JvbGxXaWR0aCwgbWluLngpLCB5OiBNYXRoLm1heChkb2Muc2Nyb2xsSGVpZ2h0LCBib2R5LnNjcm9sbEhlaWdodCwgbWluLnkpfTsKCX0sCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHt4OiAwLCB5OiAwfTsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHNpemUgPSB0aGlzLmdldFNpemUoKTsKCQlyZXR1cm4ge3RvcDogMCwgbGVmdDogMCwgYm90dG9tOiBzaXplLnksIHJpZ2h0OiBzaXplLngsIGhlaWdodDogc2l6ZS55LCB3aWR0aDogc2l6ZS54fTsKCX0KCn0pOwoKLy8gcHJpdmF0ZSBtZXRob2RzCgp2YXIgc3R5bGVTdHJpbmcgPSBFbGVtZW50LmdldENvbXB1dGVkU3R5bGU7CgpmdW5jdGlvbiBzdHlsZU51bWJlcihlbGVtZW50LCBzdHlsZSl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgc3R5bGUpLnRvSW50KCkgfHwgMDsKfTsKCmZ1bmN0aW9uIGJvcmRlckJveChlbGVtZW50KXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCAnLW1vei1ib3gtc2l6aW5nJykgPT0gJ2JvcmRlci1ib3gnOwp9OwoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn07CgpmdW5jdGlvbiBsZWZ0Qm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItbGVmdC13aWR0aCcpOwp9OwoKZnVuY3Rpb24gaXNCb2R5KGVsZW1lbnQpewoJcmV0dXJuICgvXig/OmJvZHl8aHRtbCkkL2kpLnRlc3QoZWxlbWVudC50YWdOYW1lKTsKfTsKCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn07Cgp9KSgpOwoKLy9hbGlhc2VzCkVsZW1lbnQuYWxpYXMoe3Bvc2l0aW9uOiAnc2V0UG9zaXRpb24nfSk7IC8vY29tcGF0YWJpbGl0eQoKW1dpbmRvdywgRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEhlaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueTsKCX0sCgoJZ2V0V2lkdGg6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2l6ZSgpLng7Cgl9LAoKCWdldFNjcm9sbFRvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS55OwoJfSwKCglnZXRTY3JvbGxMZWZ0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLng7Cgl9LAoKCWdldFNjcm9sbEhlaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueTsKCX0sCgoJZ2V0U2Nyb2xsV2lkdGg6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsU2l6ZSgpLng7Cgl9LAoKCWdldFRvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLnk7Cgl9LAoKCWdldExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0UG9zaXRpb24oKS54OwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBiYXNpYyBhbmltYXRpb24gbG9naWMgdG8gYmUgZXh0ZW5kZWQgYnkgYWxsIG90aGVyIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCnByb3ZpZGVzOiBGeAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBGeCA9IHRoaXMuRnggPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7CgkJLyoKCQlvblN0YXJ0OiBuaWwsCgkJb25DYW5jZWw6IG5pbCwKCQlvbkNvbXBsZXRlOiBuaWwsCgkJKi8KCQlmcHM6IDUwLAoJCXVuaXQ6IGZhbHNlLAoJCWR1cmF0aW9uOiA1MDAsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKCl7CgkJdmFyIHRpbWUgPSBEYXRlLm5vdygpOwoJCWlmICh0aW1lIDwgdGhpcy50aW1lICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uKXsKCQkJdmFyIGRlbHRhID0gdGhpcy50cmFuc2l0aW9uKCh0aW1lIC0gdGhpcy50aW1lKSAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIGRlbHRhKSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgMSkpOwoJCQl0aGlzLmNvbXBsZXRlKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMudGltZXIpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXZhciBkdXJhdGlvbiA9IHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCQl0aGlzLm9wdGlvbnMuZHVyYXRpb24gPSBGeC5EdXJhdGlvbnNbZHVyYXRpb25dIHx8IGR1cmF0aW9uLnRvSW50KCk7CgkJdGhpcy5mcm9tID0gZnJvbTsKCQl0aGlzLnRvID0gdG87CgkJdGhpcy50aW1lID0gMDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl0aGlzLnN0YXJ0VGltZXIoKTsKCQl0aGlzLm9uU3RhcnQoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcGxldGU6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuc3RvcFRpbWVyKCkpIHRoaXMub25Db21wbGV0ZSgpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuc3RvcFRpbWVyKCkpIHRoaXMub25DYW5jZWwoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJb25TdGFydDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnc3RhcnQnLCB0aGlzLnN1YmplY3QpOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJaWYgKCF0aGlzLmNhbGxDaGFpbigpKSB0aGlzLmZpcmVFdmVudCgnY2hhaW5Db21wbGV0ZScsIHRoaXMuc3ViamVjdCk7Cgl9LAoKCW9uQ2FuY2VsOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnLCB0aGlzLnN1YmplY3QpLmNsZWFyQ2hhaW4oKTsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdG9wVGltZXIoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVzdW1lOiBmdW5jdGlvbigpewoJCXRoaXMuc3RhcnRUaW1lcigpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wVGltZXI6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnRpbWVyKSByZXR1cm4gZmFsc2U7CgkJdGhpcy50aW1lID0gRGF0ZS5ub3coKSAtIHRoaXMudGltZTsKCQl0aGlzLnRpbWVyID0gcmVtb3ZlSW5zdGFuY2UodGhpcyk7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXN0YXJ0VGltZXI6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMudGltZXIpIHJldHVybiBmYWxzZTsKCQl0aGlzLnRpbWUgPSBEYXRlLm5vdygpIC0gdGhpcy50aW1lOwoJCXRoaXMudGltZXIgPSBhZGRJbnN0YW5jZSh0aGlzKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJaWYgKHRoaXNbaV0pIHRoaXNbaV0uc3RlcCgpOwoJfQp9OwoKdmFyIGFkZEluc3RhbmNlID0gZnVuY3Rpb24oaW5zdGFuY2UpewoJdmFyIGZwcyA9IGluc3RhbmNlLm9wdGlvbnMuZnBzLAoJCWxpc3QgPSBpbnN0YW5jZXNbZnBzXSB8fCAoaW5zdGFuY2VzW2Zwc10gPSBbXSk7CglsaXN0LnB1c2goaW5zdGFuY2UpOwoJaWYgKCF0aW1lcnNbZnBzXSkgdGltZXJzW2Zwc10gPSBsb29wLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gZnBzKSwgbGlzdCk7CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciByZW1vdmVJbnN0YW5jZSA9IGZ1bmN0aW9uKGluc3RhbmNlKXsKCXZhciBmcHMgPSBpbnN0YW5jZS5vcHRpb25zLmZwcywKCQlsaXN0ID0gaW5zdGFuY2VzW2Zwc10gfHwgW107CglsaXN0LmVyYXNlKGluc3RhbmNlKTsKCWlmICghbGlzdC5sZW5ndGggJiYgdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gY2xlYXJJbnRlcnZhbCh0aW1lcnNbZnBzXSk7CglyZXR1cm4gZmFsc2U7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9OwoJCUFycmF5LmVhY2goZG9jdW1lbnQuc3R5bGVTaGVldHMsIGZ1bmN0aW9uKHNoZWV0LCBqKXsKCQkJdmFyIGhyZWYgPSBzaGVldC5ocmVmOwoJCQlpZiAoaHJlZiAmJiBocmVmLmNvbnRhaW5zKCc6Ly8nKSAmJiAhaHJlZi5jb250YWlucyhkb2N1bWVudC5kb21haW4pKSByZXR1cm47CgkJCXZhciBydWxlcyA9IHNoZWV0LnJ1bGVzIHx8IHNoZWV0LmNzc1J1bGVzOwoJCQlBcnJheS5lYWNoKHJ1bGVzLCBmdW5jdGlvbihydWxlLCBpKXsKCQkJCWlmICghcnVsZS5zdHlsZSkgcmV0dXJuOwoJCQkJdmFyIHNlbGVjdG9yVGV4dCA9IChydWxlLnNlbGVjdG9yVGV4dCkgPyBydWxlLnNlbGVjdG9yVGV4dC5yZXBsYWNlKC9eXHcrLywgZnVuY3Rpb24obSl7CgkJCQkJcmV0dXJuIG0udG9Mb3dlckNhc2UoKTsKCQkJCX0pIDogbnVsbDsKCQkJCWlmICghc2VsZWN0b3JUZXh0IHx8ICFzZWxlY3RvclRleHQudGVzdCgnXicgKyBzZWxlY3RvciArICckJykpIHJldHVybjsKCQkJCUVsZW1lbnQuU3R5bGVzLmVhY2goZnVuY3Rpb24odmFsdWUsIHN0eWxlKXsKCQkJCQlpZiAoIXJ1bGUuc3R5bGVbc3R5bGVdIHx8IEVsZW1lbnQuU2hvcnRTdHlsZXNbc3R5bGVdKSByZXR1cm47CgkJCQkJdmFsdWUgPSBTdHJpbmcocnVsZS5zdHlsZVtzdHlsZV0pOwoJCQkJCXRvW3N0eWxlXSA9ICh2YWx1ZS50ZXN0KC9ecmdiLykpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguQ1NTLlBhcnNlcnMgPSBuZXcgSGFzaChGeC5DU1MuUGFyc2Vycyk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJcmV0dXJuIE9iamVjdC5hcHBlbmQodHJhbnNpdGlvbiwgewoJCWVhc2VJbjogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSkgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgLyAyIDogKDIgLSB0cmFuc2l0aW9uKDIgKiAoMSAtIHBvcyksIHBhcmFtcykpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguc2luKCgxIC0gcCkgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBbaSArIDJdKTsKCX0pOwp9KTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QKCmRlc2NyaXB0aW9uOiBQb3dlcmZ1bCBhbGwgcHVycG9zZSBSZXF1ZXN0IENsYXNzLiBVc2VzIFhNTEhUVFBSZXF1ZXN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW09iamVjdCwgRWxlbWVudCwgQ2hhaW4sIEV2ZW50cywgT3B0aW9ucywgQnJvd3Nlcl0KCnByb3ZpZGVzOiBSZXF1ZXN0CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIHByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXt9OwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQkKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoJCglsb2Fkc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgnbG9hZHN0YXJ0JywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoJCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCQoJc2VuZDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJaWYgKCF0aGlzLmNoZWNrKG9wdGlvbnMpKSByZXR1cm4gdGhpczsKCgkJdGhpcy5vcHRpb25zLmlzU3VjY2VzcyA9IHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgfHwgdGhpcy5pc1N1Y2Nlc3M7CgkJdGhpcy5ydW5uaW5nID0gdHJ1ZTsKCgkJdmFyIHR5cGUgPSB0eXBlT2Yob3B0aW9ucyk7CgkJaWYgKHR5cGUgPT0gJ3N0cmluZycgfHwgdHlwZSA9PSAnZWxlbWVudCcpIG9wdGlvbnMgPSB7ZGF0YTogb3B0aW9uc307CgoJCXZhciBvbGQgPSB0aGlzLm9wdGlvbnM7CgkJb3B0aW9ucyA9IE9iamVjdC5hcHBlbmQoe2RhdGE6IG9sZC5kYXRhLCB1cmw6IG9sZC51cmwsIG1ldGhvZDogb2xkLm1ldGhvZH0sIG9wdGlvbnMpOwoJCXZhciBkYXRhID0gb3B0aW9ucy5kYXRhLCB1cmwgPSBTdHJpbmcob3B0aW9ucy51cmwpLCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b0xvd2VyQ2FzZSgpOwoKCQlzd2l0Y2ggKHR5cGVPZihkYXRhKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBkYXRhID0gZG9jdW1lbnQuaWQoZGF0YSkudG9RdWVyeVN0cmluZygpOyBicmVhazsKCQkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6IGRhdGEgPSBPYmplY3QudG9RdWVyeVN0cmluZyhkYXRhKTsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZm9ybWF0KXsKCQkJdmFyIGZvcm1hdCA9ICdmb3JtYXQ9JyArIHRoaXMub3B0aW9ucy5mb3JtYXQ7CgkJCWRhdGEgPSAoZGF0YSkgPyBmb3JtYXQgKyAnJicgKyBkYXRhIDogZm9ybWF0OwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5lbXVsYXRpb24gJiYgIVsnZ2V0JywgJ3Bvc3QnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIF9tZXRob2QgPSAnX21ldGhvZD0nICsgbWV0aG9kOwoJCQlkYXRhID0gKGRhdGEpID8gX21ldGhvZCArICcmJyArIGRhdGEgOiBfbWV0aG9kOwoJCQltZXRob2QgPSAncG9zdCc7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLnVybEVuY29kZWQgJiYgWydwb3N0JywgJ3B1dCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgZW5jb2RpbmcgPSAodGhpcy5vcHRpb25zLmVuY29kaW5nKSA/ICc7IGNoYXJzZXQ9JyArIHRoaXMub3B0aW9ucy5lbmNvZGluZyA6ICcnOwoJCQl0aGlzLmhlYWRlcnNbJ0NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgKyBlbmNvZGluZzsKCQl9CgoJCWlmICghdXJsKSB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZTsKCQkKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoJCQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0geGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBmdW5jdGlvbigpe307CgkJdGhpcy54aHIgPSBuZXcgQnJvd3Nlci5SZXF1ZXN0KCk7CgkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgbWV0aG9kcyA9IHt9OwpbJ2dldCcsICdwb3N0JywgJ3B1dCcsICdkZWxldGUnLCAnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURSddLmVhY2goZnVuY3Rpb24obWV0aG9kKXsKCW1ldGhvZHNbbWV0aG9kXSA9IGZ1bmN0aW9uKGRhdGEpewoJCXJldHVybiB0aGlzLnNlbmQoewoJCQlkYXRhOiBkYXRhLAoJCQltZXRob2Q6IG1ldGhvZAoJCX0pOwoJfTsKfSk7CgpSZXF1ZXN0LmltcGxlbWVudChtZXRob2RzKTsKCkVsZW1lbnQuUHJvcGVydGllcy5zZW5kID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbmQgPSB0aGlzLmdldCgnc2VuZCcpLmNhbmNlbCgpOwoJCXNlbmQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBzZW5kID0gdGhpcy5yZXRyaWV2ZSgnc2VuZCcpOwoJCWlmICghc2VuZCl7CgkJCXNlbmQgPSBuZXcgUmVxdWVzdCh7CgkJCQlkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgbWV0aG9kOiB0aGlzLmdldCgnbWV0aG9kJykgfHwgJ3Bvc3QnLCB1cmw6IHRoaXMuZ2V0KCdhY3Rpb24nKQoJCQl9KTsKCQkJdGhpcy5zdG9yZSgnc2VuZCcsIHNlbmQpOwoJCX0KCQlyZXR1cm4gc2VuZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2VuZDogZnVuY3Rpb24odXJsKXsKCQl2YXIgc2VuZGVyID0gdGhpcy5nZXQoJ3NlbmQnKTsKCQlzZW5kZXIuc2VuZCh7ZGF0YTogdGhpcywgdXJsOiB1cmwgfHwgc2VuZGVyLm9wdGlvbnMudXJsfSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cygnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50cy5maWx0ZXIob3B0aW9ucy5maWx0ZXIpOwoJCWlmIChvcHRpb25zLnVwZGF0ZSkgZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJZWxzZSBpZiAob3B0aW9ucy5hcHBlbmQpIGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKS5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZSBBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAoIXRoaXMuSlNPTikgdGhpcy5KU09OID0ge307CgovLzwxLjJjb21wYXQ+CgpKU09OID0gbmV3IEhhc2goewoJc3RyaW5naWZ5OiBKU09OLnN0cmluZ2lmeSwKCXBhcnNlOiBKU09OLnBhcnNlCn0pOwoKLy88LzEuMmNvbXBhdD4KCk9iamVjdC5hcHBlbmQoSlNPTiwgewoKCSRzcGVjaWFsQ2hhcnM6IHsnXGInOiAnXFxiJywgJ1x0JzogJ1xcdCcsICdcbic6ICdcXG4nLCAnXGYnOiAnXFxmJywgJ1xyJzogJ1xccicsICciJyA6ICdcXCInLCAnXFwnOiAnXFxcXCd9LAoKCSRyZXBsYWNlQ2hhcnM6IGZ1bmN0aW9uKGNocil7CgkJcmV0dXJuIEpTT04uJHNwZWNpYWxDaGFyc1tjaHJdIHx8ICdcXHUwMCcgKyBNYXRoLmZsb29yKGNoci5jaGFyQ29kZUF0KCkgLyAxNikudG9TdHJpbmcoMTYpICsgKGNoci5jaGFyQ29kZUF0KCkgJSAxNikudG9TdHJpbmcoMTYpOwoJfSwKCgllbmNvZGU6IGZ1bmN0aW9uKG9iail7CgkJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIEpTT04uJHJlcGxhY2VDaGFycykgKyAnIic7CgkJCWNhc2UgJ2FycmF5JzoKCQkJCXJldHVybiAnWycgKyBTdHJpbmcob2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSkgKyAnXSc7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOgoJCQkJdmFyIHN0cmluZyA9IFtdOwoJCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCQl2YXIganNvbiA9IEpTT04uZW5jb2RlKHZhbHVlKTsKCQkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQkJfSk7CgkJCQlyZXR1cm4gJ3snICsgc3RyaW5nICsgJ30nOwoJCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuIFN0cmluZyhvYmopOwoJCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWRlY29kZTogZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJCWlmICh0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJyB8fCAhc3RyaW5nLmxlbmd0aCkgcmV0dXJuIG51bGw7CgkJaWYgKHNlY3VyZSAmJiAhKC9eWyw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdKiQvKS50ZXN0KHN0cmluZy5yZXBsYWNlKC9cXC4vZywgJ0AnKS5yZXBsYWNlKC8iW14iXFxcblxyXSoiL2csICcnKSkpIHJldHVybiBudWxsOwoJCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSlNPTgoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBKU09OIGRhdGEuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbUmVxdWVzdCwgSlNPTl0KCnByb3ZpZGVzOiBSZXF1ZXN0LkpTT04KCi4uLgoqLwoKUmVxdWVzdC5KU09OID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgc2VjdXJlID0gdGhpcy5vcHRpb25zLnNlY3VyZTsKCQl2YXIganNvbiA9IHRoaXMucmVzcG9uc2UuanNvbiA9IEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIEpTT04uZGVjb2RlKHRleHQsIHNlY3VyZSk7CgkJfSk7CgoJCWlmIChqc29uID09IG51bGwpIHRoaXMub25GYWlsdXJlKCk7CgkJZWxzZSB0aGlzLm9uU3VjY2Vzcyhqc29uLCB0ZXh0KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ29va2llCgpkZXNjcmlwdGlvbjogQ2xhc3MgZm9yIGNyZWF0aW5nLCByZWFkaW5nLCBhbmQgZGVsZXRpbmcgYnJvd3NlciBDb29raWVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gQmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykuCgpyZXF1aXJlczogT3B0aW9ucwoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCglpc0ZyYW1lZCA9IHRydWU7CgovLyBUaGFua3MgdG8gUmljaCBEb3VnaGVydHkgPGh0dHA6Ly93d3cucmljaGRvdWdoZXJ0eS5jb20vPgp0cnkgewoJaXNGcmFtZWQgPSB3aW5kb3cuZnJhbWVFbGVtZW50ICE9IG51bGw7Cn0gY2F0Y2goZSl7fQoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgkKCWRvY3VtZW50LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCXdpbmRvdy5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbigpewoJZm9yICh2YXIgaSA9IGNoZWNrcy5sZW5ndGg7IGktLTspIGlmIChjaGVja3NbaV0oKSl7CgkJZG9tcmVhZHkoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCnZhciB0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWlzRnJhbWVkKXsKCWNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7CgkJdHJ5IHsKCQkJdGVzdEVsZW1lbnQuZG9TY3JvbGwoKTsKCQkJcmV0dXJuIHRydWU7CgkJfSBjYXRjaCAoZSl7fQoKCQlyZXR1cm4gZmFsc2U7Cgl9KTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQkKCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBpZCA9IDA7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIGlkKys7CgoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXZhciBpZCA9IHRoaXMuaWQgPSBvcHRpb25zLmlkIHx8IHRoaXMuaW5zdGFuY2U7CgkJdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmlkKG9wdGlvbnMuY29udGFpbmVyKTsKCgkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdID0ge307CgoJCXZhciBwYXJhbXMgPSBvcHRpb25zLnBhcmFtcywgdmFycyA9IG9wdGlvbnMudmFycywgY2FsbEJhY2tzID0gb3B0aW9ucy5jYWxsQmFja3M7CgkJdmFyIHByb3BlcnRpZXMgPSBPYmplY3QuYXBwZW5kKHtoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LCB3aWR0aDogb3B0aW9ucy53aWR0aH0sIG9wdGlvbnMucHJvcGVydGllcyk7CgoJCXZhciBzZWxmID0gdGhpczsKCgkJZm9yICh2YXIgY2FsbEJhY2sgaW4gY2FsbEJhY2tzKXsKCQkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdW2NhbGxCYWNrXSA9IChmdW5jdGlvbihvcHRpb24pewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCQkJcmV0dXJuIG9wdGlvbi5hcHBseShzZWxmLm9iamVjdCwgYXJndW1lbnRzKTsKCQkJCX07CgkJCX0pKGNhbGxCYWNrc1tjYWxsQmFja10pOwoJCQl2YXJzW2NhbGxCYWNrXSA9ICdTd2lmZi5DYWxsQmFja3MuJyArIHRoaXMuaW5zdGFuY2UgKyAnLicgKyBjYWxsQmFjazsKCQl9CgoJCXBhcmFtcy5mbGFzaFZhcnMgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YXJzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXByb3BlcnRpZXMuY2xhc3NpZCA9ICdjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAnOwoJCQlwYXJhbXMubW92aWUgPSBwYXRoOwoJCX0gZWxzZSB7CgkJCXByb3BlcnRpZXMudHlwZSA9ICdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCc7CgkJfQoJCXByb3BlcnRpZXMuZGF0YSA9IHBhdGg7CgoJCXZhciBidWlsZCA9ICc8b2JqZWN0IGlkPSInICsgaWQgKyAnIic7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcykgYnVpbGQgKz0gJyAnICsgcHJvcGVydHkgKyAnPSInICsgcHJvcGVydGllc1twcm9wZXJ0eV0gKyAnIic7CgkJYnVpbGQgKz0gJz4nOwoJCWZvciAodmFyIHBhcmFtIGluIHBhcmFtcyl7CgkJCWlmIChwYXJhbXNbcGFyYW1dKSBidWlsZCArPSAnPHBhcmFtIG5hbWU9IicgKyBwYXJhbSArICciIHZhbHVlPSInICsgcGFyYW1zW3BhcmFtXSArICciIC8+JzsKCQl9CgkJYnVpbGQgKz0gJzwvb2JqZWN0Pic7CgkJdGhpcy5vYmplY3QgPSAoKGNvbnRhaW5lcikgPyBjb250YWluZXIuZW1wdHkoKSA6IG5ldyBFbGVtZW50KCdkaXYnKSkuc2V0KCdodG1sJywgYnVpbGQpLmZpcnN0Q2hpbGQ7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbGVtZW50KXsKCQllbGVtZW50ID0gZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSk7CgkJZWxlbWVudC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZCh0aGlzLnRvRWxlbWVudCgpLCBlbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKCQlkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3RlOiBmdW5jdGlvbigpewoJCXJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5leHRlbmQoYXJndW1lbnRzKSk7Cgl9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7Cgl2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwoJcmV0dXJuIGV2YWwocnMpOwp9OwoKfSkoKTsKCg==",
                "body": "LyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zJywKCWJ1aWxkOiAnYTNlZWQ2OTJkZDg1MDUwZDgwMTY4ZWMyYzcwOGVmZTkwMWJiN2RiMycKfTsKCi8vIHR5cGVPZiwgaW5zdGFuY2VPZgoKdmFyIHR5cGVPZiA9IHRoaXMudHlwZU9mID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gJ251bGwnOwoJaWYgKGl0ZW0uJGZhbWlseSkgcmV0dXJuIGl0ZW0uJGZhbWlseSgpOwoKCWlmIChpdGVtLm5vZGVOYW1lKXsKCQlpZiAoaXRlbS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gJ2VsZW1lbnQnOwoJCWlmIChpdGVtLm5vZGVUeXBlID09IDMpIHJldHVybiAoL1xTLykudGVzdChpdGVtLm5vZGVWYWx1ZSkgPyAndGV4dG5vZGUnIDogJ3doaXRlc3BhY2UnOwoJfSBlbHNlIGlmICh0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicpewoJCWlmIChpdGVtLmNhbGxlZSkgcmV0dXJuICdhcmd1bWVudHMnOwoJCWlmICgnaXRlbScgaW4gaXRlbSkgcmV0dXJuICdjb2xsZWN0aW9uJzsKCX0KCglyZXR1cm4gdHlwZW9mIGl0ZW07Cn07Cgp2YXIgaW5zdGFuY2VPZiA9IHRoaXMuaW5zdGFuY2VPZiA9IGZ1bmN0aW9uKGl0ZW0sIG9iamVjdCl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gZmFsc2U7Cgl2YXIgY29uc3RydWN0b3IgPSBpdGVtLiRjb25zdHJ1Y3RvciB8fCBpdGVtLmNvbnN0cnVjdG9yOwoJd2hpbGUgKGNvbnN0cnVjdG9yKXsKCQlpZiAoY29uc3RydWN0b3IgPT09IG9iamVjdCkgcmV0dXJuIHRydWU7CgkJY29uc3RydWN0b3IgPSBjb25zdHJ1Y3Rvci5wYXJlbnQ7Cgl9CglyZXR1cm4gaXRlbSBpbnN0YW5jZW9mIG9iamVjdDsKfTsKCi8vIEZ1bmN0aW9uIG92ZXJsb2FkaW5nCgp2YXIgRnVuY3Rpb24gPSB0aGlzLkZ1bmN0aW9uOwoKdmFyIGVudW1lcmFibGVzID0gdHJ1ZTsKZm9yICh2YXIgaSBpbiB7dG9TdHJpbmc6IDF9KSBlbnVtZXJhYmxlcyA9IG51bGw7CmlmIChlbnVtZXJhYmxlcykgZW51bWVyYWJsZXMgPSBbJ2hhc093blByb3BlcnR5JywgJ3ZhbHVlT2YnLCAnaXNQcm90b3R5cGVPZicsICdwcm9wZXJ0eUlzRW51bWVyYWJsZScsICd0b0xvY2FsZVN0cmluZycsICd0b1N0cmluZycsICdjb25zdHJ1Y3RvciddOwoKRnVuY3Rpb24ucHJvdG90eXBlLm92ZXJsb2FkU2V0dGVyID0gZnVuY3Rpb24odXNlUGx1cmFsKXsKCXZhciBzZWxmID0gdGhpczsKCXJldHVybiBmdW5jdGlvbihhLCBiKXsKCQlpZiAoYSA9PSBudWxsKSByZXR1cm4gdGhpczsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKXsKCQkJZm9yICh2YXIgayBpbiBhKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCWlmIChlbnVtZXJhYmxlcykgZm9yICh2YXIgaSA9IGVudW1lcmFibGVzLmxlbmd0aDsgaS0tOyl7CgkJCQlrID0gZW51bWVyYWJsZXNbaV07CgkJCQlpZiAoYS5oYXNPd25Qcm9wZXJ0eShrKSkgc2VsZi5jYWxsKHRoaXMsIGssIGFba10pOwoJCQl9CgkJfSBlbHNlIHsKCQkJc2VsZi5jYWxsKHRoaXMsIGEsIGIpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX07Cn07CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRHZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEpewoJCXZhciBhcmdzLCByZXN1bHQ7CgkJaWYgKHVzZVBsdXJhbCB8fCB0eXBlb2YgYSAhPSAnc3RyaW5nJykgYXJncyA9IGE7CgkJZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDEpIGFyZ3MgPSBhcmd1bWVudHM7CgkJaWYgKGFyZ3MpewoJCQlyZXN1bHQgPSB7fTsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSByZXN1bHRbYXJnc1tpXV0gPSBzZWxmLmNhbGwodGhpcywgYXJnc1tpXSk7CgkJfSBlbHNlIHsKCQkJcmVzdWx0ID0gc2VsZi5jYWxsKHRoaXMsIGEpOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXNba2V5XSA9IHZhbHVlOwp9Lm92ZXJsb2FkU2V0dGVyKCk7CgpGdW5jdGlvbi5wcm90b3R5cGUuaW1wbGVtZW50ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSl7Cgl0aGlzLnByb3RvdHlwZVtrZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCi8vIEZyb20KCnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKCkZ1bmN0aW9uLmZyb20gPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAodHlwZU9mKGl0ZW0pID09ICdmdW5jdGlvbicpID8gaXRlbSA6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGl0ZW07Cgl9Owp9OwoKQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJaWYgKGl0ZW0gPT0gbnVsbCkgcmV0dXJuIFtdOwoJcmV0dXJuIChUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJykgPyAodHlwZU9mKGl0ZW0pID09ICdhcnJheScpID8gaXRlbSA6IHNsaWNlLmNhbGwoaXRlbSkgOiBbaXRlbV07Cn07CgpOdW1iZXIuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJdmFyIG51bWJlciA9IHBhcnNlRmxvYXQoaXRlbSk7CglyZXR1cm4gaXNGaW5pdGUobnVtYmVyKSA/IG51bWJlciA6IG51bGw7Cn07CgpTdHJpbmcuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIGl0ZW0gKyAnJzsKfTsKCi8vIGhpZGUsIHByb3RlY3QKCkZ1bmN0aW9uLmltcGxlbWVudCh7CgoJaGlkZTogZnVuY3Rpb24oKXsKCQl0aGlzLiRoaWRkZW4gPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglwcm90ZWN0OiBmdW5jdGlvbigpewoJCXRoaXMuJHByb3RlY3RlZCA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIFR5cGUKCnZhciBUeXBlID0gdGhpcy5UeXBlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0KXsKCWlmIChuYW1lKXsKCQl2YXIgbG93ZXIgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CgkJdmFyIHR5cGVDaGVjayA9IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gKHR5cGVPZihpdGVtKSA9PSBsb3dlcik7CgkJfTsKCgkJVHlwZVsnaXMnICsgbmFtZV0gPSB0eXBlQ2hlY2s7CgkJaWYgKG9iamVjdCAhPSBudWxsKXsKCQkJb2JqZWN0LnByb3RvdHlwZS4kZmFtaWx5ID0gKGZ1bmN0aW9uKCl7CgkJCQlyZXR1cm4gbG93ZXI7CgkJCX0pLmhpZGUoKTsKCQkJLy88MS4yY29tcGF0PgoJCQlvYmplY3QudHlwZSA9IHR5cGVDaGVjazsKCQkJLy88LzEuMmNvbXBhdD4KCQl9Cgl9CgoJaWYgKG9iamVjdCA9PSBudWxsKSByZXR1cm4gbnVsbDsKCglvYmplY3QuZXh0ZW5kKHRoaXMpOwoJb2JqZWN0LiRjb25zdHJ1Y3RvciA9IFR5cGU7CglvYmplY3QucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG9iamVjdDsKCglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHRvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKClR5cGUuaXNFbnVtZXJhYmxlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gKGl0ZW0gIT0gbnVsbCAmJiB0eXBlb2YgaXRlbS5sZW5ndGggPT0gJ251bWJlcicgJiYgdG9TdHJpbmcuY2FsbChpdGVtKSAhPSAnW29iamVjdCBGdW5jdGlvbl0nICk7Cn07Cgp2YXIgaG9va3MgPSB7fTsKCnZhciBob29rc09mID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdC5wcm90b3R5cGUpOwoJcmV0dXJuIGhvb2tzW3R5cGVdIHx8IChob29rc1t0eXBlXSA9IFtdKTsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgkKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7CgoJcmV0dXJuIHRoaXM7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJdmFyIHByZXZpb3VzID0gdGhpc1tuYW1lXTsKCWlmIChwcmV2aW91cyA9PSBudWxsIHx8ICFwcmV2aW91cy4kcHJvdGVjdGVkKSB0aGlzW25hbWVdID0gbWV0aG9kOwoJcmV0dXJuIHRoaXM7Cn07CgpUeXBlLmltcGxlbWVudCh7CgoJaW1wbGVtZW50OiBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSwKCglleHRlbmQ6IGV4dGVuZC5vdmVybG9hZFNldHRlcigpLAoKCWFsaWFzOiBmdW5jdGlvbihuYW1lLCBleGlzdGluZyl7CgkJaW1wbGVtZW50LmNhbGwodGhpcywgbmFtZSwgdGhpcy5wcm90b3R5cGVbZXhpc3RpbmddKTsKCX0ub3ZlcmxvYWRTZXR0ZXIoKSwKCgltaXJyb3I6IGZ1bmN0aW9uKGhvb2spewoJCWhvb2tzT2YodGhpcykucHVzaChob29rKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKbmV3IFR5cGUoJ1R5cGUnLCBUeXBlKTsKCi8vIERlZmF1bHQgVHlwZXMKCnZhciBmb3JjZSA9IGZ1bmN0aW9uKG5hbWUsIG9iamVjdCwgbWV0aG9kcyl7Cgl2YXIgaXNUeXBlID0gKG9iamVjdCAhPSBPYmplY3QpLAoJCXByb3RvdHlwZSA9IG9iamVjdC5wcm90b3R5cGU7CgoJaWYgKGlzVHlwZSkgb2JqZWN0ID0gbmV3IFR5cGUobmFtZSwgb2JqZWN0KTsKCglmb3IgKHZhciBpID0gMCwgbCA9IG1ldGhvZHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQl2YXIga2V5ID0gbWV0aG9kc1tpXSwKCQkJZ2VuZXJpYyA9IG9iamVjdFtrZXldLAoJCQlwcm90byA9IHByb3RvdHlwZVtrZXldOwoKCQlpZiAoZ2VuZXJpYykgZ2VuZXJpYy5wcm90ZWN0KCk7CgoJCWlmIChpc1R5cGUgJiYgcHJvdG8pewoJCQlkZWxldGUgcHJvdG90eXBlW2tleV07CgkJCXByb3RvdHlwZVtrZXldID0gcHJvdG8ucHJvdGVjdCgpOwoJCX0KCX0KCglpZiAoaXNUeXBlKSBvYmplY3QuaW1wbGVtZW50KHByb3RvdHlwZSk7CgoJcmV0dXJuIGZvcmNlOwp9OwoKZm9yY2UoJ1N0cmluZycsIFN0cmluZywgWwoJJ2NoYXJBdCcsICdjaGFyQ29kZUF0JywgJ2NvbmNhdCcsICdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ21hdGNoJywgJ3F1b3RlJywgJ3JlcGxhY2UnLCAnc2VhcmNoJywKCSdzbGljZScsICdzcGxpdCcsICdzdWJzdHInLCAnc3Vic3RyaW5nJywgJ3RvTG93ZXJDYXNlJywgJ3RvVXBwZXJDYXNlJwpdKSgnQXJyYXknLCBBcnJheSwgWwoJJ3BvcCcsICdwdXNoJywgJ3JldmVyc2UnLCAnc2hpZnQnLCAnc29ydCcsICdzcGxpY2UnLCAndW5zaGlmdCcsICdjb25jYXQnLCAnam9pbicsICdzbGljZScsCgknaW5kZXhPZicsICdsYXN0SW5kZXhPZicsICdmaWx0ZXInLCAnZm9yRWFjaCcsICdldmVyeScsICdtYXAnLCAnc29tZScsICdyZWR1Y2UnLCAncmVkdWNlUmlnaHQnCl0pKCdOdW1iZXInLCBOdW1iZXIsIFsKCSd0b0V4cG9uZW50aWFsJywgJ3RvRml4ZWQnLCAndG9Mb2NhbGVTdHJpbmcnLCAndG9QcmVjaXNpb24nCl0pKCdGdW5jdGlvbicsIEZ1bmN0aW9uLCBbCgknYXBwbHknLCAnY2FsbCcsICdiaW5kJwpdKSgnUmVnRXhwJywgUmVnRXhwLCBbCgknZXhlYycsICd0ZXN0JwpdKSgnT2JqZWN0JywgT2JqZWN0LCBbCgknY3JlYXRlJywgJ2RlZmluZVByb3BlcnR5JywgJ2RlZmluZVByb3BlcnRpZXMnLCAna2V5cycsCgknZ2V0UHJvdG90eXBlT2YnLCAnZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yJywgJ2dldE93blByb3BlcnR5TmFtZXMnLAoJJ3ByZXZlbnRFeHRlbnNpb25zJywgJ2lzRXh0ZW5zaWJsZScsICdzZWFsJywgJ2lzU2VhbGVkJywgJ2ZyZWV6ZScsICdpc0Zyb3plbicKXSkoJ0RhdGUnLCBEYXRlLCBbJ25vdyddKTsKCk9iamVjdC5leHRlbmQgPSBleHRlbmQub3ZlcmxvYWRTZXR0ZXIoKTsKCkRhdGUuZXh0ZW5kKCdub3cnLCBmdW5jdGlvbigpewoJcmV0dXJuICsobmV3IERhdGUpOwp9KTsKCm5ldyBUeXBlKCdCb29sZWFuJywgQm9vbGVhbik7CgovLyBmaXhlcyBOYU4gcmV0dXJuaW5nIGFzIE51bWJlcgoKTnVtYmVyLnByb3RvdHlwZS4kZmFtaWx5ID0gZnVuY3Rpb24oKXsKCXJldHVybiBpc0Zpbml0ZSh0aGlzKSA/ICdudW1iZXInIDogJ251bGwnOwp9LmhpZGUoKTsKCi8vIE51bWJlci5yYW5kb20KCk51bWJlci5leHRlbmQoJ3JhbmRvbScsIGZ1bmN0aW9uKG1pbiwgbWF4KXsKCXJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluICsgMSkgKyBtaW4pOwp9KTsKCi8vIGZvckVhY2gsIGVhY2gKCk9iamVjdC5leHRlbmQoJ2ZvckVhY2gnLCBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJfQp9KTsKCk9iamVjdC5lYWNoID0gT2JqZWN0LmZvckVhY2g7CgpBcnJheS5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKGkgaW4gdGhpcykgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9Cgl9LAoKCWVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlBcnJheS5mb3JFYWNoKHRoaXMsIGZuLCBiaW5kKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gQXJyYXkgJiBPYmplY3QgY2xvbmluZywgT2JqZWN0IG1lcmdpbmcgYW5kIGFwcGVuZGluZwoKdmFyIGNsb25lT2YgPSBmdW5jdGlvbihpdGVtKXsKCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQljYXNlICdhcnJheSc6IHJldHVybiBpdGVtLmNsb25lKCk7CgkJY2FzZSAnb2JqZWN0JzogcmV0dXJuIE9iamVjdC5jbG9uZShpdGVtKTsKCQlkZWZhdWx0OiByZXR1cm4gaXRlbTsKCX0KfTsKCkFycmF5LmltcGxlbWVudCgnY2xvbmUnLCBmdW5jdGlvbigpewoJdmFyIGkgPSB0aGlzLmxlbmd0aCwgY2xvbmUgPSBuZXcgQXJyYXkoaSk7Cgl3aGlsZSAoaS0tKSBjbG9uZVtpXSA9IGNsb25lT2YodGhpc1tpXSk7CglyZXR1cm4gY2xvbmU7Cn0pOwoKdmFyIG1lcmdlT25lID0gZnVuY3Rpb24oc291cmNlLCBrZXksIGN1cnJlbnQpewoJc3dpdGNoICh0eXBlT2YoY3VycmVudCkpewoJCWNhc2UgJ29iamVjdCc6CgkJCWlmICh0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSBPYmplY3QubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwoJCQllbHNlIHNvdXJjZVtrZXldID0gT2JqZWN0LmNsb25lKGN1cnJlbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ2FycmF5Jzogc291cmNlW2tleV0gPSBjdXJyZW50LmNsb25lKCk7IGJyZWFrOwoJCWRlZmF1bHQ6IHNvdXJjZVtrZXldID0gY3VycmVudDsKCX0KCXJldHVybiBzb3VyY2U7Cn07CgpPYmplY3QuZXh0ZW5kKHsKCgltZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKCQlpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwoJCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwoJCX0KCQlyZXR1cm4gc291cmNlOwoJfSwKCgljbG9uZTogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgY2xvbmUgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBjbG9uZVtrZXldID0gY2xvbmVPZihvYmplY3Rba2V5XSk7CgkJcmV0dXJuIGNsb25lOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKG9yaWdpbmFsKXsKCQlmb3IgKHZhciBpID0gMSwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZXh0ZW5kZWQgPSBhcmd1bWVudHNbaV0gfHwge307CgkJCWZvciAodmFyIGtleSBpbiBleHRlbmRlZCkgb3JpZ2luYWxba2V5XSA9IGV4dGVuZGVkW2tleV07CgkJfQoJCXJldHVybiBvcmlnaW5hbDsKCX0KCn0pOwoKLy8gT2JqZWN0LWxlc3MgdHlwZXMKClsnT2JqZWN0JywgJ1doaXRlU3BhY2UnLCAnVGV4dE5vZGUnLCAnQ29sbGVjdGlvbicsICdBcmd1bWVudHMnXS5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJbmV3IFR5cGUobmFtZSk7Cn0pOwoKLy8gVW5pcXVlIElECgp2YXIgVUlEID0gRGF0ZS5ub3coKTsKClN0cmluZy5leHRlbmQoJ3VuaXF1ZUlEJywgZnVuY3Rpb24oKXsKCXJldHVybiAoVUlEKyspLnRvU3RyaW5nKDM2KTsKfSk7CgovLzwxLjJjb21wYXQ+Cgp2YXIgSGFzaCA9IHRoaXMuSGFzaCA9IG5ldyBUeXBlKCdIYXNoJywgZnVuY3Rpb24ob2JqZWN0KXsKCWlmICh0eXBlT2Yob2JqZWN0KSA9PSAnaGFzaCcpIG9iamVjdCA9IE9iamVjdC5jbG9uZShvYmplY3QuZ2V0Q2xlYW4oKSk7Cglmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSB0aGlzW2tleV0gPSBvYmplY3Rba2V5XTsKCXJldHVybiB0aGlzOwp9KTsKCkhhc2guaW1wbGVtZW50KHsKCglmb3JFYWNoOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJT2JqZWN0LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRDbGVhbjogZnVuY3Rpb24oKXsKCQl2YXIgY2xlYW4gPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gdGhpcyl7CgkJCWlmICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpIGNsZWFuW2tleV0gPSB0aGlzW2tleV07CgkJfQoJCXJldHVybiBjbGVhbjsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSAwOwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgbGVuZ3RoKys7CgkJfQoJCXJldHVybiBsZW5ndGg7Cgl9Cgp9KTsKCkhhc2guYWxpYXMoJ2VhY2gnLCAnZm9yRWFjaCcpOwoKT2JqZWN0LnR5cGUgPSBUeXBlLmlzT2JqZWN0OwoKdmFyIE5hdGl2ZSA9IHRoaXMuTmF0aXZlID0gZnVuY3Rpb24ocHJvcGVydGllcyl7CglyZXR1cm4gbmV3IFR5cGUocHJvcGVydGllcy5uYW1lLCBwcm9wZXJ0aWVzLmluaXRpYWxpemUpOwp9OwoKTmF0aXZlLnR5cGUgPSBUeXBlLnR5cGU7CgpOYXRpdmUuaW1wbGVtZW50ID0gZnVuY3Rpb24ob2JqZWN0cywgbWV0aG9kcyl7Cglmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIG9iamVjdHNbaV0uaW1wbGVtZW50KG1ldGhvZHMpOwoJcmV0dXJuIE5hdGl2ZTsKfTsKCnZhciBhcnJheVR5cGUgPSBBcnJheS50eXBlOwpBcnJheS50eXBlID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaW5zdGFuY2VPZihpdGVtLCBBcnJheSkgfHwgYXJyYXlUeXBlKGl0ZW0pOwp9OwoKdGhpcy4kQSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIEFycmF5LmZyb20oaXRlbSkuc2xpY2UoKTsKfTsKCnRoaXMuJGFyZ3VtZW50cyA9IGZ1bmN0aW9uKGkpewoJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJcmV0dXJuIGFyZ3VtZW50c1tpXTsKCX07Cn07Cgp0aGlzLiRjaGsgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuICEhKG9iaiB8fCBvYmogPT09IDApOwp9OwoKdGhpcy4kY2xlYXIgPSBmdW5jdGlvbih0aW1lcil7CgljbGVhclRpbWVvdXQodGltZXIpOwoJY2xlYXJJbnRlcnZhbCh0aW1lcik7CglyZXR1cm4gbnVsbDsKfTsKCnRoaXMuJGRlZmluZWQgPSBmdW5jdGlvbihvYmopewoJcmV0dXJuIChvYmogIT0gbnVsbCk7Cn07Cgp0aGlzLiRlYWNoID0gZnVuY3Rpb24oaXRlcmFibGUsIGZuLCBiaW5kKXsKCXZhciB0eXBlID0gdHlwZU9mKGl0ZXJhYmxlKTsKCSgodHlwZSA9PSAnYXJndW1lbnRzJyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnZWxlbWVudHMnKSA/IEFycmF5IDogT2JqZWN0KS5lYWNoKGl0ZXJhYmxlLCBmbiwgYmluZCk7Cn07Cgp0aGlzLiRlbXB0eSA9IGZ1bmN0aW9uKCl7fTsKCnRoaXMuJGV4dGVuZCA9IGZ1bmN0aW9uKG9yaWdpbmFsLCBleHRlbmRlZCl7CglyZXR1cm4gT2JqZWN0LmFwcGVuZChvcmlnaW5hbCwgZXh0ZW5kZWQpOwp9OwoKdGhpcy4kSCA9IGZ1bmN0aW9uKG9iamVjdCl7CglyZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKfTsKCnRoaXMuJG1lcmdlID0gZnVuY3Rpb24oKXsKCXZhciBhcmdzID0gQXJyYXkuc2xpY2UoYXJndW1lbnRzKTsKCWFyZ3MudW5zaGlmdCh7fSk7CglyZXR1cm4gT2JqZWN0Lm1lcmdlLmFwcGx5KG51bGwsIGFyZ3MpOwp9OwoKdGhpcy4kbGFtYmRhID0gRnVuY3Rpb24uZnJvbTsKdGhpcy4kbWl4aW4gPSBPYmplY3QubWVyZ2U7CnRoaXMuJHJhbmRvbSA9IE51bWJlci5yYW5kb207CnRoaXMuJHNwbGF0ID0gQXJyYXkuZnJvbTsKdGhpcy4kdGltZSA9IERhdGUubm93OwoKdGhpcy4kdHlwZSA9IGZ1bmN0aW9uKG9iamVjdCl7Cgl2YXIgdHlwZSA9IHR5cGVPZihvYmplY3QpOwoJaWYgKHR5cGUgPT0gJ2VsZW1lbnRzJykgcmV0dXJuICdhcnJheSc7CglyZXR1cm4gKHR5cGUgPT0gJ251bGwnKSA/IGZhbHNlIDogdHlwZTsKfTsKCnRoaXMuJHVubGluayA9IGZ1bmN0aW9uKG9iamVjdCl7Cglzd2l0Y2ggKHR5cGVPZihvYmplY3QpKXsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKG9iamVjdCk7CgkJY2FzZSAnYXJyYXknOiByZXR1cm4gQXJyYXkuY2xvbmUob2JqZWN0KTsKCQljYXNlICdoYXNoJzogcmV0dXJuIG5ldyBIYXNoKG9iamVjdCk7CgkJZGVmYXVsdDogcmV0dXJuIG9iamVjdDsKCX0KfTsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQXJyYXkKCmRlc2NyaXB0aW9uOiBDb250YWlucyBBcnJheSBQcm90b3R5cGVzIGxpa2UgZWFjaCwgY29udGFpbnMsIGFuZCBlcmFzZS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBBcnJheQoKLi4uCiovCgpBcnJheS5pbXBsZW1lbnQoewoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmICgoaSBpbiB0aGlzKSAmJiAhZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJlc3VsdHMucHVzaCh0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWNsZWFuOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0gIT0gbnVsbDsKCQl9KTsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW47IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IHRoaXMuaW5kZXhPZihzdHJpbmcpID4gLTE7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gKCctJyArIG1hdGNoLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpKTsKCQl9KTsKCX0sCgoJY2FwaXRhbGl6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8oWy0uKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfSwKCgl0b0ludDogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIHBhcnNlSW50KHRoaXMsIGJhc2UgfHwgMTApOwoJfSwKCgl0b0Zsb2F0OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUZsb2F0KHRoaXMpOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IG51bGw7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKHJlZ2V4cCB8fCAoL1xcP1x7KFtee31dKylcfS9nKSwgZnVuY3Rpb24obWF0Y2gsIG5hbWUpewoJCQlpZiAobWF0Y2guY2hhckF0KDApID09ICdcXCcpIHJldHVybiBtYXRjaC5zbGljZSgxKTsKCQkJcmV0dXJuIChvYmplY3RbbmFtZV0gIT0gbnVsbCkgPyBvYmplY3RbbmFtZV0gOiAnJzsKCQl9KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWRlbGF5OiBmdW5jdGlvbihkZWxheSwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldFRpbWVvdXQodGhpcy5wYXNzKGFyZ3MsIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoYXJncywgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKCk9iamVjdC5leHRlbmQoewoKCXN1YnNldDogZnVuY3Rpb24ob2JqZWN0LCBrZXlzKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgayA9IGtleXNbaV07CgkJCXJlc3VsdHNba10gPSBvYmplY3Rba107CgkJfQoJCXJldHVybiByZXN1bHRzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkgcmVzdWx0c1trZXldID0gZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5LCBvYmplY3QpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZmlsdGVyOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0pOwoJCXJldHVybiByZXN1bHRzOwoJfSwKCglldmVyeTogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJc29tZTogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXkpKSByZXR1cm4gdHJ1ZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglrZXlzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBrZXlzID0gW107CgkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCWlmIChvYmplY3QuaGFzT3duUHJvcGVydHkoa2V5KSkga2V5cy5wdXNoKGtleSk7CgkJfQoJCXJldHVybiBrZXlzOwoJfSwKCgl2YWx1ZXM6IGZ1bmN0aW9uKG9iamVjdCl7CgkJdmFyIHZhbHVlcyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHZhbHVlcy5wdXNoKG9iamVjdFtrZXldKTsKCQl9CgkJcmV0dXJuIHZhbHVlczsKCX0sCgoJZ2V0TGVuZ3RoOiBmdW5jdGlvbihvYmplY3QpewoJCXJldHVybiBPYmplY3Qua2V5cyhvYmplY3QpLmxlbmd0aDsKCX0sCgoJa2V5T2Y6IGZ1bmN0aW9uKG9iamVjdCwgdmFsdWUpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgb2JqZWN0W2tleV0gPT09IHZhbHVlKSByZXR1cm4ga2V5OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKG9iamVjdCwgdmFsdWUpewoJCXJldHVybiBPYmplY3Qua2V5T2Yob2JqZWN0LCB2YWx1ZSkgIT0gbnVsbDsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24ob2JqZWN0LCBiYXNlKXsKCQl2YXIgcXVlcnlTdHJpbmcgPSBbXTsKCgkJT2JqZWN0LmVhY2gob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJaWYgKGJhc2UpIGtleSA9IGJhc2UgKyAnWycgKyBrZXkgKyAnXSc7CgkJCXZhciByZXN1bHQ7CgkJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCQljYXNlICdvYmplY3QnOiByZXN1bHQgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YWx1ZSwga2V5KTsgYnJlYWs7CgkJCQljYXNlICdhcnJheSc6CgkJCQkJdmFyIHFzID0ge307CgkJCQkJdmFsdWUuZWFjaChmdW5jdGlvbih2YWwsIGkpewoJCQkJCQlxc1tpXSA9IHZhbDsKCQkJCQl9KTsKCQkJCQlyZXN1bHQgPSBPYmplY3QudG9RdWVyeVN0cmluZyhxcywga2V5KTsKCQkJCWJyZWFrOwoJCQkJZGVmYXVsdDogcmVzdWx0ID0ga2V5ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTsKCQkJfQoJCQlpZiAodmFsdWUgIT0gbnVsbCkgcXVlcnlTdHJpbmcucHVzaChyZXN1bHQpOwoJCX0pOwoKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfQoKfSk7CgoKLy88MS4yY29tcGF0PgoKSGFzaC5pbXBsZW1lbnQoewoKCWhhczogT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eSwKCglrZXlPZjogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBPYmplY3Qua2V5T2YodGhpcywgdmFsdWUpOwoJfSwKCgloYXNWYWx1ZTogZnVuY3Rpb24odmFsdWUpewoJCXJldHVybiBPYmplY3QuY29udGFpbnModGhpcywgdmFsdWUpOwoJfSwKCglleHRlbmQ6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCUhhc2guZWFjaChwcm9wZXJ0aWVzIHx8IHt9LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJSGFzaC5zZXQodGhpcywga2V5LCB2YWx1ZSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKHByb3BlcnRpZXMpewoJCUhhc2guZWFjaChwcm9wZXJ0aWVzIHx8IHt9LCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJSGFzaC5pbmNsdWRlKHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oa2V5KXsKCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBkZWxldGUgdGhpc1trZXldOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKGtleSl7CgkJcmV0dXJuICh0aGlzLmhhc093blByb3BlcnR5KGtleSkpID8gdGhpc1trZXldIDogbnVsbDsKCX0sCgoJc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAoIXRoaXNba2V5XSB8fCB0aGlzLmhhc093blByb3BlcnR5KGtleSkpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQlIYXNoLmVhY2godGhpcywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWRlbGV0ZSB0aGlzW2tleV07CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluY2x1ZGU6IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJCWlmICh0aGlzW2tleV0gPT0gbnVsbCkgdGhpc1trZXldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCW1hcDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBuZXcgSGFzaChPYmplY3QubWFwKHRoaXMsIGZuLCBiaW5kKSk7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBuZXcgSGFzaChPYmplY3QuZmlsdGVyKHRoaXMsIGZuLCBiaW5kKSk7Cgl9LAoKCWV2ZXJ5OiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5ldmVyeSh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gT2JqZWN0LnNvbWUodGhpcywgZm4sIGJpbmQpOwoJfSwKCglnZXRLZXlzOiBmdW5jdGlvbigpewoJCXJldHVybiBPYmplY3Qua2V5cyh0aGlzKTsKCX0sCgoJZ2V0VmFsdWVzOiBmdW5jdGlvbigpewoJCXJldHVybiBPYmplY3QudmFsdWVzKHRoaXMpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gT2JqZWN0LnRvUXVlcnlTdHJpbmcodGhpcywgYmFzZSk7Cgl9Cgp9KTsKCkhhc2guZXh0ZW5kID0gT2JqZWN0LmFwcGVuZDsKCkhhc2guYWxpYXMoe2luZGV4T2Y6ICdrZXlPZicsIGNvbnRhaW5zOiAnaGFzVmFsdWUnfSk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCi8vPDEuMmNvbXBhdD4KCmlmIChCcm93c2VyLlBsYXRmb3JtLmlvcykgQnJvd3Nlci5QbGF0Zm9ybS5pcG9kID0gdHJ1ZTsKCkJyb3dzZXIuRW5naW5lID0ge307Cgp2YXIgc2V0RW5naW5lID0gZnVuY3Rpb24obmFtZSwgdmVyc2lvbil7CglCcm93c2VyLkVuZ2luZS5uYW1lID0gbmFtZTsKCUJyb3dzZXIuRW5naW5lW25hbWUgKyB2ZXJzaW9uXSA9IHRydWU7CglCcm93c2VyLkVuZ2luZS52ZXJzaW9uID0gdmVyc2lvbjsKfTsKCmlmIChCcm93c2VyLmllKXsKCUJyb3dzZXIuRW5naW5lLnRyaWRlbnQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDY6IHNldEVuZ2luZSgndHJpZGVudCcsIDQpOyBicmVhazsKCQljYXNlIDc6IHNldEVuZ2luZSgndHJpZGVudCcsIDUpOyBicmVhazsKCQljYXNlIDg6IHNldEVuZ2luZSgndHJpZGVudCcsIDYpOwoJfQp9CgppZiAoQnJvd3Nlci5maXJlZm94KXsKCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDMpIHNldEVuZ2luZSgnZ2Vja28nLCAxOSk7CgllbHNlIHNldEVuZ2luZSgnZ2Vja28nLCAxOCk7Cn0KCmlmIChCcm93c2VyLnNhZmFyaSB8fCBCcm93c2VyLmNocm9tZSl7CglCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDI6IHNldEVuZ2luZSgnd2Via2l0JywgNDE5KTsgYnJlYWs7CgkJY2FzZSAzOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQyMCk7IGJyZWFrOwoJCWNhc2UgNDogc2V0RW5naW5lKCd3ZWJraXQnLCA1MjUpOwoJfQp9CgppZiAoQnJvd3Nlci5vcGVyYSl7CglCcm93c2VyLkVuZ2luZS5wcmVzdG8gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gOS42KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk2MCk7CgllbHNlIGlmIChCcm93c2VyLnZlcnNpb24gPj0gOS41KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk1MCk7CgllbHNlIHNldEVuZ2luZSgncHJlc3RvJywgOTI1KTsKfQoKaWYgKEJyb3dzZXIubmFtZSA9PSAndW5rbm93bicpewoJc3dpdGNoICgodWEubWF0Y2goLyg/OndlYmtpdHxraHRtbHxnZWNrbykvKSB8fCBbXSlbMF0pewoJCWNhc2UgJ3dlYmtpdCc6CgkJY2FzZSAna2h0bWwnOgoJCQlCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoJCWJyZWFrOwoJCWNhc2UgJ2dlY2tvJzoKCQkJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoJfQp9Cgp0aGlzLiRleGVjID0gQnJvd3Nlci5leGVjOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFdmVudAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBFdmVudCBDbGFzcywgdG8gbWFrZSB0aGUgZXZlbnQgb2JqZWN0IGNyb3NzLWJyb3dzZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIEZ1bmN0aW9uLCBTdHJpbmcsIE9iamVjdF0KCnByb3ZpZGVzOiBFdmVudAoKLi4uCiovCgp2YXIgRXZlbnQgPSBuZXcgVHlwZSgnRXZlbnQnLCBmdW5jdGlvbihldmVudCwgd2luKXsKCWlmICghd2luKSB3aW4gPSB3aW5kb3c7Cgl2YXIgZG9jID0gd2luLmRvY3VtZW50OwoJZXZlbnQgPSBldmVudCB8fCB3aW4uZXZlbnQ7CglpZiAoZXZlbnQuJGV4dGVuZGVkKSByZXR1cm4gZXZlbnQ7Cgl0aGlzLiRleHRlbmRlZCA9IHRydWU7Cgl2YXIgdHlwZSA9IGV2ZW50LnR5cGUsCgkJdGFyZ2V0ID0gZXZlbnQudGFyZ2V0IHx8IGV2ZW50LnNyY0VsZW1lbnQsCgkJcGFnZSA9IHt9LAoJCWNsaWVudCA9IHt9OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgIT0gLTEpewoJCXZhciBjb2RlID0gZXZlbnQud2hpY2ggfHwgZXZlbnQua2V5Q29kZTsKCQl2YXIga2V5ID0gT2JqZWN0LmtleU9mKEV2ZW50LktleXMsIGNvZGUpOwoJCWlmICh0eXBlID09ICdrZXlkb3duJyl7CgkJCXZhciBmS2V5ID0gY29kZSAtIDExMTsKCQkJaWYgKGZLZXkgPiAwICYmIGZLZXkgPCAxMykga2V5ID0gJ2YnICsgZktleTsKCQl9CgkJaWYgKCFrZXkpIGtleSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoY29kZSkudG9Mb3dlckNhc2UoKTsKCX0gZWxzZSBpZiAodHlwZS50ZXN0KC9jbGlja3xtb3VzZXxtZW51L2kpKXsKCQlkb2MgPSAoIWRvYy5jb21wYXRNb2RlIHx8IGRvYy5jb21wYXRNb2RlID09ICdDU1MxQ29tcGF0JykgPyBkb2MuaHRtbCA6IGRvYy5ib2R5OwoJCXBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQljbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAodHlwZS50ZXN0KC9ET01Nb3VzZVNjcm9sbHxtb3VzZXdoZWVsLykpewoJCQl2YXIgd2hlZWwgPSAoZXZlbnQud2hlZWxEZWx0YSkgPyBldmVudC53aGVlbERlbHRhIC8gMTIwIDogLShldmVudC5kZXRhaWwgfHwgMCkgLyAzOwoJCX0KCQl2YXIgcmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpLAoJCQlyZWxhdGVkID0gbnVsbDsKCQlpZiAodHlwZS50ZXN0KC9vdmVyfG91dC8pKXsKCQkJcmVsYXRlZCA9IGV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgZXZlbnRbKHR5cGUgPT0gJ21vdXNlb3ZlcicgPyAnZnJvbScgOiAndG8nKSArICdFbGVtZW50J107CgkJCXZhciB0ZXN0UmVsYXRlZCA9IGZ1bmN0aW9uKCl7CgkJCQl3aGlsZSAocmVsYXRlZCAmJiByZWxhdGVkLm5vZGVUeXBlID09IDMpIHJlbGF0ZWQgPSByZWxhdGVkLnBhcmVudE5vZGU7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfTsKCQkJdmFyIGhhc1JlbGF0ZWQgPSAoQnJvd3Nlci5maXJlZm94MikgPyB0ZXN0UmVsYXRlZC5hdHRlbXB0KCkgOiB0ZXN0UmVsYXRlZCgpOwoJCQlyZWxhdGVkID0gKGhhc1JlbGF0ZWQpID8gcmVsYXRlZCA6IG51bGw7CgkJfQoJfSBlbHNlIGlmICh0eXBlLnRlc3QoL2dlc3R1cmV8dG91Y2gvaSkpewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQlwYWdlID0ge3g6IHRvdWNoLnBhZ2VYLCB5OiB0b3VjaC5wYWdlWX07CgkJCWNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJcmV0dXJuIE9iamVjdC5hcHBlbmQodGhpcywgewoJCWV2ZW50OiBldmVudCwKCQl0eXBlOiB0eXBlLAoKCQlwYWdlOiBwYWdlLAoJCWNsaWVudDogY2xpZW50LAoJCXJpZ2h0Q2xpY2s6IHJpZ2h0Q2xpY2ssCgoJCXdoZWVsOiB3aGVlbCwKCgkJcmVsYXRlZFRhcmdldDogZG9jdW1lbnQuaWQocmVsYXRlZCksCgkJdGFyZ2V0OiBkb2N1bWVudC5pZCh0YXJnZXQpLAoKCQljb2RlOiBjb2RlLAoJCWtleToga2V5LAoKCQlzaGlmdDogZXZlbnQuc2hpZnRLZXksCgkJY29udHJvbDogZXZlbnQuY3RybEtleSwKCQlhbHQ6IGV2ZW50LmFsdEtleSwKCQltZXRhOiBldmVudC5tZXRhS2V5Cgl9KTsKfSk7CgpFdmVudC5LZXlzID0gewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfTsKCi8vPDEuMmNvbXBhdD4KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8vPC8xLjJjb21wYXQ+CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgQ2xhc3MgRnVuY3Rpb24gZm9yIGVhc2lseSBjcmVhdGluZywgZXh0ZW5kaW5nLCBhbmQgaW1wbGVtZW50aW5nIHJldXNhYmxlIENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlcl0KCnByb3ZpZGVzOiBDbGFzcwoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBDbGFzcyA9IHRoaXMuQ2xhc3MgPSBuZXcgVHlwZSgnQ2xhc3MnLCBmdW5jdGlvbihwYXJhbXMpewoJaWYgKGluc3RhbmNlT2YocGFyYW1zLCBGdW5jdGlvbikpIHBhcmFtcyA9IHtpbml0aWFsaXplOiBwYXJhbXN9OwoKCXZhciBuZXdDbGFzcyA9IGZ1bmN0aW9uKCl7CgkJcmVzZXQodGhpcyk7CgkJaWYgKG5ld0NsYXNzLiRwcm90b3R5cGluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gbnVsbDsKCQl2YXIgdmFsdWUgPSAodGhpcy5pbml0aWFsaXplKSA/IHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpczsKCQl0aGlzLiRjYWxsZXIgPSB0aGlzLmNhbGxlciA9IG51bGw7CgkJcmV0dXJuIHZhbHVlOwoJfS5leHRlbmQodGhpcykuaW1wbGVtZW50KHBhcmFtcyk7CgoJbmV3Q2xhc3MuJGNvbnN0cnVjdG9yID0gQ2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUucGFyZW50ID0gcGFyZW50OwoKCXJldHVybiBuZXdDbGFzczsKfSk7Cgp2YXIgcGFyZW50ID0gZnVuY3Rpb24oKXsKCWlmICghdGhpcy4kY2FsbGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgInBhcmVudCIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCXZhciBuYW1lID0gdGhpcy4kY2FsbGVyLiRuYW1lLAoJCXBhcmVudCA9IHRoaXMuJGNhbGxlci4kb3duZXIucGFyZW50LAoJCXByZXZpb3VzID0gKHBhcmVudCkgPyBwYXJlbnQucHJvdG90eXBlW25hbWVdIDogbnVsbDsKCWlmICghcHJldmlvdXMpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIG5hbWUgKyAnIiBoYXMgbm8gcGFyZW50LicpOwoJcmV0dXJuIHByZXZpb3VzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07Cgp2YXIgcmVzZXQgPSBmdW5jdGlvbihvYmplY3QpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJc3dpdGNoICh0eXBlT2YodmFsdWUpKXsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCXZhciBGID0gZnVuY3Rpb24oKXt9OwoJCQkJRi5wcm90b3R5cGUgPSB2YWx1ZTsKCQkJCW9iamVjdFtrZXldID0gcmVzZXQobmV3IEYpOwoJCQlicmVhazsKCQkJY2FzZSAnYXJyYXknOiBvYmplY3Rba2V5XSA9IHZhbHVlLmNsb25lKCk7IGJyZWFrOwoJCX0KCX0KCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgd3JhcCA9IGZ1bmN0aW9uKHNlbGYsIGtleSwgbWV0aG9kKXsKCWlmIChtZXRob2QuJG9yaWdpbikgbWV0aG9kID0gbWV0aG9kLiRvcmlnaW47Cgl2YXIgd3JhcHBlciA9IGZ1bmN0aW9uKCl7CgkJaWYgKG1ldGhvZC4kcHJvdGVjdGVkICYmIHRoaXMuJGNhbGxlciA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBrZXkgKyAnIiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJCXZhciBjYWxsZXIgPSB0aGlzLmNhbGxlciwgY3VycmVudCA9IHRoaXMuJGNhbGxlcjsKCQl0aGlzLmNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuJGNhbGxlciA9IHdyYXBwZXI7CgkJdmFyIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCXRoaXMuJGNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuY2FsbGVyID0gY2FsbGVyOwoJCXJldHVybiByZXN1bHQ7Cgl9LmV4dGVuZCh7JG93bmVyOiBzZWxmLCAkb3JpZ2luOiBtZXRob2QsICRuYW1lOiBrZXl9KTsKCXJldHVybiB3cmFwcGVyOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHJldGFpbil7CglpZiAoQ2xhc3MuTXV0YXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSl7CgkJdmFsdWUgPSBDbGFzcy5NdXRhdG9yc1trZXldLmNhbGwodGhpcywgdmFsdWUpOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpczsKCX0KCglpZiAodHlwZU9mKHZhbHVlKSA9PSAnZnVuY3Rpb24nKXsKCQlpZiAodmFsdWUuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcm90b3R5cGVba2V5XSA9IChyZXRhaW4pID8gdmFsdWUgOiB3cmFwKHRoaXMsIGtleSwgdmFsdWUpOwoJfSBlbHNlIHsKCQlPYmplY3QubWVyZ2UodGhpcy5wcm90b3R5cGUsIGtleSwgdmFsdWUpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKdmFyIGdldEluc3RhbmNlID0gZnVuY3Rpb24oa2xhc3MpewoJa2xhc3MuJHByb3RvdHlwaW5nID0gdHJ1ZTsKCXZhciBwcm90byA9IG5ldyBrbGFzczsKCWRlbGV0ZSBrbGFzcy4kcHJvdG90eXBpbmc7CglyZXR1cm4gcHJvdG87Cn07CgpDbGFzcy5pbXBsZW1lbnQoJ2ltcGxlbWVudCcsIGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpKTsKCkNsYXNzLk11dGF0b3JzID0gewoKCUV4dGVuZHM6IGZ1bmN0aW9uKHBhcmVudCl7CgkJdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CgkJdGhpcy5wcm90b3R5cGUgPSBnZXRJbnN0YW5jZShwYXJlbnQpOwoJfSwKCglJbXBsZW1lbnRzOiBmdW5jdGlvbihpdGVtcyl7CgkJQXJyYXkuZnJvbShpdGVtcykuZWFjaChmdW5jdGlvbihpdGVtKXsKCQkJdmFyIGluc3RhbmNlID0gbmV3IGl0ZW07CgkJCWZvciAodmFyIGtleSBpbiBpbnN0YW5jZSkgaW1wbGVtZW50LmNhbGwodGhpcywga2V5LCBpbnN0YW5jZVtrZXldLCB0cnVlKTsKCQl9LCB0aGlzKTsKCX0KfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAoIXRoaXMuYWRkRXZlbnQpIHJldHVybiB0aGlzOwoJCWZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLlBhcnNlcgpkZXNjcmlwdGlvbjogU3RhbmRhbG9uZSBDU1MzIFNlbGVjdG9yIHBhcnNlcgpwcm92aWRlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7U2xpY2s6IHRydWUsIGV4cHJlc3Npb25zOiBbXSwgcmF3OiBleHByZXNzaW9uLCByZXZlcnNlOiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7Cgl9fTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCAiXFwkJiIpOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXw6Kyg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEyXSopXFwxMil8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZQoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge307CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8IChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnKTsKfTsKCmxvY2FsLnNldERvY3VtZW50ID0gZnVuY3Rpb24oZG9jdW1lbnQpewoKCS8vIGNvbnZlcnQgZWxlbWVudHMgLyB3aW5kb3cgYXJndW1lbnRzIHRvIGRvY3VtZW50LiBpZiBkb2N1bWVudCBjYW5ub3QgYmUgZXh0cmFwb2xhdGVkLCB0aGUgZnVuY3Rpb24gcmV0dXJucy4KCglpZiAoZG9jdW1lbnQubm9kZVR5cGUgPT09IDkpOyAvLyBkb2N1bWVudAoJZWxzZSBpZiAoZG9jdW1lbnQub3duZXJEb2N1bWVudCkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7Cgl2YXIgcm9vdCA9IHRoaXMucm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgl0aGlzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCgl0aGlzLmJyb2tlblN0YXJHRUJUTgoJPSB0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IHRoaXMuaWRHZXRzTmFtZQoJPSB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJPSB0aGlzLmJyb2tlbkdFQkNOCgk9IHRoaXMuYnJva2VuQ2hlY2tlZFFTQQoJPSB0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBCgk9IHRoaXMuaXNIVE1MRG9jdW1lbnQKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lOwoKCXZhciBzZWxlY3RlZCwgaWQ7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCXJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQlpZCA9ICdzbGlja19nZXRieWlkX3Rlc3QnOwoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQl0aGlzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMCk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJdGhpcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQlpZiAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCkgdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQl0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBID0gKHNlbGVjdGVkICYmIHNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQlpZCA9ICdzbGlja19pZF9nZXRzX25hbWUnOwoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJytpZCsnIj48L2E+PGIgaWQ9IicraWQrJyI+PC9iPic7CgkJCXRoaXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJNaVhlZENhU2UiPjwvYT4nOwoJCQl0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYZWRDYVNlJykubGVuZ3RoOwoJCX0gY2F0Y2goZSl7fTsKCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCX0gY2F0Y2goZSl7fTsKCgkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJfSBjYXRjaChlKXt9OwoKCQl0aGlzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQkKCQkvLyBXZWJraXQgZG9udCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9ucyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQl0aGlzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJfSBjYXRjaChlKXt9OwoJCQoJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iIj48L2E+JzsKCQkJdGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQl9IGNhdGNoKGUpe307CgkJCgl9CgoJcm9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IG51bGw7CgoJLy8gaGFzQXR0cmlidXRlCgoJdGhpcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXRoaXMuY29udGFpbnMgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSkgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dC5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJdGhpcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJdGhpcy5nZXRVSUQgPSAodGhpcy5pc0hUTUxEb2N1bWVudCkgPyB0aGlzLmdldFVJREhUTUwgOiB0aGlzLmdldFVJRFhNTDsKCn07CgovLyBNYWluIE1ldGhvZAoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJLy8gY29udGV4dCBjaGVja3MKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsgLy8gTm8gY29udGV4dAoJaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7IC8vIFJlamVjdCBtaXNjIGp1bmsgaW5wdXQKCgkvLyBzZXR1cAoKCXZhciBwYXJzZWQsIGk7CgoJdmFyIHVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSkgdGhpcy5zZXREb2N1bWVudChjb250ZXh0KTsKCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCS8vIHNob3VsZCByZW1vdmUgZHVwbGljYXRlcyBpZiBhcHBlbmQgYWxyZWFkeSBoYXMgaXRlbXMKCXZhciBzaG91bGRVbmlxdWVzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKHNob3VsZFVuaXF1ZXMpIGZvciAoaSA9IGZvdW5kLmxlbmd0aDsgaS0tOykgdGhpcy51bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvLyBPdmVycmlkZXMKCgkJZm9yIChpID0gdGhpcy5vdmVycmlkZXMubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG92ZXJyaWRlID0gdGhpcy5vdmVycmlkZXNbaV07CgkJCWlmIChvdmVycmlkZS5yZWdleHAudGVzdChleHByZXNzaW9uKSl7CgkJCQl2YXIgcmVzdWx0ID0gb3ZlcnJpZGUubWV0aG9kLmNhbGwoY29udGV4dCwgZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KTsKCQkJCWlmIChyZXN1bHQgPT09IGZhbHNlKSBjb250aW51ZTsKCQkJCWlmIChyZXN1bHQgPT09IHRydWUpIHJldHVybiBmb3VuZDsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQl9CgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghc2hvdWxkVW5pcXVlcyAmJiAoZmlyc3QgfHwgKHBhcnNlZC5sZW5ndGggPT0gMSAmJiBwYXJzZWQuZXhwcmVzc2lvbnNbMF0ubGVuZ3RoID09IDEpKSkgPyB0aGlzLnB1c2hBcnJheSA6IHRoaXMucHVzaFVJRDsKCglpZiAoZm91bmQgPT0gbnVsbCkgZm91bmQgPSBbXTsKCgkvLyBkZWZhdWx0IGVuZ2luZQoKCXZhciBqLCBtLCBuOwoJdmFyIGNvbWJpbmF0b3IsIHRhZywgaWQsIGNsYXNzTGlzdCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvczsKCXZhciBjdXJyZW50SXRlbXMsIGN1cnJlbnRFeHByZXNzaW9uLCBjdXJyZW50Qml0LCBsYXN0Qml0LCBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9uczsKCglzZWFyY2g6IGZvciAoaSA9IDA7IChjdXJyZW50RXhwcmVzc2lvbiA9IGV4cHJlc3Npb25zW2ldKTsgaSsrKSBmb3IgKGogPSAwOyAoY3VycmVudEJpdCA9IGN1cnJlbnRFeHByZXNzaW9uW2pdKTsgaisrKXsKCgkJY29tYmluYXRvciA9ICdjb21iaW5hdG9yOicgKyBjdXJyZW50Qml0LmNvbWJpbmF0b3I7CgkJaWYgKCF0aGlzW2NvbWJpbmF0b3JdKSBjb250aW51ZSBzZWFyY2g7CgoJCXRhZyAgICAgICAgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IGN1cnJlbnRCaXQudGFnIDogY3VycmVudEJpdC50YWcudG9VcHBlckNhc2UoKTsKCQlpZCAgICAgICAgID0gY3VycmVudEJpdC5pZDsKCQljbGFzc0xpc3QgID0gY3VycmVudEJpdC5jbGFzc0xpc3Q7CgkJY2xhc3NlcyAgICA9IGN1cnJlbnRCaXQuY2xhc3NlczsKCQlhdHRyaWJ1dGVzID0gY3VycmVudEJpdC5hdHRyaWJ1dGVzOwoJCXBzZXVkb3MgICAgPSBjdXJyZW50Qml0LnBzZXVkb3M7CgkJbGFzdEJpdCAgICA9IChqID09PSAoY3VycmVudEV4cHJlc3Npb24ubGVuZ3RoIC0gMSkpOwoKCQl0aGlzLmJpdFVuaXF1ZXMgPSB7fTsKCgkJaWYgKGxhc3RCaXQpewoJCQl0aGlzLnVuaXF1ZXMgPSB1bmlxdWVzOwoJCQl0aGlzLmZvdW5kID0gZm91bmQ7CgkJfSBlbHNlIHsKCQkJdGhpcy51bmlxdWVzID0ge307CgkJCXRoaXMuZm91bmQgPSBbXTsKCQl9CgoJCWlmIChqID09PSAwKXsKCQkJdGhpc1tjb21iaW5hdG9yXShjb250ZXh0LCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCAmJiBmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQl9IGVsc2UgewoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCkgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspewoJCQkJdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCQlpZiAoZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJCX0gZWxzZSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKykgdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJfQoKCQljdXJyZW50SXRlbXMgPSB0aGlzLmZvdW5kOwoJfQoKCWlmIChzaG91bGRVbmlxdWVzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljazp1bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPT0gbm9kZU5hbWUpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0gZWxzZSB7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7Cgl2YXIgcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShzZWxlY3Rvcik7CglpZiAoIXBhcnNlZCkgcmV0dXJuIHRydWU7CgoJLy8gc2ltcGxlIChzaW5nbGUpIHNlbGVjdG9ycwoJaWYocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSl7CgkJdmFyIGV4cCA9IHBhcnNlZC5leHByZXNzaW9uc1swXVswXTsKCQlyZXR1cm4gdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKTsKCX0KCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpOwoJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBub2Rlc1tpKytdOyl7CgkJaWYgKGl0ZW0gPT09IG5vZGUpIHJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKbG9jYWwubWF0Y2hQc2V1ZG8gPSBmdW5jdGlvbihub2RlLCBuYW1lLCBhcmd1bWVudCl7Cgl2YXIgcHNldWRvTmFtZSA9ICdwc2V1ZG86JyArIG5hbWU7CglpZiAodGhpc1twc2V1ZG9OYW1lXSkgcmV0dXJuIHRoaXNbcHNldWRvTmFtZV0obm9kZSwgYXJndW1lbnQpOwoJdmFyIGF0dHJpYnV0ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwoJcmV0dXJuIChhcmd1bWVudCkgPyBhcmd1bWVudCA9PSBhdHRyaWJ1dGUgOiAhIWF0dHJpYnV0ZTsKfTsKCmxvY2FsLm1hdGNoU2VsZWN0b3IgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0YWcpewoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGUubm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZS5ub2RlTmFtZSAhPSB0YWcpIHJldHVybiBmYWxzZTsKCQl9Cgl9CgoJaWYgKGlkICYmIG5vZGUuZ2V0QXR0cmlidXRlKCdpZCcpICE9IGlkKSByZXR1cm4gZmFsc2U7CgoJdmFyIGksIHBhcnQsIGNsczsKCWlmIChjbGFzc2VzKSBmb3IgKGkgPSBjbGFzc2VzLmxlbmd0aDsgaS0tOyl7CgkJY2xzID0gKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgaWYgKGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgPT0gaWQpewoJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJYnJlYWs7CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT09IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlLmRpc2FibGVkID09PSBmYWxzZSk7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZS5kaXNhYmxlZCA9PT0gdHJ1ZSk7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gdGhpcykgPyB0aGlzLmNsYXNzTmFtZSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdodG1sRm9yJyBpbiB0aGlzKSA/IHRoaXMuaHRtbEZvciA6IHRoaXMuZ2V0QXR0cmlidXRlKCdmb3InKTsKCX0sCgoJJ2hyZWYnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2hyZWYnIGluIHRoaXMpID8gdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJyk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnN0eWxlKSA/IHRoaXMuc3R5bGUuY3NzVGV4dCA6IHRoaXMuZ2V0QXR0cmlidXRlKCdzdHlsZScpOwoJfQoKfTsKCmxvY2FsLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJLy8gRklYTUU6IGNoZWNrIGlmIGdldEF0dHJpYnV0ZSgpIHdpbGwgZ2V0IGlucHV0IGVsZW1lbnRzIG9uIGEgZm9ybSBvbiB0aGlzIGJyb3dzZXIKCS8vIGdldEF0dHJpYnV0ZSBpcyBmYXN0ZXIgdGhhbiBnZXRBdHRyaWJ1dGVOb2RlKCkubm9kZVZhbHVlCgl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJdmFyIGF0dHJpYnV0ZU5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CglyZXR1cm4gYXR0cmlidXRlTm9kZSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKfTsKCi8vIG92ZXJyaWRlcwoKbG9jYWwub3ZlcnJpZGVzID0gW107Cgpsb2NhbC5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgbWV0aG9kKXsKCXRoaXMub3ZlcnJpZGVzLnB1c2goe3JlZ2V4cDogcmVnZXhwLCBtZXRob2Q6IG1ldGhvZH0pOwp9OwoKLyo8b3ZlcnJpZGVzPiovCgovKjxxdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKdmFyIHJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuKlsqJF5dPSg/OlsiJ117Mn0pP1xdLzsKCmxvY2FsLm92ZXJyaWRlKC8uLywgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KXsgLy9xdWVyeVNlbGVjdG9yQWxsIG92ZXJyaWRlCgoJaWYgKCF0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwgfHwgdGhpcy5ub2RlVHlwZSAhPSA5IHx8ICFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCBsb2NhbC5icm9rZW5NaXhlZENhc2VRU0EgfHwKCShsb2NhbC5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJKGxvY2FsLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkgfHwgU2xpY2suZGlzYWJsZVFTQSkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2Rlcywgbm9kZTsKCXRyeSB7CgkJaWYgKGZpcnN0KSByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKGV4cHJlc3Npb24pIHx8IG51bGw7CgkJZWxzZSBub2RlcyA9IHRoaXMucXVlcnlTZWxlY3RvckFsbChleHByZXNzaW9uKTsKCX0gY2F0Y2goZXJyb3IpewoJCXJldHVybiBmYWxzZTsKCX0KCgl2YXIgaSwgaGFzT3RoZXJzID0gISEoZm91bmQubGVuZ3RoKTsKCglpZiAobG9jYWwuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKG5vZGUubm9kZU5hbWUgPiAnQCcgJiYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7Cgl9CgoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CgoJcmV0dXJuIHRydWU7Cgp9KTsKCi8qPC9xdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKLyo8dGFnLW92ZXJyaWRlPiovCgpsb2NhbC5vdmVycmlkZSgvXltcdy1dKyR8XlwqJC8sIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGZvdW5kLCBmaXJzdCl7IC8vIHRhZyBvdmVycmlkZQoJdmFyIHRhZyA9IGV4cHJlc3Npb247CglpZiAodGFnID09ICcqJyAmJiBsb2NhbC5icm9rZW5TdGFyR0VCVE4pIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgoJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCXZhciBpLCBub2RlLCBoYXNPdGhlcnMgPSAhIShmb3VuZC5sZW5ndGgpOwoKCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlEKG5vZGUpXSkgZm91bmQucHVzaChub2RlKTsKCX0KCglpZiAoaGFzT3RoZXJzKSBsb2NhbC5zb3J0KGZvdW5kKTsKCglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvdGFnLW92ZXJyaWRlPiovCgovKjxjbGFzcy1vdmVycmlkZT4qLwoKbG9jYWwub3ZlcnJpZGUoL15cLltcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBjbGFzcyBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCAoIXRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiB0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwpKSByZXR1cm4gZmFsc2U7CgoJdmFyIG5vZGVzLCBub2RlLCBpLCBoYXNPdGhlcnMgPSAhIShmb3VuZCAmJiBmb3VuZC5sZW5ndGgpLCBjbGFzc05hbWUgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKTsKCWlmICh0aGlzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIWxvY2FsLmJyb2tlbkdFQkNOKXsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwoJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfSBlbHNlIHsKCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArJyhcXHN8JCknKTsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQljbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKCQkJaWYgKCFjbGFzc05hbWUgfHwgIW1hdGNoQ2xhc3MudGVzdChjbGFzc05hbWUpKSBjb250aW51ZTsKCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfQoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiB0cnVlOwp9KTsKCi8qPC9jbGFzcy1vdmVycmlkZT4qLwoKLyo8aWQtb3ZlcnJpZGU+Ki8KCmxvY2FsLm92ZXJyaWRlKC9eI1tcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBJRCBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCB0aGlzLm5vZGVUeXBlICE9IDkpIHJldHVybiBmYWxzZTsKCgl2YXIgaWQgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKSwgZWwgPSB0aGlzLmdldEVsZW1lbnRCeUlkKGlkKTsKCWlmICghZWwpIHJldHVybiBmb3VuZDsKCWlmIChsb2NhbC5pZEdldHNOYW1lICYmIGVsLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSByZXR1cm4gZmFsc2U7CglpZiAoZmlyc3QpIHJldHVybiBlbCB8fCBudWxsOwoJdmFyIGhhc090aGVycyA9ICEhKGZvdW5kLmxlbmd0aCk7CglpZiAoIWhhc090aGVycyB8fCAhbG9jYWwudW5pcXVlc1tsb2NhbC5nZXRVSURIVE1MKGVsKV0pIGZvdW5kLnB1c2goZWwpOwoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvaWQtb3ZlcnJpZGU+Ki8KCi8qPC9vdmVycmlkZXM+Ki8KCmlmICh0eXBlb2YgZG9jdW1lbnQgIT0gJ3VuZGVmaW5lZCcpIGxvY2FsLnNldERvY3VtZW50KGRvY3VtZW50KTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMC45ZGV2JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCXJldHVybiBsb2NhbC5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWlmICh0eXBlb2Ygc2VsZWN0b3IgIT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoIXRhZy50ZXN0KC9eW1x3LV0rJC8pKXsKCQl2YXIgcGFyc2VkID0gU2xpY2sucGFyc2UodGFnKS5leHByZXNzaW9uc1swXVswXTsKCQl0YWcgPSAocGFyc2VkLnRhZyA9PSAnKicpID8gJ2RpdicgOiBwYXJzZWQudGFnOwoJCWlmIChwYXJzZWQuaWQgJiYgcHJvcHMuaWQgPT0gbnVsbCkgcHJvcHMuaWQgPSBwYXJzZWQuaWQ7CgoJCXZhciBhdHRyaWJ1dGVzID0gcGFyc2VkLmF0dHJpYnV0ZXM7CgkJaWYgKGF0dHJpYnV0ZXMpIGZvciAodmFyIGkgPSAwLCBsID0gYXR0cmlidXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChhdHRyLnZhbHVlICE9IG51bGwgJiYgYXR0ci5vcGVyYXRvciA9PSAnPScgJiYgcHJvcHNbYXR0ci5rZXldID09IG51bGwpCgkJCQlwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCX0KCgkJaWYgKHBhcnNlZC5jbGFzc0xpc3QgJiYgcHJvcHNbJ2NsYXNzJ10gPT0gbnVsbCkgcHJvcHNbJ2NsYXNzJ10gPSBwYXJzZWQuY2xhc3NMaXN0LmpvaW4oJyAnKTsKCX0KCglyZXR1cm4gZG9jdW1lbnQubmV3RWxlbWVudCh0YWcsIHByb3BzKTsKfTsKCmlmIChCcm93c2VyLkVsZW1lbnQpIEVsZW1lbnQucHJvdG90eXBlID0gQnJvd3Nlci5FbGVtZW50LnByb3RvdHlwZTsKCm5ldyBUeXBlKCdFbGVtZW50JywgRWxlbWVudCkubWlycm9yKGZ1bmN0aW9uKG5hbWUpewoJaWYgKEFycmF5LnByb3RvdHlwZVtuYW1lXSkgcmV0dXJuOwoKCXZhciBvYmogPSB7fTsKCW9ialtuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdHMgPSBbXSwgYXJncyA9IGFyZ3VtZW50cywgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IHRoaXNbaV0sIHJlc3VsdCA9IHJlc3VsdHNbaV0gPSBlbGVtZW50W25hbWVdLmFwcGx5KGVsZW1lbnQsIGFyZ3MpOwoJCQllbGVtZW50cyA9IChlbGVtZW50cyAmJiB0eXBlT2YocmVzdWx0KSA9PSAnZWxlbWVudCcpOwoJCX0KCQlyZXR1cm4gKGVsZW1lbnRzKSA/IG5ldyBFbGVtZW50cyhyZXN1bHRzKSA6IHJlc3VsdHM7Cgl9OwoKCUVsZW1lbnRzLmltcGxlbWVudChvYmopOwp9KTsKCmlmICghQnJvd3Nlci5FbGVtZW50KXsKCUVsZW1lbnQucGFyZW50ID0gT2JqZWN0OwoKCUVsZW1lbnQuUHJvdG90eXBlID0geyckZmFtaWx5JzogRnVuY3Rpb24uZnJvbSgnZWxlbWVudCcpLmhpZGUoKX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSBuZXcgSGFzaDsKCi8vPC8xLjJjb21wYXQ+Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcudW5pcXVlSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCQoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL15vYmplY3R8ZW1iZWQkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgooZnVuY3Rpb24oc2VhcmNoLCBmaW5kLCBtYXRjaCl7CgoJdGhpcy5TZWxlY3RvcnMgPSB7fTsKCXZhciBwc2V1ZG9zID0gdGhpcy5TZWxlY3RvcnMuUHNldWRvID0gbmV3IEhhc2goKTsKCgl2YXIgYWRkU2xpY2tQc2V1ZG9zID0gZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBuYW1lIGluIHBzZXVkb3MpIGlmIChwc2V1ZG9zLmhhc093blByb3BlcnR5KG5hbWUpKXsKCQkJU2xpY2suZGVmaW5lUHNldWRvKG5hbWUsIHBzZXVkb3NbbmFtZV0pOwoJCQlkZWxldGUgcHNldWRvc1tuYW1lXTsKCQl9Cgl9OwoKCVNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIHNlYXJjaC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cgl9OwoKCVNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gZmluZC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24pOwoJfTsKCglTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gbWF0Y2guY2FsbCh0aGlzLCBub2RlLCBzZWxlY3Rvcik7Cgl9OwoKfSkoU2xpY2suc2VhcmNoLCBTbGljay5maW5kLCBTbGljay5tYXRjaCk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJdmFyIGVsZW1lbnRzID0gbmV3IEVsZW1lbnRzOwoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIGVsZW1lbnRzKTsKCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmdzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGl0ZW0gPSBhcmdzW2ldOwoJCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goaXRlbSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgaXRlbSwgZWxlbWVudHMpOwoJCX0KCX0KCXJldHVybiBlbGVtZW50czsKfSk7CgovLzwvMS4yY29tcGF0PgoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCWlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIG5ldyBFbGVtZW50cyk7CgkJZWxzZSBpZiAoVHlwZS5pc0VudW1lcmFibGUoc2VsZWN0b3IpKSByZXR1cm4gbmV3IEVsZW1lbnRzKHNlbGVjdG9yKTsKCX0KCXJldHVybiBuZXcgRWxlbWVudHMoYXJndW1lbnRzKTsKfSk7CgooZnVuY3Rpb24oKXsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9Owp2YXIgcHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLmlubmVyVGV4dCA9PSBudWxsKSA/ICd0ZXh0Q29udGVudCcgOiAnaW5uZXJUZXh0JzsKCX0pKCkKfTsKdmFyIHJlYWRPbmx5ID0gWyd0eXBlJ107CnZhciBleHBhbmRvcyA9IFsndmFsdWUnLCAnZGVmYXVsdFZhbHVlJ107CnZhciB1cmlBdHRycyA9IC9eKD86aHJlZnxzcmN8dXNlbWFwKSQvaTsKCmJvb2xzID0gYm9vbHMuYXNzb2NpYXRlKGJvb2xzKTsKY2FtZWxzID0gY2FtZWxzLmFzc29jaWF0ZShjYW1lbHMubWFwKFN0cmluZy50b0xvd2VyQ2FzZSkpOwpyZWFkT25seSA9IHJlYWRPbmx5LmFzc29jaWF0ZShyZWFkT25seSk7CgpPYmplY3QuYXBwZW5kKGF0dHJpYnV0ZXMsIGV4cGFuZG9zLmFzc29jaWF0ZShleHBhbmRvcykpOwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpOwoJCXZhciBjbGVhbiA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQpewoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCWlmIChCcm93c2VyLmllKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQl2YXIgcHJvcCA9IHByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfTsKCgkJdmFyIGk7CgkJaWYgKGNvbnRlbnRzKXsKCQkJdmFyIGNlID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSwgdGUgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCWZvciAoaSA9IGNlLmxlbmd0aDsgaS0tOykgY2xlYW4oY2VbaV0sIHRlW2ldKTsKCQl9CgoJCWNsZWFuKGNsb25lLCB0aGlzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXZhciB0cyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLAoJCQkJY3MgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksCgkJCQl0bCA9IHRzLmxlbmd0aCwgY2wgPSBjcy5sZW5ndGg7CgkJCWZvciAoaSA9IDA7IGkgPCB0bCAmJiBpIDwgY2w7IGkrKykKCQkJCWNzW2ldLm91dGVySFRNTCA9IHRzW2ldLm91dGVySFRNTDsKCQl9CgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0sCgoJZGVzdHJveTogZnVuY3Rpb24oKXsKCQl2YXIgY2hpbGRyZW4gPSBjbGVhbih0aGlzKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCUFycmF5LmVhY2goY2hpbGRyZW4sIGNsZWFuKTsKCQlFbGVtZW50LmRpc3Bvc2UodGhpcyk7CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUFycmF5LmZyb20odGhpcy5jaGlsZE5vZGVzKS5lYWNoKEVsZW1lbnQuZGlzcG9zZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRpc3Bvc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnBhcmVudE5vZGUpID8gdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpIDogdGhpczsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkW3RoaXMudWlkXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKSwgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldOwoJCWlmIChkZmx0ICE9IG51bGwgJiYgcHJvcCA9PSBudWxsKSBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV0gPSBkZmx0OwoJCXJldHVybiBwcm9wICE9IG51bGwgPyBwcm9wIDogbnVsbDsKCX0sCgoJc3RvcmU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQodGhpcy51aWQpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKTsKdmFyIHJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldE9wYWNpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCWlmIChoYXNPcGFjaXR5KXsKCQllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwoJfSBlbHNlIHsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgPT0gMSkgPyAnJyA6ICdhbHBoYShvcGFjaXR5PScgKyBvcGFjaXR5ICogMTAwICsgJyknOwoJCXZhciBmaWx0ZXIgPSBlbGVtZW50LnN0eWxlLmZpbHRlciB8fCBlbGVtZW50LmdldENvbXB1dGVkU3R5bGUoJ2ZpbHRlcicpIHx8ICcnOwoJCWVsZW1lbnQuc3R5bGUuZmlsdGVyID0gZmlsdGVyLnRlc3QocmVBbHBoYSkgPyBmaWx0ZXIucmVwbGFjZShyZUFscGhhLCBvcGFjaXR5KSA6IGZpbHRlciArIG9wYWNpdHk7Cgl9Cn07CgpFbGVtZW50LlByb3BlcnRpZXMub3BhY2l0eSA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wYWNpdHkpewoJCXZhciB2aXNpYmlsaXR5ID0gdGhpcy5zdHlsZS52aXNpYmlsaXR5OwoJCWlmIChvcGFjaXR5ID09IDAgJiYgdmlzaWJpbGl0eSAhPSAnaGlkZGVuJykgdGhpcy5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CgkJZWxzZSBpZiAob3BhY2l0eSAhPSAwICYmIHZpc2liaWxpdHkgIT0gJ3Zpc2libGUnKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CgoJCXNldE9wYWNpdHkodGhpcywgb3BhY2l0eSk7Cgl9LAoKCWdldDogKGhhc09wYWNpdHkpID8gZnVuY3Rpb24oKXsKCQl2YXIgb3BhY2l0eSA9IHRoaXMuc3R5bGUub3BhY2l0eSB8fCB0aGlzLmdldENvbXB1dGVkU3R5bGUoJ29wYWNpdHknKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gJycpID8gMSA6IG9wYWNpdHk7Cgl9IDogZnVuY3Rpb24oKXsKCQl2YXIgb3BhY2l0eSwgZmlsdGVyID0gKHRoaXMuc3R5bGUuZmlsdGVyIHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykpOwoJCWlmIChmaWx0ZXIpIG9wYWNpdHkgPSBmaWx0ZXIubWF0Y2gocmVBbHBoYSk7CgkJcmV0dXJuIChvcGFjaXR5ID09IG51bGwgfHwgZmlsdGVyID09IG51bGwpID8gMSA6IChvcGFjaXR5WzFdIC8gMTAwKTsKCX0KCn07Cgp2YXIgZmxvYXROYW1lID0gKGh0bWwuc3R5bGUuY3NzRmxvYXQgPT0gbnVsbCkgPyAnc3R5bGVGbG9hdCcgOiAnY3NzRmxvYXQnOwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWdldENvbXB1dGVkU3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5KXsKCQlpZiAodGhpcy5jdXJyZW50U3R5bGUpIHJldHVybiB0aGlzLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eS5jYW1lbENhc2UoKV07CgkJdmFyIGRlZmF1bHRWaWV3ID0gRWxlbWVudC5nZXREb2N1bWVudCh0aGlzKS5kZWZhdWx0VmlldywKCQkJY29tcHV0ZWQgPSBkZWZhdWx0VmlldyA/IGRlZmF1bHRWaWV3LmdldENvbXB1dGVkU3R5bGUodGhpcywgbnVsbCkgOiBudWxsOwoJCXJldHVybiAoY29tcHV0ZWQpID8gY29tcHV0ZWQuZ2V0UHJvcGVydHlWYWx1ZSgocHJvcGVydHkgPT0gZmxvYXROYW1lKSA/ICdmbG9hdCcgOiBwcm9wZXJ0eS5oeXBoZW5hdGUoKSkgOiBudWxsOwoJfSwKCglzZXRPcGFjaXR5OiBmdW5jdGlvbih2YWx1ZSl7CgkJc2V0T3BhY2l0eSh0aGlzLCB2YWx1ZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldE9wYWNpdHk6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0KCdvcGFjaXR5Jyk7Cgl9LAoKCXNldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXN3aXRjaCAocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuc2V0KCdvcGFjaXR5JywgcGFyc2VGbG9hdCh2YWx1ZSkpOwoJCQljYXNlICdmbG9hdCc6IHByb3BlcnR5ID0gZmxvYXROYW1lOwoJCX0KCQlwcm9wZXJ0eSA9IHByb3BlcnR5LmNhbWVsQ2FzZSgpOwoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdzdHJpbmcnKXsKCQkJdmFyIG1hcCA9IChFbGVtZW50LlN0eWxlc1twcm9wZXJ0eV0gfHwgJ0AnKS5zcGxpdCgnICcpOwoJCQl2YWx1ZSA9IEFycmF5LmZyb20odmFsdWUpLm1hcChmdW5jdGlvbih2YWwsIGkpewoJCQkJaWYgKCFtYXBbaV0pIHJldHVybiAnJzsKCQkJCXJldHVybiAodHlwZU9mKHZhbCkgPT0gJ251bWJlcicpID8gbWFwW2ldLnJlcGxhY2UoJ0AnLCBNYXRoLnJvdW5kKHZhbCkpIDogdmFsOwoJCQl9KS5qb2luKCcgJyk7CgkJfSBlbHNlIGlmICh2YWx1ZSA9PSBTdHJpbmcoTnVtYmVyKHZhbHVlKSkpewoJCQl2YWx1ZSA9IE1hdGgucm91bmQodmFsdWUpOwoJCX0KCQl0aGlzLnN0eWxlW3Byb3BlcnR5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXN3aXRjaCAocHJvcGVydHkpewoJCQljYXNlICdvcGFjaXR5JzogcmV0dXJuIHRoaXMuZ2V0KCdvcGFjaXR5Jyk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJdmFyIHJlc3VsdCA9IHRoaXMuc3R5bGVbcHJvcGVydHldOwoJCWlmICghcmVzdWx0IHx8IHByb3BlcnR5ID09ICd6SW5kZXgnKXsKCQkJcmVzdWx0ID0gW107CgkJCWZvciAodmFyIHN0eWxlIGluIEVsZW1lbnQuU2hvcnRTdHlsZXMpewoJCQkJaWYgKHByb3BlcnR5ICE9IHN0eWxlKSBjb250aW51ZTsKCQkJCWZvciAodmFyIHMgaW4gRWxlbWVudC5TaG9ydFN0eWxlc1tzdHlsZV0pIHJlc3VsdC5wdXNoKHRoaXMuZ2V0U3R5bGUocykpOwoJCQkJcmV0dXJuIHJlc3VsdC5qb2luKCcgJyk7CgkJCX0KCQkJcmVzdWx0ID0gdGhpcy5nZXRDb21wdXRlZFN0eWxlKHByb3BlcnR5KTsKCQl9CgkJaWYgKHJlc3VsdCl7CgkJCXJlc3VsdCA9IFN0cmluZyhyZXN1bHQpOwoJCQl2YXIgY29sb3IgPSByZXN1bHQubWF0Y2goL3JnYmE/XChbXGRccyxdK1wpLyk7CgkJCWlmIChjb2xvcikgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoY29sb3JbMF0sIGNvbG9yWzBdLnJnYlRvSGV4KCkpOwoJCX0KCQlpZiAoQnJvd3Nlci5vcGVyYSB8fCAoQnJvd3Nlci5pZSAmJiBpc05hTihwYXJzZUZsb2F0KHJlc3VsdCkpKSl7CgkJCWlmIChwcm9wZXJ0eS50ZXN0KC9eKGhlaWdodHx3aWR0aCkkLykpewoJCQkJdmFyIHZhbHVlcyA9IChwcm9wZXJ0eSA9PSAnd2lkdGgnKSA/IFsnbGVmdCcsICdyaWdodCddIDogWyd0b3AnLCAnYm90dG9tJ10sIHNpemUgPSAwOwoJCQkJdmFsdWVzLmVhY2goZnVuY3Rpb24odmFsdWUpewoJCQkJCXNpemUgKz0gdGhpcy5nZXRTdHlsZSgnYm9yZGVyLScgKyB2YWx1ZSArICctd2lkdGgnKS50b0ludCgpICsgdGhpcy5nZXRTdHlsZSgncGFkZGluZy0nICsgdmFsdWUpLnRvSW50KCk7CgkJCQl9LCB0aGlzKTsKCQkJCXJldHVybiB0aGlzWydvZmZzZXQnICsgcHJvcGVydHkuY2FwaXRhbGl6ZSgpXSAtIHNpemUgKyAncHgnOwoJCQl9CgkJCWlmIChCcm93c2VyLm9wZXJhICYmIFN0cmluZyhyZXN1bHQpLmluZGV4T2YoJ3B4JykgIT0gLTEpIHJldHVybiByZXN1bHQ7CgkJCWlmIChwcm9wZXJ0eS50ZXN0KC8oYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nKS8pKSByZXR1cm4gJzBweCc7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCXNldFN0eWxlczogZnVuY3Rpb24oc3R5bGVzKXsKCQlmb3IgKHZhciBzdHlsZSBpbiBzdHlsZXMpIHRoaXMuc2V0U3R5bGUoc3R5bGUsIHN0eWxlc1tzdHlsZV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTdHlsZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdCA9IHt9OwoJCUFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKS5lYWNoKGZ1bmN0aW9uKGtleSl7CgkJCXJlc3VsdFtrZXldID0gdGhpcy5nZXRTdHlsZShrZXkpOwoJCX0sIHRoaXMpOwoJCXJldHVybiByZXN1bHQ7Cgl9Cgp9KTsKCkVsZW1lbnQuU3R5bGVzID0gewoJbGVmdDogJ0BweCcsIHRvcDogJ0BweCcsIGJvdHRvbTogJ0BweCcsIHJpZ2h0OiAnQHB4JywKCXdpZHRoOiAnQHB4JywgaGVpZ2h0OiAnQHB4JywgbWF4V2lkdGg6ICdAcHgnLCBtYXhIZWlnaHQ6ICdAcHgnLCBtaW5XaWR0aDogJ0BweCcsIG1pbkhlaWdodDogJ0BweCcsCgliYWNrZ3JvdW5kQ29sb3I6ICdyZ2IoQCwgQCwgQCknLCBiYWNrZ3JvdW5kUG9zaXRpb246ICdAcHggQHB4JywgY29sb3I6ICdyZ2IoQCwgQCwgQCknLAoJZm9udFNpemU6ICdAcHgnLCBsZXR0ZXJTcGFjaW5nOiAnQHB4JywgbGluZUhlaWdodDogJ0BweCcsIGNsaXA6ICdyZWN0KEBweCBAcHggQHB4IEBweCknLAoJbWFyZ2luOiAnQHB4IEBweCBAcHggQHB4JywgcGFkZGluZzogJ0BweCBAcHggQHB4IEBweCcsIGJvcmRlcjogJ0BweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCkgQHB4IEAgcmdiKEAsIEAsIEApJywKCWJvcmRlcldpZHRoOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyU3R5bGU6ICdAIEAgQCBAJywgYm9yZGVyQ29sb3I6ICdyZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKSByZ2IoQCwgQCwgQCknLAoJekluZGV4OiAnQCcsICd6b29tJzogJ0AnLCBmb250V2VpZ2h0OiAnQCcsIHRleHRJbmRlbnQ6ICdAcHgnLCBvcGFjaXR5OiAnQCcKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuU3R5bGVzID0gbmV3IEhhc2goRWxlbWVudC5TdHlsZXMpOwoKLy88LzEuMmNvbXBhdD4KCkVsZW1lbnQuU2hvcnRTdHlsZXMgPSB7bWFyZ2luOiB7fSwgcGFkZGluZzoge30sIGJvcmRlcjoge30sIGJvcmRlcldpZHRoOiB7fSwgYm9yZGVyU3R5bGU6IHt9LCBib3JkZXJDb2xvcjoge319OwoKWydUb3AnLCAnUmlnaHQnLCAnQm90dG9tJywgJ0xlZnQnXS5lYWNoKGZ1bmN0aW9uKGRpcmVjdGlvbil7Cgl2YXIgU2hvcnQgPSBFbGVtZW50LlNob3J0U3R5bGVzOwoJdmFyIEFsbCA9IEVsZW1lbnQuU3R5bGVzOwoJWydtYXJnaW4nLCAncGFkZGluZyddLmVhY2goZnVuY3Rpb24oc3R5bGUpewoJCXZhciBzZCA9IHN0eWxlICsgZGlyZWN0aW9uOwoJCVNob3J0W3N0eWxlXVtzZF0gPSBBbGxbc2RdID0gJ0BweCc7Cgl9KTsKCXZhciBiZCA9ICdib3JkZXInICsgZGlyZWN0aW9uOwoJU2hvcnQuYm9yZGVyW2JkXSA9IEFsbFtiZF0gPSAnQHB4IEAgcmdiKEAsIEAsIEApJzsKCXZhciBiZHcgPSBiZCArICdXaWR0aCcsIGJkcyA9IGJkICsgJ1N0eWxlJywgYmRjID0gYmQgKyAnQ29sb3InOwoJU2hvcnRbYmRdID0ge307CglTaG9ydC5ib3JkZXJXaWR0aFtiZHddID0gU2hvcnRbYmRdW2Jkd10gPSBBbGxbYmR3XSA9ICdAcHgnOwoJU2hvcnQuYm9yZGVyU3R5bGVbYmRzXSA9IFNob3J0W2JkXVtiZHNdID0gQWxsW2Jkc10gPSAnQCc7CglTaG9ydC5ib3JkZXJDb2xvcltiZGNdID0gU2hvcnRbYmRdW2JkY10gPSBBbGxbYmRjXSA9ICdyZ2IoQCwgQCwgQCknOwp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFdmVudF0KCnByb3ZpZGVzOiBFbGVtZW50LkV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpewoKRWxlbWVudC5Qcm9wZXJ0aWVzLmV2ZW50cyA9IHtzZXQ6IGZ1bmN0aW9uKGV2ZW50cyl7Cgl0aGlzLmFkZEV2ZW50cyhldmVudHMpOwp9fTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnLCB7fSk7CgkJaWYgKCFldmVudHNbdHlwZV0pIGV2ZW50c1t0eXBlXSA9IHtrZXlzOiBbXSwgdmFsdWVzOiBbXX07CgkJaWYgKGV2ZW50c1t0eXBlXS5rZXlzLmNvbnRhaW5zKGZuKSkgcmV0dXJuIHRoaXM7CgkJZXZlbnRzW3R5cGVdLmtleXMucHVzaChmbik7CgkJdmFyIHJlYWxUeXBlID0gdHlwZSwKCQkJY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV0sCgkJCWNvbmRpdGlvbiA9IGZuLAoJCQlzZWxmID0gdGhpczsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vbkFkZCkgY3VzdG9tLm9uQWRkLmNhbGwodGhpcywgZm4pOwoJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbil7CgkJCQljb25kaXRpb24gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJaWYgKGN1c3RvbS5jb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRoaXMsIGV2ZW50KTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX07CgkJCX0KCQkJcmVhbFR5cGUgPSBjdXN0b20uYmFzZSB8fCByZWFsVHlwZTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBJRTkKdHJ5IHsKCWlmICh0eXBlb2YgSFRNTEVsZW1lbnQgIT0gJ3VuZGVmaW5lZCcpCgkJSFRNTEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudCA9IEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudDsKfSBjYXRjaChlKXt9CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRpbWVuc2lvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBtZXRob2RzIHRvIHdvcmsgd2l0aCBzaXplLCBzY3JvbGwsIG9yIHBvc2l0aW9uaW5nIG9mIEVsZW1lbnRzIGFuZCB0aGUgd2luZG93IG9iamVjdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVsZW1lbnQgcG9zaXRpb25pbmcgYmFzZWQgb24gdGhlIFtxb294ZG9vXShodHRwOi8vcW9veGRvby5vcmcvKSBjb2RlIGFuZCBzbWFydCBicm93c2VyIGZpeGVzLCBbTEdQTCBMaWNlbnNlXShodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sKS4KICAtIFZpZXdwb3J0IGRpbWVuc2lvbnMgYmFzZWQgb24gW1lVSV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpLykgY29kZSwgW0JTRCBMaWNlbnNlXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvbGljZW5zZS5odG1sKS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBbRWxlbWVudC5EaW1lbnNpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCglzY3JvbGxUbzogZnVuY3Rpb24oeCwgeSl7CgkJaWYgKGlzQm9keSh0aGlzKSl7CgkJCXRoaXMuZ2V0V2luZG93KCkuc2Nyb2xsVG8oeCwgeSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zY3JvbGxMZWZ0ID0geDsKCQkJdGhpcy5zY3JvbGxUb3AgPSB5OwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLm9mZnNldFdpZHRoLCB5OiB0aGlzLm9mZnNldEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbFNpemU6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsU2l6ZSgpOwoJCXJldHVybiB7eDogdGhpcy5zY3JvbGxXaWR0aCwgeTogdGhpcy5zY3JvbGxIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHRoaXMuZ2V0V2luZG93KCkuZ2V0U2Nyb2xsKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbExlZnQsIHk6IHRoaXMuc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsczogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXMucGFyZW50Tm9kZSwgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJd2hpbGUgKGVsZW1lbnQgJiYgIWlzQm9keShlbGVtZW50KSl7CgkJCXBvc2l0aW9uLnggKz0gZWxlbWVudC5zY3JvbGxMZWZ0OwoJCQlwb3NpdGlvbi55ICs9IGVsZW1lbnQuc2Nyb2xsVG9wOwoJCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldE9mZnNldFBhcmVudDogZnVuY3Rpb24oKXsKCQl2YXIgZWxlbWVudCA9IHRoaXM7CgkJaWYgKGlzQm9keShlbGVtZW50KSkgcmV0dXJuIG51bGw7CgkJaWYgKCFCcm93c2VyLmllKSByZXR1cm4gZWxlbWVudC5vZmZzZXRQYXJlbnQ7CgkJd2hpbGUgKChlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlKSl7CgkJCWlmIChzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSAhPSAnc3RhdGljJyB8fCBpc0JvZHkoZWxlbWVudCkpIHJldHVybiBlbGVtZW50OwoJCX0KCQlyZXR1cm4gbnVsbDsKCX0sCgoJZ2V0T2Zmc2V0czogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QgJiYgIUJyb3dzZXIuUGxhdGZvcm0uaW9zKXsKCQkJdmFyIGJvdW5kID0gdGhpcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKSwKCQkJCWh0bWwgPSBkb2N1bWVudC5pZCh0aGlzLmdldERvY3VtZW50KCkuZG9jdW1lbnRFbGVtZW50KSwKCQkJCWh0bWxTY3JvbGwgPSBodG1sLmdldFNjcm9sbCgpLAoJCQkJZWxlbVNjcm9sbHMgPSB0aGlzLmdldFNjcm9sbHMoKSwKCQkJCWlzRml4ZWQgPSAoc3R5bGVTdHJpbmcodGhpcywgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJyk7CgoJCQlyZXR1cm4gewoJCQkJeDogYm91bmQubGVmdC50b0ludCgpICsgZWxlbVNjcm9sbHMueCArICgoaXNGaXhlZCkgPyAwIDogaHRtbFNjcm9sbC54KSAtIGh0bWwuY2xpZW50TGVmdCwKCQkJCXk6IGJvdW5kLnRvcC50b0ludCgpICArIGVsZW1TY3JvbGxzLnkgKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueSkgLSBodG1sLmNsaWVudFRvcAoJCQl9OwoJCX0KCgkJdmFyIGVsZW1lbnQgPSB0aGlzLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gcG9zaXRpb247CgoJCXdoaWxlIChlbGVtZW50ICYmICFpc0JvZHkoZWxlbWVudCkpewoJCQlwb3NpdGlvbi54ICs9IGVsZW1lbnQub2Zmc2V0TGVmdDsKCQkJcG9zaXRpb24ueSArPSBlbGVtZW50Lm9mZnNldFRvcDsKCgkJCWlmIChCcm93c2VyLmZpcmVmb3gpewoJCQkJaWYgKCFib3JkZXJCb3goZWxlbWVudCkpewoJCQkJCXBvc2l0aW9uLnggKz0gbGVmdEJvcmRlcihlbGVtZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJCX0KCQkJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJCQlpZiAocGFyZW50ICYmIHN0eWxlU3RyaW5nKHBhcmVudCwgJ292ZXJmbG93JykgIT0gJ3Zpc2libGUnKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIocGFyZW50KTsKCQkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihwYXJlbnQpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKGVsZW1lbnQgIT0gdGhpcyAmJiBCcm93c2VyLnNhZmFyaSl7CgkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQlwb3NpdGlvbi55ICs9IHRvcEJvcmRlcihlbGVtZW50KTsKCQkJfQoKCQkJZWxlbWVudCA9IGVsZW1lbnQub2Zmc2V0UGFyZW50OwoJCX0KCQlpZiAoQnJvd3Nlci5maXJlZm94ICYmICFib3JkZXJCb3godGhpcykpewoJCQlwb3NpdGlvbi54IC09IGxlZnRCb3JkZXIodGhpcyk7CgkJCXBvc2l0aW9uLnkgLT0gdG9wQm9yZGVyKHRoaXMpOwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbihyZWxhdGl2ZSl7CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHt4OiAwLCB5OiAwfTsKCQl2YXIgb2Zmc2V0ID0gdGhpcy5nZXRPZmZzZXRzKCksCgkJCXNjcm9sbCA9IHRoaXMuZ2V0U2Nyb2xscygpOwoJCXZhciBwb3NpdGlvbiA9IHsKCQkJeDogb2Zmc2V0LnggLSBzY3JvbGwueCwKCQkJeTogb2Zmc2V0LnkgLSBzY3JvbGwueQoJCX07CgkJCgkJaWYgKHJlbGF0aXZlICYmIChyZWxhdGl2ZSA9IGRvY3VtZW50LmlkKHJlbGF0aXZlKSkpewoJCQl2YXIgcmVsYXRpdmVQb3NpdGlvbiA9IHJlbGF0aXZlLmdldFBvc2l0aW9uKCk7CgkJCXJldHVybiB7eDogcG9zaXRpb24ueCAtIHJlbGF0aXZlUG9zaXRpb24ueCAtIGxlZnRCb3JkZXIocmVsYXRpdmUpLCB5OiBwb3NpdGlvbi55IC0gcmVsYXRpdmVQb3NpdGlvbi55IC0gdG9wQm9yZGVyKHJlbGF0aXZlKX07CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKGVsZW1lbnQpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldENvb3JkaW5hdGVzKCk7CgkJdmFyIHBvc2l0aW9uID0gdGhpcy5nZXRQb3NpdGlvbihlbGVtZW50KSwKCQkJc2l6ZSA9IHRoaXMuZ2V0U2l6ZSgpOwoJCXZhciBvYmogPSB7CgkJCWxlZnQ6IHBvc2l0aW9uLngsCgkJCXRvcDogcG9zaXRpb24ueSwKCQkJd2lkdGg6IHNpemUueCwKCQkJaGVpZ2h0OiBzaXplLnkKCQl9OwoJCW9iai5yaWdodCA9IG9iai5sZWZ0ICsgb2JqLndpZHRoOwoJCW9iai5ib3R0b20gPSBvYmoudG9wICsgb2JqLmhlaWdodDsKCQlyZXR1cm4gb2JqOwoJfSwKCgljb21wdXRlUG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHsKCQkJbGVmdDogb2JqLnggLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLWxlZnQnKSwKCQkJdG9wOiBvYmoueSAtIHN0eWxlTnVtYmVyKHRoaXMsICdtYXJnaW4tdG9wJykKCQl9OwoJfSwKCglzZXRQb3NpdGlvbjogZnVuY3Rpb24ob2JqKXsKCQlyZXR1cm4gdGhpcy5zZXRTdHlsZXModGhpcy5jb21wdXRlUG9zaXRpb24ob2JqKSk7Cgl9Cgp9KTsKCgpbRG9jdW1lbnQsIFdpbmRvd10uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0U2l6ZTogZnVuY3Rpb24oKXsKCQl2YXIgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKTsKCQlyZXR1cm4ge3g6IGRvYy5jbGllbnRXaWR0aCwgeTogZG9jLmNsaWVudEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbDogZnVuY3Rpb24oKXsKCQl2YXIgd2luID0gdGhpcy5nZXRXaW5kb3coKSwgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKTsKCQlyZXR1cm4ge3g6IHdpbi5wYWdlWE9mZnNldCB8fCBkb2Muc2Nyb2xsTGVmdCwgeTogd2luLnBhZ2VZT2Zmc2V0IHx8IGRvYy5zY3JvbGxUb3B9OwoJfSwKCglnZXRTY3JvbGxTaXplOiBmdW5jdGlvbigpewoJCXZhciBkb2MgPSBnZXRDb21wYXRFbGVtZW50KHRoaXMpLAoJCQltaW4gPSB0aGlzLmdldFNpemUoKSwKCQkJYm9keSA9IHRoaXMuZ2V0RG9jdW1lbnQoKS5ib2R5OwoKCQlyZXR1cm4ge3g6IE1hdGgubWF4KGRvYy5zY3JvbGxXaWR0aCwgYm9keS5zY3JvbGxXaWR0aCwgbWluLngpLCB5OiBNYXRoLm1heChkb2Muc2Nyb2xsSGVpZ2h0LCBib2R5LnNjcm9sbEhlaWdodCwgbWluLnkpfTsKCX0sCgoJZ2V0UG9zaXRpb246IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHt4OiAwLCB5OiAwfTsKCX0sCgoJZ2V0Q29vcmRpbmF0ZXM6IGZ1bmN0aW9uKCl7CgkJdmFyIHNpemUgPSB0aGlzLmdldFNpemUoKTsKCQlyZXR1cm4ge3RvcDogMCwgbGVmdDogMCwgYm90dG9tOiBzaXplLnksIHJpZ2h0OiBzaXplLngsIGhlaWdodDogc2l6ZS55LCB3aWR0aDogc2l6ZS54fTsKCX0KCn0pOwoKLy8gcHJpdmF0ZSBtZXRob2RzCgp2YXIgc3R5bGVTdHJpbmcgPSBFbGVtZW50LmdldENvbXB1dGVkU3R5bGU7CgpmdW5jdGlvbiBzdHlsZU51bWJlcihlbGVtZW50LCBzdHlsZSl7CglyZXR1cm4gc3R5bGVTdHJpbmcoZWxlbWVudCwgc3R5bGUpLnRvSW50KCkgfHwgMDsKfTsKCmZ1bmN0aW9uIGJvcmRlckJveChlbGVtZW50KXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCAnLW1vei1ib3gtc2l6aW5nJykgPT0gJ2JvcmRlci1ib3gnOwp9OwoKZnVuY3Rpb24gdG9wQm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItdG9wLXdpZHRoJyk7Cn07CgpmdW5jdGlvbiBsZWZ0Qm9yZGVyKGVsZW1lbnQpewoJcmV0dXJuIHN0eWxlTnVtYmVyKGVsZW1lbnQsICdib3JkZXItbGVmdC13aWR0aCcpOwp9OwoKZnVuY3Rpb24gaXNCb2R5KGVsZW1lbnQpewoJcmV0dXJuICgvXig/OmJvZHl8aHRtbCkkL2kpLnRlc3QoZWxlbWVudC50YWdOYW1lKTsKfTsKCmZ1bmN0aW9uIGdldENvbXBhdEVsZW1lbnQoZWxlbWVudCl7Cgl2YXIgZG9jID0gZWxlbWVudC5nZXREb2N1bWVudCgpOwoJcmV0dXJuICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7Cn07Cgp9KSgpOwoKLy9hbGlhc2VzCkVsZW1lbnQuYWxpYXMoe3Bvc2l0aW9uOiAnc2V0UG9zaXRpb24nfSk7IC8vY29tcGF0YWJpbGl0eQoKW1dpbmRvdywgRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEhlaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTaXplKCkueTsKCX0sCgoJZ2V0V2lkdGg6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2l6ZSgpLng7Cgl9LAoKCWdldFNjcm9sbFRvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS55OwoJfSwKCglnZXRTY3JvbGxMZWZ0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbCgpLng7Cgl9LAoKCWdldFNjcm9sbEhlaWdodDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGxTaXplKCkueTsKCX0sCgoJZ2V0U2Nyb2xsV2lkdGg6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsU2l6ZSgpLng7Cgl9LAoKCWdldFRvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRQb3NpdGlvbigpLnk7Cgl9LAoKCWdldExlZnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0UG9zaXRpb24oKS54OwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeAoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBiYXNpYyBhbmltYXRpb24gbG9naWMgdG8gYmUgZXh0ZW5kZWQgYnkgYWxsIG90aGVyIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCnByb3ZpZGVzOiBGeAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBGeCA9IHRoaXMuRnggPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7CgkJLyoKCQlvblN0YXJ0OiBuaWwsCgkJb25DYW5jZWw6IG5pbCwKCQlvbkNvbXBsZXRlOiBuaWwsCgkJKi8KCQlmcHM6IDUwLAoJCXVuaXQ6IGZhbHNlLAoJCWR1cmF0aW9uOiA1MDAsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKCl7CgkJdmFyIHRpbWUgPSBEYXRlLm5vdygpOwoJCWlmICh0aW1lIDwgdGhpcy50aW1lICsgdGhpcy5vcHRpb25zLmR1cmF0aW9uKXsKCQkJdmFyIGRlbHRhID0gdGhpcy50cmFuc2l0aW9uKCh0aW1lIC0gdGhpcy50aW1lKSAvIHRoaXMub3B0aW9ucy5kdXJhdGlvbik7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIGRlbHRhKSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5zZXQodGhpcy5jb21wdXRlKHRoaXMuZnJvbSwgdGhpcy50bywgMSkpOwoJCQl0aGlzLmNvbXBsZXRlKCk7CgkJfQoJfSwKCglzZXQ6IGZ1bmN0aW9uKG5vdyl7CgkJcmV0dXJuIG5vdzsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQlyZXR1cm4gRnguY29tcHV0ZShmcm9tLCB0bywgZGVsdGEpOwoJfSwKCgljaGVjazogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMudGltZXIpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglzdGFydDogZnVuY3Rpb24oZnJvbSwgdG8pewoJCWlmICghdGhpcy5jaGVjayhmcm9tLCB0bykpIHJldHVybiB0aGlzOwoJCXZhciBkdXJhdGlvbiA9IHRoaXMub3B0aW9ucy5kdXJhdGlvbjsKCQl0aGlzLm9wdGlvbnMuZHVyYXRpb24gPSBGeC5EdXJhdGlvbnNbZHVyYXRpb25dIHx8IGR1cmF0aW9uLnRvSW50KCk7CgkJdGhpcy5mcm9tID0gZnJvbTsKCQl0aGlzLnRvID0gdG87CgkJdGhpcy50aW1lID0gMDsKCQl0aGlzLnRyYW5zaXRpb24gPSB0aGlzLmdldFRyYW5zaXRpb24oKTsKCQl0aGlzLnN0YXJ0VGltZXIoKTsKCQl0aGlzLm9uU3RhcnQoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcGxldGU6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuc3RvcFRpbWVyKCkpIHRoaXMub25Db21wbGV0ZSgpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuc3RvcFRpbWVyKCkpIHRoaXMub25DYW5jZWwoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJb25TdGFydDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnc3RhcnQnLCB0aGlzLnN1YmplY3QpOwoJfSwKCglvbkNvbXBsZXRlOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIHRoaXMuc3ViamVjdCk7CgkJaWYgKCF0aGlzLmNhbGxDaGFpbigpKSB0aGlzLmZpcmVFdmVudCgnY2hhaW5Db21wbGV0ZScsIHRoaXMuc3ViamVjdCk7Cgl9LAoKCW9uQ2FuY2VsOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnLCB0aGlzLnN1YmplY3QpLmNsZWFyQ2hhaW4oKTsKCX0sCgoJcGF1c2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdG9wVGltZXIoKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVzdW1lOiBmdW5jdGlvbigpewoJCXRoaXMuc3RhcnRUaW1lcigpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdG9wVGltZXI6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnRpbWVyKSByZXR1cm4gZmFsc2U7CgkJdGhpcy50aW1lID0gRGF0ZS5ub3coKSAtIHRoaXMudGltZTsKCQl0aGlzLnRpbWVyID0gcmVtb3ZlSW5zdGFuY2UodGhpcyk7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXN0YXJ0VGltZXI6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMudGltZXIpIHJldHVybiBmYWxzZTsKCQl0aGlzLnRpbWUgPSBEYXRlLm5vdygpIC0gdGhpcy50aW1lOwoJCXRoaXMudGltZXIgPSBhZGRJbnN0YW5jZSh0aGlzKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJaWYgKHRoaXNbaV0pIHRoaXNbaV0uc3RlcCgpOwoJfQp9OwoKdmFyIGFkZEluc3RhbmNlID0gZnVuY3Rpb24oaW5zdGFuY2UpewoJdmFyIGZwcyA9IGluc3RhbmNlLm9wdGlvbnMuZnBzLAoJCWxpc3QgPSBpbnN0YW5jZXNbZnBzXSB8fCAoaW5zdGFuY2VzW2Zwc10gPSBbXSk7CglsaXN0LnB1c2goaW5zdGFuY2UpOwoJaWYgKCF0aW1lcnNbZnBzXSkgdGltZXJzW2Zwc10gPSBsb29wLnBlcmlvZGljYWwoTWF0aC5yb3VuZCgxMDAwIC8gZnBzKSwgbGlzdCk7CglyZXR1cm4gdHJ1ZTsKfTsKCnZhciByZW1vdmVJbnN0YW5jZSA9IGZ1bmN0aW9uKGluc3RhbmNlKXsKCXZhciBmcHMgPSBpbnN0YW5jZS5vcHRpb25zLmZwcywKCQlsaXN0ID0gaW5zdGFuY2VzW2Zwc10gfHwgW107CglsaXN0LmVyYXNlKGluc3RhbmNlKTsKCWlmICghbGlzdC5sZW5ndGggJiYgdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gY2xlYXJJbnRlcnZhbCh0aW1lcnNbZnBzXSk7CglyZXR1cm4gZmFsc2U7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9OwoJCUFycmF5LmVhY2goZG9jdW1lbnQuc3R5bGVTaGVldHMsIGZ1bmN0aW9uKHNoZWV0LCBqKXsKCQkJdmFyIGhyZWYgPSBzaGVldC5ocmVmOwoJCQlpZiAoaHJlZiAmJiBocmVmLmNvbnRhaW5zKCc6Ly8nKSAmJiAhaHJlZi5jb250YWlucyhkb2N1bWVudC5kb21haW4pKSByZXR1cm47CgkJCXZhciBydWxlcyA9IHNoZWV0LnJ1bGVzIHx8IHNoZWV0LmNzc1J1bGVzOwoJCQlBcnJheS5lYWNoKHJ1bGVzLCBmdW5jdGlvbihydWxlLCBpKXsKCQkJCWlmICghcnVsZS5zdHlsZSkgcmV0dXJuOwoJCQkJdmFyIHNlbGVjdG9yVGV4dCA9IChydWxlLnNlbGVjdG9yVGV4dCkgPyBydWxlLnNlbGVjdG9yVGV4dC5yZXBsYWNlKC9eXHcrLywgZnVuY3Rpb24obSl7CgkJCQkJcmV0dXJuIG0udG9Mb3dlckNhc2UoKTsKCQkJCX0pIDogbnVsbDsKCQkJCWlmICghc2VsZWN0b3JUZXh0IHx8ICFzZWxlY3RvclRleHQudGVzdCgnXicgKyBzZWxlY3RvciArICckJykpIHJldHVybjsKCQkJCUVsZW1lbnQuU3R5bGVzLmVhY2goZnVuY3Rpb24odmFsdWUsIHN0eWxlKXsKCQkJCQlpZiAoIXJ1bGUuc3R5bGVbc3R5bGVdIHx8IEVsZW1lbnQuU2hvcnRTdHlsZXNbc3R5bGVdKSByZXR1cm47CgkJCQkJdmFsdWUgPSBTdHJpbmcocnVsZS5zdHlsZVtzdHlsZV0pOwoJCQkJCXRvW3N0eWxlXSA9ICh2YWx1ZS50ZXN0KC9ecmdiLykpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguQ1NTLlBhcnNlcnMgPSBuZXcgSGFzaChGeC5DU1MuUGFyc2Vycyk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJcmV0dXJuIE9iamVjdC5hcHBlbmQodHJhbnNpdGlvbiwgewoJCWVhc2VJbjogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZU91dDogZnVuY3Rpb24ocG9zKXsKCQkJcmV0dXJuIDEgLSB0cmFuc2l0aW9uKDEgLSBwb3MsIHBhcmFtcyk7CgkJfSwKCQllYXNlSW5PdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAocG9zIDw9IDAuNSkgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgLyAyIDogKDIgLSB0cmFuc2l0aW9uKDIgKiAoMSAtIHBvcyksIHBhcmFtcykpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguc2luKCgxIC0gcCkgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBbaSArIDJdKTsKCX0pOwp9KTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QKCmRlc2NyaXB0aW9uOiBQb3dlcmZ1bCBhbGwgcHVycG9zZSBSZXF1ZXN0IENsYXNzLiBVc2VzIFhNTEhUVFBSZXF1ZXN0LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW09iamVjdCwgRWxlbWVudCwgQ2hhaW4sIEV2ZW50cywgT3B0aW9ucywgQnJvd3Nlcl0KCnByb3ZpZGVzOiBSZXF1ZXN0CgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIHByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKXt9OwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQkKCQl0aGlzLnJlc3BvbnNlID0ge3RleHQ6IHRoaXMueGhyLnJlc3BvbnNlVGV4dCB8fCAnJywgeG1sOiB0aGlzLnhoci5yZXNwb25zZVhNTH07CgkJaWYgKHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MuY2FsbCh0aGlzLCB0aGlzLnN0YXR1cykpCgkJCXRoaXMuc3VjY2Vzcyh0aGlzLnJlc3BvbnNlLnRleHQsIHRoaXMucmVzcG9uc2UueG1sKTsKCQllbHNlCgkJCXRoaXMuZmFpbHVyZSgpOwoJfSwKCglpc1N1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdmFyIHN0YXR1cyA9IHRoaXMuc3RhdHVzOwoJCXJldHVybiAoc3RhdHVzID49IDIwMCAmJiBzdGF0dXMgPCAzMDApOwoJfSwKCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICEhdGhpcy5ydW5uaW5nOwoJfSwKCglwcm9jZXNzU2NyaXB0czogZnVuY3Rpb24odGV4dCl7CgkJaWYgKHRoaXMub3B0aW9ucy5ldmFsUmVzcG9uc2UgfHwgKC8oZWNtYXxqYXZhKXNjcmlwdC8pLnRlc3QodGhpcy5nZXRIZWFkZXIoJ0NvbnRlbnQtdHlwZScpKSkgcmV0dXJuIEJyb3dzZXIuZXhlYyh0ZXh0KTsKCQlyZXR1cm4gdGV4dC5zdHJpcFNjcmlwdHModGhpcy5vcHRpb25zLmV2YWxTY3JpcHRzKTsKCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCwgeG1sKXsKCQl0aGlzLm9uU3VjY2Vzcyh0aGlzLnByb2Nlc3NTY3JpcHRzKHRleHQpLCB4bWwpOwoJfSwKCglvblN1Y2Nlc3M6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgYXJndW1lbnRzKS5maXJlRXZlbnQoJ3N1Y2Nlc3MnLCBhcmd1bWVudHMpLmNhbGxDaGFpbigpOwoJfSwKCglmYWlsdXJlOiBmdW5jdGlvbigpewoJCXRoaXMub25GYWlsdXJlKCk7Cgl9LAoKCW9uRmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgnY29tcGxldGUnKS5maXJlRXZlbnQoJ2ZhaWx1cmUnLCB0aGlzLnhocik7Cgl9LAoJCglsb2Fkc3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgnbG9hZHN0YXJ0JywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJcHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50KXsKCQl0aGlzLmZpcmVFdmVudCgncHJvZ3Jlc3MnLCBbZXZlbnQsIHRoaXMueGhyXSk7Cgl9LAoJCgl0aW1lb3V0OiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCd0aW1lb3V0JywgdGhpcy54aHIpOwoJfSwKCglzZXRIZWFkZXI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKXsKCQl0aGlzLmhlYWRlcnNbbmFtZV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy54aHIuZ2V0UmVzcG9uc2VIZWFkZXIobmFtZSk7CgkJfS5iaW5kKHRoaXMpKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0cnVlOwoJCXN3aXRjaCAodGhpcy5vcHRpb25zLmxpbmspewoJCQljYXNlICdjYW5jZWwnOiB0aGlzLmNhbmNlbCgpOyByZXR1cm4gdHJ1ZTsKCQkJY2FzZSAnY2hhaW4nOiB0aGlzLmNoYWluKHRoaXMuY2FsbGVyLnBhc3MoYXJndW1lbnRzLCB0aGlzKSk7IHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIGZhbHNlOwoJfSwKCQoJc2VuZDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJaWYgKCF0aGlzLmNoZWNrKG9wdGlvbnMpKSByZXR1cm4gdGhpczsKCgkJdGhpcy5vcHRpb25zLmlzU3VjY2VzcyA9IHRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgfHwgdGhpcy5pc1N1Y2Nlc3M7CgkJdGhpcy5ydW5uaW5nID0gdHJ1ZTsKCgkJdmFyIHR5cGUgPSB0eXBlT2Yob3B0aW9ucyk7CgkJaWYgKHR5cGUgPT0gJ3N0cmluZycgfHwgdHlwZSA9PSAnZWxlbWVudCcpIG9wdGlvbnMgPSB7ZGF0YTogb3B0aW9uc307CgoJCXZhciBvbGQgPSB0aGlzLm9wdGlvbnM7CgkJb3B0aW9ucyA9IE9iamVjdC5hcHBlbmQoe2RhdGE6IG9sZC5kYXRhLCB1cmw6IG9sZC51cmwsIG1ldGhvZDogb2xkLm1ldGhvZH0sIG9wdGlvbnMpOwoJCXZhciBkYXRhID0gb3B0aW9ucy5kYXRhLCB1cmwgPSBTdHJpbmcob3B0aW9ucy51cmwpLCBtZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b0xvd2VyQ2FzZSgpOwoKCQlzd2l0Y2ggKHR5cGVPZihkYXRhKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBkYXRhID0gZG9jdW1lbnQuaWQoZGF0YSkudG9RdWVyeVN0cmluZygpOyBicmVhazsKCQkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6IGRhdGEgPSBPYmplY3QudG9RdWVyeVN0cmluZyhkYXRhKTsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZm9ybWF0KXsKCQkJdmFyIGZvcm1hdCA9ICdmb3JtYXQ9JyArIHRoaXMub3B0aW9ucy5mb3JtYXQ7CgkJCWRhdGEgPSAoZGF0YSkgPyBmb3JtYXQgKyAnJicgKyBkYXRhIDogZm9ybWF0OwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy5lbXVsYXRpb24gJiYgIVsnZ2V0JywgJ3Bvc3QnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIF9tZXRob2QgPSAnX21ldGhvZD0nICsgbWV0aG9kOwoJCQlkYXRhID0gKGRhdGEpID8gX21ldGhvZCArICcmJyArIGRhdGEgOiBfbWV0aG9kOwoJCQltZXRob2QgPSAncG9zdCc7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLnVybEVuY29kZWQgJiYgWydwb3N0JywgJ3B1dCddLmNvbnRhaW5zKG1ldGhvZCkpewoJCQl2YXIgZW5jb2RpbmcgPSAodGhpcy5vcHRpb25zLmVuY29kaW5nKSA/ICc7IGNoYXJzZXQ9JyArIHRoaXMub3B0aW9ucy5lbmNvZGluZyA6ICcnOwoJCQl0aGlzLmhlYWRlcnNbJ0NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgKyBlbmNvZGluZzsKCQl9CgoJCWlmICghdXJsKSB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wYXRobmFtZTsKCQkKCQl2YXIgdHJpbVBvc2l0aW9uID0gdXJsLmxhc3RJbmRleE9mKCcvJyk7CgkJaWYgKHRyaW1Qb3NpdGlvbiA+IC0xICYmICh0cmltUG9zaXRpb24gPSB1cmwuaW5kZXhPZignIycpKSA+IC0xKSB1cmwgPSB1cmwuc3Vic3RyKDAsIHRyaW1Qb3NpdGlvbik7CgoJCWlmICh0aGlzLm9wdGlvbnMubm9DYWNoZSkKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBTdHJpbmcudW5pcXVlSUQoKTsKCgkJaWYgKGRhdGEgJiYgbWV0aG9kID09ICdnZXQnKXsKCQkJdXJsICs9ICh1cmwuY29udGFpbnMoJz8nKSA/ICcmJyA6ICc/JykgKyBkYXRhOwoJCQlkYXRhID0gbnVsbDsKCQl9CgoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQlpZiAocHJvZ3Jlc3NTdXBwb3J0KXsKCQkJeGhyLm9ubG9hZHN0YXJ0ID0gdGhpcy5sb2Fkc3RhcnQuYmluZCh0aGlzKTsKCQkJeGhyLm9ucHJvZ3Jlc3MgPSB0aGlzLnByb2dyZXNzLmJpbmQodGhpcyk7CgkJfQoKCQl4aHIub3BlbihtZXRob2QudG9VcHBlckNhc2UoKSwgdXJsLCB0aGlzLm9wdGlvbnMuYXN5bmMsIHRoaXMub3B0aW9ucy51c2VyLCB0aGlzLm9wdGlvbnMucGFzc3dvcmQpOwoJCWlmICh0aGlzLm9wdGlvbnMudXNlciAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiB4aHIpIHhoci53aXRoQ3JlZGVudGlhbHMgPSB0cnVlOwoJCQoJCXhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSB0aGlzLm9uU3RhdGVDaGFuZ2UuYmluZCh0aGlzKTsKCgkJT2JqZWN0LmVhY2godGhpcy5oZWFkZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJdHJ5IHsKCQkJCXhoci5zZXRSZXF1ZXN0SGVhZGVyKGtleSwgdmFsdWUpOwoJCQl9IGNhdGNoIChlKXsKCQkJCXRoaXMuZmlyZUV2ZW50KCdleGNlcHRpb24nLCBba2V5LCB2YWx1ZV0pOwoJCQl9CgkJfSwgdGhpcyk7CgoJCXRoaXMuZmlyZUV2ZW50KCdyZXF1ZXN0Jyk7CgkJeGhyLnNlbmQoZGF0YSk7CgkJaWYgKCF0aGlzLm9wdGlvbnMuYXN5bmMpIHRoaXMub25TdGF0ZUNoYW5nZSgpOwoJCWlmICh0aGlzLm9wdGlvbnMudGltZW91dCkgdGhpcy50aW1lciA9IHRoaXMudGltZW91dC5kZWxheSh0aGlzLm9wdGlvbnMudGltZW91dCwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNhbmNlbDogZnVuY3Rpb24oKXsKCQlpZiAoIXRoaXMucnVubmluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy5ydW5uaW5nID0gZmFsc2U7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCXhoci5hYm9ydCgpOwoJCWNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0geGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBmdW5jdGlvbigpe307CgkJdGhpcy54aHIgPSBuZXcgQnJvd3Nlci5SZXF1ZXN0KCk7CgkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgbWV0aG9kcyA9IHt9OwpbJ2dldCcsICdwb3N0JywgJ3B1dCcsICdkZWxldGUnLCAnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURSddLmVhY2goZnVuY3Rpb24obWV0aG9kKXsKCW1ldGhvZHNbbWV0aG9kXSA9IGZ1bmN0aW9uKGRhdGEpewoJCXJldHVybiB0aGlzLnNlbmQoewoJCQlkYXRhOiBkYXRhLAoJCQltZXRob2Q6IG1ldGhvZAoJCX0pOwoJfTsKfSk7CgpSZXF1ZXN0LmltcGxlbWVudChtZXRob2RzKTsKCkVsZW1lbnQuUHJvcGVydGllcy5zZW5kID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbmQgPSB0aGlzLmdldCgnc2VuZCcpLmNhbmNlbCgpOwoJCXNlbmQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBzZW5kID0gdGhpcy5yZXRyaWV2ZSgnc2VuZCcpOwoJCWlmICghc2VuZCl7CgkJCXNlbmQgPSBuZXcgUmVxdWVzdCh7CgkJCQlkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgbWV0aG9kOiB0aGlzLmdldCgnbWV0aG9kJykgfHwgJ3Bvc3QnLCB1cmw6IHRoaXMuZ2V0KCdhY3Rpb24nKQoJCQl9KTsKCQkJdGhpcy5zdG9yZSgnc2VuZCcsIHNlbmQpOwoJCX0KCQlyZXR1cm4gc2VuZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2VuZDogZnVuY3Rpb24odXJsKXsKCQl2YXIgc2VuZGVyID0gdGhpcy5nZXQoJ3NlbmQnKTsKCQlzZW5kZXIuc2VuZCh7ZGF0YTogdGhpcywgdXJsOiB1cmwgfHwgc2VuZGVyLm9wdGlvbnMudXJsfSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cygnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50cy5maWx0ZXIob3B0aW9ucy5maWx0ZXIpOwoJCWlmIChvcHRpb25zLnVwZGF0ZSkgZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJZWxzZSBpZiAob3B0aW9ucy5hcHBlbmQpIGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKS5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZSBBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAoIXRoaXMuSlNPTikgdGhpcy5KU09OID0ge307CgovLzwxLjJjb21wYXQ+CgpKU09OID0gbmV3IEhhc2goewoJc3RyaW5naWZ5OiBKU09OLnN0cmluZ2lmeSwKCXBhcnNlOiBKU09OLnBhcnNlCn0pOwoKLy88LzEuMmNvbXBhdD4KCk9iamVjdC5hcHBlbmQoSlNPTiwgewoKCSRzcGVjaWFsQ2hhcnM6IHsnXGInOiAnXFxiJywgJ1x0JzogJ1xcdCcsICdcbic6ICdcXG4nLCAnXGYnOiAnXFxmJywgJ1xyJzogJ1xccicsICciJyA6ICdcXCInLCAnXFwnOiAnXFxcXCd9LAoKCSRyZXBsYWNlQ2hhcnM6IGZ1bmN0aW9uKGNocil7CgkJcmV0dXJuIEpTT04uJHNwZWNpYWxDaGFyc1tjaHJdIHx8ICdcXHUwMCcgKyBNYXRoLmZsb29yKGNoci5jaGFyQ29kZUF0KCkgLyAxNikudG9TdHJpbmcoMTYpICsgKGNoci5jaGFyQ29kZUF0KCkgJSAxNikudG9TdHJpbmcoMTYpOwoJfSwKCgllbmNvZGU6IGZ1bmN0aW9uKG9iail7CgkJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJCWNhc2UgJ3N0cmluZyc6CgkJCQlyZXR1cm4gJyInICsgb2JqLnJlcGxhY2UoL1tceDAwLVx4MWZcXCJdL2csIEpTT04uJHJlcGxhY2VDaGFycykgKyAnIic7CgkJCWNhc2UgJ2FycmF5JzoKCQkJCXJldHVybiAnWycgKyBTdHJpbmcob2JqLm1hcChKU09OLmVuY29kZSkuY2xlYW4oKSkgKyAnXSc7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOgoJCQkJdmFyIHN0cmluZyA9IFtdOwoJCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCQl2YXIganNvbiA9IEpTT04uZW5jb2RlKHZhbHVlKTsKCQkJCQlpZiAoanNvbikgc3RyaW5nLnB1c2goSlNPTi5lbmNvZGUoa2V5KSArICc6JyArIGpzb24pOwoJCQkJfSk7CgkJCQlyZXR1cm4gJ3snICsgc3RyaW5nICsgJ30nOwoJCQljYXNlICdudW1iZXInOiBjYXNlICdib29sZWFuJzogcmV0dXJuIFN0cmluZyhvYmopOwoJCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWRlY29kZTogZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJCWlmICh0eXBlT2Yoc3RyaW5nKSAhPSAnc3RyaW5nJyB8fCAhc3RyaW5nLmxlbmd0aCkgcmV0dXJuIG51bGw7CgkJaWYgKHNlY3VyZSAmJiAhKC9eWyw6e31cW1xdMC05LlwtK0VhZWZsbnItdSBcblxyXHRdKiQvKS50ZXN0KHN0cmluZy5yZXBsYWNlKC9cXC4vZywgJ0AnKS5yZXBsYWNlKC8iW14iXFxcblxyXSoiL2csICcnKSkpIHJldHVybiBudWxsOwoJCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSlNPTgoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIHNlbmRpbmcgYW5kIHJlY2VpdmluZyBKU09OIGRhdGEuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbUmVxdWVzdCwgSlNPTl0KCnByb3ZpZGVzOiBSZXF1ZXN0LkpTT04KCi4uLgoqLwoKUmVxdWVzdC5KU09OID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIgc2VjdXJlID0gdGhpcy5vcHRpb25zLnNlY3VyZTsKCQl2YXIganNvbiA9IHRoaXMucmVzcG9uc2UuanNvbiA9IEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIEpTT04uZGVjb2RlKHRleHQsIHNlY3VyZSk7CgkJfSk7CgoJCWlmIChqc29uID09IG51bGwpIHRoaXMub25GYWlsdXJlKCk7CgkJZWxzZSB0aGlzLm9uU3VjY2Vzcyhqc29uLCB0ZXh0KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ29va2llCgpkZXNjcmlwdGlvbjogQ2xhc3MgZm9yIGNyZWF0aW5nLCByZWFkaW5nLCBhbmQgZGVsZXRpbmcgYnJvd3NlciBDb29raWVzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gQmFzZWQgb24gdGhlIGZ1bmN0aW9ucyBieSBQZXRlci1QYXVsIEtvY2ggKGh0dHA6Ly9xdWlya3Ntb2RlLm9yZykuCgpyZXF1aXJlczogT3B0aW9ucwoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCglpc0ZyYW1lZCA9IHRydWU7CgovLyBUaGFua3MgdG8gUmljaCBEb3VnaGVydHkgPGh0dHA6Ly93d3cucmljaGRvdWdoZXJ0eS5jb20vPgp0cnkgewoJaXNGcmFtZWQgPSB3aW5kb3cuZnJhbWVFbGVtZW50ICE9IG51bGw7Cn0gY2F0Y2goZSl7fQoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgkKCWRvY3VtZW50LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCXdpbmRvdy5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbigpewoJZm9yICh2YXIgaSA9IGNoZWNrcy5sZW5ndGg7IGktLTspIGlmIChjaGVja3NbaV0oKSl7CgkJZG9tcmVhZHkoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCglyZXR1cm4gZmFsc2U7Cn07Cgp2YXIgcG9sbCA9IGZ1bmN0aW9uKCl7CgljbGVhclRpbWVvdXQodGltZXIpOwoJaWYgKCFjaGVjaygpKSB0aW1lciA9IHNldFRpbWVvdXQocG9sbCwgMTApOwp9OwoKZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSk7CgovLyBkb1Njcm9sbCB0ZWNobmlxdWUgYnkgRGllZ28gUGVyaW5pIGh0dHA6Ly9qYXZhc2NyaXB0Lm53Ym94LmNvbS9JRUNvbnRlbnRMb2FkZWQvCnZhciB0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWlzRnJhbWVkKXsKCWNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7CgkJdHJ5IHsKCQkJdGVzdEVsZW1lbnQuZG9TY3JvbGwoKTsKCQkJcmV0dXJuIHRydWU7CgkJfSBjYXRjaCAoZSl7fQoKCQlyZXR1cm4gZmFsc2U7Cgl9KTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSkgY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCXZhciBzdGF0ZSA9IGRvY3VtZW50LnJlYWR5U3RhdGU7CglyZXR1cm4gKHN0YXRlID09ICdsb2FkZWQnIHx8IHN0YXRlID09ICdjb21wbGV0ZScpOwp9KTsKCmlmICgnb25yZWFkeXN0YXRlY2hhbmdlJyBpbiBkb2N1bWVudCkgZG9jdW1lbnQuYWRkTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CmVsc2Ugc2hvdWxkUG9sbCA9IHRydWU7CgppZiAoc2hvdWxkUG9sbCkgcG9sbCgpOwoKRWxlbWVudC5FdmVudHMuZG9tcmVhZHkgPSB7CglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChyZWFkeSkgZm4uY2FsbCh0aGlzKTsKCX0KfTsKCi8vIE1ha2Ugc3VyZSB0aGF0IGRvbXJlYWR5IGZpcmVzIGJlZm9yZSBsb2FkCkVsZW1lbnQuRXZlbnRzLmxvYWQgPSB7CgliYXNlOiAnbG9hZCcsCglvbkFkZDogZnVuY3Rpb24oZm4pewoJCWlmIChsb2FkZWQgJiYgdGhpcyA9PSB3aW5kb3cpIGZuLmNhbGwodGhpcyk7Cgl9LAoJY29uZGl0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzID09IHdpbmRvdyl7CgkJCWRvbXJlYWR5KCk7CgkJCWRlbGV0ZSBFbGVtZW50LkV2ZW50cy5sb2FkOwoJCX0KCQkKCQlyZXR1cm4gdHJ1ZTsKCX0KfTsKCi8vIFRoaXMgaXMgYmFzZWQgb24gdGhlIGN1c3RvbSBsb2FkIGV2ZW50CndpbmRvdy5hZGRFdmVudCgnbG9hZCcsIGZ1bmN0aW9uKCl7Cglsb2FkZWQgPSB0cnVlOwp9KTsKCn0pKHdpbmRvdywgZG9jdW1lbnQpOwoKCi8qCi0tLQoKbmFtZTogU3dpZmYKCmRlc2NyaXB0aW9uOiBXcmFwcGVyIGZvciBlbWJlZGRpbmcgU1dGIG1vdmllcy4gU3VwcG9ydHMgRXh0ZXJuYWwgSW50ZXJmYWNlIENvbW11bmljYXRpb24uCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBGbGFzaCBkZXRlY3Rpb24gJiBJbnRlcm5ldCBFeHBsb3JlciArIEZsYXNoIFBsYXllciA5IGZpeCBpbnNwaXJlZCBieSBTV0ZPYmplY3QuCgpyZXF1aXJlczogW09wdGlvbnMsIE9iamVjdF0KCnByb3ZpZGVzOiBTd2lmZgoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBpZCA9IDA7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIGlkKys7CgoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoJCXZhciBpZCA9IHRoaXMuaWQgPSBvcHRpb25zLmlkIHx8IHRoaXMuaW5zdGFuY2U7CgkJdmFyIGNvbnRhaW5lciA9IGRvY3VtZW50LmlkKG9wdGlvbnMuY29udGFpbmVyKTsKCgkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdID0ge307CgoJCXZhciBwYXJhbXMgPSBvcHRpb25zLnBhcmFtcywgdmFycyA9IG9wdGlvbnMudmFycywgY2FsbEJhY2tzID0gb3B0aW9ucy5jYWxsQmFja3M7CgkJdmFyIHByb3BlcnRpZXMgPSBPYmplY3QuYXBwZW5kKHtoZWlnaHQ6IG9wdGlvbnMuaGVpZ2h0LCB3aWR0aDogb3B0aW9ucy53aWR0aH0sIG9wdGlvbnMucHJvcGVydGllcyk7CgoJCXZhciBzZWxmID0gdGhpczsKCgkJZm9yICh2YXIgY2FsbEJhY2sgaW4gY2FsbEJhY2tzKXsKCQkJU3dpZmYuQ2FsbEJhY2tzW3RoaXMuaW5zdGFuY2VdW2NhbGxCYWNrXSA9IChmdW5jdGlvbihvcHRpb24pewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCQkJcmV0dXJuIG9wdGlvbi5hcHBseShzZWxmLm9iamVjdCwgYXJndW1lbnRzKTsKCQkJCX07CgkJCX0pKGNhbGxCYWNrc1tjYWxsQmFja10pOwoJCQl2YXJzW2NhbGxCYWNrXSA9ICdTd2lmZi5DYWxsQmFja3MuJyArIHRoaXMuaW5zdGFuY2UgKyAnLicgKyBjYWxsQmFjazsKCQl9CgoJCXBhcmFtcy5mbGFzaFZhcnMgPSBPYmplY3QudG9RdWVyeVN0cmluZyh2YXJzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXByb3BlcnRpZXMuY2xhc3NpZCA9ICdjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAnOwoJCQlwYXJhbXMubW92aWUgPSBwYXRoOwoJCX0gZWxzZSB7CgkJCXByb3BlcnRpZXMudHlwZSA9ICdhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCc7CgkJfQoJCXByb3BlcnRpZXMuZGF0YSA9IHBhdGg7CgoJCXZhciBidWlsZCA9ICc8b2JqZWN0IGlkPSInICsgaWQgKyAnIic7CgkJZm9yICh2YXIgcHJvcGVydHkgaW4gcHJvcGVydGllcykgYnVpbGQgKz0gJyAnICsgcHJvcGVydHkgKyAnPSInICsgcHJvcGVydGllc1twcm9wZXJ0eV0gKyAnIic7CgkJYnVpbGQgKz0gJz4nOwoJCWZvciAodmFyIHBhcmFtIGluIHBhcmFtcyl7CgkJCWlmIChwYXJhbXNbcGFyYW1dKSBidWlsZCArPSAnPHBhcmFtIG5hbWU9IicgKyBwYXJhbSArICciIHZhbHVlPSInICsgcGFyYW1zW3BhcmFtXSArICciIC8+JzsKCQl9CgkJYnVpbGQgKz0gJzwvb2JqZWN0Pic7CgkJdGhpcy5vYmplY3QgPSAoKGNvbnRhaW5lcikgPyBjb250YWluZXIuZW1wdHkoKSA6IG5ldyBFbGVtZW50KCdkaXYnKSkuc2V0KCdodG1sJywgYnVpbGQpLmZpcnN0Q2hpbGQ7Cgl9LAoKCXJlcGxhY2VzOiBmdW5jdGlvbihlbGVtZW50KXsKCQllbGVtZW50ID0gZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSk7CgkJZWxlbWVudC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZCh0aGlzLnRvRWxlbWVudCgpLCBlbGVtZW50KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaW5qZWN0OiBmdW5jdGlvbihlbGVtZW50KXsKCQlkb2N1bWVudC5pZChlbGVtZW50LCB0cnVlKS5hcHBlbmRDaGlsZCh0aGlzLnRvRWxlbWVudCgpKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3RlOiBmdW5jdGlvbigpewoJCXJldHVybiBTd2lmZi5yZW1vdGUuYXBwbHkoU3dpZmYsIFt0aGlzLnRvRWxlbWVudCgpXS5leHRlbmQoYXJndW1lbnRzKSk7Cgl9Cgp9KTsKClN3aWZmLkNhbGxCYWNrcyA9IHt9OwoKU3dpZmYucmVtb3RlID0gZnVuY3Rpb24ob2JqLCBmbil7Cgl2YXIgcnMgPSBvYmouQ2FsbEZ1bmN0aW9uKCc8aW52b2tlIG5hbWU9IicgKyBmbiArICciIHJldHVybnR5cGU9ImphdmFzY3JpcHQiPicgKyBfX2ZsYXNoX19hcmd1bWVudHNUb1hNTChhcmd1bWVudHMsIDIpICsgJzwvaW52b2tlPicpOwoJcmV0dXJuIGV2YWwocnMpOwp9OwoKfSkoKTsKCg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 04:07:34 GMT",
                    "Content-Length": "140971",
                    "Date": "Sat, 08 Nov 2014 04:07:34 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}