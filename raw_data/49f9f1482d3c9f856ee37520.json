{
    "url": "http://localhost:9999/Splendsome/meteor-famous-angular/index.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>window.name</b> and written to <b>the 'name' property of a DOM element</b> via the following statement:<ul><li>window.name = \"NG_DEFER_BOOTSTRAP!\" + window.name;</li></ul><b>Note:</b> The name of the current window is a valid attack vector for DOM-based vulnerabilities. An attacker can directly control the name of the targeted application's window by using code on their own domain to load the targeted page using either window.open() or an iframe tag, and specifying the desired window name. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Splendsome/meteor-famous-angular/index.js",
                "path": "/Splendsome/meteor-famous-angular/index.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9TcGxlbmRzb21lL21ldGVvci1mYW1vdXMtYW5ndWxhci9pbmRleC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjM4OTkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMDU6MjA6NDEgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDA1OjIwOjQxIEdNVA0KDQovKioKICogZmFtb3VzLWFuZ3VsYXIgLSBJbnRlZ3JhdGUgRmFtby51cyBpbnRvIEFuZ3VsYXJKUyBhcHBzIGFuZCBidWlsZCBGYW1vLnVzIGFwcHMgdXNpbmcgQW5ndWxhckpTIHRvb2xzCiAqIEB2ZXJzaW9uIHYwLjAuMTIKICogQGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL0ZhbW91cy9mYW1vdXMtYW5ndWxhcgogKiBAbGljZW5zZSAKICovCid1c2Ugc3RyaWN0JzsKCi8vIFB1dCBhbmd1bGFyIGJvb3RzdHJhcCBvbiBob2xkCndpbmRvdy5uYW1lID0gIk5HX0RFRkVSX0JPT1RTVFJBUCEiICsgd2luZG93Lm5hbWU7CgpkZWZpbmUoZnVuY3Rpb24ocmVxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7CgovL1RPRE86ICBFbnN1cmUgdGhhdCB0aGlzIGxpc3Qgc3RheXMgdXAtdG8tZGF0ZSB3aXRoCi8vICAgICAgIHRoZSBmaWxlc3lzdGVtIChtYXliZSB3cml0ZSBhIGJhc2ggc2NyaXB0Ci8vICAgICAgIHdvcmtpbmcgYXJvdW5kIGBscyAtUjEgYXBwL3NjcmlwdHMvZmFtb3VzYCA/KQp2YXIgcmVxdWlyZW1lbnRzID0gWwoJImZhbW91cy9jb3JlL0VuZ2luZSIsCgkiZmFtb3VzL2NvcmUvRXZlbnRFbWl0dGVyIiwKCSJmYW1vdXMvY29yZS9FdmVudEhhbmRsZXIiLAoJImZhbW91cy9jb3JlL01vZGlmaWVyIiwKCSJmYW1vdXMvY29yZS9SZW5kZXJOb2RlIiwKCSJmYW1vdXMvY29yZS9TdXJmYWNlIiwKCSJmYW1vdXMvY29yZS9UcmFuc2Zvcm0iLAoJImZhbW91cy9jb3JlL1ZpZXciLAoJImZhbW91cy9jb3JlL1ZpZXdTZXF1ZW5jZSIsCgkiZmFtb3VzL2V2ZW50cy9FdmVudEFyYml0ZXIiLAoJImZhbW91cy9ldmVudHMvRXZlbnRGaWx0ZXIiLAoJImZhbW91cy9ldmVudHMvRXZlbnRNYXBwZXIiLAoJImZhbW91cy9pbnB1dHMvRmFzdENsaWNrIiwKCSJmYW1vdXMvaW5wdXRzL0dlbmVyaWNTeW5jIiwKCSJmYW1vdXMvaW5wdXRzL01vdXNlU3luYyIsCgkiZmFtb3VzL2lucHV0cy9QaW5jaFN5bmMiLAoJImZhbW91cy9pbnB1dHMvUm90YXRlU3luYyIsCgkiZmFtb3VzL2lucHV0cy9Ub3VjaFN5bmMiLAoJImZhbW91cy9zdXJmYWNlcy9JbWFnZVN1cmZhY2UiLAoJImZhbW91cy9zdXJmYWNlcy9JbnB1dFN1cmZhY2UiLAoJImZhbW91cy90cmFuc2l0aW9ucy9FYXNpbmciLAoJImZhbW91cy90cmFuc2l0aW9ucy9TcHJpbmdUcmFuc2l0aW9uIiwKCSJmYW1vdXMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGUiLAoJImZhbW91cy90cmFuc2l0aW9ucy9UcmFuc2l0aW9uYWJsZVRyYW5zZm9ybSIsCgkiZmFtb3VzL3V0aWxpdGllcy9LZXlDb2RlcyIsCgkiZmFtb3VzL3V0aWxpdGllcy9UaW1lciIsCgkiZmFtb3VzL3ZpZXdzL0dyaWRMYXlvdXQiLAoJImZhbW91cy92aWV3cy9SZW5kZXJDb250cm9sbGVyIiwKCSJmYW1vdXMvdmlld3MvU2Nyb2xsZXIiLAoJImZhbW91cy92aWV3cy9TY3JvbGx2aWV3IgpdCgp2YXIgcmVxdWlyZWQgPSBbXTsKZm9yICh2YXIgaSBpbiByZXF1aXJlbWVudHMpIHsKICByZXF1aXJlZFtpXSA9IHJlcXVpcmUocmVxdWlyZW1lbnRzW2ldKTsKfTsKCi8vZGVjbGFyZSB0aGUgbW9kdWxlIGJlZm9yZSB0aGUgYXN5bmMgY2FsbGJhY2sgc28gdGhhdAovL2l0IHdpbGwgYmUgYWNjZXNzaWJsZSB0byBvdGhlciBzeW5jaHJvbm91c2x5IGxvYWRlZCBhbmd1bGFyCi8vY29tcG9uZW50cwp2YXIgbmdGYW1lQXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJywgW10pOwoKKGZ1bmN0aW9uKCkgewogIC8qKgogICAqIEBuZ2RvYyBwcm92aWRlcgogICAqIEBuYW1lICRmYW1vdXNQcm92aWRlcgogICAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICAgKiBAZGVzY3JpcHRpb24KICAgKiBUaGlzIHByb3ZpZGVyIGlzIGxvYWRlZCBhcyBhbiBBTUQgbW9kdWxlIGFuZCB3aWxsIGtlZXAgYSByZWZlcmVuY2Ugb24gdGhlIGNvbXBsZXRlIEZhbW8udXMgbGlicmFyeS4KICAgKiBXZSB1c2UgdGhpcyBwcm92aWRlciB0byBhdm9pZCBuZWVkaW5nIHRvIGRlYWwgd2l0aCBBTUQgb24gYW55IG90aGVyIGFuZ3VsYXIgZmlsZXMuCiAgICoKICAgKiBAdXNhZ2UKICAgKiBZb3UgcHJvYmFibHkgd29uJ3QgaGF2ZSB0byBjb25maWd1cmUgdGhpcyBwcm92aWRlcgogICAqCiAgICogYGBganMKICAgKiBhbmd1bGFyLm1vZHVsZSgnbXlTdXBlckFwcCcsIFsnZmFtb3VzLmFuZ3VsYXInXSkuY29uZmlnKAogICAqICAgZnVuY3Rpb24oJGZhbW91c1Byb3ZpZGVyKSB7CiAgICoKICAgKiAgICAgICAvLyBSZWdpc3RlciB5b3VyIG1vZHVsZXMKICAgKiAgICAgICAkZmFtb3VzUHJvdmlkZXIucmVnaXN0ZXJNb2R1bGUoJ21vZHVsZUtleScsIG1vZHVsZSk7CiAgICoKICAgKiAgIH07CiAgICogfSk7CiAgICogYGBgCiAgICoKICAgKi8KICBuZ0ZhbWVBcHAucHJvdmlkZXIoJyRmYW1vdXMnLCBmdW5jdGlvbigpIHsKICAgIC8vIGhhc2ggZm9yIHN0b3JpbmcgbW9kdWxlcwogICAgdmFyIF9tb2R1bGVzID0ge307CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkZmFtb3VzUHJvdmlkZXIjcmVnaXN0ZXJNb2R1bGUKICAgICAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICAgICAqIEBkZXNjcmlwdGlvbgogICAgICogUmVnaXN0ZXIgdGhlIG1vZHVsZXMgdGhhdCB3aWxsIGJlIGF2YWlsYWJsZSBpbiB0aGUgJGZhbW91cyBzZXJ2aWNlCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSB0aGUga2V5IHRoYXQgd2lsbCBiZSB1c2VkIHRvIHJlZ2lzdGVyIHRoZSBtb2R1bGUKICAgICAqIEBwYXJhbSB7TWlzY30gbW9kdWxlIHRoZSBkYXRhIHRoYXQgd2lsbCBiZSByZXR1cm5lZCBieSB0aGUgc2VydmljZQogICAgICovCiAgICB0aGlzLnJlZ2lzdGVyTW9kdWxlID0gZnVuY3Rpb24oa2V5LCBtb2R1bGUpIHsKICAgICAgLy9UT0RPIHdhcm5pbmcgaWYgdGhlIGtleSBpcyBhbHJlYWR5IHJlZ2lzdGVyZWQgPwogICAgICBfbW9kdWxlc1trZXldID0gbW9kdWxlOwogICAgfTsKCiAgICAvKioKICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAqIEBuYW1lICRmYW1vdXNQcm92aWRlciNmaW5kCiAgICAgKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAgICAgKiBAZGVzY3JpcHRpb24gZ2l2ZW4gYSBzZWxlY3RvciwgcmV0cmlldmVzCiAgICAgKiB0aGUgaXNvbGF0ZSBvbiBhIHRlbXBsYXRlLWRlY2xhcmVkIHNjZW5lIGdyYXBoIGVsZW1lbnQuICBUaGlzIGlzIHVzZWZ1bAogICAgICogZm9yIG1hbmlwdWxhdGluZyBGYW1vLnVzIG9iamVjdHMgZGlyZWN0bHkgYWZ0ZXIgdGhleSd2ZSBiZWVuIGRlY2xhcmVkIGluIHRoZSBET00uCiAgICAgKiBBcyBpbiBub3JtYWwgQW5ndWxhciwgdGhpcyBET00gbG9vay11cCBzaG91bGQgYmUgcGVyZm9ybWVkIGluIHRoZSBwb3N0TGluayBmdW5jdGlvbgogICAgICogb2YgYSBkaXJlY3RpdmUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IGFuIGFycmF5IG9mIHRoZSBpc29sYXRlIG9iamVjdHMgb2YgdGhlIHNlbGVjdGVkIGVsZW1lbnRzLgogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzZWxlY3RvciAtIHRoZSBzZWxlY3RvciBmb3IgdGhlIGVsZW1lbnRzIHRvIGxvb2sgdXAKICAgICAqIEB1c2FnZQogICAgICogVmlldzoKICAgICAqIGBgYGh0bWwKICAgICAqIDxmYS1zY3JvbGwtdmlldyBpZD0ibXlTY3JvbGxWaWV3Ij48L2ZhLXNjcm9sbC12aWV3PgogICAgICogYGBgCiAgICAgKiBDb250cm9sbGVyOgogICAgICogYGBgamF2YXNjcmlwdAogICAgICogdmFyIHNjcm9sbFZpZXdSZWZlcmVuY2UgPSAkZmFtb3VzLmZpbmQoJyNteVNjcm9sbFZpZXcnKVswXS5yZW5kZXJOb2RlOwogICAgICogLy9Ob3cgc2Nyb2xsVmlld1JlZmVyZW5jZSBpcyBwb2ludGluZyB0byB0aGUgRmFtby51cyBTY3JvbGx2aWV3IG9iamVjdAogICAgICogLy90aGF0IHdlIGNyZWF0ZWQgaW4gdGhlIHZpZXcuCiAgICAgKiBgYGAKICAgICAqLwoKICAgIF9tb2R1bGVzLmZpbmQgPSBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBlbGVtcyA9IGFuZ3VsYXIuZWxlbWVudCh3aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWxlY3RvcikpOwogICAgICB2YXIgc2NvcGVzID0gZnVuY3Rpb24oZWxlbXMpIHsKICAgICAgICB2YXIgX3MgPSBbXTsKICAgICAgICBhbmd1bGFyLmZvckVhY2goZWxlbXMsIGZ1bmN0aW9uKGVsZW0sIGkpIHsKICAgICAgICAgIF9zW2ldID0gYW5ndWxhci5lbGVtZW50KGVsZW0pLnNjb3BlKCk7CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIF9zOwogICAgICB9KGVsZW1zKTsKICAgICAgdmFyIGlzb2xhdGVzID0gZnVuY3Rpb24oc2NvcGVzKSB7CiAgICAgICAgdmFyIF9zID0gW107CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKHNjb3BlcywgZnVuY3Rpb24oc2NvcGUsIGkpIHsKICAgICAgICAgIF9zW2ldID0gc2NvcGUuaXNvbGF0ZVtzY29wZS4kaWRdOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBfczsKICAgICAgfShzY29wZXMpOwogICAgICByZXR1cm4gaXNvbGF0ZXM7CiAgICB9CgogICAgdGhpcy4kZ2V0ID0gZnVuY3Rpb24oKSB7CgogICAgICAvKioKICAgICAgICogQG5nZG9jIHNlcnZpY2UKICAgICAgICogQG5hbWUgJGZhbW91cwogICAgICAgKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAgICAgICAqIEBkZXNjcmlwdGlvbgogICAgICAgKiBUaGlzIHNlcnZpY2UgZ2l2ZXMgeW91IGFjY2VzcyB0byB0aGUgY29tcGxldGUgRmFtby51cyBsaWJyYXJ5LgogICAgICAgKgogICAgICAgKiBAdXNhZ2UKICAgICAgICogVXNlIHRoaXMgc2VydmljZSB0byBhY2Nlc3MgdGhlIHJlZ2lzdGVyZWQgRmFtby51cyBtb2R1bGVzIGFzIGFuIG9iamVjdC4KICAgICAgICoKICAgICAgICogYGBganMKICAgICAgICogYW5ndWxhci5tb2R1bGUoJ215U3VwZXJBcHAnLCBbJ2ZhbW91cy5hbmd1bGFyJ10pLmNvbnRyb2xsZXIoCiAgICAgICAqICAgZnVuY3Rpb24oJHNjb3BlLCAkZmFtb3VzKSB7CiAgICAgICAqCiAgICAgICAqICAgICAgIC8vIEFjY2VzcyBhbnkgcmVnaXN0ZXJlZCBtb2R1bGUKICAgICAgICogICAgICAgdmFyIEV2ZW50SGFuZGxlciA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL0V2ZW50SGFuZGxlciddOwogICAgICAgKiAgICAgICAkc2NvcGUuZXZlbnRIYW5kbGVyID0gbmV3IEV2ZW50SGFuZGxlcigpOwogICAgICAgKgogICAgICAgKiAgIH07CiAgICAgICAqIH0pOwogICAgICAgKiBgYGAKICAgICAgICoKICAgICAgICovCiAgICAgIHJldHVybiBfbW9kdWxlczsKICAgIH07CiAgfSk7CgogIG5nRmFtZUFwcC5jb25maWcoWyckZmFtb3VzUHJvdmlkZXInLCBmdW5jdGlvbigkZmFtb3VzUHJvdmlkZXIpIHsKICAgIGZvcih2YXIgaSA9IDA7IGkgPCByZXF1aXJlbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgJGZhbW91c1Byb3ZpZGVyLnJlZ2lzdGVyTW9kdWxlKHJlcXVpcmVtZW50c1tpXSwgcmVxdWlyZWRbaV0pOwogICAgfQogICAgLy8JCWNvbnNvbGUubG9nKCdyZWdpc3RlcmVkIG1vZHVsZXMnLCBmYW1vdXNQcm92aWRlci4kZ2V0KCkpOwogIH1dKTsKCiAgYW5ndWxhci5lbGVtZW50KGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpIHsKICAgIGlmKGFuZ3VsYXIucmVzdW1lQm9vdHN0cmFwKSBhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCgpOwogIH0pOwp9KSgpOwoKLyoqCiAqIEBuZ2RvYyBzZXJ2aWNlCiAqIEBuYW1lICRmYW1vdXNEZWNvcmF0b3IKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAZGVzY3JpcHRpb24KICogTWFuYWdlcyB0aGUgY3JlYXRpb24gYW5kIGhhbmRsaW5nIG9mIGlzb2xhdGUgc2NvcGVzLgogKgogKiBJc29sYXRlIHNjb3BlcyBhcmUgbGlrZSBhIG5hbWVzcGFjaW5nIGluc2lkZSBwbGFpbiBBbmd1bGFyIGNoaWxkIHNjb3BlcywgCiAqIHdpdGggdGhlIHB1cnBvc2Ugb2Ygc3RvcmluZyBwcm9wZXJ0aWVzIGF2YWlsYWJsZSBvbmx5IHRvIG9uZSBwYXJ0aWN1bGFyIAogKiBzY29wZS4gIAogKiBUaGUgc2NvcGVzIGFyZSBzdGlsbCBhYmxlIHRvIGNvbW11bmljYXRlIHdpdGggdGhlIHBhcmVudCB2aWEgZXZlbnRzIAogKiAoJGVtaXQsICRicm9hZGNhc3QpLCB5ZXQgc3RpbGwgaGF2ZSB0aGVpciBvd24gJHNjb3BlIHByb3BlcnRpZXMgdGhhdCB3aWxsIAogKiBub3QgY29uZmxpY3Qgd2l0aCB0aGUgcGFyZW50IG9yIG90aGVyIHNpYmxpbmdzLiAKICoKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5mYWN0b3J5KCckZmFtb3VzRGVjb3JhdG9yJywgZnVuY3Rpb24gKCkgewogICAgLy9UT0RPOiAgYWRkIHJlcGVhdGVkIGxvZ2ljIHRvIHRoZXNlIHJvbGVzCiAgICB2YXIgX3JvbGVzID0gewogICAgICBjaGlsZDogewogICAgICB9LAogICAgICBwYXJlbnQ6IHsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB7CiAgICAgIC8vVE9ETzogIHBhdGNoIGludG8gX3JvbGVzIGFuZCBhc3NpZ24gdGhlCiAgICAgIC8vIGFwcHJvcHJpYXRlIHJvbGUgdG8gdGhlIGdpdmVuIHNjb3BlCiAgICAgIGFkZFJvbGU6IGZ1bmN0aW9uKHJvbGUsIHNjb3BlKXsKCiAgICAgIH0sCgogICAgICAvKioKICAgICAgICogQG5nZG9jIG1ldGhvZAogICAgICAgKiBAbmFtZSAkZmFtb3VzRGVjb3JhdG9yI2Vuc3VyZUlzb2xhdGUKICAgICAgICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogQ2hlY2tzIHRoZSBwYXNzZWQgaW4gc2NvcGUgZm9yIGFuIGV4aXN0aW5nIGlzb2xhdGUgcHJvcGVydHkuICBJZgogICAgICAgKiBzY29wZS5pc29sYXRlIGRvZXMgbm90IGFscmVhZHkgZXhpc3QsIGNyZWF0ZSBpdC4KICAgICAgICoKICAgICAgICogSWYgdGhlIHNjb3BlIGlzIGJlaW5nIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCBhbiBuZy1yZXBlYXQsIGFzc2lnbgogICAgICAgKiB0aGUgZGVmYXVsdCBuZy1yZXBlYXQgaW5kZXggb250byB0aGUgc2NvcGUuIAogICAgICAgKgogICAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSB0aGUgaXNvbGF0ZWQgc2NvcGUgb2JqZWN0IGZyb20gc2NvcGUuaXNvbGF0ZQogICAgICAgKiAgCiAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBzY29wZSAtIHRoZSBzY29wZSB0byBlbnN1cmUgdGhhdCB0aGUgaXNvbGF0ZSBwcm9wZXJ0eQogICAgICAgKiBleGlzdHMgb24KICAgICAgICogIAogICAgICAgKiBAdXNhZ2UKICAgICAgICogCiAgICAgICAqIGBgYGpzCiAgICAgICAqIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKCRzY29wZSk7CiAgICAgICAqIGBgYAogICAgICAgKi8KICAgICAgZW5zdXJlSXNvbGF0ZTogZnVuY3Rpb24oc2NvcGUpewogICAgICAgIHNjb3BlLmlzb2xhdGUgPSBzY29wZS5pc29sYXRlIHx8IHt9OwogICAgICAgIHNjb3BlLmlzb2xhdGVbc2NvcGUuJGlkXSA9IHNjb3BlLmlzb2xhdGVbc2NvcGUuJGlkXSB8fCB7fTsKCiAgICAgICAgLy9hc3NpZ24gdGhlIHNjb3BlICRpZCB0byB0aGUgaXNvbGF0ZQogICAgICAgIHZhciBpc29sYXRlID0gc2NvcGUuaXNvbGF0ZVtzY29wZS4kaWRdOwogICAgICAgIGlzb2xhdGUuaWQgPSBzY29wZS4kaWQ7CgogICAgICAgIC8vYXNzaWduIGRlZmF1bHQgbmctcmVwZWF0IGluZGV4IGlmIGl0IGV4aXN0cwogICAgICAgIC8vYW5kIGluZGV4IGlzbid0IGFscmVhZHkgYXNzaWduZWQKICAgICAgICB2YXIgaSA9IHNjb3BlLiRldmFsKCIkaW5kZXgiKTsKICAgICAgICBpZihpICYmIGkgIT09ICckaW5kZXgnICYmICFpc29sYXRlLmluZGV4KSBpc29sYXRlLmluZGV4ID0gaTsKCiAgICAgICAgcmV0dXJuIGlzb2xhdGU7CiAgICAgIH0KICAgIH07CiAgfSk7CgoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFBbmltYXRpb24KICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRUEKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGlzIHVzZWQgdG8gYW5pbWF0ZSBhbiBlbGVtZW50IGluIGNvbmp1bmN0aW9uIHdpdGggYW4ge0BsaW5rIGFwaS9kaXJlY3RpdmUvYW5pbWF0ZSBhbmltYXRlfSBkaXJlY3RpdmUKICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLWFuaW1hdGlvbiB0aW1lbGluZT0iZnVuY3Rpb25UaGF0UmV0dXJuc0FUaW1lbGluZVZhbHVlQmV0d2VlbjBBbmQxIj4KICogIDxhbmltYXRlIHRhcmdldE1vZFNlbGVjdG9yPSIjdG9wTW9kIiBmaWVsZD0icm90YXRlWCIgc3RhcnRWYWx1ZT0iMy4xNDE1IiBlbmRWYWx1ZT0iMCIgY3VydmU9ImluUXVhZCIgdGltZWxpbmVMb3dlckJvdW5kPSIwIiB0aW1lbGluZVVwcGVyQm91bmQ9Ii4yNSIgLz4KICogPC9mYS1hbmltYXRpb24+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFBbmltYXRpb24nLCBbJyRmYW1vdXMnLCAnJGZhbW91c0RlY29yYXRvcicsIGZ1bmN0aW9uICgkZmFtb3VzLCBmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgdmFyIFRyYW5zZm9ybSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1RyYW5zZm9ybSddOwogICAgICAgIHZhciBUcmFuc2l0aW9uYWJsZSA9ICRmYW1vdXNbJ2ZhbW91cy90cmFuc2l0aW9ucy9UcmFuc2l0aW9uYWJsZSddOwogICAgICAgIHZhciBFYXNpbmcgPSAkZmFtb3VzWydmYW1vdXMvdHJhbnNpdGlvbnMvRWFzaW5nJ107CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSBmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSBmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaXNvbGF0ZS50aW1lbGluZSA9IHNjb3BlLiRldmFsKGF0dHJzLnRpbWVsaW5lKTsKICAgICAgICAgICAgICBpc29sYXRlLl90cmFucyA9IG5ldyBUcmFuc2l0aW9uYWJsZSgwKTsKCiAgICAgICAgICAgICAgaXNvbGF0ZS5wbGF5ID0gZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSB7CiAgICAgICAgICAgICAgICAgIGR1cmF0aW9uOiBzY29wZS4kZXZhbChhdHRycy5kdXJhdGlvbiksCiAgICAgICAgICAgICAgICAgIGN1cnZlOiBzY29wZS4kZXZhbChhdHRycy5jdXJ2ZSkgfHwgJ2xpbmVhcicKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpc29sYXRlLl90cmFucy5zZXQoMSwgdHJhbnNpdGlvbiwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgaWYoY2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgICAgaWYoYXR0cnMubG9vcCl7CiAgICAgICAgICAgICAgICAgICAgLy9GYW1vLnVzIHNpbGVudGx5IGJyZWFrcyBpdHMgdHJhbnNpdGlvbmFibGUgaWYgdGhpcyBydW5zIGluCiAgICAgICAgICAgICAgICAgICAgLy90aGUgc2FtZSBleGVjdXRpb24gY29udGV4dC4gIE1heWJlIGEgc3VwcHJlc3NlZCBTTyBlcnJvciBzb21ld2hlcmU/CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpe2lzb2xhdGUucmVwbGF5KGNhbGxiYWNrKX0sIDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIC8vVE9ETzogIGhhbmRsZSAkYW5pbWF0ZSB3aXRoIGEgY2FsbGJhY2sKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaXNvbGF0ZS5yZXNldCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpc29sYXRlLl90cmFucy5zZXQoMCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlzb2xhdGUucmVwbGF5ID0gZnVuY3Rpb24oY2FsbGJhY2spewogICAgICAgICAgICAgICAgaXNvbGF0ZS5yZXNldCgpOwogICAgICAgICAgICAgICAgaXNvbGF0ZS5wbGF5KGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vZGlzZW5nYWdlIGlzIGEgZnVuY3Rpb24gdGhhdAogICAgICAgICAgICAgIC8vY2FuIHVuYXNzaWduIHRoZSBldmVudCBsaXN0ZW5lcgogICAgICAgICAgICAgIHZhciBfZGlzZW5nYWdlID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgIGlmKGF0dHJzLmV2ZW50KXsKICAgICAgICAgICAgICAgIGlmKF9kaXNlbmdhZ2UpCiAgICAgICAgICAgICAgICAgIF9kaXNlbmdhZ2UoKTsKICAgICAgICAgICAgICAgIF9kaXNlbmdhZ2UgPSBzY29wZS4kb24oYXR0cnMuZXZlbnQsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IGRhdGEgJiYgZGF0YS5jYWxsYmFjayA/IGRhdGEuY2FsbGJhY2sgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgIGlzb2xhdGUucmVwbGF5KGNhbGxiYWNrKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciBpZCA9IGF0dHJzLmlkOwoKICAgICAgICAgICAgICBpZihpc29sYXRlLnRpbWVsaW5lID09PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgaXNvbGF0ZS50aW1lbGluZSA9IGlzb2xhdGUuX3RyYW5zLmdldC5iaW5kKGlzb2xhdGUuX3RyYW5zKTsKICAgICAgICAgICAgICAgIGlmKGF0dHJzLmF1dG9wbGF5KQogICAgICAgICAgICAgICAgICBpc29sYXRlLnBsYXkoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYoIWlzb2xhdGUudGltZWxpbmUgaW5zdGFuY2VvZiBGdW5jdGlvbikKICAgICAgICAgICAgICAgIHRocm93ICd0aW1lbGluZSBtdXN0IGJlIGEgcmVmZXJlbmNlIHRvIGEgZnVuY3Rpb24gb3IgZHVyYXRpb24gbXVzdCBiZSBwcm92aWRlZCc7CgoJICAgICAgICAgICAgLyoqCgkgICAgICAgICAgICAgKiBAbmdkb2MgZGlyZWN0aXZlCgkgICAgICAgICAgICAgKiBAbmFtZSBhbmltYXRlCgkgICAgICAgICAgICAgKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCgkgICAgICAgICAgICAgKiBAcmVzdHJpY3QgRQoJICAgICAgICAgICAgICogQGRlc2NyaXB0aW9uCgkgICAgICAgICAgICAgKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHNwZWNpZnkgdGhlIGFuaW1hdGlvbiBvZiBhbiBlbGVtZW50IGluIGEge0BsaW5rIGFwaS9kaXJlY3RpdmUvZmFBbmltYXRpb24gZmFBbmltYXRpb259IGRpcmVjdGl2ZQoJICAgICAgICAgICAgICoKCSAgICAgICAgICAgICAqIEB1c2FnZQoJICAgICAgICAgICAgICogYGBgaHRtbAoJICAgICAgICAgICAgICogPGZhLWFuaW1hdGlvbiB0aW1lbGluZT0iZnVuY3Rpb25UaGF0UmV0dXJuc0FUaW1lbGluZVZhbHVlQmV0d2VlbjBBbmQxIj4KCSAgICAgICAgICAgICAqICA8YW5pbWF0ZSB0YXJnZXRNb2RTZWxlY3Rvcj0iI3RvcE1vZCIgZmllbGQ9InJvdGF0ZVgiIHN0YXJ0VmFsdWU9IjMuMTQxNSIgZW5kVmFsdWU9IjAiIGN1cnZlPSJpblF1YWQiIHRpbWVsaW5lTG93ZXJCb3VuZD0iMCIgdGltZWxpbmVVcHBlckJvdW5kPSIuMjUiIC8+CgkgICAgICAgICAgICAgKiA8L2ZhLWFuaW1hdGlvbj4KCSAgICAgICAgICAgICAqIGBgYAoJICAgICAgICAgICAgICovCgogICAgICAgICAgICAgIHZhciBhbmltYXRlcyA9IGVsZW1lbnQuZmluZCgnYW5pbWF0ZScpOwogICAgICAgICAgICAgIHZhciBkZWNsYXJhdGlvbnMgPSB7fTsKCiAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IGFuaW1hdGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgIChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICB2YXIgYW5pbWF0ZSA9IGFuaW1hdGVzW2ldOwoKICAgICAgICAgICAgICAgICAgLy9ET00gc2VsZWN0b3Igc3RyaW5nIHRoYXQgcG9pbnRzIHRvIG91ciBtb2Qgb2YgaW50ZXJlc3QKICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZS5hdHRyaWJ1dGVzWyd0YXJnZXRtb2RzZWxlY3RvciddKXsKICAgICAgICAgICAgICAgICAgICAvL2RpZyBvdXQgdGhlIHJlZmVyZW5jZSB0byBvdXIgbW9kaWZpZXIKICAgICAgICAgICAgICAgICAgICAvL1RPRE86ICBzdXBwb3J0IHBhc3NpbmcgYSBkaXJlY3QgcmVmZXJlbmNlIHRvIGEgbW9kaWZpZXIKICAgICAgICAgICAgICAgICAgICAvLyAgICAgICBpbnN0ZWFkIG9mIHBlcmZvcm1pbmcgYSBET00gbG9va3VwCgkgICAgICAgICAgICAgICAgdmFyIG1vZEVsZW1lbnRzID0gYW5ndWxhci5lbGVtZW50KGVsZW1lbnRbMF0ucGFyZW50Tm9kZSlbMF0ucXVlcnlTZWxlY3RvckFsbChhbmltYXRlLmF0dHJpYnV0ZXNbJ3RhcmdldG1vZHNlbGVjdG9yJ10udmFsdWUpOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChtb2RFbGVtZW50cywgZnVuY3Rpb24obW9kRWxlbWVudCl7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kU2NvcGUgPSBhbmd1bGFyLmVsZW1lbnQobW9kRWxlbWVudCkuc2NvcGUoKTsKICAgICAgICAgICAgICAgICAgICAgIHZhciBtb2RpZmllciA9IG1vZFNjb3BlLmlzb2xhdGVbbW9kU2NvcGUuJGlkXS5tb2RpZmllcjsKICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRUcmFuc2Zvcm0gPSBtb2RTY29wZS5pc29sYXRlW21vZFNjb3BlLiRpZF0uZ2V0VHJhbnNmb3JtOwoKICAgICAgICAgICAgICAgICAgICAgIC8vVE9ETzogIHdvbid0IG5lZWQgdG8gc3BlY2lhbC1jYXNlIGN1cnZlIHR5cGUgJ2xpbmVhcicKICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgIG9uY2UvaWYgaXQgZXhpc3RzIGluIEVhc2luZy5qcwogICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnZlID0KICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZS5hdHRyaWJ1dGVzWydjdXJ2ZSddICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGUuYXR0cmlidXRlc1snY3VydmUnXS52YWx1ZSAhPT0gJ2xpbmVhcicgCiAgICAgICAgICAgICAgICAgICAgICAgID8gRWFzaW5nW2FuaW1hdGUuYXR0cmlidXRlc1snY3VydmUnXS52YWx1ZV0KICAgICAgICAgICAgICAgICAgICAgICAgOiBmdW5jdGlvbihqKSB7cmV0dXJuIGo7fTsgLy9saW5lYXIKCiAgICAgICAgICAgICAgICAgICAgICAvL2Fzc2lnbiB0aGUgbW9kaWZpZXIgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICBpZihhbmltYXRlLmF0dHJpYnV0ZXNbJ2ZpZWxkJ10pewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGQgPSBhbmltYXRlLmF0dHJpYnV0ZXNbJ2ZpZWxkJ10udmFsdWU7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG93ZXJCb3VuZCA9CiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGUuYXR0cmlidXRlc1sndGltZWxpbmVsb3dlcmJvdW5kJ10KICAgICAgICAgICAgICAgICAgICAgICAgICA/IHBhcnNlRmxvYXQoYW5pbWF0ZS5hdHRyaWJ1dGVzWyd0aW1lbGluZWxvd2VyYm91bmQnXS52YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IDA7CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXBwZXJCb3VuZCA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZS5hdHRyaWJ1dGVzWyd0aW1lbGluZXVwcGVyYm91bmQnXQogICAgICAgICAgICAgICAgICAgICAgICAgID8gcGFyc2VGbG9hdChhbmltYXRlLmF0dHJpYnV0ZXNbJ3RpbWVsaW5ldXBwZXJib3VuZCddLnZhbHVlKQogICAgICAgICAgICAgICAgICAgICAgICAgIDogMTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhbmltYXRlLmF0dHJpYnV0ZXNbJ3N0YXJ0dmFsdWUnXSkKICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAneW91IG11c3QgcHJvdmlkZSBhIHN0YXJ0IHZhbHVlIGZvciB0aGUgYW5pbWF0aW9uJwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnRWYWx1ZSA9IHNjb3BlLiRldmFsKGFuaW1hdGUuYXR0cmlidXRlc1snc3RhcnR2YWx1ZSddLnZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFhbmltYXRlLmF0dHJpYnV0ZXNbJ2VuZHZhbHVlJ10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJ3lvdSBtdXN0IHByb3ZpZGUgYW4gZW5kIHZhbHVlIGZvciB0aGUgYW5pbWF0aW9uJwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kVmFsdWUgPSBzY29wZS4kZXZhbChhbmltYXRlLmF0dHJpYnV0ZXNbJ2VuZFZhbHVlJ10udmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy9LZWVwIGFycmF5cyBvZiBhbGwgZGVjbGFyYXRpb25zIHNvIHRoYXQgdHJhbnNmb3JtRnVuY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgICAgIC8vY2FuIGhhbmRsZSBhbGwgb2YgdGhlIGFwcHJvcHJpYXRlIHNlZ21lbnRzCgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kRGVjcyA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjbGFyYXRpb25zW21vZFNjb3BlLiRpZF0gPQogICAgICAgICAgICAgICAgICAgICAgICAgIGRlY2xhcmF0aW9uc1ttb2RTY29wZS4kaWRdIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VnbWVudHMgPSBtb2REZWNzW2ZpZWxkXSA9IG1vZERlY3NbZmllbGRdIHx8IFtdOwogICAgICAgICAgICAgICAgICAgICAgICBzZWdtZW50cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogZmllbGQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJCb3VuZDogbG93ZXJCb3VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgICB1cHBlckJvdW5kOiB1cHBlckJvdW5kLAogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VmFsdWU6IHN0YXJ0VmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZW5kVmFsdWU6IGVuZFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnZlOiBjdXJ2ZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vS2VlcCBtb2REZWNzW2ZpZWxkXSBzb3J0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMuc29ydChmdW5jdGlvbihhLCBiKXsKICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5sb3dlckJvdW5kIC0gYi5sb3dlckJvdW5kOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vQ2hlY2sgZG9tYWluIG92ZXJsYXA6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vYWZ0ZXIgc29ydGluZyBieSBsb3dlckJvdW5kcywgaWYgYW55IHNlZ21lbnQncyBsb3dlciBib3VuZAogICAgICAgICAgICAgICAgICAgICAgICAvL2lzIGxvd2VyIHRoYW4gdGhlIGxvd2VyIGJvdW5kIG9mIGFueSBpdGVtIGJlZm9yZSBpdCwgZG9tYWlucyBhcmUKICAgICAgICAgICAgICAgICAgICAgICAgLy9vdmVybGFwcGluZwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAxOyBqIDwgc2VnbWVudHMubGVuZ3RoOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsb3dlciA9IHNlZ21lbnRzW2pdLmxvd2VyQm91bmQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBrID0gMDsgayA8IGo7IGsrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihsb3dlciA8IHNlZ21lbnRzW2tdLnVwcGVyQm91bmQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyAiQW5pbWF0ZSBzZWdtZW50cyBoYXZlIG92ZXJsYXBwaW5nIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb21haW5zIGZvciB0aGUgc2FtZSBmaWVsZCAoIiArIGZpZWxkICsgIikuIFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBdCBhbnkgcG9pbnQgaW4gdGhlIHRpbWVsaW5lLCBvbmx5IG9uZSA8YW5pbWF0ZT4gXAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbiBhZmZlY3QgYSBnaXZlbiBmaWVsZCBvbiB0aGUgc2FtZSBtb2RpZmllci4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAgICAgLy9Eb21haW46ICB0aW1lbGluZSBmdW5jdGlvbiBib3VuZGVkIFswLDFdCiAgICAgICAgICAgICAgICAgICAgICAgIC8vU3ViZG9tYWlucyAoYmV0d2VlbiBwaXBlcyk6ICBzcGVjaWZpZWQgc3ViZG9tYWlucyBvZiB0aW1lbGluZSBzZWdtZW50cwogICAgICAgICAgICAgICAgICAgICAgICAvL1JhbmdlOiAgb3V0cHV0IHZhbHVlLCBkZXRlcm1pbmVkIGJ5IGludGVycG9sYXRpbmcgc3RhcnRWYWx1ZSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgIGVuZFZhbHVlIHRocm91Z2ggdGhlIGVhc2luZyBjdXJ2ZXMuCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAgICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgICAgICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAgICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgfCAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAoZWFzZSkgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgIChlYXNlKSAgfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAgICAgLS98LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18LVwgICAgICAgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgICAgICAtLyAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgLVwgICAgICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAgIC0vICAgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgICAgLVwgICAgfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgLS8gICAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgLVwgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gLS0tLXwtLyAgICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgLVx8LS0tLS0tLQogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy9fX19fX3xfX19fX19fX19ffF9fX19fX19fX19fX19fX19fX19fX19ffF9fX19fX19fX198X19fX19fXwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfHgoMCwwKSAgICB8eCgwLDEpICAgICAgICAgICAgICAgICB8eCgxLDApICAgIHx4KDEsMSkKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vVE9ETzogIGluIG9yZGVyIHRvIHN1cHBvcnQgbmVzdGVkIGZhLWFuaW1hdGlvbiBkaXJlY3RpdmVzLAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICB0aGlzIGZ1bmN0aW9uIG5lZWRzIHRvIGJlIGV4cG9zZWQgc29tZWhvdy4gKHBhc3MgYSByZWZlcmVuY2UgaW50byB0aGUgZGlyZWN0aXZlOwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICBhbmQgdGhlbiBhc3NpZ24gdGhpcyBmdW5jdGlvbiB0byB0aGF0IHJlZmVyZW5jZT8pCiAgICAgICAgICAgICAgICAgICAgICAgIC8vVE9ETzogIGlmIG5lZWRlZDogIG1ha2UgdGhpcyBtb3JlIGVmZmljaWVudC4gIFRoaXMgaXMgYSBob3QtcnVubmluZwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICBmdW5jdGlvbiBhbmQgd2Ugc2hvdWxkIGJlIGFibGUgdG8gb3B0aW1pemUuCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2Zvcm1GdW5jdGlvbiA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHggPSBpc29sYXRlLnRpbWVsaW5lKCkgfHwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVsZXZhbnRJbmRleCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbGV2YW50U2VnbWVudCA9IHNlZ21lbnRzW3JlbGV2YW50SW5kZXhdOwoKICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgc2VnbWVudHMubGVuZ3RoOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90aGlzIGlzIHRoZSByZWxldmFudCBzZWdtZW50IGlmIHggaXMgaW4gdGhlIHN1YmRvbWFpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA+PSBzZWdtZW50c1tqXS5sb3dlckJvdW5kICYmIHggPD0gc2VnbWVudHNbal0udXBwZXJCb3VuZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGV2YW50U2VnbWVudCA9IHNlZ21lbnRzW2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcyBpcyB0aGUgcmVsZXZhbnQgc2VnbWVudCBpZiBpdCBpcyB0aGUgbGFzdCBvbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGogPT09IHNlZ21lbnRzLmxlbmd0aCAtIDEpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxldmFudFNlZ21lbnQgPSBzZWdtZW50c1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMgaXMgdGhlIHJlbGV2YW50IHNlZ21lbnQgaWYgeCBpcyBncmVhdGVyIHRoYW4gaXRzIHVwcGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2JvdW5kIGJ1dCBsZXNzIHRoYW4gdGhlIG5leHQgc2VnbWVudCdzIGxvd2VyIGJvdW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID49IHNlZ21lbnRzW2pdLnVwcGVyQm91bmQgJiYgeCA8IHNlZ21lbnRzW2ogKyAxXS5sb3dlckJvdW5kKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsZXZhbnRTZWdtZW50ID0gc2VnbWVudHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA8PSByZWxldmFudFNlZ21lbnQubG93ZXJCb3VuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWxldmFudFNlZ21lbnQuc3RhcnRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZih4ID49IHJlbGV2YW50U2VnbWVudC51cHBlckJvdW5kKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbGV2YW50U2VnbWVudC5lbmRWYWx1ZTsgCiAgICAgICAgICAgICAgICAgICAgICAgICAgLy9ub3JtYWxpemUgb3VyIGRvbWFpbiB0byBbMCwgMV0KICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3ViRG9tYWluID0gKHJlbGV2YW50U2VnbWVudC51cHBlckJvdW5kIC0gcmVsZXZhbnRTZWdtZW50Lmxvd2VyQm91bmQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRYID0gKHggLSByZWxldmFudFNlZ21lbnQubG93ZXJCb3VuZCkgLyBzdWJEb21haW47CgogICAgICAgICAgICAgICAgICAgICAgICAgIC8vU3VwcG9ydCBpbnRlcnBvbGF0aW5nIG11bHRpcGxlIHZhbHVlcywgZS5nLiBmb3IgYSBTY2FsZSBhcnJheSBbeCx5LHpdCiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoQXJyYXkuaXNBcnJheShyZWxldmFudFNlZ21lbnQuc3RhcnRWYWx1ZSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IHJlbGV2YW50U2VnbWVudC5zdGFydFZhbHVlLmxlbmd0aDsgaisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2goCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsZXZhbnRTZWdtZW50LnN0YXJ0VmFsdWVbal0gKyByZWxldmFudFNlZ21lbnQuY3VydmUobm9ybWFsaXplZFgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChyZWxldmFudFNlZ21lbnQuZW5kVmFsdWVbal0gLSByZWxldmFudFNlZ21lbnQuc3RhcnRWYWx1ZVtqXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVsZXZhbnRTZWdtZW50LnN0YXJ0VmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyByZWxldmFudFNlZ21lbnQuY3VydmUobm9ybWFsaXplZFgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICogKHJlbGV2YW50U2VnbWVudC5lbmRWYWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtIHJlbGV2YW50U2VnbWVudC5zdGFydFZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtQ29tcG9uZW50cyA9IG1vZERlY3MudHJhbnNmb3JtQ29tcG9uZW50cyA9IG1vZERlY3MudHJhbnNmb3JtQ29tcG9uZW50cyB8fCBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZpZWxkID09PSAnb3BhY2l0eScpewogICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmaWVyLm9wYWNpdHlGcm9tKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJhbnNmb3JtRnVuY3Rpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2UgaWYgKGZpZWxkID09PSAnb3JpZ2luJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXIub3JpZ2luRnJvbShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybUZ1bmN0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmIChmaWVsZCA9PT0gJ3NpemUnKXsKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZmllci5zaXplRnJvbShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybUZ1bmN0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNleyAvL3RyYW5zZm9ybSBmaWVsZAogICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zZm9ybUNvbXBvbmVudHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogZmllbGQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogdHJhbnNmb3JtRnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZmllci50cmFuc2Zvcm1Gcm9tKGZ1bmN0aW9uKCl7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG11bHQgPSBnZXRUcmFuc2Zvcm0gJiYgZ2V0VHJhbnNmb3JtKCkgPyBbZ2V0VHJhbnNmb3JtKCldIDogW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgdHJhbnNmb3JtQ29tcG9uZW50cy5sZW5ndGg7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNWYWwgPSB0cmFuc2Zvcm1Db21wb25lbnRzW2pdLmZuKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSB0cmFuc2Zvcm1Db21wb25lbnRzW2pdLmZpZWxkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkodHJhbnNWYWwpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbXVsdC5wdXNoKFRyYW5zZm9ybVtmXS5hcHBseSh0aGlzLCB0cmFuc1ZhbCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHQucHVzaChUcmFuc2Zvcm1bZl0odHJhbnNWYWwpKTsgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSgpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1RyYW5zZm9ybS5tdWx0aXBseSBmYWlscyBvbiBhcnJheXMgb2YgPD0xIG1hdHJpY2llcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobXVsdC5sZW5ndGggPT09IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtdWx0WzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcmFuc2Zvcm0ubXVsdGlwbHkuYXBwbHkodGhpcywgbXVsdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0pKCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDEpLy9lbmQgc2V0VGltZW91dAogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhQXBwCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB0aGUgY29udGFpbmVyIGFuZCBlbnRyeSBwb2ludCB0byBGYW1vLnVzL0FuZ3VsYXIuICBCZWhpbmQgdGhlIHNjZW5lcywKICogaXQgY3JlYXRlcyBhIEZhbW91cyBjb250ZXh0IGFuZCB0aGVuIGFkZHMgY2hpbGQgZWxlbWVudHMKICogdG8gdGhhdCBjb250ZXh0IGFzIHRoZXkgZ2V0IGNvbXBpbGVkLiAgSW5zaWRlIG9mIHRoaXMgZGlyZWN0aXZlLAogKiBub3JtYWwgSFRNTCBjb250ZW50IHdpbGwgbm90IGdldCByZW5kZXJlZCB0byB0aGUgc2NyZWVuIHVubGVzcwogKiBpdCBpcyBpbnNpZGUgb2YgYSB7QGxpbmsgYXBpL2RpcmVjdGl2ZS9mYVN1cmZhY2UgZmEtc3VyZmFjZX0gZGlyZWN0aXZlLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtYXBwIG5nLWNvbnRyb2xsZXI9Ik15Q3RybCI+CiAqICAgPCEtLSBvdGhlciBmYS0gc2NlbmUgZ3JhcGggY29tcG9uZW50cyAtLT4KICogPC9mYS1hcHA+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFBcHAnLCBbIiRmYW1vdXMiLCAiJGZhbW91c0RlY29yYXRvciIsIGZ1bmN0aW9uICgkZmFtb3VzLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZTogJzxkaXYgc3R5bGU9ImRpc3BsYXk6IG5vbmU7Ij48ZGl2PjwvZGl2PjwvZGl2PicsCiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIFZpZXcgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9WaWV3J107CiAgICAgICAgICAgIHZhciBFbmdpbmUgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FbmdpbmUnXTsKICAgICAgICAgICAgdmFyIFRyYW5zZm9ybSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1RyYW5zZm9ybSddCgogICAgICAgICAgICAKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmQoJzxkaXYgY2xhc3M9ImZhbW91cy1hbmd1bGFyLWNvbnRhaW5lciI+PC9kaXY+Jyk7CiAgICAgICAgICAgIGlzb2xhdGUuY29udGV4dCA9IEVuZ2luZS5jcmVhdGVDb250ZXh0KGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignLmZhbW91cy1hbmd1bGFyLWNvbnRhaW5lcicpKTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIEFwcFZpZXcoKXsKICAgICAgICAgICAgICBWaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIEFwcFZpZXcucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShWaWV3LnByb3RvdHlwZSk7CiAgICAgICAgICAgIEFwcFZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gQXBwVmlldzsKCiAgICAgICAgICAgIHZhciBnZXRPclZhbHVlID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgIHJldHVybiB4LmdldCA/IHguZ2V0KCkgOiB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIGdldFRyYW5zZm9ybSA9IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtcyA9IFtdOwogICAgICAgICAgICAgIGlmIChkYXRhLm1vZCgpLnRyYW5zbGF0ZSAmJiBkYXRhLm1vZCgpLnRyYW5zbGF0ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBkYXRhLm1vZCgpLnRyYW5zbGF0ZS5tYXAoZ2V0T3JWYWx1ZSkKICAgICAgICAgICAgICAgIHRyYW5zZm9ybXMucHVzaChUcmFuc2Zvcm0udHJhbnNsYXRlLmFwcGx5KHRoaXMsIHZhbHVlcykpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2NvcGVbImZhUm90YXRlWiJdKQogICAgICAgICAgICAgICAgdHJhbnNmb3Jtcy5wdXNoKFRyYW5zZm9ybS5yb3RhdGVaKHNjb3BlWyJmYVJvdGF0ZVoiXSkpOwogICAgICAgICAgICAgIGlmIChzY29wZVsiZmFTa2V3Il0pCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goVHJhbnNmb3JtLnNrZXcoMCwgMCwgc2NvcGVbImZhU2tldyJdKSk7CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zZm9ybS5tdWx0aXBseS5hcHBseSh0aGlzLCB0cmFuc2Zvcm1zKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlzb2xhdGUudmlldyA9IG5ldyBBcHBWaWV3KCk7CiAgICAgICAgICAgIGlzb2xhdGUuY29udGV4dC5hZGQoaXNvbGF0ZS52aWV3KTsKCiAgICAgICAgICAgIC8vSEFDSzogIFNpbmNlIEZhbW8udXMgRW5naW5lIGRvZXNuJ3QgeWV0CiAgICAgICAgICAgIC8vc3VwcG9ydCB1bnJlZ2lzdGVyaW5nIGNvbnRleHRzLCB0aGlzIHdpbGwga2VlcAogICAgICAgICAgICAvL3RoZSBjb250ZXh0IGZyb20gZ2V0dGluZyB1cGRhdGVkIGJ5IHRoZSBlbmdpbmUKICAgICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaXNvbGF0ZS5jb250ZXh0LnVwZGF0ZSA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgfSkKCgogICAgICAgICAgICAvL1RPRE86ICBXaGF0IGlmIHRoZSBhY3R1YWwgc2NvcGUgaGllcmFyY2h5CiAgICAgICAgICAgIC8vd2VyZSBhbmd1bGFyICR3YXRjaGVkIGluc3RlYWQgb2YgdXNpbmcgZXZlbnRpbmc/CiAgICAgICAgICAgIC8vQ291bGQgd3JpdGUgYSBmdW5jdGlvbiB0aGF0IHRyYXZlcnNlcyBhbmd1bGFyJ3Mgc2NvcGVzCiAgICAgICAgICAgIC8vYW5kIHJldHVybnMgYSBoYXNoLWxpa2UKICAgICAgICAgICAgLy9yZXByZXNlbnRhdGlvbiBvZiByZW5kZXItbm9kZS1jb250YWluaW5nICRzY29wZXMKICAgICAgICAgICAgLy8odmlhIHRoZWlyIGlzb2xhdGUgb2JqZWN0cy4pICBUaGVuLCB0d2VhayB0aGUgc2NlbmUKICAgICAgICAgICAgLy9ncmFwaCBhcyBuZWVkZWQgd2hlbiBpdCBzZWVzIGNoYW5nZXMuCiAgICAgICAgICAgIC8vVGhpcyB3b3VsZCBtYWtlIGUuZy4gcmVmbG93aW5nIGVsZW1lbnRzIGluIGEgc2Nyb2xsdmlldwogICAgICAgICAgICAvL21vcmUgZWxlZ2FudCB0aGFuIHRoZSBjdXJyZW50IGFwcHJvYWNoLCBidXQgd291bGQKICAgICAgICAgICAgLy9yZXF1aXJlIGEgYml0IG9mIHJlcGx1bWJpbmcuICBXb3VsZCBuZWVkIHRvIGludmVzdGlnYXRlCiAgICAgICAgICAgIC8vdGhlIG92ZXJoZWFkIG9mICR3YXRjaGluZyBhIHBvdGVudGlhbGx5IGNvbXBsZXggc2NlbmUgZ3JhcGgsIHRvbwogICAgICAgICAgICBzY29wZS4kb24oJ3JlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlzb2xhdGUudmlldy5hZGQoZGF0YS5yZW5kZXJOb2RlKTsKICAgICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKCiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgdHJhbnNjbHVkZShzY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKCSAgICAgICAgICAgIGFuZ3VsYXIuZWxlbWVudChlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3JBbGwoJ2RpdiBkaXYnKVswXSkuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlzb2xhdGUucmVhZHlUb1JlbmRlciA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhQ2xpY2sKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGZhQ2xpY2sge0BsaW5rIGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2d1aWRlL2V4cHJlc3Npb24gRXhwcmVzc2lvbn0gdG8gZXZhbHVhdGUgdXBvbgogKiBjbGljay4gKHtAbGluayBodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9ndWlkZS9leHByZXNzaW9uIy1ldmVudC0gRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YH0pCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIHdoZW4gYW4gZWxlbWVudCBpcyBjbGlja2VkLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8QU5ZIGZhLWNsaWNrPSJleHByZXNzaW9uIj4KICoKICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFDbGljaycsIFsiJHBhcnNlIiwgIiRmYW1vdXNEZWNvcmF0b3IiLGZ1bmN0aW9uICgkcGFyc2UsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIGlmIChhdHRycy5mYUNsaWNrKSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlck5vZGUgPSAoaXNvbGF0ZS5yZW5kZXJOb2RlLl9ldmVudElucHV0IHx8IGlzb2xhdGUucmVuZGVyTm9kZSkKCiAgICAgICAgICAgICAgcmVuZGVyTm9kZS5vbigiY2xpY2siLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cnMuZmFDbGljayk7CiAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDpkYXRhfSk7CiAgICAgICAgICAgICAgICBpZighc2NvcGUuJCRwaGFzZSkKICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFHcmlkTGF5b3V0CiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSB3aWxsIGNyZWF0ZSBhIEZhbW8udXMgR3JpZExheW91dCBjb250YWluaW5nIHRoZSAKICogc3BlY2lmaWVkIGNoaWxkIGVsZW1lbnRzLiBUaGUgcHJvdmlkZWQgYG9wdGlvbnNgIG9iamVjdAogKiB3aWxsIHBhc3MgZGlyZWN0bHkgdGhyb3VnaCB0byB0aGUgRmFtby51cyBHcmlkTGF5b3V0J3MKICogY29uc3RydWN0b3IuICBTZWUgW2h0dHBzOi8vZmFtby51cy9kb2NzLzAuMS4xL3ZpZXdzL0dyaWRMYXlvdXQvXQogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtZ3JpZC1sYXlvdXQgZmEtb3B0aW9ucz0ic2NvcGVPcHRpb25zT2JqZWN0Ij4KICogICA8IS0tIHplcm8gb3IgbW9yZSByZW5kZXIgbm9kZXMgLS0+CiAqIDwvZmEtZ3JpZC1sYXlvdXQ+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFHcmlkTGF5b3V0JywgWyIkZmFtb3VzIiwgIiRmYW1vdXNEZWNvcmF0b3IiLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsCiAgICAgIHJlc3RyaWN0OiAnRScsCiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbSwgdEF0dHJzLCB0cmFuc2NsdWRlKXsKICAgICAgICByZXR1cm4gIHsKICAgICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgdmFyIEdyaWRMYXlvdXQgPSAkZmFtb3VzWyJmYW1vdXMvdmlld3MvR3JpZExheW91dCJdOwogICAgICAgICAgICB2YXIgVmlld1NlcXVlbmNlID0gJGZhbW91c1snZmFtb3VzL2NvcmUvVmlld1NlcXVlbmNlJ107CgogICAgICAgICAgICB2YXIgX2NoaWxkcmVuID0gW107CgogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHNjb3BlLiRldmFsKGF0dHJzLmZhT3B0aW9ucykgfHwge307CiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IG5ldyBHcmlkTGF5b3V0KG9wdGlvbnMpOwoKICAgICAgICAgICAgdmFyIHVwZGF0ZUdyaWRMYXlvdXQgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIF9jaGlsZHJlbi5zb3J0KGZ1bmN0aW9uKGEsIGIpewogICAgICAgICAgICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXF1ZW5jZUZyb20oZnVuY3Rpb24oX2NoaWxkcmVuKSB7CgkgICAgICAgICAgICAgIHZhciBfY2ggPSBbXTsKCSAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKF9jaGlsZHJlbiwgZnVuY3Rpb24oYywgaSkgewoJCSAgICAgICAgICAgICAgX2NoW2ldID0gYy5yZW5kZXJOb2RlOwoJICAgICAgICAgICAgICB9KQoJICAgICAgICAgICAgICByZXR1cm4gX2NoOwogICAgICAgICAgICAgIH0oX2NoaWxkcmVuKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNjb3BlLiRvbigncmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPSBzY29wZS4kaWQpewogICAgICAgICAgICAgICAgX2NoaWxkcmVuLnB1c2goZGF0YSk7CiAgICAgICAgICAgICAgICB1cGRhdGVHcmlkTGF5b3V0KCk7CiAgICAgICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kb24oJ3VucmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPSBzY29wZS4kaWQpewoJICAgICAgICAgICAgX2NoaWxkcmVuID0gZnVuY3Rpb24oX2NoaWxkcmVuKSB7CgkJICAgICAgICAgIHZhciBfY2ggPSBbXTsKCQkgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKF9jaGlsZHJlbiwgZnVuY3Rpb24oYykgewoJCQkgICAgICAgIGlmKGMuaWQgIT09IGRhdGEuaWQpIHsKCQkJCSAgICAgIF9jaC5wdXNoKGMpOwoJCQkgICAgICAgIH0KCQkgICAgICAgICAgfSk7CgkJICAgICAgICAgIHJldHVybiBfY2g7CgkgICAgICAgICAgICB9KF9jaGlsZHJlbik7CiAgICAgICAgICAgICAgICB1cGRhdGVHcmlkTGF5b3V0KCk7CiAgICAgICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQoKICAgICAgICAgIH0sCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2NsdWRlKHNjb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnZGl2JykuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kZW1pdCgncmVnaXN0ZXJDaGlsZCcsIGlzb2xhdGUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFJbWFnZVN1cmZhY2UKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRUEKICogQHBhcmFtIHtTdHJpbmd9IGZhSW1hZ2VVcmwgIC0gIFN0cmluZyB1cmwgcG9pbnRpbmcgdG8gdGhlIGltYWdlIHRoYXQgc2hvdWxkIGJlIGxvYWRlZCBpbnRvIHRoZSBGYW1vLnVzIEltYWdlU3VyZmFjZQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgY3JlYXRlcyBhIEZhbW8udXMgSW1hZ2VTdXJmYWNlIGFuZCBsb2FkcwogKiB0aGUgc3BlY2lmaWVkIEltYWdlVXJsLgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtaW1hZ2Utc3VyZmFjZSBmYS1pbWFnZS11cmw9ImltZy9teS1pbWFnZS5wbmciPgogKiA8L2ZhLWltYWdlLXN1cmZhY2U+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFJbWFnZVN1cmZhY2UnLCBbIiRmYW1vdXMiLCAiJGZhbW91c0RlY29yYXRvciIsIGZ1bmN0aW9uICgkZmFtb3VzLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICBzY29wZTogdHJ1ZSwKICAgICAgdGVtcGxhdGU6ICc8ZGl2IGNsYXNzPSJmYS1pbWFnZS1zdXJmYWNlIj48L2Rpdj4nLAogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW0sIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgdmFyIEltYWdlU3VyZmFjZSA9ICRmYW1vdXNbJ2ZhbW91cy9zdXJmYWNlcy9JbWFnZVN1cmZhY2UnXTsKICAgICAgICAgICAgdmFyIFRyYW5zZm9ybSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1RyYW5zZm9ybSddCiAgICAgICAgICAgIHZhciBFdmVudEhhbmRsZXIgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FdmVudEhhbmRsZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vdXBkYXRlIHByb3BlcnRpZXMKICAgICAgICAgICAgLy9UT0RPOiAgaXMgdGhpcyBnb2luZyB0byBiZSBhIGJvdHRsZW5lY2s/CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcmV0dXJuIGlzb2xhdGUuZ2V0UHJvcGVydGllcygpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaWYoaXNvbGF0ZS5yZW5kZXJOb2RlKQogICAgICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2V0UHJvcGVydGllcyhpc29sYXRlLmdldFByb3BlcnRpZXMoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlzb2xhdGUuZ2V0UHJvcGVydGllcyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogc2NvcGUuJGV2YWwoYXR0cnMuZmFCYWNrZ3JvdW5kQ29sb3IpLAogICAgICAgICAgICAgICAgY29sb3I6IHNjb3BlLiRldmFsKGF0dHJzLmZhQ29sb3IpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBnZXRPclZhbHVlID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgIHJldHVybiB4LmdldCA/IHguZ2V0KCkgOiB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlID0gbmV3IEltYWdlU3VyZmFjZSh7CiAgICAgICAgICAgICAgc2l6ZTogc2NvcGUuJGV2YWwoYXR0cnMuZmFTaXplKSwKICAgICAgICAgICAgICBjbGFzczogc2NvcGUuJGV2YWwoYXR0cnMuY2xhc3MpLAogICAgICAgICAgICAgIHByb3BlcnRpZXM6IGlzb2xhdGUuZ2V0UHJvcGVydGllcygpCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy9UT0RPOiAgc3VwcG9ydCBuZy1jbGFzcwogICAgICAgICAgICBpZihhdHRycy5jbGFzcykKICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2V0Q2xhc3NlcyhhdHRyc1snY2xhc3MnXS5zcGxpdCgnICcpKTsKCiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHVwZGF0ZUNvbnRlbnQgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXRDb250ZW50KGF0dHJzLmZhSW1hZ2VVcmwpCiAgICAgICAgICAgIH07CgogICAgICAgICAgICB1cGRhdGVDb250ZW50KCk7CgogICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZSgnZmFJbWFnZVVybCcsIHVwZGF0ZUNvbnRlbnQpOwoKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJ3JlZ2lzdGVyQ2hpbGQnLCBpc29sYXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFJbmRleAogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHNwZWNpZnkgdGhlIHJlbmRlcmluZyBvcmRlciBvZiBlbGVtZW50cwogKiBpbnNpZGUgb2YgYSBWaWV3U2VxdWVuY2UtYmFzZWQgY29tcG9uZW50LCBzdWNoIGFzIEBsaW5rIGFwaS9kaXJlY3RpdmUvZmFTY3JvbGxWaWV3IGZhU2Nyb2xsVmlld30KICogb3IgQGxpbmsgYXBpL2RpcmVjdGl2ZS9mYUdyaWRMYXlvdXQgZmFHcmlkTGF5b3V0fS4gIEFzIGEgc3BlY2lhbCBjYXNlLCB3aGVuIGVsZW1lbnRzIGFyZSBhZGRlZCB0bwogKiB0aGVzZSBjb250cm9scyB1c2luZyBuZy1yZXBlYXQsIHRoZXkgYXJlIGF1dG9tYXRpY2FsbHkgYXNzaWduZWQgdGhlCiAqICRpbmRleCBwcm9wZXJ0eSBleHBvc2VkIGJ5IG5nLXJlcGVhdC4gIFdoZW4gYWRkaW5nIGVsZW1lbnRzIG1hbnVhbGx5CiAqIChlLmcuIHRvIGEgZmFTY3JvbGxWaWV3IGJ1dCBub3QgdXNpbmcgbmctcmVwZWF0KSBvciBpbiBhIGNhc2Ugd2hlcmUgY3VzdG9tCiAqIG9yZGVyIGlzIGRlc2lyZWQsIHRoZW4gdGhlIGluZGV4IHZhbHVlIG11c3QgYmUgYXNzaWduZWQvb3ZlcnJpZGRlbiB1c2luZyB0aGUgZmFJbmRleCBkaXJlY3RpdmUuCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1zY3JvbGwtdmlldz4KICogIDxmYS1zdXJmYWNlIGZhLWluZGV4PSIwIj5TdXJmYWNlIDE8L2ZhLXN1cmZhY2U+CiAqICA8ZmEtc3VyZmFjZSBmYS1pbmRleD0iMSI+U3VyZmFjZSAyPC9mYS1zdXJmYWNlPgogKiA8L2ZhLXNjcm9sbC12aWV3PgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhSW5kZXgnLCBbIiRwYXJzZSIsICIkZmFtb3VzRGVjb3JhdG9yIiwgZnVuY3Rpb24gKCRwYXJzZSwgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgc2NvcGU6IGZhbHNlLAogICAgICBwcmlvcml0eTogMTYsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgaXNvbGF0ZS5pbmRleCA9IHNjb3BlLiRldmFsKGF0dHJzLmZhSW5kZXgpOwoKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmZhSW5kZXgpCiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgaXNvbGF0ZS5pbmRleCA9IHNjb3BlLiRldmFsKGF0dHJzLmZhSW5kZXgpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYU1vZGlmaWVyCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBwYXJhbSB7QXJyYXl8RnVuY3Rpb259IGZhUm90YXRlICAtICBBcnJheSBvZiBudW1iZXJzIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBudW1iZXJzIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyByb3RhdGUgc2hvdWxkIGJlIGJvdW5kLgogKiBAcGFyYW0ge051bWJlcnxGdW5jdGlvbn0gZmFSb3RhdGVYICAtICBOdW1iZXIgb3IgZnVuY3Rpb24gcmV0dXJuaW5nIGEgbnVtYmVyIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyByb3RhdGVYIHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge051bWJlcnxGdW5jdGlvbn0gZmFSb3RhdGVZICAtICBOdW1iZXIgb3IgZnVuY3Rpb24gcmV0dXJuaW5nIGEgbnVtYmVyIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyByb3RhdGVZIHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge051bWJlcnxGdW5jdGlvbn0gZmFSb3RhdGVaICAtICBOdW1iZXIgb3IgZnVuY3Rpb24gcmV0dXJuaW5nIGEgbnVtYmVyIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyByb3RhdGVaIHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufSBmYVNjYWxlICAtICBBcnJheSBvZiBudW1iZXJzIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBudW1iZXJzIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyBzY2FsZSBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbn0gZmFTa2V3ICAtICBBcnJheSBvZiBudW1iZXJzIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBudW1iZXJzIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyBza2V3IHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufSBmYUFib3V0T3JpZ2luICAtICBBcnJheSBvZiBhcmd1bWVudHMgKG9yIGEgZnVuY3Rpb24gcmV0dXJuaW5nIGFuIGFycmF5IG9mIGFyZ3VtZW50cykgdG8gcGFzcyB0byBUcmFuc2Zvcm0uYWJvdXRPcmlnaW4KICogQHBhcmFtIHtOdW1iZXJ8RnVuY3Rpb259IGZhUGVyc3BlY3RpdmUgIC0gIE51bWJlciBvciBhcnJheSByZXR1cm5pbmcgYSBudW1iZXIgdG8gd2hpY2ggdGhpcyBtb2RpZmllcidzIHBlcnNwZWN0aXZlIChmb2N1c1opIHNob3VsZCBiZSBib3VuZC4KICogQHBhcmFtIHtUcmFuc2Zvcm19IGZhVHJhbnNmb3JtIC0gTWFudWFsbHkgY3JlYXRlZCBGYW1vLnVzIFRyYW5zZm9ybSBvYmplY3QgKGFuIGFycmF5KSB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gdGhlIG1vZGlmaWVyLiAgKldpbGwgb3ZlcnJpZGUgYWxsIG90aGVyIHRyYW5zZm9ybSBhdHRyaWJ1dGVzLioKICogQHBhcmFtIHtOdW1iZXJ8RnVuY3Rpb258VHJhbnNpdGlvbmFibGV9IGZhT3BhY2l0eSAgLSAgTnVtYmVyIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhIG51bWJlciB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgb3BhY2l0eSBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxUcmFuc2l0aW9uYWJsZX0gZmFTaXplICAtICBBcnJheSBvZiBudW1iZXJzIChlLmcuIFsxMDAsIDUwMF0gZm9yIHRoZSB4LSBhbmQgeS1zaXplcykgb3IgZnVuY3Rpb24gcmV0dXJuaW5nIGFuIGFycmF5IG9mIG51bWJlcnMgdG8gd2hpY2ggdGhpcyBNb2RpZmllcidzIHNpemUgc2hvdWxkIGJlIGJvdW5kCiAqIEBwYXJhbSB7QXJyYXl8RnVuY3Rpb258VHJhbnNpdGlvbmFibGV9IGZhT3JpZ2luICAtICBBcnJheSBvZiBudW1iZXJzIChlLmcuIFsuNSwgMF0gZm9yIHRoZSB4LSBhbmQgeS1vcmlnaW5zKSBvciBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgbnVtYmVycyB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgb3JpZ2luIHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufFRyYW5zaXRpb25hYmxlfSBmYUFsaWduICAtICBBcnJheSBvZiBudW1iZXJzIChlLmcuIFsuNSwgMF0gZm9yIHRoZSB4LSBhbmQgeS1hbGlnbnMpIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBudW1iZXJzIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyBhbGlnbiBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheS5TdHJpbmd9IGZhVHJhbnNmb3JtT3JkZXIgIC0gIE9wdGlvbmFsIGFycmF5IG9mIHN0cmluZ3MgdG8gc3BlY2lmeSB3aGljaCB0cmFuc2Zvcm1zIHRvIGFwcGx5IGFuZCBpbiB3aGljaCBvcmRlci4gKGUuZy4gYGZhLXRyYW5zZm9ybS1vcmRlcj0iWydyb3RhdGVaJywgJ3RyYW5zbGF0ZScsICdzY2FsZSddImApICBEZWZhdWx0IGJlaGF2aW9yIGlzIHRvIGV2YWx1YXRlIGFsbCBzdXBwb3J0ZWQgdHJhbnNmb3JtcyBhbmQgYXBwbHkgdGhlbSBpbiBhbHBoYWJldGljYWwgb3JkZXIuCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBjcmVhdGVzIGEgRmFtby51cyBNb2RpZmllciB0aGF0IHdpbGwgYWZmZWN0IGFsbCBjaGlsZHJlbiByZW5kZXIgbm9kZXMuICBJdHMgcHJvcGVydGllcyBjYW4gYmUgYm91bmQKICogdG8gdmFsdWVzIChlLmcuIGBmYS10cmFuc2xhdGU9IlsxNSwgMjAsIDFdImAsIEZhbW8udXMgVHJhbnNpdGlvbmFibGUgb2JqZWN0cywgb3IgdG8gZnVuY3Rpb25zIHRoYXQgcmV0dXJuIG51bWJlcnMuCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1tb2RpZmllciBmYS1vcGFjaXR5PSIuMjUiIGZhLXNrZXc9Im15U2NvcGVTa2V3VmFyaWFibGUiIGZhLXRyYW5zbGF0ZT0iWzI1LCA1MCwgMl0iIGZhLXNjYWxlPSJteVNjb3BlRnVuY3Rpb25UaGF0UmV0dXJuc0FuQXJyYXkiPgogKiAgIDwhLS0gQ2hpbGQgZWxlbWVudHMgb2YgdGhpcyBmYS1tb2RpZmllciB3aWxsIGJlIGFmZmVjdGVkIGJ5IHRoZSB2YWx1ZXMgYWJvdmUgLS0+CiAqICAgPGZhLXN1cmZhY2U+SSdtIHRyYW5zbHVjZW50LCBza2V3ZWQsIHJvdGF0ZWQsIGFuZCB0cmFuc2xhdGVkPC9mYS1zdXJmYWNlPgogKiA8L2ZhLW1vZGlmaWVyPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhTW9kaWZpZXInLCBbIiRmYW1vdXMiLCAiJGZhbW91c0RlY29yYXRvciIsICIkcGFyc2UiLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvciwgJHBhcnNlKSB7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+JywKICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIHByaW9yaXR5OiAyLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciBSZW5kZXJOb2RlID0gJGZhbW91c1snZmFtb3VzL2NvcmUvUmVuZGVyTm9kZSddCiAgICAgICAgICAgIHZhciBNb2RpZmllciA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL01vZGlmaWVyJ10KICAgICAgICAgICAgdmFyIFRyYW5zZm9ybSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1RyYW5zZm9ybSddCgogICAgICAgICAgICB2YXIgZ2V0ID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgIGlmICh4IGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiB4KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHguZ2V0ID8geC5nZXQoKSA6IHg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICAvL1RPRE86ICBtYWtlIGEgc3RhbmQtYWxvbmUgd2luZG93LWxldmVsIHV0aWxpdHkKICAgICAgICAgICAgLy8gICAgICAgb2JqZWN0IHRvIHN0b3JlIHN0dWZmIGxpa2UgdGhpcwogICAgICAgICAgICAvKiBDb3BpZWQgZnJvbSBhbmd1bGFyLmpzICovCiAgICAgICAgICAgIHZhciBTUEVDSUFMX0NIQVJTX1JFR0VYUCA9IC8oW1w6XC1cX10rKC4pKS9nOwogICAgICAgICAgICB2YXIgTU9aX0hBQ0tfUkVHRVhQID0gL15tb3ooW0EtWl0pLzsKICAgICAgICAgICAgZnVuY3Rpb24gY2FtZWxDYXNlKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gbmFtZS4KICAgICAgICAgICAgICAgIHJlcGxhY2UoU1BFQ0lBTF9DSEFSU19SRUdFWFAsIGZ1bmN0aW9uKF8sIHNlcGFyYXRvciwgbGV0dGVyLCBvZmZzZXQpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mZnNldCA/IGxldHRlci50b1VwcGVyQ2FzZSgpIDogbGV0dGVyOwogICAgICAgICAgICAgICAgfSkuCiAgICAgICAgICAgICAgICByZXBsYWNlKE1PWl9IQUNLX1JFR0VYUCwgJ01veiQxJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFBSRUZJWF9SRUdFWFAgPSAvXih4W1w6XC1fXXxkYXRhW1w6XC1fXSkvaTsKICAgICAgICAgICAgZnVuY3Rpb24gZGlyZWN0aXZlTm9ybWFsaXplKG5hbWUpIHsKICAgICAgICAgICAgICByZXR1cm4gY2FtZWxDYXNlKG5hbWUucmVwbGFjZShQUkVGSVhfUkVHRVhQLCAnJykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qIGVuZCBjb3B5IGZyb20gYW5ndWxhci5qcyAqLwoKICAgICAgICAgICAgdmFyIF90cmFuc2Zvcm1GaWVsZHMgPSBbCiAgICAgICAgICAgICAgImFib3V0T3JpZ2luIiwKICAgICAgICAgICAgICAicGVyc3BlY3RpdmUiLAogICAgICAgICAgICAgICJyb3RhdGUiLAogICAgICAgICAgICAgICJyb3RhdGVBeGlzIiwKICAgICAgICAgICAgICAicm90YXRlWCIsCiAgICAgICAgICAgICAgInJvdGF0ZVkiLAogICAgICAgICAgICAgICJyb3RhdGVaIiwKICAgICAgICAgICAgICAic2NhbGUiLAogICAgICAgICAgICAgICJza2V3IiwKICAgICAgICAgICAgICAidHJhbnNsYXRlIgogICAgICAgICAgICBdOwoKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhVHJhbnNmb3JtT3JkZXInLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBzY29wZS4kZXZhbChhdHRycy5mYVRyYW5zZm9ybU9yZGVyKTsKICAgICAgICAgICAgICBpZihjYW5kaWRhdGUgIT09IHVuZGVmaW5lZCkgX3RyYW5zZm9ybUZpZWxkcyA9IGNhbmRpZGF0ZTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgX3BhcnNlZFRyYW5zZm9ybXMgPSB7fTsKICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKF90cmFuc2Zvcm1GaWVsZHMsIGZ1bmN0aW9uKGZpZWxkKXsKICAgICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSBkaXJlY3RpdmVOb3JtYWxpemUoJ2ZhLScgKyBmaWVsZCk7CiAgICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoYXR0ck5hbWUsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBfcGFyc2VkVHJhbnNmb3Jtc1tmaWVsZF0gPSAkcGFyc2UoYXR0cnNbYXR0ck5hbWVdKTsKICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KQoKCiAgICAgICAgICAgIHZhciBfdHJhbnNmb3JtRm4gPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYVRyYW5zZm9ybScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgX3RyYW5zZm9ybUZuID0gJHBhcnNlKGF0dHJzLmZhVHJhbnNmb3JtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlzb2xhdGUuZ2V0VHJhbnNmb3JtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgLy9pZiBmYVRyYW5zZm9ybSBpcyBwcm92aWRlZCwgcmV0dXJuIGl0CiAgICAgICAgICAgICAgLy9pbnN0ZWFkIG9mIGxvb3BpbmcgdGhyb3VnaCB0aGUgb3RoZXIgdHJhbnNmb3Jtcy4KICAgICAgICAgICAgICB2YXIgb3ZlcnJpZGUgPSBfdHJhbnNmb3JtRm4oc2NvcGUpOwogICAgICAgICAgICAgIGlmKG92ZXJyaWRlICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgaWYob3ZlcnJpZGUgaW5zdGFuY2VvZiBGdW5jdGlvbikgcmV0dXJuIG92ZXJyaWRlKCk7CiAgICAgICAgICAgICAgICBlbHNlIGlmKG92ZXJyaWRlIGluc3RhbmNlb2YgT2JqZWN0ICYmIG92ZXJyaWRlLmdldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gb3ZlcnJpZGUuZ2V0KCk7CiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBvdmVycmlkZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIHZhciB0cmFuc2Zvcm1zID0gW107CiAgICAgICAgICAgICAgYW5ndWxhci5mb3JFYWNoKF90cmFuc2Zvcm1GaWVsZHMsIGZ1bmN0aW9uKGZpZWxkKXsKICAgICAgICAgICAgICAgIHZhciBjYW5kaWRhdGUgPSBfcGFyc2VkVHJhbnNmb3Jtc1tmaWVsZF0gPyBfcGFyc2VkVHJhbnNmb3Jtc1tmaWVsZF0oc2NvcGUpIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgaWYoY2FuZGlkYXRlICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBpZihjYW5kaWRhdGUgaW5zdGFuY2VvZiBGdW5jdGlvbikgdHJhbnNmb3Jtcy5wdXNoKGNhbmRpZGF0ZSgpKQogICAgICAgICAgICAgICAgICBlbHNlIGlmKGNhbmRpZGF0ZSBpbnN0YW5jZW9mIEFycmF5KSB0cmFuc2Zvcm1zLnB1c2goVHJhbnNmb3JtW2ZpZWxkXS5hcHBseSh0aGlzLCBjYW5kaWRhdGUpKQogICAgICAgICAgICAgICAgICBlbHNlIHRyYW5zZm9ybXMucHVzaChUcmFuc2Zvcm1bZmllbGRdLmNhbGwodGhpcywgY2FuZGlkYXRlKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIGlmKCF0cmFuc2Zvcm1zLmxlbmd0aCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICBlbHNlIGlmICh0cmFuc2Zvcm1zLmxlbmd0aCA9PT0gMSkgcmV0dXJuIHRyYW5zZm9ybXNbMF0KICAgICAgICAgICAgICBlbHNlIHJldHVybiBUcmFuc2Zvcm0ubXVsdGlwbHkuYXBwbHkodGhpcywgdHJhbnNmb3Jtcyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgX2FsaWduRm4gPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYUFsaWduJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBfYWxpZ25GbiA9ICRwYXJzZShhdHRycy5mYUFsaWduKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlzb2xhdGUuZ2V0QWxpZ24gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciByZXQgPSBfYWxpZ25GbihzY29wZSk7CiAgICAgICAgICAgICAgaWYocmV0IGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiByZXQoKTsKICAgICAgICAgICAgICBlbHNlIGlmKHJldCBpbnN0YW5jZW9mIE9iamVjdCAmJiByZXQuZ2V0ICE9PSB1bmRlZmluZWQpIHJldHVybiByZXQuZ2V0KCk7CiAgICAgICAgICAgICAgZWxzZSByZXR1cm4gcmV0OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX29wYWNpdHlGbiA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhT3BhY2l0eScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgX29wYWNpdHlGbiA9ICRwYXJzZShhdHRycy5mYU9wYWNpdHkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaXNvbGF0ZS5nZXRPcGFjaXR5ID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgcmV0ID0gX29wYWNpdHlGbihzY29wZSk7CiAgICAgICAgICAgICAgaWYocmV0ID09PSB1bmRlZmluZWQpIHJldHVybiAxOwogICAgICAgICAgICAgIGVsc2UgaWYocmV0IGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiByZXQoKTsKICAgICAgICAgICAgICBlbHNlIGlmKHJldCBpbnN0YW5jZW9mIE9iamVjdCAmJiByZXQuZ2V0ICE9PSB1bmRlZmluZWQpIHJldHVybiByZXQuZ2V0KCk7CiAgICAgICAgICAgICAgZWxzZSByZXR1cm4gcmV0OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX3NpemVGbiA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhU2l6ZScsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgX3NpemVGbiA9ICRwYXJzZShhdHRycy5mYVNpemUpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaXNvbGF0ZS5nZXRTaXplID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgcmV0ID0gX3NpemVGbihzY29wZSk7CiAgICAgICAgICAgICAgaWYocmV0IGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiByZXQoKTsKICAgICAgICAgICAgICBlbHNlIGlmKHJldCBpbnN0YW5jZW9mIE9iamVjdCAmJiByZXQuZ2V0ICE9PSB1bmRlZmluZWQpIHJldHVybiByZXQuZ2V0KCk7CiAgICAgICAgICAgICAgZWxzZSByZXR1cm4gcmV0OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgX29yaWdpbkZuID0gYW5ndWxhci5ub29wOwogICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZSgnZmFPcmlnaW4nLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIF9vcmlnaW5GbiA9ICRwYXJzZShhdHRycy5mYU9yaWdpbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpc29sYXRlLmdldE9yaWdpbiA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIHJldCA9IF9vcmlnaW5GbihzY29wZSk7CiAgICAgICAgICAgICAgaWYocmV0IGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiByZXQoKTsKICAgICAgICAgICAgICBlbHNlIGlmKHJldCBpbnN0YW5jZW9mIE9iamVjdCAmJiByZXQuZ2V0ICE9PSB1bmRlZmluZWQpIHJldHVybiByZXQuZ2V0KCk7CiAgICAgICAgICAgICAgZWxzZSByZXR1cm4gcmV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpc29sYXRlLm1vZGlmaWVyID0gbmV3IE1vZGlmaWVyKHsKICAgICAgICAgICAgICB0cmFuc2Zvcm06IGlzb2xhdGUuZ2V0VHJhbnNmb3JtLAogICAgICAgICAgICAgIHNpemU6IGlzb2xhdGUuZ2V0U2l6ZSwKICAgICAgICAgICAgICBvcGFjaXR5OiBpc29sYXRlLmdldE9wYWNpdHksCiAgICAgICAgICAgICAgb3JpZ2luOiBpc29sYXRlLmdldE9yaWdpbiwKICAgICAgICAgICAgICBhbGlnbjogaXNvbGF0ZS5nZXRBbGlnbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IG5ldyBSZW5kZXJOb2RlKCkuYWRkKGlzb2xhdGUubW9kaWZpZXIpCgogICAgICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaXNvbGF0ZS5tb2RpZmllci5zZXRPcGFjaXR5KDApOwogICAgICAgICAgICAgIHNjb3BlLiRlbWl0KCd1bnJlZ2lzdGVyQ2hpbGQnLCB7aWQ6IHNjb3BlLiRpZH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHNjb3BlLiRvbigncmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPT0gZXZ0LmN1cnJlbnRTY29wZS4kaWQpewogICAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLmFkZChkYXRhLnJlbmRlck5vZGUpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCdkaXYnKS5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhUGlwZUZyb20KICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAcHJpb3JpdHkgMTYKICogQHBhcmFtIHtPYmplY3R9IEV2ZW50SGFuZGxlciAtIHRhcmdldCBoYW5kbGVyIG9iamVjdAogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgcmVtb3ZlIGFuIGhhbmRsZXIgb2JqZWN0IGZyb20gc2V0IG9mIGRvd25zdHJlYW0gaGFuZGxlcnMuIFVuZG9lcyB3b3JrIG9mICJwaXBlIgogKiBmcm9tIGEgZmFQaXBlVG8gZGlyZWN0aXZlLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8QU5ZIGZhLXBpcGUtZnJvbT0iRXZlbnRIYW5kbGVyIj4KICogICA8IS0tIHplcm8gb3IgbW9yZSByZW5kZXIgbm9kZXMgLS0+CiAqIDwvQU5ZPgogKiBgYGAKICovCgovL1VOVEVTVEVEIGFzIG9mIDIwMTQtMDUtMTMKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYVBpcGVGcm9tJywgWyckZmFtb3VzJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgc2NvcGU6IGZhbHNlLAogICAgICBwcmlvcml0eTogMTYsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBFbmdpbmUgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FbmdpbmUnXTsKICAgICAgICAKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmZhUGlwZUZyb20pOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24obmV3VGFyZ2V0LCBvbGRUYXJnZXQpewogICAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGlzb2xhdGUucmVuZGVyTm9kZSB8fCBFbmdpbmU7CiAgICAgICAgICAgICAgICBpZihvbGRUYXJnZXQgaW5zdGFuY2VvZiBBcnJheSl7CiAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvbGRUYXJnZXQubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgICAgICAgIG9sZFRhcmdldFtpXS51bnBpcGUoc291cmNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2UgaWYob2xkVGFyZ2V0ICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBvbGRUYXJnZXQudW5waXBlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYobmV3VGFyZ2V0IGluc3RhbmNlb2YgQXJyYXkpewogICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbmV3VGFyZ2V0Lmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBuZXdUYXJnZXRbaV0ucGlwZShzb3VyY2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihuZXdUYXJnZXQgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIG5ld1RhcmdldC5waXBlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVBpcGVUbwogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBBCiAqIEBwYXJhbSB7T2JqZWN0fSBFdmVudEhhbmRsZXIgLSBFdmVudCBoYW5kbGVyIHRhcmdldCBvYmplY3QKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGFkZCBhbiBldmVudCBoYW5kbGVyIG9iamVjdCB0byBzZXQgb2YgZG93bnN0cmVhbSBoYW5kbGVycy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS1waXBlLXRvPSJldmVudEhhbmRsZXIiPgogKiAgIDwhLS0gemVybyBvciBtb3JlIHJlbmRlciBub2RlcyAtLT4KICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFQaXBlVG8nLCBbJyRmYW1vdXMnLCAnJGZhbW91c0RlY29yYXRvcicsIGZ1bmN0aW9uICgkZmFtb3VzLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBzY29wZTogZmFsc2UsCiAgICAgIHByaW9yaXR5OiAxNiwKICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIEVuZ2luZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL0VuZ2luZSddOwogICAgICAgIAogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgc2NvcGUuJHdhdGNoKAogICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICByZXR1cm4gc2NvcGUuJGV2YWwoYXR0cnMuZmFQaXBlVG8pOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24obmV3UGlwZSwgb2xkUGlwZSl7CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gaXNvbGF0ZS5yZW5kZXJOb2RlIHx8IEVuZ2luZTsKICAgICAgICAgICAgICAgIGlmKG9sZFBpcGUgaW5zdGFuY2VvZiBBcnJheSl7CiAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBvbGRQaXBlLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQudW5waXBlKG9sZFBpcGVbaV0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9ZWxzZSBpZihvbGRQaXBlICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICB0YXJnZXQudW5waXBlKG9sZFBpcGUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKG5ld1BpcGUgaW5zdGFuY2VvZiBBcnJheSl7CiAgICAgICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBuZXdQaXBlLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGlwZShuZXdQaXBlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2UgaWYobmV3UGlwZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBpcGUobmV3UGlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVJlbmRlck5vZGUKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRUEKICogQGRlc2NyaXB0aW9uCiAqIEEgZGlyZWN0aXZlIHRvIGluc2VydCBhIHtAbGluayBodHRwczovL2ZhbW8udXMvZG9jcy8wLjEuMS9jb3JlL1JlbmRlck5vZGUvIEZhbW8udXMgUmVuZGVyTm9kZX0gdGhhdCBpcwogKiBhIHdyYXBwZXIgZm9yIGluc2VydGluZyBhIHJlbmRlcmFibGUgY29tcG9uZW50IChsaWtlIGEgTW9kaWZlciBvciBTdXJmYWNlKSBpbnRvIHRoZSByZW5kZXIgdHJlZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLXJlbmRlci1ub2RlPgogKiAgICAgPCEtLSBjb250ZW50IC0tPgogKiA8L2ZhLXJlbmRlci1ub2RlPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhUmVuZGVyTm9kZScsIFsiJGZhbW91cyIsICIkZmFtb3VzRGVjb3JhdG9yIiwgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHRlbXBsYXRlOiAnPGRpdj48L2Rpdj4nLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBFbmdpbmUgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FbmdpbmUnXTsKCiAgICAgICAgICAgIHZhciBnZXRPclZhbHVlID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgIHJldHVybiB4LmdldCA/IHguZ2V0KCkgOiB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaXNvbGF0ZS5jaGlsZHJlbiA9IFtdOwoKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhUGlwZVRvJywgZnVuY3Rpb24odmFsKXsKICAgICAgICAgICAgICB2YXIgcGlwZVRvID0gc2NvcGUuJGV2YWwodmFsKTsKICAgICAgICAgICAgICBpZihwaXBlVG8pCiAgICAgICAgICAgICAgICBFbmdpbmUucGlwZShwaXBlVG8pOwogICAgICAgICAgICB9KQoKICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlID0gc2NvcGUuJGV2YWwoYXR0cnMuZmFOb2RlKTsKCiAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY29wZS4kZW1pdCgndW5yZWdpc3RlckNoaWxkJywge2lkOiBzY29wZS4kaWR9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kb24oJ3JlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT0gc2NvcGUuJGlkKXsKICAgICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5hZGQoZGF0YS5yZW5kZXJOb2RlKTsKICAgICAgICAgICAgICAgIGlzb2xhdGUuY2hpbGRyZW4ucHVzaChkYXRhKTsKICAgICAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCdkaXYnKS5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhU2Nyb2xsVmlldwogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBFCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgYSB7QGxpbmsgaHR0cHM6Ly9mYW1vLnVzL2RvY3MvMC4xLjEvdmlld3MvU2Nyb2xsdmlldy8gZmFtby51cyBTY3JvbGx2aWV3fQogKiB0aGF0IHdpbGwgbGF5IG91dCBhIGNvbGxlY3Rpb24gb2YgcmVuZGVyYWJsZXMgc2VxdWVudGlhbGx5IGluIHRoZSBzcGVjaWZpZWQgZGlyZWN0aW9uCiAqIGFuZCB3aWxsIGFsbG93IHlvdSB0byBzY3JvbGwgdGhyb3VnaCB0aGVtIHdpdGggbW91c2V3aGVlbCBvciB0b3VjaCBldmVudHMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1zY3JvbGwtdmlldz4KICogICA8ZmEtdmlldz4KICogICAgIDwhLS0gY29udGVudCAtLT4KICogICA8L2ZhLXZpZXc+CiAqIDwvZmEtc2Nyb2xsLXZpZXc+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFTY3JvbGxWaWV3JywgWyckZmFtb3VzJywgJyRmYW1vdXNEZWNvcmF0b3InLCAnJHRpbWVvdXQnLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvciwgJHRpbWVvdXQpIHsKICAgIHJldHVybiB7CiAgICAgIHRlbXBsYXRlOiAnPGRpdj48L2Rpdj4nLAogICAgICByZXN0cmljdDogJ0UnLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW0sIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgcmV0dXJuICB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciBTY3JvbGxWaWV3ID0gJGZhbW91c1siZmFtb3VzL3ZpZXdzL1Njcm9sbHZpZXciXTsKICAgICAgICAgICAgdmFyIFZpZXdTZXF1ZW5jZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1ZpZXdTZXF1ZW5jZSddOwogICAgICAgICAgICB2YXIgU3VyZmFjZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1N1cmZhY2UnXTsKCiAgICAgICAgICAgIHZhciBfY2hpbGRyZW4gPSBbXTsKCiAgICAgICAgICAgIHZhciBvcHRpb25zID0gc2NvcGUuJGV2YWwoYXR0cnMuZmFPcHRpb25zKSB8fCB7fTsKICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlID0gbmV3IFNjcm9sbFZpZXcob3B0aW9ucyk7CgogICAgICAgICAgICB2YXIgdXBkYXRlU2Nyb2xsdmlldyA9IGZ1bmN0aW9uKGluaXQpewogICAgICAgICAgICAgIC8vJHRpbWVvdXQgaGFjayB1c2VkIGhlcmUgYmVjYXVzZSB0aGUKICAgICAgICAgICAgICAvL3VwZGF0ZVNjcm9sbHZpZXcgZnVuY3Rpb24gd2lsbCBnZXQgY2FsbGVkCiAgICAgICAgICAgICAgLy9iZWZvcmUgdGhlICRpbmRleCB2YWx1ZXMgZ2V0IHJlLWJvdW5kCiAgICAgICAgICAgICAgLy90aHJvdWdoIG5nLXJlcGVhdC4gIFRoZSByZXN1bHQgaXMgdGhhdAogICAgICAgICAgICAgIC8vdGhlIGl0ZW1zIGdldCBzb3J0ZWQgaGVyZSwgdGhlbiB0aGUgaW5kZXhlcwogICAgICAgICAgICAgIC8vZ2V0IHJlLWJvdW5kLCBhbmQgdGh1cyB0aGUgcmVzdWx0cyBhcmUgaW5jb3JyZWN0bHkKICAgICAgICAgICAgICAvL29yZGVyZWQuCiAgICAgICAgICAgICAgJHRpbWVvdXQoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIF9jaGlsZHJlbi5zb3J0KGZ1bmN0aW9uKGEsIGIpewogICAgICAgICAgICAgICAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgICAgICAgICAgICAgICB9KTsgCgogICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICAgIGFycmF5OiBmdW5jdGlvbihfY2hpbGRyZW4pIHsKCSAgICAgICAgICAgICAgICAgIHZhciBfY2ggPSBbXTsKCSAgICAgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfY2hpbGRyZW4sIGZ1bmN0aW9uKGMsIGkpIHsKCQkgICAgICAgICAgICAgICAgICBfY2hbaV0gPSBjLnJlbmRlck5vZGU7CgkgICAgICAgICAgICAgICAgICB9KQoJICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jaDsKICAgICAgICAgICAgICAgICAgfShfY2hpbGRyZW4pCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgLy9zZXQgdGhlIGZpcnN0IHBhZ2Ugb24gdGhlIHNjcm9sbHZpZXcgaWYKICAgICAgICAgICAgICAgIC8vc3BlY2lmaWVkCiAgICAgICAgICAgICAgICBpZihpbml0KQogICAgICAgICAgICAgICAgICBvcHRpb25zLmluZGV4ID0gc2NvcGUuJGV2YWwoYXR0cnMuZmFTdGFydEluZGV4KTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIHZpZXdTZXEgPSBuZXcgVmlld1NlcXVlbmNlKG9wdGlvbnMpOwogICAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLnNlcXVlbmNlRnJvbSh2aWV3U2VxKTsKCiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2NvcGUuJG9uKCdyZWdpc3RlckNoaWxkJywgZnVuY3Rpb24oZXZ0LCBkYXRhKXsKICAgICAgICAgICAgICBpZihldnQudGFyZ2V0U2NvcGUuJGlkICE9IHNjb3BlLiRpZCl7CiAgICAgICAgICAgICAgICBfY2hpbGRyZW4ucHVzaChkYXRhKTsKICAgICAgICAgICAgICAgIHVwZGF0ZVNjcm9sbHZpZXcodHJ1ZSk7CiAgICAgICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kb24oJ3VucmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPSBzY29wZS4kaWQpewoKCSAgICAgICAgICAgIF9jaGlsZHJlbiA9IGZ1bmN0aW9uKF9jaGlsZHJlbikgewoJCSAgICAgICAgICB2YXIgX2NoID0gW107CgkJICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfY2hpbGRyZW4sIGZ1bmN0aW9uKGMpIHsKCQkJICAgICAgICBpZihjLmlkICE9PSBkYXRhLmlkKSB7CgkJCQkgICAgICBfY2gucHVzaChjKTsKCQkJICAgICAgICB9CgkJICAgICAgICAgIH0pOwoJCSAgICAgICAgICByZXR1cm4gX2NoOwoJICAgICAgICAgICAgfShfY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgdXBkYXRlU2Nyb2xsdmlldygpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgdHJhbnNjbHVkZShzY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJ2RpdicpLmFwcGVuZChjbG9uZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJ3JlZ2lzdGVyQ2hpbGQnLCBpc29sYXRlKTsKCiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVN1cmZhY2UKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRUEKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGlzIHVzZWQgdG8gY3JlYXRlIGdlbmVyYWwgRmFtby51cyBzdXJmYWNlcywgd2hpY2ggYXJlIHRoZQogKiBsZWFmIG5vZGVzIG9mIHRoZSBzY2VuZSBncmFwaC4gIFRoZSBjb250ZW50IGluc2lkZQogKiBzdXJmYWNlcyBpcyB3aGF0IGdldHMgcmVuZGVyZWQgdG8gdGhlIHNjcmVlbi4KICogVGhpcyBpcyB3aGVyZSB5b3UgY2FuIGNyZWF0ZSBmb3JtIGVsZW1lbnRzLCBhdHRhY2gKICogaW1hZ2VzLCBvciBvdXRwdXQgcmF3IHRleHQgY29udGVudCB3aXRoIG9uZS13YXkgZGF0YWJpbmRpbmcge3t9fS4KICogWW91IGNhbiBpbmNsdWRlIGVudGlyZSBjb21wbGV4IEhUTUwgc25pcHBldHMgaW5zaWRlIGEgZmFTdXJmYWNlLCBpbmNsdWRpbmcKICogbmdJbmNsdWRlcyBvciBjdXN0b20gKHZhbmlsbGEgQW5ndWxhcikgZGlyZWN0aXZlcy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLXN1cmZhY2U+CiAqICAgSGVyZSdzIHNvbWUgZGF0YS1ib3VuZCBjb250ZW50IHt7bXlTY29wZVZhcmlhYmxlfX0KICogPC9mYS1zdXJmYWNlPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhU3VyZmFjZScsIFsnJGZhbW91cycsICckZmFtb3VzRGVjb3JhdG9yJywgJyRpbnRlcnBvbGF0ZScsICckY29udHJvbGxlcicsICckY29tcGlsZScsIGZ1bmN0aW9uICgkZmFtb3VzLCAkZmFtb3VzRGVjb3JhdG9yLCAkaW50ZXJwb2xhdGUsICRjb250cm9sbGVyLCAkY29tcGlsZSkgewogICAgcmV0dXJuIHsKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0iZmEtc3VyZmFjZSI+PC9kaXY+JywKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtLCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciBTdXJmYWNlID0gJGZhbW91c1snZmFtb3VzL2NvcmUvU3VyZmFjZSddOwogICAgICAgICAgICB2YXIgVHJhbnNmb3JtID0gJGZhbW91c1snZmFtb3VzL2NvcmUvVHJhbnNmb3JtJ10KICAgICAgICAgICAgdmFyIEV2ZW50SGFuZGxlciA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL0V2ZW50SGFuZGxlciddOwogICAgICAgICAgICAKICAgICAgICAgICAgLy91cGRhdGUgcHJvcGVydGllcwogICAgICAgICAgICAvL1RPRE86ICBpcyB0aGlzIGdvaW5nIHRvIGJlIGEgYm90dGxlbmVjaz8KICAgICAgICAgICAgc2NvcGUuJHdhdGNoKAogICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNvbGF0ZS5nZXRQcm9wZXJ0aWVzKCkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBpZihpc29sYXRlLnJlbmRlck5vZGUpCiAgICAgICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXRQcm9wZXJ0aWVzKGlzb2xhdGUuZ2V0UHJvcGVydGllcygpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHRydWUKICAgICAgICAgICAgKQoKICAgICAgICAgICAgaXNvbGF0ZS5nZXRQcm9wZXJ0aWVzID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBzY29wZS4kZXZhbChhdHRycy5mYUJhY2tncm91bmRDb2xvciksCiAgICAgICAgICAgICAgICBjb2xvcjogc2NvcGUuJGV2YWwoYXR0cnMuZmFDb2xvcikKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlID0gbmV3IFN1cmZhY2UoewogICAgICAgICAgICAgIHNpemU6IHNjb3BlLiRldmFsKGF0dHJzLmZhU2l6ZSksCiAgICAgICAgICAgICAgY2xhc3M6IHNjb3BlLiRldmFsKGF0dHJzLmNsYXNzKSwKICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBpc29sYXRlLmdldFByb3BlcnRpZXMoKQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vVE9ETzogIHN1cHBvcnQgbmctY2xhc3MKICAgICAgICAgICAgaWYoYXR0cnMuY2xhc3MpCiAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLnNldENsYXNzZXMoYXR0cnNbJ2NsYXNzJ10uc3BsaXQoJyAnKSk7CgogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciB1cGRhdGVDb250ZW50ID0gZnVuY3Rpb24oKXsKLy8gICAgICAgICAgICAgIHZhciBjb21waWxlZEVsID0gaXNvbGF0ZS5jb21waWxlZEVsID0gaXNvbGF0ZS5jb21waWxlZEVsIHx8ICRjb21waWxlKGVsZW1lbnQuZmluZCgnZGl2LmZhLXN1cmZhY2UnKS5jb250ZW50cygpKShzY29wZSkKLy8gICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXRDb250ZW50KGlzb2xhdGUuY29tcGlsZWRFbC5jb250ZXh0KTsKCSAgICAgICAgICAgIC8vVE9ETyBjaGVjayBpZiAkY29tcGlsZSBpcyBuZWVkZWQgPwoJICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLnNldENvbnRlbnQoZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yKCdkaXYuZmEtc3VyZmFjZScpKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHVwZGF0ZUNvbnRlbnQoKTsKCiAgICAgICAgICAgIC8vYm9pbGVycGxhdGUKICAgICAgICAgICAgdHJhbnNjbHVkZShzY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCdkaXYuZmEtc3VyZmFjZScpKS5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhVGFwCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEEKICogQHBhcmFtIHtleHByZXNzaW9ufSBmYVRhcCBFeHByZXNzaW9uIHRvIGV2YWx1YXRlIHVwb24gdGFwLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbiBhbiBlbGVtZW50IGlzIHRhcHBlZC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS10YXA9ImV4cHJlc3Npb24iPgogKgogKiA8L0FOWT4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYVRhcCcsIFsnJHBhcnNlJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJHBhcnNlLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICBpZiAoYXR0cnMuZmFUYXApIHsKICAgICAgICAgICAgICB2YXIgcmVuZGVyTm9kZSA9IChpc29sYXRlLnJlbmRlck5vZGUuX2V2ZW50SW5wdXQgfHwgaXNvbGF0ZS5yZW5kZXJOb2RlKQoKICAgICAgICAgICAgICB2YXIgX2RyYWdnaW5nID0gZmFsc2U7CgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oInRvdWNobW92ZSIsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgIF9kcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgcmVuZGVyTm9kZS5vbigidG91Y2hlbmQiLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICBpZiAoIV9kcmFnZ2luZyl7CiAgICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRycy5mYVRhcCk7CiAgICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmRhdGF9KTsKICAgICAgICAgICAgICAgICAgaWYoIXNjb3BlLiQkcGhhc2UpCiAgICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfZHJhZ2dpbmcgPSBmYWxzZQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhVG91Y2hlbmQKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGZhVG91Y2hlbmQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB1cG9uIHRvdWNoZW5kLiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3IgYWZ0ZXIgYW4gZWxlbWVudCB0aGF0IHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9SZWZlcmVuY2UvRXZlbnRzL3RvdWNoZW5kIGhhcyBiZWVuIHRvdWNoZWR9LgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8QU5ZIGZhLXRvdWNoZW5kPSJleHByZXNzaW9uIj4KICoKICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFUb3VjaGVuZCcsIFsnJHBhcnNlJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJHBhcnNlLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBzY29wZTogZmFsc2UsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIGlmIChhdHRycy5mYVRvdWNoRW5kKSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlck5vZGUgPSAoaXNvbGF0ZS5yZW5kZXJOb2RlLl9ldmVudElucHV0IHx8IGlzb2xhdGUucmVuZGVyTm9kZSkKCiAgICAgICAgICAgICAgcmVuZGVyTm9kZS5vbigidG91Y2hlbmQiLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cnMuZmFUb3VjaE1vdmUpOwogICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZGF0YX0pOwogICAgICAgICAgICAgICAgaWYoIXNjb3BlLiQkcGhhc2UpCiAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVRvdWNobW92ZQogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBBCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZmFUb3VjaG1vdmUgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB1cG9uIHRvdWNobW92ZS4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIHdoZW4gYW4gZWxlbWVudCBpcyB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvUmVmZXJlbmNlL0V2ZW50cy90b3VjaG1vdmUgbW92ZWQgYWxvbmcgYSB0b3VjaCBzdXJmYWNlfS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS10b3VjaG1vdmU9ImV4cHJlc3Npb24iPgogKgogKiA8L0FOWT4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYVRvdWNobW92ZScsIFsnJHBhcnNlJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJHBhcnNlLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBzY29wZTogZmFsc2UsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIGlmIChhdHRycy5mYVRvdWNoTW92ZSkgewogICAgICAgICAgICAgIHZhciByZW5kZXJOb2RlID0gKGlzb2xhdGUucmVuZGVyTm9kZS5fZXZlbnRJbnB1dCB8fCBpc29sYXRlLnJlbmRlck5vZGUpCgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oInRvdWNobW92ZSIsIGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgIHZhciBmbiA9ICRwYXJzZShhdHRycy5mYVRvdWNoTW92ZSk7CiAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDpkYXRhfSk7CiAgICAgICAgICAgICAgICBpZighc2NvcGUuJCRwaGFzZSkKICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFUb3VjaHN0YXJ0CiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEEKICogQHBhcmFtIHtleHByZXNzaW9ufSBmYVRvdWNoc3RhcnQgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB1cG9uIHRvdWNoc3RhcnQuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuIGFuIGVsZW1lbnQgaXMge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL1JlZmVyZW5jZS9FdmVudHMvdG91Y2hzdGFydCB0b3VjaGVkIHVwb24gYSB0b3VjaCBzdXJmYWNlfS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS10b3VjaHN0YXJ0PSJleHByZXNzaW9uIj4KICoKICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFUb3VjaHN0YXJ0JywgWyckcGFyc2UnLCAnJGZhbW91c0RlY29yYXRvcicsIGZ1bmN0aW9uICgkcGFyc2UsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHNjb3BlOiBmYWxzZSwKICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgaWYgKGF0dHJzLmZhVG91Y2hTdGFydCkgewogICAgICAgICAgICAgIHZhciByZW5kZXJOb2RlID0gKGlzb2xhdGUucmVuZGVyTm9kZS5fZXZlbnRJbnB1dCB8fCBpc29sYXRlLnJlbmRlck5vZGUpCgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oInRvdWNoc3RhcnQiLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cnMuZmFUb3VjaFN0YXJ0KTsKICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmRhdGF9KTsKICAgICAgICAgICAgICAgIGlmKCFzY29wZS4kJHBoYXNlKQogICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVZpZXcKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRUEKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGlzIHVzZWQgdG8gd3JhcCBjaGlsZCBlbGVtZW50cyBpbnRvIGEgVmlldyByZW5kZXIgbm9kZS4gIFRoaXMgaXMgZXNwZWNpYWxseSB1c2VmdWwgZm9yIGdyb3VwaW5nLgogKiBVc2UgYW4gYDxmYS12aWV3PmAgc3Vycm91bmRlZCBieSBhIGA8ZmEtbW9kaWZpZXI+YCBpbiBvcmRlciB0byBhZmZlY3QgdGhlIFZpZXcncyBwb3NpdGlvbiwgc2NhbGUsIGV0Yy4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLXZpZXc+CiAqICAgPCEtLSBjb250ZW50IC0tPgogKiA8L2ZhLXZpZXc+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFWaWV3JywgWyIkZmFtb3VzIiwgIiRmYW1vdXNEZWNvcmF0b3IiLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsCiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgIHNjb3BlOiB0cnVlLAogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW1lbnQsIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgdmFyIFZpZXcgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9WaWV3J107CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHByZTogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgaXNvbGF0ZS5jaGlsZHJlbiA9IFtdOwoKICAgICAgICAgICAgdmFyIGdldE9yVmFsdWUgPSBmdW5jdGlvbih4KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHguZ2V0ID8geC5nZXQoKSA6IHg7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUgPSBuZXcgVmlldyh7CiAgICAgICAgICAgICAgc2l6ZTogc2NvcGUuJGV2YWwoYXR0cnMuZmFTaXplKSB8fCBbdW5kZWZpbmVkLCB1bmRlZmluZWRdCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjb3BlLiRlbWl0KCd1bnJlZ2lzdGVyQ2hpbGQnLCB7aWQ6IHNjb3BlLiRpZH0pOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRvbigncmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPSBzY29wZS4kaWQpewogICAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLmFkZChkYXRhLnJlbmRlck5vZGUpOwogICAgICAgICAgICAgICAgaXNvbGF0ZS5jaGlsZHJlbi5wdXNoKGRhdGEpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgdHJhbnNjbHVkZShzY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJ2RpdicpLmFwcGVuZChjbG9uZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJ3JlZ2lzdGVyQ2hpbGQnLCBpc29sYXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKICBtb2R1bGUuZXhwb3J0cyA9IG5nRmFtZUFwcDsKfSk7Cg==",
                "body": "LyoqCiAqIGZhbW91cy1hbmd1bGFyIC0gSW50ZWdyYXRlIEZhbW8udXMgaW50byBBbmd1bGFySlMgYXBwcyBhbmQgYnVpbGQgRmFtby51cyBhcHBzIHVzaW5nIEFuZ3VsYXJKUyB0b29scwogKiBAdmVyc2lvbiB2MC4wLjEyCiAqIEBsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9GYW1vdXMvZmFtb3VzLWFuZ3VsYXIKICogQGxpY2Vuc2UgCiAqLwondXNlIHN0cmljdCc7CgovLyBQdXQgYW5ndWxhciBib290c3RyYXAgb24gaG9sZAp3aW5kb3cubmFtZSA9ICJOR19ERUZFUl9CT09UU1RSQVAhIiArIHdpbmRvdy5uYW1lOwoKZGVmaW5lKGZ1bmN0aW9uKHJlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZSkgewoKLy9UT0RPOiAgRW5zdXJlIHRoYXQgdGhpcyBsaXN0IHN0YXlzIHVwLXRvLWRhdGUgd2l0aAovLyAgICAgICB0aGUgZmlsZXN5c3RlbSAobWF5YmUgd3JpdGUgYSBiYXNoIHNjcmlwdAovLyAgICAgICB3b3JraW5nIGFyb3VuZCBgbHMgLVIxIGFwcC9zY3JpcHRzL2ZhbW91c2AgPykKdmFyIHJlcXVpcmVtZW50cyA9IFsKCSJmYW1vdXMvY29yZS9FbmdpbmUiLAoJImZhbW91cy9jb3JlL0V2ZW50RW1pdHRlciIsCgkiZmFtb3VzL2NvcmUvRXZlbnRIYW5kbGVyIiwKCSJmYW1vdXMvY29yZS9Nb2RpZmllciIsCgkiZmFtb3VzL2NvcmUvUmVuZGVyTm9kZSIsCgkiZmFtb3VzL2NvcmUvU3VyZmFjZSIsCgkiZmFtb3VzL2NvcmUvVHJhbnNmb3JtIiwKCSJmYW1vdXMvY29yZS9WaWV3IiwKCSJmYW1vdXMvY29yZS9WaWV3U2VxdWVuY2UiLAoJImZhbW91cy9ldmVudHMvRXZlbnRBcmJpdGVyIiwKCSJmYW1vdXMvZXZlbnRzL0V2ZW50RmlsdGVyIiwKCSJmYW1vdXMvZXZlbnRzL0V2ZW50TWFwcGVyIiwKCSJmYW1vdXMvaW5wdXRzL0Zhc3RDbGljayIsCgkiZmFtb3VzL2lucHV0cy9HZW5lcmljU3luYyIsCgkiZmFtb3VzL2lucHV0cy9Nb3VzZVN5bmMiLAoJImZhbW91cy9pbnB1dHMvUGluY2hTeW5jIiwKCSJmYW1vdXMvaW5wdXRzL1JvdGF0ZVN5bmMiLAoJImZhbW91cy9pbnB1dHMvVG91Y2hTeW5jIiwKCSJmYW1vdXMvc3VyZmFjZXMvSW1hZ2VTdXJmYWNlIiwKCSJmYW1vdXMvc3VyZmFjZXMvSW5wdXRTdXJmYWNlIiwKCSJmYW1vdXMvdHJhbnNpdGlvbnMvRWFzaW5nIiwKCSJmYW1vdXMvdHJhbnNpdGlvbnMvU3ByaW5nVHJhbnNpdGlvbiIsCgkiZmFtb3VzL3RyYW5zaXRpb25zL1RyYW5zaXRpb25hYmxlIiwKCSJmYW1vdXMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGVUcmFuc2Zvcm0iLAoJImZhbW91cy91dGlsaXRpZXMvS2V5Q29kZXMiLAoJImZhbW91cy91dGlsaXRpZXMvVGltZXIiLAoJImZhbW91cy92aWV3cy9HcmlkTGF5b3V0IiwKCSJmYW1vdXMvdmlld3MvUmVuZGVyQ29udHJvbGxlciIsCgkiZmFtb3VzL3ZpZXdzL1Njcm9sbGVyIiwKCSJmYW1vdXMvdmlld3MvU2Nyb2xsdmlldyIKXQoKdmFyIHJlcXVpcmVkID0gW107CmZvciAodmFyIGkgaW4gcmVxdWlyZW1lbnRzKSB7CiAgcmVxdWlyZWRbaV0gPSByZXF1aXJlKHJlcXVpcmVtZW50c1tpXSk7Cn07CgovL2RlY2xhcmUgdGhlIG1vZHVsZSBiZWZvcmUgdGhlIGFzeW5jIGNhbGxiYWNrIHNvIHRoYXQKLy9pdCB3aWxsIGJlIGFjY2Vzc2libGUgdG8gb3RoZXIgc3luY2hyb25vdXNseSBsb2FkZWQgYW5ndWxhcgovL2NvbXBvbmVudHMKdmFyIG5nRmFtZUFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicsIFtdKTsKCihmdW5jdGlvbigpIHsKICAvKioKICAgKiBAbmdkb2MgcHJvdmlkZXIKICAgKiBAbmFtZSAkZmFtb3VzUHJvdmlkZXIKICAgKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAgICogQGRlc2NyaXB0aW9uCiAgICogVGhpcyBwcm92aWRlciBpcyBsb2FkZWQgYXMgYW4gQU1EIG1vZHVsZSBhbmQgd2lsbCBrZWVwIGEgcmVmZXJlbmNlIG9uIHRoZSBjb21wbGV0ZSBGYW1vLnVzIGxpYnJhcnkuCiAgICogV2UgdXNlIHRoaXMgcHJvdmlkZXIgdG8gYXZvaWQgbmVlZGluZyB0byBkZWFsIHdpdGggQU1EIG9uIGFueSBvdGhlciBhbmd1bGFyIGZpbGVzLgogICAqCiAgICogQHVzYWdlCiAgICogWW91IHByb2JhYmx5IHdvbid0IGhhdmUgdG8gY29uZmlndXJlIHRoaXMgcHJvdmlkZXIKICAgKgogICAqIGBgYGpzCiAgICogYW5ndWxhci5tb2R1bGUoJ215U3VwZXJBcHAnLCBbJ2ZhbW91cy5hbmd1bGFyJ10pLmNvbmZpZygKICAgKiAgIGZ1bmN0aW9uKCRmYW1vdXNQcm92aWRlcikgewogICAqCiAgICogICAgICAgLy8gUmVnaXN0ZXIgeW91ciBtb2R1bGVzCiAgICogICAgICAgJGZhbW91c1Byb3ZpZGVyLnJlZ2lzdGVyTW9kdWxlKCdtb2R1bGVLZXknLCBtb2R1bGUpOwogICAqCiAgICogICB9OwogICAqIH0pOwogICAqIGBgYAogICAqCiAgICovCiAgbmdGYW1lQXBwLnByb3ZpZGVyKCckZmFtb3VzJywgZnVuY3Rpb24oKSB7CiAgICAvLyBoYXNoIGZvciBzdG9yaW5nIG1vZHVsZXMKICAgIHZhciBfbW9kdWxlcyA9IHt9OwoKICAgIC8qKgogICAgICogQG5nZG9jIG1ldGhvZAogICAgICogQG5hbWUgJGZhbW91c1Byb3ZpZGVyI3JlZ2lzdGVyTW9kdWxlCiAgICAgKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAgICAgKiBAZGVzY3JpcHRpb24KICAgICAqIFJlZ2lzdGVyIHRoZSBtb2R1bGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgaW4gdGhlICRmYW1vdXMgc2VydmljZQogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgdGhlIGtleSB0aGF0IHdpbGwgYmUgdXNlZCB0byByZWdpc3RlciB0aGUgbW9kdWxlCiAgICAgKiBAcGFyYW0ge01pc2N9IG1vZHVsZSB0aGUgZGF0YSB0aGF0IHdpbGwgYmUgcmV0dXJuZWQgYnkgdGhlIHNlcnZpY2UKICAgICAqLwogICAgdGhpcy5yZWdpc3Rlck1vZHVsZSA9IGZ1bmN0aW9uKGtleSwgbW9kdWxlKSB7CiAgICAgIC8vVE9ETyB3YXJuaW5nIGlmIHRoZSBrZXkgaXMgYWxyZWFkeSByZWdpc3RlcmVkID8KICAgICAgX21vZHVsZXNba2V5XSA9IG1vZHVsZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBAbmdkb2MgbWV0aG9kCiAgICAgKiBAbmFtZSAkZmFtb3VzUHJvdmlkZXIjZmluZAogICAgICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogICAgICogQGRlc2NyaXB0aW9uIGdpdmVuIGEgc2VsZWN0b3IsIHJldHJpZXZlcwogICAgICogdGhlIGlzb2xhdGUgb24gYSB0ZW1wbGF0ZS1kZWNsYXJlZCBzY2VuZSBncmFwaCBlbGVtZW50LiAgVGhpcyBpcyB1c2VmdWwKICAgICAqIGZvciBtYW5pcHVsYXRpbmcgRmFtby51cyBvYmplY3RzIGRpcmVjdGx5IGFmdGVyIHRoZXkndmUgYmVlbiBkZWNsYXJlZCBpbiB0aGUgRE9NLgogICAgICogQXMgaW4gbm9ybWFsIEFuZ3VsYXIsIHRoaXMgRE9NIGxvb2stdXAgc2hvdWxkIGJlIHBlcmZvcm1lZCBpbiB0aGUgcG9zdExpbmsgZnVuY3Rpb24KICAgICAqIG9mIGEgZGlyZWN0aXZlLgogICAgICogQHJldHVybnMge0FycmF5fSBhbiBhcnJheSBvZiB0aGUgaXNvbGF0ZSBvYmplY3RzIG9mIHRoZSBzZWxlY3RlZCBlbGVtZW50cy4KICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gc2VsZWN0b3IgLSB0aGUgc2VsZWN0b3IgZm9yIHRoZSBlbGVtZW50cyB0byBsb29rIHVwCiAgICAgKiBAdXNhZ2UKICAgICAqIFZpZXc6CiAgICAgKiBgYGBodG1sCiAgICAgKiA8ZmEtc2Nyb2xsLXZpZXcgaWQ9Im15U2Nyb2xsVmlldyI+PC9mYS1zY3JvbGwtdmlldz4KICAgICAqIGBgYAogICAgICogQ29udHJvbGxlcjoKICAgICAqIGBgYGphdmFzY3JpcHQKICAgICAqIHZhciBzY3JvbGxWaWV3UmVmZXJlbmNlID0gJGZhbW91cy5maW5kKCcjbXlTY3JvbGxWaWV3JylbMF0ucmVuZGVyTm9kZTsKICAgICAqIC8vTm93IHNjcm9sbFZpZXdSZWZlcmVuY2UgaXMgcG9pbnRpbmcgdG8gdGhlIEZhbW8udXMgU2Nyb2xsdmlldyBvYmplY3QKICAgICAqIC8vdGhhdCB3ZSBjcmVhdGVkIGluIHRoZSB2aWV3LgogICAgICogYGBgCiAgICAgKi8KCiAgICBfbW9kdWxlcy5maW5kID0gZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgZWxlbXMgPSBhbmd1bGFyLmVsZW1lbnQod2luZG93LmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpKTsKICAgICAgdmFyIHNjb3BlcyA9IGZ1bmN0aW9uKGVsZW1zKSB7CiAgICAgICAgdmFyIF9zID0gW107CiAgICAgICAgYW5ndWxhci5mb3JFYWNoKGVsZW1zLCBmdW5jdGlvbihlbGVtLCBpKSB7CiAgICAgICAgICBfc1tpXSA9IGFuZ3VsYXIuZWxlbWVudChlbGVtKS5zY29wZSgpOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBfczsKICAgICAgfShlbGVtcyk7CiAgICAgIHZhciBpc29sYXRlcyA9IGZ1bmN0aW9uKHNjb3BlcykgewogICAgICAgIHZhciBfcyA9IFtdOwogICAgICAgIGFuZ3VsYXIuZm9yRWFjaChzY29wZXMsIGZ1bmN0aW9uKHNjb3BlLCBpKSB7CiAgICAgICAgICBfc1tpXSA9IHNjb3BlLmlzb2xhdGVbc2NvcGUuJGlkXTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gX3M7CiAgICAgIH0oc2NvcGVzKTsKICAgICAgcmV0dXJuIGlzb2xhdGVzOwogICAgfQoKICAgIHRoaXMuJGdldCA9IGZ1bmN0aW9uKCkgewoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBzZXJ2aWNlCiAgICAgICAqIEBuYW1lICRmYW1vdXMKICAgICAgICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogICAgICAgKiBAZGVzY3JpcHRpb24KICAgICAgICogVGhpcyBzZXJ2aWNlIGdpdmVzIHlvdSBhY2Nlc3MgdG8gdGhlIGNvbXBsZXRlIEZhbW8udXMgbGlicmFyeS4KICAgICAgICoKICAgICAgICogQHVzYWdlCiAgICAgICAqIFVzZSB0aGlzIHNlcnZpY2UgdG8gYWNjZXNzIHRoZSByZWdpc3RlcmVkIEZhbW8udXMgbW9kdWxlcyBhcyBhbiBvYmplY3QuCiAgICAgICAqCiAgICAgICAqIGBgYGpzCiAgICAgICAqIGFuZ3VsYXIubW9kdWxlKCdteVN1cGVyQXBwJywgWydmYW1vdXMuYW5ndWxhciddKS5jb250cm9sbGVyKAogICAgICAgKiAgIGZ1bmN0aW9uKCRzY29wZSwgJGZhbW91cykgewogICAgICAgKgogICAgICAgKiAgICAgICAvLyBBY2Nlc3MgYW55IHJlZ2lzdGVyZWQgbW9kdWxlCiAgICAgICAqICAgICAgIHZhciBFdmVudEhhbmRsZXIgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FdmVudEhhbmRsZXInXTsKICAgICAgICogICAgICAgJHNjb3BlLmV2ZW50SGFuZGxlciA9IG5ldyBFdmVudEhhbmRsZXIoKTsKICAgICAgICoKICAgICAgICogICB9OwogICAgICAgKiB9KTsKICAgICAgICogYGBgCiAgICAgICAqCiAgICAgICAqLwogICAgICByZXR1cm4gX21vZHVsZXM7CiAgICB9OwogIH0pOwoKICBuZ0ZhbWVBcHAuY29uZmlnKFsnJGZhbW91c1Byb3ZpZGVyJywgZnVuY3Rpb24oJGZhbW91c1Byb3ZpZGVyKSB7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgcmVxdWlyZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICRmYW1vdXNQcm92aWRlci5yZWdpc3Rlck1vZHVsZShyZXF1aXJlbWVudHNbaV0sIHJlcXVpcmVkW2ldKTsKICAgIH0KICAgIC8vCQljb25zb2xlLmxvZygncmVnaXN0ZXJlZCBtb2R1bGVzJywgZmFtb3VzUHJvdmlkZXIuJGdldCgpKTsKICB9XSk7CgogIGFuZ3VsYXIuZWxlbWVudChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgICBpZihhbmd1bGFyLnJlc3VtZUJvb3RzdHJhcCkgYW5ndWxhci5yZXN1bWVCb290c3RyYXAoKTsKICB9KTsKfSkoKTsKCi8qKgogKiBAbmdkb2Mgc2VydmljZQogKiBAbmFtZSAkZmFtb3VzRGVjb3JhdG9yCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQGRlc2NyaXB0aW9uCiAqIE1hbmFnZXMgdGhlIGNyZWF0aW9uIGFuZCBoYW5kbGluZyBvZiBpc29sYXRlIHNjb3Blcy4KICoKICogSXNvbGF0ZSBzY29wZXMgYXJlIGxpa2UgYSBuYW1lc3BhY2luZyBpbnNpZGUgcGxhaW4gQW5ndWxhciBjaGlsZCBzY29wZXMsIAogKiB3aXRoIHRoZSBwdXJwb3NlIG9mIHN0b3JpbmcgcHJvcGVydGllcyBhdmFpbGFibGUgb25seSB0byBvbmUgcGFydGljdWxhciAKICogc2NvcGUuICAKICogVGhlIHNjb3BlcyBhcmUgc3RpbGwgYWJsZSB0byBjb21tdW5pY2F0ZSB3aXRoIHRoZSBwYXJlbnQgdmlhIGV2ZW50cyAKICogKCRlbWl0LCAkYnJvYWRjYXN0KSwgeWV0IHN0aWxsIGhhdmUgdGhlaXIgb3duICRzY29wZSBwcm9wZXJ0aWVzIHRoYXQgd2lsbCAKICogbm90IGNvbmZsaWN0IHdpdGggdGhlIHBhcmVudCBvciBvdGhlciBzaWJsaW5ncy4gCiAqCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZmFjdG9yeSgnJGZhbW91c0RlY29yYXRvcicsIGZ1bmN0aW9uICgpIHsKICAgIC8vVE9ETzogIGFkZCByZXBlYXRlZCBsb2dpYyB0byB0aGVzZSByb2xlcwogICAgdmFyIF9yb2xlcyA9IHsKICAgICAgY2hpbGQ6IHsKICAgICAgfSwKICAgICAgcGFyZW50OiB7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gewogICAgICAvL1RPRE86ICBwYXRjaCBpbnRvIF9yb2xlcyBhbmQgYXNzaWduIHRoZQogICAgICAvLyBhcHByb3ByaWF0ZSByb2xlIHRvIHRoZSBnaXZlbiBzY29wZQogICAgICBhZGRSb2xlOiBmdW5jdGlvbihyb2xlLCBzY29wZSl7CgogICAgICB9LAoKICAgICAgLyoqCiAgICAgICAqIEBuZ2RvYyBtZXRob2QKICAgICAgICogQG5hbWUgJGZhbW91c0RlY29yYXRvciNlbnN1cmVJc29sYXRlCiAgICAgICAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICAgICAgICogQGRlc2NyaXB0aW9uCiAgICAgICAqIENoZWNrcyB0aGUgcGFzc2VkIGluIHNjb3BlIGZvciBhbiBleGlzdGluZyBpc29sYXRlIHByb3BlcnR5LiAgSWYKICAgICAgICogc2NvcGUuaXNvbGF0ZSBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0LCBjcmVhdGUgaXQuCiAgICAgICAqCiAgICAgICAqIElmIHRoZSBzY29wZSBpcyBiZWluZyB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggYW4gbmctcmVwZWF0LCBhc3NpZ24KICAgICAgICogdGhlIGRlZmF1bHQgbmctcmVwZWF0IGluZGV4IG9udG8gdGhlIHNjb3BlLiAKICAgICAgICoKICAgICAgICogQHJldHVybnMge09iamVjdH0gdGhlIGlzb2xhdGVkIHNjb3BlIG9iamVjdCBmcm9tIHNjb3BlLmlzb2xhdGUKICAgICAgICogIAogICAgICAgKiBAcGFyYW0ge1N0cmluZ30gc2NvcGUgLSB0aGUgc2NvcGUgdG8gZW5zdXJlIHRoYXQgdGhlIGlzb2xhdGUgcHJvcGVydHkKICAgICAgICogZXhpc3RzIG9uCiAgICAgICAqICAKICAgICAgICogQHVzYWdlCiAgICAgICAqIAogICAgICAgKiBgYGBqcwogICAgICAgKiB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZSgkc2NvcGUpOwogICAgICAgKiBgYGAKICAgICAgICovCiAgICAgIGVuc3VyZUlzb2xhdGU6IGZ1bmN0aW9uKHNjb3BlKXsKICAgICAgICBzY29wZS5pc29sYXRlID0gc2NvcGUuaXNvbGF0ZSB8fCB7fTsKICAgICAgICBzY29wZS5pc29sYXRlW3Njb3BlLiRpZF0gPSBzY29wZS5pc29sYXRlW3Njb3BlLiRpZF0gfHwge307CgogICAgICAgIC8vYXNzaWduIHRoZSBzY29wZSAkaWQgdG8gdGhlIGlzb2xhdGUKICAgICAgICB2YXIgaXNvbGF0ZSA9IHNjb3BlLmlzb2xhdGVbc2NvcGUuJGlkXTsKICAgICAgICBpc29sYXRlLmlkID0gc2NvcGUuJGlkOwoKICAgICAgICAvL2Fzc2lnbiBkZWZhdWx0IG5nLXJlcGVhdCBpbmRleCBpZiBpdCBleGlzdHMKICAgICAgICAvL2FuZCBpbmRleCBpc24ndCBhbHJlYWR5IGFzc2lnbmVkCiAgICAgICAgdmFyIGkgPSBzY29wZS4kZXZhbCgiJGluZGV4Iik7CiAgICAgICAgaWYoaSAmJiBpICE9PSAnJGluZGV4JyAmJiAhaXNvbGF0ZS5pbmRleCkgaXNvbGF0ZS5pbmRleCA9IGk7CgogICAgICAgIHJldHVybiBpc29sYXRlOwogICAgICB9CiAgICB9OwogIH0pOwoKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhQW5pbWF0aW9uCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIGFuaW1hdGUgYW4gZWxlbWVudCBpbiBjb25qdW5jdGlvbiB3aXRoIGFuIHtAbGluayBhcGkvZGlyZWN0aXZlL2FuaW1hdGUgYW5pbWF0ZX0gZGlyZWN0aXZlCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1hbmltYXRpb24gdGltZWxpbmU9ImZ1bmN0aW9uVGhhdFJldHVybnNBVGltZWxpbmVWYWx1ZUJldHdlZW4wQW5kMSI+CiAqICA8YW5pbWF0ZSB0YXJnZXRNb2RTZWxlY3Rvcj0iI3RvcE1vZCIgZmllbGQ9InJvdGF0ZVgiIHN0YXJ0VmFsdWU9IjMuMTQxNSIgZW5kVmFsdWU9IjAiIGN1cnZlPSJpblF1YWQiIHRpbWVsaW5lTG93ZXJCb3VuZD0iMCIgdGltZWxpbmVVcHBlckJvdW5kPSIuMjUiIC8+CiAqIDwvZmEtYW5pbWF0aW9uPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhQW5pbWF0aW9uJywgWyckZmFtb3VzJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJGZhbW91cywgZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0VBJywKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHZhciBUcmFuc2Zvcm0gPSAkZmFtb3VzWydmYW1vdXMvY29yZS9UcmFuc2Zvcm0nXTsKICAgICAgICB2YXIgVHJhbnNpdGlvbmFibGUgPSAkZmFtb3VzWydmYW1vdXMvdHJhbnNpdGlvbnMvVHJhbnNpdGlvbmFibGUnXTsKICAgICAgICB2YXIgRWFzaW5nID0gJGZhbW91c1snZmFtb3VzL3RyYW5zaXRpb25zL0Vhc2luZyddOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgIGlzb2xhdGUudGltZWxpbmUgPSBzY29wZS4kZXZhbChhdHRycy50aW1lbGluZSk7CiAgICAgICAgICAgICAgaXNvbGF0ZS5fdHJhbnMgPSBuZXcgVHJhbnNpdGlvbmFibGUoMCk7CgogICAgICAgICAgICAgIGlzb2xhdGUucGxheSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uID0gewogICAgICAgICAgICAgICAgICBkdXJhdGlvbjogc2NvcGUuJGV2YWwoYXR0cnMuZHVyYXRpb24pLAogICAgICAgICAgICAgICAgICBjdXJ2ZTogc2NvcGUuJGV2YWwoYXR0cnMuY3VydmUpIHx8ICdsaW5lYXInCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaXNvbGF0ZS5fdHJhbnMuc2V0KDEsIHRyYW5zaXRpb24sIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgIGlmKGNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIGlmKGF0dHJzLmxvb3ApewogICAgICAgICAgICAgICAgICAgIC8vRmFtby51cyBzaWxlbnRseSBicmVha3MgaXRzIHRyYW5zaXRpb25hYmxlIGlmIHRoaXMgcnVucyBpbgogICAgICAgICAgICAgICAgICAgIC8vdGhlIHNhbWUgZXhlY3V0aW9uIGNvbnRleHQuICBNYXliZSBhIHN1cHByZXNzZWQgU08gZXJyb3Igc29tZXdoZXJlPwogICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtpc29sYXRlLnJlcGxheShjYWxsYmFjayl9LCAwKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAvL1RPRE86ICBoYW5kbGUgJGFuaW1hdGUgd2l0aCBhIGNhbGxiYWNrCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlzb2xhdGUucmVzZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaXNvbGF0ZS5fdHJhbnMuc2V0KDApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpc29sYXRlLnJlcGxheSA9IGZ1bmN0aW9uKGNhbGxiYWNrKXsKICAgICAgICAgICAgICAgIGlzb2xhdGUucmVzZXQoKTsKICAgICAgICAgICAgICAgIGlzb2xhdGUucGxheShjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvL2Rpc2VuZ2FnZSBpcyBhIGZ1bmN0aW9uIHRoYXQKICAgICAgICAgICAgICAvL2NhbiB1bmFzc2lnbiB0aGUgZXZlbnQgbGlzdGVuZXIKICAgICAgICAgICAgICB2YXIgX2Rpc2VuZ2FnZSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICBpZihhdHRycy5ldmVudCl7CiAgICAgICAgICAgICAgICBpZihfZGlzZW5nYWdlKQogICAgICAgICAgICAgICAgICBfZGlzZW5nYWdlKCk7CiAgICAgICAgICAgICAgICBfZGlzZW5nYWdlID0gc2NvcGUuJG9uKGF0dHJzLmV2ZW50LCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBkYXRhICYmIGRhdGEuY2FsbGJhY2sgPyBkYXRhLmNhbGxiYWNrIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICBpc29sYXRlLnJlcGxheShjYWxsYmFjaykKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgaWQgPSBhdHRycy5pZDsKCiAgICAgICAgICAgICAgaWYoaXNvbGF0ZS50aW1lbGluZSA9PT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGlzb2xhdGUudGltZWxpbmUgPSBpc29sYXRlLl90cmFucy5nZXQuYmluZChpc29sYXRlLl90cmFucyk7CiAgICAgICAgICAgICAgICBpZihhdHRycy5hdXRvcGxheSkKICAgICAgICAgICAgICAgICAgaXNvbGF0ZS5wbGF5KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKCFpc29sYXRlLnRpbWVsaW5lIGluc3RhbmNlb2YgRnVuY3Rpb24pCiAgICAgICAgICAgICAgICB0aHJvdyAndGltZWxpbmUgbXVzdCBiZSBhIHJlZmVyZW5jZSB0byBhIGZ1bmN0aW9uIG9yIGR1cmF0aW9uIG11c3QgYmUgcHJvdmlkZWQnOwoKCSAgICAgICAgICAgIC8qKgoJICAgICAgICAgICAgICogQG5nZG9jIGRpcmVjdGl2ZQoJICAgICAgICAgICAgICogQG5hbWUgYW5pbWF0ZQoJICAgICAgICAgICAgICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgoJICAgICAgICAgICAgICogQHJlc3RyaWN0IEUKCSAgICAgICAgICAgICAqIEBkZXNjcmlwdGlvbgoJICAgICAgICAgICAgICogVGhpcyBkaXJlY3RpdmUgaXMgdXNlZCB0byBzcGVjaWZ5IHRoZSBhbmltYXRpb24gb2YgYW4gZWxlbWVudCBpbiBhIHtAbGluayBhcGkvZGlyZWN0aXZlL2ZhQW5pbWF0aW9uIGZhQW5pbWF0aW9ufSBkaXJlY3RpdmUKCSAgICAgICAgICAgICAqCgkgICAgICAgICAgICAgKiBAdXNhZ2UKCSAgICAgICAgICAgICAqIGBgYGh0bWwKCSAgICAgICAgICAgICAqIDxmYS1hbmltYXRpb24gdGltZWxpbmU9ImZ1bmN0aW9uVGhhdFJldHVybnNBVGltZWxpbmVWYWx1ZUJldHdlZW4wQW5kMSI+CgkgICAgICAgICAgICAgKiAgPGFuaW1hdGUgdGFyZ2V0TW9kU2VsZWN0b3I9IiN0b3BNb2QiIGZpZWxkPSJyb3RhdGVYIiBzdGFydFZhbHVlPSIzLjE0MTUiIGVuZFZhbHVlPSIwIiBjdXJ2ZT0iaW5RdWFkIiB0aW1lbGluZUxvd2VyQm91bmQ9IjAiIHRpbWVsaW5lVXBwZXJCb3VuZD0iLjI1IiAvPgoJICAgICAgICAgICAgICogPC9mYS1hbmltYXRpb24+CgkgICAgICAgICAgICAgKiBgYGAKCSAgICAgICAgICAgICAqLwoKICAgICAgICAgICAgICB2YXIgYW5pbWF0ZXMgPSBlbGVtZW50LmZpbmQoJ2FuaW1hdGUnKTsKICAgICAgICAgICAgICB2YXIgZGVjbGFyYXRpb25zID0ge307CgogICAgICAgICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBhbmltYXRlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAoZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgdmFyIGFuaW1hdGUgPSBhbmltYXRlc1tpXTsKCiAgICAgICAgICAgICAgICAgIC8vRE9NIHNlbGVjdG9yIHN0cmluZyB0aGF0IHBvaW50cyB0byBvdXIgbW9kIG9mIGludGVyZXN0CiAgICAgICAgICAgICAgICAgIGlmKGFuaW1hdGUuYXR0cmlidXRlc1sndGFyZ2V0bW9kc2VsZWN0b3InXSl7CiAgICAgICAgICAgICAgICAgICAgLy9kaWcgb3V0IHRoZSByZWZlcmVuY2UgdG8gb3VyIG1vZGlmaWVyCiAgICAgICAgICAgICAgICAgICAgLy9UT0RPOiAgc3VwcG9ydCBwYXNzaW5nIGEgZGlyZWN0IHJlZmVyZW5jZSB0byBhIG1vZGlmaWVyCiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgaW5zdGVhZCBvZiBwZXJmb3JtaW5nIGEgRE9NIGxvb2t1cAoJICAgICAgICAgICAgICAgIHZhciBtb2RFbGVtZW50cyA9IGFuZ3VsYXIuZWxlbWVudChlbGVtZW50WzBdLnBhcmVudE5vZGUpWzBdLnF1ZXJ5U2VsZWN0b3JBbGwoYW5pbWF0ZS5hdHRyaWJ1dGVzWyd0YXJnZXRtb2RzZWxlY3RvciddLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2gobW9kRWxlbWVudHMsIGZ1bmN0aW9uKG1vZEVsZW1lbnQpewogICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZFNjb3BlID0gYW5ndWxhci5lbGVtZW50KG1vZEVsZW1lbnQpLnNjb3BlKCk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbW9kaWZpZXIgPSBtb2RTY29wZS5pc29sYXRlW21vZFNjb3BlLiRpZF0ubW9kaWZpZXI7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0VHJhbnNmb3JtID0gbW9kU2NvcGUuaXNvbGF0ZVttb2RTY29wZS4kaWRdLmdldFRyYW5zZm9ybTsKCiAgICAgICAgICAgICAgICAgICAgICAvL1RPRE86ICB3b24ndCBuZWVkIHRvIHNwZWNpYWwtY2FzZSBjdXJ2ZSB0eXBlICdsaW5lYXInCiAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgICBvbmNlL2lmIGl0IGV4aXN0cyBpbiBFYXNpbmcuanMKICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJ2ZSA9CiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGUuYXR0cmlidXRlc1snY3VydmUnXSAmJgogICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRlLmF0dHJpYnV0ZXNbJ2N1cnZlJ10udmFsdWUgIT09ICdsaW5lYXInIAogICAgICAgICAgICAgICAgICAgICAgICA/IEVhc2luZ1thbmltYXRlLmF0dHJpYnV0ZXNbJ2N1cnZlJ10udmFsdWVdCiAgICAgICAgICAgICAgICAgICAgICAgIDogZnVuY3Rpb24oaikge3JldHVybiBqO307IC8vbGluZWFyCgogICAgICAgICAgICAgICAgICAgICAgLy9hc3NpZ24gdGhlIG1vZGlmaWVyIGZ1bmN0aW9ucwogICAgICAgICAgICAgICAgICAgICAgaWYoYW5pbWF0ZS5hdHRyaWJ1dGVzWydmaWVsZCddKXsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkID0gYW5pbWF0ZS5hdHRyaWJ1dGVzWydmaWVsZCddLnZhbHVlOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxvd2VyQm91bmQgPQogICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRlLmF0dHJpYnV0ZXNbJ3RpbWVsaW5lbG93ZXJib3VuZCddCiAgICAgICAgICAgICAgICAgICAgICAgICAgPyBwYXJzZUZsb2F0KGFuaW1hdGUuYXR0cmlidXRlc1sndGltZWxpbmVsb3dlcmJvdW5kJ10udmFsdWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgOiAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVwcGVyQm91bmQgPQogICAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGUuYXR0cmlidXRlc1sndGltZWxpbmV1cHBlcmJvdW5kJ10KICAgICAgICAgICAgICAgICAgICAgICAgICA/IHBhcnNlRmxvYXQoYW5pbWF0ZS5hdHRyaWJ1dGVzWyd0aW1lbGluZXVwcGVyYm91bmQnXS52YWx1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICA6IDE7CgogICAgICAgICAgICAgICAgICAgICAgICBpZighYW5pbWF0ZS5hdHRyaWJ1dGVzWydzdGFydHZhbHVlJ10pCiAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgJ3lvdSBtdXN0IHByb3ZpZGUgYSBzdGFydCB2YWx1ZSBmb3IgdGhlIGFuaW1hdGlvbicKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0VmFsdWUgPSBzY29wZS4kZXZhbChhbmltYXRlLmF0dHJpYnV0ZXNbJ3N0YXJ0dmFsdWUnXS52YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZighYW5pbWF0ZS5hdHRyaWJ1dGVzWydlbmR2YWx1ZSddKQogICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93ICd5b3UgbXVzdCBwcm92aWRlIGFuIGVuZCB2YWx1ZSBmb3IgdGhlIGFuaW1hdGlvbicKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVuZFZhbHVlID0gc2NvcGUuJGV2YWwoYW5pbWF0ZS5hdHRyaWJ1dGVzWydlbmRWYWx1ZSddLnZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vS2VlcCBhcnJheXMgb2YgYWxsIGRlY2xhcmF0aW9ucyBzbyB0aGF0IHRyYW5zZm9ybUZ1bmN0aW9ucwogICAgICAgICAgICAgICAgICAgICAgICAvL2NhbiBoYW5kbGUgYWxsIG9mIHRoZSBhcHByb3ByaWF0ZSBzZWdtZW50cwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1vZERlY3MgPQogICAgICAgICAgICAgICAgICAgICAgICAgIGRlY2xhcmF0aW9uc1ttb2RTY29wZS4kaWRdID0KICAgICAgICAgICAgICAgICAgICAgICAgICBkZWNsYXJhdGlvbnNbbW9kU2NvcGUuJGlkXSB8fCB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlZ21lbnRzID0gbW9kRGVjc1tmaWVsZF0gPSBtb2REZWNzW2ZpZWxkXSB8fCBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgc2VnbWVudHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VyQm91bmQ6IGxvd2VyQm91bmQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgdXBwZXJCb3VuZDogdXBwZXJCb3VuZCwKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydFZhbHVlOiBzdGFydFZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGVuZFZhbHVlOiBlbmRWYWx1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJ2ZTogY3VydmUKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvL0tlZXAgbW9kRGVjc1tmaWVsZF0gc29ydGVkCiAgICAgICAgICAgICAgICAgICAgICAgIHNlZ21lbnRzLnNvcnQoZnVuY3Rpb24oYSwgYil7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEubG93ZXJCb3VuZCAtIGIubG93ZXJCb3VuZDsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvL0NoZWNrIGRvbWFpbiBvdmVybGFwOgogICAgICAgICAgICAgICAgICAgICAgICAvL2FmdGVyIHNvcnRpbmcgYnkgbG93ZXJCb3VuZHMsIGlmIGFueSBzZWdtZW50J3MgbG93ZXIgYm91bmQKICAgICAgICAgICAgICAgICAgICAgICAgLy9pcyBsb3dlciB0aGFuIHRoZSBsb3dlciBib3VuZCBvZiBhbnkgaXRlbSBiZWZvcmUgaXQsIGRvbWFpbnMgYXJlCiAgICAgICAgICAgICAgICAgICAgICAgIC8vb3ZlcmxhcHBpbmcKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMTsgaiA8IHNlZ21lbnRzLmxlbmd0aDsgaisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbG93ZXIgPSBzZWdtZW50c1tqXS5sb3dlckJvdW5kOwogICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgayA9IDA7IGsgPCBqOyBrKyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYobG93ZXIgPCBzZWdtZW50c1trXS51cHBlckJvdW5kKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgIkFuaW1hdGUgc2VnbWVudHMgaGF2ZSBvdmVybGFwcGluZyBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9tYWlucyBmb3IgdGhlIHNhbWUgZmllbGQgKCIgKyBmaWVsZCArICIpLiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQXQgYW55IHBvaW50IGluIHRoZSB0aW1lbGluZSwgb25seSBvbmUgPGFuaW1hdGU+IFwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYW4gYWZmZWN0IGEgZ2l2ZW4gZmllbGQgb24gdGhlIHNhbWUgbW9kaWZpZXIuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vRG9tYWluOiAgdGltZWxpbmUgZnVuY3Rpb24gYm91bmRlZCBbMCwxXQogICAgICAgICAgICAgICAgICAgICAgICAvL1N1YmRvbWFpbnMgKGJldHdlZW4gcGlwZXMpOiAgc3BlY2lmaWVkIHN1YmRvbWFpbnMgb2YgdGltZWxpbmUgc2VnbWVudHMKICAgICAgICAgICAgICAgICAgICAgICAgLy9SYW5nZTogIG91dHB1dCB2YWx1ZSwgZGV0ZXJtaW5lZCBieSBpbnRlcnBvbGF0aW5nIHN0YXJ0VmFsdWUgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAgICBlbmRWYWx1ZSB0aHJvdWdoIHRoZSBlYXNpbmcgY3VydmVzLgogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgICAgICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAgICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgICAgfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAgICAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgICAgICAgIHwgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgKGVhc2UpICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAoZWFzZSkgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgICAgICAgIC0vfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC1cICAgICAgICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICB8ICAgICAgLS8gIHwgICAgICAgICAgICAgICAgICAgICAgIHwgIC1cICAgICAgfAogICAgICAgICAgICAgICAgICAgICAgICAvLyAgICAgfCAgICAtLyAgICB8ICAgICAgICAgICAgICAgICAgICAgICB8ICAgIC1cICAgIHwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgIC0vICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgIC1cICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC0tLS18LS8gICAgICAgIHwgICAgICAgICAgICAgICAgICAgICAgIHwgICAgICAgIC1cfC0tLS0tLS0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHwgICAgICAgICAgfCAgICAgICAgICAgICAgICAgICAgICAgfCAgICAgICAgICB8CiAgICAgICAgICAgICAgICAgICAgICAgIC8vX19fX198X19fX19fX19fX3xfX19fX19fX19fX19fX19fX19fX19fX3xfX19fX19fX19ffF9fX19fX18KICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgIHx4KDAsMCkgICAgfHgoMCwxKSAgICAgICAgICAgICAgICAgfHgoMSwwKSAgICB8eCgxLDEpCgogICAgICAgICAgICAgICAgICAgICAgICAvL1RPRE86ICBpbiBvcmRlciB0byBzdXBwb3J0IG5lc3RlZCBmYS1hbmltYXRpb24gZGlyZWN0aXZlcywKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgdGhpcyBmdW5jdGlvbiBuZWVkcyB0byBiZSBleHBvc2VkIHNvbWVob3cuIChwYXNzIGEgcmVmZXJlbmNlIGludG8gdGhlIGRpcmVjdGl2ZTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgYW5kIHRoZW4gYXNzaWduIHRoaXMgZnVuY3Rpb24gdG8gdGhhdCByZWZlcmVuY2U/KQogICAgICAgICAgICAgICAgICAgICAgICAvL1RPRE86ICBpZiBuZWVkZWQ6ICBtYWtlIHRoaXMgbW9yZSBlZmZpY2llbnQuICBUaGlzIGlzIGEgaG90LXJ1bm5pbmcKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgZnVuY3Rpb24gYW5kIHdlIHNob3VsZCBiZSBhYmxlIHRvIG9wdGltaXplLgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtRnVuY3Rpb24gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4ID0gaXNvbGF0ZS50aW1lbGluZSgpIHx8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbGV2YW50SW5kZXggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWxldmFudFNlZ21lbnQgPSBzZWdtZW50c1tyZWxldmFudEluZGV4XTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IHNlZ21lbnRzLmxlbmd0aDsgaisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcyBpcyB0aGUgcmVsZXZhbnQgc2VnbWVudCBpZiB4IGlzIGluIHRoZSBzdWJkb21haW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHggPj0gc2VnbWVudHNbal0ubG93ZXJCb3VuZCAmJiB4IDw9IHNlZ21lbnRzW2pdLnVwcGVyQm91bmQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxldmFudFNlZ21lbnQgPSBzZWdtZW50c1tqXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMgaXMgdGhlIHJlbGV2YW50IHNlZ21lbnQgaWYgaXQgaXMgdGhlIGxhc3Qgb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihqID09PSBzZWdtZW50cy5sZW5ndGggLSAxKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVsZXZhbnRTZWdtZW50ID0gc2VnbWVudHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90aGlzIGlzIHRoZSByZWxldmFudCBzZWdtZW50IGlmIHggaXMgZ3JlYXRlciB0aGFuIGl0cyB1cHBlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9ib3VuZCBidXQgbGVzcyB0aGFuIHRoZSBuZXh0IHNlZ21lbnQncyBsb3dlciBib3VuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA+PSBzZWdtZW50c1tqXS51cHBlckJvdW5kICYmIHggPCBzZWdtZW50c1tqICsgMV0ubG93ZXJCb3VuZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGV2YW50U2VnbWVudCA9IHNlZ21lbnRzW2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHggPD0gcmVsZXZhbnRTZWdtZW50Lmxvd2VyQm91bmQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVsZXZhbnRTZWdtZW50LnN0YXJ0VmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeCA+PSByZWxldmFudFNlZ21lbnQudXBwZXJCb3VuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWxldmFudFNlZ21lbnQuZW5kVmFsdWU7IAogICAgICAgICAgICAgICAgICAgICAgICAgIC8vbm9ybWFsaXplIG91ciBkb21haW4gdG8gWzAsIDFdCiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN1YkRvbWFpbiA9IChyZWxldmFudFNlZ21lbnQudXBwZXJCb3VuZCAtIHJlbGV2YW50U2VnbWVudC5sb3dlckJvdW5kKQogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub3JtYWxpemVkWCA9ICh4IC0gcmVsZXZhbnRTZWdtZW50Lmxvd2VyQm91bmQpIC8gc3ViRG9tYWluOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAvL1N1cHBvcnQgaW50ZXJwb2xhdGluZyBtdWx0aXBsZSB2YWx1ZXMsIGUuZy4gZm9yIGEgU2NhbGUgYXJyYXkgW3gseSx6XQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmKEFycmF5LmlzQXJyYXkocmVsZXZhbnRTZWdtZW50LnN0YXJ0VmFsdWUpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCByZWxldmFudFNlZ21lbnQuc3RhcnRWYWx1ZS5sZW5ndGg7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGV2YW50U2VnbWVudC5zdGFydFZhbHVlW2pdICsgcmVsZXZhbnRTZWdtZW50LmN1cnZlKG5vcm1hbGl6ZWRYKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAocmVsZXZhbnRTZWdtZW50LmVuZFZhbHVlW2pdIC0gcmVsZXZhbnRTZWdtZW50LnN0YXJ0VmFsdWVbal0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbGV2YW50U2VnbWVudC5zdGFydFZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgcmVsZXZhbnRTZWdtZW50LmN1cnZlKG5vcm1hbGl6ZWRYKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqIChyZWxldmFudFNlZ21lbnQuZW5kVmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLSByZWxldmFudFNlZ21lbnQuc3RhcnRWYWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZm9ybUNvbXBvbmVudHMgPSBtb2REZWNzLnRyYW5zZm9ybUNvbXBvbmVudHMgPSBtb2REZWNzLnRyYW5zZm9ybUNvbXBvbmVudHMgfHwgW107CgogICAgICAgICAgICAgICAgICAgICAgICBpZihmaWVsZCA9PT0gJ29wYWNpdHknKXsKICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RpZmllci5vcGFjaXR5RnJvbShmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybUZ1bmN0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmIChmaWVsZCA9PT0gJ29yaWdpbicpewogICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGlmaWVyLm9yaWdpbkZyb20oZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2Zvcm1GdW5jdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZSBpZiAoZmllbGQgPT09ICdzaXplJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXIuc2l6ZUZyb20oZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2Zvcm1GdW5jdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsgLy90cmFuc2Zvcm0gZmllbGQKICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2Zvcm1Db21wb25lbnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IGZpZWxkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IHRyYW5zZm9ybUZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kaWZpZXIudHJhbnNmb3JtRnJvbShmdW5jdGlvbigpewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtdWx0ID0gZ2V0VHJhbnNmb3JtICYmIGdldFRyYW5zZm9ybSgpID8gW2dldFRyYW5zZm9ybSgpXSA6IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yKHZhciBqID0gMDsgaiA8IHRyYW5zZm9ybUNvbXBvbmVudHMubGVuZ3RoOyBqKyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoKGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zVmFsID0gdHJhbnNmb3JtQ29tcG9uZW50c1tqXS5mbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmID0gdHJhbnNmb3JtQ29tcG9uZW50c1tqXS5maWVsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihBcnJheS5pc0FycmF5KHRyYW5zVmFsKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG11bHQucHVzaChUcmFuc2Zvcm1bZl0uYXBwbHkodGhpcywgdHJhbnNWYWwpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtdWx0LnB1c2goVHJhbnNmb3JtW2ZdKHRyYW5zVmFsKSk7ICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkoKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9UcmFuc2Zvcm0ubXVsdGlwbHkgZmFpbHMgb24gYXJyYXlzIG9mIDw9MSBtYXRyaWNpZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKG11bHQubGVuZ3RoID09PSAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbXVsdFswXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJhbnNmb3JtLm11bHRpcGx5LmFwcGx5KHRoaXMsIG11bHQpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9KSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxKS8vZW5kIHNldFRpbWVvdXQKICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYUFwcAogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBFQQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgaXMgdGhlIGNvbnRhaW5lciBhbmQgZW50cnkgcG9pbnQgdG8gRmFtby51cy9Bbmd1bGFyLiAgQmVoaW5kIHRoZSBzY2VuZXMsCiAqIGl0IGNyZWF0ZXMgYSBGYW1vdXMgY29udGV4dCBhbmQgdGhlbiBhZGRzIGNoaWxkIGVsZW1lbnRzCiAqIHRvIHRoYXQgY29udGV4dCBhcyB0aGV5IGdldCBjb21waWxlZC4gIEluc2lkZSBvZiB0aGlzIGRpcmVjdGl2ZSwKICogbm9ybWFsIEhUTUwgY29udGVudCB3aWxsIG5vdCBnZXQgcmVuZGVyZWQgdG8gdGhlIHNjcmVlbiB1bmxlc3MKICogaXQgaXMgaW5zaWRlIG9mIGEge0BsaW5rIGFwaS9kaXJlY3RpdmUvZmFTdXJmYWNlIGZhLXN1cmZhY2V9IGRpcmVjdGl2ZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLWFwcCBuZy1jb250cm9sbGVyPSJNeUN0cmwiPgogKiAgIDwhLS0gb3RoZXIgZmEtIHNjZW5lIGdyYXBoIGNvbXBvbmVudHMgLS0+CiAqIDwvZmEtYXBwPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhQXBwJywgWyIkZmFtb3VzIiwgIiRmYW1vdXNEZWNvcmF0b3IiLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgdGVtcGxhdGU6ICc8ZGl2IHN0eWxlPSJkaXNwbGF5OiBub25lOyI+PGRpdj48L2Rpdj48L2Rpdj4nLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBWaWV3ID0gJGZhbW91c1snZmFtb3VzL2NvcmUvVmlldyddOwogICAgICAgICAgICB2YXIgRW5naW5lID0gJGZhbW91c1snZmFtb3VzL2NvcmUvRW5naW5lJ107CiAgICAgICAgICAgIHZhciBUcmFuc2Zvcm0gPSAkZmFtb3VzWydmYW1vdXMvY29yZS9UcmFuc2Zvcm0nXQoKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kKCc8ZGl2IGNsYXNzPSJmYW1vdXMtYW5ndWxhci1jb250YWluZXIiPjwvZGl2PicpOwogICAgICAgICAgICBpc29sYXRlLmNvbnRleHQgPSBFbmdpbmUuY3JlYXRlQ29udGV4dChlbGVtZW50WzBdLnF1ZXJ5U2VsZWN0b3IoJy5mYW1vdXMtYW5ndWxhci1jb250YWluZXInKSk7CgogICAgICAgICAgICBmdW5jdGlvbiBBcHBWaWV3KCl7CiAgICAgICAgICAgICAgVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBBcHBWaWV3LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoVmlldy5wcm90b3R5cGUpOwogICAgICAgICAgICBBcHBWaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IEFwcFZpZXc7CgogICAgICAgICAgICB2YXIgZ2V0T3JWYWx1ZSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICByZXR1cm4geC5nZXQgPyB4LmdldCgpIDogeDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHZhciBnZXRUcmFuc2Zvcm0gPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zZm9ybXMgPSBbXTsKICAgICAgICAgICAgICBpZiAoZGF0YS5tb2QoKS50cmFuc2xhdGUgJiYgZGF0YS5tb2QoKS50cmFuc2xhdGUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gZGF0YS5tb2QoKS50cmFuc2xhdGUubWFwKGdldE9yVmFsdWUpCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goVHJhbnNmb3JtLnRyYW5zbGF0ZS5hcHBseSh0aGlzLCB2YWx1ZXMpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNjb3BlWyJmYVJvdGF0ZVoiXSkKICAgICAgICAgICAgICAgIHRyYW5zZm9ybXMucHVzaChUcmFuc2Zvcm0ucm90YXRlWihzY29wZVsiZmFSb3RhdGVaIl0pKTsKICAgICAgICAgICAgICBpZiAoc2NvcGVbImZhU2tldyJdKQogICAgICAgICAgICAgICAgdHJhbnNmb3Jtcy5wdXNoKFRyYW5zZm9ybS5za2V3KDAsIDAsIHNjb3BlWyJmYVNrZXciXSkpOwogICAgICAgICAgICAgIHJldHVybiBUcmFuc2Zvcm0ubXVsdGlwbHkuYXBwbHkodGhpcywgdHJhbnNmb3Jtcyk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBpc29sYXRlLnZpZXcgPSBuZXcgQXBwVmlldygpOwogICAgICAgICAgICBpc29sYXRlLmNvbnRleHQuYWRkKGlzb2xhdGUudmlldyk7CgogICAgICAgICAgICAvL0hBQ0s6ICBTaW5jZSBGYW1vLnVzIEVuZ2luZSBkb2Vzbid0IHlldAogICAgICAgICAgICAvL3N1cHBvcnQgdW5yZWdpc3RlcmluZyBjb250ZXh0cywgdGhpcyB3aWxsIGtlZXAKICAgICAgICAgICAgLy90aGUgY29udGV4dCBmcm9tIGdldHRpbmcgdXBkYXRlZCBieSB0aGUgZW5naW5lCiAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIGlzb2xhdGUuY29udGV4dC51cGRhdGUgPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIH0pCgoKICAgICAgICAgICAgLy9UT0RPOiAgV2hhdCBpZiB0aGUgYWN0dWFsIHNjb3BlIGhpZXJhcmNoeQogICAgICAgICAgICAvL3dlcmUgYW5ndWxhciAkd2F0Y2hlZCBpbnN0ZWFkIG9mIHVzaW5nIGV2ZW50aW5nPwogICAgICAgICAgICAvL0NvdWxkIHdyaXRlIGEgZnVuY3Rpb24gdGhhdCB0cmF2ZXJzZXMgYW5ndWxhcidzIHNjb3BlcwogICAgICAgICAgICAvL2FuZCByZXR1cm5zIGEgaGFzaC1saWtlCiAgICAgICAgICAgIC8vcmVwcmVzZW50YXRpb24gb2YgcmVuZGVyLW5vZGUtY29udGFpbmluZyAkc2NvcGVzCiAgICAgICAgICAgIC8vKHZpYSB0aGVpciBpc29sYXRlIG9iamVjdHMuKSAgVGhlbiwgdHdlYWsgdGhlIHNjZW5lCiAgICAgICAgICAgIC8vZ3JhcGggYXMgbmVlZGVkIHdoZW4gaXQgc2VlcyBjaGFuZ2VzLgogICAgICAgICAgICAvL1RoaXMgd291bGQgbWFrZSBlLmcuIHJlZmxvd2luZyBlbGVtZW50cyBpbiBhIHNjcm9sbHZpZXcKICAgICAgICAgICAgLy9tb3JlIGVsZWdhbnQgdGhhbiB0aGUgY3VycmVudCBhcHByb2FjaCwgYnV0IHdvdWxkCiAgICAgICAgICAgIC8vcmVxdWlyZSBhIGJpdCBvZiByZXBsdW1iaW5nLiAgV291bGQgbmVlZCB0byBpbnZlc3RpZ2F0ZQogICAgICAgICAgICAvL3RoZSBvdmVyaGVhZCBvZiAkd2F0Y2hpbmcgYSBwb3RlbnRpYWxseSBjb21wbGV4IHNjZW5lIGdyYXBoLCB0b28KICAgICAgICAgICAgc2NvcGUuJG9uKCdyZWdpc3RlckNoaWxkJywgZnVuY3Rpb24oZXZ0LCBkYXRhKXsKICAgICAgICAgICAgICBpc29sYXRlLnZpZXcuYWRkKGRhdGEucmVuZGVyTm9kZSk7CiAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICB9KQogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CgogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CgkgICAgICAgICAgICBhbmd1bGFyLmVsZW1lbnQoZWxlbWVudFswXS5xdWVyeVNlbGVjdG9yQWxsKCdkaXYgZGl2JylbMF0pLmFwcGVuZChjbG9uZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpc29sYXRlLnJlYWR5VG9SZW5kZXIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYUNsaWNrCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEEKICogQHBhcmFtIHtleHByZXNzaW9ufSBmYUNsaWNrIHtAbGluayBodHRwczovL2RvY3MuYW5ndWxhcmpzLm9yZy9ndWlkZS9leHByZXNzaW9uIEV4cHJlc3Npb259IHRvIGV2YWx1YXRlIHVwb24KICogY2xpY2suICh7QGxpbmsgaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvZ3VpZGUvZXhwcmVzc2lvbiMtZXZlbnQtIEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGB9KQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuIGFuIGVsZW1lbnQgaXMgY2xpY2tlZC4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS1jbGljaz0iZXhwcmVzc2lvbiI+CiAqCiAqIDwvQU5ZPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhQ2xpY2snLCBbIiRwYXJzZSIsICIkZmFtb3VzRGVjb3JhdG9yIixmdW5jdGlvbiAoJHBhcnNlLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICBpZiAoYXR0cnMuZmFDbGljaykgewogICAgICAgICAgICAgIHZhciByZW5kZXJOb2RlID0gKGlzb2xhdGUucmVuZGVyTm9kZS5fZXZlbnRJbnB1dCB8fCBpc29sYXRlLnJlbmRlck5vZGUpCgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oImNsaWNrIiwgZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJzLmZhQ2xpY2spOwogICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZGF0YX0pOwogICAgICAgICAgICAgICAgaWYoIXNjb3BlLiQkcGhhc2UpCiAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhR3JpZExheW91dAogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBFQQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgd2lsbCBjcmVhdGUgYSBGYW1vLnVzIEdyaWRMYXlvdXQgY29udGFpbmluZyB0aGUgCiAqIHNwZWNpZmllZCBjaGlsZCBlbGVtZW50cy4gVGhlIHByb3ZpZGVkIGBvcHRpb25zYCBvYmplY3QKICogd2lsbCBwYXNzIGRpcmVjdGx5IHRocm91Z2ggdG8gdGhlIEZhbW8udXMgR3JpZExheW91dCdzCiAqIGNvbnN0cnVjdG9yLiAgU2VlIFtodHRwczovL2ZhbW8udXMvZG9jcy8wLjEuMS92aWV3cy9HcmlkTGF5b3V0L10KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLWdyaWQtbGF5b3V0IGZhLW9wdGlvbnM9InNjb3BlT3B0aW9uc09iamVjdCI+CiAqICAgPCEtLSB6ZXJvIG9yIG1vcmUgcmVuZGVyIG5vZGVzIC0tPgogKiA8L2ZhLWdyaWQtbGF5b3V0PgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhR3JpZExheW91dCcsIFsiJGZhbW91cyIsICIkZmFtb3VzRGVjb3JhdG9yIiwgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHRlbXBsYXRlOiAnPGRpdj48L2Rpdj4nLAogICAgICByZXN0cmljdDogJ0UnLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgY29tcGlsZTogZnVuY3Rpb24odEVsZW0sIHRBdHRycywgdHJhbnNjbHVkZSl7CiAgICAgICAgcmV0dXJuICB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciBHcmlkTGF5b3V0ID0gJGZhbW91c1siZmFtb3VzL3ZpZXdzL0dyaWRMYXlvdXQiXTsKICAgICAgICAgICAgdmFyIFZpZXdTZXF1ZW5jZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1ZpZXdTZXF1ZW5jZSddOwoKICAgICAgICAgICAgdmFyIF9jaGlsZHJlbiA9IFtdOwoKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSBzY29wZS4kZXZhbChhdHRycy5mYU9wdGlvbnMpIHx8IHt9OwogICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUgPSBuZXcgR3JpZExheW91dChvcHRpb25zKTsKCiAgICAgICAgICAgIHZhciB1cGRhdGVHcmlkTGF5b3V0ID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBfY2hpbGRyZW4uc29ydChmdW5jdGlvbihhLCBiKXsKICAgICAgICAgICAgICAgIHJldHVybiBhLmluZGV4IC0gYi5pbmRleDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2VxdWVuY2VGcm9tKGZ1bmN0aW9uKF9jaGlsZHJlbikgewoJICAgICAgICAgICAgICB2YXIgX2NoID0gW107CgkgICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfY2hpbGRyZW4sIGZ1bmN0aW9uKGMsIGkpIHsKCQkgICAgICAgICAgICAgIF9jaFtpXSA9IGMucmVuZGVyTm9kZTsKCSAgICAgICAgICAgICAgfSkKCSAgICAgICAgICAgICAgcmV0dXJuIF9jaDsKICAgICAgICAgICAgICB9KF9jaGlsZHJlbikpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzY29wZS4kb24oJ3JlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT0gc2NvcGUuJGlkKXsKICAgICAgICAgICAgICAgIF9jaGlsZHJlbi5wdXNoKGRhdGEpOwogICAgICAgICAgICAgICAgdXBkYXRlR3JpZExheW91dCgpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJG9uKCd1bnJlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT0gc2NvcGUuJGlkKXsKCSAgICAgICAgICAgIF9jaGlsZHJlbiA9IGZ1bmN0aW9uKF9jaGlsZHJlbikgewoJCSAgICAgICAgICB2YXIgX2NoID0gW107CgkJICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfY2hpbGRyZW4sIGZ1bmN0aW9uKGMpIHsKCQkJICAgICAgICBpZihjLmlkICE9PSBkYXRhLmlkKSB7CgkJCQkgICAgICBfY2gucHVzaChjKTsKCQkJICAgICAgICB9CgkJICAgICAgICAgIH0pOwoJCSAgICAgICAgICByZXR1cm4gX2NoOwoJICAgICAgICAgICAgfShfY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgdXBkYXRlR3JpZExheW91dCgpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICB9LAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKXsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICAKICAgICAgICAgICAgdHJhbnNjbHVkZShzY29wZSwgZnVuY3Rpb24oY2xvbmUpIHsKICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJ2RpdicpLmFwcGVuZChjbG9uZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJGVtaXQoJ3JlZ2lzdGVyQ2hpbGQnLCBpc29sYXRlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhSW1hZ2VTdXJmYWNlCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBwYXJhbSB7U3RyaW5nfSBmYUltYWdlVXJsICAtICBTdHJpbmcgdXJsIHBvaW50aW5nIHRvIHRoZSBpbWFnZSB0aGF0IHNob3VsZCBiZSBsb2FkZWQgaW50byB0aGUgRmFtby51cyBJbWFnZVN1cmZhY2UKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGNyZWF0ZXMgYSBGYW1vLnVzIEltYWdlU3VyZmFjZSBhbmQgbG9hZHMKICogdGhlIHNwZWNpZmllZCBJbWFnZVVybC4KICogQHVzYWdlCiAqIGBgYGh0bWwKICogPGZhLWltYWdlLXN1cmZhY2UgZmEtaW1hZ2UtdXJsPSJpbWcvbXktaW1hZ2UucG5nIj4KICogPC9mYS1pbWFnZS1zdXJmYWNlPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhSW1hZ2VTdXJmYWNlJywgWyIkZmFtb3VzIiwgIiRmYW1vdXNEZWNvcmF0b3IiLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIHRlbXBsYXRlOiAnPGRpdiBjbGFzcz0iZmEtaW1hZ2Utc3VyZmFjZSI+PC9kaXY+JywKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtLCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHZhciBJbWFnZVN1cmZhY2UgPSAkZmFtb3VzWydmYW1vdXMvc3VyZmFjZXMvSW1hZ2VTdXJmYWNlJ107CiAgICAgICAgICAgIHZhciBUcmFuc2Zvcm0gPSAkZmFtb3VzWydmYW1vdXMvY29yZS9UcmFuc2Zvcm0nXQogICAgICAgICAgICB2YXIgRXZlbnRIYW5kbGVyID0gJGZhbW91c1snZmFtb3VzL2NvcmUvRXZlbnRIYW5kbGVyJ107CiAgICAgICAgICAgIAogICAgICAgICAgICAvL3VwZGF0ZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgIC8vVE9ETzogIGlzIHRoaXMgZ29pbmcgdG8gYmUgYSBib3R0bGVuZWNrPwogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHJldHVybiBpc29sYXRlLmdldFByb3BlcnRpZXMoKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIGlmKGlzb2xhdGUucmVuZGVyTm9kZSkKICAgICAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLnNldFByb3BlcnRpZXMoaXNvbGF0ZS5nZXRQcm9wZXJ0aWVzKCkpOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgdHJ1ZQogICAgICAgICAgICApCgogICAgICAgICAgICBpc29sYXRlLmdldFByb3BlcnRpZXMgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHNjb3BlLiRldmFsKGF0dHJzLmZhQmFja2dyb3VuZENvbG9yKSwKICAgICAgICAgICAgICAgIGNvbG9yOiBzY29wZS4kZXZhbChhdHRycy5mYUNvbG9yKQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB2YXIgZ2V0T3JWYWx1ZSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICByZXR1cm4geC5nZXQgPyB4LmdldCgpIDogeDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IG5ldyBJbWFnZVN1cmZhY2UoewogICAgICAgICAgICAgIHNpemU6IHNjb3BlLiRldmFsKGF0dHJzLmZhU2l6ZSksCiAgICAgICAgICAgICAgY2xhc3M6IHNjb3BlLiRldmFsKGF0dHJzLmNsYXNzKSwKICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBpc29sYXRlLmdldFByb3BlcnRpZXMoKQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vVE9ETzogIHN1cHBvcnQgbmctY2xhc3MKICAgICAgICAgICAgaWYoYXR0cnMuY2xhc3MpCiAgICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlLnNldENsYXNzZXMoYXR0cnNbJ2NsYXNzJ10uc3BsaXQoJyAnKSk7CgogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB1cGRhdGVDb250ZW50ID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2V0Q29udGVudChhdHRycy5mYUltYWdlVXJsKQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdXBkYXRlQ29udGVudCgpOwoKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhSW1hZ2VVcmwnLCB1cGRhdGVDb250ZW50KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhSW5kZXgKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgaXMgdXNlZCB0byBzcGVjaWZ5IHRoZSByZW5kZXJpbmcgb3JkZXIgb2YgZWxlbWVudHMKICogaW5zaWRlIG9mIGEgVmlld1NlcXVlbmNlLWJhc2VkIGNvbXBvbmVudCwgc3VjaCBhcyBAbGluayBhcGkvZGlyZWN0aXZlL2ZhU2Nyb2xsVmlldyBmYVNjcm9sbFZpZXd9CiAqIG9yIEBsaW5rIGFwaS9kaXJlY3RpdmUvZmFHcmlkTGF5b3V0IGZhR3JpZExheW91dH0uICBBcyBhIHNwZWNpYWwgY2FzZSwgd2hlbiBlbGVtZW50cyBhcmUgYWRkZWQgdG8KICogdGhlc2UgY29udHJvbHMgdXNpbmcgbmctcmVwZWF0LCB0aGV5IGFyZSBhdXRvbWF0aWNhbGx5IGFzc2lnbmVkIHRoZQogKiAkaW5kZXggcHJvcGVydHkgZXhwb3NlZCBieSBuZy1yZXBlYXQuICBXaGVuIGFkZGluZyBlbGVtZW50cyBtYW51YWxseQogKiAoZS5nLiB0byBhIGZhU2Nyb2xsVmlldyBidXQgbm90IHVzaW5nIG5nLXJlcGVhdCkgb3IgaW4gYSBjYXNlIHdoZXJlIGN1c3RvbQogKiBvcmRlciBpcyBkZXNpcmVkLCB0aGVuIHRoZSBpbmRleCB2YWx1ZSBtdXN0IGJlIGFzc2lnbmVkL292ZXJyaWRkZW4gdXNpbmcgdGhlIGZhSW5kZXggZGlyZWN0aXZlLgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtc2Nyb2xsLXZpZXc+CiAqICA8ZmEtc3VyZmFjZSBmYS1pbmRleD0iMCI+U3VyZmFjZSAxPC9mYS1zdXJmYWNlPgogKiAgPGZhLXN1cmZhY2UgZmEtaW5kZXg9IjEiPlN1cmZhY2UgMjwvZmEtc3VyZmFjZT4KICogPC9mYS1zY3JvbGwtdmlldz4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYUluZGV4JywgWyIkcGFyc2UiLCAiJGZhbW91c0RlY29yYXRvciIsIGZ1bmN0aW9uICgkcGFyc2UsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHNjb3BlOiBmYWxzZSwKICAgICAgcHJpb3JpdHk6IDE2LAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIGlzb2xhdGUuaW5kZXggPSBzY29wZS4kZXZhbChhdHRycy5mYUluZGV4KTsKCiAgICAgICAgICAgIHNjb3BlLiR3YXRjaChmdW5jdGlvbigpewogICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5mYUluZGV4KQogICAgICAgICAgICB9LCBmdW5jdGlvbigpewogICAgICAgICAgICAgIGlzb2xhdGUuaW5kZXggPSBzY29wZS4kZXZhbChhdHRycy5mYUluZGV4KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFNb2RpZmllcgogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBFQQogKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufSBmYVJvdGF0ZSAgLSAgQXJyYXkgb2YgbnVtYmVycyBvciBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgbnVtYmVycyB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgcm90YXRlIHNob3VsZCBiZSBib3VuZC4KICogQHBhcmFtIHtOdW1iZXJ8RnVuY3Rpb259IGZhUm90YXRlWCAgLSAgTnVtYmVyIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhIG51bWJlciB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgcm90YXRlWCBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtOdW1iZXJ8RnVuY3Rpb259IGZhUm90YXRlWSAgLSAgTnVtYmVyIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhIG51bWJlciB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgcm90YXRlWSBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtOdW1iZXJ8RnVuY3Rpb259IGZhUm90YXRlWiAgLSAgTnVtYmVyIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhIG51bWJlciB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgcm90YXRlWiBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbn0gZmFTY2FsZSAgLSAgQXJyYXkgb2YgbnVtYmVycyBvciBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgbnVtYmVycyB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgc2NhbGUgc2hvdWxkIGJlIGJvdW5kCiAqIEBwYXJhbSB7QXJyYXl8RnVuY3Rpb259IGZhU2tldyAgLSAgQXJyYXkgb2YgbnVtYmVycyBvciBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgbnVtYmVycyB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3Mgc2tldyBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbn0gZmFBYm91dE9yaWdpbiAgLSAgQXJyYXkgb2YgYXJndW1lbnRzIChvciBhIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBhcmd1bWVudHMpIHRvIHBhc3MgdG8gVHJhbnNmb3JtLmFib3V0T3JpZ2luCiAqIEBwYXJhbSB7TnVtYmVyfEZ1bmN0aW9ufSBmYVBlcnNwZWN0aXZlICAtICBOdW1iZXIgb3IgYXJyYXkgcmV0dXJuaW5nIGEgbnVtYmVyIHRvIHdoaWNoIHRoaXMgbW9kaWZpZXIncyBwZXJzcGVjdGl2ZSAoZm9jdXNaKSBzaG91bGQgYmUgYm91bmQuCiAqIEBwYXJhbSB7VHJhbnNmb3JtfSBmYVRyYW5zZm9ybSAtIE1hbnVhbGx5IGNyZWF0ZWQgRmFtby51cyBUcmFuc2Zvcm0gb2JqZWN0IChhbiBhcnJheSkgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIHRoZSBtb2RpZmllci4gICpXaWxsIG92ZXJyaWRlIGFsbCBvdGhlciB0cmFuc2Zvcm0gYXR0cmlidXRlcy4qCiAqIEBwYXJhbSB7TnVtYmVyfEZ1bmN0aW9ufFRyYW5zaXRpb25hYmxlfSBmYU9wYWNpdHkgIC0gIE51bWJlciBvciBmdW5jdGlvbiByZXR1cm5pbmcgYSBudW1iZXIgdG8gd2hpY2ggdGhpcyBNb2RpZmllcidzIG9wYWNpdHkgc2hvdWxkIGJlIGJvdW5kCiAqIEBwYXJhbSB7QXJyYXl8RnVuY3Rpb258VHJhbnNpdGlvbmFibGV9IGZhU2l6ZSAgLSAgQXJyYXkgb2YgbnVtYmVycyAoZS5nLiBbMTAwLCA1MDBdIGZvciB0aGUgeC0gYW5kIHktc2l6ZXMpIG9yIGZ1bmN0aW9uIHJldHVybmluZyBhbiBhcnJheSBvZiBudW1iZXJzIHRvIHdoaWNoIHRoaXMgTW9kaWZpZXIncyBzaXplIHNob3VsZCBiZSBib3VuZAogKiBAcGFyYW0ge0FycmF5fEZ1bmN0aW9ufFRyYW5zaXRpb25hYmxlfSBmYU9yaWdpbiAgLSAgQXJyYXkgb2YgbnVtYmVycyAoZS5nLiBbLjUsIDBdIGZvciB0aGUgeC0gYW5kIHktb3JpZ2lucykgb3IgZnVuY3Rpb24gcmV0dXJuaW5nIGFuIGFycmF5IG9mIG51bWJlcnMgdG8gd2hpY2ggdGhpcyBNb2RpZmllcidzIG9yaWdpbiBzaG91bGQgYmUgYm91bmQKICogQHBhcmFtIHtBcnJheXxGdW5jdGlvbnxUcmFuc2l0aW9uYWJsZX0gZmFBbGlnbiAgLSAgQXJyYXkgb2YgbnVtYmVycyAoZS5nLiBbLjUsIDBdIGZvciB0aGUgeC0gYW5kIHktYWxpZ25zKSBvciBmdW5jdGlvbiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgbnVtYmVycyB0byB3aGljaCB0aGlzIE1vZGlmaWVyJ3MgYWxpZ24gc2hvdWxkIGJlIGJvdW5kCiAqIEBwYXJhbSB7QXJyYXkuU3RyaW5nfSBmYVRyYW5zZm9ybU9yZGVyICAtICBPcHRpb25hbCBhcnJheSBvZiBzdHJpbmdzIHRvIHNwZWNpZnkgd2hpY2ggdHJhbnNmb3JtcyB0byBhcHBseSBhbmQgaW4gd2hpY2ggb3JkZXIuIChlLmcuIGBmYS10cmFuc2Zvcm0tb3JkZXI9Ilsncm90YXRlWicsICd0cmFuc2xhdGUnLCAnc2NhbGUnXSJgKSAgRGVmYXVsdCBiZWhhdmlvciBpcyB0byBldmFsdWF0ZSBhbGwgc3VwcG9ydGVkIHRyYW5zZm9ybXMgYW5kIGFwcGx5IHRoZW0gaW4gYWxwaGFiZXRpY2FsIG9yZGVyLgogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgY3JlYXRlcyBhIEZhbW8udXMgTW9kaWZpZXIgdGhhdCB3aWxsIGFmZmVjdCBhbGwgY2hpbGRyZW4gcmVuZGVyIG5vZGVzLiAgSXRzIHByb3BlcnRpZXMgY2FuIGJlIGJvdW5kCiAqIHRvIHZhbHVlcyAoZS5nLiBgZmEtdHJhbnNsYXRlPSJbMTUsIDIwLCAxXSJgLCBGYW1vLnVzIFRyYW5zaXRpb25hYmxlIG9iamVjdHMsIG9yIHRvIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBudW1iZXJzLgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtbW9kaWZpZXIgZmEtb3BhY2l0eT0iLjI1IiBmYS1za2V3PSJteVNjb3BlU2tld1ZhcmlhYmxlIiBmYS10cmFuc2xhdGU9IlsyNSwgNTAsIDJdIiBmYS1zY2FsZT0ibXlTY29wZUZ1bmN0aW9uVGhhdFJldHVybnNBbkFycmF5Ij4KICogICA8IS0tIENoaWxkIGVsZW1lbnRzIG9mIHRoaXMgZmEtbW9kaWZpZXIgd2lsbCBiZSBhZmZlY3RlZCBieSB0aGUgdmFsdWVzIGFib3ZlIC0tPgogKiAgIDxmYS1zdXJmYWNlPkknbSB0cmFuc2x1Y2VudCwgc2tld2VkLCByb3RhdGVkLCBhbmQgdHJhbnNsYXRlZDwvZmEtc3VyZmFjZT4KICogPC9mYS1tb2RpZmllcj4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYU1vZGlmaWVyJywgWyIkZmFtb3VzIiwgIiRmYW1vdXNEZWNvcmF0b3IiLCAiJHBhcnNlIiwgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IsICRwYXJzZSkgewogICAgcmV0dXJuIHsKICAgICAgdGVtcGxhdGU6ICc8ZGl2PjwvZGl2PicsCiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsCiAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICBwcmlvcml0eTogMiwKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICB2YXIgUmVuZGVyTm9kZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1JlbmRlck5vZGUnXQogICAgICAgICAgICB2YXIgTW9kaWZpZXIgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9Nb2RpZmllciddCiAgICAgICAgICAgIHZhciBUcmFuc2Zvcm0gPSAkZmFtb3VzWydmYW1vdXMvY29yZS9UcmFuc2Zvcm0nXQoKICAgICAgICAgICAgdmFyIGdldCA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICBpZiAoeCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSByZXR1cm4geCgpOwogICAgICAgICAgICAgIHJldHVybiB4LmdldCA/IHguZ2V0KCkgOiB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy9UT0RPOiAgbWFrZSBhIHN0YW5kLWFsb25lIHdpbmRvdy1sZXZlbCB1dGlsaXR5CiAgICAgICAgICAgIC8vICAgICAgIG9iamVjdCB0byBzdG9yZSBzdHVmZiBsaWtlIHRoaXMKICAgICAgICAgICAgLyogQ29waWVkIGZyb20gYW5ndWxhci5qcyAqLwogICAgICAgICAgICB2YXIgU1BFQ0lBTF9DSEFSU19SRUdFWFAgPSAvKFtcOlwtXF9dKyguKSkvZzsKICAgICAgICAgICAgdmFyIE1PWl9IQUNLX1JFR0VYUCA9IC9ebW96KFtBLVpdKS87CiAgICAgICAgICAgIGZ1bmN0aW9uIGNhbWVsQ2FzZShuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5hbWUuCiAgICAgICAgICAgICAgICByZXBsYWNlKFNQRUNJQUxfQ0hBUlNfUkVHRVhQLCBmdW5jdGlvbihfLCBzZXBhcmF0b3IsIGxldHRlciwgb2Zmc2V0KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBvZmZzZXQgPyBsZXR0ZXIudG9VcHBlckNhc2UoKSA6IGxldHRlcjsKICAgICAgICAgICAgICAgIH0pLgogICAgICAgICAgICAgICAgcmVwbGFjZShNT1pfSEFDS19SRUdFWFAsICdNb3okMScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBQUkVGSVhfUkVHRVhQID0gL14oeFtcOlwtX118ZGF0YVtcOlwtX10pL2k7CiAgICAgICAgICAgIGZ1bmN0aW9uIGRpcmVjdGl2ZU5vcm1hbGl6ZShuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbWVsQ2FzZShuYW1lLnJlcGxhY2UoUFJFRklYX1JFR0VYUCwgJycpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvKiBlbmQgY29weSBmcm9tIGFuZ3VsYXIuanMgKi8KCiAgICAgICAgICAgIHZhciBfdHJhbnNmb3JtRmllbGRzID0gWwogICAgICAgICAgICAgICJhYm91dE9yaWdpbiIsCiAgICAgICAgICAgICAgInBlcnNwZWN0aXZlIiwKICAgICAgICAgICAgICAicm90YXRlIiwKICAgICAgICAgICAgICAicm90YXRlQXhpcyIsCiAgICAgICAgICAgICAgInJvdGF0ZVgiLAogICAgICAgICAgICAgICJyb3RhdGVZIiwKICAgICAgICAgICAgICAicm90YXRlWiIsCiAgICAgICAgICAgICAgInNjYWxlIiwKICAgICAgICAgICAgICAic2tldyIsCiAgICAgICAgICAgICAgInRyYW5zbGF0ZSIKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYVRyYW5zZm9ybU9yZGVyJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgY2FuZGlkYXRlID0gc2NvcGUuJGV2YWwoYXR0cnMuZmFUcmFuc2Zvcm1PcmRlcik7CiAgICAgICAgICAgICAgaWYoY2FuZGlkYXRlICE9PSB1bmRlZmluZWQpIF90cmFuc2Zvcm1GaWVsZHMgPSBjYW5kaWRhdGU7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgdmFyIF9wYXJzZWRUcmFuc2Zvcm1zID0ge307CiAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfdHJhbnNmb3JtRmllbGRzLCBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgICAgICAgdmFyIGF0dHJOYW1lID0gZGlyZWN0aXZlTm9ybWFsaXplKCdmYS0nICsgZmllbGQpOwogICAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKGF0dHJOYW1lLCBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgX3BhcnNlZFRyYW5zZm9ybXNbZmllbGRdID0gJHBhcnNlKGF0dHJzW2F0dHJOYW1lXSk7CiAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSkKCgogICAgICAgICAgICB2YXIgX3RyYW5zZm9ybUZuID0gYW5ndWxhci5ub29wOwogICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZSgnZmFUcmFuc2Zvcm0nLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIF90cmFuc2Zvcm1GbiA9ICRwYXJzZShhdHRycy5mYVRyYW5zZm9ybSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpc29sYXRlLmdldFRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIC8vaWYgZmFUcmFuc2Zvcm0gaXMgcHJvdmlkZWQsIHJldHVybiBpdAogICAgICAgICAgICAgIC8vaW5zdGVhZCBvZiBsb29waW5nIHRocm91Z2ggdGhlIG90aGVyIHRyYW5zZm9ybXMuCiAgICAgICAgICAgICAgdmFyIG92ZXJyaWRlID0gX3RyYW5zZm9ybUZuKHNjb3BlKTsKICAgICAgICAgICAgICBpZihvdmVycmlkZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgIGlmKG92ZXJyaWRlIGluc3RhbmNlb2YgRnVuY3Rpb24pIHJldHVybiBvdmVycmlkZSgpOwogICAgICAgICAgICAgICAgZWxzZSBpZihvdmVycmlkZSBpbnN0YW5jZW9mIE9iamVjdCAmJiBvdmVycmlkZS5nZXQgIT09IHVuZGVmaW5lZCkgcmV0dXJuIG92ZXJyaWRlLmdldCgpOwogICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gb3ZlcnJpZGU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtcyA9IFtdOwogICAgICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChfdHJhbnNmb3JtRmllbGRzLCBmdW5jdGlvbihmaWVsZCl7CiAgICAgICAgICAgICAgICB2YXIgY2FuZGlkYXRlID0gX3BhcnNlZFRyYW5zZm9ybXNbZmllbGRdID8gX3BhcnNlZFRyYW5zZm9ybXNbZmllbGRdKHNjb3BlKSA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGlmKGNhbmRpZGF0ZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgaWYoY2FuZGlkYXRlIGluc3RhbmNlb2YgRnVuY3Rpb24pIHRyYW5zZm9ybXMucHVzaChjYW5kaWRhdGUoKSkKICAgICAgICAgICAgICAgICAgZWxzZSBpZihjYW5kaWRhdGUgaW5zdGFuY2VvZiBBcnJheSkgdHJhbnNmb3Jtcy5wdXNoKFRyYW5zZm9ybVtmaWVsZF0uYXBwbHkodGhpcywgY2FuZGlkYXRlKSkKICAgICAgICAgICAgICAgICAgZWxzZSB0cmFuc2Zvcm1zLnB1c2goVHJhbnNmb3JtW2ZpZWxkXS5jYWxsKHRoaXMsIGNhbmRpZGF0ZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICBpZighdHJhbnNmb3Jtcy5sZW5ndGgpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgZWxzZSBpZiAodHJhbnNmb3Jtcy5sZW5ndGggPT09IDEpIHJldHVybiB0cmFuc2Zvcm1zWzBdCiAgICAgICAgICAgICAgZWxzZSByZXR1cm4gVHJhbnNmb3JtLm11bHRpcGx5LmFwcGx5KHRoaXMsIHRyYW5zZm9ybXMpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdmFyIF9hbGlnbkZuID0gYW5ndWxhci5ub29wOwogICAgICAgICAgICBhdHRycy4kb2JzZXJ2ZSgnZmFBbGlnbicsIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgX2FsaWduRm4gPSAkcGFyc2UoYXR0cnMuZmFBbGlnbik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpc29sYXRlLmdldEFsaWduID0gZnVuY3Rpb24oKXsKICAgICAgICAgICAgICB2YXIgcmV0ID0gX2FsaWduRm4oc2NvcGUpOwogICAgICAgICAgICAgIGlmKHJldCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSByZXR1cm4gcmV0KCk7CiAgICAgICAgICAgICAgZWxzZSBpZihyZXQgaW5zdGFuY2VvZiBPYmplY3QgJiYgcmV0LmdldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcmV0LmdldCgpOwogICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF9vcGFjaXR5Rm4gPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYU9wYWNpdHknLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIF9vcGFjaXR5Rm4gPSAkcGFyc2UoYXR0cnMuZmFPcGFjaXR5KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlzb2xhdGUuZ2V0T3BhY2l0eSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIHJldCA9IF9vcGFjaXR5Rm4oc2NvcGUpOwogICAgICAgICAgICAgIGlmKHJldCA9PT0gdW5kZWZpbmVkKSByZXR1cm4gMTsKICAgICAgICAgICAgICBlbHNlIGlmKHJldCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSByZXR1cm4gcmV0KCk7CiAgICAgICAgICAgICAgZWxzZSBpZihyZXQgaW5zdGFuY2VvZiBPYmplY3QgJiYgcmV0LmdldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcmV0LmdldCgpOwogICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF9zaXplRm4gPSBhbmd1bGFyLm5vb3A7CiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYVNpemUnLCBmdW5jdGlvbigpewogICAgICAgICAgICAgIF9zaXplRm4gPSAkcGFyc2UoYXR0cnMuZmFTaXplKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlzb2xhdGUuZ2V0U2l6ZSA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIHJldCA9IF9zaXplRm4oc2NvcGUpOwogICAgICAgICAgICAgIGlmKHJldCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSByZXR1cm4gcmV0KCk7CiAgICAgICAgICAgICAgZWxzZSBpZihyZXQgaW5zdGFuY2VvZiBPYmplY3QgJiYgcmV0LmdldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcmV0LmdldCgpOwogICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIF9vcmlnaW5GbiA9IGFuZ3VsYXIubm9vcDsKICAgICAgICAgICAgYXR0cnMuJG9ic2VydmUoJ2ZhT3JpZ2luJywgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICBfb3JpZ2luRm4gPSAkcGFyc2UoYXR0cnMuZmFPcmlnaW4pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaXNvbGF0ZS5nZXRPcmlnaW4gPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciByZXQgPSBfb3JpZ2luRm4oc2NvcGUpOwogICAgICAgICAgICAgIGlmKHJldCBpbnN0YW5jZW9mIEZ1bmN0aW9uKSByZXR1cm4gcmV0KCk7CiAgICAgICAgICAgICAgZWxzZSBpZihyZXQgaW5zdGFuY2VvZiBPYmplY3QgJiYgcmV0LmdldCAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcmV0LmdldCgpOwogICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaXNvbGF0ZS5tb2RpZmllciA9IG5ldyBNb2RpZmllcih7CiAgICAgICAgICAgICAgdHJhbnNmb3JtOiBpc29sYXRlLmdldFRyYW5zZm9ybSwKICAgICAgICAgICAgICBzaXplOiBpc29sYXRlLmdldFNpemUsCiAgICAgICAgICAgICAgb3BhY2l0eTogaXNvbGF0ZS5nZXRPcGFjaXR5LAogICAgICAgICAgICAgIG9yaWdpbjogaXNvbGF0ZS5nZXRPcmlnaW4sCiAgICAgICAgICAgICAgYWxpZ246IGlzb2xhdGUuZ2V0QWxpZ24KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUgPSBuZXcgUmVuZGVyTm9kZSgpLmFkZChpc29sYXRlLm1vZGlmaWVyKQoKICAgICAgICAgICAgc2NvcGUuJG9uKCckZGVzdHJveScsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlzb2xhdGUubW9kaWZpZXIuc2V0T3BhY2l0eSgwKTsKICAgICAgICAgICAgICBzY29wZS4kZW1pdCgndW5yZWdpc3RlckNoaWxkJywge2lkOiBzY29wZS4kaWR9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBzY29wZS4kb24oJ3JlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT09IGV2dC5jdXJyZW50U2NvcGUuJGlkKXsKICAgICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5hZGQoZGF0YS5yZW5kZXJOb2RlKTsKICAgICAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgICB0cmFuc2NsdWRlKHNjb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnZGl2JykuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kZW1pdCgncmVnaXN0ZXJDaGlsZCcsIGlzb2xhdGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVBpcGVGcm9tCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEEKICogQHByaW9yaXR5IDE2CiAqIEBwYXJhbSB7T2JqZWN0fSBFdmVudEhhbmRsZXIgLSB0YXJnZXQgaGFuZGxlciBvYmplY3QKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIHJlbW92ZSBhbiBoYW5kbGVyIG9iamVjdCBmcm9tIHNldCBvZiBkb3duc3RyZWFtIGhhbmRsZXJzLiBVbmRvZXMgd29yayBvZiAicGlwZSIKICogZnJvbSBhIGZhUGlwZVRvIGRpcmVjdGl2ZS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS1waXBlLWZyb209IkV2ZW50SGFuZGxlciI+CiAqICAgPCEtLSB6ZXJvIG9yIG1vcmUgcmVuZGVyIG5vZGVzIC0tPgogKiA8L0FOWT4KICogYGBgCiAqLwoKLy9VTlRFU1RFRCBhcyBvZiAyMDE0LTA1LTEzCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFQaXBlRnJvbScsIFsnJGZhbW91cycsICckZmFtb3VzRGVjb3JhdG9yJywgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHJlc3RyaWN0OiAnQScsCiAgICAgIHNjb3BlOiBmYWxzZSwKICAgICAgcHJpb3JpdHk6IDE2LAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgRW5naW5lID0gJGZhbW91c1snZmFtb3VzL2NvcmUvRW5naW5lJ107CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwogICAgICAgICAgICBzY29wZS4kd2F0Y2goCiAgICAgICAgICAgICAgZnVuY3Rpb24oKXsKICAgICAgICAgICAgICAgIHJldHVybiBzY29wZS4kZXZhbChhdHRycy5mYVBpcGVGcm9tKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKG5ld1RhcmdldCwgb2xkVGFyZ2V0KXsKICAgICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBpc29sYXRlLnJlbmRlck5vZGUgfHwgRW5naW5lOwogICAgICAgICAgICAgICAgaWYob2xkVGFyZ2V0IGluc3RhbmNlb2YgQXJyYXkpewogICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2xkVGFyZ2V0Lmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBvbGRUYXJnZXRbaV0udW5waXBlKHNvdXJjZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKG9sZFRhcmdldCAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgb2xkVGFyZ2V0LnVucGlwZShzb3VyY2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKG5ld1RhcmdldCBpbnN0YW5jZW9mIEFycmF5KXsKICAgICAgICAgICAgICAgICAgZm9yKHZhciBpID0gMDsgaSA8IG5ld1RhcmdldC5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgbmV3VGFyZ2V0W2ldLnBpcGUoc291cmNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2UgaWYobmV3VGFyZ2V0ICE9PSB1bmRlZmluZWQpewogICAgICAgICAgICAgICAgICBuZXdUYXJnZXQucGlwZShzb3VyY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFQaXBlVG8KICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAcGFyYW0ge09iamVjdH0gRXZlbnRIYW5kbGVyIC0gRXZlbnQgaGFuZGxlciB0YXJnZXQgb2JqZWN0CiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhZGQgYW4gZXZlbnQgaGFuZGxlciBvYmplY3QgdG8gc2V0IG9mIGRvd25zdHJlYW0gaGFuZGxlcnMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxBTlkgZmEtcGlwZS10bz0iZXZlbnRIYW5kbGVyIj4KICogICA8IS0tIHplcm8gb3IgbW9yZSByZW5kZXIgbm9kZXMgLS0+CiAqIDwvQU5ZPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhUGlwZVRvJywgWyckZmFtb3VzJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgc2NvcGU6IGZhbHNlLAogICAgICBwcmlvcml0eTogMTYsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBFbmdpbmUgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FbmdpbmUnXTsKICAgICAgICAKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcmV0dXJuIHNjb3BlLiRldmFsKGF0dHJzLmZhUGlwZVRvKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bmN0aW9uKG5ld1BpcGUsIG9sZFBpcGUpewogICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGlzb2xhdGUucmVuZGVyTm9kZSB8fCBFbmdpbmU7CiAgICAgICAgICAgICAgICBpZihvbGRQaXBlIGluc3RhbmNlb2YgQXJyYXkpewogICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgb2xkUGlwZS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnVucGlwZShvbGRQaXBlW2ldKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfWVsc2UgaWYob2xkUGlwZSAhPT0gdW5kZWZpbmVkKXsKICAgICAgICAgICAgICAgICAgdGFyZ2V0LnVucGlwZShvbGRQaXBlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZihuZXdQaXBlIGluc3RhbmNlb2YgQXJyYXkpewogICAgICAgICAgICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgbmV3UGlwZS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBpcGUobmV3UGlwZVtpXSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH1lbHNlIGlmKG5ld1BpcGUgIT09IHVuZGVmaW5lZCl7CiAgICAgICAgICAgICAgICAgIHRhcmdldC5waXBlKG5ld1BpcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFSZW5kZXJOb2RlCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBBIGRpcmVjdGl2ZSB0byBpbnNlcnQgYSB7QGxpbmsgaHR0cHM6Ly9mYW1vLnVzL2RvY3MvMC4xLjEvY29yZS9SZW5kZXJOb2RlLyBGYW1vLnVzIFJlbmRlck5vZGV9IHRoYXQgaXMKICogYSB3cmFwcGVyIGZvciBpbnNlcnRpbmcgYSByZW5kZXJhYmxlIGNvbXBvbmVudCAobGlrZSBhIE1vZGlmZXIgb3IgU3VyZmFjZSkgaW50byB0aGUgcmVuZGVyIHRyZWUuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1yZW5kZXItbm9kZT4KICogICAgIDwhLS0gY29udGVudCAtLT4KICogPC9mYS1yZW5kZXItbm9kZT4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYVJlbmRlck5vZGUnLCBbIiRmYW1vdXMiLCAiJGZhbW91c0RlY29yYXRvciIsIGZ1bmN0aW9uICgkZmFtb3VzLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+JywKICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbWVudCwgdEF0dHJzLCB0cmFuc2NsdWRlKXsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgRW5naW5lID0gJGZhbW91c1snZmFtb3VzL2NvcmUvRW5naW5lJ107CgogICAgICAgICAgICB2YXIgZ2V0T3JWYWx1ZSA9IGZ1bmN0aW9uKHgpIHsKICAgICAgICAgICAgICByZXR1cm4geC5nZXQgPyB4LmdldCgpIDogeDsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlzb2xhdGUuY2hpbGRyZW4gPSBbXTsKCiAgICAgICAgICAgIGF0dHJzLiRvYnNlcnZlKCdmYVBpcGVUbycsIGZ1bmN0aW9uKHZhbCl7CiAgICAgICAgICAgICAgdmFyIHBpcGVUbyA9IHNjb3BlLiRldmFsKHZhbCk7CiAgICAgICAgICAgICAgaWYocGlwZVRvKQogICAgICAgICAgICAgICAgRW5naW5lLnBpcGUocGlwZVRvKTsKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IHNjb3BlLiRldmFsKGF0dHJzLmZhTm9kZSk7CgogICAgICAgICAgICBzY29wZS4kb24oJyRkZXN0cm95JywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgc2NvcGUuJGVtaXQoJ3VucmVnaXN0ZXJDaGlsZCcsIHtpZDogc2NvcGUuJGlkfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJG9uKCdyZWdpc3RlckNoaWxkJywgZnVuY3Rpb24oZXZ0LCBkYXRhKXsKICAgICAgICAgICAgICBpZihldnQudGFyZ2V0U2NvcGUuJGlkICE9IHNjb3BlLiRpZCl7CiAgICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuYWRkKGRhdGEucmVuZGVyTm9kZSk7CiAgICAgICAgICAgICAgICBpc29sYXRlLmNoaWxkcmVuLnB1c2goZGF0YSk7CiAgICAgICAgICAgICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KQoKICAgICAgICAgIH0sCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2NsdWRlKHNjb3BlLCBmdW5jdGlvbihjbG9uZSkgewogICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnZGl2JykuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kZW1pdCgncmVnaXN0ZXJDaGlsZCcsIGlzb2xhdGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVNjcm9sbFZpZXcKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgRQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGEge0BsaW5rIGh0dHBzOi8vZmFtby51cy9kb2NzLzAuMS4xL3ZpZXdzL1Njcm9sbHZpZXcvIGZhbW8udXMgU2Nyb2xsdmlld30KICogdGhhdCB3aWxsIGxheSBvdXQgYSBjb2xsZWN0aW9uIG9mIHJlbmRlcmFibGVzIHNlcXVlbnRpYWxseSBpbiB0aGUgc3BlY2lmaWVkIGRpcmVjdGlvbgogKiBhbmQgd2lsbCBhbGxvdyB5b3UgdG8gc2Nyb2xsIHRocm91Z2ggdGhlbSB3aXRoIG1vdXNld2hlZWwgb3IgdG91Y2ggZXZlbnRzLgogKgogKiBAdXNhZ2UKICogYGBgaHRtbAogKiA8ZmEtc2Nyb2xsLXZpZXc+CiAqICAgPGZhLXZpZXc+CiAqICAgICA8IS0tIGNvbnRlbnQgLS0+CiAqICAgPC9mYS12aWV3PgogKiA8L2ZhLXNjcm9sbC12aWV3PgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhU2Nyb2xsVmlldycsIFsnJGZhbW91cycsICckZmFtb3VzRGVjb3JhdG9yJywgJyR0aW1lb3V0JywgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IsICR0aW1lb3V0KSB7CiAgICByZXR1cm4gewogICAgICB0ZW1wbGF0ZTogJzxkaXY+PC9kaXY+JywKICAgICAgcmVzdHJpY3Q6ICdFJywKICAgICAgdHJhbnNjbHVkZTogdHJ1ZSwKICAgICAgc2NvcGU6IHRydWUsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtLCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHJldHVybiAgewogICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICB2YXIgU2Nyb2xsVmlldyA9ICRmYW1vdXNbImZhbW91cy92aWV3cy9TY3JvbGx2aWV3Il07CiAgICAgICAgICAgIHZhciBWaWV3U2VxdWVuY2UgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9WaWV3U2VxdWVuY2UnXTsKICAgICAgICAgICAgdmFyIFN1cmZhY2UgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9TdXJmYWNlJ107CgogICAgICAgICAgICB2YXIgX2NoaWxkcmVuID0gW107CgogICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHNjb3BlLiRldmFsKGF0dHJzLmZhT3B0aW9ucykgfHwge307CiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IG5ldyBTY3JvbGxWaWV3KG9wdGlvbnMpOwoKICAgICAgICAgICAgdmFyIHVwZGF0ZVNjcm9sbHZpZXcgPSBmdW5jdGlvbihpbml0KXsKICAgICAgICAgICAgICAvLyR0aW1lb3V0IGhhY2sgdXNlZCBoZXJlIGJlY2F1c2UgdGhlCiAgICAgICAgICAgICAgLy91cGRhdGVTY3JvbGx2aWV3IGZ1bmN0aW9uIHdpbGwgZ2V0IGNhbGxlZAogICAgICAgICAgICAgIC8vYmVmb3JlIHRoZSAkaW5kZXggdmFsdWVzIGdldCByZS1ib3VuZAogICAgICAgICAgICAgIC8vdGhyb3VnaCBuZy1yZXBlYXQuICBUaGUgcmVzdWx0IGlzIHRoYXQKICAgICAgICAgICAgICAvL3RoZSBpdGVtcyBnZXQgc29ydGVkIGhlcmUsIHRoZW4gdGhlIGluZGV4ZXMKICAgICAgICAgICAgICAvL2dldCByZS1ib3VuZCwgYW5kIHRodXMgdGhlIHJlc3VsdHMgYXJlIGluY29ycmVjdGx5CiAgICAgICAgICAgICAgLy9vcmRlcmVkLgogICAgICAgICAgICAgICR0aW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICBfY2hpbGRyZW4uc29ydChmdW5jdGlvbihhLCBiKXsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGEuaW5kZXggLSBiLmluZGV4OwogICAgICAgICAgICAgICAgfSk7IAoKICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0gewogICAgICAgICAgICAgICAgICBhcnJheTogZnVuY3Rpb24oX2NoaWxkcmVuKSB7CgkgICAgICAgICAgICAgICAgICB2YXIgX2NoID0gW107CgkgICAgICAgICAgICAgICAgICBhbmd1bGFyLmZvckVhY2goX2NoaWxkcmVuLCBmdW5jdGlvbihjLCBpKSB7CgkJICAgICAgICAgICAgICAgICAgX2NoW2ldID0gYy5yZW5kZXJOb2RlOwoJICAgICAgICAgICAgICAgICAgfSkKCSAgICAgICAgICAgICAgICAgIHJldHVybiBfY2g7CiAgICAgICAgICAgICAgICAgIH0oX2NoaWxkcmVuKQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIC8vc2V0IHRoZSBmaXJzdCBwYWdlIG9uIHRoZSBzY3JvbGx2aWV3IGlmCiAgICAgICAgICAgICAgICAvL3NwZWNpZmllZAogICAgICAgICAgICAgICAgaWYoaW5pdCkKICAgICAgICAgICAgICAgICAgb3B0aW9ucy5pbmRleCA9IHNjb3BlLiRldmFsKGF0dHJzLmZhU3RhcnRJbmRleCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciB2aWV3U2VxID0gbmV3IFZpZXdTZXF1ZW5jZShvcHRpb25zKTsKICAgICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXF1ZW5jZUZyb20odmlld1NlcSk7CgogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNjb3BlLiRvbigncmVnaXN0ZXJDaGlsZCcsIGZ1bmN0aW9uKGV2dCwgZGF0YSl7CiAgICAgICAgICAgICAgaWYoZXZ0LnRhcmdldFNjb3BlLiRpZCAhPSBzY29wZS4kaWQpewogICAgICAgICAgICAgICAgX2NoaWxkcmVuLnB1c2goZGF0YSk7CiAgICAgICAgICAgICAgICB1cGRhdGVTY3JvbGx2aWV3KHRydWUpOwogICAgICAgICAgICAgICAgZXZ0LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc2NvcGUuJG9uKCd1bnJlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT0gc2NvcGUuJGlkKXsKCgkgICAgICAgICAgICBfY2hpbGRyZW4gPSBmdW5jdGlvbihfY2hpbGRyZW4pIHsKCQkgICAgICAgICAgdmFyIF9jaCA9IFtdOwoJCSAgICAgICAgICBhbmd1bGFyLmZvckVhY2goX2NoaWxkcmVuLCBmdW5jdGlvbihjKSB7CgkJCSAgICAgICAgaWYoYy5pZCAhPT0gZGF0YS5pZCkgewoJCQkJICAgICAgX2NoLnB1c2goYyk7CgkJCSAgICAgICAgfQoJCSAgICAgICAgICB9KTsKCQkgICAgICAgICAgcmV0dXJuIF9jaDsKCSAgICAgICAgICAgIH0oX2NoaWxkcmVuKTsKICAgICAgICAgICAgICAgIHVwZGF0ZVNjcm9sbHZpZXcoKTsKICAgICAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCdkaXYnKS5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CgogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFTdXJmYWNlCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIGNyZWF0ZSBnZW5lcmFsIEZhbW8udXMgc3VyZmFjZXMsIHdoaWNoIGFyZSB0aGUKICogbGVhZiBub2RlcyBvZiB0aGUgc2NlbmUgZ3JhcGguICBUaGUgY29udGVudCBpbnNpZGUKICogc3VyZmFjZXMgaXMgd2hhdCBnZXRzIHJlbmRlcmVkIHRvIHRoZSBzY3JlZW4uCiAqIFRoaXMgaXMgd2hlcmUgeW91IGNhbiBjcmVhdGUgZm9ybSBlbGVtZW50cywgYXR0YWNoCiAqIGltYWdlcywgb3Igb3V0cHV0IHJhdyB0ZXh0IGNvbnRlbnQgd2l0aCBvbmUtd2F5IGRhdGFiaW5kaW5nIHt7fX0uCiAqIFlvdSBjYW4gaW5jbHVkZSBlbnRpcmUgY29tcGxleCBIVE1MIHNuaXBwZXRzIGluc2lkZSBhIGZhU3VyZmFjZSwgaW5jbHVkaW5nCiAqIG5nSW5jbHVkZXMgb3IgY3VzdG9tICh2YW5pbGxhIEFuZ3VsYXIpIGRpcmVjdGl2ZXMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS1zdXJmYWNlPgogKiAgIEhlcmUncyBzb21lIGRhdGEtYm91bmQgY29udGVudCB7e215U2NvcGVWYXJpYWJsZX19CiAqIDwvZmEtc3VyZmFjZT4KICogYGBgCiAqLwoKYW5ndWxhci5tb2R1bGUoJ2ZhbW91cy5hbmd1bGFyJykKICAuZGlyZWN0aXZlKCdmYVN1cmZhY2UnLCBbJyRmYW1vdXMnLCAnJGZhbW91c0RlY29yYXRvcicsICckaW50ZXJwb2xhdGUnLCAnJGNvbnRyb2xsZXInLCAnJGNvbXBpbGUnLCBmdW5jdGlvbiAoJGZhbW91cywgJGZhbW91c0RlY29yYXRvciwgJGludGVycG9sYXRlLCAkY29udHJvbGxlciwgJGNvbXBpbGUpIHsKICAgIHJldHVybiB7CiAgICAgIHNjb3BlOiB0cnVlLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICB0ZW1wbGF0ZTogJzxkaXYgY2xhc3M9ImZhLXN1cmZhY2UiPjwvZGl2PicsCiAgICAgIHJlc3RyaWN0OiAnRUEnLAogICAgICBjb21waWxlOiBmdW5jdGlvbih0RWxlbSwgdEF0dHJzLCB0cmFuc2NsdWRlKXsKICAgICAgICByZXR1cm4gewogICAgICAgICAgcHJlOiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICB2YXIgU3VyZmFjZSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1N1cmZhY2UnXTsKICAgICAgICAgICAgdmFyIFRyYW5zZm9ybSA9ICRmYW1vdXNbJ2ZhbW91cy9jb3JlL1RyYW5zZm9ybSddCiAgICAgICAgICAgIHZhciBFdmVudEhhbmRsZXIgPSAkZmFtb3VzWydmYW1vdXMvY29yZS9FdmVudEhhbmRsZXInXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vdXBkYXRlIHByb3BlcnRpZXMKICAgICAgICAgICAgLy9UT0RPOiAgaXMgdGhpcyBnb2luZyB0byBiZSBhIGJvdHRsZW5lY2s/CiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgcmV0dXJuIGlzb2xhdGUuZ2V0UHJvcGVydGllcygpCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmdW5jdGlvbigpewogICAgICAgICAgICAgICAgaWYoaXNvbGF0ZS5yZW5kZXJOb2RlKQogICAgICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2V0UHJvcGVydGllcyhpc29sYXRlLmdldFByb3BlcnRpZXMoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICB0cnVlCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGlzb2xhdGUuZ2V0UHJvcGVydGllcyA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogc2NvcGUuJGV2YWwoYXR0cnMuZmFCYWNrZ3JvdW5kQ29sb3IpLAogICAgICAgICAgICAgICAgY29sb3I6IHNjb3BlLiRldmFsKGF0dHJzLmZhQ29sb3IpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZSA9IG5ldyBTdXJmYWNlKHsKICAgICAgICAgICAgICBzaXplOiBzY29wZS4kZXZhbChhdHRycy5mYVNpemUpLAogICAgICAgICAgICAgIGNsYXNzOiBzY29wZS4kZXZhbChhdHRycy5jbGFzcyksCiAgICAgICAgICAgICAgcHJvcGVydGllczogaXNvbGF0ZS5nZXRQcm9wZXJ0aWVzKCkKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAvL1RPRE86ICBzdXBwb3J0IG5nLWNsYXNzCiAgICAgICAgICAgIGlmKGF0dHJzLmNsYXNzKQogICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXRDbGFzc2VzKGF0dHJzWydjbGFzcyddLnNwbGl0KCcgJykpOwoKICAgICAgICAgIH0sCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICB2YXIgdXBkYXRlQ29udGVudCA9IGZ1bmN0aW9uKCl7Ci8vICAgICAgICAgICAgICB2YXIgY29tcGlsZWRFbCA9IGlzb2xhdGUuY29tcGlsZWRFbCA9IGlzb2xhdGUuY29tcGlsZWRFbCB8fCAkY29tcGlsZShlbGVtZW50LmZpbmQoJ2Rpdi5mYS1zdXJmYWNlJykuY29udGVudHMoKSkoc2NvcGUpCi8vICAgICAgICAgICAgICBpc29sYXRlLnJlbmRlck5vZGUuc2V0Q29udGVudChpc29sYXRlLmNvbXBpbGVkRWwuY29udGV4dCk7CgkgICAgICAgICAgICAvL1RPRE8gY2hlY2sgaWYgJGNvbXBpbGUgaXMgbmVlZGVkID8KCSAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5zZXRDb250ZW50KGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvcignZGl2LmZhLXN1cmZhY2UnKSk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB1cGRhdGVDb250ZW50KCk7CgogICAgICAgICAgICAvL2JvaWxlcnBsYXRlCiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgYW5ndWxhci5lbGVtZW50KGVsZW1lbnRbMF0ucXVlcnlTZWxlY3RvckFsbCgnZGl2LmZhLXN1cmZhY2UnKSkuYXBwZW5kKGNsb25lKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kZW1pdCgncmVnaXN0ZXJDaGlsZCcsIGlzb2xhdGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVRhcAogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBBCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZmFUYXAgRXhwcmVzc2lvbiB0byBldmFsdWF0ZSB1cG9uIHRhcC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIHdoZW4gYW4gZWxlbWVudCBpcyB0YXBwZWQuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxBTlkgZmEtdGFwPSJleHByZXNzaW9uIj4KICoKICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFUYXAnLCBbJyRwYXJzZScsICckZmFtb3VzRGVjb3JhdG9yJywgZnVuY3Rpb24gKCRwYXJzZSwgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgY29tcGlsZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICBwb3N0OiBmdW5jdGlvbihzY29wZSwgZWxlbWVudCwgYXR0cnMpIHsKICAgICAgICAgICAgdmFyIGlzb2xhdGUgPSAkZmFtb3VzRGVjb3JhdG9yLmVuc3VyZUlzb2xhdGUoc2NvcGUpOwoKICAgICAgICAgICAgaWYgKGF0dHJzLmZhVGFwKSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlck5vZGUgPSAoaXNvbGF0ZS5yZW5kZXJOb2RlLl9ldmVudElucHV0IHx8IGlzb2xhdGUucmVuZGVyTm9kZSkKCiAgICAgICAgICAgICAgdmFyIF9kcmFnZ2luZyA9IGZhbHNlOwoKICAgICAgICAgICAgICByZW5kZXJOb2RlLm9uKCJ0b3VjaG1vdmUiLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICBfZHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oInRvdWNoZW5kIiwgZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgaWYgKCFfZHJhZ2dpbmcpewogICAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cnMuZmFUYXApOwogICAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDpkYXRhfSk7CiAgICAgICAgICAgICAgICAgIGlmKCFzY29wZS4kJHBoYXNlKQogICAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX2RyYWdnaW5nID0gZmFsc2UKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9XSk7CgovKioKICogQG5nZG9jIGRpcmVjdGl2ZQogKiBAbmFtZSBmYVRvdWNoZW5kCiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEEKICogQHBhcmFtIHtleHByZXNzaW9ufSBmYVRvdWNoZW5kIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgdXBvbiB0b3VjaGVuZC4gKEV2ZW50IG9iamVjdCBpcyBhdmFpbGFibGUgYXMgYCRldmVudGApCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBhbGxvd3MgeW91IHRvIHNwZWNpZnkgY3VzdG9tIGJlaGF2aW9yIGFmdGVyIGFuIGVsZW1lbnQgdGhhdCB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvUmVmZXJlbmNlL0V2ZW50cy90b3VjaGVuZCBoYXMgYmVlbiB0b3VjaGVkfS4KICoKICogQHVzYWdlCiAqIGBgYGh0bWwKICogPEFOWSBmYS10b3VjaGVuZD0iZXhwcmVzc2lvbiI+CiAqCiAqIDwvQU5ZPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhVG91Y2hlbmQnLCBbJyRwYXJzZScsICckZmFtb3VzRGVjb3JhdG9yJywgZnVuY3Rpb24gKCRwYXJzZSwgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgc2NvcGU6IGZhbHNlLAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICBpZiAoYXR0cnMuZmFUb3VjaEVuZCkgewogICAgICAgICAgICAgIHZhciByZW5kZXJOb2RlID0gKGlzb2xhdGUucmVuZGVyTm9kZS5fZXZlbnRJbnB1dCB8fCBpc29sYXRlLnJlbmRlck5vZGUpCgogICAgICAgICAgICAgIHJlbmRlck5vZGUub24oInRvdWNoZW5kIiwgZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJzLmZhVG91Y2hNb3ZlKTsKICAgICAgICAgICAgICAgIGZuKHNjb3BlLCB7JGV2ZW50OmRhdGF9KTsKICAgICAgICAgICAgICAgIGlmKCFzY29wZS4kJHBoYXNlKQogICAgICAgICAgICAgICAgICBzY29wZS4kYXBwbHkoKTsKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFUb3VjaG1vdmUKICogQG1vZHVsZSBmYW1vdXMuYW5ndWxhcgogKiBAcmVzdHJpY3QgQQogKiBAcGFyYW0ge2V4cHJlc3Npb259IGZhVG91Y2htb3ZlIEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgdXBvbiB0b3VjaG1vdmUuIChFdmVudCBvYmplY3QgaXMgYXZhaWxhYmxlIGFzIGAkZXZlbnRgKQogKiBAZGVzY3JpcHRpb24KICogVGhpcyBkaXJlY3RpdmUgYWxsb3dzIHlvdSB0byBzcGVjaWZ5IGN1c3RvbSBiZWhhdmlvciB3aGVuIGFuIGVsZW1lbnQgaXMge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL1JlZmVyZW5jZS9FdmVudHMvdG91Y2htb3ZlIG1vdmVkIGFsb25nIGEgdG91Y2ggc3VyZmFjZX0uCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxBTlkgZmEtdG91Y2htb3ZlPSJleHByZXNzaW9uIj4KICoKICogPC9BTlk+CiAqIGBgYAogKi8KCmFuZ3VsYXIubW9kdWxlKCdmYW1vdXMuYW5ndWxhcicpCiAgLmRpcmVjdGl2ZSgnZmFUb3VjaG1vdmUnLCBbJyRwYXJzZScsICckZmFtb3VzRGVjb3JhdG9yJywgZnVuY3Rpb24gKCRwYXJzZSwgJGZhbW91c0RlY29yYXRvcikgewogICAgcmV0dXJuIHsKICAgICAgcmVzdHJpY3Q6ICdBJywKICAgICAgc2NvcGU6IGZhbHNlLAogICAgICBjb21waWxlOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycykgewogICAgICAgICAgICB2YXIgaXNvbGF0ZSA9ICRmYW1vdXNEZWNvcmF0b3IuZW5zdXJlSXNvbGF0ZShzY29wZSk7CgogICAgICAgICAgICBpZiAoYXR0cnMuZmFUb3VjaE1vdmUpIHsKICAgICAgICAgICAgICB2YXIgcmVuZGVyTm9kZSA9IChpc29sYXRlLnJlbmRlck5vZGUuX2V2ZW50SW5wdXQgfHwgaXNvbGF0ZS5yZW5kZXJOb2RlKQoKICAgICAgICAgICAgICByZW5kZXJOb2RlLm9uKCJ0b3VjaG1vdmUiLCBmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgICB2YXIgZm4gPSAkcGFyc2UoYXR0cnMuZmFUb3VjaE1vdmUpOwogICAgICAgICAgICAgICAgZm4oc2NvcGUsIHskZXZlbnQ6ZGF0YX0pOwogICAgICAgICAgICAgICAgaWYoIXNjb3BlLiQkcGhhc2UpCiAgICAgICAgICAgICAgICAgIHNjb3BlLiRhcHBseSgpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCi8qKgogKiBAbmdkb2MgZGlyZWN0aXZlCiAqIEBuYW1lIGZhVG91Y2hzdGFydAogKiBAbW9kdWxlIGZhbW91cy5hbmd1bGFyCiAqIEByZXN0cmljdCBBCiAqIEBwYXJhbSB7ZXhwcmVzc2lvbn0gZmFUb3VjaHN0YXJ0IEV4cHJlc3Npb24gdG8gZXZhbHVhdGUgdXBvbiB0b3VjaHN0YXJ0LiAoRXZlbnQgb2JqZWN0IGlzIGF2YWlsYWJsZSBhcyBgJGV2ZW50YCkKICogQGRlc2NyaXB0aW9uCiAqIFRoaXMgZGlyZWN0aXZlIGFsbG93cyB5b3UgdG8gc3BlY2lmeSBjdXN0b20gYmVoYXZpb3Igd2hlbiBhbiBlbGVtZW50IGlzIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9SZWZlcmVuY2UvRXZlbnRzL3RvdWNoc3RhcnQgdG91Y2hlZCB1cG9uIGEgdG91Y2ggc3VyZmFjZX0uCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxBTlkgZmEtdG91Y2hzdGFydD0iZXhwcmVzc2lvbiI+CiAqCiAqIDwvQU5ZPgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhVG91Y2hzdGFydCcsIFsnJHBhcnNlJywgJyRmYW1vdXNEZWNvcmF0b3InLCBmdW5jdGlvbiAoJHBhcnNlLCAkZmFtb3VzRGVjb3JhdG9yKSB7CiAgICByZXR1cm4gewogICAgICByZXN0cmljdDogJ0EnLAogICAgICBzY29wZTogZmFsc2UsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgcG9zdDogZnVuY3Rpb24oc2NvcGUsIGVsZW1lbnQsIGF0dHJzKSB7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIGlmIChhdHRycy5mYVRvdWNoU3RhcnQpIHsKICAgICAgICAgICAgICB2YXIgcmVuZGVyTm9kZSA9IChpc29sYXRlLnJlbmRlck5vZGUuX2V2ZW50SW5wdXQgfHwgaXNvbGF0ZS5yZW5kZXJOb2RlKQoKICAgICAgICAgICAgICByZW5kZXJOb2RlLm9uKCJ0b3VjaHN0YXJ0IiwgZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIGZuID0gJHBhcnNlKGF0dHJzLmZhVG91Y2hTdGFydCk7CiAgICAgICAgICAgICAgICBmbihzY29wZSwgeyRldmVudDpkYXRhfSk7CiAgICAgICAgICAgICAgICBpZighc2NvcGUuJCRwaGFzZSkKICAgICAgICAgICAgICAgICAgc2NvcGUuJGFwcGx5KCk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH07CiAgfV0pOwoKLyoqCiAqIEBuZ2RvYyBkaXJlY3RpdmUKICogQG5hbWUgZmFWaWV3CiAqIEBtb2R1bGUgZmFtb3VzLmFuZ3VsYXIKICogQHJlc3RyaWN0IEVBCiAqIEBkZXNjcmlwdGlvbgogKiBUaGlzIGRpcmVjdGl2ZSBpcyB1c2VkIHRvIHdyYXAgY2hpbGQgZWxlbWVudHMgaW50byBhIFZpZXcgcmVuZGVyIG5vZGUuICBUaGlzIGlzIGVzcGVjaWFsbHkgdXNlZnVsIGZvciBncm91cGluZy4KICogVXNlIGFuIGA8ZmEtdmlldz5gIHN1cnJvdW5kZWQgYnkgYSBgPGZhLW1vZGlmaWVyPmAgaW4gb3JkZXIgdG8gYWZmZWN0IHRoZSBWaWV3J3MgcG9zaXRpb24sIHNjYWxlLCBldGMuCiAqCiAqIEB1c2FnZQogKiBgYGBodG1sCiAqIDxmYS12aWV3PgogKiAgIDwhLS0gY29udGVudCAtLT4KICogPC9mYS12aWV3PgogKiBgYGAKICovCgphbmd1bGFyLm1vZHVsZSgnZmFtb3VzLmFuZ3VsYXInKQogIC5kaXJlY3RpdmUoJ2ZhVmlldycsIFsiJGZhbW91cyIsICIkZmFtb3VzRGVjb3JhdG9yIiwgZnVuY3Rpb24gKCRmYW1vdXMsICRmYW1vdXNEZWNvcmF0b3IpIHsKICAgIHJldHVybiB7CiAgICAgIHRlbXBsYXRlOiAnPGRpdj48L2Rpdj4nLAogICAgICB0cmFuc2NsdWRlOiB0cnVlLAogICAgICBzY29wZTogdHJ1ZSwKICAgICAgcmVzdHJpY3Q6ICdFQScsCiAgICAgIGNvbXBpbGU6IGZ1bmN0aW9uKHRFbGVtZW50LCB0QXR0cnMsIHRyYW5zY2x1ZGUpewogICAgICAgIHZhciBWaWV3ID0gJGZhbW91c1snZmFtb3VzL2NvcmUvVmlldyddOwogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICBwcmU6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKCiAgICAgICAgICAgIGlzb2xhdGUuY2hpbGRyZW4gPSBbXTsKCiAgICAgICAgICAgIHZhciBnZXRPclZhbHVlID0gZnVuY3Rpb24oeCkgewogICAgICAgICAgICAgIHJldHVybiB4LmdldCA/IHguZ2V0KCkgOiB4OwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgaXNvbGF0ZS5yZW5kZXJOb2RlID0gbmV3IFZpZXcoewogICAgICAgICAgICAgIHNpemU6IHNjb3BlLiRldmFsKGF0dHJzLmZhU2l6ZSkgfHwgW3VuZGVmaW5lZCwgdW5kZWZpbmVkXQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY29wZS4kZW1pdCgndW5yZWdpc3RlckNoaWxkJywge2lkOiBzY29wZS4kaWR9KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzY29wZS4kb24oJ3JlZ2lzdGVyQ2hpbGQnLCBmdW5jdGlvbihldnQsIGRhdGEpewogICAgICAgICAgICAgIGlmKGV2dC50YXJnZXRTY29wZS4kaWQgIT0gc2NvcGUuJGlkKXsKICAgICAgICAgICAgICAgIGlzb2xhdGUucmVuZGVyTm9kZS5hZGQoZGF0YS5yZW5kZXJOb2RlKTsKICAgICAgICAgICAgICAgIGlzb2xhdGUuY2hpbGRyZW4ucHVzaChkYXRhKTsKICAgICAgICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgfSwKICAgICAgICAgIHBvc3Q6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBhdHRycyl7CiAgICAgICAgICAgIHZhciBpc29sYXRlID0gJGZhbW91c0RlY29yYXRvci5lbnN1cmVJc29sYXRlKHNjb3BlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyYW5zY2x1ZGUoc2NvcGUsIGZ1bmN0aW9uKGNsb25lKSB7CiAgICAgICAgICAgICAgZWxlbWVudC5maW5kKCdkaXYnKS5hcHBlbmQoY2xvbmUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHNjb3BlLiRlbWl0KCdyZWdpc3RlckNoaWxkJywgaXNvbGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH1dKTsKCiAgbW9kdWxlLmV4cG9ydHMgPSBuZ0ZhbWVBcHA7Cn0pOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 05:20:41 GMT",
                    "Content-Length": "63899",
                    "Date": "Sat, 08 Nov 2014 05:20:41 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}