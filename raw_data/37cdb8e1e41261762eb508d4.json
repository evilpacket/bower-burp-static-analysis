{
    "url": "http://localhost:9999/DavidDurman/joint/dist/joint.all.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/DavidDurman/joint/dist/joint.all.js",
                "path": "/DavidDurman/joint/dist/joint.all.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9EYXZpZER1cm1hbi9qb2ludC9kaXN0L2pvaW50LmFsbC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogOTI2NTczDQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA1OjQxOjQ0IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNTo0MTo0MyBHTVQNCg0KLyohIEpvaW50SlMgdjAuOS4xIC0gSmF2YVNjcmlwdCBkaWFncmFtbWluZyBsaWJyYXJ5ICAyMDE0LTA4LTA3IAoKClRoaXMgU291cmNlIENvZGUgRm9ybSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgTW96aWxsYSBQdWJsaWMKTGljZW5zZSwgdi4gMi4wLiBJZiBhIGNvcHkgb2YgdGhlIE1QTCB3YXMgbm90IGRpc3RyaWJ1dGVkIHdpdGggdGhpcwpmaWxlLCBZb3UgY2FuIG9idGFpbiBvbmUgYXQgaHR0cDovL21vemlsbGEub3JnL01QTC8yLjAvLgogKi8KLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjIuMC4zCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTA3LTAzVDEzOjMwWgogKi8KKGZ1bmN0aW9uKCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKLy8gdGhlIHN0YWNrIHZpYSBhcmd1bWVudHMuY2FsbGVyLmNhbGxlZSBhbmQgRmlyZWZveCBkaWVzIGlmCi8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCi8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCi8vInVzZSBzdHJpY3QiOwp2YXIKCS8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQoJcm9vdGpRdWVyeSwKCgkvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKCXJlYWR5TGlzdCwKCgkvLyBTdXBwb3J0OiBJRTkKCS8vIEZvciBgdHlwZW9mIHhtbE5vZGUubWV0aG9kYCBpbnN0ZWFkIG9mIGB4bWxOb2RlLm1ldGhvZCAhPT0gdW5kZWZpbmVkYAoJY29yZV9zdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLAoKCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKCWxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCglkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gW1tDbGFzc11dIC0+IHR5cGUgcGFpcnMKCWNsYXNzMnR5cGUgPSB7fSwKCgkvLyBMaXN0IG9mIGRlbGV0ZWQgZGF0YSBjYWNoZSBpZHMsIHNvIHdlIGNhbiByZXVzZSB0aGVtCgljb3JlX2RlbGV0ZWRJZHMgPSBbXSwKCgljb3JlX3ZlcnNpb24gPSAiMi4wLjMiLAoKCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKCWNvcmVfY29uY2F0ID0gY29yZV9kZWxldGVkSWRzLmNvbmNhdCwKCWNvcmVfcHVzaCA9IGNvcmVfZGVsZXRlZElkcy5wdXNoLAoJY29yZV9zbGljZSA9IGNvcmVfZGVsZXRlZElkcy5zbGljZSwKCWNvcmVfaW5kZXhPZiA9IGNvcmVfZGVsZXRlZElkcy5pbmRleE9mLAoJY29yZV90b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmcsCgljb3JlX2hhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHksCgljb3JlX3RyaW0gPSBjb3JlX3ZlcnNpb24udHJpbSwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5ICk7Cgl9LAoKCS8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKCWNvcmVfcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlLAoKCS8vIFVzZWQgZm9yIHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlCgljb3JlX3Jub3R3aGl0ZSA9IC9cUysvZywKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCgkvLyBNYXRjaCBhIHN0YW5kYWxvbmUgdGFnCglyc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLywKCgkvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKCXJtc1ByZWZpeCA9IC9eLW1zLS8sCglyZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCgoJLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7Cgl9LAoKCS8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCgljb21wbGV0ZWQgPSBmdW5jdGlvbigpIHsKCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgkJalF1ZXJ5LnJlYWR5KCk7Cgl9OwoKalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogY29yZV92ZXJzaW9uLAoKCWNvbnN0cnVjdG9yOiBqUXVlcnksCglpbml0OiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnkgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCBzZWxlY3Rvci5jaGFyQXQoMCkgPT09ICI8IiAmJiBzZWxlY3Rvci5jaGFyQXQoIHNlbGVjdG9yLmxlbmd0aCAtIDEgKSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzICkgewoJCQkJLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKCQkJCW1hdGNoID0gWyBudWxsLCBzZWxlY3RvciwgbnVsbCBdOwoKCQkJfSBlbHNlIHsKCQkJCW1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApOwoJCQl9CgoJCQkvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsKCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKCQkJCWlmICggbWF0Y2hbMV0gKSB7CgkJCQkJY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKCgkJCQkJLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdAoJCQkJCWpRdWVyeS5tZXJnZSggdGhpcywgalF1ZXJ5LnBhcnNlSFRNTCgKCQkJCQkJbWF0Y2hbMV0sCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsCgkJCQkJCXRydWUKCQkJCQkpICk7CgoJCQkJCS8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbMV0gKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29udGV4dCApICkgewoJCQkJCQlmb3IgKCBtYXRjaCBpbiBjb250ZXh0ICkgewoJCQkJCQkJLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQoJCQkJCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdGhpc1sgbWF0Y2ggXSApICkgewoJCQkJCQkJCXRoaXNbIG1hdGNoIF0oIGNvbnRleHRbIG1hdGNoIF0gKTsKCgkJCQkJCQkvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXRoaXMuYXR0ciggbWF0Y2gsIGNvbnRleHRbIG1hdGNoIF0gKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0dXJuIHRoaXM7CgoJCQkJLy8gSEFORExFOiAkKCNpZCkKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCgkJCS8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQoJCX0gZWxzZSBpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICk7CgkJfQoKCQlpZiAoIHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKCQkJdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKCQl9CgoJCXJldHVybiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciwgdGhpcyApOwoJfSwKCgkvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCglzZWxlY3RvcjogIiIsCgoJLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCglsZW5ndGg6IDAsCgoJdG9BcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGNvcmVfc2xpY2UuY2FsbCggdGhpcyApOwoJfSwKCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCgkvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQoJZ2V0OiBmdW5jdGlvbiggbnVtICkgewoJCXJldHVybiBudW0gPT0gbnVsbCA/CgoJCQkvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CgkJCXRoaXMudG9BcnJheSgpIDoKCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKCQkJKCBudW0gPCAwID8gdGhpc1sgdGhpcy5sZW5ndGggKyBudW0gXSA6IHRoaXNbIG51bSBdICk7Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKCS8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7Cgl9LAoKCXJlYWR5OiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gQWRkIHRoZSBjYWxsYmFjawoJCWpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCWZpcnN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggMCApOwoJfSwKCglsYXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggLTEgKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aCwKCQkJaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGogPj0gMCAmJiBqIDwgbGVuID8gWyB0aGlzW2pdIF0gOiBbXSApOwoJfSwKCgltYXA6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJfSkpOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCglwdXNoOiBjb3JlX3B1c2gsCglzb3J0OiBbXS5zb3J0LAoJc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCXZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKCQl0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCgkJaSA9IDEsCgkJbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKCQlkZWVwID0gZmFsc2U7CgoJLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggbGVuZ3RoID09PSBpICkgewoJCXRhcmdldCA9IHRoaXM7CgkJLS1pOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKSB7CgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQkJc3JjID0gdGFyZ2V0WyBuYW1lIF07CgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwoJCQkJaWYgKCBkZWVwICYmIGNvcHkgJiYgKCBqUXVlcnkuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBqUXVlcnkuaXNBcnJheShjb3B5KSkgKSApIHsKCQkJCQlpZiAoIGNvcHlJc0FycmF5ICkgewoJCQkJCQljb3B5SXNBcnJheSA9IGZhbHNlOwoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKCQkJCQl9CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKCWV4cGFuZG86ICJqUXVlcnkiICsgKCBjb3JlX3ZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksCgoJbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CgkJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgewoJCQl3aW5kb3cuJCA9IF8kOwoJCX0KCgkJaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKCQkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5OwoJfSwKCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKCQkvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKCQlpZiAoIGpRdWVyeS5mbi50cmlnZ2VyICkgewoJCQlqUXVlcnkoIGRvY3VtZW50ICkudHJpZ2dlcigicmVhZHkiKS5vZmYoInJlYWR5Iik7CgkJfQoJfSwKCgkvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgoJLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAoJLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KCWlzRnVuY3Rpb246IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJmdW5jdGlvbiI7Cgl9LAoKCWlzQXJyYXk6IEFycmF5LmlzQXJyYXksCgoJaXNXaW5kb3c6IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PT0gb2JqLndpbmRvdzsKCX0sCgoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKCX0sCgoJdHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAoIG9iaiA9PSBudWxsICkgewoJCQlyZXR1cm4gU3RyaW5nKCBvYmogKTsKCQl9CgkJLy8gU3VwcG9ydDogU2FmYXJpIDw9IDUuMSAoZnVuY3Rpb25pc2ggUmVnRXhwKQoJCXJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8KCQkJY2xhc3MydHlwZVsgY29yZV90b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IiA6CgkJCXR5cGVvZiBvYmo7Cgl9LAoKCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJLy8gTm90IHBsYWluIG9iamVjdHM6CgkJLy8gLSBBbnkgb2JqZWN0IG9yIHZhbHVlIHdob3NlIGludGVybmFsIFtbQ2xhc3NdXSBwcm9wZXJ0eSBpcyBub3QgIltvYmplY3QgT2JqZWN0XSIKCQkvLyAtIERPTSBub2RlcwoJCS8vIC0gd2luZG93CgkJaWYgKCBqUXVlcnkudHlwZSggb2JqICkgIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBqUXVlcnkuaXNXaW5kb3coIG9iaiApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTdXBwb3J0OiBGaXJlZm94IDwyMAoJCS8vIFRoZSB0cnkvY2F0Y2ggc3VwcHJlc3NlcyBleGNlcHRpb25zIHRocm93biB3aGVuIGF0dGVtcHRpbmcgdG8gYWNjZXNzCgkJLy8gdGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgb2YgY2VydGFpbiBob3N0IG9iamVjdHMsIGllLiB8d2luZG93LmxvY2F0aW9ufAoJCS8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTgxNDYyMgoJCXRyeSB7CgkJCWlmICggb2JqLmNvbnN0cnVjdG9yICYmCgkJCQkJIWNvcmVfaGFzT3duLmNhbGwoIG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSBjYXRjaCAoIGUgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIElmIHRoZSBmdW5jdGlvbiBoYXNuJ3QgcmV0dXJuZWQgYWxyZWFkeSwgd2UncmUgY29uZmlkZW50IHRoYXQKCQkvLyB8b2JqfCBpcyBhIHBsYWluIG9iamVjdCwgY3JlYXRlZCBieSB7fSBvciBjb25zdHJ1Y3RlZCB3aXRoIG5ldyBPYmplY3QKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJaXNFbXB0eU9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgbmFtZTsKCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsKCX0sCgoJLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKCS8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQKCS8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKCXBhcnNlSFRNTDogZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewoJCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCQlrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CgkJCWNvbnRleHQgPSBmYWxzZTsKCQl9CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCXZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSwKCQkJc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCgkJLy8gU2luZ2xlIHRhZwoJCWlmICggcGFyc2VkICkgewoJCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsxXSApIF07CgkJfQoKCQlwYXJzZWQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggWyBkYXRhIF0sIGNvbnRleHQsIHNjcmlwdHMgKTsKCgkJaWYgKCBzY3JpcHRzICkgewoJCQlqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsKCQl9CgoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwoJfSwKCglwYXJzZUpTT046IEpTT04ucGFyc2UsCgoJLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwoJcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB4bWwsIHRtcDsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRTkKCQl0cnkgewoJCQl0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEgLCAidGV4dC94bWwiICk7CgkJfSBjYXRjaCAoIGUgKSB7CgkJCXhtbCA9IHVuZGVmaW5lZDsKCQl9CgoJCWlmICggIXhtbCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CgkJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwoJCX0KCQlyZXR1cm4geG1sOwoJfSwKCglub29wOiBmdW5jdGlvbigpIHt9LAoKCS8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggY29kZSApIHsKCQl2YXIgc2NyaXB0LAoJCQkJaW5kaXJlY3QgPSBldmFsOwoKCQljb2RlID0galF1ZXJ5LnRyaW0oIGNvZGUgKTsKCgkJaWYgKCBjb2RlICkgewoJCQkvLyBJZiB0aGUgY29kZSBpbmNsdWRlcyBhIHZhbGlkLCBwcm9sb2d1ZSBwb3NpdGlvbgoJCQkvLyBzdHJpY3QgbW9kZSBwcmFnbWEsIGV4ZWN1dGUgY29kZSBieSBpbmplY3RpbmcgYQoJCQkvLyBzY3JpcHQgdGFnIGludG8gdGhlIGRvY3VtZW50LgoJCQlpZiAoIGNvZGUuaW5kZXhPZigidXNlIHN0cmljdCIpID09PSAxICkgewoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgkJCQlzY3JpcHQudGV4dCA9IGNvZGU7CgkJCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKCBzY3JpcHQgKS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlLCBhdm9pZCB0aGUgRE9NIG5vZGUgY3JlYXRpb24sIGluc2VydGlvbgoJCQkvLyBhbmQgcmVtb3ZhbCBieSB1c2luZyBhbiBpbmRpcmVjdCBnbG9iYWwgZXZhbAoJCQkJaW5kaXJlY3QoIGNvZGUgKTsKCQkJfQoJCX0KCX0sCgoJLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQoJY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewoJCXJldHVybiBzdHJpbmcucmVwbGFjZSggcm1zUHJlZml4LCAibXMtIiApLnJlcGxhY2UoIHJkYXNoQWxwaGEsIGZjYW1lbENhc2UgKTsKCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgdmFsdWUsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBvYmoubGVuZ3RoLAoJCQlpc0FycmF5ID0gaXNBcnJheWxpa2UoIG9iaiApOwoKCQlpZiAoIGFyZ3MgKSB7CgkJCWlmICggaXNBcnJheSApIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suYXBwbHkoIG9ialsgaSBdLCBhcmdzICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpIGluIG9iaiApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc0FycmF5ICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suY2FsbCggb2JqWyBpIF0sIGksIG9ialsgaSBdICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCXJldHVybiB0ZXh0ID09IG51bGwgPyAiIiA6IGNvcmVfdHJpbS5jYWxsKCB0ZXh0ICk7Cgl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LAoJCQkJCXR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KCQkJCQlbIGFyciBdIDogYXJyCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJY29yZV9wdXNoLmNhbGwoIHJldCwgYXJyICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWluQXJyYXk6IGZ1bmN0aW9uKCBlbGVtLCBhcnIsIGkgKSB7CgkJcmV0dXJuIGFyciA9PSBudWxsID8gLTEgOiBjb3JlX2luZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7Cgl9LAoKCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKCQl2YXIgbCA9IHNlY29uZC5sZW5ndGgsCgkJCWkgPSBmaXJzdC5sZW5ndGgsCgkJCWogPSAwOwoKCQlpZiAoIHR5cGVvZiBsID09PSAibnVtYmVyIiApIHsKCQkJZm9yICggOyBqIDwgbDsgaisrICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqIF07CgkJCX0KCQl9IGVsc2UgewoJCQl3aGlsZSAoIHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKCQkJfQoJCX0KCgkJZmlyc3QubGVuZ3RoID0gaTsKCgkJcmV0dXJuIGZpcnN0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldFZhbCwKCQkJcmV0ID0gW10sCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgkJaW52ID0gISFpbnY7CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKCQkvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQlyZXRWYWwgPSAhIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggaW52ICE9PSByZXRWYWwgKSB7CgkJCQlyZXQucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgYXJnICkgewoJCXZhciB2YWx1ZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBlbGVtcyApLAoJCQlyZXQgPSBbXTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJaWYgKCBpc0FycmF5ICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCgkJfSBlbHNlIHsKCQkJZm9yICggaSBpbiBlbGVtcyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7Cgl9LAoKCS8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwoJZ3VpZDogMSwKCgkvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKCS8vIGFyZ3VtZW50cy4KCXByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7CgkJdmFyIHRtcCwgYXJncywgcHJveHk7CgoJCWlmICggdHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciICkgewoJCQl0bXAgPSBmblsgY29udGV4dCBdOwoJCQljb250ZXh0ID0gZm47CgkJCWZuID0gdG1wOwoJCX0KCgkJLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKCQkvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgoJCWlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJLy8gU2ltdWxhdGVkIGJpbmQKCQlhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKCQlwcm94eSA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gZm4uYXBwbHkoIGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoIGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX07CgoJCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoKCQlyZXR1cm4gcHJveHk7Cgl9LAoKCS8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgoJLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCglhY2Nlc3M6IGZ1bmN0aW9uKCBlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHJhdyApIHsKCQl2YXIgaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJYnVsayA9IGtleSA9PSBudWxsOwoKCQkvLyBTZXRzIG1hbnkgdmFsdWVzCgkJaWYgKCBqUXVlcnkudHlwZSgga2V5ICkgPT09ICJvYmplY3QiICkgewoJCQljaGFpbmFibGUgPSB0cnVlOwoJCQlmb3IgKCBpIGluIGtleSApIHsKCQkJCWpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CgkJCX0KCgkJLy8gU2V0cyBvbmUgdmFsdWUKCQl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQljaGFpbmFibGUgPSB0cnVlOwoKCQkJaWYgKCAhalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyYXcgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIGJ1bGsgKSB7CgkJCQkvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKCQkJCWlmICggcmF3ICkgewoJCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwoJCQkJCWZuID0gbnVsbDsKCgkJCQkvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCgkJCQl9IGVsc2UgewoJCQkJCWJ1bGsgPSBmbjsKCQkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgewoJCQkJCQlyZXR1cm4gYnVsay5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdmFsdWUgKTsKCQkJCQl9OwoJCQkJfQoJCQl9CgoJCQlpZiAoIGZuICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJZm4oIGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbCggZWxlbXNbaV0sIGksIGZuKCBlbGVtc1tpXSwga2V5ICkgKSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gY2hhaW5hYmxlID8KCQkJZWxlbXMgOgoKCQkJLy8gR2V0cwoJCQlidWxrID8KCQkJCWZuLmNhbGwoIGVsZW1zICkgOgoJCQkJbGVuZ3RoID8gZm4oIGVsZW1zWzBdLCBrZXkgKSA6IGVtcHR5R2V0OwoJfSwKCglub3c6IERhdGUubm93LAoKCS8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMuCgkvLyBOb3RlOiB0aGlzIG1ldGhvZCBiZWxvbmdzIHRvIHRoZSBjc3MgbW9kdWxlIGJ1dCBpdCdzIG5lZWRlZCBoZXJlIGZvciB0aGUgc3VwcG9ydCBtb2R1bGUuCgkvLyBJZiBzdXBwb3J0IGdldHMgbW9kdWxhcml6ZWQsIHRoaXMgbWV0aG9kIHNob3VsZCBiZSBtb3ZlZCBiYWNrIHRvIHRoZSBjc3MgbW9kdWxlLgoJc3dhcDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrLCBhcmdzICkgewoJCXZhciByZXQsIG5hbWUsCgkJCW9sZCA9IHt9OwoKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07CgkJfQoKCQlyZXQgPSBjYWxsYmFjay5hcHBseSggZWxlbSwgYXJncyB8fCBbXSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KfSk7CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CglpZiAoICFyZWFkeUxpc3QgKSB7CgoJCXJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKCQkvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQkvLyB3ZSBvbmNlIHRyaWVkIHRvIHVzZSByZWFkeVN0YXRlICJpbnRlcmFjdGl2ZSIgaGVyZSwgYnV0IGl0IGNhdXNlZCBpc3N1ZXMgbGlrZSB0aGUgb25lCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoKCQl9IGVsc2UgewoKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl9Cgl9CglyZXR1cm4gcmVhZHlMaXN0LnByb21pc2UoIG9iaiApOwp9OwoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIi5zcGxpdCgiICIpLCBmdW5jdGlvbihpLCBuYW1lKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCmZ1bmN0aW9uIGlzQXJyYXlsaWtlKCBvYmogKSB7Cgl2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aCwKCQl0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOwoKCWlmICggalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJaWYgKCBvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoICkgewoJCXJldHVybiB0cnVlOwoJfQoKCXJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IHR5cGUgIT09ICJmdW5jdGlvbiIgJiYKCQkoIGxlbmd0aCA9PT0gMCB8fAoJCXR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKCBsZW5ndGggLSAxICkgaW4gb2JqICk7Cn0KCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQpyb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYxLjkuNC1wcmUKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTA2LTAzCiAqLwooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGksCglzdXBwb3J0LAoJY2FjaGVkcnVucywKCUV4cHIsCglnZXRUZXh0LAoJaXNYTUwsCgljb21waWxlLAoJb3V0ZXJtb3N0Q29udGV4dCwKCXNvcnRJbnB1dCwKCgkvLyBMb2NhbCBkb2N1bWVudCB2YXJzCglzZXREb2N1bWVudCwKCWRvY3VtZW50LAoJZG9jRWxlbSwKCWRvY3VtZW50SXNIVE1MLAoJcmJ1Z2d5UVNBLAoJcmJ1Z2d5TWF0Y2hlcywKCW1hdGNoZXMsCgljb250YWlucywKCgkvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhCglleHBhbmRvID0gInNpenpsZSIgKyAtKG5ldyBEYXRlKCkpLAoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAoJZGlycnVucyA9IDAsCglkb25lID0gMCwKCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksCgljb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCWhhc0R1cGxpY2F0ZSA9IGZhbHNlLAoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgkJcmV0dXJuIDA7Cgl9LAoKCS8vIEdlbmVyYWwtcHVycG9zZSBjb25zdGFudHMKCXN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsCglNQVhfTkVHQVRJVkUgPSAxIDw8IDMxLAoKCS8vIEluc3RhbmNlIG1ldGhvZHMKCWhhc093biA9ICh7fSkuaGFzT3duUHJvcGVydHksCglhcnIgPSBbXSwKCXBvcCA9IGFyci5wb3AsCglwdXNoX25hdGl2ZSA9IGFyci5wdXNoLAoJcHVzaCA9IGFyci5wdXNoLAoJc2xpY2UgPSBhcnIuc2xpY2UsCgkvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgaWYgd2UgY2FuJ3QgdXNlIGEgbmF0aXZlIG9uZQoJaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXSA9PT0gZWxlbSApIHsKCQkJCXJldHVybiBpOwoJCQl9CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAoKCS8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXN5bnRheC8jY2hhcmFjdGVycwoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLAoKCS8vIExvb3NlbHkgbW9kZWxlZCBvbiBDU1MgaWRlbnRpZmllciBjaGFyYWN0ZXJzCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCglpZGVudGlmaWVyID0gY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyMiICksCgoJLy8gQWNjZXB0YWJsZSBvcGVyYXRvcnMgaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCglhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICsgd2hpdGVzcGFjZSArCgkJIiooPzooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArICIqKD86KFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcM3woIiArIGlkZW50aWZpZXIgKyAiKXwpfCkiICsgd2hpdGVzcGFjZSArICIqXFxdIiwKCgkvLyBQcmVmZXIgYXJndW1lbnRzIHF1b3RlZCwKCS8vICAgdGhlbiBub3QgY29udGFpbmluZyBwc2V1ZG9zL2JyYWNrZXRzLAoJLy8gICB0aGVuIGF0dHJpYnV0ZSBzZWxlY3RvcnMvbm9uLXBhcmVudGhldGljYWwgZXhwcmVzc2lvbnMsCgkvLyAgIHRoZW4gYW55dGhpbmcgZWxzZQoJLy8gVGhlc2UgcHJlZmVyZW5jZXMgYXJlIGhlcmUgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzCgkvLyAgIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIFBTRVVETyBwcmVGaWx0ZXIKCXBzZXVkb3MgPSAiOigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSg/OlxcKCgoWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzLnJlcGxhY2UoIDMsIDggKSArICIpKil8LiopXFwpfCkiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAoJcmNvbWJpbmF0b3JzID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqKFs+K35dfCIgKyB3aGl0ZXNwYWNlICsgIikiICsgd2hpdGVzcGFjZSArICIqIiApLAoKCXJzaWJsaW5nID0gbmV3IFJlZ0V4cCggd2hpdGVzcGFjZSArICIqWyt+XSIgKSwKCXJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCAiPSIgKyB3aGl0ZXNwYWNlICsgIiooW15cXF0nXCJdKikiICsgd2hpdGVzcGFjZSArICIqXFxdIiwgImciICksCgoJcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwKCXJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCggIl4iICsgaWRlbnRpZmllciArICIkIiApLAoKCW1hdGNoRXhwciA9IHsKCQkiSUQiOiBuZXcgUmVnRXhwKCAiXiMoIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIlRBRyI6IG5ldyBSZWdFeHAoICJeKCIgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3KiIgKSArICIpIiApLAoJCSJBVFRSIjogbmV3IFJlZ0V4cCggIl4iICsgYXR0cmlidXRlcyApLAoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCgkJIkNISUxEIjogbmV3IFJlZ0V4cCggIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkJIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsKCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwKCQkiYm9vbCI6IG5ldyBSZWdFeHAoICJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YAoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIipbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCIgKwoJCQl3aGl0ZXNwYWNlICsgIiooKD86LVxcZCk/XFxkKikiICsgd2hpdGVzcGFjZSArICIqXFwpfCkoPz1bXi1dfCQpIiwgImkiICkKCX0sCgoJcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKCgkvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMKCXJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAoKCXJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAoJcmhlYWRlciA9IC9eaFxkJC9pLAoKCXJlc2NhcGUgPSAvJ3xcXC9nLAoKCS8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKCXJ1bmVzY2FwZSA9IG5ldyBSZWdFeHAoICJcXFxcKFtcXGRhLWZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fCgiICsgd2hpdGVzcGFjZSArICIpfC4pIiwgImlnIiApLAoJZnVuZXNjYXBlID0gZnVuY3Rpb24oIF8sIGVzY2FwZWQsIGVzY2FwZWRXaGl0ZXNwYWNlICkgewoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwoJCS8vIE5hTiBtZWFucyBub24tY29kZXBvaW50CgkJLy8gU3VwcG9ydDogRmlyZWZveAoJCS8vIFdvcmthcm91bmQgZXJyb25lb3VzIG51bWVyaWMgaW50ZXJwcmV0YXRpb24gb2YgKyIweCIKCQlyZXR1cm4gaGlnaCAhPT0gaGlnaCB8fCBlc2NhcGVkV2hpdGVzcGFjZSA/CgkJCWVzY2FwZWQgOgoJCQkvLyBCTVAgY29kZXBvaW50CgkJCWhpZ2ggPCAwID8KCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgoJCQkJLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoID4+IDEwIHwgMHhEODAwLCBoaWdoICYgMHgzRkYgfCAweERDMDAgKTsKCX07CgovLyBPcHRpbWl6ZSBmb3IgcHVzaC5hcHBseSggXywgTm9kZUxpc3QgKQp0cnkgewoJcHVzaC5hcHBseSgKCQkoYXJyID0gc2xpY2UuY2FsbCggcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMgKSksCgkJcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMKCSk7CgkvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMAoJLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CglwdXNoID0geyBhcHBseTogYXJyLmxlbmd0aCA/CgoJCS8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQlwdXNoX25hdGl2ZS5hcHBseSggdGFyZ2V0LCBzbGljZS5jYWxsKGVscykgKTsKCQl9IDoKCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIE90aGVyd2lzZSBhcHBlbmQgZGlyZWN0bHkKCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7CgkJCXZhciBqID0gdGFyZ2V0Lmxlbmd0aCwKCQkJCWkgPSAwOwoJCQkvLyBDYW4ndCB0cnVzdCBOb2RlTGlzdC5sZW5ndGgKCQkJd2hpbGUgKCAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgKSB7fQoJCQl0YXJnZXQubGVuZ3RoID0gaiAtIDE7CgkJfQoJfTsKfQoKZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXZhciBtYXRjaCwgZWxlbSwgbSwgbm9kZVR5cGUsCgkJLy8gUVNBIHZhcnMKCQlpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsKCglpZiAoICggY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7Cgl9CgoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCWlmICggKG5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZSkgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWlmICggZG9jdW1lbnRJc0hUTUwgJiYgIXNlZWQgKSB7CgoJCS8vIFNob3J0Y3V0cwoJCWlmICggKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJaWYgKCAobSA9IG1hdGNoWzFdKSApIHsKCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQoJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9CgkJfQoKCQkvLyBRU0EgcGF0aAoJCWlmICggc3VwcG9ydC5xc2EgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KCBzZWxlY3RvciApKSApIHsKCQkJbmlkID0gb2xkID0gZXhwYW5kbzsKCQkJbmV3Q29udGV4dCA9IGNvbnRleHQ7CgkJCW5ld1NlbGVjdG9yID0gbm9kZVR5cGUgPT09IDkgJiYgc2VsZWN0b3I7CgoJCQkvLyBxU0Egd29ya3Mgc3RyYW5nZWx5IG9uIEVsZW1lbnQtcm9vdGVkIHF1ZXJpZXMKCQkJLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAoJCQkvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKCQkJLy8gSUUgOCBkb2Vzbid0IHdvcmsgb24gb2JqZWN0IGVsZW1lbnRzCgkJCWlmICggbm9kZVR5cGUgPT09IDEgJiYgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IiApIHsKCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKCQkJCWlmICggKG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpKSApIHsKCQkJCQluaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CgkJCQl9IGVsc2UgewoJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKCQkJCX0KCQkJCW5pZCA9ICJbaWQ9JyIgKyBuaWQgKyAiJ10gIjsKCgkJCQlpID0gZ3JvdXBzLmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwoJCQkJfQoJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQ7CgkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CgkJCX0KCgkJCWlmICggbmV3U2VsZWN0b3IgKSB7CgkJCQl0cnkgewoJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsCgkJCQkJCW5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCggbmV3U2VsZWN0b3IgKQoJCQkJCSk7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQl9IGNhdGNoKHFzYUVycm9yKSB7CgkJCQl9IGZpbmFsbHkgewoJCQkJCWlmICggIW9sZCApIHsKCQkJCQkJY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoImlkIik7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIEFsbCBvdGhlcnMKCXJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKfQoKLyoqCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAqCWRlbGV0aW5nIHRoZSBvbGRlc3QgZW50cnkKICovCmZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewoJdmFyIGtleXMgPSBbXTsKCglmdW5jdGlvbiBjYWNoZSgga2V5LCB2YWx1ZSApIHsKCQkvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKCQlpZiAoIGtleXMucHVzaCgga2V5ICs9ICIgIiApID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQkJLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCgkJCWRlbGV0ZSBjYWNoZVsga2V5cy5zaGlmdCgpIF07CgkJfQoJCXJldHVybiAoY2FjaGVbIGtleSBdID0gdmFsdWUpOwoJfQoJcmV0dXJuIGNhY2hlOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CglmblsgZXhwYW5kbyBdID0gdHJ1ZTsKCXJldHVybiBmbjsKfQoKLyoqCiAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFBhc3NlZCB0aGUgY3JlYXRlZCBkaXYgYW5kIGV4cGVjdHMgYSBib29sZWFuIHJlc3VsdAogKi8KZnVuY3Rpb24gYXNzZXJ0KCBmbiApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCgl0cnkgewoJCXJldHVybiAhIWZuKCBkaXYgKTsKCX0gY2F0Y2ggKGUpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9IGZpbmFsbHkgewoJCS8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAoJCWlmICggZGl2LnBhcmVudE5vZGUgKSB7CgkJCWRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBkaXYgKTsKCQl9CgkJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCQlkaXYgPSBudWxsOwoJfQp9CgovKioKICogQWRkcyB0aGUgc2FtZSBoYW5kbGVyIGZvciBhbGwgb2YgdGhlIHNwZWNpZmllZCBhdHRycwogKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogKi8KZnVuY3Rpb24gYWRkSGFuZGxlKCBhdHRycywgaGFuZGxlciApIHsKCXZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLAoJCWkgPSBhdHRycy5sZW5ndGg7CgoJd2hpbGUgKCBpLS0gKSB7CgkJRXhwci5hdHRySGFuZGxlWyBhcnJbaV0gXSA9IGhhbmRsZXI7Cgl9Cn0KCi8qKgogKiBDaGVja3MgZG9jdW1lbnQgb3JkZXIgb2YgdHdvIHNpYmxpbmdzCiAqIEBwYXJhbSB7RWxlbWVudH0gYQogKiBAcGFyYW0ge0VsZW1lbnR9IGIKICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBsZXNzIHRoYW4gMCBpZiBhIHByZWNlZGVzIGIsIGdyZWF0ZXIgdGhhbiAwIGlmIGEgZm9sbG93cyBiCiAqLwpmdW5jdGlvbiBzaWJsaW5nQ2hlY2soIGEsIGIgKSB7Cgl2YXIgY3VyID0gYiAmJiBhLAoJCWRpZmYgPSBjdXIgJiYgYS5ub2RlVHlwZSA9PT0gMSAmJiBiLm5vZGVUeXBlID09PSAxICYmCgkJCSggfmIuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICkgLQoJCQkoIH5hLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApOwoKCS8vIFVzZSBJRSBzb3VyY2VJbmRleCBpZiBhdmFpbGFibGUgb24gYm90aCBub2RlcwoJaWYgKCBkaWZmICkgewoJCXJldHVybiBkaWZmOwoJfQoKCS8vIENoZWNrIGlmIGIgZm9sbG93cyBhCglpZiAoIGN1ciApIHsKCQl3aGlsZSAoIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpICkgewoJCQlpZiAoIGN1ciA9PT0gYiApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gYSA/IDEgOiAtMTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgaW5wdXQgdHlwZXMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUlucHV0UHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvblBzZXVkbyggdHlwZSApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlyZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAqLwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIGFyZ3VtZW50ICkgewoJCWFyZ3VtZW50ID0gK2FyZ3VtZW50OwoJCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCXZhciBqLAoJCQkJbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKCQkJCWkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKCQkJLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCBzZWVkWyAoaiA9IG1hdGNoSW5kZXhlc1tpXSkgXSApIHsKCQkJCQlzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwp9CgovKioKICogRGV0ZWN0IHhtbAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogKi8KaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsKCS8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQoJdmFyIGRvY3VtZW50RWxlbWVudCA9IGVsZW0gJiYgKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKS5kb2N1bWVudEVsZW1lbnQ7CglyZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKfTsKCi8vIEV4cG9zZSBzdXBwb3J0IHZhcnMgZm9yIGNvbnZlbmllbmNlCnN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwoKLyoqCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqLwpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgewoJdmFyIGRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYywKCQlwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7CgoJLy8gSWYgbm8gZG9jdW1lbnQgYW5kIGRvY3VtZW50RWxlbWVudCBpcyBhdmFpbGFibGUsIHJldHVybgoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsKCQlyZXR1cm4gZG9jdW1lbnQ7Cgl9CgoJLy8gU2V0IG91ciBkb2N1bWVudAoJZG9jdW1lbnQgPSBkb2M7Cglkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkvLyBTdXBwb3J0IHRlc3RzCglkb2N1bWVudElzSFRNTCA9ICFpc1hNTCggZG9jICk7CgoJLy8gU3VwcG9ydDogSUU+OAoJLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwKCS8vIElFIHdpbGwgdGhyb3cgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIGFjY2Vzc2luZyAiZG9jdW1lbnQiIHZhcmlhYmxlLCBzZWUgalF1ZXJ5ICMxMzkzNgoJLy8gSUU2LTggZG8gbm90IHN1cHBvcnQgdGhlIGRlZmF1bHRWaWV3IHByb3BlcnR5IHNvIHBhcmVudCB3aWxsIGJlIHVuZGVmaW5lZAoJaWYgKCBwYXJlbnQgJiYgcGFyZW50LmF0dGFjaEV2ZW50ICYmIHBhcmVudCAhPT0gcGFyZW50LnRvcCApIHsKCQlwYXJlbnQuYXR0YWNoRXZlbnQoICJvbmJlZm9yZXVubG9hZCIsIGZ1bmN0aW9uKCkgewoJCQlzZXREb2N1bWVudCgpOwoJCX0pOwoJfQoKCS8qIEF0dHJpYnV0ZXMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBTdXBwb3J0OiBJRTw4CgkvLyBWZXJpZnkgdGhhdCBnZXRBdHRyaWJ1dGUgcmVhbGx5IHJldHVybnMgYXR0cmlidXRlcyBhbmQgbm90IHByb3BlcnRpZXMgKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuY2xhc3NOYW1lID0gImkiOwoJCXJldHVybiAhZGl2LmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7Cgl9KTsKCgkvKiBnZXRFbGVtZW50KHMpQnkqCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoOwoJfSk7CgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAoJc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdhJz48L2Rpdj48ZGl2IGNsYXNzPSdhIGknPjwvZGl2PiI7CgoJCS8vIFN1cHBvcnQ6IFNhZmFyaTw0CgkJLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nCgkJZGl2LmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gImkiOwoJCS8vIFN1cHBvcnQ6IE9wZXJhPDEwCgkJLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMKCQlyZXR1cm4gZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImkiKS5sZW5ndGggPT09IDI7Cgl9KTsKCgkvLyBTdXBwb3J0OiBJRTwxMAoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLAoJLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CglzdXBwb3J0LmdldEJ5SWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBkaXYgKS5pZCA9IGV4cGFuZG87CgkJcmV0dXJuICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUgfHwgIWRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aDsKCX0pOwoKCS8vIElEIGZpbmQgYW5kIGZpbHRlcgoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7CgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CgkJCX0KCQl9OwoJCUV4cHIuZmlsdGVyWyJJRCJdID0gZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBhdHRySWQ7CgkJCX07CgkJfTsKCX0gZWxzZSB7CgkJLy8gU3VwcG9ydDogSUU2LzcKCQkvLyBnZXRFbGVtZW50QnlJZCBpcyBub3QgcmVsaWFibGUgYXMgYSBmaW5kIHNob3J0Y3V0CgkJZGVsZXRlIEV4cHIuZmluZFsiSUQiXTsKCgkJRXhwci5maWx0ZXJbIklEIl0gPSAgZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwoJCQl9OwoJCX07Cgl9CgoJLy8gVGFnCglFeHByLmZpbmRbIlRBRyJdID0gc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoJCQl9CgkJfSA6CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJdmFyIGVsZW0sCgkJCQl0bXAgPSBbXSwKCQkJCWkgPSAwLAoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdG1wOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX07CgoJLy8gQ2xhc3MKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MICkgewoJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBjbGFzc05hbWUgKTsKCQl9Cgl9OwoKCS8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CgoJLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKCXJidWdneU1hdGNoZXMgPSBbXTsKCgkvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKQoJLy8gV2UgYWxsb3cgdGhpcyBiZWNhdXNlIG9mIGEgYnVnIGluIElFOC85IHRoYXQgdGhyb3dzIGFuIGVycm9yCgkvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCgkvLyBTbywgd2UgYWxsb3cgOmZvY3VzIHRvIHBhc3MgdGhyb3VnaCBRU0EgYWxsIHRoZSB0aW1lIHRvIGF2b2lkIHRoZSBJRSBlcnJvcgoJLy8gU2VlIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CglyYnVnZ3lRU0EgPSBbXTsKCglpZiAoIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdCggZG9jLnF1ZXJ5U2VsZWN0b3JBbGwgKSkgKSB7CgkJLy8gQnVpbGQgUVNBIHJlZ2V4CgkJLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBTZWxlY3QgaXMgc2V0IHRvIGVtcHR5IHN0cmluZyBvbiBwdXJwb3NlCgkJCS8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQoJCQkvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKCQkJLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKCQkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIiApOwoJCQl9CgoJCQkvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoJCX0pOwoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCgkJCS8vIFN1cHBvcnQ6IE9wZXJhIDEwLTEyL0lFOAoJCQkvLyBePSAkPSAqPSBhbmQgZW1wdHkgdmFsdWVzCgkJCS8vIFNob3VsZCBub3Qgc2VsZWN0IGFueXRoaW5nCgkJCS8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwoJCQkvLyBUaGUgdHlwZSBhdHRyaWJ1dGUgaXMgcmVzdHJpY3RlZCBkdXJpbmcgLmlubmVySFRNTCBhc3NpZ25tZW50CgkJCXZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCQlpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgImhpZGRlbiIgKTsKCQkJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApLnNldEF0dHJpYnV0ZSggInQiLCAiIiApOwoKCQkJaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCgiW3RePScnXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiWypeJF09IiArIHdoaXRlc3BhY2UgKyAiKig/OicnfFwiXCIpIiApOwoJCQl9CgoJCQkvLyBGRiAzLjUgLSA6ZW5hYmxlZC86ZGlzYWJsZWQgYW5kIGhpZGRlbiBlbGVtZW50cyAoaGlkZGVuIGVsZW1lbnRzIGFyZSBzdGlsbCBlbmFibGVkKQoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsKCQkJfQoKCQkJLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKCQkJZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKCQkJcmJ1Z2d5UVNBLnB1c2goIiwuKjoiKTsKCQl9KTsKCX0KCglpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdCggKG1hdGNoZXMgPSBkb2NFbGVtLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKCQkJc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbCggZGl2LCAiZGl2IiApOwoKCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgoJCQkvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCgkJCW1hdGNoZXMuY2FsbCggZGl2LCAiW3MhPScnXTp4IiApOwoJCQlyYnVnZ3lNYXRjaGVzLnB1c2goICIhPSIsIHBzZXVkb3MgKTsKCQl9KTsKCX0KCglyYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneVFTQS5qb2luKCJ8IikgKTsKCXJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lNYXRjaGVzLmpvaW4oInwiKSApOwoKCS8qIENvbnRhaW5zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCgkvLyBQdXJwb3NlZnVsbHkgZG9lcyBub3QgaW1wbGVtZW50IGluY2x1c2l2ZSBkZXNjZW5kZW50CgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgoJY29udGFpbnMgPSBybmF0aXZlLnRlc3QoIGRvY0VsZW0uY29udGFpbnMgKSB8fCBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJCWJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKCQkJCWFkb3duLmNvbnRhaW5zID8KCQkJCQlhZG93bi5jb250YWlucyggYnVwICkgOgoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgoJCQkpKTsKCQl9IDoKCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJaWYgKCBiICkgewoJCQkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCQkJaWYgKCBiID09PSBhICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJLyogU29ydGluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKCXNvcnRPcmRlciA9IGRvY0VsZW0uY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXZhciBjb21wYXJlID0gYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKTsKCgkJaWYgKCBjb21wYXJlICkgewoJCQkvLyBEaXNjb25uZWN0ZWQgbm9kZXMKCQkJaWYgKCBjb21wYXJlICYgMSB8fAoJCQkJKCFzdXBwb3J0LnNvcnREZXRhY2hlZCAmJiBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBhICkgPT09IGNvbXBhcmUpICkgewoKCQkJCS8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAoJCQkJaWYgKCBhID09PSBkb2MgfHwgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSApIHsKCQkJCQlyZXR1cm4gLTE7CgkJCQl9CgkJCQlpZiAoIGIgPT09IGRvYyB8fCBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpICkgewoJCQkJCXJldHVybiAxOwoJCQkJfQoKCQkJCS8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCgkJCQlyZXR1cm4gc29ydElucHV0ID8KCQkJCQkoIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBhICkgLSBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYiApICkgOgoJCQkJCTA7CgkJCX0KCgkJCXJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKCQl9CgoJCS8vIE5vdCBkaXJlY3RseSBjb21wYXJhYmxlLCBzb3J0IG9uIGV4aXN0ZW5jZSBvZiBtZXRob2QKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsKCX0gOgoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwKCQkJYnVwID0gYi5wYXJlbnROb2RlLAoJCQlhcCA9IFsgYSBdLAoJCQlicCA9IFsgYiBdOwoKCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKCQl9IGVsc2UgaWYgKCAhYXVwIHx8ICFidXAgKSB7CgkJCXJldHVybiBhID09PSBkb2MgPyAtMSA6CgkJCQliID09PSBkb2MgPyAxIDoKCQkJCWF1cCA/IC0xIDoKCQkJCWJ1cCA/IDEgOgoJCQkJc29ydElucHV0ID8KCQkJCSggaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGEgKSAtIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoKCQkvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawoJCX0gZWxzZSBpZiAoIGF1cCA9PT0gYnVwICkgewoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7CgkJfQoKCQkvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgoJCWN1ciA9IGE7CgkJd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewoJCQlhcC51bnNoaWZ0KCBjdXIgKTsKCQl9CgkJY3VyID0gYjsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWJwLnVuc2hpZnQoIGN1ciApOwoJCX0KCgkJLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKCQl3aGlsZSAoIGFwW2ldID09PSBicFtpXSApIHsKCQkJaSsrOwoJCX0KCgkJcmV0dXJuIGkgPwoJCQkvLyBEbyBhIHNpYmxpbmcgY2hlY2sgaWYgdGhlIG5vZGVzIGhhdmUgYSBjb21tb24gYW5jZXN0b3IKCQkJc2libGluZ0NoZWNrKCBhcFtpXSwgYnBbaV0gKSA6CgoJCQkvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKCQkJYXBbaV0gPT09IHByZWZlcnJlZERvYyA/IC0xIDoKCQkJYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOgoJCQkwOwoJfTsKCglyZXR1cm4gZG9jOwp9OwoKU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgZWxlbWVudHMgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBlbGVtZW50cyApOwp9OwoKU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbGVtLCBleHByICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgkvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKCWV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgoJaWYgKCBzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJgoJCSggIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICkgJiYKCQkoICFyYnVnZ3lRU0EgICAgIHx8ICFyYnVnZ3lRU0EudGVzdCggZXhwciApICkgKSB7CgoJCXRyeSB7CgkJCXZhciByZXQgPSBtYXRjaGVzLmNhbGwoIGVsZW0sIGV4cHIgKTsKCgkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKCQkJaWYgKCByZXQgfHwgc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCB8fAoJCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CgkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQoJCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgkJfSBjYXRjaChlKSB7fQoJfQoKCXJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJfQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgl2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbIG5hbWUudG9Mb3dlckNhc2UoKSBdLAoJCS8vIERvbid0IGdldCBmb29sZWQgYnkgT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzIChqUXVlcnkgIzEzODA3KQoJCXZhbCA9IGZuICYmIGhhc093bi5jYWxsKCBFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSApID8KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoKCQkJdW5kZWZpbmVkOwoKCXJldHVybiB2YWwgPT09IHVuZGVmaW5lZCA/CgkJc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/CgkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICkgOgoJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsIDoKCQl2YWw7Cn07CgpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgewoJdGhyb3cgbmV3IEVycm9yKCAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyApOwp9OwoKLyoqCiAqIERvY3VtZW50IHNvcnRpbmcgYW5kIHJlbW92aW5nIGR1cGxpY2F0ZXMKICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMKICovClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24oIHJlc3VsdHMgKSB7Cgl2YXIgZWxlbSwKCQlkdXBsaWNhdGVzID0gW10sCgkJaiA9IDAsCgkJaSA9IDA7CgoJLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQoJaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKCXNvcnRJbnB1dCA9ICFzdXBwb3J0LnNvcnRTdGFibGUgJiYgcmVzdWx0cy5zbGljZSggMCApOwoJcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCglpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQl3aGlsZSAoIChlbGVtID0gcmVzdWx0c1tpKytdKSApIHsKCQkJaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIF0gKSB7CgkJCQlqID0gZHVwbGljYXRlcy5wdXNoKCBpICk7CgkJCX0KCQl9CgkJd2hpbGUgKCBqLS0gKSB7CgkJCXJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsKCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwpnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoICFub2RlVHlwZSApIHsKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCWZvciAoIDsgKG5vZGUgPSBlbGVtW2ldKTsgaSsrICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykKCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJfSBlbHNlIHsKCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJfQoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCX0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKCXJldHVybiByZXQ7Cn07CgpFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgljcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKCgltYXRjaDogbWF0Y2hFeHByLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWZpbmQ6IHt9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKCQkJCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNiB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50CgkJCQk4IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXS5zbGljZSggMCwgMyApID09PSAibnRoIiApIHsKCQkJCS8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFszXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs1XSA9ICsoICggbWF0Y2hbN10gKyBtYXRjaFs4XSApIHx8IG1hdGNoWzNdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzNdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGV4Y2VzcywKCQkJCXVucXVvdGVkID0gIW1hdGNoWzVdICYmIG1hdGNoWzJdOwoKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQkvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwoJCQlpZiAoIG1hdGNoWzNdICYmIG1hdGNoWzRdICE9PSB1bmRlZmluZWQgKSB7CgkJCQltYXRjaFsyXSA9IG1hdGNoWzRdOwoKCQkJLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKCQkJfSBlbHNlIGlmICggdW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KCB1bnF1b3RlZCApICYmCgkJCQkvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQoJCQkJKGV4Y2VzcyA9IHRva2VuaXplKCB1bnF1b3RlZCwgdHJ1ZSApKSAmJgoJCQkJLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzCgkJCQkoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgoJCQkJLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKCQkJCW1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAsIGV4Y2VzcyApOwoJCQkJbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CgkJCX0KCgkJCS8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsKCQl9Cgl9LAoKCWZpbHRlcjogewoKCQkiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lU2VsZWN0b3IgKSB7CgkJCXZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbm9kZU5hbWVTZWxlY3RvciA9PT0gIioiID8KCQkJCWZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfSA6CgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwoJCQkJfTsKCQl9LAoKCQkiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgewoJCQl2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbIGNsYXNzTmFtZSArICIgIiBdOwoKCQkJcmV0dXJuIHBhdHRlcm4gfHwKCQkJCShwYXR0ZXJuID0gbmV3IFJlZ0V4cCggIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiICkpICYmCgkJCQljbGFzc0NhY2hlKCBjbGFzc05hbWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIHR5cGVvZiBlbGVtLmNsYXNzTmFtZSA9PT0gInN0cmluZyIgJiYgZWxlbS5jbGFzc05hbWUgfHwgdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIgKTsKCQkJCX0pOwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgkJCQlpZiAoICFvcGVyYXRvciApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXN1bHQgKz0gIiI7CgoJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgoJCQkJCW9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAifj0iID8gKCAiICIgKyByZXN1bHQgKyAiICIgKS5pbmRleE9mKCBjaGVjayApID4gLTEgOgoJCQkJCW9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoIDAsIGNoZWNrLmxlbmd0aCArIDEgKSA9PT0gY2hlY2sgKyAiLSIgOgoJCQkJCWZhbHNlOwoJCQl9OwoJCX0sCgoJCSJDSElMRCI6IGZ1bmN0aW9uKCB0eXBlLCB3aGF0LCBhcmd1bWVudCwgZmlyc3QsIGxhc3QgKSB7CgkJCXZhciBzaW1wbGUgPSB0eXBlLnNsaWNlKCAwLCAzICkgIT09ICJudGgiLAoJCQkJZm9yd2FyZCA9IHR5cGUuc2xpY2UoIC00ICkgIT09ICJsYXN0IiwKCQkJCW9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKCgkJCXJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KCgkJCQkvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CgkJCQl9IDoKCgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBjYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgZGlmZiwgbm9kZUluZGV4LCBzdGFydCwKCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsCgkJCQkJCW5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsKCgkJCQkJaWYgKCBwYXJlbnQgKSB7CgoJCQkJCQkvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCgkJCQkJCWlmICggc2ltcGxlICkgewoJCQkJCQkJd2hpbGUgKCBkaXIgKSB7CgkJCQkJCQkJbm9kZSA9IGVsZW07CgkJCQkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGVbIGRpciBdKSApIHsKCQkJCQkJCQkJaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJCS8vIFJldmVyc2UgZGlyZWN0aW9uIGZvciA6b25seS0qIChpZiB3ZSBoYXZlbid0IHlldCBkb25lIHNvKQoJCQkJCQkJCXN0YXJ0ID0gZGlyID0gdHlwZSA9PT0gIm9ubHkiICYmICFzdGFydCAmJiAibmV4dFNpYmxpbmciOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCX0KCgkJCQkJCXN0YXJ0ID0gWyBmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkIF07CgoJCQkJCQkvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAoJCQkJCQlpZiAoIGZvcndhcmQgJiYgdXNlQ2FjaGUgKSB7CgkJCQkJCQkvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKCQkJCQkJCW91dGVyQ2FjaGUgPSBwYXJlbnRbIGV4cGFuZG8gXSB8fCAocGFyZW50WyBleHBhbmRvIF0gPSB7fSk7CgkJCQkJCQljYWNoZSA9IG91dGVyQ2FjaGVbIHR5cGUgXSB8fCBbXTsKCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwoJCQkJCQkJZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOwoJCQkJCQkJbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCgkJCQkJCQkJLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJLy8gV2hlbiBmb3VuZCwgY2FjaGUgaW5kZXhlcyBvbiBgcGFyZW50YCBhbmQgYnJlYWsKCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCW91dGVyQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgbm9kZUluZGV4LCBkaWZmIF07CgkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCX0KCQkJCQkJCX0KCgkJCQkJCS8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQoJCQkJCQl9IGVsc2UgaWYgKCB1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zICkgewoJCQkJCQkJZGlmZiA9IGNhY2hlWzFdOwoKCQkJCQkJLy8geG1sIDpudGgtY2hpbGQoLi4uKSBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydAoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJaWYgKCAoIG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEgKSAmJiArK2RpZmYgKSB7CgkJCQkJCQkJCS8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKCQkJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsKCQkJCQkJCQkJCShub2RlWyBleHBhbmRvIF0gfHwgKG5vZGVbIGV4cGFuZG8gXSA9IHt9KSlbIHR5cGUgXSA9IFsgZGlycnVucywgZGlmZiBdOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQlpZiAoIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKCQkJCQkJZGlmZiAtPSBsYXN0OwoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKCQkJCQl9CgkJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwoJCQl2YXIgYXJncywKCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwKCQkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8gKTsKCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKCQkJLy8gYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7CgkJCQlyZXR1cm4gZm4oIGFyZ3VtZW50ICk7CgkJCX0KCgkJCS8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7CgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CgkJCQlyZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KCBwc2V1ZG8udG9Mb3dlckNhc2UoKSApID8KCQkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCQkJCXZhciBpZHgsCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksCgkJCQkJCQlpID0gbWF0Y2hlZC5sZW5ndGg7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CgkJCQkJCQlzZWVkWyBpZHggXSA9ICEoIG1hdGNoZXNbIGlkeCBdID0gbWF0Y2hlZFtpXSApOwoJCQkJCQl9CgkJCQkJfSkgOgoJCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsKCQkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZm47CgkJfQoJfSwKCglwc2V1ZG9zOiB7CgkJLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zCgkJIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgaW5wdXQgPSBbXSwKCQkJCXJlc3VsdHMgPSBbXSwKCQkJCW1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApICk7CgoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8KCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksCgkJCQkJCWkgPSBzZWVkLmxlbmd0aDsKCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pIDoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJaW5wdXRbMF0gPSBlbGVtOwoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7CgkJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCS8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCgkJLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKCQkvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAoJCS8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgoJCS8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgoJCS8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgoJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KCQkibGFuZyI6IG1hcmtGdW5jdGlvbiggZnVuY3Rpb24oIGxhbmcgKSB7CgkJCS8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKCQkJaWYgKCAhcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSApIHsKCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CgkJCX0KCQkJbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgZWxlbUxhbmc7CgkJCQlkbyB7CgkJCQkJaWYgKCAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/CgkJCQkJCWVsZW0ubGFuZyA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikpICkgewoKCQkJCQkJZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwoJCQkJCQlyZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwoJCQkJCX0KCQkJCX0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9OwoJCX0pLAoKCQkvLyBNaXNjZWxsYW5lb3VzCgkJInRhcmdldCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOwoJCX0sCgoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBkb2NFbGVtOwoJCX0sCgoJCSJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwoJCX0sCgoJCS8vIEJvb2xlYW4gcHJvcGVydGllcwoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKCQl9LAoKCQkiZGlzYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gQ29udGVudHMKCQkiZW1wdHkiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KCQkJLy8gOmVtcHR5IGlzIG9ubHkgYWZmZWN0ZWQgYnkgZWxlbWVudCBub2RlcyBhbmQgY29udGVudCBub2RlcyhpbmNsdWRpbmcgdGV4dCgzKSwgY2RhdGEoNCkpLAoJCQkvLyAgIG5vdCBjb21tZW50LCBwcm9jZXNzaW5nIGluc3RydWN0aW9ucywgb3Igb3RoZXJzCgkJCS8vIFRoYW5rcyB0byBEaWVnbyBQZXJpbmkgZm9yIHRoZSBub2RlTmFtZSBzaG9ydGN1dAoJCQkvLyAgIEdyZWF0ZXIgdGhhbiAiQCIgbWVhbnMgYWxwaGEgY2hhcmFjdGVycyAoc3BlY2lmaWNhbGx5IG5vdCBzdGFydGluZyB3aXRoICIjIiBvciAiPyIpCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lID4gIkAiIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCS8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiaW5wdXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJpbnB1dHMudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGF0dHI7CgkJCS8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQoJCQkvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgoJCQkJZWxlbS50eXBlID09PSAidGV4dCIgJiYKCQkJCSggKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gZWxlbS50eXBlICk7CgkJfSwKCgkJLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgoJCSJmaXJzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oKSB7CgkJCXJldHVybiBbIDAgXTsKCQl9KSwKCgkJImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwoJCX0pLAoKCQkiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXJldHVybiBbIGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgXTsKCQl9KSwKCgkJImV2ZW4iOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDE7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKCQkJZm9yICggOyAtLWkgPj0gMDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJndCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwoJCQlmb3IgKCA7ICsraSA8IGxlbmd0aDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSkKCX0KfTsKCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBBZGQgYnV0dG9uL2lucHV0IHR5cGUgcHNldWRvcwpmb3IgKCBpIGluIHsgcmFkaW86IHRydWUsIGNoZWNrYm94OiB0cnVlLCBmaWxlOiB0cnVlLCBwYXNzd29yZDogdHJ1ZSwgaW1hZ2U6IHRydWUgfSApIHsKCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsKfQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oIGkgKTsKfQoKLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCmZ1bmN0aW9uIHNldEZpbHRlcnMoKSB7fQpzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsKCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgcGFyc2VPbmx5ICkgewoJdmFyIG1hdGNoZWQsIG1hdGNoLCB0b2tlbnMsIHR5cGUsCgkJc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywKCQljYWNoZWQgPSB0b2tlbkNhY2hlWyBzZWxlY3RvciArICIgIiBdOwoKCWlmICggY2FjaGVkICkgewoJCXJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKCAwICk7Cgl9CgoJc29GYXIgPSBzZWxlY3RvcjsKCWdyb3VwcyA9IFtdOwoJcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwoKCXdoaWxlICggc29GYXIgKSB7CgoJCS8vIENvbW1hIGFuZCBmaXJzdCBydW4KCQlpZiAoICFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKCBzb0ZhciApKSApIHsKCQkJaWYgKCBtYXRjaCApIHsKCQkJCS8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaFswXS5sZW5ndGggKSB8fCBzb0ZhcjsKCQkJfQoJCQlncm91cHMucHVzaCggdG9rZW5zID0gW10gKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCXRva2Vucy5wdXNoKHsKCQkJCXZhbHVlOiBtYXRjaGVkLAoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQl0eXBlOiBtYXRjaFswXS5yZXBsYWNlKCBydHJpbSwgIiAiICkKCQkJfSk7CgkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJfQoKCQkvLyBGaWx0ZXJzCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKCQkJCXRva2Vucy5wdXNoKHsKCQkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCQl0eXBlOiB0eXBlLAoJCQkJCW1hdGNoZXM6IG1hdGNoCgkJCQl9KTsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJCX0KCQl9CgoJCWlmICggIW1hdGNoZWQgKSB7CgkJCWJyZWFrOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwoJLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCglyZXR1cm4gcGFyc2VPbmx5ID8KCQlzb0Zhci5sZW5ndGggOgoJCXNvRmFyID8KCQkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKCQkJLy8gQ2FjaGUgdGhlIHRva2VucwoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfQoKZnVuY3Rpb24gdG9TZWxlY3RvciggdG9rZW5zICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IHRva2Vucy5sZW5ndGgsCgkJc2VsZWN0b3IgPSAiIjsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCXNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKCX0KCXJldHVybiBzZWxlY3RvcjsKfQoKZnVuY3Rpb24gYWRkQ29tYmluYXRvciggbWF0Y2hlciwgY29tYmluYXRvciwgYmFzZSApIHsKCXZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwKCQljaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBkaXIgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCQkJfQoJCX0gOgoKCQkvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgZGF0YSwgY2FjaGUsIG91dGVyQ2FjaGUsCgkJCQlkaXJrZXkgPSBkaXJydW5zICsgIiAiICsgZG9uZU5hbWU7CgoJCQkvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBkaXIgY2FjaGluZwoJCQlpZiAoIHhtbCApIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCW91dGVyQ2FjaGUgPSBlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KTsKCQkJCQkJaWYgKCAoY2FjaGUgPSBvdXRlckNhY2hlWyBkaXIgXSkgJiYgY2FjaGVbMF0gPT09IGRpcmtleSApIHsKCQkJCQkJCWlmICggKGRhdGEgPSBjYWNoZVsxXSkgPT09IHRydWUgfHwgZGF0YSA9PT0gY2FjaGVkcnVucyApIHsKCQkJCQkJCQlyZXR1cm4gZGF0YSA9PT0gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0gPSBbIGRpcmtleSBdOwoJCQkJCQkJY2FjaGVbMV0gPSBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB8fCBjYWNoZWRydW5zOwoJCQkJCQkJaWYgKCBjYWNoZVsxXSA9PT0gdHJ1ZSApIHsKCQkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX07Cn0KCmZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApIHsKCXJldHVybiBtYXRjaGVycy5sZW5ndGggPiAxID8KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoICFtYXRjaGVyc1tpXSggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gOgoJCW1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewoJdmFyIGVsZW0sCgkJbmV3VW5tYXRjaGVkID0gW10sCgkJaSA9IDAsCgkJbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwKCQltYXBwZWQgPSBtYXAgIT0gbnVsbDsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQluZXdVbm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJaWYgKCBtYXBwZWQgKSB7CgkJCQkJbWFwLnB1c2goIGkgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CglpZiAoIHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbIGV4cGFuZG8gXSApIHsKCQlwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwoJfQoJaWYgKCBwb3N0RmluZGVyICYmICFwb3N0RmluZGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbmRlciA9IHNldE1hdGNoZXIoIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvciApOwoJfQoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewoJCXZhciB0ZW1wLCBpLCBlbGVtLAoJCQlwcmVNYXAgPSBbXSwKCQkJcG9zdE1hcCA9IFtdLAoJCQlwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAoKCQkJLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKCQkJZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFsgY29udGV4dCBdIDogY29udGV4dCwgW10gKSwKCgkJCS8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgoJCQltYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKCBzZWVkIHx8ICFzZWxlY3RvciApID8KCQkJCWNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKCQkJCWVsZW1zLAoKCQkJbWF0Y2hlck91dCA9IG1hdGNoZXIgPwoJCQkJLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKCQkJCXBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCgkJCQkJLy8gLi4uaW50ZXJtZWRpYXRlIHByb2Nlc3NpbmcgaXMgbmVjZXNzYXJ5CgkJCQkJW10gOgoKCQkJCQkvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKCQkJCQlyZXN1bHRzIDoKCQkJCW1hdGNoZXJJbjsKCgkJLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKCQlpZiAoIG1hdGNoZXIgKSB7CgkJCW1hdGNoZXIoIG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sICk7CgkJfQoKCQkvLyBBcHBseSBwb3N0RmlsdGVyCgkJaWYgKCBwb3N0RmlsdGVyICkgewoJCQl0ZW1wID0gY29uZGVuc2UoIG1hdGNoZXJPdXQsIHBvc3RNYXAgKTsKCQkJcG9zdEZpbHRlciggdGVtcCwgW10sIGNvbnRleHQsIHhtbCApOwoKCQkJLy8gVW4tbWF0Y2ggZmFpbGluZyBlbGVtZW50cyBieSBtb3ZpbmcgdGhlbSBiYWNrIHRvIG1hdGNoZXJJbgoJCQlpID0gdGVtcC5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAoZWxlbSA9IHRlbXBbaV0pICkgewoJCQkJCW1hdGNoZXJPdXRbIHBvc3RNYXBbaV0gXSA9ICEobWF0Y2hlckluWyBwb3N0TWFwW2ldIF0gPSBlbGVtKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBzZWVkICkgewoJCQlpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewoJCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJCS8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwoJCQkJCXRlbXAgPSBbXTsKCQkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKCQkJCQkJCS8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCgkJCQkJCQl0ZW1wLnB1c2goIChtYXRjaGVySW5baV0gPSBlbGVtKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKCQkJCX0KCgkJCQkvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAoJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCgkJCQkJCSh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKCQkJCQkJc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKCQl9IGVsc2UgewoJCQltYXRjaGVyT3V0ID0gY29uZGVuc2UoCgkJCQltYXRjaGVyT3V0ID09PSByZXN1bHRzID8KCQkJCQltYXRjaGVyT3V0LnNwbGljZSggcHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoICkgOgoJCQkJCW1hdGNoZXJPdXQKCQkJKTsKCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJcG9zdEZpbmRlciggbnVsbCwgcmVzdWx0cywgbWF0Y2hlck91dCwgeG1sICk7CgkJCX0gZWxzZSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBtYXRjaGVyT3V0ICk7CgkJCX0KCQl9Cgl9KTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucyApIHsKCXZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCgkJbGVuID0gdG9rZW5zLmxlbmd0aCwKCQlsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMF0udHlwZSBdLAoJCWltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAoJCWkgPSBsZWFkaW5nUmVsYXRpdmUgPyAxIDogMCwKCgkJLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKCQltYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksCgkJbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvciggZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQlyZXR1cm4gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCX0gXTsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CgkJCW1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLCBtYXRjaGVyKSBdOwoJCX0gZWxzZSB7CgkJCW1hdGNoZXIgPSBFeHByLmZpbHRlclsgdG9rZW5zW2ldLnR5cGUgXS5hcHBseSggbnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMgKTsKCgkJCS8vIFJldHVybiBzcGVjaWFsIHVwb24gc2VlaW5nIGEgcG9zaXRpb25hbCBtYXRjaGVyCgkJCWlmICggbWF0Y2hlclsgZXhwYW5kbyBdICkgewoJCQkJLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCgkJCQlqID0gKytpOwoJCQkJZm9yICggOyBqIDwgbGVuOyBqKysgKSB7CgkJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyB0b2tlbnNbal0udHlwZSBdICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gc2V0TWF0Y2hlcigKCQkJCQlpID4gMSAmJiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwKCQkJCQlpID4gMSAmJiB0b1NlbGVjdG9yKAoJCQkJCQkvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYAoJCQkJCQl0b2tlbnMuc2xpY2UoIDAsIGkgLSAxICkuY29uY2F0KHsgdmFsdWU6IHRva2Vuc1sgaSAtIDIgXS50eXBlID09PSAiICIgPyAiKiIgOiAiIiB9KQoJCQkJCSkucmVwbGFjZSggcnRyaW0sICIkMSIgKSwKCQkJCQltYXRjaGVyLAoJCQkJCWkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLAoJCQkJCWogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnMoICh0b2tlbnMgPSB0b2tlbnMuc2xpY2UoIGogKSkgKSwKCQkJCQlqIDwgbGVuICYmIHRvU2VsZWN0b3IoIHRva2VucyApCgkJCQkpOwoJCQl9CgkJCW1hdGNoZXJzLnB1c2goIG1hdGNoZXIgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7CgkvLyBBIGNvdW50ZXIgdG8gc3BlY2lmeSB3aGljaCBlbGVtZW50IGlzIGN1cnJlbnRseSBiZWluZyBtYXRjaGVkCgl2YXIgbWF0Y2hlckNhY2hlZFJ1bnMgPSAwLAoJCWJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBleHBhbmRDb250ZXh0ICkgewoJCQl2YXIgZWxlbSwgaiwgbWF0Y2hlciwKCQkJCXNldE1hdGNoZWQgPSBbXSwKCQkJCW1hdGNoZWRDb3VudCA9IDAsCgkJCQlpID0gIjAiLAoJCQkJdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKCQkJCW91dGVybW9zdCA9IGV4cGFuZENvbnRleHQgIT0gbnVsbCwKCQkJCWNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAoJCQkJLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBjb250ZXh0CgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgZXhwYW5kQ29udGV4dCAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dCApLAoJCQkJLy8gVXNlIGludGVnZXIgZGlycnVucyBpZmYgdGhpcyBpcyB0aGUgb3V0ZXJtb3N0IG1hdGNoZXIKCQkJCWRpcnJ1bnNVbmlxdWUgPSAoZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEpOwoKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCAhPT0gZG9jdW1lbnQgJiYgY29udGV4dDsKCQkJCWNhY2hlZHJ1bnMgPSBtYXRjaGVyQ2FjaGVkUnVuczsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJLy8gS2VlcCBgaWAgYSBzdHJpbmcgaWYgdGhlcmUgYXJlIG5vIGVsZW1lbnRzIHNvIGBtYXRjaGVkQ291bnRgIHdpbGwgYmUgIjAwIiBiZWxvdwoJCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggYnlFbGVtZW50ICYmIGVsZW0gKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwoJCQkJCQljYWNoZWRydW5zID0gKyttYXRjaGVyQ2FjaGVkUnVuczsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwoJCQkJaWYgKCBieVNldCApIHsKCQkJCQkvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCgkJCQkJaWYgKCAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pICkgewoJCQkJCQltYXRjaGVkQ291bnQtLTsKCQkJCQl9CgoJCQkJCS8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKCQkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJCXVubWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBBcHBseSBzZXQgZmlsdGVycyB0byB1bm1hdGNoZWQgZWxlbWVudHMKCQkJbWF0Y2hlZENvdW50ICs9IGk7CgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCgkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZiAoICEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pICkgewoJCQkJCQkJCXNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwoJCQkJCXNldE1hdGNoZWQgPSBjb25kZW5zZSggc2V0TWF0Y2hlZCApOwoJCQkJfQoKCQkJCS8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsKCgkJCQkvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgoJCQkJCSggbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoICkgPiAxICkgewoKCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwoJCQl9CgoJCQlyZXR1cm4gdW5tYXRjaGVkOwoJCX07CgoJcmV0dXJuIGJ5U2V0ID8KCQltYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKCQlzdXBlck1hdGNoZXI7Cn0KCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgZ3JvdXAgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7Cgl2YXIgaSwKCQlzZXRNYXRjaGVycyA9IFtdLAoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCAhY2FjaGVkICkgewoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJCWlmICggIWdyb3VwICkgewoJCQlncm91cCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoJCX0KCQlpID0gZ3JvdXAubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggZ3JvdXBbaV0gKTsKCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsKCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9CgkJfQoKCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KCQljYWNoZWQgPSBjb21waWxlckNhY2hlKCBzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgKTsKCX0KCXJldHVybiBjYWNoZWQ7Cn07CgpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7Cgl2YXIgaSA9IDAsCgkJbGVuID0gY29udGV4dHMubGVuZ3RoOwoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJU2l6emxlKCBzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMgKTsKCX0KCXJldHVybiByZXN1bHRzOwp9CgpmdW5jdGlvbiBzZWxlY3QoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJbWF0Y2ggPSB0b2tlbml6ZSggc2VsZWN0b3IgKTsKCglpZiAoICFzZWVkICkgewoJCS8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG9ubHkgb25lIGdyb3VwCgkJaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7CgoJCQkvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAoJCQl0b2tlbnMgPSBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwICk7CgkJCWlmICggdG9rZW5zLmxlbmd0aCA+IDIgJiYgKHRva2VuID0gdG9rZW5zWzBdKS50eXBlID09PSAiSUQiICYmCgkJCQkJc3VwcG9ydC5nZXRCeUlkICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYKCQkJCQlFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgewoKCQkJCWNvbnRleHQgPSAoIEV4cHIuZmluZFsiSUQiXSggdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgY29udGV4dCApIHx8IFtdIClbMF07CgkJCQlpZiAoICFjb250ZXh0ICkgewoJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJfQoJCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7CgkJCX0KCgkJCS8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKCQkJaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdCggc2VsZWN0b3IgKSA/IDAgOiB0b2tlbnMubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCXRva2VuID0gdG9rZW5zW2ldOwoKCQkJCS8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKCQkJCQkvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKCQkJCQlpZiAoIChzZWVkID0gZmluZCgKCQkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLAoJCQkJCQlyc2libGluZy50ZXN0KCB0b2tlbnNbMF0udHlwZSApICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0CgkJCQkJKSkgKSB7CgoJCQkJCQkvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKCQkJCQkJdG9rZW5zLnNwbGljZSggaSwgMSApOwoJCQkJCQlzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOwoJCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNlZWQgKTsKCQkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCQl9CgoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbgoJLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQoJY29tcGlsZSggc2VsZWN0b3IsIG1hdGNoICkoCgkJc2VlZCwKCQljb250ZXh0LAoJCSFkb2N1bWVudElzSFRNTCwKCQlyZXN1bHRzLAoJCXJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkKCSk7CglyZXR1cm4gcmVzdWx0czsKfQoKLy8gT25lLXRpbWUgYXNzaWdubWVudHMKCi8vIFNvcnQgc3RhYmlsaXR5CnN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoIiIpLnNvcnQoIHNvcnRPcmRlciApLmpvaW4oIiIpID09PSBleHBhbmRvOwoKLy8gU3VwcG9ydDogQ2hyb21lPDE0Ci8vIEFsd2F5cyBhc3N1bWUgZHVwbGljYXRlcyBpZiB0aGV5IGFyZW4ndCBwYXNzZWQgdG8gdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24Kc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gaGFzRHVwbGljYXRlOwoKLy8gSW5pdGlhbGl6ZSBhZ2FpbnN0IHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQovLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdjEgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBkaXYxLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCXJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiIDsKfSkgKSB7CglhZGRIYW5kbGUoICJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInR5cGUiID8gMSA6IDIgKTsKCQl9Cgl9KTsKfQoKLy8gU3VwcG9ydDogSUU8OQovLyBVc2UgZGVmYXVsdFZhbHVlIGluIHBsYWNlIG9mIGdldEF0dHJpYnV0ZSgidmFsdWUiKQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQvPiI7CglkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CglyZXR1cm4gZGl2LmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOwp9KSApIHsKCWFkZEhhbmRsZSggYm9vbGVhbnMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQl2YXIgdmFsOwoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQllbGVtWyBuYW1lIF0gPT09IHRydWUgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiBudWxsOwoJCX0KCX0pOwp9CgpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdLCBmdW5jdGlvbiggXywgZmxhZyApIHsKCQlvYmplY3RbIGZsYWcgXSA9IHRydWU7Cgl9KTsKCXJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKglvcHRpb25zOiBhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBvcHRpb25zIHRoYXQgd2lsbCBjaGFuZ2UgaG93CiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogKgogKiBCeSBkZWZhdWx0IGEgY2FsbGJhY2sgbGlzdCB3aWxsIGFjdCBsaWtlIGFuIGV2ZW50IGNhbGxiYWNrIGxpc3QgYW5kIGNhbiBiZQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogKgogKiBQb3NzaWJsZSBvcHRpb25zOgogKgogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogKgogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAqCiAqLwpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJLy8gQ29udmVydCBvcHRpb25zIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkIGlmIG5lZWRlZAoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/CgkJKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CgkJalF1ZXJ5LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQoJCW1lbW9yeSwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAoJCWZpcmVkLAoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKCQlmaXJpbmcsCgkJLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCgkJZmlyaW5nU3RhcnQsCgkJLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCgkJZmlyaW5nTGVuZ3RoLAoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCgkJZmlyaW5nSW5kZXgsCgkJLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKCQlsaXN0ID0gW10sCgkJLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwoJCXN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKCQkvLyBGaXJlIGNhbGxiYWNrcwoJCWZpcmUgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJbWVtb3J5ID0gb3B0aW9ucy5tZW1vcnkgJiYgZGF0YTsKCQkJZmlyZWQgPSB0cnVlOwoJCQlmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CgkJCWZpcmluZ1N0YXJ0ID0gMDsKCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCWZpcmluZyA9IHRydWU7CgkJCWZvciAoIDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKyApIHsKCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggZGF0YVsgMCBdLCBkYXRhWyAxIF0gKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSApIHsKCQkJCQltZW1vcnkgPSBmYWxzZTsgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWZpcmluZyA9IGZhbHNlOwoJCQlpZiAoIGxpc3QgKSB7CgkJCQlpZiAoIHN0YWNrICkgewoJCQkJCWlmICggc3RhY2subGVuZ3RoICkgewoJCQkJCQlmaXJlKCBzdGFjay5zaGlmdCgpICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCWxpc3QgPSBbXTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCX0KCQl9LAoJCS8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CgkJc2VsZiA9IHsKCQkJLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAoJCQlhZGQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCS8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAoJCQkJCXZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwoJCQkJCShmdW5jdGlvbiBhZGQoIGFyZ3MgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCBhcmdzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQkJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggYXJnICk7CgkJCQkJCQlpZiAoIHR5cGUgPT09ICJmdW5jdGlvbiIgKSB7CgkJCQkJCQkJaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKCQkJCQkJCQkJbGlzdC5wdXNoKCBhcmcgKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJCQkJCQkvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CgkJCQkJCQkJYWRkKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfSkoIGFyZ3VtZW50cyApOwoJCQkJCS8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCgkJCQkJLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQkJCS8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KCQkJCQkvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CgkJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCQlmaXJpbmdTdGFydCA9IHN0YXJ0OwoJCQkJCQlmaXJlKCBtZW1vcnkgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCWpRdWVyeS5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCXZhciBpbmRleDsKCQkJCQkJd2hpbGUoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0xlbmd0aCApIHsKCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07CgkJCQkJCQkJfQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KCQkJLy8gSWYgbm8gYXJndW1lbnQgaXMgZ2l2ZW4sIHJldHVybiB3aGV0aGVyIG9yIG5vdCBsaXN0IGhhcyBjYWxsYmFja3MgYXR0YWNoZWQuCgkJCWhhczogZnVuY3Rpb24oIGZuICkgewoJCQkJcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoIGZuLCBsaXN0ICkgPiAtMSA6ICEhKCBsaXN0ICYmIGxpc3QubGVuZ3RoICk7CgkJCX0sCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IFtdOwoJCQkJZmlyaW5nTGVuZ3RoID0gMDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQoJCQlkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQkJCWxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBkaXNhYmxlZD8KCQkJZGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFsaXN0OwoJCQl9LAoJCQkvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCgkJCWxvY2s6IGZ1bmN0aW9uKCkgewoJCQkJc3RhY2sgPSB1bmRlZmluZWQ7CgkJCQlpZiAoICFtZW1vcnkgKSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gSXMgaXQgbG9ja2VkPwoJCQlsb2NrZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFzdGFjazsKCQkJfSwKCQkJLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwoJCQlmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7CgkJCQlpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsKCQkJCQlhcmdzID0gYXJncyB8fCBbXTsKCQkJCQlhcmdzID0gWyBjb250ZXh0LCBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncyBdOwoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlzdGFjay5wdXNoKCBhcmdzICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmlyZSggYXJncyApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwoJCQlmaXJlOiBmdW5jdGlvbigpIHsKCQkJCXNlbGYuZmlyZVdpdGgoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKCURlZmVycmVkOiBmdW5jdGlvbiggZnVuYyApIHsKCQl2YXIgdHVwbGVzID0gWwoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCgkJCQlbICJyZXNvbHZlIiwgImRvbmUiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVzb2x2ZWQiIF0sCgkJCQlbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKCQkJCVsgIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpIF0KCQkJXSwKCQkJc3RhdGUgPSAicGVuZGluZyIsCgkJCXByb21pc2UgPSB7CgkJCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlOwoJCQkJfSwKCQkJCWFsd2F5czogZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewoJCQkJCXZhciBmbnMgPSBhcmd1bWVudHM7CgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJCQkJCXZhciBhY3Rpb24gPSB0dXBsZVsgMCBdLAoJCQkJCQkJCWZuID0galF1ZXJ5LmlzRnVuY3Rpb24oIGZuc1sgaSBdICkgJiYgZm5zWyBpIF07CgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKCQkJCQkJCWRlZmVycmVkWyB0dXBsZVsxXSBdKGZ1bmN0aW9uKCkgewoJCQkJCQkJCXZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7CgkJCQkJCQkJCXJldHVybmVkLnByb21pc2UoKQoJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCgkJCQkJCQkJCQkucHJvZ3Jlc3MoIG5ld0RlZmVyLm5vdGlmeSApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CgkJCQkJCQkJfQoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCQlmbnMgPSBudWxsOwoJCQkJCX0pLnByb21pc2UoKTsKCQkJCX0sCgkJCQkvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewoJCQkJCXJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQoIG9iaiwgcHJvbWlzZSApIDogcHJvbWlzZTsKCQkJCX0KCQkJfSwKCQkJZGVmZXJyZWQgPSB7fTsKCgkJLy8gS2VlcCBwaXBlIGZvciBiYWNrLWNvbXBhdAoJCXByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwoJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLAoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKCQkJLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKCQkJcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKCQkJLy8gSGFuZGxlIHN0YXRlCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7CgkJCQlsaXN0LmFkZChmdW5jdGlvbigpIHsKCQkJCQkvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCgkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsKCgkJCQkvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCgkJCQl9LCB0dXBsZXNbIGkgXiAxIF1bIDIgXS5kaXNhYmxlLCB0dXBsZXNbIDIgXVsgMiBdLmxvY2sgKTsKCQkJfQoKCQkJLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gXSA9IGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWRbIHR1cGxlWzBdICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX07CgkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9KTsKCgkJLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKCQkvLyBDYWxsIGdpdmVuIGZ1bmMgaWYgYW55CgkJaWYgKCBmdW5jICkgewoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOwoJCX0KCgkJLy8gQWxsIGRvbmUhCgkJcmV0dXJuIGRlZmVycmVkOwoJfSwKCgkvLyBEZWZlcnJlZCBoZWxwZXIKCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgewoJCXZhciBpID0gMCwKCQkJcmVzb2x2ZVZhbHVlcyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLAoKCQkJLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwoJCQlyZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLAoKCQkJLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCgkJCWRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwKCgkJCS8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKCQkJdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQljb250ZXh0c1sgaSBdID0gdGhpczsKCQkJCQl2YWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOwoJCQkJCWlmKCB2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzICkgewoJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9LAoKCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCgkJLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAoJCWlmICggbGVuZ3RoID4gMSApIHsKCQkJcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UgKSApIHsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpCgkJCQkJCS5kb25lKCB1cGRhdGVGdW5jKCBpLCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKSApCgkJCQkJCS5mYWlsKCBkZWZlcnJlZC5yZWplY3QgKQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLS1yZW1haW5pbmc7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKCQlpZiAoICFyZW1haW5pbmcgKSB7CgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Cn0pOwpqUXVlcnkuc3VwcG9ydCA9IChmdW5jdGlvbiggc3VwcG9ydCApIHsKCXZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0IiksCgkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0IiksCgkJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApOwoKCS8vIEZpbmlzaCBlYXJseSBpbiBsaW1pdGVkIGVudmlyb25tZW50cwoJaWYgKCAhaW5wdXQudHlwZSApIHsKCQlyZXR1cm4gc3VwcG9ydDsKCX0KCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsKCgkvLyBTdXBwb3J0OiBTYWZhcmkgNS4xLCBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKCS8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBvbGQgV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKCXN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAiIjsKCgkvLyBNdXN0IGFjY2VzcyB0aGUgcGFyZW50IHRvIG1ha2UgYW4gb3B0aW9uIHNlbGVjdCBwcm9wZXJseQoJLy8gU3VwcG9ydDogSUU5LCBJRTEwCglzdXBwb3J0Lm9wdFNlbGVjdGVkID0gb3B0LnNlbGVjdGVkOwoKCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0gdHJ1ZTsKCXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSB0cnVlOwoJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gZmFsc2U7CgoJLy8gTWFrZSBzdXJlIGNoZWNrZWQgc3RhdHVzIGlzIHByb3Blcmx5IGNsb25lZAoJLy8gU3VwcG9ydDogSUU5LCBJRTEwCglpbnB1dC5jaGVja2VkID0gdHJ1ZTsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSBpbnB1dC5jbG9uZU5vZGUoIHRydWUgKS5jaGVja2VkOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KCS8vIFN1cHBvcnQ6IElFOSwgSUUxMAoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC50eXBlID0gInJhZGlvIjsKCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgInQiICk7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7CgoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGlucHV0ICk7CgoJLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCgkvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBmcmFnbWVudC5jbG9uZU5vZGUoIHRydWUgKS5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBTdXBwb3J0OiBGaXJlZm94LCBDaHJvbWUsIFNhZmFyaQoJLy8gQmV3YXJlIG9mIENTUCByZXN0cmljdGlvbnMgKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkKCXN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgPSAib25mb2N1c2luIiBpbiB3aW5kb3c7CgoJZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsKCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiOwoJc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CgoJLy8gUnVuIHRlc3RzIHRoYXQgbmVlZCBhIGJvZHkgYXQgZG9jIHJlYWR5CglqUXVlcnkoZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciwgbWFyZ2luRGl2LAoJCQkvLyBTdXBwb3J0OiBGaXJlZm94LCBBbmRyb2lkIDIuMyAoUHJlZml4ZWQgYm94LXNpemluZyB2ZXJzaW9ucykuCgkJCWRpdlJlc2V0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5OmJsb2NrOy13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7Ym94LXNpemluZzpjb250ZW50LWJveCIsCgkJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWyAwIF07CgoJCWlmICggIWJvZHkgKSB7CgkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJCXJldHVybjsKCQl9CgoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gImJvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDotOTk5OXB4O21hcmdpbi10b3A6MXB4IjsKCgkJLy8gQ2hlY2sgYm94LXNpemluZyBhbmQgbWFyZ2luIGJlaGF2aW9yLgoJCWJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCQlkaXYuaW5uZXJIVE1MID0gIiI7CgkJLy8gU3VwcG9ydDogRmlyZWZveCwgQW5kcm9pZCAyLjMgKFByZWZpeGVkIGJveC1zaXppbmcgdmVyc2lvbnMpLgoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gIi13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94O2JveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElIjsKCgkJLy8gV29ya2Fyb3VuZCBmYWlsaW5nIGJveFNpemluZyB0ZXN0IGR1ZSB0byBvZmZzZXRXaWR0aCByZXR1cm5pbmcgd3JvbmcgdmFsdWUKCQkvLyB3aXRoIHNvbWUgbm9uLTEgdmFsdWVzIG9mIGJvZHkgem9vbSwgdGlja2V0ICMxMzU0MwoJCWpRdWVyeS5zd2FwKCBib2R5LCBib2R5LnN0eWxlLnpvb20gIT0gbnVsbCA/IHsgem9vbTogMSB9IDoge30sIGZ1bmN0aW9uKCkgewoJCQlzdXBwb3J0LmJveFNpemluZyA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDsKCQl9KTsKCgkJLy8gVXNlIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlIGJlY2F1c2UganNkb20gb24gbm9kZS5qcyB3aWxsIGJyZWFrIHdpdGhvdXQgaXQuCgkJaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQkJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7CgkJCXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCQkJLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQoJCQkvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCW1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCQkJbWFyZ2luRGl2LnN0eWxlLmNzc1RleHQgPSBkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0OwoJCQltYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CgkJCWRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoKCQkJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KCQkJCSFwYXJzZUZsb2F0KCAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBtYXJnaW5EaXYsIG51bGwgKSB8fCB7fSApLm1hcmdpblJpZ2h0ICk7CgkJfQoKCQlib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCX0pOwoKCXJldHVybiBzdXBwb3J0Owp9KSgge30gKTsKCi8qCglJbXBsZW1lbnRhdGlvbiBTdW1tYXJ5CgoJMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAoJMi4gSW1wcm92ZSB0aGUgbW9kdWxlJ3MgbWFpbnRhaW5hYmlsaXR5IGJ5IHJlZHVjaW5nIHRoZSBzdG9yYWdlCgkJcGF0aHMgdG8gYSBzaW5nbGUgbWVjaGFuaXNtLgoJMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgoJNC4gX05ldmVyXyBleHBvc2UgInByaXZhdGUiIGRhdGEgdG8gdXNlciBjb2RlIChUT0RPOiBEcm9wIF9kYXRhLCBfcmVtb3ZlRGF0YSkKCTUuIEF2b2lkIGV4cG9zaW5nIGltcGxlbWVudGF0aW9uIGRldGFpbHMgb24gdXNlciBvYmplY3RzIChlZy4gZXhwYW5kbyBwcm9wZXJ0aWVzKQoJNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0CiovCnZhciBkYXRhX3VzZXIsIGRhdGFfcHJpdiwKCXJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKCXJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwoKZnVuY3Rpb24gRGF0YSgpIHsKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LAoJLy8gT2xkIFdlYktpdCBkb2VzIG5vdCBoYXZlIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucy9mcmVlemUgbWV0aG9kLAoJLy8gcmV0dXJuIG5ldyBlbXB0eSBvYmplY3QgaW5zdGVhZCB3aXRoIG5vIFtbc2V0XV0gYWNjZXNzb3IKCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5jYWNoZSA9IHt9LCAwLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHt9OwoJCX0KCX0pOwoKCXRoaXMuZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvICsgTWF0aC5yYW5kb20oKTsKfQoKRGF0YS51aWQgPSAxOwoKRGF0YS5hY2NlcHRzID0gZnVuY3Rpb24oIG93bmVyICkgewoJLy8gQWNjZXB0cyBvbmx5OgoJLy8gIC0gTm9kZQoJLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQoJLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKCS8vICAtIE9iamVjdAoJLy8gICAgLSBBbnkKCXJldHVybiBvd25lci5ub2RlVHlwZSA/CgkJb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgOiB0cnVlOwp9OwoKRGF0YS5wcm90b3R5cGUgPSB7CglrZXk6IGZ1bmN0aW9uKCBvd25lciApIHsKCQkvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKCQkvLyBidXQgd2Ugc2hvdWxkIG5vdCwgc2VlICM4MzM1LgoJCS8vIEFsd2F5cyByZXR1cm4gdGhlIGtleSBmb3IgYSBmcm96ZW4gb2JqZWN0LgoJCWlmICggIURhdGEuYWNjZXB0cyggb3duZXIgKSApIHsKCQkJcmV0dXJuIDA7CgkJfQoKCQl2YXIgZGVzY3JpcHRvciA9IHt9LAoJCQkvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUga2V5CgkJCXVubG9jayA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCgkJLy8gSWYgbm90LCBjcmVhdGUgb25lCgkJaWYgKCAhdW5sb2NrICkgewoJCQl1bmxvY2sgPSBEYXRhLnVpZCsrOwoKCQkJLy8gU2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUsIG5vbi13cml0YWJsZSBwcm9wZXJ0eQoJCQl0cnkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB7IHZhbHVlOiB1bmxvY2sgfTsKCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKCBvd25lciwgZGVzY3JpcHRvciApOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQKCQkJLy8gRmFsbGJhY2sgdG8gYSBsZXNzIHNlY3VyZSBkZWZpbml0aW9uCgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB1bmxvY2s7CgkJCQlqUXVlcnkuZXh0ZW5kKCBvd25lciwgZGVzY3JpcHRvciApOwoJCQl9CgkJfQoKCQkvLyBFbnN1cmUgdGhlIGNhY2hlIG9iamVjdAoJCWlmICggIXRoaXMuY2FjaGVbIHVubG9jayBdICkgewoJCQl0aGlzLmNhY2hlWyB1bmxvY2sgXSA9IHt9OwoJCX0KCgkJcmV0dXJuIHVubG9jazsKCX0sCglzZXQ6IGZ1bmN0aW9uKCBvd25lciwgZGF0YSwgdmFsdWUgKSB7CgkJdmFyIHByb3AsCgkJCS8vIFRoZXJlIG1heSBiZSBhbiB1bmxvY2sgYXNzaWduZWQgdG8gdGhpcyBub2RlLAoJCQkvLyBpZiB0aGVyZSBpcyBubyBlbnRyeSBmb3IgdGhpcyAib3duZXIiLCBjcmVhdGUgb25lIGlubGluZQoJCQkvLyBhbmQgc2V0IHRoZSB1bmxvY2sgYXMgdGhvdWdoIGFuIG93bmVyIGVudHJ5IGhhZCBhbHdheXMgZXhpc3RlZAoJCQl1bmxvY2sgPSB0aGlzLmtleSggb3duZXIgKSwKCQkJY2FjaGUgPSB0aGlzLmNhY2hlWyB1bmxvY2sgXTsKCgkJLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQljYWNoZVsgZGF0YSBdID0gdmFsdWU7CgoJCS8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCgkJfSBlbHNlIHsKCQkJLy8gRnJlc2ggYXNzaWdubWVudHMgYnkgb2JqZWN0IGFyZSBzaGFsbG93IGNvcGllZAoJCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBjYWNoZSApICkgewoJCQkJalF1ZXJ5LmV4dGVuZCggdGhpcy5jYWNoZVsgdW5sb2NrIF0sIGRhdGEgKTsKCQkJLy8gT3RoZXJ3aXNlLCBjb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAoJCQl9IGVsc2UgewoJCQkJZm9yICggcHJvcCBpbiBkYXRhICkgewoJCQkJCWNhY2hlWyBwcm9wIF0gPSBkYXRhWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlOwoJfSwKCWdldDogZnVuY3Rpb24oIG93bmVyLCBrZXkgKSB7CgkJLy8gRWl0aGVyIGEgdmFsaWQgY2FjaGUgaXMgZm91bmQsIG9yIHdpbGwgYmUgY3JlYXRlZC4KCQkvLyBOZXcgY2FjaGVzIHdpbGwgYmUgY3JlYXRlZCBhbmQgdGhlIHVubG9jayByZXR1cm5lZCwKCQkvLyBhbGxvd2luZyBkaXJlY3QgYWNjZXNzIHRvIHRoZSBuZXdseSBjcmVhdGVkCgkJLy8gZW1wdHkgZGF0YSBvYmplY3QuIEEgdmFsaWQgb3duZXIgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuCgkJdmFyIGNhY2hlID0gdGhpcy5jYWNoZVsgdGhpcy5rZXkoIG93bmVyICkgXTsKCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkID8KCQkJY2FjaGUgOiBjYWNoZVsga2V5IF07Cgl9LAoJYWNjZXNzOiBmdW5jdGlvbiggb3duZXIsIGtleSwgdmFsdWUgKSB7CgkJdmFyIHN0b3JlZDsKCQkvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCgkJLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCgkJLy8KCQkvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCgkJLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAoJCS8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKCQkvLwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgfHwKCQkJCSgoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciKSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSApIHsKCgkJCXN0b3JlZCA9IHRoaXMuZ2V0KCBvd25lciwga2V5ICk7CgoJCQlyZXR1cm4gc3RvcmVkICE9PSB1bmRlZmluZWQgPwoJCQkJc3RvcmVkIDogdGhpcy5nZXQoIG93bmVyLCBqUXVlcnkuY2FtZWxDYXNlKGtleSkgKTsKCQl9CgoJCS8vIFsqXVdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCgkJLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCgkJLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKCQkvLwoJCXRoaXMuc2V0KCBvd25lciwga2V5LCB2YWx1ZSApOwoKCQkvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCgkJLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdCgkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKCX0sCglyZW1vdmU6IGZ1bmN0aW9uKCBvd25lciwga2V5ICkgewoJCXZhciBpLCBuYW1lLCBjYW1lbCwKCQkJdW5sb2NrID0gdGhpcy5rZXkoIG93bmVyICksCgkJCWNhY2hlID0gdGhpcy5jYWNoZVsgdW5sb2NrIF07CgoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuY2FjaGVbIHVubG9jayBdID0ge307CgoJCX0gZWxzZSB7CgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzCgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIGtleSApICkgewoJCQkJLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KCQkJCS8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwKCQkJCS8vIGtleXMgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2FtZWxDYXNlLgoJCQkJLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKCQkJCS8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYKCQkJCS8vIFRoaXMgd2lsbCBvbmx5IHBlbmFsaXplIHRoZSBhcnJheSBhcmd1bWVudCBwYXRoLgoJCQkJbmFtZSA9IGtleS5jb25jYXQoIGtleS5tYXAoIGpRdWVyeS5jYW1lbENhc2UgKSApOwoJCQl9IGVsc2UgewoJCQkJY2FtZWwgPSBqUXVlcnkuY2FtZWxDYXNlKCBrZXkgKTsKCQkJCS8vIFRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uCgkJCQlpZiAoIGtleSBpbiBjYWNoZSApIHsKCQkJCQluYW1lID0gWyBrZXksIGNhbWVsIF07CgkJCQl9IGVsc2UgewoJCQkJCS8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KCQkJCQkvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQoJCQkJCW5hbWUgPSBjYW1lbDsKCQkJCQluYW1lID0gbmFtZSBpbiBjYWNoZSA/CgkJCQkJCVsgbmFtZSBdIDogKCBuYW1lLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdICk7CgkJCQl9CgkJCX0KCgkJCWkgPSBuYW1lLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlkZWxldGUgY2FjaGVbIG5hbWVbIGkgXSBdOwoJCQl9CgkJfQoJfSwKCWhhc0RhdGE6IGZ1bmN0aW9uKCBvd25lciApIHsKCQlyZXR1cm4gIWpRdWVyeS5pc0VtcHR5T2JqZWN0KAoJCQl0aGlzLmNhY2hlWyBvd25lclsgdGhpcy5leHBhbmRvIF0gXSB8fCB7fQoJCSk7Cgl9LAoJZGlzY2FyZDogZnVuY3Rpb24oIG93bmVyICkgewoJCWlmICggb3duZXJbIHRoaXMuZXhwYW5kbyBdICkgewoJCQlkZWxldGUgdGhpcy5jYWNoZVsgb3duZXJbIHRoaXMuZXhwYW5kbyBdIF07CgkJfQoJfQp9OwoKLy8gVGhlc2UgbWF5IGJlIHVzZWQgdGhyb3VnaG91dCB0aGUgalF1ZXJ5IGNvcmUgY29kZWJhc2UKZGF0YV91c2VyID0gbmV3IERhdGEoKTsKZGF0YV9wcml2ID0gbmV3IERhdGEoKTsKCgpqUXVlcnkuZXh0ZW5kKHsKCWFjY2VwdERhdGE6IERhdGEuYWNjZXB0cywKCgloYXNEYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZGF0YV91c2VyLmhhc0RhdGEoIGVsZW0gKSB8fCBkYXRhX3ByaXYuaGFzRGF0YSggZWxlbSApOwoJfSwKCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4gZGF0YV91c2VyLmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlkYXRhX3VzZXIucmVtb3ZlKCBlbGVtLCBuYW1lICk7Cgl9LAoKCS8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCgkvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhX3ByaXYgbWV0aG9kcywgdGhlc2UgY2FuIGJlIGRlcHJlY2F0ZWQuCglfZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIG5hbWUsIGRhdGEgKTsKCX0sCgoJX3JlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWRhdGFfcHJpdi5yZW1vdmUoIGVsZW0sIG5hbWUgKTsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBhdHRycywgbmFtZSwKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJaSA9IDAsCgkJCWRhdGEgPSBudWxsOwoKCQkvLyBHZXRzIGFsbCB2YWx1ZXMKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQkJZGF0YSA9IGRhdGFfdXNlci5nZXQoIGVsZW0gKTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFfcHJpdi5nZXQoIGVsZW0sICJoYXNEYXRhQXR0cnMiICkgKSB7CgkJCQkJYXR0cnMgPSBlbGVtLmF0dHJpYnV0ZXM7CgkJCQkJZm9yICggOyBpIDwgYXR0cnMubGVuZ3RoOyBpKysgKSB7CgkJCQkJCW5hbWUgPSBhdHRyc1sgaSBdLm5hbWU7CgoJCQkJCQlpZiAoIG5hbWUuaW5kZXhPZiggImRhdGEtIiApID09PSAwICkgewoJCQkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUuc2xpY2UoNSkgKTsKCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlkYXRhX3ByaXYuc2V0KCBlbGVtLCAiaGFzRGF0YUF0dHJzIiwgdHJ1ZSApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZGF0YTsKCQl9CgoJCS8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWRhdGFfdXNlci5zZXQoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBkYXRhLAoJCQkJY2FtZWxLZXkgPSBqUXVlcnkuY2FtZWxDYXNlKCBrZXkgKTsKCgkJCS8vIFRoZSBjYWxsaW5nIGpRdWVyeSBvYmplY3QgKGVsZW1lbnQgbWF0Y2hlcykgaXMgbm90IGVtcHR5CgkJCS8vIChhbmQgdGhlcmVmb3JlIGhhcyBhbiBlbGVtZW50IGFwcGVhcnMgYXQgdGhpc1sgMCBdKSBhbmQgdGhlCgkJCS8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CgkJCS8vIHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGZvciBlbGVtID0gdGhpc1sgMCBdIHdoaWNoIHdpbGwKCQkJLy8gdGhyb3cgYW4gZXhjZXB0aW9uIGlmIGFuIGF0dGVtcHQgdG8gcmVhZCBhIGRhdGEgY2FjaGUgaXMgbWFkZS4KCQkJaWYgKCBlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCgkJCQkvLyB3aXRoIHRoZSBrZXkgYXMtaXMKCQkJCWRhdGEgPSBkYXRhX3VzZXIuZ2V0KCBlbGVtLCBrZXkgKTsKCQkJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBkYXRhOwoJCQkJfQoKCQkJCS8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKCQkJCS8vIHdpdGggdGhlIGtleSBjYW1lbGl6ZWQKCQkJCWRhdGEgPSBkYXRhX3VzZXIuZ2V0KCBlbGVtLCBjYW1lbEtleSApOwoJCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9CgoJCQkJLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCgkJCQkvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCgkJCQlkYXRhID0gZGF0YUF0dHIoIGVsZW0sIGNhbWVsS2V5LCB1bmRlZmluZWQgKTsKCQkJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBkYXRhOwoJCQkJfQoKCQkJCS8vIFdlIHRyaWVkIHJlYWxseSBoYXJkLCBidXQgdGhlIGRhdGEgZG9lc24ndCBleGlzdC4KCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU2V0IHRoZSBkYXRhLi4uCgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCS8vIEZpcnN0LCBhdHRlbXB0IHRvIHN0b3JlIGEgY29weSBvciByZWZlcmVuY2Ugb2YgYW55CgkJCQkvLyBkYXRhIHRoYXQgbWlnaHQndmUgYmVlbiBzdG9yZSB3aXRoIGEgY2FtZWxDYXNlZCBrZXkuCgkJCQl2YXIgZGF0YSA9IGRhdGFfdXNlci5nZXQoIHRoaXMsIGNhbWVsS2V5ICk7CgoJCQkJLy8gRm9yIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUgaW50ZXJvcCwgd2UgaGF2ZSB0bwoJCQkJLy8gc3RvcmUgcHJvcGVydHkgbmFtZXMgd2l0aCBkYXNoZXMgaW4gYSBjYW1lbENhc2UgZm9ybS4KCQkJCS8vIFRoaXMgbWlnaHQgbm90IGFwcGx5IHRvIGFsbCBwcm9wZXJ0aWVzLi4uKgoJCQkJZGF0YV91c2VyLnNldCggdGhpcywgY2FtZWxLZXksIHZhbHVlICk7CgoJCQkJLy8gKi4uLiBJbiB0aGUgY2FzZSBvZiBwcm9wZXJ0aWVzIHRoYXQgbWlnaHQgX2FjdHVhbGx5XwoJCQkJLy8gaGF2ZSBkYXNoZXMsIHdlIG5lZWQgdG8gYWxzbyBzdG9yZSBhIGNvcHkgb2YgdGhhdAoJCQkJLy8gdW5jaGFuZ2VkIHByb3BlcnR5LgoJCQkJaWYgKCBrZXkuaW5kZXhPZigiLSIpICE9PSAtMSAmJiBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJZGF0YV91c2VyLnNldCggdGhpcywga2V5LCB2YWx1ZSApOwoJCQkJfQoJCQl9KTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIHRydWUgKTsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlkYXRhX3VzZXIucmVtb3ZlKCB0aGlzLCBrZXkgKTsKCQl9KTsKCX0KfSk7CgpmdW5jdGlvbiBkYXRhQXR0ciggZWxlbSwga2V5LCBkYXRhICkgewoJdmFyIG5hbWU7CgoJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQoJLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCglpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCW5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCXRyeSB7CgkJCQlkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CgkJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQkJCQlkYXRhID09PSAibnVsbCIgPyBudWxsIDoKCQkJCQkvLyBPbmx5IGNvbnZlcnQgdG8gYSBudW1iZXIgaWYgaXQgZG9lc24ndCBjaGFuZ2UgdGhlIHN0cmluZwoJCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CgkJCQkJcmJyYWNlLnRlc3QoIGRhdGEgKSA/IEpTT04ucGFyc2UoIGRhdGEgKSA6CgkJCQkJZGF0YTsKCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKCQkJZGF0YV91c2VyLnNldCggZWxlbSwga2V5LCBkYXRhICk7CgkJfSBlbHNlIHsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9Cgl9CglyZXR1cm4gZGF0YTsKfQpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQl2YXIgcXVldWU7CgoJCWlmICggZWxlbSApIHsKCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwoJCQlxdWV1ZSA9IGRhdGFfcHJpdi5nZXQoIGVsZW0sIHR5cGUgKTsKCgkJCS8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKCQkJaWYgKCBkYXRhICkgewoJCQkJaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoIGRhdGEgKSApIHsKCQkJCQlxdWV1ZSA9IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoZGF0YSkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJcXVldWUucHVzaCggZGF0YSApOwoJCQkJfQoJCQl9CgkJCXJldHVybiBxdWV1ZSB8fCBbXTsKCQl9Cgl9LAoKCWRlcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggZWxlbSwgdHlwZSApLAoJCQlzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpLAoJCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgdHlwZSApLAoJCQluZXh0ID0gZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwoJCQl9OwoKCQkvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsCgkJaWYgKCBmbiA9PT0gImlucHJvZ3Jlc3MiICkgewoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCk7CgkJCXN0YXJ0TGVuZ3RoLS07CgkJfQoKCQlpZiAoIGZuICkgewoKCQkJLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZwoJCQkvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCgkJCWlmICggdHlwZSA9PT0gImZ4IiApIHsKCQkJCXF1ZXVlLnVuc2hpZnQoICJpbnByb2dyZXNzIiApOwoJCQl9CgoJCQkvLyBjbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uCgkJCWRlbGV0ZSBob29rcy5zdG9wOwoJCQlmbi5jYWxsKCBlbGVtLCBuZXh0LCBob29rcyApOwoJCX0KCgkJaWYgKCAhc3RhcnRMZW5ndGggJiYgaG9va3MgKSB7CgkJCWhvb2tzLmVtcHR5LmZpcmUoKTsKCQl9Cgl9LAoKCS8vIG5vdCBpbnRlbmRlZCBmb3IgcHVibGljIGNvbnN1bXB0aW9uIC0gZ2VuZXJhdGVzIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybnMgdGhlIGN1cnJlbnQgb25lCglfcXVldWVIb29rczogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdmFyIGtleSA9IHR5cGUgKyAicXVldWVIb29rcyI7CgkJcmV0dXJuIGRhdGFfcHJpdi5nZXQoIGVsZW0sIGtleSApIHx8IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIGtleSwgewoJCQllbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24oKSB7CgkJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCBbIHR5cGUgKyAicXVldWUiLCBrZXkgXSApOwoJCQl9KQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CgkJCXRoaXMgOgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWzBdICE9PSAiaW5wcm9ncmVzcyIgKSB7CgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJCX0KCQkJfSk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9KTsKCX0sCgkvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCgkvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCglkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CgkJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQkJaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJCX07CgkJfSk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCgkvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJdmFyIHRtcCwKCQkJY291bnQgPSAxLAoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQllbGVtZW50cyA9IHRoaXMsCgkJCWkgPSB0aGlzLmxlbmd0aCwKCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7CgkJCQkJZGVmZXIucmVzb2x2ZVdpdGgoIGVsZW1lbnRzLCBbIGVsZW1lbnRzIF0gKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXdoaWxlKCBpLS0gKSB7CgkJCXRtcCA9IGRhdGFfcHJpdi5nZXQoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsKCQkJaWYgKCB0bXAgJiYgdG1wLmVtcHR5ICkgewoJCQkJY291bnQrKzsKCQkJCXRtcC5lbXB0eS5hZGQoIHJlc29sdmUgKTsKCQkJfQoJCX0KCQlyZXNvbHZlKCk7CgkJcmV0dXJuIGRlZmVyLnByb21pc2UoIG9iaiApOwoJfQp9KTsKdmFyIG5vZGVIb29rLCBib29sSG9vaywKCXJjbGFzcyA9IC9bXHRcclxuXGZdL2csCglycmV0dXJuID0gL1xyL2csCglyZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSk7Cgl9LAoKCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlkZWxldGUgdGhpc1sgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lIF07CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosCgkJCWkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aCwKCQkJcHJvY2VlZCA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWU7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5hZGRDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwoJCQl9KTsKCQl9CgoJCWlmICggcHJvY2VlZCApIHsKCQkJLy8gVGhlIGRpc2p1bmN0aW9uIGhlcmUgaXMgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSByZW1vdmVDbGFzcykKCQkJY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCBlbGVtLmNsYXNzTmFtZSA/CgkJCQkJKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgoJCQkJCSIgIgoJCQkJKTsKCgkJCQlpZiAoIGN1ciApIHsKCQkJCQlqID0gMDsKCQkJCQl3aGlsZSAoIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgKSB7CgkJCQkJCWlmICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPCAwICkgewoJCQkJCQkJY3VyICs9IGNsYXp6ICsgIiAiOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oIGN1ciApOwoKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosCgkJCWkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aCwKCQkJcHJvY2VlZCA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSApICk7CgkJCX0pOwoJCX0KCQlpZiAoIHByb2NlZWQgKSB7CgkJCWNsYXNzZXMgPSAoIHZhbHVlIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgkJCQkvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQoJCQkJY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIGVsZW0uY2xhc3NOYW1lID8KCQkJCQkoICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiICkucmVwbGFjZSggcmNsYXNzLCAiICIgKSA6CgkJCQkJIiIKCQkJCSk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewoJCQkJCQkvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCgkJCQkJCXdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPj0gMCApIHsKCQkJCQkJCWN1ciA9IGN1ci5yZXBsYWNlKCAiICIgKyBjbGF6eiArICIgIiwgIiAiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxlbS5jbGFzc05hbWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKCBjdXIgKSA6ICIiOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCWlmICggdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3MoIHZhbHVlICkgOiB0aGlzLnJlbW92ZUNsYXNzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnRvZ2dsZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHRoaXMuY2xhc3NOYW1lLCBzdGF0ZVZhbCksIHN0YXRlVmFsICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJCS8vIHRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCgkJCQl2YXIgY2xhc3NOYW1lLAoJCQkJCWkgPSAwLAoJCQkJCXNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKCQkJCQljbGFzc05hbWVzID0gdmFsdWUubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCQkJd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAoJCQkJCWlmICggc2VsZi5oYXNDbGFzcyggY2xhc3NOYW1lICkgKSB7CgkJCQkJCXNlbGYucmVtb3ZlQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNlbGYuYWRkQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09IGNvcmVfc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWRhdGFfcHJpdi5zZXQoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyBJZiB0aGUgZWxlbWVudCBoYXMgYSBjbGFzcyBuYW1lIG9yIGlmIHdlJ3JlIHBhc3NlZCAiZmFsc2UiLAoJCQkJLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4KCQkJCS8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCgkJCQkvLyBmYWxsaW5nIGJhY2sgdG8gdGhlIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBzdG9yZWQuCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogZGF0YV9wcml2LmdldCggdGhpcywgIl9fY2xhc3NOYW1lX18iICkgfHwgIiI7CgkJCX0KCQl9KTsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgY2xhc3NOYW1lID0gIiAiICsgc2VsZWN0b3IgKyAiICIsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGg7CgkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQlpZiAoIHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+PSAwICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJdmFsOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCgkJCWVsZW0gPSB0aGlzWzBdOwoKCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgewoJCQlpZiAoIGVsZW0gKSB7CgkJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sICJ2YWx1ZSIgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfQoKCQkJCXJldCA9IGVsZW0udmFsdWU7CgoJCQkJcmV0dXJuIHR5cGVvZiByZXQgPT09ICJzdHJpbmciID8KCQkJCQkvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCgkJCQkJcmV0LnJlcGxhY2UocnJldHVybiwgIiIpIDoKCQkJCQkvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKCQkJCQlyZXQgPT0gbnVsbCA/ICIiIDogcmV0OwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciB2YWw7CgoJCQlpZiAoIHRoaXMubm9kZVR5cGUgIT09IDEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIGpRdWVyeSggdGhpcyApLnZhbCgpICk7CgkJCX0gZWxzZSB7CgkJCQl2YWwgPSB2YWx1ZTsKCQkJfQoKCQkJLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9ICIiOwoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgdmFsID09PSAibnVtYmVyIiApIHsKCQkJCXZhbCArPSAiIjsKCQkJfSBlbHNlIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICggdmFsdWUgKSB7CgkJCQkJcmV0dXJuIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICsgIiI7CgkJCQl9KTsKCQkJfQoKCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7Cgl2YWxIb29rczogewoJCW9wdGlvbjogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJLy8gYXR0cmlidXRlcy52YWx1ZSBpcyB1bmRlZmluZWQgaW4gQmxhY2tiZXJyeSA0LjcgYnV0CgkJCQkvLyB1c2VzIC52YWx1ZS4gU2VlICM2OTMyCgkJCQl2YXIgdmFsID0gZWxlbS5hdHRyaWJ1dGVzLnZhbHVlOwoJCQkJcmV0dXJuICF2YWwgfHwgdmFsLnNwZWNpZmllZCA/IGVsZW0udmFsdWUgOiBlbGVtLnRleHQ7CgkJCX0KCQl9LAoJCXNlbGVjdDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHZhbHVlLCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQlpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQlvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiB8fCBpbmRleCA8IDAsCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAoJCQkJCW1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoLAoJCQkJCWkgPSBpbmRleCA8IDAgPwoJCQkJCQltYXggOgoJCQkJCQlvbmUgPyBpbmRleCA6IDA7CgoJCQkJLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwoJCQkJZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKCQkJCQkvLyBJRTYtOSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkKCQkJCQlpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKCQkJCQkJCS8vIERvbid0IHJldHVybiBvcHRpb25zIHRoYXQgYXJlIGRpc2FibGVkIG9yIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKCQkJCQkJCSggalF1ZXJ5LnN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PT0gbnVsbCApICYmCgkJCQkJCQkoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApICkgKSB7CgoJCQkJCQkvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCgkJCQkJCXZhbHVlID0galF1ZXJ5KCBvcHRpb24gKS52YWwoKTsKCgkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCgkJCQkJCWlmICggb25lICkgewoJCQkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJCQl9CgoJCQkJCQkvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQoJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlczsKCQkJfSwKCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJdmFyIG9wdGlvblNldCwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSggdmFsdWUgKSwKCQkJCQlpID0gb3B0aW9ucy5sZW5ndGg7CgoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoJCQkJCWlmICggKG9wdGlvbi5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkob3B0aW9uKS52YWwoKSwgdmFsdWVzICkgPj0gMCkgKSB7CgkJCQkJCW9wdGlvblNldCA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CgkJCQlpZiAoICFvcHRpb25TZXQgKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9CgkJfQoJfSwKCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09IGNvcmVfc3RydW5kZWZpbmVkICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQkvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCgkJLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgewoJCQluYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlob29rcyA9IGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSB8fAoJCQkJKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QoIG5hbWUgKSA/IGJvb2xIb29rIDogbm9kZUhvb2sgKTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggdmFsdWUgPT09IG51bGwgKSB7CgkJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoKCQkJfSBlbHNlIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoKCQl9IGVsc2UgewoJCQlyZXQgPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCQlyZXR1cm4gcmV0ID09IG51bGwgPwoJCQkJdW5kZWZpbmVkIDoKCQkJCXJldDsKCQl9Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQl2YXIgbmFtZSwgcHJvcE5hbWUsCgkJCWkgPSAwLAoJCQlhdHRyTmFtZXMgPSB2YWx1ZSAmJiB2YWx1ZS5tYXRjaCggY29yZV9ybm90d2hpdGUgKTsKCgkJaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsKCQkJCXByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoKCQkJCS8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkKCQkJCWlmICggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgKSB7CgkJCQkJLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UKCQkJCQllbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CgkJCQl9CgoJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIG5hbWUgKTsKCQkJfQoJCX0KCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICJyYWRpbyIgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJpbnB1dCIpICkgewoJCQkJCS8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKCQkJCQkvLyBSZXNldCB2YWx1ZSB0byBkZWZhdWx0IGluIGNhc2UgdHlwZSBpcyBzZXQgYWZ0ZXIgdmFsdWUgZHVyaW5nIGNyZWF0aW9uCgkJCQkJdmFyIHZhbCA9IGVsZW0udmFsdWU7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKCQkJCQlpZiAoIHZhbCApIHsKCQkJCQkJZWxlbS52YWx1ZSA9IHZhbDsKCQkJCQl9CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfSwKCglwcm9wRml4OiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIgoJfSwKCglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApOwoKCQlpZiAoIG5vdHhtbCApIHsKCQkJLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgPwoJCQkJcmV0IDoKCQkJCSggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCgkJfSBlbHNlIHsKCQkJcmV0dXJuIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgPwoJCQkJcmV0IDoKCQkJCWVsZW1bIG5hbWUgXTsKCQl9Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5oYXNBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSB8fCByZm9jdXNhYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSB8fCBlbGVtLmhyZWYgPwoJCQkJCWVsZW0udGFiSW5kZXggOgoJCQkJCS0xOwoJCQl9CgkJfQoJfQp9KTsKCi8vIEhvb2tzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMKYm9vbEhvb2sgPSB7CglzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lICk7CgkJfQoJCXJldHVybiBuYW1lOwoJfQp9OwpqUXVlcnkuZWFjaCggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goIC9cdysvZyApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBnZXR0ZXIgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsKCglqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0gPSBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIGZuID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdLAoJCQlyZXQgPSBpc1hNTCA/CgkJCQl1bmRlZmluZWQgOgoJCQkJLyoganNoaW50IGVxZXFlcTogZmFsc2UgKi8KCQkJCS8vIFRlbXBvcmFyaWx5IGRpc2FibGUgdGhpcyBoYW5kbGVyIHRvIGNoZWNrIGV4aXN0ZW5jZQoJCQkJKGpRdWVyeS5leHByLmF0dHJIYW5kbGVbIG5hbWUgXSA9IHVuZGVmaW5lZCkgIT0KCQkJCQlnZXR0ZXIoIGVsZW0sIG5hbWUsIGlzWE1MICkgPwoKCQkJCQluYW1lLnRvTG93ZXJDYXNlKCkgOgoJCQkJCW51bGw7CgoJCS8vIFJlc3RvcmUgaGFuZGxlcgoJCWpRdWVyeS5leHByLmF0dHJIYW5kbGVbIG5hbWUgXSA9IGZuOwoKCQlyZXR1cm4gcmV0OwoJfTsKfSk7CgovLyBTdXBwb3J0OiBJRTkrCi8vIFNlbGVjdGVkbmVzcyBmb3IgYW4gb3B0aW9uIGluIGFuIG9wdGdyb3VwIGNhbiBiZSBpbmFjY3VyYXRlCmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQlpZiAoIHBhcmVudCAmJiBwYXJlbnQucGFyZW50Tm9kZSApIHsKCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcmV0dXJuIG51bGw7CgkJfQoJfTsKfQoKalF1ZXJ5LmVhY2goWwoJInRhYkluZGV4IiwKCSJyZWFkT25seSIsCgkibWF4TGVuZ3RoIiwKCSJjZWxsU3BhY2luZyIsCgkiY2VsbFBhZGRpbmciLAoJInJvd1NwYW4iLAoJImNvbFNwYW4iLAoJInVzZU1hcCIsCgkiZnJhbWVCb3JkZXIiLAoJImNvbnRlbnRFZGl0YWJsZSIKXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkucHJvcEZpeFsgdGhpcy50b0xvd2VyQ2FzZSgpIF0gPSB0aGlzOwp9KTsKCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQkJcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7CgkJCX0KCQl9Cgl9OwoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tPbiApIHsKCQlqUXVlcnkudmFsSG9va3NbIHRoaXMgXS5nZXQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gU3VwcG9ydDogV2Via2l0CgkJCS8vICIiIGlzIHJldHVybmVkIGluc3RlYWQgb2YgIm9uIiBpZiBhIHZhbHVlIGlzbid0IHNwZWNpZmllZAoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKCQl9OwoJfQp9KTsKdmFyIHJrZXlFdmVudCA9IC9ea2V5LywKCXJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxjb250ZXh0bWVudSl8Y2xpY2svLAoJcmZvY3VzTW9ycGggPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCglydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CgpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsKCXRyeSB7CgkJcmV0dXJuIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7Cgl9IGNhdGNoICggZXJyICkgeyB9Cn0KCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCglnbG9iYWw6IHt9LAoKCWFkZDogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvciApIHsKCgkJdmFyIGhhbmRsZU9iakluLCBldmVudEhhbmRsZSwgdG1wLAoJCQlldmVudHMsIHQsIGhhbmRsZU9iaiwKCQkJc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLAoJCQllbGVtRGF0YSA9IGRhdGFfcHJpdi5nZXQoIGVsZW0gKTsKCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykKCQlpZiAoICFlbGVtRGF0YSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7CgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsKCQkJaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7CgkJCWhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CgkJfQoKCQkvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CgkJaWYgKCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykgKSB7CgkJCWV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwoJCX0KCQlpZiAoICEoZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUpICkgewoJCQlldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSBjb3JlX3N0cnVuZGVmaW5lZCAmJiAoIWUgfHwgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlKSA/CgkJCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KCBldmVudEhhbmRsZS5lbGVtLCBhcmd1bWVudHMgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9OwoJCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKCQkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKCQl0ID0gdHlwZXMubGVuZ3RoOwoJCXdoaWxlICggdC0tICkgewoJCQl0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1t0XSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsyXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKCQkJaWYgKCAhdHlwZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoKCQkJLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewoJCQkJdHlwZTogdHlwZSwKCQkJCW9yaWdUeXBlOiBvcmlnVHlwZSwKCQkJCWRhdGE6IGRhdGEsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJZ3VpZDogaGFuZGxlci5ndWlkLAoJCQkJc2VsZWN0b3I6IHNlbGVjdG9yLAoJCQkJbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSwKCQkJCW5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKCQkJfSwgaGFuZGxlT2JqSW4gKTsKCgkJCS8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CgkJCWlmICggIShoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdKSApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoIGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsKCQkJCXNwZWNpYWwuYWRkLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWhhbmRsZXJzLnNwbGljZSggaGFuZGxlcnMuZGVsZWdhdGVDb3VudCsrLCAwLCBoYW5kbGVPYmogKTsKCQkJfSBlbHNlIHsKCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOwoJCQl9CgoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCgkJCWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSA9IHRydWU7CgkJfQoKCQkvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKCQllbGVtID0gbnVsbDsKCX0sCgoJLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CglyZW1vdmU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzICkgewoKCQl2YXIgaiwgb3JpZ0NvdW50LCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YV9wcml2Lmhhc0RhdGEoIGVsZW0gKSAmJiBkYXRhX3ByaXYuZ2V0KCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFsiIl07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbMl0gJiYgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKTsKCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKCQkJb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKCQkJCQkoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgoJCQkJCSggIXRtcCB8fCB0bXAudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgJiYKCQkJCQkoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApICkgewoJCQkJCWhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKCQkJCQlpZiAoIGhhbmRsZU9iai5zZWxlY3RvciApIHsKCQkJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOwoJCQkJCX0KCQkJCQlpZiAoIHNwZWNpYWwucmVtb3ZlICkgewoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCgkJCWlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CgkJCQlpZiAoICFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbCggZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CgkJCQl9CgoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOwoJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCAiZXZlbnRzIiApOwoJCX0KCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgoJCXZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsCgkJCWV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAoJCQl0eXBlID0gY29yZV9oYXNPd24uY2FsbCggZXZlbnQsICJ0eXBlIiApID8gZXZlbnQudHlwZSA6IGV2ZW50LAoJCQluYW1lc3BhY2VzID0gY29yZV9oYXNPd24uY2FsbCggZXZlbnQsICJuYW1lc3BhY2UiICkgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoIi4iKSA6IFtdOwoKCQljdXIgPSB0bXAgPSBlbGVtID0gZWxlbSB8fCBkb2N1bWVudDsKCgkJLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CgkJaWYgKCByZm9jdXNNb3JwaC50ZXN0KCB0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHR5cGUuaW5kZXhPZigiLiIpID49IDAgKSB7CgkJCS8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKCQkJbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKCQkJdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKCQkJbmFtZXNwYWNlcy5zb3J0KCk7CgkJfQoJCW9udHlwZSA9IHR5cGUuaW5kZXhPZigiOiIpIDwgMCAmJiAib24iICsgdHlwZTsKCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCgkJZXZlbnQgPSBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/CgkJCWV2ZW50IDoKCQkJbmV3IGpRdWVyeS5FdmVudCggdHlwZSwgdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiAmJiBldmVudCApOwoKCQkvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCgkJZXZlbnQuaXNUcmlnZ2VyID0gb25seUhhbmRsZXJzID8gMiA6IDM7CgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCIuIik7CgkJZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8KCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKSA6CgkJCW51bGw7CgoJCS8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAoJCWV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGVsZW07CgkJfQoKCQkvLyBDbG9uZSBhbnkgaW5jb21pbmcgZGF0YSBhbmQgcHJlcGVuZCB0aGUgZXZlbnQsIGNyZWF0aW5nIHRoZSBoYW5kbGVyIGFyZyBsaXN0CgkJZGF0YSA9IGRhdGEgPT0gbnVsbCA/CgkJCVsgZXZlbnQgXSA6CgkJCWpRdWVyeS5tYWtlQXJyYXkoIGRhdGEsIFsgZXZlbnQgXSApOwoKCQkvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCgkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgkJaWYgKCAhb25seUhhbmRsZXJzICYmIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQoJCS8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCWJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwoJCQlpZiAoICFyZm9jdXNNb3JwaC50ZXN0KCBidWJibGVUeXBlICsgdHlwZSApICkgewoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQkJZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIGN1ciApOwoJCQkJdG1wID0gY3VyOwoJCQl9CgoJCQkvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKCQkJaWYgKCB0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyApOwoJCQl9CgkJfQoKCQkvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCgkJaSA9IDA7CgkJd2hpbGUgKCAoY3VyID0gZXZlbnRQYXRoW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJZXZlbnQudHlwZSA9IGkgPiAxID8KCQkJCWJ1YmJsZVR5cGUgOgoJCQkJc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOwoKCQkJLy8galF1ZXJ5IGhhbmRsZXIKCQkJaGFuZGxlID0gKCBkYXRhX3ByaXYuZ2V0KCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGRhdGFfcHJpdi5nZXQoIGN1ciwgImhhbmRsZSIgKTsKCQkJaWYgKCBoYW5kbGUgKSB7CgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQl9CgoJCQkvLyBOYXRpdmUgaGFuZGxlcgoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKCQkJaWYgKCBoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICYmIGhhbmRsZS5hcHBseSAmJiBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgkJZXZlbnQudHlwZSA9IHR5cGU7CgoJCS8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJaWYgKCAoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZXZlbnRQYXRoLnBvcCgpLCBkYXRhICkgPT09IGZhbHNlKSAmJgoJCQkJalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCgkJCQkvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCgkJCQlpZiAoIG9udHlwZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggZWxlbVsgdHlwZSBdICkgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCgkJCQkJdG1wID0gZWxlbVsgb250eXBlIF07CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG51bGw7CgkJCQkJfQoKCQkJCQkvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwoJCQkJCWVsZW1bIHR5cGUgXSgpOwoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IHRtcDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWRpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKTsKCgkJdmFyIGksIGosIHJldCwgbWF0Y2hlZCwgaGFuZGxlT2JqLAoJCQloYW5kbGVyUXVldWUgPSBbXSwKCQkJYXJncyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWhhbmRsZXJzID0gKCBkYXRhX3ByaXYuZ2V0KCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307CgoJCS8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CgkJYXJnc1swXSA9IGV2ZW50OwoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgaGFuZGxlcnMKCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJaSA9IDA7CgkJd2hpbGUgKCAobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVsgaSsrIF0pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwoKCQkJaiA9IDA7CgkJCXdoaWxlICggKGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbIGorKyBdKSAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCgkJCQkvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCgkJCQkvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KCQkJCWlmICggIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoKCQkJCQlldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoKCQkJCQlyZXQgPSAoIChqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlciApCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKCQkJCQlpZiAoIHJldCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQlpZiAoIChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgloYW5kbGVyczogZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVycyApIHsKCQl2YXIgaSwgbWF0Y2hlcywgc2VsLCBoYW5kbGVPYmosCgkJCWhhbmRsZXJRdWV1ZSA9IFtdLAoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKCQkJY3VyID0gZXZlbnQudGFyZ2V0OwoKCQkvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzCgkJLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkKCQkvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYgY3VyLm5vZGVUeXBlICYmICghZXZlbnQuYnV0dG9uIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIpICkgewoKCQkJZm9yICggOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMgKSB7CgoJCQkJLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCgkJCQlpZiAoIGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siICkgewoJCQkJCW1hdGNoZXMgPSBbXTsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsKCQkJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGkgXTsKCgkJCQkJCS8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCgkJCQkJCXNlbCA9IGhhbmRsZU9iai5zZWxlY3RvciArICIgIjsKCgkJCQkJCWlmICggbWF0Y2hlc1sgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCW1hdGNoZXNbIHNlbCBdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/CgkJCQkJCQkJalF1ZXJ5KCBzZWwsIHRoaXMgKS5pbmRleCggY3VyICkgPj0gMCA6CgkJCQkJCQkJalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKCQkJCQkJfQoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlcy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG1hdGNoZXMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgaGFuZGxlcnM6IG1hdGNoZXMgfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCgkJaWYgKCBkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoICkgewoJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IHRoaXMsIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZSggZGVsZWdhdGVDb3VudCApIH0pOwoJCX0KCgkJcmV0dXJuIGhhbmRsZXJRdWV1ZTsKCX0sCgoJLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKCXByb3BzOiAiYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeEhvb2tzOiB7fSwKCglrZXlIb29rczogewoJCXByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQkJaWYgKCBldmVudC53aGljaCA9PSBudWxsICkgewoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCgltb3VzZUhvb2tzOiB7CgkJcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoJCQl2YXIgZXZlbnREb2MsIGRvYywgYm9keSwKCQkJCWJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbjsKCgkJCS8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUKCQkJaWYgKCBldmVudC5wYWdlWCA9PSBudWxsICYmIG9yaWdpbmFsLmNsaWVudFggIT0gbnVsbCApIHsKCQkJCWV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CgkJCQlkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CgkJCQlib2R5ID0gZXZlbnREb2MuYm9keTsKCgkJCQlldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7CgkJCQlldmVudC5wYWdlWSA9IG9yaWdpbmFsLmNsaWVudFkgKyAoIGRvYyAmJiBkb2Muc2Nyb2xsVG9wICB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wICB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50VG9wICB8fCBib2R5ICYmIGJvZHkuY2xpZW50VG9wICB8fCAwICk7CgkJCX0KCgkJCS8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKCQkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQkJaWYgKCAhZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CgkJCX0KCgkJCXJldHVybiBldmVudDsKCQl9Cgl9LAoKCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gKSB7CgkJCXJldHVybiBldmVudDsKCQl9CgoJCS8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwoJCXZhciBpLCBwcm9wLCBjb3B5LAoJCQl0eXBlID0gZXZlbnQudHlwZSwKCQkJb3JpZ2luYWxFdmVudCA9IGV2ZW50LAoJCQlmaXhIb29rID0gdGhpcy5maXhIb29rc1sgdHlwZSBdOwoKCQlpZiAoICFmaXhIb29rICkgewoJCQl0aGlzLmZpeEhvb2tzWyB0eXBlIF0gPSBmaXhIb29rID0KCQkJCXJtb3VzZUV2ZW50LnRlc3QoIHR5cGUgKSA/IHRoaXMubW91c2VIb29rcyA6CgkJCQlya2V5RXZlbnQudGVzdCggdHlwZSApID8gdGhpcy5rZXlIb29rcyA6CgkJCQl7fTsKCQl9CgkJY29weSA9IGZpeEhvb2sucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdCggZml4SG9vay5wcm9wcyApIDogdGhpcy5wcm9wczsKCgkJZXZlbnQgPSBuZXcgalF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWkgPSBjb3B5Lmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJcHJvcCA9IGNvcHlbIGkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQl9CgoJCS8vIFN1cHBvcnQ6IENvcmRvdmEgMi41IChXZWJLaXQpICgjMTMyNTUpCgkJLy8gQWxsIGV2ZW50cyBzaG91bGQgaGF2ZSBhIHRhcmdldDsgQ29yZG92YSBkZXZpY2VyZWFkeSBkb2Vzbid0CgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBkb2N1bWVudDsKCQl9CgoJCS8vIFN1cHBvcnQ6IFNhZmFyaSA2LjArLCBDaHJvbWUgPCAyOAoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoJCX0KCgkJcmV0dXJuIGZpeEhvb2suZmlsdGVyPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwoJfSwKCglzcGVjaWFsOiB7CgkJbG9hZDogewoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCQlmb2N1czogewoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgIT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5mb2N1cyApIHsKCQkJCQl0aGlzLmZvY3VzKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgoJCX0sCgkJYmx1cjogewoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcyA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmJsdXIgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKCQl9LAoJCWNsaWNrOiB7CgkJCS8vIEZvciBjaGVja2JveCwgZmlyZSBuYXRpdmUgZXZlbnQgc28gY2hlY2tlZCBzdGF0ZSB3aWxsIGJlIHJpZ2h0CgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgJiYgdGhpcy5jbGljayAmJiBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJpbnB1dCIgKSApIHsKCQkJCQl0aGlzLmNsaWNrKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoKCQkJLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCgkJCV9kZWZhdWx0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBldmVudC50YXJnZXQsICJhIiApOwoJCQl9CgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggMjArCgkJCQkvLyBGaXJlZm94IGRvZXNuJ3QgYWxlcnQgaWYgdGhlIHJldHVyblZhbHVlIGZpZWxkIGlzIG5vdCBzZXQuCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCXNpbXVsYXRlOiBmdW5jdGlvbiggdHlwZSwgZWxlbSwgZXZlbnQsIGJ1YmJsZSApIHsKCQkvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCgkJLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlCgkJLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCgkJdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAoJCQluZXcgalF1ZXJ5LkV2ZW50KCksCgkJCWV2ZW50LAoJCQl7CgkJCQl0eXBlOiB0eXBlLAoJCQkJaXNTaW11bGF0ZWQ6IHRydWUsCgkJCQlvcmlnaW5hbEV2ZW50OiB7fQoJCQl9CgkJKTsKCQlpZiAoIGJ1YmJsZSApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGUsIG51bGwsIGVsZW0gKTsKCQl9IGVsc2UgewoJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbCggZWxlbSwgZSApOwoJCX0KCQlpZiAoIGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfQp9OwoKalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCWlmICggZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyICkgewoJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJfQp9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7CgkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKCWlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOwoJfQoKCS8vIEV2ZW50IG9iamVjdAoJaWYgKCBzcmMgJiYgc3JjLnR5cGUgKSB7CgkJdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwoJCXRoaXMudHlwZSA9IHNyYy50eXBlOwoKCQkvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fAoJCQlzcmMuZ2V0UHJldmVudERlZmF1bHQgJiYgc3JjLmdldFByZXZlbnREZWZhdWx0KCkgKSA/IHJldHVyblRydWUgOiByZXR1cm5GYWxzZTsKCgkvLyBFdmVudCB0eXBlCgl9IGVsc2UgewoJCXRoaXMudHlwZSA9IHNyYzsKCX0KCgkvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAoJaWYgKCBwcm9wcyApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0aGlzLCBwcm9wcyApOwoJfQoKCS8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCgl0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IGpRdWVyeS5ub3coKTsKCgkvLyBNYXJrIGl0IGFzIGZpeGVkCgl0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwovLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKCWlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCglpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCglpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwoKCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CgoJCWlmICggZSAmJiBlLnByZXZlbnREZWZhdWx0ICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0KfTsKCi8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwovLyBTdXBwb3J0OiBDaHJvbWUgMTUrCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKCgkJCS8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KCQkJLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKCQkJaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnMoIHRhcmdldCwgcmVsYXRlZCApKSApIHsKCQkJCWV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CgkJCQlyZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlldmVudC50eXBlID0gZml4OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfQoJfTsKfSk7CgovLyBDcmVhdGUgImJ1YmJsaW5nIiBmb2N1cyBhbmQgYmx1ciBldmVudHMKLy8gU3VwcG9ydDogRmlyZWZveCwgQ2hyb21lLCBTYWZhcmkKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgKSB7CglqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAoJCXZhciBhdHRhY2hlcyA9IDAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApLCB0cnVlICk7CgkJCX07CgoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBhdHRhY2hlcysrID09PSAwICkgewoJCQkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAtLWF0dGFjaGVzID09PSAwICkgewoJCQkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX07Cgl9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJb246IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAvKklOVEVSTkFMKi8gb25lICkgewoJCXZhciBvcmlnRm4sIHR5cGU7CgoJCS8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQkJZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vbiggdHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzWyB0eXBlIF0sIG9uZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKCQkJLy8gKCB0eXBlcywgZm4gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfSBlbHNlIGlmICggZm4gPT0gbnVsbCApIHsKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJCX0gZWxzZSB7CgkJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9IGVsc2UgaWYgKCAhZm4gKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBvbmUgPT09IDEgKSB7CgkJCW9yaWdGbiA9IGZuOwoJCQlmbiA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwoJCQkJalF1ZXJ5KCkub2ZmKCBldmVudCApOwoJCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJCS8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCgkJCWZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAoIG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCW9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEgKTsKCX0sCglvZmY6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGZuICkgewoJCXZhciBoYW5kbGVPYmosIHR5cGU7CgkJaWYgKCB0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmogKSB7CgkJCS8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKAoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsCgkJCQloYW5kbGVPYmouaGFuZGxlcgoJCQkpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vZmYoIHR5cGUsIHNlbGVjdG9yLCB0eXBlc1sgdHlwZSBdICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiApIHsKCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKCQl9KTsKCX0sCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWzBdOwoJCWlmICggZWxlbSApIHsKCQkJcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCBlbGVtLCB0cnVlICk7CgkJfQoJfQp9KTsKdmFyIGlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywKCXJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoJcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLAoJCQlyZXQgPSBbXSwKCQkJc2VsZiA9IHRoaXMsCgkJCWxlbiA9IHNlbGYubGVuZ3RoOwoKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5KCBzZWxlY3RvciApLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0pICk7CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHNlbGZbIGkgXSwgcmV0ICk7CgkJfQoKCQkvLyBOZWVkZWQgYmVjYXVzZSAkKCBzZWxlY3RvciwgY29udGV4dCApIGJlY29tZXMgJCggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICkKCQlyZXQgPSB0aGlzLnB1c2hTdGFjayggbGVuID4gMSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0ICk7CgkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciA/IHRoaXMuc2VsZWN0b3IgKyAiICIgKyBzZWxlY3RvciA6IHNlbGVjdG9yOwoJCXJldHVybiByZXQ7Cgl9LAoKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWwgPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQl2YXIgaSA9IDA7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCB0aGlzLCB0YXJnZXRzW2ldICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0sCgoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpICk7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSkgKTsKCX0sCgoJaXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gISF3aW5ub3coCgkJCXRoaXMsCgoJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiAmJiBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciApIDoKCQkJCXNlbGVjdG9yIHx8IFtdLAoJCQlmYWxzZQoJCSkubGVuZ3RoOwoJfSwKCgljbG9zZXN0OiBmdW5jdGlvbiggc2VsZWN0b3JzLCBjb250ZXh0ICkgewoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGgsCgkJCW1hdGNoZWQgPSBbXSwKCQkJcG9zID0gKCBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOgoJCQkJMDsKCgkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQlmb3IgKCBjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCS8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwoJCQkJaWYgKCBjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8KCQkJCQlwb3MuaW5kZXgoY3VyKSA+IC0xIDoKCgkJCQkJLy8gRG9uJ3QgcGFzcyBub24tZWxlbWVudHMgdG8gU2l6emxlCgkJCQkJY3VyLm5vZGVUeXBlID09PSAxICYmCgkJCQkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpICkgewoKCQkJCQljdXIgPSBtYXRjaGVkLnB1c2goIGN1ciApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUoIG1hdGNoZWQgKSA6IG1hdGNoZWQgKTsKCX0sCgoJLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbgoJLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCglpbmRleDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCS8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuICggdGhpc1sgMCBdICYmIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwoJCX0KCgkJLy8gaW5kZXggaW4gc2VsZWN0b3IKCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdGhpc1sgMCBdICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4gY29yZV9pbmRleE9mLmNhbGwoIHRoaXMsCgoJCQkvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKCQkJZWxlbS5qcXVlcnkgPyBlbGVtWyAwIF0gOiBlbGVtCgkJKTsKCX0sCgoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJdmFyIHNldCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApIDoKCQkJCWpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yICYmIHNlbGVjdG9yLm5vZGVUeXBlID8gWyBzZWxlY3RvciBdIDogc2VsZWN0b3IgKSwKCQkJYWxsID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBzZXQgKTsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKGFsbCkgKTsKCX0sCgoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpCgkJKTsKCX0KfSk7CgpmdW5jdGlvbiBzaWJsaW5nKCBjdXIsIGRpciApIHsKCXdoaWxlICggKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQoKCXJldHVybiBjdXI7Cn0KCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIgKTsKCX0sCglwYXJlbnRzVW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwoJfSwKCW5leHQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dEFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKCX0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgewoJCXZhciBtYXRjaGVkID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgoJCWlmICggbmFtZS5zbGljZSggLTUgKSAhPT0gIlVudGlsIiApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBtYXRjaGVkICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoID4gMSApIHsKCQkJLy8gUmVtb3ZlIGR1cGxpY2F0ZXMKCQkJaWYgKCAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdICkgewoJCQkJalF1ZXJ5LnVuaXF1ZSggbWF0Y2hlZCApOwoJCQl9CgoJCQkvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcwoJCQlpZiAoIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CgkJCQltYXRjaGVkLnJldmVyc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkICk7Cgl9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoJZmlsdGVyOiBmdW5jdGlvbiggZXhwciwgZWxlbXMsIG5vdCApIHsKCQl2YXIgZWxlbSA9IGVsZW1zWyAwIF07CgoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPwoJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGVsZW0sIGV4cHIgKSA/IFsgZWxlbSBdIDogW10gOgoJCQlqUXVlcnkuZmluZC5tYXRjaGVzKCBleHByLCBqUXVlcnkuZ3JlcCggZWxlbXMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJCX0pKTsKCX0sCgoJZGlyOiBmdW5jdGlvbiggZWxlbSwgZGlyLCB1bnRpbCApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdLAoJCQl0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CgoJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSApIHsKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJaWYgKCB0cnVuY2F0ZSAmJiBqUXVlcnkoIGVsZW0gKS5pcyggdW50aWwgKSApIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCW1hdGNoZWQucHVzaCggZWxlbSApOwoJCQl9CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSApIHsKCQkJCW1hdGNoZWQucHVzaCggbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gbWF0Y2hlZDsKCX0KfSk7CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQkvKiBqc2hpbnQgLVcwMTggKi8KCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0pOwoKCX0KCglpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgIT09IG5vdDsKCQl9KTsKCgl9CgoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHF1YWxpZmllciApICkgewoJCQlyZXR1cm4galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBlbGVtZW50cywgbm90ICk7CgkJfQoKCQlxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGVsZW1lbnRzICk7Cgl9CgoJcmV0dXJuIGpRdWVyeS5ncmVwKCBlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICggY29yZV9pbmRleE9mLmNhbGwoIHF1YWxpZmllciwgZWxlbSApID49IDAgKSAhPT0gbm90OwoJfSk7Cn0KdmFyIHJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksCglydGFnTmFtZSA9IC88KFtcdzpdKykvLAoJcmh0bWwgPSAvPHwmIz9cdys7LywKCXJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCgltYW5pcHVsYXRpb25fcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaSwKCS8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKCXJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCglyc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKCXJzY3JpcHRUeXBlTWFza2VkID0gL150cnVlXC8oLiopLywKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZywKCgkvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQoJd3JhcE1hcCA9IHsKCgkJLy8gU3VwcG9ydDogSUUgOQoJCW9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCgoJCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAoJCWNvbDogWyAyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKCQl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCgkJX2RlZmF1bHQ6IFsgMCwgIiIsICIiIF0KCX07CgovLyBTdXBwb3J0OiBJRSA5CndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKCndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgl0ZXh0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnRleHQoIHRoaXMgKSA6CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbIDAgXSAmJiB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApLmNyZWF0ZVRleHROb2RlKCB2YWx1ZSApICk7CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCApOwoJCQl9CgkJfSk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5wYXJlbnROb2RlICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOwoJCQl9CgkJfSk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLm5leHRTaWJsaW5nICk7CgkJCX0KCQl9KTsKCX0sCgoJLy8ga2VlcERhdGEgaXMgZm9yIGludGVybmFsIHVzZSBvbmx5LS1kbyBub3QgZG9jdW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQl2YXIgZWxlbSwKCQkJZWxlbXMgPSBzZWxlY3RvciA/IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCB0aGlzICkgOiB0aGlzLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0gKSApOwoJCQl9CgoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWlmICgga2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKCQkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKCQkJCX0KCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoKCQkJCS8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKCgkJCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCQkJZWxlbS50ZXh0Q29udGVudCA9ICIiOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwoJCWRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7CgkJfSk7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZWxlbSA9IHRoaXNbIDAgXSB8fCB7fSwKCQkJCWkgPSAwLAoJCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlyZXR1cm4gZWxlbS5pbm5lckhUTUw7CgkJCX0KCgkJCS8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJgoJCQkJIXdyYXBNYXBbICggcnRhZ05hbWUuZXhlYyggdmFsdWUgKSB8fCBbICIiLCAiIiBdIClbIDEgXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQkJCWVsZW0gPSB0aGlzWyBpIF0gfHwge307CgoJCQkJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgkJCQkJCQllbGVtLmlubmVySFRNTCA9IHZhbHVlOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQllbGVtID0gMDsKCgkJCQkvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKCQkJCX0gY2F0Y2goIGUgKSB7fQoJCQl9CgoJCQlpZiAoIGVsZW0gKSB7CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCB2YWx1ZSApOwoJCQl9CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCkgewoJCXZhcgoJCQkvLyBTbmFwc2hvdCB0aGUgRE9NIGluIGNhc2UgLmRvbU1hbmlwIHN3ZWVwcyBzb21ldGhpbmcgcmVsZXZhbnQgaW50byBpdHMgZnJhZ21lbnQKCQkJYXJncyA9IGpRdWVyeS5tYXAoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFsgZWxlbS5uZXh0U2libGluZywgZWxlbS5wYXJlbnROb2RlIF07CgkJCX0pLAoJCQlpID0gMDsKCgkJLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CgkJdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5leHQgPSBhcmdzWyBpKysgXSwKCQkJCXBhcmVudCA9IGFyZ3NbIGkrKyBdOwoKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQkvLyBEb24ndCB1c2UgdGhlIHNuYXBzaG90IG5leHQgaWYgaXQgaGFzIG1vdmVkICgjMTM4MTApCgkJCQlpZiAoIG5leHQgJiYgbmV4dC5wYXJlbnROb2RlICE9PSBwYXJlbnQgKSB7CgkJCQkJbmV4dCA9IHRoaXMubmV4dFNpYmxpbmc7CgkJCQl9CgkJCQlqUXVlcnkoIHRoaXMgKS5yZW1vdmUoKTsKCQkJCXBhcmVudC5pbnNlcnRCZWZvcmUoIGVsZW0sIG5leHQgKTsKCQkJfQoJCS8vIEFsbG93IG5ldyBjb250ZW50IHRvIGluY2x1ZGUgZWxlbWVudHMgZnJvbSB0aGUgY29udGV4dCBzZXQKCQl9LCB0cnVlICk7CgoJCS8vIEZvcmNlIHJlbW92YWwgaWYgdGhlcmUgd2FzIG5vIG5ldyBjb250ZW50IChlLmcuLCBmcm9tIGVtcHR5IGFyZ3VtZW50cykKCQlyZXR1cm4gaSA/IHRoaXMgOiB0aGlzLnJlbW92ZSgpOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7Cgl9LAoKCWRvbU1hbmlwOiBmdW5jdGlvbiggYXJncywgY2FsbGJhY2ssIGFsbG93SW50ZXJzZWN0aW9uICkgewoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJYXJncyA9IGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOwoKCQl2YXIgZnJhZ21lbnQsIGZpcnN0LCBzY3JpcHRzLCBoYXNTY3JpcHRzLCBub2RlLCBkb2MsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGgsCgkJCXNldCA9IHRoaXMsCgkJCWlOb0Nsb25lID0gbCAtIDEsCgkJCXZhbHVlID0gYXJnc1sgMCBdLAoJCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCS8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdAoJCWlmICggaXNGdW5jdGlvbiB8fCAhKCBsIDw9IDEgfHwgdHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIiB8fCBqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGluZGV4ICkgewoJCQkJdmFyIHNlbGYgPSBzZXQuZXEoIGluZGV4ICk7CgkJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQkJYXJnc1sgMCBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpICk7CgkJCQl9CgkJCQlzZWxmLmRvbU1hbmlwKCBhcmdzLCBjYWxsYmFjaywgYWxsb3dJbnRlcnNlY3Rpb24gKTsKCQkJfSk7CgkJfQoKCQlpZiAoIGwgKSB7CgkJCWZyYWdtZW50ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXNbIDAgXS5vd25lckRvY3VtZW50LCBmYWxzZSwgIWFsbG93SW50ZXJzZWN0aW9uICYmIHRoaXMgKTsKCQkJZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwoKCQkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJCWZyYWdtZW50ID0gZmlyc3Q7CgkJCX0KCgkJCWlmICggZmlyc3QgKSB7CgkJCQlzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOwoJCQkJaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwoKCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCQkvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgoJCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJCW5vZGUgPSBmcmFnbWVudDsKCgkJCQkJaWYgKCBpICE9PSBpTm9DbG9uZSApIHsKCQkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOwoKCQkJCQkJLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgoJCQkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgY29yZV9wdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCgkJCQkJCQlqUXVlcnkubWVyZ2UoIHNjcmlwdHMsIGdldEFsbCggbm9kZSwgInNjcmlwdCIgKSApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQljYWxsYmFjay5jYWxsKCB0aGlzWyBpIF0sIG5vZGUsIGkgKTsKCQkJCX0KCgkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJZG9jID0gc2NyaXB0c1sgc2NyaXB0cy5sZW5ndGggLSAxIF0ub3duZXJEb2N1bWVudDsKCgkJCQkJLy8gUmVlbmFibGUgc2NyaXB0cwoJCQkJCWpRdWVyeS5tYXAoIHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQgKTsKCgkJCQkJLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgoJCQkJCWZvciAoIGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrICkgewoJCQkJCQlub2RlID0gc2NyaXB0c1sgaSBdOwoJCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIG5vZGUudHlwZSB8fCAiIiApICYmCgkJCQkJCQkhZGF0YV9wcml2LmFjY2Vzcyggbm9kZSwgImdsb2JhbEV2YWwiICkgJiYgalF1ZXJ5LmNvbnRhaW5zKCBkb2MsIG5vZGUgKSApIHsKCgkJCQkJCQlpZiAoIG5vZGUuc3JjICkgewoJCQkJCQkJCS8vIEhvcGUgYWpheCBpcyBhdmFpbGFibGUuLi4KCQkJCQkJCQlqUXVlcnkuX2V2YWxVcmwoIG5vZGUuc3JjICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWpRdWVyeS5nbG9iYWxFdmFsKCBub2RlLnRleHRDb250ZW50LnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpqUXVlcnkuZWFjaCh7CglhcHBlbmRUbzogImFwcGVuZCIsCglwcmVwZW5kVG86ICJwcmVwZW5kIiwKCWluc2VydEJlZm9yZTogImJlZm9yZSIsCglpbnNlcnRBZnRlcjogImFmdGVyIiwKCXJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zLAoJCQlyZXQgPSBbXSwKCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlsYXN0ID0gaW5zZXJ0Lmxlbmd0aCAtIDEsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IGkgPD0gbGFzdDsgaSsrICkgewoJCQllbGVtcyA9IGkgPT09IGxhc3QgPyB0aGlzIDogdGhpcy5jbG9uZSggdHJ1ZSApOwoJCQlqUXVlcnkoIGluc2VydFsgaSBdIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7CgoJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkvLyAuZ2V0KCkgYmVjYXVzZSBjb3JlX3B1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKCQkJY29yZV9wdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCApOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJdmFyIGksIGwsIHNyY0VsZW1lbnRzLCBkZXN0RWxlbWVudHMsCgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKSwKCQkJaW5QYWdlID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJLy8gU3VwcG9ydDogSUUgPj0gOQoJCS8vIEZpeCBDbG9uaW5nIGlzc3VlcwoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSApICYmICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cDovL2pzcGVyZi5jb20vZ2V0YWxsLXZzLXNpenpsZS8yCgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCgkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJZml4SW5wdXQoIHNyY0VsZW1lbnRzWyBpIF0sIGRlc3RFbGVtZW50c1sgaSBdICk7CgkJCX0KCQl9CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7CgkJCWlmICggZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJCQlzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOwoJCQkJZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbCggY2xvbmUgKTsKCgkJCQlmb3IgKCBpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQljbG9uZUNvcHlFdmVudCggc3JjRWxlbWVudHNbIGkgXSwgZGVzdEVsZW1lbnRzWyBpIF0gKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwoJCQl9CgkJfQoKCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsKCQlpZiAoIGRlc3RFbGVtZW50cy5sZW5ndGggPiAwICkgewoJCQlzZXRHbG9iYWxFdmFsKCBkZXN0RWxlbWVudHMsICFpblBhZ2UgJiYgZ2V0QWxsKCBlbGVtLCAic2NyaXB0IiApICk7CgkJfQoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uICkgewoJCXZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosCgkJCWkgPSAwLAoJCQlsID0gZWxlbXMubGVuZ3RoLAoJCQlmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlub2RlcyA9IFtdOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWVsZW0gPSBlbGVtc1sgaSBdOwoKCQkJaWYgKCBlbGVtIHx8IGVsZW0gPT09IDAgKSB7CgoJCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5CgkJCQlpZiAoIGpRdWVyeS50eXBlKCBlbGVtICkgPT09ICJvYmplY3QiICkgewoJCQkJCS8vIFN1cHBvcnQ6IFF0V2ViS2l0CgkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgY29yZV9wdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCgkJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgZWxlbS5ub2RlVHlwZSA/IFsgZWxlbSBdIDogZWxlbSApOwoKCQkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQoJCQkJfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKCQkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICkgKTsKCgkJCQkvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKCQkJCX0gZWxzZSB7CgkJCQkJdG1wID0gdG1wIHx8IGZyYWdtZW50LmFwcGVuZENoaWxkKCBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7CgoJCQkJCS8vIERlc2VyaWFsaXplIGEgc3RhbmRhcmQgcmVwcmVzZW50YXRpb24KCQkJCQl0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWyAxIF0udG9Mb3dlckNhc2UoKTsKCQkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCQkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsgMSBdICsgZWxlbS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICkgKyB3cmFwWyAyIF07CgoJCQkJCS8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAoJCQkJCWogPSB3cmFwWyAwIF07CgkJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7CgkJCQkJfQoKCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCS8vIGpRdWVyeS5tZXJnZSBiZWNhdXNlIGNvcmVfcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwoJCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7CgoJCQkJCS8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyCgkJCQkJdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJCQkJLy8gRml4ZXMgIzEyMzQ2CgkJCQkJLy8gU3VwcG9ydDogV2Via2l0LCBJRQoJCQkJCXRtcC50ZXh0Q29udGVudCA9ICIiOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CgkJZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKCgkJaSA9IDA7CgkJd2hpbGUgKCAoZWxlbSA9IG5vZGVzWyBpKysgXSkgKSB7CgoJCQkvLyAjNDA4NyAtIElmIG9yaWdpbiBhbmQgZGVzdGluYXRpb24gZWxlbWVudHMgYXJlIHRoZSBzYW1lLCBhbmQgdGhpcyBpcwoJCQkvLyB0aGF0IGVsZW1lbnQsIGRvIG5vdCBkbyBhbnl0aGluZwoJCQlpZiAoIHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheSggZWxlbSwgc2VsZWN0aW9uICkgIT09IC0xICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJCS8vIEFwcGVuZCB0byBmcmFnbWVudAoJCQl0bXAgPSBnZXRBbGwoIGZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7CgoJCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJCWlmICggY29udGFpbnMgKSB7CgkJCQlzZXRHbG9iYWxFdmFsKCB0bXAgKTsKCQkJfQoKCQkJLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwoJCQlpZiAoIHNjcmlwdHMgKSB7CgkJCQlqID0gMDsKCQkJCXdoaWxlICggKGVsZW0gPSB0bXBbIGorKyBdKSApIHsKCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIGVsZW0udHlwZSB8fCAiIiApICkgewoJCQkJCQlzY3JpcHRzLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBmcmFnbWVudDsKCX0sCgoJY2xlYW5EYXRhOiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJdmFyIGRhdGEsIGVsZW0sIGV2ZW50cywgdHlwZSwga2V5LCBqLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbIGkgXSkgIT09IHVuZGVmaW5lZDsgaSsrICkgewoJCQlpZiAoIERhdGEuYWNjZXB0cyggZWxlbSApICkgewoJCQkJa2V5ID0gZWxlbVsgZGF0YV9wcml2LmV4cGFuZG8gXTsKCgkJCQlpZiAoIGtleSAmJiAoZGF0YSA9IGRhdGFfcHJpdi5jYWNoZVsga2V5IF0pICkgewoJCQkJCWV2ZW50cyA9IE9iamVjdC5rZXlzKCBkYXRhLmV2ZW50cyB8fCB7fSApOwoJCQkJCWlmICggZXZlbnRzLmxlbmd0aCApIHsKCQkJCQkJZm9yICggaiA9IDA7ICh0eXBlID0gZXZlbnRzW2pdKSAhPT0gdW5kZWZpbmVkOyBqKysgKSB7CgkJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgoJCQkJCQkJLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBkYXRhX3ByaXYuY2FjaGVbIGtleSBdICkgewoJCQkJCQkvLyBEaXNjYXJkIGFueSByZW1haW5pbmcgYHByaXZhdGVgIGRhdGEKCQkJCQkJZGVsZXRlIGRhdGFfcHJpdi5jYWNoZVsga2V5IF07CgkJCQkJfQoJCQkJfQoJCQl9CgkJCS8vIERpc2NhcmQgYW55IHJlbWFpbmluZyBgdXNlcmAgZGF0YQoJCQlkZWxldGUgZGF0YV91c2VyLmNhY2hlWyBlbGVtWyBkYXRhX3VzZXIuZXhwYW5kbyBdIF07CgkJfQoJfSwKCglfZXZhbFVybDogZnVuY3Rpb24oIHVybCApIHsKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCQkJdHlwZTogIkdFVCIsCgkJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQkJYXN5bmM6IGZhbHNlLAoJCQlnbG9iYWw6IGZhbHNlLAoJCQkidGhyb3dzIjogdHJ1ZQoJCX0pOwoJfQp9KTsKCi8vIFN1cHBvcnQ6IDEueCBjb21wYXRpYmlsaXR5Ci8vIE1hbmlwdWxhdGluZyB0YWJsZXMgcmVxdWlyZXMgYSB0Ym9keQpmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoIGVsZW0sIGNvbnRlbnQgKSB7CglyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAidGFibGUiICkgJiYKCQlqUXVlcnkubm9kZU5hbWUoIGNvbnRlbnQubm9kZVR5cGUgPT09IDEgPyBjb250ZW50IDogY29udGVudC5maXJzdENoaWxkLCAidHIiICkgPwoKCQllbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8CgkJCWVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICkgOgoJCWVsZW07Cn0KCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsKCWVsZW0udHlwZSA9IChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpICE9PSBudWxsKSArICIvIiArIGVsZW0udHlwZTsKCXJldHVybiBlbGVtOwp9CmZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoIGVsZW0gKSB7Cgl2YXIgbWF0Y2ggPSByc2NyaXB0VHlwZU1hc2tlZC5leGVjKCBlbGVtLnR5cGUgKTsKCglpZiAoIG1hdGNoICkgewoJCWVsZW0udHlwZSA9IG1hdGNoWyAxIF07Cgl9IGVsc2UgewoJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCJ0eXBlIik7Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7Cgl2YXIgbCA9IGVsZW1zLmxlbmd0aCwKCQlpID0gMDsKCglmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJZGF0YV9wcml2LnNldCgKCQkJZWxlbXNbIGkgXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YV9wcml2LmdldCggcmVmRWxlbWVudHNbIGkgXSwgImdsb2JhbEV2YWwiICkKCQkpOwoJfQp9CgpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgewoJdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CgoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgoJaWYgKCBkYXRhX3ByaXYuaGFzRGF0YSggc3JjICkgKSB7CgkJcGRhdGFPbGQgPSBkYXRhX3ByaXYuYWNjZXNzKCBzcmMgKTsKCQlwZGF0YUN1ciA9IGRhdGFfcHJpdi5zZXQoIGRlc3QsIHBkYXRhT2xkICk7CgkJZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwoKCQlpZiAoIGV2ZW50cyApIHsKCQkJZGVsZXRlIHBkYXRhQ3VyLmhhbmRsZTsKCQkJcGRhdGFDdXIuZXZlbnRzID0ge307CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyAyLiBDb3B5IHVzZXIgZGF0YQoJaWYgKCBkYXRhX3VzZXIuaGFzRGF0YSggc3JjICkgKSB7CgkJdWRhdGFPbGQgPSBkYXRhX3VzZXIuYWNjZXNzKCBzcmMgKTsKCQl1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoIHt9LCB1ZGF0YU9sZCApOwoKCQlkYXRhX3VzZXIuc2V0KCBkZXN0LCB1ZGF0YUN1ciApOwoJfQp9CgoKZnVuY3Rpb24gZ2V0QWxsKCBjb250ZXh0LCB0YWcgKSB7Cgl2YXIgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyB8fCAiKiIgKSA6CgkJCWNvbnRleHQucXVlcnlTZWxlY3RvckFsbCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoKCQkJW107CgoJcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoIGNvbnRleHQsIHRhZyApID8KCQlqUXVlcnkubWVyZ2UoIFsgY29udGV4dCBdLCByZXQgKSA6CgkJcmV0Owp9CgovLyBTdXBwb3J0OiBJRSA+PSA5CmZ1bmN0aW9uIGZpeElucHV0KCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgoJLy8gRmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveCBvciByYWRpbyBidXR0b24uCglpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICYmIG1hbmlwdWxhdGlvbl9yY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgewoJCWRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOwoKCS8vIEZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiApIHsKCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7Cgl9Cn0KalF1ZXJ5LmZuLmV4dGVuZCh7Cgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgd3JhcDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWyAwIF0gKSB7CgoJCQkvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAoJCQl3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCApLmVxKCAwICkuY2xvbmUoIHRydWUgKTsKCgkJCWlmICggdGhpc1sgMCBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1sgMCBdICk7CgkJCX0KCgkJCXdyYXAubWFwKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSB0aGlzOwoKCQkJCXdoaWxlICggZWxlbS5maXJzdEVsZW1lbnRDaGlsZCApIHsKCQkJCQllbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQljb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCgkJCWlmICggY29udGVudHMubGVuZ3RoICkgewoJCQkJY29udGVudHMud3JhcEFsbCggaHRtbCApOwoKCQkJfSBlbHNlIHsKCQkJCXNlbGYuYXBwZW5kKCBodG1sICk7CgkJCX0KCQl9KTsKCX0sCgoJd3JhcDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBpc0Z1bmN0aW9uID8gaHRtbC5jYWxsKHRoaXMsIGkpIDogaHRtbCApOwoJCX0pOwoJfSwKCgl1bndyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWpRdWVyeS5ub2RlTmFtZSggdGhpcywgImJvZHkiICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CgkJCX0KCQl9KS5lbmQoKTsKCX0KfSk7CnZhciBjdXJDU1MsIGlmcmFtZSwKCS8vIHN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUgZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCgkvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKCXJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywKCXJtYXJnaW4gPSAvXm1hcmdpbi8sCglybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoLiopJCIsICJpIiApLAoJcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIGNvcmVfcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIgKSwKCXJyZWxOdW0gPSBuZXcgUmVnRXhwKCAiXihbKy1dKT0oIiArIGNvcmVfcG51bSArICIpIiwgImkiICksCgllbGVtZGlzcGxheSA9IHsgQk9EWTogImJsb2NrIiB9LAoKCWNzc1Nob3cgPSB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB2aXNpYmlsaXR5OiAiaGlkZGVuIiwgZGlzcGxheTogImJsb2NrIiB9LAoJY3NzTm9ybWFsVHJhbnNmb3JtID0gewoJCWxldHRlclNwYWNpbmc6IDAsCgkJZm9udFdlaWdodDogNDAwCgl9LAoKCWNzc0V4cGFuZCA9IFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXSwKCWNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgoJLy8gc2hvcnRjdXQgZm9yIG5hbWVzIHRoYXQgYXJlIG5vdCB2ZW5kb3IgcHJlZml4ZWQKCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQlyZXR1cm4gbmFtZTsKCX0KCgkvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCgl2YXIgY2FwTmFtZSA9IG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAoJCW9yaWdOYW1lID0gbmFtZSwKCQlpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCW5hbWUgPSBjc3NQcmVmaXhlc1sgaSBdICsgY2FwTmFtZTsKCQlpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJCXJldHVybiBuYW1lOwoJCX0KCX0KCglyZXR1cm4gb3JpZ05hbWU7Cn0KCmZ1bmN0aW9uIGlzSGlkZGVuKCBlbGVtLCBlbCApIHsKCS8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CgkvLyBpbiB0aGF0IGNhc2UsIGVsZW1lbnQgd2lsbCBiZSBzZWNvbmQgYXJndW1lbnQKCWVsZW0gPSBlbCB8fCBlbGVtOwoJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cn0KCi8vIE5PVEU6IHdlJ3ZlIGluY2x1ZGVkIHRoZSAid2luZG93IiBpbiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZQovLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgpmdW5jdGlvbiBnZXRTdHlsZXMoIGVsZW0gKSB7CglyZXR1cm4gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKTsKfQoKZnVuY3Rpb24gc2hvd0hpZGUoIGVsZW1lbnRzLCBzaG93ICkgewoJdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCgkJdmFsdWVzWyBpbmRleCBdID0gZGF0YV9wcml2LmdldCggZWxlbSwgIm9sZGRpc3BsYXkiICk7CgkJZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheTsKCQlpZiAoIHNob3cgKSB7CgkJCS8vIFJlc2V0IHRoZSBpbmxpbmUgZGlzcGxheSBvZiB0aGlzIGVsZW1lbnQgdG8gbGVhcm4gaWYgaXQgaXMKCQkJLy8gYmVpbmcgaGlkZGVuIGJ5IGNhc2NhZGVkIHJ1bGVzIG9yIG5vdAoJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gJiYgZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQkJZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CgkJCX0KCgkJCS8vIFNldCBlbGVtZW50cyB3aGljaCBoYXZlIGJlZW4gb3ZlcnJpZGRlbiB3aXRoIGRpc3BsYXk6IG5vbmUKCQkJLy8gaW4gYSBzdHlsZXNoZWV0IHRvIHdoYXRldmVyIHRoZSBkZWZhdWx0IGJyb3dzZXIgc3R5bGUgaXMKCQkJLy8gZm9yIHN1Y2ggYW4gZWxlbWVudAoJCQlpZiAoIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgaXNIaWRkZW4oIGVsZW0gKSApIHsKCQkJCXZhbHVlc1sgaW5kZXggXSA9IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sICJvbGRkaXNwbGF5IiwgY3NzX2RlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICkgewoJCQkJaGlkZGVuID0gaXNIaWRkZW4oIGVsZW0gKTsKCgkJCQlpZiAoIGRpc3BsYXkgJiYgZGlzcGxheSAhPT0gIm5vbmUiIHx8ICFoaWRkZW4gKSB7CgkJCQkJZGF0YV9wcml2LnNldCggZWxlbSwgIm9sZGRpc3BsYXkiLCBoaWRkZW4gPyBkaXNwbGF5IDogalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoICFzaG93IHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgKSB7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCQl2YXIgc3R5bGVzLCBsZW4sCgkJCQltYXAgPSB7fSwKCQkJCWkgPSAwOwoKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSggbmFtZSApICkgewoJCQkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7CgkJCQlsZW4gPSBuYW1lLmxlbmd0aDsKCgkJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQltYXBbIG5hbWVbIGkgXSBdID0galF1ZXJ5LmNzcyggZWxlbSwgbmFtZVsgaSBdLCBmYWxzZSwgc3R5bGVzICk7CgkJCQl9CgoJCQkJcmV0dXJuIG1hcDsKCQkJfQoKCQkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApIDoKCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsKCQl9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCglzaG93OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMsIHRydWUgKTsKCX0sCgloaWRlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKCX0sCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSApIHsKCQlpZiAoIHR5cGVvZiBzdGF0ZSA9PT0gImJvb2xlYW4iICkgewoJCQlyZXR1cm4gc3RhdGUgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCBpc0hpZGRlbiggdGhpcyApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuc2hvdygpOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5KCB0aGlzICkuaGlkZSgpOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKCWNzc051bWJlcjogewoJCSJjb2x1bW5Db3VudCI6IHRydWUsCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JkZXIiOiB0cnVlLAoJCSJvcnBoYW5zIjogdHJ1ZSwKCQkid2lkb3dzIjogdHJ1ZSwKCQkiekluZGV4IjogdHJ1ZSwKCQkiem9vbSI6IHRydWUKCX0sCgoJLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQoJY3NzUHJvcHM6IHsKCQkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CgkJImZsb2F0IjogImNzc0Zsb2F0IgoJfSwKCgkvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEgKSB7CgkJLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCXZhciByZXQsIHR5cGUsIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBvcmlnTmFtZSApICk7CgoJCS8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KCQkvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07CgoJCS8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCgkJCS8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICYmIChyZXQgPSBycmVsTnVtLmV4ZWMoIHZhbHVlICkpICkgewoJCQkJdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwoJCQkJLy8gRml4ZXMgYnVnICM5MjM3CgkJCQl0eXBlID0gIm51bWJlciI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IE5hTiBhbmQgbnVsbCB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgoJCQlpZiAoIHZhbHVlID09IG51bGwgfHwgdHlwZSA9PT0gIm51bWJlciIgJiYgaXNOYU4oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQoJCQlpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewoJCQkJdmFsdWUgKz0gInB4IjsKCQkJfQoKCQkJLy8gRml4ZXMgIzg5MDgsIGl0IGNhbiBiZSBkb25lIG1vcmUgY29ycmVjdGx5IGJ5IHNwZWNpZnlpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKCQkJLy8gYnV0IGl0IHdvdWxkIG1lYW4gdG8gZGVmaW5lIGVpZ2h0IChmb3IgZXZlcnkgcHJvYmxlbWF0aWMgcHJvcGVydHkpIGlkZW50aWNhbCBmdW5jdGlvbnMKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsKCQkJCXN0eWxlWyBuYW1lIF0gPSAiaW5oZXJpdCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3R5bGVbIG5hbWUgXSA9IHZhbHVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoKCQkJLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKCQkJcmV0dXJuIHN0eWxlWyBuYW1lIF07CgkJfQoJfSwKCgljc3M6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzICkgewoJCXZhciB2YWwsIG51bSwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CgkJfQoKCQkvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKCQlpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CgkJCXZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwoJCX0KCgkJLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwoJCWlmICggZXh0cmEgPT09ICIiIHx8IGV4dHJhICkgewoJCQludW0gPSBwYXJzZUZsb2F0KCB2YWwgKTsKCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7CgkJfQoJCXJldHVybiB2YWw7Cgl9Cn0pOwoKY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKCXZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAoJCWNvbXB1dGVkID0gX2NvbXB1dGVkIHx8IGdldFN0eWxlcyggZWxlbSApLAoKCQkvLyBTdXBwb3J0OiBJRTkKCQkvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKCQlyZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKSB8fCBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAoJCXN0eWxlID0gZWxlbS5zdHlsZTsKCglpZiAoIGNvbXB1dGVkICkgewoKCQlpZiAoIHJldCA9PT0gIiIgJiYgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7CgkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOwoJCX0KCgkJLy8gU3VwcG9ydDogU2FmYXJpIDUuMQoJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJLy8gU2FmYXJpIDUuMS43IChhdCBsZWFzdCkgcmV0dXJucyBwZXJjZW50YWdlIGZvciBhIGxhcmdlciBzZXQgb2YgdmFsdWVzLCBidXQgd2lkdGggc2VlbXMgdG8gYmUgcmVsaWFibHkgcGl4ZWxzCgkJLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCgkJaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgcm1hcmdpbi50ZXN0KCBuYW1lICkgKSB7CgoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCXdpZHRoID0gc3R5bGUud2lkdGg7CgkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJcmV0ID0gY29tcHV0ZWQud2lkdGg7CgoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CgkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn07CgoKZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCApIHsKCXZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgkJLy8gR3VhcmQgYWdhaW5zdCB1bmRlZmluZWQgInN1YnRyYWN0IiwgZS5nLiwgd2hlbiB1c2VkIGFzIGluIGNzc0hvb2tzCgkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCXZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7Cgl2YXIgaSA9IGV4dHJhID09PSAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSA/CgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCgkJNCA6CgkJLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwoJCW5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCgkJdmFsID0gMDsKCglmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CgkJLy8gYm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luLCBzbyBhZGQgaXQgaWYgd2Ugd2FudCBpdAoJCWlmICggZXh0cmEgPT09ICJtYXJnaW4iICkgewoJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQlpZiAoIGlzQm9yZGVyQm94ICkgewoJCQkvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKCQkJaWYgKCBleHRyYSA9PT0gImNvbnRlbnQiICkgewoJCQkJdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewoJCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLAoJCXZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmcgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMgKSA9PT0gImJvcmRlci1ib3giOwoKCS8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZAoJLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CgkvLyBNYXRoTUwgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00OTE2NjgKCWlmICggdmFsIDw9IDAgfHwgdmFsID09IG51bGwgKSB7CgkJLy8gRmFsbCBiYWNrIHRvIGNvbXB1dGVkIHRoZW4gdW5jb21wdXRlZCBjc3MgaWYgbmVjZXNzYXJ5CgkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKCQlpZiAoIHZhbCA8IDAgfHwgdmFsID09IG51bGwgKSB7CgkJCXZhbCA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQl9CgoJCS8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCgkJaWYgKCBybnVtbm9ucHgudGVzdCh2YWwpICkgewoJCQlyZXR1cm4gdmFsOwoJCX0KCgkJLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKCQkvLyBmb3IgZ2V0Q29tcHV0ZWRTdHlsZSBzaWxlbnRseSBmYWxscyBiYWNrIHRvIHRoZSByZWxpYWJsZSBlbGVtLnN0eWxlCgkJdmFsdWVJc0JvcmRlckJveCA9IGlzQm9yZGVyQm94ICYmICggalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBuYW1lIF0gKTsKCgkJLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKCQl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoJfQoKCS8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCglyZXR1cm4gKCB2YWwgKwoJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQllbGVtLAoJCQluYW1lLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveCwKCQkJc3R5bGVzCgkJKQoJKSArICJweCI7Cn0KCi8vIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CmZ1bmN0aW9uIGNzc19kZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7Cgl2YXIgZG9jID0gZG9jdW1lbnQsCgkJZGlzcGxheSA9IGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwoKCWlmICggIWRpc3BsYXkgKSB7CgkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCgkJLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgfHwgIWRpc3BsYXkgKSB7CgkJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQoJCQlpZnJhbWUgPSAoIGlmcmFtZSB8fAoJCQkJalF1ZXJ5KCI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IikKCQkJCS5jc3MoICJjc3NUZXh0IiwgImRpc3BsYXk6YmxvY2sgIWltcG9ydGFudCIgKQoJCQkpLmFwcGVuZFRvKCBkb2MuZG9jdW1lbnRFbGVtZW50ICk7CgoJCQkvLyBBbHdheXMgd3JpdGUgYSBuZXcgSFRNTCBza2VsZXRvbiBzbyBXZWJraXQgYW5kIEZpcmVmb3ggZG9uJ3QgY2hva2Ugb24gcmV1c2UKCQkJZG9jID0gKCBpZnJhbWVbMF0uY29udGVudFdpbmRvdyB8fCBpZnJhbWVbMF0uY29udGVudERvY3VtZW50ICkuZG9jdW1lbnQ7CgkJCWRvYy53cml0ZSgiPCFkb2N0eXBlIGh0bWw+PGh0bWw+PGJvZHk+Iik7CgkJCWRvYy5jbG9zZSgpOwoKCQkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCQkJaWZyYW1lLmRldGFjaCgpOwoJCX0KCgkJLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CgkJZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwoJfQoKCXJldHVybiBkaXNwbGF5Owp9CgovLyBDYWxsZWQgT05MWSBmcm9tIHdpdGhpbiBjc3NfZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewoJdmFyIGVsZW0gPSBqUXVlcnkoIGRvYy5jcmVhdGVFbGVtZW50KCBuYW1lICkgKS5hcHBlbmRUbyggZG9jLmJvZHkgKSwKCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbVswXSwgImRpc3BsYXkiICk7CgllbGVtLnJlbW92ZSgpOwoJcmV0dXJuIGRpc3BsYXk7Cn0KCmpRdWVyeS5lYWNoKFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CglqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCwgZXh0cmEgKSB7CgkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkvLyBjZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KCQkJCS8vIGhvd2V2ZXIsIGl0IG11c3QgaGF2ZSBhIGN1cnJlbnQgZGlzcGxheSBzdHlsZSB0aGF0IHdvdWxkIGJlbmVmaXQgZnJvbSB0aGlzCgkJCQlyZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCAmJiByZGlzcGxheXN3YXAudGVzdCggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKSA/CgkJCQkJalF1ZXJ5LnN3YXAoIGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJCQl9KSA6CgkJCQkJZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJfQoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKCQkJdmFyIHN0eWxlcyA9IGV4dHJhICYmIGdldFN0eWxlcyggZWxlbSApOwoJCQlyZXR1cm4gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBleHRyYSA/CgkJCQlhdWdtZW50V2lkdGhPckhlaWdodCgKCQkJCQllbGVtLAoJCQkJCW5hbWUsCgkJCQkJZXh0cmEsCgkJCQkJalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCQlzdHlsZXMKCQkJCSkgOiAwCgkJCSk7CgkJfQoJfTsKfSk7CgovLyBUaGVzZSBob29rcyBjYW5ub3QgYmUgYWRkZWQgdW50aWwgRE9NIHJlYWR5IGJlY2F1c2UgdGhlIHN1cHBvcnQgdGVzdAovLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkKalF1ZXJ5KGZ1bmN0aW9uKCkgewoJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCWlmICggIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlTWFyZ2luUmlnaHQgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCQkJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJCQkvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKCQkJCQlyZXR1cm4galF1ZXJ5LnN3YXAoIGVsZW0sIHsgImRpc3BsYXkiOiAiaW5saW5lLWJsb2NrIiB9LAoJCQkJCQljdXJDU1MsIFsgZWxlbSwgIm1hcmdpblJpZ2h0IiBdICk7CgkJCQl9CgkJCX0KCQl9OwoJfQoKCS8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAoJLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAoJLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIHdlIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKCWlmICggIWpRdWVyeS5zdXBwb3J0LnBpeGVsUG9zaXRpb24gJiYgalF1ZXJ5LmZuLnBvc2l0aW9uICkgewoJCWpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGksIHByb3AgKSB7CgkJCWpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gewoJCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkJY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKCQkJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CgkJCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CgkJCQkJCQlqUXVlcnkoIGVsZW0gKS5wb3NpdGlvbigpWyBwcm9wIF0gKyAicHgiIDoKCQkJCQkJCWNvbXB1dGVkOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCX0KCn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCQkvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgoJCS8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMKCQlyZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCA8PSAwICYmIGVsZW0ub2Zmc2V0SGVpZ2h0IDw9IDA7Cgl9OwoKCWpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oIGVsZW0gKTsKCX07Cn0KCi8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKalF1ZXJ5LmVhY2goewoJbWFyZ2luOiAiIiwKCXBhZGRpbmc6ICIiLAoJYm9yZGVyOiAiV2lkdGgiCn0sIGZ1bmN0aW9uKCBwcmVmaXgsIHN1ZmZpeCApIHsKCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CgkJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBpID0gMCwKCQkJCWV4cGFuZGVkID0ge30sCgoJCQkJLy8gYXNzdW1lcyBhIHNpbmdsZSBudW1iZXIgaWYgbm90IGEgc3RyaW5nCgkJCQlwYXJ0cyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiICIpIDogWyB2YWx1ZSBdOwoKCQkJZm9yICggOyBpIDwgNDsgaSsrICkgewoJCQkJZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQoJCQkJCXBhcnRzWyBpIF0gfHwgcGFydHNbIGkgLSAyIF0gfHwgcGFydHNbIDAgXTsKCQkJfQoKCQkJcmV0dXJuIGV4cGFuZGVkOwoJCX0KCX07CgoJaWYgKCAhcm1hcmdpbi50ZXN0KCBwcmVmaXggKSApIHsKCQlqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwoJfQp9KTsKdmFyIHIyMCA9IC8lMjAvZywKCXJicmFja2V0ID0gL1xbXF0kLywKCXJDUkxGID0gL1xyP1xuL2csCglyc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCglyc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGpRdWVyeS5wYXJhbSggdGhpcy5zZXJpYWxpemVBcnJheSgpICk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewoJCQkvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwoJCQl2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwoJCQlyZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKXsKCQkJdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgkJCS8vIFVzZSAuaXMoIjpkaXNhYmxlZCIpIHNvIHRoYXQgZmllbGRzZXRbZGlzYWJsZWRdIHdvcmtzCgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSggdGhpcyApLmlzKCAiOmRpc2FibGVkIiApICYmCgkJCQlyc3VibWl0dGFibGUudGVzdCggdGhpcy5ub2RlTmFtZSApICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCggdHlwZSApICYmCgkJCQkoIHRoaXMuY2hlY2tlZCB8fCAhbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwoJCX0pCgkJLm1hcChmdW5jdGlvbiggaSwgZWxlbSApewoJCQl2YXIgdmFsID0galF1ZXJ5KCB0aGlzICkudmFsKCk7CgoJCQlyZXR1cm4gdmFsID09IG51bGwgPwoJCQkJbnVsbCA6CgkJCQlqUXVlcnkuaXNBcnJheSggdmFsICkgPwoJCQkJCWpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApewoJCQkJCQlyZXR1cm4geyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJCQkJfSkgOgoJCQkJCXsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy9rZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24oIGEsIHRyYWRpdGlvbmFsICkgewoJdmFyIHByZWZpeCwKCQlzID0gW10sCgkJYWRkID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQoJCQl2YWx1ZSA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApID8gdmFsdWUoKSA6ICggdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKTsKCQkJc1sgcy5sZW5ndGggXSA9IGVuY29kZVVSSUNvbXBvbmVudCgga2V5ICkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIHZhbHVlICk7CgkJfTsKCgkvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgoJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewoJCXRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncyAmJiBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsOwoJfQoKCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCglpZiAoIGpRdWVyeS5pc0FycmF5KCBhICkgfHwgKCBhLmpxdWVyeSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGEgKSApICkgewoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKCQl9KTsKCgl9IGVsc2UgewoJCS8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgoJCS8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgoJCWZvciAoIHByZWZpeCBpbiBhICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCglyZXR1cm4gcy5qb2luKCAiJiIgKS5yZXBsYWNlKCByMjAsICIrIiApOwp9OwoKZnVuY3Rpb24gYnVpbGRQYXJhbXMoIHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkICkgewoJdmFyIG5hbWU7CgoJaWYgKCBqUXVlcnkuaXNBcnJheSggb2JqICkgKSB7CgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCgkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7CgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQlhZGQoIHByZWZpeCwgdiApOwoKCQkJfSBlbHNlIHsKCQkJCS8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQpqUXVlcnkuZWFjaCggKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsKCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGRhdGEsIGZuICkgewoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOgoJCQl0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwoJfSwKCXVuYmluZDogZnVuY3Rpb24oIHR5cGVzLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vZmYoIHR5cGVzLCBudWxsLCBmbiApOwoJfSwKCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsKCX0sCgl1bmRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBmbiApIHsKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZiggc2VsZWN0b3IsICIqKiIgKSA6IHRoaXMub2ZmKCB0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCX0KfSk7CnZhcgoJLy8gRG9jdW1lbnQgbG9jYXRpb24KCWFqYXhMb2NQYXJ0cywKCWFqYXhMb2NhdGlvbiwKCglhamF4X25vbmNlID0galF1ZXJ5Lm5vdygpLAoKCWFqYXhfcnF1ZXJ5ID0gL1w/LywKCXJoYXNoID0gLyMuKiQvLAoJcnRzID0gLyhbPyZdKV89W14mXSovLAoJcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL21nLAoJLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCglybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAoJcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCglycHJvdG9jb2wgPSAvXlwvXC8vLAoJcnVybCA9IC9eKFtcdy4rLV0rOikoPzpcL1wvKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKCgkvLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCglfbG9hZCA9IGpRdWVyeS5mbi5sb2FkLAoKCS8qIFByZWZpbHRlcnMKCSAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCgkgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgoJICogICAgLSBCRUZPUkUgYXNraW5nIGZvciBhIHRyYW5zcG9ydAoJICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQoJICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQoJICogNCkgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKCSAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAoJICovCglwcmVmaWx0ZXJzID0ge30sCgoJLyogVHJhbnNwb3J0cyBiaW5kaW5ncwoJICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQoJICogMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKCSAqIDMpIHNlbGVjdGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGdvIHRvICIqIiBpZiBuZWVkZWQKCSAqLwoJdHJhbnNwb3J0cyA9IHt9LAoKCS8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbgoJYWxsVHlwZXMgPSAiKi8iLmNvbmNhdCgiKiIpOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CglhamF4TG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmOwp9IGNhdGNoKCBlICkgewoJLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKCS8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCglhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCWFqYXhMb2NhdGlvbi5ocmVmID0gIiI7CglhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKCS8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCglyZXR1cm4gZnVuY3Rpb24oIGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYyApIHsKCgkJaWYgKCB0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIiApIHsKCQkJZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKCQkJZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOwoJCX0KCgkJdmFyIGRhdGFUeXBlLAoJCQlpID0gMCwKCQkJZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCQkJLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgoJCQl3aGlsZSAoIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSApIHsKCQkJCS8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCgkJCQlpZiAoIGRhdGFUeXBlWzBdID09PSAiKyIgKSB7CgkJCQkJZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSggMSApIHx8ICIqIjsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS51bnNoaWZ0KCBmdW5jICk7CgoJCQkJLy8gT3RoZXJ3aXNlIGFwcGVuZAoJCQkJfSBlbHNlIHsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS5wdXNoKCBmdW5jICk7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCgl2YXIgaW5zcGVjdGVkID0ge30sCgkJc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7CgkJdmFyIHNlbGVjdGVkOwoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsKCQkJdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3RvcnkoIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkJaWYoIHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAic3RyaW5nIiAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkWyBkYXRhVHlwZU9yVHJhbnNwb3J0IF0gKSB7CgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gc2VsZWN0ZWQ7Cgl9CgoJcmV0dXJuIGluc3BlY3QoIG9wdGlvbnMuZGF0YVR5cGVzWyAwIF0gKSB8fCAhaW5zcGVjdGVkWyAiKiIgXSAmJiBpbnNwZWN0KCAiKiIgKTsKfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwpmdW5jdGlvbiBhamF4RXh0ZW5kKCB0YXJnZXQsIHNyYyApIHsKCXZhciBrZXksIGRlZXAsCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwoKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8IChkZWVwID0ge30pICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7CglpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkICkgewoJCXJldHVybiBfbG9hZC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9CgoJdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwKCQlzZWxmID0gdGhpcywKCQlvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoKCWlmICggb2ZmID49IDAgKSB7CgkJc2VsZWN0b3IgPSB1cmwuc2xpY2UoIG9mZiApOwoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7Cgl9CgoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCgkJLy8gV2UgYXNzdW1lIHRoYXQgaXQncyB0aGUgY2FsbGJhY2sKCQljYWxsYmFjayA9IHBhcmFtczsKCQlwYXJhbXMgPSB1bmRlZmluZWQ7CgoJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwoJfSBlbHNlIGlmICggcGFyYW1zICYmIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgewoJCXR5cGUgPSAiUE9TVCI7Cgl9CgoJLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKCWlmICggc2VsZi5sZW5ndGggPiAwICkgewoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgoJCQkvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKCQkJdHlwZTogdHlwZSwKCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJZGF0YTogcGFyYW1zCgkJfSkuZG9uZShmdW5jdGlvbiggcmVzcG9uc2VUZXh0ICkgewoKCQkJLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCgkJCXJlc3BvbnNlID0gYXJndW1lbnRzOwoKCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/CgoJCQkJLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CgkJCQkvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMKCQkJCWpRdWVyeSgiPGRpdj4iKS5hcHBlbmQoIGpRdWVyeS5wYXJzZUhUTUwoIHJlc3BvbnNlVGV4dCApICkuZmluZCggc2VsZWN0b3IgKSA6CgoJCQkJLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKCQkJCXJlc3BvbnNlVGV4dCApOwoKCQl9KS5jb21wbGV0ZSggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCXNlbGYuZWFjaCggY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsganFYSFIucmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0gKTsKCQl9KTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCBbICJhamF4U3RhcnQiLCAiYWpheFN0b3AiLCAiYWpheENvbXBsZXRlIiwgImFqYXhFcnJvciIsICJhamF4U3VjY2VzcyIsICJhamF4U2VuZCIgXSwgZnVuY3Rpb24oIGksIHR5cGUgKXsKCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIGZuICl7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKCWxhc3RNb2RpZmllZDoge30sCglldGFnOiB7fSwKCglhamF4U2V0dGluZ3M6IHsKCQl1cmw6IGFqYXhMb2NhdGlvbiwKCQl0eXBlOiAiR0VUIiwKCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLAoJCWdsb2JhbDogdHJ1ZSwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCgkJLyoKCQl0aW1lb3V0OiAwLAoJCWRhdGE6IG51bGwsCgkJZGF0YVR5cGU6IG51bGwsCgkJdXNlcm5hbWU6IG51bGwsCgkJcGFzc3dvcmQ6IG51bGwsCgkJY2FjaGU6IG51bGwsCgkJdGhyb3dzOiBmYWxzZSwKCQl0cmFkaXRpb25hbDogZmFsc2UsCgkJaGVhZGVyczoge30sCgkJKi8KCgkJYWNjZXB0czogewoJCQkiKiI6IGFsbFR5cGVzLAoJCQl0ZXh0OiAidGV4dC9wbGFpbiIsCgkJCWh0bWw6ICJ0ZXh0L2h0bWwiLAoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKCQkJanNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIKCQl9LAoKCQljb250ZW50czogewoJCQl4bWw6IC94bWwvLAoJCQlodG1sOiAvaHRtbC8sCgkJCWpzb246IC9qc29uLwoJCX0sCgoJCXJlc3BvbnNlRmllbGRzOiB7CgkJCXhtbDogInJlc3BvbnNlWE1MIiwKCQkJdGV4dDogInJlc3BvbnNlVGV4dCIsCgkJCWpzb246ICJyZXNwb25zZUpTT04iCgkJfSwKCgkJLy8gRGF0YSBjb252ZXJ0ZXJzCgkJLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKCQljb252ZXJ0ZXJzOiB7CgoJCQkvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKCQkJIiogdGV4dCI6IFN0cmluZywKCgkJCS8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQoJCQkidGV4dCBodG1sIjogdHJ1ZSwKCgkJCS8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KCQkJInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgoJCQkvLyBQYXJzZSB0ZXh0IGFzIHhtbAoJCQkidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKCQl9LAoKCQkvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgoJCS8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKCQkvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQoJCS8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQoJCWZsYXRPcHRpb25zOiB7CgkJCXVybDogdHJ1ZSwKCQkJY29udGV4dDogdHJ1ZQoJCX0KCX0sCgoJLy8gQ3JlYXRlcyBhIGZ1bGwgZmxlZGdlZCBzZXR0aW5ncyBvYmplY3QgaW50byB0YXJnZXQKCS8vIHdpdGggYm90aCBhamF4U2V0dGluZ3MgYW5kIHNldHRpbmdzIGZpZWxkcy4KCS8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCglhamF4U2V0dXA6IGZ1bmN0aW9uKCB0YXJnZXQsIHNldHRpbmdzICkgewoJCXJldHVybiBzZXR0aW5ncyA/CgoJCQkvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAoJCQlhamF4RXh0ZW5kKCBhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKSwgc2V0dGluZ3MgKSA6CgoJCQkvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCgkJCWFqYXhFeHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCApOwoJfSwKCglhamF4UHJlZmlsdGVyOiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMgKSwKCWFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLAoKCS8vIE1haW4gbWV0aG9kCglhamF4OiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkvLyBJZiB1cmwgaXMgYW4gb2JqZWN0LCBzaW11bGF0ZSBwcmUtMS41IHNpZ25hdHVyZQoJCWlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7CgkJCW9wdGlvbnMgPSB1cmw7CgkJCXVybCA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCXZhciB0cmFuc3BvcnQsCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KCQkJY2FjaGVVUkwsCgkJCS8vIFJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nLAoJCQlyZXNwb25zZUhlYWRlcnMsCgkJCS8vIHRpbWVvdXQgaGFuZGxlCgkJCXRpbWVvdXRUaW1lciwKCQkJLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCgkJCXBhcnRzLAoJCQkvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKCQkJZmlyZUdsb2JhbHMsCgkJCS8vIExvb3AgdmFyaWFibGUKCQkJaSwKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCQkJLy8gQ2FsbGJhY2tzIGNvbnRleHQKCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCgkJCS8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KCQkJZ2xvYmFsRXZlbnRDb250ZXh0ID0gcy5jb250ZXh0ICYmICggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/CgkJCQlqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoKCQkJCWpRdWVyeS5ldmVudCwKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLAoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoJCQkvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQoJCQlyZXF1ZXN0SGVhZGVycyA9IHt9LAoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCgkJCS8vIFRoZSBqcVhIUiBzdGF0ZQoJCQlzdGF0ZSA9IDAsCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQoJCQlzdHJBYm9ydCA9ICJjYW5jZWxlZCIsCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCQkJaWYgKCAhcmVzcG9uc2VIZWFkZXJzICkgewoJCQkJCQkJcmVzcG9uc2VIZWFkZXJzID0ge307CgkJCQkJCQl3aGlsZSAoIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMoIHJlc3BvbnNlSGVhZGVyc1N0cmluZyApKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNbIGtleS50b0xvd2VyQ2FzZSgpIF07CgkJCQkJfQoJCQkJCXJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOwoJCQkJfSwKCgkJCQkvLyBSYXcgc3RyaW5nCgkJCQlnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZSA9PT0gMiA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CgkJCQl9LAoKCQkJCS8vIENhY2hlcyB0aGUgaGVhZGVyCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJCQkJdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQluYW1lID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gfHwgbmFtZTsKCQkJCQkJcmVxdWVzdEhlYWRlcnNbIG5hbWUgXSA9IHZhbHVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKCQkJCW92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCQlzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewoJCQkJCXZhciBjb2RlOwoJCQkJCWlmICggbWFwICkgewoJCQkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQkJCWZvciAoIGNvZGUgaW4gbWFwICkgewoJCQkJCQkJCS8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2sgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKCQkJCQkJCQlzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcwoJCQkJCQkJanFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIENhbmNlbCB0aGUgcmVxdWVzdAoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCBzdGF0dXNUZXh0ICkgewoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwoJCQkJCWlmICggdHJhbnNwb3J0ICkgewoJCQkJCQl0cmFuc3BvcnQuYWJvcnQoIGZpbmFsVGV4dCApOwoJCQkJCX0KCQkJCQlkb25lKCAwLCBmaW5hbFRleHQgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfTsKCgkJLy8gQXR0YWNoIGRlZmVycmVkcwoJCWRlZmVycmVkLnByb21pc2UoIGpxWEhSICkuY29tcGxldGUgPSBjb21wbGV0ZURlZmVycmVkLmFkZDsKCQlqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKCQlqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CgoJCS8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKHByZWZpbHRlcnMgbWlnaHQgZXhwZWN0IGl0KQoJCS8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCgkJLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsIHx8IGFqYXhMb2NhdGlvbiApICsgIiIgKS5yZXBsYWNlKCByaGFzaCwgIiIgKQoJCQkucmVwbGFjZSggcnByb3RvY29sLCBhamF4TG9jUGFydHNbIDEgXSArICIvLyIgKTsKCgkJLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CgkJcy50eXBlID0gb3B0aW9ucy5tZXRob2QgfHwgb3B0aW9ucy50eXBlIHx8IHMubWV0aG9kIHx8IHMudHlwZTsKCgkJLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAoJCXMuZGF0YVR5cGVzID0galF1ZXJ5LnRyaW0oIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbIiJdOwoKCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gd2UgaGF2ZSBhIHByb3RvY29sOmhvc3Q6cG9ydCBtaXNtYXRjaAoJCWlmICggcy5jcm9zc0RvbWFpbiA9PSBudWxsICkgewoJCQlwYXJ0cyA9IHJ1cmwuZXhlYyggcy51cmwudG9Mb3dlckNhc2UoKSApOwoJCQlzLmNyb3NzRG9tYWluID0gISEoIHBhcnRzICYmCgkJCQkoIHBhcnRzWyAxIF0gIT09IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT09IGFqYXhMb2NQYXJ0c1sgMiBdIHx8CgkJCQkJKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/ICI4MCIgOiAiNDQzIiApICkgIT09CgkJCQkJCSggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/ICI4MCIgOiAiNDQzIiApICkgKQoJCQkpOwoJCX0KCgkJLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsKCQl9CgoJCS8vIEFwcGx5IHByZWZpbHRlcnMKCQlpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQlyZXR1cm4ganFYSFI7CgkJfQoKCQkvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwoJCWZpcmVHbG9iYWxzID0gcy5nbG9iYWw7CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwoJCX0KCgkJLy8gVXBwZXJjYXNlIHRoZSB0eXBlCgkJcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgoJCS8vIERldGVybWluZSBpZiByZXF1ZXN0IGhhcyBjb250ZW50CgkJcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdCggcy50eXBlICk7CgoJCS8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQoJCS8vIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciBsYXRlciBvbgoJCWNhY2hlVVJMID0gcy51cmw7CgoJCS8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CgkJaWYgKCAhcy5oYXNDb250ZW50ICkgewoKCQkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybAoJCQlpZiAoIHMuZGF0YSApIHsKCQkJCWNhY2hlVVJMID0gKCBzLnVybCArPSAoIGFqYXhfcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YSApOwoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoJCQkJcy51cmwgPSBydHMudGVzdCggY2FjaGVVUkwgKSA/CgoJCQkJCS8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSAnXycgcGFyYW1ldGVyLCBzZXQgaXRzIHZhbHVlCgkJCQkJY2FjaGVVUkwucmVwbGFjZSggcnRzLCAiJDFfPSIgKyBhamF4X25vbmNlKysgKSA6CgoJCQkJCS8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKCQkJCQljYWNoZVVSTCArICggYWpheF9ycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgIl89IiArIGFqYXhfbm9uY2UrKzsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOwoJCQl9CgkJCWlmICggalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAoJCWlmICggcy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOwoJCX0KCgkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoCgkJCSJBY2NlcHQiLAoJCQlzLmRhdGFUeXBlc1sgMCBdICYmIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gKyAoIHMuZGF0YVR5cGVzWyAwIF0gIT09ICIqIiA/ICIsICIgKyBhbGxUeXBlcyArICI7IHE9MC4wMSIgOiAiIiApIDoKCQkJCXMuYWNjZXB0c1sgIioiIF0KCQkpOwoKCQkvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKCQl9CgoJCS8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKCQlpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CgkJCS8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgoJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCQl9CgoJCS8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgoJCXN0ckFib3J0ID0gImFib3J0IjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCgkJZm9yICggaSBpbiB7IHN1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMSB9ICkgewoJCQlqcVhIUlsgaSBdKCBzWyBpIF0gKTsKCQl9CgoJCS8vIEdldCB0cmFuc3BvcnQKCQl0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CgkJaWYgKCAhdHJhbnNwb3J0ICkgewoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsKCQl9IGVsc2UgewoJCQlqcVhIUi5yZWFkeVN0YXRlID0gMTsKCgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJanFYSFIuYWJvcnQoInRpbWVvdXQiKTsKCQkJCX0sIHMudGltZW91dCApOwoJCQl9CgoJCQl0cnkgewoJCQkJc3RhdGUgPSAxOwoJCQkJdHJhbnNwb3J0LnNlbmQoIHJlcXVlc3RIZWFkZXJzLCBkb25lICk7CgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZG9uZSggLTEsIGUgKTsKCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyBlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsKCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwKCQkJCXN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKCQkJLy8gQ2FsbGVkIG9uY2UKCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU3RhdGUgaXMgImRvbmUiIG5vdwoJCQlzdGF0ZSA9IDI7CgoJCQkvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwoJCQlpZiAoIHRpbWVvdXRUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggdGltZW91dFRpbWVyICk7CgkJCX0KCgkJCS8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCgkJCS8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCgkJCS8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCgkJCS8vIFNldCByZWFkeVN0YXRlCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7CgoJCQkvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsKCgkJCS8vIEdldCByZXNwb25zZSBkYXRhCgkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICk7CgkJCX0KCgkJCS8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKCQkJcmVzcG9uc2UgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKTsKCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCgkJCWlmICggaXNTdWNjZXNzICkgewoKCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJldGFnIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gaWYgbm8gY29udGVudAoJCQkJaWYgKCBzdGF0dXMgPT09IDIwNCB8fCBzLnR5cGUgPT09ICJIRUFEIiApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7CgoJCQkJLy8gaWYgbm90IG1vZGlmaWVkCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQKCQkJCX0gZWxzZSB7CgkJCQkJc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwoJCQkJCWVycm9yID0gcmVzcG9uc2UuZXJyb3I7CgkJCQkJaXNTdWNjZXNzID0gIWVycm9yOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKCQkJCS8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cwoJCQkJZXJyb3IgPSBzdGF0dXNUZXh0OwoJCQkJaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJlcnJvciI7CgkJCQkJaWYgKCBzdGF0dXMgPCAwICkgewoJCQkJCQlzdGF0dXMgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKCQkJanFYSFIuc3RhdHVzID0gc3RhdHVzOwoJCQlqcVhIUi5zdGF0dXNUZXh0ID0gKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKSArICIiOwoKCQkJLy8gU3VjY2Vzcy9FcnJvcgoJCQlpZiAoIGlzU3VjY2VzcyApIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsgc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFIgXSApOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CgkJCX0KCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCWpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKCQkJc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggaXNTdWNjZXNzID8gImFqYXhTdWNjZXNzIiA6ICJhamF4RXJyb3IiLAoJCQkJCVsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CgkJCX0KCgkJCS8vIENvbXBsZXRlCgkJCWNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4Q29tcGxldGUiLCBbIGpxWEhSLCBzIF0gKTsKCQkJCS8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGpxWEhSOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCBkYXRhLCBjYWxsYmFjaywgImpzb24iICk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKCX0KfSk7CgpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7CglqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwoJCQljYWxsYmFjayA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCQkJdHlwZTogbWV0aG9kLAoJCQlkYXRhVHlwZTogdHlwZSwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2sKCQl9KTsKCX07Cn0pOwoKLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICovCmZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKSB7CgoJdmFyIGN0LCB0eXBlLCBmaW5hbERhdGFUeXBlLCBmaXJzdERhdGFUeXBlLAoJCWNvbnRlbnRzID0gcy5jb250ZW50cywKCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlczsKCgkvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwoJd2hpbGUoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwoJCX0KCX0KCgkvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKCWlmICggY3QgKSB7CgkJZm9yICggdHlwZSBpbiBjb250ZW50cyApIHsKCQkJaWYgKCBjb250ZW50c1sgdHlwZSBdICYmIGNvbnRlbnRzWyB0eXBlIF0udGVzdCggY3QgKSApIHsKCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0eXBlICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCgkvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKCWlmICggZGF0YVR5cGVzWyAwIF0gaW4gcmVzcG9uc2VzICkgewoJCWZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbIDAgXTsKCX0gZWxzZSB7CgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKCQkJCWZpbmFsRGF0YVR5cGUgPSB0eXBlOwoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAhZmlyc3REYXRhVHlwZSApIHsKCQkJCWZpcnN0RGF0YVR5cGUgPSB0eXBlOwoJCQl9CgkJfQoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCk7CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgoJLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKCXdoaWxlICggY3VycmVudCApIHsKCgkJaWYgKCBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gKSB7CgkJCWpxWEhSWyBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gXSA9IHJlc3BvbnNlOwoJCX0KCgkJLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKCQlpZiAoICFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIgKSB7CgkJCXJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwoJCX0KCgkJcHJldiA9IGN1cnJlbnQ7CgkJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCQlpZiAoIGN1cnJlbnQgKSB7CgoJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQkJaWYgKCBjdXJyZW50ID09PSAiKiIgKSB7CgoJCQkJY3VycmVudCA9IHByZXY7CgoJCQkvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CgkJCX0gZWxzZSBpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgewoKCQkJCS8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKCQkJCS8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCgkJCQlpZiAoICFjb252ICkgewoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7CgoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKCQkJCQkJdG1wID0gY29udjIuc3BsaXQoICIgIiApOwoJCQkJCQlpZiAoIHRtcFsgMSBdID09PSBjdXJyZW50ICkgewoKCQkJCQkJCS8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAoJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyB0bXBbIDAgXSBdIHx8CgkJCQkJCQkJY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CgkJCQkJCQlpZiAoIGNvbnYgKSB7CgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyAidGhyb3dzIiBdICkgewoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsKCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQlyZXR1cm4geyBzdGF0ZTogInBhcnNlcmVycm9yIiwgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQgfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9Ci8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCmpRdWVyeS5hamF4U2V0dXAoewoJYWNjZXB0czogewoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgoJfSwKCWNvbnRlbnRzOiB7CgkJc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSk7CgovLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGNyb3NzRG9tYWluCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CglpZiAoIHMuY2FjaGUgPT09IHVuZGVmaW5lZCApIHsKCQlzLmNhY2hlID0gZmFsc2U7Cgl9CglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJcy50eXBlID0gIkdFVCI7Cgl9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJdmFyIHNjcmlwdCwgY2FsbGJhY2s7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIF8sIGNvbXBsZXRlICkgewoJCQkJc2NyaXB0ID0galF1ZXJ5KCI8c2NyaXB0PiIpLnByb3AoewoJCQkJCWFzeW5jOiB0cnVlLAoJCQkJCWNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwKCQkJCQlzcmM6IHMudXJsCgkJCQl9KS5vbigKCQkJCQkibG9hZCBlcnJvciIsCgkJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlzY3JpcHQucmVtb3ZlKCk7CgkJCQkJCWNhbGxiYWNrID0gbnVsbDsKCQkJCQkJaWYgKCBldnQgKSB7CgkJCQkJCQljb21wbGV0ZSggZXZ0LnR5cGUgPT09ICJlcnJvciIgPyA0MDQgOiAyMDAsIGV2dC50eXBlICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkpOwoJCQkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCggc2NyaXB0WyAwIF0gKTsKCQkJfSwKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjaygpOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewoJanNvbnA6ICJjYWxsYmFjayIsCglqc29ucENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggYWpheF9ub25jZSsrICkgKTsKCQl0aGlzWyBjYWxsYmFjayBdID0gdHJ1ZTsKCQlyZXR1cm4gY2FsbGJhY2s7Cgl9Cn0pOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCgl2YXIgY2FsbGJhY2tOYW1lLCBvdmVyd3JpdHRlbiwgcmVzcG9uc2VDb250YWluZXIsCgkJanNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KCQkJInVybCIgOgoJCQl0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgoJCSk7CgoJLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKCWlmICgganNvblByb3AgfHwgcy5kYXRhVHlwZXNbIDAgXSA9PT0gImpzb25wIiApIHsKCgkJLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAoJCWNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBzLmpzb25wQ2FsbGJhY2sgKSA/CgkJCXMuanNvbnBDYWxsYmFjaygpIDoKCQkJcy5qc29ucENhbGxiYWNrOwoKCQkvLyBJbnNlcnQgY2FsbGJhY2sgaW50byB1cmwgb3IgZm9ybSBkYXRhCgkJaWYgKCBqc29uUHJvcCApIHsKCQkJc1sganNvblByb3AgXSA9IHNbIGpzb25Qcm9wIF0ucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CgkJfSBlbHNlIGlmICggcy5qc29ucCAhPT0gZmFsc2UgKSB7CgkJCXMudXJsICs9ICggYWpheF9ycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsKCQl9CgoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KCQlzLmNvbnZlcnRlcnNbInNjcmlwdCBqc29uIl0gPSBmdW5jdGlvbigpIHsKCQkJaWYgKCAhcmVzcG9uc2VDb250YWluZXIgKSB7CgkJCQlqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7CgkJCX0KCQkJcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CgkJfTsKCgkJLy8gZm9yY2UganNvbiBkYXRhVHlwZQoJCXMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2sKCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07CgkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewoJCQlyZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKCQl9OwoKCQkvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKCQlqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKCQkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKCQkJLy8gU2F2ZSBiYWNrIGFzIGZyZWUKCQkJaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAoJCQkJcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwoKCQkJCS8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKCQkJCW9sZENhbGxiYWNrcy5wdXNoKCBjYWxsYmFja05hbWUgKTsKCQkJfQoKCQkJLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCgkJCWlmICggcmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIG92ZXJ3cml0dGVuICkgKSB7CgkJCQlvdmVyd3JpdHRlbiggcmVzcG9uc2VDb250YWluZXJbIDAgXSApOwoJCQl9CgoJCQlyZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwoJCX0pOwoKCQkvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKCQlyZXR1cm4gInNjcmlwdCI7Cgl9Cn0pOwpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9IGNhdGNoKCBlICkge30KfTsKCnZhciB4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpLAoJeGhyU3VjY2Vzc1N0YXR1cyA9IHsKCQkvLyBmaWxlIHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIGNvZGUgMCwgYXNzdW1lIDIwMAoJCTA6IDIwMCwKCQkvLyBTdXBwb3J0OiBJRTkKCQkvLyAjMTQ1MDogc29tZXRpbWVzIElFIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkxMjIzOiAyMDQKCX0sCgkvLyBTdXBwb3J0OiBJRTkKCS8vIFdlIG5lZWQgdG8ga2VlcCB0cmFjayBvZiBvdXRib3VuZCB4aHIgYW5kIGFib3J0IHRoZW0gbWFudWFsbHkKCS8vIGJlY2F1c2UgSUUgaXMgbm90IHNtYXJ0IGVub3VnaCB0byBkbyBpdCBhbGwgYnkgaXRzZWxmCgl4aHJJZCA9IDAsCgl4aHJDYWxsYmFja3MgPSB7fTsKCmlmICggd2luZG93LkFjdGl2ZVhPYmplY3QgKSB7CglqUXVlcnkoIHdpbmRvdyApLm9uKCAidW5sb2FkIiwgZnVuY3Rpb24oKSB7CgkJZm9yKCB2YXIga2V5IGluIHhockNhbGxiYWNrcyApIHsKCQkJeGhyQ2FsbGJhY2tzWyBrZXkgXSgpOwoJCX0KCQl4aHJDYWxsYmFja3MgPSB1bmRlZmluZWQ7Cgl9KTsKfQoKalF1ZXJ5LnN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICggIndpdGhDcmVkZW50aWFscyIgaW4geGhyU3VwcG9ydGVkICk7CmpRdWVyeS5zdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKCmpRdWVyeS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyIGNhbGxiYWNrOwoJLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdAoJaWYgKCBqUXVlcnkuc3VwcG9ydC5jb3JzIHx8IHhoclN1cHBvcnRlZCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbiApIHsKCQlyZXR1cm4gewoJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7CgkJCQl2YXIgaSwgaWQsCgkJCQkJeGhyID0gb3B0aW9ucy54aHIoKTsKCQkJCXhoci5vcGVuKCBvcHRpb25zLnR5cGUsIG9wdGlvbnMudXJsLCBvcHRpb25zLmFzeW5jLCBvcHRpb25zLnVzZXJuYW1lLCBvcHRpb25zLnBhc3N3b3JkICk7CgkJCQkvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCgkJCQlpZiAoIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCWZvciAoIGkgaW4gb3B0aW9ucy54aHJGaWVsZHMgKSB7CgkJCQkJCXhoclsgaSBdID0gb3B0aW9ucy54aHJGaWVsZHNbIGkgXTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCgkJCQlpZiAoIG9wdGlvbnMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CgkJCQkJeGhyLm92ZXJyaWRlTWltZVR5cGUoIG9wdGlvbnMubWltZVR5cGUgKTsKCQkJCX0KCQkJCS8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCgkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCgkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCWlmICggIW9wdGlvbnMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSApIHsKCQkJCQloZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gPSAiWE1MSHR0cFJlcXVlc3QiOwoJCQkJfQoJCQkJLy8gU2V0IGhlYWRlcnMKCQkJCWZvciAoIGkgaW4gaGVhZGVycyApIHsKCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlciggaSwgaGVhZGVyc1sgaSBdICk7CgkJCQl9CgkJCQkvLyBDYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQlkZWxldGUgeGhyQ2FsbGJhY2tzWyBpZCBdOwoJCQkJCQkJY2FsbGJhY2sgPSB4aHIub25sb2FkID0geGhyLm9uZXJyb3IgPSBudWxsOwoJCQkJCQkJaWYgKCB0eXBlID09PSAiYWJvcnQiICkgewoJCQkJCQkJCXhoci5hYm9ydCgpOwoJCQkJCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gImVycm9yIiApIHsKCQkJCQkJCQljb21wbGV0ZSgKCQkJCQkJCQkJLy8gZmlsZSBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwLCBhc3N1bWUgNDA0CgkJCQkJCQkJCXhoci5zdGF0dXMgfHwgNDA0LAoJCQkJCQkJCQl4aHIuc3RhdHVzVGV4dAoJCQkJCQkJCSk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQl4aHJTdWNjZXNzU3RhdHVzWyB4aHIuc3RhdHVzIF0gfHwgeGhyLnN0YXR1cywKCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQsCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IElFOQoJCQkJCQkJCQkvLyAjMTE0MjY6IFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU5IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uCgkJCQkJCQkJCS8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQKCQkJCQkJCQkJdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICJzdHJpbmciID8gewoJCQkJCQkJCQkJdGV4dDogeGhyLnJlc3BvbnNlVGV4dAoJCQkJCQkJCQl9IDogdW5kZWZpbmVkLAoJCQkJCQkJCQl4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKCQkJCQkJCQkpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfTsKCQkJCX07CgkJCQkvLyBMaXN0ZW4gdG8gZXZlbnRzCgkJCQl4aHIub25sb2FkID0gY2FsbGJhY2soKTsKCQkJCXhoci5vbmVycm9yID0gY2FsbGJhY2soImVycm9yIik7CgkJCQkvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrCgkJCQljYWxsYmFjayA9IHhockNhbGxiYWNrc1soIGlkID0geGhySWQrKyApXSA9IGNhbGxiYWNrKCJhYm9ydCIpOwoJCQkJLy8gRG8gc2VuZCB0aGUgcmVxdWVzdAoJCQkJLy8gVGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uIHdoaWNoIGlzIGFjdHVhbGx5CgkJCQkvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKCQkJCXhoci5zZW5kKCBvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhIHx8IG51bGwgKTsKCQkJfSwKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjaygpOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CnZhciBmeE5vdywgdGltZXJJZCwKCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAoJcmZ4bnVtID0gbmV3IFJlZ0V4cCggIl4oPzooWystXSk9fCkoIiArIGNvcmVfcG51bSArICIpKFthLXolXSopJCIsICJpIiApLAoJcnJ1biA9IC9xdWV1ZUhvb2tzJC8sCglhbmltYXRpb25QcmVmaWx0ZXJzID0gWyBkZWZhdWx0UHJlZmlsdGVyIF0sCgl0d2VlbmVycyA9IHsKCQkiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICksCgkJCQl0YXJnZXQgPSB0d2Vlbi5jdXIoKSwKCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCgkJCQl1bml0ID0gcGFydHMgJiYgcGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkJCS8vIFN0YXJ0aW5nIHZhbHVlIGNvbXB1dGF0aW9uIGlzIHJlcXVpcmVkIGZvciBwb3RlbnRpYWwgdW5pdCBtaXNtYXRjaGVzCgkJCQlzdGFydCA9ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK3RhcmdldCApICYmCgkJCQkJcmZ4bnVtLmV4ZWMoIGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AgKSApLAoJCQkJc2NhbGUgPSAxLAoJCQkJbWF4SXRlcmF0aW9ucyA9IDIwOwoKCQkJaWYgKCBzdGFydCAmJiBzdGFydFsgMyBdICE9PSB1bml0ICkgewoJCQkJLy8gVHJ1c3QgdW5pdHMgcmVwb3J0ZWQgYnkgalF1ZXJ5LmNzcwoJCQkJdW5pdCA9IHVuaXQgfHwgc3RhcnRbIDMgXTsKCgkJCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCgkJCQlwYXJ0cyA9IHBhcnRzIHx8IFtdOwoKCQkJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJCQlzdGFydCA9ICt0YXJnZXQgfHwgMTsKCgkJCQlkbyB7CgkJCQkJLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwoJCQkJCXNjYWxlID0gc2NhbGUgfHwgIi41IjsKCgkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQoJCQkJCXN0YXJ0ID0gc3RhcnQgLyBzY2FsZTsKCQkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCgkJCQkvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAoJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CgkJCX0KCgkJCS8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCgkJCWlmICggcGFydHMgKSB7CgkJCQlzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKCQkJCXR3ZWVuLnVuaXQgPSB1bml0OwoJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQl0d2Vlbi5lbmQgPSBwYXJ0c1sgMSBdID8KCQkJCQlzdGFydCArICggcGFydHNbIDEgXSArIDEgKSAqIHBhcnRzWyAyIF0gOgoJCQkJCStwYXJ0c1sgMiBdOwoJCQl9CgoJCQlyZXR1cm4gdHdlZW47CgkJfV0KCX07CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlmeE5vdyA9IHVuZGVmaW5lZDsKCX0pOwoJcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKfQoKZnVuY3Rpb24gY3JlYXRlVHdlZW4oIHZhbHVlLCBwcm9wLCBhbmltYXRpb24gKSB7Cgl2YXIgdHdlZW4sCgkJY29sbGVjdGlvbiA9ICggdHdlZW5lcnNbIHByb3AgXSB8fCBbXSApLmNvbmNhdCggdHdlZW5lcnNbICIqIiBdICksCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICh0d2VlbiA9IGNvbGxlY3Rpb25bIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSApKSApIHsKCgkJCS8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CgkJCXJldHVybiB0d2VlbjsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKCXZhciByZXN1bHQsCgkJc3RvcHBlZCwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsCgkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQkvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKCQkJZGVsZXRlIHRpY2suZWxlbTsKCQl9KSwKCQl0aWNrID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc3RvcHBlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwoJCQl9CgoJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtYWluaW5nOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CgkJCWVsZW06IGVsZW0sCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLAoJCQlvcHRzOiBqUXVlcnkuZXh0ZW5kKCB0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoJCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQkJc3RvcHBlZCA9IHRydWU7CgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9KSwKCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsKCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWVsZW06IGVsZW0sCgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCgkJfSkKCSk7CgoJLy8gYXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCXJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7Cgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKCS8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIGluZGV4ICk7CgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOwoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJZWFzaW5nID0gdmFsdWVbIDEgXTsKCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07CgkJfQoKCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgewoJCQlwcm9wc1sgbmFtZSBdID0gdmFsdWU7CgkJCWRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKCQl9CgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF07CgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKCQkJdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CgkJCWRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKCQkJLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgoJCQkvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKCQkJCWlmICggISggaW5kZXggaW4gcHJvcHMgKSApIHsKCQkJCQlwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlzcGVjaWFsRWFzaW5nWyBuYW1lIF0gPSBlYXNpbmc7CgkJfQoJfQp9CgpqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZCggQW5pbWF0aW9uLCB7CgoJdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwcm9wcyApICkgewoJCQljYWxsYmFjayA9IHByb3BzOwoJCQlwcm9wcyA9IFsgIioiIF07CgkJfSBlbHNlIHsKCQkJcHJvcHMgPSBwcm9wcy5zcGxpdCgiICIpOwoJCX0KCgkJdmFyIHByb3AsCgkJCWluZGV4ID0gMCwKCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOwoJCQl0d2VlbmVyc1sgcHJvcCBdID0gdHdlZW5lcnNbIHByb3AgXSB8fCBbXTsKCQkJdHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0KCX0sCgoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7CgkJaWYgKCBwcmVwZW5kICkgewoJCQlhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwoJCX0KCX0KfSk7CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKCS8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KCXZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsCgkJYW5pbSA9IHRoaXMsCgkJb3JpZyA9IHt9LAoJCXN0eWxlID0gZWxlbS5zdHlsZSwKCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICksCgkJZGF0YVNob3cgPSBkYXRhX3ByaXYuZ2V0KCBlbGVtLCAiZnhzaG93IiApOwoKCS8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCX0KCgkvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwoJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICggImhlaWdodCIgaW4gcHJvcHMgfHwgIndpZHRoIiBpbiBwcm9wcyApICkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUU5LTEwIGRvIG5vdAoJCS8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAoJCS8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCgkJb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgoJCS8vIFNldCBkaXNwbGF5IHByb3BlcnR5IHRvIGlubGluZS1ibG9jayBmb3IgaGVpZ2h0L3dpZHRoCgkJLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmCgkJCQlqUXVlcnkuY3NzKCBlbGVtLCAiZmxvYXQiICkgPT09ICJub25lIiApIHsKCgkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCQl9Cgl9CgoJaWYgKCBvcHRzLm92ZXJmbG93ICkgewoJCXN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCXN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1sgMCBdOwoJCQlzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CgkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsKCQl9KTsKCX0KCgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIHByb3AgaW4gcHJvcHMgKSB7CgkJdmFsdWUgPSBwcm9wc1sgcHJvcCBdOwoJCWlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKCQkJZGVsZXRlIHByb3BzWyBwcm9wIF07CgkJCXRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KCQkJCWlmICggdmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaGlkZGVuID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCX0KCQkJb3JpZ1sgcHJvcCBdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCQl9Cgl9CgoJaWYgKCAhalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsKCQlpZiAoIGRhdGFTaG93ICkgewoJCQlpZiAoICJoaWRkZW4iIGluIGRhdGFTaG93ICkgewoJCQkJaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwoJCQl9CgkJfSBlbHNlIHsKCQkJZGF0YVNob3cgPSBkYXRhX3ByaXYuYWNjZXNzKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKCQl9CgoJCS8vIHN0b3JlIHN0YXRlIGlmIGl0cyB0b2dnbGUgLSBlbmFibGVzIC5zdG9wKCkudG9nZ2xlKCkgdG8gInJldmVyc2UiCgkJaWYgKCB0b2dnbGUgKSB7CgkJCWRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CgkJfQoJCWlmICggaGlkZGVuICkgewoJCQlqUXVlcnkoIGVsZW0gKS5zaG93KCk7CgkJfSBlbHNlIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5KCBlbGVtICkuaGlkZSgpOwoJCQl9KTsKCQl9CgkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQl2YXIgcHJvcDsKCgkJCWRhdGFfcHJpdi5yZW1vdmUoIGVsZW0sICJmeHNob3ciICk7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7CgkJCX0KCQl9KTsKCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCXR3ZWVuID0gY3JlYXRlVHdlZW4oIGhpZGRlbiA/IGRhdGFTaG93WyBwcm9wIF0gOiAwLCBwcm9wLCBhbmltICk7CgoJCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsKCQkJCWRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKCQkJCWlmICggaGlkZGVuICkgewoJCQkJCXR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwoJCQkJCXR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gIndpZHRoIiB8fCBwcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwOwoJCQkJfQoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKAoJCQkJcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCgkJCSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CgkJfQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJaWYgKCB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJgoJCQkJKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbIHR3ZWVuLnByb3AgXSA9PSBudWxsKSApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCgkJCS8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOwoJCQkvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCgkJCXJldHVybiAhcmVzdWx0IHx8IHJlc3VsdCA9PT0gImF1dG8iID8gMCA6IHJlc3VsdDsKCQl9LAoJCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQkvLyB1c2Ugc3RlcCBob29rIGZvciBiYWNrIGNvbXBhdCAtIHVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZSAtIHVzZSAuc3R5bGUgaWYgaXRzCgkJCS8vIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlCgkJCWlmICggalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSApIHsKCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0uc3R5bGUgJiYgKCB0d2Vlbi5lbGVtLnN0eWxlWyBqUXVlcnkuY3NzUHJvcHNbIHR3ZWVuLnByb3AgXSBdICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCApOwoJCQl9IGVsc2UgewoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCQl9CgkJfQoJfQp9OwoKLy8gU3VwcG9ydDogSUU5Ci8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoKVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewoJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsKCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCX0KCX0KfTsKCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGNzc0ZuID0galF1ZXJ5LmZuWyBuYW1lIF07CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgfHwgZGF0YV9wcml2LmdldCggdGhpcywgImZpbmlzaCIgKSApIHsKCQkJCQlhbmltLnN0b3AoIHRydWUgKTsKCQkJCX0KCQkJfTsKCQkJZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGRhdGFfcHJpdi5nZXQoIHRoaXMgKTsKCgkJCWlmICggaW5kZXggKSB7CgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewoJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaW5kZXggaW4gZGF0YSApIHsKCQkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSkgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwoJCQkJCWRlcXVldWUgPSBmYWxzZTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJCS8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCgkJCS8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kCgkJCWlmICggZGVxdWV1ZSB8fCAhZ290b0VuZCApIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCX0KCQl9KTsKCX0sCglmaW5pc2g6IGZ1bmN0aW9uKCB0eXBlICkgewoJCWlmICggdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCWRhdGEgPSBkYXRhX3ByaXYuZ2V0KCB0aGlzICksCgkJCQlxdWV1ZSA9IGRhdGFbIHR5cGUgKyAicXVldWUiIF0sCgkJCQlob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CgoJCQkvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCgkJCWRhdGEuZmluaXNoID0gdHJ1ZTsKCgkJCS8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAoJCQlqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIFtdICk7CgoJCQlpZiAoIGhvb2tzICYmIGhvb2tzLnN0b3AgKSB7CgkJCQlob29rcy5zdG9wLmNhbGwoIHRoaXMsIHRydWUgKTsKCQkJfQoKCQkJLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIHRydWUgKTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJaWYgKCBxdWV1ZVsgaW5kZXggXSAmJiBxdWV1ZVsgaW5kZXggXS5maW5pc2ggKSB7CgkJCQkJcXVldWVbIGluZGV4IF0uZmluaXNoLmNhbGwoIHRoaXMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKCQkJZGVsZXRlIGRhdGEuZmluaXNoOwoJCX0pOwoJfQp9KTsKCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LAoJCWkgPSAwOwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aD8gMSA6IDA7Cglmb3IoIDsgaSA8IDQgOyBpICs9IDIgLSBpbmNsdWRlV2lkdGggKSB7CgkJd2hpY2ggPSBjc3NFeHBhbmRbIGkgXTsKCQlhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwoJfQoKCWlmICggaW5jbHVkZVdpZHRoICkgewoJCWF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7Cgl9CgoJcmV0dXJuIGF0dHJzOwp9CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwKCWZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGZuICkgewoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsKCQljb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAoJCQlqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCW9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgoJCW9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKCS8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmVhc2luZyA9IHsKCWxpbmVhcjogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHA7Cgl9LAoJc3dpbmc6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiAwLjUgLSBNYXRoLmNvcyggcCpNYXRoLlBJICkgLyAyOwoJfQp9OwoKalF1ZXJ5LnRpbWVycyA9IFtdOwpqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKCXZhciB0aW1lciwKCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCWkgPSAwOwoKCWZ4Tm93ID0galF1ZXJ5Lm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAoJCWlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKCQl9Cgl9CgoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsKCQlqUXVlcnkuZnguc3RvcCgpOwoJfQoJZnhOb3cgPSB1bmRlZmluZWQ7Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICkgewoJCWpRdWVyeS5meC5zdGFydCgpOwoJfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RhcnQgPSBmdW5jdGlvbigpIHsKCWlmICggIXRpbWVySWQgKSB7CgkJdGltZXJJZCA9IHNldEludGVydmFsKCBqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsICk7Cgl9Cn07CgpqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uKCkgewoJY2xlYXJJbnRlcnZhbCggdGltZXJJZCApOwoJdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewoJc2xvdzogNjAwLAoJZmFzdDogMjAwLAoJLy8gRGVmYXVsdCBzcGVlZAoJX2RlZmF1bHQ6IDQwMAp9OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCQl9KS5sZW5ndGg7Cgl9Owp9CmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJfQoKCXZhciBkb2NFbGVtLCB3aW4sCgkJZWxlbSA9IHRoaXNbIDAgXSwKCQlib3ggPSB7IHRvcDogMCwgbGVmdDogMCB9LAoJCWRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwoKCWlmICggIWRvYyApIHsKCQlyZXR1cm47Cgl9CgoJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgoJLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCglpZiAoICFqUXVlcnkuY29udGFpbnMoIGRvY0VsZW0sIGVsZW0gKSApIHsKCQlyZXR1cm4gYm94OwoJfQoKCS8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCgkvLyBCbGFja0JlcnJ5IDUsIGlPUyAzIChvcmlnaW5hbCBpUGhvbmUpCglpZiAoIHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gY29yZV9zdHJ1bmRlZmluZWQgKSB7CgkJYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCX0KCXdpbiA9IGdldFdpbmRvdyggZG9jICk7CglyZXR1cm4gewoJCXRvcDogYm94LnRvcCArIHdpbi5wYWdlWU9mZnNldCAtIGRvY0VsZW0uY2xpZW50VG9wLAoJCWxlZnQ6IGJveC5sZWZ0ICsgd2luLnBhZ2VYT2Zmc2V0IC0gZG9jRWxlbS5jbGllbnRMZWZ0Cgl9Owp9OwoKalF1ZXJ5Lm9mZnNldCA9IHsKCglzZXRPZmZzZXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBpICkgewoJCXZhciBjdXJQb3NpdGlvbiwgY3VyTGVmdCwgY3VyQ1NTVG9wLCBjdXJUb3AsIGN1ck9mZnNldCwgY3VyQ1NTTGVmdCwgY2FsY3VsYXRlUG9zaXRpb24sCgkJCXBvc2l0aW9uID0galF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApLAoJCQljdXJFbGVtID0galF1ZXJ5KCBlbGVtICksCgkJCXByb3BzID0ge307CgoJCS8vIFNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KCQlpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsKCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoKCQljdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpOwoJCWN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoIGVsZW0sICJ0b3AiICk7CgkJY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApOwoJCWNhbGN1bGF0ZVBvc2l0aW9uID0gKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApICYmICggY3VyQ1NTVG9wICsgY3VyQ1NTTGVmdCApLmluZGV4T2YoImF1dG8iKSA+IC0xOwoKCQkvLyBOZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlciB0b3Agb3IgbGVmdCBpcyBhdXRvIGFuZCBwb3NpdGlvbiBpcyBlaXRoZXIgYWJzb2x1dGUgb3IgZml4ZWQKCQlpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewoJCQljdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKCQkJY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwoJCQljdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKCgkJfSBlbHNlIHsKCQkJY3VyVG9wID0gcGFyc2VGbG9hdCggY3VyQ1NTVG9wICkgfHwgMDsKCQkJY3VyTGVmdCA9IHBhcnNlRmxvYXQoIGN1ckNTU0xlZnQgKSB8fCAwOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBjdXJPZmZzZXQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJcG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXNbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIG9mZnNldFBhcmVudCwgb2Zmc2V0LAoJCQllbGVtID0gdGhpc1sgMCBdLAoJCQlwYXJlbnRPZmZzZXQgPSB7IHRvcDogMCwgbGVmdDogMCB9OwoKCQkvLyBGaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50CgkJaWYgKCBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICkgPT09ICJmaXhlZCIgKSB7CgkJCS8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKCQl9IGVsc2UgewoJCQkvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAoJCQlvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKCQkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCQlvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKCQkJCXBhcmVudE9mZnNldCA9IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCQkJfQoKCQkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJCXBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlICk7CgkJfQoKCQkvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCgkJcmV0dXJuIHsKCQkJdG9wOiBvZmZzZXQudG9wIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUgKQoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKCgkJCXdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIiApICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoKCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwoJCX0pOwoJfQp9KTsKCgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHtzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLCBzY3JvbGxUb3A6ICJwYWdlWU9mZnNldCJ9LCBmdW5jdGlvbiggbWV0aG9kLCBwcm9wICkgewoJdmFyIHRvcCA9ICJwYWdlWU9mZnNldCIgPT09IHByb3A7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB2YWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKCQkJdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB3aW4gPyB3aW5bIHByb3AgXSA6IGVsZW1bIG1ldGhvZCBdOwoJCQl9CgoJCQlpZiAoIHdpbiApIHsKCQkJCXdpbi5zY3JvbGxUbygKCQkJCQkhdG9wID8gdmFsIDogd2luZG93LnBhZ2VYT2Zmc2V0LAoJCQkJCXRvcCA/IHZhbCA6IHdpbmRvdy5wYWdlWU9mZnNldAoJCQkJKTsKCgkJCX0gZWxzZSB7CgkJCQllbGVtWyBtZXRob2QgXSA9IHZhbDsKCQkJfQoJCX0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7Cgl9Owp9KTsKCmZ1bmN0aW9uIGdldFdpbmRvdyggZWxlbSApIHsKCXJldHVybiBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSA/IGVsZW0gOiBlbGVtLm5vZGVUeXBlID09PSA5ICYmIGVsZW0uZGVmYXVsdFZpZXc7Cn0KLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKCQkvLyBtYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgdHlwZSwgdmFsdWUgKSB7CgkJCQl2YXIgZG9jOwoKCQkJCWlmICggalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgkJCQkJLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKCQkJCQkvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246CgkJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC83NjQKCQkJCQlyZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwoJCQkJfQoKCQkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQlkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLAoJCQkJCS8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCXJldHVybiBNYXRoLm1heCgKCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwKCQkJCQkJZWxlbS5ib2R5WyAib2Zmc2V0IiArIG5hbWUgXSwgZG9jWyAib2Zmc2V0IiArIG5hbWUgXSwKCQkJCQkJZG9jWyAiY2xpZW50IiArIG5hbWUgXQoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQKCQkJCQlqUXVlcnkuY3NzKCBlbGVtLCB0eXBlLCBleHRyYSApIDoKCgkJCQkJLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAoJCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhICk7CgkJCX0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsICk7CgkJfTsKCX0pOwp9KTsKLy8gTGltaXQgc2NvcGUgcG9sbHV0aW9uIGZyb20gYW55IGRlcHJlY2F0ZWQgQVBJCi8vIChmdW5jdGlvbigpIHsKCi8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CmpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gdGhpcy5sZW5ndGg7Cn07CgpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwoKLy8gfSkoKTsKaWYgKCB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAib2JqZWN0IiApIHsKCS8vIEV4cG9zZSBqUXVlcnkgYXMgbW9kdWxlLmV4cG9ydHMgaW4gbG9hZGVycyB0aGF0IGltcGxlbWVudCB0aGUgTm9kZQoJLy8gbW9kdWxlIHBhdHRlcm4gKGluY2x1ZGluZyBicm93c2VyaWZ5KS4gRG8gbm90IGNyZWF0ZSB0aGUgZ2xvYmFsLCBzaW5jZQoJLy8gdGhlIHVzZXIgd2lsbCBiZSBzdG9yaW5nIGl0IHRoZW1zZWx2ZXMgbG9jYWxseSwgYW5kIGdsb2JhbHMgYXJlIGZyb3duZWQKCS8vIHVwb24gaW4gdGhlIE5vZGUgbW9kdWxlIHdvcmxkLgoJbW9kdWxlLmV4cG9ydHMgPSBqUXVlcnk7Cn0gZWxzZSB7CgkvLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIKCS8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKCS8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdAoJLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQoJLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCgkvLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMKCS8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbiAoKSB7IHJldHVybiBqUXVlcnk7IH0gKTsKCX0KfQoKLy8gSWYgdGhlcmUgaXMgYSB3aW5kb3cgb2JqZWN0LCB0aGF0IGF0IGxlYXN0IGhhcyBhIGRvY3VtZW50IHByb3BlcnR5LAovLyBkZWZpbmUgalF1ZXJ5IGFuZCAkIGlkZW50aWZpZXJzCmlmICggdHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCA9PT0gIm9iamVjdCIgKSB7Cgl3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qKgogKiBAbGljZW5zZQogKiBMby1EYXNoIDIuMi4xIChDdXN0b20gQnVpbGQpIDxodHRwOi8vbG9kYXNoLmNvbS8+CiAqIEJ1aWxkOiBgbG9kYXNoIG1vZGVybiAtbyAuL2Rpc3QvbG9kYXNoLmpzYAogKiBDb3B5cmlnaHQgMjAxMi0yMDEzIFRoZSBEb2pvIEZvdW5kYXRpb24gPGh0dHA6Ly9kb2pvZm91bmRhdGlvbi5vcmcvPgogKiBCYXNlZCBvbiBVbmRlcnNjb3JlLmpzIDEuNS4yIDxodHRwOi8vdW5kZXJzY29yZWpzLm9yZy9MSUNFTlNFPgogKiBDb3B5cmlnaHQgMjAwOS0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCiAqIEF2YWlsYWJsZSB1bmRlciBNSVQgbGljZW5zZSA8aHR0cDovL2xvZGFzaC5jb20vbGljZW5zZT4KICovCjsoZnVuY3Rpb24oKSB7CgogIC8qKiBVc2VkIGFzIGEgc2FmZSByZWZlcmVuY2UgZm9yIGB1bmRlZmluZWRgIGluIHByZSBFUzUgZW52aXJvbm1lbnRzICovCiAgdmFyIHVuZGVmaW5lZDsKCiAgLyoqIFVzZWQgdG8gcG9vbCBhcnJheXMgYW5kIG9iamVjdHMgdXNlZCBpbnRlcm5hbGx5ICovCiAgdmFyIGFycmF5UG9vbCA9IFtdLAogICAgICBvYmplY3RQb29sID0gW107CgogIC8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KICB2YXIgaWRDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgdG8gcHJlZml4IGtleXMgdG8gYXZvaWQgaXNzdWVzIHdpdGggYF9fcHJvdG9fX2AgYW5kIHByb3BlcnRpZXMgb24gYE9iamVjdC5wcm90b3R5cGVgICovCiAgdmFyIGtleVByZWZpeCA9ICtuZXcgRGF0ZSArICcnOwoKICAvKiogVXNlZCBhcyB0aGUgc2l6ZSB3aGVuIG9wdGltaXphdGlvbnMgYXJlIGVuYWJsZWQgZm9yIGxhcmdlIGFycmF5cyAqLwogIHZhciBsYXJnZUFycmF5U2l6ZSA9IDc1OwoKICAvKiogVXNlZCBhcyB0aGUgbWF4IHNpemUgb2YgdGhlIGBhcnJheVBvb2xgIGFuZCBgb2JqZWN0UG9vbGAgKi8KICB2YXIgbWF4UG9vbFNpemUgPSA0MDsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGFuZCB0ZXN0IHdoaXRlc3BhY2UgKi8KICB2YXIgd2hpdGVzcGFjZSA9ICgKICAgIC8vIHdoaXRlc3BhY2UKICAgICcgXHRceDBCXGZceEEwXHVmZWZmJyArCgogICAgLy8gbGluZSB0ZXJtaW5hdG9ycwogICAgJ1xuXHJcdTIwMjhcdTIwMjknICsKCiAgICAvLyB1bmljb2RlIGNhdGVnb3J5ICJacyIgc3BhY2Ugc2VwYXJhdG9ycwogICAgJ1x1MTY4MFx1MTgwZVx1MjAwMFx1MjAwMVx1MjAwMlx1MjAwM1x1MjAwNFx1MjAwNVx1MjAwNlx1MjAwN1x1MjAwOFx1MjAwOVx1MjAwYVx1MjAyZlx1MjA1Zlx1MzAwMCcKICApOwoKICAvKiogVXNlZCB0byBtYXRjaCBlbXB0eSBzdHJpbmcgbGl0ZXJhbHMgaW4gY29tcGlsZWQgdGVtcGxhdGUgc291cmNlICovCiAgdmFyIHJlRW1wdHlTdHJpbmdMZWFkaW5nID0gL1xiX19wIFwrPSAnJzsvZywKICAgICAgcmVFbXB0eVN0cmluZ01pZGRsZSA9IC9cYihfX3AgXCs9KSAnJyBcKy9nLAogICAgICByZUVtcHR5U3RyaW5nVHJhaWxpbmcgPSAvKF9fZVwoLio/XCl8XGJfX3RcKSkgXCtcbicnOy9nOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIEVTNiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICogaHR0cDovL3Blb3BsZS5tb3ppbGxhLm9yZy9+am9yZW5kb3JmZi9lczYtZHJhZnQuaHRtbCNzZWMtNy44LjYKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoW15cXH1dKig/OlxcLlteXFx9XSopKilcfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0ZWQgbmFtZWQgZnVuY3Rpb25zICovCiAgdmFyIHJlRnVuY05hbWUgPSAvXmZ1bmN0aW9uWyBcblxyXHRdK1x3LzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggImludGVycG9sYXRlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlSW50ZXJwb2xhdGUgPSAvPCU9KFtcc1xTXSs/KSU+L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGxlYWRpbmcgd2hpdGVzcGFjZSBhbmQgemVyb3MgdG8gYmUgcmVtb3ZlZCAqLwogIHZhciByZUxlYWRpbmdTcGFjZXNBbmRaZXJvcyA9IFJlZ0V4cCgnXlsnICsgd2hpdGVzcGFjZSArICddKjArKD89LiQpJyk7CgogIC8qKiBVc2VkIHRvIGVuc3VyZSBjYXB0dXJpbmcgb3JkZXIgb2YgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZU5vTWF0Y2ggPSAvKCReKS87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBmdW5jdGlvbnMgY29udGFpbmluZyBhIGB0aGlzYCByZWZlcmVuY2UgKi8KICB2YXIgcmVUaGlzID0gL1xidGhpc1xiLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGFzc2lnbiBkZWZhdWx0IGBjb250ZXh0YCBvYmplY3QgcHJvcGVydGllcyAqLwogIHZhciBjb250ZXh0UHJvcHMgPSBbCiAgICAnQXJyYXknLCAnQm9vbGVhbicsICdEYXRlJywgJ0Z1bmN0aW9uJywgJ01hdGgnLCAnTnVtYmVyJywgJ09iamVjdCcsCiAgICAnUmVnRXhwJywgJ1N0cmluZycsICdfJywgJ2F0dGFjaEV2ZW50JywgJ2NsZWFyVGltZW91dCcsICdpc0Zpbml0ZScsICdpc05hTicsCiAgICAncGFyc2VJbnQnLCAnc2V0SW1tZWRpYXRlJywgJ3NldFRpbWVvdXQnCiAgXTsKCiAgLyoqIFVzZWQgdG8gbWFrZSB0ZW1wbGF0ZSBzb3VyY2VVUkxzIGVhc2llciB0byBpZGVudGlmeSAqLwogIHZhciB0ZW1wbGF0ZUNvdW50ZXIgPSAwOwoKICAvKiogYE9iamVjdCN0b1N0cmluZ2AgcmVzdWx0IHNob3J0Y3V0cyAqLwogIHZhciBhcmdzQ2xhc3MgPSAnW29iamVjdCBBcmd1bWVudHNdJywKICAgICAgYXJyYXlDbGFzcyA9ICdbb2JqZWN0IEFycmF5XScsCiAgICAgIGJvb2xDbGFzcyA9ICdbb2JqZWN0IEJvb2xlYW5dJywKICAgICAgZGF0ZUNsYXNzID0gJ1tvYmplY3QgRGF0ZV0nLAogICAgICBmdW5jQ2xhc3MgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBudW1iZXJDbGFzcyA9ICdbb2JqZWN0IE51bWJlcl0nLAogICAgICBvYmplY3RDbGFzcyA9ICdbb2JqZWN0IE9iamVjdF0nLAogICAgICByZWdleHBDbGFzcyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzdHJpbmdDbGFzcyA9ICdbb2JqZWN0IFN0cmluZ10nOwoKICAvKiogVXNlZCB0byBpZGVudGlmeSBvYmplY3QgY2xhc3NpZmljYXRpb25zIHRoYXQgYF8uY2xvbmVgIHN1cHBvcnRzICovCiAgdmFyIGNsb25lYWJsZUNsYXNzZXMgPSB7fTsKICBjbG9uZWFibGVDbGFzc2VzW2Z1bmNDbGFzc10gPSBmYWxzZTsKICBjbG9uZWFibGVDbGFzc2VzW2FyZ3NDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2FycmF5Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW2Jvb2xDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2RhdGVDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbbnVtYmVyQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tvYmplY3RDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbcmVnZXhwQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tzdHJpbmdDbGFzc10gPSB0cnVlOwoKICAvKiogVXNlZCBhcyBhbiBpbnRlcm5hbCBgXy5kZWJvdW5jZWAgb3B0aW9ucyBvYmplY3QgKi8KICB2YXIgZGVib3VuY2VPcHRpb25zID0gewogICAgJ2xlYWRpbmcnOiBmYWxzZSwKICAgICdtYXhXYWl0JzogMCwKICAgICd0cmFpbGluZyc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgYXMgdGhlIHByb3BlcnR5IGRlc2NyaXB0b3IgZm9yIGBfX2JpbmREYXRhX19gICovCiAgdmFyIGRlc2NyaXB0b3IgPSB7CiAgICAnY29uZmlndXJhYmxlJzogZmFsc2UsCiAgICAnZW51bWVyYWJsZSc6IGZhbHNlLAogICAgJ3ZhbHVlJzogbnVsbCwKICAgICd3cml0YWJsZSc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgdG8gZGV0ZXJtaW5lIGlmIHZhbHVlcyBhcmUgb2YgdGhlIGxhbmd1YWdlIHR5cGUgT2JqZWN0ICovCiAgdmFyIG9iamVjdFR5cGVzID0gewogICAgJ2Jvb2xlYW4nOiBmYWxzZSwKICAgICdmdW5jdGlvbic6IHRydWUsCiAgICAnb2JqZWN0JzogdHJ1ZSwKICAgICdudW1iZXInOiBmYWxzZSwKICAgICdzdHJpbmcnOiBmYWxzZSwKICAgICd1bmRlZmluZWQnOiBmYWxzZQogIH07CgogIC8qKiBVc2VkIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHN0cmluZ0VzY2FwZXMgPSB7CiAgICAnXFwnOiAnXFwnLAogICAgIiciOiAiJyIsCiAgICAnXG4nOiAnbicsCiAgICAnXHInOiAncicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgLyoqIFVzZWQgYXMgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QgKi8KICB2YXIgcm9vdCA9IChvYmplY3RUeXBlc1t0eXBlb2Ygd2luZG93XSAmJiB3aW5kb3cpIHx8IHRoaXM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZXhwb3J0c2AgKi8KICB2YXIgZnJlZUV4cG9ydHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgZXhwb3J0c10gJiYgZXhwb3J0cyAmJiAhZXhwb3J0cy5ub2RlVHlwZSAmJiBleHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYG1vZHVsZWAgKi8KICB2YXIgZnJlZU1vZHVsZSA9IG9iamVjdFR5cGVzW3R5cGVvZiBtb2R1bGVdICYmIG1vZHVsZSAmJiAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKCiAgLyoqIERldGVjdCB0aGUgcG9wdWxhciBDb21tb25KUyBleHRlbnNpb24gYG1vZHVsZS5leHBvcnRzYCAqLwogIHZhciBtb2R1bGVFeHBvcnRzID0gZnJlZU1vZHVsZSAmJiBmcmVlTW9kdWxlLmV4cG9ydHMgPT09IGZyZWVFeHBvcnRzICYmIGZyZWVFeHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGdsb2JhbGAgZnJvbSBOb2RlLmpzIG9yIEJyb3dzZXJpZmllZCBjb2RlIGFuZCB1c2UgaXQgYXMgYHJvb3RgICovCiAgdmFyIGZyZWVHbG9iYWwgPSBvYmplY3RUeXBlc1t0eXBlb2YgZ2xvYmFsXSAmJiBnbG9iYWw7CiAgaWYgKGZyZWVHbG9iYWwgJiYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsKSkgewogICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaW5kZXhPZmAgd2l0aG91dCBzdXBwb3J0IGZvciBiaW5hcnkgc2VhcmNoZXMKICAgKiBvciBgZnJvbUluZGV4YCBjb25zdHJhaW50cy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGJhc2VJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAoZnJvbUluZGV4IHx8IDApIC0gMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIEFuIGltcGxlbWVudGF0aW9uIG9mIGBfLmNvbnRhaW5zYCBmb3IgY2FjaGUgb2JqZWN0cyB0aGF0IG1pbWljcyB0aGUgcmV0dXJuCiAgICogc2lnbmF0dXJlIG9mIGBfLmluZGV4T2ZgIGJ5IHJldHVybmluZyBgMGAgaWYgdGhlIHZhbHVlIGlzIGZvdW5kLCBlbHNlIGAtMWAuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBjYWNoZSBUaGUgY2FjaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGAwYCBpZiBgdmFsdWVgIGlzIGZvdW5kLCBlbHNlIGAtMWAuCiAgICovCiAgZnVuY3Rpb24gY2FjaGVJbmRleE9mKGNhY2hlLCB2YWx1ZSkgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICBjYWNoZSA9IGNhY2hlLmNhY2hlOwoKICAgIGlmICh0eXBlID09ICdib29sZWFuJyB8fCB2YWx1ZSA9PSBudWxsKSB7CiAgICAgIHJldHVybiBjYWNoZVt2YWx1ZV0gPyAwIDogLTE7CiAgICB9CiAgICBpZiAodHlwZSAhPSAnbnVtYmVyJyAmJiB0eXBlICE9ICdzdHJpbmcnKSB7CiAgICAgIHR5cGUgPSAnb2JqZWN0JzsKICAgIH0KICAgIHZhciBrZXkgPSB0eXBlID09ICdudW1iZXInID8gdmFsdWUgOiBrZXlQcmVmaXggKyB2YWx1ZTsKICAgIGNhY2hlID0gKGNhY2hlID0gY2FjaGVbdHlwZV0pICYmIGNhY2hlW2tleV07CgogICAgcmV0dXJuIHR5cGUgPT0gJ29iamVjdCcKICAgICAgPyAoY2FjaGUgJiYgYmFzZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA+IC0xID8gMCA6IC0xKQogICAgICA6IChjYWNoZSA/IDAgOiAtMSk7CiAgfQoKICAvKioKICAgKiBBZGRzIGEgZ2l2ZW4gdmFsdWUgdG8gdGhlIGNvcnJlc3BvbmRpbmcgY2FjaGUgb2JqZWN0LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBhZGQgdG8gdGhlIGNhY2hlLgogICAqLwogIGZ1bmN0aW9uIGNhY2hlUHVzaCh2YWx1ZSkgewogICAgdmFyIGNhY2hlID0gdGhpcy5jYWNoZSwKICAgICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwoKICAgIGlmICh0eXBlID09ICdib29sZWFuJyB8fCB2YWx1ZSA9PSBudWxsKSB7CiAgICAgIGNhY2hlW3ZhbHVlXSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBpZiAodHlwZSAhPSAnbnVtYmVyJyAmJiB0eXBlICE9ICdzdHJpbmcnKSB7CiAgICAgICAgdHlwZSA9ICdvYmplY3QnOwogICAgICB9CiAgICAgIHZhciBrZXkgPSB0eXBlID09ICdudW1iZXInID8gdmFsdWUgOiBrZXlQcmVmaXggKyB2YWx1ZSwKICAgICAgICAgIHR5cGVDYWNoZSA9IGNhY2hlW3R5cGVdIHx8IChjYWNoZVt0eXBlXSA9IHt9KTsKCiAgICAgIGlmICh0eXBlID09ICdvYmplY3QnKSB7CiAgICAgICAgKHR5cGVDYWNoZVtrZXldIHx8ICh0eXBlQ2FjaGVba2V5XSA9IFtdKSkucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZUNhY2hlW2tleV0gPSB0cnVlOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBfLm1heGAgYW5kIGBfLm1pbmAgYXMgdGhlIGRlZmF1bHQgY2FsbGJhY2sgd2hlbiBhIGdpdmVuCiAgICogY29sbGVjdGlvbiBpcyBhIHN0cmluZyB2YWx1ZS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFRoZSBjaGFyYWN0ZXIgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjb2RlIHVuaXQgb2YgZ2l2ZW4gY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGNoYXJBdENhbGxiYWNrKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUuY2hhckNvZGVBdCgwKTsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHNvcnRCeWAgdG8gY29tcGFyZSB0cmFuc2Zvcm1lZCBgY29sbGVjdGlvbmAgZWxlbWVudHMsIHN0YWJsZSBzb3J0aW5nCiAgICogdGhlbSBpbiBhc2NlbmRpbmcgb3JkZXIuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBhIFRoZSBvYmplY3QgdG8gY29tcGFyZSB0byBgYmAuCiAgICogQHBhcmFtIHtPYmplY3R9IGIgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBhYC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBzb3J0IG9yZGVyIGluZGljYXRvciBvZiBgMWAgb3IgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjb21wYXJlQXNjZW5kaW5nKGEsIGIpIHsKICAgIHZhciBhYyA9IGEuY3JpdGVyaWEsCiAgICAgICAgYmMgPSBiLmNyaXRlcmlhOwoKICAgIC8vIGVuc3VyZSBhIHN0YWJsZSBzb3J0IGluIFY4IGFuZCBvdGhlciBlbmdpbmVzCiAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvdjgvaXNzdWVzL2RldGFpbD9pZD05MAogICAgaWYgKGFjICE9PSBiYykgewogICAgICBpZiAoYWMgPiBiYyB8fCB0eXBlb2YgYWMgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYWMgPCBiYyB8fCB0eXBlb2YgYmMgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIC8vIFRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgYXBwbGljYXRpb25zIGxpa2UgSW5EZXNpZ24gaGFzIGEgYnVnZ3kKICAgIC8vIGBBcnJheSNzb3J0YCBpbXBsZW1lbnRhdGlvbiB0aGF0IGNhdXNlcyBpdCwgdW5kZXIgY2VydGFpbiBjaXJjdW1zdGFuY2VzLAogICAgLy8gdG8gcmV0dXJuIHRoZSBzYW1lIHZhbHVlIGZvciBgYWAgYW5kIGBiYC4KICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vamFzaGtlbmFzL3VuZGVyc2NvcmUvcHVsbC8xMjQ3CiAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgY2FjaGUgb2JqZWN0IHRvIG9wdGltaXplIGxpbmVhciBzZWFyY2hlcyBvZiBsYXJnZSBhcnJheXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheT1bXV0gVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcmV0dXJucyB7bnVsbHxPYmplY3R9IFJldHVybnMgdGhlIGNhY2hlIG9iamVjdCBvciBgbnVsbGAgaWYgY2FjaGluZyBzaG91bGQgbm90IGJlIHVzZWQuCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGUoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBmaXJzdCA9IGFycmF5WzBdLAogICAgICAgIG1pZCA9IGFycmF5WyhsZW5ndGggLyAyKSB8IDBdLAogICAgICAgIGxhc3QgPSBhcnJheVtsZW5ndGggLSAxXTsKCiAgICBpZiAoZmlyc3QgJiYgdHlwZW9mIGZpcnN0ID09ICdvYmplY3QnICYmCiAgICAgICAgbWlkICYmIHR5cGVvZiBtaWQgPT0gJ29iamVjdCcgJiYgbGFzdCAmJiB0eXBlb2YgbGFzdCA9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgY2FjaGUgPSBnZXRPYmplY3QoKTsKICAgIGNhY2hlWydmYWxzZSddID0gY2FjaGVbJ251bGwnXSA9IGNhY2hlWyd0cnVlJ10gPSBjYWNoZVsndW5kZWZpbmVkJ10gPSBmYWxzZTsKCiAgICB2YXIgcmVzdWx0ID0gZ2V0T2JqZWN0KCk7CiAgICByZXN1bHQuYXJyYXkgPSBhcnJheTsKICAgIHJlc3VsdC5jYWNoZSA9IGNhY2hlOwogICAgcmVzdWx0LnB1c2ggPSBjYWNoZVB1c2g7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZAogICAqIHN0cmluZyBsaXRlcmFscy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlU3RyaW5nQ2hhcihtYXRjaCkgewogICAgcmV0dXJuICdcXCcgKyBzdHJpbmdFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIEdldHMgYW4gYXJyYXkgZnJvbSB0aGUgYXJyYXkgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge0FycmF5fSBUaGUgYXJyYXkgZnJvbSB0aGUgcG9vbC4KICAgKi8KICBmdW5jdGlvbiBnZXRBcnJheSgpIHsKICAgIHJldHVybiBhcnJheVBvb2wucG9wKCkgfHwgW107CiAgfQoKICAvKioKICAgKiBHZXRzIGFuIG9iamVjdCBmcm9tIHRoZSBvYmplY3QgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge09iamVjdH0gVGhlIG9iamVjdCBmcm9tIHRoZSBwb29sLgogICAqLwogIGZ1bmN0aW9uIGdldE9iamVjdCgpIHsKICAgIHJldHVybiBvYmplY3RQb29sLnBvcCgpIHx8IHsKICAgICAgJ2FycmF5JzogbnVsbCwKICAgICAgJ2NhY2hlJzogbnVsbCwKICAgICAgJ2NyaXRlcmlhJzogbnVsbCwKICAgICAgJ2ZhbHNlJzogZmFsc2UsCiAgICAgICdpbmRleCc6IDAsCiAgICAgICdudWxsJzogZmFsc2UsCiAgICAgICdudW1iZXInOiBudWxsLAogICAgICAnb2JqZWN0JzogbnVsbCwKICAgICAgJ3B1c2gnOiBudWxsLAogICAgICAnc3RyaW5nJzogbnVsbCwKICAgICAgJ3RydWUnOiBmYWxzZSwKICAgICAgJ3VuZGVmaW5lZCc6IGZhbHNlLAogICAgICAndmFsdWUnOiBudWxsCiAgICB9OwogIH0KCiAgLyoqCiAgICogQSBuby1vcGVyYXRpb24gZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgfQoKICAvKioKICAgKiBSZWxlYXNlcyB0aGUgZ2l2ZW4gYXJyYXkgYmFjayB0byB0aGUgYXJyYXkgcG9vbC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gcmVsZWFzZS4KICAgKi8KICBmdW5jdGlvbiByZWxlYXNlQXJyYXkoYXJyYXkpIHsKICAgIGFycmF5Lmxlbmd0aCA9IDA7CiAgICBpZiAoYXJyYXlQb29sLmxlbmd0aCA8IG1heFBvb2xTaXplKSB7CiAgICAgIGFycmF5UG9vbC5wdXNoKGFycmF5KTsKICAgIH0KICB9CgogIC8qKgogICAqIFJlbGVhc2VzIHRoZSBnaXZlbiBvYmplY3QgYmFjayB0byB0aGUgb2JqZWN0IHBvb2wuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBUaGUgb2JqZWN0IHRvIHJlbGVhc2UuCiAgICovCiAgZnVuY3Rpb24gcmVsZWFzZU9iamVjdChvYmplY3QpIHsKICAgIHZhciBjYWNoZSA9IG9iamVjdC5jYWNoZTsKICAgIGlmIChjYWNoZSkgewogICAgICByZWxlYXNlT2JqZWN0KGNhY2hlKTsKICAgIH0KICAgIG9iamVjdC5hcnJheSA9IG9iamVjdC5jYWNoZSA9IG9iamVjdC5jcml0ZXJpYSA9IG9iamVjdC5vYmplY3QgPSBvYmplY3QubnVtYmVyID0gb2JqZWN0LnN0cmluZyA9IG9iamVjdC52YWx1ZSA9IG51bGw7CiAgICBpZiAob2JqZWN0UG9vbC5sZW5ndGggPCBtYXhQb29sU2l6ZSkgewogICAgICBvYmplY3RQb29sLnB1c2gob2JqZWN0KTsKICAgIH0KICB9CgogIC8qKgogICAqIFNsaWNlcyB0aGUgYGNvbGxlY3Rpb25gIGZyb20gdGhlIGBzdGFydGAgaW5kZXggdXAgdG8sIGJ1dCBub3QgaW5jbHVkaW5nLAogICAqIHRoZSBgZW5kYCBpbmRleC4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBpbnN0ZWFkIG9mIGBBcnJheSNzbGljZWAgdG8gc3VwcG9ydCBub2RlIGxpc3RzCiAgICogaW4gSUUgPCA5IGFuZCB0byBlbnN1cmUgZGVuc2UgYXJyYXlzIGFyZSByZXR1cm5lZC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNsaWNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIGluZGV4LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5LgogICAqLwogIGZ1bmN0aW9uIHNsaWNlKGFycmF5LCBzdGFydCwgZW5kKSB7CiAgICBzdGFydCB8fCAoc3RhcnQgPSAwKTsKICAgIGlmICh0eXBlb2YgZW5kID09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuZCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGVuZCAtIHN0YXJ0IHx8IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBhcnJheVtzdGFydCArIGluZGV4XTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IGBsb2Rhc2hgIGZ1bmN0aW9uIHVzaW5nIHRoZSBnaXZlbiBjb250ZXh0IG9iamVjdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbnRleHQ9cm9vdF0gVGhlIGNvbnRleHQgb2JqZWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gcnVuSW5Db250ZXh0KGNvbnRleHQpIHsKICAgIC8vIEF2b2lkIGlzc3VlcyB3aXRoIHNvbWUgRVMzIGVudmlyb25tZW50cyB0aGF0IGF0dGVtcHQgdG8gdXNlIHZhbHVlcywgbmFtZWQKICAgIC8vIGFmdGVyIGJ1aWx0LWluIGNvbnN0cnVjdG9ycyBsaWtlIGBPYmplY3RgLCBmb3IgdGhlIGNyZWF0aW9uIG9mIGxpdGVyYWxzLgogICAgLy8gRVM1IGNsZWFycyB0aGlzIHVwIGJ5IHN0YXRpbmcgdGhhdCBsaXRlcmFscyBtdXN0IHVzZSBidWlsdC1pbiBjb25zdHJ1Y3RvcnMuCiAgICAvLyBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxMS4xLjUuCiAgICBjb250ZXh0ID0gY29udGV4dCA/IF8uZGVmYXVsdHMocm9vdC5PYmplY3QoKSwgY29udGV4dCwgXy5waWNrKHJvb3QsIGNvbnRleHRQcm9wcykpIDogcm9vdDsKCiAgICAvKiogTmF0aXZlIGNvbnN0cnVjdG9yIHJlZmVyZW5jZXMgKi8KICAgIHZhciBBcnJheSA9IGNvbnRleHQuQXJyYXksCiAgICAgICAgQm9vbGVhbiA9IGNvbnRleHQuQm9vbGVhbiwKICAgICAgICBEYXRlID0gY29udGV4dC5EYXRlLAogICAgICAgIEZ1bmN0aW9uID0gY29udGV4dC5GdW5jdGlvbiwKICAgICAgICBNYXRoID0gY29udGV4dC5NYXRoLAogICAgICAgIE51bWJlciA9IGNvbnRleHQuTnVtYmVyLAogICAgICAgIE9iamVjdCA9IGNvbnRleHQuT2JqZWN0LAogICAgICAgIFJlZ0V4cCA9IGNvbnRleHQuUmVnRXhwLAogICAgICAgIFN0cmluZyA9IGNvbnRleHQuU3RyaW5nLAogICAgICAgIFR5cGVFcnJvciA9IGNvbnRleHQuVHlwZUVycm9yOwoKICAgIC8qKgogICAgICogVXNlZCBmb3IgYEFycmF5YCBtZXRob2QgcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiBOb3JtYWxseSBgQXJyYXkucHJvdG90eXBlYCB3b3VsZCBzdWZmaWNlLCBob3dldmVyLCB1c2luZyBhbiBhcnJheSBsaXRlcmFsCiAgICAgKiBhdm9pZHMgaXNzdWVzIGluIE5hcndoYWwuCiAgICAgKi8KICAgIHZhciBhcnJheVJlZiA9IFtdOwoKICAgIC8qKiBVc2VkIGZvciBuYXRpdmUgbWV0aG9kIHJlZmVyZW5jZXMgKi8KICAgIHZhciBvYmplY3RQcm90byA9IE9iamVjdC5wcm90b3R5cGU7CgogICAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgbm9Db25mbGljdGAgKi8KICAgIHZhciBvbGREYXNoID0gY29udGV4dC5fOwoKICAgIC8qKiBVc2VkIHRvIGRldGVjdCBpZiBhIG1ldGhvZCBpcyBuYXRpdmUgKi8KICAgIHZhciByZU5hdGl2ZSA9IFJlZ0V4cCgnXicgKwogICAgICBTdHJpbmcob2JqZWN0UHJvdG8udmFsdWVPZikKICAgICAgICAucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xdXFxdL2csICdcXCQmJykKICAgICAgICAucmVwbGFjZSgvdmFsdWVPZnxmb3IgW15cXV0rL2csICcuKz8nKSArICckJwogICAgKTsKCiAgICAvKiogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgKi8KICAgIHZhciBjZWlsID0gTWF0aC5jZWlsLAogICAgICAgIGNsZWFyVGltZW91dCA9IGNvbnRleHQuY2xlYXJUaW1lb3V0LAogICAgICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgICAgICBmblRvU3RyaW5nID0gRnVuY3Rpb24ucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgIGdldFByb3RvdHlwZU9mID0gcmVOYXRpdmUudGVzdChnZXRQcm90b3R5cGVPZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZikgJiYgZ2V0UHJvdG90eXBlT2YsCiAgICAgICAgaGFzT3duUHJvcGVydHkgPSBvYmplY3RQcm90by5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICBub3cgPSByZU5hdGl2ZS50ZXN0KG5vdyA9IERhdGUubm93KSAmJiBub3cgfHwgZnVuY3Rpb24oKSB7IHJldHVybiArbmV3IERhdGU7IH0sCiAgICAgICAgcHVzaCA9IGFycmF5UmVmLnB1c2gsCiAgICAgICAgc2V0SW1tZWRpYXRlID0gY29udGV4dC5zZXRJbW1lZGlhdGUsCiAgICAgICAgc2V0VGltZW91dCA9IGNvbnRleHQuc2V0VGltZW91dCwKICAgICAgICBzcGxpY2UgPSBhcnJheVJlZi5zcGxpY2UsCiAgICAgICAgdG9TdHJpbmcgPSBvYmplY3RQcm90by50b1N0cmluZywKICAgICAgICB1bnNoaWZ0ID0gYXJyYXlSZWYudW5zaGlmdDsKCiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIG8gPSB7fSwKICAgICAgICAgICAgZnVuYyA9IHJlTmF0aXZlLnRlc3QoZnVuYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgJiYgZnVuYywKICAgICAgICAgICAgcmVzdWx0ID0gZnVuYyhvLCBvLCBvKSAmJiBmdW5jOwogICAgICB9IGNhdGNoKGUpIHsgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSgpKTsKCiAgICAvKiBOYXRpdmUgbWV0aG9kIHNob3J0Y3V0cyBmb3IgbWV0aG9kcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgb3RoZXIgYGxvZGFzaGAgbWV0aG9kcyAqLwogICAgdmFyIG5hdGl2ZUJpbmQgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUJpbmQgPSB0b1N0cmluZy5iaW5kKSAmJiBuYXRpdmVCaW5kLAogICAgICAgIG5hdGl2ZUNyZWF0ZSA9IHJlTmF0aXZlLnRlc3QobmF0aXZlQ3JlYXRlID0gT2JqZWN0LmNyZWF0ZSkgJiYgbmF0aXZlQ3JlYXRlLAogICAgICAgIG5hdGl2ZUlzQXJyYXkgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KSAmJiBuYXRpdmVJc0FycmF5LAogICAgICAgIG5hdGl2ZUlzRmluaXRlID0gY29udGV4dC5pc0Zpbml0ZSwKICAgICAgICBuYXRpdmVJc05hTiA9IGNvbnRleHQuaXNOYU4sCiAgICAgICAgbmF0aXZlS2V5cyA9IHJlTmF0aXZlLnRlc3QobmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzKSAmJiBuYXRpdmVLZXlzLAogICAgICAgIG5hdGl2ZU1heCA9IE1hdGgubWF4LAogICAgICAgIG5hdGl2ZU1pbiA9IE1hdGgubWluLAogICAgICAgIG5hdGl2ZVBhcnNlSW50ID0gY29udGV4dC5wYXJzZUludCwKICAgICAgICBuYXRpdmVSYW5kb20gPSBNYXRoLnJhbmRvbSwKICAgICAgICBuYXRpdmVTbGljZSA9IGFycmF5UmVmLnNsaWNlOwoKICAgIC8qKiBEZXRlY3QgdmFyaW91cyBlbnZpcm9ubWVudHMgKi8KICAgIHZhciBpc0llT3BlcmEgPSByZU5hdGl2ZS50ZXN0KGNvbnRleHQuYXR0YWNoRXZlbnQpLAogICAgICAgIGlzVjggPSBuYXRpdmVCaW5kICYmICEvXG58dHJ1ZS8udGVzdChuYXRpdmVCaW5kICsgaXNJZU9wZXJhKTsKCiAgICAvKiogVXNlZCB0byBsb29rdXAgYSBidWlsdC1pbiBjb25zdHJ1Y3RvciBieSBbW0NsYXNzXV0gKi8KICAgIHZhciBjdG9yQnlDbGFzcyA9IHt9OwogICAgY3RvckJ5Q2xhc3NbYXJyYXlDbGFzc10gPSBBcnJheTsKICAgIGN0b3JCeUNsYXNzW2Jvb2xDbGFzc10gPSBCb29sZWFuOwogICAgY3RvckJ5Q2xhc3NbZGF0ZUNsYXNzXSA9IERhdGU7CiAgICBjdG9yQnlDbGFzc1tmdW5jQ2xhc3NdID0gRnVuY3Rpb247CiAgICBjdG9yQnlDbGFzc1tvYmplY3RDbGFzc10gPSBPYmplY3Q7CiAgICBjdG9yQnlDbGFzc1tudW1iZXJDbGFzc10gPSBOdW1iZXI7CiAgICBjdG9yQnlDbGFzc1tyZWdleHBDbGFzc10gPSBSZWdFeHA7CiAgICBjdG9yQnlDbGFzc1tzdHJpbmdDbGFzc10gPSBTdHJpbmc7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0IHdoaWNoIHdyYXBzIHRoZSBnaXZlbiB2YWx1ZSB0byBlbmFibGUgaW50dWl0aXZlCiAgICAgKiBtZXRob2QgY2hhaW5pbmcuCiAgICAgKgogICAgICogSW4gYWRkaXRpb24gdG8gTG8tRGFzaCBtZXRob2RzLCB3cmFwcGVycyBhbHNvIGhhdmUgdGhlIGZvbGxvd2luZyBgQXJyYXlgIG1ldGhvZHM6CiAgICAgKiBgY29uY2F0YCwgYGpvaW5gLCBgcG9wYCwgYHB1c2hgLCBgcmV2ZXJzZWAsIGBzaGlmdGAsIGBzbGljZWAsIGBzb3J0YCwgYHNwbGljZWAsCiAgICAgKiBhbmQgYHVuc2hpZnRgCiAgICAgKgogICAgICogQ2hhaW5pbmcgaXMgc3VwcG9ydGVkIGluIGN1c3RvbSBidWlsZHMgYXMgbG9uZyBhcyB0aGUgYHZhbHVlYCBtZXRob2QgaXMKICAgICAqIGltcGxpY2l0bHkgb3IgZXhwbGljaXRseSBpbmNsdWRlZCBpbiB0aGUgYnVpbGQuCiAgICAgKgogICAgICogVGhlIGNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICAgKiBgYWZ0ZXJgLCBgYXNzaWduYCwgYGJpbmRgLCBgYmluZEFsbGAsIGBiaW5kS2V5YCwgYGNoYWluYCwgYGNvbXBhY3RgLAogICAgICogYGNvbXBvc2VgLCBgY29uY2F0YCwgYGNvdW50QnlgLCBgY3JlYXRlQ2FsbGJhY2tgLCBgY3VycnlgLCBgZGVib3VuY2VgLAogICAgICogYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLCBgZmlsdGVyYCwgYGZsYXR0ZW5gLCBgZm9yRWFjaGAsCiAgICAgKiBgZm9yRWFjaFJpZ2h0YCwgYGZvckluYCwgYGZvckluUmlnaHRgLCBgZm9yT3duYCwgYGZvck93blJpZ2h0YCwgYGZ1bmN0aW9uc2AsCiAgICAgKiBgZ3JvdXBCeWAsIGBpbmRleEJ5YCwgYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsIGBpbnZva2VgLCBga2V5c2AsCiAgICAgKiBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwgYG1lcmdlYCwgYG1pbmAsIGBvYmplY3RgLCBgb21pdGAsIGBvbmNlYCwgYHBhaXJzYCwKICAgICAqIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsIGBwaWNrYCwgYHBsdWNrYCwgYHB1bGxgLCBgcHVzaGAsIGByYW5nZWAsIGByZWplY3RgLAogICAgICogYHJlbW92ZWAsIGByZXN0YCwgYHJldmVyc2VgLCBgc2h1ZmZsZWAsIGBzbGljZWAsIGBzb3J0YCwgYHNvcnRCeWAsIGBzcGxpY2VgLAogICAgICogYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwgYHRyYW5zZm9ybWAsIGB1bmlvbmAsIGB1bmlxYCwgYHVuc2hpZnRgLAogICAgICogYHVuemlwYCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLCBhbmQgYHppcGAKICAgICAqCiAgICAgKiBUaGUgbm9uLWNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICAgKiBgY2xvbmVgLCBgY2xvbmVEZWVwYCwgYGNvbnRhaW5zYCwgYGVzY2FwZWAsIGBldmVyeWAsIGBmaW5kYCwgYGZpbmRJbmRleGAsCiAgICAgKiBgZmluZEtleWAsIGBmaW5kTGFzdGAsIGBmaW5kTGFzdEluZGV4YCwgYGZpbmRMYXN0S2V5YCwgYGhhc2AsIGBpZGVudGl0eWAsCiAgICAgKiBgaW5kZXhPZmAsIGBpc0FyZ3VtZW50c2AsIGBpc0FycmF5YCwgYGlzQm9vbGVhbmAsIGBpc0RhdGVgLCBgaXNFbGVtZW50YCwKICAgICAqIGBpc0VtcHR5YCwgYGlzRXF1YWxgLCBgaXNGaW5pdGVgLCBgaXNGdW5jdGlvbmAsIGBpc05hTmAsIGBpc051bGxgLCBgaXNOdW1iZXJgLAogICAgICogYGlzT2JqZWN0YCwgYGlzUGxhaW5PYmplY3RgLCBgaXNSZWdFeHBgLCBgaXNTdHJpbmdgLCBgaXNVbmRlZmluZWRgLCBgam9pbmAsCiAgICAgKiBgbGFzdEluZGV4T2ZgLCBgbWl4aW5gLCBgbm9Db25mbGljdGAsIGBwYXJzZUludGAsIGBwb3BgLCBgcmFuZG9tYCwgYHJlZHVjZWAsCiAgICAgKiBgcmVkdWNlUmlnaHRgLCBgcmVzdWx0YCwgYHNoaWZ0YCwgYHNpemVgLCBgc29tZWAsIGBzb3J0ZWRJbmRleGAsIGBydW5JbkNvbnRleHRgLAogICAgICogYHRlbXBsYXRlYCwgYHVuZXNjYXBlYCwgYHVuaXF1ZUlkYCwgYW5kIGB2YWx1ZWAKICAgICAqCiAgICAgKiBUaGUgd3JhcHBlciBmdW5jdGlvbnMgYGZpcnN0YCBhbmQgYGxhc3RgIHJldHVybiB3cmFwcGVkIHZhbHVlcyB3aGVuIGBuYCBpcwogICAgICogcHJvdmlkZWQsIG90aGVyd2lzZSB0aGV5IHJldHVybiB1bndyYXBwZWQgdmFsdWVzLgogICAgICoKICAgICAqIEV4cGxpY2l0IGNoYWluaW5nIGNhbiBiZSBlbmFibGVkIGJ5IHVzaW5nIHRoZSBgXy5jaGFpbmAgbWV0aG9kLgogICAgICoKICAgICAqIEBuYW1lIF8KICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB3cmFwcGVkID0gXyhbMSwgMiwgM10pOwogICAgICoKICAgICAqIC8vIHJldHVybnMgYW4gdW53cmFwcGVkIHZhbHVlCiAgICAgKiB3cmFwcGVkLnJlZHVjZShmdW5jdGlvbihzdW0sIG51bSkgewogICAgICogICByZXR1cm4gc3VtICsgbnVtOwogICAgICogfSk7CiAgICAgKiAvLyA9PiA2CiAgICAgKgogICAgICogLy8gcmV0dXJucyBhIHdyYXBwZWQgdmFsdWUKICAgICAqIHZhciBzcXVhcmVzID0gd3JhcHBlZC5tYXAoZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gKiBudW07CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoc3F1YXJlcyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheShzcXVhcmVzLnZhbHVlKCkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBsb2Rhc2godmFsdWUpIHsKICAgICAgLy8gZG9uJ3Qgd3JhcCBpZiBhbHJlYWR5IHdyYXBwZWQsIGV2ZW4gaWYgd3JhcHBlZCBieSBhIGRpZmZlcmVudCBgbG9kYXNoYCBjb25zdHJ1Y3RvcgogICAgICByZXR1cm4gKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiAhaXNBcnJheSh2YWx1ZSkgJiYgaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ19fd3JhcHBlZF9fJykpCiAgICAgICA/IHZhbHVlCiAgICAgICA6IG5ldyBsb2Rhc2hXcmFwcGVyKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgZmFzdCBwYXRoIGZvciBjcmVhdGluZyBgbG9kYXNoYCB3cmFwcGVyIG9iamVjdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAgaW4gYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hhaW5BbGwgQSBmbGFnIHRvIGVuYWJsZSBjaGFpbmluZyBmb3IgYWxsIG1ldGhvZHMKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgICAqLwogICAgZnVuY3Rpb24gbG9kYXNoV3JhcHBlcih2YWx1ZSwgY2hhaW5BbGwpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSAhIWNoYWluQWxsOwogICAgICB0aGlzLl9fd3JhcHBlZF9fID0gdmFsdWU7CiAgICB9CiAgICAvLyBlbnN1cmUgYG5ldyBsb2Rhc2hXcmFwcGVyYCBpcyBhbiBpbnN0YW5jZSBvZiBgbG9kYXNoYAogICAgbG9kYXNoV3JhcHBlci5wcm90b3R5cGUgPSBsb2Rhc2gucHJvdG90eXBlOwoKICAgIC8qKgogICAgICogQW4gb2JqZWN0IHVzZWQgdG8gZmxhZyBlbnZpcm9ubWVudHMgZmVhdHVyZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICB2YXIgc3VwcG9ydCA9IGxvZGFzaC5zdXBwb3J0ID0ge307CgogICAgLyoqCiAgICAgKiBEZXRlY3QgaWYgYEZ1bmN0aW9uI2JpbmRgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoYWxsIGJ1dCBWOCkuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8uc3VwcG9ydAogICAgICogQHR5cGUgYm9vbGVhbgogICAgICovCiAgICBzdXBwb3J0LmZhc3RCaW5kID0gbmF0aXZlQmluZCAmJiAhaXNWODsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBmdW5jdGlvbnMgY2FuIGJlIGRlY29tcGlsZWQgYnkgYEZ1bmN0aW9uI3RvU3RyaW5nYAogICAgICogKGFsbCBidXQgUFMzIGFuZCBvbGRlciBPcGVyYSBtb2JpbGUgYnJvd3NlcnMgJiBhdm9pZGVkIGluIFdpbmRvd3MgOCBhcHBzKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY0RlY29tcCA9ICFyZU5hdGl2ZS50ZXN0KGNvbnRleHQuV2luUlRFcnJvcikgJiYgcmVUaGlzLnRlc3QocnVuSW5Db250ZXh0KTsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBgRnVuY3Rpb24jbmFtZWAgaXMgc3VwcG9ydGVkIChhbGwgYnV0IElFKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY05hbWVzID0gdHlwZW9mIEZ1bmN0aW9uLm5hbWUgPT0gJ3N0cmluZyc7CgogICAgLyoqCiAgICAgKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgZGVsaW1pdGVycyB1c2VkIGJ5IExvLURhc2ggYXJlIHNpbWlsYXIgdG8gdGhvc2UgaW4KICAgICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAgICogZGVsaW1pdGVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2VzY2FwZSc6IC88JS0oW1xzXFNdKz8pJT4vZywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAgICovCiAgICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gaW5qZWN0LgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgc3RyaW5nCiAgICAgICAqLwogICAgICAndmFyaWFibGUnOiAnJywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAnaW1wb3J0cyc6IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICAnXyc6IGxvZGFzaAogICAgICB9CiAgICB9OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY2xvbmVgIHdpdGhvdXQgYXJndW1lbnQganVnZ2xpbmcgb3Igc3VwcG9ydAogICAgICogZm9yIGB0aGlzQXJnYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2RlZXA9ZmFsc2VdIFNwZWNpZnkgYSBkZWVwIGNsb25lLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNsb25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgY2xvbmVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDbG9uZSh2YWx1ZSwgZGVlcCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSk7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGluc3BlY3QgW1tDbGFzc11dCiAgICAgIHZhciBpc09iaiA9IGlzT2JqZWN0KHZhbHVlKTsKICAgICAgaWYgKGlzT2JqKSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgICAgIGlmICghY2xvbmVhYmxlQ2xhc3Nlc1tjbGFzc05hbWVdKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjdG9yID0gY3RvckJ5Q2xhc3NbY2xhc3NOYW1lXTsKICAgICAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICAgICAgcmV0dXJuIG5ldyBjdG9yKCt2YWx1ZSk7CgogICAgICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgICAgIHJldHVybiBuZXcgY3Rvcih2YWx1ZSk7CgogICAgICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICAgICAgcmVzdWx0ID0gY3Rvcih2YWx1ZS5zb3VyY2UsIHJlRmxhZ3MuZXhlYyh2YWx1ZSkpOwogICAgICAgICAgICByZXN1bHQubGFzdEluZGV4ID0gdmFsdWUubGFzdEluZGV4OwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSk7CiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgLy8gY2hlY2sgZm9yIGNpcmN1bGFyIHJlZmVyZW5jZXMgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIGNsb25lCiAgICAgICAgdmFyIGluaXRlZFN0YWNrID0gIXN0YWNrQTsKICAgICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gZ2V0QXJyYXkoKSk7CgogICAgICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKHN0YWNrQVtsZW5ndGhdID09IHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBzdGFja0JbbGVuZ3RoXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gaXNBcnIgPyBjdG9yKHZhbHVlLmxlbmd0aCkgOiB7fTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXN1bHQgPSBpc0FyciA/IHNsaWNlKHZhbHVlKSA6IGFzc2lnbih7fSwgdmFsdWUpOwogICAgICB9CiAgICAgIC8vIGFkZCBhcnJheSBwcm9wZXJ0aWVzIGFzc2lnbmVkIGJ5IGBSZWdFeHAjZXhlY2AKICAgICAgaWYgKGlzQXJyKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdpbmRleCcpKSB7CiAgICAgICAgICByZXN1bHQuaW5kZXggPSB2YWx1ZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdpbnB1dCcpKSB7CiAgICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZS5pbnB1dDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZXhpdCBmb3Igc2hhbGxvdyBjbG9uZQogICAgICBpZiAoIWRlZXApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGFkZCB0aGUgc291cmNlIHZhbHVlIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgICAgc3RhY2tCLnB1c2gocmVzdWx0KTsKCiAgICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGJhc2VDbG9uZShvYmpWYWx1ZSwgZGVlcCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgfSk7CgogICAgICBpZiAoaW5pdGVkU3RhY2spIHsKICAgICAgICByZWxlYXNlQXJyYXkoc3RhY2tBKTsKICAgICAgICByZWxlYXNlQXJyYXkoc3RhY2tCKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY3JlYXRlQ2FsbGJhY2tgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY3JlYXRpbmcKICAgICAqICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2tzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IFtmdW5jPWlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcmdDb3VudF0gVGhlIG51bWJlciBvZiBhcmd1bWVudHMgdGhlIGNhbGxiYWNrIGFjY2VwdHMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KSB7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgaXMgbm8gYHRoaXNBcmdgCiAgICAgIGlmICh0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIHZhciBiaW5kRGF0YSA9IGZ1bmMuX19iaW5kRGF0YV9fIHx8IChzdXBwb3J0LmZ1bmNOYW1lcyAmJiAhZnVuYy5uYW1lKTsKICAgICAgaWYgKHR5cGVvZiBiaW5kRGF0YSA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHZhciBzb3VyY2UgPSByZVRoaXMgJiYgZm5Ub1N0cmluZy5jYWxsKGZ1bmMpOwogICAgICAgIGlmICghc3VwcG9ydC5mdW5jTmFtZXMgJiYgc291cmNlICYmICFyZUZ1bmNOYW1lLnRlc3Qoc291cmNlKSkgewogICAgICAgICAgYmluZERhdGEgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VwcG9ydC5mdW5jTmFtZXMgfHwgIWJpbmREYXRhKSB7CiAgICAgICAgICAvLyBjaGVja3MgaWYgYGZ1bmNgIHJlZmVyZW5jZXMgdGhlIGB0aGlzYCBrZXl3b3JkIGFuZCBzdG9yZXMgdGhlIHJlc3VsdAogICAgICAgICAgYmluZERhdGEgPSAhc3VwcG9ydC5mdW5jRGVjb21wIHx8IHJlVGhpcy50ZXN0KHNvdXJjZSk7CiAgICAgICAgICBzZXRCaW5kRGF0YShmdW5jLCBiaW5kRGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgYXJlIG5vIGB0aGlzYCByZWZlcmVuY2VzIG9yIGBmdW5jYCBpcyBib3VuZAogICAgICBpZiAoYmluZERhdGEgIT09IHRydWUgJiYgKGJpbmREYXRhICYmIGJpbmREYXRhWzFdICYgMSkpIHsKICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgfQogICAgICBzd2l0Y2ggKGFyZ0NvdW50KSB7CiAgICAgICAgY2FzZSAxOiByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgdmFsdWUpOwogICAgICAgIH07CiAgICAgICAgY2FzZSAyOiByZXR1cm4gZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhLCBiKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgMzogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIH07CiAgICAgICAgY2FzZSA0OiByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBiaW5kKGZ1bmMsIHRoaXNBcmcpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZmxhdHRlbmAgd2l0aG91dCBzdXBwb3J0IGZvciBjYWxsYmFjawogICAgICogc2hvcnRoYW5kcyBvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NoYWxsb3c9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGEgc2luZ2xlIGxldmVsLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNBcmdBcnJheXM9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGFycmF5cyBhbmQgYGFyZ3VtZW50c2Agb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzdGFydCBmcm9tLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdywgaXNBcmdBcnJheXMsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAoZnJvbUluZGV4IHx8IDApIC0gMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJwogICAgICAgICAgICAmJiAoaXNBcnJheSh2YWx1ZSkgfHwgaXNBcmd1bWVudHModmFsdWUpKSkgewogICAgICAgICAgLy8gcmVjdXJzaXZlbHkgZmxhdHRlbiBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgdmFsdWUgPSBiYXNlRmxhdHRlbih2YWx1ZSwgaXNTaGFsbG93LCBpc0FyZ0FycmF5cyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsSW5kZXggPSAtMSwKICAgICAgICAgICAgICB2YWxMZW5ndGggPSB2YWx1ZS5sZW5ndGgsCiAgICAgICAgICAgICAgcmVzSW5kZXggPSByZXN1bHQubGVuZ3RoOwoKICAgICAgICAgIHJlc3VsdC5sZW5ndGggKz0gdmFsTGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsrdmFsSW5kZXggPCB2YWxMZW5ndGgpIHsKICAgICAgICAgICAgcmVzdWx0W3Jlc0luZGV4KytdID0gdmFsdWVbdmFsSW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIWlzQXJnQXJyYXlzKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc0VxdWFsYCwgd2l0aG91dCBzdXBwb3J0IGZvciBgdGhpc0FyZ2AgYmluZGluZywKICAgICAqIHRoYXQgYWxsb3dzIHBhcnRpYWwgIl8ud2hlcmUiIHN0eWxlIGNvbXBhcmlzb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IGEgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IGIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY29tcGFyaW5nIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpc1doZXJlPWZhbHNlXSBBIGZsYWcgdG8gaW5kaWNhdGUgcGVyZm9ybWluZyBwYXJ0aWFsIGNvbXBhcmlzb25zLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBgYWAgb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIFRyYWNrcyB0cmF2ZXJzZWQgYGJgIG9iamVjdHMuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNFcXVhbChhLCBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgLy8gdXNlZCB0byBpbmRpY2F0ZSB0aGF0IHdoZW4gY29tcGFyaW5nIG9iamVjdHMsIGBhYCBoYXMgYXQgbGVhc3QgdGhlIHByb3BlcnRpZXMgb2YgYGJgCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjayhhLCBiKTsKICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBleGl0IGVhcmx5IGZvciBpZGVudGljYWwgdmFsdWVzCiAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgLy8gdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICByZXR1cm4gYSAhPT0gMCB8fCAoMSAvIGEgPT0gMSAvIGIpOwogICAgICB9CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIGEsCiAgICAgICAgICBvdGhlclR5cGUgPSB0eXBlb2YgYjsKCiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIHVubGlrZSBwcmltaXRpdmUgdmFsdWVzCiAgICAgIGlmIChhID09PSBhICYmCiAgICAgICAgICAhKGEgJiYgb2JqZWN0VHlwZXNbdHlwZV0pICYmCiAgICAgICAgICAhKGIgJiYgb2JqZWN0VHlwZXNbb3RoZXJUeXBlXSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gZXhpdCBlYXJseSBmb3IgYG51bGxgIGFuZCBgdW5kZWZpbmVkYCBhdm9pZGluZyBFUzMncyBGdW5jdGlvbiNjYWxsIGJlaGF2aW9yCiAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMy40LjQKICAgICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgfQogICAgICAvLyBjb21wYXJlIFtbQ2xhc3NdXSBuYW1lcwogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKSwKICAgICAgICAgIG90aGVyQ2xhc3MgPSB0b1N0cmluZy5jYWxsKGIpOwoKICAgICAgaWYgKGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MpIHsKICAgICAgICBjbGFzc05hbWUgPSBvYmplY3RDbGFzczsKICAgICAgfQogICAgICBpZiAob3RoZXJDbGFzcyA9PSBhcmdzQ2xhc3MpIHsKICAgICAgICBvdGhlckNsYXNzID0gb2JqZWN0Q2xhc3M7CiAgICAgIH0KICAgICAgaWYgKGNsYXNzTmFtZSAhPSBvdGhlckNsYXNzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgICAgY2FzZSBkYXRlQ2xhc3M6CiAgICAgICAgICAvLyBjb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWJlcnMsIGRhdGVzIHRvIG1pbGxpc2Vjb25kcyBhbmQgYm9vbGVhbnMKICAgICAgICAgIC8vIHRvIGAxYCBvciBgMGAgdHJlYXRpbmcgaW52YWxpZCBkYXRlcyBjb2VyY2VkIHRvIGBOYU5gIGFzIG5vdCBlcXVhbAogICAgICAgICAgcmV0dXJuICthID09ICtiOwoKICAgICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgICAgLy8gdHJlYXQgYE5hTmAgdnMuIGBOYU5gIGFzIGVxdWFsCiAgICAgICAgICByZXR1cm4gKGEgIT0gK2EpCiAgICAgICAgICAgID8gYiAhPSArYgogICAgICAgICAgICAvLyBidXQgdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICAgICAgOiAoYSA9PSAwID8gKDEgLyBhID09IDEgLyBiKSA6IGEgPT0gK2IpOwoKICAgICAgICBjYXNlIHJlZ2V4cENsYXNzOgogICAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgICAvLyBjb2VyY2UgcmVnZXhlcyB0byBzdHJpbmdzIChodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjEwLjYuNCkKICAgICAgICAgIC8vIHRyZWF0IHN0cmluZyBwcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCBpbnN0YW5jZXMgYXMgZXF1YWwKICAgICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBjbGFzc05hbWUgPT0gYXJyYXlDbGFzczsKICAgICAgaWYgKCFpc0FycikgewogICAgICAgIC8vIHVud3JhcCBhbnkgYGxvZGFzaGAgd3JhcHBlZCB2YWx1ZXMKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCAnX193cmFwcGVkX18gJykgfHwgaGFzT3duUHJvcGVydHkuY2FsbChiLCAnX193cmFwcGVkX18nKSkgewogICAgICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsKGEuX193cmFwcGVkX18gfHwgYSwgYi5fX3dyYXBwZWRfXyB8fCBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpOwogICAgICAgIH0KICAgICAgICAvLyBleGl0IGZvciBmdW5jdGlvbnMgYW5kIERPTSBub2RlcwogICAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICAgIHZhciBjdG9yQSA9IGEuY29uc3RydWN0b3IsCiAgICAgICAgICAgIGN0b3JCID0gYi5jb25zdHJ1Y3RvcjsKCiAgICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYgISgKICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGN0b3JBKSAmJiBjdG9yQSBpbnN0YW5jZW9mIGN0b3JBICYmCiAgICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQgogICAgICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGFzc3VtZSBjeWNsaWMgc3RydWN0dXJlcyBhcmUgZXF1YWwKICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMi4zKQogICAgICB2YXIgaW5pdGVkU3RhY2sgPSAhc3RhY2tBOwogICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHNpemUgPSAwOwogICAgICByZXN1bHQgPSB0cnVlOwoKICAgICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICBzdGFja0EucHVzaChhKTsKICAgICAgc3RhY2tCLnB1c2goYik7CgogICAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycikgewogICAgICAgIGxlbmd0aCA9IGEubGVuZ3RoOwogICAgICAgIHNpemUgPSBiLmxlbmd0aDsKCiAgICAgICAgLy8gY29tcGFyZSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkKICAgICAgICByZXN1bHQgPSBzaXplID09IGEubGVuZ3RoOwogICAgICAgIGlmICghcmVzdWx0ICYmICFpc1doZXJlKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICAvLyBkZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoLAogICAgICAgICAgICAgIHZhbHVlID0gYltzaXplXTsKCiAgICAgICAgICBpZiAoaXNXaGVyZSkgewogICAgICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgICAgIGlmICgocmVzdWx0ID0gYmFzZUlzRXF1YWwoYVtpbmRleF0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwoYVtzaXplXSwgdmFsdWUsIGNhbGxiYWNrLCBpc1doZXJlLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGRlZXAgY29tcGFyZSBvYmplY3RzIHVzaW5nIGBmb3JJbmAsIGluc3RlYWQgb2YgYGZvck93bmAsIHRvIGF2b2lkIGBPYmplY3Qua2V5c2AKICAgICAgLy8gd2hpY2gsIGluIHRoaXMgY2FzZSwgaXMgbW9yZSBjb3N0bHkKICAgICAgZm9ySW4oYiwgZnVuY3Rpb24odmFsdWUsIGtleSwgYikgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkpIHsKICAgICAgICAgIC8vIGNvdW50IHRoZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSBlYWNoIHByb3BlcnR5IHZhbHVlLgogICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkgJiYgYmFzZUlzRXF1YWwoYVtrZXldLCB2YWx1ZSwgY2FsbGJhY2ssIGlzV2hlcmUsIHN0YWNrQSwgc3RhY2tCKSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmIChyZXN1bHQgJiYgIWlzV2hlcmUpIHsKICAgICAgICAvLyBlbnN1cmUgYm90aCBvYmplY3RzIGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMKICAgICAgICBmb3JJbihhLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBhKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBrZXkpKSB7CiAgICAgICAgICAgIC8vIGBzaXplYCB3aWxsIGJlIGAtMWAgaWYgYGFgIGhhcyBtb3JlIHByb3BlcnRpZXMgdGhhbiBgYmAKICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGluaXRlZFN0YWNrKSB7CiAgICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQSk7CiAgICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm1lcmdlYCB3aXRob3V0IGFyZ3VtZW50IGp1Z2dsaW5nIG9yIHN1cHBvcnQKICAgICAqIGZvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBtZXJnaW5nIHByb3BlcnRpZXMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc3RhY2tBPVtdXSBUcmFja3MgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQj1bXV0gQXNzb2NpYXRlcyB2YWx1ZXMgd2l0aCBzb3VyY2UgY291bnRlcnBhcnRzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlTWVyZ2Uob2JqZWN0LCBzb3VyY2UsIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQikgewogICAgICAoaXNBcnJheShzb3VyY2UpID8gZm9yRWFjaCA6IGZvck93bikoc291cmNlLCBmdW5jdGlvbihzb3VyY2UsIGtleSkgewogICAgICAgIHZhciBmb3VuZCwKICAgICAgICAgICAgaXNBcnIsCiAgICAgICAgICAgIHJlc3VsdCA9IHNvdXJjZSwKICAgICAgICAgICAgdmFsdWUgPSBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKHNvdXJjZSAmJiAoKGlzQXJyID0gaXNBcnJheShzb3VyY2UpKSB8fCBpc1BsYWluT2JqZWN0KHNvdXJjZSkpKSB7CiAgICAgICAgICAvLyBhdm9pZCBtZXJnaW5nIHByZXZpb3VzbHkgbWVyZ2VkIGN5Y2xpYyBzb3VyY2VzCiAgICAgICAgICB2YXIgc3RhY2tMZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0YWNrTGVuZ3RoLS0pIHsKICAgICAgICAgICAgaWYgKChmb3VuZCA9IHN0YWNrQVtzdGFja0xlbmd0aF0gPT0gc291cmNlKSkgewogICAgICAgICAgICAgIHZhbHVlID0gc3RhY2tCW3N0YWNrTGVuZ3RoXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgICB2YXIgaXNTaGFsbG93OwogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgICBpZiAoKGlzU2hhbGxvdyA9IHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IGlzQXJyCiAgICAgICAgICAgICAgICA/IChpc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW10pCiAgICAgICAgICAgICAgICA6IChpc1BsYWluT2JqZWN0KHZhbHVlKSA/IHZhbHVlIDoge30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFkZCBgc291cmNlYCBhbmQgYXNzb2NpYXRlZCBgdmFsdWVgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAgICAgICBzdGFja0EucHVzaChzb3VyY2UpOwogICAgICAgICAgICBzdGFja0IucHVzaCh2YWx1ZSk7CgogICAgICAgICAgICAvLyByZWN1cnNpdmVseSBtZXJnZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgICBpZiAoIWlzU2hhbGxvdykgewogICAgICAgICAgICAgIGJhc2VNZXJnZSh2YWx1ZSwgc291cmNlLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgIHJlc3VsdCA9IHNvdXJjZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9iamVjdFtrZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8udW5pcWAgd2l0aG91dCBzdXBwb3J0IGZvciBjYWxsYmFjayBzaG9ydGhhbmRzCiAgICAgKiBvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYGFycmF5YCBpcyBzb3J0ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIGFycmF5LgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgdmFyIGlzTGFyZ2UgPSAhaXNTb3J0ZWQgJiYgbGVuZ3RoID49IGxhcmdlQXJyYXlTaXplICYmIGluZGV4T2YgPT09IGJhc2VJbmRleE9mLAogICAgICAgICAgc2VlbiA9IChjYWxsYmFjayB8fCBpc0xhcmdlKSA/IGdldEFycmF5KCkgOiByZXN1bHQ7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBjYWNoZSA9IGNyZWF0ZUNhY2hlKHNlZW4pOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgaW5kZXhPZiA9IGNhY2hlSW5kZXhPZjsKICAgICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgICAgc2VlbiA9IGNhbGxiYWNrID8gc2VlbiA6IChyZWxlYXNlQXJyYXkoc2VlbiksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdLAogICAgICAgICAgICBjb21wdXRlZCA9IGNhbGxiYWNrID8gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBhcnJheSkgOiB2YWx1ZTsKCiAgICAgICAgaWYgKGlzU29ydGVkCiAgICAgICAgICAgICAgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSBjb21wdXRlZAogICAgICAgICAgICAgIDogaW5kZXhPZihzZWVuLCBjb21wdXRlZCkgPCAwCiAgICAgICAgICAgICkgewogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGlzTGFyZ2UpIHsKICAgICAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICByZWxlYXNlQXJyYXkoc2Vlbi5hcnJheSk7CiAgICAgICAgcmVsZWFzZU9iamVjdChzZWVuKTsKICAgICAgfSBlbHNlIGlmIChjYWxsYmFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzZWVuKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhIGNvbGxlY3Rpb24sIGNyZWF0aW5nIGFuIG9iamVjdCBjb21wb3NlZAogICAgICogb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nIGVhY2ggZWxlbWVudCBvZiB0aGUgY29sbGVjdGlvbgogICAgICogdGhyb3VnaCBhIGNhbGxiYWNrLiBUaGUgZ2l2ZW4gYHNldHRlcmAgZnVuY3Rpb24gc2V0cyB0aGUga2V5cyBhbmQgdmFsdWVzCiAgICAgKiBvZiB0aGUgY29tcG9zZWQgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzZXR0ZXIgVGhlIHNldHRlciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFnZ3JlZ2F0b3IgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUFnZ3JlZ2F0b3Ioc2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICAgIHNldHRlcihyZXN1bHQsIHZhbHVlLCBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLCBjb2xsZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgc2V0dGVyKHJlc3VsdCwgdmFsdWUsIGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pLCBjb2xsZWN0aW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBlaXRoZXIgY3VycmllcyBvciBpbnZva2VzIGBmdW5jYAogICAgICogd2l0aCBhbiBvcHRpb25hbCBgdGhpc2AgYmluZGluZyBhbmQgcGFydGlhbGx5IGFwcGxpZWQgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gZnVuYyBUaGUgZnVuY3Rpb24gb3IgbWV0aG9kIG5hbWUgdG8gcmVmZXJlbmNlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgb2YgbWV0aG9kIGZsYWdzIHRvIGNvbXBvc2UuCiAgICAgKiAgVGhlIGJpdG1hc2sgbWF5IGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZmxhZ3M6CiAgICAgKiAgMSAtIGBfLmJpbmRgCiAgICAgKiAgMiAtIGBfLmJpbmRLZXlgCiAgICAgKiAgNCAtIGBfLmN1cnJ5YAogICAgICogIDggLSBgXy5jdXJyeWAgKGJvdW5kKQogICAgICogIDE2IC0gYF8ucGFydGlhbGAKICAgICAqICAzMiAtIGBfLnBhcnRpYWxSaWdodGAKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwYXJ0aWFsQXJnc10gQW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIHByZXBlbmQgdG8gdGhvc2UKICAgICAqICBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtBcnJheX0gW3BhcnRpYWxSaWdodEFyZ3NdIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBhcHBlbmQgdG8gdGhvc2UKICAgICAqICBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHldIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQm91bmQoZnVuYywgYml0bWFzaywgcGFydGlhbEFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MsIHRoaXNBcmcsIGFyaXR5KSB7CiAgICAgIHZhciBpc0JpbmQgPSBiaXRtYXNrICYgMSwKICAgICAgICAgIGlzQmluZEtleSA9IGJpdG1hc2sgJiAyLAogICAgICAgICAgaXNDdXJyeSA9IGJpdG1hc2sgJiA0LAogICAgICAgICAgaXNDdXJyeUJvdW5kID0gYml0bWFzayAmIDgsCiAgICAgICAgICBpc1BhcnRpYWwgPSBiaXRtYXNrICYgMTYsCiAgICAgICAgICBpc1BhcnRpYWxSaWdodCA9IGJpdG1hc2sgJiAzMiwKICAgICAgICAgIGtleSA9IGZ1bmM7CgogICAgICBpZiAoIWlzQmluZEtleSAmJiAhaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgaWYgKGlzUGFydGlhbCAmJiAhcGFydGlhbEFyZ3MubGVuZ3RoKSB7CiAgICAgICAgYml0bWFzayAmPSB+MTY7CiAgICAgICAgaXNQYXJ0aWFsID0gcGFydGlhbEFyZ3MgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAoaXNQYXJ0aWFsUmlnaHQgJiYgIXBhcnRpYWxSaWdodEFyZ3MubGVuZ3RoKSB7CiAgICAgICAgYml0bWFzayAmPSB+MzI7CiAgICAgICAgaXNQYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHRBcmdzID0gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGJpbmREYXRhID0gZnVuYyAmJiBmdW5jLl9fYmluZERhdGFfXzsKICAgICAgaWYgKGJpbmREYXRhKSB7CiAgICAgICAgaWYgKGlzQmluZCAmJiAhKGJpbmREYXRhWzFdICYgMSkpIHsKICAgICAgICAgIGJpbmREYXRhWzRdID0gdGhpc0FyZzsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0JpbmQgJiYgYmluZERhdGFbMV0gJiAxKSB7CiAgICAgICAgICBiaXRtYXNrIHw9IDg7CiAgICAgICAgfQogICAgICAgIGlmIChpc0N1cnJ5ICYmICEoYmluZERhdGFbMV0gJiA0KSkgewogICAgICAgICAgYmluZERhdGFbNV0gPSBhcml0eTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgcHVzaC5hcHBseShiaW5kRGF0YVsyXSB8fCAoYmluZERhdGFbMl0gPSBbXSksIHBhcnRpYWxBcmdzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUGFydGlhbFJpZ2h0KSB7CiAgICAgICAgICBwdXNoLmFwcGx5KGJpbmREYXRhWzNdIHx8IChiaW5kRGF0YVszXSA9IFtdKSwgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgfQogICAgICAgIGJpbmREYXRhWzFdIHw9IGJpdG1hc2s7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kLmFwcGx5KG51bGwsIGJpbmREYXRhKTsKICAgICAgfQogICAgICAvLyB1c2UgYEZ1bmN0aW9uI2JpbmRgIGlmIGl0IGV4aXN0cyBhbmQgaXMgZmFzdAogICAgICAvLyAoaW4gVjggYEZ1bmN0aW9uI2JpbmRgIGlzIHNsb3dlciBleGNlcHQgd2hlbiBwYXJ0aWFsbHkgYXBwbGllZCkKICAgICAgaWYgKGlzQmluZCAmJiAhKGlzQmluZEtleSB8fCBpc0N1cnJ5IHx8IGlzUGFydGlhbFJpZ2h0KSAmJgogICAgICAgICAgKHN1cHBvcnQuZmFzdEJpbmQgfHwgKG5hdGl2ZUJpbmQgJiYgaXNQYXJ0aWFsKSkpIHsKICAgICAgICBpZiAoaXNQYXJ0aWFsKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFt0aGlzQXJnXTsKICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgcGFydGlhbEFyZ3MpOwogICAgICAgIH0KICAgICAgICB2YXIgYm91bmQgPSBpc1BhcnRpYWwKICAgICAgICAgID8gbmF0aXZlQmluZC5hcHBseShmdW5jLCBhcmdzKQogICAgICAgICAgOiBuYXRpdmVCaW5kLmNhbGwoZnVuYywgdGhpc0FyZyk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGBGdW5jdGlvbiNiaW5kYCBzcGVjCiAgICAgICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjMuNC41CiAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICB0aGlzQmluZGluZyA9IGlzQmluZCA/IHRoaXNBcmcgOiB0aGlzOwoKICAgICAgICAgIGlmIChpc0N1cnJ5IHx8IGlzUGFydGlhbCB8fCBpc1BhcnRpYWxSaWdodCkgewogICAgICAgICAgICBhcmdzID0gbmF0aXZlU2xpY2UuY2FsbChhcmdzKTsKICAgICAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgICAgIHVuc2hpZnQuYXBwbHkoYXJncywgcGFydGlhbEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1BhcnRpYWxSaWdodCkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VycnkgJiYgYXJncy5sZW5ndGggPCBhcml0eSkgewogICAgICAgICAgICAgIGJpdG1hc2sgfD0gMTYgJiB+MzI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIChpc0N1cnJ5Qm91bmQgPyBiaXRtYXNrIDogYml0bWFzayAmIH4zKSwgYXJncywgbnVsbCwgdGhpc0FyZywgYXJpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNCaW5kS2V5KSB7CiAgICAgICAgICAgIGZ1bmMgPSB0aGlzQmluZGluZ1trZXldOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgICAgICAvLyBlbnN1cmUgYG5ldyBib3VuZGAgaXMgYW4gaW5zdGFuY2Ugb2YgYGZ1bmNgCiAgICAgICAgICAgIHRoaXNCaW5kaW5nID0gY3JlYXRlT2JqZWN0KGZ1bmMucHJvdG90eXBlKTsKCiAgICAgICAgICAgIC8vIG1pbWljIHRoZSBjb25zdHJ1Y3RvcidzIGByZXR1cm5gIGJlaGF2aW9yCiAgICAgICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTMuMi4yCiAgICAgICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHNldEJpbmREYXRhKGJvdW5kLCBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cykpOwogICAgICByZXR1cm4gYm91bmQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IG9iamVjdCB3aXRoIHRoZSBzcGVjaWZpZWQgYHByb3RvdHlwZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm90b3R5cGUgVGhlIHByb3RvdHlwZSBvYmplY3QuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVPYmplY3QocHJvdG90eXBlKSB7CiAgICAgIHJldHVybiBpc09iamVjdChwcm90b3R5cGUpID8gbmF0aXZlQ3JlYXRlKHByb3RvdHlwZSkgOiB7fTsKICAgIH0KICAgIC8vIGZhbGxiYWNrIGZvciBicm93c2VycyB3aXRob3V0IGBPYmplY3QuY3JlYXRlYAogICAgaWYgKCFuYXRpdmVDcmVhdGUpIHsKICAgICAgY3JlYXRlT2JqZWN0ID0gZnVuY3Rpb24ocHJvdG90eXBlKSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KHByb3RvdHlwZSkpIHsKICAgICAgICAgIG5vb3AucHJvdG90eXBlID0gcHJvdG90eXBlOwogICAgICAgICAgdmFyIHJlc3VsdCA9IG5ldyBub29wOwogICAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0IHx8IHt9OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGFwcHJvcHJpYXRlICJpbmRleE9mIiBmdW5jdGlvbi4gSWYgdGhlIGBfLmluZGV4T2ZgIG1ldGhvZCBpcwogICAgICogY3VzdG9taXplZCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgY3VzdG9tIG1ldGhvZCwgb3RoZXJ3aXNlIGl0IHJldHVybnMKICAgICAqIHRoZSBgYmFzZUluZGV4T2ZgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlICJpbmRleE9mIiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SW5kZXhPZigpIHsKICAgICAgdmFyIHJlc3VsdCA9IChyZXN1bHQgPSBsb2Rhc2guaW5kZXhPZikgPT09IGluZGV4T2YgPyBiYXNlSW5kZXhPZiA6IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgYHRoaXNgIGJpbmRpbmcgZGF0YSBvbiBhIGdpdmVuIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBzZXQgZGF0YSBvbi4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4KICAgICAqLwogICAgdmFyIHNldEJpbmREYXRhID0gIWRlZmluZVByb3BlcnR5ID8gbm9vcCA6IGZ1bmN0aW9uKGZ1bmMsIHZhbHVlKSB7CiAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSB2YWx1ZTsKICAgICAgZGVmaW5lUHJvcGVydHkoZnVuYywgJ19fYmluZERhdGFfXycsIGRlc2NyaXB0b3IpOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgZmFsbGJhY2sgaW1wbGVtZW50YXRpb24gb2YgYGlzUGxhaW5PYmplY3RgIHdoaWNoIGNoZWNrcyBpZiBhIGdpdmVuIHZhbHVlCiAgICAgKiBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IsIGFzc3VtaW5nIG9iamVjdHMgY3JlYXRlZAogICAgICogYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yIGhhdmUgbm8gaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcyBhbmQgdGhhdAogICAgICogdGhlcmUgYXJlIG5vIGBPYmplY3QucHJvdG90eXBlYCBleHRlbnNpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNoaW1Jc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICAgIHZhciBjdG9yLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgLy8gYXZvaWQgbm9uIE9iamVjdCBvYmplY3RzLCBgYXJndW1lbnRzYCBvYmplY3RzLCBhbmQgRE9NIGVsZW1lbnRzCiAgICAgIGlmICghKHZhbHVlICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG9iamVjdENsYXNzKSB8fAogICAgICAgICAgKGN0b3IgPSB2YWx1ZS5jb25zdHJ1Y3RvciwgaXNGdW5jdGlvbihjdG9yKSAmJiAhKGN0b3IgaW5zdGFuY2VvZiBjdG9yKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gSW4gbW9zdCBlbnZpcm9ubWVudHMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGJlZm9yZQogICAgICAvLyBpdHMgaW5oZXJpdGVkIHByb3BlcnRpZXMuIElmIHRoZSBsYXN0IGl0ZXJhdGVkIHByb3BlcnR5IGlzIGFuIG9iamVjdCdzCiAgICAgIC8vIG93biBwcm9wZXJ0eSB0aGVuIHRoZXJlIGFyZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0eXBlb2YgcmVzdWx0ID09ICd1bmRlZmluZWQnIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIHJlc3VsdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIGJ5IGB1bmVzY2FwZWAgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gdW5lc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgY2hhcmFjdGVyLgogICAgICovCiAgICBmdW5jdGlvbiB1bmVzY2FwZUh0bWxDaGFyKG1hdGNoKSB7CiAgICAgIHJldHVybiBodG1sVW5lc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJndW1lbnRzKGFyZ3VtZW50cyk7IH0pKDEsIDIsIDMpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJyAmJgogICAgICAgIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFyZ3NDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8uaXNBcnJheShhcmd1bWVudHMpOyB9KSgpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgdmFyIGlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJyAmJgogICAgICAgIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFycmF5Q2xhc3MgfHwgZmFsc2U7CiAgICB9OwoKICAgIC8qKgogICAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgT2JqZWN0LmtleXNgIHdoaWNoIHByb2R1Y2VzIGFuIGFycmF5IG9mIHRoZQogICAgICogZ2l2ZW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgICAqLwogICAgdmFyIHNoaW1LZXlzID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBvYmplY3QsIHJlc3VsdCA9IFtdOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIShvYmplY3RUeXBlc1t0eXBlb2Ygb2JqZWN0XSkpIHJldHVybiByZXN1bHQ7CiAgICAgICAgZm9yIChpbmRleCBpbiBpdGVyYWJsZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGluZGV4KSkgewogICAgICAgICAgICByZXN1bHQucHVzaChpbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMgb2YgYW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ua2V5cyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IFsnb25lJywgJ3R3bycsICd0aHJlZSddIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIga2V5cyA9ICFuYXRpdmVLZXlzID8gc2hpbUtleXMgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgaWYgKCFpc09iamVjdChvYmplY3QpKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHJldHVybiBuYXRpdmVLZXlzKG9iamVjdCk7CiAgICB9OwoKICAgIC8qKgogICAgICogVXNlZCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllczoKICAgICAqCiAgICAgKiBUaG91Z2ggdGhlIGA+YCBjaGFyYWN0ZXIgaXMgZXNjYXBlZCBmb3Igc3ltbWV0cnksIGNoYXJhY3RlcnMgbGlrZSBgPmAgYW5kIGAvYAogICAgICogZG9uJ3QgcmVxdWlyZSBlc2NhcGluZyBpbiBIVE1MIGFuZCBoYXZlIG5vIHNwZWNpYWwgbWVhbmluZyB1bmxlc3MgdGhleSdyZSBwYXJ0CiAgICAgKiBvZiBhIHRhZyBvciBhbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUuCiAgICAgKiBodHRwOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9hbWJpZ3VvdXMtYW1wZXJzYW5kcyAodW5kZXIgInNlbWktcmVsYXRlZCBmdW4gZmFjdCIpCiAgICAgKi8KICAgIHZhciBodG1sRXNjYXBlcyA9IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjMzk7JwogICAgfTsKCiAgICAvKiogVXNlZCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycyAqLwogICAgdmFyIGh0bWxVbmVzY2FwZXMgPSBpbnZlcnQoaHRtbEVzY2FwZXMpOwoKICAgIC8qKiBVc2VkIHRvIG1hdGNoIEhUTUwgZW50aXRpZXMgYW5kIEhUTUwgY2hhcmFjdGVycyAqLwogICAgdmFyIHJlRXNjYXBlZEh0bWwgPSBSZWdFeHAoJygnICsga2V5cyhodG1sVW5lc2NhcGVzKS5qb2luKCd8JykgKyAnKScsICdnJyksCiAgICAgICAgcmVVbmVzY2FwZWRIdG1sID0gUmVnRXhwKCdbJyArIGtleXMoaHRtbEVzY2FwZXMpLmpvaW4oJycpICsgJ10nLCAnZycpOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBvYmplY3QuIFN1YnNlcXVlbnQgc291cmNlcyB3aWxsIG92ZXJ3cml0ZSBwcm9wZXJ0eSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cwogICAgICogc291cmNlcy4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlCiAgICAgKiBhc3NpZ25lZCB2YWx1ZXMuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0d28KICAgICAqIGFyZ3VtZW50czsgKG9iamVjdFZhbHVlLCBzb3VyY2VWYWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAYWxpYXMgZXh0ZW5kCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IFtzb3VyY2VdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBhc3NpZ25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uYXNzaWduKHsgJ25hbWUnOiAnbW9lJyB9LCB7ICdhZ2UnOiA0MCB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgICAqCiAgICAgKiB2YXIgZGVmYXVsdHMgPSBfLnBhcnRpYWxSaWdodChfLmFzc2lnbiwgZnVuY3Rpb24oYSwgYikgewogICAgICogICByZXR1cm4gdHlwZW9mIGEgPT0gJ3VuZGVmaW5lZCcgPyBiIDogYTsKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBmb29kID0geyAnbmFtZSc6ICdhcHBsZScgfTsKICAgICAqIGRlZmF1bHRzKGZvb2QsIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdhcHBsZScsICd0eXBlJzogJ2ZydWl0JyB9CiAgICAgKi8KICAgIHZhciBhc3NpZ24gPSBmdW5jdGlvbihvYmplY3QsIHNvdXJjZSwgZ3VhcmQpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IG9iamVjdCwgcmVzdWx0ID0gaXRlcmFibGU7CiAgICAgIGlmICghaXRlcmFibGUpIHJldHVybiByZXN1bHQ7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgYXJnc0luZGV4ID0gMCwKICAgICAgICAgIGFyZ3NMZW5ndGggPSB0eXBlb2YgZ3VhcmQgPT0gJ251bWJlcicgPyAyIDogYXJncy5sZW5ndGg7CiAgICAgIGlmIChhcmdzTGVuZ3RoID4gMyAmJiB0eXBlb2YgYXJnc1thcmdzTGVuZ3RoIC0gMl0gPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBjYWxsYmFjayA9IGJhc2VDcmVhdGVDYWxsYmFjayhhcmdzWy0tYXJnc0xlbmd0aCAtIDFdLCBhcmdzW2FyZ3NMZW5ndGgtLV0sIDIpOwogICAgICB9IGVsc2UgaWYgKGFyZ3NMZW5ndGggPiAyICYmIHR5cGVvZiBhcmdzW2FyZ3NMZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tYXJnc0xlbmd0aF07CiAgICAgIH0KICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIGl0ZXJhYmxlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGlmIChpdGVyYWJsZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSB7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2sgPyBjYWxsYmFjayhyZXN1bHRbaW5kZXhdLCBpdGVyYWJsZVtpbmRleF0pIDogaXRlcmFibGVbaW5kZXhdOwogICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjbG9uZSBvZiBgdmFsdWVgLiBJZiBgZGVlcGAgaXMgYHRydWVgIG5lc3RlZCBvYmplY3RzIHdpbGwgYWxzbwogICAgICogYmUgY2xvbmVkLCBvdGhlcndpc2UgdGhleSB3aWxsIGJlIGFzc2lnbmVkIGJ5IHJlZmVyZW5jZS4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCB0byBwcm9kdWNlIHRoZSBjbG9uZWQgdmFsdWVzLiBJZiB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgY2xvbmluZyB3aWxsIGJlIGhhbmRsZWQgYnkgdGhlIG1ldGhvZCBpbnN0ZWFkLgogICAgICogVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDsgKHZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNsb25lLgogICAgICogQHBhcmFtIHtib29sZWFufSBbZGVlcD1mYWxzZV0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBzdG9vZ2VzID0gWwogICAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIHNoYWxsb3cgPSBfLmNsb25lKHN0b29nZXMpOwogICAgICogc2hhbGxvd1swXSA9PT0gc3Rvb2dlc1swXTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgZGVlcCA9IF8uY2xvbmUoc3Rvb2dlcywgdHJ1ZSk7CiAgICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLm1peGluKHsKICAgICAqICAgJ2Nsb25lJzogXy5wYXJ0aWFsUmlnaHQoXy5jbG9uZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgICByZXR1cm4gXy5pc0VsZW1lbnQodmFsdWUpID8gdmFsdWUuY2xvbmVOb2RlKGZhbHNlKSA6IHVuZGVmaW5lZDsKICAgICAqICAgfSkKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBjbG9uZSA9IF8uY2xvbmUoZG9jdW1lbnQuYm9keSk7CiAgICAgKiBjbG9uZS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAqIC8vID0+IDAKICAgICAqLwogICAgZnVuY3Rpb24gY2xvbmUodmFsdWUsIGRlZXAsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggIkNvbGxlY3Rpb25zIiBtZXRob2RzIHdpdGhvdXQgdXNpbmcgdGhlaXIgYGluZGV4YAogICAgICAvLyBhbmQgYGNvbGxlY3Rpb25gIGFyZ3VtZW50cyBmb3IgYGRlZXBgIGFuZCBgY2FsbGJhY2tgCiAgICAgIGlmICh0eXBlb2YgZGVlcCAhPSAnYm9vbGVhbicgJiYgZGVlcCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gZGVlcDsKICAgICAgICBkZWVwID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2VDbG9uZSh2YWx1ZSwgZGVlcCwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjbG9uZSBvZiBgdmFsdWVgLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUKICAgICAqIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIGNsb25lZCB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgCiAgICAgKiBjbG9uaW5nIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIGxvb3NlbHkgYmFzZWQgb24gdGhlIHN0cnVjdHVyZWQgY2xvbmUgYWxnb3JpdGhtLiBGdW5jdGlvbnMKICAgICAqIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kCiAgICAgKiBvYmplY3RzIGNyZWF0ZWQgYnkgY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiB2YXIgZGVlcCA9IF8uY2xvbmVEZWVwKHN0b29nZXMpOwogICAgICogZGVlcFswXSA9PT0gc3Rvb2dlc1swXTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIHZpZXcgPSB7CiAgICAgKiAgICdsYWJlbCc6ICdkb2NzJywKICAgICAqICAgJ25vZGUnOiBlbGVtZW50CiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBjbG9uZSA9IF8uY2xvbmVEZWVwKHZpZXcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgIHJldHVybiBfLmlzRWxlbWVudCh2YWx1ZSkgPyB2YWx1ZS5jbG9uZU5vZGUodHJ1ZSkgOiB1bmRlZmluZWQ7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBjbG9uZS5ub2RlID09IHZpZXcubm9kZTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lRGVlcCh2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGJhc2VDbG9uZSh2YWx1ZSwgdHJ1ZSwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgZGVzdGluYXRpb24KICAgICAqIG9iamVjdCBmb3IgYWxsIGRlc3RpbmF0aW9uIHByb3BlcnRpZXMgdGhhdCByZXNvbHZlIHRvIGB1bmRlZmluZWRgLiBPbmNlIGEKICAgICAqIHByb3BlcnR5IGlzIHNldCwgYWRkaXRpb25hbCBkZWZhdWx0cyBvZiB0aGUgc2FtZSBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IFtzb3VyY2VdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBBbGxvd3Mgd29ya2luZyB3aXRoIGBfLnJlZHVjZWAgd2l0aG91dCB1c2luZyBpdHMKICAgICAqICBga2V5YCBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBmb29kID0geyAnbmFtZSc6ICdhcHBsZScgfTsKICAgICAqIF8uZGVmYXVsdHMoZm9vZCwgeyAnbmFtZSc6ICdiYW5hbmEnLCAndHlwZSc6ICdmcnVpdCcgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2FwcGxlJywgJ3R5cGUnOiAnZnJ1aXQnIH0KICAgICAqLwogICAgdmFyIGRlZmF1bHRzID0gZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UsIGd1YXJkKSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBvYmplY3QsIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIGFyZ3NJbmRleCA9IDAsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gdHlwZW9mIGd1YXJkID09ICdudW1iZXInID8gMiA6IGFyZ3MubGVuZ3RoOwogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgaXRlcmFibGUgPSBhcmdzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGl0ZXJhYmxlICYmIG9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHsKICAgICAgICB2YXIgb3duSW5kZXggPSAtMSwKICAgICAgICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdICYmIGtleXMoaXRlcmFibGUpLAogICAgICAgICAgICBsZW5ndGggPSBvd25Qcm9wcyA/IG93blByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK293bkluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTsKICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0W2luZGV4XSA9PSAndW5kZWZpbmVkJykgcmVzdWx0W2luZGV4XSA9IGl0ZXJhYmxlW2luZGV4XTsKICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRJbmRleGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUga2V5IG9mIHRoZQogICAgICogZmlyc3QgZWxlbWVudCB0aGF0IHBhc3NlcyB0aGUgY2FsbGJhY2sgY2hlY2ssIGluc3RlYWQgb2YgdGhlIGVsZW1lbnQgaXRzZWxmLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlcgogICAgICogIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8KICAgICAqICBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd8dW5kZWZpbmVkfSBSZXR1cm5zIHRoZSBrZXkgb2YgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZEtleSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMsICdkJzogNCB9LCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSAlIDIgPT0gMDsKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2InIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kS2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRLZXlgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0S2V5KHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMywgJ2QnOiA0IH0sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICUgMiA9PSAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiByZXR1cm5zIGBjYCwgYXNzdW1pbmcgYF8uZmluZEtleWAgcmV0dXJucyBgYWAKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3RLZXkob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGZvck93blJpZ2h0KG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LAogICAgICogZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQKICAgICAqIGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRG9nKG5hbWUpIHsKICAgICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ1dvb2YsIHdvb2YhJyk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW4obmV3IERvZygnRGFnbnknKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICogICBjb25zb2xlLmxvZyhrZXkpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBsb2dzICdiYXJrJyBhbmQgJ25hbWUnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9ySW4gPSBmdW5jdGlvbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gY29sbGVjdGlvbiwgcmVzdWx0ID0gaXRlcmFibGU7CiAgICAgIGlmICghaXRlcmFibGUpIHJldHVybiByZXN1bHQ7CiAgICAgIGlmICghb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSkgcmV0dXJuIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyA/IGNhbGxiYWNrIDogYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICBmb3IgKGluZGV4IGluIGl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9ySW5gIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRG9nKG5hbWUpIHsKICAgICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ1dvb2YsIHdvb2YhJyk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW5SaWdodChuZXcgRG9nKCdEYWdueScpLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ25hbWUnIGFuZCAnYmFyaycgYXNzdW1pbmcgYF8uZm9ySW4gYCBsb2dzICdiYXJrJyBhbmQgJ25hbWUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckluUmlnaHQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcGFpcnMgPSBbXTsKCiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHBhaXJzLnB1c2goa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBpZiAoY2FsbGJhY2socGFpcnNbbGVuZ3RoLS1dLCBwYWlyc1tsZW5ndGhdLCBvYmplY3QpID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LCBleGVjdXRpbmcgdGhlIGNhbGxiYWNrCiAgICAgKiBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5CiAgICAgKiBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mb3JPd24oeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9yT3duID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIW9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHJldHVybiByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yT3duYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yT3duUmlnaHQoeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnbGVuZ3RoJywgJzEnLCBhbmQgJzAnIGFzc3VtaW5nIGBfLmZvck93bmAgbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvck93blJpZ2h0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbbGVuZ3RoXTsKICAgICAgICBpZiAoY2FsbGJhY2sob2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLAogICAgICogb3duIGFuZCBpbmhlcml0ZWQsIG9mIGBvYmplY3RgIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBtZXRob2RzCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mdW5jdGlvbnMoXyk7CiAgICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgICAqLwogICAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBgcHJvcGVydHlgIGV4aXN0cyBhbmQgaXMgYSBkaXJlY3QgcHJvcGVydHksCiAgICAgKiBpbnN0ZWFkIG9mIGFuIGluaGVyaXRlZCBwcm9wZXJ0eS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gY2hlY2sgZm9yLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaGFzKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgcmV0dXJuIG9iamVjdCA/IGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSkgOiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBpbnZlcnRlZCBrZXlzIGFuZCB2YWx1ZXMgb2YgdGhlIGdpdmVuIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjcmVhdGVkIGludmVydGVkIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogIF8uaW52ZXJ0KHsgJ2ZpcnN0JzogJ21vZScsICdzZWNvbmQnOiAnbGFycnknIH0pOwogICAgICogLy8gPT4geyAnbW9lJzogJ2ZpcnN0JywgJ2xhcnJ5JzogJ3NlY29uZCcgfQogICAgICovCiAgICBmdW5jdGlvbiBpbnZlcnQob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSB7fTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICByZXN1bHRbb2JqZWN0W2tleV1dID0ga2V5OwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Jvb2xlYW4obnVsbCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlIHx8IHZhbHVlID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBib29sQ2xhc3M7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGRhdGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGRhdGUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0RhdGUobmV3IERhdGUpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBkYXRlQ2xhc3MpIDogZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRWxlbWVudChkb2N1bWVudC5ib2R5KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IHZhbHVlLm5vZGVUeXBlID09PSAxIDogZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBlbXB0eS4gQXJyYXlzLCBzdHJpbmdzLCBvciBgYXJndW1lbnRzYCBvYmplY3RzIHdpdGggYQogICAgICogbGVuZ3RoIG9mIGAwYCBhbmQgb2JqZWN0cyB3aXRoIG5vIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGNvbnNpZGVyZWQKICAgICAqICJlbXB0eSIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGVtcHR5LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbXB0eShbMSwgMiwgM10pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoe30pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNFbXB0eSgnJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKHZhbHVlKSwKICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKCiAgICAgIGlmICgoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MgfHwgY2xhc3NOYW1lID09IHN0cmluZ0NsYXNzIHx8IGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MgKSB8fAogICAgICAgICAgKGNsYXNzTmFtZSA9PSBvYmplY3RDbGFzcyAmJiB0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInICYmIGlzRnVuY3Rpb24odmFsdWUuc3BsaWNlKSkpIHsKICAgICAgICByZXR1cm4gIWxlbmd0aDsKICAgICAgfQogICAgICBmb3JPd24odmFsdWUsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAocmVzdWx0ID0gZmFsc2UpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFBlcmZvcm1zIGEgZGVlcCBjb21wYXJpc29uIGJldHdlZW4gdHdvIHZhbHVlcyB0byBkZXRlcm1pbmUgaWYgdGhleSBhcmUKICAgICAqIGVxdWl2YWxlbnQgdG8gZWFjaCBvdGhlci4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkCiAgICAgKiB0byBjb21wYXJlIHZhbHVlcy4gSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgY29tcGFyaXNvbnMgd2lsbAogICAgICogYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czsgKGEsIGIpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdmFsdWVzIGFyZSBlcXVpdmFsZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICogdmFyIGNvcHkgPSB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICoKICAgICAqIG1vZSA9PSBjb3B5OwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRXF1YWwobW9lLCBjb3B5KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgd29yZHMgPSBbJ2hlbGxvJywgJ2dvb2RieWUnXTsKICAgICAqIHZhciBvdGhlcldvcmRzID0gWydoaScsICdnb29kYnllJ107CiAgICAgKgogICAgICogXy5pc0VxdWFsKHdvcmRzLCBvdGhlcldvcmRzLCBmdW5jdGlvbihhLCBiKSB7CiAgICAgKiAgIHZhciByZUdyZWV0ID0gL14oPzpoZWxsb3xoaSkkL2ksCiAgICAgKiAgICAgICBhR3JlZXQgPSBfLmlzU3RyaW5nKGEpICYmIHJlR3JlZXQudGVzdChhKSwKICAgICAqICAgICAgIGJHcmVldCA9IF8uaXNTdHJpbmcoYikgJiYgcmVHcmVldC50ZXN0KGIpOwogICAgICoKICAgICAqICAgcmV0dXJuIChhR3JlZXQgfHwgYkdyZWV0KSA/IChhR3JlZXQgPT0gYkdyZWV0KSA6IHVuZGVmaW5lZDsKICAgICAqIH0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VxdWFsKGEsIGIsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBiYXNlSXNFcXVhbChhLCBiLCB0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJyAmJiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDIpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzLCBvciBjYW4gYmUgY29lcmNlZCB0bywgYSBmaW5pdGUgbnVtYmVyLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNGaW5pdGVgIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICAgKiBib29sZWFucyBhbmQgZW1wdHkgc3RyaW5ncy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMS4yLjUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBmaW5pdGUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSgtMTAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKCcxMCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUodHJ1ZSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoJycpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKEluZmluaXR5KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRmluaXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiBuYXRpdmVJc0Zpbml0ZSh2YWx1ZSkgJiYgIW5hdGl2ZUlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGZ1bmN0aW9uLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNGdW5jdGlvbihfKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbic7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyB0aGUgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QuCiAgICAgKiAoZS5nLiBhcnJheXMsIGZ1bmN0aW9ucywgb2JqZWN0cywgcmVnZXhlcywgYG5ldyBOdW1iZXIoMClgLCBhbmQgYG5ldyBTdHJpbmcoJycpYCkKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KHt9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc09iamVjdCgxKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIC8vIGNoZWNrIGlmIHRoZSB2YWx1ZSBpcyB0aGUgRUNNQVNjcmlwdCBsYW5ndWFnZSB0eXBlIG9mIE9iamVjdAogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDgKICAgICAgLy8gYW5kIGF2b2lkIGEgVjggYnVnCiAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIyOTEKICAgICAgcmV0dXJuICEhKHZhbHVlICYmIG9iamVjdFR5cGVzW3R5cGVvZiB2YWx1ZV0pOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc05hTmAgd2hpY2ggd2lsbCByZXR1cm4gYHRydWVgIGZvcgogICAgICogYHVuZGVmaW5lZGAgYW5kIG90aGVyIG5vbi1udW1lcmljIHZhbHVlcy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMS4yLjQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgTmFOYCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTmFOKE5hTik7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc05hTihuZXcgTnVtYmVyKE5hTikpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIGlzTmFOKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc05hTih1bmRlZmluZWQpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNOYU4odmFsdWUpIHsKICAgICAgLy8gYE5hTmAgYXMgYSBwcmltaXRpdmUgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBpcyBub3QgZXF1YWwgdG8gaXRzZWxmCiAgICAgIC8vIChwZXJmb3JtIHRoZSBbW0NsYXNzXV0gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZSBob3N0IG9iamVjdHMgaW4gSUUpCiAgICAgIHJldHVybiBpc051bWJlcih2YWx1ZSkgJiYgdmFsdWUgIT0gK3ZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOdWxsKG51bGwpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNOdWxsKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBudW1iZXIuCiAgICAgKgogICAgICogTm90ZTogYE5hTmAgaXMgY29uc2lkZXJlZCBhIG51bWJlci4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4OC41LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBudW1iZXIsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc051bWJlcig4LjQgKiA1KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIG9iamVjdCBjcmVhdGVkIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3Rvci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gU3Rvb2dlKG5hbWUsIGFnZSkgewogICAgICogICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICogICB0aGlzLmFnZSA9IGFnZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFN0b29nZSgnbW9lJywgNDApKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNQbGFpbk9iamVjdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgdmFyIGlzUGxhaW5PYmplY3QgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoISh2YWx1ZSAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBvYmplY3RDbGFzcykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIHZhbHVlT2YgPSB2YWx1ZS52YWx1ZU9mLAogICAgICAgICAgb2JqUHJvdG8gPSB0eXBlb2YgdmFsdWVPZiA9PSAnZnVuY3Rpb24nICYmIChvYmpQcm90byA9IGdldFByb3RvdHlwZU9mKHZhbHVlT2YpKSAmJiBnZXRQcm90b3R5cGVPZihvYmpQcm90byk7CgogICAgICByZXR1cm4gb2JqUHJvdG8KICAgICAgICA/ICh2YWx1ZSA9PSBvYmpQcm90byB8fCBnZXRQcm90b3R5cGVPZih2YWx1ZSkgPT0gb2JqUHJvdG8pCiAgICAgICAgOiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzUmVnRXhwKC9tb2UvKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzcykgOiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1N0cmluZygnbW9lJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gc3RyaW5nQ2xhc3M7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNVbmRlZmluZWQodm9pZCAwKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzsKICAgIH0KCiAgICAvKioKICAgICAqIFJlY3Vyc2l2ZWx5IG1lcmdlcyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHRoZSBzb3VyY2Ugb2JqZWN0KHMpLCB0aGF0CiAgICAgKiBkb24ndCByZXNvbHZlIHRvIGB1bmRlZmluZWRgIGludG8gdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzCiAgICAgKiB3aWxsIG92ZXJ3cml0ZSBwcm9wZXJ0eSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyBzb3VyY2VzLiBJZiBhIGNhbGxiYWNrIGlzCiAgICAgKiBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIG1lcmdlZCB2YWx1ZXMgb2YgdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBhbmQgc291cmNlIHByb3BlcnRpZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIG1lcmdpbmcgd2lsbAogICAgICogYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czsgKG9iamVjdFZhbHVlLCBzb3VyY2VWYWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZV0gVGhlIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIG1lcmdpbmcgcHJvcGVydGllcy4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgbmFtZXMgPSB7CiAgICAgKiAgICdzdG9vZ2VzJzogWwogICAgICogICAgIHsgJ25hbWUnOiAnbW9lJyB9LAogICAgICogICAgIHsgJ25hbWUnOiAnbGFycnknIH0KICAgICAqICAgXQogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgYWdlcyA9IHsKICAgICAqICAgJ3N0b29nZXMnOiBbCiAgICAgKiAgICAgeyAnYWdlJzogNDAgfSwKICAgICAqICAgICB7ICdhZ2UnOiA1MCB9CiAgICAgKiAgIF0KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShuYW1lcywgYWdlcyk7CiAgICAgKiAvLyA9PiB7ICdzdG9vZ2VzJzogW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0gfQogICAgICoKICAgICAqIHZhciBmb29kID0gewogICAgICogICAnZnJ1aXRzJzogWydhcHBsZSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnYmVldCddCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBvdGhlckZvb2QgPSB7CiAgICAgKiAgICdmcnVpdHMnOiBbJ2JhbmFuYSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnY2Fycm90J10KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShmb29kLCBvdGhlckZvb2QsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgcmV0dXJuIF8uaXNBcnJheShhKSA/IGEuY29uY2F0KGIpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdmcnVpdHMnOiBbJ2FwcGxlJywgJ2JhbmFuYSddLCAndmVnZXRhYmxlcyc6IFsnYmVldCcsICdjYXJyb3RdIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0KSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gMjsKCiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0KICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIGFuZCBgXy5yZWR1Y2VSaWdodGAgd2l0aG91dCB1c2luZwogICAgICAvLyB0aGVpciBgaW5kZXhgIGFuZCBgY29sbGVjdGlvbmAgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgYXJnc1syXSAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2xlbmd0aCAtIDJdID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soYXJnc1stLWxlbmd0aCAtIDFdLCBhcmdzW2xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiB0eXBlb2YgYXJnc1tsZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tbGVuZ3RoXTsKICAgICAgfQogICAgICB2YXIgc291cmNlcyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxLCBsZW5ndGgpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIHN0YWNrQSA9IGdldEFycmF5KCksCiAgICAgICAgICBzdGFja0IgPSBnZXRBcnJheSgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBiYXNlTWVyZ2Uob2JqZWN0LCBzb3VyY2VzW2luZGV4XSwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgfQogICAgICByZWxlYXNlQXJyYXkoc3RhY2tBKTsKICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQik7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBleGNsdWRpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YKICAgICAqIHByb3BlcnR5IG5hbWVzLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2gKICAgICAqIHByb3BlcnR5IG9mIGBvYmplY3RgIG9taXR0aW5nIHRoZSBwcm9wZXJ0aWVzIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5CiAgICAgKiBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufC4uLnN0cmluZ3xzdHJpbmdbXX0gW2NhbGxiYWNrXSBUaGUgcHJvcGVydGllcyB0byBvbWl0IG9yIHRoZQogICAgICogIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCB3aXRob3V0IHRoZSBvbWl0dGVkIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LCAnYWdlJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICovCiAgICBmdW5jdGlvbiBvbWl0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJywKICAgICAgICAgIHJlc3VsdCA9IHt9OwoKICAgICAgaWYgKGlzRnVuYykgewogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKTsKICAgICAgfQogICAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChpc0Z1bmMKICAgICAgICAgICAgICA/ICFjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpCiAgICAgICAgICAgICAgOiBpbmRleE9mKHByb3BzLCBrZXkpIDwgMAogICAgICAgICAgICApIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSB0d28gZGltZW5zaW9uYWwgYXJyYXkgb2YgYW4gb2JqZWN0J3Mga2V5LXZhbHVlIHBhaXJzLAogICAgICogaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgbmV3IGFycmF5IG9mIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5wYWlycyh7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAgfSk7CiAgICAgKiAvLyA9PiBbWydtb2UnLCAzMF0sIFsnbGFycnknLCA0MF1dIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBwYWlycyhvYmplY3QpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IFtrZXksIG9iamVjdFtrZXldXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgY29tcG9zZWQgb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YKICAgICAqIHByb3BlcnR5IG5hbWVzLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2gKICAgICAqIHByb3BlcnR5IG9mIGBvYmplY3RgIHBpY2tpbmcgdGhlIHByb3BlcnRpZXMgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkKICAgICAqIGZvci4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258Li4uc3RyaW5nfHN0cmluZ1tdfSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyCiAgICAgKiAgaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWVzIHRvIHBpY2ssIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIHByb3BlcnR5CiAgICAgKiAgbmFtZXMgb3IgYXJyYXlzIG9mIHByb3BlcnR5IG5hbWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sICduYW1lJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICoKICAgICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAqICAgcmV0dXJuIGtleS5jaGFyQXQoMCkgIT0gJ18nOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICovCiAgICBmdW5jdGlvbiBwaWNrKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSwKICAgICAgICAgICAgbGVuZ3RoID0gaXNPYmplY3Qob2JqZWN0KSA/IHByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgcmVzdWx0W2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbiBhbHRlcm5hdGl2ZSB0byBgXy5yZWR1Y2VgIHRoaXMgbWV0aG9kIHRyYW5zZm9ybXMgYG9iamVjdGAgdG8gYSBuZXcKICAgICAqIGBhY2N1bXVsYXRvcmAgb2JqZWN0IHdoaWNoIGlzIHRoZSByZXN1bHQgb2YgcnVubmluZyBlYWNoIG9mIGl0cyBlbGVtZW50cwogICAgICogdGhyb3VnaCBhIGNhbGxiYWNrLCB3aXRoIGVhY2ggY2FsbGJhY2sgZXhlY3V0aW9uIHBvdGVudGlhbGx5IG11dGF0aW5nCiAgICAgKiB0aGUgYGFjY3VtdWxhdG9yYCBvYmplY3QuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggZm91ciBhcmd1bWVudHM7IChhY2N1bXVsYXRvciwgdmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0CiAgICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIFRoZSBjdXN0b20gYWNjdW11bGF0b3IgdmFsdWUuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHNxdWFyZXMgPSBfLnRyYW5zZm9ybShbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdLCBmdW5jdGlvbihyZXN1bHQsIG51bSkgewogICAgICogICBudW0gKj0gbnVtOwogICAgICogICBpZiAobnVtICUgMikgewogICAgICogICAgIHJldHVybiByZXN1bHQucHVzaChudW0pIDwgMzsKICAgICAqICAgfQogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMSwgOSwgMjVdCiAgICAgKgogICAgICogdmFyIG1hcHBlZCA9IF8udHJhbnNmb3JtKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMyB9LCBmdW5jdGlvbihyZXN1bHQsIG51bSwga2V5KSB7CiAgICAgKiAgIHJlc3VsdFtrZXldID0gbnVtICogMzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnYSc6IDMsICdiJzogNiwgJ2MnOiA5IH0KICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmb3JtKG9iamVjdCwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpc0FyciA9IGlzQXJyYXkob2JqZWN0KTsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDQpOwoKICAgICAgaWYgKGFjY3VtdWxhdG9yID09IG51bGwpIHsKICAgICAgICBpZiAoaXNBcnIpIHsKICAgICAgICAgIGFjY3VtdWxhdG9yID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdG9yID0gb2JqZWN0ICYmIG9iamVjdC5jb25zdHJ1Y3RvciwKICAgICAgICAgICAgICBwcm90byA9IGN0b3IgJiYgY3Rvci5wcm90b3R5cGU7CgogICAgICAgICAgYWNjdW11bGF0b3IgPSBjcmVhdGVPYmplY3QocHJvdG8pOwogICAgICAgIH0KICAgICAgfQogICAgICAoaXNBcnIgPyBmb3JFYWNoIDogZm9yT3duKShvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbXBvc2VkIG9mIHRoZSBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSB2YWx1ZXMgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udmFsdWVzKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAgICogLy8gPT4gWzEsIDIsIDNdIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiB2YWx1ZXMob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gb2JqZWN0W3Byb3BzW2luZGV4XV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMgZnJvbSB0aGUgc3BlY2lmaWVkIGluZGV4ZXMsIG9yIGtleXMsIG9mIHRoZQogICAgICogYGNvbGxlY3Rpb25gLiBJbmRleGVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICAgKiBvZiBpbmRleGVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0gey4uLihudW1iZXJ8bnVtYmVyW118c3RyaW5nfHN0cmluZ1tdKX0gW2luZGV4XSBUaGUgaW5kZXhlcyBvZiBgY29sbGVjdGlvbmAKICAgICAqICAgdG8gcmV0cmlldmUsIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGluZGV4ZXMgb3IgYXJyYXlzIG9mIGluZGV4ZXMuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgY29ycmVzcG9uZGluZyB0byB0aGUKICAgICAqICBwcm92aWRlZCBpbmRleGVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmF0KFsnYScsICdiJywgJ2MnLCAnZCcsICdlJ10sIFswLCAyLCA0XSk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYycsICdlJ10KICAgICAqCiAgICAgKiBfLmF0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIDAsIDIpOwogICAgICogLy8gPT4gWydtb2UnLCAnY3VybHknXQogICAgICovCiAgICBmdW5jdGlvbiBhdChjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0gYmFzZUZsYXR0ZW4oYXJncywgdHJ1ZSwgZmFsc2UsIDEpLAogICAgICAgICAgbGVuZ3RoID0gKGFyZ3NbMl0gJiYgYXJnc1syXVthcmdzWzFdXSA9PT0gY29sbGVjdGlvbikgPyAxIDogcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY29sbGVjdGlvbltwcm9wc1tpbmRleF1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYSBnaXZlbiB2YWx1ZSBpcyBwcmVzZW50IGluIGEgY29sbGVjdGlvbiB1c2luZyBzdHJpY3QgZXF1YWxpdHkKICAgICAqIGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQgYXMgdGhlCiAgICAgKiBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgaW5jbHVkZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsqfSB0YXJnZXQgVGhlIHZhbHVlIHRvIGNoZWNrIGZvci4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHRhcmdldGAgZWxlbWVudCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5jb250YWlucyhbMSwgMiwgM10sIDEsIDIpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sICdtb2UnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKCdjdXJseScsICd1cicpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHJlc3VsdCA9IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpID4gLTE7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHJlc3VsdCA9IChpc1N0cmluZyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSkgPiAtMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICgrK2luZGV4ID49IGZyb21JbmRleCkgewogICAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IHdhcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2suCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiAyLCAnNSc6IDEgfQogICAgICovCiAgICB2YXIgY291bnRCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YKICAgICAqIGEgY29sbGVjdGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGFsbAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddLCBCb29sZWFuKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmV2ZXJ5KHN0b29nZXMsICdhZ2UnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmV2ZXJ5KHN0b29nZXMsIHsgJ2FnZSc6IDUwIH0pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gZXZlcnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9ICEhY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiAocmVzdWx0ID0gISFjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyBhbiBhcnJheSBvZiBhbGwgZWxlbWVudHMKICAgICAqIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvci4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIHNlbGVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgcGFzc2VkIHRoZSBjYWxsYmFjayBjaGVjay4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGV2ZW5zID0gXy5maWx0ZXIoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICAgKiAvLyA9PiBbMiwgNCwgNl0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdhcHBsZScsICAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUsICAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maWx0ZXIoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2NhcnJvdCcsICdvcmdhbmljJzogdHJ1ZSwgJ3R5cGUnOiAndmVnZXRhYmxlJyB9XQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmlsdGVyKGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYXBwbGUnLCAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyB0aGUgZmlyc3QgZWxlbWVudCB0aGF0CiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkZXRlY3QsIGZpbmRXaGVyZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZChbMSwgMiwgMywgNF0sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICUgMiA9PSAwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlLCAgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZChmb29kLCB7ICd0eXBlJzogJ3ZlZ2V0YWJsZScgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2JlZXQnLCAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmQoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlLCAndHlwZSc6ICdmcnVpdCcgfQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0KFsxLCAyLCAzLCA0XSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gJSAyID09IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDMKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3QoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVsZW1lbnRzIG9mIGEgY29sbGVjdGlvbiwgZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaAogICAgICogZWxlbWVudC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieQogICAgICogZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGVhY2gKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fHN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS5mb3JFYWNoKGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KS5qb2luKCcsJyk7CiAgICAgKiAvLyA9PiBsb2dzIGVhY2ggbnVtYmVyIGFuZCByZXR1cm5zICcxLDIsMycKICAgICAqCiAgICAgKiBfLmZvckVhY2goeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IGNvbnNvbGUubG9nKG51bSk7IH0pOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBhbmQgcmV0dXJucyB0aGUgb2JqZWN0IChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGNhbGxiYWNrKTsKICAgICAgfQogICAgICByZXR1cm4gY29sbGVjdGlvbjsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yRWFjaGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZWFjaFJpZ2h0CiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxzdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzXSkuZm9yRWFjaFJpZ2h0KGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KS5qb2luKCcsJyk7CiAgICAgKiAvLyA9PiBsb2dzIGVhY2ggbnVtYmVyIGZyb20gcmlnaHQgdG8gbGVmdCBhbmQgcmV0dXJucyAnMywyLDEnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckVhY2hSaWdodChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyA/IGNhbGxiYWNrIDogYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2xlbmd0aF0sIGxlbmd0aCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJvcHMgPSBrZXlzKGNvbGxlY3Rpb24pOwogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICAgICAga2V5ID0gcHJvcHMgPyBwcm9wc1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhjb2xsZWN0aW9uW2tleV0sIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiBrZXlzIGdlbmVyYXRlZCBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBvZiBhIGNvbGxlY3Rpb24gdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoZSBjb3JyZXNwb25kaW5nIHZhbHVlCiAgICAgKiBvZiBlYWNoIGtleSBpcyBhbiBhcnJheSBvZiB0aGUgZWxlbWVudHMgcmVzcG9uc2libGUgZm9yIGdlbmVyYXRpbmcgdGhlIGtleS4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAgICogLy8gPT4geyAnNCc6IFs0LjJdLCAnNic6IFs2LjEsIDYuNF0gfQogICAgICoKICAgICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmdyb3VwQnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiBbJ29uZScsICd0d28nXSwgJzUnOiBbJ3RocmVlJ10gfQogICAgICovCiAgICB2YXIgZ3JvdXBCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogcmVzdWx0W2tleV0gPSBbXSkucHVzaCh2YWx1ZSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgZ2VuZXJhdGVkIGZyb20gdGhlIHJlc3VsdHMgb2YgcnVubmluZwogICAgICogZWFjaCBlbGVtZW50IG9mIHRoZSBjb2xsZWN0aW9uIHRocm91Z2ggdGhlIGdpdmVuIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZwogICAgICogdmFsdWUgb2YgZWFjaCBrZXkgaXMgdGhlIGxhc3QgZWxlbWVudCByZXNwb25zaWJsZSBmb3IgZ2VuZXJhdGluZyB0aGUga2V5LgogICAgICogVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGtleXMgPSBbCiAgICAgKiAgIHsgJ2Rpcic6ICdsZWZ0JywgJ2NvZGUnOiA5NyB9LAogICAgICogICB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uaW5kZXhCeShrZXlzLCAnZGlyJyk7CiAgICAgKiAvLyA9PiB7ICdsZWZ0JzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdyaWdodCc6IHsgJ2Rpcic6ICdyaWdodCcsICdjb2RlJzogMTAwIH0gfQogICAgICoKICAgICAqIF8uaW5kZXhCeShrZXlzLCBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoa2V5LmNvZGUpOyB9KTsKICAgICAqIC8vID0+IHsgJ2EnOiB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwgJ2QnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqCiAgICAgKiBfLmluZGV4Qnkoc3Rvb2dlcywgZnVuY3Rpb24oa2V5KSB7IHRoaXMuZnJvbUNoYXJDb2RlKGtleS5jb2RlKTsgfSwgU3RyaW5nKTsKICAgICAqIC8vID0+IHsgJ2EnOiB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwgJ2QnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqLwogICAgdmFyIGluZGV4QnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBJbnZva2VzIHRoZSBtZXRob2QgbmFtZWQgYnkgYG1ldGhvZE5hbWVgIG9uIGVhY2ggZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gCiAgICAgKiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgICAqIHdpbGwgYmUgcHJvdmlkZWQgdG8gZWFjaCBpbnZva2VkIG1ldGhvZC4gSWYgYG1ldGhvZE5hbWVgIGlzIGEgZnVuY3Rpb24gaXQKICAgICAqIHdpbGwgYmUgaW52b2tlZCBmb3IsIGFuZCBgdGhpc2AgYm91bmQgdG8sIGVhY2ggZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gbWV0aG9kTmFtZSBUaGUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIGludm9rZSBvcgogICAgICogIHRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIG1ldGhvZCB3aXRoLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW52b2tlKFtbNSwgMSwgN10sIFszLCAyLCAxXV0sICdzb3J0Jyk7CiAgICAgKiAvLyA9PiBbWzEsIDUsIDddLCBbMSwgMiwgM11dCiAgICAgKgogICAgICogXy5pbnZva2UoWzEyMywgNDU2XSwgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCwgJycpOwogICAgICogLy8gPT4gW1snMScsICcyJywgJzMnXSwgWyc0JywgJzUnLCAnNiddXQogICAgICovCiAgICBmdW5jdGlvbiBpbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICB2YXIgYXJncyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXN1bHRbKytpbmRleF0gPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IHZhbHVlW21ldGhvZE5hbWVdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gdGhlIGNvbGxlY3Rpb24KICAgICAqIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgY29sbGVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWFwKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgICAqIC8vID0+IFszLCA2LCA5XQogICAgICoKICAgICAqIF8ubWFwKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogMzsgfSk7CiAgICAgKiAvLyA9PiBbMywgNiwgOV0gKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1hcChzdG9vZ2VzLCAnbmFtZScpOwogICAgICogLy8gPT4gWydtb2UnLCAnbGFycnknXQogICAgICovCiAgICBmdW5jdGlvbiBtYXAoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHZhciByZXN1bHQgPSBBcnJheShsZW5ndGgpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgdGhlIG1heGltdW0gdmFsdWUgb2YgYSBjb2xsZWN0aW9uLiBJZiB0aGUgY29sbGVjdGlvbiBpcyBlbXB0eSBvcgogICAgICogZmFsc2V5IGAtSW5maW5pdHlgIGlzIHJldHVybmVkLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQKICAgICAqIGZvciBlYWNoIHZhbHVlIGluIHRoZSBjb2xsZWN0aW9uIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlCiAgICAgKiBpcyByYW5rZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWF4KFs0LCAyLCA4LCA2XSk7CiAgICAgKiAvLyA9PiA4CiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1heChzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWF4KHN0b29nZXMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfTsKICAgICAqLwogICAgZnVuY3Rpb24gbWF4KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBjb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgICAgaWYgKCFjYWxsYmFjayAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrID0gKCFjYWxsYmFjayAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkKICAgICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICAgIDogbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICAgIGlmIChjdXJyZW50ID4gY29tcHV0ZWQpIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBtaW5pbXVtIHZhbHVlIG9mIGEgY29sbGVjdGlvbi4gSWYgdGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkgb3IKICAgICAqIGZhbHNleSBgSW5maW5pdHlgIGlzIHJldHVybmVkLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQKICAgICAqIGZvciBlYWNoIHZhbHVlIGluIHRoZSBjb2xsZWN0aW9uIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlCiAgICAgKiBpcyByYW5rZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1pbmltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWluKFs0LCAyLCA4LCA2XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1pbihzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1pbihzdG9vZ2VzLCAnYWdlJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICovCiAgICBmdW5jdGlvbiBtaW4oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9ICghY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpCiAgICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgICA6IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgICBpZiAoY3VycmVudCA8IGNvbXB1dGVkKSB7CiAgICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgcHJvcGVydHkgZnJvbSBhbGwgZWxlbWVudHMgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8ucGx1Y2soc3Rvb2dlcywgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnbW9lJywgJ2xhcnJ5J10KICAgICAqLwogICAgZnVuY3Rpb24gcGx1Y2soY29sbGVjdGlvbiwgcHJvcGVydHkpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNvbGxlY3Rpb25baW5kZXhdW3Byb3BlcnR5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdCB8fCBtYXAoY29sbGVjdGlvbiwgcHJvcGVydHkpOwogICAgfQoKICAgIC8qKgogICAgICogUmVkdWNlcyBhIGNvbGxlY3Rpb24gdG8gYSB2YWx1ZSB3aGljaCBpcyB0aGUgYWNjdW11bGF0ZWQgcmVzdWx0IG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjaywgd2hlcmUgZWFjaCBzdWNjZXNzaXZlCiAgICAgKiBjYWxsYmFjayBleGVjdXRpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJldmlvdXMgZXhlY3V0aW9uLiBJZgogICAgICogYGFjY3VtdWxhdG9yYCBpcyBub3QgcHJvdmlkZWQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24gd2lsbCBiZQogICAgICogdXNlZCBhcyB0aGUgaW5pdGlhbCBgYWNjdW11bGF0b3JgIHZhbHVlLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICAgKiBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIHZhciBtYXBwZWQgPSBfLnJlZHVjZSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgZnVuY3Rpb24ocmVzdWx0LCBudW0sIGtleSkgewogICAgICogICByZXN1bHRba2V5XSA9IG51bSAqIDM7CiAgICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICAgKiB9LCB7fSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgICBjYWxsYmFjayA9IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICBpZiAobm9hY2N1bSkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBub2FjY3VtCiAgICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnJlZHVjZWAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZHIKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAgICogdmFyIGZsYXQgPSBfLnJlZHVjZVJpZ2h0KGxpc3QsIGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEuY29uY2F0KGIpOyB9LCBbXSk7CiAgICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVkdWNlUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CiAgICAgIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCA0KTsKICAgICAgZm9yRWFjaFJpZ2h0KGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSBlbGVtZW50cyBvZiBhCiAgICAgKiBjb2xsZWN0aW9uIHRoYXQgdGhlIGNhbGxiYWNrIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1ZXkgZm9yLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBmYWlsZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzEsIDMsIDVdCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlLCAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVqZWN0KGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdhcHBsZScsICdvcmdhbmljJzogZmFsc2UsICd0eXBlJzogJ2ZydWl0JyB9XQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVqZWN0KGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlLCAndHlwZSc6ICd2ZWdldGFibGUnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlamVjdChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuICFjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyBhIHJhbmRvbSBlbGVtZW50IG9yIGBuYCByYW5kb20gZWxlbWVudHMgZnJvbSBhIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbl0gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBzYW1wbGUuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gQWxsb3dzIHdvcmtpbmcgd2l0aCBmdW5jdGlvbnMsIGxpa2UgYF8ubWFwYCwKICAgICAqICB3aXRob3V0IHVzaW5nIHRoZWlyIGBrZXlgIGFuZCBgb2JqZWN0YCBhcmd1bWVudHMgYXMgc291cmNlcy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZG9tIHNhbXBsZShzKSBvZiBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2FtcGxlKFsxLCAyLCAzLCA0XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zYW1wbGUoWzEsIDIsIDMsIDRdLCAyKTsKICAgICAqIC8vID0+IFszLCAxXQogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGUoY29sbGVjdGlvbiwgbiwgZ3VhcmQpIHsKICAgICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoICE9ICdudW1iZXInKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlcyhjb2xsZWN0aW9uKTsKICAgICAgfQogICAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uW3JhbmRvbShsZW5ndGggLSAxKV0gOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHNodWZmbGUoY29sbGVjdGlvbik7CiAgICAgIHJlc3VsdC5sZW5ndGggPSBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCByZXN1bHQubGVuZ3RoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgdmFsdWVzLCB1c2luZyBhIHZlcnNpb24gb2YgdGhlIEZpc2hlci1ZYXRlcwogICAgICogc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgICAqLwogICAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgcmFuZCA9IHJhbmRvbSgrK2luZGV4KTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gcmVzdWx0W3JhbmRdOwogICAgICAgIHJlc3VsdFtyYW5kXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIHNpemUgb2YgdGhlIGBjb2xsZWN0aW9uYCBieSByZXR1cm5pbmcgYGNvbGxlY3Rpb24ubGVuZ3RoYCBmb3IgYXJyYXlzCiAgICAgKiBhbmQgYXJyYXktbGlrZSBvYmplY3RzIG9yIHRoZSBudW1iZXIgb2Ygb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBmb3Igb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgYGNvbGxlY3Rpb24ubGVuZ3RoYCBvciBudW1iZXIgb2Ygb3duIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaXplKFsxLCAyXSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zaXplKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8uc2l6ZSgnY3VybHknKTsKICAgICAqIC8vID0+IDUKICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZXkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICAgKiBjb2xsZWN0aW9uLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGEgcGFzc2luZyB2YWx1ZSBhbmQKICAgICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGNvbGxlY3Rpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBhbnkKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbnkgZWxlbWVudCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdhcHBsZScsICAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUsICAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5zb21lKGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5zb21lKGZvb2QsIHsgJ3R5cGUnOiAnbWVhdCcgfSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBzb21lKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmICgocmVzdWx0ID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiAhKHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMsIHNvcnRlZCBpbiBhc2NlbmRpbmcgb3JkZXIgYnkgdGhlIHJlc3VsdHMgb2YKICAgICAqIHJ1bm5pbmcgZWFjaCBlbGVtZW50IGluIGEgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjay4gVGhpcyBtZXRob2QKICAgICAqIHBlcmZvcm1zIGEgc3RhYmxlIHNvcnQsIHRoYXQgaXMsIGl0IHdpbGwgcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNvcnQgb3JkZXIKICAgICAqIG9mIGVxdWFsIGVsZW1lbnRzLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2Ygc29ydGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5zaW4obnVtKTsgfSk7CiAgICAgKiAvLyA9PiBbMywgMSwgMl0KICAgICAqCiAgICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5zaW4obnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiBbMywgMSwgMl0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnNvcnRCeShbJ2JhbmFuYScsICdzdHJhd2JlcnJ5JywgJ2FwcGxlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IFsnYXBwbGUnLCAnYmFuYW5hJywgJ3N0cmF3YmVycnknXQogICAgICovCiAgICBmdW5jdGlvbiBzb3J0QnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgb2JqZWN0ID0gcmVzdWx0WysraW5kZXhdID0gZ2V0T2JqZWN0KCk7CiAgICAgICAgb2JqZWN0LmNyaXRlcmlhID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgb2JqZWN0LmluZGV4ID0gaW5kZXg7CiAgICAgICAgb2JqZWN0LnZhbHVlID0gdmFsdWU7CiAgICAgIH0pOwoKICAgICAgbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDsKICAgICAgcmVzdWx0LnNvcnQoY29tcGFyZUFzY2VuZGluZyk7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIHZhciBvYmplY3QgPSByZXN1bHRbbGVuZ3RoXTsKICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IG9iamVjdC52YWx1ZTsKICAgICAgICByZWxlYXNlT2JqZWN0KG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgICAqIC8vID0+IFsyLCAzLCA0XQogICAgICovCiAgICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHNsaWNlKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXMoY29sbGVjdGlvbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBvZiBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAgdG8gdGhlIGdpdmVuCiAgICAgKiBgcHJvcGVydGllc2Agb2JqZWN0LCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzIHRoYXQgaGF2ZSBlcXVpdmFsZW50CiAgICAgKiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBmaWx0ZXIgYnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBnaXZlbiBwcm9wZXJ0aWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiAzMCwgJ3F1b3Rlcyc6IFsnT2gsIGEgd2lzZSBndXksIGVoPycsICdQb2lmZWN0ISddIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwLCAncXVvdGVzJzogWydTcHJlYWQgb3V0IScsICdZb3Uga251Y2tsZWhlYWQhJ10gfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ2FnZSc6IDQwIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwLCAncXVvdGVzJzogWydTcHJlYWQgb3V0IScsICdZb3Uga251Y2tsZWhlYWQhJ10gfV0KICAgICAqCiAgICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ3F1b3Rlcyc6IFsnUG9pZmVjdCEnXSB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDMwLCAncXVvdGVzJzogWydPaCwgYSB3aXNlIGd1eSwgZWg/JywgJ1BvaWZlY3QhJ10gfV0KICAgICAqLwogICAgdmFyIHdoZXJlID0gZmlsdGVyOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIHJlbW92ZWQuIFRoZSB2YWx1ZXMgYGZhbHNlYCwgYG51bGxgLAogICAgICogYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCwgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGV4Y2x1ZGluZyBhbGwgdmFsdWVzIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5XSBUaGUgYXJyYXlzIG9mIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kaWZmZXJlbmNlKFsxLCAyLCAzLCA0LCA1XSwgWzUsIDIsIDEwXSk7CiAgICAgKiAvLyA9PiBbMSwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gZGlmZmVyZW5jZShhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICBzZWVuID0gYmFzZUZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlLCB0cnVlLCAxKSwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgdmFyIGlzTGFyZ2UgPSBsZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYgaW5kZXhPZiA9PT0gYmFzZUluZGV4T2Y7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBjYWNoZSA9IGNyZWF0ZUNhY2hlKHNlZW4pOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgaW5kZXhPZiA9IGNhY2hlSW5kZXhPZjsKICAgICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAoaW5kZXhPZihzZWVuLCB2YWx1ZSkgPCAwKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgcmVsZWFzZU9iamVjdChzZWVuKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCByZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QKICAgICAqIGVsZW1lbnQgdGhhdCBwYXNzZXMgdGhlIGNhbGxiYWNrIGNoZWNrLCBpbnN0ZWFkIG9mIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZEluZGV4KFsnYXBwbGUnLCAnYmFuYW5hJywgJ2JlZXQnXSwgZnVuY3Rpb24oZm9vZCkgewogICAgICogICByZXR1cm4gL15iLy50ZXN0KGZvb2QpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRJbmRleChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRJbmRleGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5maW5kTGFzdEluZGV4KFsnYXBwbGUnLCAnYmFuYW5hJywgJ2JlZXQnXSwgZnVuY3Rpb24oZm9vZCkgewogICAgICogICByZXR1cm4gL15iLy50ZXN0KGZvb2QpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRMYXN0SW5kZXgoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKGFycmF5W2xlbmd0aF0sIGxlbmd0aCwgYXJyYXkpKSB7CiAgICAgICAgICByZXR1cm4gbGVuZ3RoOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBmaXJzdCBlbGVtZW50IG9yIGZpcnN0IGBuYCBlbGVtZW50cyBvZiBhbiBhcnJheS4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgZWxlbWVudHMgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgYXJyYXkgYXJlIHJldHVybmVkIGFzIGxvbmcKICAgICAqIGFzIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5LiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAgICogaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgaGVhZCwgdGFrZQogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmlyc3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IDEKICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPCAzOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYW5hbmEnLCAnb3JnYW5pYyc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH0sCiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmlyc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JhbmFuYScsICdvcmdhbmljJzogdHJ1ZSB9XQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2FwcGxlJywgICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JhbmFuYScsICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICd0eXBlJzogJ3ZlZ2V0YWJsZScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpcnN0KGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYXBwbGUnLCAndHlwZSc6ICdmcnVpdCcgfSwgeyAnbmFtZSc6ICdiYW5hbmEnLCAndHlwZSc6ICdmcnVpdCcgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlyc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IGNhbGxiYWNrOwogICAgICAgIGlmIChuID09IG51bGwgfHwgdGhpc0FyZykgewogICAgICAgICAgcmV0dXJuIGFycmF5ID8gYXJyYXlbMF0gOiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBuKSwgbGVuZ3RoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBGbGF0dGVucyBhIG5lc3RlZCBhcnJheSAodGhlIG5lc3RpbmcgY2FuIGJlIHRvIGFueSBkZXB0aCkuIElmIGBpc1NoYWxsb3dgCiAgICAgKiBpcyB0cnVleSwgdGhlIGFycmF5IHdpbGwgb25seSBiZSBmbGF0dGVuZWQgYSBzaW5nbGUgbGV2ZWwuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGVhY2ggZWxlbWVudCBvZiB0aGUgYXJyYXkgaXMgcGFzc2VkIHRocm91Z2ggdGhlIGNhbGxiYWNrIGJlZm9yZQogICAgICogZmxhdHRlbmluZy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NoYWxsb3c9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGEgc2luZ2xlIGxldmVsLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dKTsKICAgICAqIC8vID0+IFsxLCAyLCAzLCA0XTsKICAgICAqCiAgICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0sIHRydWUpOwogICAgICogLy8gPT4gWzEsIDIsIDMsIFtbNF1dXTsKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdxdW90ZXMnOiBbJ09oLCBhIHdpc2UgZ3V5LCBlaD8nLCAnUG9pZmVjdCEnXSB9LAogICAgICogICB7ICduYW1lJzogJ21vZScsICdxdW90ZXMnOiBbJ1NwcmVhZCBvdXQhJywgJ1lvdSBrbnVja2xlaGVhZCEnXSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmxhdHRlbihzdG9vZ2VzLCAncXVvdGVzJyk7CiAgICAgKiAvLyA9PiBbJ09oLCBhIHdpc2UgZ3V5LCBlaD8nLCAnUG9pZmVjdCEnLCAnU3ByZWFkIG91dCEnLCAnWW91IGtudWNrbGVoZWFkISddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgICBpZiAodHlwZW9mIGlzU2hhbGxvdyAhPSAnYm9vbGVhbicgJiYgaXNTaGFsbG93ICE9IG51bGwpIHsKICAgICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSAhKHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NoYWxsb3ddID09PSBhcnJheSkgPyBpc1NoYWxsb3cgOiBudWxsOwogICAgICAgIGlzU2hhbGxvdyA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgYXJyYXkgPSBtYXAoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYXJyYXkgaXMgYWxyZWFkeSBzb3J0ZWQKICAgICAqIHByb3ZpZGluZyBgdHJ1ZWAgZm9yIGBmcm9tSW5kZXhgIHdpbGwgcnVuIGEgZmFzdGVyIGJpbmFyeSBzZWFyY2guCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtib29sZWFufG51bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20gb3IgYHRydWVgCiAgICAgKiAgdG8gcGVyZm9ybSBhIGJpbmFyeSBzZWFyY2ggb24gYSBzb3J0ZWQgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSBvciBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IDEKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDEsIDIsIDIsIDMsIDNdLCAyLCB0cnVlKTsKICAgICAqIC8vID0+IDIKICAgICAqLwogICAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgdmFsdWUsIGZyb21JbmRleCkgewogICAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICAgIHZhciBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICAgICAgZnJvbUluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgbGVuZ3RoICsgZnJvbUluZGV4KSA6IGZyb21JbmRleCB8fCAwKTsKICAgICAgfSBlbHNlIGlmIChmcm9tSW5kZXgpIHsKICAgICAgICB2YXIgaW5kZXggPSBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUpOwogICAgICAgIHJldHVybiBhcnJheVtpbmRleF0gPT09IHZhbHVlID8gaW5kZXggOiAtMTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhbGwgYnV0IHRoZSBsYXN0IGVsZW1lbnQgb3IgbGFzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEKICAgICAqIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBlbmQgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tCiAgICAgKiB0aGUgcmVzdWx0IGFzIGxvbmcgYXMgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZAogICAgICogdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFjaz0xXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICoKICAgICAqIF8uaW5pdGlhbChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzFdCiAgICAgKgogICAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPiAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5pbml0aWFsKGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH1dCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9LAogICAgICogICB7ICduYW1lJzogJ2NhcnJvdCcsICd0eXBlJzogJ3ZlZ2V0YWJsZScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmluaXRpYWwoZm9vZCwgeyAndHlwZSc6ICd2ZWdldGFibGUnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluaXRpYWwoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBjYWxsYmFjayB8fCBuOwogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBsZW5ndGggLSBuKSwgbGVuZ3RoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMgcHJlc2VudCBpbiBhbGwgcHJvdmlkZWQgYXJyYXlzIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXldIFRoZSBhcnJheXMgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBjb21wb3NpdGUgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludGVyc2VjdGlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICovCiAgICBmdW5jdGlvbiBpbnRlcnNlY3Rpb24oYXJyYXkpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICBhcmdzSW5kZXggPSAtMSwKICAgICAgICAgIGNhY2hlcyA9IGdldEFycmF5KCksCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgc2VlbiA9IGdldEFycmF5KCk7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGNhY2hlc1thcmdzSW5kZXhdID0gaW5kZXhPZiA9PT0gYmFzZUluZGV4T2YgJiYKICAgICAgICAgICh2YWx1ZSA/IHZhbHVlLmxlbmd0aCA6IDApID49IGxhcmdlQXJyYXlTaXplICYmCiAgICAgICAgICBjcmVhdGVDYWNoZShhcmdzSW5kZXggPyBhcmdzW2FyZ3NJbmRleF0gOiBzZWVuKTsKICAgICAgfQogICAgICBvdXRlcjoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgY2FjaGUgPSBjYWNoZXNbMF07CiAgICAgICAgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAgIGlmICgoY2FjaGUgPyBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA6IGluZGV4T2Yoc2VlbiwgdmFsdWUpKSA8IDApIHsKICAgICAgICAgIGFyZ3NJbmRleCA9IGFyZ3NMZW5ndGg7CiAgICAgICAgICAoY2FjaGUgfHwgc2VlbikucHVzaCh2YWx1ZSk7CiAgICAgICAgICB3aGlsZSAoLS1hcmdzSW5kZXgpIHsKICAgICAgICAgICAgY2FjaGUgPSBjYWNoZXNbYXJnc0luZGV4XTsKICAgICAgICAgICAgaWYgKChjYWNoZSA/IGNhY2hlSW5kZXhPZihjYWNoZSwgdmFsdWUpIDogaW5kZXhPZihhcmdzW2FyZ3NJbmRleF0sIHZhbHVlKSkgPCAwKSB7CiAgICAgICAgICAgICAgY29udGludWUgb3V0ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKGFyZ3NMZW5ndGgtLSkgewogICAgICAgIGNhY2hlID0gY2FjaGVzW2FyZ3NMZW5ndGhdOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgcmVsZWFzZU9iamVjdChjYWNoZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlbGVhc2VBcnJheShjYWNoZXMpOwogICAgICByZWxlYXNlQXJyYXkoc2Vlbik7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBsYXN0IGVsZW1lbnQgb3IgbGFzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgaXMKICAgICAqIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBlbmQgb2YgdGhlIGFycmF5IGFyZSByZXR1cm5lZCBhcyBsb25nIGFzIHRoZQogICAgICogY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBsYXN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLmxhc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsyLCAzXQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICdvcmdhbmljJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmxhc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2NhcnJvdCcsICdvcmdhbmljJzogdHJ1ZSB9XQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2JhbmFuYScsICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICd0eXBlJzogJ3ZlZ2V0YWJsZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5sYXN0KGZvb2QsIHsgJ3R5cGUnOiAndmVnZXRhYmxlJyB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAndHlwZSc6ICd2ZWdldGFibGUnIH0sIHsgJ25hbWUnOiAnY2Fycm90JywgJ3R5cGUnOiAndmVnZXRhYmxlJyB9XQogICAgICovCiAgICBmdW5jdGlvbiBsYXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdudW1iZXInICYmIGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkgPyBhcnJheVtsZW5ndGggLSAxXSA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbikpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nIHN0cmljdAogICAgICogZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiBgZnJvbUluZGV4YCBpcyBuZWdhdGl2ZSwgaXQgaXMgdXNlZAogICAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9YXJyYXkubGVuZ3RoLTFdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICAgIHZhciBpbmRleCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT0gJ251bWJlcicpIHsKICAgICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGluZGV4ICsgZnJvbUluZGV4KSA6IG5hdGl2ZU1pbihmcm9tSW5kZXgsIGluZGV4IC0gMSkpICsgMTsKICAgICAgfQogICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIHByb3ZpZGVkIHZhbHVlcyBmcm9tIHRoZSBnaXZlbiBhcnJheSB1c2luZyBzdHJpY3QgZXF1YWxpdHkgZm9yCiAgICAgKiBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7Li4uKn0gW3ZhbHVlXSBUaGUgdmFsdWVzIHRvIHJlbW92ZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgMSwgMiwgM107CiAgICAgKiBfLnB1bGwoYXJyYXksIDIsIDMpOwogICAgICogY29uc29sZS5sb2coYXJyYXkpOwogICAgICogLy8gPT4gWzEsIDFdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHB1bGwoYXJyYXkpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3MubGVuZ3RoLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbYXJnc0luZGV4XTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBudW1iZXJzIChwb3NpdGl2ZSBhbmQvb3IgbmVnYXRpdmUpIHByb2dyZXNzaW5nIGZyb20KICAgICAqIGBzdGFydGAgdXAgdG8gYnV0IG5vdCBpbmNsdWRpbmcgYGVuZGAuIElmIGBzdGFydGAgaXMgbGVzcyB0aGFuIGBzdG9wYCBhCiAgICAgKiB6ZXJvLWxlbmd0aCByYW5nZSBpcyBjcmVhdGVkIHVubGVzcyBhIG5lZ2F0aXZlIGBzdGVwYCBpcyBzcGVjaWZpZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZWNyZW1lbnQgYnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgcmFuZ2UgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZ2UoMTApOwogICAgICogLy8gPT4gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDldCiAgICAgKgogICAgICogXy5yYW5nZSgxLCAxMSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAzMCwgNSk7CiAgICAgKiAvLyA9PiBbMCwgNSwgMTAsIDE1LCAyMCwgMjVdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAtMTAsIC0xKTsKICAgICAqIC8vID0+IFswLCAtMSwgLTIsIC0zLCAtNCwgLTUsIC02LCAtNywgLTgsIC05XQogICAgICoKICAgICAqIF8ucmFuZ2UoMSwgNCwgMCk7CiAgICAgKiAvLyA9PiBbMSwgMSwgMV0KICAgICAqCiAgICAgKiBfLnJhbmdlKDApOwogICAgICogLy8gPT4gW10KICAgICAqLwogICAgZnVuY3Rpb24gcmFuZ2Uoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgICBzdGFydCA9ICtzdGFydCB8fCAwOwogICAgICBzdGVwID0gdHlwZW9mIHN0ZXAgPT0gJ251bWJlcicgPyBzdGVwIDogKCtzdGVwIHx8IDEpOwoKICAgICAgaWYgKGVuZCA9PSBudWxsKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9CiAgICAgIC8vIHVzZSBgQXJyYXkobGVuZ3RoKWAgc28gZW5naW5lcywgbGlrZSBDaGFrcmEgYW5kIFY4LCBhdm9pZCBzbG93ZXIgbW9kZXMKICAgICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWF4KDAsIGNlaWwoKGVuZCAtIHN0YXJ0KSAvIChzdGVwIHx8IDEpKSksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgZWxlbWVudHMgZnJvbSBhbiBhcnJheSB0aGF0IHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvcgogICAgICogYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgcmVtb3ZlZCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgNCwgNSwgNl07CiAgICAgKiB2YXIgZXZlbnMgPSBfLnJlbW92ZShhcnJheSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxLCAzLCA1XQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGV2ZW5zKTsKICAgICAqIC8vID0+IFsyLCA0LCA2XQogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmUoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gW107CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uaW5pdGlhbGAgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCBlbGVtZW50IG9yCiAgICAgKiBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZWxlbWVudHMKICAgICAqIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxudW1iZXJ8c3RyaW5nfSBbY2FsbGJhY2s9MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gZXhjbHVkZS4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yCiAgICAgKiAgb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiCiAgICAgKiAgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLnJlc3QoWzEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IFszXQogICAgICoKICAgICAqIF8ucmVzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzNdCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ29yZ2FuaWMnOiBmYWxzZSB9LAogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAnb3JnYW5pYyc6IGZhbHNlIH1dCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVzdChmb29kLCB7ICd0eXBlJzogJ2ZydWl0JyB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAndHlwZSc6ICd2ZWdldGFibGUnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBuID0gMCwKICAgICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGggJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBuYXRpdmVNYXgoMCwgY2FsbGJhY2spOwogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VzIGEgYmluYXJ5IHNlYXJjaCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIGEgdmFsdWUKICAgICAqIHNob3VsZCBiZSBpbnNlcnRlZCBpbnRvIGEgZ2l2ZW4gc29ydGVkIGFycmF5IGluIG9yZGVyIHRvIG1haW50YWluIHRoZSBzb3J0CiAgICAgKiBvcmRlciBvZiB0aGUgYXJyYXkuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IKICAgICAqIGB2YWx1ZWAgYW5kIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIHRvIGNvbXB1dGUgdGhlaXIgc29ydCByYW5raW5nLiBUaGUKICAgICAqIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDsgKHZhbHVlKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIGB2YWx1ZWAgc2hvdWxkIGJlIGluc2VydGVkCiAgICAgKiAgaW50byBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsyMCwgMzAsIDUwXSwgNDApOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29ydGVkSW5kZXgoW3sgJ3gnOiAyMCB9LCB7ICd4JzogMzAgfSwgeyAneCc6IDUwIH1dLCB7ICd4JzogNDAgfSwgJ3gnKTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiB2YXIgZGljdCA9IHsKICAgICAqICAgJ3dvcmRUb051bWJlcic6IHsgJ3R3ZW50eSc6IDIwLCAndGhpcnR5JzogMzAsICdmb3VydHknOiA0MCwgJ2ZpZnR5JzogNTAgfQogICAgICogfTsKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAgICogICByZXR1cm4gZGljdC53b3JkVG9OdW1iZXJbd29yZF07CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAgICogICByZXR1cm4gdGhpcy53b3JkVG9OdW1iZXJbd29yZF07CiAgICAgKiB9LCBkaWN0KTsKICAgICAqIC8vID0+IDIKICAgICAqLwogICAgZnVuY3Rpb24gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbG93ID0gMCwKICAgICAgICAgIGhpZ2ggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IGxvdzsKCiAgICAgIC8vIGV4cGxpY2l0bHkgcmVmZXJlbmNlIGBpZGVudGl0eWAgZm9yIGJldHRlciBpbmxpbmluZyBpbiBGaXJlZm94CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPyBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDEpIDogaWRlbnRpdHk7CiAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUpOwoKICAgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICAgIChjYWxsYmFjayhhcnJheVttaWRdKSA8IHZhbHVlKQogICAgICAgICAgPyBsb3cgPSBtaWQgKyAxCiAgICAgICAgICA6IGhpZ2ggPSBtaWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGxvdzsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIGNvbXBvc2l0ZSB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgMTAxLCAxMF0KICAgICAqLwogICAgZnVuY3Rpb24gdW5pb24oYXJyYXkpIHsKICAgICAgcmV0dXJuIGJhc2VVbmlxKGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgdHJ1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIHZlcnNpb24gb2YgYW4gYXJyYXkgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICAgKiBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBhcnJheSBpcyBzb3J0ZWQsIHByb3ZpZGluZwogICAgICogYHRydWVgIGZvciBgaXNTb3J0ZWRgIHdpbGwgdXNlIGEgZmFzdGVyIGFsZ29yaXRobS4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZAogICAgICogZWFjaCBlbGVtZW50IG9mIGBhcnJheWAgaXMgcGFzc2VkIHRocm91Z2ggdGhlIGNhbGxiYWNrIGJlZm9yZSB1bmlxdWVuZXNzCiAgICAgKiBpcyBjb21wdXRlZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIHVuaXF1ZQogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYGFycmF5YCBpcyBzb3J0ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy51bmlxKFsxLCAyLCAxLCAzLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiBfLnVuaXEoWzEsIDEsIDIsIDIsIDNdLCB0cnVlKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICoKICAgICAqIF8udW5pcShbJ0EnLCAnYicsICdDJywgJ2EnLCAnQicsICdjJ10sIGZ1bmN0aW9uKGxldHRlcikgeyByZXR1cm4gbGV0dGVyLnRvTG93ZXJDYXNlKCk7IH0pOwogICAgICogLy8gPT4gWydBJywgJ2InLCAnQyddCiAgICAgKgogICAgICogXy51bmlxKFsxLCAyLjUsIDMsIDEuNSwgMiwgMy41XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAgICogLy8gPT4gWzEsIDIuNSwgM10KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnVuaXEoW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH0sIHsgJ3gnOiAxIH1dLCAneCcpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVuaXEoYXJyYXksIGlzU29ydGVkLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgIT0gJ2Jvb2xlYW4nICYmIGlzU29ydGVkICE9IG51bGwpIHsKICAgICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSAhKHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NvcnRlZF0gPT09IGFycmF5KSA/IGlzU29ydGVkIDogbnVsbDsKICAgICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgZXhjbHVkaW5nIGFsbCBwcm92aWRlZCB2YWx1ZXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAgICogY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFt2YWx1ZV0gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy53aXRob3V0KFsxLCAyLCAxLCAwLCAzLCAxLCA0XSwgMCwgMSk7CiAgICAgKiAvLyA9PiBbMiwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gd2l0aG91dChhcnJheSkgewogICAgICByZXR1cm4gZGlmZmVyZW5jZShhcnJheSwgbmF0aXZlU2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cywgdGhlIGZpcnN0IG9mIHdoaWNoIGNvbnRhaW5zIHRoZSBmaXJzdAogICAgICogZWxlbWVudHMgb2YgdGhlIGdpdmVuIGFycmF5cywgdGhlIHNlY29uZCBvZiB3aGljaCBjb250YWlucyB0aGUgc2Vjb25kCiAgICAgKiBlbGVtZW50cyBvZiB0aGUgZ2l2ZW4gYXJyYXlzLCBhbmQgc28gb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyB1bnppcAogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5XSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnppcChbJ21vZScsICdsYXJyeSddLCBbMzAsIDQwXSwgW3RydWUsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiBbWydtb2UnLCAzMCwgdHJ1ZV0sIFsnbGFycnknLCA0MCwgZmFsc2VdXQogICAgICovCiAgICBmdW5jdGlvbiB6aXAoKSB7CiAgICAgIHZhciBhcnJheSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzIDogYXJndW1lbnRzWzBdLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gbWF4KHBsdWNrKGFycmF5LCAnbGVuZ3RoJykpIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCA8IDAgPyAwIDogbGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IHBsdWNrKGFycmF5LCBpbmRleCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIGZyb20gYXJyYXlzIG9mIGBrZXlzYCBhbmQgYHZhbHVlc2AuIFByb3ZpZGUKICAgICAqIGVpdGhlciBhIHNpbmdsZSB0d28gZGltZW5zaW9uYWwgYXJyYXksIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYAogICAgICogb3IgdHdvIGFycmF5cywgb25lIG9mIGBrZXlzYCBhbmQgb25lIG9mIGNvcnJlc3BvbmRpbmcgYHZhbHVlc2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBvYmplY3QKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGFycmF5IG9mIGtleXMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzPVtdXSBUaGUgYXJyYXkgb2YgdmFsdWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGdpdmVuIGtleXMgYW5kCiAgICAgKiAgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uemlwT2JqZWN0KFsnbW9lJywgJ2xhcnJ5J10sIFszMCwgNDBdKTsKICAgICAqIC8vID0+IHsgJ21vZSc6IDMwLCAnbGFycnknOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcE9iamVjdChrZXlzLCB2YWx1ZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgICAgfSBlbHNlIGlmIChrZXkpIHsKICAgICAgICAgIHJlc3VsdFtrZXlbMF1dID0ga2V5WzFdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgZXhlY3V0ZXMgYGZ1bmNgLCB3aXRoICB0aGUgYHRoaXNgIGJpbmRpbmcgYW5kCiAgICAgKiBhcmd1bWVudHMgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24sIG9ubHkgYWZ0ZXIgYmVpbmcgY2FsbGVkIGBuYCB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZnVuY3Rpb24gbXVzdCBiZSBjYWxsZWQgYmVmb3JlCiAgICAgKiAgYGZ1bmNgIGlzIGV4ZWN1dGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F2ZXMgPSBbJ3Byb2ZpbGUnLCAnc2V0dGluZ3MnXTsKICAgICAqCiAgICAgKiB2YXIgZG9uZSA9IF8uYWZ0ZXIoc2F2ZXMubGVuZ3RoLCBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ0RvbmUgc2F2aW5nIScpOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5mb3JFYWNoKHNhdmVzLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgKiAgIGFzeW5jU2F2ZSh7ICd0eXBlJzogdHlwZSwgJ2NvbXBsZXRlJzogZG9uZSB9KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnRG9uZSBzYXZpbmchJywgYWZ0ZXIgYWxsIHNhdmVzIGhhdmUgY29tcGxldGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKC0tbiA8IDEpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICAgKiBwcm92aWRlZCB0byB0aGUgYm91bmQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiB9OwogICAgICoKICAgICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdtb2UnIH0sICdoaScpOwogICAgICogZnVuYygpOwogICAgICogLy8gPT4gJ2hpIG1vZScKICAgICAqLwogICAgZnVuY3Rpb24gYmluZChmdW5jLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgICAgID8gY3JlYXRlQm91bmQoZnVuYywgMTcsIG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwgbnVsbCwgdGhpc0FyZykKICAgICAgICA6IGNyZWF0ZUJvdW5kKGZ1bmMsIDEsIG51bGwsIG51bGwsIHRoaXNBcmcpOwogICAgfQoKICAgIC8qKgogICAgICogQmluZHMgbWV0aG9kcyBvZiBhbiBvYmplY3QgdG8gdGhlIG9iamVjdCBpdHNlbGYsIG92ZXJ3cml0aW5nIHRoZSBleGlzdGluZwogICAgICogbWV0aG9kLiBNZXRob2QgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMKICAgICAqIG9mIG1ldGhvZCBuYW1lcy4gSWYgbm8gbWV0aG9kIG5hbWVzIGFyZSBwcm92aWRlZCBhbGwgdGhlIGZ1bmN0aW9uIHByb3BlcnRpZXMKICAgICAqIG9mIGBvYmplY3RgIHdpbGwgYmUgYm91bmQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBiaW5kIGFuZCBhc3NpZ24gdGhlIGJvdW5kIG1ldGhvZHMgdG8uCiAgICAgKiBAcGFyYW0gey4uLnN0cmluZ30gW21ldGhvZE5hbWVdIFRoZSBvYmplY3QgbWV0aG9kIG5hbWVzIHRvCiAgICAgKiAgYmluZCwgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgbWV0aG9kIG5hbWVzIG9yIGFycmF5cyBvZiBtZXRob2QgbmFtZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdmlldyA9IHsKICAgICAqICAnbGFiZWwnOiAnZG9jcycsCiAgICAgKiAgJ29uQ2xpY2snOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2NsaWNrZWQgJyArIHRoaXMubGFiZWwpOyB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uYmluZEFsbCh2aWV3KTsKICAgICAqIGpRdWVyeSgnI2RvY3MnKS5vbignY2xpY2snLCB2aWV3Lm9uQ2xpY2spOwogICAgICogLy8gPT4gbG9ncyAnY2xpY2tlZCBkb2NzJywgd2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSA6IGZ1bmN0aW9ucyhvYmplY3QpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgICBvYmplY3Rba2V5XSA9IGNyZWF0ZUJvdW5kKG9iamVjdFtrZXldLCAxLCBudWxsLCBudWxsLCBvYmplY3QpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgdGhlIG1ldGhvZCBhdCBgb2JqZWN0W2tleV1gCiAgICAgKiBhbmQgcHJlcGVuZHMgYW55IGFkZGl0aW9uYWwgYGJpbmRLZXlgIGFyZ3VtZW50cyB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgYm91bmQKICAgICAqIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZCBkaWZmZXJzIGZyb20gYF8uYmluZGAgYnkgYWxsb3dpbmcgYm91bmQgZnVuY3Rpb25zIHRvCiAgICAgKiByZWZlcmVuY2UgbWV0aG9kcyB0aGF0IHdpbGwgYmUgcmVkZWZpbmVkIG9yIGRvbid0IHlldCBleGlzdC4KICAgICAqIFNlZSBodHRwOi8vbWljaGF1eC5jYS9hcnRpY2xlcy9sYXp5LWZ1bmN0aW9uLWRlZmluaXRpb24tcGF0dGVybi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoZSBtZXRob2QgYmVsb25ncyB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgbWV0aG9kLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsKICAgICAqICAgJ25hbWUnOiAnbW9lJywKICAgICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBtb2UnCiAgICAgKgogICAgICogb2JqZWN0LmdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJywgJyArIHRoaXMubmFtZSArICchJzsKICAgICAqIH07CiAgICAgKgogICAgICogZnVuYygpOwogICAgICogLy8gPT4gJ2hpLCBtb2UhJwogICAgICovCiAgICBmdW5jdGlvbiBiaW5kS2V5KG9iamVjdCwga2V5KSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgICAgID8gY3JlYXRlQm91bmQoa2V5LCAxOSwgbmF0aXZlU2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBudWxsLCBvYmplY3QpCiAgICAgICAgOiBjcmVhdGVCb3VuZChrZXksIDMsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGZ1bmN0aW9ucywKICAgICAqIHdoZXJlIGVhY2ggZnVuY3Rpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogICAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Li4uRnVuY3Rpb259IFtmdW5jXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNvbXBvc2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcmVhbE5hbWVNYXAgPSB7CiAgICAgKiAgICdjdXJseSc6ICdqZXJvbWUnCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBmb3JtYXQgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgKiAgIG5hbWUgPSByZWFsTmFtZU1hcFtuYW1lLnRvTG93ZXJDYXNlKCldIHx8IG5hbWU7CiAgICAgKiAgIHJldHVybiBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihmb3JtYXR0ZWQpIHsKICAgICAqICAgcmV0dXJuICdIaXlhICcgKyBmb3JtYXR0ZWQgKyAnISc7CiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciB3ZWxjb21lID0gXy5jb21wb3NlKGdyZWV0LCBmb3JtYXQpOwogICAgICogd2VsY29tZSgnY3VybHknKTsKICAgICAqIC8vID0+ICdIaXlhIEplcm9tZSEnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBvc2UoKSB7CiAgICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50cywKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jc1tsZW5ndGhdKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgYXJncyA9IFtmdW5jc1tsZW5ndGhdLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIGNhbGxiYWNrIGJvdW5kIHRvIGFuIG9wdGlvbmFsIGB0aGlzQXJnYC4gSWYgYGZ1bmNgIGlzIGEgcHJvcGVydHkKICAgICAqIG5hbWUgdGhlIGNyZWF0ZWQgY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIGZvciBhIGdpdmVuIGVsZW1lbnQuCiAgICAgKiBJZiBgZnVuY2AgaXMgYW4gb2JqZWN0IHRoZSBjcmVhdGVkIGNhbGxiYWNrIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMKICAgICAqIHRoYXQgY29udGFpbiB0aGUgZXF1aXZhbGVudCBvYmplY3QgcHJvcGVydGllcywgb3RoZXJ3aXNlIGl0IHdpbGwgcmV0dXJuIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Kn0gW2Z1bmM9aWRlbnRpdHldIFRoZSB2YWx1ZSB0byBjb252ZXJ0IHRvIGEgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyZ0NvdW50XSBUaGUgbnVtYmVyIG9mIGFyZ3VtZW50cyB0aGUgY2FsbGJhY2sgYWNjZXB0cy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBhIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHdyYXAgdG8gY3JlYXRlIGN1c3RvbSBjYWxsYmFjayBzaG9ydGhhbmRzCiAgICAgKiBfLmNyZWF0ZUNhbGxiYWNrID0gXy53cmFwKF8uY3JlYXRlQ2FsbGJhY2ssIGZ1bmN0aW9uKGZ1bmMsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgKiAgIHZhciBtYXRjaCA9IC9eKC4rPylfXyhbZ2xddCkoLispJC8uZXhlYyhjYWxsYmFjayk7CiAgICAgKiAgIHJldHVybiAhbWF0Y2ggPyBmdW5jKGNhbGxiYWNrLCB0aGlzQXJnKSA6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICogICAgIHJldHVybiBtYXRjaFsyXSA9PSAnZ3QnID8gb2JqZWN0W21hdGNoWzFdXSA+IG1hdGNoWzNdIDogb2JqZWN0W21hdGNoWzFdXSA8IG1hdGNoWzNdOwogICAgICogICB9OwogICAgICogfSk7CiAgICAgKgogICAgICogXy5maWx0ZXIoc3Rvb2dlcywgJ2FnZV9fZ3Q0NScpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYXJnQ291bnQpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgICAgaWYgKGZ1bmMgPT0gbnVsbCB8fCB0eXBlID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KTsKICAgICAgfQogICAgICAvLyBoYW5kbGUgIl8ucGx1Y2siIHN0eWxlIGNhbGxiYWNrIHNob3J0aGFuZHMKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2Z1bmNdOwogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKSwKICAgICAgICAgIGtleSA9IHByb3BzWzBdLAogICAgICAgICAgYSA9IGZ1bmNba2V5XTsKCiAgICAgIC8vIGhhbmRsZSAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICBpZiAocHJvcHMubGVuZ3RoID09IDEgJiYgYSA9PT0gYSAmJiAhaXNPYmplY3QoYSkpIHsKICAgICAgICAvLyBmYXN0IHBhdGggdGhlIGNvbW1vbiBjYXNlIG9mIHByb3ZpZGluZyBhbiBvYmplY3Qgd2l0aCBhIHNpbmdsZQogICAgICAgIC8vIHByb3BlcnR5IGNvbnRhaW5pbmcgYSBwcmltaXRpdmUgdmFsdWUKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB2YXIgYiA9IG9iamVjdFtrZXldOwogICAgICAgICAgcmV0dXJuIGEgPT09IGIgJiYgKGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwob2JqZWN0W3Byb3BzW2xlbmd0aF1dLCBmdW5jW3Byb3BzW2xlbmd0aF1dLCBudWxsLCB0cnVlKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gd2hpY2ggYWNjZXB0cyBvbmUgb3IgbW9yZSBhcmd1bWVudHMgb2YgYGZ1bmNgIHRoYXQgd2hlbgogICAgICogaW52b2tlZCBlaXRoZXIgZXhlY3V0ZXMgYGZ1bmNgIHJldHVybmluZyBpdHMgcmVzdWx0LCBpZiBhbGwgYGZ1bmNgIGFyZ3VtZW50cwogICAgICogaGF2ZSBiZWVuIHByb3ZpZGVkLCBvciByZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIG9uZSBvciBtb3JlIG9mIHRoZQogICAgICogcmVtYWluaW5nIGBmdW5jYCBhcmd1bWVudHMsIGFuZCBzbyBvbi4gVGhlIGFyaXR5IG9mIGBmdW5jYCBjYW4gYmUgc3BlY2lmaWVkCiAgICAgKiBpZiBgZnVuYy5sZW5ndGhgIGlzIG5vdCBzdWZmaWNpZW50LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjdXJyeS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHk9ZnVuYy5sZW5ndGhdIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjdXJyaWVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY3VycmllZCA9IF8uY3VycnkoZnVuY3Rpb24oYSwgYiwgYykgewogICAgICogICBjb25zb2xlLmxvZyhhICsgYiArIGMpOwogICAgICogfSk7CiAgICAgKgogICAgICogY3VycmllZCgxKSgyKSgzKTsKICAgICAqIC8vID0+IDYKICAgICAqCiAgICAgKiBjdXJyaWVkKDEsIDIpKDMpOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMiwgMyk7CiAgICAgKiAvLyA9PiA2CiAgICAgKi8KICAgIGZ1bmN0aW9uIGN1cnJ5KGZ1bmMsIGFyaXR5KSB7CiAgICAgIGFyaXR5ID0gdHlwZW9mIGFyaXR5ID09ICdudW1iZXInID8gYXJpdHkgOiAoK2FyaXR5IHx8IGZ1bmMubGVuZ3RoKTsKICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIDQsIG51bGwsIG51bGwsIG51bGwsIGFyaXR5KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiBgZnVuY2AgdW50aWwgYWZ0ZXIKICAgICAqIGB3YWl0YCBtaWxsaXNlY29uZHMgaGF2ZSBlbGFwc2VkIHNpbmNlIHRoZSBsYXN0IHRpbWUgaXQgd2FzIGludm9rZWQuCiAgICAgKiBQcm92aWRlIGFuIG9wdGlvbnMgb2JqZWN0IHRvIGluZGljYXRlIHRoYXQgYGZ1bmNgIHNob3VsZCBiZSBpbnZva2VkIG9uCiAgICAgKiB0aGUgbGVhZGluZyBhbmQvb3IgdHJhaWxpbmcgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMKICAgICAqIHRvIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgICAqCiAgICAgKiBOb3RlOiBJZiBgbGVhZGluZ2AgYW5kIGB0cmFpbGluZ2Agb3B0aW9ucyBhcmUgYHRydWVgIGBmdW5jYCB3aWxsIGJlIGNhbGxlZAogICAgICogb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQgb25seSBpZiB0aGUgdGhlIGRlYm91bmNlZCBmdW5jdGlvbiBpcwogICAgICogaW52b2tlZCBtb3JlIHRoYW4gb25jZSBkdXJpbmcgdGhlIGB3YWl0YCB0aW1lb3V0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxlYWRpbmc9ZmFsc2VdIFNwZWNpZnkgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMubWF4V2FpdF0gVGhlIG1heGltdW0gdGltZSBgZnVuY2AgaXMgYWxsb3dlZCB0byBiZSBkZWxheWVkIGJlZm9yZSBpdCdzIGNhbGxlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudHJhaWxpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBkZWJvdW5jZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIGF2b2lkIGNvc3RseSBjYWxjdWxhdGlvbnMgd2hpbGUgdGhlIHdpbmRvdyBzaXplIGlzIGluIGZsdXgKICAgICAqIHZhciBsYXp5TGF5b3V0ID0gXy5kZWJvdW5jZShjYWxjdWxhdGVMYXlvdXQsIDE1MCk7CiAgICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgbGF6eUxheW91dCk7CiAgICAgKgogICAgICogLy8gZXhlY3V0ZSBgc2VuZE1haWxgIHdoZW4gdGhlIGNsaWNrIGV2ZW50IGlzIGZpcmVkLCBkZWJvdW5jaW5nIHN1YnNlcXVlbnQgY2FsbHMKICAgICAqIGpRdWVyeSgnI3Bvc3Rib3gnKS5vbignY2xpY2snLCBfLmRlYm91bmNlKHNlbmRNYWlsLCAzMDAsIHsKICAgICAqICAgJ2xlYWRpbmcnOiB0cnVlLAogICAgICogICAndHJhaWxpbmcnOiBmYWxzZQogICAgICogfSk7CiAgICAgKgogICAgICogLy8gZW5zdXJlIGBiYXRjaExvZ2AgaXMgZXhlY3V0ZWQgb25jZSBhZnRlciAxIHNlY29uZCBvZiBkZWJvdW5jZWQgY2FsbHMKICAgICAqIHZhciBzb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2UoJy9zdHJlYW0nKTsKICAgICAqIHNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgXy5kZWJvdW5jZShiYXRjaExvZywgMjUwLCB7CiAgICAgKiAgICdtYXhXYWl0JzogMTAwMAogICAgICogfSwgZmFsc2UpOwogICAgICovCiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICAgIHZhciBhcmdzLAogICAgICAgICAgbWF4VGltZW91dElkLAogICAgICAgICAgcmVzdWx0LAogICAgICAgICAgc3RhbXAsCiAgICAgICAgICB0aGlzQXJnLAogICAgICAgICAgdGltZW91dElkLAogICAgICAgICAgdHJhaWxpbmdDYWxsLAogICAgICAgICAgbGFzdENhbGxlZCA9IDAsCiAgICAgICAgICBtYXhXYWl0ID0gZmFsc2UsCiAgICAgICAgICB0cmFpbGluZyA9IHRydWU7CgogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHdhaXQgPSBuYXRpdmVNYXgoMCwgd2FpdCkgfHwgMDsKICAgICAgaWYgKG9wdGlvbnMgPT09IHRydWUpIHsKICAgICAgICB2YXIgbGVhZGluZyA9IHRydWU7CiAgICAgICAgdHJhaWxpbmcgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIGxlYWRpbmcgPSBvcHRpb25zLmxlYWRpbmc7CiAgICAgICAgbWF4V2FpdCA9ICdtYXhXYWl0JyBpbiBvcHRpb25zICYmIChuYXRpdmVNYXgod2FpdCwgb3B0aW9ucy5tYXhXYWl0KSB8fCAwKTsKICAgICAgICB0cmFpbGluZyA9ICd0cmFpbGluZycgaW4gb3B0aW9ucyA/IG9wdGlvbnMudHJhaWxpbmcgOiB0cmFpbGluZzsKICAgICAgfQogICAgICB2YXIgZGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdygpIC0gc3RhbXApOwogICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgaWYgKG1heFRpbWVvdXRJZCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQobWF4VGltZW91dElkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhbGxlZCA9IHRyYWlsaW5nQ2FsbDsKICAgICAgICAgIG1heFRpbWVvdXRJZCA9IHRpbWVvdXRJZCA9IHRyYWlsaW5nQ2FsbCA9IHVuZGVmaW5lZDsKICAgICAgICAgIGlmIChpc0NhbGxlZCkgewogICAgICAgICAgICBsYXN0Q2FsbGVkID0gbm93KCk7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgbWF4RGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aW1lb3V0SWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHRyYWlsaW5nIHx8IChtYXhXYWl0ICE9PSB3YWl0KSkgewogICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBzdGFtcCA9IG5vdygpOwogICAgICAgIHRoaXNBcmcgPSB0aGlzOwogICAgICAgIHRyYWlsaW5nQ2FsbCA9IHRyYWlsaW5nICYmICh0aW1lb3V0SWQgfHwgIWxlYWRpbmcpOwoKICAgICAgICBpZiAobWF4V2FpdCA9PT0gZmFsc2UpIHsKICAgICAgICAgIHZhciBsZWFkaW5nQ2FsbCA9IGxlYWRpbmcgJiYgIXRpbWVvdXRJZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFtYXhUaW1lb3V0SWQgJiYgIWxlYWRpbmcpIHsKICAgICAgICAgICAgbGFzdENhbGxlZCA9IHN0YW1wOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlbWFpbmluZyA9IG1heFdhaXQgLSAoc3RhbXAgLSBsYXN0Q2FsbGVkKTsKICAgICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgICBpZiAobWF4VGltZW91dElkKSB7CiAgICAgICAgICAgICAgbWF4VGltZW91dElkID0gY2xlYXJUaW1lb3V0KG1heFRpbWVvdXRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENhbGxlZCA9IHN0YW1wOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoIW1heFRpbWVvdXRJZCkgewogICAgICAgICAgICBtYXhUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KG1heERlbGF5ZWQsIHJlbWFpbmluZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGltZW91dElkICYmIHdhaXQgIT09IG1heFdhaXQpIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgd2FpdCk7CiAgICAgICAgfQogICAgICAgIGlmIChsZWFkaW5nQ2FsbCkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIERlZmVycyBleGVjdXRpbmcgdGhlIGBmdW5jYCBmdW5jdGlvbiB1bnRpbCB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcyBjbGVhcmVkLgogICAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBwcm92aWRlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWZlci4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ10gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgZnVuY3Rpb24gd2l0aC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHRpbWVyIGlkLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmRlZmVyKGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnZGVmZXJyZWQnKTsgfSk7CiAgICAgKiAvLyByZXR1cm5zIGZyb20gdGhlIGZ1bmN0aW9uIGJlZm9yZSAnZGVmZXJyZWQnIGlzIGxvZ2dlZAogICAgICovCiAgICBmdW5jdGlvbiBkZWZlcihmdW5jKSB7CiAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgdmFyIGFyZ3MgPSBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIDEpOwogICAgfQogICAgLy8gdXNlIGBzZXRJbW1lZGlhdGVgIGlmIGF2YWlsYWJsZSBpbiBOb2RlLmpzCiAgICBpZiAoaXNWOCAmJiBtb2R1bGVFeHBvcnRzICYmIHR5cGVvZiBzZXRJbW1lZGlhdGUgPT0gJ2Z1bmN0aW9uJykgewogICAgICBkZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRJbW1lZGlhdGUuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4ZWN1dGVzIHRoZSBgZnVuY2AgZnVuY3Rpb24gYWZ0ZXIgYHdhaXRgIG1pbGxpc2Vjb25kcy4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgICAqIHdpbGwgYmUgcHJvdmlkZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVsYXkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheSBleGVjdXRpb24uCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSB0aW1lciBpZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGxvZyA9IF8uYmluZChjb25zb2xlLmxvZywgY29uc29sZSk7CiAgICAgKiBfLmRlbGF5KGxvZywgMTAwMCwgJ2xvZ2dlZCBsYXRlcicpOwogICAgICogLy8gPT4gJ2xvZ2dlZCBsYXRlcicgKEFwcGVhcnMgYWZ0ZXIgb25lIHNlY29uZC4pCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlbGF5KGZ1bmMsIHdhaXQpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBtZW1vaXplcyB0aGUgcmVzdWx0IG9mIGBmdW5jYC4gSWYgYHJlc29sdmVyYCBpcwogICAgICogcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgY2FjaGUga2V5IGZvciBzdG9yaW5nIHRoZSByZXN1bHQKICAgICAqIGJhc2VkIG9uIHRoZSBhcmd1bWVudHMgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUKICAgICAqIGZpcnN0IGFyZ3VtZW50IHByb3ZpZGVkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBjYWNoZSBrZXkuCiAgICAgKiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqIFRoZSByZXN1bHQgY2FjaGUgaXMgZXhwb3NlZCBhcyB0aGUgYGNhY2hlYCBwcm9wZXJ0eSBvbiB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGhhdmUgaXRzIG91dHB1dCBtZW1vaXplZC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtyZXNvbHZlcl0gQSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIGNhY2hlIGtleS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemluZyBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZpYm9uYWNjaSA9IF8ubWVtb2l6ZShmdW5jdGlvbihuKSB7CiAgICAgKiAgIHJldHVybiBuIDwgMiA/IG4gOiBmaWJvbmFjY2kobiAtIDEpICsgZmlib25hY2NpKG4gLSAyKTsKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBkYXRhID0gewogICAgICogICAnbW9lJzogeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgJ2N1cmx5JzogeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKiB9OwogICAgICoKICAgICAqIC8vIG1vZGlmeWluZyB0aGUgcmVzdWx0IGNhY2hlCiAgICAgKiB2YXIgc3Rvb2dlID0gXy5tZW1vaXplKGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuIGRhdGFbbmFtZV07IH0sIF8uaWRlbnRpdHkpOwogICAgICogc3Rvb2dlKCdjdXJseScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKgogICAgICogc3Rvb2dlLmNhY2hlLmN1cmx5Lm5hbWUgPSAnamVyb21lJzsKICAgICAqIHN0b29nZSgnY3VybHknKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnamVyb21lJywgJ2FnZSc6IDYwIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBtZW1vaXplZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWNoZSA9IG1lbW9pemVkLmNhY2hlLAogICAgICAgICAgICBrZXkgPSByZXNvbHZlciA/IHJlc29sdmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBrZXlQcmVmaXggKyBhcmd1bWVudHNbMF07CgogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICB9CiAgICAgIG1lbW9pemVkLmNhY2hlID0ge307CiAgICAgIHJldHVybiBtZW1vaXplZDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICAgKiB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHZhbHVlIG9mIHRoZSBmaXJzdCBjYWxsLiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkCiAgICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9uY2UoZnVuYykgewogICAgICB2YXIgcmFuLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHJhbikgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmFuID0gdHJ1ZTsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBuZXcgZnVuY3Rpb24uIFRoaXMKICAgICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgbmFtZTsgfTsKICAgICAqIHZhciBoaSA9IF8ucGFydGlhbChncmVldCwgJ2hpJyk7CiAgICAgKiBoaSgnbW9lJyk7CiAgICAgKiAvLyA9PiAnaGkgbW9lJwogICAgICovCiAgICBmdW5jdGlvbiBwYXJ0aWFsKGZ1bmMpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIDE2LCBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5wYXJ0aWFsYCBleGNlcHQgdGhhdCBgcGFydGlhbGAgYXJndW1lbnRzIGFyZQogICAgICogYXBwZW5kZWQgdG8gdGhvc2UgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcGFydGlhbGx5IGFwcGx5IGFyZ3VtZW50cyB0by4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ10gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcGFydGlhbGx5IGFwcGxpZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBkZWZhdWx0c0RlZXAgPSBfLnBhcnRpYWxSaWdodChfLm1lcmdlLCBfLmRlZmF1bHRzKTsKICAgICAqCiAgICAgKiB2YXIgb3B0aW9ucyA9IHsKICAgICAqICAgJ3ZhcmlhYmxlJzogJ2RhdGEnLAogICAgICogICAnaW1wb3J0cyc6IHsgJ2pxJzogJCB9CiAgICAgKiB9OwogICAgICoKICAgICAqIGRlZmF1bHRzRGVlcChvcHRpb25zLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwogICAgICoKICAgICAqIG9wdGlvbnMudmFyaWFibGUKICAgICAqIC8vID0+ICdkYXRhJwogICAgICoKICAgICAqIG9wdGlvbnMuaW1wb3J0cwogICAgICogLy8gPT4geyAnXyc6IF8sICdqcSc6ICQgfQogICAgICovCiAgICBmdW5jdGlvbiBwYXJ0aWFsUmlnaHQoZnVuYykgewogICAgICByZXR1cm4gY3JlYXRlQm91bmQoZnVuYywgMzIsIG51bGwsIG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBleGVjdXRlZCwgd2lsbCBvbmx5IGNhbGwgdGhlIGBmdW5jYCBmdW5jdGlvbgogICAgICogYXQgbW9zdCBvbmNlIHBlciBldmVyeSBgd2FpdGAgbWlsbGlzZWNvbmRzLiBQcm92aWRlIGFuIG9wdGlvbnMgb2JqZWN0IHRvCiAgICAgKiBpbmRpY2F0ZSB0aGF0IGBmdW5jYCBzaG91bGQgYmUgaW52b2tlZCBvbiB0aGUgbGVhZGluZyBhbmQvb3IgdHJhaWxpbmcgZWRnZQogICAgICogb2YgdGhlIGB3YWl0YCB0aW1lb3V0LiBTdWJzZXF1ZW50IGNhbGxzIHRvIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbAogICAgICogcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICAgKgogICAgICogTm90ZTogSWYgYGxlYWRpbmdgIGFuZCBgdHJhaWxpbmdgIG9wdGlvbnMgYXJlIGB0cnVlYCBgZnVuY2Agd2lsbCBiZSBjYWxsZWQKICAgICAqIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0IG9ubHkgaWYgdGhlIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gaXMKICAgICAqIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB0aHJvdHRsZSBleGVjdXRpb25zIHRvLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxlYWRpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudHJhaWxpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB0aHJvdHRsZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIGF2b2lkIGV4Y2Vzc2l2ZWx5IHVwZGF0aW5nIHRoZSBwb3NpdGlvbiB3aGlsZSBzY3JvbGxpbmcKICAgICAqIHZhciB0aHJvdHRsZWQgPSBfLnRocm90dGxlKHVwZGF0ZVBvc2l0aW9uLCAxMDApOwogICAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Njcm9sbCcsIHRocm90dGxlZCk7CiAgICAgKgogICAgICogLy8gZXhlY3V0ZSBgcmVuZXdUb2tlbmAgd2hlbiB0aGUgY2xpY2sgZXZlbnQgaXMgZmlyZWQsIGJ1dCBub3QgbW9yZSB0aGFuIG9uY2UgZXZlcnkgNSBtaW51dGVzCiAgICAgKiBqUXVlcnkoJy5pbnRlcmFjdGl2ZScpLm9uKCdjbGljaycsIF8udGhyb3R0bGUocmVuZXdUb2tlbiwgMzAwMDAwLCB7CiAgICAgKiAgICd0cmFpbGluZyc6IGZhbHNlCiAgICAgKiB9KSk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRocm90dGxlKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGxlYWRpbmcgPSB0cnVlLAogICAgICAgICAgdHJhaWxpbmcgPSB0cnVlOwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICBpZiAob3B0aW9ucyA9PT0gZmFsc2UpIHsKICAgICAgICBsZWFkaW5nID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykpIHsKICAgICAgICBsZWFkaW5nID0gJ2xlYWRpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLmxlYWRpbmcgOiBsZWFkaW5nOwogICAgICAgIHRyYWlsaW5nID0gJ3RyYWlsaW5nJyBpbiBvcHRpb25zID8gb3B0aW9ucy50cmFpbGluZyA6IHRyYWlsaW5nOwogICAgICB9CiAgICAgIGRlYm91bmNlT3B0aW9ucy5sZWFkaW5nID0gbGVhZGluZzsKICAgICAgZGVib3VuY2VPcHRpb25zLm1heFdhaXQgPSB3YWl0OwogICAgICBkZWJvdW5jZU9wdGlvbnMudHJhaWxpbmcgPSB0cmFpbGluZzsKCiAgICAgIHZhciByZXN1bHQgPSBkZWJvdW5jZShmdW5jLCB3YWl0LCBkZWJvdW5jZU9wdGlvbnMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYHZhbHVlYCB0byB0aGUgd3JhcHBlciBmdW5jdGlvbiBhcyBpdHMKICAgICAqIGZpcnN0IGFyZ3VtZW50LiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBwcm92aWRlZCB0byB0aGUgZnVuY3Rpb24gYXJlIGFwcGVuZGVkCiAgICAgKiB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgd3JhcHBlciBmdW5jdGlvbi4gVGhlIHdyYXBwZXIgaXMgZXhlY3V0ZWQgd2l0aAogICAgICogdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gd3JhcHBlciBUaGUgd3JhcHBlciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaGVsbG8gPSBmdW5jdGlvbihuYW1lKSB7IHJldHVybiAnaGVsbG8gJyArIG5hbWU7IH07CiAgICAgKiBoZWxsbyA9IF8ud3JhcChoZWxsbywgZnVuY3Rpb24oZnVuYykgewogICAgICogICByZXR1cm4gJ2JlZm9yZSwgJyArIGZ1bmMoJ21vZScpICsgJywgYWZ0ZXInOwogICAgICogfSk7CiAgICAgKiBoZWxsbygpOwogICAgICogLy8gPT4gJ2JlZm9yZSwgaGVsbG8gbW9lLCBhZnRlcicKICAgICAqLwogICAgZnVuY3Rpb24gd3JhcCh2YWx1ZSwgd3JhcHBlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24od3JhcHBlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt2YWx1ZV07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ29udmVydHMgdGhlIGNoYXJhY3RlcnMgYCZgLCBgPGAsIGA+YCwgYCJgLCBhbmQgYCdgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICAgKiBjb3JyZXNwb25kaW5nIEhUTUwgZW50aXRpZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5lc2NhcGUoJ01vZSwgTGFycnkgJiBDdXJseScpOwogICAgICogLy8gPT4gJ01vZSwgTGFycnkgJmFtcDsgQ3VybHknCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVzY2FwZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyaW5nKS5yZXBsYWNlKHJlVW5lc2NhcGVkSHRtbCwgZXNjYXBlSHRtbENoYXIpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgcmV0dXJucyB0aGUgZmlyc3QgYXJndW1lbnQgcHJvdmlkZWQgdG8gaXQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgQW55IHZhbHVlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgYHZhbHVlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJyB9OwogICAgICogbW9lID09PSBfLmlkZW50aXR5KG1vZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgZnVuY3Rpb24gcHJvcGVydGllcyBvZiBhIHNvdXJjZSBvYmplY3QgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uIGFuZAogICAgICogY2hhaW5hYmxlIHdyYXBwZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5taXhpbih7CiAgICAgKiAgICdjYXBpdGFsaXplJzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgKiAgICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogICB9CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBfLmNhcGl0YWxpemUoJ21vZScpOwogICAgICogLy8gPT4gJ01vZScKICAgICAqCiAgICAgKiBfKCdtb2UnKS5jYXBpdGFsaXplKCk7CiAgICAgKiAvLyA9PiAnTW9lJwogICAgICovCiAgICBmdW5jdGlvbiBtaXhpbihvYmplY3QsIHNvdXJjZSkgewogICAgICB2YXIgY3RvciA9IG9iamVjdCwKICAgICAgICAgIGlzRnVuYyA9ICFzb3VyY2UgfHwgaXNGdW5jdGlvbihjdG9yKTsKCiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgY3RvciA9IGxvZGFzaFdyYXBwZXI7CiAgICAgICAgc291cmNlID0gb2JqZWN0OwogICAgICAgIG9iamVjdCA9IGxvZGFzaDsKICAgICAgfQogICAgICBmb3JFYWNoKGZ1bmN0aW9ucyhzb3VyY2UpLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIGZ1bmMgPSBvYmplY3RbbWV0aG9kTmFtZV0gPSBzb3VyY2VbbWV0aG9kTmFtZV07CiAgICAgICAgaWYgKGlzRnVuYykgewogICAgICAgICAgY3Rvci5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXywKICAgICAgICAgICAgICAgIGFyZ3MgPSBbdmFsdWVdOwoKICAgICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShvYmplY3QsIGFyZ3MpOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHZhbHVlID09PSByZXN1bHQpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgPSBuZXcgY3RvcihyZXN1bHQpOwogICAgICAgICAgICByZXN1bHQuX19jaGFpbl9fID0gdGhpcy5fX2NoYWluX187CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXZlcnRzIHRoZSAnXycgdmFyaWFibGUgdG8gaXRzIHByZXZpb3VzIHZhbHVlIGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvCiAgICAgKiB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsb2Rhc2ggPSBfLm5vQ29uZmxpY3QoKTsKICAgICAqLwogICAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgY29udGV4dC5fID0gb2xkRGFzaDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gdmFsdWUgaW50byBhbiBpbnRlZ2VyIG9mIHRoZSBzcGVjaWZpZWQgcmFkaXguCiAgICAgKiBJZiBgcmFkaXhgIGlzIGB1bmRlZmluZWRgIG9yIGAwYCBhIGByYWRpeGAgb2YgYDEwYCBpcyB1c2VkIHVubGVzcyB0aGUKICAgICAqIGB2YWx1ZWAgaXMgYSBoZXhhZGVjaW1hbCwgaW4gd2hpY2ggY2FzZSBhIGByYWRpeGAgb2YgYDE2YCBpcyB1c2VkLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGF2b2lkcyBkaWZmZXJlbmNlcyBpbiBuYXRpdmUgRVMzIGFuZCBFUzUgYHBhcnNlSW50YAogICAgICogaW1wbGVtZW50YXRpb25zLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI0UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFyc2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl4XSBUaGUgcmFkaXggdXNlZCB0byBpbnRlcnByZXQgdGhlIHZhbHVlIHRvIHBhcnNlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbmV3IGludGVnZXIgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFyc2VJbnQoJzA4Jyk7CiAgICAgKiAvLyA9PiA4CiAgICAgKi8KICAgIHZhciBwYXJzZUludCA9IG5hdGl2ZVBhcnNlSW50KHdoaXRlc3BhY2UgKyAnMDgnKSA9PSA4ID8gbmF0aXZlUGFyc2VJbnQgOiBmdW5jdGlvbih2YWx1ZSwgcmFkaXgpIHsKICAgICAgLy8gRmlyZWZveCBhbmQgT3BlcmEgc3RpbGwgZm9sbG93IHRoZSBFUzMgc3BlY2lmaWVkIGltcGxlbWVudGF0aW9uIG9mIGBwYXJzZUludGAKICAgICAgcmV0dXJuIG5hdGl2ZVBhcnNlSW50KGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnJlcGxhY2UocmVMZWFkaW5nU3BhY2VzQW5kWmVyb3MsICcnKSA6IHZhbHVlLCByYWRpeCB8fCAwKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBgbWluYCBhbmQgYG1heGAgKGluY2x1c2l2ZSkuIElmIG9ubHkgb25lCiAgICAgKiBhcmd1bWVudCBpcyBwcm92aWRlZCBhIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgdGhlIGdpdmVuIG51bWJlciB3aWxsIGJlCiAgICAgKiByZXR1cm5lZC4gSWYgYGZsb2F0aW5nYCBpcyB0cnVleSBvciBlaXRoZXIgYG1pbmAgb3IgYG1heGAgYXJlIGZsb2F0cyBhCiAgICAgKiBmbG9hdGluZy1wb2ludCBudW1iZXIgd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIGFuIGludGVnZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWluPTBdIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXg9MV0gVGhlIG1heGltdW0gcG9zc2libGUgdmFsdWUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmbG9hdGluZz1mYWxzZV0gU3BlY2lmeSByZXR1cm5pbmcgYSBmbG9hdGluZy1wb2ludCBudW1iZXIuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGEgcmFuZG9tIG51bWJlci4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yYW5kb20oMCwgNSk7CiAgICAgKiAvLyA9PiBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDUpOwogICAgICogLy8gPT4gYWxzbyBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDUsIHRydWUpOwogICAgICogLy8gPT4gYSBmbG9hdGluZy1wb2ludCBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICAgKgogICAgICogXy5yYW5kb20oMS4yLCA1LjIpOwogICAgICogLy8gPT4gYSBmbG9hdGluZy1wb2ludCBudW1iZXIgYmV0d2VlbiAxLjIgYW5kIDUuMgogICAgICovCiAgICBmdW5jdGlvbiByYW5kb20obWluLCBtYXgsIGZsb2F0aW5nKSB7CiAgICAgIHZhciBub01pbiA9IG1pbiA9PSBudWxsLAogICAgICAgICAgbm9NYXggPSBtYXggPT0gbnVsbDsKCiAgICAgIGlmIChmbG9hdGluZyA9PSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtaW4gPT0gJ2Jvb2xlYW4nICYmIG5vTWF4KSB7CiAgICAgICAgICBmbG9hdGluZyA9IG1pbjsKICAgICAgICAgIG1pbiA9IDE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCFub01heCAmJiB0eXBlb2YgbWF4ID09ICdib29sZWFuJykgewogICAgICAgICAgZmxvYXRpbmcgPSBtYXg7CiAgICAgICAgICBub01heCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChub01pbiAmJiBub01heCkgewogICAgICAgIG1heCA9IDE7CiAgICAgIH0KICAgICAgbWluID0gK21pbiB8fCAwOwogICAgICBpZiAobm9NYXgpIHsKICAgICAgICBtYXggPSBtaW47CiAgICAgICAgbWluID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXggPSArbWF4IHx8IDA7CiAgICAgIH0KICAgICAgdmFyIHJhbmQgPSBuYXRpdmVSYW5kb20oKTsKICAgICAgcmV0dXJuIChmbG9hdGluZyB8fCBtaW4gJSAxIHx8IG1heCAlIDEpCiAgICAgICAgPyBuYXRpdmVNaW4obWluICsgKHJhbmQgKiAobWF4IC0gbWluICsgcGFyc2VGbG9hdCgnMWUtJyArICgocmFuZCArJycpLmxlbmd0aCAtIDEpKSkpLCBtYXgpCiAgICAgICAgOiBtaW4gKyBmbG9vcihyYW5kICogKG1heCAtIG1pbiArIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSB2YWx1ZSBvZiBgcHJvcGVydHlgIG9uIGBvYmplY3RgLiBJZiBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24KICAgICAqIGl0IHdpbGwgYmUgaW52b2tlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiBgb2JqZWN0YCBhbmQgaXRzIHJlc3VsdCByZXR1cm5lZCwKICAgICAqIGVsc2UgdGhlIHByb3BlcnR5IHZhbHVlIGlzIHJldHVybmVkLiBJZiBgb2JqZWN0YCBpcyBmYWxzZXkgdGhlbiBgdW5kZWZpbmVkYAogICAgICogaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgdGhlIHZhbHVlIG9mLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgcmV0dXJuICdub25zZW5zZSc7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgICAqIC8vID0+ICdub25zZW5zZScKICAgICAqLwogICAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgICAqIHdoaXRlc3BhY2UsIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogICAgICoKICAgICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCwgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHByZWNvbXBpbGluZyB0ZW1wbGF0ZXMgc2VlOgogICAgICogaHR0cDovL2xvZGFzaC5jb20vI2N1c3RvbS1idWlsZHMKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBDaHJvbWUgZXh0ZW5zaW9uIHNhbmRib3hlcyBzZWU6CiAgICAgKiBodHRwOi8vZGV2ZWxvcGVyLmNocm9tZS5jb20vc3RhYmxlL2V4dGVuc2lvbnMvc2FuZGJveGluZ0V2YWwuaHRtbAogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGVtcGxhdGUgdGV4dC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuZXNjYXBlXSBUaGUgImVzY2FwZSIgZGVsaW1pdGVyLgogICAgICogQHBhcmFtIHtSZWdFeHB9IFtvcHRpb25zLmV2YWx1YXRlXSBUaGUgImV2YWx1YXRlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMuaW1wb3J0c10gQW4gb2JqZWN0IHRvIGltcG9ydCBpbnRvIHRoZSB0ZW1wbGF0ZSBhcyBsb2NhbCB2YXJpYWJsZXMuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuaW50ZXJwb2xhdGVdIFRoZSAiaW50ZXJwb2xhdGUiIGRlbGltaXRlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc291cmNlVVJMXSBUaGUgc291cmNlVVJMIG9mIHRoZSB0ZW1wbGF0ZSdzIGNvbXBpbGVkIHNvdXJjZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdmFyaWFibGVdIFRoZSBkYXRhIG9iamVjdCB2YXJpYWJsZSBuYW1lLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufHN0cmluZ30gUmV0dXJucyBhIGNvbXBpbGVkIGZ1bmN0aW9uIHdoZW4gbm8gYGRhdGFgIG9iamVjdAogICAgICogIGlzIGdpdmVuLCBlbHNlIGl0IHJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIgdG8gY3JlYXRlIGEgY29tcGlsZWQgdGVtcGxhdGUKICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+Jyk7CiAgICAgKiBjb21waWxlZCh7ICduYW1lJzogJ21vZScgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gbW9lJwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIgdG8gZXNjYXBlIEhUTUwgaW4gZGF0YSBwcm9wZXJ0eSB2YWx1ZXMKICAgICAqIF8udGVtcGxhdGUoJzxiPjwlLSB2YWx1ZSAlPjwvYj4nLCB7ICd2YWx1ZSc6ICc8c2NyaXB0PicgfSk7CiAgICAgKiAvLyA9PiAnPGI+Jmx0O3NjcmlwdCZndDs8L2I+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiZXZhbHVhdGUiIGRlbGltaXRlciB0byBnZW5lcmF0ZSBIVE1MCiAgICAgKiB2YXIgbGlzdCA9ICc8JSBfLmZvckVhY2gocGVvcGxlLCBmdW5jdGlvbihuYW1lKSB7ICU+PGxpPjwlLSBuYW1lICU+PC9saT48JSB9KTsgJT4nOwogICAgICogXy50ZW1wbGF0ZShsaXN0LCB7ICdwZW9wbGUnOiBbJ21vZScsICdsYXJyeSddIH0pOwogICAgICogLy8gPT4gJzxsaT5tb2U8L2xpPjxsaT5sYXJyeTwvbGk+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBFUzYgZGVsaW1pdGVyIGFzIGFuIGFsdGVybmF0aXZlIHRvIHRoZSBkZWZhdWx0ICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyCiAgICAgKiBfLnRlbXBsYXRlKCdoZWxsbyAkeyBuYW1lIH0nLCB7ICduYW1lJzogJ2N1cmx5JyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBjdXJseScKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGUoJzwlIHByaW50KCJoZWxsbyAiICsgbmFtZSk7ICU+IScsIHsgJ25hbWUnOiAnbGFycnknIH0pOwogICAgICogLy8gPT4gJ2hlbGxvIGxhcnJ5IScKICAgICAqCiAgICAgKiAvLyB1c2luZyBhIGN1c3RvbSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICAgKiBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICAgKiAgICdpbnRlcnBvbGF0ZSc6IC97eyhbXHNcU10rPyl9fS9nCiAgICAgKiB9OwogICAgICoKICAgICAqIF8udGVtcGxhdGUoJ2hlbGxvIHt7IG5hbWUgfX0hJywgeyAnbmFtZSc6ICdtdXN0YWNoZScgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gbXVzdGFjaGUhJwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgaW1wb3J0c2Agb3B0aW9uIHRvIGltcG9ydCBqUXVlcnkKICAgICAqIHZhciBsaXN0ID0gJzwlICQuZWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCUtIG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnbW9lJywgJ2xhcnJ5J10gfSwgeyAnaW1wb3J0cyc6IHsgJyQnOiBqUXVlcnkgfSB9KTsKICAgICAqIC8vID0+ICc8bGk+bW9lPC9saT48bGk+bGFycnk8L2xpPicKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZVVSTGAgb3B0aW9uIHRvIHNwZWNpZnkgYSBjdXN0b20gc291cmNlVVJMIGZvciB0aGUgdGVtcGxhdGUKICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+JywgbnVsbCwgeyAnc291cmNlVVJMJzogJy9iYXNpYy9ncmVldGluZy5qc3QnIH0pOwogICAgICogY29tcGlsZWQoZGF0YSk7CiAgICAgKiAvLyA9PiBmaW5kIHRoZSBzb3VyY2Ugb2YgImdyZWV0aW5nLmpzdCIgdW5kZXIgdGhlIFNvdXJjZXMgdGFiIG9yIFJlc291cmNlcyBwYW5lbCBvZiB0aGUgd2ViIGluc3BlY3RvcgogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgdmFyaWFibGVgIG9wdGlvbiB0byBlbnN1cmUgYSB3aXRoLXN0YXRlbWVudCBpc24ndCB1c2VkIGluIHRoZSBjb21waWxlZCB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGkgPCU9IGRhdGEubmFtZSAlPiEnLCBudWxsLCB7ICd2YXJpYWJsZSc6ICdkYXRhJyB9KTsKICAgICAqIGNvbXBpbGVkLnNvdXJjZTsKICAgICAqIC8vID0+IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAqICAgdmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlOwogICAgICogICBfX3AgKz0gJ2hpICcgKyAoKF9fdCA9ICggZGF0YS5uYW1lICkpID09IG51bGwgPyAnJyA6IF9fdCkgKyAnISc7CiAgICAgKiAgIHJldHVybiBfX3A7CiAgICAgKiB9CiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGBzb3VyY2VgIHByb3BlcnR5IHRvIGlubGluZSBjb21waWxlZCB0ZW1wbGF0ZXMgZm9yIG1lYW5pbmdmdWwKICAgICAqIC8vIGxpbmUgbnVtYmVycyBpbiBlcnJvciBtZXNzYWdlcyBhbmQgYSBzdGFjayB0cmFjZQogICAgICogZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oY3dkLCAnanN0LmpzJyksICdcCiAgICAgKiAgIHZhciBKU1QgPSB7XAogICAgICogICAgICJtYWluIjogJyArIF8udGVtcGxhdGUobWFpblRleHQpLnNvdXJjZSArICdcCiAgICAgKiAgIH07XAogICAgICogJyk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlbXBsYXRlKHRleHQsIGRhdGEsIG9wdGlvbnMpIHsKICAgICAgLy8gYmFzZWQgb24gSm9obiBSZXNpZydzIGB0bXBsYCBpbXBsZW1lbnRhdGlvbgogICAgICAvLyBodHRwOi8vZWpvaG4ub3JnL2Jsb2cvamF2YXNjcmlwdC1taWNyby10ZW1wbGF0aW5nLwogICAgICAvLyBhbmQgTGF1cmEgRG9rdG9yb3ZhJ3MgZG9ULmpzCiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9vbGFkby9kb1QKICAgICAgdmFyIHNldHRpbmdzID0gbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3M7CiAgICAgIHRleHQgfHwgKHRleHQgPSAnJyk7CgogICAgICAvLyBhdm9pZCBtaXNzaW5nIGRlcGVuZGVuY2llcyB3aGVuIGBpdGVyYXRvclRlbXBsYXRlYCBpcyBub3QgZGVmaW5lZAogICAgICBvcHRpb25zID0gZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldHRpbmdzKTsKCiAgICAgIHZhciBpbXBvcnRzID0gZGVmYXVsdHMoe30sIG9wdGlvbnMuaW1wb3J0cywgc2V0dGluZ3MuaW1wb3J0cyksCiAgICAgICAgICBpbXBvcnRzS2V5cyA9IGtleXMoaW1wb3J0cyksCiAgICAgICAgICBpbXBvcnRzVmFsdWVzID0gdmFsdWVzKGltcG9ydHMpOwoKICAgICAgdmFyIGlzRXZhbHVhdGluZywKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGludGVycG9sYXRlID0gb3B0aW9ucy5pbnRlcnBvbGF0ZSB8fCByZU5vTWF0Y2gsCiAgICAgICAgICBzb3VyY2UgPSAiX19wICs9ICciOwoKICAgICAgLy8gY29tcGlsZSB0aGUgcmVnZXhwIHRvIG1hdGNoIGVhY2ggZGVsaW1pdGVyCiAgICAgIHZhciByZURlbGltaXRlcnMgPSBSZWdFeHAoCiAgICAgICAgKG9wdGlvbnMuZXNjYXBlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgICBpbnRlcnBvbGF0ZS5zb3VyY2UgKyAnfCcgKwogICAgICAgIChpbnRlcnBvbGF0ZSA9PT0gcmVJbnRlcnBvbGF0ZSA/IHJlRXNUZW1wbGF0ZSA6IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgICAob3B0aW9ucy5ldmFsdWF0ZSB8fCByZU5vTWF0Y2gpLnNvdXJjZSArICd8JCcKICAgICAgLCAnZycpOwoKICAgICAgdGV4dC5yZXBsYWNlKHJlRGVsaW1pdGVycywgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZVZhbHVlLCBpbnRlcnBvbGF0ZVZhbHVlLCBlc1RlbXBsYXRlVmFsdWUsIGV2YWx1YXRlVmFsdWUsIG9mZnNldCkgewogICAgICAgIGludGVycG9sYXRlVmFsdWUgfHwgKGludGVycG9sYXRlVmFsdWUgPSBlc1RlbXBsYXRlVmFsdWUpOwoKICAgICAgICAvLyBlc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbm5vdCBiZSBpbmNsdWRlZCBpbiBzdHJpbmcgbGl0ZXJhbHMKICAgICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKHJlVW5lc2NhcGVkU3RyaW5nLCBlc2NhcGVTdHJpbmdDaGFyKTsKCiAgICAgICAgLy8gcmVwbGFjZSBkZWxpbWl0ZXJzIHdpdGggc25pcHBldHMKICAgICAgICBpZiAoZXNjYXBlVmFsdWUpIHsKICAgICAgICAgIHNvdXJjZSArPSAiJyArXG5fX2UoIiArIGVzY2FwZVZhbHVlICsgIikgK1xuJyI7CiAgICAgICAgfQogICAgICAgIGlmIChldmFsdWF0ZVZhbHVlKSB7CiAgICAgICAgICBpc0V2YWx1YXRpbmcgPSB0cnVlOwogICAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlVmFsdWUgKyAiO1xuX19wICs9ICciOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZXJwb2xhdGVWYWx1ZSkgewogICAgICAgICAgc291cmNlICs9ICInICtcbigoX190ID0gKCIgKyBpbnRlcnBvbGF0ZVZhbHVlICsgIikpID09IG51bGwgPyAnJyA6IF9fdCkgK1xuJyI7CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKICAgICAgICAvLyB0aGUgSlMgZW5naW5lIGVtYmVkZGVkIGluIEFkb2JlIHByb2R1Y3RzIHJlcXVpcmVzIHJldHVybmluZyB0aGUgYG1hdGNoYAogICAgICAgIC8vIHN0cmluZyBpbiBvcmRlciB0byBwcm9kdWNlIHRoZSBjb3JyZWN0IGBvZmZzZXRgIHZhbHVlCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICB9KTsKCiAgICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgICAvLyBpZiBgdmFyaWFibGVgIGlzIG5vdCBzcGVjaWZpZWQsIHdyYXAgYSB3aXRoLXN0YXRlbWVudCBhcm91bmQgdGhlIGdlbmVyYXRlZAogICAgICAvLyBjb2RlIHRvIGFkZCB0aGUgZGF0YSBvYmplY3QgdG8gdGhlIHRvcCBvZiB0aGUgc2NvcGUgY2hhaW4KICAgICAgdmFyIHZhcmlhYmxlID0gb3B0aW9ucy52YXJpYWJsZSwKICAgICAgICAgIGhhc1ZhcmlhYmxlID0gdmFyaWFibGU7CgogICAgICBpZiAoIWhhc1ZhcmlhYmxlKSB7CiAgICAgICAgdmFyaWFibGUgPSAnb2JqJzsKICAgICAgICBzb3VyY2UgPSAnd2l0aCAoJyArIHZhcmlhYmxlICsgJykge1xuJyArIHNvdXJjZSArICdcbn1cbic7CiAgICAgIH0KICAgICAgLy8gY2xlYW51cCBjb2RlIGJ5IHN0cmlwcGluZyBlbXB0eSBzdHJpbmdzCiAgICAgIHNvdXJjZSA9IChpc0V2YWx1YXRpbmcgPyBzb3VyY2UucmVwbGFjZShyZUVtcHR5U3RyaW5nTGVhZGluZywgJycpIDogc291cmNlKQogICAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdNaWRkbGUsICckMScpCiAgICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ1RyYWlsaW5nLCAnJDE7Jyk7CgogICAgICAvLyBmcmFtZSBjb2RlIGFzIHRoZSBmdW5jdGlvbiBib2R5CiAgICAgIHNvdXJjZSA9ICdmdW5jdGlvbignICsgdmFyaWFibGUgKyAnKSB7XG4nICsKICAgICAgICAoaGFzVmFyaWFibGUgPyAnJyA6IHZhcmlhYmxlICsgJyB8fCAoJyArIHZhcmlhYmxlICsgJyA9IHt9KTtcbicpICsKICAgICAgICAidmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlIiArCiAgICAgICAgKGlzRXZhbHVhdGluZwogICAgICAgICAgPyAnLCBfX2ogPSBBcnJheS5wcm90b3R5cGUuam9pbjtcbicgKwogICAgICAgICAgICAiZnVuY3Rpb24gcHJpbnQoKSB7IF9fcCArPSBfX2ouY2FsbChhcmd1bWVudHMsICcnKSB9XG4iCiAgICAgICAgICA6ICc7XG4nCiAgICAgICAgKSArCiAgICAgICAgc291cmNlICsKICAgICAgICAncmV0dXJuIF9fcFxufSc7CgogICAgICAvLyBVc2UgYSBzb3VyY2VVUkwgZm9yIGVhc2llciBkZWJ1Z2dpbmcuCiAgICAgIC8vIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgICAgdmFyIHNvdXJjZVVSTCA9ICdcbi8qXG4vLyMgc291cmNlVVJMPScgKyAob3B0aW9ucy5zb3VyY2VVUkwgfHwgJy9sb2Rhc2gvdGVtcGxhdGUvc291cmNlWycgKyAodGVtcGxhdGVDb3VudGVyKyspICsgJ10nKSArICdcbiovJzsKCiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IEZ1bmN0aW9uKGltcG9ydHNLZXlzLCAncmV0dXJuICcgKyBzb3VyY2UgKyBzb3VyY2VVUkwpLmFwcGx5KHVuZGVmaW5lZCwgaW1wb3J0c1ZhbHVlcyk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgICAgaWYgKGRhdGEpIHsKICAgICAgICByZXR1cm4gcmVzdWx0KGRhdGEpOwogICAgICB9CiAgICAgIC8vIHByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uJ3Mgc291cmNlIGJ5IGl0cyBgdG9TdHJpbmdgIG1ldGhvZCwgaW4KICAgICAgLy8gc3VwcG9ydGVkIGVudmlyb25tZW50cywgb3IgdGhlIGBzb3VyY2VgIHByb3BlcnR5IGFzIGEgY29udmVuaWVuY2UgZm9yCiAgICAgIC8vIGlubGluaW5nIGNvbXBpbGVkIHRlbXBsYXRlcyBkdXJpbmcgdGhlIGJ1aWxkIHByb2Nlc3MKICAgICAgcmVzdWx0LnNvdXJjZSA9IHNvdXJjZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEV4ZWN1dGVzIHRoZSBjYWxsYmFjayBgbmAgdGltZXMsIHJldHVybmluZyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cwogICAgICogb2YgZWFjaCBjYWxsYmFjayBleGVjdXRpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggb25lIGFyZ3VtZW50OyAoaW5kZXgpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGRpY2VSb2xscyA9IF8udGltZXMoMywgXy5wYXJ0aWFsKF8ucmFuZG9tLCAxLCA2KSk7CiAgICAgKiAvLyA9PiBbMywgNiwgNF0KICAgICAqCiAgICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgbWFnZS5jYXN0U3BlbGwobik7IH0pOwogICAgICogLy8gPT4gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcywgcGFzc2luZyBgbmAgb2YgYDBgLCBgMWAsIGFuZCBgMmAgcmVzcGVjdGl2ZWx5CiAgICAgKgogICAgICogXy50aW1lcygzLCBmdW5jdGlvbihuKSB7IHRoaXMuY2FzdChuKTsgfSwgbWFnZSk7CiAgICAgKiAvLyA9PiBhbHNvIGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMKICAgICAqLwogICAgZnVuY3Rpb24gdGltZXMobiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgbiA9IChuID0gK24pID4gLTEgPyBuIDogMDsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShuKTsKCiAgICAgIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBuKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNhbGxiYWNrKGluZGV4KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGludmVyc2Ugb2YgYF8uZXNjYXBlYCB0aGlzIG1ldGhvZCBjb252ZXJ0cyB0aGUgSFRNTCBlbnRpdGllcwogICAgICogYCZhbXA7YCwgYCZsdDtgLCBgJmd0O2AsIGAmcXVvdDtgLCBhbmQgYCYjMzk7YCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAgICogY29ycmVzcG9uZGluZyBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gdW5lc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuZXNjYXBlKCdNb2UsIExhcnJ5ICZhbXA7IEN1cmx5Jyk7CiAgICAgKiAvLyA9PiAnTW9lLCBMYXJyeSAmIEN1cmx5JwogICAgICovCiAgICBmdW5jdGlvbiB1bmVzY2FwZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyaW5nKS5yZXBsYWNlKHJlRXNjYXBlZEh0bWwsIHVuZXNjYXBlSHRtbENoYXIpOwogICAgfQoKICAgIC8qKgogICAgICogR2VuZXJhdGVzIGEgdW5pcXVlIElELiBJZiBgcHJlZml4YCBpcyBwcm92aWRlZCB0aGUgSUQgd2lsbCBiZSBhcHBlbmRlZCB0byBpdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtwcmVmaXhdIFRoZSB2YWx1ZSB0byBwcmVmaXggdGhlIElEIHdpdGguCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmlxdWUgSUQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pcXVlSWQoJ2NvbnRhY3RfJyk7CiAgICAgKiAvLyA9PiAnY29udGFjdF8xMDQnCiAgICAgKgogICAgICogXy51bmlxdWVJZCgpOwogICAgICogLy8gPT4gJzEwNScKICAgICAqLwogICAgZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CiAgICAgIHZhciBpZCA9ICsraWRDb3VudGVyOwogICAgICByZXR1cm4gU3RyaW5nKHByZWZpeCA9PSBudWxsID8gJycgOiBwcmVmaXgpICsgaWQ7CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0IHRoYXQgd3JhcHMgdGhlIGdpdmVuIHZhbHVlIHdpdGggZXhwbGljaXQKICAgICAqIG1ldGhvZCBjaGFpbmluZyBlbmFibGVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIHZhciB5b3VuZ2VzdCA9IF8uY2hhaW4oc3Rvb2dlcykKICAgICAqICAgICAuc29ydEJ5KCdhZ2UnKQogICAgICogICAgIC5tYXAoZnVuY3Rpb24oc3Rvb2dlKSB7IHJldHVybiBzdG9vZ2UubmFtZSArICcgaXMgJyArIHN0b29nZS5hZ2U7IH0pCiAgICAgKiAgICAgLmZpcnN0KCkKICAgICAqICAgICAudmFsdWUoKTsKICAgICAqIC8vID0+ICdtb2UgaXMgNDAnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoYWluKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gbmV3IGxvZGFzaFdyYXBwZXIodmFsdWUpOwogICAgICB2YWx1ZS5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZva2VzIGBpbnRlcmNlcHRvcmAgd2l0aCB0aGUgYHZhbHVlYCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgYW5kIHRoZW4KICAgICAqIHJldHVybnMgYHZhbHVlYC4gVGhlIHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZAogICAgICogY2hhaW4gaW4gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbgogICAgICogdGhlIGNoYWluLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHByb3ZpZGUgdG8gYGludGVyY2VwdG9yYC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGludGVyY2VwdG9yIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyBgdmFsdWVgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzLCA0XSkKICAgICAqICAuZmlsdGVyKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KQogICAgICogIC50YXAoZnVuY3Rpb24oYXJyYXkpIHsgY29uc29sZS5sb2coYXJyYXkpOyB9KQogICAgICogIC5tYXAoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiBudW07IH0pCiAgICAgKiAgLnZhbHVlKCk7CiAgICAgKiAvLyA9PiAvLyBbMiwgNF0gKGxvZ2dlZCkKICAgICAqIC8vID0+IFs0LCAxNl0KICAgICAqLwogICAgZnVuY3Rpb24gdGFwKHZhbHVlLCBpbnRlcmNlcHRvcikgewogICAgICBpbnRlcmNlcHRvcih2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgZXhwbGljaXQgbWV0aG9kIGNoYWluaW5nIG9uIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqCiAgICAgKiBAbmFtZSBjaGFpbgogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZXIgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHdpdGhvdXQgZXhwbGljaXQgY2hhaW5pbmcKICAgICAqIF8oc3Rvb2dlcykuZmlyc3QoKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgICAqCiAgICAgKiAvLyB3aXRoIGV4cGxpY2l0IGNoYWluaW5nCiAgICAgKiBfKHN0b29nZXMpLmNoYWluKCkKICAgICAqICAgLmZpcnN0KCkKICAgICAqICAgLnBpY2soJ2FnZScpCiAgICAgKiAgIC52YWx1ZSgpCiAgICAgKiAvLyA9PiB7ICdhZ2UnOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbmFtZSB0b1N0cmluZwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlc3VsdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLnRvU3RyaW5nKCk7CiAgICAgKiAvLyA9PiAnMSwyLDMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJUb1N0cmluZygpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLl9fd3JhcHBlZF9fKTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAgICoKICAgICAqIEBuYW1lIHZhbHVlT2YKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdmFsdWUKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICAgIHJldHVybiB0aGlzLl9fd3JhcHBlZF9fOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogICAgbG9kYXNoLmF0ID0gYXQ7CiAgICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgICBsb2Rhc2guYmluZEtleSA9IGJpbmRLZXk7CiAgICBsb2Rhc2guY2hhaW4gPSBjaGFpbjsKICAgIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICAgIGxvZGFzaC5jb21wb3NlID0gY29tcG9zZTsKICAgIGxvZGFzaC5jb3VudEJ5ID0gY291bnRCeTsKICAgIGxvZGFzaC5jcmVhdGVDYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrOwogICAgbG9kYXNoLmN1cnJ5ID0gY3Vycnk7CiAgICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgbG9kYXNoLmRlZmVyID0gZGVmZXI7CiAgICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICAgIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICAgIGxvZGFzaC5maWx0ZXIgPSBmaWx0ZXI7CiAgICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZm9yRWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgICBsb2Rhc2guZm9ySW5SaWdodCA9IGZvckluUmlnaHQ7CiAgICBsb2Rhc2guZm9yT3duID0gZm9yT3duOwogICAgbG9kYXNoLmZvck93blJpZ2h0ID0gZm9yT3duUmlnaHQ7CiAgICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLmdyb3VwQnkgPSBncm91cEJ5OwogICAgbG9kYXNoLmluZGV4QnkgPSBpbmRleEJ5OwogICAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogICAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICAgIGxvZGFzaC5pbnZlcnQgPSBpbnZlcnQ7CiAgICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogICAgbG9kYXNoLmtleXMgPSBrZXlzOwogICAgbG9kYXNoLm1hcCA9IG1hcDsKICAgIGxvZGFzaC5tYXggPSBtYXg7CiAgICBsb2Rhc2gubWVtb2l6ZSA9IG1lbW9pemU7CiAgICBsb2Rhc2gubWVyZ2UgPSBtZXJnZTsKICAgIGxvZGFzaC5taW4gPSBtaW47CiAgICBsb2Rhc2gub21pdCA9IG9taXQ7CiAgICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgICBsb2Rhc2gucGFpcnMgPSBwYWlyczsKICAgIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICAgIGxvZGFzaC5wYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHQ7CiAgICBsb2Rhc2gucGljayA9IHBpY2s7CiAgICBsb2Rhc2gucGx1Y2sgPSBwbHVjazsKICAgIGxvZGFzaC5wdWxsID0gcHVsbDsKICAgIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogICAgbG9kYXNoLnJlamVjdCA9IHJlamVjdDsKICAgIGxvZGFzaC5yZW1vdmUgPSByZW1vdmU7CiAgICBsb2Rhc2gucmVzdCA9IHJlc3Q7CiAgICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogICAgbG9kYXNoLnRhcCA9IHRhcDsKICAgIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogICAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgICBsb2Rhc2gudG9BcnJheSA9IHRvQXJyYXk7CiAgICBsb2Rhc2gudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogICAgbG9kYXNoLndoZXJlID0gd2hlcmU7CiAgICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgICBsb2Rhc2guemlwID0gemlwOwogICAgbG9kYXNoLnppcE9iamVjdCA9IHppcE9iamVjdDsKCiAgICAvLyBhZGQgYWxpYXNlcwogICAgbG9kYXNoLmNvbGxlY3QgPSBtYXA7CiAgICBsb2Rhc2guZHJvcCA9IHJlc3Q7CiAgICBsb2Rhc2guZWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmV4dGVuZCA9IGFzc2lnbjsKICAgIGxvZGFzaC5tZXRob2RzID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLm9iamVjdCA9IHppcE9iamVjdDsKICAgIGxvZGFzaC5zZWxlY3QgPSBmaWx0ZXI7CiAgICBsb2Rhc2gudGFpbCA9IHJlc3Q7CiAgICBsb2Rhc2gudW5pcXVlID0gdW5pcTsKICAgIGxvZGFzaC51bnppcCA9IHppcDsKCiAgICAvLyBhZGQgZnVuY3Rpb25zIHRvIGBsb2Rhc2gucHJvdG90eXBlYAogICAgbWl4aW4obG9kYXNoKTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmNsb25lID0gY2xvbmU7CiAgICBsb2Rhc2guY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogICAgbG9kYXNoLmNvbnRhaW5zID0gY29udGFpbnM7CiAgICBsb2Rhc2guZXNjYXBlID0gZXNjYXBlOwogICAgbG9kYXNoLmV2ZXJ5ID0gZXZlcnk7CiAgICBsb2Rhc2guZmluZCA9IGZpbmQ7CiAgICBsb2Rhc2guZmluZEluZGV4ID0gZmluZEluZGV4OwogICAgbG9kYXNoLmZpbmRLZXkgPSBmaW5kS2V5OwogICAgbG9kYXNoLmZpbmRMYXN0ID0gZmluZExhc3Q7CiAgICBsb2Rhc2guZmluZExhc3RJbmRleCA9IGZpbmRMYXN0SW5kZXg7CiAgICBsb2Rhc2guZmluZExhc3RLZXkgPSBmaW5kTGFzdEtleTsKICAgIGxvZGFzaC5oYXMgPSBoYXM7CiAgICBsb2Rhc2guaWRlbnRpdHkgPSBpZGVudGl0eTsKICAgIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICAgIGxvZGFzaC5pc0FyZ3VtZW50cyA9IGlzQXJndW1lbnRzOwogICAgbG9kYXNoLmlzQXJyYXkgPSBpc0FycmF5OwogICAgbG9kYXNoLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICAgIGxvZGFzaC5pc0RhdGUgPSBpc0RhdGU7CiAgICBsb2Rhc2guaXNFbGVtZW50ID0gaXNFbGVtZW50OwogICAgbG9kYXNoLmlzRW1wdHkgPSBpc0VtcHR5OwogICAgbG9kYXNoLmlzRXF1YWwgPSBpc0VxdWFsOwogICAgbG9kYXNoLmlzRmluaXRlID0gaXNGaW5pdGU7CiAgICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgICBsb2Rhc2guaXNOYU4gPSBpc05hTjsKICAgIGxvZGFzaC5pc051bGwgPSBpc051bGw7CiAgICBsb2Rhc2guaXNOdW1iZXIgPSBpc051bWJlcjsKICAgIGxvZGFzaC5pc09iamVjdCA9IGlzT2JqZWN0OwogICAgbG9kYXNoLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0OwogICAgbG9kYXNoLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgICBsb2Rhc2guaXNTdHJpbmcgPSBpc1N0cmluZzsKICAgIGxvZGFzaC5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogICAgbG9kYXNoLmxhc3RJbmRleE9mID0gbGFzdEluZGV4T2Y7CiAgICBsb2Rhc2gubWl4aW4gPSBtaXhpbjsKICAgIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICAgIGxvZGFzaC5wYXJzZUludCA9IHBhcnNlSW50OwogICAgbG9kYXNoLnJhbmRvbSA9IHJhbmRvbTsKICAgIGxvZGFzaC5yZWR1Y2UgPSByZWR1Y2U7CiAgICBsb2Rhc2gucmVkdWNlUmlnaHQgPSByZWR1Y2VSaWdodDsKICAgIGxvZGFzaC5yZXN1bHQgPSByZXN1bHQ7CiAgICBsb2Rhc2gucnVuSW5Db250ZXh0ID0gcnVuSW5Db250ZXh0OwogICAgbG9kYXNoLnNpemUgPSBzaXplOwogICAgbG9kYXNoLnNvbWUgPSBzb21lOwogICAgbG9kYXNoLnNvcnRlZEluZGV4ID0gc29ydGVkSW5kZXg7CiAgICBsb2Rhc2gudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgIGxvZGFzaC51bmVzY2FwZSA9IHVuZXNjYXBlOwogICAgbG9kYXNoLnVuaXF1ZUlkID0gdW5pcXVlSWQ7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC5hbGwgPSBldmVyeTsKICAgIGxvZGFzaC5hbnkgPSBzb21lOwogICAgbG9kYXNoLmRldGVjdCA9IGZpbmQ7CiAgICBsb2Rhc2guZmluZFdoZXJlID0gZmluZDsKICAgIGxvZGFzaC5mb2xkbCA9IHJlZHVjZTsKICAgIGxvZGFzaC5mb2xkciA9IHJlZHVjZVJpZ2h0OwogICAgbG9kYXNoLmluY2x1ZGUgPSBjb250YWluczsKICAgIGxvZGFzaC5pbmplY3QgPSByZWR1Y2U7CgogICAgZm9yT3duKGxvZGFzaCwgZnVuY3Rpb24oZnVuYywgbWV0aG9kTmFtZSkgewogICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl9fd3JhcHBlZF9fXSwKICAgICAgICAgICAgICBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fOwoKICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KGxvZGFzaCwgYXJncyk7CiAgICAgICAgICByZXR1cm4gY2hhaW5BbGwKICAgICAgICAgICAgPyBuZXcgbG9kYXNoV3JhcHBlcihyZXN1bHQsIGNoYWluQWxsKQogICAgICAgICAgICA6IHJlc3VsdDsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvLyBhZGQgZnVuY3Rpb25zIGNhcGFibGUgb2YgcmV0dXJuaW5nIHdyYXBwZWQgYW5kIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmZpcnN0ID0gZmlyc3Q7CiAgICBsb2Rhc2gubGFzdCA9IGxhc3Q7CiAgICBsb2Rhc2guc2FtcGxlID0gc2FtcGxlOwoKICAgIC8vIGFkZCBhbGlhc2VzCiAgICBsb2Rhc2gudGFrZSA9IGZpcnN0OwogICAgbG9kYXNoLmhlYWQgPSBmaXJzdDsKCiAgICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjYWxsYmFja2FibGUgPSBtZXRob2ROYW1lICE9PSAnc2FtcGxlJzsKICAgICAgaWYgKCFsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdKSB7CiAgICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXT0gZnVuY3Rpb24obiwgZ3VhcmQpIHsKICAgICAgICAgIHZhciBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fLAogICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmModGhpcy5fX3dyYXBwZWRfXywgbiwgZ3VhcmQpOwoKICAgICAgICAgIHJldHVybiAhY2hhaW5BbGwgJiYgKG4gPT0gbnVsbCB8fCAoZ3VhcmQgJiYgIShjYWxsYmFja2FibGUgJiYgdHlwZW9mIG4gPT0gJ2Z1bmN0aW9uJykpKQogICAgICAgICAgICA/IHJlc3VsdAogICAgICAgICAgICA6IG5ldyBsb2Rhc2hXcmFwcGVyKHJlc3VsdCwgY2hhaW5BbGwpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIHNlbWFudGljIHZlcnNpb24gbnVtYmVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBzdHJpbmcKICAgICAqLwogICAgbG9kYXNoLlZFUlNJT04gPSAnMi4yLjEnOwoKICAgIC8vIGFkZCAiQ2hhaW5pbmciIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlcgogICAgbG9kYXNoLnByb3RvdHlwZS5jaGFpbiA9IHdyYXBwZXJDaGFpbjsKICAgIGxvZGFzaC5wcm90b3R5cGUudG9TdHJpbmcgPSB3cmFwcGVyVG9TdHJpbmc7CiAgICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlID0gd3JhcHBlclZhbHVlT2Y7CiAgICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlT2YgPSB3cmFwcGVyVmFsdWVPZjsKCiAgICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdW53cmFwcGVkIHZhbHVlcwogICAgZm9yRWFjaChbJ2pvaW4nLCAncG9wJywgJ3NoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CgogICAgICAgIHJldHVybiBjaGFpbkFsbAogICAgICAgICAgPyBuZXcgbG9kYXNoV3JhcHBlcihyZXN1bHQsIGNoYWluQWxsKQogICAgICAgICAgOiByZXN1bHQ7CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdGhlIHdyYXBwZWQgdmFsdWUKICAgIGZvckVhY2goWydwdXNoJywgJ3JldmVyc2UnLCAnc29ydCcsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBuZXcgd3JhcHBlZCB2YWx1ZXMKICAgIGZvckVhY2goWydjb25jYXQnLCAnc2xpY2UnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgbG9kYXNoV3JhcHBlcihmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyksIHRoaXMuX19jaGFpbl9fKTsKICAgICAgfTsKICAgIH0pOwoKICAgIHJldHVybiBsb2Rhc2g7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gZXhwb3NlIExvLURhc2gKICB2YXIgXyA9IHJ1bkluQ29udGV4dCgpOwoKICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIHdhcyBpbmplY3RlZCBieSBhIHRoaXJkLXBhcnR5IHNjcmlwdCBhbmQgbm90IGludGVuZGVkIHRvIGJlCiAgICAvLyBsb2FkZWQgYXMgYSBtb2R1bGUuIFRoZSBnbG9iYWwgYXNzaWdubWVudCBjYW4gYmUgcmV2ZXJ0ZWQgaW4gdGhlIExvLURhc2gKICAgIC8vIG1vZHVsZSBieSBpdHMgYG5vQ29uZmxpY3QoKWAgbWV0aG9kLgogICAgcm9vdC5fID0gXzsKCiAgICAvLyBkZWZpbmUgYXMgYW4gYW5vbnltb3VzIG1vZHVsZSBzbywgdGhyb3VnaCBwYXRoIG1hcHBpbmcsIGl0IGNhbiBiZQogICAgLy8gcmVmZXJlbmNlZCBhcyB0aGUgInVuZGVyc2NvcmUiIG1vZHVsZQogICAgZGVmaW5lKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXzsKICAgIH0pOwogIH0KICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgZWxzZSBpZiAoZnJlZUV4cG9ydHMgJiYgZnJlZU1vZHVsZSkgewogICAgLy8gaW4gTm9kZS5qcyBvciBSaW5nb0pTCiAgICBpZiAobW9kdWxlRXhwb3J0cykgewogICAgICAoZnJlZU1vZHVsZS5leHBvcnRzID0gXykuXyA9IF87CiAgICB9CiAgICAvLyBpbiBOYXJ3aGFsIG9yIFJoaW5vIC1yZXF1aXJlCiAgICBlbHNlIHsKICAgICAgZnJlZUV4cG9ydHMuXyA9IF87CiAgICB9CiAgfQogIGVsc2UgewogICAgLy8gaW4gYSBicm93c2VyIG9yIFJoaW5vCiAgICByb290Ll8gPSBfOwogIH0KfS5jYWxsKHRoaXMpKTsKCi8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoKLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewoKICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICB9KTsKCiAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgogIC8vIEZpbmFsbHksIGFzIGEgYnJvd3NlciBnbG9iYWwuCiAgfSBlbHNlIHsKICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CiAgfQoKfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAvLyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSAkOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKICAgICAgaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIGlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CiAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKSBkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9OwoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCiAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CiAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwogICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CiAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSBvcHRpb25zOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9CiAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAogICAgICAgIF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8CiAgICAgICAgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKICAgIH0sCgogICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIE1vZGVsLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiBmYWxzZX07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgIC8vIHJlbW92aW5nIG1vZGVscyB0aGF0IGFyZSBubyBsb25nZXIgcHJlc2VudCwgYW5kIG1lcmdpbmcgbW9kZWxzIHRoYXQKICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAogICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICBzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucy5hdDsKICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwogICAgICB2YXIgb3JkZXIgPSAhc29ydGFibGUgJiYgYWRkICYmIHJlbW92ZSA/IFtdIDogZmFsc2U7CgogICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CiAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWQgPSBhdHRyc1t0YXJnZXRNb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUgfHwgJ2lkJ107CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CiAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgogICAgICAgIG1vZGVsID0gZXhpc3RpbmcgfHwgbW9kZWw7CiAgICAgICAgaWYgKG9yZGVyICYmIChtb2RlbC5pc05ldygpIHx8ICFtb2RlbE1hcFttb2RlbC5pZF0pKSBvcmRlci5wdXNoKG1vZGVsKTsKICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqXSB8fCB0aGlzLl9ieUlkW29iai5pZF0gfHwgdGhpcy5fYnlJZFtvYmouY2lkXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKSByZXR1cm4gbW9kZWw7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nLCAnc2FtcGxlJ107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknLCAnaW5kZXhCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0KICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIG5hbWUgPSAnJzsKICAgICAgfQogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgogICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW14vP10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyg/OlxcPyhbXFxzXFxTXSopKT8kJyk7CiAgICB9LAoKICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwogICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewogICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpIHJldHVybiBwYXJhbSB8fCBudWxsOwogICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwogICAgICB9KTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgogIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAogIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaC4KICB2YXIgcGF0aFN0cmlwcGVyID0gLyMuKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KICAgIGF0Um9vdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwogICAgfSwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwogICAgICAgIHRoaXMuaWZyYW1lID0gZnJhbWUuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwoKICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKICAgICAgLy8gcmVxdWVzdGVkLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgogICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAogICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgICAgaWYgKCF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIXRoaXMuYXRSb290KCkpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CiAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgogICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CiAgfTsKCiAgcmV0dXJuIEJhY2tib25lOwoKfSkpOwoKLy8gVmVjdG9yaXplci4KLy8gLS0tLS0tLS0tLS0KCi8vIEEgdGlueSBsaWJyYXJ5IGZvciBtYWtpbmcgeW91ciBsaXZlIGVhc2llciB3aGVuIGRlYWxpbmcgd2l0aCBTVkcuCgovLyBDb3B5cmlnaHQgwqkgMjAxMiAtIDIwMTQgY2xpZW50IElPIChodHRwOi8vY2xpZW50LmlvKQoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICAgICAgCiAgICB9IGVsc2UgewogICAgICAgIC8vIEJyb3dzZXIgZ2xvYmFscy4KICAgICAgICByb290LlZlY3Rvcml6ZXIgPSByb290LlYgPSBmYWN0b3J5KCk7CiAgICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKCkgewoKICAgIC8vIFdlbGwsIGlmIFNWRyBpcyBub3Qgc3VwcG9ydGVkLCB0aGlzIGxpYnJhcnkgaXMgdXNlbGVzcy4KICAgIHZhciBTVkdzdXBwb3J0ZWQgPSAhISh3aW5kb3cuU1ZHQW5nbGUgfHwgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uaGFzRmVhdHVyZSgnaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNCYXNpY1N0cnVjdHVyZScsICcxLjEnKSk7CgogICAgLy8gWE1MIG5hbWVzcGFjZXMuCiAgICB2YXIgbnMgPSB7CiAgICAgICAgeG1sbnM6ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsCiAgICAgICAgeGxpbms6ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJwogICAgfTsKICAgIC8vIFNWRyB2ZXJzaW9uLgogICAgdmFyIFNWR3ZlcnNpb24gPSAnMS4xJzsKCiAgICAvLyBBIGZ1bmN0aW9uIHJldHVybmluZyBhIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIGNsaWVudCBzZXNzaW9uIHdpdGggZXZlcnkgY2FsbC4KICAgIHZhciBpZENvdW50ZXIgPSAwOwogICAgZnVuY3Rpb24gdW5pcXVlSWQoKSB7CiAgICAgICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgICAgICByZXR1cm4gJ3YtJyArIGlkOwogICAgfQoKICAgIC8vIENyZWF0ZSBTVkcgZWxlbWVudC4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGVsLCBhdHRycywgY2hpbGRyZW4pIHsKCiAgICAgICAgaWYgKCFlbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAKICAgICAgICAvLyBJZiBgZWxgIGlzIGFuIG9iamVjdCwgaXQgaXMgcHJvYmFibHkgYSBuYXRpdmUgU1ZHIGVsZW1lbnQuIFdyYXAgaXQgdG8gVkVsZW1lbnQuCiAgICAgICAgaWYgKHR5cGVvZiBlbCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBWRWxlbWVudChlbCk7CiAgICAgICAgfQogICAgICAgIGF0dHJzID0gYXR0cnMgfHwge307CgogICAgICAgIC8vIElmIGBlbGAgaXMgYSBgJ3N2ZydgIG9yIGAnU1ZHJ2Agc3RyaW5nLCBjcmVhdGUgYSBuZXcgU1ZHIGNhbnZhcy4KICAgICAgICBpZiAoZWwudG9Mb3dlckNhc2UoKSA9PT0gJ3N2ZycpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF0dHJzLnhtbG5zID0gbnMueG1sbnM7CiAgICAgICAgICAgIGF0dHJzWyd4bWxuczp4bGluayddID0gbnMueGxpbms7CiAgICAgICAgICAgIGF0dHJzLnZlcnNpb24gPSBTVkd2ZXJzaW9uOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKGVsWzBdID09PSAnPCcpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGVsZW1lbnQgZnJvbSBhbiBTVkcgc3RyaW5nLgogICAgICAgICAgICAvLyBBbGxvd3MgY29uc3RydWN0cyBvZiB0eXBlOiBgZG9jdW1lbnQuYXBwZW5kQ2hpbGQoVmVjdG9yaXplcignPHJlY3Q+PC9yZWN0PicpLm5vZGUpYC4KICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBzdmcgPSAnPHN2ZyB4bWxucz0iJyArIG5zLnhtbG5zICsgJyIgeG1sbnM6eGxpbms9IicgKyBucy54bGluayArICciIHZlcnNpb249IicgKyBTVkd2ZXJzaW9uICsgJyI+JyArIGVsICsgJzwvc3ZnPic7CiAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICAgIHBhcnNlci5hc3luYyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgc3ZnRG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhzdmcsICd0ZXh0L3htbCcpLmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBgY3JlYXRlRWxlbWVudCgpYCBtaWdodCBhbHNvIHJldHVybiBhbiBhcnJheSBzaG91bGQgdGhlIFNWRyBzdHJpbmcgcGFzc2VkIGFzCiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBhcmd1bWVudCBjb250YWluIG1vcmUgdGhlbiBvbmUgcm9vdCBlbGVtZW50LgogICAgICAgICAgICBpZiAoc3ZnRG9jLmNoaWxkTm9kZXMubGVuZ3RoID4gMSkgewoKICAgICAgICAgICAgICAgIC8vIE1hcCBjaGlsZCBub2RlcyB0byBgVkVsZW1lbnRgcy4KICAgICAgICAgICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzdmdEb2MuY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gc3ZnRG9jLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2gobmV3IFZFbGVtZW50KGRvY3VtZW50LmltcG9ydE5vZGUoY2hpbGROb2RlLCB0cnVlKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG5ldyBWRWxlbWVudChkb2N1bWVudC5pbXBvcnROb2RlKHN2Z0RvYy5maXJzdENoaWxkLCB0cnVlKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5zLnhtbG5zLCBlbCk7CgogICAgICAgIC8vIFNldCBhdHRyaWJ1dGVzLgogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewoKICAgICAgICAgICAgc2V0QXR0cmlidXRlKGVsLCBrZXksIGF0dHJzW2tleV0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBOb3JtYWxpemUgYGNoaWxkcmVuYCBhcnJheS4KICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGNoaWxkcmVuKSAhPSAnW29iamVjdCBBcnJheV0nKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgogICAgICAgIC8vIEFwcGVuZCBjaGlsZHJlbiBpZiB0aGV5IGFyZSBzcGVjaWZpZWQuCiAgICAgICAgdmFyIGkgPSAwLCBsZW4gPSAoY2hpbGRyZW5bMF0gJiYgY2hpbGRyZW4ubGVuZ3RoKSB8fCAwLCBjaGlsZDsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGNoaWxkIGluc3RhbmNlb2YgVkVsZW1lbnQgPyBjaGlsZC5ub2RlIDogY2hpbGQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbmV3IFZFbGVtZW50KGVsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoZWwsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgCiAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignOicpID4gLTEpIHsKICAgICAgICAgICAgLy8gQXR0cmlidXRlIG5hbWVzIGNhbiBiZSBuYW1lc3BhY2VkLiBFLmcuIGBpbWFnZWAgZWxlbWVudHMKICAgICAgICAgICAgLy8gaGF2ZSBhIGB4bGluazpocmVmYCBhdHRyaWJ1dGUgdG8gc2V0IHRoZSBzb3VyY2Ugb2YgdGhlIGltYWdlLgogICAgICAgICAgICB2YXIgY29tYmluZWRLZXkgPSBuYW1lLnNwbGl0KCc6Jyk7CiAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZU5TKG5zW2NvbWJpbmVkS2V5WzBdXSwgY29tYmluZWRLZXlbMV0sIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICdpZCcpIHsKICAgICAgICAgICAgZWwuaWQgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVRyYW5zZm9ybVN0cmluZyh0cmFuc2Zvcm0pIHsKICAgICAgICB2YXIgdHJhbnNsYXRlLAogICAgICAgICAgICByb3RhdGUsCiAgICAgICAgICAgIHNjYWxlOwoKICAgICAgICBpZiAodHJhbnNmb3JtKSB7CgogICAgICAgICAgICB2YXIgc2VwYXJhdG9yID0gL1sgLF0rLzsKCiAgICAgICAgICAgIHZhciB0cmFuc2xhdGVNYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCgvdHJhbnNsYXRlXCgoLiopXCkvKTsKICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZU1hdGNoKSB7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSB0cmFuc2xhdGVNYXRjaFsxXS5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb3RhdGVNYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCgvcm90YXRlXCgoLiopXCkvKTsKICAgICAgICAgICAgaWYgKHJvdGF0ZU1hdGNoKSB7CiAgICAgICAgICAgICAgICByb3RhdGUgPSByb3RhdGVNYXRjaFsxXS5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzY2FsZU1hdGNoID0gdHJhbnNmb3JtLm1hdGNoKC9zY2FsZVwoKC4qKVwpLyk7CiAgICAgICAgICAgIGlmIChzY2FsZU1hdGNoKSB7CiAgICAgICAgICAgICAgICBzY2FsZSA9IHNjYWxlTWF0Y2hbMV0uc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHN4ID0gKHNjYWxlICYmIHNjYWxlWzBdKSA/IHBhcnNlRmxvYXQoc2NhbGVbMF0pIDogMTsKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2xhdGU6IHsKICAgICAgICAgICAgICAgIHR4OiAodHJhbnNsYXRlICYmIHRyYW5zbGF0ZVswXSkgPyBwYXJzZUludCh0cmFuc2xhdGVbMF0sIDEwKSA6IDAsCiAgICAgICAgICAgICAgICB0eTogKHRyYW5zbGF0ZSAmJiB0cmFuc2xhdGVbMV0pID8gcGFyc2VJbnQodHJhbnNsYXRlWzFdLCAxMCkgOiAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJvdGF0ZTogewogICAgICAgICAgICAgICAgYW5nbGU6IChyb3RhdGUgJiYgcm90YXRlWzBdKSA/IHBhcnNlSW50KHJvdGF0ZVswXSwgMTApIDogMCwKICAgICAgICAgICAgICAgIGN4OiAocm90YXRlICYmIHJvdGF0ZVsxXSkgPyBwYXJzZUludChyb3RhdGVbMV0sIDEwKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIGN5OiAocm90YXRlICYmIHJvdGF0ZVsyXSkgPyBwYXJzZUludChyb3RhdGVbMl0sIDEwKSA6IHVuZGVmaW5lZAogICAgICAgICAgICB9LAogICAgICAgICAgICBzY2FsZTogewogICAgICAgICAgICAgICAgc3g6IHN4LAogICAgICAgICAgICAgICAgc3k6IChzY2FsZSAmJiBzY2FsZVsxXSkgPyBwYXJzZUZsb2F0KHNjYWxlWzFdKSA6IHN4CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKCiAgICAvLyBNYXRyaXggZGVjb21wb3NpdGlvbi4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIGZ1bmN0aW9uIGRlbHRhVHJhbnNmb3JtUG9pbnQobWF0cml4LCBwb2ludCkgIHsKICAgICAgICAKCXZhciBkeCA9IHBvaW50LnggKiBtYXRyaXguYSArIHBvaW50LnkgKiBtYXRyaXguYyArIDA7Cgl2YXIgZHkgPSBwb2ludC54ICogbWF0cml4LmIgKyBwb2ludC55ICogbWF0cml4LmQgKyAwOwoJcmV0dXJuIHsgeDogZHgsIHk6IGR5IH07CiAgICB9CgogICAgZnVuY3Rpb24gZGVjb21wb3NlTWF0cml4KG1hdHJpeCkgewoKICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzIwNTIyNDcKICAgICAgICAKICAgICAgICAvLyBjYWxjdWxhdGUgZGVsdGEgdHJhbnNmb3JtIHBvaW50Cgl2YXIgcHggPSBkZWx0YVRyYW5zZm9ybVBvaW50KG1hdHJpeCwgeyB4OiAwLCB5OiAxIH0pOwoJdmFyIHB5ID0gZGVsdGFUcmFuc2Zvcm1Qb2ludChtYXRyaXgsIHsgeDogMSwgeTogMCB9KTsKICAgICAgICAKCS8vIGNhbGN1bGF0ZSBza2V3Cgl2YXIgc2tld1ggPSAoKDE4MCAvIE1hdGguUEkpICogTWF0aC5hdGFuMihweC55LCBweC54KSAtIDkwKTsKCXZhciBza2V3WSA9ICgoMTgwIC8gTWF0aC5QSSkgKiBNYXRoLmF0YW4yKHB5LnksIHB5LngpKTsKICAgICAgICAKCXJldHVybiB7CiAgICAgICAgICAgIAoJICAgIHRyYW5zbGF0ZVg6IG1hdHJpeC5lLAoJICAgIHRyYW5zbGF0ZVk6IG1hdHJpeC5mLAoJICAgIHNjYWxlWDogTWF0aC5zcXJ0KG1hdHJpeC5hICogbWF0cml4LmEgKyBtYXRyaXguYiAqIG1hdHJpeC5iKSwKCSAgICBzY2FsZVk6IE1hdGguc3FydChtYXRyaXguYyAqIG1hdHJpeC5jICsgbWF0cml4LmQgKiBtYXRyaXguZCksCgkgICAgc2tld1g6IHNrZXdYLAoJICAgIHNrZXdZOiBza2V3WSwKCSAgICByb3RhdGlvbjogc2tld1ggLy8gcm90YXRpb24gaXMgdGhlIHNhbWUgYXMgc2tldyB4Cgl9OwogICAgfQogICAgCiAgICAvLyBWRWxlbWVudC4KICAgIC8vIC0tLS0tLS0tLQoKICAgIGZ1bmN0aW9uIFZFbGVtZW50KGVsKSB7CiAgICAgICAgdGhpcy5ub2RlID0gZWw7CiAgICAgICAgaWYgKCF0aGlzLm5vZGUuaWQpIHsKICAgICAgICAgICAgdGhpcy5ub2RlLmlkID0gdW5pcXVlSWQoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVkVsZW1lbnQgcHVibGljIEFQSS4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgVkVsZW1lbnQucHJvdG90eXBlID0gewogICAgICAgIAogICAgICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24odHgsIHR5LCBvcHQpIHsKCiAgICAgICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKICAgICAgICAgICAgdHkgPSB0eSB8fCAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRyYW5zZm9ybUF0dHIgPSB0aGlzLmF0dHIoJ3RyYW5zZm9ybScpIHx8ICcnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtID0gcGFyc2VUcmFuc2Zvcm1TdHJpbmcodHJhbnNmb3JtQXR0cik7CgogICAgICAgICAgICAvLyBJcyBpdCBhIGdldHRlcj8KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2Zvcm0udHJhbnNsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2Zvcm1BdHRyID0gdHJhbnNmb3JtQXR0ci5yZXBsYWNlKC90cmFuc2xhdGVcKFteXCldKlwpL2csICcnKS50cmltKCk7CgogICAgICAgICAgICB2YXIgbmV3VHggPSBvcHQuYWJzb2x1dGUgPyB0eCA6IHRyYW5zZm9ybS50cmFuc2xhdGUudHggKyB0eCwKICAgICAgICAgICAgICAgIG5ld1R5ID0gb3B0LmFic29sdXRlID8gdHkgOiB0cmFuc2Zvcm0udHJhbnNsYXRlLnR5ICsgdHksCiAgICAgICAgICAgICAgICBuZXdUcmFuc2xhdGUgPSAndHJhbnNsYXRlKCcgKyBuZXdUeCArICcsJyArIG5ld1R5ICsgJyknOwoKICAgICAgICAgICAgLy8gTm90ZSB0aGF0IGB0cmFuc2xhdGUoKWAgaXMgYWx3YXlzIHRoZSBmaXJzdCB0cmFuc2Zvcm1hdGlvbi4gVGhpcyBpcwogICAgICAgICAgICAvLyB1c3VhbGx5IHRoZSBkZXNpcmVkIGNhc2UuCiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgKG5ld1RyYW5zbGF0ZSArICcgJyArIHRyYW5zZm9ybUF0dHIpLnRyaW0oKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHJvdGF0ZTogZnVuY3Rpb24oYW5nbGUsIGN4LCBjeSwgb3B0KSB7CgogICAgICAgICAgICBvcHQgPSBvcHQgfHwge307CgogICAgICAgICAgICB2YXIgdHJhbnNmb3JtQXR0ciA9IHRoaXMuYXR0cigndHJhbnNmb3JtJykgfHwgJycsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm0gPSBwYXJzZVRyYW5zZm9ybVN0cmluZyh0cmFuc2Zvcm1BdHRyKTsKCiAgICAgICAgICAgIC8vIElzIGl0IGEgZ2V0dGVyPwogICAgICAgICAgICBpZiAodHlwZW9mIGFuZ2xlID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybS5yb3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRyYW5zZm9ybUF0dHIgPSB0cmFuc2Zvcm1BdHRyLnJlcGxhY2UoL3JvdGF0ZVwoW15cKV0qXCkvZywgJycpLnRyaW0oKTsKCiAgICAgICAgICAgIGFuZ2xlICU9IDM2MDsKCiAgICAgICAgICAgIHZhciBuZXdBbmdsZSA9IG9wdC5hYnNvbHV0ZSA/IGFuZ2xlOiB0cmFuc2Zvcm0ucm90YXRlLmFuZ2xlICsgYW5nbGUsCiAgICAgICAgICAgICAgICBuZXdPcmlnaW4gPSAoY3ggIT09IHVuZGVmaW5lZCAmJiBjeSAhPT0gdW5kZWZpbmVkKSA/ICcsJyArIGN4ICsgJywnICsgY3kgOiAnJywKICAgICAgICAgICAgICAgIG5ld1JvdGF0ZSA9ICdyb3RhdGUoJyArIG5ld0FuZ2xlICsgbmV3T3JpZ2luICsgJyknOwoKICAgICAgICAgICAgdGhpcy5hdHRyKCd0cmFuc2Zvcm0nLCAodHJhbnNmb3JtQXR0ciArICcgJyArIG5ld1JvdGF0ZSkudHJpbSgpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZSB0aGF0IGBzY2FsZWAgYXMgdGhlIG9ubHkgdHJhbnNmb3JtYXRpb24gZG9lcyBub3QgY29tYmluZSB3aXRoIHByZXZpb3VzIHZhbHVlcy4KICAgICAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5KSB7CiAgICAgICAgICAgIHN5ID0gKHR5cGVvZiBzeSA9PT0gJ3VuZGVmaW5lZCcpID8gc3ggOiBzeTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB0cmFuc2Zvcm1BdHRyID0gdGhpcy5hdHRyKCd0cmFuc2Zvcm0nKSB8fCAnJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybSA9IHBhcnNlVHJhbnNmb3JtU3RyaW5nKHRyYW5zZm9ybUF0dHIpOwoKICAgICAgICAgICAgLy8gSXMgaXQgYSBnZXR0ZXI/CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3ggPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJhbnNmb3JtLnNjYWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2Zvcm1BdHRyID0gdHJhbnNmb3JtQXR0ci5yZXBsYWNlKC9zY2FsZVwoW15cKV0qXCkvZywgJycpLnRyaW0oKTsKCiAgICAgICAgICAgIHZhciBuZXdTY2FsZSA9ICdzY2FsZSgnICsgc3ggKyAnLCcgKyBzeSArICcpJzsKCiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgKHRyYW5zZm9ybUF0dHIgKyAnICcgKyBuZXdTY2FsZSkudHJpbSgpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gR2V0IFNWR1JlY3QgdGhhdCBjb250YWlucyBjb29yZGluYXRlcyBhbmQgZGltZW5zaW9uIG9mIHRoZSByZWFsIGJvdW5kaW5nIGJveCwKICAgICAgICAvLyBpLmUuIGFmdGVyIHRyYW5zZm9ybWF0aW9ucyBhcmUgYXBwbGllZC4KICAgICAgICAvLyBJZiBgdGFyZ2V0YCBpcyBzcGVjaWZpZWQsIGJvdW5kaW5nIGJveCB3aWxsIGJlIGNvbXB1dGVkIHJlbGF0aXZlbHkgdG8gYHRhcmdldGAgZWxlbWVudC4KICAgICAgICBiYm94OiBmdW5jdGlvbih3aXRob3V0VHJhbnNmb3JtYXRpb25zLCB0YXJnZXQpIHsKCiAgICAgICAgICAgIC8vIElmIHRoZSBlbGVtZW50IGlzIG5vdCBpbiB0aGUgbGl2ZSBET00sIGl0IGRvZXMgbm90IGhhdmUgYSBib3VuZGluZyBib3ggZGVmaW5lZCBhbmQKICAgICAgICAgICAgLy8gc28gZmFsbCBiYWNrIHRvICd6ZXJvJyBkaW1lbnNpb24gZWxlbWVudC4KICAgICAgICAgICAgaWYgKCF0aGlzLm5vZGUub3duZXJTVkdFbGVtZW50KSByZXR1cm4geyB4OiAwLCB5OiAwLCB3aWR0aDogMCwgaGVpZ2h0OiAwIH07CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgYm94OwogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICAgIGJveCA9IHRoaXMubm9kZS5nZXRCQm94KCk7CgoJCS8vIE9wZXJhIHJldHVybnMgaW5maW5pdGUgdmFsdWVzIGluIHNvbWUgY2FzZXMuCgkJLy8gTm90ZSB0aGF0IEluZmluaXR5IHwgMCBwcm9kdWNlcyAwIGFzIG9wcG9zZWQgdG8gSW5maW5pdHkgfHwgMC4KCQkvLyBXZSBhbHNvIGhhdmUgdG8gY3JlYXRlIG5ldyBvYmplY3QgYXMgdGhlIHN0YW5kYXJkIHNheXMgdGhhdCB5b3UgY2FuJ3QKCQkvLyBtb2RpZnkgdGhlIGF0dHJpYnV0ZXMgb2YgYSBiYm94LgoJCWJveCA9IHsgeDogYm94LnggfCAwLCB5OiBib3gueSB8IDAsIHdpZHRoOiBib3gud2lkdGggfCAwLCBoZWlnaHQ6IGJveC5oZWlnaHQgfCAwfTsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBmb3IgSUUuCiAgICAgICAgICAgICAgICBib3ggPSB7CiAgICAgICAgICAgICAgICAgICAgeDogdGhpcy5ub2RlLmNsaWVudExlZnQsCiAgICAgICAgICAgICAgICAgICAgeTogdGhpcy5ub2RlLmNsaWVudFRvcCwKICAgICAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5ub2RlLmNsaWVudFdpZHRoLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5ub2RlLmNsaWVudEhlaWdodAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHdpdGhvdXRUcmFuc2Zvcm1hdGlvbnMpIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gYm94OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWF0cml4ID0gdGhpcy5ub2RlLmdldFRyYW5zZm9ybVRvRWxlbWVudCh0YXJnZXQgfHwgdGhpcy5ub2RlLm93bmVyU1ZHRWxlbWVudCk7CiAgICAgICAgICAgIHZhciBjb3JuZXJzID0gW107CiAgICAgICAgICAgIHZhciBwb2ludCA9IHRoaXMubm9kZS5vd25lclNWR0VsZW1lbnQuY3JlYXRlU1ZHUG9pbnQoKTsKCgogICAgICAgICAgICBwb2ludC54ID0gYm94Lng7CiAgICAgICAgICAgIHBvaW50LnkgPSBib3gueTsKICAgICAgICAgICAgY29ybmVycy5wdXNoKHBvaW50Lm1hdHJpeFRyYW5zZm9ybShtYXRyaXgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHBvaW50LnggPSBib3gueCArIGJveC53aWR0aDsKICAgICAgICAgICAgcG9pbnQueSA9IGJveC55OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcG9pbnQueCA9IGJveC54ICsgYm94LndpZHRoOwogICAgICAgICAgICBwb2ludC55ID0gYm94LnkgKyBib3guaGVpZ2h0OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcG9pbnQueCA9IGJveC54OwogICAgICAgICAgICBwb2ludC55ID0gYm94LnkgKyBib3guaGVpZ2h0OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwoKICAgICAgICAgICAgdmFyIG1pblggPSBjb3JuZXJzWzBdLng7CiAgICAgICAgICAgIHZhciBtYXhYID0gbWluWDsKICAgICAgICAgICAgdmFyIG1pblkgPSBjb3JuZXJzWzBdLnk7CiAgICAgICAgICAgIHZhciBtYXhZID0gbWluWTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBjb3JuZXJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciB4ID0gY29ybmVyc1tpXS54OwogICAgICAgICAgICAgICAgdmFyIHkgPSBjb3JuZXJzW2ldLnk7CgogICAgICAgICAgICAgICAgaWYgKHggPCBtaW5YKSB7CiAgICAgICAgICAgICAgICAgICAgbWluWCA9IHg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHggPiBtYXhYKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4WCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh5IDwgbWluWSkgewogICAgICAgICAgICAgICAgICAgIG1pblkgPSB5OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5ID4gbWF4WSkgewogICAgICAgICAgICAgICAgICAgIG1heFkgPSB5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgeDogbWluWCwKICAgICAgICAgICAgICAgIHk6IG1pblksCiAgICAgICAgICAgICAgICB3aWR0aDogbWF4WCAtIG1pblgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IG1heFkgLSBtaW5ZCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogZnVuY3Rpb24oY29udGVudCwgb3B0KSB7CgoJICAgIG9wdCA9IG9wdCB8fCB7fTsKICAgICAgICAgICAgdmFyIGxpbmVzID0gY29udGVudC5zcGxpdCgnXG4nKTsKCSAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciB0c3BhbjsKCiAgICAgICAgICAgIC8vIGBhbGlnbm1lbnQtYmFzZWxpbmVgIGRvZXMgbm90IHdvcmsgaW4gRmlyZWZveC4KCSAgICAvLyBTZXR0aW5nIGBkb21pbmFudC1iYXNlbGluZWAgb24gdGhlIGA8dGV4dD5gIGVsZW1lbnQgZG9lc24ndCB3b3JrIGluIElFOS4KICAgICAgICAgICAgLy8gSW4gb3JkZXIgdG8gaGF2ZSB0aGUgMCwwIGNvb3JkaW5hdGUgb2YgdGhlIGA8dGV4dD5gIGVsZW1lbnQgKG9yIHRoZSBmaXJzdCBgPHRzcGFuPmApCgkgICAgLy8gaW4gdGhlIHRvcCBsZWZ0IGNvcm5lciB3ZSB0cmFuc2xhdGUgdGhlIGA8dGV4dD5gIGVsZW1lbnQgYnkgYDAuOGVtYC4KCSAgICAvLyBTZWUgYGh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy9XRy93aWtpL0hvd190b19kZXRlcm1pbmVfZG9taW5hbnRfYmFzZWxpbmVgLgoJICAgIC8vIFNlZSBhbHNvIGBodHRwOi8vYXBpa2UuY2EvcHJvZ19zdmdfdGV4dF9zdHlsZS5odG1sYC4KCSAgICB0aGlzLmF0dHIoJ3knLCAnMC44ZW0nKTsKCiAgICAgICAgICAgIC8vIEFuIGVtcHR5IHRleHQgZ2V0cyByZW5kZXJlZCBpbnRvIHRoZSBET00gaW4gd2Via2l0LWJhc2VkIGJyb3dzZXJzLgogICAgICAgICAgICAvLyBJbiBvcmRlciB0byB1bmlmeSB0aGlzIGJlaGF2aW91ciBhY3Jvc3MgYWxsIGJyb3dzZXJzCiAgICAgICAgICAgIC8vIHdlIHJhdGhlciBoaWRlIHRoZSB0ZXh0IGVsZW1lbnQgd2hlbiBpdCdzIGVtcHR5LgogICAgICAgICAgICB0aGlzLmF0dHIoJ2Rpc3BsYXknLCBjb250ZW50ID8gbnVsbCA6ICdub25lJyk7CgoJICAgIC8vIFByZXNlcnZlIHNwYWNlcy4gSW4gb3RoZXIgd29yZHMsIHdlIGRvIG5vdCB3YW50IGNvbnNlY3V0aXZlIHNwYWNlcyB0byBnZXQgY29sbGFwc2VkIHRvIG9uZS4KCSAgICB0aGlzLm5vZGUuc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsICJ4bWw6c3BhY2UiLCJwcmVzZXJ2ZSIpOwoKICAgICAgICAgICAgaWYgKGxpbmVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5ub2RlLnRleHRDb250ZW50ID0gY29udGVudDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEVhc3kgd2F5IHRvIGVyYXNlIGFsbCBgPHRzcGFuPmAgY2hpbGRyZW47CiAgICAgICAgICAgIHRoaXMubm9kZS50ZXh0Q29udGVudCA9ICcnOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yICg7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGFsbCB0aGUgPHRzcGFuPiBidXQgZmlyc3QgYnkgb25lIGxpbmUgKGAxZW1gKQogICAgICAgICAgICAgICAgdHNwYW4gPSBWKCd0c3BhbicsIHsgZHk6IChpID09IDAgPyAnMGVtJyA6IG9wdC5saW5lSGVpZ2h0IHx8ICcxZW0nKSwgeDogdGhpcy5hdHRyKCd4JykgfHwgMH0pOwoJCS8vIE1ha2Ugc3VyZSB0aGUgdGV4dENvbnRlbnQgaXMgbmV2ZXIgZW1wdHkuIElmIGl0IGlzLCBhZGQgYW4gYWRkaXRpb25hbCAKCQkvLyBzcGFjZSAoYW4gaW52aXNpYmxlIGNoYXJhY3Rlcikgc28gdGhhdCBmb2xsb3dpbmcgbGluZXMgYXJlIGNvcnJlY3RseQoJCS8vIHJlbGF0aXZlbHkgcG9zaXRpb25lZC4gYGR5PTFlbWAgd29uJ3Qgd29yayB3aXRoIGVtcHR5IGxpbmVzIG90aGVyd2lzZS4KICAgICAgICAgICAgICAgIHRzcGFuLm5vZGUudGV4dENvbnRlbnQgPSBsaW5lc1tpXSB8fCAnICc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kKHRzcGFuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGF0dHI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ck5hbWUgaW4gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLmhhc093blByb3BlcnR5KGF0dHJOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRBdHRyaWJ1dGUodGhpcy5ub2RlLCBhdHRyTmFtZSwgbmFtZVthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHNldEF0dHJpYnV0ZSh0aGlzLm5vZGUsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMubm9kZS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLm5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYXBwZW5kOiBmdW5jdGlvbihlbCkgewoKICAgICAgICAgICAgdmFyIGVscyA9IGVsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlbCkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxzID0gW2VsXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGVscy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgZWwgPSBlbHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQoZWwgaW5zdGFuY2VvZiBWRWxlbWVudCA/IGVsLm5vZGUgOiBlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHRoaXMubm9kZS5pbnNlcnRCZWZvcmUoZWwgaW5zdGFuY2VvZiBWRWxlbWVudCA/IGVsLm5vZGUgOiBlbCwgdGhpcy5ub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0sCgogICAgICAgIHN2ZzogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5ub2RlIGluc3RhbmNlb2Ygd2luZG93LlNWR1NWR0VsZW1lbnQgPyB0aGlzIDogVih0aGlzLm5vZGUub3duZXJTVkdFbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICBkZWZzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBkZWZzID0gdGhpcy5zdmcoKS5ub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkZWZzJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gKGRlZnMgJiYgZGVmcy5sZW5ndGgpID8gVihkZWZzWzBdKSA6IHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IFYodGhpcy5ub2RlLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBjbG9uZSBpbmhlcml0cyBhbHNvIElELiBUaGVyZWZvcmUsIHdlIG5lZWQgdG8gY2hhbmdlIGl0IGhlcmUuCiAgICAgICAgICAgIGNsb25lLm5vZGUuaWQgPSB1bmlxdWVJZCgpOwogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgfSwKCiAgICAgICAgZmluZE9uZTogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBmb3VuZCA9IHRoaXMubm9kZS5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgICAgICAgICAgcmV0dXJuIGZvdW5kID8gVihmb3VuZCkgOiB1bmRlZmluZWQ7CiAgICAgICAgfSwKCiAgICAgICAgZmluZDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBub2RlcyA9IHRoaXMubm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKCiAgICAgICAgICAgIC8vIE1hcCBET00gZWxlbWVudHMgdG8gYFZFbGVtZW50YHMuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBub2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgbm9kZXNbaV0gPSBWKG5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZXM7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvLyBDb252ZXJ0IGdsb2JhbCBwb2ludCBpbnRvIHRoZSBjb29yZGluYXRlIHNwYWNlIG9mIHRoaXMgZWxlbWVudC4KICAgICAgICB0b0xvY2FsUG9pbnQ6IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgICAgIHZhciBzdmcgPSB0aGlzLnN2ZygpLm5vZGU7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcCA9IHN2Zy5jcmVhdGVTVkdQb2ludCgpOwogICAgICAgICAgICBwLnggPSB4OwogICAgICAgICAgICBwLnkgPSB5OwoKCSAgICB0cnkgewoKCQl2YXIgZ2xvYmFsUG9pbnQgPSBwLm1hdHJpeFRyYW5zZm9ybShzdmcuZ2V0U2NyZWVuQ1RNKCkuaW52ZXJzZSgpKTsKCQl2YXIgZ2xvYmFsVG9Mb2NhbE1hdHJpeCA9IHRoaXMubm9kZS5nZXRUcmFuc2Zvcm1Ub0VsZW1lbnQoc3ZnKS5pbnZlcnNlKCk7CgoJICAgIH0gY2F0Y2goZSkgewoJCS8vIElFOSB0aHJvd3MgYW4gZXhjZXB0aW9uIGluIG9kZCBjYXNlcy4gKGBVbmV4cGVjdGVkIGNhbGwgdG8gbWV0aG9kIG9yIHByb3BlcnR5IGFjY2Vzc2ApCgkJLy8gV2UgaGF2ZSB0byBtYWtlIGRvIHdpdGggdGhlIG9yaWdpbmFsIGNvb3JkaWFuYXRlcy4KCQlyZXR1cm4gcDsKCSAgICB9CgogICAgICAgICAgICByZXR1cm4gZ2xvYmFsUG9pbnQubWF0cml4VHJhbnNmb3JtKGdsb2JhbFRvTG9jYWxNYXRyaXgpOwogICAgICAgIH0sCgogICAgICAgIHRyYW5zbGF0ZUNlbnRlclRvUG9pbnQ6IGZ1bmN0aW9uKHApIHsKCiAgICAgICAgICAgIHZhciBiYm94ID0gdGhpcy5iYm94KCk7CiAgICAgICAgICAgIHZhciBjZW50ZXIgPSBnLnJlY3QoYmJveCkuY2VudGVyKCk7CgogICAgICAgICAgICB0aGlzLnRyYW5zbGF0ZShwLnggLSBjZW50ZXIueCwgcC55IC0gY2VudGVyLnkpOwogICAgICAgIH0sCgogICAgICAgIC8vIEVmZmljaWVudGx5IGF1dG8tb3JpZW50IGFuIGVsZW1lbnQuIFRoaXMgYmFzaWNhbGx5IGltcGxlbWVudHMgdGhlIG9yaWVudD1hdXRvIGF0dHJpYnV0ZQogICAgICAgIC8vIG9mIG1hcmtlcnMuIFRoZSBlYXNpZXN0IHdheSBvZiB1bmRlcnN0YW5kaW5nIG9uIHdoYXQgdGhpcyBkb2VzIGlzIHRvIGltYWdpbmUgdGhlIGVsZW1lbnQgaXMgYW4KICAgICAgICAvLyBhcnJvd2hlYWQuIENhbGxpbmcgdGhpcyBtZXRob2Qgb24gdGhlIGFycm93aGVhZCBtYWtlcyBpdCBwb2ludCB0byB0aGUgYHBvc2l0aW9uYCBwb2ludCB3aGlsZQogICAgICAgIC8vIGJlaW5nIGF1dG8tb3JpZW50ZWQgKHByb3Blcmx5IHJvdGF0ZWQpIHRvd2FyZHMgdGhlIGByZWZlcmVuY2VgIHBvaW50LgogICAgICAgIC8vIGB0YXJnZXRgIGlzIHRoZSBlbGVtZW50IHJlbGF0aXZlIHRvIHdoaWNoIHRoZSB0cmFuc2Zvcm1hdGlvbnMgYXJlIGFwcGxpZWQuIFVzdWFsbHkgYSB2aWV3cG9ydC4KICAgICAgICB0cmFuc2xhdGVBbmRBdXRvT3JpZW50OiBmdW5jdGlvbihwb3NpdGlvbiwgcmVmZXJlbmNlLCB0YXJnZXQpIHsKCiAgICAgICAgICAgIC8vIENsZWFuLXVwIHByZXZpb3VzbHkgc2V0IHRyYW5zZm9ybWF0aW9ucyBleGNlcHQgdGhlIHNjYWxlLiBJZiB3ZSBkaWRuJ3QgY2xlYW4gdXAgdGhlCiAgICAgICAgICAgIC8vIHByZXZpb3VzIHRyYW5zZm9ybWF0aW9ucyB0aGVuIHRoZXknZCBhZGQgdXAgd2l0aCB0aGUgb2xkIG9uZXMuIFNjYWxlIGlzIGFuIGV4Y2VwdGlvbiBhcwogICAgICAgICAgICAvLyBpdCBkb2Vzbid0IGFkZCB1cCwgY29uc2lkZXI6IGB0aGlzLnNjYWxlKDIpLnNjYWxlKDIpLnNjYWxlKDIpYC4gVGhlIHJlc3VsdCBpcyB0aGF0IHRoZQogICAgICAgICAgICAvLyBlbGVtZW50IGlzIHNjYWxlZCBieSB0aGUgZmFjdG9yIDIsIG5vdCA4LgoKICAgICAgICAgICAgdmFyIHMgPSB0aGlzLnNjYWxlKCk7CiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgJycpOwogICAgICAgICAgICB0aGlzLnNjYWxlKHMuc3gsIHMuc3kpOwoKICAgICAgICAgICAgdmFyIHN2ZyA9IHRoaXMuc3ZnKCkubm9kZTsKICAgICAgICAgICAgdmFyIGJib3ggPSB0aGlzLmJib3goZmFsc2UsIHRhcmdldCk7CgogICAgICAgICAgICAvLyAxLiBUcmFuc2xhdGUgdG8gb3JpZ2luLgogICAgICAgICAgICB2YXIgdHJhbnNsYXRlVG9PcmlnaW4gPSBzdmcuY3JlYXRlU1ZHVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZVRvT3JpZ2luLnNldFRyYW5zbGF0ZSgtYmJveC54IC0gYmJveC53aWR0aC8yLCAtYmJveC55IC0gYmJveC5oZWlnaHQvMik7CgogICAgICAgICAgICAvLyAyLiBSb3RhdGUgYXJvdW5kIG9yaWdpbi4KICAgICAgICAgICAgdmFyIHJvdGF0ZUFyb3VuZE9yaWdpbiA9IHN2Zy5jcmVhdGVTVkdUcmFuc2Zvcm0oKTsKICAgICAgICAgICAgdmFyIGFuZ2xlID0gZy5wb2ludChwb3NpdGlvbikuY2hhbmdlSW5BbmdsZShwb3NpdGlvbi54IC0gcmVmZXJlbmNlLngsIHBvc2l0aW9uLnkgLSByZWZlcmVuY2UueSwgcmVmZXJlbmNlKTsKICAgICAgICAgICAgcm90YXRlQXJvdW5kT3JpZ2luLnNldFJvdGF0ZShhbmdsZSwgMCwgMCk7CgogICAgICAgICAgICAvLyAzLiBUcmFuc2xhdGUgdG8gdGhlIGBwb3NpdGlvbmAgKyB0aGUgb2Zmc2V0IChoYWxmIG15IHdpZHRoKSB0b3dhcmRzIHRoZSBgcmVmZXJlbmNlYCBwb2ludC4KICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZUZpbmFsID0gc3ZnLmNyZWF0ZVNWR1RyYW5zZm9ybSgpOwogICAgICAgICAgICB2YXIgZmluYWxQb3NpdGlvbiA9IGcucG9pbnQocG9zaXRpb24pLm1vdmUocmVmZXJlbmNlLCBiYm94LndpZHRoLzIpOwogICAgICAgICAgICB0cmFuc2xhdGVGaW5hbC5zZXRUcmFuc2xhdGUocG9zaXRpb24ueCArIChwb3NpdGlvbi54IC0gZmluYWxQb3NpdGlvbi54KSwgcG9zaXRpb24ueSArIChwb3NpdGlvbi55IC0gZmluYWxQb3NpdGlvbi55KSk7CgogICAgICAgICAgICAvLyA0LiBBcHBseSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICAgIHZhciBjdG0gPSB0aGlzLm5vZGUuZ2V0VHJhbnNmb3JtVG9FbGVtZW50KHRhcmdldCk7CiAgICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSBzdmcuY3JlYXRlU1ZHVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIHRyYW5zZm9ybS5zZXRNYXRyaXgoCiAgICAgICAgICAgICAgICB0cmFuc2xhdGVGaW5hbC5tYXRyaXgubXVsdGlwbHkoCiAgICAgICAgICAgICAgICAgICAgcm90YXRlQXJvdW5kT3JpZ2luLm1hdHJpeC5tdWx0aXBseSgKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlVG9PcmlnaW4ubWF0cml4Lm11bHRpcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RtKSkpCiAgICAgICAgICAgICk7CgogICAgICAgICAgICAvLyBJbnN0ZWFkIG9mIGRpcmVjdGx5IHNldHRpbmcgdGhlIGBtYXRyaXgoKWAgdHJhbnNmb3JtIG9uIHRoZSBlbGVtZW50LCBmaXJzdCwgZGVjb21wb3NlCiAgICAgICAgICAgIC8vIHRoZSBtYXRyaXggaW50byBzZXBhcmF0ZSB0cmFuc2Zvcm1zLiBUaGlzIGFsbG93cyB1cyB0byB1c2Ugbm9ybWFsIFZlY3Rvcml6ZXIgbWV0aG9kcwogICAgICAgICAgICAvLyBhcyB0aGV5IGRvbid0IHdvcmsgb24gbWF0cmljZXMuIEFuIGV4YW1wbGUgb2YgdGhpcyBpcyB0byByZXRyaWV2ZSBhIHNjYWxlIG9mIGFuIGVsZW1lbnQuCiAgICAgICAgICAgIC8vIHRoaXMubm9kZS50cmFuc2Zvcm0uYmFzZVZhbC5pbml0aWFsaXplKHRyYW5zZm9ybSk7CgogICAgICAgICAgICB2YXIgZGVjb21wb3NpdGlvbiA9IGRlY29tcG9zZU1hdHJpeCh0cmFuc2Zvcm0ubWF0cml4KTsKCiAgICAgICAgICAgIHRoaXMudHJhbnNsYXRlKGRlY29tcG9zaXRpb24udHJhbnNsYXRlWCwgZGVjb21wb3NpdGlvbi50cmFuc2xhdGVZKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGUoZGVjb21wb3NpdGlvbi5yb3RhdGlvbik7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBzY2FsZSBoYXMgYmVlbiBhbHJlYWR5IGFwcGxpZWQsIGhlbmNlIHRoZSBmb2xsb3dpbmcgbGluZSBzdGF5cyBjb21tZW50ZWQuIChpdCdzIGhlcmUganVzdCBmb3IgcmVmZXJlbmNlKS4KICAgICAgICAgICAgLy90aGlzLnNjYWxlKGRlY29tcG9zaXRpb24uc2NhbGVYLCBkZWNvbXBvc2l0aW9uLnNjYWxlWSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBhbmltYXRlQWxvbmdQYXRoOiBmdW5jdGlvbihhdHRycywgcGF0aCkgewoKICAgICAgICAgICAgdmFyIGFuaW1hdGVNb3Rpb24gPSBWKCdhbmltYXRlTW90aW9uJywgYXR0cnMpOwogICAgICAgICAgICB2YXIgbXBhdGggPSBWKCdtcGF0aCcsIHsgJ3hsaW5rOmhyZWYnOiAnIycgKyBWKHBhdGgpLm5vZGUuaWQgfSk7CgogICAgICAgICAgICBhbmltYXRlTW90aW9uLmFwcGVuZChtcGF0aCk7CgogICAgICAgICAgICB0aGlzLmFwcGVuZChhbmltYXRlTW90aW9uKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGFuaW1hdGVNb3Rpb24ubm9kZS5iZWdpbkVsZW1lbnQoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgZm9yIElFIDkuCgkJLy8gUnVuIHRoZSBhbmltYXRpb24gcHJvZ3JhbWF0aWNhbGx5IGlmIEZha2VTbWlsZSAoYGh0dHA6Ly9sZXVuZW4ubWUvZmFrZXNtaWxlL2ApIHByZXNlbnQgCgkJaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NtaWxpbmcnKSA9PT0gJ2Zha2UnKSB7CgoJCSAgICAvLyBSZWdpc3RlciB0aGUgYW5pbWF0aW9uLiAoU2VlIGBodHRwczovL2Fuc3dlcnMubGF1bmNocGFkLm5ldC9zbWlsLytxdWVzdGlvbi8yMDMzMzNgKQoJCSAgICB2YXIgYW5pbWF0aW9uID0gYW5pbWF0ZU1vdGlvbi5ub2RlOwoJCSAgICBhbmltYXRpb24uYW5pbWF0b3JzID0gW107CgoJCSAgICB2YXIgYW5pbWF0aW9uSUQgPSBhbmltYXRpb24uZ2V0QXR0cmlidXRlKCdpZCcpOwoJCSAgICBpZiAoYW5pbWF0aW9uSUQpIGlkMmFuaW1bYW5pbWF0aW9uSURdID0gYW5pbWF0aW9uOwoKICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0cyA9IGdldFRhcmdldHMoYW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGFyZ2V0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGFyZ2V0c1tpXTsKCQkJdmFyIGFuaW1hdG9yID0gbmV3IEFuaW1hdG9yKGFuaW1hdGlvbiwgdGFyZ2V0LCBpKTsKCQkJYW5pbWF0b3JzLnB1c2goYW5pbWF0b3IpOwoJCQlhbmltYXRpb24uYW5pbWF0b3JzW2ldID0gYW5pbWF0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdG9yLnJlZ2lzdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQoJCX0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpIHsKCiAgICAgICAgICAgIHJldHVybiBuZXcgUmVnRXhwKCcoXFxzfF4pJyArIGNsYXNzTmFtZSArICcoXFxzfCQpJykudGVzdCh0aGlzLm5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpKTsKICAgICAgICB9LAoKICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZDbGFzc2VzID0gdGhpcy5ub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJzsKICAgICAgICAgICAgICAgIHRoaXMubm9kZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKHByZXZDbGFzc2VzICsgJyAnICsgY2xhc3NOYW1lKS50cmltKCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IHRoaXMubm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykucmVwbGFjZShuZXcgUmVnRXhwKCcoXFxzfF4pJyArIGNsYXNzTmFtZSArICcoXFxzfCQpJywgJ2cnKSwgJyQyJyk7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUuc2V0QXR0cmlidXRlKCdjbGFzcycsIG5ld0NsYXNzZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lLCB0b0FkZCkgewoKICAgICAgICAgICAgdmFyIHRvUmVtb3ZlID0gdHlwZW9mIHRvQWRkID09PSAndW5kZWZpbmVkJyA/IHRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSA6ICF0b0FkZDsKCiAgICAgICAgICAgIGlmICh0b1JlbW92ZSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIENvbnZlcnQgYSByZWN0YW5nbGUgdG8gU1ZHIHBhdGggY29tbWFuZHMuIGByYCBpcyBhbiBvYmplY3Qgb2YgdGhlIGZvcm06CiAgICAvLyBgeyB4OiBbbnVtYmVyXSwgeTogW251bWJlcl0sIHdpZHRoOiBbbnVtYmVyXSwgaGVpZ2h0OiBbbnVtYmVyXSwgdG9wLXJ5OiBbbnVtYmVyXSwgdG9wLXJ5OiBbbnVtYmVyXSwgYm90dG9tLXJ4OiBbbnVtYmVyXSwgYm90dG9tLXJ5OiBbbnVtYmVyXSB9YCwKICAgIC8vIHdoZXJlIGB4LCB5LCB3aWR0aCwgaGVpZ2h0YCBhcmUgdGhlIHVzdWFsIHJlY3RhbmdsZSBhdHRyaWJ1dGVzIGFuZCBbdG9wLS9ib3R0b20tXXJ4L3J5IGFsbG93cyBmb3IKICAgIC8vIHNwZWNpZnlpbmcgcmFkaXVzIG9mIHRoZSByZWN0YW5nbGUgZm9yIGFsbCBpdHMgc2lkZXMgKGFzIG9wcG9zZWQgdG8gdGhlIGJ1aWx0LWluIFNWRyByZWN0YW5nbGUKICAgIC8vIHRoYXQgaGFzIG9ubHkgYHJ4YCBhbmQgYHJ5YCBhdHRyaWJ1dGVzKS4KICAgIGZ1bmN0aW9uIHJlY3RUb1BhdGgocikgewoKICAgICAgICB2YXIgdG9wUnggPSByLnJ4IHx8IHJbJ3RvcC1yeCddIHx8IDA7CiAgICAgICAgdmFyIGJvdHRvbVJ4ID0gci5yeCB8fCByWydib3R0b20tcngnXSB8fCAwOwogICAgICAgIHZhciB0b3BSeSA9IHIucnkgfHwgclsndG9wLXJ5J10gfHwgMDsKICAgICAgICB2YXIgYm90dG9tUnkgPSByLnJ5IHx8IHJbJ2JvdHRvbS1yeSddIHx8IDA7CgogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICdNJywgci54LCByLnkgKyB0b3BSeSwKICAgICAgICAgICAgJ3YnLCByLmhlaWdodCAtIHRvcFJ5IC0gYm90dG9tUnksCiAgICAgICAgICAgICdhJywgYm90dG9tUngsIGJvdHRvbVJ5LCAwLCAwLCAwLCBib3R0b21SeCwgYm90dG9tUnksCiAgICAgICAgICAgICdoJywgci53aWR0aCAtIDIgKiBib3R0b21SeCwKICAgICAgICAgICAgJ2EnLCBib3R0b21SeCwgYm90dG9tUnksIDAsIDAsIDAsIGJvdHRvbVJ4LCAtYm90dG9tUnksCiAgICAgICAgICAgICd2JywgLShyLmhlaWdodCAtIGJvdHRvbVJ5IC0gdG9wUnkpLAogICAgICAgICAgICAnYScsIHRvcFJ4LCB0b3BSeSwgMCwgMCwgMCwgLXRvcFJ4LCAtdG9wUnksCiAgICAgICAgICAgICdoJywgLShyLndpZHRoIC0gMiAqIHRvcFJ4KSwKICAgICAgICAgICAgJ2EnLCB0b3BSeCwgdG9wUnksIDAsIDAsIDAsIC10b3BSeCwgdG9wUnkKICAgICAgICBdLmpvaW4oJyAnKTsKICAgIH0KCiAgICB2YXIgViA9IGNyZWF0ZUVsZW1lbnQ7CgogICAgVi5kZWNvbXBvc2VNYXRyaXggPSBkZWNvbXBvc2VNYXRyaXg7CiAgICBWLnJlY3RUb1BhdGggPSByZWN0VG9QYXRoOwoKICAgIHZhciBzdmdEb2N1bWVudCA9IFYoJ3N2ZycpLm5vZGU7CiAgICAKICAgIFYuY3JlYXRlU1ZHTWF0cml4ID0gZnVuY3Rpb24obSkgewoKICAgICAgICB2YXIgc3ZnTWF0cml4ID0gc3ZnRG9jdW1lbnQuY3JlYXRlU1ZHTWF0cml4KCk7CiAgICAgICAgZm9yICh2YXIgY29tcG9uZW50IGluIG0pIHsKICAgICAgICAgICAgc3ZnTWF0cml4W2NvbXBvbmVudF0gPSBtW2NvbXBvbmVudF07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBzdmdNYXRyaXg7CiAgICB9OwoKICAgIFYuY3JlYXRlU1ZHVHJhbnNmb3JtID0gZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiBzdmdEb2N1bWVudC5jcmVhdGVTVkdUcmFuc2Zvcm0oKTsKICAgIH07CgogICAgVi5jcmVhdGVTVkdQb2ludCA9IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgdmFyIHAgPSBzdmdEb2N1bWVudC5jcmVhdGVTVkdQb2ludCgpOwogICAgICAgIHAueCA9IHg7CiAgICAgICAgcC55ID0geTsKICAgICAgICByZXR1cm4gcDsKICAgIH07CgogICAgcmV0dXJuIFY7Cgp9KSk7CgoKLy8gICAgICBHZW9tZXRyeSBsaWJyYXJ5LgovLyAgICAgIChjKSAyMDExLTIwMTMgY2xpZW50IElPCgoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICAgICAgCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIE5vZGUuIERvZXMgbm90IHdvcmsgd2l0aCBzdHJpY3QgQ29tbW9uSlMsIGJ1dAogICAgICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgdGhhdCBzdXBwb3J0IG1vZHVsZS5leHBvcnRzLAogICAgICAgIC8vIGxpa2UgTm9kZS4KICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgICAgICAKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzLgogICAgICAgIHJvb3QuZyA9IGZhY3RvcnkoKTsKICAgIH0KCn0odGhpcywgZnVuY3Rpb24oKSB7CgoKICAgIC8vIERlY2xhcmUgc2hvcnRoYW5kcyB0byB0aGUgbW9zdCB1c2VkIG1hdGggZnVuY3Rpb25zLgogICAgdmFyIG1hdGggPSBNYXRoOwogICAgdmFyIGFicyA9IG1hdGguYWJzOwogICAgdmFyIGNvcyA9IG1hdGguY29zOwogICAgdmFyIHNpbiA9IG1hdGguc2luOwogICAgdmFyIHNxcnQgPSBtYXRoLnNxcnQ7CiAgICB2YXIgbW1pbiA9IG1hdGgubWluOwogICAgdmFyIG1tYXggPSBtYXRoLm1heDsKICAgIHZhciBhdGFuID0gbWF0aC5hdGFuOwogICAgdmFyIGF0YW4yID0gbWF0aC5hdGFuMjsKICAgIHZhciBhY29zID0gbWF0aC5hY29zOwogICAgdmFyIHJvdW5kID0gbWF0aC5yb3VuZDsKICAgIHZhciBmbG9vciA9IG1hdGguZmxvb3I7CiAgICB2YXIgUEkgPSBtYXRoLlBJOwogICAgdmFyIHJhbmRvbSA9IG1hdGgucmFuZG9tOwogICAgdmFyIHRvRGVnID0gZnVuY3Rpb24ocmFkKSB7IHJldHVybiAoMTgwKnJhZCAvIFBJKSAlIDM2MDsgfTsKICAgIHZhciB0b1JhZCA9IGZ1bmN0aW9uKGRlZykgeyByZXR1cm4gKGRlZyAlIDM2MCkgKiBQSSAvIDE4MDsgfTsKICAgIHZhciBzbmFwVG9HcmlkID0gZnVuY3Rpb24odmFsLCBncmlkU2l6ZSkgeyByZXR1cm4gZ3JpZFNpemUgKiBNYXRoLnJvdW5kKHZhbC9ncmlkU2l6ZSk7IH07CiAgICB2YXIgbm9ybWFsaXplQW5nbGUgPSBmdW5jdGlvbihhbmdsZSkgeyByZXR1cm4gKGFuZ2xlICUgMzYwKSArIChhbmdsZSA8IDAgPyAzNjAgOiAwKTsgfTsKCiAgICAvLyBQb2ludAogICAgLy8gLS0tLS0KCiAgICAvLyBQb2ludCBpcyB0aGUgbW9zdCBiYXNpYyBvYmplY3QgY29uc2lzdGluZyBvZiB4L3kgY29vcmRpbmF0ZSwuCgogICAgLy8gUG9zc2libGUgaW5zdGFudGlhdGlvbnMgYXJlOgoKICAgIC8vICogYHBvaW50KDEwLCAyMClgCiAgICAvLyAqIGBuZXcgcG9pbnQoMTAsIDIwKWAKICAgIC8vICogYHBvaW50KCcxMCAyMCcpYAogICAgLy8gKiBgcG9pbnQocG9pbnQoMTAsIDIwKSlgCiAgICBmdW5jdGlvbiBwb2ludCh4LCB5KSB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIHBvaW50KSkKICAgICAgICAgICAgcmV0dXJuIG5ldyBwb2ludCh4LCB5KTsKICAgICAgICB2YXIgeHk7CiAgICAgICAgaWYgKHkgPT09IHVuZGVmaW5lZCAmJiBPYmplY3QoeCkgIT09IHgpIHsKICAgICAgICAgICAgeHkgPSB4LnNwbGl0KHguaW5kZXhPZignQCcpID09PSAtMSA/ICcgJyA6ICdAJyk7CiAgICAgICAgICAgIHRoaXMueCA9IHBhcnNlSW50KHh5WzBdLCAxMCk7CiAgICAgICAgICAgIHRoaXMueSA9IHBhcnNlSW50KHh5WzFdLCAxMCk7CiAgICAgICAgfSBlbHNlIGlmIChPYmplY3QoeCkgPT09IHgpIHsKICAgICAgICAgICAgdGhpcy54ID0geC54OwogICAgICAgICAgICB0aGlzLnkgPSB4Lnk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy54ID0geDsKICAgICAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB9CiAgICB9CgogICAgcG9pbnQucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMueCArICJAIiArIHRoaXMueTsKICAgICAgICB9LAogICAgICAgIC8vIElmIHBvaW50IGxpZXMgb3V0c2lkZSByZWN0YW5nbGUgYHJgLCByZXR1cm4gdGhlIG5lYXJlc3QgcG9pbnQgb24gdGhlIGJvdW5kYXJ5IG9mIHJlY3QgYHJgLAogICAgICAgIC8vIG90aGVyd2lzZSByZXR1cm4gcG9pbnQgaXRzZWxmLgogICAgICAgIC8vIChzZWUgU3F1ZWFrIFNtYWxsdGFsaywgUG9pbnQ+PmFkaGVyZVRvOikKICAgICAgICBhZGhlcmVUb1JlY3Q6IGZ1bmN0aW9uKHIpIHsKCSAgICBpZiAoci5jb250YWluc1BvaW50KHRoaXMpKXsKCSAgICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfQoJICAgIHRoaXMueCA9IG1taW4obW1heCh0aGlzLngsIHIueCksIHIueCArIHIud2lkdGgpOwoJICAgIHRoaXMueSA9IG1taW4obW1heCh0aGlzLnksIHIueSksIHIueSArIHIuaGVpZ2h0KTsKCSAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENvbXB1dGUgdGhlIGFuZ2xlIGJldHdlZW4gbWUgYW5kIGBwYCBhbmQgdGhlIHggYXhpcy4KICAgICAgICAvLyAoY2FydGVzaWFuLXRvLXBvbGFyIGNvb3JkaW5hdGVzIGNvbnZlcnNpb24pCiAgICAgICAgLy8gUmV0dXJuIHRoZXRhIGFuZ2xlIGluIGRlZ3JlZXMuCiAgICAgICAgdGhldGE6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwogICAgICAgICAgICAvLyBJbnZlcnQgdGhlIHktYXhpcy4KCSAgICB2YXIgeSA9IC0ocC55IC0gdGhpcy55KTsKCSAgICB2YXIgeCA9IHAueCAtIHRoaXMueDsKICAgICAgICAgICAgLy8gTWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wYXJpc29uIHdpdGggemVybyB0YWtlcyByb3VuZGluZyBlcnJvcnMgaW50byBhY2NvdW50LgogICAgICAgICAgICB2YXIgUFJFQ0lTSU9OID0gMTA7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBgYXRhbjJgIGlzIG5vdCBkZWZpbmVkIGZvciBgeGAsIGB5YCBib3RoIGVxdWFsIHplcm8uCgkgICAgdmFyIHJhZCA9ICh5LnRvRml4ZWQoUFJFQ0lTSU9OKSA9PSAwICYmIHgudG9GaXhlZChQUkVDSVNJT04pID09IDApID8gMCA6IGF0YW4yKHksIHgpOyAKCiAgICAgICAgICAgIC8vIENvcnJlY3Rpb24gZm9yIElJSS4gYW5kIElWLiBxdWFkcmFudC4KCSAgICBpZiAocmFkIDwgMCkgeyAKCSAgICAgICAgcmFkID0gMipQSSArIHJhZDsKCSAgICB9CgkgICAgcmV0dXJuIDE4MCpyYWQgLyBQSTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgZGlzdGFuY2UgYmV0d2VlbiBtZSBhbmQgcG9pbnQgYHBgLgogICAgICAgIGRpc3RhbmNlOiBmdW5jdGlvbihwKSB7CgkgICAgcmV0dXJuIGxpbmUodGhpcywgcCkubGVuZ3RoKCk7CiAgICAgICAgfSwKICAgICAgICAvLyBSZXR1cm5zIGEgbWFuaGF0dGFuICh0YXhpLWNhYikgZGlzdGFuY2UgYmV0d2VlbiBtZSBhbmQgcG9pbnQgYHBgLgogICAgICAgIG1hbmhhdHRhbkRpc3RhbmNlOiBmdW5jdGlvbihwKSB7CiAgICAgICAgICAgIHJldHVybiBhYnMocC54IC0gdGhpcy54KSArIGFicyhwLnkgLSB0aGlzLnkpOwogICAgICAgIH0sCiAgICAgICAgLy8gT2Zmc2V0IG1lIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgogICAgICAgIG9mZnNldDogZnVuY3Rpb24oZHgsIGR5KSB7CgkgICAgdGhpcy54ICs9IGR4IHx8IDA7CgkgICAgdGhpcy55ICs9IGR5IHx8IDA7CgkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBtYWduaXR1ZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gc3FydCgodGhpcy54KnRoaXMueCkgKyAodGhpcy55KnRoaXMueSkpIHx8IDAuMDE7CiAgICAgICAgfSwKICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAgICAgICAgdGhpcy54ID0geCB8fCAwOwogICAgICAgICAgICB0aGlzLnkgPSB5IHx8IDA7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgcm91bmQ6IGZ1bmN0aW9uKGRlY2ltYWxzKSB7CiAgICAgICAgICAgIHRoaXMueCA9IGRlY2ltYWxzID8gdGhpcy54LnRvRml4ZWQoZGVjaW1hbHMpIDogcm91bmQodGhpcy54KTsKICAgICAgICAgICAgdGhpcy55ID0gZGVjaW1hbHMgPyB0aGlzLnkudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLnkpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFNjYWxlIHRoZSBsaW5lIHNlZ21lbnQgYmV0d2VlbiAoMCwwKSBhbmQgbWUgdG8gaGF2ZSBhIGxlbmd0aCBvZiBsZW4uCiAgICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbihsZW4pIHsKCSAgICB2YXIgcyA9IChsZW4gfHwgMSkgLyB0aGlzLm1hZ25pdHVkZSgpOwoJICAgIHRoaXMueCA9IHMgKiB0aGlzLng7CgkgICAgdGhpcy55ID0gcyAqIHRoaXMueTsKCSAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGRpZmZlcmVuY2U6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCAtIHAueCwgdGhpcy55IC0gcC55KTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybiB0aGUgYmVhcmluZyBiZXR3ZWVuIG1lIGFuZCBwb2ludCBgcGAuCiAgICAgICAgYmVhcmluZzogZnVuY3Rpb24ocCkgewogICAgICAgICAgICByZXR1cm4gbGluZSh0aGlzLCBwKS5iZWFyaW5nKCk7CiAgICAgICAgfSwgICAgICAgIAogICAgICAgIC8vIENvbnZlcnRzIHJlY3Rhbmd1bGFyIHRvIHBvbGFyIGNvb3JkaW5hdGVzLgogICAgICAgIC8vIEFuIG9yaWdpbiBjYW4gYmUgc3BlY2lmaWVkLCBvdGhlcndpc2UgaXQncyAwQDAuCiAgICAgICAgdG9Qb2xhcjogZnVuY3Rpb24obykgewogICAgICAgICAgICBvID0gKG8gJiYgcG9pbnQobykpIHx8IHBvaW50KDAsMCk7CiAgICAgICAgICAgIHZhciB4ID0gdGhpcy54OwogICAgICAgICAgICB2YXIgeSA9IHRoaXMueTsKICAgICAgICAgICAgdGhpcy54ID0gc3FydCgoeC1vLngpKih4LW8ueCkgKyAoeS1vLnkpKih5LW8ueSkpOyAgIC8vIHIKICAgICAgICAgICAgdGhpcy55ID0gdG9SYWQoby50aGV0YShwb2ludCh4LHkpKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUm90YXRlIHBvaW50IGJ5IGFuZ2xlIGFyb3VuZCBvcmlnaW4gby4KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKG8sIGFuZ2xlKSB7CiAgICAgICAgICAgIGFuZ2xlID0gKGFuZ2xlICsgMzYwKSAlIDM2MDsKICAgICAgICAgICAgdGhpcy50b1BvbGFyKG8pOwogICAgICAgICAgICB0aGlzLnkgKz0gdG9SYWQoYW5nbGUpOwogICAgICAgICAgICB2YXIgcCA9IHBvaW50LmZyb21Qb2xhcih0aGlzLngsIHRoaXMueSwgbyk7CiAgICAgICAgICAgIHRoaXMueCA9IHAueDsKICAgICAgICAgICAgdGhpcy55ID0gcC55OwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIE1vdmUgcG9pbnQgb24gbGluZSBzdGFydGluZyBmcm9tIHJlZiBlbmRpbmcgYXQgbWUgYnkKICAgICAgICAvLyBkaXN0YW5jZSBkaXN0YW5jZS4KICAgICAgICBtb3ZlOiBmdW5jdGlvbihyZWYsIGRpc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciB0aGV0YSA9IHRvUmFkKHBvaW50KHJlZikudGhldGEodGhpcykpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQoY29zKHRoZXRhKSAqIGRpc3RhbmNlLCAtc2luKHRoZXRhKSAqIGRpc3RhbmNlKTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgY2hhbmdlIGluIGFuZ2xlIGZyb20gbXkgcHJldmlvdXMgcG9zaXRpb24gKC1keCwgLWR5KSB0byBteSBuZXcgcG9zaXRpb24KICAgICAgICAvLyByZWxhdGl2ZSB0byByZWYgcG9pbnQuCiAgICAgICAgY2hhbmdlSW5BbmdsZTogZnVuY3Rpb24oZHgsIGR5LCByZWYpIHsKICAgICAgICAgICAgLy8gUmV2ZXJ0IHRoZSB0cmFuc2xhdGlvbiBhbmQgbWVhc3VyZSB0aGUgY2hhbmdlIGluIGFuZ2xlIGFyb3VuZCB4LWF4aXMuCiAgICAgICAgICAgIHJldHVybiBwb2ludCh0aGlzKS5vZmZzZXQoLWR4LCAtZHkpLnRoZXRhKHJlZikgLSB0aGlzLnRoZXRhKHJlZik7CiAgICAgICAgfSwKICAgICAgICBlcXVhbHM6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMueCA9PT0gcC54ICYmIHRoaXMueSA9PT0gcC55OwogICAgICAgIH0sCiAgICAgICAgc25hcFRvR3JpZDogZnVuY3Rpb24oZ3gsIGd5KSB7CiAgICAgICAgICAgIHRoaXMueCA9IHNuYXBUb0dyaWQodGhpcy54LCBneCkKICAgICAgICAgICAgdGhpcy55ID0gc25hcFRvR3JpZCh0aGlzLnksIGd5IHx8IGd4KQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgYSBwb2ludCB0aGF0IGlzIHRoZSByZWZsZWN0aW9uIG9mIG1lIHdpdGgKICAgICAgICAvLyB0aGUgY2VudGVyIG9mIGludmVyc2lvbiBpbiByZWYgcG9pbnQuCiAgICAgICAgcmVmbGVjdGlvbjogZnVuY3Rpb24ocmVmKSB7CiAgICAgICAgICAgIHJldHVybiBwb2ludChyZWYpLm1vdmUodGhpcywgdGhpcy5kaXN0YW5jZShyZWYpKTsKICAgICAgICB9CiAgICB9OwogICAgLy8gQWx0ZXJuYXRpdmUgY29uc3RydWN0b3IsIGZyb20gcG9sYXIgY29vcmRpbmF0ZXMuCiAgICAvLyBAcGFyYW0ge251bWJlcn0gciBEaXN0YW5jZS4KICAgIC8vIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSBBbmdsZSBpbiByYWRpYW5zLgogICAgLy8gQHBhcmFtIHtwb2ludH0gW29wdGlvbmFsXSBvIE9yaWdpbi4KICAgIHBvaW50LmZyb21Qb2xhciA9IGZ1bmN0aW9uKHIsIGFuZ2xlLCBvKSB7CiAgICAgICAgbyA9IChvICYmIHBvaW50KG8pKSB8fCBwb2ludCgwLDApOwogICAgICAgIHZhciB4ID0gYWJzKHIgKiBjb3MoYW5nbGUpKTsKICAgICAgICB2YXIgeSA9IGFicyhyICogc2luKGFuZ2xlKSk7CiAgICAgICAgdmFyIGRlZyA9IG5vcm1hbGl6ZUFuZ2xlKHRvRGVnKGFuZ2xlKSk7CgogICAgICAgIGlmIChkZWcgPCA5MCkgeSA9IC15OwogICAgICAgIGVsc2UgaWYgKGRlZyA8IDE4MCkgeyB4ID0gLXg7IHkgPSAteTsgfQogICAgICAgIGVsc2UgaWYgKGRlZyA8IDI3MCkgeCA9IC14OwogICAgICAgIAogICAgICAgIHJldHVybiBwb2ludChvLnggKyB4LCBvLnkgKyB5KTsKICAgIH07CgogICAgLy8gQ3JlYXRlIGEgcG9pbnQgd2l0aCByYW5kb20gY29vcmRpbmF0ZXMgdGhhdCBmYWxsIGludG8gdGhlIHJhbmdlIGBbeDEsIHgyXWAgYW5kIGBbeTEsIHkyXWAuCiAgICBwb2ludC5yYW5kb20gPSBmdW5jdGlvbih4MSwgeDIsIHkxLCB5MikgewogICAgICAgIHJldHVybiBwb2ludChmbG9vcihyYW5kb20oKSAqICh4MiAtIHgxICsgMSkgKyB4MSksIGZsb29yKHJhbmRvbSgpICogKHkyIC0geTEgKyAxKSArIHkxKSk7CiAgICB9OwoKICAgIC8vIExpbmUuCiAgICAvLyAtLS0tLQogICAgZnVuY3Rpb24gbGluZShwMSwgcDIpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgbGluZSkpCiAgICAgICAgICAgIHJldHVybiBuZXcgbGluZShwMSwgcDIpOwogICAgICAgIHRoaXMuc3RhcnQgPSBwb2ludChwMSk7CiAgICAgICAgdGhpcy5lbmQgPSBwb2ludChwMik7CiAgICB9CiAgICAKICAgIGxpbmUucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5zdGFydC50b1N0cmluZygpICsgJyAnICsgdGhpcy5lbmQudG9TdHJpbmcoKTsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge2RvdWJsZX0gbGVuZ3RoIG9mIHRoZSBsaW5lCiAgICAgICAgbGVuZ3RoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHNxcnQodGhpcy5zcXVhcmVkTGVuZ3RoKCkpOwogICAgICAgIH0sCiAgICAgICAgLy8gQHJldHVybiB7aW50ZWdlcn0gbGVuZ3RoIHdpdGhvdXQgc3FydAogICAgICAgIC8vIEBub3RlIGZvciBhcHBsaWNhdGlvbnMgd2hlcmUgdGhlIGV4YWN0IGxlbmd0aCBpcyBub3QgbmVjZXNzYXJ5IChlLmcuIGNvbXBhcmUgb25seSkKICAgICAgICBzcXVhcmVkTGVuZ3RoOiBmdW5jdGlvbigpIHsKCSAgICB2YXIgeDAgPSB0aGlzLnN0YXJ0Lng7CiAgICAgICAgICAgIHZhciB5MCA9IHRoaXMuc3RhcnQueTsKCSAgICB2YXIgeDEgPSB0aGlzLmVuZC54OwogICAgICAgICAgICB2YXIgeTEgPSB0aGlzLmVuZC55OwoJICAgIHJldHVybiAoeDAgLT0geDEpKngwICsgKHkwIC09IHkxKSp5MDsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge3BvaW50fSBteSBtaWRwb2ludAogICAgICAgIG1pZHBvaW50OiBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gcG9pbnQoKHRoaXMuc3RhcnQueCArIHRoaXMuZW5kLngpIC8gMiwKCQkgICAgICAgICAodGhpcy5zdGFydC55ICsgdGhpcy5lbmQueSkgLyAyKTsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge3BvaW50fSBQb2ludCB3aGVyZSBJJ20gaW50ZXJzZWN0aW5nIGwuCiAgICAgICAgLy8gQHNlZSBTcXVlYWsgU21hbGx0YWxrLCBMaW5lU2VnbWVudD4+aW50ZXJzZWN0aW9uV2l0aDoKICAgICAgICBpbnRlcnNlY3Rpb246IGZ1bmN0aW9uKGwpIHsKCSAgICB2YXIgcHQxRGlyID0gcG9pbnQodGhpcy5lbmQueCAtIHRoaXMuc3RhcnQueCwgdGhpcy5lbmQueSAtIHRoaXMuc3RhcnQueSk7CgkgICAgdmFyIHB0MkRpciA9IHBvaW50KGwuZW5kLnggLSBsLnN0YXJ0LngsIGwuZW5kLnkgLSBsLnN0YXJ0LnkpOwoJICAgIHZhciBkZXQgPSAocHQxRGlyLnggKiBwdDJEaXIueSkgLSAocHQxRGlyLnkgKiBwdDJEaXIueCk7CgkgICAgdmFyIGRlbHRhUHQgPSBwb2ludChsLnN0YXJ0LnggLSB0aGlzLnN0YXJ0LngsIGwuc3RhcnQueSAtIHRoaXMuc3RhcnQueSk7CgkgICAgdmFyIGFscGhhID0gKGRlbHRhUHQueCAqIHB0MkRpci55KSAtIChkZWx0YVB0LnkgKiBwdDJEaXIueCk7CgkgICAgdmFyIGJldGEgPSAoZGVsdGFQdC54ICogcHQxRGlyLnkpIC0gKGRlbHRhUHQueSAqIHB0MURpci54KTsKCgkgICAgaWYgKGRldCA9PT0gMCB8fAoJICAgICAgICBhbHBoYSAqIGRldCA8IDAgfHwKCSAgICAgICAgYmV0YSAqIGRldCA8IDApIHsKICAgICAgICAgICAgICAgIC8vIE5vIGludGVyc2VjdGlvbiBmb3VuZC4KCSAgICAgICAgcmV0dXJuIG51bGw7CQoJICAgIH0KCSAgICBpZiAoZGV0ID4gMCl7CgkgICAgICAgIGlmIChhbHBoYSA+IGRldCB8fCBiZXRhID4gZGV0KXsKCQkgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgICBpZiAoYWxwaGEgPCBkZXQgfHwgYmV0YSA8IGRldCl7CgkJICAgIHJldHVybiBudWxsOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBwb2ludCh0aGlzLnN0YXJ0LnggKyAoYWxwaGEgKiBwdDFEaXIueCAvIGRldCksCgkJICAgICAgICAgdGhpcy5zdGFydC55ICsgKGFscGhhICogcHQxRGlyLnkgLyBkZXQpKTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8vIEByZXR1cm4gdGhlIGJlYXJpbmcgKGNhcmRpbmFsIGRpcmVjdGlvbikgb2YgdGhlIGxpbmUuIEZvciBleGFtcGxlIE4sIFcsIG9yIFNFLgogICAgICAgIC8vIEByZXR1cm5zIHtTdHJpbmd9IE9uZSBvZiB0aGUgZm9sbG93aW5nIGJlYXJpbmdzIDogTkUsIEUsIFNFLCBTLCBTVywgVywgTlcsIE4uCiAgICAgICAgYmVhcmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgbGF0MSA9IHRvUmFkKHRoaXMuc3RhcnQueSk7CiAgICAgICAgICAgIHZhciBsYXQyID0gdG9SYWQodGhpcy5lbmQueSk7CiAgICAgICAgICAgIHZhciBsb24xID0gdGhpcy5zdGFydC54OwogICAgICAgICAgICB2YXIgbG9uMiA9IHRoaXMuZW5kLng7CiAgICAgICAgICAgIHZhciBkTG9uID0gdG9SYWQobG9uMiAtIGxvbjEpOwogICAgICAgICAgICB2YXIgeSA9IHNpbihkTG9uKSAqIGNvcyhsYXQyKTsKICAgICAgICAgICAgdmFyIHggPSBjb3MobGF0MSkgKiBzaW4obGF0MikgLSBzaW4obGF0MSkgKiBjb3MobGF0MikgKiBjb3MoZExvbik7CiAgICAgICAgICAgIHZhciBicm5nID0gdG9EZWcoYXRhbjIoeSwgeCkpOwoKICAgICAgICAgICAgdmFyIGJlYXJpbmdzID0gWydORScsICdFJywgJ1NFJywgJ1MnLCAnU1cnLCAnVycsICdOVycsICdOJ107CgogICAgICAgICAgICB2YXIgaW5kZXggPSBicm5nIC0gMjIuNTsKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkKICAgICAgICAgICAgICAgIGluZGV4ICs9IDM2MDsKICAgICAgICAgICAgaW5kZXggPSBwYXJzZUludChpbmRleCAvIDQ1KTsKCiAgICAgICAgICAgIHJldHVybiBiZWFyaW5nc1tpbmRleF07CiAgICAgICAgfSwKCiAgICAgICAgLy8gQHJldHVybiB7cG9pbnR9IG15IHBvaW50IGF0ICd0JyA8MCwxPgogICAgICAgIHBvaW50QXQ6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgdmFyIHggPSAoMSAtIHQpICogdGhpcy5zdGFydC54ICsgdCAqIHRoaXMuZW5kLng7CiAgICAgICAgICAgIHZhciB5ID0gKDEgLSB0KSAqIHRoaXMuc3RhcnQueSArIHQgKiB0aGlzLmVuZC55OwogICAgICAgICAgICByZXR1cm4gcG9pbnQoeCwgeSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBSZWN0YW5nbGUuCiAgICAvLyAtLS0tLS0tLS0tCiAgICBmdW5jdGlvbiByZWN0KHgsIHksIHcsIGgpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgcmVjdCkpCiAgICAgICAgICAgIHJldHVybiBuZXcgcmVjdCh4LCB5LCB3LCBoKTsKICAgICAgICBpZiAoeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHkgPSB4Lnk7CiAgICAgICAgICAgIHcgPSB4LndpZHRoOwogICAgICAgICAgICBoID0geC5oZWlnaHQ7CiAgICAgICAgICAgIHggPSB4Lng7ICAgICAgICAKICAgICAgICB9CiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHRoaXMud2lkdGggPSB3OwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaDsKICAgIH0KICAgIAogICAgcmVjdC5wcm90b3R5cGUgPSB7CiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLm9yaWdpbigpLnRvU3RyaW5nKCkgKyAnICcgKyB0aGlzLmNvcm5lcigpLnRvU3RyaW5nKCk7CiAgICAgICAgfSwKICAgICAgICBvcmlnaW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcG9pbnQodGhpcy54LCB0aGlzLnkpOwogICAgICAgIH0sCiAgICAgICAgY29ybmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHRoaXMueSArIHRoaXMuaGVpZ2h0KTsKICAgICAgICB9LAogICAgICAgIHRvcFJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHRoaXMueSk7CiAgICAgICAgfSwKICAgICAgICBib3R0b21MZWZ0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCwgdGhpcy55ICsgdGhpcy5oZWlnaHQpOwogICAgICAgIH0sCiAgICAgICAgY2VudGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgvMiwgdGhpcy55ICsgdGhpcy5oZWlnaHQvMik7CiAgICAgICAgfSwKICAgICAgICAvLyBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHJlY3RhbmdsZXMgaW50ZXJzZWN0CiAgICAgICAgaW50ZXJzZWN0OiBmdW5jdGlvbihyKSB7CgkgICAgdmFyIG15T3JpZ2luID0gdGhpcy5vcmlnaW4oKTsKCSAgICB2YXIgbXlDb3JuZXIgPSB0aGlzLmNvcm5lcigpOwoJICAgIHZhciByT3JpZ2luID0gci5vcmlnaW4oKTsKCSAgICB2YXIgckNvcm5lciA9IHIuY29ybmVyKCk7CiAgICAgICAgICAgIAoJICAgIGlmIChyQ29ybmVyLnggPD0gbXlPcmlnaW4ueCB8fAoJICAgICAgICByQ29ybmVyLnkgPD0gbXlPcmlnaW4ueSB8fAoJICAgICAgICByT3JpZ2luLnggPj0gbXlDb3JuZXIueCB8fAoJICAgICAgICByT3JpZ2luLnkgPj0gbXlDb3JuZXIueSkgcmV0dXJuIGZhbHNlOwoJICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgLy8gQHJldHVybiB7c3RyaW5nfSAobGVmdHxyaWdodHx0b3B8Ym90dG9tKSBzaWRlIHdoaWNoIGlzIG5lYXJlc3QgdG8gcG9pbnQKICAgICAgICAvLyBAc2VlIFNxdWVhayBTbWFsbHRhbGssIFJlY3RhbmdsZT4+c2lkZU5lYXJlc3RUbzoKICAgICAgICBzaWRlTmVhcmVzdFRvUG9pbnQ6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwoJICAgIHZhciBkaXN0VG9MZWZ0ID0gcC54IC0gdGhpcy54OwoJICAgIHZhciBkaXN0VG9SaWdodCA9ICh0aGlzLnggKyB0aGlzLndpZHRoKSAtIHAueDsKCSAgICB2YXIgZGlzdFRvVG9wID0gcC55IC0gdGhpcy55OwoJICAgIHZhciBkaXN0VG9Cb3R0b20gPSAodGhpcy55ICsgdGhpcy5oZWlnaHQpIC0gcC55OwoJICAgIHZhciBjbG9zZXN0ID0gZGlzdFRvTGVmdDsKCSAgICB2YXIgc2lkZSA9ICdsZWZ0JzsKICAgICAgICAgICAgCgkgICAgaWYgKGRpc3RUb1JpZ2h0IDwgY2xvc2VzdCkgewoJICAgICAgICBjbG9zZXN0ID0gZGlzdFRvUmlnaHQ7CgkgICAgICAgIHNpZGUgPSAncmlnaHQnOwoJICAgIH0KCSAgICBpZiAoZGlzdFRvVG9wIDwgY2xvc2VzdCkgewoJICAgICAgICBjbG9zZXN0ID0gZGlzdFRvVG9wOwoJICAgICAgICBzaWRlID0gJ3RvcCc7CgkgICAgfQoJICAgIGlmIChkaXN0VG9Cb3R0b20gPCBjbG9zZXN0KSB7CgkgICAgICAgIGNsb3Nlc3QgPSBkaXN0VG9Cb3R0b207CgkgICAgICAgIHNpZGUgPSAnYm90dG9tJzsKCSAgICB9CgkgICAgcmV0dXJuIHNpZGU7CiAgICAgICAgfSwKICAgICAgICAvLyBAcmV0dXJuIHtib29sfSB0cnVlIGlmIHBvaW50IHAgaXMgaW5zaWdodCBtZQogICAgICAgIGNvbnRhaW5zUG9pbnQ6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwoJICAgIGlmIChwLnggPj0gdGhpcy54ICYmIHAueCA8PSB0aGlzLnggKyB0aGlzLndpZHRoICYmCgkgICAgICAgIHAueSA+PSB0aGlzLnkgJiYgcC55IDw9IHRoaXMueSArIHRoaXMuaGVpZ2h0KSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIH0KCSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvLyBBbGdvcml0aG0gcG9ydGVkIGZyb20gamF2YS5hd3QuUmVjdGFuZ2xlIGZyb20gT3BlbkpESy4KICAgICAgICAvLyBAcmV0dXJuIHtib29sfSB0cnVlIGlmIHJlY3RhbmdsZSBgcmAgaXMgaW5zaWRlIG1lLgogICAgICAgIGNvbnRhaW5zUmVjdDogZnVuY3Rpb24ocikgewogICAgICAgICAgICB2YXIgbnIgPSByZWN0KHIpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB2YXIgVyA9IG5yLndpZHRoOwogICAgICAgICAgICB2YXIgSCA9IG5yLmhlaWdodDsKICAgICAgICAgICAgdmFyIFggPSBuci54OwogICAgICAgICAgICB2YXIgWSA9IG5yLnk7CiAgICAgICAgICAgIHZhciB3ID0gdGhpcy53aWR0aDsKICAgICAgICAgICAgdmFyIGggPSB0aGlzLmhlaWdodDsKICAgICAgICAgICAgaWYgKCh3IHwgaCB8IFcgfCBIKSA8IDApIHsKICAgICAgICAgICAgICAgIC8vIEF0IGxlYXN0IG9uZSBvZiB0aGUgZGltZW5zaW9ucyBpcyBuZWdhdGl2ZS4uLgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vdGU6IGlmIGFueSBkaW1lbnNpb24gaXMgemVybywgdGVzdHMgYmVsb3cgbXVzdCByZXR1cm4gZmFsc2UuLi4KICAgICAgICAgICAgdmFyIHggPSB0aGlzLng7CiAgICAgICAgICAgIHZhciB5ID0gdGhpcy55OwogICAgICAgICAgICBpZiAoWCA8IHggfHwgWSA8IHkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3ICs9IHg7CiAgICAgICAgICAgIFcgKz0gWDsKICAgICAgICAgICAgaWYgKFcgPD0gWCkgewogICAgICAgICAgICAgICAgLy8gWCtXIG92ZXJmbG93ZWQgb3IgVyB3YXMgemVybywgcmV0dXJuIGZhbHNlIGlmLi4uCiAgICAgICAgICAgICAgICAvLyBlaXRoZXIgb3JpZ2luYWwgdyBvciBXIHdhcyB6ZXJvIG9yCiAgICAgICAgICAgICAgICAvLyB4K3cgZGlkIG5vdCBvdmVyZmxvdyBvcgogICAgICAgICAgICAgICAgLy8gdGhlIG92ZXJmbG93ZWQgeCt3IGlzIHNtYWxsZXIgdGhhbiB0aGUgb3ZlcmZsb3dlZCBYK1cKICAgICAgICAgICAgICAgIGlmICh3ID49IHggfHwgVyA+IHcpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFgrVyBkaWQgbm90IG92ZXJmbG93IGFuZCBXIHdhcyBub3QgemVybywgcmV0dXJuIGZhbHNlIGlmLi4uCiAgICAgICAgICAgICAgICAvLyBvcmlnaW5hbCB3IHdhcyB6ZXJvIG9yCiAgICAgICAgICAgICAgICAvLyB4K3cgZGlkIG5vdCBvdmVyZmxvdyBhbmQgeCt3IGlzIHNtYWxsZXIgdGhhbiBYK1cKICAgICAgICAgICAgICAgIGlmICh3ID49IHggJiYgVyA+IHcpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoICs9IHk7CiAgICAgICAgICAgIEggKz0gWTsKICAgICAgICAgICAgaWYgKEggPD0gWSkgewogICAgICAgICAgICAgICAgaWYgKGggPj0geSB8fCBIID4gaCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGggPj0geSAmJiBIID4gaCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sICAgICAgICAKICAgICAgICAvLyBAcmV0dXJuIHtwb2ludH0gYSBwb2ludCBvbiBteSBib3VuZGFyeSBuZWFyZXN0IHRvIHAKICAgICAgICAvLyBAc2VlIFNxdWVhayBTbWFsbHRhbGssIFJlY3RhbmdsZT4+cG9pbnROZWFyZXN0VG86CiAgICAgICAgcG9pbnROZWFyZXN0VG9Qb2ludDogZnVuY3Rpb24ocCkgewogICAgICAgICAgICBwID0gcG9pbnQocCk7CgkgICAgaWYgKHRoaXMuY29udGFpbnNQb2ludChwKSkgewoJICAgICAgICB2YXIgc2lkZSA9IHRoaXMuc2lkZU5lYXJlc3RUb1BvaW50KHApOwoJICAgICAgICBzd2l0Y2ggKHNpZGUpewoJICAgICAgICAgIGNhc2UgInJpZ2h0IjogcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHAueSk7CgkgICAgICAgICAgY2FzZSAibGVmdCI6IHJldHVybiBwb2ludCh0aGlzLngsIHAueSk7CgkgICAgICAgICAgY2FzZSAiYm90dG9tIjogcmV0dXJuIHBvaW50KHAueCwgdGhpcy55ICsgdGhpcy5oZWlnaHQpOwoJICAgICAgICAgIGNhc2UgInRvcCI6IHJldHVybiBwb2ludChwLngsIHRoaXMueSk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHAuYWRoZXJlVG9SZWN0KHRoaXMpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBwb2ludCBvbiBteSBib3VuZGFyeSB3aGVyZSBsaW5lIHN0YXJ0aW5nCiAgICAgICAgLy8gZnJvbSBteSBjZW50ZXIgZW5kaW5nIGluIHBvaW50IHAgaW50ZXJzZWN0cyBtZS4KICAgICAgICAvLyBAcGFyYW0ge251bWJlcn0gYW5nbGUgSWYgYW5nbGUgaXMgc3BlY2lmaWVkLCBpbnRlcnNlY3Rpb24gd2l0aCByb3RhdGVkIHJlY3RhbmdsZSBpcyBjb21wdXRlZC4KICAgICAgICBpbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50OiBmdW5jdGlvbihwLCBhbmdsZSkgewogICAgICAgICAgICBwID0gcG9pbnQocCk7CgkgICAgdmFyIGNlbnRlciA9IHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgvMiwgdGhpcy55ICsgdGhpcy5oZWlnaHQvMik7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIGlmIChhbmdsZSkgcC5yb3RhdGUoY2VudGVyLCBhbmdsZSk7CiAgICAgICAgICAgIAoJICAgIC8vIChjbG9ja3dpc2UsIHN0YXJ0aW5nIGZyb20gdGhlIHRvcCBzaWRlKQoJICAgIHZhciBzaWRlcyA9IFsKCSAgICAgICAgbGluZSh0aGlzLm9yaWdpbigpLCB0aGlzLnRvcFJpZ2h0KCkpLAoJICAgICAgICBsaW5lKHRoaXMudG9wUmlnaHQoKSwgdGhpcy5jb3JuZXIoKSksCgkgICAgICAgIGxpbmUodGhpcy5jb3JuZXIoKSwgdGhpcy5ib3R0b21MZWZ0KCkpLAoJICAgICAgICBsaW5lKHRoaXMuYm90dG9tTGVmdCgpLCB0aGlzLm9yaWdpbigpKQoJICAgIF07CgkgICAgdmFyIGNvbm5lY3RvciA9IGxpbmUoY2VudGVyLCBwKTsKICAgICAgICAgICAgCgkgICAgZm9yICh2YXIgaSA9IHNpZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKXsKCSAgICAgICAgdmFyIGludGVyc2VjdGlvbiA9IHNpZGVzW2ldLmludGVyc2VjdGlvbihjb25uZWN0b3IpOwoJICAgICAgICBpZiAoaW50ZXJzZWN0aW9uICE9PSBudWxsKXsKCQkgICAgcmVzdWx0ID0gaW50ZXJzZWN0aW9uOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgfQogICAgICAgICAgICBpZiAocmVzdWx0ICYmIGFuZ2xlKSByZXN1bHQucm90YXRlKGNlbnRlciwgLWFuZ2xlKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAogICAgICAgIC8vIE1vdmUgYW5kIGV4cGFuZCBtZS4KICAgICAgICAvLyBAcGFyYW0gciB7cmVjdGFuZ2xlfSByZXByZXNlbnRpbmcgZGVsdGFzCiAgICAgICAgbW92ZUFuZEV4cGFuZDogZnVuY3Rpb24ocikgewoJICAgIHRoaXMueCArPSByLng7CgkgICAgdGhpcy55ICs9IHIueTsKCSAgICB0aGlzLndpZHRoICs9IHIud2lkdGg7CgkgICAgdGhpcy5oZWlnaHQgKz0gci5oZWlnaHQ7CgkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICByb3VuZDogZnVuY3Rpb24oZGVjaW1hbHMpIHsKICAgICAgICAgICAgdGhpcy54ID0gZGVjaW1hbHMgPyB0aGlzLngudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLngpOwogICAgICAgICAgICB0aGlzLnkgPSBkZWNpbWFscyA/IHRoaXMueS50b0ZpeGVkKGRlY2ltYWxzKSA6IHJvdW5kKHRoaXMueSk7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSBkZWNpbWFscyA/IHRoaXMud2lkdGgudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLndpZHRoKTsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSBkZWNpbWFscyA/IHRoaXMuaGVpZ2h0LnRvRml4ZWQoZGVjaW1hbHMpIDogcm91bmQodGhpcy5oZWlnaHQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIE5vcm1hbGl6ZSB0aGUgcmVjdGFuZ2xlOyBpLmUuLCBtYWtlIGl0IHNvIHRoYXQgaXQgaGFzIGEgbm9uLW5lZ2F0aXZlIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAgICAgLy8gSWYgd2lkdGggPCAwIHRoZSBmdW5jdGlvbiBzd2FwcyB0aGUgbGVmdCBhbmQgcmlnaHQgY29ybmVycywKICAgICAgICAvLyBhbmQgaXQgc3dhcHMgdGhlIHRvcCBhbmQgYm90dG9tIGNvcm5lcnMgaWYgaGVpZ2h0IDwgMAogICAgICAgIC8vIGxpa2UgaW4gaHR0cDovL3F0LXByb2plY3Qub3JnL2RvYy9xdC00LjgvcXJlY3RmLmh0bWwjbm9ybWFsaXplZAogICAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXd4ID0gdGhpcy54OwogICAgICAgICAgICB2YXIgbmV3eSA9IHRoaXMueTsKICAgICAgICAgICAgdmFyIG5ld3dpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICAgICAgdmFyIG5ld2hlaWdodCA9IHRoaXMuaGVpZ2h0OwogICAgICAgICAgICBpZiAodGhpcy53aWR0aCA8IDApIHsKICAgICAgICAgICAgICAgIG5ld3ggPSB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgICAgICAgICAgICAgbmV3d2lkdGggPSAtdGhpcy53aWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5oZWlnaHQgPCAwKSB7CiAgICAgICAgICAgICAgICBuZXd5ID0gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICBuZXdoZWlnaHQgPSAtdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy54ID0gbmV3eDsKICAgICAgICAgICAgdGhpcy55ID0gbmV3eTsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IG5ld3dpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IG5ld2hlaWdodDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBGaW5kIG15IGJvdW5kaW5nIGJveCB3aGVuIEknbSByb3RhdGVkIHdpdGggdGhlIGNlbnRlciBvZiByb3RhdGlvbiBpbiB0aGUgY2VudGVyIG9mIG1lLgogICAgICAgIC8vIEByZXR1cm4gciB7cmVjdGFuZ2xlfSByZXByZXNlbnRpbmcgYSBib3VuZGluZyBib3gKICAgICAgICBiYm94OiBmdW5jdGlvbihhbmdsZSkgewogICAgICAgICAgICB2YXIgdGhldGEgPSB0b1JhZChhbmdsZSB8fCAwKTsKICAgICAgICAgICAgdmFyIHN0ID0gYWJzKHNpbih0aGV0YSkpOwogICAgICAgICAgICB2YXIgY3QgPSBhYnMoY29zKHRoZXRhKSk7CiAgICAgICAgICAgIHZhciB3ID0gdGhpcy53aWR0aCAqIGN0ICsgdGhpcy5oZWlnaHQgKiBzdDsKICAgICAgICAgICAgdmFyIGggPSB0aGlzLndpZHRoICogc3QgKyB0aGlzLmhlaWdodCAqIGN0OwogICAgICAgICAgICByZXR1cm4gcmVjdCh0aGlzLnggKyAodGhpcy53aWR0aCAtIHcpIC8gMiwgdGhpcy55ICsgKHRoaXMuaGVpZ2h0IC0gaCkgLyAyLCB3LCBoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEVsbGlwc2UuCiAgICAvLyAtLS0tLS0tLQogICAgZnVuY3Rpb24gZWxsaXBzZShjLCBhLCBiKSB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGVsbGlwc2UpKQogICAgICAgICAgICByZXR1cm4gbmV3IGVsbGlwc2UoYywgYSwgYik7CiAgICAgICAgYyA9IHBvaW50KGMpOwogICAgICAgIHRoaXMueCA9IGMueDsKICAgICAgICB0aGlzLnkgPSBjLnk7CiAgICAgICAgdGhpcy5hID0gYTsKICAgICAgICB0aGlzLmIgPSBiOwogICAgfQoKICAgIGVsbGlwc2UucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCwgdGhpcy55KS50b1N0cmluZygpICsgJyAnICsgdGhpcy5hICsgJyAnICsgdGhpcy5iOwogICAgICAgIH0sCiAgICAgICAgYmJveDogZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiByZWN0KHRoaXMueCAtIHRoaXMuYSwgdGhpcy55IC0gdGhpcy5iLCAyKnRoaXMuYSwgMip0aGlzLmIpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBwb2ludCBvbiBtZSB3aGVyZSBsaW5lIGZyb20gbXkgY2VudGVyIHRvCiAgICAgICAgLy8gcG9pbnQgcCBpbnRlcnNlY3RzIG15IGJvdW5kYXJ5LgogICAgICAgIC8vIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSBJZiBhbmdsZSBpcyBzcGVjaWZpZWQsIGludGVyc2VjdGlvbiB3aXRoIHJvdGF0ZWQgZWxsaXBzZSBpcyBjb21wdXRlZC4KICAgICAgICBpbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50OiBmdW5jdGlvbihwLCBhbmdsZSkgewoJICAgIHAgPSBwb2ludChwKTsKICAgICAgICAgICAgaWYgKGFuZ2xlKSBwLnJvdGF0ZShwb2ludCh0aGlzLngsIHRoaXMueSksIGFuZ2xlKTsKICAgICAgICAgICAgdmFyIGR4ID0gcC54IC0gdGhpcy54OwoJICAgIHZhciBkeSA9IHAueSAtIHRoaXMueTsKICAgICAgICAgICAgdmFyIHJlc3VsdDsKCSAgICBpZiAoZHggPT09IDApIHsKCSAgICAgICAgcmVzdWx0ID0gdGhpcy5iYm94KCkucG9pbnROZWFyZXN0VG9Qb2ludChwKTsKICAgICAgICAgICAgICAgIGlmIChhbmdsZSkgcmV0dXJuIHJlc3VsdC5yb3RhdGUocG9pbnQodGhpcy54LCB0aGlzLnkpLCAtYW5nbGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9CgkgICAgdmFyIG0gPSBkeSAvIGR4OwoJICAgIHZhciBtU3F1YXJlZCA9IG0gKiBtOwoJICAgIHZhciBhU3F1YXJlZCA9IHRoaXMuYSAqIHRoaXMuYTsKCSAgICB2YXIgYlNxdWFyZWQgPSB0aGlzLmIgKiB0aGlzLmI7CgkgICAgdmFyIHggPSBzcXJ0KDEgLyAoKDEgLyBhU3F1YXJlZCkgKyAobVNxdWFyZWQgLyBiU3F1YXJlZCkpKTsKCiAgICAgICAgICAgIHggPSBkeCA8IDAgPyAteCA6IHg7CgkgICAgdmFyIHkgPSBtICogeDsKCSAgICByZXN1bHQgPSBwb2ludCh0aGlzLnggKyB4LCB0aGlzLnkgKyB5KTsKICAgICAgICAgICAgaWYgKGFuZ2xlKSByZXR1cm4gcmVzdWx0LnJvdGF0ZShwb2ludCh0aGlzLngsIHRoaXMueSksIC1hbmdsZSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBCZXppZXIgY3VydmUuCiAgICAvLyAtLS0tLS0tLS0tLS0tCiAgICB2YXIgYmV6aWVyID0gewogICAgICAgIC8vIEN1YmljIEJlemllciBjdXJ2ZSBwYXRoIHRocm91Z2ggcG9pbnRzLgogICAgICAgIC8vIFBvcnRlZCBmcm9tIEMjIGltcGxlbWVudGF0aW9uIGJ5IE9sZWcgVi4gUG9saWthcnBvdGNoa2luIGFuZCBQZXRlciBMZWUgKGh0dHA6Ly93d3cuY29kZXByb2plY3QuY29tL0tCL2dyYXBoaWNzL0JlemllclNwbGluZS5hc3B4KS4KICAgICAgICAvLyBAcGFyYW0ge2FycmF5fSBwb2ludHMgQXJyYXkgb2YgcG9pbnRzIHRocm91Z2ggd2hpY2ggdGhlIHNtb290aCBsaW5lIHdpbGwgZ28uCiAgICAgICAgLy8gQHJldHVybiB7YXJyYXl9IFNWRyBQYXRoIGNvbW1hbmRzIGFzIGFuIGFycmF5CiAgICAgICAgY3VydmVUaHJvdWdoUG9pbnRzOiBmdW5jdGlvbihwb2ludHMpIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xQb2ludHMgPSB0aGlzLmdldEN1cnZlQ29udHJvbFBvaW50cyhwb2ludHMpOwogICAgICAgICAgICB2YXIgcGF0aCA9IFsnTScsIHBvaW50c1swXS54LCBwb2ludHNbMF0ueV07CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRyb2xQb2ludHNbMF0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHBhdGgucHVzaCgnQycsIGNvbnRyb2xQb2ludHNbMF1baV0ueCwgY29udHJvbFBvaW50c1swXVtpXS55LCBjb250cm9sUG9pbnRzWzFdW2ldLngsIGNvbnRyb2xQb2ludHNbMV1baV0ueSwgcG9pbnRzW2krMV0ueCwgcG9pbnRzW2krMV0ueSk7ICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGF0aDsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8vIEdldCBvcGVuLWVuZGVkIEJlemllciBTcGxpbmUgQ29udHJvbCBQb2ludHMuCiAgICAgICAgLy8gQHBhcmFtIGtub3RzIElucHV0IEtub3QgQmV6aWVyIHNwbGluZSBwb2ludHMgKEF0IGxlYXN0IHR3byBwb2ludHMhKS4KICAgICAgICAvLyBAcGFyYW0gZmlyc3RDb250cm9sUG9pbnRzIE91dHB1dCBGaXJzdCBDb250cm9sIHBvaW50cy4gQXJyYXkgb2Yga25vdHMubGVuZ3RoIC0gMSBsZW5ndGguCiAgICAgICAgLy8gIEBwYXJhbSBzZWNvbmRDb250cm9sUG9pbnRzIE91dHB1dCBTZWNvbmQgQ29udHJvbCBwb2ludHMuIEFycmF5IG9mIGtub3RzLmxlbmd0aCAtIDEgbGVuZ3RoLgogICAgICAgIGdldEN1cnZlQ29udHJvbFBvaW50czogZnVuY3Rpb24oa25vdHMpIHsKICAgICAgICAgICAgdmFyIGZpcnN0Q29udHJvbFBvaW50cyA9IFtdOwogICAgICAgICAgICB2YXIgc2Vjb25kQ29udHJvbFBvaW50cyA9IFtdOwogICAgICAgICAgICB2YXIgbiA9IGtub3RzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHZhciBpOwoKICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlOiBCZXppZXIgY3VydmUgc2hvdWxkIGJlIGEgc3RyYWlnaHQgbGluZS4KICAgICAgICAgICAgaWYgKG4gPT0gMSkgeyAKCSAgICAgICAgLy8gM1AxID0gMlAwICsgUDMKCSAgICAgICAgZmlyc3RDb250cm9sUG9pbnRzWzBdID0gcG9pbnQoKDIgKiBrbm90c1swXS54ICsga25vdHNbMV0ueCkgLyAzLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMiAqIGtub3RzWzBdLnkgKyBrbm90c1sxXS55KSAvIDMpOwoJICAgICAgICAvLyBQMiA9IDJQMSDigJMgUDAKCSAgICAgICAgc2Vjb25kQ29udHJvbFBvaW50c1swXSA9IHBvaW50KDIgKiBmaXJzdENvbnRyb2xQb2ludHNbMF0ueCAtIGtub3RzWzBdLngsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICogZmlyc3RDb250cm9sUG9pbnRzWzBdLnkgLSBrbm90c1swXS55KTsKCSAgICAgICAgcmV0dXJuIFtmaXJzdENvbnRyb2xQb2ludHMsIHNlY29uZENvbnRyb2xQb2ludHNdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGZpcnN0IEJlemllciBjb250cm9sIHBvaW50cy4KICAgICAgICAgICAgLy8gUmlnaHQgaGFuZCBzaWRlIHZlY3Rvci4KICAgICAgICAgICAgdmFyIHJocyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IHJpZ2h0IGhhbmQgc2lkZSBYIHZhbHVlcy4KICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG4gLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIHJoc1tpXSA9IDQgKiBrbm90c1tpXS54ICsgMiAqIGtub3RzW2kgKyAxXS54OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJoc1swXSA9IGtub3RzWzBdLnggKyAyICoga25vdHNbMV0ueDsKICAgICAgICAgICAgcmhzW24gLSAxXSA9ICg4ICoga25vdHNbbiAtIDFdLnggKyBrbm90c1tuXS54KSAvIDIuMDsKICAgICAgICAgICAgLy8gR2V0IGZpcnN0IGNvbnRyb2wgcG9pbnRzIFgtdmFsdWVzLgogICAgICAgICAgICB2YXIgeCA9IHRoaXMuZ2V0Rmlyc3RDb250cm9sUG9pbnRzKHJocyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgcmlnaHQgaGFuZCBzaWRlIFkgdmFsdWVzLgogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbiAtIDE7ICsraSkgewoJICAgICAgICByaHNbaV0gPSA0ICoga25vdHNbaV0ueSArIDIgKiBrbm90c1tpICsgMV0ueTsKICAgICAgICAgICAgfQogICAgICAgICAgICByaHNbMF0gPSBrbm90c1swXS55ICsgMiAqIGtub3RzWzFdLnk7CiAgICAgICAgICAgIHJoc1tuIC0gMV0gPSAoOCAqIGtub3RzW24gLSAxXS55ICsga25vdHNbbl0ueSkgLyAyLjA7CiAgICAgICAgICAgIC8vIEdldCBmaXJzdCBjb250cm9sIHBvaW50cyBZLXZhbHVlcy4KICAgICAgICAgICAgdmFyIHkgPSB0aGlzLmdldEZpcnN0Q29udHJvbFBvaW50cyhyaHMpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmlsbCBvdXRwdXQgYXJyYXlzLgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgaSsrKSB7CgkgICAgICAgIC8vIEZpcnN0IGNvbnRyb2wgcG9pbnQuCgkgICAgICAgIGZpcnN0Q29udHJvbFBvaW50cy5wdXNoKHBvaW50KHhbaV0sIHlbaV0pKTsKCSAgICAgICAgLy8gU2Vjb25kIGNvbnRyb2wgcG9pbnQuCgkgICAgICAgIGlmIChpIDwgbiAtIDEpIHsKCSAgICAgICAgICAgIHNlY29uZENvbnRyb2xQb2ludHMucHVzaChwb2ludCgyICoga25vdHMgW2kgKyAxXS54IC0geFtpICsgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgKiBrbm90c1tpICsgMV0ueSAtIHlbaSArIDFdKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBzZWNvbmRDb250cm9sUG9pbnRzLnB1c2gocG9pbnQoKGtub3RzW25dLnggKyB4W24gLSAxXSkgLyAyLAoJCQkJCSAgICAgICAgICAgKGtub3RzW25dLnkgKyB5W24gLSAxXSkgLyAyKSk7CgkgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW2ZpcnN0Q29udHJvbFBvaW50cywgc2Vjb25kQ29udHJvbFBvaW50c107CiAgICAgICAgfSwKCiAgICAgICAgLy8gU29sdmVzIGEgdHJpZGlhZ29uYWwgc3lzdGVtIGZvciBvbmUgb2YgY29vcmRpbmF0ZXMgKHggb3IgeSkgb2YgZmlyc3QgQmV6aWVyIGNvbnRyb2wgcG9pbnRzLgogICAgICAgIC8vIEBwYXJhbSByaHMgUmlnaHQgaGFuZCBzaWRlIHZlY3Rvci4KICAgICAgICAvLyBAcmV0dXJuIFNvbHV0aW9uIHZlY3Rvci4KICAgICAgICBnZXRGaXJzdENvbnRyb2xQb2ludHM6IGZ1bmN0aW9uKHJocykgewogICAgICAgICAgICB2YXIgbiA9IHJocy5sZW5ndGg7CiAgICAgICAgICAgIC8vIGB4YCBpcyBhIHNvbHV0aW9uIHZlY3Rvci4KICAgICAgICAgICAgdmFyIHggPSBbXTsKICAgICAgICAgICAgdmFyIHRtcCA9IFtdOwogICAgICAgICAgICB2YXIgYiA9IDIuMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHhbMF0gPSByaHNbMF0gLyBiOwogICAgICAgICAgICAvLyBEZWNvbXBvc2l0aW9uIGFuZCBmb3J3YXJkIHN1YnN0aXR1dGlvbi4KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBuOyBpKyspIHsgCgkgICAgICAgIHRtcFtpXSA9IDEgLyBiOwoJICAgICAgICBiID0gKGkgPCBuIC0gMSA/IDQuMCA6IDMuNSkgLSB0bXBbaV07CgkgICAgICAgIHhbaV0gPSAocmhzW2ldIC0geFtpIC0gMV0pIC8gYjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBCYWNrc3Vic3RpdHV0aW9uLgoJICAgICAgICB4W24gLSBpIC0gMV0gLT0gdG1wW24gLSBpXSAqIHhbbiAtIGldOyAKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9LAoKICAgICAgICAvLyBTb2x2ZXMgYW4gaW52ZXJzaW9uIHByb2JsZW0gLS0gR2l2ZW4gdGhlICh4LCB5KSBjb29yZGluYXRlcyBvZiBhIHBvaW50IHdoaWNoIGxpZXMgb24KICAgICAgICAvLyBhIHBhcmFtZXRyaWMgY3VydmUgeCA9IHgodCkvdyh0KSwgeSA9IHkodCkvdyh0KSwg76yBbmQgdGhlIHBhcmFtZXRlciB2YWx1ZSB0CiAgICAgICAgLy8gd2hpY2ggY29ycmVzcG9uZHMgdG8gdGhhdCBwb2ludC4KICAgICAgICAvLyBAcGFyYW0gY29udHJvbCBwb2ludHMgKHN0YXJ0LCBjb250cm9sIHN0YXJ0LCBjb250cm9sIGVuZCwgZW5kKQogICAgICAgIC8vIEByZXR1cm4gYSBmdW5jdGlvbiBhY2NlcHRzIGEgcG9pbnQgYW5kIHJldHVybnMgdC4KICAgICAgICBnZXRJbnZlcnNpb25Tb2x2ZXI6IGZ1bmN0aW9uKHAwLCBwMSwgcDIsIHAzKSB7CiAgICAgICAgICAgIHZhciBwdHMgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGZ1bmN0aW9uIGwoaSxqKSB7CiAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGVzIGEgZGV0ZXJtaW5hbnQgM3gzCiAgICAgICAgICAgICAgICAvLyBbcC54ICBwLnkgIDFdCiAgICAgICAgICAgICAgICAvLyBbcGkueCBwaS55IDFdCiAgICAgICAgICAgICAgICAvLyBbcGoueCBwai55IDFdCiAgICAgICAgICAgICAgICB2YXIgcGkgPSBwdHNbaV0sIHBqID0gcHRzW2pdOwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdyA9IChpICUgMyA/IDMgOiAxKSAqIChqICUgMyA/IDMgOiAxKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlqID0gcC54ICogKHBpLnkgLSBwai55KSArIHAueSAqIChwai54IC0gcGkueCkgKyBwaS54ICogcGoueSAtIHBpLnkgKiBwai54OwogICAgICAgICAgICAgICAgICAgIHJldHVybiB3ICogbGlqOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc29sdmVJbnZlcnNpb24ocCkgewogICAgICAgICAgICAgICAgdmFyIGN0ID0gMyAqIGwoMiwzKShwMSk7CiAgICAgICAgICAgICAgICB2YXIgYzEgPSBsKDEsMykocDApIC8gY3Q7CiAgICAgICAgICAgICAgICB2YXIgYzIgPSAtbCgyLDMpKHAwKSAvIGN0OwogICAgICAgICAgICAgICAgdmFyIGxhID0gYzEgKiBsKDMsMSkocCkgKyBjMiAqIChsKDMsMCkocCkgKyBsKDIsMSkocCkpICsgbCgyLDApKHApOwogICAgICAgICAgICAgICAgdmFyIGxiID0gYzEgKiBsKDMsMCkocCkgKyBjMiAqIGwoMiwwKShwKSArIGwoMSwwKShwKTsKICAgICAgICAgICAgICAgIHJldHVybiBsYiAvIChsYiAtIGxhKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvLyBEaXZpZGUgYSBCZXppZXIgY3VydmUgaW50byB0d28gYXQgcG9pbnQgZGVmaW5lZCBieSB2YWx1ZSAndCcgPDAsMT4uCiAgICAgICAgLy8gVXNpbmcgZGVDYXN0ZWxqYXUgYWxnb3JpdGhtLiBodHRwOi8vbWF0aC5zdGFja2V4Y2hhbmdlLmNvbS9hLzMxNzg2NwogICAgICAgIC8vIEBwYXJhbSBjb250cm9sIHBvaW50cyAoc3RhcnQsIGNvbnRyb2wgc3RhcnQsIGNvbnRyb2wgZW5kLCBlbmQpCiAgICAgICAgLy8gQHJldHVybiBhIGZ1bmN0aW9uIGFjY2VwdHMgdCBhbmQgcmV0dXJucyAyIGN1cnZlcyBlYWNoIGRlZmluZWQgYnkgNCBjb250cm9sIHBvaW50cy4KICAgICAgICBnZXRDdXJ2ZURpdmlkZXI6IGZ1bmN0aW9uKHAwLHAxLHAyLHAzKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkaXZpZGVDdXJ2ZSh0KSB7CiAgICAgICAgICAgICAgICB2YXIgbCA9IGxpbmUocDAscDEpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgbSA9IGxpbmUocDEscDIpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGxpbmUocDIscDMpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgcCA9IGxpbmUobCxtKS5wb2ludEF0KHQpOwogICAgICAgICAgICAgICAgdmFyIHEgPSBsaW5lKG0sbikucG9pbnRBdCh0KTsKICAgICAgICAgICAgICAgIHZhciByID0gbGluZShwLHEpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICByZXR1cm4gW3sgcDA6IHAwLCBwMTogbCwgcDI6IHAsIHAzOiByIH0sIHsgcDA6IHIsIHAxOiBxLCBwMjogbiwgcDM6IHAzIH1dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBTY2FsZS4KICAgIHZhciBzY2FsZSA9IHsKCiAgICAgICAgLy8gUmV0dXJuIHRoZSBgdmFsdWVgIGZyb20gdGhlIGBkb21haW5gIGludGVydmFsIHNjYWxlZCB0byB0aGUgYHJhbmdlYCBpbnRlcnZhbC4KICAgICAgICBsaW5lYXI6IGZ1bmN0aW9uKGRvbWFpbiwgcmFuZ2UsIHZhbHVlKSB7CgogICAgICAgICAgICB2YXIgZG9tYWluU3BhbiA9IGRvbWFpblsxXSAtIGRvbWFpblswXTsKICAgICAgICAgICAgdmFyIHJhbmdlU3BhbiA9IHJhbmdlWzFdIC0gcmFuZ2VbMF07CiAgICAgICAgICAgIHJldHVybiAoKCh2YWx1ZSAtIGRvbWFpblswXSkgLyBkb21haW5TcGFuKSAqIHJhbmdlU3BhbiArIHJhbmdlWzBdKSB8fCAwOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKCiAgICAgICAgdG9EZWc6IHRvRGVnLAogICAgICAgIHRvUmFkOiB0b1JhZCwKICAgICAgICBzbmFwVG9HcmlkOiBzbmFwVG9HcmlkLAoJbm9ybWFsaXplQW5nbGU6IG5vcm1hbGl6ZUFuZ2xlLAogICAgICAgIHBvaW50OiBwb2ludCwKICAgICAgICBsaW5lOiBsaW5lLAogICAgICAgIHJlY3Q6IHJlY3QsCiAgICAgICAgZWxsaXBzZTogZWxsaXBzZSwKICAgICAgICBiZXppZXI6IGJlemllciwKICAgICAgICBzY2FsZTogc2NhbGUKICAgIH0KfSkpOwoKLy8gICAgICBKb2ludEpTIGxpYnJhcnkuCi8vICAgICAgKGMpIDIwMTEtMjAxMyBjbGllbnQgSU8KCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKLy8gR2xvYmFsIG5hbWVzcGFjZS4KCnZhciBqb2ludCA9IHsKCiAgICAvLyBgam9pbnQuZGlhYCBuYW1lc3BhY2UuCiAgICBkaWE6IHt9LAoKICAgIC8vIGBqb2ludC51aWAgbmFtZXNwYWNlLgogICAgdWk6IHt9LAoKICAgIC8vIGBqb2ludC5sYXlvdXRgIG5hbWVzcGFjZS4KICAgIGxheW91dDoge30sCgogICAgLy8gYGpvaW50LnNoYXBlc2AgbmFtZXNwYWNlLgogICAgc2hhcGVzOiB7fSwKCiAgICAvLyBgam9pbnQuZm9ybWF0YCBuYW1lc3BhY2UuCiAgICBmb3JtYXQ6IHt9LAoKICAgIC8vIGBqb2ludC5jb25uZWN0b3JzYCBuYW1lc3BhY2UuCiAgICBjb25uZWN0b3JzOiB7fSwKCiAgICAvLyBgam9pbnQucm91dGVyc2AgbmFtZXNwYWNlLgogICAgcm91dGVyczoge30sCgogICAgdXRpbDogewoKICAgICAgICAvLyBSZXR1cm4gYSBzaW1wbGUgaGFzaCBjb2RlIGZyb20gYSBzdHJpbmcuIFNlZSBodHRwOi8vd2VyeGx0ZC5jb20vd3AvMjAxMC8wNS8xMy9qYXZhc2NyaXB0LWltcGxlbWVudGF0aW9uLW9mLWphdmFzLXN0cmluZy1oYXNoY29kZS1tZXRob2QvLgogICAgICAgIGhhc2hDb2RlOiBmdW5jdGlvbihzdHIpIHsKCiAgICAgICAgICAgIHZhciBoYXNoID0gMDsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPT0gMCkgcmV0dXJuIGhhc2g7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgICAgaGFzaCA9ICgoaGFzaCA8PCA1KSAtIGhhc2gpICsgYzsKICAgICAgICAgICAgICAgIGhhc2ggPSBoYXNoICYgaGFzaDsgLy8gQ29udmVydCB0byAzMmJpdCBpbnRlZ2VyCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhhc2g7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0QnlQYXRoOiBmdW5jdGlvbihvYmosIHBhdGgsIGRlbGltKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBkZWxpbSA9IGRlbGltIHx8ICcuJzsKICAgICAgICAgICAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KGRlbGltKTsKICAgICAgICAgICAgdmFyIGtleTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkgewogICAgICAgICAgICAgICAga2V5ID0ga2V5cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgaWYgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBvYmogPSBvYmpba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCgogICAgICAgIHNldEJ5UGF0aDogZnVuY3Rpb24ob2JqLCBwYXRoLCB2YWx1ZSwgZGVsaW0pIHsKCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwoKICAgICAgICAgICAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KGRlbGltKTsKICAgICAgICAgICAgdmFyIGRpdmVyID0gb2JqOwogICAgICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgICAgICBpZiAocGF0aC5pbmRleE9mKGRlbGltKSA+IC0xKSB7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBsZW4gLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAvLyBkaXZlciBjcmVhdGVzIGFuIGVtcHR5IG9iamVjdCBpZiB0aGVyZSBpcyBubyBuZXN0ZWQgb2JqZWN0IHVuZGVyIHN1Y2ggYSBrZXkuCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtZWFucyB0aGF0IG9uZSBjYW4gcG9wdWxhdGUgYW4gZW1wdHkgbmVzdGVkIG9iamVjdCB3aXRoIHNldEJ5UGF0aCgpLgogICAgICAgICAgICAgICAgICAgIGRpdmVyID0gZGl2ZXJba2V5c1tpXV0gfHwgKGRpdmVyW2tleXNbaV1dID0ge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGl2ZXJba2V5c1tsZW4gLSAxXV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9ialtwYXRoXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgfSwKCiAgICAgICAgdW5zZXRCeVBhdGg6IGZ1bmN0aW9uKG9iaiwgcGF0aCwgZGVsaW0pIHsKCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwoKICAgICAgICAgICAgLy8gaW5kZXggb2YgdGhlIGxhc3QgZGVsaW1pdGVyCiAgICAgICAgICAgIHZhciBpID0gcGF0aC5sYXN0SW5kZXhPZihkZWxpbSk7CgogICAgICAgICAgICBpZiAoaSA+IC0xKSB7CgogICAgICAgICAgICAgICAgLy8gdW5zZXR0aW5nIGEgbmVzdGVkIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGpvaW50LnV0aWwuZ2V0QnlQYXRoKG9iaiwgcGF0aC5zdWJzdHIoMCwgaSksIGRlbGltKTsKCiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJlbnRbcGF0aC5zbGljZShpICsgMSldOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyB1bnNldHRpbmcgYSBwcmltaXRpdmUgYXR0cmlidXRlCiAgICAgICAgICAgICAgICBkZWxldGUgb2JqW3BhdGhdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCgogICAgICAgIGZsYXR0ZW5PYmplY3Q6IGZ1bmN0aW9uKG9iaiwgZGVsaW0sIHN0b3ApIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwogICAgICAgICAgICB2YXIgcmV0ID0ge307CgkgICAgCgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgewoJCWlmICghb2JqLmhhc093blByb3BlcnR5KGtleSkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBzaG91bGRHb0RlZXBlciA9IHR5cGVvZiBvYmpba2V5XSA9PT0gJ29iamVjdCc7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkR29EZWVwZXIgJiYgc3RvcCAmJiBzdG9wKG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgIHNob3VsZEdvRGVlcGVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKCQlpZiAoc2hvdWxkR29EZWVwZXIpIHsKCQkgICAgdmFyIGZsYXRPYmplY3QgPSB0aGlzLmZsYXR0ZW5PYmplY3Qob2JqW2tleV0sIGRlbGltLCBzdG9wKTsKCQkgICAgZm9yICh2YXIgZmxhdEtleSBpbiBmbGF0T2JqZWN0KSB7CgkJCWlmICghZmxhdE9iamVjdC5oYXNPd25Qcm9wZXJ0eShmbGF0S2V5KSkgY29udGludWU7CgkJCQoJCQlyZXRba2V5ICsgZGVsaW0gKyBmbGF0S2V5XSA9IGZsYXRPYmplY3RbZmxhdEtleV07CgkJICAgIH0KCQl9IGVsc2UgewoJCSAgICByZXRba2V5XSA9IG9ialtrZXldOwoJCX0KCSAgICB9CgkgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICB1dWlkOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGNyZWRpdDogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3Bvc3RzLzIxMTc1MjMvcmV2aXNpb25zCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkqMTZ8MCwgdiA9IGMgPT0gJ3gnID8gciA6IChyJjB4M3wweDgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvLyBHZW5lcmF0ZSBnbG9iYWwgdW5pcXVlIGlkIGZvciBvYmogYW5kIHN0b3JlIGl0IGFzIGEgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAgICBndWlkOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZ3VpZC5pZCA9IHRoaXMuZ3VpZC5pZCB8fCAxOwogICAgICAgICAgICBvYmouaWQgPSAob2JqLmlkID09PSB1bmRlZmluZWQgPyAnal8nICsgdGhpcy5ndWlkLmlkKysgOiBvYmouaWQpOwogICAgICAgICAgICByZXR1cm4gb2JqLmlkOwogICAgICAgIH0sCgogICAgICAgIC8vIENvcHkgYWxsIHRoZSBwcm9wZXJ0aWVzIHRvIHRoZSBmaXJzdCBhcmd1bWVudCBmcm9tIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzLgogICAgICAgIC8vIEFsbCB0aGUgcHJvcGVydGllcyB3aWxsIGJlIG92ZXJ3cml0dGVuIGJ5IHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGZvbGxvd2luZwogICAgICAgIC8vIGFyZ3VtZW50cy4gSW5oZXJpdGVkIHByb3BlcnRpZXMgYXJlIGlnbm9yZWQuCiAgICAgICAgbWl4aW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPbmx5IGZ1bmN0aW9ucyBhbmQgb2JqZWN0cyBjYW4gYmUgbWl4aW5lZC4KCiAgICAgICAgICAgICAgICBpZiAoKE9iamVjdChleHRlbnNpb24pICE9PSBleHRlbnNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgIV8uaXNGdW5jdGlvbihleHRlbnNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgKGV4dGVuc2lvbiA9PT0gbnVsbCB8fCBleHRlbnNpb24gPT09IHVuZGVmaW5lZCkpIHsKCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgXy5lYWNoKGV4dGVuc2lvbiwgZnVuY3Rpb24oY29weSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4aW4uZGVlcCAmJiAoT2JqZWN0KGNvcHkpID09PSBjb3B5KSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRba2V5XSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gXy5pc0FycmF5KGNvcHkpID8gW10gOiB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5taXhpbih0YXJnZXRba2V5XSwgY29weSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFtrZXldICE9PSBjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWl4aW4uc3VwcGxlbWVudCB8fCAhdGFyZ2V0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5XSA9IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ29weSBhbGwgcHJvcGVydGllcyB0byB0aGUgZmlyc3QgYXJndW1lbnQgZnJvbSB0aGUgZm9sbG93aW5nCiAgICAgICAgLy8gYXJndW1lbnRzIG9ubHkgaW4gY2FzZSBpZiB0aGV5IGRvbid0IGV4aXN0cyBpbiB0aGUgZmlyc3QgYXJndW1lbnQuCiAgICAgICAgLy8gQWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJlcnRpZXMgaW4gdGhlIGZpcnN0IGFyZ3VtZW50IHdpbGwgZ2V0CiAgICAgICAgLy8gYWRkaXRpb25hbCBwcm9wZXJ0eSBiYXNlIHBvaW50aW5nIHRvIHRoZSBleHRlbmRlcnMgc2FtZSBuYW1lZAogICAgICAgIC8vIHByb3BlcnR5IGZ1bmN0aW9uJ3MgY2FsbCBtZXRob2QuCiAgICAgICAgc3VwcGxlbWVudDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLm1peGluLnN1cHBsZW1lbnQgPSB0cnVlOwogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5taXhpbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLm1peGluLnN1cHBsZW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAvLyBTYW1lIGFzIGBtaXhpbigpYCBidXQgZGVlcCB2ZXJzaW9uLgogICAgICAgIGRlZXBNaXhpbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1peGluLmRlZXAgPSB0cnVlOwogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5taXhpbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLm1peGluLmRlZXAgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAvLyBTYW1lIGFzIGBzdXBwbGVtZW50KClgIGJ1dCBkZWVwIHZlcnNpb24uCiAgICAgICAgZGVlcFN1cHBsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5taXhpbi5kZWVwID0gdGhpcy5taXhpbi5zdXBwbGVtZW50ID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJldCA9IHRoaXMubWl4aW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5taXhpbi5kZWVwID0gdGhpcy5taXhpbi5zdXBwbGVtZW50ID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgbm9ybWFsaXplRXZlbnQ6IGZ1bmN0aW9uKGV2dCkgewoKICAgICAgICAgICAgcmV0dXJuIChldnQub3JpZ2luYWxFdmVudCAmJiBldnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlcyAmJiBldnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpID8gZXZ0Lm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0gOiBldnQ7CiAgICAgICAgfSwKCgluZXh0RnJhbWU6KGZ1bmN0aW9uKCkgewoKCSAgICB2YXIgcmFmOwoJICAgIHZhciBjbGllbnQgPSB0eXBlb2Ygd2luZG93ICE9ICd1bmRlZmluZWQnOwoKCSAgICBpZiAoY2xpZW50KSB7CgoJCXJhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgICAgfHwKCQkgICAgICB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CgkgICAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgfHwKCQkgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgIHx8CgkJICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKCSAgICB9CgoJICAgIGlmICghcmFmKSB7CgoJCXZhciBsYXN0VGltZSA9IDA7CgoJCXJhZiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgoJCSAgICB2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkgICAgdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSk7CgkJICAgIHZhciBpZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNhbGxiYWNrKGN1cnJUaW1lICsgdGltZVRvQ2FsbCk7IH0sIHRpbWVUb0NhbGwpOwoJCSAgICBsYXN0VGltZSA9IGN1cnJUaW1lICsgdGltZVRvQ2FsbDsKCQkgICAgcmV0dXJuIGlkOwoKCQl9OwoJICAgIH0KCgkgICAgcmV0dXJuIGNsaWVudCA/IF8uYmluZChyYWYsIHdpbmRvdykgOiByYWY7Cgl9KSgpLAoKCWNhbmNlbEZyYW1lOiAoZnVuY3Rpb24oKSB7CgoJICAgIHZhciBjYWY7CgkgICAgdmFyIGNsaWVudCA9IHR5cGVvZiB3aW5kb3cgIT0gJ3VuZGVmaW5lZCc7CgoJICAgIGlmIChjbGllbnQpIHsKCgkJY2FmID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lICAgICAgICAgICAgICB8fAoJCSAgICAgIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAoJCSAgICAgIHdpbmRvdy5tc0NhbmNlbEFuaW1hdGlvbkZyYW1lICAgICAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93Lm1zQ2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgICB8fAoJCSAgICAgIHdpbmRvdy5vQ2FuY2VsQW5pbWF0aW9uRnJhbWUgICAgICAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93Lm9DYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgICB8fAoJICAgICAgICAgICAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgICAgICAgICAgIHx8CgkJICAgICAgd2luZG93Lm1vekNhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCgkgICAgfQoKCSAgICBjYWYgPSBjYWYgfHwgY2xlYXJUaW1lb3V0OwoKCSAgICByZXR1cm4gY2xpZW50ID8gXy5iaW5kKGNhZiwgd2luZG93KSA6IGNhZjsKCX0pKCksCgogICAgICAgIGJyZWFrVGV4dDogZnVuY3Rpb24odGV4dCwgc2l6ZSwgc3R5bGVzLCBvcHQpIHsKCiAgICAgICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHNpemUud2lkdGg7CiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBzaXplLmhlaWdodDsKCiAgICAgICAgICAgIHZhciBzdmdEb2N1bWVudCA9IG9wdC5zdmdEb2N1bWVudCB8fCBWKCdzdmcnKS5ub2RlOwogICAgICAgICAgICB2YXIgdGV4dEVsZW1lbnQgPSBWKCc8dGV4dD48dHNwYW4+PC90c3Bhbj48L3RleHQ+JykuYXR0cihzdHlsZXMgfHwge30pLm5vZGU7CiAgICAgICAgICAgIHZhciB0ZXh0U3BhbiA9IHRleHRFbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTsKCiAgICAgICAgICAgIHRleHRTcGFuLmFwcGVuZENoaWxkKHRleHROb2RlKTsKCiAgICAgICAgICAgIHN2Z0RvY3VtZW50LmFwcGVuZENoaWxkKHRleHRFbGVtZW50KTsKCiAgICAgICAgICAgIGlmICghb3B0LnN2Z0RvY3VtZW50KSB7CgogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzdmdEb2N1bWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB3b3JkcyA9IHRleHQuc3BsaXQoJyAnKTsKICAgICAgICAgICAgdmFyIGZ1bGwgPSBbXTsKICAgICAgICAgICAgdmFyIGxpbmVzID0gW107CiAgICAgICAgICAgIHZhciBwOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSAwLCBsZW4gPSB3b3Jkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoKICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07CgogICAgICAgICAgICAgICAgdGV4dE5vZGUuZGF0YSA9IGxpbmVzW2xdID8gbGluZXNbbF0gKyAnICcgKyB3b3JkIDogd29yZDsKCiAgICAgICAgICAgICAgICBpZiAodGV4dFNwYW4uZ2V0Q29tcHV0ZWRUZXh0TGVuZ3RoKCkgPD0gd2lkdGgpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGN1cnJlbnQgbGluZSBmaXRzCiAgICAgICAgICAgICAgICAgICAgbGluZXNbbF0gPSB0ZXh0Tm9kZS5kYXRhOwoKICAgICAgICAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIHBhcnRpdGlvbmluZy4gUHV0IHJlc3Qgb2YgdGhlIHdvcmQgb250byBuZXh0IGxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFtsKytdID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwYXJ0aXRpb25pbmcKICAgICAgICAgICAgICAgICAgICAgICAgcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghbGluZXNbbF0gfHwgcCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRpdGlvbiA9ICEhcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSB3b3JkLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydGl0aW9uIHx8ICFwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd29yZCBoYXMgb25seSBvbmUgY2hhcmFjdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGluZXNbbF0pIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHdvbid0IGZpdCB0aGlzIHRleHQgd2l0aGluIG91ciByZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gW107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcnRpdGlvbmluZyBkaWRuJ3QgaGVscCBvbiB0aGUgbm9uLWVtcHR5IGxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnkgYWdhaW4sIGJ1dCB0aGlzIHRpbWUgc3RhcnQgd2l0aCBhIG5ldyBsaW5lCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwYXJ0aXRpb25zIGNyZWF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3Jkcy5zcGxpY2UoaSwyLCB3b3JkICsgd29yZHNbaSsxXSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkanVzdCB3b3JkIGxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbi0tOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsW2wrK10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSBsYXN0IGxldHRlciB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBuZXh0IHdvcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gd29yZC5zdWJzdHJpbmcoMCxwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2krMV0gPSB3b3JkLnN1YnN0cmluZyhwKSArIHdvcmRzW2krMV07CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGluaXRpYXRlIHBhcnRpdGlvbmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BsaXQgdGhlIGxvbmcgd29yZCBpbnRvIHR3byB3b3JkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHMuc3BsaWNlKGksIDEsIHdvcmQuc3Vic3RyaW5nKDAscCksIHdvcmQuc3Vic3RyaW5nKHApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGp1c3Qgd29yZHMgbGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4rKzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobCAmJiAhZnVsbFtsLTFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHByZXZpb3VzIGxpbmUgaXMgbm90IGZ1bGwsIHRyeSB0byBmaXQgbWF4IHBhcnQgb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY3VycmVudCB3b3JkIHRoZXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpLS07CgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGwrKzsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWYgc2l6ZS5oZWlnaHQgaXMgZGVmaW5lZCB3ZSBoYXZlIHRvIGNoZWNrIHdoZXRoZXIgdGhlIGhlaWdodCBvZiB0aGUgZW50aXJlCiAgICAgICAgICAgICAgICAvLyB0ZXh0IGV4Y2VlZHMgdGhlIHJlY3QgaGVpZ2h0CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhlaWdodCAhPT0gJ3VuZGVmaW5lZCcpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gZ2V0IGxpbmUgaGVpZ2h0IGFzIHRleHQgaGVpZ2h0IC8gMC44IChhcyB0ZXh0IGhlaWdodCBpcyBhcHByb3guIDAuOGVtCiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGxpbmUgaGVpZ2h0IGlzIDFlbS4gU2VlIHZlY3Rvcml6ZXIudGV4dCgpKQogICAgICAgICAgICAgICAgICAgIHZhciBsaCA9IGxoIHx8IHRleHRFbGVtZW50LmdldEJCb3goKS5oZWlnaHQgKiAxLjI1OwoKICAgICAgICAgICAgICAgICAgICBpZiAobGggKiBsaW5lcy5sZW5ndGggPiBoZWlnaHQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBvdmVyZmxvd2luZyBsaW5lcwogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5zcGxpY2UoTWF0aC5mbG9vcihoZWlnaHQgLyBsaCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0LnN2Z0RvY3VtZW50KSB7CgogICAgICAgICAgICAgICAgLy8gc3ZnIGRvY3VtZW50IHdhcyBwcm92aWRlZCwgcmVtb3ZlIHRoZSB0ZXh0IGVsZW1lbnQgb25seQogICAgICAgICAgICAgICAgc3ZnRG9jdW1lbnQucmVtb3ZlQ2hpbGQodGV4dEVsZW1lbnQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBjbGVhbiBzdmcgZG9jdW1lbnQKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc3ZnRG9jdW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbGluZXMuam9pbignXG4nKTsKICAgICAgICB9LAoKCXRpbWluZzogewoKCSAgICBsaW5lYXI6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gdDsKCSAgICB9LAoKCSAgICBxdWFkOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0OwoJICAgIH0sCgoJICAgIGN1YmljOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0ICogdDsKCSAgICB9LAoKCSAgICBpbm91dDogZnVuY3Rpb24odCkgewoJCWlmICh0IDw9IDApIHJldHVybiAwOwoJCWlmICh0ID49IDEpIHJldHVybiAxOwoJCXZhciB0MiA9IHQgKiB0LCB0MyA9IHQyICogdDsKCQlyZXR1cm4gNCAqICh0IDwgLjUgPyB0MyA6IDMgKiAodCAtIHQyKSArIHQzIC0gLjc1KTsKCSAgICB9LAoKCSAgICBleHBvbmVudGlhbDogZnVuY3Rpb24odCkgewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqICh0IC0gMSkpOwoJICAgIH0sCgoJICAgIGJvdW5jZTogZnVuY3Rpb24odCkgewoJCWZvcih2YXIgYSA9IDAsIGIgPSAxOyAxOyBhICs9IGIsIGIgLz0gMikgewoJCSAgICBpZiAodCA+PSAoNyAtIDQgKiBhKSAvIDExKSB7CgkJCXZhciBxID0gKDExIC0gNiAqIGEgLSAxMSAqIHQpIC8gNDsKCQkJcmV0dXJuIC1xICogcSArIGIgKiBiOwoJCSAgICB9CgkJfQoJICAgIH0sCgoJICAgIHJldmVyc2U6IGZ1bmN0aW9uKGYpIHsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gMSAtIGYoMSAtIHQpCgkJfQoJICAgIH0sCgoJICAgIHJlZmxlY3Q6IGZ1bmN0aW9uKGYpIHsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gLjUgKiAodCA8IC41ID8gZigyICogdCkgOiAoMiAtIGYoMiAtIDIgKiB0KSkpOwoJCX07CgkgICAgfSwKCgkgICAgY2xhbXA6IGZ1bmN0aW9uKGYsbix4KSB7CgkJbiA9IG4gfHwgMDsKCQl4ID0geCB8fCAxOwoJCXJldHVybiBmdW5jdGlvbih0KSB7CgkJICAgIHZhciByID0gZih0KTsKCQkgICAgcmV0dXJuIHIgPCBuID8gbiA6IHIgPiB4ID8geCA6IHI7CgkJfQoJICAgIH0sCgoJICAgIGJhY2s6IGZ1bmN0aW9uKHMpIHsKCQlpZiAoIXMpIHMgPSAxLjcwMTU4OwoJCXJldHVybiBmdW5jdGlvbih0KSB7CgkJICAgIHJldHVybiB0ICogdCAqICgocyArIDEpICogdCAtIHMpOwoJCX07CgkgICAgfSwKCgkgICAgZWxhc3RpYzogZnVuY3Rpb24oeCkgewoJCWlmICgheCkgeCA9IDEuNTsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSAqIE1hdGguY29zKDIwKk1hdGguUEkqeC8zKnQpOwoJCX0KCSAgICB9CgoJfSwKCglpbnRlcnBvbGF0ZTogewoKCSAgICBudW1iZXI6IGZ1bmN0aW9uKGEsIGIpIHsKCQl2YXIgZCA9IGIgLSBhOwoJCXJldHVybiBmdW5jdGlvbih0KSB7IHJldHVybiBhICsgZCAqIHQ7IH07CgkgICAgfSwKCgkgICAgb2JqZWN0OiBmdW5jdGlvbihhLCBiKSB7CgkJdmFyIHMgPSBfLmtleXMoYSk7CgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKCQkgICAgdmFyIGksIHAsIHIgPSB7fTsKCQkgICAgZm9yIChpID0gcy5sZW5ndGggLSAxOyBpICE9IC0xOyBpLS0pIHsKCQkJcCA9IHNbaV07CgkJCXJbcF0gPSBhW3BdICsgKGJbcF0gLSBhW3BdKSAqIHQ7CgkJICAgIH0KCQkgICAgcmV0dXJuICByOwoJCX0KCSAgICB9LAoKCSAgICBoZXhDb2xvcjogZnVuY3Rpb24oYSwgYikgewoKCQl2YXIgY2EgPSBwYXJzZUludChhLnNsaWNlKDEpLCAxNiksIGNiID0gcGFyc2VJbnQoYi5zbGljZSgxKSwgMTYpOwoKCQl2YXIgcmEgPSBjYSAmIDB4MDAwMGZmLCByZCA9IChjYiAmIDB4MDAwMGZmKSAtIHJhOwoJCXZhciBnYSA9IGNhICYgMHgwMGZmMDAsIGdkID0gKGNiICYgMHgwMGZmMDApIC0gZ2E7CgkJdmFyIGJhID0gY2EgJiAweGZmMDAwMCwgYmQgPSAoY2IgJiAweGZmMDAwMCkgLSBiYTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgciA9IChyYSArIHJkICogdCkgJiAweDAwMDAwMGZmOwogICAgICAgICAgICAgICAgICAgIHZhciBnID0gKGdhICsgZ2QgKiB0KSAmIDB4MDAwMGZmMDA7CiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSAoYmEgKyBiZCAqIHQpICYgMHgwMGZmMDAwMDsKCQkgICAgcmV0dXJuICcjJyArICgxIDw8IDI0IHwgciB8IGcgfCBiICkudG9TdHJpbmcoMTYpLnNsaWNlKDEpOwoJCX07CgkgICAgfSwKCgkgICAgdW5pdDogZnVuY3Rpb24oYSwgYikgewoKCQl2YXIgciA9IC8oLT9bMC05XSouWzAtOV0qKShweHxlbXxjbXxtbXxpbnxwdHxwY3wlKS87CgoJCXZhciBtYSA9IHIuZXhlYyhhKSwgbWIgPSByLmV4ZWMoYik7CgkJdmFyIHAgPSBtYlsxXS5pbmRleE9mKCcuJyksIGYgPSBwID4gMCA/IG1iWzFdLmxlbmd0aCAtIHAgLSAxIDogMDsKCQl2YXIgYSA9ICttYVsxXSwgZCA9ICttYlsxXSAtIGEsIHUgPSBtYVsyXTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKCQkgICAgcmV0dXJuIChhICsgZCAqIHQpLnRvRml4ZWQoZikgKyB1OwoJCX0KCSAgICB9Cgl9LAoKICAgICAgICAvLyBTVkcgZmlsdGVycy4KICAgICAgICBmaWx0ZXI6IHsKCiAgICAgICAgICAgIC8vIGB4YCAuLi4gaG9yaXpvbnRhbCBibHVyCiAgICAgICAgICAgIC8vIGB5YCAuLi4gdmVydGljYWwgYmx1ciAob3B0aW9uYWwpCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIHggPSBfLmlzRmluaXRlKGFyZ3MueCkgPyBhcmdzLnggOiAyOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IiR7c3RkRGV2aWF0aW9ufSIvPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBzdGREZXZpYXRpb246IF8uaXNGaW5pdGUoYXJncy55KSA/IFt4LCBhcmdzLnldIDogeAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgZHhgIC4uLiBob3Jpem9udGFsIHNoaWZ0CiAgICAgICAgICAgIC8vIGBkeWAgLi4uIHZlcnRpY2FsIHNoaWZ0CiAgICAgICAgICAgIC8vIGBibHVyYCAuLi4gYmx1cgogICAgICAgICAgICAvLyBgY29sb3JgIC4uLiBjb2xvcgogICAgICAgICAgICAvLyBgb3BhY2l0eWAgLi4uIG9wYWNpdHkKICAgICAgICAgICAgZHJvcFNoYWRvdzogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHZhciB0cGwgPSAnU1ZHRkVEcm9wU2hhZG93RWxlbWVudCcgaW4gd2luZG93CiAgICAgICAgICAgICAgICAgICAgPyAnPGZpbHRlcj48ZmVEcm9wU2hhZG93IHN0ZERldmlhdGlvbj0iJHtibHVyfSIgZHg9IiR7ZHh9IiBkeT0iJHtkeX0iIGZsb29kLWNvbG9yPSIke2NvbG9yfSIgZmxvb2Qtb3BhY2l0eT0iJHtvcGFjaXR5fSIvPjwvZmlsdGVyPicKICAgICAgICAgICAgICAgICAgICA6ICc8ZmlsdGVyPjxmZUdhdXNzaWFuQmx1ciBpbj0iU291cmNlQWxwaGEiIHN0ZERldmlhdGlvbj0iJHtibHVyfSIvPjxmZU9mZnNldCBkeD0iJHtkeH0iIGR5PSIke2R5fSIgcmVzdWx0PSJvZmZzZXRibHVyIi8+PGZlRmxvb2QgZmxvb2QtY29sb3I9IiR7Y29sb3J9Ii8+PGZlQ29tcG9zaXRlIGluMj0ib2Zmc2V0Ymx1ciIgb3BlcmF0b3I9ImluIi8+PGZlQ29tcG9uZW50VHJhbnNmZXI+PGZlRnVuY0EgdHlwZT0ibGluZWFyIiBzbG9wZT0iJHtvcGFjaXR5fSIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVNZXJnZT48ZmVNZXJnZU5vZGUvPjxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIvPjwvZmVNZXJnZT48L2ZpbHRlcj4nOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKHRwbCwgewogICAgICAgICAgICAgICAgICAgIGR4OiBhcmdzLmR4IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgZHk6IGFyZ3MuZHkgfHwgMCwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiBfLmlzRmluaXRlKGFyZ3Mub3BhY2l0eSkgPyBhcmdzLm9wYWNpdHkgOiAxLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiBhcmdzLmNvbG9yIHx8ICdibGFjaycsCiAgICAgICAgICAgICAgICAgICAgYmx1cjogXy5pc0Zpbml0ZShhcmdzLmJsdXIpID8gYXJncy5ibHVyIDogNAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gdGhlIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMSBpcyBjb21wbGV0ZWx5IGdyYXlzY2FsZS4gQSB2YWx1ZSBvZiAwIGxlYXZlcyB0aGUgaW5wdXQgdW5jaGFuZ2VkLgogICAgICAgICAgICBncmF5c2NhbGU6IGZ1bmN0aW9uKGFyZ3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgYW1vdW50ID0gXy5pc0Zpbml0ZShhcmdzLmFtb3VudCkgPyBhcmdzLmFtb3VudCA6IDE7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIke2F9ICR7Yn0gJHtjfSAwIDAgJHtkfSAke2V9ICR7Zn0gMCAwICR7Z30gJHtifSAke2h9IDAgMCAwIDAgMCAxIDAiLz48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYTogMC4yMTI2ICsgMC43ODc0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGI6IDAuNzE1MiAtIDAuNzE1MiAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBjOiAwLjA3MjIgLSAwLjA3MjIgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZDogMC4yMTI2IC0gMC4yMTI2ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGU6IDAuNzE1MiArIDAuMjg0OCAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBmOiAwLjA3MjIgLSAwLjA3MjIgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZzogMC4yMTI2IC0gMC4yMTI2ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGg6IDAuMDcyMiArIDAuOTI3OCAqICgxIC0gYW1vdW50KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gdGhlIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMSBpcyBjb21wbGV0ZWx5IHNlcGlhLiBBIHZhbHVlIG9mIDAgbGVhdmVzIHRoZSBpbnB1dCB1bmNoYW5nZWQuCiAgICAgICAgICAgIHNlcGlhOiBmdW5jdGlvbihhcmdzKSB7CgogICAgICAgICAgICAgICAgdmFyIGFtb3VudCA9IF8uaXNGaW5pdGUoYXJncy5hbW91bnQpID8gYXJncy5hbW91bnQgOiAxOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIke2F9ICR7Yn0gJHtjfSAwIDAgJHtkfSAke2V9ICR7Zn0gMCAwICR7Z30gJHtofSAke2l9IDAgMCAwIDAgMCAxIDAiLz48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYTogMC4zOTMgKyAwLjYwNyAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBiOiAwLjc2OSAtIDAuNzY5ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGM6IDAuMTg5IC0gMC4xODkgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZDogMC4zNDkgLSAwLjM0OSAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBlOiAwLjY4NiArIDAuMzE0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGY6IDAuMTY4IC0gMC4xNjggKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZzogMC4yNzIgLSAwLjI3MiAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBoOiAwLjUzNCAtIDAuNTM0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGk6IDAuMTMxICsgMC44NjkgKiAoMSAtIGFtb3VudCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYGFtb3VudGAgLi4uIHRoZSBwcm9wb3J0aW9uIG9mIHRoZSBjb252ZXJzaW9uLiBBIHZhbHVlIG9mIDAgaXMgY29tcGxldGVseSB1bi1zYXR1cmF0ZWQuIEEgdmFsdWUgb2YgMSBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgc2F0dXJhdGU6IGZ1bmN0aW9uKGFyZ3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgYW1vdW50ID0gXy5pc0Zpbml0ZShhcmdzLmFtb3VudCkgPyBhcmdzLmFtb3VudCA6IDE7CgogICAgICAgICAgICAgICAgcmV0dXJuIF8udGVtcGxhdGUoJzxmaWx0ZXI+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iJHthbW91bnR9Ii8+PC9maWx0ZXI+JywgewogICAgICAgICAgICAgICAgICAgIGFtb3VudDogMSAtIGFtb3VudAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW5nbGVgIC4uLiAgdGhlIG51bWJlciBvZiBkZWdyZWVzIGFyb3VuZCB0aGUgY29sb3IgY2lyY2xlIHRoZSBpbnB1dCBzYW1wbGVzIHdpbGwgYmUgYWRqdXN0ZWQuCiAgICAgICAgICAgIGh1ZVJvdGF0ZTogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Imh1ZVJvdGF0ZSIgdmFsdWVzPSIke2FuZ2xlfSIvPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBhbmdsZTogYXJncy5hbmdsZSB8fCAwCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIGBhbW91bnRgIC4uLiB0aGUgcHJvcG9ydGlvbiBvZiB0aGUgY29udmVyc2lvbi4gQSB2YWx1ZSBvZiAxIGlzIGNvbXBsZXRlbHkgaW52ZXJ0ZWQuIEEgdmFsdWUgb2YgMCBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgaW52ZXJ0OiBmdW5jdGlvbihhcmdzKSB7CgogICAgICAgICAgICAgICAgdmFyIGFtb3VudCA9IF8uaXNGaW5pdGUoYXJncy5hbW91bnQpID8gYXJncy5hbW91bnQgOiAxOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGZpbHRlcj48ZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVGdW5jUiB0eXBlPSJ0YWJsZSIgdGFibGVWYWx1ZXM9IiR7YW1vdW50fSAke2Ftb3VudDJ9Ii8+PGZlRnVuY0cgdHlwZT0idGFibGUiIHRhYmxlVmFsdWVzPSIke2Ftb3VudH0gJHthbW91bnQyfSIvPjxmZUZ1bmNCIHR5cGU9InRhYmxlIiB0YWJsZVZhbHVlcz0iJHthbW91bnR9ICR7YW1vdW50Mn0iLz48L2ZlQ29tcG9uZW50VHJhbnNmZXI+PC9maWx0ZXI+JywgewogICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICAgICAgICAgIGFtb3VudDI6IDEgLSBhbW91bnQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYGFtb3VudGAgLi4uIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMCB3aWxsIGNyZWF0ZSBhbiBpbWFnZSB0aGF0IGlzIGNvbXBsZXRlbHkgYmxhY2suIEEgdmFsdWUgb2YgMSBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgYnJpZ2h0bmVzczogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbXBvbmVudFRyYW5zZmVyPjxmZUZ1bmNSIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjxmZUZ1bmNHIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjxmZUZ1bmNCIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBfLmlzRmluaXRlKGFyZ3MuYW1vdW50KSA/IGFyZ3MuYW1vdW50IDogMQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gcHJvcG9ydGlvbiBvZiB0aGUgY29udmVyc2lvbi4gQSB2YWx1ZSBvZiAwIHdpbGwgY3JlYXRlIGFuIGltYWdlIHRoYXQgaXMgY29tcGxldGVseSBibGFjay4gQSB2YWx1ZSBvZiAxIGxlYXZlcyB0aGUgaW5wdXQgdW5jaGFuZ2VkLgogICAgICAgICAgICBjb250cmFzdDogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHZhciBhbW91bnQgPSBfLmlzRmluaXRlKGFyZ3MuYW1vdW50KSA/IGFyZ3MuYW1vdW50IDogMTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIF8udGVtcGxhdGUoJzxmaWx0ZXI+PGZlQ29tcG9uZW50VHJhbnNmZXI+PGZlRnVuY1IgdHlwZT0ibGluZWFyIiBzbG9wZT0iJHthbW91bnR9IiBpbnRlcmNlcHQ9IiR7YW1vdW50Mn0iLz48ZmVGdW5jRyB0eXBlPSJsaW5lYXIiIHNsb3BlPSIke2Ftb3VudH0iIGludGVyY2VwdD0iJHthbW91bnQyfSIvPjxmZUZ1bmNCIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIgaW50ZXJjZXB0PSIke2Ftb3VudDJ9Ii8+PC9mZUNvbXBvbmVudFRyYW5zZmVyPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICAgICAgICBhbW91bnQyOiAuNSAtIGFtb3VudCAvIDIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZm9ybWF0OiB7CgogICAgICAgICAgICAvLyBGb3JtYXR0aW5nIG51bWJlcnMgdmlhIHRoZSBQeXRob24gRm9ybWF0IFNwZWNpZmljYXRpb24gTWluaS1sYW5ndWFnZS4KICAgICAgICAgICAgLy8gU2VlIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvcmVsZWFzZS8zLjEuMy9saWJyYXJ5L3N0cmluZy5odG1sI2Zvcm1hdC1zcGVjaWZpY2F0aW9uLW1pbmktbGFuZ3VhZ2UuCiAgICAgICAgICAgIC8vIEhlYXZpbGx5IGluc3BpcmVkIGJ5IHRoZSBEMy5qcyBsaWJyYXJ5IGltcGxlbWVudGF0aW9uLgogICAgICAgICAgICBudW1iZXI6IGZ1bmN0aW9uKHNwZWNpZmllciwgdmFsdWUsIGxvY2FsZSkgewoKICAgICAgICAgICAgICAgIGxvY2FsZSA9IGxvY2FsZSB8fCB7CgogICAgICAgICAgICAgICAgICAgIGN1cnJlbmN5OiBbJyQnLCAnJ10sCiAgICAgICAgICAgICAgICAgICAgZGVjaW1hbDogJy4nLAogICAgICAgICAgICAgICAgICAgIHRob3VzYW5kczogJywnLAogICAgICAgICAgICAgICAgICAgIGdyb3VwaW5nOiBbM10KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNlZSBQeXRob24gZm9ybWF0IHNwZWNpZmljYXRpb24gbWluaS1sYW5ndWFnZTogaHR0cDovL2RvY3MucHl0aG9uLm9yZy9yZWxlYXNlLzMuMS4zL2xpYnJhcnkvc3RyaW5nLmh0bWwjZm9ybWF0LXNwZWNpZmljYXRpb24tbWluaS1sYW5ndWFnZS4KICAgICAgICAgICAgICAgIC8vIFtbZmlsbF1hbGlnbl1bc2lnbl1bc3ltYm9sXVswXVt3aWR0aF1bLF1bLnByZWNpc2lvbl1bdHlwZV0KICAgICAgICAgICAgICAgIHZhciByZSA9IC8oPzooW157XSk/KFs8Pj1eXSkpPyhbK1wtIF0pPyhbJCNdKT8oMCk/KFxkKyk/KCwpPyhcLi0/XGQrKT8oW2EteiVdKT8vaTsKCiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcik7CiAgICAgICAgICAgICAgICB2YXIgZmlsbCA9IG1hdGNoWzFdIHx8ICcgJzsKICAgICAgICAgICAgICAgIHZhciBhbGlnbiA9IG1hdGNoWzJdIHx8ICc+JzsKICAgICAgICAgICAgICAgIHZhciBzaWduID0gbWF0Y2hbM10gfHwgJyc7CiAgICAgICAgICAgICAgICB2YXIgc3ltYm9sID0gbWF0Y2hbNF0gfHwgJyc7CiAgICAgICAgICAgICAgICB2YXIgemZpbGwgPSBtYXRjaFs1XTsKICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9ICttYXRjaFs2XTsKICAgICAgICAgICAgICAgIHZhciBjb21tYSA9IG1hdGNoWzddOwogICAgICAgICAgICAgICAgdmFyIHByZWNpc2lvbiA9IG1hdGNoWzhdOwogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBtYXRjaFs5XTsKICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IDE7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gJyc7CiAgICAgICAgICAgICAgICB2YXIgc3VmZml4ID0gJyc7CiAgICAgICAgICAgICAgICB2YXIgaW50ZWdlciA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChwcmVjaXNpb24pIHByZWNpc2lvbiA9ICtwcmVjaXNpb24uc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoemZpbGwgfHwgZmlsbCA9PT0gJzAnICYmIGFsaWduID09PSAnPScpIHsKICAgICAgICAgICAgICAgICAgICB6ZmlsbCA9IGZpbGwgPSAnMCc7CiAgICAgICAgICAgICAgICAgICAgYWxpZ24gPSAnPSc7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hKSB3aWR0aCAtPSBNYXRoLmZsb29yKCh3aWR0aCAtIDEpIC8gNCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ24nOiBjb21tYSA9IHRydWU7IHR5cGUgPSAnZyc7IGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICclJzogc2NhbGUgPSAxMDA7IHN1ZmZpeCA9ICclJzsgdHlwZSA9ICdmJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ3AnOiBzY2FsZSA9IDEwMDsgc3VmZml4ID0gJyUnOyB0eXBlID0gJ3InOyBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICAgIGNhc2UgJ28nOgogICAgICAgICAgICAgICAgICBjYXNlICd4JzoKICAgICAgICAgICAgICAgICAgY2FzZSAnWCc6IGlmIChzeW1ib2wgPT09ICcjJykgcHJlZml4ID0gJzAnICsgdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICBjYXNlICdjJzoKICAgICAgICAgICAgICAgICAgY2FzZSAnZCc6IGludGVnZXIgPSB0cnVlOyBwcmVjaXNpb24gPSAwOyBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAncyc6IHNjYWxlID0gLTE7IHR5cGUgPSAncic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzeW1ib2wgPT09ICckJykgewogICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IGxvY2FsZS5jdXJyZW5jeVswXTsKICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBsb2NhbGUuY3VycmVuY3lbMV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgbm8gcHJlY2lzaW9uIGlzIHNwZWNpZmllZCBmb3IgYCdyJ2AsIGZhbGxiYWNrIHRvIGdlbmVyYWwgbm90YXRpb24uCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSAncicgJiYgIXByZWNpc2lvbikgdHlwZSA9ICdnJzsKCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgcmVxdWVzdGVkIHByZWNpc2lvbiBpcyBpbiB0aGUgc3VwcG9ydGVkIHJhbmdlLgogICAgICAgICAgICAgICAgaWYgKHByZWNpc2lvbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gJ2cnKSBwcmVjaXNpb24gPSBNYXRoLm1heCgxLCBNYXRoLm1pbigyMSwgcHJlY2lzaW9uKSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnZScgfHwgdHlwZSA9PSAnZicpIHByZWNpc2lvbiA9IE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCBwcmVjaXNpb24pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgemNvbW1hID0gemZpbGwgJiYgY29tbWE7CgogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBlbXB0eSBzdHJpbmcgZm9yIGZsb2F0cyBmb3JtYXR0ZWQgYXMgaW50cy4KICAgICAgICAgICAgICAgIGlmIChpbnRlZ2VyICYmICh2YWx1ZSAlIDEpKSByZXR1cm4gJyc7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBuZWdhdGl2ZSB0byBwb3NpdGl2ZSwgYW5kIHJlY29yZCB0aGUgc2lnbiBwcmVmaXguCiAgICAgICAgICAgICAgICB2YXIgbmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgdmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCA/ICh2YWx1ZSA9IC12YWx1ZSwgJy0nKSA6IHNpZ247CgogICAgICAgICAgICAgICAgdmFyIGZ1bGxTdWZmaXggPSBzdWZmaXg7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRoZSBzY2FsZSwgY29tcHV0aW5nIGl0IGZyb20gdGhlIHZhbHVlJ3MgZXhwb25lbnQgZm9yIHNpIGZvcm1hdC4KICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIHRoZSBleGlzdGluZyBzdWZmaXgsIGlmIGFueSwgc3VjaCBhcyB0aGUgY3VycmVuY3kgc3ltYm9sLgogICAgICAgICAgICAgICAgaWYgKHNjYWxlIDwgMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bml0ID0gdGhpcy5wcmVmaXgodmFsdWUsIHByZWNpc2lvbik7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bml0LnNjYWxlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBmdWxsU3VmZml4ID0gdW5pdC5zeW1ib2wgKyBzdWZmaXg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbHVlICo9IHNjYWxlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gdGhlIGRlc2lyZWQgcHJlY2lzaW9uLgogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmNvbnZlcnQodHlwZSwgdmFsdWUsIHByZWNpc2lvbik7CgogICAgICAgICAgICAgICAgLy8gQnJlYWsgdGhlIHZhbHVlIGludG8gdGhlIGludGVnZXIgcGFydCAoYmVmb3JlKSBhbmQgZGVjaW1hbCBwYXJ0IChhZnRlcikuCiAgICAgICAgICAgICAgICB2YXIgaSA9IHZhbHVlLmxhc3RJbmRleE9mKCcuJyk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlID0gaSA8IDAgPyB2YWx1ZSA6IHZhbHVlLnN1YnN0cmluZygwLCBpKTsKICAgICAgICAgICAgICAgIHZhciBhZnRlciA9IGkgPCAwID8gJycgOiBsb2NhbGUuZGVjaW1hbCArIHZhbHVlLnN1YnN0cmluZyhpICsgMSk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0R3JvdXAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIHZhciBqID0gMDsKICAgICAgICAgICAgICAgICAgICB2YXIgZyA9IGxvY2FsZS5ncm91cGluZ1swXTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5wdXNoKHZhbHVlLnN1YnN0cmluZyhpIC09IGcsIGkgKyBnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGcgPSBsb2NhbGUuZ3JvdXBpbmdbaiA9IChqICsgMSkgJSBsb2NhbGUuZ3JvdXBpbmcubGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4obG9jYWxlLnRob3VzYW5kcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBmaWxsIGNoYXJhY3RlciBpcyBub3QgYCcwJ2AsIGdyb3VwaW5nIGlzIGFwcGxpZWQgYmVmb3JlIHBhZGRpbmcuCiAgICAgICAgICAgICAgICBpZiAoIXpmaWxsICYmIGNvbW1hICYmIGxvY2FsZS5ncm91cGluZykgewoKICAgICAgICAgICAgICAgICAgICBiZWZvcmUgPSBmb3JtYXRHcm91cChiZWZvcmUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBsZW5ndGggPSBwcmVmaXgubGVuZ3RoICsgYmVmb3JlLmxlbmd0aCArIGFmdGVyLmxlbmd0aCArICh6Y29tbWEgPyAwIDogbmVnYXRpdmUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHZhciBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkobGVuZ3RoID0gd2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogJyc7CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGZpbGwgY2hhcmFjdGVyIGlzIGAnMCdgLCBncm91cGluZyBpcyBhcHBsaWVkIGFmdGVyIHBhZGRpbmcuCiAgICAgICAgICAgICAgICBpZiAoemNvbW1hKSBiZWZvcmUgPSBmb3JtYXRHcm91cChwYWRkaW5nICsgYmVmb3JlKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBwcmVmaXguCiAgICAgICAgICAgICAgICBuZWdhdGl2ZSArPSBwcmVmaXg7CgogICAgICAgICAgICAgICAgLy8gUmVqb2luIGludGVnZXIgYW5kIGRlY2ltYWwgcGFydHMuCiAgICAgICAgICAgICAgICB2YWx1ZSA9IGJlZm9yZSArIGFmdGVyOwoKICAgICAgICAgICAgICAgIHJldHVybiAoYWxpZ24gPT09ICc8JyA/IG5lZ2F0aXZlICsgdmFsdWUgKyBwYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIDogYWxpZ24gPT09ICc+JyA/IHBhZGRpbmcgKyBuZWdhdGl2ZSArIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogYWxpZ24gPT09ICdeJyA/IHBhZGRpbmcuc3Vic3RyaW5nKDAsIGxlbmd0aCA+Pj0gMSkgKyBuZWdhdGl2ZSArIHZhbHVlICsgcGFkZGluZy5zdWJzdHJpbmcobGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICA6IG5lZ2F0aXZlICsgKHpjb21tYSA/IHZhbHVlIDogcGFkZGluZyArIHZhbHVlKSkgKyBmdWxsU3VmZml4OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY29udmVydDogZnVuY3Rpb24odHlwZSwgdmFsdWUsIHByZWNpc2lvbikgewoKICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgICBjYXNlICdiJzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDIpOwogICAgICAgICAgICAgICAgICBjYXNlICdjJzogcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUodmFsdWUpOwogICAgICAgICAgICAgICAgICBjYXNlICdvJzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDgpOwogICAgICAgICAgICAgICAgICBjYXNlICd4JzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgICAgICAgY2FzZSAnWCc6IHJldHVybiB2YWx1ZS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgY2FzZSAnZyc6IHJldHVybiB2YWx1ZS50b1ByZWNpc2lvbihwcmVjaXNpb24pOwogICAgICAgICAgICAgICAgICBjYXNlICdlJzogcmV0dXJuIHZhbHVlLnRvRXhwb25lbnRpYWwocHJlY2lzaW9uKTsKICAgICAgICAgICAgICAgICAgY2FzZSAnZic6IHJldHVybiB2YWx1ZS50b0ZpeGVkKHByZWNpc2lvbik7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ3InOiByZXR1cm4gKHZhbHVlID0gdGhpcy5yb3VuZCh2YWx1ZSwgdGhpcy5wcmVjaXNpb24odmFsdWUsIHByZWNpc2lvbikpKS50b0ZpeGVkKE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCB0aGlzLnByZWNpc2lvbih2YWx1ZSAqICgxICsgMWUtMTUpLCBwcmVjaXNpb24pKSkpOwogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIHZhbHVlICsgJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByb3VuZDogZnVuY3Rpb24odmFsdWUsIHByZWNpc2lvbikgewoKICAgICAgICAgICAgICAgIHJldHVybiBwcmVjaXNpb24KICAgICAgICAgICAgICAgICAgICA/IE1hdGgucm91bmQodmFsdWUgKiAocHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbikpKSAvIHByZWNpc2lvbgogICAgICAgICAgICAgICAgICAgIDogTWF0aC5yb3VuZCh2YWx1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwcmVjaXNpb246IGZ1bmN0aW9uKHZhbHVlLCBwcmVjaXNpb24pIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHByZWNpc2lvbiAtICh2YWx1ZSA/IE1hdGguY2VpbChNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMTApIDogMSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwcmVmaXg6IGZ1bmN0aW9uKHZhbHVlLCBwcmVjaXNpb24pIHsKCiAgICAgICAgICAgICAgICB2YXIgcHJlZml4ZXMgPSBfLm1hcChbJ3knLCd6JywnYScsJ2YnLCdwJywnbicsJ8K1JywnbScsJycsJ2snLCdNJywnRycsJ1QnLCdQJywnRScsJ1onLCdZJ10sIGZ1bmN0aW9uKGQsIGkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IE1hdGgucG93KDEwLCBhYnMoOCAtIGkpICogMyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IGkgPiA4ID8gZnVuY3Rpb24oZCkgeyByZXR1cm4gZCAvIGs7IH0gOiBmdW5jdGlvbihkKSB7IHJldHVybiBkICogazsgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc3ltYm9sOiBkCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSAqPSAtMTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJlY2lzaW9uKSB2YWx1ZSA9IGQzLnJvdW5kKHZhbHVlLCB0aGlzLnByZWNpc2lvbih2YWx1ZSwgcHJlY2lzaW9uKSk7CiAgICAgICAgICAgICAgICAgICAgaSA9IDEgKyBNYXRoLmZsb29yKDFlLTEyICsgTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjEwKTsKICAgICAgICAgICAgICAgICAgICBpID0gTWF0aC5tYXgoLTI0LCBNYXRoLm1pbigyNCwgTWF0aC5mbG9vcigoaSA8PSAwID8gaSArIDEgOiBpIC0gMSkgLyAzKSAqIDMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlc1s4ICsgaSAvIDNdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQ7Cn0KCi8vICAgICAgSm9pbnRKUywgdGhlIEphdmFTY3JpcHQgZGlhZ3JhbW1pbmcgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmxpbmsnKS5MaW5rLAogICAgICAgICAgICBFbGVtZW50OiByZXF1aXJlKCcuL2pvaW50LmRpYS5lbGVtZW50JykuRWxlbWVudAogICAgICAgIH0sCiAgICAgICAgc2hhcGVzOiByZXF1aXJlKCcuLi9wbHVnaW5zL3NoYXBlcycpCiAgICB9OwogICAgdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CiAgICB2YXIgZyA9IHJlcXVpcmUoJy4vZ2VvbWV0cnknKTsKfQoKCgpqb2ludC5kaWEuR3JhcGhDZWxscyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICAvLyBCYWNrYm9uZSBhdXRvbWF0aWNhbGx5IGRvZXNuJ3QgdHJpZ2dlciByZS1zb3J0IGlmIG1vZGVscyBhdHRyaWJ1dGVzIGFyZSBjaGFuZ2VkIGxhdGVyIHdoZW4KICAgICAgICAvLyB0aGV5J3JlIGFscmVhZHkgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZXJlZm9yZSwgd2UncmUgdHJpZ2dlcmluZyBzb3J0IG1hbnVhbGx5IGhlcmUuCiAgICAgICAgdGhpcy5vbignY2hhbmdlOnonLCB0aGlzLnNvcnQsIHRoaXMpOwogICAgfSwKCiAgICBtb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCiAgICAgICAgaWYgKGF0dHJzLnR5cGUgPT09ICdsaW5rJykgewoKICAgICAgICAgICAgcmV0dXJuIG5ldyBqb2ludC5kaWEuTGluayhhdHRycywgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbW9kdWxlID0gYXR0cnMudHlwZS5zcGxpdCgnLicpWzBdOwogICAgICAgIHZhciBlbnRpdHkgPSBhdHRycy50eXBlLnNwbGl0KCcuJylbMV07CgogICAgICAgIGlmIChqb2ludC5zaGFwZXNbbW9kdWxlXSAmJiBqb2ludC5zaGFwZXNbbW9kdWxlXVtlbnRpdHldKSB7CgogICAgICAgICAgICByZXR1cm4gbmV3IGpvaW50LnNoYXBlc1ttb2R1bGVdW2VudGl0eV0oYXR0cnMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbmV3IGpvaW50LmRpYS5FbGVtZW50KGF0dHJzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gYGNvbXBhcmF0b3JgIG1ha2VzIGl0IGVhc3kgdG8gc29ydCBjZWxscyBiYXNlZCBvbiB0aGVpciBgemAgaW5kZXguCiAgICBjb21wYXJhdG9yOiBmdW5jdGlvbihtb2RlbCkgewoKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KCd6JykgfHwgMDsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBpbmJvdW5kIGFuZCBvdXRib3VuZCBsaW5rcyBjb25uZWN0ZWQgdG8gdGhlIGNlbGwgYG1vZGVsYC4KICAgIGdldENvbm5lY3RlZExpbmtzOiBmdW5jdGlvbihtb2RlbCwgb3B0KSB7CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQob3B0LmluYm91bmQpICYmIF8uaXNVbmRlZmluZWQob3B0Lm91dGJvdW5kKSkgewogICAgICAgICAgICBvcHQuaW5ib3VuZCA9IG9wdC5vdXRib3VuZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGlua3MgPSBbXTsKICAgICAgICAKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGNlbGwuZ2V0KCdzb3VyY2UnKTsKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGNlbGwuZ2V0KCd0YXJnZXQnKTsKCiAgICAgICAgICAgIGlmIChzb3VyY2UgJiYgc291cmNlLmlkID09PSBtb2RlbC5pZCAmJiBvcHQub3V0Ym91bmQpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGlua3MucHVzaChjZWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuaWQgPT09IG1vZGVsLmlkICYmIG9wdC5pbmJvdW5kKSB7CgogICAgICAgICAgICAgICAgbGlua3MucHVzaChjZWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gbGlua3M7CiAgICB9Cn0pOwoKCmpvaW50LmRpYS5HcmFwaCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMuc2V0KCdjZWxscycsIG5ldyBqb2ludC5kaWEuR3JhcGhDZWxscyk7CgogICAgICAgIC8vIE1ha2UgYWxsIHRoZSBldmVudHMgZmlyZWQgaW4gdGhlIGBjZWxsc2AgY29sbGVjdGlvbiBhdmFpbGFibGUuCiAgICAgICAgLy8gdG8gdGhlIG91dHNpZGUgd29ybGQuCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykub24oJ2FsbCcsIHRoaXMudHJpZ2dlciwgdGhpcyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykub24oJ3JlbW92ZScsIHRoaXMucmVtb3ZlQ2VsbCwgdGhpcyk7CiAgICB9LAoKICAgIHRvSlNPTjogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIEJhY2tib25lIGRvZXMgbm90IHJlY3Vyc2l2ZWx5IGNhbGwgYHRvSlNPTigpYCBvbiBhdHRyaWJ1dGVzIHRoYXQgYXJlIHRoZW1zZWx2ZXMgbW9kZWxzL2NvbGxlY3Rpb25zLgogICAgICAgIC8vIEl0IGp1c3QgY2xvbmVzIHRoZSBhdHRyaWJ1dGVzLiBUaGVyZWZvcmUsIHdlIG11c3QgY2FsbCBgdG9KU09OKClgIG9uIHRoZSBjZWxscyBjb2xsZWN0aW9uIGV4cGxpY2l0ZWx5LgogICAgICAgIHZhciBqc29uID0gQmFja2JvbmUuTW9kZWwucHJvdG90eXBlLnRvSlNPTi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGpzb24uY2VsbHMgPSB0aGlzLmdldCgnY2VsbHMnKS50b0pTT04oKTsKICAgICAgICByZXR1cm4ganNvbjsKICAgIH0sCgogICAgZnJvbUpTT046IGZ1bmN0aW9uKGpzb24sIG9wdCkgewoKICAgICAgICBpZiAoIWpzb24uY2VsbHMpIHsKCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JhcGggSlNPTiBtdXN0IGNvbnRhaW4gY2VsbHMgYXJyYXkuJyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldChfLm9taXQoanNvbiwgJ2NlbGxzJyksIG9wdCk7CiAgICAgICAgdGhpcy5yZXNldENlbGxzKGpzb24uY2VsbHMsIG9wdCk7CiAgICB9LAoKICAgIGNsZWFyOiBmdW5jdGlvbihvcHQpIHsKCiAgICAgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdGFydCcpOwogICAgICAgIHRoaXMuZ2V0KCdjZWxscycpLnJlbW92ZSh0aGlzLmdldCgnY2VsbHMnKS5tb2RlbHMsIG9wdCk7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICB9LAoKICAgIF9wcmVwYXJlQ2VsbDogZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICBpZiAoY2VsbCBpbnN0YW5jZW9mIEJhY2tib25lLk1vZGVsICYmIF8uaXNVbmRlZmluZWQoY2VsbC5nZXQoJ3onKSkpIHsKCiAgICAgICAgICAgIGNlbGwuc2V0KCd6JywgdGhpcy5tYXhaSW5kZXgoKSArIDEsIHsgc2lsZW50OiB0cnVlIH0pOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKF8uaXNVbmRlZmluZWQoY2VsbC56KSkgewoKICAgICAgICAgICAgY2VsbC56ID0gdGhpcy5tYXhaSW5kZXgoKSArIDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2VsbDsKICAgIH0sCgogICAgbWF4WkluZGV4OiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGxhc3RDZWxsID0gdGhpcy5nZXQoJ2NlbGxzJykubGFzdCgpOwogICAgICAgIHJldHVybiBsYXN0Q2VsbCA/IChsYXN0Q2VsbC5nZXQoJ3onKSB8fCAwKSA6IDA7CiAgICB9LAoKICAgIGFkZENlbGw6IGZ1bmN0aW9uKGNlbGwsIG9wdGlvbnMpIHsKCiAgICAgICAgaWYgKF8uaXNBcnJheShjZWxsKSkgewoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkQ2VsbHMoY2VsbCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdldCgnY2VsbHMnKS5hZGQodGhpcy5fcHJlcGFyZUNlbGwoY2VsbCksIG9wdGlvbnMgfHwge30pOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgYWRkQ2VsbHM6IGZ1bmN0aW9uKGNlbGxzLCBvcHRpb25zKSB7CgogICAgICAgIF8uZWFjaChjZWxscywgZnVuY3Rpb24oY2VsbCkgeyB0aGlzLmFkZENlbGwoY2VsbCwgb3B0aW9ucyk7IH0sIHRoaXMpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiBhZGRpbmcgYSBsb3Qgb2YgY2VsbHMsIGl0IGlzIG11Y2ggbW9yZSBlZmZpY2llbnQgdG8KICAgIC8vIHJlc2V0IHRoZSBlbnRpcmUgY2VsbHMgY29sbGVjdGlvbiBpbiBvbmUgZ28uCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0Q2VsbHM6IGZ1bmN0aW9uKGNlbGxzLCBvcHQpIHsKICAgICAgICAKICAgICAgICB0aGlzLmdldCgnY2VsbHMnKS5yZXNldChfLm1hcChjZWxscywgdGhpcy5fcHJlcGFyZUNlbGwsIHRoaXMpLCBvcHQpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVtb3ZlQ2VsbDogZnVuY3Rpb24oY2VsbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewoKICAgICAgICAvLyBBcHBsaWNhdGlvbnMgbWlnaHQgcHJvdmlkZSBhIGBkaXNjb25uZWN0TGlua3NgIG9wdGlvbiBzZXQgdG8gYHRydWVgIGluIG9yZGVyIHRvCiAgICAgICAgLy8gZGlzY29ubmVjdCBsaW5rcyB3aGVuIGEgY2VsbCBpcyByZW1vdmVkIHJhdGhlciB0aGVuIHJlbW92aW5nIHRoZW0uIFRoZSBkZWZhdWx0CiAgICAgICAgLy8gaXMgdG8gcmVtb3ZlIGFsbCB0aGUgYXNzb2NpYXRlZCBsaW5rcy4KICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRpc2Nvbm5lY3RMaW5rcykgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0TGlua3MoY2VsbCk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICB0aGlzLnJlbW92ZUxpbmtzKGNlbGwpOwogICAgICAgIH0KCiAgICAgICAgLy8gU2lsZW50bHkgcmVtb3ZlIHRoZSBjZWxsIGZyb20gdGhlIGNlbGxzIGNvbGxlY3Rpb24uIFNpbGVudGx5LCBiZWNhdXNlCiAgICAgICAgLy8gYGpvaW50LmRpYS5DZWxsLnByb3RvdHlwZS5yZW1vdmVgIGFscmVhZHkgdHJpZ2dlcnMgdGhlIGByZW1vdmVgIGV2ZW50IHdoaWNoIGlzCiAgICAgICAgLy8gdGhlbiBwcm9wYWdhdGVkIHRvIHRoZSBncmFwaCBtb2RlbC4gSWYgd2UgZGlkbid0IHJlbW92ZSB0aGUgY2VsbCBzaWxlbnRseSwgdHdvIGByZW1vdmVgIGV2ZW50cwogICAgICAgIC8vIHdvdWxkIGJlIHRyaWdnZXJlZCBvbiB0aGUgZ3JhcGggbW9kZWwuCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykucmVtb3ZlKGNlbGwsIHsgc2lsZW50OiB0cnVlIH0pOwogICAgfSwKCiAgICAvLyBHZXQgYSBjZWxsIGJ5IGBpZGAuCiAgICBnZXRDZWxsOiBmdW5jdGlvbihpZCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2NlbGxzJykuZ2V0KGlkKTsKICAgIH0sCgogICAgZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2NlbGxzJykuZmlsdGVyKGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgICAgIHJldHVybiBjZWxsIGluc3RhbmNlb2Ygam9pbnQuZGlhLkVsZW1lbnQ7CiAgICAgICAgfSk7CiAgICB9LAogICAgCiAgICBnZXRMaW5rczogZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldCgnY2VsbHMnKS5maWx0ZXIoZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgcmV0dXJuIGNlbGwgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluazsKICAgICAgICB9KTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBpbmJvdW5kIGFuZCBvdXRib3VuZCBsaW5rcyBjb25uZWN0ZWQgdG8gdGhlIGNlbGwgYG1vZGVsYC4KICAgIGdldENvbm5lY3RlZExpbmtzOiBmdW5jdGlvbihtb2RlbCwgb3B0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldCgnY2VsbHMnKS5nZXRDb25uZWN0ZWRMaW5rcyhtb2RlbCwgb3B0KTsKICAgIH0sCgogICAgZ2V0TmVpZ2hib3JzOiBmdW5jdGlvbihlbCkgewoKICAgICAgICB2YXIgbGlua3MgPSB0aGlzLmdldENvbm5lY3RlZExpbmtzKGVsKTsKICAgICAgICB2YXIgbmVpZ2hib3JzID0gW107CiAgICAgICAgdmFyIGNlbGxzID0gdGhpcy5nZXQoJ2NlbGxzJyk7CiAgICAgICAgCiAgICAgICAgXy5lYWNoKGxpbmtzLCBmdW5jdGlvbihsaW5rKSB7CgogICAgICAgICAgICB2YXIgc291cmNlID0gbGluay5nZXQoJ3NvdXJjZScpOwogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gbGluay5nZXQoJ3RhcmdldCcpOwoKICAgICAgICAgICAgLy8gRGlzY2FyZCBpZiBpdCBpcyBhIHBvaW50LgogICAgICAgICAgICBpZiAoIXNvdXJjZS54KSB7CiAgICAgICAgICAgICAgICB2YXIgc291cmNlRWxlbWVudCA9IGNlbGxzLmdldChzb3VyY2UuaWQpOwogICAgICAgICAgICAgICAgaWYgKHNvdXJjZUVsZW1lbnQgIT09IGVsKSB7CgogICAgICAgICAgICAgICAgICAgIG5laWdoYm9ycy5wdXNoKHNvdXJjZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGFyZ2V0LngpIHsKICAgICAgICAgICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gY2VsbHMuZ2V0KHRhcmdldC5pZCk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0RWxlbWVudCAhPT0gZWwpIHsKCiAgICAgICAgICAgICAgICAgICAgbmVpZ2hib3JzLnB1c2godGFyZ2V0RWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG5laWdoYm9yczsKICAgIH0sCiAgICAKICAgIC8vIERpc2Nvbm5lY3QgbGlua3MgY29ubmVjdGVkIHRvIHRoZSBjZWxsIGBtb2RlbGAuCiAgICBkaXNjb25uZWN0TGlua3M6IGZ1bmN0aW9uKG1vZGVsKSB7CgogICAgICAgIF8uZWFjaCh0aGlzLmdldENvbm5lY3RlZExpbmtzKG1vZGVsKSwgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgbGluay5zZXQobGluay5nZXQoJ3NvdXJjZScpLmlkID09PSBtb2RlbC5pZCA/ICdzb3VyY2UnIDogJ3RhcmdldCcsIGcucG9pbnQoMCwgMCkpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZW1vdmUgbGlua3MgY29ubmVjdGVkIHRvIHRoZSBjZWxsIGBtb2RlbGAgY29tcGxldGVseS4KICAgIHJlbW92ZUxpbmtzOiBmdW5jdGlvbihtb2RlbCkgewoKICAgICAgICBfLmludm9rZSh0aGlzLmdldENvbm5lY3RlZExpbmtzKG1vZGVsKSwgJ3JlbW92ZScpOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBhdCBnaXZlbiBwb2ludAogICAgZmluZE1vZGVsc0Zyb21Qb2ludDogZnVuY3Rpb24ocCkgewoKCXJldHVybiBfLmZpbHRlcih0aGlzLmdldEVsZW1lbnRzKCksIGZ1bmN0aW9uKGVsKSB7CgkgICAgcmV0dXJuIGVsLmdldEJCb3goKS5jb250YWluc1BvaW50KHApOwoJfSk7CiAgICB9LAoKICAgIC8vIEZpbmQgYWxsIHZpZXdzIGluIGdpdmVuIGFyZWEKICAgIGZpbmRNb2RlbHNJbkFyZWE6IGZ1bmN0aW9uKHIpIHsKCglyZXR1cm4gXy5maWx0ZXIodGhpcy5nZXRFbGVtZW50cygpLCBmdW5jdGlvbihlbCkgewoJICAgIHJldHVybiBlbC5nZXRCQm94KCkuaW50ZXJzZWN0KHIpOwoJfSk7CiAgICB9LAoKICAgIC8vIFJldHVybiB0aGUgYm91bmRpbmcgYm94IG9mIGFsbCBgZWxlbWVudHNgLgogICAgZ2V0QkJveDogZnVuY3Rpb24oZWxlbWVudHMpIHsKCgl2YXIgb3JpZ2luID0geyB4OiBJbmZpbml0eSwgeTogSW5maW5pdHkgfTsKCXZhciBjb3JuZXIgPSB7IHg6IDAsIHk6IDAgfTsKCQoJXy5lYWNoKGVsZW1lbnRzLCBmdW5jdGlvbihjZWxsKSB7CgkgICAgCgkgICAgdmFyIGJib3ggPSBjZWxsLmdldEJCb3goKTsKCSAgICBvcmlnaW4ueCA9IE1hdGgubWluKG9yaWdpbi54LCBiYm94LngpOwoJICAgIG9yaWdpbi55ID0gTWF0aC5taW4ob3JpZ2luLnksIGJib3gueSk7CgkgICAgY29ybmVyLnggPSBNYXRoLm1heChjb3JuZXIueCwgYmJveC54ICsgYmJveC53aWR0aCk7CgkgICAgY29ybmVyLnkgPSBNYXRoLm1heChjb3JuZXIueSwgYmJveC55ICsgYmJveC5oZWlnaHQpOwoJfSk7CgoJcmV0dXJuIGcucmVjdChvcmlnaW4ueCwgb3JpZ2luLnksIGNvcm5lci54IC0gb3JpZ2luLngsIGNvcm5lci55IC0gb3JpZ2luLnkpOwogICAgfQoKfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkdyYXBoID0gam9pbnQuZGlhLkdyYXBoOwp9CgovLyAgICAgIEpvaW50SlMuCi8vICAgICAgKGMpIDIwMTEtMjAxMyBjbGllbnQgSU8KCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgdmFyIGpvaW50ID0gewogICAgICAgIHV0aWw6IHJlcXVpcmUoJy4vY29yZScpLnV0aWwsCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKLy8gam9pbnQuZGlhLkNlbGwgYmFzZSBtb2RlbC4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmpvaW50LmRpYS5DZWxsID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKCiAgICAvLyBUaGlzIGlzIHRoZSBzYW1lIGFzIEJhY2tib25lLk1vZGVsIHdpdGggdGhlIG9ubHkgZGlmZmVyZW5jZSB0aGF0IGlzIHVzZXMgXy5tZXJnZQogICAgLy8gaW5zdGVhZCBvZiBqdXN0IF8uZXh0ZW5kLiBUaGUgcmVhc29uIGlzIHRoYXQgd2Ugd2FudCB0byBtaXhpbiBhdHRyaWJ1dGVzIHNldCBpbiB1cHBlciBjbGFzc2VzLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKCiAgICAgICAgdmFyIGRlZmF1bHRzOwogICAgICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgICAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgICAgLy8gUmVwbGFjZWQgdGhlIGNhbGwgdG8gXy5kZWZhdWx0cyB3aXRoIF8ubWVyZ2UuCiAgICAgICAgICAgIGF0dHJzID0gXy5tZXJnZSh7fSwgZGVmYXVsdHMsIGF0dHJzKTsKICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgIH0KICAgICAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHRvSlNPTjogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBkZWZhdWx0QXR0cnMgPSB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5kZWZhdWx0cy5hdHRycyB8fCB7fTsKICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLmF0dHJpYnV0ZXMuYXR0cnM7CiAgICAgICAgdmFyIGZpbmFsQXR0cnMgPSB7fTsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgYXR0cmlidXRlcyBhbmQKICAgICAgICAvLyBvbWl0IHRoZSBkZWZhdWx0IGF0dHJpYnV0ZXMgYXMgdGhleSBhcmUgaW1wbGljaXRseSByZWNvbnN0cnVjdGFibGUgYnkgdGhlIGNlbGwgJ3R5cGUnLgogICAgICAgIF8uZWFjaChhdHRycywgZnVuY3Rpb24oYXR0ciwgc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBkZWZhdWx0QXR0ciA9IGRlZmF1bHRBdHRyc1tzZWxlY3Rvcl07CgogICAgICAgICAgICBfLmVhY2goYXR0ciwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gYXR0ciBpcyBtYWlubHkgZmxhdCB0aG91Z2ggaXQgbWlnaHQgaGF2ZSBvbmUgbW9yZSBsZXZlbCAoY29uc2lkZXIgdGhlIGBzdHlsZWAgYXR0cmlidXRlKS4KICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBgdmFsdWVgIGlzIG9iamVjdCBhbmQgaWYgeWVzLCBnbyBvbmUgbGV2ZWwgZGVlcC4KICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHZhbHVlKSAmJiAhXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF8uZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsdWUyLCBuYW1lMikgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZWZhdWx0QXR0ciB8fCAhZGVmYXVsdEF0dHJbbmFtZV0gfHwgIV8uaXNFcXVhbChkZWZhdWx0QXR0cltuYW1lXVtuYW1lMl0sIHZhbHVlMikpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbEF0dHJzW3NlbGVjdG9yXSA9IGZpbmFsQXR0cnNbc2VsZWN0b3JdIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZpbmFsQXR0cnNbc2VsZWN0b3JdW25hbWVdIHx8IChmaW5hbEF0dHJzW3NlbGVjdG9yXVtuYW1lXSA9IHt9KSlbbmFtZTJdID0gdmFsdWUyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGVmYXVsdEF0dHIgfHwgIV8uaXNFcXVhbChkZWZhdWx0QXR0cltuYW1lXSwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYHZhbHVlYCBpcyBub3QgYW4gb2JqZWN0LCBkZWZhdWx0IGF0dHJpYnV0ZSBmb3Igc3VjaCBhIHNlbGVjdG9yIGRvZXMgbm90IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgLy8gb3IgaXQgaXMgZGlmZmVyZW50IHRoYW4gdGhlIGF0dHJpYnV0ZSB2YWx1ZSBzZXQgb24gdGhlIG1vZGVsLgoKICAgICAgICAgICAgICAgICAgICBmaW5hbEF0dHJzW3NlbGVjdG9yXSA9IGZpbmFsQXR0cnNbc2VsZWN0b3JdIHx8IHt9OwogICAgICAgICAgICAgICAgICAgIGZpbmFsQXR0cnNbc2VsZWN0b3JdW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgYXR0cmlidXRlcyA9IF8uY2xvbmVEZWVwKF8ub21pdCh0aGlzLmF0dHJpYnV0ZXMsICdhdHRycycpKTsKICAgICAgICAvL3ZhciBhdHRyaWJ1dGVzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShfLm9taXQodGhpcy5hdHRyaWJ1dGVzLCAnYXR0cnMnKSkpOwogICAgICAgIGF0dHJpYnV0ZXMuYXR0cnMgPSBmaW5hbEF0dHJzOwoKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewoKICAgICAgICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuaWQpIHsKCiAgICAgICAgICAgIHRoaXMuc2V0KCdpZCcsIGpvaW50LnV0aWwudXVpZCgpLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgICB9CgoJdGhpcy5fdHJhbnNpdGlvbklkcyA9IHt9OwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIGRlZmluZWQgaW4gYGF0dHJzYCBhbmQga2VlcCBjb2xsZWN0aW5nIHdoZW5ldmVyIGBhdHRyc2Agb2JqZWN0IGNoYW5nZXMuCiAgICAgICAgdGhpcy5wcm9jZXNzUG9ydHMoKTsKICAgICAgICB0aGlzLm9uKCdjaGFuZ2U6YXR0cnMnLCB0aGlzLnByb2Nlc3NQb3J0cywgdGhpcyk7CiAgICB9LAoKICAgIHByb2Nlc3NQb3J0czogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIFdoZW5ldmVyIGBhdHRyc2AgY2hhbmdlcywgd2UgZXh0cmFjdCBwb3J0cyBmcm9tIHRoZSBgYXR0cnNgIG9iamVjdCBhbmQgc3RvcmUgaXQKICAgICAgICAvLyBpbiBhIG1vcmUgYWNjZXNzaWJsZSB3YXkuIEFsc28sIGlmIGFueSBwb3J0IGdvdCByZW1vdmVkIGFuZCB0aGVyZSB3ZXJlIGxpbmtzIHRoYXQgaGFkIGB0YXJnZXRgL2Bzb3VyY2VgCiAgICAgICAgLy8gc2V0IHRvIHRoYXQgcG9ydCwgd2UgcmVtb3ZlIHRob3NlIGxpbmtzIGFzIHdlbGwgKHRvIGZvbGxvdyB0aGUgc2FtZSBiZWhhdmlvdXIgYXMKICAgICAgICAvLyB3aXRoIGEgcmVtb3ZlZCBlbGVtZW50KS4KCiAgICAgICAgdmFyIHByZXZpb3VzUG9ydHMgPSB0aGlzLnBvcnRzOwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIGZyb20gdGhlIGBhdHRyc2Agb2JqZWN0LgogICAgICAgIHZhciBwb3J0cyA9IHt9OwogICAgICAgIF8uZWFjaCh0aGlzLmdldCgnYXR0cnMnKSwgZnVuY3Rpb24oYXR0cnMsIHNlbGVjdG9yKSB7CgogICAgICAgICAgICBpZiAoYXR0cnMgJiYgYXR0cnMucG9ydCkgewoKICAgICAgICAgICAgICAgIC8vIGBwb3J0YCBjYW4gZWl0aGVyIGJlIGRpcmVjdGx5IGFuIGBpZGAgb3IgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYW4gYGlkYCAoYW5kIHBvdGVudGlhbGx5IG90aGVyIGRhdGEpLgogICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLnBvcnQuaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgcG9ydHNbYXR0cnMucG9ydC5pZF0gPSBhdHRycy5wb3J0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwb3J0c1thdHRycy5wb3J0XSA9IHsgaWQ6IGF0dHJzLnBvcnQgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgKGNvbXBhcmVkIHRvIHRoZSBwcmV2aW91cyBwb3J0cykgLSBpZiBhbnkuCiAgICAgICAgLy8gVXNlIGhhc2ggdGFibGUgZm9yIHF1aWNrIGxvb2t1cC4KICAgICAgICB2YXIgcmVtb3ZlZFBvcnRzID0ge307CiAgICAgICAgXy5lYWNoKHByZXZpb3VzUG9ydHMsIGZ1bmN0aW9uKHBvcnQsIGlkKSB7CgogICAgICAgICAgICBpZiAoIXBvcnRzW2lkXSkgcmVtb3ZlZFBvcnRzW2lkXSA9IHRydWU7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFJlbW92ZSBhbGwgdGhlIGluY29taW5nL291dGdvaW5nIGxpbmtzIHRoYXQgaGF2ZSBzb3VyY2UvdGFyZ2V0IHBvcnQgc2V0IHRvIGFueSBvZiB0aGUgcmVtb3ZlZCBwb3J0cy4KICAgICAgICBpZiAodGhpcy5jb2xsZWN0aW9uICYmICFfLmlzRW1wdHkocmVtb3ZlZFBvcnRzKSkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGluYm91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyh0aGlzLCB7IGluYm91bmQ6IHRydWUgfSk7CiAgICAgICAgICAgIF8uZWFjaChpbmJvdW5kTGlua3MsIGZ1bmN0aW9uKGxpbmspIHsKCiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZFBvcnRzW2xpbmsuZ2V0KCd0YXJnZXQnKS5wb3J0XSkgbGluay5yZW1vdmUoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgb3V0Ym91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyh0aGlzLCB7IG91dGJvdW5kOiB0cnVlIH0pOwogICAgICAgICAgICBfLmVhY2gob3V0Ym91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgIGlmIChyZW1vdmVkUG9ydHNbbGluay5nZXQoJ3NvdXJjZScpLnBvcnRdKSBsaW5rLnJlbW92ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgYHBvcnRzYCBvYmplY3QuCiAgICAgICAgdGhpcy5wb3J0cyA9IHBvcnRzOwogICAgfSwKCiAgICByZW1vdmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCgl2YXIgY29sbGVjdGlvbiA9IHRoaXMuY29sbGVjdGlvbjsKCglpZiAoY29sbGVjdGlvbikgewoJICAgIGNvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCX0KCiAgICAgICAgLy8gRmlyc3QsIHVuZW1iZWQgdGhpcyBjZWxsIGZyb20gaXRzIHBhcmVudCBjZWxsIGlmIHRoZXJlIGlzIG9uZS4KICAgICAgICB2YXIgcGFyZW50Q2VsbElkID0gdGhpcy5nZXQoJ3BhcmVudCcpOwogICAgICAgIGlmIChwYXJlbnRDZWxsSWQpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBwYXJlbnRDZWxsID0gdGhpcy5jb2xsZWN0aW9uICYmIHRoaXMuY29sbGVjdGlvbi5nZXQocGFyZW50Q2VsbElkKTsKICAgICAgICAgICAgcGFyZW50Q2VsbC51bmVtYmVkKHRoaXMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBfLmludm9rZSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgJ3JlbW92ZScsIG9wdGlvbnMpOwogICAgICAgIAogICAgICAgIHRoaXMudHJpZ2dlcigncmVtb3ZlJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBvcHRpb25zKTsKCglpZiAoY29sbGVjdGlvbikgewoJICAgIGNvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoJfQoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICB0b0Zyb250OiBmdW5jdGlvbigpIHsKCiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewoKICAgICAgICAgICAgdGhpcy5zZXQoJ3onLCAodGhpcy5jb2xsZWN0aW9uLmxhc3QoKS5nZXQoJ3onKSB8fCAwKSArIDEpOwogICAgICAgIH0KCglyZXR1cm4gdGhpczsKICAgIH0sCiAgICAKICAgIHRvQmFjazogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2V0KCd6JywgKHRoaXMuY29sbGVjdGlvbi5maXJzdCgpLmdldCgneicpIHx8IDApIC0gMSk7CiAgICAgICAgfQoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICBlbWJlZDogZnVuY3Rpb24oY2VsbCkgewoKCWlmICh0aGlzLmdldCgncGFyZW50JykgPT0gY2VsbC5pZCkgewoKCSAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY3Vyc2l2ZSBlbWJlZGRpbmcgbm90IGFsbG93ZWQuJyk7CgoJfSBlbHNlIHsKCgkgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdGFydCcpOwoKCSAgICBjZWxsLnNldCgncGFyZW50JywgdGhpcy5pZCk7CgkgICAgdGhpcy5zZXQoJ2VtYmVkcycsIF8udW5pcSgodGhpcy5nZXQoJ2VtYmVkcycpIHx8IFtdKS5jb25jYXQoW2NlbGwuaWRdKSkpOwoKCSAgICB0aGlzLnRyaWdnZXIoJ2JhdGNoOnN0b3AnKTsKCX0KCglyZXR1cm4gdGhpczsKICAgIH0sCgogICAgdW5lbWJlZDogZnVuY3Rpb24oY2VsbCkgewoKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCiAgICAgICAgdmFyIGNlbGxJZCA9IGNlbGwuaWQ7CiAgICAgICAgY2VsbC51bnNldCgncGFyZW50Jyk7CgogICAgICAgIHRoaXMuc2V0KCdlbWJlZHMnLCBfLndpdGhvdXQodGhpcy5nZXQoJ2VtYmVkcycpLCBjZWxsSWQpKTsKCgl0aGlzLnRyaWdnZXIoJ2JhdGNoOnN0b3AnKTsKCglyZXR1cm4gdGhpczsKICAgIH0sCgogICAgZ2V0RW1iZWRkZWRDZWxsczogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIENlbGwgbW9kZWxzIGNhbiBvbmx5IGJlIHJldHJpZXZlZCB3aGVuIHRoaXMgZWxlbWVudCBpcyBwYXJ0IG9mIGEgY29sbGVjdGlvbi4KICAgICAgICAvLyBUaGVyZSBpcyBubyB3YXkgdGhpcyBlbGVtZW50IGtub3dzIGFib3V0IG90aGVyIGNlbGxzIG90aGVyd2lzZS4KICAgICAgICAvLyBUaGlzIGFsc28gbWVhbnMgdGhhdCBjYWxsaW5nIGUuZy4gYHRyYW5zbGF0ZSgpYCBvbiBhbiBlbGVtZW50IHdpdGggZW1iZWRzIGJlZm9yZQogICAgICAgIC8vIGFkZGluZyBpdCB0byBhIGdyYXBoIGRvZXMgbm90IHRyYW5zbGF0ZSBpdHMgZW1iZWRzLgogICAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKCiAgICAgICAgICAgIHJldHVybiBfLm1hcCh0aGlzLmdldCgnZW1iZWRzJykgfHwgW10sIGZ1bmN0aW9uKGNlbGxJZCkgewoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb24uZ2V0KGNlbGxJZCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgIH0sCgogICAgY2xvbmU6IGZ1bmN0aW9uKG9wdCkgewoKICAgICAgICBvcHQgPSBvcHQgfHwge307CgogICAgICAgIHZhciBjbG9uZSA9IEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5jbG9uZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIGNsb25lIHRvIGhhdmUgdGhlIHNhbWUgSUQgYXMgdGhlIG9yaWdpbmFsLgogICAgICAgIGNsb25lLnNldCgnaWQnLCBqb2ludC51dGlsLnV1aWQoKSwgeyBzaWxlbnQ6IHRydWUgfSk7CiAgICAgICAgY2xvbmUuc2V0KCdlbWJlZHMnLCAnJyk7CgogICAgICAgIGlmICghb3B0LmRlZXApIHJldHVybiBjbG9uZTsKCiAgICAgICAgLy8gVGhlIHJlc3Qgb2YgdGhlIGBjbG9uZSgpYCBtZXRob2QgZGVhbHMgd2l0aCBlbWJlZHMuIElmIGBkZWVwYCBvcHRpb24gaXMgc2V0IHRvIGB0cnVlYCwKICAgICAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIGlzIGFuIGFycmF5IG9mIGFsbCB0aGUgZW1iZWRkZWQgY2xvbmVzIGNyZWF0ZWQuCgogICAgICAgIHZhciBlbWJlZHMgPSBfLnNvcnRCeSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgZnVuY3Rpb24oY2VsbCkgewogICAgICAgICAgICAvLyBTb3J0IGVtYmVkcyB0aGF0IGxpbmtzIGNvbWUgYmVmb3JlIGVsZW1lbnRzLgogICAgICAgICAgICByZXR1cm4gY2VsbCBpbnN0YW5jZW9mIGpvaW50LmRpYS5FbGVtZW50OwogICAgICAgIH0pOwoKICAgICAgICB2YXIgY2xvbmVzID0gW2Nsb25lXTsKCiAgICAgICAgLy8gVGhpcyBtYXBwaW5nIHN0b3JlcyBjbG9uZWQgbGlua3MgdW5kZXIgdGhlIGBpZGBzIG9mIHRoZXkgb3JpZ2luYWxzLgogICAgICAgIC8vIFRoaXMgcHJldmVudHMgY2xvbmluZyBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuIENvbnNpZGVyIGEgbGluayAnc2VsZiBsb29wJyBmb3IgZXhhbXBsZS4KICAgICAgICB2YXIgbGlua0Nsb25lTWFwcGluZyA9IHt9OwogICAgICAgIAogICAgICAgIF8uZWFjaChlbWJlZHMsIGZ1bmN0aW9uKGVtYmVkKSB7CgogICAgICAgICAgICB2YXIgZW1iZWRDbG9uZXMgPSBlbWJlZC5jbG9uZSh7IGRlZXA6IHRydWUgfSk7CgogICAgICAgICAgICAvLyBFbWJlZCB0aGUgZmlyc3QgY2xvbmUgcmV0dXJuZWQgZnJvbSBgY2xvbmUoeyBkZWVwOiB0cnVlIH0pYCBhYm92ZS4gVGhlIGZpcnN0CiAgICAgICAgICAgIC8vIGNlbGwgaXMgYWx3YXlzIHRoZSBjbG9uZSBvZiB0aGUgY2VsbCB0aGF0IGNhbGxlZCB0aGUgYGNsb25lKClgIG1ldGhvZCwgaS5lLiBjbG9uZSBvZiBgZW1iZWRgIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgY2xvbmUuZW1iZWQoZW1iZWRDbG9uZXNbMF0pOwoKICAgICAgICAgICAgXy5lYWNoKGVtYmVkQ2xvbmVzLCBmdW5jdGlvbihlbWJlZENsb25lKSB7CgogICAgICAgICAgICAgICAgaWYgKGVtYmVkQ2xvbmUgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluaykgewoKICAgICAgICAgICAgICAgICAgICBpZiAoZW1iZWRDbG9uZS5nZXQoJ3NvdXJjZScpLmlkID09IHRoaXMuaWQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBfLmNsb25lKGVtYmVkQ2xvbmUuZ2V0KCdzb3VyY2UnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZS5pZCA9IGNsb25lLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBlbWJlZENsb25lLnNldCgnc291cmNlJywgc291cmNlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlbWJlZENsb25lLmdldCgndGFyZ2V0JykuaWQgPT0gdGhpcy5pZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IF8uY2xvbmUoZW1iZWRDbG9uZS5nZXQoJ3RhcmdldCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LmlkID0gY2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVtYmVkQ2xvbmUuc2V0KCd0YXJnZXQnLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tlbWJlZC5pZF0gPSBlbWJlZENsb25lOwoKICAgICAgICAgICAgICAgICAgICAvLyBTa2lwIGxpbmtzLiBJbmJvdW5kL291dGJvdW5kIGxpbmtzIGFyZSBub3QgcmVsZXZhbnQgZm9yIHRoZW0uCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNsb25lcy5wdXNoKGVtYmVkQ2xvbmUpOwoKICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgYWxsIGluYm91bmQgbGlua3MsIGNsb25lIHRoZW0gKGlmIG5vdCBkb25lIGFscmVhZHkpIGFuZCBzZXQgdGhlaXIgdGFyZ2V0IHRvIHRoZSBgZW1iZWRDbG9uZS5pZGAuCiAgICAgICAgICAgICAgICB2YXIgaW5ib3VuZExpbmtzID0gdGhpcy5jb2xsZWN0aW9uLmdldENvbm5lY3RlZExpbmtzKGVtYmVkLCB7IGluYm91bmQ6IHRydWUgfSk7CgogICAgICAgICAgICAgICAgXy5lYWNoKGluYm91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0Nsb25lID0gbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSB8fCBsaW5rLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBjbG9uZSBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSA9IGxpbmtDbG9uZTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IF8uY2xvbmUobGlua0Nsb25lLmdldCgndGFyZ2V0JykpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldC5pZCA9IGVtYmVkQ2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lLnNldCgndGFyZ2V0JywgdGFyZ2V0KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgYWxsIGluYm91bmQgbGlua3MsIGNsb25lIHRoZW0gKGlmIG5vdCBkb25lIGFscmVhZHkpIGFuZCBzZXQgdGhlaXIgc291cmNlIHRvIHRoZSBgZW1iZWRDbG9uZS5pZGAuCiAgICAgICAgICAgICAgICB2YXIgb3V0Ym91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyhlbWJlZCwgeyBvdXRib3VuZDogdHJ1ZSB9KTsKCiAgICAgICAgICAgICAgICBfLmVhY2gob3V0Ym91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0Nsb25lID0gbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSB8fCBsaW5rLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBjbG9uZSBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSA9IGxpbmtDbG9uZTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IF8uY2xvbmUobGlua0Nsb25lLmdldCgnc291cmNlJykpOwogICAgICAgICAgICAgICAgICAgIHNvdXJjZS5pZCA9IGVtYmVkQ2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lLnNldCgnc291cmNlJywgc291cmNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAvLyBBZGQgbGluayBjbG9uZXMgdG8gdGhlIGFycmF5IG9mIGFsbCB0aGUgbmV3IGNsb25lcy4KICAgICAgICBjbG9uZXMgPSBjbG9uZXMuY29uY2F0KF8udmFsdWVzKGxpbmtDbG9uZU1hcHBpbmcpKTsKCiAgICAgICAgcmV0dXJuIGNsb25lczsKICAgIH0sCgogICAgLy8gQSBjb252ZW5pZW50IHdheSB0byBzZXQgbmVzdGVkIGF0dHJpYnV0ZXMuCiAgICBhdHRyOiBmdW5jdGlvbihhdHRycywgdmFsdWUsIG9wdCkgewoKICAgICAgICB2YXIgY3VycmVudEF0dHJzID0gdGhpcy5nZXQoJ2F0dHJzJyk7CiAgICAgICAgdmFyIGRlbGltID0gJy8nOwogICAgICAgIAogICAgICAgIGlmIChfLmlzU3RyaW5nKGF0dHJzKSkgewogICAgICAgICAgICAvLyBHZXQvc2V0IGFuIGF0dHJpYnV0ZSBieSBhIHNwZWNpYWwgcGF0aCBzeW50YXggdGhhdCBkZWxpbWl0cwogICAgICAgICAgICAvLyBuZXN0ZWQgb2JqZWN0cyBieSB0aGUgY29sb24gY2hhcmFjdGVyLgoKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAndW5kZWZpbmVkJykgewoKICAgICAgICAgICAgICAgIHZhciBhdHRyID0ge307CiAgICAgICAgICAgICAgICBqb2ludC51dGlsLnNldEJ5UGF0aChhdHRyLCBhdHRycywgdmFsdWUsIGRlbGltKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCgnYXR0cnMnLCBfLm1lcmdlKHt9LCBjdXJyZW50QXR0cnMsIGF0dHIpLCBvcHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBqb2ludC51dGlsLmdldEJ5UGF0aChjdXJyZW50QXR0cnMsIGF0dHJzLCBkZWxpbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KCdhdHRycycsIF8ubWVyZ2Uoe30sIGN1cnJlbnRBdHRycywgYXR0cnMpLCB2YWx1ZSwgb3B0KTsKICAgIH0sCgogICAgLy8gQSBjb252ZW5pZW50IHdheSB0byB1bnNldCBuZXN0ZWQgYXR0cmlidXRlcwogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24ocGF0aCwgb3B0KSB7CgogICAgICAgIGlmIChfLmlzQXJyYXkocGF0aCkpIHsKICAgICAgICAgICAgXy5lYWNoKHBhdGgsIGZ1bmN0aW9uKHApIHsgdGhpcy5yZW1vdmVBdHRyKHAsIG9wdCk7IH0sIHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIGF0dHJzID0gam9pbnQudXRpbC51bnNldEJ5UGF0aChfLm1lcmdlKHt9LCB0aGlzLmdldCgnYXR0cnMnKSksIHBhdGgsICcvJyk7CgogICAgICAgIHJldHVybiB0aGlzLnNldCgnYXR0cnMnLCBhdHRycywgXy5leHRlbmQoeyBkaXJ0eTogdHJ1ZSB9LCBvcHQpKTsKICAgIH0sCgogICAgdHJhbnNpdGlvbjogZnVuY3Rpb24ocGF0aCwgdmFsdWUsIG9wdCwgZGVsaW0pIHsKCglkZWxpbSA9IGRlbGltIHx8ICcvJzsKCgl2YXIgZGVmYXVsdHMgPSB7CgkgICAgZHVyYXRpb246IDEwMCwKCSAgICBkZWxheTogMTAsCgkgICAgdGltaW5nRnVuY3Rpb246IGpvaW50LnV0aWwudGltaW5nLmxpbmVhciwKCSAgICB2YWx1ZUZ1bmN0aW9uOiBqb2ludC51dGlsLmludGVycG9sYXRlLm51bWJlcgoJfTsKCglvcHQgPSBfLmV4dGVuZChkZWZhdWx0cywgb3B0KTsKCgl2YXIgcGF0aEFycmF5ID0gcGF0aC5zcGxpdChkZWxpbSk7CiAgICAgICAgdmFyIHByb3BlcnR5ID0gcGF0aEFycmF5WzBdOwoJdmFyIGlzUHJvcGVydHlOZXN0ZWQgPSBwYXRoQXJyYXkubGVuZ3RoID4gMTsKCXZhciBmaXJzdEZyYW1lVGltZSA9IDA7Cgl2YXIgaW50ZXJwb2xhdGluZ0Z1bmN0aW9uOwoKCXZhciBzZXR0ZXIgPSBfLmJpbmQoZnVuY3Rpb24ocnVudGltZSkgewoKCSAgICB2YXIgaWQsIHByb2dyZXNzLCBwcm9wZXJ0eVZhbHVlLCBzdGF0dXM7CgoJICAgIGZpcnN0RnJhbWVUaW1lID0gZmlyc3RGcmFtZVRpbWUgfHwgcnVudGltZTsKCSAgICBydW50aW1lIC09IGZpcnN0RnJhbWVUaW1lOwoJICAgIHByb2dyZXNzID0gcnVudGltZSAvIG9wdC5kdXJhdGlvbjsKCgkgICAgaWYgKHByb2dyZXNzIDwgMSkgewoJCXRoaXMuX3RyYW5zaXRpb25JZHNbcGF0aF0gPSBpZCA9IGpvaW50LnV0aWwubmV4dEZyYW1lKHNldHRlcik7CgkgICAgfSBlbHNlIHsKCQlwcm9ncmVzcyA9IDE7CgkJZGVsZXRlIHRoaXMuX3RyYW5zaXRpb25JZHNbcGF0aF07CgkgICAgfQoKCSAgICBwcm9wZXJ0eVZhbHVlID0gaW50ZXJwb2xhdGluZ0Z1bmN0aW9uKG9wdC50aW1pbmdGdW5jdGlvbihwcm9ncmVzcykpOwoKCSAgICBpZiAoaXNQcm9wZXJ0eU5lc3RlZCkgewoJCXZhciBuZXN0ZWRQcm9wZXJ0eVZhbHVlID0gam9pbnQudXRpbC5zZXRCeVBhdGgoe30sIHBhdGgsIHByb3BlcnR5VmFsdWUsIGRlbGltKVtwcm9wZXJ0eV07CgkJcHJvcGVydHlWYWx1ZSA9IF8ubWVyZ2Uoe30sIHRoaXMuZ2V0KHByb3BlcnR5KSwgbmVzdGVkUHJvcGVydHlWYWx1ZSk7CgkgICAgfQoKCSAgICBvcHQudHJhbnNpdGlvbklkID0gaWQ7CgoJICAgIHRoaXMuc2V0KHByb3BlcnR5LCBwcm9wZXJ0eVZhbHVlLCBvcHQpOwoKCSAgICBpZiAoIWlkKSB0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246ZW5kJywgdGhpcywgcGF0aCk7CgoJfSwgdGhpcyk7CgoJdmFyIGluaXRpYXRvciA9Xy5iaW5kKGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgoJICAgIHRoaXMuc3RvcFRyYW5zaXRpb25zKHBhdGgpOwoKCSAgICBpbnRlcnBvbGF0aW5nRnVuY3Rpb24gPSBvcHQudmFsdWVGdW5jdGlvbihqb2ludC51dGlsLmdldEJ5UGF0aCh0aGlzLmF0dHJpYnV0ZXMsIHBhdGgsIGRlbGltKSwgdmFsdWUpOwoKCSAgICB0aGlzLl90cmFuc2l0aW9uSWRzW3BhdGhdID0gam9pbnQudXRpbC5uZXh0RnJhbWUoY2FsbGJhY2spOwoKCSAgICB0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246c3RhcnQnLCB0aGlzLCBwYXRoKTsKCgl9LCB0aGlzKTsKCglyZXR1cm4gXy5kZWxheShpbml0aWF0b3IsIG9wdC5kZWxheSwgc2V0dGVyKTsKICAgIH0sCgogICAgZ2V0VHJhbnNpdGlvbnM6IGZ1bmN0aW9uKCkgewoJcmV0dXJuIF8ua2V5cyh0aGlzLl90cmFuc2l0aW9uSWRzKTsKICAgIH0sCgogICAgc3RvcFRyYW5zaXRpb25zOiBmdW5jdGlvbihwYXRoLCBkZWxpbSkgewoKCWRlbGltID0gZGVsaW0gfHwgJy8nOwoKCXZhciBwYXRoQXJyYXkgPSBwYXRoICYmIHBhdGguc3BsaXQoZGVsaW0pOwoKCV8odGhpcy5fdHJhbnNpdGlvbklkcykua2V5cygpLmZpbHRlcihwYXRoQXJyYXkgJiYgZnVuY3Rpb24oa2V5KSB7CgoJICAgIHJldHVybiBfLmlzRXF1YWwocGF0aEFycmF5LCBrZXkuc3BsaXQoZGVsaW0pLnNsaWNlKDAsIHBhdGhBcnJheS5sZW5ndGgpKTsKCgl9KS5lYWNoKGZ1bmN0aW9uKGtleSkgewoKCSAgICBqb2ludC51dGlsLmNhbmNlbEZyYW1lKHRoaXMuX3RyYW5zaXRpb25JZHNba2V5XSk7CgoJICAgIGRlbGV0ZSB0aGlzLl90cmFuc2l0aW9uSWRzW2tleV07CgoJICAgIHRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjplbmQnLCB0aGlzLCBrZXkpOwoKCX0sIHRoaXMpOwoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBIHNob3JjdXQgbWFraW5nIGl0IGVhc3kgdG8gY3JlYXRlIGNvbnN0cnVjdHMgbGlrZSB0aGUgZm9sbG93aW5nOgogICAgLy8gYHZhciBlbCA9IChuZXcgam9pbnQuc2hhcGVzLmJhc2ljLlJlY3QpLmFkZFRvKGdyYXBoKWAuCiAgICBhZGRUbzogZnVuY3Rpb24oZ3JhcGgpIHsKCglncmFwaC5hZGRDZWxsKHRoaXMpOwoJcmV0dXJuIHRoaXM7CiAgICB9Cn0pOwoKLy8gam9pbnQuZGlhLkNlbGxWaWV3IGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIFRoaXMgaXMgdGhlIGJhc2UgdmlldyBhbmQgY29udHJvbGxlciBmb3IgYGpvaW50LmRpYS5FbGVtZW50Vmlld2AgYW5kIGBqb2ludC5kaWEuTGlua1ZpZXdgLgoKam9pbnQuZGlhLkNlbGxWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewoKICAgIHRhZ05hbWU6ICdnJywKCiAgICBhdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgcmV0dXJuIHsgJ21vZGVsLWlkJzogdGhpcy5tb2RlbC5pZCB9CiAgICB9LAoKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CgoJdGhpcy5fY29uZmlndXJlKG9wdGlvbnMpOwoJQmFja2JvbmUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CgoJaWYgKHRoaXMub3B0aW9ucykgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnb3B0aW9ucycpLCBvcHRpb25zKTsKCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgLy8gTWFrZSBzdXJlIGEgZ2xvYmFsIHVuaXF1ZSBpZCBpcyBhc3NpZ25lZCB0byB0aGlzIHZpZXcuIFN0b3JlIHRoaXMgaWQgYWxzbyB0byB0aGUgcHJvcGVydGllcyBvYmplY3QuCiAgICAgICAgLy8gVGhlIGdsb2JhbCB1bmlxdWUgaWQgbWFrZXMgc3VyZSB0aGF0IHRoZSBzYW1lIHZpZXcgY2FuIGJlIHJlbmRlcmVkIG9uIGUuZy4gZGlmZmVyZW50IG1hY2hpbmVzIGFuZAogICAgICAgIC8vIHN0aWxsIGJlIGFzc29jaWF0ZWQgdG8gdGhlIHNhbWUgb2JqZWN0IGFtb25nIGFsbCB0aG9zZSBjbGllbnRzLiBUaGlzIGlzIG5lY2Vzc2FyeSBmb3IgcmVhbC10aW1lCiAgICAgICAgLy8gY29sbGFib3JhdGlvbiBtZWNoYW5pc20uCiAgICAgICAgdGhpcy5vcHRpb25zLmlkID0gdGhpcy5vcHRpb25zLmlkIHx8IGpvaW50LnV0aWwuZ3VpZCh0aGlzKTsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIF8uYmluZEFsbCh0aGlzLCAncmVtb3ZlJywgJ3VwZGF0ZScpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2UgdG8gdGhpcyB0byB0aGUgPGc+IERPTSBlbGVtZW50IHNvIHRoYXQgdGhlIHZpZXcgaXMgYWNjZXNzaWJsZSB0aHJvdWdoIHRoZSBET00gdHJlZS4KICAgICAgICB0aGlzLiRlbC5kYXRhKCd2aWV3JywgdGhpcyk7CgoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAncmVtb3ZlJywgdGhpcy5yZW1vdmUpOwoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOmF0dHJzJywgdGhpcy5vbkNoYW5nZUF0dHJzKTsKICAgIH0sCgogICAgb25DaGFuZ2VBdHRyczogZnVuY3Rpb24oY2VsbCwgYXR0cnMsIG9wdCkgewoKICAgICAgICBpZiAob3B0LmRpcnR5KSB7CgogICAgICAgICAgICAvLyBkaXJ0eSBmbGFnIGNvdWxkIGJlIHNldCB3aGVuIGEgbW9kZWwgYXR0cmlidXRlIHdhcyByZW1vdmVkIGFuZCBpdCBuZWVkcyB0byBiZSBjbGVhcmVkCiAgICAgICAgICAgIC8vIGFsc28gZnJvbSB0aGUgRE9NIGVsZW1lbnQuIFNlZSBjZWxsLnJlbW92ZUF0dHIoKS4KICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGUoKTsKICAgIH0sCgogICAgLy8gT3ZlcnJpZGUgdGhlIEJhY2tib25lIGBfZW5zdXJlRWxlbWVudCgpYCBtZXRob2QgaW4gb3JkZXIgdG8gY3JlYXRlIGEgYDxnPmAgbm9kZSB0aGF0IHdyYXBzCiAgICAvLyBhbGwgdGhlIG5vZGVzIG9mIHRoZSBDZWxsIHZpZXcuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBlbDsKCiAgICAgICAgaWYgKCF0aGlzLmVsKSB7CgogICAgICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7IGlkOiB0aGlzLmlkIH0sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgICAgICBlbCA9IFYoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLm5vZGU7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBlbCA9IF8ucmVzdWx0KHRoaXMsICdlbCcpCiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldEVsZW1lbnQoZWwsIGZhbHNlKTsKICAgIH0sCiAgICAKICAgIGZpbmRCeVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3RvcikgewoKICAgICAgICAvLyBUaGVzZSBhcmUgZWl0aGVyIGRlc2NlbmRhbnRzIG9mIGB0aGlzLiRlbGAgb2YgYHRoaXMuJGVsYCBpdHNlbGYuIAogICAgICAgLy8gYC5gIGlzIGEgc3BlY2lhbCBzZWxlY3RvciB1c2VkIHRvIHNlbGVjdCB0aGUgd3JhcHBpbmcgYDxnPmAgZWxlbWVudC4KICAgICAgICB2YXIgJHNlbGVjdGVkID0gc2VsZWN0b3IgPT09ICcuJyA/IHRoaXMuJGVsIDogdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICAgICAgcmV0dXJuICRzZWxlY3RlZDsKICAgIH0sCgogICAgbm90aWZ5OiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgaWYgKHRoaXMucGFwZXIpIHsKCiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgICAgICAgICAgIC8vIFRyaWdnZXIgdGhlIGV2ZW50IG9uIGJvdGggdGhlIGVsZW1lbnQgaXRzZWxmIGFuZCBhbHNvIG9uIHRoZSBwYXBlci4KICAgICAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFtldnRdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXBlciBldmVudCBoYW5kbGVycyByZWNlaXZlIHRoZSB2aWV3IG9iamVjdCBhcyB0aGUgZmlyc3QgYXJndW1lbnQuCiAgICAgICAgICAgIHRoaXMucGFwZXIudHJpZ2dlci5hcHBseSh0aGlzLnBhcGVyLCBbZXZ0LCB0aGlzXS5jb25jYXQoYXJncykpOwogICAgICAgIH0KICAgIH0sCgogICAgZ2V0U3Ryb2tlQkJveDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAvLyBSZXR1cm4gYSBib3VuZGluZyBib3ggcmVjdGFuZ2xlIHRoYXQgdGFrZXMgaW50byBhY2NvdW50IHN0cm9rZS4KICAgICAgICAvLyBOb3RlIHRoYXQgdGhpcyBpcyBhIG5haXZlIGFuZCBhZC1ob2MgaW1wbGVtZW50YXRpb24gdGhhdCBkb2VzIG5vdAogICAgICAgIC8vIHdvcmtzIG9ubHkgaW4gY2VydGFpbiBjYXNlcyBhbmQgc2hvdWxkIGJlIHJlcGxhY2VkIGFzIHNvb24gYXMgYnJvd3NlcnMgd2lsbAogICAgICAgIC8vIHN0YXJ0IHN1cHBvcnRpbmcgdGhlIGdldFN0cm9rZUJCb3goKSBTVkcgbWV0aG9kLgogICAgICAgIC8vIEBUT0RPIGFueSBiZXR0ZXIgc29sdXRpb24gaXMgdmVyeSB3ZWxjb21lIQoKICAgICAgICB2YXIgaXNNYWduZXQgPSAhIWVsOwogICAgICAgIAogICAgICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgICAgICB2YXIgYmJveCA9IFYoZWwpLmJib3goZmFsc2UsIHRoaXMucGFwZXIudmlld3BvcnQpOwoKICAgICAgICB2YXIgc3Ryb2tlV2lkdGg7CiAgICAgICAgaWYgKGlzTWFnbmV0KSB7CgogICAgICAgICAgICBzdHJva2VXaWR0aCA9IFYoZWwpLmF0dHIoJ3N0cm9rZS13aWR0aCcpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgc3Ryb2tlV2lkdGggPSB0aGlzLm1vZGVsLmF0dHIoJ3JlY3Qvc3Ryb2tlLXdpZHRoJykgfHwgdGhpcy5tb2RlbC5hdHRyKCdjaXJjbGUvc3Ryb2tlLXdpZHRoJykgfHwgdGhpcy5tb2RlbC5hdHRyKCdlbGxpcHNlL3N0cm9rZS13aWR0aCcpIHx8IHRoaXMubW9kZWwuYXR0cigncGF0aC9zdHJva2Utd2lkdGgnKTsKICAgICAgICB9CgogICAgICAgIHN0cm9rZVdpZHRoID0gcGFyc2VGbG9hdChzdHJva2VXaWR0aCkgfHwgMDsKCiAgICAgICAgcmV0dXJuIGcucmVjdChiYm94KS5tb3ZlQW5kRXhwYW5kKHsgeDogLXN0cm9rZVdpZHRoLzIsIHk6IC1zdHJva2VXaWR0aC8yLCB3aWR0aDogc3Ryb2tlV2lkdGgsIGhlaWdodDogc3Ryb2tlV2lkdGggfSk7CiAgICB9LAogICAgCiAgICBnZXRCQm94OiBmdW5jdGlvbigpIHsKCiAgICAgICAgcmV0dXJuIFYodGhpcy5lbCkuYmJveCgpOwogICAgfSwKCiAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uKGVsKSB7CgogICAgICAgIGVsID0gIWVsID8gdGhpcy5lbCA6IHRoaXMuJChlbClbMF0gfHwgdGhpcy5lbDsKCiAgICAgICAgVihlbCkuYWRkQ2xhc3MoJ2hpZ2hsaWdodGVkJyk7CiAgICB9LAoKICAgIHVuaGlnaGxpZ2h0OiBmdW5jdGlvbihlbCkgewoKICAgICAgICBlbCA9ICFlbCA/IHRoaXMuZWwgOiB0aGlzLiQoZWwpWzBdIHx8IHRoaXMuZWw7CgogICAgICAgIFYoZWwpLnJlbW92ZUNsYXNzKCdoaWdobGlnaHRlZCcpOwogICAgfSwKCiAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IGVsZW1lbnQgdGhhdCBoYXMgdGhlIGBtYWduZXRgIGF0dHJpYnV0ZSBzZXQgdG8gYHRydWVgLiBJZiB0aGVyZSB3YXMgbm90IHN1Y2gKICAgIC8vIGFuIGVsZW1lbnQgZm91bmQsIHJldHVybiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBjZWxsIHZpZXcuCiAgICBmaW5kTWFnbmV0OiBmdW5jdGlvbihlbCkgewoKICAgICAgICB2YXIgJGVsID0gdGhpcy4kKGVsKTsKCiAgICAgICAgaWYgKCRlbC5sZW5ndGggPT09IDAgfHwgJGVsWzBdID09PSB0aGlzLmVsKSB7CgogICAgICAgICAgICAvLyBJZiB0aGUgb3ZlcmFsbCBjZWxsIGhhcyBzZXQgYG1hZ25ldCA9PT0gZmFsc2VgLCB0aGVuIHJldHVybiBgdW5kZWZpbmVkYCB0bwogICAgICAgICAgICAvLyBhbm5vdW5jZSB0aGVyZSBpcyBubyBtYWduZXQgZm91bmQgZm9yIHRoaXMgY2VsbC4KICAgICAgICAgICAgLy8gVGhpcyBpcyBlc3BlY2lhbGx5IHVzZWZ1bCB0byBzZXQgb24gY2VsbHMgdGhhdCBoYXZlICdwb3J0cycuIEluIHRoaXMgY2FzZSwKICAgICAgICAgICAgLy8gb25seSB0aGUgcG9ydHMgaGF2ZSBzZXQgYG1hZ25ldCA9PT0gdHJ1ZWAgYW5kIHRoZSBvdmVyYWxsIGVsZW1lbnQgaGFzIGBtYWduZXQgPT09IGZhbHNlYC4KICAgICAgICAgICAgdmFyIGF0dHJzID0gdGhpcy5tb2RlbC5nZXQoJ2F0dHJzJykgfHwge307CiAgICAgICAgICAgIGlmIChhdHRyc1snLiddICYmIGF0dHJzWycuJ11bJ21hZ25ldCddID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWw7CiAgICAgICAgfQoKICAgICAgICBpZiAoJGVsLmF0dHIoJ21hZ25ldCcpKSB7CgogICAgICAgICAgICByZXR1cm4gJGVsWzBdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuZmluZE1hZ25ldCgkZWwucGFyZW50KCkpOwogICAgfSwKCiAgICAvLyBgc2VsZWN0b3JgIGlzIGEgQ1NTIHNlbGVjdG9yIG9yIGAnLidgLiBgZmlsdGVyYCBtdXN0IGJlIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZmlsdGVyIGZvcm1hdDoKICAgIC8vIGB7IG5hbWU6IDxuYW1lIG9mIHRoZSBmaWx0ZXI+LCBhcmdzOiB7IDxhcmd1bWVudHM+LCAuLi4gfWAuCiAgICAvLyBBbiBleGFtcGxlIGlzOiBgeyBmaWx0ZXI6IHsgbmFtZTogJ2JsdXInLCBhcmdzOiB7IHJhZGl1czogNSB9IH0gfWAuCiAgICBhcHBseUZpbHRlcjogZnVuY3Rpb24oc2VsZWN0b3IsIGZpbHRlcikgewoKICAgICAgICB2YXIgJHNlbGVjdGVkID0gdGhpcy5maW5kQnlTZWxlY3RvcihzZWxlY3Rvcik7CgogICAgICAgIC8vIEdlbmVyYXRlIGEgaGFzaCBjb2RlIGZyb20gdGhlIHN0cmluZ2lmaWVkIGZpbHRlciBkZWZpbml0aW9uLiBUaGlzIGdpdmVzIHVzCiAgICAgICAgLy8gYSB1bmlxdWUgZmlsdGVyIElEIGZvciBkaWZmZXJlbnQgZGVmaW5pdGlvbnMuCiAgICAgICAgdmFyIGZpbHRlcklkID0gZmlsdGVyLm5hbWUgKyB0aGlzLnBhcGVyLnN2Zy5pZCArIGpvaW50LnV0aWwuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkoZmlsdGVyKSk7CgogICAgICAgIC8vIElmIHRoZSBmaWx0ZXIgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIHdlJ3JlIGRvbmUgYW5kIHdlIGNhbiBqdXN0IHVzZSBpdCAocmVmZXJlbmNlIGl0IHVzaW5nIGB1cmwoKWApLgogICAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZS4KICAgICAgICBpZiAoIXRoaXMucGFwZXIuc3ZnLmdldEVsZW1lbnRCeUlkKGZpbHRlcklkKSkgewoKICAgICAgICAgICAgdmFyIGZpbHRlclNWR1N0cmluZyA9IGpvaW50LnV0aWwuZmlsdGVyW2ZpbHRlci5uYW1lXSAmJiBqb2ludC51dGlsLmZpbHRlcltmaWx0ZXIubmFtZV0oZmlsdGVyLmFyZ3MgfHwge30pOwogICAgICAgICAgICBpZiAoIWZpbHRlclNWR1N0cmluZykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb24tZXhpc3RpbmcgZmlsdGVyICcgKyBmaWx0ZXIubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlckVsZW1lbnQgPSBWKGZpbHRlclNWR1N0cmluZyk7CiAgICAgICAgICAgIGZpbHRlckVsZW1lbnQuYXR0cignZmlsdGVyVW5pdHMnLCAndXNlclNwYWNlT25Vc2UnKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5hdHRycykgZmlsdGVyRWxlbWVudC5hdHRyKGZpbHRlci5hdHRycyk7CiAgICAgICAgICAgIGZpbHRlckVsZW1lbnQubm9kZS5pZCA9IGZpbHRlcklkOwogICAgICAgICAgICBWKHRoaXMucGFwZXIuc3ZnKS5kZWZzKCkuYXBwZW5kKGZpbHRlckVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBWKHRoaXMpLmF0dHIoJ2ZpbHRlcicsICd1cmwoIycgKyBmaWx0ZXJJZCArICcpJyk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vIGBzZWxlY3RvcmAgaXMgYSBDU1Mgc2VsZWN0b3Igb3IgYCcuJ2AuIGBhdHRyYCBpcyBlaXRoZXIgYSBgJ2ZpbGwnYCBvciBgJ3N0cm9rZSdgLgogICAgLy8gYGdyYWRpZW50YCBtdXN0IGJlIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZ3JhZGllbnQgZm9ybWF0OgogICAgLy8gYHsgdHlwZTogPGxpbmVhckdyYWRpZW50fHJhZGlhbEdyYWRpZW50Piwgc3RvcHM6IFsgeyBvZmZzZXQ6IDxvZmZzZXQ+LCBjb2xvcjogPGNvbG9yPiB9LCAuLi4gXWAuCiAgICAvLyBBbiBleGFtcGxlIGlzOiBgeyBmaWxsOiB7IHR5cGU6ICdsaW5lYXJHcmFkaWVudCcsIHN0b3BzOiBbIHsgb2Zmc2V0OiAnMTAlJywgY29sb3I6ICdncmVlbicgfSwgeyBvZmZzZXQ6ICc1MCUnLCBjb2xvcjogJ2JsdWUnIH0gXSB9IH1gLgogICAgYXBwbHlHcmFkaWVudDogZnVuY3Rpb24oc2VsZWN0b3IsIGF0dHIsIGdyYWRpZW50KSB7CgogICAgICAgIHZhciAkc2VsZWN0ZWQgPSB0aGlzLmZpbmRCeVNlbGVjdG9yKHNlbGVjdG9yKTsKCiAgICAgICAgLy8gR2VuZXJhdGUgYSBoYXNoIGNvZGUgZnJvbSB0aGUgc3RyaW5naWZpZWQgZmlsdGVyIGRlZmluaXRpb24uIFRoaXMgZ2l2ZXMgdXMKICAgICAgICAvLyBhIHVuaXF1ZSBmaWx0ZXIgSUQgZm9yIGRpZmZlcmVudCBkZWZpbml0aW9ucy4KICAgICAgICB2YXIgZ3JhZGllbnRJZCA9IGdyYWRpZW50LnR5cGUgKyB0aGlzLnBhcGVyLnN2Zy5pZCArIGpvaW50LnV0aWwuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkoZ3JhZGllbnQpKTsKCiAgICAgICAgLy8gSWYgdGhlIGdyYWRpZW50IGFscmVhZHkgZXhpc3RzIGluIHRoZSBkb2N1bWVudCwKICAgICAgICAvLyB3ZSdyZSBkb25lIGFuZCB3ZSBjYW4ganVzdCB1c2UgaXQgKHJlZmVyZW5jZSBpdCB1c2luZyBgdXJsKClgKS4KICAgICAgICAvLyBJZiBub3QsIGNyZWF0ZSBvbmUuCiAgICAgICAgaWYgKCF0aGlzLnBhcGVyLnN2Zy5nZXRFbGVtZW50QnlJZChncmFkaWVudElkKSkgewoKICAgICAgICAgICAgdmFyIGdyYWRpZW50U1ZHU3RyaW5nID0gWwogICAgICAgICAgICAgICAgJzwnICsgZ3JhZGllbnQudHlwZSArICc+JywKICAgICAgICAgICAgICAgIF8ubWFwKGdyYWRpZW50LnN0b3BzLCBmdW5jdGlvbihzdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3RvcCBvZmZzZXQ9IicgKyBzdG9wLm9mZnNldCArICciIHN0b3AtY29sb3I9IicgKyBzdG9wLmNvbG9yICsgJyIgc3RvcC1vcGFjaXR5PSInICsgKF8uaXNGaW5pdGUoc3RvcC5vcGFjaXR5KSA/IHN0b3Aub3BhY2l0eSA6IDEpICsgJyIgLz4nCiAgICAgICAgICAgICAgICB9KS5qb2luKCcnKSwKICAgICAgICAgICAgICAgICc8LycgKyBncmFkaWVudC50eXBlICsgJz4nCiAgICAgICAgICAgIF0uam9pbignJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZ3JhZGllbnRFbGVtZW50ID0gVihncmFkaWVudFNWR1N0cmluZyk7CiAgICAgICAgICAgIGlmIChncmFkaWVudC5hdHRycykgeyBncmFkaWVudEVsZW1lbnQuYXR0cihncmFkaWVudC5hdHRycyk7IH0KICAgICAgICAgICAgZ3JhZGllbnRFbGVtZW50Lm5vZGUuaWQgPSBncmFkaWVudElkOwogICAgICAgICAgICBWKHRoaXMucGFwZXIuc3ZnKS5kZWZzKCkuYXBwZW5kKGdyYWRpZW50RWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICAkc2VsZWN0ZWQuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIFYodGhpcykuYXR0cihhdHRyLCAndXJsKCMnICsgZ3JhZGllbnRJZCArICcpJyk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vIENvbnN0cnVjdCBhIHVuaXF1ZSBzZWxlY3RvciBmb3IgdGhlIGBlbGAgZWxlbWVudCB3aXRoaW4gdGhpcyB2aWV3LgogICAgLy8gYHNlbGVjdG9yYCBpcyBiZWluZyBjb2xsZWN0ZWQgdGhyb3VnaCB0aGUgcmVjdXJzaXZlIGNhbGwuIE5vIHZhbHVlIGZvciBgc2VsZWN0b3JgIGlzIGV4cGVjdGVkIHdoZW4gdXNpbmcgdGhpcyBtZXRob2QuCiAgICBnZXRTZWxlY3RvcjogZnVuY3Rpb24oZWwsIHNlbGVjdG9yKSB7CgogICAgICAgIGlmIChlbCA9PT0gdGhpcy5lbCkgewoKICAgICAgICAgICAgcmV0dXJuIHNlbGVjdG9yOwogICAgICAgIH0KCiAgICAgICAgdmFyIGluZGV4ID0gJChlbCkuaW5kZXgoKTsKCiAgICAgICAgc2VsZWN0b3IgPSBlbC50YWdOYW1lICsgJzpudGgtY2hpbGQoJyArIChpbmRleCArIDEpICsgJyknICsgJyAnICsgKHNlbGVjdG9yIHx8ICcnKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VsZWN0b3IoJChlbCkucGFyZW50KClbMF0sIHNlbGVjdG9yICsgJyAnKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uIFRoZSBjb250cm9sbGVyIHBhcnQuCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvLyBJbnRlcmFjdGlvbiBpcyBoYW5kbGVkIGJ5IHRoZSBwYXBlciBhbmQgZGVsZWdhdGVkIHRvIHRoZSB2aWV3IGluIGludGVyZXN0LgogICAgLy8gYHhgICYgYHlgIHBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZXNlIGZ1bmN0aW9ucyByZXByZXNlbnQgdGhlIGNvb3JkaW5hdGVzIGFscmVhZHkgc25hcHBlZCB0byB0aGUgcGFwZXIgZ3JpZC4KICAgIC8vIElmIG5lY2Vzc2FyeSwgcmVhbCBjb29yZGluYXRlcyBjYW4gYmUgb2J0YWluZWQgZnJvbSB0aGUgYGV2dGAgZXZlbnQgb2JqZWN0LgoKICAgIC8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgc3VwcG9zZWQgdG8gYmUgb3ZlcnJpZGVuIGJ5IHRoZSB2aWV3cyB0aGF0IGluaGVyaXQgZnJvbSBgam9pbnQuZGlhLkNlbGxgLAogICAgLy8gaS5lLiBgam9pbnQuZGlhLkVsZW1lbnRgIGFuZCBgam9pbnQuZGlhLkxpbmtgLgoKICAgIHBvaW50ZXJkYmxjbGljazogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJkYmxjbGljaycsIGV2dCwgeCwgeSk7CiAgICB9LAoKICAgIHBvaW50ZXJjbGljazogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJjbGljaycsIGV2dCwgeCwgeSk7CiAgICB9LAogICAgCiAgICBwb2ludGVyZG93bjogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgoJaWYgKHRoaXMubW9kZWwuY29sbGVjdGlvbikgewoJICAgIHRoaXMubW9kZWwudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCSAgICB0aGlzLl9jb2xsZWN0aW9uID0gdGhpcy5tb2RlbC5jb2xsZWN0aW9uOwoJfQoKICAgICAgICB0aGlzLm5vdGlmeSgnY2VsbDpwb2ludGVyZG93bicsIGV2dCwgeCwgeSk7CiAgICB9LAogICAgCiAgICBwb2ludGVybW92ZTogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJtb3ZlJywgZXZ0LCB4LCB5KTsKICAgIH0sCiAgICAKICAgIHBvaW50ZXJ1cDogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJ1cCcsIGV2dCwgeCwgeSk7CgoJaWYgKHRoaXMuX2NvbGxlY3Rpb24pIHsKCSAgICAvLyB3ZSBkb24ndCB3YW50IHRvIHRyaWdnZXIgZXZlbnQgb24gbW9kZWwgYXMgbW9kZWwgZG9lc24ndAoJICAgIC8vIG5lZWQgdG8gYmUgbWVtYmVyIG9mIGNvbGxlY3Rpb24gYW55bW9yZSAocmVtb3ZlKQoJICAgIHRoaXMuX2NvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoJICAgIGRlbGV0ZSB0aGlzLl9jb2xsZWN0aW9uOwoJfQoKICAgIH0KfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkNlbGwgPSBqb2ludC5kaWEuQ2VsbDsKICAgIG1vZHVsZS5leHBvcnRzLkNlbGxWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3Owp9CgovLyAgICAgIEpvaW50SlMgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi9jb3JlJykudXRpbCwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgQ2VsbDogcmVxdWlyZSgnLi9qb2ludC5kaWEuY2VsbCcpLkNlbGwsCiAgICAgICAgICAgIENlbGxWaWV3OiByZXF1aXJlKCcuL2pvaW50LmRpYS5jZWxsJykuQ2VsbFZpZXcKICAgICAgICB9CiAgICB9OwogICAgdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCgovLyBqb2ludC5kaWEuRWxlbWVudCBiYXNlIG1vZGVsLgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkVsZW1lbnQgPSBqb2ludC5kaWEuQ2VsbC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiB7CiAgICAgICAgcG9zaXRpb246IHsgeDogMCwgeTogMCB9LAoJc2l6ZTogeyB3aWR0aDogMSwgaGVpZ2h0OiAxIH0sCiAgICAgICAgYW5nbGU6IDAKICAgIH0sCgogICAgcG9zaXRpb246IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgdGhpcy5zZXQoJ3Bvc2l0aW9uJywgeyB4OiB4LCB5OiB5IH0pOwogICAgfSwKICAgIAogICAgdHJhbnNsYXRlOiBmdW5jdGlvbih0eCwgdHksIG9wdCkgewoKICAgICAgICB0eSA9IHR5IHx8IDA7CgogICAgICAgIGlmICh0eCA9PT0gMCAmJiB0eSA9PT0gMCkgewogICAgICAgICAgICAvLyBMaWtlIG5vdGhpbmcgaGFzIGhhcHBlbmVkLgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0KCdwb3NpdGlvbicpIHx8IHsgeDogMCwgeTogMCB9OwoJdmFyIHRyYW5zbGF0ZWRQb3NpdGlvbiA9IHsgeDogcG9zaXRpb24ueCArIHR4IHx8IDAsIHk6IHBvc2l0aW9uLnkgKyB0eSB8fCAwIH07CgoJaWYgKG9wdCAmJiBvcHQudHJhbnNpdGlvbikgewoKCSAgICBpZiAoIV8uaXNPYmplY3Qob3B0LnRyYW5zaXRpb24pKSBvcHQudHJhbnNpdGlvbiA9IHt9OwoKCSAgICB0aGlzLnRyYW5zaXRpb24oJ3Bvc2l0aW9uJywgdHJhbnNsYXRlZFBvc2l0aW9uLCBfLmV4dGVuZCh7fSwgb3B0LnRyYW5zaXRpb24sIHsKCQl2YWx1ZUZ1bmN0aW9uOiBqb2ludC51dGlsLmludGVycG9sYXRlLm9iamVjdAoJICAgIH0pKTsKCgl9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy5zZXQoJ3Bvc2l0aW9uJywgdHJhbnNsYXRlZFBvc2l0aW9uLCBvcHQpOwoKICAgICAgICAgICAgLy8gUmVjdXJzaXZlbHkgY2FsbCBgdHJhbnNsYXRlKClgIG9uIGFsbCB0aGUgZW1iZWRzIGNlbGxzLgogICAgICAgICAgICBfLmludm9rZSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgJ3RyYW5zbGF0ZScsIHR4LCB0eSwgb3B0KTsKCX0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlc2l6ZTogZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewoKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKICAgICAgICB0aGlzLnNldCgnc2l6ZScsIHsgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCB9KTsKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSb3RhdGUgZWxlbWVudCBieSBgYW5nbGVgIGRlZ3JlZXMsIG9wdGlvbmFsbHkgYXJvdW5kIGBvcmlnaW5gIHBvaW50LgogICAgLy8gSWYgYG9yaWdpbmAgaXMgbm90IHByb3ZpZGVkLCBpdCBpcyBjb25zaWRlcmVkIHRvIGJlIHRoZSBjZW50ZXIgb2YgdGhlIGVsZW1lbnQuCiAgICAvLyBJZiBgYWJzb2x1dGVgIGlzIGB0cnVlYCwgdGhlIGBhbmdsZWAgaXMgY29uc2lkZXJlZCBpcyBhYnNsdXRlLCBpLmUuIGl0IGlzIG5vdAogICAgLy8gdGhlIGRpZmZlcmVuY2UgZnJvbSB0aGUgcHJldmlvdXMgYW5nbGUuCiAgICByb3RhdGU6IGZ1bmN0aW9uKGFuZ2xlLCBhYnNvbHV0ZSwgb3JpZ2luKSB7CgkKCWlmIChvcmlnaW4pIHsKCgkgICAgdmFyIGNlbnRlciA9IHRoaXMuZ2V0QkJveCgpLmNlbnRlcigpOwoJICAgIHZhciBzaXplID0gdGhpcy5nZXQoJ3NpemUnKTsKCSAgICB2YXIgcG9zaXRpb24gPSB0aGlzLmdldCgncG9zaXRpb24nKTsKCSAgICBjZW50ZXIucm90YXRlKG9yaWdpbiwgKHRoaXMuZ2V0KCdhbmdsZScpIHx8IDApIC0gYW5nbGUpOwoJICAgIHZhciBkeCA9IGNlbnRlci54IC0gc2l6ZS53aWR0aC8yIC0gcG9zaXRpb24ueDsKCSAgICB2YXIgZHkgPSBjZW50ZXIueSAtIHNpemUuaGVpZ2h0LzIgLSBwb3NpdGlvbi55OwoJICAgIHRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCSAgICB0aGlzLnRyYW5zbGF0ZShkeCwgZHkpOwoJICAgIHRoaXMucm90YXRlKGFuZ2xlLCBhYnNvbHV0ZSk7CgkgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICAgICAgICAgIAoJfSBlbHNlIHsKCgkgICAgdGhpcy5zZXQoJ2FuZ2xlJywgYWJzb2x1dGUgPyBhbmdsZSA6ICgodGhpcy5nZXQoJ2FuZ2xlJykgfHwgMCkgKyBhbmdsZSkgJSAzNjApOwoJfQoJcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGdldEJCb3g6IGZ1bmN0aW9uKCkgewoKCXZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0KCdwb3NpdGlvbicpOwoJdmFyIHNpemUgPSB0aGlzLmdldCgnc2l6ZScpOwoKCXJldHVybiBnLnJlY3QocG9zaXRpb24ueCwgcG9zaXRpb24ueSwgc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQpOwogICAgfQp9KTsKCi8vIGpvaW50LmRpYS5FbGVtZW50IGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkVsZW1lbnRWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3LmV4dGVuZCh7CgogICAgY2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gJ2VsZW1lbnQgJyArIHRoaXMubW9kZWwuZ2V0KCd0eXBlJykuc3BsaXQoJy4nKS5qb2luKCcgJyk7CiAgICB9LAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBfLmJpbmRBbGwodGhpcywgJ3RyYW5zbGF0ZScsICdyZXNpemUnLCAncm90YXRlJyk7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnBvc2l0aW9uJywgdGhpcy50cmFuc2xhdGUpOwoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnNpemUnLCB0aGlzLnJlc2l6ZSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6YW5nbGUnLCB0aGlzLnJvdGF0ZSk7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgaXMgdG8gcHJvY2VzcyB0aGUgYGF0dHJzYCBvYmplY3QgYW5kIHNldCBhdHRyaWJ1dGVzIG9uIHN1YmVsZW1lbnRzIGJhc2VkIG9uIHRoZSBzZWxlY3RvcnMuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKGNlbGwsIHJlbmRlcmluZ09ubHlBdHRycykgewoKICAgICAgICB2YXIgYWxsQXR0cnMgPSB0aGlzLm1vZGVsLmdldCgnYXR0cnMnKTsKCiAgICAgICAgdmFyIHJvdGF0YWJsZSA9IFYodGhpcy4kKCcucm90YXRhYmxlJylbMF0pOwogICAgICAgIGlmIChyb3RhdGFibGUpIHsKCiAgICAgICAgICAgIHZhciByb3RhdGlvbiA9IHJvdGF0YWJsZS5hdHRyKCd0cmFuc2Zvcm0nKTsKICAgICAgICAgICAgcm90YXRhYmxlLmF0dHIoJ3RyYW5zZm9ybScsICcnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIHJlbGF0aXZlbHlQb3NpdGlvbmVkID0gW107CgogICAgICAgIF8uZWFjaChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgYWxsQXR0cnMsIGZ1bmN0aW9uKGF0dHJzLCBzZWxlY3RvcikgewoKICAgICAgICAgICAgLy8gRWxlbWVudHMgdGhhdCBzaG91bGQgYmUgdXBkYXRlZC4KICAgICAgICAgICAgdmFyICRzZWxlY3RlZCA9IHRoaXMuZmluZEJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwoKICAgICAgICAgICAgLy8gTm8gZWxlbWVudCBtYXRjaGVkIGJ5IHRoZSBgc2VsZWN0b3JgIHdhcyBmb3VuZC4gV2UncmUgZG9uZSB0aGVuLgogICAgICAgICAgICBpZiAoJHNlbGVjdGVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU3BlY2lhbCBhdHRyaWJ1dGVzIGFyZSB0cmVhdGVkIGJ5IEpvaW50SlMsIG5vdCBieSBTVkcuCiAgICAgICAgICAgIHZhciBzcGVjaWFsQXR0cmlidXRlcyA9IFsnc3R5bGUnLCAndGV4dCcsICdodG1sJywgJ3JlZi14JywgJ3JlZi15JywgJ3JlZi1keCcsICdyZWYtZHknLCAncmVmLXdpZHRoJywgJ3JlZi1oZWlnaHQnLCAncmVmJywgJ3gtYWxpZ25tZW50JywgJ3ktYWxpZ25tZW50JywgJ3BvcnQnXTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBgZmlsdGVyYCBhdHRyaWJ1dGUgaXMgYW4gb2JqZWN0LCBpdCBpcyBpbiB0aGUgc3BlY2lhbCBKb2ludEpTIGZpbHRlciBmb3JtYXQgYW5kIHNvCiAgICAgICAgICAgIC8vIGl0IGJlY29tZXMgYSBzcGVjaWFsIGF0dHJpYnV0ZSBhbmQgaXMgdHJlYXRlZCBzZXBhcmF0ZWx5LgogICAgICAgICAgICBpZiAoXy5pc09iamVjdChhdHRycy5maWx0ZXIpKSB7CgogICAgICAgICAgICAgICAgc3BlY2lhbEF0dHJpYnV0ZXMucHVzaCgnZmlsdGVyJyk7CiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHNlbGVjdG9yLCBhdHRycy5maWx0ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGUgYGZpbGxgIG9yIGBzdHJva2VgIGF0dHJpYnV0ZSBpcyBhbiBvYmplY3QsIGl0IGlzIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZ3JhZGllbnQgZm9ybWF0IGFuZCBzbwogICAgICAgICAgICAvLyBpdCBiZWNvbWVzIGEgc3BlY2lhbCBhdHRyaWJ1dGUgYW5kIGlzIHRyZWF0ZWQgc2VwYXJhdGVseS4KICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QoYXR0cnMuZmlsbCkpIHsKCiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0cmlidXRlcy5wdXNoKCdmaWxsJyk7CiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5R3JhZGllbnQoc2VsZWN0b3IsICdmaWxsJywgYXR0cnMuZmlsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QoYXR0cnMuc3Ryb2tlKSkgewoKICAgICAgICAgICAgICAgIHNwZWNpYWxBdHRyaWJ1dGVzLnB1c2goJ3N0cm9rZScpOwogICAgICAgICAgICAgICAgdGhpcy5hcHBseUdyYWRpZW50KHNlbGVjdG9yLCAnc3Ryb2tlJywgYXR0cnMuc3Ryb2tlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWFrZSBzcGVjaWFsIGNhc2UgZm9yIGB0ZXh0YCBhdHRyaWJ1dGUuIFNvIHRoYXQgd2UgY2FuIHNldCB0ZXh0IGNvbnRlbnQgb2YgdGhlIGA8dGV4dD5gIGVsZW1lbnQKICAgICAgICAgICAgLy8gdmlhIHRoZSBgYXR0cnNgIG9iamVjdCBhcyB3ZWxsLgogICAgICAgICAgICAvLyBOb3RlIHRoYXQgaXQncyBpbXBvcnRhbnQgdG8gc2V0IHRleHQgYmVmb3JlIGFwcGx5aW5nIHRoZSByZXN0IG9mIHRoZSBmaW5hbCBhdHRyaWJ1dGVzLgogICAgICAgICAgICAvLyBWZWN0b3JpemVyIGB0ZXh0KClgIG1ldGhvZCBzZXRzIG9uIHRoZSBlbGVtZW50IGl0cyBvd24gYXR0cmlidXRlcyBhbmQgaXQgaGFzIHRvIGJlIHBvc3NpYmxlCiAgICAgICAgICAgIC8vIHRvIHJld3JpdGUgdGhlbSwgaWYgbmVlZGVkLiAoaS5lIGRpc3BsYXk6ICdub25lJykKICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLnRleHQpKSB7CgogICAgICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIFYodGhpcykudGV4dChhdHRycy50ZXh0ICsgJycsIHsgbGluZUhlaWdodDogYXR0cnMubGluZUhlaWdodCB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXQgcmVndWxhciBhdHRyaWJ1dGVzIG9uIHRoZSBgJHNlbGVjdGVkYCBzdWJlbGVtZW50LiBOb3RlIHRoYXQgd2UgY2Fubm90IHVzZSB0aGUgalF1ZXJ5IGF0dHIoKQogICAgICAgICAgICAvLyBtZXRob2QgYXMgc29tZSBvZiB0aGUgYXR0cmlidXRlcyBtaWdodCBiZSBuYW1lc3BhY2VkIChlLmcuIHhsaW5rOmhyZWYpIHdoaWNoIGZhaWxzIHdpdGggalF1ZXJ5IGF0dHIoKS4KICAgICAgICAgICAgdmFyIGZpbmFsQXR0cmlidXRlcyA9IF8ub21pdChhdHRycywgc3BlY2lhbEF0dHJpYnV0ZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFYodGhpcykuYXR0cihmaW5hbEF0dHJpYnV0ZXMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGBwb3J0YCBhdHRyaWJ1dGUgY29udGFpbnMgdGhlIGBpZGAgb2YgdGhlIHBvcnQgdGhhdCB0aGUgdW5kZXJseWluZyBtYWduZXQgcmVwcmVzZW50cy4KICAgICAgICAgICAgaWYgKGF0dHJzLnBvcnQpIHsKCiAgICAgICAgICAgICAgICAkc2VsZWN0ZWQuYXR0cigncG9ydCcsIF8uaXNVbmRlZmluZWQoYXR0cnMucG9ydC5pZCkgPyBhdHRycy5wb3J0IDogYXR0cnMucG9ydC5pZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGBzdHlsZWAgYXR0cmlidXRlIGlzIHNwZWNpYWwgaW4gdGhlIHNlbnNlIHRoYXQgaXQgc2V0cyB0aGUgQ1NTIHN0eWxlIG9mIHRoZSBzdWJlbGVtZW50LgogICAgICAgICAgICBpZiAoYXR0cnMuc3R5bGUpIHsKCiAgICAgICAgICAgICAgICAkc2VsZWN0ZWQuY3NzKGF0dHJzLnN0eWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLmh0bWwpKSB7CgogICAgICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICQodGhpcykuaHRtbChhdHRycy5odG1sICsgJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNwZWNpYWwgYHJlZi14YCBhbmQgYHJlZi15YCBhdHRyaWJ1dGVzIG1ha2UgaXQgcG9zc2libGUgdG8gc2V0IGJvdGggYWJzb2x1dGUgb3IKICAgICAgICAgICAgLy8gcmVsYXRpdmUgcG9zaXRpb25pbmcgb2Ygc3ViZWxlbWVudHMuCiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChhdHRyc1sncmVmLXgnXSkgfHwKICAgICAgICAgICAgICAgICFfLmlzVW5kZWZpbmVkKGF0dHJzWydyZWYteSddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1keCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1keSddKSB8fAoJCSFfLmlzVW5kZWZpbmVkKGF0dHJzWyd4LWFsaWdubWVudCddKSB8fAoJCSFfLmlzVW5kZWZpbmVkKGF0dHJzWyd5LWFsaWdubWVudCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi13aWR0aCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1oZWlnaHQnXSkKICAgICAgICAgICAgICAgKSB7CgogICAgICAgICAgICAgICAgICAgXy5lYWNoKCRzZWxlY3RlZCwgZnVuY3Rpb24oZWwsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoZWwpOwogICAgICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgb3JpZ2luYWwgbGlzdCBzZWxlY3RvciB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICRlbC5zZWxlY3RvciA9IGxpc3Quc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmVseVBvc2l0aW9uZWQucHVzaCgkZWwpOwogICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIHN1YiBlbGVtZW50cyB0byBhZmZlY3QgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgcm9vdCBlbGVtZW50IHdoZW4KICAgICAgICAvLyBwb3NpdGlvbmluZyB0aGUgc3ViIGVsZW1lbnRzIHJlbGF0aXZlbHkgdG8gdGhlIGJvdW5kaW5nIGJveC4KICAgICAgICAvL18uaW52b2tlKHJlbGF0aXZlbHlQb3NpdGlvbmVkLCAnaGlkZScpOwogICAgICAgIC8vXy5pbnZva2UocmVsYXRpdmVseVBvc2l0aW9uZWQsICdzaG93Jyk7CgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSdyZSB1c2luZyB0aGUgYm91bmRpbmcgYm94IHdpdGhvdXQgdHJhbnNmb3JtYXRpb24gYmVjYXVzZSB3ZSBhcmUgYWxyZWFkeSBpbnNpZGUKICAgICAgICAvLyBhIHRyYW5zZm9ybWVkIGNvb3JkaW5hdGUgc3lzdGVtLgogICAgICAgIHZhciBiYm94ID0gdGhpcy5lbC5nZXRCQm94KCk7ICAgICAgICAKCiAgICAgICAgcmVuZGVyaW5nT25seUF0dHJzID0gcmVuZGVyaW5nT25seUF0dHJzIHx8IHt9OwoKICAgICAgICBfLmVhY2gocmVsYXRpdmVseVBvc2l0aW9uZWQsIGZ1bmN0aW9uKCRlbCkgewoKICAgICAgICAgICAgLy8gaWYgdGhlcmUgd2FzIGEgc3BlY2lhbCBhdHRyaWJ1dGUgYWZmZWN0aW5nIHRoZSBwb3NpdGlvbiBhbW9uZ3N0IHJlbmRlcmluZ09ubHlBdHRyaWJ1dGVzCiAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gbWVyZ2UgaXQgd2l0aCByZXN0IG9mIHRoZSBlbGVtZW50J3MgYXR0cmlidXRlcyBhcyB0aGV5IGFyZSBuZWNlc3NhcnkKICAgICAgICAgICAgLy8gdG8gdXBkYXRlIHRoZSBwb3NpdGlvbiByZWxhdGl2ZWx5IChpLmUgYHJlZmApCiAgICAgICAgICAgIHZhciByZW5kZXJpbmdPbmx5RWxBdHRycyA9IHJlbmRlcmluZ09ubHlBdHRyc1skZWwuc2VsZWN0b3JdOwogICAgICAgICAgICB2YXIgZWxBdHRycyA9IHJlbmRlcmluZ09ubHlFbEF0dHJzCiAgICAgICAgICAgICAgICA/IF8ubWVyZ2Uoe30sIGFsbEF0dHJzWyRlbC5zZWxlY3Rvcl0sIHJlbmRlcmluZ09ubHlFbEF0dHJzKQogICAgICAgICAgICAgICAgOiBhbGxBdHRyc1skZWwuc2VsZWN0b3JdOwoKICAgICAgICAgICAgdGhpcy5wb3NpdGlvblJlbGF0aXZlKCRlbCwgYmJveCwgZWxBdHRycyk7CiAgICAgICAgICAgIAogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICBpZiAocm90YXRhYmxlKSB7CgogICAgICAgICAgICByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJywgcm90YXRpb24gfHwgJycpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9zaXRpb25SZWxhdGl2ZTogZnVuY3Rpb24oJGVsLCBiYm94LCBlbEF0dHJzKSB7CgogICAgICAgIHZhciByZWYgPSBlbEF0dHJzWydyZWYnXTsKICAgICAgICB2YXIgcmVmWCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLXgnXSk7CiAgICAgICAgdmFyIHJlZlkgPSBwYXJzZUZsb2F0KGVsQXR0cnNbJ3JlZi15J10pOwogICAgICAgIHZhciByZWZEeCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWR4J10pOwogICAgICAgIHZhciByZWZEeSA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWR5J10pOwogICAgICAgIHZhciB5QWxpZ25tZW50ID0gZWxBdHRyc1sneS1hbGlnbm1lbnQnXTsKICAgICAgICB2YXIgeEFsaWdubWVudCA9IGVsQXR0cnNbJ3gtYWxpZ25tZW50J107CiAgICAgICAgdmFyIHJlZldpZHRoID0gcGFyc2VGbG9hdChlbEF0dHJzWydyZWYtd2lkdGgnXSk7CiAgICAgICAgdmFyIHJlZkhlaWdodCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWhlaWdodCddKTsKCiAgICAgICAgLy8gYHJlZmAgaXMgdGhlIHNlbGVjdG9yIG9mIHRoZSByZWZlcmVuY2UgZWxlbWVudC4gSWYgbm8gYHJlZmAgaXMgcGFzc2VkLCByZWZlcmVuY2UKICAgICAgICAvLyBlbGVtZW50IGlzIHRoZSByb290IGVsZW1lbnQuCgogICAgICAgIHZhciBpc1NjYWxhYmxlID0gXy5jb250YWlucyhfLnBsdWNrKF8ucGx1Y2soJGVsLnBhcmVudHMoJ2cnKSwgJ2NsYXNzTmFtZScpLCAnYmFzZVZhbCcpLCAnc2NhbGFibGUnKTsKCiAgICAgICAgaWYgKHJlZikgewoKICAgICAgICAgICAgLy8gR2V0IHRoZSBib3VuZGluZyBib3ggb2YgdGhlIHJlZmVyZW5jZSBlbGVtZW50IHJlbGF0aXZlIHRvIHRoZSByb290IGA8Zz5gIGVsZW1lbnQuCiAgICAgICAgICAgIGJib3ggPSBWKHRoaXMuZmluZEJ5U2VsZWN0b3IocmVmKVswXSkuYmJveChmYWxzZSwgdGhpcy5lbCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmVsID0gVigkZWxbMF0pOwoKICAgICAgICAvLyBSZW1vdmUgdGhlIHByZXZpb3VzIHRyYW5zbGF0ZSgpIGZyb20gdGhlIHRyYW5zZm9ybSBhdHRyaWJ1dGUgYW5kIHRyYW5zbGF0ZSB0aGUgZWxlbWVudAogICAgICAgIC8vIHJlbGF0aXZlIHRvIHRoZSByb290IGJvdW5kaW5nIGJveCBmb2xsb3dpbmcgdGhlIGByZWYteGAgYW5kIGByZWYteWAgYXR0cmlidXRlcy4KICAgICAgICBpZiAodmVsLmF0dHIoJ3RyYW5zZm9ybScpKSB7CgogICAgICAgICAgICB2ZWwuYXR0cigndHJhbnNmb3JtJywgdmVsLmF0dHIoJ3RyYW5zZm9ybScpLnJlcGxhY2UoL3RyYW5zbGF0ZVwoW14pXSpcKS9nLCAnJykudHJpbSgpIHx8ICcnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh4KSB7CiAgICAgICAgICAgIHJldHVybiBfLmlzTnVtYmVyKHgpICYmICFfLmlzTmFOKHgpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhlIGZpbmFsIHRyYW5zbGF0aW9uIG9mIHRoZSBzdWJlbGVtZW50LgogICAgICAgIHZhciB0eCA9IDA7CiAgICAgICAgdmFyIHR5ID0gMDsKCiAgICAgICAgLy8gJ3JlZi13aWR0aCcvJ3JlZi1oZWlnaHQnIGRlZmluZXMgdGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgc3ViZWxlbWVudCByZWxhdGl2ZWx5IHRvCiAgICAgICAgLy8gdGhlIHJlZmVyZW5jZSBlbGVtZW50IHNpemUKICAgICAgICAvLyB2YWwgaW4gMC4uMSAgICAgICAgIHJlZi13aWR0aCA9IDAuNzUgc2V0cyB0aGUgd2lkdGggdG8gNzUlIG9mIHRoZSByZWYuIGVsLiB3aWR0aAogICAgICAgIC8vIHZhbCA8IDAgfHwgdmFsID4gMSAgcmVmLWhlaWdodCA9IC0yMCBzZXRzIHRoZSBoZWlnaHQgdG8gdGhlIHRoZSByZWYuIGVsLiBoZWlnaHQgc2hvcnRlciBieSAyMAoKICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZldpZHRoKSkgewoKICAgICAgICAgICAgaWYgKHJlZldpZHRoID49IDAgJiYgcmVmV2lkdGggPD0gMSkgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCd3aWR0aCcsIHJlZldpZHRoICogYmJveC53aWR0aCk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCd3aWR0aCcsIE1hdGgubWF4KHJlZldpZHRoICsgYmJveC53aWR0aCwgMCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkhlaWdodCkpIHsKCiAgICAgICAgICAgIGlmIChyZWZIZWlnaHQgPj0gMCAmJiByZWZIZWlnaHQgPD0gMSkgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCdoZWlnaHQnLCByZWZIZWlnaHQgKiBiYm94LmhlaWdodCk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCdoZWlnaHQnLCBNYXRoLm1heChyZWZIZWlnaHQgKyBiYm94LmhlaWdodCwgMCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBgcmVmLWR4YCBhbmQgYHJlZi1keWAgZGVmaW5lIHRoZSBvZmZzZXQgb2YgdGhlIHN1YmVsZW1lbnQgcmVsYXRpdmUgdG8gdGhlIHJpZ2h0IGFuZC9vciBib3R0b20KICAgICAgICAvLyBjb29yZGluYXRlIG9mIHRoZSByZWZlcmVuY2UgZWxlbWVudC4KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkR4KSkgewoKICAgICAgICAgICAgaWYgKGlzU2NhbGFibGUpIHsKCiAgICAgICAgICAgICAgICAvLyBDb21wZW5zYXRlIGZvciB0aGUgc2NhbGUgZ3JpZCBpbiBjYXNlIHRoZSBlbGVtbnQgaXMgaW4gdGhlIHNjYWxhYmxlIGdyb3VwLgogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gVih0aGlzLiQoJy5zY2FsYWJsZScpWzBdKS5zY2FsZSgpOwogICAgICAgICAgICAgICAgdHggPSBiYm94LnggKyBiYm94LndpZHRoICsgcmVmRHggLyBzY2FsZS5zeDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0eCA9IGJib3gueCArIGJib3gud2lkdGggKyByZWZEeDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkR5KSkgewoKICAgICAgICAgICAgaWYgKGlzU2NhbGFibGUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29tcGVuc2F0ZSBmb3IgdGhlIHNjYWxlIGdyaWQgaW4gY2FzZSB0aGUgZWxlbW50IGlzIGluIHRoZSBzY2FsYWJsZSBncm91cC4KICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSkuc2NhbGUoKTsKICAgICAgICAgICAgICAgIHR5ID0gYmJveC55ICsgYmJveC5oZWlnaHQgKyByZWZEeSAvIHNjYWxlLnN5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0eSA9IGJib3gueSArIGJib3guaGVpZ2h0ICsgcmVmRHk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGlmIGByZWZYYCBpcyBpbiBbMCwgMV0gdGhlbiBgcmVmWGAgaXMgYSBmcmFjdGlvbiBvZiBib3VuZGluZyBib3ggd2lkdGgKICAgICAgICAvLyBpZiBgcmVmWGAgaXMgPCAwIHRoZW4gYHJlZlhgJ3MgYWJzb2x1dGUgdmFsdWVzIGlzIHRoZSByaWdodCBjb29yZGluYXRlIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAgICAvLyBvdGhlcndpc2UsIGByZWZYYCBpcyB0aGUgbGVmdCBjb29yZGluYXRlIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAgICAvLyBBbmFsb2dpY2FsIHJ1bGVzIGFwcGx5IGZvciBgcmVmWWAuCiAgICAgICAgaWYgKGlzRGVmaW5lZChyZWZYKSkgewoKICAgICAgICAgICAgaWYgKHJlZlggPiAwICYmIHJlZlggPCAxKSB7CgogICAgICAgICAgICAgICAgdHggPSBiYm94LnggKyBiYm94LndpZHRoICogcmVmWDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTY2FsYWJsZSkgewoKICAgICAgICAgICAgICAgIC8vIENvbXBlbnNhdGUgZm9yIHRoZSBzY2FsZSBncmlkIGluIGNhc2UgdGhlIGVsZW1udCBpcyBpbiB0aGUgc2NhbGFibGUgZ3JvdXAuCiAgICAgICAgICAgICAgICB2YXIgc2NhbGUgPSBWKHRoaXMuJCgnLnNjYWxhYmxlJylbMF0pLnNjYWxlKCk7CiAgICAgICAgICAgICAgICB0eCA9IGJib3gueCArIHJlZlggLyBzY2FsZS5zeDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHR4ID0gYmJveC54ICsgcmVmWDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZlkpKSB7CgogICAgICAgICAgICBpZiAocmVmWSA+IDAgJiYgcmVmWSA8IDEpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHkgPSBiYm94LnkgKyBiYm94LmhlaWdodCAqIHJlZlk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NjYWxhYmxlKSB7CgogICAgICAgICAgICAgICAgLy8gQ29tcGVuc2F0ZSBmb3IgdGhlIHNjYWxlIGdyaWQgaW4gY2FzZSB0aGUgZWxlbW50IGlzIGluIHRoZSBzY2FsYWJsZSBncm91cC4KICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSkuc2NhbGUoKTsKICAgICAgICAgICAgICAgIHR5ID0gYmJveC55ICsgcmVmWSAvIHNjYWxlLnN5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgdHkgPSBiYm94LnkgKyByZWZZOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCXZhciB2ZWxiYm94ID0gdmVsLmJib3goZmFsc2UsIHRoaXMucGFwZXIudmlld3BvcnQpOwogICAgICAgIC8vIGB5LWFsaWdubWVudGAgd2hlbiBzZXQgdG8gYG1pZGRsZWAgY2F1c2VzIGNlbnRlcmluZyBvZiB0aGUgc3ViZWxlbWVudCBhcm91bmQgaXRzIG5ldyB5IGNvb3JkaW5hdGUuCiAgICAgICAgaWYgKHlBbGlnbm1lbnQgPT09ICdtaWRkbGUnKSB7CgogICAgICAgICAgICB0eSAtPSB2ZWxiYm94LmhlaWdodC8yOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh5QWxpZ25tZW50KSkgewoKICAgICAgICAgICAgdHkgKz0gKHlBbGlnbm1lbnQgPiAtMSAmJiB5QWxpZ25tZW50IDwgMSkgPyAgdmVsYmJveC5oZWlnaHQgKiB5QWxpZ25tZW50IDogeUFsaWdubWVudDsKICAgICAgICB9CgogICAgICAgIC8vIGB4LWFsaWdubWVudGAgd2hlbiBzZXQgdG8gYG1pZGRsZWAgY2F1c2VzIGNlbnRlcmluZyBvZiB0aGUgc3ViZWxlbWVudCBhcm91bmQgaXRzIG5ldyB4IGNvb3JkaW5hdGUuCiAgICAgICAgaWYgKHhBbGlnbm1lbnQgPT09ICdtaWRkbGUnKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0eCAtPSB2ZWxiYm94LndpZHRoLzI7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHhBbGlnbm1lbnQpKSB7CgogICAgICAgICAgICB0eCArPSAoeEFsaWdubWVudCA+IC0xICYmIHhBbGlnbm1lbnQgPCAxKSA/ICB2ZWxiYm94LndpZHRoICogeEFsaWdubWVudCA6IHhBbGlnbm1lbnQ7CiAgICAgICAgfQoKICAgICAgICB2ZWwudHJhbnNsYXRlKHR4LCB0eSk7CiAgICB9LAoKICAgIC8vIGBwcm90b3R5cGUubWFya3VwYCBpcyByZW5kZXJlZCBieSBkZWZhdWx0LiBTZXQgdGhlIGBtYXJrdXBgIGF0dHJpYnV0ZSBvbiB0aGUgbW9kZWwgaWYgdGhlCiAgICAvLyBkZWZhdWx0IG1hcmt1cCBpcyBub3QgZGVzaXJhYmxlLgogICAgcmVuZGVyTWFya3VwOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgbWFya3VwID0gdGhpcy5tb2RlbC5tYXJrdXAgfHwgdGhpcy5tb2RlbC5nZXQoJ21hcmt1cCcpOwogICAgICAgIAogICAgICAgIGlmIChtYXJrdXApIHsKCiAgICAgICAgICAgIHZhciBub2RlcyA9IFYobWFya3VwKTsKICAgICAgICAgICAgVih0aGlzLmVsKS5hcHBlbmQobm9kZXMpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9wZXJ0aWVzLm1hcmt1cCBpcyBtaXNzaW5nIHdoaWxlIHRoZSBkZWZhdWx0IHJlbmRlcigpIGltcGxlbWVudGF0aW9uIGlzIHVzZWQuJyk7CiAgICAgICAgfQogICAgfSwKCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwoKICAgICAgICB0aGlzLnJlbmRlck1hcmt1cCgpOwoKICAgICAgICB0aGlzLnVwZGF0ZSgpOwoKICAgICAgICB0aGlzLnJlc2l6ZSgpOwogICAgICAgIHRoaXMucm90YXRlKCk7CiAgICAgICAgdGhpcy50cmFuc2xhdGUoKTsgICAgICAgIAoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2NhbGUgdGhlIHdob2xlIGA8Zz5gIGdyb3VwLiBOb3RlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gYHNjYWxlKClgIGFuZCBgcmVzaXplKClgIGhlcmUuCiAgICAvLyBgcmVzaXplKClgIGRvZXNuJ3Qgc2NhbGUgdGhlIHdob2xlIGA8Zz5gIGdyb3VwIGJ1dCByYXRoZXIgYWRqdXN0cyB0aGUgYGJveC5zeGAvYGJveC5zeWAgb25seS4KICAgIC8vIGB1cGRhdGUoKWAgaXMgdGhlbiByZXNwb25zaWJsZSBmb3Igc2NhbGluZyBvbmx5IHRob3NlIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgYGZvbGxvdy1zY2FsZWAKICAgIC8vIGF0dHJpYnV0ZSBzZXQgdG8gYHRydWVgLiBUaGlzIGlzIGRlc2lyYWJsZSBpbiBlbGVtZW50cyB0aGF0IGhhdmUgZS5nLiBhIGA8dGV4dD5gIHN1YmVsZW1lbnQKICAgIC8vIHRoYXQgaXMgbm90IHN1cHBvc2VkIHRvIGJlIHNjYWxlZCB0b2dldGhlciB3aXRoIGEgc3Vycm91bmRpbmcgYDxyZWN0PmAgZWxlbWVudCB0aGF0IElTIHN1cHBvc2VkCiAgICAvLyBiZSBiZSBzY2FsZWQuCiAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5KSB7CgogICAgICAgIC8vIFRPRE86IHRha2UgaW50byBhY2NvdW50IHRoZSBvcmlnaW4gY29vcmRpbmF0ZXMgYG94YCBhbmQgYG95YC4KICAgICAgICBWKHRoaXMuZWwpLnNjYWxlKHN4LCBzeSk7CiAgICB9LAoKICAgIHJlc2l6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBzaXplID0gdGhpcy5tb2RlbC5nZXQoJ3NpemUnKSB8fCB7IHdpZHRoOiAxLCBoZWlnaHQ6IDEgfTsKICAgICAgICB2YXIgYW5nbGUgPSB0aGlzLm1vZGVsLmdldCgnYW5nbGUnKSB8fCAwOwogICAgICAgIAogICAgICAgIHZhciBzY2FsYWJsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSk7CiAgICAgICAgaWYgKCFzY2FsYWJsZSkgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBzY2FsYWJsZSBlbGVtZW50cywgdGhhbiB0aGVyZSBpcyBub3RoaW5nIHRvIHJlc2l6ZS4KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgc2NhbGFibGVCYm94ID0gc2NhbGFibGUuYmJveCh0cnVlKTsKICAgICAgICAvLyBNYWtlIHN1cmUgYHNjYWxhYmxlQmJveC53aWR0aGAgYW5kIGBzY2FsYWJsZUJib3guaGVpZ2h0YCBhcmUgbm90IHplcm8gd2hpY2ggY2FuIGhhcHBlbiBpZiB0aGUgZWxlbWVudCBkb2VzIG5vdCBoYXZlIGFueSBjb250ZW50LiBCeSBtYWtpbmcKICAgICAgICAvLyB0aGUgd2lkdGgvaGVpZ2h0IDEsIHdlIHByZXZlbnQgSFRNTCBlcnJvcnMgb2YgdGhlIHR5cGUgYHNjYWxlKEluZmluaXR5LCBJbmZpbml0eSlgLgogICAgICAgIHNjYWxhYmxlLmF0dHIoJ3RyYW5zZm9ybScsICdzY2FsZSgnICsgKHNpemUud2lkdGggLyAoc2NhbGFibGVCYm94LndpZHRoIHx8IDEpKSArICcsJyArIChzaXplLmhlaWdodCAvIChzY2FsYWJsZUJib3guaGVpZ2h0IHx8IDEpKSArICcpJyk7CgogICAgICAgIC8vIE5vdyB0aGUgaW50ZXJlc3RpbmcgcGFydC4gVGhlIGdvYWwgaXMgdG8gYmUgYWJsZSB0byBzdG9yZSB0aGUgb2JqZWN0IGdlb21ldHJ5IHZpYSBqdXN0IGB4YCwgYHlgLCBgYW5nbGVgLCBgd2lkdGhgIGFuZCBgaGVpZ2h0YAogICAgICAgIC8vIE9yZGVyIG9mIHRyYW5zZm9ybWF0aW9ucyBpcyBzaWduaWZpY2FudCBidXQgd2Ugd2FudCB0byByZWNvbnN0cnVjdCB0aGUgb2JqZWN0IGFsd2F5cyBpbiB0aGUgb3JkZXI6CiAgICAgICAgLy8gcmVzaXplKCksIHJvdGF0ZSgpLCB0cmFuc2xhdGUoKSBubyBtYXR0ZXIgb2YgaG93IHRoZSBvYmplY3Qgd2FzIHRyYW5zZm9ybWVkLiBGb3IgdGhhdCB0byB3b3JrLAogICAgICAgIC8vIHdlIG11c3QgYWRqdXN0IHRoZSBgeGAgYW5kIGB5YCBjb29yZGluYXRlcyBvZiB0aGUgb2JqZWN0IHdoZW5ldmVyIHdlIHJlc2l6ZSBpdCAoYmVjYXVzZSB0aGUgb3JpZ2luIG9mIHRoZQogICAgICAgIC8vIHJvdGF0aW9uIGNoYW5nZXMpLiBUaGUgbmV3IGB4YCBhbmQgYHlgIGNvb3JkaW5hdGVzIGFyZSBjb21wdXRlZCBieSBjYW5jZWxpbmcgdGhlIHByZXZpb3VzIHJvdGF0aW9uCiAgICAgICAgLy8gYXJvdW5kIHRoZSBjZW50ZXIgb2YgdGhlIHJlc2l6ZWQgb2JqZWN0ICh3aGljaCBpcyBhIGRpZmZlcmVudCBvcmlnaW4gdGhlbiB0aGUgb3JpZ2luIG9mIHRoZSBwcmV2aW91cyByb3RhdGlvbikKICAgICAgICAvLyBhbmQgZ2V0dGluZyB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSByZXN1bHRpbmcgb2JqZWN0LiBUaGVuIHdlIGNsZWFuIHVwIHRoZSByb3RhdGlvbiBiYWNrIHRvIHdoYXQgaXQgb3JpZ2luYWxseSB3YXMuCiAgICAgICAgCiAgICAgICAgLy8gQ2FuY2VsIHRoZSByb3RhdGlvbiBidXQgbm93IGFyb3VuZCBhIGRpZmZlcmVudCBvcmlnaW4sIHdoaWNoIGlzIHRoZSBjZW50ZXIgb2YgdGhlIHNjYWxlZCBvYmplY3QuCiAgICAgICAgdmFyIHJvdGF0YWJsZSA9IFYodGhpcy4kKCcucm90YXRhYmxlJylbMF0pOwogICAgICAgIHZhciByb3RhdGlvbiA9IHJvdGF0YWJsZSAmJiByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJyk7CiAgICAgICAgaWYgKHJvdGF0aW9uICYmIHJvdGF0aW9uICE9PSAnbnVsbCcpIHsKCiAgICAgICAgICAgIHJvdGF0YWJsZS5hdHRyKCd0cmFuc2Zvcm0nLCByb3RhdGlvbiArICcgcm90YXRlKCcgKyAoLWFuZ2xlKSArICcsJyArIChzaXplLndpZHRoLzIpICsgJywnICsgKHNpemUuaGVpZ2h0LzIpICsgJyknKTsKICAgICAgICAgICAgdmFyIHJvdGF0YWJsZUJib3ggPSBzY2FsYWJsZS5iYm94KGZhbHNlLCB0aGlzLnBhcGVyLnZpZXdwb3J0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3JlIG5ldyB4LCB5IGFuZCBwZXJmb3JtIHJvdGF0ZSgpIGFnYWluIGFnYWluc3QgdGhlIG5ldyByb3RhdGlvbiBvcmlnaW4uCiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCdwb3NpdGlvbicsIHsgeDogcm90YXRhYmxlQmJveC54LCB5OiByb3RhdGFibGVCYm94LnkgfSk7CiAgICAgICAgICAgIHRoaXMucm90YXRlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgbXVzdCBhbHdheXMgYmUgY2FsbGVkIG9uIG5vbi1yb3RhdGVkIGVsZW1lbnQuIE90aGVyd2lzZSwgcmVsYXRpdmUgcG9zaXRpb25pbmcKICAgICAgICAvLyB3b3VsZCB3b3JrIHdpdGggd3JvbmcgKHJvdGF0ZWQpIGJvdW5kaW5nIGJveGVzLgogICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9LAoKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24obW9kZWwsIGNoYW5nZXMsIG9wdCkgewoKICAgICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLm1vZGVsLmdldCgncG9zaXRpb24nKSB8fCB7IHg6IDAsIHk6IDAgfTsKCiAgICAgICAgVih0aGlzLmVsKS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyBwb3NpdGlvbi54ICsgJywnICsgcG9zaXRpb24ueSArICcpJyk7CiAgICB9LAoKICAgIHJvdGF0ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciByb3RhdGFibGUgPSBWKHRoaXMuJCgnLnJvdGF0YWJsZScpWzBdKTsKICAgICAgICBpZiAoIXJvdGF0YWJsZSkgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyByb3RhdGFibGUgZWxlbWVudHMsIHRoZW4gdGhlcmUgaXMgbm90aGluZyB0byByb3RhdGUuCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIGFuZ2xlID0gdGhpcy5tb2RlbC5nZXQoJ2FuZ2xlJykgfHwgMDsKICAgICAgICB2YXIgc2l6ZSA9IHRoaXMubW9kZWwuZ2V0KCdzaXplJykgfHwgeyB3aWR0aDogMSwgaGVpZ2h0OiAxIH07CgogICAgICAgIHZhciBveCA9IHNpemUud2lkdGgvMjsKICAgICAgICB2YXIgb3kgPSBzaXplLmhlaWdodC8yOwogICAgICAgIAoKICAgICAgICByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJywgJ3JvdGF0ZSgnICsgYW5nbGUgKyAnLCcgKyBveCArICcsJyArIG95ICsgJyknKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uIFRoZSBjb250cm9sbGVyIHBhcnQuCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAKICAgIHBvaW50ZXJkb3duOiBmdW5jdGlvbihldnQsIHgsIHkpIHsKCiAgICAgICAgaWYgKCAvLyB0YXJnZXQgaXMgYSB2YWxpZCBtYWduZXQgc3RhcnQgbGlua2luZwogICAgICAgICAgICBldnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnbWFnbmV0JykgJiYKICAgICAgICAgICAgdGhpcy5wYXBlci5vcHRpb25zLnZhbGlkYXRlTWFnbmV0LmNhbGwodGhpcy5wYXBlciwgdGhpcywgZXZ0LnRhcmdldCkKICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHRoaXMucGFwZXIuZ2V0RGVmYXVsdExpbmsodGhpcywgZXZ0LnRhcmdldCk7CiAgICAgICAgICAgICAgICBsaW5rLnNldCh7CiAgICAgICAgICAgICAgICAgICAgc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB0aGlzLm1vZGVsLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvcjogdGhpcy5nZXRTZWxlY3RvcihldnQudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogJChldnQudGFyZ2V0KS5hdHRyKCdwb3J0JykKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogeyB4OiB4LCB5OiB5IH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMucGFwZXIubW9kZWwuYWRkQ2VsbChsaW5rKTsKCgkgICAgICAgIHRoaXMuX2xpbmtWaWV3ID0gdGhpcy5wYXBlci5maW5kVmlld0J5TW9kZWwobGluayk7CiAgICAgICAgICAgICAgICB0aGlzLl9saW5rVmlldy5zdGFydEFycm93aGVhZE1vdmUoJ3RhcmdldCcpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy5fZHggPSB4OwogICAgICAgICAgICB0aGlzLl9keSA9IHk7CgogICAgICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJkb3duLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgfSwKCiAgICBwb2ludGVybW92ZTogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIGlmICh0aGlzLl9saW5rVmlldykgewoKICAgICAgICAgICAgLy8gbGV0IHRoZSBsaW5rdmlldyBkZWFsIHdpdGggdGhpcyBldmVudAogICAgICAgICAgICB0aGlzLl9saW5rVmlldy5wb2ludGVybW92ZShldnQsIHgsIHkpOwoKICAgICAgICB9IGVsc2UgewoKCSAgICB2YXIgZ3JpZCA9IHRoaXMucGFwZXIub3B0aW9ucy5ncmlkU2l6ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgIT09IGZhbHNlKSB7CgoJICAgICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLm1vZGVsLmdldCgncG9zaXRpb24nKTsKCgkgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgbmV3IGVsZW1lbnQncyBwb3NpdGlvbiBhbHdheXMgc25hcHMgdG8gdGhlIGN1cnJlbnQgZ3JpZCBhZnRlcgoJICAgICAgICAvLyB0cmFuc2xhdGUgYXMgdGhlIHByZXZpb3VzIG9uZSBjb3VsZCBiZSBjYWxjdWxhdGVkIHdpdGggYSBkaWZmZXJlbnQgZ3JpZCBzaXplLgoJICAgICAgICB0aGlzLm1vZGVsLnRyYW5zbGF0ZSgKCQkgICAgZy5zbmFwVG9HcmlkKHBvc2l0aW9uLngsIGdyaWQpIC0gcG9zaXRpb24ueCArIGcuc25hcFRvR3JpZCh4IC0gdGhpcy5fZHgsIGdyaWQpLAoJCSAgICBnLnNuYXBUb0dyaWQocG9zaXRpb24ueSwgZ3JpZCkgLSBwb3NpdGlvbi55ICsgZy5zbmFwVG9HcmlkKHkgLSB0aGlzLl9keSwgZ3JpZCkKCSAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZHggPSBnLnNuYXBUb0dyaWQoeCwgZ3JpZCk7CiAgICAgICAgICAgIHRoaXMuX2R5ID0gZy5zbmFwVG9HcmlkKHksIGdyaWQpOwoKICAgICAgICAgICAgam9pbnQuZGlhLkNlbGxWaWV3LnByb3RvdHlwZS5wb2ludGVybW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcnVwOiBmdW5jdGlvbihldnQsIHgsIHkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2xpbmtWaWV3KSB7CgogICAgICAgICAgICAvLyBsZXQgdGhlIGxpbmt2aWV3IGRlYWwgd2l0aCB0aGlzIGV2ZW50CiAgICAgICAgICAgIHRoaXMuX2xpbmtWaWV3LnBvaW50ZXJ1cChldnQsIHgsIHkpOwoKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2xpbmtWaWV3OwoKICAgICAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJ1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkVsZW1lbnQgPSBqb2ludC5kaWEuRWxlbWVudDsKICAgIG1vZHVsZS5leHBvcnRzLkVsZW1lbnRWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3Owp9CgovLyAgICAgIEpvaW50SlMgZGlhZ3JhbW1pbmcgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIENlbGw6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmNlbGwnKS5DZWxsLAogICAgICAgICAgICBDZWxsVmlldzogcmVxdWlyZSgnLi9qb2ludC5kaWEuY2VsbCcpLkNlbGxWaWV3CiAgICAgICAgfQogICAgfTsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwogICAgdmFyIGcgPSByZXF1aXJlKCcuL2dlb21ldHJ5Jyk7Cn0KCgoKLy8gam9pbnQuZGlhLkxpbmsgYmFzZSBtb2RlbC4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0Kam9pbnQuZGlhLkxpbmsgPSBqb2ludC5kaWEuQ2VsbC5leHRlbmQoewoKICAgIC8vIFRoZSBkZWZhdWx0IG1hcmt1cCBmb3IgbGlua3MuCiAgICBtYXJrdXA6IFsKICAgICAgICAnPHBhdGggY2xhc3M9ImNvbm5lY3Rpb24iIHN0cm9rZT0iYmxhY2siLz4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLXNvdXJjZSIgZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIC8+JywKICAgICAgICAnPHBhdGggY2xhc3M9Im1hcmtlci10YXJnZXQiIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiAvPicsCiAgICAgICAgJzxwYXRoIGNsYXNzPSJjb25uZWN0aW9uLXdyYXAiLz4nLAogICAgICAgICc8ZyBjbGFzcz0ibGFiZWxzIi8+JywKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci12ZXJ0aWNlcyIvPicsCiAgICAgICAgJzxnIGNsYXNzPSJtYXJrZXItYXJyb3doZWFkcyIvPicsCiAgICAgICAgJzxnIGNsYXNzPSJsaW5rLXRvb2xzIi8+JwogICAgXS5qb2luKCcnKSwKCiAgICBsYWJlbE1hcmt1cDogWwogICAgICAgICc8ZyBjbGFzcz0ibGFiZWwiPicsCiAgICAgICAgJzxyZWN0IC8+JywKICAgICAgICAnPHRleHQgLz4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICB0b29sTWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJsaW5rLXRvb2wiPicsCiAgICAgICAgJzxnIGNsYXNzPSJ0b29sLXJlbW92ZSIgZXZlbnQ9InJlbW92ZSI+JywKICAgICAgICAnPGNpcmNsZSByPSIxMSIgLz4nLAogICAgICAgICc8cGF0aCB0cmFuc2Zvcm09InNjYWxlKC44KSB0cmFuc2xhdGUoLTE2LCAtMTYpIiBkPSJNMjQuNzc4LDIxLjQxOSAxOS4yNzYsMTUuOTE3IDI0Ljc3NywxMC40MTUgMjEuOTQ5LDcuNTg1IDE2LjQ0NywxMy4wODcgMTAuOTQ1LDcuNTg1IDguMTE3LDEwLjQxNSAxMy42MTgsMTUuOTE3IDguMTE2LDIxLjQxOSAxMC45NDYsMjQuMjQ4IDE2LjQ0NywxOC43NDYgMjEuOTQ4LDI0LjI0OHoiLz4nLAogICAgICAgICc8dGl0bGU+UmVtb3ZlIGxpbmsuPC90aXRsZT4nLAogICAgICAgICc8L2c+JywKICAgICAgICAnPGcgY2xhc3M9InRvb2wtb3B0aW9ucyIgZXZlbnQ9Imxpbms6b3B0aW9ucyI+JywKICAgICAgICAnPGNpcmNsZSByPSIxMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUpIi8+JywKICAgICAgICAnPHBhdGggZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ic2NhbGUoLjU1KSB0cmFuc2xhdGUoMjksIC0xNikiIGQ9Ik0zMS4yMjksMTcuNzM2YzAuMDY0LTAuNTcxLDAuMTA0LTEuMTQ4LDAuMTA0LTEuNzM2cy0wLjA0LTEuMTY2LTAuMTA0LTEuNzM3bC00LjM3Ny0xLjU1N2MtMC4yMTgtMC43MTYtMC41MDQtMS40MDEtMC44NTEtMi4wNWwxLjk5My00LjE5MmMtMC43MjUtMC45MS0xLjU0OS0xLjczNC0yLjQ1OC0yLjQ1OWwtNC4xOTMsMS45OTRjLTAuNjQ3LTAuMzQ3LTEuMzM0LTAuNjMyLTIuMDQ5LTAuODQ5bC0xLjU1OC00LjM3OEMxNy4xNjUsMC43MDgsMTYuNTg4LDAuNjY3LDE2LDAuNjY3cy0xLjE2NiwwLjA0MS0xLjczNywwLjEwNUwxMi43MDcsNS4xNWMtMC43MTYsMC4yMTctMS40MDEsMC41MDItMi4wNSwwLjg0OUw2LjQ2NCw0LjAwNUM1LjU1NCw0LjczLDQuNzMsNS41NTQsNC4wMDUsNi40NjRsMS45OTQsNC4xOTJjLTAuMzQ3LDAuNjQ4LTAuNjMyLDEuMzM0LTAuODQ5LDIuMDVsLTQuMzc4LDEuNTU3QzAuNzA4LDE0LjgzNCwwLjY2NywxNS40MTIsMC42NjcsMTZzMC4wNDEsMS4xNjUsMC4xMDUsMS43MzZsNC4zNzgsMS41NThjMC4yMTcsMC43MTUsMC41MDIsMS40MDEsMC44NDksMi4wNDlsLTEuOTk0LDQuMTkzYzAuNzI1LDAuOTA5LDEuNTQ5LDEuNzMzLDIuNDU5LDIuNDU4bDQuMTkyLTEuOTkzYzAuNjQ4LDAuMzQ3LDEuMzM0LDAuNjMzLDIuMDUsMC44NTFsMS41NTcsNC4zNzdjMC41NzEsMC4wNjQsMS4xNDgsMC4xMDQsMS43MzcsMC4xMDRjMC41ODgsMCwxLjE2NS0wLjA0LDEuNzM2LTAuMTA0bDEuNTU4LTQuMzc3YzAuNzE1LTAuMjE4LDEuMzk5LTAuNTA0LDIuMDQ5LTAuODUxbDQuMTkzLDEuOTkzYzAuOTA5LTAuNzI1LDEuNzMzLTEuNTQ5LDIuNDU4LTIuNDU4bC0xLjk5My00LjE5M2MwLjM0Ny0wLjY0NywwLjYzMy0xLjMzNCwwLjg1MS0yLjA0OUwzMS4yMjksMTcuNzM2ek0xNiwyMC44NzFjLTIuNjksMC00Ljg3Mi0yLjE4Mi00Ljg3Mi00Ljg3MWMwLTIuNjksMi4xODItNC44NzIsNC44NzItNC44NzJjMi42ODksMCw0Ljg3MSwyLjE4Miw0Ljg3MSw0Ljg3MkMyMC44NzEsMTguNjg5LDE4LjY4OSwyMC44NzEsMTYsMjAuODcxeiIvPicsCiAgICAgICAgJzx0aXRsZT5MaW5rIG9wdGlvbnMuPC90aXRsZT4nLAogICAgICAgICc8L2c+JywKICAgICAgICAnPC9nPicKICAgIF0uam9pbignJyksCgogICAgLy8gVGhlIGRlZmF1bHQgbWFya3VwIGZvciBzaG93aW5nL3JlbW92aW5nIHZlcnRpY2VzLiBUaGVzZSBlbGVtZW50cyBhcmUgdGhlIGNoaWxkcmVuIG9mIHRoZSAubWFya2VyLXZlcnRpY2VzIGVsZW1lbnQgKHNlZSBgdGhpcy5tYXJrdXBgKS4KICAgIC8vIE9ubHkgLm1hcmtlci12ZXJ0ZXggYW5kIC5tYXJrZXItdmVydGV4LXJlbW92ZSBlbGVtZW50IGhhdmUgc3BlY2lhbCBtZWFuaW5nLiBUaGUgZm9ybWVyIGlzIHVzZWQgZm9yCiAgICAvLyBkcmFnZ2luZyB2ZXJ0aWNlcyAoY2hhbmdpbiB0aGVpciBwb3NpdGlvbikuIFRoZSBsYXR0ZXIgaXMgdXNlZCBmb3IgcmVtb3ZpbmcgdmVydGljZXMuCiAgICB2ZXJ0ZXhNYXJrdXA6IFsKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci12ZXJ0ZXgtZ3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDwlPSB4ICU+LCA8JT0geSAlPikiPicsCiAgICAgICAgJzxjaXJjbGUgY2xhc3M9Im1hcmtlci12ZXJ0ZXgiIGlkeD0iPCU9IGlkeCAlPiIgcj0iMTAiIC8+JywKICAgICAgICAnPHBhdGggY2xhc3M9Im1hcmtlci12ZXJ0ZXgtcmVtb3ZlLWFyZWEiIGlkeD0iPCU9IGlkeCAlPiIgZD0iTTE2LDUuMzMzYy03LjczMiwwLTE0LDQuNzAxLTE0LDEwLjVjMCwxLjk4MiwwLjc0MSwzLjgzMywyLjAxNiw1LjQxNEwyLDI1LjY2N2w1LjYxMy0xLjQ0MWMyLjMzOSwxLjMxNyw1LjIzNywyLjEwNyw4LjM4NywyLjEwN2M3LjczMiwwLDE0LTQuNzAxLDE0LTEwLjVDMzAsMTAuMDM0LDIzLjczMiw1LjMzMywxNiw1LjMzM3oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUsIC0zMykiLz4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLXZlcnRleC1yZW1vdmUiIGlkeD0iPCU9IGlkeCAlPiIgdHJhbnNmb3JtPSJzY2FsZSguOCkgdHJhbnNsYXRlKDkuNSwgLTM3KSIgZD0iTTI0Ljc3OCwyMS40MTkgMTkuMjc2LDE1LjkxNyAyNC43NzcsMTAuNDE1IDIxLjk0OSw3LjU4NSAxNi40NDcsMTMuMDg3IDEwLjk0NSw3LjU4NSA4LjExNywxMC40MTUgMTMuNjE4LDE1LjkxNyA4LjExNiwyMS40MTkgMTAuOTQ2LDI0LjI0OCAxNi40NDcsMTguNzQ2IDIxLjk0OCwyNC4yNDh6Ij4nLAogICAgICAgICc8dGl0bGU+UmVtb3ZlIHZlcnRleC48L3RpdGxlPicsCiAgICAgICAgJzwvcGF0aD4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICBhcnJvd2hlYWRNYXJrdXA6IFsKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci1hcnJvd2hlYWQtZ3JvdXAgbWFya2VyLWFycm93aGVhZC1ncm91cC08JT0gZW5kICU+Ij4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLWFycm93aGVhZCIgZW5kPSI8JT0gZW5kICU+IiBkPSJNIDI2IDAgTCAwIDEzIEwgMjYgMjYgeiIgLz4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICBkZWZhdWx0czogewoKICAgICAgICB0eXBlOiAnbGluaycKICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiB0aGlzLnNldCh7IHNvdXJjZTogZy5wb2ludCgwLCAwKSwgdGFyZ2V0OiBnLnBvaW50KDAsIDApIH0pOwogICAgfSwKCiAgICAvLyBBIGNvbnZlbmllbnQgd2F5IHRvIHNldCBsYWJlbHMuIEN1cnJlbnRseSBzZXQgdmFsdWVzIHdpbGwgYmUgbWl4aW5lZCB3aXRoIGB2YWx1ZWAgaWYgdXNlZCBhcyBhIHNldHRlci4KICAgIGxhYmVsOiBmdW5jdGlvbihpZHgsIHZhbHVlKSB7CgogICAgICAgIGlkeCA9IGlkeCB8fCAwOwogICAgICAgIAogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgCiAgICAgICAgLy8gSXMgaXQgYSBnZXR0ZXI/CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGxhYmVsc1tpZHhdOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1ZhbHVlID0gXy5tZXJnZSh7fSwgbGFiZWxzW2lkeF0sIHZhbHVlKTsKCiAgICAgICAgdmFyIG5ld0xhYmVscyA9IGxhYmVscy5zbGljZSgpOwogICAgICAgIG5ld0xhYmVsc1tpZHhdID0gbmV3VmFsdWU7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KHsgbGFiZWxzOiBuZXdMYWJlbHMgfSk7CiAgICB9LAoKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24odHgsIHR5LCBvcHQpIHsKCiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgdmFyIHNvdXJjZSA9IHRoaXMuZ2V0KCdzb3VyY2UnKTsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5nZXQoJ3RhcmdldCcpOwogICAgICAgIHZhciB2ZXJ0aWNlcyA9IHRoaXMuZ2V0KCd2ZXJ0aWNlcycpOwoKICAgICAgICBpZiAoIXNvdXJjZS5pZCkgewogICAgICAgICAgICBhdHRycy5zb3VyY2UgPSB7IHg6IHNvdXJjZS54ICsgdHgsIHk6IHNvdXJjZS55ICsgdHkgfTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFyZ2V0LmlkKSB7CiAgICAgICAgICAgIGF0dHJzLnRhcmdldCA9IHsgeDogdGFyZ2V0LnggKyB0eCwgeTogdGFyZ2V0LnkgKyB0eSB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHZlcnRpY2VzICYmIHZlcnRpY2VzLmxlbmd0aCkgewogICAgICAgICAgICBhdHRycy52ZXJ0aWNlcyA9IF8ubWFwKHZlcnRpY2VzLCBmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IHZlcnRleC54ICsgdHgsIHk6IHZlcnRleC55ICsgdHkgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIG9wdCk7CiAgICB9Cn0pOwoKCi8vIGpvaW50LmRpYS5MaW5rIGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkxpbmtWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3LmV4dGVuZCh7CgogICAgY2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gXy51bmlxdWUodGhpcy5tb2RlbC5nZXQoJ3R5cGUnKS5zcGxpdCgnLicpLmNvbmNhdCgnbGluaycpKS5qb2luKCcgJyk7CiAgICB9LAoKICAgIG9wdGlvbnM6IHsKCiAgICAgICAgc2hvcnRMaW5rTGVuZ3RoOiAxMDAKICAgIH0sCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgLy8gY3JlYXRlIG1ldGhvZHMgaW4gcHJvdG90eXBlLCBzbyB0aGV5IGNhbiBiZSBhY2Nlc3NlZCBmcm9tIGFueSBpbnN0YW5jZSBhbmQKICAgICAgICAvLyBkb24ndCBuZWVkIHRvIGJlIGNyZWF0ZSBvdmVyIGFuZCBvdmVyCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFNvdXJjZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFNvdXJjZSA9IHRoaXMuX2NyZWF0ZVdhdGNoZXIoJ3NvdXJjZScpOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFRhcmdldCA9IHRoaXMuX2NyZWF0ZVdhdGNoZXIoJ3RhcmdldCcpOwogICAgICAgIH0KCiAgICAgICAgLy8gYF8ubGFiZWxDYWNoZWAgaXMgYSBtYXBwaW5nIG9mIGluZGV4ZXMgb2YgbGFiZWxzIGluIHRoZSBgdGhpcy5nZXQoJ2xhYmVscycpYCBhcnJheSB0bwogICAgICAgIC8vIGA8ZyBjbGFzcz0ibGFiZWwiPmAgbm9kZXMgd3JhcHBlZCBieSBWZWN0b3JpemVyLiBUaGlzIGFsbG93cyBmb3IgcXVpY2sgYWNjZXNzIHRvIHRoZQogICAgICAgIC8vIG5vZGVzIGluIGB1cGRhdGVMYWJlbFBvc2l0aW9uKClgIGluIG9yZGVyIHRvIHVwZGF0ZSB0aGUgbGFiZWwgcG9zaXRpb25zLgogICAgICAgIHRoaXMuX2xhYmVsQ2FjaGUgPSB7fTsKCiAgICAgICAgLy8ga2VlcHMgbWFya2VycyBiYm94ZXMgYW5kIHBvc2l0aW9ucyBhZ2FpbiBmb3IgcXVpY2tlciBhY2Nlc3MKICAgICAgICB0aGlzLl9tYXJrZXJDYWNoZSA9IHt9OwoKICAgICAgICAvLyBiaW5kIGV2ZW50cwogICAgICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTsKICAgIH0sCgogICAgc3RhcnRMaXN0ZW5pbmc6IGZ1bmN0aW9uKCkgewoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTptYXJrdXAnLCB0aGlzLnJlbmRlcik7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6c21vb3RoIGNoYW5nZTptYW5oYXR0YW4gY2hhbmdlOnJvdXRlciBjaGFuZ2U6Y29ubmVjdG9yJywgdGhpcy51cGRhdGUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTp0b29sTWFya3VwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVG9vbHMoKS51cGRhdGVUb29sc1Bvc2l0aW9uKCk7CiAgICAgICAgfSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6bGFiZWxzIGNoYW5nZTpsYWJlbE1hcmt1cCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJlbmRlckxhYmVscygpLnVwZGF0ZUxhYmVsUG9zaXRpb25zKCk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnZlcnRpY2VzIGNoYW5nZTp2ZXJ0ZXhNYXJrdXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJWZXJ0ZXhNYXJrZXJzKCkudXBkYXRlKCk7CiAgICAgICAgfSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6c291cmNlJywgZnVuY3Rpb24oY2VsbCwgc291cmNlKSB7CiAgICAgICAgICAgIHRoaXMud2F0Y2hTb3VyY2UoY2VsbCwgc291cmNlKS51cGRhdGUoKTsKICAgICAgICB9KTsKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTp0YXJnZXQnLCBmdW5jdGlvbihjZWxsLCB0YXJnZXQpIHsKICAgICAgICAgICAgdGhpcy53YXRjaFRhcmdldChjZWxsLCB0YXJnZXQpLnVwZGF0ZSgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZW5kZXJpbmcKICAgIC8vLS0tLS0tLS0tLQoKICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CgoJdGhpcy4kZWwuZW1wdHkoKTsKCiAgICAgICAgLy8gQSBzcGVjaWFsIG1hcmt1cCBjYW4gYmUgZ2l2ZW4gaW4gdGhlIGBwcm9wZXJ0aWVzLm1hcmt1cGAgcHJvcGVydHkuIFRoaXMgbWlnaHQgYmUgaGFuZHkKICAgICAgICAvLyBpZiBlLmcuIGFycm93aGVhZCBtYXJrZXJzIHNob3VsZCBiZSBgPGltYWdlPmAgZWxlbWVudHMgb3IgYW55IG90aGVyIGVsZW1lbnQgdGhhbiBgPHBhdGg+YHMuCiAgICAgICAgLy8gYC5jb25uZWN0aW9uYCwgYC5jb25uZWN0aW9uLXdyYXBgLCBgLm1hcmtlci1zb3VyY2VgIGFuZCBgLm1hcmtlci10YXJnZXRgIHNlbGVjdG9ycwogICAgICAgIC8vIG9mIGVsZW1lbnRzIHdpdGggc3BlY2lhbCBtZWFuaW5nIHRob3VnaC4gVGhlcmVmb3JlLCB0aG9zZSBjbGFzc2VzIHNob3VsZCBiZSBwcmVzZXJ2ZWQgaW4gYW55CiAgICAgICAgLy8gc3BlY2lhbCBtYXJrdXAgcGFzc2VkIGluIGBwcm9wZXJ0aWVzLm1hcmt1cGAuCiAgICAgICAgdmFyIGNoaWxkcmVuID0gVih0aGlzLm1vZGVsLmdldCgnbWFya3VwJykgfHwgdGhpcy5tb2RlbC5tYXJrdXApOwoKICAgICAgICAvLyBjdXN0b20gbWFya3VwIG1heSBjb250YWluIG9ubHkgb25lIGNoaWxkcmVuCiAgICAgICAgaWYgKCFfLmlzQXJyYXkoY2hpbGRyZW4pKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgogICAgICAgIC8vIENhY2hlIGFsbCBjaGlsZHJlbiBlbGVtZW50cyBmb3IgcXVpY2tlciBhY2Nlc3MuCiAgICAgICAgdGhpcy5fViA9IHt9OyAvLyB2ZWN0b3JpemVkIG1hcmt1cDsKICAgICAgICBfLmVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHZhciBjID0gY2hpbGQuYXR0cignY2xhc3MnKTsKICAgICAgICAgICAgYyAmJiAodGhpcy5fVlskLmNhbWVsQ2FzZShjKV0gPSBjaGlsZCk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIE9ubHkgdGhlIGNvbm5lY3Rpb24gcGF0aCBpcyBtYW5kYXRvcnkKICAgICAgICBpZiAoIXRoaXMuX1YuY29ubmVjdGlvbikgdGhyb3cgbmV3IEVycm9yKCdsaW5rOiBubyBjb25uZWN0aW9uIHBhdGggaW4gdGhlIG1hcmt1cCcpOwoKICAgICAgICAvLyBwYXJ0aWFsIHJlbmRlcmluZwogICAgICAgIHRoaXMucmVuZGVyVG9vbHMoKTsKICAgICAgICB0aGlzLnJlbmRlclZlcnRleE1hcmtlcnMoKTsKICAgICAgICB0aGlzLnJlbmRlckFycm93aGVhZE1hcmtlcnMoKTsKCiAgICAgICAgVih0aGlzLmVsKS5hcHBlbmQoY2hpbGRyZW4pOwoKICAgICAgICAvLyByZW5kZXJpbmcgbGFiZWxzIGhhcyB0byBiZSBydW4gYWZ0ZXIgdGhlIGxpbmsgaXMgYXBwZW5kZWQgdG8gRE9NIHRyZWUuIChvdGhlcndpc2UgPFRleHQ+IGJib3gKICAgICAgICAvLyByZXR1cm5zIHplcm8gdmFsdWVzKQogICAgICAgIHRoaXMucmVuZGVyTGFiZWxzKCk7CgogICAgICAgIC8vIHN0YXJ0IHdhdGNoaW5nIHRoZSBlbmRzIG9mIHRoZSBsaW5rIGZvciBjaGFuZ2VzCiAgICAgICAgdGhpcy53YXRjaFNvdXJjZSh0aGlzLm1vZGVsLCB0aGlzLm1vZGVsLmdldCgnc291cmNlJykpCiAgICAgICAgICAgIC53YXRjaFRhcmdldCh0aGlzLm1vZGVsLCB0aGlzLm1vZGVsLmdldCgndGFyZ2V0JykpCiAgICAgICAgICAgIC51cGRhdGUoKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlckxhYmVsczogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICghdGhpcy5fVi5sYWJlbHMpIHJldHVybiB0aGlzOwoKICAgICAgICB0aGlzLl9sYWJlbENhY2hlID0ge307CiAgICAgICAgdmFyICRsYWJlbHMgPSAkKHRoaXMuX1YubGFiZWxzLm5vZGUpLmVtcHR5KCk7CgogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLm1vZGVsLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgaWYgKCFsYWJlbHMubGVuZ3RoKSByZXR1cm4gdGhpczsKICAgICAgICAKICAgICAgICB2YXIgbGFiZWxUZW1wbGF0ZSA9IF8udGVtcGxhdGUodGhpcy5tb2RlbC5nZXQoJ2xhYmVsTWFya3VwJykgfHwgdGhpcy5tb2RlbC5sYWJlbE1hcmt1cCk7CiAgICAgICAgLy8gVGhpcyBpcyBhIHByZXBhcmVkIGluc3RhbmNlIG9mIGEgdmVjdG9yaXplZCBTVkdET00gbm9kZSBmb3IgdGhlIGxhYmVsIGVsZW1lbnQgcmVzdWx0aW5nIGZyb20KICAgICAgICAvLyBjb21waWxhdGlvbiBvZiB0aGUgbGFiZWxUZW1wbGF0ZS4gVGhlIHB1cnBvc2UgaXMgdGhhdCBhbGwgbGFiZWxzIHdpbGwganVzdCBgY2xvbmUoKWAgdGhpcwogICAgICAgIC8vIG5vZGUgdG8gY3JlYXRlIGEgZHVwbGljYXRlLgogICAgICAgIHZhciBsYWJlbE5vZGVJbnN0YW5jZSA9IFYobGFiZWxUZW1wbGF0ZSgpKTsKCiAgICAgICAgXy5lYWNoKGxhYmVscywgZnVuY3Rpb24obGFiZWwsIGlkeCkgewoKICAgICAgICAgICAgdmFyIGxhYmVsTm9kZSA9IGxhYmVsTm9kZUluc3RhbmNlLmNsb25lKCkubm9kZTsKICAgICAgICAgICAgLy8gQ2FjaGUgbGFiZWwgbm9kZXMgc28gdGhhdCB0aGUgYHVwZGF0ZUxhYmVscygpYCBjYW4ganVzdCB1cGRhdGUgdGhlIGxhYmVsIG5vZGUgcG9zaXRpb25zLgogICAgICAgICAgICB0aGlzLl9sYWJlbENhY2hlW2lkeF0gPSBWKGxhYmVsTm9kZSk7CgogICAgICAgICAgICB2YXIgJHRleHQgPSAkKGxhYmVsTm9kZSkuZmluZCgndGV4dCcpOwogICAgICAgICAgICB2YXIgJHJlY3QgPSAkKGxhYmVsTm9kZSkuZmluZCgncmVjdCcpOwoKICAgICAgICAgICAgLy8gVGV4dCBhdHRyaWJ1dGVzIHdpdGggdGhlIGRlZmF1bHQgYHRleHQtYW5jaG9yYCBhbmQgZm9udC1zaXplIHNldC4KICAgICAgICAgICAgdmFyIHRleHRBdHRyaWJ1dGVzID0gXy5leHRlbmQoeyAndGV4dC1hbmNob3InOiAnbWlkZGxlJywgJ2ZvbnQtc2l6ZSc6IDE0IH0sIGpvaW50LnV0aWwuZ2V0QnlQYXRoKGxhYmVsLCAnYXR0cnMvdGV4dCcsICcvJykpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHRleHQuYXR0cihfLm9taXQodGV4dEF0dHJpYnV0ZXMsICd0ZXh0JykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh0ZXh0QXR0cmlidXRlcy50ZXh0KSkgewoKICAgICAgICAgICAgICAgIFYoJHRleHRbMF0pLnRleHQodGV4dEF0dHJpYnV0ZXMudGV4dCArICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGZpcnN0IG5lZWQgdG8gYXBwZW5kIHRoZSBgPHRleHQ+YCBlbGVtZW50IHRvIHRoZSBET00gaW4gb3JkZXIgdG8KICAgICAgICAgICAgLy8gZ2V0IGl0cyBib3VuZGluZyBib3guCiAgICAgICAgICAgICRsYWJlbHMuYXBwZW5kKGxhYmVsTm9kZSk7CgogICAgICAgICAgICAvLyBgeS1hbGlnbm1lbnRgIC0gY2VudGVyIHRoZSB0ZXh0IGVsZW1lbnQgYXJvdW5kIGl0cyB5IGNvb3JkaW5hdGUuCiAgICAgICAgICAgIHZhciB0ZXh0QmJveCA9IFYoJHRleHRbMF0pLmJib3godHJ1ZSwgJGxhYmVsc1swXSk7CiAgICAgICAgICAgIFYoJHRleHRbMF0pLnRyYW5zbGF0ZSgwLCAtdGV4dEJib3guaGVpZ2h0LzIpOwoKICAgICAgICAgICAgLy8gQWRkIGRlZmF1bHQgdmFsdWVzLgogICAgICAgICAgICB2YXIgcmVjdEF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7CgogICAgICAgICAgICAgICAgZmlsbDogJ3doaXRlJywKICAgICAgICAgICAgICAgIHJ4OiAzLAogICAgICAgICAgICAgICAgcnk6IDMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9LCBqb2ludC51dGlsLmdldEJ5UGF0aChsYWJlbCwgJ2F0dHJzL3JlY3QnLCAnLycpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICRyZWN0LmF0dHIoXy5leHRlbmQocmVjdEF0dHJpYnV0ZXMsIHsKCiAgICAgICAgICAgICAgICB4OiB0ZXh0QmJveC54LAogICAgICAgICAgICAgICAgeTogdGV4dEJib3gueSAtIHRleHRCYm94LmhlaWdodC8yLCAgLy8gVGFrZSBpbnRvIGFjY291bnQgdGhlIHktYWxpZ25tZW50IHRyYW5zbGF0aW9uLgogICAgICAgICAgICAgICAgd2lkdGg6IHRleHRCYm94LndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiB0ZXh0QmJveC5oZWlnaHQKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlclRvb2xzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9WLmxpbmtUb29scykgcmV0dXJuIHRoaXM7CgogICAgICAgIC8vIFRvb2xzIGFyZSBhIGdyb3VwIG9mIGNsaWNrYWJsZSBlbGVtZW50cyB0aGF0IG1hbmlwdWxhdGUgdGhlIHdob2xlIGxpbmsuCiAgICAgICAgLy8gQSBnb29kIGV4YW1wbGUgb2YgdGhpcyBpcyB0aGUgcmVtb3ZlIHRvb2wgdGhhdCByZW1vdmVzIHRoZSB3aG9sZSBsaW5rLgogICAgICAgIC8vIFRvb2xzIGFwcGVhciBhZnRlciBob3ZlcmluZyB0aGUgbGluayBjbG9zZSB0byB0aGUgYHNvdXJjZWAgZWxlbWVudC9wb2ludCBvZiB0aGUgbGluawogICAgICAgIC8vIGJ1dCBhcmUgb2Zmc2V0IGEgYml0IHNvIHRoYXQgdGhleSBkb24ndCBjb3ZlciB0aGUgYG1hcmtlci1hcnJvd2hlYWRgLgoKICAgICAgICB2YXIgJHRvb2xzID0gJCh0aGlzLl9WLmxpbmtUb29scy5ub2RlKS5lbXB0eSgpOwogICAgICAgIHZhciB0b29sVGVtcGxhdGUgPSBfLnRlbXBsYXRlKHRoaXMubW9kZWwuZ2V0KCd0b29sTWFya3VwJykgfHwgdGhpcy5tb2RlbC50b29sTWFya3VwKTsKICAgICAgICB2YXIgdG9vbCA9IFYodG9vbFRlbXBsYXRlKCkpOwoKICAgICAgICAkdG9vbHMuYXBwZW5kKHRvb2wubm9kZSk7CiAgICAgICAgCiAgICAgICAgLy8gQ2FjaGUgdGhlIHRvb2wgbm9kZSBzbyB0aGF0IHRoZSBgdXBkYXRlVG9vbHNQb3NpdGlvbigpYCBjYW4gdXBkYXRlIHRoZSB0b29sIHBvc2l0aW9uIHF1aWNrbHkuCiAgICAgICAgdGhpcy5fdG9vbENhY2hlID0gdG9vbDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlclZlcnRleE1hcmtlcnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubWFya2VyVmVydGljZXMpIHJldHVybiB0aGlzOwoKICAgICAgICB2YXIgJG1hcmtlclZlcnRpY2VzID0gJCh0aGlzLl9WLm1hcmtlclZlcnRpY2VzLm5vZGUpLmVtcHR5KCk7CgogICAgICAgIC8vIEEgc3BlY2lhbCBtYXJrdXAgY2FuIGJlIGdpdmVuIGluIHRoZSBgcHJvcGVydGllcy52ZXJ0ZXhNYXJrdXBgIHByb3BlcnR5LiBUaGlzIG1pZ2h0IGJlIGhhbmR5CiAgICAgICAgLy8gaWYgZGVmYXVsdCBzdHlsaW5nIChlbGVtZW50cykgYXJlIG5vdCBkZXNpcmVkLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIHVzZSBhbnkKICAgICAgICAvLyBTVkcgZWxlbWVudHMgZm9yIC5tYXJrZXItdmVydGV4IGFuZCAubWFya2VyLXZlcnRleC1yZW1vdmUgdG9vbHMuCiAgICAgICAgdmFyIG1hcmt1cFRlbXBsYXRlID0gXy50ZW1wbGF0ZSh0aGlzLm1vZGVsLmdldCgndmVydGV4TWFya3VwJykgfHwgdGhpcy5tb2RlbC52ZXJ0ZXhNYXJrdXApOwogICAgICAgIAogICAgICAgIF8uZWFjaCh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSwgZnVuY3Rpb24odmVydGV4LCBpZHgpIHsKCiAgICAgICAgICAgICRtYXJrZXJWZXJ0aWNlcy5hcHBlbmQoVihtYXJrdXBUZW1wbGF0ZShfLmV4dGVuZCh7IGlkeDogaWR4IH0sIHZlcnRleCkpKS5ub2RlKTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVuZGVyQXJyb3doZWFkTWFya2VyczogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIEN1c3RvbSBtYXJrdXBzIG1pZ2h0IG5vdCBoYXZlIGFycm93aGVhZCBtYXJrZXJzLiBUaGVyZWZvcmUsIGp1bXAgb2YgdGhpcyBmdW5jdGlvbiBpbW1lZGlhdGVseSBpZiB0aGF0J3MgdGhlIGNhc2UuCiAgICAgICAgaWYgKCF0aGlzLl9WLm1hcmtlckFycm93aGVhZHMpIHJldHVybiB0aGlzOwoKICAgICAgICB2YXIgJG1hcmtlckFycm93aGVhZHMgPSAkKHRoaXMuX1YubWFya2VyQXJyb3doZWFkcy5ub2RlKTsKCiAgICAgICAgJG1hcmtlckFycm93aGVhZHMuZW1wdHkoKTsKCiAgICAgICAgLy8gQSBzcGVjaWFsIG1hcmt1cCBjYW4gYmUgZ2l2ZW4gaW4gdGhlIGBwcm9wZXJ0aWVzLnZlcnRleE1hcmt1cGAgcHJvcGVydHkuIFRoaXMgbWlnaHQgYmUgaGFuZHkKICAgICAgICAvLyBpZiBkZWZhdWx0IHN0eWxpbmcgKGVsZW1lbnRzKSBhcmUgbm90IGRlc2lyZWQuIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gdXNlIGFueQogICAgICAgIC8vIFNWRyBlbGVtZW50cyBmb3IgLm1hcmtlci12ZXJ0ZXggYW5kIC5tYXJrZXItdmVydGV4LXJlbW92ZSB0b29scy4KICAgICAgICB2YXIgbWFya3VwVGVtcGxhdGUgPSBfLnRlbXBsYXRlKHRoaXMubW9kZWwuZ2V0KCdhcnJvd2hlYWRNYXJrdXAnKSB8fCB0aGlzLm1vZGVsLmFycm93aGVhZE1hcmt1cCk7CgogICAgICAgIHRoaXMuX1Yuc291cmNlQXJyb3doZWFkID0gVihtYXJrdXBUZW1wbGF0ZSh7IGVuZDogJ3NvdXJjZScgfSkpOwogICAgICAgIHRoaXMuX1YudGFyZ2V0QXJyb3doZWFkID0gVihtYXJrdXBUZW1wbGF0ZSh7IGVuZDogJ3RhcmdldCcgfSkpOwoKICAgICAgICAkbWFya2VyQXJyb3doZWFkcy5hcHBlbmQodGhpcy5fVi5zb3VyY2VBcnJvd2hlYWQubm9kZSwgdGhpcy5fVi50YXJnZXRBcnJvd2hlYWQubm9kZSk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBVcGRhdGluZwogICAgLy8tLS0tLS0tLS0KCiAgICAvLyBEZWZhdWx0IGlzIHRvIHByb2Nlc3MgdGhlIGBhdHRyc2Agb2JqZWN0IGFuZCBzZXQgYXR0cmlidXRlcyBvbiBzdWJlbGVtZW50cyBiYXNlZCBvbiB0aGUgc2VsZWN0b3JzLgogICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgLy8gVXBkYXRlIGF0dHJpYnV0ZXMuCiAgICAgICAgXy5lYWNoKHRoaXMubW9kZWwuZ2V0KCdhdHRycycpLCBmdW5jdGlvbihhdHRycywgc2VsZWN0b3IpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIHRoZSBgZmlsdGVyYCBhdHRyaWJ1dGUgaXMgYW4gb2JqZWN0LCBpdCBpcyBpbiB0aGUgc3BlY2lhbCBKb2ludEpTIGZpbHRlciBmb3JtYXQgYW5kIHNvCiAgICAgICAgICAgIC8vIGl0IGJlY29tZXMgYSBzcGVjaWFsIGF0dHJpYnV0ZSBhbmQgaXMgdHJlYXRlZCBzZXBhcmF0ZWx5LgogICAgICAgICAgICBpZiAoXy5pc09iamVjdChhdHRycy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZmluZEJ5U2VsZWN0b3Ioc2VsZWN0b3IpLmF0dHIoXy5vbWl0KGF0dHJzLCAnZmlsdGVyJykpOwogICAgICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcihzZWxlY3RvciwgYXR0cnMuZmlsdGVyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmZpbmRCeVNlbGVjdG9yKHNlbGVjdG9yKS5hdHRyKGF0dHJzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAvLyBQYXRoIGZpbmRpbmcKICAgICAgICB2YXIgdmVydGljZXMgPSB0aGlzLnJvdXRlID0gdGhpcy5maW5kUm91dGUodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwgW10pOwoKICAgICAgICAvLyBmaW5kcyBhbGwgdGhlIGNvbm5lY3Rpb24gcG9pbnRzIHRha2luZyBuZXcgdmVydGljZXMgaW50byBhY2NvdW50CiAgICAgICAgdGhpcy5fZmluZENvbm5lY3Rpb25Qb2ludHModmVydGljZXMpOwoKICAgICAgICB2YXIgcGF0aERhdGEgPSB0aGlzLmdldFBhdGhEYXRhKHZlcnRpY2VzKTsKCiAgICAgICAgLy8gVGhlIG1hcmt1cCBuZWVkcyB0byBjb250YWluIGEgYC5jb25uZWN0aW9uYAogICAgICAgIHRoaXMuX1YuY29ubmVjdGlvbi5hdHRyKCdkJywgcGF0aERhdGEpOwogICAgICAgIHRoaXMuX1YuY29ubmVjdGlvbldyYXAgJiYgdGhpcy5fVi5jb25uZWN0aW9uV3JhcC5hdHRyKCdkJywgcGF0aERhdGEpOwoKICAgICAgICB0aGlzLl90cmFuc2xhdGVBbmRBdXRvT3JpZW50QXJyb3dzKHRoaXMuX1YubWFya2VyU291cmNlLCB0aGlzLl9WLm1hcmtlclRhcmdldCk7CgogICAgICAgIC8vcGFydGlhbHMgdXBkYXRlcwogICAgICAgIHRoaXMudXBkYXRlTGFiZWxQb3NpdGlvbnMoKTsKICAgICAgICB0aGlzLnVwZGF0ZVRvb2xzUG9zaXRpb24oKTsKICAgICAgICB0aGlzLnVwZGF0ZUFycm93aGVhZE1hcmtlcnMoKTsKCiAgICAgICAgZGVsZXRlIHRoaXMub3B0aW9ucy5wZXJwZW5kaWN1bGFyOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgX2ZpbmRDb25uZWN0aW9uUG9pbnRzOiBmdW5jdGlvbih2ZXJ0aWNlcykgewoKICAgICAgICAvLyBjYWNoZSBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMKICAgICAgICB2YXIgc291cmNlUG9pbnQsIHRhcmdldFBvaW50LCBzb3VyY2VNYXJrZXJQb2ludCwgdGFyZ2V0TWFya2VyUG9pbnQ7CgogICAgICAgIHZhciBmaXJzdFZlcnRleCA9IF8uZmlyc3QodmVydGljZXMpOwoKICAgICAgICBzb3VyY2VQb2ludCA9IHRoaXMuZ2V0Q29ubmVjdGlvblBvaW50KAogICAgICAgICAgICAnc291cmNlJywgdGhpcy5tb2RlbC5nZXQoJ3NvdXJjZScpLCBmaXJzdFZlcnRleCB8fCB0aGlzLm1vZGVsLmdldCgndGFyZ2V0JykKICAgICAgICApLnJvdW5kKCk7CgogICAgICAgIHZhciBsYXN0VmVydGV4ID0gXy5sYXN0KHZlcnRpY2VzKTsKCiAgICAgICAgdGFyZ2V0UG9pbnQgPSB0aGlzLmdldENvbm5lY3Rpb25Qb2ludCgKICAgICAgICAgICAgJ3RhcmdldCcsIHRoaXMubW9kZWwuZ2V0KCd0YXJnZXQnKSwgbGFzdFZlcnRleCB8fCBzb3VyY2VQb2ludAogICAgICAgICkucm91bmQoKTsKCiAgICAgICAgLy8gTW92ZSB0aGUgc291cmNlIHBvaW50IGJ5IHRoZSB3aWR0aCBvZiB0aGUgbWFya2VyIHRha2luZyBpbnRvIGFjY291bnQKICAgICAgICAvLyBpdHMgc2NhbGUgYXJvdW5kIHgtYXhpcy4gTm90ZSB0aGF0IHNjYWxlIGlzIHRoZSBvbmx5IHRyYW5zZm9ybSB0aGF0CiAgICAgICAgLy8gbWFrZXMgc2Vuc2UgdG8gYmUgc2V0IGluIGAubWFya2VyLXNvdXJjZWAgYXR0cmlidXRlcyBvYmplY3QKICAgICAgICAvLyBhcyBhbGwgb3RoZXIgdHJhbnNmb3JtcyAodHJhbnNsYXRlL3JvdGF0ZSkgd2lsbCBiZSByZXBsYWNlZAogICAgICAgIC8vIGJ5IHRoZSBgdHJhbnNsYXRlQW5kQXV0b09yaWVudCgpYCBmdW5jdGlvbi4KICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLl9tYXJrZXJDYWNoZTsKCiAgICAgICAgaWYgKHRoaXMuX1YubWFya2VyU291cmNlKSB7CgogICAgICAgICAgICBjYWNoZS5zb3VyY2VCQm94ID0gY2FjaGUuc291cmNlQkJveCB8fCB0aGlzLl9WLm1hcmtlclNvdXJjZS5iYm94KHRydWUpOwoKICAgICAgICAgICAgc291cmNlTWFya2VyUG9pbnQgPSBnLnBvaW50KHNvdXJjZVBvaW50KS5tb3ZlKAogICAgICAgICAgICAgICAgZmlyc3RWZXJ0ZXggfHwgdGFyZ2V0UG9pbnQsCiAgICAgICAgICAgICAgICBjYWNoZS5zb3VyY2VCQm94LndpZHRoICogdGhpcy5fVi5tYXJrZXJTb3VyY2Uuc2NhbGUoKS5zeCAqIC0xCiAgICAgICAgICAgICkucm91bmQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9WLm1hcmtlclRhcmdldCkgewoKICAgICAgICAgICAgY2FjaGUudGFyZ2V0QkJveCA9IGNhY2hlLnRhcmdldEJCb3ggfHwgdGhpcy5fVi5tYXJrZXJUYXJnZXQuYmJveCh0cnVlKTsKCiAgICAgICAgICAgIHRhcmdldE1hcmtlclBvaW50ID0gZy5wb2ludCh0YXJnZXRQb2ludCkubW92ZSgKICAgICAgICAgICAgICAgIGxhc3RWZXJ0ZXggfHwgc291cmNlUG9pbnQsCiAgICAgICAgICAgICAgICBjYWNoZS50YXJnZXRCQm94LndpZHRoICogdGhpcy5fVi5tYXJrZXJUYXJnZXQuc2NhbGUoKS5zeCAqIC0xCiAgICAgICAgICAgICkucm91bmQoKTsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHRoZXJlIHdhcyBubyBtYXJrdXAgZm9yIHRoZSBtYXJrZXIsIHVzZSB0aGUgY29ubmVjdGlvbiBwb2ludC4KICAgICAgICBjYWNoZS5zb3VyY2VQb2ludCA9IHNvdXJjZU1hcmtlclBvaW50IHx8IHNvdXJjZVBvaW50OwogICAgICAgIGNhY2hlLnRhcmdldFBvaW50ID0gdGFyZ2V0TWFya2VyUG9pbnQgfHwgdGFyZ2V0UG9pbnQ7CgogICAgICAgIC8vIG1ha2UgY29ubmVjdGlvbiBwb2ludHMgcHVibGljCiAgICAgICAgdGhpcy5zb3VyY2VQb2ludCA9IHNvdXJjZVBvaW50OwogICAgICAgIHRoaXMudGFyZ2V0UG9pbnQgPSB0YXJnZXRQb2ludDsKICAgIH0sCgogICAgdXBkYXRlTGFiZWxQb3NpdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubGFiZWxzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gVGhpcyBtZXRob2QgYXNzdW1lcyBhbGwgdGhlIGxhYmVsIG5vZGVzIGFyZSBzdG9yZWQgaW4gdGhlIGB0aGlzLl9sYWJlbENhY2hlYCBoYXNoIHRhYmxlCiAgICAgICAgLy8gYnkgdGhlaXIgaW5kZXhlcyBpbiB0aGUgYHRoaXMuZ2V0KCdsYWJlbHMnKWAgYXJyYXkuIFRoaXMgaXMgZG9uZSBpbiB0aGUgYHJlbmRlckxhYmVscygpYCBtZXRob2QuCgogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLm1vZGVsLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgaWYgKCFsYWJlbHMubGVuZ3RoKSByZXR1cm4gdGhpczsKCiAgICAgICAgdmFyIGNvbm5lY3Rpb25FbGVtZW50ID0gdGhpcy5fVi5jb25uZWN0aW9uLm5vZGU7CiAgICAgICAgdmFyIGNvbm5lY3Rpb25MZW5ndGggPSBjb25uZWN0aW9uRWxlbWVudC5nZXRUb3RhbExlbmd0aCgpOwoKICAgICAgICBfLmVhY2gobGFiZWxzLCBmdW5jdGlvbihsYWJlbCwgaWR4KSB7CgogICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBsYWJlbC5wb3NpdGlvbjsKICAgICAgICAgICAgcG9zaXRpb24gPSAocG9zaXRpb24gPiBjb25uZWN0aW9uTGVuZ3RoKSA/IGNvbm5lY3Rpb25MZW5ndGggOiBwb3NpdGlvbjsgLy8gc2FuaXR5IGNoZWNrCiAgICAgICAgICAgIHBvc2l0aW9uID0gKHBvc2l0aW9uIDwgMCkgPyBjb25uZWN0aW9uTGVuZ3RoICsgcG9zaXRpb24gOiBwb3NpdGlvbjsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiA+IDEgPyBwb3NpdGlvbiA6IGNvbm5lY3Rpb25MZW5ndGggKiBwb3NpdGlvbjsKCiAgICAgICAgICAgIHZhciBsYWJlbENvb3JkaW5hdGVzID0gY29ubmVjdGlvbkVsZW1lbnQuZ2V0UG9pbnRBdExlbmd0aChwb3NpdGlvbik7CgogICAgICAgICAgICB0aGlzLl9sYWJlbENhY2hlW2lkeF0uYXR0cigndHJhbnNmb3JtJywgJ3RyYW5zbGF0ZSgnICsgbGFiZWxDb29yZGluYXRlcy54ICsgJywgJyArIGxhYmVsQ29vcmRpbmF0ZXMueSArICcpJyk7CgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIHVwZGF0ZVRvb2xzUG9zaXRpb246IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubGlua1Rvb2xzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gTW92ZSB0aGUgdG9vbHMgYSBiaXQgdG8gdGhlIHRhcmdldCBwb3NpdGlvbiBidXQgZG9uJ3QgY292ZXIgdGhlIGBzb3VyY2VBcnJvd2hlYWRgIG1hcmtlci4KICAgICAgICAvLyBOb3RlIHRoYXQgdGhlIG9mZnNldCBpcyBoYXJkY29kZWQgaGVyZS4gVGhlIG9mZnNldCBzaG91bGQgYmUgYWx3YXlzCiAgICAgICAgLy8gbW9yZSB0aGFuIHRoZSBgdGhpcy4kKCcubWFya2VyLWFycm93aGVhZFtlbmQ9InNvdXJjZSJdJylbMF0uYmJveCgpLndpZHRoYCBidXQgbG9va2luZwogICAgICAgIC8vIHRoaXMgdXAgYWxsIHRoZSB0aW1lIHdvdWxkIGJlIHNsb3cuCgogICAgICAgIHZhciBzY2FsZSA9ICcnOwogICAgICAgIHZhciBvZmZzZXQgPSA0MDsKCiAgICAgICAgLy8gSWYgdGhlIGxpbmsgaXMgdG9vIHNob3J0LCBtYWtlIHRoZSB0b29scyBoYWxmIHRoZSBzaXplIGFuZCB0aGUgb2Zmc2V0IHR3aWNlIGFzIGxvdy4KICAgICAgICBpZiAodGhpcy5nZXRDb25uZWN0aW9uTGVuZ3RoKCkgPCB0aGlzLm9wdGlvbnMuc2hvcnRMaW5rTGVuZ3RoKSB7CiAgICAgICAgICAgIHNjYWxlID0gJ3NjYWxlKC41KSc7CiAgICAgICAgICAgIG9mZnNldCAvPSAyOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvb2xQb3NpdGlvbiA9IHRoaXMuZ2V0UG9pbnRBdExlbmd0aChvZmZzZXQpOwogICAgICAgIAogICAgICAgIHRoaXMuX3Rvb2xDYWNoZS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyB0b29sUG9zaXRpb24ueCArICcsICcgKyB0b29sUG9zaXRpb24ueSArICcpICcgKyBzY2FsZSk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgdXBkYXRlQXJyb3doZWFkTWFya2VyczogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICghdGhpcy5fVi5tYXJrZXJBcnJvd2hlYWRzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gZ2V0dGluZyBiYm94IG9mIGFuIGVsZW1lbnQgd2l0aCBgZGlzcGxheT0ibm9uZSJgIGluIElFOSBlbmRzIHVwIHdpdGggYWNjZXNzIHZpb2xhdGlvbgogICAgICAgIGlmICgkLmNzcyh0aGlzLl9WLm1hcmtlckFycm93aGVhZHMubm9kZSwgJ2Rpc3BsYXknKSA9PT0gJ25vbmUnKSByZXR1cm4gdGhpczsKCiAgICAgICAgdmFyIHN4ID0gdGhpcy5nZXRDb25uZWN0aW9uTGVuZ3RoKCkgPCB0aGlzLm9wdGlvbnMuc2hvcnRMaW5rTGVuZ3RoID8gLjUgOiAxOwogICAgICAgIHRoaXMuX1Yuc291cmNlQXJyb3doZWFkLnNjYWxlKHN4KTsKICAgICAgICB0aGlzLl9WLnRhcmdldEFycm93aGVhZC5zY2FsZShzeCk7CgogICAgICAgIHRoaXMuX3RyYW5zbGF0ZUFuZEF1dG9PcmllbnRBcnJvd3ModGhpcy5fVi5zb3VyY2VBcnJvd2hlYWQsIHRoaXMuX1YudGFyZ2V0QXJyb3doZWFkKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJldHVybnMgYSBmdW5jdGlvbiBvYnNlcnZpbmcgY2hhbmdlcyBvbiBhbiBlbmQgb2YgdGhlIGxpbmsuIElmIGEgY2hhbmdlIGhhcHBlbnMgYW5kIG5ldyBlbmQgaXMgYSBuZXcgbW9kZWwsCiAgICAvLyBpdCBzdG9wcyBsaXN0ZW5pbmcgb24gdGhlIHByZXZpb3VzIG9uZSBhbmQgc3RhcnRzIGxpc3RlbmluZyB0byB0aGUgbmV3IG9uZS4KICAgIF9jcmVhdGVXYXRjaGVyOiBmdW5jdGlvbihlbmRUeXBlKSB7CgogICAgICAgIGZ1bmN0aW9uIHdhdGNoRW5kKGxpbmssIGVuZCkgewoKICAgICAgICAgICAgZW5kID0gZW5kIHx8IHt9OwoKICAgICAgICAgICAgdmFyIHByZXZpb3VzRW5kID0gbGluay5wcmV2aW91cyhlbmRUeXBlKSB8fCB7fTsKCiAgICAgICAgICAgIC8vIFBpY2sgdXBkYXRlTWV0aG9kIHRoaXMuX3NvdXJjZUJib3hVcGRhdGUgb3IgdGhpcy5fdGFyZ2V0QmJveFVwZGF0ZS4KICAgICAgICAgICAgdmFyIHVwZGF0ZUVuZEZ1bmN0aW9uID0gdGhpc1snXycgKyBlbmRUeXBlICsgJ0JCb3hVcGRhdGUnXTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9pc01vZGVsKHByZXZpb3VzRW5kKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHRoaXMucGFwZXIuZ2V0TW9kZWxCeUlkKHByZXZpb3VzRW5kLmlkKSwgJ2NoYW5nZScsIHVwZGF0ZUVuZEZ1bmN0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2lzTW9kZWwoZW5kKSkgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIG9ic2VydmVkIG1vZGVsIGNoYW5nZXMsIGl0IGNhY2hlcyBhIG5ldyBiYm94IGFuZCBkbyB0aGUgbGluayB1cGRhdGUuCiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMucGFwZXIuZ2V0TW9kZWxCeUlkKGVuZC5pZCksICdjaGFuZ2UnLCB1cGRhdGVFbmRGdW5jdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF8uYmluZCh1cGRhdGVFbmRGdW5jdGlvbiwgdGhpcykoeyBjYWNoZU9ubHk6IHRydWUgfSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHJldHVybiB3YXRjaEVuZDsKICAgIH0sCgogICAgLy8gSXQncyBpbXBvcnRhbnQgdG8ga2VlcCBib3RoIG1ldGhvZHMgKHNvdXJjZUJib3hVcGRhdGUgYW5kIHRhcmdldEJib3hVcGRhdGUpIGFzIHVuaXF1ZSBtZXRob2RzCiAgICAvLyBiZWNhdXNlIG9mIGxvb3AgbGlua3MuIFdlIGhhdmUgdG8gYmUgYWJsZSB0byBkZXRlcm1pbmUsIHdoaWNoIG1ldGhvZCB3ZSB3YW50IHRvIHN0b3AgbGlzdGVuIHRvLgogICAgLy8gTGlzdGVuVG8obW9kZWwsIGV2ZW50LCBoYW5kbGVyKSBhcyBtb2RlbCBhbmQgZXZlbnQgd2lsbCBiZSBpZGVudGljYWwuCiAgICBfc291cmNlQkJveFVwZGF0ZTogZnVuY3Rpb24odXBkYXRlKSB7CgogICAgICAgIC8vIGtlZXAgdHJhY2sgd2hpY2ggZW5kIGhhZCBiZWVuIGNoYW5nZWQgdmVyeSBsYXN0CiAgICAgICAgdGhpcy5sYXN0RW5kQ2hhbmdlID0gJ3NvdXJjZSc7CgogICAgICAgIHVwZGF0ZSA9IHVwZGF0ZSB8fCB7fTsKICAgICAgICB2YXIgZW5kID0gdGhpcy5tb2RlbC5nZXQoJ3NvdXJjZScpOwoKICAgICAgICBpZiAodGhpcy5faXNNb2RlbChlbmQpKSB7CgogICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSB0aGlzLl9tYWtlU2VsZWN0b3IoZW5kKTsKICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnBhcGVyLmZpbmRWaWV3QnlNb2RlbChlbmQuaWQpOwogICAgICAgICAgICB2YXIgbWFnbmV0RWxlbWVudCA9IHRoaXMucGFwZXIudmlld3BvcnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CgogICAgICAgICAgICB0aGlzLnNvdXJjZUJCb3ggPSB2aWV3LmdldFN0cm9rZUJCb3gobWFnbmV0RWxlbWVudCk7CgkgICAgdGhpcy5zb3VyY2VWaWV3ID0gdmlldzsKCSAgICB0aGlzLnNvdXJjZU1hZ25ldCA9IG1hZ25ldEVsZW1lbnQ7CgogICAgICAgIH0gZWxzZSBpZiAoZW5kKSB7CiAgICAgICAgICAgIC8vIHRoZSBsaW5rIGVuZCBpcyBhIHBvaW50IH4gcmVjdCAxeDEKICAgICAgICAgICAgdGhpcy5zb3VyY2VCQm94ID0gZy5yZWN0KGVuZC54LCBlbmQueSwgMSwgMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXVwZGF0ZS5jYWNoZU9ubHkpIHRoaXMudXBkYXRlKCk7CiAgICB9LAoKICAgIF90YXJnZXRCQm94VXBkYXRlOiBmdW5jdGlvbih1cGRhdGUpIHsKCiAgICAgICAgLy8ga2VlcCB0cmFjayB3aGljaCBlbmQgaGFkIGJlZW4gY2hhbmdlZCB2ZXJ5IGxhc3QKICAgICAgICB0aGlzLmxhc3RFbmRDaGFuZ2UgPSAndGFyZ2V0JzsKCiAgICAgICAgdXBkYXRlID0gdXBkYXRlIHx8IHt9OwogICAgICAgIHZhciBlbmQgPSB0aGlzLm1vZGVsLmdldCgndGFyZ2V0Jyk7CgogICAgICAgIGlmICh0aGlzLl9pc01vZGVsKGVuZCkpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3RvciA9IHRoaXMuX21ha2VTZWxlY3RvcihlbmQpOwogICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMucGFwZXIuZmluZFZpZXdCeU1vZGVsKGVuZC5pZCk7CiAgICAgICAgICAgIHZhciBtYWduZXRFbGVtZW50ID0gdGhpcy5wYXBlci52aWV3cG9ydC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKCiAgICAgICAgICAgIHRoaXMudGFyZ2V0QkJveCA9IHZpZXcuZ2V0U3Ryb2tlQkJveChtYWduZXRFbGVtZW50KTsKCSAgICB0aGlzLnRhcmdldFZpZXcgPSB2aWV3OwoJICAgIHRoaXMudGFyZ2V0TWFnbmV0ID0gbWFnbmV0RWxlbWVudDsKCiAgICAgICAgfSBlbHNlIGlmIChlbmQpIHsKICAgICAgICAgICAgLy8gdGhlIGxpbmsgZW5kIGlzIGEgcG9pbnQgfiByZWN0IDF4MQogICAgICAgICAgICB0aGlzLnRhcmdldEJCb3ggPSBnLnJlY3QoZW5kLngsIGVuZC55LCAxLCAxKTsKICAgICAgICB9CgogICAgICAgIGlmICghdXBkYXRlLmNhY2hlT25seSkgdGhpcy51cGRhdGUoKTsKICAgIH0sCgogICAgX3RyYW5zbGF0ZUFuZEF1dG9PcmllbnRBcnJvd3M6IGZ1bmN0aW9uKHNvdXJjZUFycm93LCB0YXJnZXRBcnJvdykgewoKICAgICAgICAvLyBNYWtlIHRoZSBtYXJrZXJzICJwb2ludCIgdG8gdGhlaXIgc3RpY2t5IHBvaW50cyBiZWluZyBhdXRvLW9yaWVudGVkIHRvd2FyZHMKICAgICAgICAvLyBgdGFyZ2V0UG9zaXRpb25gL2Bzb3VyY2VQb3NpdGlvbmAuIEFuZCBkbyBzbyBvbmx5IGlmIHRoZXJlIGlzIGEgbWFya3VwIGZvciB0aGVtLgogICAgICAgIGlmIChzb3VyY2VBcnJvdykgewogICAgICAgICAgICBzb3VyY2VBcnJvdy50cmFuc2xhdGVBbmRBdXRvT3JpZW50KAogICAgICAgICAgICAgICAgdGhpcy5zb3VyY2VQb2ludCwKICAgICAgICAgICAgICAgIF8uZmlyc3QodGhpcy5yb3V0ZSkgfHwgdGhpcy50YXJnZXRQb2ludCwKICAgICAgICAgICAgICAgIHRoaXMucGFwZXIudmlld3BvcnQKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YXJnZXRBcnJvdykgewogICAgICAgICAgICB0YXJnZXRBcnJvdy50cmFuc2xhdGVBbmRBdXRvT3JpZW50KAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRQb2ludCwKICAgICAgICAgICAgICAgIF8ubGFzdCh0aGlzLnJvdXRlKSB8fCB0aGlzLnNvdXJjZVBvaW50LAogICAgICAgICAgICAgICAgdGhpcy5wYXBlci52aWV3cG9ydAogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH0sCgogICAgcmVtb3ZlVmVydGV4OiBmdW5jdGlvbihpZHgpIHsKCiAgICAgICAgdmFyIHZlcnRpY2VzID0gXy5jbG9uZSh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSk7CiAgICAgICAgCiAgICAgICAgaWYgKHZlcnRpY2VzICYmIHZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICAgICAgdmVydGljZXMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCd2ZXJ0aWNlcycsIHZlcnRpY2VzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUaGlzIG1ldGhvZCBhZHMgYSBuZXcgdmVydGV4IHRvIHRoZSBgdmVydGljZXNgIGFycmF5IG9mIGAuY29ubmVjdGlvbmAuIFRoaXMgbWV0aG9kCiAgICAvLyB1c2VzIGEgaGV1cmlzdGljIHRvIGZpbmQgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBuZXcgYHZlcnRleGAgc2hvdWxkIGJlIHBsYWNlZCBhdCBhc3N1bWluZwogICAgLy8gdGhlIG5ldyB2ZXJ0ZXggaXMgc29tZXdoZXJlIG9uIHRoZSBwYXRoLgogICAgYWRkVmVydGV4OiBmdW5jdGlvbih2ZXJ0ZXgpIHsKCiAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ2F0dHJzJywgdGhpcy5tb2RlbC5nZXQoJ2F0dHJzJykgfHwge30pOwogICAgICAgIHZhciBhdHRycyA9IHRoaXMubW9kZWwuZ2V0KCdhdHRycycpOwogICAgICAgIAogICAgICAgIC8vIEFzIGl0IGlzIHZlcnkgaGFyZCB0byBmaW5kIGEgY29ycmVjdCBpbmRleCBvZiB0aGUgbmV3bHkgY3JlYXRlZCB2ZXJ0ZXgsCiAgICAgICAgLy8gYSBsaXR0bGUgaGV1cmlzdGljcyBpcyB0YWtpbmcgcGxhY2UgaGVyZS4KICAgICAgICAvLyBUaGUgaGV1cmlzdGljcyBjaGVja3MgaWYgbGVuZ3RoIG9mIHRoZSBuZXdseSBjcmVhdGVkCiAgICAgICAgLy8gcGF0aCBpcyBsb3QgbW9yZSB0aGFuIGxlbmd0aCBvZiB0aGUgb2xkIHBhdGguIElmIHRoaXMgaXMgdGhlIGNhc2UsCiAgICAgICAgLy8gbmV3IHZlcnRleCB3YXMgcHJvYmFibHkgcHV0IGludG8gYSB3cm9uZyBpbmRleC4KICAgICAgICAvLyBUcnkgdG8gcHV0IGl0IGludG8gYW5vdGhlciBpbmRleCBhbmQgcmVwZWF0IHRoZSBoZXVyaXN0aWNzIGFnYWluLgoKICAgICAgICB2YXIgdmVydGljZXMgPSAodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgLy8gU3RvcmUgdGhlIG9yaWdpbmFsIHZlcnRpY2VzIGZvciBhIGxhdGVyIHJldmVydCBpZiBuZWVkZWQuCiAgICAgICAgdmFyIG9yaWdpbmFsVmVydGljZXMgPSB2ZXJ0aWNlcy5zbGljZSgpOwoKICAgICAgICAvLyBBIGA8cGF0aD5gIGVsZW1lbnQgdXNlZCB0byBjb21wdXRlIHRoZSBsZW5ndGggb2YgdGhlIHBhdGggZHVyaW5nIGhldXJpc3RpY3MuCiAgICAgICAgdmFyIHBhdGggPSB0aGlzLl9WLmNvbm5lY3Rpb24ubm9kZS5jbG9uZU5vZGUoZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIExlbmd0aCBvZiB0aGUgb3JpZ2luYWwgcGF0aC4gICAgICAgIAogICAgICAgIHZhciBvcmlnaW5hbFBhdGhMZW5ndGggPSBwYXRoLmdldFRvdGFsTGVuZ3RoKCk7CiAgICAgICAgLy8gQ3VycmVudCBwYXRoIGxlbmd0aC4KICAgICAgICB2YXIgcGF0aExlbmd0aDsKICAgICAgICAvLyBUb2xlcmFuY2UgZGV0ZXJtaW5lcyB0aGUgaGlnaGVzdCBwb3NzaWJsZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGxlbmd0aAogICAgICAgIC8vIG9mIHRoZSBvbGQgYW5kIG5ldyBwYXRoLiBUaGUgbnVtYmVyIGhhcyBiZWVuIGNob3NlbiBoZXVyaXN0aWNhbGx5LgogICAgICAgIHZhciBwYXRoTGVuZ3RoVG9sZXJhbmNlID0gMjA7CiAgICAgICAgLy8gVG90YWwgbnVtYmVyIG9mIHZlcnRpY2VzIGluY2x1ZGluZyBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMuCiAgICAgICAgdmFyIGlkeCA9IHZlcnRpY2VzLmxlbmd0aCArIDE7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgcG9zc2libGUgaW5kZXhlcyBhbmQgY2hlY2sgaWYgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbgogICAgICAgIC8vIHBhdGggbGVuZ3RocyBjaGFuZ2VzIHNpZ25pZmljYW50bHkuIElmIG5vdCwgdGhlIGZvdW5kIGluZGV4IGlzCiAgICAgICAgLy8gbW9zdCBwcm9iYWJseSB0aGUgcmlnaHQgb25lLgogICAgICAgIHdoaWxlIChpZHgtLSkgewoKICAgICAgICAgICAgdmVydGljZXMuc3BsaWNlKGlkeCwgMCwgdmVydGV4KTsKICAgICAgICAgICAgVihwYXRoKS5hdHRyKCdkJywgdGhpcy5nZXRQYXRoRGF0YSh0aGlzLmZpbmRSb3V0ZSh2ZXJ0aWNlcykpKTsKCiAgICAgICAgICAgIHBhdGhMZW5ndGggPSBwYXRoLmdldFRvdGFsTGVuZ3RoKCk7CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGF0aCBsZW5ndGhzIGNoYW5nZWQgc2lnbmlmaWNhbnRseS4KICAgICAgICAgICAgaWYgKHBhdGhMZW5ndGggLSBvcmlnaW5hbFBhdGhMZW5ndGggPiBwYXRoTGVuZ3RoVG9sZXJhbmNlKSB7CgogICAgICAgICAgICAgICAgLy8gUmV2ZXJ0IHZlcnRpY2VzIHRvIHRoZSBvcmlnaW5hbCBhcnJheS4gVGhlIHBhdGggbGVuZ3RoIGhhcyBjaGFuZ2VkIHRvbyBtdWNoCiAgICAgICAgICAgICAgICAvLyBzbyB0aGF0IHRoZSBpbmRleCB3YXMgbm90IGZvdW5kIHlldC4KICAgICAgICAgICAgICAgIHZlcnRpY2VzID0gb3JpZ2luYWxWZXJ0aWNlcy5zbGljZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMubW9kZWwuc2V0KCd2ZXJ0aWNlcycsIHZlcnRpY2VzKTsKCiAgICAgICAgLy8gSW4gbWFuaGF0dGFuIHJvdXRpbmcsIGlmIHRoZXJlIGFyZSBubyB2ZXJ0aWNlcywgdGhlIHBhdGggbGVuZ3RoIGNoYW5nZXMgc2lnbmlmaWNhbnRseQogICAgICAgIC8vIHdpdGggdGhlIGZpcnN0IHZlcnRleCBhZGRlZC4gU2hhbGwgd2UgY2hlY2sgdmVydGljZXMubGVuZ3RoID09PSAwPyBhdCBiZWdpbm5pbmcgb2YgYWRkVmVydGV4KCkKICAgICAgICAvLyBpbiBvcmRlciB0byBhdm9pZCB0aGUgdGVtcG9yYXJ5IHBhdGggY29uc3RydWN0aW9uIGFuZCBvdGhlciBvcGVyYXRpb25zPwogICAgICAgIHJldHVybiBNYXRoLm1heChpZHgsIDApOwogICAgfSwKCiAgICAvLyBTZW5kIGEgdG9rZW4gKGFuIFNWRyBlbGVtZW50LCB1c3VhbGx5IGEgY2lyY2xlKSBhbG9uZyB0aGUgY29ubmVjdGlvbiBwYXRoLgogICAgLy8gRXhhbXBsZTogYHBhcGVyLmZpbmRWaWV3QnlNb2RlbChsaW5rKS5zZW5kVG9rZW4oVignY2lyY2xlJywgeyByOiA3LCBmaWxsOiAnZ3JlZW4nIH0pLm5vZGUpYAogICAgLy8gYGR1cmF0aW9uYCBpcyBvcHRpb25hbCBhbmQgaXMgYSB0aW1lIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSB0b2tlbiB0cmF2ZWxzIGZyb20gdGhlIHNvdXJjZSB0byB0aGUgdGFyZ2V0IG9mIHRoZSBsaW5rLiBEZWZhdWx0IGlzIGAxMDAwYC4KICAgIC8vIGBjYWxsYmFja2AgaXMgb3B0aW9uYWwgYW5kIGlzIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uY2UgdGhlIHRva2VuIHJlYWNoZXMgdGhlIHRhcmdldC4KICAgIHNlbmRUb2tlbjogZnVuY3Rpb24odG9rZW4sIGR1cmF0aW9uLCBjYWxsYmFjaykgewoKCWR1cmF0aW9uID0gZHVyYXRpb24gfHwgMTAwMDsKCglWKHRoaXMucGFwZXIudmlld3BvcnQpLmFwcGVuZCh0b2tlbik7CglWKHRva2VuKS5hbmltYXRlQWxvbmdQYXRoKHsgZHVyOiBkdXJhdGlvbiArICdtcycsIHJlcGVhdENvdW50OiAxIH0sIHRoaXMuX1YuY29ubmVjdGlvbi5ub2RlKTsKCV8uZGVsYXkoZnVuY3Rpb24oKSB7IFYodG9rZW4pLnJlbW92ZSgpOyBjYWxsYmFjayAmJiBjYWxsYmFjaygpOyB9LCBkdXJhdGlvbik7CiAgICB9LAoKICAgIGZpbmRSb3V0ZTogZnVuY3Rpb24ob2xkVmVydGljZXMpIHsKCiAgICAgICAgdmFyIHJvdXRlciA9IHRoaXMubW9kZWwuZ2V0KCdyb3V0ZXInKTsKCiAgICAgICAgaWYgKCFyb3V0ZXIpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnbWFuaGF0dGFuJykpIHsKICAgICAgICAgICAgICAgIC8vIGJhY2t3YXJkcyBjb21wYWJpbGl0eQogICAgICAgICAgICAgICAgcm91dGVyID0geyBuYW1lOiAnb3J0aG9nb25hbCcgfTsKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gb2xkVmVydGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBmbiA9IGpvaW50LnJvdXRlcnNbcm91dGVyLm5hbWVdOwoKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihmbikpIHsKCiAgICAgICAgICAgIHRocm93ICd1bmtub3duIHJvdXRlcjogJyArIHJvdXRlci5uYW1lOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1ZlcnRpY2VzID0gZm4uY2FsbCh0aGlzLCBvbGRWZXJ0aWNlcyB8fCBbXSwgcm91dGVyLmFyZ3MgfHwge30sIHRoaXMpOwoKICAgICAgICByZXR1cm4gbmV3VmVydGljZXM7CiAgICB9LAoKICAgIC8vIFJldHVybiB0aGUgYGRgIGF0dHJpYnV0ZSB2YWx1ZSBvZiB0aGUgYDxwYXRoPmAgZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGxpbmsKICAgIC8vIGJldHdlZW4gYHNvdXJjZWAgYW5kIGB0YXJnZXRgLgogICAgZ2V0UGF0aERhdGE6IGZ1bmN0aW9uKHZlcnRpY2VzKSB7CgogICAgICAgIHZhciBjb25uZWN0b3IgPSB0aGlzLm1vZGVsLmdldCgnY29ubmVjdG9yJyk7CgogICAgICAgIGlmICghY29ubmVjdG9yKSB7CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGFiaWxpdHkKICAgICAgICAgICAgY29ubmVjdG9yID0gdGhpcy5tb2RlbC5nZXQoJ3Ntb290aCcpID8geyBuYW1lOiAnc21vb3RoJyB9IDogeyBuYW1lOiAnbm9ybWFsJyB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oam9pbnQuY29ubmVjdG9yc1tjb25uZWN0b3IubmFtZV0pKSB7CgogICAgICAgICAgICB0aHJvdyAndW5rbm93biBjb25uZWN0b3I6ICcgKyBjb25uZWN0b3IubmFtZTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoRGF0YSA9IGpvaW50LmNvbm5lY3RvcnNbY29ubmVjdG9yLm5hbWVdLmNhbGwoCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIHRoaXMuX21hcmtlckNhY2hlLnNvdXJjZVBvaW50LCAvLyBOb3RlIHRoYXQgdGhlIHZhbHVlIGlzIHRyYW5zbGF0ZWQgYnkgdGhlIHNpemUKICAgICAgICAgICAgdGhpcy5fbWFya2VyQ2FjaGUudGFyZ2V0UG9pbnQsIC8vIG9mIHRoZSBtYXJrZXIuIChXZSdyIG5vdCB1c2luZyB0aGlzLnNvdXJjZVBvaW50KQogICAgICAgICAgICB2ZXJ0aWNlcyB8fCAodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwge30pLAogICAgICAgICAgICBjb25uZWN0b3IuYXJncyB8fCB7fSwgLy8gb3B0aW9ucwogICAgICAgICAgICB0aGlzCiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHBhdGhEYXRhOwogICAgfSwKCiAgICAvLyBGaW5kIGEgcG9pbnQgdGhhdCBpcyB0aGUgc3RhcnQgb2YgdGhlIGNvbm5lY3Rpb24uCiAgICAvLyBJZiBgc2VsZWN0b3JPclBvaW50YCBpcyBhIHBvaW50LCB0aGVuIHdlJ3JlIGRvbmUgYW5kIHRoYXQgcG9pbnQgaXMgdGhlIHN0YXJ0IG9mIHRoZSBjb25uZWN0aW9uLgogICAgLy8gSWYgdGhlIGBzZWxlY3Rvck9yUG9pbnRgIGlzIGFuIGVsZW1lbnQgaG93ZXZlciwgd2UgbmVlZCB0byBrbm93IGEgcmVmZXJlbmNlIHBvaW50IChvciBlbGVtZW50KQogICAgLy8gdGhhdCB0aGUgbGluayBsZWFkcyB0byBpbiBvcmRlciB0byBkZXRlcm1pbmUgdGhlIHN0YXJ0IG9mIHRoZSBjb25uZWN0aW9uIG9uIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogICAgZ2V0Q29ubmVjdGlvblBvaW50OiBmdW5jdGlvbihlbmQsIHNlbGVjdG9yT3JQb2ludCwgcmVmZXJlbmNlU2VsZWN0b3JPclBvaW50KSB7CgogICAgICAgIHZhciBzcG90OwoKICAgICAgICAvLyBJZiB0aGUgYHNlbGVjdG9yT3JQb2ludGAgKG9yIGByZWZlcmVuY2VTZWxlY3Rvck9yUG9pbnRgKSBpcyBgdW5kZWZpbmVkYCwgdGhlIGBzb3VyY2VgL2B0YXJnZXRgIG9mIHRoZSBsaW5rIG1vZGVsIGlzIGB1bmRlZmluZWRgLgogICAgICAgIC8vIFdlIHdhbnQgdG8gYWxsb3cgdGhpcyBob3dldmVyIHNvIHRoYXQgb25lIGNhbiBjcmVhdGUgbGlua3Mgc3VjaCBhcyBgdmFyIGxpbmsgPSBuZXcgam9pbnQuZGlhLkxpbmtgIGFuZAogICAgICAgIC8vIHNldCB0aGUgYHNvdXJjZWAvYHRhcmdldGAgbGF0ZXIuCiAgICAgICAgc2VsZWN0b3JPclBvaW50ID0gc2VsZWN0b3JPclBvaW50IHx8IHsgeDogMCwgeTogMCB9OwogICAgICAgIHJlZmVyZW5jZVNlbGVjdG9yT3JQb2ludCA9IHJlZmVyZW5jZVNlbGVjdG9yT3JQb2ludCB8fCB7IHg6IDAsIHk6IDAgfTsKCiAgICAgICAgaWYgKHRoaXMuX2lzUG9pbnQoc2VsZWN0b3JPclBvaW50KSkgewoKICAgICAgICAgICAgLy8gSWYgdGhlIHNvdXJjZSBpcyBhIHBvaW50LCB3ZSBkb24ndCBuZWVkIGEgcmVmZXJlbmNlIHBvaW50IHRvIGZpbmQgdGhlIHN0aWNreSBwb2ludCBvZiBjb25uZWN0aW9uLgogICAgICAgICAgICBzcG90ID0gZy5wb2ludChzZWxlY3Rvck9yUG9pbnQpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy8gSWYgdGhlIHNvdXJjZSBpcyBhbiBlbGVtZW50LCB3ZSBuZWVkIHRvIGZpbmQgYSBwb2ludCBvbiB0aGUgZWxlbWVudCBib3VuZGFyeSB0aGF0IGlzIGNsb3Nlc3QKICAgICAgICAgICAgLy8gdG8gdGhlIHJlZmVyZW5jZSBwb2ludCAob3IgcmVmZXJlbmNlIGVsZW1lbnQpLgogICAgICAgICAgICAvLyBHZXQgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgc3BvdCByZWxhdGl2ZSB0byB0aGUgcGFwZXIgdmlld3BvcnQuIFRoaXMgaXMgbmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGZvbGxvdyBwYXBlciB2aWV3cG9ydCB0cmFuc2Zvcm1hdGlvbnMgKHNjYWxlL3JvdGF0ZSkuCiAgICAgICAgICAgIC8vIGBfc291cmNlQmJveGAgKGBfdGFyZ2V0QmJveGApIGNvbWVzIGZyb20gYF9zb3VyY2VCYm94VXBkYXRlYCAoYF9zb3VyY2VCYm94VXBkYXRlYCkKICAgICAgICAgICAgLy8gbWV0aG9kLCBpdCBleGlzdHMgc2luY2UgZmlyc3QgcmVuZGVyIGFuZCBhcmUgYXV0b21hdGljYWxseSB1cGRhdGVkCiAgICAgICAgICAgIHZhciBzcG90QmJveCA9IGVuZCA9PT0gJ3NvdXJjZScgPyB0aGlzLnNvdXJjZUJCb3ggOiB0aGlzLnRhcmdldEJCb3g7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcmVmZXJlbmNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuX2lzUG9pbnQocmVmZXJlbmNlU2VsZWN0b3JPclBvaW50KSkgewoKICAgICAgICAgICAgICAgIC8vIFJlZmVyZW5jZSB3YXMgcGFzc2VkIGFzIGEgcG9pbnQsIHRoZXJlZm9yZSwgd2UncmUgcmVhZHkgdG8gZmluZCB0aGUgc3RpY2t5IHBvaW50IG9mIGNvbm5lY3Rpb24gb24gdGhlIHNvdXJjZSBlbGVtZW50LgogICAgICAgICAgICAgICAgcmVmZXJlbmNlID0gZy5wb2ludChyZWZlcmVuY2VTZWxlY3Rvck9yUG9pbnQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBSZWZlcmVuY2Ugd2FzIHBhc3NlZCBhcyBhbiBlbGVtZW50LCB0aGVyZWZvcmUgd2UgbmVlZCB0byBmaW5kIGEgcG9pbnQgb24gdGhlIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgLy8gZWxlbWVudCBib3VuZGFyeSBjbG9zZXN0IHRvIHRoZSBzb3VyY2UgZWxlbWVudC4KICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgYm91bmRpbmcgYm94IG9mIHRoZSBzcG90IHJlbGF0aXZlIHRvIHRoZSBwYXBlciB2aWV3cG9ydC4gVGhpcyBpcyBuZWNlc3NhcnkKICAgICAgICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGZvbGxvdyBwYXBlciB2aWV3cG9ydCB0cmFuc2Zvcm1hdGlvbnMgKHNjYWxlL3JvdGF0ZSkuCiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlQmJveCA9IGVuZCA9PT0gJ3NvdXJjZScgPyB0aGlzLnRhcmdldEJCb3ggOiB0aGlzLnNvdXJjZUJCb3g7CgogICAgICAgICAgICAgICAgcmVmZXJlbmNlID0gZy5yZWN0KHJlZmVyZW5jZUJib3gpLmludGVyc2VjdGlvbldpdGhMaW5lRnJvbUNlbnRlclRvUG9pbnQoZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKSk7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UgPSByZWZlcmVuY2UgfHwgZy5yZWN0KHJlZmVyZW5jZUJib3gpLmNlbnRlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiBgcGVycGVuZGljdWxhckxpbmtzYCBmbGFnIGlzIHNldCBvbiB0aGUgcGFwZXIgYW5kIHRoZXJlIGFyZSB2ZXJ0aWNlcwogICAgICAgICAgICAvLyBvbiB0aGUgbGluaywgdGhlbiB0cnkgdG8gZmluZCBhIGNvbm5lY3Rpb24gcG9pbnQgdGhhdCBtYWtlcyB0aGUgbGluayBwZXJwZW5kaWN1bGFyCiAgICAgICAgICAgIC8vIGV2ZW4gdGhvdWdoIHRoZSBsaW5rIHdvbid0IHBvaW50IHRvIHRoZSBjZW50ZXIgb2YgdGhlIHRhcmdldGVkIG9iamVjdC4KICAgICAgICAgICAgaWYgKHRoaXMucGFwZXIub3B0aW9ucy5wZXJwZW5kaWN1bGFyTGlua3MgfHwgdGhpcy5vcHRpb25zLnBlcnBlbmRpY3VsYXIpIHsKCiAgICAgICAgICAgICAgICB2YXIgaG9yaXpvbnRhbExpbmVSZWN0ID0gZy5yZWN0KDAsIHJlZmVyZW5jZS55LCB0aGlzLnBhcGVyLm9wdGlvbnMud2lkdGgsIDEpOwogICAgICAgICAgICAgICAgdmFyIHZlcnRpY2FsTGluZVJlY3QgPSBnLnJlY3QocmVmZXJlbmNlLngsIDAsIDEsIHRoaXMucGFwZXIub3B0aW9ucy5oZWlnaHQpOwogICAgICAgICAgICAgICAgdmFyIG5lYXJlc3RTaWRlOwoKICAgICAgICAgICAgICAgIGlmIChob3Jpem9udGFsTGluZVJlY3QuaW50ZXJzZWN0KGcucmVjdChzcG90QmJveCkpKSB7CgogICAgICAgICAgICAgICAgICAgIG5lYXJlc3RTaWRlID0gZy5yZWN0KHNwb3RCYm94KS5zaWRlTmVhcmVzdFRvUG9pbnQocmVmZXJlbmNlKTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG5lYXJlc3RTaWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQoc3BvdEJib3gueCwgcmVmZXJlbmNlLnkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQoc3BvdEJib3gueCArIHNwb3RCYm94LndpZHRoLCByZWZlcmVuY2UueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwb3QgPSBnLnJlY3Qoc3BvdEJib3gpLmNlbnRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZlcnRpY2FsTGluZVJlY3QuaW50ZXJzZWN0KGcucmVjdChzcG90QmJveCkpKSB7CgogICAgICAgICAgICAgICAgICAgIG5lYXJlc3RTaWRlID0gZy5yZWN0KHNwb3RCYm94KS5zaWRlTmVhcmVzdFRvUG9pbnQocmVmZXJlbmNlKTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG5lYXJlc3RTaWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0b3AnOgogICAgICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5wb2ludChyZWZlcmVuY2UueCwgc3BvdEJib3gueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQocmVmZXJlbmNlLngsIHNwb3RCYm94LnkgKyBzcG90QmJveC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uIGhvcml6b250YWxseSBvciB2ZXJ0aWNhbGx5IHdpdGggdGhlIG9iamVjdCBib3VuZGluZyBib3gsCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiB3ZSBmYWxsIGJhY2sgdG8gdGhlIHJlZ3VsYXIgc2l0dWF0aW9uIGZpbmRpbmcgc3RyYWlnaHQgbGluZSAobm90IHBlcnBlbmRpY3VsYXIpCiAgICAgICAgICAgICAgICAgICAgLy8gYmV0d2VlbiB0aGUgb2JqZWN0IGFuZCB0aGUgcmVmZXJlbmNlIHBvaW50LgoKICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5yZWN0KHNwb3RCYm94KS5pbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50KHJlZmVyZW5jZSk7CiAgICAgICAgICAgICAgICAgICAgc3BvdCA9IHNwb3QgfHwgZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucGFwZXIub3B0aW9ucy5saW5rQ29ubmVjdGlvblBvaW50KSB7CgoJCXZhciB2aWV3ID0gZW5kID09PSAndGFyZ2V0JyA/IHRoaXMudGFyZ2V0VmlldyA6IHRoaXMuc291cmNlVmlldzsKCQl2YXIgbWFnbmV0ID0gZW5kID09PSAndGFyZ2V0JyA/IHRoaXMudGFyZ2V0TWFnbmV0IDogdGhpcy5zb3VyY2VNYWduZXQ7CgoJCXNwb3QgPSB0aGlzLnBhcGVyLm9wdGlvbnMubGlua0Nvbm5lY3Rpb25Qb2ludCh0aGlzLCB2aWV3LCBtYWduZXQsIHJlZmVyZW5jZSk7CgoJICAgIH0gZWxzZSB7CgogICAgICAgICAgICAJc3BvdCA9IGcucmVjdChzcG90QmJveCkuaW50ZXJzZWN0aW9uV2l0aExpbmVGcm9tQ2VudGVyVG9Qb2ludChyZWZlcmVuY2UpOwogICAgICAgICAgICAgICAgc3BvdCA9IHNwb3QgfHwgZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNwb3Q7CiAgICB9LAoKICAgIF9pc01vZGVsOiBmdW5jdGlvbihlbmQpIHsKCiAgICAgICAgcmV0dXJuIGVuZCAmJiBlbmQuaWQ7CiAgICB9LAoKICAgIF9pc1BvaW50OiBmdW5jdGlvbihlbmQpIHsKCiAgICAgICAgcmV0dXJuICF0aGlzLl9pc01vZGVsKGVuZCk7CiAgICB9LAoKICAgIF9tYWtlU2VsZWN0b3I6IGZ1bmN0aW9uKGVuZCkgewoKICAgICAgICB2YXIgc2VsZWN0b3IgPSAnW21vZGVsLWlkPSInICsgZW5kLmlkICsgJyJdJzsKICAgICAgICAvLyBgcG9ydGAgaGFzIGEgaGlnaGVyIHByZWNlbmRlbmNlIG92ZXIgYHNlbGVjdG9yYC4gVGhpcyBpcyBiZWNhdXNlIHRoZSBzZWxlY3RvciB0byB0aGUgbWFnbmV0CiAgICAgICAgLy8gbWlnaHQgY2hhbmdlIHdoaWxlIHRoZSBuYW1lIG9mIHRoZSBwb3J0IGNhbiBzdGF5IHRoZSBzYW1lLgogICAgICAgIGlmIChlbmQucG9ydCkgewogICAgICAgICAgICBzZWxlY3RvciArPSAnIFtwb3J0PSInICsgZW5kLnBvcnQgKyAnIl0nOwogICAgICAgIH0gZWxzZSBpZiAoZW5kLnNlbGVjdG9yKSB7CiAgICAgICAgICAgIHNlbGVjdG9yICs9ICcgJyArIGVuZC5zZWxlY3RvcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxlY3RvcjsKICAgIH0sCgogICAgLy8gUHVibGljIEFQSQogICAgLy8gLS0tLS0tLS0tLQoKICAgIGdldENvbm5lY3Rpb25MZW5ndGg6IGZ1bmN0aW9uKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5fVi5jb25uZWN0aW9uLm5vZGUuZ2V0VG90YWxMZW5ndGgoKTsKICAgIH0sCgogICAgZ2V0UG9pbnRBdExlbmd0aDogZnVuY3Rpb24obGVuZ3RoKSB7CgogICAgICAgIHJldHVybiB0aGlzLl9WLmNvbm5lY3Rpb24ubm9kZS5nZXRQb2ludEF0TGVuZ3RoKGxlbmd0aCk7CiAgICB9LAoKICAgIC8vIEludGVyYWN0aW9uLiBUaGUgY29udHJvbGxlciBwYXJ0LgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgX2JlZm9yZUFycm93aGVhZE1vdmU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ2JhdGNoOnN0YXJ0Jyk7CgogICAgICAgIHRoaXMuX3ogPSB0aGlzLm1vZGVsLmdldCgneicpOwogICAgICAgIHRoaXMubW9kZWwuc2V0KCd6JywgTnVtYmVyLk1BWF9WQUxVRSk7CgogICAgICAgIC8vIExldCB0aGUgcG9pbnRlciBwcm9wYWdhdGUgdGhyb3VnaHQgdGhlIGxpbmsgdmlldyBlbGVtZW50cyBzbyB0aGF0CiAgICAgICAgLy8gdGhlIGBldnQudGFyZ2V0YCBpcyBhbm90aGVyIGVsZW1lbnQgdW5kZXIgdGhlIHBvaW50ZXIsIG5vdCB0aGUgbGluayBpdHNlbGYuCiAgICAgICAgdGhpcy5lbC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnOwoKICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLm1hcmtBdmFpbGFibGUpIHsKICAgICAgICAgICAgdGhpcy5fbWFya0F2YWlsYWJsZU1hZ25ldHMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIF9hZnRlckFycm93aGVhZE1vdmU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAodGhpcy5feikgewogICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgneicsIHRoaXMuX3opOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fejsKICAgICAgICB9CgogICAgICAgIC8vIFB1dCBgcG9pbnRlci1ldmVudHNgIGJhY2sgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLiBTZWUgYHN0YXJ0QXJyb3doZWFkTW92ZSgpYCBmb3IgZXhwbGFuYXRpb24uCgkvLyBWYWx1ZSBgYXV0b2AgZG9lc24ndCB3b3JrIGluIElFOS4gV2UgZm9yY2UgdG8gdXNlIGB2aXNpYmxlUGFpbnRlZGAgaW5zdGVhZC4KCS8vIFNlZSBgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BvaW50ZXItZXZlbnRzYC4KICAgICAgICB0aGlzLmVsLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAndmlzaWJsZVBhaW50ZWQnOwoKICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLm1hcmtBdmFpbGFibGUpIHsKICAgICAgICAgICAgdGhpcy5fdW5tYXJrQXZhaWxhYmxlTWFnbmV0cygpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICB9LAoKICAgIF9jcmVhdGVWYWxpZGF0ZUNvbm5lY3Rpb25BcmdzOiBmdW5jdGlvbihhcnJvd2hlYWQpIHsKICAgICAgICAvLyBJdCBtYWtlcyBzdXJlIHRoZSBhcmd1bWVudHMgZm9yIHZhbGlkYXRlQ29ubmVjdGlvbiBoYXZlIHRoZSBmb2xsb3dpbmcgZm9ybToKICAgICAgICAvLyAoc291cmNlIHZpZXcsIHNvdXJjZSBtYWduZXQsIHRhcmdldCB2aWV3LCB0YXJnZXQgbWFnbmV0IGFuZCBsaW5rIHZpZXcpCiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKCiAgICAgICAgYXJnc1s0XSA9IGFycm93aGVhZDsKICAgICAgICBhcmdzWzVdID0gdGhpczsKCiAgICAgICAgdmFyIG9wcG9zaXRlQXJyb3doZWFkLCBpID0gMCwgaiA9IDA7CgogICAgICAgIGlmIChhcnJvd2hlYWQgPT09ICdzb3VyY2UnKSB7CiAgICAgICAgICAgIGkgPSAyOwogICAgICAgICAgICBvcHBvc2l0ZUFycm93aGVhZCA9ICd0YXJnZXQnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGogPSAyOwogICAgICAgICAgICBvcHBvc2l0ZUFycm93aGVhZCA9ICdzb3VyY2UnOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVuZCA9IHRoaXMubW9kZWwuZ2V0KG9wcG9zaXRlQXJyb3doZWFkKTsKCiAgICAgICAgaWYgKGVuZC5pZCkgewogICAgICAgICAgICBhcmdzW2ldID0gdGhpcy5wYXBlci5maW5kVmlld0J5TW9kZWwoZW5kLmlkKTsKICAgICAgICAgICAgYXJnc1tpKzFdID0gZW5kLnNlbGVjdG9yICYmIGFyZ3NbaV0uZWwucXVlcnlTZWxlY3RvcihlbmQuc2VsZWN0b3IpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDb25uZWN0aW9uQXJncyhjZWxsVmlldywgbWFnbmV0KSB7CiAgICAgICAgICAgIGFyZ3Nbal0gPSBjZWxsVmlldzsKICAgICAgICAgICAgYXJnc1tqKzFdID0gY2VsbFZpZXcuZWwgPT09IG1hZ25ldCA/IHVuZGVmaW5lZCA6IG1hZ25ldDsKICAgICAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsaWRhdGVDb25uZWN0aW9uQXJnczsKICAgIH0sCgogICAgX21hcmtBdmFpbGFibGVNYWduZXRzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGVsZW1lbnRzID0gdGhpcy5wYXBlci5tb2RlbC5nZXRFbGVtZW50cygpOwogICAgICAgIHZhciB2YWxpZGF0ZSA9IHRoaXMucGFwZXIub3B0aW9ucy52YWxpZGF0ZUNvbm5lY3Rpb247CgogICAgICAgIF8uY2hhaW4oZWxlbWVudHMpLm1hcCh0aGlzLnBhcGVyLmZpbmRWaWV3QnlNb2RlbCwgdGhpcy5wYXBlcikuZWFjaChmdW5jdGlvbih2aWV3KSB7CgogICAgICAgICAgICB2YXIgaXNFbGVtZW50QXZhaWxhYmxlID0gdmlldy5lbC5nZXRBdHRyaWJ1dGUoJ21hZ25ldCcpICE9PSAnZmFsc2UnICYmCiAgICAgICAgICAgICAgICB2YWxpZGF0ZS5hcHBseSh0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG51bGwpKTsKCiAgICAgICAgICAgIHZhciBhdmFpbGFibGVNYWduZXRzID0gXy5maWx0ZXIodmlldy5lbC5xdWVyeVNlbGVjdG9yQWxsKCdbbWFnbmV0XScpLCBmdW5jdGlvbihtYWduZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZS5hcHBseSh0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG1hZ25ldCkpOwogICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIGlmIChpc0VsZW1lbnRBdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgIFYodmlldy5lbCkuYWRkQ2xhc3MoJ2F2YWlsYWJsZS1tYWduZXQnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgXy5lYWNoKGF2YWlsYWJsZU1hZ25ldHMsIGZ1bmN0aW9uKG1hZ25ldCkgewogICAgICAgICAgICAgICAgVihtYWduZXQpLmFkZENsYXNzKCdhdmFpbGFibGUtbWFnbmV0Jyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGlzRWxlbWVudEF2YWlsYWJsZSB8fCBhdmFpbGFibGVNYWduZXRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVih2aWV3LmVsKS5hZGRDbGFzcygnYXZhaWxhYmxlLWNlbGwnKTsKICAgICAgICAgICAgfQoKICAgICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgX3VubWFya0F2YWlsYWJsZU1hZ25ldHM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBfLmVhY2godGhpcy5wYXBlci5lbC5xdWVyeVNlbGVjdG9yQWxsKCcuYXZhaWxhYmxlLWNlbGwsIC5hdmFpbGFibGUtbWFnbmV0JyksIGZ1bmN0aW9uKG1hZ25ldCkgewogICAgICAgICAgICBWKG1hZ25ldCkucmVtb3ZlQ2xhc3MoJ2F2YWlsYWJsZS1tYWduZXQnKS5yZW1vdmVDbGFzcygnYXZhaWxhYmxlLWNlbGwnKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgc3RhcnRBcnJvd2hlYWRNb3ZlOiBmdW5jdGlvbihlbmQpIHsKICAgICAgICAvLyBBbGxvdyB0byBkZWxlZ2F0ZSBldmVudHMgZnJvbSBhbiBhbm90aGVyIHZpZXcgdG8gdGhpcyBsaW5rVmlldyBpbiBvcmRlciB0byB0cmlnZ2VyIGFycm93aGVhZAogICAgICAgIC8vIG1vdmUgd2l0aG91dCBuZWVkIHRvIGNsaWNrIG9uIHRoZSBhY3R1YWwgYXJyb3doZWFkIGRvbSBlbGVtZW50LgogICAgICAgIHRoaXMuX2FjdGlvbiA9ICdhcnJvd2hlYWQtbW92ZSc7CiAgICAgICAgdGhpcy5fYXJyb3doZWFkID0gZW5kOwogICAgICAgIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3MgPSB0aGlzLl9jcmVhdGVWYWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHRoaXMuX2Fycm93aGVhZCk7CiAgICAgICAgdGhpcy5fYmVmb3JlQXJyb3doZWFkTW92ZSgpOwogICAgfSwKCiAgICBwb2ludGVyZG93bjogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUucG9pbnRlcmRvd24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgl0aGlzLl9keCA9IHg7CiAgICAgICAgdGhpcy5fZHkgPSB5OwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmludGVyYWN0aXZlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICB2YXIgY2xhc3NOYW1lID0gZXZ0LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7CgogICAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CgogICAgICAgIGNhc2UgJ21hcmtlci12ZXJ0ZXgnOgogICAgICAgICAgICB0aGlzLl9hY3Rpb24gPSAndmVydGV4LW1vdmUnOwogICAgICAgICAgICB0aGlzLl92ZXJ0ZXhJZHggPSBldnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnaWR4Jyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdtYXJrZXItdmVydGV4LXJlbW92ZSc6CiAgICAgICAgY2FzZSAnbWFya2VyLXZlcnRleC1yZW1vdmUtYXJlYSc6CiAgICAgICAgICAgIHRoaXMucmVtb3ZlVmVydGV4KGV2dC50YXJnZXQuZ2V0QXR0cmlidXRlKCdpZHgnKSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdtYXJrZXItYXJyb3doZWFkJzoKICAgICAgICAgICAgdGhpcy5zdGFydEFycm93aGVhZE1vdmUoZXZ0LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2VuZCcpKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CgogICAgICAgICAgICB2YXIgdGFyZ2V0UGFyZW50RXZlbnQgPSBldnQudGFyZ2V0LnBhcmVudE5vZGUuZ2V0QXR0cmlidXRlKCdldmVudCcpOwoKICAgICAgICAgICAgaWYgKHRhcmdldFBhcmVudEV2ZW50KSB7CgogICAgICAgICAgICAgICAgLy8gYHJlbW92ZWAgZXZlbnQgaXMgYnVpbHQtaW4uIE90aGVyIGN1c3RvbSBldmVudHMgYXJlIHRyaWdnZXJlZCBvbiB0aGUgcGFwZXIuCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0UGFyZW50RXZlbnQgPT09ICdyZW1vdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXBlci50cmlnZ2VyKHRhcmdldFBhcmVudEV2ZW50LCBldnQsIHRoaXMsIHgsIHkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBTdG9yZSB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIG5ldyB2ZXJ0ZXggaGFzIGp1c3QgYmVlbiBwbGFjZWQuCiAgICAgICAgICAgICAgICAvLyBXZSdsbCBiZSB1cGRhdGUgdGhlIHZlcnkgc2FtZSB2ZXJ0ZXggcG9zaXRpb24gaW4gYHBvaW50ZXJtb3ZlKClgLgogICAgICAgICAgICAgICAgdGhpcy5fdmVydGV4SWR4ID0gdGhpcy5hZGRWZXJ0ZXgoeyB4OiB4LCB5OiB5IH0pOwogICAgICAgICAgICAgICAgdGhpcy5fYWN0aW9uID0gJ3ZlcnRleC1tb3ZlJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcm1vdmU6IGZ1bmN0aW9uKGV2dCwgeCwgeSkgewoKICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJtb3ZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHN3aXRjaCAodGhpcy5fYWN0aW9uKSB7CgogICAgICAgICAgY2FzZSAndmVydGV4LW1vdmUnOgoKICAgICAgICAgICAgdmFyIHZlcnRpY2VzID0gXy5jbG9uZSh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSk7CiAgICAgICAgICAgIHZlcnRpY2VzW3RoaXMuX3ZlcnRleElkeF0gPSB7IHg6IHgsIHk6IHkgfTsKICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ3ZlcnRpY2VzJywgdmVydGljZXMpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICdhcnJvd2hlYWQtbW92ZSc6CgogICAgICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLnNuYXBMaW5rcykgewoKICAgICAgICAgICAgICAgIC8vIGNoZWNraW5nIHZpZXcgaW4gY2xvc2UgYXJlYSBvZiB0aGUgcG9pbnRlcgoKICAgICAgICAgICAgICAgIHZhciByID0gdGhpcy5wYXBlci5vcHRpb25zLnNuYXBMaW5rcy5yYWRpdXMgfHwgNTA7CiAgICAgICAgICAgICAgICB2YXIgdmlld3NJbkFyZWEgPSB0aGlzLnBhcGVyLmZpbmRWaWV3c0luQXJlYSh7IHg6IHggLSByLCB5OiB5IC0gciwgd2lkdGg6IDIgKiByLCBoZWlnaHQ6IDIgKiByIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ICYmIHRoaXMuX2Nsb3Nlc3RWaWV3LnVuaGlnaGxpZ2h0KHRoaXMuX2Nsb3Nlc3RFbmQuc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgPSB0aGlzLl9jbG9zZXN0RW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICB2YXIgcG9pbnRlciA9IGcucG9pbnQoeCx5KTsKICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZSwgbWluRGlzdGFuY2UgPSBOdW1iZXIuTUFYX1ZBTFVFOwoKICAgICAgICAgICAgICAgIF8uZWFjaCh2aWV3c0luQXJlYSwgZnVuY3Rpb24odmlldykgewoKICAgICAgICAgICAgICAgICAgICAvLyBza2lwIGNvbm5lY3RpbmcgdG8gdGhlIGVsZW1lbnQgaW4gY2FzZSAnLic6IHsgbWFnbmV0OiBmYWxzZSB9IGF0dHJpYnV0ZSBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZWwuZ2V0QXR0cmlidXRlKCdtYWduZXQnKSAhPT0gJ2ZhbHNlJykgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmluZCBkaXN0YW5jZSBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIG1vZGVsIHRvIHBvaW50ZXIgY29vcmRpbmF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2UgPSB2aWV3Lm1vZGVsLmdldEJCb3goKS5jZW50ZXIoKS5kaXN0YW5jZShwb2ludGVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjb25uZWN0aW9uIGlzIGxvb2tlZCB1cCBpbiBhIGNpcmNsZSBhcmVhIGJ5IGBkaXN0YW5jZSA8IHJgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IHIgJiYgZGlzdGFuY2UgPCBtaW5EaXN0YW5jZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcGVyLm9wdGlvbnMudmFsaWRhdGVDb25uZWN0aW9uLmFwcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFwZXIsIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3ModmlldywgbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ID0gdmlldzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0RW5kID0geyBpZDogdmlldy5tb2RlbC5pZCB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2aWV3LiQoJ1ttYWduZXRdJykuZWFjaChfLmJpbmQoZnVuY3Rpb24oaW5kZXgsIG1hZ25ldCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJib3ggPSBWKG1hZ25ldCkuYmJveChmYWxzZSwgdGhpcy5wYXBlci52aWV3cG9ydCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZSA9IHBvaW50ZXIuZGlzdGFuY2UoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeDogYmJveC54ICsgYmJveC53aWR0aCAvIDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiBiYm94LnkgKyBiYm94LmhlaWdodCAvIDIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCByICYmIGRpc3RhbmNlIDwgbWluRGlzdGFuY2UpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLnZhbGlkYXRlQ29ubmVjdGlvbi5hcHBseSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG1hZ25ldCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ID0gdmlldzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0RW5kID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmlldy5tb2RlbC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHZpZXcuZ2V0U2VsZWN0b3IobWFnbmV0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogbWFnbmV0LmdldEF0dHJpYnV0ZSgncG9ydCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAgICAgfSwgdGhpcyk7CgogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgJiYgdGhpcy5fY2xvc2VzdFZpZXcuaGlnaGxpZ2h0KHRoaXMuX2Nsb3Nlc3RFbmQuc2VsZWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgdGhpcy5fY2xvc2VzdEVuZCB8fCB7IHg6IHgsIHk6IHkgfSk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIGNoZWNraW5nIHZpZXdzIHJpZ2h0IHVuZGVyIHRoZSBwb2ludGVyCgogICAgICAgICAgICAgICAgLy8gVG91Y2htb3ZlIGV2ZW50J3MgdGFyZ2V0IGlzIG5vdCByZWZsZWN0aW5nIHRoZSBlbGVtZW50IHVuZGVyIHRoZSBjb29yZGluYXRlcyBhcyBtb3VzZW1vdmUgZG9lcy4KICAgICAgICAgICAgICAgIC8vIEl0IGhvbGRzIHRoZSBlbGVtZW50IHdoZW4gYSB0b3VjaHN0YXJ0IHRyaWdnZXJlZC4KICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAoZXZ0LnR5cGUgPT09ICdtb3VzZW1vdmUnKQogICAgICAgICAgICAgICAgICAgID8gZXZ0LnRhcmdldAogICAgICAgICAgICAgICAgICAgIDogZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChldnQuY2xpZW50WCwgZXZ0LmNsaWVudFkpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLl90YXJnZXRFdmVudCAhPT0gdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVW5oaWdobGlnaHQgdGhlIHByZXZpb3VzIHZpZXcgdW5kZXIgcG9pbnRlciBpZiB0aGVyZSB3YXMgb25lLgogICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciAmJiB0aGlzLl92aWV3VW5kZXJQb2ludGVyLnVuaGlnaGxpZ2h0KHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld1VuZGVyUG9pbnRlciA9IHRoaXMucGFwZXIuZmluZFZpZXcodGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdmlld1VuZGVyUG9pbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBmb3VuZCBhIHZpZXcgdGhhdCBpcyB1bmRlciB0aGUgcG9pbnRlciwgd2UgbmVlZCB0byBmaW5kIHRoZSBjbG9zZXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hZ25ldCBiYXNlZCBvbiB0aGUgcmVhbCB0YXJnZXQgZWxlbWVudCBvZiB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciA9IHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuZmluZE1hZ25ldCh0YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciAmJiB0aGlzLnBhcGVyLm9wdGlvbnMudmFsaWRhdGVDb25uZWN0aW9uLmFwcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXBlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3ModGhpcy5fdmlld1VuZGVyUG9pbnRlciwgdGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKQogICAgICAgICAgICAgICAgICAgICAgICApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSB3YXMgbm8gbWFnbmV0IGZvdW5kLCBkbyBub3QgaGlnaGxpZ2h0IGFueXRoaW5nIGFuZCBhc3N1bWUgdGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlzIG5vIHZpZXcgdW5kZXIgcG9pbnRlciB3ZSdyZSBpbnRlcmVzdGVkIGluIHJlY29ubmVjdGluZyB0by4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIG9ubHkgaGFwcGVuIGlmIHRoZSBvdmVyYWxsIGVsZW1lbnQgaGFzIHRoZSBhdHRyaWJ1dGUgYCcuJzogeyBtYWduZXQ6IGZhbHNlIH1gLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyICYmIHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuaGlnaGxpZ2h0KHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHR5cGUgb2YgY29ubmVjdGlvbiBpcyBub3QgdmFsaWQuIERpc3JlZ2FyZCB0aGlzIG1hZ25ldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UnbGwgZGVsZXRlIHByZXZpb3VzIG1hZ25ldAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgkgICAgICAgIHRoaXMuX3RhcmdldEV2ZW50ID0gdGFyZ2V0OwoKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgeyB4OiB4LCB5OiB5IH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2R4ID0geDsKICAgICAgICB0aGlzLl9keSA9IHk7CiAgICB9LAoKICAgIHBvaW50ZXJ1cDogZnVuY3Rpb24oZXZ0KSB7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUucG9pbnRlcnVwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh0aGlzLl9hY3Rpb24gPT09ICdhcnJvd2hlYWQtbW92ZScpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLnBhcGVyLm9wdGlvbnMuc25hcExpbmtzKSB7CgogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgJiYgdGhpcy5fY2xvc2VzdFZpZXcudW5oaWdobGlnaHQodGhpcy5fY2xvc2VzdEVuZC5zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0VmlldyA9IHRoaXMuX2Nsb3Nlc3RFbmQgPSBudWxsOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld1VuZGVyUG9pbnRlci51bmhpZ2hsaWdodCh0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIpOwogICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgYSB1bmlxdWUgYHNlbGVjdG9yYCBvZiB0aGUgZWxlbWVudCB1bmRlciBwb2ludGVyIHRoYXQgaXMgYSBtYWduZXQuIElmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGB0aGlzLl9tYWduZXRVbmRlclBvaW50ZXJgIGlzIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGB0aGlzLl92aWV3VW5kZXJQb2ludGVyYCBpdHNlbGYsCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHJldHVybmVkIGBzZWxlY3RvcmAgd2lsbCBiZSBgdW5kZWZpbmVkYC4gVGhhdCBtZWFucyB3ZSBjYW4gZGlyZWN0bHkgcGFzcyBpdCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAvLyBgc291cmNlYC9gdGFyZ2V0YCBhdHRyaWJ1dGUgb2YgdGhlIGxpbmsgbW9kZWwgYmVsb3cuCgkJICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5fdmlld1VuZGVyUG9pbnRlci5tb2RlbC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuZ2V0U2VsZWN0b3IodGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogJCh0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIpLmF0dHIoJ3BvcnQnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl92aWV3VW5kZXJQb2ludGVyOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcjsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdGF0aWNWaWV3OwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3N0YXRpY01hZ25ldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYWZ0ZXJBcnJvd2hlYWRNb3ZlKCk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdGhpcy5fYWN0aW9uOwogICAgfQp9KTsKCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMuTGluayA9IGpvaW50LmRpYS5MaW5rOwogICAgbW9kdWxlLmV4cG9ydHMuTGlua1ZpZXcgPSBqb2ludC5kaWEuTGlua1ZpZXc7Cn0KCi8vICAgICAgSm9pbnRKUyBsaWJyYXJ5LgovLyAgICAgIChjKSAyMDExLTIwMTMgY2xpZW50IElPCgoKam9pbnQuZGlhLlBhcGVyID0gQmFja2JvbmUuVmlldy5leHRlbmQoewoKICAgIGNsYXNzTmFtZTogJ3BhcGVyJywKCiAgICBvcHRpb25zOiB7CgogICAgICAgIHdpZHRoOiA4MDAsCiAgICAgICAgaGVpZ2h0OiA2MDAsCiAgICAgICAgb3JpZ2luOiB7IHg6IDAsIHk6IDAgfSwgLy8geCx5IGNvb3JkaW5hdGVzIGluIHRvcC1sZWZ0IGNvcm5lcgogICAgICAgIGdyaWRTaXplOiA1MCwKICAgICAgICBwZXJwZW5kaWN1bGFyTGlua3M6IGZhbHNlLAogICAgICAgIGVsZW1lbnRWaWV3OiBqb2ludC5kaWEuRWxlbWVudFZpZXcsCiAgICAgICAgbGlua1ZpZXc6IGpvaW50LmRpYS5MaW5rVmlldywKICAgICAgICBzbmFwTGlua3M6IGZhbHNlLCAvLyBmYWxzZSwgdHJ1ZSwgeyByYWRpdXM6IHZhbHVlIH0KCiAgICAgICAgLy8gTWFya3MgYWxsIGF2YWlsYWJsZSBtYWduZXRzIHdpdGggJ2F2YWlsYWJsZS1tYWduZXQnIGNsYXNzIG5hbWUgYW5kIGFsbCBhdmFpbGFibGUgY2VsbHMgd2l0aAogICAgICAgIC8vICdhdmFpbGFibGUtY2VsbCcgY2xhc3MgbmFtZS4gTWFya3MgdGhlbSB3aGVuIGRyYWdnaW5nIGEgbGluayBpcyBzdGFydGVkIGFuZCB1bm1hcmsKICAgICAgICAvLyB3aGVuIHRoZSBkcmFnZ2luZyBpcyBzdG9wcGVkLgogICAgICAgIG1hcmtBdmFpbGFibGU6IGZhbHNlLAoKICAgICAgICAvLyBEZWZpbmVzIHdoYXQgbGluayBtb2RlbCBpcyBhZGRlZCB0byB0aGUgZ3JhcGggYWZ0ZXIgYW4gdXNlciBjbGlja3Mgb24gYW4gYWN0aXZlIG1hZ25ldC4KICAgICAgICAvLyBWYWx1ZSBjb3VsZCBiZSB0aGUgQmFja2JvbmUubW9kZWwgb3IgYSBmdW5jdGlvbiByZXR1cm5pbmcgdGhlIEJhY2tib25lLm1vZGVsCiAgICAgICAgLy8gZGVmYXVsdExpbms6IGZ1bmN0aW9uKGVsZW1lbnRWaWV3LCBtYWduZXQpIHsgcmV0dXJuIGNvbmRpdGlvbiA/IG5ldyBjdXN0b21MaW5rMSgpIDogbmV3IGN1c3RvbUxpbmsyKCkgfQogICAgICAgIGRlZmF1bHRMaW5rOiBuZXcgam9pbnQuZGlhLkxpbmssCgogICAgICAgIC8vIENoZWNrIHdoZXRoZXIgdG8gYWRkIGEgbmV3IGxpbmsgdG8gdGhlIGdyYXBoIHdoZW4gdXNlciBjbGlja3Mgb24gYW4gYSBtYWduZXQuCiAgICAgICAgdmFsaWRhdGVNYWduZXQ6IGZ1bmN0aW9uKGNlbGxWaWV3LCBtYWduZXQpIHsKICAgICAgICAgICAgcmV0dXJuIG1hZ25ldC5nZXRBdHRyaWJ1dGUoJ21hZ25ldCcpICE9PSAncGFzc2l2ZSc7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ2hlY2sgd2hldGhlciB0byBhbGxvdyBvciBkaXNhbGxvdyB0aGUgbGluayBjb25uZWN0aW9uIHdoaWxlIGFuIGFycm93aGVhZCBlbmQgKHNvdXJjZS90YXJnZXQpCiAgICAgICAgLy8gYmVpbmcgY2hhbmdlZC4KICAgICAgICB2YWxpZGF0ZUNvbm5lY3Rpb246IGZ1bmN0aW9uKGNlbGxWaWV3UywgbWFnbmV0UywgY2VsbFZpZXdULCBtYWduZXRULCBlbmQsIGxpbmtWaWV3KSB7CiAgICAgICAgICAgIHJldHVybiAoZW5kID09PSAndGFyZ2V0JyA/IGNlbGxWaWV3VCA6IGNlbGxWaWV3UykgaW5zdGFuY2VvZiBqb2ludC5kaWEuRWxlbWVudFZpZXc7CiAgICAgICAgfQogICAgfSwKCiAgICBldmVudHM6IHsKCiAgICAgICAgJ21vdXNlZG93bic6ICdwb2ludGVyZG93bicsCiAgICAgICAgJ2RibGNsaWNrJzogJ21vdXNlZGJsY2xpY2snLAogICAgICAgICdjbGljayc6ICdtb3VzZWNsaWNrJywKICAgICAgICAndG91Y2hzdGFydCc6ICdwb2ludGVyZG93bicsCiAgICAgICAgJ21vdXNlbW92ZSc6ICdwb2ludGVybW92ZScsCiAgICAgICAgJ3RvdWNobW92ZSc6ICdwb2ludGVybW92ZScKICAgIH0sCgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCgl0aGlzLl9jb25maWd1cmUob3B0aW9ucyk7CglCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCglpZiAodGhpcy5vcHRpb25zKSBvcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwoJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIF8uYmluZEFsbCh0aGlzLCAnYWRkQ2VsbCcsICdzb3J0Q2VsbHMnLCAncmVzZXRDZWxscycsICdwb2ludGVydXAnLCAnYXN5bmNSZW5kZXJDZWxscycpOwoKICAgICAgICB0aGlzLnN2ZyA9IFYoJ3N2ZycpLm5vZGU7CiAgICAgICAgdGhpcy52aWV3cG9ydCA9IFYoJ2cnKS5ub2RlOwoKICAgICAgICAvLyBBcHBlbmQgYDxkZWZzPmAgZWxlbWVudCB0byB0aGUgU1ZHIGRvY3VtZW50LiBUaGlzIGlzIHVzZWZ1bCBmb3IgZmlsdGVycyBhbmQgZ3JhZGllbnRzLgogICAgICAgIFYodGhpcy5zdmcpLmFwcGVuZChWKCdkZWZzJykubm9kZSk7CgogICAgICAgIFYodGhpcy52aWV3cG9ydCkuYXR0cih7ICdjbGFzcyc6ICd2aWV3cG9ydCcgfSk7CiAgICAgICAgCiAgICAgICAgVih0aGlzLnN2ZykuYXBwZW5kKHRoaXMudmlld3BvcnQpOwoKICAgICAgICB0aGlzLiRlbC5hcHBlbmQodGhpcy5zdmcpOwoKICAgICAgICB0aGlzLnNldE9yaWdpbigpOwogICAgICAgIHRoaXMuc2V0RGltZW5zaW9ucygpOwoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2FkZCcsIHRoaXMuYWRkQ2VsbCk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdyZXNldCcsIHRoaXMucmVzZXRDZWxscyk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdzb3J0JywgdGhpcy5zb3J0Q2VsbHMpOwoKCSQoZG9jdW1lbnQpLm9uKCdtb3VzZXVwIHRvdWNoZW5kJywgdGhpcy5wb2ludGVydXApOwoKICAgICAgICAvLyBIb2xkIHRoZSB2YWx1ZSB3aGVuIG1vdXNlIGhhcyBiZWVuIG1vdmVkOiB3aGVuIG1vdXNlIG1vdmVkLCBubyBjbGljayBldmVudCB3aWxsIGJlIHRyaWdnZXJlZC4KICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gZmFsc2U7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CgoJJChkb2N1bWVudCkub2ZmKCdtb3VzZXVwIHRvdWNoZW5kJywgdGhpcy5wb2ludGVydXApOwoKCUJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHdpZHRoID0gdGhpcy5vcHRpb25zLndpZHRoID0gd2lkdGggfHwgdGhpcy5vcHRpb25zLndpZHRoOwogICAgICAgIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgPSBoZWlnaHQgfHwgdGhpcy5vcHRpb25zLmhlaWdodDsKCiAgICAgICAgVih0aGlzLnN2ZykuYXR0cih7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfSk7CgogICAgICAgIHRoaXMudHJpZ2dlcigncmVzaXplJywgd2lkdGgsIGhlaWdodCk7CiAgICB9LAoKICAgIHNldE9yaWdpbjogZnVuY3Rpb24ob3gsIG95KSB7CgogICAgICAgIHRoaXMub3B0aW9ucy5vcmlnaW4ueCA9IG94IHx8IDA7CiAgICAgICAgdGhpcy5vcHRpb25zLm9yaWdpbi55ID0gb3kgfHwgMDsKCiAgICAgICAgVih0aGlzLnZpZXdwb3J0KS50cmFuc2xhdGUob3gsIG95LCB7IGFic29sdXRlOiB0cnVlIH0pOwoKICAgICAgICB0aGlzLnRyaWdnZXIoJ3RyYW5zbGF0ZScsIG94LCBveSk7CiAgICB9LAoKICAgIC8vIEV4cGFuZC9zaHJpbmsgdGhlIHBhcGVyIHRvIGZpdCB0aGUgY29udGVudC4gU25hcCB0aGUgd2lkdGgvaGVpZ2h0IHRvIHRoZSBncmlkCiAgICAvLyBkZWZpbmVkIGluIGBncmlkV2lkdGhgLCBgZ3JpZEhlaWdodGAuIGBwYWRkaW5nYCBhZGRzIHRvIHRoZSByZXN1bHRpbmcgd2lkdGgvaGVpZ2h0IG9mIHRoZSBwYXBlci4KICAgIC8vIFdoZW4gb3B0aW9ucyB7IGZpdE5lZ2F0aXZlOiB0cnVlIH0gaXQgYWxzbyB0cmFuc2xhdGVzIHRoZSB2aWV3cG9ydCBpbiBvcmRlciB0byBtYWtlIGFsbAogICAgLy8gdGhlIGNvbnRlbnQgdmlzaWJsZS4KICAgIGZpdFRvQ29udGVudDogZnVuY3Rpb24oZ3JpZFdpZHRoLCBncmlkSGVpZ2h0LCBwYWRkaW5nLCBvcHQpIHsgLy8gYWx0ZXJuYXRpdmVseSBmdW5jdGlvbihvcHQpCgogICAgICAgIGlmIChfLmlzT2JqZWN0KGdyaWRXaWR0aCkpIHsKICAgICAgICAgICAgLy8gZmlyc3QgcGFyYW1ldGVyIGlzIGFuIG9wdGlvbiBvYmplY3QKICAgICAgICAgICAgb3B0ID0gZ3JpZFdpZHRoOwoJICAgIGdyaWRXaWR0aCA9IG9wdC5ncmlkV2lkdGggfHwgMTsKCSAgICBncmlkSGVpZ2h0ID0gb3B0LmdyaWRIZWlnaHQgfHwgMTsKICAgICAgICAgICAgcGFkZGluZyA9IG9wdC5wYWRkaW5nIHx8IDA7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBvcHQgPSBvcHQgfHwge307CgkgICAgZ3JpZFdpZHRoID0gZ3JpZFdpZHRoIHx8IDE7CgkgICAgZ3JpZEhlaWdodCA9IGdyaWRIZWlnaHQgfHwgMTsKICAgICAgICAgICAgcGFkZGluZyA9IHBhZGRpbmcgfHwgMDsKICAgICAgICB9CgoJLy8gQ2FsY3VsYXRlIHRoZSBwYXBlciBzaXplIHRvIGFjY29tb2RhdGUgYWxsIHRoZSBncmFwaCdzIGVsZW1lbnRzLgoJdmFyIGJib3ggPSBWKHRoaXMudmlld3BvcnQpLmJib3godHJ1ZSwgdGhpcy5zdmcpOwoKCXZhciBjYWxjV2lkdGggPSBNYXRoLm1heChNYXRoLmNlaWwoKGJib3gud2lkdGggKyBiYm94LngpIC8gZ3JpZFdpZHRoKSwgMSkgKiBncmlkV2lkdGg7Cgl2YXIgY2FsY0hlaWdodCA9IE1hdGgubWF4KE1hdGguY2VpbCgoYmJveC5oZWlnaHQgKyBiYm94LnkpIC8gZ3JpZEhlaWdodCksIDEpICogZ3JpZEhlaWdodDsKCiAgICAgICAgdmFyIHR4ID0gMDsKICAgICAgICB2YXIgdHkgPSAwOwoKICAgICAgICBpZiAob3B0LmZpdE5lZ2F0aXZlKSB7CgogICAgICAgICAgICBpZiAoYmJveC54IDwgMCkgewogICAgICAgICAgICAgICAgdHggPSBNYXRoLmNlaWwoLWJib3gueCAvIGdyaWRXaWR0aCkgKiBncmlkV2lkdGg7CiAgICAgICAgICAgICAgICBjYWxjV2lkdGggKz0gdHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYm94LnkgPCAwKSB7CiAgICAgICAgICAgICAgICB0eSA9IE1hdGguY2VpbCgtYmJveC55IC8gZ3JpZEhlaWdodCkgKiBncmlkSGVpZ2h0OwogICAgICAgICAgICAgICAgY2FsY0hlaWdodCArPSB0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2FsY1dpZHRoICs9IHBhZGRpbmc7CiAgICAgICAgY2FsY0hlaWdodCArPSBwYWRkaW5nOwoKICAgICAgICB2YXIgZGltZW5zaW9uQ2hhbmdlID0gY2FsY1dpZHRoICE9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjYWxjSGVpZ2h0ICE9IHRoaXMub3B0aW9ucy5oZWlnaHQ7CiAgICAgICAgdmFyIG9yaWdpbkNoYW5nZSA9IG9wdC5maXROZWdhdGl2ZSAmJiAodHggIT0gdGhpcy5vcHRpb25zLm9yaWdpbi54IHx8IHR5ICE9IHRoaXMub3B0aW9ucy5vcmlnaW4ueSk7CgoJLy8gQ2hhbmdlIHRoZSBkaW1lbnNpb25zIG9ubHkgaWYgdGhlcmUgaXMgYSBzaXplIGRpc2NyZXBlbmN5IG9yIGFuIG9yaWdpbiBjaGFuZ2UKICAgICAgICBpZiAob3JpZ2luQ2hhbmdlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0T3JpZ2luKHR4LCB0eSk7CiAgICAgICAgfQoJaWYgKGRpbWVuc2lvbkNoYW5nZSkgewoJICAgIHRoaXMuc2V0RGltZW5zaW9ucyhjYWxjV2lkdGgsIGNhbGNIZWlnaHQpOwoJfQogICAgfSwKCiAgICBzY2FsZUNvbnRlbnRUb0ZpdDogZnVuY3Rpb24ob3B0KSB7CgogICAgICAgIHZhciBjb250ZW50QkJveCA9IHRoaXMuZ2V0Q29udGVudEJCb3goKTsKCiAgICAgICAgaWYgKCFjb250ZW50QkJveC53aWR0aCB8fCAhY29udGVudEJCb3guaGVpZ2h0KSByZXR1cm47CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgXy5kZWZhdWx0cyhvcHQsIHsKICAgICAgICAgICAgcGFkZGluZzogMCwKICAgICAgICAgICAgcHJlc2VydmVBc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgICAgc2NhbGVHcmlkOiBudWxsLAogICAgICAgICAgICBtaW5TY2FsZTogMCwKICAgICAgICAgICAgbWF4U2NhbGU6IE51bWJlci5NQVhfVkFMVUUKICAgICAgICAgICAgLy9taW5TY2FsZVgKICAgICAgICAgICAgLy9taW5TY2FsZVkKICAgICAgICAgICAgLy9tYXhTY2FsZVgKICAgICAgICAgICAgLy9tYXhTY2FsZVkKICAgICAgICAgICAgLy9maXR0aW5nQkJveAogICAgICAgIH0pOwoKICAgICAgICB2YXIgcGFkZGluZyA9IG9wdC5wYWRkaW5nOwoKICAgICAgICB2YXIgbWluU2NhbGVYID0gb3B0Lm1pblNjYWxlWCB8fCBvcHQubWluU2NhbGU7CiAgICAgICAgdmFyIG1heFNjYWxlWCA9IG9wdC5tYXhTY2FsZVggfHwgb3B0Lm1heFNjYWxlOwogICAgICAgIHZhciBtaW5TY2FsZVkgPSBvcHQubWluU2NhbGVZIHx8IG9wdC5taW5TY2FsZTsKICAgICAgICB2YXIgbWF4U2NhbGVZID0gb3B0Lm1heFNjYWxlWSB8fCBvcHQubWF4U2NhbGU7CgogICAgICAgIHZhciBmaXR0aW5nQkJveCA9IG9wdC5maXR0aW5nQkJveCB8fCAoewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwLAogICAgICAgICAgICB3aWR0aDogdGhpcy5vcHRpb25zLndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHRoaXMub3B0aW9ucy5oZWlnaHQKICAgICAgICB9KTsKCiAgICAgICAgZml0dGluZ0JCb3ggPSBnLnJlY3QoZml0dGluZ0JCb3gpLm1vdmVBbmRFeHBhbmQoewogICAgICAgICAgICB4OiBwYWRkaW5nLAogICAgICAgICAgICB5OiBwYWRkaW5nLAogICAgICAgICAgICB3aWR0aDogLTIgKiBwYWRkaW5nLAogICAgICAgICAgICBoZWlnaHQ6IC0yICogcGFkZGluZwogICAgICAgIH0pOwoKICAgICAgICB2YXIgY3VycmVudFNjYWxlID0gVih0aGlzLnZpZXdwb3J0KS5zY2FsZSgpOwoKICAgICAgICB2YXIgbmV3U3ggPSBmaXR0aW5nQkJveC53aWR0aCAvIGNvbnRlbnRCQm94LndpZHRoICogY3VycmVudFNjYWxlLnN4OwogICAgICAgIHZhciBuZXdTeSA9IGZpdHRpbmdCQm94LmhlaWdodCAvIGNvbnRlbnRCQm94LmhlaWdodCAqIGN1cnJlbnRTY2FsZS5zeTsKCiAgICAgICAgaWYgKG9wdC5wcmVzZXJ2ZUFzcGVjdFJhdGlvKSB7CiAgICAgICAgICAgIG5ld1N4ID0gbmV3U3kgPSBNYXRoLm1pbihuZXdTeCwgbmV3U3kpOwogICAgICAgIH0KCiAgICAgICAgLy8gc25hcCBzY2FsZSB0byBhIGdyaWQKICAgICAgICBpZiAob3B0LnNjYWxlR3JpZCkgewoKICAgICAgICAgICAgdmFyIGdyaWRTaXplID0gb3B0LnNjYWxlR3JpZDsKCiAgICAgICAgICAgIG5ld1N4ID0gZ3JpZFNpemUgKiBNYXRoLmZsb29yKG5ld1N4IC8gZ3JpZFNpemUpOwogICAgICAgICAgICBuZXdTeSA9IGdyaWRTaXplICogTWF0aC5mbG9vcihuZXdTeSAvIGdyaWRTaXplKTsKICAgICAgICB9CgogICAgICAgIC8vIHNjYWxlIG1pbi9tYXggYm91bmRhcmllcwogICAgICAgIG5ld1N4ID0gTWF0aC5taW4obWF4U2NhbGVYLCBNYXRoLm1heChtaW5TY2FsZVgsIG5ld1N4KSk7CiAgICAgICAgbmV3U3kgPSBNYXRoLm1pbihtYXhTY2FsZVksIE1hdGgubWF4KG1pblNjYWxlWSwgbmV3U3kpKTsKCiAgICAgICAgdGhpcy5zY2FsZShuZXdTeCwgbmV3U3kpOwoKICAgICAgICB2YXIgY29udGVudFRyYW5zbGF0aW9uID0gdGhpcy5nZXRDb250ZW50QkJveCgpOwoKICAgICAgICB2YXIgbmV3T3ggPSBmaXR0aW5nQkJveC54IC0gY29udGVudFRyYW5zbGF0aW9uLng7CiAgICAgICAgdmFyIG5ld095ID0gZml0dGluZ0JCb3gueSAtIGNvbnRlbnRUcmFuc2xhdGlvbi55OwoKICAgICAgICB0aGlzLnNldE9yaWdpbihuZXdPeCwgbmV3T3kpOwogICAgfSwKCiAgICBnZXRDb250ZW50QkJveDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBjcmVjdCA9IHRoaXMudmlld3BvcnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICAgIC8vIFVzaW5nIFNjcmVlbiBDVE0gd2FzIHRoZSBvbmx5IHdheSB0byBnZXQgdGhlIHJlYWwgdmlld3BvcnQgYm91bmRpbmcgYm94IHdvcmtpbmcgaW4gYm90aAogICAgICAgIC8vIEdvb2dsZSBDaHJvbWUgYW5kIEZpcmVmb3guCiAgICAgICAgdmFyIHNjcmVlbkNUTSA9IHRoaXMudmlld3BvcnQuZ2V0U2NyZWVuQ1RNKCk7CgogICAgICAgIC8vIGZvciBub24tZGVmYXVsdCBvcmlnaW4gd2UgbmVlZCB0byB0YWtlIHRoZSB2aWV3cG9ydCB0cmFuc2xhdGlvbiBpbnRvIGFjY291bnQKICAgICAgICB2YXIgdmlld3BvcnRDVE0gPSB0aGlzLnZpZXdwb3J0LmdldENUTSgpOwoKICAgICAgICB2YXIgYmJveCA9IGcucmVjdCh7CiAgICAgICAgICAgIHg6IGNyZWN0LmxlZnQgLSBzY3JlZW5DVE0uZSArIHZpZXdwb3J0Q1RNLmUsCiAgICAgICAgICAgIHk6IGNyZWN0LnRvcCAtIHNjcmVlbkNUTS5mICsgdmlld3BvcnRDVE0uZiwKICAgICAgICAgICAgd2lkdGg6IGNyZWN0LndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IGNyZWN0LmhlaWdodAogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gYmJveDsKICAgIH0sCgogICAgY3JlYXRlVmlld0Zvck1vZGVsOiBmdW5jdGlvbihjZWxsKSB7CgogICAgICAgIHZhciB2aWV3OwogICAgICAgIAogICAgICAgIHZhciB0eXBlID0gY2VsbC5nZXQoJ3R5cGUnKTsKICAgICAgICB2YXIgbW9kdWxlID0gdHlwZS5zcGxpdCgnLicpWzBdOwogICAgICAgIHZhciBlbnRpdHkgPSB0eXBlLnNwbGl0KCcuJylbMV07CgogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgc3BlY2lhbCB2aWV3IGRlZmluZWQgZm9yIHRoaXMgbW9kZWwsIHVzZSB0aGF0IG9uZSBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IGBlbGVtZW50Vmlld2AvYGxpbmtWaWV3YC4KICAgICAgICBpZiAoam9pbnQuc2hhcGVzW21vZHVsZV0gJiYgam9pbnQuc2hhcGVzW21vZHVsZV1bZW50aXR5ICsgJ1ZpZXcnXSkgewoKICAgICAgICAgICAgdmlldyA9IG5ldyBqb2ludC5zaGFwZXNbbW9kdWxlXVtlbnRpdHkgKyAnVmlldyddKHsgbW9kZWw6IGNlbGwsIGludGVyYWN0aXZlOiB0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgfSk7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSBpZiAoY2VsbCBpbnN0YW5jZW9mIGpvaW50LmRpYS5FbGVtZW50KSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdmlldyA9IG5ldyB0aGlzLm9wdGlvbnMuZWxlbWVudFZpZXcoeyBtb2RlbDogY2VsbCwgaW50ZXJhY3RpdmU6IHRoaXMub3B0aW9ucy5pbnRlcmFjdGl2ZSB9KTsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHZpZXcgPSBuZXcgdGhpcy5vcHRpb25zLmxpbmtWaWV3KHsgbW9kZWw6IGNlbGwsIGludGVyYWN0aXZlOiB0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAKICAgIGFkZENlbGw6IGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmNyZWF0ZVZpZXdGb3JNb2RlbChjZWxsKTsKCiAgICAgICAgVih0aGlzLnZpZXdwb3J0KS5hcHBlbmQodmlldy5lbCk7CiAgICAgICAgdmlldy5wYXBlciA9IHRoaXM7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKCiAgICAgICAgLy8gVGhpcyBpcyB0aGUgb25seSB3YXkgdG8gcHJldmVudCBpbWFnZSBkcmFnZ2luZyBpbiBGaXJlZm94IHRoYXQgd29ya3MuCiAgICAgICAgLy8gU2V0dGluZyAtbW96LXVzZXItc2VsZWN0OiBub25lLCBkcmFnZ2FibGU9ImZhbHNlIiBhdHRyaWJ1dGUgb3IgdXNlci1kcmFnOiBub25lIGRpZG4ndCBoZWxwLgogICAgICAgICQodmlldy5lbCkuZmluZCgnaW1hZ2UnKS5vbignZHJhZ3N0YXJ0JywgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICB9LAoKICAgIHJlc2V0Q2VsbHM6IGZ1bmN0aW9uKGNlbGxzQ29sbGVjdGlvbikgewoKICAgICAgICAkKHRoaXMudmlld3BvcnQpLmVtcHR5KCk7CgogICAgICAgIHZhciBjZWxscyA9IGNlbGxzQ29sbGVjdGlvbi5tb2RlbHMuc2xpY2UoKTsKCiAgICAgICAgLy8gTWFrZSBzdXJlIGxpbmtzIGFyZSBhbHdheXMgYWRkZWQgQUZURVIgZWxlbWVudHMuCiAgICAgICAgLy8gVGhleSB3b3VsZG4ndCBmaW5kIHRoZWlyIHNvdXJjZXMvdGFyZ2V0cyBpbiB0aGUgRE9NIG90aGVyd2lzZS4KICAgICAgICBjZWxscy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluayA/IDEgOiAtMTsgfSk7CiAgICAgICAgCglpZiAodGhpcy5fZnJhbWVJZCkgewoJICAgIGpvaW50LnV0aWwuY2FuY2VsRnJhbWUodGhpcy5fZnJhbWVJZCk7Cgl9CglpZiAodGhpcy5vcHRpb25zLmFzeW5jKSB7CgoJICAgIHRoaXMuYXN5bmNSZW5kZXJDZWxscyhjZWxscyk7CgoJfSBlbHNlIHsKCiAgICAgICAgICAgIF8uZWFjaChjZWxscywgdGhpcy5hZGRDZWxsLCB0aGlzKTsKCX0KCiAgICAgICAgLy8gU29ydCB0aGUgY2VsbHMgaW4gdGhlIERPTSBtYW51YWxseSBhcyB3ZSBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIG9yZGVyIHRoZXkKICAgICAgICAvLyB3ZXJlIGFkZGVkIHRvIHRoZSBET00gKHNlZSBhYm92ZSkuCiAgICAgICAgdGhpcy5zb3J0Q2VsbHMoKTsKICAgIH0sCgogICAgYXN5bmNSZW5kZXJDZWxsczogZnVuY3Rpb24oY2VsbHMpIHsKCiAgICAgICAgdmFyIGRvbmUgPSBmYWxzZTsKCiAgICAgICAgXy5lYWNoKF8ucmFuZ2UodGhpcy5vcHRpb25zLmFzeW5jICYmIHRoaXMub3B0aW9ucy5hc3luYy5iYXRjaFNpemUgfHwgNTApLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBjZWxsID0gY2VsbHMuc2hpZnQoKTsKCSAgICBkb25lID0gIWNlbGw7CiAgICAgICAgICAgIGlmICghZG9uZSkgdGhpcy5hZGRDZWxsKGNlbGwpOwoKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgaWYgKGRvbmUpIHsKCgkgICAgdGhpcy50cmlnZ2VyKCdyZW5kZXI6ZG9uZScpOwoKCX0gZWxzZSB7CgogICAgICAgICAgICB0aGlzLl9mcmFtZUlkID0gam9pbnQudXRpbC5uZXh0RnJhbWUoXy5iaW5kKGZ1bmN0aW9uKCkgewoJCXRoaXMuYXN5bmNSZW5kZXJDZWxscyhjZWxscyk7CgkgICAgfSwgdGhpcykpOwogICAgICAgIH0KICAgIH0sCgogICAgc29ydENlbGxzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgLy8gUnVuIGluc2VydGlvbiBzb3J0IGFsZ29yaXRobSBpbiBvcmRlciB0byBlZmZpY2llbnRseSBzb3J0IERPTSBlbGVtZW50cyBhY2NvcmRpbmcgdG8gdGhlaXIKICAgICAgICAvLyBhc3NvY2lhdGVkIG1vZGVsIGB6YCBhdHRyaWJ1dGUuCgogICAgICAgIHZhciAkY2VsbHMgPSAkKHRoaXMudmlld3BvcnQpLmNoaWxkcmVuKCdbbW9kZWwtaWRdJyk7CiAgICAgICAgdmFyIGNlbGxzID0gdGhpcy5tb2RlbC5nZXQoJ2NlbGxzJyk7CgogICAgICAgIHRoaXMuc29ydEVsZW1lbnRzKCRjZWxscywgZnVuY3Rpb24oYSwgYikgewoKICAgICAgICAgICAgdmFyIGNlbGxBID0gY2VsbHMuZ2V0KCQoYSkuYXR0cignbW9kZWwtaWQnKSk7CiAgICAgICAgICAgIHZhciBjZWxsQiA9IGNlbGxzLmdldCgkKGIpLmF0dHIoJ21vZGVsLWlkJykpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIChjZWxsQS5nZXQoJ3onKSB8fCAwKSA+IChjZWxsQi5nZXQoJ3onKSB8fCAwKSA/IDEgOiAtMTsKICAgICAgICB9KTsKICAgIH0sCgogICAgLy8gSGlnaGx5IGluc3BpcmVkIGJ5IHRoZSBqcXVlcnkuc29ydEVsZW1lbnRzIHBsdWdpbiBieSBQYWRvbHNleS4KICAgIC8vIFNlZSBodHRwOi8vamFtZXMucGFkb2xzZXkuY29tL2phdmFzY3JpcHQvc29ydGluZy1lbGVtZW50cy13aXRoLWpxdWVyeS8uCiAgICBzb3J0RWxlbWVudHM6IGZ1bmN0aW9uKGVsZW1lbnRzLCBjb21wYXJhdG9yKSB7CgogICAgICAgIHZhciAkZWxlbWVudHMgPSAkKGVsZW1lbnRzKTsKICAgICAgICAKICAgICAgICB2YXIgcGxhY2VtZW50cyA9ICRlbGVtZW50cy5tYXAoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc29ydEVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHNvcnRFbGVtZW50LnBhcmVudE5vZGU7CgogICAgICAgICAgICAvLyBTaW5jZSB0aGUgZWxlbWVudCBpdHNlbGYgd2lsbCBjaGFuZ2UgcG9zaXRpb24sIHdlIGhhdmUKICAgICAgICAgICAgLy8gdG8gaGF2ZSBzb21lIHdheSBvZiBzdG9yaW5nIGl0J3Mgb3JpZ2luYWwgcG9zaXRpb24gaW4KICAgICAgICAgICAgLy8gdGhlIERPTS4gVGhlIGVhc2llc3Qgd2F5IGlzIHRvIGhhdmUgYSAnZmxhZycgbm9kZToKICAgICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoCiAgICAgICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnJyksCiAgICAgICAgICAgICAgICBzb3J0RWxlbWVudC5uZXh0U2libGluZwogICAgICAgICAgICApOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAgICAgIllvdSBjYW4ndCBzb3J0IGVsZW1lbnRzIGlmIGFueSBvbmUgaXMgYSBkZXNjZW5kYW50IG9mIGFub3RoZXIuIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEluc2VydCBiZWZvcmUgZmxhZzoKICAgICAgICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBmbGFnOgogICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zb3J0LmNhbGwoJGVsZW1lbnRzLCBjb21wYXJhdG9yKS5lYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgcGxhY2VtZW50c1tpXS5jYWxsKHRoaXMpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5LCBveCwgb3kpIHsKCiAgICAgICAgc3kgPSBzeSB8fCBzeDsKCiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQob3gpKSB7CgogICAgICAgICAgICBveCA9IDA7CiAgICAgICAgICAgIG95ID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBwcmV2aW91cyB0cmFuc2Zvcm0gc28gdGhhdCB0aGUgbmV3IHNjYWxlIGlzIG5vdCBhZmZlY3RlZCBieSBwcmV2aW91cyBzY2FsZXMsIGVzcGVjaWFsbHkKICAgICAgICAvLyB0aGUgb2xkIHRyYW5zbGF0ZSgpIGRvZXMgbm90IGFmZmVjdCB0aGUgbmV3IHRyYW5zbGF0ZSBpZiBhbiBvcmlnaW4gaXMgc3BlY2lmaWVkLgogICAgICAgIFYodGhpcy52aWV3cG9ydCkuYXR0cigndHJhbnNmb3JtJywgJycpOwoKICAgICAgICB2YXIgb2xkVHggPSB0aGlzLm9wdGlvbnMub3JpZ2luLng7CiAgICAgICAgdmFyIG9sZFR5ID0gdGhpcy5vcHRpb25zLm9yaWdpbi55OwoKICAgICAgICAvLyBUT0RPOiBWLnNjYWxlKCkgZG9lc24ndCBzdXBwb3J0IHNldHRpbmcgc2NhbGUgb3JpZ2luLiAjRml4ICAgICAgICAKICAgICAgICBpZiAob3ggfHwgb3kgfHwgb2xkVHggfHwgb2xkVHkpIHsKCiAgICAgICAgICAgIHZhciBuZXdUeCA9IG9sZFR4IC0gb3ggKiAoc3ggLSAxKTsKICAgICAgICAgICAgdmFyIG5ld1R5ID0gb2xkVHkgLSBveSAqIChzeSAtIDEpOwoKICAgICAgICAgICAgaWYgKG5ld1R4ICE9IG9sZFR4IHx8IG5ld1R5ICE9IG9sZFR5KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldE9yaWdpbihuZXdUeCwgbmV3VHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBWKHRoaXMudmlld3BvcnQpLnNjYWxlKHN4LCBzeSk7CgoJdGhpcy50cmlnZ2VyKCdzY2FsZScsIHN4LCBzeSwgb3gsIG95KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJvdGF0ZTogZnVuY3Rpb24oZGVnLCBveCwgb3kpIHsKICAgICAgICAKICAgICAgICAvLyBJZiB0aGUgb3JpZ2luIGlzIG5vdCBzZXQgZXhwbGljaXRlbHksIHJvdGF0ZSBhcm91bmQgdGhlIGNlbnRlci4gTm90ZSB0aGF0CiAgICAgICAgLy8gd2UgbXVzdCB1c2UgdGhlIHBsYWluIGJvdW5kaW5nIGJveCAoYHRoaXMuZWwuZ2V0QkJveCgpYCBpbnN0ZWFkIG9mIHRoZSBvbmUgdGhhdCBnaXZlcyB1cwogICAgICAgIC8vIHRoZSByZWFsIGJvdW5kaW5nIGJveCAoYGJib3goKWApIGluY2x1ZGluZyB0cmFuc2Zvcm1hdGlvbnMpLgogICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKG94KSkgewoKICAgICAgICAgICAgdmFyIGJib3ggPSB0aGlzLnZpZXdwb3J0LmdldEJCb3goKTsKICAgICAgICAgICAgb3ggPSBiYm94LndpZHRoLzI7CiAgICAgICAgICAgIG95ID0gYmJveC5oZWlnaHQvMjsKICAgICAgICB9CgogICAgICAgIFYodGhpcy52aWV3cG9ydCkucm90YXRlKGRlZywgb3gsIG95KTsKICAgIH0sCgogICAgLy8gRmluZCB0aGUgZmlyc3QgdmlldyBjbGltYmluZyB1cCB0aGUgRE9NIHRyZWUgc3RhcnRpbmcgYXQgZWxlbWVudCBgZWxgLiBOb3RlIHRoYXQgYGVsYCBjYW4gYWxzbwogICAgLy8gYmUgYSBzZWxlY3RvciBvciBhIGpRdWVyeSBvYmplY3QuCiAgICBmaW5kVmlldzogZnVuY3Rpb24oZWwpIHsKCiAgICAgICAgdmFyICRlbCA9IHRoaXMuJChlbCk7CgogICAgICAgIGlmICgkZWwubGVuZ3RoID09PSAwIHx8ICRlbFswXSA9PT0gdGhpcy5lbCkgewoKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGlmICgkZWwuZGF0YSgndmlldycpKSB7CgogICAgICAgICAgICByZXR1cm4gJGVsLmRhdGEoJ3ZpZXcnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmZpbmRWaWV3KCRlbC5wYXJlbnQoKSk7CiAgICB9LAoKICAgIC8vIEZpbmQgYSB2aWV3IGZvciBhIG1vZGVsIGBjZWxsYC4gYGNlbGxgIGNhbiBhbHNvIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBhIG1vZGVsIGBpZGAuCiAgICBmaW5kVmlld0J5TW9kZWw6IGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgdmFyIGlkID0gXy5pc1N0cmluZyhjZWxsKSA/IGNlbGwgOiBjZWxsLmlkOwogICAgICAgIAogICAgICAgIHZhciAkdmlldyA9IHRoaXMuJCgnW21vZGVsLWlkPSInICsgaWQgKyAnIl0nKTsKICAgICAgICBpZiAoJHZpZXcubGVuZ3RoKSB7CgogICAgICAgICAgICByZXR1cm4gJHZpZXcuZGF0YSgndmlldycpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBhdCBnaXZlbiBwb2ludAogICAgZmluZFZpZXdzRnJvbVBvaW50OiBmdW5jdGlvbihwKSB7CgoJcCA9IGcucG9pbnQocCk7CgogICAgICAgIHZhciB2aWV3cyA9IF8ubWFwKHRoaXMubW9kZWwuZ2V0RWxlbWVudHMoKSwgdGhpcy5maW5kVmlld0J5TW9kZWwpOwoKCXJldHVybiBfLmZpbHRlcih2aWV3cywgZnVuY3Rpb24odmlldykgewoJICAgIHJldHVybiBnLnJlY3QoVih2aWV3LmVsKS5iYm94KGZhbHNlLCB0aGlzLnZpZXdwb3J0KSkuY29udGFpbnNQb2ludChwKTsKCX0sIHRoaXMpOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBpbiBnaXZlbiBhcmVhCiAgICBmaW5kVmlld3NJbkFyZWE6IGZ1bmN0aW9uKHIpIHsKCglyID0gZy5yZWN0KHIpOwoKICAgICAgICB2YXIgdmlld3MgPSBfLm1hcCh0aGlzLm1vZGVsLmdldEVsZW1lbnRzKCksIHRoaXMuZmluZFZpZXdCeU1vZGVsKTsKCglyZXR1cm4gXy5maWx0ZXIodmlld3MsIGZ1bmN0aW9uKHZpZXcpIHsKCSAgICByZXR1cm4gci5pbnRlcnNlY3QoZy5yZWN0KFYodmlldy5lbCkuYmJveChmYWxzZSwgdGhpcy52aWV3cG9ydCkpKTsKCX0sIHRoaXMpOwogICAgfSwKCiAgICBnZXRNb2RlbEJ5SWQ6IGZ1bmN0aW9uKGlkKSB7CgogICAgICAgIHJldHVybiB0aGlzLm1vZGVsLmdldENlbGwoaWQpOwogICAgfSwKCiAgICBzbmFwVG9HcmlkOiBmdW5jdGlvbihwKSB7CgogICAgICAgIC8vIENvbnZlcnQgZ2xvYmFsIGNvb3JkaW5hdGVzIHRvIHRoZSBsb2NhbCBvbmVzIG9mIHRoZSBgdmlld3BvcnRgLiBPdGhlcndpc2UsCiAgICAgICAgLy8gaW1wcm9wZXIgdHJhbnNmb3JtYXRpb24gd291bGQgYmUgYXBwbGllZCB3aGVuIHRoZSB2aWV3cG9ydCBnZXRzIHRyYW5zZm9ybWVkIChzY2FsZWQvcm90YXRlZCkuIAogICAgICAgIHZhciBsb2NhbFBvaW50ID0gVih0aGlzLnZpZXdwb3J0KS50b0xvY2FsUG9pbnQocC54LCBwLnkpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBnLnNuYXBUb0dyaWQobG9jYWxQb2ludC54LCB0aGlzLm9wdGlvbnMuZ3JpZFNpemUpLAogICAgICAgICAgICB5OiBnLnNuYXBUb0dyaWQobG9jYWxQb2ludC55LCB0aGlzLm9wdGlvbnMuZ3JpZFNpemUpCiAgICAgICAgfTsKICAgIH0sCgogICAgZ2V0RGVmYXVsdExpbms6IGZ1bmN0aW9uKGNlbGxWaWV3LCBtYWduZXQpIHsKCiAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmspCiAgICAgICAgLy8gZGVmYXVsdCBsaW5rIGlzIGEgZnVuY3Rpb24gcHJvZHVjaW5nIGxpbmsgbW9kZWwKICAgICAgICAgICAgPyB0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmsuY2FsbCh0aGlzLCBjZWxsVmlldywgbWFnbmV0KQogICAgICAgIC8vIGRlZmF1bHQgbGluayBpcyB0aGUgQmFja2JvbmUgbW9kZWwKICAgICAgICAgICAgOiB0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmsuY2xvbmUoKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uCiAgICAvLyAtLS0tLS0tLS0tLS0KCiAgICBtb3VzZWRibGNsaWNrOiBmdW5jdGlvbihldnQpIHsKICAgICAgICAKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldnQgPSBqb2ludC51dGlsLm5vcm1hbGl6ZUV2ZW50KGV2dCk7CiAgICAgICAgCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmZpbmRWaWV3KGV2dC50YXJnZXQpOwogICAgICAgIHZhciBsb2NhbFBvaW50ID0gdGhpcy5zbmFwVG9HcmlkKHsgeDogZXZ0LmNsaWVudFgsIHk6IGV2dC5jbGllbnRZIH0pOwoKICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICAKICAgICAgICAgICAgdmlldy5wb2ludGVyZGJsY2xpY2soZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JsYW5rOnBvaW50ZXJkYmxjbGljaycsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgbW91c2VjbGljazogZnVuY3Rpb24oZXZ0KSB7CgogICAgICAgIC8vIFRyaWdnZXIgZXZlbnQgd2hlbiBtb3VzZSBub3QgbW92ZWQuCiAgICAgICAgaWYgKCF0aGlzLl9tb3VzZW1vdmVkKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwoKICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmZpbmRWaWV3KGV2dC50YXJnZXQpOwogICAgICAgICAgICB2YXIgbG9jYWxQb2ludCA9IHRoaXMuc25hcFRvR3JpZCh7IHg6IGV2dC5jbGllbnRYLCB5OiBldnQuY2xpZW50WSB9KTsKCiAgICAgICAgICAgIGlmICh2aWV3KSB7CgogICAgICAgICAgICAgICAgdmlldy5wb2ludGVyY2xpY2soZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JsYW5rOnBvaW50ZXJjbGljaycsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gZmFsc2U7CiAgICB9LAoKICAgIHBvaW50ZXJkb3duOiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwogICAgICAgIAogICAgICAgIHZhciB2aWV3ID0gdGhpcy5maW5kVmlldyhldnQudGFyZ2V0KTsKCiAgICAgICAgdmFyIGxvY2FsUG9pbnQgPSB0aGlzLnNuYXBUb0dyaWQoeyB4OiBldnQuY2xpZW50WCwgeTogZXZ0LmNsaWVudFkgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHZpZXcpIHsKCiAgICAgICAgICAgIHRoaXMuc291cmNlVmlldyA9IHZpZXc7CgogICAgICAgICAgICB2aWV3LnBvaW50ZXJkb3duKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdibGFuazpwb2ludGVyZG93bicsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcm1vdmU6IGZ1bmN0aW9uKGV2dCkgewoKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldnQgPSBqb2ludC51dGlsLm5vcm1hbGl6ZUV2ZW50KGV2dCk7CgogICAgICAgIGlmICh0aGlzLnNvdXJjZVZpZXcpIHsKCiAgICAgICAgICAgIC8vIE1vdXNlIG1vdmVkLgogICAgICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gdHJ1ZTsKCiAgICAgICAgICAgIHZhciBsb2NhbFBvaW50ID0gdGhpcy5zbmFwVG9HcmlkKHsgeDogZXZ0LmNsaWVudFgsIHk6IGV2dC5jbGllbnRZIH0pOwoKICAgICAgICAgICAgdGhpcy5zb3VyY2VWaWV3LnBvaW50ZXJtb3ZlKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcnVwOiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwoKICAgICAgICB2YXIgbG9jYWxQb2ludCA9IHRoaXMuc25hcFRvR3JpZCh7IHg6IGV2dC5jbGllbnRYLCB5OiBldnQuY2xpZW50WSB9KTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5zb3VyY2VWaWV3KSB7CgogICAgICAgICAgICB0aGlzLnNvdXJjZVZpZXcucG9pbnRlcnVwKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwoKICAgICAgICAgICAgLy8iZGVsZXRlIHNvdXJjZVZpZXciIG9jY2FzaW9uYWxseSB0aHJvd3MgYW4gZXJyb3IgaW4gY2hyb21lIChpbGxlZ2FsIGFjY2VzcyBleGNlcHRpb24pCgkgICAgdGhpcy5zb3VyY2VWaWV3ID0gbnVsbDsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignYmxhbms6cG9pbnRlcnVwJywgZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgfQogICAgfQp9KTsKCgovLyAgICAgIEpvaW50SlMgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczoge30sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnQ6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnQsCiAgICAgICAgICAgIEVsZW1lbnRWaWV3OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50VmlldwogICAgICAgIH0KICAgIH07CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKam9pbnQuc2hhcGVzLmJhc2ljID0ge307CgoKam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgICAgICAKICAgICAgICB0eXBlOiAnYmFzaWMuR2VuZXJpYycsCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy4nOiB7IGZpbGw6ICcjRkZGRkZGJywgc3Ryb2tlOiAnbm9uZScgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LmRpYS5FbGVtZW50LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuUmVjdCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cmVjdC8+PC9nPjx0ZXh0Lz48L2c+JywKICAgIAogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewogICAgCiAgICAgICAgdHlwZTogJ2Jhc2ljLlJlY3QnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdyZWN0JzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJywgd2lkdGg6IDEwMCwgaGVpZ2h0OiA2MCB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3JlZi14JzogLjUsICdyZWYteSc6IC41LCByZWY6ICdyZWN0JywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsICd4LWFsaWdubWVudCc6ICdtaWRkbGUnLCBmaWxsOiAnYmxhY2snLCAnZm9udC1mYW1pbHknOiAnQXJpYWwsIGhlbHZldGljYSwgc2Fucy1zZXJpZicgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuVGV4dCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48dGV4dC8+PC9nPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgCiAgICAgICAgdHlwZTogJ2Jhc2ljLlRleHQnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICd0ZXh0JzogeyAnZm9udC1zaXplJzogMTgsIGZpbGw6ICdibGFjaycgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxjaXJjbGUvPjwvZz48dGV4dC8+PC9nPicsCiAgICAKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2Jhc2ljLkNpcmNsZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNjAsIGhlaWdodDogNjAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnY2lyY2xlJzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJywgcjogMzAsIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgzMCwgMzApJyB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLXknOiAuNSwgcmVmOiAnY2lyY2xlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsIGZpbGw6ICdibGFjaycsICdmb250LWZhbWlseSc6ICdBcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5iYXNpYy5JbWFnZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48aW1hZ2UvPjwvZz48dGV4dC8+PC9nPicsCiAgICAKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2Jhc2ljLkltYWdlJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLWR5JzogMjAsIHJlZjogJ2ltYWdlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsIGZpbGw6ICdibGFjaycsICdmb250LWZhbWlseSc6ICdBcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5iYXNpYy5QYXRoID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxwYXRoLz48L2c+PHRleHQvPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdiYXNpYy5QYXRoJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA2MCwgaGVpZ2h0OiA2MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdwYXRoJzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJyB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLWR5JzogMjAsIHJlZjogJ3BhdGgnLCAneS1hbGlnbm1lbnQnOiAnbWlkZGxlJywgZmlsbDogJ2JsYWNrJywgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWYnIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmJhc2ljLlJob21idXMgPSBqb2ludC5zaGFwZXMuYmFzaWMuUGF0aC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgIAogICAgICAgIHR5cGU6ICdiYXNpYy5SaG9tYnVzJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAncGF0aCc6IHsgZDogJ00gMzAgMCBMIDYwIDMwIDMwIDYwIDAgMzAgeicgfSwKICAgICAgICAgICAgJ3RleHQnOiB7ICdyZWYteSc6IC41IH0KICAgICAgICB9CiAgICAgICAgCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuUGF0aC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKCi8vIFBvcnRzTW9kZWxJbnRlcmZhY2UgaXMgYSBjb21tb24gaW50ZXJmYWNlIGZvciBzaGFwZXMgdGhhdCBoYXZlIHBvcnRzLiBUaGlzIGludGVyZmFjZSBtYWtlcyBpdCBlYXN5Ci8vIHRvIGNyZWF0ZSBuZXcgc2hhcGVzIHdpdGggcG9ydHMgZnVuY3Rpb25hbGl0eS4gSXQgaXMgYXNzdW1lZCB0aGF0IHRoZSBuZXcgc2hhcGVzIGhhdmUKLy8gYGluUG9ydHNgIGFuZCBgb3V0UG9ydHNgIGFycmF5IHByb3BlcnRpZXMuIE9ubHkgdGhlc2UgcHJvcGVydGllcyBzaG91bGQgYmUgdXNlZCB0byBzZXQgcG9ydHMuCi8vIEluIG90aGVyIHdvcmRzLCB1c2luZyB0aGlzIGludGVyZmFjZSwgaXQgaXMgbm8gbG9uZ2VyIHJlY29tbWVuZGVkIHRvIHNldCBwb3J0cyBkaXJlY3RseSB0aHJvdWdoIHRoZQovLyBgYXR0cnNgIG9iamVjdC4KCi8vIFVzYWdlOgovLyBqb2ludC5zaGFwZXMuY3VzdG9tLk15RWxlbWVudFdpdGhQb3J0cyA9IGpvaW50LnNoYXBlcy5iYXNpYy5QYXRoLmV4dGVuZChfLmV4dGVuZCh7fSwgam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UsIHsKLy8gICAgIGdldFBvcnRBdHRyczogZnVuY3Rpb24ocG9ydE5hbWUsIGluZGV4LCB0b3RhbCwgc2VsZWN0b3IsIHR5cGUpIHsKLy8gICAgICAgICB2YXIgYXR0cnMgPSB7fTsKLy8gICAgICAgICB2YXIgcG9ydENsYXNzID0gJ3BvcnQnICsgaW5kZXg7Ci8vICAgICAgICAgdmFyIHBvcnRTZWxlY3RvciA9IHNlbGVjdG9yICsgJz4uJyArIHBvcnRDbGFzczsKLy8gICAgICAgICB2YXIgcG9ydFRleHRTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+dGV4dCc7Ci8vICAgICAgICAgdmFyIHBvcnRDaXJjbGVTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+Y2lyY2xlJzsKLy8KLy8gICAgICAgICBhdHRyc1twb3J0VGV4dFNlbGVjdG9yXSA9IHsgdGV4dDogcG9ydE5hbWUgfTsKLy8gICAgICAgICBhdHRyc1twb3J0Q2lyY2xlU2VsZWN0b3JdID0geyBwb3J0OiB7IGlkOiBwb3J0TmFtZSB8fCBfLnVuaXF1ZUlkKHR5cGUpICwgdHlwZTogdHlwZSB9IH07Ci8vICAgICAgICAgYXR0cnNbcG9ydFNlbGVjdG9yXSA9IHsgcmVmOiAncmVjdCcsICdyZWYteSc6IChpbmRleCArIDAuNSkgKiAoMSAvIHRvdGFsKSB9OwovLwovLyAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJy5vdXRQb3J0cycpIHsgYXR0cnNbcG9ydFNlbGVjdG9yXVsncmVmLWR4J10gPSAwOyB9Ci8vCi8vICAgICAgICAgcmV0dXJuIGF0dHJzOwovLyAgICAgfQovL30pKTsKam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UgPSB7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMudXBkYXRlUG9ydHNBdHRycygpOwogICAgICAgIHRoaXMub24oJ2NoYW5nZTppblBvcnRzIGNoYW5nZTpvdXRQb3J0cycsIHRoaXMudXBkYXRlUG9ydHNBdHRycywgdGhpcyk7CgogICAgICAgIC8vIENhbGwgdGhlIGBpbml0aWFsaXplKClgIG9mIHRoZSBwYXJlbnQuCiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18uY29uc3RydWN0b3IuX19zdXBlcl9fLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAKICAgIHVwZGF0ZVBvcnRzQXR0cnM6IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoKICAgICAgICAvLyBEZWxldGUgcHJldmlvdXNseSBzZXQgYXR0cmlidXRlcyBmb3IgcG9ydHMuCiAgICAgICAgdmFyIGN1cnJBdHRycyA9IHRoaXMuZ2V0KCdhdHRycycpOwogICAgICAgIF8uZWFjaCh0aGlzLl9wb3J0U2VsZWN0b3JzLCBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICAgICAgICBpZiAoY3VyckF0dHJzW3NlbGVjdG9yXSkgZGVsZXRlIGN1cnJBdHRyc1tzZWxlY3Rvcl07CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gVGhpcyBob2xkcyBrZXlzIHRvIHRoZSBgYXR0cnNgIG9iamVjdCBmb3IgYWxsIHRoZSBwb3J0IHNwZWNpZmljIGF0dHJpYnV0ZSB0aGF0CiAgICAgICAgLy8gd2Ugc2V0IGluIHRoaXMgbWV0aG9kLiBUaGlzIGlzIG5lY2Vzc2FyeSBpbiBvcmRlciB0byByZW1vdmUgcHJldmlvdXNseSBzZXQKICAgICAgICAvLyBhdHRyaWJ1dGVzIGZvciBwcmV2aW91cyBwb3J0cy4KICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gW107CiAgICAgICAgCiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgCiAgICAgICAgXy5lYWNoKHRoaXMuZ2V0KCdpblBvcnRzJyksIGZ1bmN0aW9uKHBvcnROYW1lLCBpbmRleCwgcG9ydHMpIHsKICAgICAgICAgICAgdmFyIHBvcnRBdHRyaWJ1dGVzID0gdGhpcy5nZXRQb3J0QXR0cnMocG9ydE5hbWUsIGluZGV4LCBwb3J0cy5sZW5ndGgsICcuaW5Qb3J0cycsICdpbicpOwogICAgICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gdGhpcy5fcG9ydFNlbGVjdG9ycy5jb25jYXQoXy5rZXlzKHBvcnRBdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKGF0dHJzLCBwb3J0QXR0cmlidXRlcyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgCiAgICAgICAgXy5lYWNoKHRoaXMuZ2V0KCdvdXRQb3J0cycpLCBmdW5jdGlvbihwb3J0TmFtZSwgaW5kZXgsIHBvcnRzKSB7CiAgICAgICAgICAgIHZhciBwb3J0QXR0cmlidXRlcyA9IHRoaXMuZ2V0UG9ydEF0dHJzKHBvcnROYW1lLCBpbmRleCwgcG9ydHMubGVuZ3RoLCAnLm91dFBvcnRzJywgJ291dCcpOwogICAgICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gdGhpcy5fcG9ydFNlbGVjdG9ycy5jb25jYXQoXy5rZXlzKHBvcnRBdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKGF0dHJzLCBwb3J0QXR0cmlidXRlcyk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIFNpbGVudGx5IHNldCBgYXR0cnNgIG9uIHRoZSBjZWxsIHNvIHRoYXQgbm9vbmUga25vd3MgdGhlIGF0dHJzIGhhdmUgY2hhbmdlZC4gVGhpcyBtYWtlcyBzdXJlCiAgICAgICAgLy8gdGhhdCwgZm9yIGV4YW1wbGUsIGNvbW1hbmQgbWFuYWdlciBkb2VzIG5vdCByZWdpc3RlciBgY2hhbmdlOmF0dHJzYCBjb21tYW5kIGJ1dCBvbmx5CiAgICAgICAgLy8gdGhlIGltcG9ydGFudCBgY2hhbmdlOmluUG9ydHNgL2BjaGFuZ2U6b3V0UG9ydHNgIGNvbW1hbmQuCiAgICAgICAgdGhpcy5hdHRyKGF0dHJzLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgICAvLyBNYW51YWxseSBjYWxsIHRoZSBgcHJvY2Vzc1BvcnRzKClgIG1ldGhvZCB0aGF0IGlzIG5vcm1hbGx5IGNhbGxlZCBvbiBgY2hhbmdlOmF0dHJzYCAodGhhdCB3ZSBqdXN0IG1hZGUgc2lsZW50KS4KICAgICAgICB0aGlzLnByb2Nlc3NQb3J0cygpOwogICAgICAgIC8vIExldCB0aGUgb3V0c2lkZSB3b3JsZCAobWFpbmx5IHRoZSBgTW9kZWxWaWV3YCkga25vdyB0aGF0IHdlJ3JlIGRvbmUgY29uZmlndXJpbmcgdGhlIGBhdHRyc2Agb2JqZWN0LgogICAgICAgIHRoaXMudHJpZ2dlcigncHJvY2Vzczpwb3J0cycpOwogICAgfSwKCiAgICBnZXRQb3J0U2VsZWN0b3I6IGZ1bmN0aW9uKG5hbWUpIHsKCiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy5pblBvcnRzJzsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldCgnaW5Qb3J0cycpLmluZGV4T2YobmFtZSk7CgogICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgc2VsZWN0b3IgPSAnLm91dFBvcnRzJzsKICAgICAgICAgICAgaW5kZXggPSB0aGlzLmdldCgnb3V0UG9ydHMnKS5pbmRleE9mKG5hbWUpOwoKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgdGhyb3cgbmV3IEVycm9yKCJnZXRQb3J0U2VsZWN0b3IoKTogUG9ydCBkb2Vzbid0IGV4aXN0LiIpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGVjdG9yICsgJz5nOm50aC1jaGlsZCgnICsgKGluZGV4ICsgMSkgKyAnKT5jaXJjbGUnOwogICAgfQp9OwoKam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzVmlld0ludGVyZmFjZSA9IHsKICAgIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIGBNb2RlbGAgZW1pdHMgdGhlIGBwcm9jZXNzOnBvcnRzYCB3aGVuZXZlciBpdCdzIGRvbmUgY29uZmlndXJpbmcgdGhlIGBhdHRyc2Agb2JqZWN0IGZvciBwb3J0cy4KICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdwcm9jZXNzOnBvcnRzJywgdGhpcy51cGRhdGUpOwogICAgICAgIAogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICB1cGRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBGaXJzdCByZW5kZXIgcG9ydHMgc28gdGhhdCBgYXR0cnNgIGNhbiBiZSBhcHBsaWVkIHRvIHRob3NlIG5ld2x5IGNyZWF0ZWQgRE9NIGVsZW1lbnRzCiAgICAgICAgLy8gaW4gYEVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUoKWAuCiAgICAgICAgdGhpcy5yZW5kZXJQb3J0cygpOwogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUudXBkYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHJlbmRlclBvcnRzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyICRpblBvcnRzID0gdGhpcy4kKCcuaW5Qb3J0cycpLmVtcHR5KCk7CiAgICAgICAgdmFyICRvdXRQb3J0cyA9IHRoaXMuJCgnLm91dFBvcnRzJykuZW1wdHkoKTsKCiAgICAgICAgdmFyIHBvcnRUZW1wbGF0ZSA9IF8udGVtcGxhdGUodGhpcy5tb2RlbC5wb3J0TWFya3VwKTsKCiAgICAgICAgXy5lYWNoKF8uZmlsdGVyKHRoaXMubW9kZWwucG9ydHMsIGZ1bmN0aW9uKHApIHsgcmV0dXJuIHAudHlwZSA9PT0gJ2luJyB9KSwgZnVuY3Rpb24ocG9ydCwgaW5kZXgpIHsKCiAgICAgICAgICAgICRpblBvcnRzLmFwcGVuZChWKHBvcnRUZW1wbGF0ZSh7IGlkOiBpbmRleCwgcG9ydDogcG9ydCB9KSkubm9kZSk7CiAgICAgICAgfSk7CiAgICAgICAgXy5lYWNoKF8uZmlsdGVyKHRoaXMubW9kZWwucG9ydHMsIGZ1bmN0aW9uKHApIHsgcmV0dXJuIHAudHlwZSA9PT0gJ291dCcgfSksIGZ1bmN0aW9uKHBvcnQsIGluZGV4KSB7CgogICAgICAgICAgICAkb3V0UG9ydHMuYXBwZW5kKFYocG9ydFRlbXBsYXRlKHsgaWQ6IGluZGV4LCBwb3J0OiBwb3J0IH0pKS5ub2RlKTsKICAgICAgICB9KTsKICAgIH0KfTsKCmpvaW50LnNoYXBlcy5iYXNpYy5UZXh0QmxvY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogWyc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0Lz48L2c+PHN3aXRjaD4nLAoKICAgICAgICAgICAgIC8vIGlmIGZvcmVpZ25PYmplY3Qgc3VwcG9ydGVkCgogICAgICAgICAgICAgJzxmb3JlaWduT2JqZWN0IHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgY2xhc3M9ImZvYmoiPicsCiAgICAgICAgICAgICAnPGJvZHkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxkaXYvPjwvYm9keT4nLAogICAgICAgICAgICAgJzwvZm9yZWlnbk9iamVjdD4nLAoKICAgICAgICAgICAgIC8vIGVsc2UgZm9yZWlnbk9iamVjdCBpcyBub3Qgc3VwcG9ydGVkIChmYWxsYmFjayBmb3IgSUUpCiAgICAgICAgICAgICAnPHRleHQgY2xhc3M9ImNvbnRlbnQiLz4nLAoKICAgICAgICAgICAgICc8L3N3aXRjaD48L2c+J10uam9pbignJyksCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnYmFzaWMuVGV4dEJsb2NrJywKCiAgICAgICAgLy8gc2VlIGpvaW50LmNzcyBmb3IgbW9yZSBlbGVtZW50IHN0eWxlcwogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHJlY3Q6IHsKICAgICAgICAgICAgICAgIGZpbGw6ICcjZmZmZmZmJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJyMwMDAwMDAnLAogICAgICAgICAgICAgICAgd2lkdGg6IDgwLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAxMDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgZmlsbDogJyMwMDAwMDAnLAogICAgICAgICAgICAgICAgJ2ZvbnQtc2l6ZSc6IDE0LAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWYnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuY29udGVudCc6IHsKICAgICAgICAgICAgICAgIHRleHQ6ICcnLAogICAgICAgICAgICAgICAgcmVmOiAncmVjdCcsCiAgICAgICAgICAgICAgICAncmVmLXgnOiAuNSwKICAgICAgICAgICAgICAgICdyZWYteSc6IC41LAogICAgICAgICAgICAgICAgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudDogJycKCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpLAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAodHlwZW9mIFNWR0ZvcmVpZ25PYmplY3RFbGVtZW50ICE9PSAndW5kZWZpbmVkJykgewoKICAgICAgICAgICAgLy8gZm9yZWlnbk9iamVjdCBzdXBwb3J0ZWQKICAgICAgICAgICAgdGhpcy5zZXRGb3JlaWduT2JqZWN0U2l6ZSh0aGlzLCB0aGlzLmdldCgnc2l6ZScpKTsKICAgICAgICAgICAgdGhpcy5zZXREaXZDb250ZW50KHRoaXMsIHRoaXMuZ2V0KCdjb250ZW50JykpOwogICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMsICdjaGFuZ2U6c2l6ZScsIHRoaXMuc2V0Rm9yZWlnbk9iamVjdFNpemUpOwogICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMsICdjaGFuZ2U6Y29udGVudCcsIHRoaXMuc2V0RGl2Q29udGVudCk7CgogICAgICAgIH0KCiAgICAgICAgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgc2V0Rm9yZWlnbk9iamVjdFNpemU6IGZ1bmN0aW9uKGNlbGwsIHNpemUpIHsKCiAgICAgICAgLy8gU2VsZWN0b3IgYGZvcmVpZ25PYmplY3QnIGRvZXNuJ3Qgd29yayBhY2Nyb3NzIGFsbCBicm93c2Vycywgd2UnciB1c2luZyBjbGFzcyBzZWxlY3RvciBpbnN0ZWFkLgogICAgICAgIC8vIFdlIGhhdmUgdG8gY2xvbmUgc2l6ZSBhcyB3ZSBkb24ndCB3YW50IGF0dHJpYnV0ZXMuZGl2LnN0eWxlIHRvIGJlIHNhbWUgb2JqZWN0IGFzIGF0dHJpYnV0ZXMuc2l6ZS4KICAgICAgICBjZWxsLmF0dHIoewogICAgICAgICAgICAnLmZvYmonOiBfLmNsb25lKHNpemUpLAogICAgICAgICAgICBkaXY6IHsgc3R5bGU6IF8uY2xvbmUoc2l6ZSkgfQogICAgICAgIH0pOwogICAgfSwKCiAgICBzZXREaXZDb250ZW50OiBmdW5jdGlvbihjZWxsLCBjb250ZW50KSB7CgogICAgICAgIC8vIEFwcGVuZCB0aGUgY29udGVudCB0byBkaXYgYXMgaHRtbC4KICAgICAgICBjZWxsLmF0dHIoeyBkaXYgOiB7CiAgICAgICAgICAgIGh0bWw6IGNvbnRlbnQKICAgICAgICB9fSk7CiAgICB9Cgp9KTsKCi8vIFRleHRCbG9ja1ZpZXcgaW1wbGVtZW50cyB0aGUgZmFsbGJhY2sgZm9yIElFIHdoZW4gbm8gZm9yZWlnbk9iamVjdCBleGlzdHMgYW5kCi8vIHRoZSB0ZXh0IG5lZWRzIHRvIGJlIG1hbnVhbGx5IGJyb2tlbi4Kam9pbnQuc2hhcGVzLmJhc2ljLlRleHRCbG9ja1ZpZXcgPSBqb2ludC5kaWEuRWxlbWVudFZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh0eXBlb2YgU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQgPT09ICd1bmRlZmluZWQnKSB7CgogICAgICAgICAgICB0aGlzLm5vU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQgPSB0cnVlOwoKICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOmNvbnRlbnQnLCBmdW5jdGlvbihjZWxsKSB7CiAgICAgICAgICAgICAgICAvLyBhdm9pZGluZyBwYXNzIG9mIGV4dHJhIHBhcmFtdGVycwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb250ZW50KGNlbGwpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZTogZnVuY3Rpb24oY2VsbCwgcmVuZGVyaW5nT25seUF0dHJzKSB7CgogICAgICAgIGlmICh0aGlzLm5vU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQpIHsKCiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMubW9kZWw7CgogICAgICAgICAgICAvLyBVcGRhdGUgZXZlcnl0aGluZyBidXQgdGhlIGNvbnRlbnQgZmlyc3QuCiAgICAgICAgICAgIHZhciBub1RleHRBdHRycyA9IF8ub21pdChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgbW9kZWwuZ2V0KCdhdHRycycpLCAnLmNvbnRlbnQnKTsKICAgICAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBtb2RlbCwgbm9UZXh0QXR0cnMpOwoKICAgICAgICAgICAgaWYgKCFyZW5kZXJpbmdPbmx5QXR0cnMgfHwgXy5oYXMocmVuZGVyaW5nT25seUF0dHJzLCAnLmNvbnRlbnQnKSkgewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjb250ZW50IGl0c2VsZi4KICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ29udGVudChtb2RlbCwgcmVuZGVyaW5nT25seUF0dHJzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBtb2RlbCwgcmVuZGVyaW5nT25seUF0dHJzKTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZUNvbnRlbnQ6IGZ1bmN0aW9uKGNlbGwsIHJlbmRlcmluZ09ubHlBdHRycykgewoKICAgICAgICAvLyBDcmVhdGUgY29weSBvZiB0aGUgdGV4dCBhdHRyaWJ1dGVzCiAgICAgICAgdmFyIHRleHRBdHRycyA9IF8ubWVyZ2Uoe30sIChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgY2VsbC5nZXQoJ2F0dHJzJykpWycuY29udGVudCddKTsKCiAgICAgICAgZGVsZXRlIHRleHRBdHRycy50ZXh0OwoKICAgICAgICAvLyBCcmVhayB0aGUgY29udGVudCB0byBmaXQgdGhlIGVsZW1lbnQgc2l6ZSB0YWtpbmcgaW50byBhY2NvdW50IHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgLy8gc2V0IG9uIHRoZSBtb2RlbC4KICAgICAgICB2YXIgdGV4dCA9IGpvaW50LnV0aWwuYnJlYWtUZXh0KGNlbGwuZ2V0KCdjb250ZW50JyksIGNlbGwuZ2V0KCdzaXplJyksIHRleHRBdHRycywgewogICAgICAgICAgICAvLyBtZWFzdXJpbmcgc2FuZGJveCBzdmcgZG9jdW1lbnQKICAgICAgICAgICAgc3ZnRG9jdW1lbnQ6IHRoaXMucGFwZXIuc3ZnCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBhdHRycyB3aXRoIHNhbWUgc3RydWN0dXJlIGFzIHRoZSBtb2RlbCBhdHRycyB7IHRleHQ6IHsgKnRleHRBdHRyaWJ1dGVzKiB9fQogICAgICAgIHZhciBhdHRycyA9IGpvaW50LnV0aWwuc2V0QnlQYXRoKHt9LCAnLmNvbnRlbnQnLCB0ZXh0QXR0cnMsJy8nKTsKCiAgICAgICAgLy8gUmVwbGFjZSB0ZXh0IGF0dHJpYnV0ZSB3aXRoIHRoZSBvbmUgd2UganVzdCBwcm9jZXNzZWQuCiAgICAgICAgYXR0cnNbJy5jb250ZW50J10udGV4dCA9IHRleHQ7CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgdmlldyB1c2luZyByZW5kZXJpbmdPbmx5QXR0cmlidXRlcyBwYXJhbWV0ZXIuCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBjZWxsLCBhdHRycyk7CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLmJhc2ljOwp9Cgpqb2ludC5yb3V0ZXJzLm9ydGhvZ29uYWwgPSBmdW5jdGlvbigpIHsKCiAgICB2YXIgc291cmNlQkJveCwgdGFyZ2V0QkJveDsKCiAgICAvLyBSZXR1cm4gdGhlIGRpcmVjdGlvbiB0aGF0IG9uZSB3b3VsZCBoYXZlIHRvIHRha2UgdHJhdmVsaW5nIGZyb20gYHAxYCB0byBgcDJgLgogICAgLy8gVGhpcyBmdW5jdGlvbiBhc3N1bWVzIHRoZSBsaW5lIGJldHdlZW4gYHAxYCBhbmQgYHAyYCBpcyBvcnRob2dvbmFsLgogICAgZnVuY3Rpb24gZGlyZWN0aW9uKHAxLCBwMikgewogICAgICAgIAogICAgICAgIGlmIChwMS55IDwgcDIueSAmJiBwMS54ID09PSBwMi54KSB7CiAgICAgICAgICAgIHJldHVybiAnZG93bic7CiAgICAgICAgfSBlbHNlIGlmIChwMS55ID4gcDIueSAmJiBwMS54ID09PSBwMi54KSB7CiAgICAgICAgICAgIHJldHVybiAndXAnOwogICAgICAgIH0gZWxzZSBpZiAocDEueCA8IHAyLnggJiYgcDEueSA9PT0gcDIueSkgewogICAgICAgICAgICByZXR1cm4gJ3JpZ2h0JzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICdsZWZ0JzsKICAgIH0KCiAgICBmdW5jdGlvbiBiZXN0RGlyZWN0aW9uKHAxLCBwMiwgcHJlZmVycmVkRGlyZWN0aW9uKSB7CgogICAgICAgIHZhciBkaXJlY3Rpb25zOwoKICAgICAgICAvLyBUaGlzIGJyYW5jaGluZyBkZXRlcm1pbmVzIHBvc3NpYmxlIGRpcmVjdGlvbnMgdGhhdCBvbmUgY2FuIHRha2UgdG8gdHJhdmVsCiAgICAgICAgLy8gZnJvbSBgcDFgIHRvIGBwMmAuCiAgICAgICAgaWYgKHAxLnggPCBwMi54KSB7CgogICAgICAgICAgICBpZiAocDEueSA+IHAyLnkpIHsgZGlyZWN0aW9ucyA9IFsndXAnLCAncmlnaHQnXTsgfQogICAgICAgICAgICBlbHNlIGlmIChwMS55IDwgcDIueSkgeyBkaXJlY3Rpb25zID0gWydkb3duJywgJ3JpZ2h0J107IH0KICAgICAgICAgICAgZWxzZSB7IGRpcmVjdGlvbnMgPSBbJ3JpZ2h0J107IH0KCiAgICAgICAgfSBlbHNlIGlmIChwMS54ID4gcDIueCkgewoKICAgICAgICAgICAgaWYgKHAxLnkgPiBwMi55KSB7IGRpcmVjdGlvbnMgPSBbJ3VwJywgJ2xlZnQnXTsgfQogICAgICAgICAgICBlbHNlIGlmIChwMS55IDwgcDIueSkgeyBkaXJlY3Rpb25zID0gWydkb3duJywgJ2xlZnQnXTsgfQogICAgICAgICAgICBlbHNlIHsgZGlyZWN0aW9ucyA9IFsnbGVmdCddOyB9CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAocDEueSA+IHAyLnkpIHsgZGlyZWN0aW9ucyA9IFsndXAnXTsgfQogICAgICAgICAgICBlbHNlIHsgZGlyZWN0aW9ucyA9IFsnZG93biddOyB9CiAgICAgICAgfQoKICAgICAgICBpZiAoXy5jb250YWlucyhkaXJlY3Rpb25zLCBwcmVmZXJyZWREaXJlY3Rpb24pKSB7CiAgICAgICAgICAgIHJldHVybiBwcmVmZXJyZWREaXJlY3Rpb247CiAgICAgICAgfQoKICAgICAgICB2YXIgZGlyZWN0aW9uID0gXy5maXJzdChkaXJlY3Rpb25zKTsKCiAgICAgICAgLy8gU2hvdWxkIHRoZSBkaXJlY3Rpb24gYmUgdGhlIGV4YWN0IG9wcG9zaXRlIG9mIHRoZSBwcmVmZXJyZWQgZGlyZWN0aW9uLAogICAgICAgIC8vIHRyeSBhbm90aGVyIG9uZSBpZiBzdWNoIGRpcmVjdGlvbiBleGlzdHMuCiAgICAgICAgc3dpdGNoIChwcmVmZXJyZWREaXJlY3Rpb24pIHsKICAgICAgICBjYXNlICdkb3duJzogaWYgKGRpcmVjdGlvbiA9PT0gJ3VwJykgcmV0dXJuIF8ubGFzdChkaXJlY3Rpb25zKTsgYnJlYWs7CiAgICAgICAgY2FzZSAndXAnOiBpZiAoZGlyZWN0aW9uID09PSAnZG93bicpIHJldHVybiBfLmxhc3QoZGlyZWN0aW9ucyk7IGJyZWFrOwogICAgICAgIGNhc2UgJ2xlZnQnOiBpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnKSByZXR1cm4gXy5sYXN0KGRpcmVjdGlvbnMpOyBicmVhazsKICAgICAgICBjYXNlICdyaWdodCc6IGlmIChkaXJlY3Rpb24gPT09ICdsZWZ0JykgcmV0dXJuIF8ubGFzdChkaXJlY3Rpb25zKTsgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkaXJlY3Rpb247CiAgICB9OwoKICAgIC8vIEZpbmQgYSB2ZXJ0ZXggaW4gYmV0d2VlbiB0aGUgdmVydGljZXMgYHAxYCBhbmQgYHAyYCBzbyB0aGF0IHRoZSByb3V0ZSBiZXR3ZWVuIHRob3NlIHZlcnRpY2VzCiAgICAvLyBpcyBvcnRob2dvbmFsLiBQcmVmZXIgZ29pbmcgdGhlIGRpcmVjdGlvbiBkZXRlcm1pbmVkIGJ5IGBwcmVmZXJyZWREaXJlY3Rpb25gLgogICAgZnVuY3Rpb24gZmluZE1pZGRsZVZlcnRleChwMSwgcDIsIHByZWZlcnJlZERpcmVjdGlvbikgewogICAgICAgIAogICAgICAgIHZhciBkaXJlY3Rpb24gPSBiZXN0RGlyZWN0aW9uKHAxLCBwMiwgcHJlZmVycmVkRGlyZWN0aW9uKTsKICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAnZG93bicgfHwgZGlyZWN0aW9uID09PSAndXAnKSB7CiAgICAgICAgICAgIHJldHVybiB7IHg6IHAxLngsIHk6IHAyLnksIGQ6IGRpcmVjdGlvbiB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4geyB4OiBwMi54LCB5OiBwMS55LCBkOiBkaXJlY3Rpb24gfTsKICAgIH0KCiAgICAvLyBSZXR1cm4gcG9pbnRzIHRoYXQgb25lIG5lZWRzIHRvIGRyYXcgYSBjb25uZWN0aW9uIHRocm91Z2ggaW4gb3JkZXIgdG8gaGF2ZSBhIG9ydGhvZ29uYWwgbGluawogICAgLy8gcm91dGluZyBmcm9tIHNvdXJjZSB0byB0YXJnZXQgZ29pbmcgdGhyb3VnaCBgdmVydGljZXNgLgogICAgZnVuY3Rpb24gZmluZE9ydGhvZ29uYWxSb3V0ZSh2ZXJ0aWNlcykgewoKICAgICAgICB2ZXJ0aWNlcyA9ICh2ZXJ0aWNlcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICB2YXIgb3J0aG9nb25hbFZlcnRpY2VzID0gW107CgogICAgICAgIHZhciBzb3VyY2VDZW50ZXIgPSBzb3VyY2VCQm94LmNlbnRlcigpOwogICAgICAgIHZhciB0YXJnZXRDZW50ZXIgPSB0YXJnZXRCQm94LmNlbnRlcigpOwoKICAgICAgICBpZiAoIXZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNvdXJjZUNlbnRlci54IC0gdGFyZ2V0Q2VudGVyLngpIDwgKHNvdXJjZUJCb3gud2lkdGggLyAyKSB8fAogICAgICAgICAgICAgICAgTWF0aC5hYnMoc291cmNlQ2VudGVyLnkgLSB0YXJnZXRDZW50ZXIueSkgPCAoc291cmNlQkJveC5oZWlnaHQgLyAyKQogICAgICAgICAgICApIHsKCiAgICAgICAgICAgICAgICB2ZXJ0aWNlcyA9IFt7CiAgICAgICAgICAgICAgICAgICAgeDogTWF0aC5taW4oc291cmNlQ2VudGVyLngsIHRhcmdldENlbnRlci54KSArCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguYWJzKHNvdXJjZUNlbnRlci54IC0gdGFyZ2V0Q2VudGVyLngpIC8gMiwKICAgICAgICAgICAgICAgICAgICB5OiBNYXRoLm1pbihzb3VyY2VDZW50ZXIueSwgdGFyZ2V0Q2VudGVyLnkpICsKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5hYnMoc291cmNlQ2VudGVyLnkgLSB0YXJnZXRDZW50ZXIueSkgLyAyCiAgICAgICAgICAgICAgICB9XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmVydGljZXMudW5zaGlmdChzb3VyY2VDZW50ZXIpOwogICAgICAgIHZlcnRpY2VzLnB1c2godGFyZ2V0Q2VudGVyKTsKCiAgICAgICAgdmFyIG9ydGhvZ29uYWxWZXJ0ZXg7CiAgICAgICAgdmFyIGxhc3RPcnRob2dvbmFsVmVydGV4OwogICAgICAgIHZhciB2ZXJ0ZXg7CiAgICAgICAgdmFyIG5leHRWZXJ0ZXg7CgogICAgICAgIC8vIEZvciBhbGwgdGhlIHBhaXJzIG9mIGxpbmsgbW9kZWwgdmVydGljZXMuLi4KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aCAtIDE7IGkrKykgewoKICAgICAgICAgICAgdmVydGV4ID0gdmVydGljZXNbaV07CiAgICAgICAgICAgIG5leHRWZXJ0ZXggPSB2ZXJ0aWNlc1tpICsgMV07CiAgICAgICAgICAgIGxhc3RPcnRob2dvbmFsVmVydGV4ID0gXy5sYXN0KG9ydGhvZ29uYWxWZXJ0aWNlcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaSA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFB1c2ggYWxsIHRoZSBsaW5rIHZlcnRpY2VzIHRvIHRoZSBvcnRob2dvbmFsIHJvdXRlLgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleCA9IHZlcnRleDsKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBhIGRpcmVjdGlvbiBiZXR3ZWVuIHRoZSBsYXN0IHZlcnRleCBhbmQgdGhlIG5ldyBvbmUuCiAgICAgICAgICAgICAgICAvLyBUaGVyZWZvcmUsIGVhY2ggdmVydGV4IGNvbnRhaW5zIHRoZSBgZGAgcHJvcGVydHkgZGVzY3JpYmluZyB0aGUgZGlyZWN0aW9uIHRoYXQgb25lCiAgICAgICAgICAgICAgICAvLyB3b3VsZCBoYXZlIHRvIHRha2UgdG8gdHJhdmVsIHRvIHRoYXQgdmVydGV4LgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleC5kID0gbGFzdE9ydGhvZ29uYWxWZXJ0ZXgKICAgICAgICAgICAgICAgICAgICA/IGRpcmVjdGlvbihsYXN0T3J0aG9nb25hbFZlcnRleCwgdmVydGV4KQogICAgICAgICAgICAgICAgICAgIDogJ3RvcCc7CgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRpY2VzLnB1c2gob3J0aG9nb25hbFZlcnRleCk7CiAgICAgICAgICAgICAgICBsYXN0T3J0aG9nb25hbFZlcnRleCA9IG9ydGhvZ29uYWxWZXJ0ZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlIGRvbid0IGNyZWF0ZSBhIHZlcnRleCB0aGF0IHdvdWxkIGdvIHRoZSBvcHBvc2l0ZSBkaXJlY3Rpb24gdGhlbgogICAgICAgICAgICAvLyB0aGF0IG9mIHRoZSBwcmV2aW91cyBvbmUuCiAgICAgICAgICAgIC8vIE90aHdlcndpc2UsIGEgJ3NwaWtlJyBzZWdtZW50IHdvdWxkIGJlIGNyZWF0ZWQgd2hpY2ggaXMgbm90IGRlc2lyYWJsZS4KICAgICAgICAgICAgLy8gRmluZCBhIGR1bW15IHZlcnRleCB0byBrZWVwIHRoZSBsaW5rIG9ydGhvZ29uYWwuIFByZWZlcmFibHksIHRha2UgdGhlIHNhbWUgZGlyZWN0aW9uCiAgICAgICAgICAgIC8vIGFzIHRoZSBwcmV2aW91cyBvbmUuCiAgICAgICAgICAgIHZhciBkID0gbGFzdE9ydGhvZ29uYWxWZXJ0ZXggJiYgbGFzdE9ydGhvZ29uYWxWZXJ0ZXguZDsKICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleCA9IGZpbmRNaWRkbGVWZXJ0ZXgodmVydGV4LCBuZXh0VmVydGV4LCBkKTsKCiAgICAgICAgICAgIC8vIERvIG5vdCBhZGQgYSBuZXcgdmVydGV4IHRoYXQgaXMgdGhlIHNhbWUgYXMgb25lIG9mIHRoZSB2ZXJ0aWNlcyBhbHJlYWR5IGFkZGVkLgogICAgICAgICAgICBpZiAoIWcucG9pbnQob3J0aG9nb25hbFZlcnRleCkuZXF1YWxzKGcucG9pbnQodmVydGV4KSkgJiYKICAgICAgICAgICAgICAgICFnLnBvaW50KG9ydGhvZ29uYWxWZXJ0ZXgpLmVxdWFscyhnLnBvaW50KG5leHRWZXJ0ZXgpKSkgewoKICAgICAgICAgICAgICAgIG9ydGhvZ29uYWxWZXJ0aWNlcy5wdXNoKG9ydGhvZ29uYWxWZXJ0ZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvcnRob2dvbmFsVmVydGljZXM7CiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbih2ZXJ0aWNlcykgewoKICAgICAgICBzb3VyY2VCQm94ID0gdGhpcy5zb3VyY2VCQm94OwogICAgICAgIHRhcmdldEJCb3ggPSB0aGlzLnRhcmdldEJCb3g7CgogICAgICAgIHJldHVybiBmaW5kT3J0aG9nb25hbFJvdXRlKHZlcnRpY2VzKTsKICAgIH07Cgp9KCk7Cgpqb2ludC5yb3V0ZXJzLm1hbmhhdHRhbiA9IChmdW5jdGlvbigpIHsKCiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIGNvbmZpZyA9IHsKCiAgICAgICAgLy8gc2l6ZSBvZiB0aGUgc3RlcCB0byBmaW5kIGEgcm91dGUKICAgICAgICBzdGVwOiAxMCwKCiAgICAgICAgLy8gdXNlIG9mIHRoZSBwZXJwZW5kaWN1bGFyIGxpbmtWaWV3IG9wdGlvbiB0byBjb25uZWN0IGNlbnRlciBvZiBlbGVtZW50IHdpdGggZmlyc3QgdmVydGV4CiAgICAgICAgcGVycGVuZGljdWxhcjogdHJ1ZSwKCiAgICAgICAgLy8gdGVsbHMgaG93IHRvIGRpdmlkZSB0aGUgcGFwZXIgd2hlbiBjcmVhdGluZyB0aGUgZWxlbWVudHMgbWFwCiAgICAgICAgbWFwR3JpZFNpemU6IDEwMCwKCiAgICAgICAgLy8gc2hvdWxkIGJlIHNvdXJjZSBvciB0YXJnZXQgbm90IHRvIGJlIGNvbnNpZGVyIGFzIGFuIG9ic3RhY2xlCiAgICAgICAgZXhjbHVkZUVuZHM6IFtdLCAvLyAnc291cmNlJywgJ3RhcmdldCcKCiAgICAgICAgLy8gc2hvdWxkIGJlIGFueSBlbGVtZW50IHdpdGggYSBjZXJ0YWluIHR5cGUgbm90IHRvIGJlIGNvbnNpZGVyIGFzIGFuIG9ic3RhY2xlCiAgICAgICAgZXhjbHVkZVR5cGVzOiBbJ2Jhc2ljLlRleHQnXSwKCiAgICAgICAgLy8gaWYgbnVtYmVyIG9mIHJvdXRlIGZpbmRpbmcgbG9vcHMgZXhjZWVkIHRoZSBtYXhpbXVtLCBzdG9wcyBzZWFyY2hpbmcgYW5kIHJldHVybnMKICAgICAgICAvLyBmYWxsYmFjayByb3V0ZQogICAgICAgIG1heGltdW1Mb29wczogNTAwLAoKICAgICAgICAvLyBwb3NzaWJsZSBzdGFydGluZyBkaXJlY3Rpb25zIGZyb20gYW4gZWxlbWVudAogICAgICAgIHN0YXJ0RGlyZWN0aW9uczogWydsZWZ0JywncmlnaHQnLCd0b3AnLCdib3R0b20nXSwKCiAgICAgICAgLy8gcG9zc2libGUgZW5kaW5nIGRpcmVjdGlvbnMgdG8gYW4gZWxlbWVudAogICAgICAgIGVuZERpcmVjdGlvbnM6IFsnbGVmdCcsJ3JpZ2h0JywndG9wJywnYm90dG9tJ10sCgogICAgICAgIC8vIHNwZWNpZnkgZGlyZWN0aW9ucyBhYm92ZQogICAgICAgIGRpcmVjdGlvbk1hcDogewogICAgICAgICAgICByaWdodDogeyB4OiAxLCB5OiAwIH0sCiAgICAgICAgICAgIGJvdHRvbTogeyB4OiAwLCB5OiAxIH0sCiAgICAgICAgICAgIGxlZnQ6IHsgeDogLTEsIHk6IDAgfSwKICAgICAgICAgICAgdG9wOiB7IHg6IDAsIHk6IC0xIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtYXhpbXVtIGNoYW5nZSBvZiB0aGUgZGlyZWN0aW9uCiAgICAgICAgbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZTogMSwKCiAgICAgICAgLy8gcGFkZGluZyBhcHBsaWVkIG9uIHRoZSBlbGVtZW50IGJvdW5kaW5nIGJveGVzCiAgICAgICAgcGFkZGluZ0JveDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc3RlcCA9IHRoaXMuc3RlcDsKCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB4OiAtc3RlcCwKICAgICAgICAgICAgICAgIHk6IC1zdGVwLAogICAgICAgICAgICAgICAgd2lkdGg6IDIqc3RlcCwKICAgICAgICAgICAgICAgIGhlaWdodDogMipzdGVwCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhbiBhcnJheSBvZiBkaXJlY3Rpb25zIHRvIGZpbmQgbmV4dCBwb2ludHMgb24gdGhlIHJvdXRlCiAgICAgICAgZGlyZWN0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc3RlcCA9IHRoaXMuc3RlcDsKCiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IHN0ZXAgICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogc3RlcCAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IC1zdGVwICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogLXN0ZXAgLCBjb3N0OiBzdGVwIH0KICAgICAgICAgICAgXTsKICAgICAgICB9LAoKICAgICAgICAvLyBhIHBlbmFsdHkgcmVjZWl2ZWQgZm9yIGRpcmVjdGlvbiBjaGFuZ2UKICAgICAgICBwZW5hbHRpZXM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgcmV0dXJuIFswLCB0aGlzLnN0ZXAgLyAyLCB0aGlzLnN0ZXBdOwogICAgICAgIH0sCgogICAgICAgIC8vIGhldXJlc3RpYyBtZXRob2QgdG8gZGV0ZXJtaW5lIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byBwb2ludHMKICAgICAgICBlc3RpbWF0ZUNvc3Q6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CgogICAgICAgICAgICByZXR1cm4gZnJvbS5tYW5oYXR0YW5EaXN0YW5jZSh0byk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYSBzaW1wbGUgcm91dGUgdXNlZCBpbiBzaXR1YXRpb25zLCB3aGVuIG1haW4gcm91dGluZyBtZXRob2QgZmFpbHMKICAgICAgICAvLyAoZXhjZWVkIGxvb3BzLCBpbmFjY2Vzc2libGUpLgogICAgICAgIGZhbGxiYWNrUm91dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7CgogICAgICAgICAgICAvLyBGaW5kIGFuIG9ydGhvZ29uYWwgcm91dGUgaWdub3Jpbmcgb2JzdGFjbGVzLgoKICAgICAgICAgICAgdmFyIHByZXZEaXJJbmRleGVzID0gb3B0cy5wcmV2RGlySW5kZXhlcyB8fCB7fTsKCiAgICAgICAgICAgIHZhciBwb2ludCA9IChwcmV2RGlySW5kZXhlc1tmcm9tXSB8fCAwKSAlIDIKICAgICAgICAgICAgICAgICAgICA/IGcucG9pbnQoZnJvbS54LCB0by55KQogICAgICAgICAgICAgICAgICAgIDogZy5wb2ludCh0by54LCBmcm9tLnkpOwoKICAgICAgICAgICAgcmV0dXJuIFtwb2ludCwgdG9dOwogICAgICAgIH0sCgogICAgICAgIC8vIGlmIGEgZnVuY3Rpb24gaXMgcHJvdmlkZWQsIGl0J3MgdXNlZCB0byByb3V0ZSB0aGUgbGluayB3aGlsZSBkcmFnZ2luZyBhbiBlbmQKICAgICAgICAvLyBpLmUuIGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7IHJldHVybiBbXTsgfQogICAgICAgIGRyYWdnaW5nUm91dGU6IG51bGwKICAgIH07CgogICAgLy8gcmVjb25zdHJ1Y3RzIGEgcm91dGUgYnkgY29uY2F0aW5nIHBvaW50cyB3aXRoIHRoZWlyIHBhcmVudHMKICAgIGZ1bmN0aW9uIHJlY29uc3RydWN0Um91dGUocGFyZW50cywgcG9pbnQpIHsKCiAgICAgICAgdmFyIHJvdXRlID0gW107CiAgICAgICAgdmFyIHByZXZEaWZmID0geyB4OiAwLCB5OiAwIH07CiAgICAgICAgdmFyIGN1cnJlbnQgPSBwb2ludDsKICAgICAgICB2YXIgcGFyZW50OwoKICAgICAgICB3aGlsZSAoKHBhcmVudCA9IHBhcmVudHNbY3VycmVudF0pKSB7CgogICAgICAgICAgICB2YXIgZGlmZiA9IHBhcmVudC5kaWZmZXJlbmNlKGN1cnJlbnQpOwoKICAgICAgICAgICAgaWYgKCFkaWZmLmVxdWFscyhwcmV2RGlmZikpIHsKCiAgICAgICAgICAgICAgICByb3V0ZS51bnNoaWZ0KGN1cnJlbnQpOwogICAgICAgICAgICAgICAgcHJldkRpZmYgPSBkaWZmOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50ID0gcGFyZW50OwogICAgICAgIH0KCiAgICAgICAgcm91dGUudW5zaGlmdChjdXJyZW50KTsKCiAgICAgICAgcmV0dXJuIHJvdXRlOwogICAgfTsKCiAgICAvLyBmaW5kIHBvaW50cyBhcm91bmQgdGhlIHJlY3RhbmdsZSB0YWtpbmcgZ2l2ZW4gZGlyZWN0aW9ucyBpbiB0aGUgYWNjb3VudAogICAgZnVuY3Rpb24gZ2V0UmVjdFBvaW50cyhiYm94LCBkaXJlY3Rpb25MaXN0LCBvcHRzKSB7CgogICAgICAgIHZhciBzdGVwID0gb3B0cy5zdGVwOwoKICAgICAgICB2YXIgY2VudGVyID0gYmJveC5jZW50ZXIoKTsKCiAgICAgICAgdmFyIHN0YXJ0UG9pbnRzID0gXy5jaGFpbihvcHRzLmRpcmVjdGlvbk1hcCkucGljayhkaXJlY3Rpb25MaXN0KS5tYXAoZnVuY3Rpb24oZGlyZWN0aW9uKSB7CgogICAgICAgICAgICB2YXIgeCA9IGRpcmVjdGlvbi54ICogYmJveC53aWR0aCAvIDI7CiAgICAgICAgICAgIHZhciB5ID0gZGlyZWN0aW9uLnkgKiBiYm94LmhlaWdodCAvIDI7CgogICAgICAgICAgICB2YXIgcG9pbnQgPSBnLnBvaW50KGNlbnRlcikub2Zmc2V0KHgseSkuc25hcFRvR3JpZChzdGVwKTsKCiAgICAgICAgICAgIGlmIChiYm94LmNvbnRhaW5zUG9pbnQocG9pbnQpKSB7CgogICAgICAgICAgICAgICAgcG9pbnQub2Zmc2V0KGRpcmVjdGlvbi54ICogc3RlcCwgZGlyZWN0aW9uLnkgKiBzdGVwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBvaW50OwoKICAgICAgICB9KS52YWx1ZSgpOwoKICAgICAgICByZXR1cm4gc3RhcnRQb2ludHM7CiAgICB9OwoKICAgIC8vIHJldHVybnMgYSBkaXJlY3Rpb24gaW5kZXggZnJvbSBzdGFydCBwb2ludCB0byBlbmQgcG9pbnQKICAgIGZ1bmN0aW9uIGdldERpcmVjdGlvbihzdGFydCwgZW5kLCBkaXJMZW4pIHsKCiAgICAgICAgdmFyIGRpckFuZ2xlID0gMzYwIC8gZGlyTGVuOwoKICAgICAgICB2YXIgcSA9IE1hdGguZmxvb3Ioc3RhcnQudGhldGEoZW5kKSAvIGRpckFuZ2xlKTsKCiAgICAgICAgcmV0dXJuIGRpckxlbiAtIHE7CiAgICB9CgogICAgLy8gZmluZHMgdGhlIHJvdXRlIGJldHdlZW4gdG8gcG9pbnRzL3JlY3RhbmdsZXMgaW1wbGVtZW50aW5nIEEqIGFsZ2hvcml0bQogICAgZnVuY3Rpb24gZmluZFJvdXRlKHN0YXJ0LCBlbmQsIG1hcCwgb3B0KSB7CgogICAgICAgIHZhciBzdGFydERpcmVjdGlvbnMgPSBvcHQucmV2ZXJzZWQgPyBvcHQuZW5kRGlyZWN0aW9ucyA6IG9wdC5zdGFydERpcmVjdGlvbnM7CiAgICAgICAgdmFyIGVuZERpcmVjdGlvbnMgPSBvcHQucmV2ZXJzZWQgPyBvcHQuc3RhcnREaXJlY3Rpb25zIDogb3B0LmVuZERpcmVjdGlvbnM7CgogICAgICAgIC8vIHNldCBvZiBwb2ludHMgd2Ugc3RhcnQgcGF0aGZpbmRpbmcgZnJvbQogICAgICAgIHZhciBzdGFydFNldCA9IHN0YXJ0IGluc3RhbmNlb2YgZy5yZWN0CiAgICAgICAgICAgICAgICA/IGdldFJlY3RQb2ludHMoc3RhcnQsIHN0YXJ0RGlyZWN0aW9ucywgb3B0KQogICAgICAgICAgICAgICAgOiBbc3RhcnRdOwoKICAgICAgICAvLyBzZXQgb2YgcG9pbnRzIHdlIHdhbnQgdGhlIHBhdGhmaW5kaW5nIHRvIGZpbmlzaCBhdAogICAgICAgIHZhciBlbmRTZXQgPSBlbmQgaW5zdGFuY2VvZiBnLnJlY3QKICAgICAgICAgICAgICAgID8gZ2V0UmVjdFBvaW50cyhlbmQsIGVuZERpcmVjdGlvbnMsIG9wdCkKICAgICAgICAgICAgICAgIDogW2VuZF07CgogICAgICAgIHZhciBzdGFydENlbnRlciA9IHN0YXJ0U2V0Lmxlbmd0aCA+IDEgPyBzdGFydC5jZW50ZXIoKSA6IHN0YXJ0U2V0WzBdOwogICAgICAgIHZhciBlbmRDZW50ZXIgPSBlbmRTZXQubGVuZ3RoID4gMSA/IGVuZC5jZW50ZXIoKSA6IGVuZFNldFswXTsKCiAgICAgICAgLy8gdGFrZSBpbnRvIGFjY291bnQgIG9ubHkgYWNjZXNzaWJsZSBlbmQgcG9pbnRzCiAgICAgICAgdmFyIGVuZFBvaW50cyA9IF8uZmlsdGVyKGVuZFNldCwgZnVuY3Rpb24ocG9pbnQpIHsKCiAgICAgICAgICAgIHZhciBtYXBLZXkgPSBnLnBvaW50KHBvaW50KS5zbmFwVG9HcmlkKG9wdC5tYXBHcmlkU2l6ZSkudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIHZhciBhY2Nlc2libGUgPSBfLmV2ZXJ5KG1hcFttYXBLZXldLCBmdW5jdGlvbihvYnN0YWNsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICFvYnN0YWNsZS5jb250YWluc1BvaW50KHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gYWNjZXNpYmxlOwogICAgICAgIH0pOwoKCiAgICAgICAgaWYgKGVuZFBvaW50cy5sZW5ndGgpIHsKCiAgICAgICAgICAgIHZhciBzdGVwID0gb3B0LnN0ZXA7CiAgICAgICAgICAgIHZhciBwZW5hbHRpZXMgPSBvcHQucGVuYWx0aWVzOwoKICAgICAgICAgICAgLy8gY2hvb3NlIHRoZSBlbmQgcG9pbnQgd2l0aCB0aGUgc2hvcnRlc3QgZXN0aW1hdGVkIHBhdGggY29zdAogICAgICAgICAgICB2YXIgZW5kUG9pbnQgPSBfLmNoYWluKGVuZFBvaW50cykuaW52b2tlKCdzbmFwVG9HcmlkJywgc3RlcCkubWluKGZ1bmN0aW9uKHBvaW50KSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIG9wdC5lc3RpbWF0ZUNvc3Qoc3RhcnRDZW50ZXIsIHBvaW50KTsKCiAgICAgICAgICAgIH0pLnZhbHVlKCk7CgogICAgICAgICAgICB2YXIgcGFyZW50cyA9IHt9OwogICAgICAgICAgICB2YXIgY29zdEZyb21TdGFydCA9IHt9OwogICAgICAgICAgICB2YXIgdG90YWxDb3N0ID0ge307CgogICAgICAgICAgICAvLyBkaXJlY3Rpb25zCiAgICAgICAgICAgIHZhciBkaXJzID0gb3B0LmRpcmVjdGlvbnM7CiAgICAgICAgICAgIHZhciBkaXJMZW4gPSBkaXJzLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGRpckhhbGZMZW4gPSBkaXJMZW4gLyAyOwogICAgICAgICAgICB2YXIgZGlySW5kZXhlcyA9IG9wdC5wcmV2aW91c0RpckluZGV4ZXMgfHwge307CgogICAgICAgICAgICAvLyBUaGUgc2V0IG9mIHBvaW50IGFscmVhZHkgZXZhbHVhdGVkLgogICAgICAgICAgICB2YXIgY2xvc2VIYXNoID0ge307IC8vIGtlZXBzIG9ubHkgaW5mb3JtYXRpb24gd2hldGhlciBhIHBvaW50IHdhcyBldmFsdWF0ZWQnCgogICAgICAgICAgICAvLyBUaGUgc2V0IG9mIHRlbnRhdGl2ZSBwb2ludHMgdG8gYmUgZXZhbHVhdGVkLCBpbml0aWFsbHkgY29udGFpbmluZyB0aGUgc3RhcnQgcG9pbnRzCiAgICAgICAgICAgIHZhciBvcGVuSGFzaCA9IHt9OyAvLyBrZWVwcyBvbmx5IGluZm9ybWF0aW9uIHdoZXRoZXIgYSBwb2ludCBpcyB0byBiZSBldmFsdWF0ZWQnCiAgICAgICAgICAgIHZhciBvcGVuU2V0ID0gXy5jaGFpbihzdGFydFNldCkuaW52b2tlKCdzbmFwVG9HcmlkJywgc3RlcCkuZWFjaChmdW5jdGlvbihwb2ludCkgewoKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBwb2ludC50b1N0cmluZygpOwoKICAgICAgICAgICAgICAgIGNvc3RGcm9tU3RhcnRba2V5XSA9IDA7IC8vIENvc3QgZnJvbSBzdGFydCBhbG9uZyBiZXN0IGtub3duIHBhdGguCiAgICAgICAgICAgICAgICB0b3RhbENvc3Rba2V5XSA9IG9wdC5lc3RpbWF0ZUNvc3QocG9pbnQsIGVuZFBvaW50KTsKICAgICAgICAgICAgICAgIGRpckluZGV4ZXNba2V5XSA9IGRpckluZGV4ZXNba2V5XSB8fCBnZXREaXJlY3Rpb24oc3RhcnRDZW50ZXIsIHBvaW50LCBkaXJMZW4pOwogICAgICAgICAgICAgICAgb3Blbkhhc2hba2V5XSA9IHRydWU7CgogICAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24ocG9pbnQpIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gcG9pbnQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIH0pLnNvcnRCeShmdW5jdGlvbihwb2ludEtleSkgewoKICAgICAgICAgICAgICAgIHJldHVybiB0b3RhbENvc3RbcG9pbnRLZXldOwoKICAgICAgICAgICAgfSkudmFsdWUoKTsKCiAgICAgICAgICAgIHZhciBsb29wQ291bnRlciA9IG9wdC5tYXhpbXVtTG9vcHM7CgogICAgICAgICAgICB2YXIgbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZSA9IG9wdC5tYXhBbGxvd2VkRGlyZWN0aW9uQ2hhbmdlOwoKICAgICAgICAgICAgLy8gbWFpbiByb3V0ZSBmaW5kaW5nIGxvb3AKICAgICAgICAgICAgd2hpbGUgKG9wZW5TZXQubGVuZ3RoICYmIGxvb3BDb3VudGVyLS0pIHsKCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEtleSA9IG9wZW5TZXRbMF07CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFBvaW50ID0gZy5wb2ludChjdXJyZW50S2V5KTsKCiAgICAgICAgICAgICAgICBpZiAoZW5kUG9pbnQuZXF1YWxzKGN1cnJlbnRQb2ludCkpIHsKCiAgICAgICAgICAgICAgICAgICAgb3B0LnByZXZpb3VzRGlySW5kZXhlcyA9IF8ucGljayhkaXJJbmRleGVzLCBjdXJyZW50S2V5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25zdHJ1Y3RSb3V0ZShwYXJlbnRzLCBjdXJyZW50UG9pbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBjdXJyZW50IGZyb20gdGhlIG9wZW4gbGlzdAogICAgICAgICAgICAgICAgb3BlblNldC5zcGxpY2UoMCwgMSk7CiAgICAgICAgICAgICAgICBvcGVuSGFzaFtuZWlnaGJvcktleV0gPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGFkZCBjdXJyZW50IHRvIHRoZSBjbG9zZSBsaXN0CiAgICAgICAgICAgICAgICBjbG9zZUhhc2hbbmVpZ2hib3JLZXldID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudERpckluZGV4ID0gZGlySW5kZXhlc1tjdXJyZW50S2V5XTsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RGlzdCA9IGNvc3RGcm9tU3RhcnRbY3VycmVudEtleV07CgogICAgICAgICAgICAgICAgZm9yICh2YXIgZGlySW5kZXggPSAwOyBkaXJJbmRleCA8IGRpckxlbjsgZGlySW5kZXgrKykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlyQ2hhbmdlID0gTWF0aC5hYnMoZGlySW5kZXggLSBjdXJyZW50RGlySW5kZXgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGlyQ2hhbmdlID4gZGlySGFsZkxlbikgewoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyQ2hhbmdlID0gZGlyTGVuIC0gZGlyQ2hhbmdlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGRpcmVjdGlvbiBjaGFuZ2VkIHJhcGlkbHkgZG9uJ3QgdXNlIHRoaXMgcG9pbnQKICAgICAgICAgICAgICAgICAgICBpZiAoZGlyQ2hhbmdlID4gbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlyID0gZGlyc1tkaXJJbmRleF07CgogICAgICAgICAgICAgICAgICAgIHZhciBuZWlnaGJvclBvaW50ID0gZy5wb2ludChjdXJyZW50UG9pbnQpLm9mZnNldChkaXIub2Zmc2V0WCwgZGlyLm9mZnNldFkpOwogICAgICAgICAgICAgICAgICAgIHZhciBuZWlnaGJvcktleSA9IG5laWdoYm9yUG9pbnQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNsb3NlSGFzaFtuZWlnaGJvcktleV0pIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaXMgcG9pbnQgYWNjZXNpYmxlIC0gbm8gb2JzdGFjbGUgaW4gdGhlIHdheQoKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwS2V5ID0gZy5wb2ludChuZWlnaGJvclBvaW50KS5zbmFwVG9HcmlkKG9wdC5tYXBHcmlkU2l6ZSkudG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGlzQWNjZXNpYmxlID0gXy5ldmVyeShtYXBbbWFwS2V5XSwgZnVuY3Rpb24ob2JzdGFjbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFvYnN0YWNsZS5jb250YWluc1BvaW50KG5laWdoYm9yUG9pbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWNjZXNpYmxlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBpbk9wZW5TZXQgPSBfLmhhcyhvcGVuSGFzaCwgbmVpZ2hib3JLZXkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgY29zdFRvTmVpZ2hib3IgPSBjdXJyZW50RGlzdCArIGRpci5jb3N0OwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWluT3BlblNldCB8fCBjb3N0VG9OZWlnaGJvciA8IGNvc3RGcm9tU3RhcnRbbmVpZ2hib3JLZXldKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzW25laWdoYm9yS2V5XSA9IGN1cnJlbnRQb2ludDsKICAgICAgICAgICAgICAgICAgICAgICAgZGlySW5kZXhlc1tuZWlnaGJvcktleV0gPSBkaXJJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgY29zdEZyb21TdGFydFtuZWlnaGJvcktleV0gPSBjb3N0VG9OZWlnaGJvcjsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsQ29zdFtuZWlnaGJvcktleV0gPSBjb3N0VG9OZWlnaGJvciArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHQuZXN0aW1hdGVDb3N0KG5laWdoYm9yUG9pbnQsIGVuZFBvaW50KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5hbHRpZXNbZGlyQ2hhbmdlXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5PcGVuU2V0KSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wZW5JbmRleCA9IF8uc29ydGVkSW5kZXgob3BlblNldCwgbmVpZ2hib3JLZXksIGZ1bmN0aW9uKG9wZW5LZXkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRvdGFsQ29zdFtvcGVuS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5TZXQuc3BsaWNlKG9wZW5JbmRleCwgMCwgbmVpZ2hib3JLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Blbkhhc2hbbmVpZ2hib3JLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBubyByb3V0ZSBmb3VuZCAoJ3RvJyBwb2ludCB3YXNuJ3QgZWl0aGVyIGFjY2Vzc2libGUgb3IgZmluZGluZyByb3V0ZSB0b29rCiAgICAgICAgLy8gd2F5IHRvIG11Y2ggY2FsY3VsYXRpb25zKQogICAgICAgIHJldHVybiBvcHQuZmFsbGJhY2tSb3V0ZShzdGFydENlbnRlciwgZW5kQ2VudGVyLCBvcHQpOwogICAgfTsKCiAgICAvLyBpbml0aWF0aW9uIG9mIHRoZSByb3V0ZSBmaW5kaW5nCiAgICBmdW5jdGlvbiByb3V0ZXIob2xkVmVydGljZXMsIG9wdCkgewoKICAgICAgICAvLyByZXNvbHZlIHNvbWUgb2YgdGhlIG9wdGlvbnMKICAgICAgICBvcHQuZGlyZWN0aW9ucyA9IF8ucmVzdWx0KG9wdCwgJ2RpcmVjdGlvbnMnKTsKICAgICAgICBvcHQucGVuYWx0aWVzID0gXy5yZXN1bHQob3B0LCAncGVuYWx0aWVzJyk7CiAgICAgICAgb3B0LnBhZGRpbmdCb3ggPSBfLnJlc3VsdChvcHQsICdwYWRkaW5nQm94Jyk7CgogICAgICAgIC8vIGVuYWJsZS9kaXNhYmxlIGxpbmtWaWV3IHBlcnBlbmRpY3VsYXIgb3B0aW9uCiAgICAgICAgdGhpcy5vcHRpb25zLnBlcnBlbmRpY3VsYXIgPSAhIW9wdC5wZXJwZW5kaWN1bGFyOwoKICAgICAgICAvLyBBcyByb3V0ZSBjaGFuZ2VzIGl0cyBzaGFwZSByYXBpZGx5IHdoZW4gd2Ugc3RhcnQgZmluZGluZyByb3V0ZSBmcm9tIGRpZmZlcmVudCBwb2ludAogICAgICAgIC8vIGl0J3MgbmVjZXNzYXJ5IHRvIHN0YXJ0IGZyb20gdGhlIGVsZW1lbnQgdGhhdCB3YXMgbm90IGludGVyYWN0ZWQgd2l0aAogICAgICAgIC8vICh0aGUgcG9zaXRpb24gd2FzIGNoYW5nZWQpIGF0IHZlcnkgbGFzdC4KICAgICAgICB2YXIgcmV2ZXJzZVJvdXRpbmcgPSBvcHQucmV2ZXJzZWQgPSAodGhpcy5sYXN0RW5kQ2hhbmdlID09PSAnc291cmNlJyk7CgogICAgICAgIHZhciBzb3VyY2VCQm94ID0gcmV2ZXJzZVJvdXRpbmcgPyBnLnJlY3QodGhpcy50YXJnZXRCQm94KSA6IGcucmVjdCh0aGlzLnNvdXJjZUJCb3gpOwogICAgICAgIHZhciB0YXJnZXRCQm94ID0gcmV2ZXJzZVJvdXRpbmcgPyBnLnJlY3QodGhpcy5zb3VyY2VCQm94KSA6IGcucmVjdCh0aGlzLnRhcmdldEJCb3gpOwoKICAgICAgICAvLyBleHBhbmQgYm94ZXMgYnkgc3BlY2lmaWMgcGFkZGluZwogICAgICAgIHNvdXJjZUJCb3gubW92ZUFuZEV4cGFuZChvcHQucGFkZGluZ0JveCk7CiAgICAgICAgdGFyZ2V0QkJveC5tb3ZlQW5kRXhwYW5kKG9wdC5wYWRkaW5nQm94KTsKCiAgICAgICAgLy8gYnVpbGRpbmcgYW4gZWxlbWVudHMgbWFwCgogICAgICAgIHZhciBsaW5rID0gdGhpcy5tb2RlbDsKICAgICAgICB2YXIgZ3JhcGggPSB0aGlzLnBhcGVyLm1vZGVsOwoKICAgICAgICAvLyBzb3VyY2Ugb3IgdGFyZ2V0IGVsZW1lbnQgY291bGQgYmUgZXhjbHVkZWQgZnJvbSBzZXQgb2Ygb2JzdGFjbGVzCiAgICAgICAgdmFyIGV4Y2x1ZGVkRW5kcyA9IF8uY2hhaW4ob3B0LmV4Y2x1ZGVFbmRzKQogICAgICAgICAgICAgICAgLm1hcChsaW5rLmdldCwgbGluaykKICAgICAgICAgICAgICAgIC5wbHVjaygnaWQnKQogICAgICAgICAgICAgICAgLm1hcChncmFwaC5nZXRDZWxsLCBncmFwaCkudmFsdWUoKTsKCiAgICAgICAgdmFyIG1hcEdyaWRTaXplID0gb3B0Lm1hcEdyaWRTaXplOwoKICAgICAgICAvLyBidWlsZHMgYSBtYXAgb2YgYWxsIGVsZW1lbnRzIGZvciBxdWlja2VyIG9ic3RhY2xlIHF1ZXJpZXMgKGkuZS4gaXMgYSBwb2ludCBjb250YWluZWQKICAgICAgICAvLyBpbiBhbnkgb2JzdGFjbGU/KSAoYSBzaW1wbGlmaWVkIGdyaWQgc2VhcmNoKQogICAgICAgIC8vIFRoZSBwYXBlciBpcyBkaXZpZGVkIHRvIHNtYWxsZXIgY2VsbHMsIHdoZXJlIGVhY2ggb2YgdGhlbSBob2xkcyBhbiBpbmZvcm1hdGlvbiB3aGljaAogICAgICAgIC8vIGVsZW1lbnRzIGJlbG9uZyB0byBpdC4gV2hlbiB3ZSBxdWVyeSB3aGV0aGVyIGEgcG9pbnQgaXMgaW4gYW4gb2JzdGFjbGUgd2UgZG9uJ3QgbmVlZAogICAgICAgIC8vIHRvIGdvIHRocm91Z2ggYWxsIG9ic3RhY2xlcywgd2UgY2hlY2sgb25seSB0aG9zZSBpbiBhIHBhcnRpY3VsYXIgY2VsbC4KICAgICAgICB2YXIgbWFwID0gXy5jaGFpbihncmFwaC5nZXRFbGVtZW50cygpKQogICAgICAgICAgICAvLyByZW1vdmUgc291cmNlIGFuZCB0YXJnZXQgZWxlbWVudCBpZiByZXF1aXJlZAogICAgICAgICAgICAuZGlmZmVyZW5jZShleGNsdWRlZEVuZHMpCiAgICAgICAgICAgIC8vIHJlbW92ZSBhbGwgZWxlbWVudHMgd2hvc2UgdHlwZSBpcyBsaXN0ZWQgaW4gZXhjbHVkZWRUeXBlcyBhcnJheQogICAgICAgICAgICAucmVqZWN0KGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfLmNvbnRhaW5zKG9wdC5leGNsdWRlVHlwZXMsIGVsZW1lbnQuZ2V0KCd0eXBlJykpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAvLyBjaGFuZ2UgZWxlbWVudHMgKG1vZGVscykgdG8gdGhlaXIgYm91bmRpbmcgYm94ZXMKICAgICAgICAgICAgLmludm9rZSgnZ2V0QkJveCcpCiAgICAgICAgICAgIC8vIGV4cGFuZCB0aGVpciBib3hlcyBieSBzcGVjaWZpYyBwYWRkaW5nCiAgICAgICAgICAgIC5pbnZva2UoJ21vdmVBbmRFeHBhbmQnLCBvcHQucGFkZGluZ0JveCkKICAgICAgICAgICAgLy8gYnVpbGQgdGhlIG1hcAogICAgICAgICAgICAuZm9sZGwoZnVuY3Rpb24ocmVzLCBiYm94KSB7CgogICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IGJib3gub3JpZ2luKCkuc25hcFRvR3JpZChtYXBHcmlkU2l6ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29ybmVyID0gYmJveC5jb3JuZXIoKS5zbmFwVG9HcmlkKG1hcEdyaWRTaXplKTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciB4ID0gb3JpZ2luLng7IHggPD0gY29ybmVyLng7IHggKz0gbWFwR3JpZFNpemUpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB5ID0gb3JpZ2luLnk7IHkgPD0gY29ybmVyLnk7IHkgKz0gbWFwR3JpZFNpemUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmlkS2V5ID0geCArICdAJyArIHk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXNbZ3JpZEtleV0gPSByZXNbZ3JpZEtleV0gfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc1tncmlkS2V5XS5wdXNoKGJib3gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwoKICAgICAgICAgICAgfSwge30pLnZhbHVlKCk7CgogICAgICAgIC8vIHBhdGhmaW5kaW5nCgogICAgICAgIHZhciBuZXdWZXJ0aWNlcyA9IFtdOwoKICAgICAgICB2YXIgcG9pbnRzID0gXy5tYXAob2xkVmVydGljZXMsIGcucG9pbnQpOwoKICAgICAgICB2YXIgdGFpbFBvaW50ID0gc291cmNlQkJveC5jZW50ZXIoKTsKCiAgICAgICAgLy8gZmluZCBhIHJvdXRlIGJ5IGNvbmNhdGluZyBhbGwgcGFydGlhbCByb3V0ZXMgKHJvdXRlcyBuZWVkIHRvIGdvIHRocm91Z2ggdGhlIHZlcnRpY2VzKQogICAgICAgIC8vIHN0YXJ0RWxlbWVudCAtPiB2ZXJ0ZXhbMV0gLT4gLi4uIC0+IHZlcnRleFtuXSAtPiBlbmRFbGVtZW50CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPD0gbGVuOyBpKyspIHsKCiAgICAgICAgICAgIHZhciBwYXJ0aWFsUm91dGUgPSBudWxsOwoKICAgICAgICAgICAgdmFyIGZyb20gPSB0byB8fCBzb3VyY2VCQm94OwogICAgICAgICAgICB2YXIgdG8gPSBwb2ludHNbaV07CgogICAgICAgICAgICBpZiAoIXRvKSB7CgogICAgICAgICAgICAgICAgdG8gPSB0YXJnZXRCQm94OwoKICAgICAgICAgICAgICAgIC8vICd0bycgaXMgbm90IGEgdmVydGV4LiBJZiB0aGUgdGFyZ2V0IGlzIGEgcG9pbnQgKGkuZS4gaXQncyBub3QgYW4gZWxlbWVudCksIHdlCiAgICAgICAgICAgICAgICAvLyBtaWdodCB1c2UgZHJhZ2dpbmcgcm91dGUgaW5zdGVhZCBvZiBtYWluIHJvdXRpbmcgbWV0aG9kIGlmIHRoYXQgaXMgZW5hYmxlZC4KICAgICAgICAgICAgICAgIHZhciBlbmRpbmdBdFBvaW50ID0gIXRoaXMubW9kZWwuZ2V0KCdzb3VyY2UnKS5pZCB8fCAhdGhpcy5tb2RlbC5nZXQoJ3RhcmdldCcpLmlkOwoKICAgICAgICAgICAgICAgIGlmIChlbmRpbmdBdFBvaW50ICYmIF8uaXNGdW5jdGlvbihvcHQuZHJhZ2dpbmdSb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgcGFzc2luZyBwb2ludHMgb25seSAobm90IHJlY3RzKS4KICAgICAgICAgICAgICAgICAgICB2YXIgZHJhZ0Zyb20gPSBmcm9tIGluc3RhbmNlb2YgZy5yZWN0ID8gZnJvbS5jZW50ZXIoKSA6IGZyb207CiAgICAgICAgICAgICAgICAgICAgcGFydGlhbFJvdXRlID0gb3B0LmRyYWdnaW5nUm91dGUoZHJhZ0Zyb20sIHRvLm9yaWdpbigpLCBvcHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBwYXJ0aWFsIHJvdXRlIGhhcyBub3QgYmVlbiBjYWxjdWxhdGVkIHlldCB1c2UgdGhlIG1haW4gcm91dGluZyBtZXRob2QgdG8gZmluZCBvbmUKICAgICAgICAgICAgcGFydGlhbFJvdXRlID0gcGFydGlhbFJvdXRlIHx8IGZpbmRSb3V0ZShmcm9tLCB0bywgbWFwLCBvcHQpOwoKICAgICAgICAgICAgdmFyIGxlYWRQb2ludCA9IF8uZmlyc3QocGFydGlhbFJvdXRlKTsKCiAgICAgICAgICAgIGlmIChsZWFkUG9pbnQgJiYgbGVhZFBvaW50LmVxdWFscyh0YWlsUG9pbnQpKSB7CgogICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBmaXJzdCBwb2ludCBpZiB0aGUgcHJldmlvdXMgcGFydGlhbCByb3V0ZSBoYWQgdGhlIHNhbWUgcG9pbnQgYXMgbGFzdAogICAgICAgICAgICAgICAgcGFydGlhbFJvdXRlLnNoaWZ0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhaWxQb2ludCA9IF8ubGFzdChwYXJ0aWFsUm91dGUpIHx8IHRhaWxQb2ludDsKCiAgICAgICAgICAgIG5ld1ZlcnRpY2VzID0gbmV3VmVydGljZXMuY29uY2F0KHBhcnRpYWxSb3V0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gd2UgbWlnaHQgaGF2ZSB0byByZXZlcnNlIHRoZSByZXN1bHQgaWYgd2Ugc3dhcHBlZCBzb3VyY2UgYW5kIHRhcmdldCBhdCB0aGUgYmVnaW5uaW5nCiAgICAgICAgcmV0dXJuIHJldmVyc2VSb3V0aW5nID8gbmV3VmVydGljZXMucmV2ZXJzZSgpIDogbmV3VmVydGljZXM7CiAgICB9OwoKICAgIC8vIHB1YmxpYyBmdW5jdGlvbgogICAgcmV0dXJuIGZ1bmN0aW9uKHZlcnRpY2VzLCBvcHQsIGxpbmtWaWV3KSB7CgogICAgICAgIHJldHVybiByb3V0ZXIuY2FsbChsaW5rVmlldywgdmVydGljZXMsIF8uZXh0ZW5kKHt9LCBjb25maWcsIG9wdCkpOwogICAgfTsKCn0pKCk7Cgpqb2ludC5yb3V0ZXJzLm1ldHJvID0gKGZ1bmN0aW9uKCkgewoKICAgIGlmICghXy5pc0Z1bmN0aW9uKGpvaW50LnJvdXRlcnMubWFuaGF0dGFuKSkgewoKICAgICAgICB0aHJvdygnTWV0cm8gcmVxdWlyZXMgdGhlIG1hbmhhdHRhbiByb3V0ZXIuJyk7CiAgICB9CgogICAgdmFyIGNvbmZpZyA9IHsKCiAgICAgICAgLy8gY29zdCBvZiBhIGRpYWdvbmFsIHN0ZXAgKGNhbGN1bGF0ZWQgaWYgbm90IGRlZmluZWQpLgogICAgICAgIGRpYWdvbmFsQ29zdDogbnVsbCwKCiAgICAgICAgLy8gYW4gYXJyYXkgb2YgZGlyZWN0aW9ucyB0byBmaW5kIG5leHQgcG9pbnRzIG9uIHRoZSByb3V0ZQogICAgICAgIGRpcmVjdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIHN0ZXAgPSB0aGlzLnN0ZXA7CiAgICAgICAgICAgIHZhciBkaWFnb25hbENvc3QgPSB0aGlzLmRpYWdvbmFsQ29zdCB8fCBNYXRoLmNlaWwoTWF0aC5zcXJ0KHN0ZXAgKiBzdGVwIDw8IDEpKTsKCiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IHN0ZXAgICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogc3RlcCAgLCBvZmZzZXRZOiBzdGVwICAsIGNvc3Q6IGRpYWdvbmFsQ29zdCB9LAogICAgICAgICAgICAgICAgeyBvZmZzZXRYOiAwICAgICAsIG9mZnNldFk6IHN0ZXAgICwgY29zdDogc3RlcCAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IC1zdGVwICwgb2Zmc2V0WTogc3RlcCAgLCBjb3N0OiBkaWFnb25hbENvc3QgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogLXN0ZXAgLCBvZmZzZXRZOiAwICAgICAsIGNvc3Q6IHN0ZXAgICAgICAgICB9LAogICAgICAgICAgICAgICAgeyBvZmZzZXRYOiAtc3RlcCAsIG9mZnNldFk6IC1zdGVwICwgY29zdDogZGlhZ29uYWxDb3N0IH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogLXN0ZXAgLCBjb3N0OiBzdGVwICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogc3RlcCAgLCBvZmZzZXRZOiAtc3RlcCAsIGNvc3Q6IGRpYWdvbmFsQ29zdCB9CiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgLy8gYSBzaW1wbGUgcm91dGUgdXNlZCBpbiBzaXR1YXRpb25zLCB3aGVuIG1haW4gcm91dGluZyBtZXRob2QgZmFpbHMKICAgICAgICAvLyAoZXhjZWVkIGxvb3BzLCBpbmFjY2Vzc2libGUpLgogICAgICAgIGZhbGxiYWNrUm91dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7CgogICAgICAgICAgICAvLyBGaW5kIGEgcm91dGUgd2hpY2ggYnJlYWtzIGJ5IDQ1IGRlZ3JlZXMgaWdub3JpbmcgYWxsIG9ic3RhY2xlcy4KCiAgICAgICAgICAgIHZhciB0aGV0YSA9IGZyb20udGhldGEodG8pOwoKICAgICAgICAgICAgdmFyIGEgPSB7IHg6IHRvLngsIHk6IGZyb20ueSB9OwogICAgICAgICAgICB2YXIgYiA9IHsgeDogZnJvbS54LCB5OiB0by55IH07CgogICAgICAgICAgICBpZiAodGhldGEgJSAxODAgPiA5MCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBhOwogICAgICAgICAgICAgICAgYSA9IGI7CiAgICAgICAgICAgICAgICBiID0gdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHAxID0gKHRoZXRhICUgOTApIDwgNDUgPyBhIDogYjsKCiAgICAgICAgICAgIHZhciBsMSA9IGcubGluZShmcm9tLCBwMSk7CgogICAgICAgICAgICB2YXIgYWxwaGEgPSA5MCAqIE1hdGguY2VpbCh0aGV0YSAvIDkwKTsKCiAgICAgICAgICAgIHZhciBwMiA9IGcucG9pbnQuZnJvbVBvbGFyKGwxLnNxdWFyZWRMZW5ndGgoKSwgZy50b1JhZChhbHBoYSArIDEzNSksIHAxKTsKCiAgICAgICAgICAgIHZhciBsMiA9IGcubGluZSh0bywgcDIpOwoKICAgICAgICAgICAgdmFyIHBvaW50ID0gbDEuaW50ZXJzZWN0aW9uKGwyKTsKCiAgICAgICAgICAgIHJldHVybiBwb2ludCA/IFtwb2ludC5yb3VuZCgpLCB0b10gOiBbdG9dOwogICAgICAgIH0KICAgIH07CgogICAgLy8gcHVibGljIGZ1bmN0aW9uCiAgICByZXR1cm4gZnVuY3Rpb24odmVydGljZXMsIG9wdHMsIGxpbmtWaWV3KSB7CgogICAgICAgIHJldHVybiBqb2ludC5yb3V0ZXJzLm1hbmhhdHRhbih2ZXJ0aWNlcywgXy5leHRlbmQoe30sIGNvbmZpZywgb3B0cyksIGxpbmtWaWV3KTsKICAgIH07Cgp9KSgpOwoKam9pbnQuY29ubmVjdG9ycy5ub3JtYWwgPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzKSB7CgogICAgLy8gQ29uc3RydWN0IHRoZSBgZGAgYXR0cmlidXRlIG9mIHRoZSBgPHBhdGg+YCBlbGVtZW50LgogICAgdmFyIGQgPSBbJ00nLCBzb3VyY2VQb2ludC54LCBzb3VyY2VQb2ludC55XTsKCiAgICBfLmVhY2godmVydGljZXMsIGZ1bmN0aW9uKHZlcnRleCkgewoKICAgICAgICBkLnB1c2godmVydGV4LngsIHZlcnRleC55KTsKICAgIH0pOwoKICAgIGQucHVzaCh0YXJnZXRQb2ludC54LCB0YXJnZXRQb2ludC55KTsKCiAgICByZXR1cm4gZC5qb2luKCcgJyk7Cn07Cgpqb2ludC5jb25uZWN0b3JzLnJvdW5kZWQgPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzLCBvcHRzKSB7CgogICAgdmFyIG9mZnNldCA9IG9wdHMucmFkaXVzIHx8IDEwOwoKICAgIHZhciBjMSwgYzIsIGQxLCBkMiwgcHJldiwgbmV4dDsKCiAgICAvLyBDb25zdHJ1Y3QgdGhlIGBkYCBhdHRyaWJ1dGUgb2YgdGhlIGA8cGF0aD5gIGVsZW1lbnQuCiAgICB2YXIgZCA9IFsnTScsIHNvdXJjZVBvaW50LngsIHNvdXJjZVBvaW50LnldOwoKICAgIF8uZWFjaCh2ZXJ0aWNlcywgZnVuY3Rpb24odmVydGV4LCBpbmRleCkgewoKICAgICAgICAvLyB0aGUgY2xvc2VzdCB2ZXJ0aWNlcwogICAgICAgIHByZXYgPSB2ZXJ0aWNlc1tpbmRleC0xXSB8fCBzb3VyY2VQb2ludDsKICAgICAgICBuZXh0ID0gdmVydGljZXNbaW5kZXgrMV0gfHwgdGFyZ2V0UG9pbnQ7CgogICAgICAgIC8vIGEgaGFsZiBkaXN0YW5jZSB0byB0aGUgY2xvc2VzdCB2ZXJ0ZXgKICAgICAgICBkMSA9IGQyIHx8IGcucG9pbnQodmVydGV4KS5kaXN0YW5jZShwcmV2KSAvIDI7CiAgICAgICAgZDIgPSBnLnBvaW50KHZlcnRleCkuZGlzdGFuY2UobmV4dCkgLyAyOwoKICAgICAgICAvLyBjb250cm9sIHBvaW50cwogICAgICAgIGMxID0gZy5wb2ludCh2ZXJ0ZXgpLm1vdmUocHJldiwgLU1hdGgubWluKG9mZnNldCwgZDEpKS5yb3VuZCgpOwogICAgICAgIGMyID0gZy5wb2ludCh2ZXJ0ZXgpLm1vdmUobmV4dCwgLU1hdGgubWluKG9mZnNldCwgZDIpKS5yb3VuZCgpOwoKICAgICAgICBkLnB1c2goYzEueCwgYzEueSwgJ1MnLCB2ZXJ0ZXgueCwgdmVydGV4LnksIGMyLngsIGMyLnksICdMJyk7CiAgICB9KTsKCiAgICBkLnB1c2godGFyZ2V0UG9pbnQueCwgdGFyZ2V0UG9pbnQueSk7CgogICAgcmV0dXJuIGQuam9pbignICcpOwp9OwoKam9pbnQuY29ubmVjdG9ycy5zbW9vdGggPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzKSB7CgogICAgdmFyIGQ7CgogICAgaWYgKHZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICBkID0gZy5iZXppZXIuY3VydmVUaHJvdWdoUG9pbnRzKFtzb3VyY2VQb2ludF0uY29uY2F0KHZlcnRpY2VzKS5jb25jYXQoW3RhcmdldFBvaW50XSkpOwoKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaWYgd2UgaGF2ZSBubyB2ZXJ0aWNlcyB1c2UgYSBkZWZhdWx0IGN1YmljIGJlemllciBjdXJ2ZSwgY3ViaWMgYmV6aWVyIHJlcXVpcmVzCiAgICAgICAgLy8gdHdvIGNvbnRyb2wgcG9pbnRzLiBUaGUgdHdvIGNvbnRyb2wgcG9pbnRzIGFyZSBib3RoIGRlZmluZWQgd2l0aCBYIGFzIG1pZCB3YXkKICAgICAgICAvLyBiZXR3ZWVuIHRoZSBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMuIFNvdXJjZUNvbnRyb2xQb2ludCBZIGlzIGVxdWFsIHRvIHNvdXJjZVBvaW50IFkKICAgICAgICAvLyBhbmQgdGFyZ2V0Q29udHJvbFBvaW50WSBiZWluZyBlcXVhbCB0byB0YXJnZXRQb2ludFkuIEhhbmRsZSBzaXR1YXRpb24gd2VyZQogICAgICAgIC8vIHNvdXJjZVBvaW50WCBpcyBncmVhdGVyIG9yIGxlc3MgdGhlbiB0YXJnZXRQb2ludFguCiAgICAgICAgdmFyIGNvbnRyb2xQb2ludFggPSAoc291cmNlUG9pbnQueCA8IHRhcmdldFBvaW50LngpIAogICAgICAgICAgICAgICAgPyB0YXJnZXRQb2ludC54IC0gKCh0YXJnZXRQb2ludC54IC0gc291cmNlUG9pbnQueCkgLyAyKQogICAgICAgICAgICAgICAgOiBzb3VyY2VQb2ludC54IC0gKChzb3VyY2VQb2ludC54IC0gdGFyZ2V0UG9pbnQueCkgLyAyKTsKCiAgICAgICAgZCA9IFsKICAgICAgICAgICAgJ00nLCBzb3VyY2VQb2ludC54LCBzb3VyY2VQb2ludC55LAogICAgICAgICAgICAnQycsIGNvbnRyb2xQb2ludFgsIHNvdXJjZVBvaW50LnksIGNvbnRyb2xQb2ludFgsIHRhcmdldFBvaW50LnksCiAgICAgICAgICAgIHRhcmdldFBvaW50LngsIHRhcmdldFBvaW50LnkKICAgICAgICBdOwogICAgfQoKICAgIHJldHVybiBkLmpvaW4oJyAnKTsKfTsKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczoge30sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnQ6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnQsCiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEubGluaycpLkxpbmsKICAgICAgICB9CiAgICB9Owp9CgoKam9pbnQuc2hhcGVzLmVyZCA9IHt9OwoKam9pbnQuc2hhcGVzLmVyZC5FbnRpdHkgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHBvbHlnb24gY2xhc3M9Im91dGVyIi8+PHBvbHlnb24gY2xhc3M9ImlubmVyIi8+PC9nPjx0ZXh0Lz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdlcmQuRW50aXR5JywKICAgICAgICBzaXplOiB7IHdpZHRoOiAxNTAsIGhlaWdodDogNjAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm91dGVyJzogewogICAgICAgICAgICAgICAgZmlsbDogJyMyRUNDNzEnLCBzdHJva2U6ICcjMjdBRTYwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBwb2ludHM6ICcxMDAsMCAxMDAsNjAgMCw2MCAwLDAnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuaW5uZXInOiB7CiAgICAgICAgICAgICAgICBmaWxsOiAnIzJFQ0M3MScsIHN0cm9rZTogJyMyN0FFNjAnLCAnc3Ryb2tlLXdpZHRoJzogMiwKICAgICAgICAgICAgICAgIHBvaW50czogJzk1LDUgOTUsNTUgNSw1NSA1LDUnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRleHQ6IHsKICAgICAgICAgICAgICAgIHRleHQ6ICdFbnRpdHknLAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsJywgJ2ZvbnQtc2l6ZSc6IDE0LAogICAgICAgICAgICAgICAgcmVmOiAnLm91dGVyJywgJ3JlZi14JzogLjUsICdyZWYteSc6IC41LAogICAgICAgICAgICAgICAgJ3gtYWxpZ25tZW50JzogJ21pZGRsZScsICd5LWFsaWdubWVudCc6ICdtaWRkbGUnCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuZGlhLkVsZW1lbnQucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5lcmQuV2Vha0VudGl0eSA9IGpvaW50LnNoYXBlcy5lcmQuRW50aXR5LmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZXJkLldlYWtFbnRpdHknLAoKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLmlubmVyJyA6IHsgZGlzcGxheTogJ2F1dG8nIH0sCiAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ1dlYWsgRW50aXR5JyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5lcmQuRW50aXR5LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZXJkLlJlbGF0aW9uc2hpcCA9IGpvaW50LmRpYS5FbGVtZW50LmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cG9seWdvbiBjbGFzcz0ib3V0ZXIiLz48cG9seWdvbiBjbGFzcz0iaW5uZXIiLz48L2c+PHRleHQvPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdlcmQuUmVsYXRpb25zaGlwJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA4MCwgaGVpZ2h0OiA4MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcub3V0ZXInOiB7CiAgICAgICAgICAgICAgICBmaWxsOiAnIzM0OThEQicsIHN0cm9rZTogJyMyOTgwQjknLCAnc3Ryb2tlLXdpZHRoJzogMiwKICAgICAgICAgICAgICAgIHBvaW50czogJzQwLDAgODAsNDAgNDAsODAgMCw0MCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy5pbm5lcic6IHsKICAgICAgICAgICAgICAgIGZpbGw6ICcjMzQ5OERCJywgc3Ryb2tlOiAnIzI5ODBCOScsICdzdHJva2Utd2lkdGgnOiAyLAogICAgICAgICAgICAgICAgcG9pbnRzOiAnNDAsNSA3NSw0MCA0MCw3NSA1LDQwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJwogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZXh0OiB7CiAgICAgICAgICAgICAgICB0ZXh0OiAnUmVsYXRpb25zaGlwJywKICAgICAgICAgICAgICAgICdmb250LWZhbWlseSc6ICdBcmlhbCcsICdmb250LXNpemUnOiAxMiwKICAgICAgICAgICAgICAgIHJlZjogJy4nLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogLjUsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmVyZC5JZGVudGlmeWluZ1JlbGF0aW9uc2hpcCA9IGpvaW50LnNoYXBlcy5lcmQuUmVsYXRpb25zaGlwLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZXJkLklkZW50aWZ5aW5nUmVsYXRpb25zaGlwJywKCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5pbm5lcic6IHsgZGlzcGxheTogJ2F1dG8nIH0sCiAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ0lkZW50aWZ5aW5nJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5lcmQuUmVsYXRpb25zaGlwLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZSA9IGpvaW50LmRpYS5FbGVtZW50LmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZWxsaXBzZSBjbGFzcz0ib3V0ZXIiLz48ZWxsaXBzZSBjbGFzcz0iaW5uZXIiLz48L2c+PHRleHQvPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5BdHRyaWJ1dGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEwMCwgaGVpZ2h0OiA1MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdlbGxpcHNlJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDUwLCAyNSknCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcub3V0ZXInOiB7CiAgICAgICAgICAgICAgICBzdHJva2U6ICcjRDM1NDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBjeDogMCwgY3k6IDAsIHJ4OiA1MCwgcnk6IDI1LAogICAgICAgICAgICAgICAgZmlsbDogJyNFNjdFMjInCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuaW5uZXInOiB7CiAgICAgICAgICAgICAgICBzdHJva2U6ICcjRDM1NDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBjeDogMCwgY3k6IDAsIHJ4OiA0NSwgcnk6IDIwLAogICAgICAgICAgICAgICAgZmlsbDogJ3RyYW5zcGFyZW50JywgZGlzcGxheTogJ25vbmUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRleHQ6IHsKICAgICAgICAgICAgICAgICAnZm9udC1mYW1pbHknOiAnQXJpYWwnLCAnZm9udC1zaXplJzogMTQsCiAgICAgICAgICAgICAgICAgcmVmOiAnLicsICdyZWYteCc6IC41LCAncmVmLXknOiAuNSwKICAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgIH0KICAgICAgICAgfQoKICAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCgogfSk7Cgogam9pbnQuc2hhcGVzLmVyZC5NdWx0aXZhbHVlZCA9IGpvaW50LnNoYXBlcy5lcmQuQXR0cmlidXRlLmV4dGVuZCh7CgogICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgIHR5cGU6ICdlcmQuTXVsdGl2YWx1ZWQnLAoKICAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgICcuaW5uZXInOiB7IGRpc3BsYXk6ICdibG9jaycgfSwKICAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ211bHRpdmFsdWVkJyB9CiAgICAgICAgIH0KICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCiB9KTsKCiBqb2ludC5zaGFwZXMuZXJkLkRlcml2ZWQgPSBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5leHRlbmQoewoKICAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgICB0eXBlOiAnZXJkLkRlcml2ZWQnLAoKICAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgICcub3V0ZXInOiB7ICdzdHJva2UtZGFzaGFycmF5JzogJzMsNScgfSwKICAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ2Rlcml2ZWQnIH0KICAgICAgICAgfQoKICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCiB9KTsKCiBqb2ludC5zaGFwZXMuZXJkLktleSA9IGpvaW50LnNoYXBlcy5lcmQuQXR0cmlidXRlLmV4dGVuZCh7CgogICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgIHR5cGU6ICdlcmQuS2V5JywKCiAgICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICBlbGxpcHNlOiB7ICdzdHJva2Utd2lkdGgnOiA0IH0sCiAgICAgICAgICAgICB0ZXh0OiB7IHRleHQ6ICdrZXknLCAnZm9udC13ZWlnaHQnOiAnYm9sZCcsICd0ZXh0LWRlY29yYXRpb24nOiAndW5kZXJsaW5lJyB9CiAgICAgICAgIH0KICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmVyZC5Ob3JtYWwgPSBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5Ob3JtYWwnLAoKICAgICAgICBhdHRyczogeyB0ZXh0OiB7IHRleHQ6ICdOb3JtYWwnIH19CgogICAgfSwgam9pbnQuc2hhcGVzLmVyZC5BdHRyaWJ1dGUucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5lcmQuSVNBID0gam9pbnQuZGlhLkVsZW1lbnQuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxwb2x5Z29uLz48L2c+PHRleHQvPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5JU0EnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEwMCwgaGVpZ2h0OiA1MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHBvbHlnb246IHsKICAgICAgICAgICAgICAgIHBvaW50czogJzAsMCA1MCw1MCAxMDAsMCcsCiAgICAgICAgICAgICAgICBmaWxsOiAnI0YxQzQwRicsIHN0cm9rZTogJyNGMzlDMTInLCAnc3Ryb2tlLXdpZHRoJzogMgogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZXh0OiB7CiAgICAgICAgICAgICAgICB0ZXh0OiAnSVNBJywKICAgICAgICAgICAgICAgIHJlZjogJy4nLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogLjMsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCgp9KTsKCmpvaW50LnNoYXBlcy5lcmQuTGluZSA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IHsgdHlwZTogImVyZC5MaW5lIiB9LAoKICAgIGNhcmRpbmFsaXR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0KCdsYWJlbHMnLCBbeyBwb3NpdGlvbjogLTIwLCBhdHRyczogeyB0ZXh0OiB7IGR5OiAtOCwgdGV4dDogdmFsdWUgfX19XSk7CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLmVyZDsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudDogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5lbGVtZW50JykuRWxlbWVudCwKICAgICAgICAgICAgTGluazogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5saW5rJykuTGluawogICAgICAgIH0KICAgIH07Cn0KCmpvaW50LnNoYXBlcy5mc2EgPSB7fTsKCmpvaW50LnNoYXBlcy5mc2EuU3RhdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlLmV4dGVuZCh7CiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgdHlwZTogJ2ZzYS5TdGF0ZScsCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgY2lyY2xlOiB7ICdzdHJva2Utd2lkdGgnOiAzIH0sCiAgICAgICAgICAgIHRleHQ6IHsgJ2ZvbnQtd2VpZ2h0JzogJ2JvbGQnIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZnNhLlN0YXJ0U3RhdGUgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZS8+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2ZzYS5TdGFydFN0YXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyMCwgaGVpZ2h0OiAyMCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIGNpcmNsZTogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogMTAsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuZGlhLkVsZW1lbnQucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5mc2EuRW5kU3RhdGUgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZSBjbGFzcz0ib3V0ZXIiLz48Y2lyY2xlIGNsYXNzPSJpbm5lciIvPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdmc2EuRW5kU3RhdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDIwLCBoZWlnaHQ6IDIwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5vdXRlcic6IHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxMCwgMTApJywKICAgICAgICAgICAgICAgIHI6IDEwLAogICAgICAgICAgICAgICAgZmlsbDogJyNGRkZGRkYnLAogICAgICAgICAgICAgICAgc3Ryb2tlOiAnYmxhY2snCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnLmlubmVyJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogNiwKICAgICAgICAgICAgICAgIGZpbGw6ICcjMDAwMDAwJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LmRpYS5FbGVtZW50LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZnNhLkFycm93ID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7Cgl0eXBlOiAnZnNhLkFycm93JywKICAgICAgICBhdHRyczogeyAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JyB9fSwKICAgICAgICBzbW9vdGg6IHRydWUKICAgIH0sIGpvaW50LmRpYS5MaW5rLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuZnNhOwp9CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgdmFyIGpvaW50ID0gewogICAgICAgIHV0aWw6IHJlcXVpcmUoJy4uL3NyYy9jb3JlJykudXRpbCwKICAgICAgICBzaGFwZXM6IHt9LAogICAgICAgIGRpYTogewogICAgICAgICAgICBFbGVtZW50OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKfQoKam9pbnQuc2hhcGVzLm9yZyA9IHt9OwoKam9pbnQuc2hhcGVzLm9yZy5NZW1iZXIgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHJlY3QgY2xhc3M9ImNhcmQiLz48aW1hZ2UvPjwvZz48dGV4dCBjbGFzcz0icmFuayIvPjx0ZXh0IGNsYXNzPSJuYW1lIi8+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnb3JnLk1lbWJlcicsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMTgwLCBoZWlnaHQ6IDcwIH0sCiAgICAgICAgYXR0cnM6IHsKCiAgICAgICAgICAgIHJlY3Q6IHsgd2lkdGg6IDE3MCwgaGVpZ2h0OiA2MCB9LAoKICAgICAgICAgICAgJy5jYXJkJzogewogICAgICAgICAgICAgICAgZmlsbDogJyNGRkZGRkYnLCBzdHJva2U6ICcjMDAwMDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICAncG9pbnRlci1ldmVudHMnOiAndmlzaWJsZVBhaW50ZWQnLCByeDogMTAsIHJ5OiAxMAogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW1hZ2U6IHsKCQl3aWR0aDogNDgsIGhlaWdodDogNDgsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDEwLCAncmVmLXknOiA1CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIAogICAgICAgICAgICAnLnJhbmsnOiB7CiAgICAgICAgICAgICAgICAndGV4dC1kZWNvcmF0aW9uJzogJ3VuZGVybGluZScsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDAuOSwgJ3JlZi15JzogMC4yLAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0LAoJCSd0ZXh0LWFuY2hvcic6ICdlbmQnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnLm5hbWUnOiB7CiAgICAgICAgICAgICAgICAnZm9udC13ZWlnaHQnOiAnYm9sZCcsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDAuOSwgJ3JlZi15JzogMC42LAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0LAoJCSd0ZXh0LWFuY2hvcic6ICdlbmQnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLm9yZy5BcnJvdyA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IHsKICAgICAgICB0eXBlOiAnb3JnLkFycm93JywKICAgICAgICBzb3VyY2U6IHsgc2VsZWN0b3I6ICcuY2FyZCcgfSwgdGFyZ2V0OiB7IHNlbGVjdG9yOiAnLmNhcmQnIH0sCiAgICAgICAgYXR0cnM6IHsgJy5jb25uZWN0aW9uJzogeyBzdHJva2U6ICcjNTg1ODU4JywgJ3N0cm9rZS13aWR0aCc6IDMgfX0sCiAgICAgICAgejogLTEKICAgIH0KfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLm9yZzsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHt9CiAgICB9Owp9Cgpqb2ludC5zaGFwZXMuY2hlc3MgPSB7fTsKCmpvaW50LnNoYXBlcy5jaGVzcy5LaW5nV2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9ImZpbGw6bm9uZTsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPjxwYXRoICAgICAgZD0iTSAyMi41LDExLjYzIEwgMjIuNSw2IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMjAsOCBMIDI1LDgiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyMi41LDI1IEMgMjIuNSwyNSAyNywxNy41IDI1LjUsMTQuNSBDIDI1LjUsMTQuNSAyNC41LDEyIDIyLjUsMTIgQyAyMC41LDEyIDE5LjUsMTQuNSAxOS41LDE0LjUgQyAxOCwxNy41IDIyLjUsMjUgMjIuNSwyNSIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLWxpbmVjYXA6YnV0dDsgc3Ryb2tlLWxpbmVqb2luOm1pdGVyOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLjUsMzcgQyAxNyw0MC41IDI3LDQwLjUgMzIuNSwzNyBMIDMyLjUsMzAgQyAzMi41LDMwIDQxLjUsMjUuNSAzOC41LDE5LjUgQyAzNC41LDEzIDI1LDE2IDIyLjUsMjMuNSBMIDIyLjUsMjcgTCAyMi41LDIzLjUgQyAxOSwxNiA5LjUsMTMgNi41LDE5LjUgQyAzLjUsMjUuNSAxMS41LDI5LjUgMTEuNSwyOS41IEwgMTEuNSwzNyB6ICIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMS41LDMwIEMgMTcsMjcgMjcsMjcgMzIuNSwzMCIgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMS41LDMzLjUgQyAxNywzMC41IDI3LDMwLjUgMzIuNSwzMy41IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLjUsMzcgQyAxNywzNCAyNywzNCAzMi41LDM3IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS2luZ1doaXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA0MiwgaGVpZ2h0OiAzOCB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5LaW5nQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9ImZpbGw6bm9uZTsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8cGF0aCAgICAgICBkPSJNIDIyLjUsMTEuNjMgTCAyMi41LDYiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAgICAgICBpZD0icGF0aDY1NzAiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMjIuNSwyNSBDIDIyLjUsMjUgMjcsMTcuNSAyNS41LDE0LjUgQyAyNS41LDE0LjUgMjQuNSwxMiAyMi41LDEyIEMgMjAuNSwxMiAxOS41LDE0LjUgMTkuNSwxNC41IEMgMTgsMTcuNSAyMi41LDI1IDIyLjUsMjUiICAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7ZmlsbC1vcGFjaXR5OjE7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMTEuNSwzNyBDIDE3LDQwLjUgMjcsNDAuNSAzMi41LDM3IEwgMzIuNSwzMCBDIDMyLjUsMzAgNDEuNSwyNS41IDM4LjUsMTkuNSBDIDM0LjUsMTMgMjUsMTYgMjIuNSwyMy41IEwgMjIuNSwyNyBMIDIyLjUsMjMuNSBDIDE5LDE2IDkuNSwxMyA2LjUsMTkuNSBDIDMuNSwyNS41IDExLjUsMjkuNSAxMS41LDI5LjUgTCAxMS41LDM3IHogIiAgICAgICBzdHlsZT0iZmlsbDojMDAwMDAwOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMjAsOCBMIDI1LDgiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgICBkPSJNIDMyLDI5LjUgQyAzMiwyOS41IDQwLjUsMjUuNSAzOC4wMywxOS44NSBDIDM0LjE1LDE0IDI1LDE4IDIyLjUsMjQuNSBMIDIyLjUxLDI2LjYgTCAyMi41LDI0LjUgQyAyMCwxOCA5LjkwNiwxNCA2Ljk5NywxOS44NSBDIDQuNSwyNS41IDExLjg1LDI4Ljg1IDExLjg1LDI4Ljg1IiAgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6I2ZmZmZmZjsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMTEuNSwzMCBDIDE3LDI3IDI3LDI3IDMyLjUsMzAgTSAxMS41LDMzLjUgQyAxNywzMC41IDI3LDMwLjUgMzIuNSwzMy41IE0gMTEuNSwzNyBDIDE3LDM0IDI3LDM0IDMyLjUsMzciICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS2luZ0JsYWNrJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA0MiwgaGVpZ2h0OiAzOCB9CiAgICAgICAgCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlF1ZWVuV2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDojZmZmZmZmOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEsLTEpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSAxMyBBIDIgMiAwIDEgMSAgNSwxMyBBIDIgMiAwIDEgMSAgOSAxMyB6IiAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1LjUsLTUuNSkiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzIsLTEpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSAxMyBBIDIgMiAwIDEgMSAgNSwxMyBBIDIgMiAwIDEgMSAgOSAxMyB6IiAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcsLTQuNSkiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjQsLTQpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSwyNiBDIDE3LjUsMjQuNSAzMCwyNC41IDM2LDI2IEwgMzgsMTQgTCAzMSwyNSBMIDMxLDExIEwgMjUuNSwyNC41IEwgMjIuNSw5LjUgTCAxOS41LDI0LjUgTCAxNCwxMC41IEwgMTQsMjUgTCA3LDE0IEwgOSwyNiB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5LDI2IEMgOSwyOCAxMC41LDI4IDExLjUsMzAgQyAxMi41LDMxLjUgMTIuNSwzMSAxMiwzMy41IEMgMTAuNSwzNC41IDEwLjUsMzYgMTAuNSwzNiBDIDksMzcuNSAxMSwzOC41IDExLDM4LjUgQyAxNy41LDM5LjUgMjcuNSwzOS41IDM0LDM4LjUgQyAzNCwzOC41IDM1LjUsMzcuNSAzNCwzNiBDIDM0LDM2IDM0LjUsMzQuNSAzMywzMy41IEMgMzIuNSwzMSAzMi41LDMxLjUgMzMuNSwzMCBDIDM0LjUsMjggMzYsMjggMzYsMjYgQyAyNy41LDI0LjUgMTcuNSwyNC41IDksMjYgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTEuNSwzMCBDIDE1LDI5IDMwLDI5IDMzLjUsMzAiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzMy41IEMgMTgsMzIuNSAyNywzMi41IDMzLDMzLjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsiIC8+ICA8L2c+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlF1ZWVuV2hpdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDQyLCBoZWlnaHQ6IDM4IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlF1ZWVuQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDojMDAwMDAwOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxnIHN0eWxlPSJmaWxsOiMwMDAwMDA7IHN0cm9rZTpub25lOyI+ICAgICAgPGNpcmNsZSBjeD0iNiIgICAgY3k9IjEyIiByPSIyLjc1IiAvPiAgICAgIDxjaXJjbGUgY3g9IjE0IiAgIGN5PSI5IiAgcj0iMi43NSIgLz4gICAgICA8Y2lyY2xlIGN4PSIyMi41IiBjeT0iOCIgIHI9IjIuNzUiIC8+ICAgICAgPGNpcmNsZSBjeD0iMzEiICAgY3k9IjkiICByPSIyLjc1IiAvPiAgICAgIDxjaXJjbGUgY3g9IjM5IiAgIGN5PSIxMiIgcj0iMi43NSIgLz4gICAgPC9nPiAgICA8cGF0aCAgICAgICBkPSJNIDksMjYgQyAxNy41LDI0LjUgMzAsMjQuNSAzNiwyNiBMIDM4LjUsMTMuNSBMIDMxLDI1IEwgMzAuNywxMC45IEwgMjUuNSwyNC41IEwgMjIuNSwxMCBMIDE5LjUsMjQuNSBMIDE0LjMsMTAuOSBMIDE0LDI1IEwgNi41LDEzLjUgTCA5LDI2IHoiICAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gOSwyNiBDIDksMjggMTAuNSwyOCAxMS41LDMwIEMgMTIuNSwzMS41IDEyLjUsMzEgMTIsMzMuNSBDIDEwLjUsMzQuNSAxMC41LDM2IDEwLjUsMzYgQyA5LDM3LjUgMTEsMzguNSAxMSwzOC41IEMgMTcuNSwzOS41IDI3LjUsMzkuNSAzNCwzOC41IEMgMzQsMzguNSAzNS41LDM3LjUgMzQsMzYgQyAzNCwzNiAzNC41LDM0LjUgMzMsMzMuNSBDIDMyLjUsMzEgMzIuNSwzMS41IDMzLjUsMzAgQyAzNC41LDI4IDM2LDI4IDM2LDI2IEMgMjcuNSwyNC41IDE3LjUsMjQuNSA5LDI2IHoiICAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMSwzOC41IEEgMzUsMzUgMSAwIDAgMzQsMzguNSIgICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgICBkPSJNIDExLDI5IEEgMzUsMzUgMSAwIDEgMzQsMjkiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMi41LDMxLjUgTCAzMi41LDMxLjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMS41LDM0LjUgQSAzNSwzNSAxIDAgMCAzMy41LDM0LjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMC41LDM3LjUgQSAzNSwzNSAxIDAgMCAzNC41LDM3LjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuUXVlZW5CbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNDIsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuUm9va1doaXRlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxnIHN0eWxlPSJvcGFjaXR5OjE7IGZpbGw6I2ZmZmZmZjsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSwzOSBMIDM2LDM5IEwgMzYsMzYgTCA5LDM2IEwgOSwzOSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzNiBMIDEyLDMyIEwgMzMsMzIgTCAzMywzNiBMIDEyLDM2IHogIiAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLDE0IEwgMTEsOSBMIDE1LDkgTCAxNSwxMSBMIDIwLDExIEwgMjAsOSBMIDI1LDkgTCAyNSwxMSBMIDMwLDExIEwgMzAsOSBMIDM0LDkgTCAzNCwxNCIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAzNCwxNCBMIDMxLDE3IEwgMTQsMTcgTCAxMSwxNCIgLz4gICAgPHBhdGggICAgICBkPSJNIDMxLDE3IEwgMzEsMjkuNSBMIDE0LDI5LjUgTCAxNCwxNyIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsgc3Ryb2tlLWxpbmVqb2luOm1pdGVyOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDMxLDI5LjUgTCAzMi41LDMyIEwgMTIuNSwzMiBMIDE0LDI5LjUiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMSwxNCBMIDM0LDE0IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5Sb29rV2hpdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDMyLCBoZWlnaHQ6IDM0IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlJvb2tCbGFjayA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZyBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOiMwMDAwMDA7IGZpbGwtb3BhY2l0eToxOyBmaWxsLXJ1bGU6ZXZlbm9kZDsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDo0OyBzdHJva2UtZGFzaGFycmF5Om5vbmU7IHN0cm9rZS1vcGFjaXR5OjE7Ij4gICAgPHBhdGggICAgICBkPSJNIDksMzkgTCAzNiwzOSBMIDM2LDM2IEwgOSwzNiBMIDksMzkgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTIuNSwzMiBMIDE0LDI5LjUgTCAzMSwyOS41IEwgMzIuNSwzMiBMIDEyLjUsMzIgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTIsMzYgTCAxMiwzMiBMIDMzLDMyIEwgMzMsMzYgTCAxMiwzNiB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxNCwyOS41IEwgMTQsMTYuNSBMIDMxLDE2LjUgTCAzMSwyOS41IEwgMTQsMjkuNSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMTYuNSBMIDExLDE0IEwgMzQsMTQgTCAzMSwxNi41IEwgMTQsMTYuNSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMSwxNCBMIDExLDkgTCAxNSw5IEwgMTUsMTEgTCAyMCwxMSBMIDIwLDkgTCAyNSw5IEwgMjUsMTEgTCAzMCwxMSBMIDMwLDkgTCAzNCw5IEwgMzQsMTQgTCAxMSwxNCB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzNS41IEwgMzMsMzUuNSBMIDMzLDM1LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTMsMzEuNSBMIDMyLDMxLjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMjkuNSBMIDMxLDI5LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMTYuNSBMIDMxLDE2LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTEsMTQgTCAzNCwxNCIgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6I2ZmZmZmZjsgc3Ryb2tlLXdpZHRoOjE7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICA8L2c+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlJvb2tCbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzIsIGhlaWdodDogMzQgfQogICAgICAgIAogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5CaXNob3BXaGl0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZyBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOm5vbmU7IGZpbGwtcnVsZTpldmVub2RkOyBmaWxsLW9wYWNpdHk6MTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kOyBzdHJva2UtbGluZWpvaW46cm91bmQ7IHN0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8ZyBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLWxpbmVjYXA6YnV0dDsiPiAgICAgICA8cGF0aCAgICAgICAgZD0iTSA5LDM2IEMgMTIuMzksMzUuMDMgMTkuMTEsMzYuNDMgMjIuNSwzNCBDIDI1Ljg5LDM2LjQzIDMyLjYxLDM1LjAzIDM2LDM2IEMgMzYsMzYgMzcuNjUsMzYuNTQgMzksMzggQyAzOC4zMiwzOC45NyAzNy4zNSwzOC45OSAzNiwzOC41IEMgMzIuNjEsMzcuNTMgMjUuODksMzguOTYgMjIuNSwzNy41IEMgMTkuMTEsMzguOTYgMTIuMzksMzcuNTMgOSwzOC41IEMgNy42NDYsMzguOTkgNi42NzcsMzguOTcgNiwzOCBDIDcuMzU0LDM2LjA2IDksMzYgOSwzNiB6IiAvPiAgICAgIDxwYXRoICAgICAgICBkPSJNIDE1LDMyIEMgMTcuNSwzNC41IDI3LjUsMzQuNSAzMCwzMiBDIDMwLjUsMzAuNSAzMCwzMCAzMCwzMCBDIDMwLDI3LjUgMjcuNSwyNiAyNy41LDI2IEMgMzMsMjQuNSAzMy41LDE0LjUgMjIuNSwxMC41IEMgMTEuNSwxNC41IDEyLDI0LjUgMTcuNSwyNiBDIDE3LjUsMjYgMTUsMjcuNSAxNSwzMCBDIDE1LDMwIDE0LjUsMzAuNSAxNSwzMiB6IiAvPiAgICAgIDxwYXRoICAgICAgICBkPSJNIDI1IDggQSAyLjUgMi41IDAgMSAxICAyMCw4IEEgMi41IDIuNSAwIDEgMSAgMjUgOCB6IiAvPiAgICA8L2c+ICAgIDxwYXRoICAgICAgZD0iTSAxNy41LDI2IEwgMjcuNSwyNiBNIDE1LDMwIEwgMzAsMzAgTSAyMi41LDE1LjUgTCAyMi41LDIwLjUgTSAyMCwxOCBMIDI1LDE4IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5CaXNob3BXaGl0ZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuQmlzaG9wQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLXJ1bGU6ZXZlbm9kZDsgZmlsbC1vcGFjaXR5OjE7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDsgc3Ryb2tlLWxpbmVqb2luOnJvdW5kOyBzdHJva2UtbWl0ZXJsaW1pdDo0OyBzdHJva2UtZGFzaGFycmF5Om5vbmU7IHN0cm9rZS1vcGFjaXR5OjE7Ij4gICAgPGcgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7Ij4gICAgICAgPHBhdGggICAgICAgIGQ9Ik0gOSwzNiBDIDEyLjM5LDM1LjAzIDE5LjExLDM2LjQzIDIyLjUsMzQgQyAyNS44OSwzNi40MyAzMi42MSwzNS4wMyAzNiwzNiBDIDM2LDM2IDM3LjY1LDM2LjU0IDM5LDM4IEMgMzguMzIsMzguOTcgMzcuMzUsMzguOTkgMzYsMzguNSBDIDMyLjYxLDM3LjUzIDI1Ljg5LDM4Ljk2IDIyLjUsMzcuNSBDIDE5LjExLDM4Ljk2IDEyLjM5LDM3LjUzIDksMzguNSBDIDcuNjQ2LDM4Ljk5IDYuNjc3LDM4Ljk3IDYsMzggQyA3LjM1NCwzNi4wNiA5LDM2IDksMzYgeiIgLz4gICAgICA8cGF0aCAgICAgICAgZD0iTSAxNSwzMiBDIDE3LjUsMzQuNSAyNy41LDM0LjUgMzAsMzIgQyAzMC41LDMwLjUgMzAsMzAgMzAsMzAgQyAzMCwyNy41IDI3LjUsMjYgMjcuNSwyNiBDIDMzLDI0LjUgMzMuNSwxNC41IDIyLjUsMTAuNSBDIDExLjUsMTQuNSAxMiwyNC41IDE3LjUsMjYgQyAxNy41LDI2IDE1LDI3LjUgMTUsMzAgQyAxNSwzMCAxNC41LDMwLjUgMTUsMzIgeiIgLz4gICAgICA8cGF0aCAgICAgICAgZD0iTSAyNSA4IEEgMi41IDIuNSAwIDEgMSAgMjAsOCBBIDIuNSAyLjUgMCAxIDEgIDI1IDggeiIgLz4gICAgPC9nPiAgICA8cGF0aCAgICAgICBkPSJNIDE3LjUsMjYgTCAyNy41LDI2IE0gMTUsMzAgTCAzMCwzMCBNIDIyLjUsMTUuNSBMIDIyLjUsMjAuNSBNIDIwLDE4IEwgMjUsMTgiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5CaXNob3BCbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuS25pZ2h0V2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSAyMiwxMCBDIDMyLjUsMTEgMzguNSwxOCAzOCwzOSBMIDE1LDM5IEMgMTUsMzAgMjUsMzIuNSAyMywxOCIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyNCwxOCBDIDI0LjM4LDIwLjkxIDE4LjQ1LDI1LjM3IDE2LDI3IEMgMTMsMjkgMTMuMTgsMzEuMzQgMTEsMzEgQyA5Ljk1OCwzMC4wNiAxMi40MSwyNy45NiAxMSwyOCBDIDEwLDI4IDExLjE5LDI5LjIzIDEwLDMwIEMgOSwzMCA1Ljk5NywzMSA2LDI2IEMgNiwyNCAxMiwxNCAxMiwxNCBDIDEyLDE0IDEzLjg5LDEyLjEgMTQsMTAuNSBDIDEzLjI3LDkuNTA2IDEzLjUsOC41IDEzLjUsNy41IEMgMTQuNSw2LjUgMTYuNSwxMCAxNi41LDEwIEwgMTguNSwxMCBDIDE4LjUsMTAgMTkuMjgsOC4wMDggMjEsNyBDIDIyLDcgMjIsMTAgMjIsMTAiICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOS41IDI1LjUgQSAwLjUgMC41IDAgMSAxIDguNSwyNS41IEEgMC41IDAuNSAwIDEgMSA5LjUgMjUuNSB6IiAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7IHN0cm9rZTojMDAwMDAwOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDE1IDE1LjUgQSAwLjUgMS41IDAgMSAxICAxNCwxNS41IEEgMC41IDEuNSAwIDEgMSAgMTUgMTUuNSB6IiAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDAuODY2LDAuNSwtMC41LDAuODY2LDkuNjkzLC01LjE3MykiICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5LbmlnaHRXaGl0ZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzcgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuS25pZ2h0QmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSAyMiwxMCBDIDMyLjUsMTEgMzguNSwxOCAzOCwzOSBMIDE1LDM5IEMgMTUsMzAgMjUsMzIuNSAyMywxOCIgICAgICBzdHlsZT0iZmlsbDojMDAwMDAwOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyNCwxOCBDIDI0LjM4LDIwLjkxIDE4LjQ1LDI1LjM3IDE2LDI3IEMgMTMsMjkgMTMuMTgsMzEuMzQgMTEsMzEgQyA5Ljk1OCwzMC4wNiAxMi40MSwyNy45NiAxMSwyOCBDIDEwLDI4IDExLjE5LDI5LjIzIDEwLDMwIEMgOSwzMCA1Ljk5NywzMSA2LDI2IEMgNiwyNCAxMiwxNCAxMiwxNCBDIDEyLDE0IDEzLjg5LDEyLjEgMTQsMTAuNSBDIDEzLjI3LDkuNTA2IDEzLjUsOC41IDEzLjUsNy41IEMgMTQuNSw2LjUgMTYuNSwxMCAxNi41LDEwIEwgMTguNSwxMCBDIDE4LjUsMTAgMTkuMjgsOC4wMDggMjEsNyBDIDIyLDcgMjIsMTAgMjIsMTAiICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOS41IDI1LjUgQSAwLjUgMC41IDAgMSAxIDguNSwyNS41IEEgMC41IDAuNSAwIDEgMSA5LjUgMjUuNSB6IiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDE1IDE1LjUgQSAwLjUgMS41IDAgMSAxICAxNCwxNS41IEEgMC41IDEuNSAwIDEgMSAgMTUgMTUuNSB6IiAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDAuODY2LDAuNSwtMC41LDAuODY2LDkuNjkzLC01LjE3MykiICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjsgc3Ryb2tlOiNmZmZmZmY7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMjQuNTUsMTAuNCBMIDI0LjEsMTEuODUgTCAyNC42LDEyIEMgMjcuNzUsMTMgMzAuMjUsMTQuNDkgMzIuNSwxOC43NSBDIDM0Ljc1LDIzLjAxIDM1Ljc1LDI5LjA2IDM1LjI1LDM5IEwgMzUuMiwzOS41IEwgMzcuNDUsMzkuNSBMIDM3LjUsMzkgQyAzOCwyOC45NCAzNi42MiwyMi4xNSAzNC4yNSwxNy42NiBDIDMxLjg4LDEzLjE3IDI4LjQ2LDExLjAyIDI1LjA2LDEwLjUgTCAyNC41NSwxMC40IHogIiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTpub25lOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS25pZ2h0QmxhY2snLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDM4LCBoZWlnaHQ6IDM3IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlBhd25XaGl0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cGF0aCBkPSJNIDIyLDkgQyAxOS43OSw5IDE4LDEwLjc5IDE4LDEzIEMgMTgsMTMuODkgMTguMjksMTQuNzEgMTguNzgsMTUuMzggQyAxNi44MywxNi41IDE1LjUsMTguNTkgMTUuNSwyMSBDIDE1LjUsMjMuMDMgMTYuNDQsMjQuODQgMTcuOTEsMjYuMDMgQyAxNC45MSwyNy4wOSAxMC41LDMxLjU4IDEwLjUsMzkuNSBMIDMzLjUsMzkuNSBDIDMzLjUsMzEuNTggMjkuMDksMjcuMDkgMjYuMDksMjYuMDMgQyAyNy41NiwyNC44NCAyOC41LDIzLjAzIDI4LjUsMjEgQyAyOC41LDE4LjU5IDI3LjE3LDE2LjUgMjUuMjIsMTUuMzggQyAyNS43MSwxNC43MSAyNiwxMy44OSAyNiwxMyBDIDI2LDEwLjc5IDI0LjIxLDkgMjIsOSB6ICIgIHN0eWxlPSJvcGFjaXR5OjE7IGZpbGw6I2ZmZmZmZjsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpub256ZXJvOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7IHN0cm9rZS1saW5lam9pbjptaXRlcjsgc3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyIgLz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuUGF3bldoaXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyOCwgaGVpZ2h0OiAzMyB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5QYXduQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHBhdGggZD0iTSAyMiw5IEMgMTkuNzksOSAxOCwxMC43OSAxOCwxMyBDIDE4LDEzLjg5IDE4LjI5LDE0LjcxIDE4Ljc4LDE1LjM4IEMgMTYuODMsMTYuNSAxNS41LDE4LjU5IDE1LjUsMjEgQyAxNS41LDIzLjAzIDE2LjQ0LDI0Ljg0IDE3LjkxLDI2LjAzIEMgMTQuOTEsMjcuMDkgMTAuNSwzMS41OCAxMC41LDM5LjUgTCAzMy41LDM5LjUgQyAzMy41LDMxLjU4IDI5LjA5LDI3LjA5IDI2LjA5LDI2LjAzIEMgMjcuNTYsMjQuODQgMjguNSwyMy4wMyAyOC41LDIxIEMgMjguNSwxOC41OSAyNy4xNywxNi41IDI1LjIyLDE1LjM4IEMgMjUuNzEsMTQuNzEgMjYsMTMuODkgMjYsMTMgQyAyNiwxMC43OSAyNC4yMSw5IDIyLDkgeiAiICBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOiMwMDAwMDA7IGZpbGwtb3BhY2l0eToxOyBmaWxsLXJ1bGU6bm9uemVybzsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IHN0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiIC8+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlBhd25CbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMjgsIGhlaWdodDogMzMgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuY2hlc3M7Cn0KCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczogewogICAgICAgICAgICBiYXNpYzogcmVxdWlyZSgnLi9qb2ludC5zaGFwZXMuYmFzaWMnKQogICAgICAgIH0sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnRWaWV3OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50VmlldywKICAgICAgICAgICAgTGluazogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5saW5rJykuTGluawogICAgICAgIH0KICAgIH07Cn0KCmpvaW50LnNoYXBlcy5wbiA9IHt9OwoKam9pbnQuc2hhcGVzLnBuLlBsYWNlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxjaXJjbGUgY2xhc3M9InJvb3QiLz48ZyBjbGFzcz0idG9rZW5zIiAvPjwvZz48dGV4dCBjbGFzcz0ibGFiZWwiLz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdwbi5QbGFjZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNTAsIGhlaWdodDogNTAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLnJvb3QnOiB7CiAgICAgICAgICAgICAgICByOiAyNSwKICAgICAgICAgICAgICAgIGZpbGw6ICd3aGl0ZScsCiAgICAgICAgICAgICAgICBzdHJva2U6ICdibGFjaycsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDI1KScKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy5sYWJlbCc6IHsKICAgICAgICAgICAgICAgICd0ZXh0LWFuY2hvcic6ICdtaWRkbGUnLAogICAgICAgICAgICAgICAgJ3JlZi14JzogLjUsCiAgICAgICAgICAgICAgICAncmVmLXknOiAtMjAsCiAgICAgICAgICAgICAgICByZWY6ICcucm9vdCcsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snLAogICAgICAgICAgICAgICAgJ2ZvbnQtc2l6ZSc6IDEyCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudG9rZW5zID4gY2lyY2xlJzogewogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgIHI6IDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy50b2tlbnMub25lID4gY2lyY2xlJzogeyB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDI1KScgfSwKICAgICAgICAgICAgCiAgICAgICAgICAgICcudG9rZW5zLnR3byA+IGNpcmNsZTpudGgtY2hpbGQoMSknOiB7IHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxOSwgMjUpJyB9LAogICAgICAgICAgICAnLnRva2Vucy50d28gPiBjaXJjbGU6bnRoLWNoaWxkKDIpJzogeyB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMzEsIDI1KScgfSwKICAgICAgICAgICAgCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgxKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDE4LCAyOSknIH0sCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgyKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDI1LCAxOSknIH0sCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgzKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDMyLCAyOSknIH0sCgogICAgICAgICAgICAnLnRva2Vucy5hbG90ID4gdGV4dCc6IHsKCQl0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDE4KScsCgkJJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCgpqb2ludC5zaGFwZXMucG4uUGxhY2VWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3LmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6dG9rZW5zJywgZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLnJlbmRlclRva2VucygpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZSgpOwoKICAgICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdGhpcy5yZW5kZXJUb2tlbnMoKTsKICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgfSwKCiAgICByZW5kZXJUb2tlbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgJHRva2VucyA9IHRoaXMuJCgnLnRva2VucycpLmVtcHR5KCk7CiAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCA9ICd0b2tlbnMnOwoKICAgICAgICB2YXIgdG9rZW5zID0gdGhpcy5tb2RlbC5nZXQoJ3Rva2VucycpOwoKICAgICAgICBpZiAoIXRva2VucykgcmV0dXJuOwoKICAgICAgICBzd2l0Y2ggKHRva2VucykgewoKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCArPSAnIG9uZSc7CiAgICAgICAgICAgICR0b2tlbnMuYXBwZW5kKFYoJzxjaXJjbGUvPicpLm5vZGUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICR0b2tlbnNbMF0uY2xhc3NOYW1lLmJhc2VWYWwgKz0gJyB0d28nOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAkdG9rZW5zWzBdLmNsYXNzTmFtZS5iYXNlVmFsICs9ICcgdGhyZWUnOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCArPSAnIGFsb3QnOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8dGV4dC8+JykudGV4dCh0b2tlbnMgKyAnJyApLm5vZGUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9Cn0pOwoKCmpvaW50LnNoYXBlcy5wbi5UcmFuc2l0aW9uID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0IGNsYXNzPSJyb290Ii8+PC9nPjwvZz48dGV4dCBjbGFzcz0ibGFiZWwiLz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3BuLlRyYW5zaXRpb24nLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEyLCBoZWlnaHQ6IDUwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJ3JlY3QnOiB7CiAgICAgICAgICAgICAgICB3aWR0aDogMTIsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IDUwLAogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJ2JsYWNrJwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLmxhYmVsJzogewogICAgICAgICAgICAgICAgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAncmVmLXgnOiAuNSwKICAgICAgICAgICAgICAgICdyZWYteSc6IC0yMCwKICAgICAgICAgICAgICAgIHJlZjogJ3JlY3QnLAogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgICdmb250LXNpemUnOiAxMgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMucG4uTGluayA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICBhdHRyczogeyAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JyB9fQogICAgICAgIAogICAgfSwgam9pbnQuZGlhLkxpbmsucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICBtb2R1bGUuZXhwb3J0cyA9IGpvaW50LnNoYXBlcy5wbjsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudFZpZXc6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnRWaWV3LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCmpvaW50LnNoYXBlcy5kZXZzID0ge307Cgpqb2ludC5zaGFwZXMuZGV2cy5Nb2RlbCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZChfLmV4dGVuZCh7fSwgam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UsIHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0IGNsYXNzPSJib2R5Ii8+PC9nPjx0ZXh0IGNsYXNzPSJsYWJlbCIvPjxnIGNsYXNzPSJpblBvcnRzIi8+PGcgY2xhc3M9Im91dFBvcnRzIi8+PC9nPicsCiAgICBwb3J0TWFya3VwOiAnPGcgY2xhc3M9InBvcnQgcG9ydDwlPSBpZCAlPiI+PGNpcmNsZSBjbGFzcz0icG9ydC1ib2R5Ii8+PHRleHQgY2xhc3M9InBvcnQtbGFiZWwiLz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdkZXZzLk1vZGVsJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAxLCBoZWlnaHQ6IDEgfSwKICAgICAgICAKICAgICAgICBpblBvcnRzOiBbXSwKICAgICAgICBvdXRQb3J0czogW10sCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcuJzogeyBtYWduZXQ6IGZhbHNlIH0sCiAgICAgICAgICAgICcuYm9keSc6IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAxNTAsIGhlaWdodDogMjUwLAogICAgICAgICAgICAgICAgc3Ryb2tlOiAnYmxhY2snCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcucG9ydC1ib2R5JzogewogICAgICAgICAgICAgICAgcjogMTAsCiAgICAgICAgICAgICAgICBtYWduZXQ6IHRydWUsCiAgICAgICAgICAgICAgICBzdHJva2U6ICdibGFjaycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgICdwb2ludGVyLWV2ZW50cyc6ICdub25lJwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLmxhYmVsJzogeyB0ZXh0OiAnTW9kZWwnLCAncmVmLXgnOiAuMywgJ3JlZi15JzogLjIgfSwKICAgICAgICAgICAgJy5pblBvcnRzIC5wb3J0LWxhYmVsJzogeyB4Oi0xNSwgZHk6IDQsICd0ZXh0LWFuY2hvcic6ICdlbmQnIH0sCiAgICAgICAgICAgICcub3V0UG9ydHMgLnBvcnQtbGFiZWwnOnsgeDogMTUsIGR5OiA0IH0KICAgICAgICB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBnZXRQb3J0QXR0cnM6IGZ1bmN0aW9uKHBvcnROYW1lLCBpbmRleCwgdG90YWwsIHNlbGVjdG9yLCB0eXBlKSB7CgogICAgICAgIHZhciBhdHRycyA9IHt9OwoKICAgICAgICB2YXIgcG9ydENsYXNzID0gJ3BvcnQnICsgaW5kZXg7CiAgICAgICAgdmFyIHBvcnRTZWxlY3RvciA9IHNlbGVjdG9yICsgJz4uJyArIHBvcnRDbGFzczsKICAgICAgICB2YXIgcG9ydExhYmVsU2VsZWN0b3IgPSBwb3J0U2VsZWN0b3IgKyAnPi5wb3J0LWxhYmVsJzsKICAgICAgICB2YXIgcG9ydEJvZHlTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+LnBvcnQtYm9keSc7CgogICAgICAgIGF0dHJzW3BvcnRMYWJlbFNlbGVjdG9yXSA9IHsgdGV4dDogcG9ydE5hbWUgfTsKICAgICAgICBhdHRyc1twb3J0Qm9keVNlbGVjdG9yXSA9IHsgcG9ydDogeyBpZDogcG9ydE5hbWUgfHwgXy51bmlxdWVJZCh0eXBlKSAsIHR5cGU6IHR5cGUgfSB9OwogICAgICAgIGF0dHJzW3BvcnRTZWxlY3Rvcl0gPSB7IHJlZjogJy5ib2R5JywgJ3JlZi15JzogKGluZGV4ICsgMC41KSAqICgxIC8gdG90YWwpIH07CgogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJy5vdXRQb3J0cycpIHsgYXR0cnNbcG9ydFNlbGVjdG9yXVsncmVmLWR4J10gPSAwOyB9CgogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KfSkpOwoKCmpvaW50LnNoYXBlcy5kZXZzLkF0b21pYyA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZGV2cy5BdG9taWMnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDgwLCBoZWlnaHQ6IDgwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5ib2R5JzogeyBmaWxsOiAnc2FsbW9uJyB9LAogICAgICAgICAgICAnLmxhYmVsJzogeyB0ZXh0OiAnQXRvbWljJyB9LAogICAgICAgICAgICAnLmluUG9ydHMgLnBvcnQtYm9keSc6IHsgZmlsbDogJ1BhbGVHcmVlbicgfSwKICAgICAgICAgICAgJy5vdXRQb3J0cyAucG9ydC1ib2R5JzogeyBmaWxsOiAnVG9tYXRvJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLnByb3RvdHlwZS5kZWZhdWx0cykKCn0pOwoKam9pbnQuc2hhcGVzLmRldnMuQ291cGxlZCA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZGV2cy5Db3VwbGVkJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyMDAsIGhlaWdodDogMzAwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5ib2R5JzogeyBmaWxsOiAnc2VhR3JlZW4nIH0sCiAgICAgICAgICAgICcubGFiZWwnOiB7IHRleHQ6ICdDb3VwbGVkJyB9LAogICAgICAgICAgICAnLmluUG9ydHMgLnBvcnQtYm9keSc6IHsgZmlsbDogJ1BhbGVHcmVlbicgfSwKICAgICAgICAgICAgJy5vdXRQb3J0cyAucG9ydC1ib2R5JzogeyBmaWxsOiAnVG9tYXRvJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZGV2cy5MaW5rID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICdkZXZzLkxpbmsnLAogICAgICAgIGF0dHJzOiB7ICcuY29ubmVjdGlvbicgOiB7ICdzdHJva2Utd2lkdGgnIDogIDIgfX0KICAgIH0KfSk7Cgpqb2ludC5zaGFwZXMuZGV2cy5Nb2RlbFZpZXcgPSBqb2ludC5kaWEuRWxlbWVudFZpZXcuZXh0ZW5kKGpvaW50LnNoYXBlcy5iYXNpYy5Qb3J0c1ZpZXdJbnRlcmZhY2UpOwpqb2ludC5zaGFwZXMuZGV2cy5BdG9taWNWaWV3ID0gam9pbnQuc2hhcGVzLmRldnMuTW9kZWxWaWV3Owpqb2ludC5zaGFwZXMuZGV2cy5Db3VwbGVkVmlldyA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsVmlldzsKCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuZGV2czsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudFZpZXc6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnRWaWV3LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCmpvaW50LnNoYXBlcy51bWwgPSB7fQoKam9pbnQuc2hhcGVzLnVtbC5DbGFzcyA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJyb3RhdGFibGUiPicsCiAgICAgICAgICAnPGcgY2xhc3M9InNjYWxhYmxlIj4nLAogICAgICAgICAgICAnPHJlY3QgY2xhc3M9InVtbC1jbGFzcy1uYW1lLXJlY3QiLz48cmVjdCBjbGFzcz0idW1sLWNsYXNzLWF0dHJzLXJlY3QiLz48cmVjdCBjbGFzcz0idW1sLWNsYXNzLW1ldGhvZHMtcmVjdCIvPicsCiAgICAgICAgICAnPC9nPicsCiAgICAgICAgICAnPHRleHQgY2xhc3M9InVtbC1jbGFzcy1uYW1lLXRleHQiLz48dGV4dCBjbGFzcz0idW1sLWNsYXNzLWF0dHJzLXRleHQiLz48dGV4dCBjbGFzcz0idW1sLWNsYXNzLW1ldGhvZHMtdGV4dCIvPicsCiAgICAgICAgJzwvZz4nCiAgICBdLmpvaW4oJycpLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5DbGFzcycsCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHJlY3Q6IHsgJ3dpZHRoJzogMjAwIH0sCgogICAgICAgICAgICAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnOiB7ICdzdHJva2UnOiAnYmxhY2snLCAnc3Ryb2tlLXdpZHRoJzogMiwgJ2ZpbGwnOiAnIzM0OThkYicgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtYXR0cnMtcmVjdCc6IHsgJ3N0cm9rZSc6ICdibGFjaycsICdzdHJva2Utd2lkdGgnOiAyLCAnZmlsbCc6ICcjMjk4MGI5JyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1tZXRob2RzLXJlY3QnOiB7ICdzdHJva2UnOiAnYmxhY2snLCAnc3Ryb2tlLXdpZHRoJzogMiwgJ2ZpbGwnOiAnIzI5ODBiOScgfSwKCiAgICAgICAgICAgICcudW1sLWNsYXNzLW5hbWUtdGV4dCc6IHsKICAgICAgICAgICAgICAgICdyZWYnOiAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnLCAncmVmLXknOiAuNSwgJ3JlZi14JzogLjUsICd0ZXh0LWFuY2hvcic6ICdtaWRkbGUnLCAneS1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ2ZvbnQtd2VpZ2h0JzogJ2JvbGQnLAogICAgICAgICAgICAgICAgJ2ZpbGwnOiAnYmxhY2snLCAnZm9udC1zaXplJzogMTIsICdmb250LWZhbWlseSc6ICdUaW1lcyBOZXcgUm9tYW4nCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudW1sLWNsYXNzLWF0dHJzLXRleHQnOiB7CiAgICAgICAgICAgICAgICAncmVmJzogJy51bWwtY2xhc3MtYXR0cnMtcmVjdCcsICdyZWYteSc6IDUsICdyZWYteCc6IDUsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICdibGFjaycsICdmb250LXNpemUnOiAxMiwgJ2ZvbnQtZmFtaWx5JzogJ1RpbWVzIE5ldyBSb21hbicKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtbWV0aG9kcy10ZXh0JzogewogICAgICAgICAgICAgICAgJ3JlZic6ICcudW1sLWNsYXNzLW1ldGhvZHMtcmVjdCcsICdyZWYteSc6IDUsICdyZWYteCc6IDUsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICdibGFjaycsICdmb250LXNpemUnOiAxMiwgJ2ZvbnQtZmFtaWx5JzogJ1RpbWVzIE5ldyBSb21hbicKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG5hbWU6IFtdLAogICAgICAgIGF0dHJpYnV0ZXM6IFtdLAogICAgICAgIG1ldGhvZHM6IFtdCgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5vbignY2hhbmdlOm5hbWUgY2hhbmdlOmF0dHJpYnV0ZXMgY2hhbmdlOm1ldGhvZHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVSZWN0YW5nbGVzKCk7CgkgICAgdGhpcy50cmlnZ2VyKCd1bWwtdXBkYXRlJyk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHRoaXMudXBkYXRlUmVjdGFuZ2xlcygpOwoKICAgICAgICBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBnZXRDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnbmFtZScpOwogICAgfSwKCiAgICB1cGRhdGVSZWN0YW5nbGVzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGF0dHJzID0gdGhpcy5nZXQoJ2F0dHJzJyk7CgogICAgICAgIHZhciByZWN0cyA9IFsKICAgICAgICAgICAgeyB0eXBlOiAnbmFtZScsIHRleHQ6IHRoaXMuZ2V0Q2xhc3NOYW1lKCkgfSwKICAgICAgICAgICAgeyB0eXBlOiAnYXR0cnMnLCB0ZXh0OiB0aGlzLmdldCgnYXR0cmlidXRlcycpIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ21ldGhvZHMnLCB0ZXh0OiB0aGlzLmdldCgnbWV0aG9kcycpIH0KICAgICAgICBdOwoKICAgICAgICB2YXIgb2Zmc2V0WSA9IDA7CgogICAgICAgIF8uZWFjaChyZWN0cywgZnVuY3Rpb24ocmVjdCkgewoKICAgICAgICAgICAgdmFyIGxpbmVzID0gXy5pc0FycmF5KHJlY3QudGV4dCkgPyByZWN0LnRleHQgOiBbcmVjdC50ZXh0XTsKCSAgICB2YXIgcmVjdEhlaWdodCA9IGxpbmVzLmxlbmd0aCAqIDIwICsgMjA7CgogICAgICAgICAgICBhdHRyc1snLnVtbC1jbGFzcy0nICsgcmVjdC50eXBlICsgJy10ZXh0J10udGV4dCA9IGxpbmVzLmpvaW4oJ1xuJyk7CiAgICAgICAgICAgIGF0dHJzWycudW1sLWNsYXNzLScgKyByZWN0LnR5cGUgKyAnLXJlY3QnXS5oZWlnaHQgPSByZWN0SGVpZ2h0OwogICAgICAgICAgICBhdHRyc1snLnVtbC1jbGFzcy0nICsgcmVjdC50eXBlICsgJy1yZWN0J10udHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgwLCcrIG9mZnNldFkgKyAnKSc7CgogICAgICAgICAgICBvZmZzZXRZICs9IHJlY3RIZWlnaHQ7CiAgICAgICAgfSk7CiAgICB9Cgp9KTsKCmpvaW50LnNoYXBlcy51bWwuQ2xhc3NWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3LmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ3VtbC11cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgICAgICAgdGhpcy5yZXNpemUoKTsKICAgICAgICB9KTsKICAgIH0KfSk7Cgpqb2ludC5zaGFwZXMudW1sLkFic3RyYWN0ID0gam9pbnQuc2hhcGVzLnVtbC5DbGFzcy5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgICAgICB0eXBlOiAndW1sLkFic3RyYWN0JywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnOiB7IGZpbGwgOiAnI2U3NGMzYycgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtYXR0cnMtcmVjdCc6IHsgZmlsbCA6ICcjYzAzOTJiJyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1tZXRob2RzLXJlY3QnOiB7IGZpbGwgOiAnI2MwMzkyYicgfQogICAgICAgIH0KICAgIH0sIGpvaW50LnNoYXBlcy51bWwuQ2xhc3MucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBnZXRDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBbJzw8QWJzdHJhY3Q+PicsIHRoaXMuZ2V0KCduYW1lJyldOwogICAgfQoKfSk7CmpvaW50LnNoYXBlcy51bWwuQWJzdHJhY3RWaWV3ID0gam9pbnQuc2hhcGVzLnVtbC5DbGFzc1ZpZXc7Cgpqb2ludC5zaGFwZXMudW1sLkludGVyZmFjZSA9IGpvaW50LnNoYXBlcy51bWwuQ2xhc3MuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgdHlwZTogJ3VtbC5JbnRlcmZhY2UnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcudW1sLWNsYXNzLW5hbWUtcmVjdCc6IHsgZmlsbCA6ICcjZjFjNDBmJyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1hdHRycy1yZWN0JzogeyBmaWxsIDogJyNmMzljMTInIH0sCiAgICAgICAgICAgICcudW1sLWNsYXNzLW1ldGhvZHMtcmVjdCc6IHsgZmlsbCA6ICcjZjM5YzEyJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLnVtbC5DbGFzcy5wcm90b3R5cGUuZGVmYXVsdHMpLAoKICAgIGdldENsYXNzTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFsnPDxJbnRlcmZhY2U+PicsIHRoaXMuZ2V0KCduYW1lJyldOwogICAgfQoKfSk7CmpvaW50LnNoYXBlcy51bWwuSW50ZXJmYWNlVmlldyA9IGpvaW50LnNoYXBlcy51bWwuQ2xhc3NWaWV3OwoKam9pbnQuc2hhcGVzLnVtbC5HZW5lcmFsaXphdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuR2VuZXJhbGl6YXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gMjAgMCBMIDAgMTAgTCAyMCAyMCB6JywgZmlsbDogJ3doaXRlJyB9fQogICAgfQp9KTsKCmpvaW50LnNoYXBlcy51bWwuSW1wbGVtZW50YXRpb24gPSBqb2ludC5kaWEuTGluay5leHRlbmQoewogICAgZGVmYXVsdHM6IHsKICAgICAgICB0eXBlOiAndW1sLkltcGxlbWVudGF0aW9uJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDIwIDAgTCAwIDEwIEwgMjAgMjAgeicsIGZpbGw6ICd3aGl0ZScgfSwKICAgICAgICAgICAgJy5jb25uZWN0aW9uJzogeyAnc3Ryb2tlLWRhc2hhcnJheSc6ICczLDMnIH0KICAgICAgICB9CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5BZ2dyZWdhdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuQWdncmVnYXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gNDAgMTAgTCAyMCAyMCBMIDAgMTAgTCAyMCAwIHonLCBmaWxsOiAnd2hpdGUnIH19CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5Db21wb3NpdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuQ29tcG9zaXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gNDAgMTAgTCAyMCAyMCBMIDAgMTAgTCAyMCAwIHonLCBmaWxsOiAnYmxhY2snIH19CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5Bc3NvY2lhdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogeyB0eXBlOiAndW1sLkFzc29jaWF0aW9uJyB9Cn0pOwoKLy8gU3RhdGVjaGFydAoKam9pbnQuc2hhcGVzLnVtbC5TdGF0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJyb3RhdGFibGUiPicsCiAgICAgICAgICAnPGcgY2xhc3M9InNjYWxhYmxlIj4nLAogICAgICAgICAgICAnPHJlY3QgY2xhc3M9InVtbC1zdGF0ZS1ib2R5Ii8+JywKICAgICAgICAgICc8L2c+JywKICAgICAgICAgICc8cGF0aCBjbGFzcz0idW1sLXN0YXRlLXNlcGFyYXRvciIvPicsCiAgICAgICAgICAnPHRleHQgY2xhc3M9InVtbC1zdGF0ZS1uYW1lIi8+JywKICAgICAgICAgICc8dGV4dCBjbGFzcz0idW1sLXN0YXRlLWV2ZW50cyIvPicsCiAgICAgICAgJzwvZz4nCiAgICBdLmpvaW4oJycpLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5TdGF0ZScsCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcudW1sLXN0YXRlLWJvZHknOiB7CiAgICAgICAgICAgICAgICAnd2lkdGgnOiAyMDAsICdoZWlnaHQnOiAyMDAsICdyeCc6IDEwLCAncnknOiAxMCwKICAgICAgICAgICAgICAgICdmaWxsJzogJyNlY2YwZjEnLCAnc3Ryb2tlJzogJyNiZGMzYzcnLCAnc3Ryb2tlLXdpZHRoJzogMwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLnVtbC1zdGF0ZS1zZXBhcmF0b3InOiB7CiAgICAgICAgICAgICAgICAnc3Ryb2tlJzogJyNiZGMzYzcnLCAnc3Ryb2tlLXdpZHRoJzogMgogICAgICAgICAgICB9LAogICAgICAgICAgICAnLnVtbC1zdGF0ZS1uYW1lJzogewogICAgICAgICAgICAgICAgJ3JlZic6ICcudW1sLXN0YXRlLWJvZHknLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogNSwgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICcjMDAwMDAwJywgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudW1sLXN0YXRlLWV2ZW50cyc6IHsKICAgICAgICAgICAgICAgICdyZWYnOiAnLnVtbC1zdGF0ZS1zZXBhcmF0b3InLCAncmVmLXgnOiA1LCAncmVmLXknOiA1LAogICAgICAgICAgICAgICAgJ2ZpbGwnOiAnIzAwMDAwMCcsICdmb250LWZhbWlseSc6ICdDb3VyaWVyIE5ldycsICdmb250LXNpemUnOiAxNAogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbmFtZTogJ1N0YXRlJywKICAgICAgICBldmVudHM6IFtdCgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5vbih7CiAgICAgICAgICAgICdjaGFuZ2U6bmFtZSc6IHRoaXMudXBkYXRlTmFtZSwKICAgICAgICAgICAgJ2NoYW5nZTpldmVudHMnOiB0aGlzLnVwZGF0ZUV2ZW50cywKICAgICAgICAgICAgJ2NoYW5nZTpzaXplJzogdGhpcy51cGRhdGVQYXRoCiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHRoaXMudXBkYXRlTmFtZSgpOwogICAgICAgIHRoaXMudXBkYXRlRXZlbnRzKCk7CiAgICAgICAgdGhpcy51cGRhdGVQYXRoKCk7CgogICAgICAgIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHVwZGF0ZU5hbWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLmF0dHIoJy51bWwtc3RhdGUtbmFtZS90ZXh0JywgdGhpcy5nZXQoJ25hbWUnKSk7CiAgICB9LAoKICAgIHVwZGF0ZUV2ZW50czogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMuYXR0cignLnVtbC1zdGF0ZS1ldmVudHMvdGV4dCcsIHRoaXMuZ2V0KCdldmVudHMnKS5qb2luKCdcbicpKTsKICAgIH0sCgogICAgdXBkYXRlUGF0aDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBkID0gJ00gMCAyMCBMICcgKyB0aGlzLmdldCgnc2l6ZScpLndpZHRoICsgJyAyMCc7CgogICAgICAgIC8vIFdlIGFyZSB1c2luZyBgc2lsZW50OiB0cnVlYCBoZXJlIGJlY2F1c2UgdXBkYXRlUGF0aCgpIGlzIG1lYW50IHRvIGJlIGNhbGxlZAogICAgICAgIC8vIG9uIHJlc2l6ZSBhbmQgdGhlcmUncyBubyBuZWVkIHRvIHRvIHVwZGF0ZSB0aGUgZWxlbWVudCB0d2ljZSAoYGNoYW5nZTpzaXplYAogICAgICAgIC8vIHRyaWdnZXJzIGFsc28gYW4gdXBkYXRlKS4KICAgICAgICB0aGlzLmF0dHIoJy51bWwtc3RhdGUtc2VwYXJhdG9yL2QnLCBkLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgIH0KCn0pOwoKam9pbnQuc2hhcGVzLnVtbC5TdGFydFN0YXRlID0gam9pbnQuc2hhcGVzLmJhc2ljLkNpcmNsZS5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5TdGFydFN0YXRlJywKICAgICAgICBhdHRyczogeyBjaXJjbGU6IHsgJ2ZpbGwnOiAnIzM0NDk1ZScsICdzdHJva2UnOiAnIzJjM2U1MCcsICdzdHJva2Utd2lkdGgnOiAyLCAncngnOiAxIH19CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkNpcmNsZS5wcm90b3R5cGUuZGVmYXVsdHMpCgp9KTsKCmpvaW50LnNoYXBlcy51bWwuRW5kU3RhdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZSBjbGFzcz0ib3V0ZXIiLz48Y2lyY2xlIGNsYXNzPSJpbm5lciIvPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICd1bWwuRW5kU3RhdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDIwLCBoZWlnaHQ6IDIwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJ2NpcmNsZS5vdXRlcic6IHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxMCwgMTApJywKICAgICAgICAgICAgICAgIHI6IDEwLAogICAgICAgICAgICAgICAgZmlsbDogJ3doaXRlJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJyMyYzNlNTAnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnY2lyY2xlLmlubmVyJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogNiwKICAgICAgICAgICAgICAgIGZpbGw6ICcjMzQ0OTVlJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKCn0pOwoKam9pbnQuc2hhcGVzLnVtbC5UcmFuc2l0aW9uID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKICAgIGRlZmF1bHRzOiB7CiAgICAgICAgdHlwZTogJ3VtbC5UcmFuc2l0aW9uJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JywgZmlsbDogJyMzNDQ5NWUnLCBzdHJva2U6ICcjMmMzZTUwJyB9LAogICAgICAgICAgICAnLmNvbm5lY3Rpb24nOiB7IHN0cm9rZTogJyMyYzNlNTAnIH0KICAgICAgICB9CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLnVtbDsKfQoKOyhmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09ImZ1bmN0aW9uIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3Rocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK28rIiciKX12YXIgZj1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwoZi5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxmLGYuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBnbG9iYWw9dHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge307LyoqCiAqIEBsaWNlbnNlCiAqIENvcHlyaWdodCAoYykgMjAxMi0yMDEzIENocmlzIFBldHRpdHQKICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAqCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqLwpnbG9iYWwuZGFncmUgPSByZXF1aXJlKCIuL2luZGV4Iik7Cgp9LHsiLi9pbmRleCI6Mn1dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKgpDb3B5cmlnaHQgKGMpIDIwMTItMjAxMyBDaHJpcyBQZXR0aXR0CgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCmluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbApjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCk9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KVEhFIFNPRlRXQVJFLgoqLwpleHBvcnRzLkRpZ3JhcGggPSByZXF1aXJlKCJncmFwaGxpYiIpLkRpZ3JhcGg7CmV4cG9ydHMuR3JhcGggPSByZXF1aXJlKCJncmFwaGxpYiIpLkdyYXBoOwpleHBvcnRzLmxheW91dCA9IHJlcXVpcmUoIi4vbGliL2xheW91dCIpOwpleHBvcnRzLnZlcnNpb24gPSByZXF1aXJlKCIuL2xpYi92ZXJzaW9uIik7Cgp9LHsiLi9saWIvbGF5b3V0IjozLCIuL2xpYi92ZXJzaW9uIjoxOCwiZ3JhcGhsaWIiOjI0fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyksCiAgICByYW5rID0gcmVxdWlyZSgnLi9yYW5rJyksCiAgICBvcmRlciA9IHJlcXVpcmUoJy4vb3JkZXInKSwKICAgIENHcmFwaCA9IHJlcXVpcmUoJ2dyYXBobGliJykuQ0dyYXBoLAogICAgQ0RpZ3JhcGggPSByZXF1aXJlKCdncmFwaGxpYicpLkNEaWdyYXBoOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAvLyBFeHRlcm5hbCBjb25maWd1cmF0aW9uCiAgdmFyIGNvbmZpZyA9IHsKICAgIC8vIEhvdyBtdWNoIGRlYnVnIGluZm9ybWF0aW9uIHRvIGluY2x1ZGU/CiAgICBkZWJ1Z0xldmVsOiAwLAogICAgLy8gTWF4IG51bWJlciBvZiBzd2VlcHMgdG8gcGVyZm9ybSBpbiBvcmRlciBwaGFzZQogICAgb3JkZXJNYXhTd2VlcHM6IG9yZGVyLkRFRkFVTFRfTUFYX1NXRUVQUywKICAgIC8vIFVzZSBuZXR3b3JrIHNpbXBsZXggYWxnb3JpdGhtIGluIHJhbmtpbmcKICAgIHJhbmtTaW1wbGV4OiBmYWxzZSwKICAgIC8vIFJhbmsgZGlyZWN0aW9uLiBWYWxpZCB2YWx1ZXMgYXJlIChUQiwgTFIpCiAgICByYW5rRGlyOiAnVEInCiAgfTsKCiAgLy8gUGhhc2UgZnVuY3Rpb25zCiAgdmFyIHBvc2l0aW9uID0gcmVxdWlyZSgnLi9wb3NpdGlvbicpKCk7CgogIC8vIFRoaXMgbGF5b3V0IG9iamVjdAogIHZhciBzZWxmID0ge307CgogIHNlbGYub3JkZXJJdGVycyA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdvcmRlck1heFN3ZWVwcycpOwoKICBzZWxmLnJhbmtTaW1wbGV4ID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ3JhbmtTaW1wbGV4Jyk7CgogIHNlbGYubm9kZVNlcCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24ubm9kZVNlcCk7CiAgc2VsZi5lZGdlU2VwID0gZGVsZWdhdGVQcm9wZXJ0eShwb3NpdGlvbi5lZGdlU2VwKTsKICBzZWxmLnVuaXZlcnNhbFNlcCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24udW5pdmVyc2FsU2VwKTsKICBzZWxmLnJhbmtTZXAgPSBkZWxlZ2F0ZVByb3BlcnR5KHBvc2l0aW9uLnJhbmtTZXApOwogIHNlbGYucmFua0RpciA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdyYW5rRGlyJyk7CiAgc2VsZi5kZWJ1Z0FsaWdubWVudCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24uZGVidWdBbGlnbm1lbnQpOwoKICBzZWxmLmRlYnVnTGV2ZWwgPSB1dGlsLnByb3BlcnR5QWNjZXNzb3Ioc2VsZiwgY29uZmlnLCAnZGVidWdMZXZlbCcsIGZ1bmN0aW9uKHgpIHsKICAgIHV0aWwubG9nLmxldmVsID0geDsKICAgIHBvc2l0aW9uLmRlYnVnTGV2ZWwoeCk7CiAgfSk7CgogIHNlbGYucnVuID0gdXRpbC50aW1lKCdUb3RhbCBsYXlvdXQnLCBydW4pOwoKICBzZWxmLl9ub3JtYWxpemUgPSBub3JtYWxpemU7CgogIHJldHVybiBzZWxmOwoKICAvKgogICAqIENvbnN0cnVjdHMgYW4gYWRqYWNlbmN5IGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgc3BlY2lmaWVkIHRocm91Z2gKICAgKiBjb25maWcuIEZvciBlYWNoIG5vZGUgYW5kIGVkZ2Ugd2UgYWRkIGEgcHJvcGVydHkgYGRhZ3JlYCB0aGF0IGNvbnRhaW5zIGFuCiAgICogb2JqZWN0IHRoYXQgd2lsbCBob2xkIGludGVybWVkaWF0ZSBhbmQgZmluYWwgbGF5b3V0IGluZm9ybWF0aW9uLiBTb21lIG9mCiAgICogdGhlIGNvbnRlbnRzIGluY2x1ZGU6CiAgICoKICAgKiAgMSkgQSBnZW5lcmF0ZWQgSUQgdGhhdCB1bmlxdWVseSBpZGVudGlmaWVzIHRoZSBvYmplY3QuCiAgICogIDIpIERpbWVuc2lvbiBpbmZvcm1hdGlvbiBmb3Igbm9kZXMgKGNvcGllZCBmcm9tIHRoZSBzb3VyY2Ugbm9kZSkuCiAgICogIDMpIE9wdGlvbmFsIGRpbWVuc2lvbiBpbmZvcm1hdGlvbiBmb3IgZWRnZXMuCiAgICoKICAgKiBBZnRlciB0aGUgYWRqYWNlbmN5IGdyYXBoIGlzIGNvbnN0cnVjdGVkIHRoZSBjb2RlIG5vIGxvbmdlciBuZWVkcyB0byB1c2UKICAgKiB0aGUgb3JpZ2luYWwgbm9kZXMgYW5kIGVkZ2VzIHBhc3NlZCBpbiB2aWEgY29uZmlnLgogICAqLwogIGZ1bmN0aW9uIGluaXRMYXlvdXRHcmFwaChpbnB1dEdyYXBoKSB7CiAgICB2YXIgZyA9IG5ldyBDRGlncmFwaCgpOwoKICAgIGlucHV0R3JhcGguZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHZhbHVlID0ge307CiAgICAgIGcuYWRkTm9kZSh1LCB7CiAgICAgICAgd2lkdGg6IHZhbHVlLndpZHRoLAogICAgICAgIGhlaWdodDogdmFsdWUuaGVpZ2h0CiAgICAgIH0pOwogICAgICBpZiAodmFsdWUuaGFzT3duUHJvcGVydHkoJ3JhbmsnKSkgewogICAgICAgIGcubm9kZSh1KS5wcmVmUmFuayA9IHZhbHVlLnJhbms7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFNldCB1cCBzdWJncmFwaHMKICAgIGlmIChpbnB1dEdyYXBoLnBhcmVudCkgewogICAgICBpbnB1dEdyYXBoLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgICAgZy5wYXJlbnQodSwgaW5wdXRHcmFwaC5wYXJlbnQodSkpOwogICAgICB9KTsKICAgIH0KCiAgICBpbnB1dEdyYXBoLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB2YWx1ZSA9IHt9OwogICAgICB2YXIgbmV3VmFsdWUgPSB7CiAgICAgICAgZTogZSwKICAgICAgICBtaW5MZW46IHZhbHVlLm1pbkxlbiB8fCAxLAogICAgICAgIHdpZHRoOiB2YWx1ZS53aWR0aCB8fCAwLAogICAgICAgIGhlaWdodDogdmFsdWUuaGVpZ2h0IHx8IDAsCiAgICAgICAgcG9pbnRzOiBbXQogICAgICB9OwoKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIG5ld1ZhbHVlKTsKICAgIH0pOwoKICAgIC8vIEluaXRpYWwgZ3JhcGggYXR0cmlidXRlcwogICAgdmFyIGdyYXBoVmFsdWUgPSBpbnB1dEdyYXBoLmdyYXBoKCkgfHwge307CiAgICBnLmdyYXBoKHsKICAgICAgcmFua0RpcjogZ3JhcGhWYWx1ZS5yYW5rRGlyIHx8IGNvbmZpZy5yYW5rRGlyLAogICAgICBvcmRlclJlc3RhcnRzOiBncmFwaFZhbHVlLm9yZGVyUmVzdGFydHMKICAgIH0pOwoKICAgIHJldHVybiBnOwogIH0KCiAgZnVuY3Rpb24gcnVuKGlucHV0R3JhcGgpIHsKICAgIHZhciByYW5rU2VwID0gc2VsZi5yYW5rU2VwKCk7CiAgICB2YXIgZzsKICAgIHRyeSB7CiAgICAgIC8vIEJ1aWxkIGludGVybmFsIGdyYXBoCiAgICAgIGcgPSB1dGlsLnRpbWUoJ2luaXRMYXlvdXRHcmFwaCcsIGluaXRMYXlvdXRHcmFwaCkoaW5wdXRHcmFwaCk7CgogICAgICBpZiAoZy5vcmRlcigpID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGc7CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3BhY2UgZm9yIGVkZ2UgbGFiZWxzCiAgICAgIGcuZWFjaEVkZ2UoZnVuY3Rpb24oZSwgcywgdCwgYSkgewogICAgICAgIGEubWluTGVuICo9IDI7CiAgICAgIH0pOwogICAgICBzZWxmLnJhbmtTZXAocmFua1NlcCAvIDIpOwoKICAgICAgLy8gRGV0ZXJtaW5lIHRoZSByYW5rIGZvciBlYWNoIG5vZGUuIE5vZGVzIHdpdGggYSBsb3dlciByYW5rIHdpbGwgYXBwZWFyCiAgICAgIC8vIGFib3ZlIG5vZGVzIG9mIGhpZ2hlciByYW5rLgogICAgICB1dGlsLnRpbWUoJ3JhbmsucnVuJywgcmFuay5ydW4pKGcsIGNvbmZpZy5yYW5rU2ltcGxleCk7CgogICAgICAvLyBOb3JtYWxpemUgdGhlIGdyYXBoIGJ5IGVuc3VyaW5nIHRoYXQgZXZlcnkgZWRnZSBpcyBwcm9wZXIgKGVhY2ggZWRnZSBoYXMKICAgICAgLy8gYSBsZW5ndGggb2YgMSkuIFdlIGFjaGlldmUgdGhpcyBieSBhZGRpbmcgZHVtbXkgbm9kZXMgdG8gbG9uZyBlZGdlcywKICAgICAgLy8gdGh1cyBzaG9ydGVuaW5nIHRoZW0uCiAgICAgIHV0aWwudGltZSgnbm9ybWFsaXplJywgbm9ybWFsaXplKShnKTsKCiAgICAgIC8vIE9yZGVyIHRoZSBub2RlcyBzbyB0aGF0IGVkZ2UgY3Jvc3NpbmdzIGFyZSBtaW5pbWl6ZWQuCiAgICAgIHV0aWwudGltZSgnb3JkZXInLCBvcmRlcikoZywgY29uZmlnLm9yZGVyTWF4U3dlZXBzKTsKCiAgICAgIC8vIEZpbmQgdGhlIHggYW5kIHkgY29vcmRpbmF0ZXMgZm9yIGV2ZXJ5IG5vZGUgaW4gdGhlIGdyYXBoLgogICAgICB1dGlsLnRpbWUoJ3Bvc2l0aW9uJywgcG9zaXRpb24ucnVuKShnKTsKCiAgICAgIC8vIERlLW5vcm1hbGl6ZSB0aGUgZ3JhcGggYnkgcmVtb3ZpbmcgZHVtbXkgbm9kZXMgYW5kIGF1Z21lbnRpbmcgdGhlCiAgICAgIC8vIG9yaWdpbmFsIGxvbmcgZWRnZXMgd2l0aCBjb29yZGluYXRlIGluZm9ybWF0aW9uLgogICAgICB1dGlsLnRpbWUoJ3VuZG9Ob3JtYWxpemUnLCB1bmRvTm9ybWFsaXplKShnKTsKCiAgICAgIC8vIFJldmVyc2VzIHBvaW50cyBmb3IgZWRnZXMgdGhhdCBhcmUgaW4gYSByZXZlcnNlZCBzdGF0ZS4KICAgICAgdXRpbC50aW1lKCdmaXh1cEVkZ2VQb2ludHMnLCBmaXh1cEVkZ2VQb2ludHMpKGcpOwoKICAgICAgLy8gUmVzdG9yZSBkZWxldGUgZWRnZXMgYW5kIHJldmVyc2UgZWRnZXMgdGhhdCB3ZXJlIHJldmVyc2VkIGluIHRoZSByYW5rCiAgICAgIC8vIHBoYXNlLgogICAgICB1dGlsLnRpbWUoJ3JhbmsucmVzdG9yZUVkZ2VzJywgcmFuay5yZXN0b3JlRWRnZXMpKGcpOwoKICAgICAgLy8gQ29uc3RydWN0IGZpbmFsIHJlc3VsdCBncmFwaCBhbmQgcmV0dXJuIGl0CiAgICAgIHJldHVybiB1dGlsLnRpbWUoJ2NyZWF0ZUZpbmFsR3JhcGgnLCBjcmVhdGVGaW5hbEdyYXBoKShnLCBpbnB1dEdyYXBoLmlzRGlyZWN0ZWQoKSk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZWxmLnJhbmtTZXAocmFua1NlcCk7CiAgICB9CiAgfQoKICAvKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgcmVzcG9uc2libGUgZm9yICdub3JtYWxpemluZycgdGhlIGdyYXBoLiBUaGUgcHJvY2VzcyBvZgogICAqIG5vcm1hbGl6YXRpb24gZW5zdXJlcyB0aGF0IG5vIGVkZ2UgaW4gdGhlIGdyYXBoIGhhcyBzcGFucyBtb3JlIHRoYW4gb25lCiAgICogcmFuay4gVG8gZG8gdGhpcyBpdCBpbnNlcnRzIGR1bW15IG5vZGVzIGFzIG5lZWRlZCBhbmQgbGlua3MgdGhlbSBieSBhZGRpbmcKICAgKiBkdW1teSBlZGdlcy4gVGhpcyBmdW5jdGlvbiBrZWVwcyBlbm91Z2ggaW5mb3JtYXRpb24gaW4gdGhlIGR1bW15IG5vZGVzIGFuZAogICAqIGVkZ2VzIHRvIGVuc3VyZSB0aGF0IHRoZSBvcmlnaW5hbCBncmFwaCBjYW4gYmUgcmVjb25zdHJ1Y3RlZCBsYXRlci4KICAgKgogICAqIFRoaXMgbWV0aG9kIGFzc3VtZXMgdGhhdCB0aGUgaW5wdXQgZ3JhcGggaXMgY3ljbGUgZnJlZS4KICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemUoZykgewogICAgdmFyIGR1bW15Q291bnQgPSAwOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCBzLCB0LCBhKSB7CiAgICAgIHZhciBzb3VyY2VSYW5rID0gZy5ub2RlKHMpLnJhbms7CiAgICAgIHZhciB0YXJnZXRSYW5rID0gZy5ub2RlKHQpLnJhbms7CiAgICAgIGlmIChzb3VyY2VSYW5rICsgMSA8IHRhcmdldFJhbmspIHsKICAgICAgICBmb3IgKHZhciB1ID0gcywgcmFuayA9IHNvdXJjZVJhbmsgKyAxLCBpID0gMDsgcmFuayA8IHRhcmdldFJhbms7ICsrcmFuaywgKytpKSB7CiAgICAgICAgICB2YXIgdiA9ICdfRCcgKyAoKytkdW1teUNvdW50KTsKICAgICAgICAgIHZhciBub2RlID0gewogICAgICAgICAgICB3aWR0aDogYS53aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBhLmhlaWdodCwKICAgICAgICAgICAgZWRnZTogeyBpZDogZSwgc291cmNlOiBzLCB0YXJnZXQ6IHQsIGF0dHJzOiBhIH0sCiAgICAgICAgICAgIHJhbms6IHJhbmssCiAgICAgICAgICAgIGR1bW15OiB0cnVlCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIElmIHRoaXMgbm9kZSByZXByZXNlbnRzIGEgYmVuZCB0aGVuIHdlIHdpbGwgdXNlIGl0IGFzIGEgY29udHJvbAogICAgICAgICAgLy8gcG9pbnQuIEZvciBlZGdlcyB3aXRoIDIgc2VnbWVudHMgdGhpcyB3aWxsIGJlIHRoZSBjZW50ZXIgZHVtbXkKICAgICAgICAgIC8vIG5vZGUuIEZvciBlZGdlcyB3aXRoIG1vcmUgdGhhbiB0d28gc2VnbWVudHMsIHRoaXMgd2lsbCBiZSB0aGUKICAgICAgICAgIC8vIGZpcnN0IGFuZCBsYXN0IGR1bW15IG5vZGUuCiAgICAgICAgICBpZiAoaSA9PT0gMCkgbm9kZS5pbmRleCA9IDA7CiAgICAgICAgICBlbHNlIGlmIChyYW5rICsgMSA9PT0gdGFyZ2V0UmFuaykgbm9kZS5pbmRleCA9IDE7CgogICAgICAgICAgZy5hZGROb2RlKHYsIG5vZGUpOwogICAgICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHt9KTsKICAgICAgICAgIHUgPSB2OwogICAgICAgIH0KICAgICAgICBnLmFkZEVkZ2UobnVsbCwgdSwgdCwge30pOwogICAgICAgIGcuZGVsRWRnZShlKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKgogICAqIFJlY29uc3RydWN0cyB0aGUgZ3JhcGggYXMgaXQgd2FzIGJlZm9yZSBub3JtYWxpemF0aW9uLiBUaGUgcG9zaXRpb25zIG9mCiAgICogZHVtbXkgbm9kZXMgYXJlIHVzZWQgdG8gYnVpbGQgYW4gYXJyYXkgb2YgcG9pbnRzIGZvciB0aGUgb3JpZ2luYWwgJ2xvbmcnCiAgICogZWRnZS4gRHVtbXkgbm9kZXMgYW5kIGVkZ2VzIGFyZSByZW1vdmVkLgogICAqLwogIGZ1bmN0aW9uIHVuZG9Ob3JtYWxpemUoZykgewogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1LCBhKSB7CiAgICAgIGlmIChhLmR1bW15KSB7CiAgICAgICAgaWYgKCdpbmRleCcgaW4gYSkgewogICAgICAgICAgdmFyIGVkZ2UgPSBhLmVkZ2U7CiAgICAgICAgICBpZiAoIWcuaGFzRWRnZShlZGdlLmlkKSkgewogICAgICAgICAgICBnLmFkZEVkZ2UoZWRnZS5pZCwgZWRnZS5zb3VyY2UsIGVkZ2UudGFyZ2V0LCBlZGdlLmF0dHJzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb2ludHMgPSBnLmVkZ2UoZWRnZS5pZCkucG9pbnRzOwogICAgICAgICAgcG9pbnRzW2EuaW5kZXhdID0geyB4OiBhLngsIHk6IGEueSwgdWw6IGEudWwsIHVyOiBhLnVyLCBkbDogYS5kbCwgZHI6IGEuZHIgfTsKICAgICAgICB9CiAgICAgICAgZy5kZWxOb2RlKHUpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qCiAgICogRm9yIGVhY2ggZWRnZSB0aGF0IHdhcyByZXZlcnNlZCBkdXJpbmcgdGhlIGBhY3ljbGljYCBzdGVwLCByZXZlcnNlIGl0cwogICAqIGFycmF5IG9mIHBvaW50cy4KICAgKi8KICBmdW5jdGlvbiBmaXh1cEVkZ2VQb2ludHMoZykgewogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCBzLCB0LCBhKSB7IGlmIChhLnJldmVyc2VkKSBhLnBvaW50cy5yZXZlcnNlKCk7IH0pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmluYWxHcmFwaChnLCBpc0RpcmVjdGVkKSB7CiAgICB2YXIgb3V0ID0gaXNEaXJlY3RlZCA/IG5ldyBDRGlncmFwaCgpIDogbmV3IENHcmFwaCgpOwogICAgb3V0LmdyYXBoKGcuZ3JhcGgoKSk7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7IG91dC5hZGROb2RlKHUsIHZhbHVlKTsgfSk7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsgb3V0LnBhcmVudCh1LCBnLnBhcmVudCh1KSk7IH0pOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgICBvdXQuYWRkRWRnZSh2YWx1ZS5lLCB1LCB2LCB2YWx1ZSk7CiAgICB9KTsKCiAgICAvLyBBdHRhY2ggYm91bmRpbmcgYm94IGluZm9ybWF0aW9uCiAgICB2YXIgbWF4WCA9IDAsIG1heFkgPSAwOwogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgewogICAgICBpZiAoIWcuY2hpbGRyZW4odSkubGVuZ3RoKSB7CiAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHZhbHVlLnggKyB2YWx1ZS53aWR0aCAvIDIpOwogICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCB2YWx1ZS55ICsgdmFsdWUuaGVpZ2h0IC8gMik7CiAgICAgIH0KICAgIH0pOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgICB2YXIgbWF4WFBvaW50cyA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlLnBvaW50cy5tYXAoZnVuY3Rpb24ocCkgeyByZXR1cm4gcC54OyB9KSk7CiAgICAgIHZhciBtYXhZUG9pbnRzID0gTWF0aC5tYXguYXBwbHkoTWF0aCwgdmFsdWUucG9pbnRzLm1hcChmdW5jdGlvbihwKSB7IHJldHVybiBwLnk7IH0pKTsKICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIG1heFhQb2ludHMgKyB2YWx1ZS53aWR0aCAvIDIpOwogICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgbWF4WVBvaW50cyArIHZhbHVlLmhlaWdodCAvIDIpOwogICAgfSk7CiAgICBvdXQuZ3JhcGgoKS53aWR0aCA9IG1heFg7CiAgICBvdXQuZ3JhcGgoKS5oZWlnaHQgPSBtYXhZOwoKICAgIHJldHVybiBvdXQ7CiAgfQoKICAvKgogICAqIEdpdmVuIGEgZnVuY3Rpb24sIGEgbmV3IGZ1bmN0aW9uIGlzIHJldHVybmVkIHRoYXQgaW52b2tlcyB0aGUgZ2l2ZW4KICAgKiBmdW5jdGlvbi4gVGhlIHJldHVybiB2YWx1ZSBmcm9tIHRoZSBmdW5jdGlvbiBpcyBhbHdheXMgdGhlIGBzZWxmYCBvYmplY3QuCiAgICovCiAgZnVuY3Rpb24gZGVsZWdhdGVQcm9wZXJ0eShmKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGYoKTsKICAgICAgZi5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gc2VsZjsKICAgIH07CiAgfQp9OwoKCn0seyIuL29yZGVyIjo0LCIuL3Bvc2l0aW9uIjo5LCIuL3JhbmsiOjEwLCIuL3V0aWwiOjE3LCJncmFwaGxpYiI6MjR9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKSwKICAgIGNyb3NzQ291bnQgPSByZXF1aXJlKCcuL29yZGVyL2Nyb3NzQ291bnQnKSwKICAgIGluaXRMYXllckdyYXBocyA9IHJlcXVpcmUoJy4vb3JkZXIvaW5pdExheWVyR3JhcGhzJyksCiAgICBpbml0T3JkZXIgPSByZXF1aXJlKCcuL29yZGVyL2luaXRPcmRlcicpLAogICAgc29ydExheWVyID0gcmVxdWlyZSgnLi9vcmRlci9zb3J0TGF5ZXInKTsKCm1vZHVsZS5leHBvcnRzID0gb3JkZXI7CgovLyBUaGUgbWF4aW11bSBudW1iZXIgb2Ygc3dlZXBzIHRvIHBlcmZvcm0gYmVmb3JlIGZpbmlzaGluZyB0aGUgb3JkZXIgcGhhc2UuCnZhciBERUZBVUxUX01BWF9TV0VFUFMgPSAyNDsKb3JkZXIuREVGQVVMVF9NQVhfU1dFRVBTID0gREVGQVVMVF9NQVhfU1dFRVBTOwoKLyoKICogUnVucyB0aGUgb3JkZXIgcGhhc2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGBncmFwaCwgYG1heFN3ZWVwc2AsIGFuZAogKiBgZGVidWdMZXZlbGAuIElmIGBtYXhTd2VlcHNgIGlzIG5vdCBzcGVjaWZpZWQgd2UgdXNlIGBERUZBVUxUX01BWF9TV0VFUFNgLgogKiBJZiBgZGVidWdMZXZlbGAgaXMgbm90IHNldCB3ZSBhc3N1bWUgMC4KICovCmZ1bmN0aW9uIG9yZGVyKGcsIG1heFN3ZWVwcykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgbWF4U3dlZXBzID0gREVGQVVMVF9NQVhfU1dFRVBTOwogIH0KCiAgdmFyIHJlc3RhcnRzID0gZy5ncmFwaCgpLm9yZGVyUmVzdGFydHMgfHwgMDsKCiAgdmFyIGxheWVyR3JhcGhzID0gaW5pdExheWVyR3JhcGhzKGcpOwogIC8vIFRPRE86IHJlbW92ZSB0aGlzIHdoZW4gd2UgYWRkIGJhY2sgc3VwcG9ydCBmb3Igb3JkZXJpbmcgY2x1c3RlcnMKICBsYXllckdyYXBocy5mb3JFYWNoKGZ1bmN0aW9uKGxnKSB7CiAgICBsZyA9IGxnLmZpbHRlck5vZGVzKGZ1bmN0aW9uKHUpIHsgcmV0dXJuICFnLmNoaWxkcmVuKHUpLmxlbmd0aDsgfSk7CiAgfSk7CgogIHZhciBpdGVycyA9IDAsCiAgICAgIGN1cnJlbnRCZXN0Q0MsCiAgICAgIGFsbFRpbWVCZXN0Q0MgPSBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICBhbGxUaW1lQmVzdCA9IHt9OwoKICBmdW5jdGlvbiBzYXZlQWxsVGltZUJlc3QoKSB7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7IGFsbFRpbWVCZXN0W3VdID0gdmFsdWUub3JkZXI7IH0pOwogIH0KCiAgZm9yICh2YXIgaiA9IDA7IGogPCBOdW1iZXIocmVzdGFydHMpICsgMSAmJiBhbGxUaW1lQmVzdENDICE9PSAwOyArK2opIHsKICAgIGN1cnJlbnRCZXN0Q0MgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgaW5pdE9yZGVyKGcsIHJlc3RhcnRzID4gMCk7CgogICAgdXRpbC5sb2coMiwgJ09yZGVyIHBoYXNlIHN0YXJ0IGNyb3NzIGNvdW50OiAnICsgZy5ncmFwaCgpLm9yZGVySW5pdENDKTsKCiAgICB2YXIgaSwgbGFzdEJlc3QsIGNjOwogICAgZm9yIChpID0gMCwgbGFzdEJlc3QgPSAwOyBsYXN0QmVzdCA8IDQgJiYgaSA8IG1heFN3ZWVwcyAmJiBjdXJyZW50QmVzdENDID4gMDsgKytpLCArK2xhc3RCZXN0LCArK2l0ZXJzKSB7CiAgICAgIHN3ZWVwKGcsIGxheWVyR3JhcGhzLCBpKTsKICAgICAgY2MgPSBjcm9zc0NvdW50KGcpOwogICAgICBpZiAoY2MgPCBjdXJyZW50QmVzdENDKSB7CiAgICAgICAgbGFzdEJlc3QgPSAwOwogICAgICAgIGN1cnJlbnRCZXN0Q0MgPSBjYzsKICAgICAgICBpZiAoY2MgPCBhbGxUaW1lQmVzdENDKSB7CiAgICAgICAgICBzYXZlQWxsVGltZUJlc3QoKTsKICAgICAgICAgIGFsbFRpbWVCZXN0Q0MgPSBjYzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdXRpbC5sb2coMywgJ09yZGVyIHBoYXNlIHN0YXJ0ICcgKyBqICsgJyBpdGVyICcgKyBpICsgJyBjcm9zcyBjb3VudDogJyArIGNjKTsKICAgIH0KICB9CgogIE9iamVjdC5rZXlzKGFsbFRpbWVCZXN0KS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIGlmICghZy5jaGlsZHJlbiB8fCAhZy5jaGlsZHJlbih1KS5sZW5ndGgpIHsKICAgICAgZy5ub2RlKHUpLm9yZGVyID0gYWxsVGltZUJlc3RbdV07CiAgICB9CiAgfSk7CiAgZy5ncmFwaCgpLm9yZGVyQ0MgPSBhbGxUaW1lQmVzdENDOwoKICB1dGlsLmxvZygyLCAnT3JkZXIgaXRlcmF0aW9uczogJyArIGl0ZXJzKTsKICB1dGlsLmxvZygyLCAnT3JkZXIgcGhhc2UgYmVzdCBjcm9zcyBjb3VudDogJyArIGcuZ3JhcGgoKS5vcmRlckNDKTsKfQoKZnVuY3Rpb24gcHJlZGVjZXNzb3JXZWlnaHRzKGcsIG5vZGVzKSB7CiAgdmFyIHdlaWdodHMgPSB7fTsKICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIHdlaWdodHNbdV0gPSBnLmluRWRnZXModSkubWFwKGZ1bmN0aW9uKGUpIHsKICAgICAgcmV0dXJuIGcubm9kZShnLnNvdXJjZShlKSkub3JkZXI7CiAgICB9KTsKICB9KTsKICByZXR1cm4gd2VpZ2h0czsKfQoKZnVuY3Rpb24gc3VjY2Vzc29yV2VpZ2h0cyhnLCBub2RlcykgewogIHZhciB3ZWlnaHRzID0ge307CiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICB3ZWlnaHRzW3VdID0gZy5vdXRFZGdlcyh1KS5tYXAoZnVuY3Rpb24oZSkgewogICAgICByZXR1cm4gZy5ub2RlKGcudGFyZ2V0KGUpKS5vcmRlcjsKICAgIH0pOwogIH0pOwogIHJldHVybiB3ZWlnaHRzOwp9CgpmdW5jdGlvbiBzd2VlcChnLCBsYXllckdyYXBocywgaXRlcikgewogIGlmIChpdGVyICUgMiA9PT0gMCkgewogICAgc3dlZXBEb3duKGcsIGxheWVyR3JhcGhzLCBpdGVyKTsKICB9IGVsc2UgewogICAgc3dlZXBVcChnLCBsYXllckdyYXBocywgaXRlcik7CiAgfQp9CgpmdW5jdGlvbiBzd2VlcERvd24oZywgbGF5ZXJHcmFwaHMpIHsKICB2YXIgY2c7CiAgZm9yIChpID0gMTsgaSA8IGxheWVyR3JhcGhzLmxlbmd0aDsgKytpKSB7CiAgICBjZyA9IHNvcnRMYXllcihsYXllckdyYXBoc1tpXSwgY2csIHByZWRlY2Vzc29yV2VpZ2h0cyhnLCBsYXllckdyYXBoc1tpXS5ub2RlcygpKSk7CiAgfQp9CgpmdW5jdGlvbiBzd2VlcFVwKGcsIGxheWVyR3JhcGhzKSB7CiAgdmFyIGNnOwogIGZvciAoaSA9IGxheWVyR3JhcGhzLmxlbmd0aCAtIDI7IGkgPj0gMDsgLS1pKSB7CiAgICBzb3J0TGF5ZXIobGF5ZXJHcmFwaHNbaV0sIGNnLCBzdWNjZXNzb3JXZWlnaHRzKGcsIGxheWVyR3JhcGhzW2ldLm5vZGVzKCkpKTsKICB9Cn0KCn0seyIuL29yZGVyL2Nyb3NzQ291bnQiOjUsIi4vb3JkZXIvaW5pdExheWVyR3JhcGhzIjo2LCIuL29yZGVyL2luaXRPcmRlciI6NywiLi9vcmRlci9zb3J0TGF5ZXIiOjgsIi4vdXRpbCI6MTd9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGNyb3NzQ291bnQ7CgovKgogKiBSZXR1cm5zIHRoZSBjcm9zcyBjb3VudCBmb3IgdGhlIGdpdmVuIGdyYXBoLgogKi8KZnVuY3Rpb24gY3Jvc3NDb3VudChnKSB7CiAgdmFyIGNjID0gMDsKICB2YXIgb3JkZXJpbmcgPSB1dGlsLm9yZGVyaW5nKGcpOwogIGZvciAodmFyIGkgPSAxOyBpIDwgb3JkZXJpbmcubGVuZ3RoOyArK2kpIHsKICAgIGNjICs9IHR3b0xheWVyQ3Jvc3NDb3VudChnLCBvcmRlcmluZ1tpLTFdLCBvcmRlcmluZ1tpXSk7CiAgfQogIHJldHVybiBjYzsKfQoKLyoKICogVGhpcyBmdW5jdGlvbiBzZWFyY2hlcyB0aHJvdWdoIGEgcmFua2VkIGFuZCBvcmRlcmVkIGdyYXBoIGFuZCBjb3VudHMgdGhlCiAqIG51bWJlciBvZiBlZGdlcyB0aGF0IGNyb3NzLiBUaGlzIGFsZ29yaXRobSBpcyBkZXJpdmVkIGZyb206CiAqCiAqICAgIFcuIEJhcnRoIGV0IGFsLiwgQmlsYXllciBDcm9zcyBDb3VudGluZywgSkdBQSwgOCgyKSAxNznigJMxOTQgKDIwMDQpCiAqLwpmdW5jdGlvbiB0d29MYXllckNyb3NzQ291bnQoZywgbGF5ZXIxLCBsYXllcjIpIHsKICB2YXIgaW5kaWNlcyA9IFtdOwogIGxheWVyMS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIHZhciBub2RlSW5kaWNlcyA9IFtdOwogICAgZy5vdXRFZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsgbm9kZUluZGljZXMucHVzaChnLm5vZGUoZy50YXJnZXQoZSkpLm9yZGVyKTsgfSk7CiAgICBub2RlSW5kaWNlcy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsgcmV0dXJuIHggLSB5OyB9KTsKICAgIGluZGljZXMgPSBpbmRpY2VzLmNvbmNhdChub2RlSW5kaWNlcyk7CiAgfSk7CgogIHZhciBmaXJzdEluZGV4ID0gMTsKICB3aGlsZSAoZmlyc3RJbmRleCA8IGxheWVyMi5sZW5ndGgpIGZpcnN0SW5kZXggPDw9IDE7CgogIHZhciB0cmVlU2l6ZSA9IDIgKiBmaXJzdEluZGV4IC0gMTsKICBmaXJzdEluZGV4IC09IDE7CgogIHZhciB0cmVlID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmVlU2l6ZTsgKytpKSB7IHRyZWVbaV0gPSAwOyB9CgogIHZhciBjYyA9IDA7CiAgaW5kaWNlcy5mb3JFYWNoKGZ1bmN0aW9uKGkpIHsKICAgIHZhciB0cmVlSW5kZXggPSBpICsgZmlyc3RJbmRleDsKICAgICsrdHJlZVt0cmVlSW5kZXhdOwogICAgd2hpbGUgKHRyZWVJbmRleCA+IDApIHsKICAgICAgaWYgKHRyZWVJbmRleCAlIDIpIHsKICAgICAgICBjYyArPSB0cmVlW3RyZWVJbmRleCArIDFdOwogICAgICB9CiAgICAgIHRyZWVJbmRleCA9ICh0cmVlSW5kZXggLSAxKSA+PiAxOwogICAgICArK3RyZWVbdHJlZUluZGV4XTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIGNjOwp9Cgp9LHsiLi4vdXRpbCI6MTd9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIG5vZGVzRnJvbUxpc3QgPSByZXF1aXJlKCdncmFwaGxpYicpLmZpbHRlci5ub2Rlc0Zyb21MaXN0LAogICAgLyoganNoaW50IC1XMDc5ICovCiAgICBTZXQgPSByZXF1aXJlKCdjcC1kYXRhJykuU2V0OwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0TGF5ZXJHcmFwaHM7CgovKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGEgY29tcG91bmQgbGF5ZXJlZCBncmFwaCwgZywgYW5kIHByb2R1Y2VzIGFuIGFycmF5IG9mCiAqIGxheWVyIGdyYXBocy4gRWFjaCBlbnRyeSBpbiB0aGUgYXJyYXkgcmVwcmVzZW50cyBhIHN1YmdyYXBoIG9mIG5vZGVzCiAqIHJlbGV2YW50IGZvciBwZXJmb3JtaW5nIGNyb3NzaW5nIHJlZHVjdGlvbiBvbiB0aGF0IGxheWVyLgogKi8KZnVuY3Rpb24gaW5pdExheWVyR3JhcGhzKGcpIHsKICB2YXIgcmFua3MgPSBbXTsKCiAgZnVuY3Rpb24gZGZzKHUpIHsKICAgIGlmICh1ID09PSBudWxsKSB7CiAgICAgIGcuY2hpbGRyZW4odSkuZm9yRWFjaChmdW5jdGlvbih2KSB7IGRmcyh2KTsgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdmFsdWUgPSBnLm5vZGUodSk7CiAgICB2YWx1ZS5taW5SYW5rID0gKCdyYW5rJyBpbiB2YWx1ZSkgPyB2YWx1ZS5yYW5rIDogTnVtYmVyLk1BWF9WQUxVRTsKICAgIHZhbHVlLm1heFJhbmsgPSAoJ3JhbmsnIGluIHZhbHVlKSA/IHZhbHVlLnJhbmsgOiBOdW1iZXIuTUlOX1ZBTFVFOwogICAgdmFyIHVSYW5rcyA9IG5ldyBTZXQoKTsKICAgIGcuY2hpbGRyZW4odSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBycyA9IGRmcyh2KTsKICAgICAgdVJhbmtzID0gU2V0LnVuaW9uKFt1UmFua3MsIHJzXSk7CiAgICAgIHZhbHVlLm1pblJhbmsgPSBNYXRoLm1pbih2YWx1ZS5taW5SYW5rLCBnLm5vZGUodikubWluUmFuayk7CiAgICAgIHZhbHVlLm1heFJhbmsgPSBNYXRoLm1heCh2YWx1ZS5tYXhSYW5rLCBnLm5vZGUodikubWF4UmFuayk7CiAgICB9KTsKCiAgICBpZiAoJ3JhbmsnIGluIHZhbHVlKSB1UmFua3MuYWRkKHZhbHVlLnJhbmspOwoKICAgIHVSYW5rcy5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbihyKSB7CiAgICAgIGlmICghKHIgaW4gcmFua3MpKSByYW5rc1tyXSA9IFtdOwogICAgICByYW5rc1tyXS5wdXNoKHUpOwogICAgfSk7CgogICAgcmV0dXJuIHVSYW5rczsKICB9CiAgZGZzKG51bGwpOwoKICB2YXIgbGF5ZXJHcmFwaHMgPSBbXTsKICByYW5rcy5mb3JFYWNoKGZ1bmN0aW9uKHVzLCByYW5rKSB7CiAgICBsYXllckdyYXBoc1tyYW5rXSA9IGcuZmlsdGVyTm9kZXMobm9kZXNGcm9tTGlzdCh1cykpOwogIH0pOwoKICByZXR1cm4gbGF5ZXJHcmFwaHM7Cn0KCn0seyJjcC1kYXRhIjoxOSwiZ3JhcGhsaWIiOjI0fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBjcm9zc0NvdW50ID0gcmVxdWlyZSgnLi9jcm9zc0NvdW50JyksCiAgICB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0T3JkZXI7CgovKgogKiBHaXZlbiBhIGdyYXBoIHdpdGggYSBzZXQgb2YgbGF5ZXJlZCBub2RlcyAoaS5lLiBub2RlcyB0aGF0IGhhdmUgYSBgcmFua2AKICogYXR0cmlidXRlKSB0aGlzIGZ1bmN0aW9uIGF0dGFjaGVzIGFuIGBvcmRlcmAgYXR0cmlidXRlIHRoYXQgdW5pcXVlbHkKICogYXJyYW5nZXMgZWFjaCBub2RlIG9mIGVhY2ggcmFuay4gSWYgbm8gY29uc3RyYWludCBncmFwaCBpcyBwcm92aWRlZCB0aGUKICogb3JkZXIgb2YgdGhlIG5vZGVzIGluIGVhY2ggcmFuayBpcyBlbnRpcmVseSBhcmJpdHJhcnkuCiAqLwpmdW5jdGlvbiBpbml0T3JkZXIoZywgcmFuZG9tKSB7CiAgdmFyIGxheWVycyA9IFtdOwoKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB2YXIgbGF5ZXIgPSBsYXllcnNbdmFsdWUucmFua107CiAgICBpZiAoZy5jaGlsZHJlbiAmJiBnLmNoaWxkcmVuKHUpLmxlbmd0aCA+IDApIHJldHVybjsKICAgIGlmICghbGF5ZXIpIHsKICAgICAgbGF5ZXIgPSBsYXllcnNbdmFsdWUucmFua10gPSBbXTsKICAgIH0KICAgIGxheWVyLnB1c2godSk7CiAgfSk7CgogIGxheWVycy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICBpZiAocmFuZG9tKSB7CiAgICAgIHV0aWwuc2h1ZmZsZShsYXllcik7CiAgICB9CiAgICBsYXllci5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgICAgZy5ub2RlKHUpLm9yZGVyID0gaTsKICAgIH0pOwogIH0pOwoKICB2YXIgY2MgPSBjcm9zc0NvdW50KGcpOwogIGcuZ3JhcGgoKS5vcmRlckluaXRDQyA9IGNjOwogIGcuZ3JhcGgoKS5vcmRlckNDID0gTnVtYmVyLk1BWF9WQUxVRTsKfQoKfSx7Ii4uL3V0aWwiOjE3LCIuL2Nyb3NzQ291bnQiOjV9XSw4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Ci8qCiAgICBEaWdyYXBoID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5EaWdyYXBoLAogICAgdG9wc29ydCA9IHJlcXVpcmUoJ2dyYXBobGliJykuYWxnLnRvcHNvcnQsCiAgICBub2Rlc0Zyb21MaXN0ID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5maWx0ZXIubm9kZXNGcm9tTGlzdDsKKi8KCm1vZHVsZS5leHBvcnRzID0gc29ydExheWVyOwoKLyoKZnVuY3Rpb24gc29ydExheWVyKGcsIGNnLCB3ZWlnaHRzKSB7CiAgdmFyIHJlc3VsdCA9IHNvcnRMYXllclN1YmdyYXBoKGcsIG51bGwsIGNnLCB3ZWlnaHRzKTsKICByZXN1bHQubGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgIGcubm9kZSh1KS5vcmRlciA9IGk7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdC5jb25zdHJhaW50R3JhcGg7Cn0KKi8KCmZ1bmN0aW9uIHNvcnRMYXllcihnLCBjZywgd2VpZ2h0cykgewogIHZhciBvcmRlcmluZyA9IFtdOwogIHZhciBicyA9IHt9OwogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIG9yZGVyaW5nW3ZhbHVlLm9yZGVyXSA9IHU7CiAgICB2YXIgd3MgPSB3ZWlnaHRzW3VdOwogICAgaWYgKHdzLmxlbmd0aCkgewogICAgICBic1t1XSA9IHV0aWwuc3VtKHdzKSAvIHdzLmxlbmd0aDsKICAgIH0KICB9KTsKCiAgdmFyIHRvU29ydCA9IGcubm9kZXMoKS5maWx0ZXIoZnVuY3Rpb24odSkgeyByZXR1cm4gYnNbdV0gIT09IHVuZGVmaW5lZDsgfSk7CiAgdG9Tb3J0LnNvcnQoZnVuY3Rpb24oeCwgeSkgewogICAgcmV0dXJuIGJzW3hdIC0gYnNbeV0gfHwgZy5ub2RlKHgpLm9yZGVyIC0gZy5ub2RlKHkpLm9yZGVyOwogIH0pOwoKICBmb3IgKHZhciBpID0gMCwgaiA9IDAsIGpsID0gdG9Tb3J0Lmxlbmd0aDsgaiA8IGpsOyArK2kpIHsKICAgIGlmIChic1tvcmRlcmluZ1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICBnLm5vZGUodG9Tb3J0W2orK10pLm9yZGVyID0gaTsKICAgIH0KICB9Cn0KCi8vIFRPT0Q6IHJlLWVuYWJsZSBjb25zdHJhaW5lZCBzb3J0aW5nIG9uY2Ugd2UgaGF2ZSBhIHN0cmF0ZWd5IGZvciBoYW5kbGluZwovLyB1bmRlZmluZWQgYmFyeWNlbnRlcnMuCi8qCmZ1bmN0aW9uIHNvcnRMYXllclN1YmdyYXBoKGcsIHNnLCBjZywgd2VpZ2h0cykgewogIGNnID0gY2cgPyBjZy5maWx0ZXJOb2Rlcyhub2Rlc0Zyb21MaXN0KGcuY2hpbGRyZW4oc2cpKSkgOiBuZXcgRGlncmFwaCgpOwoKICB2YXIgbm9kZURhdGEgPSB7fTsKICBnLmNoaWxkcmVuKHNnKS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIGlmIChnLmNoaWxkcmVuKHUpLmxlbmd0aCkgewogICAgICBub2RlRGF0YVt1XSA9IHNvcnRMYXllclN1YmdyYXBoKGcsIHUsIGNnLCB3ZWlnaHRzKTsKICAgICAgbm9kZURhdGFbdV0uZmlyc3RTRyA9IHU7CiAgICAgIG5vZGVEYXRhW3VdLmxhc3RTRyA9IHU7CiAgICB9IGVsc2UgewogICAgICB2YXIgd3MgPSB3ZWlnaHRzW3VdOwogICAgICBub2RlRGF0YVt1XSA9IHsKICAgICAgICBkZWdyZWU6IHdzLmxlbmd0aCwKICAgICAgICBiYXJ5Y2VudGVyOiB3cy5sZW5ndGggPiAwID8gdXRpbC5zdW0od3MpIC8gd3MubGVuZ3RoIDogMCwKICAgICAgICBsaXN0OiBbdV0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgcmVzb2x2ZVZpb2xhdGVkQ29uc3RyYWludHMoZywgY2csIG5vZGVEYXRhKTsKCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhub2RlRGF0YSk7CiAga2V5cy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsKICAgIHJldHVybiBub2RlRGF0YVt4XS5iYXJ5Y2VudGVyIC0gbm9kZURhdGFbeV0uYmFyeWNlbnRlcjsKICB9KTsKCiAgdmFyIHJlc3VsdCA9ICBrZXlzLm1hcChmdW5jdGlvbih1KSB7IHJldHVybiBub2RlRGF0YVt1XTsgfSkKICAgICAgICAgICAgICAgICAgICAucmVkdWNlKGZ1bmN0aW9uKGxocywgcmhzKSB7IHJldHVybiBtZXJnZU5vZGVEYXRhKGcsIGxocywgcmhzKTsgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoKZnVuY3Rpb24gbWVyZ2VOb2RlRGF0YShnLCBsaHMsIHJocykgewogIHZhciBjZyA9IG1lcmdlRGlncmFwaHMobGhzLmNvbnN0cmFpbnRHcmFwaCwgcmhzLmNvbnN0cmFpbnRHcmFwaCk7CgogIGlmIChsaHMubGFzdFNHICE9PSB1bmRlZmluZWQgJiYgcmhzLmZpcnN0U0cgIT09IHVuZGVmaW5lZCkgewogICAgaWYgKGNnID09PSB1bmRlZmluZWQpIHsKICAgICAgY2cgPSBuZXcgRGlncmFwaCgpOwogICAgfQogICAgaWYgKCFjZy5oYXNOb2RlKGxocy5sYXN0U0cpKSB7IGNnLmFkZE5vZGUobGhzLmxhc3RTRyk7IH0KICAgIGNnLmFkZE5vZGUocmhzLmZpcnN0U0cpOwogICAgY2cuYWRkRWRnZShudWxsLCBsaHMubGFzdFNHLCByaHMuZmlyc3RTRyk7CiAgfQoKICByZXR1cm4gewogICAgZGVncmVlOiBsaHMuZGVncmVlICsgcmhzLmRlZ3JlZSwKICAgIGJhcnljZW50ZXI6IChsaHMuYmFyeWNlbnRlciAqIGxocy5kZWdyZWUgKyByaHMuYmFyeWNlbnRlciAqIHJocy5kZWdyZWUpIC8KICAgICAgICAgICAgICAgIChsaHMuZGVncmVlICsgcmhzLmRlZ3JlZSksCiAgICBsaXN0OiBsaHMubGlzdC5jb25jYXQocmhzLmxpc3QpLAogICAgZmlyc3RTRzogbGhzLmZpcnN0U0cgIT09IHVuZGVmaW5lZCA/IGxocy5maXJzdFNHIDogcmhzLmZpcnN0U0csCiAgICBsYXN0U0c6IHJocy5sYXN0U0cgIT09IHVuZGVmaW5lZCA/IHJocy5sYXN0U0cgOiBsaHMubGFzdFNHLAogICAgY29uc3RyYWludEdyYXBoOiBjZwogIH07Cn0KCmZ1bmN0aW9uIG1lcmdlRGlncmFwaHMobGhzLCByaHMpIHsKICBpZiAobGhzID09PSB1bmRlZmluZWQpIHJldHVybiByaHM7CiAgaWYgKHJocyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbGhzOwoKICBsaHMgPSBsaHMuY29weSgpOwogIHJocy5ub2RlcygpLmZvckVhY2goZnVuY3Rpb24odSkgeyBsaHMuYWRkTm9kZSh1KTsgfSk7CiAgcmhzLmVkZ2VzKCkuZm9yRWFjaChmdW5jdGlvbihlLCB1LCB2KSB7IGxocy5hZGRFZGdlKG51bGwsIHUsIHYpOyB9KTsKICByZXR1cm4gbGhzOwp9CgpmdW5jdGlvbiByZXNvbHZlVmlvbGF0ZWRDb25zdHJhaW50cyhnLCBjZywgbm9kZURhdGEpIHsKICAvLyBSZW1vdmVzIG5vZGVzIGB1YCBhbmQgYHZgIGZyb20gYGNnYCBhbmQgbWFrZXMgYW55IGVkZ2VzIGluY2lkZW50IG9uIHRoZW0KICAvLyBpbmNpZGVudCBvbiBgd2AgaW5zdGVhZC4KICBmdW5jdGlvbiBjb2xsYXBzZU5vZGVzKHUsIHYsIHcpIHsKICAgIC8vIFRPRE8gb3JpZ2luYWwgcGFwZXIgcmVtb3ZlcyBzZWxmIGxvb3BzLCBidXQgaXQgaXMgbm90IG9idmlvdXMgd2hlbiB0aGlzIHdvdWxkIGhhcHBlbgogICAgY2cuaW5FZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgY2cuZGVsRWRnZShlKTsKICAgICAgY2cuYWRkRWRnZShudWxsLCBjZy5zb3VyY2UoZSksIHcpOwogICAgfSk7CgogICAgY2cub3V0RWRnZXModikuZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGNnLmRlbEVkZ2UoZSk7CiAgICAgIGNnLmFkZEVkZ2UobnVsbCwgdywgY2cudGFyZ2V0KGUpKTsKICAgIH0pOwoKICAgIGNnLmRlbE5vZGUodSk7CiAgICBjZy5kZWxOb2RlKHYpOwogIH0KCiAgdmFyIHZpb2xhdGVkOwogIHdoaWxlICgodmlvbGF0ZWQgPSBmaW5kVmlvbGF0ZWRDb25zdHJhaW50KGNnLCBub2RlRGF0YSkpICE9PSB1bmRlZmluZWQpIHsKICAgIHZhciBzb3VyY2UgPSBjZy5zb3VyY2UodmlvbGF0ZWQpLAogICAgICAgIHRhcmdldCA9IGNnLnRhcmdldCh2aW9sYXRlZCk7CgogICAgdmFyIHY7CiAgICB3aGlsZSAoKHYgPSBjZy5hZGROb2RlKG51bGwpKSAmJiBnLmhhc05vZGUodikpIHsKICAgICAgY2cuZGVsTm9kZSh2KTsKICAgIH0KCiAgICAvLyBDb2xsYXBzZSBiYXJ5Y2VudGVyIGFuZCBsaXN0CiAgICBub2RlRGF0YVt2XSA9IG1lcmdlTm9kZURhdGEoZywgbm9kZURhdGFbc291cmNlXSwgbm9kZURhdGFbdGFyZ2V0XSk7CiAgICBkZWxldGUgbm9kZURhdGFbc291cmNlXTsKICAgIGRlbGV0ZSBub2RlRGF0YVt0YXJnZXRdOwoKICAgIGNvbGxhcHNlTm9kZXMoc291cmNlLCB0YXJnZXQsIHYpOwogICAgaWYgKGNnLmluY2lkZW50RWRnZXModikubGVuZ3RoID09PSAwKSB7IGNnLmRlbE5vZGUodik7IH0KICB9Cn0KCmZ1bmN0aW9uIGZpbmRWaW9sYXRlZENvbnN0cmFpbnQoY2csIG5vZGVEYXRhKSB7CiAgdmFyIHVzID0gdG9wc29ydChjZyk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cy5sZW5ndGg7ICsraSkgewogICAgdmFyIHUgPSB1c1tpXTsKICAgIHZhciBpbkVkZ2VzID0gY2cuaW5FZGdlcyh1KTsKICAgIGZvciAodmFyIGogPSAwOyBqIDwgaW5FZGdlcy5sZW5ndGg7ICsraikgewogICAgICB2YXIgZSA9IGluRWRnZXNbal07CiAgICAgIGlmIChub2RlRGF0YVtjZy5zb3VyY2UoZSldLmJhcnljZW50ZXIgPj0gbm9kZURhdGFbdV0uYmFyeWNlbnRlcikgewogICAgICAgIHJldHVybiBlOwogICAgICB9CiAgICB9CiAgfQp9CiovCgp9LHsiLi4vdXRpbCI6MTd9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKCi8qCiAqIFRoZSBhbGdvcml0aG1zIGhlcmUgYXJlIGJhc2VkIG9uIEJyYW5kZXMgYW5kIEvDtnBmLCAiRmFzdCBhbmQgU2ltcGxlCiAqIEhvcml6b250YWwgQ29vcmRpbmF0ZSBBc3NpZ25tZW50Ii4KICovCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CiAgLy8gRXh0ZXJuYWwgY29uZmlndXJhdGlvbgogIHZhciBjb25maWcgPSB7CiAgICBub2RlU2VwOiA1MCwKICAgIGVkZ2VTZXA6IDEwLAogICAgdW5pdmVyc2FsU2VwOiBudWxsLAogICAgcmFua1NlcDogMzAKICB9OwoKICB2YXIgc2VsZiA9IHt9OwoKICBzZWxmLm5vZGVTZXAgPSB1dGlsLnByb3BlcnR5QWNjZXNzb3Ioc2VsZiwgY29uZmlnLCAnbm9kZVNlcCcpOwogIHNlbGYuZWRnZVNlcCA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdlZGdlU2VwJyk7CiAgLy8gSWYgbm90IG51bGwgdGhpcyBzZXBhcmF0aW9uIHZhbHVlIGlzIHVzZWQgZm9yIGFsbCBub2RlcyBhbmQgZWRnZXMKICAvLyByZWdhcmRsZXNzIG9mIHRoZWlyIHdpZHRocy4gYG5vZGVTZXBgIGFuZCBgZWRnZVNlcGAgYXJlIGlnbm9yZWQgd2l0aCB0aGlzCiAgLy8gb3B0aW9uLgogIHNlbGYudW5pdmVyc2FsU2VwID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ3VuaXZlcnNhbFNlcCcpOwogIHNlbGYucmFua1NlcCA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdyYW5rU2VwJyk7CiAgc2VsZi5kZWJ1Z0xldmVsID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ2RlYnVnTGV2ZWwnKTsKCiAgc2VsZi5ydW4gPSBydW47CgogIHJldHVybiBzZWxmOwoKICBmdW5jdGlvbiBydW4oZykgewogICAgZyA9IGcuZmlsdGVyTm9kZXModXRpbC5maWx0ZXJOb25TdWJncmFwaHMoZykpOwoKICAgIHZhciBsYXllcmluZyA9IHV0aWwub3JkZXJpbmcoZyk7CgogICAgdmFyIGNvbmZsaWN0cyA9IGZpbmRDb25mbGljdHMoZywgbGF5ZXJpbmcpOwoKICAgIHZhciB4c3MgPSB7fTsKICAgIFsndScsICdkJ10uZm9yRWFjaChmdW5jdGlvbih2ZXJ0RGlyKSB7CiAgICAgIGlmICh2ZXJ0RGlyID09PSAnZCcpIGxheWVyaW5nLnJldmVyc2UoKTsKCiAgICAgIFsnbCcsICdyJ10uZm9yRWFjaChmdW5jdGlvbihob3JpekRpcikgewogICAgICAgIGlmIChob3JpekRpciA9PT0gJ3InKSByZXZlcnNlSW5uZXJPcmRlcihsYXllcmluZyk7CgogICAgICAgIHZhciBkaXIgPSB2ZXJ0RGlyICsgaG9yaXpEaXI7CiAgICAgICAgdmFyIGFsaWduID0gdmVydGljYWxBbGlnbm1lbnQoZywgbGF5ZXJpbmcsIGNvbmZsaWN0cywgdmVydERpciA9PT0gJ3UnID8gJ3ByZWRlY2Vzc29ycycgOiAnc3VjY2Vzc29ycycpOwogICAgICAgIHhzc1tkaXJdPSBob3Jpem9udGFsQ29tcGFjdGlvbihnLCBsYXllcmluZywgYWxpZ24ucG9zLCBhbGlnbi5yb290LCBhbGlnbi5hbGlnbik7CgogICAgICAgIGlmIChjb25maWcuZGVidWdMZXZlbCA+PSAzKQogICAgICAgICAgZGVidWdQb3NpdGlvbmluZyh2ZXJ0RGlyICsgaG9yaXpEaXIsIGcsIGxheWVyaW5nLCB4c3NbZGlyXSk7CgogICAgICAgIGlmIChob3JpekRpciA9PT0gJ3InKSBmbGlwSG9yaXpvbnRhbGx5KHhzc1tkaXJdKTsKCiAgICAgICAgaWYgKGhvcml6RGlyID09PSAncicpIHJldmVyc2VJbm5lck9yZGVyKGxheWVyaW5nKTsKICAgICAgfSk7CgogICAgICBpZiAodmVydERpciA9PT0gJ2QnKSBsYXllcmluZy5yZXZlcnNlKCk7CiAgICB9KTsKCiAgICBiYWxhbmNlKGcsIGxheWVyaW5nLCB4c3MpOwoKICAgIGcuZWFjaE5vZGUoZnVuY3Rpb24odikgewogICAgICB2YXIgeHMgPSBbXTsKICAgICAgZm9yICh2YXIgYWxpZ25tZW50IGluIHhzcykgewogICAgICAgIHZhciBhbGlnbm1lbnRYID0geHNzW2FsaWdubWVudF1bdl07CiAgICAgICAgcG9zWERlYnVnKGFsaWdubWVudCwgZywgdiwgYWxpZ25tZW50WCk7CiAgICAgICAgeHMucHVzaChhbGlnbm1lbnRYKTsKICAgICAgfQogICAgICB4cy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsgcmV0dXJuIHggLSB5OyB9KTsKICAgICAgcG9zWChnLCB2LCAoeHNbMV0gKyB4c1syXSkgLyAyKTsKICAgIH0pOwoKICAgIC8vIEFsaWduIHkgY29vcmRpbmF0ZXMgd2l0aCByYW5rcwogICAgdmFyIHkgPSAwLCByZXZlcnNlWSA9IGcuZ3JhcGgoKS5yYW5rRGlyID09PSAnQlQnIHx8IGcuZ3JhcGgoKS5yYW5rRGlyID09PSAnUkwnOwogICAgbGF5ZXJpbmcuZm9yRWFjaChmdW5jdGlvbihsYXllcikgewogICAgICB2YXIgbWF4SGVpZ2h0ID0gdXRpbC5tYXgobGF5ZXIubWFwKGZ1bmN0aW9uKHUpIHsgcmV0dXJuIGhlaWdodChnLCB1KTsgfSkpOwogICAgICB5ICs9IG1heEhlaWdodCAvIDI7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAgIHBvc1koZywgdSwgcmV2ZXJzZVkgPyAteSA6IHkpOwogICAgICB9KTsKICAgICAgeSArPSBtYXhIZWlnaHQgLyAyICsgY29uZmlnLnJhbmtTZXA7CiAgICB9KTsKCiAgICAvLyBUcmFuc2xhdGUgbGF5b3V0IHNvIHRoYXQgdG9wIGxlZnQgY29ybmVyIG9mIGJvdW5kaW5nIHJlY3RhbmdsZSBoYXMKICAgIC8vIGNvb3JkaW5hdGUgKDAsIDApLgogICAgdmFyIG1pblggPSB1dGlsLm1pbihnLm5vZGVzKCkubWFwKGZ1bmN0aW9uKHUpIHsgcmV0dXJuIHBvc1goZywgdSkgLSB3aWR0aChnLCB1KSAvIDI7IH0pKTsKICAgIHZhciBtaW5ZID0gdXRpbC5taW4oZy5ub2RlcygpLm1hcChmdW5jdGlvbih1KSB7IHJldHVybiBwb3NZKGcsIHUpIC0gaGVpZ2h0KGcsIHUpIC8gMjsgfSkpOwogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1KSB7CiAgICAgIHBvc1goZywgdSwgcG9zWChnLCB1KSAtIG1pblgpOwogICAgICBwb3NZKGcsIHUsIHBvc1koZywgdSkgLSBtaW5ZKTsKICAgIH0pOwogIH0KCiAgLyoKICAgKiBHZW5lcmF0ZSBhbiBJRCB0aGF0IGNhbiBiZSB1c2VkIHRvIHJlcHJlc2VudCBhbnkgdW5kaXJlY3RlZCBlZGdlIHRoYXQgaXMKICAgKiBpbmNpZGVudCBvbiBgdWAgYW5kIGB2YC4KICAgKi8KICBmdW5jdGlvbiB1bmRpckVkZ2VJZCh1LCB2KSB7CiAgICByZXR1cm4gdSA8IHYKICAgICAgPyB1LnRvU3RyaW5nKCkubGVuZ3RoICsgJzonICsgdSArICctJyArIHYKICAgICAgOiB2LnRvU3RyaW5nKCkubGVuZ3RoICsgJzonICsgdiArICctJyArIHU7CiAgfQoKICBmdW5jdGlvbiBmaW5kQ29uZmxpY3RzKGcsIGxheWVyaW5nKSB7CiAgICB2YXIgY29uZmxpY3RzID0ge30sIC8vIFNldCBvZiBjb25mbGljdGluZyBlZGdlIGlkcwogICAgICAgIHBvcyA9IHt9LCAgICAgICAvLyBQb3NpdGlvbiBvZiBub2RlIGluIGl0cyBsYXllcgogICAgICAgIHByZXZMYXllciwKICAgICAgICBjdXJyTGF5ZXIsCiAgICAgICAgazAsICAgICAvLyBQb3NpdGlvbiBvZiB0aGUgbGFzdCBpbm5lciBzZWdtZW50IGluIHRoZSBwcmV2aW91cyBsYXllcgogICAgICAgIGwsICAgICAgLy8gQ3VycmVudCBwb3NpdGlvbiBpbiB0aGUgY3VycmVudCBsYXllciAoZm9yIGl0ZXJhdGlvbiB1cCB0byBgbDFgKQogICAgICAgIGsxOyAgICAgLy8gUG9zaXRpb24gb2YgdGhlIG5leHQgaW5uZXIgc2VnbWVudCBpbiB0aGUgcHJldmlvdXMgbGF5ZXIgb3IKICAgICAgICAgICAgICAgIC8vIHRoZSBwb3NpdGlvbiBvZiB0aGUgbGFzdCBlbGVtZW50IGluIHRoZSBwcmV2aW91cyBsYXllcgoKICAgIGlmIChsYXllcmluZy5sZW5ndGggPD0gMikgcmV0dXJuIGNvbmZsaWN0czsKCiAgICBmdW5jdGlvbiB1cGRhdGVDb25mbGljdHModikgewogICAgICB2YXIgayA9IHBvc1t2XTsKICAgICAgaWYgKGsgPCBrMCB8fCBrID4gazEpIHsKICAgICAgICBjb25mbGljdHNbdW5kaXJFZGdlSWQoY3VyckxheWVyW2xdLCB2KV0gPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgbGF5ZXJpbmdbMV0uZm9yRWFjaChmdW5jdGlvbih1LCBpKSB7IHBvc1t1XSA9IGk7IH0pOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBsYXllcmluZy5sZW5ndGggLSAxOyArK2kpIHsKICAgICAgcHJldkxheWVyID0gbGF5ZXJpbmdbaV07CiAgICAgIGN1cnJMYXllciA9IGxheWVyaW5nW2krMV07CiAgICAgIGswID0gMDsKICAgICAgbCA9IDA7CgogICAgICAvLyBTY2FuIGN1cnJlbnQgbGF5ZXIgZm9yIG5leHQgbm9kZSB0aGF0IGlzIGluY2lkZW50IHRvIGFuIGlubmVyIHNlZ2VtZW50CiAgICAgIC8vIGJldHdlZW4gbGF5ZXJpbmdbaSsxXSBhbmQgbGF5ZXJpbmdbaV0uCiAgICAgIGZvciAodmFyIGwxID0gMDsgbDEgPCBjdXJyTGF5ZXIubGVuZ3RoOyArK2wxKSB7CiAgICAgICAgdmFyIHUgPSBjdXJyTGF5ZXJbbDFdOyAvLyBOZXh0IGlubmVyIHNlZ21lbnQgaW4gdGhlIGN1cnJlbnQgbGF5ZXIgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxhc3Qgbm9kZSBpbiB0aGUgY3VycmVudCBsYXllcgogICAgICAgIHBvc1t1XSA9IGwxOwogICAgICAgIGsxID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAoZy5ub2RlKHUpLmR1bW15KSB7CiAgICAgICAgICB2YXIgdVByZWQgPSBnLnByZWRlY2Vzc29ycyh1KVswXTsKICAgICAgICAgIC8vIE5vdGU6IEluIHRoZSBjYXNlIG9mIHNlbGYgbG9vcHMgYW5kIHNpZGV3YXlzIGVkZ2VzIGl0IGlzIHBvc3NpYmxlCiAgICAgICAgICAvLyBmb3IgYSBkdW1teSBub3QgdG8gaGF2ZSBhIHByZWRlY2Vzc29yLgogICAgICAgICAgaWYgKHVQcmVkICE9PSB1bmRlZmluZWQgJiYgZy5ub2RlKHVQcmVkKS5kdW1teSkKICAgICAgICAgICAgazEgPSBwb3NbdVByZWRdOwogICAgICAgIH0KICAgICAgICBpZiAoazEgPT09IHVuZGVmaW5lZCAmJiBsMSA9PT0gY3VyckxheWVyLmxlbmd0aCAtIDEpCiAgICAgICAgICBrMSA9IHByZXZMYXllci5sZW5ndGggLSAxOwoKICAgICAgICBpZiAoazEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZm9yICg7IGwgPD0gbDE7ICsrbCkgewogICAgICAgICAgICBnLnByZWRlY2Vzc29ycyhjdXJyTGF5ZXJbbF0pLmZvckVhY2godXBkYXRlQ29uZmxpY3RzKTsKICAgICAgICAgIH0KICAgICAgICAgIGswID0gazE7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbmZsaWN0czsKICB9CgogIGZ1bmN0aW9uIHZlcnRpY2FsQWxpZ25tZW50KGcsIGxheWVyaW5nLCBjb25mbGljdHMsIHJlbGF0aW9uc2hpcCkgewogICAgdmFyIHBvcyA9IHt9LCAgIC8vIFBvc2l0aW9uIGZvciBhIG5vZGUgaW4gaXRzIGxheWVyCiAgICAgICAgcm9vdCA9IHt9LCAgLy8gUm9vdCBvZiB0aGUgYmxvY2sgdGhhdCB0aGUgbm9kZSBwYXJ0aWNpcGF0ZXMgaW4KICAgICAgICBhbGlnbiA9IHt9OyAvLyBQb2ludHMgdG8gdGhlIG5leHQgbm9kZSBpbiB0aGUgYmxvY2sgb3IsIGlmIHRoZSBsYXN0CiAgICAgICAgICAgICAgICAgICAgLy8gZWxlbWVudCBpbiB0aGUgYmxvY2ssIHBvaW50cyB0byB0aGUgZmlyc3QgYmxvY2sncyByb290CgogICAgbGF5ZXJpbmcuZm9yRWFjaChmdW5jdGlvbihsYXllcikgewogICAgICBsYXllci5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgICAgICByb290W3VdID0gdTsKICAgICAgICBhbGlnblt1XSA9IHU7CiAgICAgICAgcG9zW3VdID0gaTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIHZhciBwcmV2SWR4ID0gLTE7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHZhciByZWxhdGVkID0gZ1tyZWxhdGlvbnNoaXBdKHYpLCAvLyBBZGphY2VudCBub2RlcyBmcm9tIHRoZSBwcmV2aW91cyBsYXllcgogICAgICAgICAgICBtaWQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbWlkIHBvaW50IGluIHRoZSByZWxhdGVkIGFycmF5CgogICAgICAgIGlmIChyZWxhdGVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlbGF0ZWQuc29ydChmdW5jdGlvbih4LCB5KSB7IHJldHVybiBwb3NbeF0gLSBwb3NbeV07IH0pOwogICAgICAgICAgbWlkID0gKHJlbGF0ZWQubGVuZ3RoIC0gMSkgLyAyOwogICAgICAgICAgcmVsYXRlZC5zbGljZShNYXRoLmZsb29yKG1pZCksIE1hdGguY2VpbChtaWQpICsgMSkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgICAgICAgIGlmIChhbGlnblt2XSA9PT0gdikgewogICAgICAgICAgICAgIGlmICghY29uZmxpY3RzW3VuZGlyRWRnZUlkKHUsIHYpXSAmJiBwcmV2SWR4IDwgcG9zW3VdKSB7CiAgICAgICAgICAgICAgICBhbGlnblt1XSA9IHY7CiAgICAgICAgICAgICAgICBhbGlnblt2XSA9IHJvb3Rbdl0gPSByb290W3VdOwogICAgICAgICAgICAgICAgcHJldklkeCA9IHBvc1t1XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4geyBwb3M6IHBvcywgcm9vdDogcm9vdCwgYWxpZ246IGFsaWduIH07CiAgfQoKICAvLyBUaGlzIGZ1bmN0aW9uIGRldmlhdGVzIGZyb20gdGhlIHN0YW5kYXJkIEJLIGFsZ29yaXRobSBpbiB0d28gd2F5cy4gRmlyc3QKICAvLyBpdCB0YWtlcyBpbnRvIGFjY291bnQgdGhlIHNpemUgb2YgdGhlIG5vZGVzLiBTZWNvbmQgaXQgaW5jbHVkZXMgYSBmaXggdG8KICAvLyB0aGUgb3JpZ2luYWwgYWxnb3JpdGhtIHRoYXQgaXMgZGVzY3JpYmVkIGluIENhcnN0ZW5zLCAiTm9kZSBhbmQgTGFiZWwKICAvLyBQbGFjZW1lbnQgaW4gYSBMYXllcmVkIExheW91dCBBbGdvcml0aG0iLgogIGZ1bmN0aW9uIGhvcml6b250YWxDb21wYWN0aW9uKGcsIGxheWVyaW5nLCBwb3MsIHJvb3QsIGFsaWduKSB7CiAgICB2YXIgc2luayA9IHt9LCAgICAgICAvLyBNYXBwaW5nIG9mIG5vZGUgaWQgLT4gc2luayBub2RlIGlkIGZvciBjbGFzcwogICAgICAgIG1heWJlU2hpZnQgPSB7fSwgLy8gTWFwcGluZyBvZiBzaW5rIG5vZGUgaWQgLT4geyBjbGFzcyBub2RlIGlkLCBtaW4gc2hpZnQgfQogICAgICAgIHNoaWZ0ID0ge30sICAgICAgLy8gTWFwcGluZyBvZiBzaW5rIG5vZGUgaWQgLT4gc2hpZnQKICAgICAgICBwcmVkID0ge30sICAgICAgIC8vIE1hcHBpbmcgb2Ygbm9kZSBpZCAtPiBwcmVkZWNlc3NvciBub2RlIChvciBudWxsKQogICAgICAgIHhzID0ge307ICAgICAgICAgLy8gQ2FsY3VsYXRlZCBYIHBvc2l0aW9ucwoKICAgIGxheWVyaW5nLmZvckVhY2goZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgbGF5ZXIuZm9yRWFjaChmdW5jdGlvbih1LCBpKSB7CiAgICAgICAgc2lua1t1XSA9IHU7CiAgICAgICAgbWF5YmVTaGlmdFt1XSA9IHt9OwogICAgICAgIGlmIChpID4gMCkKICAgICAgICAgIHByZWRbdV0gPSBsYXllcltpIC0gMV07CiAgICAgIH0pOwogICAgfSk7CgogICAgZnVuY3Rpb24gdXBkYXRlU2hpZnQodG9TaGlmdCwgbmVpZ2hib3IsIGRlbHRhKSB7CiAgICAgIGlmICghKG5laWdoYm9yIGluIG1heWJlU2hpZnRbdG9TaGlmdF0pKSB7CiAgICAgICAgbWF5YmVTaGlmdFt0b1NoaWZ0XVtuZWlnaGJvcl0gPSBkZWx0YTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXliZVNoaWZ0W3RvU2hpZnRdW25laWdoYm9yXSA9IE1hdGgubWluKG1heWJlU2hpZnRbdG9TaGlmdF1bbmVpZ2hib3JdLCBkZWx0YSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwbGFjZUJsb2NrKHYpIHsKICAgICAgaWYgKCEodiBpbiB4cykpIHsKICAgICAgICB4c1t2XSA9IDA7CiAgICAgICAgdmFyIHcgPSB2OwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwb3Nbd10gPiAwKSB7CiAgICAgICAgICAgIHZhciB1ID0gcm9vdFtwcmVkW3ddXTsKICAgICAgICAgICAgcGxhY2VCbG9jayh1KTsKICAgICAgICAgICAgaWYgKHNpbmtbdl0gPT09IHYpIHsKICAgICAgICAgICAgICBzaW5rW3ZdID0gc2lua1t1XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsdGEgPSBzZXAoZywgcHJlZFt3XSkgKyBzZXAoZywgdyk7CiAgICAgICAgICAgIGlmIChzaW5rW3ZdICE9PSBzaW5rW3VdKSB7CiAgICAgICAgICAgICAgdXBkYXRlU2hpZnQoc2lua1t1XSwgc2lua1t2XSwgeHNbdl0gLSB4c1t1XSAtIGRlbHRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4c1t2XSA9IE1hdGgubWF4KHhzW3ZdLCB4c1t1XSArIGRlbHRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdyA9IGFsaWduW3ddOwogICAgICAgIH0gd2hpbGUgKHcgIT09IHYpOwogICAgICB9CiAgICB9CgogICAgLy8gUm9vdCBjb29yZGluYXRlcyByZWxhdGl2ZSB0byBzaW5rCiAgICB1dGlsLnZhbHVlcyhyb290KS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgcGxhY2VCbG9jayh2KTsKICAgIH0pOwoKICAgIC8vIEFic29sdXRlIGNvb3JkaW5hdGVzCiAgICAvLyBUaGVyZSBpcyBhbiBhc3N1bXB0aW9uIGhlcmUgdGhhdCB3ZSd2ZSByZXNvbHZlZCBzaGlmdHMgZm9yIGFueSBjbGFzc2VzCiAgICAvLyB0aGF0IGJlZ2luIGF0IGFuIGVhcmxpZXIgbGF5ZXIuIFdlIGd1YXJhbnRlZSB0aGlzIGJ5IHZpc2l0aW5nIGxheWVycyBpbgogICAgLy8gb3JkZXIuCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHhzW3ZdID0geHNbcm9vdFt2XV07CiAgICAgICAgaWYgKHYgPT09IHJvb3Rbdl0gJiYgdiA9PT0gc2lua1t2XSkgewogICAgICAgICAgdmFyIG1pblNoaWZ0ID0gMDsKICAgICAgICAgIGlmICh2IGluIG1heWJlU2hpZnQgJiYgT2JqZWN0LmtleXMobWF5YmVTaGlmdFt2XSkubGVuZ3RoID4gMCkgewogICAgICAgICAgICBtaW5TaGlmdCA9IHV0aWwubWluKE9iamVjdC5rZXlzKG1heWJlU2hpZnRbdl0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVNoaWZ0W3ZdW3VdICsgKHUgaW4gc2hpZnQgPyBzaGlmdFt1XSA6IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzaGlmdFt2XSA9IG1pblNoaWZ0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHhzW3ZdICs9IHNoaWZ0W3Npbmtbcm9vdFt2XV1dIHx8IDA7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHhzOwogIH0KCiAgZnVuY3Rpb24gZmluZE1pbkNvb3JkKGcsIGxheWVyaW5nLCB4cykgewogICAgcmV0dXJuIHV0aWwubWluKGxheWVyaW5nLm1hcChmdW5jdGlvbihsYXllcikgewogICAgICB2YXIgdSA9IGxheWVyWzBdOwogICAgICByZXR1cm4geHNbdV07CiAgICB9KSk7CiAgfQoKICBmdW5jdGlvbiBmaW5kTWF4Q29vcmQoZywgbGF5ZXJpbmcsIHhzKSB7CiAgICByZXR1cm4gdXRpbC5tYXgobGF5ZXJpbmcubWFwKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIHZhciB1ID0gbGF5ZXJbbGF5ZXIubGVuZ3RoIC0gMV07CiAgICAgIHJldHVybiB4c1t1XTsKICAgIH0pKTsKICB9CgogIGZ1bmN0aW9uIGJhbGFuY2UoZywgbGF5ZXJpbmcsIHhzcykgewogICAgdmFyIG1pbiA9IHt9LCAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNaW4gY29vcmRpbmF0ZSBmb3IgdGhlIGFsaWdubWVudAogICAgICAgIG1heCA9IHt9LCAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXggY29vcmRpbmF0ZSBmb3IgdGhlIGFsZ2lubWVudAogICAgICAgIHNtYWxsZXN0QWxpZ25tZW50LAogICAgICAgIHNoaWZ0ID0ge307ICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBbW91bnQgdG8gc2hpZnQgYSBnaXZlbiBhbGlnbm1lbnQKCiAgICBmdW5jdGlvbiB1cGRhdGVBbGlnbm1lbnQodikgewogICAgICB4c3NbYWxpZ25tZW50XVt2XSArPSBzaGlmdFthbGlnbm1lbnRdOwogICAgfQoKICAgIHZhciBzbWFsbGVzdCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGZvciAodmFyIGFsaWdubWVudCBpbiB4c3MpIHsKICAgICAgdmFyIHhzID0geHNzW2FsaWdubWVudF07CiAgICAgIG1pblthbGlnbm1lbnRdID0gZmluZE1pbkNvb3JkKGcsIGxheWVyaW5nLCB4cyk7CiAgICAgIG1heFthbGlnbm1lbnRdID0gZmluZE1heENvb3JkKGcsIGxheWVyaW5nLCB4cyk7CiAgICAgIHZhciB3ID0gbWF4W2FsaWdubWVudF0gLSBtaW5bYWxpZ25tZW50XTsKICAgICAgaWYgKHcgPCBzbWFsbGVzdCkgewogICAgICAgIHNtYWxsZXN0ID0gdzsKICAgICAgICBzbWFsbGVzdEFsaWdubWVudCA9IGFsaWdubWVudDsKICAgICAgfQogICAgfQoKICAgIC8vIERldGVybWluZSBob3cgbXVjaCB0byBhZGp1c3QgcG9zaXRpb25pbmcgZm9yIGVhY2ggYWxpZ25tZW50CiAgICBbJ3UnLCAnZCddLmZvckVhY2goZnVuY3Rpb24odmVydERpcikgewogICAgICBbJ2wnLCAnciddLmZvckVhY2goZnVuY3Rpb24oaG9yaXpEaXIpIHsKICAgICAgICB2YXIgYWxpZ25tZW50ID0gdmVydERpciArIGhvcml6RGlyOwogICAgICAgIHNoaWZ0W2FsaWdubWVudF0gPSBob3JpekRpciA9PT0gJ2wnCiAgICAgICAgICAgID8gbWluW3NtYWxsZXN0QWxpZ25tZW50XSAtIG1pblthbGlnbm1lbnRdCiAgICAgICAgICAgIDogbWF4W3NtYWxsZXN0QWxpZ25tZW50XSAtIG1heFthbGlnbm1lbnRdOwogICAgICB9KTsKICAgIH0pOwoKICAgIC8vIEZpbmQgYXZlcmFnZSBvZiBtZWRpYW5zIGZvciB4c3MgYXJyYXkKICAgIGZvciAoYWxpZ25tZW50IGluIHhzcykgewogICAgICBnLmVhY2hOb2RlKHVwZGF0ZUFsaWdubWVudCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmbGlwSG9yaXpvbnRhbGx5KHhzKSB7CiAgICBmb3IgKHZhciB1IGluIHhzKSB7CiAgICAgIHhzW3VdID0gLXhzW3VdOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmV2ZXJzZUlubmVyT3JkZXIobGF5ZXJpbmcpIHsKICAgIGxheWVyaW5nLmZvckVhY2goZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgbGF5ZXIucmV2ZXJzZSgpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB3aWR0aChnLCB1KSB7CiAgICBzd2l0Y2ggKGcuZ3JhcGgoKS5yYW5rRGlyKSB7CiAgICAgIGNhc2UgJ0xSJzogcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICAgIGNhc2UgJ1JMJzogcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICAgIGRlZmF1bHQ6ICAgcmV0dXJuIGcubm9kZSh1KS53aWR0aDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhlaWdodChnLCB1KSB7CiAgICBzd2l0Y2goZy5ncmFwaCgpLnJhbmtEaXIpIHsKICAgICAgY2FzZSAnTFInOiByZXR1cm4gZy5ub2RlKHUpLndpZHRoOwogICAgICBjYXNlICdSTCc6IHJldHVybiBnLm5vZGUodSkud2lkdGg7CiAgICAgIGRlZmF1bHQ6ICAgcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXAoZywgdSkgewogICAgaWYgKGNvbmZpZy51bml2ZXJzYWxTZXAgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGNvbmZpZy51bml2ZXJzYWxTZXA7CiAgICB9CiAgICB2YXIgdyA9IHdpZHRoKGcsIHUpOwogICAgdmFyIHMgPSBnLm5vZGUodSkuZHVtbXkgPyBjb25maWcuZWRnZVNlcCA6IGNvbmZpZy5ub2RlU2VwOwogICAgcmV0dXJuICh3ICsgcykgLyAyOwogIH0KCiAgZnVuY3Rpb24gcG9zWChnLCB1LCB4KSB7CiAgICBpZiAoZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdMUicgfHwgZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdSTCcpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS55OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS55ID0geDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS54OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS54ID0geDsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcG9zWERlYnVnKG5hbWUsIGcsIHUsIHgpIHsKICAgIGlmIChnLmdyYXBoKCkucmFua0RpciA9PT0gJ0xSJyB8fCBnLmdyYXBoKCkucmFua0RpciA9PT0gJ1JMJykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgICByZXR1cm4gZy5ub2RlKHUpW25hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KVtuYW1lXSA9IHg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAgIHJldHVybiBnLm5vZGUodSlbbmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZy5ub2RlKHUpW25hbWVdID0geDsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcG9zWShnLCB1LCB5KSB7CiAgICBpZiAoZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdMUicgfHwgZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdSTCcpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS54OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS54ID0geTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS55OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS55ID0geTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVidWdQb3NpdGlvbmluZyhhbGlnbiwgZywgbGF5ZXJpbmcsIHhzKSB7CiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGwsIGxpKSB7CiAgICAgIHZhciB1LCB4VTsKICAgICAgbC5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICB2YXIgeFYgPSB4c1t2XTsKICAgICAgICBpZiAodSkgewogICAgICAgICAgdmFyIHMgPSBzZXAoZywgdSkgKyBzZXAoZywgdik7CiAgICAgICAgICBpZiAoeFYgLSB4VSA8IHMpCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQb3NpdGlvbiBwaGFzZTogc2VwIHZpb2xhdGlvbi4gQWxpZ246ICcgKyBhbGlnbiArICcuIExheWVyOiAnICsgbGkgKyAnLiAnICsKICAgICAgICAgICAgICAnVTogJyArIHUgKyAnIFY6ICcgKyB2ICsgJy4gQWN0dWFsIHNlcDogJyArICh4ViAtIHhVKSArICcgRXhwZWN0ZWQgc2VwOiAnICsgcyk7CiAgICAgICAgfQogICAgICAgIHUgPSB2OwogICAgICAgIHhVID0geFY7CiAgICAgIH0pOwogICAgfSk7CiAgfQp9OwoKfSx7Ii4vdXRpbCI6MTd9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyksCiAgICBhY3ljbGljID0gcmVxdWlyZSgnLi9yYW5rL2FjeWNsaWMnKSwKICAgIGluaXRSYW5rID0gcmVxdWlyZSgnLi9yYW5rL2luaXRSYW5rJyksCiAgICBmZWFzaWJsZVRyZWUgPSByZXF1aXJlKCcuL3JhbmsvZmVhc2libGVUcmVlJyksCiAgICBjb25zdHJhaW50cyA9IHJlcXVpcmUoJy4vcmFuay9jb25zdHJhaW50cycpLAogICAgc2ltcGxleCA9IHJlcXVpcmUoJy4vcmFuay9zaW1wbGV4JyksCiAgICBjb21wb25lbnRzID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5hbGcuY29tcG9uZW50cywKICAgIGZpbHRlciA9IHJlcXVpcmUoJ2dyYXBobGliJykuZmlsdGVyOwoKZXhwb3J0cy5ydW4gPSBydW47CmV4cG9ydHMucmVzdG9yZUVkZ2VzID0gcmVzdG9yZUVkZ2VzOwoKLyoKICogSGV1cmlzdGljIGZ1bmN0aW9uIHRoYXQgYXNzaWducyBhIHJhbmsgdG8gZWFjaCBub2RlIG9mIHRoZSBpbnB1dCBncmFwaCB3aXRoCiAqIHRoZSBpbnRlbnQgb2YgbWluaW1pemluZyBlZGdlIGxlbmd0aHMsIHdoaWxlIHJlc3BlY3RpbmcgdGhlIGBtaW5MZW5gCiAqIGF0dHJpYnV0ZSBvZiBpbmNpZGVudCBlZGdlcy4KICoKICogUHJlcmVxdWlzaXRlczoKICoKICogICogRWFjaCBlZGdlIGluIHRoZSBpbnB1dCBncmFwaCBtdXN0IGhhdmUgYW4gYXNzaWduZWQgJ21pbkxlbicgYXR0cmlidXRlCiAqLwpmdW5jdGlvbiBydW4oZywgdXNlU2ltcGxleCkgewogIGV4cGFuZFNlbGZMb29wcyhnKTsKCiAgLy8gSWYgdGhlcmUgYXJlIHJhbmsgY29uc3RyYWludHMgb24gbm9kZXMsIHRoZW4gYnVpbGQgYSBuZXcgZ3JhcGggdGhhdAogIC8vIGVuY29kZXMgdGhlIGNvbnN0cmFpbnRzLgogIHV0aWwudGltZSgnY29uc3RyYWludHMuYXBwbHknLCBjb25zdHJhaW50cy5hcHBseSkoZyk7CgogIGV4cGFuZFNpZGV3YXlzRWRnZXMoZyk7CgogIC8vIFJldmVyc2UgZWRnZXMgdG8gZ2V0IGFuIGFjeWNsaWMgZ3JhcGgsIHdlIGtlZXAgdGhlIGdyYXBoIGluIGFuIGFjeWNsaWMKICAvLyBzdGF0ZSB1bnRpbCB0aGUgdmVyeSBlbmQuCiAgdXRpbC50aW1lKCdhY3ljbGljJywgYWN5Y2xpYykoZyk7CgogIC8vIENvbnZlcnQgdGhlIGdyYXBoIGludG8gYSBmbGF0IGdyYXBoIGZvciByYW5raW5nCiAgdmFyIGZsYXRHcmFwaCA9IGcuZmlsdGVyTm9kZXModXRpbC5maWx0ZXJOb25TdWJncmFwaHMoZykpOwoKICAvLyBBc3NpZ24gYW4gaW5pdGlhbCByYW5raW5nIHVzaW5nIERGUy4KICBpbml0UmFuayhmbGF0R3JhcGgpOwoKICAvLyBGb3IgZWFjaCBjb21wb25lbnQgaW1wcm92ZSB0aGUgYXNzaWduZWQgcmFua3MuCiAgY29tcG9uZW50cyhmbGF0R3JhcGgpLmZvckVhY2goZnVuY3Rpb24oY21wdCkgewogICAgdmFyIHN1YmdyYXBoID0gZmxhdEdyYXBoLmZpbHRlck5vZGVzKGZpbHRlci5ub2Rlc0Zyb21MaXN0KGNtcHQpKTsKICAgIHJhbmtDb21wb25lbnQoc3ViZ3JhcGgsIHVzZVNpbXBsZXgpOwogIH0pOwoKICAvLyBSZWxheCBvcmlnaW5hbCBjb25zdHJhaW50cwogIHV0aWwudGltZSgnY29uc3RyYWludHMucmVsYXgnLCBjb25zdHJhaW50cy5yZWxheChnKSk7CgogIC8vIFdoZW4gaGFuZGxpbmcgbm9kZXMgd2l0aCBjb25zdHJhaW5lZCByYW5rcyBpdCBpcyBwb3NzaWJsZSB0byBlbmQgdXAgd2l0aAogIC8vIGVkZ2VzIHRoYXQgcG9pbnQgdG8gcHJldmlvdXMgcmFua3MuIE1vc3Qgb2YgdGhlIHN1YnNlcXVlbnQgYWxnb3JpdGhtcyBhc3N1bWUKICAvLyB0aGF0IGVkZ2VzIGFyZSBwb2ludGluZyB0byBzdWNjZXNzaXZlIHJhbmtzIG9ubHkuIEhlcmUgd2UgcmV2ZXJzZSBhbnkgImJhY2sKICAvLyBlZGdlcyIgYW5kIG1hcmsgdGhlbSBhcyBzdWNoLiBUaGUgYWN5Y2xpYyBhbGdvcml0aG0gd2lsbCByZXZlcnNlIHRoZW0gYXMgYQogIC8vIHBvc3QgcHJvY2Vzc2luZyBzdGVwLgogIHV0aWwudGltZSgncmVvcmllbnRFZGdlcycsIHJlb3JpZW50RWRnZXMpKGcpOwp9CgpmdW5jdGlvbiByZXN0b3JlRWRnZXMoZykgewogIGFjeWNsaWMudW5kbyhnKTsKfQoKLyoKICogRXhwYW5kIHNlbGYgbG9vcHMgaW50byB0aHJlZSBkdW1teSBub2Rlcy4gT25lIHdpbGwgc2l0IGFib3ZlIHRoZSBpbmNpZGVudAogKiBub2RlLCBvbmUgd2lsbCBiZSBhdCB0aGUgc2FtZSBsZXZlbCwgYW5kIG9uZSBiZWxvdy4gVGhlIHJlc3VsdCBsb29rcyBsaWtlOgogKgogKiAgICAgICAgIC8tLTwtLXgtLS0+LS1cCiAqICAgICBub2RlICAgICAgICAgICAgICB5CiAqICAgICAgICAgXC0tPC0tei0tLT4tLS8KICoKICogRHVtbXkgbm9kZXMgeCwgeSwgeiBnaXZlIHVzIHRoZSBzaGFwZSBvZiBhIGxvb3AgYW5kIG5vZGUgeSBpcyB3aGVyZSB3ZSBwbGFjZQogKiB0aGUgbGFiZWwuCiAqCiAqIFRPRE86IGNvbnNvbGlkYXRlIGtub3dsZWRnZSBvZiBkdW1teSBub2RlIGNvbnN0cnVjdGlvbi4KICogVE9ETzogc3VwcG9ydCBtaW5MZW4gPSAyCiAqLwpmdW5jdGlvbiBleHBhbmRTZWxmTG9vcHMoZykgewogIGcuZWFjaEVkZ2UoZnVuY3Rpb24oZSwgdSwgdiwgYSkgewogICAgaWYgKHUgPT09IHYpIHsKICAgICAgdmFyIHggPSBhZGREdW1teU5vZGUoZywgZSwgdSwgdiwgYSwgMCwgZmFsc2UpLAogICAgICAgICAgeSA9IGFkZER1bW15Tm9kZShnLCBlLCB1LCB2LCBhLCAxLCB0cnVlKSwKICAgICAgICAgIHogPSBhZGREdW1teU5vZGUoZywgZSwgdSwgdiwgYSwgMiwgZmFsc2UpOwogICAgICBnLmFkZEVkZ2UobnVsbCwgeCwgdSwge21pbkxlbjogMSwgc2VsZkxvb3A6IHRydWV9KTsKICAgICAgZy5hZGRFZGdlKG51bGwsIHgsIHksIHttaW5MZW46IDEsIHNlbGZMb29wOiB0cnVlfSk7CiAgICAgIGcuYWRkRWRnZShudWxsLCB1LCB6LCB7bWluTGVuOiAxLCBzZWxmTG9vcDogdHJ1ZX0pOwogICAgICBnLmFkZEVkZ2UobnVsbCwgeSwgeiwge21pbkxlbjogMSwgc2VsZkxvb3A6IHRydWV9KTsKICAgICAgZy5kZWxFZGdlKGUpOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBleHBhbmRTaWRld2F5c0VkZ2VzKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIGEpIHsKICAgIGlmICh1ID09PSB2KSB7CiAgICAgIHZhciBvcmlnRWRnZSA9IGEub3JpZ2luYWxFZGdlLAogICAgICAgICAgZHVtbXkgPSBhZGREdW1teU5vZGUoZywgb3JpZ0VkZ2UuZSwgb3JpZ0VkZ2UudSwgb3JpZ0VkZ2Uudiwgb3JpZ0VkZ2UudmFsdWUsIDAsIHRydWUpOwogICAgICBnLmFkZEVkZ2UobnVsbCwgdSwgZHVtbXksIHttaW5MZW46IDF9KTsKICAgICAgZy5hZGRFZGdlKG51bGwsIGR1bW15LCB2LCB7bWluTGVuOiAxfSk7CiAgICAgIGcuZGVsRWRnZShlKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gYWRkRHVtbXlOb2RlKGcsIGUsIHUsIHYsIGEsIGluZGV4LCBpc0xhYmVsKSB7CiAgcmV0dXJuIGcuYWRkTm9kZShudWxsLCB7CiAgICB3aWR0aDogaXNMYWJlbCA/IGEud2lkdGggOiAwLAogICAgaGVpZ2h0OiBpc0xhYmVsID8gYS5oZWlnaHQgOiAwLAogICAgZWRnZTogeyBpZDogZSwgc291cmNlOiB1LCB0YXJnZXQ6IHYsIGF0dHJzOiBhIH0sCiAgICBkdW1teTogdHJ1ZSwKICAgIGluZGV4OiBpbmRleAogIH0pOwp9CgpmdW5jdGlvbiByZW9yaWVudEVkZ2VzKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBpZiAoZy5ub2RlKHUpLnJhbmsgPiBnLm5vZGUodikucmFuaykgewogICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgIHZhbHVlLnJldmVyc2VkID0gdHJ1ZTsKICAgICAgZy5hZGRFZGdlKGUsIHYsIHUsIHZhbHVlKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gcmFua0NvbXBvbmVudChzdWJncmFwaCwgdXNlU2ltcGxleCkgewogIHZhciBzcGFubmluZ1RyZWUgPSBmZWFzaWJsZVRyZWUoc3ViZ3JhcGgpOwoKICBpZiAodXNlU2ltcGxleCkgewogICAgdXRpbC5sb2coMSwgJ1VzaW5nIG5ldHdvcmsgc2ltcGxleCBmb3IgcmFua2luZycpOwogICAgc2ltcGxleChzdWJncmFwaCwgc3Bhbm5pbmdUcmVlKTsKICB9CiAgbm9ybWFsaXplKHN1YmdyYXBoKTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplKGcpIHsKICB2YXIgbSA9IHV0aWwubWluKGcubm9kZXMoKS5tYXAoZnVuY3Rpb24odSkgeyByZXR1cm4gZy5ub2RlKHUpLnJhbms7IH0pKTsKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIG5vZGUpIHsgbm9kZS5yYW5rIC09IG07IH0pOwp9Cgp9LHsiLi9yYW5rL2FjeWNsaWMiOjExLCIuL3JhbmsvY29uc3RyYWludHMiOjEyLCIuL3JhbmsvZmVhc2libGVUcmVlIjoxMywiLi9yYW5rL2luaXRSYW5rIjoxNCwiLi9yYW5rL3NpbXBsZXgiOjE2LCIuL3V0aWwiOjE3LCJncmFwaGxpYiI6MjR9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBhY3ljbGljOwptb2R1bGUuZXhwb3J0cy51bmRvID0gdW5kbzsKCi8qCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYSBkaXJlY3RlZCBncmFwaCB0aGF0IG1heSBoYXZlIGN5Y2xlcyBhbmQgcmV2ZXJzZXMgZWRnZXMKICogYXMgYXBwcm9wcmlhdGUgdG8gYnJlYWsgdGhlc2UgY3ljbGVzLiBFYWNoIHJldmVyc2VkIGVkZ2UgaXMgYXNzaWduZWQgYQogKiBgcmV2ZXJzZWRgIGF0dHJpYnV0ZSB3aXRoIHRoZSB2YWx1ZSBgdHJ1ZWAuCiAqCiAqIFRoZXJlIHNob3VsZCBiZSBubyBzZWxmIGxvb3BzIGluIHRoZSBncmFwaC4KICovCmZ1bmN0aW9uIGFjeWNsaWMoZykgewogIHZhciBvblN0YWNrID0ge30sCiAgICAgIHZpc2l0ZWQgPSB7fSwKICAgICAgcmV2ZXJzZUNvdW50ID0gMDsKICAKICBmdW5jdGlvbiBkZnModSkgewogICAgaWYgKHUgaW4gdmlzaXRlZCkgcmV0dXJuOwogICAgdmlzaXRlZFt1XSA9IG9uU3RhY2tbdV0gPSB0cnVlOwogICAgZy5vdXRFZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHQgPSBnLnRhcmdldChlKSwKICAgICAgICAgIHZhbHVlOwoKICAgICAgaWYgKHUgPT09IHQpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdXYXJuaW5nOiBmb3VuZCBzZWxmIGxvb3AgIicgKyBlICsgJyIgZm9yIG5vZGUgIicgKyB1ICsgJyInKTsKICAgICAgfSBlbHNlIGlmICh0IGluIG9uU3RhY2spIHsKICAgICAgICB2YWx1ZSA9IGcuZWRnZShlKTsKICAgICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgICAgICsrcmV2ZXJzZUNvdW50OwogICAgICAgIGcuYWRkRWRnZShlLCB0LCB1LCB2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGZzKHQpOwogICAgICB9CiAgICB9KTsKCiAgICBkZWxldGUgb25TdGFja1t1XTsKICB9CgogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSkgeyBkZnModSk7IH0pOwoKICB1dGlsLmxvZygyLCAnQWN5Y2xpYyBQaGFzZTogcmV2ZXJzZWQgJyArIHJldmVyc2VDb3VudCArICcgZWRnZShzKScpOwoKICByZXR1cm4gcmV2ZXJzZUNvdW50Owp9CgovKgogKiBHaXZlbiBhIGdyYXBoIHRoYXQgaGFzIGhhZCB0aGUgYWN5Y2xpYyBvcGVyYXRpb24gYXBwbGllZCwgdGhpcyBmdW5jdGlvbgogKiB1bmRvZXMgdGhhdCBvcGVyYXRpb24uIE1vcmUgc3BlY2lmaWNhbGx5LCBhbnkgZWRnZSB3aXRoIHRoZSBgcmV2ZXJzZWRgCiAqIGF0dHJpYnV0ZSBpcyBhZ2FpbiByZXZlcnNlZCB0byByZXN0b3JlIHRoZSBvcmlnaW5hbCBkaXJlY3Rpb24gb2YgdGhlIGVkZ2UuCiAqLwpmdW5jdGlvbiB1bmRvKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHMsIHQsIGEpIHsKICAgIGlmIChhLnJldmVyc2VkKSB7CiAgICAgIGRlbGV0ZSBhLnJldmVyc2VkOwogICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgIGcuYWRkRWRnZShlLCB0LCBzLCBhKTsKICAgIH0KICB9KTsKfQoKfSx7Ii4uL3V0aWwiOjE3fV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpleHBvcnRzLmFwcGx5ID0gZnVuY3Rpb24oZykgewogIGZ1bmN0aW9uIGRmcyhzZykgewogICAgdmFyIHJhbmtTZXRzID0ge307CiAgICBnLmNoaWxkcmVuKHNnKS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgICAgaWYgKGcuY2hpbGRyZW4odSkubGVuZ3RoKSB7CiAgICAgICAgZGZzKHUpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlID0gZy5ub2RlKHUpLAogICAgICAgICAgcHJlZlJhbmsgPSB2YWx1ZS5wcmVmUmFuazsKICAgICAgaWYgKHByZWZSYW5rICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIWNoZWNrU3VwcG9ydGVkUHJlZlJhbmsocHJlZlJhbmspKSB7IHJldHVybjsgfQoKICAgICAgICBpZiAoIShwcmVmUmFuayBpbiByYW5rU2V0cykpIHsKICAgICAgICAgIHJhbmtTZXRzLnByZWZSYW5rID0gW3VdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByYW5rU2V0cy5wcmVmUmFuay5wdXNoKHUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1UgPSByYW5rU2V0c1twcmVmUmFua107CiAgICAgICAgaWYgKG5ld1UgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgbmV3VSA9IHJhbmtTZXRzW3ByZWZSYW5rXSA9IGcuYWRkTm9kZShudWxsLCB7IG9yaWdpbmFsTm9kZXM6IFtdIH0pOwogICAgICAgICAgZy5wYXJlbnQobmV3VSwgc2cpOwogICAgICAgIH0KCiAgICAgICAgcmVkaXJlY3RJbkVkZ2VzKGcsIHUsIG5ld1UsIHByZWZSYW5rID09PSAnbWluJyk7CiAgICAgICAgcmVkaXJlY3RPdXRFZGdlcyhnLCB1LCBuZXdVLCBwcmVmUmFuayA9PT0gJ21heCcpOwoKICAgICAgICAvLyBTYXZlIG9yaWdpbmFsIG5vZGUgYW5kIHJlbW92ZSBpdCBmcm9tIHJlZHVjZWQgZ3JhcGgKICAgICAgICBnLm5vZGUobmV3VSkub3JpZ2luYWxOb2Rlcy5wdXNoKHsgdTogdSwgdmFsdWU6IHZhbHVlLCBwYXJlbnQ6IHNnIH0pOwogICAgICAgIGcuZGVsTm9kZSh1KTsKICAgICAgfQogICAgfSk7CgogICAgYWRkTGlnaHRFZGdlc0Zyb21NaW5Ob2RlKGcsIHNnLCByYW5rU2V0cy5taW4pOwogICAgYWRkTGlnaHRFZGdlc1RvTWF4Tm9kZShnLCBzZywgcmFua1NldHMubWF4KTsKICB9CgogIGRmcyhudWxsKTsKfTsKCmZ1bmN0aW9uIGNoZWNrU3VwcG9ydGVkUHJlZlJhbmsocHJlZlJhbmspIHsKICBpZiAocHJlZlJhbmsgIT09ICdtaW4nICYmIHByZWZSYW5rICE9PSAnbWF4JyAmJiBwcmVmUmFuay5pbmRleE9mKCdzYW1lXycpICE9PSAwKSB7CiAgICBjb25zb2xlLmVycm9yKCdVbnN1cHBvcnRlZCByYW5rIHR5cGU6ICcgKyBwcmVmUmFuayk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZWRpcmVjdEluRWRnZXMoZywgdSwgbmV3VSwgcmV2ZXJzZSkgewogIGcuaW5FZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgIHZhciBvcmlnVmFsdWUgPSBnLmVkZ2UoZSksCiAgICAgICAgdmFsdWU7CiAgICBpZiAob3JpZ1ZhbHVlLm9yaWdpbmFsRWRnZSkgewogICAgICB2YWx1ZSA9IG9yaWdWYWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlID0gIHsKICAgICAgICBvcmlnaW5hbEVkZ2U6IHsgZTogZSwgdTogZy5zb3VyY2UoZSksIHY6IGcudGFyZ2V0KGUpLCB2YWx1ZTogb3JpZ1ZhbHVlIH0sCiAgICAgICAgbWluTGVuOiBnLmVkZ2UoZSkubWluTGVuCiAgICAgIH07CiAgICB9CgogICAgLy8gRG8gbm90IHJldmVyc2UgZWRnZXMgZm9yIHNlbGYtbG9vcHMuCiAgICBpZiAob3JpZ1ZhbHVlLnNlbGZMb29wKSB7CiAgICAgIHJldmVyc2UgPSBmYWxzZTsKICAgIH0KCiAgICBpZiAocmV2ZXJzZSkgewogICAgICAvLyBFbnN1cmUgdGhhdCBhbGwgZWRnZXMgdG8gbWluIGFyZSByZXZlcnNlZAogICAgICBnLmFkZEVkZ2UobnVsbCwgbmV3VSwgZy5zb3VyY2UoZSksIHZhbHVlKTsKICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIGcuc291cmNlKGUpLCBuZXdVLCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlZGlyZWN0T3V0RWRnZXMoZywgdSwgbmV3VSwgcmV2ZXJzZSkgewogIGcub3V0RWRnZXModSkuZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICB2YXIgb3JpZ1ZhbHVlID0gZy5lZGdlKGUpLAogICAgICAgIHZhbHVlOwogICAgaWYgKG9yaWdWYWx1ZS5vcmlnaW5hbEVkZ2UpIHsKICAgICAgdmFsdWUgPSBvcmlnVmFsdWU7CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9ICB7CiAgICAgICAgb3JpZ2luYWxFZGdlOiB7IGU6IGUsIHU6IGcuc291cmNlKGUpLCB2OiBnLnRhcmdldChlKSwgdmFsdWU6IG9yaWdWYWx1ZSB9LAogICAgICAgIG1pbkxlbjogZy5lZGdlKGUpLm1pbkxlbgogICAgICB9OwogICAgfQoKICAgIC8vIERvIG5vdCByZXZlcnNlIGVkZ2VzIGZvciBzZWxmLWxvb3BzLgogICAgaWYgKG9yaWdWYWx1ZS5zZWxmTG9vcCkgewogICAgICByZXZlcnNlID0gZmFsc2U7CiAgICB9CgogICAgaWYgKHJldmVyc2UpIHsKICAgICAgLy8gRW5zdXJlIHRoYXQgYWxsIGVkZ2VzIGZyb20gbWF4IGFyZSByZXZlcnNlZAogICAgICBnLmFkZEVkZ2UobnVsbCwgZy50YXJnZXQoZSksIG5ld1UsIHZhbHVlKTsKICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIG5ld1UsIGcudGFyZ2V0KGUpLCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGFkZExpZ2h0RWRnZXNGcm9tTWluTm9kZShnLCBzZywgbWluTm9kZSkgewogIGlmIChtaW5Ob2RlICE9PSB1bmRlZmluZWQpIHsKICAgIGcuY2hpbGRyZW4oc2cpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAvLyBUaGUgZHVtbXkgY2hlY2sgZW5zdXJlcyB3ZSBkb24ndCBhZGQgYW4gZWRnZSBpZiB0aGUgbm9kZSBpcyBpbnZvbHZlZAogICAgICAvLyBpbiBhIHNlbGYgbG9vcCBvciBzaWRld2F5cyBlZGdlLgogICAgICBpZiAodSAhPT0gbWluTm9kZSAmJiAhZy5vdXRFZGdlcyhtaW5Ob2RlLCB1KS5sZW5ndGggJiYgIWcubm9kZSh1KS5kdW1teSkgewogICAgICAgIGcuYWRkRWRnZShudWxsLCBtaW5Ob2RlLCB1LCB7IG1pbkxlbjogMCB9KTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBhZGRMaWdodEVkZ2VzVG9NYXhOb2RlKGcsIHNnLCBtYXhOb2RlKSB7CiAgaWYgKG1heE5vZGUgIT09IHVuZGVmaW5lZCkgewogICAgZy5jaGlsZHJlbihzZykuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIC8vIFRoZSBkdW1teSBjaGVjayBlbnN1cmVzIHdlIGRvbid0IGFkZCBhbiBlZGdlIGlmIHRoZSBub2RlIGlzIGludm9sdmVkCiAgICAgIC8vIGluIGEgc2VsZiBsb29wIG9yIHNpZGV3YXlzIGVkZ2UuCiAgICAgIGlmICh1ICE9PSBtYXhOb2RlICYmICFnLm91dEVkZ2VzKHUsIG1heE5vZGUpLmxlbmd0aCAmJiAhZy5ub2RlKHUpLmR1bW15KSB7CiAgICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIG1heE5vZGUsIHsgbWluTGVuOiAwIH0pOwogICAgICB9CiAgICB9KTsKICB9Cn0KCi8qCiAqIFRoaXMgZnVuY3Rpb24gInJlbGF4ZXMiIHRoZSBjb25zdHJhaW50cyBhcHBsaWVkIHByZXZpb3VzbHkgYnkgdGhlICJhcHBseSIKICogZnVuY3Rpb24uIEl0IGV4cGFuZHMgYW55IG5vZGVzIHRoYXQgd2VyZSBjb2xsYXBzZWQgYW5kIGFzc2lnbnMgdGhlIHJhbmsgb2YKICogdGhlIGNvbGxhcHNlZCBub2RlIHRvIGVhY2ggb2YgdGhlIGV4cGFuZGVkIG5vZGVzLiBJdCBhbHNvIHJlc3RvcmVzIHRoZQogKiBvcmlnaW5hbCBlZGdlcyBhbmQgcmVtb3ZlcyBhbnkgZHVtbXkgZWRnZXMgcG9pbnRpbmcgYXQgdGhlIGNvbGxhcHNlZCBub2Rlcy4KICoKICogTm90ZSB0aGF0IHRoZSBwcm9jZXNzIG9mIHJlbW92aW5nIGNvbGxhcHNlZCBub2RlcyBhbHNvIHJlbW92ZXMgZHVtbXkgZWRnZXMKICogYXV0b21hdGljYWxseS4KICovCmV4cG9ydHMucmVsYXggPSBmdW5jdGlvbihnKSB7CiAgLy8gU2F2ZSBvcmlnaW5hbCBlZGdlcwogIHZhciBvcmlnaW5hbEVkZ2VzID0gW107CiAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgdmFyIG9yaWdpbmFsRWRnZSA9IHZhbHVlLm9yaWdpbmFsRWRnZTsKICAgIGlmIChvcmlnaW5hbEVkZ2UpIHsKICAgICAgb3JpZ2luYWxFZGdlcy5wdXNoKG9yaWdpbmFsRWRnZSk7CiAgICB9CiAgfSk7CgogIC8vIEV4cGFuZCBjb2xsYXBzZWQgbm9kZXMKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB2YXIgb3JpZ2luYWxOb2RlcyA9IHZhbHVlLm9yaWdpbmFsTm9kZXM7CiAgICBpZiAob3JpZ2luYWxOb2RlcykgewogICAgICBvcmlnaW5hbE5vZGVzLmZvckVhY2goZnVuY3Rpb24ob3JpZ2luYWxOb2RlKSB7CiAgICAgICAgb3JpZ2luYWxOb2RlLnZhbHVlLnJhbmsgPSB2YWx1ZS5yYW5rOwogICAgICAgIGcuYWRkTm9kZShvcmlnaW5hbE5vZGUudSwgb3JpZ2luYWxOb2RlLnZhbHVlKTsKICAgICAgICBnLnBhcmVudChvcmlnaW5hbE5vZGUudSwgb3JpZ2luYWxOb2RlLnBhcmVudCk7CiAgICAgIH0pOwogICAgICBnLmRlbE5vZGUodSk7CiAgICB9CiAgfSk7CgogIC8vIFJlc3RvcmUgb3JpZ2luYWwgZWRnZXMKICBvcmlnaW5hbEVkZ2VzLmZvckVhY2goZnVuY3Rpb24oZWRnZSkgewogICAgZy5hZGRFZGdlKGVkZ2UuZSwgZWRnZS51LCBlZGdlLnYsIGVkZ2UudmFsdWUpOwogIH0pOwp9OwoKfSx7fV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBqc2hpbnQgLVcwNzkgKi8KdmFyIFNldCA9IHJlcXVpcmUoJ2NwLWRhdGEnKS5TZXQsCi8qIGpzaGludCArVzA3OSAqLwogICAgRGlncmFwaCA9IHJlcXVpcmUoJ2dyYXBobGliJykuRGlncmFwaCwKICAgIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZlYXNpYmxlVHJlZTsKCi8qCiAqIEdpdmVuIGFuIGFjeWNsaWMgZ3JhcGggd2l0aCBlYWNoIG5vZGUgYXNzaWduZWQgYSBgcmFua2AgYXR0cmlidXRlLCB0aGlzCiAqIGZ1bmN0aW9uIGNvbnN0cnVjdHMgYW5kIHJldHVybnMgYSBzcGFubmluZyB0cmVlLiBUaGlzIGZ1bmN0aW9uIG1heSByZWR1Y2UKICogdGhlIGxlbmd0aCBvZiBzb21lIGVkZ2VzIGZyb20gdGhlIGluaXRpYWwgcmFuayBhc3NpZ25tZW50IHdoaWxlIG1haW50YWluaW5nCiAqIHRoZSBgbWluTGVuYCBzcGVjaWZpZWQgYnkgZWFjaCBlZGdlLgogKgogKiBQcmVyZXF1aXNpdGVzOgogKgogKiAqIFRoZSBpbnB1dCBncmFwaCBpcyBhY3ljbGljCiAqICogRWFjaCBub2RlIGluIHRoZSBpbnB1dCBncmFwaCBoYXMgYW4gYXNzaWduZWQgYHJhbmtgIGF0dHJpYnV0ZQogKiAqIEVhY2ggZWRnZSBpbiB0aGUgaW5wdXQgZ3JhcGggaGFzIGFuIGFzc2lnbmVkIGBtaW5MZW5gIGF0dHJpYnV0ZQogKgogKiBPdXRwdXRzOgogKgogKiBBIGZlYXNpYmxlIHNwYW5uaW5nIHRyZWUgZm9yIHRoZSBpbnB1dCBncmFwaCAoaS5lLiBhIHNwYW5uaW5nIHRyZWUgdGhhdAogKiByZXNwZWN0cyBlYWNoIGdyYXBoIGVkZ2UncyBgbWluTGVuYCBhdHRyaWJ1dGUpIHJlcHJlc2VudGVkIGFzIGEgRGlncmFwaCB3aXRoCiAqIGEgYHJvb3RgIGF0dHJpYnV0ZSBvbiBncmFwaC4KICoKICogTm9kZXMgaGF2ZSB0aGUgc2FtZSBpZCBhbmQgdmFsdWUgYXMgdGhhdCBpbiB0aGUgaW5wdXQgZ3JhcGguCiAqCiAqIEVkZ2VzIGluIHRoZSB0cmVlIGhhdmUgYXJiaXRyYXJpbHkgYXNzaWduZWQgaWRzLiBUaGUgYXR0cmlidXRlcyBmb3IgZWRnZXMKICogaW5jbHVkZSBgcmV2ZXJzZWRgLiBgcmV2ZXJzZWRgIGluZGljYXRlcyB0aGF0IHRoZSBlZGdlIGlzIGEKICogYmFjayBlZGdlIGluIHRoZSBpbnB1dCBncmFwaC4KICovCmZ1bmN0aW9uIGZlYXNpYmxlVHJlZShnKSB7CiAgdmFyIHJlbWFpbmluZyA9IG5ldyBTZXQoZy5ub2RlcygpKSwKICAgICAgdHJlZSA9IG5ldyBEaWdyYXBoKCk7CgogIGlmIChyZW1haW5pbmcuc2l6ZSgpID09PSAxKSB7CiAgICB2YXIgcm9vdCA9IGcubm9kZXMoKVswXTsKICAgIHRyZWUuYWRkTm9kZShyb290LCB7fSk7CiAgICB0cmVlLmdyYXBoKHsgcm9vdDogcm9vdCB9KTsKICAgIHJldHVybiB0cmVlOwogIH0KCiAgZnVuY3Rpb24gYWRkVGlnaHRFZGdlcyh2KSB7CiAgICB2YXIgY29udGludWVUb1NjYW4gPSB0cnVlOwogICAgZy5wcmVkZWNlc3NvcnModikuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIGlmIChyZW1haW5pbmcuaGFzKHUpICYmICFzbGFjayhnLCB1LCB2KSkgewogICAgICAgIGlmIChyZW1haW5pbmcuaGFzKHYpKSB7CiAgICAgICAgICB0cmVlLmFkZE5vZGUodiwge30pOwogICAgICAgICAgcmVtYWluaW5nLnJlbW92ZSh2KTsKICAgICAgICAgIHRyZWUuZ3JhcGgoeyByb290OiB2IH0pOwogICAgICAgIH0KCiAgICAgICAgdHJlZS5hZGROb2RlKHUsIHt9KTsKICAgICAgICB0cmVlLmFkZEVkZ2UobnVsbCwgdSwgdiwgeyByZXZlcnNlZDogdHJ1ZSB9KTsKICAgICAgICByZW1haW5pbmcucmVtb3ZlKHUpOwogICAgICAgIGFkZFRpZ2h0RWRnZXModSk7CiAgICAgICAgY29udGludWVUb1NjYW4gPSBmYWxzZTsKICAgICAgfQogICAgfSk7CgogICAgZy5zdWNjZXNzb3JzKHYpLmZvckVhY2goZnVuY3Rpb24odykgIHsKICAgICAgaWYgKHJlbWFpbmluZy5oYXModykgJiYgIXNsYWNrKGcsIHYsIHcpKSB7CiAgICAgICAgaWYgKHJlbWFpbmluZy5oYXModikpIHsKICAgICAgICAgIHRyZWUuYWRkTm9kZSh2LCB7fSk7CiAgICAgICAgICByZW1haW5pbmcucmVtb3ZlKHYpOwogICAgICAgICAgdHJlZS5ncmFwaCh7IHJvb3Q6IHYgfSk7CiAgICAgICAgfQoKICAgICAgICB0cmVlLmFkZE5vZGUodywge30pOwogICAgICAgIHRyZWUuYWRkRWRnZShudWxsLCB2LCB3LCB7fSk7CiAgICAgICAgcmVtYWluaW5nLnJlbW92ZSh3KTsKICAgICAgICBhZGRUaWdodEVkZ2VzKHcpOwogICAgICAgIGNvbnRpbnVlVG9TY2FuID0gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbnRpbnVlVG9TY2FuOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVGlnaHRFZGdlKCkgewogICAgdmFyIG1pblNsYWNrID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIHJlbWFpbmluZy5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGcucHJlZGVjZXNzb3JzKHYpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAgIGlmICghcmVtYWluaW5nLmhhcyh1KSkgewogICAgICAgICAgdmFyIGVkZ2VTbGFjayA9IHNsYWNrKGcsIHUsIHYpOwogICAgICAgICAgaWYgKE1hdGguYWJzKGVkZ2VTbGFjaykgPCBNYXRoLmFicyhtaW5TbGFjaykpIHsKICAgICAgICAgICAgbWluU2xhY2sgPSAtZWRnZVNsYWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICBnLnN1Y2Nlc3NvcnModikuZm9yRWFjaChmdW5jdGlvbih3KSB7CiAgICAgICAgaWYgKCFyZW1haW5pbmcuaGFzKHcpKSB7CiAgICAgICAgICB2YXIgZWRnZVNsYWNrID0gc2xhY2soZywgdiwgdyk7CiAgICAgICAgICBpZiAoTWF0aC5hYnMoZWRnZVNsYWNrKSA8IE1hdGguYWJzKG1pblNsYWNrKSkgewogICAgICAgICAgICBtaW5TbGFjayA9IGVkZ2VTbGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdHJlZS5lYWNoTm9kZShmdW5jdGlvbih1KSB7IGcubm9kZSh1KS5yYW5rIC09IG1pblNsYWNrOyB9KTsKICB9CgogIHdoaWxlIChyZW1haW5pbmcuc2l6ZSgpKSB7CiAgICB2YXIgbm9kZXNUb1NlYXJjaCA9ICF0cmVlLm9yZGVyKCkgPyByZW1haW5pbmcua2V5cygpIDogdHJlZS5ub2RlcygpOwogICAgZm9yICh2YXIgaSA9IDAsIGlsID0gbm9kZXNUb1NlYXJjaC5sZW5ndGg7CiAgICAgICAgIGkgPCBpbCAmJiBhZGRUaWdodEVkZ2VzKG5vZGVzVG9TZWFyY2hbaV0pOwogICAgICAgICArK2kpOwogICAgaWYgKHJlbWFpbmluZy5zaXplKCkpIHsKICAgICAgY3JlYXRlVGlnaHRFZGdlKCk7CiAgICB9CiAgfQoKICByZXR1cm4gdHJlZTsKfQoKZnVuY3Rpb24gc2xhY2soZywgdSwgdikgewogIHZhciByYW5rRGlmZiA9IGcubm9kZSh2KS5yYW5rIC0gZy5ub2RlKHUpLnJhbms7CiAgdmFyIG1heE1pbkxlbiA9IHV0aWwubWF4KGcub3V0RWRnZXModSwgdikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24oZSkgeyByZXR1cm4gZy5lZGdlKGUpLm1pbkxlbjsgfSkpOwogIHJldHVybiByYW5rRGlmZiAtIG1heE1pbkxlbjsKfQoKfSx7Ii4uL3V0aWwiOjE3LCJjcC1kYXRhIjoxOSwiZ3JhcGhsaWIiOjI0fV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKSwKICAgIHRvcHNvcnQgPSByZXF1aXJlKCdncmFwaGxpYicpLmFsZy50b3Bzb3J0OwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0UmFuazsKCi8qCiAqIEFzc2lnbnMgYSBgcmFua2AgYXR0cmlidXRlIHRvIGVhY2ggbm9kZSBpbiB0aGUgaW5wdXQgZ3JhcGggYW5kIGVuc3VyZXMgdGhhdAogKiB0aGlzIHJhbmsgcmVzcGVjdHMgdGhlIGBtaW5MZW5gIGF0dHJpYnV0ZSBvZiBpbmNpZGVudCBlZGdlcy4KICoKICogUHJlcmVxdWlzaXRlczoKICoKICogICogVGhlIGlucHV0IGdyYXBoIG11c3QgYmUgYWN5Y2xpYwogKiAgKiBFYWNoIGVkZ2UgaW4gdGhlIGlucHV0IGdyYXBoIG11c3QgaGF2ZSBhbiBhc3NpZ25lZCAnbWluTGVuJyBhdHRyaWJ1dGUKICovCmZ1bmN0aW9uIGluaXRSYW5rKGcpIHsKICB2YXIgc29ydGVkID0gdG9wc29ydChnKTsKCiAgc29ydGVkLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgdmFyIGluRWRnZXMgPSBnLmluRWRnZXModSk7CiAgICBpZiAoaW5FZGdlcy5sZW5ndGggPT09IDApIHsKICAgICAgZy5ub2RlKHUpLnJhbmsgPSAwOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIG1pbkxlbnMgPSBpbkVkZ2VzLm1hcChmdW5jdGlvbihlKSB7CiAgICAgIHJldHVybiBnLm5vZGUoZy5zb3VyY2UoZSkpLnJhbmsgKyBnLmVkZ2UoZSkubWluTGVuOwogICAgfSk7CiAgICBnLm5vZGUodSkucmFuayA9IHV0aWwubWF4KG1pbkxlbnMpOwogIH0pOwp9Cgp9LHsiLi4vdXRpbCI6MTcsImdyYXBobGliIjoyNH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7CiAgc2xhY2s6IHNsYWNrCn07CgovKgogKiBBIGhlbHBlciB0byBjYWxjdWxhdGUgdGhlIHNsYWNrIGJldHdlZW4gdHdvIG5vZGVzIChgdWAgYW5kIGB2YCkgZ2l2ZW4gYQogKiBgbWluTGVuYCBjb25zdHJhaW50LiBUaGUgc2xhY2sgcmVwcmVzZW50cyBob3cgbXVjaCB0aGUgZGlzdGFuY2UgYmV0d2VlbiBgdWAKICogYW5kIGB2YCBjb3VsZCBzaHJpbmsgd2hpbGUgbWFpbnRhaW5pbmcgdGhlIGBtaW5MZW5gIGNvbnN0cmFpbnQuIElmIHRoZSB2YWx1ZQogKiBpcyBuZWdhdGl2ZSB0aGVuIHRoZSBjb25zdHJhaW50IGlzIGN1cnJlbnRseSB2aW9sYXRlZC4KICoKICBUaGlzIGZ1bmN0aW9uIHJlcXVpcmVzIHRoYXQgYHVgIGFuZCBgdmAgYXJlIGluIGBncmFwaGAgYW5kIHRoZXkgYm90aCBoYXZlIGEKICBgcmFua2AgYXR0cmlidXRlLgogKi8KZnVuY3Rpb24gc2xhY2soZ3JhcGgsIHUsIHYsIG1pbkxlbikgewogIHJldHVybiBNYXRoLmFicyhncmFwaC5ub2RlKHUpLnJhbmsgLSBncmFwaC5ub2RlKHYpLnJhbmspIC0gbWluTGVuOwp9Cgp9LHt9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpLAogICAgcmFua1V0aWwgPSByZXF1aXJlKCcuL3JhbmtVdGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHNpbXBsZXg7CgpmdW5jdGlvbiBzaW1wbGV4KGdyYXBoLCBzcGFubmluZ1RyZWUpIHsKICAvLyBUaGUgbmV0d29yayBzaW1wbGV4IGFsZ29yaXRobSByZXBlYXRlZGx5IHJlcGxhY2VzIGVkZ2VzIG9mCiAgLy8gdGhlIHNwYW5uaW5nIHRyZWUgd2l0aCBuZWdhdGl2ZSBjdXQgdmFsdWVzIHVudGlsIG5vIHN1Y2gKICAvLyBlZGdlIGV4aXN0cy4KICBpbml0Q3V0VmFsdWVzKGdyYXBoLCBzcGFubmluZ1RyZWUpOwogIHdoaWxlICh0cnVlKSB7CiAgICB2YXIgZSA9IGxlYXZlRWRnZShzcGFubmluZ1RyZWUpOwogICAgaWYgKGUgPT09IG51bGwpIGJyZWFrOwogICAgdmFyIGYgPSBlbnRlckVkZ2UoZ3JhcGgsIHNwYW5uaW5nVHJlZSwgZSk7CiAgICBleGNoYW5nZShncmFwaCwgc3Bhbm5pbmdUcmVlLCBlLCBmKTsKICB9Cn0KCi8qCiAqIFNldCB0aGUgY3V0IHZhbHVlcyBvZiBlZGdlcyBpbiB0aGUgc3Bhbm5pbmcgdHJlZSBieSBhIGRlcHRoLWZpcnN0CiAqIHBvc3RvcmRlciB0cmF2ZXJzYWwuICBUaGUgY3V0IHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBjb3N0LCBpbgogKiB0ZXJtcyBvZiBhIHJhbmtpbmcncyBlZGdlIGxlbmd0aCBzdW0sIG9mIGxlbmd0aGVuaW5nIGFuIGVkZ2UuCiAqIE5lZ2F0aXZlIGN1dCB2YWx1ZXMgdHlwaWNhbGx5IGluZGljYXRlIGVkZ2VzIHRoYXQgd291bGQgeWllbGQgYQogKiBzbWFsbGVyIGVkZ2UgbGVuZ3RoIHN1bSBpZiB0aGV5IHdlcmUgbGVuZ3RoZW5lZC4KICovCmZ1bmN0aW9uIGluaXRDdXRWYWx1ZXMoZ3JhcGgsIHNwYW5uaW5nVHJlZSkgewogIGNvbXB1dGVMb3dMaW0oc3Bhbm5pbmdUcmVlKTsKCiAgc3Bhbm5pbmdUcmVlLmVhY2hFZGdlKGZ1bmN0aW9uKGlkLCB1LCB2LCB0cmVlVmFsdWUpIHsKICAgIHRyZWVWYWx1ZS5jdXRWYWx1ZSA9IDA7CiAgfSk7CgogIC8vIFByb3BhZ2F0ZSBjdXQgdmFsdWVzIHVwIHRoZSB0cmVlLgogIGZ1bmN0aW9uIGRmcyhuKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBzcGFubmluZ1RyZWUuc3VjY2Vzc29ycyhuKTsKICAgIGZvciAodmFyIGMgaW4gY2hpbGRyZW4pIHsKICAgICAgdmFyIGNoaWxkID0gY2hpbGRyZW5bY107CiAgICAgIGRmcyhjaGlsZCk7CiAgICB9CiAgICBpZiAobiAhPT0gc3Bhbm5pbmdUcmVlLmdyYXBoKCkucm9vdCkgewogICAgICBzZXRDdXRWYWx1ZShncmFwaCwgc3Bhbm5pbmdUcmVlLCBuKTsKICAgIH0KICB9CiAgZGZzKHNwYW5uaW5nVHJlZS5ncmFwaCgpLnJvb3QpOwp9CgovKgogKiBQZXJmb3JtIGEgREZTIHBvc3RvcmRlciB0cmF2ZXJzYWwsIGxhYmVsaW5nIGVhY2ggbm9kZSB2IHdpdGgKICogaXRzIHRyYXZlcnNhbCBvcmRlciAnbGltKHYpJyBhbmQgdGhlIG1pbmltdW0gdHJhdmVyc2FsIG51bWJlcgogKiBvZiBhbnkgb2YgaXRzIGRlc2NlbmRhbnRzICdsb3codiknLiAgVGhpcyBwcm92aWRlcyBhbiBlZmZpY2llbnQKICogd2F5IHRvIHRlc3Qgd2hldGhlciB1IGlzIGFuIGFuY2VzdG9yIG9mIHYgc2luY2UKICogbG93KHUpIDw9IGxpbSh2KSA8PSBsaW0odSkgaWYgYW5kIG9ubHkgaWYgdSBpcyBhbiBhbmNlc3Rvci4KICovCmZ1bmN0aW9uIGNvbXB1dGVMb3dMaW0odHJlZSkgewogIHZhciBwb3N0T3JkZXJOdW0gPSAwOwogIAogIGZ1bmN0aW9uIGRmcyhuKSB7CiAgICB2YXIgY2hpbGRyZW4gPSB0cmVlLnN1Y2Nlc3NvcnMobik7CiAgICB2YXIgbG93ID0gcG9zdE9yZGVyTnVtOwogICAgZm9yICh2YXIgYyBpbiBjaGlsZHJlbikgewogICAgICB2YXIgY2hpbGQgPSBjaGlsZHJlbltjXTsKICAgICAgZGZzKGNoaWxkKTsKICAgICAgbG93ID0gTWF0aC5taW4obG93LCB0cmVlLm5vZGUoY2hpbGQpLmxvdyk7CiAgICB9CiAgICB0cmVlLm5vZGUobikubG93ID0gbG93OwogICAgdHJlZS5ub2RlKG4pLmxpbSA9IHBvc3RPcmRlck51bSsrOwogIH0KCiAgZGZzKHRyZWUuZ3JhcGgoKS5yb290KTsKfQoKLyoKICogVG8gY29tcHV0ZSB0aGUgY3V0IHZhbHVlIG9mIHRoZSBlZGdlIHBhcmVudCAtPiBjaGlsZCwgd2UgY29uc2lkZXIKICogaXQgYW5kIGFueSBvdGhlciBncmFwaCBlZGdlcyB0byBvciBmcm9tIHRoZSBjaGlsZC4KICogICAgICAgICAgcGFyZW50CiAqICAgICAgICAgICAgIHwKICogICAgICAgICAgIGNoaWxkCiAqICAgICAgICAgIC8gICAgICBcCiAqICAgICAgICAgdSAgICAgICAgdgogKi8KZnVuY3Rpb24gc2V0Q3V0VmFsdWUoZ3JhcGgsIHRyZWUsIGNoaWxkKSB7CiAgdmFyIHBhcmVudEVkZ2UgPSB0cmVlLmluRWRnZXMoY2hpbGQpWzBdOwoKICAvLyBMaXN0IG9mIGNoaWxkJ3MgY2hpbGRyZW4gaW4gdGhlIHNwYW5uaW5nIHRyZWUuCiAgdmFyIGdyYW5kY2hpbGRyZW4gPSBbXTsKICB2YXIgZ3JhbmRjaGlsZEVkZ2VzID0gdHJlZS5vdXRFZGdlcyhjaGlsZCk7CiAgZm9yICh2YXIgZ2NlIGluIGdyYW5kY2hpbGRFZGdlcykgewogICAgZ3JhbmRjaGlsZHJlbi5wdXNoKHRyZWUudGFyZ2V0KGdyYW5kY2hpbGRFZGdlc1tnY2VdKSk7CiAgfQoKICB2YXIgY3V0VmFsdWUgPSAwOwoKICAvLyBUT0RPOiBSZXBsYWNlIHVuaXQgaW5jcmVtZW50L2RlY3JlbWVudCB3aXRoIGVkZ2Ugd2VpZ2h0cy4KICB2YXIgRSA9IDA7ICAgIC8vIEVkZ2VzIGZyb20gY2hpbGQgdG8gZ3JhbmRjaGlsZCdzIHN1YnRyZWUuCiAgdmFyIEYgPSAwOyAgICAvLyBFZGdlcyB0byBjaGlsZCBmcm9tIGdyYW5kY2hpbGQncyBzdWJ0cmVlLgogIHZhciBHID0gMDsgICAgLy8gRWRnZXMgZnJvbSBjaGlsZCB0byBub2RlcyBvdXRzaWRlIG9mIGNoaWxkJ3Mgc3VidHJlZS4KICB2YXIgSCA9IDA7ICAgIC8vIEVkZ2VzIGZyb20gbm9kZXMgb3V0c2lkZSBvZiBjaGlsZCdzIHN1YnRyZWUgdG8gY2hpbGQuCgogIC8vIENvbnNpZGVyIGFsbCBncmFwaCBlZGdlcyBmcm9tIGNoaWxkLgogIHZhciBvdXRFZGdlcyA9IGdyYXBoLm91dEVkZ2VzKGNoaWxkKTsKICB2YXIgZ2M7CiAgZm9yICh2YXIgb2UgaW4gb3V0RWRnZXMpIHsKICAgIHZhciBzdWNjID0gZ3JhcGgudGFyZ2V0KG91dEVkZ2VzW29lXSk7CiAgICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgICAgaWYgKGluU3VidHJlZSh0cmVlLCBzdWNjLCBncmFuZGNoaWxkcmVuW2djXSkpIHsKICAgICAgICBFKys7CiAgICAgIH0KICAgIH0KICAgIGlmICghaW5TdWJ0cmVlKHRyZWUsIHN1Y2MsIGNoaWxkKSkgewogICAgICBHKys7CiAgICB9CiAgfQoKICAvLyBDb25zaWRlciBhbGwgZ3JhcGggZWRnZXMgdG8gY2hpbGQuCiAgdmFyIGluRWRnZXMgPSBncmFwaC5pbkVkZ2VzKGNoaWxkKTsKICBmb3IgKHZhciBpZSBpbiBpbkVkZ2VzKSB7CiAgICB2YXIgcHJlZCA9IGdyYXBoLnNvdXJjZShpbkVkZ2VzW2llXSk7CiAgICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgICAgaWYgKGluU3VidHJlZSh0cmVlLCBwcmVkLCBncmFuZGNoaWxkcmVuW2djXSkpIHsKICAgICAgICBGKys7CiAgICAgIH0KICAgIH0KICAgIGlmICghaW5TdWJ0cmVlKHRyZWUsIHByZWQsIGNoaWxkKSkgewogICAgICBIKys7CiAgICB9CiAgfQoKICAvLyBDb250cmlidXRpb25zIGRlcGVuZCBvbiB0aGUgYWxpZ25tZW50IG9mIHRoZSBwYXJlbnQgLT4gY2hpbGQgZWRnZQogIC8vIGFuZCB0aGUgY2hpbGQgLT4gdSBvciB2IGVkZ2VzLgogIHZhciBncmFuZGNoaWxkQ3V0U3VtID0gMDsKICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgIHZhciBjdiA9IHRyZWUuZWRnZShncmFuZGNoaWxkRWRnZXNbZ2NdKS5jdXRWYWx1ZTsKICAgIGlmICghdHJlZS5lZGdlKGdyYW5kY2hpbGRFZGdlc1tnY10pLnJldmVyc2VkKSB7CiAgICAgIGdyYW5kY2hpbGRDdXRTdW0gKz0gY3Y7CiAgICB9IGVsc2UgewogICAgICBncmFuZGNoaWxkQ3V0U3VtIC09IGN2OwogICAgfQogIH0KCiAgaWYgKCF0cmVlLmVkZ2UocGFyZW50RWRnZSkucmV2ZXJzZWQpIHsKICAgIGN1dFZhbHVlICs9IGdyYW5kY2hpbGRDdXRTdW0gLSBFICsgRiAtIEcgKyBIOwogIH0gZWxzZSB7CiAgICBjdXRWYWx1ZSAtPSBncmFuZGNoaWxkQ3V0U3VtIC0gRSArIEYgLSBHICsgSDsKICB9CgogIHRyZWUuZWRnZShwYXJlbnRFZGdlKS5jdXRWYWx1ZSA9IGN1dFZhbHVlOwp9CgovKgogKiBSZXR1cm4gd2hldGhlciBuIGlzIGEgbm9kZSBpbiB0aGUgc3VidHJlZSB3aXRoIHRoZSBnaXZlbgogKiByb290LgogKi8KZnVuY3Rpb24gaW5TdWJ0cmVlKHRyZWUsIG4sIHJvb3QpIHsKICByZXR1cm4gKHRyZWUubm9kZShyb290KS5sb3cgPD0gdHJlZS5ub2RlKG4pLmxpbSAmJgogICAgICAgICAgdHJlZS5ub2RlKG4pLmxpbSA8PSB0cmVlLm5vZGUocm9vdCkubGltKTsKfQoKLyoKICogUmV0dXJuIGFuIGVkZ2UgZnJvbSB0aGUgdHJlZSB3aXRoIGEgbmVnYXRpdmUgY3V0IHZhbHVlLCBvciBudWxsIGlmIHRoZXJlCiAqIGlzIG5vbmUuCiAqLwpmdW5jdGlvbiBsZWF2ZUVkZ2UodHJlZSkgewogIHZhciBlZGdlcyA9IHRyZWUuZWRnZXMoKTsKICBmb3IgKHZhciBuIGluIGVkZ2VzKSB7CiAgICB2YXIgZSA9IGVkZ2VzW25dOwogICAgdmFyIHRyZWVWYWx1ZSA9IHRyZWUuZWRnZShlKTsKICAgIGlmICh0cmVlVmFsdWUuY3V0VmFsdWUgPCAwKSB7CiAgICAgIHJldHVybiBlOwogICAgfQogIH0KICByZXR1cm4gbnVsbDsKfQoKLyoKICogVGhlIGVkZ2UgZSBzaG91bGQgYmUgYW4gZWRnZSBpbiB0aGUgdHJlZSwgd2l0aCBhbiB1bmRlcmx5aW5nIGVkZ2UKICogaW4gdGhlIGdyYXBoLCB3aXRoIGEgbmVnYXRpdmUgY3V0IHZhbHVlLiAgT2YgdGhlIHR3byBub2RlcyBpbmNpZGVudAogKiBvbiB0aGUgZWRnZSwgdGFrZSB0aGUgbG93ZXIgb25lLiAgZW50ZXJFZGdlIHJldHVybnMgYW4gZWRnZSB3aXRoCiAqIG1pbmltdW0gc2xhY2sgZ29pbmcgZnJvbSBvdXRzaWRlIG9mIHRoYXQgbm9kZSdzIHN1YnRyZWUgdG8gaW5zaWRlCiAqIG9mIHRoYXQgbm9kZSdzIHN1YnRyZWUuCiAqLwpmdW5jdGlvbiBlbnRlckVkZ2UoZ3JhcGgsIHRyZWUsIGUpIHsKICB2YXIgc291cmNlID0gdHJlZS5zb3VyY2UoZSk7CiAgdmFyIHRhcmdldCA9IHRyZWUudGFyZ2V0KGUpOwogIHZhciBsb3dlciA9IHRyZWUubm9kZSh0YXJnZXQpLmxpbSA8IHRyZWUubm9kZShzb3VyY2UpLmxpbSA/IHRhcmdldCA6IHNvdXJjZTsKCiAgLy8gSXMgdGhlIHRyZWUgZWRnZSBhbGlnbmVkIHdpdGggdGhlIGdyYXBoIGVkZ2U/CiAgdmFyIGFsaWduZWQgPSAhdHJlZS5lZGdlKGUpLnJldmVyc2VkOwoKICB2YXIgbWluU2xhY2sgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgdmFyIG1pblNsYWNrRWRnZTsKICBpZiAoYWxpZ25lZCkgewogICAgZ3JhcGguZWFjaEVkZ2UoZnVuY3Rpb24oaWQsIHUsIHYsIHZhbHVlKSB7CiAgICAgIGlmIChpZCAhPT0gZSAmJiBpblN1YnRyZWUodHJlZSwgdSwgbG93ZXIpICYmICFpblN1YnRyZWUodHJlZSwgdiwgbG93ZXIpKSB7CiAgICAgICAgdmFyIHNsYWNrID0gcmFua1V0aWwuc2xhY2soZ3JhcGgsIHUsIHYsIHZhbHVlLm1pbkxlbik7CiAgICAgICAgaWYgKHNsYWNrIDwgbWluU2xhY2spIHsKICAgICAgICAgIG1pblNsYWNrID0gc2xhY2s7CiAgICAgICAgICBtaW5TbGFja0VkZ2UgPSBpZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBncmFwaC5lYWNoRWRnZShmdW5jdGlvbihpZCwgdSwgdiwgdmFsdWUpIHsKICAgICAgaWYgKGlkICE9PSBlICYmICFpblN1YnRyZWUodHJlZSwgdSwgbG93ZXIpICYmIGluU3VidHJlZSh0cmVlLCB2LCBsb3dlcikpIHsKICAgICAgICB2YXIgc2xhY2sgPSByYW5rVXRpbC5zbGFjayhncmFwaCwgdSwgdiwgdmFsdWUubWluTGVuKTsKICAgICAgICBpZiAoc2xhY2sgPCBtaW5TbGFjaykgewogICAgICAgICAgbWluU2xhY2sgPSBzbGFjazsKICAgICAgICAgIG1pblNsYWNrRWRnZSA9IGlkOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAobWluU2xhY2tFZGdlID09PSB1bmRlZmluZWQpIHsKICAgIHZhciBvdXRzaWRlID0gW107CiAgICB2YXIgaW5zaWRlID0gW107CiAgICBncmFwaC5lYWNoTm9kZShmdW5jdGlvbihpZCkgewogICAgICBpZiAoIWluU3VidHJlZSh0cmVlLCBpZCwgbG93ZXIpKSB7CiAgICAgICAgb3V0c2lkZS5wdXNoKGlkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnNpZGUucHVzaChpZCk7CiAgICAgIH0KICAgIH0pOwogICAgdGhyb3cgbmV3IEVycm9yKCdObyBlZGdlIGZvdW5kIGZyb20gb3V0c2lkZSBvZiB0cmVlIHRvIGluc2lkZScpOwogIH0KCiAgcmV0dXJuIG1pblNsYWNrRWRnZTsKfQoKLyoKICogUmVwbGFjZSBlZGdlIGUgd2l0aCBlZGdlIGYgaW4gdGhlIHRyZWUsIHJlY2FsY3VsYXRpbmcgdGhlIHRyZWUgcm9vdCwKICogdGhlIG5vZGVzJyBsb3cgYW5kIGxpbSBwcm9wZXJ0aWVzIGFuZCB0aGUgZWRnZXMnIGN1dCB2YWx1ZXMuCiAqLwpmdW5jdGlvbiBleGNoYW5nZShncmFwaCwgdHJlZSwgZSwgZikgewogIHRyZWUuZGVsRWRnZShlKTsKICB2YXIgc291cmNlID0gZ3JhcGguc291cmNlKGYpOwogIHZhciB0YXJnZXQgPSBncmFwaC50YXJnZXQoZik7CgogIC8vIFJlZGlyZWN0IGVkZ2VzIHNvIHRoYXQgdGFyZ2V0IGlzIHRoZSByb290IG9mIGl0cyBzdWJ0cmVlLgogIGZ1bmN0aW9uIHJlZGlyZWN0KHYpIHsKICAgIHZhciBlZGdlcyA9IHRyZWUuaW5FZGdlcyh2KTsKICAgIGZvciAodmFyIGkgaW4gZWRnZXMpIHsKICAgICAgdmFyIGUgPSBlZGdlc1tpXTsKICAgICAgdmFyIHUgPSB0cmVlLnNvdXJjZShlKTsKICAgICAgdmFyIHZhbHVlID0gdHJlZS5lZGdlKGUpOwogICAgICByZWRpcmVjdCh1KTsKICAgICAgdHJlZS5kZWxFZGdlKGUpOwogICAgICB2YWx1ZS5yZXZlcnNlZCA9ICF2YWx1ZS5yZXZlcnNlZDsKICAgICAgdHJlZS5hZGRFZGdlKGUsIHYsIHUsIHZhbHVlKTsKICAgIH0KICB9CgogIHJlZGlyZWN0KHRhcmdldCk7CgogIHZhciByb290ID0gc291cmNlOwogIHZhciBlZGdlcyA9IHRyZWUuaW5FZGdlcyhyb290KTsKICB3aGlsZSAoZWRnZXMubGVuZ3RoID4gMCkgewogICAgcm9vdCA9IHRyZWUuc291cmNlKGVkZ2VzWzBdKTsKICAgIGVkZ2VzID0gdHJlZS5pbkVkZ2VzKHJvb3QpOwogIH0KCiAgdHJlZS5ncmFwaCgpLnJvb3QgPSByb290OwoKICB0cmVlLmFkZEVkZ2UobnVsbCwgc291cmNlLCB0YXJnZXQsIHtjdXRWYWx1ZTogMH0pOwoKICBpbml0Q3V0VmFsdWVzKGdyYXBoLCB0cmVlKTsKCiAgYWRqdXN0UmFua3MoZ3JhcGgsIHRyZWUpOwp9CgovKgogKiBSZXNldCB0aGUgcmFua3Mgb2YgYWxsIG5vZGVzIGJhc2VkIG9uIHRoZSBjdXJyZW50IHNwYW5uaW5nIHRyZWUuCiAqIFRoZSByYW5rIG9mIHRoZSB0cmVlJ3Mgcm9vdCByZW1haW5zIHVuY2hhbmdlZCwgd2hpbGUgYWxsIG90aGVyCiAqIG5vZGVzIGFyZSBzZXQgdG8gdGhlIHN1bSBvZiBtaW5pbXVtIGxlbmd0aCBjb25zdHJhaW50cyBhbG9uZwogKiB0aGUgcGF0aCBmcm9tIHRoZSByb290LgogKi8KZnVuY3Rpb24gYWRqdXN0UmFua3MoZ3JhcGgsIHRyZWUpIHsKICBmdW5jdGlvbiBkZnMocCkgewogICAgdmFyIGNoaWxkcmVuID0gdHJlZS5zdWNjZXNzb3JzKHApOwogICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjKSB7CiAgICAgIHZhciBtaW5MZW4gPSBtaW5pbXVtTGVuZ3RoKGdyYXBoLCBwLCBjKTsKICAgICAgZ3JhcGgubm9kZShjKS5yYW5rID0gZ3JhcGgubm9kZShwKS5yYW5rICsgbWluTGVuOwogICAgICBkZnMoYyk7CiAgICB9KTsKICB9CgogIGRmcyh0cmVlLmdyYXBoKCkucm9vdCk7Cn0KCi8qCiAqIElmIHUgYW5kIHYgYXJlIGNvbm5lY3RlZCBieSBzb21lIGVkZ2VzIGluIHRoZSBncmFwaCwgcmV0dXJuIHRoZQogKiBtaW5pbXVtIGxlbmd0aCBvZiB0aG9zZSBlZGdlcywgYXMgYSBwb3NpdGl2ZSBudW1iZXIgaWYgdiBzdWNjZWVkcwogKiB1IGFuZCBhcyBhIG5lZ2F0aXZlIG51bWJlciBpZiB2IHByZWNlZGVzIHUuCiAqLwpmdW5jdGlvbiBtaW5pbXVtTGVuZ3RoKGdyYXBoLCB1LCB2KSB7CiAgdmFyIG91dEVkZ2VzID0gZ3JhcGgub3V0RWRnZXModSwgdik7CiAgaWYgKG91dEVkZ2VzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiB1dGlsLm1heChvdXRFZGdlcy5tYXAoZnVuY3Rpb24oZSkgewogICAgICByZXR1cm4gZ3JhcGguZWRnZShlKS5taW5MZW47CiAgICB9KSk7CiAgfQoKICB2YXIgaW5FZGdlcyA9IGdyYXBoLmluRWRnZXModSwgdik7CiAgaWYgKGluRWRnZXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIC11dGlsLm1heChpbkVkZ2VzLm1hcChmdW5jdGlvbihlKSB7CiAgICAgIHJldHVybiBncmFwaC5lZGdlKGUpLm1pbkxlbjsKICAgIH0pKTsKICB9Cn0KCn0seyIuLi91dGlsIjoxNywiLi9yYW5rVXRpbCI6MTV9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qCiAqIFJldHVybnMgdGhlIHNtYWxsZXN0IHZhbHVlIGluIHRoZSBhcnJheS4KICovCmV4cG9ydHMubWluID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHZhbHVlcyk7Cn07CgovKgogKiBSZXR1cm5zIHRoZSBsYXJnZXN0IHZhbHVlIGluIHRoZSBhcnJheS4KICovCmV4cG9ydHMubWF4ID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlcyk7Cn07CgovKgogKiBSZXR1cm5zIGB0cnVlYCBvbmx5IGlmIGBmKHgpYCBpcyBgdHJ1ZWAgZm9yIGFsbCBgeGAgaW4gYHhzYC4gT3RoZXJ3aXNlCiAqIHJldHVybnMgYGZhbHNlYC4gVGhpcyBmdW5jdGlvbiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBpdCBmaW5kcyBhCiAqIGNhc2Ugd2hlcmUgYGYoeClgIGRvZXMgbm90IGhvbGQuCiAqLwpleHBvcnRzLmFsbCA9IGZ1bmN0aW9uKHhzLCBmKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB4cy5sZW5ndGg7ICsraSkgewogICAgaWYgKCFmKHhzW2ldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9OwoKLyoKICogQWNjdW11bGF0ZXMgdGhlIHN1bSBvZiBlbGVtZW50cyBpbiB0aGUgZ2l2ZW4gYXJyYXkgdXNpbmcgdGhlIGArYCBvcGVyYXRvci4KICovCmV4cG9ydHMuc3VtID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIHZhbHVlcy5yZWR1Y2UoZnVuY3Rpb24oYWNjLCB4KSB7IHJldHVybiBhY2MgKyB4OyB9LCAwKTsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgYWxsIHZhbHVlcyBpbiB0aGUgZ2l2ZW4gb2JqZWN0LgogKi8KZXhwb3J0cy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5tYXAoZnVuY3Rpb24oaykgeyByZXR1cm4gb2JqW2tdOyB9KTsKfTsKCmV4cG9ydHMuc2h1ZmZsZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgZm9yIChpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+IDA7IC0taSkgewogICAgdmFyIGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaSArIDEpKTsKICAgIHZhciBhaiA9IGFycmF5W2pdOwogICAgYXJyYXlbal0gPSBhcnJheVtpXTsKICAgIGFycmF5W2ldID0gYWo7CiAgfQp9OwoKZXhwb3J0cy5wcm9wZXJ0eUFjY2Vzc29yID0gZnVuY3Rpb24oc2VsZiwgY29uZmlnLCBmaWVsZCwgc2V0SG9vaykgewogIHJldHVybiBmdW5jdGlvbih4KSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBjb25maWdbZmllbGRdOwogICAgY29uZmlnW2ZpZWxkXSA9IHg7CiAgICBpZiAoc2V0SG9vaykgc2V0SG9vayh4KTsKICAgIHJldHVybiBzZWxmOwogIH07Cn07CgovKgogKiBHaXZlbiBhIGxheWVyZWQsIGRpcmVjdGVkIGdyYXBoIHdpdGggYHJhbmtgIGFuZCBgb3JkZXJgIG5vZGUgYXR0cmlidXRlcywKICogdGhpcyBmdW5jdGlvbiByZXR1cm5zIGFuIGFycmF5IG9mIG9yZGVyZWQgcmFua3MuIEVhY2ggcmFuayBjb250YWlucyBhbiBhcnJheQogKiBvZiB0aGUgaWRzIG9mIHRoZSBub2RlcyBpbiB0aGF0IHJhbmsgaW4gdGhlIG9yZGVyIHNwZWNpZmllZCBieSB0aGUgYG9yZGVyYAogKiBhdHRyaWJ1dGUuCiAqLwpleHBvcnRzLm9yZGVyaW5nID0gZnVuY3Rpb24oZykgewogIHZhciBvcmRlcmluZyA9IFtdOwogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIHZhciByYW5rID0gb3JkZXJpbmdbdmFsdWUucmFua10gfHwgKG9yZGVyaW5nW3ZhbHVlLnJhbmtdID0gW10pOwogICAgcmFua1t2YWx1ZS5vcmRlcl0gPSB1OwogIH0pOwogIHJldHVybiBvcmRlcmluZzsKfTsKCi8qCiAqIEEgZmlsdGVyIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBgZmlsdGVyTm9kZXNgIHRvIGdldCBhIGdyYXBoIHRoYXQgb25seQogKiBpbmNsdWRlcyBub2RlcyB0aGF0IGRvIG5vdCBjb250YWluIG90aGVycyBub2Rlcy4KICovCmV4cG9ydHMuZmlsdGVyTm9uU3ViZ3JhcGhzID0gZnVuY3Rpb24oZykgewogIHJldHVybiBmdW5jdGlvbih1KSB7CiAgICByZXR1cm4gZy5jaGlsZHJlbih1KS5sZW5ndGggPT09IDA7CiAgfTsKfTsKCi8qCiAqIFJldHVybnMgYSBuZXcgZnVuY3Rpb24gdGhhdCB3cmFwcyBgZnVuY2Agd2l0aCBhIHRpbWVyLiBUaGUgd3JhcHBlciBsb2dzIHRoZQogKiB0aW1lIGl0IHRha2VzIHRvIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uLgogKgogKiBUaGUgdGltZXIgd2lsbCBiZSBlbmFibGVkIHByb3ZpZGVkIGBsb2cubGV2ZWwgPj0gMWAuCiAqLwpmdW5jdGlvbiB0aW1lKG5hbWUsIGZ1bmMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9IGZpbmFsbHkgewogICAgICBsb2coMSwgbmFtZSArICcgdGltZTogJyArIChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHN0YXJ0KSArICdtcycpOwogICAgfQogIH07Cn0KdGltZS5lbmFibGVkID0gZmFsc2U7CgpleHBvcnRzLnRpbWUgPSB0aW1lOwoKLyoKICogQSBnbG9iYWwgbG9nZ2VyIHdpdGggdGhlIHNwZWNpZmljYXRpb24gYGxvZyhsZXZlbCwgbWVzc2FnZSwgLi4uKWAgdGhhdAogKiB3aWxsIGxvZyBhIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUgaWYgYGxvZy5sZXZlbCA+PSBsZXZlbGAuCiAqLwpmdW5jdGlvbiBsb2cobGV2ZWwpIHsKICBpZiAobG9nLmxldmVsID49IGxldmVsKSB7CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9Cn0KbG9nLmxldmVsID0gMDsKCmV4cG9ydHMubG9nID0gbG9nOwoKfSx7fV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9ICcwLjQuNSc7Cgp9LHt9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMuU2V0ID0gcmVxdWlyZSgnLi9saWIvU2V0Jyk7CmV4cG9ydHMuUHJpb3JpdHlRdWV1ZSA9IHJlcXVpcmUoJy4vbGliL1ByaW9yaXR5UXVldWUnKTsKZXhwb3J0cy52ZXJzaW9uID0gcmVxdWlyZSgnLi9saWIvdmVyc2lvbicpOwoKfSx7Ii4vbGliL1ByaW9yaXR5UXVldWUiOjIwLCIuL2xpYi9TZXQiOjIxLCIuL2xpYi92ZXJzaW9uIjoyM31dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSBQcmlvcml0eVF1ZXVlOwoKLyoqCiAqIEEgbWluLXByaW9yaXR5IHF1ZXVlIGRhdGEgc3RydWN0dXJlLiBUaGlzIGFsZ29yaXRobSBpcyBkZXJpdmVkIGZyb20gQ29ybWVuLAogKiBldCBhbC4sICJJbnRyb2R1Y3Rpb24gdG8gQWxnb3JpdGhtcyIuIFRoZSBiYXNpYyBpZGVhIG9mIGEgbWluLXByaW9yaXR5CiAqIHF1ZXVlIGlzIHRoYXQgeW91IGNhbiBlZmZpY2llbnRseSAoaW4gTygxKSB0aW1lKSBnZXQgdGhlIHNtYWxsZXN0IGtleSBpbgogKiB0aGUgcXVldWUuIEFkZGluZyBhbmQgcmVtb3ZpbmcgZWxlbWVudHMgdGFrZXMgTyhsb2cgbikgdGltZS4gQSBrZXkgY2FuCiAqIGhhdmUgaXRzIHByaW9yaXR5IGRlY3JlYXNlZCBpbiBPKGxvZyBuKSB0aW1lLgogKi8KZnVuY3Rpb24gUHJpb3JpdHlRdWV1ZSgpIHsKICB0aGlzLl9hcnIgPSBbXTsKICB0aGlzLl9rZXlJbmRpY2VzID0ge307Cn0KCi8qKgogKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIHF1ZXVlLiBUYWtlcyBgTygxKWAgdGltZS4KICovClByaW9yaXR5UXVldWUucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fYXJyLmxlbmd0aDsKfTsKCi8qKgogKiBSZXR1cm5zIHRoZSBrZXlzIHRoYXQgYXJlIGluIHRoZSBxdWV1ZS4gVGFrZXMgYE8obilgIHRpbWUuCiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2Fyci5tYXAoZnVuY3Rpb24oeCkgeyByZXR1cm4geC5rZXk7IH0pOwp9OwoKLyoqCiAqIFJldHVybnMgYHRydWVgIGlmICoqa2V5KiogaXMgaW4gdGhlIHF1ZXVlIGFuZCBgZmFsc2VgIGlmIG5vdC4KICovClByaW9yaXR5UXVldWUucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uKGtleSkgewogIHJldHVybiBrZXkgaW4gdGhpcy5fa2V5SW5kaWNlczsKfTsKCi8qKgogKiBSZXR1cm5zIHRoZSBwcmlvcml0eSBmb3IgKiprZXkqKi4gSWYgKiprZXkqKiBpcyBub3QgcHJlc2VudCBpbiB0aGUgcXVldWUKICogdGhlbiB0aGlzIGZ1bmN0aW9uIHJldHVybnMgYHVuZGVmaW5lZGAuIFRha2VzIGBPKDEpYCB0aW1lLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5CiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5wcmlvcml0eSA9IGZ1bmN0aW9uKGtleSkgewogIHZhciBpbmRleCA9IHRoaXMuX2tleUluZGljZXNba2V5XTsKICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIHRoaXMuX2FycltpbmRleF0ucHJpb3JpdHk7CiAgfQp9OwoKLyoqCiAqIFJldHVybnMgdGhlIGtleSBmb3IgdGhlIG1pbmltdW0gZWxlbWVudCBpbiB0aGlzIHF1ZXVlLiBJZiB0aGUgcXVldWUgaXMKICogZW1wdHkgdGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUubWluID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuc2l6ZSgpID09PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlF1ZXVlIHVuZGVyZmxvdyIpOwogIH0KICByZXR1cm4gdGhpcy5fYXJyWzBdLmtleTsKfTsKCi8qKgogKiBJbnNlcnRzIGEgbmV3IGtleSBpbnRvIHRoZSBwcmlvcml0eSBxdWV1ZS4gSWYgdGhlIGtleSBhbHJlYWR5IGV4aXN0cyBpbgogKiB0aGUgcXVldWUgdGhpcyBmdW5jdGlvbiByZXR1cm5zIGBmYWxzZWA7IG90aGVyd2lzZSBpdCB3aWxsIHJldHVybiBgdHJ1ZWAuCiAqIFRha2VzIGBPKG4pYCB0aW1lLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5IHRoZSBrZXkgdG8gYWRkCiAqIEBwYXJhbSB7TnVtYmVyfSBwcmlvcml0eSB0aGUgaW5pdGlhbCBwcmlvcml0eSBmb3IgdGhlIGtleQogKi8KUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oa2V5LCBwcmlvcml0eSkgewogIHZhciBrZXlJbmRpY2VzID0gdGhpcy5fa2V5SW5kaWNlczsKICBpZiAoIShrZXkgaW4ga2V5SW5kaWNlcykpIHsKICAgIHZhciBhcnIgPSB0aGlzLl9hcnI7CiAgICB2YXIgaW5kZXggPSBhcnIubGVuZ3RoOwogICAga2V5SW5kaWNlc1trZXldID0gaW5kZXg7CiAgICBhcnIucHVzaCh7a2V5OiBrZXksIHByaW9yaXR5OiBwcmlvcml0eX0pOwogICAgdGhpcy5fZGVjcmVhc2UoaW5kZXgpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCi8qKgogKiBSZW1vdmVzIGFuZCByZXR1cm5zIHRoZSBzbWFsbGVzdCBrZXkgaW4gdGhlIHF1ZXVlLiBUYWtlcyBgTyhsb2cgbilgIHRpbWUuCiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5yZW1vdmVNaW4gPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zd2FwKDAsIHRoaXMuX2Fyci5sZW5ndGggLSAxKTsKICB2YXIgbWluID0gdGhpcy5fYXJyLnBvcCgpOwogIGRlbGV0ZSB0aGlzLl9rZXlJbmRpY2VzW21pbi5rZXldOwogIHRoaXMuX2hlYXBpZnkoMCk7CiAgcmV0dXJuIG1pbi5rZXk7Cn07CgovKioKICogRGVjcmVhc2VzIHRoZSBwcmlvcml0eSBmb3IgKiprZXkqKiB0byAqKnByaW9yaXR5KiouIElmIHRoZSBuZXcgcHJpb3JpdHkgaXMKICogZ3JlYXRlciB0aGFuIHRoZSBwcmV2aW91cyBwcmlvcml0eSwgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5IHRoZSBrZXkgZm9yIHdoaWNoIHRvIHJhaXNlIHByaW9yaXR5CiAqIEBwYXJhbSB7TnVtYmVyfSBwcmlvcml0eSB0aGUgbmV3IHByaW9yaXR5IGZvciB0aGUga2V5CiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5kZWNyZWFzZSA9IGZ1bmN0aW9uKGtleSwgcHJpb3JpdHkpIHsKICB2YXIgaW5kZXggPSB0aGlzLl9rZXlJbmRpY2VzW2tleV07CiAgaWYgKHByaW9yaXR5ID4gdGhpcy5fYXJyW2luZGV4XS5wcmlvcml0eSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOZXcgcHJpb3JpdHkgaXMgZ3JlYXRlciB0aGFuIGN1cnJlbnQgcHJpb3JpdHkuICIgKwogICAgICAgICJLZXk6ICIgKyBrZXkgKyAiIE9sZDogIiArIHRoaXMuX2FycltpbmRleF0ucHJpb3JpdHkgKyAiIE5ldzogIiArIHByaW9yaXR5KTsKICB9CiAgdGhpcy5fYXJyW2luZGV4XS5wcmlvcml0eSA9IHByaW9yaXR5OwogIHRoaXMuX2RlY3JlYXNlKGluZGV4KTsKfTsKClByaW9yaXR5UXVldWUucHJvdG90eXBlLl9oZWFwaWZ5ID0gZnVuY3Rpb24oaSkgewogIHZhciBhcnIgPSB0aGlzLl9hcnI7CiAgdmFyIGwgPSAyICogaSwKICAgICAgciA9IGwgKyAxLAogICAgICBsYXJnZXN0ID0gaTsKICBpZiAobCA8IGFyci5sZW5ndGgpIHsKICAgIGxhcmdlc3QgPSBhcnJbbF0ucHJpb3JpdHkgPCBhcnJbbGFyZ2VzdF0ucHJpb3JpdHkgPyBsIDogbGFyZ2VzdDsKICAgIGlmIChyIDwgYXJyLmxlbmd0aCkgewogICAgICBsYXJnZXN0ID0gYXJyW3JdLnByaW9yaXR5IDwgYXJyW2xhcmdlc3RdLnByaW9yaXR5ID8gciA6IGxhcmdlc3Q7CiAgICB9CiAgICBpZiAobGFyZ2VzdCAhPT0gaSkgewogICAgICB0aGlzLl9zd2FwKGksIGxhcmdlc3QpOwogICAgICB0aGlzLl9oZWFwaWZ5KGxhcmdlc3QpOwogICAgfQogIH0KfTsKClByaW9yaXR5UXVldWUucHJvdG90eXBlLl9kZWNyZWFzZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgdmFyIGFyciA9IHRoaXMuX2FycjsKICB2YXIgcHJpb3JpdHkgPSBhcnJbaW5kZXhdLnByaW9yaXR5OwogIHZhciBwYXJlbnQ7CiAgd2hpbGUgKGluZGV4ICE9PSAwKSB7CiAgICBwYXJlbnQgPSBpbmRleCA+PiAxOwogICAgaWYgKGFycltwYXJlbnRdLnByaW9yaXR5IDwgcHJpb3JpdHkpIHsKICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl9zd2FwKGluZGV4LCBwYXJlbnQpOwogICAgaW5kZXggPSBwYXJlbnQ7CiAgfQp9OwoKUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUuX3N3YXAgPSBmdW5jdGlvbihpLCBqKSB7CiAgdmFyIGFyciA9IHRoaXMuX2FycjsKICB2YXIga2V5SW5kaWNlcyA9IHRoaXMuX2tleUluZGljZXM7CiAgdmFyIG9yaWdBcnJJID0gYXJyW2ldOwogIHZhciBvcmlnQXJySiA9IGFycltqXTsKICBhcnJbaV0gPSBvcmlnQXJySjsKICBhcnJbal0gPSBvcmlnQXJySTsKICBrZXlJbmRpY2VzW29yaWdBcnJKLmtleV0gPSBpOwogIGtleUluZGljZXNbb3JpZ0Fyckkua2V5XSA9IGo7Cn07Cgp9LHt9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IFNldDsKCi8qKgogKiBDb25zdHJ1Y3RzIGEgbmV3IFNldCB3aXRoIGFuIG9wdGlvbmFsIHNldCBvZiBgaW5pdGlhbEtleXNgLgogKgogKiBJdCBpcyBpbXBvcnRhbnQgdG8gbm90ZSB0aGF0IGtleXMgYXJlIGNvZXJjZWQgdG8gU3RyaW5nIGZvciBtb3N0IHB1cnBvc2VzCiAqIHdpdGggdGhpcyBvYmplY3QsIHNpbWlsYXIgdG8gdGhlIGJlaGF2aW9yIG9mIEphdmFTY3JpcHQncyBPYmplY3QuIEZvcgogKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHdpbGwgYWRkIG9ubHkgb25lIGtleToKICoKICogICAgIHZhciBzID0gbmV3IFNldCgpOwogKiAgICAgcy5hZGQoMSk7CiAqICAgICBzLmFkZCgiMSIpOwogKgogKiBIb3dldmVyLCB0aGUgdHlwZSBvZiB0aGUga2V5IGlzIHByZXNlcnZlZCBpbnRlcm5hbGx5IHNvIHRoYXQgYGtleXNgIHJldHVybnMKICogdGhlIG9yaWdpbmFsIGtleSBzZXQgdW5jb2VyY2VkLiBGb3IgdGhlIGFib3ZlIGV4YW1wbGUsIGBrZXlzYCB3b3VsZCByZXR1cm4KICogYFsxXWAuCiAqLwpmdW5jdGlvbiBTZXQoaW5pdGlhbEtleXMpIHsKICB0aGlzLl9zaXplID0gMDsKICB0aGlzLl9rZXlzID0ge307CgogIGlmIChpbml0aWFsS2V5cykgewogICAgZm9yICh2YXIgaSA9IDAsIGlsID0gaW5pdGlhbEtleXMubGVuZ3RoOyBpIDwgaWw7ICsraSkgewogICAgICB0aGlzLmFkZChpbml0aWFsS2V5c1tpXSk7CiAgICB9CiAgfQp9CgovKioKICogUmV0dXJucyBhIG5ldyBTZXQgdGhhdCByZXByZXNlbnRzIHRoZSBzZXQgaW50ZXJzZWN0aW9uIG9mIHRoZSBhcnJheSBvZiBnaXZlbgogKiBzZXRzLgogKi8KU2V0LmludGVyc2VjdCA9IGZ1bmN0aW9uKHNldHMpIHsKICBpZiAoc2V0cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBuZXcgU2V0KCk7CiAgfQoKICB2YXIgcmVzdWx0ID0gbmV3IFNldCghdXRpbC5pc0FycmF5KHNldHNbMF0pID8gc2V0c1swXS5rZXlzKCkgOiBzZXRzWzBdKTsKICBmb3IgKHZhciBpID0gMSwgaWwgPSBzZXRzLmxlbmd0aDsgaSA8IGlsOyArK2kpIHsKICAgIHZhciByZXN1bHRLZXlzID0gcmVzdWx0LmtleXMoKSwKICAgICAgICBvdGhlciA9ICF1dGlsLmlzQXJyYXkoc2V0c1tpXSkgPyBzZXRzW2ldIDogbmV3IFNldChzZXRzW2ldKTsKICAgIGZvciAodmFyIGogPSAwLCBqbCA9IHJlc3VsdEtleXMubGVuZ3RoOyBqIDwgamw7ICsraikgewogICAgICB2YXIga2V5ID0gcmVzdWx0S2V5c1tqXTsKICAgICAgaWYgKCFvdGhlci5oYXMoa2V5KSkgewogICAgICAgIHJlc3VsdC5yZW1vdmUoa2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBSZXR1cm5zIGEgbmV3IFNldCB0aGF0IHJlcHJlc2VudHMgdGhlIHNldCB1bmlvbiBvZiB0aGUgYXJyYXkgb2YgZ2l2ZW4gc2V0cy4KICovClNldC51bmlvbiA9IGZ1bmN0aW9uKHNldHMpIHsKICB2YXIgdG90YWxFbGVtcyA9IHV0aWwucmVkdWNlKHNldHMsIGZ1bmN0aW9uKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzICsgKHJocy5zaXplID8gcmhzLnNpemUoKSA6IHJocy5sZW5ndGgpOwogIH0sIDApOwogIHZhciBhcnIgPSBuZXcgQXJyYXkodG90YWxFbGVtcyk7CgogIHZhciBrID0gMDsKICBmb3IgKHZhciBpID0gMCwgaWwgPSBzZXRzLmxlbmd0aDsgaSA8IGlsOyArK2kpIHsKICAgIHZhciBjdXIgPSBzZXRzW2ldLAogICAgICAgIGtleXMgPSAhdXRpbC5pc0FycmF5KGN1cikgPyBjdXIua2V5cygpIDogY3VyOwogICAgZm9yICh2YXIgaiA9IDAsIGpsID0ga2V5cy5sZW5ndGg7IGogPCBqbDsgKytqKSB7CiAgICAgIGFycltrKytdID0ga2V5c1tqXTsKICAgIH0KICB9CgogIHJldHVybiBuZXcgU2V0KGFycik7Cn07CgovKioKICogUmV0dXJucyB0aGUgc2l6ZSBvZiB0aGlzIHNldCBpbiBgTygxKWAgdGltZS4KICovClNldC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9zaXplOwp9OwoKLyoqCiAqIFJldHVybnMgdGhlIGtleXMgaW4gdGhpcyBzZXQuIFRha2VzIGBPKG4pYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHZhbHVlcyh0aGlzLl9rZXlzKTsKfTsKCi8qKgogKiBUZXN0cyBpZiBhIGtleSBpcyBwcmVzZW50IGluIHRoaXMgU2V0LiBSZXR1cm5zIGB0cnVlYCBpZiBpdCBpcyBhbmQgYGZhbHNlYAogKiBpZiBub3QuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbihrZXkpIHsKICByZXR1cm4ga2V5IGluIHRoaXMuX2tleXM7Cn07CgovKioKICogQWRkcyBhIG5ldyBrZXkgdG8gdGhpcyBTZXQgaWYgaXQgaXMgbm90IGFscmVhZHkgcHJlc2VudC4gUmV0dXJucyBgdHJ1ZWAgaWYKICogdGhlIGtleSB3YXMgYWRkZWQgYW5kIGBmYWxzZWAgaWYgaXQgd2FzIGFscmVhZHkgcHJlc2VudC4gVGFrZXMgYE8oMSlgIHRpbWUuCiAqLwpTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uKGtleSkgewogIGlmICghKGtleSBpbiB0aGlzLl9rZXlzKSkgewogICAgdGhpcy5fa2V5c1trZXldID0ga2V5OwogICAgKyt0aGlzLl9zaXplOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCi8qKgogKiBSZW1vdmVzIGEga2V5IGZyb20gdGhpcyBTZXQuIElmIHRoZSBrZXkgd2FzIHJlbW92ZWQgdGhpcyBmdW5jdGlvbiByZXR1cm5zCiAqIGB0cnVlYC4gSWYgbm90LCBpdCByZXR1cm5zIGBmYWxzZWAuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihrZXkpIHsKICBpZiAoa2V5IGluIHRoaXMuX2tleXMpIHsKICAgIGRlbGV0ZSB0aGlzLl9rZXlzW2tleV07CiAgICAtLXRoaXMuX3NpemU7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBhbGwgdmFsdWVzIGZvciBwcm9wZXJ0aWVzIG9mICoqbyoqLgogKi8KZnVuY3Rpb24gdmFsdWVzKG8pIHsKICB2YXIga3MgPSBPYmplY3Qua2V5cyhvKSwKICAgICAgbGVuID0ga3MubGVuZ3RoLAogICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuKSwKICAgICAgaTsKICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIHJlc3VsdFtpXSA9IG9ba3NbaV1dOwogIH0KICByZXR1cm4gcmVzdWx0Owp9Cgp9LHsiLi91dGlsIjoyMn1dLDIyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogVGhpcyBwb2x5ZmlsbCBjb21lcyBmcm9tCiAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L2lzQXJyYXkKICovCmlmKCFBcnJheS5pc0FycmF5KSB7CiAgZXhwb3J0cy5pc0FycmF5ID0gZnVuY3Rpb24gKHZBcmcpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodkFyZykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfSBlbHNlIHsKICBleHBvcnRzLmlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp9CgovKgogKiBTbGlnaHRseSBhZGFwdGVkIHBvbHlmaWxsIGZyb20KICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvUmVkdWNlCiAqLwppZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5yZWR1Y2UpIHsKICBleHBvcnRzLnJlZHVjZSA9IGZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgaWYgKG51bGwgPT09IGFycmF5IHx8ICd1bmRlZmluZWQnID09PSB0eXBlb2YgYXJyYXkpIHsKICAgICAgLy8gQXQgdGhlIG1vbWVudCBhbGwgbW9kZXJuIGJyb3dzZXJzLCB0aGF0IHN1cHBvcnQgc3RyaWN0IG1vZGUsIGhhdmUKICAgICAgLy8gbmF0aXZlIGltcGxlbWVudGF0aW9uIG9mIEFycmF5LnByb3RvdHlwZS5yZWR1Y2UuIEZvciBpbnN0YW5jZSwgSUU4CiAgICAgIC8vIGRvZXMgbm90IHN1cHBvcnQgc3RyaWN0IG1vZGUsIHNvIHRoaXMgY2hlY2sgaXMgYWN0dWFsbHkgdXNlbGVzcy4KICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKICAgICAgICAgICdBcnJheS5wcm90b3R5cGUucmVkdWNlIGNhbGxlZCBvbiBudWxsIG9yIHVuZGVmaW5lZCcpOwogICAgfQogICAgaWYgKCdmdW5jdGlvbicgIT09IHR5cGVvZiBjYWxsYmFjaykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGNhbGxiYWNrICsgJyBpcyBub3QgYSBmdW5jdGlvbicpOwogICAgfQogICAgdmFyIGluZGV4LCB2YWx1ZSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGggPj4+IDAsCiAgICAgICAgaXNWYWx1ZVNldCA9IGZhbHNlOwogICAgaWYgKDEgPCBhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHZhbHVlID0gb3B0X2luaXRpYWxWYWx1ZTsKICAgICAgaXNWYWx1ZVNldCA9IHRydWU7CiAgICB9CiAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID4gaW5kZXg7ICsraW5kZXgpIHsKICAgICAgaWYgKGFycmF5Lmhhc093blByb3BlcnR5KGluZGV4KSkgewogICAgICAgIGlmIChpc1ZhbHVlU2V0KSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgICBpc1ZhbHVlU2V0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICghaXNWYWx1ZVNldCkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKfSBlbHNlIHsKICBleHBvcnRzLnJlZHVjZSA9IGZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSkgewogICAgcmV0dXJuIGFycmF5LnJlZHVjZShjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSk7CiAgfTsKfQoKfSx7fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9ICcxLjEuMyc7Cgp9LHt9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMuR3JhcGggPSByZXF1aXJlKCIuL2xpYi9HcmFwaCIpOwpleHBvcnRzLkRpZ3JhcGggPSByZXF1aXJlKCIuL2xpYi9EaWdyYXBoIik7CmV4cG9ydHMuQ0dyYXBoID0gcmVxdWlyZSgiLi9saWIvQ0dyYXBoIik7CmV4cG9ydHMuQ0RpZ3JhcGggPSByZXF1aXJlKCIuL2xpYi9DRGlncmFwaCIpOwpyZXF1aXJlKCIuL2xpYi9ncmFwaC1jb252ZXJ0ZXJzIik7CgpleHBvcnRzLmFsZyA9IHsKICBpc0FjeWNsaWM6IHJlcXVpcmUoIi4vbGliL2FsZy9pc0FjeWNsaWMiKSwKICBjb21wb25lbnRzOiByZXF1aXJlKCIuL2xpYi9hbGcvY29tcG9uZW50cyIpLAogIGRpamtzdHJhOiByZXF1aXJlKCIuL2xpYi9hbGcvZGlqa3N0cmEiKSwKICBkaWprc3RyYUFsbDogcmVxdWlyZSgiLi9saWIvYWxnL2RpamtzdHJhQWxsIiksCiAgZmluZEN5Y2xlczogcmVxdWlyZSgiLi9saWIvYWxnL2ZpbmRDeWNsZXMiKSwKICBmbG95ZFdhcnNoYWxsOiByZXF1aXJlKCIuL2xpYi9hbGcvZmxveWRXYXJzaGFsbCIpLAogIHBvc3RvcmRlcjogcmVxdWlyZSgiLi9saWIvYWxnL3Bvc3RvcmRlciIpLAogIHByZW9yZGVyOiByZXF1aXJlKCIuL2xpYi9hbGcvcHJlb3JkZXIiKSwKICBwcmltOiByZXF1aXJlKCIuL2xpYi9hbGcvcHJpbSIpLAogIHRhcmphbjogcmVxdWlyZSgiLi9saWIvYWxnL3RhcmphbiIpLAogIHRvcHNvcnQ6IHJlcXVpcmUoIi4vbGliL2FsZy90b3Bzb3J0IikKfTsKCmV4cG9ydHMuY29udmVydGVyID0gewogIGpzb246IHJlcXVpcmUoIi4vbGliL2NvbnZlcnRlci9qc29uLmpzIikKfTsKCnZhciBmaWx0ZXIgPSByZXF1aXJlKCIuL2xpYi9maWx0ZXIiKTsKZXhwb3J0cy5maWx0ZXIgPSB7CiAgYWxsOiBmaWx0ZXIuYWxsLAogIG5vZGVzRnJvbUxpc3Q6IGZpbHRlci5ub2Rlc0Zyb21MaXN0Cn07CgpleHBvcnRzLnZlcnNpb24gPSByZXF1aXJlKCIuL2xpYi92ZXJzaW9uIik7Cgp9LHsiLi9saWIvQ0RpZ3JhcGgiOjI2LCIuL2xpYi9DR3JhcGgiOjI3LCIuL2xpYi9EaWdyYXBoIjoyOCwiLi9saWIvR3JhcGgiOjI5LCIuL2xpYi9hbGcvY29tcG9uZW50cyI6MzAsIi4vbGliL2FsZy9kaWprc3RyYSI6MzEsIi4vbGliL2FsZy9kaWprc3RyYUFsbCI6MzIsIi4vbGliL2FsZy9maW5kQ3ljbGVzIjozMywiLi9saWIvYWxnL2Zsb3lkV2Fyc2hhbGwiOjM0LCIuL2xpYi9hbGcvaXNBY3ljbGljIjozNSwiLi9saWIvYWxnL3Bvc3RvcmRlciI6MzYsIi4vbGliL2FsZy9wcmVvcmRlciI6MzcsIi4vbGliL2FsZy9wcmltIjozOCwiLi9saWIvYWxnL3RhcmphbiI6MzksIi4vbGliL2FsZy90b3Bzb3J0Ijo0MCwiLi9saWIvY29udmVydGVyL2pzb24uanMiOjQyLCIuL2xpYi9maWx0ZXIiOjQzLCIuL2xpYi9ncmFwaC1jb252ZXJ0ZXJzIjo0NCwiLi9saWIvdmVyc2lvbiI6NDZ9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IEJhc2VHcmFwaDsKCmZ1bmN0aW9uIEJhc2VHcmFwaCgpIHsKICAvLyBUaGUgdmFsdWUgYXNzaWduZWQgdG8gdGhlIGdyYXBoIGl0c2VsZi4KICB0aGlzLl92YWx1ZSA9IHVuZGVmaW5lZDsKCiAgLy8gTWFwIG9mIG5vZGUgaWQgLT4geyBpZCwgdmFsdWUgfQogIHRoaXMuX25vZGVzID0ge307CgogIC8vIE1hcCBvZiBlZGdlIGlkIC0+IHsgaWQsIHUsIHYsIHZhbHVlIH0KICB0aGlzLl9lZGdlcyA9IHt9OwoKICAvLyBVc2VkIHRvIGdlbmVyYXRlIGEgdW5pcXVlIGlkIGluIHRoZSBncmFwaAogIHRoaXMuX25leHRJZCA9IDA7Cn0KCi8vIE51bWJlciBvZiBub2RlcwpCYXNlR3JhcGgucHJvdG90eXBlLm9yZGVyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX25vZGVzKS5sZW5ndGg7Cn07CgovLyBOdW1iZXIgb2YgZWRnZXMKQmFzZUdyYXBoLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2VkZ2VzKS5sZW5ndGg7Cn07CgovLyBBY2Nlc3NvciBmb3IgZ3JhcGggbGV2ZWwgdmFsdWUKQmFzZUdyYXBoLnByb3RvdHlwZS5ncmFwaCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB0aGlzLl92YWx1ZTsKICB9CiAgdGhpcy5fdmFsdWUgPSB2YWx1ZTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuaGFzTm9kZSA9IGZ1bmN0aW9uKHUpIHsKICByZXR1cm4gdSBpbiB0aGlzLl9ub2RlczsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUubm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgdmFyIG5vZGUgPSB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gbm9kZS52YWx1ZTsKICB9CiAgbm9kZS52YWx1ZSA9IHZhbHVlOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5ub2RlcyA9IGZ1bmN0aW9uKCkgewogIHZhciBub2RlcyA9IFtdOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24oaWQpIHsgbm9kZXMucHVzaChpZCk7IH0pOwogIHJldHVybiBub2RlczsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuZWFjaE5vZGUgPSBmdW5jdGlvbihmdW5jKSB7CiAgZm9yICh2YXIgayBpbiB0aGlzLl9ub2RlcykgewogICAgdmFyIG5vZGUgPSB0aGlzLl9ub2Rlc1trXTsKICAgIGZ1bmMobm9kZS5pZCwgbm9kZS52YWx1ZSk7CiAgfQp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5oYXNFZGdlID0gZnVuY3Rpb24oZSkgewogIHJldHVybiBlIGluIHRoaXMuX2VkZ2VzOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5lZGdlID0gZnVuY3Rpb24oZSwgdmFsdWUpIHsKICB2YXIgZWRnZSA9IHRoaXMuX3N0cmljdEdldEVkZ2UoZSk7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiBlZGdlLnZhbHVlOwogIH0KICBlZGdlLnZhbHVlID0gdmFsdWU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLmVkZ2VzID0gZnVuY3Rpb24oKSB7CiAgdmFyIGVzID0gW107CiAgdGhpcy5lYWNoRWRnZShmdW5jdGlvbihpZCkgeyBlcy5wdXNoKGlkKTsgfSk7CiAgcmV0dXJuIGVzOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5lYWNoRWRnZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICBmb3IgKHZhciBrIGluIHRoaXMuX2VkZ2VzKSB7CiAgICB2YXIgZWRnZSA9IHRoaXMuX2VkZ2VzW2tdOwogICAgZnVuYyhlZGdlLmlkLCBlZGdlLnUsIGVkZ2UudiwgZWRnZS52YWx1ZSk7CiAgfQp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5pbmNpZGVudE5vZGVzID0gZnVuY3Rpb24oZSkgewogIHZhciBlZGdlID0gdGhpcy5fc3RyaWN0R2V0RWRnZShlKTsKICByZXR1cm4gW2VkZ2UudSwgZWRnZS52XTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuYWRkTm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgaWYgKHUgPT09IHVuZGVmaW5lZCB8fCB1ID09PSBudWxsKSB7CiAgICBkbyB7CiAgICAgIHUgPSAiXyIgKyAoKyt0aGlzLl9uZXh0SWQpOwogICAgfSB3aGlsZSAodGhpcy5oYXNOb2RlKHUpKTsKICB9IGVsc2UgaWYgKHRoaXMuaGFzTm9kZSh1KSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJHcmFwaCBhbHJlYWR5IGhhcyBub2RlICciICsgdSArICInIik7CiAgfQogIHRoaXMuX25vZGVzW3VdID0geyBpZDogdSwgdmFsdWU6IHZhbHVlIH07CiAgcmV0dXJuIHU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLmRlbE5vZGUgPSBmdW5jdGlvbih1KSB7CiAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKICB0aGlzLmluY2lkZW50RWRnZXModSkuZm9yRWFjaChmdW5jdGlvbihlKSB7IHRoaXMuZGVsRWRnZShlKTsgfSwgdGhpcyk7CiAgZGVsZXRlIHRoaXMuX25vZGVzW3VdOwp9OwoKLy8gaW5NYXAgYW5kIG91dE1hcCBhcmUgb3Bwb3NpdGUgc2lkZXMgb2YgYW4gaW5jaWRlbmNlIG1hcC4gRm9yIGV4YW1wbGUsIGZvcgovLyBHcmFwaCB0aGVzZSB3b3VsZCBib3RoIGNvbWUgZnJvbSB0aGUgX2luY2lkZW50RWRnZXMgbWFwLCB3aGlsZSBmb3IgRGlncmFwaAovLyB0aGV5IHdvdWxkIGNvbWUgZnJvbSBfaW5FZGdlcyBhbmQgX291dEVkZ2VzLgpCYXNlR3JhcGgucHJvdG90eXBlLl9hZGRFZGdlID0gZnVuY3Rpb24oZSwgdSwgdiwgdmFsdWUsIGluTWFwLCBvdXRNYXApIHsKICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIHRoaXMuX3N0cmljdEdldE5vZGUodik7CgogIGlmIChlID09PSB1bmRlZmluZWQgfHwgZSA9PT0gbnVsbCkgewogICAgZG8gewogICAgICBlID0gIl8iICsgKCsrdGhpcy5fbmV4dElkKTsKICAgIH0gd2hpbGUgKHRoaXMuaGFzRWRnZShlKSk7CiAgfQogIGVsc2UgaWYgKHRoaXMuaGFzRWRnZShlKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJHcmFwaCBhbHJlYWR5IGhhcyBlZGdlICciICsgZSArICInIik7CiAgfQoKICB0aGlzLl9lZGdlc1tlXSA9IHsgaWQ6IGUsIHU6IHUsIHY6IHYsIHZhbHVlOiB2YWx1ZSB9OwogIGFkZEVkZ2VUb01hcChpbk1hcFt2XSwgdSwgZSk7CiAgYWRkRWRnZVRvTWFwKG91dE1hcFt1XSwgdiwgZSk7CgogIHJldHVybiBlOwp9OwoKLy8gU2VlIG5vdGUgZm9yIF9hZGRFZGdlIHJlZ2FyZGluZyBpbk1hcCBhbmQgb3V0TWFwLgpCYXNlR3JhcGgucHJvdG90eXBlLl9kZWxFZGdlID0gZnVuY3Rpb24oZSwgaW5NYXAsIG91dE1hcCkgewogIHZhciBlZGdlID0gdGhpcy5fc3RyaWN0R2V0RWRnZShlKTsKICBkZWxFZGdlRnJvbU1hcChpbk1hcFtlZGdlLnZdLCBlZGdlLnUsIGUpOwogIGRlbEVkZ2VGcm9tTWFwKG91dE1hcFtlZGdlLnVdLCBlZGdlLnYsIGUpOwogIGRlbGV0ZSB0aGlzLl9lZGdlc1tlXTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKCkgewogIHZhciBjb3B5ID0gbmV3IHRoaXMuY29uc3RydWN0b3IoKTsKICBjb3B5LmdyYXBoKHRoaXMuZ3JhcGgoKSk7CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgeyBjb3B5LmFkZE5vZGUodSwgdmFsdWUpOyB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7IGNvcHkuYWRkRWRnZShlLCB1LCB2LCB2YWx1ZSk7IH0pOwogIGNvcHkuX25leHRJZCA9IHRoaXMuX25leHRJZDsKICByZXR1cm4gY29weTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuZmlsdGVyTm9kZXMgPSBmdW5jdGlvbihmaWx0ZXIpIHsKICB2YXIgY29weSA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCk7CiAgY29weS5ncmFwaCh0aGlzLmdyYXBoKCkpOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIGlmIChmaWx0ZXIodSkpIHsKICAgICAgY29weS5hZGROb2RlKHUsIHZhbHVlKTsKICAgIH0KICB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBpZiAoY29weS5oYXNOb2RlKHUpICYmIGNvcHkuaGFzTm9kZSh2KSkgewogICAgICBjb3B5LmFkZEVkZ2UoZSwgdSwgdiwgdmFsdWUpOwogICAgfQogIH0pOwogIHJldHVybiBjb3B5Owp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5fc3RyaWN0R2V0Tm9kZSA9IGZ1bmN0aW9uKHUpIHsKICB2YXIgbm9kZSA9IHRoaXMuX25vZGVzW3VdOwogIGlmIChub2RlID09PSB1bmRlZmluZWQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm9kZSAnIiArIHUgKyAiJyBpcyBub3QgaW4gZ3JhcGgiKTsKICB9CiAgcmV0dXJuIG5vZGU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLl9zdHJpY3RHZXRFZGdlID0gZnVuY3Rpb24oZSkgewogIHZhciBlZGdlID0gdGhpcy5fZWRnZXNbZV07CiAgaWYgKGVkZ2UgPT09IHVuZGVmaW5lZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJFZGdlICciICsgZSArICInIGlzIG5vdCBpbiBncmFwaCIpOwogIH0KICByZXR1cm4gZWRnZTsKfTsKCmZ1bmN0aW9uIGFkZEVkZ2VUb01hcChtYXAsIHYsIGUpIHsKICAobWFwW3ZdIHx8IChtYXBbdl0gPSBuZXcgU2V0KCkpKS5hZGQoZSk7Cn0KCmZ1bmN0aW9uIGRlbEVkZ2VGcm9tTWFwKG1hcCwgdiwgZSkgewogIHZhciB2RW50cnkgPSBtYXBbdl07CiAgdkVudHJ5LnJlbW92ZShlKTsKICBpZiAodkVudHJ5LnNpemUoKSA9PT0gMCkgewogICAgZGVsZXRlIG1hcFt2XTsKICB9Cn0KCgp9LHsiY3AtZGF0YSI6MTl9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBEaWdyYXBoID0gcmVxdWlyZSgiLi9EaWdyYXBoIiksCiAgICBjb21wb3VuZGlmeSA9IHJlcXVpcmUoIi4vY29tcG91bmRpZnkiKTsKCnZhciBDRGlncmFwaCA9IGNvbXBvdW5kaWZ5KERpZ3JhcGgpOwoKbW9kdWxlLmV4cG9ydHMgPSBDRGlncmFwaDsKCkNEaWdyYXBoLmZyb21EaWdyYXBoID0gZnVuY3Rpb24oc3JjKSB7CiAgdmFyIGcgPSBuZXcgQ0RpZ3JhcGgoKSwKICAgICAgZ3JhcGhWYWx1ZSA9IHNyYy5ncmFwaCgpOwoKICBpZiAoZ3JhcGhWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBnLmdyYXBoKGdyYXBoVmFsdWUpOwogIH0KCiAgc3JjLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICBnLmFkZE5vZGUodSk7CiAgICB9IGVsc2UgewogICAgICBnLmFkZE5vZGUodSwgdmFsdWUpOwogICAgfQogIH0pOwogIHNyYy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYpOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIH0KICB9KTsKICByZXR1cm4gZzsKfTsKCkNEaWdyYXBoLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAiQ0RpZ3JhcGggIiArIEpTT04uc3RyaW5naWZ5KHRoaXMsIG51bGwsIDIpOwp9OwoKfSx7Ii4vRGlncmFwaCI6MjgsIi4vY29tcG91bmRpZnkiOjQxfV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgR3JhcGggPSByZXF1aXJlKCIuL0dyYXBoIiksCiAgICBjb21wb3VuZGlmeSA9IHJlcXVpcmUoIi4vY29tcG91bmRpZnkiKTsKCnZhciBDR3JhcGggPSBjb21wb3VuZGlmeShHcmFwaCk7Cgptb2R1bGUuZXhwb3J0cyA9IENHcmFwaDsKCkNHcmFwaC5mcm9tR3JhcGggPSBmdW5jdGlvbihzcmMpIHsKICB2YXIgZyA9IG5ldyBDR3JhcGgoKSwKICAgICAgZ3JhcGhWYWx1ZSA9IHNyYy5ncmFwaCgpOwoKICBpZiAoZ3JhcGhWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBnLmdyYXBoKGdyYXBoVmFsdWUpOwogIH0KCiAgc3JjLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICBnLmFkZE5vZGUodSk7CiAgICB9IGVsc2UgewogICAgICBnLmFkZE5vZGUodSwgdmFsdWUpOwogICAgfQogIH0pOwogIHNyYy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYpOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIH0KICB9KTsKICByZXR1cm4gZzsKfTsKCkNHcmFwaC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gIkNHcmFwaCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgMik7Cn07Cgp9LHsiLi9HcmFwaCI6MjksIi4vY29tcG91bmRpZnkiOjQxfV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKgogKiBUaGlzIGZpbGUgaXMgb3JnYW5pemVkIHdpdGggaW4gdGhlIGZvbGxvd2luZyBvcmRlcjoKICoKICogRXhwb3J0cwogKiBHcmFwaCBjb25zdHJ1Y3RvcnMKICogR3JhcGggcXVlcmllcyAoZS5nLiBub2RlcygpLCBlZGdlcygpCiAqIEdyYXBoIG11dGF0b3JzCiAqIEhlbHBlciBmdW5jdGlvbnMKICovCgp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbCIpLAogICAgQmFzZUdyYXBoID0gcmVxdWlyZSgiLi9CYXNlR3JhcGgiKSwKLyoganNoaW50IC1XMDc5ICovCiAgICBTZXQgPSByZXF1aXJlKCJjcC1kYXRhIikuU2V0OwovKiBqc2hpbnQgK1cwNzkgKi8KCm1vZHVsZS5leHBvcnRzID0gRGlncmFwaDsKCi8qCiAqIENvbnN0cnVjdG9yIHRvIGNyZWF0ZSBhIG5ldyBkaXJlY3RlZCBtdWx0aS1ncmFwaC4KICovCmZ1bmN0aW9uIERpZ3JhcGgoKSB7CiAgQmFzZUdyYXBoLmNhbGwodGhpcyk7CgogIC8qISBNYXAgb2Ygc291cmNlSWQgLT4ge3RhcmdldElkIC0+IFNldCBvZiBlZGdlIGlkc30gKi8KICB0aGlzLl9pbkVkZ2VzID0ge307CgogIC8qISBNYXAgb2YgdGFyZ2V0SWQgLT4ge3NvdXJjZUlkIC0+IFNldCBvZiBlZGdlIGlkc30gKi8KICB0aGlzLl9vdXRFZGdlcyA9IHt9Owp9CgpEaWdyYXBoLnByb3RvdHlwZSA9IG5ldyBCYXNlR3JhcGgoKTsKRGlncmFwaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEaWdyYXBoOwoKLyoKICogQWx3YXlzIHJldHVybnMgYHRydWVgLgogKi8KRGlncmFwaC5wcm90b3R5cGUuaXNEaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0cnVlOwp9OwoKLyoKICogUmV0dXJucyBhbGwgc3VjY2Vzc29ycyBvZiB0aGUgbm9kZSB3aXRoIHRoZSBpZCBgdWAuIFRoYXQgaXMsIGFsbCBub2RlcwogKiB0aGF0IGhhdmUgdGhlIG5vZGUgYHVgIGFzIHRoZWlyIHNvdXJjZSBhcmUgcmV0dXJuZWQuCiAqIAogKiBJZiBubyBub2RlIGB1YCBleGlzdHMgaW4gdGhlIGdyYXBoIHRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdSBhIG5vZGUgaWQKICovCkRpZ3JhcGgucHJvdG90eXBlLnN1Y2Nlc3NvcnMgPSBmdW5jdGlvbih1KSB7CiAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fb3V0RWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbGwgcHJlZGVjZXNzb3JzIG9mIHRoZSBub2RlIHdpdGggdGhlIGlkIGB1YC4gVGhhdCBpcywgYWxsIG5vZGVzCiAqIHRoYXQgaGF2ZSB0aGUgbm9kZSBgdWAgYXMgdGhlaXIgdGFyZ2V0IGFyZSByZXR1cm5lZC4KICogCiAqIElmIG5vIG5vZGUgYHVgIGV4aXN0cyBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUucHJlZGVjZXNzb3JzID0gZnVuY3Rpb24odSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodSk7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2luRWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbGwgbm9kZXMgdGhhdCBhcmUgYWRqYWNlbnQgdG8gdGhlIG5vZGUgd2l0aCB0aGUgaWQgYHVgLiBJbiBvdGhlcgogKiB3b3JkcywgdGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBzZXQgb2YgYWxsIHN1Y2Nlc3NvcnMgYW5kIHByZWRlY2Vzc29ycyBvZgogKiBub2RlIGB1YC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5uZWlnaGJvcnMgPSBmdW5jdGlvbih1KSB7CiAgcmV0dXJuIFNldC51bmlvbihbdGhpcy5zdWNjZXNzb3JzKHUpLCB0aGlzLnByZWRlY2Vzc29ycyh1KV0pLmtleXMoKTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIGluIHRoZSBncmFwaCB0aGF0IGhhdmUgbm8gaW4tZWRnZXMuCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5zb3VyY2VzID0gZnVuY3Rpb24oKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHJldHVybiB0aGlzLl9maWx0ZXJOb2RlcyhmdW5jdGlvbih1KSB7CiAgICAvLyBUaGlzIGNvdWxkIGhhdmUgYmV0dGVyIHNwYWNlIGNoYXJhY3RlcmlzdGljcyBpZiB3ZSBoYWQgYW4gaW5EZWdyZWUgZnVuY3Rpb24uCiAgICByZXR1cm4gc2VsZi5pbkVkZ2VzKHUpLmxlbmd0aCA9PT0gMDsKICB9KTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIGluIHRoZSBncmFwaCB0aGF0IGhhdmUgbm8gb3V0LWVkZ2VzLgogKi8KRGlncmFwaC5wcm90b3R5cGUuc2lua3MgPSBmdW5jdGlvbigpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgcmV0dXJuIHRoaXMuX2ZpbHRlck5vZGVzKGZ1bmN0aW9uKHUpIHsKICAgIC8vIFRoaXMgY291bGQgaGF2ZSBiZXR0ZXIgc3BhY2UgY2hhcmFjdGVyaXN0aWNzIGlmIHdlIGhhdmUgYW4gb3V0RGVncmVlIGZ1bmN0aW9uLgogICAgcmV0dXJuIHNlbGYub3V0RWRnZXModSkubGVuZ3RoID09PSAwOwogIH0pOwp9OwoKLyoKICogUmV0dXJucyB0aGUgc291cmNlIG5vZGUgaW5jaWRlbnQgb24gdGhlIGVkZ2UgaWRlbnRpZmllZCBieSB0aGUgaWQgYGVgLiBJZiBubwogKiBzdWNoIGVkZ2UgZXhpc3RzIGluIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uIHRocm93cyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IGUgYW4gZWRnZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUuc291cmNlID0gZnVuY3Rpb24oZSkgewogIHJldHVybiB0aGlzLl9zdHJpY3RHZXRFZGdlKGUpLnU7Cn07CgovKgogKiBSZXR1cm5zIHRoZSB0YXJnZXQgbm9kZSBpbmNpZGVudCBvbiB0aGUgZWRnZSBpZGVudGlmaWVkIGJ5IHRoZSBpZCBgZWAuIElmIG5vCiAqIHN1Y2ggZWRnZSBleGlzdHMgaW4gdGhlIGdyYXBoIHRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS50YXJnZXQgPSBmdW5jdGlvbihlKSB7CiAgcmV0dXJuIHRoaXMuX3N0cmljdEdldEVkZ2UoZSkudjsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgaWRzIGZvciBhbGwgZWRnZXMgaW4gdGhlIGdyYXBoIHRoYXQgaGF2ZSB0aGUgbm9kZQogKiBgdGFyZ2V0YCBhcyB0aGVpciB0YXJnZXQuIElmIHRoZSBub2RlIGB0YXJnZXRgIGlzIG5vdCBpbiB0aGUgZ3JhcGggdGhpcwogKiBmdW5jdGlvbiByYWlzZXMgYW4gRXJyb3IuCiAqCiAqIE9wdGlvbmFsbHkgYSBgc291cmNlYCBub2RlIGNhbiBhbHNvIGJlIHNwZWNpZmllZC4gVGhpcyBjYXVzZXMgdGhlIHJlc3VsdHMKICogdG8gYmUgZmlsdGVyZWQgc3VjaCB0aGF0IG9ubHkgZWRnZXMgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YCBhcmUgaW5jbHVkZWQuCiAqIElmIHRoZSBub2RlIGBzb3VyY2VgIGlzIHNwZWNpZmllZCBidXQgaXMgbm90IGluIHRoZSBncmFwaCB0aGVuIHRoaXMgZnVuY3Rpb24KICogcmFpc2VzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0IHRoZSB0YXJnZXQgbm9kZSBpZAogKiBAcGFyYW0ge1N0cmluZ30gW3NvdXJjZV0gYW4gb3B0aW9uYWwgc291cmNlIG5vZGUgaWQKICovCkRpZ3JhcGgucHJvdG90eXBlLmluRWRnZXMgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodGFyZ2V0KTsKICB2YXIgcmVzdWx0cyA9IFNldC51bmlvbih1dGlsLnZhbHVlcyh0aGlzLl9pbkVkZ2VzW3RhcmdldF0pKS5rZXlzKCk7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICB0aGlzLl9zdHJpY3RHZXROb2RlKHNvdXJjZSk7CiAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoZnVuY3Rpb24oZSkgeyByZXR1cm4gdGhpcy5zb3VyY2UoZSkgPT09IHNvdXJjZTsgfSwgdGhpcyk7CiAgfQogIHJldHVybiByZXN1bHRzOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBpZHMgZm9yIGFsbCBlZGdlcyBpbiB0aGUgZ3JhcGggdGhhdCBoYXZlIHRoZSBub2RlCiAqIGBzb3VyY2VgIGFzIHRoZWlyIHNvdXJjZS4gSWYgdGhlIG5vZGUgYHNvdXJjZWAgaXMgbm90IGluIHRoZSBncmFwaCB0aGlzCiAqIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogT3B0aW9uYWxseSBhIGB0YXJnZXRgIG5vZGUgbWF5IGFsc28gYmUgc3BlY2lmaWVkLiBUaGlzIGNhdXNlcyB0aGUgcmVzdWx0cwogKiB0byBiZSBmaWx0ZXJlZCBzdWNoIHRoYXQgb25seSBlZGdlcyBmcm9tIGBzb3VyY2VgIHRvIGB0YXJnZXRgIGFyZSBpbmNsdWRlZC4KICogSWYgdGhlIG5vZGUgYHRhcmdldGAgaXMgc3BlY2lmaWVkIGJ1dCBpcyBub3QgaW4gdGhlIGdyYXBoIHRoZW4gdGhpcyBmdW5jdGlvbgogKiByYWlzZXMgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBzb3VyY2UgdGhlIHNvdXJjZSBub2RlIGlkCiAqIEBwYXJhbSB7U3RyaW5nfSBbdGFyZ2V0XSBhbiBvcHRpb25hbCB0YXJnZXQgbm9kZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUub3V0RWRnZXMgPSBmdW5jdGlvbihzb3VyY2UsIHRhcmdldCkgewogIHRoaXMuX3N0cmljdEdldE5vZGUoc291cmNlKTsKICB2YXIgcmVzdWx0cyA9IFNldC51bmlvbih1dGlsLnZhbHVlcyh0aGlzLl9vdXRFZGdlc1tzb3VyY2VdKSkua2V5cygpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh0YXJnZXQpOwogICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGZ1bmN0aW9uKGUpIHsgcmV0dXJuIHRoaXMudGFyZ2V0KGUpID09PSB0YXJnZXQ7IH0sIHRoaXMpOwogIH0KICByZXR1cm4gcmVzdWx0czsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgaWRzIGZvciBhbGwgZWRnZXMgaW4gdGhlIGdyYXBoIHRoYXQgaGF2ZSB0aGUgYHVgIGFzCiAqIHRoZWlyIHNvdXJjZSBvciB0aGVpciB0YXJnZXQuIElmIHRoZSBub2RlIGB1YCBpcyBub3QgaW4gdGhlIGdyYXBoIHRoaXMKICogZnVuY3Rpb24gcmFpc2VzIGFuIEVycm9yLgogKgogKiBPcHRpb25hbGx5IGEgYHZgIG5vZGUgbWF5IGFsc28gYmUgc3BlY2lmaWVkLiBUaGlzIGNhdXNlcyB0aGUgcmVzdWx0cyB0byBiZQogKiBmaWx0ZXJlZCBzdWNoIHRoYXQgb25seSBlZGdlcyBiZXR3ZWVuIGB1YCBhbmQgYHZgIC0gaW4gZWl0aGVyIGRpcmVjdGlvbiAtCiAqIGFyZSBpbmNsdWRlZC4gSUYgdGhlIG5vZGUgYHZgIGlzIHNwZWNpZmllZCBidXQgbm90IGluIHRoZSBncmFwaCB0aGVuIHRoaXMKICogZnVuY3Rpb24gcmFpc2VzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdSB0aGUgbm9kZSBmb3Igd2hpY2ggdG8gZmluZCBpbmNpZGVudCBlZGdlcwogKiBAcGFyYW0ge1N0cmluZ30gW3ZdIG9wdGlvbiBub2RlIHRoYXQgbXVzdCBiZSBhZGphY2VudCB0byBgdWAKICovCkRpZ3JhcGgucHJvdG90eXBlLmluY2lkZW50RWRnZXMgPSBmdW5jdGlvbih1LCB2KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKFt0aGlzLm91dEVkZ2VzKHUsIHYpLCB0aGlzLm91dEVkZ2VzKHYsIHUpXSkua2V5cygpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKFt0aGlzLmluRWRnZXModSksIHRoaXMub3V0RWRnZXModSldKS5rZXlzKCk7CiAgfQp9OwoKLyoKICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGdyYXBoLgogKi8KRGlncmFwaC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gIkRpZ3JhcGggIiArIEpTT04uc3RyaW5naWZ5KHRoaXMsIG51bGwsIDIpOwp9OwoKLyoKICogQWRkcyBhIG5ldyBub2RlIHdpdGggdGhlIGlkIGB1YCB0byB0aGUgZ3JhcGggYW5kIGFzc2lnbnMgaXQgdGhlIHZhbHVlCiAqIGB2YWx1ZWAuIElmIGEgbm9kZSB3aXRoIHRoZSBpZCBpcyBhbHJlYWR5IGEgcGFydCBvZiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbgogKiB0aHJvd3MgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKiBAcGFyYW0ge09iamVjdH0gW3ZhbHVlXSBhbiBvcHRpb25hbCB2YWx1ZSB0byBhdHRhY2ggdG8gdGhlIG5vZGUKICovCkRpZ3JhcGgucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbih1LCB2YWx1ZSkgewogIHUgPSBCYXNlR3JhcGgucHJvdG90eXBlLmFkZE5vZGUuY2FsbCh0aGlzLCB1LCB2YWx1ZSk7CiAgdGhpcy5faW5FZGdlc1t1XSA9IHt9OwogIHRoaXMuX291dEVkZ2VzW3VdID0ge307CiAgcmV0dXJuIHU7Cn07CgovKgogKiBSZW1vdmVzIGEgbm9kZSBmcm9tIHRoZSBncmFwaCB0aGF0IGhhcyB0aGUgaWQgYHVgLiBBbnkgZWRnZXMgaW5jaWRlbnQgb24gdGhlCiAqIG5vZGUgYXJlIGFsc28gcmVtb3ZlZC4gSWYgdGhlIGdyYXBoIGRvZXMgbm90IGNvbnRhaW4gYSBub2RlIHdpdGggdGhlIGlkIHRoaXMKICogZnVuY3Rpb24gd2lsbCB0aHJvdyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5kZWxOb2RlID0gZnVuY3Rpb24odSkgewogIEJhc2VHcmFwaC5wcm90b3R5cGUuZGVsTm9kZS5jYWxsKHRoaXMsIHUpOwogIGRlbGV0ZSB0aGlzLl9pbkVkZ2VzW3VdOwogIGRlbGV0ZSB0aGlzLl9vdXRFZGdlc1t1XTsKfTsKCi8qCiAqIEFkZHMgYSBuZXcgZWRnZSB0byB0aGUgZ3JhcGggd2l0aCB0aGUgaWQgYGVgIGZyb20gYSBub2RlIHdpdGggdGhlIGlkIGBzb3VyY2VgCiAqIHRvIGEgbm9kZSB3aXRoIGFuIGlkIGB0YXJnZXRgIGFuZCBhc3NpZ25zIGl0IHRoZSB2YWx1ZSBgdmFsdWVgLiBUaGlzIGdyYXBoCiAqIGFsbG93cyBtb3JlIHRoYW4gb25lIGVkZ2UgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YCBhcyBsb25nIGFzIHRoZSBpZCBgZWAKICogaXMgdW5pcXVlIGluIHRoZSBzZXQgb2YgZWRnZXMuIElmIGBlYCBpcyBgbnVsbGAgdGhlIGdyYXBoIHdpbGwgYXNzaWduIGEKICogdW5pcXVlIGlkZW50aWZpZXIgdG8gdGhlIGVkZ2UuCiAqCiAqIElmIGBzb3VyY2VgIG9yIGB0YXJnZXRgIGFyZSBub3QgcHJlc2VudCBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB3aWxsCiAqIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gW2VdIGFuIGVkZ2UgaWQKICogQHBhcmFtIHtTdHJpbmd9IHNvdXJjZSB0aGUgc291cmNlIG5vZGUgaWQKICogQHBhcmFtIHtTdHJpbmd9IHRhcmdldCB0aGUgdGFyZ2V0IG5vZGUgaWQKICogQHBhcmFtIHtPYmplY3R9IFt2YWx1ZV0gYW4gb3B0aW9uYWwgdmFsdWUgdG8gYXR0YWNoIHRvIHRoZSBlZGdlCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5hZGRFZGdlID0gZnVuY3Rpb24oZSwgc291cmNlLCB0YXJnZXQsIHZhbHVlKSB7CiAgcmV0dXJuIEJhc2VHcmFwaC5wcm90b3R5cGUuX2FkZEVkZ2UuY2FsbCh0aGlzLCBlLCBzb3VyY2UsIHRhcmdldCwgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbkVkZ2VzLCB0aGlzLl9vdXRFZGdlcyk7Cn07CgovKgogKiBSZW1vdmVzIGFuIGVkZ2UgaW4gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYC4gSWYgbm8gZWRnZSBpbiB0aGUgZ3JhcGggaGFzCiAqIHRoZSBpZCBgZWAgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5kZWxFZGdlID0gZnVuY3Rpb24oZSkgewogIEJhc2VHcmFwaC5wcm90b3R5cGUuX2RlbEVkZ2UuY2FsbCh0aGlzLCBlLCB0aGlzLl9pbkVkZ2VzLCB0aGlzLl9vdXRFZGdlcyk7Cn07CgovLyBVbmxpa2UgQmFzZUdyYXBoLmZpbHRlck5vZGVzLCB0aGlzIGhlbHBlciBqdXN0IHJldHVybnMgbm9kZXMgdGhhdAovLyBzYXRpc2Z5IGEgcHJlZGljYXRlLgpEaWdyYXBoLnByb3RvdHlwZS5fZmlsdGVyTm9kZXMgPSBmdW5jdGlvbihwcmVkKSB7CiAgdmFyIGZpbHRlcmVkID0gW107CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1KSB7CiAgICBpZiAocHJlZCh1KSkgewogICAgICBmaWx0ZXJlZC5wdXNoKHUpOwogICAgfQogIH0pOwogIHJldHVybiBmaWx0ZXJlZDsKfTsKCgp9LHsiLi9CYXNlR3JhcGgiOjI1LCIuL3V0aWwiOjQ1LCJjcC1kYXRhIjoxOX1dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogVGhpcyBmaWxlIGlzIG9yZ2FuaXplZCB3aXRoIGluIHRoZSBmb2xsb3dpbmcgb3JkZXI6CiAqCiAqIEV4cG9ydHMKICogR3JhcGggY29uc3RydWN0b3JzCiAqIEdyYXBoIHF1ZXJpZXMgKGUuZy4gbm9kZXMoKSwgZWRnZXMoKQogKiBHcmFwaCBtdXRhdG9ycwogKiBIZWxwZXIgZnVuY3Rpb25zCiAqLwoKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwiKSwKICAgIEJhc2VHcmFwaCA9IHJlcXVpcmUoIi4vQmFzZUdyYXBoIiksCi8qIGpzaGludCAtVzA3OSAqLwogICAgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IEdyYXBoOwoKLyoKICogQ29uc3RydWN0b3IgdG8gY3JlYXRlIGEgbmV3IHVuZGlyZWN0ZWQgbXVsdGktZ3JhcGguCiAqLwpmdW5jdGlvbiBHcmFwaCgpIHsKICBCYXNlR3JhcGguY2FsbCh0aGlzKTsKCiAgLyohIE1hcCBvZiBub2RlSWQgLT4geyBvdGhlck5vZGVJZCAtPiBTZXQgb2YgZWRnZSBpZHMgfSAqLwogIHRoaXMuX2luY2lkZW50RWRnZXMgPSB7fTsKfQoKR3JhcGgucHJvdG90eXBlID0gbmV3IEJhc2VHcmFwaCgpOwpHcmFwaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBHcmFwaDsKCi8qCiAqIEFsd2F5cyByZXR1cm5zIGBmYWxzZWAuCiAqLwpHcmFwaC5wcm90b3R5cGUuaXNEaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBmYWxzZTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIHRoYXQgYXJlIGFkamFjZW50IHRvIHRoZSBub2RlIHdpdGggdGhlIGlkIGB1YC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpHcmFwaC5wcm90b3R5cGUubmVpZ2hib3JzID0gZnVuY3Rpb24odSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodSk7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2luY2lkZW50RWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBpZHMgZm9yIGFsbCBlZGdlcyBpbiB0aGUgZ3JhcGggdGhhdCBhcmUgaW5jaWRlbnQgb24gYHVgLgogKiBJZiB0aGUgbm9kZSBgdWAgaXMgbm90IGluIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogT3B0aW9uYWxseSBhIGB2YCBub2RlIG1heSBhbHNvIGJlIHNwZWNpZmllZC4gVGhpcyBjYXVzZXMgdGhlIHJlc3VsdHMgdG8gYmUKICogZmlsdGVyZWQgc3VjaCB0aGF0IG9ubHkgZWRnZXMgYmV0d2VlbiBgdWAgYW5kIGB2YCBhcmUgaW5jbHVkZWQuIElmIHRoZSBub2RlCiAqIGB2YCBpcyBzcGVjaWZpZWQgYnV0IG5vdCBpbiB0aGUgZ3JhcGggdGhlbiB0aGlzIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgdGhlIG5vZGUgZm9yIHdoaWNoIHRvIGZpbmQgaW5jaWRlbnQgZWRnZXMKICogQHBhcmFtIHtTdHJpbmd9IFt2XSBvcHRpb24gbm9kZSB0aGF0IG11c3QgYmUgYWRqYWNlbnQgdG8gYHVgCiAqLwpHcmFwaC5wcm90b3R5cGUuaW5jaWRlbnRFZGdlcyA9IGZ1bmN0aW9uKHUsIHYpIHsKICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh2KTsKICAgIHJldHVybiB2IGluIHRoaXMuX2luY2lkZW50RWRnZXNbdV0gPyB0aGlzLl9pbmNpZGVudEVkZ2VzW3VdW3ZdLmtleXMoKSA6IFtdOwogIH0gZWxzZSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKHV0aWwudmFsdWVzKHRoaXMuX2luY2lkZW50RWRnZXNbdV0pKS5rZXlzKCk7CiAgfQp9OwoKLyoKICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGdyYXBoLgogKi8KR3JhcGgucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuICJHcmFwaCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgMik7Cn07CgovKgogKiBBZGRzIGEgbmV3IG5vZGUgd2l0aCB0aGUgaWQgYHVgIHRvIHRoZSBncmFwaCBhbmQgYXNzaWducyBpdCB0aGUgdmFsdWUKICogYHZhbHVlYC4gSWYgYSBub2RlIHdpdGggdGhlIGlkIGlzIGFscmVhZHkgYSBwYXJ0IG9mIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uCiAqIHRocm93cyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqIEBwYXJhbSB7T2JqZWN0fSBbdmFsdWVdIGFuIG9wdGlvbmFsIHZhbHVlIHRvIGF0dGFjaCB0byB0aGUgbm9kZQogKi8KR3JhcGgucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbih1LCB2YWx1ZSkgewogIHUgPSBCYXNlR3JhcGgucHJvdG90eXBlLmFkZE5vZGUuY2FsbCh0aGlzLCB1LCB2YWx1ZSk7CiAgdGhpcy5faW5jaWRlbnRFZGdlc1t1XSA9IHt9OwogIHJldHVybiB1Owp9OwoKLyoKICogUmVtb3ZlcyBhIG5vZGUgZnJvbSB0aGUgZ3JhcGggdGhhdCBoYXMgdGhlIGlkIGB1YC4gQW55IGVkZ2VzIGluY2lkZW50IG9uIHRoZQogKiBub2RlIGFyZSBhbHNvIHJlbW92ZWQuIElmIHRoZSBncmFwaCBkb2VzIG5vdCBjb250YWluIGEgbm9kZSB3aXRoIHRoZSBpZCB0aGlzCiAqIGZ1bmN0aW9uIHdpbGwgdGhyb3cgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKi8KR3JhcGgucHJvdG90eXBlLmRlbE5vZGUgPSBmdW5jdGlvbih1KSB7CiAgQmFzZUdyYXBoLnByb3RvdHlwZS5kZWxOb2RlLmNhbGwodGhpcywgdSk7CiAgZGVsZXRlIHRoaXMuX2luY2lkZW50RWRnZXNbdV07Cn07CgovKgogKiBBZGRzIGEgbmV3IGVkZ2UgdG8gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYCBiZXR3ZWVuIGEgbm9kZSB3aXRoIHRoZSBpZCBgdWAKICogYW5kIGEgbm9kZSB3aXRoIGFuIGlkIGB2YCBhbmQgYXNzaWducyBpdCB0aGUgdmFsdWUgYHZhbHVlYC4gVGhpcyBncmFwaAogKiBhbGxvd3MgbW9yZSB0aGFuIG9uZSBlZGdlIGJldHdlZW4gYHVgIGFuZCBgdmAgYXMgbG9uZyBhcyB0aGUgaWQgYGVgCiAqIGlzIHVuaXF1ZSBpbiB0aGUgc2V0IG9mIGVkZ2VzLiBJZiBgZWAgaXMgYG51bGxgIHRoZSBncmFwaCB3aWxsIGFzc2lnbiBhCiAqIHVuaXF1ZSBpZGVudGlmaWVyIHRvIHRoZSBlZGdlLgogKgogKiBJZiBgdWAgb3IgYHZgIGFyZSBub3QgcHJlc2VudCBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuCiAqIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gW2VdIGFuIGVkZ2UgaWQKICogQHBhcmFtIHtTdHJpbmd9IHUgdGhlIG5vZGUgaWQgb2Ygb25lIG9mIHRoZSBhZGphY2VudCBub2RlcwogKiBAcGFyYW0ge1N0cmluZ30gdiB0aGUgbm9kZSBpZCBvZiB0aGUgb3RoZXIgYWRqYWNlbnQgbm9kZQogKiBAcGFyYW0ge09iamVjdH0gW3ZhbHVlXSBhbiBvcHRpb25hbCB2YWx1ZSB0byBhdHRhY2ggdG8gdGhlIGVkZ2UKICovCkdyYXBoLnByb3RvdHlwZS5hZGRFZGdlID0gZnVuY3Rpb24oZSwgdSwgdiwgdmFsdWUpIHsKICByZXR1cm4gQmFzZUdyYXBoLnByb3RvdHlwZS5fYWRkRWRnZS5jYWxsKHRoaXMsIGUsIHUsIHYsIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5jaWRlbnRFZGdlcywgdGhpcy5faW5jaWRlbnRFZGdlcyk7Cn07CgovKgogKiBSZW1vdmVzIGFuIGVkZ2UgaW4gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYC4gSWYgbm8gZWRnZSBpbiB0aGUgZ3JhcGggaGFzCiAqIHRoZSBpZCBgZWAgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpHcmFwaC5wcm90b3R5cGUuZGVsRWRnZSA9IGZ1bmN0aW9uKGUpIHsKICBCYXNlR3JhcGgucHJvdG90eXBlLl9kZWxFZGdlLmNhbGwodGhpcywgZSwgdGhpcy5faW5jaWRlbnRFZGdlcywgdGhpcy5faW5jaWRlbnRFZGdlcyk7Cn07CgoKfSx7Ii4vQmFzZUdyYXBoIjoyNSwiLi91dGlsIjo0NSwiY3AtZGF0YSI6MTl9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IGNvbXBvbmVudHM7CgovKioKICogRmluZHMgYWxsIFtjb25uZWN0ZWQgY29tcG9uZW50c11bXSBpbiBhIGdyYXBoIGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIHRoZXNlCiAqIGNvbXBvbmVudHMuIEVhY2ggY29tcG9uZW50IGlzIGl0c2VsZiBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSBpZHMgb2Ygbm9kZXMKICogaW4gdGhlIGNvbXBvbmVudC4KICoKICogVGhpcyBmdW5jdGlvbiBvbmx5IHdvcmtzIHdpdGggdW5kaXJlY3RlZCBHcmFwaHMuCiAqCiAqIFtjb25uZWN0ZWQgY29tcG9uZW50c106IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29ubmVjdGVkX2NvbXBvbmVudF8oZ3JhcGhfdGhlb3J5KQogKgogKiBAcGFyYW0ge0dyYXBofSBnIHRoZSBncmFwaCB0byBzZWFyY2ggZm9yIGNvbXBvbmVudHMKICovCmZ1bmN0aW9uIGNvbXBvbmVudHMoZykgewogIHZhciByZXN1bHRzID0gW107CiAgdmFyIHZpc2l0ZWQgPSBuZXcgU2V0KCk7CgogIGZ1bmN0aW9uIGRmcyh2LCBjb21wb25lbnQpIHsKICAgIGlmICghdmlzaXRlZC5oYXModikpIHsKICAgICAgdmlzaXRlZC5hZGQodik7CiAgICAgIGNvbXBvbmVudC5wdXNoKHYpOwogICAgICBnLm5laWdoYm9ycyh2KS5mb3JFYWNoKGZ1bmN0aW9uKHcpIHsKICAgICAgICBkZnModywgY29tcG9uZW50KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBnLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICB2YXIgY29tcG9uZW50ID0gW107CiAgICBkZnModiwgY29tcG9uZW50KTsKICAgIGlmIChjb21wb25lbnQubGVuZ3RoID4gMCkgewogICAgICByZXN1bHRzLnB1c2goY29tcG9uZW50KTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCn0seyJjcC1kYXRhIjoxOX1dLDMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIFByaW9yaXR5UXVldWUgPSByZXF1aXJlKCJjcC1kYXRhIikuUHJpb3JpdHlRdWV1ZTsKCm1vZHVsZS5leHBvcnRzID0gZGlqa3N0cmE7CgovKioKICogVGhpcyBmdW5jdGlvbiBpcyBhbiBpbXBsZW1lbnRhdGlvbiBvZiBbRGlqa3N0cmEncyBhbGdvcml0aG1dW10gd2hpY2ggZmluZHMKICogdGhlIHNob3J0ZXN0IHBhdGggZnJvbSAqKnNvdXJjZSoqIHRvIGFsbCBvdGhlciBub2RlcyBpbiAqKmcqKi4gVGhpcwogKiBmdW5jdGlvbiByZXR1cm5zIGEgbWFwIG9mIGB1IC0+IHsgZGlzdGFuY2UsIHByZWRlY2Vzc29yIH1gLiBUaGUgZGlzdGFuY2UKICogcHJvcGVydHkgaG9sZHMgdGhlIHN1bSBvZiB0aGUgd2VpZ2h0cyBmcm9tICoqc291cmNlKiogdG8gYHVgIGFsb25nIHRoZQogKiBzaG9ydGVzdCBwYXRoIG9yIGBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlgIGlmIHRoZXJlIGlzIG5vIHBhdGggZnJvbQogKiAqKnNvdXJjZSoqLiBUaGUgcHJlZGVjZXNzb3IgcHJvcGVydHkgY2FuIGJlIHVzZWQgdG8gd2FsayB0aGUgaW5kaXZpZHVhbAogKiBlbGVtZW50cyBvZiB0aGUgcGF0aCBmcm9tICoqc291cmNlKiogdG8gKip1KiogaW4gcmV2ZXJzZSBvcmRlci4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgd2VpZ2h0RnVuYyhlKWAgd2hpY2ggcmV0dXJucyB0aGUKICogd2VpZ2h0IG9mIHRoZSBlZGdlIGBlYC4gSWYgbm8gd2VpZ2h0RnVuYyBpcyBzdXBwbGllZCB0aGVuIGVhY2ggZWRnZSBpcwogKiBhc3N1bWVkIHRvIGhhdmUgYSB3ZWlnaHQgb2YgMS4gVGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IgaWYgYW55IG9mCiAqIHRoZSB0cmF2ZXJzZWQgZWRnZXMgaGF2ZSBhIG5lZ2F0aXZlIGVkZ2Ugd2VpZ2h0LgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGFuIG9wdGlvbmFsIGBpbmNpZGVudEZ1bmModSlgIHdoaWNoIHJldHVybnMgdGhlIGlkcyBvZgogKiBhbGwgZWRnZXMgaW5jaWRlbnQgdG8gdGhlIG5vZGUgYHVgIGZvciB0aGUgcHVycG9zZXMgb2Ygc2hvcnRlc3QgcGF0aAogKiB0cmF2ZXJzYWwuIEJ5IGRlZmF1bHQgdGhpcyBmdW5jdGlvbiB1c2VzIHRoZSBgZy5vdXRFZGdlc2AgZm9yIERpZ3JhcGhzIGFuZAogKiBgZy5pbmNpZGVudEVkZ2VzYCBmb3IgR3JhcGhzLgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGBPKCh8RXwgKyB8VnwpICogbG9nIHxWfClgIHRpbWUuCiAqCiAqIFtEaWprc3RyYSdzIGFsZ29yaXRobV06IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGlqa3N0cmElMjdzX2FsZ29yaXRobQogKgogKiBAcGFyYW0ge0dyYXBofSBnIHRoZSBncmFwaCB0byBzZWFyY2ggZm9yIHNob3J0ZXN0IHBhdGhzIGZyb20gKipzb3VyY2UqKgogKiBAcGFyYW0ge09iamVjdH0gc291cmNlIHRoZSBzb3VyY2UgZnJvbSB3aGljaCB0byBzdGFydCB0aGUgc2VhcmNoCiAqIEBwYXJhbSB7RnVuY3Rpb259IFt3ZWlnaHRGdW5jXSBvcHRpb25hbCB3ZWlnaHQgZnVuY3Rpb24KICogQHBhcmFtIHtGdW5jdGlvbn0gW2luY2lkZW50RnVuY10gb3B0aW9uYWwgaW5jaWRlbnQgZnVuY3Rpb24KICovCmZ1bmN0aW9uIGRpamtzdHJhKGcsIHNvdXJjZSwgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKSB7CiAgdmFyIHJlc3VsdHMgPSB7fSwKICAgICAgcHEgPSBuZXcgUHJpb3JpdHlRdWV1ZSgpOwoKICBmdW5jdGlvbiB1cGRhdGVOZWlnaGJvcnMoZSkgewogICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgdiA9IGluY2lkZW50Tm9kZXNbMF0gIT09IHUgPyBpbmNpZGVudE5vZGVzWzBdIDogaW5jaWRlbnROb2Rlc1sxXSwKICAgICAgICB2RW50cnkgPSByZXN1bHRzW3ZdLAogICAgICAgIHdlaWdodCA9IHdlaWdodEZ1bmMoZSksCiAgICAgICAgZGlzdGFuY2UgPSB1RW50cnkuZGlzdGFuY2UgKyB3ZWlnaHQ7CgogICAgaWYgKHdlaWdodCA8IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJkaWprc3RyYSBkb2VzIG5vdCBhbGxvdyBuZWdhdGl2ZSBlZGdlIHdlaWdodHMuIEJhZCBlZGdlOiAiICsgZSArICIgV2VpZ2h0OiAiICsgd2VpZ2h0KTsKICAgIH0KCiAgICBpZiAoZGlzdGFuY2UgPCB2RW50cnkuZGlzdGFuY2UpIHsKICAgICAgdkVudHJ5LmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICAgIHZFbnRyeS5wcmVkZWNlc3NvciA9IHU7CiAgICAgIHBxLmRlY3JlYXNlKHYsIGRpc3RhbmNlKTsKICAgIH0KICB9CgogIHdlaWdodEZ1bmMgPSB3ZWlnaHRGdW5jIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gMTsgfTsKICBpbmNpZGVudEZ1bmMgPSBpbmNpZGVudEZ1bmMgfHwgKGcuaXNEaXJlY3RlZCgpCiAgICAgID8gZnVuY3Rpb24odSkgeyByZXR1cm4gZy5vdXRFZGdlcyh1KTsgfQogICAgICA6IGZ1bmN0aW9uKHUpIHsgcmV0dXJuIGcuaW5jaWRlbnRFZGdlcyh1KTsgfSk7CgogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSkgewogICAgdmFyIGRpc3RhbmNlID0gdSA9PT0gc291cmNlID8gMCA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIHJlc3VsdHNbdV0gPSB7IGRpc3RhbmNlOiBkaXN0YW5jZSB9OwogICAgcHEuYWRkKHUsIGRpc3RhbmNlKTsKICB9KTsKCiAgdmFyIHUsIHVFbnRyeTsKICB3aGlsZSAocHEuc2l6ZSgpID4gMCkgewogICAgdSA9IHBxLnJlbW92ZU1pbigpOwogICAgdUVudHJ5ID0gcmVzdWx0c1t1XTsKICAgIGlmICh1RW50cnkuZGlzdGFuY2UgPT09IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSkgewogICAgICBicmVhazsKICAgIH0KCiAgICBpbmNpZGVudEZ1bmModSkuZm9yRWFjaCh1cGRhdGVOZWlnaGJvcnMpOwogIH0KCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCn0seyJjcC1kYXRhIjoxOX1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGRpamtzdHJhID0gcmVxdWlyZSgiLi9kaWprc3RyYSIpOwoKbW9kdWxlLmV4cG9ydHMgPSBkaWprc3RyYUFsbDsKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIGZpbmRzIHRoZSBzaG9ydGVzdCBwYXRoIGZyb20gZWFjaCBub2RlIHRvIGV2ZXJ5IG90aGVyCiAqIHJlYWNoYWJsZSBub2RlIGluIHRoZSBncmFwaC4gSXQgaXMgc2ltaWxhciB0byBbYWxnLmRpamtzdHJhXVtdLCBidXQKICogaW5zdGVhZCBvZiByZXR1cm5pbmcgYSBzaW5nbGUtc291cmNlIGFycmF5LCBpdCByZXR1cm5zIGEgbWFwcGluZyBvZgogKiBvZiBgc291cmNlIC0+IGFsZy5kaWprc3RhKGcsIHNvdXJjZSwgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKWAuCiAqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYW4gb3B0aW9uYWwgYHdlaWdodEZ1bmMoZSlgIHdoaWNoIHJldHVybnMgdGhlCiAqIHdlaWdodCBvZiB0aGUgZWRnZSBgZWAuIElmIG5vIHdlaWdodEZ1bmMgaXMgc3VwcGxpZWQgdGhlbiBlYWNoIGVkZ2UgaXMKICogYXNzdW1lZCB0byBoYXZlIGEgd2VpZ2h0IG9mIDEuIFRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yIGlmIGFueSBvZgogKiB0aGUgdHJhdmVyc2VkIGVkZ2VzIGhhdmUgYSBuZWdhdGl2ZSBlZGdlIHdlaWdodC4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgaW5jaWRlbnRGdW5jKHUpYCB3aGljaCByZXR1cm5zIHRoZSBpZHMgb2YKICogYWxsIGVkZ2VzIGluY2lkZW50IHRvIHRoZSBub2RlIGB1YCBmb3IgdGhlIHB1cnBvc2VzIG9mIHNob3J0ZXN0IHBhdGgKICogdHJhdmVyc2FsLiBCeSBkZWZhdWx0IHRoaXMgZnVuY3Rpb24gdXNlcyB0aGUgYG91dEVkZ2VzYCBmdW5jdGlvbiBvbiB0aGUKICogc3VwcGxpZWQgZ3JhcGguCiAqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYE8ofFZ8ICogKHxFfCArIHxWfCkgKiBsb2cgfFZ8KWAgdGltZS4KICoKICogW2FsZy5kaWprc3RyYV06IGRpamtzdHJhLmpzLmh0bWwjZGlqa3N0cmEKICoKICogQHBhcmFtIHtHcmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBzaG9ydGVzdCBwYXRocyBmcm9tICoqc291cmNlKioKICogQHBhcmFtIHtGdW5jdGlvbn0gW3dlaWdodEZ1bmNdIG9wdGlvbmFsIHdlaWdodCBmdW5jdGlvbgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaW5jaWRlbnRGdW5jXSBvcHRpb25hbCBpbmNpZGVudCBmdW5jdGlvbgogKi8KZnVuY3Rpb24gZGlqa3N0cmFBbGwoZywgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKSB7CiAgdmFyIHJlc3VsdHMgPSB7fTsKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsKICAgIHJlc3VsdHNbdV0gPSBkaWprc3RyYShnLCB1LCB3ZWlnaHRGdW5jLCBpbmNpZGVudEZ1bmMpOwogIH0pOwogIHJldHVybiByZXN1bHRzOwp9Cgp9LHsiLi9kaWprc3RyYSI6MzF9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0YXJqYW4gPSByZXF1aXJlKCIuL3RhcmphbiIpOwoKbW9kdWxlLmV4cG9ydHMgPSBmaW5kQ3ljbGVzOwoKLyoKICogR2l2ZW4gYSBEaWdyYXBoICoqZyoqIHRoaXMgZnVuY3Rpb24gcmV0dXJucyBhbGwgbm9kZXMgdGhhdCBhcmUgcGFydCBvZiBhCiAqIGN5Y2xlLiBTaW5jZSB0aGVyZSBtYXkgYmUgbW9yZSB0aGFuIG9uZSBjeWNsZSBpbiBhIGdyYXBoIHRoaXMgZnVuY3Rpb24KICogcmV0dXJucyBhbiBhcnJheSBvZiB0aGVzZSBjeWNsZXMsIHdoZXJlIGVhY2ggY3ljbGUgaXMgaXRzZWxmIHJlcHJlc2VudGVkCiAqIGJ5IGFuIGFycmF5IG9mIGlkcyBmb3IgZWFjaCBub2RlIGludm9sdmVkIGluIHRoYXQgY3ljbGUuCiAqCiAqIFthbGcuaXNBY3ljbGljXVtdIGlzIG1vcmUgZWZmaWNpZW50IGlmIHlvdSBvbmx5IG5lZWQgdG8gZGV0ZXJtaW5lIHdoZXRoZXIKICogYSBncmFwaCBoYXMgYSBjeWNsZSBvciBub3QuCiAqCiAqIFthbGcuaXNBY3ljbGljXTogaXNBY3ljbGljLmpzLmh0bWwjaXNBY3ljbGljCiAqCiAqIEBwYXJhbSB7RGlncmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBjeWNsZXMuCiAqLwpmdW5jdGlvbiBmaW5kQ3ljbGVzKGcpIHsKICByZXR1cm4gdGFyamFuKGcpLmZpbHRlcihmdW5jdGlvbihjbXB0KSB7IHJldHVybiBjbXB0Lmxlbmd0aCA+IDE7IH0pOwp9Cgp9LHsiLi90YXJqYW4iOjM5fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZsb3lkV2Fyc2hhbGw7CgovKioKICogVGhpcyBmdW5jdGlvbiBpcyBhbiBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgW0Zsb3lkLVdhcnNoYWxsIGFsZ29yaXRobV1bXSwKICogd2hpY2ggZmluZHMgdGhlIHNob3J0ZXN0IHBhdGggZnJvbSBlYWNoIG5vZGUgdG8gZXZlcnkgb3RoZXIgcmVhY2hhYmxlIG5vZGUKICogaW4gdGhlIGdyYXBoLiBJdCBpcyBzaW1pbGFyIHRvIFthbGcuZGlqa3N0cmFBbGxdW10sIGJ1dCBpdCBoYW5kbGVzIG5lZ2F0aXZlCiAqIGVkZ2Ugd2VpZ2h0cyBhbmQgaXMgbW9yZSBlZmZpY2llbnQgZm9yIHNvbWUgdHlwZXMgb2YgZ3JhcGhzLiBUaGlzIGZ1bmN0aW9uCiAqIHJldHVybnMgYSBtYXAgb2YgYHNvdXJjZSAtPiB7IHRhcmdldCAtPiB7IGRpc3RhbmNlLCBwcmVkZWNlc3NvciB9YC4gVGhlCiAqIGRpc3RhbmNlIHByb3BlcnR5IGhvbGRzIHRoZSBzdW0gb2YgdGhlIHdlaWdodHMgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YAogKiBhbG9uZyB0aGUgc2hvcnRlc3QgcGF0aCBvZiBgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZYCBpZiB0aGVyZSBpcyBubyBwYXRoCiAqIGZyb20gYHNvdXJjZWAuIFRoZSBwcmVkZWNlc3NvciBwcm9wZXJ0eSBjYW4gYmUgdXNlZCB0byB3YWxrIHRoZSBpbmRpdmlkdWFsCiAqIGVsZW1lbnRzIG9mIHRoZSBwYXRoIGZyb20gYHNvdXJjZWAgdG8gYHRhcmdldGAgaW4gcmV2ZXJzZSBvcmRlci4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgd2VpZ2h0RnVuYyhlKWAgd2hpY2ggcmV0dXJucyB0aGUKICogd2VpZ2h0IG9mIHRoZSBlZGdlIGBlYC4gSWYgbm8gd2VpZ2h0RnVuYyBpcyBzdXBwbGllZCB0aGVuIGVhY2ggZWRnZSBpcwogKiBhc3N1bWVkIHRvIGhhdmUgYSB3ZWlnaHQgb2YgMS4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgaW5jaWRlbnRGdW5jKHUpYCB3aGljaCByZXR1cm5zIHRoZSBpZHMgb2YKICogYWxsIGVkZ2VzIGluY2lkZW50IHRvIHRoZSBub2RlIGB1YCBmb3IgdGhlIHB1cnBvc2VzIG9mIHNob3J0ZXN0IHBhdGgKICogdHJhdmVyc2FsLiBCeSBkZWZhdWx0IHRoaXMgZnVuY3Rpb24gdXNlcyB0aGUgYG91dEVkZ2VzYCBmdW5jdGlvbiBvbiB0aGUKICogc3VwcGxpZWQgZ3JhcGguCiAqCiAqIFRoaXMgYWxnb3JpdGhtIHRha2VzIE8ofFZ8XjMpIHRpbWUuCiAqCiAqIFtGbG95ZC1XYXJzaGFsbCBhbGdvcml0aG1dOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GbG95ZC1XYXJzaGFsbF9hbGdvcml0aG0KICogW2FsZy5kaWprc3RyYUFsbF06IGRpamtzdHJhQWxsLmpzLmh0bWwjZGlqa3N0cmFBbGwKICoKICogQHBhcmFtIHtHcmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBzaG9ydGVzdCBwYXRocyBmcm9tICoqc291cmNlKioKICogQHBhcmFtIHtGdW5jdGlvbn0gW3dlaWdodEZ1bmNdIG9wdGlvbmFsIHdlaWdodCBmdW5jdGlvbgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaW5jaWRlbnRGdW5jXSBvcHRpb25hbCBpbmNpZGVudCBmdW5jdGlvbgogKi8KZnVuY3Rpb24gZmxveWRXYXJzaGFsbChnLCB3ZWlnaHRGdW5jLCBpbmNpZGVudEZ1bmMpIHsKICB2YXIgcmVzdWx0cyA9IHt9LAogICAgICBub2RlcyA9IGcubm9kZXMoKTsKCiAgd2VpZ2h0RnVuYyA9IHdlaWdodEZ1bmMgfHwgZnVuY3Rpb24oKSB7IHJldHVybiAxOyB9OwogIGluY2lkZW50RnVuYyA9IGluY2lkZW50RnVuYyB8fCAoZy5pc0RpcmVjdGVkKCkKICAgICAgPyBmdW5jdGlvbih1KSB7IHJldHVybiBnLm91dEVkZ2VzKHUpOyB9CiAgICAgIDogZnVuY3Rpb24odSkgeyByZXR1cm4gZy5pbmNpZGVudEVkZ2VzKHUpOyB9KTsKCiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICByZXN1bHRzW3VdID0ge307CiAgICByZXN1bHRzW3VdW3VdID0geyBkaXN0YW5jZTogMCB9OwogICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICh1ICE9PSB2KSB7CiAgICAgICAgcmVzdWx0c1t1XVt2XSA9IHsgZGlzdGFuY2U6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSB9OwogICAgICB9CiAgICB9KTsKICAgIGluY2lkZW50RnVuYyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgICB2ID0gaW5jaWRlbnROb2Rlc1swXSAhPT0gdSA/IGluY2lkZW50Tm9kZXNbMF0gOiBpbmNpZGVudE5vZGVzWzFdLAogICAgICAgICAgZCA9IHdlaWdodEZ1bmMoZSk7CiAgICAgIGlmIChkIDwgcmVzdWx0c1t1XVt2XS5kaXN0YW5jZSkgewogICAgICAgIHJlc3VsdHNbdV1bdl0gPSB7IGRpc3RhbmNlOiBkLCBwcmVkZWNlc3NvcjogdSB9OwogICAgICB9CiAgICB9KTsKICB9KTsKCiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICB2YXIgcm93SyA9IHJlc3VsdHNba107CiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgdmFyIHJvd0kgPSByZXN1bHRzW2ldOwogICAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGopIHsKICAgICAgICB2YXIgaWsgPSByb3dJW2tdOwogICAgICAgIHZhciBraiA9IHJvd0tbal07CiAgICAgICAgdmFyIGlqID0gcm93SVtqXTsKICAgICAgICB2YXIgYWx0RGlzdGFuY2UgPSBpay5kaXN0YW5jZSArIGtqLmRpc3RhbmNlOwogICAgICAgIGlmIChhbHREaXN0YW5jZSA8IGlqLmRpc3RhbmNlKSB7CiAgICAgICAgICBpai5kaXN0YW5jZSA9IGFsdERpc3RhbmNlOwogICAgICAgICAgaWoucHJlZGVjZXNzb3IgPSBrai5wcmVkZWNlc3NvcjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfSk7CgogIHJldHVybiByZXN1bHRzOwp9Cgp9LHt9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0b3Bzb3J0ID0gcmVxdWlyZSgiLi90b3Bzb3J0Iik7Cgptb2R1bGUuZXhwb3J0cyA9IGlzQWN5Y2xpYzsKCi8qCiAqIEdpdmVuIGEgRGlncmFwaCAqKmcqKiB0aGlzIGZ1bmN0aW9uIHJldHVybnMgYHRydWVgIGlmIHRoZSBncmFwaCBoYXMgbm8KICogY3ljbGVzIGFuZCByZXR1cm5zIGBmYWxzZWAgaWYgaXQgZG9lcy4gVGhpcyBhbGdvcml0aG0gcmV0dXJucyBhcyBzb29uIGFzIGl0CiAqIGRldGVjdHMgdGhlIGZpcnN0IGN5Y2xlLgogKgogKiBVc2UgW2FsZy5maW5kQ3ljbGVzXVtdIGlmIHlvdSBuZWVkIHRoZSBhY3R1YWwgbGlzdCBvZiBjeWNsZXMgaW4gYSBncmFwaC4KICoKICogW2FsZy5maW5kQ3ljbGVzXTogZmluZEN5Y2xlcy5qcy5odG1sI2ZpbmRDeWNsZXMKICoKICogQHBhcmFtIHtEaWdyYXBofSBnIHRoZSBncmFwaCB0byB0ZXN0IGZvciBjeWNsZXMKICovCmZ1bmN0aW9uIGlzQWN5Y2xpYyhnKSB7CiAgdHJ5IHsKICAgIHRvcHNvcnQoZyk7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGUgaW5zdGFuY2VvZiB0b3Bzb3J0LkN5Y2xlRXhjZXB0aW9uKSByZXR1cm4gZmFsc2U7CiAgICB0aHJvdyBlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQoKfSx7Ii4vdG9wc29ydCI6NDB9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IHBvc3RvcmRlcjsKCi8vIFBvc3RvcmRlciB0cmF2ZXJzYWwgb2YgZywgY2FsbGluZyBmIGZvciBlYWNoIHZpc2l0ZWQgbm9kZS4gQXNzdW1lcyB0aGUgZ3JhcGgKLy8gaXMgYSB0cmVlLgpmdW5jdGlvbiBwb3N0b3JkZXIoZywgcm9vdCwgZikgewogIHZhciB2aXNpdGVkID0gbmV3IFNldCgpOwogIGlmIChnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGZ1bmN0aW9uIG9ubHkgd29ya3MgZm9yIHVuZGlyZWN0ZWQgZ3JhcGhzIik7CiAgfQogIGZ1bmN0aW9uIGRmcyh1LCBwcmV2KSB7CiAgICBpZiAodmlzaXRlZC5oYXModSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgaW5wdXQgZ3JhcGggaXMgbm90IGEgdHJlZTogIiArIGcpOwogICAgfQogICAgdmlzaXRlZC5hZGQodSk7CiAgICBnLm5laWdoYm9ycyh1KS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgaWYgKHYgIT09IHByZXYpIGRmcyh2LCB1KTsKICAgIH0pOwogICAgZih1KTsKICB9CiAgZGZzKHJvb3QpOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSwzNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IHByZW9yZGVyOwoKLy8gUHJlb3JkZXIgdHJhdmVyc2FsIG9mIGcsIGNhbGxpbmcgZiBmb3IgZWFjaCB2aXNpdGVkIG5vZGUuIEFzc3VtZXMgdGhlIGdyYXBoCi8vIGlzIGEgdHJlZS4KZnVuY3Rpb24gcHJlb3JkZXIoZywgcm9vdCwgZikgewogIHZhciB2aXNpdGVkID0gbmV3IFNldCgpOwogIGlmIChnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGZ1bmN0aW9uIG9ubHkgd29ya3MgZm9yIHVuZGlyZWN0ZWQgZ3JhcGhzIik7CiAgfQogIGZ1bmN0aW9uIGRmcyh1LCBwcmV2KSB7CiAgICBpZiAodmlzaXRlZC5oYXModSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgaW5wdXQgZ3JhcGggaXMgbm90IGEgdHJlZTogIiArIGcpOwogICAgfQogICAgdmlzaXRlZC5hZGQodSk7CiAgICBmKHUpOwogICAgZy5uZWlnaGJvcnModSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICh2ICE9PSBwcmV2KSBkZnModiwgdSk7CiAgICB9KTsKICB9CiAgZGZzKHJvb3QpOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBHcmFwaCA9IHJlcXVpcmUoIi4uL0dyYXBoIiksCiAgICBQcmlvcml0eVF1ZXVlID0gcmVxdWlyZSgiY3AtZGF0YSIpLlByaW9yaXR5UXVldWU7Cgptb2R1bGUuZXhwb3J0cyA9IHByaW07CgovKioKICogW1ByaW0ncyBhbGdvcml0aG1dW10gdGFrZXMgYSBjb25uZWN0ZWQgdW5kaXJlY3RlZCBncmFwaCBhbmQgZ2VuZXJhdGVzIGEKICogW21pbmltdW0gc3Bhbm5pbmcgdHJlZV1bXS4gVGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBtaW5pbXVtIHNwYW5uaW5nCiAqIHRyZWUgYXMgYW4gdW5kaXJlY3RlZCBncmFwaC4gVGhpcyBhbGdvcml0aG0gaXMgZGVyaXZlZCBmcm9tIHRoZSBkZXNjcmlwdGlvbgogKiBpbiAiSW50cm9kdWN0aW9uIHRvIEFsZ29yaXRobXMiLCBUaGlyZCBFZGl0aW9uLCBDb3JtZW4sIGV0IGFsLiwgUGcgNjM0LgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGEgYHdlaWdodEZ1bmMoZSlgIHdoaWNoIHJldHVybnMgdGhlIHdlaWdodCBvZiB0aGUgZWRnZQogKiBgZWAuIEl0IHRocm93cyBhbiBFcnJvciBpZiB0aGUgZ3JhcGggaXMgbm90IGNvbm5lY3RlZC4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBgTyh8RXwgbG9nIHxWfClgIHRpbWUuCiAqCiAqIFtQcmltJ3MgYWxnb3JpdGhtXTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbSdzX2FsZ29yaXRobQogKiBbbWluaW11bSBzcGFubmluZyB0cmVlXTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTWluaW11bV9zcGFubmluZ190cmVlCiAqCiAqIEBwYXJhbSB7R3JhcGh9IGcgdGhlIGdyYXBoIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIG1pbmltdW0gc3Bhbm5pbmcgdHJlZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSB3ZWlnaHRGdW5jIHRoZSB3ZWlnaHQgZnVuY3Rpb24gdG8gdXNlCiAqLwpmdW5jdGlvbiBwcmltKGcsIHdlaWdodEZ1bmMpIHsKICB2YXIgcmVzdWx0ID0gbmV3IEdyYXBoKCksCiAgICAgIHBhcmVudHMgPSB7fSwKICAgICAgcHEgPSBuZXcgUHJpb3JpdHlRdWV1ZSgpLAogICAgICB1OwoKICBmdW5jdGlvbiB1cGRhdGVOZWlnaGJvcnMoZSkgewogICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgdiA9IGluY2lkZW50Tm9kZXNbMF0gIT09IHUgPyBpbmNpZGVudE5vZGVzWzBdIDogaW5jaWRlbnROb2Rlc1sxXSwKICAgICAgICBwcmkgPSBwcS5wcmlvcml0eSh2KTsKICAgIGlmIChwcmkgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgZWRnZVdlaWdodCA9IHdlaWdodEZ1bmMoZSk7CiAgICAgIGlmIChlZGdlV2VpZ2h0IDwgcHJpKSB7CiAgICAgICAgcGFyZW50c1t2XSA9IHU7CiAgICAgICAgcHEuZGVjcmVhc2UodiwgZWRnZVdlaWdodCk7CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChnLm9yZGVyKCkgPT09IDApIHsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsKICAgIHBxLmFkZCh1LCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpOwogICAgcmVzdWx0LmFkZE5vZGUodSk7CiAgfSk7CgogIC8vIFN0YXJ0IGZyb20gYW4gYXJiaXRyYXJ5IG5vZGUKICBwcS5kZWNyZWFzZShnLm5vZGVzKClbMF0sIDApOwoKICB2YXIgaW5pdCA9IGZhbHNlOwogIHdoaWxlIChwcS5zaXplKCkgPiAwKSB7CiAgICB1ID0gcHEucmVtb3ZlTWluKCk7CiAgICBpZiAodSBpbiBwYXJlbnRzKSB7CiAgICAgIHJlc3VsdC5hZGRFZGdlKG51bGwsIHUsIHBhcmVudHNbdV0pOwogICAgfSBlbHNlIGlmIChpbml0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgZ3JhcGggaXMgbm90IGNvbm5lY3RlZDogIiArIGcpOwogICAgfSBlbHNlIHsKICAgICAgaW5pdCA9IHRydWU7CiAgICB9CgogICAgZy5pbmNpZGVudEVkZ2VzKHUpLmZvckVhY2godXBkYXRlTmVpZ2hib3JzKTsKICB9CgogIHJldHVybiByZXN1bHQ7Cn0KCn0seyIuLi9HcmFwaCI6MjksImNwLWRhdGEiOjE5fV0sMzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHRhcmphbjsKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIGlzIGFuIGltcGxlbWVudGF0aW9uIG9mIFtUYXJqYW4ncyBhbGdvcml0aG1dW10gd2hpY2ggZmluZHMKICogYWxsIFtzdHJvbmdseSBjb25uZWN0ZWQgY29tcG9uZW50c11bXSBpbiB0aGUgZGlyZWN0ZWQgZ3JhcGggKipnKiouIEVhY2gKICogc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudCBpcyBjb21wb3NlZCBvZiBub2RlcyB0aGF0IGNhbiByZWFjaCBhbGwgb3RoZXIKICogbm9kZXMgaW4gdGhlIGNvbXBvbmVudCB2aWEgZGlyZWN0ZWQgZWRnZXMuIEEgc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudAogKiBjYW4gY29uc2lzdCBvZiBhIHNpbmdsZSBub2RlIGlmIHRoYXQgbm9kZSBjYW5ub3QgYm90aCByZWFjaCBhbmQgYmUgcmVhY2hlZAogKiBieSBhbnkgb3RoZXIgc3BlY2lmaWMgbm9kZSBpbiB0aGUgZ3JhcGguIENvbXBvbmVudHMgb2YgbW9yZSB0aGFuIG9uZSBub2RlCiAqIGFyZSBndWFyYW50ZWVkIHRvIGhhdmUgYXQgbGVhc3Qgb25lIGN5Y2xlLgogKgogKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYW4gYXJyYXkgb2YgY29tcG9uZW50cy4gRWFjaCBjb21wb25lbnQgaXMgaXRzZWxmIGFuCiAqIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIGlkcyBvZiBhbGwgbm9kZXMgaW4gdGhlIGNvbXBvbmVudC4KICoKICogW1RhcmphbidzIGFsZ29yaXRobV06IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVGFyamFuJ3Nfc3Ryb25nbHlfY29ubmVjdGVkX2NvbXBvbmVudHNfYWxnb3JpdGhtCiAqIFtzdHJvbmdseSBjb25uZWN0ZWQgY29tcG9uZW50c106IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3Ryb25nbHlfY29ubmVjdGVkX2NvbXBvbmVudAogKgogKiBAcGFyYW0ge0RpZ3JhcGh9IGcgdGhlIGdyYXBoIHRvIHNlYXJjaCBmb3Igc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudHMKICovCmZ1bmN0aW9uIHRhcmphbihnKSB7CiAgaWYgKCFnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJ0YXJqYW4gY2FuIG9ubHkgYmUgYXBwbGllZCB0byBhIGRpcmVjdGVkIGdyYXBoLiBCYWQgaW5wdXQ6ICIgKyBnKTsKICB9CgogIHZhciBpbmRleCA9IDAsCiAgICAgIHN0YWNrID0gW10sCiAgICAgIHZpc2l0ZWQgPSB7fSwgLy8gbm9kZSBpZCAtPiB7IG9uU3RhY2ssIGxvd2xpbmssIGluZGV4IH0KICAgICAgcmVzdWx0cyA9IFtdOwoKICBmdW5jdGlvbiBkZnModSkgewogICAgdmFyIGVudHJ5ID0gdmlzaXRlZFt1XSA9IHsKICAgICAgb25TdGFjazogdHJ1ZSwKICAgICAgbG93bGluazogaW5kZXgsCiAgICAgIGluZGV4OiBpbmRleCsrCiAgICB9OwogICAgc3RhY2sucHVzaCh1KTsKCiAgICBnLnN1Y2Nlc3NvcnModSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICghKHYgaW4gdmlzaXRlZCkpIHsKICAgICAgICBkZnModik7CiAgICAgICAgZW50cnkubG93bGluayA9IE1hdGgubWluKGVudHJ5Lmxvd2xpbmssIHZpc2l0ZWRbdl0ubG93bGluayk7CiAgICAgIH0gZWxzZSBpZiAodmlzaXRlZFt2XS5vblN0YWNrKSB7CiAgICAgICAgZW50cnkubG93bGluayA9IE1hdGgubWluKGVudHJ5Lmxvd2xpbmssIHZpc2l0ZWRbdl0uaW5kZXgpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAoZW50cnkubG93bGluayA9PT0gZW50cnkuaW5kZXgpIHsKICAgICAgdmFyIGNtcHQgPSBbXSwKICAgICAgICAgIHY7CiAgICAgIGRvIHsKICAgICAgICB2ID0gc3RhY2sucG9wKCk7CiAgICAgICAgdmlzaXRlZFt2XS5vblN0YWNrID0gZmFsc2U7CiAgICAgICAgY21wdC5wdXNoKHYpOwogICAgICB9IHdoaWxlICh1ICE9PSB2KTsKICAgICAgcmVzdWx0cy5wdXNoKGNtcHQpOwogICAgfQogIH0KCiAgZy5ub2RlcygpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgaWYgKCEodSBpbiB2aXNpdGVkKSkgewogICAgICBkZnModSk7CiAgICB9CiAgfSk7CgogIHJldHVybiByZXN1bHRzOwp9Cgp9LHt9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gdG9wc29ydDsKdG9wc29ydC5DeWNsZUV4Y2VwdGlvbiA9IEN5Y2xlRXhjZXB0aW9uOwoKLyoKICogR2l2ZW4gYSBncmFwaCAqKmcqKiwgdGhpcyBmdW5jdGlvbiByZXR1cm5zIGFuIG9yZGVyZWQgbGlzdCBvZiBub2RlcyBzdWNoCiAqIHRoYXQgZm9yIGVhY2ggZWRnZSBgdSAtPiB2YCwgYHVgIGFwcGVhcnMgYmVmb3JlIGB2YCBpbiB0aGUgbGlzdC4gSWYgdGhlCiAqIGdyYXBoIGhhcyBhIGN5Y2xlIGl0IGlzIGltcG9zc2libGUgdG8gZ2VuZXJhdGUgc3VjaCBhIGxpc3QgYW5kCiAqICoqQ3ljbGVFeGNlcHRpb24qKiBpcyB0aHJvd24uCiAqCiAqIFNlZSBbdG9wb2xvZ2ljYWwgc29ydGluZ10oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVG9wb2xvZ2ljYWxfc29ydGluZykKICogZm9yIG1vcmUgZGV0YWlscyBhYm91dCBob3cgdGhpcyBhbGdvcml0aG0gd29ya3MuCiAqCiAqIEBwYXJhbSB7RGlncmFwaH0gZyB0aGUgZ3JhcGggdG8gc29ydAogKi8KZnVuY3Rpb24gdG9wc29ydChnKSB7CiAgaWYgKCFnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJ0b3Bzb3J0IGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gYSBkaXJlY3RlZCBncmFwaC4gQmFkIGlucHV0OiAiICsgZyk7CiAgfQoKICB2YXIgdmlzaXRlZCA9IHt9OwogIHZhciBzdGFjayA9IHt9OwogIHZhciByZXN1bHRzID0gW107CgogIGZ1bmN0aW9uIHZpc2l0KG5vZGUpIHsKICAgIGlmIChub2RlIGluIHN0YWNrKSB7CiAgICAgIHRocm93IG5ldyBDeWNsZUV4Y2VwdGlvbigpOwogICAgfQoKICAgIGlmICghKG5vZGUgaW4gdmlzaXRlZCkpIHsKICAgICAgc3RhY2tbbm9kZV0gPSB0cnVlOwogICAgICB2aXNpdGVkW25vZGVdID0gdHJ1ZTsKICAgICAgZy5wcmVkZWNlc3NvcnMobm9kZSkuZm9yRWFjaChmdW5jdGlvbihwcmVkKSB7CiAgICAgICAgdmlzaXQocHJlZCk7CiAgICAgIH0pOwogICAgICBkZWxldGUgc3RhY2tbbm9kZV07CiAgICAgIHJlc3VsdHMucHVzaChub2RlKTsKICAgIH0KICB9CgogIHZhciBzaW5rcyA9IGcuc2lua3MoKTsKICBpZiAoZy5vcmRlcigpICE9PSAwICYmIHNpbmtzLmxlbmd0aCA9PT0gMCkgewogICAgdGhyb3cgbmV3IEN5Y2xlRXhjZXB0aW9uKCk7CiAgfQoKICBnLnNpbmtzKCkuZm9yRWFjaChmdW5jdGlvbihzaW5rKSB7CiAgICB2aXNpdChzaW5rKTsKICB9KTsKCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIEN5Y2xlRXhjZXB0aW9uKCkge30KCkN5Y2xlRXhjZXB0aW9uLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAiR3JhcGggaGFzIGF0IGxlYXN0IG9uZSBjeWNsZSI7Cn07Cgp9LHt9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIFRoaXMgZmlsZSBwcm92aWRlcyBhIGhlbHBlciBmdW5jdGlvbiB0aGF0IG1peGVzLWluIERvdCBiZWhhdmlvciB0byBhbgovLyBleGlzdGluZyBncmFwaCBwcm90b3R5cGUuCgovKiBqc2hpbnQgLVcwNzkgKi8KdmFyIFNldCA9IHJlcXVpcmUoImNwLWRhdGEiKS5TZXQ7Ci8qIGpzaGludCArVzA3OSAqLwoKbW9kdWxlLmV4cG9ydHMgPSBjb21wb3VuZGlmeTsKCi8vIEV4dGVuZHMgdGhlIGdpdmVuIFN1cGVyQ29uc3RydWN0b3Igd2l0aCB0aGUgYWJpbGl0eSBmb3Igbm9kZXMgdG8gY29udGFpbgovLyBvdGhlciBub2Rlcy4gQSBzcGVjaWFsIG5vZGUgaWQgYG51bGxgIGlzIHVzZWQgdG8gaW5kaWNhdGUgdGhlIHJvb3QgZ3JhcGguCmZ1bmN0aW9uIGNvbXBvdW5kaWZ5KFN1cGVyQ29uc3RydWN0b3IpIHsKICBmdW5jdGlvbiBDb25zdHJ1Y3RvcigpIHsKICAgIFN1cGVyQ29uc3RydWN0b3IuY2FsbCh0aGlzKTsKCiAgICAvLyBNYXAgb2Ygb2JqZWN0IGlkIC0+IHBhcmVudCBpZCAob3IgbnVsbCBmb3Igcm9vdCBncmFwaCkKICAgIHRoaXMuX3BhcmVudHMgPSB7fTsKCiAgICAvLyBNYXAgb2YgaWQgKG9yIG51bGwpIC0+IGNoaWxkcmVuIHNldAogICAgdGhpcy5fY2hpbGRyZW4gPSB7fTsKICAgIHRoaXMuX2NoaWxkcmVuW251bGxdID0gbmV3IFNldCgpOwogIH0KCiAgQ29uc3RydWN0b3IucHJvdG90eXBlID0gbmV3IFN1cGVyQ29uc3RydWN0b3IoKTsKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25zdHJ1Y3RvcjsKCiAgQ29uc3RydWN0b3IucHJvdG90eXBlLnBhcmVudCA9IGZ1bmN0aW9uKHUsIHBhcmVudCkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudHNbdV07CiAgICB9CgogICAgaWYgKHUgPT09IHBhcmVudCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBtYWtlICIgKyB1ICsgIiBhIHBhcmVudCBvZiBpdHNlbGYiKTsKICAgIH0KICAgIGlmIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgdGhpcy5fc3RyaWN0R2V0Tm9kZShwYXJlbnQpOwogICAgfQoKICAgIHRoaXMuX2NoaWxkcmVuW3RoaXMuX3BhcmVudHNbdV1dLnJlbW92ZSh1KTsKICAgIHRoaXMuX3BhcmVudHNbdV0gPSBwYXJlbnQ7CiAgICB0aGlzLl9jaGlsZHJlbltwYXJlbnRdLmFkZCh1KTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY2hpbGRyZW4gPSBmdW5jdGlvbih1KSB7CiAgICBpZiAodSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX2NoaWxkcmVuW3VdLmtleXMoKTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuYWRkTm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB1ID0gU3VwZXJDb25zdHJ1Y3Rvci5wcm90b3R5cGUuYWRkTm9kZS5jYWxsKHRoaXMsIHUsIHZhbHVlKTsKICAgIHRoaXMuX3BhcmVudHNbdV0gPSBudWxsOwogICAgdGhpcy5fY2hpbGRyZW5bdV0gPSBuZXcgU2V0KCk7CiAgICB0aGlzLl9jaGlsZHJlbltudWxsXS5hZGQodSk7CiAgICByZXR1cm4gdTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuZGVsTm9kZSA9IGZ1bmN0aW9uKHUpIHsKICAgIC8vIFByb21vdGUgYWxsIGNoaWxkcmVuIHRvIHRoZSBwYXJlbnQgb2YgdGhlIHN1YmdyYXBoCiAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnQodSk7CiAgICB0aGlzLl9jaGlsZHJlblt1XS5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLnBhcmVudChjaGlsZCwgcGFyZW50KTsKICAgIH0sIHRoaXMpOwoKICAgIHRoaXMuX2NoaWxkcmVuW3BhcmVudF0ucmVtb3ZlKHUpOwogICAgZGVsZXRlIHRoaXMuX3BhcmVudHNbdV07CiAgICBkZWxldGUgdGhpcy5fY2hpbGRyZW5bdV07CgogICAgcmV0dXJuIFN1cGVyQ29uc3RydWN0b3IucHJvdG90eXBlLmRlbE5vZGUuY2FsbCh0aGlzLCB1KTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvcHkgPSBTdXBlckNvbnN0cnVjdG9yLnByb3RvdHlwZS5jb3B5LmNhbGwodGhpcyk7CiAgICB0aGlzLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIGNvcHkucGFyZW50KHUsIHRoaXMucGFyZW50KHUpKTsKICAgIH0sIHRoaXMpOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgQ29uc3RydWN0b3IucHJvdG90eXBlLmZpbHRlck5vZGVzID0gZnVuY3Rpb24oZmlsdGVyKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgY29weSA9IFN1cGVyQ29uc3RydWN0b3IucHJvdG90eXBlLmZpbHRlck5vZGVzLmNhbGwodGhpcywgZmlsdGVyKTsKCiAgICB2YXIgcGFyZW50cyA9IHt9OwogICAgZnVuY3Rpb24gZmluZFBhcmVudCh1KSB7CiAgICAgIHZhciBwYXJlbnQgPSBzZWxmLnBhcmVudCh1KTsKICAgICAgaWYgKHBhcmVudCA9PT0gbnVsbCB8fCBjb3B5Lmhhc05vZGUocGFyZW50KSkgewogICAgICAgIHBhcmVudHNbdV0gPSBwYXJlbnQ7CiAgICAgICAgcmV0dXJuIHBhcmVudDsKICAgICAgfSBlbHNlIGlmIChwYXJlbnQgaW4gcGFyZW50cykgewogICAgICAgIHJldHVybiBwYXJlbnRzW3BhcmVudF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZpbmRQYXJlbnQocGFyZW50KTsKICAgICAgfQogICAgfQoKICAgIGNvcHkuZWFjaE5vZGUoZnVuY3Rpb24odSkgeyBjb3B5LnBhcmVudCh1LCBmaW5kUGFyZW50KHUpKTsgfSk7CgogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgcmV0dXJuIENvbnN0cnVjdG9yOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBHcmFwaCA9IHJlcXVpcmUoIi4uL0dyYXBoIiksCiAgICBEaWdyYXBoID0gcmVxdWlyZSgiLi4vRGlncmFwaCIpLAogICAgQ0dyYXBoID0gcmVxdWlyZSgiLi4vQ0dyYXBoIiksCiAgICBDRGlncmFwaCA9IHJlcXVpcmUoIi4uL0NEaWdyYXBoIik7CgpleHBvcnRzLmRlY29kZSA9IGZ1bmN0aW9uKG5vZGVzLCBlZGdlcywgQ3RvcikgewogIEN0b3IgPSBDdG9yIHx8IERpZ3JhcGg7CgogIGlmICh0eXBlT2Yobm9kZXMpICE9PSAiQXJyYXkiKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vZGVzIGlzIG5vdCBhbiBBcnJheSIpOwogIH0KCiAgaWYgKHR5cGVPZihlZGdlcykgIT09ICJBcnJheSIpIHsKICAgIHRocm93IG5ldyBFcnJvcigiZWRnZXMgaXMgbm90IGFuIEFycmF5Iik7CiAgfQoKICBpZiAodHlwZW9mIEN0b3IgPT09ICJzdHJpbmciKSB7CiAgICBzd2l0Y2goQ3RvcikgewogICAgICBjYXNlICJncmFwaCI6IEN0b3IgPSBHcmFwaDsgYnJlYWs7CiAgICAgIGNhc2UgImRpZ3JhcGgiOiBDdG9yID0gRGlncmFwaDsgYnJlYWs7CiAgICAgIGNhc2UgImNncmFwaCI6IEN0b3IgPSBDR3JhcGg7IGJyZWFrOwogICAgICBjYXNlICJjZGlncmFwaCI6IEN0b3IgPSBDRGlncmFwaDsgYnJlYWs7CiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIGdyYXBoIHR5cGU6ICIgKyBDdG9yKTsKICAgIH0KICB9CgogIHZhciBncmFwaCA9IG5ldyBDdG9yKCk7CgogIG5vZGVzLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgZ3JhcGguYWRkTm9kZSh1LmlkLCB1LnZhbHVlKTsKICB9KTsKCiAgLy8gSWYgdGhlIGdyYXBoIGlzIGNvbXBvdW5kLCBzZXQgdXAgY2hpbGRyZW4uLi4KICBpZiAoZ3JhcGgucGFyZW50KSB7CiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgICAgaWYgKHUuY2hpbGRyZW4pIHsKICAgICAgICB1LmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgZ3JhcGgucGFyZW50KHYsIHUuaWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIGVkZ2VzLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgZ3JhcGguYWRkRWRnZShlLmlkLCBlLnUsIGUudiwgZS52YWx1ZSk7CiAgfSk7CgogIHJldHVybiBncmFwaDsKfTsKCmV4cG9ydHMuZW5jb2RlID0gZnVuY3Rpb24oZ3JhcGgpIHsKICB2YXIgbm9kZXMgPSBbXTsKICB2YXIgZWRnZXMgPSBbXTsKCiAgZ3JhcGguZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIHZhciBub2RlID0ge2lkOiB1LCB2YWx1ZTogdmFsdWV9OwogICAgaWYgKGdyYXBoLmNoaWxkcmVuKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGdyYXBoLmNoaWxkcmVuKHUpOwogICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgbm9kZS5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICB9CiAgICB9CiAgICBub2Rlcy5wdXNoKG5vZGUpOwogIH0pOwoKICBncmFwaC5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgZWRnZXMucHVzaCh7aWQ6IGUsIHU6IHUsIHY6IHYsIHZhbHVlOiB2YWx1ZX0pOwogIH0pOwoKICB2YXIgdHlwZTsKICBpZiAoZ3JhcGggaW5zdGFuY2VvZiBDRGlncmFwaCkgewogICAgdHlwZSA9ICJjZGlncmFwaCI7CiAgfSBlbHNlIGlmIChncmFwaCBpbnN0YW5jZW9mIENHcmFwaCkgewogICAgdHlwZSA9ICJjZ3JhcGgiOwogIH0gZWxzZSBpZiAoZ3JhcGggaW5zdGFuY2VvZiBEaWdyYXBoKSB7CiAgICB0eXBlID0gImRpZ3JhcGgiOwogIH0gZWxzZSBpZiAoZ3JhcGggaW5zdGFuY2VvZiBHcmFwaCkgewogICAgdHlwZSA9ICJncmFwaCI7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZGV0ZXJtaW5lIHR5cGUgb2YgZ3JhcGg6ICIgKyBncmFwaCk7CiAgfQoKICByZXR1cm4geyBub2Rlczogbm9kZXMsIGVkZ2VzOiBlZGdlcywgdHlwZTogdHlwZSB9Owp9OwoKZnVuY3Rpb24gdHlwZU9mKG9iaikgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKS5zbGljZSg4LCAtMSk7Cn0KCn0seyIuLi9DRGlncmFwaCI6MjYsIi4uL0NHcmFwaCI6MjcsIi4uL0RpZ3JhcGgiOjI4LCIuLi9HcmFwaCI6Mjl9XSw0MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgpleHBvcnRzLmFsbCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07Cn07CgpleHBvcnRzLm5vZGVzRnJvbUxpc3QgPSBmdW5jdGlvbihub2RlcykgewogIHZhciBzZXQgPSBuZXcgU2V0KG5vZGVzKTsKICByZXR1cm4gZnVuY3Rpb24odSkgewogICAgcmV0dXJuIHNldC5oYXModSk7CiAgfTsKfTsKCn0seyJjcC1kYXRhIjoxOX1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEdyYXBoID0gcmVxdWlyZSgiLi9HcmFwaCIpLAogICAgRGlncmFwaCA9IHJlcXVpcmUoIi4vRGlncmFwaCIpOwoKLy8gU2lkZS1lZmZlY3QgYmFzZWQgY2hhbmdlcyBhcmUgbG91c3ksIGJ1dCBub2RlIGRvZXNuJ3Qgc2VlbSB0byByZXNvbHZlIHRoZQovLyByZXF1aXJlcyBjeWNsZS4KCi8qKgogKiBSZXR1cm5zIGEgbmV3IGRpcmVjdGVkIGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgZnJvbSB0aGlzIGdyYXBoLiBUaGUKICogbmV3IGdyYXBoIHdpbGwgaGF2ZSB0aGUgc2FtZSBub2RlcywgYnV0IHdpbGwgaGF2ZSB0d2ljZSB0aGUgbnVtYmVyIG9mIGVkZ2VzOgogKiBlYWNoIGVkZ2UgaXMgc3BsaXQgaW50byB0d28gZWRnZXMgd2l0aCBvcHBvc2l0ZSBkaXJlY3Rpb25zLiBFZGdlIGlkcywKICogY29uc2VxdWVudGx5LCBhcmUgbm90IHByZXNlcnZlZCBieSB0aGlzIHRyYW5zZm9ybWF0aW9uLgogKi8KR3JhcGgucHJvdG90eXBlLnRvRGlncmFwaCA9CkdyYXBoLnByb3RvdHlwZS5hc0RpcmVjdGVkID0gZnVuY3Rpb24oKSB7CiAgdmFyIGcgPSBuZXcgRGlncmFwaCgpOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsgZy5hZGROb2RlKHUsIHZhbHVlKTsgfSk7CiAgdGhpcy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIGcuYWRkRWRnZShudWxsLCB2LCB1LCB2YWx1ZSk7CiAgfSk7CiAgcmV0dXJuIGc7Cn07CgovKioKICogUmV0dXJucyBhIG5ldyB1bmRpcmVjdGVkIGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgZnJvbSB0aGlzIGdyYXBoLgogKiBUaGUgbmV3IGdyYXBoIHdpbGwgaGF2ZSB0aGUgc2FtZSBub2RlcywgYnV0IHRoZSBlZGdlcyB3aWxsIGJlIG1hZGUKICogdW5kaXJlY3RlZC4gRWRnZSBpZHMgYXJlIHByZXNlcnZlZCBpbiB0aGlzIHRyYW5zZm9ybWF0aW9uLgogKi8KRGlncmFwaC5wcm90b3R5cGUudG9HcmFwaCA9CkRpZ3JhcGgucHJvdG90eXBlLmFzVW5kaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHZhciBnID0gbmV3IEdyYXBoKCk7CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgeyBnLmFkZE5vZGUodSwgdmFsdWUpOyB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBnLmFkZEVkZ2UoZSwgdSwgdiwgdmFsdWUpOwogIH0pOwogIHJldHVybiBnOwp9OwoKfSx7Ii4vRGlncmFwaCI6MjgsIi4vR3JhcGgiOjI5fV0sNDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBSZXR1cm5zIGFuIGFycmF5IG9mIGFsbCB2YWx1ZXMgZm9yIHByb3BlcnRpZXMgb2YgKipvKiouCmV4cG9ydHMudmFsdWVzID0gZnVuY3Rpb24obykgewogIHZhciBrcyA9IE9iamVjdC5rZXlzKG8pLAogICAgICBsZW4gPSBrcy5sZW5ndGgsCiAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW4pLAogICAgICBpOwogIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgcmVzdWx0W2ldID0gb1trc1tpXV07CiAgfQogIHJldHVybiByZXN1bHQ7Cn07Cgp9LHt9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gJzAuNy40JzsKCn0se31dfSx7fSxbMV0pCjsKam9pbnQubGF5b3V0LkRpcmVjdGVkR3JhcGggPSB7CgogICAgbGF5b3V0OiBmdW5jdGlvbihncmFwaCwgb3B0KSB7CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgdmFyIGlucHV0R3JhcGggPSB0aGlzLl9wcmVwYXJlRGF0YShncmFwaCk7CiAgICAgICAgdmFyIHJ1bm5lciA9IGRhZ3JlLmxheW91dCgpOwoKICAgICAgICBpZiAob3B0LmRlYnVnTGV2ZWwpIHsgcnVubmVyLmRlYnVnTGV2ZWwob3B0LmRlYnVnTGV2ZWwpOyB9CiAgICAgICAgaWYgKG9wdC5yYW5rRGlyKSB7IHJ1bm5lci5yYW5rRGlyKG9wdC5yYW5rRGlyKTsgfQogICAgICAgIGlmIChvcHQucmFua1NlcCkgeyBydW5uZXIucmFua1NlcChvcHQucmFua1NlcCk7IH0KICAgICAgICBpZiAob3B0LmVkZ2VTZXApIHsgcnVubmVyLmVkZ2VTZXAob3B0LmVkZ2VTZXApOyB9CiAgICAgICAgaWYgKG9wdC5ub2RlU2VwKSB7IHJ1bm5lci5ub2RlU2VwKG9wdC5ub2RlU2VwKTsgfQoKICAgICAgICB2YXIgbGF5b3V0R3JhcGggPSBydW5uZXIucnVuKGlucHV0R3JhcGgpOwogICAgICAgIAogICAgICAgIGxheW91dEdyYXBoLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUuZHVtbXkpIHsKCgkJdmFyIGNlbGwgPSBncmFwaC5nZXRDZWxsKHUpOwoJCW9wdC5zZXRQb3NpdGlvbiAKCQkgICAgPyBvcHQuc2V0UG9zaXRpb24oY2VsbCwgdmFsdWUpCgkJICAgIDogZ3JhcGguZ2V0KCdjZWxscycpLmdldCh1KS5zZXQoJ3Bvc2l0aW9uJywgewoJCQl4OiB2YWx1ZS54IC0gdmFsdWUud2lkdGgvMiwKCQkJeTogdmFsdWUueSAtIHZhbHVlLmhlaWdodC8yCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9wdC5zZXRMaW5rVmVydGljZXMpIHsKCiAgICAgICAgICAgIGxheW91dEdyYXBoLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IGdyYXBoLmdldENlbGwoZSk7CiAgICAgICAgICAgICAgICBpZiAobGluaykgewoJCSAgICBvcHQuc2V0VmVydGljZXMKCQkJPyBvcHQuc2V0VmVydGljZXMobGluaywgdmFsdWUucG9pbnRzKQoJCQk6IGxpbmsuc2V0KCd2ZXJ0aWNlcycsIHZhbHVlLnBvaW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgd2lkdGg6IGxheW91dEdyYXBoLmdyYXBoKCkud2lkdGgsIGhlaWdodDogbGF5b3V0R3JhcGguZ3JhcGgoKS5oZWlnaHQgfTsKICAgIH0sCiAgICAKICAgIF9wcmVwYXJlRGF0YTogZnVuY3Rpb24oZ3JhcGgpIHsKCiAgICAgICAgdmFyIGRhZ3JlR3JhcGggPSBuZXcgZGFncmUuRGlncmFwaCgpOwoKICAgICAgICAvLyBGb3IgZWFjaCBlbGVtZW50LgogICAgICAgIF8uZWFjaChncmFwaC5nZXRFbGVtZW50cygpLCBmdW5jdGlvbihjZWxsKSB7CgogICAgICAgICAgICBpZiAoZGFncmVHcmFwaC5oYXNOb2RlKGNlbGwuaWQpKSByZXR1cm47CgogICAgICAgICAgICBkYWdyZUdyYXBoLmFkZE5vZGUoY2VsbC5pZCwgewogICAgICAgICAgICAgICAgd2lkdGg6IGNlbGwuZ2V0KCdzaXplJykud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGNlbGwuZ2V0KCdzaXplJykuaGVpZ2h0LAogICAgICAgICAgICAgICAgcmFuazogY2VsbC5nZXQoJ3JhbmsnKQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gRm9yIGVhY2ggbGluay4KICAgICAgICBfLmVhY2goZ3JhcGguZ2V0TGlua3MoKSwgZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgaWYgKGRhZ3JlR3JhcGguaGFzRWRnZShjZWxsLmlkKSkgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIHNvdXJjZUlkID0gY2VsbC5nZXQoJ3NvdXJjZScpLmlkOwogICAgICAgICAgICB2YXIgdGFyZ2V0SWQgPSBjZWxsLmdldCgndGFyZ2V0JykuaWQ7CgogICAgICAgICAgICBkYWdyZUdyYXBoLmFkZEVkZ2UoY2VsbC5pZCwgc291cmNlSWQsIHRhcmdldElkLCB7IG1pbkxlbjogY2VsbC5nZXQoJ21pbkxlbicpIHx8IDEgfSk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkYWdyZUdyYXBoOwogICAgfQp9Owo=",
                "body": "LyohIEpvaW50SlMgdjAuOS4xIC0gSmF2YVNjcmlwdCBkaWFncmFtbWluZyBsaWJyYXJ5ICAyMDE0LTA4LTA3IAoKClRoaXMgU291cmNlIENvZGUgRm9ybSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgTW96aWxsYSBQdWJsaWMKTGljZW5zZSwgdi4gMi4wLiBJZiBhIGNvcHkgb2YgdGhlIE1QTCB3YXMgbm90IGRpc3RyaWJ1dGVkIHdpdGggdGhpcwpmaWxlLCBZb3UgY2FuIG9idGFpbiBvbmUgYXQgaHR0cDovL21vemlsbGEub3JnL01QTC8yLjAvLgogKi8KLyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjIuMC4zCiAqIGh0dHA6Ly9qcXVlcnkuY29tLwogKgogKiBJbmNsdWRlcyBTaXp6bGUuanMKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMDUsIDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTA3LTAzVDEzOjMwWgogKi8KKGZ1bmN0aW9uKCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIENhbid0IGRvIHRoaXMgYmVjYXVzZSBzZXZlcmFsIGFwcHMgaW5jbHVkaW5nIEFTUC5ORVQgdHJhY2UKLy8gdGhlIHN0YWNrIHZpYSBhcmd1bWVudHMuY2FsbGVyLmNhbGxlZSBhbmQgRmlyZWZveCBkaWVzIGlmCi8vIHlvdSB0cnkgdG8gdHJhY2UgdGhyb3VnaCAidXNlIHN0cmljdCIgY2FsbCBjaGFpbnMuICgjMTMzMzUpCi8vIFN1cHBvcnQ6IEZpcmVmb3ggMTgrCi8vInVzZSBzdHJpY3QiOwp2YXIKCS8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQoJcm9vdGpRdWVyeSwKCgkvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKCXJlYWR5TGlzdCwKCgkvLyBTdXBwb3J0OiBJRTkKCS8vIEZvciBgdHlwZW9mIHhtbE5vZGUubWV0aG9kYCBpbnN0ZWFkIG9mIGB4bWxOb2RlLm1ldGhvZCAhPT0gdW5kZWZpbmVkYAoJY29yZV9zdHJ1bmRlZmluZWQgPSB0eXBlb2YgdW5kZWZpbmVkLAoKCS8vIFVzZSB0aGUgY29ycmVjdCBkb2N1bWVudCBhY2NvcmRpbmdseSB3aXRoIHdpbmRvdyBhcmd1bWVudCAoc2FuZGJveCkKCWxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAoJZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCglkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoKCS8vIE1hcCBvdmVyIGpRdWVyeSBpbiBjYXNlIG9mIG92ZXJ3cml0ZQoJX2pRdWVyeSA9IHdpbmRvdy5qUXVlcnksCgoJLy8gTWFwIG92ZXIgdGhlICQgaW4gY2FzZSBvZiBvdmVyd3JpdGUKCV8kID0gd2luZG93LiQsCgoJLy8gW1tDbGFzc11dIC0+IHR5cGUgcGFpcnMKCWNsYXNzMnR5cGUgPSB7fSwKCgkvLyBMaXN0IG9mIGRlbGV0ZWQgZGF0YSBjYWNoZSBpZHMsIHNvIHdlIGNhbiByZXVzZSB0aGVtCgljb3JlX2RlbGV0ZWRJZHMgPSBbXSwKCgljb3JlX3ZlcnNpb24gPSAiMi4wLjMiLAoKCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gc29tZSBjb3JlIG1ldGhvZHMKCWNvcmVfY29uY2F0ID0gY29yZV9kZWxldGVkSWRzLmNvbmNhdCwKCWNvcmVfcHVzaCA9IGNvcmVfZGVsZXRlZElkcy5wdXNoLAoJY29yZV9zbGljZSA9IGNvcmVfZGVsZXRlZElkcy5zbGljZSwKCWNvcmVfaW5kZXhPZiA9IGNvcmVfZGVsZXRlZElkcy5pbmRleE9mLAoJY29yZV90b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmcsCgljb3JlX2hhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHksCgljb3JlX3RyaW0gPSBjb3JlX3ZlcnNpb24udHJpbSwKCgkvLyBEZWZpbmUgYSBsb2NhbCBjb3B5IG9mIGpRdWVyeQoJalF1ZXJ5ID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0ICkgewoJCS8vIFRoZSBqUXVlcnkgb2JqZWN0IGlzIGFjdHVhbGx5IGp1c3QgdGhlIGluaXQgY29uc3RydWN0b3IgJ2VuaGFuY2VkJwoJCXJldHVybiBuZXcgalF1ZXJ5LmZuLmluaXQoIHNlbGVjdG9yLCBjb250ZXh0LCByb290alF1ZXJ5ICk7Cgl9LAoKCS8vIFVzZWQgZm9yIG1hdGNoaW5nIG51bWJlcnMKCWNvcmVfcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlLAoKCS8vIFVzZWQgZm9yIHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlCgljb3JlX3Jub3R3aGl0ZSA9IC9cUysvZywKCgkvLyBBIHNpbXBsZSB3YXkgdG8gY2hlY2sgZm9yIEhUTUwgc3RyaW5ncwoJLy8gUHJpb3JpdGl6ZSAjaWQgb3ZlciA8dGFnPiB0byBhdm9pZCBYU1MgdmlhIGxvY2F0aW9uLmhhc2ggKCM5NTIxKQoJLy8gU3RyaWN0IEhUTUwgcmVjb2duaXRpb24gKCMxMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCglycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0qKSkkLywKCgkvLyBNYXRjaCBhIHN0YW5kYWxvbmUgdGFnCglyc2luZ2xlVGFnID0gL148KFx3KylccypcLz8+KD86PFwvXDE+fCkkLywKCgkvLyBNYXRjaGVzIGRhc2hlZCBzdHJpbmcgZm9yIGNhbWVsaXppbmcKCXJtc1ByZWZpeCA9IC9eLW1zLS8sCglyZGFzaEFscGhhID0gLy0oW1xkYS16XSkvZ2ksCgoJLy8gVXNlZCBieSBqUXVlcnkuY2FtZWxDYXNlIGFzIGNhbGxiYWNrIHRvIHJlcGxhY2UoKQoJZmNhbWVsQ2FzZSA9IGZ1bmN0aW9uKCBhbGwsIGxldHRlciApIHsKCQlyZXR1cm4gbGV0dGVyLnRvVXBwZXJDYXNlKCk7Cgl9LAoKCS8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCgljb21wbGV0ZWQgPSBmdW5jdGlvbigpIHsKCQlkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lciggImxvYWQiLCBjb21wbGV0ZWQsIGZhbHNlICk7CgkJalF1ZXJ5LnJlYWR5KCk7Cgl9OwoKalF1ZXJ5LmZuID0galF1ZXJ5LnByb3RvdHlwZSA9IHsKCS8vIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgalF1ZXJ5IGJlaW5nIHVzZWQKCWpxdWVyeTogY29yZV92ZXJzaW9uLAoKCWNvbnN0cnVjdG9yOiBqUXVlcnksCglpbml0OiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQsIHJvb3RqUXVlcnkgKSB7CgkJdmFyIG1hdGNoLCBlbGVtOwoKCQkvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gSGFuZGxlIEhUTUwgc3RyaW5ncwoJCWlmICggdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJaWYgKCBzZWxlY3Rvci5jaGFyQXQoMCkgPT09ICI8IiAmJiBzZWxlY3Rvci5jaGFyQXQoIHNlbGVjdG9yLmxlbmd0aCAtIDEgKSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzICkgewoJCQkJLy8gQXNzdW1lIHRoYXQgc3RyaW5ncyB0aGF0IHN0YXJ0IGFuZCBlbmQgd2l0aCA8PiBhcmUgSFRNTCBhbmQgc2tpcCB0aGUgcmVnZXggY2hlY2sKCQkJCW1hdGNoID0gWyBudWxsLCBzZWxlY3RvciwgbnVsbCBdOwoKCQkJfSBlbHNlIHsKCQkJCW1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApOwoJCQl9CgoJCQkvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCgkJCWlmICggbWF0Y2ggJiYgKG1hdGNoWzFdIHx8ICFjb250ZXh0KSApIHsKCgkJCQkvLyBIQU5ETEU6ICQoaHRtbCkgLT4gJChhcnJheSkKCQkJCWlmICggbWF0Y2hbMV0gKSB7CgkJCQkJY29udGV4dCA9IGNvbnRleHQgaW5zdGFuY2VvZiBqUXVlcnkgPyBjb250ZXh0WzBdIDogY29udGV4dDsKCgkJCQkJLy8gc2NyaXB0cyBpcyB0cnVlIGZvciBiYWNrLWNvbXBhdAoJCQkJCWpRdWVyeS5tZXJnZSggdGhpcywgalF1ZXJ5LnBhcnNlSFRNTCgKCQkJCQkJbWF0Y2hbMV0sCgkJCQkJCWNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsCgkJCQkJCXRydWUKCQkJCQkpICk7CgoJCQkJCS8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKCQkJCQlpZiAoIHJzaW5nbGVUYWcudGVzdCggbWF0Y2hbMV0gKSAmJiBqUXVlcnkuaXNQbGFpbk9iamVjdCggY29udGV4dCApICkgewoJCQkJCQlmb3IgKCBtYXRjaCBpbiBjb250ZXh0ICkgewoJCQkJCQkJLy8gUHJvcGVydGllcyBvZiBjb250ZXh0IGFyZSBjYWxsZWQgYXMgbWV0aG9kcyBpZiBwb3NzaWJsZQoJCQkJCQkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdGhpc1sgbWF0Y2ggXSApICkgewoJCQkJCQkJCXRoaXNbIG1hdGNoIF0oIGNvbnRleHRbIG1hdGNoIF0gKTsKCgkJCQkJCQkvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXRoaXMuYXR0ciggbWF0Y2gsIGNvbnRleHRbIG1hdGNoIF0gKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCgkJCQkJcmV0dXJuIHRoaXM7CgoJCQkJLy8gSEFORExFOiAkKCNpZCkKCQkJCX0gZWxzZSB7CgkJCQkJZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtYXRjaFsyXSApOwoKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAoJCQkJCQl0aGlzLmxlbmd0aCA9IDE7CgkJCQkJCXRoaXNbMF0gPSBlbGVtOwoJCQkJCX0KCgkJCQkJdGhpcy5jb250ZXh0ID0gZG9jdW1lbnQ7CgkJCQkJdGhpcy5zZWxlY3RvciA9IHNlbGVjdG9yOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoKCQkJLy8gSEFORExFOiAkKGV4cHIsICQoLi4uKSkKCQkJfSBlbHNlIGlmICggIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkgKSB7CgkJCQlyZXR1cm4gKCBjb250ZXh0IHx8IHJvb3RqUXVlcnkgKS5maW5kKCBzZWxlY3RvciApOwoKCQkJLy8gSEFORExFOiAkKGV4cHIsIGNvbnRleHQpCgkJCS8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQoJCQl9IGVsc2UgewoJCQkJcmV0dXJuIHRoaXMuY29uc3RydWN0b3IoIGNvbnRleHQgKS5maW5kKCBzZWxlY3RvciApOwoJCQl9CgoJCS8vIEhBTkRMRTogJChET01FbGVtZW50KQoJCX0gZWxzZSBpZiAoIHNlbGVjdG9yLm5vZGVUeXBlICkgewoJCQl0aGlzLmNvbnRleHQgPSB0aGlzWzBdID0gc2VsZWN0b3I7CgkJCXRoaXMubGVuZ3RoID0gMTsKCQkJcmV0dXJuIHRoaXM7CgoJCS8vIEhBTkRMRTogJChmdW5jdGlvbikKCQkvLyBTaG9ydGN1dCBmb3IgZG9jdW1lbnQgcmVhZHkKCQl9IGVsc2UgaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggc2VsZWN0b3IgKSApIHsKCQkJcmV0dXJuIHJvb3RqUXVlcnkucmVhZHkoIHNlbGVjdG9yICk7CgkJfQoKCQlpZiAoIHNlbGVjdG9yLnNlbGVjdG9yICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuc2VsZWN0b3IgPSBzZWxlY3Rvci5zZWxlY3RvcjsKCQkJdGhpcy5jb250ZXh0ID0gc2VsZWN0b3IuY29udGV4dDsKCQl9CgoJCXJldHVybiBqUXVlcnkubWFrZUFycmF5KCBzZWxlY3RvciwgdGhpcyApOwoJfSwKCgkvLyBTdGFydCB3aXRoIGFuIGVtcHR5IHNlbGVjdG9yCglzZWxlY3RvcjogIiIsCgoJLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCglsZW5ndGg6IDAsCgoJdG9BcnJheTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGNvcmVfc2xpY2UuY2FsbCggdGhpcyApOwoJfSwKCgkvLyBHZXQgdGhlIE50aCBlbGVtZW50IGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0IE9SCgkvLyBHZXQgdGhlIHdob2xlIG1hdGNoZWQgZWxlbWVudCBzZXQgYXMgYSBjbGVhbiBhcnJheQoJZ2V0OiBmdW5jdGlvbiggbnVtICkgewoJCXJldHVybiBudW0gPT0gbnVsbCA/CgoJCQkvLyBSZXR1cm4gYSAnY2xlYW4nIGFycmF5CgkJCXRoaXMudG9BcnJheSgpIDoKCgkJCS8vIFJldHVybiBqdXN0IHRoZSBvYmplY3QKCQkJKCBudW0gPCAwID8gdGhpc1sgdGhpcy5sZW5ndGggKyBudW0gXSA6IHRoaXNbIG51bSBdICk7Cgl9LAoKCS8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKCS8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQoJcHVzaFN0YWNrOiBmdW5jdGlvbiggZWxlbXMgKSB7CgoJCS8vIEJ1aWxkIGEgbmV3IGpRdWVyeSBtYXRjaGVkIGVsZW1lbnQgc2V0CgkJdmFyIHJldCA9IGpRdWVyeS5tZXJnZSggdGhpcy5jb25zdHJ1Y3RvcigpLCBlbGVtcyApOwoKCQkvLyBBZGQgdGhlIG9sZCBvYmplY3Qgb250byB0aGUgc3RhY2sgKGFzIGEgcmVmZXJlbmNlKQoJCXJldC5wcmV2T2JqZWN0ID0gdGhpczsKCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dDsKCgkJLy8gUmV0dXJuIHRoZSBuZXdseS1mb3JtZWQgZWxlbWVudCBzZXQKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBFeGVjdXRlIGEgY2FsbGJhY2sgZm9yIGV2ZXJ5IGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgc2V0LgoJLy8gKFlvdSBjYW4gc2VlZCB0aGUgYXJndW1lbnRzIHdpdGggYW4gYXJyYXkgb2YgYXJncywgYnV0IHRoaXMgaXMKCS8vIG9ubHkgdXNlZCBpbnRlcm5hbGx5LikKCWVhY2g6IGZ1bmN0aW9uKCBjYWxsYmFjaywgYXJncyApIHsKCQlyZXR1cm4galF1ZXJ5LmVhY2goIHRoaXMsIGNhbGxiYWNrLCBhcmdzICk7Cgl9LAoKCXJlYWR5OiBmdW5jdGlvbiggZm4gKSB7CgkJLy8gQWRkIHRoZSBjYWxsYmFjawoJCWpRdWVyeS5yZWFkeS5wcm9taXNlKCkuZG9uZSggZm4gKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXNsaWNlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGNvcmVfc2xpY2UuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApICk7Cgl9LAoKCWZpcnN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggMCApOwoJfSwKCglsYXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lcSggLTEgKTsKCX0sCgoJZXE6IGZ1bmN0aW9uKCBpICkgewoJCXZhciBsZW4gPSB0aGlzLmxlbmd0aCwKCQkJaiA9ICtpICsgKCBpIDwgMCA/IGxlbiA6IDAgKTsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGogPj0gMCAmJiBqIDwgbGVuID8gWyB0aGlzW2pdIF0gOiBbXSApOwoJfSwKCgltYXA6IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIGpRdWVyeS5tYXAodGhpcywgZnVuY3Rpb24oIGVsZW0sIGkgKSB7CgkJCXJldHVybiBjYWxsYmFjay5jYWxsKCBlbGVtLCBpLCBlbGVtICk7CgkJfSkpOwoJfSwKCgllbmQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcihudWxsKTsKCX0sCgoJLy8gRm9yIGludGVybmFsIHVzZSBvbmx5LgoJLy8gQmVoYXZlcyBsaWtlIGFuIEFycmF5J3MgbWV0aG9kLCBub3QgbGlrZSBhIGpRdWVyeSBtZXRob2QuCglwdXNoOiBjb3JlX3B1c2gsCglzb3J0OiBbXS5zb3J0LAoJc3BsaWNlOiBbXS5zcGxpY2UKfTsKCi8vIEdpdmUgdGhlIGluaXQgZnVuY3Rpb24gdGhlIGpRdWVyeSBwcm90b3R5cGUgZm9yIGxhdGVyIGluc3RhbnRpYXRpb24KalF1ZXJ5LmZuLmluaXQucHJvdG90eXBlID0galF1ZXJ5LmZuOwoKalF1ZXJ5LmV4dGVuZCA9IGpRdWVyeS5mbi5leHRlbmQgPSBmdW5jdGlvbigpIHsKCXZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKCQl0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCgkJaSA9IDEsCgkJbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKCQlkZWVwID0gZmFsc2U7CgoJLy8gSGFuZGxlIGEgZGVlcCBjb3B5IHNpdHVhdGlvbgoJaWYgKCB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIgKSB7CgkJZGVlcCA9IHRhcmdldDsKCQl0YXJnZXQgPSBhcmd1bWVudHNbMV0gfHwge307CgkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCWkgPSAyOwoJfQoKCS8vIEhhbmRsZSBjYXNlIHdoZW4gdGFyZ2V0IGlzIGEgc3RyaW5nIG9yIHNvbWV0aGluZyAocG9zc2libGUgaW4gZGVlcCBjb3B5KQoJaWYgKCB0eXBlb2YgdGFyZ2V0ICE9PSAib2JqZWN0IiAmJiAhalF1ZXJ5LmlzRnVuY3Rpb24odGFyZ2V0KSApIHsKCQl0YXJnZXQgPSB7fTsKCX0KCgkvLyBleHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCWlmICggbGVuZ3RoID09PSBpICkgewoJCXRhcmdldCA9IHRoaXM7CgkJLS1pOwoJfQoKCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQlpZiAoIChvcHRpb25zID0gYXJndW1lbnRzWyBpIF0pICE9IG51bGwgKSB7CgkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJZm9yICggbmFtZSBpbiBvcHRpb25zICkgewoJCQkJc3JjID0gdGFyZ2V0WyBuYW1lIF07CgkJCQljb3B5ID0gb3B0aW9uc1sgbmFtZSBdOwoKCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCWlmICggdGFyZ2V0ID09PSBjb3B5ICkgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoKCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwoJCQkJaWYgKCBkZWVwICYmIGNvcHkgJiYgKCBqUXVlcnkuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBqUXVlcnkuaXNBcnJheShjb3B5KSkgKSApIHsKCQkJCQlpZiAoIGNvcHlJc0FycmF5ICkgewoJCQkJCQljb3B5SXNBcnJheSA9IGZhbHNlOwoJCQkJCQljbG9uZSA9IHNyYyAmJiBqUXVlcnkuaXNBcnJheShzcmMpID8gc3JjIDogW107CgoJCQkJCX0gZWxzZSB7CgkJCQkJCWNsb25lID0gc3JjICYmIGpRdWVyeS5pc1BsYWluT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKCQkJCQl9CgoJCQkJCS8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQoJCQkJCXRhcmdldFsgbmFtZSBdID0galF1ZXJ5LmV4dGVuZCggZGVlcCwgY2xvbmUsIGNvcHkgKTsKCgkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQl9IGVsc2UgaWYgKCBjb3B5ICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJdGFyZ2V0WyBuYW1lIF0gPSBjb3B5OwoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CglyZXR1cm4gdGFyZ2V0Owp9OwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBVbmlxdWUgZm9yIGVhY2ggY29weSBvZiBqUXVlcnkgb24gdGhlIHBhZ2UKCWV4cGFuZG86ICJqUXVlcnkiICsgKCBjb3JlX3ZlcnNpb24gKyBNYXRoLnJhbmRvbSgpICkucmVwbGFjZSggL1xEL2csICIiICksCgoJbm9Db25mbGljdDogZnVuY3Rpb24oIGRlZXAgKSB7CgkJaWYgKCB3aW5kb3cuJCA9PT0galF1ZXJ5ICkgewoJCQl3aW5kb3cuJCA9IF8kOwoJCX0KCgkJaWYgKCBkZWVwICYmIHdpbmRvdy5qUXVlcnkgPT09IGpRdWVyeSApIHsKCQkJd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CgkJfQoKCQlyZXR1cm4galF1ZXJ5OwoJfSwKCgkvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgoJaXNSZWFkeTogZmFsc2UsCgoJLy8gQSBjb3VudGVyIHRvIHRyYWNrIGhvdyBtYW55IGl0ZW1zIHRvIHdhaXQgZm9yIGJlZm9yZQoJLy8gdGhlIHJlYWR5IGV2ZW50IGZpcmVzLiBTZWUgIzY3ODEKCXJlYWR5V2FpdDogMSwKCgkvLyBIb2xkIChvciByZWxlYXNlKSB0aGUgcmVhZHkgZXZlbnQKCWhvbGRSZWFkeTogZnVuY3Rpb24oIGhvbGQgKSB7CgkJaWYgKCBob2xkICkgewoJCQlqUXVlcnkucmVhZHlXYWl0Kys7CgkJfSBlbHNlIHsKCQkJalF1ZXJ5LnJlYWR5KCB0cnVlICk7CgkJfQoJfSwKCgkvLyBIYW5kbGUgd2hlbiB0aGUgRE9NIGlzIHJlYWR5CglyZWFkeTogZnVuY3Rpb24oIHdhaXQgKSB7CgoJCS8vIEFib3J0IGlmIHRoZXJlIGFyZSBwZW5kaW5nIGhvbGRzIG9yIHdlJ3JlIGFscmVhZHkgcmVhZHkKCQlpZiAoIHdhaXQgPT09IHRydWUgPyAtLWpRdWVyeS5yZWFkeVdhaXQgOiBqUXVlcnkuaXNSZWFkeSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gUmVtZW1iZXIgdGhhdCB0aGUgRE9NIGlzIHJlYWR5CgkJalF1ZXJ5LmlzUmVhZHkgPSB0cnVlOwoKCQkvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQoJCWlmICggd2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCgkJcmVhZHlMaXN0LnJlc29sdmVXaXRoKCBkb2N1bWVudCwgWyBqUXVlcnkgXSApOwoKCQkvLyBUcmlnZ2VyIGFueSBib3VuZCByZWFkeSBldmVudHMKCQlpZiAoIGpRdWVyeS5mbi50cmlnZ2VyICkgewoJCQlqUXVlcnkoIGRvY3VtZW50ICkudHJpZ2dlcigicmVhZHkiKS5vZmYoInJlYWR5Iik7CgkJfQoJfSwKCgkvLyBTZWUgdGVzdC91bml0L2NvcmUuanMgZm9yIGRldGFpbHMgY29uY2VybmluZyBpc0Z1bmN0aW9uLgoJLy8gU2luY2UgdmVyc2lvbiAxLjMsIERPTSBtZXRob2RzIGFuZCBmdW5jdGlvbnMgbGlrZSBhbGVydAoJLy8gYXJlbid0IHN1cHBvcnRlZC4gVGhleSByZXR1cm4gZmFsc2Ugb24gSUUgKCMyOTY4KS4KCWlzRnVuY3Rpb246IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIGpRdWVyeS50eXBlKG9iaikgPT09ICJmdW5jdGlvbiI7Cgl9LAoKCWlzQXJyYXk6IEFycmF5LmlzQXJyYXksCgoJaXNXaW5kb3c6IGZ1bmN0aW9uKCBvYmogKSB7CgkJcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PT0gb2JqLndpbmRvdzsKCX0sCgoJaXNOdW1lcmljOiBmdW5jdGlvbiggb2JqICkgewoJCXJldHVybiAhaXNOYU4oIHBhcnNlRmxvYXQob2JqKSApICYmIGlzRmluaXRlKCBvYmogKTsKCX0sCgoJdHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAoIG9iaiA9PSBudWxsICkgewoJCQlyZXR1cm4gU3RyaW5nKCBvYmogKTsKCQl9CgkJLy8gU3VwcG9ydDogU2FmYXJpIDw9IDUuMSAoZnVuY3Rpb25pc2ggUmVnRXhwKQoJCXJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8KCQkJY2xhc3MydHlwZVsgY29yZV90b1N0cmluZy5jYWxsKG9iaikgXSB8fCAib2JqZWN0IiA6CgkJCXR5cGVvZiBvYmo7Cgl9LAoKCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uKCBvYmogKSB7CgkJLy8gTm90IHBsYWluIG9iamVjdHM6CgkJLy8gLSBBbnkgb2JqZWN0IG9yIHZhbHVlIHdob3NlIGludGVybmFsIFtbQ2xhc3NdXSBwcm9wZXJ0eSBpcyBub3QgIltvYmplY3QgT2JqZWN0XSIKCQkvLyAtIERPTSBub2RlcwoJCS8vIC0gd2luZG93CgkJaWYgKCBqUXVlcnkudHlwZSggb2JqICkgIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBqUXVlcnkuaXNXaW5kb3coIG9iaiApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTdXBwb3J0OiBGaXJlZm94IDwyMAoJCS8vIFRoZSB0cnkvY2F0Y2ggc3VwcHJlc3NlcyBleGNlcHRpb25zIHRocm93biB3aGVuIGF0dGVtcHRpbmcgdG8gYWNjZXNzCgkJLy8gdGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgb2YgY2VydGFpbiBob3N0IG9iamVjdHMsIGllLiB8d2luZG93LmxvY2F0aW9ufAoJCS8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTgxNDYyMgoJCXRyeSB7CgkJCWlmICggb2JqLmNvbnN0cnVjdG9yICYmCgkJCQkJIWNvcmVfaGFzT3duLmNhbGwoIG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSBjYXRjaCAoIGUgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIElmIHRoZSBmdW5jdGlvbiBoYXNuJ3QgcmV0dXJuZWQgYWxyZWFkeSwgd2UncmUgY29uZmlkZW50IHRoYXQKCQkvLyB8b2JqfCBpcyBhIHBsYWluIG9iamVjdCwgY3JlYXRlZCBieSB7fSBvciBjb25zdHJ1Y3RlZCB3aXRoIG5ldyBPYmplY3QKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJaXNFbXB0eU9iamVjdDogZnVuY3Rpb24oIG9iaiApIHsKCQl2YXIgbmFtZTsKCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJZXJyb3I6IGZ1bmN0aW9uKCBtc2cgKSB7CgkJdGhyb3cgbmV3IEVycm9yKCBtc2cgKTsKCX0sCgoJLy8gZGF0YTogc3RyaW5nIG9mIGh0bWwKCS8vIGNvbnRleHQgKG9wdGlvbmFsKTogSWYgc3BlY2lmaWVkLCB0aGUgZnJhZ21lbnQgd2lsbCBiZSBjcmVhdGVkIGluIHRoaXMgY29udGV4dCwgZGVmYXVsdHMgdG8gZG9jdW1lbnQKCS8vIGtlZXBTY3JpcHRzIChvcHRpb25hbCk6IElmIHRydWUsIHdpbGwgaW5jbHVkZSBzY3JpcHRzIHBhc3NlZCBpbiB0aGUgaHRtbCBzdHJpbmcKCXBhcnNlSFRNTDogZnVuY3Rpb24oIGRhdGEsIGNvbnRleHQsIGtlZXBTY3JpcHRzICkgewoJCWlmICggIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciICkgewoJCQlyZXR1cm4gbnVsbDsKCQl9CgkJaWYgKCB0eXBlb2YgY29udGV4dCA9PT0gImJvb2xlYW4iICkgewoJCQlrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CgkJCWNvbnRleHQgPSBmYWxzZTsKCQl9CgkJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CgoJCXZhciBwYXJzZWQgPSByc2luZ2xlVGFnLmV4ZWMoIGRhdGEgKSwKCQkJc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCgkJLy8gU2luZ2xlIHRhZwoJCWlmICggcGFyc2VkICkgewoJCQlyZXR1cm4gWyBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoIHBhcnNlZFsxXSApIF07CgkJfQoKCQlwYXJzZWQgPSBqUXVlcnkuYnVpbGRGcmFnbWVudCggWyBkYXRhIF0sIGNvbnRleHQsIHNjcmlwdHMgKTsKCgkJaWYgKCBzY3JpcHRzICkgewoJCQlqUXVlcnkoIHNjcmlwdHMgKS5yZW1vdmUoKTsKCQl9CgoJCXJldHVybiBqUXVlcnkubWVyZ2UoIFtdLCBwYXJzZWQuY2hpbGROb2RlcyApOwoJfSwKCglwYXJzZUpTT046IEpTT04ucGFyc2UsCgoJLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwoJcGFyc2VYTUw6IGZ1bmN0aW9uKCBkYXRhICkgewoJCXZhciB4bWwsIHRtcDsKCQlpZiAoICFkYXRhIHx8IHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRTkKCQl0cnkgewoJCQl0bXAgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCXhtbCA9IHRtcC5wYXJzZUZyb21TdHJpbmcoIGRhdGEgLCAidGV4dC94bWwiICk7CgkJfSBjYXRjaCAoIGUgKSB7CgkJCXhtbCA9IHVuZGVmaW5lZDsKCQl9CgoJCWlmICggIXhtbCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoICJwYXJzZXJlcnJvciIgKS5sZW5ndGggKSB7CgkJCWpRdWVyeS5lcnJvciggIkludmFsaWQgWE1MOiAiICsgZGF0YSApOwoJCX0KCQlyZXR1cm4geG1sOwoJfSwKCglub29wOiBmdW5jdGlvbigpIHt9LAoKCS8vIEV2YWx1YXRlcyBhIHNjcmlwdCBpbiBhIGdsb2JhbCBjb250ZXh0CglnbG9iYWxFdmFsOiBmdW5jdGlvbiggY29kZSApIHsKCQl2YXIgc2NyaXB0LAoJCQkJaW5kaXJlY3QgPSBldmFsOwoKCQljb2RlID0galF1ZXJ5LnRyaW0oIGNvZGUgKTsKCgkJaWYgKCBjb2RlICkgewoJCQkvLyBJZiB0aGUgY29kZSBpbmNsdWRlcyBhIHZhbGlkLCBwcm9sb2d1ZSBwb3NpdGlvbgoJCQkvLyBzdHJpY3QgbW9kZSBwcmFnbWEsIGV4ZWN1dGUgY29kZSBieSBpbmplY3RpbmcgYQoJCQkvLyBzY3JpcHQgdGFnIGludG8gdGhlIGRvY3VtZW50LgoJCQlpZiAoIGNvZGUuaW5kZXhPZigidXNlIHN0cmljdCIpID09PSAxICkgewoJCQkJc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2NyaXB0Iik7CgkJCQlzY3JpcHQudGV4dCA9IGNvZGU7CgkJCQlkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKCBzY3JpcHQgKS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBzY3JpcHQgKTsKCQkJfSBlbHNlIHsKCQkJLy8gT3RoZXJ3aXNlLCBhdm9pZCB0aGUgRE9NIG5vZGUgY3JlYXRpb24sIGluc2VydGlvbgoJCQkvLyBhbmQgcmVtb3ZhbCBieSB1c2luZyBhbiBpbmRpcmVjdCBnbG9iYWwgZXZhbAoJCQkJaW5kaXJlY3QoIGNvZGUgKTsKCQkJfQoJCX0KCX0sCgoJLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwoJLy8gTWljcm9zb2Z0IGZvcmdvdCB0byBodW1wIHRoZWlyIHZlbmRvciBwcmVmaXggKCM5NTcyKQoJY2FtZWxDYXNlOiBmdW5jdGlvbiggc3RyaW5nICkgewoJCXJldHVybiBzdHJpbmcucmVwbGFjZSggcm1zUHJlZml4LCAibXMtIiApLnJlcGxhY2UoIHJkYXNoQWxwaGEsIGZjYW1lbENhc2UgKTsKCX0sCgoJbm9kZU5hbWU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCXJldHVybiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJfSwKCgkvLyBhcmdzIGlzIGZvciBpbnRlcm5hbCB1c2FnZSBvbmx5CgllYWNoOiBmdW5jdGlvbiggb2JqLCBjYWxsYmFjaywgYXJncyApIHsKCQl2YXIgdmFsdWUsCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBvYmoubGVuZ3RoLAoJCQlpc0FycmF5ID0gaXNBcnJheWxpa2UoIG9iaiApOwoKCQlpZiAoIGFyZ3MgKSB7CgkJCWlmICggaXNBcnJheSApIHsKCQkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suYXBwbHkoIG9ialsgaSBdLCBhcmdzICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQlmb3IgKCBpIGluIG9iaiApIHsKCQkJCQl2YWx1ZSA9IGNhbGxiYWNrLmFwcGx5KCBvYmpbIGkgXSwgYXJncyApOwoKCQkJCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCS8vIEEgc3BlY2lhbCwgZmFzdCwgY2FzZSBmb3IgdGhlIG1vc3QgY29tbW9uIHVzZSBvZiBlYWNoCgkJfSBlbHNlIHsKCQkJaWYgKCBpc0FycmF5ICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFsdWUgPSBjYWxsYmFjay5jYWxsKCBvYmpbIGkgXSwgaSwgb2JqWyBpIF0gKTsKCgkJCQkJaWYgKCB2YWx1ZSA9PT0gZmFsc2UgKSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWZvciAoIGkgaW4gb2JqICkgewoJCQkJCXZhbHVlID0gY2FsbGJhY2suY2FsbCggb2JqWyBpIF0sIGksIG9ialsgaSBdICk7CgoJCQkJCWlmICggdmFsdWUgPT09IGZhbHNlICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvYmo7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCB0ZXh0ICkgewoJCXJldHVybiB0ZXh0ID09IG51bGwgPyAiIiA6IGNvcmVfdHJpbS5jYWxsKCB0ZXh0ICk7Cgl9LAoKCS8vIHJlc3VsdHMgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1ha2VBcnJheTogZnVuY3Rpb24oIGFyciwgcmVzdWx0cyApIHsKCQl2YXIgcmV0ID0gcmVzdWx0cyB8fCBbXTsKCgkJaWYgKCBhcnIgIT0gbnVsbCApIHsKCQkJaWYgKCBpc0FycmF5bGlrZSggT2JqZWN0KGFycikgKSApIHsKCQkJCWpRdWVyeS5tZXJnZSggcmV0LAoJCQkJCXR5cGVvZiBhcnIgPT09ICJzdHJpbmciID8KCQkJCQlbIGFyciBdIDogYXJyCgkJCQkpOwoJCQl9IGVsc2UgewoJCQkJY29yZV9wdXNoLmNhbGwoIHJldCwgYXJyICk7CgkJCX0KCQl9CgoJCXJldHVybiByZXQ7Cgl9LAoKCWluQXJyYXk6IGZ1bmN0aW9uKCBlbGVtLCBhcnIsIGkgKSB7CgkJcmV0dXJuIGFyciA9PSBudWxsID8gLTEgOiBjb3JlX2luZGV4T2YuY2FsbCggYXJyLCBlbGVtLCBpICk7Cgl9LAoKCW1lcmdlOiBmdW5jdGlvbiggZmlyc3QsIHNlY29uZCApIHsKCQl2YXIgbCA9IHNlY29uZC5sZW5ndGgsCgkJCWkgPSBmaXJzdC5sZW5ndGgsCgkJCWogPSAwOwoKCQlpZiAoIHR5cGVvZiBsID09PSAibnVtYmVyIiApIHsKCQkJZm9yICggOyBqIDwgbDsgaisrICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqIF07CgkJCX0KCQl9IGVsc2UgewoJCQl3aGlsZSAoIHNlY29uZFtqXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJZmlyc3RbIGkrKyBdID0gc2Vjb25kWyBqKysgXTsKCQkJfQoJCX0KCgkJZmlyc3QubGVuZ3RoID0gaTsKCgkJcmV0dXJuIGZpcnN0OwoJfSwKCglncmVwOiBmdW5jdGlvbiggZWxlbXMsIGNhbGxiYWNrLCBpbnYgKSB7CgkJdmFyIHJldFZhbCwKCQkJcmV0ID0gW10sCgkJCWkgPSAwLAoJCQlsZW5ndGggPSBlbGVtcy5sZW5ndGg7CgkJaW52ID0gISFpbnY7CgoJCS8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKCQkvLyB0aGF0IHBhc3MgdGhlIHZhbGlkYXRvciBmdW5jdGlvbgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQlyZXRWYWwgPSAhIWNhbGxiYWNrKCBlbGVtc1sgaSBdLCBpICk7CgkJCWlmICggaW52ICE9PSByZXRWYWwgKSB7CgkJCQlyZXQucHVzaCggZWxlbXNbIGkgXSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCgkvLyBhcmcgaXMgZm9yIGludGVybmFsIHVzYWdlIG9ubHkKCW1hcDogZnVuY3Rpb24oIGVsZW1zLCBjYWxsYmFjaywgYXJnICkgewoJCXZhciB2YWx1ZSwKCQkJaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJaXNBcnJheSA9IGlzQXJyYXlsaWtlKCBlbGVtcyApLAoJCQlyZXQgPSBbXTsKCgkJLy8gR28gdGhyb3VnaCB0aGUgYXJyYXksIHRyYW5zbGF0aW5nIGVhY2ggb2YgdGhlIGl0ZW1zIHRvIHRoZWlyCgkJaWYgKCBpc0FycmF5ICkgewoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgoJCS8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCgkJfSBlbHNlIHsKCQkJZm9yICggaSBpbiBlbGVtcyApIHsKCQkJCXZhbHVlID0gY2FsbGJhY2soIGVsZW1zWyBpIF0sIGksIGFyZyApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlyZXRbIHJldC5sZW5ndGggXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJcmV0dXJuIGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgcmV0ICk7Cgl9LAoKCS8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwoJZ3VpZDogMSwKCgkvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKCS8vIGFyZ3VtZW50cy4KCXByb3h5OiBmdW5jdGlvbiggZm4sIGNvbnRleHQgKSB7CgkJdmFyIHRtcCwgYXJncywgcHJveHk7CgoJCWlmICggdHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciICkgewoJCQl0bXAgPSBmblsgY29udGV4dCBdOwoJCQljb250ZXh0ID0gZm47CgkJCWZuID0gdG1wOwoJCX0KCgkJLy8gUXVpY2sgY2hlY2sgdG8gZGV0ZXJtaW5lIGlmIHRhcmdldCBpcyBjYWxsYWJsZSwgaW4gdGhlIHNwZWMKCQkvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgoJCWlmICggIWpRdWVyeS5pc0Z1bmN0aW9uKCBmbiApICkgewoJCQlyZXR1cm4gdW5kZWZpbmVkOwoJCX0KCgkJLy8gU2ltdWxhdGVkIGJpbmQKCQlhcmdzID0gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMsIDIgKTsKCQlwcm94eSA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gZm4uYXBwbHkoIGNvbnRleHQgfHwgdGhpcywgYXJncy5jb25jYXQoIGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICkgKSApOwoJCX07CgoJCS8vIFNldCB0aGUgZ3VpZCBvZiB1bmlxdWUgaGFuZGxlciB0byB0aGUgc2FtZSBvZiBvcmlnaW5hbCBoYW5kbGVyLCBzbyBpdCBjYW4gYmUgcmVtb3ZlZAoJCXByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwoKCQlyZXR1cm4gcHJveHk7Cgl9LAoKCS8vIE11bHRpZnVuY3Rpb25hbCBtZXRob2QgdG8gZ2V0IGFuZCBzZXQgdmFsdWVzIG9mIGEgY29sbGVjdGlvbgoJLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCglhY2Nlc3M6IGZ1bmN0aW9uKCBlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHJhdyApIHsKCQl2YXIgaSA9IDAsCgkJCWxlbmd0aCA9IGVsZW1zLmxlbmd0aCwKCQkJYnVsayA9IGtleSA9PSBudWxsOwoKCQkvLyBTZXRzIG1hbnkgdmFsdWVzCgkJaWYgKCBqUXVlcnkudHlwZSgga2V5ICkgPT09ICJvYmplY3QiICkgewoJCQljaGFpbmFibGUgPSB0cnVlOwoJCQlmb3IgKCBpIGluIGtleSApIHsKCQkJCWpRdWVyeS5hY2Nlc3MoIGVsZW1zLCBmbiwgaSwga2V5W2ldLCB0cnVlLCBlbXB0eUdldCwgcmF3ICk7CgkJCX0KCgkJLy8gU2V0cyBvbmUgdmFsdWUKCQl9IGVsc2UgaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQljaGFpbmFibGUgPSB0cnVlOwoKCQkJaWYgKCAhalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCQlyYXcgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIGJ1bGsgKSB7CgkJCQkvLyBCdWxrIG9wZXJhdGlvbnMgcnVuIGFnYWluc3QgdGhlIGVudGlyZSBzZXQKCQkJCWlmICggcmF3ICkgewoJCQkJCWZuLmNhbGwoIGVsZW1zLCB2YWx1ZSApOwoJCQkJCWZuID0gbnVsbDsKCgkJCQkvLyAuLi5leGNlcHQgd2hlbiBleGVjdXRpbmcgZnVuY3Rpb24gdmFsdWVzCgkJCQl9IGVsc2UgewoJCQkJCWJ1bGsgPSBmbjsKCQkJCQlmbiA9IGZ1bmN0aW9uKCBlbGVtLCBrZXksIHZhbHVlICkgewoJCQkJCQlyZXR1cm4gYnVsay5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdmFsdWUgKTsKCQkJCQl9OwoJCQkJfQoJCQl9CgoJCQlpZiAoIGZuICkgewoJCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQkJZm4oIGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbCggZWxlbXNbaV0sIGksIGZuKCBlbGVtc1tpXSwga2V5ICkgKSApOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gY2hhaW5hYmxlID8KCQkJZWxlbXMgOgoKCQkJLy8gR2V0cwoJCQlidWxrID8KCQkJCWZuLmNhbGwoIGVsZW1zICkgOgoJCQkJbGVuZ3RoID8gZm4oIGVsZW1zWzBdLCBrZXkgKSA6IGVtcHR5R2V0OwoJfSwKCglub3c6IERhdGUubm93LAoKCS8vIEEgbWV0aG9kIGZvciBxdWlja2x5IHN3YXBwaW5nIGluL291dCBDU1MgcHJvcGVydGllcyB0byBnZXQgY29ycmVjdCBjYWxjdWxhdGlvbnMuCgkvLyBOb3RlOiB0aGlzIG1ldGhvZCBiZWxvbmdzIHRvIHRoZSBjc3MgbW9kdWxlIGJ1dCBpdCdzIG5lZWRlZCBoZXJlIGZvciB0aGUgc3VwcG9ydCBtb2R1bGUuCgkvLyBJZiBzdXBwb3J0IGdldHMgbW9kdWxhcml6ZWQsIHRoaXMgbWV0aG9kIHNob3VsZCBiZSBtb3ZlZCBiYWNrIHRvIHRoZSBjc3MgbW9kdWxlLgoJc3dhcDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIGNhbGxiYWNrLCBhcmdzICkgewoJCXZhciByZXQsIG5hbWUsCgkJCW9sZCA9IHt9OwoKCQkvLyBSZW1lbWJlciB0aGUgb2xkIHZhbHVlcywgYW5kIGluc2VydCB0aGUgbmV3IG9uZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCW9sZFsgbmFtZSBdID0gZWxlbS5zdHlsZVsgbmFtZSBdOwoJCQllbGVtLnN0eWxlWyBuYW1lIF0gPSBvcHRpb25zWyBuYW1lIF07CgkJfQoKCQlyZXQgPSBjYWxsYmFjay5hcHBseSggZWxlbSwgYXJncyB8fCBbXSApOwoKCQkvLyBSZXZlcnQgdGhlIG9sZCB2YWx1ZXMKCQlmb3IgKCBuYW1lIGluIG9wdGlvbnMgKSB7CgkJCWVsZW0uc3R5bGVbIG5hbWUgXSA9IG9sZFsgbmFtZSBdOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KfSk7CgpqUXVlcnkucmVhZHkucHJvbWlzZSA9IGZ1bmN0aW9uKCBvYmogKSB7CglpZiAoICFyZWFkeUxpc3QgKSB7CgoJCXJlYWR5TGlzdCA9IGpRdWVyeS5EZWZlcnJlZCgpOwoKCQkvLyBDYXRjaCBjYXNlcyB3aGVyZSAkKGRvY3VtZW50KS5yZWFkeSgpIGlzIGNhbGxlZCBhZnRlciB0aGUgYnJvd3NlciBldmVudCBoYXMgYWxyZWFkeSBvY2N1cnJlZC4KCQkvLyB3ZSBvbmNlIHRyaWVkIHRvIHVzZSByZWFkeVN0YXRlICJpbnRlcmFjdGl2ZSIgaGVyZSwgYnV0IGl0IGNhdXNlZCBpc3N1ZXMgbGlrZSB0aGUgb25lCgkJLy8gZGlzY292ZXJlZCBieSBDaHJpc1MgaGVyZTogaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIyODIjY29tbWVudDoxNQoJCWlmICggZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCQkJLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CgkJCXNldFRpbWVvdXQoIGpRdWVyeS5yZWFkeSApOwoKCQl9IGVsc2UgewoKCQkJLy8gVXNlIHRoZSBoYW5keSBldmVudCBjYWxsYmFjawoJCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCgkJCS8vIEEgZmFsbGJhY2sgdG8gd2luZG93Lm9ubG9hZCwgdGhhdCB3aWxsIGFsd2F5cyB3b3JrCgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCAibG9hZCIsIGNvbXBsZXRlZCwgZmFsc2UgKTsKCQl9Cgl9CglyZXR1cm4gcmVhZHlMaXN0LnByb21pc2UoIG9iaiApOwp9OwoKLy8gUG9wdWxhdGUgdGhlIGNsYXNzMnR5cGUgbWFwCmpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIi5zcGxpdCgiICIpLCBmdW5jdGlvbihpLCBuYW1lKSB7CgljbGFzczJ0eXBlWyAiW29iamVjdCAiICsgbmFtZSArICJdIiBdID0gbmFtZS50b0xvd2VyQ2FzZSgpOwp9KTsKCmZ1bmN0aW9uIGlzQXJyYXlsaWtlKCBvYmogKSB7Cgl2YXIgbGVuZ3RoID0gb2JqLmxlbmd0aCwKCQl0eXBlID0galF1ZXJ5LnR5cGUoIG9iaiApOwoKCWlmICggalF1ZXJ5LmlzV2luZG93KCBvYmogKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJaWYgKCBvYmoubm9kZVR5cGUgPT09IDEgJiYgbGVuZ3RoICkgewoJCXJldHVybiB0cnVlOwoJfQoKCXJldHVybiB0eXBlID09PSAiYXJyYXkiIHx8IHR5cGUgIT09ICJmdW5jdGlvbiIgJiYKCQkoIGxlbmd0aCA9PT0gMCB8fAoJCXR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgKCBsZW5ndGggLSAxICkgaW4gb2JqICk7Cn0KCi8vIEFsbCBqUXVlcnkgb2JqZWN0cyBzaG91bGQgcG9pbnQgYmFjayB0byB0aGVzZQpyb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKLyohCiAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYxLjkuNC1wcmUKICogaHR0cDovL3NpenpsZWpzLmNvbS8KICoKICogQ29weXJpZ2h0IDIwMTMgalF1ZXJ5IEZvdW5kYXRpb24sIEluYy4gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQogKgogKiBEYXRlOiAyMDEzLTA2LTAzCiAqLwooZnVuY3Rpb24oIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGksCglzdXBwb3J0LAoJY2FjaGVkcnVucywKCUV4cHIsCglnZXRUZXh0LAoJaXNYTUwsCgljb21waWxlLAoJb3V0ZXJtb3N0Q29udGV4dCwKCXNvcnRJbnB1dCwKCgkvLyBMb2NhbCBkb2N1bWVudCB2YXJzCglzZXREb2N1bWVudCwKCWRvY3VtZW50LAoJZG9jRWxlbSwKCWRvY3VtZW50SXNIVE1MLAoJcmJ1Z2d5UVNBLAoJcmJ1Z2d5TWF0Y2hlcywKCW1hdGNoZXMsCgljb250YWlucywKCgkvLyBJbnN0YW5jZS1zcGVjaWZpYyBkYXRhCglleHBhbmRvID0gInNpenpsZSIgKyAtKG5ldyBEYXRlKCkpLAoJcHJlZmVycmVkRG9jID0gd2luZG93LmRvY3VtZW50LAoJZGlycnVucyA9IDAsCglkb25lID0gMCwKCWNsYXNzQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAoJdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksCgljb21waWxlckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKCWhhc0R1cGxpY2F0ZSA9IGZhbHNlLAoJc29ydE9yZGVyID0gZnVuY3Rpb24oIGEsIGIgKSB7CgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgkJcmV0dXJuIDA7Cgl9LAoKCS8vIEdlbmVyYWwtcHVycG9zZSBjb25zdGFudHMKCXN0cnVuZGVmaW5lZCA9IHR5cGVvZiB1bmRlZmluZWQsCglNQVhfTkVHQVRJVkUgPSAxIDw8IDMxLAoKCS8vIEluc3RhbmNlIG1ldGhvZHMKCWhhc093biA9ICh7fSkuaGFzT3duUHJvcGVydHksCglhcnIgPSBbXSwKCXBvcCA9IGFyci5wb3AsCglwdXNoX25hdGl2ZSA9IGFyci5wdXNoLAoJcHVzaCA9IGFyci5wdXNoLAoJc2xpY2UgPSBhcnIuc2xpY2UsCgkvLyBVc2UgYSBzdHJpcHBlZC1kb3duIGluZGV4T2YgaWYgd2UgY2FuJ3QgdXNlIGEgbmF0aXZlIG9uZQoJaW5kZXhPZiA9IGFyci5pbmRleE9mIHx8IGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBpID0gMCwKCQkJbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJCWlmICggdGhpc1tpXSA9PT0gZWxlbSApIHsKCQkJCXJldHVybiBpOwoJCQl9CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJYm9vbGVhbnMgPSAiY2hlY2tlZHxzZWxlY3RlZHxhc3luY3xhdXRvZm9jdXN8YXV0b3BsYXl8Y29udHJvbHN8ZGVmZXJ8ZGlzYWJsZWR8aGlkZGVufGlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAoKCS8vIFJlZ3VsYXIgZXhwcmVzc2lvbnMKCgkvLyBXaGl0ZXNwYWNlIGNoYXJhY3RlcnMgaHR0cDovL3d3dy53My5vcmcvVFIvY3NzMy1zZWxlY3RvcnMvI3doaXRlc3BhY2UKCXdoaXRlc3BhY2UgPSAiW1xceDIwXFx0XFxyXFxuXFxmXSIsCgkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXN5bnRheC8jY2hhcmFjdGVycwoJY2hhcmFjdGVyRW5jb2RpbmcgPSAiKD86XFxcXC58W1xcdy1dfFteXFx4MDAtXFx4YTBdKSsiLAoKCS8vIExvb3NlbHkgbW9kZWxlZCBvbiBDU1MgaWRlbnRpZmllciBjaGFyYWN0ZXJzCgkvLyBBbiB1bnF1b3RlZCB2YWx1ZSBzaG91bGQgYmUgYSBDU1MgaWRlbnRpZmllciBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jYXR0cmlidXRlLXNlbGVjdG9ycwoJLy8gUHJvcGVyIHN5bnRheDogaHR0cDovL3d3dy53My5vcmcvVFIvQ1NTMjEvc3luZGF0YS5odG1sI3ZhbHVlLWRlZi1pZGVudGlmaWVyCglpZGVudGlmaWVyID0gY2hhcmFjdGVyRW5jb2RpbmcucmVwbGFjZSggInciLCAidyMiICksCgoJLy8gQWNjZXB0YWJsZSBvcGVyYXRvcnMgaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNhdHRyaWJ1dGUtc2VsZWN0b3JzCglhdHRyaWJ1dGVzID0gIlxcWyIgKyB3aGl0ZXNwYWNlICsgIiooIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICsgd2hpdGVzcGFjZSArCgkJIiooPzooWypeJHwhfl0/PSkiICsgd2hpdGVzcGFjZSArICIqKD86KFsnXCJdKSgoPzpcXFxcLnxbXlxcXFxdKSo/KVxcM3woIiArIGlkZW50aWZpZXIgKyAiKXwpfCkiICsgd2hpdGVzcGFjZSArICIqXFxdIiwKCgkvLyBQcmVmZXIgYXJndW1lbnRzIHF1b3RlZCwKCS8vICAgdGhlbiBub3QgY29udGFpbmluZyBwc2V1ZG9zL2JyYWNrZXRzLAoJLy8gICB0aGVuIGF0dHJpYnV0ZSBzZWxlY3RvcnMvbm9uLXBhcmVudGhldGljYWwgZXhwcmVzc2lvbnMsCgkvLyAgIHRoZW4gYW55dGhpbmcgZWxzZQoJLy8gVGhlc2UgcHJlZmVyZW5jZXMgYXJlIGhlcmUgdG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzCgkvLyAgIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIFBTRVVETyBwcmVGaWx0ZXIKCXBzZXVkb3MgPSAiOigiICsgY2hhcmFjdGVyRW5jb2RpbmcgKyAiKSg/OlxcKCgoWydcIl0pKCg/OlxcXFwufFteXFxcXF0pKj8pXFwzfCgoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzLnJlcGxhY2UoIDMsIDggKSArICIpKil8LiopXFwpfCkiLAoKCS8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKCXJ0cmltID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIiApLAoKCXJjb21tYSA9IG5ldyBSZWdFeHAoICJeIiArIHdoaXRlc3BhY2UgKyAiKiwiICsgd2hpdGVzcGFjZSArICIqIiApLAoJcmNvbWJpbmF0b3JzID0gbmV3IFJlZ0V4cCggIl4iICsgd2hpdGVzcGFjZSArICIqKFs+K35dfCIgKyB3aGl0ZXNwYWNlICsgIikiICsgd2hpdGVzcGFjZSArICIqIiApLAoKCXJzaWJsaW5nID0gbmV3IFJlZ0V4cCggd2hpdGVzcGFjZSArICIqWyt+XSIgKSwKCXJhdHRyaWJ1dGVRdW90ZXMgPSBuZXcgUmVnRXhwKCAiPSIgKyB3aGl0ZXNwYWNlICsgIiooW15cXF0nXCJdKikiICsgd2hpdGVzcGFjZSArICIqXFxdIiwgImciICksCgoJcnBzZXVkbyA9IG5ldyBSZWdFeHAoIHBzZXVkb3MgKSwKCXJpZGVudGlmaWVyID0gbmV3IFJlZ0V4cCggIl4iICsgaWRlbnRpZmllciArICIkIiApLAoKCW1hdGNoRXhwciA9IHsKCQkiSUQiOiBuZXcgUmVnRXhwKCAiXiMoIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIkNMQVNTIjogbmV3IFJlZ0V4cCggIl5cXC4oIiArIGNoYXJhY3RlckVuY29kaW5nICsgIikiICksCgkJIlRBRyI6IG5ldyBSZWdFeHAoICJeKCIgKyBjaGFyYWN0ZXJFbmNvZGluZy5yZXBsYWNlKCAidyIsICJ3KiIgKSArICIpIiApLAoJCSJBVFRSIjogbmV3IFJlZ0V4cCggIl4iICsgYXR0cmlidXRlcyApLAoJCSJQU0VVRE8iOiBuZXcgUmVnRXhwKCAiXiIgKyBwc2V1ZG9zICksCgkJIkNISUxEIjogbmV3IFJlZ0V4cCggIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsKCQkJIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsKCQkJIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIgKSwKCQkiYm9vbCI6IG5ldyBSZWdFeHAoICJeKD86IiArIGJvb2xlYW5zICsgIikkIiwgImkiICksCgkJLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCgkJLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YAoJCSJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCAiXiIgKyB3aGl0ZXNwYWNlICsgIipbPit+XXw6KGV2ZW58b2RkfGVxfGd0fGx0fG50aHxmaXJzdHxsYXN0KSg/OlxcKCIgKwoJCQl3aGl0ZXNwYWNlICsgIiooKD86LVxcZCk/XFxkKikiICsgd2hpdGVzcGFjZSArICIqXFwpfCkoPz1bXi1dfCQpIiwgImkiICkKCX0sCgoJcm5hdGl2ZSA9IC9eW157XStce1xzKlxbbmF0aXZlIFx3LywKCgkvLyBFYXNpbHktcGFyc2VhYmxlL3JldHJpZXZhYmxlIElEIG9yIFRBRyBvciBDTEFTUyBzZWxlY3RvcnMKCXJxdWlja0V4cHIgPSAvXig/OiMoW1x3LV0rKXwoXHcrKXxcLihbXHctXSspKSQvLAoKCXJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAoJcmhlYWRlciA9IC9eaFxkJC9pLAoKCXJlc2NhcGUgPSAvJ3xcXC9nLAoKCS8vIENTUyBlc2NhcGVzIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKCXJ1bmVzY2FwZSA9IG5ldyBSZWdFeHAoICJcXFxcKFtcXGRhLWZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fCgiICsgd2hpdGVzcGFjZSArICIpfC4pIiwgImlnIiApLAoJZnVuZXNjYXBlID0gZnVuY3Rpb24oIF8sIGVzY2FwZWQsIGVzY2FwZWRXaGl0ZXNwYWNlICkgewoJCXZhciBoaWdoID0gIjB4IiArIGVzY2FwZWQgLSAweDEwMDAwOwoJCS8vIE5hTiBtZWFucyBub24tY29kZXBvaW50CgkJLy8gU3VwcG9ydDogRmlyZWZveAoJCS8vIFdvcmthcm91bmQgZXJyb25lb3VzIG51bWVyaWMgaW50ZXJwcmV0YXRpb24gb2YgKyIweCIKCQlyZXR1cm4gaGlnaCAhPT0gaGlnaCB8fCBlc2NhcGVkV2hpdGVzcGFjZSA/CgkJCWVzY2FwZWQgOgoJCQkvLyBCTVAgY29kZXBvaW50CgkJCWhpZ2ggPCAwID8KCQkJCVN0cmluZy5mcm9tQ2hhckNvZGUoIGhpZ2ggKyAweDEwMDAwICkgOgoJCQkJLy8gU3VwcGxlbWVudGFsIFBsYW5lIGNvZGVwb2ludCAoc3Vycm9nYXRlIHBhaXIpCgkJCQlTdHJpbmcuZnJvbUNoYXJDb2RlKCBoaWdoID4+IDEwIHwgMHhEODAwLCBoaWdoICYgMHgzRkYgfCAweERDMDAgKTsKCX07CgovLyBPcHRpbWl6ZSBmb3IgcHVzaC5hcHBseSggXywgTm9kZUxpc3QgKQp0cnkgewoJcHVzaC5hcHBseSgKCQkoYXJyID0gc2xpY2UuY2FsbCggcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMgKSksCgkJcHJlZmVycmVkRG9jLmNoaWxkTm9kZXMKCSk7CgkvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMAoJLy8gRGV0ZWN0IHNpbGVudGx5IGZhaWxpbmcgcHVzaC5hcHBseQoJYXJyWyBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcy5sZW5ndGggXS5ub2RlVHlwZTsKfSBjYXRjaCAoIGUgKSB7CglwdXNoID0geyBhcHBseTogYXJyLmxlbmd0aCA/CgoJCS8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCgkJZnVuY3Rpb24oIHRhcmdldCwgZWxzICkgewoJCQlwdXNoX25hdGl2ZS5hcHBseSggdGFyZ2V0LCBzbGljZS5jYWxsKGVscykgKTsKCQl9IDoKCgkJLy8gU3VwcG9ydDogSUU8OQoJCS8vIE90aGVyd2lzZSBhcHBlbmQgZGlyZWN0bHkKCQlmdW5jdGlvbiggdGFyZ2V0LCBlbHMgKSB7CgkJCXZhciBqID0gdGFyZ2V0Lmxlbmd0aCwKCQkJCWkgPSAwOwoJCQkvLyBDYW4ndCB0cnVzdCBOb2RlTGlzdC5sZW5ndGgKCQkJd2hpbGUgKCAodGFyZ2V0W2orK10gPSBlbHNbaSsrXSkgKSB7fQoJCQl0YXJnZXQubGVuZ3RoID0gaiAtIDE7CgkJfQoJfTsKfQoKZnVuY3Rpb24gU2l6emxlKCBzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCApIHsKCXZhciBtYXRjaCwgZWxlbSwgbSwgbm9kZVR5cGUsCgkJLy8gUVNBIHZhcnMKCQlpLCBncm91cHMsIG9sZCwgbmlkLCBuZXdDb250ZXh0LCBuZXdTZWxlY3RvcjsKCglpZiAoICggY29udGV4dCA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogcHJlZmVycmVkRG9jICkgIT09IGRvY3VtZW50ICkgewoJCXNldERvY3VtZW50KCBjb250ZXh0ICk7Cgl9CgoJY29udGV4dCA9IGNvbnRleHQgfHwgZG9jdW1lbnQ7CglyZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCglpZiAoICFzZWxlY3RvciB8fCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCXJldHVybiByZXN1bHRzOwoJfQoKCWlmICggKG5vZGVUeXBlID0gY29udGV4dC5ub2RlVHlwZSkgIT09IDEgJiYgbm9kZVR5cGUgIT09IDkgKSB7CgkJcmV0dXJuIFtdOwoJfQoKCWlmICggZG9jdW1lbnRJc0hUTUwgJiYgIXNlZWQgKSB7CgoJCS8vIFNob3J0Y3V0cwoJCWlmICggKG1hdGNoID0gcnF1aWNrRXhwci5leGVjKCBzZWxlY3RvciApKSApIHsKCQkJLy8gU3BlZWQtdXA6IFNpenpsZSgiI0lEIikKCQkJaWYgKCAobSA9IG1hdGNoWzFdKSApIHsKCQkJCWlmICggbm9kZVR5cGUgPT09IDkgKSB7CgkJCQkJZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIG0gKTsKCQkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJCS8vIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgZG9jdW1lbnQgIzY5NjMKCQkJCQlpZiAoIGVsZW0gJiYgZWxlbS5wYXJlbnROb2RlICkgewoJCQkJCQkvLyBIYW5kbGUgdGhlIGNhc2Ugd2hlcmUgSUUsIE9wZXJhLCBhbmQgV2Via2l0IHJldHVybiBpdGVtcwoJCQkJCQkvLyBieSBuYW1lIGluc3RlYWQgb2YgSUQKCQkJCQkJaWYgKCBlbGVtLmlkID09PSBtICkgewoJCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCQlyZXR1cm4gcmVzdWx0czsKCQkJCQkJfQoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJLy8gQ29udGV4dCBpcyBub3QgYSBkb2N1bWVudAoJCQkJCWlmICggY29udGV4dC5vd25lckRvY3VtZW50ICYmIChlbGVtID0gY29udGV4dC5vd25lckRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBtICkpICYmCgkJCQkJCWNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICkgJiYgZWxlbS5pZCA9PT0gbSApIHsKCQkJCQkJcmVzdWx0cy5wdXNoKCBlbGVtICk7CgkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFNwZWVkLXVwOiBTaXp6bGUoIlRBRyIpCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzJdICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSggc2VsZWN0b3IgKSApOwoJCQkJcmV0dXJuIHJlc3VsdHM7CgoJCQkvLyBTcGVlZC11cDogU2l6emxlKCIuQ0xBU1MiKQoJCQl9IGVsc2UgaWYgKCAobSA9IG1hdGNoWzNdKSAmJiBzdXBwb3J0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICkgewoJCQkJcHVzaC5hcHBseSggcmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBtICkgKTsKCQkJCXJldHVybiByZXN1bHRzOwoJCQl9CgkJfQoKCQkvLyBRU0EgcGF0aAoJCWlmICggc3VwcG9ydC5xc2EgJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KCBzZWxlY3RvciApKSApIHsKCQkJbmlkID0gb2xkID0gZXhwYW5kbzsKCQkJbmV3Q29udGV4dCA9IGNvbnRleHQ7CgkJCW5ld1NlbGVjdG9yID0gbm9kZVR5cGUgPT09IDkgJiYgc2VsZWN0b3I7CgoJCQkvLyBxU0Egd29ya3Mgc3RyYW5nZWx5IG9uIEVsZW1lbnQtcm9vdGVkIHF1ZXJpZXMKCQkJLy8gV2UgY2FuIHdvcmsgYXJvdW5kIHRoaXMgYnkgc3BlY2lmeWluZyBhbiBleHRyYSBJRCBvbiB0aGUgcm9vdAoJCQkvLyBhbmQgd29ya2luZyB1cCBmcm9tIHRoZXJlIChUaGFua3MgdG8gQW5kcmV3IER1cG9udCBmb3IgdGhlIHRlY2huaXF1ZSkKCQkJLy8gSUUgOCBkb2Vzbid0IHdvcmsgb24gb2JqZWN0IGVsZW1lbnRzCgkJCWlmICggbm9kZVR5cGUgPT09IDEgJiYgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IiApIHsKCQkJCWdyb3VwcyA9IHRva2VuaXplKCBzZWxlY3RvciApOwoKCQkJCWlmICggKG9sZCA9IGNvbnRleHQuZ2V0QXR0cmlidXRlKCJpZCIpKSApIHsKCQkJCQluaWQgPSBvbGQucmVwbGFjZSggcmVzY2FwZSwgIlxcJCYiICk7CgkJCQl9IGVsc2UgewoJCQkJCWNvbnRleHQuc2V0QXR0cmlidXRlKCAiaWQiLCBuaWQgKTsKCQkJCX0KCQkJCW5pZCA9ICJbaWQ9JyIgKyBuaWQgKyAiJ10gIjsKCgkJCQlpID0gZ3JvdXBzLmxlbmd0aDsKCQkJCXdoaWxlICggaS0tICkgewoJCQkJCWdyb3Vwc1tpXSA9IG5pZCArIHRvU2VsZWN0b3IoIGdyb3Vwc1tpXSApOwoJCQkJfQoJCQkJbmV3Q29udGV4dCA9IHJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkgJiYgY29udGV4dC5wYXJlbnROb2RlIHx8IGNvbnRleHQ7CgkJCQluZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CgkJCX0KCgkJCWlmICggbmV3U2VsZWN0b3IgKSB7CgkJCQl0cnkgewoJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsCgkJCQkJCW5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbCggbmV3U2VsZWN0b3IgKQoJCQkJCSk7CgkJCQkJcmV0dXJuIHJlc3VsdHM7CgkJCQl9IGNhdGNoKHFzYUVycm9yKSB7CgkJCQl9IGZpbmFsbHkgewoJCQkJCWlmICggIW9sZCApIHsKCQkJCQkJY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoImlkIik7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJfQoKCS8vIEFsbCBvdGhlcnMKCXJldHVybiBzZWxlY3QoIHNlbGVjdG9yLnJlcGxhY2UoIHJ0cmltLCAiJDEiICksIGNvbnRleHQsIHJlc3VsdHMsIHNlZWQgKTsKfQoKLyoqCiAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogKiBAcmV0dXJucyB7RnVuY3Rpb24oc3RyaW5nLCBPYmplY3QpfSBSZXR1cm5zIHRoZSBPYmplY3QgZGF0YSBhZnRlciBzdG9yaW5nIGl0IG9uIGl0c2VsZiB3aXRoCiAqCXByb3BlcnR5IG5hbWUgdGhlIChzcGFjZS1zdWZmaXhlZCkgc3RyaW5nIGFuZCAoaWYgdGhlIGNhY2hlIGlzIGxhcmdlciB0aGFuIEV4cHIuY2FjaGVMZW5ndGgpCiAqCWRlbGV0aW5nIHRoZSBvbGRlc3QgZW50cnkKICovCmZ1bmN0aW9uIGNyZWF0ZUNhY2hlKCkgewoJdmFyIGtleXMgPSBbXTsKCglmdW5jdGlvbiBjYWNoZSgga2V5LCB2YWx1ZSApIHsKCQkvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKCQlpZiAoIGtleXMucHVzaCgga2V5ICs9ICIgIiApID4gRXhwci5jYWNoZUxlbmd0aCApIHsKCQkJLy8gT25seSBrZWVwIHRoZSBtb3N0IHJlY2VudCBlbnRyaWVzCgkJCWRlbGV0ZSBjYWNoZVsga2V5cy5zaGlmdCgpIF07CgkJfQoJCXJldHVybiAoY2FjaGVbIGtleSBdID0gdmFsdWUpOwoJfQoJcmV0dXJuIGNhY2hlOwp9CgovKioKICogTWFyayBhIGZ1bmN0aW9uIGZvciBzcGVjaWFsIHVzZSBieSBTaXp6bGUKICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gVGhlIGZ1bmN0aW9uIHRvIG1hcmsKICovCmZ1bmN0aW9uIG1hcmtGdW5jdGlvbiggZm4gKSB7CglmblsgZXhwYW5kbyBdID0gdHJ1ZTsKCXJldHVybiBmbjsKfQoKLyoqCiAqIFN1cHBvcnQgdGVzdGluZyB1c2luZyBhbiBlbGVtZW50CiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIFBhc3NlZCB0aGUgY3JlYXRlZCBkaXYgYW5kIGV4cGVjdHMgYSBib29sZWFuIHJlc3VsdAogKi8KZnVuY3Rpb24gYXNzZXJ0KCBmbiApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCgl0cnkgewoJCXJldHVybiAhIWZuKCBkaXYgKTsKCX0gY2F0Y2ggKGUpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9IGZpbmFsbHkgewoJCS8vIFJlbW92ZSBmcm9tIGl0cyBwYXJlbnQgYnkgZGVmYXVsdAoJCWlmICggZGl2LnBhcmVudE5vZGUgKSB7CgkJCWRpdi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCBkaXYgKTsKCQl9CgkJLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKCQlkaXYgPSBudWxsOwoJfQp9CgovKioKICogQWRkcyB0aGUgc2FtZSBoYW5kbGVyIGZvciBhbGwgb2YgdGhlIHNwZWNpZmllZCBhdHRycwogKiBAcGFyYW0ge1N0cmluZ30gYXR0cnMgUGlwZS1zZXBhcmF0ZWQgbGlzdCBvZiBhdHRyaWJ1dGVzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogKi8KZnVuY3Rpb24gYWRkSGFuZGxlKCBhdHRycywgaGFuZGxlciApIHsKCXZhciBhcnIgPSBhdHRycy5zcGxpdCgifCIpLAoJCWkgPSBhdHRycy5sZW5ndGg7CgoJd2hpbGUgKCBpLS0gKSB7CgkJRXhwci5hdHRySGFuZGxlWyBhcnJbaV0gXSA9IGhhbmRsZXI7Cgl9Cn0KCi8qKgogKiBDaGVja3MgZG9jdW1lbnQgb3JkZXIgb2YgdHdvIHNpYmxpbmdzCiAqIEBwYXJhbSB7RWxlbWVudH0gYQogKiBAcGFyYW0ge0VsZW1lbnR9IGIKICogQHJldHVybnMge051bWJlcn0gUmV0dXJucyBsZXNzIHRoYW4gMCBpZiBhIHByZWNlZGVzIGIsIGdyZWF0ZXIgdGhhbiAwIGlmIGEgZm9sbG93cyBiCiAqLwpmdW5jdGlvbiBzaWJsaW5nQ2hlY2soIGEsIGIgKSB7Cgl2YXIgY3VyID0gYiAmJiBhLAoJCWRpZmYgPSBjdXIgJiYgYS5ub2RlVHlwZSA9PT0gMSAmJiBiLm5vZGVUeXBlID09PSAxICYmCgkJCSggfmIuc291cmNlSW5kZXggfHwgTUFYX05FR0FUSVZFICkgLQoJCQkoIH5hLnNvdXJjZUluZGV4IHx8IE1BWF9ORUdBVElWRSApOwoKCS8vIFVzZSBJRSBzb3VyY2VJbmRleCBpZiBhdmFpbGFibGUgb24gYm90aCBub2RlcwoJaWYgKCBkaWZmICkgewoJCXJldHVybiBkaWZmOwoJfQoKCS8vIENoZWNrIGlmIGIgZm9sbG93cyBhCglpZiAoIGN1ciApIHsKCQl3aGlsZSAoIChjdXIgPSBjdXIubmV4dFNpYmxpbmcpICkgewoJCQlpZiAoIGN1ciA9PT0gYiApIHsKCQkJCXJldHVybiAtMTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gYSA/IDEgOiAtMTsKfQoKLyoqCiAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgaW5wdXQgdHlwZXMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUlucHV0UHNldWRvKCB0eXBlICkgewoJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCXZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICovCmZ1bmN0aW9uIGNyZWF0ZUJ1dHRvblBzZXVkbyggdHlwZSApIHsKCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQlyZXR1cm4gKG5hbWUgPT09ICJpbnB1dCIgfHwgbmFtZSA9PT0gImJ1dHRvbiIpICYmIGVsZW0udHlwZSA9PT0gdHlwZTsKCX07Cn0KCi8qKgogKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIHBvc2l0aW9uYWxzCiAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAqLwpmdW5jdGlvbiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKCBmbiApIHsKCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIGFyZ3VtZW50ICkgewoJCWFyZ3VtZW50ID0gK2FyZ3VtZW50OwoJCXJldHVybiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCXZhciBqLAoJCQkJbWF0Y2hJbmRleGVzID0gZm4oIFtdLCBzZWVkLmxlbmd0aCwgYXJndW1lbnQgKSwKCQkJCWkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKCQkJLy8gTWF0Y2ggZWxlbWVudHMgZm91bmQgYXQgdGhlIHNwZWNpZmllZCBpbmRleGVzCgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCBzZWVkWyAoaiA9IG1hdGNoSW5kZXhlc1tpXSkgXSApIHsKCQkJCQlzZWVkW2pdID0gIShtYXRjaGVzW2pdID0gc2VlZFtqXSk7CgkJCQl9CgkJCX0KCQl9KTsKCX0pOwp9CgovKioKICogRGV0ZWN0IHhtbAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBlbGVtIEFuIGVsZW1lbnQgb3IgYSBkb2N1bWVudAogKi8KaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiggZWxlbSApIHsKCS8vIGRvY3VtZW50RWxlbWVudCBpcyB2ZXJpZmllZCBmb3IgY2FzZXMgd2hlcmUgaXQgZG9lc24ndCB5ZXQgZXhpc3QKCS8vIChzdWNoIGFzIGxvYWRpbmcgaWZyYW1lcyBpbiBJRSAtICM0ODMzKQoJdmFyIGRvY3VtZW50RWxlbWVudCA9IGVsZW0gJiYgKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKS5kb2N1bWVudEVsZW1lbnQ7CglyZXR1cm4gZG9jdW1lbnRFbGVtZW50ID8gZG9jdW1lbnRFbGVtZW50Lm5vZGVOYW1lICE9PSAiSFRNTCIgOiBmYWxzZTsKfTsKCi8vIEV4cG9zZSBzdXBwb3J0IHZhcnMgZm9yIGNvbnZlbmllbmNlCnN1cHBvcnQgPSBTaXp6bGUuc3VwcG9ydCA9IHt9OwoKLyoqCiAqIFNldHMgZG9jdW1lbnQtcmVsYXRlZCB2YXJpYWJsZXMgb25jZSBiYXNlZCBvbiB0aGUgY3VycmVudCBkb2N1bWVudAogKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjdXJyZW50IGRvY3VtZW50CiAqLwpzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uKCBub2RlICkgewoJdmFyIGRvYyA9IG5vZGUgPyBub2RlLm93bmVyRG9jdW1lbnQgfHwgbm9kZSA6IHByZWZlcnJlZERvYywKCQlwYXJlbnQgPSBkb2MuZGVmYXVsdFZpZXc7CgoJLy8gSWYgbm8gZG9jdW1lbnQgYW5kIGRvY3VtZW50RWxlbWVudCBpcyBhdmFpbGFibGUsIHJldHVybgoJaWYgKCBkb2MgPT09IGRvY3VtZW50IHx8IGRvYy5ub2RlVHlwZSAhPT0gOSB8fCAhZG9jLmRvY3VtZW50RWxlbWVudCApIHsKCQlyZXR1cm4gZG9jdW1lbnQ7Cgl9CgoJLy8gU2V0IG91ciBkb2N1bWVudAoJZG9jdW1lbnQgPSBkb2M7Cglkb2NFbGVtID0gZG9jLmRvY3VtZW50RWxlbWVudDsKCgkvLyBTdXBwb3J0IHRlc3RzCglkb2N1bWVudElzSFRNTCA9ICFpc1hNTCggZG9jICk7CgoJLy8gU3VwcG9ydDogSUU+OAoJLy8gSWYgaWZyYW1lIGRvY3VtZW50IGlzIGFzc2lnbmVkIHRvICJkb2N1bWVudCIgdmFyaWFibGUgYW5kIGlmIGlmcmFtZSBoYXMgYmVlbiByZWxvYWRlZCwKCS8vIElFIHdpbGwgdGhyb3cgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIGFjY2Vzc2luZyAiZG9jdW1lbnQiIHZhcmlhYmxlLCBzZWUgalF1ZXJ5ICMxMzkzNgoJLy8gSUU2LTggZG8gbm90IHN1cHBvcnQgdGhlIGRlZmF1bHRWaWV3IHByb3BlcnR5IHNvIHBhcmVudCB3aWxsIGJlIHVuZGVmaW5lZAoJaWYgKCBwYXJlbnQgJiYgcGFyZW50LmF0dGFjaEV2ZW50ICYmIHBhcmVudCAhPT0gcGFyZW50LnRvcCApIHsKCQlwYXJlbnQuYXR0YWNoRXZlbnQoICJvbmJlZm9yZXVubG9hZCIsIGZ1bmN0aW9uKCkgewoJCQlzZXREb2N1bWVudCgpOwoJCX0pOwoJfQoKCS8qIEF0dHJpYnV0ZXMKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBTdXBwb3J0OiBJRTw4CgkvLyBWZXJpZnkgdGhhdCBnZXRBdHRyaWJ1dGUgcmVhbGx5IHJldHVybnMgYXR0cmlidXRlcyBhbmQgbm90IHByb3BlcnRpZXMgKGV4Y2VwdGluZyBJRTggYm9vbGVhbnMpCglzdXBwb3J0LmF0dHJpYnV0ZXMgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuY2xhc3NOYW1lID0gImkiOwoJCXJldHVybiAhZGl2LmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7Cgl9KTsKCgkvKiBnZXRFbGVtZW50KHMpQnkqCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeVRhZ05hbWUoIioiKSByZXR1cm5zIG9ubHkgZWxlbWVudHMKCXN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkaXYuYXBwZW5kQ2hpbGQoIGRvYy5jcmVhdGVDb21tZW50KCIiKSApOwoJCXJldHVybiAhZGl2LmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoOwoJfSk7CgoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSBjYW4gYmUgdHJ1c3RlZAoJc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CgkJZGl2LmlubmVySFRNTCA9ICI8ZGl2IGNsYXNzPSdhJz48L2Rpdj48ZGl2IGNsYXNzPSdhIGknPjwvZGl2PiI7CgoJCS8vIFN1cHBvcnQ6IFNhZmFyaTw0CgkJLy8gQ2F0Y2ggY2xhc3Mgb3Zlci1jYWNoaW5nCgkJZGl2LmZpcnN0Q2hpbGQuY2xhc3NOYW1lID0gImkiOwoJCS8vIFN1cHBvcnQ6IE9wZXJhPDEwCgkJLy8gQ2F0Y2ggZ0VCQ04gZmFpbHVyZSB0byBmaW5kIG5vbi1sZWFkaW5nIGNsYXNzZXMKCQlyZXR1cm4gZGl2LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoImkiKS5sZW5ndGggPT09IDI7Cgl9KTsKCgkvLyBTdXBwb3J0OiBJRTwxMAoJLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCgkvLyBUaGUgYnJva2VuIGdldEVsZW1lbnRCeUlkIG1ldGhvZHMgZG9uJ3QgcGljayB1cCBwcm9ncmFtYXRpY2FsbHktc2V0IG5hbWVzLAoJLy8gc28gdXNlIGEgcm91bmRhYm91dCBnZXRFbGVtZW50c0J5TmFtZSB0ZXN0CglzdXBwb3J0LmdldEJ5SWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCQlkb2NFbGVtLmFwcGVuZENoaWxkKCBkaXYgKS5pZCA9IGV4cGFuZG87CgkJcmV0dXJuICFkb2MuZ2V0RWxlbWVudHNCeU5hbWUgfHwgIWRvYy5nZXRFbGVtZW50c0J5TmFtZSggZXhwYW5kbyApLmxlbmd0aDsKCX0pOwoKCS8vIElEIGZpbmQgYW5kIGZpbHRlcgoJaWYgKCBzdXBwb3J0LmdldEJ5SWQgKSB7CgkJRXhwci5maW5kWyJJRCJdID0gZnVuY3Rpb24oIGlkLCBjb250ZXh0ICkgewoJCQlpZiAoIHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSBzdHJ1bmRlZmluZWQgJiYgZG9jdW1lbnRJc0hUTUwgKSB7CgkJCQl2YXIgbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoIGlkICk7CgkJCQkvLyBDaGVjayBwYXJlbnROb2RlIHRvIGNhdGNoIHdoZW4gQmxhY2tiZXJyeSA0LjYgcmV0dXJucwoJCQkJLy8gbm9kZXMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSBkb2N1bWVudCAjNjk2MwoJCQkJcmV0dXJuIG0gJiYgbS5wYXJlbnROb2RlID8gW21dIDogW107CgkJCX0KCQl9OwoJCUV4cHIuZmlsdGVyWyJJRCJdID0gZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJpZCIpID09PSBhdHRySWQ7CgkJCX07CgkJfTsKCX0gZWxzZSB7CgkJLy8gU3VwcG9ydDogSUU2LzcKCQkvLyBnZXRFbGVtZW50QnlJZCBpcyBub3QgcmVsaWFibGUgYXMgYSBmaW5kIHNob3J0Y3V0CgkJZGVsZXRlIEV4cHIuZmluZFsiSUQiXTsKCgkJRXhwci5maWx0ZXJbIklEIl0gPSAgZnVuY3Rpb24oIGlkICkgewoJCQl2YXIgYXR0cklkID0gaWQucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIG5vZGUgPSB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKCJpZCIpOwoJCQkJcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwoJCQl9OwoJCX07Cgl9CgoJLy8gVGFnCglFeHByLmZpbmRbIlRBRyJdID0gc3VwcG9ydC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJaWYgKCB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gc3RydW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoJCQl9CgkJfSA6CgkJZnVuY3Rpb24oIHRhZywgY29udGV4dCApIHsKCQkJdmFyIGVsZW0sCgkJCQl0bXAgPSBbXSwKCQkJCWkgPSAwLAoJCQkJcmVzdWx0cyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyApOwoKCQkJLy8gRmlsdGVyIG91dCBwb3NzaWJsZSBjb21tZW50cwoJCQlpZiAoIHRhZyA9PT0gIioiICkgewoJCQkJd2hpbGUgKCAoZWxlbSA9IHJlc3VsdHNbaSsrXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQl0bXAucHVzaCggZWxlbSApOwoJCQkJCX0KCQkJCX0KCgkJCQlyZXR1cm4gdG1wOwoJCQl9CgkJCXJldHVybiByZXN1bHRzOwoJCX07CgoJLy8gQ2xhc3MKCUV4cHIuZmluZFsiQ0xBU1MiXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiBmdW5jdGlvbiggY2xhc3NOYW1lLCBjb250ZXh0ICkgewoJCWlmICggdHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gc3RydW5kZWZpbmVkICYmIGRvY3VtZW50SXNIVE1MICkgewoJCQlyZXR1cm4gY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCBjbGFzc05hbWUgKTsKCQl9Cgl9OwoKCS8qIFFTQS9tYXRjaGVzU2VsZWN0b3IKCS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCgkvLyBRU0EgYW5kIG1hdGNoZXNTZWxlY3RvciBzdXBwb3J0CgoJLy8gbWF0Y2hlc1NlbGVjdG9yKDphY3RpdmUpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChJRTkvT3BlcmEgMTEuNSkKCXJidWdneU1hdGNoZXMgPSBbXTsKCgkvLyBxU2EoOmZvY3VzKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoQ2hyb21lIDIxKQoJLy8gV2UgYWxsb3cgdGhpcyBiZWNhdXNlIG9mIGEgYnVnIGluIElFOC85IHRoYXQgdGhyb3dzIGFuIGVycm9yCgkvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCgkvLyBTbywgd2UgYWxsb3cgOmZvY3VzIHRvIHBhc3MgdGhyb3VnaCBRU0EgYWxsIHRoZSB0aW1lIHRvIGF2b2lkIHRoZSBJRSBlcnJvcgoJLy8gU2VlIGh0dHA6Ly9idWdzLmpxdWVyeS5jb20vdGlja2V0LzEzMzc4CglyYnVnZ3lRU0EgPSBbXTsKCglpZiAoIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdCggZG9jLnF1ZXJ5U2VsZWN0b3JBbGwgKSkgKSB7CgkJLy8gQnVpbGQgUVNBIHJlZ2V4CgkJLy8gUmVnZXggc3RyYXRlZ3kgYWRvcHRlZCBmcm9tIERpZWdvIFBlcmluaQoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBTZWxlY3QgaXMgc2V0IHRvIGVtcHR5IHN0cmluZyBvbiBwdXJwb3NlCgkJCS8vIFRoaXMgaXMgdG8gdGVzdCBJRSdzIHRyZWF0bWVudCBvZiBub3QgZXhwbGljaXRseQoJCQkvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKCQkJLy8gc2luY2UgaXRzIHByZXNlbmNlIHNob3VsZCBiZSBlbm91Z2gKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKCQkJZGl2LmlubmVySFRNTCA9ICI8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9Jyc+PC9vcHRpb24+PC9zZWxlY3Q+IjsKCgkJCS8vIFN1cHBvcnQ6IElFOAoJCQkvLyBCb29sZWFuIGF0dHJpYnV0ZXMgYW5kICJ2YWx1ZSIgYXJlIG5vdCB0cmVhdGVkIGNvcnJlY3RseQoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIiApOwoJCQl9CgoJCQkvLyBXZWJraXQvT3BlcmEgLSA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIHNlbGVjdGVkIG9wdGlvbiBlbGVtZW50cwoJCQkvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCgiOmNoZWNrZWQiKTsKCQkJfQoJCX0pOwoKCQlhc3NlcnQoZnVuY3Rpb24oIGRpdiApIHsKCgkJCS8vIFN1cHBvcnQ6IE9wZXJhIDEwLTEyL0lFOAoJCQkvLyBePSAkPSAqPSBhbmQgZW1wdHkgdmFsdWVzCgkJCS8vIFNob3VsZCBub3Qgc2VsZWN0IGFueXRoaW5nCgkJCS8vIFN1cHBvcnQ6IFdpbmRvd3MgOCBOYXRpdmUgQXBwcwoJCQkvLyBUaGUgdHlwZSBhdHRyaWJ1dGUgaXMgcmVzdHJpY3RlZCBkdXJpbmcgLmlubmVySFRNTCBhc3NpZ25tZW50CgkJCXZhciBpbnB1dCA9IGRvYy5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCQlpbnB1dC5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgImhpZGRlbiIgKTsKCQkJZGl2LmFwcGVuZENoaWxkKCBpbnB1dCApLnNldEF0dHJpYnV0ZSggInQiLCAiIiApOwoKCQkJaWYgKCBkaXYucXVlcnlTZWxlY3RvckFsbCgiW3RePScnXSIpLmxlbmd0aCApIHsKCQkJCXJidWdneVFTQS5wdXNoKCAiWypeJF09IiArIHdoaXRlc3BhY2UgKyAiKig/OicnfFwiXCIpIiApOwoJCQl9CgoJCQkvLyBGRiAzLjUgLSA6ZW5hYmxlZC86ZGlzYWJsZWQgYW5kIGhpZGRlbiBlbGVtZW50cyAoaGlkZGVuIGVsZW1lbnRzIGFyZSBzdGlsbCBlbmFibGVkKQoJCQkvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwoJCQlpZiAoICFkaXYucXVlcnlTZWxlY3RvckFsbCgiOmVuYWJsZWQiKS5sZW5ndGggKSB7CgkJCQlyYnVnZ3lRU0EucHVzaCggIjplbmFibGVkIiwgIjpkaXNhYmxlZCIgKTsKCQkJfQoKCQkJLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKCQkJZGl2LnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKCQkJcmJ1Z2d5UVNBLnB1c2goIiwuKjoiKTsKCQl9KTsKCX0KCglpZiAoIChzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciA9IHJuYXRpdmUudGVzdCggKG1hdGNoZXMgPSBkb2NFbGVtLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fAoJCWRvY0VsZW0ubW96TWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8CgkJZG9jRWxlbS5tc01hdGNoZXNTZWxlY3RvcikgKSkgKSB7CgoJCWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJCQkvLyBDaGVjayB0byBzZWUgaWYgaXQncyBwb3NzaWJsZSB0byBkbyBtYXRjaGVzU2VsZWN0b3IKCQkJLy8gb24gYSBkaXNjb25uZWN0ZWQgbm9kZSAoSUUgOSkKCQkJc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbCggZGl2LCAiZGl2IiApOwoKCQkJLy8gVGhpcyBzaG91bGQgZmFpbCB3aXRoIGFuIGV4Y2VwdGlvbgoJCQkvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCgkJCW1hdGNoZXMuY2FsbCggZGl2LCAiW3MhPScnXTp4IiApOwoJCQlyYnVnZ3lNYXRjaGVzLnB1c2goICIhPSIsIHBzZXVkb3MgKTsKCQl9KTsKCX0KCglyYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAoIHJidWdneVFTQS5qb2luKCJ8IikgKTsKCXJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKCByYnVnZ3lNYXRjaGVzLmpvaW4oInwiKSApOwoKCS8qIENvbnRhaW5zCgktLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgoJLy8gRWxlbWVudCBjb250YWlucyBhbm90aGVyCgkvLyBQdXJwb3NlZnVsbHkgZG9lcyBub3QgaW1wbGVtZW50IGluY2x1c2l2ZSBkZXNjZW5kZW50CgkvLyBBcyBpbiwgYW4gZWxlbWVudCBkb2VzIG5vdCBjb250YWluIGl0c2VsZgoJY29udGFpbnMgPSBybmF0aXZlLnRlc3QoIGRvY0VsZW0uY29udGFpbnMgKSB8fCBkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uID8KCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJdmFyIGFkb3duID0gYS5ub2RlVHlwZSA9PT0gOSA/IGEuZG9jdW1lbnRFbGVtZW50IDogYSwKCQkJCWJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwoJCQlyZXR1cm4gYSA9PT0gYnVwIHx8ICEhKCBidXAgJiYgYnVwLm5vZGVUeXBlID09PSAxICYmICgKCQkJCWFkb3duLmNvbnRhaW5zID8KCQkJCQlhZG93bi5jb250YWlucyggYnVwICkgOgoJCQkJCWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gJiYgYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiggYnVwICkgJiAxNgoJCQkpKTsKCQl9IDoKCQlmdW5jdGlvbiggYSwgYiApIHsKCQkJaWYgKCBiICkgewoJCQkJd2hpbGUgKCAoYiA9IGIucGFyZW50Tm9kZSkgKSB7CgkJCQkJaWYgKCBiID09PSBhICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX07CgoJLyogU29ydGluZwoJLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqLwoKCS8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKCXNvcnRPcmRlciA9IGRvY0VsZW0uY29tcGFyZURvY3VtZW50UG9zaXRpb24gPwoJZnVuY3Rpb24oIGEsIGIgKSB7CgoJCS8vIEZsYWcgZm9yIGR1cGxpY2F0ZSByZW1vdmFsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCQl9CgoJCXZhciBjb21wYXJlID0gYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uICYmIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oIGIgKTsKCgkJaWYgKCBjb21wYXJlICkgewoJCQkvLyBEaXNjb25uZWN0ZWQgbm9kZXMKCQkJaWYgKCBjb21wYXJlICYgMSB8fAoJCQkJKCFzdXBwb3J0LnNvcnREZXRhY2hlZCAmJiBiLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBhICkgPT09IGNvbXBhcmUpICkgewoKCQkJCS8vIENob29zZSB0aGUgZmlyc3QgZWxlbWVudCB0aGF0IGlzIHJlbGF0ZWQgdG8gb3VyIHByZWZlcnJlZCBkb2N1bWVudAoJCQkJaWYgKCBhID09PSBkb2MgfHwgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSApIHsKCQkJCQlyZXR1cm4gLTE7CgkJCQl9CgkJCQlpZiAoIGIgPT09IGRvYyB8fCBjb250YWlucyhwcmVmZXJyZWREb2MsIGIpICkgewoJCQkJCXJldHVybiAxOwoJCQkJfQoKCQkJCS8vIE1haW50YWluIG9yaWdpbmFsIG9yZGVyCgkJCQlyZXR1cm4gc29ydElucHV0ID8KCQkJCQkoIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBhICkgLSBpbmRleE9mLmNhbGwoIHNvcnRJbnB1dCwgYiApICkgOgoJCQkJCTA7CgkJCX0KCgkJCXJldHVybiBjb21wYXJlICYgNCA/IC0xIDogMTsKCQl9CgoJCS8vIE5vdCBkaXJlY3RseSBjb21wYXJhYmxlLCBzb3J0IG9uIGV4aXN0ZW5jZSBvZiBtZXRob2QKCQlyZXR1cm4gYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiA/IC0xIDogMTsKCX0gOgoJZnVuY3Rpb24oIGEsIGIgKSB7CgkJdmFyIGN1ciwKCQkJaSA9IDAsCgkJCWF1cCA9IGEucGFyZW50Tm9kZSwKCQkJYnVwID0gYi5wYXJlbnROb2RlLAoJCQlhcCA9IFsgYSBdLAoJCQlicCA9IFsgYiBdOwoKCQkvLyBFeGl0IGVhcmx5IGlmIHRoZSBub2RlcyBhcmUgaWRlbnRpY2FsCgkJaWYgKCBhID09PSBiICkgewoJCQloYXNEdXBsaWNhdGUgPSB0cnVlOwoJCQlyZXR1cm4gMDsKCgkJLy8gUGFyZW50bGVzcyBub2RlcyBhcmUgZWl0aGVyIGRvY3VtZW50cyBvciBkaXNjb25uZWN0ZWQKCQl9IGVsc2UgaWYgKCAhYXVwIHx8ICFidXAgKSB7CgkJCXJldHVybiBhID09PSBkb2MgPyAtMSA6CgkJCQliID09PSBkb2MgPyAxIDoKCQkJCWF1cCA/IC0xIDoKCQkJCWJ1cCA/IDEgOgoJCQkJc29ydElucHV0ID8KCQkJCSggaW5kZXhPZi5jYWxsKCBzb3J0SW5wdXQsIGEgKSAtIGluZGV4T2YuY2FsbCggc29ydElucHV0LCBiICkgKSA6CgkJCQkwOwoKCQkvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawoJCX0gZWxzZSBpZiAoIGF1cCA9PT0gYnVwICkgewoJCQlyZXR1cm4gc2libGluZ0NoZWNrKCBhLCBiICk7CgkJfQoKCQkvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgoJCWN1ciA9IGE7CgkJd2hpbGUgKCAoY3VyID0gY3VyLnBhcmVudE5vZGUpICkgewoJCQlhcC51bnNoaWZ0KCBjdXIgKTsKCQl9CgkJY3VyID0gYjsKCQl3aGlsZSAoIChjdXIgPSBjdXIucGFyZW50Tm9kZSkgKSB7CgkJCWJwLnVuc2hpZnQoIGN1ciApOwoJCX0KCgkJLy8gV2FsayBkb3duIHRoZSB0cmVlIGxvb2tpbmcgZm9yIGEgZGlzY3JlcGFuY3kKCQl3aGlsZSAoIGFwW2ldID09PSBicFtpXSApIHsKCQkJaSsrOwoJCX0KCgkJcmV0dXJuIGkgPwoJCQkvLyBEbyBhIHNpYmxpbmcgY2hlY2sgaWYgdGhlIG5vZGVzIGhhdmUgYSBjb21tb24gYW5jZXN0b3IKCQkJc2libGluZ0NoZWNrKCBhcFtpXSwgYnBbaV0gKSA6CgoJCQkvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKCQkJYXBbaV0gPT09IHByZWZlcnJlZERvYyA/IC0xIDoKCQkJYnBbaV0gPT09IHByZWZlcnJlZERvYyA/IDEgOgoJCQkwOwoJfTsKCglyZXR1cm4gZG9jOwp9OwoKU2l6emxlLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgZWxlbWVudHMgKSB7CglyZXR1cm4gU2l6emxlKCBleHByLCBudWxsLCBudWxsLCBlbGVtZW50cyApOwp9OwoKU2l6emxlLm1hdGNoZXNTZWxlY3RvciA9IGZ1bmN0aW9uKCBlbGVtLCBleHByICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgkvLyBNYWtlIHN1cmUgdGhhdCBhdHRyaWJ1dGUgc2VsZWN0b3JzIGFyZSBxdW90ZWQKCWV4cHIgPSBleHByLnJlcGxhY2UoIHJhdHRyaWJ1dGVRdW90ZXMsICI9JyQxJ10iICk7CgoJaWYgKCBzdXBwb3J0Lm1hdGNoZXNTZWxlY3RvciAmJiBkb2N1bWVudElzSFRNTCAmJgoJCSggIXJidWdneU1hdGNoZXMgfHwgIXJidWdneU1hdGNoZXMudGVzdCggZXhwciApICkgJiYKCQkoICFyYnVnZ3lRU0EgICAgIHx8ICFyYnVnZ3lRU0EudGVzdCggZXhwciApICkgKSB7CgoJCXRyeSB7CgkJCXZhciByZXQgPSBtYXRjaGVzLmNhbGwoIGVsZW0sIGV4cHIgKTsKCgkJCS8vIElFIDkncyBtYXRjaGVzU2VsZWN0b3IgcmV0dXJucyBmYWxzZSBvbiBkaXNjb25uZWN0ZWQgbm9kZXMKCQkJaWYgKCByZXQgfHwgc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCB8fAoJCQkJCS8vIEFzIHdlbGwsIGRpc2Nvbm5lY3RlZCBub2RlcyBhcmUgc2FpZCB0byBiZSBpbiBhIGRvY3VtZW50CgkJCQkJLy8gZnJhZ21lbnQgaW4gSUUgOQoJCQkJCWVsZW0uZG9jdW1lbnQgJiYgZWxlbS5kb2N1bWVudC5ub2RlVHlwZSAhPT0gMTEgKSB7CgkJCQlyZXR1cm4gcmV0OwoJCQl9CgkJfSBjYXRjaChlKSB7fQoJfQoKCXJldHVybiBTaXp6bGUoIGV4cHIsIGRvY3VtZW50LCBudWxsLCBbZWxlbV0gKS5sZW5ndGggPiAwOwp9OwoKU2l6emxlLmNvbnRhaW5zID0gZnVuY3Rpb24oIGNvbnRleHQsIGVsZW0gKSB7CgkvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKCWlmICggKCBjb250ZXh0Lm93bmVyRG9jdW1lbnQgfHwgY29udGV4dCApICE9PSBkb2N1bWVudCApIHsKCQlzZXREb2N1bWVudCggY29udGV4dCApOwoJfQoJcmV0dXJuIGNvbnRhaW5zKCBjb250ZXh0LCBlbGVtICk7Cn07CgpTaXp6bGUuYXR0ciA9IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCglpZiAoICggZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0gKSAhPT0gZG9jdW1lbnQgKSB7CgkJc2V0RG9jdW1lbnQoIGVsZW0gKTsKCX0KCgl2YXIgZm4gPSBFeHByLmF0dHJIYW5kbGVbIG5hbWUudG9Mb3dlckNhc2UoKSBdLAoJCS8vIERvbid0IGdldCBmb29sZWQgYnkgT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzIChqUXVlcnkgIzEzODA3KQoJCXZhbCA9IGZuICYmIGhhc093bi5jYWxsKCBFeHByLmF0dHJIYW5kbGUsIG5hbWUudG9Mb3dlckNhc2UoKSApID8KCQkJZm4oIGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCApIDoKCQkJdW5kZWZpbmVkOwoKCXJldHVybiB2YWwgPT09IHVuZGVmaW5lZCA/CgkJc3VwcG9ydC5hdHRyaWJ1dGVzIHx8ICFkb2N1bWVudElzSFRNTCA/CgkJCWVsZW0uZ2V0QXR0cmlidXRlKCBuYW1lICkgOgoJCQkodmFsID0gZWxlbS5nZXRBdHRyaWJ1dGVOb2RlKG5hbWUpKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQludWxsIDoKCQl2YWw7Cn07CgpTaXp6bGUuZXJyb3IgPSBmdW5jdGlvbiggbXNnICkgewoJdGhyb3cgbmV3IEVycm9yKCAiU3ludGF4IGVycm9yLCB1bnJlY29nbml6ZWQgZXhwcmVzc2lvbjogIiArIG1zZyApOwp9OwoKLyoqCiAqIERvY3VtZW50IHNvcnRpbmcgYW5kIHJlbW92aW5nIGR1cGxpY2F0ZXMKICogQHBhcmFtIHtBcnJheUxpa2V9IHJlc3VsdHMKICovClNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24oIHJlc3VsdHMgKSB7Cgl2YXIgZWxlbSwKCQlkdXBsaWNhdGVzID0gW10sCgkJaiA9IDAsCgkJaSA9IDA7CgoJLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQoJaGFzRHVwbGljYXRlID0gIXN1cHBvcnQuZGV0ZWN0RHVwbGljYXRlczsKCXNvcnRJbnB1dCA9ICFzdXBwb3J0LnNvcnRTdGFibGUgJiYgcmVzdWx0cy5zbGljZSggMCApOwoJcmVzdWx0cy5zb3J0KCBzb3J0T3JkZXIgKTsKCglpZiAoIGhhc0R1cGxpY2F0ZSApIHsKCQl3aGlsZSAoIChlbGVtID0gcmVzdWx0c1tpKytdKSApIHsKCQkJaWYgKCBlbGVtID09PSByZXN1bHRzWyBpIF0gKSB7CgkJCQlqID0gZHVwbGljYXRlcy5wdXNoKCBpICk7CgkJCX0KCQl9CgkJd2hpbGUgKCBqLS0gKSB7CgkJCXJlc3VsdHMuc3BsaWNlKCBkdXBsaWNhdGVzWyBqIF0sIDEgKTsKCQl9Cgl9CgoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKioKICogVXRpbGl0eSBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyB0aGUgdGV4dCB2YWx1ZSBvZiBhbiBhcnJheSBvZiBET00gbm9kZXMKICogQHBhcmFtIHtBcnJheXxFbGVtZW50fSBlbGVtCiAqLwpnZXRUZXh0ID0gU2l6emxlLmdldFRleHQgPSBmdW5jdGlvbiggZWxlbSApIHsKCXZhciBub2RlLAoJCXJldCA9ICIiLAoJCWkgPSAwLAoJCW5vZGVUeXBlID0gZWxlbS5ub2RlVHlwZTsKCglpZiAoICFub2RlVHlwZSApIHsKCQkvLyBJZiBubyBub2RlVHlwZSwgdGhpcyBpcyBleHBlY3RlZCB0byBiZSBhbiBhcnJheQoJCWZvciAoIDsgKG5vZGUgPSBlbGVtW2ldKTsgaSsrICkgewoJCQkvLyBEbyBub3QgdHJhdmVyc2UgY29tbWVudCBub2RlcwoJCQlyZXQgKz0gZ2V0VGV4dCggbm9kZSApOwoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAxIHx8IG5vZGVUeXBlID09PSA5IHx8IG5vZGVUeXBlID09PSAxMSApIHsKCQkvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCgkJLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoc2VlICMxMTE1MykKCQlpZiAoIHR5cGVvZiBlbGVtLnRleHRDb250ZW50ID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGVsZW0udGV4dENvbnRlbnQ7CgkJfSBlbHNlIHsKCQkJLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJcmV0ICs9IGdldFRleHQoIGVsZW0gKTsKCQkJfQoJCX0KCX0gZWxzZSBpZiAoIG5vZGVUeXBlID09PSAzIHx8IG5vZGVUeXBlID09PSA0ICkgewoJCXJldHVybiBlbGVtLm5vZGVWYWx1ZTsKCX0KCS8vIERvIG5vdCBpbmNsdWRlIGNvbW1lbnQgb3IgcHJvY2Vzc2luZyBpbnN0cnVjdGlvbiBub2RlcwoKCXJldHVybiByZXQ7Cn07CgpFeHByID0gU2l6emxlLnNlbGVjdG9ycyA9IHsKCgkvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKCWNhY2hlTGVuZ3RoOiA1MCwKCgljcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKCgltYXRjaDogbWF0Y2hFeHByLAoKCWF0dHJIYW5kbGU6IHt9LAoKCWZpbmQ6IHt9LAoKCXJlbGF0aXZlOiB7CgkJIj4iOiB7IGRpcjogInBhcmVudE5vZGUiLCBmaXJzdDogdHJ1ZSB9LAoJCSIgIjogeyBkaXI6ICJwYXJlbnROb2RlIiB9LAoJCSIrIjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciLCBmaXJzdDogdHJ1ZSB9LAoJCSJ+IjogeyBkaXI6ICJwcmV2aW91c1NpYmxpbmciIH0KCX0sCgoJcHJlRmlsdGVyOiB7CgkJIkFUVFIiOiBmdW5jdGlvbiggbWF0Y2ggKSB7CgkJCW1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKTsKCgkJCS8vIE1vdmUgdGhlIGdpdmVuIHZhbHVlIHRvIG1hdGNoWzNdIHdoZXRoZXIgcXVvdGVkIG9yIHVucXVvdGVkCgkJCW1hdGNoWzNdID0gKCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCAiIiApLnJlcGxhY2UoIHJ1bmVzY2FwZSwgZnVuZXNjYXBlICk7CgoJCQlpZiAoIG1hdGNoWzJdID09PSAifj0iICkgewoJCQkJbWF0Y2hbM10gPSAiICIgKyBtYXRjaFszXSArICIgIjsKCQkJfQoKCQkJcmV0dXJuIG1hdGNoLnNsaWNlKCAwLCA0ICk7CgkJfSwKCgkJIkNISUxEIjogZnVuY3Rpb24oIG1hdGNoICkgewoJCQkvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCgkJCQkxIHR5cGUgKG9ubHl8bnRofC4uLikKCQkJCTIgd2hhdCAoY2hpbGR8b2YtdHlwZSkKCQkJCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCgkJCQk0IHhuLWNvbXBvbmVudCBvZiB4bit5IGFyZ3VtZW50IChbKy1dP1xkKm58KQoJCQkJNSBzaWduIG9mIHhuLWNvbXBvbmVudAoJCQkJNiB4IG9mIHhuLWNvbXBvbmVudAoJCQkJNyBzaWduIG9mIHktY29tcG9uZW50CgkJCQk4IHkgb2YgeS1jb21wb25lbnQKCQkJKi8KCQkJbWF0Y2hbMV0gPSBtYXRjaFsxXS50b0xvd2VyQ2FzZSgpOwoKCQkJaWYgKCBtYXRjaFsxXS5zbGljZSggMCwgMyApID09PSAibnRoIiApIHsKCQkJCS8vIG50aC0qIHJlcXVpcmVzIGFyZ3VtZW50CgkJCQlpZiAoICFtYXRjaFszXSApIHsKCQkJCQlTaXp6bGUuZXJyb3IoIG1hdGNoWzBdICk7CgkJCQl9CgoJCQkJLy8gbnVtZXJpYyB4IGFuZCB5IHBhcmFtZXRlcnMgZm9yIEV4cHIuZmlsdGVyLkNISUxECgkJCQkvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCgkJCQltYXRjaFs0XSA9ICsoIG1hdGNoWzRdID8gbWF0Y2hbNV0gKyAobWF0Y2hbNl0gfHwgMSkgOiAyICogKCBtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIiApICk7CgkJCQltYXRjaFs1XSA9ICsoICggbWF0Y2hbN10gKyBtYXRjaFs4XSApIHx8IG1hdGNoWzNdID09PSAib2RkIiApOwoKCQkJLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCgkJCX0gZWxzZSBpZiAoIG1hdGNoWzNdICkgewoJCQkJU2l6emxlLmVycm9yKCBtYXRjaFswXSApOwoJCQl9CgoJCQlyZXR1cm4gbWF0Y2g7CgkJfSwKCgkJIlBTRVVETyI6IGZ1bmN0aW9uKCBtYXRjaCApIHsKCQkJdmFyIGV4Y2VzcywKCQkJCXVucXVvdGVkID0gIW1hdGNoWzVdICYmIG1hdGNoWzJdOwoKCQkJaWYgKCBtYXRjaEV4cHJbIkNISUxEIl0udGVzdCggbWF0Y2hbMF0gKSApIHsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCQkvLyBBY2NlcHQgcXVvdGVkIGFyZ3VtZW50cyBhcy1pcwoJCQlpZiAoIG1hdGNoWzNdICYmIG1hdGNoWzRdICE9PSB1bmRlZmluZWQgKSB7CgkJCQltYXRjaFsyXSA9IG1hdGNoWzRdOwoKCQkJLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKCQkJfSBlbHNlIGlmICggdW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KCB1bnF1b3RlZCApICYmCgkJCQkvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQoJCQkJKGV4Y2VzcyA9IHRva2VuaXplKCB1bnF1b3RlZCwgdHJ1ZSApKSAmJgoJCQkJLy8gYWR2YW5jZSB0byB0aGUgbmV4dCBjbG9zaW5nIHBhcmVudGhlc2lzCgkJCQkoZXhjZXNzID0gdW5xdW90ZWQuaW5kZXhPZiggIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MgKSAtIHVucXVvdGVkLmxlbmd0aCkgKSB7CgoJCQkJLy8gZXhjZXNzIGlzIGEgbmVnYXRpdmUgaW5kZXgKCQkJCW1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoIDAsIGV4Y2VzcyApOwoJCQkJbWF0Y2hbMl0gPSB1bnF1b3RlZC5zbGljZSggMCwgZXhjZXNzICk7CgkJCX0KCgkJCS8vIFJldHVybiBvbmx5IGNhcHR1cmVzIG5lZWRlZCBieSB0aGUgcHNldWRvIGZpbHRlciBtZXRob2QgKHR5cGUgYW5kIGFyZ3VtZW50KQoJCQlyZXR1cm4gbWF0Y2guc2xpY2UoIDAsIDMgKTsKCQl9Cgl9LAoKCWZpbHRlcjogewoKCQkiVEFHIjogZnVuY3Rpb24oIG5vZGVOYW1lU2VsZWN0b3IgKSB7CgkJCXZhciBub2RlTmFtZSA9IG5vZGVOYW1lU2VsZWN0b3IucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gbm9kZU5hbWVTZWxlY3RvciA9PT0gIioiID8KCQkJCWZ1bmN0aW9uKCkgeyByZXR1cm4gdHJ1ZTsgfSA6CgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lOwoJCQkJfTsKCQl9LAoKCQkiQ0xBU1MiOiBmdW5jdGlvbiggY2xhc3NOYW1lICkgewoJCQl2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbIGNsYXNzTmFtZSArICIgIiBdOwoKCQkJcmV0dXJuIHBhdHRlcm4gfHwKCQkJCShwYXR0ZXJuID0gbmV3IFJlZ0V4cCggIihefCIgKyB3aGl0ZXNwYWNlICsgIikiICsgY2xhc3NOYW1lICsgIigiICsgd2hpdGVzcGFjZSArICJ8JCkiICkpICYmCgkJCQljbGFzc0NhY2hlKCBjbGFzc05hbWUsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCXJldHVybiBwYXR0ZXJuLnRlc3QoIHR5cGVvZiBlbGVtLmNsYXNzTmFtZSA9PT0gInN0cmluZyIgJiYgZWxlbS5jbGFzc05hbWUgfHwgdHlwZW9mIGVsZW0uZ2V0QXR0cmlidXRlICE9PSBzdHJ1bmRlZmluZWQgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIgKTsKCQkJCX0pOwoJCX0sCgoJCSJBVFRSIjogZnVuY3Rpb24oIG5hbWUsIG9wZXJhdG9yLCBjaGVjayApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHJlc3VsdCA9IFNpenpsZS5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkJaWYgKCByZXN1bHQgPT0gbnVsbCApIHsKCQkJCQlyZXR1cm4gb3BlcmF0b3IgPT09ICIhPSI7CgkJCQl9CgkJCQlpZiAoICFvcGVyYXRvciApIHsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX0KCgkJCQlyZXN1bHQgKz0gIiI7CgoJCQkJcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDoKCQkJCQlvcGVyYXRvciA9PT0gIiE9IiA/IHJlc3VsdCAhPT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAiXj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPT09IDAgOgoJCQkJCW9wZXJhdG9yID09PSAiKj0iID8gY2hlY2sgJiYgcmVzdWx0LmluZGV4T2YoIGNoZWNrICkgPiAtMSA6CgkJCQkJb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoIC1jaGVjay5sZW5ndGggKSA9PT0gY2hlY2sgOgoJCQkJCW9wZXJhdG9yID09PSAifj0iID8gKCAiICIgKyByZXN1bHQgKyAiICIgKS5pbmRleE9mKCBjaGVjayApID4gLTEgOgoJCQkJCW9wZXJhdG9yID09PSAifD0iID8gcmVzdWx0ID09PSBjaGVjayB8fCByZXN1bHQuc2xpY2UoIDAsIGNoZWNrLmxlbmd0aCArIDEgKSA9PT0gY2hlY2sgKyAiLSIgOgoJCQkJCWZhbHNlOwoJCQl9OwoJCX0sCgoJCSJDSElMRCI6IGZ1bmN0aW9uKCB0eXBlLCB3aGF0LCBhcmd1bWVudCwgZmlyc3QsIGxhc3QgKSB7CgkJCXZhciBzaW1wbGUgPSB0eXBlLnNsaWNlKCAwLCAzICkgIT09ICJudGgiLAoJCQkJZm9yd2FyZCA9IHR5cGUuc2xpY2UoIC00ICkgIT09ICJsYXN0IiwKCQkJCW9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKCgkJCXJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KCgkJCQkvLyBTaG9ydGN1dCBmb3IgOm50aC0qKG4pCgkJCQlmdW5jdGlvbiggZWxlbSApIHsKCQkJCQlyZXR1cm4gISFlbGVtLnBhcmVudE5vZGU7CgkJCQl9IDoKCgkJCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBjYWNoZSwgb3V0ZXJDYWNoZSwgbm9kZSwgZGlmZiwgbm9kZUluZGV4LCBzdGFydCwKCQkJCQkJZGlyID0gc2ltcGxlICE9PSBmb3J3YXJkID8gIm5leHRTaWJsaW5nIiA6ICJwcmV2aW91c1NpYmxpbmciLAoJCQkJCQlwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGUsCgkJCQkJCW5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCQl1c2VDYWNoZSA9ICF4bWwgJiYgIW9mVHlwZTsKCgkJCQkJaWYgKCBwYXJlbnQgKSB7CgoJCQkJCQkvLyA6KGZpcnN0fGxhc3R8b25seSktKGNoaWxkfG9mLXR5cGUpCgkJCQkJCWlmICggc2ltcGxlICkgewoJCQkJCQkJd2hpbGUgKCBkaXIgKSB7CgkJCQkJCQkJbm9kZSA9IGVsZW07CgkJCQkJCQkJd2hpbGUgKCAobm9kZSA9IG5vZGVbIGRpciBdKSApIHsKCQkJCQkJCQkJaWYgKCBvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJCQl9CgkJCQkJCQkJfQoJCQkJCQkJCS8vIFJldmVyc2UgZGlyZWN0aW9uIGZvciA6b25seS0qIChpZiB3ZSBoYXZlbid0IHlldCBkb25lIHNvKQoJCQkJCQkJCXN0YXJ0ID0gZGlyID0gdHlwZSA9PT0gIm9ubHkiICYmICFzdGFydCAmJiAibmV4dFNpYmxpbmciOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHRydWU7CgkJCQkJCX0KCgkJCQkJCXN0YXJ0ID0gWyBmb3J3YXJkID8gcGFyZW50LmZpcnN0Q2hpbGQgOiBwYXJlbnQubGFzdENoaWxkIF07CgoJCQkJCQkvLyBub24teG1sIDpudGgtY2hpbGQoLi4uKSBzdG9yZXMgY2FjaGUgZGF0YSBvbiBgcGFyZW50YAoJCQkJCQlpZiAoIGZvcndhcmQgJiYgdXNlQ2FjaGUgKSB7CgkJCQkJCQkvLyBTZWVrIGBlbGVtYCBmcm9tIGEgcHJldmlvdXNseS1jYWNoZWQgaW5kZXgKCQkJCQkJCW91dGVyQ2FjaGUgPSBwYXJlbnRbIGV4cGFuZG8gXSB8fCAocGFyZW50WyBleHBhbmRvIF0gPSB7fSk7CgkJCQkJCQljYWNoZSA9IG91dGVyQ2FjaGVbIHR5cGUgXSB8fCBbXTsKCQkJCQkJCW5vZGVJbmRleCA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzFdOwoJCQkJCQkJZGlmZiA9IGNhY2hlWzBdID09PSBkaXJydW5zICYmIGNhY2hlWzJdOwoJCQkJCQkJbm9kZSA9IG5vZGVJbmRleCAmJiBwYXJlbnQuY2hpbGROb2Rlc1sgbm9kZUluZGV4IF07CgoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCgkJCQkJCQkJLy8gRmFsbGJhY2sgdG8gc2Vla2luZyBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJLy8gV2hlbiBmb3VuZCwgY2FjaGUgaW5kZXhlcyBvbiBgcGFyZW50YCBhbmQgYnJlYWsKCQkJCQkJCQlpZiAoIG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCW91dGVyQ2FjaGVbIHR5cGUgXSA9IFsgZGlycnVucywgbm9kZUluZGV4LCBkaWZmIF07CgkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCX0KCQkJCQkJCX0KCgkJCQkJCS8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQoJCQkJCQl9IGVsc2UgaWYgKCB1c2VDYWNoZSAmJiAoY2FjaGUgPSAoZWxlbVsgZXhwYW5kbyBdIHx8IChlbGVtWyBleHBhbmRvIF0gPSB7fSkpWyB0eXBlIF0pICYmIGNhY2hlWzBdID09PSBkaXJydW5zICkgewoJCQkJCQkJZGlmZiA9IGNhY2hlWzFdOwoKCQkJCQkJLy8geG1sIDpudGgtY2hpbGQoLi4uKSBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCgkJCQkJCX0gZWxzZSB7CgkJCQkJCQkvLyBVc2UgdGhlIHNhbWUgbG9vcCBhcyBhYm92ZSB0byBzZWVrIGBlbGVtYCBmcm9tIHRoZSBzdGFydAoJCQkJCQkJd2hpbGUgKCAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVsgZGlyIF0gfHwKCQkJCQkJCQkoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSApIHsKCgkJCQkJCQkJaWYgKCAoIG9mVHlwZSA/IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gbmFtZSA6IG5vZGUubm9kZVR5cGUgPT09IDEgKSAmJiArK2RpZmYgKSB7CgkJCQkJCQkJCS8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKCQkJCQkJCQkJaWYgKCB1c2VDYWNoZSApIHsKCQkJCQkJCQkJCShub2RlWyBleHBhbmRvIF0gfHwgKG5vZGVbIGV4cGFuZG8gXSA9IHt9KSlbIHR5cGUgXSA9IFsgZGlycnVucywgZGlmZiBdOwoJCQkJCQkJCQl9CgoJCQkJCQkJCQlpZiAoIG5vZGUgPT09IGVsZW0gKSB7CgkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJfQoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoKCQkJCQkJLy8gSW5jb3Jwb3JhdGUgdGhlIG9mZnNldCwgdGhlbiBjaGVjayBhZ2FpbnN0IGN5Y2xlIHNpemUKCQkJCQkJZGlmZiAtPSBsYXN0OwoJCQkJCQlyZXR1cm4gZGlmZiA9PT0gZmlyc3QgfHwgKCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDAgKTsKCQkJCQl9CgkJCQl9OwoJCX0sCgoJCSJQU0VVRE8iOiBmdW5jdGlvbiggcHNldWRvLCBhcmd1bWVudCApIHsKCQkJLy8gcHNldWRvLWNsYXNzIG5hbWVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jcHNldWRvLWNsYXNzZXMKCQkJLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKCQkJLy8gUmVtZW1iZXIgdGhhdCBzZXRGaWx0ZXJzIGluaGVyaXRzIGZyb20gcHNldWRvcwoJCQl2YXIgYXJncywKCQkJCWZuID0gRXhwci5wc2V1ZG9zWyBwc2V1ZG8gXSB8fCBFeHByLnNldEZpbHRlcnNbIHBzZXVkby50b0xvd2VyQ2FzZSgpIF0gfHwKCQkJCQlTaXp6bGUuZXJyb3IoICJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8gKTsKCgkJCS8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKCQkJLy8gYXJndW1lbnRzIGFyZSBuZWVkZWQgdG8gY3JlYXRlIHRoZSBmaWx0ZXIgZnVuY3Rpb24KCQkJLy8ganVzdCBhcyBTaXp6bGUgZG9lcwoJCQlpZiAoIGZuWyBleHBhbmRvIF0gKSB7CgkJCQlyZXR1cm4gZm4oIGFyZ3VtZW50ICk7CgkJCX0KCgkJCS8vIEJ1dCBtYWludGFpbiBzdXBwb3J0IGZvciBvbGQgc2lnbmF0dXJlcwoJCQlpZiAoIGZuLmxlbmd0aCA+IDEgKSB7CgkJCQlhcmdzID0gWyBwc2V1ZG8sIHBzZXVkbywgIiIsIGFyZ3VtZW50IF07CgkJCQlyZXR1cm4gRXhwci5zZXRGaWx0ZXJzLmhhc093blByb3BlcnR5KCBwc2V1ZG8udG9Mb3dlckNhc2UoKSApID8KCQkJCQltYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHNlZWQsIG1hdGNoZXMgKSB7CgkJCQkJCXZhciBpZHgsCgkJCQkJCQltYXRjaGVkID0gZm4oIHNlZWQsIGFyZ3VtZW50ICksCgkJCQkJCQlpID0gbWF0Y2hlZC5sZW5ndGg7CgkJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQkJaWR4ID0gaW5kZXhPZi5jYWxsKCBzZWVkLCBtYXRjaGVkW2ldICk7CgkJCQkJCQlzZWVkWyBpZHggXSA9ICEoIG1hdGNoZXNbIGlkeCBdID0gbWF0Y2hlZFtpXSApOwoJCQkJCQl9CgkJCQkJfSkgOgoJCQkJCWZ1bmN0aW9uKCBlbGVtICkgewoJCQkJCQlyZXR1cm4gZm4oIGVsZW0sIDAsIGFyZ3MgKTsKCQkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gZm47CgkJfQoJfSwKCglwc2V1ZG9zOiB7CgkJLy8gUG90ZW50aWFsbHkgY29tcGxleCBwc2V1ZG9zCgkJIm5vdCI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJCS8vIFRyaW0gdGhlIHNlbGVjdG9yIHBhc3NlZCB0byBjb21waWxlCgkJCS8vIHRvIGF2b2lkIHRyZWF0aW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nCgkJCS8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwoJCQl2YXIgaW5wdXQgPSBbXSwKCQkJCXJlc3VsdHMgPSBbXSwKCQkJCW1hdGNoZXIgPSBjb21waWxlKCBzZWxlY3Rvci5yZXBsYWNlKCBydHJpbSwgIiQxIiApICk7CgoJCQlyZXR1cm4gbWF0Y2hlclsgZXhwYW5kbyBdID8KCQkJCW1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgbWF0Y2hlcywgY29udGV4dCwgeG1sICkgewoJCQkJCXZhciBlbGVtLAoJCQkJCQl1bm1hdGNoZWQgPSBtYXRjaGVyKCBzZWVkLCBudWxsLCB4bWwsIFtdICksCgkJCQkJCWkgPSBzZWVkLmxlbmd0aDsKCgkJCQkJLy8gTWF0Y2ggZWxlbWVudHMgdW5tYXRjaGVkIGJ5IGBtYXRjaGVyYAoJCQkJCXdoaWxlICggaS0tICkgewoJCQkJCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJCQkJCXNlZWRbaV0gPSAhKG1hdGNoZXNbaV0gPSBlbGVtKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pIDoKCQkJCWZ1bmN0aW9uKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB7CgkJCQkJaW5wdXRbMF0gPSBlbGVtOwoJCQkJCW1hdGNoZXIoIGlucHV0LCBudWxsLCB4bWwsIHJlc3VsdHMgKTsKCQkJCQlyZXR1cm4gIXJlc3VsdHMucG9wKCk7CgkJCQl9OwoJCX0pLAoKCQkiaGFzIjogbWFya0Z1bmN0aW9uKGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFNpenpsZSggc2VsZWN0b3IsIGVsZW0gKS5sZW5ndGggPiAwOwoJCQl9OwoJCX0pLAoKCQkiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24oIHRleHQgKSB7CgkJCXJldHVybiBmdW5jdGlvbiggZWxlbSApIHsKCQkJCXJldHVybiAoIGVsZW0udGV4dENvbnRlbnQgfHwgZWxlbS5pbm5lclRleHQgfHwgZ2V0VGV4dCggZWxlbSApICkuaW5kZXhPZiggdGV4dCApID4gLTE7CgkJCX07CgkJfSksCgoJCS8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCgkJLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKCQkvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAoJCS8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgoJCS8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgoJCS8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgoJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KCQkibGFuZyI6IG1hcmtGdW5jdGlvbiggZnVuY3Rpb24oIGxhbmcgKSB7CgkJCS8vIGxhbmcgdmFsdWUgbXVzdCBiZSBhIHZhbGlkIGlkZW50aWZpZXIKCQkJaWYgKCAhcmlkZW50aWZpZXIudGVzdChsYW5nIHx8ICIiKSApIHsKCQkJCVNpenpsZS5lcnJvciggInVuc3VwcG9ydGVkIGxhbmc6ICIgKyBsYW5nICk7CgkJCX0KCQkJbGFuZyA9IGxhbmcucmVwbGFjZSggcnVuZXNjYXBlLCBmdW5lc2NhcGUgKS50b0xvd2VyQ2FzZSgpOwoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQl2YXIgZWxlbUxhbmc7CgkJCQlkbyB7CgkJCQkJaWYgKCAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/CgkJCQkJCWVsZW0ubGFuZyA6CgkJCQkJCWVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikpICkgewoKCQkJCQkJZWxlbUxhbmcgPSBlbGVtTGFuZy50b0xvd2VyQ2FzZSgpOwoJCQkJCQlyZXR1cm4gZWxlbUxhbmcgPT09IGxhbmcgfHwgZWxlbUxhbmcuaW5kZXhPZiggbGFuZyArICItIiApID09PSAwOwoJCQkJCX0KCQkJCX0gd2hpbGUgKCAoZWxlbSA9IGVsZW0ucGFyZW50Tm9kZSkgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9OwoJCX0pLAoKCQkvLyBNaXNjZWxsYW5lb3VzCgkJInRhcmdldCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbiAmJiB3aW5kb3cubG9jYXRpb24uaGFzaDsKCQkJcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSggMSApID09PSBlbGVtLmlkOwoJCX0sCgoJCSJyb290IjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtID09PSBkb2NFbGVtOwoJCX0sCgoJCSJmb2N1cyI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAoIWRvY3VtZW50Lmhhc0ZvY3VzIHx8IGRvY3VtZW50Lmhhc0ZvY3VzKCkpICYmICEhKGVsZW0udHlwZSB8fCBlbGVtLmhyZWYgfHwgfmVsZW0udGFiSW5kZXgpOwoJCX0sCgoJCS8vIEJvb2xlYW4gcHJvcGVydGllcwoJCSJlbmFibGVkIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBlbGVtLmRpc2FibGVkID09PSBmYWxzZTsKCQl9LAoKCQkiZGlzYWJsZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0uZGlzYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJImNoZWNrZWQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gSW4gQ1NTMywgOmNoZWNrZWQgc2hvdWxkIHJldHVybiBib3RoIGNoZWNrZWQgYW5kIHNlbGVjdGVkIGVsZW1lbnRzCgkJCS8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCgkJCXZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCQkJcmV0dXJuIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAhIWVsZW0uY2hlY2tlZCkgfHwgKG5vZGVOYW1lID09PSAib3B0aW9uIiAmJiAhIWVsZW0uc2VsZWN0ZWQpOwoJCX0sCgoJCSJzZWxlY3RlZCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CgkJCS8vIG9wdGlvbnMgaW4gU2FmYXJpIHdvcmsgcHJvcGVybHkKCQkJaWYgKCBlbGVtLnBhcmVudE5vZGUgKSB7CgkJCQllbGVtLnBhcmVudE5vZGUuc2VsZWN0ZWRJbmRleDsKCQkJfQoKCQkJcmV0dXJuIGVsZW0uc2VsZWN0ZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gQ29udGVudHMKCQkiZW1wdHkiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNlbXB0eS1wc2V1ZG8KCQkJLy8gOmVtcHR5IGlzIG9ubHkgYWZmZWN0ZWQgYnkgZWxlbWVudCBub2RlcyBhbmQgY29udGVudCBub2RlcyhpbmNsdWRpbmcgdGV4dCgzKSwgY2RhdGEoNCkpLAoJCQkvLyAgIG5vdCBjb21tZW50LCBwcm9jZXNzaW5nIGluc3RydWN0aW9ucywgb3Igb3RoZXJzCgkJCS8vIFRoYW5rcyB0byBEaWVnbyBQZXJpbmkgZm9yIHRoZSBub2RlTmFtZSBzaG9ydGN1dAoJCQkvLyAgIEdyZWF0ZXIgdGhhbiAiQCIgbWVhbnMgYWxwaGEgY2hhcmFjdGVycyAoc3BlY2lmaWNhbGx5IG5vdCBzdGFydGluZyB3aXRoICIjIiBvciAiPyIpCgkJCWZvciAoIGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nICkgewoJCQkJaWYgKCBlbGVtLm5vZGVOYW1lID4gIkAiIHx8IGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJInBhcmVudCI6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQlyZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXSggZWxlbSApOwoJCX0sCgoJCS8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKCQkiaGVhZGVyIjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiByaGVhZGVyLnRlc3QoIGVsZW0ubm9kZU5hbWUgKTsKCQl9LAoKCQkiaW5wdXQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIHJpbnB1dHMudGVzdCggZWxlbS5ub2RlTmFtZSApOwoJCX0sCgoJCSJidXR0b24iOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgkJCXJldHVybiBuYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImJ1dHRvbiIgfHwgbmFtZSA9PT0gImJ1dHRvbiI7CgkJfSwKCgkJInRleHQiOiBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIGF0dHI7CgkJCS8vIElFNiBhbmQgNyB3aWxsIG1hcCBlbGVtLnR5cGUgdG8gJ3RleHQnIGZvciBuZXcgSFRNTDUgdHlwZXMgKHNlYXJjaCwgZXRjKQoJCQkvLyB1c2UgZ2V0QXR0cmlidXRlIGluc3RlYWQgdG8gdGVzdCB0aGlzIGNhc2UKCQkJcmV0dXJuIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJgoJCQkJZWxlbS50eXBlID09PSAidGV4dCIgJiYKCQkJCSggKGF0dHIgPSBlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpKSA9PSBudWxsIHx8IGF0dHIudG9Mb3dlckNhc2UoKSA9PT0gZWxlbS50eXBlICk7CgkJfSwKCgkJLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgoJCSJmaXJzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oKSB7CgkJCXJldHVybiBbIDAgXTsKCQl9KSwKCgkJImxhc3QiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJcmV0dXJuIFsgbGVuZ3RoIC0gMSBdOwoJCX0pLAoKCQkiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXJldHVybiBbIGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgXTsKCQl9KSwKCgkJImV2ZW4iOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCApIHsKCQkJdmFyIGkgPSAwOwoJCQlmb3IgKCA7IGkgPCBsZW5ndGg7IGkgKz0gMiApIHsKCQkJCW1hdGNoSW5kZXhlcy5wdXNoKCBpICk7CgkJCX0KCQkJcmV0dXJuIG1hdGNoSW5kZXhlczsKCQl9KSwKCgkJIm9kZCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoICkgewoJCQl2YXIgaSA9IDE7CgkJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSArPSAyICkgewoJCQkJbWF0Y2hJbmRleGVzLnB1c2goIGkgKTsKCQkJfQoJCQlyZXR1cm4gbWF0Y2hJbmRleGVzOwoJCX0pLAoKCQkibHQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uKCBtYXRjaEluZGV4ZXMsIGxlbmd0aCwgYXJndW1lbnQgKSB7CgkJCXZhciBpID0gYXJndW1lbnQgPCAwID8gYXJndW1lbnQgKyBsZW5ndGggOiBhcmd1bWVudDsKCQkJZm9yICggOyAtLWkgPj0gMDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSksCgoJCSJndCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24oIG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCApIHsKCQkJdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwoJCQlmb3IgKCA7ICsraSA8IGxlbmd0aDsgKSB7CgkJCQltYXRjaEluZGV4ZXMucHVzaCggaSApOwoJCQl9CgkJCXJldHVybiBtYXRjaEluZGV4ZXM7CgkJfSkKCX0KfTsKCkV4cHIucHNldWRvc1sibnRoIl0gPSBFeHByLnBzZXVkb3NbImVxIl07CgovLyBBZGQgYnV0dG9uL2lucHV0IHR5cGUgcHNldWRvcwpmb3IgKCBpIGluIHsgcmFkaW86IHRydWUsIGNoZWNrYm94OiB0cnVlLCBmaWxlOiB0cnVlLCBwYXNzd29yZDogdHJ1ZSwgaW1hZ2U6IHRydWUgfSApIHsKCUV4cHIucHNldWRvc1sgaSBdID0gY3JlYXRlSW5wdXRQc2V1ZG8oIGkgKTsKfQpmb3IgKCBpIGluIHsgc3VibWl0OiB0cnVlLCByZXNldDogdHJ1ZSB9ICkgewoJRXhwci5wc2V1ZG9zWyBpIF0gPSBjcmVhdGVCdXR0b25Qc2V1ZG8oIGkgKTsKfQoKLy8gRWFzeSBBUEkgZm9yIGNyZWF0aW5nIG5ldyBzZXRGaWx0ZXJzCmZ1bmN0aW9uIHNldEZpbHRlcnMoKSB7fQpzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKRXhwci5zZXRGaWx0ZXJzID0gbmV3IHNldEZpbHRlcnMoKTsKCmZ1bmN0aW9uIHRva2VuaXplKCBzZWxlY3RvciwgcGFyc2VPbmx5ICkgewoJdmFyIG1hdGNoZWQsIG1hdGNoLCB0b2tlbnMsIHR5cGUsCgkJc29GYXIsIGdyb3VwcywgcHJlRmlsdGVycywKCQljYWNoZWQgPSB0b2tlbkNhY2hlWyBzZWxlY3RvciArICIgIiBdOwoKCWlmICggY2FjaGVkICkgewoJCXJldHVybiBwYXJzZU9ubHkgPyAwIDogY2FjaGVkLnNsaWNlKCAwICk7Cgl9CgoJc29GYXIgPSBzZWxlY3RvcjsKCWdyb3VwcyA9IFtdOwoJcHJlRmlsdGVycyA9IEV4cHIucHJlRmlsdGVyOwoKCXdoaWxlICggc29GYXIgKSB7CgoJCS8vIENvbW1hIGFuZCBmaXJzdCBydW4KCQlpZiAoICFtYXRjaGVkIHx8IChtYXRjaCA9IHJjb21tYS5leGVjKCBzb0ZhciApKSApIHsKCQkJaWYgKCBtYXRjaCApIHsKCQkJCS8vIERvbid0IGNvbnN1bWUgdHJhaWxpbmcgY29tbWFzIGFzIHZhbGlkCgkJCQlzb0ZhciA9IHNvRmFyLnNsaWNlKCBtYXRjaFswXS5sZW5ndGggKSB8fCBzb0ZhcjsKCQkJfQoJCQlncm91cHMucHVzaCggdG9rZW5zID0gW10gKTsKCQl9CgoJCW1hdGNoZWQgPSBmYWxzZTsKCgkJLy8gQ29tYmluYXRvcnMKCQlpZiAoIChtYXRjaCA9IHJjb21iaW5hdG9ycy5leGVjKCBzb0ZhciApKSApIHsKCQkJbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CgkJCXRva2Vucy5wdXNoKHsKCQkJCXZhbHVlOiBtYXRjaGVkLAoJCQkJLy8gQ2FzdCBkZXNjZW5kYW50IGNvbWJpbmF0b3JzIHRvIHNwYWNlCgkJCQl0eXBlOiBtYXRjaFswXS5yZXBsYWNlKCBydHJpbSwgIiAiICkKCQkJfSk7CgkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJfQoKCQkvLyBGaWx0ZXJzCgkJZm9yICggdHlwZSBpbiBFeHByLmZpbHRlciApIHsKCQkJaWYgKCAobWF0Y2ggPSBtYXRjaEV4cHJbIHR5cGUgXS5leGVjKCBzb0ZhciApKSAmJiAoIXByZUZpbHRlcnNbIHR5cGUgXSB8fAoJCQkJKG1hdGNoID0gcHJlRmlsdGVyc1sgdHlwZSBdKCBtYXRjaCApKSkgKSB7CgkJCQltYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKCQkJCXRva2Vucy5wdXNoKHsKCQkJCQl2YWx1ZTogbWF0Y2hlZCwKCQkJCQl0eXBlOiB0eXBlLAoJCQkJCW1hdGNoZXM6IG1hdGNoCgkJCQl9KTsKCQkJCXNvRmFyID0gc29GYXIuc2xpY2UoIG1hdGNoZWQubGVuZ3RoICk7CgkJCX0KCQl9CgoJCWlmICggIW1hdGNoZWQgKSB7CgkJCWJyZWFrOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIGxlbmd0aCBvZiB0aGUgaW52YWxpZCBleGNlc3MKCS8vIGlmIHdlJ3JlIGp1c3QgcGFyc2luZwoJLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCglyZXR1cm4gcGFyc2VPbmx5ID8KCQlzb0Zhci5sZW5ndGggOgoJCXNvRmFyID8KCQkJU2l6emxlLmVycm9yKCBzZWxlY3RvciApIDoKCQkJLy8gQ2FjaGUgdGhlIHRva2VucwoJCQl0b2tlbkNhY2hlKCBzZWxlY3RvciwgZ3JvdXBzICkuc2xpY2UoIDAgKTsKfQoKZnVuY3Rpb24gdG9TZWxlY3RvciggdG9rZW5zICkgewoJdmFyIGkgPSAwLAoJCWxlbiA9IHRva2Vucy5sZW5ndGgsCgkJc2VsZWN0b3IgPSAiIjsKCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCXNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKCX0KCXJldHVybiBzZWxlY3RvcjsKfQoKZnVuY3Rpb24gYWRkQ29tYmluYXRvciggbWF0Y2hlciwgY29tYmluYXRvciwgYmFzZSApIHsKCXZhciBkaXIgPSBjb21iaW5hdG9yLmRpciwKCQljaGVja05vbkVsZW1lbnRzID0gYmFzZSAmJiBkaXIgPT09ICJwYXJlbnROb2RlIiwKCQlkb25lTmFtZSA9IGRvbmUrKzsKCglyZXR1cm4gY29tYmluYXRvci5maXJzdCA/CgkJLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CgkJZnVuY3Rpb24oIGVsZW0sIGNvbnRleHQsIHhtbCApIHsKCQkJd2hpbGUgKCAoZWxlbSA9IGVsZW1bIGRpciBdKSApIHsKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzICkgewoJCQkJCXJldHVybiBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCQkJfQoJCX0gOgoKCQkvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgZGF0YSwgY2FjaGUsIG91dGVyQ2FjaGUsCgkJCQlkaXJrZXkgPSBkaXJydW5zICsgIiAiICsgZG9uZU5hbWU7CgoJCQkvLyBXZSBjYW4ndCBzZXQgYXJiaXRyYXJ5IGRhdGEgb24gWE1MIG5vZGVzLCBzbyB0aGV5IGRvbid0IGJlbmVmaXQgZnJvbSBkaXIgY2FjaGluZwoJCQlpZiAoIHhtbCApIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCWlmICggbWF0Y2hlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgKSB7CgkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxIHx8IGNoZWNrTm9uRWxlbWVudHMgKSB7CgkJCQkJCW91dGVyQ2FjaGUgPSBlbGVtWyBleHBhbmRvIF0gfHwgKGVsZW1bIGV4cGFuZG8gXSA9IHt9KTsKCQkJCQkJaWYgKCAoY2FjaGUgPSBvdXRlckNhY2hlWyBkaXIgXSkgJiYgY2FjaGVbMF0gPT09IGRpcmtleSApIHsKCQkJCQkJCWlmICggKGRhdGEgPSBjYWNoZVsxXSkgPT09IHRydWUgfHwgZGF0YSA9PT0gY2FjaGVkcnVucyApIHsKCQkJCQkJCQlyZXR1cm4gZGF0YSA9PT0gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWNhY2hlID0gb3V0ZXJDYWNoZVsgZGlyIF0gPSBbIGRpcmtleSBdOwoJCQkJCQkJY2FjaGVbMV0gPSBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSB8fCBjYWNoZWRydW5zOwoJCQkJCQkJaWYgKCBjYWNoZVsxXSA9PT0gdHJ1ZSApIHsKCQkJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX07Cn0KCmZ1bmN0aW9uIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApIHsKCXJldHVybiBtYXRjaGVycy5sZW5ndGggPiAxID8KCQlmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQl2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlpZiAoICFtYXRjaGVyc1tpXSggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gOgoJCW1hdGNoZXJzWzBdOwp9CgpmdW5jdGlvbiBjb25kZW5zZSggdW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sICkgewoJdmFyIGVsZW0sCgkJbmV3VW5tYXRjaGVkID0gW10sCgkJaSA9IDAsCgkJbGVuID0gdW5tYXRjaGVkLmxlbmd0aCwKCQltYXBwZWQgPSBtYXAgIT0gbnVsbDsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChlbGVtID0gdW5tYXRjaGVkW2ldKSApIHsKCQkJaWYgKCAhZmlsdGVyIHx8IGZpbHRlciggZWxlbSwgY29udGV4dCwgeG1sICkgKSB7CgkJCQluZXdVbm1hdGNoZWQucHVzaCggZWxlbSApOwoJCQkJaWYgKCBtYXBwZWQgKSB7CgkJCQkJbWFwLnB1c2goIGkgKTsKCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4gbmV3VW5tYXRjaGVkOwp9CgpmdW5jdGlvbiBzZXRNYXRjaGVyKCBwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IgKSB7CglpZiAoIHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbIGV4cGFuZG8gXSApIHsKCQlwb3N0RmlsdGVyID0gc2V0TWF0Y2hlciggcG9zdEZpbHRlciApOwoJfQoJaWYgKCBwb3N0RmluZGVyICYmICFwb3N0RmluZGVyWyBleHBhbmRvIF0gKSB7CgkJcG9zdEZpbmRlciA9IHNldE1hdGNoZXIoIHBvc3RGaW5kZXIsIHBvc3RTZWxlY3RvciApOwoJfQoJcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiggc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sICkgewoJCXZhciB0ZW1wLCBpLCBlbGVtLAoJCQlwcmVNYXAgPSBbXSwKCQkJcG9zdE1hcCA9IFtdLAoJCQlwcmVleGlzdGluZyA9IHJlc3VsdHMubGVuZ3RoLAoKCQkJLy8gR2V0IGluaXRpYWwgZWxlbWVudHMgZnJvbSBzZWVkIG9yIGNvbnRleHQKCQkJZWxlbXMgPSBzZWVkIHx8IG11bHRpcGxlQ29udGV4dHMoIHNlbGVjdG9yIHx8ICIqIiwgY29udGV4dC5ub2RlVHlwZSA/IFsgY29udGV4dCBdIDogY29udGV4dCwgW10gKSwKCgkJCS8vIFByZWZpbHRlciB0byBnZXQgbWF0Y2hlciBpbnB1dCwgcHJlc2VydmluZyBhIG1hcCBmb3Igc2VlZC1yZXN1bHRzIHN5bmNocm9uaXphdGlvbgoJCQltYXRjaGVySW4gPSBwcmVGaWx0ZXIgJiYgKCBzZWVkIHx8ICFzZWxlY3RvciApID8KCQkJCWNvbmRlbnNlKCBlbGVtcywgcHJlTWFwLCBwcmVGaWx0ZXIsIGNvbnRleHQsIHhtbCApIDoKCQkJCWVsZW1zLAoKCQkJbWF0Y2hlck91dCA9IG1hdGNoZXIgPwoJCQkJLy8gSWYgd2UgaGF2ZSBhIHBvc3RGaW5kZXIsIG9yIGZpbHRlcmVkIHNlZWQsIG9yIG5vbi1zZWVkIHBvc3RGaWx0ZXIgb3IgcHJlZXhpc3RpbmcgcmVzdWx0cywKCQkJCXBvc3RGaW5kZXIgfHwgKCBzZWVkID8gcHJlRmlsdGVyIDogcHJlZXhpc3RpbmcgfHwgcG9zdEZpbHRlciApID8KCgkJCQkJLy8gLi4uaW50ZXJtZWRpYXRlIHByb2Nlc3NpbmcgaXMgbmVjZXNzYXJ5CgkJCQkJW10gOgoKCQkJCQkvLyAuLi5vdGhlcndpc2UgdXNlIHJlc3VsdHMgZGlyZWN0bHkKCQkJCQlyZXN1bHRzIDoKCQkJCW1hdGNoZXJJbjsKCgkJLy8gRmluZCBwcmltYXJ5IG1hdGNoZXMKCQlpZiAoIG1hdGNoZXIgKSB7CgkJCW1hdGNoZXIoIG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sICk7CgkJfQoKCQkvLyBBcHBseSBwb3N0RmlsdGVyCgkJaWYgKCBwb3N0RmlsdGVyICkgewoJCQl0ZW1wID0gY29uZGVuc2UoIG1hdGNoZXJPdXQsIHBvc3RNYXAgKTsKCQkJcG9zdEZpbHRlciggdGVtcCwgW10sIGNvbnRleHQsIHhtbCApOwoKCQkJLy8gVW4tbWF0Y2ggZmFpbGluZyBlbGVtZW50cyBieSBtb3ZpbmcgdGhlbSBiYWNrIHRvIG1hdGNoZXJJbgoJCQlpID0gdGVtcC5sZW5ndGg7CgkJCXdoaWxlICggaS0tICkgewoJCQkJaWYgKCAoZWxlbSA9IHRlbXBbaV0pICkgewoJCQkJCW1hdGNoZXJPdXRbIHBvc3RNYXBbaV0gXSA9ICEobWF0Y2hlckluWyBwb3N0TWFwW2ldIF0gPSBlbGVtKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBzZWVkICkgewoJCQlpZiAoIHBvc3RGaW5kZXIgfHwgcHJlRmlsdGVyICkgewoJCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJCS8vIEdldCB0aGUgZmluYWwgbWF0Y2hlck91dCBieSBjb25kZW5zaW5nIHRoaXMgaW50ZXJtZWRpYXRlIGludG8gcG9zdEZpbmRlciBjb250ZXh0cwoJCQkJCXRlbXAgPSBbXTsKCQkJCQlpID0gbWF0Y2hlck91dC5sZW5ndGg7CgkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCWlmICggKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSApIHsKCQkJCQkJCS8vIFJlc3RvcmUgbWF0Y2hlckluIHNpbmNlIGVsZW0gaXMgbm90IHlldCBhIGZpbmFsIG1hdGNoCgkJCQkJCQl0ZW1wLnB1c2goIChtYXRjaGVySW5baV0gPSBlbGVtKSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXBvc3RGaW5kZXIoIG51bGwsIChtYXRjaGVyT3V0ID0gW10pLCB0ZW1wLCB4bWwgKTsKCQkJCX0KCgkJCQkvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAoJCQkJaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJaWYgKCAoZWxlbSA9IG1hdGNoZXJPdXRbaV0pICYmCgkJCQkJCSh0ZW1wID0gcG9zdEZpbmRlciA/IGluZGV4T2YuY2FsbCggc2VlZCwgZWxlbSApIDogcHJlTWFwW2ldKSA+IC0xICkgewoKCQkJCQkJc2VlZFt0ZW1wXSA9ICEocmVzdWx0c1t0ZW1wXSA9IGVsZW0pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkvLyBBZGQgZWxlbWVudHMgdG8gcmVzdWx0cywgdGhyb3VnaCBwb3N0RmluZGVyIGlmIGRlZmluZWQKCQl9IGVsc2UgewoJCQltYXRjaGVyT3V0ID0gY29uZGVuc2UoCgkJCQltYXRjaGVyT3V0ID09PSByZXN1bHRzID8KCQkJCQltYXRjaGVyT3V0LnNwbGljZSggcHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoICkgOgoJCQkJCW1hdGNoZXJPdXQKCQkJKTsKCQkJaWYgKCBwb3N0RmluZGVyICkgewoJCQkJcG9zdEZpbmRlciggbnVsbCwgcmVzdWx0cywgbWF0Y2hlck91dCwgeG1sICk7CgkJCX0gZWxzZSB7CgkJCQlwdXNoLmFwcGx5KCByZXN1bHRzLCBtYXRjaGVyT3V0ICk7CgkJCX0KCQl9Cgl9KTsKfQoKZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnMoIHRva2VucyApIHsKCXZhciBjaGVja0NvbnRleHQsIG1hdGNoZXIsIGosCgkJbGVuID0gdG9rZW5zLmxlbmd0aCwKCQlsZWFkaW5nUmVsYXRpdmUgPSBFeHByLnJlbGF0aXZlWyB0b2tlbnNbMF0udHlwZSBdLAoJCWltcGxpY2l0UmVsYXRpdmUgPSBsZWFkaW5nUmVsYXRpdmUgfHwgRXhwci5yZWxhdGl2ZVsiICJdLAoJCWkgPSBsZWFkaW5nUmVsYXRpdmUgPyAxIDogMCwKCgkJLy8gVGhlIGZvdW5kYXRpb25hbCBtYXRjaGVyIGVuc3VyZXMgdGhhdCBlbGVtZW50cyBhcmUgcmVhY2hhYmxlIGZyb20gdG9wLWxldmVsIGNvbnRleHQocykKCQltYXRjaENvbnRleHQgPSBhZGRDb21iaW5hdG9yKCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKCQl9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlICksCgkJbWF0Y2hBbnlDb250ZXh0ID0gYWRkQ29tYmluYXRvciggZnVuY3Rpb24oIGVsZW0gKSB7CgkJCXJldHVybiBpbmRleE9mLmNhbGwoIGNoZWNrQ29udGV4dCwgZWxlbSApID4gLTE7CgkJfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSApLAoJCW1hdGNoZXJzID0gWyBmdW5jdGlvbiggZWxlbSwgY29udGV4dCwgeG1sICkgewoJCQlyZXR1cm4gKCAhbGVhZGluZ1JlbGF0aXZlICYmICggeG1sIHx8IGNvbnRleHQgIT09IG91dGVybW9zdENvbnRleHQgKSApIHx8ICgKCQkJCShjaGVja0NvbnRleHQgPSBjb250ZXh0KS5ub2RlVHlwZSA/CgkJCQkJbWF0Y2hDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSA6CgkJCQkJbWF0Y2hBbnlDb250ZXh0KCBlbGVtLCBjb250ZXh0LCB4bWwgKSApOwoJCX0gXTsKCglmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQlpZiAoIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVsgdG9rZW5zW2ldLnR5cGUgXSkgKSB7CgkJCW1hdGNoZXJzID0gWyBhZGRDb21iaW5hdG9yKGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApLCBtYXRjaGVyKSBdOwoJCX0gZWxzZSB7CgkJCW1hdGNoZXIgPSBFeHByLmZpbHRlclsgdG9rZW5zW2ldLnR5cGUgXS5hcHBseSggbnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMgKTsKCgkJCS8vIFJldHVybiBzcGVjaWFsIHVwb24gc2VlaW5nIGEgcG9zaXRpb25hbCBtYXRjaGVyCgkJCWlmICggbWF0Y2hlclsgZXhwYW5kbyBdICkgewoJCQkJLy8gRmluZCB0aGUgbmV4dCByZWxhdGl2ZSBvcGVyYXRvciAoaWYgYW55KSBmb3IgcHJvcGVyIGhhbmRsaW5nCgkJCQlqID0gKytpOwoJCQkJZm9yICggOyBqIDwgbGVuOyBqKysgKSB7CgkJCQkJaWYgKCBFeHByLnJlbGF0aXZlWyB0b2tlbnNbal0udHlwZSBdICkgewoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gc2V0TWF0Y2hlcigKCQkJCQlpID4gMSAmJiBlbGVtZW50TWF0Y2hlciggbWF0Y2hlcnMgKSwKCQkJCQlpID4gMSAmJiB0b1NlbGVjdG9yKAoJCQkJCQkvLyBJZiB0aGUgcHJlY2VkaW5nIHRva2VuIHdhcyBhIGRlc2NlbmRhbnQgY29tYmluYXRvciwgaW5zZXJ0IGFuIGltcGxpY2l0IGFueS1lbGVtZW50IGAqYAoJCQkJCQl0b2tlbnMuc2xpY2UoIDAsIGkgLSAxICkuY29uY2F0KHsgdmFsdWU6IHRva2Vuc1sgaSAtIDIgXS50eXBlID09PSAiICIgPyAiKiIgOiAiIiB9KQoJCQkJCSkucmVwbGFjZSggcnRyaW0sICIkMSIgKSwKCQkJCQltYXRjaGVyLAoJCQkJCWkgPCBqICYmIG1hdGNoZXJGcm9tVG9rZW5zKCB0b2tlbnMuc2xpY2UoIGksIGogKSApLAoJCQkJCWogPCBsZW4gJiYgbWF0Y2hlckZyb21Ub2tlbnMoICh0b2tlbnMgPSB0b2tlbnMuc2xpY2UoIGogKSkgKSwKCQkJCQlqIDwgbGVuICYmIHRvU2VsZWN0b3IoIHRva2VucyApCgkJCQkpOwoJCQl9CgkJCW1hdGNoZXJzLnB1c2goIG1hdGNoZXIgKTsKCQl9Cgl9CgoJcmV0dXJuIGVsZW1lbnRNYXRjaGVyKCBtYXRjaGVycyApOwp9CgpmdW5jdGlvbiBtYXRjaGVyRnJvbUdyb3VwTWF0Y2hlcnMoIGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMgKSB7CgkvLyBBIGNvdW50ZXIgdG8gc3BlY2lmeSB3aGljaCBlbGVtZW50IGlzIGN1cnJlbnRseSBiZWluZyBtYXRjaGVkCgl2YXIgbWF0Y2hlckNhY2hlZFJ1bnMgPSAwLAoJCWJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKCQlzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiggc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBleHBhbmRDb250ZXh0ICkgewoJCQl2YXIgZWxlbSwgaiwgbWF0Y2hlciwKCQkJCXNldE1hdGNoZWQgPSBbXSwKCQkJCW1hdGNoZWRDb3VudCA9IDAsCgkJCQlpID0gIjAiLAoJCQkJdW5tYXRjaGVkID0gc2VlZCAmJiBbXSwKCQkJCW91dGVybW9zdCA9IGV4cGFuZENvbnRleHQgIT0gbnVsbCwKCQkJCWNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAoJCQkJLy8gV2UgbXVzdCBhbHdheXMgaGF2ZSBlaXRoZXIgc2VlZCBlbGVtZW50cyBvciBjb250ZXh0CgkJCQllbGVtcyA9IHNlZWQgfHwgYnlFbGVtZW50ICYmIEV4cHIuZmluZFsiVEFHIl0oICIqIiwgZXhwYW5kQ29udGV4dCAmJiBjb250ZXh0LnBhcmVudE5vZGUgfHwgY29udGV4dCApLAoJCQkJLy8gVXNlIGludGVnZXIgZGlycnVucyBpZmYgdGhpcyBpcyB0aGUgb3V0ZXJtb3N0IG1hdGNoZXIKCQkJCWRpcnJ1bnNVbmlxdWUgPSAoZGlycnVucyArPSBjb250ZXh0QmFja3VwID09IG51bGwgPyAxIDogTWF0aC5yYW5kb20oKSB8fCAwLjEpOwoKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dCAhPT0gZG9jdW1lbnQgJiYgY29udGV4dDsKCQkJCWNhY2hlZHJ1bnMgPSBtYXRjaGVyQ2FjaGVkUnVuczsKCQkJfQoKCQkJLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKCQkJLy8gS2VlcCBgaWAgYSBzdHJpbmcgaWYgdGhlcmUgYXJlIG5vIGVsZW1lbnRzIHNvIGBtYXRjaGVkQ291bnRgIHdpbGwgYmUgIjAwIiBiZWxvdwoJCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJCWlmICggYnlFbGVtZW50ICYmIGVsZW0gKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSApIHsKCQkJCQkJaWYgKCBtYXRjaGVyKCBlbGVtLCBjb250ZXh0LCB4bWwgKSApIHsKCQkJCQkJCXJlc3VsdHMucHVzaCggZWxlbSApOwoJCQkJCQkJYnJlYWs7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQkJCWRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwoJCQkJCQljYWNoZWRydW5zID0gKyttYXRjaGVyQ2FjaGVkUnVuczsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwoJCQkJaWYgKCBieVNldCApIHsKCQkJCQkvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCgkJCQkJaWYgKCAoZWxlbSA9ICFtYXRjaGVyICYmIGVsZW0pICkgewoJCQkJCQltYXRjaGVkQ291bnQtLTsKCQkJCQl9CgoJCQkJCS8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKCQkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJCXVubWF0Y2hlZC5wdXNoKCBlbGVtICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQkvLyBBcHBseSBzZXQgZmlsdGVycyB0byB1bm1hdGNoZWQgZWxlbWVudHMKCQkJbWF0Y2hlZENvdW50ICs9IGk7CgkJCWlmICggYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50ICkgewoJCQkJaiA9IDA7CgkJCQl3aGlsZSAoIChtYXRjaGVyID0gc2V0TWF0Y2hlcnNbaisrXSkgKSB7CgkJCQkJbWF0Y2hlciggdW5tYXRjaGVkLCBzZXRNYXRjaGVkLCBjb250ZXh0LCB4bWwgKTsKCQkJCX0KCgkJCQlpZiAoIHNlZWQgKSB7CgkJCQkJLy8gUmVpbnRlZ3JhdGUgZWxlbWVudCBtYXRjaGVzIHRvIGVsaW1pbmF0ZSB0aGUgbmVlZCBmb3Igc29ydGluZwoJCQkJCWlmICggbWF0Y2hlZENvdW50ID4gMCApIHsKCQkJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJCQlpZiAoICEodW5tYXRjaGVkW2ldIHx8IHNldE1hdGNoZWRbaV0pICkgewoJCQkJCQkJCXNldE1hdGNoZWRbaV0gPSBwb3AuY2FsbCggcmVzdWx0cyApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoKCQkJCQkvLyBEaXNjYXJkIGluZGV4IHBsYWNlaG9sZGVyIHZhbHVlcyB0byBnZXQgb25seSBhY3R1YWwgbWF0Y2hlcwoJCQkJCXNldE1hdGNoZWQgPSBjb25kZW5zZSggc2V0TWF0Y2hlZCApOwoJCQkJfQoKCQkJCS8vIEFkZCBtYXRjaGVzIHRvIHJlc3VsdHMKCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNldE1hdGNoZWQgKTsKCgkJCQkvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKCQkJCWlmICggb3V0ZXJtb3N0ICYmICFzZWVkICYmIHNldE1hdGNoZWQubGVuZ3RoID4gMCAmJgoJCQkJCSggbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoICkgPiAxICkgewoKCQkJCQlTaXp6bGUudW5pcXVlU29ydCggcmVzdWx0cyApOwoJCQkJfQoJCQl9CgoJCQkvLyBPdmVycmlkZSBtYW5pcHVsYXRpb24gb2YgZ2xvYmFscyBieSBuZXN0ZWQgbWF0Y2hlcnMKCQkJaWYgKCBvdXRlcm1vc3QgKSB7CgkJCQlkaXJydW5zID0gZGlycnVuc1VuaXF1ZTsKCQkJCW91dGVybW9zdENvbnRleHQgPSBjb250ZXh0QmFja3VwOwoJCQl9CgoJCQlyZXR1cm4gdW5tYXRjaGVkOwoJCX07CgoJcmV0dXJuIGJ5U2V0ID8KCQltYXJrRnVuY3Rpb24oIHN1cGVyTWF0Y2hlciApIDoKCQlzdXBlck1hdGNoZXI7Cn0KCmNvbXBpbGUgPSBTaXp6bGUuY29tcGlsZSA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgZ3JvdXAgLyogSW50ZXJuYWwgVXNlIE9ubHkgKi8gKSB7Cgl2YXIgaSwKCQlzZXRNYXRjaGVycyA9IFtdLAoJCWVsZW1lbnRNYXRjaGVycyA9IFtdLAoJCWNhY2hlZCA9IGNvbXBpbGVyQ2FjaGVbIHNlbGVjdG9yICsgIiAiIF07CgoJaWYgKCAhY2FjaGVkICkgewoJCS8vIEdlbmVyYXRlIGEgZnVuY3Rpb24gb2YgcmVjdXJzaXZlIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSB1c2VkIHRvIGNoZWNrIGVhY2ggZWxlbWVudAoJCWlmICggIWdyb3VwICkgewoJCQlncm91cCA9IHRva2VuaXplKCBzZWxlY3RvciApOwoJCX0KCQlpID0gZ3JvdXAubGVuZ3RoOwoJCXdoaWxlICggaS0tICkgewoJCQljYWNoZWQgPSBtYXRjaGVyRnJvbVRva2VucyggZ3JvdXBbaV0gKTsKCQkJaWYgKCBjYWNoZWRbIGV4cGFuZG8gXSApIHsKCQkJCXNldE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudE1hdGNoZXJzLnB1c2goIGNhY2hlZCApOwoJCQl9CgkJfQoKCQkvLyBDYWNoZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24KCQljYWNoZWQgPSBjb21waWxlckNhY2hlKCBzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKCBlbGVtZW50TWF0Y2hlcnMsIHNldE1hdGNoZXJzICkgKTsKCX0KCXJldHVybiBjYWNoZWQ7Cn07CgpmdW5jdGlvbiBtdWx0aXBsZUNvbnRleHRzKCBzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMgKSB7Cgl2YXIgaSA9IDAsCgkJbGVuID0gY29udGV4dHMubGVuZ3RoOwoJZm9yICggOyBpIDwgbGVuOyBpKysgKSB7CgkJU2l6emxlKCBzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMgKTsKCX0KCXJldHVybiByZXN1bHRzOwp9CgpmdW5jdGlvbiBzZWxlY3QoIHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkICkgewoJdmFyIGksIHRva2VucywgdG9rZW4sIHR5cGUsIGZpbmQsCgkJbWF0Y2ggPSB0b2tlbml6ZSggc2VsZWN0b3IgKTsKCglpZiAoICFzZWVkICkgewoJCS8vIFRyeSB0byBtaW5pbWl6ZSBvcGVyYXRpb25zIGlmIHRoZXJlIGlzIG9ubHkgb25lIGdyb3VwCgkJaWYgKCBtYXRjaC5sZW5ndGggPT09IDEgKSB7CgoJCQkvLyBUYWtlIGEgc2hvcnRjdXQgYW5kIHNldCB0aGUgY29udGV4dCBpZiB0aGUgcm9vdCBzZWxlY3RvciBpcyBhbiBJRAoJCQl0b2tlbnMgPSBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKCAwICk7CgkJCWlmICggdG9rZW5zLmxlbmd0aCA+IDIgJiYgKHRva2VuID0gdG9rZW5zWzBdKS50eXBlID09PSAiSUQiICYmCgkJCQkJc3VwcG9ydC5nZXRCeUlkICYmIGNvbnRleHQubm9kZVR5cGUgPT09IDkgJiYgZG9jdW1lbnRJc0hUTUwgJiYKCQkJCQlFeHByLnJlbGF0aXZlWyB0b2tlbnNbMV0udHlwZSBdICkgewoKCQkJCWNvbnRleHQgPSAoIEV4cHIuZmluZFsiSUQiXSggdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKSwgY29udGV4dCApIHx8IFtdIClbMF07CgkJCQlpZiAoICFjb250ZXh0ICkgewoJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJfQoJCQkJc2VsZWN0b3IgPSBzZWxlY3Rvci5zbGljZSggdG9rZW5zLnNoaWZ0KCkudmFsdWUubGVuZ3RoICk7CgkJCX0KCgkJCS8vIEZldGNoIGEgc2VlZCBzZXQgZm9yIHJpZ2h0LXRvLWxlZnQgbWF0Y2hpbmcKCQkJaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdCggc2VsZWN0b3IgKSA/IDAgOiB0b2tlbnMubGVuZ3RoOwoJCQl3aGlsZSAoIGktLSApIHsKCQkJCXRva2VuID0gdG9rZW5zW2ldOwoKCQkJCS8vIEFib3J0IGlmIHdlIGhpdCBhIGNvbWJpbmF0b3IKCQkJCWlmICggRXhwci5yZWxhdGl2ZVsgKHR5cGUgPSB0b2tlbi50eXBlKSBdICkgewoJCQkJCWJyZWFrOwoJCQkJfQoJCQkJaWYgKCAoZmluZCA9IEV4cHIuZmluZFsgdHlwZSBdKSApIHsKCQkJCQkvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKCQkJCQlpZiAoIChzZWVkID0gZmluZCgKCQkJCQkJdG9rZW4ubWF0Y2hlc1swXS5yZXBsYWNlKCBydW5lc2NhcGUsIGZ1bmVzY2FwZSApLAoJCQkJCQlyc2libGluZy50ZXN0KCB0b2tlbnNbMF0udHlwZSApICYmIGNvbnRleHQucGFyZW50Tm9kZSB8fCBjb250ZXh0CgkJCQkJKSkgKSB7CgoJCQkJCQkvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKCQkJCQkJdG9rZW5zLnNwbGljZSggaSwgMSApOwoJCQkJCQlzZWxlY3RvciA9IHNlZWQubGVuZ3RoICYmIHRvU2VsZWN0b3IoIHRva2VucyApOwoJCQkJCQlpZiAoICFzZWxlY3RvciApIHsKCQkJCQkJCXB1c2guYXBwbHkoIHJlc3VsdHMsIHNlZWQgKTsKCQkJCQkJCXJldHVybiByZXN1bHRzOwoJCQkJCQl9CgoJCQkJCQlicmVhazsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gQ29tcGlsZSBhbmQgZXhlY3V0ZSBhIGZpbHRlcmluZyBmdW5jdGlvbgoJLy8gUHJvdmlkZSBgbWF0Y2hgIHRvIGF2b2lkIHJldG9rZW5pemF0aW9uIGlmIHdlIG1vZGlmaWVkIHRoZSBzZWxlY3RvciBhYm92ZQoJY29tcGlsZSggc2VsZWN0b3IsIG1hdGNoICkoCgkJc2VlZCwKCQljb250ZXh0LAoJCSFkb2N1bWVudElzSFRNTCwKCQlyZXN1bHRzLAoJCXJzaWJsaW5nLnRlc3QoIHNlbGVjdG9yICkKCSk7CglyZXR1cm4gcmVzdWx0czsKfQoKLy8gT25lLXRpbWUgYXNzaWdubWVudHMKCi8vIFNvcnQgc3RhYmlsaXR5CnN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoIiIpLnNvcnQoIHNvcnRPcmRlciApLmpvaW4oIiIpID09PSBleHBhbmRvOwoKLy8gU3VwcG9ydDogQ2hyb21lPDE0Ci8vIEFsd2F5cyBhc3N1bWUgZHVwbGljYXRlcyBpZiB0aGV5IGFyZW4ndCBwYXNzZWQgdG8gdGhlIGNvbXBhcmlzb24gZnVuY3Rpb24Kc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzID0gaGFzRHVwbGljYXRlOwoKLy8gSW5pdGlhbGl6ZSBhZ2FpbnN0IHRoZSBkZWZhdWx0IGRvY3VtZW50CnNldERvY3VtZW50KCk7CgovLyBTdXBwb3J0OiBXZWJraXQ8NTM3LjMyIC0gU2FmYXJpIDYuMC4zL0Nocm9tZSAyNSAoZml4ZWQgaW4gQ2hyb21lIDI3KQovLyBEZXRhY2hlZCBub2RlcyBjb25mb3VuZGluZ2x5IGZvbGxvdyAqZWFjaCBvdGhlcioKc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24oIGRpdjEgKSB7CgkvLyBTaG91bGQgcmV0dXJuIDEsIGJ1dCByZXR1cm5zIDQgKGZvbGxvd2luZykKCXJldHVybiBkaXYxLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKSApICYgMTsKfSk7CgovLyBTdXBwb3J0OiBJRTw4Ci8vIFByZXZlbnQgYXR0cmlidXRlL3Byb3BlcnR5ICJpbnRlcnBvbGF0aW9uIgovLyBodHRwOi8vbXNkbi5taWNyb3NvZnQuY29tL2VuLXVzL2xpYnJhcnkvbXM1MzY0MjklMjhWUy44NSUyOS5hc3B4CmlmICggIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKCXJldHVybiBkaXYuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoImhyZWYiKSA9PT0gIiMiIDsKfSkgKSB7CglhZGRIYW5kbGUoICJ0eXBlfGhyZWZ8aGVpZ2h0fHdpZHRoIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUsIG5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInR5cGUiID8gMSA6IDIgKTsKCQl9Cgl9KTsKfQoKLy8gU3VwcG9ydDogSUU8OQovLyBVc2UgZGVmYXVsdFZhbHVlIGluIHBsYWNlIG9mIGdldEF0dHJpYnV0ZSgidmFsdWUiKQppZiAoICFzdXBwb3J0LmF0dHJpYnV0ZXMgfHwgIWFzc2VydChmdW5jdGlvbiggZGl2ICkgewoJZGl2LmlubmVySFRNTCA9ICI8aW5wdXQvPiI7CglkaXYuZmlyc3RDaGlsZC5zZXRBdHRyaWJ1dGUoICJ2YWx1ZSIsICIiICk7CglyZXR1cm4gZGl2LmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgPT09ICIiOwp9KSApIHsKCWFkZEhhbmRsZSggInZhbHVlIiwgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGlzWE1MICkgewoJCWlmICggIWlzWE1MICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiApIHsKCQkJcmV0dXJuIGVsZW0uZGVmYXVsdFZhbHVlOwoJCX0KCX0pOwp9CgovLyBTdXBwb3J0OiBJRTw5Ci8vIFVzZSBnZXRBdHRyaWJ1dGVOb2RlIHRvIGZldGNoIGJvb2xlYW5zIHdoZW4gZ2V0QXR0cmlidXRlIGxpZXMKaWYgKCAhYXNzZXJ0KGZ1bmN0aW9uKCBkaXYgKSB7CglyZXR1cm4gZGl2LmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOwp9KSApIHsKCWFkZEhhbmRsZSggYm9vbGVhbnMsIGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBpc1hNTCApIHsKCQl2YXIgdmFsOwoJCWlmICggIWlzWE1MICkgewoJCQlyZXR1cm4gKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSggbmFtZSApKSAmJiB2YWwuc3BlY2lmaWVkID8KCQkJCXZhbC52YWx1ZSA6CgkJCQllbGVtWyBuYW1lIF0gPT09IHRydWUgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiBudWxsOwoJCX0KCX0pOwp9CgpqUXVlcnkuZmluZCA9IFNpenpsZTsKalF1ZXJ5LmV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzOwpqUXVlcnkuZXhwclsiOiJdID0galF1ZXJ5LmV4cHIucHNldWRvczsKalF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwpqUXVlcnkudGV4dCA9IFNpenpsZS5nZXRUZXh0OwpqUXVlcnkuaXNYTUxEb2MgPSBTaXp6bGUuaXNYTUw7CmpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKCgp9KSggd2luZG93ICk7Ci8vIFN0cmluZyB0byBPYmplY3Qgb3B0aW9ucyBmb3JtYXQgY2FjaGUKdmFyIG9wdGlvbnNDYWNoZSA9IHt9OwoKLy8gQ29udmVydCBTdHJpbmctZm9ybWF0dGVkIG9wdGlvbnMgaW50byBPYmplY3QtZm9ybWF0dGVkIG9uZXMgYW5kIHN0b3JlIGluIGNhY2hlCmZ1bmN0aW9uIGNyZWF0ZU9wdGlvbnMoIG9wdGlvbnMgKSB7Cgl2YXIgb2JqZWN0ID0gb3B0aW9uc0NhY2hlWyBvcHRpb25zIF0gPSB7fTsKCWpRdWVyeS5lYWNoKCBvcHRpb25zLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdLCBmdW5jdGlvbiggXywgZmxhZyApIHsKCQlvYmplY3RbIGZsYWcgXSA9IHRydWU7Cgl9KTsKCXJldHVybiBvYmplY3Q7Cn0KCi8qCiAqIENyZWF0ZSBhIGNhbGxiYWNrIGxpc3QgdXNpbmcgdGhlIGZvbGxvd2luZyBwYXJhbWV0ZXJzOgogKgogKglvcHRpb25zOiBhbiBvcHRpb25hbCBsaXN0IG9mIHNwYWNlLXNlcGFyYXRlZCBvcHRpb25zIHRoYXQgd2lsbCBjaGFuZ2UgaG93CiAqCQkJdGhlIGNhbGxiYWNrIGxpc3QgYmVoYXZlcyBvciBhIG1vcmUgdHJhZGl0aW9uYWwgb3B0aW9uIG9iamVjdAogKgogKiBCeSBkZWZhdWx0IGEgY2FsbGJhY2sgbGlzdCB3aWxsIGFjdCBsaWtlIGFuIGV2ZW50IGNhbGxiYWNrIGxpc3QgYW5kIGNhbiBiZQogKiAiZmlyZWQiIG11bHRpcGxlIHRpbWVzLgogKgogKiBQb3NzaWJsZSBvcHRpb25zOgogKgogKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJbWVtb3J5OgkJCXdpbGwga2VlcCB0cmFjayBvZiBwcmV2aW91cyB2YWx1ZXMgYW5kIHdpbGwgY2FsbCBhbnkgY2FsbGJhY2sgYWRkZWQKICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAqCQkJCQl2YWx1ZXMgKGxpa2UgYSBEZWZlcnJlZCkKICoKICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogKgogKglzdG9wT25GYWxzZToJaW50ZXJydXB0IGNhbGxpbmdzIHdoZW4gYSBjYWxsYmFjayByZXR1cm5zIGZhbHNlCiAqCiAqLwpqUXVlcnkuQ2FsbGJhY2tzID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgoJLy8gQ29udmVydCBvcHRpb25zIGZyb20gU3RyaW5nLWZvcm1hdHRlZCB0byBPYmplY3QtZm9ybWF0dGVkIGlmIG5lZWRlZAoJLy8gKHdlIGNoZWNrIGluIGNhY2hlIGZpcnN0KQoJb3B0aW9ucyA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiA/CgkJKCBvcHRpb25zQ2FjaGVbIG9wdGlvbnMgXSB8fCBjcmVhdGVPcHRpb25zKCBvcHRpb25zICkgKSA6CgkJalF1ZXJ5LmV4dGVuZCgge30sIG9wdGlvbnMgKTsKCgl2YXIgLy8gTGFzdCBmaXJlIHZhbHVlIChmb3Igbm9uLWZvcmdldHRhYmxlIGxpc3RzKQoJCW1lbW9yeSwKCQkvLyBGbGFnIHRvIGtub3cgaWYgbGlzdCB3YXMgYWxyZWFkeSBmaXJlZAoJCWZpcmVkLAoJCS8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKCQlmaXJpbmcsCgkJLy8gRmlyc3QgY2FsbGJhY2sgdG8gZmlyZSAodXNlZCBpbnRlcm5hbGx5IGJ5IGFkZCBhbmQgZmlyZVdpdGgpCgkJZmlyaW5nU3RhcnQsCgkJLy8gRW5kIG9mIHRoZSBsb29wIHdoZW4gZmlyaW5nCgkJZmlyaW5nTGVuZ3RoLAoJCS8vIEluZGV4IG9mIGN1cnJlbnRseSBmaXJpbmcgY2FsbGJhY2sgKG1vZGlmaWVkIGJ5IHJlbW92ZSBpZiBuZWVkZWQpCgkJZmlyaW5nSW5kZXgsCgkJLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKCQlsaXN0ID0gW10sCgkJLy8gU3RhY2sgb2YgZmlyZSBjYWxscyBmb3IgcmVwZWF0YWJsZSBsaXN0cwoJCXN0YWNrID0gIW9wdGlvbnMub25jZSAmJiBbXSwKCQkvLyBGaXJlIGNhbGxiYWNrcwoJCWZpcmUgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJbWVtb3J5ID0gb3B0aW9ucy5tZW1vcnkgJiYgZGF0YTsKCQkJZmlyZWQgPSB0cnVlOwoJCQlmaXJpbmdJbmRleCA9IGZpcmluZ1N0YXJ0IHx8IDA7CgkJCWZpcmluZ1N0YXJ0ID0gMDsKCQkJZmlyaW5nTGVuZ3RoID0gbGlzdC5sZW5ndGg7CgkJCWZpcmluZyA9IHRydWU7CgkJCWZvciAoIDsgbGlzdCAmJiBmaXJpbmdJbmRleCA8IGZpcmluZ0xlbmd0aDsgZmlyaW5nSW5kZXgrKyApIHsKCQkJCWlmICggbGlzdFsgZmlyaW5nSW5kZXggXS5hcHBseSggZGF0YVsgMCBdLCBkYXRhWyAxIF0gKSA9PT0gZmFsc2UgJiYgb3B0aW9ucy5zdG9wT25GYWxzZSApIHsKCQkJCQltZW1vcnkgPSBmYWxzZTsgLy8gVG8gcHJldmVudCBmdXJ0aGVyIGNhbGxzIHVzaW5nIGFkZAoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJCWZpcmluZyA9IGZhbHNlOwoJCQlpZiAoIGxpc3QgKSB7CgkJCQlpZiAoIHN0YWNrICkgewoJCQkJCWlmICggc3RhY2subGVuZ3RoICkgewoJCQkJCQlmaXJlKCBzdGFjay5zaGlmdCgpICk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCWxpc3QgPSBbXTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCX0KCQl9LAoJCS8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CgkJc2VsZiA9IHsKCQkJLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAoJCQlhZGQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCS8vIEZpcnN0LCB3ZSBzYXZlIHRoZSBjdXJyZW50IGxlbmd0aAoJCQkJCXZhciBzdGFydCA9IGxpc3QubGVuZ3RoOwoJCQkJCShmdW5jdGlvbiBhZGQoIGFyZ3MgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCBhcmdzLCBmdW5jdGlvbiggXywgYXJnICkgewoJCQkJCQkJdmFyIHR5cGUgPSBqUXVlcnkudHlwZSggYXJnICk7CgkJCQkJCQlpZiAoIHR5cGUgPT09ICJmdW5jdGlvbiIgKSB7CgkJCQkJCQkJaWYgKCAhb3B0aW9ucy51bmlxdWUgfHwgIXNlbGYuaGFzKCBhcmcgKSApIHsKCQkJCQkJCQkJbGlzdC5wdXNoKCBhcmcgKTsKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYgKCBhcmcgJiYgYXJnLmxlbmd0aCAmJiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJCQkJCQkvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CgkJCQkJCQkJYWRkKCBhcmcgKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfSkoIGFyZ3VtZW50cyApOwoJCQkJCS8vIERvIHdlIG5lZWQgdG8gYWRkIHRoZSBjYWxsYmFja3MgdG8gdGhlCgkJCQkJLy8gY3VycmVudCBmaXJpbmcgYmF0Y2g/CgkJCQkJaWYgKCBmaXJpbmcgKSB7CgkJCQkJCWZpcmluZ0xlbmd0aCA9IGxpc3QubGVuZ3RoOwoJCQkJCS8vIFdpdGggbWVtb3J5LCBpZiB3ZSdyZSBub3QgZmlyaW5nIHRoZW4KCQkJCQkvLyB3ZSBzaG91bGQgY2FsbCByaWdodCBhd2F5CgkJCQkJfSBlbHNlIGlmICggbWVtb3J5ICkgewoJCQkJCQlmaXJpbmdTdGFydCA9IHN0YXJ0OwoJCQkJCQlmaXJlKCBtZW1vcnkgKTsKCQkJCQl9CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAoJCQlyZW1vdmU6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBsaXN0ICkgewoJCQkJCWpRdWVyeS5lYWNoKCBhcmd1bWVudHMsIGZ1bmN0aW9uKCBfLCBhcmcgKSB7CgkJCQkJCXZhciBpbmRleDsKCQkJCQkJd2hpbGUoICggaW5kZXggPSBqUXVlcnkuaW5BcnJheSggYXJnLCBsaXN0LCBpbmRleCApICkgPiAtMSApIHsKCQkJCQkJCWxpc3Quc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJCQkJLy8gSGFuZGxlIGZpcmluZyBpbmRleGVzCgkJCQkJCQlpZiAoIGZpcmluZyApIHsKCQkJCQkJCQlpZiAoIGluZGV4IDw9IGZpcmluZ0xlbmd0aCApIHsKCQkJCQkJCQkJZmlyaW5nTGVuZ3RoLS07CgkJCQkJCQkJfQoJCQkJCQkJCWlmICggaW5kZXggPD0gZmlyaW5nSW5kZXggKSB7CgkJCQkJCQkJCWZpcmluZ0luZGV4LS07CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KCQkJLy8gSWYgbm8gYXJndW1lbnQgaXMgZ2l2ZW4sIHJldHVybiB3aGV0aGVyIG9yIG5vdCBsaXN0IGhhcyBjYWxsYmFja3MgYXR0YWNoZWQuCgkJCWhhczogZnVuY3Rpb24oIGZuICkgewoJCQkJcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoIGZuLCBsaXN0ICkgPiAtMSA6ICEhKCBsaXN0ICYmIGxpc3QubGVuZ3RoICk7CgkJCX0sCgkJCS8vIFJlbW92ZSBhbGwgY2FsbGJhY2tzIGZyb20gdGhlIGxpc3QKCQkJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCQkJbGlzdCA9IFtdOwoJCQkJZmlyaW5nTGVuZ3RoID0gMDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBIYXZlIHRoZSBsaXN0IGRvIG5vdGhpbmcgYW55bW9yZQoJCQlkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQkJCWxpc3QgPSBzdGFjayA9IG1lbW9yeSA9IHVuZGVmaW5lZDsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBJcyBpdCBkaXNhYmxlZD8KCQkJZGlzYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFsaXN0OwoJCQl9LAoJCQkvLyBMb2NrIHRoZSBsaXN0IGluIGl0cyBjdXJyZW50IHN0YXRlCgkJCWxvY2s6IGZ1bmN0aW9uKCkgewoJCQkJc3RhY2sgPSB1bmRlZmluZWQ7CgkJCQlpZiAoICFtZW1vcnkgKSB7CgkJCQkJc2VsZi5kaXNhYmxlKCk7CgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJLy8gSXMgaXQgbG9ja2VkPwoJCQlsb2NrZWQ6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICFzdGFjazsKCQkJfSwKCQkJLy8gQ2FsbCBhbGwgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGNvbnRleHQgYW5kIGFyZ3VtZW50cwoJCQlmaXJlV2l0aDogZnVuY3Rpb24oIGNvbnRleHQsIGFyZ3MgKSB7CgkJCQlpZiAoIGxpc3QgJiYgKCAhZmlyZWQgfHwgc3RhY2sgKSApIHsKCQkJCQlhcmdzID0gYXJncyB8fCBbXTsKCQkJCQlhcmdzID0gWyBjb250ZXh0LCBhcmdzLnNsaWNlID8gYXJncy5zbGljZSgpIDogYXJncyBdOwoJCQkJCWlmICggZmlyaW5nICkgewoJCQkJCQlzdGFjay5wdXNoKCBhcmdzICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJZmlyZSggYXJncyApOwoJCQkJCX0KCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQkvLyBDYWxsIGFsbCB0aGUgY2FsbGJhY2tzIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cwoJCQlmaXJlOiBmdW5jdGlvbigpIHsKCQkJCXNlbGYuZmlyZVdpdGgoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCS8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQoJCQlmaXJlZDogZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gISFmaXJlZDsKCQkJfQoJCX07CgoJcmV0dXJuIHNlbGY7Cn07CmpRdWVyeS5leHRlbmQoewoKCURlZmVycmVkOiBmdW5jdGlvbiggZnVuYyApIHsKCQl2YXIgdHVwbGVzID0gWwoJCQkJLy8gYWN0aW9uLCBhZGQgbGlzdGVuZXIsIGxpc3RlbmVyIGxpc3QsIGZpbmFsIHN0YXRlCgkJCQlbICJyZXNvbHZlIiwgImRvbmUiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAicmVzb2x2ZWQiIF0sCgkJCQlbICJyZWplY3QiLCAiZmFpbCIsIGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksICJyZWplY3RlZCIgXSwKCQkJCVsgIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpIF0KCQkJXSwKCQkJc3RhdGUgPSAicGVuZGluZyIsCgkJCXByb21pc2UgPSB7CgkJCQlzdGF0ZTogZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuIHN0YXRlOwoJCQkJfSwKCQkJCWFsd2F5czogZnVuY3Rpb24oKSB7CgkJCQkJZGVmZXJyZWQuZG9uZSggYXJndW1lbnRzICkuZmFpbCggYXJndW1lbnRzICk7CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoJCQkJdGhlbjogZnVuY3Rpb24oIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovICkgewoJCQkJCXZhciBmbnMgPSBhcmd1bWVudHM7CgkJCQkJcmV0dXJuIGpRdWVyeS5EZWZlcnJlZChmdW5jdGlvbiggbmV3RGVmZXIgKSB7CgkJCQkJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJCQkJCXZhciBhY3Rpb24gPSB0dXBsZVsgMCBdLAoJCQkJCQkJCWZuID0galF1ZXJ5LmlzRnVuY3Rpb24oIGZuc1sgaSBdICkgJiYgZm5zWyBpIF07CgkJCQkJCQkvLyBkZWZlcnJlZFsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdIGZvciBmb3J3YXJkaW5nIGFjdGlvbnMgdG8gbmV3RGVmZXIKCQkJCQkJCWRlZmVycmVkWyB0dXBsZVsxXSBdKGZ1bmN0aW9uKCkgewoJCQkJCQkJCXZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQkJCQlpZiAoIHJldHVybmVkICYmIGpRdWVyeS5pc0Z1bmN0aW9uKCByZXR1cm5lZC5wcm9taXNlICkgKSB7CgkJCQkJCQkJCXJldHVybmVkLnByb21pc2UoKQoJCQkJCQkJCQkJLmRvbmUoIG5ld0RlZmVyLnJlc29sdmUgKQoJCQkJCQkJCQkJLmZhaWwoIG5ld0RlZmVyLnJlamVjdCApCgkJCQkJCQkJCQkucHJvZ3Jlc3MoIG5ld0RlZmVyLm5vdGlmeSApOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCW5ld0RlZmVyWyBhY3Rpb24gKyAiV2l0aCIgXSggdGhpcyA9PT0gcHJvbWlzZSA/IG5ld0RlZmVyLnByb21pc2UoKSA6IHRoaXMsIGZuID8gWyByZXR1cm5lZCBdIDogYXJndW1lbnRzICk7CgkJCQkJCQkJfQoJCQkJCQkJfSk7CgkJCQkJCX0pOwoJCQkJCQlmbnMgPSBudWxsOwoJCQkJCX0pLnByb21pc2UoKTsKCQkJCX0sCgkJCQkvLyBHZXQgYSBwcm9taXNlIGZvciB0aGlzIGRlZmVycmVkCgkJCQkvLyBJZiBvYmogaXMgcHJvdmlkZWQsIHRoZSBwcm9taXNlIGFzcGVjdCBpcyBhZGRlZCB0byB0aGUgb2JqZWN0CgkJCQlwcm9taXNlOiBmdW5jdGlvbiggb2JqICkgewoJCQkJCXJldHVybiBvYmogIT0gbnVsbCA/IGpRdWVyeS5leHRlbmQoIG9iaiwgcHJvbWlzZSApIDogcHJvbWlzZTsKCQkJCX0KCQkJfSwKCQkJZGVmZXJyZWQgPSB7fTsKCgkJLy8gS2VlcCBwaXBlIGZvciBiYWNrLWNvbXBhdAoJCXByb21pc2UucGlwZSA9IHByb21pc2UudGhlbjsKCgkJLy8gQWRkIGxpc3Qtc3BlY2lmaWMgbWV0aG9kcwoJCWpRdWVyeS5lYWNoKCB0dXBsZXMsIGZ1bmN0aW9uKCBpLCB0dXBsZSApIHsKCQkJdmFyIGxpc3QgPSB0dXBsZVsgMiBdLAoJCQkJc3RhdGVTdHJpbmcgPSB0dXBsZVsgMyBdOwoKCQkJLy8gcHJvbWlzZVsgZG9uZSB8IGZhaWwgfCBwcm9ncmVzcyBdID0gbGlzdC5hZGQKCQkJcHJvbWlzZVsgdHVwbGVbMV0gXSA9IGxpc3QuYWRkOwoKCQkJLy8gSGFuZGxlIHN0YXRlCgkJCWlmICggc3RhdGVTdHJpbmcgKSB7CgkJCQlsaXN0LmFkZChmdW5jdGlvbigpIHsKCQkJCQkvLyBzdGF0ZSA9IFsgcmVzb2x2ZWQgfCByZWplY3RlZCBdCgkJCQkJc3RhdGUgPSBzdGF0ZVN0cmluZzsKCgkJCQkvLyBbIHJlamVjdF9saXN0IHwgcmVzb2x2ZV9saXN0IF0uZGlzYWJsZTsgcHJvZ3Jlc3NfbGlzdC5sb2NrCgkJCQl9LCB0dXBsZXNbIGkgXiAxIF1bIDIgXS5kaXNhYmxlLCB0dXBsZXNbIDIgXVsgMiBdLmxvY2sgKTsKCQkJfQoKCQkJLy8gZGVmZXJyZWRbIHJlc29sdmUgfCByZWplY3QgfCBub3RpZnkgXQoJCQlkZWZlcnJlZFsgdHVwbGVbMF0gXSA9IGZ1bmN0aW9uKCkgewoJCQkJZGVmZXJyZWRbIHR1cGxlWzBdICsgIldpdGgiIF0oIHRoaXMgPT09IGRlZmVycmVkID8gcHJvbWlzZSA6IHRoaXMsIGFyZ3VtZW50cyApOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX07CgkJCWRlZmVycmVkWyB0dXBsZVswXSArICJXaXRoIiBdID0gbGlzdC5maXJlV2l0aDsKCQl9KTsKCgkJLy8gTWFrZSB0aGUgZGVmZXJyZWQgYSBwcm9taXNlCgkJcHJvbWlzZS5wcm9taXNlKCBkZWZlcnJlZCApOwoKCQkvLyBDYWxsIGdpdmVuIGZ1bmMgaWYgYW55CgkJaWYgKCBmdW5jICkgewoJCQlmdW5jLmNhbGwoIGRlZmVycmVkLCBkZWZlcnJlZCApOwoJCX0KCgkJLy8gQWxsIGRvbmUhCgkJcmV0dXJuIGRlZmVycmVkOwoJfSwKCgkvLyBEZWZlcnJlZCBoZWxwZXIKCXdoZW46IGZ1bmN0aW9uKCBzdWJvcmRpbmF0ZSAvKiAsIC4uLiwgc3Vib3JkaW5hdGVOICovICkgewoJCXZhciBpID0gMCwKCQkJcmVzb2x2ZVZhbHVlcyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWxlbmd0aCA9IHJlc29sdmVWYWx1ZXMubGVuZ3RoLAoKCQkJLy8gdGhlIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwoJCQlyZW1haW5pbmcgPSBsZW5ndGggIT09IDEgfHwgKCBzdWJvcmRpbmF0ZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggc3Vib3JkaW5hdGUucHJvbWlzZSApICkgPyBsZW5ndGggOiAwLAoKCQkJLy8gdGhlIG1hc3RlciBEZWZlcnJlZC4gSWYgcmVzb2x2ZVZhbHVlcyBjb25zaXN0IG9mIG9ubHkgYSBzaW5nbGUgRGVmZXJyZWQsIGp1c3QgdXNlIHRoYXQuCgkJCWRlZmVycmVkID0gcmVtYWluaW5nID09PSAxID8gc3Vib3JkaW5hdGUgOiBqUXVlcnkuRGVmZXJyZWQoKSwKCgkJCS8vIFVwZGF0ZSBmdW5jdGlvbiBmb3IgYm90aCByZXNvbHZlIGFuZCBwcm9ncmVzcyB2YWx1ZXMKCQkJdXBkYXRlRnVuYyA9IGZ1bmN0aW9uKCBpLCBjb250ZXh0cywgdmFsdWVzICkgewoJCQkJcmV0dXJuIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJCQljb250ZXh0c1sgaSBdID0gdGhpczsKCQkJCQl2YWx1ZXNbIGkgXSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gY29yZV9zbGljZS5jYWxsKCBhcmd1bWVudHMgKSA6IHZhbHVlOwoJCQkJCWlmKCB2YWx1ZXMgPT09IHByb2dyZXNzVmFsdWVzICkgewoJCQkJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBjb250ZXh0cywgdmFsdWVzICk7CgkJCQkJfSBlbHNlIGlmICggISggLS1yZW1haW5pbmcgKSApIHsKCQkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGNvbnRleHRzLCB2YWx1ZXMgKTsKCQkJCQl9CgkJCQl9OwoJCQl9LAoKCQkJcHJvZ3Jlc3NWYWx1ZXMsIHByb2dyZXNzQ29udGV4dHMsIHJlc29sdmVDb250ZXh0czsKCgkJLy8gYWRkIGxpc3RlbmVycyB0byBEZWZlcnJlZCBzdWJvcmRpbmF0ZXM7IHRyZWF0IG90aGVycyBhcyByZXNvbHZlZAoJCWlmICggbGVuZ3RoID4gMSApIHsKCQkJcHJvZ3Jlc3NWYWx1ZXMgPSBuZXcgQXJyYXkoIGxlbmd0aCApOwoJCQlwcm9ncmVzc0NvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJcmVzb2x2ZUNvbnRleHRzID0gbmV3IEFycmF5KCBsZW5ndGggKTsKCQkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIHJlc29sdmVWYWx1ZXNbIGkgXSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggcmVzb2x2ZVZhbHVlc1sgaSBdLnByb21pc2UgKSApIHsKCQkJCQlyZXNvbHZlVmFsdWVzWyBpIF0ucHJvbWlzZSgpCgkJCQkJCS5kb25lKCB1cGRhdGVGdW5jKCBpLCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKSApCgkJCQkJCS5mYWlsKCBkZWZlcnJlZC5yZWplY3QgKQoJCQkJCQkucHJvZ3Jlc3MoIHVwZGF0ZUZ1bmMoIGksIHByb2dyZXNzQ29udGV4dHMsIHByb2dyZXNzVmFsdWVzICkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLS1yZW1haW5pbmc7CgkJCQl9CgkJCX0KCQl9CgoJCS8vIGlmIHdlJ3JlIG5vdCB3YWl0aW5nIG9uIGFueXRoaW5nLCByZXNvbHZlIHRoZSBtYXN0ZXIKCQlpZiAoICFyZW1haW5pbmcgKSB7CgkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCByZXNvbHZlQ29udGV4dHMsIHJlc29sdmVWYWx1ZXMgKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Cn0pOwpqUXVlcnkuc3VwcG9ydCA9IChmdW5jdGlvbiggc3VwcG9ydCApIHsKCXZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0IiksCgkJZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCgkJZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IiksCgkJc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic2VsZWN0IiksCgkJb3B0ID0gc2VsZWN0LmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvcHRpb24iKSApOwoKCS8vIEZpbmlzaCBlYXJseSBpbiBsaW1pdGVkIGVudmlyb25tZW50cwoJaWYgKCAhaW5wdXQudHlwZSApIHsKCQlyZXR1cm4gc3VwcG9ydDsKCX0KCglpbnB1dC50eXBlID0gImNoZWNrYm94IjsKCgkvLyBTdXBwb3J0OiBTYWZhcmkgNS4xLCBpT1MgNS4xLCBBbmRyb2lkIDQueCwgQW5kcm9pZCAyLjMKCS8vIENoZWNrIHRoZSBkZWZhdWx0IGNoZWNrYm94L3JhZGlvIHZhbHVlICgiIiBvbiBvbGQgV2ViS2l0OyAib24iIGVsc2V3aGVyZSkKCXN1cHBvcnQuY2hlY2tPbiA9IGlucHV0LnZhbHVlICE9PSAiIjsKCgkvLyBNdXN0IGFjY2VzcyB0aGUgcGFyZW50IHRvIG1ha2UgYW4gb3B0aW9uIHNlbGVjdCBwcm9wZXJseQoJLy8gU3VwcG9ydDogSUU5LCBJRTEwCglzdXBwb3J0Lm9wdFNlbGVjdGVkID0gb3B0LnNlbGVjdGVkOwoKCS8vIFdpbGwgYmUgZGVmaW5lZCBsYXRlcgoJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0gdHJ1ZTsKCXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSB0cnVlOwoJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gZmFsc2U7CgoJLy8gTWFrZSBzdXJlIGNoZWNrZWQgc3RhdHVzIGlzIHByb3Blcmx5IGNsb25lZAoJLy8gU3VwcG9ydDogSUU5LCBJRTEwCglpbnB1dC5jaGVja2VkID0gdHJ1ZTsKCXN1cHBvcnQubm9DbG9uZUNoZWNrZWQgPSBpbnB1dC5jbG9uZU5vZGUoIHRydWUgKS5jaGVja2VkOwoKCS8vIE1ha2Ugc3VyZSB0aGF0IHRoZSBvcHRpb25zIGluc2lkZSBkaXNhYmxlZCBzZWxlY3RzIGFyZW4ndCBtYXJrZWQgYXMgZGlzYWJsZWQKCS8vIChXZWJLaXQgbWFya3MgdGhlbSBhcyBkaXNhYmxlZCkKCXNlbGVjdC5kaXNhYmxlZCA9IHRydWU7CglzdXBwb3J0Lm9wdERpc2FibGVkID0gIW9wdC5kaXNhYmxlZDsKCgkvLyBDaGVjayBpZiBhbiBpbnB1dCBtYWludGFpbnMgaXRzIHZhbHVlIGFmdGVyIGJlY29taW5nIGEgcmFkaW8KCS8vIFN1cHBvcnQ6IElFOSwgSUUxMAoJaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJaW5wdXQudmFsdWUgPSAidCI7CglpbnB1dC50eXBlID0gInJhZGlvIjsKCXN1cHBvcnQucmFkaW9WYWx1ZSA9IGlucHV0LnZhbHVlID09PSAidCI7CgoJLy8gIzExMjE3IC0gV2ViS2l0IGxvc2VzIGNoZWNrIHdoZW4gdGhlIG5hbWUgaXMgYWZ0ZXIgdGhlIGNoZWNrZWQgYXR0cmlidXRlCglpbnB1dC5zZXRBdHRyaWJ1dGUoICJjaGVja2VkIiwgInQiICk7CglpbnB1dC5zZXRBdHRyaWJ1dGUoICJuYW1lIiwgInQiICk7CgoJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGlucHV0ICk7CgoJLy8gU3VwcG9ydDogU2FmYXJpIDUuMSwgQW5kcm9pZCA0LngsIEFuZHJvaWQgMi4zCgkvLyBvbGQgV2ViS2l0IGRvZXNuJ3QgY2xvbmUgY2hlY2tlZCBzdGF0ZSBjb3JyZWN0bHkgaW4gZnJhZ21lbnRzCglzdXBwb3J0LmNoZWNrQ2xvbmUgPSBmcmFnbWVudC5jbG9uZU5vZGUoIHRydWUgKS5jbG9uZU5vZGUoIHRydWUgKS5sYXN0Q2hpbGQuY2hlY2tlZDsKCgkvLyBTdXBwb3J0OiBGaXJlZm94LCBDaHJvbWUsIFNhZmFyaQoJLy8gQmV3YXJlIG9mIENTUCByZXN0cmljdGlvbnMgKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL1NlY3VyaXR5L0NTUCkKCXN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgPSAib25mb2N1c2luIiBpbiB3aW5kb3c7CgoJZGl2LnN0eWxlLmJhY2tncm91bmRDbGlwID0gImNvbnRlbnQtYm94IjsKCWRpdi5jbG9uZU5vZGUoIHRydWUgKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiOwoJc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CgoJLy8gUnVuIHRlc3RzIHRoYXQgbmVlZCBhIGJvZHkgYXQgZG9jIHJlYWR5CglqUXVlcnkoZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciwgbWFyZ2luRGl2LAoJCQkvLyBTdXBwb3J0OiBGaXJlZm94LCBBbmRyb2lkIDIuMyAoUHJlZml4ZWQgYm94LXNpemluZyB2ZXJzaW9ucykuCgkJCWRpdlJlc2V0ID0gInBhZGRpbmc6MDttYXJnaW46MDtib3JkZXI6MDtkaXNwbGF5OmJsb2NrOy13ZWJraXQtYm94LXNpemluZzpjb250ZW50LWJveDstbW96LWJveC1zaXppbmc6Y29udGVudC1ib3g7Ym94LXNpemluZzpjb250ZW50LWJveCIsCgkJCWJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWyAwIF07CgoJCWlmICggIWJvZHkgKSB7CgkJCS8vIFJldHVybiBmb3IgZnJhbWVzZXQgZG9jcyB0aGF0IGRvbid0IGhhdmUgYSBib2R5CgkJCXJldHVybjsKCQl9CgoJCWNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCWNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gImJvcmRlcjowO3dpZHRoOjA7aGVpZ2h0OjA7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDotOTk5OXB4O21hcmdpbi10b3A6MXB4IjsKCgkJLy8gQ2hlY2sgYm94LXNpemluZyBhbmQgbWFyZ2luIGJlaGF2aW9yLgoJCWJvZHkuYXBwZW5kQ2hpbGQoIGNvbnRhaW5lciApLmFwcGVuZENoaWxkKCBkaXYgKTsKCQlkaXYuaW5uZXJIVE1MID0gIiI7CgkJLy8gU3VwcG9ydDogRmlyZWZveCwgQW5kcm9pZCAyLjMgKFByZWZpeGVkIGJveC1zaXppbmcgdmVyc2lvbnMpLgoJCWRpdi5zdHlsZS5jc3NUZXh0ID0gIi13ZWJraXQtYm94LXNpemluZzpib3JkZXItYm94Oy1tb3otYm94LXNpemluZzpib3JkZXItYm94O2JveC1zaXppbmc6Ym9yZGVyLWJveDtwYWRkaW5nOjFweDtib3JkZXI6MXB4O2Rpc3BsYXk6YmxvY2s7d2lkdGg6NHB4O21hcmdpbi10b3A6MSU7cG9zaXRpb246YWJzb2x1dGU7dG9wOjElIjsKCgkJLy8gV29ya2Fyb3VuZCBmYWlsaW5nIGJveFNpemluZyB0ZXN0IGR1ZSB0byBvZmZzZXRXaWR0aCByZXR1cm5pbmcgd3JvbmcgdmFsdWUKCQkvLyB3aXRoIHNvbWUgbm9uLTEgdmFsdWVzIG9mIGJvZHkgem9vbSwgdGlja2V0ICMxMzU0MwoJCWpRdWVyeS5zd2FwKCBib2R5LCBib2R5LnN0eWxlLnpvb20gIT0gbnVsbCA/IHsgem9vbTogMSB9IDoge30sIGZ1bmN0aW9uKCkgewoJCQlzdXBwb3J0LmJveFNpemluZyA9IGRpdi5vZmZzZXRXaWR0aCA9PT0gNDsKCQl9KTsKCgkJLy8gVXNlIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlIGJlY2F1c2UganNkb20gb24gbm9kZS5qcyB3aWxsIGJyZWFrIHdpdGhvdXQgaXQuCgkJaWYgKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSApIHsKCQkJc3VwcG9ydC5waXhlbFBvc2l0aW9uID0gKCB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSggZGl2LCBudWxsICkgfHwge30gKS50b3AgIT09ICIxJSI7CgkJCXN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgPSAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBkaXYsIG51bGwgKSB8fCB7IHdpZHRoOiAiNHB4IiB9ICkud2lkdGggPT09ICI0cHgiOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCQkJLy8gQ2hlY2sgaWYgZGl2IHdpdGggZXhwbGljaXQgd2lkdGggYW5kIG5vIG1hcmdpbi1yaWdodCBpbmNvcnJlY3RseQoJCQkvLyBnZXRzIGNvbXB1dGVkIG1hcmdpbi1yaWdodCBiYXNlZCBvbiB3aWR0aCBvZiBjb250YWluZXIuICgjMzMzMykKCQkJLy8gV2ViS2l0IEJ1ZyAxMzM0MyAtIGdldENvbXB1dGVkU3R5bGUgcmV0dXJucyB3cm9uZyB2YWx1ZSBmb3IgbWFyZ2luLXJpZ2h0CgkJCW1hcmdpbkRpdiA9IGRpdi5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2IikgKTsKCQkJbWFyZ2luRGl2LnN0eWxlLmNzc1RleHQgPSBkaXYuc3R5bGUuY3NzVGV4dCA9IGRpdlJlc2V0OwoJCQltYXJnaW5EaXYuc3R5bGUubWFyZ2luUmlnaHQgPSBtYXJnaW5EaXYuc3R5bGUud2lkdGggPSAiMCI7CgkJCWRpdi5zdHlsZS53aWR0aCA9ICIxcHgiOwoKCQkJc3VwcG9ydC5yZWxpYWJsZU1hcmdpblJpZ2h0ID0KCQkJCSFwYXJzZUZsb2F0KCAoIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBtYXJnaW5EaXYsIG51bGwgKSB8fCB7fSApLm1hcmdpblJpZ2h0ICk7CgkJfQoKCQlib2R5LnJlbW92ZUNoaWxkKCBjb250YWluZXIgKTsKCX0pOwoKCXJldHVybiBzdXBwb3J0Owp9KSgge30gKTsKCi8qCglJbXBsZW1lbnRhdGlvbiBTdW1tYXJ5CgoJMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAoJMi4gSW1wcm92ZSB0aGUgbW9kdWxlJ3MgbWFpbnRhaW5hYmlsaXR5IGJ5IHJlZHVjaW5nIHRoZSBzdG9yYWdlCgkJcGF0aHMgdG8gYSBzaW5nbGUgbWVjaGFuaXNtLgoJMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgoJNC4gX05ldmVyXyBleHBvc2UgInByaXZhdGUiIGRhdGEgdG8gdXNlciBjb2RlIChUT0RPOiBEcm9wIF9kYXRhLCBfcmVtb3ZlRGF0YSkKCTUuIEF2b2lkIGV4cG9zaW5nIGltcGxlbWVudGF0aW9uIGRldGFpbHMgb24gdXNlciBvYmplY3RzIChlZy4gZXhwYW5kbyBwcm9wZXJ0aWVzKQoJNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0CiovCnZhciBkYXRhX3VzZXIsIGRhdGFfcHJpdiwKCXJicmFjZSA9IC8oPzpce1tcc1xTXSpcfXxcW1tcc1xTXSpcXSkkLywKCXJtdWx0aURhc2ggPSAvKFtBLVpdKS9nOwoKZnVuY3Rpb24gRGF0YSgpIHsKCS8vIFN1cHBvcnQ6IEFuZHJvaWQgPCA0LAoJLy8gT2xkIFdlYktpdCBkb2VzIG5vdCBoYXZlIE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucy9mcmVlemUgbWV0aG9kLAoJLy8gcmV0dXJuIG5ldyBlbXB0eSBvYmplY3QgaW5zdGVhZCB3aXRoIG5vIFtbc2V0XV0gYWNjZXNzb3IKCU9iamVjdC5kZWZpbmVQcm9wZXJ0eSggdGhpcy5jYWNoZSA9IHt9LCAwLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHt9OwoJCX0KCX0pOwoKCXRoaXMuZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvICsgTWF0aC5yYW5kb20oKTsKfQoKRGF0YS51aWQgPSAxOwoKRGF0YS5hY2NlcHRzID0gZnVuY3Rpb24oIG93bmVyICkgewoJLy8gQWNjZXB0cyBvbmx5OgoJLy8gIC0gTm9kZQoJLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQoJLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKCS8vICAtIE9iamVjdAoJLy8gICAgLSBBbnkKCXJldHVybiBvd25lci5ub2RlVHlwZSA/CgkJb3duZXIubm9kZVR5cGUgPT09IDEgfHwgb3duZXIubm9kZVR5cGUgPT09IDkgOiB0cnVlOwp9OwoKRGF0YS5wcm90b3R5cGUgPSB7CglrZXk6IGZ1bmN0aW9uKCBvd25lciApIHsKCQkvLyBXZSBjYW4gYWNjZXB0IGRhdGEgZm9yIG5vbi1lbGVtZW50IG5vZGVzIGluIG1vZGVybiBicm93c2VycywKCQkvLyBidXQgd2Ugc2hvdWxkIG5vdCwgc2VlICM4MzM1LgoJCS8vIEFsd2F5cyByZXR1cm4gdGhlIGtleSBmb3IgYSBmcm96ZW4gb2JqZWN0LgoJCWlmICggIURhdGEuYWNjZXB0cyggb3duZXIgKSApIHsKCQkJcmV0dXJuIDA7CgkJfQoKCQl2YXIgZGVzY3JpcHRvciA9IHt9LAoJCQkvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUga2V5CgkJCXVubG9jayA9IG93bmVyWyB0aGlzLmV4cGFuZG8gXTsKCgkJLy8gSWYgbm90LCBjcmVhdGUgb25lCgkJaWYgKCAhdW5sb2NrICkgewoJCQl1bmxvY2sgPSBEYXRhLnVpZCsrOwoKCQkJLy8gU2VjdXJlIGl0IGluIGEgbm9uLWVudW1lcmFibGUsIG5vbi13cml0YWJsZSBwcm9wZXJ0eQoJCQl0cnkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB7IHZhbHVlOiB1bmxvY2sgfTsKCQkJCU9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKCBvd25lciwgZGVzY3JpcHRvciApOwoKCQkJLy8gU3VwcG9ydDogQW5kcm9pZCA8IDQKCQkJLy8gRmFsbGJhY2sgdG8gYSBsZXNzIHNlY3VyZSBkZWZpbml0aW9uCgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJZGVzY3JpcHRvclsgdGhpcy5leHBhbmRvIF0gPSB1bmxvY2s7CgkJCQlqUXVlcnkuZXh0ZW5kKCBvd25lciwgZGVzY3JpcHRvciApOwoJCQl9CgkJfQoKCQkvLyBFbnN1cmUgdGhlIGNhY2hlIG9iamVjdAoJCWlmICggIXRoaXMuY2FjaGVbIHVubG9jayBdICkgewoJCQl0aGlzLmNhY2hlWyB1bmxvY2sgXSA9IHt9OwoJCX0KCgkJcmV0dXJuIHVubG9jazsKCX0sCglzZXQ6IGZ1bmN0aW9uKCBvd25lciwgZGF0YSwgdmFsdWUgKSB7CgkJdmFyIHByb3AsCgkJCS8vIFRoZXJlIG1heSBiZSBhbiB1bmxvY2sgYXNzaWduZWQgdG8gdGhpcyBub2RlLAoJCQkvLyBpZiB0aGVyZSBpcyBubyBlbnRyeSBmb3IgdGhpcyAib3duZXIiLCBjcmVhdGUgb25lIGlubGluZQoJCQkvLyBhbmQgc2V0IHRoZSB1bmxvY2sgYXMgdGhvdWdoIGFuIG93bmVyIGVudHJ5IGhhZCBhbHdheXMgZXhpc3RlZAoJCQl1bmxvY2sgPSB0aGlzLmtleSggb3duZXIgKSwKCQkJY2FjaGUgPSB0aGlzLmNhY2hlWyB1bmxvY2sgXTsKCgkJLy8gSGFuZGxlOiBbIG93bmVyLCBrZXksIHZhbHVlIF0gYXJncwoJCWlmICggdHlwZW9mIGRhdGEgPT09ICJzdHJpbmciICkgewoJCQljYWNoZVsgZGF0YSBdID0gdmFsdWU7CgoJCS8vIEhhbmRsZTogWyBvd25lciwgeyBwcm9wZXJ0aWVzIH0gXSBhcmdzCgkJfSBlbHNlIHsKCQkJLy8gRnJlc2ggYXNzaWdubWVudHMgYnkgb2JqZWN0IGFyZSBzaGFsbG93IGNvcGllZAoJCQlpZiAoIGpRdWVyeS5pc0VtcHR5T2JqZWN0KCBjYWNoZSApICkgewoJCQkJalF1ZXJ5LmV4dGVuZCggdGhpcy5jYWNoZVsgdW5sb2NrIF0sIGRhdGEgKTsKCQkJLy8gT3RoZXJ3aXNlLCBjb3B5IHRoZSBwcm9wZXJ0aWVzIG9uZS1ieS1vbmUgdG8gdGhlIGNhY2hlIG9iamVjdAoJCQl9IGVsc2UgewoJCQkJZm9yICggcHJvcCBpbiBkYXRhICkgewoJCQkJCWNhY2hlWyBwcm9wIF0gPSBkYXRhWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGNhY2hlOwoJfSwKCWdldDogZnVuY3Rpb24oIG93bmVyLCBrZXkgKSB7CgkJLy8gRWl0aGVyIGEgdmFsaWQgY2FjaGUgaXMgZm91bmQsIG9yIHdpbGwgYmUgY3JlYXRlZC4KCQkvLyBOZXcgY2FjaGVzIHdpbGwgYmUgY3JlYXRlZCBhbmQgdGhlIHVubG9jayByZXR1cm5lZCwKCQkvLyBhbGxvd2luZyBkaXJlY3QgYWNjZXNzIHRvIHRoZSBuZXdseSBjcmVhdGVkCgkJLy8gZW1wdHkgZGF0YSBvYmplY3QuIEEgdmFsaWQgb3duZXIgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuCgkJdmFyIGNhY2hlID0gdGhpcy5jYWNoZVsgdGhpcy5rZXkoIG93bmVyICkgXTsKCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkID8KCQkJY2FjaGUgOiBjYWNoZVsga2V5IF07Cgl9LAoJYWNjZXNzOiBmdW5jdGlvbiggb3duZXIsIGtleSwgdmFsdWUgKSB7CgkJdmFyIHN0b3JlZDsKCQkvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIE5vIGtleSB3YXMgc3BlY2lmaWVkCgkJLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCgkJLy8KCQkvLyBUYWtlIHRoZSAicmVhZCIgcGF0aCBhbmQgYWxsb3cgdGhlIGdldCBtZXRob2QgdG8gZGV0ZXJtaW5lCgkJLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgoJCS8vCgkJLy8gICAxLiBUaGUgZW50aXJlIGNhY2hlIG9iamVjdAoJCS8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKCQkvLwoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgfHwKCQkJCSgoa2V5ICYmIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciKSAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSApIHsKCgkJCXN0b3JlZCA9IHRoaXMuZ2V0KCBvd25lciwga2V5ICk7CgoJCQlyZXR1cm4gc3RvcmVkICE9PSB1bmRlZmluZWQgPwoJCQkJc3RvcmVkIDogdGhpcy5nZXQoIG93bmVyLCBqUXVlcnkuY2FtZWxDYXNlKGtleSkgKTsKCQl9CgoJCS8vIFsqXVdoZW4gdGhlIGtleSBpcyBub3QgYSBzdHJpbmcsIG9yIGJvdGggYSBrZXkgYW5kIHZhbHVlCgkJLy8gYXJlIHNwZWNpZmllZCwgc2V0IG9yIGV4dGVuZCAoZXhpc3Rpbmcgb2JqZWN0cykgd2l0aCBlaXRoZXI6CgkJLy8KCQkvLyAgIDEuIEFuIG9iamVjdCBvZiBwcm9wZXJ0aWVzCgkJLy8gICAyLiBBIGtleSBhbmQgdmFsdWUKCQkvLwoJCXRoaXMuc2V0KCBvd25lciwga2V5LCB2YWx1ZSApOwoKCQkvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCgkJLy8gcmV0dXJuIHRoZSBleHBlY3RlZCBkYXRhIGJhc2VkIG9uIHdoaWNoIHBhdGggd2FzIHRha2VuWypdCgkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPyB2YWx1ZSA6IGtleTsKCX0sCglyZW1vdmU6IGZ1bmN0aW9uKCBvd25lciwga2V5ICkgewoJCXZhciBpLCBuYW1lLCBjYW1lbCwKCQkJdW5sb2NrID0gdGhpcy5rZXkoIG93bmVyICksCgkJCWNhY2hlID0gdGhpcy5jYWNoZVsgdW5sb2NrIF07CgoJCWlmICgga2V5ID09PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuY2FjaGVbIHVubG9jayBdID0ge307CgoJCX0gZWxzZSB7CgkJCS8vIFN1cHBvcnQgYXJyYXkgb3Igc3BhY2Ugc2VwYXJhdGVkIHN0cmluZyBvZiBrZXlzCgkJCWlmICggalF1ZXJ5LmlzQXJyYXkoIGtleSApICkgewoJCQkJLy8gSWYgIm5hbWUiIGlzIGFuIGFycmF5IG9mIGtleXMuLi4KCQkJCS8vIFdoZW4gZGF0YSBpcyBpbml0aWFsbHkgY3JlYXRlZCwgdmlhICgia2V5IiwgInZhbCIpIHNpZ25hdHVyZSwKCQkJCS8vIGtleXMgd2lsbCBiZSBjb252ZXJ0ZWQgdG8gY2FtZWxDYXNlLgoJCQkJLy8gU2luY2UgdGhlcmUgaXMgbm8gd2F5IHRvIHRlbGwgX2hvd18gYSBrZXkgd2FzIGFkZGVkLCByZW1vdmUKCQkJCS8vIGJvdGggcGxhaW4ga2V5IGFuZCBjYW1lbENhc2Uga2V5LiAjMTI3ODYKCQkJCS8vIFRoaXMgd2lsbCBvbmx5IHBlbmFsaXplIHRoZSBhcnJheSBhcmd1bWVudCBwYXRoLgoJCQkJbmFtZSA9IGtleS5jb25jYXQoIGtleS5tYXAoIGpRdWVyeS5jYW1lbENhc2UgKSApOwoJCQl9IGVsc2UgewoJCQkJY2FtZWwgPSBqUXVlcnkuY2FtZWxDYXNlKCBrZXkgKTsKCQkJCS8vIFRyeSB0aGUgc3RyaW5nIGFzIGEga2V5IGJlZm9yZSBhbnkgbWFuaXB1bGF0aW9uCgkJCQlpZiAoIGtleSBpbiBjYWNoZSApIHsKCQkJCQluYW1lID0gWyBrZXksIGNhbWVsIF07CgkJCQl9IGVsc2UgewoJCQkJCS8vIElmIGEga2V5IHdpdGggdGhlIHNwYWNlcyBleGlzdHMsIHVzZSBpdC4KCQkJCQkvLyBPdGhlcndpc2UsIGNyZWF0ZSBhbiBhcnJheSBieSBtYXRjaGluZyBub24td2hpdGVzcGFjZQoJCQkJCW5hbWUgPSBjYW1lbDsKCQkJCQluYW1lID0gbmFtZSBpbiBjYWNoZSA/CgkJCQkJCVsgbmFtZSBdIDogKCBuYW1lLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFtdICk7CgkJCQl9CgkJCX0KCgkJCWkgPSBuYW1lLmxlbmd0aDsKCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQlkZWxldGUgY2FjaGVbIG5hbWVbIGkgXSBdOwoJCQl9CgkJfQoJfSwKCWhhc0RhdGE6IGZ1bmN0aW9uKCBvd25lciApIHsKCQlyZXR1cm4gIWpRdWVyeS5pc0VtcHR5T2JqZWN0KAoJCQl0aGlzLmNhY2hlWyBvd25lclsgdGhpcy5leHBhbmRvIF0gXSB8fCB7fQoJCSk7Cgl9LAoJZGlzY2FyZDogZnVuY3Rpb24oIG93bmVyICkgewoJCWlmICggb3duZXJbIHRoaXMuZXhwYW5kbyBdICkgewoJCQlkZWxldGUgdGhpcy5jYWNoZVsgb3duZXJbIHRoaXMuZXhwYW5kbyBdIF07CgkJfQoJfQp9OwoKLy8gVGhlc2UgbWF5IGJlIHVzZWQgdGhyb3VnaG91dCB0aGUgalF1ZXJ5IGNvcmUgY29kZWJhc2UKZGF0YV91c2VyID0gbmV3IERhdGEoKTsKZGF0YV9wcml2ID0gbmV3IERhdGEoKTsKCgpqUXVlcnkuZXh0ZW5kKHsKCWFjY2VwdERhdGE6IERhdGEuYWNjZXB0cywKCgloYXNEYXRhOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4gZGF0YV91c2VyLmhhc0RhdGEoIGVsZW0gKSB8fCBkYXRhX3ByaXYuaGFzRGF0YSggZWxlbSApOwoJfSwKCglkYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgZGF0YSApIHsKCQlyZXR1cm4gZGF0YV91c2VyLmFjY2VzcyggZWxlbSwgbmFtZSwgZGF0YSApOwoJfSwKCglyZW1vdmVEYXRhOiBmdW5jdGlvbiggZWxlbSwgbmFtZSApIHsKCQlkYXRhX3VzZXIucmVtb3ZlKCBlbGVtLCBuYW1lICk7Cgl9LAoKCS8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCgkvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhX3ByaXYgbWV0aG9kcywgdGhlc2UgY2FuIGJlIGRlcHJlY2F0ZWQuCglfZGF0YTogZnVuY3Rpb24oIGVsZW0sIG5hbWUsIGRhdGEgKSB7CgkJcmV0dXJuIGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIG5hbWUsIGRhdGEgKTsKCX0sCgoJX3JlbW92ZURhdGE6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lICkgewoJCWRhdGFfcHJpdi5yZW1vdmUoIGVsZW0sIG5hbWUgKTsKCX0KfSk7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCWRhdGE6IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBhdHRycywgbmFtZSwKCQkJZWxlbSA9IHRoaXNbIDAgXSwKCQkJaSA9IDAsCgkJCWRhdGEgPSBudWxsOwoKCQkvLyBHZXRzIGFsbCB2YWx1ZXMKCQlpZiAoIGtleSA9PT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMubGVuZ3RoICkgewoJCQkJZGF0YSA9IGRhdGFfdXNlci5nZXQoIGVsZW0gKTsKCgkJCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgIWRhdGFfcHJpdi5nZXQoIGVsZW0sICJoYXNEYXRhQXR0cnMiICkgKSB7CgkJCQkJYXR0cnMgPSBlbGVtLmF0dHJpYnV0ZXM7CgkJCQkJZm9yICggOyBpIDwgYXR0cnMubGVuZ3RoOyBpKysgKSB7CgkJCQkJCW5hbWUgPSBhdHRyc1sgaSBdLm5hbWU7CgoJCQkJCQlpZiAoIG5hbWUuaW5kZXhPZiggImRhdGEtIiApID09PSAwICkgewoJCQkJCQkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUuc2xpY2UoNSkgKTsKCQkJCQkJCWRhdGFBdHRyKCBlbGVtLCBuYW1lLCBkYXRhWyBuYW1lIF0gKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlkYXRhX3ByaXYuc2V0KCBlbGVtLCAiaGFzRGF0YUF0dHJzIiwgdHJ1ZSApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gZGF0YTsKCQl9CgoJCS8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAib2JqZWN0IiApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCWRhdGFfdXNlci5zZXQoIHRoaXMsIGtleSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBkYXRhLAoJCQkJY2FtZWxLZXkgPSBqUXVlcnkuY2FtZWxDYXNlKCBrZXkgKTsKCgkJCS8vIFRoZSBjYWxsaW5nIGpRdWVyeSBvYmplY3QgKGVsZW1lbnQgbWF0Y2hlcykgaXMgbm90IGVtcHR5CgkJCS8vIChhbmQgdGhlcmVmb3JlIGhhcyBhbiBlbGVtZW50IGFwcGVhcnMgYXQgdGhpc1sgMCBdKSBhbmQgdGhlCgkJCS8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CgkJCS8vIHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGZvciBlbGVtID0gdGhpc1sgMCBdIHdoaWNoIHdpbGwKCQkJLy8gdGhyb3cgYW4gZXhjZXB0aW9uIGlmIGFuIGF0dGVtcHQgdG8gcmVhZCBhIGRhdGEgY2FjaGUgaXMgbWFkZS4KCQkJaWYgKCBlbGVtICYmIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkvLyBBdHRlbXB0IHRvIGdldCBkYXRhIGZyb20gdGhlIGNhY2hlCgkJCQkvLyB3aXRoIHRoZSBrZXkgYXMtaXMKCQkJCWRhdGEgPSBkYXRhX3VzZXIuZ2V0KCBlbGVtLCBrZXkgKTsKCQkJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBkYXRhOwoJCQkJfQoKCQkJCS8vIEF0dGVtcHQgdG8gZ2V0IGRhdGEgZnJvbSB0aGUgY2FjaGUKCQkJCS8vIHdpdGggdGhlIGtleSBjYW1lbGl6ZWQKCQkJCWRhdGEgPSBkYXRhX3VzZXIuZ2V0KCBlbGVtLCBjYW1lbEtleSApOwoJCQkJaWYgKCBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9CgoJCQkJLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCgkJCQkvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCgkJCQlkYXRhID0gZGF0YUF0dHIoIGVsZW0sIGNhbWVsS2V5LCB1bmRlZmluZWQgKTsKCQkJCWlmICggZGF0YSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBkYXRhOwoJCQkJfQoKCQkJCS8vIFdlIHRyaWVkIHJlYWxseSBoYXJkLCBidXQgdGhlIGRhdGEgZG9lc24ndCBleGlzdC4KCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU2V0IHRoZSBkYXRhLi4uCgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCS8vIEZpcnN0LCBhdHRlbXB0IHRvIHN0b3JlIGEgY29weSBvciByZWZlcmVuY2Ugb2YgYW55CgkJCQkvLyBkYXRhIHRoYXQgbWlnaHQndmUgYmVlbiBzdG9yZSB3aXRoIGEgY2FtZWxDYXNlZCBrZXkuCgkJCQl2YXIgZGF0YSA9IGRhdGFfdXNlci5nZXQoIHRoaXMsIGNhbWVsS2V5ICk7CgoJCQkJLy8gRm9yIEhUTUw1IGRhdGEtKiBhdHRyaWJ1dGUgaW50ZXJvcCwgd2UgaGF2ZSB0bwoJCQkJLy8gc3RvcmUgcHJvcGVydHkgbmFtZXMgd2l0aCBkYXNoZXMgaW4gYSBjYW1lbENhc2UgZm9ybS4KCQkJCS8vIFRoaXMgbWlnaHQgbm90IGFwcGx5IHRvIGFsbCBwcm9wZXJ0aWVzLi4uKgoJCQkJZGF0YV91c2VyLnNldCggdGhpcywgY2FtZWxLZXksIHZhbHVlICk7CgoJCQkJLy8gKi4uLiBJbiB0aGUgY2FzZSBvZiBwcm9wZXJ0aWVzIHRoYXQgbWlnaHQgX2FjdHVhbGx5XwoJCQkJLy8gaGF2ZSBkYXNoZXMsIHdlIG5lZWQgdG8gYWxzbyBzdG9yZSBhIGNvcHkgb2YgdGhhdAoJCQkJLy8gdW5jaGFuZ2VkIHByb3BlcnR5LgoJCQkJaWYgKCBrZXkuaW5kZXhPZigiLSIpICE9PSAtMSAmJiBkYXRhICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJZGF0YV91c2VyLnNldCggdGhpcywga2V5LCB2YWx1ZSApOwoJCQkJfQoJCQl9KTsKCQl9LCBudWxsLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEsIG51bGwsIHRydWUgKTsKCX0sCgoJcmVtb3ZlRGF0YTogZnVuY3Rpb24oIGtleSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlkYXRhX3VzZXIucmVtb3ZlKCB0aGlzLCBrZXkgKTsKCQl9KTsKCX0KfSk7CgpmdW5jdGlvbiBkYXRhQXR0ciggZWxlbSwga2V5LCBkYXRhICkgewoJdmFyIG5hbWU7CgoJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW50ZXJuYWxseSwgdHJ5IHRvIGZldGNoIGFueQoJLy8gZGF0YSBmcm9tIHRoZSBIVE1MNSBkYXRhLSogYXR0cmlidXRlCglpZiAoIGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCW5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2UoIHJtdWx0aURhc2gsICItJDEiICkudG9Mb3dlckNhc2UoKTsKCQlkYXRhID0gZWxlbS5nZXRBdHRyaWJ1dGUoIG5hbWUgKTsKCgkJaWYgKCB0eXBlb2YgZGF0YSA9PT0gInN0cmluZyIgKSB7CgkJCXRyeSB7CgkJCQlkYXRhID0gZGF0YSA9PT0gInRydWUiID8gdHJ1ZSA6CgkJCQkJZGF0YSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQkJCQlkYXRhID09PSAibnVsbCIgPyBudWxsIDoKCQkJCQkvLyBPbmx5IGNvbnZlcnQgdG8gYSBudW1iZXIgaWYgaXQgZG9lc24ndCBjaGFuZ2UgdGhlIHN0cmluZwoJCQkJCStkYXRhICsgIiIgPT09IGRhdGEgPyArZGF0YSA6CgkJCQkJcmJyYWNlLnRlc3QoIGRhdGEgKSA/IEpTT04ucGFyc2UoIGRhdGEgKSA6CgkJCQkJZGF0YTsKCQkJfSBjYXRjaCggZSApIHt9CgoJCQkvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKCQkJZGF0YV91c2VyLnNldCggZWxlbSwga2V5LCBkYXRhICk7CgkJfSBlbHNlIHsKCQkJZGF0YSA9IHVuZGVmaW5lZDsKCQl9Cgl9CglyZXR1cm4gZGF0YTsKfQpqUXVlcnkuZXh0ZW5kKHsKCXF1ZXVlOiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZGF0YSApIHsKCQl2YXIgcXVldWU7CgoJCWlmICggZWxlbSApIHsKCQkJdHlwZSA9ICggdHlwZSB8fCAiZngiICkgKyAicXVldWUiOwoJCQlxdWV1ZSA9IGRhdGFfcHJpdi5nZXQoIGVsZW0sIHR5cGUgKTsKCgkJCS8vIFNwZWVkIHVwIGRlcXVldWUgYnkgZ2V0dGluZyBvdXQgcXVpY2tseSBpZiB0aGlzIGlzIGp1c3QgYSBsb29rdXAKCQkJaWYgKCBkYXRhICkgewoJCQkJaWYgKCAhcXVldWUgfHwgalF1ZXJ5LmlzQXJyYXkoIGRhdGEgKSApIHsKCQkJCQlxdWV1ZSA9IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIHR5cGUsIGpRdWVyeS5tYWtlQXJyYXkoZGF0YSkgKTsKCQkJCX0gZWxzZSB7CgkJCQkJcXVldWUucHVzaCggZGF0YSApOwoJCQkJfQoJCQl9CgkJCXJldHVybiBxdWV1ZSB8fCBbXTsKCQl9Cgl9LAoKCWRlcXVldWU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlICkgewoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSggZWxlbSwgdHlwZSApLAoJCQlzdGFydExlbmd0aCA9IHF1ZXVlLmxlbmd0aCwKCQkJZm4gPSBxdWV1ZS5zaGlmdCgpLAoJCQlob29rcyA9IGpRdWVyeS5fcXVldWVIb29rcyggZWxlbSwgdHlwZSApLAoJCQluZXh0ID0gZnVuY3Rpb24oKSB7CgkJCQlqUXVlcnkuZGVxdWV1ZSggZWxlbSwgdHlwZSApOwoJCQl9OwoKCQkvLyBJZiB0aGUgZnggcXVldWUgaXMgZGVxdWV1ZWQsIGFsd2F5cyByZW1vdmUgdGhlIHByb2dyZXNzIHNlbnRpbmVsCgkJaWYgKCBmbiA9PT0gImlucHJvZ3Jlc3MiICkgewoJCQlmbiA9IHF1ZXVlLnNoaWZ0KCk7CgkJCXN0YXJ0TGVuZ3RoLS07CgkJfQoKCQlpZiAoIGZuICkgewoKCQkJLy8gQWRkIGEgcHJvZ3Jlc3Mgc2VudGluZWwgdG8gcHJldmVudCB0aGUgZnggcXVldWUgZnJvbSBiZWluZwoJCQkvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCgkJCWlmICggdHlwZSA9PT0gImZ4IiApIHsKCQkJCXF1ZXVlLnVuc2hpZnQoICJpbnByb2dyZXNzIiApOwoJCQl9CgoJCQkvLyBjbGVhciB1cCB0aGUgbGFzdCBxdWV1ZSBzdG9wIGZ1bmN0aW9uCgkJCWRlbGV0ZSBob29rcy5zdG9wOwoJCQlmbi5jYWxsKCBlbGVtLCBuZXh0LCBob29rcyApOwoJCX0KCgkJaWYgKCAhc3RhcnRMZW5ndGggJiYgaG9va3MgKSB7CgkJCWhvb2tzLmVtcHR5LmZpcmUoKTsKCQl9Cgl9LAoKCS8vIG5vdCBpbnRlbmRlZCBmb3IgcHVibGljIGNvbnN1bXB0aW9uIC0gZ2VuZXJhdGVzIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybnMgdGhlIGN1cnJlbnQgb25lCglfcXVldWVIb29rczogZnVuY3Rpb24oIGVsZW0sIHR5cGUgKSB7CgkJdmFyIGtleSA9IHR5cGUgKyAicXVldWVIb29rcyI7CgkJcmV0dXJuIGRhdGFfcHJpdi5nZXQoIGVsZW0sIGtleSApIHx8IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sIGtleSwgewoJCQllbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24oKSB7CgkJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCBbIHR5cGUgKyAicXVldWUiLCBrZXkgXSApOwoJCQl9KQoJCX0pOwoJfQp9KTsKCmpRdWVyeS5mbi5leHRlbmQoewoJcXVldWU6IGZ1bmN0aW9uKCB0eXBlLCBkYXRhICkgewoJCXZhciBzZXR0ZXIgPSAyOwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZGF0YSA9IHR5cGU7CgkJCXR5cGUgPSAiZngiOwoJCQlzZXR0ZXItLTsKCQl9CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlciApIHsKCQkJcmV0dXJuIGpRdWVyeS5xdWV1ZSggdGhpc1swXSwgdHlwZSApOwoJCX0KCgkJcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/CgkJCXRoaXMgOgoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIGRhdGEgKTsKCgkJCQkvLyBlbnN1cmUgYSBob29rcyBmb3IgdGhpcyBxdWV1ZQoJCQkJalF1ZXJ5Ll9xdWV1ZUhvb2tzKCB0aGlzLCB0eXBlICk7CgoJCQkJaWYgKCB0eXBlID09PSAiZngiICYmIHF1ZXVlWzBdICE9PSAiaW5wcm9ncmVzcyIgKSB7CgkJCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQkJCX0KCQkJfSk7Cgl9LAoJZGVxdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmRlcXVldWUoIHRoaXMsIHR5cGUgKTsKCQl9KTsKCX0sCgkvLyBCYXNlZCBvZmYgb2YgdGhlIHBsdWdpbiBieSBDbGludCBIZWxmZXJzLCB3aXRoIHBlcm1pc3Npb24uCgkvLyBodHRwOi8vYmxpbmRzaWduYWxzLmNvbS9pbmRleC5waHAvMjAwOS8wNy9qcXVlcnktZGVsYXkvCglkZWxheTogZnVuY3Rpb24oIHRpbWUsIHR5cGUgKSB7CgkJdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbIHRpbWUgXSB8fCB0aW1lIDogdGltZTsKCQl0eXBlID0gdHlwZSB8fCAiZngiOwoKCQlyZXR1cm4gdGhpcy5xdWV1ZSggdHlwZSwgZnVuY3Rpb24oIG5leHQsIGhvb2tzICkgewoJCQl2YXIgdGltZW91dCA9IHNldFRpbWVvdXQoIG5leHQsIHRpbWUgKTsKCQkJaG9va3Muc3RvcCA9IGZ1bmN0aW9uKCkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lb3V0ICk7CgkJCX07CgkJfSk7Cgl9LAoJY2xlYXJRdWV1ZTogZnVuY3Rpb24oIHR5cGUgKSB7CgkJcmV0dXJuIHRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCX0sCgkvLyBHZXQgYSBwcm9taXNlIHJlc29sdmVkIHdoZW4gcXVldWVzIG9mIGEgY2VydGFpbiB0eXBlCgkvLyBhcmUgZW1wdGllZCAoZnggaXMgdGhlIHR5cGUgYnkgZGVmYXVsdCkKCXByb21pc2U6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJdmFyIHRtcCwKCQkJY291bnQgPSAxLAoJCQlkZWZlciA9IGpRdWVyeS5EZWZlcnJlZCgpLAoJCQllbGVtZW50cyA9IHRoaXMsCgkJCWkgPSB0aGlzLmxlbmd0aCwKCQkJcmVzb2x2ZSA9IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAhKCAtLWNvdW50ICkgKSB7CgkJCQkJZGVmZXIucmVzb2x2ZVdpdGgoIGVsZW1lbnRzLCBbIGVsZW1lbnRzIF0gKTsKCQkJCX0KCQkJfTsKCgkJaWYgKCB0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIgKSB7CgkJCW9iaiA9IHR5cGU7CgkJCXR5cGUgPSB1bmRlZmluZWQ7CgkJfQoJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgoJCXdoaWxlKCBpLS0gKSB7CgkJCXRtcCA9IGRhdGFfcHJpdi5nZXQoIGVsZW1lbnRzWyBpIF0sIHR5cGUgKyAicXVldWVIb29rcyIgKTsKCQkJaWYgKCB0bXAgJiYgdG1wLmVtcHR5ICkgewoJCQkJY291bnQrKzsKCQkJCXRtcC5lbXB0eS5hZGQoIHJlc29sdmUgKTsKCQkJfQoJCX0KCQlyZXNvbHZlKCk7CgkJcmV0dXJuIGRlZmVyLnByb21pc2UoIG9iaiApOwoJfQp9KTsKdmFyIG5vZGVIb29rLCBib29sSG9vaywKCXJjbGFzcyA9IC9bXHRcclxuXGZdL2csCglycmV0dXJuID0gL1xyL2csCglyZm9jdXNhYmxlID0gL14oPzppbnB1dHxzZWxlY3R8dGV4dGFyZWF8YnV0dG9uKSQvaTsKCmpRdWVyeS5mbi5leHRlbmQoewoJYXR0cjogZnVuY3Rpb24oIG5hbWUsIHZhbHVlICkgewoJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBqUXVlcnkuYXR0ciwgbmFtZSwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxICk7Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBuYW1lICkgewoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5yZW1vdmVBdHRyKCB0aGlzLCBuYW1lICk7CgkJfSk7Cgl9LAoKCXByb3A6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSApOwoJfSwKCglyZW1vdmVQcm9wOiBmdW5jdGlvbiggbmFtZSApIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlkZWxldGUgdGhpc1sgalF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lIF07CgkJfSk7Cgl9LAoKCWFkZENsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosCgkJCWkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aCwKCQkJcHJvY2VlZCA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWU7CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGogKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5hZGRDbGFzcyggdmFsdWUuY2FsbCggdGhpcywgaiwgdGhpcy5jbGFzc05hbWUgKSApOwoJCQl9KTsKCQl9CgoJCWlmICggcHJvY2VlZCApIHsKCQkJLy8gVGhlIGRpc2p1bmN0aW9uIGhlcmUgaXMgZm9yIGJldHRlciBjb21wcmVzc2liaWxpdHkgKHNlZSByZW1vdmVDbGFzcykKCQkJY2xhc3NlcyA9ICggdmFsdWUgfHwgIiIgKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbXTsKCgkJCWZvciAoIDsgaSA8IGxlbjsgaSsrICkgewoJCQkJZWxlbSA9IHRoaXNbIGkgXTsKCQkJCWN1ciA9IGVsZW0ubm9kZVR5cGUgPT09IDEgJiYgKCBlbGVtLmNsYXNzTmFtZSA/CgkJCQkJKCAiICIgKyBlbGVtLmNsYXNzTmFtZSArICIgIiApLnJlcGxhY2UoIHJjbGFzcywgIiAiICkgOgoJCQkJCSIgIgoJCQkJKTsKCgkJCQlpZiAoIGN1ciApIHsKCQkJCQlqID0gMDsKCQkJCQl3aGlsZSAoIChjbGF6eiA9IGNsYXNzZXNbaisrXSkgKSB7CgkJCQkJCWlmICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPCAwICkgewoJCQkJCQkJY3VyICs9IGNsYXp6ICsgIiAiOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWVsZW0uY2xhc3NOYW1lID0galF1ZXJ5LnRyaW0oIGN1ciApOwoKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGNsYXNzZXMsIGVsZW0sIGN1ciwgY2xhenosIGosCgkJCWkgPSAwLAoJCQlsZW4gPSB0aGlzLmxlbmd0aCwKCQkJcHJvY2VlZCA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZTsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaiApIHsKCQkJCWpRdWVyeSggdGhpcyApLnJlbW92ZUNsYXNzKCB2YWx1ZS5jYWxsKCB0aGlzLCBqLCB0aGlzLmNsYXNzTmFtZSApICk7CgkJCX0pOwoJCX0KCQlpZiAoIHByb2NlZWQgKSB7CgkJCWNsYXNzZXMgPSAoIHZhbHVlIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCWVsZW0gPSB0aGlzWyBpIF07CgkJCQkvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQoJCQkJY3VyID0gZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIGVsZW0uY2xhc3NOYW1lID8KCQkJCQkoICIgIiArIGVsZW0uY2xhc3NOYW1lICsgIiAiICkucmVwbGFjZSggcmNsYXNzLCAiICIgKSA6CgkJCQkJIiIKCQkJCSk7CgoJCQkJaWYgKCBjdXIgKSB7CgkJCQkJaiA9IDA7CgkJCQkJd2hpbGUgKCAoY2xhenogPSBjbGFzc2VzW2orK10pICkgewoJCQkJCQkvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCgkJCQkJCXdoaWxlICggY3VyLmluZGV4T2YoICIgIiArIGNsYXp6ICsgIiAiICkgPj0gMCApIHsKCQkJCQkJCWN1ciA9IGN1ci5yZXBsYWNlKCAiICIgKyBjbGF6eiArICIgIiwgIiAiICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJZWxlbS5jbGFzc05hbWUgPSB2YWx1ZSA/IGpRdWVyeS50cmltKCBjdXIgKSA6ICIiOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uKCB2YWx1ZSwgc3RhdGVWYWwgKSB7CgkJdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CgoJCWlmICggdHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgdHlwZSA9PT0gInN0cmluZyIgKSB7CgkJCXJldHVybiBzdGF0ZVZhbCA/IHRoaXMuYWRkQ2xhc3MoIHZhbHVlICkgOiB0aGlzLnJlbW92ZUNsYXNzKCB2YWx1ZSApOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeSggdGhpcyApLnRvZ2dsZUNsYXNzKCB2YWx1ZS5jYWxsKHRoaXMsIGksIHRoaXMuY2xhc3NOYW1lLCBzdGF0ZVZhbCksIHN0YXRlVmFsICk7CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCB0eXBlID09PSAic3RyaW5nIiApIHsKCQkJCS8vIHRvZ2dsZSBpbmRpdmlkdWFsIGNsYXNzIG5hbWVzCgkJCQl2YXIgY2xhc3NOYW1lLAoJCQkJCWkgPSAwLAoJCQkJCXNlbGYgPSBqUXVlcnkoIHRoaXMgKSwKCQkJCQljbGFzc05hbWVzID0gdmFsdWUubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCQkJd2hpbGUgKCAoY2xhc3NOYW1lID0gY2xhc3NOYW1lc1sgaSsrIF0pICkgewoJCQkJCS8vIGNoZWNrIGVhY2ggY2xhc3NOYW1lIGdpdmVuLCBzcGFjZSBzZXBhcmF0ZWQgbGlzdAoJCQkJCWlmICggc2VsZi5oYXNDbGFzcyggY2xhc3NOYW1lICkgKSB7CgkJCQkJCXNlbGYucmVtb3ZlQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNlbGYuYWRkQ2xhc3MoIGNsYXNzTmFtZSApOwoJCQkJCX0KCQkJCX0KCgkJCS8vIFRvZ2dsZSB3aG9sZSBjbGFzcyBuYW1lCgkJCX0gZWxzZSBpZiAoIHR5cGUgPT09IGNvcmVfc3RydW5kZWZpbmVkIHx8IHR5cGUgPT09ICJib29sZWFuIiApIHsKCQkJCWlmICggdGhpcy5jbGFzc05hbWUgKSB7CgkJCQkJLy8gc3RvcmUgY2xhc3NOYW1lIGlmIHNldAoJCQkJCWRhdGFfcHJpdi5zZXQoIHRoaXMsICJfX2NsYXNzTmFtZV9fIiwgdGhpcy5jbGFzc05hbWUgKTsKCQkJCX0KCgkJCQkvLyBJZiB0aGUgZWxlbWVudCBoYXMgYSBjbGFzcyBuYW1lIG9yIGlmIHdlJ3JlIHBhc3NlZCAiZmFsc2UiLAoJCQkJLy8gdGhlbiByZW1vdmUgdGhlIHdob2xlIGNsYXNzbmFtZSAoaWYgdGhlcmUgd2FzIG9uZSwgdGhlIGFib3ZlIHNhdmVkIGl0KS4KCQkJCS8vIE90aGVyd2lzZSBicmluZyBiYWNrIHdoYXRldmVyIHdhcyBwcmV2aW91c2x5IHNhdmVkIChpZiBhbnl0aGluZyksCgkJCQkvLyBmYWxsaW5nIGJhY2sgdG8gdGhlIGVtcHR5IHN0cmluZyBpZiBub3RoaW5nIHdhcyBzdG9yZWQuCgkJCQl0aGlzLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lIHx8IHZhbHVlID09PSBmYWxzZSA/ICIiIDogZGF0YV9wcml2LmdldCggdGhpcywgIl9fY2xhc3NOYW1lX18iICkgfHwgIiI7CgkJCX0KCQl9KTsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQl2YXIgY2xhc3NOYW1lID0gIiAiICsgc2VsZWN0b3IgKyAiICIsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGg7CgkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQlpZiAoIHRoaXNbaV0ubm9kZVR5cGUgPT09IDEgJiYgKCIgIiArIHRoaXNbaV0uY2xhc3NOYW1lICsgIiAiKS5yZXBsYWNlKHJjbGFzcywgIiAiKS5pbmRleE9mKCBjbGFzc05hbWUgKSA+PSAwICkgewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCX0sCgoJdmFsOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsIGlzRnVuY3Rpb24sCgkJCWVsZW0gPSB0aGlzWzBdOwoKCQlpZiAoICFhcmd1bWVudHMubGVuZ3RoICkgewoJCQlpZiAoIGVsZW0gKSB7CgkJCQlob29rcyA9IGpRdWVyeS52YWxIb29rc1sgZWxlbS50eXBlIF0gfHwgalF1ZXJ5LnZhbEhvb2tzWyBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgXTsKCgkJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sICJ2YWx1ZSIgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfQoKCQkJCXJldCA9IGVsZW0udmFsdWU7CgoJCQkJcmV0dXJuIHR5cGVvZiByZXQgPT09ICJzdHJpbmciID8KCQkJCQkvLyBoYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCgkJCQkJcmV0LnJlcGxhY2UocnJldHVybiwgIiIpIDoKCQkJCQkvLyBoYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKCQkJCQlyZXQgPT0gbnVsbCA/ICIiIDogcmV0OwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCXZhciB2YWw7CgoJCQlpZiAoIHRoaXMubm9kZVR5cGUgIT09IDEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggaXNGdW5jdGlvbiApIHsKCQkJCXZhbCA9IHZhbHVlLmNhbGwoIHRoaXMsIGksIGpRdWVyeSggdGhpcyApLnZhbCgpICk7CgkJCX0gZWxzZSB7CgkJCQl2YWwgPSB2YWx1ZTsKCQkJfQoKCQkJLy8gVHJlYXQgbnVsbC91bmRlZmluZWQgYXMgIiI7IGNvbnZlcnQgbnVtYmVycyB0byBzdHJpbmcKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9ICIiOwoJCQl9IGVsc2UgaWYgKCB0eXBlb2YgdmFsID09PSAibnVtYmVyIiApIHsKCQkJCXZhbCArPSAiIjsKCQkJfSBlbHNlIGlmICggalF1ZXJ5LmlzQXJyYXkoIHZhbCApICkgewoJCQkJdmFsID0galF1ZXJ5Lm1hcCh2YWwsIGZ1bmN0aW9uICggdmFsdWUgKSB7CgkJCQkJcmV0dXJuIHZhbHVlID09IG51bGwgPyAiIiA6IHZhbHVlICsgIiI7CgkJCQl9KTsKCQkJfQoKCQkJaG9va3MgPSBqUXVlcnkudmFsSG9va3NbIHRoaXMudHlwZSBdIHx8IGpRdWVyeS52YWxIb29rc1sgdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpIF07CgoJCQkvLyBJZiBzZXQgcmV0dXJucyB1bmRlZmluZWQsIGZhbGwgYmFjayB0byBub3JtYWwgc2V0dGluZwoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQoIHRoaXMsIHZhbCwgInZhbHVlIiApID09PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLnZhbHVlID0gdmFsOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7Cgl2YWxIb29rczogewoJCW9wdGlvbjogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJLy8gYXR0cmlidXRlcy52YWx1ZSBpcyB1bmRlZmluZWQgaW4gQmxhY2tiZXJyeSA0LjcgYnV0CgkJCQkvLyB1c2VzIC52YWx1ZS4gU2VlICM2OTMyCgkJCQl2YXIgdmFsID0gZWxlbS5hdHRyaWJ1dGVzLnZhbHVlOwoJCQkJcmV0dXJuICF2YWwgfHwgdmFsLnNwZWNpZmllZCA/IGVsZW0udmFsdWUgOiBlbGVtLnRleHQ7CgkJCX0KCQl9LAoJCXNlbGVjdDogewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJdmFyIHZhbHVlLCBvcHRpb24sCgkJCQkJb3B0aW9ucyA9IGVsZW0ub3B0aW9ucywKCQkJCQlpbmRleCA9IGVsZW0uc2VsZWN0ZWRJbmRleCwKCQkJCQlvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiB8fCBpbmRleCA8IDAsCgkJCQkJdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAoJCQkJCW1heCA9IG9uZSA/IGluZGV4ICsgMSA6IG9wdGlvbnMubGVuZ3RoLAoJCQkJCWkgPSBpbmRleCA8IDAgPwoJCQkJCQltYXggOgoJCQkJCQlvbmUgPyBpbmRleCA6IDA7CgoJCQkJLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwoJCQkJZm9yICggOyBpIDwgbWF4OyBpKysgKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoKCQkJCQkvLyBJRTYtOSBkb2Vzbid0IHVwZGF0ZSBzZWxlY3RlZCBhZnRlciBmb3JtIHJlc2V0ICgjMjU1MSkKCQkJCQlpZiAoICggb3B0aW9uLnNlbGVjdGVkIHx8IGkgPT09IGluZGV4ICkgJiYKCQkJCQkJCS8vIERvbid0IHJldHVybiBvcHRpb25zIHRoYXQgYXJlIGRpc2FibGVkIG9yIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKCQkJCQkJCSggalF1ZXJ5LnN1cHBvcnQub3B0RGlzYWJsZWQgPyAhb3B0aW9uLmRpc2FibGVkIDogb3B0aW9uLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PT0gbnVsbCApICYmCgkJCQkJCQkoICFvcHRpb24ucGFyZW50Tm9kZS5kaXNhYmxlZCB8fCAhalF1ZXJ5Lm5vZGVOYW1lKCBvcHRpb24ucGFyZW50Tm9kZSwgIm9wdGdyb3VwIiApICkgKSB7CgoJCQkJCQkvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCgkJCQkJCXZhbHVlID0galF1ZXJ5KCBvcHRpb24gKS52YWwoKTsKCgkJCQkJCS8vIFdlIGRvbid0IG5lZWQgYW4gYXJyYXkgZm9yIG9uZSBzZWxlY3RzCgkJCQkJCWlmICggb25lICkgewoJCQkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJCQl9CgoJCQkJCQkvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQoJCQkJCQl2YWx1ZXMucHVzaCggdmFsdWUgKTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlczsKCQkJfSwKCgkJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQkJdmFyIG9wdGlvblNldCwgb3B0aW9uLAoJCQkJCW9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCgkJCQkJdmFsdWVzID0galF1ZXJ5Lm1ha2VBcnJheSggdmFsdWUgKSwKCQkJCQlpID0gb3B0aW9ucy5sZW5ndGg7CgoJCQkJd2hpbGUgKCBpLS0gKSB7CgkJCQkJb3B0aW9uID0gb3B0aW9uc1sgaSBdOwoJCQkJCWlmICggKG9wdGlvbi5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KCBqUXVlcnkob3B0aW9uKS52YWwoKSwgdmFsdWVzICkgPj0gMCkgKSB7CgkJCQkJCW9wdGlvblNldCA9IHRydWU7CgkJCQkJfQoJCQkJfQoKCQkJCS8vIGZvcmNlIGJyb3dzZXJzIHRvIGJlaGF2ZSBjb25zaXN0ZW50bHkgd2hlbiBub24tbWF0Y2hpbmcgdmFsdWUgaXMgc2V0CgkJCQlpZiAoICFvcHRpb25TZXQgKSB7CgkJCQkJZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CgkJCQl9CgkJCQlyZXR1cm4gdmFsdWVzOwoJCQl9CgkJfQoJfSwKCglhdHRyOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIGhvb2tzLCByZXQsCgkJCW5UeXBlID0gZWxlbS5ub2RlVHlwZTsKCgkJLy8gZG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwoJCWlmICggIWVsZW0gfHwgblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCgkJaWYgKCB0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09IGNvcmVfc3RydW5kZWZpbmVkICkgewoJCQlyZXR1cm4galF1ZXJ5LnByb3AoIGVsZW0sIG5hbWUsIHZhbHVlICk7CgkJfQoKCQkvLyBBbGwgYXR0cmlidXRlcyBhcmUgbG93ZXJjYXNlCgkJLy8gR3JhYiBuZWNlc3NhcnkgaG9vayBpZiBvbmUgaXMgZGVmaW5lZAoJCWlmICggblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApICkgewoJCQluYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQlob29rcyA9IGpRdWVyeS5hdHRySG9va3NbIG5hbWUgXSB8fAoJCQkJKCBqUXVlcnkuZXhwci5tYXRjaC5ib29sLnRlc3QoIG5hbWUgKSA/IGJvb2xIb29rIDogbm9kZUhvb2sgKTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCgkJCWlmICggdmFsdWUgPT09IG51bGwgKSB7CgkJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoKCQkJfSBlbHNlIGlmICggaG9va3MgJiYgInNldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLnNldCggZWxlbSwgdmFsdWUsIG5hbWUgKSkgIT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiByZXQ7CgoJCQl9IGVsc2UgewoJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoIG5hbWUsIHZhbHVlICsgIiIgKTsKCQkJCXJldHVybiB2YWx1ZTsKCQkJfQoKCQl9IGVsc2UgaWYgKCBob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KCBlbGVtLCBuYW1lICkpICE9PSBudWxsICkgewoJCQlyZXR1cm4gcmV0OwoKCQl9IGVsc2UgewoJCQlyZXQgPSBqUXVlcnkuZmluZC5hdHRyKCBlbGVtLCBuYW1lICk7CgoJCQkvLyBOb24tZXhpc3RlbnQgYXR0cmlidXRlcyByZXR1cm4gbnVsbCwgd2Ugbm9ybWFsaXplIHRvIHVuZGVmaW5lZAoJCQlyZXR1cm4gcmV0ID09IG51bGwgPwoJCQkJdW5kZWZpbmVkIDoKCQkJCXJldDsKCQl9Cgl9LAoKCXJlbW92ZUF0dHI6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQl2YXIgbmFtZSwgcHJvcE5hbWUsCgkJCWkgPSAwLAoJCQlhdHRyTmFtZXMgPSB2YWx1ZSAmJiB2YWx1ZS5tYXRjaCggY29yZV9ybm90d2hpdGUgKTsKCgkJaWYgKCBhdHRyTmFtZXMgJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSApIHsKCQkJd2hpbGUgKCAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSApIHsKCQkJCXByb3BOYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoKCQkJCS8vIEJvb2xlYW4gYXR0cmlidXRlcyBnZXQgc3BlY2lhbCB0cmVhdG1lbnQgKCMxMDg3MCkKCQkJCWlmICggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC50ZXN0KCBuYW1lICkgKSB7CgkJCQkJLy8gU2V0IGNvcnJlc3BvbmRpbmcgcHJvcGVydHkgdG8gZmFsc2UKCQkJCQllbGVtWyBwcm9wTmFtZSBdID0gZmFsc2U7CgkJCQl9CgoJCQkJZWxlbS5yZW1vdmVBdHRyaWJ1dGUoIG5hbWUgKTsKCQkJfQoJCX0KCX0sCgoJYXR0ckhvb2tzOiB7CgkJdHlwZTogewoJCQlzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSApIHsKCQkJCWlmICggIWpRdWVyeS5zdXBwb3J0LnJhZGlvVmFsdWUgJiYgdmFsdWUgPT09ICJyYWRpbyIgJiYgalF1ZXJ5Lm5vZGVOYW1lKGVsZW0sICJpbnB1dCIpICkgewoJCQkJCS8vIFNldHRpbmcgdGhlIHR5cGUgb24gYSByYWRpbyBidXR0b24gYWZ0ZXIgdGhlIHZhbHVlIHJlc2V0cyB0aGUgdmFsdWUgaW4gSUU2LTkKCQkJCQkvLyBSZXNldCB2YWx1ZSB0byBkZWZhdWx0IGluIGNhc2UgdHlwZSBpcyBzZXQgYWZ0ZXIgdmFsdWUgZHVyaW5nIGNyZWF0aW9uCgkJCQkJdmFyIHZhbCA9IGVsZW0udmFsdWU7CgkJCQkJZWxlbS5zZXRBdHRyaWJ1dGUoICJ0eXBlIiwgdmFsdWUgKTsKCQkJCQlpZiAoIHZhbCApIHsKCQkJCQkJZWxlbS52YWx1ZSA9IHZhbDsKCQkJCQl9CgkJCQkJcmV0dXJuIHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfSwKCglwcm9wRml4OiB7CgkJImZvciI6ICJodG1sRm9yIiwKCQkiY2xhc3MiOiAiY2xhc3NOYW1lIgoJfSwKCglwcm9wOiBmdW5jdGlvbiggZWxlbSwgbmFtZSwgdmFsdWUgKSB7CgkJdmFyIHJldCwgaG9va3MsIG5vdHhtbCwKCQkJblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKCQkvLyBkb24ndCBnZXQvc2V0IHByb3BlcnRpZXMgb24gdGV4dCwgY29tbWVudCBhbmQgYXR0cmlidXRlIG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBuVHlwZSA9PT0gMyB8fCBuVHlwZSA9PT0gOCB8fCBuVHlwZSA9PT0gMiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJbm90eG1sID0gblR5cGUgIT09IDEgfHwgIWpRdWVyeS5pc1hNTERvYyggZWxlbSApOwoKCQlpZiAoIG5vdHhtbCApIHsKCQkJLy8gRml4IG5hbWUgYW5kIGF0dGFjaCBob29rcwoJCQluYW1lID0galF1ZXJ5LnByb3BGaXhbIG5hbWUgXSB8fCBuYW1lOwoJCQlob29rcyA9IGpRdWVyeS5wcm9wSG9va3NbIG5hbWUgXTsKCQl9CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJcmV0dXJuIGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBuYW1lICkpICE9PSB1bmRlZmluZWQgPwoJCQkJcmV0IDoKCQkJCSggZWxlbVsgbmFtZSBdID0gdmFsdWUgKTsKCgkJfSBlbHNlIHsKCQkJcmV0dXJuIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIG5hbWUgKSkgIT09IG51bGwgPwoJCQkJcmV0IDoKCQkJCWVsZW1bIG5hbWUgXTsKCQl9Cgl9LAoKCXByb3BIb29rczogewoJCXRhYkluZGV4OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gZWxlbS5oYXNBdHRyaWJ1dGUoICJ0YWJpbmRleCIgKSB8fCByZm9jdXNhYmxlLnRlc3QoIGVsZW0ubm9kZU5hbWUgKSB8fCBlbGVtLmhyZWYgPwoJCQkJCWVsZW0udGFiSW5kZXggOgoJCQkJCS0xOwoJCQl9CgkJfQoJfQp9KTsKCi8vIEhvb2tzIGZvciBib29sZWFuIGF0dHJpYnV0ZXMKYm9vbEhvb2sgPSB7CglzZXQ6IGZ1bmN0aW9uKCBlbGVtLCB2YWx1ZSwgbmFtZSApIHsKCQlpZiAoIHZhbHVlID09PSBmYWxzZSApIHsKCQkJLy8gUmVtb3ZlIGJvb2xlYW4gYXR0cmlidXRlcyB3aGVuIHNldCB0byBmYWxzZQoJCQlqUXVlcnkucmVtb3ZlQXR0ciggZWxlbSwgbmFtZSApOwoJCX0gZWxzZSB7CgkJCWVsZW0uc2V0QXR0cmlidXRlKCBuYW1lLCBuYW1lICk7CgkJfQoJCXJldHVybiBuYW1lOwoJfQp9OwpqUXVlcnkuZWFjaCggalF1ZXJ5LmV4cHIubWF0Y2guYm9vbC5zb3VyY2UubWF0Y2goIC9cdysvZyApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCXZhciBnZXR0ZXIgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsKCglqUXVlcnkuZXhwci5hdHRySGFuZGxlWyBuYW1lIF0gPSBmdW5jdGlvbiggZWxlbSwgbmFtZSwgaXNYTUwgKSB7CgkJdmFyIGZuID0galF1ZXJ5LmV4cHIuYXR0ckhhbmRsZVsgbmFtZSBdLAoJCQlyZXQgPSBpc1hNTCA/CgkJCQl1bmRlZmluZWQgOgoJCQkJLyoganNoaW50IGVxZXFlcTogZmFsc2UgKi8KCQkJCS8vIFRlbXBvcmFyaWx5IGRpc2FibGUgdGhpcyBoYW5kbGVyIHRvIGNoZWNrIGV4aXN0ZW5jZQoJCQkJKGpRdWVyeS5leHByLmF0dHJIYW5kbGVbIG5hbWUgXSA9IHVuZGVmaW5lZCkgIT0KCQkJCQlnZXR0ZXIoIGVsZW0sIG5hbWUsIGlzWE1MICkgPwoKCQkJCQluYW1lLnRvTG93ZXJDYXNlKCkgOgoJCQkJCW51bGw7CgoJCS8vIFJlc3RvcmUgaGFuZGxlcgoJCWpRdWVyeS5leHByLmF0dHJIYW5kbGVbIG5hbWUgXSA9IGZuOwoKCQlyZXR1cm4gcmV0OwoJfTsKfSk7CgovLyBTdXBwb3J0OiBJRTkrCi8vIFNlbGVjdGVkbmVzcyBmb3IgYW4gb3B0aW9uIGluIGFuIG9wdGdyb3VwIGNhbiBiZSBpbmFjY3VyYXRlCmlmICggIWpRdWVyeS5zdXBwb3J0Lm9wdFNlbGVjdGVkICkgewoJalF1ZXJ5LnByb3BIb29rcy5zZWxlY3RlZCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCQl2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwoJCQlpZiAoIHBhcmVudCAmJiBwYXJlbnQucGFyZW50Tm9kZSApIHsKCQkJCXBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CgkJCX0KCQkJcmV0dXJuIG51bGw7CgkJfQoJfTsKfQoKalF1ZXJ5LmVhY2goWwoJInRhYkluZGV4IiwKCSJyZWFkT25seSIsCgkibWF4TGVuZ3RoIiwKCSJjZWxsU3BhY2luZyIsCgkiY2VsbFBhZGRpbmciLAoJInJvd1NwYW4iLAoJImNvbFNwYW4iLAoJInVzZU1hcCIsCgkiZnJhbWVCb3JkZXIiLAoJImNvbnRlbnRFZGl0YWJsZSIKXSwgZnVuY3Rpb24oKSB7CglqUXVlcnkucHJvcEZpeFsgdGhpcy50b0xvd2VyQ2FzZSgpIF0gPSB0aGlzOwp9KTsKCi8vIFJhZGlvcyBhbmQgY2hlY2tib3hlcyBnZXR0ZXIvc2V0dGVyCmpRdWVyeS5lYWNoKFsgInJhZGlvIiwgImNoZWNrYm94IiBdLCBmdW5jdGlvbigpIHsKCWpRdWVyeS52YWxIb29rc1sgdGhpcyBdID0gewoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlICkgewoJCQlpZiAoIGpRdWVyeS5pc0FycmF5KCB2YWx1ZSApICkgewoJCQkJcmV0dXJuICggZWxlbS5jaGVja2VkID0galF1ZXJ5LmluQXJyYXkoIGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUgKSA+PSAwICk7CgkJCX0KCQl9Cgl9OwoJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2hlY2tPbiApIHsKCQlqUXVlcnkudmFsSG9va3NbIHRoaXMgXS5nZXQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQkJLy8gU3VwcG9ydDogV2Via2l0CgkJCS8vICIiIGlzIHJldHVybmVkIGluc3RlYWQgb2YgIm9uIiBpZiBhIHZhbHVlIGlzbid0IHNwZWNpZmllZAoJCQlyZXR1cm4gZWxlbS5nZXRBdHRyaWJ1dGUoInZhbHVlIikgPT09IG51bGwgPyAib24iIDogZWxlbS52YWx1ZTsKCQl9OwoJfQp9KTsKdmFyIHJrZXlFdmVudCA9IC9ea2V5LywKCXJtb3VzZUV2ZW50ID0gL14oPzptb3VzZXxjb250ZXh0bWVudSl8Y2xpY2svLAoJcmZvY3VzTW9ycGggPSAvXig/OmZvY3VzaW5mb2N1c3xmb2N1c291dGJsdXIpJC8sCglydHlwZW5hbWVzcGFjZSA9IC9eKFteLl0qKSg/OlwuKC4rKXwpJC87CgpmdW5jdGlvbiByZXR1cm5UcnVlKCkgewoJcmV0dXJuIHRydWU7Cn0KCmZ1bmN0aW9uIHJldHVybkZhbHNlKCkgewoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsKCXRyeSB7CgkJcmV0dXJuIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7Cgl9IGNhdGNoICggZXJyICkgeyB9Cn0KCi8qCiAqIEhlbHBlciBmdW5jdGlvbnMgZm9yIG1hbmFnaW5nIGV2ZW50cyAtLSBub3QgcGFydCBvZiB0aGUgcHVibGljIGludGVyZmFjZS4KICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICovCmpRdWVyeS5ldmVudCA9IHsKCglnbG9iYWw6IHt9LAoKCWFkZDogZnVuY3Rpb24oIGVsZW0sIHR5cGVzLCBoYW5kbGVyLCBkYXRhLCBzZWxlY3RvciApIHsKCgkJdmFyIGhhbmRsZU9iakluLCBldmVudEhhbmRsZSwgdG1wLAoJCQlldmVudHMsIHQsIGhhbmRsZU9iaiwKCQkJc3BlY2lhbCwgaGFuZGxlcnMsIHR5cGUsIG5hbWVzcGFjZXMsIG9yaWdUeXBlLAoJCQllbGVtRGF0YSA9IGRhdGFfcHJpdi5nZXQoIGVsZW0gKTsKCgkJLy8gRG9uJ3QgYXR0YWNoIGV2ZW50cyB0byBub0RhdGEgb3IgdGV4dC9jb21tZW50IG5vZGVzIChidXQgYWxsb3cgcGxhaW4gb2JqZWN0cykKCQlpZiAoICFlbGVtRGF0YSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGFuIG9iamVjdCBvZiBjdXN0b20gZGF0YSBpbiBsaWV1IG9mIHRoZSBoYW5kbGVyCgkJaWYgKCBoYW5kbGVyLmhhbmRsZXIgKSB7CgkJCWhhbmRsZU9iakluID0gaGFuZGxlcjsKCQkJaGFuZGxlciA9IGhhbmRsZU9iakluLmhhbmRsZXI7CgkJCXNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CgkJfQoKCQkvLyBNYWtlIHN1cmUgdGhhdCB0aGUgaGFuZGxlciBoYXMgYSB1bmlxdWUgSUQsIHVzZWQgdG8gZmluZC9yZW1vdmUgaXQgbGF0ZXIKCQlpZiAoICFoYW5kbGVyLmd1aWQgKSB7CgkJCWhhbmRsZXIuZ3VpZCA9IGpRdWVyeS5ndWlkKys7CgkJfQoKCQkvLyBJbml0IHRoZSBlbGVtZW50J3MgZXZlbnQgc3RydWN0dXJlIGFuZCBtYWluIGhhbmRsZXIsIGlmIHRoaXMgaXMgdGhlIGZpcnN0CgkJaWYgKCAhKGV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cykgKSB7CgkJCWV2ZW50cyA9IGVsZW1EYXRhLmV2ZW50cyA9IHt9OwoJCX0KCQlpZiAoICEoZXZlbnRIYW5kbGUgPSBlbGVtRGF0YS5oYW5kbGUpICkgewoJCQlldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uKCBlICkgewoJCQkJLy8gRGlzY2FyZCB0aGUgc2Vjb25kIGV2ZW50IG9mIGEgalF1ZXJ5LmV2ZW50LnRyaWdnZXIoKSBhbmQKCQkJCS8vIHdoZW4gYW4gZXZlbnQgaXMgY2FsbGVkIGFmdGVyIGEgcGFnZSBoYXMgdW5sb2FkZWQKCQkJCXJldHVybiB0eXBlb2YgalF1ZXJ5ICE9PSBjb3JlX3N0cnVuZGVmaW5lZCAmJiAoIWUgfHwgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCAhPT0gZS50eXBlKSA/CgkJCQkJalF1ZXJ5LmV2ZW50LmRpc3BhdGNoLmFwcGx5KCBldmVudEhhbmRsZS5lbGVtLCBhcmd1bWVudHMgKSA6CgkJCQkJdW5kZWZpbmVkOwoJCQl9OwoJCQkvLyBBZGQgZWxlbSBhcyBhIHByb3BlcnR5IG9mIHRoZSBoYW5kbGUgZm4gdG8gcHJldmVudCBhIG1lbW9yeSBsZWFrIHdpdGggSUUgbm9uLW5hdGl2ZSBldmVudHMKCQkJZXZlbnRIYW5kbGUuZWxlbSA9IGVsZW07CgkJfQoKCQkvLyBIYW5kbGUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBhIHNwYWNlCgkJdHlwZXMgPSAoIHR5cGVzIHx8ICIiICkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgWyIiXTsKCQl0ID0gdHlwZXMubGVuZ3RoOwoJCXdoaWxlICggdC0tICkgewoJCQl0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKCB0eXBlc1t0XSApIHx8IFtdOwoJCQl0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CgkJCW5hbWVzcGFjZXMgPSAoIHRtcFsyXSB8fCAiIiApLnNwbGl0KCAiLiIgKS5zb3J0KCk7CgoJCQkvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKCQkJaWYgKCAhdHlwZSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQkvLyBJZiBldmVudCBjaGFuZ2VzIGl0cyB0eXBlLCB1c2UgdGhlIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBjaGFuZ2VkIHR5cGUKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgoJCQkvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoKCQkJLy8gVXBkYXRlIHNwZWNpYWwgYmFzZWQgb24gbmV3bHkgcmVzZXQgdHlwZQoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCgkJCS8vIGhhbmRsZU9iaiBpcyBwYXNzZWQgdG8gYWxsIGV2ZW50IGhhbmRsZXJzCgkJCWhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewoJCQkJdHlwZTogdHlwZSwKCQkJCW9yaWdUeXBlOiBvcmlnVHlwZSwKCQkJCWRhdGE6IGRhdGEsCgkJCQloYW5kbGVyOiBoYW5kbGVyLAoJCQkJZ3VpZDogaGFuZGxlci5ndWlkLAoJCQkJc2VsZWN0b3I6IHNlbGVjdG9yLAoJCQkJbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdCggc2VsZWN0b3IgKSwKCQkJCW5hbWVzcGFjZTogbmFtZXNwYWNlcy5qb2luKCIuIikKCQkJfSwgaGFuZGxlT2JqSW4gKTsKCgkJCS8vIEluaXQgdGhlIGV2ZW50IGhhbmRsZXIgcXVldWUgaWYgd2UncmUgdGhlIGZpcnN0CgkJCWlmICggIShoYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdKSApIHsKCQkJCWhhbmRsZXJzID0gZXZlbnRzWyB0eXBlIF0gPSBbXTsKCQkJCWhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKCQkJCS8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQoJCQkJaWYgKCAhc3BlY2lhbC5zZXR1cCB8fCBzcGVjaWFsLnNldHVwLmNhbGwoIGVsZW0sIGRhdGEsIG5hbWVzcGFjZXMsIGV2ZW50SGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCQkJCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGV2ZW50SGFuZGxlLCBmYWxzZSApOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJaWYgKCBzcGVjaWFsLmFkZCApIHsKCQkJCXNwZWNpYWwuYWRkLmNhbGwoIGVsZW0sIGhhbmRsZU9iaiApOwoKCQkJCWlmICggIWhhbmRsZU9iai5oYW5kbGVyLmd1aWQgKSB7CgkJCQkJaGFuZGxlT2JqLmhhbmRsZXIuZ3VpZCA9IGhhbmRsZXIuZ3VpZDsKCQkJCX0KCQkJfQoKCQkJLy8gQWRkIHRvIHRoZSBlbGVtZW50J3MgaGFuZGxlciBsaXN0LCBkZWxlZ2F0ZXMgaW4gZnJvbnQKCQkJaWYgKCBzZWxlY3RvciApIHsKCQkJCWhhbmRsZXJzLnNwbGljZSggaGFuZGxlcnMuZGVsZWdhdGVDb3VudCsrLCAwLCBoYW5kbGVPYmogKTsKCQkJfSBlbHNlIHsKCQkJCWhhbmRsZXJzLnB1c2goIGhhbmRsZU9iaiApOwoJCQl9CgoJCQkvLyBLZWVwIHRyYWNrIG9mIHdoaWNoIGV2ZW50cyBoYXZlIGV2ZXIgYmVlbiB1c2VkLCBmb3IgZXZlbnQgb3B0aW1pemF0aW9uCgkJCWpRdWVyeS5ldmVudC5nbG9iYWxbIHR5cGUgXSA9IHRydWU7CgkJfQoKCQkvLyBOdWxsaWZ5IGVsZW0gdG8gcHJldmVudCBtZW1vcnkgbGVha3MgaW4gSUUKCQllbGVtID0gbnVsbDsKCX0sCgoJLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CglyZW1vdmU6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzICkgewoKCQl2YXIgaiwgb3JpZ0NvdW50LCB0bXAsCgkJCWV2ZW50cywgdCwgaGFuZGxlT2JqLAoJCQlzcGVjaWFsLCBoYW5kbGVycywgdHlwZSwgbmFtZXNwYWNlcywgb3JpZ1R5cGUsCgkJCWVsZW1EYXRhID0gZGF0YV9wcml2Lmhhc0RhdGEoIGVsZW0gKSAmJiBkYXRhX3ByaXYuZ2V0KCBlbGVtICk7CgoJCWlmICggIWVsZW1EYXRhIHx8ICEoZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gT25jZSBmb3IgZWFjaCB0eXBlLm5hbWVzcGFjZSBpbiB0eXBlczsgdHlwZSBtYXkgYmUgb21pdHRlZAoJCXR5cGVzID0gKCB0eXBlcyB8fCAiIiApLm1hdGNoKCBjb3JlX3Jub3R3aGl0ZSApIHx8IFsiIl07CgkJdCA9IHR5cGVzLmxlbmd0aDsKCQl3aGlsZSAoIHQtLSApIHsKCQkJdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyggdHlwZXNbdF0gKSB8fCBbXTsKCQkJdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwoJCQluYW1lc3BhY2VzID0gKCB0bXBbMl0gfHwgIiIgKS5zcGxpdCggIi4iICkuc29ydCgpOwoKCQkJLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CgkJCWlmICggIXR5cGUgKSB7CgkJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICsgdHlwZXNbIHQgXSwgaGFuZGxlciwgc2VsZWN0b3IsIHRydWUgKTsKCQkJCX0KCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbIHR5cGUgXSB8fCB7fTsKCQkJdHlwZSA9ICggc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUgKSB8fCB0eXBlOwoJCQloYW5kbGVycyA9IGV2ZW50c1sgdHlwZSBdIHx8IFtdOwoJCQl0bXAgPSB0bXBbMl0gJiYgbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKTsKCgkJCS8vIFJlbW92ZSBtYXRjaGluZyBldmVudHMKCQkJb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQloYW5kbGVPYmogPSBoYW5kbGVyc1sgaiBdOwoKCQkJCWlmICggKCBtYXBwZWRUeXBlcyB8fCBvcmlnVHlwZSA9PT0gaGFuZGxlT2JqLm9yaWdUeXBlICkgJiYKCQkJCQkoICFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQgKSAmJgoJCQkJCSggIXRtcCB8fCB0bXAudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgJiYKCQkJCQkoICFzZWxlY3RvciB8fCBzZWxlY3RvciA9PT0gaGFuZGxlT2JqLnNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSAiKioiICYmIGhhbmRsZU9iai5zZWxlY3RvciApICkgewoJCQkJCWhhbmRsZXJzLnNwbGljZSggaiwgMSApOwoKCQkJCQlpZiAoIGhhbmRsZU9iai5zZWxlY3RvciApIHsKCQkJCQkJaGFuZGxlcnMuZGVsZWdhdGVDb3VudC0tOwoJCQkJCX0KCQkJCQlpZiAoIHNwZWNpYWwucmVtb3ZlICkgewoJCQkJCQlzcGVjaWFsLnJlbW92ZS5jYWxsKCBlbGVtLCBoYW5kbGVPYmogKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIFJlbW92ZSBnZW5lcmljIGV2ZW50IGhhbmRsZXIgaWYgd2UgcmVtb3ZlZCBzb21ldGhpbmcgYW5kIG5vIG1vcmUgaGFuZGxlcnMgZXhpc3QKCQkJLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCgkJCWlmICggb3JpZ0NvdW50ICYmICFoYW5kbGVycy5sZW5ndGggKSB7CgkJCQlpZiAoICFzcGVjaWFsLnRlYXJkb3duIHx8IHNwZWNpYWwudGVhcmRvd24uY2FsbCggZWxlbSwgbmFtZXNwYWNlcywgZWxlbURhdGEuaGFuZGxlICkgPT09IGZhbHNlICkgewoJCQkJCWpRdWVyeS5yZW1vdmVFdmVudCggZWxlbSwgdHlwZSwgZWxlbURhdGEuaGFuZGxlICk7CgkJCQl9CgoJCQkJZGVsZXRlIGV2ZW50c1sgdHlwZSBdOwoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgdGhlIGV4cGFuZG8gaWYgaXQncyBubyBsb25nZXIgdXNlZAoJCWlmICggalF1ZXJ5LmlzRW1wdHlPYmplY3QoIGV2ZW50cyApICkgewoJCQlkZWxldGUgZWxlbURhdGEuaGFuZGxlOwoJCQlkYXRhX3ByaXYucmVtb3ZlKCBlbGVtLCAiZXZlbnRzIiApOwoJCX0KCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIGV2ZW50LCBkYXRhLCBlbGVtLCBvbmx5SGFuZGxlcnMgKSB7CgoJCXZhciBpLCBjdXIsIHRtcCwgYnViYmxlVHlwZSwgb250eXBlLCBoYW5kbGUsIHNwZWNpYWwsCgkJCWV2ZW50UGF0aCA9IFsgZWxlbSB8fCBkb2N1bWVudCBdLAoJCQl0eXBlID0gY29yZV9oYXNPd24uY2FsbCggZXZlbnQsICJ0eXBlIiApID8gZXZlbnQudHlwZSA6IGV2ZW50LAoJCQluYW1lc3BhY2VzID0gY29yZV9oYXNPd24uY2FsbCggZXZlbnQsICJuYW1lc3BhY2UiICkgPyBldmVudC5uYW1lc3BhY2Uuc3BsaXQoIi4iKSA6IFtdOwoKCQljdXIgPSB0bXAgPSBlbGVtID0gZWxlbSB8fCBkb2N1bWVudDsKCgkJLy8gRG9uJ3QgZG8gZXZlbnRzIG9uIHRleHQgYW5kIGNvbW1lbnQgbm9kZXMKCQlpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gOCApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gZm9jdXMvYmx1ciBtb3JwaHMgdG8gZm9jdXNpbi9vdXQ7IGVuc3VyZSB3ZSdyZSBub3QgZmlyaW5nIHRoZW0gcmlnaHQgbm93CgkJaWYgKCByZm9jdXNNb3JwaC50ZXN0KCB0eXBlICsgalF1ZXJ5LmV2ZW50LnRyaWdnZXJlZCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHR5cGUuaW5kZXhPZigiLiIpID49IDAgKSB7CgkJCS8vIE5hbWVzcGFjZWQgdHJpZ2dlcjsgY3JlYXRlIGEgcmVnZXhwIHRvIG1hdGNoIGV2ZW50IHR5cGUgaW4gaGFuZGxlKCkKCQkJbmFtZXNwYWNlcyA9IHR5cGUuc3BsaXQoIi4iKTsKCQkJdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKCQkJbmFtZXNwYWNlcy5zb3J0KCk7CgkJfQoJCW9udHlwZSA9IHR5cGUuaW5kZXhPZigiOiIpIDwgMCAmJiAib24iICsgdHlwZTsKCgkJLy8gQ2FsbGVyIGNhbiBwYXNzIGluIGEgalF1ZXJ5LkV2ZW50IG9iamVjdCwgT2JqZWN0LCBvciBqdXN0IGFuIGV2ZW50IHR5cGUgc3RyaW5nCgkJZXZlbnQgPSBldmVudFsgalF1ZXJ5LmV4cGFuZG8gXSA/CgkJCWV2ZW50IDoKCQkJbmV3IGpRdWVyeS5FdmVudCggdHlwZSwgdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiAmJiBldmVudCApOwoKCQkvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCgkJZXZlbnQuaXNUcmlnZ2VyID0gb25seUhhbmRsZXJzID8gMiA6IDM7CgkJZXZlbnQubmFtZXNwYWNlID0gbmFtZXNwYWNlcy5qb2luKCIuIik7CgkJZXZlbnQubmFtZXNwYWNlX3JlID0gZXZlbnQubmFtZXNwYWNlID8KCQkJbmV3IFJlZ0V4cCggIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIgKSA6CgkJCW51bGw7CgoJCS8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAoJCWV2ZW50LnJlc3VsdCA9IHVuZGVmaW5lZDsKCQlpZiAoICFldmVudC50YXJnZXQgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGVsZW07CgkJfQoKCQkvLyBDbG9uZSBhbnkgaW5jb21pbmcgZGF0YSBhbmQgcHJlcGVuZCB0aGUgZXZlbnQsIGNyZWF0aW5nIHRoZSBoYW5kbGVyIGFyZyBsaXN0CgkJZGF0YSA9IGRhdGEgPT0gbnVsbCA/CgkJCVsgZXZlbnQgXSA6CgkJCWpRdWVyeS5tYWtlQXJyYXkoIGRhdGEsIFsgZXZlbnQgXSApOwoKCQkvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCgkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyB0eXBlIF0gfHwge307CgkJaWYgKCAhb25seUhhbmRsZXJzICYmIHNwZWNpYWwudHJpZ2dlciAmJiBzcGVjaWFsLnRyaWdnZXIuYXBwbHkoIGVsZW0sIGRhdGEgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKCM5OTUxKQoJCS8vIEJ1YmJsZSB1cCB0byBkb2N1bWVudCwgdGhlbiB0byB3aW5kb3c7IHdhdGNoIGZvciBhIGdsb2JhbCBvd25lckRvY3VtZW50IHZhciAoIzk3MjQpCgkJaWYgKCAhb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSApIHsKCgkJCWJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwoJCQlpZiAoICFyZm9jdXNNb3JwaC50ZXN0KCBidWJibGVUeXBlICsgdHlwZSApICkgewoJCQkJY3VyID0gY3VyLnBhcmVudE5vZGU7CgkJCX0KCQkJZm9yICggOyBjdXI7IGN1ciA9IGN1ci5wYXJlbnROb2RlICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIGN1ciApOwoJCQkJdG1wID0gY3VyOwoJCQl9CgoJCQkvLyBPbmx5IGFkZCB3aW5kb3cgaWYgd2UgZ290IHRvIGRvY3VtZW50IChlLmcuLCBub3QgcGxhaW4gb2JqIG9yIGRldGFjaGVkIERPTSkKCQkJaWYgKCB0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpICkgewoJCQkJZXZlbnRQYXRoLnB1c2goIHRtcC5kZWZhdWx0VmlldyB8fCB0bXAucGFyZW50V2luZG93IHx8IHdpbmRvdyApOwoJCQl9CgkJfQoKCQkvLyBGaXJlIGhhbmRsZXJzIG9uIHRoZSBldmVudCBwYXRoCgkJaSA9IDA7CgkJd2hpbGUgKCAoY3VyID0gZXZlbnRQYXRoW2krK10pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoKCQkJZXZlbnQudHlwZSA9IGkgPiAxID8KCQkJCWJ1YmJsZVR5cGUgOgoJCQkJc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOwoKCQkJLy8galF1ZXJ5IGhhbmRsZXIKCQkJaGFuZGxlID0gKCBkYXRhX3ByaXYuZ2V0KCBjdXIsICJldmVudHMiICkgfHwge30gKVsgZXZlbnQudHlwZSBdICYmIGRhdGFfcHJpdi5nZXQoIGN1ciwgImhhbmRsZSIgKTsKCQkJaWYgKCBoYW5kbGUgKSB7CgkJCQloYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApOwoJCQl9CgoJCQkvLyBOYXRpdmUgaGFuZGxlcgoJCQloYW5kbGUgPSBvbnR5cGUgJiYgY3VyWyBvbnR5cGUgXTsKCQkJaWYgKCBoYW5kbGUgJiYgalF1ZXJ5LmFjY2VwdERhdGEoIGN1ciApICYmIGhhbmRsZS5hcHBseSAmJiBoYW5kbGUuYXBwbHkoIGN1ciwgZGF0YSApID09PSBmYWxzZSApIHsKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0KCQl9CgkJZXZlbnQudHlwZSA9IHR5cGU7CgoJCS8vIElmIG5vYm9keSBwcmV2ZW50ZWQgdGhlIGRlZmF1bHQgYWN0aW9uLCBkbyBpdCBub3cKCQlpZiAoICFvbmx5SGFuZGxlcnMgJiYgIWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoKCQkJaWYgKCAoIXNwZWNpYWwuX2RlZmF1bHQgfHwgc3BlY2lhbC5fZGVmYXVsdC5hcHBseSggZXZlbnRQYXRoLnBvcCgpLCBkYXRhICkgPT09IGZhbHNlKSAmJgoJCQkJalF1ZXJ5LmFjY2VwdERhdGEoIGVsZW0gKSApIHsKCgkJCQkvLyBDYWxsIGEgbmF0aXZlIERPTSBtZXRob2Qgb24gdGhlIHRhcmdldCB3aXRoIHRoZSBzYW1lIG5hbWUgbmFtZSBhcyB0aGUgZXZlbnQuCgkJCQkvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAoIzYxNzApCgkJCQlpZiAoIG9udHlwZSAmJiBqUXVlcnkuaXNGdW5jdGlvbiggZWxlbVsgdHlwZSBdICkgJiYgIWpRdWVyeS5pc1dpbmRvdyggZWxlbSApICkgewoKCQkJCQkvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCgkJCQkJdG1wID0gZWxlbVsgb250eXBlIF07CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IG51bGw7CgkJCQkJfQoKCQkJCQkvLyBQcmV2ZW50IHJlLXRyaWdnZXJpbmcgb2YgdGhlIHNhbWUgZXZlbnQsIHNpbmNlIHdlIGFscmVhZHkgYnViYmxlZCBpdCBhYm92ZQoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwoJCQkJCWVsZW1bIHR5cGUgXSgpOwoJCQkJCWpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB1bmRlZmluZWQ7CgoJCQkJCWlmICggdG1wICkgewoJCQkJCQllbGVtWyBvbnR5cGUgXSA9IHRtcDsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBldmVudC5yZXN1bHQ7Cgl9LAoKCWRpc3BhdGNoOiBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCS8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAoJCWV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeCggZXZlbnQgKTsKCgkJdmFyIGksIGosIHJldCwgbWF0Y2hlZCwgaGFuZGxlT2JqLAoJCQloYW5kbGVyUXVldWUgPSBbXSwKCQkJYXJncyA9IGNvcmVfc2xpY2UuY2FsbCggYXJndW1lbnRzICksCgkJCWhhbmRsZXJzID0gKCBkYXRhX3ByaXYuZ2V0KCB0aGlzLCAiZXZlbnRzIiApIHx8IHt9IClbIGV2ZW50LnR5cGUgXSB8fCBbXSwKCQkJc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsWyBldmVudC50eXBlIF0gfHwge307CgoJCS8vIFVzZSB0aGUgZml4LWVkIGpRdWVyeS5FdmVudCByYXRoZXIgdGhhbiB0aGUgKHJlYWQtb25seSkgbmF0aXZlIGV2ZW50CgkJYXJnc1swXSA9IGV2ZW50OwoJCWV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCgkJLy8gQ2FsbCB0aGUgcHJlRGlzcGF0Y2ggaG9vayBmb3IgdGhlIG1hcHBlZCB0eXBlLCBhbmQgbGV0IGl0IGJhaWwgaWYgZGVzaXJlZAoJCWlmICggc3BlY2lhbC5wcmVEaXNwYXRjaCAmJiBzcGVjaWFsLnByZURpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBEZXRlcm1pbmUgaGFuZGxlcnMKCQloYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCggdGhpcywgZXZlbnQsIGhhbmRsZXJzICk7CgoJCS8vIFJ1biBkZWxlZ2F0ZXMgZmlyc3Q7IHRoZXkgbWF5IHdhbnQgdG8gc3RvcCBwcm9wYWdhdGlvbiBiZW5lYXRoIHVzCgkJaSA9IDA7CgkJd2hpbGUgKCAobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVsgaSsrIF0pICYmICFldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpICkgewoJCQlldmVudC5jdXJyZW50VGFyZ2V0ID0gbWF0Y2hlZC5lbGVtOwoKCQkJaiA9IDA7CgkJCXdoaWxlICggKGhhbmRsZU9iaiA9IG1hdGNoZWQuaGFuZGxlcnNbIGorKyBdKSAmJiAhZXZlbnQuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCgkJCQkvLyBUcmlnZ2VyZWQgZXZlbnQgbXVzdCBlaXRoZXIgMSkgaGF2ZSBubyBuYW1lc3BhY2UsIG9yCgkJCQkvLyAyKSBoYXZlIG5hbWVzcGFjZShzKSBhIHN1YnNldCBvciBlcXVhbCB0byB0aG9zZSBpbiB0aGUgYm91bmQgZXZlbnQgKGJvdGggY2FuIGhhdmUgbm8gbmFtZXNwYWNlKS4KCQkJCWlmICggIWV2ZW50Lm5hbWVzcGFjZV9yZSB8fCBldmVudC5uYW1lc3BhY2VfcmUudGVzdCggaGFuZGxlT2JqLm5hbWVzcGFjZSApICkgewoKCQkJCQlldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CgkJCQkJZXZlbnQuZGF0YSA9IGhhbmRsZU9iai5kYXRhOwoKCQkJCQlyZXQgPSAoIChqUXVlcnkuZXZlbnQuc3BlY2lhbFsgaGFuZGxlT2JqLm9yaWdUeXBlIF0gfHwge30pLmhhbmRsZSB8fCBoYW5kbGVPYmouaGFuZGxlciApCgkJCQkJCQkuYXBwbHkoIG1hdGNoZWQuZWxlbSwgYXJncyApOwoKCQkJCQlpZiAoIHJldCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCQlpZiAoIChldmVudC5yZXN1bHQgPSByZXQpID09PSBmYWxzZSApIHsKCQkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJLy8gQ2FsbCB0aGUgcG9zdERpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZQoJCWlmICggc3BlY2lhbC5wb3N0RGlzcGF0Y2ggKSB7CgkJCXNwZWNpYWwucG9zdERpc3BhdGNoLmNhbGwoIHRoaXMsIGV2ZW50ICk7CgkJfQoKCQlyZXR1cm4gZXZlbnQucmVzdWx0OwoJfSwKCgloYW5kbGVyczogZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVycyApIHsKCQl2YXIgaSwgbWF0Y2hlcywgc2VsLCBoYW5kbGVPYmosCgkJCWhhbmRsZXJRdWV1ZSA9IFtdLAoJCQlkZWxlZ2F0ZUNvdW50ID0gaGFuZGxlcnMuZGVsZWdhdGVDb3VudCwKCQkJY3VyID0gZXZlbnQudGFyZ2V0OwoKCQkvLyBGaW5kIGRlbGVnYXRlIGhhbmRsZXJzCgkJLy8gQmxhY2staG9sZSBTVkcgPHVzZT4gaW5zdGFuY2UgdHJlZXMgKCMxMzE4MCkKCQkvLyBBdm9pZCBub24tbGVmdC1jbGljayBidWJibGluZyBpbiBGaXJlZm94ICgjMzg2MSkKCQlpZiAoIGRlbGVnYXRlQ291bnQgJiYgY3VyLm5vZGVUeXBlICYmICghZXZlbnQuYnV0dG9uIHx8IGV2ZW50LnR5cGUgIT09ICJjbGljayIpICkgewoKCQkJZm9yICggOyBjdXIgIT09IHRoaXM7IGN1ciA9IGN1ci5wYXJlbnROb2RlIHx8IHRoaXMgKSB7CgoJCQkJLy8gRG9uJ3QgcHJvY2VzcyBjbGlja3Mgb24gZGlzYWJsZWQgZWxlbWVudHMgKCM2OTExLCAjODE2NSwgIzExMzgyLCAjMTE3NjQpCgkJCQlpZiAoIGN1ci5kaXNhYmxlZCAhPT0gdHJ1ZSB8fCBldmVudC50eXBlICE9PSAiY2xpY2siICkgewoJCQkJCW1hdGNoZXMgPSBbXTsKCQkJCQlmb3IgKCBpID0gMDsgaSA8IGRlbGVnYXRlQ291bnQ7IGkrKyApIHsKCQkJCQkJaGFuZGxlT2JqID0gaGFuZGxlcnNbIGkgXTsKCgkJCQkJCS8vIERvbid0IGNvbmZsaWN0IHdpdGggT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzICgjMTMyMDMpCgkJCQkJCXNlbCA9IGhhbmRsZU9iai5zZWxlY3RvciArICIgIjsKCgkJCQkJCWlmICggbWF0Y2hlc1sgc2VsIF0gPT09IHVuZGVmaW5lZCApIHsKCQkJCQkJCW1hdGNoZXNbIHNlbCBdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/CgkJCQkJCQkJalF1ZXJ5KCBzZWwsIHRoaXMgKS5pbmRleCggY3VyICkgPj0gMCA6CgkJCQkJCQkJalF1ZXJ5LmZpbmQoIHNlbCwgdGhpcywgbnVsbCwgWyBjdXIgXSApLmxlbmd0aDsKCQkJCQkJfQoJCQkJCQlpZiAoIG1hdGNoZXNbIHNlbCBdICkgewoJCQkJCQkJbWF0Y2hlcy5wdXNoKCBoYW5kbGVPYmogKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAoIG1hdGNoZXMubGVuZ3RoICkgewoJCQkJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IGN1ciwgaGFuZGxlcnM6IG1hdGNoZXMgfSk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBBZGQgdGhlIHJlbWFpbmluZyAoZGlyZWN0bHktYm91bmQpIGhhbmRsZXJzCgkJaWYgKCBkZWxlZ2F0ZUNvdW50IDwgaGFuZGxlcnMubGVuZ3RoICkgewoJCQloYW5kbGVyUXVldWUucHVzaCh7IGVsZW06IHRoaXMsIGhhbmRsZXJzOiBoYW5kbGVycy5zbGljZSggZGVsZWdhdGVDb3VudCApIH0pOwoJCX0KCgkJcmV0dXJuIGhhbmRsZXJRdWV1ZTsKCX0sCgoJLy8gSW5jbHVkZXMgc29tZSBldmVudCBwcm9wcyBzaGFyZWQgYnkgS2V5RXZlbnQgYW5kIE1vdXNlRXZlbnQKCXByb3BzOiAiYWx0S2V5IGJ1YmJsZXMgY2FuY2VsYWJsZSBjdHJsS2V5IGN1cnJlbnRUYXJnZXQgZXZlbnRQaGFzZSBtZXRhS2V5IHJlbGF0ZWRUYXJnZXQgc2hpZnRLZXkgdGFyZ2V0IHRpbWVTdGFtcCB2aWV3IHdoaWNoIi5zcGxpdCgiICIpLAoKCWZpeEhvb2tzOiB7fSwKCglrZXlIb29rczogewoJCXByb3BzOiAiY2hhciBjaGFyQ29kZSBrZXkga2V5Q29kZSIuc3BsaXQoIiAiKSwKCQlmaWx0ZXI6IGZ1bmN0aW9uKCBldmVudCwgb3JpZ2luYWwgKSB7CgoJCQkvLyBBZGQgd2hpY2ggZm9yIGtleSBldmVudHMKCQkJaWYgKCBldmVudC53aGljaCA9PSBudWxsICkgewoJCQkJZXZlbnQud2hpY2ggPSBvcmlnaW5hbC5jaGFyQ29kZSAhPSBudWxsID8gb3JpZ2luYWwuY2hhckNvZGUgOiBvcmlnaW5hbC5rZXlDb2RlOwoJCQl9CgoJCQlyZXR1cm4gZXZlbnQ7CgkJfQoJfSwKCgltb3VzZUhvb2tzOiB7CgkJcHJvcHM6ICJidXR0b24gYnV0dG9ucyBjbGllbnRYIGNsaWVudFkgb2Zmc2V0WCBvZmZzZXRZIHBhZ2VYIHBhZ2VZIHNjcmVlblggc2NyZWVuWSB0b0VsZW1lbnQiLnNwbGl0KCIgIiksCgkJZmlsdGVyOiBmdW5jdGlvbiggZXZlbnQsIG9yaWdpbmFsICkgewoJCQl2YXIgZXZlbnREb2MsIGRvYywgYm9keSwKCQkJCWJ1dHRvbiA9IG9yaWdpbmFsLmJ1dHRvbjsKCgkJCS8vIENhbGN1bGF0ZSBwYWdlWC9ZIGlmIG1pc3NpbmcgYW5kIGNsaWVudFgvWSBhdmFpbGFibGUKCQkJaWYgKCBldmVudC5wYWdlWCA9PSBudWxsICYmIG9yaWdpbmFsLmNsaWVudFggIT0gbnVsbCApIHsKCQkJCWV2ZW50RG9jID0gZXZlbnQudGFyZ2V0Lm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CgkJCQlkb2MgPSBldmVudERvYy5kb2N1bWVudEVsZW1lbnQ7CgkJCQlib2R5ID0gZXZlbnREb2MuYm9keTsKCgkJCQlldmVudC5wYWdlWCA9IG9yaWdpbmFsLmNsaWVudFggKyAoIGRvYyAmJiBkb2Muc2Nyb2xsTGVmdCB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsTGVmdCB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50TGVmdCB8fCBib2R5ICYmIGJvZHkuY2xpZW50TGVmdCB8fCAwICk7CgkJCQlldmVudC5wYWdlWSA9IG9yaWdpbmFsLmNsaWVudFkgKyAoIGRvYyAmJiBkb2Muc2Nyb2xsVG9wICB8fCBib2R5ICYmIGJvZHkuc2Nyb2xsVG9wICB8fCAwICkgLSAoIGRvYyAmJiBkb2MuY2xpZW50VG9wICB8fCBib2R5ICYmIGJvZHkuY2xpZW50VG9wICB8fCAwICk7CgkJCX0KCgkJCS8vIEFkZCB3aGljaCBmb3IgY2xpY2s6IDEgPT09IGxlZnQ7IDIgPT09IG1pZGRsZTsgMyA9PT0gcmlnaHQKCQkJLy8gTm90ZTogYnV0dG9uIGlzIG5vdCBub3JtYWxpemVkLCBzbyBkb24ndCB1c2UgaXQKCQkJaWYgKCAhZXZlbnQud2hpY2ggJiYgYnV0dG9uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlldmVudC53aGljaCA9ICggYnV0dG9uICYgMSA/IDEgOiAoIGJ1dHRvbiAmIDIgPyAzIDogKCBidXR0b24gJiA0ID8gMiA6IDAgKSApICk7CgkJCX0KCgkJCXJldHVybiBldmVudDsKCQl9Cgl9LAoKCWZpeDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggZXZlbnRbIGpRdWVyeS5leHBhbmRvIF0gKSB7CgkJCXJldHVybiBldmVudDsKCQl9CgoJCS8vIENyZWF0ZSBhIHdyaXRhYmxlIGNvcHkgb2YgdGhlIGV2ZW50IG9iamVjdCBhbmQgbm9ybWFsaXplIHNvbWUgcHJvcGVydGllcwoJCXZhciBpLCBwcm9wLCBjb3B5LAoJCQl0eXBlID0gZXZlbnQudHlwZSwKCQkJb3JpZ2luYWxFdmVudCA9IGV2ZW50LAoJCQlmaXhIb29rID0gdGhpcy5maXhIb29rc1sgdHlwZSBdOwoKCQlpZiAoICFmaXhIb29rICkgewoJCQl0aGlzLmZpeEhvb2tzWyB0eXBlIF0gPSBmaXhIb29rID0KCQkJCXJtb3VzZUV2ZW50LnRlc3QoIHR5cGUgKSA/IHRoaXMubW91c2VIb29rcyA6CgkJCQlya2V5RXZlbnQudGVzdCggdHlwZSApID8gdGhpcy5rZXlIb29rcyA6CgkJCQl7fTsKCQl9CgkJY29weSA9IGZpeEhvb2sucHJvcHMgPyB0aGlzLnByb3BzLmNvbmNhdCggZml4SG9vay5wcm9wcyApIDogdGhpcy5wcm9wczsKCgkJZXZlbnQgPSBuZXcgalF1ZXJ5LkV2ZW50KCBvcmlnaW5hbEV2ZW50ICk7CgoJCWkgPSBjb3B5Lmxlbmd0aDsKCQl3aGlsZSAoIGktLSApIHsKCQkJcHJvcCA9IGNvcHlbIGkgXTsKCQkJZXZlbnRbIHByb3AgXSA9IG9yaWdpbmFsRXZlbnRbIHByb3AgXTsKCQl9CgoJCS8vIFN1cHBvcnQ6IENvcmRvdmEgMi41IChXZWJLaXQpICgjMTMyNTUpCgkJLy8gQWxsIGV2ZW50cyBzaG91bGQgaGF2ZSBhIHRhcmdldDsgQ29yZG92YSBkZXZpY2VyZWFkeSBkb2Vzbid0CgkJaWYgKCAhZXZlbnQudGFyZ2V0ICkgewoJCQlldmVudC50YXJnZXQgPSBkb2N1bWVudDsKCQl9CgoJCS8vIFN1cHBvcnQ6IFNhZmFyaSA2LjArLCBDaHJvbWUgPCAyOAoJCS8vIFRhcmdldCBzaG91bGQgbm90IGJlIGEgdGV4dCBub2RlICgjNTA0LCAjMTMxNDMpCgkJaWYgKCBldmVudC50YXJnZXQubm9kZVR5cGUgPT09IDMgKSB7CgkJCWV2ZW50LnRhcmdldCA9IGV2ZW50LnRhcmdldC5wYXJlbnROb2RlOwoJCX0KCgkJcmV0dXJuIGZpeEhvb2suZmlsdGVyPyBmaXhIb29rLmZpbHRlciggZXZlbnQsIG9yaWdpbmFsRXZlbnQgKSA6IGV2ZW50OwoJfSwKCglzcGVjaWFsOiB7CgkJbG9hZDogewoJCQkvLyBQcmV2ZW50IHRyaWdnZXJlZCBpbWFnZS5sb2FkIGV2ZW50cyBmcm9tIGJ1YmJsaW5nIHRvIHdpbmRvdy5sb2FkCgkJCW5vQnViYmxlOiB0cnVlCgkJfSwKCQlmb2N1czogewoJCQkvLyBGaXJlIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKCQkJdHJpZ2dlcjogZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHRoaXMgIT09IHNhZmVBY3RpdmVFbGVtZW50KCkgJiYgdGhpcy5mb2N1cyApIHsKCQkJCQl0aGlzLmZvY3VzKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c2luIgoJCX0sCgkJYmx1cjogewoJCQl0cmlnZ2VyOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcyA9PT0gc2FmZUFjdGl2ZUVsZW1lbnQoKSAmJiB0aGlzLmJsdXIgKSB7CgkJCQkJdGhpcy5ibHVyKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoJCQlkZWxlZ2F0ZVR5cGU6ICJmb2N1c291dCIKCQl9LAoJCWNsaWNrOiB7CgkJCS8vIEZvciBjaGVja2JveCwgZmlyZSBuYXRpdmUgZXZlbnQgc28gY2hlY2tlZCBzdGF0ZSB3aWxsIGJlIHJpZ2h0CgkJCXRyaWdnZXI6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCB0aGlzLnR5cGUgPT09ICJjaGVja2JveCIgJiYgdGhpcy5jbGljayAmJiBqUXVlcnkubm9kZU5hbWUoIHRoaXMsICJpbnB1dCIgKSApIHsKCQkJCQl0aGlzLmNsaWNrKCk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9LAoKCQkJLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIGRvbid0IGZpcmUgbmF0aXZlIC5jbGljaygpIG9uIGxpbmtzCgkJCV9kZWZhdWx0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBldmVudC50YXJnZXQsICJhIiApOwoJCQl9CgkJfSwKCgkJYmVmb3JldW5sb2FkOiB7CgkJCXBvc3REaXNwYXRjaDogZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIFN1cHBvcnQ6IEZpcmVmb3ggMjArCgkJCQkvLyBGaXJlZm94IGRvZXNuJ3QgYWxlcnQgaWYgdGhlIHJldHVyblZhbHVlIGZpZWxkIGlzIG5vdCBzZXQuCgkJCQlpZiAoIGV2ZW50LnJlc3VsdCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQucmV0dXJuVmFsdWUgPSBldmVudC5yZXN1bHQ7CgkJCQl9CgkJCX0KCQl9Cgl9LAoKCXNpbXVsYXRlOiBmdW5jdGlvbiggdHlwZSwgZWxlbSwgZXZlbnQsIGJ1YmJsZSApIHsKCQkvLyBQaWdneWJhY2sgb24gYSBkb25vciBldmVudCB0byBzaW11bGF0ZSBhIGRpZmZlcmVudCBvbmUuCgkJLy8gRmFrZSBvcmlnaW5hbEV2ZW50IHRvIGF2b2lkIGRvbm9yJ3Mgc3RvcFByb3BhZ2F0aW9uLCBidXQgaWYgdGhlCgkJLy8gc2ltdWxhdGVkIGV2ZW50IHByZXZlbnRzIGRlZmF1bHQgdGhlbiB3ZSBkbyB0aGUgc2FtZSBvbiB0aGUgZG9ub3IuCgkJdmFyIGUgPSBqUXVlcnkuZXh0ZW5kKAoJCQluZXcgalF1ZXJ5LkV2ZW50KCksCgkJCWV2ZW50LAoJCQl7CgkJCQl0eXBlOiB0eXBlLAoJCQkJaXNTaW11bGF0ZWQ6IHRydWUsCgkJCQlvcmlnaW5hbEV2ZW50OiB7fQoJCQl9CgkJKTsKCQlpZiAoIGJ1YmJsZSApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIGUsIG51bGwsIGVsZW0gKTsKCQl9IGVsc2UgewoJCQlqUXVlcnkuZXZlbnQuZGlzcGF0Y2guY2FsbCggZWxlbSwgZSApOwoJCX0KCQlpZiAoIGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfQp9OwoKalF1ZXJ5LnJlbW92ZUV2ZW50ID0gZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGhhbmRsZSApIHsKCWlmICggZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyICkgewoJCWVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lciggdHlwZSwgaGFuZGxlLCBmYWxzZSApOwoJfQp9OwoKalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24oIHNyYywgcHJvcHMgKSB7CgkvLyBBbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgdGhlICduZXcnIGtleXdvcmQKCWlmICggISh0aGlzIGluc3RhbmNlb2YgalF1ZXJ5LkV2ZW50KSApIHsKCQlyZXR1cm4gbmV3IGpRdWVyeS5FdmVudCggc3JjLCBwcm9wcyApOwoJfQoKCS8vIEV2ZW50IG9iamVjdAoJaWYgKCBzcmMgJiYgc3JjLnR5cGUgKSB7CgkJdGhpcy5vcmlnaW5hbEV2ZW50ID0gc3JjOwoJCXRoaXMudHlwZSA9IHNyYy50eXBlOwoKCQkvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAoJCS8vIGJ5IGEgaGFuZGxlciBsb3dlciBkb3duIHRoZSB0cmVlOyByZWZsZWN0IHRoZSBjb3JyZWN0IHZhbHVlLgoJCXRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gKCBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fAoJCQlzcmMuZ2V0UHJldmVudERlZmF1bHQgJiYgc3JjLmdldFByZXZlbnREZWZhdWx0KCkgKSA/IHJldHVyblRydWUgOiByZXR1cm5GYWxzZTsKCgkvLyBFdmVudCB0eXBlCgl9IGVsc2UgewoJCXRoaXMudHlwZSA9IHNyYzsKCX0KCgkvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAoJaWYgKCBwcm9wcyApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0aGlzLCBwcm9wcyApOwoJfQoKCS8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCgl0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IGpRdWVyeS5ub3coKTsKCgkvLyBNYXJrIGl0IGFzIGZpeGVkCgl0aGlzWyBqUXVlcnkuZXhwYW5kbyBdID0gdHJ1ZTsKfTsKCi8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwovLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKalF1ZXJ5LkV2ZW50LnByb3RvdHlwZSA9IHsKCWlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCglpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCglpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBlID0gdGhpcy5vcmlnaW5hbEV2ZW50OwoKCQl0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IHJldHVyblRydWU7CgoJCWlmICggZSAmJiBlLnByZXZlbnREZWZhdWx0ICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSwKCXN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdmFyIGUgPSB0aGlzLm9yaWdpbmFsRXZlbnQ7CgoJCXRoaXMuaXNQcm9wYWdhdGlvblN0b3BwZWQgPSByZXR1cm5UcnVlOwoKCQlpZiAoIGUgJiYgZS5zdG9wUHJvcGFnYXRpb24gKSB7CgkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJfQoJfSwKCXN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CgkJdGhpcy5zdG9wUHJvcGFnYXRpb24oKTsKCX0KfTsKCi8vIENyZWF0ZSBtb3VzZWVudGVyL2xlYXZlIGV2ZW50cyB1c2luZyBtb3VzZW92ZXIvb3V0IGFuZCBldmVudC10aW1lIGNoZWNrcwovLyBTdXBwb3J0OiBDaHJvbWUgMTUrCmpRdWVyeS5lYWNoKHsKCW1vdXNlZW50ZXI6ICJtb3VzZW92ZXIiLAoJbW91c2VsZWF2ZTogIm1vdXNlb3V0Igp9LCBmdW5jdGlvbiggb3JpZywgZml4ICkgewoJalF1ZXJ5LmV2ZW50LnNwZWNpYWxbIG9yaWcgXSA9IHsKCQlkZWxlZ2F0ZVR5cGU6IGZpeCwKCQliaW5kVHlwZTogZml4LAoKCQloYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIHJldCwKCQkJCXRhcmdldCA9IHRoaXMsCgkJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCwKCQkJCWhhbmRsZU9iaiA9IGV2ZW50LmhhbmRsZU9iajsKCgkJCS8vIEZvciBtb3VzZW50ZXIvbGVhdmUgY2FsbCB0aGUgaGFuZGxlciBpZiByZWxhdGVkIGlzIG91dHNpZGUgdGhlIHRhcmdldC4KCQkJLy8gTkI6IE5vIHJlbGF0ZWRUYXJnZXQgaWYgdGhlIG1vdXNlIGxlZnQvZW50ZXJlZCB0aGUgYnJvd3NlciB3aW5kb3cKCQkJaWYgKCAhcmVsYXRlZCB8fCAocmVsYXRlZCAhPT0gdGFyZ2V0ICYmICFqUXVlcnkuY29udGFpbnMoIHRhcmdldCwgcmVsYXRlZCApKSApIHsKCQkJCWV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CgkJCQlyZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQlldmVudC50eXBlID0gZml4OwoJCQl9CgkJCXJldHVybiByZXQ7CgkJfQoJfTsKfSk7CgovLyBDcmVhdGUgImJ1YmJsaW5nIiBmb2N1cyBhbmQgYmx1ciBldmVudHMKLy8gU3VwcG9ydDogRmlyZWZveCwgQ2hyb21lLCBTYWZhcmkKaWYgKCAhalF1ZXJ5LnN1cHBvcnQuZm9jdXNpbkJ1YmJsZXMgKSB7CglqUXVlcnkuZWFjaCh7IGZvY3VzOiAiZm9jdXNpbiIsIGJsdXI6ICJmb2N1c291dCIgfSwgZnVuY3Rpb24oIG9yaWcsIGZpeCApIHsKCgkJLy8gQXR0YWNoIGEgc2luZ2xlIGNhcHR1cmluZyBoYW5kbGVyIHdoaWxlIHNvbWVvbmUgd2FudHMgZm9jdXNpbi9mb2N1c291dAoJCXZhciBhdHRhY2hlcyA9IDAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlqUXVlcnkuZXZlbnQuc2ltdWxhdGUoIGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KCBldmVudCApLCB0cnVlICk7CgkJCX07CgoJCWpRdWVyeS5ldmVudC5zcGVjaWFsWyBmaXggXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBhdHRhY2hlcysrID09PSAwICkgewoJCQkJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCAtLWF0dGFjaGVzID09PSAwICkgewoJCQkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIG9yaWcsIGhhbmRsZXIsIHRydWUgKTsKCQkJCX0KCQkJfQoJCX07Cgl9KTsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJb246IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCAvKklOVEVSTkFMKi8gb25lICkgewoJCXZhciBvcmlnRm4sIHR5cGU7CgoJCS8vIFR5cGVzIGNhbiBiZSBhIG1hcCBvZiB0eXBlcy9oYW5kbGVycwoJCWlmICggdHlwZW9mIHR5cGVzID09PSAib2JqZWN0IiApIHsKCQkJLy8gKCB0eXBlcy1PYmplY3QsIHNlbGVjdG9yLCBkYXRhICkKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcy1PYmplY3QsIGRhdGEgKQoJCQkJZGF0YSA9IGRhdGEgfHwgc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vbiggdHlwZSwgc2VsZWN0b3IsIGRhdGEsIHR5cGVzWyB0eXBlIF0sIG9uZSApOwoJCQl9CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBkYXRhID09IG51bGwgJiYgZm4gPT0gbnVsbCApIHsKCQkJLy8gKCB0eXBlcywgZm4gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CgkJfSBlbHNlIGlmICggZm4gPT0gbnVsbCApIHsKCQkJaWYgKCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICkgewoJCQkJLy8gKCB0eXBlcywgc2VsZWN0b3IsIGZuICkKCQkJCWZuID0gZGF0YTsKCQkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJCX0gZWxzZSB7CgkJCQkvLyAoIHR5cGVzLCBkYXRhLCBmbiApCgkJCQlmbiA9IGRhdGE7CgkJCQlkYXRhID0gc2VsZWN0b3I7CgkJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQkJfQoJCX0KCQlpZiAoIGZuID09PSBmYWxzZSApIHsKCQkJZm4gPSByZXR1cm5GYWxzZTsKCQl9IGVsc2UgaWYgKCAhZm4gKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKCBvbmUgPT09IDEgKSB7CgkJCW9yaWdGbiA9IGZuOwoJCQlmbiA9IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCS8vIENhbiB1c2UgYW4gZW1wdHkgc2V0LCBzaW5jZSBldmVudCBjb250YWlucyB0aGUgaW5mbwoJCQkJalF1ZXJ5KCkub2ZmKCBldmVudCApOwoJCQkJcmV0dXJuIG9yaWdGbi5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJCS8vIFVzZSBzYW1lIGd1aWQgc28gY2FsbGVyIGNhbiByZW1vdmUgdXNpbmcgb3JpZ0ZuCgkJCWZuLmd1aWQgPSBvcmlnRm4uZ3VpZCB8fCAoIG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyApOwoJCX0KCQlyZXR1cm4gdGhpcy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LmFkZCggdGhpcywgdHlwZXMsIGZuLCBkYXRhLCBzZWxlY3RvciApOwoJCX0pOwoJfSwKCW9uZTogZnVuY3Rpb24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4sIDEgKTsKCX0sCglvZmY6IGZ1bmN0aW9uKCB0eXBlcywgc2VsZWN0b3IsIGZuICkgewoJCXZhciBoYW5kbGVPYmosIHR5cGU7CgkJaWYgKCB0eXBlcyAmJiB0eXBlcy5wcmV2ZW50RGVmYXVsdCAmJiB0eXBlcy5oYW5kbGVPYmogKSB7CgkJCS8vICggZXZlbnQgKSAgZGlzcGF0Y2hlZCBqUXVlcnkuRXZlbnQKCQkJaGFuZGxlT2JqID0gdHlwZXMuaGFuZGxlT2JqOwoJCQlqUXVlcnkoIHR5cGVzLmRlbGVnYXRlVGFyZ2V0ICkub2ZmKAoJCQkJaGFuZGxlT2JqLm5hbWVzcGFjZSA/IGhhbmRsZU9iai5vcmlnVHlwZSArICIuIiArIGhhbmRsZU9iai5uYW1lc3BhY2UgOiBoYW5kbGVPYmoub3JpZ1R5cGUsCgkJCQloYW5kbGVPYmouc2VsZWN0b3IsCgkJCQloYW5kbGVPYmouaGFuZGxlcgoJCQkpOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKCB0eXBlb2YgdHlwZXMgPT09ICJvYmplY3QiICkgewoJCQkvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQoJCQlmb3IgKCB0eXBlIGluIHR5cGVzICkgewoJCQkJdGhpcy5vZmYoIHR5cGUsIHNlbGVjdG9yLCB0eXBlc1sgdHlwZSBdICk7CgkJCX0KCQkJcmV0dXJuIHRoaXM7CgkJfQoJCWlmICggc2VsZWN0b3IgPT09IGZhbHNlIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gImZ1bmN0aW9uIiApIHsKCQkJLy8gKCB0eXBlcyBbLCBmbl0gKQoJCQlmbiA9IHNlbGVjdG9yOwoJCQlzZWxlY3RvciA9IHVuZGVmaW5lZDsKCQl9CgkJaWYgKCBmbiA9PT0gZmFsc2UgKSB7CgkJCWZuID0gcmV0dXJuRmFsc2U7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCWpRdWVyeS5ldmVudC5yZW1vdmUoIHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IgKTsKCQl9KTsKCX0sCgoJdHJpZ2dlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoIHR5cGUsIGRhdGEsIHRoaXMgKTsKCQl9KTsKCX0sCgl0cmlnZ2VySGFuZGxlcjogZnVuY3Rpb24oIHR5cGUsIGRhdGEgKSB7CgkJdmFyIGVsZW0gPSB0aGlzWzBdOwoJCWlmICggZWxlbSApIHsKCQkJcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKCB0eXBlLCBkYXRhLCBlbGVtLCB0cnVlICk7CgkJfQoJfQp9KTsKdmFyIGlzU2ltcGxlID0gL14uW146I1xbXC4sXSokLywKCXJwYXJlbnRzcHJldiA9IC9eKD86cGFyZW50c3xwcmV2KD86VW50aWx8QWxsKSkvLAoJcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dCwKCS8vIG1ldGhvZHMgZ3VhcmFudGVlZCB0byBwcm9kdWNlIGEgdW5pcXVlIHNldCB3aGVuIHN0YXJ0aW5nIGZyb20gYSB1bmlxdWUgc2V0CglndWFyYW50ZWVkVW5pcXVlID0gewoJCWNoaWxkcmVuOiB0cnVlLAoJCWNvbnRlbnRzOiB0cnVlLAoJCW5leHQ6IHRydWUsCgkJcHJldjogdHJ1ZQoJfTsKCmpRdWVyeS5mbi5leHRlbmQoewoJZmluZDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBpLAoJCQlyZXQgPSBbXSwKCQkJc2VsZiA9IHRoaXMsCgkJCWxlbiA9IHNlbGYubGVuZ3RoOwoKCQlpZiAoIHR5cGVvZiBzZWxlY3RvciAhPT0gInN0cmluZyIgKSB7CgkJCXJldHVybiB0aGlzLnB1c2hTdGFjayggalF1ZXJ5KCBzZWxlY3RvciApLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCQkJaWYgKCBqUXVlcnkuY29udGFpbnMoIHNlbGZbIGkgXSwgdGhpcyApICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQl9CgkJCX0pICk7CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IGxlbjsgaSsrICkgewoJCQlqUXVlcnkuZmluZCggc2VsZWN0b3IsIHNlbGZbIGkgXSwgcmV0ICk7CgkJfQoKCQkvLyBOZWVkZWQgYmVjYXVzZSAkKCBzZWxlY3RvciwgY29udGV4dCApIGJlY29tZXMgJCggY29udGV4dCApLmZpbmQoIHNlbGVjdG9yICkKCQlyZXQgPSB0aGlzLnB1c2hTdGFjayggbGVuID4gMSA/IGpRdWVyeS51bmlxdWUoIHJldCApIDogcmV0ICk7CgkJcmV0LnNlbGVjdG9yID0gdGhpcy5zZWxlY3RvciA/IHRoaXMuc2VsZWN0b3IgKyAiICIgKyBzZWxlY3RvciA6IHNlbGVjdG9yOwoJCXJldHVybiByZXQ7Cgl9LAoKCWhhczogZnVuY3Rpb24oIHRhcmdldCApIHsKCQl2YXIgdGFyZ2V0cyA9IGpRdWVyeSggdGFyZ2V0LCB0aGlzICksCgkJCWwgPSB0YXJnZXRzLmxlbmd0aDsKCgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQl2YXIgaSA9IDA7CgkJCWZvciAoIDsgaSA8IGw7IGkrKyApIHsKCQkJCWlmICggalF1ZXJ5LmNvbnRhaW5zKCB0aGlzLCB0YXJnZXRzW2ldICkgKSB7CgkJCQkJcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQl9KTsKCX0sCgoJbm90OiBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCB3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIHRydWUpICk7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLnB1c2hTdGFjayggd2lubm93KHRoaXMsIHNlbGVjdG9yIHx8IFtdLCBmYWxzZSkgKTsKCX0sCgoJaXM6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gISF3aW5ub3coCgkJCXRoaXMsCgoJCQkvLyBJZiB0aGlzIGlzIGEgcG9zaXRpb25hbC9yZWxhdGl2ZSBzZWxlY3RvciwgY2hlY2sgbWVtYmVyc2hpcCBpbiB0aGUgcmV0dXJuZWQgc2V0CgkJCS8vIHNvICQoInA6Zmlyc3QiKS5pcygicDpsYXN0Iikgd29uJ3QgcmV0dXJuIHRydWUgZm9yIGEgZG9jIHdpdGggdHdvICJwIi4KCQkJdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiAmJiBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9yICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciApIDoKCQkJCXNlbGVjdG9yIHx8IFtdLAoJCQlmYWxzZQoJCSkubGVuZ3RoOwoJfSwKCgljbG9zZXN0OiBmdW5jdGlvbiggc2VsZWN0b3JzLCBjb250ZXh0ICkgewoJCXZhciBjdXIsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGgsCgkJCW1hdGNoZWQgPSBbXSwKCQkJcG9zID0gKCBybmVlZHNDb250ZXh0LnRlc3QoIHNlbGVjdG9ycyApIHx8IHR5cGVvZiBzZWxlY3RvcnMgIT09ICJzdHJpbmciICkgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvcnMsIGNvbnRleHQgfHwgdGhpcy5jb250ZXh0ICkgOgoJCQkJMDsKCgkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQlmb3IgKCBjdXIgPSB0aGlzW2ldOyBjdXIgJiYgY3VyICE9PSBjb250ZXh0OyBjdXIgPSBjdXIucGFyZW50Tm9kZSApIHsKCQkJCS8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwoJCQkJaWYgKCBjdXIubm9kZVR5cGUgPCAxMSAmJiAocG9zID8KCQkJCQlwb3MuaW5kZXgoY3VyKSA+IC0xIDoKCgkJCQkJLy8gRG9uJ3QgcGFzcyBub24tZWxlbWVudHMgdG8gU2l6emxlCgkJCQkJY3VyLm5vZGVUeXBlID09PSAxICYmCgkJCQkJCWpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihjdXIsIHNlbGVjdG9ycykpICkgewoKCQkJCQljdXIgPSBtYXRjaGVkLnB1c2goIGN1ciApOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIG1hdGNoZWQubGVuZ3RoID4gMSA/IGpRdWVyeS51bmlxdWUoIG1hdGNoZWQgKSA6IG1hdGNoZWQgKTsKCX0sCgoJLy8gRGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiBhbiBlbGVtZW50IHdpdGhpbgoJLy8gdGhlIG1hdGNoZWQgc2V0IG9mIGVsZW1lbnRzCglpbmRleDogZnVuY3Rpb24oIGVsZW0gKSB7CgoJCS8vIE5vIGFyZ3VtZW50LCByZXR1cm4gaW5kZXggaW4gcGFyZW50CgkJaWYgKCAhZWxlbSApIHsKCQkJcmV0dXJuICggdGhpc1sgMCBdICYmIHRoaXNbIDAgXS5wYXJlbnROb2RlICkgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwoJCX0KCgkJLy8gaW5kZXggaW4gc2VsZWN0b3IKCQlpZiAoIHR5cGVvZiBlbGVtID09PSAic3RyaW5nIiApIHsKCQkJcmV0dXJuIGNvcmVfaW5kZXhPZi5jYWxsKCBqUXVlcnkoIGVsZW0gKSwgdGhpc1sgMCBdICk7CgkJfQoKCQkvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKCQlyZXR1cm4gY29yZV9pbmRleE9mLmNhbGwoIHRoaXMsCgoJCQkvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKCQkJZWxlbS5qcXVlcnkgPyBlbGVtWyAwIF0gOiBlbGVtCgkJKTsKCX0sCgoJYWRkOiBmdW5jdGlvbiggc2VsZWN0b3IsIGNvbnRleHQgKSB7CgkJdmFyIHNldCA9IHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIgPwoJCQkJalF1ZXJ5KCBzZWxlY3RvciwgY29udGV4dCApIDoKCQkJCWpRdWVyeS5tYWtlQXJyYXkoIHNlbGVjdG9yICYmIHNlbGVjdG9yLm5vZGVUeXBlID8gWyBzZWxlY3RvciBdIDogc2VsZWN0b3IgKSwKCQkJYWxsID0galF1ZXJ5Lm1lcmdlKCB0aGlzLmdldCgpLCBzZXQgKTsKCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBqUXVlcnkudW5pcXVlKGFsbCkgKTsKCX0sCgoJYWRkQmFjazogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXJldHVybiB0aGlzLmFkZCggc2VsZWN0b3IgPT0gbnVsbCA/CgkJCXRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpCgkJKTsKCX0KfSk7CgpmdW5jdGlvbiBzaWJsaW5nKCBjdXIsIGRpciApIHsKCXdoaWxlICggKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEgKSB7fQoKCXJldHVybiBjdXI7Cn0KCmpRdWVyeS5lYWNoKHsKCXBhcmVudDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKCQlyZXR1cm4gcGFyZW50ICYmIHBhcmVudC5ub2RlVHlwZSAhPT0gMTEgPyBwYXJlbnQgOiBudWxsOwoJfSwKCXBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuZGlyKCBlbGVtLCAicGFyZW50Tm9kZSIgKTsKCX0sCglwYXJlbnRzVW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInBhcmVudE5vZGUiLCB1bnRpbCApOwoJfSwKCW5leHQ6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBzaWJsaW5nKCBlbGVtLCAibmV4dFNpYmxpbmciICk7Cgl9LAoJcHJldjogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIHNpYmxpbmcoIGVsZW0sICJwcmV2aW91c1NpYmxpbmciICk7Cgl9LAoJbmV4dEFsbDogZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuIGpRdWVyeS5kaXIoIGVsZW0sICJuZXh0U2libGluZyIgKTsKCX0sCglwcmV2QWxsOiBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIgKTsKCX0sCgluZXh0VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgIm5leHRTaWJsaW5nIiwgdW50aWwgKTsKCX0sCglwcmV2VW50aWw6IGZ1bmN0aW9uKCBlbGVtLCBpLCB1bnRpbCApIHsKCQlyZXR1cm4galF1ZXJ5LmRpciggZWxlbSwgInByZXZpb3VzU2libGluZyIsIHVudGlsICk7Cgl9LAoJc2libGluZ3M6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggKCBlbGVtLnBhcmVudE5vZGUgfHwge30gKS5maXJzdENoaWxkLCBlbGVtICk7Cgl9LAoJY2hpbGRyZW46IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBqUXVlcnkuc2libGluZyggZWxlbS5maXJzdENoaWxkICk7Cgl9LAoJY29udGVudHM6IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudCB8fCBqUXVlcnkubWVyZ2UoIFtdLCBlbGVtLmNoaWxkTm9kZXMgKTsKCX0KfSwgZnVuY3Rpb24oIG5hbWUsIGZuICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggdW50aWwsIHNlbGVjdG9yICkgewoJCXZhciBtYXRjaGVkID0galF1ZXJ5Lm1hcCggdGhpcywgZm4sIHVudGlsICk7CgoJCWlmICggbmFtZS5zbGljZSggLTUgKSAhPT0gIlVudGlsIiApIHsKCQkJc2VsZWN0b3IgPSB1bnRpbDsKCQl9CgoJCWlmICggc2VsZWN0b3IgJiYgdHlwZW9mIHNlbGVjdG9yID09PSAic3RyaW5nIiApIHsKCQkJbWF0Y2hlZCA9IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCBtYXRjaGVkICk7CgkJfQoKCQlpZiAoIHRoaXMubGVuZ3RoID4gMSApIHsKCQkJLy8gUmVtb3ZlIGR1cGxpY2F0ZXMKCQkJaWYgKCAhZ3VhcmFudGVlZFVuaXF1ZVsgbmFtZSBdICkgewoJCQkJalF1ZXJ5LnVuaXF1ZSggbWF0Y2hlZCApOwoJCQl9CgoJCQkvLyBSZXZlcnNlIG9yZGVyIGZvciBwYXJlbnRzKiBhbmQgcHJldi1kZXJpdmF0aXZlcwoJCQlpZiAoIHJwYXJlbnRzcHJldi50ZXN0KCBuYW1lICkgKSB7CgkJCQltYXRjaGVkLnJldmVyc2UoKTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMucHVzaFN0YWNrKCBtYXRjaGVkICk7Cgl9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoJZmlsdGVyOiBmdW5jdGlvbiggZXhwciwgZWxlbXMsIG5vdCApIHsKCQl2YXIgZWxlbSA9IGVsZW1zWyAwIF07CgoJCWlmICggbm90ICkgewoJCQlleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CgkJfQoKCQlyZXR1cm4gZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgPwoJCQlqUXVlcnkuZmluZC5tYXRjaGVzU2VsZWN0b3IoIGVsZW0sIGV4cHIgKSA/IFsgZWxlbSBdIDogW10gOgoJCQlqUXVlcnkuZmluZC5tYXRjaGVzKCBleHByLCBqUXVlcnkuZ3JlcCggZWxlbXMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIGVsZW0ubm9kZVR5cGUgPT09IDE7CgkJCX0pKTsKCX0sCgoJZGlyOiBmdW5jdGlvbiggZWxlbSwgZGlyLCB1bnRpbCApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdLAoJCQl0cnVuY2F0ZSA9IHVudGlsICE9PSB1bmRlZmluZWQ7CgoJCXdoaWxlICggKGVsZW0gPSBlbGVtWyBkaXIgXSkgJiYgZWxlbS5ub2RlVHlwZSAhPT0gOSApIHsKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJaWYgKCB0cnVuY2F0ZSAmJiBqUXVlcnkoIGVsZW0gKS5pcyggdW50aWwgKSApIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCW1hdGNoZWQucHVzaCggZWxlbSApOwoJCQl9CgkJfQoJCXJldHVybiBtYXRjaGVkOwoJfSwKCglzaWJsaW5nOiBmdW5jdGlvbiggbiwgZWxlbSApIHsKCQl2YXIgbWF0Y2hlZCA9IFtdOwoKCQlmb3IgKCA7IG47IG4gPSBuLm5leHRTaWJsaW5nICkgewoJCQlpZiAoIG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSApIHsKCQkJCW1hdGNoZWQucHVzaCggbiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gbWF0Y2hlZDsKCX0KfSk7CgovLyBJbXBsZW1lbnQgdGhlIGlkZW50aWNhbCBmdW5jdGlvbmFsaXR5IGZvciBmaWx0ZXIgYW5kIG5vdApmdW5jdGlvbiB3aW5ub3coIGVsZW1lbnRzLCBxdWFsaWZpZXIsIG5vdCApIHsKCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIHF1YWxpZmllciApICkgewoJCXJldHVybiBqUXVlcnkuZ3JlcCggZWxlbWVudHMsIGZ1bmN0aW9uKCBlbGVtLCBpICkgewoJCQkvKiBqc2hpbnQgLVcwMTggKi8KCQkJcmV0dXJuICEhcXVhbGlmaWVyLmNhbGwoIGVsZW0sIGksIGVsZW0gKSAhPT0gbm90OwoJCX0pOwoKCX0KCglpZiAoIHF1YWxpZmllci5ub2RlVHlwZSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoIGVsZW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJcmV0dXJuICggZWxlbSA9PT0gcXVhbGlmaWVyICkgIT09IG5vdDsKCQl9KTsKCgl9CgoJaWYgKCB0eXBlb2YgcXVhbGlmaWVyID09PSAic3RyaW5nIiApIHsKCQlpZiAoIGlzU2ltcGxlLnRlc3QoIHF1YWxpZmllciApICkgewoJCQlyZXR1cm4galF1ZXJ5LmZpbHRlciggcXVhbGlmaWVyLCBlbGVtZW50cywgbm90ICk7CgkJfQoKCQlxdWFsaWZpZXIgPSBqUXVlcnkuZmlsdGVyKCBxdWFsaWZpZXIsIGVsZW1lbnRzICk7Cgl9CgoJcmV0dXJuIGpRdWVyeS5ncmVwKCBlbGVtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICggY29yZV9pbmRleE9mLmNhbGwoIHF1YWxpZmllciwgZWxlbSApID49IDAgKSAhPT0gbm90OwoJfSk7Cn0KdmFyIHJ4aHRtbFRhZyA9IC88KD8hYXJlYXxicnxjb2x8ZW1iZWR8aHJ8aW1nfGlucHV0fGxpbmt8bWV0YXxwYXJhbSkoKFtcdzpdKylbXj5dKilcLz4vZ2ksCglydGFnTmFtZSA9IC88KFtcdzpdKykvLAoJcmh0bWwgPSAvPHwmIz9cdys7LywKCXJub0lubmVyaHRtbCA9IC88KD86c2NyaXB0fHN0eWxlfGxpbmspL2ksCgltYW5pcHVsYXRpb25fcmNoZWNrYWJsZVR5cGUgPSAvXig/OmNoZWNrYm94fHJhZGlvKSQvaSwKCS8vIGNoZWNrZWQ9ImNoZWNrZWQiIG9yIGNoZWNrZWQKCXJjaGVja2VkID0gL2NoZWNrZWRccyooPzpbXj1dfD1ccyouY2hlY2tlZC4pL2ksCglyc2NyaXB0VHlwZSA9IC9eJHxcLyg/OmphdmF8ZWNtYSlzY3JpcHQvaSwKCXJzY3JpcHRUeXBlTWFza2VkID0gL150cnVlXC8oLiopLywKCXJjbGVhblNjcmlwdCA9IC9eXHMqPCEoPzpcW0NEQVRBXFt8LS0pfCg/OlxdXF18LS0pPlxzKiQvZywKCgkvLyBXZSBoYXZlIHRvIGNsb3NlIHRoZXNlIHRhZ3MgdG8gc3VwcG9ydCBYSFRNTCAoIzEzMjAwKQoJd3JhcE1hcCA9IHsKCgkJLy8gU3VwcG9ydDogSUUgOQoJCW9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCgoJCXRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAoJCWNvbDogWyAyLCAiPHRhYmxlPjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKCQl0cjogWyAyLCAiPHRhYmxlPjx0Ym9keT4iLCAiPC90Ym9keT48L3RhYmxlPiIgXSwKCQl0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKCgkJX2RlZmF1bHQ6IFsgMCwgIiIsICIiIF0KCX07CgovLyBTdXBwb3J0OiBJRSA5CndyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKCndyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CndyYXBNYXAudGggPSB3cmFwTWFwLnRkOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgl0ZXh0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnRleHQoIHRoaXMgKSA6CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCAoIHRoaXNbIDAgXSAmJiB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApLmNyZWF0ZVRleHROb2RlKCB2YWx1ZSApICk7CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJYXBwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuYXBwZW5kQ2hpbGQoIGVsZW0gKTsKCQkJfQoJCX0pOwoJfSwKCglwcmVwZW5kOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkgKSB7CgkJCQl2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KCB0aGlzLCBlbGVtICk7CgkJCQl0YXJnZXQuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0YXJnZXQuZmlyc3RDaGlsZCApOwoJCQl9CgkJfSk7Cgl9LAoKCWJlZm9yZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZG9tTWFuaXAoIGFyZ3VtZW50cywgZnVuY3Rpb24oIGVsZW0gKSB7CgkJCWlmICggdGhpcy5wYXJlbnROb2RlICkgewoJCQkJdGhpcy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZWxlbSwgdGhpcyApOwoJCQl9CgkJfSk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJaWYgKCB0aGlzLnBhcmVudE5vZGUgKSB7CgkJCQl0aGlzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCBlbGVtLCB0aGlzLm5leHRTaWJsaW5nICk7CgkJCX0KCQl9KTsKCX0sCgoJLy8ga2VlcERhdGEgaXMgZm9yIGludGVybmFsIHVzZSBvbmx5LS1kbyBub3QgZG9jdW1lbnQKCXJlbW92ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCBrZWVwRGF0YSApIHsKCQl2YXIgZWxlbSwKCQkJZWxlbXMgPSBzZWxlY3RvciA/IGpRdWVyeS5maWx0ZXIoIHNlbGVjdG9yLCB0aGlzICkgOiB0aGlzLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKysgKSB7CgkJCWlmICggIWtlZXBEYXRhICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0gKSApOwoJCQl9CgoJCQlpZiAoIGVsZW0ucGFyZW50Tm9kZSApIHsKCQkJCWlmICgga2VlcERhdGEgJiYgalF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKSApIHsKCQkJCQlzZXRHbG9iYWxFdmFsKCBnZXRBbGwoIGVsZW0sICJzY3JpcHQiICkgKTsKCQkJCX0KCQkJCWVsZW0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggZWxlbSApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtLAoJCQlpID0gMDsKCgkJZm9yICggOyAoZWxlbSA9IHRoaXNbaV0pICE9IG51bGw7IGkrKyApIHsKCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoKCQkJCS8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCgkJCQlqUXVlcnkuY2xlYW5EYXRhKCBnZXRBbGwoIGVsZW0sIGZhbHNlICkgKTsKCgkJCQkvLyBSZW1vdmUgYW55IHJlbWFpbmluZyBub2RlcwoJCQkJZWxlbS50ZXh0Q29udGVudCA9ICIiOwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvbmU6IGZ1bmN0aW9uKCBkYXRhQW5kRXZlbnRzLCBkZWVwRGF0YUFuZEV2ZW50cyApIHsKCQlkYXRhQW5kRXZlbnRzID0gZGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZmFsc2UgOiBkYXRhQW5kRXZlbnRzOwoJCWRlZXBEYXRhQW5kRXZlbnRzID0gZGVlcERhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGRhdGFBbmRFdmVudHMgOiBkZWVwRGF0YUFuZEV2ZW50czsKCgkJcmV0dXJuIHRoaXMubWFwKCBmdW5jdGlvbiAoKSB7CgkJCXJldHVybiBqUXVlcnkuY2xvbmUoIHRoaXMsIGRhdGFBbmRFdmVudHMsIGRlZXBEYXRhQW5kRXZlbnRzICk7CgkJfSk7Cgl9LAoKCWh0bWw6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgZWxlbSA9IHRoaXNbIDAgXSB8fCB7fSwKCQkJCWkgPSAwLAoJCQkJbCA9IHRoaXMubGVuZ3RoOwoKCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICYmIGVsZW0ubm9kZVR5cGUgPT09IDEgKSB7CgkJCQlyZXR1cm4gZWxlbS5pbm5lckhUTUw7CgkJCX0KCgkJCS8vIFNlZSBpZiB3ZSBjYW4gdGFrZSBhIHNob3J0Y3V0IGFuZCBqdXN0IHVzZSBpbm5lckhUTUwKCQkJaWYgKCB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmICFybm9Jbm5lcmh0bWwudGVzdCggdmFsdWUgKSAmJgoJCQkJIXdyYXBNYXBbICggcnRhZ05hbWUuZXhlYyggdmFsdWUgKSB8fCBbICIiLCAiIiBdIClbIDEgXS50b0xvd2VyQ2FzZSgpIF0gKSB7CgoJCQkJdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICk7CgoJCQkJdHJ5IHsKCQkJCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCQkJCWVsZW0gPSB0aGlzWyBpIF0gfHwge307CgoJCQkJCQkvLyBSZW1vdmUgZWxlbWVudCBub2RlcyBhbmQgcHJldmVudCBtZW1vcnkgbGVha3MKCQkJCQkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICkgewoJCQkJCQkJalF1ZXJ5LmNsZWFuRGF0YSggZ2V0QWxsKCBlbGVtLCBmYWxzZSApICk7CgkJCQkJCQllbGVtLmlubmVySFRNTCA9IHZhbHVlOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQllbGVtID0gMDsKCgkJCQkvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKCQkJCX0gY2F0Y2goIGUgKSB7fQoJCQl9CgoJCQlpZiAoIGVsZW0gKSB7CgkJCQl0aGlzLmVtcHR5KCkuYXBwZW5kKCB2YWx1ZSApOwoJCQl9CgkJfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggKTsKCX0sCgoJcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKCkgewoJCXZhcgoJCQkvLyBTbmFwc2hvdCB0aGUgRE9NIGluIGNhc2UgLmRvbU1hbmlwIHN3ZWVwcyBzb21ldGhpbmcgcmVsZXZhbnQgaW50byBpdHMgZnJhZ21lbnQKCQkJYXJncyA9IGpRdWVyeS5tYXAoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtICkgewoJCQkJcmV0dXJuIFsgZWxlbS5uZXh0U2libGluZywgZWxlbS5wYXJlbnROb2RlIF07CgkJCX0pLAoJCQlpID0gMDsKCgkJLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CgkJdGhpcy5kb21NYW5pcCggYXJndW1lbnRzLCBmdW5jdGlvbiggZWxlbSApIHsKCQkJdmFyIG5leHQgPSBhcmdzWyBpKysgXSwKCQkJCXBhcmVudCA9IGFyZ3NbIGkrKyBdOwoKCQkJaWYgKCBwYXJlbnQgKSB7CgkJCQkvLyBEb24ndCB1c2UgdGhlIHNuYXBzaG90IG5leHQgaWYgaXQgaGFzIG1vdmVkICgjMTM4MTApCgkJCQlpZiAoIG5leHQgJiYgbmV4dC5wYXJlbnROb2RlICE9PSBwYXJlbnQgKSB7CgkJCQkJbmV4dCA9IHRoaXMubmV4dFNpYmxpbmc7CgkJCQl9CgkJCQlqUXVlcnkoIHRoaXMgKS5yZW1vdmUoKTsKCQkJCXBhcmVudC5pbnNlcnRCZWZvcmUoIGVsZW0sIG5leHQgKTsKCQkJfQoJCS8vIEFsbG93IG5ldyBjb250ZW50IHRvIGluY2x1ZGUgZWxlbWVudHMgZnJvbSB0aGUgY29udGV4dCBzZXQKCQl9LCB0cnVlICk7CgoJCS8vIEZvcmNlIHJlbW92YWwgaWYgdGhlcmUgd2FzIG5vIG5ldyBjb250ZW50IChlLmcuLCBmcm9tIGVtcHR5IGFyZ3VtZW50cykKCQlyZXR1cm4gaSA/IHRoaXMgOiB0aGlzLnJlbW92ZSgpOwoJfSwKCglkZXRhY2g6IGZ1bmN0aW9uKCBzZWxlY3RvciApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmUoIHNlbGVjdG9yLCB0cnVlICk7Cgl9LAoKCWRvbU1hbmlwOiBmdW5jdGlvbiggYXJncywgY2FsbGJhY2ssIGFsbG93SW50ZXJzZWN0aW9uICkgewoKCQkvLyBGbGF0dGVuIGFueSBuZXN0ZWQgYXJyYXlzCgkJYXJncyA9IGNvcmVfY29uY2F0LmFwcGx5KCBbXSwgYXJncyApOwoKCQl2YXIgZnJhZ21lbnQsIGZpcnN0LCBzY3JpcHRzLCBoYXNTY3JpcHRzLCBub2RlLCBkb2MsCgkJCWkgPSAwLAoJCQlsID0gdGhpcy5sZW5ndGgsCgkJCXNldCA9IHRoaXMsCgkJCWlOb0Nsb25lID0gbCAtIDEsCgkJCXZhbHVlID0gYXJnc1sgMCBdLAoJCQlpc0Z1bmN0aW9uID0galF1ZXJ5LmlzRnVuY3Rpb24oIHZhbHVlICk7CgoJCS8vIFdlIGNhbid0IGNsb25lTm9kZSBmcmFnbWVudHMgdGhhdCBjb250YWluIGNoZWNrZWQsIGluIFdlYktpdAoJCWlmICggaXNGdW5jdGlvbiB8fCAhKCBsIDw9IDEgfHwgdHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIiB8fCBqUXVlcnkuc3VwcG9ydC5jaGVja0Nsb25lIHx8ICFyY2hlY2tlZC50ZXN0KCB2YWx1ZSApICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGluZGV4ICkgewoJCQkJdmFyIHNlbGYgPSBzZXQuZXEoIGluZGV4ICk7CgkJCQlpZiAoIGlzRnVuY3Rpb24gKSB7CgkJCQkJYXJnc1sgMCBdID0gdmFsdWUuY2FsbCggdGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpICk7CgkJCQl9CgkJCQlzZWxmLmRvbU1hbmlwKCBhcmdzLCBjYWxsYmFjaywgYWxsb3dJbnRlcnNlY3Rpb24gKTsKCQkJfSk7CgkJfQoKCQlpZiAoIGwgKSB7CgkJCWZyYWdtZW50ID0galF1ZXJ5LmJ1aWxkRnJhZ21lbnQoIGFyZ3MsIHRoaXNbIDAgXS5vd25lckRvY3VtZW50LCBmYWxzZSwgIWFsbG93SW50ZXJzZWN0aW9uICYmIHRoaXMgKTsKCQkJZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwoKCQkJaWYgKCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSApIHsKCQkJCWZyYWdtZW50ID0gZmlyc3Q7CgkJCX0KCgkJCWlmICggZmlyc3QgKSB7CgkJCQlzY3JpcHRzID0galF1ZXJ5Lm1hcCggZ2V0QWxsKCBmcmFnbWVudCwgInNjcmlwdCIgKSwgZGlzYWJsZVNjcmlwdCApOwoJCQkJaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwoKCQkJCS8vIFVzZSB0aGUgb3JpZ2luYWwgZnJhZ21lbnQgZm9yIHRoZSBsYXN0IGl0ZW0gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCgkJCQkvLyBiZWluZyBlbXB0aWVkIGluY29ycmVjdGx5IGluIGNlcnRhaW4gc2l0dWF0aW9ucyAoIzgwNzApLgoJCQkJZm9yICggOyBpIDwgbDsgaSsrICkgewoJCQkJCW5vZGUgPSBmcmFnbWVudDsKCgkJCQkJaWYgKCBpICE9PSBpTm9DbG9uZSApIHsKCQkJCQkJbm9kZSA9IGpRdWVyeS5jbG9uZSggbm9kZSwgdHJ1ZSwgdHJ1ZSApOwoKCQkJCQkJLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgoJCQkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgY29yZV9wdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCgkJCQkJCQlqUXVlcnkubWVyZ2UoIHNjcmlwdHMsIGdldEFsbCggbm9kZSwgInNjcmlwdCIgKSApOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQljYWxsYmFjay5jYWxsKCB0aGlzWyBpIF0sIG5vZGUsIGkgKTsKCQkJCX0KCgkJCQlpZiAoIGhhc1NjcmlwdHMgKSB7CgkJCQkJZG9jID0gc2NyaXB0c1sgc2NyaXB0cy5sZW5ndGggLSAxIF0ub3duZXJEb2N1bWVudDsKCgkJCQkJLy8gUmVlbmFibGUgc2NyaXB0cwoJCQkJCWpRdWVyeS5tYXAoIHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQgKTsKCgkJCQkJLy8gRXZhbHVhdGUgZXhlY3V0YWJsZSBzY3JpcHRzIG9uIGZpcnN0IGRvY3VtZW50IGluc2VydGlvbgoJCQkJCWZvciAoIGkgPSAwOyBpIDwgaGFzU2NyaXB0czsgaSsrICkgewoJCQkJCQlub2RlID0gc2NyaXB0c1sgaSBdOwoJCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIG5vZGUudHlwZSB8fCAiIiApICYmCgkJCQkJCQkhZGF0YV9wcml2LmFjY2Vzcyggbm9kZSwgImdsb2JhbEV2YWwiICkgJiYgalF1ZXJ5LmNvbnRhaW5zKCBkb2MsIG5vZGUgKSApIHsKCgkJCQkJCQlpZiAoIG5vZGUuc3JjICkgewoJCQkJCQkJCS8vIEhvcGUgYWpheCBpcyBhdmFpbGFibGUuLi4KCQkJCQkJCQlqUXVlcnkuX2V2YWxVcmwoIG5vZGUuc3JjICk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWpRdWVyeS5nbG9iYWxFdmFsKCBub2RlLnRleHRDb250ZW50LnJlcGxhY2UoIHJjbGVhblNjcmlwdCwgIiIgKSApOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KfSk7CgpqUXVlcnkuZWFjaCh7CglhcHBlbmRUbzogImFwcGVuZCIsCglwcmVwZW5kVG86ICJwcmVwZW5kIiwKCWluc2VydEJlZm9yZTogImJlZm9yZSIsCglpbnNlcnRBZnRlcjogImFmdGVyIiwKCXJlcGxhY2VBbGw6ICJyZXBsYWNlV2l0aCIKfSwgZnVuY3Rpb24oIG5hbWUsIG9yaWdpbmFsICkgewoJalF1ZXJ5LmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJdmFyIGVsZW1zLAoJCQlyZXQgPSBbXSwKCQkJaW5zZXJ0ID0galF1ZXJ5KCBzZWxlY3RvciApLAoJCQlsYXN0ID0gaW5zZXJ0Lmxlbmd0aCAtIDEsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IGkgPD0gbGFzdDsgaSsrICkgewoJCQllbGVtcyA9IGkgPT09IGxhc3QgPyB0aGlzIDogdGhpcy5jbG9uZSggdHJ1ZSApOwoJCQlqUXVlcnkoIGluc2VydFsgaSBdIClbIG9yaWdpbmFsIF0oIGVsZW1zICk7CgoJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkvLyAuZ2V0KCkgYmVjYXVzZSBjb3JlX3B1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3MKCQkJY29yZV9wdXNoLmFwcGx5KCByZXQsIGVsZW1zLmdldCgpICk7CgkJfQoKCQlyZXR1cm4gdGhpcy5wdXNoU3RhY2soIHJldCApOwoJfTsKfSk7CgpqUXVlcnkuZXh0ZW5kKHsKCWNsb25lOiBmdW5jdGlvbiggZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJdmFyIGksIGwsIHNyY0VsZW1lbnRzLCBkZXN0RWxlbWVudHMsCgkJCWNsb25lID0gZWxlbS5jbG9uZU5vZGUoIHRydWUgKSwKCQkJaW5QYWdlID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJLy8gU3VwcG9ydDogSUUgPj0gOQoJCS8vIEZpeCBDbG9uaW5nIGlzc3VlcwoJCWlmICggIWpRdWVyeS5zdXBwb3J0Lm5vQ2xvbmVDaGVja2VkICYmICggZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSApICYmICFqUXVlcnkuaXNYTUxEb2MoIGVsZW0gKSApIHsKCgkJCS8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cDovL2pzcGVyZi5jb20vZ2V0YWxsLXZzLXNpenpsZS8yCgkJCWRlc3RFbGVtZW50cyA9IGdldEFsbCggY2xvbmUgKTsKCQkJc3JjRWxlbWVudHMgPSBnZXRBbGwoIGVsZW0gKTsKCgkJCWZvciAoIGkgPSAwLCBsID0gc3JjRWxlbWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJZml4SW5wdXQoIHNyY0VsZW1lbnRzWyBpIF0sIGRlc3RFbGVtZW50c1sgaSBdICk7CgkJCX0KCQl9CgoJCS8vIENvcHkgdGhlIGV2ZW50cyBmcm9tIHRoZSBvcmlnaW5hbCB0byB0aGUgY2xvbmUKCQlpZiAoIGRhdGFBbmRFdmVudHMgKSB7CgkJCWlmICggZGVlcERhdGFBbmRFdmVudHMgKSB7CgkJCQlzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbCggZWxlbSApOwoJCQkJZGVzdEVsZW1lbnRzID0gZGVzdEVsZW1lbnRzIHx8IGdldEFsbCggY2xvbmUgKTsKCgkJCQlmb3IgKCBpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyApIHsKCQkJCQljbG9uZUNvcHlFdmVudCggc3JjRWxlbWVudHNbIGkgXSwgZGVzdEVsZW1lbnRzWyBpIF0gKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCWNsb25lQ29weUV2ZW50KCBlbGVtLCBjbG9uZSApOwoJCQl9CgkJfQoKCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJZGVzdEVsZW1lbnRzID0gZ2V0QWxsKCBjbG9uZSwgInNjcmlwdCIgKTsKCQlpZiAoIGRlc3RFbGVtZW50cy5sZW5ndGggPiAwICkgewoJCQlzZXRHbG9iYWxFdmFsKCBkZXN0RWxlbWVudHMsICFpblBhZ2UgJiYgZ2V0QWxsKCBlbGVtLCAic2NyaXB0IiApICk7CgkJfQoKCQkvLyBSZXR1cm4gdGhlIGNsb25lZCBzZXQKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uKCBlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uICkgewoJCXZhciBlbGVtLCB0bXAsIHRhZywgd3JhcCwgY29udGFpbnMsIGosCgkJCWkgPSAwLAoJCQlsID0gZWxlbXMubGVuZ3RoLAoJCQlmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAoJCQlub2RlcyA9IFtdOwoKCQlmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJCWVsZW0gPSBlbGVtc1sgaSBdOwoKCQkJaWYgKCBlbGVtIHx8IGVsZW0gPT09IDAgKSB7CgoJCQkJLy8gQWRkIG5vZGVzIGRpcmVjdGx5CgkJCQlpZiAoIGpRdWVyeS50eXBlKCBlbGVtICkgPT09ICJvYmplY3QiICkgewoJCQkJCS8vIFN1cHBvcnQ6IFF0V2ViS2l0CgkJCQkJLy8galF1ZXJ5Lm1lcmdlIGJlY2F1c2UgY29yZV9wdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzCgkJCQkJalF1ZXJ5Lm1lcmdlKCBub2RlcywgZWxlbS5ub2RlVHlwZSA/IFsgZWxlbSBdIDogZWxlbSApOwoKCQkJCS8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQoJCQkJfSBlbHNlIGlmICggIXJodG1sLnRlc3QoIGVsZW0gKSApIHsKCQkJCQlub2Rlcy5wdXNoKCBjb250ZXh0LmNyZWF0ZVRleHROb2RlKCBlbGVtICkgKTsKCgkJCQkvLyBDb252ZXJ0IGh0bWwgaW50byBET00gbm9kZXMKCQkJCX0gZWxzZSB7CgkJCQkJdG1wID0gdG1wIHx8IGZyYWdtZW50LmFwcGVuZENoaWxkKCBjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpICk7CgoJCQkJCS8vIERlc2VyaWFsaXplIGEgc3RhbmRhcmQgcmVwcmVzZW50YXRpb24KCQkJCQl0YWcgPSAoIHJ0YWdOYW1lLmV4ZWMoIGVsZW0gKSB8fCBbIiIsICIiXSApWyAxIF0udG9Mb3dlckNhc2UoKTsKCQkJCQl3cmFwID0gd3JhcE1hcFsgdGFnIF0gfHwgd3JhcE1hcC5fZGVmYXVsdDsKCQkJCQl0bXAuaW5uZXJIVE1MID0gd3JhcFsgMSBdICsgZWxlbS5yZXBsYWNlKCByeGh0bWxUYWcsICI8JDE+PC8kMj4iICkgKyB3cmFwWyAyIF07CgoJCQkJCS8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAoJCQkJCWogPSB3cmFwWyAwIF07CgkJCQkJd2hpbGUgKCBqLS0gKSB7CgkJCQkJCXRtcCA9IHRtcC5sYXN0Q2hpbGQ7CgkJCQkJfQoKCQkJCQkvLyBTdXBwb3J0OiBRdFdlYktpdAoJCQkJCS8vIGpRdWVyeS5tZXJnZSBiZWNhdXNlIGNvcmVfcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cwoJCQkJCWpRdWVyeS5tZXJnZSggbm9kZXMsIHRtcC5jaGlsZE5vZGVzICk7CgoJCQkJCS8vIFJlbWVtYmVyIHRoZSB0b3AtbGV2ZWwgY29udGFpbmVyCgkJCQkJdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCgkJCQkJLy8gRml4ZXMgIzEyMzQ2CgkJCQkJLy8gU3VwcG9ydDogV2Via2l0LCBJRQoJCQkJCXRtcC50ZXh0Q29udGVudCA9ICIiOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBSZW1vdmUgd3JhcHBlciBmcm9tIGZyYWdtZW50CgkJZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKCgkJaSA9IDA7CgkJd2hpbGUgKCAoZWxlbSA9IG5vZGVzWyBpKysgXSkgKSB7CgoJCQkvLyAjNDA4NyAtIElmIG9yaWdpbiBhbmQgZGVzdGluYXRpb24gZWxlbWVudHMgYXJlIHRoZSBzYW1lLCBhbmQgdGhpcyBpcwoJCQkvLyB0aGF0IGVsZW1lbnQsIGRvIG5vdCBkbyBhbnl0aGluZwoJCQlpZiAoIHNlbGVjdGlvbiAmJiBqUXVlcnkuaW5BcnJheSggZWxlbSwgc2VsZWN0aW9uICkgIT09IC0xICkgewoJCQkJY29udGludWU7CgkJCX0KCgkJCWNvbnRhaW5zID0galF1ZXJ5LmNvbnRhaW5zKCBlbGVtLm93bmVyRG9jdW1lbnQsIGVsZW0gKTsKCgkJCS8vIEFwcGVuZCB0byBmcmFnbWVudAoJCQl0bXAgPSBnZXRBbGwoIGZyYWdtZW50LmFwcGVuZENoaWxkKCBlbGVtICksICJzY3JpcHQiICk7CgoJCQkvLyBQcmVzZXJ2ZSBzY3JpcHQgZXZhbHVhdGlvbiBoaXN0b3J5CgkJCWlmICggY29udGFpbnMgKSB7CgkJCQlzZXRHbG9iYWxFdmFsKCB0bXAgKTsKCQkJfQoKCQkJLy8gQ2FwdHVyZSBleGVjdXRhYmxlcwoJCQlpZiAoIHNjcmlwdHMgKSB7CgkJCQlqID0gMDsKCQkJCXdoaWxlICggKGVsZW0gPSB0bXBbIGorKyBdKSApIHsKCQkJCQlpZiAoIHJzY3JpcHRUeXBlLnRlc3QoIGVsZW0udHlwZSB8fCAiIiApICkgewoJCQkJCQlzY3JpcHRzLnB1c2goIGVsZW0gKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBmcmFnbWVudDsKCX0sCgoJY2xlYW5EYXRhOiBmdW5jdGlvbiggZWxlbXMgKSB7CgkJdmFyIGRhdGEsIGVsZW0sIGV2ZW50cywgdHlwZSwga2V5LCBqLAoJCQlzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWwsCgkJCWkgPSAwOwoKCQlmb3IgKCA7IChlbGVtID0gZWxlbXNbIGkgXSkgIT09IHVuZGVmaW5lZDsgaSsrICkgewoJCQlpZiAoIERhdGEuYWNjZXB0cyggZWxlbSApICkgewoJCQkJa2V5ID0gZWxlbVsgZGF0YV9wcml2LmV4cGFuZG8gXTsKCgkJCQlpZiAoIGtleSAmJiAoZGF0YSA9IGRhdGFfcHJpdi5jYWNoZVsga2V5IF0pICkgewoJCQkJCWV2ZW50cyA9IE9iamVjdC5rZXlzKCBkYXRhLmV2ZW50cyB8fCB7fSApOwoJCQkJCWlmICggZXZlbnRzLmxlbmd0aCApIHsKCQkJCQkJZm9yICggaiA9IDA7ICh0eXBlID0gZXZlbnRzW2pdKSAhPT0gdW5kZWZpbmVkOyBqKysgKSB7CgkJCQkJCQlpZiAoIHNwZWNpYWxbIHR5cGUgXSApIHsKCQkJCQkJCQlqUXVlcnkuZXZlbnQucmVtb3ZlKCBlbGVtLCB0eXBlICk7CgoJCQkJCQkJLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlqUXVlcnkucmVtb3ZlRXZlbnQoIGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlICk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKCBkYXRhX3ByaXYuY2FjaGVbIGtleSBdICkgewoJCQkJCQkvLyBEaXNjYXJkIGFueSByZW1haW5pbmcgYHByaXZhdGVgIGRhdGEKCQkJCQkJZGVsZXRlIGRhdGFfcHJpdi5jYWNoZVsga2V5IF07CgkJCQkJfQoJCQkJfQoJCQl9CgkJCS8vIERpc2NhcmQgYW55IHJlbWFpbmluZyBgdXNlcmAgZGF0YQoJCQlkZWxldGUgZGF0YV91c2VyLmNhY2hlWyBlbGVtWyBkYXRhX3VzZXIuZXhwYW5kbyBdIF07CgkJfQoJfSwKCglfZXZhbFVybDogZnVuY3Rpb24oIHVybCApIHsKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCQkJdHlwZTogIkdFVCIsCgkJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQkJYXN5bmM6IGZhbHNlLAoJCQlnbG9iYWw6IGZhbHNlLAoJCQkidGhyb3dzIjogdHJ1ZQoJCX0pOwoJfQp9KTsKCi8vIFN1cHBvcnQ6IDEueCBjb21wYXRpYmlsaXR5Ci8vIE1hbmlwdWxhdGluZyB0YWJsZXMgcmVxdWlyZXMgYSB0Ym9keQpmdW5jdGlvbiBtYW5pcHVsYXRpb25UYXJnZXQoIGVsZW0sIGNvbnRlbnQgKSB7CglyZXR1cm4galF1ZXJ5Lm5vZGVOYW1lKCBlbGVtLCAidGFibGUiICkgJiYKCQlqUXVlcnkubm9kZU5hbWUoIGNvbnRlbnQubm9kZVR5cGUgPT09IDEgPyBjb250ZW50IDogY29udGVudC5maXJzdENoaWxkLCAidHIiICkgPwoKCQllbGVtLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJ0Ym9keSIpWzBdIHx8CgkJCWVsZW0uYXBwZW5kQ2hpbGQoIGVsZW0ub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ0Ym9keSIpICkgOgoJCWVsZW07Cn0KCi8vIFJlcGxhY2UvcmVzdG9yZSB0aGUgdHlwZSBhdHRyaWJ1dGUgb2Ygc2NyaXB0IGVsZW1lbnRzIGZvciBzYWZlIERPTSBtYW5pcHVsYXRpb24KZnVuY3Rpb24gZGlzYWJsZVNjcmlwdCggZWxlbSApIHsKCWVsZW0udHlwZSA9IChlbGVtLmdldEF0dHJpYnV0ZSgidHlwZSIpICE9PSBudWxsKSArICIvIiArIGVsZW0udHlwZTsKCXJldHVybiBlbGVtOwp9CmZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoIGVsZW0gKSB7Cgl2YXIgbWF0Y2ggPSByc2NyaXB0VHlwZU1hc2tlZC5leGVjKCBlbGVtLnR5cGUgKTsKCglpZiAoIG1hdGNoICkgewoJCWVsZW0udHlwZSA9IG1hdGNoWyAxIF07Cgl9IGVsc2UgewoJCWVsZW0ucmVtb3ZlQXR0cmlidXRlKCJ0eXBlIik7Cgl9CgoJcmV0dXJuIGVsZW07Cn0KCi8vIE1hcmsgc2NyaXB0cyBhcyBoYXZpbmcgYWxyZWFkeSBiZWVuIGV2YWx1YXRlZApmdW5jdGlvbiBzZXRHbG9iYWxFdmFsKCBlbGVtcywgcmVmRWxlbWVudHMgKSB7Cgl2YXIgbCA9IGVsZW1zLmxlbmd0aCwKCQlpID0gMDsKCglmb3IgKCA7IGkgPCBsOyBpKysgKSB7CgkJZGF0YV9wcml2LnNldCgKCQkJZWxlbXNbIGkgXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YV9wcml2LmdldCggcmVmRWxlbWVudHNbIGkgXSwgImdsb2JhbEV2YWwiICkKCQkpOwoJfQp9CgpmdW5jdGlvbiBjbG9uZUNvcHlFdmVudCggc3JjLCBkZXN0ICkgewoJdmFyIGksIGwsIHR5cGUsIHBkYXRhT2xkLCBwZGF0YUN1ciwgdWRhdGFPbGQsIHVkYXRhQ3VyLCBldmVudHM7CgoJaWYgKCBkZXN0Lm5vZGVUeXBlICE9PSAxICkgewoJCXJldHVybjsKCX0KCgkvLyAxLiBDb3B5IHByaXZhdGUgZGF0YTogZXZlbnRzLCBoYW5kbGVycywgZXRjLgoJaWYgKCBkYXRhX3ByaXYuaGFzRGF0YSggc3JjICkgKSB7CgkJcGRhdGFPbGQgPSBkYXRhX3ByaXYuYWNjZXNzKCBzcmMgKTsKCQlwZGF0YUN1ciA9IGRhdGFfcHJpdi5zZXQoIGRlc3QsIHBkYXRhT2xkICk7CgkJZXZlbnRzID0gcGRhdGFPbGQuZXZlbnRzOwoKCQlpZiAoIGV2ZW50cyApIHsKCQkJZGVsZXRlIHBkYXRhQ3VyLmhhbmRsZTsKCQkJcGRhdGFDdXIuZXZlbnRzID0ge307CgoJCQlmb3IgKCB0eXBlIGluIGV2ZW50cyApIHsKCQkJCWZvciAoIGkgPSAwLCBsID0gZXZlbnRzWyB0eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrICkgewoJCQkJCWpRdWVyeS5ldmVudC5hZGQoIGRlc3QsIHR5cGUsIGV2ZW50c1sgdHlwZSBdWyBpIF0gKTsKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyAyLiBDb3B5IHVzZXIgZGF0YQoJaWYgKCBkYXRhX3VzZXIuaGFzRGF0YSggc3JjICkgKSB7CgkJdWRhdGFPbGQgPSBkYXRhX3VzZXIuYWNjZXNzKCBzcmMgKTsKCQl1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoIHt9LCB1ZGF0YU9sZCApOwoKCQlkYXRhX3VzZXIuc2V0KCBkZXN0LCB1ZGF0YUN1ciApOwoJfQp9CgoKZnVuY3Rpb24gZ2V0QWxsKCBjb250ZXh0LCB0YWcgKSB7Cgl2YXIgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSA/IGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIHRhZyB8fCAiKiIgKSA6CgkJCWNvbnRleHQucXVlcnlTZWxlY3RvckFsbCA/IGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCggdGFnIHx8ICIqIiApIDoKCQkJW107CgoJcmV0dXJuIHRhZyA9PT0gdW5kZWZpbmVkIHx8IHRhZyAmJiBqUXVlcnkubm9kZU5hbWUoIGNvbnRleHQsIHRhZyApID8KCQlqUXVlcnkubWVyZ2UoIFsgY29udGV4dCBdLCByZXQgKSA6CgkJcmV0Owp9CgovLyBTdXBwb3J0OiBJRSA+PSA5CmZ1bmN0aW9uIGZpeElucHV0KCBzcmMsIGRlc3QgKSB7Cgl2YXIgbm9kZU5hbWUgPSBkZXN0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgoJLy8gRmFpbHMgdG8gcGVyc2lzdCB0aGUgY2hlY2tlZCBzdGF0ZSBvZiBhIGNsb25lZCBjaGVja2JveCBvciByYWRpbyBidXR0b24uCglpZiAoIG5vZGVOYW1lID09PSAiaW5wdXQiICYmIG1hbmlwdWxhdGlvbl9yY2hlY2thYmxlVHlwZS50ZXN0KCBzcmMudHlwZSApICkgewoJCWRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOwoKCS8vIEZhaWxzIHRvIHJldHVybiB0aGUgc2VsZWN0ZWQgb3B0aW9uIHRvIHRoZSBkZWZhdWx0IHNlbGVjdGVkIHN0YXRlIHdoZW4gY2xvbmluZyBvcHRpb25zCgl9IGVsc2UgaWYgKCBub2RlTmFtZSA9PT0gImlucHV0IiB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiApIHsKCQlkZXN0LmRlZmF1bHRWYWx1ZSA9IHNyYy5kZWZhdWx0VmFsdWU7Cgl9Cn0KalF1ZXJ5LmZuLmV4dGVuZCh7Cgl3cmFwQWxsOiBmdW5jdGlvbiggaHRtbCApIHsKCQl2YXIgd3JhcDsKCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApICkgewoJCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQkJalF1ZXJ5KCB0aGlzICkud3JhcEFsbCggaHRtbC5jYWxsKHRoaXMsIGkpICk7CgkJCX0pOwoJCX0KCgkJaWYgKCB0aGlzWyAwIF0gKSB7CgoJCQkvLyBUaGUgZWxlbWVudHMgdG8gd3JhcCB0aGUgdGFyZ2V0IGFyb3VuZAoJCQl3cmFwID0galF1ZXJ5KCBodG1sLCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCApLmVxKCAwICkuY2xvbmUoIHRydWUgKTsKCgkJCWlmICggdGhpc1sgMCBdLnBhcmVudE5vZGUgKSB7CgkJCQl3cmFwLmluc2VydEJlZm9yZSggdGhpc1sgMCBdICk7CgkJCX0KCgkJCXdyYXAubWFwKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSB0aGlzOwoKCQkJCXdoaWxlICggZWxlbS5maXJzdEVsZW1lbnRDaGlsZCApIHsKCQkJCQllbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKCQkJCX0KCgkJCQlyZXR1cm4gZWxlbTsKCQkJfSkuYXBwZW5kKCB0aGlzICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcElubmVyOiBmdW5jdGlvbiggaHRtbCApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBodG1sICkgKSB7CgkJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oIGkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS53cmFwSW5uZXIoIGh0bWwuY2FsbCh0aGlzLCBpKSApOwoJCQl9KTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0galF1ZXJ5KCB0aGlzICksCgkJCQljb250ZW50cyA9IHNlbGYuY29udGVudHMoKTsKCgkJCWlmICggY29udGVudHMubGVuZ3RoICkgewoJCQkJY29udGVudHMud3JhcEFsbCggaHRtbCApOwoKCQkJfSBlbHNlIHsKCQkJCXNlbGYuYXBwZW5kKCBodG1sICk7CgkJCX0KCQl9KTsKCX0sCgoJd3JhcDogZnVuY3Rpb24oIGh0bWwgKSB7CgkJdmFyIGlzRnVuY3Rpb24gPSBqUXVlcnkuaXNGdW5jdGlvbiggaHRtbCApOwoKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCBpICkgewoJCQlqUXVlcnkoIHRoaXMgKS53cmFwQWxsKCBpc0Z1bmN0aW9uID8gaHRtbC5jYWxsKHRoaXMsIGkpIDogaHRtbCApOwoJCX0pOwoJfSwKCgl1bndyYXA6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnBhcmVudCgpLmVhY2goZnVuY3Rpb24oKSB7CgkJCWlmICggIWpRdWVyeS5ub2RlTmFtZSggdGhpcywgImJvZHkiICkgKSB7CgkJCQlqUXVlcnkoIHRoaXMgKS5yZXBsYWNlV2l0aCggdGhpcy5jaGlsZE5vZGVzICk7CgkJCX0KCQl9KS5lbmQoKTsKCX0KfSk7CnZhciBjdXJDU1MsIGlmcmFtZSwKCS8vIHN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUgZXhjZXB0ICJ0YWJsZSIsICJ0YWJsZS1jZWxsIiwgb3IgInRhYmxlLWNhcHRpb24iCgkvLyBzZWUgaGVyZSBmb3IgZGlzcGxheSB2YWx1ZXM6IGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvQ1NTL2Rpc3BsYXkKCXJkaXNwbGF5c3dhcCA9IC9eKG5vbmV8dGFibGUoPyEtY1tlYV0pLispLywKCXJtYXJnaW4gPSAvXm1hcmdpbi8sCglybnVtc3BsaXQgPSBuZXcgUmVnRXhwKCAiXigiICsgY29yZV9wbnVtICsgIikoLiopJCIsICJpIiApLAoJcm51bW5vbnB4ID0gbmV3IFJlZ0V4cCggIl4oIiArIGNvcmVfcG51bSArICIpKD8hcHgpW2EteiVdKyQiLCAiaSIgKSwKCXJyZWxOdW0gPSBuZXcgUmVnRXhwKCAiXihbKy1dKT0oIiArIGNvcmVfcG51bSArICIpIiwgImkiICksCgllbGVtZGlzcGxheSA9IHsgQk9EWTogImJsb2NrIiB9LAoKCWNzc1Nob3cgPSB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCB2aXNpYmlsaXR5OiAiaGlkZGVuIiwgZGlzcGxheTogImJsb2NrIiB9LAoJY3NzTm9ybWFsVHJhbnNmb3JtID0gewoJCWxldHRlclNwYWNpbmc6IDAsCgkJZm9udFdlaWdodDogNDAwCgl9LAoKCWNzc0V4cGFuZCA9IFsgIlRvcCIsICJSaWdodCIsICJCb3R0b20iLCAiTGVmdCIgXSwKCWNzc1ByZWZpeGVzID0gWyAiV2Via2l0IiwgIk8iLCAiTW96IiwgIm1zIiBdOwoKLy8gcmV0dXJuIGEgY3NzIHByb3BlcnR5IG1hcHBlZCB0byBhIHBvdGVudGlhbGx5IHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQpmdW5jdGlvbiB2ZW5kb3JQcm9wTmFtZSggc3R5bGUsIG5hbWUgKSB7CgoJLy8gc2hvcnRjdXQgZm9yIG5hbWVzIHRoYXQgYXJlIG5vdCB2ZW5kb3IgcHJlZml4ZWQKCWlmICggbmFtZSBpbiBzdHlsZSApIHsKCQlyZXR1cm4gbmFtZTsKCX0KCgkvLyBjaGVjayBmb3IgdmVuZG9yIHByZWZpeGVkIG5hbWVzCgl2YXIgY2FwTmFtZSA9IG5hbWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBuYW1lLnNsaWNlKDEpLAoJCW9yaWdOYW1lID0gbmFtZSwKCQlpID0gY3NzUHJlZml4ZXMubGVuZ3RoOwoKCXdoaWxlICggaS0tICkgewoJCW5hbWUgPSBjc3NQcmVmaXhlc1sgaSBdICsgY2FwTmFtZTsKCQlpZiAoIG5hbWUgaW4gc3R5bGUgKSB7CgkJCXJldHVybiBuYW1lOwoJCX0KCX0KCglyZXR1cm4gb3JpZ05hbWU7Cn0KCmZ1bmN0aW9uIGlzSGlkZGVuKCBlbGVtLCBlbCApIHsKCS8vIGlzSGlkZGVuIG1pZ2h0IGJlIGNhbGxlZCBmcm9tIGpRdWVyeSNmaWx0ZXIgZnVuY3Rpb247CgkvLyBpbiB0aGF0IGNhc2UsIGVsZW1lbnQgd2lsbCBiZSBzZWNvbmQgYXJndW1lbnQKCWVsZW0gPSBlbCB8fCBlbGVtOwoJcmV0dXJuIGpRdWVyeS5jc3MoIGVsZW0sICJkaXNwbGF5IiApID09PSAibm9uZSIgfHwgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICk7Cn0KCi8vIE5PVEU6IHdlJ3ZlIGluY2x1ZGVkIHRoZSAid2luZG93IiBpbiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZQovLyBiZWNhdXNlIGpzZG9tIG9uIG5vZGUuanMgd2lsbCBicmVhayB3aXRob3V0IGl0LgpmdW5jdGlvbiBnZXRTdHlsZXMoIGVsZW0gKSB7CglyZXR1cm4gd2luZG93LmdldENvbXB1dGVkU3R5bGUoIGVsZW0sIG51bGwgKTsKfQoKZnVuY3Rpb24gc2hvd0hpZGUoIGVsZW1lbnRzLCBzaG93ICkgewoJdmFyIGRpc3BsYXksIGVsZW0sIGhpZGRlbiwKCQl2YWx1ZXMgPSBbXSwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gZWxlbWVudHMubGVuZ3RoOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCgkJdmFsdWVzWyBpbmRleCBdID0gZGF0YV9wcml2LmdldCggZWxlbSwgIm9sZGRpc3BsYXkiICk7CgkJZGlzcGxheSA9IGVsZW0uc3R5bGUuZGlzcGxheTsKCQlpZiAoIHNob3cgKSB7CgkJCS8vIFJlc2V0IHRoZSBpbmxpbmUgZGlzcGxheSBvZiB0aGlzIGVsZW1lbnQgdG8gbGVhcm4gaWYgaXQgaXMKCQkJLy8gYmVpbmcgaGlkZGVuIGJ5IGNhc2NhZGVkIHJ1bGVzIG9yIG5vdAoJCQlpZiAoICF2YWx1ZXNbIGluZGV4IF0gJiYgZGlzcGxheSA9PT0gIm5vbmUiICkgewoJCQkJZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CgkJCX0KCgkJCS8vIFNldCBlbGVtZW50cyB3aGljaCBoYXZlIGJlZW4gb3ZlcnJpZGRlbiB3aXRoIGRpc3BsYXk6IG5vbmUKCQkJLy8gaW4gYSBzdHlsZXNoZWV0IHRvIHdoYXRldmVyIHRoZSBkZWZhdWx0IGJyb3dzZXIgc3R5bGUgaXMKCQkJLy8gZm9yIHN1Y2ggYW4gZWxlbWVudAoJCQlpZiAoIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYgaXNIaWRkZW4oIGVsZW0gKSApIHsKCQkJCXZhbHVlc1sgaW5kZXggXSA9IGRhdGFfcHJpdi5hY2Nlc3MoIGVsZW0sICJvbGRkaXNwbGF5IiwgY3NzX2RlZmF1bHREaXNwbGF5KGVsZW0ubm9kZU5hbWUpICk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKCAhdmFsdWVzWyBpbmRleCBdICkgewoJCQkJaGlkZGVuID0gaXNIaWRkZW4oIGVsZW0gKTsKCgkJCQlpZiAoIGRpc3BsYXkgJiYgZGlzcGxheSAhPT0gIm5vbmUiIHx8ICFoaWRkZW4gKSB7CgkJCQkJZGF0YV9wcml2LnNldCggZWxlbSwgIm9sZGRpc3BsYXkiLCBoaWRkZW4gPyBkaXNwbGF5IDogalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpICk7CgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gU2V0IHRoZSBkaXNwbGF5IG9mIG1vc3Qgb2YgdGhlIGVsZW1lbnRzIGluIGEgc2Vjb25kIGxvb3AKCS8vIHRvIGF2b2lkIHRoZSBjb25zdGFudCByZWZsb3cKCWZvciAoIGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KysgKSB7CgkJZWxlbSA9IGVsZW1lbnRzWyBpbmRleCBdOwoJCWlmICggIWVsZW0uc3R5bGUgKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpZiAoICFzaG93IHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgKSB7CgkJCWVsZW0uc3R5bGUuZGlzcGxheSA9IHNob3cgPyB2YWx1ZXNbIGluZGV4IF0gfHwgIiIgOiAibm9uZSI7CgkJfQoJfQoKCXJldHVybiBlbGVtZW50czsKfQoKalF1ZXJ5LmZuLmV4dGVuZCh7Cgljc3M6IGZ1bmN0aW9uKCBuYW1lLCB2YWx1ZSApIHsKCQlyZXR1cm4galF1ZXJ5LmFjY2VzcyggdGhpcywgZnVuY3Rpb24oIGVsZW0sIG5hbWUsIHZhbHVlICkgewoJCQl2YXIgc3R5bGVzLCBsZW4sCgkJCQltYXAgPSB7fSwKCQkJCWkgPSAwOwoKCQkJaWYgKCBqUXVlcnkuaXNBcnJheSggbmFtZSApICkgewoJCQkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICk7CgkJCQlsZW4gPSBuYW1lLmxlbmd0aDsKCgkJCQlmb3IgKCA7IGkgPCBsZW47IGkrKyApIHsKCQkJCQltYXBbIG5hbWVbIGkgXSBdID0galF1ZXJ5LmNzcyggZWxlbSwgbmFtZVsgaSBdLCBmYWxzZSwgc3R5bGVzICk7CgkJCQl9CgoJCQkJcmV0dXJuIG1hcDsKCQkJfQoKCQkJcmV0dXJuIHZhbHVlICE9PSB1bmRlZmluZWQgPwoJCQkJalF1ZXJ5LnN0eWxlKCBlbGVtLCBuYW1lLCB2YWx1ZSApIDoKCQkJCWpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKTsKCQl9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgKTsKCX0sCglzaG93OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMsIHRydWUgKTsKCX0sCgloaWRlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gc2hvd0hpZGUoIHRoaXMgKTsKCX0sCgl0b2dnbGU6IGZ1bmN0aW9uKCBzdGF0ZSApIHsKCQlpZiAoIHR5cGVvZiBzdGF0ZSA9PT0gImJvb2xlYW4iICkgewoJCQlyZXR1cm4gc3RhdGUgPyB0aGlzLnNob3coKSA6IHRoaXMuaGlkZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCBpc0hpZGRlbiggdGhpcyApICkgewoJCQkJalF1ZXJ5KCB0aGlzICkuc2hvdygpOwoJCQl9IGVsc2UgewoJCQkJalF1ZXJ5KCB0aGlzICkuaGlkZSgpOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKalF1ZXJ5LmV4dGVuZCh7CgkvLyBBZGQgaW4gc3R5bGUgcHJvcGVydHkgaG9va3MgZm9yIG92ZXJyaWRpbmcgdGhlIGRlZmF1bHQKCS8vIGJlaGF2aW9yIG9mIGdldHRpbmcgYW5kIHNldHRpbmcgYSBzdHlsZSBwcm9wZXJ0eQoJY3NzSG9va3M6IHsKCQlvcGFjaXR5OiB7CgkJCWdldDogZnVuY3Rpb24oIGVsZW0sIGNvbXB1dGVkICkgewoJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQoJCQkJCXZhciByZXQgPSBjdXJDU1MoIGVsZW0sICJvcGFjaXR5IiApOwoJCQkJCXJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwoJCQkJfQoJCQl9CgkJfQoJfSwKCgkvLyBEb24ndCBhdXRvbWF0aWNhbGx5IGFkZCAicHgiIHRvIHRoZXNlIHBvc3NpYmx5LXVuaXRsZXNzIHByb3BlcnRpZXMKCWNzc051bWJlcjogewoJCSJjb2x1bW5Db3VudCI6IHRydWUsCgkJImZpbGxPcGFjaXR5IjogdHJ1ZSwKCQkiZm9udFdlaWdodCI6IHRydWUsCgkJImxpbmVIZWlnaHQiOiB0cnVlLAoJCSJvcGFjaXR5IjogdHJ1ZSwKCQkib3JkZXIiOiB0cnVlLAoJCSJvcnBoYW5zIjogdHJ1ZSwKCQkid2lkb3dzIjogdHJ1ZSwKCQkiekluZGV4IjogdHJ1ZSwKCQkiem9vbSI6IHRydWUKCX0sCgoJLy8gQWRkIGluIHByb3BlcnRpZXMgd2hvc2UgbmFtZXMgeW91IHdpc2ggdG8gZml4IGJlZm9yZQoJLy8gc2V0dGluZyBvciBnZXR0aW5nIHRoZSB2YWx1ZQoJY3NzUHJvcHM6IHsKCQkvLyBub3JtYWxpemUgZmxvYXQgY3NzIHByb3BlcnR5CgkJImZsb2F0IjogImNzc0Zsb2F0IgoJfSwKCgkvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQoJc3R5bGU6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEgKSB7CgkJLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCgkJaWYgKCAhZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQoJCXZhciByZXQsIHR5cGUsIGhvb2tzLAoJCQlvcmlnTmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIG5hbWUgKSwKCQkJc3R5bGUgPSBlbGVtLnN0eWxlOwoKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIHN0eWxlLCBvcmlnTmFtZSApICk7CgoJCS8vIGdldHMgaG9vayBmb3IgdGhlIHByZWZpeGVkIHZlcnNpb24KCQkvLyBmb2xsb3dlZCBieSB0aGUgdW5wcmVmaXhlZCB2ZXJzaW9uCgkJaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSB8fCBqUXVlcnkuY3NzSG9va3NbIG9yaWdOYW1lIF07CgoJCS8vIENoZWNrIGlmIHdlJ3JlIHNldHRpbmcgYSB2YWx1ZQoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCgkJCS8vIGNvbnZlcnQgcmVsYXRpdmUgbnVtYmVyIHN0cmluZ3MgKCs9IG9yIC09KSB0byByZWxhdGl2ZSBudW1iZXJzLiAjNzM0NQoJCQlpZiAoIHR5cGUgPT09ICJzdHJpbmciICYmIChyZXQgPSBycmVsTnVtLmV4ZWMoIHZhbHVlICkpICkgewoJCQkJdmFsdWUgPSAoIHJldFsxXSArIDEgKSAqIHJldFsyXSArIHBhcnNlRmxvYXQoIGpRdWVyeS5jc3MoIGVsZW0sIG5hbWUgKSApOwoJCQkJLy8gRml4ZXMgYnVnICM5MjM3CgkJCQl0eXBlID0gIm51bWJlciI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGF0IE5hTiBhbmQgbnVsbCB2YWx1ZXMgYXJlbid0IHNldC4gU2VlOiAjNzExNgoJCQlpZiAoIHZhbHVlID09IG51bGwgfHwgdHlwZSA9PT0gIm51bWJlciIgJiYgaXNOYU4oIHZhbHVlICkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGEgbnVtYmVyIHdhcyBwYXNzZWQgaW4sIGFkZCAncHgnIHRvIHRoZSAoZXhjZXB0IGZvciBjZXJ0YWluIENTUyBwcm9wZXJ0aWVzKQoJCQlpZiAoIHR5cGUgPT09ICJudW1iZXIiICYmICFqUXVlcnkuY3NzTnVtYmVyWyBvcmlnTmFtZSBdICkgewoJCQkJdmFsdWUgKz0gInB4IjsKCQkJfQoKCQkJLy8gRml4ZXMgIzg5MDgsIGl0IGNhbiBiZSBkb25lIG1vcmUgY29ycmVjdGx5IGJ5IHNwZWNpZnlpbmcgc2V0dGVycyBpbiBjc3NIb29rcywKCQkJLy8gYnV0IGl0IHdvdWxkIG1lYW4gdG8gZGVmaW5lIGVpZ2h0IChmb3IgZXZlcnkgcHJvYmxlbWF0aWMgcHJvcGVydHkpIGlkZW50aWNhbCBmdW5jdGlvbnMKCQkJaWYgKCAhalF1ZXJ5LnN1cHBvcnQuY2xlYXJDbG9uZVN0eWxlICYmIHZhbHVlID09PSAiIiAmJiBuYW1lLmluZGV4T2YoImJhY2tncm91bmQiKSA9PT0gMCApIHsKCQkJCXN0eWxlWyBuYW1lIF0gPSAiaW5oZXJpdCI7CgkJCX0KCgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQoJCQlpZiAoICFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCAodmFsdWUgPSBob29rcy5zZXQoIGVsZW0sIHZhbHVlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3R5bGVbIG5hbWUgXSA9IHZhbHVlOwoJCQl9CgoJCX0gZWxzZSB7CgkJCS8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBub24tY29tcHV0ZWQgdmFsdWUgZnJvbSB0aGVyZQoJCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoIGVsZW0sIGZhbHNlLCBleHRyYSApKSAhPT0gdW5kZWZpbmVkICkgewoJCQkJcmV0dXJuIHJldDsKCQkJfQoKCQkJLy8gT3RoZXJ3aXNlIGp1c3QgZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoZSBzdHlsZSBvYmplY3QKCQkJcmV0dXJuIHN0eWxlWyBuYW1lIF07CgkJfQoJfSwKCgljc3M6IGZ1bmN0aW9uKCBlbGVtLCBuYW1lLCBleHRyYSwgc3R5bGVzICkgewoJCXZhciB2YWwsIG51bSwgaG9va3MsCgkJCW9yaWdOYW1lID0galF1ZXJ5LmNhbWVsQ2FzZSggbmFtZSApOwoKCQkvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUKCQluYW1lID0galF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdIHx8ICggalF1ZXJ5LmNzc1Byb3BzWyBvcmlnTmFtZSBdID0gdmVuZG9yUHJvcE5hbWUoIGVsZW0uc3R5bGUsIG9yaWdOYW1lICkgKTsKCgkJLy8gZ2V0cyBob29rIGZvciB0aGUgcHJlZml4ZWQgdmVyc2lvbgoJCS8vIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIHZlcnNpb24KCQlob29rcyA9IGpRdWVyeS5jc3NIb29rc1sgbmFtZSBdIHx8IGpRdWVyeS5jc3NIb29rc1sgb3JpZ05hbWUgXTsKCgkJLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIGNvbXB1dGVkIHZhbHVlIGZyb20gdGhlcmUKCQlpZiAoIGhvb2tzICYmICJnZXQiIGluIGhvb2tzICkgewoJCQl2YWwgPSBob29rcy5nZXQoIGVsZW0sIHRydWUsIGV4dHJhICk7CgkJfQoKCQkvLyBPdGhlcndpc2UsIGlmIGEgd2F5IHRvIGdldCB0aGUgY29tcHV0ZWQgdmFsdWUgZXhpc3RzLCB1c2UgdGhhdAoJCWlmICggdmFsID09PSB1bmRlZmluZWQgKSB7CgkJCXZhbCA9IGN1ckNTUyggZWxlbSwgbmFtZSwgc3R5bGVzICk7CgkJfQoKCQkvL2NvbnZlcnQgIm5vcm1hbCIgdG8gY29tcHV0ZWQgdmFsdWUKCQlpZiAoIHZhbCA9PT0gIm5vcm1hbCIgJiYgbmFtZSBpbiBjc3NOb3JtYWxUcmFuc2Zvcm0gKSB7CgkJCXZhbCA9IGNzc05vcm1hbFRyYW5zZm9ybVsgbmFtZSBdOwoJCX0KCgkJLy8gUmV0dXJuLCBjb252ZXJ0aW5nIHRvIG51bWJlciBpZiBmb3JjZWQgb3IgYSBxdWFsaWZpZXIgd2FzIHByb3ZpZGVkIGFuZCB2YWwgbG9va3MgbnVtZXJpYwoJCWlmICggZXh0cmEgPT09ICIiIHx8IGV4dHJhICkgewoJCQludW0gPSBwYXJzZUZsb2F0KCB2YWwgKTsKCQkJcmV0dXJuIGV4dHJhID09PSB0cnVlIHx8IGpRdWVyeS5pc051bWVyaWMoIG51bSApID8gbnVtIHx8IDAgOiB2YWw7CgkJfQoJCXJldHVybiB2YWw7Cgl9Cn0pOwoKY3VyQ1NTID0gZnVuY3Rpb24oIGVsZW0sIG5hbWUsIF9jb21wdXRlZCApIHsKCXZhciB3aWR0aCwgbWluV2lkdGgsIG1heFdpZHRoLAoJCWNvbXB1dGVkID0gX2NvbXB1dGVkIHx8IGdldFN0eWxlcyggZWxlbSApLAoKCQkvLyBTdXBwb3J0OiBJRTkKCQkvLyBnZXRQcm9wZXJ0eVZhbHVlIGlzIG9ubHkgbmVlZGVkIGZvciAuY3NzKCdmaWx0ZXInKSBpbiBJRTksIHNlZSAjMTI1MzcKCQlyZXQgPSBjb21wdXRlZCA/IGNvbXB1dGVkLmdldFByb3BlcnR5VmFsdWUoIG5hbWUgKSB8fCBjb21wdXRlZFsgbmFtZSBdIDogdW5kZWZpbmVkLAoJCXN0eWxlID0gZWxlbS5zdHlsZTsKCglpZiAoIGNvbXB1dGVkICkgewoKCQlpZiAoIHJldCA9PT0gIiIgJiYgIWpRdWVyeS5jb250YWlucyggZWxlbS5vd25lckRvY3VtZW50LCBlbGVtICkgKSB7CgkJCXJldCA9IGpRdWVyeS5zdHlsZSggZWxlbSwgbmFtZSApOwoJCX0KCgkJLy8gU3VwcG9ydDogU2FmYXJpIDUuMQoJCS8vIEEgdHJpYnV0ZSB0byB0aGUgImF3ZXNvbWUgaGFjayBieSBEZWFuIEVkd2FyZHMiCgkJLy8gU2FmYXJpIDUuMS43IChhdCBsZWFzdCkgcmV0dXJucyBwZXJjZW50YWdlIGZvciBhIGxhcmdlciBzZXQgb2YgdmFsdWVzLCBidXQgd2lkdGggc2VlbXMgdG8gYmUgcmVsaWFibHkgcGl4ZWxzCgkJLy8gdGhpcyBpcyBhZ2FpbnN0IHRoZSBDU1NPTSBkcmFmdCBzcGVjOiBodHRwOi8vZGV2LnczLm9yZy9jc3N3Zy9jc3NvbS8jcmVzb2x2ZWQtdmFsdWVzCgkJaWYgKCBybnVtbm9ucHgudGVzdCggcmV0ICkgJiYgcm1hcmdpbi50ZXN0KCBuYW1lICkgKSB7CgoJCQkvLyBSZW1lbWJlciB0aGUgb3JpZ2luYWwgdmFsdWVzCgkJCXdpZHRoID0gc3R5bGUud2lkdGg7CgkJCW1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CgkJCW1heFdpZHRoID0gc3R5bGUubWF4V2lkdGg7CgoJCQkvLyBQdXQgaW4gdGhlIG5ldyB2YWx1ZXMgdG8gZ2V0IGEgY29tcHV0ZWQgdmFsdWUgb3V0CgkJCXN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKCQkJcmV0ID0gY29tcHV0ZWQud2lkdGg7CgoJCQkvLyBSZXZlcnQgdGhlIGNoYW5nZWQgdmFsdWVzCgkJCXN0eWxlLndpZHRoID0gd2lkdGg7CgkJCXN0eWxlLm1pbldpZHRoID0gbWluV2lkdGg7CgkJCXN0eWxlLm1heFdpZHRoID0gbWF4V2lkdGg7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn07CgoKZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCApIHsKCXZhciBtYXRjaGVzID0gcm51bXNwbGl0LmV4ZWMoIHZhbHVlICk7CglyZXR1cm4gbWF0Y2hlcyA/CgkJLy8gR3VhcmQgYWdhaW5zdCB1bmRlZmluZWQgInN1YnRyYWN0IiwgZS5nLiwgd2hlbiB1c2VkIGFzIGluIGNzc0hvb2tzCgkJTWF0aC5tYXgoIDAsIG1hdGNoZXNbIDEgXSAtICggc3VidHJhY3QgfHwgMCApICkgKyAoIG1hdGNoZXNbIDIgXSB8fCAicHgiICkgOgoJCXZhbHVlOwp9CgpmdW5jdGlvbiBhdWdtZW50V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEsIGlzQm9yZGVyQm94LCBzdHlsZXMgKSB7Cgl2YXIgaSA9IGV4dHJhID09PSAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSA/CgkJLy8gSWYgd2UgYWxyZWFkeSBoYXZlIHRoZSByaWdodCBtZWFzdXJlbWVudCwgYXZvaWQgYXVnbWVudGF0aW9uCgkJNCA6CgkJLy8gT3RoZXJ3aXNlIGluaXRpYWxpemUgZm9yIGhvcml6b250YWwgb3IgdmVydGljYWwgcHJvcGVydGllcwoJCW5hbWUgPT09ICJ3aWR0aCIgPyAxIDogMCwKCgkJdmFsID0gMDsKCglmb3IgKCA7IGkgPCA0OyBpICs9IDIgKSB7CgkJLy8gYm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luLCBzbyBhZGQgaXQgaWYgd2Ugd2FudCBpdAoJCWlmICggZXh0cmEgPT09ICJtYXJnaW4iICkgewoJCQl2YWwgKz0galF1ZXJ5LmNzcyggZWxlbSwgZXh0cmEgKyBjc3NFeHBhbmRbIGkgXSwgdHJ1ZSwgc3R5bGVzICk7CgkJfQoKCQlpZiAoIGlzQm9yZGVyQm94ICkgewoJCQkvLyBib3JkZXItYm94IGluY2x1ZGVzIHBhZGRpbmcsIHNvIHJlbW92ZSBpdCBpZiB3ZSB3YW50IGNvbnRlbnQKCQkJaWYgKCBleHRyYSA9PT0gImNvbnRlbnQiICkgewoJCQkJdmFsIC09IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgYm9yZGVyIG5vciBtYXJnaW4sIHNvIHJlbW92ZSBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gIm1hcmdpbiIgKSB7CgkJCQl2YWwgLT0galF1ZXJ5LmNzcyggZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbIGkgXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gYXQgdGhpcyBwb2ludCwgZXh0cmEgaXNuJ3QgY29udGVudCwgc28gYWRkIHBhZGRpbmcKCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFsgaSBdLCB0cnVlLCBzdHlsZXMgKTsKCgkJCS8vIGF0IHRoaXMgcG9pbnQsIGV4dHJhIGlzbid0IGNvbnRlbnQgbm9yIHBhZGRpbmcsIHNvIGFkZCBib3JkZXIKCQkJaWYgKCBleHRyYSAhPT0gInBhZGRpbmciICkgewoJCQkJdmFsICs9IGpRdWVyeS5jc3MoIGVsZW0sICJib3JkZXIiICsgY3NzRXhwYW5kWyBpIF0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMgKTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gdmFsOwp9CgpmdW5jdGlvbiBnZXRXaWR0aE9ySGVpZ2h0KCBlbGVtLCBuYW1lLCBleHRyYSApIHsKCgkvLyBTdGFydCB3aXRoIG9mZnNldCBwcm9wZXJ0eSwgd2hpY2ggaXMgZXF1aXZhbGVudCB0byB0aGUgYm9yZGVyLWJveCB2YWx1ZQoJdmFyIHZhbHVlSXNCb3JkZXJCb3ggPSB0cnVlLAoJCXZhbCA9IG5hbWUgPT09ICJ3aWR0aCIgPyBlbGVtLm9mZnNldFdpZHRoIDogZWxlbS5vZmZzZXRIZWlnaHQsCgkJc3R5bGVzID0gZ2V0U3R5bGVzKCBlbGVtICksCgkJaXNCb3JkZXJCb3ggPSBqUXVlcnkuc3VwcG9ydC5ib3hTaXppbmcgJiYgalF1ZXJ5LmNzcyggZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMgKSA9PT0gImJvcmRlci1ib3giOwoKCS8vIHNvbWUgbm9uLWh0bWwgZWxlbWVudHMgcmV0dXJuIHVuZGVmaW5lZCBmb3Igb2Zmc2V0V2lkdGgsIHNvIGNoZWNrIGZvciBudWxsL3VuZGVmaW5lZAoJLy8gc3ZnIC0gaHR0cHM6Ly9idWd6aWxsYS5tb3ppbGxhLm9yZy9zaG93X2J1Zy5jZ2k/aWQ9NjQ5Mjg1CgkvLyBNYXRoTUwgLSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD00OTE2NjgKCWlmICggdmFsIDw9IDAgfHwgdmFsID09IG51bGwgKSB7CgkJLy8gRmFsbCBiYWNrIHRvIGNvbXB1dGVkIHRoZW4gdW5jb21wdXRlZCBjc3MgaWYgbmVjZXNzYXJ5CgkJdmFsID0gY3VyQ1NTKCBlbGVtLCBuYW1lLCBzdHlsZXMgKTsKCQlpZiAoIHZhbCA8IDAgfHwgdmFsID09IG51bGwgKSB7CgkJCXZhbCA9IGVsZW0uc3R5bGVbIG5hbWUgXTsKCQl9CgoJCS8vIENvbXB1dGVkIHVuaXQgaXMgbm90IHBpeGVscy4gU3RvcCBoZXJlIGFuZCByZXR1cm4uCgkJaWYgKCBybnVtbm9ucHgudGVzdCh2YWwpICkgewoJCQlyZXR1cm4gdmFsOwoJCX0KCgkJLy8gd2UgbmVlZCB0aGUgY2hlY2sgZm9yIHN0eWxlIGluIGNhc2UgYSBicm93c2VyIHdoaWNoIHJldHVybnMgdW5yZWxpYWJsZSB2YWx1ZXMKCQkvLyBmb3IgZ2V0Q29tcHV0ZWRTdHlsZSBzaWxlbnRseSBmYWxscyBiYWNrIHRvIHRoZSByZWxpYWJsZSBlbGVtLnN0eWxlCgkJdmFsdWVJc0JvcmRlckJveCA9IGlzQm9yZGVyQm94ICYmICggalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nUmVsaWFibGUgfHwgdmFsID09PSBlbGVtLnN0eWxlWyBuYW1lIF0gKTsKCgkJLy8gTm9ybWFsaXplICIiLCBhdXRvLCBhbmQgcHJlcGFyZSBmb3IgZXh0cmEKCQl2YWwgPSBwYXJzZUZsb2F0KCB2YWwgKSB8fCAwOwoJfQoKCS8vIHVzZSB0aGUgYWN0aXZlIGJveC1zaXppbmcgbW9kZWwgdG8gYWRkL3N1YnRyYWN0IGlycmVsZXZhbnQgc3R5bGVzCglyZXR1cm4gKCB2YWwgKwoJCWF1Z21lbnRXaWR0aE9ySGVpZ2h0KAoJCQllbGVtLAoJCQluYW1lLAoJCQlleHRyYSB8fCAoIGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIgKSwKCQkJdmFsdWVJc0JvcmRlckJveCwKCQkJc3R5bGVzCgkJKQoJKSArICJweCI7Cn0KCi8vIFRyeSB0byBkZXRlcm1pbmUgdGhlIGRlZmF1bHQgZGlzcGxheSB2YWx1ZSBvZiBhbiBlbGVtZW50CmZ1bmN0aW9uIGNzc19kZWZhdWx0RGlzcGxheSggbm9kZU5hbWUgKSB7Cgl2YXIgZG9jID0gZG9jdW1lbnQsCgkJZGlzcGxheSA9IGVsZW1kaXNwbGF5WyBub2RlTmFtZSBdOwoKCWlmICggIWRpc3BsYXkgKSB7CgkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCgkJLy8gSWYgdGhlIHNpbXBsZSB3YXkgZmFpbHMsIHJlYWQgZnJvbSBpbnNpZGUgYW4gaWZyYW1lCgkJaWYgKCBkaXNwbGF5ID09PSAibm9uZSIgfHwgIWRpc3BsYXkgKSB7CgkJCS8vIFVzZSB0aGUgYWxyZWFkeS1jcmVhdGVkIGlmcmFtZSBpZiBwb3NzaWJsZQoJCQlpZnJhbWUgPSAoIGlmcmFtZSB8fAoJCQkJalF1ZXJ5KCI8aWZyYW1lIGZyYW1lYm9yZGVyPScwJyB3aWR0aD0nMCcgaGVpZ2h0PScwJy8+IikKCQkJCS5jc3MoICJjc3NUZXh0IiwgImRpc3BsYXk6YmxvY2sgIWltcG9ydGFudCIgKQoJCQkpLmFwcGVuZFRvKCBkb2MuZG9jdW1lbnRFbGVtZW50ICk7CgoJCQkvLyBBbHdheXMgd3JpdGUgYSBuZXcgSFRNTCBza2VsZXRvbiBzbyBXZWJraXQgYW5kIEZpcmVmb3ggZG9uJ3QgY2hva2Ugb24gcmV1c2UKCQkJZG9jID0gKCBpZnJhbWVbMF0uY29udGVudFdpbmRvdyB8fCBpZnJhbWVbMF0uY29udGVudERvY3VtZW50ICkuZG9jdW1lbnQ7CgkJCWRvYy53cml0ZSgiPCFkb2N0eXBlIGh0bWw+PGh0bWw+PGJvZHk+Iik7CgkJCWRvYy5jbG9zZSgpOwoKCQkJZGlzcGxheSA9IGFjdHVhbERpc3BsYXkoIG5vZGVOYW1lLCBkb2MgKTsKCQkJaWZyYW1lLmRldGFjaCgpOwoJCX0KCgkJLy8gU3RvcmUgdGhlIGNvcnJlY3QgZGVmYXVsdCBkaXNwbGF5CgkJZWxlbWRpc3BsYXlbIG5vZGVOYW1lIF0gPSBkaXNwbGF5OwoJfQoKCXJldHVybiBkaXNwbGF5Owp9CgovLyBDYWxsZWQgT05MWSBmcm9tIHdpdGhpbiBjc3NfZGVmYXVsdERpc3BsYXkKZnVuY3Rpb24gYWN0dWFsRGlzcGxheSggbmFtZSwgZG9jICkgewoJdmFyIGVsZW0gPSBqUXVlcnkoIGRvYy5jcmVhdGVFbGVtZW50KCBuYW1lICkgKS5hcHBlbmRUbyggZG9jLmJvZHkgKSwKCQlkaXNwbGF5ID0galF1ZXJ5LmNzcyggZWxlbVswXSwgImRpc3BsYXkiICk7CgllbGVtLnJlbW92ZSgpOwoJcmV0dXJuIGRpc3BsYXk7Cn0KCmpRdWVyeS5lYWNoKFsgImhlaWdodCIsICJ3aWR0aCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CglqUXVlcnkuY3NzSG9va3NbIG5hbWUgXSA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCwgZXh0cmEgKSB7CgkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkvLyBjZXJ0YWluIGVsZW1lbnRzIGNhbiBoYXZlIGRpbWVuc2lvbiBpbmZvIGlmIHdlIGludmlzaWJseSBzaG93IHRoZW0KCQkJCS8vIGhvd2V2ZXIsIGl0IG11c3QgaGF2ZSBhIGN1cnJlbnQgZGlzcGxheSBzdHlsZSB0aGF0IHdvdWxkIGJlbmVmaXQgZnJvbSB0aGlzCgkJCQlyZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCA9PT0gMCAmJiByZGlzcGxheXN3YXAudGVzdCggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgKSA/CgkJCQkJalF1ZXJ5LnN3YXAoIGVsZW0sIGNzc1Nob3csIGZ1bmN0aW9uKCkgewoJCQkJCQlyZXR1cm4gZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJCQl9KSA6CgkJCQkJZ2V0V2lkdGhPckhlaWdodCggZWxlbSwgbmFtZSwgZXh0cmEgKTsKCQkJfQoJCX0sCgoJCXNldDogZnVuY3Rpb24oIGVsZW0sIHZhbHVlLCBleHRyYSApIHsKCQkJdmFyIHN0eWxlcyA9IGV4dHJhICYmIGdldFN0eWxlcyggZWxlbSApOwoJCQlyZXR1cm4gc2V0UG9zaXRpdmVOdW1iZXIoIGVsZW0sIHZhbHVlLCBleHRyYSA/CgkJCQlhdWdtZW50V2lkdGhPckhlaWdodCgKCQkJCQllbGVtLAoJCQkJCW5hbWUsCgkJCQkJZXh0cmEsCgkJCQkJalF1ZXJ5LnN1cHBvcnQuYm94U2l6aW5nICYmIGpRdWVyeS5jc3MoIGVsZW0sICJib3hTaXppbmciLCBmYWxzZSwgc3R5bGVzICkgPT09ICJib3JkZXItYm94IiwKCQkJCQlzdHlsZXMKCQkJCSkgOiAwCgkJCSk7CgkJfQoJfTsKfSk7CgovLyBUaGVzZSBob29rcyBjYW5ub3QgYmUgYWRkZWQgdW50aWwgRE9NIHJlYWR5IGJlY2F1c2UgdGhlIHN1cHBvcnQgdGVzdAovLyBmb3IgaXQgaXMgbm90IHJ1biB1bnRpbCBhZnRlciBET00gcmVhZHkKalF1ZXJ5KGZ1bmN0aW9uKCkgewoJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCWlmICggIWpRdWVyeS5zdXBwb3J0LnJlbGlhYmxlTWFyZ2luUmlnaHQgKSB7CgkJalF1ZXJ5LmNzc0hvb2tzLm1hcmdpblJpZ2h0ID0gewoJCQlnZXQ6IGZ1bmN0aW9uKCBlbGVtLCBjb21wdXRlZCApIHsKCQkJCWlmICggY29tcHV0ZWQgKSB7CgkJCQkJLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMKCQkJCQkvLyBXZWJLaXQgQnVnIDEzMzQzIC0gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHdyb25nIHZhbHVlIGZvciBtYXJnaW4tcmlnaHQKCQkJCQkvLyBXb3JrIGFyb3VuZCBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIGVsZW1lbnQgZGlzcGxheSB0byBpbmxpbmUtYmxvY2sKCQkJCQlyZXR1cm4galF1ZXJ5LnN3YXAoIGVsZW0sIHsgImRpc3BsYXkiOiAiaW5saW5lLWJsb2NrIiB9LAoJCQkJCQljdXJDU1MsIFsgZWxlbSwgIm1hcmdpblJpZ2h0IiBdICk7CgkJCQl9CgkJCX0KCQl9OwoJfQoKCS8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAoJLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodAoJLy8gcmF0aGVyIHRoYW4gbWFrZSB0aGUgY3NzIG1vZHVsZSBkZXBlbmQgb24gdGhlIG9mZnNldCBtb2R1bGUsIHdlIGp1c3QgY2hlY2sgZm9yIGl0IGhlcmUKCWlmICggIWpRdWVyeS5zdXBwb3J0LnBpeGVsUG9zaXRpb24gJiYgalF1ZXJ5LmZuLnBvc2l0aW9uICkgewoJCWpRdWVyeS5lYWNoKCBbICJ0b3AiLCAibGVmdCIgXSwgZnVuY3Rpb24oIGksIHByb3AgKSB7CgkJCWpRdWVyeS5jc3NIb29rc1sgcHJvcCBdID0gewoJCQkJZ2V0OiBmdW5jdGlvbiggZWxlbSwgY29tcHV0ZWQgKSB7CgkJCQkJaWYgKCBjb21wdXRlZCApIHsKCQkJCQkJY29tcHV0ZWQgPSBjdXJDU1MoIGVsZW0sIHByb3AgKTsKCQkJCQkJLy8gaWYgY3VyQ1NTIHJldHVybnMgcGVyY2VudGFnZSwgZmFsbGJhY2sgdG8gb2Zmc2V0CgkJCQkJCXJldHVybiBybnVtbm9ucHgudGVzdCggY29tcHV0ZWQgKSA/CgkJCQkJCQlqUXVlcnkoIGVsZW0gKS5wb3NpdGlvbigpWyBwcm9wIF0gKyAicHgiIDoKCQkJCQkJCWNvbXB1dGVkOwoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCX0KCn0pOwoKaWYgKCBqUXVlcnkuZXhwciAmJiBqUXVlcnkuZXhwci5maWx0ZXJzICkgewoJalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4gPSBmdW5jdGlvbiggZWxlbSApIHsKCQkvLyBTdXBwb3J0OiBPcGVyYSA8PSAxMi4xMgoJCS8vIE9wZXJhIHJlcG9ydHMgb2Zmc2V0V2lkdGhzIGFuZCBvZmZzZXRIZWlnaHRzIGxlc3MgdGhhbiB6ZXJvIG9uIHNvbWUgZWxlbWVudHMKCQlyZXR1cm4gZWxlbS5vZmZzZXRXaWR0aCA8PSAwICYmIGVsZW0ub2Zmc2V0SGVpZ2h0IDw9IDA7Cgl9OwoKCWpRdWVyeS5leHByLmZpbHRlcnMudmlzaWJsZSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhalF1ZXJ5LmV4cHIuZmlsdGVycy5oaWRkZW4oIGVsZW0gKTsKCX07Cn0KCi8vIFRoZXNlIGhvb2tzIGFyZSB1c2VkIGJ5IGFuaW1hdGUgdG8gZXhwYW5kIHByb3BlcnRpZXMKalF1ZXJ5LmVhY2goewoJbWFyZ2luOiAiIiwKCXBhZGRpbmc6ICIiLAoJYm9yZGVyOiAiV2lkdGgiCn0sIGZ1bmN0aW9uKCBwcmVmaXgsIHN1ZmZpeCApIHsKCWpRdWVyeS5jc3NIb29rc1sgcHJlZml4ICsgc3VmZml4IF0gPSB7CgkJZXhwYW5kOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXZhciBpID0gMCwKCQkJCWV4cGFuZGVkID0ge30sCgoJCQkJLy8gYXNzdW1lcyBhIHNpbmdsZSBudW1iZXIgaWYgbm90IGEgc3RyaW5nCgkJCQlwYXJ0cyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZS5zcGxpdCgiICIpIDogWyB2YWx1ZSBdOwoKCQkJZm9yICggOyBpIDwgNDsgaSsrICkgewoJCQkJZXhwYW5kZWRbIHByZWZpeCArIGNzc0V4cGFuZFsgaSBdICsgc3VmZml4IF0gPQoJCQkJCXBhcnRzWyBpIF0gfHwgcGFydHNbIGkgLSAyIF0gfHwgcGFydHNbIDAgXTsKCQkJfQoKCQkJcmV0dXJuIGV4cGFuZGVkOwoJCX0KCX07CgoJaWYgKCAhcm1hcmdpbi50ZXN0KCBwcmVmaXggKSApIHsKCQlqUXVlcnkuY3NzSG9va3NbIHByZWZpeCArIHN1ZmZpeCBdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwoJfQp9KTsKdmFyIHIyMCA9IC8lMjAvZywKCXJicmFja2V0ID0gL1xbXF0kLywKCXJDUkxGID0gL1xyP1xuL2csCglyc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCglyc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CgpqUXVlcnkuZm4uZXh0ZW5kKHsKCXNlcmlhbGl6ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIGpRdWVyeS5wYXJhbSggdGhpcy5zZXJpYWxpemVBcnJheSgpICk7Cgl9LAoJc2VyaWFsaXplQXJyYXk6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpewoJCQkvLyBDYW4gYWRkIHByb3BIb29rIGZvciAiZWxlbWVudHMiIHRvIGZpbHRlciBvciBhZGQgZm9ybSBlbGVtZW50cwoJCQl2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCggdGhpcywgImVsZW1lbnRzIiApOwoJCQlyZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KCBlbGVtZW50cyApIDogdGhpczsKCQl9KQoJCS5maWx0ZXIoZnVuY3Rpb24oKXsKCQkJdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgkJCS8vIFVzZSAuaXMoIjpkaXNhYmxlZCIpIHNvIHRoYXQgZmllbGRzZXRbZGlzYWJsZWRdIHdvcmtzCgkJCXJldHVybiB0aGlzLm5hbWUgJiYgIWpRdWVyeSggdGhpcyApLmlzKCAiOmRpc2FibGVkIiApICYmCgkJCQlyc3VibWl0dGFibGUudGVzdCggdGhpcy5ub2RlTmFtZSApICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCggdHlwZSApICYmCgkJCQkoIHRoaXMuY2hlY2tlZCB8fCAhbWFuaXB1bGF0aW9uX3JjaGVja2FibGVUeXBlLnRlc3QoIHR5cGUgKSApOwoJCX0pCgkJLm1hcChmdW5jdGlvbiggaSwgZWxlbSApewoJCQl2YXIgdmFsID0galF1ZXJ5KCB0aGlzICkudmFsKCk7CgoJCQlyZXR1cm4gdmFsID09IG51bGwgPwoJCQkJbnVsbCA6CgkJCQlqUXVlcnkuaXNBcnJheSggdmFsICkgPwoJCQkJCWpRdWVyeS5tYXAoIHZhbCwgZnVuY3Rpb24oIHZhbCApewoJCQkJCQlyZXR1cm4geyBuYW1lOiBlbGVtLm5hbWUsIHZhbHVlOiB2YWwucmVwbGFjZSggckNSTEYsICJcclxuIiApIH07CgkJCQkJfSkgOgoJCQkJCXsgbmFtZTogZWxlbS5uYW1lLCB2YWx1ZTogdmFsLnJlcGxhY2UoIHJDUkxGLCAiXHJcbiIgKSB9OwoJCX0pLmdldCgpOwoJfQp9KTsKCi8vU2VyaWFsaXplIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMgb3IgYSBzZXQgb2YKLy9rZXkvdmFsdWVzIGludG8gYSBxdWVyeSBzdHJpbmcKalF1ZXJ5LnBhcmFtID0gZnVuY3Rpb24oIGEsIHRyYWRpdGlvbmFsICkgewoJdmFyIHByZWZpeCwKCQlzID0gW10sCgkJYWRkID0gZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCS8vIElmIHZhbHVlIGlzIGEgZnVuY3Rpb24sIGludm9rZSBpdCBhbmQgcmV0dXJuIGl0cyB2YWx1ZQoJCQl2YWx1ZSA9IGpRdWVyeS5pc0Z1bmN0aW9uKCB2YWx1ZSApID8gdmFsdWUoKSA6ICggdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWUgKTsKCQkJc1sgcy5sZW5ndGggXSA9IGVuY29kZVVSSUNvbXBvbmVudCgga2V5ICkgKyAiPSIgKyBlbmNvZGVVUklDb21wb25lbnQoIHZhbHVlICk7CgkJfTsKCgkvLyBTZXQgdHJhZGl0aW9uYWwgdG8gdHJ1ZSBmb3IgalF1ZXJ5IDw9IDEuMy4yIGJlaGF2aW9yLgoJaWYgKCB0cmFkaXRpb25hbCA9PT0gdW5kZWZpbmVkICkgewoJCXRyYWRpdGlvbmFsID0galF1ZXJ5LmFqYXhTZXR0aW5ncyAmJiBqUXVlcnkuYWpheFNldHRpbmdzLnRyYWRpdGlvbmFsOwoJfQoKCS8vIElmIGFuIGFycmF5IHdhcyBwYXNzZWQgaW4sIGFzc3VtZSB0aGF0IGl0IGlzIGFuIGFycmF5IG9mIGZvcm0gZWxlbWVudHMuCglpZiAoIGpRdWVyeS5pc0FycmF5KCBhICkgfHwgKCBhLmpxdWVyeSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3QoIGEgKSApICkgewoJCS8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwoJCWpRdWVyeS5lYWNoKCBhLCBmdW5jdGlvbigpIHsKCQkJYWRkKCB0aGlzLm5hbWUsIHRoaXMudmFsdWUgKTsKCQl9KTsKCgl9IGVsc2UgewoJCS8vIElmIHRyYWRpdGlvbmFsLCBlbmNvZGUgdGhlICJvbGQiIHdheSAodGhlIHdheSAxLjMuMiBvciBvbGRlcgoJCS8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgoJCWZvciAoIHByZWZpeCBpbiBhICkgewoJCQlidWlsZFBhcmFtcyggcHJlZml4LCBhWyBwcmVmaXggXSwgdHJhZGl0aW9uYWwsIGFkZCApOwoJCX0KCX0KCgkvLyBSZXR1cm4gdGhlIHJlc3VsdGluZyBzZXJpYWxpemF0aW9uCglyZXR1cm4gcy5qb2luKCAiJiIgKS5yZXBsYWNlKCByMjAsICIrIiApOwp9OwoKZnVuY3Rpb24gYnVpbGRQYXJhbXMoIHByZWZpeCwgb2JqLCB0cmFkaXRpb25hbCwgYWRkICkgewoJdmFyIG5hbWU7CgoJaWYgKCBqUXVlcnkuaXNBcnJheSggb2JqICkgKSB7CgkJLy8gU2VyaWFsaXplIGFycmF5IGl0ZW0uCgkJalF1ZXJ5LmVhY2goIG9iaiwgZnVuY3Rpb24oIGksIHYgKSB7CgkJCWlmICggdHJhZGl0aW9uYWwgfHwgcmJyYWNrZXQudGVzdCggcHJlZml4ICkgKSB7CgkJCQkvLyBUcmVhdCBlYWNoIGFycmF5IGl0ZW0gYXMgYSBzY2FsYXIuCgkJCQlhZGQoIHByZWZpeCwgdiApOwoKCQkJfSBlbHNlIHsKCQkJCS8vIEl0ZW0gaXMgbm9uLXNjYWxhciAoYXJyYXkgb3Igb2JqZWN0KSwgZW5jb2RlIGl0cyBudW1lcmljIGluZGV4LgoJCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArICggdHlwZW9mIHYgPT09ICJvYmplY3QiID8gaSA6ICIiICkgKyAiXSIsIHYsIHRyYWRpdGlvbmFsLCBhZGQgKTsKCQkJfQoJCX0pOwoKCX0gZWxzZSBpZiAoICF0cmFkaXRpb25hbCAmJiBqUXVlcnkudHlwZSggb2JqICkgPT09ICJvYmplY3QiICkgewoJCS8vIFNlcmlhbGl6ZSBvYmplY3QgaXRlbS4KCQlmb3IgKCBuYW1lIGluIG9iaiApIHsKCQkJYnVpbGRQYXJhbXMoIHByZWZpeCArICJbIiArIG5hbWUgKyAiXSIsIG9ialsgbmFtZSBdLCB0cmFkaXRpb25hbCwgYWRkICk7CgkJfQoKCX0gZWxzZSB7CgkJLy8gU2VyaWFsaXplIHNjYWxhciBpdGVtLgoJCWFkZCggcHJlZml4LCBvYmogKTsKCX0KfQpqUXVlcnkuZWFjaCggKCJibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQgbG9hZCByZXNpemUgc2Nyb2xsIHVubG9hZCBjbGljayBkYmxjbGljayAiICsKCSJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsKCSJjaGFuZ2Ugc2VsZWN0IHN1Ym1pdCBrZXlkb3duIGtleXByZXNzIGtleXVwIGVycm9yIGNvbnRleHRtZW51Iikuc3BsaXQoIiAiKSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgoJLy8gSGFuZGxlIGV2ZW50IGJpbmRpbmcKCWpRdWVyeS5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGRhdGEsIGZuICkgewoJCXJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMCA/CgkJCXRoaXMub24oIG5hbWUsIG51bGwsIGRhdGEsIGZuICkgOgoJCQl0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7Cglob3ZlcjogZnVuY3Rpb24oIGZuT3ZlciwgZm5PdXQgKSB7CgkJcmV0dXJuIHRoaXMubW91c2VlbnRlciggZm5PdmVyICkubW91c2VsZWF2ZSggZm5PdXQgfHwgZm5PdmVyICk7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBudWxsLCBkYXRhLCBmbiApOwoJfSwKCXVuYmluZDogZnVuY3Rpb24oIHR5cGVzLCBmbiApIHsKCQlyZXR1cm4gdGhpcy5vZmYoIHR5cGVzLCBudWxsLCBmbiApOwoJfSwKCglkZWxlZ2F0ZTogZnVuY3Rpb24oIHNlbGVjdG9yLCB0eXBlcywgZGF0YSwgZm4gKSB7CgkJcmV0dXJuIHRoaXMub24oIHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4gKTsKCX0sCgl1bmRlbGVnYXRlOiBmdW5jdGlvbiggc2VsZWN0b3IsIHR5cGVzLCBmbiApIHsKCQkvLyAoIG5hbWVzcGFjZSApIG9yICggc2VsZWN0b3IsIHR5cGVzIFssIGZuXSApCgkJcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZiggc2VsZWN0b3IsICIqKiIgKSA6IHRoaXMub2ZmKCB0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4gKTsKCX0KfSk7CnZhcgoJLy8gRG9jdW1lbnQgbG9jYXRpb24KCWFqYXhMb2NQYXJ0cywKCWFqYXhMb2NhdGlvbiwKCglhamF4X25vbmNlID0galF1ZXJ5Lm5vdygpLAoKCWFqYXhfcnF1ZXJ5ID0gL1w/LywKCXJoYXNoID0gLyMuKiQvLAoJcnRzID0gLyhbPyZdKV89W14mXSovLAoJcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL21nLAoJLy8gIzc2NTMsICM4MTI1LCAjODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCglybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAoJcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCglycHJvdG9jb2wgPSAvXlwvXC8vLAoJcnVybCA9IC9eKFtcdy4rLV0rOikoPzpcL1wvKFteXC8/IzpdKikoPzo6KFxkKyl8KXwpLywKCgkvLyBLZWVwIGEgY29weSBvZiB0aGUgb2xkIGxvYWQgbWV0aG9kCglfbG9hZCA9IGpRdWVyeS5mbi5sb2FkLAoKCS8qIFByZWZpbHRlcnMKCSAqIDEpIFRoZXkgYXJlIHVzZWZ1bCB0byBpbnRyb2R1Y2UgY3VzdG9tIGRhdGFUeXBlcyAoc2VlIGFqYXgvanNvbnAuanMgZm9yIGFuIGV4YW1wbGUpCgkgKiAyKSBUaGVzZSBhcmUgY2FsbGVkOgoJICogICAgLSBCRUZPUkUgYXNraW5nIGZvciBhIHRyYW5zcG9ydAoJICogICAgLSBBRlRFUiBwYXJhbSBzZXJpYWxpemF0aW9uIChzLmRhdGEgaXMgYSBzdHJpbmcgaWYgcy5wcm9jZXNzRGF0YSBpcyB0cnVlKQoJICogMykga2V5IGlzIHRoZSBkYXRhVHlwZQoJICogNCkgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKCSAqIDUpIGV4ZWN1dGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGNvbnRpbnVlIGRvd24gdG8gIioiIGlmIG5lZWRlZAoJICovCglwcmVmaWx0ZXJzID0ge30sCgoJLyogVHJhbnNwb3J0cyBiaW5kaW5ncwoJICogMSkga2V5IGlzIHRoZSBkYXRhVHlwZQoJICogMikgdGhlIGNhdGNoYWxsIHN5bWJvbCAiKiIgY2FuIGJlIHVzZWQKCSAqIDMpIHNlbGVjdGlvbiB3aWxsIHN0YXJ0IHdpdGggdHJhbnNwb3J0IGRhdGFUeXBlIGFuZCBUSEVOIGdvIHRvICIqIiBpZiBuZWVkZWQKCSAqLwoJdHJhbnNwb3J0cyA9IHt9LAoKCS8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKCMxMDA5OCk7IG11c3QgYXBwZWFzZSBsaW50IGFuZCBldmFkZSBjb21wcmVzc2lvbgoJYWxsVHlwZXMgPSAiKi8iLmNvbmNhdCgiKiIpOwoKLy8gIzgxMzgsIElFIG1heSB0aHJvdyBhbiBleGNlcHRpb24gd2hlbiBhY2Nlc3NpbmcKLy8gYSBmaWVsZCBmcm9tIHdpbmRvdy5sb2NhdGlvbiBpZiBkb2N1bWVudC5kb21haW4gaGFzIGJlZW4gc2V0CnRyeSB7CglhamF4TG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmOwp9IGNhdGNoKCBlICkgewoJLy8gVXNlIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiBhbiBBIGVsZW1lbnQKCS8vIHNpbmNlIElFIHdpbGwgbW9kaWZ5IGl0IGdpdmVuIGRvY3VtZW50LmxvY2F0aW9uCglhamF4TG9jYXRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiYSIgKTsKCWFqYXhMb2NhdGlvbi5ocmVmID0gIiI7CglhamF4TG9jYXRpb24gPSBhamF4TG9jYXRpb24uaHJlZjsKfQoKLy8gU2VnbWVudCBsb2NhdGlvbiBpbnRvIHBhcnRzCmFqYXhMb2NQYXJ0cyA9IHJ1cmwuZXhlYyggYWpheExvY2F0aW9uLnRvTG93ZXJDYXNlKCkgKSB8fCBbXTsKCi8vIEJhc2UgImNvbnN0cnVjdG9yIiBmb3IgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIgYW5kIGpRdWVyeS5hamF4VHJhbnNwb3J0CmZ1bmN0aW9uIGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggc3RydWN0dXJlICkgewoKCS8vIGRhdGFUeXBlRXhwcmVzc2lvbiBpcyBvcHRpb25hbCBhbmQgZGVmYXVsdHMgdG8gIioiCglyZXR1cm4gZnVuY3Rpb24oIGRhdGFUeXBlRXhwcmVzc2lvbiwgZnVuYyApIHsKCgkJaWYgKCB0eXBlb2YgZGF0YVR5cGVFeHByZXNzaW9uICE9PSAic3RyaW5nIiApIHsKCQkJZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKCQkJZGF0YVR5cGVFeHByZXNzaW9uID0gIioiOwoJCX0KCgkJdmFyIGRhdGFUeXBlLAoJCQlpID0gMCwKCQkJZGF0YVR5cGVzID0gZGF0YVR5cGVFeHByZXNzaW9uLnRvTG93ZXJDYXNlKCkubWF0Y2goIGNvcmVfcm5vdHdoaXRlICkgfHwgW107CgoJCWlmICggalF1ZXJ5LmlzRnVuY3Rpb24oIGZ1bmMgKSApIHsKCQkJLy8gRm9yIGVhY2ggZGF0YVR5cGUgaW4gdGhlIGRhdGFUeXBlRXhwcmVzc2lvbgoJCQl3aGlsZSAoIChkYXRhVHlwZSA9IGRhdGFUeXBlc1tpKytdKSApIHsKCQkJCS8vIFByZXBlbmQgaWYgcmVxdWVzdGVkCgkJCQlpZiAoIGRhdGFUeXBlWzBdID09PSAiKyIgKSB7CgkJCQkJZGF0YVR5cGUgPSBkYXRhVHlwZS5zbGljZSggMSApIHx8ICIqIjsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS51bnNoaWZ0KCBmdW5jICk7CgoJCQkJLy8gT3RoZXJ3aXNlIGFwcGVuZAoJCQkJfSBlbHNlIHsKCQkJCQkoc3RydWN0dXJlWyBkYXRhVHlwZSBdID0gc3RydWN0dXJlWyBkYXRhVHlwZSBdIHx8IFtdKS5wdXNoKCBmdW5jICk7CgkJCQl9CgkJCX0KCQl9Cgl9Owp9CgovLyBCYXNlIGluc3BlY3Rpb24gZnVuY3Rpb24gZm9yIHByZWZpbHRlcnMgYW5kIHRyYW5zcG9ydHMKZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHN0cnVjdHVyZSwgb3B0aW9ucywgb3JpZ2luYWxPcHRpb25zLCBqcVhIUiApIHsKCgl2YXIgaW5zcGVjdGVkID0ge30sCgkJc2Vla2luZ1RyYW5zcG9ydCA9ICggc3RydWN0dXJlID09PSB0cmFuc3BvcnRzICk7CgoJZnVuY3Rpb24gaW5zcGVjdCggZGF0YVR5cGUgKSB7CgkJdmFyIHNlbGVjdGVkOwoJCWluc3BlY3RlZFsgZGF0YVR5cGUgXSA9IHRydWU7CgkJalF1ZXJ5LmVhY2goIHN0cnVjdHVyZVsgZGF0YVR5cGUgXSB8fCBbXSwgZnVuY3Rpb24oIF8sIHByZWZpbHRlck9yRmFjdG9yeSApIHsKCQkJdmFyIGRhdGFUeXBlT3JUcmFuc3BvcnQgPSBwcmVmaWx0ZXJPckZhY3RvcnkoIG9wdGlvbnMsIG9yaWdpbmFsT3B0aW9ucywganFYSFIgKTsKCQkJaWYoIHR5cGVvZiBkYXRhVHlwZU9yVHJhbnNwb3J0ID09PSAic3RyaW5nIiAmJiAhc2Vla2luZ1RyYW5zcG9ydCAmJiAhaW5zcGVjdGVkWyBkYXRhVHlwZU9yVHJhbnNwb3J0IF0gKSB7CgkJCQlvcHRpb25zLmRhdGFUeXBlcy51bnNoaWZ0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlpbnNwZWN0KCBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0gZWxzZSBpZiAoIHNlZWtpbmdUcmFuc3BvcnQgKSB7CgkJCQlyZXR1cm4gISggc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0ICk7CgkJCX0KCQl9KTsKCQlyZXR1cm4gc2VsZWN0ZWQ7Cgl9CgoJcmV0dXJuIGluc3BlY3QoIG9wdGlvbnMuZGF0YVR5cGVzWyAwIF0gKSB8fCAhaW5zcGVjdGVkWyAiKiIgXSAmJiBpbnNwZWN0KCAiKiIgKTsKfQoKLy8gQSBzcGVjaWFsIGV4dGVuZCBmb3IgYWpheCBvcHRpb25zCi8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQovLyBGaXhlcyAjOTg4NwpmdW5jdGlvbiBhamF4RXh0ZW5kKCB0YXJnZXQsIHNyYyApIHsKCXZhciBrZXksIGRlZXAsCgkJZmxhdE9wdGlvbnMgPSBqUXVlcnkuYWpheFNldHRpbmdzLmZsYXRPcHRpb25zIHx8IHt9OwoKCWZvciAoIGtleSBpbiBzcmMgKSB7CgkJaWYgKCBzcmNbIGtleSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCSggZmxhdE9wdGlvbnNbIGtleSBdID8gdGFyZ2V0IDogKCBkZWVwIHx8IChkZWVwID0ge30pICkgKVsga2V5IF0gPSBzcmNbIGtleSBdOwoJCX0KCX0KCWlmICggZGVlcCApIHsKCQlqUXVlcnkuZXh0ZW5kKCB0cnVlLCB0YXJnZXQsIGRlZXAgKTsKCX0KCglyZXR1cm4gdGFyZ2V0Owp9CgpqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uKCB1cmwsIHBhcmFtcywgY2FsbGJhY2sgKSB7CglpZiAoIHR5cGVvZiB1cmwgIT09ICJzdHJpbmciICYmIF9sb2FkICkgewoJCXJldHVybiBfbG9hZC5hcHBseSggdGhpcywgYXJndW1lbnRzICk7Cgl9CgoJdmFyIHNlbGVjdG9yLCB0eXBlLCByZXNwb25zZSwKCQlzZWxmID0gdGhpcywKCQlvZmYgPSB1cmwuaW5kZXhPZigiICIpOwoKCWlmICggb2ZmID49IDAgKSB7CgkJc2VsZWN0b3IgPSB1cmwuc2xpY2UoIG9mZiApOwoJCXVybCA9IHVybC5zbGljZSggMCwgb2ZmICk7Cgl9CgoJLy8gSWYgaXQncyBhIGZ1bmN0aW9uCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwYXJhbXMgKSApIHsKCgkJLy8gV2UgYXNzdW1lIHRoYXQgaXQncyB0aGUgY2FsbGJhY2sKCQljYWxsYmFjayA9IHBhcmFtczsKCQlwYXJhbXMgPSB1bmRlZmluZWQ7CgoJLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwoJfSBlbHNlIGlmICggcGFyYW1zICYmIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgewoJCXR5cGUgPSAiUE9TVCI7Cgl9CgoJLy8gSWYgd2UgaGF2ZSBlbGVtZW50cyB0byBtb2RpZnksIG1ha2UgdGhlIHJlcXVlc3QKCWlmICggc2VsZi5sZW5ndGggPiAwICkgewoJCWpRdWVyeS5hamF4KHsKCQkJdXJsOiB1cmwsCgoJCQkvLyBpZiAidHlwZSIgdmFyaWFibGUgaXMgdW5kZWZpbmVkLCB0aGVuICJHRVQiIG1ldGhvZCB3aWxsIGJlIHVzZWQKCQkJdHlwZTogdHlwZSwKCQkJZGF0YVR5cGU6ICJodG1sIiwKCQkJZGF0YTogcGFyYW1zCgkJfSkuZG9uZShmdW5jdGlvbiggcmVzcG9uc2VUZXh0ICkgewoKCQkJLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCgkJCXJlc3BvbnNlID0gYXJndW1lbnRzOwoKCQkJc2VsZi5odG1sKCBzZWxlY3RvciA/CgoJCQkJLy8gSWYgYSBzZWxlY3RvciB3YXMgc3BlY2lmaWVkLCBsb2NhdGUgdGhlIHJpZ2h0IGVsZW1lbnRzIGluIGEgZHVtbXkgZGl2CgkJCQkvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMKCQkJCWpRdWVyeSgiPGRpdj4iKS5hcHBlbmQoIGpRdWVyeS5wYXJzZUhUTUwoIHJlc3BvbnNlVGV4dCApICkuZmluZCggc2VsZWN0b3IgKSA6CgoJCQkJLy8gT3RoZXJ3aXNlIHVzZSB0aGUgZnVsbCByZXN1bHQKCQkJCXJlc3BvbnNlVGV4dCApOwoKCQl9KS5jb21wbGV0ZSggY2FsbGJhY2sgJiYgZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCXNlbGYuZWFjaCggY2FsbGJhY2ssIHJlc3BvbnNlIHx8IFsganFYSFIucmVzcG9uc2VUZXh0LCBzdGF0dXMsIGpxWEhSIF0gKTsKCQl9KTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCi8vIEF0dGFjaCBhIGJ1bmNoIG9mIGZ1bmN0aW9ucyBmb3IgaGFuZGxpbmcgY29tbW9uIEFKQVggZXZlbnRzCmpRdWVyeS5lYWNoKCBbICJhamF4U3RhcnQiLCAiYWpheFN0b3AiLCAiYWpheENvbXBsZXRlIiwgImFqYXhFcnJvciIsICJhamF4U3VjY2VzcyIsICJhamF4U2VuZCIgXSwgZnVuY3Rpb24oIGksIHR5cGUgKXsKCWpRdWVyeS5mblsgdHlwZSBdID0gZnVuY3Rpb24oIGZuICl7CgkJcmV0dXJuIHRoaXMub24oIHR5cGUsIGZuICk7Cgl9Owp9KTsKCmpRdWVyeS5leHRlbmQoewoKCS8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwoJYWN0aXZlOiAwLAoKCS8vIExhc3QtTW9kaWZpZWQgaGVhZGVyIGNhY2hlIGZvciBuZXh0IHJlcXVlc3QKCWxhc3RNb2RpZmllZDoge30sCglldGFnOiB7fSwKCglhamF4U2V0dGluZ3M6IHsKCQl1cmw6IGFqYXhMb2NhdGlvbiwKCQl0eXBlOiAiR0VUIiwKCQlpc0xvY2FsOiBybG9jYWxQcm90b2NvbC50ZXN0KCBhamF4TG9jUGFydHNbIDEgXSApLAoJCWdsb2JhbDogdHJ1ZSwKCQlwcm9jZXNzRGF0YTogdHJ1ZSwKCQlhc3luYzogdHJ1ZSwKCQljb250ZW50VHlwZTogImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZDsgY2hhcnNldD1VVEYtOCIsCgkJLyoKCQl0aW1lb3V0OiAwLAoJCWRhdGE6IG51bGwsCgkJZGF0YVR5cGU6IG51bGwsCgkJdXNlcm5hbWU6IG51bGwsCgkJcGFzc3dvcmQ6IG51bGwsCgkJY2FjaGU6IG51bGwsCgkJdGhyb3dzOiBmYWxzZSwKCQl0cmFkaXRpb25hbDogZmFsc2UsCgkJaGVhZGVyczoge30sCgkJKi8KCgkJYWNjZXB0czogewoJCQkiKiI6IGFsbFR5cGVzLAoJCQl0ZXh0OiAidGV4dC9wbGFpbiIsCgkJCWh0bWw6ICJ0ZXh0L2h0bWwiLAoJCQl4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKCQkJanNvbjogImFwcGxpY2F0aW9uL2pzb24sIHRleHQvamF2YXNjcmlwdCIKCQl9LAoKCQljb250ZW50czogewoJCQl4bWw6IC94bWwvLAoJCQlodG1sOiAvaHRtbC8sCgkJCWpzb246IC9qc29uLwoJCX0sCgoJCXJlc3BvbnNlRmllbGRzOiB7CgkJCXhtbDogInJlc3BvbnNlWE1MIiwKCQkJdGV4dDogInJlc3BvbnNlVGV4dCIsCgkJCWpzb246ICJyZXNwb25zZUpTT04iCgkJfSwKCgkJLy8gRGF0YSBjb252ZXJ0ZXJzCgkJLy8gS2V5cyBzZXBhcmF0ZSBzb3VyY2UgKG9yIGNhdGNoYWxsICIqIikgYW5kIGRlc3RpbmF0aW9uIHR5cGVzIHdpdGggYSBzaW5nbGUgc3BhY2UKCQljb252ZXJ0ZXJzOiB7CgoJCQkvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKCQkJIiogdGV4dCI6IFN0cmluZywKCgkJCS8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQoJCQkidGV4dCBodG1sIjogdHJ1ZSwKCgkJCS8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KCQkJInRleHQganNvbiI6IGpRdWVyeS5wYXJzZUpTT04sCgoJCQkvLyBQYXJzZSB0ZXh0IGFzIHhtbAoJCQkidGV4dCB4bWwiOiBqUXVlcnkucGFyc2VYTUwKCQl9LAoKCQkvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgoJCS8vIHlvdSBjYW4gYWRkIHlvdXIgb3duIGN1c3RvbSBvcHRpb25zIGhlcmUgaWYKCQkvLyBhbmQgd2hlbiB5b3UgY3JlYXRlIG9uZSB0aGF0IHNob3VsZG4ndCBiZQoJCS8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQoJCWZsYXRPcHRpb25zOiB7CgkJCXVybDogdHJ1ZSwKCQkJY29udGV4dDogdHJ1ZQoJCX0KCX0sCgoJLy8gQ3JlYXRlcyBhIGZ1bGwgZmxlZGdlZCBzZXR0aW5ncyBvYmplY3QgaW50byB0YXJnZXQKCS8vIHdpdGggYm90aCBhamF4U2V0dGluZ3MgYW5kIHNldHRpbmdzIGZpZWxkcy4KCS8vIElmIHRhcmdldCBpcyBvbWl0dGVkLCB3cml0ZXMgaW50byBhamF4U2V0dGluZ3MuCglhamF4U2V0dXA6IGZ1bmN0aW9uKCB0YXJnZXQsIHNldHRpbmdzICkgewoJCXJldHVybiBzZXR0aW5ncyA/CgoJCQkvLyBCdWlsZGluZyBhIHNldHRpbmdzIG9iamVjdAoJCQlhamF4RXh0ZW5kKCBhamF4RXh0ZW5kKCB0YXJnZXQsIGpRdWVyeS5hamF4U2V0dGluZ3MgKSwgc2V0dGluZ3MgKSA6CgoJCQkvLyBFeHRlbmRpbmcgYWpheFNldHRpbmdzCgkJCWFqYXhFeHRlbmQoIGpRdWVyeS5hamF4U2V0dGluZ3MsIHRhcmdldCApOwoJfSwKCglhamF4UHJlZmlsdGVyOiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoIHByZWZpbHRlcnMgKSwKCWFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cyApLAoKCS8vIE1haW4gbWV0aG9kCglhamF4OiBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoKCQkvLyBJZiB1cmwgaXMgYW4gb2JqZWN0LCBzaW11bGF0ZSBwcmUtMS41IHNpZ25hdHVyZQoJCWlmICggdHlwZW9mIHVybCA9PT0gIm9iamVjdCIgKSB7CgkJCW9wdGlvbnMgPSB1cmw7CgkJCXVybCA9IHVuZGVmaW5lZDsKCQl9CgoJCS8vIEZvcmNlIG9wdGlvbnMgdG8gYmUgYW4gb2JqZWN0CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCXZhciB0cmFuc3BvcnQsCgkJCS8vIFVSTCB3aXRob3V0IGFudGktY2FjaGUgcGFyYW0KCQkJY2FjaGVVUkwsCgkJCS8vIFJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nLAoJCQlyZXNwb25zZUhlYWRlcnMsCgkJCS8vIHRpbWVvdXQgaGFuZGxlCgkJCXRpbWVvdXRUaW1lciwKCQkJLy8gQ3Jvc3MtZG9tYWluIGRldGVjdGlvbiB2YXJzCgkJCXBhcnRzLAoJCQkvLyBUbyBrbm93IGlmIGdsb2JhbCBldmVudHMgYXJlIHRvIGJlIGRpc3BhdGNoZWQKCQkJZmlyZUdsb2JhbHMsCgkJCS8vIExvb3AgdmFyaWFibGUKCQkJaSwKCQkJLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAoJCQlzID0galF1ZXJ5LmFqYXhTZXR1cCgge30sIG9wdGlvbnMgKSwKCQkJLy8gQ2FsbGJhY2tzIGNvbnRleHQKCQkJY2FsbGJhY2tDb250ZXh0ID0gcy5jb250ZXh0IHx8IHMsCgkJCS8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KCQkJZ2xvYmFsRXZlbnRDb250ZXh0ID0gcy5jb250ZXh0ICYmICggY2FsbGJhY2tDb250ZXh0Lm5vZGVUeXBlIHx8IGNhbGxiYWNrQ29udGV4dC5qcXVlcnkgKSA/CgkJCQlqUXVlcnkoIGNhbGxiYWNrQ29udGV4dCApIDoKCQkJCWpRdWVyeS5ldmVudCwKCQkJLy8gRGVmZXJyZWRzCgkJCWRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCgkJCWNvbXBsZXRlRGVmZXJyZWQgPSBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLAoJCQkvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwoJCQlzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAoJCQkvLyBIZWFkZXJzICh0aGV5IGFyZSBzZW50IGFsbCBhdCBvbmNlKQoJCQlyZXF1ZXN0SGVhZGVycyA9IHt9LAoJCQlyZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCgkJCS8vIFRoZSBqcVhIUiBzdGF0ZQoJCQlzdGF0ZSA9IDAsCgkJCS8vIERlZmF1bHQgYWJvcnQgbWVzc2FnZQoJCQlzdHJBYm9ydCA9ICJjYW5jZWxlZCIsCgkJCS8vIEZha2UgeGhyCgkJCWpxWEhSID0gewoJCQkJcmVhZHlTdGF0ZTogMCwKCgkJCQkvLyBCdWlsZHMgaGVhZGVycyBoYXNodGFibGUgaWYgbmVlZGVkCgkJCQlnZXRSZXNwb25zZUhlYWRlcjogZnVuY3Rpb24oIGtleSApIHsKCQkJCQl2YXIgbWF0Y2g7CgkJCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCQkJaWYgKCAhcmVzcG9uc2VIZWFkZXJzICkgewoJCQkJCQkJcmVzcG9uc2VIZWFkZXJzID0ge307CgkJCQkJCQl3aGlsZSAoIChtYXRjaCA9IHJoZWFkZXJzLmV4ZWMoIHJlc3BvbnNlSGVhZGVyc1N0cmluZyApKSApIHsKCQkJCQkJCQlyZXNwb25zZUhlYWRlcnNbIG1hdGNoWzFdLnRvTG93ZXJDYXNlKCkgXSA9IG1hdGNoWyAyIF07CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJbWF0Y2ggPSByZXNwb25zZUhlYWRlcnNbIGtleS50b0xvd2VyQ2FzZSgpIF07CgkJCQkJfQoJCQkJCXJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoOwoJCQkJfSwKCgkJCQkvLyBSYXcgc3RyaW5nCgkJCQlnZXRBbGxSZXNwb25zZUhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiBzdGF0ZSA9PT0gMiA/IHJlc3BvbnNlSGVhZGVyc1N0cmluZyA6IG51bGw7CgkJCQl9LAoKCQkJCS8vIENhY2hlcyB0aGUgaGVhZGVyCgkJCQlzZXRSZXF1ZXN0SGVhZGVyOiBmdW5jdGlvbiggbmFtZSwgdmFsdWUgKSB7CgkJCQkJdmFyIGxuYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQluYW1lID0gcmVxdWVzdEhlYWRlcnNOYW1lc1sgbG5hbWUgXSA9IHJlcXVlc3RIZWFkZXJzTmFtZXNbIGxuYW1lIF0gfHwgbmFtZTsKCQkJCQkJcmVxdWVzdEhlYWRlcnNbIG5hbWUgXSA9IHZhbHVlOwoJCQkJCX0KCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgoJCQkJLy8gT3ZlcnJpZGVzIHJlc3BvbnNlIGNvbnRlbnQtdHlwZSBoZWFkZXIKCQkJCW92ZXJyaWRlTWltZVR5cGU6IGZ1bmN0aW9uKCB0eXBlICkgewoJCQkJCWlmICggIXN0YXRlICkgewoJCQkJCQlzLm1pbWVUeXBlID0gdHlwZTsKCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCQlzdGF0dXNDb2RlOiBmdW5jdGlvbiggbWFwICkgewoJCQkJCXZhciBjb2RlOwoJCQkJCWlmICggbWFwICkgewoJCQkJCQlpZiAoIHN0YXRlIDwgMiApIHsKCQkJCQkJCWZvciAoIGNvZGUgaW4gbWFwICkgewoJCQkJCQkJCS8vIExhenktYWRkIHRoZSBuZXcgY2FsbGJhY2sgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKCQkJCQkJCQlzdGF0dXNDb2RlWyBjb2RlIF0gPSBbIHN0YXR1c0NvZGVbIGNvZGUgXSwgbWFwWyBjb2RlIF0gXTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcwoJCQkJCQkJanFYSFIuYWx3YXlzKCBtYXBbIGpxWEhSLnN0YXR1cyBdICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9LAoKCQkJCS8vIENhbmNlbCB0aGUgcmVxdWVzdAoJCQkJYWJvcnQ6IGZ1bmN0aW9uKCBzdGF0dXNUZXh0ICkgewoJCQkJCXZhciBmaW5hbFRleHQgPSBzdGF0dXNUZXh0IHx8IHN0ckFib3J0OwoJCQkJCWlmICggdHJhbnNwb3J0ICkgewoJCQkJCQl0cmFuc3BvcnQuYWJvcnQoIGZpbmFsVGV4dCApOwoJCQkJCX0KCQkJCQlkb25lKCAwLCBmaW5hbFRleHQgKTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0KCQkJfTsKCgkJLy8gQXR0YWNoIGRlZmVycmVkcwoJCWRlZmVycmVkLnByb21pc2UoIGpxWEhSICkuY29tcGxldGUgPSBjb21wbGV0ZURlZmVycmVkLmFkZDsKCQlqcVhIUi5zdWNjZXNzID0ganFYSFIuZG9uZTsKCQlqcVhIUi5lcnJvciA9IGpxWEhSLmZhaWw7CgoJCS8vIFJlbW92ZSBoYXNoIGNoYXJhY3RlciAoIzc1MzE6IGFuZCBzdHJpbmcgcHJvbW90aW9uKQoJCS8vIEFkZCBwcm90b2NvbCBpZiBub3QgcHJvdmlkZWQgKHByZWZpbHRlcnMgbWlnaHQgZXhwZWN0IGl0KQoJCS8vIEhhbmRsZSBmYWxzeSB1cmwgaW4gdGhlIHNldHRpbmdzIG9iamVjdCAoIzEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCgkJLy8gV2UgYWxzbyB1c2UgdGhlIHVybCBwYXJhbWV0ZXIgaWYgYXZhaWxhYmxlCgkJcy51cmwgPSAoICggdXJsIHx8IHMudXJsIHx8IGFqYXhMb2NhdGlvbiApICsgIiIgKS5yZXBsYWNlKCByaGFzaCwgIiIgKQoJCQkucmVwbGFjZSggcnByb3RvY29sLCBhamF4TG9jUGFydHNbIDEgXSArICIvLyIgKTsKCgkJLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgIzEyMDA0CgkJcy50eXBlID0gb3B0aW9ucy5tZXRob2QgfHwgb3B0aW9ucy50eXBlIHx8IHMubWV0aG9kIHx8IHMudHlwZTsKCgkJLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAoJCXMuZGF0YVR5cGVzID0galF1ZXJ5LnRyaW0oIHMuZGF0YVR5cGUgfHwgIioiICkudG9Mb3dlckNhc2UoKS5tYXRjaCggY29yZV9ybm90d2hpdGUgKSB8fCBbIiJdOwoKCQkvLyBBIGNyb3NzLWRvbWFpbiByZXF1ZXN0IGlzIGluIG9yZGVyIHdoZW4gd2UgaGF2ZSBhIHByb3RvY29sOmhvc3Q6cG9ydCBtaXNtYXRjaAoJCWlmICggcy5jcm9zc0RvbWFpbiA9PSBudWxsICkgewoJCQlwYXJ0cyA9IHJ1cmwuZXhlYyggcy51cmwudG9Mb3dlckNhc2UoKSApOwoJCQlzLmNyb3NzRG9tYWluID0gISEoIHBhcnRzICYmCgkJCQkoIHBhcnRzWyAxIF0gIT09IGFqYXhMb2NQYXJ0c1sgMSBdIHx8IHBhcnRzWyAyIF0gIT09IGFqYXhMb2NQYXJ0c1sgMiBdIHx8CgkJCQkJKCBwYXJ0c1sgMyBdIHx8ICggcGFydHNbIDEgXSA9PT0gImh0dHA6IiA/ICI4MCIgOiAiNDQzIiApICkgIT09CgkJCQkJCSggYWpheExvY1BhcnRzWyAzIF0gfHwgKCBhamF4TG9jUGFydHNbIDEgXSA9PT0gImh0dHA6IiA/ICI4MCIgOiAiNDQzIiApICkgKQoJCQkpOwoJCX0KCgkJLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCgkJaWYgKCBzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIiApIHsKCQkJcy5kYXRhID0galF1ZXJ5LnBhcmFtKCBzLmRhdGEsIHMudHJhZGl0aW9uYWwgKTsKCQl9CgoJCS8vIEFwcGx5IHByZWZpbHRlcnMKCQlpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggcHJlZmlsdGVycywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgcmVxdWVzdCB3YXMgYWJvcnRlZCBpbnNpZGUgYSBwcmVmaWx0ZXIsIHN0b3AgdGhlcmUKCQlpZiAoIHN0YXRlID09PSAyICkgewoJCQlyZXR1cm4ganFYSFI7CgkJfQoKCQkvLyBXZSBjYW4gZmlyZSBnbG9iYWwgZXZlbnRzIGFzIG9mIG5vdyBpZiBhc2tlZCB0bwoJCWZpcmVHbG9iYWxzID0gcy5nbG9iYWw7CgoJCS8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKCQlpZiAoIGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCApIHsKCQkJalF1ZXJ5LmV2ZW50LnRyaWdnZXIoImFqYXhTdGFydCIpOwoJCX0KCgkJLy8gVXBwZXJjYXNlIHRoZSB0eXBlCgkJcy50eXBlID0gcy50eXBlLnRvVXBwZXJDYXNlKCk7CgoJCS8vIERldGVybWluZSBpZiByZXF1ZXN0IGhhcyBjb250ZW50CgkJcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdCggcy50eXBlICk7CgoJCS8vIFNhdmUgdGhlIFVSTCBpbiBjYXNlIHdlJ3JlIHRveWluZyB3aXRoIHRoZSBJZi1Nb2RpZmllZC1TaW5jZQoJCS8vIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciBsYXRlciBvbgoJCWNhY2hlVVJMID0gcy51cmw7CgoJCS8vIE1vcmUgb3B0aW9ucyBoYW5kbGluZyBmb3IgcmVxdWVzdHMgd2l0aCBubyBjb250ZW50CgkJaWYgKCAhcy5oYXNDb250ZW50ICkgewoKCQkJLy8gSWYgZGF0YSBpcyBhdmFpbGFibGUsIGFwcGVuZCBkYXRhIHRvIHVybAoJCQlpZiAoIHMuZGF0YSApIHsKCQkJCWNhY2hlVVJMID0gKCBzLnVybCArPSAoIGFqYXhfcnF1ZXJ5LnRlc3QoIGNhY2hlVVJMICkgPyAiJiIgOiAiPyIgKSArIHMuZGF0YSApOwoJCQkJLy8gIzk2ODI6IHJlbW92ZSBkYXRhIHNvIHRoYXQgaXQncyBub3QgdXNlZCBpbiBhbiBldmVudHVhbCByZXRyeQoJCQkJZGVsZXRlIHMuZGF0YTsKCQkJfQoKCQkJLy8gQWRkIGFudGktY2FjaGUgaW4gdXJsIGlmIG5lZWRlZAoJCQlpZiAoIHMuY2FjaGUgPT09IGZhbHNlICkgewoJCQkJcy51cmwgPSBydHMudGVzdCggY2FjaGVVUkwgKSA/CgoJCQkJCS8vIElmIHRoZXJlIGlzIGFscmVhZHkgYSAnXycgcGFyYW1ldGVyLCBzZXQgaXRzIHZhbHVlCgkJCQkJY2FjaGVVUkwucmVwbGFjZSggcnRzLCAiJDFfPSIgKyBhamF4X25vbmNlKysgKSA6CgoJCQkJCS8vIE90aGVyd2lzZSBhZGQgb25lIHRvIHRoZSBlbmQKCQkJCQljYWNoZVVSTCArICggYWpheF9ycXVlcnkudGVzdCggY2FjaGVVUkwgKSA/ICImIiA6ICI/IiApICsgIl89IiArIGFqYXhfbm9uY2UrKzsKCQkJfQoJCX0KCgkJLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJaWYgKCBqUXVlcnkubGFzdE1vZGlmaWVkWyBjYWNoZVVSTCBdICkgewoJCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggIklmLU1vZGlmaWVkLVNpbmNlIiwgalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSApOwoJCQl9CgkJCWlmICggalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gKSB7CgkJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnWyBjYWNoZVVSTCBdICk7CgkJCX0KCQl9CgoJCS8vIFNldCB0aGUgY29ycmVjdCBoZWFkZXIsIGlmIGRhdGEgaXMgYmVpbmcgc2VudAoJCWlmICggcy5kYXRhICYmIHMuaGFzQ29udGVudCAmJiBzLmNvbnRlbnRUeXBlICE9PSBmYWxzZSB8fCBvcHRpb25zLmNvbnRlbnRUeXBlICkgewoJCQlqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCAiQ29udGVudC1UeXBlIiwgcy5jb250ZW50VHlwZSApOwoJCX0KCgkJLy8gU2V0IHRoZSBBY2NlcHRzIGhlYWRlciBmb3IgdGhlIHNlcnZlciwgZGVwZW5kaW5nIG9uIHRoZSBkYXRhVHlwZQoJCWpxWEhSLnNldFJlcXVlc3RIZWFkZXIoCgkJCSJBY2NlcHQiLAoJCQlzLmRhdGFUeXBlc1sgMCBdICYmIHMuYWNjZXB0c1sgcy5kYXRhVHlwZXNbMF0gXSA/CgkJCQlzLmFjY2VwdHNbIHMuZGF0YVR5cGVzWzBdIF0gKyAoIHMuZGF0YVR5cGVzWyAwIF0gIT09ICIqIiA/ICIsICIgKyBhbGxUeXBlcyArICI7IHE9MC4wMSIgOiAiIiApIDoKCQkJCXMuYWNjZXB0c1sgIioiIF0KCQkpOwoKCQkvLyBDaGVjayBmb3IgaGVhZGVycyBvcHRpb24KCQlmb3IgKCBpIGluIHMuaGVhZGVycyApIHsKCQkJanFYSFIuc2V0UmVxdWVzdEhlYWRlciggaSwgcy5oZWFkZXJzWyBpIF0gKTsKCQl9CgoJCS8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKCQlpZiAoIHMuYmVmb3JlU2VuZCAmJiAoIHMuYmVmb3JlU2VuZC5jYWxsKCBjYWxsYmFja0NvbnRleHQsIGpxWEhSLCBzICkgPT09IGZhbHNlIHx8IHN0YXRlID09PSAyICkgKSB7CgkJCS8vIEFib3J0IGlmIG5vdCBkb25lIGFscmVhZHkgYW5kIHJldHVybgoJCQlyZXR1cm4ganFYSFIuYWJvcnQoKTsKCQl9CgoJCS8vIGFib3J0aW5nIGlzIG5vIGxvbmdlciBhIGNhbmNlbGxhdGlvbgoJCXN0ckFib3J0ID0gImFib3J0IjsKCgkJLy8gSW5zdGFsbCBjYWxsYmFja3Mgb24gZGVmZXJyZWRzCgkJZm9yICggaSBpbiB7IHN1Y2Nlc3M6IDEsIGVycm9yOiAxLCBjb21wbGV0ZTogMSB9ICkgewoJCQlqcVhIUlsgaSBdKCBzWyBpIF0gKTsKCQl9CgoJCS8vIEdldCB0cmFuc3BvcnQKCQl0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyggdHJhbnNwb3J0cywgcywgb3B0aW9ucywganFYSFIgKTsKCgkJLy8gSWYgbm8gdHJhbnNwb3J0LCB3ZSBhdXRvLWFib3J0CgkJaWYgKCAhdHJhbnNwb3J0ICkgewoJCQlkb25lKCAtMSwgIk5vIFRyYW5zcG9ydCIgKTsKCQl9IGVsc2UgewoJCQlqcVhIUi5yZWFkeVN0YXRlID0gMTsKCgkJCS8vIFNlbmQgZ2xvYmFsIGV2ZW50CgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggImFqYXhTZW5kIiwgWyBqcVhIUiwgcyBdICk7CgkJCX0KCQkJLy8gVGltZW91dAoJCQlpZiAoIHMuYXN5bmMgJiYgcy50aW1lb3V0ID4gMCApIHsKCQkJCXRpbWVvdXRUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJanFYSFIuYWJvcnQoInRpbWVvdXQiKTsKCQkJCX0sIHMudGltZW91dCApOwoJCQl9CgoJCQl0cnkgewoJCQkJc3RhdGUgPSAxOwoJCQkJdHJhbnNwb3J0LnNlbmQoIHJlcXVlc3RIZWFkZXJzLCBkb25lICk7CgkJCX0gY2F0Y2ggKCBlICkgewoJCQkJLy8gUHJvcGFnYXRlIGV4Y2VwdGlvbiBhcyBlcnJvciBpZiBub3QgZG9uZQoJCQkJaWYgKCBzdGF0ZSA8IDIgKSB7CgkJCQkJZG9uZSggLTEsIGUgKTsKCQkJCS8vIFNpbXBseSByZXRocm93IG90aGVyd2lzZQoJCQkJfSBlbHNlIHsKCQkJCQl0aHJvdyBlOwoJCQkJfQoJCQl9CgkJfQoKCQkvLyBDYWxsYmFjayBmb3Igd2hlbiBldmVyeXRoaW5nIGlzIGRvbmUKCQlmdW5jdGlvbiBkb25lKCBzdGF0dXMsIG5hdGl2ZVN0YXR1c1RleHQsIHJlc3BvbnNlcywgaGVhZGVycyApIHsKCQkJdmFyIGlzU3VjY2Vzcywgc3VjY2VzcywgZXJyb3IsIHJlc3BvbnNlLCBtb2RpZmllZCwKCQkJCXN0YXR1c1RleHQgPSBuYXRpdmVTdGF0dXNUZXh0OwoKCQkJLy8gQ2FsbGVkIG9uY2UKCQkJaWYgKCBzdGF0ZSA9PT0gMiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gU3RhdGUgaXMgImRvbmUiIG5vdwoJCQlzdGF0ZSA9IDI7CgoJCQkvLyBDbGVhciB0aW1lb3V0IGlmIGl0IGV4aXN0cwoJCQlpZiAoIHRpbWVvdXRUaW1lciApIHsKCQkJCWNsZWFyVGltZW91dCggdGltZW91dFRpbWVyICk7CgkJCX0KCgkJCS8vIERlcmVmZXJlbmNlIHRyYW5zcG9ydCBmb3IgZWFybHkgZ2FyYmFnZSBjb2xsZWN0aW9uCgkJCS8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCgkJCXRyYW5zcG9ydCA9IHVuZGVmaW5lZDsKCgkJCS8vIENhY2hlIHJlc3BvbnNlIGhlYWRlcnMKCQkJcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCgkJCS8vIFNldCByZWFkeVN0YXRlCgkJCWpxWEhSLnJlYWR5U3RhdGUgPSBzdGF0dXMgPiAwID8gNCA6IDA7CgoJCQkvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAoJCQlpc1N1Y2Nlc3MgPSBzdGF0dXMgPj0gMjAwICYmIHN0YXR1cyA8IDMwMCB8fCBzdGF0dXMgPT09IDMwNDsKCgkJCS8vIEdldCByZXNwb25zZSBkYXRhCgkJCWlmICggcmVzcG9uc2VzICkgewoJCQkJcmVzcG9uc2UgPSBhamF4SGFuZGxlUmVzcG9uc2VzKCBzLCBqcVhIUiwgcmVzcG9uc2VzICk7CgkJCX0KCgkJCS8vIENvbnZlcnQgbm8gbWF0dGVyIHdoYXQgKHRoYXQgd2F5IHJlc3BvbnNlWFhYIGZpZWxkcyBhcmUgYWx3YXlzIHNldCkKCQkJcmVzcG9uc2UgPSBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKTsKCgkJCS8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCgkJCWlmICggaXNTdWNjZXNzICkgewoKCQkJCS8vIFNldCB0aGUgSWYtTW9kaWZpZWQtU2luY2UgYW5kL29yIElmLU5vbmUtTWF0Y2ggaGVhZGVyLCBpZiBpbiBpZk1vZGlmaWVkIG1vZGUuCgkJCQlpZiAoIHMuaWZNb2RpZmllZCApIHsKCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJMYXN0LU1vZGlmaWVkIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5Lmxhc3RNb2RpZmllZFsgY2FjaGVVUkwgXSA9IG1vZGlmaWVkOwoJCQkJCX0KCQkJCQltb2RpZmllZCA9IGpxWEhSLmdldFJlc3BvbnNlSGVhZGVyKCJldGFnIik7CgkJCQkJaWYgKCBtb2RpZmllZCApIHsKCQkJCQkJalF1ZXJ5LmV0YWdbIGNhY2hlVVJMIF0gPSBtb2RpZmllZDsKCQkJCQl9CgkJCQl9CgoJCQkJLy8gaWYgbm8gY29udGVudAoJCQkJaWYgKCBzdGF0dXMgPT09IDIwNCB8fCBzLnR5cGUgPT09ICJIRUFEIiApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vY29udGVudCI7CgoJCQkJLy8gaWYgbm90IG1vZGlmaWVkCgkJCQl9IGVsc2UgaWYgKCBzdGF0dXMgPT09IDMwNCApIHsKCQkJCQlzdGF0dXNUZXh0ID0gIm5vdG1vZGlmaWVkIjsKCgkJCQkvLyBJZiB3ZSBoYXZlIGRhdGEsIGxldCdzIGNvbnZlcnQgaXQKCQkJCX0gZWxzZSB7CgkJCQkJc3RhdHVzVGV4dCA9IHJlc3BvbnNlLnN0YXRlOwoJCQkJCXN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwoJCQkJCWVycm9yID0gcmVzcG9uc2UuZXJyb3I7CgkJCQkJaXNTdWNjZXNzID0gIWVycm9yOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJLy8gV2UgZXh0cmFjdCBlcnJvciBmcm9tIHN0YXR1c1RleHQKCQkJCS8vIHRoZW4gbm9ybWFsaXplIHN0YXR1c1RleHQgYW5kIHN0YXR1cyBmb3Igbm9uLWFib3J0cwoJCQkJZXJyb3IgPSBzdGF0dXNUZXh0OwoJCQkJaWYgKCBzdGF0dXMgfHwgIXN0YXR1c1RleHQgKSB7CgkJCQkJc3RhdHVzVGV4dCA9ICJlcnJvciI7CgkJCQkJaWYgKCBzdGF0dXMgPCAwICkgewoJCQkJCQlzdGF0dXMgPSAwOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKCQkJanFYSFIuc3RhdHVzID0gc3RhdHVzOwoJCQlqcVhIUi5zdGF0dXNUZXh0ID0gKCBuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQgKSArICIiOwoKCQkJLy8gU3VjY2Vzcy9FcnJvcgoJCQlpZiAoIGlzU3VjY2VzcyApIHsKCQkJCWRlZmVycmVkLnJlc29sdmVXaXRoKCBjYWxsYmFja0NvbnRleHQsIFsgc3VjY2Vzcywgc3RhdHVzVGV4dCwganFYSFIgXSApOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggY2FsbGJhY2tDb250ZXh0LCBbIGpxWEhSLCBzdGF0dXNUZXh0LCBlcnJvciBdICk7CgkJCX0KCgkJCS8vIFN0YXR1cy1kZXBlbmRlbnQgY2FsbGJhY2tzCgkJCWpxWEhSLnN0YXR1c0NvZGUoIHN0YXR1c0NvZGUgKTsKCQkJc3RhdHVzQ29kZSA9IHVuZGVmaW5lZDsKCgkJCWlmICggZmlyZUdsb2JhbHMgKSB7CgkJCQlnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlciggaXNTdWNjZXNzID8gImFqYXhTdWNjZXNzIiA6ICJhamF4RXJyb3IiLAoJCQkJCVsganFYSFIsIHMsIGlzU3VjY2VzcyA/IHN1Y2Nlc3MgOiBlcnJvciBdICk7CgkJCX0KCgkJCS8vIENvbXBsZXRlCgkJCWNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoIGNhbGxiYWNrQ29udGV4dCwgWyBqcVhIUiwgc3RhdHVzVGV4dCBdICk7CgoJCQlpZiAoIGZpcmVHbG9iYWxzICkgewoJCQkJZ2xvYmFsRXZlbnRDb250ZXh0LnRyaWdnZXIoICJhamF4Q29tcGxldGUiLCBbIGpxWEhSLCBzIF0gKTsKCQkJCS8vIEhhbmRsZSB0aGUgZ2xvYmFsIEFKQVggY291bnRlcgoJCQkJaWYgKCAhKCAtLWpRdWVyeS5hY3RpdmUgKSApIHsKCQkJCQlqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGpxWEhSOwoJfSwKCglnZXRKU09OOiBmdW5jdGlvbiggdXJsLCBkYXRhLCBjYWxsYmFjayApIHsKCQlyZXR1cm4galF1ZXJ5LmdldCggdXJsLCBkYXRhLCBjYWxsYmFjaywgImpzb24iICk7Cgl9LAoKCWdldFNjcmlwdDogZnVuY3Rpb24oIHVybCwgY2FsbGJhY2sgKSB7CgkJcmV0dXJuIGpRdWVyeS5nZXQoIHVybCwgdW5kZWZpbmVkLCBjYWxsYmFjaywgInNjcmlwdCIgKTsKCX0KfSk7CgpqUXVlcnkuZWFjaCggWyAiZ2V0IiwgInBvc3QiIF0sIGZ1bmN0aW9uKCBpLCBtZXRob2QgKSB7CglqUXVlcnlbIG1ldGhvZCBdID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgY2FsbGJhY2ssIHR5cGUgKSB7CgkJLy8gc2hpZnQgYXJndW1lbnRzIGlmIGRhdGEgYXJndW1lbnQgd2FzIG9taXR0ZWQKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBkYXRhICkgKSB7CgkJCXR5cGUgPSB0eXBlIHx8IGNhbGxiYWNrOwoJCQljYWxsYmFjayA9IGRhdGE7CgkJCWRhdGEgPSB1bmRlZmluZWQ7CgkJfQoKCQlyZXR1cm4galF1ZXJ5LmFqYXgoewoJCQl1cmw6IHVybCwKCQkJdHlwZTogbWV0aG9kLAoJCQlkYXRhVHlwZTogdHlwZSwKCQkJZGF0YTogZGF0YSwKCQkJc3VjY2VzczogY2FsbGJhY2sKCQl9KTsKCX07Cn0pOwoKLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogKiAtIGZpbmRzIHRoZSByaWdodCBkYXRhVHlwZSAobWVkaWF0ZXMgYmV0d2VlbiBjb250ZW50LXR5cGUgYW5kIGV4cGVjdGVkIGRhdGFUeXBlKQogKiAtIHJldHVybnMgdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKICovCmZ1bmN0aW9uIGFqYXhIYW5kbGVSZXNwb25zZXMoIHMsIGpxWEhSLCByZXNwb25zZXMgKSB7CgoJdmFyIGN0LCB0eXBlLCBmaW5hbERhdGFUeXBlLCBmaXJzdERhdGFUeXBlLAoJCWNvbnRlbnRzID0gcy5jb250ZW50cywKCQlkYXRhVHlwZXMgPSBzLmRhdGFUeXBlczsKCgkvLyBSZW1vdmUgYXV0byBkYXRhVHlwZSBhbmQgZ2V0IGNvbnRlbnQtdHlwZSBpbiB0aGUgcHJvY2VzcwoJd2hpbGUoIGRhdGFUeXBlc1sgMCBdID09PSAiKiIgKSB7CgkJZGF0YVR5cGVzLnNoaWZ0KCk7CgkJaWYgKCBjdCA9PT0gdW5kZWZpbmVkICkgewoJCQljdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwoJCX0KCX0KCgkvLyBDaGVjayBpZiB3ZSdyZSBkZWFsaW5nIHdpdGggYSBrbm93biBjb250ZW50LXR5cGUKCWlmICggY3QgKSB7CgkJZm9yICggdHlwZSBpbiBjb250ZW50cyApIHsKCQkJaWYgKCBjb250ZW50c1sgdHlwZSBdICYmIGNvbnRlbnRzWyB0eXBlIF0udGVzdCggY3QgKSApIHsKCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0eXBlICk7CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCgkvLyBDaGVjayB0byBzZWUgaWYgd2UgaGF2ZSBhIHJlc3BvbnNlIGZvciB0aGUgZXhwZWN0ZWQgZGF0YVR5cGUKCWlmICggZGF0YVR5cGVzWyAwIF0gaW4gcmVzcG9uc2VzICkgewoJCWZpbmFsRGF0YVR5cGUgPSBkYXRhVHlwZXNbIDAgXTsKCX0gZWxzZSB7CgkJLy8gVHJ5IGNvbnZlcnRpYmxlIGRhdGFUeXBlcwoJCWZvciAoIHR5cGUgaW4gcmVzcG9uc2VzICkgewoJCQlpZiAoICFkYXRhVHlwZXNbIDAgXSB8fCBzLmNvbnZlcnRlcnNbIHR5cGUgKyAiICIgKyBkYXRhVHlwZXNbMF0gXSApIHsKCQkJCWZpbmFsRGF0YVR5cGUgPSB0eXBlOwoJCQkJYnJlYWs7CgkJCX0KCQkJaWYgKCAhZmlyc3REYXRhVHlwZSApIHsKCQkJCWZpcnN0RGF0YVR5cGUgPSB0eXBlOwoJCQl9CgkJfQoJCS8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQoJCWZpbmFsRGF0YVR5cGUgPSBmaW5hbERhdGFUeXBlIHx8IGZpcnN0RGF0YVR5cGU7Cgl9CgoJLy8gSWYgd2UgZm91bmQgYSBkYXRhVHlwZQoJLy8gV2UgYWRkIHRoZSBkYXRhVHlwZSB0byB0aGUgbGlzdCBpZiBuZWVkZWQKCS8vIGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcmVzcG9uc2UKCWlmICggZmluYWxEYXRhVHlwZSApIHsKCQlpZiAoIGZpbmFsRGF0YVR5cGUgIT09IGRhdGFUeXBlc1sgMCBdICkgewoJCQlkYXRhVHlwZXMudW5zaGlmdCggZmluYWxEYXRhVHlwZSApOwoJCX0KCQlyZXR1cm4gcmVzcG9uc2VzWyBmaW5hbERhdGFUeXBlIF07Cgl9Cn0KCi8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICogQWxzbyBzZXRzIHRoZSByZXNwb25zZVhYWCBmaWVsZHMgb24gdGhlIGpxWEhSIGluc3RhbmNlCiAqLwpmdW5jdGlvbiBhamF4Q29udmVydCggcywgcmVzcG9uc2UsIGpxWEhSLCBpc1N1Y2Nlc3MgKSB7Cgl2YXIgY29udjIsIGN1cnJlbnQsIGNvbnYsIHRtcCwgcHJldiwKCQljb252ZXJ0ZXJzID0ge30sCgkJLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgoJCWRhdGFUeXBlcyA9IHMuZGF0YVR5cGVzLnNsaWNlKCk7CgoJLy8gQ3JlYXRlIGNvbnZlcnRlcnMgbWFwIHdpdGggbG93ZXJjYXNlZCBrZXlzCglpZiAoIGRhdGFUeXBlc1sgMSBdICkgewoJCWZvciAoIGNvbnYgaW4gcy5jb252ZXJ0ZXJzICkgewoJCQljb252ZXJ0ZXJzWyBjb252LnRvTG93ZXJDYXNlKCkgXSA9IHMuY29udmVydGVyc1sgY29udiBdOwoJCX0KCX0KCgljdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgoJLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKCXdoaWxlICggY3VycmVudCApIHsKCgkJaWYgKCBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gKSB7CgkJCWpxWEhSWyBzLnJlc3BvbnNlRmllbGRzWyBjdXJyZW50IF0gXSA9IHJlc3BvbnNlOwoJCX0KCgkJLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKCQlpZiAoICFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIgKSB7CgkJCXJlc3BvbnNlID0gcy5kYXRhRmlsdGVyKCByZXNwb25zZSwgcy5kYXRhVHlwZSApOwoJCX0KCgkJcHJldiA9IGN1cnJlbnQ7CgkJY3VycmVudCA9IGRhdGFUeXBlcy5zaGlmdCgpOwoKCQlpZiAoIGN1cnJlbnQgKSB7CgoJCS8vIFRoZXJlJ3Mgb25seSB3b3JrIHRvIGRvIGlmIGN1cnJlbnQgZGF0YVR5cGUgaXMgbm9uLWF1dG8KCQkJaWYgKCBjdXJyZW50ID09PSAiKiIgKSB7CgoJCQkJY3VycmVudCA9IHByZXY7CgoJCQkvLyBDb252ZXJ0IHJlc3BvbnNlIGlmIHByZXYgZGF0YVR5cGUgaXMgbm9uLWF1dG8gYW5kIGRpZmZlcnMgZnJvbSBjdXJyZW50CgkJCX0gZWxzZSBpZiAoIHByZXYgIT09ICIqIiAmJiBwcmV2ICE9PSBjdXJyZW50ICkgewoKCQkJCS8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCgkJCQljb252ID0gY29udmVydGVyc1sgcHJldiArICIgIiArIGN1cnJlbnQgXSB8fCBjb252ZXJ0ZXJzWyAiKiAiICsgY3VycmVudCBdOwoKCQkJCS8vIElmIG5vbmUgZm91bmQsIHNlZWsgYSBwYWlyCgkJCQlpZiAoICFjb252ICkgewoJCQkJCWZvciAoIGNvbnYyIGluIGNvbnZlcnRlcnMgKSB7CgoJCQkJCQkvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKCQkJCQkJdG1wID0gY29udjIuc3BsaXQoICIgIiApOwoJCQkJCQlpZiAoIHRtcFsgMSBdID09PSBjdXJyZW50ICkgewoKCQkJCQkJCS8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAoJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIHByZXYgKyAiICIgKyB0bXBbIDAgXSBdIHx8CgkJCQkJCQkJY29udmVydGVyc1sgIiogIiArIHRtcFsgMCBdIF07CgkJCQkJCQlpZiAoIGNvbnYgKSB7CgkJCQkJCQkJLy8gQ29uZGVuc2UgZXF1aXZhbGVuY2UgY29udmVydGVycwoJCQkJCQkJCWlmICggY29udiA9PT0gdHJ1ZSApIHsKCQkJCQkJCQkJY29udiA9IGNvbnZlcnRlcnNbIGNvbnYyIF07CgoJCQkJCQkJCS8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKCQkJCQkJCQl9IGVsc2UgaWYgKCBjb252ZXJ0ZXJzWyBjb252MiBdICE9PSB0cnVlICkgewoJCQkJCQkJCQljdXJyZW50ID0gdG1wWyAwIF07CgkJCQkJCQkJCWRhdGFUeXBlcy51bnNoaWZ0KCB0bXBbIDEgXSApOwoJCQkJCQkJCX0KCQkJCQkJCQlicmVhazsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCgkJCQkvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKCQkJCWlmICggY29udiAhPT0gdHJ1ZSApIHsKCgkJCQkJLy8gVW5sZXNzIGVycm9ycyBhcmUgYWxsb3dlZCB0byBidWJibGUsIGNhdGNoIGFuZCByZXR1cm4gdGhlbQoJCQkJCWlmICggY29udiAmJiBzWyAidGhyb3dzIiBdICkgewoJCQkJCQlyZXNwb25zZSA9IGNvbnYoIHJlc3BvbnNlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCXJlc3BvbnNlID0gY29udiggcmVzcG9uc2UgKTsKCQkJCQkJfSBjYXRjaCAoIGUgKSB7CgkJCQkJCQlyZXR1cm4geyBzdGF0ZTogInBhcnNlcmVycm9yIiwgZXJyb3I6IGNvbnYgPyBlIDogIk5vIGNvbnZlcnNpb24gZnJvbSAiICsgcHJldiArICIgdG8gIiArIGN1cnJlbnQgfTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCX0KCglyZXR1cm4geyBzdGF0ZTogInN1Y2Nlc3MiLCBkYXRhOiByZXNwb25zZSB9Owp9Ci8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCmpRdWVyeS5hamF4U2V0dXAoewoJYWNjZXB0czogewoJCXNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgYXBwbGljYXRpb24vZWNtYXNjcmlwdCwgYXBwbGljYXRpb24veC1lY21hc2NyaXB0IgoJfSwKCWNvbnRlbnRzOiB7CgkJc2NyaXB0OiAvKD86amF2YXxlY21hKXNjcmlwdC8KCX0sCgljb252ZXJ0ZXJzOiB7CgkJInRleHQgc2NyaXB0IjogZnVuY3Rpb24oIHRleHQgKSB7CgkJCWpRdWVyeS5nbG9iYWxFdmFsKCB0ZXh0ICk7CgkJCXJldHVybiB0ZXh0OwoJCX0KCX0KfSk7CgovLyBIYW5kbGUgY2FjaGUncyBzcGVjaWFsIGNhc2UgYW5kIGNyb3NzRG9tYWluCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CglpZiAoIHMuY2FjaGUgPT09IHVuZGVmaW5lZCApIHsKCQlzLmNhY2hlID0gZmFsc2U7Cgl9CglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJcy50eXBlID0gIkdFVCI7Cgl9Cn0pOwoKLy8gQmluZCBzY3JpcHQgdGFnIGhhY2sgdHJhbnNwb3J0CmpRdWVyeS5hamF4VHJhbnNwb3J0KCAic2NyaXB0IiwgZnVuY3Rpb24oIHMgKSB7CgkvLyBUaGlzIHRyYW5zcG9ydCBvbmx5IGRlYWxzIHdpdGggY3Jvc3MgZG9tYWluIHJlcXVlc3RzCglpZiAoIHMuY3Jvc3NEb21haW4gKSB7CgkJdmFyIHNjcmlwdCwgY2FsbGJhY2s7CgkJcmV0dXJuIHsKCQkJc2VuZDogZnVuY3Rpb24oIF8sIGNvbXBsZXRlICkgewoJCQkJc2NyaXB0ID0galF1ZXJ5KCI8c2NyaXB0PiIpLnByb3AoewoJCQkJCWFzeW5jOiB0cnVlLAoJCQkJCWNoYXJzZXQ6IHMuc2NyaXB0Q2hhcnNldCwKCQkJCQlzcmM6IHMudXJsCgkJCQl9KS5vbigKCQkJCQkibG9hZCBlcnJvciIsCgkJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggZXZ0ICkgewoJCQkJCQlzY3JpcHQucmVtb3ZlKCk7CgkJCQkJCWNhbGxiYWNrID0gbnVsbDsKCQkJCQkJaWYgKCBldnQgKSB7CgkJCQkJCQljb21wbGV0ZSggZXZ0LnR5cGUgPT09ICJlcnJvciIgPyA0MDQgOiAyMDAsIGV2dC50eXBlICk7CgkJCQkJCX0KCQkJCQl9CgkJCQkpOwoJCQkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZCggc2NyaXB0WyAwIF0gKTsKCQkJfSwKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjaygpOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CnZhciBvbGRDYWxsYmFja3MgPSBbXSwKCXJqc29ucCA9IC8oPSlcPyg/PSZ8JCl8XD9cPy87CgovLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCmpRdWVyeS5hamF4U2V0dXAoewoJanNvbnA6ICJjYWxsYmFjayIsCglqc29ucENhbGxiYWNrOiBmdW5jdGlvbigpIHsKCQl2YXIgY2FsbGJhY2sgPSBvbGRDYWxsYmFja3MucG9wKCkgfHwgKCBqUXVlcnkuZXhwYW5kbyArICJfIiArICggYWpheF9ub25jZSsrICkgKTsKCQl0aGlzWyBjYWxsYmFjayBdID0gdHJ1ZTsKCQlyZXR1cm4gY2FsbGJhY2s7Cgl9Cn0pOwoKLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCmpRdWVyeS5hamF4UHJlZmlsdGVyKCAianNvbiBqc29ucCIsIGZ1bmN0aW9uKCBzLCBvcmlnaW5hbFNldHRpbmdzLCBqcVhIUiApIHsKCgl2YXIgY2FsbGJhY2tOYW1lLCBvdmVyd3JpdHRlbiwgcmVzcG9uc2VDb250YWluZXIsCgkJanNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAoIHJqc29ucC50ZXN0KCBzLnVybCApID8KCQkJInVybCIgOgoJCQl0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAhKCBzLmNvbnRlbnRUeXBlIHx8ICIiICkuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgJiYgcmpzb25wLnRlc3QoIHMuZGF0YSApICYmICJkYXRhIgoJCSk7CgoJLy8gSGFuZGxlIGlmZiB0aGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGlzICJqc29ucCIgb3Igd2UgaGF2ZSBhIHBhcmFtZXRlciB0byBzZXQKCWlmICgganNvblByb3AgfHwgcy5kYXRhVHlwZXNbIDAgXSA9PT0gImpzb25wIiApIHsKCgkJLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAoJCWNhbGxiYWNrTmFtZSA9IHMuanNvbnBDYWxsYmFjayA9IGpRdWVyeS5pc0Z1bmN0aW9uKCBzLmpzb25wQ2FsbGJhY2sgKSA/CgkJCXMuanNvbnBDYWxsYmFjaygpIDoKCQkJcy5qc29ucENhbGxiYWNrOwoKCQkvLyBJbnNlcnQgY2FsbGJhY2sgaW50byB1cmwgb3IgZm9ybSBkYXRhCgkJaWYgKCBqc29uUHJvcCApIHsKCQkJc1sganNvblByb3AgXSA9IHNbIGpzb25Qcm9wIF0ucmVwbGFjZSggcmpzb25wLCAiJDEiICsgY2FsbGJhY2tOYW1lICk7CgkJfSBlbHNlIGlmICggcy5qc29ucCAhPT0gZmFsc2UgKSB7CgkJCXMudXJsICs9ICggYWpheF9ycXVlcnkudGVzdCggcy51cmwgKSA/ICImIiA6ICI/IiApICsgcy5qc29ucCArICI9IiArIGNhbGxiYWNrTmFtZTsKCQl9CgoJCS8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KCQlzLmNvbnZlcnRlcnNbInNjcmlwdCBqc29uIl0gPSBmdW5jdGlvbigpIHsKCQkJaWYgKCAhcmVzcG9uc2VDb250YWluZXIgKSB7CgkJCQlqUXVlcnkuZXJyb3IoIGNhbGxiYWNrTmFtZSArICIgd2FzIG5vdCBjYWxsZWQiICk7CgkJCX0KCQkJcmV0dXJuIHJlc3BvbnNlQ29udGFpbmVyWyAwIF07CgkJfTsKCgkJLy8gZm9yY2UganNvbiBkYXRhVHlwZQoJCXMuZGF0YVR5cGVzWyAwIF0gPSAianNvbiI7CgoJCS8vIEluc3RhbGwgY2FsbGJhY2sKCQlvdmVyd3JpdHRlbiA9IHdpbmRvd1sgY2FsbGJhY2tOYW1lIF07CgkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IGZ1bmN0aW9uKCkgewoJCQlyZXNwb25zZUNvbnRhaW5lciA9IGFyZ3VtZW50czsKCQl9OwoKCQkvLyBDbGVhbi11cCBmdW5jdGlvbiAoZmlyZXMgYWZ0ZXIgY29udmVydGVycykKCQlqcVhIUi5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIFJlc3RvcmUgcHJlZXhpc3RpbmcgdmFsdWUKCQkJd2luZG93WyBjYWxsYmFja05hbWUgXSA9IG92ZXJ3cml0dGVuOwoKCQkJLy8gU2F2ZSBiYWNrIGFzIGZyZWUKCQkJaWYgKCBzWyBjYWxsYmFja05hbWUgXSApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHJlLXVzaW5nIHRoZSBvcHRpb25zIGRvZXNuJ3Qgc2NyZXcgdGhpbmdzIGFyb3VuZAoJCQkJcy5qc29ucENhbGxiYWNrID0gb3JpZ2luYWxTZXR0aW5ncy5qc29ucENhbGxiYWNrOwoKCQkJCS8vIHNhdmUgdGhlIGNhbGxiYWNrIG5hbWUgZm9yIGZ1dHVyZSB1c2UKCQkJCW9sZENhbGxiYWNrcy5wdXNoKCBjYWxsYmFja05hbWUgKTsKCQkJfQoKCQkJLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCgkJCWlmICggcmVzcG9uc2VDb250YWluZXIgJiYgalF1ZXJ5LmlzRnVuY3Rpb24oIG92ZXJ3cml0dGVuICkgKSB7CgkJCQlvdmVyd3JpdHRlbiggcmVzcG9uc2VDb250YWluZXJbIDAgXSApOwoJCQl9CgoJCQlyZXNwb25zZUNvbnRhaW5lciA9IG92ZXJ3cml0dGVuID0gdW5kZWZpbmVkOwoJCX0pOwoKCQkvLyBEZWxlZ2F0ZSB0byBzY3JpcHQKCQlyZXR1cm4gInNjcmlwdCI7Cgl9Cn0pOwpqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uKCkgewoJdHJ5IHsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9IGNhdGNoKCBlICkge30KfTsKCnZhciB4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpLAoJeGhyU3VjY2Vzc1N0YXR1cyA9IHsKCQkvLyBmaWxlIHByb3RvY29sIGFsd2F5cyB5aWVsZHMgc3RhdHVzIGNvZGUgMCwgYXNzdW1lIDIwMAoJCTA6IDIwMCwKCQkvLyBTdXBwb3J0OiBJRTkKCQkvLyAjMTQ1MDogc29tZXRpbWVzIElFIHJldHVybnMgMTIyMyB3aGVuIGl0IHNob3VsZCBiZSAyMDQKCQkxMjIzOiAyMDQKCX0sCgkvLyBTdXBwb3J0OiBJRTkKCS8vIFdlIG5lZWQgdG8ga2VlcCB0cmFjayBvZiBvdXRib3VuZCB4aHIgYW5kIGFib3J0IHRoZW0gbWFudWFsbHkKCS8vIGJlY2F1c2UgSUUgaXMgbm90IHNtYXJ0IGVub3VnaCB0byBkbyBpdCBhbGwgYnkgaXRzZWxmCgl4aHJJZCA9IDAsCgl4aHJDYWxsYmFja3MgPSB7fTsKCmlmICggd2luZG93LkFjdGl2ZVhPYmplY3QgKSB7CglqUXVlcnkoIHdpbmRvdyApLm9uKCAidW5sb2FkIiwgZnVuY3Rpb24oKSB7CgkJZm9yKCB2YXIga2V5IGluIHhockNhbGxiYWNrcyApIHsKCQkJeGhyQ2FsbGJhY2tzWyBrZXkgXSgpOwoJCX0KCQl4aHJDYWxsYmFja3MgPSB1bmRlZmluZWQ7Cgl9KTsKfQoKalF1ZXJ5LnN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICggIndpdGhDcmVkZW50aWFscyIgaW4geGhyU3VwcG9ydGVkICk7CmpRdWVyeS5zdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKCmpRdWVyeS5hamF4VHJhbnNwb3J0KGZ1bmN0aW9uKCBvcHRpb25zICkgewoJdmFyIGNhbGxiYWNrOwoJLy8gQ3Jvc3MgZG9tYWluIG9ubHkgYWxsb3dlZCBpZiBzdXBwb3J0ZWQgdGhyb3VnaCBYTUxIdHRwUmVxdWVzdAoJaWYgKCBqUXVlcnkuc3VwcG9ydC5jb3JzIHx8IHhoclN1cHBvcnRlZCAmJiAhb3B0aW9ucy5jcm9zc0RvbWFpbiApIHsKCQlyZXR1cm4gewoJCQlzZW5kOiBmdW5jdGlvbiggaGVhZGVycywgY29tcGxldGUgKSB7CgkJCQl2YXIgaSwgaWQsCgkJCQkJeGhyID0gb3B0aW9ucy54aHIoKTsKCQkJCXhoci5vcGVuKCBvcHRpb25zLnR5cGUsIG9wdGlvbnMudXJsLCBvcHRpb25zLmFzeW5jLCBvcHRpb25zLnVzZXJuYW1lLCBvcHRpb25zLnBhc3N3b3JkICk7CgkJCQkvLyBBcHBseSBjdXN0b20gZmllbGRzIGlmIHByb3ZpZGVkCgkJCQlpZiAoIG9wdGlvbnMueGhyRmllbGRzICkgewoJCQkJCWZvciAoIGkgaW4gb3B0aW9ucy54aHJGaWVsZHMgKSB7CgkJCQkJCXhoclsgaSBdID0gb3B0aW9ucy54aHJGaWVsZHNbIGkgXTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBPdmVycmlkZSBtaW1lIHR5cGUgaWYgbmVlZGVkCgkJCQlpZiAoIG9wdGlvbnMubWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUgKSB7CgkJCQkJeGhyLm92ZXJyaWRlTWltZVR5cGUoIG9wdGlvbnMubWltZVR5cGUgKTsKCQkJCX0KCQkJCS8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCgkJCQkvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCgkJCQkvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgoJCQkJLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCgkJCQkvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KCQkJCWlmICggIW9wdGlvbnMuY3Jvc3NEb21haW4gJiYgIWhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSApIHsKCQkJCQloZWFkZXJzWyJYLVJlcXVlc3RlZC1XaXRoIl0gPSAiWE1MSHR0cFJlcXVlc3QiOwoJCQkJfQoJCQkJLy8gU2V0IGhlYWRlcnMKCQkJCWZvciAoIGkgaW4gaGVhZGVycyApIHsKCQkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlciggaSwgaGVhZGVyc1sgaSBdICk7CgkJCQl9CgkJCQkvLyBDYWxsYmFjawoJCQkJY2FsbGJhY2sgPSBmdW5jdGlvbiggdHlwZSApIHsKCQkJCQlyZXR1cm4gZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggY2FsbGJhY2sgKSB7CgkJCQkJCQlkZWxldGUgeGhyQ2FsbGJhY2tzWyBpZCBdOwoJCQkJCQkJY2FsbGJhY2sgPSB4aHIub25sb2FkID0geGhyLm9uZXJyb3IgPSBudWxsOwoJCQkJCQkJaWYgKCB0eXBlID09PSAiYWJvcnQiICkgewoJCQkJCQkJCXhoci5hYm9ydCgpOwoJCQkJCQkJfSBlbHNlIGlmICggdHlwZSA9PT0gImVycm9yIiApIHsKCQkJCQkJCQljb21wbGV0ZSgKCQkJCQkJCQkJLy8gZmlsZSBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwLCBhc3N1bWUgNDA0CgkJCQkJCQkJCXhoci5zdGF0dXMgfHwgNDA0LAoJCQkJCQkJCQl4aHIuc3RhdHVzVGV4dAoJCQkJCQkJCSk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWNvbXBsZXRlKAoJCQkJCQkJCQl4aHJTdWNjZXNzU3RhdHVzWyB4aHIuc3RhdHVzIF0gfHwgeGhyLnN0YXR1cywKCQkJCQkJCQkJeGhyLnN0YXR1c1RleHQsCgkJCQkJCQkJCS8vIFN1cHBvcnQ6IElFOQoJCQkJCQkJCQkvLyAjMTE0MjY6IFdoZW4gcmVxdWVzdGluZyBiaW5hcnkgZGF0YSwgSUU5IHdpbGwgdGhyb3cgYW4gZXhjZXB0aW9uCgkJCQkJCQkJCS8vIG9uIGFueSBhdHRlbXB0IHRvIGFjY2VzcyByZXNwb25zZVRleHQKCQkJCQkJCQkJdHlwZW9mIHhoci5yZXNwb25zZVRleHQgPT09ICJzdHJpbmciID8gewoJCQkJCQkJCQkJdGV4dDogeGhyLnJlc3BvbnNlVGV4dAoJCQkJCQkJCQl9IDogdW5kZWZpbmVkLAoJCQkJCQkJCQl4aHIuZ2V0QWxsUmVzcG9uc2VIZWFkZXJzKCkKCQkJCQkJCQkpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfTsKCQkJCX07CgkJCQkvLyBMaXN0ZW4gdG8gZXZlbnRzCgkJCQl4aHIub25sb2FkID0gY2FsbGJhY2soKTsKCQkJCXhoci5vbmVycm9yID0gY2FsbGJhY2soImVycm9yIik7CgkJCQkvLyBDcmVhdGUgdGhlIGFib3J0IGNhbGxiYWNrCgkJCQljYWxsYmFjayA9IHhockNhbGxiYWNrc1soIGlkID0geGhySWQrKyApXSA9IGNhbGxiYWNrKCJhYm9ydCIpOwoJCQkJLy8gRG8gc2VuZCB0aGUgcmVxdWVzdAoJCQkJLy8gVGhpcyBtYXkgcmFpc2UgYW4gZXhjZXB0aW9uIHdoaWNoIGlzIGFjdHVhbGx5CgkJCQkvLyBoYW5kbGVkIGluIGpRdWVyeS5hamF4IChzbyBubyB0cnkvY2F0Y2ggaGVyZSkKCQkJCXhoci5zZW5kKCBvcHRpb25zLmhhc0NvbnRlbnQgJiYgb3B0aW9ucy5kYXRhIHx8IG51bGwgKTsKCQkJfSwKCQkJYWJvcnQ6IGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjaygpOwoJCQkJfQoJCQl9CgkJfTsKCX0KfSk7CnZhciBmeE5vdywgdGltZXJJZCwKCXJmeHR5cGVzID0gL14oPzp0b2dnbGV8c2hvd3xoaWRlKSQvLAoJcmZ4bnVtID0gbmV3IFJlZ0V4cCggIl4oPzooWystXSk9fCkoIiArIGNvcmVfcG51bSArICIpKFthLXolXSopJCIsICJpIiApLAoJcnJ1biA9IC9xdWV1ZUhvb2tzJC8sCglhbmltYXRpb25QcmVmaWx0ZXJzID0gWyBkZWZhdWx0UHJlZmlsdGVyIF0sCgl0d2VlbmVycyA9IHsKCQkiKiI6IFtmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJCXZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4oIHByb3AsIHZhbHVlICksCgkJCQl0YXJnZXQgPSB0d2Vlbi5jdXIoKSwKCQkJCXBhcnRzID0gcmZ4bnVtLmV4ZWMoIHZhbHVlICksCgkJCQl1bml0ID0gcGFydHMgJiYgcGFydHNbIDMgXSB8fCAoIGpRdWVyeS5jc3NOdW1iZXJbIHByb3AgXSA/ICIiIDogInB4IiApLAoKCQkJCS8vIFN0YXJ0aW5nIHZhbHVlIGNvbXB1dGF0aW9uIGlzIHJlcXVpcmVkIGZvciBwb3RlbnRpYWwgdW5pdCBtaXNtYXRjaGVzCgkJCQlzdGFydCA9ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdIHx8IHVuaXQgIT09ICJweCIgJiYgK3RhcmdldCApICYmCgkJCQkJcmZ4bnVtLmV4ZWMoIGpRdWVyeS5jc3MoIHR3ZWVuLmVsZW0sIHByb3AgKSApLAoJCQkJc2NhbGUgPSAxLAoJCQkJbWF4SXRlcmF0aW9ucyA9IDIwOwoKCQkJaWYgKCBzdGFydCAmJiBzdGFydFsgMyBdICE9PSB1bml0ICkgewoJCQkJLy8gVHJ1c3QgdW5pdHMgcmVwb3J0ZWQgYnkgalF1ZXJ5LmNzcwoJCQkJdW5pdCA9IHVuaXQgfHwgc3RhcnRbIDMgXTsKCgkJCQkvLyBNYWtlIHN1cmUgd2UgdXBkYXRlIHRoZSB0d2VlbiBwcm9wZXJ0aWVzIGxhdGVyIG9uCgkJCQlwYXJ0cyA9IHBhcnRzIHx8IFtdOwoKCQkJCS8vIEl0ZXJhdGl2ZWx5IGFwcHJveGltYXRlIGZyb20gYSBub256ZXJvIHN0YXJ0aW5nIHBvaW50CgkJCQlzdGFydCA9ICt0YXJnZXQgfHwgMTsKCgkJCQlkbyB7CgkJCQkJLy8gSWYgcHJldmlvdXMgaXRlcmF0aW9uIHplcm9lZCBvdXQsIGRvdWJsZSB1bnRpbCB3ZSBnZXQgKnNvbWV0aGluZyoKCQkJCQkvLyBVc2UgYSBzdHJpbmcgZm9yIGRvdWJsaW5nIGZhY3RvciBzbyB3ZSBkb24ndCBhY2NpZGVudGFsbHkgc2VlIHNjYWxlIGFzIHVuY2hhbmdlZCBiZWxvdwoJCQkJCXNjYWxlID0gc2NhbGUgfHwgIi41IjsKCgkJCQkJLy8gQWRqdXN0IGFuZCBhcHBseQoJCQkJCXN0YXJ0ID0gc3RhcnQgLyBzY2FsZTsKCQkJCQlqUXVlcnkuc3R5bGUoIHR3ZWVuLmVsZW0sIHByb3AsIHN0YXJ0ICsgdW5pdCApOwoKCQkJCS8vIFVwZGF0ZSBzY2FsZSwgdG9sZXJhdGluZyB6ZXJvIG9yIE5hTiBmcm9tIHR3ZWVuLmN1cigpCgkJCQkvLyBBbmQgYnJlYWtpbmcgdGhlIGxvb3AgaWYgc2NhbGUgaXMgdW5jaGFuZ2VkIG9yIHBlcmZlY3QsIG9yIGlmIHdlJ3ZlIGp1c3QgaGFkIGVub3VnaAoJCQkJfSB3aGlsZSAoIHNjYWxlICE9PSAoc2NhbGUgPSB0d2Vlbi5jdXIoKSAvIHRhcmdldCkgJiYgc2NhbGUgIT09IDEgJiYgLS1tYXhJdGVyYXRpb25zICk7CgkJCX0KCgkJCS8vIFVwZGF0ZSB0d2VlbiBwcm9wZXJ0aWVzCgkJCWlmICggcGFydHMgKSB7CgkJCQlzdGFydCA9IHR3ZWVuLnN0YXJ0ID0gK3N0YXJ0IHx8ICt0YXJnZXQgfHwgMDsKCQkJCXR3ZWVuLnVuaXQgPSB1bml0OwoJCQkJLy8gSWYgYSArPS8tPSB0b2tlbiB3YXMgcHJvdmlkZWQsIHdlJ3JlIGRvaW5nIGEgcmVsYXRpdmUgYW5pbWF0aW9uCgkJCQl0d2Vlbi5lbmQgPSBwYXJ0c1sgMSBdID8KCQkJCQlzdGFydCArICggcGFydHNbIDEgXSArIDEgKSAqIHBhcnRzWyAyIF0gOgoJCQkJCStwYXJ0c1sgMiBdOwoJCQl9CgoJCQlyZXR1cm4gdHdlZW47CgkJfV0KCX07CgovLyBBbmltYXRpb25zIGNyZWF0ZWQgc3luY2hyb25vdXNseSB3aWxsIHJ1biBzeW5jaHJvbm91c2x5CmZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlmeE5vdyA9IHVuZGVmaW5lZDsKCX0pOwoJcmV0dXJuICggZnhOb3cgPSBqUXVlcnkubm93KCkgKTsKfQoKZnVuY3Rpb24gY3JlYXRlVHdlZW4oIHZhbHVlLCBwcm9wLCBhbmltYXRpb24gKSB7Cgl2YXIgdHdlZW4sCgkJY29sbGVjdGlvbiA9ICggdHdlZW5lcnNbIHByb3AgXSB8fCBbXSApLmNvbmNhdCggdHdlZW5lcnNbICIqIiBdICksCgkJaW5kZXggPSAwLAoJCWxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoJZm9yICggOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKyApIHsKCQlpZiAoICh0d2VlbiA9IGNvbGxlY3Rpb25bIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSApKSApIHsKCgkJCS8vIHdlJ3JlIGRvbmUgd2l0aCB0aGlzIHByb3BlcnR5CgkJCXJldHVybiB0d2VlbjsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIEFuaW1hdGlvbiggZWxlbSwgcHJvcGVydGllcywgb3B0aW9ucyApIHsKCXZhciByZXN1bHQsCgkJc3RvcHBlZCwKCQlpbmRleCA9IDAsCgkJbGVuZ3RoID0gYW5pbWF0aW9uUHJlZmlsdGVycy5sZW5ndGgsCgkJZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoIGZ1bmN0aW9uKCkgewoJCQkvLyBkb24ndCBtYXRjaCBlbGVtIGluIHRoZSA6YW5pbWF0ZWQgc2VsZWN0b3IKCQkJZGVsZXRlIHRpY2suZWxlbTsKCQl9KSwKCQl0aWNrID0gZnVuY3Rpb24oKSB7CgkJCWlmICggc3RvcHBlZCApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQl2YXIgY3VycmVudFRpbWUgPSBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAoJCQkJcmVtYWluaW5nID0gTWF0aC5tYXgoIDAsIGFuaW1hdGlvbi5zdGFydFRpbWUgKyBhbmltYXRpb24uZHVyYXRpb24gLSBjdXJyZW50VGltZSApLAoJCQkJLy8gYXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIDEgLSAoIDAuNSB8fCAwICkgKCMxMjQ5NykKCQkJCXRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKCQkJCXBlcmNlbnQgPSAxIC0gdGVtcCwKCQkJCWluZGV4ID0gMCwKCQkJCWxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwoKCQkJZm9yICggOyBpbmRleCA8IGxlbmd0aCA7IGluZGV4KysgKSB7CgkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggcGVyY2VudCApOwoJCQl9CgoJCQlkZWZlcnJlZC5ub3RpZnlXaXRoKCBlbGVtLCBbIGFuaW1hdGlvbiwgcGVyY2VudCwgcmVtYWluaW5nIF0pOwoKCQkJaWYgKCBwZXJjZW50IDwgMSAmJiBsZW5ndGggKSB7CgkJCQlyZXR1cm4gcmVtYWluaW5nOwoJCQl9IGVsc2UgewoJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uIF0gKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0sCgkJYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CgkJCWVsZW06IGVsZW0sCgkJCXByb3BzOiBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcGVydGllcyApLAoJCQlvcHRzOiBqUXVlcnkuZXh0ZW5kKCB0cnVlLCB7IHNwZWNpYWxFYXNpbmc6IHt9IH0sIG9wdGlvbnMgKSwKCQkJb3JpZ2luYWxQcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLAoJCQlvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCgkJCXN0YXJ0VGltZTogZnhOb3cgfHwgY3JlYXRlRnhOb3coKSwKCQkJZHVyYXRpb246IG9wdGlvbnMuZHVyYXRpb24sCgkJCXR3ZWVuczogW10sCgkJCWNyZWF0ZVR3ZWVuOiBmdW5jdGlvbiggcHJvcCwgZW5kICkgewoJCQkJdmFyIHR3ZWVuID0galF1ZXJ5LlR3ZWVuKCBlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLAoJCQkJCQlhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nWyBwcm9wIF0gfHwgYW5pbWF0aW9uLm9wdHMuZWFzaW5nICk7CgkJCQlhbmltYXRpb24udHdlZW5zLnB1c2goIHR3ZWVuICk7CgkJCQlyZXR1cm4gdHdlZW47CgkJCX0sCgkJCXN0b3A6IGZ1bmN0aW9uKCBnb3RvRW5kICkgewoJCQkJdmFyIGluZGV4ID0gMCwKCQkJCQkvLyBpZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGVuZCwgd2Ugd2FudCB0byBydW4gYWxsIHRoZSB0d2VlbnMKCQkJCQkvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKCQkJCQlsZW5ndGggPSBnb3RvRW5kID8gYW5pbWF0aW9uLnR3ZWVucy5sZW5ndGggOiAwOwoJCQkJaWYgKCBzdG9wcGVkICkgewoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQkJc3RvcHBlZCA9IHRydWU7CgkJCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJCQlhbmltYXRpb24udHdlZW5zWyBpbmRleCBdLnJ1biggMSApOwoJCQkJfQoKCQkJCS8vIHJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWUKCQkJCS8vIG90aGVyd2lzZSwgcmVqZWN0CgkJCQlpZiAoIGdvdG9FbmQgKSB7CgkJCQkJZGVmZXJyZWQucmVzb2x2ZVdpdGgoIGVsZW0sIFsgYW5pbWF0aW9uLCBnb3RvRW5kIF0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJZGVmZXJyZWQucmVqZWN0V2l0aCggZWxlbSwgWyBhbmltYXRpb24sIGdvdG9FbmQgXSApOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9KSwKCQlwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKCglwcm9wRmlsdGVyKCBwcm9wcywgYW5pbWF0aW9uLm9wdHMuc3BlY2lhbEVhc2luZyApOwoKCWZvciAoIDsgaW5kZXggPCBsZW5ndGggOyBpbmRleCsrICkgewoJCXJlc3VsdCA9IGFuaW1hdGlvblByZWZpbHRlcnNbIGluZGV4IF0uY2FsbCggYW5pbWF0aW9uLCBlbGVtLCBwcm9wcywgYW5pbWF0aW9uLm9wdHMgKTsKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmV0dXJuIHJlc3VsdDsKCQl9Cgl9CgoJalF1ZXJ5Lm1hcCggcHJvcHMsIGNyZWF0ZVR3ZWVuLCBhbmltYXRpb24gKTsKCglpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBhbmltYXRpb24ub3B0cy5zdGFydCApICkgewoJCWFuaW1hdGlvbi5vcHRzLnN0YXJ0LmNhbGwoIGVsZW0sIGFuaW1hdGlvbiApOwoJfQoKCWpRdWVyeS5meC50aW1lcigKCQlqUXVlcnkuZXh0ZW5kKCB0aWNrLCB7CgkJCWVsZW06IGVsZW0sCgkJCWFuaW06IGFuaW1hdGlvbiwKCQkJcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCgkJfSkKCSk7CgoJLy8gYXR0YWNoIGNhbGxiYWNrcyBmcm9tIG9wdGlvbnMKCXJldHVybiBhbmltYXRpb24ucHJvZ3Jlc3MoIGFuaW1hdGlvbi5vcHRzLnByb2dyZXNzICkKCQkuZG9uZSggYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUgKQoJCS5mYWlsKCBhbmltYXRpb24ub3B0cy5mYWlsICkKCQkuYWx3YXlzKCBhbmltYXRpb24ub3B0cy5hbHdheXMgKTsKfQoKZnVuY3Rpb24gcHJvcEZpbHRlciggcHJvcHMsIHNwZWNpYWxFYXNpbmcgKSB7Cgl2YXIgaW5kZXgsIG5hbWUsIGVhc2luZywgdmFsdWUsIGhvb2tzOwoKCS8vIGNhbWVsQ2FzZSwgc3BlY2lhbEVhc2luZyBhbmQgZXhwYW5kIGNzc0hvb2sgcGFzcwoJZm9yICggaW5kZXggaW4gcHJvcHMgKSB7CgkJbmFtZSA9IGpRdWVyeS5jYW1lbENhc2UoIGluZGV4ICk7CgkJZWFzaW5nID0gc3BlY2lhbEVhc2luZ1sgbmFtZSBdOwoJCXZhbHVlID0gcHJvcHNbIGluZGV4IF07CgkJaWYgKCBqUXVlcnkuaXNBcnJheSggdmFsdWUgKSApIHsKCQkJZWFzaW5nID0gdmFsdWVbIDEgXTsKCQkJdmFsdWUgPSBwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyAwIF07CgkJfQoKCQlpZiAoIGluZGV4ICE9PSBuYW1lICkgewoJCQlwcm9wc1sgbmFtZSBdID0gdmFsdWU7CgkJCWRlbGV0ZSBwcm9wc1sgaW5kZXggXTsKCQl9CgoJCWhvb2tzID0galF1ZXJ5LmNzc0hvb2tzWyBuYW1lIF07CgkJaWYgKCBob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcyApIHsKCQkJdmFsdWUgPSBob29rcy5leHBhbmQoIHZhbHVlICk7CgkJCWRlbGV0ZSBwcm9wc1sgbmFtZSBdOwoKCQkJLy8gbm90IHF1aXRlICQuZXh0ZW5kLCB0aGlzIHdvbnQgb3ZlcndyaXRlIGtleXMgYWxyZWFkeSBwcmVzZW50LgoJCQkvLyBhbHNvIC0gcmV1c2luZyAnaW5kZXgnIGZyb20gYWJvdmUgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgoJCQlmb3IgKCBpbmRleCBpbiB2YWx1ZSApIHsKCQkJCWlmICggISggaW5kZXggaW4gcHJvcHMgKSApIHsKCQkJCQlwcm9wc1sgaW5kZXggXSA9IHZhbHVlWyBpbmRleCBdOwoJCQkJCXNwZWNpYWxFYXNpbmdbIGluZGV4IF0gPSBlYXNpbmc7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlzcGVjaWFsRWFzaW5nWyBuYW1lIF0gPSBlYXNpbmc7CgkJfQoJfQp9CgpqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZCggQW5pbWF0aW9uLCB7CgoJdHdlZW5lcjogZnVuY3Rpb24oIHByb3BzLCBjYWxsYmFjayApIHsKCQlpZiAoIGpRdWVyeS5pc0Z1bmN0aW9uKCBwcm9wcyApICkgewoJCQljYWxsYmFjayA9IHByb3BzOwoJCQlwcm9wcyA9IFsgIioiIF07CgkJfSBlbHNlIHsKCQkJcHJvcHMgPSBwcm9wcy5zcGxpdCgiICIpOwoJCX0KCgkJdmFyIHByb3AsCgkJCWluZGV4ID0gMCwKCQkJbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKCQlmb3IgKCA7IGluZGV4IDwgbGVuZ3RoIDsgaW5kZXgrKyApIHsKCQkJcHJvcCA9IHByb3BzWyBpbmRleCBdOwoJCQl0d2VlbmVyc1sgcHJvcCBdID0gdHdlZW5lcnNbIHByb3AgXSB8fCBbXTsKCQkJdHdlZW5lcnNbIHByb3AgXS51bnNoaWZ0KCBjYWxsYmFjayApOwoJCX0KCX0sCgoJcHJlZmlsdGVyOiBmdW5jdGlvbiggY2FsbGJhY2ssIHByZXBlbmQgKSB7CgkJaWYgKCBwcmVwZW5kICkgewoJCQlhbmltYXRpb25QcmVmaWx0ZXJzLnVuc2hpZnQoIGNhbGxiYWNrICk7CgkJfSBlbHNlIHsKCQkJYW5pbWF0aW9uUHJlZmlsdGVycy5wdXNoKCBjYWxsYmFjayApOwoJCX0KCX0KfSk7CgpmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKCBlbGVtLCBwcm9wcywgb3B0cyApIHsKCS8qIGpzaGludCB2YWxpZHRoaXM6IHRydWUgKi8KCXZhciBwcm9wLCB2YWx1ZSwgdG9nZ2xlLCB0d2VlbiwgaG9va3MsIG9sZGZpcmUsCgkJYW5pbSA9IHRoaXMsCgkJb3JpZyA9IHt9LAoJCXN0eWxlID0gZWxlbS5zdHlsZSwKCQloaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuKCBlbGVtICksCgkJZGF0YVNob3cgPSBkYXRhX3ByaXYuZ2V0KCBlbGVtLCAiZnhzaG93IiApOwoKCS8vIGhhbmRsZSBxdWV1ZTogZmFsc2UgcHJvbWlzZXMKCWlmICggIW9wdHMucXVldWUgKSB7CgkJaG9va3MgPSBqUXVlcnkuX3F1ZXVlSG9va3MoIGVsZW0sICJmeCIgKTsKCQlpZiAoIGhvb2tzLnVucXVldWVkID09IG51bGwgKSB7CgkJCWhvb2tzLnVucXVldWVkID0gMDsKCQkJb2xkZmlyZSA9IGhvb2tzLmVtcHR5LmZpcmU7CgkJCWhvb2tzLmVtcHR5LmZpcmUgPSBmdW5jdGlvbigpIHsKCQkJCWlmICggIWhvb2tzLnVucXVldWVkICkgewoJCQkJCW9sZGZpcmUoKTsKCQkJCX0KCQkJfTsKCQl9CgkJaG9va3MudW5xdWV1ZWQrKzsKCgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCS8vIGRvaW5nIHRoaXMgbWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wbGV0ZSBoYW5kbGVyIHdpbGwgYmUgY2FsbGVkCgkJCS8vIGJlZm9yZSB0aGlzIGNvbXBsZXRlcwoJCQlhbmltLmFsd2F5cyhmdW5jdGlvbigpIHsKCQkJCWhvb2tzLnVucXVldWVkLS07CgkJCQlpZiAoICFqUXVlcnkucXVldWUoIGVsZW0sICJmeCIgKS5sZW5ndGggKSB7CgkJCQkJaG9va3MuZW1wdHkuZmlyZSgpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCX0KCgkvLyBoZWlnaHQvd2lkdGggb3ZlcmZsb3cgcGFzcwoJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAxICYmICggImhlaWdodCIgaW4gcHJvcHMgfHwgIndpZHRoIiBpbiBwcm9wcyApICkgewoJCS8vIE1ha2Ugc3VyZSB0aGF0IG5vdGhpbmcgc25lYWtzIG91dAoJCS8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUU5LTEwIGRvIG5vdAoJCS8vIGNoYW5nZSB0aGUgb3ZlcmZsb3cgYXR0cmlidXRlIHdoZW4gb3ZlcmZsb3dYIGFuZAoJCS8vIG92ZXJmbG93WSBhcmUgc2V0IHRvIHRoZSBzYW1lIHZhbHVlCgkJb3B0cy5vdmVyZmxvdyA9IFsgc3R5bGUub3ZlcmZsb3csIHN0eWxlLm92ZXJmbG93WCwgc3R5bGUub3ZlcmZsb3dZIF07CgoJCS8vIFNldCBkaXNwbGF5IHByb3BlcnR5IHRvIGlubGluZS1ibG9jayBmb3IgaGVpZ2h0L3dpZHRoCgkJLy8gYW5pbWF0aW9ucyBvbiBpbmxpbmUgZWxlbWVudHMgdGhhdCBhcmUgaGF2aW5nIHdpZHRoL2hlaWdodCBhbmltYXRlZAoJCWlmICggalF1ZXJ5LmNzcyggZWxlbSwgImRpc3BsYXkiICkgPT09ICJpbmxpbmUiICYmCgkJCQlqUXVlcnkuY3NzKCBlbGVtLCAiZmxvYXQiICkgPT09ICJub25lIiApIHsKCgkJCXN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKCQl9Cgl9CgoJaWYgKCBvcHRzLm92ZXJmbG93ICkgewoJCXN0eWxlLm92ZXJmbG93ID0gImhpZGRlbiI7CgkJYW5pbS5hbHdheXMoZnVuY3Rpb24oKSB7CgkJCXN0eWxlLm92ZXJmbG93ID0gb3B0cy5vdmVyZmxvd1sgMCBdOwoJCQlzdHlsZS5vdmVyZmxvd1ggPSBvcHRzLm92ZXJmbG93WyAxIF07CgkJCXN0eWxlLm92ZXJmbG93WSA9IG9wdHMub3ZlcmZsb3dbIDIgXTsKCQl9KTsKCX0KCgoJLy8gc2hvdy9oaWRlIHBhc3MKCWZvciAoIHByb3AgaW4gcHJvcHMgKSB7CgkJdmFsdWUgPSBwcm9wc1sgcHJvcCBdOwoJCWlmICggcmZ4dHlwZXMuZXhlYyggdmFsdWUgKSApIHsKCQkJZGVsZXRlIHByb3BzWyBwcm9wIF07CgkJCXRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CgkJCWlmICggdmFsdWUgPT09ICggaGlkZGVuID8gImhpZGUiIDogInNob3ciICkgKSB7CgoJCQkJLy8gSWYgdGhlcmUgaXMgZGF0YVNob3cgbGVmdCBvdmVyIGZyb20gYSBzdG9wcGVkIGhpZGUgb3Igc2hvdyBhbmQgd2UgYXJlIGdvaW5nIHRvIHByb2NlZWQgd2l0aCBzaG93LCB3ZSBzaG91bGQgcHJldGVuZCB0byBiZSBoaWRkZW4KCQkJCWlmICggdmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1sgcHJvcCBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJaGlkZGVuID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCX0KCQkJb3JpZ1sgcHJvcCBdID0gZGF0YVNob3cgJiYgZGF0YVNob3dbIHByb3AgXSB8fCBqUXVlcnkuc3R5bGUoIGVsZW0sIHByb3AgKTsKCQl9Cgl9CgoJaWYgKCAhalF1ZXJ5LmlzRW1wdHlPYmplY3QoIG9yaWcgKSApIHsKCQlpZiAoIGRhdGFTaG93ICkgewoJCQlpZiAoICJoaWRkZW4iIGluIGRhdGFTaG93ICkgewoJCQkJaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwoJCQl9CgkJfSBlbHNlIHsKCQkJZGF0YVNob3cgPSBkYXRhX3ByaXYuYWNjZXNzKCBlbGVtLCAiZnhzaG93Iiwge30gKTsKCQl9CgoJCS8vIHN0b3JlIHN0YXRlIGlmIGl0cyB0b2dnbGUgLSBlbmFibGVzIC5zdG9wKCkudG9nZ2xlKCkgdG8gInJldmVyc2UiCgkJaWYgKCB0b2dnbGUgKSB7CgkJCWRhdGFTaG93LmhpZGRlbiA9ICFoaWRkZW47CgkJfQoJCWlmICggaGlkZGVuICkgewoJCQlqUXVlcnkoIGVsZW0gKS5zaG93KCk7CgkJfSBlbHNlIHsKCQkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQkJalF1ZXJ5KCBlbGVtICkuaGlkZSgpOwoJCQl9KTsKCQl9CgkJYW5pbS5kb25lKGZ1bmN0aW9uKCkgewoJCQl2YXIgcHJvcDsKCgkJCWRhdGFfcHJpdi5yZW1vdmUoIGVsZW0sICJmeHNob3ciICk7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgcHJvcCwgb3JpZ1sgcHJvcCBdICk7CgkJCX0KCQl9KTsKCQlmb3IgKCBwcm9wIGluIG9yaWcgKSB7CgkJCXR3ZWVuID0gY3JlYXRlVHdlZW4oIGhpZGRlbiA/IGRhdGFTaG93WyBwcm9wIF0gOiAwLCBwcm9wLCBhbmltICk7CgoJCQlpZiAoICEoIHByb3AgaW4gZGF0YVNob3cgKSApIHsKCQkJCWRhdGFTaG93WyBwcm9wIF0gPSB0d2Vlbi5zdGFydDsKCQkJCWlmICggaGlkZGVuICkgewoJCQkJCXR3ZWVuLmVuZCA9IHR3ZWVuLnN0YXJ0OwoJCQkJCXR3ZWVuLnN0YXJ0ID0gcHJvcCA9PT0gIndpZHRoIiB8fCBwcm9wID09PSAiaGVpZ2h0IiA/IDEgOiAwOwoJCQkJfQoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBUd2VlbiggZWxlbSwgb3B0aW9ucywgcHJvcCwgZW5kLCBlYXNpbmcgKSB7CglyZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KCBlbGVtLCBvcHRpb25zLCBwcm9wLCBlbmQsIGVhc2luZyApOwp9CmpRdWVyeS5Ud2VlbiA9IFR3ZWVuOwoKVHdlZW4ucHJvdG90eXBlID0gewoJY29uc3RydWN0b3I6IFR3ZWVuLAoJaW5pdDogZnVuY3Rpb24oIGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0ICkgewoJCXRoaXMuZWxlbSA9IGVsZW07CgkJdGhpcy5wcm9wID0gcHJvcDsKCQl0aGlzLmVhc2luZyA9IGVhc2luZyB8fCAic3dpbmciOwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CgkJdGhpcy5zdGFydCA9IHRoaXMubm93ID0gdGhpcy5jdXIoKTsKCQl0aGlzLmVuZCA9IGVuZDsKCQl0aGlzLnVuaXQgPSB1bml0IHx8ICggalF1ZXJ5LmNzc051bWJlclsgcHJvcCBdID8gIiIgOiAicHgiICk7Cgl9LAoJY3VyOiBmdW5jdGlvbigpIHsKCQl2YXIgaG9va3MgPSBUd2Vlbi5wcm9wSG9va3NbIHRoaXMucHJvcCBdOwoKCQlyZXR1cm4gaG9va3MgJiYgaG9va3MuZ2V0ID8KCQkJaG9va3MuZ2V0KCB0aGlzICkgOgoJCQlUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KCB0aGlzICk7Cgl9LAoJcnVuOiBmdW5jdGlvbiggcGVyY2VudCApIHsKCQl2YXIgZWFzZWQsCgkJCWhvb2tzID0gVHdlZW4ucHJvcEhvb2tzWyB0aGlzLnByb3AgXTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZHVyYXRpb24gKSB7CgkJCXRoaXMucG9zID0gZWFzZWQgPSBqUXVlcnkuZWFzaW5nWyB0aGlzLmVhc2luZyBdKAoJCQkJcGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uCgkJCSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5wb3MgPSBlYXNlZCA9IHBlcmNlbnQ7CgkJfQoJCXRoaXMubm93ID0gKCB0aGlzLmVuZCAtIHRoaXMuc3RhcnQgKSAqIGVhc2VkICsgdGhpcy5zdGFydDsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuc3RlcCApIHsKCQkJdGhpcy5vcHRpb25zLnN0ZXAuY2FsbCggdGhpcy5lbGVtLCB0aGlzLm5vdywgdGhpcyApOwoJCX0KCgkJaWYgKCBob29rcyAmJiBob29rcy5zZXQgKSB7CgkJCWhvb2tzLnNldCggdGhpcyApOwoJCX0gZWxzZSB7CgkJCVR3ZWVuLnByb3BIb29rcy5fZGVmYXVsdC5zZXQoIHRoaXMgKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn07CgpUd2Vlbi5wcm90b3R5cGUuaW5pdC5wcm90b3R5cGUgPSBUd2Vlbi5wcm90b3R5cGU7CgpUd2Vlbi5wcm9wSG9va3MgPSB7CglfZGVmYXVsdDogewoJCWdldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQl2YXIgcmVzdWx0OwoKCQkJaWYgKCB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF0gIT0gbnVsbCAmJgoJCQkJKCF0d2Vlbi5lbGVtLnN0eWxlIHx8IHR3ZWVuLmVsZW0uc3R5bGVbIHR3ZWVuLnByb3AgXSA9PSBudWxsKSApIHsKCQkJCXJldHVybiB0d2Vlbi5lbGVtWyB0d2Vlbi5wcm9wIF07CgkJCX0KCgkJCS8vIHBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQoJCQkvLyBhdHRlbXB0IGEgcGFyc2VGbG9hdCBhbmQgZmFsbGJhY2sgdG8gYSBzdHJpbmcgaWYgdGhlIHBhcnNlIGZhaWxzCgkJCS8vIHNvLCBzaW1wbGUgdmFsdWVzIHN1Y2ggYXMgIjEwcHgiIGFyZSBwYXJzZWQgdG8gRmxvYXQuCgkJCS8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzIGlzLgoJCQlyZXN1bHQgPSBqUXVlcnkuY3NzKCB0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCAiIiApOwoJCQkvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCgkJCXJldHVybiAhcmVzdWx0IHx8IHJlc3VsdCA9PT0gImF1dG8iID8gMCA6IHJlc3VsdDsKCQl9LAoJCXNldDogZnVuY3Rpb24oIHR3ZWVuICkgewoJCQkvLyB1c2Ugc3RlcCBob29rIGZvciBiYWNrIGNvbXBhdCAtIHVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZSAtIHVzZSAuc3R5bGUgaWYgaXRzCgkJCS8vIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlCgkJCWlmICggalF1ZXJ5LmZ4LnN0ZXBbIHR3ZWVuLnByb3AgXSApIHsKCQkJCWpRdWVyeS5meC5zdGVwWyB0d2Vlbi5wcm9wIF0oIHR3ZWVuICk7CgkJCX0gZWxzZSBpZiAoIHR3ZWVuLmVsZW0uc3R5bGUgJiYgKCB0d2Vlbi5lbGVtLnN0eWxlWyBqUXVlcnkuY3NzUHJvcHNbIHR3ZWVuLnByb3AgXSBdICE9IG51bGwgfHwgalF1ZXJ5LmNzc0hvb2tzWyB0d2Vlbi5wcm9wIF0gKSApIHsKCQkJCWpRdWVyeS5zdHlsZSggdHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgdHdlZW4ubm93ICsgdHdlZW4udW5pdCApOwoJCQl9IGVsc2UgewoJCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCQl9CgkJfQoJfQp9OwoKLy8gU3VwcG9ydDogSUU5Ci8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwoKVHdlZW4ucHJvcEhvb2tzLnNjcm9sbFRvcCA9IFR3ZWVuLnByb3BIb29rcy5zY3JvbGxMZWZ0ID0gewoJc2V0OiBmdW5jdGlvbiggdHdlZW4gKSB7CgkJaWYgKCB0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSApIHsKCQkJdHdlZW4uZWxlbVsgdHdlZW4ucHJvcCBdID0gdHdlZW4ubm93OwoJCX0KCX0KfTsKCmpRdWVyeS5lYWNoKFsgInRvZ2dsZSIsICJzaG93IiwgImhpZGUiIF0sIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoJdmFyIGNzc0ZuID0galF1ZXJ5LmZuWyBuYW1lIF07CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/CgkJCWNzc0ZuLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSA6CgkJCXRoaXMuYW5pbWF0ZSggZ2VuRngoIG5hbWUsIHRydWUgKSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LmZuLmV4dGVuZCh7CglmYWRlVG86IGZ1bmN0aW9uKCBzcGVlZCwgdG8sIGVhc2luZywgY2FsbGJhY2sgKSB7CgoJCS8vIHNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAoJCXJldHVybiB0aGlzLmZpbHRlciggaXNIaWRkZW4gKS5jc3MoICJvcGFjaXR5IiwgMCApLnNob3coKQoKCQkJLy8gYW5pbWF0ZSB0byB0aGUgdmFsdWUgc3BlY2lmaWVkCgkJCS5lbmQoKS5hbmltYXRlKHsgb3BhY2l0eTogdG8gfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX0sCglhbmltYXRlOiBmdW5jdGlvbiggcHJvcCwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKSB7CgkJdmFyIGVtcHR5ID0galF1ZXJ5LmlzRW1wdHlPYmplY3QoIHByb3AgKSwKCQkJb3B0YWxsID0galF1ZXJ5LnNwZWVkKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApLAoJCQlkb0FuaW1hdGlvbiA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKCQkJCXZhciBhbmltID0gQW5pbWF0aW9uKCB0aGlzLCBqUXVlcnkuZXh0ZW5kKCB7fSwgcHJvcCApLCBvcHRhbGwgKTsKCgkJCQkvLyBFbXB0eSBhbmltYXRpb25zLCBvciBmaW5pc2hpbmcgcmVzb2x2ZXMgaW1tZWRpYXRlbHkKCQkJCWlmICggZW1wdHkgfHwgZGF0YV9wcml2LmdldCggdGhpcywgImZpbmlzaCIgKSApIHsKCQkJCQlhbmltLnN0b3AoIHRydWUgKTsKCQkJCX0KCQkJfTsKCQkJZG9BbmltYXRpb24uZmluaXNoID0gZG9BbmltYXRpb247CgoJCXJldHVybiBlbXB0eSB8fCBvcHRhbGwucXVldWUgPT09IGZhbHNlID8KCQkJdGhpcy5lYWNoKCBkb0FuaW1hdGlvbiApIDoKCQkJdGhpcy5xdWV1ZSggb3B0YWxsLnF1ZXVlLCBkb0FuaW1hdGlvbiApOwoJfSwKCXN0b3A6IGZ1bmN0aW9uKCB0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kICkgewoJCXZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiggaG9va3MgKSB7CgkJCXZhciBzdG9wID0gaG9va3Muc3RvcDsKCQkJZGVsZXRlIGhvb2tzLnN0b3A7CgkJCXN0b3AoIGdvdG9FbmQgKTsKCQl9OwoKCQlpZiAoIHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIiApIHsKCQkJZ290b0VuZCA9IGNsZWFyUXVldWU7CgkJCWNsZWFyUXVldWUgPSB0eXBlOwoJCQl0eXBlID0gdW5kZWZpbmVkOwoJCX0KCQlpZiAoIGNsZWFyUXVldWUgJiYgdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXRoaXMucXVldWUoIHR5cGUgfHwgImZ4IiwgW10gKTsKCQl9CgoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBkZXF1ZXVlID0gdHJ1ZSwKCQkJCWluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCgkJCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCQkJZGF0YSA9IGRhdGFfcHJpdi5nZXQoIHRoaXMgKTsKCgkJCWlmICggaW5kZXggKSB7CgkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICkgewoJCQkJCXN0b3BRdWV1ZSggZGF0YVsgaW5kZXggXSApOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJZm9yICggaW5kZXggaW4gZGF0YSApIHsKCQkJCQlpZiAoIGRhdGFbIGluZGV4IF0gJiYgZGF0YVsgaW5kZXggXS5zdG9wICYmIHJydW4udGVzdCggaW5kZXggKSApIHsKCQkJCQkJc3RvcFF1ZXVlKCBkYXRhWyBpbmRleCBdICk7CgkJCQkJfQoJCQkJfQoJCQl9CgoJCQlmb3IgKCBpbmRleCA9IHRpbWVycy5sZW5ndGg7IGluZGV4LS07ICkgewoJCQkJaWYgKCB0aW1lcnNbIGluZGV4IF0uZWxlbSA9PT0gdGhpcyAmJiAodHlwZSA9PSBudWxsIHx8IHRpbWVyc1sgaW5kZXggXS5xdWV1ZSA9PT0gdHlwZSkgKSB7CgkJCQkJdGltZXJzWyBpbmRleCBdLmFuaW0uc3RvcCggZ290b0VuZCApOwoJCQkJCWRlcXVldWUgPSBmYWxzZTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBzdGFydCB0aGUgbmV4dCBpbiB0aGUgcXVldWUgaWYgdGhlIGxhc3Qgc3RlcCB3YXNuJ3QgZm9yY2VkCgkJCS8vIHRpbWVycyBjdXJyZW50bHkgd2lsbCBjYWxsIHRoZWlyIGNvbXBsZXRlIGNhbGxiYWNrcywgd2hpY2ggd2lsbCBkZXF1ZXVlCgkJCS8vIGJ1dCBvbmx5IGlmIHRoZXkgd2VyZSBnb3RvRW5kCgkJCWlmICggZGVxdWV1ZSB8fCAhZ290b0VuZCApIHsKCQkJCWpRdWVyeS5kZXF1ZXVlKCB0aGlzLCB0eXBlICk7CgkJCX0KCQl9KTsKCX0sCglmaW5pc2g6IGZ1bmN0aW9uKCB0eXBlICkgewoJCWlmICggdHlwZSAhPT0gZmFsc2UgKSB7CgkJCXR5cGUgPSB0eXBlIHx8ICJmeCI7CgkJfQoJCXJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCWRhdGEgPSBkYXRhX3ByaXYuZ2V0KCB0aGlzICksCgkJCQlxdWV1ZSA9IGRhdGFbIHR5cGUgKyAicXVldWUiIF0sCgkJCQlob29rcyA9IGRhdGFbIHR5cGUgKyAicXVldWVIb29rcyIgXSwKCQkJCXRpbWVycyA9IGpRdWVyeS50aW1lcnMsCgkJCQlsZW5ndGggPSBxdWV1ZSA/IHF1ZXVlLmxlbmd0aCA6IDA7CgoJCQkvLyBlbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCgkJCWRhdGEuZmluaXNoID0gdHJ1ZTsKCgkJCS8vIGVtcHR5IHRoZSBxdWV1ZSBmaXJzdAoJCQlqUXVlcnkucXVldWUoIHRoaXMsIHR5cGUsIFtdICk7CgoJCQlpZiAoIGhvb2tzICYmIGhvb2tzLnN0b3AgKSB7CgkJCQlob29rcy5zdG9wLmNhbGwoIHRoaXMsIHRydWUgKTsKCQkJfQoKCQkJLy8gbG9vayBmb3IgYW55IGFjdGl2ZSBhbmltYXRpb25zLCBhbmQgZmluaXNoIHRoZW0KCQkJZm9yICggaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOyApIHsKCQkJCWlmICggdGltZXJzWyBpbmRleCBdLmVsZW0gPT09IHRoaXMgJiYgdGltZXJzWyBpbmRleCBdLnF1ZXVlID09PSB0eXBlICkgewoJCQkJCXRpbWVyc1sgaW5kZXggXS5hbmltLnN0b3AoIHRydWUgKTsKCQkJCQl0aW1lcnMuc3BsaWNlKCBpbmRleCwgMSApOwoJCQkJfQoJCQl9CgoJCQkvLyBsb29rIGZvciBhbnkgYW5pbWF0aW9ucyBpbiB0aGUgb2xkIHF1ZXVlIGFuZCBmaW5pc2ggdGhlbQoJCQlmb3IgKCBpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrICkgewoJCQkJaWYgKCBxdWV1ZVsgaW5kZXggXSAmJiBxdWV1ZVsgaW5kZXggXS5maW5pc2ggKSB7CgkJCQkJcXVldWVbIGluZGV4IF0uZmluaXNoLmNhbGwoIHRoaXMgKTsKCQkJCX0KCQkJfQoKCQkJLy8gdHVybiBvZmYgZmluaXNoaW5nIGZsYWcKCQkJZGVsZXRlIGRhdGEuZmluaXNoOwoJCX0pOwoJfQp9KTsKCi8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCmZ1bmN0aW9uIGdlbkZ4KCB0eXBlLCBpbmNsdWRlV2lkdGggKSB7Cgl2YXIgd2hpY2gsCgkJYXR0cnMgPSB7IGhlaWdodDogdHlwZSB9LAoJCWkgPSAwOwoKCS8vIGlmIHdlIGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMSB0byBkbyBhbGwgY3NzRXhwYW5kIHZhbHVlcywKCS8vIGlmIHdlIGRvbid0IGluY2x1ZGUgd2lkdGgsIHN0ZXAgdmFsdWUgaXMgMiB0byBza2lwIG92ZXIgTGVmdCBhbmQgUmlnaHQKCWluY2x1ZGVXaWR0aCA9IGluY2x1ZGVXaWR0aD8gMSA6IDA7Cglmb3IoIDsgaSA8IDQgOyBpICs9IDIgLSBpbmNsdWRlV2lkdGggKSB7CgkJd2hpY2ggPSBjc3NFeHBhbmRbIGkgXTsKCQlhdHRyc1sgIm1hcmdpbiIgKyB3aGljaCBdID0gYXR0cnNbICJwYWRkaW5nIiArIHdoaWNoIF0gPSB0eXBlOwoJfQoKCWlmICggaW5jbHVkZVdpZHRoICkgewoJCWF0dHJzLm9wYWNpdHkgPSBhdHRycy53aWR0aCA9IHR5cGU7Cgl9CgoJcmV0dXJuIGF0dHJzOwp9CgovLyBHZW5lcmF0ZSBzaG9ydGN1dHMgZm9yIGN1c3RvbSBhbmltYXRpb25zCmpRdWVyeS5lYWNoKHsKCXNsaWRlRG93bjogZ2VuRngoInNob3ciKSwKCXNsaWRlVXA6IGdlbkZ4KCJoaWRlIiksCglzbGlkZVRvZ2dsZTogZ2VuRngoInRvZ2dsZSIpLAoJZmFkZUluOiB7IG9wYWNpdHk6ICJzaG93IiB9LAoJZmFkZU91dDogeyBvcGFjaXR5OiAiaGlkZSIgfSwKCWZhZGVUb2dnbGU6IHsgb3BhY2l0eTogInRvZ2dsZSIgfQp9LCBmdW5jdGlvbiggbmFtZSwgcHJvcHMgKSB7CglqUXVlcnkuZm5bIG5hbWUgXSA9IGZ1bmN0aW9uKCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayApIHsKCQlyZXR1cm4gdGhpcy5hbmltYXRlKCBwcm9wcywgc3BlZWQsIGVhc2luZywgY2FsbGJhY2sgKTsKCX07Cn0pOwoKalF1ZXJ5LnNwZWVkID0gZnVuY3Rpb24oIHNwZWVkLCBlYXNpbmcsIGZuICkgewoJdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKCB7fSwgc3BlZWQgKSA6IHsKCQljb21wbGV0ZTogZm4gfHwgIWZuICYmIGVhc2luZyB8fAoJCQlqUXVlcnkuaXNGdW5jdGlvbiggc3BlZWQgKSAmJiBzcGVlZCwKCQlkdXJhdGlvbjogc3BlZWQsCgkJZWFzaW5nOiBmbiAmJiBlYXNpbmcgfHwgZWFzaW5nICYmICFqUXVlcnkuaXNGdW5jdGlvbiggZWFzaW5nICkgJiYgZWFzaW5nCgl9OwoKCW9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5vZmYgPyAwIDogdHlwZW9mIG9wdC5kdXJhdGlvbiA9PT0gIm51bWJlciIgPyBvcHQuZHVyYXRpb24gOgoJCW9wdC5kdXJhdGlvbiBpbiBqUXVlcnkuZnguc3BlZWRzID8galF1ZXJ5LmZ4LnNwZWVkc1sgb3B0LmR1cmF0aW9uIF0gOiBqUXVlcnkuZnguc3BlZWRzLl9kZWZhdWx0OwoKCS8vIG5vcm1hbGl6ZSBvcHQucXVldWUgLSB0cnVlL3VuZGVmaW5lZC9udWxsIC0+ICJmeCIKCWlmICggb3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlICkgewoJCW9wdC5xdWV1ZSA9ICJmeCI7Cgl9CgoJLy8gUXVldWVpbmcKCW9wdC5vbGQgPSBvcHQuY29tcGxldGU7CgoJb3B0LmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0Lm9sZCApICkgewoJCQlvcHQub2xkLmNhbGwoIHRoaXMgKTsKCQl9CgoJCWlmICggb3B0LnF1ZXVlICkgewoJCQlqUXVlcnkuZGVxdWV1ZSggdGhpcywgb3B0LnF1ZXVlICk7CgkJfQoJfTsKCglyZXR1cm4gb3B0Owp9OwoKalF1ZXJ5LmVhc2luZyA9IHsKCWxpbmVhcjogZnVuY3Rpb24oIHAgKSB7CgkJcmV0dXJuIHA7Cgl9LAoJc3dpbmc6IGZ1bmN0aW9uKCBwICkgewoJCXJldHVybiAwLjUgLSBNYXRoLmNvcyggcCpNYXRoLlBJICkgLyAyOwoJfQp9OwoKalF1ZXJ5LnRpbWVycyA9IFtdOwpqUXVlcnkuZnggPSBUd2Vlbi5wcm90b3R5cGUuaW5pdDsKalF1ZXJ5LmZ4LnRpY2sgPSBmdW5jdGlvbigpIHsKCXZhciB0aW1lciwKCQl0aW1lcnMgPSBqUXVlcnkudGltZXJzLAoJCWkgPSAwOwoKCWZ4Tm93ID0galF1ZXJ5Lm5vdygpOwoKCWZvciAoIDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKyApIHsKCQl0aW1lciA9IHRpbWVyc1sgaSBdOwoJCS8vIENoZWNrcyB0aGUgdGltZXIgaGFzIG5vdCBhbHJlYWR5IGJlZW4gcmVtb3ZlZAoJCWlmICggIXRpbWVyKCkgJiYgdGltZXJzWyBpIF0gPT09IHRpbWVyICkgewoJCQl0aW1lcnMuc3BsaWNlKCBpLS0sIDEgKTsKCQl9Cgl9CgoJaWYgKCAhdGltZXJzLmxlbmd0aCApIHsKCQlqUXVlcnkuZnguc3RvcCgpOwoJfQoJZnhOb3cgPSB1bmRlZmluZWQ7Cn07CgpqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiggdGltZXIgKSB7CglpZiAoIHRpbWVyKCkgJiYgalF1ZXJ5LnRpbWVycy5wdXNoKCB0aW1lciApICkgewoJCWpRdWVyeS5meC5zdGFydCgpOwoJfQp9OwoKalF1ZXJ5LmZ4LmludGVydmFsID0gMTM7CgpqUXVlcnkuZnguc3RhcnQgPSBmdW5jdGlvbigpIHsKCWlmICggIXRpbWVySWQgKSB7CgkJdGltZXJJZCA9IHNldEludGVydmFsKCBqUXVlcnkuZngudGljaywgalF1ZXJ5LmZ4LmludGVydmFsICk7Cgl9Cn07CgpqUXVlcnkuZnguc3RvcCA9IGZ1bmN0aW9uKCkgewoJY2xlYXJJbnRlcnZhbCggdGltZXJJZCApOwoJdGltZXJJZCA9IG51bGw7Cn07CgpqUXVlcnkuZnguc3BlZWRzID0gewoJc2xvdzogNjAwLAoJZmFzdDogMjAwLAoJLy8gRGVmYXVsdCBzcGVlZAoJX2RlZmF1bHQ6IDQwMAp9OwoKLy8gQmFjayBDb21wYXQgPDEuOCBleHRlbnNpb24gcG9pbnQKalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKCmlmICggalF1ZXJ5LmV4cHIgJiYgalF1ZXJ5LmV4cHIuZmlsdGVycyApIHsKCWpRdWVyeS5leHByLmZpbHRlcnMuYW5pbWF0ZWQgPSBmdW5jdGlvbiggZWxlbSApIHsKCQlyZXR1cm4galF1ZXJ5LmdyZXAoalF1ZXJ5LnRpbWVycywgZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKCQl9KS5sZW5ndGg7Cgl9Owp9CmpRdWVyeS5mbi5vZmZzZXQgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQlyZXR1cm4gb3B0aW9ucyA9PT0gdW5kZWZpbmVkID8KCQkJdGhpcyA6CgkJCXRoaXMuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJCWpRdWVyeS5vZmZzZXQuc2V0T2Zmc2V0KCB0aGlzLCBvcHRpb25zLCBpICk7CgkJCX0pOwoJfQoKCXZhciBkb2NFbGVtLCB3aW4sCgkJZWxlbSA9IHRoaXNbIDAgXSwKCQlib3ggPSB7IHRvcDogMCwgbGVmdDogMCB9LAoJCWRvYyA9IGVsZW0gJiYgZWxlbS5vd25lckRvY3VtZW50OwoKCWlmICggIWRvYyApIHsKCQlyZXR1cm47Cgl9CgoJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQ7CgoJLy8gTWFrZSBzdXJlIGl0J3Mgbm90IGEgZGlzY29ubmVjdGVkIERPTSBub2RlCglpZiAoICFqUXVlcnkuY29udGFpbnMoIGRvY0VsZW0sIGVsZW0gKSApIHsKCQlyZXR1cm4gYm94OwoJfQoKCS8vIElmIHdlIGRvbid0IGhhdmUgZ0JDUiwganVzdCB1c2UgMCwwIHJhdGhlciB0aGFuIGVycm9yCgkvLyBCbGFja0JlcnJ5IDUsIGlPUyAzIChvcmlnaW5hbCBpUGhvbmUpCglpZiAoIHR5cGVvZiBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCAhPT0gY29yZV9zdHJ1bmRlZmluZWQgKSB7CgkJYm94ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCX0KCXdpbiA9IGdldFdpbmRvdyggZG9jICk7CglyZXR1cm4gewoJCXRvcDogYm94LnRvcCArIHdpbi5wYWdlWU9mZnNldCAtIGRvY0VsZW0uY2xpZW50VG9wLAoJCWxlZnQ6IGJveC5sZWZ0ICsgd2luLnBhZ2VYT2Zmc2V0IC0gZG9jRWxlbS5jbGllbnRMZWZ0Cgl9Owp9OwoKalF1ZXJ5Lm9mZnNldCA9IHsKCglzZXRPZmZzZXQ6IGZ1bmN0aW9uKCBlbGVtLCBvcHRpb25zLCBpICkgewoJCXZhciBjdXJQb3NpdGlvbiwgY3VyTGVmdCwgY3VyQ1NTVG9wLCBjdXJUb3AsIGN1ck9mZnNldCwgY3VyQ1NTTGVmdCwgY2FsY3VsYXRlUG9zaXRpb24sCgkJCXBvc2l0aW9uID0galF1ZXJ5LmNzcyggZWxlbSwgInBvc2l0aW9uIiApLAoJCQljdXJFbGVtID0galF1ZXJ5KCBlbGVtICksCgkJCXByb3BzID0ge307CgoJCS8vIFNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KCQlpZiAoIHBvc2l0aW9uID09PSAic3RhdGljIiApIHsKCQkJZWxlbS5zdHlsZS5wb3NpdGlvbiA9ICJyZWxhdGl2ZSI7CgkJfQoKCQljdXJPZmZzZXQgPSBjdXJFbGVtLm9mZnNldCgpOwoJCWN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoIGVsZW0sICJ0b3AiICk7CgkJY3VyQ1NTTGVmdCA9IGpRdWVyeS5jc3MoIGVsZW0sICJsZWZ0IiApOwoJCWNhbGN1bGF0ZVBvc2l0aW9uID0gKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApICYmICggY3VyQ1NTVG9wICsgY3VyQ1NTTGVmdCApLmluZGV4T2YoImF1dG8iKSA+IC0xOwoKCQkvLyBOZWVkIHRvIGJlIGFibGUgdG8gY2FsY3VsYXRlIHBvc2l0aW9uIGlmIGVpdGhlciB0b3Agb3IgbGVmdCBpcyBhdXRvIGFuZCBwb3NpdGlvbiBpcyBlaXRoZXIgYWJzb2x1dGUgb3IgZml4ZWQKCQlpZiAoIGNhbGN1bGF0ZVBvc2l0aW9uICkgewoJCQljdXJQb3NpdGlvbiA9IGN1ckVsZW0ucG9zaXRpb24oKTsKCQkJY3VyVG9wID0gY3VyUG9zaXRpb24udG9wOwoJCQljdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKCgkJfSBlbHNlIHsKCQkJY3VyVG9wID0gcGFyc2VGbG9hdCggY3VyQ1NTVG9wICkgfHwgMDsKCQkJY3VyTGVmdCA9IHBhcnNlRmxvYXQoIGN1ckNTU0xlZnQgKSB8fCAwOwoJCX0KCgkJaWYgKCBqUXVlcnkuaXNGdW5jdGlvbiggb3B0aW9ucyApICkgewoJCQlvcHRpb25zID0gb3B0aW9ucy5jYWxsKCBlbGVtLCBpLCBjdXJPZmZzZXQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy50b3AgIT0gbnVsbCApIHsKCQkJcHJvcHMudG9wID0gKCBvcHRpb25zLnRvcCAtIGN1ck9mZnNldC50b3AgKSArIGN1clRvcDsKCQl9CgkJaWYgKCBvcHRpb25zLmxlZnQgIT0gbnVsbCApIHsKCQkJcHJvcHMubGVmdCA9ICggb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKSArIGN1ckxlZnQ7CgkJfQoKCQlpZiAoICJ1c2luZyIgaW4gb3B0aW9ucyApIHsKCQkJb3B0aW9ucy51c2luZy5jYWxsKCBlbGVtLCBwcm9wcyApOwoKCQl9IGVsc2UgewoJCQljdXJFbGVtLmNzcyggcHJvcHMgKTsKCQl9Cgl9Cn07CgoKalF1ZXJ5LmZuLmV4dGVuZCh7CgoJcG9zaXRpb246IGZ1bmN0aW9uKCkgewoJCWlmICggIXRoaXNbIDAgXSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIG9mZnNldFBhcmVudCwgb2Zmc2V0LAoJCQllbGVtID0gdGhpc1sgMCBdLAoJCQlwYXJlbnRPZmZzZXQgPSB7IHRvcDogMCwgbGVmdDogMCB9OwoKCQkvLyBGaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gd2luZG93IChwYXJlbnRPZmZzZXQgPSB7dG9wOjAsIGxlZnQ6IDB9LCBiZWNhdXNlIGl0IGlzIGl0J3Mgb25seSBvZmZzZXQgcGFyZW50CgkJaWYgKCBqUXVlcnkuY3NzKCBlbGVtLCAicG9zaXRpb24iICkgPT09ICJmaXhlZCIgKSB7CgkJCS8vIFdlIGFzc3VtZSB0aGF0IGdldEJvdW5kaW5nQ2xpZW50UmVjdCBpcyBhdmFpbGFibGUgd2hlbiBjb21wdXRlZCBwb3NpdGlvbiBpcyBmaXhlZAoJCQlvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKCQl9IGVsc2UgewoJCQkvLyBHZXQgKnJlYWwqIG9mZnNldFBhcmVudAoJCQlvZmZzZXRQYXJlbnQgPSB0aGlzLm9mZnNldFBhcmVudCgpOwoKCQkJLy8gR2V0IGNvcnJlY3Qgb2Zmc2V0cwoJCQlvZmZzZXQgPSB0aGlzLm9mZnNldCgpOwoJCQlpZiAoICFqUXVlcnkubm9kZU5hbWUoIG9mZnNldFBhcmVudFsgMCBdLCAiaHRtbCIgKSApIHsKCQkJCXBhcmVudE9mZnNldCA9IG9mZnNldFBhcmVudC5vZmZzZXQoKTsKCQkJfQoKCQkJLy8gQWRkIG9mZnNldFBhcmVudCBib3JkZXJzCgkJCXBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJUb3BXaWR0aCIsIHRydWUgKTsKCQkJcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyggb2Zmc2V0UGFyZW50WyAwIF0sICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlICk7CgkJfQoKCQkvLyBTdWJ0cmFjdCBwYXJlbnQgb2Zmc2V0cyBhbmQgZWxlbWVudCBtYXJnaW5zCgkJcmV0dXJuIHsKCQkJdG9wOiBvZmZzZXQudG9wIC0gcGFyZW50T2Zmc2V0LnRvcCAtIGpRdWVyeS5jc3MoIGVsZW0sICJtYXJnaW5Ub3AiLCB0cnVlICksCgkJCWxlZnQ6IG9mZnNldC5sZWZ0IC0gcGFyZW50T2Zmc2V0LmxlZnQgLSBqUXVlcnkuY3NzKCBlbGVtLCAibWFyZ2luTGVmdCIsIHRydWUgKQoJCX07Cgl9LAoKCW9mZnNldFBhcmVudDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKCkgewoJCQl2YXIgb2Zmc2V0UGFyZW50ID0gdGhpcy5vZmZzZXRQYXJlbnQgfHwgZG9jRWxlbTsKCgkJCXdoaWxlICggb2Zmc2V0UGFyZW50ICYmICggIWpRdWVyeS5ub2RlTmFtZSggb2Zmc2V0UGFyZW50LCAiaHRtbCIgKSAmJiBqUXVlcnkuY3NzKCBvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIiApICkgewoJCQkJb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKCQkJfQoKCQkJcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2NFbGVtOwoJCX0pOwoJfQp9KTsKCgovLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKalF1ZXJ5LmVhY2goIHtzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLCBzY3JvbGxUb3A6ICJwYWdlWU9mZnNldCJ9LCBmdW5jdGlvbiggbWV0aG9kLCBwcm9wICkgewoJdmFyIHRvcCA9ICJwYWdlWU9mZnNldCIgPT09IHByb3A7CgoJalF1ZXJ5LmZuWyBtZXRob2QgXSA9IGZ1bmN0aW9uKCB2YWwgKSB7CgkJcmV0dXJuIGpRdWVyeS5hY2Nlc3MoIHRoaXMsIGZ1bmN0aW9uKCBlbGVtLCBtZXRob2QsIHZhbCApIHsKCQkJdmFyIHdpbiA9IGdldFdpbmRvdyggZWxlbSApOwoKCQkJaWYgKCB2YWwgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiB3aW4gPyB3aW5bIHByb3AgXSA6IGVsZW1bIG1ldGhvZCBdOwoJCQl9CgoJCQlpZiAoIHdpbiApIHsKCQkJCXdpbi5zY3JvbGxUbygKCQkJCQkhdG9wID8gdmFsIDogd2luZG93LnBhZ2VYT2Zmc2V0LAoJCQkJCXRvcCA/IHZhbCA6IHdpbmRvdy5wYWdlWU9mZnNldAoJCQkJKTsKCgkJCX0gZWxzZSB7CgkJCQllbGVtWyBtZXRob2QgXSA9IHZhbDsKCQkJfQoJCX0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoLCBudWxsICk7Cgl9Owp9KTsKCmZ1bmN0aW9uIGdldFdpbmRvdyggZWxlbSApIHsKCXJldHVybiBqUXVlcnkuaXNXaW5kb3coIGVsZW0gKSA/IGVsZW0gOiBlbGVtLm5vZGVUeXBlID09PSA5ICYmIGVsZW0uZGVmYXVsdFZpZXc7Cn0KLy8gQ3JlYXRlIGlubmVySGVpZ2h0LCBpbm5lcldpZHRoLCBoZWlnaHQsIHdpZHRoLCBvdXRlckhlaWdodCBhbmQgb3V0ZXJXaWR0aCBtZXRob2RzCmpRdWVyeS5lYWNoKCB7IEhlaWdodDogImhlaWdodCIsIFdpZHRoOiAid2lkdGgiIH0sIGZ1bmN0aW9uKCBuYW1lLCB0eXBlICkgewoJalF1ZXJ5LmVhY2goIHsgcGFkZGluZzogImlubmVyIiArIG5hbWUsIGNvbnRlbnQ6IHR5cGUsICIiOiAib3V0ZXIiICsgbmFtZSB9LCBmdW5jdGlvbiggZGVmYXVsdEV4dHJhLCBmdW5jTmFtZSApIHsKCQkvLyBtYXJnaW4gaXMgb25seSBmb3Igb3V0ZXJIZWlnaHQsIG91dGVyV2lkdGgKCQlqUXVlcnkuZm5bIGZ1bmNOYW1lIF0gPSBmdW5jdGlvbiggbWFyZ2luLCB2YWx1ZSApIHsKCQkJdmFyIGNoYWluYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggJiYgKCBkZWZhdWx0RXh0cmEgfHwgdHlwZW9mIG1hcmdpbiAhPT0gImJvb2xlYW4iICksCgkJCQlleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAoIG1hcmdpbiA9PT0gdHJ1ZSB8fCB2YWx1ZSA9PT0gdHJ1ZSA/ICJtYXJnaW4iIDogImJvcmRlciIgKTsKCgkJCXJldHVybiBqUXVlcnkuYWNjZXNzKCB0aGlzLCBmdW5jdGlvbiggZWxlbSwgdHlwZSwgdmFsdWUgKSB7CgkJCQl2YXIgZG9jOwoKCQkJCWlmICggalF1ZXJ5LmlzV2luZG93KCBlbGVtICkgKSB7CgkJCQkJLy8gQXMgb2YgNS84LzIwMTIgdGhpcyB3aWxsIHlpZWxkIGluY29ycmVjdCByZXN1bHRzIGZvciBNb2JpbGUgU2FmYXJpLCBidXQgdGhlcmUKCQkJCQkvLyBpc24ndCBhIHdob2xlIGxvdCB3ZSBjYW4gZG8uIFNlZSBwdWxsIHJlcXVlc3QgYXQgdGhpcyBVUkwgZm9yIGRpc2N1c3Npb246CgkJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnkvcHVsbC83NjQKCQkJCQlyZXR1cm4gZWxlbS5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbICJjbGllbnQiICsgbmFtZSBdOwoJCQkJfQoKCQkJCS8vIEdldCBkb2N1bWVudCB3aWR0aCBvciBoZWlnaHQKCQkJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gOSApIHsKCQkJCQlkb2MgPSBlbGVtLmRvY3VtZW50RWxlbWVudDsKCgkJCQkJLy8gRWl0aGVyIHNjcm9sbFtXaWR0aC9IZWlnaHRdIG9yIG9mZnNldFtXaWR0aC9IZWlnaHRdIG9yIGNsaWVudFtXaWR0aC9IZWlnaHRdLAoJCQkJCS8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAoJCQkJCXJldHVybiBNYXRoLm1heCgKCQkJCQkJZWxlbS5ib2R5WyAic2Nyb2xsIiArIG5hbWUgXSwgZG9jWyAic2Nyb2xsIiArIG5hbWUgXSwKCQkJCQkJZWxlbS5ib2R5WyAib2Zmc2V0IiArIG5hbWUgXSwgZG9jWyAib2Zmc2V0IiArIG5hbWUgXSwKCQkJCQkJZG9jWyAiY2xpZW50IiArIG5hbWUgXQoJCQkJCSk7CgkJCQl9CgoJCQkJcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPwoJCQkJCS8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQKCQkJCQlqUXVlcnkuY3NzKCBlbGVtLCB0eXBlLCBleHRyYSApIDoKCgkJCQkJLy8gU2V0IHdpZHRoIG9yIGhlaWdodCBvbiB0aGUgZWxlbWVudAoJCQkJCWpRdWVyeS5zdHlsZSggZWxlbSwgdHlwZSwgdmFsdWUsIGV4dHJhICk7CgkJCX0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlLCBudWxsICk7CgkJfTsKCX0pOwp9KTsKLy8gTGltaXQgc2NvcGUgcG9sbHV0aW9uIGZyb20gYW55IGRlcHJlY2F0ZWQgQVBJCi8vIChmdW5jdGlvbigpIHsKCi8vIFRoZSBudW1iZXIgb2YgZWxlbWVudHMgY29udGFpbmVkIGluIHRoZSBtYXRjaGVkIGVsZW1lbnQgc2V0CmpRdWVyeS5mbi5zaXplID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gdGhpcy5sZW5ndGg7Cn07CgpqUXVlcnkuZm4uYW5kU2VsZiA9IGpRdWVyeS5mbi5hZGRCYWNrOwoKLy8gfSkoKTsKaWYgKCB0eXBlb2YgbW9kdWxlID09PSAib2JqZWN0IiAmJiBtb2R1bGUgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAib2JqZWN0IiApIHsKCS8vIEV4cG9zZSBqUXVlcnkgYXMgbW9kdWxlLmV4cG9ydHMgaW4gbG9hZGVycyB0aGF0IGltcGxlbWVudCB0aGUgTm9kZQoJLy8gbW9kdWxlIHBhdHRlcm4gKGluY2x1ZGluZyBicm93c2VyaWZ5KS4gRG8gbm90IGNyZWF0ZSB0aGUgZ2xvYmFsLCBzaW5jZQoJLy8gdGhlIHVzZXIgd2lsbCBiZSBzdG9yaW5nIGl0IHRoZW1zZWx2ZXMgbG9jYWxseSwgYW5kIGdsb2JhbHMgYXJlIGZyb3duZWQKCS8vIHVwb24gaW4gdGhlIE5vZGUgbW9kdWxlIHdvcmxkLgoJbW9kdWxlLmV4cG9ydHMgPSBqUXVlcnk7Cn0gZWxzZSB7CgkvLyBSZWdpc3RlciBhcyBhIG5hbWVkIEFNRCBtb2R1bGUsIHNpbmNlIGpRdWVyeSBjYW4gYmUgY29uY2F0ZW5hdGVkIHdpdGggb3RoZXIKCS8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKCS8vIHVuZGVyc3RhbmRzIGFub255bW91cyBBTUQgbW9kdWxlcy4gQSBuYW1lZCBBTUQgaXMgc2FmZXN0IGFuZCBtb3N0IHJvYnVzdAoJLy8gd2F5IHRvIHJlZ2lzdGVyLiBMb3dlcmNhc2UganF1ZXJ5IGlzIHVzZWQgYmVjYXVzZSBBTUQgbW9kdWxlIG5hbWVzIGFyZQoJLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCgkvLyBmaWxlIG5hbWUuIERvIHRoaXMgYWZ0ZXIgY3JlYXRpbmcgdGhlIGdsb2JhbCBzbyB0aGF0IGlmIGFuIEFNRCBtb2R1bGUgd2FudHMKCS8vIHRvIGNhbGwgbm9Db25mbGljdCB0byBoaWRlIHRoaXMgdmVyc2lvbiBvZiBqUXVlcnksIGl0IHdpbGwgd29yay4KCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCWRlZmluZSggImpxdWVyeSIsIFtdLCBmdW5jdGlvbiAoKSB7IHJldHVybiBqUXVlcnk7IH0gKTsKCX0KfQoKLy8gSWYgdGhlcmUgaXMgYSB3aW5kb3cgb2JqZWN0LCB0aGF0IGF0IGxlYXN0IGhhcyBhIGRvY3VtZW50IHByb3BlcnR5LAovLyBkZWZpbmUgalF1ZXJ5IGFuZCAkIGlkZW50aWZpZXJzCmlmICggdHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCA9PT0gIm9iamVjdCIgKSB7Cgl3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7Cn0KCn0pKCB3aW5kb3cgKTsKCi8qKgogKiBAbGljZW5zZQogKiBMby1EYXNoIDIuMi4xIChDdXN0b20gQnVpbGQpIDxodHRwOi8vbG9kYXNoLmNvbS8+CiAqIEJ1aWxkOiBgbG9kYXNoIG1vZGVybiAtbyAuL2Rpc3QvbG9kYXNoLmpzYAogKiBDb3B5cmlnaHQgMjAxMi0yMDEzIFRoZSBEb2pvIEZvdW5kYXRpb24gPGh0dHA6Ly9kb2pvZm91bmRhdGlvbi5vcmcvPgogKiBCYXNlZCBvbiBVbmRlcnNjb3JlLmpzIDEuNS4yIDxodHRwOi8vdW5kZXJzY29yZWpzLm9yZy9MSUNFTlNFPgogKiBDb3B5cmlnaHQgMjAwOS0yMDEzIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBhbmQgSW52ZXN0aWdhdGl2ZSBSZXBvcnRlcnMgJiBFZGl0b3JzCiAqIEF2YWlsYWJsZSB1bmRlciBNSVQgbGljZW5zZSA8aHR0cDovL2xvZGFzaC5jb20vbGljZW5zZT4KICovCjsoZnVuY3Rpb24oKSB7CgogIC8qKiBVc2VkIGFzIGEgc2FmZSByZWZlcmVuY2UgZm9yIGB1bmRlZmluZWRgIGluIHByZSBFUzUgZW52aXJvbm1lbnRzICovCiAgdmFyIHVuZGVmaW5lZDsKCiAgLyoqIFVzZWQgdG8gcG9vbCBhcnJheXMgYW5kIG9iamVjdHMgdXNlZCBpbnRlcm5hbGx5ICovCiAgdmFyIGFycmF5UG9vbCA9IFtdLAogICAgICBvYmplY3RQb29sID0gW107CgogIC8qKiBVc2VkIHRvIGdlbmVyYXRlIHVuaXF1ZSBJRHMgKi8KICB2YXIgaWRDb3VudGVyID0gMDsKCiAgLyoqIFVzZWQgdG8gcHJlZml4IGtleXMgdG8gYXZvaWQgaXNzdWVzIHdpdGggYF9fcHJvdG9fX2AgYW5kIHByb3BlcnRpZXMgb24gYE9iamVjdC5wcm90b3R5cGVgICovCiAgdmFyIGtleVByZWZpeCA9ICtuZXcgRGF0ZSArICcnOwoKICAvKiogVXNlZCBhcyB0aGUgc2l6ZSB3aGVuIG9wdGltaXphdGlvbnMgYXJlIGVuYWJsZWQgZm9yIGxhcmdlIGFycmF5cyAqLwogIHZhciBsYXJnZUFycmF5U2l6ZSA9IDc1OwoKICAvKiogVXNlZCBhcyB0aGUgbWF4IHNpemUgb2YgdGhlIGBhcnJheVBvb2xgIGFuZCBgb2JqZWN0UG9vbGAgKi8KICB2YXIgbWF4UG9vbFNpemUgPSA0MDsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0IGFuZCB0ZXN0IHdoaXRlc3BhY2UgKi8KICB2YXIgd2hpdGVzcGFjZSA9ICgKICAgIC8vIHdoaXRlc3BhY2UKICAgICcgXHRceDBCXGZceEEwXHVmZWZmJyArCgogICAgLy8gbGluZSB0ZXJtaW5hdG9ycwogICAgJ1xuXHJcdTIwMjhcdTIwMjknICsKCiAgICAvLyB1bmljb2RlIGNhdGVnb3J5ICJacyIgc3BhY2Ugc2VwYXJhdG9ycwogICAgJ1x1MTY4MFx1MTgwZVx1MjAwMFx1MjAwMVx1MjAwMlx1MjAwM1x1MjAwNFx1MjAwNVx1MjAwNlx1MjAwN1x1MjAwOFx1MjAwOVx1MjAwYVx1MjAyZlx1MjA1Zlx1MzAwMCcKICApOwoKICAvKiogVXNlZCB0byBtYXRjaCBlbXB0eSBzdHJpbmcgbGl0ZXJhbHMgaW4gY29tcGlsZWQgdGVtcGxhdGUgc291cmNlICovCiAgdmFyIHJlRW1wdHlTdHJpbmdMZWFkaW5nID0gL1xiX19wIFwrPSAnJzsvZywKICAgICAgcmVFbXB0eVN0cmluZ01pZGRsZSA9IC9cYihfX3AgXCs9KSAnJyBcKy9nLAogICAgICByZUVtcHR5U3RyaW5nVHJhaWxpbmcgPSAvKF9fZVwoLio/XCl8XGJfX3RcKSkgXCtcbicnOy9nOwoKICAvKioKICAgKiBVc2VkIHRvIG1hdGNoIEVTNiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICogaHR0cDovL3Blb3BsZS5tb3ppbGxhLm9yZy9+am9yZW5kb3JmZi9lczYtZHJhZnQuaHRtbCNzZWMtNy44LjYKICAgKi8KICB2YXIgcmVFc1RlbXBsYXRlID0gL1wkXHsoW15cXH1dKig/OlxcLlteXFx9XSopKilcfS9nOwoKICAvKiogVXNlZCB0byBtYXRjaCByZWdleHAgZmxhZ3MgZnJvbSB0aGVpciBjb2VyY2VkIHN0cmluZyB2YWx1ZXMgKi8KICB2YXIgcmVGbGFncyA9IC9cdyokLzsKCiAgLyoqIFVzZWQgdG8gZGV0ZWN0ZWQgbmFtZWQgZnVuY3Rpb25zICovCiAgdmFyIHJlRnVuY05hbWUgPSAvXmZ1bmN0aW9uWyBcblxyXHRdK1x3LzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggImludGVycG9sYXRlIiB0ZW1wbGF0ZSBkZWxpbWl0ZXJzICovCiAgdmFyIHJlSW50ZXJwb2xhdGUgPSAvPCU9KFtcc1xTXSs/KSU+L2c7CgogIC8qKiBVc2VkIHRvIG1hdGNoIGxlYWRpbmcgd2hpdGVzcGFjZSBhbmQgemVyb3MgdG8gYmUgcmVtb3ZlZCAqLwogIHZhciByZUxlYWRpbmdTcGFjZXNBbmRaZXJvcyA9IFJlZ0V4cCgnXlsnICsgd2hpdGVzcGFjZSArICddKjArKD89LiQpJyk7CgogIC8qKiBVc2VkIHRvIGVuc3VyZSBjYXB0dXJpbmcgb3JkZXIgb2YgdGVtcGxhdGUgZGVsaW1pdGVycyAqLwogIHZhciByZU5vTWF0Y2ggPSAvKCReKS87CgogIC8qKiBVc2VkIHRvIGRldGVjdCBmdW5jdGlvbnMgY29udGFpbmluZyBhIGB0aGlzYCByZWZlcmVuY2UgKi8KICB2YXIgcmVUaGlzID0gL1xidGhpc1xiLzsKCiAgLyoqIFVzZWQgdG8gbWF0Y2ggdW5lc2NhcGVkIGNoYXJhY3RlcnMgaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHJlVW5lc2NhcGVkU3RyaW5nID0gL1snXG5cclx0XHUyMDI4XHUyMDI5XFxdL2c7CgogIC8qKiBVc2VkIHRvIGFzc2lnbiBkZWZhdWx0IGBjb250ZXh0YCBvYmplY3QgcHJvcGVydGllcyAqLwogIHZhciBjb250ZXh0UHJvcHMgPSBbCiAgICAnQXJyYXknLCAnQm9vbGVhbicsICdEYXRlJywgJ0Z1bmN0aW9uJywgJ01hdGgnLCAnTnVtYmVyJywgJ09iamVjdCcsCiAgICAnUmVnRXhwJywgJ1N0cmluZycsICdfJywgJ2F0dGFjaEV2ZW50JywgJ2NsZWFyVGltZW91dCcsICdpc0Zpbml0ZScsICdpc05hTicsCiAgICAncGFyc2VJbnQnLCAnc2V0SW1tZWRpYXRlJywgJ3NldFRpbWVvdXQnCiAgXTsKCiAgLyoqIFVzZWQgdG8gbWFrZSB0ZW1wbGF0ZSBzb3VyY2VVUkxzIGVhc2llciB0byBpZGVudGlmeSAqLwogIHZhciB0ZW1wbGF0ZUNvdW50ZXIgPSAwOwoKICAvKiogYE9iamVjdCN0b1N0cmluZ2AgcmVzdWx0IHNob3J0Y3V0cyAqLwogIHZhciBhcmdzQ2xhc3MgPSAnW29iamVjdCBBcmd1bWVudHNdJywKICAgICAgYXJyYXlDbGFzcyA9ICdbb2JqZWN0IEFycmF5XScsCiAgICAgIGJvb2xDbGFzcyA9ICdbb2JqZWN0IEJvb2xlYW5dJywKICAgICAgZGF0ZUNsYXNzID0gJ1tvYmplY3QgRGF0ZV0nLAogICAgICBmdW5jQ2xhc3MgPSAnW29iamVjdCBGdW5jdGlvbl0nLAogICAgICBudW1iZXJDbGFzcyA9ICdbb2JqZWN0IE51bWJlcl0nLAogICAgICBvYmplY3RDbGFzcyA9ICdbb2JqZWN0IE9iamVjdF0nLAogICAgICByZWdleHBDbGFzcyA9ICdbb2JqZWN0IFJlZ0V4cF0nLAogICAgICBzdHJpbmdDbGFzcyA9ICdbb2JqZWN0IFN0cmluZ10nOwoKICAvKiogVXNlZCB0byBpZGVudGlmeSBvYmplY3QgY2xhc3NpZmljYXRpb25zIHRoYXQgYF8uY2xvbmVgIHN1cHBvcnRzICovCiAgdmFyIGNsb25lYWJsZUNsYXNzZXMgPSB7fTsKICBjbG9uZWFibGVDbGFzc2VzW2Z1bmNDbGFzc10gPSBmYWxzZTsKICBjbG9uZWFibGVDbGFzc2VzW2FyZ3NDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2FycmF5Q2xhc3NdID0KICBjbG9uZWFibGVDbGFzc2VzW2Jvb2xDbGFzc10gPSBjbG9uZWFibGVDbGFzc2VzW2RhdGVDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbbnVtYmVyQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tvYmplY3RDbGFzc10gPQogIGNsb25lYWJsZUNsYXNzZXNbcmVnZXhwQ2xhc3NdID0gY2xvbmVhYmxlQ2xhc3Nlc1tzdHJpbmdDbGFzc10gPSB0cnVlOwoKICAvKiogVXNlZCBhcyBhbiBpbnRlcm5hbCBgXy5kZWJvdW5jZWAgb3B0aW9ucyBvYmplY3QgKi8KICB2YXIgZGVib3VuY2VPcHRpb25zID0gewogICAgJ2xlYWRpbmcnOiBmYWxzZSwKICAgICdtYXhXYWl0JzogMCwKICAgICd0cmFpbGluZyc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgYXMgdGhlIHByb3BlcnR5IGRlc2NyaXB0b3IgZm9yIGBfX2JpbmREYXRhX19gICovCiAgdmFyIGRlc2NyaXB0b3IgPSB7CiAgICAnY29uZmlndXJhYmxlJzogZmFsc2UsCiAgICAnZW51bWVyYWJsZSc6IGZhbHNlLAogICAgJ3ZhbHVlJzogbnVsbCwKICAgICd3cml0YWJsZSc6IGZhbHNlCiAgfTsKCiAgLyoqIFVzZWQgdG8gZGV0ZXJtaW5lIGlmIHZhbHVlcyBhcmUgb2YgdGhlIGxhbmd1YWdlIHR5cGUgT2JqZWN0ICovCiAgdmFyIG9iamVjdFR5cGVzID0gewogICAgJ2Jvb2xlYW4nOiBmYWxzZSwKICAgICdmdW5jdGlvbic6IHRydWUsCiAgICAnb2JqZWN0JzogdHJ1ZSwKICAgICdudW1iZXInOiBmYWxzZSwKICAgICdzdHJpbmcnOiBmYWxzZSwKICAgICd1bmRlZmluZWQnOiBmYWxzZQogIH07CgogIC8qKiBVc2VkIHRvIGVzY2FwZSBjaGFyYWN0ZXJzIGZvciBpbmNsdXNpb24gaW4gY29tcGlsZWQgc3RyaW5nIGxpdGVyYWxzICovCiAgdmFyIHN0cmluZ0VzY2FwZXMgPSB7CiAgICAnXFwnOiAnXFwnLAogICAgIiciOiAiJyIsCiAgICAnXG4nOiAnbicsCiAgICAnXHInOiAncicsCiAgICAnXHQnOiAndCcsCiAgICAnXHUyMDI4JzogJ3UyMDI4JywKICAgICdcdTIwMjknOiAndTIwMjknCiAgfTsKCiAgLyoqIFVzZWQgYXMgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QgKi8KICB2YXIgcm9vdCA9IChvYmplY3RUeXBlc1t0eXBlb2Ygd2luZG93XSAmJiB3aW5kb3cpIHx8IHRoaXM7CgogIC8qKiBEZXRlY3QgZnJlZSB2YXJpYWJsZSBgZXhwb3J0c2AgKi8KICB2YXIgZnJlZUV4cG9ydHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgZXhwb3J0c10gJiYgZXhwb3J0cyAmJiAhZXhwb3J0cy5ub2RlVHlwZSAmJiBleHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYG1vZHVsZWAgKi8KICB2YXIgZnJlZU1vZHVsZSA9IG9iamVjdFR5cGVzW3R5cGVvZiBtb2R1bGVdICYmIG1vZHVsZSAmJiAhbW9kdWxlLm5vZGVUeXBlICYmIG1vZHVsZTsKCiAgLyoqIERldGVjdCB0aGUgcG9wdWxhciBDb21tb25KUyBleHRlbnNpb24gYG1vZHVsZS5leHBvcnRzYCAqLwogIHZhciBtb2R1bGVFeHBvcnRzID0gZnJlZU1vZHVsZSAmJiBmcmVlTW9kdWxlLmV4cG9ydHMgPT09IGZyZWVFeHBvcnRzICYmIGZyZWVFeHBvcnRzOwoKICAvKiogRGV0ZWN0IGZyZWUgdmFyaWFibGUgYGdsb2JhbGAgZnJvbSBOb2RlLmpzIG9yIEJyb3dzZXJpZmllZCBjb2RlIGFuZCB1c2UgaXQgYXMgYHJvb3RgICovCiAgdmFyIGZyZWVHbG9iYWwgPSBvYmplY3RUeXBlc1t0eXBlb2YgZ2xvYmFsXSAmJiBnbG9iYWw7CiAgaWYgKGZyZWVHbG9iYWwgJiYgKGZyZWVHbG9iYWwuZ2xvYmFsID09PSBmcmVlR2xvYmFsIHx8IGZyZWVHbG9iYWwud2luZG93ID09PSBmcmVlR2xvYmFsKSkgewogICAgcm9vdCA9IGZyZWVHbG9iYWw7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uaW5kZXhPZmAgd2l0aG91dCBzdXBwb3J0IGZvciBiaW5hcnkgc2VhcmNoZXMKICAgKiBvciBgZnJvbUluZGV4YCBjb25zdHJhaW50cy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSBvciBgLTFgLgogICAqLwogIGZ1bmN0aW9uIGJhc2VJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICB2YXIgaW5kZXggPSAoZnJvbUluZGV4IHx8IDApIC0gMSwKICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAtMTsKICB9CgogIC8qKgogICAqIEFuIGltcGxlbWVudGF0aW9uIG9mIGBfLmNvbnRhaW5zYCBmb3IgY2FjaGUgb2JqZWN0cyB0aGF0IG1pbWljcyB0aGUgcmV0dXJuCiAgICogc2lnbmF0dXJlIG9mIGBfLmluZGV4T2ZgIGJ5IHJldHVybmluZyBgMGAgaWYgdGhlIHZhbHVlIGlzIGZvdW5kLCBlbHNlIGAtMWAuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBjYWNoZSBUaGUgY2FjaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2VhcmNoIGZvci4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGAwYCBpZiBgdmFsdWVgIGlzIGZvdW5kLCBlbHNlIGAtMWAuCiAgICovCiAgZnVuY3Rpb24gY2FjaGVJbmRleE9mKGNhY2hlLCB2YWx1ZSkgewogICAgdmFyIHR5cGUgPSB0eXBlb2YgdmFsdWU7CiAgICBjYWNoZSA9IGNhY2hlLmNhY2hlOwoKICAgIGlmICh0eXBlID09ICdib29sZWFuJyB8fCB2YWx1ZSA9PSBudWxsKSB7CiAgICAgIHJldHVybiBjYWNoZVt2YWx1ZV0gPyAwIDogLTE7CiAgICB9CiAgICBpZiAodHlwZSAhPSAnbnVtYmVyJyAmJiB0eXBlICE9ICdzdHJpbmcnKSB7CiAgICAgIHR5cGUgPSAnb2JqZWN0JzsKICAgIH0KICAgIHZhciBrZXkgPSB0eXBlID09ICdudW1iZXInID8gdmFsdWUgOiBrZXlQcmVmaXggKyB2YWx1ZTsKICAgIGNhY2hlID0gKGNhY2hlID0gY2FjaGVbdHlwZV0pICYmIGNhY2hlW2tleV07CgogICAgcmV0dXJuIHR5cGUgPT0gJ29iamVjdCcKICAgICAgPyAoY2FjaGUgJiYgYmFzZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA+IC0xID8gMCA6IC0xKQogICAgICA6IChjYWNoZSA/IDAgOiAtMSk7CiAgfQoKICAvKioKICAgKiBBZGRzIGEgZ2l2ZW4gdmFsdWUgdG8gdGhlIGNvcnJlc3BvbmRpbmcgY2FjaGUgb2JqZWN0LgogICAqCiAgICogQHByaXZhdGUKICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBhZGQgdG8gdGhlIGNhY2hlLgogICAqLwogIGZ1bmN0aW9uIGNhY2hlUHVzaCh2YWx1ZSkgewogICAgdmFyIGNhY2hlID0gdGhpcy5jYWNoZSwKICAgICAgICB0eXBlID0gdHlwZW9mIHZhbHVlOwoKICAgIGlmICh0eXBlID09ICdib29sZWFuJyB8fCB2YWx1ZSA9PSBudWxsKSB7CiAgICAgIGNhY2hlW3ZhbHVlXSA9IHRydWU7CiAgICB9IGVsc2UgewogICAgICBpZiAodHlwZSAhPSAnbnVtYmVyJyAmJiB0eXBlICE9ICdzdHJpbmcnKSB7CiAgICAgICAgdHlwZSA9ICdvYmplY3QnOwogICAgICB9CiAgICAgIHZhciBrZXkgPSB0eXBlID09ICdudW1iZXInID8gdmFsdWUgOiBrZXlQcmVmaXggKyB2YWx1ZSwKICAgICAgICAgIHR5cGVDYWNoZSA9IGNhY2hlW3R5cGVdIHx8IChjYWNoZVt0eXBlXSA9IHt9KTsKCiAgICAgIGlmICh0eXBlID09ICdvYmplY3QnKSB7CiAgICAgICAgKHR5cGVDYWNoZVtrZXldIHx8ICh0eXBlQ2FjaGVba2V5XSA9IFtdKSkucHVzaCh2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdHlwZUNhY2hlW2tleV0gPSB0cnVlOwogICAgICB9CiAgICB9CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGBfLm1heGAgYW5kIGBfLm1pbmAgYXMgdGhlIGRlZmF1bHQgY2FsbGJhY2sgd2hlbiBhIGdpdmVuCiAgICogY29sbGVjdGlvbiBpcyBhIHN0cmluZyB2YWx1ZS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIFRoZSBjaGFyYWN0ZXIgdG8gaW5zcGVjdC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBjb2RlIHVuaXQgb2YgZ2l2ZW4gY2hhcmFjdGVyLgogICAqLwogIGZ1bmN0aW9uIGNoYXJBdENhbGxiYWNrKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUuY2hhckNvZGVBdCgwKTsKICB9CgogIC8qKgogICAqIFVzZWQgYnkgYHNvcnRCeWAgdG8gY29tcGFyZSB0cmFuc2Zvcm1lZCBgY29sbGVjdGlvbmAgZWxlbWVudHMsIHN0YWJsZSBzb3J0aW5nCiAgICogdGhlbSBpbiBhc2NlbmRpbmcgb3JkZXIuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBhIFRoZSBvYmplY3QgdG8gY29tcGFyZSB0byBgYmAuCiAgICogQHBhcmFtIHtPYmplY3R9IGIgVGhlIG9iamVjdCB0byBjb21wYXJlIHRvIGBhYC4KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBzb3J0IG9yZGVyIGluZGljYXRvciBvZiBgMWAgb3IgYC0xYC4KICAgKi8KICBmdW5jdGlvbiBjb21wYXJlQXNjZW5kaW5nKGEsIGIpIHsKICAgIHZhciBhYyA9IGEuY3JpdGVyaWEsCiAgICAgICAgYmMgPSBiLmNyaXRlcmlhOwoKICAgIC8vIGVuc3VyZSBhIHN0YWJsZSBzb3J0IGluIFY4IGFuZCBvdGhlciBlbmdpbmVzCiAgICAvLyBodHRwOi8vY29kZS5nb29nbGUuY29tL3AvdjgvaXNzdWVzL2RldGFpbD9pZD05MAogICAgaWYgKGFjICE9PSBiYykgewogICAgICBpZiAoYWMgPiBiYyB8fCB0eXBlb2YgYWMgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQogICAgICBpZiAoYWMgPCBiYyB8fCB0eXBlb2YgYmMgPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0KICAgIH0KICAgIC8vIFRoZSBKUyBlbmdpbmUgZW1iZWRkZWQgaW4gQWRvYmUgYXBwbGljYXRpb25zIGxpa2UgSW5EZXNpZ24gaGFzIGEgYnVnZ3kKICAgIC8vIGBBcnJheSNzb3J0YCBpbXBsZW1lbnRhdGlvbiB0aGF0IGNhdXNlcyBpdCwgdW5kZXIgY2VydGFpbiBjaXJjdW1zdGFuY2VzLAogICAgLy8gdG8gcmV0dXJuIHRoZSBzYW1lIHZhbHVlIGZvciBgYWAgYW5kIGBiYC4KICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vamFzaGtlbmFzL3VuZGVyc2NvcmUvcHVsbC8xMjQ3CiAgICByZXR1cm4gYS5pbmRleCAtIGIuaW5kZXg7CiAgfQoKICAvKioKICAgKiBDcmVhdGVzIGEgY2FjaGUgb2JqZWN0IHRvIG9wdGltaXplIGxpbmVhciBzZWFyY2hlcyBvZiBsYXJnZSBhcnJheXMuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7QXJyYXl9IFthcnJheT1bXV0gVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgKiBAcmV0dXJucyB7bnVsbHxPYmplY3R9IFJldHVybnMgdGhlIGNhY2hlIG9iamVjdCBvciBgbnVsbGAgaWYgY2FjaGluZyBzaG91bGQgbm90IGJlIHVzZWQuCiAgICovCiAgZnVuY3Rpb24gY3JlYXRlQ2FjaGUoYXJyYXkpIHsKICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGFycmF5Lmxlbmd0aCwKICAgICAgICBmaXJzdCA9IGFycmF5WzBdLAogICAgICAgIG1pZCA9IGFycmF5WyhsZW5ndGggLyAyKSB8IDBdLAogICAgICAgIGxhc3QgPSBhcnJheVtsZW5ndGggLSAxXTsKCiAgICBpZiAoZmlyc3QgJiYgdHlwZW9mIGZpcnN0ID09ICdvYmplY3QnICYmCiAgICAgICAgbWlkICYmIHR5cGVvZiBtaWQgPT0gJ29iamVjdCcgJiYgbGFzdCAmJiB0eXBlb2YgbGFzdCA9PSAnb2JqZWN0JykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB2YXIgY2FjaGUgPSBnZXRPYmplY3QoKTsKICAgIGNhY2hlWydmYWxzZSddID0gY2FjaGVbJ251bGwnXSA9IGNhY2hlWyd0cnVlJ10gPSBjYWNoZVsndW5kZWZpbmVkJ10gPSBmYWxzZTsKCiAgICB2YXIgcmVzdWx0ID0gZ2V0T2JqZWN0KCk7CiAgICByZXN1bHQuYXJyYXkgPSBhcnJheTsKICAgIHJlc3VsdC5jYWNoZSA9IGNhY2hlOwogICAgcmVzdWx0LnB1c2ggPSBjYWNoZVB1c2g7CgogICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgcmVzdWx0LnB1c2goYXJyYXlbaW5kZXhdKTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKioKICAgKiBVc2VkIGJ5IGB0ZW1wbGF0ZWAgdG8gZXNjYXBlIGNoYXJhY3RlcnMgZm9yIGluY2x1c2lvbiBpbiBjb21waWxlZAogICAqIHN0cmluZyBsaXRlcmFscy4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBjaGFyYWN0ZXIuCiAgICovCiAgZnVuY3Rpb24gZXNjYXBlU3RyaW5nQ2hhcihtYXRjaCkgewogICAgcmV0dXJuICdcXCcgKyBzdHJpbmdFc2NhcGVzW21hdGNoXTsKICB9CgogIC8qKgogICAqIEdldHMgYW4gYXJyYXkgZnJvbSB0aGUgYXJyYXkgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge0FycmF5fSBUaGUgYXJyYXkgZnJvbSB0aGUgcG9vbC4KICAgKi8KICBmdW5jdGlvbiBnZXRBcnJheSgpIHsKICAgIHJldHVybiBhcnJheVBvb2wucG9wKCkgfHwgW107CiAgfQoKICAvKioKICAgKiBHZXRzIGFuIG9iamVjdCBmcm9tIHRoZSBvYmplY3QgcG9vbCBvciBjcmVhdGVzIGEgbmV3IG9uZSBpZiB0aGUgcG9vbCBpcyBlbXB0eS4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHJldHVybnMge09iamVjdH0gVGhlIG9iamVjdCBmcm9tIHRoZSBwb29sLgogICAqLwogIGZ1bmN0aW9uIGdldE9iamVjdCgpIHsKICAgIHJldHVybiBvYmplY3RQb29sLnBvcCgpIHx8IHsKICAgICAgJ2FycmF5JzogbnVsbCwKICAgICAgJ2NhY2hlJzogbnVsbCwKICAgICAgJ2NyaXRlcmlhJzogbnVsbCwKICAgICAgJ2ZhbHNlJzogZmFsc2UsCiAgICAgICdpbmRleCc6IDAsCiAgICAgICdudWxsJzogZmFsc2UsCiAgICAgICdudW1iZXInOiBudWxsLAogICAgICAnb2JqZWN0JzogbnVsbCwKICAgICAgJ3B1c2gnOiBudWxsLAogICAgICAnc3RyaW5nJzogbnVsbCwKICAgICAgJ3RydWUnOiBmYWxzZSwKICAgICAgJ3VuZGVmaW5lZCc6IGZhbHNlLAogICAgICAndmFsdWUnOiBudWxsCiAgICB9OwogIH0KCiAgLyoqCiAgICogQSBuby1vcGVyYXRpb24gZnVuY3Rpb24uCiAgICoKICAgKiBAcHJpdmF0ZQogICAqLwogIGZ1bmN0aW9uIG5vb3AoKSB7CiAgICAvLyBubyBvcGVyYXRpb24gcGVyZm9ybWVkCiAgfQoKICAvKioKICAgKiBSZWxlYXNlcyB0aGUgZ2l2ZW4gYXJyYXkgYmFjayB0byB0aGUgYXJyYXkgcG9vbC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheX0gW2FycmF5XSBUaGUgYXJyYXkgdG8gcmVsZWFzZS4KICAgKi8KICBmdW5jdGlvbiByZWxlYXNlQXJyYXkoYXJyYXkpIHsKICAgIGFycmF5Lmxlbmd0aCA9IDA7CiAgICBpZiAoYXJyYXlQb29sLmxlbmd0aCA8IG1heFBvb2xTaXplKSB7CiAgICAgIGFycmF5UG9vbC5wdXNoKGFycmF5KTsKICAgIH0KICB9CgogIC8qKgogICAqIFJlbGVhc2VzIHRoZSBnaXZlbiBvYmplY3QgYmFjayB0byB0aGUgb2JqZWN0IHBvb2wuCiAgICoKICAgKiBAcHJpdmF0ZQogICAqIEBwYXJhbSB7T2JqZWN0fSBbb2JqZWN0XSBUaGUgb2JqZWN0IHRvIHJlbGVhc2UuCiAgICovCiAgZnVuY3Rpb24gcmVsZWFzZU9iamVjdChvYmplY3QpIHsKICAgIHZhciBjYWNoZSA9IG9iamVjdC5jYWNoZTsKICAgIGlmIChjYWNoZSkgewogICAgICByZWxlYXNlT2JqZWN0KGNhY2hlKTsKICAgIH0KICAgIG9iamVjdC5hcnJheSA9IG9iamVjdC5jYWNoZSA9IG9iamVjdC5jcml0ZXJpYSA9IG9iamVjdC5vYmplY3QgPSBvYmplY3QubnVtYmVyID0gb2JqZWN0LnN0cmluZyA9IG9iamVjdC52YWx1ZSA9IG51bGw7CiAgICBpZiAob2JqZWN0UG9vbC5sZW5ndGggPCBtYXhQb29sU2l6ZSkgewogICAgICBvYmplY3RQb29sLnB1c2gob2JqZWN0KTsKICAgIH0KICB9CgogIC8qKgogICAqIFNsaWNlcyB0aGUgYGNvbGxlY3Rpb25gIGZyb20gdGhlIGBzdGFydGAgaW5kZXggdXAgdG8sIGJ1dCBub3QgaW5jbHVkaW5nLAogICAqIHRoZSBgZW5kYCBpbmRleC4KICAgKgogICAqIE5vdGU6IFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBpbnN0ZWFkIG9mIGBBcnJheSNzbGljZWAgdG8gc3VwcG9ydCBub2RlIGxpc3RzCiAgICogaW4gSUUgPCA5IGFuZCB0byBlbnN1cmUgZGVuc2UgYXJyYXlzIGFyZSByZXR1cm5lZC4KICAgKgogICAqIEBwcml2YXRlCiAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNsaWNlLgogICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBUaGUgc3RhcnQgaW5kZXguCiAgICogQHBhcmFtIHtudW1iZXJ9IGVuZCBUaGUgZW5kIGluZGV4LgogICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgbmV3IGFycmF5LgogICAqLwogIGZ1bmN0aW9uIHNsaWNlKGFycmF5LCBzdGFydCwgZW5kKSB7CiAgICBzdGFydCB8fCAoc3RhcnQgPSAwKTsKICAgIGlmICh0eXBlb2YgZW5kID09ICd1bmRlZmluZWQnKSB7CiAgICAgIGVuZCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgIH0KICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgIGxlbmd0aCA9IGVuZCAtIHN0YXJ0IHx8IDAsCiAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoIDwgMCA/IDAgOiBsZW5ndGgpOwoKICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgIHJlc3VsdFtpbmRleF0gPSBhcnJheVtzdGFydCArIGluZGV4XTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IGBsb2Rhc2hgIGZ1bmN0aW9uIHVzaW5nIHRoZSBnaXZlbiBjb250ZXh0IG9iamVjdC4KICAgKgogICAqIEBzdGF0aWMKICAgKiBAbWVtYmVyT2YgXwogICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgKiBAcGFyYW0ge09iamVjdH0gW2NvbnRleHQ9cm9vdF0gVGhlIGNvbnRleHQgb2JqZWN0LgogICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICovCiAgZnVuY3Rpb24gcnVuSW5Db250ZXh0KGNvbnRleHQpIHsKICAgIC8vIEF2b2lkIGlzc3VlcyB3aXRoIHNvbWUgRVMzIGVudmlyb25tZW50cyB0aGF0IGF0dGVtcHQgdG8gdXNlIHZhbHVlcywgbmFtZWQKICAgIC8vIGFmdGVyIGJ1aWx0LWluIGNvbnN0cnVjdG9ycyBsaWtlIGBPYmplY3RgLCBmb3IgdGhlIGNyZWF0aW9uIG9mIGxpdGVyYWxzLgogICAgLy8gRVM1IGNsZWFycyB0aGlzIHVwIGJ5IHN0YXRpbmcgdGhhdCBsaXRlcmFscyBtdXN0IHVzZSBidWlsdC1pbiBjb25zdHJ1Y3RvcnMuCiAgICAvLyBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI3gxMS4xLjUuCiAgICBjb250ZXh0ID0gY29udGV4dCA/IF8uZGVmYXVsdHMocm9vdC5PYmplY3QoKSwgY29udGV4dCwgXy5waWNrKHJvb3QsIGNvbnRleHRQcm9wcykpIDogcm9vdDsKCiAgICAvKiogTmF0aXZlIGNvbnN0cnVjdG9yIHJlZmVyZW5jZXMgKi8KICAgIHZhciBBcnJheSA9IGNvbnRleHQuQXJyYXksCiAgICAgICAgQm9vbGVhbiA9IGNvbnRleHQuQm9vbGVhbiwKICAgICAgICBEYXRlID0gY29udGV4dC5EYXRlLAogICAgICAgIEZ1bmN0aW9uID0gY29udGV4dC5GdW5jdGlvbiwKICAgICAgICBNYXRoID0gY29udGV4dC5NYXRoLAogICAgICAgIE51bWJlciA9IGNvbnRleHQuTnVtYmVyLAogICAgICAgIE9iamVjdCA9IGNvbnRleHQuT2JqZWN0LAogICAgICAgIFJlZ0V4cCA9IGNvbnRleHQuUmVnRXhwLAogICAgICAgIFN0cmluZyA9IGNvbnRleHQuU3RyaW5nLAogICAgICAgIFR5cGVFcnJvciA9IGNvbnRleHQuVHlwZUVycm9yOwoKICAgIC8qKgogICAgICogVXNlZCBmb3IgYEFycmF5YCBtZXRob2QgcmVmZXJlbmNlcy4KICAgICAqCiAgICAgKiBOb3JtYWxseSBgQXJyYXkucHJvdG90eXBlYCB3b3VsZCBzdWZmaWNlLCBob3dldmVyLCB1c2luZyBhbiBhcnJheSBsaXRlcmFsCiAgICAgKiBhdm9pZHMgaXNzdWVzIGluIE5hcndoYWwuCiAgICAgKi8KICAgIHZhciBhcnJheVJlZiA9IFtdOwoKICAgIC8qKiBVc2VkIGZvciBuYXRpdmUgbWV0aG9kIHJlZmVyZW5jZXMgKi8KICAgIHZhciBvYmplY3RQcm90byA9IE9iamVjdC5wcm90b3R5cGU7CgogICAgLyoqIFVzZWQgdG8gcmVzdG9yZSB0aGUgb3JpZ2luYWwgYF9gIHJlZmVyZW5jZSBpbiBgbm9Db25mbGljdGAgKi8KICAgIHZhciBvbGREYXNoID0gY29udGV4dC5fOwoKICAgIC8qKiBVc2VkIHRvIGRldGVjdCBpZiBhIG1ldGhvZCBpcyBuYXRpdmUgKi8KICAgIHZhciByZU5hdGl2ZSA9IFJlZ0V4cCgnXicgKwogICAgICBTdHJpbmcob2JqZWN0UHJvdG8udmFsdWVPZikKICAgICAgICAucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xdXFxdL2csICdcXCQmJykKICAgICAgICAucmVwbGFjZSgvdmFsdWVPZnxmb3IgW15cXV0rL2csICcuKz8nKSArICckJwogICAgKTsKCiAgICAvKiogTmF0aXZlIG1ldGhvZCBzaG9ydGN1dHMgKi8KICAgIHZhciBjZWlsID0gTWF0aC5jZWlsLAogICAgICAgIGNsZWFyVGltZW91dCA9IGNvbnRleHQuY2xlYXJUaW1lb3V0LAogICAgICAgIGZsb29yID0gTWF0aC5mbG9vciwKICAgICAgICBmblRvU3RyaW5nID0gRnVuY3Rpb24ucHJvdG90eXBlLnRvU3RyaW5nLAogICAgICAgIGdldFByb3RvdHlwZU9mID0gcmVOYXRpdmUudGVzdChnZXRQcm90b3R5cGVPZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZikgJiYgZ2V0UHJvdG90eXBlT2YsCiAgICAgICAgaGFzT3duUHJvcGVydHkgPSBvYmplY3RQcm90by5oYXNPd25Qcm9wZXJ0eSwKICAgICAgICBub3cgPSByZU5hdGl2ZS50ZXN0KG5vdyA9IERhdGUubm93KSAmJiBub3cgfHwgZnVuY3Rpb24oKSB7IHJldHVybiArbmV3IERhdGU7IH0sCiAgICAgICAgcHVzaCA9IGFycmF5UmVmLnB1c2gsCiAgICAgICAgc2V0SW1tZWRpYXRlID0gY29udGV4dC5zZXRJbW1lZGlhdGUsCiAgICAgICAgc2V0VGltZW91dCA9IGNvbnRleHQuc2V0VGltZW91dCwKICAgICAgICBzcGxpY2UgPSBhcnJheVJlZi5zcGxpY2UsCiAgICAgICAgdG9TdHJpbmcgPSBvYmplY3RQcm90by50b1N0cmluZywKICAgICAgICB1bnNoaWZ0ID0gYXJyYXlSZWYudW5zaGlmdDsKCiAgICB2YXIgZGVmaW5lUHJvcGVydHkgPSAoZnVuY3Rpb24oKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIG8gPSB7fSwKICAgICAgICAgICAgZnVuYyA9IHJlTmF0aXZlLnRlc3QoZnVuYyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgJiYgZnVuYywKICAgICAgICAgICAgcmVzdWx0ID0gZnVuYyhvLCBvLCBvKSAmJiBmdW5jOwogICAgICB9IGNhdGNoKGUpIHsgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSgpKTsKCiAgICAvKiBOYXRpdmUgbWV0aG9kIHNob3J0Y3V0cyBmb3IgbWV0aG9kcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgb3RoZXIgYGxvZGFzaGAgbWV0aG9kcyAqLwogICAgdmFyIG5hdGl2ZUJpbmQgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUJpbmQgPSB0b1N0cmluZy5iaW5kKSAmJiBuYXRpdmVCaW5kLAogICAgICAgIG5hdGl2ZUNyZWF0ZSA9IHJlTmF0aXZlLnRlc3QobmF0aXZlQ3JlYXRlID0gT2JqZWN0LmNyZWF0ZSkgJiYgbmF0aXZlQ3JlYXRlLAogICAgICAgIG5hdGl2ZUlzQXJyYXkgPSByZU5hdGl2ZS50ZXN0KG5hdGl2ZUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KSAmJiBuYXRpdmVJc0FycmF5LAogICAgICAgIG5hdGl2ZUlzRmluaXRlID0gY29udGV4dC5pc0Zpbml0ZSwKICAgICAgICBuYXRpdmVJc05hTiA9IGNvbnRleHQuaXNOYU4sCiAgICAgICAgbmF0aXZlS2V5cyA9IHJlTmF0aXZlLnRlc3QobmF0aXZlS2V5cyA9IE9iamVjdC5rZXlzKSAmJiBuYXRpdmVLZXlzLAogICAgICAgIG5hdGl2ZU1heCA9IE1hdGgubWF4LAogICAgICAgIG5hdGl2ZU1pbiA9IE1hdGgubWluLAogICAgICAgIG5hdGl2ZVBhcnNlSW50ID0gY29udGV4dC5wYXJzZUludCwKICAgICAgICBuYXRpdmVSYW5kb20gPSBNYXRoLnJhbmRvbSwKICAgICAgICBuYXRpdmVTbGljZSA9IGFycmF5UmVmLnNsaWNlOwoKICAgIC8qKiBEZXRlY3QgdmFyaW91cyBlbnZpcm9ubWVudHMgKi8KICAgIHZhciBpc0llT3BlcmEgPSByZU5hdGl2ZS50ZXN0KGNvbnRleHQuYXR0YWNoRXZlbnQpLAogICAgICAgIGlzVjggPSBuYXRpdmVCaW5kICYmICEvXG58dHJ1ZS8udGVzdChuYXRpdmVCaW5kICsgaXNJZU9wZXJhKTsKCiAgICAvKiogVXNlZCB0byBsb29rdXAgYSBidWlsdC1pbiBjb25zdHJ1Y3RvciBieSBbW0NsYXNzXV0gKi8KICAgIHZhciBjdG9yQnlDbGFzcyA9IHt9OwogICAgY3RvckJ5Q2xhc3NbYXJyYXlDbGFzc10gPSBBcnJheTsKICAgIGN0b3JCeUNsYXNzW2Jvb2xDbGFzc10gPSBCb29sZWFuOwogICAgY3RvckJ5Q2xhc3NbZGF0ZUNsYXNzXSA9IERhdGU7CiAgICBjdG9yQnlDbGFzc1tmdW5jQ2xhc3NdID0gRnVuY3Rpb247CiAgICBjdG9yQnlDbGFzc1tvYmplY3RDbGFzc10gPSBPYmplY3Q7CiAgICBjdG9yQnlDbGFzc1tudW1iZXJDbGFzc10gPSBOdW1iZXI7CiAgICBjdG9yQnlDbGFzc1tyZWdleHBDbGFzc10gPSBSZWdFeHA7CiAgICBjdG9yQnlDbGFzc1tzdHJpbmdDbGFzc10gPSBTdHJpbmc7CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0IHdoaWNoIHdyYXBzIHRoZSBnaXZlbiB2YWx1ZSB0byBlbmFibGUgaW50dWl0aXZlCiAgICAgKiBtZXRob2QgY2hhaW5pbmcuCiAgICAgKgogICAgICogSW4gYWRkaXRpb24gdG8gTG8tRGFzaCBtZXRob2RzLCB3cmFwcGVycyBhbHNvIGhhdmUgdGhlIGZvbGxvd2luZyBgQXJyYXlgIG1ldGhvZHM6CiAgICAgKiBgY29uY2F0YCwgYGpvaW5gLCBgcG9wYCwgYHB1c2hgLCBgcmV2ZXJzZWAsIGBzaGlmdGAsIGBzbGljZWAsIGBzb3J0YCwgYHNwbGljZWAsCiAgICAgKiBhbmQgYHVuc2hpZnRgCiAgICAgKgogICAgICogQ2hhaW5pbmcgaXMgc3VwcG9ydGVkIGluIGN1c3RvbSBidWlsZHMgYXMgbG9uZyBhcyB0aGUgYHZhbHVlYCBtZXRob2QgaXMKICAgICAqIGltcGxpY2l0bHkgb3IgZXhwbGljaXRseSBpbmNsdWRlZCBpbiB0aGUgYnVpbGQuCiAgICAgKgogICAgICogVGhlIGNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICAgKiBgYWZ0ZXJgLCBgYXNzaWduYCwgYGJpbmRgLCBgYmluZEFsbGAsIGBiaW5kS2V5YCwgYGNoYWluYCwgYGNvbXBhY3RgLAogICAgICogYGNvbXBvc2VgLCBgY29uY2F0YCwgYGNvdW50QnlgLCBgY3JlYXRlQ2FsbGJhY2tgLCBgY3VycnlgLCBgZGVib3VuY2VgLAogICAgICogYGRlZmF1bHRzYCwgYGRlZmVyYCwgYGRlbGF5YCwgYGRpZmZlcmVuY2VgLCBgZmlsdGVyYCwgYGZsYXR0ZW5gLCBgZm9yRWFjaGAsCiAgICAgKiBgZm9yRWFjaFJpZ2h0YCwgYGZvckluYCwgYGZvckluUmlnaHRgLCBgZm9yT3duYCwgYGZvck93blJpZ2h0YCwgYGZ1bmN0aW9uc2AsCiAgICAgKiBgZ3JvdXBCeWAsIGBpbmRleEJ5YCwgYGluaXRpYWxgLCBgaW50ZXJzZWN0aW9uYCwgYGludmVydGAsIGBpbnZva2VgLCBga2V5c2AsCiAgICAgKiBgbWFwYCwgYG1heGAsIGBtZW1vaXplYCwgYG1lcmdlYCwgYG1pbmAsIGBvYmplY3RgLCBgb21pdGAsIGBvbmNlYCwgYHBhaXJzYCwKICAgICAqIGBwYXJ0aWFsYCwgYHBhcnRpYWxSaWdodGAsIGBwaWNrYCwgYHBsdWNrYCwgYHB1bGxgLCBgcHVzaGAsIGByYW5nZWAsIGByZWplY3RgLAogICAgICogYHJlbW92ZWAsIGByZXN0YCwgYHJldmVyc2VgLCBgc2h1ZmZsZWAsIGBzbGljZWAsIGBzb3J0YCwgYHNvcnRCeWAsIGBzcGxpY2VgLAogICAgICogYHRhcGAsIGB0aHJvdHRsZWAsIGB0aW1lc2AsIGB0b0FycmF5YCwgYHRyYW5zZm9ybWAsIGB1bmlvbmAsIGB1bmlxYCwgYHVuc2hpZnRgLAogICAgICogYHVuemlwYCwgYHZhbHVlc2AsIGB3aGVyZWAsIGB3aXRob3V0YCwgYHdyYXBgLCBhbmQgYHppcGAKICAgICAqCiAgICAgKiBUaGUgbm9uLWNoYWluYWJsZSB3cmFwcGVyIGZ1bmN0aW9ucyBhcmU6CiAgICAgKiBgY2xvbmVgLCBgY2xvbmVEZWVwYCwgYGNvbnRhaW5zYCwgYGVzY2FwZWAsIGBldmVyeWAsIGBmaW5kYCwgYGZpbmRJbmRleGAsCiAgICAgKiBgZmluZEtleWAsIGBmaW5kTGFzdGAsIGBmaW5kTGFzdEluZGV4YCwgYGZpbmRMYXN0S2V5YCwgYGhhc2AsIGBpZGVudGl0eWAsCiAgICAgKiBgaW5kZXhPZmAsIGBpc0FyZ3VtZW50c2AsIGBpc0FycmF5YCwgYGlzQm9vbGVhbmAsIGBpc0RhdGVgLCBgaXNFbGVtZW50YCwKICAgICAqIGBpc0VtcHR5YCwgYGlzRXF1YWxgLCBgaXNGaW5pdGVgLCBgaXNGdW5jdGlvbmAsIGBpc05hTmAsIGBpc051bGxgLCBgaXNOdW1iZXJgLAogICAgICogYGlzT2JqZWN0YCwgYGlzUGxhaW5PYmplY3RgLCBgaXNSZWdFeHBgLCBgaXNTdHJpbmdgLCBgaXNVbmRlZmluZWRgLCBgam9pbmAsCiAgICAgKiBgbGFzdEluZGV4T2ZgLCBgbWl4aW5gLCBgbm9Db25mbGljdGAsIGBwYXJzZUludGAsIGBwb3BgLCBgcmFuZG9tYCwgYHJlZHVjZWAsCiAgICAgKiBgcmVkdWNlUmlnaHRgLCBgcmVzdWx0YCwgYHNoaWZ0YCwgYHNpemVgLCBgc29tZWAsIGBzb3J0ZWRJbmRleGAsIGBydW5JbkNvbnRleHRgLAogICAgICogYHRlbXBsYXRlYCwgYHVuZXNjYXBlYCwgYHVuaXF1ZUlkYCwgYW5kIGB2YWx1ZWAKICAgICAqCiAgICAgKiBUaGUgd3JhcHBlciBmdW5jdGlvbnMgYGZpcnN0YCBhbmQgYGxhc3RgIHJldHVybiB3cmFwcGVkIHZhbHVlcyB3aGVuIGBuYCBpcwogICAgICogcHJvdmlkZWQsIG90aGVyd2lzZSB0aGV5IHJldHVybiB1bndyYXBwZWQgdmFsdWVzLgogICAgICoKICAgICAqIEV4cGxpY2l0IGNoYWluaW5nIGNhbiBiZSBlbmFibGVkIGJ5IHVzaW5nIHRoZSBgXy5jaGFpbmAgbWV0aG9kLgogICAgICoKICAgICAqIEBuYW1lIF8KICAgICAqIEBjb25zdHJ1Y3RvcgogICAgICogQGNhdGVnb3J5IENoYWluaW5nCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwIGluIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGEgYGxvZGFzaGAgaW5zdGFuY2UuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciB3cmFwcGVkID0gXyhbMSwgMiwgM10pOwogICAgICoKICAgICAqIC8vIHJldHVybnMgYW4gdW53cmFwcGVkIHZhbHVlCiAgICAgKiB3cmFwcGVkLnJlZHVjZShmdW5jdGlvbihzdW0sIG51bSkgewogICAgICogICByZXR1cm4gc3VtICsgbnVtOwogICAgICogfSk7CiAgICAgKiAvLyA9PiA2CiAgICAgKgogICAgICogLy8gcmV0dXJucyBhIHdyYXBwZWQgdmFsdWUKICAgICAqIHZhciBzcXVhcmVzID0gd3JhcHBlZC5tYXAoZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gKiBudW07CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoc3F1YXJlcyk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNBcnJheShzcXVhcmVzLnZhbHVlKCkpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBsb2Rhc2godmFsdWUpIHsKICAgICAgLy8gZG9uJ3Qgd3JhcCBpZiBhbHJlYWR5IHdyYXBwZWQsIGV2ZW4gaWYgd3JhcHBlZCBieSBhIGRpZmZlcmVudCBgbG9kYXNoYCBjb25zdHJ1Y3RvcgogICAgICByZXR1cm4gKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiAhaXNBcnJheSh2YWx1ZSkgJiYgaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgJ19fd3JhcHBlZF9fJykpCiAgICAgICA/IHZhbHVlCiAgICAgICA6IG5ldyBsb2Rhc2hXcmFwcGVyKHZhbHVlKTsKICAgIH0KCiAgICAvKioKICAgICAqIEEgZmFzdCBwYXRoIGZvciBjcmVhdGluZyBgbG9kYXNoYCB3cmFwcGVyIG9iamVjdHMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAgaW4gYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hhaW5BbGwgQSBmbGFnIHRvIGVuYWJsZSBjaGFpbmluZyBmb3IgYWxsIG1ldGhvZHMKICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYSBgbG9kYXNoYCBpbnN0YW5jZS4KICAgICAqLwogICAgZnVuY3Rpb24gbG9kYXNoV3JhcHBlcih2YWx1ZSwgY2hhaW5BbGwpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSAhIWNoYWluQWxsOwogICAgICB0aGlzLl9fd3JhcHBlZF9fID0gdmFsdWU7CiAgICB9CiAgICAvLyBlbnN1cmUgYG5ldyBsb2Rhc2hXcmFwcGVyYCBpcyBhbiBpbnN0YW5jZSBvZiBgbG9kYXNoYAogICAgbG9kYXNoV3JhcHBlci5wcm90b3R5cGUgPSBsb2Rhc2gucHJvdG90eXBlOwoKICAgIC8qKgogICAgICogQW4gb2JqZWN0IHVzZWQgdG8gZmxhZyBlbnZpcm9ubWVudHMgZmVhdHVyZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIE9iamVjdAogICAgICovCiAgICB2YXIgc3VwcG9ydCA9IGxvZGFzaC5zdXBwb3J0ID0ge307CgogICAgLyoqCiAgICAgKiBEZXRlY3QgaWYgYEZ1bmN0aW9uI2JpbmRgIGV4aXN0cyBhbmQgaXMgaW5mZXJyZWQgdG8gYmUgZmFzdCAoYWxsIGJ1dCBWOCkuCiAgICAgKgogICAgICogQG1lbWJlck9mIF8uc3VwcG9ydAogICAgICogQHR5cGUgYm9vbGVhbgogICAgICovCiAgICBzdXBwb3J0LmZhc3RCaW5kID0gbmF0aXZlQmluZCAmJiAhaXNWODsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBmdW5jdGlvbnMgY2FuIGJlIGRlY29tcGlsZWQgYnkgYEZ1bmN0aW9uI3RvU3RyaW5nYAogICAgICogKGFsbCBidXQgUFMzIGFuZCBvbGRlciBPcGVyYSBtb2JpbGUgYnJvd3NlcnMgJiBhdm9pZGVkIGluIFdpbmRvd3MgOCBhcHBzKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY0RlY29tcCA9ICFyZU5hdGl2ZS50ZXN0KGNvbnRleHQuV2luUlRFcnJvcikgJiYgcmVUaGlzLnRlc3QocnVuSW5Db250ZXh0KTsKCiAgICAvKioKICAgICAqIERldGVjdCBpZiBgRnVuY3Rpb24jbmFtZWAgaXMgc3VwcG9ydGVkIChhbGwgYnV0IElFKS4KICAgICAqCiAgICAgKiBAbWVtYmVyT2YgXy5zdXBwb3J0CiAgICAgKiBAdHlwZSBib29sZWFuCiAgICAgKi8KICAgIHN1cHBvcnQuZnVuY05hbWVzID0gdHlwZW9mIEZ1bmN0aW9uLm5hbWUgPT0gJ3N0cmluZyc7CgogICAgLyoqCiAgICAgKiBCeSBkZWZhdWx0LCB0aGUgdGVtcGxhdGUgZGVsaW1pdGVycyB1c2VkIGJ5IExvLURhc2ggYXJlIHNpbWlsYXIgdG8gdGhvc2UgaW4KICAgICAqIGVtYmVkZGVkIFJ1YnkgKEVSQikuIENoYW5nZSB0aGUgZm9sbG93aW5nIHRlbXBsYXRlIHNldHRpbmdzIHRvIHVzZSBhbHRlcm5hdGl2ZQogICAgICogZGVsaW1pdGVycy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKi8KICAgIGxvZGFzaC50ZW1wbGF0ZVNldHRpbmdzID0gewoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gYmUgSFRNTC1lc2NhcGVkLgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2VzY2FwZSc6IC88JS0oW1xzXFNdKz8pJT4vZywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGRldGVjdCBjb2RlIHRvIGJlIGV2YWx1YXRlZC4KICAgICAgICoKICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncwogICAgICAgKiBAdHlwZSBSZWdFeHAKICAgICAgICovCiAgICAgICdldmFsdWF0ZSc6IC88JShbXHNcU10rPyklPi9nLAoKICAgICAgLyoqCiAgICAgICAqIFVzZWQgdG8gZGV0ZWN0IGBkYXRhYCBwcm9wZXJ0eSB2YWx1ZXMgdG8gaW5qZWN0LgogICAgICAgKgogICAgICAgKiBAbWVtYmVyT2YgXy50ZW1wbGF0ZVNldHRpbmdzCiAgICAgICAqIEB0eXBlIFJlZ0V4cAogICAgICAgKi8KICAgICAgJ2ludGVycG9sYXRlJzogcmVJbnRlcnBvbGF0ZSwKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIHJlZmVyZW5jZSB0aGUgZGF0YSBvYmplY3QgaW4gdGhlIHRlbXBsYXRlIHRleHQuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgc3RyaW5nCiAgICAgICAqLwogICAgICAndmFyaWFibGUnOiAnJywKCiAgICAgIC8qKgogICAgICAgKiBVc2VkIHRvIGltcG9ydCB2YXJpYWJsZXMgaW50byB0aGUgY29tcGlsZWQgdGVtcGxhdGUuCiAgICAgICAqCiAgICAgICAqIEBtZW1iZXJPZiBfLnRlbXBsYXRlU2V0dGluZ3MKICAgICAgICogQHR5cGUgT2JqZWN0CiAgICAgICAqLwogICAgICAnaW1wb3J0cyc6IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG1lbWJlck9mIF8udGVtcGxhdGVTZXR0aW5ncy5pbXBvcnRzCiAgICAgICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAgICAgKi8KICAgICAgICAnXyc6IGxvZGFzaAogICAgICB9CiAgICB9OwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY2xvbmVgIHdpdGhvdXQgYXJndW1lbnQganVnZ2xpbmcgb3Igc3VwcG9ydAogICAgICogZm9yIGB0aGlzQXJnYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjbG9uZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2RlZXA9ZmFsc2VdIFNwZWNpZnkgYSBkZWVwIGNsb25lLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNsb25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIEFzc29jaWF0ZXMgY2xvbmVzIHdpdGggc291cmNlIGNvdW50ZXJwYXJ0cy4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGJhc2VDbG9uZSh2YWx1ZSwgZGVlcCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKSB7CiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSk7CiAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGluc3BlY3QgW1tDbGFzc11dCiAgICAgIHZhciBpc09iaiA9IGlzT2JqZWN0KHZhbHVlKTsKICAgICAgaWYgKGlzT2JqKSB7CiAgICAgICAgdmFyIGNsYXNzTmFtZSA9IHRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgICAgIGlmICghY2xvbmVhYmxlQ2xhc3Nlc1tjbGFzc05hbWVdKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjdG9yID0gY3RvckJ5Q2xhc3NbY2xhc3NOYW1lXTsKICAgICAgICBzd2l0Y2ggKGNsYXNzTmFtZSkgewogICAgICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgICAgICBjYXNlIGRhdGVDbGFzczoKICAgICAgICAgICAgcmV0dXJuIG5ldyBjdG9yKCt2YWx1ZSk7CgogICAgICAgICAgY2FzZSBudW1iZXJDbGFzczoKICAgICAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgICAgIHJldHVybiBuZXcgY3Rvcih2YWx1ZSk7CgogICAgICAgICAgY2FzZSByZWdleHBDbGFzczoKICAgICAgICAgICAgcmVzdWx0ID0gY3Rvcih2YWx1ZS5zb3VyY2UsIHJlRmxhZ3MuZXhlYyh2YWx1ZSkpOwogICAgICAgICAgICByZXN1bHQubGFzdEluZGV4ID0gdmFsdWUubGFzdEluZGV4OwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgdmFyIGlzQXJyID0gaXNBcnJheSh2YWx1ZSk7CiAgICAgIGlmIChkZWVwKSB7CiAgICAgICAgLy8gY2hlY2sgZm9yIGNpcmN1bGFyIHJlZmVyZW5jZXMgYW5kIHJldHVybiBjb3JyZXNwb25kaW5nIGNsb25lCiAgICAgICAgdmFyIGluaXRlZFN0YWNrID0gIXN0YWNrQTsKICAgICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICAgIHN0YWNrQiB8fCAoc3RhY2tCID0gZ2V0QXJyYXkoKSk7CgogICAgICAgIHZhciBsZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKHN0YWNrQVtsZW5ndGhdID09IHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBzdGFja0JbbGVuZ3RoXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmVzdWx0ID0gaXNBcnIgPyBjdG9yKHZhbHVlLmxlbmd0aCkgOiB7fTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXN1bHQgPSBpc0FyciA/IHNsaWNlKHZhbHVlKSA6IGFzc2lnbih7fSwgdmFsdWUpOwogICAgICB9CiAgICAgIC8vIGFkZCBhcnJheSBwcm9wZXJ0aWVzIGFzc2lnbmVkIGJ5IGBSZWdFeHAjZXhlY2AKICAgICAgaWYgKGlzQXJyKSB7CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdpbmRleCcpKSB7CiAgICAgICAgICByZXN1bHQuaW5kZXggPSB2YWx1ZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsICdpbnB1dCcpKSB7CiAgICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZS5pbnB1dDsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gZXhpdCBmb3Igc2hhbGxvdyBjbG9uZQogICAgICBpZiAoIWRlZXApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGFkZCB0aGUgc291cmNlIHZhbHVlIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAvLyBhbmQgYXNzb2NpYXRlIGl0IHdpdGggaXRzIGNsb25lCiAgICAgIHN0YWNrQS5wdXNoKHZhbHVlKTsKICAgICAgc3RhY2tCLnB1c2gocmVzdWx0KTsKCiAgICAgIC8vIHJlY3Vyc2l2ZWx5IHBvcHVsYXRlIGNsb25lIChzdXNjZXB0aWJsZSB0byBjYWxsIHN0YWNrIGxpbWl0cykKICAgICAgKGlzQXJyID8gZm9yRWFjaCA6IGZvck93bikodmFsdWUsIGZ1bmN0aW9uKG9ialZhbHVlLCBrZXkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IGJhc2VDbG9uZShvYmpWYWx1ZSwgZGVlcCwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgfSk7CgogICAgICBpZiAoaW5pdGVkU3RhY2spIHsKICAgICAgICByZWxlYXNlQXJyYXkoc3RhY2tBKTsKICAgICAgICByZWxlYXNlQXJyYXkoc3RhY2tCKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uY3JlYXRlQ2FsbGJhY2tgIHdpdGhvdXQgc3VwcG9ydCBmb3IgY3JlYXRpbmcKICAgICAqICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2tzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IFtmdW5jPWlkZW50aXR5XSBUaGUgdmFsdWUgdG8gY29udmVydCB0byBhIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFthcmdDb3VudF0gVGhlIG51bWJlciBvZiBhcmd1bWVudHMgdGhlIGNhbGxiYWNrIGFjY2VwdHMuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgYSBjYWxsYmFjayBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KSB7CiAgICAgIGlmICh0eXBlb2YgZnVuYyAhPSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5OwogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgaXMgbm8gYHRoaXNBcmdgCiAgICAgIGlmICh0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBmdW5jOwogICAgICB9CiAgICAgIHZhciBiaW5kRGF0YSA9IGZ1bmMuX19iaW5kRGF0YV9fIHx8IChzdXBwb3J0LmZ1bmNOYW1lcyAmJiAhZnVuYy5uYW1lKTsKICAgICAgaWYgKHR5cGVvZiBiaW5kRGF0YSA9PSAndW5kZWZpbmVkJykgewogICAgICAgIHZhciBzb3VyY2UgPSByZVRoaXMgJiYgZm5Ub1N0cmluZy5jYWxsKGZ1bmMpOwogICAgICAgIGlmICghc3VwcG9ydC5mdW5jTmFtZXMgJiYgc291cmNlICYmICFyZUZ1bmNOYW1lLnRlc3Qoc291cmNlKSkgewogICAgICAgICAgYmluZERhdGEgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VwcG9ydC5mdW5jTmFtZXMgfHwgIWJpbmREYXRhKSB7CiAgICAgICAgICAvLyBjaGVja3MgaWYgYGZ1bmNgIHJlZmVyZW5jZXMgdGhlIGB0aGlzYCBrZXl3b3JkIGFuZCBzdG9yZXMgdGhlIHJlc3VsdAogICAgICAgICAgYmluZERhdGEgPSAhc3VwcG9ydC5mdW5jRGVjb21wIHx8IHJlVGhpcy50ZXN0KHNvdXJjZSk7CiAgICAgICAgICBzZXRCaW5kRGF0YShmdW5jLCBiaW5kRGF0YSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGV4aXQgZWFybHkgaWYgdGhlcmUgYXJlIG5vIGB0aGlzYCByZWZlcmVuY2VzIG9yIGBmdW5jYCBpcyBib3VuZAogICAgICBpZiAoYmluZERhdGEgIT09IHRydWUgJiYgKGJpbmREYXRhICYmIGJpbmREYXRhWzFdICYgMSkpIHsKICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgfQogICAgICBzd2l0Y2ggKGFyZ0NvdW50KSB7CiAgICAgICAgY2FzZSAxOiByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmNhbGwodGhpc0FyZywgdmFsdWUpOwogICAgICAgIH07CiAgICAgICAgY2FzZSAyOiByZXR1cm4gZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhLCBiKTsKICAgICAgICB9OwogICAgICAgIGNhc2UgMzogcmV0dXJuIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCB2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICAgIH07CiAgICAgICAgY2FzZSA0OiByZXR1cm4gZnVuY3Rpb24oYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbCh0aGlzQXJnLCBhY2N1bXVsYXRvciwgdmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiBiaW5kKGZ1bmMsIHRoaXNBcmcpOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8uZmxhdHRlbmAgd2l0aG91dCBzdXBwb3J0IGZvciBjYWxsYmFjawogICAgICogc2hvcnRoYW5kcyBvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NoYWxsb3c9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGEgc2luZ2xlIGxldmVsLgogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNBcmdBcnJheXM9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGFycmF5cyBhbmQgYGFyZ3VtZW50c2Agb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzdGFydCBmcm9tLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgICAqLwogICAgZnVuY3Rpb24gYmFzZUZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdywgaXNBcmdBcnJheXMsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAoZnJvbUluZGV4IHx8IDApIC0gMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJwogICAgICAgICAgICAmJiAoaXNBcnJheSh2YWx1ZSkgfHwgaXNBcmd1bWVudHModmFsdWUpKSkgewogICAgICAgICAgLy8gcmVjdXJzaXZlbHkgZmxhdHRlbiBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgdmFsdWUgPSBiYXNlRmxhdHRlbih2YWx1ZSwgaXNTaGFsbG93LCBpc0FyZ0FycmF5cyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsSW5kZXggPSAtMSwKICAgICAgICAgICAgICB2YWxMZW5ndGggPSB2YWx1ZS5sZW5ndGgsCiAgICAgICAgICAgICAgcmVzSW5kZXggPSByZXN1bHQubGVuZ3RoOwoKICAgICAgICAgIHJlc3VsdC5sZW5ndGggKz0gdmFsTGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsrdmFsSW5kZXggPCB2YWxMZW5ndGgpIHsKICAgICAgICAgICAgcmVzdWx0W3Jlc0luZGV4KytdID0gdmFsdWVbdmFsSW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIWlzQXJnQXJyYXlzKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgYmFzZSBpbXBsZW1lbnRhdGlvbiBvZiBgXy5pc0VxdWFsYCwgd2l0aG91dCBzdXBwb3J0IGZvciBgdGhpc0FyZ2AgYmluZGluZywKICAgICAqIHRoYXQgYWxsb3dzIHBhcnRpYWwgIl8ud2hlcmUiIHN0eWxlIGNvbXBhcmlzb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IGEgVGhlIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0geyp9IGIgVGhlIG90aGVyIHZhbHVlIHRvIGNvbXBhcmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY29tcGFyaW5nIHZhbHVlcy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtpc1doZXJlPWZhbHNlXSBBIGZsYWcgdG8gaW5kaWNhdGUgcGVyZm9ybWluZyBwYXJ0aWFsIGNvbXBhcmlzb25zLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQT1bXV0gVHJhY2tzIHRyYXZlcnNlZCBgYWAgb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7QXJyYXl9IFtzdGFja0I9W11dIFRyYWNrcyB0cmF2ZXJzZWQgYGJgIG9iamVjdHMuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHZhbHVlcyBhcmUgZXF1aXZhbGVudCwgZWxzZSBgZmFsc2VgLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlSXNFcXVhbChhLCBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpIHsKICAgICAgLy8gdXNlZCB0byBpbmRpY2F0ZSB0aGF0IHdoZW4gY29tcGFyaW5nIG9iamVjdHMsIGBhYCBoYXMgYXQgbGVhc3QgdGhlIHByb3BlcnRpZXMgb2YgYGJgCiAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgIHZhciByZXN1bHQgPSBjYWxsYmFjayhhLCBiKTsKICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgcmV0dXJuICEhcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgICAvLyBleGl0IGVhcmx5IGZvciBpZGVudGljYWwgdmFsdWVzCiAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgLy8gdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICByZXR1cm4gYSAhPT0gMCB8fCAoMSAvIGEgPT0gMSAvIGIpOwogICAgICB9CiAgICAgIHZhciB0eXBlID0gdHlwZW9mIGEsCiAgICAgICAgICBvdGhlclR5cGUgPSB0eXBlb2YgYjsKCiAgICAgIC8vIGV4aXQgZWFybHkgZm9yIHVubGlrZSBwcmltaXRpdmUgdmFsdWVzCiAgICAgIGlmIChhID09PSBhICYmCiAgICAgICAgICAhKGEgJiYgb2JqZWN0VHlwZXNbdHlwZV0pICYmCiAgICAgICAgICAhKGIgJiYgb2JqZWN0VHlwZXNbb3RoZXJUeXBlXSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gZXhpdCBlYXJseSBmb3IgYG51bGxgIGFuZCBgdW5kZWZpbmVkYCBhdm9pZGluZyBFUzMncyBGdW5jdGlvbiNjYWxsIGJlaGF2aW9yCiAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMy40LjQKICAgICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHsKICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgfQogICAgICAvLyBjb21wYXJlIFtbQ2xhc3NdXSBuYW1lcwogICAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKSwKICAgICAgICAgIG90aGVyQ2xhc3MgPSB0b1N0cmluZy5jYWxsKGIpOwoKICAgICAgaWYgKGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MpIHsKICAgICAgICBjbGFzc05hbWUgPSBvYmplY3RDbGFzczsKICAgICAgfQogICAgICBpZiAob3RoZXJDbGFzcyA9PSBhcmdzQ2xhc3MpIHsKICAgICAgICBvdGhlckNsYXNzID0gb2JqZWN0Q2xhc3M7CiAgICAgIH0KICAgICAgaWYgKGNsYXNzTmFtZSAhPSBvdGhlckNsYXNzKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CiAgICAgICAgY2FzZSBib29sQ2xhc3M6CiAgICAgICAgY2FzZSBkYXRlQ2xhc3M6CiAgICAgICAgICAvLyBjb2VyY2UgZGF0ZXMgYW5kIGJvb2xlYW5zIHRvIG51bWJlcnMsIGRhdGVzIHRvIG1pbGxpc2Vjb25kcyBhbmQgYm9vbGVhbnMKICAgICAgICAgIC8vIHRvIGAxYCBvciBgMGAgdHJlYXRpbmcgaW52YWxpZCBkYXRlcyBjb2VyY2VkIHRvIGBOYU5gIGFzIG5vdCBlcXVhbAogICAgICAgICAgcmV0dXJuICthID09ICtiOwoKICAgICAgICBjYXNlIG51bWJlckNsYXNzOgogICAgICAgICAgLy8gdHJlYXQgYE5hTmAgdnMuIGBOYU5gIGFzIGVxdWFsCiAgICAgICAgICByZXR1cm4gKGEgIT0gK2EpCiAgICAgICAgICAgID8gYiAhPSArYgogICAgICAgICAgICAvLyBidXQgdHJlYXQgYCswYCB2cy4gYC0wYCBhcyBub3QgZXF1YWwKICAgICAgICAgICAgOiAoYSA9PSAwID8gKDEgLyBhID09IDEgLyBiKSA6IGEgPT0gK2IpOwoKICAgICAgICBjYXNlIHJlZ2V4cENsYXNzOgogICAgICAgIGNhc2Ugc3RyaW5nQ2xhc3M6CiAgICAgICAgICAvLyBjb2VyY2UgcmVnZXhlcyB0byBzdHJpbmdzIChodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjEwLjYuNCkKICAgICAgICAgIC8vIHRyZWF0IHN0cmluZyBwcmltaXRpdmVzIGFuZCB0aGVpciBjb3JyZXNwb25kaW5nIG9iamVjdCBpbnN0YW5jZXMgYXMgZXF1YWwKICAgICAgICAgIHJldHVybiBhID09IFN0cmluZyhiKTsKICAgICAgfQogICAgICB2YXIgaXNBcnIgPSBjbGFzc05hbWUgPT0gYXJyYXlDbGFzczsKICAgICAgaWYgKCFpc0FycikgewogICAgICAgIC8vIHVud3JhcCBhbnkgYGxvZGFzaGAgd3JhcHBlZCB2YWx1ZXMKICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCAnX193cmFwcGVkX18gJykgfHwgaGFzT3duUHJvcGVydHkuY2FsbChiLCAnX193cmFwcGVkX18nKSkgewogICAgICAgICAgcmV0dXJuIGJhc2VJc0VxdWFsKGEuX193cmFwcGVkX18gfHwgYSwgYi5fX3dyYXBwZWRfXyB8fCBiLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpOwogICAgICAgIH0KICAgICAgICAvLyBleGl0IGZvciBmdW5jdGlvbnMgYW5kIERPTSBub2RlcwogICAgICAgIGlmIChjbGFzc05hbWUgIT0gb2JqZWN0Q2xhc3MpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgLy8gaW4gb2xkZXIgdmVyc2lvbnMgb2YgT3BlcmEsIGBhcmd1bWVudHNgIG9iamVjdHMgaGF2ZSBgQXJyYXlgIGNvbnN0cnVjdG9ycwogICAgICAgIHZhciBjdG9yQSA9IGEuY29uc3RydWN0b3IsCiAgICAgICAgICAgIGN0b3JCID0gYi5jb25zdHJ1Y3RvcjsKCiAgICAgICAgLy8gbm9uIGBPYmplY3RgIG9iamVjdCBpbnN0YW5jZXMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1YWwKICAgICAgICBpZiAoY3RvckEgIT0gY3RvckIgJiYgISgKICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGN0b3JBKSAmJiBjdG9yQSBpbnN0YW5jZW9mIGN0b3JBICYmCiAgICAgICAgICAgICAgaXNGdW5jdGlvbihjdG9yQikgJiYgY3RvckIgaW5zdGFuY2VvZiBjdG9yQgogICAgICAgICAgICApKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vIGFzc3VtZSBjeWNsaWMgc3RydWN0dXJlcyBhcmUgZXF1YWwKICAgICAgLy8gdGhlIGFsZ29yaXRobSBmb3IgZGV0ZWN0aW5nIGN5Y2xpYyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEKICAgICAgLy8gc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYCAoaHR0cDovL2VzNS5naXRodWIuaW8vI3gxNS4xMi4zKQogICAgICB2YXIgaW5pdGVkU3RhY2sgPSAhc3RhY2tBOwogICAgICBzdGFja0EgfHwgKHN0YWNrQSA9IGdldEFycmF5KCkpOwogICAgICBzdGFja0IgfHwgKHN0YWNrQiA9IGdldEFycmF5KCkpOwoKICAgICAgdmFyIGxlbmd0aCA9IHN0YWNrQS5sZW5ndGg7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmIChzdGFja0FbbGVuZ3RoXSA9PSBhKSB7CiAgICAgICAgICByZXR1cm4gc3RhY2tCW2xlbmd0aF0gPT0gYjsKICAgICAgICB9CiAgICAgIH0KICAgICAgdmFyIHNpemUgPSAwOwogICAgICByZXN1bHQgPSB0cnVlOwoKICAgICAgLy8gYWRkIGBhYCBhbmQgYGJgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICBzdGFja0EucHVzaChhKTsKICAgICAgc3RhY2tCLnB1c2goYik7CgogICAgICAvLyByZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cyAoc3VzY2VwdGlibGUgdG8gY2FsbCBzdGFjayBsaW1pdHMpCiAgICAgIGlmIChpc0FycikgewogICAgICAgIGxlbmd0aCA9IGEubGVuZ3RoOwogICAgICAgIHNpemUgPSBiLmxlbmd0aDsKCiAgICAgICAgLy8gY29tcGFyZSBsZW5ndGhzIHRvIGRldGVybWluZSBpZiBhIGRlZXAgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkKICAgICAgICByZXN1bHQgPSBzaXplID09IGEubGVuZ3RoOwogICAgICAgIGlmICghcmVzdWx0ICYmICFpc1doZXJlKSB7CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICAvLyBkZWVwIGNvbXBhcmUgdGhlIGNvbnRlbnRzLCBpZ25vcmluZyBub24tbnVtZXJpYyBwcm9wZXJ0aWVzCiAgICAgICAgd2hpbGUgKHNpemUtLSkgewogICAgICAgICAgdmFyIGluZGV4ID0gbGVuZ3RoLAogICAgICAgICAgICAgIHZhbHVlID0gYltzaXplXTsKCiAgICAgICAgICBpZiAoaXNXaGVyZSkgewogICAgICAgICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgICAgICAgIGlmICgocmVzdWx0ID0gYmFzZUlzRXF1YWwoYVtpbmRleF0sIHZhbHVlLCBjYWxsYmFjaywgaXNXaGVyZSwgc3RhY2tBLCBzdGFja0IpKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwoYVtzaXplXSwgdmFsdWUsIGNhbGxiYWNrLCBpc1doZXJlLCBzdGFja0EsIHN0YWNrQikpKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIC8vIGRlZXAgY29tcGFyZSBvYmplY3RzIHVzaW5nIGBmb3JJbmAsIGluc3RlYWQgb2YgYGZvck93bmAsIHRvIGF2b2lkIGBPYmplY3Qua2V5c2AKICAgICAgLy8gd2hpY2gsIGluIHRoaXMgY2FzZSwgaXMgbW9yZSBjb3N0bHkKICAgICAgZm9ySW4oYiwgZnVuY3Rpb24odmFsdWUsIGtleSwgYikgewogICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGIsIGtleSkpIHsKICAgICAgICAgIC8vIGNvdW50IHRoZSBudW1iZXIgb2YgcHJvcGVydGllcy4KICAgICAgICAgIHNpemUrKzsKICAgICAgICAgIC8vIGRlZXAgY29tcGFyZSBlYWNoIHByb3BlcnR5IHZhbHVlLgogICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSBoYXNPd25Qcm9wZXJ0eS5jYWxsKGEsIGtleSkgJiYgYmFzZUlzRXF1YWwoYVtrZXldLCB2YWx1ZSwgY2FsbGJhY2ssIGlzV2hlcmUsIHN0YWNrQSwgc3RhY2tCKSk7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmIChyZXN1bHQgJiYgIWlzV2hlcmUpIHsKICAgICAgICAvLyBlbnN1cmUgYm90aCBvYmplY3RzIGhhdmUgdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMKICAgICAgICBmb3JJbihhLCBmdW5jdGlvbih2YWx1ZSwga2V5LCBhKSB7CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChhLCBrZXkpKSB7CiAgICAgICAgICAgIC8vIGBzaXplYCB3aWxsIGJlIGAtMWAgaWYgYGFgIGhhcyBtb3JlIHByb3BlcnRpZXMgdGhhbiBgYmAKICAgICAgICAgICAgcmV0dXJuIChyZXN1bHQgPSAtLXNpemUgPiAtMSk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGluaXRlZFN0YWNrKSB7CiAgICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQSk7CiAgICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQik7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFRoZSBiYXNlIGltcGxlbWVudGF0aW9uIG9mIGBfLm1lcmdlYCB3aXRob3V0IGFyZ3VtZW50IGp1Z2dsaW5nIG9yIHN1cHBvcnQKICAgICAqIGZvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHtPYmplY3R9IHNvdXJjZSBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBtZXJnaW5nIHByb3BlcnRpZXMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc3RhY2tBPVtdXSBUcmFja3MgdHJhdmVyc2VkIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtBcnJheX0gW3N0YWNrQj1bXV0gQXNzb2NpYXRlcyB2YWx1ZXMgd2l0aCBzb3VyY2UgY291bnRlcnBhcnRzLgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlTWVyZ2Uob2JqZWN0LCBzb3VyY2UsIGNhbGxiYWNrLCBzdGFja0EsIHN0YWNrQikgewogICAgICAoaXNBcnJheShzb3VyY2UpID8gZm9yRWFjaCA6IGZvck93bikoc291cmNlLCBmdW5jdGlvbihzb3VyY2UsIGtleSkgewogICAgICAgIHZhciBmb3VuZCwKICAgICAgICAgICAgaXNBcnIsCiAgICAgICAgICAgIHJlc3VsdCA9IHNvdXJjZSwKICAgICAgICAgICAgdmFsdWUgPSBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKHNvdXJjZSAmJiAoKGlzQXJyID0gaXNBcnJheShzb3VyY2UpKSB8fCBpc1BsYWluT2JqZWN0KHNvdXJjZSkpKSB7CiAgICAgICAgICAvLyBhdm9pZCBtZXJnaW5nIHByZXZpb3VzbHkgbWVyZ2VkIGN5Y2xpYyBzb3VyY2VzCiAgICAgICAgICB2YXIgc3RhY2tMZW5ndGggPSBzdGFja0EubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKHN0YWNrTGVuZ3RoLS0pIHsKICAgICAgICAgICAgaWYgKChmb3VuZCA9IHN0YWNrQVtzdGFja0xlbmd0aF0gPT0gc291cmNlKSkgewogICAgICAgICAgICAgIHZhbHVlID0gc3RhY2tCW3N0YWNrTGVuZ3RoXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgICB2YXIgaXNTaGFsbG93OwogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjayh2YWx1ZSwgc291cmNlKTsKICAgICAgICAgICAgICBpZiAoKGlzU2hhbGxvdyA9IHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpKSB7CiAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpc1NoYWxsb3cpIHsKICAgICAgICAgICAgICB2YWx1ZSA9IGlzQXJyCiAgICAgICAgICAgICAgICA/IChpc0FycmF5KHZhbHVlKSA/IHZhbHVlIDogW10pCiAgICAgICAgICAgICAgICA6IChpc1BsYWluT2JqZWN0KHZhbHVlKSA/IHZhbHVlIDoge30pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGFkZCBgc291cmNlYCBhbmQgYXNzb2NpYXRlZCBgdmFsdWVgIHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cwogICAgICAgICAgICBzdGFja0EucHVzaChzb3VyY2UpOwogICAgICAgICAgICBzdGFja0IucHVzaCh2YWx1ZSk7CgogICAgICAgICAgICAvLyByZWN1cnNpdmVseSBtZXJnZSBvYmplY3RzIGFuZCBhcnJheXMgKHN1c2NlcHRpYmxlIHRvIGNhbGwgc3RhY2sgbGltaXRzKQogICAgICAgICAgICBpZiAoIWlzU2hhbGxvdykgewogICAgICAgICAgICAgIGJhc2VNZXJnZSh2YWx1ZSwgc291cmNlLCBjYWxsYmFjaywgc3RhY2tBLCBzdGFja0IpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBzb3VyY2UpOwogICAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgIHJlc3VsdCA9IHNvdXJjZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgdmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9iamVjdFtrZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGJhc2UgaW1wbGVtZW50YXRpb24gb2YgYF8udW5pcWAgd2l0aG91dCBzdXBwb3J0IGZvciBjYWxsYmFjayBzaG9ydGhhbmRzCiAgICAgKiBvciBgdGhpc0FyZ2AgYmluZGluZy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYGFycmF5YCBpcyBzb3J0ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIGFycmF5LgogICAgICovCiAgICBmdW5jdGlvbiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgdmFyIGlzTGFyZ2UgPSAhaXNTb3J0ZWQgJiYgbGVuZ3RoID49IGxhcmdlQXJyYXlTaXplICYmIGluZGV4T2YgPT09IGJhc2VJbmRleE9mLAogICAgICAgICAgc2VlbiA9IChjYWxsYmFjayB8fCBpc0xhcmdlKSA/IGdldEFycmF5KCkgOiByZXN1bHQ7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBjYWNoZSA9IGNyZWF0ZUNhY2hlKHNlZW4pOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgaW5kZXhPZiA9IGNhY2hlSW5kZXhPZjsKICAgICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgICAgc2VlbiA9IGNhbGxiYWNrID8gc2VlbiA6IChyZWxlYXNlQXJyYXkoc2VlbiksIHJlc3VsdCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdLAogICAgICAgICAgICBjb21wdXRlZCA9IGNhbGxiYWNrID8gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBhcnJheSkgOiB2YWx1ZTsKCiAgICAgICAgaWYgKGlzU29ydGVkCiAgICAgICAgICAgICAgPyAhaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSBjb21wdXRlZAogICAgICAgICAgICAgIDogaW5kZXhPZihzZWVuLCBjb21wdXRlZCkgPCAwCiAgICAgICAgICAgICkgewogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGlzTGFyZ2UpIHsKICAgICAgICAgICAgc2Vlbi5wdXNoKGNvbXB1dGVkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzTGFyZ2UpIHsKICAgICAgICByZWxlYXNlQXJyYXkoc2Vlbi5hcnJheSk7CiAgICAgICAgcmVsZWFzZU9iamVjdChzZWVuKTsKICAgICAgfSBlbHNlIGlmIChjYWxsYmFjaykgewogICAgICAgIHJlbGVhc2VBcnJheShzZWVuKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgYWdncmVnYXRlcyBhIGNvbGxlY3Rpb24sIGNyZWF0aW5nIGFuIG9iamVjdCBjb21wb3NlZAogICAgICogb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nIGVhY2ggZWxlbWVudCBvZiB0aGUgY29sbGVjdGlvbgogICAgICogdGhyb3VnaCBhIGNhbGxiYWNrLiBUaGUgZ2l2ZW4gYHNldHRlcmAgZnVuY3Rpb24gc2V0cyB0aGUga2V5cyBhbmQgdmFsdWVzCiAgICAgKiBvZiB0aGUgY29tcG9zZWQgb2JqZWN0LgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBzZXR0ZXIgVGhlIHNldHRlciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGFnZ3JlZ2F0b3IgZnVuY3Rpb24uCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUFnZ3JlZ2F0b3Ioc2V0dGVyKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAgIHZhciByZXN1bHQgPSB7fTsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICAgIHNldHRlcihyZXN1bHQsIHZhbHVlLCBjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pLCBjb2xsZWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgc2V0dGVyKHJlc3VsdCwgdmFsdWUsIGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pLCBjb2xsZWN0aW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBlaXRoZXIgY3VycmllcyBvciBpbnZva2VzIGBmdW5jYAogICAgICogd2l0aCBhbiBvcHRpb25hbCBgdGhpc2AgYmluZGluZyBhbmQgcGFydGlhbGx5IGFwcGxpZWQgYXJndW1lbnRzLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gZnVuYyBUaGUgZnVuY3Rpb24gb3IgbWV0aG9kIG5hbWUgdG8gcmVmZXJlbmNlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGJpdG1hc2sgVGhlIGJpdG1hc2sgb2YgbWV0aG9kIGZsYWdzIHRvIGNvbXBvc2UuCiAgICAgKiAgVGhlIGJpdG1hc2sgbWF5IGJlIGNvbXBvc2VkIG9mIHRoZSBmb2xsb3dpbmcgZmxhZ3M6CiAgICAgKiAgMSAtIGBfLmJpbmRgCiAgICAgKiAgMiAtIGBfLmJpbmRLZXlgCiAgICAgKiAgNCAtIGBfLmN1cnJ5YAogICAgICogIDggLSBgXy5jdXJyeWAgKGJvdW5kKQogICAgICogIDE2IC0gYF8ucGFydGlhbGAKICAgICAqICAzMiAtIGBfLnBhcnRpYWxSaWdodGAKICAgICAqIEBwYXJhbSB7QXJyYXl9IFtwYXJ0aWFsQXJnc10gQW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIHByZXBlbmQgdG8gdGhvc2UKICAgICAqICBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHtBcnJheX0gW3BhcnRpYWxSaWdodEFyZ3NdIEFuIGFycmF5IG9mIGFyZ3VtZW50cyB0byBhcHBlbmQgdG8gdGhvc2UKICAgICAqICBwcm92aWRlZCB0byB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBmdW5jYC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHldIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQm91bmQoZnVuYywgYml0bWFzaywgcGFydGlhbEFyZ3MsIHBhcnRpYWxSaWdodEFyZ3MsIHRoaXNBcmcsIGFyaXR5KSB7CiAgICAgIHZhciBpc0JpbmQgPSBiaXRtYXNrICYgMSwKICAgICAgICAgIGlzQmluZEtleSA9IGJpdG1hc2sgJiAyLAogICAgICAgICAgaXNDdXJyeSA9IGJpdG1hc2sgJiA0LAogICAgICAgICAgaXNDdXJyeUJvdW5kID0gYml0bWFzayAmIDgsCiAgICAgICAgICBpc1BhcnRpYWwgPSBiaXRtYXNrICYgMTYsCiAgICAgICAgICBpc1BhcnRpYWxSaWdodCA9IGJpdG1hc2sgJiAzMiwKICAgICAgICAgIGtleSA9IGZ1bmM7CgogICAgICBpZiAoIWlzQmluZEtleSAmJiAhaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgaWYgKGlzUGFydGlhbCAmJiAhcGFydGlhbEFyZ3MubGVuZ3RoKSB7CiAgICAgICAgYml0bWFzayAmPSB+MTY7CiAgICAgICAgaXNQYXJ0aWFsID0gcGFydGlhbEFyZ3MgPSBmYWxzZTsKICAgICAgfQogICAgICBpZiAoaXNQYXJ0aWFsUmlnaHQgJiYgIXBhcnRpYWxSaWdodEFyZ3MubGVuZ3RoKSB7CiAgICAgICAgYml0bWFzayAmPSB+MzI7CiAgICAgICAgaXNQYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHRBcmdzID0gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIGJpbmREYXRhID0gZnVuYyAmJiBmdW5jLl9fYmluZERhdGFfXzsKICAgICAgaWYgKGJpbmREYXRhKSB7CiAgICAgICAgaWYgKGlzQmluZCAmJiAhKGJpbmREYXRhWzFdICYgMSkpIHsKICAgICAgICAgIGJpbmREYXRhWzRdID0gdGhpc0FyZzsKICAgICAgICB9CiAgICAgICAgaWYgKCFpc0JpbmQgJiYgYmluZERhdGFbMV0gJiAxKSB7CiAgICAgICAgICBiaXRtYXNrIHw9IDg7CiAgICAgICAgfQogICAgICAgIGlmIChpc0N1cnJ5ICYmICEoYmluZERhdGFbMV0gJiA0KSkgewogICAgICAgICAgYmluZERhdGFbNV0gPSBhcml0eTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgcHVzaC5hcHBseShiaW5kRGF0YVsyXSB8fCAoYmluZERhdGFbMl0gPSBbXSksIHBhcnRpYWxBcmdzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUGFydGlhbFJpZ2h0KSB7CiAgICAgICAgICBwdXNoLmFwcGx5KGJpbmREYXRhWzNdIHx8IChiaW5kRGF0YVszXSA9IFtdKSwgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgfQogICAgICAgIGJpbmREYXRhWzFdIHw9IGJpdG1hc2s7CiAgICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kLmFwcGx5KG51bGwsIGJpbmREYXRhKTsKICAgICAgfQogICAgICAvLyB1c2UgYEZ1bmN0aW9uI2JpbmRgIGlmIGl0IGV4aXN0cyBhbmQgaXMgZmFzdAogICAgICAvLyAoaW4gVjggYEZ1bmN0aW9uI2JpbmRgIGlzIHNsb3dlciBleGNlcHQgd2hlbiBwYXJ0aWFsbHkgYXBwbGllZCkKICAgICAgaWYgKGlzQmluZCAmJiAhKGlzQmluZEtleSB8fCBpc0N1cnJ5IHx8IGlzUGFydGlhbFJpZ2h0KSAmJgogICAgICAgICAgKHN1cHBvcnQuZmFzdEJpbmQgfHwgKG5hdGl2ZUJpbmQgJiYgaXNQYXJ0aWFsKSkpIHsKICAgICAgICBpZiAoaXNQYXJ0aWFsKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFt0aGlzQXJnXTsKICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgcGFydGlhbEFyZ3MpOwogICAgICAgIH0KICAgICAgICB2YXIgYm91bmQgPSBpc1BhcnRpYWwKICAgICAgICAgID8gbmF0aXZlQmluZC5hcHBseShmdW5jLCBhcmdzKQogICAgICAgICAgOiBuYXRpdmVCaW5kLmNhbGwoZnVuYywgdGhpc0FyZyk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIC8vIGBGdW5jdGlvbiNiaW5kYCBzcGVjCiAgICAgICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDE1LjMuNC41CiAgICAgICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgICAgICB0aGlzQmluZGluZyA9IGlzQmluZCA/IHRoaXNBcmcgOiB0aGlzOwoKICAgICAgICAgIGlmIChpc0N1cnJ5IHx8IGlzUGFydGlhbCB8fCBpc1BhcnRpYWxSaWdodCkgewogICAgICAgICAgICBhcmdzID0gbmF0aXZlU2xpY2UuY2FsbChhcmdzKTsKICAgICAgICAgICAgaWYgKGlzUGFydGlhbCkgewogICAgICAgICAgICAgIHVuc2hpZnQuYXBwbHkoYXJncywgcGFydGlhbEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1BhcnRpYWxSaWdodCkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgcGFydGlhbFJpZ2h0QXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VycnkgJiYgYXJncy5sZW5ndGggPCBhcml0eSkgewogICAgICAgICAgICAgIGJpdG1hc2sgfD0gMTYgJiB+MzI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIChpc0N1cnJ5Qm91bmQgPyBiaXRtYXNrIDogYml0bWFzayAmIH4zKSwgYXJncywgbnVsbCwgdGhpc0FyZywgYXJpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNCaW5kS2V5KSB7CiAgICAgICAgICAgIGZ1bmMgPSB0aGlzQmluZGluZ1trZXldOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBib3VuZCkgewogICAgICAgICAgICAvLyBlbnN1cmUgYG5ldyBib3VuZGAgaXMgYW4gaW5zdGFuY2Ugb2YgYGZ1bmNgCiAgICAgICAgICAgIHRoaXNCaW5kaW5nID0gY3JlYXRlT2JqZWN0KGZ1bmMucHJvdG90eXBlKTsKCiAgICAgICAgICAgIC8vIG1pbWljIHRoZSBjb25zdHJ1Y3RvcidzIGByZXR1cm5gIGJlaGF2aW9yCiAgICAgICAgICAgIC8vIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTMuMi4yCiAgICAgICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIGlzT2JqZWN0KHJlc3VsdCkgPyByZXN1bHQgOiB0aGlzQmluZGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXNCaW5kaW5nLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIHNldEJpbmREYXRhKGJvdW5kLCBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cykpOwogICAgICByZXR1cm4gYm91bmQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IG9iamVjdCB3aXRoIHRoZSBzcGVjaWZpZWQgYHByb3RvdHlwZWAuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwcm90b3R5cGUgVGhlIHByb3RvdHlwZSBvYmplY3QuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBuZXcgb2JqZWN0LgogICAgICovCiAgICBmdW5jdGlvbiBjcmVhdGVPYmplY3QocHJvdG90eXBlKSB7CiAgICAgIHJldHVybiBpc09iamVjdChwcm90b3R5cGUpID8gbmF0aXZlQ3JlYXRlKHByb3RvdHlwZSkgOiB7fTsKICAgIH0KICAgIC8vIGZhbGxiYWNrIGZvciBicm93c2VycyB3aXRob3V0IGBPYmplY3QuY3JlYXRlYAogICAgaWYgKCFuYXRpdmVDcmVhdGUpIHsKICAgICAgY3JlYXRlT2JqZWN0ID0gZnVuY3Rpb24ocHJvdG90eXBlKSB7CiAgICAgICAgaWYgKGlzT2JqZWN0KHByb3RvdHlwZSkpIHsKICAgICAgICAgIG5vb3AucHJvdG90eXBlID0gcHJvdG90eXBlOwogICAgICAgICAgdmFyIHJlc3VsdCA9IG5ldyBub29wOwogICAgICAgICAgbm9vcC5wcm90b3R5cGUgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0IHx8IHt9OwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogVXNlZCBieSBgZXNjYXBlYCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllcy4KICAgICAqCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IG1hdGNoIFRoZSBtYXRjaGVkIGNoYXJhY3RlciB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIGNoYXJhY3Rlci4KICAgICAqLwogICAgZnVuY3Rpb24gZXNjYXBlSHRtbENoYXIobWF0Y2gpIHsKICAgICAgcmV0dXJuIGh0bWxFc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIGFwcHJvcHJpYXRlICJpbmRleE9mIiBmdW5jdGlvbi4gSWYgdGhlIGBfLmluZGV4T2ZgIG1ldGhvZCBpcwogICAgICogY3VzdG9taXplZCwgdGhpcyBtZXRob2QgcmV0dXJucyB0aGUgY3VzdG9tIG1ldGhvZCwgb3RoZXJ3aXNlIGl0IHJldHVybnMKICAgICAqIHRoZSBgYmFzZUluZGV4T2ZgIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlICJpbmRleE9mIiBmdW5jdGlvbi4KICAgICAqLwogICAgZnVuY3Rpb24gZ2V0SW5kZXhPZigpIHsKICAgICAgdmFyIHJlc3VsdCA9IChyZXN1bHQgPSBsb2Rhc2guaW5kZXhPZikgPT09IGluZGV4T2YgPyBiYXNlSW5kZXhPZiA6IHJlc3VsdDsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFNldHMgYHRoaXNgIGJpbmRpbmcgZGF0YSBvbiBhIGdpdmVuIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBzZXQgZGF0YSBvbi4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC4KICAgICAqLwogICAgdmFyIHNldEJpbmREYXRhID0gIWRlZmluZVByb3BlcnR5ID8gbm9vcCA6IGZ1bmN0aW9uKGZ1bmMsIHZhbHVlKSB7CiAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSB2YWx1ZTsKICAgICAgZGVmaW5lUHJvcGVydHkoZnVuYywgJ19fYmluZERhdGFfXycsIGRlc2NyaXB0b3IpOwogICAgfTsKCiAgICAvKioKICAgICAqIEEgZmFsbGJhY2sgaW1wbGVtZW50YXRpb24gb2YgYGlzUGxhaW5PYmplY3RgIHdoaWNoIGNoZWNrcyBpZiBhIGdpdmVuIHZhbHVlCiAgICAgKiBpcyBhbiBvYmplY3QgY3JlYXRlZCBieSB0aGUgYE9iamVjdGAgY29uc3RydWN0b3IsIGFzc3VtaW5nIG9iamVjdHMgY3JlYXRlZAogICAgICogYnkgdGhlIGBPYmplY3RgIGNvbnN0cnVjdG9yIGhhdmUgbm8gaW5oZXJpdGVkIGVudW1lcmFibGUgcHJvcGVydGllcyBhbmQgdGhhdAogICAgICogdGhlcmUgYXJlIG5vIGBPYmplY3QucHJvdG90eXBlYCBleHRlbnNpb25zLgogICAgICoKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBgdmFsdWVgIGlzIGEgcGxhaW4gb2JqZWN0LCBlbHNlIGBmYWxzZWAuCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNoaW1Jc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICAgIHZhciBjdG9yLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgLy8gYXZvaWQgbm9uIE9iamVjdCBvYmplY3RzLCBgYXJndW1lbnRzYCBvYmplY3RzLCBhbmQgRE9NIGVsZW1lbnRzCiAgICAgIGlmICghKHZhbHVlICYmIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IG9iamVjdENsYXNzKSB8fAogICAgICAgICAgKGN0b3IgPSB2YWx1ZS5jb25zdHJ1Y3RvciwgaXNGdW5jdGlvbihjdG9yKSAmJiAhKGN0b3IgaW5zdGFuY2VvZiBjdG9yKSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgLy8gSW4gbW9zdCBlbnZpcm9ubWVudHMgYW4gb2JqZWN0J3Mgb3duIHByb3BlcnRpZXMgYXJlIGl0ZXJhdGVkIGJlZm9yZQogICAgICAvLyBpdHMgaW5oZXJpdGVkIHByb3BlcnRpZXMuIElmIHRoZSBsYXN0IGl0ZXJhdGVkIHByb3BlcnR5IGlzIGFuIG9iamVjdCdzCiAgICAgIC8vIG93biBwcm9wZXJ0eSB0aGVuIHRoZXJlIGFyZSBubyBpbmhlcml0ZWQgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLgogICAgICBmb3JJbih2YWx1ZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0eXBlb2YgcmVzdWx0ID09ICd1bmRlZmluZWQnIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIHJlc3VsdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VkIGJ5IGB1bmVzY2FwZWAgdG8gY29udmVydCBIVE1MIGVudGl0aWVzIHRvIGNoYXJhY3RlcnMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtYXRjaCBUaGUgbWF0Y2hlZCBjaGFyYWN0ZXIgdG8gdW5lc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgY2hhcmFjdGVyLgogICAgICovCiAgICBmdW5jdGlvbiB1bmVzY2FwZUh0bWxDaGFyKG1hdGNoKSB7CiAgICAgIHJldHVybiBodG1sVW5lc2NhcGVzW21hdGNoXTsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGBhcmd1bWVudHNgIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAoZnVuY3Rpb24oKSB7IHJldHVybiBfLmlzQXJndW1lbnRzKGFyZ3VtZW50cyk7IH0pKDEsIDIsIDMpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNBcmd1bWVudHMoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJyAmJgogICAgICAgIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFyZ3NDbGFzcyB8fCBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIGFycmF5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIGFycmF5LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8uaXNBcnJheShhcmd1bWVudHMpOyB9KSgpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzQXJyYXkoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgdmFyIGlzQXJyYXkgPSBuYXRpdmVJc0FycmF5IHx8IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT0gJ29iamVjdCcgJiYgdHlwZW9mIHZhbHVlLmxlbmd0aCA9PSAnbnVtYmVyJyAmJgogICAgICAgIHRvU3RyaW5nLmNhbGwodmFsdWUpID09IGFycmF5Q2xhc3MgfHwgZmFsc2U7CiAgICB9OwoKICAgIC8qKgogICAgICogQSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiBvZiBgT2JqZWN0LmtleXNgIHdoaWNoIHByb2R1Y2VzIGFuIGFycmF5IG9mIHRoZQogICAgICogZ2l2ZW4gb2JqZWN0J3Mgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMuCiAgICAgKgogICAgICogQHByaXZhdGUKICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcy4KICAgICAqLwogICAgdmFyIHNoaW1LZXlzID0gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBvYmplY3QsIHJlc3VsdCA9IFtdOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIShvYmplY3RUeXBlc1t0eXBlb2Ygb2JqZWN0XSkpIHJldHVybiByZXN1bHQ7CiAgICAgICAgZm9yIChpbmRleCBpbiBpdGVyYWJsZSkgewogICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoaXRlcmFibGUsIGluZGV4KSkgewogICAgICAgICAgICByZXN1bHQucHVzaChpbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0CiAgICB9OwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBjb21wb3NlZCBvZiB0aGUgb3duIGVudW1lcmFibGUgcHJvcGVydHkgbmFtZXMgb2YgYW4gb2JqZWN0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ua2V5cyh7ICdvbmUnOiAxLCAndHdvJzogMiwgJ3RocmVlJzogMyB9KTsKICAgICAqIC8vID0+IFsnb25lJywgJ3R3bycsICd0aHJlZSddIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIga2V5cyA9ICFuYXRpdmVLZXlzID8gc2hpbUtleXMgOiBmdW5jdGlvbihvYmplY3QpIHsKICAgICAgaWYgKCFpc09iamVjdChvYmplY3QpKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgICB9CiAgICAgIHJldHVybiBuYXRpdmVLZXlzKG9iamVjdCk7CiAgICB9OwoKICAgIC8qKgogICAgICogVXNlZCB0byBjb252ZXJ0IGNoYXJhY3RlcnMgdG8gSFRNTCBlbnRpdGllczoKICAgICAqCiAgICAgKiBUaG91Z2ggdGhlIGA+YCBjaGFyYWN0ZXIgaXMgZXNjYXBlZCBmb3Igc3ltbWV0cnksIGNoYXJhY3RlcnMgbGlrZSBgPmAgYW5kIGAvYAogICAgICogZG9uJ3QgcmVxdWlyZSBlc2NhcGluZyBpbiBIVE1MIGFuZCBoYXZlIG5vIHNwZWNpYWwgbWVhbmluZyB1bmxlc3MgdGhleSdyZSBwYXJ0CiAgICAgKiBvZiBhIHRhZyBvciBhbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUuCiAgICAgKiBodHRwOi8vbWF0aGlhc2J5bmVucy5iZS9ub3Rlcy9hbWJpZ3VvdXMtYW1wZXJzYW5kcyAodW5kZXIgInNlbWktcmVsYXRlZCBmdW4gZmFjdCIpCiAgICAgKi8KICAgIHZhciBodG1sRXNjYXBlcyA9IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjMzk7JwogICAgfTsKCiAgICAvKiogVXNlZCB0byBjb252ZXJ0IEhUTUwgZW50aXRpZXMgdG8gY2hhcmFjdGVycyAqLwogICAgdmFyIGh0bWxVbmVzY2FwZXMgPSBpbnZlcnQoaHRtbEVzY2FwZXMpOwoKICAgIC8qKiBVc2VkIHRvIG1hdGNoIEhUTUwgZW50aXRpZXMgYW5kIEhUTUwgY2hhcmFjdGVycyAqLwogICAgdmFyIHJlRXNjYXBlZEh0bWwgPSBSZWdFeHAoJygnICsga2V5cyhodG1sVW5lc2NhcGVzKS5qb2luKCd8JykgKyAnKScsICdnJyksCiAgICAgICAgcmVVbmVzY2FwZWRIdG1sID0gUmVnRXhwKCdbJyArIGtleXMoaHRtbEVzY2FwZXMpLmpvaW4oJycpICsgJ10nLCAnZycpOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQXNzaWducyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHNvdXJjZSBvYmplY3QocykgdG8gdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBvYmplY3QuIFN1YnNlcXVlbnQgc291cmNlcyB3aWxsIG92ZXJ3cml0ZSBwcm9wZXJ0eSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cwogICAgICogc291cmNlcy4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlCiAgICAgKiBhc3NpZ25lZCB2YWx1ZXMuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0d28KICAgICAqIGFyZ3VtZW50czsgKG9iamVjdFZhbHVlLCBzb3VyY2VWYWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAYWxpYXMgZXh0ZW5kCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IFtzb3VyY2VdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGN1c3RvbWl6ZSBhc3NpZ25pbmcgdmFsdWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uYXNzaWduKHsgJ25hbWUnOiAnbW9lJyB9LCB7ICdhZ2UnOiA0MCB9KTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgICAqCiAgICAgKiB2YXIgZGVmYXVsdHMgPSBfLnBhcnRpYWxSaWdodChfLmFzc2lnbiwgZnVuY3Rpb24oYSwgYikgewogICAgICogICByZXR1cm4gdHlwZW9mIGEgPT0gJ3VuZGVmaW5lZCcgPyBiIDogYTsKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBmb29kID0geyAnbmFtZSc6ICdhcHBsZScgfTsKICAgICAqIGRlZmF1bHRzKGZvb2QsIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdhcHBsZScsICd0eXBlJzogJ2ZydWl0JyB9CiAgICAgKi8KICAgIHZhciBhc3NpZ24gPSBmdW5jdGlvbihvYmplY3QsIHNvdXJjZSwgZ3VhcmQpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IG9iamVjdCwgcmVzdWx0ID0gaXRlcmFibGU7CiAgICAgIGlmICghaXRlcmFibGUpIHJldHVybiByZXN1bHQ7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgYXJnc0luZGV4ID0gMCwKICAgICAgICAgIGFyZ3NMZW5ndGggPSB0eXBlb2YgZ3VhcmQgPT0gJ251bWJlcicgPyAyIDogYXJncy5sZW5ndGg7CiAgICAgIGlmIChhcmdzTGVuZ3RoID4gMyAmJiB0eXBlb2YgYXJnc1thcmdzTGVuZ3RoIC0gMl0gPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHZhciBjYWxsYmFjayA9IGJhc2VDcmVhdGVDYWxsYmFjayhhcmdzWy0tYXJnc0xlbmd0aCAtIDFdLCBhcmdzW2FyZ3NMZW5ndGgtLV0sIDIpOwogICAgICB9IGVsc2UgaWYgKGFyZ3NMZW5ndGggPiAyICYmIHR5cGVvZiBhcmdzW2FyZ3NMZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tYXJnc0xlbmd0aF07CiAgICAgIH0KICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIGl0ZXJhYmxlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGlmIChpdGVyYWJsZSAmJiBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdKSB7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2sgPyBjYWxsYmFjayhyZXN1bHRbaW5kZXhdLCBpdGVyYWJsZVtpbmRleF0pIDogaXRlcmFibGVbaW5kZXhdOwogICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBjbG9uZSBvZiBgdmFsdWVgLiBJZiBgZGVlcGAgaXMgYHRydWVgIG5lc3RlZCBvYmplY3RzIHdpbGwgYWxzbwogICAgICogYmUgY2xvbmVkLCBvdGhlcndpc2UgdGhleSB3aWxsIGJlIGFzc2lnbmVkIGJ5IHJlZmVyZW5jZS4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCB0byBwcm9kdWNlIHRoZSBjbG9uZWQgdmFsdWVzLiBJZiB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgY2xvbmluZyB3aWxsIGJlIGhhbmRsZWQgYnkgdGhlIG1ldGhvZCBpbnN0ZWFkLgogICAgICogVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDsgKHZhbHVlKS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNsb25lLgogICAgICogQHBhcmFtIHtib29sZWFufSBbZGVlcD1mYWxzZV0gU3BlY2lmeSBhIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBjbG9uZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBzdG9vZ2VzID0gWwogICAgICogICB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LAogICAgICogICB7ICduYW1lJzogJ2xhcnJ5JywgJ2FnZSc6IDUwIH0KICAgICAqIF07CiAgICAgKgogICAgICogdmFyIHNoYWxsb3cgPSBfLmNsb25lKHN0b29nZXMpOwogICAgICogc2hhbGxvd1swXSA9PT0gc3Rvb2dlc1swXTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgZGVlcCA9IF8uY2xvbmUoc3Rvb2dlcywgdHJ1ZSk7CiAgICAgKiBkZWVwWzBdID09PSBzdG9vZ2VzWzBdOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLm1peGluKHsKICAgICAqICAgJ2Nsb25lJzogXy5wYXJ0aWFsUmlnaHQoXy5jbG9uZSwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAqICAgICByZXR1cm4gXy5pc0VsZW1lbnQodmFsdWUpID8gdmFsdWUuY2xvbmVOb2RlKGZhbHNlKSA6IHVuZGVmaW5lZDsKICAgICAqICAgfSkKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBjbG9uZSA9IF8uY2xvbmUoZG9jdW1lbnQuYm9keSk7CiAgICAgKiBjbG9uZS5jaGlsZE5vZGVzLmxlbmd0aDsKICAgICAqIC8vID0+IDAKICAgICAqLwogICAgZnVuY3Rpb24gY2xvbmUodmFsdWUsIGRlZXAsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIC8vIGFsbG93cyB3b3JraW5nIHdpdGggIkNvbGxlY3Rpb25zIiBtZXRob2RzIHdpdGhvdXQgdXNpbmcgdGhlaXIgYGluZGV4YAogICAgICAvLyBhbmQgYGNvbGxlY3Rpb25gIGFyZ3VtZW50cyBmb3IgYGRlZXBgIGFuZCBgY2FsbGJhY2tgCiAgICAgIGlmICh0eXBlb2YgZGVlcCAhPSAnYm9vbGVhbicgJiYgZGVlcCAhPSBudWxsKSB7CiAgICAgICAgdGhpc0FyZyA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gZGVlcDsKICAgICAgICBkZWVwID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGJhc2VDbG9uZSh2YWx1ZSwgZGVlcCwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZGVlcCBjbG9uZSBvZiBgdmFsdWVgLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUKICAgICAqIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIGNsb25lZCB2YWx1ZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgCiAgICAgKiBjbG9uaW5nIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggb25lIGFyZ3VtZW50OyAodmFsdWUpLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGlzIGxvb3NlbHkgYmFzZWQgb24gdGhlIHN0cnVjdHVyZWQgY2xvbmUgYWxnb3JpdGhtLiBGdW5jdGlvbnMKICAgICAqIGFuZCBET00gbm9kZXMgYXJlICoqbm90KiogY2xvbmVkLiBUaGUgZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIGBhcmd1bWVudHNgIG9iamVjdHMgYW5kCiAgICAgKiBvYmplY3RzIGNyZWF0ZWQgYnkgY29uc3RydWN0b3JzIG90aGVyIHRoYW4gYE9iamVjdGAgYXJlIGNsb25lZCB0byBwbGFpbiBgT2JqZWN0YCBvYmplY3RzLgogICAgICogU2VlIGh0dHA6Ly93d3cudzMub3JnL1RSL2h0bWw1L2luZnJhc3RydWN0dXJlLmh0bWwjaW50ZXJuYWwtc3RydWN0dXJlZC1jbG9uaW5nLWFsZ29yaXRobS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGRlZXAgY2xvbmUuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjdXN0b21pemUgY2xvbmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBkZWVwIGNsb25lZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiB2YXIgZGVlcCA9IF8uY2xvbmVEZWVwKHN0b29nZXMpOwogICAgICogZGVlcFswXSA9PT0gc3Rvb2dlc1swXTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIHZpZXcgPSB7CiAgICAgKiAgICdsYWJlbCc6ICdkb2NzJywKICAgICAqICAgJ25vZGUnOiBlbGVtZW50CiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBjbG9uZSA9IF8uY2xvbmVEZWVwKHZpZXcsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgKiAgIHJldHVybiBfLmlzRWxlbWVudCh2YWx1ZSkgPyB2YWx1ZS5jbG9uZU5vZGUodHJ1ZSkgOiB1bmRlZmluZWQ7CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBjbG9uZS5ub2RlID09IHZpZXcubm9kZTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNsb25lRGVlcCh2YWx1ZSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgcmV0dXJuIGJhc2VDbG9uZSh2YWx1ZSwgdHJ1ZSwgdHlwZW9mIGNhbGxiYWNrID09ICdmdW5jdGlvbicgJiYgYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBc3NpZ25zIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2Ygc291cmNlIG9iamVjdChzKSB0byB0aGUgZGVzdGluYXRpb24KICAgICAqIG9iamVjdCBmb3IgYWxsIGRlc3RpbmF0aW9uIHByb3BlcnRpZXMgdGhhdCByZXNvbHZlIHRvIGB1bmRlZmluZWRgLiBPbmNlIGEKICAgICAqIHByb3BlcnR5IGlzIHNldCwgYWRkaXRpb25hbCBkZWZhdWx0cyBvZiB0aGUgc2FtZSBwcm9wZXJ0eSB3aWxsIGJlIGlnbm9yZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQHBhcmFtIHsuLi5PYmplY3R9IFtzb3VyY2VdIFRoZSBzb3VyY2Ugb2JqZWN0cy4KICAgICAqIEBwYXJhbS0ge09iamVjdH0gW2d1YXJkXSBBbGxvd3Mgd29ya2luZyB3aXRoIGBfLnJlZHVjZWAgd2l0aG91dCB1c2luZyBpdHMKICAgICAqICBga2V5YCBhbmQgYG9iamVjdGAgYXJndW1lbnRzIGFzIHNvdXJjZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBmb29kID0geyAnbmFtZSc6ICdhcHBsZScgfTsKICAgICAqIF8uZGVmYXVsdHMoZm9vZCwgeyAnbmFtZSc6ICdiYW5hbmEnLCAndHlwZSc6ICdmcnVpdCcgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2FwcGxlJywgJ3R5cGUnOiAnZnJ1aXQnIH0KICAgICAqLwogICAgdmFyIGRlZmF1bHRzID0gZnVuY3Rpb24ob2JqZWN0LCBzb3VyY2UsIGd1YXJkKSB7CiAgICAgIHZhciBpbmRleCwgaXRlcmFibGUgPSBvYmplY3QsIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICB2YXIgYXJncyA9IGFyZ3VtZW50cywKICAgICAgICAgIGFyZ3NJbmRleCA9IDAsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gdHlwZW9mIGd1YXJkID09ICdudW1iZXInID8gMiA6IGFyZ3MubGVuZ3RoOwogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgaXRlcmFibGUgPSBhcmdzW2FyZ3NJbmRleF07CiAgICAgICAgaWYgKGl0ZXJhYmxlICYmIG9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHsKICAgICAgICB2YXIgb3duSW5kZXggPSAtMSwKICAgICAgICAgICAgb3duUHJvcHMgPSBvYmplY3RUeXBlc1t0eXBlb2YgaXRlcmFibGVdICYmIGtleXMoaXRlcmFibGUpLAogICAgICAgICAgICBsZW5ndGggPSBvd25Qcm9wcyA/IG93blByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK293bkluZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICBpbmRleCA9IG93blByb3BzW293bkluZGV4XTsKICAgICAgICAgIGlmICh0eXBlb2YgcmVzdWx0W2luZGV4XSA9PSAndW5kZWZpbmVkJykgcmVzdWx0W2luZGV4XSA9IGl0ZXJhYmxlW2luZGV4XTsKICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQKICAgIH07CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRJbmRleGAgZXhjZXB0IHRoYXQgaXQgcmV0dXJucyB0aGUga2V5IG9mIHRoZQogICAgICogZmlyc3QgZWxlbWVudCB0aGF0IHBhc3NlcyB0aGUgY2FsbGJhY2sgY2hlY2ssIGluc3RlYWQgb2YgdGhlIGVsZW1lbnQgaXRzZWxmLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlcgogICAgICogIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8KICAgICAqICBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtzdHJpbmd8dW5kZWZpbmVkfSBSZXR1cm5zIHRoZSBrZXkgb2YgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZEtleSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMsICdkJzogNCB9LCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSAlIDIgPT0gMDsKICAgICAqIH0pOwogICAgICogLy8gPT4gJ2InIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kS2V5KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JPd24ob2JqZWN0LCBmdW5jdGlvbih2YWx1ZSwga2V5LCBvYmplY3QpIHsKICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgcmVzdWx0ID0ga2V5OwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRLZXlgIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIKICAgICAqICBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgKiAgY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfHVuZGVmaW5lZH0gUmV0dXJucyB0aGUga2V5IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0S2V5KHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMywgJ2QnOiA0IH0sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICUgMiA9PSAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiByZXR1cm5zIGBjYCwgYXNzdW1pbmcgYF8uZmluZEtleWAgcmV0dXJucyBgYWAKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3RLZXkob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcmVzdWx0OwogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGZvck93blJpZ2h0KG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBrZXksIG9iamVjdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IGtleTsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBvd24gYW5kIGluaGVyaXRlZCBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LAogICAgICogZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQKICAgICAqIGl0ZXJhdGlvbiBlYXJseSBieSBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRG9nKG5hbWUpIHsKICAgICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ1dvb2YsIHdvb2YhJyk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW4obmV3IERvZygnRGFnbnknKSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICogICBjb25zb2xlLmxvZyhrZXkpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBsb2dzICdiYXJrJyBhbmQgJ25hbWUnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9ySW4gPSBmdW5jdGlvbihjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgaW5kZXgsIGl0ZXJhYmxlID0gY29sbGVjdGlvbiwgcmVzdWx0ID0gaXRlcmFibGU7CiAgICAgIGlmICghaXRlcmFibGUpIHJldHVybiByZXN1bHQ7CiAgICAgIGlmICghb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSkgcmV0dXJuIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyA/IGNhbGxiYWNrIDogYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICBmb3IgKGluZGV4IGluIGl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9ySW5gIGV4Y2VwdCB0aGF0IGl0IGl0ZXJhdGVzIG92ZXIgZWxlbWVudHMKICAgICAqIG9mIGEgYGNvbGxlY3Rpb25gIGluIHRoZSBvcHBvc2l0ZSBvcmRlci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gRG9nKG5hbWUpIHsKICAgICAqICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBEb2cucHJvdG90eXBlLmJhcmsgPSBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ1dvb2YsIHdvb2YhJyk7CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uZm9ySW5SaWdodChuZXcgRG9nKCdEYWdueScpLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgKiAgIGNvbnNvbGUubG9nKGtleSk7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IGxvZ3MgJ25hbWUnIGFuZCAnYmFyaycgYXNzdW1pbmcgYF8uZm9ySW4gYCBsb2dzICdiYXJrJyBhbmQgJ25hbWUnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckluUmlnaHQob2JqZWN0LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgcGFpcnMgPSBbXTsKCiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHBhaXJzLnB1c2goa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwoKICAgICAgdmFyIGxlbmd0aCA9IHBhaXJzLmxlbmd0aDsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICBpZiAoY2FsbGJhY2socGFpcnNbbGVuZ3RoLS1dLCBwYWlyc1tsZW5ndGhdLCBvYmplY3QpID09PSBmYWxzZSkgewogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgb2YgYW4gb2JqZWN0LCBleGVjdXRpbmcgdGhlIGNhbGxiYWNrCiAgICAgKiBmb3IgZWFjaCBwcm9wZXJ0eS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwga2V5LCBvYmplY3QpLiBDYWxsYmFja3MgbWF5IGV4aXQgaXRlcmF0aW9uIGVhcmx5IGJ5CiAgICAgKiBleHBsaWNpdGx5IHJldHVybmluZyBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBGdW5jdGlvbgogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBgb2JqZWN0YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mb3JPd24oeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICB2YXIgZm9yT3duID0gZnVuY3Rpb24oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4LCBpdGVyYWJsZSA9IGNvbGxlY3Rpb24sIHJlc3VsdCA9IGl0ZXJhYmxlOwogICAgICBpZiAoIWl0ZXJhYmxlKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAoIW9iamVjdFR5cGVzW3R5cGVvZiBpdGVyYWJsZV0pIHJldHVybiByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgdmFyIG93bkluZGV4ID0gLTEsCiAgICAgICAgICAgIG93blByb3BzID0gb2JqZWN0VHlwZXNbdHlwZW9mIGl0ZXJhYmxlXSAmJiBrZXlzKGl0ZXJhYmxlKSwKICAgICAgICAgICAgbGVuZ3RoID0gb3duUHJvcHMgPyBvd25Qcm9wcy5sZW5ndGggOiAwOwoKICAgICAgICB3aGlsZSAoKytvd25JbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaW5kZXggPSBvd25Qcm9wc1tvd25JbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2soaXRlcmFibGVbaW5kZXhdLCBpbmRleCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdAogICAgfTsKCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yT3duYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBpbiB0aGUgb3Bwb3NpdGUgb3JkZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgYG9iamVjdGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZm9yT3duUmlnaHQoeyAnMCc6ICd6ZXJvJywgJzEnOiAnb25lJywgJ2xlbmd0aCc6IDIgfSwgZnVuY3Rpb24obnVtLCBrZXkpIHsKICAgICAqICAgY29uc29sZS5sb2coa2V5KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnbGVuZ3RoJywgJzEnLCBhbmQgJzAnIGFzc3VtaW5nIGBfLmZvck93bmAgbG9ncyAnMCcsICcxJywgYW5kICdsZW5ndGgnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvck93blJpZ2h0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHByb3BzID0ga2V5cyhvYmplY3QpLAogICAgICAgICAgbGVuZ3RoID0gcHJvcHMubGVuZ3RoOwoKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICB2YXIga2V5ID0gcHJvcHNbbGVuZ3RoXTsKICAgICAgICBpZiAoY2FsbGJhY2sob2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNvcnRlZCBhcnJheSBvZiBwcm9wZXJ0eSBuYW1lcyBvZiBhbGwgZW51bWVyYWJsZSBwcm9wZXJ0aWVzLAogICAgICogb3duIGFuZCBpbmhlcml0ZWQsIG9mIGBvYmplY3RgIHRoYXQgaGF2ZSBmdW5jdGlvbiB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBtZXRob2RzCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgcHJvcGVydHkgbmFtZXMgdGhhdCBoYXZlIGZ1bmN0aW9uIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mdW5jdGlvbnMoXyk7CiAgICAgKiAvLyA9PiBbJ2FsbCcsICdhbnknLCAnYmluZCcsICdiaW5kQWxsJywgJ2Nsb25lJywgJ2NvbXBhY3QnLCAnY29tcG9zZScsIC4uLl0KICAgICAqLwogICAgZnVuY3Rpb24gZnVuY3Rpb25zKG9iamVjdCkgewogICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0LnNvcnQoKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBgcHJvcGVydHlgIGV4aXN0cyBhbmQgaXMgYSBkaXJlY3QgcHJvcGVydHksCiAgICAgKiBpbnN0ZWFkIG9mIGFuIGluaGVyaXRlZCBwcm9wZXJ0eS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBjaGVjay4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gY2hlY2sgZm9yLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGtleSBpcyBhIGRpcmVjdCBwcm9wZXJ0eSwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmhhcyh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgJ2InKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaGFzKG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgcmV0dXJuIG9iamVjdCA/IGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBwcm9wZXJ0eSkgOiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBpbnZlcnRlZCBrZXlzIGFuZCB2YWx1ZXMgb2YgdGhlIGdpdmVuIG9iamVjdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjcmVhdGVkIGludmVydGVkIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogIF8uaW52ZXJ0KHsgJ2ZpcnN0JzogJ21vZScsICdzZWNvbmQnOiAnbGFycnknIH0pOwogICAgICogLy8gPT4geyAnbW9lJzogJ2ZpcnN0JywgJ2xhcnJ5JzogJ3NlY29uZCcgfQogICAgICovCiAgICBmdW5jdGlvbiBpbnZlcnQob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSB7fTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IHByb3BzW2luZGV4XTsKICAgICAgICByZXN1bHRbb2JqZWN0W2tleV1dID0ga2V5OwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGJvb2xlYW4gdmFsdWUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Jvb2xlYW4obnVsbCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc0Jvb2xlYW4odmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB0cnVlIHx8IHZhbHVlID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBib29sQ2xhc3M7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIGRhdGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGRhdGUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0RhdGUobmV3IERhdGUpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0RhdGUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBkYXRlQ2xhc3MpIDogZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBhIERPTSBlbGVtZW50LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBET00gZWxlbWVudCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzRWxlbWVudChkb2N1bWVudC5ib2R5KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNFbGVtZW50KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA/IHZhbHVlLm5vZGVUeXBlID09PSAxIDogZmFsc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBlbXB0eS4gQXJyYXlzLCBzdHJpbmdzLCBvciBgYXJndW1lbnRzYCBvYmplY3RzIHdpdGggYQogICAgICogbGVuZ3RoIG9mIGAwYCBhbmQgb2JqZWN0cyB3aXRoIG5vIG93biBlbnVtZXJhYmxlIHByb3BlcnRpZXMgYXJlIGNvbnNpZGVyZWQKICAgICAqICJlbXB0eSIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IHZhbHVlIFRoZSB2YWx1ZSB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGVtcHR5LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNFbXB0eShbMSwgMiwgM10pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRW1wdHkoe30pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNFbXB0eSgnJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRW1wdHkodmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHZhciBjbGFzc05hbWUgPSB0b1N0cmluZy5jYWxsKHZhbHVlKSwKICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKCiAgICAgIGlmICgoY2xhc3NOYW1lID09IGFycmF5Q2xhc3MgfHwgY2xhc3NOYW1lID09IHN0cmluZ0NsYXNzIHx8IGNsYXNzTmFtZSA9PSBhcmdzQ2xhc3MgKSB8fAogICAgICAgICAgKGNsYXNzTmFtZSA9PSBvYmplY3RDbGFzcyAmJiB0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInICYmIGlzRnVuY3Rpb24odmFsdWUuc3BsaWNlKSkpIHsKICAgICAgICByZXR1cm4gIWxlbmd0aDsKICAgICAgfQogICAgICBmb3JPd24odmFsdWUsIGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiAocmVzdWx0ID0gZmFsc2UpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFBlcmZvcm1zIGEgZGVlcCBjb21wYXJpc29uIGJldHdlZW4gdHdvIHZhbHVlcyB0byBkZXRlcm1pbmUgaWYgdGhleSBhcmUKICAgICAqIGVxdWl2YWxlbnQgdG8gZWFjaCBvdGhlci4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkCiAgICAgKiB0byBjb21wYXJlIHZhbHVlcy4gSWYgdGhlIGNhbGxiYWNrIHJldHVybnMgYHVuZGVmaW5lZGAgY29tcGFyaXNvbnMgd2lsbAogICAgICogYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czsgKGEsIGIpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSBhIFRoZSB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHsqfSBiIFRoZSBvdGhlciB2YWx1ZSB0byBjb21wYXJlLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIGNvbXBhcmluZyB2YWx1ZXMuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgdmFsdWVzIGFyZSBlcXVpdmFsZW50LCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBtb2UgPSB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICogdmFyIGNvcHkgPSB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICoKICAgICAqIG1vZSA9PSBjb3B5OwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRXF1YWwobW9lLCBjb3B5KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgd29yZHMgPSBbJ2hlbGxvJywgJ2dvb2RieWUnXTsKICAgICAqIHZhciBvdGhlcldvcmRzID0gWydoaScsICdnb29kYnllJ107CiAgICAgKgogICAgICogXy5pc0VxdWFsKHdvcmRzLCBvdGhlcldvcmRzLCBmdW5jdGlvbihhLCBiKSB7CiAgICAgKiAgIHZhciByZUdyZWV0ID0gL14oPzpoZWxsb3xoaSkkL2ksCiAgICAgKiAgICAgICBhR3JlZXQgPSBfLmlzU3RyaW5nKGEpICYmIHJlR3JlZXQudGVzdChhKSwKICAgICAqICAgICAgIGJHcmVldCA9IF8uaXNTdHJpbmcoYikgJiYgcmVHcmVldC50ZXN0KGIpOwogICAgICoKICAgICAqICAgcmV0dXJuIChhR3JlZXQgfHwgYkdyZWV0KSA/IChhR3JlZXQgPT0gYkdyZWV0KSA6IHVuZGVmaW5lZDsKICAgICAqIH0pOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBpc0VxdWFsKGEsIGIsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBiYXNlSXNFcXVhbChhLCBiLCB0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJyAmJiBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDIpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzLCBvciBjYW4gYmUgY29lcmNlZCB0bywgYSBmaW5pdGUgbnVtYmVyLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgaXMgbm90IHRoZSBzYW1lIGFzIG5hdGl2ZSBgaXNGaW5pdGVgIHdoaWNoIHdpbGwgcmV0dXJuIHRydWUgZm9yCiAgICAgKiBib29sZWFucyBhbmQgZW1wdHkgc3RyaW5ncy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMS4yLjUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBmaW5pdGUsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc0Zpbml0ZSgtMTAxKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKCcxMCcpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUodHJ1ZSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNGaW5pdGUoJycpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmlzRmluaXRlKEluZmluaXR5KTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzRmluaXRlKHZhbHVlKSB7CiAgICAgIHJldHVybiBuYXRpdmVJc0Zpbml0ZSh2YWx1ZSkgJiYgIW5hdGl2ZUlzTmFOKHBhcnNlRmxvYXQodmFsdWUpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIGZ1bmN0aW9uLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNGdW5jdGlvbihfKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdmdW5jdGlvbic7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyB0aGUgbGFuZ3VhZ2UgdHlwZSBvZiBPYmplY3QuCiAgICAgKiAoZS5nLiBhcnJheXMsIGZ1bmN0aW9ucywgb2JqZWN0cywgcmVnZXhlcywgYG5ldyBOdW1iZXIoMClgLCBhbmQgYG5ldyBTdHJpbmcoJycpYCkKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KHt9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmlzT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc09iamVjdCgxKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIC8vIGNoZWNrIGlmIHRoZSB2YWx1ZSBpcyB0aGUgRUNNQVNjcmlwdCBsYW5ndWFnZSB0eXBlIG9mIE9iamVjdAogICAgICAvLyBodHRwOi8vZXM1LmdpdGh1Yi5pby8jeDgKICAgICAgLy8gYW5kIGF2b2lkIGEgVjggYnVnCiAgICAgIC8vIGh0dHA6Ly9jb2RlLmdvb2dsZS5jb20vcC92OC9pc3N1ZXMvZGV0YWlsP2lkPTIyOTEKICAgICAgcmV0dXJuICEhKHZhbHVlICYmIG9iamVjdFR5cGVzW3R5cGVvZiB2YWx1ZV0pOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYE5hTmAuCiAgICAgKgogICAgICogTm90ZTogVGhpcyBpcyBub3QgdGhlIHNhbWUgYXMgbmF0aXZlIGBpc05hTmAgd2hpY2ggd2lsbCByZXR1cm4gYHRydWVgIGZvcgogICAgICogYHVuZGVmaW5lZGAgYW5kIG90aGVyIG5vbi1udW1lcmljIHZhbHVlcy4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4MTUuMS4yLjQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBgTmFOYCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzTmFOKE5hTik7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc05hTihuZXcgTnVtYmVyKE5hTikpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIGlzTmFOKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5pc05hTih1bmRlZmluZWQpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gaXNOYU4odmFsdWUpIHsKICAgICAgLy8gYE5hTmAgYXMgYSBwcmltaXRpdmUgaXMgdGhlIG9ubHkgdmFsdWUgdGhhdCBpcyBub3QgZXF1YWwgdG8gaXRzZWxmCiAgICAgIC8vIChwZXJmb3JtIHRoZSBbW0NsYXNzXV0gY2hlY2sgZmlyc3QgdG8gYXZvaWQgZXJyb3JzIHdpdGggc29tZSBob3N0IG9iamVjdHMgaW4gSUUpCiAgICAgIHJldHVybiBpc051bWJlcih2YWx1ZSkgJiYgdmFsdWUgIT0gK3ZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYG51bGxgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYG51bGxgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNOdWxsKG51bGwpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICoKICAgICAqIF8uaXNOdWxsKHVuZGVmaW5lZCk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBpc051bGwodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSBudW1iZXIuCiAgICAgKgogICAgICogTm90ZTogYE5hTmAgaXMgY29uc2lkZXJlZCBhIG51bWJlci4gU2VlIGh0dHA6Ly9lczUuZ2l0aHViLmlvLyN4OC41LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBudW1iZXIsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc051bWJlcig4LjQgKiA1KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAnbnVtYmVyJyB8fCB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBudW1iZXJDbGFzczsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGFuIG9iamVjdCBjcmVhdGVkIGJ5IHRoZSBgT2JqZWN0YCBjb25zdHJ1Y3Rvci4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGB2YWx1ZWAgaXMgYSBwbGFpbiBvYmplY3QsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogZnVuY3Rpb24gU3Rvb2dlKG5hbWUsIGFnZSkgewogICAgICogICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICogICB0aGlzLmFnZSA9IGFnZTsKICAgICAqIH0KICAgICAqCiAgICAgKiBfLmlzUGxhaW5PYmplY3QobmV3IFN0b29nZSgnbW9lJywgNDApKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogXy5pc1BsYWluT2JqZWN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICoKICAgICAqIF8uaXNQbGFpbk9iamVjdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9KTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgdmFyIGlzUGxhaW5PYmplY3QgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICBpZiAoISh2YWx1ZSAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSBvYmplY3RDbGFzcykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdmFyIHZhbHVlT2YgPSB2YWx1ZS52YWx1ZU9mLAogICAgICAgICAgb2JqUHJvdG8gPSB0eXBlb2YgdmFsdWVPZiA9PSAnZnVuY3Rpb24nICYmIChvYmpQcm90byA9IGdldFByb3RvdHlwZU9mKHZhbHVlT2YpKSAmJiBnZXRQcm90b3R5cGVPZihvYmpQcm90byk7CgogICAgICByZXR1cm4gb2JqUHJvdG8KICAgICAgICA/ICh2YWx1ZSA9PSBvYmpQcm90byB8fCBnZXRQcm90b3R5cGVPZih2YWx1ZSkgPT0gb2JqUHJvdG8pCiAgICAgICAgOiBzaGltSXNQbGFpbk9iamVjdCh2YWx1ZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIGB2YWx1ZWAgaXMgYSByZWd1bGFyIGV4cHJlc3Npb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBjaGVjay4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHZhbHVlYCBpcyBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmlzUmVnRXhwKC9tb2UvKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNSZWdFeHAodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID8gKHR5cGVvZiB2YWx1ZSA9PSAnb2JqZWN0JyAmJiB0b1N0cmluZy5jYWxsKHZhbHVlKSA9PSByZWdleHBDbGFzcykgOiBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBpZiBgdmFsdWVgIGlzIGEgc3RyaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHsqfSB2YWx1ZSBUaGUgdmFsdWUgdG8gY2hlY2suCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGB2YWx1ZWAgaXMgYSBzdHJpbmcsIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5pc1N0cmluZygnbW9lJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT0gJ3N0cmluZycgfHwgdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gc3RyaW5nQ2xhc3M7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYHZhbHVlYCBpcyBgdW5kZWZpbmVkYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIGNoZWNrLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBgdmFsdWVgIGlzIGB1bmRlZmluZWRgLCBlbHNlIGBmYWxzZWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaXNVbmRlZmluZWQodm9pZCAwKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqLwogICAgZnVuY3Rpb24gaXNVbmRlZmluZWQodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAndW5kZWZpbmVkJzsKICAgIH0KCiAgICAvKioKICAgICAqIFJlY3Vyc2l2ZWx5IG1lcmdlcyBvd24gZW51bWVyYWJsZSBwcm9wZXJ0aWVzIG9mIHRoZSBzb3VyY2Ugb2JqZWN0KHMpLCB0aGF0CiAgICAgKiBkb24ndCByZXNvbHZlIHRvIGB1bmRlZmluZWRgIGludG8gdGhlIGRlc3RpbmF0aW9uIG9iamVjdC4gU3Vic2VxdWVudCBzb3VyY2VzCiAgICAgKiB3aWxsIG92ZXJ3cml0ZSBwcm9wZXJ0eSBhc3NpZ25tZW50cyBvZiBwcmV2aW91cyBzb3VyY2VzLiBJZiBhIGNhbGxiYWNrIGlzCiAgICAgKiBwcm92aWRlZCBpdCB3aWxsIGJlIGV4ZWN1dGVkIHRvIHByb2R1Y2UgdGhlIG1lcmdlZCB2YWx1ZXMgb2YgdGhlIGRlc3RpbmF0aW9uCiAgICAgKiBhbmQgc291cmNlIHByb3BlcnRpZXMuIElmIHRoZSBjYWxsYmFjayByZXR1cm5zIGB1bmRlZmluZWRgIG1lcmdpbmcgd2lsbAogICAgICogYmUgaGFuZGxlZCBieSB0aGUgbWV0aG9kIGluc3RlYWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdHdvIGFyZ3VtZW50czsgKG9iamVjdFZhbHVlLCBzb3VyY2VWYWx1ZSkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBkZXN0aW5hdGlvbiBvYmplY3QuCiAgICAgKiBAcGFyYW0gey4uLk9iamVjdH0gW3NvdXJjZV0gVGhlIHNvdXJjZSBvYmplY3RzLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gdG8gY3VzdG9taXplIG1lcmdpbmcgcHJvcGVydGllcy4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgZGVzdGluYXRpb24gb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgbmFtZXMgPSB7CiAgICAgKiAgICdzdG9vZ2VzJzogWwogICAgICogICAgIHsgJ25hbWUnOiAnbW9lJyB9LAogICAgICogICAgIHsgJ25hbWUnOiAnbGFycnknIH0KICAgICAqICAgXQogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgYWdlcyA9IHsKICAgICAqICAgJ3N0b29nZXMnOiBbCiAgICAgKiAgICAgeyAnYWdlJzogNDAgfSwKICAgICAqICAgICB7ICdhZ2UnOiA1MCB9CiAgICAgKiAgIF0KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShuYW1lcywgYWdlcyk7CiAgICAgKiAvLyA9PiB7ICdzdG9vZ2VzJzogW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0gfQogICAgICoKICAgICAqIHZhciBmb29kID0gewogICAgICogICAnZnJ1aXRzJzogWydhcHBsZSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnYmVldCddCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBvdGhlckZvb2QgPSB7CiAgICAgKiAgICdmcnVpdHMnOiBbJ2JhbmFuYSddLAogICAgICogICAndmVnZXRhYmxlcyc6IFsnY2Fycm90J10KICAgICAqIH07CiAgICAgKgogICAgICogXy5tZXJnZShmb29kLCBvdGhlckZvb2QsIGZ1bmN0aW9uKGEsIGIpIHsKICAgICAqICAgcmV0dXJuIF8uaXNBcnJheShhKSA/IGEuY29uY2F0KGIpIDogdW5kZWZpbmVkOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICdmcnVpdHMnOiBbJ2FwcGxlJywgJ2JhbmFuYSddLCAndmVnZXRhYmxlcyc6IFsnYmVldCcsICdjYXJyb3RdIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVyZ2Uob2JqZWN0KSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgbGVuZ3RoID0gMjsKCiAgICAgIGlmICghaXNPYmplY3Qob2JqZWN0KSkgewogICAgICAgIHJldHVybiBvYmplY3Q7CiAgICAgIH0KICAgICAgLy8gYWxsb3dzIHdvcmtpbmcgd2l0aCBgXy5yZWR1Y2VgIGFuZCBgXy5yZWR1Y2VSaWdodGAgd2l0aG91dCB1c2luZwogICAgICAvLyB0aGVpciBgaW5kZXhgIGFuZCBgY29sbGVjdGlvbmAgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgYXJnc1syXSAhPSAnbnVtYmVyJykgewogICAgICAgIGxlbmd0aCA9IGFyZ3MubGVuZ3RoOwogICAgICB9CiAgICAgIGlmIChsZW5ndGggPiAzICYmIHR5cGVvZiBhcmdzW2xlbmd0aCAtIDJdID09ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soYXJnc1stLWxlbmd0aCAtIDFdLCBhcmdzW2xlbmd0aC0tXSwgMik7CiAgICAgIH0gZWxzZSBpZiAobGVuZ3RoID4gMiAmJiB0eXBlb2YgYXJnc1tsZW5ndGggLSAxXSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmdzWy0tbGVuZ3RoXTsKICAgICAgfQogICAgICB2YXIgc291cmNlcyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxLCBsZW5ndGgpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIHN0YWNrQSA9IGdldEFycmF5KCksCiAgICAgICAgICBzdGFja0IgPSBnZXRBcnJheSgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICBiYXNlTWVyZ2Uob2JqZWN0LCBzb3VyY2VzW2luZGV4XSwgY2FsbGJhY2ssIHN0YWNrQSwgc3RhY2tCKTsKICAgICAgfQogICAgICByZWxlYXNlQXJyYXkoc3RhY2tBKTsKICAgICAgcmVsZWFzZUFycmF5KHN0YWNrQik7CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgc2hhbGxvdyBjbG9uZSBvZiBgb2JqZWN0YCBleGNsdWRpbmcgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YKICAgICAqIHByb3BlcnR5IG5hbWVzLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2gKICAgICAqIHByb3BlcnR5IG9mIGBvYmplY3RgIG9taXR0aW5nIHRoZSBwcm9wZXJ0aWVzIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5CiAgICAgKiBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGtleSwgb2JqZWN0KS4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIHNvdXJjZSBvYmplY3QuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufC4uLnN0cmluZ3xzdHJpbmdbXX0gW2NhbGxiYWNrXSBUaGUgcHJvcGVydGllcyB0byBvbWl0IG9yIHRoZQogICAgICogIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCB3aXRob3V0IHRoZSBvbWl0dGVkIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LCAnYWdlJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICoKICAgICAqIF8ub21pdCh7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9LCBmdW5jdGlvbih2YWx1ZSkgewogICAgICogICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICdudW1iZXInOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICovCiAgICBmdW5jdGlvbiBvbWl0KG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgY2FsbGJhY2sgPT0gJ2Z1bmN0aW9uJywKICAgICAgICAgIHJlc3VsdCA9IHt9OwoKICAgICAgaWYgKGlzRnVuYykgewogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKTsKICAgICAgfQogICAgICBmb3JJbihvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXksIG9iamVjdCkgewogICAgICAgIGlmIChpc0Z1bmMKICAgICAgICAgICAgICA/ICFjYWxsYmFjayh2YWx1ZSwga2V5LCBvYmplY3QpCiAgICAgICAgICAgICAgOiBpbmRleE9mKHByb3BzLCBrZXkpIDwgMAogICAgICAgICAgICApIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSB0d28gZGltZW5zaW9uYWwgYXJyYXkgb2YgYW4gb2JqZWN0J3Mga2V5LXZhbHVlIHBhaXJzLAogICAgICogaS5lLiBgW1trZXkxLCB2YWx1ZTFdLCBba2V5MiwgdmFsdWUyXV1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgbmV3IGFycmF5IG9mIGtleS12YWx1ZSBwYWlycy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5wYWlycyh7ICdtb2UnOiAzMCwgJ2xhcnJ5JzogNDAgfSk7CiAgICAgKiAvLyA9PiBbWydtb2UnLCAzMF0sIFsnbGFycnknLCA0MF1dIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBwYWlycyhvYmplY3QpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBwcm9wcyA9IGtleXMob2JqZWN0KSwKICAgICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCk7CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBwcm9wc1tpbmRleF07CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IFtrZXksIG9iamVjdFtrZXldXTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIHNoYWxsb3cgY2xvbmUgb2YgYG9iamVjdGAgY29tcG9zZWQgb2YgdGhlIHNwZWNpZmllZCBwcm9wZXJ0aWVzLgogICAgICogUHJvcGVydHkgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMgb2YKICAgICAqIHByb3BlcnR5IG5hbWVzLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQgZm9yIGVhY2gKICAgICAqIHByb3BlcnR5IG9mIGBvYmplY3RgIHBpY2tpbmcgdGhlIHByb3BlcnRpZXMgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkKICAgICAqIGZvci4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwga2V5LCBvYmplY3QpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgT2JqZWN0cwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgc291cmNlIG9iamVjdC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258Li4uc3RyaW5nfHN0cmluZ1tdfSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyCiAgICAgKiAgaXRlcmF0aW9uIG9yIHByb3BlcnR5IG5hbWVzIHRvIHBpY2ssIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIHByb3BlcnR5CiAgICAgKiAgbmFtZXMgb3IgYXJyYXlzIG9mIHByb3BlcnR5IG5hbWVzLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGFuIG9iamVjdCBjb21wb3NlZCBvZiB0aGUgcGlja2VkIHByb3BlcnRpZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sICduYW1lJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICoKICAgICAqIF8ucGljayh7ICduYW1lJzogJ21vZScsICdfdXNlcmlkJzogJ21vZTEnIH0sIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAqICAgcmV0dXJuIGtleS5jaGFyQXQoMCkgIT0gJ18nOwogICAgICogfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScgfQogICAgICovCiAgICBmdW5jdGlvbiBwaWNrKG9iamVjdCwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHt9OwogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdmdW5jdGlvbicpIHsKICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgcHJvcHMgPSBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSwKICAgICAgICAgICAgbGVuZ3RoID0gaXNPYmplY3Qob2JqZWN0KSA/IHByb3BzLmxlbmd0aCA6IDA7CgogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICB2YXIga2V5ID0gcHJvcHNbaW5kZXhdOwogICAgICAgICAgaWYgKGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgcmVzdWx0W2tleV0gPSBvYmplY3Rba2V5XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIGZvckluKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSwgb2JqZWN0KSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGtleSwgb2JqZWN0KSkgewogICAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBBbiBhbHRlcm5hdGl2ZSB0byBgXy5yZWR1Y2VgIHRoaXMgbWV0aG9kIHRyYW5zZm9ybXMgYG9iamVjdGAgdG8gYSBuZXcKICAgICAqIGBhY2N1bXVsYXRvcmAgb2JqZWN0IHdoaWNoIGlzIHRoZSByZXN1bHQgb2YgcnVubmluZyBlYWNoIG9mIGl0cyBlbGVtZW50cwogICAgICogdGhyb3VnaCBhIGNhbGxiYWNrLCB3aXRoIGVhY2ggY2FsbGJhY2sgZXhlY3V0aW9uIHBvdGVudGlhbGx5IG11dGF0aW5nCiAgICAgKiB0aGUgYGFjY3VtdWxhdG9yYCBvYmplY3QuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggZm91ciBhcmd1bWVudHM7IChhY2N1bXVsYXRvciwgdmFsdWUsIGtleSwgb2JqZWN0KS4gQ2FsbGJhY2tzIG1heSBleGl0CiAgICAgKiBpdGVyYXRpb24gZWFybHkgYnkgZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IE9iamVjdHMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIFRoZSBjdXN0b20gYWNjdW11bGF0b3IgdmFsdWUuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHNxdWFyZXMgPSBfLnRyYW5zZm9ybShbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdLCBmdW5jdGlvbihyZXN1bHQsIG51bSkgewogICAgICogICBudW0gKj0gbnVtOwogICAgICogICBpZiAobnVtICUgMikgewogICAgICogICAgIHJldHVybiByZXN1bHQucHVzaChudW0pIDwgMzsKICAgICAqICAgfQogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMSwgOSwgMjVdCiAgICAgKgogICAgICogdmFyIG1hcHBlZCA9IF8udHJhbnNmb3JtKHsgJ2EnOiAxLCAnYic6IDIsICdjJzogMyB9LCBmdW5jdGlvbihyZXN1bHQsIG51bSwga2V5KSB7CiAgICAgKiAgIHJlc3VsdFtrZXldID0gbnVtICogMzsKICAgICAqIH0pOwogICAgICogLy8gPT4geyAnYSc6IDMsICdiJzogNiwgJ2MnOiA5IH0KICAgICAqLwogICAgZnVuY3Rpb24gdHJhbnNmb3JtKG9iamVjdCwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpc0FyciA9IGlzQXJyYXkob2JqZWN0KTsKICAgICAgY2FsbGJhY2sgPSBiYXNlQ3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDQpOwoKICAgICAgaWYgKGFjY3VtdWxhdG9yID09IG51bGwpIHsKICAgICAgICBpZiAoaXNBcnIpIHsKICAgICAgICAgIGFjY3VtdWxhdG9yID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBjdG9yID0gb2JqZWN0ICYmIG9iamVjdC5jb25zdHJ1Y3RvciwKICAgICAgICAgICAgICBwcm90byA9IGN0b3IgJiYgY3Rvci5wcm90b3R5cGU7CgogICAgICAgICAgYWNjdW11bGF0b3IgPSBjcmVhdGVPYmplY3QocHJvdG8pOwogICAgICAgIH0KICAgICAgfQogICAgICAoaXNBcnIgPyBmb3JFYWNoIDogZm9yT3duKShvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgb2JqZWN0KSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGFjY3VtdWxhdG9yLCB2YWx1ZSwgaW5kZXgsIG9iamVjdCk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGNvbXBvc2VkIG9mIHRoZSBvd24gZW51bWVyYWJsZSBwcm9wZXJ0eSB2YWx1ZXMgb2YgYG9iamVjdGAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBPYmplY3RzCiAgICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udmFsdWVzKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAgICogLy8gPT4gWzEsIDIsIDNdIChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiB2YWx1ZXMob2JqZWN0KSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgcHJvcHMgPSBrZXlzKG9iamVjdCksCiAgICAgICAgICBsZW5ndGggPSBwcm9wcy5sZW5ndGgsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gb2JqZWN0W3Byb3BzW2luZGV4XV07CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMgZnJvbSB0aGUgc3BlY2lmaWVkIGluZGV4ZXMsIG9yIGtleXMsIG9mIHRoZQogICAgICogYGNvbGxlY3Rpb25gLiBJbmRleGVzIG1heSBiZSBzcGVjaWZpZWQgYXMgaW5kaXZpZHVhbCBhcmd1bWVudHMgb3IgYXMgYXJyYXlzCiAgICAgKiBvZiBpbmRleGVzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0gey4uLihudW1iZXJ8bnVtYmVyW118c3RyaW5nfHN0cmluZ1tdKX0gW2luZGV4XSBUaGUgaW5kZXhlcyBvZiBgY29sbGVjdGlvbmAKICAgICAqICAgdG8gcmV0cmlldmUsIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGluZGV4ZXMgb3IgYXJyYXlzIG9mIGluZGV4ZXMuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgY29ycmVzcG9uZGluZyB0byB0aGUKICAgICAqICBwcm92aWRlZCBpbmRleGVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmF0KFsnYScsICdiJywgJ2MnLCAnZCcsICdlJ10sIFswLCAyLCA0XSk7CiAgICAgKiAvLyA9PiBbJ2EnLCAnYycsICdlJ10KICAgICAqCiAgICAgKiBfLmF0KFsnbW9lJywgJ2xhcnJ5JywgJ2N1cmx5J10sIDAsIDIpOwogICAgICogLy8gPT4gWydtb2UnLCAnY3VybHknXQogICAgICovCiAgICBmdW5jdGlvbiBhdChjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIHByb3BzID0gYmFzZUZsYXR0ZW4oYXJncywgdHJ1ZSwgZmFsc2UsIDEpLAogICAgICAgICAgbGVuZ3RoID0gKGFyZ3NbMl0gJiYgYXJnc1syXVthcmdzWzFdXSA9PT0gY29sbGVjdGlvbikgPyAxIDogcHJvcHMubGVuZ3RoLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKCiAgICAgIHdoaWxlKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gY29sbGVjdGlvbltwcm9wc1tpbmRleF1dOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgYSBnaXZlbiB2YWx1ZSBpcyBwcmVzZW50IGluIGEgY29sbGVjdGlvbiB1c2luZyBzdHJpY3QgZXF1YWxpdHkKICAgICAqIGZvciBjb21wYXJpc29ucywgaS5lLiBgPT09YC4gSWYgYGZyb21JbmRleGAgaXMgbmVnYXRpdmUsIGl0IGlzIHVzZWQgYXMgdGhlCiAgICAgKiBvZmZzZXQgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgaW5jbHVkZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHsqfSB0YXJnZXQgVGhlIHZhbHVlIHRvIGNoZWNrIGZvci4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJvbUluZGV4PTBdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYHRhcmdldGAgZWxlbWVudCBpcyBmb3VuZCwgZWxzZSBgZmFsc2VgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKFsxLCAyLCAzXSwgMSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogXy5jb250YWlucyhbMSwgMiwgM10sIDEsIDIpOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sICdtb2UnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiBfLmNvbnRhaW5zKCdjdXJseScsICd1cicpOwogICAgICogLy8gPT4gdHJ1ZQogICAgICovCiAgICBmdW5jdGlvbiBjb250YWlucyhjb2xsZWN0aW9uLCB0YXJnZXQsIGZyb21JbmRleCkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICBmcm9tSW5kZXggPSAoZnJvbUluZGV4IDwgMCA/IG5hdGl2ZU1heCgwLCBsZW5ndGggKyBmcm9tSW5kZXgpIDogZnJvbUluZGV4KSB8fCAwOwogICAgICBpZiAoaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHJlc3VsdCA9IGluZGV4T2YoY29sbGVjdGlvbiwgdGFyZ2V0LCBmcm9tSW5kZXgpID4gLTE7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHJlc3VsdCA9IChpc1N0cmluZyhjb2xsZWN0aW9uKSA/IGNvbGxlY3Rpb24uaW5kZXhPZih0YXJnZXQsIGZyb21JbmRleCkgOiBpbmRleE9mKGNvbGxlY3Rpb24sIHRhcmdldCwgZnJvbUluZGV4KSkgPiAtMTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgIGlmICgrK2luZGV4ID49IGZyb21JbmRleCkgewogICAgICAgICAgICByZXR1cm4gIShyZXN1bHQgPSB2YWx1ZSA9PT0gdGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBvYmplY3QgY29tcG9zZWQgb2Yga2V5cyBnZW5lcmF0ZWQgZnJvbSB0aGUgcmVzdWx0cyBvZiBydW5uaW5nCiAgICAgKiBlYWNoIGVsZW1lbnQgb2YgYGNvbGxlY3Rpb25gIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZQogICAgICogb2YgZWFjaCBrZXkgaXMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGUga2V5IHdhcyByZXR1cm5lZCBieSB0aGUgY2FsbGJhY2suCiAgICAgKiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOwogICAgICogKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBjb21wb3NlZCBhZ2dyZWdhdGUgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIE1hdGguZmxvb3IobnVtKTsgfSk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWzQuMywgNi4xLCA2LjRdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIHRoaXMuZmxvb3IobnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiB7ICc0JzogMSwgJzYnOiAyIH0KICAgICAqCiAgICAgKiBfLmNvdW50QnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiAyLCAnNSc6IDEgfQogICAgICovCiAgICB2YXIgY291bnRCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldKysgOiByZXN1bHRba2V5XSA9IDEpOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBDaGVja3MgaWYgdGhlIGdpdmVuIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkgdmFsdWUgZm9yICoqYWxsKiogZWxlbWVudHMgb2YKICAgICAqIGEgY29sbGVjdGlvbi4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGFsbAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIGFsbCBlbGVtZW50cyBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ldmVyeShbdHJ1ZSwgMSwgbnVsbCwgJ3llcyddLCBCb29sZWFuKTsKICAgICAqIC8vID0+IGZhbHNlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmV2ZXJ5KHN0b29nZXMsICdhZ2UnKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmV2ZXJ5KHN0b29nZXMsIHsgJ2FnZSc6IDUwIH0pOwogICAgICogLy8gPT4gZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gZXZlcnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdCA9IHRydWU7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmICghKHJlc3VsdCA9ICEhY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiAocmVzdWx0ID0gISFjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyBhbiBhcnJheSBvZiBhbGwgZWxlbWVudHMKICAgICAqIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvci4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQKICAgICAqIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIHNlbGVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGVsZW1lbnRzIHRoYXQgcGFzc2VkIHRoZSBjYWxsYmFjayBjaGVjay4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGV2ZW5zID0gXy5maWx0ZXIoWzEsIDIsIDMsIDQsIDUsIDZdLCBmdW5jdGlvbihudW0pIHsgcmV0dXJuIG51bSAlIDIgPT0gMDsgfSk7CiAgICAgKiAvLyA9PiBbMiwgNCwgNl0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdhcHBsZScsICAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUsICAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5maWx0ZXIoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2NhcnJvdCcsICdvcmdhbmljJzogdHJ1ZSwgJ3R5cGUnOiAndmVnZXRhYmxlJyB9XQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmlsdGVyKGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYXBwbGUnLCAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlsdGVyKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwoKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAoY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSkgewogICAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogSXRlcmF0ZXMgb3ZlciBlbGVtZW50cyBvZiBhIGNvbGxlY3Rpb24sIHJldHVybmluZyB0aGUgZmlyc3QgZWxlbWVudCB0aGF0CiAgICAgKiB0aGUgY2FsbGJhY2sgcmV0dXJucyB0cnVleSBmb3IuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kCiAgICAgKiBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkZXRlY3QsIGZpbmRXaGVyZQogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYHVuZGVmaW5lZGAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZChbMSwgMiwgMywgNF0sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtICUgMiA9PSAwOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlLCAgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmluZChmb29kLCB7ICd0eXBlJzogJ3ZlZ2V0YWJsZScgfSk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ2JlZXQnLCAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpbmQoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlLCAndHlwZSc6ICdmcnVpdCcgfQogICAgICovCiAgICBmdW5jdGlvbiBmaW5kKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcmVzdWx0OwogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCBpdGVyYXRlcyBvdmVyIGVsZW1lbnRzCiAgICAgKiBvZiBhIGBjb2xsZWN0aW9uYCBmcm9tIHJpZ2h0IHRvIGxlZnQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGB1bmRlZmluZWRgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmZpbmRMYXN0KFsxLCAyLCAzLCA0XSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gJSAyID09IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDMKICAgICAqLwogICAgZnVuY3Rpb24gZmluZExhc3QoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIHJlc3VsdDsKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoUmlnaHQoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpIHsKICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBJdGVyYXRlcyBvdmVyIGVsZW1lbnRzIG9mIGEgY29sbGVjdGlvbiwgZXhlY3V0aW5nIHRoZSBjYWxsYmFjayBmb3IgZWFjaAogICAgICogZWxlbWVudC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4gQ2FsbGJhY2tzIG1heSBleGl0IGl0ZXJhdGlvbiBlYXJseSBieQogICAgICogZXhwbGljaXRseSByZXR1cm5pbmcgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIGVhY2gKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl8T2JqZWN0fHN0cmluZ30gUmV0dXJucyBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS5mb3JFYWNoKGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KS5qb2luKCcsJyk7CiAgICAgKiAvLyA9PiBsb2dzIGVhY2ggbnVtYmVyIGFuZCByZXR1cm5zICcxLDIsMycKICAgICAqCiAgICAgKiBfLmZvckVhY2goeyAnb25lJzogMSwgJ3R3byc6IDIsICd0aHJlZSc6IDMgfSwgZnVuY3Rpb24obnVtKSB7IGNvbnNvbGUubG9nKG51bSk7IH0pOwogICAgICogLy8gPT4gbG9ncyBlYWNoIG51bWJlciBhbmQgcmV0dXJucyB0aGUgb2JqZWN0IChwcm9wZXJ0eSBvcmRlciBpcyBub3QgZ3VhcmFudGVlZCBhY3Jvc3MgZW52aXJvbm1lbnRzKQogICAgICovCiAgICBmdW5jdGlvbiBmb3JFYWNoKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgJiYgdHlwZW9mIHRoaXNBcmcgPT0gJ3VuZGVmaW5lZCcgPyBjYWxsYmFjayA6IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2luZGV4XSwgaW5kZXgsIGNvbGxlY3Rpb24pID09PSBmYWxzZSkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGNhbGxiYWNrKTsKICAgICAgfQogICAgICByZXR1cm4gY29sbGVjdGlvbjsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGxpa2UgYF8uZm9yRWFjaGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZWFjaFJpZ2h0CiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQgcGVyIGl0ZXJhdGlvbi4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fE9iamVjdHxzdHJpbmd9IFJldHVybnMgYGNvbGxlY3Rpb25gLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzXSkuZm9yRWFjaFJpZ2h0KGZ1bmN0aW9uKG51bSkgeyBjb25zb2xlLmxvZyhudW0pOyB9KS5qb2luKCcsJyk7CiAgICAgKiAvLyA9PiBsb2dzIGVhY2ggbnVtYmVyIGZyb20gcmlnaHQgdG8gbGVmdCBhbmQgcmV0dXJucyAnMywyLDEnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZvckVhY2hSaWdodChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayAmJiB0eXBlb2YgdGhpc0FyZyA9PSAndW5kZWZpbmVkJyA/IGNhbGxiYWNrIDogYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB3aGlsZSAobGVuZ3RoLS0pIHsKICAgICAgICAgIGlmIChjYWxsYmFjayhjb2xsZWN0aW9uW2xlbmd0aF0sIGxlbmd0aCwgY29sbGVjdGlvbikgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHJvcHMgPSBrZXlzKGNvbGxlY3Rpb24pOwogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgICBmb3JPd24oY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGtleSwgY29sbGVjdGlvbikgewogICAgICAgICAga2V5ID0gcHJvcHMgPyBwcm9wc1stLWxlbmd0aF0gOiAtLWxlbmd0aDsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhjb2xsZWN0aW9uW2tleV0sIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbGxlY3Rpb247CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIG9iamVjdCBjb21wb3NlZCBvZiBrZXlzIGdlbmVyYXRlZCBmcm9tIHRoZSByZXN1bHRzIG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBvZiBhIGNvbGxlY3Rpb24gdGhyb3VnaCB0aGUgY2FsbGJhY2suIFRoZSBjb3JyZXNwb25kaW5nIHZhbHVlCiAgICAgKiBvZiBlYWNoIGtleSBpcyBhbiBhcnJheSBvZiB0aGUgZWxlbWVudHMgcmVzcG9uc2libGUgZm9yIGdlbmVyYXRpbmcgdGhlIGtleS4KICAgICAqIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7CiAgICAgKiAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAKICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5ncm91cEJ5KFs0LjIsIDYuMSwgNi40XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBNYXRoLmZsb29yKG51bSk7IH0pOwogICAgICogLy8gPT4geyAnNCc6IFs0LjJdLCAnNic6IFs2LjEsIDYuNF0gfQogICAgICoKICAgICAqIF8uZ3JvdXBCeShbNC4yLCA2LjEsIDYuNF0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5mbG9vcihudW0pOyB9LCBNYXRoKTsKICAgICAqIC8vID0+IHsgJzQnOiBbNC4yXSwgJzYnOiBbNi4xLCA2LjRdIH0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmdyb3VwQnkoWydvbmUnLCAndHdvJywgJ3RocmVlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IHsgJzMnOiBbJ29uZScsICd0d28nXSwgJzUnOiBbJ3RocmVlJ10gfQogICAgICovCiAgICB2YXIgZ3JvdXBCeSA9IGNyZWF0ZUFnZ3JlZ2F0b3IoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7CiAgICAgIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHJlc3VsdCwga2V5KSA/IHJlc3VsdFtrZXldIDogcmVzdWx0W2tleV0gPSBbXSkucHVzaCh2YWx1ZSk7CiAgICB9KTsKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIGtleXMgZ2VuZXJhdGVkIGZyb20gdGhlIHJlc3VsdHMgb2YgcnVubmluZwogICAgICogZWFjaCBlbGVtZW50IG9mIHRoZSBjb2xsZWN0aW9uIHRocm91Z2ggdGhlIGdpdmVuIGNhbGxiYWNrLiBUaGUgY29ycmVzcG9uZGluZwogICAgICogdmFsdWUgb2YgZWFjaCBrZXkgaXMgdGhlIGxhc3QgZWxlbWVudCByZXNwb25zaWJsZSBmb3IgZ2VuZXJhdGluZyB0aGUga2V5LgogICAgICogVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsKICAgICAqICh2YWx1ZSwgaW5kZXh8a2V5LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY29tcG9zZWQgYWdncmVnYXRlIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGtleXMgPSBbCiAgICAgKiAgIHsgJ2Rpcic6ICdsZWZ0JywgJ2NvZGUnOiA5NyB9LAogICAgICogICB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8uaW5kZXhCeShrZXlzLCAnZGlyJyk7CiAgICAgKiAvLyA9PiB7ICdsZWZ0JzogeyAnZGlyJzogJ2xlZnQnLCAnY29kZSc6IDk3IH0sICdyaWdodCc6IHsgJ2Rpcic6ICdyaWdodCcsICdjb2RlJzogMTAwIH0gfQogICAgICoKICAgICAqIF8uaW5kZXhCeShrZXlzLCBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoa2V5LmNvZGUpOyB9KTsKICAgICAqIC8vID0+IHsgJ2EnOiB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwgJ2QnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqCiAgICAgKiBfLmluZGV4Qnkoc3Rvb2dlcywgZnVuY3Rpb24oa2V5KSB7IHRoaXMuZnJvbUNoYXJDb2RlKGtleS5jb2RlKTsgfSwgU3RyaW5nKTsKICAgICAqIC8vID0+IHsgJ2EnOiB7ICdkaXInOiAnbGVmdCcsICdjb2RlJzogOTcgfSwgJ2QnOiB7ICdkaXInOiAncmlnaHQnLCAnY29kZSc6IDEwMCB9IH0KICAgICAqLwogICAgdmFyIGluZGV4QnkgPSBjcmVhdGVBZ2dyZWdhdG9yKGZ1bmN0aW9uKHJlc3VsdCwgdmFsdWUsIGtleSkgewogICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgfSk7CgogICAgLyoqCiAgICAgKiBJbnZva2VzIHRoZSBtZXRob2QgbmFtZWQgYnkgYG1ldGhvZE5hbWVgIG9uIGVhY2ggZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gCiAgICAgKiByZXR1cm5pbmcgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBpbnZva2VkIG1ldGhvZC4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgICAqIHdpbGwgYmUgcHJvdmlkZWQgdG8gZWFjaCBpbnZva2VkIG1ldGhvZC4gSWYgYG1ldGhvZE5hbWVgIGlzIGEgZnVuY3Rpb24gaXQKICAgICAqIHdpbGwgYmUgaW52b2tlZCBmb3IsIGFuZCBgdGhpc2AgYm91bmQgdG8sIGVhY2ggZWxlbWVudCBpbiB0aGUgYGNvbGxlY3Rpb25gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gbWV0aG9kTmFtZSBUaGUgbmFtZSBvZiB0aGUgbWV0aG9kIHRvIGludm9rZSBvcgogICAgICogIHRoZSBmdW5jdGlvbiBpbnZva2VkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIG1ldGhvZCB3aXRoLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggaW52b2tlZCBtZXRob2QuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uaW52b2tlKFtbNSwgMSwgN10sIFszLCAyLCAxXV0sICdzb3J0Jyk7CiAgICAgKiAvLyA9PiBbWzEsIDUsIDddLCBbMSwgMiwgM11dCiAgICAgKgogICAgICogXy5pbnZva2UoWzEyMywgNDU2XSwgU3RyaW5nLnByb3RvdHlwZS5zcGxpdCwgJycpOwogICAgICogLy8gPT4gW1snMScsICcyJywgJzMnXSwgWyc0JywgJzUnLCAnNiddXQogICAgICovCiAgICBmdW5jdGlvbiBpbnZva2UoY29sbGVjdGlvbiwgbWV0aG9kTmFtZSkgewogICAgICB2YXIgYXJncyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwKICAgICAgICAgIGluZGV4ID0gLTEsCiAgICAgICAgICBpc0Z1bmMgPSB0eXBlb2YgbWV0aG9kTmFtZSA9PSAnZnVuY3Rpb24nLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICByZXN1bHRbKytpbmRleF0gPSAoaXNGdW5jID8gbWV0aG9kTmFtZSA6IHZhbHVlW21ldGhvZE5hbWVdKS5hcHBseSh2YWx1ZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiB2YWx1ZXMgYnkgcnVubmluZyBlYWNoIGVsZW1lbnQgaW4gdGhlIGNvbGxlY3Rpb24KICAgICAqIHRocm91Z2ggdGhlIGNhbGxiYWNrLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgY29sbGVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIHRoZSByZXN1bHRzIG9mIGVhY2ggYGNhbGxiYWNrYCBleGVjdXRpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWFwKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiAzOyB9KTsKICAgICAqIC8vID0+IFszLCA2LCA5XQogICAgICoKICAgICAqIF8ubWFwKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICogMzsgfSk7CiAgICAgKiAvLyA9PiBbMywgNiwgOV0gKHByb3BlcnR5IG9yZGVyIGlzIG5vdCBndWFyYW50ZWVkIGFjcm9zcyBlbnZpcm9ubWVudHMpCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1hcChzdG9vZ2VzLCAnbmFtZScpOwogICAgICogLy8gPT4gWydtb2UnLCAnbGFycnknXQogICAgICovCiAgICBmdW5jdGlvbiBtYXAoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJykgewogICAgICAgIHZhciByZXN1bHQgPSBBcnJheShsZW5ndGgpOwogICAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgICByZXN1bHRbaW5kZXhdID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJlc3VsdFsrK2luZGV4XSA9IGNhbGxiYWNrKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXRyaWV2ZXMgdGhlIG1heGltdW0gdmFsdWUgb2YgYSBjb2xsZWN0aW9uLiBJZiB0aGUgY29sbGVjdGlvbiBpcyBlbXB0eSBvcgogICAgICogZmFsc2V5IGAtSW5maW5pdHlgIGlzIHJldHVybmVkLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQKICAgICAqIGZvciBlYWNoIHZhbHVlIGluIHRoZSBjb2xsZWN0aW9uIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlCiAgICAgKiBpcyByYW5rZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1heGltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWF4KFs0LCAyLCA4LCA2XSk7CiAgICAgKiAvLyA9PiA4CiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1heChzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9OwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ubWF4KHN0b29nZXMsICdhZ2UnKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfTsKICAgICAqLwogICAgZnVuY3Rpb24gbWF4KGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBjb21wdXRlZCA9IC1JbmZpbml0eSwKICAgICAgICAgIHJlc3VsdCA9IGNvbXB1dGVkOwoKICAgICAgaWYgKCFjYWxsYmFjayAmJiBpc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgdmFyIHZhbHVlID0gY29sbGVjdGlvbltpbmRleF07CiAgICAgICAgICBpZiAodmFsdWUgPiByZXN1bHQpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGNhbGxiYWNrID0gKCFjYWxsYmFjayAmJiBpc1N0cmluZyhjb2xsZWN0aW9uKSkKICAgICAgICAgID8gY2hhckF0Q2FsbGJhY2sKICAgICAgICAgIDogbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgICAgZm9yRWFjaChjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHZhciBjdXJyZW50ID0gY2FsbGJhY2sodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICAgIGlmIChjdXJyZW50ID4gY29tcHV0ZWQpIHsKICAgICAgICAgICAgY29tcHV0ZWQgPSBjdXJyZW50OwogICAgICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmV0cmlldmVzIHRoZSBtaW5pbXVtIHZhbHVlIG9mIGEgY29sbGVjdGlvbi4gSWYgdGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkgb3IKICAgICAqIGZhbHNleSBgSW5maW5pdHlgIGlzIHJldHVybmVkLiBJZiBhIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgZXhlY3V0ZWQKICAgICAqIGZvciBlYWNoIHZhbHVlIGluIHRoZSBjb2xsZWN0aW9uIHRvIGdlbmVyYXRlIHRoZSBjcml0ZXJpb24gYnkgd2hpY2ggdGhlIHZhbHVlCiAgICAgKiBpcyByYW5rZWQuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQgd2l0aCB0aHJlZQogICAgICogYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIG1pbmltdW0gdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubWluKFs0LCAyLCA4LCA2XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLm1pbihzdG9vZ2VzLCBmdW5jdGlvbihzdG9vZ2UpIHsgcmV0dXJuIHN0b29nZS5hZ2U7IH0pOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLm1pbihzdG9vZ2VzLCAnYWdlJyk7CiAgICAgKiAvLyA9PiB7ICduYW1lJzogJ21vZScsICdhZ2UnOiA0MCB9OwogICAgICovCiAgICBmdW5jdGlvbiBtaW4oY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gSW5maW5pdHksCiAgICAgICAgICByZXN1bHQgPSBjb21wdXRlZDsKCiAgICAgIGlmICghY2FsbGJhY2sgJiYgaXNBcnJheShjb2xsZWN0aW9uKSkgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uLmxlbmd0aDsKCiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIHZhciB2YWx1ZSA9IGNvbGxlY3Rpb25baW5kZXhdOwogICAgICAgICAgaWYgKHZhbHVlIDwgcmVzdWx0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBjYWxsYmFjayA9ICghY2FsbGJhY2sgJiYgaXNTdHJpbmcoY29sbGVjdGlvbikpCiAgICAgICAgICA/IGNoYXJBdENhbGxiYWNrCiAgICAgICAgICA6IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CgogICAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgICB2YXIgY3VycmVudCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgICAgICBpZiAoY3VycmVudCA8IGNvbXB1dGVkKSB7CiAgICAgICAgICAgIGNvbXB1dGVkID0gY3VycmVudDsKICAgICAgICAgICAgcmVzdWx0ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyB0aGUgdmFsdWUgb2YgYSBzcGVjaWZpZWQgcHJvcGVydHkgZnJvbSBhbGwgZWxlbWVudHMgaW4gdGhlIGBjb2xsZWN0aW9uYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQHR5cGUgRnVuY3Rpb24KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBUaGUgcHJvcGVydHkgdG8gcGx1Y2suCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgcHJvcGVydHkgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIF8ucGx1Y2soc3Rvb2dlcywgJ25hbWUnKTsKICAgICAqIC8vID0+IFsnbW9lJywgJ2xhcnJ5J10KICAgICAqLwogICAgZnVuY3Rpb24gcGx1Y2soY29sbGVjdGlvbiwgcHJvcGVydHkpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICB2YXIgcmVzdWx0ID0gQXJyYXkobGVuZ3RoKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNvbGxlY3Rpb25baW5kZXhdW3Byb3BlcnR5XTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdCB8fCBtYXAoY29sbGVjdGlvbiwgcHJvcGVydHkpOwogICAgfQoKICAgIC8qKgogICAgICogUmVkdWNlcyBhIGNvbGxlY3Rpb24gdG8gYSB2YWx1ZSB3aGljaCBpcyB0aGUgYWNjdW11bGF0ZWQgcmVzdWx0IG9mIHJ1bm5pbmcKICAgICAqIGVhY2ggZWxlbWVudCBpbiB0aGUgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjaywgd2hlcmUgZWFjaCBzdWNjZXNzaXZlCiAgICAgKiBjYWxsYmFjayBleGVjdXRpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgcHJldmlvdXMgZXhlY3V0aW9uLiBJZgogICAgICogYGFjY3VtdWxhdG9yYCBpcyBub3QgcHJvdmlkZWQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgdGhlIGNvbGxlY3Rpb24gd2lsbCBiZQogICAgICogdXNlZCBhcyB0aGUgaW5pdGlhbCBgYWNjdW11bGF0b3JgIHZhbHVlLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgCiAgICAgKiBhbmQgaW52b2tlZCB3aXRoIGZvdXIgYXJndW1lbnRzOyAoYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZGwsIGluamVjdAogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaXRlcmF0ZSBvdmVyLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkIHBlciBpdGVyYXRpb24uCiAgICAgKiBAcGFyYW0geyp9IFthY2N1bXVsYXRvcl0gSW5pdGlhbCB2YWx1ZSBvZiB0aGUgYWNjdW11bGF0b3IuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBhY2N1bXVsYXRlZCB2YWx1ZS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN1bSA9IF8ucmVkdWNlKFsxLCAyLCAzXSwgZnVuY3Rpb24oc3VtLCBudW0pIHsKICAgICAqICAgcmV0dXJuIHN1bSArIG51bTsKICAgICAqIH0pOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIHZhciBtYXBwZWQgPSBfLnJlZHVjZSh7ICdhJzogMSwgJ2InOiAyLCAnYyc6IDMgfSwgZnVuY3Rpb24ocmVzdWx0LCBudW0sIGtleSkgewogICAgICogICByZXN1bHRba2V5XSA9IG51bSAqIDM7CiAgICAgKiAgIHJldHVybiByZXN1bHQ7CiAgICAgKiB9LCB7fSk7CiAgICAgKiAvLyA9PiB7ICdhJzogMywgJ2InOiA2LCAnYyc6IDkgfQogICAgICovCiAgICBmdW5jdGlvbiByZWR1Y2UoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIGlmICghY29sbGVjdGlvbikgcmV0dXJuIGFjY3VtdWxhdG9yOwogICAgICB2YXIgbm9hY2N1bSA9IGFyZ3VtZW50cy5sZW5ndGggPCAzOwogICAgICBjYWxsYmFjayA9IGJhc2VDcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgNCk7CgogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwoKICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicpIHsKICAgICAgICBpZiAobm9hY2N1bSkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjb2xsZWN0aW9uWysraW5kZXhdOwogICAgICAgIH0KICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBjYWxsYmFjayhhY2N1bXVsYXRvciwgY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yT3duKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgICAgYWNjdW11bGF0b3IgPSBub2FjY3VtCiAgICAgICAgICAgID8gKG5vYWNjdW0gPSBmYWxzZSwgdmFsdWUpCiAgICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLnJlZHVjZWAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgZm9sZHIKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbYWNjdW11bGF0b3JdIEluaXRpYWwgdmFsdWUgb2YgdGhlIGFjY3VtdWxhdG9yLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyB0aGUgYWNjdW11bGF0ZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsaXN0ID0gW1swLCAxXSwgWzIsIDNdLCBbNCwgNV1dOwogICAgICogdmFyIGZsYXQgPSBfLnJlZHVjZVJpZ2h0KGxpc3QsIGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEuY29uY2F0KGIpOyB9LCBbXSk7CiAgICAgKiAvLyA9PiBbNCwgNSwgMiwgMywgMCwgMV0KICAgICAqLwogICAgZnVuY3Rpb24gcmVkdWNlUmlnaHQoY29sbGVjdGlvbiwgY2FsbGJhY2ssIGFjY3VtdWxhdG9yLCB0aGlzQXJnKSB7CiAgICAgIHZhciBub2FjY3VtID0gYXJndW1lbnRzLmxlbmd0aCA8IDM7CiAgICAgIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCA0KTsKICAgICAgZm9yRWFjaFJpZ2h0KGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikgewogICAgICAgIGFjY3VtdWxhdG9yID0gbm9hY2N1bQogICAgICAgICAgPyAobm9hY2N1bSA9IGZhbHNlLCB2YWx1ZSkKICAgICAgICAgIDogY2FsbGJhY2soYWNjdW11bGF0b3IsIHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbik7CiAgICAgIH0pOwogICAgICByZXR1cm4gYWNjdW11bGF0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uZmlsdGVyYCB0aGlzIG1ldGhvZCByZXR1cm5zIHRoZSBlbGVtZW50cyBvZiBhCiAgICAgKiBjb2xsZWN0aW9uIHRoYXQgdGhlIGNhbGxiYWNrIGRvZXMgKipub3QqKiByZXR1cm4gdHJ1ZXkgZm9yLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBmYWlsZWQgdGhlIGNhbGxiYWNrIGNoZWNrLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2RkcyA9IF8ucmVqZWN0KFsxLCAyLCAzLCA0LCA1LCA2XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICogLy8gPT4gWzEsIDMsIDVdCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ29yZ2FuaWMnOiBmYWxzZSwgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlLCAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVqZWN0KGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdhcHBsZScsICdvcmdhbmljJzogZmFsc2UsICd0eXBlJzogJ2ZydWl0JyB9XQogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVqZWN0KGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlLCAndHlwZSc6ICd2ZWdldGFibGUnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlamVjdChjb2xsZWN0aW9uLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHJldHVybiBmaWx0ZXIoY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBjb2xsZWN0aW9uKSB7CiAgICAgICAgcmV0dXJuICFjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHJpZXZlcyBhIHJhbmRvbSBlbGVtZW50IG9yIGBuYCByYW5kb20gZWxlbWVudHMgZnJvbSBhIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNhbXBsZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbl0gVGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBzYW1wbGUuCiAgICAgKiBAcGFyYW0tIHtPYmplY3R9IFtndWFyZF0gQWxsb3dzIHdvcmtpbmcgd2l0aCBmdW5jdGlvbnMsIGxpa2UgYF8ubWFwYCwKICAgICAqICB3aXRob3V0IHVzaW5nIHRoZWlyIGBrZXlgIGFuZCBgb2JqZWN0YCBhcmd1bWVudHMgYXMgc291cmNlcy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyB0aGUgcmFuZG9tIHNhbXBsZShzKSBvZiBgY29sbGVjdGlvbmAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uc2FtcGxlKFsxLCAyLCAzLCA0XSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zYW1wbGUoWzEsIDIsIDMsIDRdLCAyKTsKICAgICAqIC8vID0+IFszLCAxXQogICAgICovCiAgICBmdW5jdGlvbiBzYW1wbGUoY29sbGVjdGlvbiwgbiwgZ3VhcmQpIHsKICAgICAgdmFyIGxlbmd0aCA9IGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uLmxlbmd0aCA6IDA7CiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoICE9ICdudW1iZXInKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IHZhbHVlcyhjb2xsZWN0aW9uKTsKICAgICAgfQogICAgICBpZiAobiA9PSBudWxsIHx8IGd1YXJkKSB7CiAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24gPyBjb2xsZWN0aW9uW3JhbmRvbShsZW5ndGggLSAxKV0gOiB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgdmFyIHJlc3VsdCA9IHNodWZmbGUoY29sbGVjdGlvbik7CiAgICAgIHJlc3VsdC5sZW5ndGggPSBuYXRpdmVNaW4obmF0aXZlTWF4KDAsIG4pLCByZXN1bHQubGVuZ3RoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2Ygc2h1ZmZsZWQgdmFsdWVzLCB1c2luZyBhIHZlcnNpb24gb2YgdGhlIEZpc2hlci1ZYXRlcwogICAgICogc2h1ZmZsZS4gU2VlIGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRmlzaGVyLVlhdGVzX3NodWZmbGUuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIHNodWZmbGUuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgc2h1ZmZsZWQgY29sbGVjdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaHVmZmxlKFsxLCAyLCAzLCA0LCA1LCA2XSk7CiAgICAgKiAvLyA9PiBbNCwgMSwgNiwgMywgNSwgMl0KICAgICAqLwogICAgZnVuY3Rpb24gc2h1ZmZsZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KHR5cGVvZiBsZW5ndGggPT0gJ251bWJlcicgPyBsZW5ndGggOiAwKTsKCiAgICAgIGZvckVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB2YXIgcmFuZCA9IHJhbmRvbSgrK2luZGV4KTsKICAgICAgICByZXN1bHRbaW5kZXhdID0gcmVzdWx0W3JhbmRdOwogICAgICAgIHJlc3VsdFtyYW5kXSA9IHZhbHVlOwogICAgICB9KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEdldHMgdGhlIHNpemUgb2YgdGhlIGBjb2xsZWN0aW9uYCBieSByZXR1cm5pbmcgYGNvbGxlY3Rpb24ubGVuZ3RoYCBmb3IgYXJyYXlzCiAgICAgKiBhbmQgYXJyYXktbGlrZSBvYmplY3RzIG9yIHRoZSBudW1iZXIgb2Ygb3duIGVudW1lcmFibGUgcHJvcGVydGllcyBmb3Igb2JqZWN0cy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IENvbGxlY3Rpb25zCiAgICAgKiBAcGFyYW0ge0FycmF5fE9iamVjdHxzdHJpbmd9IGNvbGxlY3Rpb24gVGhlIGNvbGxlY3Rpb24gdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgYGNvbGxlY3Rpb24ubGVuZ3RoYCBvciBudW1iZXIgb2Ygb3duIGVudW1lcmFibGUgcHJvcGVydGllcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zaXplKFsxLCAyXSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKgogICAgICogXy5zaXplKHsgJ29uZSc6IDEsICd0d28nOiAyLCAndGhyZWUnOiAzIH0pOwogICAgICogLy8gPT4gMwogICAgICoKICAgICAqIF8uc2l6ZSgnY3VybHknKTsKICAgICAqIC8vID0+IDUKICAgICAqLwogICAgZnVuY3Rpb24gc2l6ZShjb2xsZWN0aW9uKSB7CiAgICAgIHZhciBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwOwogICAgICByZXR1cm4gdHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IGtleXMoY29sbGVjdGlvbikubGVuZ3RoOwogICAgfQoKICAgIC8qKgogICAgICogQ2hlY2tzIGlmIHRoZSBjYWxsYmFjayByZXR1cm5zIGEgdHJ1ZXkgdmFsdWUgZm9yICoqYW55KiogZWxlbWVudCBvZiBhCiAgICAgKiBjb2xsZWN0aW9uLiBUaGUgZnVuY3Rpb24gcmV0dXJucyBhcyBzb29uIGFzIGl0IGZpbmRzIGEgcGFzc2luZyB2YWx1ZSBhbmQKICAgICAqIGRvZXMgbm90IGl0ZXJhdGUgb3ZlciB0aGUgZW50aXJlIGNvbGxlY3Rpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0bwogICAgICogYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4fGtleSwgY29sbGVjdGlvbikuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBhbnkKICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGl0ZXJhdGUgb3Zlci4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiBhbnkgZWxlbWVudCBwYXNzZWQgdGhlIGNhbGxiYWNrIGNoZWNrLAogICAgICogIGVsc2UgYGZhbHNlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5zb21lKFtudWxsLCAwLCAneWVzJywgZmFsc2VdLCBCb29sZWFuKTsKICAgICAqIC8vID0+IHRydWUKICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdhcHBsZScsICAnb3JnYW5pYyc6IGZhbHNlLCAndHlwZSc6ICdmcnVpdCcgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUsICAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5zb21lKGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5zb21lKGZvb2QsIHsgJ3R5cGUnOiAnbWVhdCcgfSk7CiAgICAgKiAvLyA9PiBmYWxzZQogICAgICovCiAgICBmdW5jdGlvbiBzb21lKGNvbGxlY3Rpb24sIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciByZXN1bHQ7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gY29sbGVjdGlvbiA/IGNvbGxlY3Rpb24ubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgbGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICAgIGlmICgocmVzdWx0ID0gY2FsbGJhY2soY29sbGVjdGlvbltpbmRleF0sIGluZGV4LCBjb2xsZWN0aW9uKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvck93bihjb2xsZWN0aW9uLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGNvbGxlY3Rpb24pIHsKICAgICAgICAgIHJldHVybiAhKHJlc3VsdCA9IGNhbGxiYWNrKHZhbHVlLCBpbmRleCwgY29sbGVjdGlvbikpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiAhIXJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZWxlbWVudHMsIHNvcnRlZCBpbiBhc2NlbmRpbmcgb3JkZXIgYnkgdGhlIHJlc3VsdHMgb2YKICAgICAqIHJ1bm5pbmcgZWFjaCBlbGVtZW50IGluIGEgY29sbGVjdGlvbiB0aHJvdWdoIHRoZSBjYWxsYmFjay4gVGhpcyBtZXRob2QKICAgICAqIHBlcmZvcm1zIGEgc3RhYmxlIHNvcnQsIHRoYXQgaXMsIGl0IHdpbGwgcHJlc2VydmUgdGhlIG9yaWdpbmFsIHNvcnQgb3JkZXIKICAgICAqIG9mIGVxdWFsIGVsZW1lbnRzLiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGgKICAgICAqIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleHxrZXksIGNvbGxlY3Rpb24pLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2Ygc29ydGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gTWF0aC5zaW4obnVtKTsgfSk7CiAgICAgKiAvLyA9PiBbMywgMSwgMl0KICAgICAqCiAgICAgKiBfLnNvcnRCeShbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gdGhpcy5zaW4obnVtKTsgfSwgTWF0aCk7CiAgICAgKiAvLyA9PiBbMywgMSwgMl0KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnNvcnRCeShbJ2JhbmFuYScsICdzdHJhd2JlcnJ5JywgJ2FwcGxlJ10sICdsZW5ndGgnKTsKICAgICAqIC8vID0+IFsnYXBwbGUnLCAnYmFuYW5hJywgJ3N0cmF3YmVycnknXQogICAgICovCiAgICBmdW5jdGlvbiBzb3J0QnkoY29sbGVjdGlvbiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBjb2xsZWN0aW9uID8gY29sbGVjdGlvbi5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gQXJyYXkodHlwZW9mIGxlbmd0aCA9PSAnbnVtYmVyJyA/IGxlbmd0aCA6IDApOwoKICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICBmb3JFYWNoKGNvbGxlY3Rpb24sIGZ1bmN0aW9uKHZhbHVlLCBrZXksIGNvbGxlY3Rpb24pIHsKICAgICAgICB2YXIgb2JqZWN0ID0gcmVzdWx0WysraW5kZXhdID0gZ2V0T2JqZWN0KCk7CiAgICAgICAgb2JqZWN0LmNyaXRlcmlhID0gY2FsbGJhY2sodmFsdWUsIGtleSwgY29sbGVjdGlvbik7CiAgICAgICAgb2JqZWN0LmluZGV4ID0gaW5kZXg7CiAgICAgICAgb2JqZWN0LnZhbHVlID0gdmFsdWU7CiAgICAgIH0pOwoKICAgICAgbGVuZ3RoID0gcmVzdWx0Lmxlbmd0aDsKICAgICAgcmVzdWx0LnNvcnQoY29tcGFyZUFzY2VuZGluZyk7CiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIHZhciBvYmplY3QgPSByZXN1bHRbbGVuZ3RoXTsKICAgICAgICByZXN1bHRbbGVuZ3RoXSA9IG9iamVjdC52YWx1ZTsKICAgICAgICByZWxlYXNlT2JqZWN0KG9iamVjdCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENvbnZlcnRzIHRoZSBgY29sbGVjdGlvbmAgdG8gYW4gYXJyYXkuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDb2xsZWN0aW9ucwogICAgICogQHBhcmFtIHtBcnJheXxPYmplY3R8c3RyaW5nfSBjb2xsZWN0aW9uIFRoZSBjb2xsZWN0aW9uIHRvIGNvbnZlcnQuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgdGhlIG5ldyBjb252ZXJ0ZWQgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIChmdW5jdGlvbigpIHsgcmV0dXJuIF8udG9BcnJheShhcmd1bWVudHMpLnNsaWNlKDEpOyB9KSgxLCAyLCAzLCA0KTsKICAgICAqIC8vID0+IFsyLCAzLCA0XQogICAgICovCiAgICBmdW5jdGlvbiB0b0FycmF5KGNvbGxlY3Rpb24pIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gJiYgdHlwZW9mIGNvbGxlY3Rpb24ubGVuZ3RoID09ICdudW1iZXInKSB7CiAgICAgICAgcmV0dXJuIHNsaWNlKGNvbGxlY3Rpb24pOwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZXMoY29sbGVjdGlvbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBQZXJmb3JtcyBhIGRlZXAgY29tcGFyaXNvbiBvZiBlYWNoIGVsZW1lbnQgaW4gYSBgY29sbGVjdGlvbmAgdG8gdGhlIGdpdmVuCiAgICAgKiBgcHJvcGVydGllc2Agb2JqZWN0LCByZXR1cm5pbmcgYW4gYXJyYXkgb2YgYWxsIGVsZW1lbnRzIHRoYXQgaGF2ZSBlcXVpdmFsZW50CiAgICAgKiBwcm9wZXJ0eSB2YWx1ZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEB0eXBlIEZ1bmN0aW9uCiAgICAgKiBAY2F0ZWdvcnkgQ29sbGVjdGlvbnMKICAgICAqIEBwYXJhbSB7QXJyYXl8T2JqZWN0fHN0cmluZ30gY29sbGVjdGlvbiBUaGUgY29sbGVjdGlvbiB0byBpdGVyYXRlIG92ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gcHJvcGVydGllcyBUaGUgb2JqZWN0IG9mIHByb3BlcnR5IHZhbHVlcyB0byBmaWx0ZXIgYnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgYXJyYXkgb2YgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBnaXZlbiBwcm9wZXJ0aWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiAzMCwgJ3F1b3Rlcyc6IFsnT2gsIGEgd2lzZSBndXksIGVoPycsICdQb2lmZWN0ISddIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwLCAncXVvdGVzJzogWydTcHJlYWQgb3V0IScsICdZb3Uga251Y2tsZWhlYWQhJ10gfQogICAgICogXTsKICAgICAqCiAgICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ2FnZSc6IDQwIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwLCAncXVvdGVzJzogWydTcHJlYWQgb3V0IScsICdZb3Uga251Y2tsZWhlYWQhJ10gfV0KICAgICAqCiAgICAgKiBfLndoZXJlKHN0b29nZXMsIHsgJ3F1b3Rlcyc6IFsnUG9pZmVjdCEnXSB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2N1cmx5JywgJ2FnZSc6IDMwLCAncXVvdGVzJzogWydPaCwgYSB3aXNlIGd1eSwgZWg/JywgJ1BvaWZlY3QhJ10gfV0KICAgICAqLwogICAgdmFyIHdoZXJlID0gZmlsdGVyOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSB3aXRoIGFsbCBmYWxzZXkgdmFsdWVzIHJlbW92ZWQuIFRoZSB2YWx1ZXMgYGZhbHNlYCwgYG51bGxgLAogICAgICogYDBgLCBgIiJgLCBgdW5kZWZpbmVkYCwgYW5kIGBOYU5gIGFyZSBhbGwgZmFsc2V5LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gY29tcGFjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBmaWx0ZXJlZCB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uY29tcGFjdChbMCwgMSwgZmFsc2UsIDIsICcnLCAzXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gY29tcGFjdChhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IGV4Y2x1ZGluZyBhbGwgdmFsdWVzIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcgc3RyaWN0CiAgICAgKiBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBwcm9jZXNzLgogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5XSBUaGUgYXJyYXlzIG9mIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5kaWZmZXJlbmNlKFsxLCAyLCAzLCA0LCA1XSwgWzUsIDIsIDEwXSk7CiAgICAgKiAvLyA9PiBbMSwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gZGlmZmVyZW5jZShhcnJheSkgewogICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgIGluZGV4T2YgPSBnZXRJbmRleE9mKCksCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDAsCiAgICAgICAgICBzZWVuID0gYmFzZUZsYXR0ZW4oYXJndW1lbnRzLCB0cnVlLCB0cnVlLCAxKSwKICAgICAgICAgIHJlc3VsdCA9IFtdOwoKICAgICAgdmFyIGlzTGFyZ2UgPSBsZW5ndGggPj0gbGFyZ2VBcnJheVNpemUgJiYgaW5kZXhPZiA9PT0gYmFzZUluZGV4T2Y7CgogICAgICBpZiAoaXNMYXJnZSkgewogICAgICAgIHZhciBjYWNoZSA9IGNyZWF0ZUNhY2hlKHNlZW4pOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgaW5kZXhPZiA9IGNhY2hlSW5kZXhPZjsKICAgICAgICAgIHNlZW4gPSBjYWNoZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaXNMYXJnZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciB2YWx1ZSA9IGFycmF5W2luZGV4XTsKICAgICAgICBpZiAoaW5kZXhPZihzZWVuLCB2YWx1ZSkgPCAwKSB7CiAgICAgICAgICByZXN1bHQucHVzaCh2YWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChpc0xhcmdlKSB7CiAgICAgICAgcmVsZWFzZU9iamVjdChzZWVuKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5maW5kYCBleGNlcHQgdGhhdCBpdCByZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgZmlyc3QKICAgICAqIGVsZW1lbnQgdGhhdCBwYXNzZXMgdGhlIGNhbGxiYWNrIGNoZWNrLCBpbnN0ZWFkIG9mIHRoZSBlbGVtZW50IGl0c2VsZi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHNlYXJjaC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBmb3VuZCBlbGVtZW50LCBlbHNlIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmluZEluZGV4KFsnYXBwbGUnLCAnYmFuYW5hJywgJ2JlZXQnXSwgZnVuY3Rpb24oZm9vZCkgewogICAgICogICByZXR1cm4gL15iLy50ZXN0KGZvb2QpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRJbmRleChhcnJheSwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmV0dXJuIGluZGV4OwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBsaWtlIGBfLmZpbmRJbmRleGAgZXhjZXB0IHRoYXQgaXQgaXRlcmF0ZXMgb3ZlciBlbGVtZW50cwogICAgICogb2YgYSBgY29sbGVjdGlvbmAgZnJvbSByaWdodCB0byBsZWZ0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gc2VhcmNoLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgaW5kZXggb2YgdGhlIGZvdW5kIGVsZW1lbnQsIGVsc2UgYC0xYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5maW5kTGFzdEluZGV4KFsnYXBwbGUnLCAnYmFuYW5hJywgJ2JlZXQnXSwgZnVuY3Rpb24oZm9vZCkgewogICAgICogICByZXR1cm4gL15iLy50ZXN0KGZvb2QpOwogICAgICogfSk7CiAgICAgKiAvLyA9PiAyCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpbmRMYXN0SW5kZXgoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgICAgaWYgKGNhbGxiYWNrKGFycmF5W2xlbmd0aF0sIGxlbmd0aCwgYXJyYXkpKSB7CiAgICAgICAgICByZXR1cm4gbGVuZ3RoOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBmaXJzdCBlbGVtZW50IG9yIGZpcnN0IGBuYCBlbGVtZW50cyBvZiBhbiBhcnJheS4gSWYgYSBjYWxsYmFjawogICAgICogaXMgcHJvdmlkZWQgZWxlbWVudHMgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgYXJyYXkgYXJlIHJldHVybmVkIGFzIGxvbmcKICAgICAqIGFzIHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5LiBUaGUgY2FsbGJhY2sgaXMgYm91bmQgdG8gYHRoaXNBcmdgIGFuZAogICAgICogaW52b2tlZCB3aXRoIHRocmVlIGFyZ3VtZW50czsgKHZhbHVlLCBpbmRleCwgYXJyYXkpLgogICAgICoKICAgICAqIElmIGEgcHJvcGVydHkgbmFtZSBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy5wbHVjayIgc3R5bGUKICAgICAqIGNhbGxiYWNrIHdpbGwgcmV0dXJuIHRoZSBwcm9wZXJ0eSB2YWx1ZSBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgICAqCiAgICAgKiBJZiBhbiBvYmplY3QgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrCiAgICAgKiB3aWxsIHJldHVybiBgdHJ1ZWAgZm9yIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgcHJvcGVydGllcyBvZiB0aGUgZ2l2ZW4gb2JqZWN0LAogICAgICogZWxzZSBgZmFsc2VgLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgaGVhZCwgdGFrZQogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBmaXJzdCBlbGVtZW50KHMpIG9mIGBhcnJheWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uZmlyc3QoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IDEKICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqCiAgICAgKiBfLmZpcnN0KFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPCAzOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMSwgMl0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiYW5hbmEnLCAnb3JnYW5pYyc6IHRydWUgfSwKICAgICAqICAgeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH0sCiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmlyc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JhbmFuYScsICdvcmdhbmljJzogdHJ1ZSB9XQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2FwcGxlJywgICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JhbmFuYScsICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICd0eXBlJzogJ3ZlZ2V0YWJsZScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmZpcnN0KGZvb2QsIHsgJ3R5cGUnOiAnZnJ1aXQnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYXBwbGUnLCAndHlwZSc6ICdmcnVpdCcgfSwgeyAnbmFtZSc6ICdiYW5hbmEnLCAndHlwZSc6ICdmcnVpdCcgfV0KICAgICAqLwogICAgZnVuY3Rpb24gZmlyc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICAgIGNhbGxiYWNrID0gbG9kYXNoLmNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAzKTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCAmJiBjYWxsYmFjayhhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSkpIHsKICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbiA9IGNhbGxiYWNrOwogICAgICAgIGlmIChuID09IG51bGwgfHwgdGhpc0FyZykgewogICAgICAgICAgcmV0dXJuIGFycmF5ID8gYXJyYXlbMF0gOiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBuKSwgbGVuZ3RoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBGbGF0dGVucyBhIG5lc3RlZCBhcnJheSAodGhlIG5lc3RpbmcgY2FuIGJlIHRvIGFueSBkZXB0aCkuIElmIGBpc1NoYWxsb3dgCiAgICAgKiBpcyB0cnVleSwgdGhlIGFycmF5IHdpbGwgb25seSBiZSBmbGF0dGVuZWQgYSBzaW5nbGUgbGV2ZWwuIElmIGEgY2FsbGJhY2sKICAgICAqIGlzIHByb3ZpZGVkIGVhY2ggZWxlbWVudCBvZiB0aGUgYXJyYXkgaXMgcGFzc2VkIHRocm91Z2ggdGhlIGNhbGxiYWNrIGJlZm9yZQogICAgICogZmxhdHRlbmluZy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGZsYXR0ZW4uCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NoYWxsb3c9ZmFsc2VdIEEgZmxhZyB0byByZXN0cmljdCBmbGF0dGVuaW5nIHRvIGEgc2luZ2xlIGxldmVsLgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8c3RyaW5nfSBbY2FsbGJhY2s9aWRlbnRpdHldIFRoZSBmdW5jdGlvbiBjYWxsZWQKICAgICAqICBwZXIgaXRlcmF0aW9uLiBJZiBhIHByb3BlcnR5IG5hbWUgb3Igb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZAogICAgICogIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGZsYXR0ZW5lZCBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5mbGF0dGVuKFsxLCBbMl0sIFszLCBbWzRdXV1dKTsKICAgICAqIC8vID0+IFsxLCAyLCAzLCA0XTsKICAgICAqCiAgICAgKiBfLmZsYXR0ZW4oWzEsIFsyXSwgWzMsIFtbNF1dXV0sIHRydWUpOwogICAgICogLy8gPT4gWzEsIDIsIDMsIFtbNF1dXTsKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdxdW90ZXMnOiBbJ09oLCBhIHdpc2UgZ3V5LCBlaD8nLCAnUG9pZmVjdCEnXSB9LAogICAgICogICB7ICduYW1lJzogJ21vZScsICdxdW90ZXMnOiBbJ1NwcmVhZCBvdXQhJywgJ1lvdSBrbnVja2xlaGVhZCEnXSB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uZmxhdHRlbihzdG9vZ2VzLCAncXVvdGVzJyk7CiAgICAgKiAvLyA9PiBbJ09oLCBhIHdpc2UgZ3V5LCBlaD8nLCAnUG9pZmVjdCEnLCAnU3ByZWFkIG91dCEnLCAnWW91IGtudWNrbGVoZWFkISddCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdywgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgLy8ganVnZ2xlIGFyZ3VtZW50cwogICAgICBpZiAodHlwZW9mIGlzU2hhbGxvdyAhPSAnYm9vbGVhbicgJiYgaXNTaGFsbG93ICE9IG51bGwpIHsKICAgICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSAhKHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NoYWxsb3ddID09PSBhcnJheSkgPyBpc1NoYWxsb3cgOiBudWxsOwogICAgICAgIGlzU2hhbGxvdyA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgYXJyYXkgPSBtYXAoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUZsYXR0ZW4oYXJyYXksIGlzU2hhbGxvdyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBpbmRleCBhdCB3aGljaCB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiB0aGUgYXJyYXkgaXMgYWxyZWFkeSBzb3J0ZWQKICAgICAqIHByb3ZpZGluZyBgdHJ1ZWAgZm9yIGBmcm9tSW5kZXhgIHdpbGwgcnVuIGEgZmFzdGVyIGJpbmFyeSBzZWFyY2guCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtib29sZWFufG51bWJlcn0gW2Zyb21JbmRleD0wXSBUaGUgaW5kZXggdG8gc2VhcmNoIGZyb20gb3IgYHRydWVgCiAgICAgKiAgdG8gcGVyZm9ybSBhIGJpbmFyeSBzZWFyY2ggb24gYSBzb3J0ZWQgYXJyYXkuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSBpbmRleCBvZiB0aGUgbWF0Y2hlZCB2YWx1ZSBvciBgLTFgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IDEKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyLCAzKTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLmluZGV4T2YoWzEsIDEsIDIsIDIsIDMsIDNdLCAyLCB0cnVlKTsKICAgICAqIC8vID0+IDIKICAgICAqLwogICAgZnVuY3Rpb24gaW5kZXhPZihhcnJheSwgdmFsdWUsIGZyb21JbmRleCkgewogICAgICBpZiAodHlwZW9mIGZyb21JbmRleCA9PSAnbnVtYmVyJykgewogICAgICAgIHZhciBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CiAgICAgICAgZnJvbUluZGV4ID0gKGZyb21JbmRleCA8IDAgPyBuYXRpdmVNYXgoMCwgbGVuZ3RoICsgZnJvbUluZGV4KSA6IGZyb21JbmRleCB8fCAwKTsKICAgICAgfSBlbHNlIGlmIChmcm9tSW5kZXgpIHsKICAgICAgICB2YXIgaW5kZXggPSBzb3J0ZWRJbmRleChhcnJheSwgdmFsdWUpOwogICAgICAgIHJldHVybiBhcnJheVtpbmRleF0gPT09IHZhbHVlID8gaW5kZXggOiAtMTsKICAgICAgfQogICAgICByZXR1cm4gYmFzZUluZGV4T2YoYXJyYXksIHZhbHVlLCBmcm9tSW5kZXgpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyBhbGwgYnV0IHRoZSBsYXN0IGVsZW1lbnQgb3IgbGFzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEKICAgICAqIGNhbGxiYWNrIGlzIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBlbmQgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tCiAgICAgKiB0aGUgcmVzdWx0IGFzIGxvbmcgYXMgdGhlIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZAogICAgICogdG8gYHRoaXNBcmdgIGFuZCBpbnZva2VkIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBxdWVyeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fG51bWJlcnxzdHJpbmd9IFtjYWxsYmFjaz0xXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byBleGNsdWRlLiBJZiBhIHByb3BlcnR5IG5hbWUgb3IKICAgICAqICBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGNyZWF0ZSBhICJfLnBsdWNrIiBvciAiXy53aGVyZSIKICAgICAqICBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBzbGljZSBvZiBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmluaXRpYWwoWzEsIDIsIDNdKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICoKICAgICAqIF8uaW5pdGlhbChbMSwgMiwgM10sIDIpOwogICAgICogLy8gPT4gWzFdCiAgICAgKgogICAgICogXy5pbml0aWFsKFsxLCAyLCAzXSwgZnVuY3Rpb24obnVtKSB7CiAgICAgKiAgIHJldHVybiBudW0gPiAxOwogICAgICogfSk7CiAgICAgKiAvLyA9PiBbMV0KICAgICAqCiAgICAgKiB2YXIgZm9vZCA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnY2Fycm90JywgJ29yZ2FuaWMnOiB0cnVlIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ucGx1Y2siIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5pbml0aWFsKGZvb2QsICdvcmdhbmljJyk7CiAgICAgKiAvLyA9PiBbeyAnbmFtZSc6ICdiZWV0JywgICAnb3JnYW5pYyc6IGZhbHNlIH1dCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9LAogICAgICogICB7ICduYW1lJzogJ2NhcnJvdCcsICd0eXBlJzogJ3ZlZ2V0YWJsZScgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy53aGVyZSIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmluaXRpYWwoZm9vZCwgeyAndHlwZSc6ICd2ZWdldGFibGUnIH0pOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluaXRpYWwoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBuID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKCiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBpbmRleCA9IGxlbmd0aDsKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKGluZGV4LS0gJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBjYWxsYmFjayB8fCBuOwogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgMCwgbmF0aXZlTWluKG5hdGl2ZU1heCgwLCBsZW5ndGggLSBuKSwgbGVuZ3RoKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGFuIGFycmF5IG9mIHVuaXF1ZSB2YWx1ZXMgcHJlc2VudCBpbiBhbGwgcHJvdmlkZWQgYXJyYXlzIHVzaW5nCiAgICAgKiBzdHJpY3QgZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0gey4uLkFycmF5fSBbYXJyYXldIFRoZSBhcnJheXMgdG8gaW5zcGVjdC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhbiBhcnJheSBvZiBjb21wb3NpdGUgdmFsdWVzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmludGVyc2VjdGlvbihbMSwgMiwgM10sIFsxMDEsIDIsIDEsIDEwXSwgWzIsIDFdKTsKICAgICAqIC8vID0+IFsxLCAyXQogICAgICovCiAgICBmdW5jdGlvbiBpbnRlcnNlY3Rpb24oYXJyYXkpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzTGVuZ3RoID0gYXJncy5sZW5ndGgsCiAgICAgICAgICBhcmdzSW5kZXggPSAtMSwKICAgICAgICAgIGNhY2hlcyA9IGdldEFycmF5KCksCiAgICAgICAgICBpbmRleCA9IC0xLAogICAgICAgICAgaW5kZXhPZiA9IGdldEluZGV4T2YoKSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMCwKICAgICAgICAgIHJlc3VsdCA9IFtdLAogICAgICAgICAgc2VlbiA9IGdldEFycmF5KCk7CgogICAgICB3aGlsZSAoKythcmdzSW5kZXggPCBhcmdzTGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJnc1thcmdzSW5kZXhdOwogICAgICAgIGNhY2hlc1thcmdzSW5kZXhdID0gaW5kZXhPZiA9PT0gYmFzZUluZGV4T2YgJiYKICAgICAgICAgICh2YWx1ZSA/IHZhbHVlLmxlbmd0aCA6IDApID49IGxhcmdlQXJyYXlTaXplICYmCiAgICAgICAgICBjcmVhdGVDYWNoZShhcmdzSW5kZXggPyBhcmdzW2FyZ3NJbmRleF0gOiBzZWVuKTsKICAgICAgfQogICAgICBvdXRlcjoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICB2YXIgY2FjaGUgPSBjYWNoZXNbMF07CiAgICAgICAgdmFsdWUgPSBhcnJheVtpbmRleF07CgogICAgICAgIGlmICgoY2FjaGUgPyBjYWNoZUluZGV4T2YoY2FjaGUsIHZhbHVlKSA6IGluZGV4T2Yoc2VlbiwgdmFsdWUpKSA8IDApIHsKICAgICAgICAgIGFyZ3NJbmRleCA9IGFyZ3NMZW5ndGg7CiAgICAgICAgICAoY2FjaGUgfHwgc2VlbikucHVzaCh2YWx1ZSk7CiAgICAgICAgICB3aGlsZSAoLS1hcmdzSW5kZXgpIHsKICAgICAgICAgICAgY2FjaGUgPSBjYWNoZXNbYXJnc0luZGV4XTsKICAgICAgICAgICAgaWYgKChjYWNoZSA/IGNhY2hlSW5kZXhPZihjYWNoZSwgdmFsdWUpIDogaW5kZXhPZihhcmdzW2FyZ3NJbmRleF0sIHZhbHVlKSkgPCAwKSB7CiAgICAgICAgICAgICAgY29udGludWUgb3V0ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc3VsdC5wdXNoKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgd2hpbGUgKGFyZ3NMZW5ndGgtLSkgewogICAgICAgIGNhY2hlID0gY2FjaGVzW2FyZ3NMZW5ndGhdOwogICAgICAgIGlmIChjYWNoZSkgewogICAgICAgICAgcmVsZWFzZU9iamVjdChjYWNoZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlbGVhc2VBcnJheShjYWNoZXMpOwogICAgICByZWxlYXNlQXJyYXkoc2Vlbik7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSBsYXN0IGVsZW1lbnQgb3IgbGFzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgaXMKICAgICAqIHByb3ZpZGVkIGVsZW1lbnRzIGF0IHRoZSBlbmQgb2YgdGhlIGFycmF5IGFyZSByZXR1cm5lZCBhcyBsb25nIGFzIHRoZQogICAgICogY2FsbGJhY2sgcmV0dXJucyB0cnVleS4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZAogICAgICogd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHF1ZXJ5LgogICAgICogQHBhcmFtIHtGdW5jdGlvbnxPYmplY3R8bnVtYmVyfHN0cmluZ30gW2NhbGxiYWNrXSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGVsZW1lbnQgb3IgdGhlIG51bWJlciBvZiBlbGVtZW50cyB0byByZXR1cm4uIElmIGEgcHJvcGVydHkgbmFtZSBvcgogICAgICogIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIgogICAgICogIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHsqfSBSZXR1cm5zIHRoZSBsYXN0IGVsZW1lbnQocykgb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiAzCiAgICAgKgogICAgICogXy5sYXN0KFsxLCAyLCAzXSwgMik7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLmxhc3QoWzEsIDIsIDNdLCBmdW5jdGlvbihudW0pIHsKICAgICAqICAgcmV0dXJuIG51bSA+IDE7CiAgICAgKiB9KTsKICAgICAqIC8vID0+IFsyLCAzXQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICdvcmdhbmljJzogZmFsc2UgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAnb3JnYW5pYyc6IHRydWUgfQogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLmxhc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2NhcnJvdCcsICdvcmdhbmljJzogdHJ1ZSB9XQogICAgICoKICAgICAqIHZhciBmb29kID0gWwogICAgICogICB7ICduYW1lJzogJ2JhbmFuYScsICd0eXBlJzogJ2ZydWl0JyB9LAogICAgICogICB7ICduYW1lJzogJ2JlZXQnLCAgICd0eXBlJzogJ3ZlZ2V0YWJsZScgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjYXJyb3QnLCAndHlwZSc6ICd2ZWdldGFibGUnIH0KICAgICAqIF07CiAgICAgKgogICAgICogLy8gdXNpbmcgIl8ud2hlcmUiIGNhbGxiYWNrIHNob3J0aGFuZAogICAgICogXy5sYXN0KGZvb2QsIHsgJ3R5cGUnOiAndmVnZXRhYmxlJyB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAndHlwZSc6ICd2ZWdldGFibGUnIH0sIHsgJ25hbWUnOiAnY2Fycm90JywgJ3R5cGUnOiAndmVnZXRhYmxlJyB9XQogICAgICovCiAgICBmdW5jdGlvbiBsYXN0KGFycmF5LCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbiA9IDAsCiAgICAgICAgICBsZW5ndGggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IDA7CgogICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9ICdudW1iZXInICYmIGNhbGxiYWNrICE9IG51bGwpIHsKICAgICAgICB2YXIgaW5kZXggPSBsZW5ndGg7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICAgIHdoaWxlIChpbmRleC0tICYmIGNhbGxiYWNrKGFycmF5W2luZGV4XSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgbisrOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBuID0gY2FsbGJhY2s7CiAgICAgICAgaWYgKG4gPT0gbnVsbCB8fCB0aGlzQXJnKSB7CiAgICAgICAgICByZXR1cm4gYXJyYXkgPyBhcnJheVtsZW5ndGggLSAxXSA6IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHNsaWNlKGFycmF5LCBuYXRpdmVNYXgoMCwgbGVuZ3RoIC0gbikpOwogICAgfQoKICAgIC8qKgogICAgICogR2V0cyB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIGxhc3Qgb2NjdXJyZW5jZSBvZiBgdmFsdWVgIGlzIGZvdW5kIHVzaW5nIHN0cmljdAogICAgICogZXF1YWxpdHkgZm9yIGNvbXBhcmlzb25zLCBpLmUuIGA9PT1gLiBJZiBgZnJvbUluZGV4YCBpcyBuZWdhdGl2ZSwgaXQgaXMgdXNlZAogICAgICogYXMgdGhlIG9mZnNldCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBzZWFyY2guCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcm9tSW5kZXg9YXJyYXkubGVuZ3RoLTFdIFRoZSBpbmRleCB0byBzZWFyY2ggZnJvbS4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IG9mIHRoZSBtYXRjaGVkIHZhbHVlIG9yIGAtMWAuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ubGFzdEluZGV4T2YoWzEsIDIsIDMsIDEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IDQKICAgICAqCiAgICAgKiBfLmxhc3RJbmRleE9mKFsxLCAyLCAzLCAxLCAyLCAzXSwgMiwgMyk7CiAgICAgKiAvLyA9PiAxCiAgICAgKi8KICAgIGZ1bmN0aW9uIGxhc3RJbmRleE9mKGFycmF5LCB2YWx1ZSwgZnJvbUluZGV4KSB7CiAgICAgIHZhciBpbmRleCA9IGFycmF5ID8gYXJyYXkubGVuZ3RoIDogMDsKICAgICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT0gJ251bWJlcicpIHsKICAgICAgICBpbmRleCA9IChmcm9tSW5kZXggPCAwID8gbmF0aXZlTWF4KDAsIGluZGV4ICsgZnJvbUluZGV4KSA6IG5hdGl2ZU1pbihmcm9tSW5kZXgsIGluZGV4IC0gMSkpICsgMTsKICAgICAgfQogICAgICB3aGlsZSAoaW5kZXgtLSkgewogICAgICAgIGlmIChhcnJheVtpbmRleF0gPT09IHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXg7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiAtMTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZXMgYWxsIHByb3ZpZGVkIHZhbHVlcyBmcm9tIHRoZSBnaXZlbiBhcnJheSB1c2luZyBzdHJpY3QgZXF1YWxpdHkgZm9yCiAgICAgKiBjb21wYXJpc29ucywgaS5lLiBgPT09YC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7Li4uKn0gW3ZhbHVlXSBUaGUgdmFsdWVzIHRvIHJlbW92ZS4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgMSwgMiwgM107CiAgICAgKiBfLnB1bGwoYXJyYXksIDIsIDMpOwogICAgICogY29uc29sZS5sb2coYXJyYXkpOwogICAgICogLy8gPT4gWzEsIDFdCiAgICAgKi8KICAgIGZ1bmN0aW9uIHB1bGwoYXJyYXkpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHMsCiAgICAgICAgICBhcmdzSW5kZXggPSAwLAogICAgICAgICAgYXJnc0xlbmd0aCA9IGFyZ3MubGVuZ3RoLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgd2hpbGUgKCsrYXJnc0luZGV4IDwgYXJnc0xlbmd0aCkgewogICAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbYXJnc0luZGV4XTsKICAgICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgICAgaWYgKGFycmF5W2luZGV4XSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgICBsZW5ndGgtLTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGFycmF5OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhbiBhcnJheSBvZiBudW1iZXJzIChwb3NpdGl2ZSBhbmQvb3IgbmVnYXRpdmUpIHByb2dyZXNzaW5nIGZyb20KICAgICAqIGBzdGFydGAgdXAgdG8gYnV0IG5vdCBpbmNsdWRpbmcgYGVuZGAuIElmIGBzdGFydGAgaXMgbGVzcyB0aGFuIGBzdG9wYCBhCiAgICAgKiB6ZXJvLWxlbmd0aCByYW5nZSBpcyBjcmVhdGVkIHVubGVzcyBhIG5lZ2F0aXZlIGBzdGVwYCBpcyBzcGVjaWZpZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnQ9MF0gVGhlIHN0YXJ0IG9mIHRoZSByYW5nZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBlbmQgVGhlIGVuZCBvZiB0aGUgcmFuZ2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3N0ZXA9MV0gVGhlIHZhbHVlIHRvIGluY3JlbWVudCBvciBkZWNyZW1lbnQgYnkuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBuZXcgcmFuZ2UgYXJyYXkuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucmFuZ2UoMTApOwogICAgICogLy8gPT4gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIDgsIDldCiAgICAgKgogICAgICogXy5yYW5nZSgxLCAxMSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAzMCwgNSk7CiAgICAgKiAvLyA9PiBbMCwgNSwgMTAsIDE1LCAyMCwgMjVdCiAgICAgKgogICAgICogXy5yYW5nZSgwLCAtMTAsIC0xKTsKICAgICAqIC8vID0+IFswLCAtMSwgLTIsIC0zLCAtNCwgLTUsIC02LCAtNywgLTgsIC05XQogICAgICoKICAgICAqIF8ucmFuZ2UoMSwgNCwgMCk7CiAgICAgKiAvLyA9PiBbMSwgMSwgMV0KICAgICAqCiAgICAgKiBfLnJhbmdlKDApOwogICAgICogLy8gPT4gW10KICAgICAqLwogICAgZnVuY3Rpb24gcmFuZ2Uoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgICBzdGFydCA9ICtzdGFydCB8fCAwOwogICAgICBzdGVwID0gdHlwZW9mIHN0ZXAgPT0gJ251bWJlcicgPyBzdGVwIDogKCtzdGVwIHx8IDEpOwoKICAgICAgaWYgKGVuZCA9PSBudWxsKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9CiAgICAgIC8vIHVzZSBgQXJyYXkobGVuZ3RoKWAgc28gZW5naW5lcywgbGlrZSBDaGFrcmEgYW5kIFY4LCBhdm9pZCBzbG93ZXIgbW9kZXMKICAgICAgLy8gaHR0cDovL3lvdXR1LmJlL1hBcUlwR1U4WlprI3Q9MTdtMjVzCiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gbmF0aXZlTWF4KDAsIGNlaWwoKGVuZCAtIHN0YXJ0KSAvIChzdGVwIHx8IDEpKSksCiAgICAgICAgICByZXN1bHQgPSBBcnJheShsZW5ndGgpOwoKICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGgpIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgZWxlbWVudHMgZnJvbSBhbiBhcnJheSB0aGF0IHRoZSBjYWxsYmFjayByZXR1cm5zIHRydWV5IGZvcgogICAgICogYW5kIHJldHVybnMgYW4gYXJyYXkgb2YgcmVtb3ZlZCBlbGVtZW50cy4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYAogICAgICogYW5kIGludm9rZWQgd2l0aCB0aHJlZSBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIG1vZGlmeS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiByZW1vdmVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgYXJyYXkgPSBbMSwgMiwgMywgNCwgNSwgNl07CiAgICAgKiB2YXIgZXZlbnMgPSBfLnJlbW92ZShhcnJheSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gJSAyID09IDA7IH0pOwogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGFycmF5KTsKICAgICAqIC8vID0+IFsxLCAzLCA1XQogICAgICoKICAgICAqIGNvbnNvbGUubG9nKGV2ZW5zKTsKICAgICAqIC8vID0+IFsyLCA0LCA2XQogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmUoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIHZhciBpbmRleCA9IC0xLAogICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0gW107CgogICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIHZhbHVlID0gYXJyYXlbaW5kZXhdOwogICAgICAgIGlmIChjYWxsYmFjayh2YWx1ZSwgaW5kZXgsIGFycmF5KSkgewogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpOwogICAgICAgICAgc3BsaWNlLmNhbGwoYXJyYXksIGluZGV4LS0sIDEpOwogICAgICAgICAgbGVuZ3RoLS07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgb3Bwb3NpdGUgb2YgYF8uaW5pdGlhbGAgdGhpcyBtZXRob2QgZ2V0cyBhbGwgYnV0IHRoZSBmaXJzdCBlbGVtZW50IG9yCiAgICAgKiBmaXJzdCBgbmAgZWxlbWVudHMgb2YgYW4gYXJyYXkuIElmIGEgY2FsbGJhY2sgZnVuY3Rpb24gaXMgcHJvdmlkZWQgZWxlbWVudHMKICAgICAqIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5IGFyZSBleGNsdWRlZCBmcm9tIHRoZSByZXN1bHQgYXMgbG9uZyBhcyB0aGUKICAgICAqIGNhbGxiYWNrIHJldHVybnMgdHJ1ZXkuIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggdGhyZWUgYXJndW1lbnRzOyAodmFsdWUsIGluZGV4LCBhcnJheSkuCiAgICAgKgogICAgICogSWYgYSBwcm9wZXJ0eSBuYW1lIGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLnBsdWNrIiBzdHlsZQogICAgICogY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAgICoKICAgICAqIElmIGFuIG9iamVjdCBpcyBwcm92aWRlZCBmb3IgYGNhbGxiYWNrYCB0aGUgY3JlYXRlZCAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sKICAgICAqIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMgdGhhdCBoYXZlIHRoZSBwcm9wZXJ0aWVzIG9mIHRoZSBnaXZlbiBvYmplY3QsCiAgICAgKiBlbHNlIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBkcm9wLCB0YWlsCiAgICAgKiBAY2F0ZWdvcnkgQXJyYXlzCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSBUaGUgYXJyYXkgdG8gcXVlcnkuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxudW1iZXJ8c3RyaW5nfSBbY2FsbGJhY2s9MV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBlbGVtZW50IG9yIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgdG8gZXhjbHVkZS4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yCiAgICAgKiAgb2JqZWN0IGlzIHByb3ZpZGVkIGl0IHdpbGwgYmUgdXNlZCB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiCiAgICAgKiAgc3R5bGUgY2FsbGJhY2ssIHJlc3BlY3RpdmVseS4KICAgICAqIEBwYXJhbSB7Kn0gW3RoaXNBcmddIFRoZSBgdGhpc2AgYmluZGluZyBvZiBgY2FsbGJhY2tgLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgc2xpY2Ugb2YgYGFycmF5YC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yZXN0KFsxLCAyLCAzXSk7CiAgICAgKiAvLyA9PiBbMiwgM10KICAgICAqCiAgICAgKiBfLnJlc3QoWzEsIDIsIDNdLCAyKTsKICAgICAqIC8vID0+IFszXQogICAgICoKICAgICAqIF8ucmVzdChbMSwgMiwgM10sIGZ1bmN0aW9uKG51bSkgewogICAgICogICByZXR1cm4gbnVtIDwgMzsKICAgICAqIH0pOwogICAgICogLy8gPT4gWzNdCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ29yZ2FuaWMnOiB0cnVlIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ29yZ2FuaWMnOiBmYWxzZSB9LAogICAgICogXTsKICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnJlc3QoZm9vZCwgJ29yZ2FuaWMnKTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAnb3JnYW5pYyc6IGZhbHNlIH1dCiAgICAgKgogICAgICogdmFyIGZvb2QgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnYXBwbGUnLCAgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmFuYW5hJywgJ3R5cGUnOiAnZnJ1aXQnIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnYmVldCcsICAgJ3R5cGUnOiAndmVnZXRhYmxlJyB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHVzaW5nICJfLndoZXJlIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8ucmVzdChmb29kLCB7ICd0eXBlJzogJ2ZydWl0JyB9KTsKICAgICAqIC8vID0+IFt7ICduYW1lJzogJ2JlZXQnLCAndHlwZSc6ICd2ZWdldGFibGUnIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlc3QoYXJyYXksIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT0gJ251bWJlcicgJiYgY2FsbGJhY2sgIT0gbnVsbCkgewogICAgICAgIHZhciBuID0gMCwKICAgICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgICAgbGVuZ3RoID0gYXJyYXkgPyBhcnJheS5sZW5ndGggOiAwOwoKICAgICAgICBjYWxsYmFjayA9IGxvZGFzaC5jcmVhdGVDYWxsYmFjayhjYWxsYmFjaywgdGhpc0FyZywgMyk7CiAgICAgICAgd2hpbGUgKCsraW5kZXggPCBsZW5ndGggJiYgY2FsbGJhY2soYXJyYXlbaW5kZXhdLCBpbmRleCwgYXJyYXkpKSB7CiAgICAgICAgICBuKys7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG4gPSAoY2FsbGJhY2sgPT0gbnVsbCB8fCB0aGlzQXJnKSA/IDEgOiBuYXRpdmVNYXgoMCwgY2FsbGJhY2spOwogICAgICB9CiAgICAgIHJldHVybiBzbGljZShhcnJheSwgbik7CiAgICB9CgogICAgLyoqCiAgICAgKiBVc2VzIGEgYmluYXJ5IHNlYXJjaCB0byBkZXRlcm1pbmUgdGhlIHNtYWxsZXN0IGluZGV4IGF0IHdoaWNoIGEgdmFsdWUKICAgICAqIHNob3VsZCBiZSBpbnNlcnRlZCBpbnRvIGEgZ2l2ZW4gc29ydGVkIGFycmF5IGluIG9yZGVyIHRvIG1haW50YWluIHRoZSBzb3J0CiAgICAgKiBvcmRlciBvZiB0aGUgYXJyYXkuIElmIGEgY2FsbGJhY2sgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSBleGVjdXRlZCBmb3IKICAgICAqIGB2YWx1ZWAgYW5kIGVhY2ggZWxlbWVudCBvZiBgYXJyYXlgIHRvIGNvbXB1dGUgdGhlaXIgc29ydCByYW5raW5nLiBUaGUKICAgICAqIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIG9uZSBhcmd1bWVudDsgKHZhbHVlKS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIGluc3BlY3QuCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byBldmFsdWF0ZS4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb258T2JqZWN0fHN0cmluZ30gW2NhbGxiYWNrPWlkZW50aXR5XSBUaGUgZnVuY3Rpb24gY2FsbGVkCiAgICAgKiAgcGVyIGl0ZXJhdGlvbi4gSWYgYSBwcm9wZXJ0eSBuYW1lIG9yIG9iamVjdCBpcyBwcm92aWRlZCBpdCB3aWxsIGJlIHVzZWQKICAgICAqICB0byBjcmVhdGUgYSAiXy5wbHVjayIgb3IgIl8ud2hlcmUiIHN0eWxlIGNhbGxiYWNrLCByZXNwZWN0aXZlbHkuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGNhbGxiYWNrYC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIGluZGV4IGF0IHdoaWNoIGB2YWx1ZWAgc2hvdWxkIGJlIGluc2VydGVkCiAgICAgKiAgaW50byBgYXJyYXlgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsyMCwgMzAsIDUwXSwgNDApOwogICAgICogLy8gPT4gMgogICAgICoKICAgICAqIC8vIHVzaW5nICJfLnBsdWNrIiBjYWxsYmFjayBzaG9ydGhhbmQKICAgICAqIF8uc29ydGVkSW5kZXgoW3sgJ3gnOiAyMCB9LCB7ICd4JzogMzAgfSwgeyAneCc6IDUwIH1dLCB7ICd4JzogNDAgfSwgJ3gnKTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiB2YXIgZGljdCA9IHsKICAgICAqICAgJ3dvcmRUb051bWJlcic6IHsgJ3R3ZW50eSc6IDIwLCAndGhpcnR5JzogMzAsICdmb3VydHknOiA0MCwgJ2ZpZnR5JzogNTAgfQogICAgICogfTsKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAgICogICByZXR1cm4gZGljdC53b3JkVG9OdW1iZXJbd29yZF07CiAgICAgKiB9KTsKICAgICAqIC8vID0+IDIKICAgICAqCiAgICAgKiBfLnNvcnRlZEluZGV4KFsndHdlbnR5JywgJ3RoaXJ0eScsICdmaWZ0eSddLCAnZm91cnR5JywgZnVuY3Rpb24od29yZCkgewogICAgICogICByZXR1cm4gdGhpcy53b3JkVG9OdW1iZXJbd29yZF07CiAgICAgKiB9LCBkaWN0KTsKICAgICAqIC8vID0+IDIKICAgICAqLwogICAgZnVuY3Rpb24gc29ydGVkSW5kZXgoYXJyYXksIHZhbHVlLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICB2YXIgbG93ID0gMCwKICAgICAgICAgIGhpZ2ggPSBhcnJheSA/IGFycmF5Lmxlbmd0aCA6IGxvdzsKCiAgICAgIC8vIGV4cGxpY2l0bHkgcmVmZXJlbmNlIGBpZGVudGl0eWAgZm9yIGJldHRlciBpbmxpbmluZyBpbiBGaXJlZm94CiAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPyBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDEpIDogaWRlbnRpdHk7CiAgICAgIHZhbHVlID0gY2FsbGJhY2sodmFsdWUpOwoKICAgICAgd2hpbGUgKGxvdyA8IGhpZ2gpIHsKICAgICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICAgIChjYWxsYmFjayhhcnJheVttaWRdKSA8IHZhbHVlKQogICAgICAgICAgPyBsb3cgPSBtaWQgKyAxCiAgICAgICAgICA6IGhpZ2ggPSBtaWQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGxvdzsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgdW5pcXVlIHZhbHVlcywgaW4gb3JkZXIsIG9mIHRoZSBwcm92aWRlZCBhcnJheXMgdXNpbmcKICAgICAqIHN0cmljdCBlcXVhbGl0eSBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7Li4uQXJyYXl9IFthcnJheV0gVGhlIGFycmF5cyB0byBpbnNwZWN0LgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGFuIGFycmF5IG9mIGNvbXBvc2l0ZSB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pb24oWzEsIDIsIDNdLCBbMTAxLCAyLCAxLCAxMF0sIFsyLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgMywgMTAxLCAxMF0KICAgICAqLwogICAgZnVuY3Rpb24gdW5pb24oYXJyYXkpIHsKICAgICAgcmV0dXJuIGJhc2VVbmlxKGJhc2VGbGF0dGVuKGFyZ3VtZW50cywgdHJ1ZSwgdHJ1ZSkpOwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGR1cGxpY2F0ZS12YWx1ZS1mcmVlIHZlcnNpb24gb2YgYW4gYXJyYXkgdXNpbmcgc3RyaWN0IGVxdWFsaXR5CiAgICAgKiBmb3IgY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuIElmIHRoZSBhcnJheSBpcyBzb3J0ZWQsIHByb3ZpZGluZwogICAgICogYHRydWVgIGZvciBgaXNTb3J0ZWRgIHdpbGwgdXNlIGEgZmFzdGVyIGFsZ29yaXRobS4gSWYgYSBjYWxsYmFjayBpcyBwcm92aWRlZAogICAgICogZWFjaCBlbGVtZW50IG9mIGBhcnJheWAgaXMgcGFzc2VkIHRocm91Z2ggdGhlIGNhbGxiYWNrIGJlZm9yZSB1bmlxdWVuZXNzCiAgICAgKiBpcyBjb21wdXRlZC4gVGhlIGNhbGxiYWNrIGlzIGJvdW5kIHRvIGB0aGlzQXJnYCBhbmQgaW52b2tlZCB3aXRoIHRocmVlCiAgICAgKiBhcmd1bWVudHM7ICh2YWx1ZSwgaW5kZXgsIGFycmF5KS4KICAgICAqCiAgICAgKiBJZiBhIHByb3BlcnR5IG5hbWUgaXMgcHJvdmlkZWQgZm9yIGBjYWxsYmFja2AgdGhlIGNyZWF0ZWQgIl8ucGx1Y2siIHN0eWxlCiAgICAgKiBjYWxsYmFjayB3aWxsIHJldHVybiB0aGUgcHJvcGVydHkgdmFsdWUgb2YgdGhlIGdpdmVuIGVsZW1lbnQuCiAgICAgKgogICAgICogSWYgYW4gb2JqZWN0IGlzIHByb3ZpZGVkIGZvciBgY2FsbGJhY2tgIHRoZSBjcmVhdGVkICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjawogICAgICogd2lsbCByZXR1cm4gYHRydWVgIGZvciBlbGVtZW50cyB0aGF0IGhhdmUgdGhlIHByb3BlcnRpZXMgb2YgdGhlIGdpdmVuIG9iamVjdCwKICAgICAqIGVsc2UgYGZhbHNlYC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGFsaWFzIHVuaXF1ZQogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHtBcnJheX0gYXJyYXkgVGhlIGFycmF5IHRvIHByb2Nlc3MuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1NvcnRlZD1mYWxzZV0gQSBmbGFnIHRvIGluZGljYXRlIHRoYXQgYGFycmF5YCBpcyBzb3J0ZWQuCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufE9iamVjdHxzdHJpbmd9IFtjYWxsYmFjaz1pZGVudGl0eV0gVGhlIGZ1bmN0aW9uIGNhbGxlZAogICAgICogIHBlciBpdGVyYXRpb24uIElmIGEgcHJvcGVydHkgbmFtZSBvciBvYmplY3QgaXMgcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkCiAgICAgKiAgdG8gY3JlYXRlIGEgIl8ucGx1Y2siIG9yICJfLndoZXJlIiBzdHlsZSBjYWxsYmFjaywgcmVzcGVjdGl2ZWx5LgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYSBkdXBsaWNhdGUtdmFsdWUtZnJlZSBhcnJheS4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy51bmlxKFsxLCAyLCAxLCAzLCAxXSk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqCiAgICAgKiBfLnVuaXEoWzEsIDEsIDIsIDIsIDNdLCB0cnVlKTsKICAgICAqIC8vID0+IFsxLCAyLCAzXQogICAgICoKICAgICAqIF8udW5pcShbJ0EnLCAnYicsICdDJywgJ2EnLCAnQicsICdjJ10sIGZ1bmN0aW9uKGxldHRlcikgeyByZXR1cm4gbGV0dGVyLnRvTG93ZXJDYXNlKCk7IH0pOwogICAgICogLy8gPT4gWydBJywgJ2InLCAnQyddCiAgICAgKgogICAgICogXy51bmlxKFsxLCAyLjUsIDMsIDEuNSwgMiwgMy41XSwgZnVuY3Rpb24obnVtKSB7IHJldHVybiB0aGlzLmZsb29yKG51bSk7IH0sIE1hdGgpOwogICAgICogLy8gPT4gWzEsIDIuNSwgM10KICAgICAqCiAgICAgKiAvLyB1c2luZyAiXy5wbHVjayIgY2FsbGJhY2sgc2hvcnRoYW5kCiAgICAgKiBfLnVuaXEoW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH0sIHsgJ3gnOiAxIH1dLCAneCcpOwogICAgICogLy8gPT4gW3sgJ3gnOiAxIH0sIHsgJ3gnOiAyIH1dCiAgICAgKi8KICAgIGZ1bmN0aW9uIHVuaXEoYXJyYXksIGlzU29ydGVkLCBjYWxsYmFjaywgdGhpc0FyZykgewogICAgICAvLyBqdWdnbGUgYXJndW1lbnRzCiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgIT0gJ2Jvb2xlYW4nICYmIGlzU29ydGVkICE9IG51bGwpIHsKICAgICAgICB0aGlzQXJnID0gY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSAhKHRoaXNBcmcgJiYgdGhpc0FyZ1tpc1NvcnRlZF0gPT09IGFycmF5KSA/IGlzU29ydGVkIDogbnVsbDsKICAgICAgICBpc1NvcnRlZCA9IGZhbHNlOwogICAgICB9CiAgICAgIGlmIChjYWxsYmFjayAhPSBudWxsKSB7CiAgICAgICAgY2FsbGJhY2sgPSBsb2Rhc2guY3JlYXRlQ2FsbGJhY2soY2FsbGJhY2ssIHRoaXNBcmcsIDMpOwogICAgICB9CiAgICAgIHJldHVybiBiYXNlVW5pcShhcnJheSwgaXNTb3J0ZWQsIGNhbGxiYWNrKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgZXhjbHVkaW5nIGFsbCBwcm92aWRlZCB2YWx1ZXMgdXNpbmcgc3RyaWN0IGVxdWFsaXR5IGZvcgogICAgICogY29tcGFyaXNvbnMsIGkuZS4gYD09PWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IFRoZSBhcnJheSB0byBmaWx0ZXIuCiAgICAgKiBAcGFyYW0gey4uLip9IFt2YWx1ZV0gVGhlIHZhbHVlcyB0byBleGNsdWRlLgogICAgICogQHJldHVybnMge0FycmF5fSBSZXR1cm5zIGEgbmV3IGFycmF5IG9mIGZpbHRlcmVkIHZhbHVlcy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy53aXRob3V0KFsxLCAyLCAxLCAwLCAzLCAxLCA0XSwgMCwgMSk7CiAgICAgKiAvLyA9PiBbMiwgMywgNF0KICAgICAqLwogICAgZnVuY3Rpb24gd2l0aG91dChhcnJheSkgewogICAgICByZXR1cm4gZGlmZmVyZW5jZShhcnJheSwgbmF0aXZlU2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gYXJyYXkgb2YgZ3JvdXBlZCBlbGVtZW50cywgdGhlIGZpcnN0IG9mIHdoaWNoIGNvbnRhaW5zIHRoZSBmaXJzdAogICAgICogZWxlbWVudHMgb2YgdGhlIGdpdmVuIGFycmF5cywgdGhlIHNlY29uZCBvZiB3aGljaCBjb250YWlucyB0aGUgc2Vjb25kCiAgICAgKiBlbGVtZW50cyBvZiB0aGUgZ2l2ZW4gYXJyYXlzLCBhbmQgc28gb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyB1bnppcAogICAgICogQGNhdGVnb3J5IEFycmF5cwogICAgICogQHBhcmFtIHsuLi5BcnJheX0gW2FycmF5XSBBcnJheXMgdG8gcHJvY2Vzcy4KICAgICAqIEByZXR1cm5zIHtBcnJheX0gUmV0dXJucyBhIG5ldyBhcnJheSBvZiBncm91cGVkIGVsZW1lbnRzLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnppcChbJ21vZScsICdsYXJyeSddLCBbMzAsIDQwXSwgW3RydWUsIGZhbHNlXSk7CiAgICAgKiAvLyA9PiBbWydtb2UnLCAzMCwgdHJ1ZV0sIFsnbGFycnknLCA0MCwgZmFsc2VdXQogICAgICovCiAgICBmdW5jdGlvbiB6aXAoKSB7CiAgICAgIHZhciBhcnJheSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzIDogYXJndW1lbnRzWzBdLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGFycmF5ID8gbWF4KHBsdWNrKGFycmF5LCAnbGVuZ3RoJykpIDogMCwKICAgICAgICAgIHJlc3VsdCA9IEFycmF5KGxlbmd0aCA8IDAgPyAwIDogbGVuZ3RoKTsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IHBsdWNrKGFycmF5LCBpbmRleCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYW4gb2JqZWN0IGNvbXBvc2VkIGZyb20gYXJyYXlzIG9mIGBrZXlzYCBhbmQgYHZhbHVlc2AuIFByb3ZpZGUKICAgICAqIGVpdGhlciBhIHNpbmdsZSB0d28gZGltZW5zaW9uYWwgYXJyYXksIGkuZS4gYFtba2V5MSwgdmFsdWUxXSwgW2tleTIsIHZhbHVlMl1dYAogICAgICogb3IgdHdvIGFycmF5cywgb25lIG9mIGBrZXlzYCBhbmQgb25lIG9mIGNvcnJlc3BvbmRpbmcgYHZhbHVlc2AuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBhbGlhcyBvYmplY3QKICAgICAqIEBjYXRlZ29yeSBBcnJheXMKICAgICAqIEBwYXJhbSB7QXJyYXl9IGtleXMgVGhlIGFycmF5IG9mIGtleXMuCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbdmFsdWVzPVtdXSBUaGUgYXJyYXkgb2YgdmFsdWVzLgogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyBhbiBvYmplY3QgY29tcG9zZWQgb2YgdGhlIGdpdmVuIGtleXMgYW5kCiAgICAgKiAgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8uemlwT2JqZWN0KFsnbW9lJywgJ2xhcnJ5J10sIFszMCwgNDBdKTsKICAgICAqIC8vID0+IHsgJ21vZSc6IDMwLCAnbGFycnknOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHppcE9iamVjdChrZXlzLCB2YWx1ZXMpIHsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICBsZW5ndGggPSBrZXlzID8ga2V5cy5sZW5ndGggOiAwLAogICAgICAgICAgcmVzdWx0ID0ge307CgogICAgICB3aGlsZSAoKytpbmRleCA8IGxlbmd0aCkgewogICAgICAgIHZhciBrZXkgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAodmFsdWVzKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlc1tpbmRleF07CiAgICAgICAgfSBlbHNlIGlmIChrZXkpIHsKICAgICAgICAgIHJlc3VsdFtrZXlbMF1dID0ga2V5WzFdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgZXhlY3V0ZXMgYGZ1bmNgLCB3aXRoICB0aGUgYHRoaXNgIGJpbmRpbmcgYW5kCiAgICAgKiBhcmd1bWVudHMgb2YgdGhlIGNyZWF0ZWQgZnVuY3Rpb24sIG9ubHkgYWZ0ZXIgYmVpbmcgY2FsbGVkIGBuYCB0aW1lcy4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtudW1iZXJ9IG4gVGhlIG51bWJlciBvZiB0aW1lcyB0aGUgZnVuY3Rpb24gbXVzdCBiZSBjYWxsZWQgYmVmb3JlCiAgICAgKiAgYGZ1bmNgIGlzIGV4ZWN1dGVkLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc2F2ZXMgPSBbJ3Byb2ZpbGUnLCAnc2V0dGluZ3MnXTsKICAgICAqCiAgICAgKiB2YXIgZG9uZSA9IF8uYWZ0ZXIoc2F2ZXMubGVuZ3RoLCBmdW5jdGlvbigpIHsKICAgICAqICAgY29uc29sZS5sb2coJ0RvbmUgc2F2aW5nIScpOwogICAgICogfSk7CiAgICAgKgogICAgICogXy5mb3JFYWNoKHNhdmVzLCBmdW5jdGlvbih0eXBlKSB7CiAgICAgKiAgIGFzeW5jU2F2ZSh7ICd0eXBlJzogdHlwZSwgJ2NvbXBsZXRlJzogZG9uZSB9KTsKICAgICAqIH0pOwogICAgICogLy8gPT4gbG9ncyAnRG9uZSBzYXZpbmchJywgYWZ0ZXIgYWxsIHNhdmVzIGhhdmUgY29tcGxldGVkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFmdGVyKG4sIGZ1bmMpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKC0tbiA8IDEpIHsKICAgICAgICAgIHJldHVybiBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQsIHdoZW4gY2FsbGVkLCBpbnZva2VzIGBmdW5jYCB3aXRoIHRoZSBgdGhpc2AKICAgICAqIGJpbmRpbmcgb2YgYHRoaXNBcmdgIGFuZCBwcmVwZW5kcyBhbnkgYWRkaXRpb25hbCBgYmluZGAgYXJndW1lbnRzIHRvIHRob3NlCiAgICAgKiBwcm92aWRlZCB0byB0aGUgYm91bmQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGJpbmQuCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgYGZ1bmNgLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBmdW5jdGlvbihncmVldGluZykgewogICAgICogICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiB9OwogICAgICoKICAgICAqIGZ1bmMgPSBfLmJpbmQoZnVuYywgeyAnbmFtZSc6ICdtb2UnIH0sICdoaScpOwogICAgICogZnVuYygpOwogICAgICogLy8gPT4gJ2hpIG1vZScKICAgICAqLwogICAgZnVuY3Rpb24gYmluZChmdW5jLCB0aGlzQXJnKSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgICAgID8gY3JlYXRlQm91bmQoZnVuYywgMTcsIG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKSwgbnVsbCwgdGhpc0FyZykKICAgICAgICA6IGNyZWF0ZUJvdW5kKGZ1bmMsIDEsIG51bGwsIG51bGwsIHRoaXNBcmcpOwogICAgfQoKICAgIC8qKgogICAgICogQmluZHMgbWV0aG9kcyBvZiBhbiBvYmplY3QgdG8gdGhlIG9iamVjdCBpdHNlbGYsIG92ZXJ3cml0aW5nIHRoZSBleGlzdGluZwogICAgICogbWV0aG9kLiBNZXRob2QgbmFtZXMgbWF5IGJlIHNwZWNpZmllZCBhcyBpbmRpdmlkdWFsIGFyZ3VtZW50cyBvciBhcyBhcnJheXMKICAgICAqIG9mIG1ldGhvZCBuYW1lcy4gSWYgbm8gbWV0aG9kIG5hbWVzIGFyZSBwcm92aWRlZCBhbGwgdGhlIGZ1bmN0aW9uIHByb3BlcnRpZXMKICAgICAqIG9mIGBvYmplY3RgIHdpbGwgYmUgYm91bmQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBiaW5kIGFuZCBhc3NpZ24gdGhlIGJvdW5kIG1ldGhvZHMgdG8uCiAgICAgKiBAcGFyYW0gey4uLnN0cmluZ30gW21ldGhvZE5hbWVdIFRoZSBvYmplY3QgbWV0aG9kIG5hbWVzIHRvCiAgICAgKiAgYmluZCwgc3BlY2lmaWVkIGFzIGluZGl2aWR1YWwgbWV0aG9kIG5hbWVzIG9yIGFycmF5cyBvZiBtZXRob2QgbmFtZXMuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIGBvYmplY3RgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgdmlldyA9IHsKICAgICAqICAnbGFiZWwnOiAnZG9jcycsCiAgICAgKiAgJ29uQ2xpY2snOiBmdW5jdGlvbigpIHsgY29uc29sZS5sb2coJ2NsaWNrZWQgJyArIHRoaXMubGFiZWwpOyB9CiAgICAgKiB9OwogICAgICoKICAgICAqIF8uYmluZEFsbCh2aWV3KTsKICAgICAqIGpRdWVyeSgnI2RvY3MnKS5vbignY2xpY2snLCB2aWV3Lm9uQ2xpY2spOwogICAgICogLy8gPT4gbG9ncyAnY2xpY2tlZCBkb2NzJywgd2hlbiB0aGUgYnV0dG9uIGlzIGNsaWNrZWQKICAgICAqLwogICAgZnVuY3Rpb24gYmluZEFsbChvYmplY3QpIHsKICAgICAgdmFyIGZ1bmNzID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBiYXNlRmxhdHRlbihhcmd1bWVudHMsIHRydWUsIGZhbHNlLCAxKSA6IGZ1bmN0aW9ucyhvYmplY3QpLAogICAgICAgICAgaW5kZXggPSAtMSwKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlICgrK2luZGV4IDwgbGVuZ3RoKSB7CiAgICAgICAgdmFyIGtleSA9IGZ1bmNzW2luZGV4XTsKICAgICAgICBvYmplY3Rba2V5XSA9IGNyZWF0ZUJvdW5kKG9iamVjdFtrZXldLCAxLCBudWxsLCBudWxsLCBvYmplY3QpOwogICAgICB9CiAgICAgIHJldHVybiBvYmplY3Q7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgdGhlIG1ldGhvZCBhdCBgb2JqZWN0W2tleV1gCiAgICAgKiBhbmQgcHJlcGVuZHMgYW55IGFkZGl0aW9uYWwgYGJpbmRLZXlgIGFyZ3VtZW50cyB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgYm91bmQKICAgICAqIGZ1bmN0aW9uLiBUaGlzIG1ldGhvZCBkaWZmZXJzIGZyb20gYF8uYmluZGAgYnkgYWxsb3dpbmcgYm91bmQgZnVuY3Rpb25zIHRvCiAgICAgKiByZWZlcmVuY2UgbWV0aG9kcyB0aGF0IHdpbGwgYmUgcmVkZWZpbmVkIG9yIGRvbid0IHlldCBleGlzdC4KICAgICAqIFNlZSBodHRwOi8vbWljaGF1eC5jYS9hcnRpY2xlcy9sYXp5LWZ1bmN0aW9uLWRlZmluaXRpb24tcGF0dGVybi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IHRoZSBtZXRob2QgYmVsb25ncyB0by4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgVGhlIGtleSBvZiB0aGUgbWV0aG9kLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBib3VuZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG9iamVjdCA9IHsKICAgICAqICAgJ25hbWUnOiAnbW9lJywKICAgICAqICAgJ2dyZWV0JzogZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgICByZXR1cm4gZ3JlZXRpbmcgKyAnICcgKyB0aGlzLm5hbWU7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogdmFyIGZ1bmMgPSBfLmJpbmRLZXkob2JqZWN0LCAnZ3JlZXQnLCAnaGknKTsKICAgICAqIGZ1bmMoKTsKICAgICAqIC8vID0+ICdoaSBtb2UnCiAgICAgKgogICAgICogb2JqZWN0LmdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcpIHsKICAgICAqICAgcmV0dXJuIGdyZWV0aW5nICsgJywgJyArIHRoaXMubmFtZSArICchJzsKICAgICAqIH07CiAgICAgKgogICAgICogZnVuYygpOwogICAgICogLy8gPT4gJ2hpLCBtb2UhJwogICAgICovCiAgICBmdW5jdGlvbiBiaW5kS2V5KG9iamVjdCwga2V5KSB7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMgogICAgICAgID8gY3JlYXRlQm91bmQoa2V5LCAxOSwgbmF0aXZlU2xpY2UuY2FsbChhcmd1bWVudHMsIDIpLCBudWxsLCBvYmplY3QpCiAgICAgICAgOiBjcmVhdGVCb3VuZChrZXksIDMsIG51bGwsIG51bGwsIG9iamVjdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBpcyB0aGUgY29tcG9zaXRpb24gb2YgdGhlIHByb3ZpZGVkIGZ1bmN0aW9ucywKICAgICAqIHdoZXJlIGVhY2ggZnVuY3Rpb24gY29uc3VtZXMgdGhlIHJldHVybiB2YWx1ZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCBmb2xsb3dzLgogICAgICogRm9yIGV4YW1wbGUsIGNvbXBvc2luZyB0aGUgZnVuY3Rpb25zIGBmKClgLCBgZygpYCwgYW5kIGBoKClgIHByb2R1Y2VzIGBmKGcoaCgpKSlgLgogICAgICogRWFjaCBmdW5jdGlvbiBpcyBleGVjdXRlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY29tcG9zZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Li4uRnVuY3Rpb259IFtmdW5jXSBGdW5jdGlvbnMgdG8gY29tcG9zZS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGNvbXBvc2VkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgcmVhbE5hbWVNYXAgPSB7CiAgICAgKiAgICdjdXJseSc6ICdqZXJvbWUnCiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciBmb3JtYXQgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgKiAgIG5hbWUgPSByZWFsTmFtZU1hcFtuYW1lLnRvTG93ZXJDYXNlKCldIHx8IG5hbWU7CiAgICAgKiAgIHJldHVybiBuYW1lLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogfTsKICAgICAqCiAgICAgKiB2YXIgZ3JlZXQgPSBmdW5jdGlvbihmb3JtYXR0ZWQpIHsKICAgICAqICAgcmV0dXJuICdIaXlhICcgKyBmb3JtYXR0ZWQgKyAnISc7CiAgICAgKiB9OwogICAgICoKICAgICAqIHZhciB3ZWxjb21lID0gXy5jb21wb3NlKGdyZWV0LCBmb3JtYXQpOwogICAgICogd2VsY29tZSgnY3VybHknKTsKICAgICAqIC8vID0+ICdIaXlhIEplcm9tZSEnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNvbXBvc2UoKSB7CiAgICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50cywKICAgICAgICAgIGxlbmd0aCA9IGZ1bmNzLmxlbmd0aDsKCiAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jc1tsZW5ndGhdKSkgewogICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICBsZW5ndGggPSBmdW5jcy5sZW5ndGg7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgYXJncyA9IFtmdW5jc1tsZW5ndGhdLmFwcGx5KHRoaXMsIGFyZ3MpXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3NbMF07CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIGNhbGxiYWNrIGJvdW5kIHRvIGFuIG9wdGlvbmFsIGB0aGlzQXJnYC4gSWYgYGZ1bmNgIGlzIGEgcHJvcGVydHkKICAgICAqIG5hbWUgdGhlIGNyZWF0ZWQgY2FsbGJhY2sgd2lsbCByZXR1cm4gdGhlIHByb3BlcnR5IHZhbHVlIGZvciBhIGdpdmVuIGVsZW1lbnQuCiAgICAgKiBJZiBgZnVuY2AgaXMgYW4gb2JqZWN0IHRoZSBjcmVhdGVkIGNhbGxiYWNrIHdpbGwgcmV0dXJuIGB0cnVlYCBmb3IgZWxlbWVudHMKICAgICAqIHRoYXQgY29udGFpbiB0aGUgZXF1aXZhbGVudCBvYmplY3QgcHJvcGVydGllcywgb3RoZXJ3aXNlIGl0IHdpbGwgcmV0dXJuIGBmYWxzZWAuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7Kn0gW2Z1bmM9aWRlbnRpdHldIFRoZSB2YWx1ZSB0byBjb252ZXJ0IHRvIGEgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0geyp9IFt0aGlzQXJnXSBUaGUgYHRoaXNgIGJpbmRpbmcgb2YgdGhlIGNyZWF0ZWQgY2FsbGJhY2suCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW2FyZ0NvdW50XSBUaGUgbnVtYmVyIG9mIGFyZ3VtZW50cyB0aGUgY2FsbGJhY2sgYWNjZXB0cy4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyBhIGNhbGxiYWNrIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHdyYXAgdG8gY3JlYXRlIGN1c3RvbSBjYWxsYmFjayBzaG9ydGhhbmRzCiAgICAgKiBfLmNyZWF0ZUNhbGxiYWNrID0gXy53cmFwKF8uY3JlYXRlQ2FsbGJhY2ssIGZ1bmN0aW9uKGZ1bmMsIGNhbGxiYWNrLCB0aGlzQXJnKSB7CiAgICAgKiAgIHZhciBtYXRjaCA9IC9eKC4rPylfXyhbZ2xddCkoLispJC8uZXhlYyhjYWxsYmFjayk7CiAgICAgKiAgIHJldHVybiAhbWF0Y2ggPyBmdW5jKGNhbGxiYWNrLCB0aGlzQXJnKSA6IGZ1bmN0aW9uKG9iamVjdCkgewogICAgICogICAgIHJldHVybiBtYXRjaFsyXSA9PSAnZ3QnID8gb2JqZWN0W21hdGNoWzFdXSA+IG1hdGNoWzNdIDogb2JqZWN0W21hdGNoWzFdXSA8IG1hdGNoWzNdOwogICAgICogICB9OwogICAgICogfSk7CiAgICAgKgogICAgICogXy5maWx0ZXIoc3Rvb2dlcywgJ2FnZV9fZ3Q0NScpOwogICAgICogLy8gPT4gW3sgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfV0KICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2FsbGJhY2soZnVuYywgdGhpc0FyZywgYXJnQ291bnQpIHsKICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgZnVuYzsKICAgICAgaWYgKGZ1bmMgPT0gbnVsbCB8fCB0eXBlID09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gYmFzZUNyZWF0ZUNhbGxiYWNrKGZ1bmMsIHRoaXNBcmcsIGFyZ0NvdW50KTsKICAgICAgfQogICAgICAvLyBoYW5kbGUgIl8ucGx1Y2siIHN0eWxlIGNhbGxiYWNrIHNob3J0aGFuZHMKICAgICAgaWYgKHR5cGUgIT0gJ29iamVjdCcpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gb2JqZWN0W2Z1bmNdOwogICAgICAgIH07CiAgICAgIH0KICAgICAgdmFyIHByb3BzID0ga2V5cyhmdW5jKSwKICAgICAgICAgIGtleSA9IHByb3BzWzBdLAogICAgICAgICAgYSA9IGZ1bmNba2V5XTsKCiAgICAgIC8vIGhhbmRsZSAiXy53aGVyZSIgc3R5bGUgY2FsbGJhY2sgc2hvcnRoYW5kcwogICAgICBpZiAocHJvcHMubGVuZ3RoID09IDEgJiYgYSA9PT0gYSAmJiAhaXNPYmplY3QoYSkpIHsKICAgICAgICAvLyBmYXN0IHBhdGggdGhlIGNvbW1vbiBjYXNlIG9mIHByb3ZpZGluZyBhbiBvYmplY3Qgd2l0aCBhIHNpbmdsZQogICAgICAgIC8vIHByb3BlcnR5IGNvbnRhaW5pbmcgYSBwcmltaXRpdmUgdmFsdWUKICAgICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgICB2YXIgYiA9IG9iamVjdFtrZXldOwogICAgICAgICAgcmV0dXJuIGEgPT09IGIgJiYgKGEgIT09IDAgfHwgKDEgLyBhID09IDEgLyBiKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24ob2JqZWN0KSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IHByb3BzLmxlbmd0aCwKICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7CgogICAgICAgIHdoaWxlIChsZW5ndGgtLSkgewogICAgICAgICAgaWYgKCEocmVzdWx0ID0gYmFzZUlzRXF1YWwob2JqZWN0W3Byb3BzW2xlbmd0aF1dLCBmdW5jW3Byb3BzW2xlbmd0aF1dLCBudWxsLCB0cnVlKSkpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gd2hpY2ggYWNjZXB0cyBvbmUgb3IgbW9yZSBhcmd1bWVudHMgb2YgYGZ1bmNgIHRoYXQgd2hlbgogICAgICogaW52b2tlZCBlaXRoZXIgZXhlY3V0ZXMgYGZ1bmNgIHJldHVybmluZyBpdHMgcmVzdWx0LCBpZiBhbGwgYGZ1bmNgIGFyZ3VtZW50cwogICAgICogaGF2ZSBiZWVuIHByb3ZpZGVkLCBvciByZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIG9uZSBvciBtb3JlIG9mIHRoZQogICAgICogcmVtYWluaW5nIGBmdW5jYCBhcmd1bWVudHMsIGFuZCBzbyBvbi4gVGhlIGFyaXR5IG9mIGBmdW5jYCBjYW4gYmUgc3BlY2lmaWVkCiAgICAgKiBpZiBgZnVuYy5sZW5ndGhgIGlzIG5vdCBzdWZmaWNpZW50LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBjdXJyeS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbYXJpdHk9ZnVuYy5sZW5ndGhdIFRoZSBhcml0eSBvZiBgZnVuY2AuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBjdXJyaWVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgY3VycmllZCA9IF8uY3VycnkoZnVuY3Rpb24oYSwgYiwgYykgewogICAgICogICBjb25zb2xlLmxvZyhhICsgYiArIGMpOwogICAgICogfSk7CiAgICAgKgogICAgICogY3VycmllZCgxKSgyKSgzKTsKICAgICAqIC8vID0+IDYKICAgICAqCiAgICAgKiBjdXJyaWVkKDEsIDIpKDMpOwogICAgICogLy8gPT4gNgogICAgICoKICAgICAqIGN1cnJpZWQoMSwgMiwgMyk7CiAgICAgKiAvLyA9PiA2CiAgICAgKi8KICAgIGZ1bmN0aW9uIGN1cnJ5KGZ1bmMsIGFyaXR5KSB7CiAgICAgIGFyaXR5ID0gdHlwZW9mIGFyaXR5ID09ICdudW1iZXInID8gYXJpdHkgOiAoK2FyaXR5IHx8IGZ1bmMubGVuZ3RoKTsKICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIDQsIG51bGwsIG51bGwsIG51bGwsIGFyaXR5KTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IHdpbGwgZGVsYXkgdGhlIGV4ZWN1dGlvbiBvZiBgZnVuY2AgdW50aWwgYWZ0ZXIKICAgICAqIGB3YWl0YCBtaWxsaXNlY29uZHMgaGF2ZSBlbGFwc2VkIHNpbmNlIHRoZSBsYXN0IHRpbWUgaXQgd2FzIGludm9rZWQuCiAgICAgKiBQcm92aWRlIGFuIG9wdGlvbnMgb2JqZWN0IHRvIGluZGljYXRlIHRoYXQgYGZ1bmNgIHNob3VsZCBiZSBpbnZva2VkIG9uCiAgICAgKiB0aGUgbGVhZGluZyBhbmQvb3IgdHJhaWxpbmcgZWRnZSBvZiB0aGUgYHdhaXRgIHRpbWVvdXQuIFN1YnNlcXVlbnQgY2FsbHMKICAgICAqIHRvIHRoZSBkZWJvdW5jZWQgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHJlc3VsdCBvZiB0aGUgbGFzdCBgZnVuY2AgY2FsbC4KICAgICAqCiAgICAgKiBOb3RlOiBJZiBgbGVhZGluZ2AgYW5kIGB0cmFpbGluZ2Agb3B0aW9ucyBhcmUgYHRydWVgIGBmdW5jYCB3aWxsIGJlIGNhbGxlZAogICAgICogb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQgb25seSBpZiB0aGUgdGhlIGRlYm91bmNlZCBmdW5jdGlvbiBpcwogICAgICogaW52b2tlZCBtb3JlIHRoYW4gb25jZSBkdXJpbmcgdGhlIGB3YWl0YCB0aW1lb3V0LgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWJvdW5jZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3YWl0IFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIGRlbGF5LgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxlYWRpbmc9ZmFsc2VdIFNwZWNpZnkgZXhlY3V0aW9uIG9uIHRoZSBsZWFkaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW29wdGlvbnMubWF4V2FpdF0gVGhlIG1heGltdW0gdGltZSBgZnVuY2AgaXMgYWxsb3dlZCB0byBiZSBkZWxheWVkIGJlZm9yZSBpdCdzIGNhbGxlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudHJhaWxpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBkZWJvdW5jZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIGF2b2lkIGNvc3RseSBjYWxjdWxhdGlvbnMgd2hpbGUgdGhlIHdpbmRvdyBzaXplIGlzIGluIGZsdXgKICAgICAqIHZhciBsYXp5TGF5b3V0ID0gXy5kZWJvdW5jZShjYWxjdWxhdGVMYXlvdXQsIDE1MCk7CiAgICAgKiBqUXVlcnkod2luZG93KS5vbigncmVzaXplJywgbGF6eUxheW91dCk7CiAgICAgKgogICAgICogLy8gZXhlY3V0ZSBgc2VuZE1haWxgIHdoZW4gdGhlIGNsaWNrIGV2ZW50IGlzIGZpcmVkLCBkZWJvdW5jaW5nIHN1YnNlcXVlbnQgY2FsbHMKICAgICAqIGpRdWVyeSgnI3Bvc3Rib3gnKS5vbignY2xpY2snLCBfLmRlYm91bmNlKHNlbmRNYWlsLCAzMDAsIHsKICAgICAqICAgJ2xlYWRpbmcnOiB0cnVlLAogICAgICogICAndHJhaWxpbmcnOiBmYWxzZQogICAgICogfSk7CiAgICAgKgogICAgICogLy8gZW5zdXJlIGBiYXRjaExvZ2AgaXMgZXhlY3V0ZWQgb25jZSBhZnRlciAxIHNlY29uZCBvZiBkZWJvdW5jZWQgY2FsbHMKICAgICAqIHZhciBzb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2UoJy9zdHJlYW0nKTsKICAgICAqIHNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgXy5kZWJvdW5jZShiYXRjaExvZywgMjUwLCB7CiAgICAgKiAgICdtYXhXYWl0JzogMTAwMAogICAgICogfSwgZmFsc2UpOwogICAgICovCiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBvcHRpb25zKSB7CiAgICAgIHZhciBhcmdzLAogICAgICAgICAgbWF4VGltZW91dElkLAogICAgICAgICAgcmVzdWx0LAogICAgICAgICAgc3RhbXAsCiAgICAgICAgICB0aGlzQXJnLAogICAgICAgICAgdGltZW91dElkLAogICAgICAgICAgdHJhaWxpbmdDYWxsLAogICAgICAgICAgbGFzdENhbGxlZCA9IDAsCiAgICAgICAgICBtYXhXYWl0ID0gZmFsc2UsCiAgICAgICAgICB0cmFpbGluZyA9IHRydWU7CgogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHdhaXQgPSBuYXRpdmVNYXgoMCwgd2FpdCkgfHwgMDsKICAgICAgaWYgKG9wdGlvbnMgPT09IHRydWUpIHsKICAgICAgICB2YXIgbGVhZGluZyA9IHRydWU7CiAgICAgICAgdHJhaWxpbmcgPSBmYWxzZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdChvcHRpb25zKSkgewogICAgICAgIGxlYWRpbmcgPSBvcHRpb25zLmxlYWRpbmc7CiAgICAgICAgbWF4V2FpdCA9ICdtYXhXYWl0JyBpbiBvcHRpb25zICYmIChuYXRpdmVNYXgod2FpdCwgb3B0aW9ucy5tYXhXYWl0KSB8fCAwKTsKICAgICAgICB0cmFpbGluZyA9ICd0cmFpbGluZycgaW4gb3B0aW9ucyA/IG9wdGlvbnMudHJhaWxpbmcgOiB0cmFpbGluZzsKICAgICAgfQogICAgICB2YXIgZGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByZW1haW5pbmcgPSB3YWl0IC0gKG5vdygpIC0gc3RhbXApOwogICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgaWYgKG1heFRpbWVvdXRJZCkgewogICAgICAgICAgICBjbGVhclRpbWVvdXQobWF4VGltZW91dElkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhbGxlZCA9IHRyYWlsaW5nQ2FsbDsKICAgICAgICAgIG1heFRpbWVvdXRJZCA9IHRpbWVvdXRJZCA9IHRyYWlsaW5nQ2FsbCA9IHVuZGVmaW5lZDsKICAgICAgICAgIGlmIChpc0NhbGxlZCkgewogICAgICAgICAgICBsYXN0Q2FsbGVkID0gbm93KCk7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgcmVtYWluaW5nKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgbWF4RGVsYXllZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh0aW1lb3V0SWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICBtYXhUaW1lb3V0SWQgPSB0aW1lb3V0SWQgPSB0cmFpbGluZ0NhbGwgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKHRyYWlsaW5nIHx8IChtYXhXYWl0ICE9PSB3YWl0KSkgewogICAgICAgICAgbGFzdENhbGxlZCA9IG5vdygpOwogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgYXJncyA9IGFyZ3VtZW50czsKICAgICAgICBzdGFtcCA9IG5vdygpOwogICAgICAgIHRoaXNBcmcgPSB0aGlzOwogICAgICAgIHRyYWlsaW5nQ2FsbCA9IHRyYWlsaW5nICYmICh0aW1lb3V0SWQgfHwgIWxlYWRpbmcpOwoKICAgICAgICBpZiAobWF4V2FpdCA9PT0gZmFsc2UpIHsKICAgICAgICAgIHZhciBsZWFkaW5nQ2FsbCA9IGxlYWRpbmcgJiYgIXRpbWVvdXRJZDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKCFtYXhUaW1lb3V0SWQgJiYgIWxlYWRpbmcpIHsKICAgICAgICAgICAgbGFzdENhbGxlZCA9IHN0YW1wOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlbWFpbmluZyA9IG1heFdhaXQgLSAoc3RhbXAgLSBsYXN0Q2FsbGVkKTsKICAgICAgICAgIGlmIChyZW1haW5pbmcgPD0gMCkgewogICAgICAgICAgICBpZiAobWF4VGltZW91dElkKSB7CiAgICAgICAgICAgICAgbWF4VGltZW91dElkID0gY2xlYXJUaW1lb3V0KG1heFRpbWVvdXRJZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdENhbGxlZCA9IHN0YW1wOwogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXNBcmcsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgICAgZWxzZSBpZiAoIW1heFRpbWVvdXRJZCkgewogICAgICAgICAgICBtYXhUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KG1heERlbGF5ZWQsIHJlbWFpbmluZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGltZW91dElkICYmIHdhaXQgIT09IG1heFdhaXQpIHsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoZGVsYXllZCwgd2FpdCk7CiAgICAgICAgfQogICAgICAgIGlmIChsZWFkaW5nQ2FsbCkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIERlZmVycyBleGVjdXRpbmcgdGhlIGBmdW5jYCBmdW5jdGlvbiB1bnRpbCB0aGUgY3VycmVudCBjYWxsIHN0YWNrIGhhcyBjbGVhcmVkLgogICAgICogQWRkaXRpb25hbCBhcmd1bWVudHMgd2lsbCBiZSBwcm92aWRlZCB0byBgZnVuY2Agd2hlbiBpdCBpcyBpbnZva2VkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBkZWZlci4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ10gQXJndW1lbnRzIHRvIGludm9rZSB0aGUgZnVuY3Rpb24gd2l0aC4KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFJldHVybnMgdGhlIHRpbWVyIGlkLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLmRlZmVyKGZ1bmN0aW9uKCkgeyBjb25zb2xlLmxvZygnZGVmZXJyZWQnKTsgfSk7CiAgICAgKiAvLyByZXR1cm5zIGZyb20gdGhlIGZ1bmN0aW9uIGJlZm9yZSAnZGVmZXJyZWQnIGlzIGxvZ2dlZAogICAgICovCiAgICBmdW5jdGlvbiBkZWZlcihmdW5jKSB7CiAgICAgIGlmICghaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgIH0KICAgICAgdmFyIGFyZ3MgPSBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBmdW5jLmFwcGx5KHVuZGVmaW5lZCwgYXJncyk7IH0sIDEpOwogICAgfQogICAgLy8gdXNlIGBzZXRJbW1lZGlhdGVgIGlmIGF2YWlsYWJsZSBpbiBOb2RlLmpzCiAgICBpZiAoaXNWOCAmJiBtb2R1bGVFeHBvcnRzICYmIHR5cGVvZiBzZXRJbW1lZGlhdGUgPT0gJ2Z1bmN0aW9uJykgewogICAgICBkZWZlciA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3I7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXRJbW1lZGlhdGUuYXBwbHkoY29udGV4dCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4ZWN1dGVzIHRoZSBgZnVuY2AgZnVuY3Rpb24gYWZ0ZXIgYHdhaXRgIG1pbGxpc2Vjb25kcy4gQWRkaXRpb25hbCBhcmd1bWVudHMKICAgICAqIHdpbGwgYmUgcHJvdmlkZWQgdG8gYGZ1bmNgIHdoZW4gaXQgaXMgaW52b2tlZC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gZGVsYXkuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byBkZWxheSBleGVjdXRpb24uCiAgICAgKiBAcGFyYW0gey4uLip9IFthcmddIEFyZ3VtZW50cyB0byBpbnZva2UgdGhlIGZ1bmN0aW9uIHdpdGguCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIHRoZSB0aW1lciBpZC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGxvZyA9IF8uYmluZChjb25zb2xlLmxvZywgY29uc29sZSk7CiAgICAgKiBfLmRlbGF5KGxvZywgMTAwMCwgJ2xvZ2dlZCBsYXRlcicpOwogICAgICogLy8gPT4gJ2xvZ2dlZCBsYXRlcicgKEFwcGVhcnMgYWZ0ZXIgb25lIHNlY29uZC4pCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRlbGF5KGZ1bmMsIHdhaXQpIHsKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICB2YXIgYXJncyA9IG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKICAgICAgcmV0dXJuIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGZ1bmMuYXBwbHkodW5kZWZpbmVkLCBhcmdzKTsgfSwgd2FpdCk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCBtZW1vaXplcyB0aGUgcmVzdWx0IG9mIGBmdW5jYC4gSWYgYHJlc29sdmVyYCBpcwogICAgICogcHJvdmlkZWQgaXQgd2lsbCBiZSB1c2VkIHRvIGRldGVybWluZSB0aGUgY2FjaGUga2V5IGZvciBzdG9yaW5nIHRoZSByZXN1bHQKICAgICAqIGJhc2VkIG9uIHRoZSBhcmd1bWVudHMgcHJvdmlkZWQgdG8gdGhlIG1lbW9pemVkIGZ1bmN0aW9uLiBCeSBkZWZhdWx0LCB0aGUKICAgICAqIGZpcnN0IGFyZ3VtZW50IHByb3ZpZGVkIHRvIHRoZSBtZW1vaXplZCBmdW5jdGlvbiBpcyB1c2VkIGFzIHRoZSBjYWNoZSBrZXkuCiAgICAgKiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkIHdpdGggdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBtZW1vaXplZCBmdW5jdGlvbi4KICAgICAqIFRoZSByZXN1bHQgY2FjaGUgaXMgZXhwb3NlZCBhcyB0aGUgYGNhY2hlYCBwcm9wZXJ0eSBvbiB0aGUgbWVtb2l6ZWQgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBGdW5jdGlvbnMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMgVGhlIGZ1bmN0aW9uIHRvIGhhdmUgaXRzIG91dHB1dCBtZW1vaXplZC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtyZXNvbHZlcl0gQSBmdW5jdGlvbiB1c2VkIHRvIHJlc29sdmUgdGhlIGNhY2hlIGtleS4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IG1lbW9pemluZyBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGZpYm9uYWNjaSA9IF8ubWVtb2l6ZShmdW5jdGlvbihuKSB7CiAgICAgKiAgIHJldHVybiBuIDwgMiA/IG4gOiBmaWJvbmFjY2kobiAtIDEpICsgZmlib25hY2NpKG4gLSAyKTsKICAgICAqIH0pOwogICAgICoKICAgICAqIHZhciBkYXRhID0gewogICAgICogICAnbW9lJzogeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgJ2N1cmx5JzogeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKiB9OwogICAgICoKICAgICAqIC8vIG1vZGlmeWluZyB0aGUgcmVzdWx0IGNhY2hlCiAgICAgKiB2YXIgc3Rvb2dlID0gXy5tZW1vaXplKGZ1bmN0aW9uKG5hbWUpIHsgcmV0dXJuIGRhdGFbbmFtZV07IH0sIF8uaWRlbnRpdHkpOwogICAgICogc3Rvb2dlKCdjdXJseScpOwogICAgICogLy8gPT4geyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKgogICAgICogc3Rvb2dlLmNhY2hlLmN1cmx5Lm5hbWUgPSAnamVyb21lJzsKICAgICAqIHN0b29nZSgnY3VybHknKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnamVyb21lJywgJ2FnZSc6IDYwIH0KICAgICAqLwogICAgZnVuY3Rpb24gbWVtb2l6ZShmdW5jLCByZXNvbHZlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24oZnVuYykpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHZhciBtZW1vaXplZCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjYWNoZSA9IG1lbW9pemVkLmNhY2hlLAogICAgICAgICAgICBrZXkgPSByZXNvbHZlciA/IHJlc29sdmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiBrZXlQcmVmaXggKyBhcmd1bWVudHNbMF07CgogICAgICAgIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKGNhY2hlLCBrZXkpCiAgICAgICAgICA/IGNhY2hlW2tleV0KICAgICAgICAgIDogKGNhY2hlW2tleV0gPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpOwogICAgICB9CiAgICAgIG1lbW9pemVkLmNhY2hlID0ge307CiAgICAgIHJldHVybiBtZW1vaXplZDsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBmdW5jdGlvbiB0aGF0IGlzIHJlc3RyaWN0ZWQgdG8gZXhlY3V0ZSBgZnVuY2Agb25jZS4gUmVwZWF0IGNhbGxzIHRvCiAgICAgKiB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gdGhlIHZhbHVlIG9mIHRoZSBmaXJzdCBjYWxsLiBUaGUgYGZ1bmNgIGlzIGV4ZWN1dGVkCiAgICAgKiB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiB0aGUgY3JlYXRlZCBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcmVzdHJpY3QuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyByZXN0cmljdGVkIGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaW5pdGlhbGl6ZSA9IF8ub25jZShjcmVhdGVBcHBsaWNhdGlvbik7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiBpbml0aWFsaXplKCk7CiAgICAgKiAvLyBgaW5pdGlhbGl6ZWAgZXhlY3V0ZXMgYGNyZWF0ZUFwcGxpY2F0aW9uYCBvbmNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9uY2UoZnVuYykgewogICAgICB2YXIgcmFuLAogICAgICAgICAgcmVzdWx0OwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHJhbikgewogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmFuID0gdHJ1ZTsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIC8vIGNsZWFyIHRoZSBgZnVuY2AgdmFyaWFibGUgc28gdGhlIGZ1bmN0aW9uIG1heSBiZSBnYXJiYWdlIGNvbGxlY3RlZAogICAgICAgIGZ1bmMgPSBudWxsOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBjYWxsZWQsIGludm9rZXMgYGZ1bmNgIHdpdGggYW55IGFkZGl0aW9uYWwKICAgICAqIGBwYXJ0aWFsYCBhcmd1bWVudHMgcHJlcGVuZGVkIHRvIHRob3NlIHByb3ZpZGVkIHRvIHRoZSBuZXcgZnVuY3Rpb24uIFRoaXMKICAgICAqIG1ldGhvZCBpcyBzaW1pbGFyIHRvIGBfLmJpbmRgIGV4Y2VwdCBpdCBkb2VzICoqbm90KiogYWx0ZXIgdGhlIGB0aGlzYCBiaW5kaW5nLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jIFRoZSBmdW5jdGlvbiB0byBwYXJ0aWFsbHkgYXBwbHkgYXJndW1lbnRzIHRvLgogICAgICogQHBhcmFtIHsuLi4qfSBbYXJnXSBBcmd1bWVudHMgdG8gYmUgcGFydGlhbGx5IGFwcGxpZWQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyBwYXJ0aWFsbHkgYXBwbGllZCBmdW5jdGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGdyZWV0ID0gZnVuY3Rpb24oZ3JlZXRpbmcsIG5hbWUpIHsgcmV0dXJuIGdyZWV0aW5nICsgJyAnICsgbmFtZTsgfTsKICAgICAqIHZhciBoaSA9IF8ucGFydGlhbChncmVldCwgJ2hpJyk7CiAgICAgKiBoaSgnbW9lJyk7CiAgICAgKiAvLyA9PiAnaGkgbW9lJwogICAgICovCiAgICBmdW5jdGlvbiBwYXJ0aWFsKGZ1bmMpIHsKICAgICAgcmV0dXJuIGNyZWF0ZUJvdW5kKGZ1bmMsIDE2LCBuYXRpdmVTbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgaXMgbGlrZSBgXy5wYXJ0aWFsYCBleGNlcHQgdGhhdCBgcGFydGlhbGAgYXJndW1lbnRzIGFyZQogICAgICogYXBwZW5kZWQgdG8gdGhvc2UgcHJvdmlkZWQgdG8gdGhlIG5ldyBmdW5jdGlvbi4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gcGFydGlhbGx5IGFwcGx5IGFyZ3VtZW50cyB0by4KICAgICAqIEBwYXJhbSB7Li4uKn0gW2FyZ10gQXJndW1lbnRzIHRvIGJlIHBhcnRpYWxseSBhcHBsaWVkLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufSBSZXR1cm5zIHRoZSBuZXcgcGFydGlhbGx5IGFwcGxpZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBkZWZhdWx0c0RlZXAgPSBfLnBhcnRpYWxSaWdodChfLm1lcmdlLCBfLmRlZmF1bHRzKTsKICAgICAqCiAgICAgKiB2YXIgb3B0aW9ucyA9IHsKICAgICAqICAgJ3ZhcmlhYmxlJzogJ2RhdGEnLAogICAgICogICAnaW1wb3J0cyc6IHsgJ2pxJzogJCB9CiAgICAgKiB9OwogICAgICoKICAgICAqIGRlZmF1bHRzRGVlcChvcHRpb25zLCBfLnRlbXBsYXRlU2V0dGluZ3MpOwogICAgICoKICAgICAqIG9wdGlvbnMudmFyaWFibGUKICAgICAqIC8vID0+ICdkYXRhJwogICAgICoKICAgICAqIG9wdGlvbnMuaW1wb3J0cwogICAgICogLy8gPT4geyAnXyc6IF8sICdqcSc6ICQgfQogICAgICovCiAgICBmdW5jdGlvbiBwYXJ0aWFsUmlnaHQoZnVuYykgewogICAgICByZXR1cm4gY3JlYXRlQm91bmQoZnVuYywgMzIsIG51bGwsIG5hdGl2ZVNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgZnVuY3Rpb24gdGhhdCwgd2hlbiBleGVjdXRlZCwgd2lsbCBvbmx5IGNhbGwgdGhlIGBmdW5jYCBmdW5jdGlvbgogICAgICogYXQgbW9zdCBvbmNlIHBlciBldmVyeSBgd2FpdGAgbWlsbGlzZWNvbmRzLiBQcm92aWRlIGFuIG9wdGlvbnMgb2JqZWN0IHRvCiAgICAgKiBpbmRpY2F0ZSB0aGF0IGBmdW5jYCBzaG91bGQgYmUgaW52b2tlZCBvbiB0aGUgbGVhZGluZyBhbmQvb3IgdHJhaWxpbmcgZWRnZQogICAgICogb2YgdGhlIGB3YWl0YCB0aW1lb3V0LiBTdWJzZXF1ZW50IGNhbGxzIHRvIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gd2lsbAogICAgICogcmV0dXJuIHRoZSByZXN1bHQgb2YgdGhlIGxhc3QgYGZ1bmNgIGNhbGwuCiAgICAgKgogICAgICogTm90ZTogSWYgYGxlYWRpbmdgIGFuZCBgdHJhaWxpbmdgIG9wdGlvbnMgYXJlIGB0cnVlYCBgZnVuY2Agd2lsbCBiZSBjYWxsZWQKICAgICAqIG9uIHRoZSB0cmFpbGluZyBlZGdlIG9mIHRoZSB0aW1lb3V0IG9ubHkgaWYgdGhlIHRoZSB0aHJvdHRsZWQgZnVuY3Rpb24gaXMKICAgICAqIGludm9rZWQgbW9yZSB0aGFuIG9uY2UgZHVyaW5nIHRoZSBgd2FpdGAgdGltZW91dC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IEZ1bmN0aW9ucwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZnVuYyBUaGUgZnVuY3Rpb24gdG8gdGhyb3R0bGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2FpdCBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB0aHJvdHRsZSBleGVjdXRpb25zIHRvLgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtvcHRpb25zLmxlYWRpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIGxlYWRpbmcgZWRnZSBvZiB0aGUgdGltZW91dC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW29wdGlvbnMudHJhaWxpbmc9dHJ1ZV0gU3BlY2lmeSBleGVjdXRpb24gb24gdGhlIHRyYWlsaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuCiAgICAgKiBAcmV0dXJucyB7RnVuY3Rpb259IFJldHVybnMgdGhlIG5ldyB0aHJvdHRsZWQgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIC8vIGF2b2lkIGV4Y2Vzc2l2ZWx5IHVwZGF0aW5nIHRoZSBwb3NpdGlvbiB3aGlsZSBzY3JvbGxpbmcKICAgICAqIHZhciB0aHJvdHRsZWQgPSBfLnRocm90dGxlKHVwZGF0ZVBvc2l0aW9uLCAxMDApOwogICAgICogalF1ZXJ5KHdpbmRvdykub24oJ3Njcm9sbCcsIHRocm90dGxlZCk7CiAgICAgKgogICAgICogLy8gZXhlY3V0ZSBgcmVuZXdUb2tlbmAgd2hlbiB0aGUgY2xpY2sgZXZlbnQgaXMgZmlyZWQsIGJ1dCBub3QgbW9yZSB0aGFuIG9uY2UgZXZlcnkgNSBtaW51dGVzCiAgICAgKiBqUXVlcnkoJy5pbnRlcmFjdGl2ZScpLm9uKCdjbGljaycsIF8udGhyb3R0bGUocmVuZXdUb2tlbiwgMzAwMDAwLCB7CiAgICAgKiAgICd0cmFpbGluZyc6IGZhbHNlCiAgICAgKiB9KSk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRocm90dGxlKGZ1bmMsIHdhaXQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGxlYWRpbmcgPSB0cnVlLAogICAgICAgICAgdHJhaWxpbmcgPSB0cnVlOwoKICAgICAgaWYgKCFpc0Z1bmN0aW9uKGZ1bmMpKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgICAgfQogICAgICBpZiAob3B0aW9ucyA9PT0gZmFsc2UpIHsKICAgICAgICBsZWFkaW5nID0gZmFsc2U7CiAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3Qob3B0aW9ucykpIHsKICAgICAgICBsZWFkaW5nID0gJ2xlYWRpbmcnIGluIG9wdGlvbnMgPyBvcHRpb25zLmxlYWRpbmcgOiBsZWFkaW5nOwogICAgICAgIHRyYWlsaW5nID0gJ3RyYWlsaW5nJyBpbiBvcHRpb25zID8gb3B0aW9ucy50cmFpbGluZyA6IHRyYWlsaW5nOwogICAgICB9CiAgICAgIGRlYm91bmNlT3B0aW9ucy5sZWFkaW5nID0gbGVhZGluZzsKICAgICAgZGVib3VuY2VPcHRpb25zLm1heFdhaXQgPSB3YWl0OwogICAgICBkZWJvdW5jZU9wdGlvbnMudHJhaWxpbmcgPSB0cmFpbGluZzsKCiAgICAgIHZhciByZXN1bHQgPSBkZWJvdW5jZShmdW5jLCB3YWl0LCBkZWJvdW5jZU9wdGlvbnMpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIGZ1bmN0aW9uIHRoYXQgcHJvdmlkZXMgYHZhbHVlYCB0byB0aGUgd3JhcHBlciBmdW5jdGlvbiBhcyBpdHMKICAgICAqIGZpcnN0IGFyZ3VtZW50LiBBZGRpdGlvbmFsIGFyZ3VtZW50cyBwcm92aWRlZCB0byB0aGUgZnVuY3Rpb24gYXJlIGFwcGVuZGVkCiAgICAgKiB0byB0aG9zZSBwcm92aWRlZCB0byB0aGUgd3JhcHBlciBmdW5jdGlvbi4gVGhlIHdyYXBwZXIgaXMgZXhlY3V0ZWQgd2l0aAogICAgICogdGhlIGB0aGlzYCBiaW5kaW5nIG9mIHRoZSBjcmVhdGVkIGZ1bmN0aW9uLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgRnVuY3Rpb25zCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIFRoZSB2YWx1ZSB0byB3cmFwLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gd3JhcHBlciBUaGUgd3JhcHBlciBmdW5jdGlvbi4KICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgbmV3IGZ1bmN0aW9uLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgaGVsbG8gPSBmdW5jdGlvbihuYW1lKSB7IHJldHVybiAnaGVsbG8gJyArIG5hbWU7IH07CiAgICAgKiBoZWxsbyA9IF8ud3JhcChoZWxsbywgZnVuY3Rpb24oZnVuYykgewogICAgICogICByZXR1cm4gJ2JlZm9yZSwgJyArIGZ1bmMoJ21vZScpICsgJywgYWZ0ZXInOwogICAgICogfSk7CiAgICAgKiBoZWxsbygpOwogICAgICogLy8gPT4gJ2JlZm9yZSwgaGVsbG8gbW9lLCBhZnRlcicKICAgICAqLwogICAgZnVuY3Rpb24gd3JhcCh2YWx1ZSwgd3JhcHBlcikgewogICAgICBpZiAoIWlzRnVuY3Rpb24od3JhcHBlcikpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgYXJncyA9IFt2YWx1ZV07CiAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgIHJldHVybiB3cmFwcGVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9OwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogQ29udmVydHMgdGhlIGNoYXJhY3RlcnMgYCZgLCBgPGAsIGA+YCwgYCJgLCBhbmQgYCdgIGluIGBzdHJpbmdgIHRvIHRoZWlyCiAgICAgKiBjb3JyZXNwb25kaW5nIEhUTUwgZW50aXRpZXMuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzdHJpbmcgVGhlIHN0cmluZyB0byBlc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSBlc2NhcGVkIHN0cmluZy4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5lc2NhcGUoJ01vZSwgTGFycnkgJiBDdXJseScpOwogICAgICogLy8gPT4gJ01vZSwgTGFycnkgJmFtcDsgQ3VybHknCiAgICAgKi8KICAgIGZ1bmN0aW9uIGVzY2FwZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyaW5nKS5yZXBsYWNlKHJlVW5lc2NhcGVkSHRtbCwgZXNjYXBlSHRtbENoYXIpOwogICAgfQoKICAgIC8qKgogICAgICogVGhpcyBtZXRob2QgcmV0dXJucyB0aGUgZmlyc3QgYXJndW1lbnQgcHJvdmlkZWQgdG8gaXQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgQW55IHZhbHVlLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgYHZhbHVlYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIG1vZSA9IHsgJ25hbWUnOiAnbW9lJyB9OwogICAgICogbW9lID09PSBfLmlkZW50aXR5KG1vZSk7CiAgICAgKiAvLyA9PiB0cnVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGlkZW50aXR5KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgZnVuY3Rpb24gcHJvcGVydGllcyBvZiBhIHNvdXJjZSBvYmplY3QgdG8gdGhlIGBsb2Rhc2hgIGZ1bmN0aW9uIGFuZAogICAgICogY2hhaW5hYmxlIHdyYXBwZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBvZiBmdW5jdGlvbiBwcm9wZXJ0aWVzIHRvIGFkZCB0byBgbG9kYXNoYC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5taXhpbih7CiAgICAgKiAgICdjYXBpdGFsaXplJzogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgKiAgICAgcmV0dXJuIHN0cmluZy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zbGljZSgxKS50b0xvd2VyQ2FzZSgpOwogICAgICogICB9CiAgICAgKiB9KTsKICAgICAqCiAgICAgKiBfLmNhcGl0YWxpemUoJ21vZScpOwogICAgICogLy8gPT4gJ01vZScKICAgICAqCiAgICAgKiBfKCdtb2UnKS5jYXBpdGFsaXplKCk7CiAgICAgKiAvLyA9PiAnTW9lJwogICAgICovCiAgICBmdW5jdGlvbiBtaXhpbihvYmplY3QsIHNvdXJjZSkgewogICAgICB2YXIgY3RvciA9IG9iamVjdCwKICAgICAgICAgIGlzRnVuYyA9ICFzb3VyY2UgfHwgaXNGdW5jdGlvbihjdG9yKTsKCiAgICAgIGlmICghc291cmNlKSB7CiAgICAgICAgY3RvciA9IGxvZGFzaFdyYXBwZXI7CiAgICAgICAgc291cmNlID0gb2JqZWN0OwogICAgICAgIG9iamVjdCA9IGxvZGFzaDsKICAgICAgfQogICAgICBmb3JFYWNoKGZ1bmN0aW9ucyhzb3VyY2UpLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIGZ1bmMgPSBvYmplY3RbbWV0aG9kTmFtZV0gPSBzb3VyY2VbbWV0aG9kTmFtZV07CiAgICAgICAgaWYgKGlzRnVuYykgewogICAgICAgICAgY3Rvci5wcm90b3R5cGVbbWV0aG9kTmFtZV0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5fX3dyYXBwZWRfXywKICAgICAgICAgICAgICAgIGFyZ3MgPSBbdmFsdWVdOwoKICAgICAgICAgICAgcHVzaC5hcHBseShhcmdzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB2YXIgcmVzdWx0ID0gZnVuYy5hcHBseShvYmplY3QsIGFyZ3MpOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09ICdvYmplY3QnICYmIHZhbHVlID09PSByZXN1bHQpIHsKICAgICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXN1bHQgPSBuZXcgY3RvcihyZXN1bHQpOwogICAgICAgICAgICByZXN1bHQuX19jaGFpbl9fID0gdGhpcy5fX2NoYWluX187CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXZlcnRzIHRoZSAnXycgdmFyaWFibGUgdG8gaXRzIHByZXZpb3VzIHZhbHVlIGFuZCByZXR1cm5zIGEgcmVmZXJlbmNlIHRvCiAgICAgKiB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEByZXR1cm5zIHtGdW5jdGlvbn0gUmV0dXJucyB0aGUgYGxvZGFzaGAgZnVuY3Rpb24uCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIHZhciBsb2Rhc2ggPSBfLm5vQ29uZmxpY3QoKTsKICAgICAqLwogICAgZnVuY3Rpb24gbm9Db25mbGljdCgpIHsKICAgICAgY29udGV4dC5fID0gb2xkRGFzaDsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgLyoqCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gdmFsdWUgaW50byBhbiBpbnRlZ2VyIG9mIHRoZSBzcGVjaWZpZWQgcmFkaXguCiAgICAgKiBJZiBgcmFkaXhgIGlzIGB1bmRlZmluZWRgIG9yIGAwYCBhIGByYWRpeGAgb2YgYDEwYCBpcyB1c2VkIHVubGVzcyB0aGUKICAgICAqIGB2YWx1ZWAgaXMgYSBoZXhhZGVjaW1hbCwgaW4gd2hpY2ggY2FzZSBhIGByYWRpeGAgb2YgYDE2YCBpcyB1c2VkLgogICAgICoKICAgICAqIE5vdGU6IFRoaXMgbWV0aG9kIGF2b2lkcyBkaWZmZXJlbmNlcyBpbiBuYXRpdmUgRVMzIGFuZCBFUzUgYHBhcnNlSW50YAogICAgICogaW1wbGVtZW50YXRpb25zLiBTZWUgaHR0cDovL2VzNS5naXRodWIuaW8vI0UuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSBUaGUgdmFsdWUgdG8gcGFyc2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3JhZGl4XSBUaGUgcmFkaXggdXNlZCB0byBpbnRlcnByZXQgdGhlIHZhbHVlIHRvIHBhcnNlLgogICAgICogQHJldHVybnMge251bWJlcn0gUmV0dXJucyB0aGUgbmV3IGludGVnZXIgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8ucGFyc2VJbnQoJzA4Jyk7CiAgICAgKiAvLyA9PiA4CiAgICAgKi8KICAgIHZhciBwYXJzZUludCA9IG5hdGl2ZVBhcnNlSW50KHdoaXRlc3BhY2UgKyAnMDgnKSA9PSA4ID8gbmF0aXZlUGFyc2VJbnQgOiBmdW5jdGlvbih2YWx1ZSwgcmFkaXgpIHsKICAgICAgLy8gRmlyZWZveCBhbmQgT3BlcmEgc3RpbGwgZm9sbG93IHRoZSBFUzMgc3BlY2lmaWVkIGltcGxlbWVudGF0aW9uIG9mIGBwYXJzZUludGAKICAgICAgcmV0dXJuIG5hdGl2ZVBhcnNlSW50KGlzU3RyaW5nKHZhbHVlKSA/IHZhbHVlLnJlcGxhY2UocmVMZWFkaW5nU3BhY2VzQW5kWmVyb3MsICcnKSA6IHZhbHVlLCByYWRpeCB8fCAwKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBQcm9kdWNlcyBhIHJhbmRvbSBudW1iZXIgYmV0d2VlbiBgbWluYCBhbmQgYG1heGAgKGluY2x1c2l2ZSkuIElmIG9ubHkgb25lCiAgICAgKiBhcmd1bWVudCBpcyBwcm92aWRlZCBhIG51bWJlciBiZXR3ZWVuIGAwYCBhbmQgdGhlIGdpdmVuIG51bWJlciB3aWxsIGJlCiAgICAgKiByZXR1cm5lZC4gSWYgYGZsb2F0aW5nYCBpcyB0cnVleSBvciBlaXRoZXIgYG1pbmAgb3IgYG1heGAgYXJlIGZsb2F0cyBhCiAgICAgKiBmbG9hdGluZy1wb2ludCBudW1iZXIgd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIGFuIGludGVnZXIuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWluPTBdIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHZhbHVlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXg9MV0gVGhlIG1heGltdW0gcG9zc2libGUgdmFsdWUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmbG9hdGluZz1mYWxzZV0gU3BlY2lmeSByZXR1cm5pbmcgYSBmbG9hdGluZy1wb2ludCBudW1iZXIuCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBSZXR1cm5zIGEgcmFuZG9tIG51bWJlci4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXy5yYW5kb20oMCwgNSk7CiAgICAgKiAvLyA9PiBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDUpOwogICAgICogLy8gPT4gYWxzbyBhbiBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgNQogICAgICoKICAgICAqIF8ucmFuZG9tKDUsIHRydWUpOwogICAgICogLy8gPT4gYSBmbG9hdGluZy1wb2ludCBudW1iZXIgYmV0d2VlbiAwIGFuZCA1CiAgICAgKgogICAgICogXy5yYW5kb20oMS4yLCA1LjIpOwogICAgICogLy8gPT4gYSBmbG9hdGluZy1wb2ludCBudW1iZXIgYmV0d2VlbiAxLjIgYW5kIDUuMgogICAgICovCiAgICBmdW5jdGlvbiByYW5kb20obWluLCBtYXgsIGZsb2F0aW5nKSB7CiAgICAgIHZhciBub01pbiA9IG1pbiA9PSBudWxsLAogICAgICAgICAgbm9NYXggPSBtYXggPT0gbnVsbDsKCiAgICAgIGlmIChmbG9hdGluZyA9PSBudWxsKSB7CiAgICAgICAgaWYgKHR5cGVvZiBtaW4gPT0gJ2Jvb2xlYW4nICYmIG5vTWF4KSB7CiAgICAgICAgICBmbG9hdGluZyA9IG1pbjsKICAgICAgICAgIG1pbiA9IDE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCFub01heCAmJiB0eXBlb2YgbWF4ID09ICdib29sZWFuJykgewogICAgICAgICAgZmxvYXRpbmcgPSBtYXg7CiAgICAgICAgICBub01heCA9IHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChub01pbiAmJiBub01heCkgewogICAgICAgIG1heCA9IDE7CiAgICAgIH0KICAgICAgbWluID0gK21pbiB8fCAwOwogICAgICBpZiAobm9NYXgpIHsKICAgICAgICBtYXggPSBtaW47CiAgICAgICAgbWluID0gMDsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXggPSArbWF4IHx8IDA7CiAgICAgIH0KICAgICAgdmFyIHJhbmQgPSBuYXRpdmVSYW5kb20oKTsKICAgICAgcmV0dXJuIChmbG9hdGluZyB8fCBtaW4gJSAxIHx8IG1heCAlIDEpCiAgICAgICAgPyBuYXRpdmVNaW4obWluICsgKHJhbmQgKiAobWF4IC0gbWluICsgcGFyc2VGbG9hdCgnMWUtJyArICgocmFuZCArJycpLmxlbmd0aCAtIDEpKSkpLCBtYXgpCiAgICAgICAgOiBtaW4gKyBmbG9vcihyYW5kICogKG1heCAtIG1pbiArIDEpKTsKICAgIH0KCiAgICAvKioKICAgICAqIFJlc29sdmVzIHRoZSB2YWx1ZSBvZiBgcHJvcGVydHlgIG9uIGBvYmplY3RgLiBJZiBgcHJvcGVydHlgIGlzIGEgZnVuY3Rpb24KICAgICAqIGl0IHdpbGwgYmUgaW52b2tlZCB3aXRoIHRoZSBgdGhpc2AgYmluZGluZyBvZiBgb2JqZWN0YCBhbmQgaXRzIHJlc3VsdCByZXR1cm5lZCwKICAgICAqIGVsc2UgdGhlIHByb3BlcnR5IHZhbHVlIGlzIHJldHVybmVkLiBJZiBgb2JqZWN0YCBpcyBmYWxzZXkgdGhlbiBgdW5kZWZpbmVkYAogICAgICogaXMgcmV0dXJuZWQuCiAgICAgKgogICAgICogQHN0YXRpYwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBVdGlsaXRpZXMKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IFRoZSBwcm9wZXJ0eSB0byBnZXQgdGhlIHZhbHVlIG9mLgogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHJlc29sdmVkIHZhbHVlLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgb2JqZWN0ID0gewogICAgICogICAnY2hlZXNlJzogJ2NydW1wZXRzJywKICAgICAqICAgJ3N0dWZmJzogZnVuY3Rpb24oKSB7CiAgICAgKiAgICAgcmV0dXJuICdub25zZW5zZSc7CiAgICAgKiAgIH0KICAgICAqIH07CiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnY2hlZXNlJyk7CiAgICAgKiAvLyA9PiAnY3J1bXBldHMnCiAgICAgKgogICAgICogXy5yZXN1bHQob2JqZWN0LCAnc3R1ZmYnKTsKICAgICAqIC8vID0+ICdub25zZW5zZScKICAgICAqLwogICAgZnVuY3Rpb24gcmVzdWx0KG9iamVjdCwgcHJvcGVydHkpIHsKICAgICAgaWYgKG9iamVjdCkgewogICAgICAgIHZhciB2YWx1ZSA9IG9iamVjdFtwcm9wZXJ0eV07CiAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb24odmFsdWUpID8gb2JqZWN0W3Byb3BlcnR5XSgpIDogdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEEgbWljcm8tdGVtcGxhdGluZyBtZXRob2QgdGhhdCBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMKICAgICAqIHdoaXRlc3BhY2UsIGFuZCBjb3JyZWN0bHkgZXNjYXBlcyBxdW90ZXMgd2l0aGluIGludGVycG9sYXRlZCBjb2RlLgogICAgICoKICAgICAqIE5vdGU6IEluIHRoZSBkZXZlbG9wbWVudCBidWlsZCwgYF8udGVtcGxhdGVgIHV0aWxpemVzIHNvdXJjZVVSTHMgZm9yIGVhc2llcgogICAgICogZGVidWdnaW5nLiBTZWUgaHR0cDovL3d3dy5odG1sNXJvY2tzLmNvbS9lbi90dXRvcmlhbHMvZGV2ZWxvcGVydG9vbHMvc291cmNlbWFwcy8jdG9jLXNvdXJjZXVybAogICAgICoKICAgICAqIEZvciBtb3JlIGluZm9ybWF0aW9uIG9uIHByZWNvbXBpbGluZyB0ZW1wbGF0ZXMgc2VlOgogICAgICogaHR0cDovL2xvZGFzaC5jb20vI2N1c3RvbS1idWlsZHMKICAgICAqCiAgICAgKiBGb3IgbW9yZSBpbmZvcm1hdGlvbiBvbiBDaHJvbWUgZXh0ZW5zaW9uIHNhbmRib3hlcyBzZWU6CiAgICAgKiBodHRwOi8vZGV2ZWxvcGVyLmNocm9tZS5jb20vc3RhYmxlL2V4dGVuc2lvbnMvc2FuZGJveGluZ0V2YWwuaHRtbAogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCBUaGUgdGVtcGxhdGUgdGV4dC4KICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIG9iamVjdCB1c2VkIHRvIHBvcHVsYXRlIHRoZSB0ZXh0LgogICAgICogQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBUaGUgb3B0aW9ucyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuZXNjYXBlXSBUaGUgImVzY2FwZSIgZGVsaW1pdGVyLgogICAgICogQHBhcmFtIHtSZWdFeHB9IFtvcHRpb25zLmV2YWx1YXRlXSBUaGUgImV2YWx1YXRlIiBkZWxpbWl0ZXIuCiAgICAgKiBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMuaW1wb3J0c10gQW4gb2JqZWN0IHRvIGltcG9ydCBpbnRvIHRoZSB0ZW1wbGF0ZSBhcyBsb2NhbCB2YXJpYWJsZXMuCiAgICAgKiBAcGFyYW0ge1JlZ0V4cH0gW29wdGlvbnMuaW50ZXJwb2xhdGVdIFRoZSAiaW50ZXJwb2xhdGUiIGRlbGltaXRlci4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbc291cmNlVVJMXSBUaGUgc291cmNlVVJMIG9mIHRoZSB0ZW1wbGF0ZSdzIGNvbXBpbGVkIHNvdXJjZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdmFyaWFibGVdIFRoZSBkYXRhIG9iamVjdCB2YXJpYWJsZSBuYW1lLgogICAgICogQHJldHVybnMge0Z1bmN0aW9ufHN0cmluZ30gUmV0dXJucyBhIGNvbXBpbGVkIGZ1bmN0aW9uIHdoZW4gbm8gYGRhdGFgIG9iamVjdAogICAgICogIGlzIGdpdmVuLCBlbHNlIGl0IHJldHVybnMgdGhlIGludGVycG9sYXRlZCB0ZXh0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgImludGVycG9sYXRlIiBkZWxpbWl0ZXIgdG8gY3JlYXRlIGEgY29tcGlsZWQgdGVtcGxhdGUKICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+Jyk7CiAgICAgKiBjb21waWxlZCh7ICduYW1lJzogJ21vZScgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gbW9lJwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiZXNjYXBlIiBkZWxpbWl0ZXIgdG8gZXNjYXBlIEhUTUwgaW4gZGF0YSBwcm9wZXJ0eSB2YWx1ZXMKICAgICAqIF8udGVtcGxhdGUoJzxiPjwlLSB2YWx1ZSAlPjwvYj4nLCB7ICd2YWx1ZSc6ICc8c2NyaXB0PicgfSk7CiAgICAgKiAvLyA9PiAnPGI+Jmx0O3NjcmlwdCZndDs8L2I+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSAiZXZhbHVhdGUiIGRlbGltaXRlciB0byBnZW5lcmF0ZSBIVE1MCiAgICAgKiB2YXIgbGlzdCA9ICc8JSBfLmZvckVhY2gocGVvcGxlLCBmdW5jdGlvbihuYW1lKSB7ICU+PGxpPjwlLSBuYW1lICU+PC9saT48JSB9KTsgJT4nOwogICAgICogXy50ZW1wbGF0ZShsaXN0LCB7ICdwZW9wbGUnOiBbJ21vZScsICdsYXJyeSddIH0pOwogICAgICogLy8gPT4gJzxsaT5tb2U8L2xpPjxsaT5sYXJyeTwvbGk+JwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBFUzYgZGVsaW1pdGVyIGFzIGFuIGFsdGVybmF0aXZlIHRvIHRoZSBkZWZhdWx0ICJpbnRlcnBvbGF0ZSIgZGVsaW1pdGVyCiAgICAgKiBfLnRlbXBsYXRlKCdoZWxsbyAkeyBuYW1lIH0nLCB7ICduYW1lJzogJ2N1cmx5JyB9KTsKICAgICAqIC8vID0+ICdoZWxsbyBjdXJseScKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgaW50ZXJuYWwgYHByaW50YCBmdW5jdGlvbiBpbiAiZXZhbHVhdGUiIGRlbGltaXRlcnMKICAgICAqIF8udGVtcGxhdGUoJzwlIHByaW50KCJoZWxsbyAiICsgbmFtZSk7ICU+IScsIHsgJ25hbWUnOiAnbGFycnknIH0pOwogICAgICogLy8gPT4gJ2hlbGxvIGxhcnJ5IScKICAgICAqCiAgICAgKiAvLyB1c2luZyBhIGN1c3RvbSB0ZW1wbGF0ZSBkZWxpbWl0ZXJzCiAgICAgKiBfLnRlbXBsYXRlU2V0dGluZ3MgPSB7CiAgICAgKiAgICdpbnRlcnBvbGF0ZSc6IC97eyhbXHNcU10rPyl9fS9nCiAgICAgKiB9OwogICAgICoKICAgICAqIF8udGVtcGxhdGUoJ2hlbGxvIHt7IG5hbWUgfX0hJywgeyAnbmFtZSc6ICdtdXN0YWNoZScgfSk7CiAgICAgKiAvLyA9PiAnaGVsbG8gbXVzdGFjaGUhJwogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgaW1wb3J0c2Agb3B0aW9uIHRvIGltcG9ydCBqUXVlcnkKICAgICAqIHZhciBsaXN0ID0gJzwlICQuZWFjaChwZW9wbGUsIGZ1bmN0aW9uKG5hbWUpIHsgJT48bGk+PCUtIG5hbWUgJT48L2xpPjwlIH0pOyAlPic7CiAgICAgKiBfLnRlbXBsYXRlKGxpc3QsIHsgJ3Blb3BsZSc6IFsnbW9lJywgJ2xhcnJ5J10gfSwgeyAnaW1wb3J0cyc6IHsgJyQnOiBqUXVlcnkgfSB9KTsKICAgICAqIC8vID0+ICc8bGk+bW9lPC9saT48bGk+bGFycnk8L2xpPicKICAgICAqCiAgICAgKiAvLyB1c2luZyB0aGUgYHNvdXJjZVVSTGAgb3B0aW9uIHRvIHNwZWNpZnkgYSBjdXN0b20gc291cmNlVVJMIGZvciB0aGUgdGVtcGxhdGUKICAgICAqIHZhciBjb21waWxlZCA9IF8udGVtcGxhdGUoJ2hlbGxvIDwlPSBuYW1lICU+JywgbnVsbCwgeyAnc291cmNlVVJMJzogJy9iYXNpYy9ncmVldGluZy5qc3QnIH0pOwogICAgICogY29tcGlsZWQoZGF0YSk7CiAgICAgKiAvLyA9PiBmaW5kIHRoZSBzb3VyY2Ugb2YgImdyZWV0aW5nLmpzdCIgdW5kZXIgdGhlIFNvdXJjZXMgdGFiIG9yIFJlc291cmNlcyBwYW5lbCBvZiB0aGUgd2ViIGluc3BlY3RvcgogICAgICoKICAgICAqIC8vIHVzaW5nIHRoZSBgdmFyaWFibGVgIG9wdGlvbiB0byBlbnN1cmUgYSB3aXRoLXN0YXRlbWVudCBpc24ndCB1c2VkIGluIHRoZSBjb21waWxlZCB0ZW1wbGF0ZQogICAgICogdmFyIGNvbXBpbGVkID0gXy50ZW1wbGF0ZSgnaGkgPCU9IGRhdGEubmFtZSAlPiEnLCBudWxsLCB7ICd2YXJpYWJsZSc6ICdkYXRhJyB9KTsKICAgICAqIGNvbXBpbGVkLnNvdXJjZTsKICAgICAqIC8vID0+IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAqICAgdmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlOwogICAgICogICBfX3AgKz0gJ2hpICcgKyAoKF9fdCA9ICggZGF0YS5uYW1lICkpID09IG51bGwgPyAnJyA6IF9fdCkgKyAnISc7CiAgICAgKiAgIHJldHVybiBfX3A7CiAgICAgKiB9CiAgICAgKgogICAgICogLy8gdXNpbmcgdGhlIGBzb3VyY2VgIHByb3BlcnR5IHRvIGlubGluZSBjb21waWxlZCB0ZW1wbGF0ZXMgZm9yIG1lYW5pbmdmdWwKICAgICAqIC8vIGxpbmUgbnVtYmVycyBpbiBlcnJvciBtZXNzYWdlcyBhbmQgYSBzdGFjayB0cmFjZQogICAgICogZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oY3dkLCAnanN0LmpzJyksICdcCiAgICAgKiAgIHZhciBKU1QgPSB7XAogICAgICogICAgICJtYWluIjogJyArIF8udGVtcGxhdGUobWFpblRleHQpLnNvdXJjZSArICdcCiAgICAgKiAgIH07XAogICAgICogJyk7CiAgICAgKi8KICAgIGZ1bmN0aW9uIHRlbXBsYXRlKHRleHQsIGRhdGEsIG9wdGlvbnMpIHsKICAgICAgLy8gYmFzZWQgb24gSm9obiBSZXNpZydzIGB0bXBsYCBpbXBsZW1lbnRhdGlvbgogICAgICAvLyBodHRwOi8vZWpvaG4ub3JnL2Jsb2cvamF2YXNjcmlwdC1taWNyby10ZW1wbGF0aW5nLwogICAgICAvLyBhbmQgTGF1cmEgRG9rdG9yb3ZhJ3MgZG9ULmpzCiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9vbGFkby9kb1QKICAgICAgdmFyIHNldHRpbmdzID0gbG9kYXNoLnRlbXBsYXRlU2V0dGluZ3M7CiAgICAgIHRleHQgfHwgKHRleHQgPSAnJyk7CgogICAgICAvLyBhdm9pZCBtaXNzaW5nIGRlcGVuZGVuY2llcyB3aGVuIGBpdGVyYXRvclRlbXBsYXRlYCBpcyBub3QgZGVmaW5lZAogICAgICBvcHRpb25zID0gZGVmYXVsdHMoe30sIG9wdGlvbnMsIHNldHRpbmdzKTsKCiAgICAgIHZhciBpbXBvcnRzID0gZGVmYXVsdHMoe30sIG9wdGlvbnMuaW1wb3J0cywgc2V0dGluZ3MuaW1wb3J0cyksCiAgICAgICAgICBpbXBvcnRzS2V5cyA9IGtleXMoaW1wb3J0cyksCiAgICAgICAgICBpbXBvcnRzVmFsdWVzID0gdmFsdWVzKGltcG9ydHMpOwoKICAgICAgdmFyIGlzRXZhbHVhdGluZywKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGludGVycG9sYXRlID0gb3B0aW9ucy5pbnRlcnBvbGF0ZSB8fCByZU5vTWF0Y2gsCiAgICAgICAgICBzb3VyY2UgPSAiX19wICs9ICciOwoKICAgICAgLy8gY29tcGlsZSB0aGUgcmVnZXhwIHRvIG1hdGNoIGVhY2ggZGVsaW1pdGVyCiAgICAgIHZhciByZURlbGltaXRlcnMgPSBSZWdFeHAoCiAgICAgICAgKG9wdGlvbnMuZXNjYXBlIHx8IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgICBpbnRlcnBvbGF0ZS5zb3VyY2UgKyAnfCcgKwogICAgICAgIChpbnRlcnBvbGF0ZSA9PT0gcmVJbnRlcnBvbGF0ZSA/IHJlRXNUZW1wbGF0ZSA6IHJlTm9NYXRjaCkuc291cmNlICsgJ3wnICsKICAgICAgICAob3B0aW9ucy5ldmFsdWF0ZSB8fCByZU5vTWF0Y2gpLnNvdXJjZSArICd8JCcKICAgICAgLCAnZycpOwoKICAgICAgdGV4dC5yZXBsYWNlKHJlRGVsaW1pdGVycywgZnVuY3Rpb24obWF0Y2gsIGVzY2FwZVZhbHVlLCBpbnRlcnBvbGF0ZVZhbHVlLCBlc1RlbXBsYXRlVmFsdWUsIGV2YWx1YXRlVmFsdWUsIG9mZnNldCkgewogICAgICAgIGludGVycG9sYXRlVmFsdWUgfHwgKGludGVycG9sYXRlVmFsdWUgPSBlc1RlbXBsYXRlVmFsdWUpOwoKICAgICAgICAvLyBlc2NhcGUgY2hhcmFjdGVycyB0aGF0IGNhbm5vdCBiZSBpbmNsdWRlZCBpbiBzdHJpbmcgbGl0ZXJhbHMKICAgICAgICBzb3VyY2UgKz0gdGV4dC5zbGljZShpbmRleCwgb2Zmc2V0KS5yZXBsYWNlKHJlVW5lc2NhcGVkU3RyaW5nLCBlc2NhcGVTdHJpbmdDaGFyKTsKCiAgICAgICAgLy8gcmVwbGFjZSBkZWxpbWl0ZXJzIHdpdGggc25pcHBldHMKICAgICAgICBpZiAoZXNjYXBlVmFsdWUpIHsKICAgICAgICAgIHNvdXJjZSArPSAiJyArXG5fX2UoIiArIGVzY2FwZVZhbHVlICsgIikgK1xuJyI7CiAgICAgICAgfQogICAgICAgIGlmIChldmFsdWF0ZVZhbHVlKSB7CiAgICAgICAgICBpc0V2YWx1YXRpbmcgPSB0cnVlOwogICAgICAgICAgc291cmNlICs9ICInO1xuIiArIGV2YWx1YXRlVmFsdWUgKyAiO1xuX19wICs9ICciOwogICAgICAgIH0KICAgICAgICBpZiAoaW50ZXJwb2xhdGVWYWx1ZSkgewogICAgICAgICAgc291cmNlICs9ICInICtcbigoX190ID0gKCIgKyBpbnRlcnBvbGF0ZVZhbHVlICsgIikpID09IG51bGwgPyAnJyA6IF9fdCkgK1xuJyI7CiAgICAgICAgfQogICAgICAgIGluZGV4ID0gb2Zmc2V0ICsgbWF0Y2gubGVuZ3RoOwoKICAgICAgICAvLyB0aGUgSlMgZW5naW5lIGVtYmVkZGVkIGluIEFkb2JlIHByb2R1Y3RzIHJlcXVpcmVzIHJldHVybmluZyB0aGUgYG1hdGNoYAogICAgICAgIC8vIHN0cmluZyBpbiBvcmRlciB0byBwcm9kdWNlIHRoZSBjb3JyZWN0IGBvZmZzZXRgIHZhbHVlCiAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICB9KTsKCiAgICAgIHNvdXJjZSArPSAiJztcbiI7CgogICAgICAvLyBpZiBgdmFyaWFibGVgIGlzIG5vdCBzcGVjaWZpZWQsIHdyYXAgYSB3aXRoLXN0YXRlbWVudCBhcm91bmQgdGhlIGdlbmVyYXRlZAogICAgICAvLyBjb2RlIHRvIGFkZCB0aGUgZGF0YSBvYmplY3QgdG8gdGhlIHRvcCBvZiB0aGUgc2NvcGUgY2hhaW4KICAgICAgdmFyIHZhcmlhYmxlID0gb3B0aW9ucy52YXJpYWJsZSwKICAgICAgICAgIGhhc1ZhcmlhYmxlID0gdmFyaWFibGU7CgogICAgICBpZiAoIWhhc1ZhcmlhYmxlKSB7CiAgICAgICAgdmFyaWFibGUgPSAnb2JqJzsKICAgICAgICBzb3VyY2UgPSAnd2l0aCAoJyArIHZhcmlhYmxlICsgJykge1xuJyArIHNvdXJjZSArICdcbn1cbic7CiAgICAgIH0KICAgICAgLy8gY2xlYW51cCBjb2RlIGJ5IHN0cmlwcGluZyBlbXB0eSBzdHJpbmdzCiAgICAgIHNvdXJjZSA9IChpc0V2YWx1YXRpbmcgPyBzb3VyY2UucmVwbGFjZShyZUVtcHR5U3RyaW5nTGVhZGluZywgJycpIDogc291cmNlKQogICAgICAgIC5yZXBsYWNlKHJlRW1wdHlTdHJpbmdNaWRkbGUsICckMScpCiAgICAgICAgLnJlcGxhY2UocmVFbXB0eVN0cmluZ1RyYWlsaW5nLCAnJDE7Jyk7CgogICAgICAvLyBmcmFtZSBjb2RlIGFzIHRoZSBmdW5jdGlvbiBib2R5CiAgICAgIHNvdXJjZSA9ICdmdW5jdGlvbignICsgdmFyaWFibGUgKyAnKSB7XG4nICsKICAgICAgICAoaGFzVmFyaWFibGUgPyAnJyA6IHZhcmlhYmxlICsgJyB8fCAoJyArIHZhcmlhYmxlICsgJyA9IHt9KTtcbicpICsKICAgICAgICAidmFyIF9fdCwgX19wID0gJycsIF9fZSA9IF8uZXNjYXBlIiArCiAgICAgICAgKGlzRXZhbHVhdGluZwogICAgICAgICAgPyAnLCBfX2ogPSBBcnJheS5wcm90b3R5cGUuam9pbjtcbicgKwogICAgICAgICAgICAiZnVuY3Rpb24gcHJpbnQoKSB7IF9fcCArPSBfX2ouY2FsbChhcmd1bWVudHMsICcnKSB9XG4iCiAgICAgICAgICA6ICc7XG4nCiAgICAgICAgKSArCiAgICAgICAgc291cmNlICsKICAgICAgICAncmV0dXJuIF9fcFxufSc7CgogICAgICAvLyBVc2UgYSBzb3VyY2VVUkwgZm9yIGVhc2llciBkZWJ1Z2dpbmcuCiAgICAgIC8vIGh0dHA6Ly93d3cuaHRtbDVyb2Nrcy5jb20vZW4vdHV0b3JpYWxzL2RldmVsb3BlcnRvb2xzL3NvdXJjZW1hcHMvI3RvYy1zb3VyY2V1cmwKICAgICAgdmFyIHNvdXJjZVVSTCA9ICdcbi8qXG4vLyMgc291cmNlVVJMPScgKyAob3B0aW9ucy5zb3VyY2VVUkwgfHwgJy9sb2Rhc2gvdGVtcGxhdGUvc291cmNlWycgKyAodGVtcGxhdGVDb3VudGVyKyspICsgJ10nKSArICdcbiovJzsKCiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IEZ1bmN0aW9uKGltcG9ydHNLZXlzLCAncmV0dXJuICcgKyBzb3VyY2UgKyBzb3VyY2VVUkwpLmFwcGx5KHVuZGVmaW5lZCwgaW1wb3J0c1ZhbHVlcyk7CiAgICAgIH0gY2F0Y2goZSkgewogICAgICAgIGUuc291cmNlID0gc291cmNlOwogICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgICAgaWYgKGRhdGEpIHsKICAgICAgICByZXR1cm4gcmVzdWx0KGRhdGEpOwogICAgICB9CiAgICAgIC8vIHByb3ZpZGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uJ3Mgc291cmNlIGJ5IGl0cyBgdG9TdHJpbmdgIG1ldGhvZCwgaW4KICAgICAgLy8gc3VwcG9ydGVkIGVudmlyb25tZW50cywgb3IgdGhlIGBzb3VyY2VgIHByb3BlcnR5IGFzIGEgY29udmVuaWVuY2UgZm9yCiAgICAgIC8vIGlubGluaW5nIGNvbXBpbGVkIHRlbXBsYXRlcyBkdXJpbmcgdGhlIGJ1aWxkIHByb2Nlc3MKICAgICAgcmVzdWx0LnNvdXJjZSA9IHNvdXJjZTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICAvKioKICAgICAqIEV4ZWN1dGVzIHRoZSBjYWxsYmFjayBgbmAgdGltZXMsIHJldHVybmluZyBhbiBhcnJheSBvZiB0aGUgcmVzdWx0cwogICAgICogb2YgZWFjaCBjYWxsYmFjayBleGVjdXRpb24uIFRoZSBjYWxsYmFjayBpcyBib3VuZCB0byBgdGhpc0FyZ2AgYW5kIGludm9rZWQKICAgICAqIHdpdGggb25lIGFyZ3VtZW50OyAoaW5kZXgpLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbiBUaGUgbnVtYmVyIG9mIHRpbWVzIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrLgogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIGNhbGxlZCBwZXIgaXRlcmF0aW9uLgogICAgICogQHBhcmFtIHsqfSBbdGhpc0FyZ10gVGhlIGB0aGlzYCBiaW5kaW5nIG9mIGBjYWxsYmFja2AuCiAgICAgKiBAcmV0dXJucyB7QXJyYXl9IFJldHVybnMgYW4gYXJyYXkgb2YgdGhlIHJlc3VsdHMgb2YgZWFjaCBgY2FsbGJhY2tgIGV4ZWN1dGlvbi4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIGRpY2VSb2xscyA9IF8udGltZXMoMywgXy5wYXJ0aWFsKF8ucmFuZG9tLCAxLCA2KSk7CiAgICAgKiAvLyA9PiBbMywgNiwgNF0KICAgICAqCiAgICAgKiBfLnRpbWVzKDMsIGZ1bmN0aW9uKG4pIHsgbWFnZS5jYXN0U3BlbGwobik7IH0pOwogICAgICogLy8gPT4gY2FsbHMgYG1hZ2UuY2FzdFNwZWxsKG4pYCB0aHJlZSB0aW1lcywgcGFzc2luZyBgbmAgb2YgYDBgLCBgMWAsIGFuZCBgMmAgcmVzcGVjdGl2ZWx5CiAgICAgKgogICAgICogXy50aW1lcygzLCBmdW5jdGlvbihuKSB7IHRoaXMuY2FzdChuKTsgfSwgbWFnZSk7CiAgICAgKiAvLyA9PiBhbHNvIGNhbGxzIGBtYWdlLmNhc3RTcGVsbChuKWAgdGhyZWUgdGltZXMKICAgICAqLwogICAgZnVuY3Rpb24gdGltZXMobiwgY2FsbGJhY2ssIHRoaXNBcmcpIHsKICAgICAgbiA9IChuID0gK24pID4gLTEgPyBuIDogMDsKICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICByZXN1bHQgPSBBcnJheShuKTsKCiAgICAgIGNhbGxiYWNrID0gYmFzZUNyZWF0ZUNhbGxiYWNrKGNhbGxiYWNrLCB0aGlzQXJnLCAxKTsKICAgICAgd2hpbGUgKCsraW5kZXggPCBuKSB7CiAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNhbGxiYWNrKGluZGV4KTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIC8qKgogICAgICogVGhlIGludmVyc2Ugb2YgYF8uZXNjYXBlYCB0aGlzIG1ldGhvZCBjb252ZXJ0cyB0aGUgSFRNTCBlbnRpdGllcwogICAgICogYCZhbXA7YCwgYCZsdDtgLCBgJmd0O2AsIGAmcXVvdDtgLCBhbmQgYCYjMzk7YCBpbiBgc3RyaW5nYCB0byB0aGVpcgogICAgICogY29ycmVzcG9uZGluZyBjaGFyYWN0ZXJzLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgVXRpbGl0aWVzCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3RyaW5nIFRoZSBzdHJpbmcgdG8gdW5lc2NhcGUuCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmVzY2FwZWQgc3RyaW5nLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfLnVuZXNjYXBlKCdNb2UsIExhcnJ5ICZhbXA7IEN1cmx5Jyk7CiAgICAgKiAvLyA9PiAnTW9lLCBMYXJyeSAmIEN1cmx5JwogICAgICovCiAgICBmdW5jdGlvbiB1bmVzY2FwZShzdHJpbmcpIHsKICAgICAgcmV0dXJuIHN0cmluZyA9PSBudWxsID8gJycgOiBTdHJpbmcoc3RyaW5nKS5yZXBsYWNlKHJlRXNjYXBlZEh0bWwsIHVuZXNjYXBlSHRtbENoYXIpOwogICAgfQoKICAgIC8qKgogICAgICogR2VuZXJhdGVzIGEgdW5pcXVlIElELiBJZiBgcHJlZml4YCBpcyBwcm92aWRlZCB0aGUgSUQgd2lsbCBiZSBhcHBlbmRlZCB0byBpdC4KICAgICAqCiAgICAgKiBAc3RhdGljCiAgICAgKiBAbWVtYmVyT2YgXwogICAgICogQGNhdGVnb3J5IFV0aWxpdGllcwogICAgICogQHBhcmFtIHtzdHJpbmd9IFtwcmVmaXhdIFRoZSB2YWx1ZSB0byBwcmVmaXggdGhlIElEIHdpdGguCiAgICAgKiBAcmV0dXJucyB7c3RyaW5nfSBSZXR1cm5zIHRoZSB1bmlxdWUgSUQuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8udW5pcXVlSWQoJ2NvbnRhY3RfJyk7CiAgICAgKiAvLyA9PiAnY29udGFjdF8xMDQnCiAgICAgKgogICAgICogXy51bmlxdWVJZCgpOwogICAgICogLy8gPT4gJzEwNScKICAgICAqLwogICAgZnVuY3Rpb24gdW5pcXVlSWQocHJlZml4KSB7CiAgICAgIHZhciBpZCA9ICsraWRDb3VudGVyOwogICAgICByZXR1cm4gU3RyaW5nKHByZWZpeCA9PSBudWxsID8gJycgOiBwcmVmaXgpICsgaWQ7CiAgICB9CgogICAgLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgYGxvZGFzaGAgb2JqZWN0IHRoYXQgd3JhcHMgdGhlIGdpdmVuIHZhbHVlIHdpdGggZXhwbGljaXQKICAgICAqIG1ldGhvZCBjaGFpbmluZyBlbmFibGVkLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAuCiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogdmFyIHN0b29nZXMgPSBbCiAgICAgKiAgIHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0sCiAgICAgKiAgIHsgJ25hbWUnOiAnbGFycnknLCAnYWdlJzogNTAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdjdXJseScsICdhZ2UnOiA2MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIHZhciB5b3VuZ2VzdCA9IF8uY2hhaW4oc3Rvb2dlcykKICAgICAqICAgICAuc29ydEJ5KCdhZ2UnKQogICAgICogICAgIC5tYXAoZnVuY3Rpb24oc3Rvb2dlKSB7IHJldHVybiBzdG9vZ2UubmFtZSArICcgaXMgJyArIHN0b29nZS5hZ2U7IH0pCiAgICAgKiAgICAgLmZpcnN0KCkKICAgICAqICAgICAudmFsdWUoKTsKICAgICAqIC8vID0+ICdtb2UgaXMgNDAnCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNoYWluKHZhbHVlKSB7CiAgICAgIHZhbHVlID0gbmV3IGxvZGFzaFdyYXBwZXIodmFsdWUpOwogICAgICB2YWx1ZS5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBJbnZva2VzIGBpbnRlcmNlcHRvcmAgd2l0aCB0aGUgYHZhbHVlYCBhcyB0aGUgZmlyc3QgYXJndW1lbnQgYW5kIHRoZW4KICAgICAqIHJldHVybnMgYHZhbHVlYC4gVGhlIHB1cnBvc2Ugb2YgdGhpcyBtZXRob2QgaXMgdG8gInRhcCBpbnRvIiBhIG1ldGhvZAogICAgICogY2hhaW4gaW4gb3JkZXIgdG8gcGVyZm9ybSBvcGVyYXRpb25zIG9uIGludGVybWVkaWF0ZSByZXN1bHRzIHdpdGhpbgogICAgICogdGhlIGNoYWluLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAY2F0ZWdvcnkgQ2hhaW5pbmcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgVGhlIHZhbHVlIHRvIHByb3ZpZGUgdG8gYGludGVyY2VwdG9yYC4KICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGludGVyY2VwdG9yIFRoZSBmdW5jdGlvbiB0byBpbnZva2UuCiAgICAgKiBAcmV0dXJucyB7Kn0gUmV0dXJucyBgdmFsdWVgLgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiBfKFsxLCAyLCAzLCA0XSkKICAgICAqICAuZmlsdGVyKGZ1bmN0aW9uKG51bSkgeyByZXR1cm4gbnVtICUgMiA9PSAwOyB9KQogICAgICogIC50YXAoZnVuY3Rpb24oYXJyYXkpIHsgY29uc29sZS5sb2coYXJyYXkpOyB9KQogICAgICogIC5tYXAoZnVuY3Rpb24obnVtKSB7IHJldHVybiBudW0gKiBudW07IH0pCiAgICAgKiAgLnZhbHVlKCk7CiAgICAgKiAvLyA9PiAvLyBbMiwgNF0gKGxvZ2dlZCkKICAgICAqIC8vID0+IFs0LCAxNl0KICAgICAqLwogICAgZnVuY3Rpb24gdGFwKHZhbHVlLCBpbnRlcmNlcHRvcikgewogICAgICBpbnRlcmNlcHRvcih2YWx1ZSk7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIEVuYWJsZXMgZXhwbGljaXQgbWV0aG9kIGNoYWluaW5nIG9uIHRoZSB3cmFwcGVyIG9iamVjdC4KICAgICAqCiAgICAgKiBAbmFtZSBjaGFpbgogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZXIgb2JqZWN0LgogICAgICogQGV4YW1wbGUKICAgICAqCiAgICAgKiB2YXIgc3Rvb2dlcyA9IFsKICAgICAqICAgeyAnbmFtZSc6ICdtb2UnLCAnYWdlJzogNDAgfSwKICAgICAqICAgeyAnbmFtZSc6ICdsYXJyeScsICdhZ2UnOiA1MCB9CiAgICAgKiBdOwogICAgICoKICAgICAqIC8vIHdpdGhvdXQgZXhwbGljaXQgY2hhaW5pbmcKICAgICAqIF8oc3Rvb2dlcykuZmlyc3QoKTsKICAgICAqIC8vID0+IHsgJ25hbWUnOiAnbW9lJywgJ2FnZSc6IDQwIH0KICAgICAqCiAgICAgKiAvLyB3aXRoIGV4cGxpY2l0IGNoYWluaW5nCiAgICAgKiBfKHN0b29nZXMpLmNoYWluKCkKICAgICAqICAgLmZpcnN0KCkKICAgICAqICAgLnBpY2soJ2FnZScpCiAgICAgKiAgIC52YWx1ZSgpCiAgICAgKiAvLyA9PiB7ICdhZ2UnOiA0MCB9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJDaGFpbigpIHsKICAgICAgdGhpcy5fX2NoYWluX18gPSB0cnVlOwogICAgICByZXR1cm4gdGhpczsKICAgIH0KCiAgICAvKioKICAgICAqIFByb2R1Y2VzIHRoZSBgdG9TdHJpbmdgIHJlc3VsdCBvZiB0aGUgd3JhcHBlZCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbmFtZSB0b1N0cmluZwogICAgICogQG1lbWJlck9mIF8KICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMge3N0cmluZ30gUmV0dXJucyB0aGUgc3RyaW5nIHJlc3VsdC4KICAgICAqIEBleGFtcGxlCiAgICAgKgogICAgICogXyhbMSwgMiwgM10pLnRvU3RyaW5nKCk7CiAgICAgKiAvLyA9PiAnMSwyLDMnCiAgICAgKi8KICAgIGZ1bmN0aW9uIHdyYXBwZXJUb1N0cmluZygpIHsKICAgICAgcmV0dXJuIFN0cmluZyh0aGlzLl9fd3JhcHBlZF9fKTsKICAgIH0KCiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSB3cmFwcGVkIHZhbHVlLgogICAgICoKICAgICAqIEBuYW1lIHZhbHVlT2YKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAYWxpYXMgdmFsdWUKICAgICAqIEBjYXRlZ29yeSBDaGFpbmluZwogICAgICogQHJldHVybnMgeyp9IFJldHVybnMgdGhlIHdyYXBwZWQgdmFsdWUuCiAgICAgKiBAZXhhbXBsZQogICAgICoKICAgICAqIF8oWzEsIDIsIDNdKS52YWx1ZU9mKCk7CiAgICAgKiAvLyA9PiBbMSwgMiwgM10KICAgICAqLwogICAgZnVuY3Rpb24gd3JhcHBlclZhbHVlT2YoKSB7CiAgICAgIHJldHVybiB0aGlzLl9fd3JhcHBlZF9fOwogICAgfQoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8vIGFkZCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gd3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmFmdGVyID0gYWZ0ZXI7CiAgICBsb2Rhc2guYXNzaWduID0gYXNzaWduOwogICAgbG9kYXNoLmF0ID0gYXQ7CiAgICBsb2Rhc2guYmluZCA9IGJpbmQ7CiAgICBsb2Rhc2guYmluZEFsbCA9IGJpbmRBbGw7CiAgICBsb2Rhc2guYmluZEtleSA9IGJpbmRLZXk7CiAgICBsb2Rhc2guY2hhaW4gPSBjaGFpbjsKICAgIGxvZGFzaC5jb21wYWN0ID0gY29tcGFjdDsKICAgIGxvZGFzaC5jb21wb3NlID0gY29tcG9zZTsKICAgIGxvZGFzaC5jb3VudEJ5ID0gY291bnRCeTsKICAgIGxvZGFzaC5jcmVhdGVDYWxsYmFjayA9IGNyZWF0ZUNhbGxiYWNrOwogICAgbG9kYXNoLmN1cnJ5ID0gY3Vycnk7CiAgICBsb2Rhc2guZGVib3VuY2UgPSBkZWJvdW5jZTsKICAgIGxvZGFzaC5kZWZhdWx0cyA9IGRlZmF1bHRzOwogICAgbG9kYXNoLmRlZmVyID0gZGVmZXI7CiAgICBsb2Rhc2guZGVsYXkgPSBkZWxheTsKICAgIGxvZGFzaC5kaWZmZXJlbmNlID0gZGlmZmVyZW5jZTsKICAgIGxvZGFzaC5maWx0ZXIgPSBmaWx0ZXI7CiAgICBsb2Rhc2guZmxhdHRlbiA9IGZsYXR0ZW47CiAgICBsb2Rhc2guZm9yRWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZm9yRWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmZvckluID0gZm9ySW47CiAgICBsb2Rhc2guZm9ySW5SaWdodCA9IGZvckluUmlnaHQ7CiAgICBsb2Rhc2guZm9yT3duID0gZm9yT3duOwogICAgbG9kYXNoLmZvck93blJpZ2h0ID0gZm9yT3duUmlnaHQ7CiAgICBsb2Rhc2guZnVuY3Rpb25zID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLmdyb3VwQnkgPSBncm91cEJ5OwogICAgbG9kYXNoLmluZGV4QnkgPSBpbmRleEJ5OwogICAgbG9kYXNoLmluaXRpYWwgPSBpbml0aWFsOwogICAgbG9kYXNoLmludGVyc2VjdGlvbiA9IGludGVyc2VjdGlvbjsKICAgIGxvZGFzaC5pbnZlcnQgPSBpbnZlcnQ7CiAgICBsb2Rhc2guaW52b2tlID0gaW52b2tlOwogICAgbG9kYXNoLmtleXMgPSBrZXlzOwogICAgbG9kYXNoLm1hcCA9IG1hcDsKICAgIGxvZGFzaC5tYXggPSBtYXg7CiAgICBsb2Rhc2gubWVtb2l6ZSA9IG1lbW9pemU7CiAgICBsb2Rhc2gubWVyZ2UgPSBtZXJnZTsKICAgIGxvZGFzaC5taW4gPSBtaW47CiAgICBsb2Rhc2gub21pdCA9IG9taXQ7CiAgICBsb2Rhc2gub25jZSA9IG9uY2U7CiAgICBsb2Rhc2gucGFpcnMgPSBwYWlyczsKICAgIGxvZGFzaC5wYXJ0aWFsID0gcGFydGlhbDsKICAgIGxvZGFzaC5wYXJ0aWFsUmlnaHQgPSBwYXJ0aWFsUmlnaHQ7CiAgICBsb2Rhc2gucGljayA9IHBpY2s7CiAgICBsb2Rhc2gucGx1Y2sgPSBwbHVjazsKICAgIGxvZGFzaC5wdWxsID0gcHVsbDsKICAgIGxvZGFzaC5yYW5nZSA9IHJhbmdlOwogICAgbG9kYXNoLnJlamVjdCA9IHJlamVjdDsKICAgIGxvZGFzaC5yZW1vdmUgPSByZW1vdmU7CiAgICBsb2Rhc2gucmVzdCA9IHJlc3Q7CiAgICBsb2Rhc2guc2h1ZmZsZSA9IHNodWZmbGU7CiAgICBsb2Rhc2guc29ydEJ5ID0gc29ydEJ5OwogICAgbG9kYXNoLnRhcCA9IHRhcDsKICAgIGxvZGFzaC50aHJvdHRsZSA9IHRocm90dGxlOwogICAgbG9kYXNoLnRpbWVzID0gdGltZXM7CiAgICBsb2Rhc2gudG9BcnJheSA9IHRvQXJyYXk7CiAgICBsb2Rhc2gudHJhbnNmb3JtID0gdHJhbnNmb3JtOwogICAgbG9kYXNoLnVuaW9uID0gdW5pb247CiAgICBsb2Rhc2gudW5pcSA9IHVuaXE7CiAgICBsb2Rhc2gudmFsdWVzID0gdmFsdWVzOwogICAgbG9kYXNoLndoZXJlID0gd2hlcmU7CiAgICBsb2Rhc2gud2l0aG91dCA9IHdpdGhvdXQ7CiAgICBsb2Rhc2gud3JhcCA9IHdyYXA7CiAgICBsb2Rhc2guemlwID0gemlwOwogICAgbG9kYXNoLnppcE9iamVjdCA9IHppcE9iamVjdDsKCiAgICAvLyBhZGQgYWxpYXNlcwogICAgbG9kYXNoLmNvbGxlY3QgPSBtYXA7CiAgICBsb2Rhc2guZHJvcCA9IHJlc3Q7CiAgICBsb2Rhc2guZWFjaCA9IGZvckVhY2g7CiAgICBsb2Rhc2guZWFjaFJpZ2h0ID0gZm9yRWFjaFJpZ2h0OwogICAgbG9kYXNoLmV4dGVuZCA9IGFzc2lnbjsKICAgIGxvZGFzaC5tZXRob2RzID0gZnVuY3Rpb25zOwogICAgbG9kYXNoLm9iamVjdCA9IHppcE9iamVjdDsKICAgIGxvZGFzaC5zZWxlY3QgPSBmaWx0ZXI7CiAgICBsb2Rhc2gudGFpbCA9IHJlc3Q7CiAgICBsb2Rhc2gudW5pcXVlID0gdW5pcTsKICAgIGxvZGFzaC51bnppcCA9IHppcDsKCiAgICAvLyBhZGQgZnVuY3Rpb25zIHRvIGBsb2Rhc2gucHJvdG90eXBlYAogICAgbWl4aW4obG9kYXNoKTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvLyBhZGQgZnVuY3Rpb25zIHRoYXQgcmV0dXJuIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmNsb25lID0gY2xvbmU7CiAgICBsb2Rhc2guY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogICAgbG9kYXNoLmNvbnRhaW5zID0gY29udGFpbnM7CiAgICBsb2Rhc2guZXNjYXBlID0gZXNjYXBlOwogICAgbG9kYXNoLmV2ZXJ5ID0gZXZlcnk7CiAgICBsb2Rhc2guZmluZCA9IGZpbmQ7CiAgICBsb2Rhc2guZmluZEluZGV4ID0gZmluZEluZGV4OwogICAgbG9kYXNoLmZpbmRLZXkgPSBmaW5kS2V5OwogICAgbG9kYXNoLmZpbmRMYXN0ID0gZmluZExhc3Q7CiAgICBsb2Rhc2guZmluZExhc3RJbmRleCA9IGZpbmRMYXN0SW5kZXg7CiAgICBsb2Rhc2guZmluZExhc3RLZXkgPSBmaW5kTGFzdEtleTsKICAgIGxvZGFzaC5oYXMgPSBoYXM7CiAgICBsb2Rhc2guaWRlbnRpdHkgPSBpZGVudGl0eTsKICAgIGxvZGFzaC5pbmRleE9mID0gaW5kZXhPZjsKICAgIGxvZGFzaC5pc0FyZ3VtZW50cyA9IGlzQXJndW1lbnRzOwogICAgbG9kYXNoLmlzQXJyYXkgPSBpc0FycmF5OwogICAgbG9kYXNoLmlzQm9vbGVhbiA9IGlzQm9vbGVhbjsKICAgIGxvZGFzaC5pc0RhdGUgPSBpc0RhdGU7CiAgICBsb2Rhc2guaXNFbGVtZW50ID0gaXNFbGVtZW50OwogICAgbG9kYXNoLmlzRW1wdHkgPSBpc0VtcHR5OwogICAgbG9kYXNoLmlzRXF1YWwgPSBpc0VxdWFsOwogICAgbG9kYXNoLmlzRmluaXRlID0gaXNGaW5pdGU7CiAgICBsb2Rhc2guaXNGdW5jdGlvbiA9IGlzRnVuY3Rpb247CiAgICBsb2Rhc2guaXNOYU4gPSBpc05hTjsKICAgIGxvZGFzaC5pc051bGwgPSBpc051bGw7CiAgICBsb2Rhc2guaXNOdW1iZXIgPSBpc051bWJlcjsKICAgIGxvZGFzaC5pc09iamVjdCA9IGlzT2JqZWN0OwogICAgbG9kYXNoLmlzUGxhaW5PYmplY3QgPSBpc1BsYWluT2JqZWN0OwogICAgbG9kYXNoLmlzUmVnRXhwID0gaXNSZWdFeHA7CiAgICBsb2Rhc2guaXNTdHJpbmcgPSBpc1N0cmluZzsKICAgIGxvZGFzaC5pc1VuZGVmaW5lZCA9IGlzVW5kZWZpbmVkOwogICAgbG9kYXNoLmxhc3RJbmRleE9mID0gbGFzdEluZGV4T2Y7CiAgICBsb2Rhc2gubWl4aW4gPSBtaXhpbjsKICAgIGxvZGFzaC5ub0NvbmZsaWN0ID0gbm9Db25mbGljdDsKICAgIGxvZGFzaC5wYXJzZUludCA9IHBhcnNlSW50OwogICAgbG9kYXNoLnJhbmRvbSA9IHJhbmRvbTsKICAgIGxvZGFzaC5yZWR1Y2UgPSByZWR1Y2U7CiAgICBsb2Rhc2gucmVkdWNlUmlnaHQgPSByZWR1Y2VSaWdodDsKICAgIGxvZGFzaC5yZXN1bHQgPSByZXN1bHQ7CiAgICBsb2Rhc2gucnVuSW5Db250ZXh0ID0gcnVuSW5Db250ZXh0OwogICAgbG9kYXNoLnNpemUgPSBzaXplOwogICAgbG9kYXNoLnNvbWUgPSBzb21lOwogICAgbG9kYXNoLnNvcnRlZEluZGV4ID0gc29ydGVkSW5kZXg7CiAgICBsb2Rhc2gudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgIGxvZGFzaC51bmVzY2FwZSA9IHVuZXNjYXBlOwogICAgbG9kYXNoLnVuaXF1ZUlkID0gdW5pcXVlSWQ7CgogICAgLy8gYWRkIGFsaWFzZXMKICAgIGxvZGFzaC5hbGwgPSBldmVyeTsKICAgIGxvZGFzaC5hbnkgPSBzb21lOwogICAgbG9kYXNoLmRldGVjdCA9IGZpbmQ7CiAgICBsb2Rhc2guZmluZFdoZXJlID0gZmluZDsKICAgIGxvZGFzaC5mb2xkbCA9IHJlZHVjZTsKICAgIGxvZGFzaC5mb2xkciA9IHJlZHVjZVJpZ2h0OwogICAgbG9kYXNoLmluY2x1ZGUgPSBjb250YWluczsKICAgIGxvZGFzaC5pbmplY3QgPSByZWR1Y2U7CgogICAgZm9yT3duKGxvZGFzaCwgZnVuY3Rpb24oZnVuYywgbWV0aG9kTmFtZSkgewogICAgICBpZiAoIWxvZGFzaC5wcm90b3R5cGVbbWV0aG9kTmFtZV0pIHsKICAgICAgICBsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgYXJncyA9IFt0aGlzLl9fd3JhcHBlZF9fXSwKICAgICAgICAgICAgICBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fOwoKICAgICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KGxvZGFzaCwgYXJncyk7CiAgICAgICAgICByZXR1cm4gY2hhaW5BbGwKICAgICAgICAgICAgPyBuZXcgbG9kYXNoV3JhcHBlcihyZXN1bHQsIGNoYWluQWxsKQogICAgICAgICAgICA6IHJlc3VsdDsKICAgICAgICB9OwogICAgICB9CiAgICB9KTsKCiAgICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgICAvLyBhZGQgZnVuY3Rpb25zIGNhcGFibGUgb2YgcmV0dXJuaW5nIHdyYXBwZWQgYW5kIHVud3JhcHBlZCB2YWx1ZXMgd2hlbiBjaGFpbmluZwogICAgbG9kYXNoLmZpcnN0ID0gZmlyc3Q7CiAgICBsb2Rhc2gubGFzdCA9IGxhc3Q7CiAgICBsb2Rhc2guc2FtcGxlID0gc2FtcGxlOwoKICAgIC8vIGFkZCBhbGlhc2VzCiAgICBsb2Rhc2gudGFrZSA9IGZpcnN0OwogICAgbG9kYXNoLmhlYWQgPSBmaXJzdDsKCiAgICBmb3JPd24obG9kYXNoLCBmdW5jdGlvbihmdW5jLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjYWxsYmFja2FibGUgPSBtZXRob2ROYW1lICE9PSAnc2FtcGxlJzsKICAgICAgaWYgKCFsb2Rhc2gucHJvdG90eXBlW21ldGhvZE5hbWVdKSB7CiAgICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXT0gZnVuY3Rpb24obiwgZ3VhcmQpIHsKICAgICAgICAgIHZhciBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fLAogICAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmModGhpcy5fX3dyYXBwZWRfXywgbiwgZ3VhcmQpOwoKICAgICAgICAgIHJldHVybiAhY2hhaW5BbGwgJiYgKG4gPT0gbnVsbCB8fCAoZ3VhcmQgJiYgIShjYWxsYmFja2FibGUgJiYgdHlwZW9mIG4gPT0gJ2Z1bmN0aW9uJykpKQogICAgICAgICAgICA/IHJlc3VsdAogICAgICAgICAgICA6IG5ldyBsb2Rhc2hXcmFwcGVyKHJlc3VsdCwgY2hhaW5BbGwpOwogICAgICAgIH07CiAgICAgIH0KICAgIH0pOwoKICAgIC8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qLwoKICAgIC8qKgogICAgICogVGhlIHNlbWFudGljIHZlcnNpb24gbnVtYmVyLgogICAgICoKICAgICAqIEBzdGF0aWMKICAgICAqIEBtZW1iZXJPZiBfCiAgICAgKiBAdHlwZSBzdHJpbmcKICAgICAqLwogICAgbG9kYXNoLlZFUlNJT04gPSAnMi4yLjEnOwoKICAgIC8vIGFkZCAiQ2hhaW5pbmciIGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlcgogICAgbG9kYXNoLnByb3RvdHlwZS5jaGFpbiA9IHdyYXBwZXJDaGFpbjsKICAgIGxvZGFzaC5wcm90b3R5cGUudG9TdHJpbmcgPSB3cmFwcGVyVG9TdHJpbmc7CiAgICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlID0gd3JhcHBlclZhbHVlT2Y7CiAgICBsb2Rhc2gucHJvdG90eXBlLnZhbHVlT2YgPSB3cmFwcGVyVmFsdWVPZjsKCiAgICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdW53cmFwcGVkIHZhbHVlcwogICAgZm9yRWFjaChbJ2pvaW4nLCAncG9wJywgJ3NoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBjaGFpbkFsbCA9IHRoaXMuX19jaGFpbl9fLAogICAgICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyk7CgogICAgICAgIHJldHVybiBjaGFpbkFsbAogICAgICAgICAgPyBuZXcgbG9kYXNoV3JhcHBlcihyZXN1bHQsIGNoYWluQWxsKQogICAgICAgICAgOiByZXN1bHQ7CiAgICAgIH07CiAgICB9KTsKCiAgICAvLyBhZGQgYEFycmF5YCBmdW5jdGlvbnMgdGhhdCByZXR1cm4gdGhlIHdyYXBwZWQgdmFsdWUKICAgIGZvckVhY2goWydwdXNoJywgJ3JldmVyc2UnLCAnc29ydCcsICd1bnNoaWZ0J10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmMuYXBwbHkodGhpcy5fX3dyYXBwZWRfXywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfTsKICAgIH0pOwoKICAgIC8vIGFkZCBgQXJyYXlgIGZ1bmN0aW9ucyB0aGF0IHJldHVybiBuZXcgd3JhcHBlZCB2YWx1ZXMKICAgIGZvckVhY2goWydjb25jYXQnLCAnc2xpY2UnLCAnc3BsaWNlJ10sIGZ1bmN0aW9uKG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIGZ1bmMgPSBhcnJheVJlZlttZXRob2ROYW1lXTsKICAgICAgbG9kYXNoLnByb3RvdHlwZVttZXRob2ROYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgbG9kYXNoV3JhcHBlcihmdW5jLmFwcGx5KHRoaXMuX193cmFwcGVkX18sIGFyZ3VtZW50cyksIHRoaXMuX19jaGFpbl9fKTsKICAgICAgfTsKICAgIH0pOwoKICAgIHJldHVybiBsb2Rhc2g7CiAgfQoKICAvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi8KCiAgLy8gZXhwb3NlIExvLURhc2gKICB2YXIgXyA9IHJ1bkluQ29udGV4dCgpOwoKICAvLyBzb21lIEFNRCBidWlsZCBvcHRpbWl6ZXJzLCBsaWtlIHIuanMsIGNoZWNrIGZvciBjb25kaXRpb24gcGF0dGVybnMgbGlrZSB0aGUgZm9sbG93aW5nOgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgdHlwZW9mIGRlZmluZS5hbWQgPT0gJ29iamVjdCcgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gRXhwb3NlIExvLURhc2ggdG8gdGhlIGdsb2JhbCBvYmplY3QgZXZlbiB3aGVuIGFuIEFNRCBsb2FkZXIgaXMgcHJlc2VudCBpbgogICAgLy8gY2FzZSBMby1EYXNoIHdhcyBpbmplY3RlZCBieSBhIHRoaXJkLXBhcnR5IHNjcmlwdCBhbmQgbm90IGludGVuZGVkIHRvIGJlCiAgICAvLyBsb2FkZWQgYXMgYSBtb2R1bGUuIFRoZSBnbG9iYWwgYXNzaWdubWVudCBjYW4gYmUgcmV2ZXJ0ZWQgaW4gdGhlIExvLURhc2gKICAgIC8vIG1vZHVsZSBieSBpdHMgYG5vQ29uZmxpY3QoKWAgbWV0aG9kLgogICAgcm9vdC5fID0gXzsKCiAgICAvLyBkZWZpbmUgYXMgYW4gYW5vbnltb3VzIG1vZHVsZSBzbywgdGhyb3VnaCBwYXRoIG1hcHBpbmcsIGl0IGNhbiBiZQogICAgLy8gcmVmZXJlbmNlZCBhcyB0aGUgInVuZGVyc2NvcmUiIG1vZHVsZQogICAgZGVmaW5lKGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXzsKICAgIH0pOwogIH0KICAvLyBjaGVjayBmb3IgYGV4cG9ydHNgIGFmdGVyIGBkZWZpbmVgIGluIGNhc2UgYSBidWlsZCBvcHRpbWl6ZXIgYWRkcyBhbiBgZXhwb3J0c2Agb2JqZWN0CiAgZWxzZSBpZiAoZnJlZUV4cG9ydHMgJiYgZnJlZU1vZHVsZSkgewogICAgLy8gaW4gTm9kZS5qcyBvciBSaW5nb0pTCiAgICBpZiAobW9kdWxlRXhwb3J0cykgewogICAgICAoZnJlZU1vZHVsZS5leHBvcnRzID0gXykuXyA9IF87CiAgICB9CiAgICAvLyBpbiBOYXJ3aGFsIG9yIFJoaW5vIC1yZXF1aXJlCiAgICBlbHNlIHsKICAgICAgZnJlZUV4cG9ydHMuXyA9IF87CiAgICB9CiAgfQogIGVsc2UgewogICAgLy8gaW4gYSBicm93c2VyIG9yIFJoaW5vCiAgICByb290Ll8gPSBfOwogIH0KfS5jYWxsKHRoaXMpKTsKCi8vICAgICBCYWNrYm9uZS5qcyAxLjEuMgoKLy8gICAgIChjKSAyMDEwLTIwMTQgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIGFuZCBJbnZlc3RpZ2F0aXZlIFJlcG9ydGVycyAmIEVkaXRvcnMKLy8gICAgIEJhY2tib25lIG1heSBiZSBmcmVlbHkgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOgovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnCgooZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewoKICAvLyBTZXQgdXAgQmFja2JvbmUgYXBwcm9wcmlhdGVseSBmb3IgdGhlIGVudmlyb25tZW50LiBTdGFydCB3aXRoIEFNRC4KICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoWyd1bmRlcnNjb3JlJywgJ2pxdWVyeScsICdleHBvcnRzJ10sIGZ1bmN0aW9uKF8sICQsIGV4cG9ydHMpIHsKICAgICAgLy8gRXhwb3J0IGdsb2JhbCBldmVuIGluIEFNRCBjYXNlIGluIGNhc2UgdGhpcyBzY3JpcHQgaXMgbG9hZGVkIHdpdGgKICAgICAgLy8gb3RoZXJzIHRoYXQgbWF5IHN0aWxsIGV4cGVjdCBhIGdsb2JhbCBCYWNrYm9uZS4KICAgICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXywgJCk7CiAgICB9KTsKCiAgLy8gTmV4dCBmb3IgTm9kZS5qcyBvciBDb21tb25KUy4galF1ZXJ5IG1heSBub3QgYmUgbmVlZGVkIGFzIGEgbW9kdWxlLgogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKICAgIGZhY3Rvcnkocm9vdCwgZXhwb3J0cywgXyk7CgogIC8vIEZpbmFsbHksIGFzIGEgYnJvd3NlciBnbG9iYWwuCiAgfSBlbHNlIHsKICAgIHJvb3QuQmFja2JvbmUgPSBmYWN0b3J5KHJvb3QsIHt9LCByb290Ll8sIChyb290LmpRdWVyeSB8fCByb290LlplcHRvIHx8IHJvb3QuZW5kZXIgfHwgcm9vdC4kKSk7CiAgfQoKfSh0aGlzLCBmdW5jdGlvbihyb290LCBCYWNrYm9uZSwgXywgJCkgewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgbG9jYWwgcmVmZXJlbmNlcyB0byBhcnJheSBtZXRob2RzIHdlJ2xsIHdhbnQgdG8gdXNlIGxhdGVyLgogIHZhciBhcnJheSA9IFtdOwogIHZhciBwdXNoID0gYXJyYXkucHVzaDsKICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsKICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOwoKICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLgogIEJhY2tib25lLlZFUlNJT04gPSAnMS4xLjInOwoKICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgRW5kZXIsIG9yIE15IExpYnJhcnkgKGtpZGRpbmcpIG93bnMKICAvLyB0aGUgYCRgIHZhcmlhYmxlLgogIEJhY2tib25lLiQgPSAkOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUEFUQ0giYCwgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICBCYWNrYm9uZS5lbXVsYXRlSFRUUCA9IGZhbHNlOwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QKICAvLyBgYXBwbGljYXRpb24vanNvbmAgcmVxdWVzdHMgLi4uIHdpbGwgZW5jb2RlIHRoZSBib2R5IGFzCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIEJhY2tib25lLmVtdWxhdGVKU09OID0gZmFsc2U7CgogIC8vIEJhY2tib25lLkV2ZW50cwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoCiAgLy8gY3VzdG9tIGV2ZW50cy4gWW91IG1heSBiaW5kIHdpdGggYG9uYCBvciByZW1vdmUgd2l0aCBgb2ZmYCBjYWxsYmFjawogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluCiAgLy8gc3VjY2Vzc2lvbi4KICAvLwogIC8vICAgICB2YXIgb2JqZWN0ID0ge307CiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsKICAvLyAgICAgb2JqZWN0Lm9uKCdleHBhbmQnLCBmdW5jdGlvbigpeyBhbGVydCgnZXhwYW5kZWQnKTsgfSk7CiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsKICAvLwogIHZhciBFdmVudHMgPSBCYWNrYm9uZS5FdmVudHMgPSB7CgogICAgLy8gQmluZCBhbiBldmVudCB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQKICAgIC8vIHRoZSBjYWxsYmFjayB0byBhbGwgZXZlbnRzIGZpcmVkLgogICAgb246IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7CiAgICAgIGV2ZW50cy5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSB8fCAhY2FsbGJhY2spIHJldHVybiB0aGlzOwogICAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICAgIHZhciBvbmNlID0gXy5vbmNlKGZ1bmN0aW9uKCkgewogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOwogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0pOwogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgIH0sCgogICAgLy8gUmVtb3ZlIG9uZSBvciBtYW55IGNhbGxiYWNrcy4gSWYgYGNvbnRleHRgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYG5hbWVgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciByZXRhaW4sIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOwogICAgICBpZiAoIXRoaXMuX2V2ZW50cyB8fCAhZXZlbnRzQXBpKHRoaXMsICdvZmYnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSB2b2lkIDA7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgbmFtZXMgPSBuYW1lID8gW25hbWVdIDogXy5rZXlzKHRoaXMuX2V2ZW50cyk7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBuYW1lID0gbmFtZXNbaV07CiAgICAgICAgaWYgKGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgewogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gcmV0YWluID0gW107CiAgICAgICAgICBpZiAoY2FsbGJhY2sgfHwgY29udGV4dCkgewogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gZXZlbnRzLmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gZXZlbnRzW2pdOwogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSBldi5jYWxsYmFjay5fY2FsbGJhY2spIHx8CiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICByZXRhaW4ucHVzaChldik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJldGFpbi5sZW5ndGgpIGRlbGV0ZSB0aGlzLl9ldmVudHNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQogICAgLy8gKHVubGVzcyB5b3UncmUgbGlzdGVuaW5nIG9uIGAiYWxsImAsIHdoaWNoIHdpbGwgY2F1c2UgeW91ciBjYWxsYmFjayB0bwogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLgogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZiAoIXRoaXMuX2V2ZW50cykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGV2ZW50cyA9IHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7CiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHMoZXZlbnRzLCBhcmdzKTsKICAgICAgaWYgKGFsbEV2ZW50cykgdHJpZ2dlckV2ZW50cyhhbGxFdmVudHMsIGFyZ3VtZW50cyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLgogICAgc3RvcExpc3RlbmluZzogZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbzsKICAgICAgaWYgKCFsaXN0ZW5pbmdUbykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciByZW1vdmUgPSAhbmFtZSAmJiAhY2FsbGJhY2s7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIGlmIChvYmopIChsaXN0ZW5pbmdUbyA9IHt9KVtvYmouX2xpc3RlbklkXSA9IG9iajsKICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuaW5nVG8pIHsKICAgICAgICBvYmogPSBsaXN0ZW5pbmdUb1tpZF07CiAgICAgICAgb2JqLm9mZihuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgICAgaWYgKHJlbW92ZSB8fCBfLmlzRW1wdHkob2JqLl9ldmVudHMpKSBkZWxldGUgdGhpcy5fbGlzdGVuaW5nVG9baWRdOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICB9OwoKICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLgogIHZhciBldmVudFNwbGl0dGVyID0gL1xzKy87CgogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50CiAgLy8gbmFtZXMgYCJjaGFuZ2UgYmx1ciJgIGFuZCBqUXVlcnktc3R5bGUgZXZlbnQgbWFwcyBge2NoYW5nZTogYWN0aW9ufWAKICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLgogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgewogICAgaWYgKCFuYW1lKSByZXR1cm4gdHJ1ZTsKCiAgICAvLyBIYW5kbGUgZXZlbnQgbWFwcy4KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsKICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtrZXksIG5hbWVba2V5XV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gSGFuZGxlIHNwYWNlIHNlcGFyYXRlZCBldmVudCBuYW1lcy4KICAgIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsKICAgICAgdmFyIG5hbWVzID0gbmFtZS5zcGxpdChldmVudFNwbGl0dGVyKTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gQSBkaWZmaWN1bHQtdG8tYmVsaWV2ZSwgYnV0IG9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IKICAvLyB0cmlnZ2VyaW5nIGV2ZW50cy4gVHJpZXMgdG8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IGludGVybmFsCiAgLy8gQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLgogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24oZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGgsIGExID0gYXJnc1swXSwgYTIgPSBhcmdzWzFdLCBhMyA9IGFyZ3NbMl07CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOyByZXR1cm47CiAgICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExKTsgcmV0dXJuOwogICAgICBjYXNlIDI6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhMSwgYTIpOyByZXR1cm47CiAgICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMiwgYTMpOyByZXR1cm47CiAgICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7IHJldHVybjsKICAgIH0KICB9OwoKICB2YXIgbGlzdGVuTWV0aG9kcyA9IHtsaXN0ZW5UbzogJ29uJywgbGlzdGVuVG9PbmNlOiAnb25jZSd9OwoKICAvLyBJbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9ucyBvZiBgb25gIGFuZCBgb25jZWAuIFRlbGwgKnRoaXMqIG9iamVjdCB0bwogIC8vIGxpc3RlbiB0byBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MKICAvLyBsaXN0ZW5pbmcgdG8uCiAgXy5lYWNoKGxpc3Rlbk1ldGhvZHMsIGZ1bmN0aW9uKGltcGxlbWVudGF0aW9uLCBtZXRob2QpIHsKICAgIEV2ZW50c1ttZXRob2RdID0gZnVuY3Rpb24ob2JqLCBuYW1lLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuaW5nVG8gPSB0aGlzLl9saXN0ZW5pbmdUbyB8fCAodGhpcy5fbGlzdGVuaW5nVG8gPSB7fSk7CiAgICAgIHZhciBpZCA9IG9iai5fbGlzdGVuSWQgfHwgKG9iai5fbGlzdGVuSWQgPSBfLnVuaXF1ZUlkKCdsJykpOwogICAgICBsaXN0ZW5pbmdUb1tpZF0gPSBvYmo7CiAgICAgIGlmICghY2FsbGJhY2sgJiYgdHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSBjYWxsYmFjayA9IHRoaXM7CiAgICAgIG9ialtpbXBsZW1lbnRhdGlvbl0obmFtZSwgY2FsbGJhY2ssIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgfSk7CgogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247CiAgRXZlbnRzLnVuYmluZCA9IEV2ZW50cy5vZmY7CgogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8KICAvLyB3YW50IGdsb2JhbCAicHVic3ViIiBpbiBhIGNvbnZlbmllbnQgcGxhY2UuCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7CgogIC8vIEJhY2tib25lLk1vZGVsCiAgLy8gLS0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgKipNb2RlbHMqKiBhcmUgdGhlIGJhc2ljIGRhdGEgb2JqZWN0IGluIHRoZSBmcmFtZXdvcmsgLS0KICAvLyBmcmVxdWVudGx5IHJlcHJlc2VudGluZyBhIHJvdyBpbiBhIHRhYmxlIGluIGEgZGF0YWJhc2Ugb24geW91ciBzZXJ2ZXIuCiAgLy8gQSBkaXNjcmV0ZSBjaHVuayBvZiBkYXRhIGFuZCBhIGJ1bmNoIG9mIHVzZWZ1bCwgcmVsYXRlZCBtZXRob2RzIGZvcgogIC8vIHBlcmZvcm1pbmcgY29tcHV0YXRpb25zIGFuZCB0cmFuc2Zvcm1hdGlvbnMgb24gdGhhdCBkYXRhLgoKICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCB0aGUgc3BlY2lmaWVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsKICAgIGlmIChvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMsIG9wdGlvbnMpIHx8IHt9OwogICAgYXR0cnMgPSBfLmRlZmF1bHRzKHt9LCBhdHRycywgXy5yZXN1bHQodGhpcywgJ2RlZmF1bHRzJykpOwogICAgdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBBdHRhY2ggYWxsIGluaGVyaXRhYmxlIG1ldGhvZHMgdG8gdGhlIE1vZGVsIHByb3RvdHlwZS4KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEEgaGFzaCBvZiBhdHRyaWJ1dGVzIHdob3NlIGN1cnJlbnQgYW5kIHByZXZpb3VzIHZhbHVlIGRpZmZlci4KICAgIGNoYW5nZWQ6IG51bGwsCgogICAgLy8gVGhlIHZhbHVlIHJldHVybmVkIGR1cmluZyB0aGUgbGFzdCBmYWlsZWQgdmFsaWRhdGlvbi4KICAgIHZhbGlkYXRpb25FcnJvcjogbnVsbCwKCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuCiAgICBpZEF0dHJpYnV0ZTogJ2lkJywKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG1vZGVsJ3MgYGF0dHJpYnV0ZXNgIG9iamVjdC4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdCAtLSBidXQgb3ZlcnJpZGUgdGhpcyBpZiB5b3UgbmVlZAogICAgLy8gY3VzdG9tIHN5bmNpbmcgc2VtYW50aWNzIGZvciAqdGhpcyogcGFydGljdWxhciBtb2RlbC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGdldDogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5hdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIEhUTUwtZXNjYXBlZCB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUuCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsKICAgIH0sCgogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwKICAgIC8vIG9yIHVuZGVmaW5lZC4KICAgIGhhczogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgLiBUaGlzIGlzCiAgICAvLyB0aGUgY29yZSBwcmltaXRpdmUgb3BlcmF0aW9uIG9mIGEgbW9kZWwsIHVwZGF0aW5nIHRoZSBkYXRhIGFuZCBub3RpZnlpbmcKICAgIC8vIGFueW9uZSB3aG8gbmVlZHMgdG8ga25vdyBhYm91dCB0aGUgY2hhbmdlIGluIHN0YXRlLiBUaGUgaGVhcnQgb2YgdGhlIGJlYXN0LgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0ciwgYXR0cnMsIHVuc2V0LCBjaGFuZ2VzLCBzaWxlbnQsIGNoYW5naW5nLCBwcmV2LCBjdXJyZW50OwogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4KICAgICAgdW5zZXQgICAgICAgICAgID0gb3B0aW9ucy51bnNldDsKICAgICAgc2lsZW50ICAgICAgICAgID0gb3B0aW9ucy5zaWxlbnQ7CiAgICAgIGNoYW5nZXMgICAgICAgICA9IFtdOwogICAgICBjaGFuZ2luZyAgICAgICAgPSB0aGlzLl9jaGFuZ2luZzsKICAgICAgdGhpcy5fY2hhbmdpbmcgID0gdHJ1ZTsKCiAgICAgIGlmICghY2hhbmdpbmcpIHsKICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgIH0KICAgICAgY3VycmVudCA9IHRoaXMuYXR0cmlidXRlcywgcHJldiA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07CgogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUsIHVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUuCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgewogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOwogICAgICAgIGlmICghXy5pc0VxdWFsKGN1cnJlbnRbYXR0cl0sIHZhbCkpIGNoYW5nZXMucHVzaChhdHRyKTsKICAgICAgICBpZiAoIV8uaXNFcXVhbChwcmV2W2F0dHJdLCB2YWwpKSB7CiAgICAgICAgICB0aGlzLmNoYW5nZWRbYXR0cl0gPSB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLmNoYW5nZWRbYXR0cl07CiAgICAgICAgfQogICAgICAgIHVuc2V0ID8gZGVsZXRlIGN1cnJlbnRbYXR0cl0gOiBjdXJyZW50W2F0dHJdID0gdmFsOwogICAgICB9CgogICAgICAvLyBUcmlnZ2VyIGFsbCByZWxldmFudCBhdHRyaWJ1dGUgY2hhbmdlcy4KICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGgpIHRoaXMuX3BlbmRpbmcgPSBvcHRpb25zOwogICAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hhbmdlcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyBjaGFuZ2VzW2ldLCB0aGlzLCBjdXJyZW50W2NoYW5nZXNbaV1dLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFlvdSBtaWdodCBiZSB3b25kZXJpbmcgd2h5IHRoZXJlJ3MgYSBgd2hpbGVgIGxvb3AgaGVyZS4gQ2hhbmdlcyBjYW4KICAgICAgLy8gYmUgcmVjdXJzaXZlbHkgbmVzdGVkIHdpdGhpbiBgImNoYW5nZSJgIGV2ZW50cy4KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFzaWxlbnQpIHsKICAgICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgICAgb3B0aW9ucyA9IHRoaXMuX3BlbmRpbmc7CiAgICAgICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9wZW5kaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4gYHVuc2V0YCBpcyBhIG5vb3AKICAgIC8vIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4KICAgIHVuc2V0OiBmdW5jdGlvbihhdHRyLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAuCiAgICBjbGVhcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgYXR0cnMgPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHJzLCBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3Vuc2V0OiB0cnVlfSkpOwogICAgfSwKCiAgICAvLyBEZXRlcm1pbmUgaWYgdGhlIG1vZGVsIGhhcyBjaGFuZ2VkIHNpbmNlIHRoZSBsYXN0IGAiY2hhbmdlImAgZXZlbnQuCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLgogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOwogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsKICAgIH0sCgogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3IKICAgIC8vIGZhbHNlIGlmIHRoZXJlIGFyZSBubyBjaGFuZ2VkIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3IgZGV0ZXJtaW5pbmcgd2hhdAogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUKICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4KICAgIC8vIFlvdSBjYW4gYWxzbyBwYXNzIGFuIGF0dHJpYnV0ZXMgb2JqZWN0IHRvIGRpZmYgYWdhaW5zdCB0aGUgbW9kZWwsCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLgogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsKICAgICAgaWYgKCFkaWZmKSByZXR1cm4gdGhpcy5oYXNDaGFuZ2VkKCkgPyBfLmNsb25lKHRoaXMuY2hhbmdlZCkgOiBmYWxzZTsKICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlOwogICAgICB2YXIgb2xkID0gdGhpcy5fY2hhbmdpbmcgPyB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgOiB0aGlzLmF0dHJpYnV0ZXM7CiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgewogICAgICAgIGlmIChfLmlzRXF1YWwob2xkW2F0dHJdLCAodmFsID0gZGlmZlthdHRyXSkpKSBjb250aW51ZTsKICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgbW9kZWwgZnJvbSB0aGUgc2VydmVyLiBJZiB0aGUgc2VydmVyJ3MgcmVwcmVzZW50YXRpb24gb2YgdGhlCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRkZW4sCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgICBpZiAoIW1vZGVsLnNldChtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKSwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuCiAgICAvLyBJZiB0aGUgc2VydmVyIHJldHVybnMgYW4gYXR0cmlidXRlcyBoYXNoIHRoYXQgZGlmZmVycywgdGhlIG1vZGVsJ3MKICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgewogICAgICB2YXIgYXR0cnMsIG1ldGhvZCwgeGhyLCBhdHRyaWJ1dGVzID0gdGhpcy5hdHRyaWJ1dGVzOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAnb2JqZWN0JykgewogICAgICAgIGF0dHJzID0ga2V5OwogICAgICAgIG9wdGlvbnMgPSB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7dmFsaWRhdGU6IHRydWV9LCBvcHRpb25zKTsKCiAgICAgIC8vIElmIHdlJ3JlIG5vdCB3YWl0aW5nIGFuZCBhdHRyaWJ1dGVzIGV4aXN0LCBzYXZlIGFjdHMgYXMKICAgICAgLy8gYHNldChhdHRyKS5zYXZlKG51bGwsIG9wdHMpYCB3aXRoIHZhbGlkYXRpb24uIE90aGVyd2lzZSwgY2hlY2sgaWYKICAgICAgLy8gdGhlIG1vZGVsIHdpbGwgYmUgdmFsaWQgd2hlbiB0aGUgYXR0cmlidXRlcywgaWYgYW55LCBhcmUgc2V0LgogICAgICBpZiAoYXR0cnMgJiYgIW9wdGlvbnMud2FpdCkgewogICAgICAgIGlmICghdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gU2V0IHRlbXBvcmFyeSBhdHRyaWJ1dGVzIGlmIGB7d2FpdDogdHJ1ZX1gLgogICAgICBpZiAoYXR0cnMgJiYgb3B0aW9ucy53YWl0KSB7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gXy5leHRlbmQoe30sIGF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgfQoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIC8vIEVuc3VyZSBhdHRyaWJ1dGVzIGFyZSByZXN0b3JlZCBkdXJpbmcgc3luY2hyb25vdXMgc2F2ZXMuCiAgICAgICAgbW9kZWwuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgc2VydmVyQXR0cnMgPSBfLmV4dGVuZChhdHRycyB8fCB7fSwgc2VydmVyQXR0cnMpOwogICAgICAgIGlmIChfLmlzT2JqZWN0KHNlcnZlckF0dHJzKSAmJiAhbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgICAgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgbWV0aG9kID0gdGhpcy5pc05ldygpID8gJ2NyZWF0ZScgOiAob3B0aW9ucy5wYXRjaCA/ICdwYXRjaCcgOiAndXBkYXRlJyk7CiAgICAgIGlmIChtZXRob2QgPT09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7CgogICAgICAvLyBSZXN0b3JlIGF0dHJpYnV0ZXMuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoIW1vZGVsLmlzTmV3KCkpIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBpZiAodGhpcy5pc05ldygpKSB7CiAgICAgICAgb3B0aW9ucy5zdWNjZXNzKCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHdyYXBFcnJvcih0aGlzLCBvcHRpb25zKTsKCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9CiAgICAgICAgXy5yZXN1bHQodGhpcywgJ3VybFJvb3QnKSB8fAogICAgICAgIF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8CiAgICAgICAgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24KICAgIC8vIHRoZSBtb2RlbC4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIHRoZSByZXNwb25zZSBhbG9uZy4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICF0aGlzLmhhcyh0aGlzLmlkQXR0cmlidXRlKTsKICAgIH0sCgogICAgLy8gQ2hlY2sgaWYgdGhlIG1vZGVsIGlzIGN1cnJlbnRseSBpbiBhIHZhbGlkIHN0YXRlLgogICAgaXNWYWxpZDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGUoe30sIF8uZXh0ZW5kKG9wdGlvbnMgfHwge30sIHsgdmFsaWRhdGU6IHRydWUgfSkpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gT3RoZXJ3aXNlLCBmaXJlIGFuIGAiaW52YWxpZCJgIGV2ZW50LgogICAgX3ZhbGlkYXRlOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoIW9wdGlvbnMudmFsaWRhdGUgfHwgIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOwogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsKICAgICAgdmFyIGVycm9yID0gdGhpcy52YWxpZGF0aW9uRXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSB8fCBudWxsOwogICAgICBpZiAoIWVycm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgZXJyb3IsIF8uZXh0ZW5kKG9wdGlvbnMsIHt2YWxpZGF0aW9uRXJyb3I6IGVycm9yfSkpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB3ZSB3YW50IHRvIGltcGxlbWVudCBvbiB0aGUgTW9kZWwuCiAgdmFyIG1vZGVsTWV0aG9kcyA9IFsna2V5cycsICd2YWx1ZXMnLCAncGFpcnMnLCAnaW52ZXJ0JywgJ3BpY2snLCAnb21pdCddOwoKICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBNb2RlbCNhdHRyaWJ1dGVzYC4KICBfLmVhY2gobW9kZWxNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIE1vZGVsLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCgogIC8vIElmIG1vZGVscyB0ZW5kIHRvIHJlcHJlc2VudCBhIHNpbmdsZSByb3cgb2YgZGF0YSwgYSBCYWNrYm9uZSBDb2xsZWN0aW9uIGlzCiAgLy8gbW9yZSBhbmFsYWdvdXMgdG8gYSB0YWJsZSBmdWxsIG9mIGRhdGEgLi4uIG9yIGEgc21hbGwgc2xpY2Ugb3IgcGFnZSBvZiB0aGF0CiAgLy8gdGFibGUsIG9yIGEgY29sbGVjdGlvbiBvZiByb3dzIHRoYXQgYmVsb25nIHRvZ2V0aGVyIGZvciBhIHBhcnRpY3VsYXIgcmVhc29uCiAgLy8gLS0gYWxsIG9mIHRoZSBtZXNzYWdlcyBpbiB0aGlzIHBhcnRpY3VsYXIgZm9sZGVyLCBhbGwgb2YgdGhlIGRvY3VtZW50cwogIC8vIGJlbG9uZ2luZyB0byB0aGlzIHBhcnRpY3VsYXIgYXV0aG9yLCBhbmQgc28gb24uIENvbGxlY3Rpb25zIG1haW50YWluCiAgLy8gaW5kZXhlcyBvZiB0aGVpciBtb2RlbHMsIGJvdGggaW4gb3JkZXIsIGFuZCBmb3IgbG9va3VwIGJ5IGBpZGAuCgogIC8vIENyZWF0ZSBhIG5ldyAqKkNvbGxlY3Rpb24qKiwgcGVyaGFwcyB0byBjb250YWluIGEgc3BlY2lmaWMgdHlwZSBvZiBgbW9kZWxgLgogIC8vIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbgogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4KICB2YXIgQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24gPSBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7CiAgICBpZiAob3B0aW9ucy5jb21wYXJhdG9yICE9PSB2b2lkIDApIHRoaXMuY29tcGFyYXRvciA9IG9wdGlvbnMuY29tcGFyYXRvcjsKICAgIHRoaXMuX3Jlc2V0KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChtb2RlbHMpIHRoaXMucmVzZXQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogIH07CgogIC8vIERlZmF1bHQgb3B0aW9ucyBmb3IgYENvbGxlY3Rpb24jc2V0YC4KICB2YXIgc2V0T3B0aW9ucyA9IHthZGQ6IHRydWUsIHJlbW92ZTogdHJ1ZSwgbWVyZ2U6IHRydWV9OwogIHZhciBhZGRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiBmYWxzZX07CgogIC8vIERlZmluZSB0aGUgQ29sbGVjdGlvbidzIGluaGVyaXRhYmxlIG1ldGhvZHMuCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IG1vZGVsIGZvciBhIGNvbGxlY3Rpb24gaXMganVzdCBhICoqQmFja2JvbmUuTW9kZWwqKi4KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4KICAgIG1vZGVsOiBNb2RlbCwKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUKICAgIC8vIG1vZGVscycgYXR0cmlidXRlcy4KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsKICAgIH0sCgogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuCiAgICBzeW5jOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5zZXQobW9kZWxzLCBfLmV4dGVuZCh7bWVyZ2U6IGZhbHNlfSwgb3B0aW9ucywgYWRkT3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgc2luZ3VsYXIgPSAhXy5pc0FycmF5KG1vZGVscyk7CiAgICAgIG1vZGVscyA9IHNpbmd1bGFyID8gW21vZGVsc10gOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIHZhciBpLCBsLCBpbmRleCwgbW9kZWw7CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5jaWRdOwogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsKICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIHRoaXMubGVuZ3RoLS07CiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgewogICAgICAgICAgb3B0aW9ucy5pbmRleCA9IGluZGV4OwogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICB9CiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gVXBkYXRlIGEgY29sbGVjdGlvbiBieSBgc2V0YC1pbmcgYSBuZXcgbGlzdCBvZiBtb2RlbHMsIGFkZGluZyBuZXcgb25lcywKICAgIC8vIHJlbW92aW5nIG1vZGVscyB0aGF0IGFyZSBubyBsb25nZXIgcHJlc2VudCwgYW5kIG1lcmdpbmcgbW9kZWxzIHRoYXQKICAgIC8vIGFscmVhZHkgZXhpc3QgaW4gdGhlIGNvbGxlY3Rpb24sIGFzIG5lY2Vzc2FyeS4gU2ltaWxhciB0byAqKk1vZGVsI3NldCoqLAogICAgLy8gdGhlIGNvcmUgb3BlcmF0aW9uIGZvciB1cGRhdGluZyB0aGUgZGF0YSBjb250YWluZWQgYnkgdGhlIGNvbGxlY3Rpb24uCiAgICBzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgb3B0aW9ucywgc2V0T3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscywgb3B0aW9ucyk7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyAobW9kZWxzID8gW21vZGVsc10gOiBbXSkgOiBfLmNsb25lKG1vZGVscyk7CiAgICAgIHZhciBpLCBsLCBpZCwgbW9kZWwsIGF0dHJzLCBleGlzdGluZywgc29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucy5hdDsKICAgICAgdmFyIHRhcmdldE1vZGVsID0gdGhpcy5tb2RlbDsKICAgICAgdmFyIHNvcnRhYmxlID0gdGhpcy5jb21wYXJhdG9yICYmIChhdCA9PSBudWxsKSAmJiBvcHRpb25zLnNvcnQgIT09IGZhbHNlOwogICAgICB2YXIgc29ydEF0dHIgPSBfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgPyB0aGlzLmNvbXBhcmF0b3IgOiBudWxsOwogICAgICB2YXIgdG9BZGQgPSBbXSwgdG9SZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsKICAgICAgdmFyIGFkZCA9IG9wdGlvbnMuYWRkLCBtZXJnZSA9IG9wdGlvbnMubWVyZ2UsIHJlbW92ZSA9IG9wdGlvbnMucmVtb3ZlOwogICAgICB2YXIgb3JkZXIgPSAhc29ydGFibGUgJiYgYWRkICYmIHJlbW92ZSA/IFtdIDogZmFsc2U7CgogICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzCiAgICAgIC8vIGZyb20gYmVpbmcgYWRkZWQuCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgYXR0cnMgPSBtb2RlbHNbaV0gfHwge307CiAgICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsKICAgICAgICAgIGlkID0gbW9kZWwgPSBhdHRyczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWQgPSBhdHRyc1t0YXJnZXRNb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGUgfHwgJ2lkJ107CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nID0gdGhpcy5nZXQoaWQpKSB7CiAgICAgICAgICBpZiAocmVtb3ZlKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsKICAgICAgICAgIGlmIChtZXJnZSkgewogICAgICAgICAgICBhdHRycyA9IGF0dHJzID09PSBtb2RlbCA/IG1vZGVsLmF0dHJpYnV0ZXMgOiBhdHRyczsKICAgICAgICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gZXhpc3RpbmcucGFyc2UoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBleGlzdGluZy5zZXQoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoc29ydGFibGUgJiYgIXNvcnQgJiYgZXhpc3RpbmcuaGFzQ2hhbmdlZChzb3J0QXR0cikpIHNvcnQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzW2ldID0gZXhpc3Rpbmc7CgogICAgICAgIC8vIElmIHRoaXMgaXMgYSBuZXcsIHZhbGlkIG1vZGVsLCBwdXNoIGl0IHRvIHRoZSBgdG9BZGRgIGxpc3QuCiAgICAgICAgfSBlbHNlIGlmIChhZGQpIHsKICAgICAgICAgIG1vZGVsID0gbW9kZWxzW2ldID0gdGhpcy5fcHJlcGFyZU1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgICAgdG9BZGQucHVzaChtb2RlbCk7CiAgICAgICAgICB0aGlzLl9hZGRSZWZlcmVuY2UobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIH0KCiAgICAgICAgLy8gRG8gbm90IGFkZCBtdWx0aXBsZSBtb2RlbHMgd2l0aCB0aGUgc2FtZSBgaWRgLgogICAgICAgIG1vZGVsID0gZXhpc3RpbmcgfHwgbW9kZWw7CiAgICAgICAgaWYgKG9yZGVyICYmIChtb2RlbC5pc05ldygpIHx8ICFtb2RlbE1hcFttb2RlbC5pZF0pKSBvcmRlci5wdXNoKG1vZGVsKTsKICAgICAgICBtb2RlbE1hcFttb2RlbC5pZF0gPSB0cnVlOwogICAgICB9CgogICAgICAvLyBSZW1vdmUgbm9uZXhpc3RlbnQgbW9kZWxzIGlmIGFwcHJvcHJpYXRlLgogICAgICBpZiAocmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgKytpKSB7CiAgICAgICAgICBpZiAoIW1vZGVsTWFwWyhtb2RlbCA9IHRoaXMubW9kZWxzW2ldKS5jaWRdKSB0b1JlbW92ZS5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRvUmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUodG9SZW1vdmUsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuCiAgICAgIGlmICh0b0FkZC5sZW5ndGggfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHsKICAgICAgICBpZiAoc29ydGFibGUpIHNvcnQgPSB0cnVlOwogICAgICAgIHRoaXMubGVuZ3RoICs9IHRvQWRkLmxlbmd0aDsKICAgICAgICBpZiAoYXQgIT0gbnVsbCkgewogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5zcGxpY2UoYXQgKyBpLCAwLCB0b0FkZFtpXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChvcmRlcikgdGhpcy5tb2RlbHMubGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBvcmRlcmVkTW9kZWxzID0gb3JkZXIgfHwgdG9BZGQ7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gb3JkZXJlZE1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5tb2RlbHMucHVzaChvcmRlcmVkTW9kZWxzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFNpbGVudGx5IHNvcnQgdGhlIGNvbGxlY3Rpb24gaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChzb3J0KSB0aGlzLnNvcnQoe3NpbGVudDogdHJ1ZX0pOwoKICAgICAgLy8gVW5sZXNzIHNpbGVuY2VkLCBpdCdzIHRpbWUgdG8gZmlyZSBhbGwgYXBwcm9wcmlhdGUgYWRkL3NvcnQgZXZlbnRzLgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRvQWRkLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgKG1vZGVsID0gdG9BZGRbaV0pLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvcnQgfHwgKG9yZGVyICYmIG9yZGVyLmxlbmd0aCkpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICB9CgogICAgICAvLyBSZXR1cm4gdGhlIGFkZGVkIChvciBtZXJnZWQpIG1vZGVsIChvciBtb2RlbHMpLgogICAgICByZXR1cm4gc2luZ3VsYXIgPyBtb2RlbHNbMF0gOiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGdyYW51bGFyIGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgLy8gVXNlZnVsIGZvciBidWxrIG9wZXJhdGlvbnMgYW5kIG9wdGltaXphdGlvbnMuCiAgICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgfQogICAgICBvcHRpb25zLnByZXZpb3VzTW9kZWxzID0gdGhpcy5tb2RlbHM7CiAgICAgIHRoaXMuX3Jlc2V0KCk7CiAgICAgIG1vZGVscyA9IHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsKICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdyZXNldCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWxzOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcHVzaDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IHRoaXMubGVuZ3RofSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBzaGlmdDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOwogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gU2xpY2Ugb3V0IGEgc3ViLWFycmF5IG9mIG1vZGVscyBmcm9tIHRoZSBjb2xsZWN0aW9uLgogICAgc2xpY2U6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc2xpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCBhIG1vZGVsIGZyb20gdGhlIHNldCBieSBpZC4KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7CiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsKICAgICAgcmV0dXJuIHRoaXMuX2J5SWRbb2JqXSB8fCB0aGlzLl9ieUlkW29iai5pZF0gfHwgdGhpcy5fYnlJZFtvYmouY2lkXTsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBtb2RlbCBhdCB0aGUgZ2l2ZW4gaW5kZXguCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsKICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsKICAgIH0sCgogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mCiAgICAvLyBgZmlsdGVyYC4KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycywgZmlyc3QpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBmaXJzdCA/IHZvaWQgMCA6IFtdOwogICAgICByZXR1cm4gdGhpc1tmaXJzdCA/ICdmaW5kJyA6ICdmaWx0ZXInXShmdW5jdGlvbihtb2RlbCkgewogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9KTsKICAgIH0sCgogICAgLy8gUmV0dXJuIHRoZSBmaXJzdCBtb2RlbCB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzCiAgICAvLyBvZiBgZmluZGAuCiAgICBmaW5kV2hlcmU6IGZ1bmN0aW9uKGF0dHJzKSB7CiAgICAgIHJldHVybiB0aGlzLndoZXJlKGF0dHJzLCB0cnVlKTsKICAgIH0sCgogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcgogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQogICAgLy8gaXMgYWRkZWQuCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CgogICAgICAvLyBSdW4gc29ydCBiYXNlZCBvbiB0eXBlIG9mIGBjb21wYXJhdG9yYC4KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5tb2RlbHMgPSB0aGlzLnNvcnRCeSh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOwogICAgICB9CgogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFBsdWNrIGFuIGF0dHJpYnV0ZSBmcm9tIGVhY2ggbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsKICAgIH0sCgogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGByZXNldDogdHJ1ZWAgaXMgcGFzc2VkLCB0aGUgcmVzcG9uc2UKICAgIC8vIGRhdGEgd2lsbCBiZSBwYXNzZWQgdGhyb3VnaCB0aGUgYHJlc2V0YCBtZXRob2QgaW5zdGVhZCBvZiBgc2V0YC4KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlc2V0ID8gJ3Jlc2V0JyA6ICdzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBjb2xsZWN0aW9uLnRyaWdnZXIoJ3N5bmMnLCBjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUKICAgIC8vIGNvbGxlY3Rpb24gaW1tZWRpYXRlbHksIHVubGVzcyBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCBpbiB3aGljaCBjYXNlIHdlCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLgogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpKSkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgdGhpcy5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCwgb3B0aW9ucykgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByaXZhdGUgbWV0aG9kIHRvIHJlc2V0IGFsbCBpbnRlcm5hbCBzdGF0ZS4gQ2FsbGVkIHdoZW4gdGhlIGNvbGxlY3Rpb24KICAgIC8vIGlzIGZpcnN0IGluaXRpYWxpemVkIG9yIHJlc2V0LgogICAgX3Jlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5sZW5ndGggPSAwOwogICAgICB0aGlzLm1vZGVscyA9IFtdOwogICAgICB0aGlzLl9ieUlkICA9IHt9OwogICAgfSwKCiAgICAvLyBQcmVwYXJlIGEgaGFzaCBvZiBhdHRyaWJ1dGVzIChvciBvdGhlciBtb2RlbCkgdG8gYmUgYWRkZWQgdG8gdGhpcwogICAgLy8gY29sbGVjdGlvbi4KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmIChhdHRycyBpbnN0YW5jZW9mIE1vZGVsKSByZXR1cm4gYXR0cnM7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBvcHRpb25zLmNvbGxlY3Rpb24gPSB0aGlzOwogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7CiAgICAgIGlmICghbW9kZWwudmFsaWRhdGlvbkVycm9yKSByZXR1cm4gbW9kZWw7CiAgICAgIHRoaXMudHJpZ2dlcignaW52YWxpZCcsIHRoaXMsIG1vZGVsLnZhbGlkYXRpb25FcnJvciwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGNyZWF0ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfYWRkUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICB0aGlzLl9ieUlkW21vZGVsLmNpZF0gPSBtb2RlbDsKICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIGlmICghbW9kZWwuY29sbGVjdGlvbikgbW9kZWwuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V2ZXIgYSBtb2RlbCdzIHRpZXMgdG8gYSBjb2xsZWN0aW9uLgogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOwogICAgICBtb2RlbC5vZmYoJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCBjYWxsZWQgZXZlcnkgdGltZSBhIG1vZGVsIGluIHRoZSBzZXQgZmlyZXMgYW4gZXZlbnQuCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUKICAgIC8vIGluIG90aGVyIGNvbGxlY3Rpb25zIGFyZSBpZ25vcmVkLgogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7CiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOwogICAgICBpZiAoZXZlbnQgPT09ICdkZXN0cm95JykgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsKICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgfQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLgogIC8vIDkwJSBvZiB0aGUgY29yZSB1c2VmdWxuZXNzIG9mIEJhY2tib25lIENvbGxlY3Rpb25zIGlzIGFjdHVhbGx5IGltcGxlbWVudGVkCiAgLy8gcmlnaHQgaGVyZToKICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLAogICAgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsICdjb250YWlucycsICdpbnZva2UnLAogICAgJ21heCcsICdtaW4nLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgJ3RhaWwnLCAnZHJvcCcsICdsYXN0JywgJ3dpdGhvdXQnLCAnZGlmZmVyZW5jZScsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknLCAnY2hhaW4nLCAnc2FtcGxlJ107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYENvbGxlY3Rpb24jbW9kZWxzYC4KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgdGFrZSBhIHByb3BlcnR5IG5hbWUgYXMgYW4gYXJndW1lbnQuCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknLCAnaW5kZXhCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIEJhY2tib25lIFZpZXdzIGFyZSBhbG1vc3QgbW9yZSBjb252ZW50aW9uIHRoYW4gdGhleSBhcmUgYWN0dWFsIGNvZGUuIEEgVmlldwogIC8vIGlzIHNpbXBseSBhIEphdmFTY3JpcHQgb2JqZWN0IHRoYXQgcmVwcmVzZW50cyBhIGxvZ2ljYWwgY2h1bmsgb2YgVUkgaW4gdGhlCiAgLy8gRE9NLiBUaGlzIG1pZ2h0IGJlIGEgc2luZ2xlIGl0ZW0sIGFuIGVudGlyZSBsaXN0LCBhIHNpZGViYXIgb3IgcGFuZWwsIG9yCiAgLy8gZXZlbiB0aGUgc3Vycm91bmRpbmcgZnJhbWUgd2hpY2ggd3JhcHMgeW91ciB3aG9sZSBhcHAuIERlZmluaW5nIGEgY2h1bmsgb2YKICAvLyBVSSBhcyBhICoqVmlldyoqIGFsbG93cyB5b3UgdG8gZGVmaW5lIHlvdXIgRE9NIGV2ZW50cyBkZWNsYXJhdGl2ZWx5LCB3aXRob3V0CiAgLy8gaGF2aW5nIHRvIHdvcnJ5IGFib3V0IHJlbmRlciBvcmRlciAuLi4gYW5kIG1ha2VzIGl0IGVhc3kgZm9yIHRoZSB2aWV3IHRvCiAgLy8gcmVhY3QgdG8gc3BlY2lmaWMgY2hhbmdlcyBpbiB0aGUgc3RhdGUgb2YgeW91ciBtb2RlbHMuCgogIC8vIENyZWF0aW5nIGEgQmFja2JvbmUuVmlldyBjcmVhdGVzIGl0cyBpbml0aWFsIGVsZW1lbnQgb3V0c2lkZSBvZiB0aGUgRE9NLAogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCd2aWV3Jyk7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7CiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsKICB9OwoKICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsKCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4KICAgIHRhZ05hbWU6ICdkaXYnLAoKICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScsCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9CiAgICAvLyAgICAgfQogICAgLy8KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5LgogICAgLy8gVXNlcyBldmVudCBkZWxlZ2F0aW9uIGZvciBlZmZpY2llbmN5LgogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQKICAgIC8vIG5vdCBgY2hhbmdlYCwgYHN1Ym1pdGAsIGFuZCBgcmVzZXRgIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgewogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIGNvbnRpbnVlOwoKICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICB2YXIgZXZlbnROYW1lID0gbWF0Y2hbMV0sIHNlbGVjdG9yID0gbWF0Y2hbMl07CiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7CiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgaWYgKHNlbGVjdG9yID09PSAnJykgewogICAgICAgICAgdGhpcy4kZWwub24oZXZlbnROYW1lLCBtZXRob2QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIHNlbGVjdG9yLCBtZXRob2QpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLm9mZignLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLgogICAgLy8gSWYgYHRoaXMuZWxgIGlzIGEgc3RyaW5nLCBwYXNzIGl0IHRocm91Z2ggYCQoKWAsIHRha2UgdGhlIGZpcnN0CiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4KICAgIF9lbnN1cmVFbGVtZW50OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLmVsKSB7CiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgIGlmICh0aGlzLmlkKSBhdHRycy5pZCA9IF8ucmVzdWx0KHRoaXMsICdpZCcpOwogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7CiAgICAgICAgdmFyICRlbCA9IEJhY2tib25lLiQoJzwnICsgXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSArICc+JykuYXR0cihhdHRycyk7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KCRlbCwgZmFsc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5zeW5jCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIC8vIElmIHdlJ3JlIHNlbmRpbmcgYSBgUEFUQ0hgIHJlcXVlc3QsIGFuZCB3ZSdyZSBpbiBhbiBvbGQgSW50ZXJuZXQgRXhwbG9yZXIKICAgIC8vIHRoYXQgc3RpbGwgaGFzIEFjdGl2ZVggZW5hYmxlZCBieSBkZWZhdWx0LCBvdmVycmlkZSBqUXVlcnkgdG8gdXNlIHRoYXQKICAgIC8vIGZvciBYSFIgaW5zdGVhZC4gUmVtb3ZlIHRoaXMgbGluZSB3aGVuIGpRdWVyeSBzdXBwb3J0cyBgUEFUQ0hgIG9uIElFOC4KICAgIGlmIChwYXJhbXMudHlwZSA9PT0gJ1BBVENIJyAmJiBub1hoclBhdGNoKSB7CiAgICAgIHBhcmFtcy54aHIgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxIVFRQIik7CiAgICAgIH07CiAgICB9CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBvcHRpb25zLnhociA9IEJhY2tib25lLmFqYXgoXy5leHRlbmQocGFyYW1zLCBvcHRpb25zKSk7CiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7CiAgICByZXR1cm4geGhyOwogIH07CgogIHZhciBub1hoclBhdGNoID0KICAgIHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmICEhd2luZG93LkFjdGl2ZVhPYmplY3QgJiYKICAgICAgISh3aW5kb3cuWE1MSHR0cFJlcXVlc3QgJiYgKG5ldyBYTUxIdHRwUmVxdWVzdCkuZGlzcGF0Y2hFdmVudCk7CgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIC8vIE92ZXJyaWRlIHRoaXMgaWYgeW91J2QgbGlrZSB0byB1c2UgYSBkaWZmZXJlbnQgbGlicmFyeS4KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQmFja2JvbmUuUm91dGVyCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIFJvdXRlcnMgbWFwIGZhdXgtVVJMcyB0byBhY3Rpb25zLCBhbmQgZmlyZSBldmVudHMgd2hlbiByb3V0ZXMgYXJlCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsKICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIENhY2hlZCByZWd1bGFyIGV4cHJlc3Npb25zIGZvciBtYXRjaGluZyBuYW1lZCBwYXJhbSBwYXJ0cyBhbmQgc3BsYXR0ZWQKICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLgogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOwogIHZhciBuYW1lZFBhcmFtICAgID0gLyhcKFw/KT86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG5hbWUpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBuYW1lOwogICAgICAgIG5hbWUgPSAnJzsKICAgICAgfQogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIHZhciByb3V0ZXIgPSB0aGlzOwogICAgICBCYWNrYm9uZS5oaXN0b3J5LnJvdXRlKHJvdXRlLCBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gcm91dGVyLl9leHRyYWN0UGFyYW1ldGVycyhyb3V0ZSwgZnJhZ21lbnQpOwogICAgICAgIHJvdXRlci5leGVjdXRlKGNhbGxiYWNrLCBhcmdzKTsKICAgICAgICByb3V0ZXIudHJpZ2dlci5hcHBseShyb3V0ZXIsIFsncm91dGU6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgcm91dGVyLnRyaWdnZXIoJ3JvdXRlJywgbmFtZSwgYXJncyk7CiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHJvdXRlciwgbmFtZSwgYXJncyk7CiAgICAgIH0pOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRXhlY3V0ZSBhIHJvdXRlIGhhbmRsZXIgd2l0aCB0aGUgcHJvdmlkZWQgcGFyYW1ldGVycy4gIFRoaXMgaXMgYW4KICAgIC8vIGV4Y2VsbGVudCBwbGFjZSB0byBkbyBwcmUtcm91dGUgc2V0dXAgb3IgcG9zdC1yb3V0ZSBjbGVhbnVwLgogICAgZXhlY3V0ZTogZnVuY3Rpb24oY2FsbGJhY2ssIGFyZ3MpIHsKICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0sCgogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQogICAgLy8gb3JkZXIgb2YgdGhlIHJvdXRlcyBoZXJlIHRvIHN1cHBvcnQgYmVoYXZpb3Igd2hlcmUgdGhlIG1vc3QgZ2VuZXJhbAogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKCF0aGlzLnJvdXRlcykgcmV0dXJuOwogICAgICB0aGlzLnJvdXRlcyA9IF8ucmVzdWx0KHRoaXMsICdyb3V0ZXMnKTsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sIGZ1bmN0aW9uKG1hdGNoLCBvcHRpb25hbCkgewogICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9uYWwgPyBtYXRjaCA6ICcoW14vP10rKSc7CiAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyhbXj9dKj8pJyk7CiAgICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHJvdXRlICsgJyg/OlxcPyhbXFxzXFxTXSopKT8kJyk7CiAgICB9LAoKICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YKICAgIC8vIGV4dHJhY3RlZCBkZWNvZGVkIHBhcmFtZXRlcnMuIEVtcHR5IG9yIHVubWF0Y2hlZCBwYXJhbWV0ZXJzIHdpbGwgYmUKICAgIC8vIHRyZWF0ZWQgYXMgYG51bGxgIHRvIG5vcm1hbGl6ZSBjcm9zcy1icm93c2VyIGJlaGF2aW9yLgogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsKICAgICAgdmFyIHBhcmFtcyA9IHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOwogICAgICByZXR1cm4gXy5tYXAocGFyYW1zLCBmdW5jdGlvbihwYXJhbSwgaSkgewogICAgICAgIC8vIERvbid0IGRlY29kZSB0aGUgc2VhcmNoIHBhcmFtcy4KICAgICAgICBpZiAoaSA9PT0gcGFyYW1zLmxlbmd0aCAtIDEpIHJldHVybiBwYXJhbSB8fCBudWxsOwogICAgICAgIHJldHVybiBwYXJhbSA/IGRlY29kZVVSSUNvbXBvbmVudChwYXJhbSkgOiBudWxsOwogICAgICB9KTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIGVpdGhlcgogIC8vIFtwdXNoU3RhdGVdKGh0dHA6Ly9kaXZlaW50b2h0bWw1LmluZm8vaGlzdG9yeS5odG1sKSBhbmQgcmVhbCBVUkxzLCBvcgogIC8vIFtvbmhhc2hjaGFuZ2VdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL3dpbmRvdy5vbmhhc2hjaGFuZ2UpCiAgLy8gYW5kIFVSTCBmcmFnbWVudHMuIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIG5laXRoZXIgKG9sZCBJRSwgbmF0Y2gpLAogIC8vIGZhbGxzIGJhY2sgdG8gcG9sbGluZy4KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsKICAgIF8uYmluZEFsbCh0aGlzLCAnY2hlY2tVcmwnKTsKCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4KICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICAgIH0KICB9OwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBhIGxlYWRpbmcgaGFzaC9zbGFzaCBhbmQgdHJhaWxpbmcgc3BhY2UuCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2hlcy4KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIGRldGVjdGluZyBNU0lFLgogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciByZW1vdmluZyBhIHRyYWlsaW5nIHNsYXNoLgogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIHVybHMgb2YgaGFzaC4KICB2YXIgcGF0aFN0cmlwcGVyID0gLyMuKiQvOwoKICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/CiAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChIaXN0b3J5LnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzCiAgICAvLyB0d2VudHkgdGltZXMgYSBzZWNvbmQuCiAgICBpbnRlcnZhbDogNTAsCgogICAgLy8gQXJlIHdlIGF0IHRoZSBhcHAgcm9vdD8KICAgIGF0Um9vdDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwogICAgfSwKCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4KICAgIGdldEhhc2g6IGZ1bmN0aW9uKHdpbmRvdykgewogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsCiAgICAvLyB0aGUgaGFzaCwgb3IgdGhlIG92ZXJyaWRlLgogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgewogICAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgfHwgIXRoaXMuX3dhbnRzSGFzaENoYW5nZSB8fCBmb3JjZVB1c2hTdGF0ZSkgewogICAgICAgICAgZnJhZ21lbnQgPSBkZWNvZGVVUkkodGhpcy5sb2NhdGlvbi5wYXRobmFtZSArIHRoaXMubG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOwogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnNsaWNlKHJvb3QubGVuZ3RoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgfSwKCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMKICAgIC8vIGFuIGV4aXN0aW5nIHJvdXRlLCBhbmQgYGZhbHNlYCBvdGhlcndpc2UuCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7CiAgICAgIEhpc3Rvcnkuc3RhcnRlZCA9IHRydWU7CgogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPwogICAgICAvLyBJcyBwdXNoU3RhdGUgZGVzaXJlZCAuLi4gaXMgaXQgYXZhaWxhYmxlPwogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB2YXIgZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiPicpOwogICAgICAgIHRoaXMuaWZyYW1lID0gZnJhbWUuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsKICAgICAgICB0aGlzLm5hdmlnYXRlKGZyYWdtZW50KTsKICAgICAgfQoKICAgICAgLy8gRGVwZW5kaW5nIG9uIHdoZXRoZXIgd2UncmUgdXNpbmcgcHVzaFN0YXRlIG9yIGhhc2hlcywgYW5kIHdoZXRoZXIKICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykub24oJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmICgnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3cpICYmICFvbGRJRSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwoKICAgICAgLy8gVHJhbnNpdGlvbiBmcm9tIGhhc2hDaGFuZ2UgdG8gcHVzaFN0YXRlIG9yIHZpY2UgdmVyc2EgaWYgYm90aCBhcmUKICAgICAgLy8gcmVxdWVzdGVkLgogICAgICBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlICYmIHRoaXMuX3dhbnRzUHVzaFN0YXRlKSB7CgogICAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZAogICAgICAgIC8vIGJyb3dzZXIsIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgICAgaWYgKCF0aGlzLl9oYXNQdXNoU3RhdGUgJiYgIXRoaXMuYXRSb290KCkpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOwogICAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArICcjJyArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgICAgLy8gT3IgaWYgd2UndmUgc3RhcnRlZCBvdXQgd2l0aCBhIGhhc2gtYmFzZWQgcm91dGUsIGJ1dCB3ZSdyZSBjdXJyZW50bHkKICAgICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICAgIH0gZWxzZSBpZiAodGhpcy5faGFzUHVzaFN0YXRlICYmIHRoaXMuYXRSb290KCkgJiYgbG9jLmhhc2gpIHsKICAgICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsKICAgICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50KTsKICAgICAgICB9CgogICAgICB9CgogICAgICBpZiAoIXRoaXMub3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gRGlzYWJsZSBCYWNrYm9uZS5oaXN0b3J5LCBwZXJoYXBzIHRlbXBvcmFyaWx5LiBOb3QgdXNlZnVsIGluIGEgcmVhbCBhcHAsCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS4kKHdpbmRvdykub2ZmKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpLm9mZignaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICBpZiAodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCkgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIEF0dGVtcHQgdG8gbG9hZCB0aGUgY3VycmVudCBVUkwgZnJhZ21lbnQuIElmIGEgcm91dGUgc3VjY2VlZHMgd2l0aCBhCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LAogICAgLy8gcmV0dXJucyBgZmFsc2VgLgogICAgbG9hZFVybDogZnVuY3Rpb24oZnJhZ21lbnQpIHsKICAgICAgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCk7CiAgICAgIHJldHVybiBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgaWYgKGhhbmRsZXIucm91dGUudGVzdChmcmFnbWVudCkpIHsKICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogISFvcHRpb25zfTsKCiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyAoZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKSk7CgogICAgICAvLyBTdHJpcCB0aGUgaGFzaCBmb3IgbWF0Y2hpbmcuCiAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZShwYXRoU3RyaXBwZXIsICcnKTsKCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CgogICAgICAvLyBEb24ndCBpbmNsdWRlIGEgdHJhaWxpbmcgc2xhc2ggb24gdGhlIHJvb3QuCiAgICAgIGlmIChmcmFnbWVudCA9PT0gJycgJiYgdXJsICE9PSAnLycpIHVybCA9IHVybC5zbGljZSgwLCAtMSk7CgogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLgogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7CiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsKCiAgICAgIC8vIElmIGhhc2ggY2hhbmdlcyBoYXZlbid0IGJlZW4gZXhwbGljaXRseSBkaXNhYmxlZCwgdXBkYXRlIHRoZSBoYXNoCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgewogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhCiAgICAgICAgICAvLyBoaXN0b3J5IGVudHJ5IG9uIGhhc2gtdGFnIGNoYW5nZS4gIFdoZW4gcmVwbGFjZSBpcyB0cnVlLCB3ZSBkb24ndAogICAgICAgICAgLy8gd2FudCB0aGlzLgogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7CiAgICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMuaWZyYW1lLmxvY2F0aW9uLCBmcmFnbWVudCwgb3B0aW9ucy5yZXBsYWNlKTsKICAgICAgICB9CgogICAgICAvLyBJZiB5b3UndmUgdG9sZCB1cyB0aGF0IHlvdSBleHBsaWNpdGx5IGRvbid0IHdhbnQgZmFsbGJhY2sgaGFzaGNoYW5nZS0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guCiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgcmV0dXJuIHRoaXMubG9hZFVybChmcmFnbWVudCk7CiAgICB9LAoKICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4KICAgIF91cGRhdGVIYXNoOiBmdW5jdGlvbihsb2NhdGlvbiwgZnJhZ21lbnQsIHJlcGxhY2UpIHsKICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOwogICAgICAgIGxvY2F0aW9uLnJlcGxhY2UoaHJlZiArICcjJyArIGZyYWdtZW50KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuCiAgICAgICAgbG9jYXRpb24uaGFzaCA9ICcjJyArIGZyYWdtZW50OwogICAgICB9CiAgICB9CgogIH0pOwoKICAvLyBDcmVhdGUgdGhlIGRlZmF1bHQgQmFja2JvbmUuaGlzdG9yeS4KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7CgogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCgogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLgogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kCiAgLy8gY2xhc3MgcHJvcGVydGllcyB0byBiZSBleHRlbmRlZC4KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsKICAgIHZhciBwYXJlbnQgPSB0aGlzOwogICAgdmFyIGNoaWxkOwoKICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UKICAgIC8vICh0aGUgImNvbnN0cnVjdG9yIiBwcm9wZXJ0eSBpbiB5b3VyIGBleHRlbmRgIGRlZmluaXRpb24pLCBvciBkZWZhdWx0ZWQKICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7CiAgICAgIGNoaWxkID0gcHJvdG9Qcm9wcy5jb25zdHJ1Y3RvcjsKICAgIH0gZWxzZSB7CiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcmV0dXJuIHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07CgogIC8vIFdyYXAgYW4gb3B0aW9uYWwgZXJyb3IgY2FsbGJhY2sgd2l0aCBhIGZhbGxiYWNrIGVycm9yIGV2ZW50LgogIHZhciB3cmFwRXJyb3IgPSBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIGVycm9yID0gb3B0aW9ucy5lcnJvcjsKICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgIH07CiAgfTsKCiAgcmV0dXJuIEJhY2tib25lOwoKfSkpOwoKLy8gVmVjdG9yaXplci4KLy8gLS0tLS0tLS0tLS0KCi8vIEEgdGlueSBsaWJyYXJ5IGZvciBtYWtpbmcgeW91ciBsaXZlIGVhc2llciB3aGVuIGRlYWxpbmcgd2l0aCBTVkcuCgovLyBDb3B5cmlnaHQgwqkgMjAxMiAtIDIwMTQgY2xpZW50IElPIChodHRwOi8vY2xpZW50LmlvKQoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICAgICAgCiAgICB9IGVsc2UgewogICAgICAgIC8vIEJyb3dzZXIgZ2xvYmFscy4KICAgICAgICByb290LlZlY3Rvcml6ZXIgPSByb290LlYgPSBmYWN0b3J5KCk7CiAgICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKCkgewoKICAgIC8vIFdlbGwsIGlmIFNWRyBpcyBub3Qgc3VwcG9ydGVkLCB0aGlzIGxpYnJhcnkgaXMgdXNlbGVzcy4KICAgIHZhciBTVkdzdXBwb3J0ZWQgPSAhISh3aW5kb3cuU1ZHQW5nbGUgfHwgZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uaGFzRmVhdHVyZSgnaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNCYXNpY1N0cnVjdHVyZScsICcxLjEnKSk7CgogICAgLy8gWE1MIG5hbWVzcGFjZXMuCiAgICB2YXIgbnMgPSB7CiAgICAgICAgeG1sbnM6ICdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsCiAgICAgICAgeGxpbms6ICdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJwogICAgfTsKICAgIC8vIFNWRyB2ZXJzaW9uLgogICAgdmFyIFNWR3ZlcnNpb24gPSAnMS4xJzsKCiAgICAvLyBBIGZ1bmN0aW9uIHJldHVybmluZyBhIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIGNsaWVudCBzZXNzaW9uIHdpdGggZXZlcnkgY2FsbC4KICAgIHZhciBpZENvdW50ZXIgPSAwOwogICAgZnVuY3Rpb24gdW5pcXVlSWQoKSB7CiAgICAgICAgdmFyIGlkID0gKytpZENvdW50ZXIgKyAnJzsKICAgICAgICByZXR1cm4gJ3YtJyArIGlkOwogICAgfQoKICAgIC8vIENyZWF0ZSBTVkcgZWxlbWVudC4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGVsLCBhdHRycywgY2hpbGRyZW4pIHsKCiAgICAgICAgaWYgKCFlbCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAKICAgICAgICAvLyBJZiBgZWxgIGlzIGFuIG9iamVjdCwgaXQgaXMgcHJvYmFibHkgYSBuYXRpdmUgU1ZHIGVsZW1lbnQuIFdyYXAgaXQgdG8gVkVsZW1lbnQuCiAgICAgICAgaWYgKHR5cGVvZiBlbCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBWRWxlbWVudChlbCk7CiAgICAgICAgfQogICAgICAgIGF0dHJzID0gYXR0cnMgfHwge307CgogICAgICAgIC8vIElmIGBlbGAgaXMgYSBgJ3N2ZydgIG9yIGAnU1ZHJ2Agc3RyaW5nLCBjcmVhdGUgYSBuZXcgU1ZHIGNhbnZhcy4KICAgICAgICBpZiAoZWwudG9Mb3dlckNhc2UoKSA9PT0gJ3N2ZycpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGF0dHJzLnhtbG5zID0gbnMueG1sbnM7CiAgICAgICAgICAgIGF0dHJzWyd4bWxuczp4bGluayddID0gbnMueGxpbms7CiAgICAgICAgICAgIGF0dHJzLnZlcnNpb24gPSBTVkd2ZXJzaW9uOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKGVsWzBdID09PSAnPCcpIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGVsZW1lbnQgZnJvbSBhbiBTVkcgc3RyaW5nLgogICAgICAgICAgICAvLyBBbGxvd3MgY29uc3RydWN0cyBvZiB0eXBlOiBgZG9jdW1lbnQuYXBwZW5kQ2hpbGQoVmVjdG9yaXplcignPHJlY3Q+PC9yZWN0PicpLm5vZGUpYC4KICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBzdmcgPSAnPHN2ZyB4bWxucz0iJyArIG5zLnhtbG5zICsgJyIgeG1sbnM6eGxpbms9IicgKyBucy54bGluayArICciIHZlcnNpb249IicgKyBTVkd2ZXJzaW9uICsgJyI+JyArIGVsICsgJzwvc3ZnPic7CiAgICAgICAgICAgIHZhciBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CiAgICAgICAgICAgIHBhcnNlci5hc3luYyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgc3ZnRG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhzdmcsICd0ZXh0L3htbCcpLmRvY3VtZW50RWxlbWVudDsKCiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBgY3JlYXRlRWxlbWVudCgpYCBtaWdodCBhbHNvIHJldHVybiBhbiBhcnJheSBzaG91bGQgdGhlIFNWRyBzdHJpbmcgcGFzc2VkIGFzCiAgICAgICAgICAgIC8vIHRoZSBmaXJzdCBhcmd1bWVudCBjb250YWluIG1vcmUgdGhlbiBvbmUgcm9vdCBlbGVtZW50LgogICAgICAgICAgICBpZiAoc3ZnRG9jLmNoaWxkTm9kZXMubGVuZ3RoID4gMSkgewoKICAgICAgICAgICAgICAgIC8vIE1hcCBjaGlsZCBub2RlcyB0byBgVkVsZW1lbnRgcy4KICAgICAgICAgICAgICAgIHZhciByZXQgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBzdmdEb2MuY2hpbGROb2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gc3ZnRG9jLmNoaWxkTm9kZXNbaV07CiAgICAgICAgICAgICAgICAgICAgcmV0LnB1c2gobmV3IFZFbGVtZW50KGRvY3VtZW50LmltcG9ydE5vZGUoY2hpbGROb2RlLCB0cnVlKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG5ldyBWRWxlbWVudChkb2N1bWVudC5pbXBvcnROb2RlKHN2Z0RvYy5maXJzdENoaWxkLCB0cnVlKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5zLnhtbG5zLCBlbCk7CgogICAgICAgIC8vIFNldCBhdHRyaWJ1dGVzLgogICAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewoKICAgICAgICAgICAgc2V0QXR0cmlidXRlKGVsLCBrZXksIGF0dHJzW2tleV0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBOb3JtYWxpemUgYGNoaWxkcmVuYCBhcnJheS4KICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGNoaWxkcmVuKSAhPSAnW29iamVjdCBBcnJheV0nKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgogICAgICAgIC8vIEFwcGVuZCBjaGlsZHJlbiBpZiB0aGV5IGFyZSBzcGVjaWZpZWQuCiAgICAgICAgdmFyIGkgPSAwLCBsZW4gPSAoY2hpbGRyZW5bMF0gJiYgY2hpbGRyZW4ubGVuZ3RoKSB8fCAwLCBjaGlsZDsKICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGNoaWxkIGluc3RhbmNlb2YgVkVsZW1lbnQgPyBjaGlsZC5ub2RlIDogY2hpbGQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbmV3IFZFbGVtZW50KGVsKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRBdHRyaWJ1dGUoZWwsIG5hbWUsIHZhbHVlKSB7CiAgICAgICAgCiAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignOicpID4gLTEpIHsKICAgICAgICAgICAgLy8gQXR0cmlidXRlIG5hbWVzIGNhbiBiZSBuYW1lc3BhY2VkLiBFLmcuIGBpbWFnZWAgZWxlbWVudHMKICAgICAgICAgICAgLy8gaGF2ZSBhIGB4bGluazpocmVmYCBhdHRyaWJ1dGUgdG8gc2V0IHRoZSBzb3VyY2Ugb2YgdGhlIGltYWdlLgogICAgICAgICAgICB2YXIgY29tYmluZWRLZXkgPSBuYW1lLnNwbGl0KCc6Jyk7CiAgICAgICAgICAgIGVsLnNldEF0dHJpYnV0ZU5TKG5zW2NvbWJpbmVkS2V5WzBdXSwgY29tYmluZWRLZXlbMV0sIHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICdpZCcpIHsKICAgICAgICAgICAgZWwuaWQgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVRyYW5zZm9ybVN0cmluZyh0cmFuc2Zvcm0pIHsKICAgICAgICB2YXIgdHJhbnNsYXRlLAogICAgICAgICAgICByb3RhdGUsCiAgICAgICAgICAgIHNjYWxlOwoKICAgICAgICBpZiAodHJhbnNmb3JtKSB7CgogICAgICAgICAgICB2YXIgc2VwYXJhdG9yID0gL1sgLF0rLzsKCiAgICAgICAgICAgIHZhciB0cmFuc2xhdGVNYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCgvdHJhbnNsYXRlXCgoLiopXCkvKTsKICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZU1hdGNoKSB7CiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSB0cmFuc2xhdGVNYXRjaFsxXS5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb3RhdGVNYXRjaCA9IHRyYW5zZm9ybS5tYXRjaCgvcm90YXRlXCgoLiopXCkvKTsKICAgICAgICAgICAgaWYgKHJvdGF0ZU1hdGNoKSB7CiAgICAgICAgICAgICAgICByb3RhdGUgPSByb3RhdGVNYXRjaFsxXS5zcGxpdChzZXBhcmF0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzY2FsZU1hdGNoID0gdHJhbnNmb3JtLm1hdGNoKC9zY2FsZVwoKC4qKVwpLyk7CiAgICAgICAgICAgIGlmIChzY2FsZU1hdGNoKSB7CiAgICAgICAgICAgICAgICBzY2FsZSA9IHNjYWxlTWF0Y2hbMV0uc3BsaXQoc2VwYXJhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIHN4ID0gKHNjYWxlICYmIHNjYWxlWzBdKSA/IHBhcnNlRmxvYXQoc2NhbGVbMF0pIDogMTsKICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0cmFuc2xhdGU6IHsKICAgICAgICAgICAgICAgIHR4OiAodHJhbnNsYXRlICYmIHRyYW5zbGF0ZVswXSkgPyBwYXJzZUludCh0cmFuc2xhdGVbMF0sIDEwKSA6IDAsCiAgICAgICAgICAgICAgICB0eTogKHRyYW5zbGF0ZSAmJiB0cmFuc2xhdGVbMV0pID8gcGFyc2VJbnQodHJhbnNsYXRlWzFdLCAxMCkgOiAwCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJvdGF0ZTogewogICAgICAgICAgICAgICAgYW5nbGU6IChyb3RhdGUgJiYgcm90YXRlWzBdKSA/IHBhcnNlSW50KHJvdGF0ZVswXSwgMTApIDogMCwKICAgICAgICAgICAgICAgIGN4OiAocm90YXRlICYmIHJvdGF0ZVsxXSkgPyBwYXJzZUludChyb3RhdGVbMV0sIDEwKSA6IHVuZGVmaW5lZCwKICAgICAgICAgICAgICAgIGN5OiAocm90YXRlICYmIHJvdGF0ZVsyXSkgPyBwYXJzZUludChyb3RhdGVbMl0sIDEwKSA6IHVuZGVmaW5lZAogICAgICAgICAgICB9LAogICAgICAgICAgICBzY2FsZTogewogICAgICAgICAgICAgICAgc3g6IHN4LAogICAgICAgICAgICAgICAgc3k6IChzY2FsZSAmJiBzY2FsZVsxXSkgPyBwYXJzZUZsb2F0KHNjYWxlWzFdKSA6IHN4CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfQoKCiAgICAvLyBNYXRyaXggZGVjb21wb3NpdGlvbi4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAgIGZ1bmN0aW9uIGRlbHRhVHJhbnNmb3JtUG9pbnQobWF0cml4LCBwb2ludCkgIHsKICAgICAgICAKCXZhciBkeCA9IHBvaW50LnggKiBtYXRyaXguYSArIHBvaW50LnkgKiBtYXRyaXguYyArIDA7Cgl2YXIgZHkgPSBwb2ludC54ICogbWF0cml4LmIgKyBwb2ludC55ICogbWF0cml4LmQgKyAwOwoJcmV0dXJuIHsgeDogZHgsIHk6IGR5IH07CiAgICB9CgogICAgZnVuY3Rpb24gZGVjb21wb3NlTWF0cml4KG1hdHJpeCkgewoKICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzIwNTIyNDcKICAgICAgICAKICAgICAgICAvLyBjYWxjdWxhdGUgZGVsdGEgdHJhbnNmb3JtIHBvaW50Cgl2YXIgcHggPSBkZWx0YVRyYW5zZm9ybVBvaW50KG1hdHJpeCwgeyB4OiAwLCB5OiAxIH0pOwoJdmFyIHB5ID0gZGVsdGFUcmFuc2Zvcm1Qb2ludChtYXRyaXgsIHsgeDogMSwgeTogMCB9KTsKICAgICAgICAKCS8vIGNhbGN1bGF0ZSBza2V3Cgl2YXIgc2tld1ggPSAoKDE4MCAvIE1hdGguUEkpICogTWF0aC5hdGFuMihweC55LCBweC54KSAtIDkwKTsKCXZhciBza2V3WSA9ICgoMTgwIC8gTWF0aC5QSSkgKiBNYXRoLmF0YW4yKHB5LnksIHB5LngpKTsKICAgICAgICAKCXJldHVybiB7CiAgICAgICAgICAgIAoJICAgIHRyYW5zbGF0ZVg6IG1hdHJpeC5lLAoJICAgIHRyYW5zbGF0ZVk6IG1hdHJpeC5mLAoJICAgIHNjYWxlWDogTWF0aC5zcXJ0KG1hdHJpeC5hICogbWF0cml4LmEgKyBtYXRyaXguYiAqIG1hdHJpeC5iKSwKCSAgICBzY2FsZVk6IE1hdGguc3FydChtYXRyaXguYyAqIG1hdHJpeC5jICsgbWF0cml4LmQgKiBtYXRyaXguZCksCgkgICAgc2tld1g6IHNrZXdYLAoJICAgIHNrZXdZOiBza2V3WSwKCSAgICByb3RhdGlvbjogc2tld1ggLy8gcm90YXRpb24gaXMgdGhlIHNhbWUgYXMgc2tldyB4Cgl9OwogICAgfQogICAgCiAgICAvLyBWRWxlbWVudC4KICAgIC8vIC0tLS0tLS0tLQoKICAgIGZ1bmN0aW9uIFZFbGVtZW50KGVsKSB7CiAgICAgICAgdGhpcy5ub2RlID0gZWw7CiAgICAgICAgaWYgKCF0aGlzLm5vZGUuaWQpIHsKICAgICAgICAgICAgdGhpcy5ub2RlLmlkID0gdW5pcXVlSWQoKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVkVsZW1lbnQgcHVibGljIEFQSS4KICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgVkVsZW1lbnQucHJvdG90eXBlID0gewogICAgICAgIAogICAgICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24odHgsIHR5LCBvcHQpIHsKCiAgICAgICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKICAgICAgICAgICAgdHkgPSB0eSB8fCAwOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRyYW5zZm9ybUF0dHIgPSB0aGlzLmF0dHIoJ3RyYW5zZm9ybScpIHx8ICcnLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtID0gcGFyc2VUcmFuc2Zvcm1TdHJpbmcodHJhbnNmb3JtQXR0cik7CgogICAgICAgICAgICAvLyBJcyBpdCBhIGdldHRlcj8KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eCA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cmFuc2Zvcm0udHJhbnNsYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2Zvcm1BdHRyID0gdHJhbnNmb3JtQXR0ci5yZXBsYWNlKC90cmFuc2xhdGVcKFteXCldKlwpL2csICcnKS50cmltKCk7CgogICAgICAgICAgICB2YXIgbmV3VHggPSBvcHQuYWJzb2x1dGUgPyB0eCA6IHRyYW5zZm9ybS50cmFuc2xhdGUudHggKyB0eCwKICAgICAgICAgICAgICAgIG5ld1R5ID0gb3B0LmFic29sdXRlID8gdHkgOiB0cmFuc2Zvcm0udHJhbnNsYXRlLnR5ICsgdHksCiAgICAgICAgICAgICAgICBuZXdUcmFuc2xhdGUgPSAndHJhbnNsYXRlKCcgKyBuZXdUeCArICcsJyArIG5ld1R5ICsgJyknOwoKICAgICAgICAgICAgLy8gTm90ZSB0aGF0IGB0cmFuc2xhdGUoKWAgaXMgYWx3YXlzIHRoZSBmaXJzdCB0cmFuc2Zvcm1hdGlvbi4gVGhpcyBpcwogICAgICAgICAgICAvLyB1c3VhbGx5IHRoZSBkZXNpcmVkIGNhc2UuCiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgKG5ld1RyYW5zbGF0ZSArICcgJyArIHRyYW5zZm9ybUF0dHIpLnRyaW0oKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHJvdGF0ZTogZnVuY3Rpb24oYW5nbGUsIGN4LCBjeSwgb3B0KSB7CgogICAgICAgICAgICBvcHQgPSBvcHQgfHwge307CgogICAgICAgICAgICB2YXIgdHJhbnNmb3JtQXR0ciA9IHRoaXMuYXR0cigndHJhbnNmb3JtJykgfHwgJycsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm0gPSBwYXJzZVRyYW5zZm9ybVN0cmluZyh0cmFuc2Zvcm1BdHRyKTsKCiAgICAgICAgICAgIC8vIElzIGl0IGEgZ2V0dGVyPwogICAgICAgICAgICBpZiAodHlwZW9mIGFuZ2xlID09PSAndW5kZWZpbmVkJykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRyYW5zZm9ybS5yb3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRyYW5zZm9ybUF0dHIgPSB0cmFuc2Zvcm1BdHRyLnJlcGxhY2UoL3JvdGF0ZVwoW15cKV0qXCkvZywgJycpLnRyaW0oKTsKCiAgICAgICAgICAgIGFuZ2xlICU9IDM2MDsKCiAgICAgICAgICAgIHZhciBuZXdBbmdsZSA9IG9wdC5hYnNvbHV0ZSA/IGFuZ2xlOiB0cmFuc2Zvcm0ucm90YXRlLmFuZ2xlICsgYW5nbGUsCiAgICAgICAgICAgICAgICBuZXdPcmlnaW4gPSAoY3ggIT09IHVuZGVmaW5lZCAmJiBjeSAhPT0gdW5kZWZpbmVkKSA/ICcsJyArIGN4ICsgJywnICsgY3kgOiAnJywKICAgICAgICAgICAgICAgIG5ld1JvdGF0ZSA9ICdyb3RhdGUoJyArIG5ld0FuZ2xlICsgbmV3T3JpZ2luICsgJyknOwoKICAgICAgICAgICAgdGhpcy5hdHRyKCd0cmFuc2Zvcm0nLCAodHJhbnNmb3JtQXR0ciArICcgJyArIG5ld1JvdGF0ZSkudHJpbSgpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gTm90ZSB0aGF0IGBzY2FsZWAgYXMgdGhlIG9ubHkgdHJhbnNmb3JtYXRpb24gZG9lcyBub3QgY29tYmluZSB3aXRoIHByZXZpb3VzIHZhbHVlcy4KICAgICAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5KSB7CiAgICAgICAgICAgIHN5ID0gKHR5cGVvZiBzeSA9PT0gJ3VuZGVmaW5lZCcpID8gc3ggOiBzeTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciB0cmFuc2Zvcm1BdHRyID0gdGhpcy5hdHRyKCd0cmFuc2Zvcm0nKSB8fCAnJywKICAgICAgICAgICAgICAgIHRyYW5zZm9ybSA9IHBhcnNlVHJhbnNmb3JtU3RyaW5nKHRyYW5zZm9ybUF0dHIpOwoKICAgICAgICAgICAgLy8gSXMgaXQgYSBnZXR0ZXI/CiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3ggPT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJhbnNmb3JtLnNjYWxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0cmFuc2Zvcm1BdHRyID0gdHJhbnNmb3JtQXR0ci5yZXBsYWNlKC9zY2FsZVwoW15cKV0qXCkvZywgJycpLnRyaW0oKTsKCiAgICAgICAgICAgIHZhciBuZXdTY2FsZSA9ICdzY2FsZSgnICsgc3ggKyAnLCcgKyBzeSArICcpJzsKCiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgKHRyYW5zZm9ybUF0dHIgKyAnICcgKyBuZXdTY2FsZSkudHJpbSgpKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgLy8gR2V0IFNWR1JlY3QgdGhhdCBjb250YWlucyBjb29yZGluYXRlcyBhbmQgZGltZW5zaW9uIG9mIHRoZSByZWFsIGJvdW5kaW5nIGJveCwKICAgICAgICAvLyBpLmUuIGFmdGVyIHRyYW5zZm9ybWF0aW9ucyBhcmUgYXBwbGllZC4KICAgICAgICAvLyBJZiBgdGFyZ2V0YCBpcyBzcGVjaWZpZWQsIGJvdW5kaW5nIGJveCB3aWxsIGJlIGNvbXB1dGVkIHJlbGF0aXZlbHkgdG8gYHRhcmdldGAgZWxlbWVudC4KICAgICAgICBiYm94OiBmdW5jdGlvbih3aXRob3V0VHJhbnNmb3JtYXRpb25zLCB0YXJnZXQpIHsKCiAgICAgICAgICAgIC8vIElmIHRoZSBlbGVtZW50IGlzIG5vdCBpbiB0aGUgbGl2ZSBET00sIGl0IGRvZXMgbm90IGhhdmUgYSBib3VuZGluZyBib3ggZGVmaW5lZCBhbmQKICAgICAgICAgICAgLy8gc28gZmFsbCBiYWNrIHRvICd6ZXJvJyBkaW1lbnNpb24gZWxlbWVudC4KICAgICAgICAgICAgaWYgKCF0aGlzLm5vZGUub3duZXJTVkdFbGVtZW50KSByZXR1cm4geyB4OiAwLCB5OiAwLCB3aWR0aDogMCwgaGVpZ2h0OiAwIH07CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgYm94OwogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICAgIGJveCA9IHRoaXMubm9kZS5nZXRCQm94KCk7CgoJCS8vIE9wZXJhIHJldHVybnMgaW5maW5pdGUgdmFsdWVzIGluIHNvbWUgY2FzZXMuCgkJLy8gTm90ZSB0aGF0IEluZmluaXR5IHwgMCBwcm9kdWNlcyAwIGFzIG9wcG9zZWQgdG8gSW5maW5pdHkgfHwgMC4KCQkvLyBXZSBhbHNvIGhhdmUgdG8gY3JlYXRlIG5ldyBvYmplY3QgYXMgdGhlIHN0YW5kYXJkIHNheXMgdGhhdCB5b3UgY2FuJ3QKCQkvLyBtb2RpZnkgdGhlIGF0dHJpYnV0ZXMgb2YgYSBiYm94LgoJCWJveCA9IHsgeDogYm94LnggfCAwLCB5OiBib3gueSB8IDAsIHdpZHRoOiBib3gud2lkdGggfCAwLCBoZWlnaHQ6IGJveC5oZWlnaHQgfCAwfTsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayBmb3IgSUUuCiAgICAgICAgICAgICAgICBib3ggPSB7CiAgICAgICAgICAgICAgICAgICAgeDogdGhpcy5ub2RlLmNsaWVudExlZnQsCiAgICAgICAgICAgICAgICAgICAgeTogdGhpcy5ub2RlLmNsaWVudFRvcCwKICAgICAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5ub2RlLmNsaWVudFdpZHRoLAogICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5ub2RlLmNsaWVudEhlaWdodAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHdpdGhvdXRUcmFuc2Zvcm1hdGlvbnMpIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gYm94OwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgbWF0cml4ID0gdGhpcy5ub2RlLmdldFRyYW5zZm9ybVRvRWxlbWVudCh0YXJnZXQgfHwgdGhpcy5ub2RlLm93bmVyU1ZHRWxlbWVudCk7CiAgICAgICAgICAgIHZhciBjb3JuZXJzID0gW107CiAgICAgICAgICAgIHZhciBwb2ludCA9IHRoaXMubm9kZS5vd25lclNWR0VsZW1lbnQuY3JlYXRlU1ZHUG9pbnQoKTsKCgogICAgICAgICAgICBwb2ludC54ID0gYm94Lng7CiAgICAgICAgICAgIHBvaW50LnkgPSBib3gueTsKICAgICAgICAgICAgY29ybmVycy5wdXNoKHBvaW50Lm1hdHJpeFRyYW5zZm9ybShtYXRyaXgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHBvaW50LnggPSBib3gueCArIGJveC53aWR0aDsKICAgICAgICAgICAgcG9pbnQueSA9IGJveC55OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcG9pbnQueCA9IGJveC54ICsgYm94LndpZHRoOwogICAgICAgICAgICBwb2ludC55ID0gYm94LnkgKyBib3guaGVpZ2h0OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgcG9pbnQueCA9IGJveC54OwogICAgICAgICAgICBwb2ludC55ID0gYm94LnkgKyBib3guaGVpZ2h0OwogICAgICAgICAgICBjb3JuZXJzLnB1c2gocG9pbnQubWF0cml4VHJhbnNmb3JtKG1hdHJpeCkpOwoKICAgICAgICAgICAgdmFyIG1pblggPSBjb3JuZXJzWzBdLng7CiAgICAgICAgICAgIHZhciBtYXhYID0gbWluWDsKICAgICAgICAgICAgdmFyIG1pblkgPSBjb3JuZXJzWzBdLnk7CiAgICAgICAgICAgIHZhciBtYXhZID0gbWluWTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBjb3JuZXJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHZhciB4ID0gY29ybmVyc1tpXS54OwogICAgICAgICAgICAgICAgdmFyIHkgPSBjb3JuZXJzW2ldLnk7CgogICAgICAgICAgICAgICAgaWYgKHggPCBtaW5YKSB7CiAgICAgICAgICAgICAgICAgICAgbWluWCA9IHg7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHggPiBtYXhYKSB7CiAgICAgICAgICAgICAgICAgICAgbWF4WCA9IHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh5IDwgbWluWSkgewogICAgICAgICAgICAgICAgICAgIG1pblkgPSB5OwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh5ID4gbWF4WSkgewogICAgICAgICAgICAgICAgICAgIG1heFkgPSB5OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgeDogbWluWCwKICAgICAgICAgICAgICAgIHk6IG1pblksCiAgICAgICAgICAgICAgICB3aWR0aDogbWF4WCAtIG1pblgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IG1heFkgLSBtaW5ZCiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgdGV4dDogZnVuY3Rpb24oY29udGVudCwgb3B0KSB7CgoJICAgIG9wdCA9IG9wdCB8fCB7fTsKICAgICAgICAgICAgdmFyIGxpbmVzID0gY29udGVudC5zcGxpdCgnXG4nKTsKCSAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciB0c3BhbjsKCiAgICAgICAgICAgIC8vIGBhbGlnbm1lbnQtYmFzZWxpbmVgIGRvZXMgbm90IHdvcmsgaW4gRmlyZWZveC4KCSAgICAvLyBTZXR0aW5nIGBkb21pbmFudC1iYXNlbGluZWAgb24gdGhlIGA8dGV4dD5gIGVsZW1lbnQgZG9lc24ndCB3b3JrIGluIElFOS4KICAgICAgICAgICAgLy8gSW4gb3JkZXIgdG8gaGF2ZSB0aGUgMCwwIGNvb3JkaW5hdGUgb2YgdGhlIGA8dGV4dD5gIGVsZW1lbnQgKG9yIHRoZSBmaXJzdCBgPHRzcGFuPmApCgkgICAgLy8gaW4gdGhlIHRvcCBsZWZ0IGNvcm5lciB3ZSB0cmFuc2xhdGUgdGhlIGA8dGV4dD5gIGVsZW1lbnQgYnkgYDAuOGVtYC4KCSAgICAvLyBTZWUgYGh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy9XRy93aWtpL0hvd190b19kZXRlcm1pbmVfZG9taW5hbnRfYmFzZWxpbmVgLgoJICAgIC8vIFNlZSBhbHNvIGBodHRwOi8vYXBpa2UuY2EvcHJvZ19zdmdfdGV4dF9zdHlsZS5odG1sYC4KCSAgICB0aGlzLmF0dHIoJ3knLCAnMC44ZW0nKTsKCiAgICAgICAgICAgIC8vIEFuIGVtcHR5IHRleHQgZ2V0cyByZW5kZXJlZCBpbnRvIHRoZSBET00gaW4gd2Via2l0LWJhc2VkIGJyb3dzZXJzLgogICAgICAgICAgICAvLyBJbiBvcmRlciB0byB1bmlmeSB0aGlzIGJlaGF2aW91ciBhY3Jvc3MgYWxsIGJyb3dzZXJzCiAgICAgICAgICAgIC8vIHdlIHJhdGhlciBoaWRlIHRoZSB0ZXh0IGVsZW1lbnQgd2hlbiBpdCdzIGVtcHR5LgogICAgICAgICAgICB0aGlzLmF0dHIoJ2Rpc3BsYXknLCBjb250ZW50ID8gbnVsbCA6ICdub25lJyk7CgoJICAgIC8vIFByZXNlcnZlIHNwYWNlcy4gSW4gb3RoZXIgd29yZHMsIHdlIGRvIG5vdCB3YW50IGNvbnNlY3V0aXZlIHNwYWNlcyB0byBnZXQgY29sbGFwc2VkIHRvIG9uZS4KCSAgICB0aGlzLm5vZGUuc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnL1hNTC8xOTk4L25hbWVzcGFjZSIsICJ4bWw6c3BhY2UiLCJwcmVzZXJ2ZSIpOwoKICAgICAgICAgICAgaWYgKGxpbmVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5ub2RlLnRleHRDb250ZW50ID0gY29udGVudDsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIEVhc3kgd2F5IHRvIGVyYXNlIGFsbCBgPHRzcGFuPmAgY2hpbGRyZW47CiAgICAgICAgICAgIHRoaXMubm9kZS50ZXh0Q29udGVudCA9ICcnOwogICAgICAgICAgICAKICAgICAgICAgICAgZm9yICg7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykgewoKICAgICAgICAgICAgICAgIC8vIFNoaWZ0IGFsbCB0aGUgPHRzcGFuPiBidXQgZmlyc3QgYnkgb25lIGxpbmUgKGAxZW1gKQogICAgICAgICAgICAgICAgdHNwYW4gPSBWKCd0c3BhbicsIHsgZHk6IChpID09IDAgPyAnMGVtJyA6IG9wdC5saW5lSGVpZ2h0IHx8ICcxZW0nKSwgeDogdGhpcy5hdHRyKCd4JykgfHwgMH0pOwoJCS8vIE1ha2Ugc3VyZSB0aGUgdGV4dENvbnRlbnQgaXMgbmV2ZXIgZW1wdHkuIElmIGl0IGlzLCBhZGQgYW4gYWRkaXRpb25hbCAKCQkvLyBzcGFjZSAoYW4gaW52aXNpYmxlIGNoYXJhY3Rlcikgc28gdGhhdCBmb2xsb3dpbmcgbGluZXMgYXJlIGNvcnJlY3RseQoJCS8vIHJlbGF0aXZlbHkgcG9zaXRpb25lZC4gYGR5PTFlbWAgd29uJ3Qgd29yayB3aXRoIGVtcHR5IGxpbmVzIG90aGVyd2lzZS4KICAgICAgICAgICAgICAgIHRzcGFuLm5vZGUudGV4dENvbnRlbnQgPSBsaW5lc1tpXSB8fCAnICc7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kKHRzcGFuKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIGF0dHI6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5vZGUuZ2V0QXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgYXR0ck5hbWUgaW4gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChuYW1lLmhhc093blByb3BlcnR5KGF0dHJOYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRBdHRyaWJ1dGUodGhpcy5ub2RlLCBhdHRyTmFtZSwgbmFtZVthdHRyTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHNldEF0dHJpYnV0ZSh0aGlzLm5vZGUsIG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKCiAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKHRoaXMubm9kZS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLm5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgYXBwZW5kOiBmdW5jdGlvbihlbCkgewoKICAgICAgICAgICAgdmFyIGVscyA9IGVsOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChlbCkgIT09ICdbb2JqZWN0IEFycmF5XScpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxzID0gW2VsXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGVscy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgZWwgPSBlbHNbaV07CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUuYXBwZW5kQ2hpbGQoZWwgaW5zdGFuY2VvZiBWRWxlbWVudCA/IGVsLm5vZGUgOiBlbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCgogICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICAgIHRoaXMubm9kZS5pbnNlcnRCZWZvcmUoZWwgaW5zdGFuY2VvZiBWRWxlbWVudCA/IGVsLm5vZGUgOiBlbCwgdGhpcy5ub2RlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0sCgogICAgICAgIHN2ZzogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICByZXR1cm4gdGhpcy5ub2RlIGluc3RhbmNlb2Ygd2luZG93LlNWR1NWR0VsZW1lbnQgPyB0aGlzIDogVih0aGlzLm5vZGUub3duZXJTVkdFbGVtZW50KTsKICAgICAgICB9LAoKICAgICAgICBkZWZzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBkZWZzID0gdGhpcy5zdmcoKS5ub2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdkZWZzJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gKGRlZnMgJiYgZGVmcy5sZW5ndGgpID8gVihkZWZzWzBdKSA6IHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IFYodGhpcy5ub2RlLmNsb25lTm9kZSh0cnVlKSk7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBjbG9uZSBpbmhlcml0cyBhbHNvIElELiBUaGVyZWZvcmUsIHdlIG5lZWQgdG8gY2hhbmdlIGl0IGhlcmUuCiAgICAgICAgICAgIGNsb25lLm5vZGUuaWQgPSB1bmlxdWVJZCgpOwogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgfSwKCiAgICAgICAgZmluZE9uZTogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBmb3VuZCA9IHRoaXMubm9kZS5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKICAgICAgICAgICAgcmV0dXJuIGZvdW5kID8gVihmb3VuZCkgOiB1bmRlZmluZWQ7CiAgICAgICAgfSwKCiAgICAgICAgZmluZDogZnVuY3Rpb24oc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBub2RlcyA9IHRoaXMubm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKCiAgICAgICAgICAgIC8vIE1hcCBET00gZWxlbWVudHMgdG8gYFZFbGVtZW50YHMuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBub2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgbm9kZXNbaV0gPSBWKG5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbm9kZXM7CiAgICAgICAgfSwKICAgICAgICAKICAgICAgICAvLyBDb252ZXJ0IGdsb2JhbCBwb2ludCBpbnRvIHRoZSBjb29yZGluYXRlIHNwYWNlIG9mIHRoaXMgZWxlbWVudC4KICAgICAgICB0b0xvY2FsUG9pbnQ6IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgICAgIHZhciBzdmcgPSB0aGlzLnN2ZygpLm5vZGU7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcCA9IHN2Zy5jcmVhdGVTVkdQb2ludCgpOwogICAgICAgICAgICBwLnggPSB4OwogICAgICAgICAgICBwLnkgPSB5OwoKCSAgICB0cnkgewoKCQl2YXIgZ2xvYmFsUG9pbnQgPSBwLm1hdHJpeFRyYW5zZm9ybShzdmcuZ2V0U2NyZWVuQ1RNKCkuaW52ZXJzZSgpKTsKCQl2YXIgZ2xvYmFsVG9Mb2NhbE1hdHJpeCA9IHRoaXMubm9kZS5nZXRUcmFuc2Zvcm1Ub0VsZW1lbnQoc3ZnKS5pbnZlcnNlKCk7CgoJICAgIH0gY2F0Y2goZSkgewoJCS8vIElFOSB0aHJvd3MgYW4gZXhjZXB0aW9uIGluIG9kZCBjYXNlcy4gKGBVbmV4cGVjdGVkIGNhbGwgdG8gbWV0aG9kIG9yIHByb3BlcnR5IGFjY2Vzc2ApCgkJLy8gV2UgaGF2ZSB0byBtYWtlIGRvIHdpdGggdGhlIG9yaWdpbmFsIGNvb3JkaWFuYXRlcy4KCQlyZXR1cm4gcDsKCSAgICB9CgogICAgICAgICAgICByZXR1cm4gZ2xvYmFsUG9pbnQubWF0cml4VHJhbnNmb3JtKGdsb2JhbFRvTG9jYWxNYXRyaXgpOwogICAgICAgIH0sCgogICAgICAgIHRyYW5zbGF0ZUNlbnRlclRvUG9pbnQ6IGZ1bmN0aW9uKHApIHsKCiAgICAgICAgICAgIHZhciBiYm94ID0gdGhpcy5iYm94KCk7CiAgICAgICAgICAgIHZhciBjZW50ZXIgPSBnLnJlY3QoYmJveCkuY2VudGVyKCk7CgogICAgICAgICAgICB0aGlzLnRyYW5zbGF0ZShwLnggLSBjZW50ZXIueCwgcC55IC0gY2VudGVyLnkpOwogICAgICAgIH0sCgogICAgICAgIC8vIEVmZmljaWVudGx5IGF1dG8tb3JpZW50IGFuIGVsZW1lbnQuIFRoaXMgYmFzaWNhbGx5IGltcGxlbWVudHMgdGhlIG9yaWVudD1hdXRvIGF0dHJpYnV0ZQogICAgICAgIC8vIG9mIG1hcmtlcnMuIFRoZSBlYXNpZXN0IHdheSBvZiB1bmRlcnN0YW5kaW5nIG9uIHdoYXQgdGhpcyBkb2VzIGlzIHRvIGltYWdpbmUgdGhlIGVsZW1lbnQgaXMgYW4KICAgICAgICAvLyBhcnJvd2hlYWQuIENhbGxpbmcgdGhpcyBtZXRob2Qgb24gdGhlIGFycm93aGVhZCBtYWtlcyBpdCBwb2ludCB0byB0aGUgYHBvc2l0aW9uYCBwb2ludCB3aGlsZQogICAgICAgIC8vIGJlaW5nIGF1dG8tb3JpZW50ZWQgKHByb3Blcmx5IHJvdGF0ZWQpIHRvd2FyZHMgdGhlIGByZWZlcmVuY2VgIHBvaW50LgogICAgICAgIC8vIGB0YXJnZXRgIGlzIHRoZSBlbGVtZW50IHJlbGF0aXZlIHRvIHdoaWNoIHRoZSB0cmFuc2Zvcm1hdGlvbnMgYXJlIGFwcGxpZWQuIFVzdWFsbHkgYSB2aWV3cG9ydC4KICAgICAgICB0cmFuc2xhdGVBbmRBdXRvT3JpZW50OiBmdW5jdGlvbihwb3NpdGlvbiwgcmVmZXJlbmNlLCB0YXJnZXQpIHsKCiAgICAgICAgICAgIC8vIENsZWFuLXVwIHByZXZpb3VzbHkgc2V0IHRyYW5zZm9ybWF0aW9ucyBleGNlcHQgdGhlIHNjYWxlLiBJZiB3ZSBkaWRuJ3QgY2xlYW4gdXAgdGhlCiAgICAgICAgICAgIC8vIHByZXZpb3VzIHRyYW5zZm9ybWF0aW9ucyB0aGVuIHRoZXknZCBhZGQgdXAgd2l0aCB0aGUgb2xkIG9uZXMuIFNjYWxlIGlzIGFuIGV4Y2VwdGlvbiBhcwogICAgICAgICAgICAvLyBpdCBkb2Vzbid0IGFkZCB1cCwgY29uc2lkZXI6IGB0aGlzLnNjYWxlKDIpLnNjYWxlKDIpLnNjYWxlKDIpYC4gVGhlIHJlc3VsdCBpcyB0aGF0IHRoZQogICAgICAgICAgICAvLyBlbGVtZW50IGlzIHNjYWxlZCBieSB0aGUgZmFjdG9yIDIsIG5vdCA4LgoKICAgICAgICAgICAgdmFyIHMgPSB0aGlzLnNjYWxlKCk7CiAgICAgICAgICAgIHRoaXMuYXR0cigndHJhbnNmb3JtJywgJycpOwogICAgICAgICAgICB0aGlzLnNjYWxlKHMuc3gsIHMuc3kpOwoKICAgICAgICAgICAgdmFyIHN2ZyA9IHRoaXMuc3ZnKCkubm9kZTsKICAgICAgICAgICAgdmFyIGJib3ggPSB0aGlzLmJib3goZmFsc2UsIHRhcmdldCk7CgogICAgICAgICAgICAvLyAxLiBUcmFuc2xhdGUgdG8gb3JpZ2luLgogICAgICAgICAgICB2YXIgdHJhbnNsYXRlVG9PcmlnaW4gPSBzdmcuY3JlYXRlU1ZHVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIHRyYW5zbGF0ZVRvT3JpZ2luLnNldFRyYW5zbGF0ZSgtYmJveC54IC0gYmJveC53aWR0aC8yLCAtYmJveC55IC0gYmJveC5oZWlnaHQvMik7CgogICAgICAgICAgICAvLyAyLiBSb3RhdGUgYXJvdW5kIG9yaWdpbi4KICAgICAgICAgICAgdmFyIHJvdGF0ZUFyb3VuZE9yaWdpbiA9IHN2Zy5jcmVhdGVTVkdUcmFuc2Zvcm0oKTsKICAgICAgICAgICAgdmFyIGFuZ2xlID0gZy5wb2ludChwb3NpdGlvbikuY2hhbmdlSW5BbmdsZShwb3NpdGlvbi54IC0gcmVmZXJlbmNlLngsIHBvc2l0aW9uLnkgLSByZWZlcmVuY2UueSwgcmVmZXJlbmNlKTsKICAgICAgICAgICAgcm90YXRlQXJvdW5kT3JpZ2luLnNldFJvdGF0ZShhbmdsZSwgMCwgMCk7CgogICAgICAgICAgICAvLyAzLiBUcmFuc2xhdGUgdG8gdGhlIGBwb3NpdGlvbmAgKyB0aGUgb2Zmc2V0IChoYWxmIG15IHdpZHRoKSB0b3dhcmRzIHRoZSBgcmVmZXJlbmNlYCBwb2ludC4KICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZUZpbmFsID0gc3ZnLmNyZWF0ZVNWR1RyYW5zZm9ybSgpOwogICAgICAgICAgICB2YXIgZmluYWxQb3NpdGlvbiA9IGcucG9pbnQocG9zaXRpb24pLm1vdmUocmVmZXJlbmNlLCBiYm94LndpZHRoLzIpOwogICAgICAgICAgICB0cmFuc2xhdGVGaW5hbC5zZXRUcmFuc2xhdGUocG9zaXRpb24ueCArIChwb3NpdGlvbi54IC0gZmluYWxQb3NpdGlvbi54KSwgcG9zaXRpb24ueSArIChwb3NpdGlvbi55IC0gZmluYWxQb3NpdGlvbi55KSk7CgogICAgICAgICAgICAvLyA0LiBBcHBseSB0cmFuc2Zvcm1hdGlvbnMuCiAgICAgICAgICAgIHZhciBjdG0gPSB0aGlzLm5vZGUuZ2V0VHJhbnNmb3JtVG9FbGVtZW50KHRhcmdldCk7CiAgICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSBzdmcuY3JlYXRlU1ZHVHJhbnNmb3JtKCk7CiAgICAgICAgICAgIHRyYW5zZm9ybS5zZXRNYXRyaXgoCiAgICAgICAgICAgICAgICB0cmFuc2xhdGVGaW5hbC5tYXRyaXgubXVsdGlwbHkoCiAgICAgICAgICAgICAgICAgICAgcm90YXRlQXJvdW5kT3JpZ2luLm1hdHJpeC5tdWx0aXBseSgKICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlVG9PcmlnaW4ubWF0cml4Lm11bHRpcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3RtKSkpCiAgICAgICAgICAgICk7CgogICAgICAgICAgICAvLyBJbnN0ZWFkIG9mIGRpcmVjdGx5IHNldHRpbmcgdGhlIGBtYXRyaXgoKWAgdHJhbnNmb3JtIG9uIHRoZSBlbGVtZW50LCBmaXJzdCwgZGVjb21wb3NlCiAgICAgICAgICAgIC8vIHRoZSBtYXRyaXggaW50byBzZXBhcmF0ZSB0cmFuc2Zvcm1zLiBUaGlzIGFsbG93cyB1cyB0byB1c2Ugbm9ybWFsIFZlY3Rvcml6ZXIgbWV0aG9kcwogICAgICAgICAgICAvLyBhcyB0aGV5IGRvbid0IHdvcmsgb24gbWF0cmljZXMuIEFuIGV4YW1wbGUgb2YgdGhpcyBpcyB0byByZXRyaWV2ZSBhIHNjYWxlIG9mIGFuIGVsZW1lbnQuCiAgICAgICAgICAgIC8vIHRoaXMubm9kZS50cmFuc2Zvcm0uYmFzZVZhbC5pbml0aWFsaXplKHRyYW5zZm9ybSk7CgogICAgICAgICAgICB2YXIgZGVjb21wb3NpdGlvbiA9IGRlY29tcG9zZU1hdHJpeCh0cmFuc2Zvcm0ubWF0cml4KTsKCiAgICAgICAgICAgIHRoaXMudHJhbnNsYXRlKGRlY29tcG9zaXRpb24udHJhbnNsYXRlWCwgZGVjb21wb3NpdGlvbi50cmFuc2xhdGVZKTsKICAgICAgICAgICAgdGhpcy5yb3RhdGUoZGVjb21wb3NpdGlvbi5yb3RhdGlvbik7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBzY2FsZSBoYXMgYmVlbiBhbHJlYWR5IGFwcGxpZWQsIGhlbmNlIHRoZSBmb2xsb3dpbmcgbGluZSBzdGF5cyBjb21tZW50ZWQuIChpdCdzIGhlcmUganVzdCBmb3IgcmVmZXJlbmNlKS4KICAgICAgICAgICAgLy90aGlzLnNjYWxlKGRlY29tcG9zaXRpb24uc2NhbGVYLCBkZWNvbXBvc2l0aW9uLnNjYWxlWSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICBhbmltYXRlQWxvbmdQYXRoOiBmdW5jdGlvbihhdHRycywgcGF0aCkgewoKICAgICAgICAgICAgdmFyIGFuaW1hdGVNb3Rpb24gPSBWKCdhbmltYXRlTW90aW9uJywgYXR0cnMpOwogICAgICAgICAgICB2YXIgbXBhdGggPSBWKCdtcGF0aCcsIHsgJ3hsaW5rOmhyZWYnOiAnIycgKyBWKHBhdGgpLm5vZGUuaWQgfSk7CgogICAgICAgICAgICBhbmltYXRlTW90aW9uLmFwcGVuZChtcGF0aCk7CgogICAgICAgICAgICB0aGlzLmFwcGVuZChhbmltYXRlTW90aW9uKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGFuaW1hdGVNb3Rpb24ubm9kZS5iZWdpbkVsZW1lbnQoKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgZm9yIElFIDkuCgkJLy8gUnVuIHRoZSBhbmltYXRpb24gcHJvZ3JhbWF0aWNhbGx5IGlmIEZha2VTbWlsZSAoYGh0dHA6Ly9sZXVuZW4ubWUvZmFrZXNtaWxlL2ApIHByZXNlbnQgCgkJaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3NtaWxpbmcnKSA9PT0gJ2Zha2UnKSB7CgoJCSAgICAvLyBSZWdpc3RlciB0aGUgYW5pbWF0aW9uLiAoU2VlIGBodHRwczovL2Fuc3dlcnMubGF1bmNocGFkLm5ldC9zbWlsLytxdWVzdGlvbi8yMDMzMzNgKQoJCSAgICB2YXIgYW5pbWF0aW9uID0gYW5pbWF0ZU1vdGlvbi5ub2RlOwoJCSAgICBhbmltYXRpb24uYW5pbWF0b3JzID0gW107CgoJCSAgICB2YXIgYW5pbWF0aW9uSUQgPSBhbmltYXRpb24uZ2V0QXR0cmlidXRlKCdpZCcpOwoJCSAgICBpZiAoYW5pbWF0aW9uSUQpIGlkMmFuaW1bYW5pbWF0aW9uSURdID0gYW5pbWF0aW9uOwoKICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0cyA9IGdldFRhcmdldHMoYW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGFyZ2V0cy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gdGFyZ2V0c1tpXTsKCQkJdmFyIGFuaW1hdG9yID0gbmV3IEFuaW1hdG9yKGFuaW1hdGlvbiwgdGFyZ2V0LCBpKTsKCQkJYW5pbWF0b3JzLnB1c2goYW5pbWF0b3IpOwoJCQlhbmltYXRpb24uYW5pbWF0b3JzW2ldID0gYW5pbWF0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdG9yLnJlZ2lzdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgfQoJCX0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIGhhc0NsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpIHsKCiAgICAgICAgICAgIHJldHVybiBuZXcgUmVnRXhwKCcoXFxzfF4pJyArIGNsYXNzTmFtZSArICcoXFxzfCQpJykudGVzdCh0aGlzLm5vZGUuZ2V0QXR0cmlidXRlKCdjbGFzcycpKTsKICAgICAgICB9LAoKICAgICAgICBhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgogICAgICAgICAgICBpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIHByZXZDbGFzc2VzID0gdGhpcy5ub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJzsKICAgICAgICAgICAgICAgIHRoaXMubm9kZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKHByZXZDbGFzc2VzICsgJyAnICsgY2xhc3NOYW1lKS50cmltKCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKSB7CgogICAgICAgICAgICBpZiAodGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3Q2xhc3NlcyA9IHRoaXMubm9kZS5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykucmVwbGFjZShuZXcgUmVnRXhwKCcoXFxzfF4pJyArIGNsYXNzTmFtZSArICcoXFxzfCQpJywgJ2cnKSwgJyQyJyk7CiAgICAgICAgICAgICAgICB0aGlzLm5vZGUuc2V0QXR0cmlidXRlKCdjbGFzcycsIG5ld0NsYXNzZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAoKICAgICAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lLCB0b0FkZCkgewoKICAgICAgICAgICAgdmFyIHRvUmVtb3ZlID0gdHlwZW9mIHRvQWRkID09PSAndW5kZWZpbmVkJyA/IHRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSA6ICF0b0FkZDsKCiAgICAgICAgICAgIGlmICh0b1JlbW92ZSkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIENvbnZlcnQgYSByZWN0YW5nbGUgdG8gU1ZHIHBhdGggY29tbWFuZHMuIGByYCBpcyBhbiBvYmplY3Qgb2YgdGhlIGZvcm06CiAgICAvLyBgeyB4OiBbbnVtYmVyXSwgeTogW251bWJlcl0sIHdpZHRoOiBbbnVtYmVyXSwgaGVpZ2h0OiBbbnVtYmVyXSwgdG9wLXJ5OiBbbnVtYmVyXSwgdG9wLXJ5OiBbbnVtYmVyXSwgYm90dG9tLXJ4OiBbbnVtYmVyXSwgYm90dG9tLXJ5OiBbbnVtYmVyXSB9YCwKICAgIC8vIHdoZXJlIGB4LCB5LCB3aWR0aCwgaGVpZ2h0YCBhcmUgdGhlIHVzdWFsIHJlY3RhbmdsZSBhdHRyaWJ1dGVzIGFuZCBbdG9wLS9ib3R0b20tXXJ4L3J5IGFsbG93cyBmb3IKICAgIC8vIHNwZWNpZnlpbmcgcmFkaXVzIG9mIHRoZSByZWN0YW5nbGUgZm9yIGFsbCBpdHMgc2lkZXMgKGFzIG9wcG9zZWQgdG8gdGhlIGJ1aWx0LWluIFNWRyByZWN0YW5nbGUKICAgIC8vIHRoYXQgaGFzIG9ubHkgYHJ4YCBhbmQgYHJ5YCBhdHRyaWJ1dGVzKS4KICAgIGZ1bmN0aW9uIHJlY3RUb1BhdGgocikgewoKICAgICAgICB2YXIgdG9wUnggPSByLnJ4IHx8IHJbJ3RvcC1yeCddIHx8IDA7CiAgICAgICAgdmFyIGJvdHRvbVJ4ID0gci5yeCB8fCByWydib3R0b20tcngnXSB8fCAwOwogICAgICAgIHZhciB0b3BSeSA9IHIucnkgfHwgclsndG9wLXJ5J10gfHwgMDsKICAgICAgICB2YXIgYm90dG9tUnkgPSByLnJ5IHx8IHJbJ2JvdHRvbS1yeSddIHx8IDA7CgogICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICdNJywgci54LCByLnkgKyB0b3BSeSwKICAgICAgICAgICAgJ3YnLCByLmhlaWdodCAtIHRvcFJ5IC0gYm90dG9tUnksCiAgICAgICAgICAgICdhJywgYm90dG9tUngsIGJvdHRvbVJ5LCAwLCAwLCAwLCBib3R0b21SeCwgYm90dG9tUnksCiAgICAgICAgICAgICdoJywgci53aWR0aCAtIDIgKiBib3R0b21SeCwKICAgICAgICAgICAgJ2EnLCBib3R0b21SeCwgYm90dG9tUnksIDAsIDAsIDAsIGJvdHRvbVJ4LCAtYm90dG9tUnksCiAgICAgICAgICAgICd2JywgLShyLmhlaWdodCAtIGJvdHRvbVJ5IC0gdG9wUnkpLAogICAgICAgICAgICAnYScsIHRvcFJ4LCB0b3BSeSwgMCwgMCwgMCwgLXRvcFJ4LCAtdG9wUnksCiAgICAgICAgICAgICdoJywgLShyLndpZHRoIC0gMiAqIHRvcFJ4KSwKICAgICAgICAgICAgJ2EnLCB0b3BSeCwgdG9wUnksIDAsIDAsIDAsIC10b3BSeCwgdG9wUnkKICAgICAgICBdLmpvaW4oJyAnKTsKICAgIH0KCiAgICB2YXIgViA9IGNyZWF0ZUVsZW1lbnQ7CgogICAgVi5kZWNvbXBvc2VNYXRyaXggPSBkZWNvbXBvc2VNYXRyaXg7CiAgICBWLnJlY3RUb1BhdGggPSByZWN0VG9QYXRoOwoKICAgIHZhciBzdmdEb2N1bWVudCA9IFYoJ3N2ZycpLm5vZGU7CiAgICAKICAgIFYuY3JlYXRlU1ZHTWF0cml4ID0gZnVuY3Rpb24obSkgewoKICAgICAgICB2YXIgc3ZnTWF0cml4ID0gc3ZnRG9jdW1lbnQuY3JlYXRlU1ZHTWF0cml4KCk7CiAgICAgICAgZm9yICh2YXIgY29tcG9uZW50IGluIG0pIHsKICAgICAgICAgICAgc3ZnTWF0cml4W2NvbXBvbmVudF0gPSBtW2NvbXBvbmVudF07CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBzdmdNYXRyaXg7CiAgICB9OwoKICAgIFYuY3JlYXRlU1ZHVHJhbnNmb3JtID0gZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiBzdmdEb2N1bWVudC5jcmVhdGVTVkdUcmFuc2Zvcm0oKTsKICAgIH07CgogICAgVi5jcmVhdGVTVkdQb2ludCA9IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgdmFyIHAgPSBzdmdEb2N1bWVudC5jcmVhdGVTVkdQb2ludCgpOwogICAgICAgIHAueCA9IHg7CiAgICAgICAgcC55ID0geTsKICAgICAgICByZXR1cm4gcDsKICAgIH07CgogICAgcmV0dXJuIFY7Cgp9KSk7CgoKLy8gICAgICBHZW9tZXRyeSBsaWJyYXJ5LgovLyAgICAgIChjKSAyMDExLTIwMTMgY2xpZW50IElPCgoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgogICAgICAgIGRlZmluZShbXSwgZmFjdG9yeSk7CiAgICAgICAgCiAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewogICAgICAgIC8vIE5vZGUuIERvZXMgbm90IHdvcmsgd2l0aCBzdHJpY3QgQ29tbW9uSlMsIGJ1dAogICAgICAgIC8vIG9ubHkgQ29tbW9uSlMtbGlrZSBlbnZpcm9ubWVudHMgdGhhdCBzdXBwb3J0IG1vZHVsZS5leHBvcnRzLAogICAgICAgIC8vIGxpa2UgTm9kZS4KICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKICAgICAgICAKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQnJvd3NlciBnbG9iYWxzLgogICAgICAgIHJvb3QuZyA9IGZhY3RvcnkoKTsKICAgIH0KCn0odGhpcywgZnVuY3Rpb24oKSB7CgoKICAgIC8vIERlY2xhcmUgc2hvcnRoYW5kcyB0byB0aGUgbW9zdCB1c2VkIG1hdGggZnVuY3Rpb25zLgogICAgdmFyIG1hdGggPSBNYXRoOwogICAgdmFyIGFicyA9IG1hdGguYWJzOwogICAgdmFyIGNvcyA9IG1hdGguY29zOwogICAgdmFyIHNpbiA9IG1hdGguc2luOwogICAgdmFyIHNxcnQgPSBtYXRoLnNxcnQ7CiAgICB2YXIgbW1pbiA9IG1hdGgubWluOwogICAgdmFyIG1tYXggPSBtYXRoLm1heDsKICAgIHZhciBhdGFuID0gbWF0aC5hdGFuOwogICAgdmFyIGF0YW4yID0gbWF0aC5hdGFuMjsKICAgIHZhciBhY29zID0gbWF0aC5hY29zOwogICAgdmFyIHJvdW5kID0gbWF0aC5yb3VuZDsKICAgIHZhciBmbG9vciA9IG1hdGguZmxvb3I7CiAgICB2YXIgUEkgPSBtYXRoLlBJOwogICAgdmFyIHJhbmRvbSA9IG1hdGgucmFuZG9tOwogICAgdmFyIHRvRGVnID0gZnVuY3Rpb24ocmFkKSB7IHJldHVybiAoMTgwKnJhZCAvIFBJKSAlIDM2MDsgfTsKICAgIHZhciB0b1JhZCA9IGZ1bmN0aW9uKGRlZykgeyByZXR1cm4gKGRlZyAlIDM2MCkgKiBQSSAvIDE4MDsgfTsKICAgIHZhciBzbmFwVG9HcmlkID0gZnVuY3Rpb24odmFsLCBncmlkU2l6ZSkgeyByZXR1cm4gZ3JpZFNpemUgKiBNYXRoLnJvdW5kKHZhbC9ncmlkU2l6ZSk7IH07CiAgICB2YXIgbm9ybWFsaXplQW5nbGUgPSBmdW5jdGlvbihhbmdsZSkgeyByZXR1cm4gKGFuZ2xlICUgMzYwKSArIChhbmdsZSA8IDAgPyAzNjAgOiAwKTsgfTsKCiAgICAvLyBQb2ludAogICAgLy8gLS0tLS0KCiAgICAvLyBQb2ludCBpcyB0aGUgbW9zdCBiYXNpYyBvYmplY3QgY29uc2lzdGluZyBvZiB4L3kgY29vcmRpbmF0ZSwuCgogICAgLy8gUG9zc2libGUgaW5zdGFudGlhdGlvbnMgYXJlOgoKICAgIC8vICogYHBvaW50KDEwLCAyMClgCiAgICAvLyAqIGBuZXcgcG9pbnQoMTAsIDIwKWAKICAgIC8vICogYHBvaW50KCcxMCAyMCcpYAogICAgLy8gKiBgcG9pbnQocG9pbnQoMTAsIDIwKSlgCiAgICBmdW5jdGlvbiBwb2ludCh4LCB5KSB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIHBvaW50KSkKICAgICAgICAgICAgcmV0dXJuIG5ldyBwb2ludCh4LCB5KTsKICAgICAgICB2YXIgeHk7CiAgICAgICAgaWYgKHkgPT09IHVuZGVmaW5lZCAmJiBPYmplY3QoeCkgIT09IHgpIHsKICAgICAgICAgICAgeHkgPSB4LnNwbGl0KHguaW5kZXhPZignQCcpID09PSAtMSA/ICcgJyA6ICdAJyk7CiAgICAgICAgICAgIHRoaXMueCA9IHBhcnNlSW50KHh5WzBdLCAxMCk7CiAgICAgICAgICAgIHRoaXMueSA9IHBhcnNlSW50KHh5WzFdLCAxMCk7CiAgICAgICAgfSBlbHNlIGlmIChPYmplY3QoeCkgPT09IHgpIHsKICAgICAgICAgICAgdGhpcy54ID0geC54OwogICAgICAgICAgICB0aGlzLnkgPSB4Lnk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy54ID0geDsKICAgICAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB9CiAgICB9CgogICAgcG9pbnQucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMueCArICJAIiArIHRoaXMueTsKICAgICAgICB9LAogICAgICAgIC8vIElmIHBvaW50IGxpZXMgb3V0c2lkZSByZWN0YW5nbGUgYHJgLCByZXR1cm4gdGhlIG5lYXJlc3QgcG9pbnQgb24gdGhlIGJvdW5kYXJ5IG9mIHJlY3QgYHJgLAogICAgICAgIC8vIG90aGVyd2lzZSByZXR1cm4gcG9pbnQgaXRzZWxmLgogICAgICAgIC8vIChzZWUgU3F1ZWFrIFNtYWxsdGFsaywgUG9pbnQ+PmFkaGVyZVRvOikKICAgICAgICBhZGhlcmVUb1JlY3Q6IGZ1bmN0aW9uKHIpIHsKCSAgICBpZiAoci5jb250YWluc1BvaW50KHRoaXMpKXsKCSAgICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfQoJICAgIHRoaXMueCA9IG1taW4obW1heCh0aGlzLngsIHIueCksIHIueCArIHIud2lkdGgpOwoJICAgIHRoaXMueSA9IG1taW4obW1heCh0aGlzLnksIHIueSksIHIueSArIHIuaGVpZ2h0KTsKCSAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENvbXB1dGUgdGhlIGFuZ2xlIGJldHdlZW4gbWUgYW5kIGBwYCBhbmQgdGhlIHggYXhpcy4KICAgICAgICAvLyAoY2FydGVzaWFuLXRvLXBvbGFyIGNvb3JkaW5hdGVzIGNvbnZlcnNpb24pCiAgICAgICAgLy8gUmV0dXJuIHRoZXRhIGFuZ2xlIGluIGRlZ3JlZXMuCiAgICAgICAgdGhldGE6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwogICAgICAgICAgICAvLyBJbnZlcnQgdGhlIHktYXhpcy4KCSAgICB2YXIgeSA9IC0ocC55IC0gdGhpcy55KTsKCSAgICB2YXIgeCA9IHAueCAtIHRoaXMueDsKICAgICAgICAgICAgLy8gTWFrZXMgc3VyZSB0aGF0IHRoZSBjb21wYXJpc29uIHdpdGggemVybyB0YWtlcyByb3VuZGluZyBlcnJvcnMgaW50byBhY2NvdW50LgogICAgICAgICAgICB2YXIgUFJFQ0lTSU9OID0gMTA7CiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBgYXRhbjJgIGlzIG5vdCBkZWZpbmVkIGZvciBgeGAsIGB5YCBib3RoIGVxdWFsIHplcm8uCgkgICAgdmFyIHJhZCA9ICh5LnRvRml4ZWQoUFJFQ0lTSU9OKSA9PSAwICYmIHgudG9GaXhlZChQUkVDSVNJT04pID09IDApID8gMCA6IGF0YW4yKHksIHgpOyAKCiAgICAgICAgICAgIC8vIENvcnJlY3Rpb24gZm9yIElJSS4gYW5kIElWLiBxdWFkcmFudC4KCSAgICBpZiAocmFkIDwgMCkgeyAKCSAgICAgICAgcmFkID0gMipQSSArIHJhZDsKCSAgICB9CgkgICAgcmV0dXJuIDE4MCpyYWQgLyBQSTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgZGlzdGFuY2UgYmV0d2VlbiBtZSBhbmQgcG9pbnQgYHBgLgogICAgICAgIGRpc3RhbmNlOiBmdW5jdGlvbihwKSB7CgkgICAgcmV0dXJuIGxpbmUodGhpcywgcCkubGVuZ3RoKCk7CiAgICAgICAgfSwKICAgICAgICAvLyBSZXR1cm5zIGEgbWFuaGF0dGFuICh0YXhpLWNhYikgZGlzdGFuY2UgYmV0d2VlbiBtZSBhbmQgcG9pbnQgYHBgLgogICAgICAgIG1hbmhhdHRhbkRpc3RhbmNlOiBmdW5jdGlvbihwKSB7CiAgICAgICAgICAgIHJldHVybiBhYnMocC54IC0gdGhpcy54KSArIGFicyhwLnkgLSB0aGlzLnkpOwogICAgICAgIH0sCiAgICAgICAgLy8gT2Zmc2V0IG1lIGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50LgogICAgICAgIG9mZnNldDogZnVuY3Rpb24oZHgsIGR5KSB7CgkgICAgdGhpcy54ICs9IGR4IHx8IDA7CgkgICAgdGhpcy55ICs9IGR5IHx8IDA7CgkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBtYWduaXR1ZGU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gc3FydCgodGhpcy54KnRoaXMueCkgKyAodGhpcy55KnRoaXMueSkpIHx8IDAuMDE7CiAgICAgICAgfSwKICAgICAgICB1cGRhdGU6IGZ1bmN0aW9uKHgsIHkpIHsKICAgICAgICAgICAgdGhpcy54ID0geCB8fCAwOwogICAgICAgICAgICB0aGlzLnkgPSB5IHx8IDA7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgcm91bmQ6IGZ1bmN0aW9uKGRlY2ltYWxzKSB7CiAgICAgICAgICAgIHRoaXMueCA9IGRlY2ltYWxzID8gdGhpcy54LnRvRml4ZWQoZGVjaW1hbHMpIDogcm91bmQodGhpcy54KTsKICAgICAgICAgICAgdGhpcy55ID0gZGVjaW1hbHMgPyB0aGlzLnkudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLnkpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFNjYWxlIHRoZSBsaW5lIHNlZ21lbnQgYmV0d2VlbiAoMCwwKSBhbmQgbWUgdG8gaGF2ZSBhIGxlbmd0aCBvZiBsZW4uCiAgICAgICAgbm9ybWFsaXplOiBmdW5jdGlvbihsZW4pIHsKCSAgICB2YXIgcyA9IChsZW4gfHwgMSkgLyB0aGlzLm1hZ25pdHVkZSgpOwoJICAgIHRoaXMueCA9IHMgKiB0aGlzLng7CgkgICAgdGhpcy55ID0gcyAqIHRoaXMueTsKCSAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGRpZmZlcmVuY2U6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCAtIHAueCwgdGhpcy55IC0gcC55KTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybiB0aGUgYmVhcmluZyBiZXR3ZWVuIG1lIGFuZCBwb2ludCBgcGAuCiAgICAgICAgYmVhcmluZzogZnVuY3Rpb24ocCkgewogICAgICAgICAgICByZXR1cm4gbGluZSh0aGlzLCBwKS5iZWFyaW5nKCk7CiAgICAgICAgfSwgICAgICAgIAogICAgICAgIC8vIENvbnZlcnRzIHJlY3Rhbmd1bGFyIHRvIHBvbGFyIGNvb3JkaW5hdGVzLgogICAgICAgIC8vIEFuIG9yaWdpbiBjYW4gYmUgc3BlY2lmaWVkLCBvdGhlcndpc2UgaXQncyAwQDAuCiAgICAgICAgdG9Qb2xhcjogZnVuY3Rpb24obykgewogICAgICAgICAgICBvID0gKG8gJiYgcG9pbnQobykpIHx8IHBvaW50KDAsMCk7CiAgICAgICAgICAgIHZhciB4ID0gdGhpcy54OwogICAgICAgICAgICB2YXIgeSA9IHRoaXMueTsKICAgICAgICAgICAgdGhpcy54ID0gc3FydCgoeC1vLngpKih4LW8ueCkgKyAoeS1vLnkpKih5LW8ueSkpOyAgIC8vIHIKICAgICAgICAgICAgdGhpcy55ID0gdG9SYWQoby50aGV0YShwb2ludCh4LHkpKSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUm90YXRlIHBvaW50IGJ5IGFuZ2xlIGFyb3VuZCBvcmlnaW4gby4KICAgICAgICByb3RhdGU6IGZ1bmN0aW9uKG8sIGFuZ2xlKSB7CiAgICAgICAgICAgIGFuZ2xlID0gKGFuZ2xlICsgMzYwKSAlIDM2MDsKICAgICAgICAgICAgdGhpcy50b1BvbGFyKG8pOwogICAgICAgICAgICB0aGlzLnkgKz0gdG9SYWQoYW5nbGUpOwogICAgICAgICAgICB2YXIgcCA9IHBvaW50LmZyb21Qb2xhcih0aGlzLngsIHRoaXMueSwgbyk7CiAgICAgICAgICAgIHRoaXMueCA9IHAueDsKICAgICAgICAgICAgdGhpcy55ID0gcC55OwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIE1vdmUgcG9pbnQgb24gbGluZSBzdGFydGluZyBmcm9tIHJlZiBlbmRpbmcgYXQgbWUgYnkKICAgICAgICAvLyBkaXN0YW5jZSBkaXN0YW5jZS4KICAgICAgICBtb3ZlOiBmdW5jdGlvbihyZWYsIGRpc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciB0aGV0YSA9IHRvUmFkKHBvaW50KHJlZikudGhldGEodGhpcykpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQoY29zKHRoZXRhKSAqIGRpc3RhbmNlLCAtc2luKHRoZXRhKSAqIGRpc3RhbmNlKTsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgY2hhbmdlIGluIGFuZ2xlIGZyb20gbXkgcHJldmlvdXMgcG9zaXRpb24gKC1keCwgLWR5KSB0byBteSBuZXcgcG9zaXRpb24KICAgICAgICAvLyByZWxhdGl2ZSB0byByZWYgcG9pbnQuCiAgICAgICAgY2hhbmdlSW5BbmdsZTogZnVuY3Rpb24oZHgsIGR5LCByZWYpIHsKICAgICAgICAgICAgLy8gUmV2ZXJ0IHRoZSB0cmFuc2xhdGlvbiBhbmQgbWVhc3VyZSB0aGUgY2hhbmdlIGluIGFuZ2xlIGFyb3VuZCB4LWF4aXMuCiAgICAgICAgICAgIHJldHVybiBwb2ludCh0aGlzKS5vZmZzZXQoLWR4LCAtZHkpLnRoZXRhKHJlZikgLSB0aGlzLnRoZXRhKHJlZik7CiAgICAgICAgfSwKICAgICAgICBlcXVhbHM6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMueCA9PT0gcC54ICYmIHRoaXMueSA9PT0gcC55OwogICAgICAgIH0sCiAgICAgICAgc25hcFRvR3JpZDogZnVuY3Rpb24oZ3gsIGd5KSB7CiAgICAgICAgICAgIHRoaXMueCA9IHNuYXBUb0dyaWQodGhpcy54LCBneCkKICAgICAgICAgICAgdGhpcy55ID0gc25hcFRvR3JpZCh0aGlzLnksIGd5IHx8IGd4KQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFJldHVybnMgYSBwb2ludCB0aGF0IGlzIHRoZSByZWZsZWN0aW9uIG9mIG1lIHdpdGgKICAgICAgICAvLyB0aGUgY2VudGVyIG9mIGludmVyc2lvbiBpbiByZWYgcG9pbnQuCiAgICAgICAgcmVmbGVjdGlvbjogZnVuY3Rpb24ocmVmKSB7CiAgICAgICAgICAgIHJldHVybiBwb2ludChyZWYpLm1vdmUodGhpcywgdGhpcy5kaXN0YW5jZShyZWYpKTsKICAgICAgICB9CiAgICB9OwogICAgLy8gQWx0ZXJuYXRpdmUgY29uc3RydWN0b3IsIGZyb20gcG9sYXIgY29vcmRpbmF0ZXMuCiAgICAvLyBAcGFyYW0ge251bWJlcn0gciBEaXN0YW5jZS4KICAgIC8vIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSBBbmdsZSBpbiByYWRpYW5zLgogICAgLy8gQHBhcmFtIHtwb2ludH0gW29wdGlvbmFsXSBvIE9yaWdpbi4KICAgIHBvaW50LmZyb21Qb2xhciA9IGZ1bmN0aW9uKHIsIGFuZ2xlLCBvKSB7CiAgICAgICAgbyA9IChvICYmIHBvaW50KG8pKSB8fCBwb2ludCgwLDApOwogICAgICAgIHZhciB4ID0gYWJzKHIgKiBjb3MoYW5nbGUpKTsKICAgICAgICB2YXIgeSA9IGFicyhyICogc2luKGFuZ2xlKSk7CiAgICAgICAgdmFyIGRlZyA9IG5vcm1hbGl6ZUFuZ2xlKHRvRGVnKGFuZ2xlKSk7CgogICAgICAgIGlmIChkZWcgPCA5MCkgeSA9IC15OwogICAgICAgIGVsc2UgaWYgKGRlZyA8IDE4MCkgeyB4ID0gLXg7IHkgPSAteTsgfQogICAgICAgIGVsc2UgaWYgKGRlZyA8IDI3MCkgeCA9IC14OwogICAgICAgIAogICAgICAgIHJldHVybiBwb2ludChvLnggKyB4LCBvLnkgKyB5KTsKICAgIH07CgogICAgLy8gQ3JlYXRlIGEgcG9pbnQgd2l0aCByYW5kb20gY29vcmRpbmF0ZXMgdGhhdCBmYWxsIGludG8gdGhlIHJhbmdlIGBbeDEsIHgyXWAgYW5kIGBbeTEsIHkyXWAuCiAgICBwb2ludC5yYW5kb20gPSBmdW5jdGlvbih4MSwgeDIsIHkxLCB5MikgewogICAgICAgIHJldHVybiBwb2ludChmbG9vcihyYW5kb20oKSAqICh4MiAtIHgxICsgMSkgKyB4MSksIGZsb29yKHJhbmRvbSgpICogKHkyIC0geTEgKyAxKSArIHkxKSk7CiAgICB9OwoKICAgIC8vIExpbmUuCiAgICAvLyAtLS0tLQogICAgZnVuY3Rpb24gbGluZShwMSwgcDIpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgbGluZSkpCiAgICAgICAgICAgIHJldHVybiBuZXcgbGluZShwMSwgcDIpOwogICAgICAgIHRoaXMuc3RhcnQgPSBwb2ludChwMSk7CiAgICAgICAgdGhpcy5lbmQgPSBwb2ludChwMik7CiAgICB9CiAgICAKICAgIGxpbmUucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gdGhpcy5zdGFydC50b1N0cmluZygpICsgJyAnICsgdGhpcy5lbmQudG9TdHJpbmcoKTsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge2RvdWJsZX0gbGVuZ3RoIG9mIHRoZSBsaW5lCiAgICAgICAgbGVuZ3RoOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHNxcnQodGhpcy5zcXVhcmVkTGVuZ3RoKCkpOwogICAgICAgIH0sCiAgICAgICAgLy8gQHJldHVybiB7aW50ZWdlcn0gbGVuZ3RoIHdpdGhvdXQgc3FydAogICAgICAgIC8vIEBub3RlIGZvciBhcHBsaWNhdGlvbnMgd2hlcmUgdGhlIGV4YWN0IGxlbmd0aCBpcyBub3QgbmVjZXNzYXJ5IChlLmcuIGNvbXBhcmUgb25seSkKICAgICAgICBzcXVhcmVkTGVuZ3RoOiBmdW5jdGlvbigpIHsKCSAgICB2YXIgeDAgPSB0aGlzLnN0YXJ0Lng7CiAgICAgICAgICAgIHZhciB5MCA9IHRoaXMuc3RhcnQueTsKCSAgICB2YXIgeDEgPSB0aGlzLmVuZC54OwogICAgICAgICAgICB2YXIgeTEgPSB0aGlzLmVuZC55OwoJICAgIHJldHVybiAoeDAgLT0geDEpKngwICsgKHkwIC09IHkxKSp5MDsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge3BvaW50fSBteSBtaWRwb2ludAogICAgICAgIG1pZHBvaW50OiBmdW5jdGlvbigpIHsKCSAgICByZXR1cm4gcG9pbnQoKHRoaXMuc3RhcnQueCArIHRoaXMuZW5kLngpIC8gMiwKCQkgICAgICAgICAodGhpcy5zdGFydC55ICsgdGhpcy5lbmQueSkgLyAyKTsKICAgICAgICB9LAogICAgICAgIC8vIEByZXR1cm4ge3BvaW50fSBQb2ludCB3aGVyZSBJJ20gaW50ZXJzZWN0aW5nIGwuCiAgICAgICAgLy8gQHNlZSBTcXVlYWsgU21hbGx0YWxrLCBMaW5lU2VnbWVudD4+aW50ZXJzZWN0aW9uV2l0aDoKICAgICAgICBpbnRlcnNlY3Rpb246IGZ1bmN0aW9uKGwpIHsKCSAgICB2YXIgcHQxRGlyID0gcG9pbnQodGhpcy5lbmQueCAtIHRoaXMuc3RhcnQueCwgdGhpcy5lbmQueSAtIHRoaXMuc3RhcnQueSk7CgkgICAgdmFyIHB0MkRpciA9IHBvaW50KGwuZW5kLnggLSBsLnN0YXJ0LngsIGwuZW5kLnkgLSBsLnN0YXJ0LnkpOwoJICAgIHZhciBkZXQgPSAocHQxRGlyLnggKiBwdDJEaXIueSkgLSAocHQxRGlyLnkgKiBwdDJEaXIueCk7CgkgICAgdmFyIGRlbHRhUHQgPSBwb2ludChsLnN0YXJ0LnggLSB0aGlzLnN0YXJ0LngsIGwuc3RhcnQueSAtIHRoaXMuc3RhcnQueSk7CgkgICAgdmFyIGFscGhhID0gKGRlbHRhUHQueCAqIHB0MkRpci55KSAtIChkZWx0YVB0LnkgKiBwdDJEaXIueCk7CgkgICAgdmFyIGJldGEgPSAoZGVsdGFQdC54ICogcHQxRGlyLnkpIC0gKGRlbHRhUHQueSAqIHB0MURpci54KTsKCgkgICAgaWYgKGRldCA9PT0gMCB8fAoJICAgICAgICBhbHBoYSAqIGRldCA8IDAgfHwKCSAgICAgICAgYmV0YSAqIGRldCA8IDApIHsKICAgICAgICAgICAgICAgIC8vIE5vIGludGVyc2VjdGlvbiBmb3VuZC4KCSAgICAgICAgcmV0dXJuIG51bGw7CQoJICAgIH0KCSAgICBpZiAoZGV0ID4gMCl7CgkgICAgICAgIGlmIChhbHBoYSA+IGRldCB8fCBiZXRhID4gZGV0KXsKCQkgICAgcmV0dXJuIG51bGw7CgkgICAgICAgIH0KCSAgICB9IGVsc2UgewoJICAgICAgICBpZiAoYWxwaGEgPCBkZXQgfHwgYmV0YSA8IGRldCl7CgkJICAgIHJldHVybiBudWxsOwoJICAgICAgICB9CgkgICAgfQoJICAgIHJldHVybiBwb2ludCh0aGlzLnN0YXJ0LnggKyAoYWxwaGEgKiBwdDFEaXIueCAvIGRldCksCgkJICAgICAgICAgdGhpcy5zdGFydC55ICsgKGFscGhhICogcHQxRGlyLnkgLyBkZXQpKTsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8vIEByZXR1cm4gdGhlIGJlYXJpbmcgKGNhcmRpbmFsIGRpcmVjdGlvbikgb2YgdGhlIGxpbmUuIEZvciBleGFtcGxlIE4sIFcsIG9yIFNFLgogICAgICAgIC8vIEByZXR1cm5zIHtTdHJpbmd9IE9uZSBvZiB0aGUgZm9sbG93aW5nIGJlYXJpbmdzIDogTkUsIEUsIFNFLCBTLCBTVywgVywgTlcsIE4uCiAgICAgICAgYmVhcmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgbGF0MSA9IHRvUmFkKHRoaXMuc3RhcnQueSk7CiAgICAgICAgICAgIHZhciBsYXQyID0gdG9SYWQodGhpcy5lbmQueSk7CiAgICAgICAgICAgIHZhciBsb24xID0gdGhpcy5zdGFydC54OwogICAgICAgICAgICB2YXIgbG9uMiA9IHRoaXMuZW5kLng7CiAgICAgICAgICAgIHZhciBkTG9uID0gdG9SYWQobG9uMiAtIGxvbjEpOwogICAgICAgICAgICB2YXIgeSA9IHNpbihkTG9uKSAqIGNvcyhsYXQyKTsKICAgICAgICAgICAgdmFyIHggPSBjb3MobGF0MSkgKiBzaW4obGF0MikgLSBzaW4obGF0MSkgKiBjb3MobGF0MikgKiBjb3MoZExvbik7CiAgICAgICAgICAgIHZhciBicm5nID0gdG9EZWcoYXRhbjIoeSwgeCkpOwoKICAgICAgICAgICAgdmFyIGJlYXJpbmdzID0gWydORScsICdFJywgJ1NFJywgJ1MnLCAnU1cnLCAnVycsICdOVycsICdOJ107CgogICAgICAgICAgICB2YXIgaW5kZXggPSBicm5nIC0gMjIuNTsKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkKICAgICAgICAgICAgICAgIGluZGV4ICs9IDM2MDsKICAgICAgICAgICAgaW5kZXggPSBwYXJzZUludChpbmRleCAvIDQ1KTsKCiAgICAgICAgICAgIHJldHVybiBiZWFyaW5nc1tpbmRleF07CiAgICAgICAgfSwKCiAgICAgICAgLy8gQHJldHVybiB7cG9pbnR9IG15IHBvaW50IGF0ICd0JyA8MCwxPgogICAgICAgIHBvaW50QXQ6IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgdmFyIHggPSAoMSAtIHQpICogdGhpcy5zdGFydC54ICsgdCAqIHRoaXMuZW5kLng7CiAgICAgICAgICAgIHZhciB5ID0gKDEgLSB0KSAqIHRoaXMuc3RhcnQueSArIHQgKiB0aGlzLmVuZC55OwogICAgICAgICAgICByZXR1cm4gcG9pbnQoeCwgeSk7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBSZWN0YW5nbGUuCiAgICAvLyAtLS0tLS0tLS0tCiAgICBmdW5jdGlvbiByZWN0KHgsIHksIHcsIGgpIHsKICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgcmVjdCkpCiAgICAgICAgICAgIHJldHVybiBuZXcgcmVjdCh4LCB5LCB3LCBoKTsKICAgICAgICBpZiAoeSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHkgPSB4Lnk7CiAgICAgICAgICAgIHcgPSB4LndpZHRoOwogICAgICAgICAgICBoID0geC5oZWlnaHQ7CiAgICAgICAgICAgIHggPSB4Lng7ICAgICAgICAKICAgICAgICB9CiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHRoaXMud2lkdGggPSB3OwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaDsKICAgIH0KICAgIAogICAgcmVjdC5wcm90b3R5cGUgPSB7CiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewoJICAgIHJldHVybiB0aGlzLm9yaWdpbigpLnRvU3RyaW5nKCkgKyAnICcgKyB0aGlzLmNvcm5lcigpLnRvU3RyaW5nKCk7CiAgICAgICAgfSwKICAgICAgICBvcmlnaW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gcG9pbnQodGhpcy54LCB0aGlzLnkpOwogICAgICAgIH0sCiAgICAgICAgY29ybmVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHRoaXMueSArIHRoaXMuaGVpZ2h0KTsKICAgICAgICB9LAogICAgICAgIHRvcFJpZ2h0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHRoaXMueSk7CiAgICAgICAgfSwKICAgICAgICBib3R0b21MZWZ0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCwgdGhpcy55ICsgdGhpcy5oZWlnaHQpOwogICAgICAgIH0sCiAgICAgICAgY2VudGVyOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgvMiwgdGhpcy55ICsgdGhpcy5oZWlnaHQvMik7CiAgICAgICAgfSwKICAgICAgICAvLyBAcmV0dXJuIHtib29sZWFufSB0cnVlIGlmIHJlY3RhbmdsZXMgaW50ZXJzZWN0CiAgICAgICAgaW50ZXJzZWN0OiBmdW5jdGlvbihyKSB7CgkgICAgdmFyIG15T3JpZ2luID0gdGhpcy5vcmlnaW4oKTsKCSAgICB2YXIgbXlDb3JuZXIgPSB0aGlzLmNvcm5lcigpOwoJICAgIHZhciByT3JpZ2luID0gci5vcmlnaW4oKTsKCSAgICB2YXIgckNvcm5lciA9IHIuY29ybmVyKCk7CiAgICAgICAgICAgIAoJICAgIGlmIChyQ29ybmVyLnggPD0gbXlPcmlnaW4ueCB8fAoJICAgICAgICByQ29ybmVyLnkgPD0gbXlPcmlnaW4ueSB8fAoJICAgICAgICByT3JpZ2luLnggPj0gbXlDb3JuZXIueCB8fAoJICAgICAgICByT3JpZ2luLnkgPj0gbXlDb3JuZXIueSkgcmV0dXJuIGZhbHNlOwoJICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgLy8gQHJldHVybiB7c3RyaW5nfSAobGVmdHxyaWdodHx0b3B8Ym90dG9tKSBzaWRlIHdoaWNoIGlzIG5lYXJlc3QgdG8gcG9pbnQKICAgICAgICAvLyBAc2VlIFNxdWVhayBTbWFsbHRhbGssIFJlY3RhbmdsZT4+c2lkZU5lYXJlc3RUbzoKICAgICAgICBzaWRlTmVhcmVzdFRvUG9pbnQ6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwoJICAgIHZhciBkaXN0VG9MZWZ0ID0gcC54IC0gdGhpcy54OwoJICAgIHZhciBkaXN0VG9SaWdodCA9ICh0aGlzLnggKyB0aGlzLndpZHRoKSAtIHAueDsKCSAgICB2YXIgZGlzdFRvVG9wID0gcC55IC0gdGhpcy55OwoJICAgIHZhciBkaXN0VG9Cb3R0b20gPSAodGhpcy55ICsgdGhpcy5oZWlnaHQpIC0gcC55OwoJICAgIHZhciBjbG9zZXN0ID0gZGlzdFRvTGVmdDsKCSAgICB2YXIgc2lkZSA9ICdsZWZ0JzsKICAgICAgICAgICAgCgkgICAgaWYgKGRpc3RUb1JpZ2h0IDwgY2xvc2VzdCkgewoJICAgICAgICBjbG9zZXN0ID0gZGlzdFRvUmlnaHQ7CgkgICAgICAgIHNpZGUgPSAncmlnaHQnOwoJICAgIH0KCSAgICBpZiAoZGlzdFRvVG9wIDwgY2xvc2VzdCkgewoJICAgICAgICBjbG9zZXN0ID0gZGlzdFRvVG9wOwoJICAgICAgICBzaWRlID0gJ3RvcCc7CgkgICAgfQoJICAgIGlmIChkaXN0VG9Cb3R0b20gPCBjbG9zZXN0KSB7CgkgICAgICAgIGNsb3Nlc3QgPSBkaXN0VG9Cb3R0b207CgkgICAgICAgIHNpZGUgPSAnYm90dG9tJzsKCSAgICB9CgkgICAgcmV0dXJuIHNpZGU7CiAgICAgICAgfSwKICAgICAgICAvLyBAcmV0dXJuIHtib29sfSB0cnVlIGlmIHBvaW50IHAgaXMgaW5zaWdodCBtZQogICAgICAgIGNvbnRhaW5zUG9pbnQ6IGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgcCA9IHBvaW50KHApOwoJICAgIGlmIChwLnggPj0gdGhpcy54ICYmIHAueCA8PSB0aGlzLnggKyB0aGlzLndpZHRoICYmCgkgICAgICAgIHAueSA+PSB0aGlzLnkgJiYgcC55IDw9IHRoaXMueSArIHRoaXMuaGVpZ2h0KSB7CgkgICAgICAgIHJldHVybiB0cnVlOwoJICAgIH0KCSAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwKICAgICAgICAvLyBBbGdvcml0aG0gcG9ydGVkIGZyb20gamF2YS5hd3QuUmVjdGFuZ2xlIGZyb20gT3BlbkpESy4KICAgICAgICAvLyBAcmV0dXJuIHtib29sfSB0cnVlIGlmIHJlY3RhbmdsZSBgcmAgaXMgaW5zaWRlIG1lLgogICAgICAgIGNvbnRhaW5zUmVjdDogZnVuY3Rpb24ocikgewogICAgICAgICAgICB2YXIgbnIgPSByZWN0KHIpLm5vcm1hbGl6ZSgpOwogICAgICAgICAgICB2YXIgVyA9IG5yLndpZHRoOwogICAgICAgICAgICB2YXIgSCA9IG5yLmhlaWdodDsKICAgICAgICAgICAgdmFyIFggPSBuci54OwogICAgICAgICAgICB2YXIgWSA9IG5yLnk7CiAgICAgICAgICAgIHZhciB3ID0gdGhpcy53aWR0aDsKICAgICAgICAgICAgdmFyIGggPSB0aGlzLmhlaWdodDsKICAgICAgICAgICAgaWYgKCh3IHwgaCB8IFcgfCBIKSA8IDApIHsKICAgICAgICAgICAgICAgIC8vIEF0IGxlYXN0IG9uZSBvZiB0aGUgZGltZW5zaW9ucyBpcyBuZWdhdGl2ZS4uLgogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIE5vdGU6IGlmIGFueSBkaW1lbnNpb24gaXMgemVybywgdGVzdHMgYmVsb3cgbXVzdCByZXR1cm4gZmFsc2UuLi4KICAgICAgICAgICAgdmFyIHggPSB0aGlzLng7CiAgICAgICAgICAgIHZhciB5ID0gdGhpcy55OwogICAgICAgICAgICBpZiAoWCA8IHggfHwgWSA8IHkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3ICs9IHg7CiAgICAgICAgICAgIFcgKz0gWDsKICAgICAgICAgICAgaWYgKFcgPD0gWCkgewogICAgICAgICAgICAgICAgLy8gWCtXIG92ZXJmbG93ZWQgb3IgVyB3YXMgemVybywgcmV0dXJuIGZhbHNlIGlmLi4uCiAgICAgICAgICAgICAgICAvLyBlaXRoZXIgb3JpZ2luYWwgdyBvciBXIHdhcyB6ZXJvIG9yCiAgICAgICAgICAgICAgICAvLyB4K3cgZGlkIG5vdCBvdmVyZmxvdyBvcgogICAgICAgICAgICAgICAgLy8gdGhlIG92ZXJmbG93ZWQgeCt3IGlzIHNtYWxsZXIgdGhhbiB0aGUgb3ZlcmZsb3dlZCBYK1cKICAgICAgICAgICAgICAgIGlmICh3ID49IHggfHwgVyA+IHcpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFgrVyBkaWQgbm90IG92ZXJmbG93IGFuZCBXIHdhcyBub3QgemVybywgcmV0dXJuIGZhbHNlIGlmLi4uCiAgICAgICAgICAgICAgICAvLyBvcmlnaW5hbCB3IHdhcyB6ZXJvIG9yCiAgICAgICAgICAgICAgICAvLyB4K3cgZGlkIG5vdCBvdmVyZmxvdyBhbmQgeCt3IGlzIHNtYWxsZXIgdGhhbiBYK1cKICAgICAgICAgICAgICAgIGlmICh3ID49IHggJiYgVyA+IHcpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBoICs9IHk7CiAgICAgICAgICAgIEggKz0gWTsKICAgICAgICAgICAgaWYgKEggPD0gWSkgewogICAgICAgICAgICAgICAgaWYgKGggPj0geSB8fCBIID4gaCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGggPj0geSAmJiBIID4gaCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sICAgICAgICAKICAgICAgICAvLyBAcmV0dXJuIHtwb2ludH0gYSBwb2ludCBvbiBteSBib3VuZGFyeSBuZWFyZXN0IHRvIHAKICAgICAgICAvLyBAc2VlIFNxdWVhayBTbWFsbHRhbGssIFJlY3RhbmdsZT4+cG9pbnROZWFyZXN0VG86CiAgICAgICAgcG9pbnROZWFyZXN0VG9Qb2ludDogZnVuY3Rpb24ocCkgewogICAgICAgICAgICBwID0gcG9pbnQocCk7CgkgICAgaWYgKHRoaXMuY29udGFpbnNQb2ludChwKSkgewoJICAgICAgICB2YXIgc2lkZSA9IHRoaXMuc2lkZU5lYXJlc3RUb1BvaW50KHApOwoJICAgICAgICBzd2l0Y2ggKHNpZGUpewoJICAgICAgICAgIGNhc2UgInJpZ2h0IjogcmV0dXJuIHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgsIHAueSk7CgkgICAgICAgICAgY2FzZSAibGVmdCI6IHJldHVybiBwb2ludCh0aGlzLngsIHAueSk7CgkgICAgICAgICAgY2FzZSAiYm90dG9tIjogcmV0dXJuIHBvaW50KHAueCwgdGhpcy55ICsgdGhpcy5oZWlnaHQpOwoJICAgICAgICAgIGNhc2UgInRvcCI6IHJldHVybiBwb2ludChwLngsIHRoaXMueSk7CgkgICAgICAgIH0KCSAgICB9CgkgICAgcmV0dXJuIHAuYWRoZXJlVG9SZWN0KHRoaXMpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBwb2ludCBvbiBteSBib3VuZGFyeSB3aGVyZSBsaW5lIHN0YXJ0aW5nCiAgICAgICAgLy8gZnJvbSBteSBjZW50ZXIgZW5kaW5nIGluIHBvaW50IHAgaW50ZXJzZWN0cyBtZS4KICAgICAgICAvLyBAcGFyYW0ge251bWJlcn0gYW5nbGUgSWYgYW5nbGUgaXMgc3BlY2lmaWVkLCBpbnRlcnNlY3Rpb24gd2l0aCByb3RhdGVkIHJlY3RhbmdsZSBpcyBjb21wdXRlZC4KICAgICAgICBpbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50OiBmdW5jdGlvbihwLCBhbmdsZSkgewogICAgICAgICAgICBwID0gcG9pbnQocCk7CgkgICAgdmFyIGNlbnRlciA9IHBvaW50KHRoaXMueCArIHRoaXMud2lkdGgvMiwgdGhpcy55ICsgdGhpcy5oZWlnaHQvMik7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIGlmIChhbmdsZSkgcC5yb3RhdGUoY2VudGVyLCBhbmdsZSk7CiAgICAgICAgICAgIAoJICAgIC8vIChjbG9ja3dpc2UsIHN0YXJ0aW5nIGZyb20gdGhlIHRvcCBzaWRlKQoJICAgIHZhciBzaWRlcyA9IFsKCSAgICAgICAgbGluZSh0aGlzLm9yaWdpbigpLCB0aGlzLnRvcFJpZ2h0KCkpLAoJICAgICAgICBsaW5lKHRoaXMudG9wUmlnaHQoKSwgdGhpcy5jb3JuZXIoKSksCgkgICAgICAgIGxpbmUodGhpcy5jb3JuZXIoKSwgdGhpcy5ib3R0b21MZWZ0KCkpLAoJICAgICAgICBsaW5lKHRoaXMuYm90dG9tTGVmdCgpLCB0aGlzLm9yaWdpbigpKQoJICAgIF07CgkgICAgdmFyIGNvbm5lY3RvciA9IGxpbmUoY2VudGVyLCBwKTsKICAgICAgICAgICAgCgkgICAgZm9yICh2YXIgaSA9IHNpZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKXsKCSAgICAgICAgdmFyIGludGVyc2VjdGlvbiA9IHNpZGVzW2ldLmludGVyc2VjdGlvbihjb25uZWN0b3IpOwoJICAgICAgICBpZiAoaW50ZXJzZWN0aW9uICE9PSBudWxsKXsKCQkgICAgcmVzdWx0ID0gaW50ZXJzZWN0aW9uOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgfQogICAgICAgICAgICBpZiAocmVzdWx0ICYmIGFuZ2xlKSByZXN1bHQucm90YXRlKGNlbnRlciwgLWFuZ2xlKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9LAogICAgICAgIC8vIE1vdmUgYW5kIGV4cGFuZCBtZS4KICAgICAgICAvLyBAcGFyYW0gciB7cmVjdGFuZ2xlfSByZXByZXNlbnRpbmcgZGVsdGFzCiAgICAgICAgbW92ZUFuZEV4cGFuZDogZnVuY3Rpb24ocikgewoJICAgIHRoaXMueCArPSByLng7CgkgICAgdGhpcy55ICs9IHIueTsKCSAgICB0aGlzLndpZHRoICs9IHIud2lkdGg7CgkgICAgdGhpcy5oZWlnaHQgKz0gci5oZWlnaHQ7CgkgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICByb3VuZDogZnVuY3Rpb24oZGVjaW1hbHMpIHsKICAgICAgICAgICAgdGhpcy54ID0gZGVjaW1hbHMgPyB0aGlzLngudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLngpOwogICAgICAgICAgICB0aGlzLnkgPSBkZWNpbWFscyA/IHRoaXMueS50b0ZpeGVkKGRlY2ltYWxzKSA6IHJvdW5kKHRoaXMueSk7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSBkZWNpbWFscyA/IHRoaXMud2lkdGgudG9GaXhlZChkZWNpbWFscykgOiByb3VuZCh0aGlzLndpZHRoKTsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSBkZWNpbWFscyA/IHRoaXMuaGVpZ2h0LnRvRml4ZWQoZGVjaW1hbHMpIDogcm91bmQodGhpcy5oZWlnaHQpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIE5vcm1hbGl6ZSB0aGUgcmVjdGFuZ2xlOyBpLmUuLCBtYWtlIGl0IHNvIHRoYXQgaXQgaGFzIGEgbm9uLW5lZ2F0aXZlIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAgICAgLy8gSWYgd2lkdGggPCAwIHRoZSBmdW5jdGlvbiBzd2FwcyB0aGUgbGVmdCBhbmQgcmlnaHQgY29ybmVycywKICAgICAgICAvLyBhbmQgaXQgc3dhcHMgdGhlIHRvcCBhbmQgYm90dG9tIGNvcm5lcnMgaWYgaGVpZ2h0IDwgMAogICAgICAgIC8vIGxpa2UgaW4gaHR0cDovL3F0LXByb2plY3Qub3JnL2RvYy9xdC00LjgvcXJlY3RmLmh0bWwjbm9ybWFsaXplZAogICAgICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBuZXd4ID0gdGhpcy54OwogICAgICAgICAgICB2YXIgbmV3eSA9IHRoaXMueTsKICAgICAgICAgICAgdmFyIG5ld3dpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICAgICAgdmFyIG5ld2hlaWdodCA9IHRoaXMuaGVpZ2h0OwogICAgICAgICAgICBpZiAodGhpcy53aWR0aCA8IDApIHsKICAgICAgICAgICAgICAgIG5ld3ggPSB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgICAgICAgICAgICAgbmV3d2lkdGggPSAtdGhpcy53aWR0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5oZWlnaHQgPCAwKSB7CiAgICAgICAgICAgICAgICBuZXd5ID0gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgICAgICBuZXdoZWlnaHQgPSAtdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy54ID0gbmV3eDsKICAgICAgICAgICAgdGhpcy55ID0gbmV3eTsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IG5ld3dpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IG5ld2hlaWdodDsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBGaW5kIG15IGJvdW5kaW5nIGJveCB3aGVuIEknbSByb3RhdGVkIHdpdGggdGhlIGNlbnRlciBvZiByb3RhdGlvbiBpbiB0aGUgY2VudGVyIG9mIG1lLgogICAgICAgIC8vIEByZXR1cm4gciB7cmVjdGFuZ2xlfSByZXByZXNlbnRpbmcgYSBib3VuZGluZyBib3gKICAgICAgICBiYm94OiBmdW5jdGlvbihhbmdsZSkgewogICAgICAgICAgICB2YXIgdGhldGEgPSB0b1JhZChhbmdsZSB8fCAwKTsKICAgICAgICAgICAgdmFyIHN0ID0gYWJzKHNpbih0aGV0YSkpOwogICAgICAgICAgICB2YXIgY3QgPSBhYnMoY29zKHRoZXRhKSk7CiAgICAgICAgICAgIHZhciB3ID0gdGhpcy53aWR0aCAqIGN0ICsgdGhpcy5oZWlnaHQgKiBzdDsKICAgICAgICAgICAgdmFyIGggPSB0aGlzLndpZHRoICogc3QgKyB0aGlzLmhlaWdodCAqIGN0OwogICAgICAgICAgICByZXR1cm4gcmVjdCh0aGlzLnggKyAodGhpcy53aWR0aCAtIHcpIC8gMiwgdGhpcy55ICsgKHRoaXMuaGVpZ2h0IC0gaCkgLyAyLCB3LCBoKTsKICAgICAgICB9CiAgICB9OwoKICAgIC8vIEVsbGlwc2UuCiAgICAvLyAtLS0tLS0tLQogICAgZnVuY3Rpb24gZWxsaXBzZShjLCBhLCBiKSB7CiAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGVsbGlwc2UpKQogICAgICAgICAgICByZXR1cm4gbmV3IGVsbGlwc2UoYywgYSwgYik7CiAgICAgICAgYyA9IHBvaW50KGMpOwogICAgICAgIHRoaXMueCA9IGMueDsKICAgICAgICB0aGlzLnkgPSBjLnk7CiAgICAgICAgdGhpcy5hID0gYTsKICAgICAgICB0aGlzLmIgPSBiOwogICAgfQoKICAgIGVsbGlwc2UucHJvdG90eXBlID0gewogICAgICAgIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHBvaW50KHRoaXMueCwgdGhpcy55KS50b1N0cmluZygpICsgJyAnICsgdGhpcy5hICsgJyAnICsgdGhpcy5iOwogICAgICAgIH0sCiAgICAgICAgYmJveDogZnVuY3Rpb24oKSB7CgkgICAgICAgIHJldHVybiByZWN0KHRoaXMueCAtIHRoaXMuYSwgdGhpcy55IC0gdGhpcy5iLCAyKnRoaXMuYSwgMip0aGlzLmIpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBwb2ludCBvbiBtZSB3aGVyZSBsaW5lIGZyb20gbXkgY2VudGVyIHRvCiAgICAgICAgLy8gcG9pbnQgcCBpbnRlcnNlY3RzIG15IGJvdW5kYXJ5LgogICAgICAgIC8vIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSBJZiBhbmdsZSBpcyBzcGVjaWZpZWQsIGludGVyc2VjdGlvbiB3aXRoIHJvdGF0ZWQgZWxsaXBzZSBpcyBjb21wdXRlZC4KICAgICAgICBpbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50OiBmdW5jdGlvbihwLCBhbmdsZSkgewoJICAgIHAgPSBwb2ludChwKTsKICAgICAgICAgICAgaWYgKGFuZ2xlKSBwLnJvdGF0ZShwb2ludCh0aGlzLngsIHRoaXMueSksIGFuZ2xlKTsKICAgICAgICAgICAgdmFyIGR4ID0gcC54IC0gdGhpcy54OwoJICAgIHZhciBkeSA9IHAueSAtIHRoaXMueTsKICAgICAgICAgICAgdmFyIHJlc3VsdDsKCSAgICBpZiAoZHggPT09IDApIHsKCSAgICAgICAgcmVzdWx0ID0gdGhpcy5iYm94KCkucG9pbnROZWFyZXN0VG9Qb2ludChwKTsKICAgICAgICAgICAgICAgIGlmIChhbmdsZSkgcmV0dXJuIHJlc3VsdC5yb3RhdGUocG9pbnQodGhpcy54LCB0aGlzLnkpLCAtYW5nbGUpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKCSAgICB9CgkgICAgdmFyIG0gPSBkeSAvIGR4OwoJICAgIHZhciBtU3F1YXJlZCA9IG0gKiBtOwoJICAgIHZhciBhU3F1YXJlZCA9IHRoaXMuYSAqIHRoaXMuYTsKCSAgICB2YXIgYlNxdWFyZWQgPSB0aGlzLmIgKiB0aGlzLmI7CgkgICAgdmFyIHggPSBzcXJ0KDEgLyAoKDEgLyBhU3F1YXJlZCkgKyAobVNxdWFyZWQgLyBiU3F1YXJlZCkpKTsKCiAgICAgICAgICAgIHggPSBkeCA8IDAgPyAteCA6IHg7CgkgICAgdmFyIHkgPSBtICogeDsKCSAgICByZXN1bHQgPSBwb2ludCh0aGlzLnggKyB4LCB0aGlzLnkgKyB5KTsKICAgICAgICAgICAgaWYgKGFuZ2xlKSByZXR1cm4gcmVzdWx0LnJvdGF0ZShwb2ludCh0aGlzLngsIHRoaXMueSksIC1hbmdsZSk7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBCZXppZXIgY3VydmUuCiAgICAvLyAtLS0tLS0tLS0tLS0tCiAgICB2YXIgYmV6aWVyID0gewogICAgICAgIC8vIEN1YmljIEJlemllciBjdXJ2ZSBwYXRoIHRocm91Z2ggcG9pbnRzLgogICAgICAgIC8vIFBvcnRlZCBmcm9tIEMjIGltcGxlbWVudGF0aW9uIGJ5IE9sZWcgVi4gUG9saWthcnBvdGNoa2luIGFuZCBQZXRlciBMZWUgKGh0dHA6Ly93d3cuY29kZXByb2plY3QuY29tL0tCL2dyYXBoaWNzL0JlemllclNwbGluZS5hc3B4KS4KICAgICAgICAvLyBAcGFyYW0ge2FycmF5fSBwb2ludHMgQXJyYXkgb2YgcG9pbnRzIHRocm91Z2ggd2hpY2ggdGhlIHNtb290aCBsaW5lIHdpbGwgZ28uCiAgICAgICAgLy8gQHJldHVybiB7YXJyYXl9IFNWRyBQYXRoIGNvbW1hbmRzIGFzIGFuIGFycmF5CiAgICAgICAgY3VydmVUaHJvdWdoUG9pbnRzOiBmdW5jdGlvbihwb2ludHMpIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xQb2ludHMgPSB0aGlzLmdldEN1cnZlQ29udHJvbFBvaW50cyhwb2ludHMpOwogICAgICAgICAgICB2YXIgcGF0aCA9IFsnTScsIHBvaW50c1swXS54LCBwb2ludHNbMF0ueV07CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRyb2xQb2ludHNbMF0ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHBhdGgucHVzaCgnQycsIGNvbnRyb2xQb2ludHNbMF1baV0ueCwgY29udHJvbFBvaW50c1swXVtpXS55LCBjb250cm9sUG9pbnRzWzFdW2ldLngsIGNvbnRyb2xQb2ludHNbMV1baV0ueSwgcG9pbnRzW2krMV0ueCwgcG9pbnRzW2krMV0ueSk7ICAgICAgICAKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGF0aDsKICAgICAgICB9LAogICAgICAgIAogICAgICAgIC8vIEdldCBvcGVuLWVuZGVkIEJlemllciBTcGxpbmUgQ29udHJvbCBQb2ludHMuCiAgICAgICAgLy8gQHBhcmFtIGtub3RzIElucHV0IEtub3QgQmV6aWVyIHNwbGluZSBwb2ludHMgKEF0IGxlYXN0IHR3byBwb2ludHMhKS4KICAgICAgICAvLyBAcGFyYW0gZmlyc3RDb250cm9sUG9pbnRzIE91dHB1dCBGaXJzdCBDb250cm9sIHBvaW50cy4gQXJyYXkgb2Yga25vdHMubGVuZ3RoIC0gMSBsZW5ndGguCiAgICAgICAgLy8gIEBwYXJhbSBzZWNvbmRDb250cm9sUG9pbnRzIE91dHB1dCBTZWNvbmQgQ29udHJvbCBwb2ludHMuIEFycmF5IG9mIGtub3RzLmxlbmd0aCAtIDEgbGVuZ3RoLgogICAgICAgIGdldEN1cnZlQ29udHJvbFBvaW50czogZnVuY3Rpb24oa25vdHMpIHsKICAgICAgICAgICAgdmFyIGZpcnN0Q29udHJvbFBvaW50cyA9IFtdOwogICAgICAgICAgICB2YXIgc2Vjb25kQ29udHJvbFBvaW50cyA9IFtdOwogICAgICAgICAgICB2YXIgbiA9IGtub3RzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgIHZhciBpOwoKICAgICAgICAgICAgLy8gU3BlY2lhbCBjYXNlOiBCZXppZXIgY3VydmUgc2hvdWxkIGJlIGEgc3RyYWlnaHQgbGluZS4KICAgICAgICAgICAgaWYgKG4gPT0gMSkgeyAKCSAgICAgICAgLy8gM1AxID0gMlAwICsgUDMKCSAgICAgICAgZmlyc3RDb250cm9sUG9pbnRzWzBdID0gcG9pbnQoKDIgKiBrbm90c1swXS54ICsga25vdHNbMV0ueCkgLyAzLAoJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoMiAqIGtub3RzWzBdLnkgKyBrbm90c1sxXS55KSAvIDMpOwoJICAgICAgICAvLyBQMiA9IDJQMSDigJMgUDAKCSAgICAgICAgc2Vjb25kQ29udHJvbFBvaW50c1swXSA9IHBvaW50KDIgKiBmaXJzdENvbnRyb2xQb2ludHNbMF0ueCAtIGtub3RzWzBdLngsCgkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAyICogZmlyc3RDb250cm9sUG9pbnRzWzBdLnkgLSBrbm90c1swXS55KTsKCSAgICAgICAgcmV0dXJuIFtmaXJzdENvbnRyb2xQb2ludHMsIHNlY29uZENvbnRyb2xQb2ludHNdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGZpcnN0IEJlemllciBjb250cm9sIHBvaW50cy4KICAgICAgICAgICAgLy8gUmlnaHQgaGFuZCBzaWRlIHZlY3Rvci4KICAgICAgICAgICAgdmFyIHJocyA9IFtdOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gU2V0IHJpZ2h0IGhhbmQgc2lkZSBYIHZhbHVlcy4KICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8IG4gLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIHJoc1tpXSA9IDQgKiBrbm90c1tpXS54ICsgMiAqIGtub3RzW2kgKyAxXS54OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJoc1swXSA9IGtub3RzWzBdLnggKyAyICoga25vdHNbMV0ueDsKICAgICAgICAgICAgcmhzW24gLSAxXSA9ICg4ICoga25vdHNbbiAtIDFdLnggKyBrbm90c1tuXS54KSAvIDIuMDsKICAgICAgICAgICAgLy8gR2V0IGZpcnN0IGNvbnRyb2wgcG9pbnRzIFgtdmFsdWVzLgogICAgICAgICAgICB2YXIgeCA9IHRoaXMuZ2V0Rmlyc3RDb250cm9sUG9pbnRzKHJocyk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBTZXQgcmlnaHQgaGFuZCBzaWRlIFkgdmFsdWVzLgogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbiAtIDE7ICsraSkgewoJICAgICAgICByaHNbaV0gPSA0ICoga25vdHNbaV0ueSArIDIgKiBrbm90c1tpICsgMV0ueTsKICAgICAgICAgICAgfQogICAgICAgICAgICByaHNbMF0gPSBrbm90c1swXS55ICsgMiAqIGtub3RzWzFdLnk7CiAgICAgICAgICAgIHJoc1tuIC0gMV0gPSAoOCAqIGtub3RzW24gLSAxXS55ICsga25vdHNbbl0ueSkgLyAyLjA7CiAgICAgICAgICAgIC8vIEdldCBmaXJzdCBjb250cm9sIHBvaW50cyBZLXZhbHVlcy4KICAgICAgICAgICAgdmFyIHkgPSB0aGlzLmdldEZpcnN0Q29udHJvbFBvaW50cyhyaHMpOwogICAgICAgICAgICAKICAgICAgICAgICAgLy8gRmlsbCBvdXRwdXQgYXJyYXlzLgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgaSsrKSB7CgkgICAgICAgIC8vIEZpcnN0IGNvbnRyb2wgcG9pbnQuCgkgICAgICAgIGZpcnN0Q29udHJvbFBvaW50cy5wdXNoKHBvaW50KHhbaV0sIHlbaV0pKTsKCSAgICAgICAgLy8gU2Vjb25kIGNvbnRyb2wgcG9pbnQuCgkgICAgICAgIGlmIChpIDwgbiAtIDEpIHsKCSAgICAgICAgICAgIHNlY29uZENvbnRyb2xQb2ludHMucHVzaChwb2ludCgyICoga25vdHMgW2kgKyAxXS54IC0geFtpICsgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDIgKiBrbm90c1tpICsgMV0ueSAtIHlbaSArIDFdKSk7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICBzZWNvbmRDb250cm9sUG9pbnRzLnB1c2gocG9pbnQoKGtub3RzW25dLnggKyB4W24gLSAxXSkgLyAyLAoJCQkJCSAgICAgICAgICAgKGtub3RzW25dLnkgKyB5W24gLSAxXSkgLyAyKSk7CgkgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gW2ZpcnN0Q29udHJvbFBvaW50cywgc2Vjb25kQ29udHJvbFBvaW50c107CiAgICAgICAgfSwKCiAgICAgICAgLy8gU29sdmVzIGEgdHJpZGlhZ29uYWwgc3lzdGVtIGZvciBvbmUgb2YgY29vcmRpbmF0ZXMgKHggb3IgeSkgb2YgZmlyc3QgQmV6aWVyIGNvbnRyb2wgcG9pbnRzLgogICAgICAgIC8vIEBwYXJhbSByaHMgUmlnaHQgaGFuZCBzaWRlIHZlY3Rvci4KICAgICAgICAvLyBAcmV0dXJuIFNvbHV0aW9uIHZlY3Rvci4KICAgICAgICBnZXRGaXJzdENvbnRyb2xQb2ludHM6IGZ1bmN0aW9uKHJocykgewogICAgICAgICAgICB2YXIgbiA9IHJocy5sZW5ndGg7CiAgICAgICAgICAgIC8vIGB4YCBpcyBhIHNvbHV0aW9uIHZlY3Rvci4KICAgICAgICAgICAgdmFyIHggPSBbXTsKICAgICAgICAgICAgdmFyIHRtcCA9IFtdOwogICAgICAgICAgICB2YXIgYiA9IDIuMDsKICAgICAgICAgICAgCiAgICAgICAgICAgIHhbMF0gPSByaHNbMF0gLyBiOwogICAgICAgICAgICAvLyBEZWNvbXBvc2l0aW9uIGFuZCBmb3J3YXJkIHN1YnN0aXR1dGlvbi4KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBuOyBpKyspIHsgCgkgICAgICAgIHRtcFtpXSA9IDEgLyBiOwoJICAgICAgICBiID0gKGkgPCBuIC0gMSA/IDQuMCA6IDMuNSkgLSB0bXBbaV07CgkgICAgICAgIHhbaV0gPSAocmhzW2ldIC0geFtpIC0gMV0pIC8gYjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBCYWNrc3Vic3RpdHV0aW9uLgoJICAgICAgICB4W24gLSBpIC0gMV0gLT0gdG1wW24gLSBpXSAqIHhbbiAtIGldOyAKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4geDsKICAgICAgICB9LAoKICAgICAgICAvLyBTb2x2ZXMgYW4gaW52ZXJzaW9uIHByb2JsZW0gLS0gR2l2ZW4gdGhlICh4LCB5KSBjb29yZGluYXRlcyBvZiBhIHBvaW50IHdoaWNoIGxpZXMgb24KICAgICAgICAvLyBhIHBhcmFtZXRyaWMgY3VydmUgeCA9IHgodCkvdyh0KSwgeSA9IHkodCkvdyh0KSwg76yBbmQgdGhlIHBhcmFtZXRlciB2YWx1ZSB0CiAgICAgICAgLy8gd2hpY2ggY29ycmVzcG9uZHMgdG8gdGhhdCBwb2ludC4KICAgICAgICAvLyBAcGFyYW0gY29udHJvbCBwb2ludHMgKHN0YXJ0LCBjb250cm9sIHN0YXJ0LCBjb250cm9sIGVuZCwgZW5kKQogICAgICAgIC8vIEByZXR1cm4gYSBmdW5jdGlvbiBhY2NlcHRzIGEgcG9pbnQgYW5kIHJldHVybnMgdC4KICAgICAgICBnZXRJbnZlcnNpb25Tb2x2ZXI6IGZ1bmN0aW9uKHAwLCBwMSwgcDIsIHAzKSB7CiAgICAgICAgICAgIHZhciBwdHMgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIGZ1bmN0aW9uIGwoaSxqKSB7CiAgICAgICAgICAgICAgICAvLyBjYWxjdWxhdGVzIGEgZGV0ZXJtaW5hbnQgM3gzCiAgICAgICAgICAgICAgICAvLyBbcC54ICBwLnkgIDFdCiAgICAgICAgICAgICAgICAvLyBbcGkueCBwaS55IDFdCiAgICAgICAgICAgICAgICAvLyBbcGoueCBwai55IDFdCiAgICAgICAgICAgICAgICB2YXIgcGkgPSBwdHNbaV0sIHBqID0gcHRzW2pdOwogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdyA9IChpICUgMyA/IDMgOiAxKSAqIChqICUgMyA/IDMgOiAxKTsKICAgICAgICAgICAgICAgICAgICB2YXIgbGlqID0gcC54ICogKHBpLnkgLSBwai55KSArIHAueSAqIChwai54IC0gcGkueCkgKyBwaS54ICogcGoueSAtIHBpLnkgKiBwai54OwogICAgICAgICAgICAgICAgICAgIHJldHVybiB3ICogbGlqOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gc29sdmVJbnZlcnNpb24ocCkgewogICAgICAgICAgICAgICAgdmFyIGN0ID0gMyAqIGwoMiwzKShwMSk7CiAgICAgICAgICAgICAgICB2YXIgYzEgPSBsKDEsMykocDApIC8gY3Q7CiAgICAgICAgICAgICAgICB2YXIgYzIgPSAtbCgyLDMpKHAwKSAvIGN0OwogICAgICAgICAgICAgICAgdmFyIGxhID0gYzEgKiBsKDMsMSkocCkgKyBjMiAqIChsKDMsMCkocCkgKyBsKDIsMSkocCkpICsgbCgyLDApKHApOwogICAgICAgICAgICAgICAgdmFyIGxiID0gYzEgKiBsKDMsMCkocCkgKyBjMiAqIGwoMiwwKShwKSArIGwoMSwwKShwKTsKICAgICAgICAgICAgICAgIHJldHVybiBsYiAvIChsYiAtIGxhKTsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvLyBEaXZpZGUgYSBCZXppZXIgY3VydmUgaW50byB0d28gYXQgcG9pbnQgZGVmaW5lZCBieSB2YWx1ZSAndCcgPDAsMT4uCiAgICAgICAgLy8gVXNpbmcgZGVDYXN0ZWxqYXUgYWxnb3JpdGhtLiBodHRwOi8vbWF0aC5zdGFja2V4Y2hhbmdlLmNvbS9hLzMxNzg2NwogICAgICAgIC8vIEBwYXJhbSBjb250cm9sIHBvaW50cyAoc3RhcnQsIGNvbnRyb2wgc3RhcnQsIGNvbnRyb2wgZW5kLCBlbmQpCiAgICAgICAgLy8gQHJldHVybiBhIGZ1bmN0aW9uIGFjY2VwdHMgdCBhbmQgcmV0dXJucyAyIGN1cnZlcyBlYWNoIGRlZmluZWQgYnkgNCBjb250cm9sIHBvaW50cy4KICAgICAgICBnZXRDdXJ2ZURpdmlkZXI6IGZ1bmN0aW9uKHAwLHAxLHAyLHAzKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBkaXZpZGVDdXJ2ZSh0KSB7CiAgICAgICAgICAgICAgICB2YXIgbCA9IGxpbmUocDAscDEpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgbSA9IGxpbmUocDEscDIpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgbiA9IGxpbmUocDIscDMpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICB2YXIgcCA9IGxpbmUobCxtKS5wb2ludEF0KHQpOwogICAgICAgICAgICAgICAgdmFyIHEgPSBsaW5lKG0sbikucG9pbnRBdCh0KTsKICAgICAgICAgICAgICAgIHZhciByID0gbGluZShwLHEpLnBvaW50QXQodCk7CiAgICAgICAgICAgICAgICByZXR1cm4gW3sgcDA6IHAwLCBwMTogbCwgcDI6IHAsIHAzOiByIH0sIHsgcDA6IHIsIHAxOiBxLCBwMjogbiwgcDM6IHAzIH1dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvLyBTY2FsZS4KICAgIHZhciBzY2FsZSA9IHsKCiAgICAgICAgLy8gUmV0dXJuIHRoZSBgdmFsdWVgIGZyb20gdGhlIGBkb21haW5gIGludGVydmFsIHNjYWxlZCB0byB0aGUgYHJhbmdlYCBpbnRlcnZhbC4KICAgICAgICBsaW5lYXI6IGZ1bmN0aW9uKGRvbWFpbiwgcmFuZ2UsIHZhbHVlKSB7CgogICAgICAgICAgICB2YXIgZG9tYWluU3BhbiA9IGRvbWFpblsxXSAtIGRvbWFpblswXTsKICAgICAgICAgICAgdmFyIHJhbmdlU3BhbiA9IHJhbmdlWzFdIC0gcmFuZ2VbMF07CiAgICAgICAgICAgIHJldHVybiAoKCh2YWx1ZSAtIGRvbWFpblswXSkgLyBkb21haW5TcGFuKSAqIHJhbmdlU3BhbiArIHJhbmdlWzBdKSB8fCAwOwogICAgICAgIH0KICAgIH07CgogICAgcmV0dXJuIHsKCiAgICAgICAgdG9EZWc6IHRvRGVnLAogICAgICAgIHRvUmFkOiB0b1JhZCwKICAgICAgICBzbmFwVG9HcmlkOiBzbmFwVG9HcmlkLAoJbm9ybWFsaXplQW5nbGU6IG5vcm1hbGl6ZUFuZ2xlLAogICAgICAgIHBvaW50OiBwb2ludCwKICAgICAgICBsaW5lOiBsaW5lLAogICAgICAgIHJlY3Q6IHJlY3QsCiAgICAgICAgZWxsaXBzZTogZWxsaXBzZSwKICAgICAgICBiZXppZXI6IGJlemllciwKICAgICAgICBzY2FsZTogc2NhbGUKICAgIH0KfSkpOwoKLy8gICAgICBKb2ludEpTIGxpYnJhcnkuCi8vICAgICAgKGMpIDIwMTEtMjAxMyBjbGllbnQgSU8KCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKLy8gR2xvYmFsIG5hbWVzcGFjZS4KCnZhciBqb2ludCA9IHsKCiAgICAvLyBgam9pbnQuZGlhYCBuYW1lc3BhY2UuCiAgICBkaWE6IHt9LAoKICAgIC8vIGBqb2ludC51aWAgbmFtZXNwYWNlLgogICAgdWk6IHt9LAoKICAgIC8vIGBqb2ludC5sYXlvdXRgIG5hbWVzcGFjZS4KICAgIGxheW91dDoge30sCgogICAgLy8gYGpvaW50LnNoYXBlc2AgbmFtZXNwYWNlLgogICAgc2hhcGVzOiB7fSwKCiAgICAvLyBgam9pbnQuZm9ybWF0YCBuYW1lc3BhY2UuCiAgICBmb3JtYXQ6IHt9LAoKICAgIC8vIGBqb2ludC5jb25uZWN0b3JzYCBuYW1lc3BhY2UuCiAgICBjb25uZWN0b3JzOiB7fSwKCiAgICAvLyBgam9pbnQucm91dGVyc2AgbmFtZXNwYWNlLgogICAgcm91dGVyczoge30sCgogICAgdXRpbDogewoKICAgICAgICAvLyBSZXR1cm4gYSBzaW1wbGUgaGFzaCBjb2RlIGZyb20gYSBzdHJpbmcuIFNlZSBodHRwOi8vd2VyeGx0ZC5jb20vd3AvMjAxMC8wNS8xMy9qYXZhc2NyaXB0LWltcGxlbWVudGF0aW9uLW9mLWphdmFzLXN0cmluZy1oYXNoY29kZS1tZXRob2QvLgogICAgICAgIGhhc2hDb2RlOiBmdW5jdGlvbihzdHIpIHsKCiAgICAgICAgICAgIHZhciBoYXNoID0gMDsKICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGggPT0gMCkgcmV0dXJuIGhhc2g7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgYyA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICAgICAgaGFzaCA9ICgoaGFzaCA8PCA1KSAtIGhhc2gpICsgYzsKICAgICAgICAgICAgICAgIGhhc2ggPSBoYXNoICYgaGFzaDsgLy8gQ29udmVydCB0byAzMmJpdCBpbnRlZ2VyCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhhc2g7CiAgICAgICAgfSwKCiAgICAgICAgZ2V0QnlQYXRoOiBmdW5jdGlvbihvYmosIHBhdGgsIGRlbGltKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBkZWxpbSA9IGRlbGltIHx8ICcuJzsKICAgICAgICAgICAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KGRlbGltKTsKICAgICAgICAgICAgdmFyIGtleTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHdoaWxlIChrZXlzLmxlbmd0aCkgewogICAgICAgICAgICAgICAga2V5ID0ga2V5cy5zaGlmdCgpOwogICAgICAgICAgICAgICAgaWYgKGtleSBpbiBvYmopIHsKICAgICAgICAgICAgICAgICAgICBvYmogPSBvYmpba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCgogICAgICAgIHNldEJ5UGF0aDogZnVuY3Rpb24ob2JqLCBwYXRoLCB2YWx1ZSwgZGVsaW0pIHsKCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwoKICAgICAgICAgICAgdmFyIGtleXMgPSBwYXRoLnNwbGl0KGRlbGltKTsKICAgICAgICAgICAgdmFyIGRpdmVyID0gb2JqOwogICAgICAgICAgICB2YXIgaSA9IDA7CgogICAgICAgICAgICBpZiAocGF0aC5pbmRleE9mKGRlbGltKSA+IC0xKSB7CgogICAgICAgICAgICAgICAgZm9yICh2YXIgbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBsZW4gLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAvLyBkaXZlciBjcmVhdGVzIGFuIGVtcHR5IG9iamVjdCBpZiB0aGVyZSBpcyBubyBuZXN0ZWQgb2JqZWN0IHVuZGVyIHN1Y2ggYSBrZXkuCiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBtZWFucyB0aGF0IG9uZSBjYW4gcG9wdWxhdGUgYW4gZW1wdHkgbmVzdGVkIG9iamVjdCB3aXRoIHNldEJ5UGF0aCgpLgogICAgICAgICAgICAgICAgICAgIGRpdmVyID0gZGl2ZXJba2V5c1tpXV0gfHwgKGRpdmVyW2tleXNbaV1dID0ge30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGl2ZXJba2V5c1tsZW4gLSAxXV0gPSB2YWx1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG9ialtwYXRoXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgfSwKCiAgICAgICAgdW5zZXRCeVBhdGg6IGZ1bmN0aW9uKG9iaiwgcGF0aCwgZGVsaW0pIHsKCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwoKICAgICAgICAgICAgLy8gaW5kZXggb2YgdGhlIGxhc3QgZGVsaW1pdGVyCiAgICAgICAgICAgIHZhciBpID0gcGF0aC5sYXN0SW5kZXhPZihkZWxpbSk7CgogICAgICAgICAgICBpZiAoaSA+IC0xKSB7CgogICAgICAgICAgICAgICAgLy8gdW5zZXR0aW5nIGEgbmVzdGVkIGF0dHJpYnV0ZQogICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IGpvaW50LnV0aWwuZ2V0QnlQYXRoKG9iaiwgcGF0aC5zdWJzdHIoMCwgaSksIGRlbGltKTsKCiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBwYXJlbnRbcGF0aC5zbGljZShpICsgMSldOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyB1bnNldHRpbmcgYSBwcmltaXRpdmUgYXR0cmlidXRlCiAgICAgICAgICAgICAgICBkZWxldGUgb2JqW3BhdGhdOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgIH0sCgogICAgICAgIGZsYXR0ZW5PYmplY3Q6IGZ1bmN0aW9uKG9iaiwgZGVsaW0sIHN0b3ApIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRlbGltID0gZGVsaW0gfHwgJy4nOwogICAgICAgICAgICB2YXIgcmV0ID0ge307CgkgICAgCgkgICAgZm9yICh2YXIga2V5IGluIG9iaikgewoJCWlmICghb2JqLmhhc093blByb3BlcnR5KGtleSkpIGNvbnRpbnVlOwoKICAgICAgICAgICAgICAgIHZhciBzaG91bGRHb0RlZXBlciA9IHR5cGVvZiBvYmpba2V5XSA9PT0gJ29iamVjdCc7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkR29EZWVwZXIgJiYgc3RvcCAmJiBzdG9wKG9ialtrZXldKSkgewogICAgICAgICAgICAgICAgICAgIHNob3VsZEdvRGVlcGVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKCQlpZiAoc2hvdWxkR29EZWVwZXIpIHsKCQkgICAgdmFyIGZsYXRPYmplY3QgPSB0aGlzLmZsYXR0ZW5PYmplY3Qob2JqW2tleV0sIGRlbGltLCBzdG9wKTsKCQkgICAgZm9yICh2YXIgZmxhdEtleSBpbiBmbGF0T2JqZWN0KSB7CgkJCWlmICghZmxhdE9iamVjdC5oYXNPd25Qcm9wZXJ0eShmbGF0S2V5KSkgY29udGludWU7CgkJCQoJCQlyZXRba2V5ICsgZGVsaW0gKyBmbGF0S2V5XSA9IGZsYXRPYmplY3RbZmxhdEtleV07CgkJICAgIH0KCQl9IGVsc2UgewoJCSAgICByZXRba2V5XSA9IG9ialtrZXldOwoJCX0KCSAgICB9CgkgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICB1dWlkOiBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIC8vIGNyZWRpdDogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3Bvc3RzLzIxMTc1MjMvcmV2aXNpb25zCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gJ3h4eHh4eHh4LXh4eHgtNHh4eC15eHh4LXh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3h5XS9nLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IE1hdGgucmFuZG9tKCkqMTZ8MCwgdiA9IGMgPT0gJ3gnID8gciA6IChyJjB4M3wweDgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHYudG9TdHJpbmcoMTYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvLyBHZW5lcmF0ZSBnbG9iYWwgdW5pcXVlIGlkIGZvciBvYmogYW5kIHN0b3JlIGl0IGFzIGEgcHJvcGVydHkgb2YgdGhlIG9iamVjdC4KICAgICAgICBndWlkOiBmdW5jdGlvbihvYmopIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuZ3VpZC5pZCA9IHRoaXMuZ3VpZC5pZCB8fCAxOwogICAgICAgICAgICBvYmouaWQgPSAob2JqLmlkID09PSB1bmRlZmluZWQgPyAnal8nICsgdGhpcy5ndWlkLmlkKysgOiBvYmouaWQpOwogICAgICAgICAgICByZXR1cm4gb2JqLmlkOwogICAgICAgIH0sCgogICAgICAgIC8vIENvcHkgYWxsIHRoZSBwcm9wZXJ0aWVzIHRvIHRoZSBmaXJzdCBhcmd1bWVudCBmcm9tIHRoZSBmb2xsb3dpbmcgYXJndW1lbnRzLgogICAgICAgIC8vIEFsbCB0aGUgcHJvcGVydGllcyB3aWxsIGJlIG92ZXJ3cml0dGVuIGJ5IHRoZSBwcm9wZXJ0aWVzIGZyb20gdGhlIGZvbGxvd2luZwogICAgICAgIC8vIGFyZ3VtZW50cy4gSW5oZXJpdGVkIHByb3BlcnRpZXMgYXJlIGlnbm9yZWQuCiAgICAgICAgbWl4aW46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgZXh0ZW5zaW9uID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBPbmx5IGZ1bmN0aW9ucyBhbmQgb2JqZWN0cyBjYW4gYmUgbWl4aW5lZC4KCiAgICAgICAgICAgICAgICBpZiAoKE9iamVjdChleHRlbnNpb24pICE9PSBleHRlbnNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgIV8uaXNGdW5jdGlvbihleHRlbnNpb24pICYmCiAgICAgICAgICAgICAgICAgICAgKGV4dGVuc2lvbiA9PT0gbnVsbCB8fCBleHRlbnNpb24gPT09IHVuZGVmaW5lZCkpIHsKCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgXy5lYWNoKGV4dGVuc2lvbiwgZnVuY3Rpb24oY29weSwga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubWl4aW4uZGVlcCAmJiAoT2JqZWN0KGNvcHkpID09PSBjb3B5KSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRba2V5XSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXldID0gXy5pc0FycmF5KGNvcHkpID8gW10gOiB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5taXhpbih0YXJnZXRba2V5XSwgY29weSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFtrZXldICE9PSBjb3B5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMubWl4aW4uc3VwcGxlbWVudCB8fCAhdGFyZ2V0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5XSA9IGNvcHk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ29weSBhbGwgcHJvcGVydGllcyB0byB0aGUgZmlyc3QgYXJndW1lbnQgZnJvbSB0aGUgZm9sbG93aW5nCiAgICAgICAgLy8gYXJndW1lbnRzIG9ubHkgaW4gY2FzZSBpZiB0aGV5IGRvbid0IGV4aXN0cyBpbiB0aGUgZmlyc3QgYXJndW1lbnQuCiAgICAgICAgLy8gQWxsIHRoZSBmdW5jdGlvbiBwcm9wZXJlcnRpZXMgaW4gdGhlIGZpcnN0IGFyZ3VtZW50IHdpbGwgZ2V0CiAgICAgICAgLy8gYWRkaXRpb25hbCBwcm9wZXJ0eSBiYXNlIHBvaW50aW5nIHRvIHRoZSBleHRlbmRlcnMgc2FtZSBuYW1lZAogICAgICAgIC8vIHByb3BlcnR5IGZ1bmN0aW9uJ3MgY2FsbCBtZXRob2QuCiAgICAgICAgc3VwcGxlbWVudDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLm1peGluLnN1cHBsZW1lbnQgPSB0cnVlOwogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5taXhpbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLm1peGluLnN1cHBsZW1lbnQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAvLyBTYW1lIGFzIGBtaXhpbigpYCBidXQgZGVlcCB2ZXJzaW9uLgogICAgICAgIGRlZXBNaXhpbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLm1peGluLmRlZXAgPSB0cnVlOwogICAgICAgICAgICB2YXIgcmV0ID0gdGhpcy5taXhpbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICB0aGlzLm1peGluLmRlZXAgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9LAoKICAgICAgICAvLyBTYW1lIGFzIGBzdXBwbGVtZW50KClgIGJ1dCBkZWVwIHZlcnNpb24uCiAgICAgICAgZGVlcFN1cHBsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5taXhpbi5kZWVwID0gdGhpcy5taXhpbi5zdXBwbGVtZW50ID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHJldCA9IHRoaXMubWl4aW4uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgdGhpcy5taXhpbi5kZWVwID0gdGhpcy5taXhpbi5zdXBwbGVtZW50ID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiByZXQ7CiAgICAgICAgfSwKCiAgICAgICAgbm9ybWFsaXplRXZlbnQ6IGZ1bmN0aW9uKGV2dCkgewoKICAgICAgICAgICAgcmV0dXJuIChldnQub3JpZ2luYWxFdmVudCAmJiBldnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlcyAmJiBldnQub3JpZ2luYWxFdmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGgpID8gZXZ0Lm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0gOiBldnQ7CiAgICAgICAgfSwKCgluZXh0RnJhbWU6KGZ1bmN0aW9uKCkgewoKCSAgICB2YXIgcmFmOwoJICAgIHZhciBjbGllbnQgPSB0eXBlb2Ygd2luZG93ICE9ICd1bmRlZmluZWQnOwoKCSAgICBpZiAoY2xpZW50KSB7CgoJCXJhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgICAgfHwKCQkgICAgICB3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CgkgICAgICAgICAgICAgIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgfHwKCQkgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgIHx8CgkJICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKCSAgICB9CgoJICAgIGlmICghcmFmKSB7CgoJCXZhciBsYXN0VGltZSA9IDA7CgoJCXJhZiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgoJCSAgICB2YXIgY3VyclRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKCQkgICAgdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSk7CgkJICAgIHZhciBpZCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGNhbGxiYWNrKGN1cnJUaW1lICsgdGltZVRvQ2FsbCk7IH0sIHRpbWVUb0NhbGwpOwoJCSAgICBsYXN0VGltZSA9IGN1cnJUaW1lICsgdGltZVRvQ2FsbDsKCQkgICAgcmV0dXJuIGlkOwoKCQl9OwoJICAgIH0KCgkgICAgcmV0dXJuIGNsaWVudCA/IF8uYmluZChyYWYsIHdpbmRvdykgOiByYWY7Cgl9KSgpLAoKCWNhbmNlbEZyYW1lOiAoZnVuY3Rpb24oKSB7CgoJICAgIHZhciBjYWY7CgkgICAgdmFyIGNsaWVudCA9IHR5cGVvZiB3aW5kb3cgIT0gJ3VuZGVmaW5lZCc7CgoJICAgIGlmIChjbGllbnQpIHsKCgkJY2FmID0gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lICAgICAgICAgICAgICB8fAoJCSAgICAgIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93LndlYmtpdENhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAoJCSAgICAgIHdpbmRvdy5tc0NhbmNlbEFuaW1hdGlvbkZyYW1lICAgICAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93Lm1zQ2FuY2VsUmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgICB8fAoJCSAgICAgIHdpbmRvdy5vQ2FuY2VsQW5pbWF0aW9uRnJhbWUgICAgICAgICAgICAgfHwKCSAgICAgICAgICAgICAgd2luZG93Lm9DYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgICB8fAoJICAgICAgICAgICAgICB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUgICAgICAgICAgIHx8CgkJICAgICAgd2luZG93Lm1vekNhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZTsKCgkgICAgfQoKCSAgICBjYWYgPSBjYWYgfHwgY2xlYXJUaW1lb3V0OwoKCSAgICByZXR1cm4gY2xpZW50ID8gXy5iaW5kKGNhZiwgd2luZG93KSA6IGNhZjsKCX0pKCksCgogICAgICAgIGJyZWFrVGV4dDogZnVuY3Rpb24odGV4dCwgc2l6ZSwgc3R5bGVzLCBvcHQpIHsKCiAgICAgICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgICAgIHZhciB3aWR0aCA9IHNpemUud2lkdGg7CiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBzaXplLmhlaWdodDsKCiAgICAgICAgICAgIHZhciBzdmdEb2N1bWVudCA9IG9wdC5zdmdEb2N1bWVudCB8fCBWKCdzdmcnKS5ub2RlOwogICAgICAgICAgICB2YXIgdGV4dEVsZW1lbnQgPSBWKCc8dGV4dD48dHNwYW4+PC90c3Bhbj48L3RleHQ+JykuYXR0cihzdHlsZXMgfHwge30pLm5vZGU7CiAgICAgICAgICAgIHZhciB0ZXh0U3BhbiA9IHRleHRFbGVtZW50LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCcnKTsKCiAgICAgICAgICAgIHRleHRTcGFuLmFwcGVuZENoaWxkKHRleHROb2RlKTsKCiAgICAgICAgICAgIHN2Z0RvY3VtZW50LmFwcGVuZENoaWxkKHRleHRFbGVtZW50KTsKCiAgICAgICAgICAgIGlmICghb3B0LnN2Z0RvY3VtZW50KSB7CgogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzdmdEb2N1bWVudCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB3b3JkcyA9IHRleHQuc3BsaXQoJyAnKTsKICAgICAgICAgICAgdmFyIGZ1bGwgPSBbXTsKICAgICAgICAgICAgdmFyIGxpbmVzID0gW107CiAgICAgICAgICAgIHZhciBwOwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSAwLCBsZW4gPSB3b3Jkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoKICAgICAgICAgICAgICAgIHZhciB3b3JkID0gd29yZHNbaV07CgogICAgICAgICAgICAgICAgdGV4dE5vZGUuZGF0YSA9IGxpbmVzW2xdID8gbGluZXNbbF0gKyAnICcgKyB3b3JkIDogd29yZDsKCiAgICAgICAgICAgICAgICBpZiAodGV4dFNwYW4uZ2V0Q29tcHV0ZWRUZXh0TGVuZ3RoKCkgPD0gd2lkdGgpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGN1cnJlbnQgbGluZSBmaXRzCiAgICAgICAgICAgICAgICAgICAgbGluZXNbbF0gPSB0ZXh0Tm9kZS5kYXRhOwoKICAgICAgICAgICAgICAgICAgICBpZiAocCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBXZSB3ZXJlIHBhcnRpdGlvbmluZy4gUHV0IHJlc3Qgb2YgdGhlIHdvcmQgb250byBuZXh0IGxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgZnVsbFtsKytdID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwYXJ0aXRpb25pbmcKICAgICAgICAgICAgICAgICAgICAgICAgcCA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgIGlmICghbGluZXNbbF0gfHwgcCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnRpdGlvbiA9ICEhcDsKCiAgICAgICAgICAgICAgICAgICAgICAgIHAgPSB3b3JkLmxlbmd0aCAtIDE7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydGl0aW9uIHx8ICFwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gd29yZCBoYXMgb25seSBvbmUgY2hhcmFjdGVyLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbGluZXNbbF0pIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdlIHdvbid0IGZpdCB0aGlzIHRleHQgd2l0aGluIG91ciByZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gW107CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHBhcnRpdGlvbmluZyBkaWRuJ3QgaGVscCBvbiB0aGUgbm9uLWVtcHR5IGxpbmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnkgYWdhaW4sIGJ1dCB0aGlzIHRpbWUgc3RhcnQgd2l0aCBhIG5ldyBsaW5lCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNhbmNlbCBwYXJ0aXRpb25zIGNyZWF0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3b3Jkcy5zcGxpY2UoaSwyLCB3b3JkICsgd29yZHNbaSsxXSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFkanVzdCB3b3JkIGxlbmd0aAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbi0tOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdWxsW2wrK10gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbW92ZSBsYXN0IGxldHRlciB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBuZXh0IHdvcmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2ldID0gd29yZC5zdWJzdHJpbmcoMCxwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmRzW2krMV0gPSB3b3JkLnN1YnN0cmluZyhwKSArIHdvcmRzW2krMV07CgogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlIGluaXRpYXRlIHBhcnRpdGlvbmluZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3BsaXQgdGhlIGxvbmcgd29yZCBpbnRvIHR3byB3b3JkcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd29yZHMuc3BsaWNlKGksIDEsIHdvcmQuc3Vic3RyaW5nKDAscCksIHdvcmQuc3Vic3RyaW5nKHApKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhZGp1c3Qgd29yZHMgbGVuZ3RoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW4rKzsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobCAmJiAhZnVsbFtsLTFdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIHByZXZpb3VzIGxpbmUgaXMgbm90IGZ1bGwsIHRyeSB0byBmaXQgbWF4IHBhcnQgb2YKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgY3VycmVudCB3b3JkIHRoZXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpLS07CgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGwrKzsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gaWYgc2l6ZS5oZWlnaHQgaXMgZGVmaW5lZCB3ZSBoYXZlIHRvIGNoZWNrIHdoZXRoZXIgdGhlIGhlaWdodCBvZiB0aGUgZW50aXJlCiAgICAgICAgICAgICAgICAvLyB0ZXh0IGV4Y2VlZHMgdGhlIHJlY3QgaGVpZ2h0CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGhlaWdodCAhPT0gJ3VuZGVmaW5lZCcpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gZ2V0IGxpbmUgaGVpZ2h0IGFzIHRleHQgaGVpZ2h0IC8gMC44IChhcyB0ZXh0IGhlaWdodCBpcyBhcHByb3guIDAuOGVtCiAgICAgICAgICAgICAgICAgICAgLy8gYW5kIGxpbmUgaGVpZ2h0IGlzIDFlbS4gU2VlIHZlY3Rvcml6ZXIudGV4dCgpKQogICAgICAgICAgICAgICAgICAgIHZhciBsaCA9IGxoIHx8IHRleHRFbGVtZW50LmdldEJCb3goKS5oZWlnaHQgKiAxLjI1OwoKICAgICAgICAgICAgICAgICAgICBpZiAobGggKiBsaW5lcy5sZW5ndGggPiBoZWlnaHQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBvdmVyZmxvd2luZyBsaW5lcwogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5zcGxpY2UoTWF0aC5mbG9vcihoZWlnaHQgLyBsaCkpOwoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3B0LnN2Z0RvY3VtZW50KSB7CgogICAgICAgICAgICAgICAgLy8gc3ZnIGRvY3VtZW50IHdhcyBwcm92aWRlZCwgcmVtb3ZlIHRoZSB0ZXh0IGVsZW1lbnQgb25seQogICAgICAgICAgICAgICAgc3ZnRG9jdW1lbnQucmVtb3ZlQ2hpbGQodGV4dEVsZW1lbnQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBjbGVhbiBzdmcgZG9jdW1lbnQKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoc3ZnRG9jdW1lbnQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gbGluZXMuam9pbignXG4nKTsKICAgICAgICB9LAoKCXRpbWluZzogewoKCSAgICBsaW5lYXI6IGZ1bmN0aW9uKHQpIHsKCQlyZXR1cm4gdDsKCSAgICB9LAoKCSAgICBxdWFkOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0OwoJICAgIH0sCgoJICAgIGN1YmljOiBmdW5jdGlvbih0KSB7CgkJcmV0dXJuIHQgKiB0ICogdDsKCSAgICB9LAoKCSAgICBpbm91dDogZnVuY3Rpb24odCkgewoJCWlmICh0IDw9IDApIHJldHVybiAwOwoJCWlmICh0ID49IDEpIHJldHVybiAxOwoJCXZhciB0MiA9IHQgKiB0LCB0MyA9IHQyICogdDsKCQlyZXR1cm4gNCAqICh0IDwgLjUgPyB0MyA6IDMgKiAodCAtIHQyKSArIHQzIC0gLjc1KTsKCSAgICB9LAoKCSAgICBleHBvbmVudGlhbDogZnVuY3Rpb24odCkgewoJCXJldHVybiBNYXRoLnBvdygyLCAxMCAqICh0IC0gMSkpOwoJICAgIH0sCgoJICAgIGJvdW5jZTogZnVuY3Rpb24odCkgewoJCWZvcih2YXIgYSA9IDAsIGIgPSAxOyAxOyBhICs9IGIsIGIgLz0gMikgewoJCSAgICBpZiAodCA+PSAoNyAtIDQgKiBhKSAvIDExKSB7CgkJCXZhciBxID0gKDExIC0gNiAqIGEgLSAxMSAqIHQpIC8gNDsKCQkJcmV0dXJuIC1xICogcSArIGIgKiBiOwoJCSAgICB9CgkJfQoJICAgIH0sCgoJICAgIHJldmVyc2U6IGZ1bmN0aW9uKGYpIHsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gMSAtIGYoMSAtIHQpCgkJfQoJICAgIH0sCgoJICAgIHJlZmxlY3Q6IGZ1bmN0aW9uKGYpIHsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gLjUgKiAodCA8IC41ID8gZigyICogdCkgOiAoMiAtIGYoMiAtIDIgKiB0KSkpOwoJCX07CgkgICAgfSwKCgkgICAgY2xhbXA6IGZ1bmN0aW9uKGYsbix4KSB7CgkJbiA9IG4gfHwgMDsKCQl4ID0geCB8fCAxOwoJCXJldHVybiBmdW5jdGlvbih0KSB7CgkJICAgIHZhciByID0gZih0KTsKCQkgICAgcmV0dXJuIHIgPCBuID8gbiA6IHIgPiB4ID8geCA6IHI7CgkJfQoJICAgIH0sCgoJICAgIGJhY2s6IGZ1bmN0aW9uKHMpIHsKCQlpZiAoIXMpIHMgPSAxLjcwMTU4OwoJCXJldHVybiBmdW5jdGlvbih0KSB7CgkJICAgIHJldHVybiB0ICogdCAqICgocyArIDEpICogdCAtIHMpOwoJCX07CgkgICAgfSwKCgkgICAgZWxhc3RpYzogZnVuY3Rpb24oeCkgewoJCWlmICgheCkgeCA9IDEuNTsKCQlyZXR1cm4gZnVuY3Rpb24odCkgewoJCSAgICByZXR1cm4gTWF0aC5wb3coMiwgMTAgKiAodCAtIDEpKSAqIE1hdGguY29zKDIwKk1hdGguUEkqeC8zKnQpOwoJCX0KCSAgICB9CgoJfSwKCglpbnRlcnBvbGF0ZTogewoKCSAgICBudW1iZXI6IGZ1bmN0aW9uKGEsIGIpIHsKCQl2YXIgZCA9IGIgLSBhOwoJCXJldHVybiBmdW5jdGlvbih0KSB7IHJldHVybiBhICsgZCAqIHQ7IH07CgkgICAgfSwKCgkgICAgb2JqZWN0OiBmdW5jdGlvbihhLCBiKSB7CgkJdmFyIHMgPSBfLmtleXMoYSk7CgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKCQkgICAgdmFyIGksIHAsIHIgPSB7fTsKCQkgICAgZm9yIChpID0gcy5sZW5ndGggLSAxOyBpICE9IC0xOyBpLS0pIHsKCQkJcCA9IHNbaV07CgkJCXJbcF0gPSBhW3BdICsgKGJbcF0gLSBhW3BdKSAqIHQ7CgkJICAgIH0KCQkgICAgcmV0dXJuICByOwoJCX0KCSAgICB9LAoKCSAgICBoZXhDb2xvcjogZnVuY3Rpb24oYSwgYikgewoKCQl2YXIgY2EgPSBwYXJzZUludChhLnNsaWNlKDEpLCAxNiksIGNiID0gcGFyc2VJbnQoYi5zbGljZSgxKSwgMTYpOwoKCQl2YXIgcmEgPSBjYSAmIDB4MDAwMGZmLCByZCA9IChjYiAmIDB4MDAwMGZmKSAtIHJhOwoJCXZhciBnYSA9IGNhICYgMHgwMGZmMDAsIGdkID0gKGNiICYgMHgwMGZmMDApIC0gZ2E7CgkJdmFyIGJhID0gY2EgJiAweGZmMDAwMCwgYmQgPSAoY2IgJiAweGZmMDAwMCkgLSBiYTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgciA9IChyYSArIHJkICogdCkgJiAweDAwMDAwMGZmOwogICAgICAgICAgICAgICAgICAgIHZhciBnID0gKGdhICsgZ2QgKiB0KSAmIDB4MDAwMGZmMDA7CiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSAoYmEgKyBiZCAqIHQpICYgMHgwMGZmMDAwMDsKCQkgICAgcmV0dXJuICcjJyArICgxIDw8IDI0IHwgciB8IGcgfCBiICkudG9TdHJpbmcoMTYpLnNsaWNlKDEpOwoJCX07CgkgICAgfSwKCgkgICAgdW5pdDogZnVuY3Rpb24oYSwgYikgewoKCQl2YXIgciA9IC8oLT9bMC05XSouWzAtOV0qKShweHxlbXxjbXxtbXxpbnxwdHxwY3wlKS87CgoJCXZhciBtYSA9IHIuZXhlYyhhKSwgbWIgPSByLmV4ZWMoYik7CgkJdmFyIHAgPSBtYlsxXS5pbmRleE9mKCcuJyksIGYgPSBwID4gMCA/IG1iWzFdLmxlbmd0aCAtIHAgLSAxIDogMDsKCQl2YXIgYSA9ICttYVsxXSwgZCA9ICttYlsxXSAtIGEsIHUgPSBtYVsyXTsKCgkJcmV0dXJuIGZ1bmN0aW9uKHQpIHsKCQkgICAgcmV0dXJuIChhICsgZCAqIHQpLnRvRml4ZWQoZikgKyB1OwoJCX0KCSAgICB9Cgl9LAoKICAgICAgICAvLyBTVkcgZmlsdGVycy4KICAgICAgICBmaWx0ZXI6IHsKCiAgICAgICAgICAgIC8vIGB4YCAuLi4gaG9yaXpvbnRhbCBibHVyCiAgICAgICAgICAgIC8vIGB5YCAuLi4gdmVydGljYWwgYmx1ciAob3B0aW9uYWwpCiAgICAgICAgICAgIGJsdXI6IGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdmFyIHggPSBfLmlzRmluaXRlKGFyZ3MueCkgPyBhcmdzLnggOiAyOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUdhdXNzaWFuQmx1ciBzdGREZXZpYXRpb249IiR7c3RkRGV2aWF0aW9ufSIvPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBzdGREZXZpYXRpb246IF8uaXNGaW5pdGUoYXJncy55KSA/IFt4LCBhcmdzLnldIDogeAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgZHhgIC4uLiBob3Jpem9udGFsIHNoaWZ0CiAgICAgICAgICAgIC8vIGBkeWAgLi4uIHZlcnRpY2FsIHNoaWZ0CiAgICAgICAgICAgIC8vIGBibHVyYCAuLi4gYmx1cgogICAgICAgICAgICAvLyBgY29sb3JgIC4uLiBjb2xvcgogICAgICAgICAgICAvLyBgb3BhY2l0eWAgLi4uIG9wYWNpdHkKICAgICAgICAgICAgZHJvcFNoYWRvdzogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHZhciB0cGwgPSAnU1ZHRkVEcm9wU2hhZG93RWxlbWVudCcgaW4gd2luZG93CiAgICAgICAgICAgICAgICAgICAgPyAnPGZpbHRlcj48ZmVEcm9wU2hhZG93IHN0ZERldmlhdGlvbj0iJHtibHVyfSIgZHg9IiR7ZHh9IiBkeT0iJHtkeX0iIGZsb29kLWNvbG9yPSIke2NvbG9yfSIgZmxvb2Qtb3BhY2l0eT0iJHtvcGFjaXR5fSIvPjwvZmlsdGVyPicKICAgICAgICAgICAgICAgICAgICA6ICc8ZmlsdGVyPjxmZUdhdXNzaWFuQmx1ciBpbj0iU291cmNlQWxwaGEiIHN0ZERldmlhdGlvbj0iJHtibHVyfSIvPjxmZU9mZnNldCBkeD0iJHtkeH0iIGR5PSIke2R5fSIgcmVzdWx0PSJvZmZzZXRibHVyIi8+PGZlRmxvb2QgZmxvb2QtY29sb3I9IiR7Y29sb3J9Ii8+PGZlQ29tcG9zaXRlIGluMj0ib2Zmc2V0Ymx1ciIgb3BlcmF0b3I9ImluIi8+PGZlQ29tcG9uZW50VHJhbnNmZXI+PGZlRnVuY0EgdHlwZT0ibGluZWFyIiBzbG9wZT0iJHtvcGFjaXR5fSIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVNZXJnZT48ZmVNZXJnZU5vZGUvPjxmZU1lcmdlTm9kZSBpbj0iU291cmNlR3JhcGhpYyIvPjwvZmVNZXJnZT48L2ZpbHRlcj4nOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKHRwbCwgewogICAgICAgICAgICAgICAgICAgIGR4OiBhcmdzLmR4IHx8IDAsCiAgICAgICAgICAgICAgICAgICAgZHk6IGFyZ3MuZHkgfHwgMCwKICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiBfLmlzRmluaXRlKGFyZ3Mub3BhY2l0eSkgPyBhcmdzLm9wYWNpdHkgOiAxLAogICAgICAgICAgICAgICAgICAgIGNvbG9yOiBhcmdzLmNvbG9yIHx8ICdibGFjaycsCiAgICAgICAgICAgICAgICAgICAgYmx1cjogXy5pc0Zpbml0ZShhcmdzLmJsdXIpID8gYXJncy5ibHVyIDogNAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gdGhlIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMSBpcyBjb21wbGV0ZWx5IGdyYXlzY2FsZS4gQSB2YWx1ZSBvZiAwIGxlYXZlcyB0aGUgaW5wdXQgdW5jaGFuZ2VkLgogICAgICAgICAgICBncmF5c2NhbGU6IGZ1bmN0aW9uKGFyZ3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgYW1vdW50ID0gXy5pc0Zpbml0ZShhcmdzLmFtb3VudCkgPyBhcmdzLmFtb3VudCA6IDE7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIke2F9ICR7Yn0gJHtjfSAwIDAgJHtkfSAke2V9ICR7Zn0gMCAwICR7Z30gJHtifSAke2h9IDAgMCAwIDAgMCAxIDAiLz48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYTogMC4yMTI2ICsgMC43ODc0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGI6IDAuNzE1MiAtIDAuNzE1MiAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBjOiAwLjA3MjIgLSAwLjA3MjIgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZDogMC4yMTI2IC0gMC4yMTI2ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGU6IDAuNzE1MiArIDAuMjg0OCAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBmOiAwLjA3MjIgLSAwLjA3MjIgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZzogMC4yMTI2IC0gMC4yMTI2ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGg6IDAuMDcyMiArIDAuOTI3OCAqICgxIC0gYW1vdW50KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gdGhlIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMSBpcyBjb21wbGV0ZWx5IHNlcGlhLiBBIHZhbHVlIG9mIDAgbGVhdmVzIHRoZSBpbnB1dCB1bmNoYW5nZWQuCiAgICAgICAgICAgIHNlcGlhOiBmdW5jdGlvbihhcmdzKSB7CgogICAgICAgICAgICAgICAgdmFyIGFtb3VudCA9IF8uaXNGaW5pdGUoYXJncy5hbW91bnQpID8gYXJncy5hbW91bnQgOiAxOwoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Im1hdHJpeCIgdmFsdWVzPSIke2F9ICR7Yn0gJHtjfSAwIDAgJHtkfSAke2V9ICR7Zn0gMCAwICR7Z30gJHtofSAke2l9IDAgMCAwIDAgMCAxIDAiLz48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYTogMC4zOTMgKyAwLjYwNyAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBiOiAwLjc2OSAtIDAuNzY5ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGM6IDAuMTg5IC0gMC4xODkgKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZDogMC4zNDkgLSAwLjM0OSAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBlOiAwLjY4NiArIDAuMzE0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGY6IDAuMTY4IC0gMC4xNjggKiAoMSAtIGFtb3VudCksCiAgICAgICAgICAgICAgICAgICAgZzogMC4yNzIgLSAwLjI3MiAqICgxIC0gYW1vdW50KSwKICAgICAgICAgICAgICAgICAgICBoOiAwLjUzNCAtIDAuNTM0ICogKDEgLSBhbW91bnQpLAogICAgICAgICAgICAgICAgICAgIGk6IDAuMTMxICsgMC44NjkgKiAoMSAtIGFtb3VudCkKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYGFtb3VudGAgLi4uIHRoZSBwcm9wb3J0aW9uIG9mIHRoZSBjb252ZXJzaW9uLiBBIHZhbHVlIG9mIDAgaXMgY29tcGxldGVseSB1bi1zYXR1cmF0ZWQuIEEgdmFsdWUgb2YgMSBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgc2F0dXJhdGU6IGZ1bmN0aW9uKGFyZ3MpIHsKCiAgICAgICAgICAgICAgICB2YXIgYW1vdW50ID0gXy5pc0Zpbml0ZShhcmdzLmFtb3VudCkgPyBhcmdzLmFtb3VudCA6IDE7CgogICAgICAgICAgICAgICAgcmV0dXJuIF8udGVtcGxhdGUoJzxmaWx0ZXI+PGZlQ29sb3JNYXRyaXggdHlwZT0ic2F0dXJhdGUiIHZhbHVlcz0iJHthbW91bnR9Ii8+PC9maWx0ZXI+JywgewogICAgICAgICAgICAgICAgICAgIGFtb3VudDogMSAtIGFtb3VudAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW5nbGVgIC4uLiAgdGhlIG51bWJlciBvZiBkZWdyZWVzIGFyb3VuZCB0aGUgY29sb3IgY2lyY2xlIHRoZSBpbnB1dCBzYW1wbGVzIHdpbGwgYmUgYWRqdXN0ZWQuCiAgICAgICAgICAgIGh1ZVJvdGF0ZTogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbG9yTWF0cml4IHR5cGU9Imh1ZVJvdGF0ZSIgdmFsdWVzPSIke2FuZ2xlfSIvPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBhbmdsZTogYXJncy5hbmdsZSB8fCAwCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIGBhbW91bnRgIC4uLiB0aGUgcHJvcG9ydGlvbiBvZiB0aGUgY29udmVyc2lvbi4gQSB2YWx1ZSBvZiAxIGlzIGNvbXBsZXRlbHkgaW52ZXJ0ZWQuIEEgdmFsdWUgb2YgMCBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgaW52ZXJ0OiBmdW5jdGlvbihhcmdzKSB7CgogICAgICAgICAgICAgICAgdmFyIGFtb3VudCA9IF8uaXNGaW5pdGUoYXJncy5hbW91bnQpID8gYXJncy5hbW91bnQgOiAxOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGZpbHRlcj48ZmVDb21wb25lbnRUcmFuc2Zlcj48ZmVGdW5jUiB0eXBlPSJ0YWJsZSIgdGFibGVWYWx1ZXM9IiR7YW1vdW50fSAke2Ftb3VudDJ9Ii8+PGZlRnVuY0cgdHlwZT0idGFibGUiIHRhYmxlVmFsdWVzPSIke2Ftb3VudH0gJHthbW91bnQyfSIvPjxmZUZ1bmNCIHR5cGU9InRhYmxlIiB0YWJsZVZhbHVlcz0iJHthbW91bnR9ICR7YW1vdW50Mn0iLz48L2ZlQ29tcG9uZW50VHJhbnNmZXI+PC9maWx0ZXI+JywgewogICAgICAgICAgICAgICAgICAgIGFtb3VudDogYW1vdW50LAogICAgICAgICAgICAgICAgICAgIGFtb3VudDI6IDEgLSBhbW91bnQKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gYGFtb3VudGAgLi4uIHByb3BvcnRpb24gb2YgdGhlIGNvbnZlcnNpb24uIEEgdmFsdWUgb2YgMCB3aWxsIGNyZWF0ZSBhbiBpbWFnZSB0aGF0IGlzIGNvbXBsZXRlbHkgYmxhY2suIEEgdmFsdWUgb2YgMSBsZWF2ZXMgdGhlIGlucHV0IHVuY2hhbmdlZC4KICAgICAgICAgICAgYnJpZ2h0bmVzczogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHJldHVybiBfLnRlbXBsYXRlKCc8ZmlsdGVyPjxmZUNvbXBvbmVudFRyYW5zZmVyPjxmZUZ1bmNSIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjxmZUZ1bmNHIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjxmZUZ1bmNCIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIvPjwvZmVDb21wb25lbnRUcmFuc2Zlcj48L2ZpbHRlcj4nLCB7CiAgICAgICAgICAgICAgICAgICAgYW1vdW50OiBfLmlzRmluaXRlKGFyZ3MuYW1vdW50KSA/IGFyZ3MuYW1vdW50IDogMQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyBgYW1vdW50YCAuLi4gcHJvcG9ydGlvbiBvZiB0aGUgY29udmVyc2lvbi4gQSB2YWx1ZSBvZiAwIHdpbGwgY3JlYXRlIGFuIGltYWdlIHRoYXQgaXMgY29tcGxldGVseSBibGFjay4gQSB2YWx1ZSBvZiAxIGxlYXZlcyB0aGUgaW5wdXQgdW5jaGFuZ2VkLgogICAgICAgICAgICBjb250cmFzdDogZnVuY3Rpb24oYXJncykgewoKICAgICAgICAgICAgICAgIHZhciBhbW91bnQgPSBfLmlzRmluaXRlKGFyZ3MuYW1vdW50KSA/IGFyZ3MuYW1vdW50IDogMTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIF8udGVtcGxhdGUoJzxmaWx0ZXI+PGZlQ29tcG9uZW50VHJhbnNmZXI+PGZlRnVuY1IgdHlwZT0ibGluZWFyIiBzbG9wZT0iJHthbW91bnR9IiBpbnRlcmNlcHQ9IiR7YW1vdW50Mn0iLz48ZmVGdW5jRyB0eXBlPSJsaW5lYXIiIHNsb3BlPSIke2Ftb3VudH0iIGludGVyY2VwdD0iJHthbW91bnQyfSIvPjxmZUZ1bmNCIHR5cGU9ImxpbmVhciIgc2xvcGU9IiR7YW1vdW50fSIgaW50ZXJjZXB0PSIke2Ftb3VudDJ9Ii8+PC9mZUNvbXBvbmVudFRyYW5zZmVyPjwvZmlsdGVyPicsIHsKICAgICAgICAgICAgICAgICAgICBhbW91bnQ6IGFtb3VudCwKICAgICAgICAgICAgICAgICAgICBhbW91bnQyOiAuNSAtIGFtb3VudCAvIDIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgZm9ybWF0OiB7CgogICAgICAgICAgICAvLyBGb3JtYXR0aW5nIG51bWJlcnMgdmlhIHRoZSBQeXRob24gRm9ybWF0IFNwZWNpZmljYXRpb24gTWluaS1sYW5ndWFnZS4KICAgICAgICAgICAgLy8gU2VlIGh0dHA6Ly9kb2NzLnB5dGhvbi5vcmcvcmVsZWFzZS8zLjEuMy9saWJyYXJ5L3N0cmluZy5odG1sI2Zvcm1hdC1zcGVjaWZpY2F0aW9uLW1pbmktbGFuZ3VhZ2UuCiAgICAgICAgICAgIC8vIEhlYXZpbGx5IGluc3BpcmVkIGJ5IHRoZSBEMy5qcyBsaWJyYXJ5IGltcGxlbWVudGF0aW9uLgogICAgICAgICAgICBudW1iZXI6IGZ1bmN0aW9uKHNwZWNpZmllciwgdmFsdWUsIGxvY2FsZSkgewoKICAgICAgICAgICAgICAgIGxvY2FsZSA9IGxvY2FsZSB8fCB7CgogICAgICAgICAgICAgICAgICAgIGN1cnJlbmN5OiBbJyQnLCAnJ10sCiAgICAgICAgICAgICAgICAgICAgZGVjaW1hbDogJy4nLAogICAgICAgICAgICAgICAgICAgIHRob3VzYW5kczogJywnLAogICAgICAgICAgICAgICAgICAgIGdyb3VwaW5nOiBbM10KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIFNlZSBQeXRob24gZm9ybWF0IHNwZWNpZmljYXRpb24gbWluaS1sYW5ndWFnZTogaHR0cDovL2RvY3MucHl0aG9uLm9yZy9yZWxlYXNlLzMuMS4zL2xpYnJhcnkvc3RyaW5nLmh0bWwjZm9ybWF0LXNwZWNpZmljYXRpb24tbWluaS1sYW5ndWFnZS4KICAgICAgICAgICAgICAgIC8vIFtbZmlsbF1hbGlnbl1bc2lnbl1bc3ltYm9sXVswXVt3aWR0aF1bLF1bLnByZWNpc2lvbl1bdHlwZV0KICAgICAgICAgICAgICAgIHZhciByZSA9IC8oPzooW157XSk/KFs8Pj1eXSkpPyhbK1wtIF0pPyhbJCNdKT8oMCk/KFxkKyk/KCwpPyhcLi0/XGQrKT8oW2EteiVdKT8vaTsKCiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcik7CiAgICAgICAgICAgICAgICB2YXIgZmlsbCA9IG1hdGNoWzFdIHx8ICcgJzsKICAgICAgICAgICAgICAgIHZhciBhbGlnbiA9IG1hdGNoWzJdIHx8ICc+JzsKICAgICAgICAgICAgICAgIHZhciBzaWduID0gbWF0Y2hbM10gfHwgJyc7CiAgICAgICAgICAgICAgICB2YXIgc3ltYm9sID0gbWF0Y2hbNF0gfHwgJyc7CiAgICAgICAgICAgICAgICB2YXIgemZpbGwgPSBtYXRjaFs1XTsKICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9ICttYXRjaFs2XTsKICAgICAgICAgICAgICAgIHZhciBjb21tYSA9IG1hdGNoWzddOwogICAgICAgICAgICAgICAgdmFyIHByZWNpc2lvbiA9IG1hdGNoWzhdOwogICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBtYXRjaFs5XTsKICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IDE7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gJyc7CiAgICAgICAgICAgICAgICB2YXIgc3VmZml4ID0gJyc7CiAgICAgICAgICAgICAgICB2YXIgaW50ZWdlciA9IGZhbHNlOwoKICAgICAgICAgICAgICAgIGlmIChwcmVjaXNpb24pIHByZWNpc2lvbiA9ICtwcmVjaXNpb24uc3Vic3RyaW5nKDEpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAoemZpbGwgfHwgZmlsbCA9PT0gJzAnICYmIGFsaWduID09PSAnPScpIHsKICAgICAgICAgICAgICAgICAgICB6ZmlsbCA9IGZpbGwgPSAnMCc7CiAgICAgICAgICAgICAgICAgICAgYWxpZ24gPSAnPSc7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hKSB3aWR0aCAtPSBNYXRoLmZsb29yKCh3aWR0aCAtIDEpIC8gNCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ24nOiBjb21tYSA9IHRydWU7IHR5cGUgPSAnZyc7IGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlICclJzogc2NhbGUgPSAxMDA7IHN1ZmZpeCA9ICclJzsgdHlwZSA9ICdmJzsgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ3AnOiBzY2FsZSA9IDEwMDsgc3VmZml4ID0gJyUnOyB0eXBlID0gJ3InOyBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAnYic6CiAgICAgICAgICAgICAgICAgIGNhc2UgJ28nOgogICAgICAgICAgICAgICAgICBjYXNlICd4JzoKICAgICAgICAgICAgICAgICAgY2FzZSAnWCc6IGlmIChzeW1ib2wgPT09ICcjJykgcHJlZml4ID0gJzAnICsgdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICBjYXNlICdjJzoKICAgICAgICAgICAgICAgICAgY2FzZSAnZCc6IGludGVnZXIgPSB0cnVlOyBwcmVjaXNpb24gPSAwOyBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAncyc6IHNjYWxlID0gLTE7IHR5cGUgPSAncic7IGJyZWFrOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChzeW1ib2wgPT09ICckJykgewogICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IGxvY2FsZS5jdXJyZW5jeVswXTsKICAgICAgICAgICAgICAgICAgICBzdWZmaXggPSBsb2NhbGUuY3VycmVuY3lbMV07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgbm8gcHJlY2lzaW9uIGlzIHNwZWNpZmllZCBmb3IgYCdyJ2AsIGZhbGxiYWNrIHRvIGdlbmVyYWwgbm90YXRpb24uCiAgICAgICAgICAgICAgICBpZiAodHlwZSA9PSAncicgJiYgIXByZWNpc2lvbikgdHlwZSA9ICdnJzsKCiAgICAgICAgICAgICAgICAvLyBFbnN1cmUgdGhhdCB0aGUgcmVxdWVzdGVkIHByZWNpc2lvbiBpcyBpbiB0aGUgc3VwcG9ydGVkIHJhbmdlLgogICAgICAgICAgICAgICAgaWYgKHByZWNpc2lvbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT0gJ2cnKSBwcmVjaXNpb24gPSBNYXRoLm1heCgxLCBNYXRoLm1pbigyMSwgcHJlY2lzaW9uKSk7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnZScgfHwgdHlwZSA9PSAnZicpIHByZWNpc2lvbiA9IE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCBwcmVjaXNpb24pKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgemNvbW1hID0gemZpbGwgJiYgY29tbWE7CgogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBlbXB0eSBzdHJpbmcgZm9yIGZsb2F0cyBmb3JtYXR0ZWQgYXMgaW50cy4KICAgICAgICAgICAgICAgIGlmIChpbnRlZ2VyICYmICh2YWx1ZSAlIDEpKSByZXR1cm4gJyc7CgogICAgICAgICAgICAgICAgLy8gQ29udmVydCBuZWdhdGl2ZSB0byBwb3NpdGl2ZSwgYW5kIHJlY29yZCB0aGUgc2lnbiBwcmVmaXguCiAgICAgICAgICAgICAgICB2YXIgbmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgdmFsdWUgPT09IDAgJiYgMSAvIHZhbHVlIDwgMCA/ICh2YWx1ZSA9IC12YWx1ZSwgJy0nKSA6IHNpZ247CgogICAgICAgICAgICAgICAgdmFyIGZ1bGxTdWZmaXggPSBzdWZmaXg7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEFwcGx5IHRoZSBzY2FsZSwgY29tcHV0aW5nIGl0IGZyb20gdGhlIHZhbHVlJ3MgZXhwb25lbnQgZm9yIHNpIGZvcm1hdC4KICAgICAgICAgICAgICAgIC8vIFByZXNlcnZlIHRoZSBleGlzdGluZyBzdWZmaXgsIGlmIGFueSwgc3VjaCBhcyB0aGUgY3VycmVuY3kgc3ltYm9sLgogICAgICAgICAgICAgICAgaWYgKHNjYWxlIDwgMCkgewogICAgICAgICAgICAgICAgICAgIHZhciB1bml0ID0gdGhpcy5wcmVmaXgodmFsdWUsIHByZWNpc2lvbik7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB1bml0LnNjYWxlKHZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBmdWxsU3VmZml4ID0gdW5pdC5zeW1ib2wgKyBzdWZmaXg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbHVlICo9IHNjYWxlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENvbnZlcnQgdG8gdGhlIGRlc2lyZWQgcHJlY2lzaW9uLgogICAgICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmNvbnZlcnQodHlwZSwgdmFsdWUsIHByZWNpc2lvbik7CgogICAgICAgICAgICAgICAgLy8gQnJlYWsgdGhlIHZhbHVlIGludG8gdGhlIGludGVnZXIgcGFydCAoYmVmb3JlKSBhbmQgZGVjaW1hbCBwYXJ0IChhZnRlcikuCiAgICAgICAgICAgICAgICB2YXIgaSA9IHZhbHVlLmxhc3RJbmRleE9mKCcuJyk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlID0gaSA8IDAgPyB2YWx1ZSA6IHZhbHVlLnN1YnN0cmluZygwLCBpKTsKICAgICAgICAgICAgICAgIHZhciBhZnRlciA9IGkgPCAwID8gJycgOiBsb2NhbGUuZGVjaW1hbCArIHZhbHVlLnN1YnN0cmluZyhpICsgMSk7CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0R3JvdXAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IFtdOwogICAgICAgICAgICAgICAgICAgIHZhciBqID0gMDsKICAgICAgICAgICAgICAgICAgICB2YXIgZyA9IGxvY2FsZS5ncm91cGluZ1swXTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdC5wdXNoKHZhbHVlLnN1YnN0cmluZyhpIC09IGcsIGkgKyBnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGcgPSBsb2NhbGUuZ3JvdXBpbmdbaiA9IChqICsgMSkgJSBsb2NhbGUuZ3JvdXBpbmcubGVuZ3RoXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4obG9jYWxlLnRob3VzYW5kcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBmaWxsIGNoYXJhY3RlciBpcyBub3QgYCcwJ2AsIGdyb3VwaW5nIGlzIGFwcGxpZWQgYmVmb3JlIHBhZGRpbmcuCiAgICAgICAgICAgICAgICBpZiAoIXpmaWxsICYmIGNvbW1hICYmIGxvY2FsZS5ncm91cGluZykgewoKICAgICAgICAgICAgICAgICAgICBiZWZvcmUgPSBmb3JtYXRHcm91cChiZWZvcmUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBsZW5ndGggPSBwcmVmaXgubGVuZ3RoICsgYmVmb3JlLmxlbmd0aCArIGFmdGVyLmxlbmd0aCArICh6Y29tbWEgPyAwIDogbmVnYXRpdmUubGVuZ3RoKTsKICAgICAgICAgICAgICAgIHZhciBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkobGVuZ3RoID0gd2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogJyc7CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGZpbGwgY2hhcmFjdGVyIGlzIGAnMCdgLCBncm91cGluZyBpcyBhcHBsaWVkIGFmdGVyIHBhZGRpbmcuCiAgICAgICAgICAgICAgICBpZiAoemNvbW1hKSBiZWZvcmUgPSBmb3JtYXRHcm91cChwYWRkaW5nICsgYmVmb3JlKTsKCiAgICAgICAgICAgICAgICAvLyBBcHBseSBwcmVmaXguCiAgICAgICAgICAgICAgICBuZWdhdGl2ZSArPSBwcmVmaXg7CgogICAgICAgICAgICAgICAgLy8gUmVqb2luIGludGVnZXIgYW5kIGRlY2ltYWwgcGFydHMuCiAgICAgICAgICAgICAgICB2YWx1ZSA9IGJlZm9yZSArIGFmdGVyOwoKICAgICAgICAgICAgICAgIHJldHVybiAoYWxpZ24gPT09ICc8JyA/IG5lZ2F0aXZlICsgdmFsdWUgKyBwYWRkaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIDogYWxpZ24gPT09ICc+JyA/IHBhZGRpbmcgKyBuZWdhdGl2ZSArIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIDogYWxpZ24gPT09ICdeJyA/IHBhZGRpbmcuc3Vic3RyaW5nKDAsIGxlbmd0aCA+Pj0gMSkgKyBuZWdhdGl2ZSArIHZhbHVlICsgcGFkZGluZy5zdWJzdHJpbmcobGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICA6IG5lZ2F0aXZlICsgKHpjb21tYSA/IHZhbHVlIDogcGFkZGluZyArIHZhbHVlKSkgKyBmdWxsU3VmZml4OwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgY29udmVydDogZnVuY3Rpb24odHlwZSwgdmFsdWUsIHByZWNpc2lvbikgewoKICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgICBjYXNlICdiJzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDIpOwogICAgICAgICAgICAgICAgICBjYXNlICdjJzogcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUodmFsdWUpOwogICAgICAgICAgICAgICAgICBjYXNlICdvJzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDgpOwogICAgICAgICAgICAgICAgICBjYXNlICd4JzogcmV0dXJuIHZhbHVlLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgICAgICAgY2FzZSAnWCc6IHJldHVybiB2YWx1ZS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgICAgY2FzZSAnZyc6IHJldHVybiB2YWx1ZS50b1ByZWNpc2lvbihwcmVjaXNpb24pOwogICAgICAgICAgICAgICAgICBjYXNlICdlJzogcmV0dXJuIHZhbHVlLnRvRXhwb25lbnRpYWwocHJlY2lzaW9uKTsKICAgICAgICAgICAgICAgICAgY2FzZSAnZic6IHJldHVybiB2YWx1ZS50b0ZpeGVkKHByZWNpc2lvbik7CiAgICAgICAgICAgICAgICAgIGNhc2UgJ3InOiByZXR1cm4gKHZhbHVlID0gdGhpcy5yb3VuZCh2YWx1ZSwgdGhpcy5wcmVjaXNpb24odmFsdWUsIHByZWNpc2lvbikpKS50b0ZpeGVkKE1hdGgubWF4KDAsIE1hdGgubWluKDIwLCB0aGlzLnByZWNpc2lvbih2YWx1ZSAqICgxICsgMWUtMTUpLCBwcmVjaXNpb24pKSkpOwogICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIHZhbHVlICsgJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICByb3VuZDogZnVuY3Rpb24odmFsdWUsIHByZWNpc2lvbikgewoKICAgICAgICAgICAgICAgIHJldHVybiBwcmVjaXNpb24KICAgICAgICAgICAgICAgICAgICA/IE1hdGgucm91bmQodmFsdWUgKiAocHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbikpKSAvIHByZWNpc2lvbgogICAgICAgICAgICAgICAgICAgIDogTWF0aC5yb3VuZCh2YWx1ZSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwcmVjaXNpb246IGZ1bmN0aW9uKHZhbHVlLCBwcmVjaXNpb24pIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHByZWNpc2lvbiAtICh2YWx1ZSA/IE1hdGguY2VpbChNYXRoLmxvZyh2YWx1ZSkgLyBNYXRoLkxOMTApIDogMSk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBwcmVmaXg6IGZ1bmN0aW9uKHZhbHVlLCBwcmVjaXNpb24pIHsKCiAgICAgICAgICAgICAgICB2YXIgcHJlZml4ZXMgPSBfLm1hcChbJ3knLCd6JywnYScsJ2YnLCdwJywnbicsJ8K1JywnbScsJycsJ2snLCdNJywnRycsJ1QnLCdQJywnRScsJ1onLCdZJ10sIGZ1bmN0aW9uKGQsIGkpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgayA9IE1hdGgucG93KDEwLCBhYnMoOCAtIGkpICogMyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGU6IGkgPiA4ID8gZnVuY3Rpb24oZCkgeyByZXR1cm4gZCAvIGs7IH0gOiBmdW5jdGlvbihkKSB7IHJldHVybiBkICogazsgfSwKICAgICAgICAgICAgICAgICAgICAgICAgc3ltYm9sOiBkCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPCAwKSB2YWx1ZSAqPSAtMTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJlY2lzaW9uKSB2YWx1ZSA9IGQzLnJvdW5kKHZhbHVlLCB0aGlzLnByZWNpc2lvbih2YWx1ZSwgcHJlY2lzaW9uKSk7CiAgICAgICAgICAgICAgICAgICAgaSA9IDEgKyBNYXRoLmZsb29yKDFlLTEyICsgTWF0aC5sb2codmFsdWUpIC8gTWF0aC5MTjEwKTsKICAgICAgICAgICAgICAgICAgICBpID0gTWF0aC5tYXgoLTI0LCBNYXRoLm1pbigyNCwgTWF0aC5mbG9vcigoaSA8PSAwID8gaSArIDEgOiBpIC0gMSkgLyAzKSAqIDMpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlc1s4ICsgaSAvIDNdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9OwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQ7Cn0KCi8vICAgICAgSm9pbnRKUywgdGhlIEphdmFTY3JpcHQgZGlhZ3JhbW1pbmcgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmxpbmsnKS5MaW5rLAogICAgICAgICAgICBFbGVtZW50OiByZXF1aXJlKCcuL2pvaW50LmRpYS5lbGVtZW50JykuRWxlbWVudAogICAgICAgIH0sCiAgICAgICAgc2hhcGVzOiByZXF1aXJlKCcuLi9wbHVnaW5zL3NoYXBlcycpCiAgICB9OwogICAgdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7CiAgICB2YXIgZyA9IHJlcXVpcmUoJy4vZ2VvbWV0cnknKTsKfQoKCgpqb2ludC5kaWEuR3JhcGhDZWxscyA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICAvLyBCYWNrYm9uZSBhdXRvbWF0aWNhbGx5IGRvZXNuJ3QgdHJpZ2dlciByZS1zb3J0IGlmIG1vZGVscyBhdHRyaWJ1dGVzIGFyZSBjaGFuZ2VkIGxhdGVyIHdoZW4KICAgICAgICAvLyB0aGV5J3JlIGFscmVhZHkgaW4gdGhlIGNvbGxlY3Rpb24uIFRoZXJlZm9yZSwgd2UncmUgdHJpZ2dlcmluZyBzb3J0IG1hbnVhbGx5IGhlcmUuCiAgICAgICAgdGhpcy5vbignY2hhbmdlOnonLCB0aGlzLnNvcnQsIHRoaXMpOwogICAgfSwKCiAgICBtb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKCiAgICAgICAgaWYgKGF0dHJzLnR5cGUgPT09ICdsaW5rJykgewoKICAgICAgICAgICAgcmV0dXJuIG5ldyBqb2ludC5kaWEuTGluayhhdHRycywgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbW9kdWxlID0gYXR0cnMudHlwZS5zcGxpdCgnLicpWzBdOwogICAgICAgIHZhciBlbnRpdHkgPSBhdHRycy50eXBlLnNwbGl0KCcuJylbMV07CgogICAgICAgIGlmIChqb2ludC5zaGFwZXNbbW9kdWxlXSAmJiBqb2ludC5zaGFwZXNbbW9kdWxlXVtlbnRpdHldKSB7CgogICAgICAgICAgICByZXR1cm4gbmV3IGpvaW50LnNoYXBlc1ttb2R1bGVdW2VudGl0eV0oYXR0cnMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gbmV3IGpvaW50LmRpYS5FbGVtZW50KGF0dHJzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gYGNvbXBhcmF0b3JgIG1ha2VzIGl0IGVhc3kgdG8gc29ydCBjZWxscyBiYXNlZCBvbiB0aGVpciBgemAgaW5kZXguCiAgICBjb21wYXJhdG9yOiBmdW5jdGlvbihtb2RlbCkgewoKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KCd6JykgfHwgMDsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBpbmJvdW5kIGFuZCBvdXRib3VuZCBsaW5rcyBjb25uZWN0ZWQgdG8gdGhlIGNlbGwgYG1vZGVsYC4KICAgIGdldENvbm5lY3RlZExpbmtzOiBmdW5jdGlvbihtb2RlbCwgb3B0KSB7CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQob3B0LmluYm91bmQpICYmIF8uaXNVbmRlZmluZWQob3B0Lm91dGJvdW5kKSkgewogICAgICAgICAgICBvcHQuaW5ib3VuZCA9IG9wdC5vdXRib3VuZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgbGlua3MgPSBbXTsKICAgICAgICAKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGNlbGwuZ2V0KCdzb3VyY2UnKTsKICAgICAgICAgICAgdmFyIHRhcmdldCA9IGNlbGwuZ2V0KCd0YXJnZXQnKTsKCiAgICAgICAgICAgIGlmIChzb3VyY2UgJiYgc291cmNlLmlkID09PSBtb2RlbC5pZCAmJiBvcHQub3V0Ym91bmQpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGlua3MucHVzaChjZWxsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuaWQgPT09IG1vZGVsLmlkICYmIG9wdC5pbmJvdW5kKSB7CgogICAgICAgICAgICAgICAgbGlua3MucHVzaChjZWxsKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gbGlua3M7CiAgICB9Cn0pOwoKCmpvaW50LmRpYS5HcmFwaCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMuc2V0KCdjZWxscycsIG5ldyBqb2ludC5kaWEuR3JhcGhDZWxscyk7CgogICAgICAgIC8vIE1ha2UgYWxsIHRoZSBldmVudHMgZmlyZWQgaW4gdGhlIGBjZWxsc2AgY29sbGVjdGlvbiBhdmFpbGFibGUuCiAgICAgICAgLy8gdG8gdGhlIG91dHNpZGUgd29ybGQuCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykub24oJ2FsbCcsIHRoaXMudHJpZ2dlciwgdGhpcyk7CiAgICAgICAgCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykub24oJ3JlbW92ZScsIHRoaXMucmVtb3ZlQ2VsbCwgdGhpcyk7CiAgICB9LAoKICAgIHRvSlNPTjogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIEJhY2tib25lIGRvZXMgbm90IHJlY3Vyc2l2ZWx5IGNhbGwgYHRvSlNPTigpYCBvbiBhdHRyaWJ1dGVzIHRoYXQgYXJlIHRoZW1zZWx2ZXMgbW9kZWxzL2NvbGxlY3Rpb25zLgogICAgICAgIC8vIEl0IGp1c3QgY2xvbmVzIHRoZSBhdHRyaWJ1dGVzLiBUaGVyZWZvcmUsIHdlIG11c3QgY2FsbCBgdG9KU09OKClgIG9uIHRoZSBjZWxscyBjb2xsZWN0aW9uIGV4cGxpY2l0ZWx5LgogICAgICAgIHZhciBqc29uID0gQmFja2JvbmUuTW9kZWwucHJvdG90eXBlLnRvSlNPTi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIGpzb24uY2VsbHMgPSB0aGlzLmdldCgnY2VsbHMnKS50b0pTT04oKTsKICAgICAgICByZXR1cm4ganNvbjsKICAgIH0sCgogICAgZnJvbUpTT046IGZ1bmN0aW9uKGpzb24sIG9wdCkgewoKICAgICAgICBpZiAoIWpzb24uY2VsbHMpIHsKCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JhcGggSlNPTiBtdXN0IGNvbnRhaW4gY2VsbHMgYXJyYXkuJyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldChfLm9taXQoanNvbiwgJ2NlbGxzJyksIG9wdCk7CiAgICAgICAgdGhpcy5yZXNldENlbGxzKGpzb24uY2VsbHMsIG9wdCk7CiAgICB9LAoKICAgIGNsZWFyOiBmdW5jdGlvbihvcHQpIHsKCiAgICAgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdGFydCcpOwogICAgICAgIHRoaXMuZ2V0KCdjZWxscycpLnJlbW92ZSh0aGlzLmdldCgnY2VsbHMnKS5tb2RlbHMsIG9wdCk7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICB9LAoKICAgIF9wcmVwYXJlQ2VsbDogZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICBpZiAoY2VsbCBpbnN0YW5jZW9mIEJhY2tib25lLk1vZGVsICYmIF8uaXNVbmRlZmluZWQoY2VsbC5nZXQoJ3onKSkpIHsKCiAgICAgICAgICAgIGNlbGwuc2V0KCd6JywgdGhpcy5tYXhaSW5kZXgoKSArIDEsIHsgc2lsZW50OiB0cnVlIH0pOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKF8uaXNVbmRlZmluZWQoY2VsbC56KSkgewoKICAgICAgICAgICAgY2VsbC56ID0gdGhpcy5tYXhaSW5kZXgoKSArIDE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY2VsbDsKICAgIH0sCgogICAgbWF4WkluZGV4OiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGxhc3RDZWxsID0gdGhpcy5nZXQoJ2NlbGxzJykubGFzdCgpOwogICAgICAgIHJldHVybiBsYXN0Q2VsbCA/IChsYXN0Q2VsbC5nZXQoJ3onKSB8fCAwKSA6IDA7CiAgICB9LAoKICAgIGFkZENlbGw6IGZ1bmN0aW9uKGNlbGwsIG9wdGlvbnMpIHsKCiAgICAgICAgaWYgKF8uaXNBcnJheShjZWxsKSkgewoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRkQ2VsbHMoY2VsbCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdldCgnY2VsbHMnKS5hZGQodGhpcy5fcHJlcGFyZUNlbGwoY2VsbCksIG9wdGlvbnMgfHwge30pOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgYWRkQ2VsbHM6IGZ1bmN0aW9uKGNlbGxzLCBvcHRpb25zKSB7CgogICAgICAgIF8uZWFjaChjZWxscywgZnVuY3Rpb24oY2VsbCkgeyB0aGlzLmFkZENlbGwoY2VsbCwgb3B0aW9ucyk7IH0sIHRoaXMpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gV2hlbiBhZGRpbmcgYSBsb3Qgb2YgY2VsbHMsIGl0IGlzIG11Y2ggbW9yZSBlZmZpY2llbnQgdG8KICAgIC8vIHJlc2V0IHRoZSBlbnRpcmUgY2VsbHMgY29sbGVjdGlvbiBpbiBvbmUgZ28uCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0Q2VsbHM6IGZ1bmN0aW9uKGNlbGxzLCBvcHQpIHsKICAgICAgICAKICAgICAgICB0aGlzLmdldCgnY2VsbHMnKS5yZXNldChfLm1hcChjZWxscywgdGhpcy5fcHJlcGFyZUNlbGwsIHRoaXMpLCBvcHQpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVtb3ZlQ2VsbDogZnVuY3Rpb24oY2VsbCwgY29sbGVjdGlvbiwgb3B0aW9ucykgewoKICAgICAgICAvLyBBcHBsaWNhdGlvbnMgbWlnaHQgcHJvdmlkZSBhIGBkaXNjb25uZWN0TGlua3NgIG9wdGlvbiBzZXQgdG8gYHRydWVgIGluIG9yZGVyIHRvCiAgICAgICAgLy8gZGlzY29ubmVjdCBsaW5rcyB3aGVuIGEgY2VsbCBpcyByZW1vdmVkIHJhdGhlciB0aGVuIHJlbW92aW5nIHRoZW0uIFRoZSBkZWZhdWx0CiAgICAgICAgLy8gaXMgdG8gcmVtb3ZlIGFsbCB0aGUgYXNzb2NpYXRlZCBsaW5rcy4KICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmRpc2Nvbm5lY3RMaW5rcykgewogICAgICAgICAgICAKICAgICAgICAgICAgdGhpcy5kaXNjb25uZWN0TGlua3MoY2VsbCk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICB0aGlzLnJlbW92ZUxpbmtzKGNlbGwpOwogICAgICAgIH0KCiAgICAgICAgLy8gU2lsZW50bHkgcmVtb3ZlIHRoZSBjZWxsIGZyb20gdGhlIGNlbGxzIGNvbGxlY3Rpb24uIFNpbGVudGx5LCBiZWNhdXNlCiAgICAgICAgLy8gYGpvaW50LmRpYS5DZWxsLnByb3RvdHlwZS5yZW1vdmVgIGFscmVhZHkgdHJpZ2dlcnMgdGhlIGByZW1vdmVgIGV2ZW50IHdoaWNoIGlzCiAgICAgICAgLy8gdGhlbiBwcm9wYWdhdGVkIHRvIHRoZSBncmFwaCBtb2RlbC4gSWYgd2UgZGlkbid0IHJlbW92ZSB0aGUgY2VsbCBzaWxlbnRseSwgdHdvIGByZW1vdmVgIGV2ZW50cwogICAgICAgIC8vIHdvdWxkIGJlIHRyaWdnZXJlZCBvbiB0aGUgZ3JhcGggbW9kZWwuCiAgICAgICAgdGhpcy5nZXQoJ2NlbGxzJykucmVtb3ZlKGNlbGwsIHsgc2lsZW50OiB0cnVlIH0pOwogICAgfSwKCiAgICAvLyBHZXQgYSBjZWxsIGJ5IGBpZGAuCiAgICBnZXRDZWxsOiBmdW5jdGlvbihpZCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2NlbGxzJykuZ2V0KGlkKTsKICAgIH0sCgogICAgZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nZXQoJ2NlbGxzJykuZmlsdGVyKGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgICAgIHJldHVybiBjZWxsIGluc3RhbmNlb2Ygam9pbnQuZGlhLkVsZW1lbnQ7CiAgICAgICAgfSk7CiAgICB9LAogICAgCiAgICBnZXRMaW5rczogZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldCgnY2VsbHMnKS5maWx0ZXIoZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgcmV0dXJuIGNlbGwgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluazsKICAgICAgICB9KTsKICAgIH0sCgogICAgLy8gR2V0IGFsbCBpbmJvdW5kIGFuZCBvdXRib3VuZCBsaW5rcyBjb25uZWN0ZWQgdG8gdGhlIGNlbGwgYG1vZGVsYC4KICAgIGdldENvbm5lY3RlZExpbmtzOiBmdW5jdGlvbihtb2RlbCwgb3B0KSB7CgogICAgICAgIHJldHVybiB0aGlzLmdldCgnY2VsbHMnKS5nZXRDb25uZWN0ZWRMaW5rcyhtb2RlbCwgb3B0KTsKICAgIH0sCgogICAgZ2V0TmVpZ2hib3JzOiBmdW5jdGlvbihlbCkgewoKICAgICAgICB2YXIgbGlua3MgPSB0aGlzLmdldENvbm5lY3RlZExpbmtzKGVsKTsKICAgICAgICB2YXIgbmVpZ2hib3JzID0gW107CiAgICAgICAgdmFyIGNlbGxzID0gdGhpcy5nZXQoJ2NlbGxzJyk7CiAgICAgICAgCiAgICAgICAgXy5lYWNoKGxpbmtzLCBmdW5jdGlvbihsaW5rKSB7CgogICAgICAgICAgICB2YXIgc291cmNlID0gbGluay5nZXQoJ3NvdXJjZScpOwogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gbGluay5nZXQoJ3RhcmdldCcpOwoKICAgICAgICAgICAgLy8gRGlzY2FyZCBpZiBpdCBpcyBhIHBvaW50LgogICAgICAgICAgICBpZiAoIXNvdXJjZS54KSB7CiAgICAgICAgICAgICAgICB2YXIgc291cmNlRWxlbWVudCA9IGNlbGxzLmdldChzb3VyY2UuaWQpOwogICAgICAgICAgICAgICAgaWYgKHNvdXJjZUVsZW1lbnQgIT09IGVsKSB7CgogICAgICAgICAgICAgICAgICAgIG5laWdoYm9ycy5wdXNoKHNvdXJjZUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghdGFyZ2V0LngpIHsKICAgICAgICAgICAgICAgIHZhciB0YXJnZXRFbGVtZW50ID0gY2VsbHMuZ2V0KHRhcmdldC5pZCk7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0RWxlbWVudCAhPT0gZWwpIHsKCiAgICAgICAgICAgICAgICAgICAgbmVpZ2hib3JzLnB1c2godGFyZ2V0RWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIG5laWdoYm9yczsKICAgIH0sCiAgICAKICAgIC8vIERpc2Nvbm5lY3QgbGlua3MgY29ubmVjdGVkIHRvIHRoZSBjZWxsIGBtb2RlbGAuCiAgICBkaXNjb25uZWN0TGlua3M6IGZ1bmN0aW9uKG1vZGVsKSB7CgogICAgICAgIF8uZWFjaCh0aGlzLmdldENvbm5lY3RlZExpbmtzKG1vZGVsKSwgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgbGluay5zZXQobGluay5nZXQoJ3NvdXJjZScpLmlkID09PSBtb2RlbC5pZCA/ICdzb3VyY2UnIDogJ3RhcmdldCcsIGcucG9pbnQoMCwgMCkpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZW1vdmUgbGlua3MgY29ubmVjdGVkIHRvIHRoZSBjZWxsIGBtb2RlbGAgY29tcGxldGVseS4KICAgIHJlbW92ZUxpbmtzOiBmdW5jdGlvbihtb2RlbCkgewoKICAgICAgICBfLmludm9rZSh0aGlzLmdldENvbm5lY3RlZExpbmtzKG1vZGVsKSwgJ3JlbW92ZScpOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBhdCBnaXZlbiBwb2ludAogICAgZmluZE1vZGVsc0Zyb21Qb2ludDogZnVuY3Rpb24ocCkgewoKCXJldHVybiBfLmZpbHRlcih0aGlzLmdldEVsZW1lbnRzKCksIGZ1bmN0aW9uKGVsKSB7CgkgICAgcmV0dXJuIGVsLmdldEJCb3goKS5jb250YWluc1BvaW50KHApOwoJfSk7CiAgICB9LAoKICAgIC8vIEZpbmQgYWxsIHZpZXdzIGluIGdpdmVuIGFyZWEKICAgIGZpbmRNb2RlbHNJbkFyZWE6IGZ1bmN0aW9uKHIpIHsKCglyZXR1cm4gXy5maWx0ZXIodGhpcy5nZXRFbGVtZW50cygpLCBmdW5jdGlvbihlbCkgewoJICAgIHJldHVybiBlbC5nZXRCQm94KCkuaW50ZXJzZWN0KHIpOwoJfSk7CiAgICB9LAoKICAgIC8vIFJldHVybiB0aGUgYm91bmRpbmcgYm94IG9mIGFsbCBgZWxlbWVudHNgLgogICAgZ2V0QkJveDogZnVuY3Rpb24oZWxlbWVudHMpIHsKCgl2YXIgb3JpZ2luID0geyB4OiBJbmZpbml0eSwgeTogSW5maW5pdHkgfTsKCXZhciBjb3JuZXIgPSB7IHg6IDAsIHk6IDAgfTsKCQoJXy5lYWNoKGVsZW1lbnRzLCBmdW5jdGlvbihjZWxsKSB7CgkgICAgCgkgICAgdmFyIGJib3ggPSBjZWxsLmdldEJCb3goKTsKCSAgICBvcmlnaW4ueCA9IE1hdGgubWluKG9yaWdpbi54LCBiYm94LngpOwoJICAgIG9yaWdpbi55ID0gTWF0aC5taW4ob3JpZ2luLnksIGJib3gueSk7CgkgICAgY29ybmVyLnggPSBNYXRoLm1heChjb3JuZXIueCwgYmJveC54ICsgYmJveC53aWR0aCk7CgkgICAgY29ybmVyLnkgPSBNYXRoLm1heChjb3JuZXIueSwgYmJveC55ICsgYmJveC5oZWlnaHQpOwoJfSk7CgoJcmV0dXJuIGcucmVjdChvcmlnaW4ueCwgb3JpZ2luLnksIGNvcm5lci54IC0gb3JpZ2luLngsIGNvcm5lci55IC0gb3JpZ2luLnkpOwogICAgfQoKfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkdyYXBoID0gam9pbnQuZGlhLkdyYXBoOwp9CgovLyAgICAgIEpvaW50SlMuCi8vICAgICAgKGMpIDIwMTEtMjAxMyBjbGllbnQgSU8KCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgdmFyIGpvaW50ID0gewogICAgICAgIHV0aWw6IHJlcXVpcmUoJy4vY29yZScpLnV0aWwsCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKLy8gam9pbnQuZGlhLkNlbGwgYmFzZSBtb2RlbC4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCmpvaW50LmRpYS5DZWxsID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHsKCiAgICAvLyBUaGlzIGlzIHRoZSBzYW1lIGFzIEJhY2tib25lLk1vZGVsIHdpdGggdGhlIG9ubHkgZGlmZmVyZW5jZSB0aGF0IGlzIHVzZXMgXy5tZXJnZQogICAgLy8gaW5zdGVhZCBvZiBqdXN0IF8uZXh0ZW5kLiBUaGUgcmVhc29uIGlzIHRoYXQgd2Ugd2FudCB0byBtaXhpbiBhdHRyaWJ1dGVzIHNldCBpbiB1cHBlciBjbGFzc2VzLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKCiAgICAgICAgdmFyIGRlZmF1bHRzOwogICAgICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICAgICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjJyk7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247CiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzLCBvcHRpb25zKSB8fCB7fTsKICAgICAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgewogICAgICAgICAgICAvLzxjdXN0b20gY29kZT4KICAgICAgICAgICAgLy8gUmVwbGFjZWQgdGhlIGNhbGwgdG8gXy5kZWZhdWx0cyB3aXRoIF8ubWVyZ2UuCiAgICAgICAgICAgIGF0dHJzID0gXy5tZXJnZSh7fSwgZGVmYXVsdHMsIGF0dHJzKTsKICAgICAgICAgICAgLy88L2N1c3RvbSBjb2RlPgogICAgICAgIH0KICAgICAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgdGhpcy5jaGFuZ2VkID0ge307CiAgICAgICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHRvSlNPTjogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBkZWZhdWx0QXR0cnMgPSB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5kZWZhdWx0cy5hdHRycyB8fCB7fTsKICAgICAgICB2YXIgYXR0cnMgPSB0aGlzLmF0dHJpYnV0ZXMuYXR0cnM7CiAgICAgICAgdmFyIGZpbmFsQXR0cnMgPSB7fTsKCiAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgYXR0cmlidXRlcyBhbmQKICAgICAgICAvLyBvbWl0IHRoZSBkZWZhdWx0IGF0dHJpYnV0ZXMgYXMgdGhleSBhcmUgaW1wbGljaXRseSByZWNvbnN0cnVjdGFibGUgYnkgdGhlIGNlbGwgJ3R5cGUnLgogICAgICAgIF8uZWFjaChhdHRycywgZnVuY3Rpb24oYXR0ciwgc2VsZWN0b3IpIHsKCiAgICAgICAgICAgIHZhciBkZWZhdWx0QXR0ciA9IGRlZmF1bHRBdHRyc1tzZWxlY3Rvcl07CgogICAgICAgICAgICBfLmVhY2goYXR0ciwgZnVuY3Rpb24odmFsdWUsIG5hbWUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gYXR0ciBpcyBtYWlubHkgZmxhdCB0aG91Z2ggaXQgbWlnaHQgaGF2ZSBvbmUgbW9yZSBsZXZlbCAoY29uc2lkZXIgdGhlIGBzdHlsZWAgYXR0cmlidXRlKS4KICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBgdmFsdWVgIGlzIG9iamVjdCBhbmQgaWYgeWVzLCBnbyBvbmUgbGV2ZWwgZGVlcC4KICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHZhbHVlKSAmJiAhXy5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIF8uZWFjaCh2YWx1ZSwgZnVuY3Rpb24odmFsdWUyLCBuYW1lMikgewoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZWZhdWx0QXR0ciB8fCAhZGVmYXVsdEF0dHJbbmFtZV0gfHwgIV8uaXNFcXVhbChkZWZhdWx0QXR0cltuYW1lXVtuYW1lMl0sIHZhbHVlMikpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaW5hbEF0dHJzW3NlbGVjdG9yXSA9IGZpbmFsQXR0cnNbc2VsZWN0b3JdIHx8IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgKGZpbmFsQXR0cnNbc2VsZWN0b3JdW25hbWVdIHx8IChmaW5hbEF0dHJzW3NlbGVjdG9yXVtuYW1lXSA9IHt9KSlbbmFtZTJdID0gdmFsdWUyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgfSBlbHNlIGlmICghZGVmYXVsdEF0dHIgfHwgIV8uaXNFcXVhbChkZWZhdWx0QXR0cltuYW1lXSwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gYHZhbHVlYCBpcyBub3QgYW4gb2JqZWN0LCBkZWZhdWx0IGF0dHJpYnV0ZSBmb3Igc3VjaCBhIHNlbGVjdG9yIGRvZXMgbm90IGV4aXN0CiAgICAgICAgICAgICAgICAgICAgLy8gb3IgaXQgaXMgZGlmZmVyZW50IHRoYW4gdGhlIGF0dHJpYnV0ZSB2YWx1ZSBzZXQgb24gdGhlIG1vZGVsLgoKICAgICAgICAgICAgICAgICAgICBmaW5hbEF0dHJzW3NlbGVjdG9yXSA9IGZpbmFsQXR0cnNbc2VsZWN0b3JdIHx8IHt9OwogICAgICAgICAgICAgICAgICAgIGZpbmFsQXR0cnNbc2VsZWN0b3JdW25hbWVdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwoKICAgICAgICB2YXIgYXR0cmlidXRlcyA9IF8uY2xvbmVEZWVwKF8ub21pdCh0aGlzLmF0dHJpYnV0ZXMsICdhdHRycycpKTsKICAgICAgICAvL3ZhciBhdHRyaWJ1dGVzID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShfLm9taXQodGhpcy5hdHRyaWJ1dGVzLCAnYXR0cnMnKSkpOwogICAgICAgIGF0dHJpYnV0ZXMuYXR0cnMgPSBmaW5hbEF0dHJzOwoKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewoKICAgICAgICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuaWQpIHsKCiAgICAgICAgICAgIHRoaXMuc2V0KCdpZCcsIGpvaW50LnV0aWwudXVpZCgpLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgICB9CgoJdGhpcy5fdHJhbnNpdGlvbklkcyA9IHt9OwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIGRlZmluZWQgaW4gYGF0dHJzYCBhbmQga2VlcCBjb2xsZWN0aW5nIHdoZW5ldmVyIGBhdHRyc2Agb2JqZWN0IGNoYW5nZXMuCiAgICAgICAgdGhpcy5wcm9jZXNzUG9ydHMoKTsKICAgICAgICB0aGlzLm9uKCdjaGFuZ2U6YXR0cnMnLCB0aGlzLnByb2Nlc3NQb3J0cywgdGhpcyk7CiAgICB9LAoKICAgIHByb2Nlc3NQb3J0czogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIFdoZW5ldmVyIGBhdHRyc2AgY2hhbmdlcywgd2UgZXh0cmFjdCBwb3J0cyBmcm9tIHRoZSBgYXR0cnNgIG9iamVjdCBhbmQgc3RvcmUgaXQKICAgICAgICAvLyBpbiBhIG1vcmUgYWNjZXNzaWJsZSB3YXkuIEFsc28sIGlmIGFueSBwb3J0IGdvdCByZW1vdmVkIGFuZCB0aGVyZSB3ZXJlIGxpbmtzIHRoYXQgaGFkIGB0YXJnZXRgL2Bzb3VyY2VgCiAgICAgICAgLy8gc2V0IHRvIHRoYXQgcG9ydCwgd2UgcmVtb3ZlIHRob3NlIGxpbmtzIGFzIHdlbGwgKHRvIGZvbGxvdyB0aGUgc2FtZSBiZWhhdmlvdXIgYXMKICAgICAgICAvLyB3aXRoIGEgcmVtb3ZlZCBlbGVtZW50KS4KCiAgICAgICAgdmFyIHByZXZpb3VzUG9ydHMgPSB0aGlzLnBvcnRzOwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIGZyb20gdGhlIGBhdHRyc2Agb2JqZWN0LgogICAgICAgIHZhciBwb3J0cyA9IHt9OwogICAgICAgIF8uZWFjaCh0aGlzLmdldCgnYXR0cnMnKSwgZnVuY3Rpb24oYXR0cnMsIHNlbGVjdG9yKSB7CgogICAgICAgICAgICBpZiAoYXR0cnMgJiYgYXR0cnMucG9ydCkgewoKICAgICAgICAgICAgICAgIC8vIGBwb3J0YCBjYW4gZWl0aGVyIGJlIGRpcmVjdGx5IGFuIGBpZGAgb3IgYW4gb2JqZWN0IGNvbnRhaW5pbmcgYW4gYGlkYCAoYW5kIHBvdGVudGlhbGx5IG90aGVyIGRhdGEpLgogICAgICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLnBvcnQuaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgcG9ydHNbYXR0cnMucG9ydC5pZF0gPSBhdHRycy5wb3J0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBwb3J0c1thdHRycy5wb3J0XSA9IHsgaWQ6IGF0dHJzLnBvcnQgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBDb2xsZWN0IHBvcnRzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgKGNvbXBhcmVkIHRvIHRoZSBwcmV2aW91cyBwb3J0cykgLSBpZiBhbnkuCiAgICAgICAgLy8gVXNlIGhhc2ggdGFibGUgZm9yIHF1aWNrIGxvb2t1cC4KICAgICAgICB2YXIgcmVtb3ZlZFBvcnRzID0ge307CiAgICAgICAgXy5lYWNoKHByZXZpb3VzUG9ydHMsIGZ1bmN0aW9uKHBvcnQsIGlkKSB7CgogICAgICAgICAgICBpZiAoIXBvcnRzW2lkXSkgcmVtb3ZlZFBvcnRzW2lkXSA9IHRydWU7CiAgICAgICAgfSk7CgogICAgICAgIC8vIFJlbW92ZSBhbGwgdGhlIGluY29taW5nL291dGdvaW5nIGxpbmtzIHRoYXQgaGF2ZSBzb3VyY2UvdGFyZ2V0IHBvcnQgc2V0IHRvIGFueSBvZiB0aGUgcmVtb3ZlZCBwb3J0cy4KICAgICAgICBpZiAodGhpcy5jb2xsZWN0aW9uICYmICFfLmlzRW1wdHkocmVtb3ZlZFBvcnRzKSkgewogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIGluYm91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyh0aGlzLCB7IGluYm91bmQ6IHRydWUgfSk7CiAgICAgICAgICAgIF8uZWFjaChpbmJvdW5kTGlua3MsIGZ1bmN0aW9uKGxpbmspIHsKCiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZFBvcnRzW2xpbmsuZ2V0KCd0YXJnZXQnKS5wb3J0XSkgbGluay5yZW1vdmUoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgb3V0Ym91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyh0aGlzLCB7IG91dGJvdW5kOiB0cnVlIH0pOwogICAgICAgICAgICBfLmVhY2gob3V0Ym91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgIGlmIChyZW1vdmVkUG9ydHNbbGluay5nZXQoJ3NvdXJjZScpLnBvcnRdKSBsaW5rLnJlbW92ZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgYHBvcnRzYCBvYmplY3QuCiAgICAgICAgdGhpcy5wb3J0cyA9IHBvcnRzOwogICAgfSwKCiAgICByZW1vdmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCgl2YXIgY29sbGVjdGlvbiA9IHRoaXMuY29sbGVjdGlvbjsKCglpZiAoY29sbGVjdGlvbikgewoJICAgIGNvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCX0KCiAgICAgICAgLy8gRmlyc3QsIHVuZW1iZWQgdGhpcyBjZWxsIGZyb20gaXRzIHBhcmVudCBjZWxsIGlmIHRoZXJlIGlzIG9uZS4KICAgICAgICB2YXIgcGFyZW50Q2VsbElkID0gdGhpcy5nZXQoJ3BhcmVudCcpOwogICAgICAgIGlmIChwYXJlbnRDZWxsSWQpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciBwYXJlbnRDZWxsID0gdGhpcy5jb2xsZWN0aW9uICYmIHRoaXMuY29sbGVjdGlvbi5nZXQocGFyZW50Q2VsbElkKTsKICAgICAgICAgICAgcGFyZW50Q2VsbC51bmVtYmVkKHRoaXMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBfLmludm9rZSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgJ3JlbW92ZScsIG9wdGlvbnMpOwogICAgICAgIAogICAgICAgIHRoaXMudHJpZ2dlcigncmVtb3ZlJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uLCBvcHRpb25zKTsKCglpZiAoY29sbGVjdGlvbikgewoJICAgIGNvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoJfQoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICB0b0Zyb250OiBmdW5jdGlvbigpIHsKCiAgICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewoKICAgICAgICAgICAgdGhpcy5zZXQoJ3onLCAodGhpcy5jb2xsZWN0aW9uLmxhc3QoKS5nZXQoJ3onKSB8fCAwKSArIDEpOwogICAgICAgIH0KCglyZXR1cm4gdGhpczsKICAgIH0sCiAgICAKICAgIHRvQmFjazogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRoaXMuc2V0KCd6JywgKHRoaXMuY29sbGVjdGlvbi5maXJzdCgpLmdldCgneicpIHx8IDApIC0gMSk7CiAgICAgICAgfQoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICBlbWJlZDogZnVuY3Rpb24oY2VsbCkgewoKCWlmICh0aGlzLmdldCgncGFyZW50JykgPT0gY2VsbC5pZCkgewoKCSAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlY3Vyc2l2ZSBlbWJlZGRpbmcgbm90IGFsbG93ZWQuJyk7CgoJfSBlbHNlIHsKCgkgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdGFydCcpOwoKCSAgICBjZWxsLnNldCgncGFyZW50JywgdGhpcy5pZCk7CgkgICAgdGhpcy5zZXQoJ2VtYmVkcycsIF8udW5pcSgodGhpcy5nZXQoJ2VtYmVkcycpIHx8IFtdKS5jb25jYXQoW2NlbGwuaWRdKSkpOwoKCSAgICB0aGlzLnRyaWdnZXIoJ2JhdGNoOnN0b3AnKTsKCX0KCglyZXR1cm4gdGhpczsKICAgIH0sCgogICAgdW5lbWJlZDogZnVuY3Rpb24oY2VsbCkgewoKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCiAgICAgICAgdmFyIGNlbGxJZCA9IGNlbGwuaWQ7CiAgICAgICAgY2VsbC51bnNldCgncGFyZW50Jyk7CgogICAgICAgIHRoaXMuc2V0KCdlbWJlZHMnLCBfLndpdGhvdXQodGhpcy5nZXQoJ2VtYmVkcycpLCBjZWxsSWQpKTsKCgl0aGlzLnRyaWdnZXIoJ2JhdGNoOnN0b3AnKTsKCglyZXR1cm4gdGhpczsKICAgIH0sCgogICAgZ2V0RW1iZWRkZWRDZWxsczogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIENlbGwgbW9kZWxzIGNhbiBvbmx5IGJlIHJldHJpZXZlZCB3aGVuIHRoaXMgZWxlbWVudCBpcyBwYXJ0IG9mIGEgY29sbGVjdGlvbi4KICAgICAgICAvLyBUaGVyZSBpcyBubyB3YXkgdGhpcyBlbGVtZW50IGtub3dzIGFib3V0IG90aGVyIGNlbGxzIG90aGVyd2lzZS4KICAgICAgICAvLyBUaGlzIGFsc28gbWVhbnMgdGhhdCBjYWxsaW5nIGUuZy4gYHRyYW5zbGF0ZSgpYCBvbiBhbiBlbGVtZW50IHdpdGggZW1iZWRzIGJlZm9yZQogICAgICAgIC8vIGFkZGluZyBpdCB0byBhIGdyYXBoIGRvZXMgbm90IHRyYW5zbGF0ZSBpdHMgZW1iZWRzLgogICAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKCiAgICAgICAgICAgIHJldHVybiBfLm1hcCh0aGlzLmdldCgnZW1iZWRzJykgfHwgW10sIGZ1bmN0aW9uKGNlbGxJZCkgewoKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb24uZ2V0KGNlbGxJZCk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgIH0sCgogICAgY2xvbmU6IGZ1bmN0aW9uKG9wdCkgewoKICAgICAgICBvcHQgPSBvcHQgfHwge307CgogICAgICAgIHZhciBjbG9uZSA9IEJhY2tib25lLk1vZGVsLnByb3RvdHlwZS5jbG9uZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIGNsb25lIHRvIGhhdmUgdGhlIHNhbWUgSUQgYXMgdGhlIG9yaWdpbmFsLgogICAgICAgIGNsb25lLnNldCgnaWQnLCBqb2ludC51dGlsLnV1aWQoKSwgeyBzaWxlbnQ6IHRydWUgfSk7CiAgICAgICAgY2xvbmUuc2V0KCdlbWJlZHMnLCAnJyk7CgogICAgICAgIGlmICghb3B0LmRlZXApIHJldHVybiBjbG9uZTsKCiAgICAgICAgLy8gVGhlIHJlc3Qgb2YgdGhlIGBjbG9uZSgpYCBtZXRob2QgZGVhbHMgd2l0aCBlbWJlZHMuIElmIGBkZWVwYCBvcHRpb24gaXMgc2V0IHRvIGB0cnVlYCwKICAgICAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIGlzIGFuIGFycmF5IG9mIGFsbCB0aGUgZW1iZWRkZWQgY2xvbmVzIGNyZWF0ZWQuCgogICAgICAgIHZhciBlbWJlZHMgPSBfLnNvcnRCeSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgZnVuY3Rpb24oY2VsbCkgewogICAgICAgICAgICAvLyBTb3J0IGVtYmVkcyB0aGF0IGxpbmtzIGNvbWUgYmVmb3JlIGVsZW1lbnRzLgogICAgICAgICAgICByZXR1cm4gY2VsbCBpbnN0YW5jZW9mIGpvaW50LmRpYS5FbGVtZW50OwogICAgICAgIH0pOwoKICAgICAgICB2YXIgY2xvbmVzID0gW2Nsb25lXTsKCiAgICAgICAgLy8gVGhpcyBtYXBwaW5nIHN0b3JlcyBjbG9uZWQgbGlua3MgdW5kZXIgdGhlIGBpZGBzIG9mIHRoZXkgb3JpZ2luYWxzLgogICAgICAgIC8vIFRoaXMgcHJldmVudHMgY2xvbmluZyBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuIENvbnNpZGVyIGEgbGluayAnc2VsZiBsb29wJyBmb3IgZXhhbXBsZS4KICAgICAgICB2YXIgbGlua0Nsb25lTWFwcGluZyA9IHt9OwogICAgICAgIAogICAgICAgIF8uZWFjaChlbWJlZHMsIGZ1bmN0aW9uKGVtYmVkKSB7CgogICAgICAgICAgICB2YXIgZW1iZWRDbG9uZXMgPSBlbWJlZC5jbG9uZSh7IGRlZXA6IHRydWUgfSk7CgogICAgICAgICAgICAvLyBFbWJlZCB0aGUgZmlyc3QgY2xvbmUgcmV0dXJuZWQgZnJvbSBgY2xvbmUoeyBkZWVwOiB0cnVlIH0pYCBhYm92ZS4gVGhlIGZpcnN0CiAgICAgICAgICAgIC8vIGNlbGwgaXMgYWx3YXlzIHRoZSBjbG9uZSBvZiB0aGUgY2VsbCB0aGF0IGNhbGxlZCB0aGUgYGNsb25lKClgIG1ldGhvZCwgaS5lLiBjbG9uZSBvZiBgZW1iZWRgIGluIHRoaXMgY2FzZS4KICAgICAgICAgICAgY2xvbmUuZW1iZWQoZW1iZWRDbG9uZXNbMF0pOwoKICAgICAgICAgICAgXy5lYWNoKGVtYmVkQ2xvbmVzLCBmdW5jdGlvbihlbWJlZENsb25lKSB7CgogICAgICAgICAgICAgICAgaWYgKGVtYmVkQ2xvbmUgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluaykgewoKICAgICAgICAgICAgICAgICAgICBpZiAoZW1iZWRDbG9uZS5nZXQoJ3NvdXJjZScpLmlkID09IHRoaXMuaWQpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBfLmNsb25lKGVtYmVkQ2xvbmUuZ2V0KCdzb3VyY2UnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZS5pZCA9IGNsb25lLmlkOwogICAgICAgICAgICAgICAgICAgICAgICBlbWJlZENsb25lLnNldCgnc291cmNlJywgc291cmNlKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChlbWJlZENsb25lLmdldCgndGFyZ2V0JykuaWQgPT0gdGhpcy5pZCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IF8uY2xvbmUoZW1iZWRDbG9uZS5nZXQoJ3RhcmdldCcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LmlkID0gY2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGVtYmVkQ2xvbmUuc2V0KCd0YXJnZXQnLCB0YXJnZXQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tlbWJlZC5pZF0gPSBlbWJlZENsb25lOwoKICAgICAgICAgICAgICAgICAgICAvLyBTa2lwIGxpbmtzLiBJbmJvdW5kL291dGJvdW5kIGxpbmtzIGFyZSBub3QgcmVsZXZhbnQgZm9yIHRoZW0uCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNsb25lcy5wdXNoKGVtYmVkQ2xvbmUpOwoKICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgYWxsIGluYm91bmQgbGlua3MsIGNsb25lIHRoZW0gKGlmIG5vdCBkb25lIGFscmVhZHkpIGFuZCBzZXQgdGhlaXIgdGFyZ2V0IHRvIHRoZSBgZW1iZWRDbG9uZS5pZGAuCiAgICAgICAgICAgICAgICB2YXIgaW5ib3VuZExpbmtzID0gdGhpcy5jb2xsZWN0aW9uLmdldENvbm5lY3RlZExpbmtzKGVtYmVkLCB7IGluYm91bmQ6IHRydWUgfSk7CgogICAgICAgICAgICAgICAgXy5lYWNoKGluYm91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0Nsb25lID0gbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSB8fCBsaW5rLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBjbG9uZSBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSA9IGxpbmtDbG9uZTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IF8uY2xvbmUobGlua0Nsb25lLmdldCgndGFyZ2V0JykpOwogICAgICAgICAgICAgICAgICAgIHRhcmdldC5pZCA9IGVtYmVkQ2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lLnNldCgndGFyZ2V0JywgdGFyZ2V0KTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgYWxsIGluYm91bmQgbGlua3MsIGNsb25lIHRoZW0gKGlmIG5vdCBkb25lIGFscmVhZHkpIGFuZCBzZXQgdGhlaXIgc291cmNlIHRvIHRoZSBgZW1iZWRDbG9uZS5pZGAuCiAgICAgICAgICAgICAgICB2YXIgb3V0Ym91bmRMaW5rcyA9IHRoaXMuY29sbGVjdGlvbi5nZXRDb25uZWN0ZWRMaW5rcyhlbWJlZCwgeyBvdXRib3VuZDogdHJ1ZSB9KTsKCiAgICAgICAgICAgICAgICBfLmVhY2gob3V0Ym91bmRMaW5rcywgZnVuY3Rpb24obGluaykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgbGlua0Nsb25lID0gbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSB8fCBsaW5rLmNsb25lKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB3ZSBkb24ndCBjbG9uZSBhIGxpbmsgbW9yZSB0aGVuIG9uY2UuCiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lTWFwcGluZ1tsaW5rLmlkXSA9IGxpbmtDbG9uZTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IF8uY2xvbmUobGlua0Nsb25lLmdldCgnc291cmNlJykpOwogICAgICAgICAgICAgICAgICAgIHNvdXJjZS5pZCA9IGVtYmVkQ2xvbmUuaWQ7CiAgICAgICAgICAgICAgICAgICAgbGlua0Nsb25lLnNldCgnc291cmNlJywgc291cmNlKTsKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAgIAogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAvLyBBZGQgbGluayBjbG9uZXMgdG8gdGhlIGFycmF5IG9mIGFsbCB0aGUgbmV3IGNsb25lcy4KICAgICAgICBjbG9uZXMgPSBjbG9uZXMuY29uY2F0KF8udmFsdWVzKGxpbmtDbG9uZU1hcHBpbmcpKTsKCiAgICAgICAgcmV0dXJuIGNsb25lczsKICAgIH0sCgogICAgLy8gQSBjb252ZW5pZW50IHdheSB0byBzZXQgbmVzdGVkIGF0dHJpYnV0ZXMuCiAgICBhdHRyOiBmdW5jdGlvbihhdHRycywgdmFsdWUsIG9wdCkgewoKICAgICAgICB2YXIgY3VycmVudEF0dHJzID0gdGhpcy5nZXQoJ2F0dHJzJyk7CiAgICAgICAgdmFyIGRlbGltID0gJy8nOwogICAgICAgIAogICAgICAgIGlmIChfLmlzU3RyaW5nKGF0dHJzKSkgewogICAgICAgICAgICAvLyBHZXQvc2V0IGFuIGF0dHJpYnV0ZSBieSBhIHNwZWNpYWwgcGF0aCBzeW50YXggdGhhdCBkZWxpbWl0cwogICAgICAgICAgICAvLyBuZXN0ZWQgb2JqZWN0cyBieSB0aGUgY29sb24gY2hhcmFjdGVyLgoKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPSAndW5kZWZpbmVkJykgewoKICAgICAgICAgICAgICAgIHZhciBhdHRyID0ge307CiAgICAgICAgICAgICAgICBqb2ludC51dGlsLnNldEJ5UGF0aChhdHRyLCBhdHRycywgdmFsdWUsIGRlbGltKTsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCgnYXR0cnMnLCBfLm1lcmdlKHt9LCBjdXJyZW50QXR0cnMsIGF0dHIpLCBvcHQpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBqb2ludC51dGlsLmdldEJ5UGF0aChjdXJyZW50QXR0cnMsIGF0dHJzLCBkZWxpbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KCdhdHRycycsIF8ubWVyZ2Uoe30sIGN1cnJlbnRBdHRycywgYXR0cnMpLCB2YWx1ZSwgb3B0KTsKICAgIH0sCgogICAgLy8gQSBjb252ZW5pZW50IHdheSB0byB1bnNldCBuZXN0ZWQgYXR0cmlidXRlcwogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24ocGF0aCwgb3B0KSB7CgogICAgICAgIGlmIChfLmlzQXJyYXkocGF0aCkpIHsKICAgICAgICAgICAgXy5lYWNoKHBhdGgsIGZ1bmN0aW9uKHApIHsgdGhpcy5yZW1vdmVBdHRyKHAsIG9wdCk7IH0sIHRoaXMpOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIGF0dHJzID0gam9pbnQudXRpbC51bnNldEJ5UGF0aChfLm1lcmdlKHt9LCB0aGlzLmdldCgnYXR0cnMnKSksIHBhdGgsICcvJyk7CgogICAgICAgIHJldHVybiB0aGlzLnNldCgnYXR0cnMnLCBhdHRycywgXy5leHRlbmQoeyBkaXJ0eTogdHJ1ZSB9LCBvcHQpKTsKICAgIH0sCgogICAgdHJhbnNpdGlvbjogZnVuY3Rpb24ocGF0aCwgdmFsdWUsIG9wdCwgZGVsaW0pIHsKCglkZWxpbSA9IGRlbGltIHx8ICcvJzsKCgl2YXIgZGVmYXVsdHMgPSB7CgkgICAgZHVyYXRpb246IDEwMCwKCSAgICBkZWxheTogMTAsCgkgICAgdGltaW5nRnVuY3Rpb246IGpvaW50LnV0aWwudGltaW5nLmxpbmVhciwKCSAgICB2YWx1ZUZ1bmN0aW9uOiBqb2ludC51dGlsLmludGVycG9sYXRlLm51bWJlcgoJfTsKCglvcHQgPSBfLmV4dGVuZChkZWZhdWx0cywgb3B0KTsKCgl2YXIgcGF0aEFycmF5ID0gcGF0aC5zcGxpdChkZWxpbSk7CiAgICAgICAgdmFyIHByb3BlcnR5ID0gcGF0aEFycmF5WzBdOwoJdmFyIGlzUHJvcGVydHlOZXN0ZWQgPSBwYXRoQXJyYXkubGVuZ3RoID4gMTsKCXZhciBmaXJzdEZyYW1lVGltZSA9IDA7Cgl2YXIgaW50ZXJwb2xhdGluZ0Z1bmN0aW9uOwoKCXZhciBzZXR0ZXIgPSBfLmJpbmQoZnVuY3Rpb24ocnVudGltZSkgewoKCSAgICB2YXIgaWQsIHByb2dyZXNzLCBwcm9wZXJ0eVZhbHVlLCBzdGF0dXM7CgoJICAgIGZpcnN0RnJhbWVUaW1lID0gZmlyc3RGcmFtZVRpbWUgfHwgcnVudGltZTsKCSAgICBydW50aW1lIC09IGZpcnN0RnJhbWVUaW1lOwoJICAgIHByb2dyZXNzID0gcnVudGltZSAvIG9wdC5kdXJhdGlvbjsKCgkgICAgaWYgKHByb2dyZXNzIDwgMSkgewoJCXRoaXMuX3RyYW5zaXRpb25JZHNbcGF0aF0gPSBpZCA9IGpvaW50LnV0aWwubmV4dEZyYW1lKHNldHRlcik7CgkgICAgfSBlbHNlIHsKCQlwcm9ncmVzcyA9IDE7CgkJZGVsZXRlIHRoaXMuX3RyYW5zaXRpb25JZHNbcGF0aF07CgkgICAgfQoKCSAgICBwcm9wZXJ0eVZhbHVlID0gaW50ZXJwb2xhdGluZ0Z1bmN0aW9uKG9wdC50aW1pbmdGdW5jdGlvbihwcm9ncmVzcykpOwoKCSAgICBpZiAoaXNQcm9wZXJ0eU5lc3RlZCkgewoJCXZhciBuZXN0ZWRQcm9wZXJ0eVZhbHVlID0gam9pbnQudXRpbC5zZXRCeVBhdGgoe30sIHBhdGgsIHByb3BlcnR5VmFsdWUsIGRlbGltKVtwcm9wZXJ0eV07CgkJcHJvcGVydHlWYWx1ZSA9IF8ubWVyZ2Uoe30sIHRoaXMuZ2V0KHByb3BlcnR5KSwgbmVzdGVkUHJvcGVydHlWYWx1ZSk7CgkgICAgfQoKCSAgICBvcHQudHJhbnNpdGlvbklkID0gaWQ7CgoJICAgIHRoaXMuc2V0KHByb3BlcnR5LCBwcm9wZXJ0eVZhbHVlLCBvcHQpOwoKCSAgICBpZiAoIWlkKSB0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246ZW5kJywgdGhpcywgcGF0aCk7CgoJfSwgdGhpcyk7CgoJdmFyIGluaXRpYXRvciA9Xy5iaW5kKGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgoJICAgIHRoaXMuc3RvcFRyYW5zaXRpb25zKHBhdGgpOwoKCSAgICBpbnRlcnBvbGF0aW5nRnVuY3Rpb24gPSBvcHQudmFsdWVGdW5jdGlvbihqb2ludC51dGlsLmdldEJ5UGF0aCh0aGlzLmF0dHJpYnV0ZXMsIHBhdGgsIGRlbGltKSwgdmFsdWUpOwoKCSAgICB0aGlzLl90cmFuc2l0aW9uSWRzW3BhdGhdID0gam9pbnQudXRpbC5uZXh0RnJhbWUoY2FsbGJhY2spOwoKCSAgICB0aGlzLnRyaWdnZXIoJ3RyYW5zaXRpb246c3RhcnQnLCB0aGlzLCBwYXRoKTsKCgl9LCB0aGlzKTsKCglyZXR1cm4gXy5kZWxheShpbml0aWF0b3IsIG9wdC5kZWxheSwgc2V0dGVyKTsKICAgIH0sCgogICAgZ2V0VHJhbnNpdGlvbnM6IGZ1bmN0aW9uKCkgewoJcmV0dXJuIF8ua2V5cyh0aGlzLl90cmFuc2l0aW9uSWRzKTsKICAgIH0sCgogICAgc3RvcFRyYW5zaXRpb25zOiBmdW5jdGlvbihwYXRoLCBkZWxpbSkgewoKCWRlbGltID0gZGVsaW0gfHwgJy8nOwoKCXZhciBwYXRoQXJyYXkgPSBwYXRoICYmIHBhdGguc3BsaXQoZGVsaW0pOwoKCV8odGhpcy5fdHJhbnNpdGlvbklkcykua2V5cygpLmZpbHRlcihwYXRoQXJyYXkgJiYgZnVuY3Rpb24oa2V5KSB7CgoJICAgIHJldHVybiBfLmlzRXF1YWwocGF0aEFycmF5LCBrZXkuc3BsaXQoZGVsaW0pLnNsaWNlKDAsIHBhdGhBcnJheS5sZW5ndGgpKTsKCgl9KS5lYWNoKGZ1bmN0aW9uKGtleSkgewoKCSAgICBqb2ludC51dGlsLmNhbmNlbEZyYW1lKHRoaXMuX3RyYW5zaXRpb25JZHNba2V5XSk7CgoJICAgIGRlbGV0ZSB0aGlzLl90cmFuc2l0aW9uSWRzW2tleV07CgoJICAgIHRoaXMudHJpZ2dlcigndHJhbnNpdGlvbjplbmQnLCB0aGlzLCBrZXkpOwoKCX0sIHRoaXMpOwoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBBIHNob3JjdXQgbWFraW5nIGl0IGVhc3kgdG8gY3JlYXRlIGNvbnN0cnVjdHMgbGlrZSB0aGUgZm9sbG93aW5nOgogICAgLy8gYHZhciBlbCA9IChuZXcgam9pbnQuc2hhcGVzLmJhc2ljLlJlY3QpLmFkZFRvKGdyYXBoKWAuCiAgICBhZGRUbzogZnVuY3Rpb24oZ3JhcGgpIHsKCglncmFwaC5hZGRDZWxsKHRoaXMpOwoJcmV0dXJuIHRoaXM7CiAgICB9Cn0pOwoKLy8gam9pbnQuZGlhLkNlbGxWaWV3IGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCi8vIFRoaXMgaXMgdGhlIGJhc2UgdmlldyBhbmQgY29udHJvbGxlciBmb3IgYGpvaW50LmRpYS5FbGVtZW50Vmlld2AgYW5kIGBqb2ludC5kaWEuTGlua1ZpZXdgLgoKam9pbnQuZGlhLkNlbGxWaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoewoKICAgIHRhZ05hbWU6ICdnJywKCiAgICBhdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgcmV0dXJuIHsgJ21vZGVsLWlkJzogdGhpcy5tb2RlbC5pZCB9CiAgICB9LAoKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CgoJdGhpcy5fY29uZmlndXJlKG9wdGlvbnMpOwoJQmFja2JvbmUuVmlldy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CgoJaWYgKHRoaXMub3B0aW9ucykgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnb3B0aW9ucycpLCBvcHRpb25zKTsKCXRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgLy8gTWFrZSBzdXJlIGEgZ2xvYmFsIHVuaXF1ZSBpZCBpcyBhc3NpZ25lZCB0byB0aGlzIHZpZXcuIFN0b3JlIHRoaXMgaWQgYWxzbyB0byB0aGUgcHJvcGVydGllcyBvYmplY3QuCiAgICAgICAgLy8gVGhlIGdsb2JhbCB1bmlxdWUgaWQgbWFrZXMgc3VyZSB0aGF0IHRoZSBzYW1lIHZpZXcgY2FuIGJlIHJlbmRlcmVkIG9uIGUuZy4gZGlmZmVyZW50IG1hY2hpbmVzIGFuZAogICAgICAgIC8vIHN0aWxsIGJlIGFzc29jaWF0ZWQgdG8gdGhlIHNhbWUgb2JqZWN0IGFtb25nIGFsbCB0aG9zZSBjbGllbnRzLiBUaGlzIGlzIG5lY2Vzc2FyeSBmb3IgcmVhbC10aW1lCiAgICAgICAgLy8gY29sbGFib3JhdGlvbiBtZWNoYW5pc20uCiAgICAgICAgdGhpcy5vcHRpb25zLmlkID0gdGhpcy5vcHRpb25zLmlkIHx8IGpvaW50LnV0aWwuZ3VpZCh0aGlzKTsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIF8uYmluZEFsbCh0aGlzLCAncmVtb3ZlJywgJ3VwZGF0ZScpOwoKICAgICAgICAvLyBTdG9yZSByZWZlcmVuY2UgdG8gdGhpcyB0byB0aGUgPGc+IERPTSBlbGVtZW50IHNvIHRoYXQgdGhlIHZpZXcgaXMgYWNjZXNzaWJsZSB0aHJvdWdoIHRoZSBET00gdHJlZS4KICAgICAgICB0aGlzLiRlbC5kYXRhKCd2aWV3JywgdGhpcyk7CgoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAncmVtb3ZlJywgdGhpcy5yZW1vdmUpOwoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOmF0dHJzJywgdGhpcy5vbkNoYW5nZUF0dHJzKTsKICAgIH0sCgogICAgb25DaGFuZ2VBdHRyczogZnVuY3Rpb24oY2VsbCwgYXR0cnMsIG9wdCkgewoKICAgICAgICBpZiAob3B0LmRpcnR5KSB7CgogICAgICAgICAgICAvLyBkaXJ0eSBmbGFnIGNvdWxkIGJlIHNldCB3aGVuIGEgbW9kZWwgYXR0cmlidXRlIHdhcyByZW1vdmVkIGFuZCBpdCBuZWVkcyB0byBiZSBjbGVhcmVkCiAgICAgICAgICAgIC8vIGFsc28gZnJvbSB0aGUgRE9NIGVsZW1lbnQuIFNlZSBjZWxsLnJlbW92ZUF0dHIoKS4KICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy51cGRhdGUoKTsKICAgIH0sCgogICAgLy8gT3ZlcnJpZGUgdGhlIEJhY2tib25lIGBfZW5zdXJlRWxlbWVudCgpYCBtZXRob2QgaW4gb3JkZXIgdG8gY3JlYXRlIGEgYDxnPmAgbm9kZSB0aGF0IHdyYXBzCiAgICAvLyBhbGwgdGhlIG5vZGVzIG9mIHRoZSBDZWxsIHZpZXcuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBlbDsKCiAgICAgICAgaWYgKCF0aGlzLmVsKSB7CgogICAgICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7IGlkOiB0aGlzLmlkIH0sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOwogICAgICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgICAgICBlbCA9IFYoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLm5vZGU7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBlbCA9IF8ucmVzdWx0KHRoaXMsICdlbCcpCiAgICAgICAgfQoKICAgICAgICB0aGlzLnNldEVsZW1lbnQoZWwsIGZhbHNlKTsKICAgIH0sCiAgICAKICAgIGZpbmRCeVNlbGVjdG9yOiBmdW5jdGlvbihzZWxlY3RvcikgewoKICAgICAgICAvLyBUaGVzZSBhcmUgZWl0aGVyIGRlc2NlbmRhbnRzIG9mIGB0aGlzLiRlbGAgb2YgYHRoaXMuJGVsYCBpdHNlbGYuIAogICAgICAgLy8gYC5gIGlzIGEgc3BlY2lhbCBzZWxlY3RvciB1c2VkIHRvIHNlbGVjdCB0aGUgd3JhcHBpbmcgYDxnPmAgZWxlbWVudC4KICAgICAgICB2YXIgJHNlbGVjdGVkID0gc2VsZWN0b3IgPT09ICcuJyA/IHRoaXMuJGVsIDogdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICAgICAgcmV0dXJuICRzZWxlY3RlZDsKICAgIH0sCgogICAgbm90aWZ5OiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgaWYgKHRoaXMucGFwZXIpIHsKCiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgICAgICAgICAgIC8vIFRyaWdnZXIgdGhlIGV2ZW50IG9uIGJvdGggdGhlIGVsZW1lbnQgaXRzZWxmIGFuZCBhbHNvIG9uIHRoZSBwYXBlci4KICAgICAgICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFtldnRdLmNvbmNhdChhcmdzKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBQYXBlciBldmVudCBoYW5kbGVycyByZWNlaXZlIHRoZSB2aWV3IG9iamVjdCBhcyB0aGUgZmlyc3QgYXJndW1lbnQuCiAgICAgICAgICAgIHRoaXMucGFwZXIudHJpZ2dlci5hcHBseSh0aGlzLnBhcGVyLCBbZXZ0LCB0aGlzXS5jb25jYXQoYXJncykpOwogICAgICAgIH0KICAgIH0sCgogICAgZ2V0U3Ryb2tlQkJveDogZnVuY3Rpb24oZWwpIHsKICAgICAgICAvLyBSZXR1cm4gYSBib3VuZGluZyBib3ggcmVjdGFuZ2xlIHRoYXQgdGFrZXMgaW50byBhY2NvdW50IHN0cm9rZS4KICAgICAgICAvLyBOb3RlIHRoYXQgdGhpcyBpcyBhIG5haXZlIGFuZCBhZC1ob2MgaW1wbGVtZW50YXRpb24gdGhhdCBkb2VzIG5vdAogICAgICAgIC8vIHdvcmtzIG9ubHkgaW4gY2VydGFpbiBjYXNlcyBhbmQgc2hvdWxkIGJlIHJlcGxhY2VkIGFzIHNvb24gYXMgYnJvd3NlcnMgd2lsbAogICAgICAgIC8vIHN0YXJ0IHN1cHBvcnRpbmcgdGhlIGdldFN0cm9rZUJCb3goKSBTVkcgbWV0aG9kLgogICAgICAgIC8vIEBUT0RPIGFueSBiZXR0ZXIgc29sdXRpb24gaXMgdmVyeSB3ZWxjb21lIQoKICAgICAgICB2YXIgaXNNYWduZXQgPSAhIWVsOwogICAgICAgIAogICAgICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgICAgICB2YXIgYmJveCA9IFYoZWwpLmJib3goZmFsc2UsIHRoaXMucGFwZXIudmlld3BvcnQpOwoKICAgICAgICB2YXIgc3Ryb2tlV2lkdGg7CiAgICAgICAgaWYgKGlzTWFnbmV0KSB7CgogICAgICAgICAgICBzdHJva2VXaWR0aCA9IFYoZWwpLmF0dHIoJ3N0cm9rZS13aWR0aCcpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgc3Ryb2tlV2lkdGggPSB0aGlzLm1vZGVsLmF0dHIoJ3JlY3Qvc3Ryb2tlLXdpZHRoJykgfHwgdGhpcy5tb2RlbC5hdHRyKCdjaXJjbGUvc3Ryb2tlLXdpZHRoJykgfHwgdGhpcy5tb2RlbC5hdHRyKCdlbGxpcHNlL3N0cm9rZS13aWR0aCcpIHx8IHRoaXMubW9kZWwuYXR0cigncGF0aC9zdHJva2Utd2lkdGgnKTsKICAgICAgICB9CgogICAgICAgIHN0cm9rZVdpZHRoID0gcGFyc2VGbG9hdChzdHJva2VXaWR0aCkgfHwgMDsKCiAgICAgICAgcmV0dXJuIGcucmVjdChiYm94KS5tb3ZlQW5kRXhwYW5kKHsgeDogLXN0cm9rZVdpZHRoLzIsIHk6IC1zdHJva2VXaWR0aC8yLCB3aWR0aDogc3Ryb2tlV2lkdGgsIGhlaWdodDogc3Ryb2tlV2lkdGggfSk7CiAgICB9LAogICAgCiAgICBnZXRCQm94OiBmdW5jdGlvbigpIHsKCiAgICAgICAgcmV0dXJuIFYodGhpcy5lbCkuYmJveCgpOwogICAgfSwKCiAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uKGVsKSB7CgogICAgICAgIGVsID0gIWVsID8gdGhpcy5lbCA6IHRoaXMuJChlbClbMF0gfHwgdGhpcy5lbDsKCiAgICAgICAgVihlbCkuYWRkQ2xhc3MoJ2hpZ2hsaWdodGVkJyk7CiAgICB9LAoKICAgIHVuaGlnaGxpZ2h0OiBmdW5jdGlvbihlbCkgewoKICAgICAgICBlbCA9ICFlbCA/IHRoaXMuZWwgOiB0aGlzLiQoZWwpWzBdIHx8IHRoaXMuZWw7CgogICAgICAgIFYoZWwpLnJlbW92ZUNsYXNzKCdoaWdobGlnaHRlZCcpOwogICAgfSwKCiAgICAvLyBGaW5kIHRoZSBjbG9zZXN0IGVsZW1lbnQgdGhhdCBoYXMgdGhlIGBtYWduZXRgIGF0dHJpYnV0ZSBzZXQgdG8gYHRydWVgLiBJZiB0aGVyZSB3YXMgbm90IHN1Y2gKICAgIC8vIGFuIGVsZW1lbnQgZm91bmQsIHJldHVybiB0aGUgcm9vdCBlbGVtZW50IG9mIHRoZSBjZWxsIHZpZXcuCiAgICBmaW5kTWFnbmV0OiBmdW5jdGlvbihlbCkgewoKICAgICAgICB2YXIgJGVsID0gdGhpcy4kKGVsKTsKCiAgICAgICAgaWYgKCRlbC5sZW5ndGggPT09IDAgfHwgJGVsWzBdID09PSB0aGlzLmVsKSB7CgogICAgICAgICAgICAvLyBJZiB0aGUgb3ZlcmFsbCBjZWxsIGhhcyBzZXQgYG1hZ25ldCA9PT0gZmFsc2VgLCB0aGVuIHJldHVybiBgdW5kZWZpbmVkYCB0bwogICAgICAgICAgICAvLyBhbm5vdW5jZSB0aGVyZSBpcyBubyBtYWduZXQgZm91bmQgZm9yIHRoaXMgY2VsbC4KICAgICAgICAgICAgLy8gVGhpcyBpcyBlc3BlY2lhbGx5IHVzZWZ1bCB0byBzZXQgb24gY2VsbHMgdGhhdCBoYXZlICdwb3J0cycuIEluIHRoaXMgY2FzZSwKICAgICAgICAgICAgLy8gb25seSB0aGUgcG9ydHMgaGF2ZSBzZXQgYG1hZ25ldCA9PT0gdHJ1ZWAgYW5kIHRoZSBvdmVyYWxsIGVsZW1lbnQgaGFzIGBtYWduZXQgPT09IGZhbHNlYC4KICAgICAgICAgICAgdmFyIGF0dHJzID0gdGhpcy5tb2RlbC5nZXQoJ2F0dHJzJykgfHwge307CiAgICAgICAgICAgIGlmIChhdHRyc1snLiddICYmIGF0dHJzWycuJ11bJ21hZ25ldCddID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWw7CiAgICAgICAgfQoKICAgICAgICBpZiAoJGVsLmF0dHIoJ21hZ25ldCcpKSB7CgogICAgICAgICAgICByZXR1cm4gJGVsWzBdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuZmluZE1hZ25ldCgkZWwucGFyZW50KCkpOwogICAgfSwKCiAgICAvLyBgc2VsZWN0b3JgIGlzIGEgQ1NTIHNlbGVjdG9yIG9yIGAnLidgLiBgZmlsdGVyYCBtdXN0IGJlIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZmlsdGVyIGZvcm1hdDoKICAgIC8vIGB7IG5hbWU6IDxuYW1lIG9mIHRoZSBmaWx0ZXI+LCBhcmdzOiB7IDxhcmd1bWVudHM+LCAuLi4gfWAuCiAgICAvLyBBbiBleGFtcGxlIGlzOiBgeyBmaWx0ZXI6IHsgbmFtZTogJ2JsdXInLCBhcmdzOiB7IHJhZGl1czogNSB9IH0gfWAuCiAgICBhcHBseUZpbHRlcjogZnVuY3Rpb24oc2VsZWN0b3IsIGZpbHRlcikgewoKICAgICAgICB2YXIgJHNlbGVjdGVkID0gdGhpcy5maW5kQnlTZWxlY3RvcihzZWxlY3Rvcik7CgogICAgICAgIC8vIEdlbmVyYXRlIGEgaGFzaCBjb2RlIGZyb20gdGhlIHN0cmluZ2lmaWVkIGZpbHRlciBkZWZpbml0aW9uLiBUaGlzIGdpdmVzIHVzCiAgICAgICAgLy8gYSB1bmlxdWUgZmlsdGVyIElEIGZvciBkaWZmZXJlbnQgZGVmaW5pdGlvbnMuCiAgICAgICAgdmFyIGZpbHRlcklkID0gZmlsdGVyLm5hbWUgKyB0aGlzLnBhcGVyLnN2Zy5pZCArIGpvaW50LnV0aWwuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkoZmlsdGVyKSk7CgogICAgICAgIC8vIElmIHRoZSBmaWx0ZXIgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGRvY3VtZW50LAogICAgICAgIC8vIHdlJ3JlIGRvbmUgYW5kIHdlIGNhbiBqdXN0IHVzZSBpdCAocmVmZXJlbmNlIGl0IHVzaW5nIGB1cmwoKWApLgogICAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZS4KICAgICAgICBpZiAoIXRoaXMucGFwZXIuc3ZnLmdldEVsZW1lbnRCeUlkKGZpbHRlcklkKSkgewoKICAgICAgICAgICAgdmFyIGZpbHRlclNWR1N0cmluZyA9IGpvaW50LnV0aWwuZmlsdGVyW2ZpbHRlci5uYW1lXSAmJiBqb2ludC51dGlsLmZpbHRlcltmaWx0ZXIubmFtZV0oZmlsdGVyLmFyZ3MgfHwge30pOwogICAgICAgICAgICBpZiAoIWZpbHRlclNWR1N0cmluZykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOb24tZXhpc3RpbmcgZmlsdGVyICcgKyBmaWx0ZXIubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZpbHRlckVsZW1lbnQgPSBWKGZpbHRlclNWR1N0cmluZyk7CiAgICAgICAgICAgIGZpbHRlckVsZW1lbnQuYXR0cignZmlsdGVyVW5pdHMnLCAndXNlclNwYWNlT25Vc2UnKTsKICAgICAgICAgICAgaWYgKGZpbHRlci5hdHRycykgZmlsdGVyRWxlbWVudC5hdHRyKGZpbHRlci5hdHRycyk7CiAgICAgICAgICAgIGZpbHRlckVsZW1lbnQubm9kZS5pZCA9IGZpbHRlcklkOwogICAgICAgICAgICBWKHRoaXMucGFwZXIuc3ZnKS5kZWZzKCkuYXBwZW5kKGZpbHRlckVsZW1lbnQpOwogICAgICAgIH0KCiAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBWKHRoaXMpLmF0dHIoJ2ZpbHRlcicsICd1cmwoIycgKyBmaWx0ZXJJZCArICcpJyk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vIGBzZWxlY3RvcmAgaXMgYSBDU1Mgc2VsZWN0b3Igb3IgYCcuJ2AuIGBhdHRyYCBpcyBlaXRoZXIgYSBgJ2ZpbGwnYCBvciBgJ3N0cm9rZSdgLgogICAgLy8gYGdyYWRpZW50YCBtdXN0IGJlIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZ3JhZGllbnQgZm9ybWF0OgogICAgLy8gYHsgdHlwZTogPGxpbmVhckdyYWRpZW50fHJhZGlhbEdyYWRpZW50Piwgc3RvcHM6IFsgeyBvZmZzZXQ6IDxvZmZzZXQ+LCBjb2xvcjogPGNvbG9yPiB9LCAuLi4gXWAuCiAgICAvLyBBbiBleGFtcGxlIGlzOiBgeyBmaWxsOiB7IHR5cGU6ICdsaW5lYXJHcmFkaWVudCcsIHN0b3BzOiBbIHsgb2Zmc2V0OiAnMTAlJywgY29sb3I6ICdncmVlbicgfSwgeyBvZmZzZXQ6ICc1MCUnLCBjb2xvcjogJ2JsdWUnIH0gXSB9IH1gLgogICAgYXBwbHlHcmFkaWVudDogZnVuY3Rpb24oc2VsZWN0b3IsIGF0dHIsIGdyYWRpZW50KSB7CgogICAgICAgIHZhciAkc2VsZWN0ZWQgPSB0aGlzLmZpbmRCeVNlbGVjdG9yKHNlbGVjdG9yKTsKCiAgICAgICAgLy8gR2VuZXJhdGUgYSBoYXNoIGNvZGUgZnJvbSB0aGUgc3RyaW5naWZpZWQgZmlsdGVyIGRlZmluaXRpb24uIFRoaXMgZ2l2ZXMgdXMKICAgICAgICAvLyBhIHVuaXF1ZSBmaWx0ZXIgSUQgZm9yIGRpZmZlcmVudCBkZWZpbml0aW9ucy4KICAgICAgICB2YXIgZ3JhZGllbnRJZCA9IGdyYWRpZW50LnR5cGUgKyB0aGlzLnBhcGVyLnN2Zy5pZCArIGpvaW50LnV0aWwuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkoZ3JhZGllbnQpKTsKCiAgICAgICAgLy8gSWYgdGhlIGdyYWRpZW50IGFscmVhZHkgZXhpc3RzIGluIHRoZSBkb2N1bWVudCwKICAgICAgICAvLyB3ZSdyZSBkb25lIGFuZCB3ZSBjYW4ganVzdCB1c2UgaXQgKHJlZmVyZW5jZSBpdCB1c2luZyBgdXJsKClgKS4KICAgICAgICAvLyBJZiBub3QsIGNyZWF0ZSBvbmUuCiAgICAgICAgaWYgKCF0aGlzLnBhcGVyLnN2Zy5nZXRFbGVtZW50QnlJZChncmFkaWVudElkKSkgewoKICAgICAgICAgICAgdmFyIGdyYWRpZW50U1ZHU3RyaW5nID0gWwogICAgICAgICAgICAgICAgJzwnICsgZ3JhZGllbnQudHlwZSArICc+JywKICAgICAgICAgICAgICAgIF8ubWFwKGdyYWRpZW50LnN0b3BzLCBmdW5jdGlvbihzdG9wKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8c3RvcCBvZmZzZXQ9IicgKyBzdG9wLm9mZnNldCArICciIHN0b3AtY29sb3I9IicgKyBzdG9wLmNvbG9yICsgJyIgc3RvcC1vcGFjaXR5PSInICsgKF8uaXNGaW5pdGUoc3RvcC5vcGFjaXR5KSA/IHN0b3Aub3BhY2l0eSA6IDEpICsgJyIgLz4nCiAgICAgICAgICAgICAgICB9KS5qb2luKCcnKSwKICAgICAgICAgICAgICAgICc8LycgKyBncmFkaWVudC50eXBlICsgJz4nCiAgICAgICAgICAgIF0uam9pbignJyk7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgZ3JhZGllbnRFbGVtZW50ID0gVihncmFkaWVudFNWR1N0cmluZyk7CiAgICAgICAgICAgIGlmIChncmFkaWVudC5hdHRycykgeyBncmFkaWVudEVsZW1lbnQuYXR0cihncmFkaWVudC5hdHRycyk7IH0KICAgICAgICAgICAgZ3JhZGllbnRFbGVtZW50Lm5vZGUuaWQgPSBncmFkaWVudElkOwogICAgICAgICAgICBWKHRoaXMucGFwZXIuc3ZnKS5kZWZzKCkuYXBwZW5kKGdyYWRpZW50RWxlbWVudCk7CiAgICAgICAgfQoKICAgICAgICAkc2VsZWN0ZWQuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIFYodGhpcykuYXR0cihhdHRyLCAndXJsKCMnICsgZ3JhZGllbnRJZCArICcpJyk7CiAgICAgICAgfSk7CiAgICB9LAoKICAgIC8vIENvbnN0cnVjdCBhIHVuaXF1ZSBzZWxlY3RvciBmb3IgdGhlIGBlbGAgZWxlbWVudCB3aXRoaW4gdGhpcyB2aWV3LgogICAgLy8gYHNlbGVjdG9yYCBpcyBiZWluZyBjb2xsZWN0ZWQgdGhyb3VnaCB0aGUgcmVjdXJzaXZlIGNhbGwuIE5vIHZhbHVlIGZvciBgc2VsZWN0b3JgIGlzIGV4cGVjdGVkIHdoZW4gdXNpbmcgdGhpcyBtZXRob2QuCiAgICBnZXRTZWxlY3RvcjogZnVuY3Rpb24oZWwsIHNlbGVjdG9yKSB7CgogICAgICAgIGlmIChlbCA9PT0gdGhpcy5lbCkgewoKICAgICAgICAgICAgcmV0dXJuIHNlbGVjdG9yOwogICAgICAgIH0KCiAgICAgICAgdmFyIGluZGV4ID0gJChlbCkuaW5kZXgoKTsKCiAgICAgICAgc2VsZWN0b3IgPSBlbC50YWdOYW1lICsgJzpudGgtY2hpbGQoJyArIChpbmRleCArIDEpICsgJyknICsgJyAnICsgKHNlbGVjdG9yIHx8ICcnKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VsZWN0b3IoJChlbCkucGFyZW50KClbMF0sIHNlbGVjdG9yICsgJyAnKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uIFRoZSBjb250cm9sbGVyIHBhcnQuCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAvLyBJbnRlcmFjdGlvbiBpcyBoYW5kbGVkIGJ5IHRoZSBwYXBlciBhbmQgZGVsZWdhdGVkIHRvIHRoZSB2aWV3IGluIGludGVyZXN0LgogICAgLy8gYHhgICYgYHlgIHBhcmFtZXRlcnMgcGFzc2VkIHRvIHRoZXNlIGZ1bmN0aW9ucyByZXByZXNlbnQgdGhlIGNvb3JkaW5hdGVzIGFscmVhZHkgc25hcHBlZCB0byB0aGUgcGFwZXIgZ3JpZC4KICAgIC8vIElmIG5lY2Vzc2FyeSwgcmVhbCBjb29yZGluYXRlcyBjYW4gYmUgb2J0YWluZWQgZnJvbSB0aGUgYGV2dGAgZXZlbnQgb2JqZWN0LgoKICAgIC8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgc3VwcG9zZWQgdG8gYmUgb3ZlcnJpZGVuIGJ5IHRoZSB2aWV3cyB0aGF0IGluaGVyaXQgZnJvbSBgam9pbnQuZGlhLkNlbGxgLAogICAgLy8gaS5lLiBgam9pbnQuZGlhLkVsZW1lbnRgIGFuZCBgam9pbnQuZGlhLkxpbmtgLgoKICAgIHBvaW50ZXJkYmxjbGljazogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJkYmxjbGljaycsIGV2dCwgeCwgeSk7CiAgICB9LAoKICAgIHBvaW50ZXJjbGljazogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJjbGljaycsIGV2dCwgeCwgeSk7CiAgICB9LAogICAgCiAgICBwb2ludGVyZG93bjogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgoJaWYgKHRoaXMubW9kZWwuY29sbGVjdGlvbikgewoJICAgIHRoaXMubW9kZWwudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCSAgICB0aGlzLl9jb2xsZWN0aW9uID0gdGhpcy5tb2RlbC5jb2xsZWN0aW9uOwoJfQoKICAgICAgICB0aGlzLm5vdGlmeSgnY2VsbDpwb2ludGVyZG93bicsIGV2dCwgeCwgeSk7CiAgICB9LAogICAgCiAgICBwb2ludGVybW92ZTogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJtb3ZlJywgZXZ0LCB4LCB5KTsKICAgIH0sCiAgICAKICAgIHBvaW50ZXJ1cDogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIHRoaXMubm90aWZ5KCdjZWxsOnBvaW50ZXJ1cCcsIGV2dCwgeCwgeSk7CgoJaWYgKHRoaXMuX2NvbGxlY3Rpb24pIHsKCSAgICAvLyB3ZSBkb24ndCB3YW50IHRvIHRyaWdnZXIgZXZlbnQgb24gbW9kZWwgYXMgbW9kZWwgZG9lc24ndAoJICAgIC8vIG5lZWQgdG8gYmUgbWVtYmVyIG9mIGNvbGxlY3Rpb24gYW55bW9yZSAocmVtb3ZlKQoJICAgIHRoaXMuX2NvbGxlY3Rpb24udHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoJICAgIGRlbGV0ZSB0aGlzLl9jb2xsZWN0aW9uOwoJfQoKICAgIH0KfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkNlbGwgPSBqb2ludC5kaWEuQ2VsbDsKICAgIG1vZHVsZS5leHBvcnRzLkNlbGxWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3Owp9CgovLyAgICAgIEpvaW50SlMgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi9jb3JlJykudXRpbCwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgQ2VsbDogcmVxdWlyZSgnLi9qb2ludC5kaWEuY2VsbCcpLkNlbGwsCiAgICAgICAgICAgIENlbGxWaWV3OiByZXF1aXJlKCcuL2pvaW50LmRpYS5jZWxsJykuQ2VsbFZpZXcKICAgICAgICB9CiAgICB9OwogICAgdmFyIEJhY2tib25lID0gcmVxdWlyZSgnYmFja2JvbmUnKTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCgovLyBqb2ludC5kaWEuRWxlbWVudCBiYXNlIG1vZGVsLgovLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkVsZW1lbnQgPSBqb2ludC5kaWEuQ2VsbC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiB7CiAgICAgICAgcG9zaXRpb246IHsgeDogMCwgeTogMCB9LAoJc2l6ZTogeyB3aWR0aDogMSwgaGVpZ2h0OiAxIH0sCiAgICAgICAgYW5nbGU6IDAKICAgIH0sCgogICAgcG9zaXRpb246IGZ1bmN0aW9uKHgsIHkpIHsKCiAgICAgICAgdGhpcy5zZXQoJ3Bvc2l0aW9uJywgeyB4OiB4LCB5OiB5IH0pOwogICAgfSwKICAgIAogICAgdHJhbnNsYXRlOiBmdW5jdGlvbih0eCwgdHksIG9wdCkgewoKICAgICAgICB0eSA9IHR5IHx8IDA7CgogICAgICAgIGlmICh0eCA9PT0gMCAmJiB0eSA9PT0gMCkgewogICAgICAgICAgICAvLyBMaWtlIG5vdGhpbmcgaGFzIGhhcHBlbmVkLgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0KCdwb3NpdGlvbicpIHx8IHsgeDogMCwgeTogMCB9OwoJdmFyIHRyYW5zbGF0ZWRQb3NpdGlvbiA9IHsgeDogcG9zaXRpb24ueCArIHR4IHx8IDAsIHk6IHBvc2l0aW9uLnkgKyB0eSB8fCAwIH07CgoJaWYgKG9wdCAmJiBvcHQudHJhbnNpdGlvbikgewoKCSAgICBpZiAoIV8uaXNPYmplY3Qob3B0LnRyYW5zaXRpb24pKSBvcHQudHJhbnNpdGlvbiA9IHt9OwoKCSAgICB0aGlzLnRyYW5zaXRpb24oJ3Bvc2l0aW9uJywgdHJhbnNsYXRlZFBvc2l0aW9uLCBfLmV4dGVuZCh7fSwgb3B0LnRyYW5zaXRpb24sIHsKCQl2YWx1ZUZ1bmN0aW9uOiBqb2ludC51dGlsLmludGVycG9sYXRlLm9iamVjdAoJICAgIH0pKTsKCgl9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy5zZXQoJ3Bvc2l0aW9uJywgdHJhbnNsYXRlZFBvc2l0aW9uLCBvcHQpOwoKICAgICAgICAgICAgLy8gUmVjdXJzaXZlbHkgY2FsbCBgdHJhbnNsYXRlKClgIG9uIGFsbCB0aGUgZW1iZWRzIGNlbGxzLgogICAgICAgICAgICBfLmludm9rZSh0aGlzLmdldEVtYmVkZGVkQ2VsbHMoKSwgJ3RyYW5zbGF0ZScsIHR4LCB0eSwgb3B0KTsKCX0KCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlc2l6ZTogZnVuY3Rpb24od2lkdGgsIGhlaWdodCkgewoKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKICAgICAgICB0aGlzLnNldCgnc2l6ZScsIHsgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCB9KTsKCXRoaXMudHJpZ2dlcignYmF0Y2g6c3RvcCcpOwoKCXJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSb3RhdGUgZWxlbWVudCBieSBgYW5nbGVgIGRlZ3JlZXMsIG9wdGlvbmFsbHkgYXJvdW5kIGBvcmlnaW5gIHBvaW50LgogICAgLy8gSWYgYG9yaWdpbmAgaXMgbm90IHByb3ZpZGVkLCBpdCBpcyBjb25zaWRlcmVkIHRvIGJlIHRoZSBjZW50ZXIgb2YgdGhlIGVsZW1lbnQuCiAgICAvLyBJZiBgYWJzb2x1dGVgIGlzIGB0cnVlYCwgdGhlIGBhbmdsZWAgaXMgY29uc2lkZXJlZCBpcyBhYnNsdXRlLCBpLmUuIGl0IGlzIG5vdAogICAgLy8gdGhlIGRpZmZlcmVuY2UgZnJvbSB0aGUgcHJldmlvdXMgYW5nbGUuCiAgICByb3RhdGU6IGZ1bmN0aW9uKGFuZ2xlLCBhYnNvbHV0ZSwgb3JpZ2luKSB7CgkKCWlmIChvcmlnaW4pIHsKCgkgICAgdmFyIGNlbnRlciA9IHRoaXMuZ2V0QkJveCgpLmNlbnRlcigpOwoJICAgIHZhciBzaXplID0gdGhpcy5nZXQoJ3NpemUnKTsKCSAgICB2YXIgcG9zaXRpb24gPSB0aGlzLmdldCgncG9zaXRpb24nKTsKCSAgICBjZW50ZXIucm90YXRlKG9yaWdpbiwgKHRoaXMuZ2V0KCdhbmdsZScpIHx8IDApIC0gYW5nbGUpOwoJICAgIHZhciBkeCA9IGNlbnRlci54IC0gc2l6ZS53aWR0aC8yIC0gcG9zaXRpb24ueDsKCSAgICB2YXIgZHkgPSBjZW50ZXIueSAtIHNpemUuaGVpZ2h0LzIgLSBwb3NpdGlvbi55OwoJICAgIHRoaXMudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCSAgICB0aGlzLnRyYW5zbGF0ZShkeCwgZHkpOwoJICAgIHRoaXMucm90YXRlKGFuZ2xlLCBhYnNvbHV0ZSk7CgkgICAgdGhpcy50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICAgICAgICAgIAoJfSBlbHNlIHsKCgkgICAgdGhpcy5zZXQoJ2FuZ2xlJywgYWJzb2x1dGUgPyBhbmdsZSA6ICgodGhpcy5nZXQoJ2FuZ2xlJykgfHwgMCkgKyBhbmdsZSkgJSAzNjApOwoJfQoJcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIGdldEJCb3g6IGZ1bmN0aW9uKCkgewoKCXZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0KCdwb3NpdGlvbicpOwoJdmFyIHNpemUgPSB0aGlzLmdldCgnc2l6ZScpOwoKCXJldHVybiBnLnJlY3QocG9zaXRpb24ueCwgcG9zaXRpb24ueSwgc2l6ZS53aWR0aCwgc2l6ZS5oZWlnaHQpOwogICAgfQp9KTsKCi8vIGpvaW50LmRpYS5FbGVtZW50IGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkVsZW1lbnRWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3LmV4dGVuZCh7CgogICAgY2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gJ2VsZW1lbnQgJyArIHRoaXMubW9kZWwuZ2V0KCd0eXBlJykuc3BsaXQoJy4nKS5qb2luKCcgJyk7CiAgICB9LAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBfLmJpbmRBbGwodGhpcywgJ3RyYW5zbGF0ZScsICdyZXNpemUnLCAncm90YXRlJyk7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIAoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnBvc2l0aW9uJywgdGhpcy50cmFuc2xhdGUpOwoJdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnNpemUnLCB0aGlzLnJlc2l6ZSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6YW5nbGUnLCB0aGlzLnJvdGF0ZSk7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgaXMgdG8gcHJvY2VzcyB0aGUgYGF0dHJzYCBvYmplY3QgYW5kIHNldCBhdHRyaWJ1dGVzIG9uIHN1YmVsZW1lbnRzIGJhc2VkIG9uIHRoZSBzZWxlY3RvcnMuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKGNlbGwsIHJlbmRlcmluZ09ubHlBdHRycykgewoKICAgICAgICB2YXIgYWxsQXR0cnMgPSB0aGlzLm1vZGVsLmdldCgnYXR0cnMnKTsKCiAgICAgICAgdmFyIHJvdGF0YWJsZSA9IFYodGhpcy4kKCcucm90YXRhYmxlJylbMF0pOwogICAgICAgIGlmIChyb3RhdGFibGUpIHsKCiAgICAgICAgICAgIHZhciByb3RhdGlvbiA9IHJvdGF0YWJsZS5hdHRyKCd0cmFuc2Zvcm0nKTsKICAgICAgICAgICAgcm90YXRhYmxlLmF0dHIoJ3RyYW5zZm9ybScsICcnKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIHJlbGF0aXZlbHlQb3NpdGlvbmVkID0gW107CgogICAgICAgIF8uZWFjaChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgYWxsQXR0cnMsIGZ1bmN0aW9uKGF0dHJzLCBzZWxlY3RvcikgewoKICAgICAgICAgICAgLy8gRWxlbWVudHMgdGhhdCBzaG91bGQgYmUgdXBkYXRlZC4KICAgICAgICAgICAgdmFyICRzZWxlY3RlZCA9IHRoaXMuZmluZEJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwoKICAgICAgICAgICAgLy8gTm8gZWxlbWVudCBtYXRjaGVkIGJ5IHRoZSBgc2VsZWN0b3JgIHdhcyBmb3VuZC4gV2UncmUgZG9uZSB0aGVuLgogICAgICAgICAgICBpZiAoJHNlbGVjdGVkLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwoKICAgICAgICAgICAgLy8gU3BlY2lhbCBhdHRyaWJ1dGVzIGFyZSB0cmVhdGVkIGJ5IEpvaW50SlMsIG5vdCBieSBTVkcuCiAgICAgICAgICAgIHZhciBzcGVjaWFsQXR0cmlidXRlcyA9IFsnc3R5bGUnLCAndGV4dCcsICdodG1sJywgJ3JlZi14JywgJ3JlZi15JywgJ3JlZi1keCcsICdyZWYtZHknLCAncmVmLXdpZHRoJywgJ3JlZi1oZWlnaHQnLCAncmVmJywgJ3gtYWxpZ25tZW50JywgJ3ktYWxpZ25tZW50JywgJ3BvcnQnXTsKCiAgICAgICAgICAgIC8vIElmIHRoZSBgZmlsdGVyYCBhdHRyaWJ1dGUgaXMgYW4gb2JqZWN0LCBpdCBpcyBpbiB0aGUgc3BlY2lhbCBKb2ludEpTIGZpbHRlciBmb3JtYXQgYW5kIHNvCiAgICAgICAgICAgIC8vIGl0IGJlY29tZXMgYSBzcGVjaWFsIGF0dHJpYnV0ZSBhbmQgaXMgdHJlYXRlZCBzZXBhcmF0ZWx5LgogICAgICAgICAgICBpZiAoXy5pc09iamVjdChhdHRycy5maWx0ZXIpKSB7CgogICAgICAgICAgICAgICAgc3BlY2lhbEF0dHJpYnV0ZXMucHVzaCgnZmlsdGVyJyk7CiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5RmlsdGVyKHNlbGVjdG9yLCBhdHRycy5maWx0ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGUgYGZpbGxgIG9yIGBzdHJva2VgIGF0dHJpYnV0ZSBpcyBhbiBvYmplY3QsIGl0IGlzIGluIHRoZSBzcGVjaWFsIEpvaW50SlMgZ3JhZGllbnQgZm9ybWF0IGFuZCBzbwogICAgICAgICAgICAvLyBpdCBiZWNvbWVzIGEgc3BlY2lhbCBhdHRyaWJ1dGUgYW5kIGlzIHRyZWF0ZWQgc2VwYXJhdGVseS4KICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QoYXR0cnMuZmlsbCkpIHsKCiAgICAgICAgICAgICAgICBzcGVjaWFsQXR0cmlidXRlcy5wdXNoKCdmaWxsJyk7CiAgICAgICAgICAgICAgICB0aGlzLmFwcGx5R3JhZGllbnQoc2VsZWN0b3IsICdmaWxsJywgYXR0cnMuZmlsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QoYXR0cnMuc3Ryb2tlKSkgewoKICAgICAgICAgICAgICAgIHNwZWNpYWxBdHRyaWJ1dGVzLnB1c2goJ3N0cm9rZScpOwogICAgICAgICAgICAgICAgdGhpcy5hcHBseUdyYWRpZW50KHNlbGVjdG9yLCAnc3Ryb2tlJywgYXR0cnMuc3Ryb2tlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTWFrZSBzcGVjaWFsIGNhc2UgZm9yIGB0ZXh0YCBhdHRyaWJ1dGUuIFNvIHRoYXQgd2UgY2FuIHNldCB0ZXh0IGNvbnRlbnQgb2YgdGhlIGA8dGV4dD5gIGVsZW1lbnQKICAgICAgICAgICAgLy8gdmlhIHRoZSBgYXR0cnNgIG9iamVjdCBhcyB3ZWxsLgogICAgICAgICAgICAvLyBOb3RlIHRoYXQgaXQncyBpbXBvcnRhbnQgdG8gc2V0IHRleHQgYmVmb3JlIGFwcGx5aW5nIHRoZSByZXN0IG9mIHRoZSBmaW5hbCBhdHRyaWJ1dGVzLgogICAgICAgICAgICAvLyBWZWN0b3JpemVyIGB0ZXh0KClgIG1ldGhvZCBzZXRzIG9uIHRoZSBlbGVtZW50IGl0cyBvd24gYXR0cmlidXRlcyBhbmQgaXQgaGFzIHRvIGJlIHBvc3NpYmxlCiAgICAgICAgICAgIC8vIHRvIHJld3JpdGUgdGhlbSwgaWYgbmVlZGVkLiAoaS5lIGRpc3BsYXk6ICdub25lJykKICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLnRleHQpKSB7CgogICAgICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgIFYodGhpcykudGV4dChhdHRycy50ZXh0ICsgJycsIHsgbGluZUhlaWdodDogYXR0cnMubGluZUhlaWdodCB9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXQgcmVndWxhciBhdHRyaWJ1dGVzIG9uIHRoZSBgJHNlbGVjdGVkYCBzdWJlbGVtZW50LiBOb3RlIHRoYXQgd2UgY2Fubm90IHVzZSB0aGUgalF1ZXJ5IGF0dHIoKQogICAgICAgICAgICAvLyBtZXRob2QgYXMgc29tZSBvZiB0aGUgYXR0cmlidXRlcyBtaWdodCBiZSBuYW1lc3BhY2VkIChlLmcuIHhsaW5rOmhyZWYpIHdoaWNoIGZhaWxzIHdpdGggalF1ZXJ5IGF0dHIoKS4KICAgICAgICAgICAgdmFyIGZpbmFsQXR0cmlidXRlcyA9IF8ub21pdChhdHRycywgc3BlY2lhbEF0dHJpYnV0ZXMpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIFYodGhpcykuYXR0cihmaW5hbEF0dHJpYnV0ZXMpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIGBwb3J0YCBhdHRyaWJ1dGUgY29udGFpbnMgdGhlIGBpZGAgb2YgdGhlIHBvcnQgdGhhdCB0aGUgdW5kZXJseWluZyBtYWduZXQgcmVwcmVzZW50cy4KICAgICAgICAgICAgaWYgKGF0dHJzLnBvcnQpIHsKCiAgICAgICAgICAgICAgICAkc2VsZWN0ZWQuYXR0cigncG9ydCcsIF8uaXNVbmRlZmluZWQoYXR0cnMucG9ydC5pZCkgPyBhdHRycy5wb3J0IDogYXR0cnMucG9ydC5pZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIGBzdHlsZWAgYXR0cmlidXRlIGlzIHNwZWNpYWwgaW4gdGhlIHNlbnNlIHRoYXQgaXQgc2V0cyB0aGUgQ1NTIHN0eWxlIG9mIHRoZSBzdWJlbGVtZW50LgogICAgICAgICAgICBpZiAoYXR0cnMuc3R5bGUpIHsKCiAgICAgICAgICAgICAgICAkc2VsZWN0ZWQuY3NzKGF0dHJzLnN0eWxlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGF0dHJzLmh0bWwpKSB7CgogICAgICAgICAgICAgICAgJHNlbGVjdGVkLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgICAgICQodGhpcykuaHRtbChhdHRycy5odG1sICsgJycpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFNwZWNpYWwgYHJlZi14YCBhbmQgYHJlZi15YCBhdHRyaWJ1dGVzIG1ha2UgaXQgcG9zc2libGUgdG8gc2V0IGJvdGggYWJzb2x1dGUgb3IKICAgICAgICAgICAgLy8gcmVsYXRpdmUgcG9zaXRpb25pbmcgb2Ygc3ViZWxlbWVudHMuCiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZChhdHRyc1sncmVmLXgnXSkgfHwKICAgICAgICAgICAgICAgICFfLmlzVW5kZWZpbmVkKGF0dHJzWydyZWYteSddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1keCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1keSddKSB8fAoJCSFfLmlzVW5kZWZpbmVkKGF0dHJzWyd4LWFsaWdubWVudCddKSB8fAoJCSFfLmlzVW5kZWZpbmVkKGF0dHJzWyd5LWFsaWdubWVudCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi13aWR0aCddKSB8fAogICAgICAgICAgICAgICAgIV8uaXNVbmRlZmluZWQoYXR0cnNbJ3JlZi1oZWlnaHQnXSkKICAgICAgICAgICAgICAgKSB7CgogICAgICAgICAgICAgICAgICAgXy5lYWNoKCRzZWxlY3RlZCwgZnVuY3Rpb24oZWwsIGluZGV4LCBsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoZWwpOwogICAgICAgICAgICAgICAgICAgICAgIC8vIGNvcHkgb3JpZ2luYWwgbGlzdCBzZWxlY3RvciB0byB0aGUgZWxlbWVudAogICAgICAgICAgICAgICAgICAgICAgICRlbC5zZWxlY3RvciA9IGxpc3Quc2VsZWN0b3I7CiAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpdmVseVBvc2l0aW9uZWQucHVzaCgkZWwpOwogICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdGhlIHN1YiBlbGVtZW50cyB0byBhZmZlY3QgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgcm9vdCBlbGVtZW50IHdoZW4KICAgICAgICAvLyBwb3NpdGlvbmluZyB0aGUgc3ViIGVsZW1lbnRzIHJlbGF0aXZlbHkgdG8gdGhlIGJvdW5kaW5nIGJveC4KICAgICAgICAvL18uaW52b2tlKHJlbGF0aXZlbHlQb3NpdGlvbmVkLCAnaGlkZScpOwogICAgICAgIC8vXy5pbnZva2UocmVsYXRpdmVseVBvc2l0aW9uZWQsICdzaG93Jyk7CgogICAgICAgIC8vIE5vdGUgdGhhdCB3ZSdyZSB1c2luZyB0aGUgYm91bmRpbmcgYm94IHdpdGhvdXQgdHJhbnNmb3JtYXRpb24gYmVjYXVzZSB3ZSBhcmUgYWxyZWFkeSBpbnNpZGUKICAgICAgICAvLyBhIHRyYW5zZm9ybWVkIGNvb3JkaW5hdGUgc3lzdGVtLgogICAgICAgIHZhciBiYm94ID0gdGhpcy5lbC5nZXRCQm94KCk7ICAgICAgICAKCiAgICAgICAgcmVuZGVyaW5nT25seUF0dHJzID0gcmVuZGVyaW5nT25seUF0dHJzIHx8IHt9OwoKICAgICAgICBfLmVhY2gocmVsYXRpdmVseVBvc2l0aW9uZWQsIGZ1bmN0aW9uKCRlbCkgewoKICAgICAgICAgICAgLy8gaWYgdGhlcmUgd2FzIGEgc3BlY2lhbCBhdHRyaWJ1dGUgYWZmZWN0aW5nIHRoZSBwb3NpdGlvbiBhbW9uZ3N0IHJlbmRlcmluZ09ubHlBdHRyaWJ1dGVzCiAgICAgICAgICAgIC8vIHdlIGhhdmUgdG8gbWVyZ2UgaXQgd2l0aCByZXN0IG9mIHRoZSBlbGVtZW50J3MgYXR0cmlidXRlcyBhcyB0aGV5IGFyZSBuZWNlc3NhcnkKICAgICAgICAgICAgLy8gdG8gdXBkYXRlIHRoZSBwb3NpdGlvbiByZWxhdGl2ZWx5IChpLmUgYHJlZmApCiAgICAgICAgICAgIHZhciByZW5kZXJpbmdPbmx5RWxBdHRycyA9IHJlbmRlcmluZ09ubHlBdHRyc1skZWwuc2VsZWN0b3JdOwogICAgICAgICAgICB2YXIgZWxBdHRycyA9IHJlbmRlcmluZ09ubHlFbEF0dHJzCiAgICAgICAgICAgICAgICA/IF8ubWVyZ2Uoe30sIGFsbEF0dHJzWyRlbC5zZWxlY3Rvcl0sIHJlbmRlcmluZ09ubHlFbEF0dHJzKQogICAgICAgICAgICAgICAgOiBhbGxBdHRyc1skZWwuc2VsZWN0b3JdOwoKICAgICAgICAgICAgdGhpcy5wb3NpdGlvblJlbGF0aXZlKCRlbCwgYmJveCwgZWxBdHRycyk7CiAgICAgICAgICAgIAogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICBpZiAocm90YXRhYmxlKSB7CgogICAgICAgICAgICByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJywgcm90YXRpb24gfHwgJycpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9zaXRpb25SZWxhdGl2ZTogZnVuY3Rpb24oJGVsLCBiYm94LCBlbEF0dHJzKSB7CgogICAgICAgIHZhciByZWYgPSBlbEF0dHJzWydyZWYnXTsKICAgICAgICB2YXIgcmVmWCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLXgnXSk7CiAgICAgICAgdmFyIHJlZlkgPSBwYXJzZUZsb2F0KGVsQXR0cnNbJ3JlZi15J10pOwogICAgICAgIHZhciByZWZEeCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWR4J10pOwogICAgICAgIHZhciByZWZEeSA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWR5J10pOwogICAgICAgIHZhciB5QWxpZ25tZW50ID0gZWxBdHRyc1sneS1hbGlnbm1lbnQnXTsKICAgICAgICB2YXIgeEFsaWdubWVudCA9IGVsQXR0cnNbJ3gtYWxpZ25tZW50J107CiAgICAgICAgdmFyIHJlZldpZHRoID0gcGFyc2VGbG9hdChlbEF0dHJzWydyZWYtd2lkdGgnXSk7CiAgICAgICAgdmFyIHJlZkhlaWdodCA9IHBhcnNlRmxvYXQoZWxBdHRyc1sncmVmLWhlaWdodCddKTsKCiAgICAgICAgLy8gYHJlZmAgaXMgdGhlIHNlbGVjdG9yIG9mIHRoZSByZWZlcmVuY2UgZWxlbWVudC4gSWYgbm8gYHJlZmAgaXMgcGFzc2VkLCByZWZlcmVuY2UKICAgICAgICAvLyBlbGVtZW50IGlzIHRoZSByb290IGVsZW1lbnQuCgogICAgICAgIHZhciBpc1NjYWxhYmxlID0gXy5jb250YWlucyhfLnBsdWNrKF8ucGx1Y2soJGVsLnBhcmVudHMoJ2cnKSwgJ2NsYXNzTmFtZScpLCAnYmFzZVZhbCcpLCAnc2NhbGFibGUnKTsKCiAgICAgICAgaWYgKHJlZikgewoKICAgICAgICAgICAgLy8gR2V0IHRoZSBib3VuZGluZyBib3ggb2YgdGhlIHJlZmVyZW5jZSBlbGVtZW50IHJlbGF0aXZlIHRvIHRoZSByb290IGA8Zz5gIGVsZW1lbnQuCiAgICAgICAgICAgIGJib3ggPSBWKHRoaXMuZmluZEJ5U2VsZWN0b3IocmVmKVswXSkuYmJveChmYWxzZSwgdGhpcy5lbCk7CiAgICAgICAgfQoKICAgICAgICB2YXIgdmVsID0gVigkZWxbMF0pOwoKICAgICAgICAvLyBSZW1vdmUgdGhlIHByZXZpb3VzIHRyYW5zbGF0ZSgpIGZyb20gdGhlIHRyYW5zZm9ybSBhdHRyaWJ1dGUgYW5kIHRyYW5zbGF0ZSB0aGUgZWxlbWVudAogICAgICAgIC8vIHJlbGF0aXZlIHRvIHRoZSByb290IGJvdW5kaW5nIGJveCBmb2xsb3dpbmcgdGhlIGByZWYteGAgYW5kIGByZWYteWAgYXR0cmlidXRlcy4KICAgICAgICBpZiAodmVsLmF0dHIoJ3RyYW5zZm9ybScpKSB7CgogICAgICAgICAgICB2ZWwuYXR0cigndHJhbnNmb3JtJywgdmVsLmF0dHIoJ3RyYW5zZm9ybScpLnJlcGxhY2UoL3RyYW5zbGF0ZVwoW14pXSpcKS9nLCAnJykudHJpbSgpIHx8ICcnKTsKICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGlzRGVmaW5lZCh4KSB7CiAgICAgICAgICAgIHJldHVybiBfLmlzTnVtYmVyKHgpICYmICFfLmlzTmFOKHgpOwogICAgICAgIH0KCiAgICAgICAgLy8gVGhlIGZpbmFsIHRyYW5zbGF0aW9uIG9mIHRoZSBzdWJlbGVtZW50LgogICAgICAgIHZhciB0eCA9IDA7CiAgICAgICAgdmFyIHR5ID0gMDsKCiAgICAgICAgLy8gJ3JlZi13aWR0aCcvJ3JlZi1oZWlnaHQnIGRlZmluZXMgdGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgc3ViZWxlbWVudCByZWxhdGl2ZWx5IHRvCiAgICAgICAgLy8gdGhlIHJlZmVyZW5jZSBlbGVtZW50IHNpemUKICAgICAgICAvLyB2YWwgaW4gMC4uMSAgICAgICAgIHJlZi13aWR0aCA9IDAuNzUgc2V0cyB0aGUgd2lkdGggdG8gNzUlIG9mIHRoZSByZWYuIGVsLiB3aWR0aAogICAgICAgIC8vIHZhbCA8IDAgfHwgdmFsID4gMSAgcmVmLWhlaWdodCA9IC0yMCBzZXRzIHRoZSBoZWlnaHQgdG8gdGhlIHRoZSByZWYuIGVsLiBoZWlnaHQgc2hvcnRlciBieSAyMAoKICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZldpZHRoKSkgewoKICAgICAgICAgICAgaWYgKHJlZldpZHRoID49IDAgJiYgcmVmV2lkdGggPD0gMSkgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCd3aWR0aCcsIHJlZldpZHRoICogYmJveC53aWR0aCk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCd3aWR0aCcsIE1hdGgubWF4KHJlZldpZHRoICsgYmJveC53aWR0aCwgMCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkhlaWdodCkpIHsKCiAgICAgICAgICAgIGlmIChyZWZIZWlnaHQgPj0gMCAmJiByZWZIZWlnaHQgPD0gMSkgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCdoZWlnaHQnLCByZWZIZWlnaHQgKiBiYm94LmhlaWdodCk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHZlbC5hdHRyKCdoZWlnaHQnLCBNYXRoLm1heChyZWZIZWlnaHQgKyBiYm94LmhlaWdodCwgMCkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBgcmVmLWR4YCBhbmQgYHJlZi1keWAgZGVmaW5lIHRoZSBvZmZzZXQgb2YgdGhlIHN1YmVsZW1lbnQgcmVsYXRpdmUgdG8gdGhlIHJpZ2h0IGFuZC9vciBib3R0b20KICAgICAgICAvLyBjb29yZGluYXRlIG9mIHRoZSByZWZlcmVuY2UgZWxlbWVudC4KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkR4KSkgewoKICAgICAgICAgICAgaWYgKGlzU2NhbGFibGUpIHsKCiAgICAgICAgICAgICAgICAvLyBDb21wZW5zYXRlIGZvciB0aGUgc2NhbGUgZ3JpZCBpbiBjYXNlIHRoZSBlbGVtbnQgaXMgaW4gdGhlIHNjYWxhYmxlIGdyb3VwLgogICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gVih0aGlzLiQoJy5zY2FsYWJsZScpWzBdKS5zY2FsZSgpOwogICAgICAgICAgICAgICAgdHggPSBiYm94LnggKyBiYm94LndpZHRoICsgcmVmRHggLyBzY2FsZS5zeDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0eCA9IGJib3gueCArIGJib3gud2lkdGggKyByZWZEeDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZkR5KSkgewoKICAgICAgICAgICAgaWYgKGlzU2NhbGFibGUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy8gQ29tcGVuc2F0ZSBmb3IgdGhlIHNjYWxlIGdyaWQgaW4gY2FzZSB0aGUgZWxlbW50IGlzIGluIHRoZSBzY2FsYWJsZSBncm91cC4KICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSkuc2NhbGUoKTsKICAgICAgICAgICAgICAgIHR5ID0gYmJveC55ICsgYmJveC5oZWlnaHQgKyByZWZEeSAvIHNjYWxlLnN5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0eSA9IGJib3gueSArIGJib3guaGVpZ2h0ICsgcmVmRHk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGlmIGByZWZYYCBpcyBpbiBbMCwgMV0gdGhlbiBgcmVmWGAgaXMgYSBmcmFjdGlvbiBvZiBib3VuZGluZyBib3ggd2lkdGgKICAgICAgICAvLyBpZiBgcmVmWGAgaXMgPCAwIHRoZW4gYHJlZlhgJ3MgYWJzb2x1dGUgdmFsdWVzIGlzIHRoZSByaWdodCBjb29yZGluYXRlIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAgICAvLyBvdGhlcndpc2UsIGByZWZYYCBpcyB0aGUgbGVmdCBjb29yZGluYXRlIG9mIHRoZSBib3VuZGluZyBib3gKICAgICAgICAvLyBBbmFsb2dpY2FsIHJ1bGVzIGFwcGx5IGZvciBgcmVmWWAuCiAgICAgICAgaWYgKGlzRGVmaW5lZChyZWZYKSkgewoKICAgICAgICAgICAgaWYgKHJlZlggPiAwICYmIHJlZlggPCAxKSB7CgogICAgICAgICAgICAgICAgdHggPSBiYm94LnggKyBiYm94LndpZHRoICogcmVmWDsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTY2FsYWJsZSkgewoKICAgICAgICAgICAgICAgIC8vIENvbXBlbnNhdGUgZm9yIHRoZSBzY2FsZSBncmlkIGluIGNhc2UgdGhlIGVsZW1udCBpcyBpbiB0aGUgc2NhbGFibGUgZ3JvdXAuCiAgICAgICAgICAgICAgICB2YXIgc2NhbGUgPSBWKHRoaXMuJCgnLnNjYWxhYmxlJylbMF0pLnNjYWxlKCk7CiAgICAgICAgICAgICAgICB0eCA9IGJib3gueCArIHJlZlggLyBzY2FsZS5zeDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIHR4ID0gYmJveC54ICsgcmVmWDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaXNEZWZpbmVkKHJlZlkpKSB7CgogICAgICAgICAgICBpZiAocmVmWSA+IDAgJiYgcmVmWSA8IDEpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHkgPSBiYm94LnkgKyBiYm94LmhlaWdodCAqIHJlZlk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1NjYWxhYmxlKSB7CgogICAgICAgICAgICAgICAgLy8gQ29tcGVuc2F0ZSBmb3IgdGhlIHNjYWxlIGdyaWQgaW4gY2FzZSB0aGUgZWxlbW50IGlzIGluIHRoZSBzY2FsYWJsZSBncm91cC4KICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSkuc2NhbGUoKTsKICAgICAgICAgICAgICAgIHR5ID0gYmJveC55ICsgcmVmWSAvIHNjYWxlLnN5OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgdHkgPSBiYm94LnkgKyByZWZZOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCXZhciB2ZWxiYm94ID0gdmVsLmJib3goZmFsc2UsIHRoaXMucGFwZXIudmlld3BvcnQpOwogICAgICAgIC8vIGB5LWFsaWdubWVudGAgd2hlbiBzZXQgdG8gYG1pZGRsZWAgY2F1c2VzIGNlbnRlcmluZyBvZiB0aGUgc3ViZWxlbWVudCBhcm91bmQgaXRzIG5ldyB5IGNvb3JkaW5hdGUuCiAgICAgICAgaWYgKHlBbGlnbm1lbnQgPT09ICdtaWRkbGUnKSB7CgogICAgICAgICAgICB0eSAtPSB2ZWxiYm94LmhlaWdodC8yOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZCh5QWxpZ25tZW50KSkgewoKICAgICAgICAgICAgdHkgKz0gKHlBbGlnbm1lbnQgPiAtMSAmJiB5QWxpZ25tZW50IDwgMSkgPyAgdmVsYmJveC5oZWlnaHQgKiB5QWxpZ25tZW50IDogeUFsaWdubWVudDsKICAgICAgICB9CgogICAgICAgIC8vIGB4LWFsaWdubWVudGAgd2hlbiBzZXQgdG8gYG1pZGRsZWAgY2F1c2VzIGNlbnRlcmluZyBvZiB0aGUgc3ViZWxlbWVudCBhcm91bmQgaXRzIG5ldyB4IGNvb3JkaW5hdGUuCiAgICAgICAgaWYgKHhBbGlnbm1lbnQgPT09ICdtaWRkbGUnKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0eCAtPSB2ZWxiYm94LndpZHRoLzI7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKHhBbGlnbm1lbnQpKSB7CgogICAgICAgICAgICB0eCArPSAoeEFsaWdubWVudCA+IC0xICYmIHhBbGlnbm1lbnQgPCAxKSA/ICB2ZWxiYm94LndpZHRoICogeEFsaWdubWVudCA6IHhBbGlnbm1lbnQ7CiAgICAgICAgfQoKICAgICAgICB2ZWwudHJhbnNsYXRlKHR4LCB0eSk7CiAgICB9LAoKICAgIC8vIGBwcm90b3R5cGUubWFya3VwYCBpcyByZW5kZXJlZCBieSBkZWZhdWx0LiBTZXQgdGhlIGBtYXJrdXBgIGF0dHJpYnV0ZSBvbiB0aGUgbW9kZWwgaWYgdGhlCiAgICAvLyBkZWZhdWx0IG1hcmt1cCBpcyBub3QgZGVzaXJhYmxlLgogICAgcmVuZGVyTWFya3VwOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICB2YXIgbWFya3VwID0gdGhpcy5tb2RlbC5tYXJrdXAgfHwgdGhpcy5tb2RlbC5nZXQoJ21hcmt1cCcpOwogICAgICAgIAogICAgICAgIGlmIChtYXJrdXApIHsKCiAgICAgICAgICAgIHZhciBub2RlcyA9IFYobWFya3VwKTsKICAgICAgICAgICAgVih0aGlzLmVsKS5hcHBlbmQobm9kZXMpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdwcm9wZXJ0aWVzLm1hcmt1cCBpcyBtaXNzaW5nIHdoaWxlIHRoZSBkZWZhdWx0IHJlbmRlcigpIGltcGxlbWVudGF0aW9uIGlzIHVzZWQuJyk7CiAgICAgICAgfQogICAgfSwKCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLiRlbC5lbXB0eSgpOwoKICAgICAgICB0aGlzLnJlbmRlck1hcmt1cCgpOwoKICAgICAgICB0aGlzLnVwZGF0ZSgpOwoKICAgICAgICB0aGlzLnJlc2l6ZSgpOwogICAgICAgIHRoaXMucm90YXRlKCk7CiAgICAgICAgdGhpcy50cmFuc2xhdGUoKTsgICAgICAgIAoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2NhbGUgdGhlIHdob2xlIGA8Zz5gIGdyb3VwLiBOb3RlIHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gYHNjYWxlKClgIGFuZCBgcmVzaXplKClgIGhlcmUuCiAgICAvLyBgcmVzaXplKClgIGRvZXNuJ3Qgc2NhbGUgdGhlIHdob2xlIGA8Zz5gIGdyb3VwIGJ1dCByYXRoZXIgYWRqdXN0cyB0aGUgYGJveC5zeGAvYGJveC5zeWAgb25seS4KICAgIC8vIGB1cGRhdGUoKWAgaXMgdGhlbiByZXNwb25zaWJsZSBmb3Igc2NhbGluZyBvbmx5IHRob3NlIGVsZW1lbnRzIHRoYXQgaGF2ZSB0aGUgYGZvbGxvdy1zY2FsZWAKICAgIC8vIGF0dHJpYnV0ZSBzZXQgdG8gYHRydWVgLiBUaGlzIGlzIGRlc2lyYWJsZSBpbiBlbGVtZW50cyB0aGF0IGhhdmUgZS5nLiBhIGA8dGV4dD5gIHN1YmVsZW1lbnQKICAgIC8vIHRoYXQgaXMgbm90IHN1cHBvc2VkIHRvIGJlIHNjYWxlZCB0b2dldGhlciB3aXRoIGEgc3Vycm91bmRpbmcgYDxyZWN0PmAgZWxlbWVudCB0aGF0IElTIHN1cHBvc2VkCiAgICAvLyBiZSBiZSBzY2FsZWQuCiAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5KSB7CgogICAgICAgIC8vIFRPRE86IHRha2UgaW50byBhY2NvdW50IHRoZSBvcmlnaW4gY29vcmRpbmF0ZXMgYG94YCBhbmQgYG95YC4KICAgICAgICBWKHRoaXMuZWwpLnNjYWxlKHN4LCBzeSk7CiAgICB9LAoKICAgIHJlc2l6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBzaXplID0gdGhpcy5tb2RlbC5nZXQoJ3NpemUnKSB8fCB7IHdpZHRoOiAxLCBoZWlnaHQ6IDEgfTsKICAgICAgICB2YXIgYW5nbGUgPSB0aGlzLm1vZGVsLmdldCgnYW5nbGUnKSB8fCAwOwogICAgICAgIAogICAgICAgIHZhciBzY2FsYWJsZSA9IFYodGhpcy4kKCcuc2NhbGFibGUnKVswXSk7CiAgICAgICAgaWYgKCFzY2FsYWJsZSkgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyBzY2FsYWJsZSBlbGVtZW50cywgdGhhbiB0aGVyZSBpcyBub3RoaW5nIHRvIHJlc2l6ZS4KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB2YXIgc2NhbGFibGVCYm94ID0gc2NhbGFibGUuYmJveCh0cnVlKTsKICAgICAgICAvLyBNYWtlIHN1cmUgYHNjYWxhYmxlQmJveC53aWR0aGAgYW5kIGBzY2FsYWJsZUJib3guaGVpZ2h0YCBhcmUgbm90IHplcm8gd2hpY2ggY2FuIGhhcHBlbiBpZiB0aGUgZWxlbWVudCBkb2VzIG5vdCBoYXZlIGFueSBjb250ZW50LiBCeSBtYWtpbmcKICAgICAgICAvLyB0aGUgd2lkdGgvaGVpZ2h0IDEsIHdlIHByZXZlbnQgSFRNTCBlcnJvcnMgb2YgdGhlIHR5cGUgYHNjYWxlKEluZmluaXR5LCBJbmZpbml0eSlgLgogICAgICAgIHNjYWxhYmxlLmF0dHIoJ3RyYW5zZm9ybScsICdzY2FsZSgnICsgKHNpemUud2lkdGggLyAoc2NhbGFibGVCYm94LndpZHRoIHx8IDEpKSArICcsJyArIChzaXplLmhlaWdodCAvIChzY2FsYWJsZUJib3guaGVpZ2h0IHx8IDEpKSArICcpJyk7CgogICAgICAgIC8vIE5vdyB0aGUgaW50ZXJlc3RpbmcgcGFydC4gVGhlIGdvYWwgaXMgdG8gYmUgYWJsZSB0byBzdG9yZSB0aGUgb2JqZWN0IGdlb21ldHJ5IHZpYSBqdXN0IGB4YCwgYHlgLCBgYW5nbGVgLCBgd2lkdGhgIGFuZCBgaGVpZ2h0YAogICAgICAgIC8vIE9yZGVyIG9mIHRyYW5zZm9ybWF0aW9ucyBpcyBzaWduaWZpY2FudCBidXQgd2Ugd2FudCB0byByZWNvbnN0cnVjdCB0aGUgb2JqZWN0IGFsd2F5cyBpbiB0aGUgb3JkZXI6CiAgICAgICAgLy8gcmVzaXplKCksIHJvdGF0ZSgpLCB0cmFuc2xhdGUoKSBubyBtYXR0ZXIgb2YgaG93IHRoZSBvYmplY3Qgd2FzIHRyYW5zZm9ybWVkLiBGb3IgdGhhdCB0byB3b3JrLAogICAgICAgIC8vIHdlIG11c3QgYWRqdXN0IHRoZSBgeGAgYW5kIGB5YCBjb29yZGluYXRlcyBvZiB0aGUgb2JqZWN0IHdoZW5ldmVyIHdlIHJlc2l6ZSBpdCAoYmVjYXVzZSB0aGUgb3JpZ2luIG9mIHRoZQogICAgICAgIC8vIHJvdGF0aW9uIGNoYW5nZXMpLiBUaGUgbmV3IGB4YCBhbmQgYHlgIGNvb3JkaW5hdGVzIGFyZSBjb21wdXRlZCBieSBjYW5jZWxpbmcgdGhlIHByZXZpb3VzIHJvdGF0aW9uCiAgICAgICAgLy8gYXJvdW5kIHRoZSBjZW50ZXIgb2YgdGhlIHJlc2l6ZWQgb2JqZWN0ICh3aGljaCBpcyBhIGRpZmZlcmVudCBvcmlnaW4gdGhlbiB0aGUgb3JpZ2luIG9mIHRoZSBwcmV2aW91cyByb3RhdGlvbikKICAgICAgICAvLyBhbmQgZ2V0dGluZyB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSByZXN1bHRpbmcgb2JqZWN0LiBUaGVuIHdlIGNsZWFuIHVwIHRoZSByb3RhdGlvbiBiYWNrIHRvIHdoYXQgaXQgb3JpZ2luYWxseSB3YXMuCiAgICAgICAgCiAgICAgICAgLy8gQ2FuY2VsIHRoZSByb3RhdGlvbiBidXQgbm93IGFyb3VuZCBhIGRpZmZlcmVudCBvcmlnaW4sIHdoaWNoIGlzIHRoZSBjZW50ZXIgb2YgdGhlIHNjYWxlZCBvYmplY3QuCiAgICAgICAgdmFyIHJvdGF0YWJsZSA9IFYodGhpcy4kKCcucm90YXRhYmxlJylbMF0pOwogICAgICAgIHZhciByb3RhdGlvbiA9IHJvdGF0YWJsZSAmJiByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJyk7CiAgICAgICAgaWYgKHJvdGF0aW9uICYmIHJvdGF0aW9uICE9PSAnbnVsbCcpIHsKCiAgICAgICAgICAgIHJvdGF0YWJsZS5hdHRyKCd0cmFuc2Zvcm0nLCByb3RhdGlvbiArICcgcm90YXRlKCcgKyAoLWFuZ2xlKSArICcsJyArIChzaXplLndpZHRoLzIpICsgJywnICsgKHNpemUuaGVpZ2h0LzIpICsgJyknKTsKICAgICAgICAgICAgdmFyIHJvdGF0YWJsZUJib3ggPSBzY2FsYWJsZS5iYm94KGZhbHNlLCB0aGlzLnBhcGVyLnZpZXdwb3J0KTsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFN0b3JlIG5ldyB4LCB5IGFuZCBwZXJmb3JtIHJvdGF0ZSgpIGFnYWluIGFnYWluc3QgdGhlIG5ldyByb3RhdGlvbiBvcmlnaW4uCiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCdwb3NpdGlvbicsIHsgeDogcm90YXRhYmxlQmJveC54LCB5OiByb3RhdGFibGVCYm94LnkgfSk7CiAgICAgICAgICAgIHRoaXMucm90YXRlKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBVcGRhdGUgbXVzdCBhbHdheXMgYmUgY2FsbGVkIG9uIG5vbi1yb3RhdGVkIGVsZW1lbnQuIE90aGVyd2lzZSwgcmVsYXRpdmUgcG9zaXRpb25pbmcKICAgICAgICAvLyB3b3VsZCB3b3JrIHdpdGggd3JvbmcgKHJvdGF0ZWQpIGJvdW5kaW5nIGJveGVzLgogICAgICAgIHRoaXMudXBkYXRlKCk7CiAgICB9LAoKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24obW9kZWwsIGNoYW5nZXMsIG9wdCkgewoKICAgICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLm1vZGVsLmdldCgncG9zaXRpb24nKSB8fCB7IHg6IDAsIHk6IDAgfTsKCiAgICAgICAgVih0aGlzLmVsKS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyBwb3NpdGlvbi54ICsgJywnICsgcG9zaXRpb24ueSArICcpJyk7CiAgICB9LAoKICAgIHJvdGF0ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciByb3RhdGFibGUgPSBWKHRoaXMuJCgnLnJvdGF0YWJsZScpWzBdKTsKICAgICAgICBpZiAoIXJvdGF0YWJsZSkgewogICAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBubyByb3RhdGFibGUgZWxlbWVudHMsIHRoZW4gdGhlcmUgaXMgbm90aGluZyB0byByb3RhdGUuCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdmFyIGFuZ2xlID0gdGhpcy5tb2RlbC5nZXQoJ2FuZ2xlJykgfHwgMDsKICAgICAgICB2YXIgc2l6ZSA9IHRoaXMubW9kZWwuZ2V0KCdzaXplJykgfHwgeyB3aWR0aDogMSwgaGVpZ2h0OiAxIH07CgogICAgICAgIHZhciBveCA9IHNpemUud2lkdGgvMjsKICAgICAgICB2YXIgb3kgPSBzaXplLmhlaWdodC8yOwogICAgICAgIAoKICAgICAgICByb3RhdGFibGUuYXR0cigndHJhbnNmb3JtJywgJ3JvdGF0ZSgnICsgYW5nbGUgKyAnLCcgKyBveCArICcsJyArIG95ICsgJyknKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uIFRoZSBjb250cm9sbGVyIHBhcnQuCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgICAKICAgIHBvaW50ZXJkb3duOiBmdW5jdGlvbihldnQsIHgsIHkpIHsKCiAgICAgICAgaWYgKCAvLyB0YXJnZXQgaXMgYSB2YWxpZCBtYWduZXQgc3RhcnQgbGlua2luZwogICAgICAgICAgICBldnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnbWFnbmV0JykgJiYKICAgICAgICAgICAgdGhpcy5wYXBlci5vcHRpb25zLnZhbGlkYXRlTWFnbmV0LmNhbGwodGhpcy5wYXBlciwgdGhpcywgZXZ0LnRhcmdldCkKICAgICAgICApIHsKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwudHJpZ2dlcignYmF0Y2g6c3RhcnQnKTsKCiAgICAgICAgICAgICAgICB2YXIgbGluayA9IHRoaXMucGFwZXIuZ2V0RGVmYXVsdExpbmsodGhpcywgZXZ0LnRhcmdldCk7CiAgICAgICAgICAgICAgICBsaW5rLnNldCh7CiAgICAgICAgICAgICAgICAgICAgc291cmNlOiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB0aGlzLm1vZGVsLmlkLAogICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RvcjogdGhpcy5nZXRTZWxlY3RvcihldnQudGFyZ2V0KSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogJChldnQudGFyZ2V0KS5hdHRyKCdwb3J0JykKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHRhcmdldDogeyB4OiB4LCB5OiB5IH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMucGFwZXIubW9kZWwuYWRkQ2VsbChsaW5rKTsKCgkgICAgICAgIHRoaXMuX2xpbmtWaWV3ID0gdGhpcy5wYXBlci5maW5kVmlld0J5TW9kZWwobGluayk7CiAgICAgICAgICAgICAgICB0aGlzLl9saW5rVmlldy5zdGFydEFycm93aGVhZE1vdmUoJ3RhcmdldCcpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy5fZHggPSB4OwogICAgICAgICAgICB0aGlzLl9keSA9IHk7CgogICAgICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJkb3duLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgfSwKCiAgICBwb2ludGVybW92ZTogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIGlmICh0aGlzLl9saW5rVmlldykgewoKICAgICAgICAgICAgLy8gbGV0IHRoZSBsaW5rdmlldyBkZWFsIHdpdGggdGhpcyBldmVudAogICAgICAgICAgICB0aGlzLl9saW5rVmlldy5wb2ludGVybW92ZShldnQsIHgsIHkpOwoKICAgICAgICB9IGVsc2UgewoKCSAgICB2YXIgZ3JpZCA9IHRoaXMucGFwZXIub3B0aW9ucy5ncmlkU2l6ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgIT09IGZhbHNlKSB7CgoJICAgICAgICB2YXIgcG9zaXRpb24gPSB0aGlzLm1vZGVsLmdldCgncG9zaXRpb24nKTsKCgkgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGUgbmV3IGVsZW1lbnQncyBwb3NpdGlvbiBhbHdheXMgc25hcHMgdG8gdGhlIGN1cnJlbnQgZ3JpZCBhZnRlcgoJICAgICAgICAvLyB0cmFuc2xhdGUgYXMgdGhlIHByZXZpb3VzIG9uZSBjb3VsZCBiZSBjYWxjdWxhdGVkIHdpdGggYSBkaWZmZXJlbnQgZ3JpZCBzaXplLgoJICAgICAgICB0aGlzLm1vZGVsLnRyYW5zbGF0ZSgKCQkgICAgZy5zbmFwVG9HcmlkKHBvc2l0aW9uLngsIGdyaWQpIC0gcG9zaXRpb24ueCArIGcuc25hcFRvR3JpZCh4IC0gdGhpcy5fZHgsIGdyaWQpLAoJCSAgICBnLnNuYXBUb0dyaWQocG9zaXRpb24ueSwgZ3JpZCkgLSBwb3NpdGlvbi55ICsgZy5zbmFwVG9HcmlkKHkgLSB0aGlzLl9keSwgZ3JpZCkKCSAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZHggPSBnLnNuYXBUb0dyaWQoeCwgZ3JpZCk7CiAgICAgICAgICAgIHRoaXMuX2R5ID0gZy5zbmFwVG9HcmlkKHksIGdyaWQpOwoKICAgICAgICAgICAgam9pbnQuZGlhLkNlbGxWaWV3LnByb3RvdHlwZS5wb2ludGVybW92ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcnVwOiBmdW5jdGlvbihldnQsIHgsIHkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2xpbmtWaWV3KSB7CgogICAgICAgICAgICAvLyBsZXQgdGhlIGxpbmt2aWV3IGRlYWwgd2l0aCB0aGlzIGV2ZW50CiAgICAgICAgICAgIHRoaXMuX2xpbmtWaWV3LnBvaW50ZXJ1cChldnQsIHgsIHkpOwoKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2xpbmtWaWV3OwoKICAgICAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJ1cC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgIH0KCn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzLkVsZW1lbnQgPSBqb2ludC5kaWEuRWxlbWVudDsKICAgIG1vZHVsZS5leHBvcnRzLkVsZW1lbnRWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3Owp9CgovLyAgICAgIEpvaW50SlMgZGlhZ3JhbW1pbmcgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIENlbGw6IHJlcXVpcmUoJy4vam9pbnQuZGlhLmNlbGwnKS5DZWxsLAogICAgICAgICAgICBDZWxsVmlldzogcmVxdWlyZSgnLi9qb2ludC5kaWEuY2VsbCcpLkNlbGxWaWV3CiAgICAgICAgfQogICAgfTsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwogICAgdmFyIGcgPSByZXF1aXJlKCcuL2dlb21ldHJ5Jyk7Cn0KCgoKLy8gam9pbnQuZGlhLkxpbmsgYmFzZSBtb2RlbC4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0Kam9pbnQuZGlhLkxpbmsgPSBqb2ludC5kaWEuQ2VsbC5leHRlbmQoewoKICAgIC8vIFRoZSBkZWZhdWx0IG1hcmt1cCBmb3IgbGlua3MuCiAgICBtYXJrdXA6IFsKICAgICAgICAnPHBhdGggY2xhc3M9ImNvbm5lY3Rpb24iIHN0cm9rZT0iYmxhY2siLz4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLXNvdXJjZSIgZmlsbD0iYmxhY2siIHN0cm9rZT0iYmxhY2siIC8+JywKICAgICAgICAnPHBhdGggY2xhc3M9Im1hcmtlci10YXJnZXQiIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiAvPicsCiAgICAgICAgJzxwYXRoIGNsYXNzPSJjb25uZWN0aW9uLXdyYXAiLz4nLAogICAgICAgICc8ZyBjbGFzcz0ibGFiZWxzIi8+JywKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci12ZXJ0aWNlcyIvPicsCiAgICAgICAgJzxnIGNsYXNzPSJtYXJrZXItYXJyb3doZWFkcyIvPicsCiAgICAgICAgJzxnIGNsYXNzPSJsaW5rLXRvb2xzIi8+JwogICAgXS5qb2luKCcnKSwKCiAgICBsYWJlbE1hcmt1cDogWwogICAgICAgICc8ZyBjbGFzcz0ibGFiZWwiPicsCiAgICAgICAgJzxyZWN0IC8+JywKICAgICAgICAnPHRleHQgLz4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICB0b29sTWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJsaW5rLXRvb2wiPicsCiAgICAgICAgJzxnIGNsYXNzPSJ0b29sLXJlbW92ZSIgZXZlbnQ9InJlbW92ZSI+JywKICAgICAgICAnPGNpcmNsZSByPSIxMSIgLz4nLAogICAgICAgICc8cGF0aCB0cmFuc2Zvcm09InNjYWxlKC44KSB0cmFuc2xhdGUoLTE2LCAtMTYpIiBkPSJNMjQuNzc4LDIxLjQxOSAxOS4yNzYsMTUuOTE3IDI0Ljc3NywxMC40MTUgMjEuOTQ5LDcuNTg1IDE2LjQ0NywxMy4wODcgMTAuOTQ1LDcuNTg1IDguMTE3LDEwLjQxNSAxMy42MTgsMTUuOTE3IDguMTE2LDIxLjQxOSAxMC45NDYsMjQuMjQ4IDE2LjQ0NywxOC43NDYgMjEuOTQ4LDI0LjI0OHoiLz4nLAogICAgICAgICc8dGl0bGU+UmVtb3ZlIGxpbmsuPC90aXRsZT4nLAogICAgICAgICc8L2c+JywKICAgICAgICAnPGcgY2xhc3M9InRvb2wtb3B0aW9ucyIgZXZlbnQ9Imxpbms6b3B0aW9ucyI+JywKICAgICAgICAnPGNpcmNsZSByPSIxMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjUpIi8+JywKICAgICAgICAnPHBhdGggZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ic2NhbGUoLjU1KSB0cmFuc2xhdGUoMjksIC0xNikiIGQ9Ik0zMS4yMjksMTcuNzM2YzAuMDY0LTAuNTcxLDAuMTA0LTEuMTQ4LDAuMTA0LTEuNzM2cy0wLjA0LTEuMTY2LTAuMTA0LTEuNzM3bC00LjM3Ny0xLjU1N2MtMC4yMTgtMC43MTYtMC41MDQtMS40MDEtMC44NTEtMi4wNWwxLjk5My00LjE5MmMtMC43MjUtMC45MS0xLjU0OS0xLjczNC0yLjQ1OC0yLjQ1OWwtNC4xOTMsMS45OTRjLTAuNjQ3LTAuMzQ3LTEuMzM0LTAuNjMyLTIuMDQ5LTAuODQ5bC0xLjU1OC00LjM3OEMxNy4xNjUsMC43MDgsMTYuNTg4LDAuNjY3LDE2LDAuNjY3cy0xLjE2NiwwLjA0MS0xLjczNywwLjEwNUwxMi43MDcsNS4xNWMtMC43MTYsMC4yMTctMS40MDEsMC41MDItMi4wNSwwLjg0OUw2LjQ2NCw0LjAwNUM1LjU1NCw0LjczLDQuNzMsNS41NTQsNC4wMDUsNi40NjRsMS45OTQsNC4xOTJjLTAuMzQ3LDAuNjQ4LTAuNjMyLDEuMzM0LTAuODQ5LDIuMDVsLTQuMzc4LDEuNTU3QzAuNzA4LDE0LjgzNCwwLjY2NywxNS40MTIsMC42NjcsMTZzMC4wNDEsMS4xNjUsMC4xMDUsMS43MzZsNC4zNzgsMS41NThjMC4yMTcsMC43MTUsMC41MDIsMS40MDEsMC44NDksMi4wNDlsLTEuOTk0LDQuMTkzYzAuNzI1LDAuOTA5LDEuNTQ5LDEuNzMzLDIuNDU5LDIuNDU4bDQuMTkyLTEuOTkzYzAuNjQ4LDAuMzQ3LDEuMzM0LDAuNjMzLDIuMDUsMC44NTFsMS41NTcsNC4zNzdjMC41NzEsMC4wNjQsMS4xNDgsMC4xMDQsMS43MzcsMC4xMDRjMC41ODgsMCwxLjE2NS0wLjA0LDEuNzM2LTAuMTA0bDEuNTU4LTQuMzc3YzAuNzE1LTAuMjE4LDEuMzk5LTAuNTA0LDIuMDQ5LTAuODUxbDQuMTkzLDEuOTkzYzAuOTA5LTAuNzI1LDEuNzMzLTEuNTQ5LDIuNDU4LTIuNDU4bC0xLjk5My00LjE5M2MwLjM0Ny0wLjY0NywwLjYzMy0xLjMzNCwwLjg1MS0yLjA0OUwzMS4yMjksMTcuNzM2ek0xNiwyMC44NzFjLTIuNjksMC00Ljg3Mi0yLjE4Mi00Ljg3Mi00Ljg3MWMwLTIuNjksMi4xODItNC44NzIsNC44NzItNC44NzJjMi42ODksMCw0Ljg3MSwyLjE4Miw0Ljg3MSw0Ljg3MkMyMC44NzEsMTguNjg5LDE4LjY4OSwyMC44NzEsMTYsMjAuODcxeiIvPicsCiAgICAgICAgJzx0aXRsZT5MaW5rIG9wdGlvbnMuPC90aXRsZT4nLAogICAgICAgICc8L2c+JywKICAgICAgICAnPC9nPicKICAgIF0uam9pbignJyksCgogICAgLy8gVGhlIGRlZmF1bHQgbWFya3VwIGZvciBzaG93aW5nL3JlbW92aW5nIHZlcnRpY2VzLiBUaGVzZSBlbGVtZW50cyBhcmUgdGhlIGNoaWxkcmVuIG9mIHRoZSAubWFya2VyLXZlcnRpY2VzIGVsZW1lbnQgKHNlZSBgdGhpcy5tYXJrdXBgKS4KICAgIC8vIE9ubHkgLm1hcmtlci12ZXJ0ZXggYW5kIC5tYXJrZXItdmVydGV4LXJlbW92ZSBlbGVtZW50IGhhdmUgc3BlY2lhbCBtZWFuaW5nLiBUaGUgZm9ybWVyIGlzIHVzZWQgZm9yCiAgICAvLyBkcmFnZ2luZyB2ZXJ0aWNlcyAoY2hhbmdpbiB0aGVpciBwb3NpdGlvbikuIFRoZSBsYXR0ZXIgaXMgdXNlZCBmb3IgcmVtb3ZpbmcgdmVydGljZXMuCiAgICB2ZXJ0ZXhNYXJrdXA6IFsKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci12ZXJ0ZXgtZ3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDwlPSB4ICU+LCA8JT0geSAlPikiPicsCiAgICAgICAgJzxjaXJjbGUgY2xhc3M9Im1hcmtlci12ZXJ0ZXgiIGlkeD0iPCU9IGlkeCAlPiIgcj0iMTAiIC8+JywKICAgICAgICAnPHBhdGggY2xhc3M9Im1hcmtlci12ZXJ0ZXgtcmVtb3ZlLWFyZWEiIGlkeD0iPCU9IGlkeCAlPiIgZD0iTTE2LDUuMzMzYy03LjczMiwwLTE0LDQuNzAxLTE0LDEwLjVjMCwxLjk4MiwwLjc0MSwzLjgzMywyLjAxNiw1LjQxNEwyLDI1LjY2N2w1LjYxMy0xLjQ0MWMyLjMzOSwxLjMxNyw1LjIzNywyLjEwNyw4LjM4NywyLjEwN2M3LjczMiwwLDE0LTQuNzAxLDE0LTEwLjVDMzAsMTAuMDM0LDIzLjczMiw1LjMzMywxNiw1LjMzM3oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDUsIC0zMykiLz4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLXZlcnRleC1yZW1vdmUiIGlkeD0iPCU9IGlkeCAlPiIgdHJhbnNmb3JtPSJzY2FsZSguOCkgdHJhbnNsYXRlKDkuNSwgLTM3KSIgZD0iTTI0Ljc3OCwyMS40MTkgMTkuMjc2LDE1LjkxNyAyNC43NzcsMTAuNDE1IDIxLjk0OSw3LjU4NSAxNi40NDcsMTMuMDg3IDEwLjk0NSw3LjU4NSA4LjExNywxMC40MTUgMTMuNjE4LDE1LjkxNyA4LjExNiwyMS40MTkgMTAuOTQ2LDI0LjI0OCAxNi40NDcsMTguNzQ2IDIxLjk0OCwyNC4yNDh6Ij4nLAogICAgICAgICc8dGl0bGU+UmVtb3ZlIHZlcnRleC48L3RpdGxlPicsCiAgICAgICAgJzwvcGF0aD4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICBhcnJvd2hlYWRNYXJrdXA6IFsKICAgICAgICAnPGcgY2xhc3M9Im1hcmtlci1hcnJvd2hlYWQtZ3JvdXAgbWFya2VyLWFycm93aGVhZC1ncm91cC08JT0gZW5kICU+Ij4nLAogICAgICAgICc8cGF0aCBjbGFzcz0ibWFya2VyLWFycm93aGVhZCIgZW5kPSI8JT0gZW5kICU+IiBkPSJNIDI2IDAgTCAwIDEzIEwgMjYgMjYgeiIgLz4nLAogICAgICAgICc8L2c+JwogICAgXS5qb2luKCcnKSwKCiAgICBkZWZhdWx0czogewoKICAgICAgICB0eXBlOiAnbGluaycKICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKSB7CgogICAgICAgIHJldHVybiB0aGlzLnNldCh7IHNvdXJjZTogZy5wb2ludCgwLCAwKSwgdGFyZ2V0OiBnLnBvaW50KDAsIDApIH0pOwogICAgfSwKCiAgICAvLyBBIGNvbnZlbmllbnQgd2F5IHRvIHNldCBsYWJlbHMuIEN1cnJlbnRseSBzZXQgdmFsdWVzIHdpbGwgYmUgbWl4aW5lZCB3aXRoIGB2YWx1ZWAgaWYgdXNlZCBhcyBhIHNldHRlci4KICAgIGxhYmVsOiBmdW5jdGlvbihpZHgsIHZhbHVlKSB7CgogICAgICAgIGlkeCA9IGlkeCB8fCAwOwogICAgICAgIAogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgCiAgICAgICAgLy8gSXMgaXQgYSBnZXR0ZXI/CiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGxhYmVsc1tpZHhdOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1ZhbHVlID0gXy5tZXJnZSh7fSwgbGFiZWxzW2lkeF0sIHZhbHVlKTsKCiAgICAgICAgdmFyIG5ld0xhYmVscyA9IGxhYmVscy5zbGljZSgpOwogICAgICAgIG5ld0xhYmVsc1tpZHhdID0gbmV3VmFsdWU7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHRoaXMuc2V0KHsgbGFiZWxzOiBuZXdMYWJlbHMgfSk7CiAgICB9LAoKICAgIHRyYW5zbGF0ZTogZnVuY3Rpb24odHgsIHR5LCBvcHQpIHsKCiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgdmFyIHNvdXJjZSA9IHRoaXMuZ2V0KCdzb3VyY2UnKTsKICAgICAgICB2YXIgdGFyZ2V0ID0gdGhpcy5nZXQoJ3RhcmdldCcpOwogICAgICAgIHZhciB2ZXJ0aWNlcyA9IHRoaXMuZ2V0KCd2ZXJ0aWNlcycpOwoKICAgICAgICBpZiAoIXNvdXJjZS5pZCkgewogICAgICAgICAgICBhdHRycy5zb3VyY2UgPSB7IHg6IHNvdXJjZS54ICsgdHgsIHk6IHNvdXJjZS55ICsgdHkgfTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFyZ2V0LmlkKSB7CiAgICAgICAgICAgIGF0dHJzLnRhcmdldCA9IHsgeDogdGFyZ2V0LnggKyB0eCwgeTogdGFyZ2V0LnkgKyB0eSB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHZlcnRpY2VzICYmIHZlcnRpY2VzLmxlbmd0aCkgewogICAgICAgICAgICBhdHRycy52ZXJ0aWNlcyA9IF8ubWFwKHZlcnRpY2VzLCBmdW5jdGlvbih2ZXJ0ZXgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IHZlcnRleC54ICsgdHgsIHk6IHZlcnRleC55ICsgdHkgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIG9wdCk7CiAgICB9Cn0pOwoKCi8vIGpvaW50LmRpYS5MaW5rIGJhc2UgdmlldyBhbmQgY29udHJvbGxlci4KLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQoKam9pbnQuZGlhLkxpbmtWaWV3ID0gam9pbnQuZGlhLkNlbGxWaWV3LmV4dGVuZCh7CgogICAgY2xhc3NOYW1lOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gXy51bmlxdWUodGhpcy5tb2RlbC5nZXQoJ3R5cGUnKS5zcGxpdCgnLicpLmNvbmNhdCgnbGluaycpKS5qb2luKCcgJyk7CiAgICB9LAoKICAgIG9wdGlvbnM6IHsKCiAgICAgICAgc2hvcnRMaW5rTGVuZ3RoOiAxMDAKICAgIH0sCiAgICAKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgLy8gY3JlYXRlIG1ldGhvZHMgaW4gcHJvdG90eXBlLCBzbyB0aGV5IGNhbiBiZSBhY2Nlc3NlZCBmcm9tIGFueSBpbnN0YW5jZSBhbmQKICAgICAgICAvLyBkb24ndCBuZWVkIHRvIGJlIGNyZWF0ZSBvdmVyIGFuZCBvdmVyCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFNvdXJjZSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFNvdXJjZSA9IHRoaXMuX2NyZWF0ZVdhdGNoZXIoJ3NvdXJjZScpOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnByb3RvdHlwZS53YXRjaFRhcmdldCA9IHRoaXMuX2NyZWF0ZVdhdGNoZXIoJ3RhcmdldCcpOwogICAgICAgIH0KCiAgICAgICAgLy8gYF8ubGFiZWxDYWNoZWAgaXMgYSBtYXBwaW5nIG9mIGluZGV4ZXMgb2YgbGFiZWxzIGluIHRoZSBgdGhpcy5nZXQoJ2xhYmVscycpYCBhcnJheSB0bwogICAgICAgIC8vIGA8ZyBjbGFzcz0ibGFiZWwiPmAgbm9kZXMgd3JhcHBlZCBieSBWZWN0b3JpemVyLiBUaGlzIGFsbG93cyBmb3IgcXVpY2sgYWNjZXNzIHRvIHRoZQogICAgICAgIC8vIG5vZGVzIGluIGB1cGRhdGVMYWJlbFBvc2l0aW9uKClgIGluIG9yZGVyIHRvIHVwZGF0ZSB0aGUgbGFiZWwgcG9zaXRpb25zLgogICAgICAgIHRoaXMuX2xhYmVsQ2FjaGUgPSB7fTsKCiAgICAgICAgLy8ga2VlcHMgbWFya2VycyBiYm94ZXMgYW5kIHBvc2l0aW9ucyBhZ2FpbiBmb3IgcXVpY2tlciBhY2Nlc3MKICAgICAgICB0aGlzLl9tYXJrZXJDYWNoZSA9IHt9OwoKICAgICAgICAvLyBiaW5kIGV2ZW50cwogICAgICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTsKICAgIH0sCgogICAgc3RhcnRMaXN0ZW5pbmc6IGZ1bmN0aW9uKCkgewoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTptYXJrdXAnLCB0aGlzLnJlbmRlcik7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6c21vb3RoIGNoYW5nZTptYW5oYXR0YW4gY2hhbmdlOnJvdXRlciBjaGFuZ2U6Y29ubmVjdG9yJywgdGhpcy51cGRhdGUpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTp0b29sTWFya3VwJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyVG9vbHMoKS51cGRhdGVUb29sc1Bvc2l0aW9uKCk7CiAgICAgICAgfSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6bGFiZWxzIGNoYW5nZTpsYWJlbE1hcmt1cCcsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnJlbmRlckxhYmVscygpLnVwZGF0ZUxhYmVsUG9zaXRpb25zKCk7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOnZlcnRpY2VzIGNoYW5nZTp2ZXJ0ZXhNYXJrdXAnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJWZXJ0ZXhNYXJrZXJzKCkudXBkYXRlKCk7CiAgICAgICAgfSk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdjaGFuZ2U6c291cmNlJywgZnVuY3Rpb24oY2VsbCwgc291cmNlKSB7CiAgICAgICAgICAgIHRoaXMud2F0Y2hTb3VyY2UoY2VsbCwgc291cmNlKS51cGRhdGUoKTsKICAgICAgICB9KTsKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2NoYW5nZTp0YXJnZXQnLCBmdW5jdGlvbihjZWxsLCB0YXJnZXQpIHsKICAgICAgICAgICAgdGhpcy53YXRjaFRhcmdldChjZWxsLCB0YXJnZXQpLnVwZGF0ZSgpOwogICAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZW5kZXJpbmcKICAgIC8vLS0tLS0tLS0tLQoKICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7CgoJdGhpcy4kZWwuZW1wdHkoKTsKCiAgICAgICAgLy8gQSBzcGVjaWFsIG1hcmt1cCBjYW4gYmUgZ2l2ZW4gaW4gdGhlIGBwcm9wZXJ0aWVzLm1hcmt1cGAgcHJvcGVydHkuIFRoaXMgbWlnaHQgYmUgaGFuZHkKICAgICAgICAvLyBpZiBlLmcuIGFycm93aGVhZCBtYXJrZXJzIHNob3VsZCBiZSBgPGltYWdlPmAgZWxlbWVudHMgb3IgYW55IG90aGVyIGVsZW1lbnQgdGhhbiBgPHBhdGg+YHMuCiAgICAgICAgLy8gYC5jb25uZWN0aW9uYCwgYC5jb25uZWN0aW9uLXdyYXBgLCBgLm1hcmtlci1zb3VyY2VgIGFuZCBgLm1hcmtlci10YXJnZXRgIHNlbGVjdG9ycwogICAgICAgIC8vIG9mIGVsZW1lbnRzIHdpdGggc3BlY2lhbCBtZWFuaW5nIHRob3VnaC4gVGhlcmVmb3JlLCB0aG9zZSBjbGFzc2VzIHNob3VsZCBiZSBwcmVzZXJ2ZWQgaW4gYW55CiAgICAgICAgLy8gc3BlY2lhbCBtYXJrdXAgcGFzc2VkIGluIGBwcm9wZXJ0aWVzLm1hcmt1cGAuCiAgICAgICAgdmFyIGNoaWxkcmVuID0gVih0aGlzLm1vZGVsLmdldCgnbWFya3VwJykgfHwgdGhpcy5tb2RlbC5tYXJrdXApOwoKICAgICAgICAvLyBjdXN0b20gbWFya3VwIG1heSBjb250YWluIG9ubHkgb25lIGNoaWxkcmVuCiAgICAgICAgaWYgKCFfLmlzQXJyYXkoY2hpbGRyZW4pKSBjaGlsZHJlbiA9IFtjaGlsZHJlbl07CgogICAgICAgIC8vIENhY2hlIGFsbCBjaGlsZHJlbiBlbGVtZW50cyBmb3IgcXVpY2tlciBhY2Nlc3MuCiAgICAgICAgdGhpcy5fViA9IHt9OyAvLyB2ZWN0b3JpemVkIG1hcmt1cDsKICAgICAgICBfLmVhY2goY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHZhciBjID0gY2hpbGQuYXR0cignY2xhc3MnKTsKICAgICAgICAgICAgYyAmJiAodGhpcy5fVlskLmNhbWVsQ2FzZShjKV0gPSBjaGlsZCk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIE9ubHkgdGhlIGNvbm5lY3Rpb24gcGF0aCBpcyBtYW5kYXRvcnkKICAgICAgICBpZiAoIXRoaXMuX1YuY29ubmVjdGlvbikgdGhyb3cgbmV3IEVycm9yKCdsaW5rOiBubyBjb25uZWN0aW9uIHBhdGggaW4gdGhlIG1hcmt1cCcpOwoKICAgICAgICAvLyBwYXJ0aWFsIHJlbmRlcmluZwogICAgICAgIHRoaXMucmVuZGVyVG9vbHMoKTsKICAgICAgICB0aGlzLnJlbmRlclZlcnRleE1hcmtlcnMoKTsKICAgICAgICB0aGlzLnJlbmRlckFycm93aGVhZE1hcmtlcnMoKTsKCiAgICAgICAgVih0aGlzLmVsKS5hcHBlbmQoY2hpbGRyZW4pOwoKICAgICAgICAvLyByZW5kZXJpbmcgbGFiZWxzIGhhcyB0byBiZSBydW4gYWZ0ZXIgdGhlIGxpbmsgaXMgYXBwZW5kZWQgdG8gRE9NIHRyZWUuIChvdGhlcndpc2UgPFRleHQ+IGJib3gKICAgICAgICAvLyByZXR1cm5zIHplcm8gdmFsdWVzKQogICAgICAgIHRoaXMucmVuZGVyTGFiZWxzKCk7CgogICAgICAgIC8vIHN0YXJ0IHdhdGNoaW5nIHRoZSBlbmRzIG9mIHRoZSBsaW5rIGZvciBjaGFuZ2VzCiAgICAgICAgdGhpcy53YXRjaFNvdXJjZSh0aGlzLm1vZGVsLCB0aGlzLm1vZGVsLmdldCgnc291cmNlJykpCiAgICAgICAgICAgIC53YXRjaFRhcmdldCh0aGlzLm1vZGVsLCB0aGlzLm1vZGVsLmdldCgndGFyZ2V0JykpCiAgICAgICAgICAgIC51cGRhdGUoKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlckxhYmVsczogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICghdGhpcy5fVi5sYWJlbHMpIHJldHVybiB0aGlzOwoKICAgICAgICB0aGlzLl9sYWJlbENhY2hlID0ge307CiAgICAgICAgdmFyICRsYWJlbHMgPSAkKHRoaXMuX1YubGFiZWxzLm5vZGUpLmVtcHR5KCk7CgogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLm1vZGVsLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgaWYgKCFsYWJlbHMubGVuZ3RoKSByZXR1cm4gdGhpczsKICAgICAgICAKICAgICAgICB2YXIgbGFiZWxUZW1wbGF0ZSA9IF8udGVtcGxhdGUodGhpcy5tb2RlbC5nZXQoJ2xhYmVsTWFya3VwJykgfHwgdGhpcy5tb2RlbC5sYWJlbE1hcmt1cCk7CiAgICAgICAgLy8gVGhpcyBpcyBhIHByZXBhcmVkIGluc3RhbmNlIG9mIGEgdmVjdG9yaXplZCBTVkdET00gbm9kZSBmb3IgdGhlIGxhYmVsIGVsZW1lbnQgcmVzdWx0aW5nIGZyb20KICAgICAgICAvLyBjb21waWxhdGlvbiBvZiB0aGUgbGFiZWxUZW1wbGF0ZS4gVGhlIHB1cnBvc2UgaXMgdGhhdCBhbGwgbGFiZWxzIHdpbGwganVzdCBgY2xvbmUoKWAgdGhpcwogICAgICAgIC8vIG5vZGUgdG8gY3JlYXRlIGEgZHVwbGljYXRlLgogICAgICAgIHZhciBsYWJlbE5vZGVJbnN0YW5jZSA9IFYobGFiZWxUZW1wbGF0ZSgpKTsKCiAgICAgICAgXy5lYWNoKGxhYmVscywgZnVuY3Rpb24obGFiZWwsIGlkeCkgewoKICAgICAgICAgICAgdmFyIGxhYmVsTm9kZSA9IGxhYmVsTm9kZUluc3RhbmNlLmNsb25lKCkubm9kZTsKICAgICAgICAgICAgLy8gQ2FjaGUgbGFiZWwgbm9kZXMgc28gdGhhdCB0aGUgYHVwZGF0ZUxhYmVscygpYCBjYW4ganVzdCB1cGRhdGUgdGhlIGxhYmVsIG5vZGUgcG9zaXRpb25zLgogICAgICAgICAgICB0aGlzLl9sYWJlbENhY2hlW2lkeF0gPSBWKGxhYmVsTm9kZSk7CgogICAgICAgICAgICB2YXIgJHRleHQgPSAkKGxhYmVsTm9kZSkuZmluZCgndGV4dCcpOwogICAgICAgICAgICB2YXIgJHJlY3QgPSAkKGxhYmVsTm9kZSkuZmluZCgncmVjdCcpOwoKICAgICAgICAgICAgLy8gVGV4dCBhdHRyaWJ1dGVzIHdpdGggdGhlIGRlZmF1bHQgYHRleHQtYW5jaG9yYCBhbmQgZm9udC1zaXplIHNldC4KICAgICAgICAgICAgdmFyIHRleHRBdHRyaWJ1dGVzID0gXy5leHRlbmQoeyAndGV4dC1hbmNob3InOiAnbWlkZGxlJywgJ2ZvbnQtc2l6ZSc6IDE0IH0sIGpvaW50LnV0aWwuZ2V0QnlQYXRoKGxhYmVsLCAnYXR0cnMvdGV4dCcsICcvJykpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHRleHQuYXR0cihfLm9taXQodGV4dEF0dHJpYnV0ZXMsICd0ZXh0JykpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghXy5pc1VuZGVmaW5lZCh0ZXh0QXR0cmlidXRlcy50ZXh0KSkgewoKICAgICAgICAgICAgICAgIFYoJHRleHRbMF0pLnRleHQodGV4dEF0dHJpYnV0ZXMudGV4dCArICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm90ZSB0aGF0IHdlIGZpcnN0IG5lZWQgdG8gYXBwZW5kIHRoZSBgPHRleHQ+YCBlbGVtZW50IHRvIHRoZSBET00gaW4gb3JkZXIgdG8KICAgICAgICAgICAgLy8gZ2V0IGl0cyBib3VuZGluZyBib3guCiAgICAgICAgICAgICRsYWJlbHMuYXBwZW5kKGxhYmVsTm9kZSk7CgogICAgICAgICAgICAvLyBgeS1hbGlnbm1lbnRgIC0gY2VudGVyIHRoZSB0ZXh0IGVsZW1lbnQgYXJvdW5kIGl0cyB5IGNvb3JkaW5hdGUuCiAgICAgICAgICAgIHZhciB0ZXh0QmJveCA9IFYoJHRleHRbMF0pLmJib3godHJ1ZSwgJGxhYmVsc1swXSk7CiAgICAgICAgICAgIFYoJHRleHRbMF0pLnRyYW5zbGF0ZSgwLCAtdGV4dEJib3guaGVpZ2h0LzIpOwoKICAgICAgICAgICAgLy8gQWRkIGRlZmF1bHQgdmFsdWVzLgogICAgICAgICAgICB2YXIgcmVjdEF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7CgogICAgICAgICAgICAgICAgZmlsbDogJ3doaXRlJywKICAgICAgICAgICAgICAgIHJ4OiAzLAogICAgICAgICAgICAgICAgcnk6IDMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9LCBqb2ludC51dGlsLmdldEJ5UGF0aChsYWJlbCwgJ2F0dHJzL3JlY3QnLCAnLycpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICRyZWN0LmF0dHIoXy5leHRlbmQocmVjdEF0dHJpYnV0ZXMsIHsKCiAgICAgICAgICAgICAgICB4OiB0ZXh0QmJveC54LAogICAgICAgICAgICAgICAgeTogdGV4dEJib3gueSAtIHRleHRCYm94LmhlaWdodC8yLCAgLy8gVGFrZSBpbnRvIGFjY291bnQgdGhlIHktYWxpZ25tZW50IHRyYW5zbGF0aW9uLgogICAgICAgICAgICAgICAgd2lkdGg6IHRleHRCYm94LndpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiB0ZXh0QmJveC5oZWlnaHQKICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlclRvb2xzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgaWYgKCF0aGlzLl9WLmxpbmtUb29scykgcmV0dXJuIHRoaXM7CgogICAgICAgIC8vIFRvb2xzIGFyZSBhIGdyb3VwIG9mIGNsaWNrYWJsZSBlbGVtZW50cyB0aGF0IG1hbmlwdWxhdGUgdGhlIHdob2xlIGxpbmsuCiAgICAgICAgLy8gQSBnb29kIGV4YW1wbGUgb2YgdGhpcyBpcyB0aGUgcmVtb3ZlIHRvb2wgdGhhdCByZW1vdmVzIHRoZSB3aG9sZSBsaW5rLgogICAgICAgIC8vIFRvb2xzIGFwcGVhciBhZnRlciBob3ZlcmluZyB0aGUgbGluayBjbG9zZSB0byB0aGUgYHNvdXJjZWAgZWxlbWVudC9wb2ludCBvZiB0aGUgbGluawogICAgICAgIC8vIGJ1dCBhcmUgb2Zmc2V0IGEgYml0IHNvIHRoYXQgdGhleSBkb24ndCBjb3ZlciB0aGUgYG1hcmtlci1hcnJvd2hlYWRgLgoKICAgICAgICB2YXIgJHRvb2xzID0gJCh0aGlzLl9WLmxpbmtUb29scy5ub2RlKS5lbXB0eSgpOwogICAgICAgIHZhciB0b29sVGVtcGxhdGUgPSBfLnRlbXBsYXRlKHRoaXMubW9kZWwuZ2V0KCd0b29sTWFya3VwJykgfHwgdGhpcy5tb2RlbC50b29sTWFya3VwKTsKICAgICAgICB2YXIgdG9vbCA9IFYodG9vbFRlbXBsYXRlKCkpOwoKICAgICAgICAkdG9vbHMuYXBwZW5kKHRvb2wubm9kZSk7CiAgICAgICAgCiAgICAgICAgLy8gQ2FjaGUgdGhlIHRvb2wgbm9kZSBzbyB0aGF0IHRoZSBgdXBkYXRlVG9vbHNQb3NpdGlvbigpYCBjYW4gdXBkYXRlIHRoZSB0b29sIHBvc2l0aW9uIHF1aWNrbHkuCiAgICAgICAgdGhpcy5fdG9vbENhY2hlID0gdG9vbDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJlbmRlclZlcnRleE1hcmtlcnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubWFya2VyVmVydGljZXMpIHJldHVybiB0aGlzOwoKICAgICAgICB2YXIgJG1hcmtlclZlcnRpY2VzID0gJCh0aGlzLl9WLm1hcmtlclZlcnRpY2VzLm5vZGUpLmVtcHR5KCk7CgogICAgICAgIC8vIEEgc3BlY2lhbCBtYXJrdXAgY2FuIGJlIGdpdmVuIGluIHRoZSBgcHJvcGVydGllcy52ZXJ0ZXhNYXJrdXBgIHByb3BlcnR5LiBUaGlzIG1pZ2h0IGJlIGhhbmR5CiAgICAgICAgLy8gaWYgZGVmYXVsdCBzdHlsaW5nIChlbGVtZW50cykgYXJlIG5vdCBkZXNpcmVkLiBUaGlzIG1ha2VzIGl0IHBvc3NpYmxlIHRvIHVzZSBhbnkKICAgICAgICAvLyBTVkcgZWxlbWVudHMgZm9yIC5tYXJrZXItdmVydGV4IGFuZCAubWFya2VyLXZlcnRleC1yZW1vdmUgdG9vbHMuCiAgICAgICAgdmFyIG1hcmt1cFRlbXBsYXRlID0gXy50ZW1wbGF0ZSh0aGlzLm1vZGVsLmdldCgndmVydGV4TWFya3VwJykgfHwgdGhpcy5tb2RlbC52ZXJ0ZXhNYXJrdXApOwogICAgICAgIAogICAgICAgIF8uZWFjaCh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSwgZnVuY3Rpb24odmVydGV4LCBpZHgpIHsKCiAgICAgICAgICAgICRtYXJrZXJWZXJ0aWNlcy5hcHBlbmQoVihtYXJrdXBUZW1wbGF0ZShfLmV4dGVuZCh7IGlkeDogaWR4IH0sIHZlcnRleCkpKS5ub2RlKTsKICAgICAgICB9KTsKICAgICAgICAKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgcmVuZGVyQXJyb3doZWFkTWFya2VyczogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIEN1c3RvbSBtYXJrdXBzIG1pZ2h0IG5vdCBoYXZlIGFycm93aGVhZCBtYXJrZXJzLiBUaGVyZWZvcmUsIGp1bXAgb2YgdGhpcyBmdW5jdGlvbiBpbW1lZGlhdGVseSBpZiB0aGF0J3MgdGhlIGNhc2UuCiAgICAgICAgaWYgKCF0aGlzLl9WLm1hcmtlckFycm93aGVhZHMpIHJldHVybiB0aGlzOwoKICAgICAgICB2YXIgJG1hcmtlckFycm93aGVhZHMgPSAkKHRoaXMuX1YubWFya2VyQXJyb3doZWFkcy5ub2RlKTsKCiAgICAgICAgJG1hcmtlckFycm93aGVhZHMuZW1wdHkoKTsKCiAgICAgICAgLy8gQSBzcGVjaWFsIG1hcmt1cCBjYW4gYmUgZ2l2ZW4gaW4gdGhlIGBwcm9wZXJ0aWVzLnZlcnRleE1hcmt1cGAgcHJvcGVydHkuIFRoaXMgbWlnaHQgYmUgaGFuZHkKICAgICAgICAvLyBpZiBkZWZhdWx0IHN0eWxpbmcgKGVsZW1lbnRzKSBhcmUgbm90IGRlc2lyZWQuIFRoaXMgbWFrZXMgaXQgcG9zc2libGUgdG8gdXNlIGFueQogICAgICAgIC8vIFNWRyBlbGVtZW50cyBmb3IgLm1hcmtlci12ZXJ0ZXggYW5kIC5tYXJrZXItdmVydGV4LXJlbW92ZSB0b29scy4KICAgICAgICB2YXIgbWFya3VwVGVtcGxhdGUgPSBfLnRlbXBsYXRlKHRoaXMubW9kZWwuZ2V0KCdhcnJvd2hlYWRNYXJrdXAnKSB8fCB0aGlzLm1vZGVsLmFycm93aGVhZE1hcmt1cCk7CgogICAgICAgIHRoaXMuX1Yuc291cmNlQXJyb3doZWFkID0gVihtYXJrdXBUZW1wbGF0ZSh7IGVuZDogJ3NvdXJjZScgfSkpOwogICAgICAgIHRoaXMuX1YudGFyZ2V0QXJyb3doZWFkID0gVihtYXJrdXBUZW1wbGF0ZSh7IGVuZDogJ3RhcmdldCcgfSkpOwoKICAgICAgICAkbWFya2VyQXJyb3doZWFkcy5hcHBlbmQodGhpcy5fVi5zb3VyY2VBcnJvd2hlYWQubm9kZSwgdGhpcy5fVi50YXJnZXRBcnJvd2hlYWQubm9kZSk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBVcGRhdGluZwogICAgLy8tLS0tLS0tLS0KCiAgICAvLyBEZWZhdWx0IGlzIHRvIHByb2Nlc3MgdGhlIGBhdHRyc2Agb2JqZWN0IGFuZCBzZXQgYXR0cmlidXRlcyBvbiBzdWJlbGVtZW50cyBiYXNlZCBvbiB0aGUgc2VsZWN0b3JzLgogICAgdXBkYXRlOiBmdW5jdGlvbigpIHsKCiAgICAgICAgLy8gVXBkYXRlIGF0dHJpYnV0ZXMuCiAgICAgICAgXy5lYWNoKHRoaXMubW9kZWwuZ2V0KCdhdHRycycpLCBmdW5jdGlvbihhdHRycywgc2VsZWN0b3IpIHsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIElmIHRoZSBgZmlsdGVyYCBhdHRyaWJ1dGUgaXMgYW4gb2JqZWN0LCBpdCBpcyBpbiB0aGUgc3BlY2lhbCBKb2ludEpTIGZpbHRlciBmb3JtYXQgYW5kIHNvCiAgICAgICAgICAgIC8vIGl0IGJlY29tZXMgYSBzcGVjaWFsIGF0dHJpYnV0ZSBhbmQgaXMgdHJlYXRlZCBzZXBhcmF0ZWx5LgogICAgICAgICAgICBpZiAoXy5pc09iamVjdChhdHRycy5maWx0ZXIpKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRoaXMuZmluZEJ5U2VsZWN0b3Ioc2VsZWN0b3IpLmF0dHIoXy5vbWl0KGF0dHJzLCAnZmlsdGVyJykpOwogICAgICAgICAgICAgICAgdGhpcy5hcHBseUZpbHRlcihzZWxlY3RvciwgYXR0cnMuZmlsdGVyKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0aGlzLmZpbmRCeVNlbGVjdG9yKHNlbGVjdG9yKS5hdHRyKGF0dHJzKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICAvLyBQYXRoIGZpbmRpbmcKICAgICAgICB2YXIgdmVydGljZXMgPSB0aGlzLnJvdXRlID0gdGhpcy5maW5kUm91dGUodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwgW10pOwoKICAgICAgICAvLyBmaW5kcyBhbGwgdGhlIGNvbm5lY3Rpb24gcG9pbnRzIHRha2luZyBuZXcgdmVydGljZXMgaW50byBhY2NvdW50CiAgICAgICAgdGhpcy5fZmluZENvbm5lY3Rpb25Qb2ludHModmVydGljZXMpOwoKICAgICAgICB2YXIgcGF0aERhdGEgPSB0aGlzLmdldFBhdGhEYXRhKHZlcnRpY2VzKTsKCiAgICAgICAgLy8gVGhlIG1hcmt1cCBuZWVkcyB0byBjb250YWluIGEgYC5jb25uZWN0aW9uYAogICAgICAgIHRoaXMuX1YuY29ubmVjdGlvbi5hdHRyKCdkJywgcGF0aERhdGEpOwogICAgICAgIHRoaXMuX1YuY29ubmVjdGlvbldyYXAgJiYgdGhpcy5fVi5jb25uZWN0aW9uV3JhcC5hdHRyKCdkJywgcGF0aERhdGEpOwoKICAgICAgICB0aGlzLl90cmFuc2xhdGVBbmRBdXRvT3JpZW50QXJyb3dzKHRoaXMuX1YubWFya2VyU291cmNlLCB0aGlzLl9WLm1hcmtlclRhcmdldCk7CgogICAgICAgIC8vcGFydGlhbHMgdXBkYXRlcwogICAgICAgIHRoaXMudXBkYXRlTGFiZWxQb3NpdGlvbnMoKTsKICAgICAgICB0aGlzLnVwZGF0ZVRvb2xzUG9zaXRpb24oKTsKICAgICAgICB0aGlzLnVwZGF0ZUFycm93aGVhZE1hcmtlcnMoKTsKCiAgICAgICAgZGVsZXRlIHRoaXMub3B0aW9ucy5wZXJwZW5kaWN1bGFyOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgX2ZpbmRDb25uZWN0aW9uUG9pbnRzOiBmdW5jdGlvbih2ZXJ0aWNlcykgewoKICAgICAgICAvLyBjYWNoZSBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMKICAgICAgICB2YXIgc291cmNlUG9pbnQsIHRhcmdldFBvaW50LCBzb3VyY2VNYXJrZXJQb2ludCwgdGFyZ2V0TWFya2VyUG9pbnQ7CgogICAgICAgIHZhciBmaXJzdFZlcnRleCA9IF8uZmlyc3QodmVydGljZXMpOwoKICAgICAgICBzb3VyY2VQb2ludCA9IHRoaXMuZ2V0Q29ubmVjdGlvblBvaW50KAogICAgICAgICAgICAnc291cmNlJywgdGhpcy5tb2RlbC5nZXQoJ3NvdXJjZScpLCBmaXJzdFZlcnRleCB8fCB0aGlzLm1vZGVsLmdldCgndGFyZ2V0JykKICAgICAgICApLnJvdW5kKCk7CgogICAgICAgIHZhciBsYXN0VmVydGV4ID0gXy5sYXN0KHZlcnRpY2VzKTsKCiAgICAgICAgdGFyZ2V0UG9pbnQgPSB0aGlzLmdldENvbm5lY3Rpb25Qb2ludCgKICAgICAgICAgICAgJ3RhcmdldCcsIHRoaXMubW9kZWwuZ2V0KCd0YXJnZXQnKSwgbGFzdFZlcnRleCB8fCBzb3VyY2VQb2ludAogICAgICAgICkucm91bmQoKTsKCiAgICAgICAgLy8gTW92ZSB0aGUgc291cmNlIHBvaW50IGJ5IHRoZSB3aWR0aCBvZiB0aGUgbWFya2VyIHRha2luZyBpbnRvIGFjY291bnQKICAgICAgICAvLyBpdHMgc2NhbGUgYXJvdW5kIHgtYXhpcy4gTm90ZSB0aGF0IHNjYWxlIGlzIHRoZSBvbmx5IHRyYW5zZm9ybSB0aGF0CiAgICAgICAgLy8gbWFrZXMgc2Vuc2UgdG8gYmUgc2V0IGluIGAubWFya2VyLXNvdXJjZWAgYXR0cmlidXRlcyBvYmplY3QKICAgICAgICAvLyBhcyBhbGwgb3RoZXIgdHJhbnNmb3JtcyAodHJhbnNsYXRlL3JvdGF0ZSkgd2lsbCBiZSByZXBsYWNlZAogICAgICAgIC8vIGJ5IHRoZSBgdHJhbnNsYXRlQW5kQXV0b09yaWVudCgpYCBmdW5jdGlvbi4KICAgICAgICB2YXIgY2FjaGUgPSB0aGlzLl9tYXJrZXJDYWNoZTsKCiAgICAgICAgaWYgKHRoaXMuX1YubWFya2VyU291cmNlKSB7CgogICAgICAgICAgICBjYWNoZS5zb3VyY2VCQm94ID0gY2FjaGUuc291cmNlQkJveCB8fCB0aGlzLl9WLm1hcmtlclNvdXJjZS5iYm94KHRydWUpOwoKICAgICAgICAgICAgc291cmNlTWFya2VyUG9pbnQgPSBnLnBvaW50KHNvdXJjZVBvaW50KS5tb3ZlKAogICAgICAgICAgICAgICAgZmlyc3RWZXJ0ZXggfHwgdGFyZ2V0UG9pbnQsCiAgICAgICAgICAgICAgICBjYWNoZS5zb3VyY2VCQm94LndpZHRoICogdGhpcy5fVi5tYXJrZXJTb3VyY2Uuc2NhbGUoKS5zeCAqIC0xCiAgICAgICAgICAgICkucm91bmQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9WLm1hcmtlclRhcmdldCkgewoKICAgICAgICAgICAgY2FjaGUudGFyZ2V0QkJveCA9IGNhY2hlLnRhcmdldEJCb3ggfHwgdGhpcy5fVi5tYXJrZXJUYXJnZXQuYmJveCh0cnVlKTsKCiAgICAgICAgICAgIHRhcmdldE1hcmtlclBvaW50ID0gZy5wb2ludCh0YXJnZXRQb2ludCkubW92ZSgKICAgICAgICAgICAgICAgIGxhc3RWZXJ0ZXggfHwgc291cmNlUG9pbnQsCiAgICAgICAgICAgICAgICBjYWNoZS50YXJnZXRCQm94LndpZHRoICogdGhpcy5fVi5tYXJrZXJUYXJnZXQuc2NhbGUoKS5zeCAqIC0xCiAgICAgICAgICAgICkucm91bmQoKTsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHRoZXJlIHdhcyBubyBtYXJrdXAgZm9yIHRoZSBtYXJrZXIsIHVzZSB0aGUgY29ubmVjdGlvbiBwb2ludC4KICAgICAgICBjYWNoZS5zb3VyY2VQb2ludCA9IHNvdXJjZU1hcmtlclBvaW50IHx8IHNvdXJjZVBvaW50OwogICAgICAgIGNhY2hlLnRhcmdldFBvaW50ID0gdGFyZ2V0TWFya2VyUG9pbnQgfHwgdGFyZ2V0UG9pbnQ7CgogICAgICAgIC8vIG1ha2UgY29ubmVjdGlvbiBwb2ludHMgcHVibGljCiAgICAgICAgdGhpcy5zb3VyY2VQb2ludCA9IHNvdXJjZVBvaW50OwogICAgICAgIHRoaXMudGFyZ2V0UG9pbnQgPSB0YXJnZXRQb2ludDsKICAgIH0sCgogICAgdXBkYXRlTGFiZWxQb3NpdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubGFiZWxzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gVGhpcyBtZXRob2QgYXNzdW1lcyBhbGwgdGhlIGxhYmVsIG5vZGVzIGFyZSBzdG9yZWQgaW4gdGhlIGB0aGlzLl9sYWJlbENhY2hlYCBoYXNoIHRhYmxlCiAgICAgICAgLy8gYnkgdGhlaXIgaW5kZXhlcyBpbiB0aGUgYHRoaXMuZ2V0KCdsYWJlbHMnKWAgYXJyYXkuIFRoaXMgaXMgZG9uZSBpbiB0aGUgYHJlbmRlckxhYmVscygpYCBtZXRob2QuCgogICAgICAgIHZhciBsYWJlbHMgPSB0aGlzLm1vZGVsLmdldCgnbGFiZWxzJykgfHwgW107CiAgICAgICAgaWYgKCFsYWJlbHMubGVuZ3RoKSByZXR1cm4gdGhpczsKCiAgICAgICAgdmFyIGNvbm5lY3Rpb25FbGVtZW50ID0gdGhpcy5fVi5jb25uZWN0aW9uLm5vZGU7CiAgICAgICAgdmFyIGNvbm5lY3Rpb25MZW5ndGggPSBjb25uZWN0aW9uRWxlbWVudC5nZXRUb3RhbExlbmd0aCgpOwoKICAgICAgICBfLmVhY2gobGFiZWxzLCBmdW5jdGlvbihsYWJlbCwgaWR4KSB7CgogICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBsYWJlbC5wb3NpdGlvbjsKICAgICAgICAgICAgcG9zaXRpb24gPSAocG9zaXRpb24gPiBjb25uZWN0aW9uTGVuZ3RoKSA/IGNvbm5lY3Rpb25MZW5ndGggOiBwb3NpdGlvbjsgLy8gc2FuaXR5IGNoZWNrCiAgICAgICAgICAgIHBvc2l0aW9uID0gKHBvc2l0aW9uIDwgMCkgPyBjb25uZWN0aW9uTGVuZ3RoICsgcG9zaXRpb24gOiBwb3NpdGlvbjsKICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbiA+IDEgPyBwb3NpdGlvbiA6IGNvbm5lY3Rpb25MZW5ndGggKiBwb3NpdGlvbjsKCiAgICAgICAgICAgIHZhciBsYWJlbENvb3JkaW5hdGVzID0gY29ubmVjdGlvbkVsZW1lbnQuZ2V0UG9pbnRBdExlbmd0aChwb3NpdGlvbik7CgogICAgICAgICAgICB0aGlzLl9sYWJlbENhY2hlW2lkeF0uYXR0cigndHJhbnNmb3JtJywgJ3RyYW5zbGF0ZSgnICsgbGFiZWxDb29yZGluYXRlcy54ICsgJywgJyArIGxhYmVsQ29vcmRpbmF0ZXMueSArICcpJyk7CgogICAgICAgIH0sIHRoaXMpOwoKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgoKICAgIHVwZGF0ZVRvb2xzUG9zaXRpb246IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAoIXRoaXMuX1YubGlua1Rvb2xzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gTW92ZSB0aGUgdG9vbHMgYSBiaXQgdG8gdGhlIHRhcmdldCBwb3NpdGlvbiBidXQgZG9uJ3QgY292ZXIgdGhlIGBzb3VyY2VBcnJvd2hlYWRgIG1hcmtlci4KICAgICAgICAvLyBOb3RlIHRoYXQgdGhlIG9mZnNldCBpcyBoYXJkY29kZWQgaGVyZS4gVGhlIG9mZnNldCBzaG91bGQgYmUgYWx3YXlzCiAgICAgICAgLy8gbW9yZSB0aGFuIHRoZSBgdGhpcy4kKCcubWFya2VyLWFycm93aGVhZFtlbmQ9InNvdXJjZSJdJylbMF0uYmJveCgpLndpZHRoYCBidXQgbG9va2luZwogICAgICAgIC8vIHRoaXMgdXAgYWxsIHRoZSB0aW1lIHdvdWxkIGJlIHNsb3cuCgogICAgICAgIHZhciBzY2FsZSA9ICcnOwogICAgICAgIHZhciBvZmZzZXQgPSA0MDsKCiAgICAgICAgLy8gSWYgdGhlIGxpbmsgaXMgdG9vIHNob3J0LCBtYWtlIHRoZSB0b29scyBoYWxmIHRoZSBzaXplIGFuZCB0aGUgb2Zmc2V0IHR3aWNlIGFzIGxvdy4KICAgICAgICBpZiAodGhpcy5nZXRDb25uZWN0aW9uTGVuZ3RoKCkgPCB0aGlzLm9wdGlvbnMuc2hvcnRMaW5rTGVuZ3RoKSB7CiAgICAgICAgICAgIHNjYWxlID0gJ3NjYWxlKC41KSc7CiAgICAgICAgICAgIG9mZnNldCAvPSAyOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRvb2xQb3NpdGlvbiA9IHRoaXMuZ2V0UG9pbnRBdExlbmd0aChvZmZzZXQpOwogICAgICAgIAogICAgICAgIHRoaXMuX3Rvb2xDYWNoZS5hdHRyKCd0cmFuc2Zvcm0nLCAndHJhbnNsYXRlKCcgKyB0b29sUG9zaXRpb24ueCArICcsICcgKyB0b29sUG9zaXRpb24ueSArICcpICcgKyBzY2FsZSk7CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCgogICAgdXBkYXRlQXJyb3doZWFkTWFya2VyczogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmICghdGhpcy5fVi5tYXJrZXJBcnJvd2hlYWRzKSByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gZ2V0dGluZyBiYm94IG9mIGFuIGVsZW1lbnQgd2l0aCBgZGlzcGxheT0ibm9uZSJgIGluIElFOSBlbmRzIHVwIHdpdGggYWNjZXNzIHZpb2xhdGlvbgogICAgICAgIGlmICgkLmNzcyh0aGlzLl9WLm1hcmtlckFycm93aGVhZHMubm9kZSwgJ2Rpc3BsYXknKSA9PT0gJ25vbmUnKSByZXR1cm4gdGhpczsKCiAgICAgICAgdmFyIHN4ID0gdGhpcy5nZXRDb25uZWN0aW9uTGVuZ3RoKCkgPCB0aGlzLm9wdGlvbnMuc2hvcnRMaW5rTGVuZ3RoID8gLjUgOiAxOwogICAgICAgIHRoaXMuX1Yuc291cmNlQXJyb3doZWFkLnNjYWxlKHN4KTsKICAgICAgICB0aGlzLl9WLnRhcmdldEFycm93aGVhZC5zY2FsZShzeCk7CgogICAgICAgIHRoaXMuX3RyYW5zbGF0ZUFuZEF1dG9PcmllbnRBcnJvd3ModGhpcy5fVi5zb3VyY2VBcnJvd2hlYWQsIHRoaXMuX1YudGFyZ2V0QXJyb3doZWFkKTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJldHVybnMgYSBmdW5jdGlvbiBvYnNlcnZpbmcgY2hhbmdlcyBvbiBhbiBlbmQgb2YgdGhlIGxpbmsuIElmIGEgY2hhbmdlIGhhcHBlbnMgYW5kIG5ldyBlbmQgaXMgYSBuZXcgbW9kZWwsCiAgICAvLyBpdCBzdG9wcyBsaXN0ZW5pbmcgb24gdGhlIHByZXZpb3VzIG9uZSBhbmQgc3RhcnRzIGxpc3RlbmluZyB0byB0aGUgbmV3IG9uZS4KICAgIF9jcmVhdGVXYXRjaGVyOiBmdW5jdGlvbihlbmRUeXBlKSB7CgogICAgICAgIGZ1bmN0aW9uIHdhdGNoRW5kKGxpbmssIGVuZCkgewoKICAgICAgICAgICAgZW5kID0gZW5kIHx8IHt9OwoKICAgICAgICAgICAgdmFyIHByZXZpb3VzRW5kID0gbGluay5wcmV2aW91cyhlbmRUeXBlKSB8fCB7fTsKCiAgICAgICAgICAgIC8vIFBpY2sgdXBkYXRlTWV0aG9kIHRoaXMuX3NvdXJjZUJib3hVcGRhdGUgb3IgdGhpcy5fdGFyZ2V0QmJveFVwZGF0ZS4KICAgICAgICAgICAgdmFyIHVwZGF0ZUVuZEZ1bmN0aW9uID0gdGhpc1snXycgKyBlbmRUeXBlICsgJ0JCb3hVcGRhdGUnXTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9pc01vZGVsKHByZXZpb3VzRW5kKSkgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHRoaXMucGFwZXIuZ2V0TW9kZWxCeUlkKHByZXZpb3VzRW5kLmlkKSwgJ2NoYW5nZScsIHVwZGF0ZUVuZEZ1bmN0aW9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX2lzTW9kZWwoZW5kKSkgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIG9ic2VydmVkIG1vZGVsIGNoYW5nZXMsIGl0IGNhY2hlcyBhIG5ldyBiYm94IGFuZCBkbyB0aGUgbGluayB1cGRhdGUuCiAgICAgICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMucGFwZXIuZ2V0TW9kZWxCeUlkKGVuZC5pZCksICdjaGFuZ2UnLCB1cGRhdGVFbmRGdW5jdGlvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF8uYmluZCh1cGRhdGVFbmRGdW5jdGlvbiwgdGhpcykoeyBjYWNoZU9ubHk6IHRydWUgfSk7CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIHJldHVybiB3YXRjaEVuZDsKICAgIH0sCgogICAgLy8gSXQncyBpbXBvcnRhbnQgdG8ga2VlcCBib3RoIG1ldGhvZHMgKHNvdXJjZUJib3hVcGRhdGUgYW5kIHRhcmdldEJib3hVcGRhdGUpIGFzIHVuaXF1ZSBtZXRob2RzCiAgICAvLyBiZWNhdXNlIG9mIGxvb3AgbGlua3MuIFdlIGhhdmUgdG8gYmUgYWJsZSB0byBkZXRlcm1pbmUsIHdoaWNoIG1ldGhvZCB3ZSB3YW50IHRvIHN0b3AgbGlzdGVuIHRvLgogICAgLy8gTGlzdGVuVG8obW9kZWwsIGV2ZW50LCBoYW5kbGVyKSBhcyBtb2RlbCBhbmQgZXZlbnQgd2lsbCBiZSBpZGVudGljYWwuCiAgICBfc291cmNlQkJveFVwZGF0ZTogZnVuY3Rpb24odXBkYXRlKSB7CgogICAgICAgIC8vIGtlZXAgdHJhY2sgd2hpY2ggZW5kIGhhZCBiZWVuIGNoYW5nZWQgdmVyeSBsYXN0CiAgICAgICAgdGhpcy5sYXN0RW5kQ2hhbmdlID0gJ3NvdXJjZSc7CgogICAgICAgIHVwZGF0ZSA9IHVwZGF0ZSB8fCB7fTsKICAgICAgICB2YXIgZW5kID0gdGhpcy5tb2RlbC5nZXQoJ3NvdXJjZScpOwoKICAgICAgICBpZiAodGhpcy5faXNNb2RlbChlbmQpKSB7CgogICAgICAgICAgICB2YXIgc2VsZWN0b3IgPSB0aGlzLl9tYWtlU2VsZWN0b3IoZW5kKTsKICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLnBhcGVyLmZpbmRWaWV3QnlNb2RlbChlbmQuaWQpOwogICAgICAgICAgICB2YXIgbWFnbmV0RWxlbWVudCA9IHRoaXMucGFwZXIudmlld3BvcnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7CgogICAgICAgICAgICB0aGlzLnNvdXJjZUJCb3ggPSB2aWV3LmdldFN0cm9rZUJCb3gobWFnbmV0RWxlbWVudCk7CgkgICAgdGhpcy5zb3VyY2VWaWV3ID0gdmlldzsKCSAgICB0aGlzLnNvdXJjZU1hZ25ldCA9IG1hZ25ldEVsZW1lbnQ7CgogICAgICAgIH0gZWxzZSBpZiAoZW5kKSB7CiAgICAgICAgICAgIC8vIHRoZSBsaW5rIGVuZCBpcyBhIHBvaW50IH4gcmVjdCAxeDEKICAgICAgICAgICAgdGhpcy5zb3VyY2VCQm94ID0gZy5yZWN0KGVuZC54LCBlbmQueSwgMSwgMSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXVwZGF0ZS5jYWNoZU9ubHkpIHRoaXMudXBkYXRlKCk7CiAgICB9LAoKICAgIF90YXJnZXRCQm94VXBkYXRlOiBmdW5jdGlvbih1cGRhdGUpIHsKCiAgICAgICAgLy8ga2VlcCB0cmFjayB3aGljaCBlbmQgaGFkIGJlZW4gY2hhbmdlZCB2ZXJ5IGxhc3QKICAgICAgICB0aGlzLmxhc3RFbmRDaGFuZ2UgPSAndGFyZ2V0JzsKCiAgICAgICAgdXBkYXRlID0gdXBkYXRlIHx8IHt9OwogICAgICAgIHZhciBlbmQgPSB0aGlzLm1vZGVsLmdldCgndGFyZ2V0Jyk7CgogICAgICAgIGlmICh0aGlzLl9pc01vZGVsKGVuZCkpIHsKCiAgICAgICAgICAgIHZhciBzZWxlY3RvciA9IHRoaXMuX21ha2VTZWxlY3RvcihlbmQpOwogICAgICAgICAgICB2YXIgdmlldyA9IHRoaXMucGFwZXIuZmluZFZpZXdCeU1vZGVsKGVuZC5pZCk7CiAgICAgICAgICAgIHZhciBtYWduZXRFbGVtZW50ID0gdGhpcy5wYXBlci52aWV3cG9ydC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKCiAgICAgICAgICAgIHRoaXMudGFyZ2V0QkJveCA9IHZpZXcuZ2V0U3Ryb2tlQkJveChtYWduZXRFbGVtZW50KTsKCSAgICB0aGlzLnRhcmdldFZpZXcgPSB2aWV3OwoJICAgIHRoaXMudGFyZ2V0TWFnbmV0ID0gbWFnbmV0RWxlbWVudDsKCiAgICAgICAgfSBlbHNlIGlmIChlbmQpIHsKICAgICAgICAgICAgLy8gdGhlIGxpbmsgZW5kIGlzIGEgcG9pbnQgfiByZWN0IDF4MQogICAgICAgICAgICB0aGlzLnRhcmdldEJCb3ggPSBnLnJlY3QoZW5kLngsIGVuZC55LCAxLCAxKTsKICAgICAgICB9CgogICAgICAgIGlmICghdXBkYXRlLmNhY2hlT25seSkgdGhpcy51cGRhdGUoKTsKICAgIH0sCgogICAgX3RyYW5zbGF0ZUFuZEF1dG9PcmllbnRBcnJvd3M6IGZ1bmN0aW9uKHNvdXJjZUFycm93LCB0YXJnZXRBcnJvdykgewoKICAgICAgICAvLyBNYWtlIHRoZSBtYXJrZXJzICJwb2ludCIgdG8gdGhlaXIgc3RpY2t5IHBvaW50cyBiZWluZyBhdXRvLW9yaWVudGVkIHRvd2FyZHMKICAgICAgICAvLyBgdGFyZ2V0UG9zaXRpb25gL2Bzb3VyY2VQb3NpdGlvbmAuIEFuZCBkbyBzbyBvbmx5IGlmIHRoZXJlIGlzIGEgbWFya3VwIGZvciB0aGVtLgogICAgICAgIGlmIChzb3VyY2VBcnJvdykgewogICAgICAgICAgICBzb3VyY2VBcnJvdy50cmFuc2xhdGVBbmRBdXRvT3JpZW50KAogICAgICAgICAgICAgICAgdGhpcy5zb3VyY2VQb2ludCwKICAgICAgICAgICAgICAgIF8uZmlyc3QodGhpcy5yb3V0ZSkgfHwgdGhpcy50YXJnZXRQb2ludCwKICAgICAgICAgICAgICAgIHRoaXMucGFwZXIudmlld3BvcnQKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YXJnZXRBcnJvdykgewogICAgICAgICAgICB0YXJnZXRBcnJvdy50cmFuc2xhdGVBbmRBdXRvT3JpZW50KAogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRQb2ludCwKICAgICAgICAgICAgICAgIF8ubGFzdCh0aGlzLnJvdXRlKSB8fCB0aGlzLnNvdXJjZVBvaW50LAogICAgICAgICAgICAgICAgdGhpcy5wYXBlci52aWV3cG9ydAogICAgICAgICAgICApOwogICAgICAgIH0KICAgIH0sCgogICAgcmVtb3ZlVmVydGV4OiBmdW5jdGlvbihpZHgpIHsKCiAgICAgICAgdmFyIHZlcnRpY2VzID0gXy5jbG9uZSh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSk7CiAgICAgICAgCiAgICAgICAgaWYgKHZlcnRpY2VzICYmIHZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICAgICAgdmVydGljZXMuc3BsaWNlKGlkeCwgMSk7CiAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KCd2ZXJ0aWNlcycsIHZlcnRpY2VzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUaGlzIG1ldGhvZCBhZHMgYSBuZXcgdmVydGV4IHRvIHRoZSBgdmVydGljZXNgIGFycmF5IG9mIGAuY29ubmVjdGlvbmAuIFRoaXMgbWV0aG9kCiAgICAvLyB1c2VzIGEgaGV1cmlzdGljIHRvIGZpbmQgdGhlIGluZGV4IGF0IHdoaWNoIHRoZSBuZXcgYHZlcnRleGAgc2hvdWxkIGJlIHBsYWNlZCBhdCBhc3N1bWluZwogICAgLy8gdGhlIG5ldyB2ZXJ0ZXggaXMgc29tZXdoZXJlIG9uIHRoZSBwYXRoLgogICAgYWRkVmVydGV4OiBmdW5jdGlvbih2ZXJ0ZXgpIHsKCiAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ2F0dHJzJywgdGhpcy5tb2RlbC5nZXQoJ2F0dHJzJykgfHwge30pOwogICAgICAgIHZhciBhdHRycyA9IHRoaXMubW9kZWwuZ2V0KCdhdHRycycpOwogICAgICAgIAogICAgICAgIC8vIEFzIGl0IGlzIHZlcnkgaGFyZCB0byBmaW5kIGEgY29ycmVjdCBpbmRleCBvZiB0aGUgbmV3bHkgY3JlYXRlZCB2ZXJ0ZXgsCiAgICAgICAgLy8gYSBsaXR0bGUgaGV1cmlzdGljcyBpcyB0YWtpbmcgcGxhY2UgaGVyZS4KICAgICAgICAvLyBUaGUgaGV1cmlzdGljcyBjaGVja3MgaWYgbGVuZ3RoIG9mIHRoZSBuZXdseSBjcmVhdGVkCiAgICAgICAgLy8gcGF0aCBpcyBsb3QgbW9yZSB0aGFuIGxlbmd0aCBvZiB0aGUgb2xkIHBhdGguIElmIHRoaXMgaXMgdGhlIGNhc2UsCiAgICAgICAgLy8gbmV3IHZlcnRleCB3YXMgcHJvYmFibHkgcHV0IGludG8gYSB3cm9uZyBpbmRleC4KICAgICAgICAvLyBUcnkgdG8gcHV0IGl0IGludG8gYW5vdGhlciBpbmRleCBhbmQgcmVwZWF0IHRoZSBoZXVyaXN0aWNzIGFnYWluLgoKICAgICAgICB2YXIgdmVydGljZXMgPSAodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwgW10pLnNsaWNlKCk7CiAgICAgICAgLy8gU3RvcmUgdGhlIG9yaWdpbmFsIHZlcnRpY2VzIGZvciBhIGxhdGVyIHJldmVydCBpZiBuZWVkZWQuCiAgICAgICAgdmFyIG9yaWdpbmFsVmVydGljZXMgPSB2ZXJ0aWNlcy5zbGljZSgpOwoKICAgICAgICAvLyBBIGA8cGF0aD5gIGVsZW1lbnQgdXNlZCB0byBjb21wdXRlIHRoZSBsZW5ndGggb2YgdGhlIHBhdGggZHVyaW5nIGhldXJpc3RpY3MuCiAgICAgICAgdmFyIHBhdGggPSB0aGlzLl9WLmNvbm5lY3Rpb24ubm9kZS5jbG9uZU5vZGUoZmFsc2UpOwogICAgICAgIAogICAgICAgIC8vIExlbmd0aCBvZiB0aGUgb3JpZ2luYWwgcGF0aC4gICAgICAgIAogICAgICAgIHZhciBvcmlnaW5hbFBhdGhMZW5ndGggPSBwYXRoLmdldFRvdGFsTGVuZ3RoKCk7CiAgICAgICAgLy8gQ3VycmVudCBwYXRoIGxlbmd0aC4KICAgICAgICB2YXIgcGF0aExlbmd0aDsKICAgICAgICAvLyBUb2xlcmFuY2UgZGV0ZXJtaW5lcyB0aGUgaGlnaGVzdCBwb3NzaWJsZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGxlbmd0aAogICAgICAgIC8vIG9mIHRoZSBvbGQgYW5kIG5ldyBwYXRoLiBUaGUgbnVtYmVyIGhhcyBiZWVuIGNob3NlbiBoZXVyaXN0aWNhbGx5LgogICAgICAgIHZhciBwYXRoTGVuZ3RoVG9sZXJhbmNlID0gMjA7CiAgICAgICAgLy8gVG90YWwgbnVtYmVyIG9mIHZlcnRpY2VzIGluY2x1ZGluZyBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMuCiAgICAgICAgdmFyIGlkeCA9IHZlcnRpY2VzLmxlbmd0aCArIDE7CgogICAgICAgIC8vIExvb3AgdGhyb3VnaCBhbGwgcG9zc2libGUgaW5kZXhlcyBhbmQgY2hlY2sgaWYgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbgogICAgICAgIC8vIHBhdGggbGVuZ3RocyBjaGFuZ2VzIHNpZ25pZmljYW50bHkuIElmIG5vdCwgdGhlIGZvdW5kIGluZGV4IGlzCiAgICAgICAgLy8gbW9zdCBwcm9iYWJseSB0aGUgcmlnaHQgb25lLgogICAgICAgIHdoaWxlIChpZHgtLSkgewoKICAgICAgICAgICAgdmVydGljZXMuc3BsaWNlKGlkeCwgMCwgdmVydGV4KTsKICAgICAgICAgICAgVihwYXRoKS5hdHRyKCdkJywgdGhpcy5nZXRQYXRoRGF0YSh0aGlzLmZpbmRSb3V0ZSh2ZXJ0aWNlcykpKTsKCiAgICAgICAgICAgIHBhdGhMZW5ndGggPSBwYXRoLmdldFRvdGFsTGVuZ3RoKCk7CgogICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcGF0aCBsZW5ndGhzIGNoYW5nZWQgc2lnbmlmaWNhbnRseS4KICAgICAgICAgICAgaWYgKHBhdGhMZW5ndGggLSBvcmlnaW5hbFBhdGhMZW5ndGggPiBwYXRoTGVuZ3RoVG9sZXJhbmNlKSB7CgogICAgICAgICAgICAgICAgLy8gUmV2ZXJ0IHZlcnRpY2VzIHRvIHRoZSBvcmlnaW5hbCBhcnJheS4gVGhlIHBhdGggbGVuZ3RoIGhhcyBjaGFuZ2VkIHRvbyBtdWNoCiAgICAgICAgICAgICAgICAvLyBzbyB0aGF0IHRoZSBpbmRleCB3YXMgbm90IGZvdW5kIHlldC4KICAgICAgICAgICAgICAgIHZlcnRpY2VzID0gb3JpZ2luYWxWZXJ0aWNlcy5zbGljZSgpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMubW9kZWwuc2V0KCd2ZXJ0aWNlcycsIHZlcnRpY2VzKTsKCiAgICAgICAgLy8gSW4gbWFuaGF0dGFuIHJvdXRpbmcsIGlmIHRoZXJlIGFyZSBubyB2ZXJ0aWNlcywgdGhlIHBhdGggbGVuZ3RoIGNoYW5nZXMgc2lnbmlmaWNhbnRseQogICAgICAgIC8vIHdpdGggdGhlIGZpcnN0IHZlcnRleCBhZGRlZC4gU2hhbGwgd2UgY2hlY2sgdmVydGljZXMubGVuZ3RoID09PSAwPyBhdCBiZWdpbm5pbmcgb2YgYWRkVmVydGV4KCkKICAgICAgICAvLyBpbiBvcmRlciB0byBhdm9pZCB0aGUgdGVtcG9yYXJ5IHBhdGggY29uc3RydWN0aW9uIGFuZCBvdGhlciBvcGVyYXRpb25zPwogICAgICAgIHJldHVybiBNYXRoLm1heChpZHgsIDApOwogICAgfSwKCiAgICAvLyBTZW5kIGEgdG9rZW4gKGFuIFNWRyBlbGVtZW50LCB1c3VhbGx5IGEgY2lyY2xlKSBhbG9uZyB0aGUgY29ubmVjdGlvbiBwYXRoLgogICAgLy8gRXhhbXBsZTogYHBhcGVyLmZpbmRWaWV3QnlNb2RlbChsaW5rKS5zZW5kVG9rZW4oVignY2lyY2xlJywgeyByOiA3LCBmaWxsOiAnZ3JlZW4nIH0pLm5vZGUpYAogICAgLy8gYGR1cmF0aW9uYCBpcyBvcHRpb25hbCBhbmQgaXMgYSB0aW1lIGluIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSB0b2tlbiB0cmF2ZWxzIGZyb20gdGhlIHNvdXJjZSB0byB0aGUgdGFyZ2V0IG9mIHRoZSBsaW5rLiBEZWZhdWx0IGlzIGAxMDAwYC4KICAgIC8vIGBjYWxsYmFja2AgaXMgb3B0aW9uYWwgYW5kIGlzIGEgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIG9uY2UgdGhlIHRva2VuIHJlYWNoZXMgdGhlIHRhcmdldC4KICAgIHNlbmRUb2tlbjogZnVuY3Rpb24odG9rZW4sIGR1cmF0aW9uLCBjYWxsYmFjaykgewoKCWR1cmF0aW9uID0gZHVyYXRpb24gfHwgMTAwMDsKCglWKHRoaXMucGFwZXIudmlld3BvcnQpLmFwcGVuZCh0b2tlbik7CglWKHRva2VuKS5hbmltYXRlQWxvbmdQYXRoKHsgZHVyOiBkdXJhdGlvbiArICdtcycsIHJlcGVhdENvdW50OiAxIH0sIHRoaXMuX1YuY29ubmVjdGlvbi5ub2RlKTsKCV8uZGVsYXkoZnVuY3Rpb24oKSB7IFYodG9rZW4pLnJlbW92ZSgpOyBjYWxsYmFjayAmJiBjYWxsYmFjaygpOyB9LCBkdXJhdGlvbik7CiAgICB9LAoKICAgIGZpbmRSb3V0ZTogZnVuY3Rpb24ob2xkVmVydGljZXMpIHsKCiAgICAgICAgdmFyIHJvdXRlciA9IHRoaXMubW9kZWwuZ2V0KCdyb3V0ZXInKTsKCiAgICAgICAgaWYgKCFyb3V0ZXIpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLm1vZGVsLmdldCgnbWFuaGF0dGFuJykpIHsKICAgICAgICAgICAgICAgIC8vIGJhY2t3YXJkcyBjb21wYWJpbGl0eQogICAgICAgICAgICAgICAgcm91dGVyID0geyBuYW1lOiAnb3J0aG9nb25hbCcgfTsKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gb2xkVmVydGljZXM7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBmbiA9IGpvaW50LnJvdXRlcnNbcm91dGVyLm5hbWVdOwoKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihmbikpIHsKCiAgICAgICAgICAgIHRocm93ICd1bmtub3duIHJvdXRlcjogJyArIHJvdXRlci5uYW1lOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1ZlcnRpY2VzID0gZm4uY2FsbCh0aGlzLCBvbGRWZXJ0aWNlcyB8fCBbXSwgcm91dGVyLmFyZ3MgfHwge30sIHRoaXMpOwoKICAgICAgICByZXR1cm4gbmV3VmVydGljZXM7CiAgICB9LAoKICAgIC8vIFJldHVybiB0aGUgYGRgIGF0dHJpYnV0ZSB2YWx1ZSBvZiB0aGUgYDxwYXRoPmAgZWxlbWVudCByZXByZXNlbnRpbmcgdGhlIGxpbmsKICAgIC8vIGJldHdlZW4gYHNvdXJjZWAgYW5kIGB0YXJnZXRgLgogICAgZ2V0UGF0aERhdGE6IGZ1bmN0aW9uKHZlcnRpY2VzKSB7CgogICAgICAgIHZhciBjb25uZWN0b3IgPSB0aGlzLm1vZGVsLmdldCgnY29ubmVjdG9yJyk7CgogICAgICAgIGlmICghY29ubmVjdG9yKSB7CgogICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGFiaWxpdHkKICAgICAgICAgICAgY29ubmVjdG9yID0gdGhpcy5tb2RlbC5nZXQoJ3Ntb290aCcpID8geyBuYW1lOiAnc21vb3RoJyB9IDogeyBuYW1lOiAnbm9ybWFsJyB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24oam9pbnQuY29ubmVjdG9yc1tjb25uZWN0b3IubmFtZV0pKSB7CgogICAgICAgICAgICB0aHJvdyAndW5rbm93biBjb25uZWN0b3I6ICcgKyBjb25uZWN0b3IubmFtZTsKICAgICAgICB9CgogICAgICAgIHZhciBwYXRoRGF0YSA9IGpvaW50LmNvbm5lY3RvcnNbY29ubmVjdG9yLm5hbWVdLmNhbGwoCiAgICAgICAgICAgIHRoaXMsCiAgICAgICAgICAgIHRoaXMuX21hcmtlckNhY2hlLnNvdXJjZVBvaW50LCAvLyBOb3RlIHRoYXQgdGhlIHZhbHVlIGlzIHRyYW5zbGF0ZWQgYnkgdGhlIHNpemUKICAgICAgICAgICAgdGhpcy5fbWFya2VyQ2FjaGUudGFyZ2V0UG9pbnQsIC8vIG9mIHRoZSBtYXJrZXIuIChXZSdyIG5vdCB1c2luZyB0aGlzLnNvdXJjZVBvaW50KQogICAgICAgICAgICB2ZXJ0aWNlcyB8fCAodGhpcy5tb2RlbC5nZXQoJ3ZlcnRpY2VzJykgfHwge30pLAogICAgICAgICAgICBjb25uZWN0b3IuYXJncyB8fCB7fSwgLy8gb3B0aW9ucwogICAgICAgICAgICB0aGlzCiAgICAgICAgKTsKCiAgICAgICAgcmV0dXJuIHBhdGhEYXRhOwogICAgfSwKCiAgICAvLyBGaW5kIGEgcG9pbnQgdGhhdCBpcyB0aGUgc3RhcnQgb2YgdGhlIGNvbm5lY3Rpb24uCiAgICAvLyBJZiBgc2VsZWN0b3JPclBvaW50YCBpcyBhIHBvaW50LCB0aGVuIHdlJ3JlIGRvbmUgYW5kIHRoYXQgcG9pbnQgaXMgdGhlIHN0YXJ0IG9mIHRoZSBjb25uZWN0aW9uLgogICAgLy8gSWYgdGhlIGBzZWxlY3Rvck9yUG9pbnRgIGlzIGFuIGVsZW1lbnQgaG93ZXZlciwgd2UgbmVlZCB0byBrbm93IGEgcmVmZXJlbmNlIHBvaW50IChvciBlbGVtZW50KQogICAgLy8gdGhhdCB0aGUgbGluayBsZWFkcyB0byBpbiBvcmRlciB0byBkZXRlcm1pbmUgdGhlIHN0YXJ0IG9mIHRoZSBjb25uZWN0aW9uIG9uIHRoZSBvcmlnaW5hbCBlbGVtZW50LgogICAgZ2V0Q29ubmVjdGlvblBvaW50OiBmdW5jdGlvbihlbmQsIHNlbGVjdG9yT3JQb2ludCwgcmVmZXJlbmNlU2VsZWN0b3JPclBvaW50KSB7CgogICAgICAgIHZhciBzcG90OwoKICAgICAgICAvLyBJZiB0aGUgYHNlbGVjdG9yT3JQb2ludGAgKG9yIGByZWZlcmVuY2VTZWxlY3Rvck9yUG9pbnRgKSBpcyBgdW5kZWZpbmVkYCwgdGhlIGBzb3VyY2VgL2B0YXJnZXRgIG9mIHRoZSBsaW5rIG1vZGVsIGlzIGB1bmRlZmluZWRgLgogICAgICAgIC8vIFdlIHdhbnQgdG8gYWxsb3cgdGhpcyBob3dldmVyIHNvIHRoYXQgb25lIGNhbiBjcmVhdGUgbGlua3Mgc3VjaCBhcyBgdmFyIGxpbmsgPSBuZXcgam9pbnQuZGlhLkxpbmtgIGFuZAogICAgICAgIC8vIHNldCB0aGUgYHNvdXJjZWAvYHRhcmdldGAgbGF0ZXIuCiAgICAgICAgc2VsZWN0b3JPclBvaW50ID0gc2VsZWN0b3JPclBvaW50IHx8IHsgeDogMCwgeTogMCB9OwogICAgICAgIHJlZmVyZW5jZVNlbGVjdG9yT3JQb2ludCA9IHJlZmVyZW5jZVNlbGVjdG9yT3JQb2ludCB8fCB7IHg6IDAsIHk6IDAgfTsKCiAgICAgICAgaWYgKHRoaXMuX2lzUG9pbnQoc2VsZWN0b3JPclBvaW50KSkgewoKICAgICAgICAgICAgLy8gSWYgdGhlIHNvdXJjZSBpcyBhIHBvaW50LCB3ZSBkb24ndCBuZWVkIGEgcmVmZXJlbmNlIHBvaW50IHRvIGZpbmQgdGhlIHN0aWNreSBwb2ludCBvZiBjb25uZWN0aW9uLgogICAgICAgICAgICBzcG90ID0gZy5wb2ludChzZWxlY3Rvck9yUG9pbnQpOwoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgLy8gSWYgdGhlIHNvdXJjZSBpcyBhbiBlbGVtZW50LCB3ZSBuZWVkIHRvIGZpbmQgYSBwb2ludCBvbiB0aGUgZWxlbWVudCBib3VuZGFyeSB0aGF0IGlzIGNsb3Nlc3QKICAgICAgICAgICAgLy8gdG8gdGhlIHJlZmVyZW5jZSBwb2ludCAob3IgcmVmZXJlbmNlIGVsZW1lbnQpLgogICAgICAgICAgICAvLyBHZXQgdGhlIGJvdW5kaW5nIGJveCBvZiB0aGUgc3BvdCByZWxhdGl2ZSB0byB0aGUgcGFwZXIgdmlld3BvcnQuIFRoaXMgaXMgbmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGZvbGxvdyBwYXBlciB2aWV3cG9ydCB0cmFuc2Zvcm1hdGlvbnMgKHNjYWxlL3JvdGF0ZSkuCiAgICAgICAgICAgIC8vIGBfc291cmNlQmJveGAgKGBfdGFyZ2V0QmJveGApIGNvbWVzIGZyb20gYF9zb3VyY2VCYm94VXBkYXRlYCAoYF9zb3VyY2VCYm94VXBkYXRlYCkKICAgICAgICAgICAgLy8gbWV0aG9kLCBpdCBleGlzdHMgc2luY2UgZmlyc3QgcmVuZGVyIGFuZCBhcmUgYXV0b21hdGljYWxseSB1cGRhdGVkCiAgICAgICAgICAgIHZhciBzcG90QmJveCA9IGVuZCA9PT0gJ3NvdXJjZScgPyB0aGlzLnNvdXJjZUJCb3ggOiB0aGlzLnRhcmdldEJCb3g7CiAgICAgICAgICAgIAogICAgICAgICAgICB2YXIgcmVmZXJlbmNlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuX2lzUG9pbnQocmVmZXJlbmNlU2VsZWN0b3JPclBvaW50KSkgewoKICAgICAgICAgICAgICAgIC8vIFJlZmVyZW5jZSB3YXMgcGFzc2VkIGFzIGEgcG9pbnQsIHRoZXJlZm9yZSwgd2UncmUgcmVhZHkgdG8gZmluZCB0aGUgc3RpY2t5IHBvaW50IG9mIGNvbm5lY3Rpb24gb24gdGhlIHNvdXJjZSBlbGVtZW50LgogICAgICAgICAgICAgICAgcmVmZXJlbmNlID0gZy5wb2ludChyZWZlcmVuY2VTZWxlY3Rvck9yUG9pbnQpOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBSZWZlcmVuY2Ugd2FzIHBhc3NlZCBhcyBhbiBlbGVtZW50LCB0aGVyZWZvcmUgd2UgbmVlZCB0byBmaW5kIGEgcG9pbnQgb24gdGhlIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgLy8gZWxlbWVudCBib3VuZGFyeSBjbG9zZXN0IHRvIHRoZSBzb3VyY2UgZWxlbWVudC4KICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgYm91bmRpbmcgYm94IG9mIHRoZSBzcG90IHJlbGF0aXZlIHRvIHRoZSBwYXBlciB2aWV3cG9ydC4gVGhpcyBpcyBuZWNlc3NhcnkKICAgICAgICAgICAgICAgIC8vIGluIG9yZGVyIHRvIGZvbGxvdyBwYXBlciB2aWV3cG9ydCB0cmFuc2Zvcm1hdGlvbnMgKHNjYWxlL3JvdGF0ZSkuCiAgICAgICAgICAgICAgICB2YXIgcmVmZXJlbmNlQmJveCA9IGVuZCA9PT0gJ3NvdXJjZScgPyB0aGlzLnRhcmdldEJCb3ggOiB0aGlzLnNvdXJjZUJCb3g7CgogICAgICAgICAgICAgICAgcmVmZXJlbmNlID0gZy5yZWN0KHJlZmVyZW5jZUJib3gpLmludGVyc2VjdGlvbldpdGhMaW5lRnJvbUNlbnRlclRvUG9pbnQoZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKSk7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UgPSByZWZlcmVuY2UgfHwgZy5yZWN0KHJlZmVyZW5jZUJib3gpLmNlbnRlcigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiBgcGVycGVuZGljdWxhckxpbmtzYCBmbGFnIGlzIHNldCBvbiB0aGUgcGFwZXIgYW5kIHRoZXJlIGFyZSB2ZXJ0aWNlcwogICAgICAgICAgICAvLyBvbiB0aGUgbGluaywgdGhlbiB0cnkgdG8gZmluZCBhIGNvbm5lY3Rpb24gcG9pbnQgdGhhdCBtYWtlcyB0aGUgbGluayBwZXJwZW5kaWN1bGFyCiAgICAgICAgICAgIC8vIGV2ZW4gdGhvdWdoIHRoZSBsaW5rIHdvbid0IHBvaW50IHRvIHRoZSBjZW50ZXIgb2YgdGhlIHRhcmdldGVkIG9iamVjdC4KICAgICAgICAgICAgaWYgKHRoaXMucGFwZXIub3B0aW9ucy5wZXJwZW5kaWN1bGFyTGlua3MgfHwgdGhpcy5vcHRpb25zLnBlcnBlbmRpY3VsYXIpIHsKCiAgICAgICAgICAgICAgICB2YXIgaG9yaXpvbnRhbExpbmVSZWN0ID0gZy5yZWN0KDAsIHJlZmVyZW5jZS55LCB0aGlzLnBhcGVyLm9wdGlvbnMud2lkdGgsIDEpOwogICAgICAgICAgICAgICAgdmFyIHZlcnRpY2FsTGluZVJlY3QgPSBnLnJlY3QocmVmZXJlbmNlLngsIDAsIDEsIHRoaXMucGFwZXIub3B0aW9ucy5oZWlnaHQpOwogICAgICAgICAgICAgICAgdmFyIG5lYXJlc3RTaWRlOwoKICAgICAgICAgICAgICAgIGlmIChob3Jpem9udGFsTGluZVJlY3QuaW50ZXJzZWN0KGcucmVjdChzcG90QmJveCkpKSB7CgogICAgICAgICAgICAgICAgICAgIG5lYXJlc3RTaWRlID0gZy5yZWN0KHNwb3RCYm94KS5zaWRlTmVhcmVzdFRvUG9pbnQocmVmZXJlbmNlKTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG5lYXJlc3RTaWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICdsZWZ0JzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQoc3BvdEJib3gueCwgcmVmZXJlbmNlLnkpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JpZ2h0JzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQoc3BvdEJib3gueCArIHNwb3RCYm94LndpZHRoLCByZWZlcmVuY2UueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNwb3QgPSBnLnJlY3Qoc3BvdEJib3gpLmNlbnRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZlcnRpY2FsTGluZVJlY3QuaW50ZXJzZWN0KGcucmVjdChzcG90QmJveCkpKSB7CgogICAgICAgICAgICAgICAgICAgIG5lYXJlc3RTaWRlID0gZy5yZWN0KHNwb3RCYm94KS5zaWRlTmVhcmVzdFRvUG9pbnQocmVmZXJlbmNlKTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG5lYXJlc3RTaWRlKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlICd0b3AnOgogICAgICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5wb2ludChyZWZlcmVuY2UueCwgc3BvdEJib3gueSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tJzoKICAgICAgICAgICAgICAgICAgICAgICAgc3BvdCA9IGcucG9pbnQocmVmZXJlbmNlLngsIHNwb3RCYm94LnkgKyBzcG90QmJveC5oZWlnaHQpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gaW50ZXJzZWN0aW9uIGhvcml6b250YWxseSBvciB2ZXJ0aWNhbGx5IHdpdGggdGhlIG9iamVjdCBib3VuZGluZyBib3gsCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlbiB3ZSBmYWxsIGJhY2sgdG8gdGhlIHJlZ3VsYXIgc2l0dWF0aW9uIGZpbmRpbmcgc3RyYWlnaHQgbGluZSAobm90IHBlcnBlbmRpY3VsYXIpCiAgICAgICAgICAgICAgICAgICAgLy8gYmV0d2VlbiB0aGUgb2JqZWN0IGFuZCB0aGUgcmVmZXJlbmNlIHBvaW50LgoKICAgICAgICAgICAgICAgICAgICBzcG90ID0gZy5yZWN0KHNwb3RCYm94KS5pbnRlcnNlY3Rpb25XaXRoTGluZUZyb21DZW50ZXJUb1BvaW50KHJlZmVyZW5jZSk7CiAgICAgICAgICAgICAgICAgICAgc3BvdCA9IHNwb3QgfHwgZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMucGFwZXIub3B0aW9ucy5saW5rQ29ubmVjdGlvblBvaW50KSB7CgoJCXZhciB2aWV3ID0gZW5kID09PSAndGFyZ2V0JyA/IHRoaXMudGFyZ2V0VmlldyA6IHRoaXMuc291cmNlVmlldzsKCQl2YXIgbWFnbmV0ID0gZW5kID09PSAndGFyZ2V0JyA/IHRoaXMudGFyZ2V0TWFnbmV0IDogdGhpcy5zb3VyY2VNYWduZXQ7CgoJCXNwb3QgPSB0aGlzLnBhcGVyLm9wdGlvbnMubGlua0Nvbm5lY3Rpb25Qb2ludCh0aGlzLCB2aWV3LCBtYWduZXQsIHJlZmVyZW5jZSk7CgoJICAgIH0gZWxzZSB7CgogICAgICAgICAgICAJc3BvdCA9IGcucmVjdChzcG90QmJveCkuaW50ZXJzZWN0aW9uV2l0aExpbmVGcm9tQ2VudGVyVG9Qb2ludChyZWZlcmVuY2UpOwogICAgICAgICAgICAgICAgc3BvdCA9IHNwb3QgfHwgZy5yZWN0KHNwb3RCYm94KS5jZW50ZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNwb3Q7CiAgICB9LAoKICAgIF9pc01vZGVsOiBmdW5jdGlvbihlbmQpIHsKCiAgICAgICAgcmV0dXJuIGVuZCAmJiBlbmQuaWQ7CiAgICB9LAoKICAgIF9pc1BvaW50OiBmdW5jdGlvbihlbmQpIHsKCiAgICAgICAgcmV0dXJuICF0aGlzLl9pc01vZGVsKGVuZCk7CiAgICB9LAoKICAgIF9tYWtlU2VsZWN0b3I6IGZ1bmN0aW9uKGVuZCkgewoKICAgICAgICB2YXIgc2VsZWN0b3IgPSAnW21vZGVsLWlkPSInICsgZW5kLmlkICsgJyJdJzsKICAgICAgICAvLyBgcG9ydGAgaGFzIGEgaGlnaGVyIHByZWNlbmRlbmNlIG92ZXIgYHNlbGVjdG9yYC4gVGhpcyBpcyBiZWNhdXNlIHRoZSBzZWxlY3RvciB0byB0aGUgbWFnbmV0CiAgICAgICAgLy8gbWlnaHQgY2hhbmdlIHdoaWxlIHRoZSBuYW1lIG9mIHRoZSBwb3J0IGNhbiBzdGF5IHRoZSBzYW1lLgogICAgICAgIGlmIChlbmQucG9ydCkgewogICAgICAgICAgICBzZWxlY3RvciArPSAnIFtwb3J0PSInICsgZW5kLnBvcnQgKyAnIl0nOwogICAgICAgIH0gZWxzZSBpZiAoZW5kLnNlbGVjdG9yKSB7CiAgICAgICAgICAgIHNlbGVjdG9yICs9ICcgJyArIGVuZC5zZWxlY3RvcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZWxlY3RvcjsKICAgIH0sCgogICAgLy8gUHVibGljIEFQSQogICAgLy8gLS0tLS0tLS0tLQoKICAgIGdldENvbm5lY3Rpb25MZW5ndGg6IGZ1bmN0aW9uKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5fVi5jb25uZWN0aW9uLm5vZGUuZ2V0VG90YWxMZW5ndGgoKTsKICAgIH0sCgogICAgZ2V0UG9pbnRBdExlbmd0aDogZnVuY3Rpb24obGVuZ3RoKSB7CgogICAgICAgIHJldHVybiB0aGlzLl9WLmNvbm5lY3Rpb24ubm9kZS5nZXRQb2ludEF0TGVuZ3RoKGxlbmd0aCk7CiAgICB9LAoKICAgIC8vIEludGVyYWN0aW9uLiBUaGUgY29udHJvbGxlciBwYXJ0LgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgogICAgX2JlZm9yZUFycm93aGVhZE1vdmU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLm1vZGVsLnRyaWdnZXIoJ2JhdGNoOnN0YXJ0Jyk7CgogICAgICAgIHRoaXMuX3ogPSB0aGlzLm1vZGVsLmdldCgneicpOwogICAgICAgIHRoaXMubW9kZWwuc2V0KCd6JywgTnVtYmVyLk1BWF9WQUxVRSk7CgogICAgICAgIC8vIExldCB0aGUgcG9pbnRlciBwcm9wYWdhdGUgdGhyb3VnaHQgdGhlIGxpbmsgdmlldyBlbGVtZW50cyBzbyB0aGF0CiAgICAgICAgLy8gdGhlIGBldnQudGFyZ2V0YCBpcyBhbm90aGVyIGVsZW1lbnQgdW5kZXIgdGhlIHBvaW50ZXIsIG5vdCB0aGUgbGluayBpdHNlbGYuCiAgICAgICAgdGhpcy5lbC5zdHlsZS5wb2ludGVyRXZlbnRzID0gJ25vbmUnOwoKICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLm1hcmtBdmFpbGFibGUpIHsKICAgICAgICAgICAgdGhpcy5fbWFya0F2YWlsYWJsZU1hZ25ldHMoKTsKICAgICAgICB9CiAgICB9LAoKICAgIF9hZnRlckFycm93aGVhZE1vdmU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAodGhpcy5feikgewogICAgICAgICAgICB0aGlzLm1vZGVsLnNldCgneicsIHRoaXMuX3opOwogICAgICAgICAgICBkZWxldGUgdGhpcy5fejsKICAgICAgICB9CgogICAgICAgIC8vIFB1dCBgcG9pbnRlci1ldmVudHNgIGJhY2sgdG8gaXRzIG9yaWdpbmFsIHZhbHVlLiBTZWUgYHN0YXJ0QXJyb3doZWFkTW92ZSgpYCBmb3IgZXhwbGFuYXRpb24uCgkvLyBWYWx1ZSBgYXV0b2AgZG9lc24ndCB3b3JrIGluIElFOS4gV2UgZm9yY2UgdG8gdXNlIGB2aXNpYmxlUGFpbnRlZGAgaW5zdGVhZC4KCS8vIFNlZSBgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL3BvaW50ZXItZXZlbnRzYC4KICAgICAgICB0aGlzLmVsLnN0eWxlLnBvaW50ZXJFdmVudHMgPSAndmlzaWJsZVBhaW50ZWQnOwoKICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLm1hcmtBdmFpbGFibGUpIHsKICAgICAgICAgICAgdGhpcy5fdW5tYXJrQXZhaWxhYmxlTWFnbmV0cygpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5tb2RlbC50cmlnZ2VyKCdiYXRjaDpzdG9wJyk7CiAgICB9LAoKICAgIF9jcmVhdGVWYWxpZGF0ZUNvbm5lY3Rpb25BcmdzOiBmdW5jdGlvbihhcnJvd2hlYWQpIHsKICAgICAgICAvLyBJdCBtYWtlcyBzdXJlIHRoZSBhcmd1bWVudHMgZm9yIHZhbGlkYXRlQ29ubmVjdGlvbiBoYXZlIHRoZSBmb2xsb3dpbmcgZm9ybToKICAgICAgICAvLyAoc291cmNlIHZpZXcsIHNvdXJjZSBtYWduZXQsIHRhcmdldCB2aWV3LCB0YXJnZXQgbWFnbmV0IGFuZCBsaW5rIHZpZXcpCiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKCiAgICAgICAgYXJnc1s0XSA9IGFycm93aGVhZDsKICAgICAgICBhcmdzWzVdID0gdGhpczsKCiAgICAgICAgdmFyIG9wcG9zaXRlQXJyb3doZWFkLCBpID0gMCwgaiA9IDA7CgogICAgICAgIGlmIChhcnJvd2hlYWQgPT09ICdzb3VyY2UnKSB7CiAgICAgICAgICAgIGkgPSAyOwogICAgICAgICAgICBvcHBvc2l0ZUFycm93aGVhZCA9ICd0YXJnZXQnOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGogPSAyOwogICAgICAgICAgICBvcHBvc2l0ZUFycm93aGVhZCA9ICdzb3VyY2UnOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVuZCA9IHRoaXMubW9kZWwuZ2V0KG9wcG9zaXRlQXJyb3doZWFkKTsKCiAgICAgICAgaWYgKGVuZC5pZCkgewogICAgICAgICAgICBhcmdzW2ldID0gdGhpcy5wYXBlci5maW5kVmlld0J5TW9kZWwoZW5kLmlkKTsKICAgICAgICAgICAgYXJnc1tpKzFdID0gZW5kLnNlbGVjdG9yICYmIGFyZ3NbaV0uZWwucXVlcnlTZWxlY3RvcihlbmQuc2VsZWN0b3IpOwogICAgICAgIH0KCiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDb25uZWN0aW9uQXJncyhjZWxsVmlldywgbWFnbmV0KSB7CiAgICAgICAgICAgIGFyZ3Nbal0gPSBjZWxsVmlldzsKICAgICAgICAgICAgYXJnc1tqKzFdID0gY2VsbFZpZXcuZWwgPT09IG1hZ25ldCA/IHVuZGVmaW5lZCA6IG1hZ25ldDsKICAgICAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsaWRhdGVDb25uZWN0aW9uQXJnczsKICAgIH0sCgogICAgX21hcmtBdmFpbGFibGVNYWduZXRzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGVsZW1lbnRzID0gdGhpcy5wYXBlci5tb2RlbC5nZXRFbGVtZW50cygpOwogICAgICAgIHZhciB2YWxpZGF0ZSA9IHRoaXMucGFwZXIub3B0aW9ucy52YWxpZGF0ZUNvbm5lY3Rpb247CgogICAgICAgIF8uY2hhaW4oZWxlbWVudHMpLm1hcCh0aGlzLnBhcGVyLmZpbmRWaWV3QnlNb2RlbCwgdGhpcy5wYXBlcikuZWFjaChmdW5jdGlvbih2aWV3KSB7CgogICAgICAgICAgICB2YXIgaXNFbGVtZW50QXZhaWxhYmxlID0gdmlldy5lbC5nZXRBdHRyaWJ1dGUoJ21hZ25ldCcpICE9PSAnZmFsc2UnICYmCiAgICAgICAgICAgICAgICB2YWxpZGF0ZS5hcHBseSh0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG51bGwpKTsKCiAgICAgICAgICAgIHZhciBhdmFpbGFibGVNYWduZXRzID0gXy5maWx0ZXIodmlldy5lbC5xdWVyeVNlbGVjdG9yQWxsKCdbbWFnbmV0XScpLCBmdW5jdGlvbihtYWduZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWxpZGF0ZS5hcHBseSh0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG1hZ25ldCkpOwogICAgICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgICAgIGlmIChpc0VsZW1lbnRBdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgIFYodmlldy5lbCkuYWRkQ2xhc3MoJ2F2YWlsYWJsZS1tYWduZXQnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgXy5lYWNoKGF2YWlsYWJsZU1hZ25ldHMsIGZ1bmN0aW9uKG1hZ25ldCkgewogICAgICAgICAgICAgICAgVihtYWduZXQpLmFkZENsYXNzKCdhdmFpbGFibGUtbWFnbmV0Jyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGlzRWxlbWVudEF2YWlsYWJsZSB8fCBhdmFpbGFibGVNYWduZXRzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgVih2aWV3LmVsKS5hZGRDbGFzcygnYXZhaWxhYmxlLWNlbGwnKTsKICAgICAgICAgICAgfQoKICAgICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgX3VubWFya0F2YWlsYWJsZU1hZ25ldHM6IGZ1bmN0aW9uKCkgewoKICAgICAgICBfLmVhY2godGhpcy5wYXBlci5lbC5xdWVyeVNlbGVjdG9yQWxsKCcuYXZhaWxhYmxlLWNlbGwsIC5hdmFpbGFibGUtbWFnbmV0JyksIGZ1bmN0aW9uKG1hZ25ldCkgewogICAgICAgICAgICBWKG1hZ25ldCkucmVtb3ZlQ2xhc3MoJ2F2YWlsYWJsZS1tYWduZXQnKS5yZW1vdmVDbGFzcygnYXZhaWxhYmxlLWNlbGwnKTsKICAgICAgICB9KTsKICAgIH0sCgogICAgc3RhcnRBcnJvd2hlYWRNb3ZlOiBmdW5jdGlvbihlbmQpIHsKICAgICAgICAvLyBBbGxvdyB0byBkZWxlZ2F0ZSBldmVudHMgZnJvbSBhbiBhbm90aGVyIHZpZXcgdG8gdGhpcyBsaW5rVmlldyBpbiBvcmRlciB0byB0cmlnZ2VyIGFycm93aGVhZAogICAgICAgIC8vIG1vdmUgd2l0aG91dCBuZWVkIHRvIGNsaWNrIG9uIHRoZSBhY3R1YWwgYXJyb3doZWFkIGRvbSBlbGVtZW50LgogICAgICAgIHRoaXMuX2FjdGlvbiA9ICdhcnJvd2hlYWQtbW92ZSc7CiAgICAgICAgdGhpcy5fYXJyb3doZWFkID0gZW5kOwogICAgICAgIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3MgPSB0aGlzLl9jcmVhdGVWYWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHRoaXMuX2Fycm93aGVhZCk7CiAgICAgICAgdGhpcy5fYmVmb3JlQXJyb3doZWFkTW92ZSgpOwogICAgfSwKCiAgICBwb2ludGVyZG93bjogZnVuY3Rpb24oZXZ0LCB4LCB5KSB7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUucG9pbnRlcmRvd24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCgl0aGlzLl9keCA9IHg7CiAgICAgICAgdGhpcy5fZHkgPSB5OwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLmludGVyYWN0aXZlID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICB2YXIgY2xhc3NOYW1lID0gZXZ0LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJyk7CgogICAgICAgIHN3aXRjaCAoY2xhc3NOYW1lKSB7CgogICAgICAgIGNhc2UgJ21hcmtlci12ZXJ0ZXgnOgogICAgICAgICAgICB0aGlzLl9hY3Rpb24gPSAndmVydGV4LW1vdmUnOwogICAgICAgICAgICB0aGlzLl92ZXJ0ZXhJZHggPSBldnQudGFyZ2V0LmdldEF0dHJpYnV0ZSgnaWR4Jyk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdtYXJrZXItdmVydGV4LXJlbW92ZSc6CiAgICAgICAgY2FzZSAnbWFya2VyLXZlcnRleC1yZW1vdmUtYXJlYSc6CiAgICAgICAgICAgIHRoaXMucmVtb3ZlVmVydGV4KGV2dC50YXJnZXQuZ2V0QXR0cmlidXRlKCdpZHgnKSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdtYXJrZXItYXJyb3doZWFkJzoKICAgICAgICAgICAgdGhpcy5zdGFydEFycm93aGVhZE1vdmUoZXZ0LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ2VuZCcpKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CgogICAgICAgICAgICB2YXIgdGFyZ2V0UGFyZW50RXZlbnQgPSBldnQudGFyZ2V0LnBhcmVudE5vZGUuZ2V0QXR0cmlidXRlKCdldmVudCcpOwoKICAgICAgICAgICAgaWYgKHRhcmdldFBhcmVudEV2ZW50KSB7CgogICAgICAgICAgICAgICAgLy8gYHJlbW92ZWAgZXZlbnQgaXMgYnVpbHQtaW4uIE90aGVyIGN1c3RvbSBldmVudHMgYXJlIHRyaWdnZXJlZCBvbiB0aGUgcGFwZXIuCiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0UGFyZW50RXZlbnQgPT09ICdyZW1vdmUnKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb2RlbC5yZW1vdmUoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXBlci50cmlnZ2VyKHRhcmdldFBhcmVudEV2ZW50LCBldnQsIHRoaXMsIHgsIHkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBTdG9yZSB0aGUgaW5kZXggYXQgd2hpY2ggdGhlIG5ldyB2ZXJ0ZXggaGFzIGp1c3QgYmVlbiBwbGFjZWQuCiAgICAgICAgICAgICAgICAvLyBXZSdsbCBiZSB1cGRhdGUgdGhlIHZlcnkgc2FtZSB2ZXJ0ZXggcG9zaXRpb24gaW4gYHBvaW50ZXJtb3ZlKClgLgogICAgICAgICAgICAgICAgdGhpcy5fdmVydGV4SWR4ID0gdGhpcy5hZGRWZXJ0ZXgoeyB4OiB4LCB5OiB5IH0pOwogICAgICAgICAgICAgICAgdGhpcy5fYWN0aW9uID0gJ3ZlcnRleC1tb3ZlJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcm1vdmU6IGZ1bmN0aW9uKGV2dCwgeCwgeSkgewoKICAgICAgICBqb2ludC5kaWEuQ2VsbFZpZXcucHJvdG90eXBlLnBvaW50ZXJtb3ZlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIHN3aXRjaCAodGhpcy5fYWN0aW9uKSB7CgogICAgICAgICAgY2FzZSAndmVydGV4LW1vdmUnOgoKICAgICAgICAgICAgdmFyIHZlcnRpY2VzID0gXy5jbG9uZSh0aGlzLm1vZGVsLmdldCgndmVydGljZXMnKSk7CiAgICAgICAgICAgIHZlcnRpY2VzW3RoaXMuX3ZlcnRleElkeF0gPSB7IHg6IHgsIHk6IHkgfTsKICAgICAgICAgICAgdGhpcy5tb2RlbC5zZXQoJ3ZlcnRpY2VzJywgdmVydGljZXMpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlICdhcnJvd2hlYWQtbW92ZSc6CgogICAgICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLnNuYXBMaW5rcykgewoKICAgICAgICAgICAgICAgIC8vIGNoZWNraW5nIHZpZXcgaW4gY2xvc2UgYXJlYSBvZiB0aGUgcG9pbnRlcgoKICAgICAgICAgICAgICAgIHZhciByID0gdGhpcy5wYXBlci5vcHRpb25zLnNuYXBMaW5rcy5yYWRpdXMgfHwgNTA7CiAgICAgICAgICAgICAgICB2YXIgdmlld3NJbkFyZWEgPSB0aGlzLnBhcGVyLmZpbmRWaWV3c0luQXJlYSh7IHg6IHggLSByLCB5OiB5IC0gciwgd2lkdGg6IDIgKiByLCBoZWlnaHQ6IDIgKiByIH0pOwoKICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ICYmIHRoaXMuX2Nsb3Nlc3RWaWV3LnVuaGlnaGxpZ2h0KHRoaXMuX2Nsb3Nlc3RFbmQuc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgPSB0aGlzLl9jbG9zZXN0RW5kID0gbnVsbDsKCiAgICAgICAgICAgICAgICB2YXIgcG9pbnRlciA9IGcucG9pbnQoeCx5KTsKICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZSwgbWluRGlzdGFuY2UgPSBOdW1iZXIuTUFYX1ZBTFVFOwoKICAgICAgICAgICAgICAgIF8uZWFjaCh2aWV3c0luQXJlYSwgZnVuY3Rpb24odmlldykgewoKICAgICAgICAgICAgICAgICAgICAvLyBza2lwIGNvbm5lY3RpbmcgdG8gdGhlIGVsZW1lbnQgaW4gY2FzZSAnLic6IHsgbWFnbmV0OiBmYWxzZSB9IGF0dHJpYnV0ZSBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuZWwuZ2V0QXR0cmlidXRlKCdtYWduZXQnKSAhPT0gJ2ZhbHNlJykgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmluZCBkaXN0YW5jZSBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIG1vZGVsIHRvIHBvaW50ZXIgY29vcmRpbmF0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgZGlzdGFuY2UgPSB2aWV3Lm1vZGVsLmdldEJCb3goKS5jZW50ZXIoKS5kaXN0YW5jZShwb2ludGVyKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjb25uZWN0aW9uIGlzIGxvb2tlZCB1cCBpbiBhIGNpcmNsZSBhcmVhIGJ5IGBkaXN0YW5jZSA8IHJgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IHIgJiYgZGlzdGFuY2UgPCBtaW5EaXN0YW5jZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcGVyLm9wdGlvbnMudmFsaWRhdGVDb25uZWN0aW9uLmFwcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFwZXIsIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3ModmlldywgbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ID0gdmlldzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0RW5kID0geyBpZDogdmlldy5tb2RlbC5pZCB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2aWV3LiQoJ1ttYWduZXRdJykuZWFjaChfLmJpbmQoZnVuY3Rpb24oaW5kZXgsIG1hZ25ldCkgewoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJib3ggPSBWKG1hZ25ldCkuYmJveChmYWxzZSwgdGhpcy5wYXBlci52aWV3cG9ydCk7CgogICAgICAgICAgICAgICAgICAgICAgICBkaXN0YW5jZSA9IHBvaW50ZXIuZGlzdGFuY2UoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeDogYmJveC54ICsgYmJveC53aWR0aCAvIDIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5OiBiYm94LnkgKyBiYm94LmhlaWdodCAvIDIKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPCByICYmIGRpc3RhbmNlIDwgbWluRGlzdGFuY2UpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXBlci5vcHRpb25zLnZhbGlkYXRlQ29ubmVjdGlvbi5hcHBseSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcGVyLCB0aGlzLl92YWxpZGF0ZUNvbm5lY3Rpb25BcmdzKHZpZXcsIG1hZ25ldCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2Nsb3Nlc3RWaWV3ID0gdmlldzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0RW5kID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogdmlldy5tb2RlbC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHZpZXcuZ2V0U2VsZWN0b3IobWFnbmV0KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogbWFnbmV0LmdldEF0dHJpYnV0ZSgncG9ydCcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB9LCB0aGlzKSk7CgogICAgICAgICAgICAgICAgfSwgdGhpcyk7CgogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgJiYgdGhpcy5fY2xvc2VzdFZpZXcuaGlnaGxpZ2h0KHRoaXMuX2Nsb3Nlc3RFbmQuc2VsZWN0b3IpOwoKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgdGhpcy5fY2xvc2VzdEVuZCB8fCB7IHg6IHgsIHk6IHkgfSk7CgogICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgIC8vIGNoZWNraW5nIHZpZXdzIHJpZ2h0IHVuZGVyIHRoZSBwb2ludGVyCgogICAgICAgICAgICAgICAgLy8gVG91Y2htb3ZlIGV2ZW50J3MgdGFyZ2V0IGlzIG5vdCByZWZsZWN0aW5nIHRoZSBlbGVtZW50IHVuZGVyIHRoZSBjb29yZGluYXRlcyBhcyBtb3VzZW1vdmUgZG9lcy4KICAgICAgICAgICAgICAgIC8vIEl0IGhvbGRzIHRoZSBlbGVtZW50IHdoZW4gYSB0b3VjaHN0YXJ0IHRyaWdnZXJlZC4KICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAoZXZ0LnR5cGUgPT09ICdtb3VzZW1vdmUnKQogICAgICAgICAgICAgICAgICAgID8gZXZ0LnRhcmdldAogICAgICAgICAgICAgICAgICAgIDogZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludChldnQuY2xpZW50WCwgZXZ0LmNsaWVudFkpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLl90YXJnZXRFdmVudCAhPT0gdGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVW5oaWdobGlnaHQgdGhlIHByZXZpb3VzIHZpZXcgdW5kZXIgcG9pbnRlciBpZiB0aGVyZSB3YXMgb25lLgogICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciAmJiB0aGlzLl92aWV3VW5kZXJQb2ludGVyLnVuaGlnaGxpZ2h0KHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld1VuZGVyUG9pbnRlciA9IHRoaXMucGFwZXIuZmluZFZpZXcodGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fdmlld1VuZGVyUG9pbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB3ZSBmb3VuZCBhIHZpZXcgdGhhdCBpcyB1bmRlciB0aGUgcG9pbnRlciwgd2UgbmVlZCB0byBmaW5kIHRoZSBjbG9zZXN0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG1hZ25ldCBiYXNlZCBvbiB0aGUgcmVhbCB0YXJnZXQgZWxlbWVudCBvZiB0aGUgZXZlbnQuCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciA9IHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuZmluZE1hZ25ldCh0YXJnZXQpOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciAmJiB0aGlzLnBhcGVyLm9wdGlvbnMudmFsaWRhdGVDb25uZWN0aW9uLmFwcGx5KAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXBlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3ZhbGlkYXRlQ29ubmVjdGlvbkFyZ3ModGhpcy5fdmlld1VuZGVyUG9pbnRlciwgdGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKQogICAgICAgICAgICAgICAgICAgICAgICApKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGVyZSB3YXMgbm8gbWFnbmV0IGZvdW5kLCBkbyBub3QgaGlnaGxpZ2h0IGFueXRoaW5nIGFuZCBhc3N1bWUgdGhlcmUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlzIG5vIHZpZXcgdW5kZXIgcG9pbnRlciB3ZSdyZSBpbnRlcmVzdGVkIGluIHJlY29ubmVjdGluZyB0by4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgY2FuIG9ubHkgaGFwcGVuIGlmIHRoZSBvdmVyYWxsIGVsZW1lbnQgaGFzIHRoZSBhdHRyaWJ1dGUgYCcuJzogeyBtYWduZXQ6IGZhbHNlIH1gLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyICYmIHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuaGlnaGxpZ2h0KHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHR5cGUgb2YgY29ubmVjdGlvbiBpcyBub3QgdmFsaWQuIERpc3JlZ2FyZCB0aGlzIG1hZ25ldC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlciA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UnbGwgZGVsZXRlIHByZXZpb3VzIG1hZ25ldAogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCgkgICAgICAgIHRoaXMuX3RhcmdldEV2ZW50ID0gdGFyZ2V0OwoKICAgICAgICAgICAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgeyB4OiB4LCB5OiB5IH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHRoaXMuX2R4ID0geDsKICAgICAgICB0aGlzLl9keSA9IHk7CiAgICB9LAoKICAgIHBvaW50ZXJ1cDogZnVuY3Rpb24oZXZ0KSB7CgogICAgICAgIGpvaW50LmRpYS5DZWxsVmlldy5wcm90b3R5cGUucG9pbnRlcnVwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh0aGlzLl9hY3Rpb24gPT09ICdhcnJvd2hlYWQtbW92ZScpIHsKCiAgICAgICAgICAgIGlmICh0aGlzLnBhcGVyLm9wdGlvbnMuc25hcExpbmtzKSB7CgogICAgICAgICAgICAgICAgdGhpcy5fY2xvc2VzdFZpZXcgJiYgdGhpcy5fY2xvc2VzdFZpZXcudW5oaWdobGlnaHQodGhpcy5fY2xvc2VzdEVuZC5zZWxlY3Rvcik7CiAgICAgICAgICAgICAgICB0aGlzLl9jbG9zZXN0VmlldyA9IHRoaXMuX2Nsb3Nlc3RFbmQgPSBudWxsOwoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdmlld1VuZGVyUG9pbnRlci51bmhpZ2hsaWdodCh0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIpOwogICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgYSB1bmlxdWUgYHNlbGVjdG9yYCBvZiB0aGUgZWxlbWVudCB1bmRlciBwb2ludGVyIHRoYXQgaXMgYSBtYWduZXQuIElmIHRoZQogICAgICAgICAgICAgICAgICAgIC8vIGB0aGlzLl9tYWduZXRVbmRlclBvaW50ZXJgIGlzIHRoZSByb290IGVsZW1lbnQgb2YgdGhlIGB0aGlzLl92aWV3VW5kZXJQb2ludGVyYCBpdHNlbGYsCiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIHJldHVybmVkIGBzZWxlY3RvcmAgd2lsbCBiZSBgdW5kZWZpbmVkYC4gVGhhdCBtZWFucyB3ZSBjYW4gZGlyZWN0bHkgcGFzcyBpdCB0byB0aGUKICAgICAgICAgICAgICAgICAgICAvLyBgc291cmNlYC9gdGFyZ2V0YCBhdHRyaWJ1dGUgb2YgdGhlIGxpbmsgbW9kZWwgYmVsb3cuCgkJICAgIHRoaXMubW9kZWwuc2V0KHRoaXMuX2Fycm93aGVhZCwgewogICAgICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5fdmlld1VuZGVyUG9pbnRlci5tb2RlbC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3I6IHRoaXMuX3ZpZXdVbmRlclBvaW50ZXIuZ2V0U2VsZWN0b3IodGhpcy5fbWFnbmV0VW5kZXJQb2ludGVyKSwKICAgICAgICAgICAgICAgICAgICAgICAgcG9ydDogJCh0aGlzLl9tYWduZXRVbmRlclBvaW50ZXIpLmF0dHIoJ3BvcnQnKQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl92aWV3VW5kZXJQb2ludGVyOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX21hZ25ldFVuZGVyUG9pbnRlcjsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdGF0aWNWaWV3OwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3N0YXRpY01hZ25ldDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fYWZ0ZXJBcnJvd2hlYWRNb3ZlKCk7CiAgICAgICAgfQoKICAgICAgICBkZWxldGUgdGhpcy5fYWN0aW9uOwogICAgfQp9KTsKCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMuTGluayA9IGpvaW50LmRpYS5MaW5rOwogICAgbW9kdWxlLmV4cG9ydHMuTGlua1ZpZXcgPSBqb2ludC5kaWEuTGlua1ZpZXc7Cn0KCi8vICAgICAgSm9pbnRKUyBsaWJyYXJ5LgovLyAgICAgIChjKSAyMDExLTIwMTMgY2xpZW50IElPCgoKam9pbnQuZGlhLlBhcGVyID0gQmFja2JvbmUuVmlldy5leHRlbmQoewoKICAgIGNsYXNzTmFtZTogJ3BhcGVyJywKCiAgICBvcHRpb25zOiB7CgogICAgICAgIHdpZHRoOiA4MDAsCiAgICAgICAgaGVpZ2h0OiA2MDAsCiAgICAgICAgb3JpZ2luOiB7IHg6IDAsIHk6IDAgfSwgLy8geCx5IGNvb3JkaW5hdGVzIGluIHRvcC1sZWZ0IGNvcm5lcgogICAgICAgIGdyaWRTaXplOiA1MCwKICAgICAgICBwZXJwZW5kaWN1bGFyTGlua3M6IGZhbHNlLAogICAgICAgIGVsZW1lbnRWaWV3OiBqb2ludC5kaWEuRWxlbWVudFZpZXcsCiAgICAgICAgbGlua1ZpZXc6IGpvaW50LmRpYS5MaW5rVmlldywKICAgICAgICBzbmFwTGlua3M6IGZhbHNlLCAvLyBmYWxzZSwgdHJ1ZSwgeyByYWRpdXM6IHZhbHVlIH0KCiAgICAgICAgLy8gTWFya3MgYWxsIGF2YWlsYWJsZSBtYWduZXRzIHdpdGggJ2F2YWlsYWJsZS1tYWduZXQnIGNsYXNzIG5hbWUgYW5kIGFsbCBhdmFpbGFibGUgY2VsbHMgd2l0aAogICAgICAgIC8vICdhdmFpbGFibGUtY2VsbCcgY2xhc3MgbmFtZS4gTWFya3MgdGhlbSB3aGVuIGRyYWdnaW5nIGEgbGluayBpcyBzdGFydGVkIGFuZCB1bm1hcmsKICAgICAgICAvLyB3aGVuIHRoZSBkcmFnZ2luZyBpcyBzdG9wcGVkLgogICAgICAgIG1hcmtBdmFpbGFibGU6IGZhbHNlLAoKICAgICAgICAvLyBEZWZpbmVzIHdoYXQgbGluayBtb2RlbCBpcyBhZGRlZCB0byB0aGUgZ3JhcGggYWZ0ZXIgYW4gdXNlciBjbGlja3Mgb24gYW4gYWN0aXZlIG1hZ25ldC4KICAgICAgICAvLyBWYWx1ZSBjb3VsZCBiZSB0aGUgQmFja2JvbmUubW9kZWwgb3IgYSBmdW5jdGlvbiByZXR1cm5pbmcgdGhlIEJhY2tib25lLm1vZGVsCiAgICAgICAgLy8gZGVmYXVsdExpbms6IGZ1bmN0aW9uKGVsZW1lbnRWaWV3LCBtYWduZXQpIHsgcmV0dXJuIGNvbmRpdGlvbiA/IG5ldyBjdXN0b21MaW5rMSgpIDogbmV3IGN1c3RvbUxpbmsyKCkgfQogICAgICAgIGRlZmF1bHRMaW5rOiBuZXcgam9pbnQuZGlhLkxpbmssCgogICAgICAgIC8vIENoZWNrIHdoZXRoZXIgdG8gYWRkIGEgbmV3IGxpbmsgdG8gdGhlIGdyYXBoIHdoZW4gdXNlciBjbGlja3Mgb24gYW4gYSBtYWduZXQuCiAgICAgICAgdmFsaWRhdGVNYWduZXQ6IGZ1bmN0aW9uKGNlbGxWaWV3LCBtYWduZXQpIHsKICAgICAgICAgICAgcmV0dXJuIG1hZ25ldC5nZXRBdHRyaWJ1dGUoJ21hZ25ldCcpICE9PSAncGFzc2l2ZSc7CiAgICAgICAgfSwKCiAgICAgICAgLy8gQ2hlY2sgd2hldGhlciB0byBhbGxvdyBvciBkaXNhbGxvdyB0aGUgbGluayBjb25uZWN0aW9uIHdoaWxlIGFuIGFycm93aGVhZCBlbmQgKHNvdXJjZS90YXJnZXQpCiAgICAgICAgLy8gYmVpbmcgY2hhbmdlZC4KICAgICAgICB2YWxpZGF0ZUNvbm5lY3Rpb246IGZ1bmN0aW9uKGNlbGxWaWV3UywgbWFnbmV0UywgY2VsbFZpZXdULCBtYWduZXRULCBlbmQsIGxpbmtWaWV3KSB7CiAgICAgICAgICAgIHJldHVybiAoZW5kID09PSAndGFyZ2V0JyA/IGNlbGxWaWV3VCA6IGNlbGxWaWV3UykgaW5zdGFuY2VvZiBqb2ludC5kaWEuRWxlbWVudFZpZXc7CiAgICAgICAgfQogICAgfSwKCiAgICBldmVudHM6IHsKCiAgICAgICAgJ21vdXNlZG93bic6ICdwb2ludGVyZG93bicsCiAgICAgICAgJ2RibGNsaWNrJzogJ21vdXNlZGJsY2xpY2snLAogICAgICAgICdjbGljayc6ICdtb3VzZWNsaWNrJywKICAgICAgICAndG91Y2hzdGFydCc6ICdwb2ludGVyZG93bicsCiAgICAgICAgJ21vdXNlbW92ZSc6ICdwb2ludGVybW92ZScsCiAgICAgICAgJ3RvdWNobW92ZSc6ICdwb2ludGVybW92ZScKICAgIH0sCgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCgl0aGlzLl9jb25maWd1cmUob3B0aW9ucyk7CglCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCglpZiAodGhpcy5vcHRpb25zKSBvcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOwoJdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0sCgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIF8uYmluZEFsbCh0aGlzLCAnYWRkQ2VsbCcsICdzb3J0Q2VsbHMnLCAncmVzZXRDZWxscycsICdwb2ludGVydXAnLCAnYXN5bmNSZW5kZXJDZWxscycpOwoKICAgICAgICB0aGlzLnN2ZyA9IFYoJ3N2ZycpLm5vZGU7CiAgICAgICAgdGhpcy52aWV3cG9ydCA9IFYoJ2cnKS5ub2RlOwoKICAgICAgICAvLyBBcHBlbmQgYDxkZWZzPmAgZWxlbWVudCB0byB0aGUgU1ZHIGRvY3VtZW50LiBUaGlzIGlzIHVzZWZ1bCBmb3IgZmlsdGVycyBhbmQgZ3JhZGllbnRzLgogICAgICAgIFYodGhpcy5zdmcpLmFwcGVuZChWKCdkZWZzJykubm9kZSk7CgogICAgICAgIFYodGhpcy52aWV3cG9ydCkuYXR0cih7ICdjbGFzcyc6ICd2aWV3cG9ydCcgfSk7CiAgICAgICAgCiAgICAgICAgVih0aGlzLnN2ZykuYXBwZW5kKHRoaXMudmlld3BvcnQpOwoKICAgICAgICB0aGlzLiRlbC5hcHBlbmQodGhpcy5zdmcpOwoKICAgICAgICB0aGlzLnNldE9yaWdpbigpOwogICAgICAgIHRoaXMuc2V0RGltZW5zaW9ucygpOwoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ2FkZCcsIHRoaXMuYWRkQ2VsbCk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdyZXNldCcsIHRoaXMucmVzZXRDZWxscyk7Cgl0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdzb3J0JywgdGhpcy5zb3J0Q2VsbHMpOwoKCSQoZG9jdW1lbnQpLm9uKCdtb3VzZXVwIHRvdWNoZW5kJywgdGhpcy5wb2ludGVydXApOwoKICAgICAgICAvLyBIb2xkIHRoZSB2YWx1ZSB3aGVuIG1vdXNlIGhhcyBiZWVuIG1vdmVkOiB3aGVuIG1vdXNlIG1vdmVkLCBubyBjbGljayBldmVudCB3aWxsIGJlIHRyaWdnZXJlZC4KICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gZmFsc2U7CiAgICB9LAoKICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CgoJJChkb2N1bWVudCkub2ZmKCdtb3VzZXVwIHRvdWNoZW5kJywgdGhpcy5wb2ludGVydXApOwoKCUJhY2tib25lLlZpZXcucHJvdG90eXBlLnJlbW92ZS5jYWxsKHRoaXMpOwogICAgfSwKCiAgICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHdpZHRoID0gdGhpcy5vcHRpb25zLndpZHRoID0gd2lkdGggfHwgdGhpcy5vcHRpb25zLndpZHRoOwogICAgICAgIGhlaWdodCA9IHRoaXMub3B0aW9ucy5oZWlnaHQgPSBoZWlnaHQgfHwgdGhpcy5vcHRpb25zLmhlaWdodDsKCiAgICAgICAgVih0aGlzLnN2ZykuYXR0cih7IHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQgfSk7CgogICAgICAgIHRoaXMudHJpZ2dlcigncmVzaXplJywgd2lkdGgsIGhlaWdodCk7CiAgICB9LAoKICAgIHNldE9yaWdpbjogZnVuY3Rpb24ob3gsIG95KSB7CgogICAgICAgIHRoaXMub3B0aW9ucy5vcmlnaW4ueCA9IG94IHx8IDA7CiAgICAgICAgdGhpcy5vcHRpb25zLm9yaWdpbi55ID0gb3kgfHwgMDsKCiAgICAgICAgVih0aGlzLnZpZXdwb3J0KS50cmFuc2xhdGUob3gsIG95LCB7IGFic29sdXRlOiB0cnVlIH0pOwoKICAgICAgICB0aGlzLnRyaWdnZXIoJ3RyYW5zbGF0ZScsIG94LCBveSk7CiAgICB9LAoKICAgIC8vIEV4cGFuZC9zaHJpbmsgdGhlIHBhcGVyIHRvIGZpdCB0aGUgY29udGVudC4gU25hcCB0aGUgd2lkdGgvaGVpZ2h0IHRvIHRoZSBncmlkCiAgICAvLyBkZWZpbmVkIGluIGBncmlkV2lkdGhgLCBgZ3JpZEhlaWdodGAuIGBwYWRkaW5nYCBhZGRzIHRvIHRoZSByZXN1bHRpbmcgd2lkdGgvaGVpZ2h0IG9mIHRoZSBwYXBlci4KICAgIC8vIFdoZW4gb3B0aW9ucyB7IGZpdE5lZ2F0aXZlOiB0cnVlIH0gaXQgYWxzbyB0cmFuc2xhdGVzIHRoZSB2aWV3cG9ydCBpbiBvcmRlciB0byBtYWtlIGFsbAogICAgLy8gdGhlIGNvbnRlbnQgdmlzaWJsZS4KICAgIGZpdFRvQ29udGVudDogZnVuY3Rpb24oZ3JpZFdpZHRoLCBncmlkSGVpZ2h0LCBwYWRkaW5nLCBvcHQpIHsgLy8gYWx0ZXJuYXRpdmVseSBmdW5jdGlvbihvcHQpCgogICAgICAgIGlmIChfLmlzT2JqZWN0KGdyaWRXaWR0aCkpIHsKICAgICAgICAgICAgLy8gZmlyc3QgcGFyYW1ldGVyIGlzIGFuIG9wdGlvbiBvYmplY3QKICAgICAgICAgICAgb3B0ID0gZ3JpZFdpZHRoOwoJICAgIGdyaWRXaWR0aCA9IG9wdC5ncmlkV2lkdGggfHwgMTsKCSAgICBncmlkSGVpZ2h0ID0gb3B0LmdyaWRIZWlnaHQgfHwgMTsKICAgICAgICAgICAgcGFkZGluZyA9IG9wdC5wYWRkaW5nIHx8IDA7CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBvcHQgPSBvcHQgfHwge307CgkgICAgZ3JpZFdpZHRoID0gZ3JpZFdpZHRoIHx8IDE7CgkgICAgZ3JpZEhlaWdodCA9IGdyaWRIZWlnaHQgfHwgMTsKICAgICAgICAgICAgcGFkZGluZyA9IHBhZGRpbmcgfHwgMDsKICAgICAgICB9CgoJLy8gQ2FsY3VsYXRlIHRoZSBwYXBlciBzaXplIHRvIGFjY29tb2RhdGUgYWxsIHRoZSBncmFwaCdzIGVsZW1lbnRzLgoJdmFyIGJib3ggPSBWKHRoaXMudmlld3BvcnQpLmJib3godHJ1ZSwgdGhpcy5zdmcpOwoKCXZhciBjYWxjV2lkdGggPSBNYXRoLm1heChNYXRoLmNlaWwoKGJib3gud2lkdGggKyBiYm94LngpIC8gZ3JpZFdpZHRoKSwgMSkgKiBncmlkV2lkdGg7Cgl2YXIgY2FsY0hlaWdodCA9IE1hdGgubWF4KE1hdGguY2VpbCgoYmJveC5oZWlnaHQgKyBiYm94LnkpIC8gZ3JpZEhlaWdodCksIDEpICogZ3JpZEhlaWdodDsKCiAgICAgICAgdmFyIHR4ID0gMDsKICAgICAgICB2YXIgdHkgPSAwOwoKICAgICAgICBpZiAob3B0LmZpdE5lZ2F0aXZlKSB7CgogICAgICAgICAgICBpZiAoYmJveC54IDwgMCkgewogICAgICAgICAgICAgICAgdHggPSBNYXRoLmNlaWwoLWJib3gueCAvIGdyaWRXaWR0aCkgKiBncmlkV2lkdGg7CiAgICAgICAgICAgICAgICBjYWxjV2lkdGggKz0gdHg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChiYm94LnkgPCAwKSB7CiAgICAgICAgICAgICAgICB0eSA9IE1hdGguY2VpbCgtYmJveC55IC8gZ3JpZEhlaWdodCkgKiBncmlkSGVpZ2h0OwogICAgICAgICAgICAgICAgY2FsY0hlaWdodCArPSB0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgY2FsY1dpZHRoICs9IHBhZGRpbmc7CiAgICAgICAgY2FsY0hlaWdodCArPSBwYWRkaW5nOwoKICAgICAgICB2YXIgZGltZW5zaW9uQ2hhbmdlID0gY2FsY1dpZHRoICE9IHRoaXMub3B0aW9ucy53aWR0aCB8fCBjYWxjSGVpZ2h0ICE9IHRoaXMub3B0aW9ucy5oZWlnaHQ7CiAgICAgICAgdmFyIG9yaWdpbkNoYW5nZSA9IG9wdC5maXROZWdhdGl2ZSAmJiAodHggIT0gdGhpcy5vcHRpb25zLm9yaWdpbi54IHx8IHR5ICE9IHRoaXMub3B0aW9ucy5vcmlnaW4ueSk7CgoJLy8gQ2hhbmdlIHRoZSBkaW1lbnNpb25zIG9ubHkgaWYgdGhlcmUgaXMgYSBzaXplIGRpc2NyZXBlbmN5IG9yIGFuIG9yaWdpbiBjaGFuZ2UKICAgICAgICBpZiAob3JpZ2luQ2hhbmdlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0T3JpZ2luKHR4LCB0eSk7CiAgICAgICAgfQoJaWYgKGRpbWVuc2lvbkNoYW5nZSkgewoJICAgIHRoaXMuc2V0RGltZW5zaW9ucyhjYWxjV2lkdGgsIGNhbGNIZWlnaHQpOwoJfQogICAgfSwKCiAgICBzY2FsZUNvbnRlbnRUb0ZpdDogZnVuY3Rpb24ob3B0KSB7CgogICAgICAgIHZhciBjb250ZW50QkJveCA9IHRoaXMuZ2V0Q29udGVudEJCb3goKTsKCiAgICAgICAgaWYgKCFjb250ZW50QkJveC53aWR0aCB8fCAhY29udGVudEJCb3guaGVpZ2h0KSByZXR1cm47CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgXy5kZWZhdWx0cyhvcHQsIHsKICAgICAgICAgICAgcGFkZGluZzogMCwKICAgICAgICAgICAgcHJlc2VydmVBc3BlY3RSYXRpbzogdHJ1ZSwKICAgICAgICAgICAgc2NhbGVHcmlkOiBudWxsLAogICAgICAgICAgICBtaW5TY2FsZTogMCwKICAgICAgICAgICAgbWF4U2NhbGU6IE51bWJlci5NQVhfVkFMVUUKICAgICAgICAgICAgLy9taW5TY2FsZVgKICAgICAgICAgICAgLy9taW5TY2FsZVkKICAgICAgICAgICAgLy9tYXhTY2FsZVgKICAgICAgICAgICAgLy9tYXhTY2FsZVkKICAgICAgICAgICAgLy9maXR0aW5nQkJveAogICAgICAgIH0pOwoKICAgICAgICB2YXIgcGFkZGluZyA9IG9wdC5wYWRkaW5nOwoKICAgICAgICB2YXIgbWluU2NhbGVYID0gb3B0Lm1pblNjYWxlWCB8fCBvcHQubWluU2NhbGU7CiAgICAgICAgdmFyIG1heFNjYWxlWCA9IG9wdC5tYXhTY2FsZVggfHwgb3B0Lm1heFNjYWxlOwogICAgICAgIHZhciBtaW5TY2FsZVkgPSBvcHQubWluU2NhbGVZIHx8IG9wdC5taW5TY2FsZTsKICAgICAgICB2YXIgbWF4U2NhbGVZID0gb3B0Lm1heFNjYWxlWSB8fCBvcHQubWF4U2NhbGU7CgogICAgICAgIHZhciBmaXR0aW5nQkJveCA9IG9wdC5maXR0aW5nQkJveCB8fCAoewogICAgICAgICAgICB4OiAwLAogICAgICAgICAgICB5OiAwLAogICAgICAgICAgICB3aWR0aDogdGhpcy5vcHRpb25zLndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHRoaXMub3B0aW9ucy5oZWlnaHQKICAgICAgICB9KTsKCiAgICAgICAgZml0dGluZ0JCb3ggPSBnLnJlY3QoZml0dGluZ0JCb3gpLm1vdmVBbmRFeHBhbmQoewogICAgICAgICAgICB4OiBwYWRkaW5nLAogICAgICAgICAgICB5OiBwYWRkaW5nLAogICAgICAgICAgICB3aWR0aDogLTIgKiBwYWRkaW5nLAogICAgICAgICAgICBoZWlnaHQ6IC0yICogcGFkZGluZwogICAgICAgIH0pOwoKICAgICAgICB2YXIgY3VycmVudFNjYWxlID0gVih0aGlzLnZpZXdwb3J0KS5zY2FsZSgpOwoKICAgICAgICB2YXIgbmV3U3ggPSBmaXR0aW5nQkJveC53aWR0aCAvIGNvbnRlbnRCQm94LndpZHRoICogY3VycmVudFNjYWxlLnN4OwogICAgICAgIHZhciBuZXdTeSA9IGZpdHRpbmdCQm94LmhlaWdodCAvIGNvbnRlbnRCQm94LmhlaWdodCAqIGN1cnJlbnRTY2FsZS5zeTsKCiAgICAgICAgaWYgKG9wdC5wcmVzZXJ2ZUFzcGVjdFJhdGlvKSB7CiAgICAgICAgICAgIG5ld1N4ID0gbmV3U3kgPSBNYXRoLm1pbihuZXdTeCwgbmV3U3kpOwogICAgICAgIH0KCiAgICAgICAgLy8gc25hcCBzY2FsZSB0byBhIGdyaWQKICAgICAgICBpZiAob3B0LnNjYWxlR3JpZCkgewoKICAgICAgICAgICAgdmFyIGdyaWRTaXplID0gb3B0LnNjYWxlR3JpZDsKCiAgICAgICAgICAgIG5ld1N4ID0gZ3JpZFNpemUgKiBNYXRoLmZsb29yKG5ld1N4IC8gZ3JpZFNpemUpOwogICAgICAgICAgICBuZXdTeSA9IGdyaWRTaXplICogTWF0aC5mbG9vcihuZXdTeSAvIGdyaWRTaXplKTsKICAgICAgICB9CgogICAgICAgIC8vIHNjYWxlIG1pbi9tYXggYm91bmRhcmllcwogICAgICAgIG5ld1N4ID0gTWF0aC5taW4obWF4U2NhbGVYLCBNYXRoLm1heChtaW5TY2FsZVgsIG5ld1N4KSk7CiAgICAgICAgbmV3U3kgPSBNYXRoLm1pbihtYXhTY2FsZVksIE1hdGgubWF4KG1pblNjYWxlWSwgbmV3U3kpKTsKCiAgICAgICAgdGhpcy5zY2FsZShuZXdTeCwgbmV3U3kpOwoKICAgICAgICB2YXIgY29udGVudFRyYW5zbGF0aW9uID0gdGhpcy5nZXRDb250ZW50QkJveCgpOwoKICAgICAgICB2YXIgbmV3T3ggPSBmaXR0aW5nQkJveC54IC0gY29udGVudFRyYW5zbGF0aW9uLng7CiAgICAgICAgdmFyIG5ld095ID0gZml0dGluZ0JCb3gueSAtIGNvbnRlbnRUcmFuc2xhdGlvbi55OwoKICAgICAgICB0aGlzLnNldE9yaWdpbihuZXdPeCwgbmV3T3kpOwogICAgfSwKCiAgICBnZXRDb250ZW50QkJveDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBjcmVjdCA9IHRoaXMudmlld3BvcnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICAgIC8vIFVzaW5nIFNjcmVlbiBDVE0gd2FzIHRoZSBvbmx5IHdheSB0byBnZXQgdGhlIHJlYWwgdmlld3BvcnQgYm91bmRpbmcgYm94IHdvcmtpbmcgaW4gYm90aAogICAgICAgIC8vIEdvb2dsZSBDaHJvbWUgYW5kIEZpcmVmb3guCiAgICAgICAgdmFyIHNjcmVlbkNUTSA9IHRoaXMudmlld3BvcnQuZ2V0U2NyZWVuQ1RNKCk7CgogICAgICAgIC8vIGZvciBub24tZGVmYXVsdCBvcmlnaW4gd2UgbmVlZCB0byB0YWtlIHRoZSB2aWV3cG9ydCB0cmFuc2xhdGlvbiBpbnRvIGFjY291bnQKICAgICAgICB2YXIgdmlld3BvcnRDVE0gPSB0aGlzLnZpZXdwb3J0LmdldENUTSgpOwoKICAgICAgICB2YXIgYmJveCA9IGcucmVjdCh7CiAgICAgICAgICAgIHg6IGNyZWN0LmxlZnQgLSBzY3JlZW5DVE0uZSArIHZpZXdwb3J0Q1RNLmUsCiAgICAgICAgICAgIHk6IGNyZWN0LnRvcCAtIHNjcmVlbkNUTS5mICsgdmlld3BvcnRDVE0uZiwKICAgICAgICAgICAgd2lkdGg6IGNyZWN0LndpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IGNyZWN0LmhlaWdodAogICAgICAgIH0pOwoKICAgICAgICByZXR1cm4gYmJveDsKICAgIH0sCgogICAgY3JlYXRlVmlld0Zvck1vZGVsOiBmdW5jdGlvbihjZWxsKSB7CgogICAgICAgIHZhciB2aWV3OwogICAgICAgIAogICAgICAgIHZhciB0eXBlID0gY2VsbC5nZXQoJ3R5cGUnKTsKICAgICAgICB2YXIgbW9kdWxlID0gdHlwZS5zcGxpdCgnLicpWzBdOwogICAgICAgIHZhciBlbnRpdHkgPSB0eXBlLnNwbGl0KCcuJylbMV07CgogICAgICAgIC8vIElmIHRoZXJlIGlzIGEgc3BlY2lhbCB2aWV3IGRlZmluZWQgZm9yIHRoaXMgbW9kZWwsIHVzZSB0aGF0IG9uZSBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IGBlbGVtZW50Vmlld2AvYGxpbmtWaWV3YC4KICAgICAgICBpZiAoam9pbnQuc2hhcGVzW21vZHVsZV0gJiYgam9pbnQuc2hhcGVzW21vZHVsZV1bZW50aXR5ICsgJ1ZpZXcnXSkgewoKICAgICAgICAgICAgdmlldyA9IG5ldyBqb2ludC5zaGFwZXNbbW9kdWxlXVtlbnRpdHkgKyAnVmlldyddKHsgbW9kZWw6IGNlbGwsIGludGVyYWN0aXZlOiB0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgfSk7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSBpZiAoY2VsbCBpbnN0YW5jZW9mIGpvaW50LmRpYS5FbGVtZW50KSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdmlldyA9IG5ldyB0aGlzLm9wdGlvbnMuZWxlbWVudFZpZXcoeyBtb2RlbDogY2VsbCwgaW50ZXJhY3RpdmU6IHRoaXMub3B0aW9ucy5pbnRlcmFjdGl2ZSB9KTsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHZpZXcgPSBuZXcgdGhpcy5vcHRpb25zLmxpbmtWaWV3KHsgbW9kZWw6IGNlbGwsIGludGVyYWN0aXZlOiB0aGlzLm9wdGlvbnMuaW50ZXJhY3RpdmUgfSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgICAKICAgIGFkZENlbGw6IGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmNyZWF0ZVZpZXdGb3JNb2RlbChjZWxsKTsKCiAgICAgICAgVih0aGlzLnZpZXdwb3J0KS5hcHBlbmQodmlldy5lbCk7CiAgICAgICAgdmlldy5wYXBlciA9IHRoaXM7CiAgICAgICAgdmlldy5yZW5kZXIoKTsKCiAgICAgICAgLy8gVGhpcyBpcyB0aGUgb25seSB3YXkgdG8gcHJldmVudCBpbWFnZSBkcmFnZ2luZyBpbiBGaXJlZm94IHRoYXQgd29ya3MuCiAgICAgICAgLy8gU2V0dGluZyAtbW96LXVzZXItc2VsZWN0OiBub25lLCBkcmFnZ2FibGU9ImZhbHNlIiBhdHRyaWJ1dGUgb3IgdXNlci1kcmFnOiBub25lIGRpZG4ndCBoZWxwLgogICAgICAgICQodmlldy5lbCkuZmluZCgnaW1hZ2UnKS5vbignZHJhZ3N0YXJ0JywgZnVuY3Rpb24oKSB7IHJldHVybiBmYWxzZTsgfSk7CiAgICB9LAoKICAgIHJlc2V0Q2VsbHM6IGZ1bmN0aW9uKGNlbGxzQ29sbGVjdGlvbikgewoKICAgICAgICAkKHRoaXMudmlld3BvcnQpLmVtcHR5KCk7CgogICAgICAgIHZhciBjZWxscyA9IGNlbGxzQ29sbGVjdGlvbi5tb2RlbHMuc2xpY2UoKTsKCiAgICAgICAgLy8gTWFrZSBzdXJlIGxpbmtzIGFyZSBhbHdheXMgYWRkZWQgQUZURVIgZWxlbWVudHMuCiAgICAgICAgLy8gVGhleSB3b3VsZG4ndCBmaW5kIHRoZWlyIHNvdXJjZXMvdGFyZ2V0cyBpbiB0aGUgRE9NIG90aGVyd2lzZS4KICAgICAgICBjZWxscy5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsgcmV0dXJuIGEgaW5zdGFuY2VvZiBqb2ludC5kaWEuTGluayA/IDEgOiAtMTsgfSk7CiAgICAgICAgCglpZiAodGhpcy5fZnJhbWVJZCkgewoJICAgIGpvaW50LnV0aWwuY2FuY2VsRnJhbWUodGhpcy5fZnJhbWVJZCk7Cgl9CglpZiAodGhpcy5vcHRpb25zLmFzeW5jKSB7CgoJICAgIHRoaXMuYXN5bmNSZW5kZXJDZWxscyhjZWxscyk7CgoJfSBlbHNlIHsKCiAgICAgICAgICAgIF8uZWFjaChjZWxscywgdGhpcy5hZGRDZWxsLCB0aGlzKTsKCX0KCiAgICAgICAgLy8gU29ydCB0aGUgY2VsbHMgaW4gdGhlIERPTSBtYW51YWxseSBhcyB3ZSBtaWdodCBoYXZlIGNoYW5nZWQgdGhlIG9yZGVyIHRoZXkKICAgICAgICAvLyB3ZXJlIGFkZGVkIHRvIHRoZSBET00gKHNlZSBhYm92ZSkuCiAgICAgICAgdGhpcy5zb3J0Q2VsbHMoKTsKICAgIH0sCgogICAgYXN5bmNSZW5kZXJDZWxsczogZnVuY3Rpb24oY2VsbHMpIHsKCiAgICAgICAgdmFyIGRvbmUgPSBmYWxzZTsKCiAgICAgICAgXy5lYWNoKF8ucmFuZ2UodGhpcy5vcHRpb25zLmFzeW5jICYmIHRoaXMub3B0aW9ucy5hc3luYy5iYXRjaFNpemUgfHwgNTApLCBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIHZhciBjZWxsID0gY2VsbHMuc2hpZnQoKTsKCSAgICBkb25lID0gIWNlbGw7CiAgICAgICAgICAgIGlmICghZG9uZSkgdGhpcy5hZGRDZWxsKGNlbGwpOwoKICAgICAgICB9LCB0aGlzKTsKCiAgICAgICAgaWYgKGRvbmUpIHsKCgkgICAgdGhpcy50cmlnZ2VyKCdyZW5kZXI6ZG9uZScpOwoKCX0gZWxzZSB7CgogICAgICAgICAgICB0aGlzLl9mcmFtZUlkID0gam9pbnQudXRpbC5uZXh0RnJhbWUoXy5iaW5kKGZ1bmN0aW9uKCkgewoJCXRoaXMuYXN5bmNSZW5kZXJDZWxscyhjZWxscyk7CgkgICAgfSwgdGhpcykpOwogICAgICAgIH0KICAgIH0sCgogICAgc29ydENlbGxzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgLy8gUnVuIGluc2VydGlvbiBzb3J0IGFsZ29yaXRobSBpbiBvcmRlciB0byBlZmZpY2llbnRseSBzb3J0IERPTSBlbGVtZW50cyBhY2NvcmRpbmcgdG8gdGhlaXIKICAgICAgICAvLyBhc3NvY2lhdGVkIG1vZGVsIGB6YCBhdHRyaWJ1dGUuCgogICAgICAgIHZhciAkY2VsbHMgPSAkKHRoaXMudmlld3BvcnQpLmNoaWxkcmVuKCdbbW9kZWwtaWRdJyk7CiAgICAgICAgdmFyIGNlbGxzID0gdGhpcy5tb2RlbC5nZXQoJ2NlbGxzJyk7CgogICAgICAgIHRoaXMuc29ydEVsZW1lbnRzKCRjZWxscywgZnVuY3Rpb24oYSwgYikgewoKICAgICAgICAgICAgdmFyIGNlbGxBID0gY2VsbHMuZ2V0KCQoYSkuYXR0cignbW9kZWwtaWQnKSk7CiAgICAgICAgICAgIHZhciBjZWxsQiA9IGNlbGxzLmdldCgkKGIpLmF0dHIoJ21vZGVsLWlkJykpOwogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIChjZWxsQS5nZXQoJ3onKSB8fCAwKSA+IChjZWxsQi5nZXQoJ3onKSB8fCAwKSA/IDEgOiAtMTsKICAgICAgICB9KTsKICAgIH0sCgogICAgLy8gSGlnaGx5IGluc3BpcmVkIGJ5IHRoZSBqcXVlcnkuc29ydEVsZW1lbnRzIHBsdWdpbiBieSBQYWRvbHNleS4KICAgIC8vIFNlZSBodHRwOi8vamFtZXMucGFkb2xzZXkuY29tL2phdmFzY3JpcHQvc29ydGluZy1lbGVtZW50cy13aXRoLWpxdWVyeS8uCiAgICBzb3J0RWxlbWVudHM6IGZ1bmN0aW9uKGVsZW1lbnRzLCBjb21wYXJhdG9yKSB7CgogICAgICAgIHZhciAkZWxlbWVudHMgPSAkKGVsZW1lbnRzKTsKICAgICAgICAKICAgICAgICB2YXIgcGxhY2VtZW50cyA9ICRlbGVtZW50cy5tYXAoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc29ydEVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHNvcnRFbGVtZW50LnBhcmVudE5vZGU7CgogICAgICAgICAgICAvLyBTaW5jZSB0aGUgZWxlbWVudCBpdHNlbGYgd2lsbCBjaGFuZ2UgcG9zaXRpb24sIHdlIGhhdmUKICAgICAgICAgICAgLy8gdG8gaGF2ZSBzb21lIHdheSBvZiBzdG9yaW5nIGl0J3Mgb3JpZ2luYWwgcG9zaXRpb24gaW4KICAgICAgICAgICAgLy8gdGhlIERPTS4gVGhlIGVhc2llc3Qgd2F5IGlzIHRvIGhhdmUgYSAnZmxhZycgbm9kZToKICAgICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoCiAgICAgICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgnJyksCiAgICAgICAgICAgICAgICBzb3J0RWxlbWVudC5uZXh0U2libGluZwogICAgICAgICAgICApOwoKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gdGhpcykgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAgICAgICAgICAgIllvdSBjYW4ndCBzb3J0IGVsZW1lbnRzIGlmIGFueSBvbmUgaXMgYSBkZXNjZW5kYW50IG9mIGFub3RoZXIuIgogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIEluc2VydCBiZWZvcmUgZmxhZzoKICAgICAgICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXMsIG5leHRTaWJsaW5nKTsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBmbGFnOgogICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuZXh0U2libGluZyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfTsKICAgICAgICB9KTsKCiAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5zb3J0LmNhbGwoJGVsZW1lbnRzLCBjb21wYXJhdG9yKS5lYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgcGxhY2VtZW50c1tpXS5jYWxsKHRoaXMpOwogICAgICAgIH0pOwogICAgfSwKCiAgICBzY2FsZTogZnVuY3Rpb24oc3gsIHN5LCBveCwgb3kpIHsKCiAgICAgICAgc3kgPSBzeSB8fCBzeDsKCiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQob3gpKSB7CgogICAgICAgICAgICBveCA9IDA7CiAgICAgICAgICAgIG95ID0gMDsKICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBwcmV2aW91cyB0cmFuc2Zvcm0gc28gdGhhdCB0aGUgbmV3IHNjYWxlIGlzIG5vdCBhZmZlY3RlZCBieSBwcmV2aW91cyBzY2FsZXMsIGVzcGVjaWFsbHkKICAgICAgICAvLyB0aGUgb2xkIHRyYW5zbGF0ZSgpIGRvZXMgbm90IGFmZmVjdCB0aGUgbmV3IHRyYW5zbGF0ZSBpZiBhbiBvcmlnaW4gaXMgc3BlY2lmaWVkLgogICAgICAgIFYodGhpcy52aWV3cG9ydCkuYXR0cigndHJhbnNmb3JtJywgJycpOwoKICAgICAgICB2YXIgb2xkVHggPSB0aGlzLm9wdGlvbnMub3JpZ2luLng7CiAgICAgICAgdmFyIG9sZFR5ID0gdGhpcy5vcHRpb25zLm9yaWdpbi55OwoKICAgICAgICAvLyBUT0RPOiBWLnNjYWxlKCkgZG9lc24ndCBzdXBwb3J0IHNldHRpbmcgc2NhbGUgb3JpZ2luLiAjRml4ICAgICAgICAKICAgICAgICBpZiAob3ggfHwgb3kgfHwgb2xkVHggfHwgb2xkVHkpIHsKCiAgICAgICAgICAgIHZhciBuZXdUeCA9IG9sZFR4IC0gb3ggKiAoc3ggLSAxKTsKICAgICAgICAgICAgdmFyIG5ld1R5ID0gb2xkVHkgLSBveSAqIChzeSAtIDEpOwoKICAgICAgICAgICAgaWYgKG5ld1R4ICE9IG9sZFR4IHx8IG5ld1R5ICE9IG9sZFR5KSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldE9yaWdpbihuZXdUeCwgbmV3VHkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBWKHRoaXMudmlld3BvcnQpLnNjYWxlKHN4LCBzeSk7CgoJdGhpcy50cmlnZ2VyKCdzY2FsZScsIHN4LCBzeSwgb3gsIG95KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIHJvdGF0ZTogZnVuY3Rpb24oZGVnLCBveCwgb3kpIHsKICAgICAgICAKICAgICAgICAvLyBJZiB0aGUgb3JpZ2luIGlzIG5vdCBzZXQgZXhwbGljaXRlbHksIHJvdGF0ZSBhcm91bmQgdGhlIGNlbnRlci4gTm90ZSB0aGF0CiAgICAgICAgLy8gd2UgbXVzdCB1c2UgdGhlIHBsYWluIGJvdW5kaW5nIGJveCAoYHRoaXMuZWwuZ2V0QkJveCgpYCBpbnN0ZWFkIG9mIHRoZSBvbmUgdGhhdCBnaXZlcyB1cwogICAgICAgIC8vIHRoZSByZWFsIGJvdW5kaW5nIGJveCAoYGJib3goKWApIGluY2x1ZGluZyB0cmFuc2Zvcm1hdGlvbnMpLgogICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKG94KSkgewoKICAgICAgICAgICAgdmFyIGJib3ggPSB0aGlzLnZpZXdwb3J0LmdldEJCb3goKTsKICAgICAgICAgICAgb3ggPSBiYm94LndpZHRoLzI7CiAgICAgICAgICAgIG95ID0gYmJveC5oZWlnaHQvMjsKICAgICAgICB9CgogICAgICAgIFYodGhpcy52aWV3cG9ydCkucm90YXRlKGRlZywgb3gsIG95KTsKICAgIH0sCgogICAgLy8gRmluZCB0aGUgZmlyc3QgdmlldyBjbGltYmluZyB1cCB0aGUgRE9NIHRyZWUgc3RhcnRpbmcgYXQgZWxlbWVudCBgZWxgLiBOb3RlIHRoYXQgYGVsYCBjYW4gYWxzbwogICAgLy8gYmUgYSBzZWxlY3RvciBvciBhIGpRdWVyeSBvYmplY3QuCiAgICBmaW5kVmlldzogZnVuY3Rpb24oZWwpIHsKCiAgICAgICAgdmFyICRlbCA9IHRoaXMuJChlbCk7CgogICAgICAgIGlmICgkZWwubGVuZ3RoID09PSAwIHx8ICRlbFswXSA9PT0gdGhpcy5lbCkgewoKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CgogICAgICAgIGlmICgkZWwuZGF0YSgndmlldycpKSB7CgogICAgICAgICAgICByZXR1cm4gJGVsLmRhdGEoJ3ZpZXcnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmZpbmRWaWV3KCRlbC5wYXJlbnQoKSk7CiAgICB9LAoKICAgIC8vIEZpbmQgYSB2aWV3IGZvciBhIG1vZGVsIGBjZWxsYC4gYGNlbGxgIGNhbiBhbHNvIGJlIGEgc3RyaW5nIHJlcHJlc2VudGluZyBhIG1vZGVsIGBpZGAuCiAgICBmaW5kVmlld0J5TW9kZWw6IGZ1bmN0aW9uKGNlbGwpIHsKCiAgICAgICAgdmFyIGlkID0gXy5pc1N0cmluZyhjZWxsKSA/IGNlbGwgOiBjZWxsLmlkOwogICAgICAgIAogICAgICAgIHZhciAkdmlldyA9IHRoaXMuJCgnW21vZGVsLWlkPSInICsgaWQgKyAnIl0nKTsKICAgICAgICBpZiAoJHZpZXcubGVuZ3RoKSB7CgogICAgICAgICAgICByZXR1cm4gJHZpZXcuZGF0YSgndmlldycpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBhdCBnaXZlbiBwb2ludAogICAgZmluZFZpZXdzRnJvbVBvaW50OiBmdW5jdGlvbihwKSB7CgoJcCA9IGcucG9pbnQocCk7CgogICAgICAgIHZhciB2aWV3cyA9IF8ubWFwKHRoaXMubW9kZWwuZ2V0RWxlbWVudHMoKSwgdGhpcy5maW5kVmlld0J5TW9kZWwpOwoKCXJldHVybiBfLmZpbHRlcih2aWV3cywgZnVuY3Rpb24odmlldykgewoJICAgIHJldHVybiBnLnJlY3QoVih2aWV3LmVsKS5iYm94KGZhbHNlLCB0aGlzLnZpZXdwb3J0KSkuY29udGFpbnNQb2ludChwKTsKCX0sIHRoaXMpOwogICAgfSwKCiAgICAvLyBGaW5kIGFsbCB2aWV3cyBpbiBnaXZlbiBhcmVhCiAgICBmaW5kVmlld3NJbkFyZWE6IGZ1bmN0aW9uKHIpIHsKCglyID0gZy5yZWN0KHIpOwoKICAgICAgICB2YXIgdmlld3MgPSBfLm1hcCh0aGlzLm1vZGVsLmdldEVsZW1lbnRzKCksIHRoaXMuZmluZFZpZXdCeU1vZGVsKTsKCglyZXR1cm4gXy5maWx0ZXIodmlld3MsIGZ1bmN0aW9uKHZpZXcpIHsKCSAgICByZXR1cm4gci5pbnRlcnNlY3QoZy5yZWN0KFYodmlldy5lbCkuYmJveChmYWxzZSwgdGhpcy52aWV3cG9ydCkpKTsKCX0sIHRoaXMpOwogICAgfSwKCiAgICBnZXRNb2RlbEJ5SWQ6IGZ1bmN0aW9uKGlkKSB7CgogICAgICAgIHJldHVybiB0aGlzLm1vZGVsLmdldENlbGwoaWQpOwogICAgfSwKCiAgICBzbmFwVG9HcmlkOiBmdW5jdGlvbihwKSB7CgogICAgICAgIC8vIENvbnZlcnQgZ2xvYmFsIGNvb3JkaW5hdGVzIHRvIHRoZSBsb2NhbCBvbmVzIG9mIHRoZSBgdmlld3BvcnRgLiBPdGhlcndpc2UsCiAgICAgICAgLy8gaW1wcm9wZXIgdHJhbnNmb3JtYXRpb24gd291bGQgYmUgYXBwbGllZCB3aGVuIHRoZSB2aWV3cG9ydCBnZXRzIHRyYW5zZm9ybWVkIChzY2FsZWQvcm90YXRlZCkuIAogICAgICAgIHZhciBsb2NhbFBvaW50ID0gVih0aGlzLnZpZXdwb3J0KS50b0xvY2FsUG9pbnQocC54LCBwLnkpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB4OiBnLnNuYXBUb0dyaWQobG9jYWxQb2ludC54LCB0aGlzLm9wdGlvbnMuZ3JpZFNpemUpLAogICAgICAgICAgICB5OiBnLnNuYXBUb0dyaWQobG9jYWxQb2ludC55LCB0aGlzLm9wdGlvbnMuZ3JpZFNpemUpCiAgICAgICAgfTsKICAgIH0sCgogICAgZ2V0RGVmYXVsdExpbms6IGZ1bmN0aW9uKGNlbGxWaWV3LCBtYWduZXQpIHsKCiAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbih0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmspCiAgICAgICAgLy8gZGVmYXVsdCBsaW5rIGlzIGEgZnVuY3Rpb24gcHJvZHVjaW5nIGxpbmsgbW9kZWwKICAgICAgICAgICAgPyB0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmsuY2FsbCh0aGlzLCBjZWxsVmlldywgbWFnbmV0KQogICAgICAgIC8vIGRlZmF1bHQgbGluayBpcyB0aGUgQmFja2JvbmUgbW9kZWwKICAgICAgICAgICAgOiB0aGlzLm9wdGlvbnMuZGVmYXVsdExpbmsuY2xvbmUoKTsKICAgIH0sCgogICAgLy8gSW50ZXJhY3Rpb24uCiAgICAvLyAtLS0tLS0tLS0tLS0KCiAgICBtb3VzZWRibGNsaWNrOiBmdW5jdGlvbihldnQpIHsKICAgICAgICAKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldnQgPSBqb2ludC51dGlsLm5vcm1hbGl6ZUV2ZW50KGV2dCk7CiAgICAgICAgCiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmZpbmRWaWV3KGV2dC50YXJnZXQpOwogICAgICAgIHZhciBsb2NhbFBvaW50ID0gdGhpcy5zbmFwVG9HcmlkKHsgeDogZXZ0LmNsaWVudFgsIHk6IGV2dC5jbGllbnRZIH0pOwoKICAgICAgICBpZiAodmlldykgewogICAgICAgICAgICAKICAgICAgICAgICAgdmlldy5wb2ludGVyZGJsY2xpY2soZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIAogICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JsYW5rOnBvaW50ZXJkYmxjbGljaycsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgbW91c2VjbGljazogZnVuY3Rpb24oZXZ0KSB7CgogICAgICAgIC8vIFRyaWdnZXIgZXZlbnQgd2hlbiBtb3VzZSBub3QgbW92ZWQuCiAgICAgICAgaWYgKCF0aGlzLl9tb3VzZW1vdmVkKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwoKICAgICAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmZpbmRWaWV3KGV2dC50YXJnZXQpOwogICAgICAgICAgICB2YXIgbG9jYWxQb2ludCA9IHRoaXMuc25hcFRvR3JpZCh7IHg6IGV2dC5jbGllbnRYLCB5OiBldnQuY2xpZW50WSB9KTsKCiAgICAgICAgICAgIGlmICh2aWV3KSB7CgogICAgICAgICAgICAgICAgdmlldy5wb2ludGVyY2xpY2soZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICB0aGlzLnRyaWdnZXIoJ2JsYW5rOnBvaW50ZXJjbGljaycsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gZmFsc2U7CiAgICB9LAoKICAgIHBvaW50ZXJkb3duOiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwogICAgICAgIAogICAgICAgIHZhciB2aWV3ID0gdGhpcy5maW5kVmlldyhldnQudGFyZ2V0KTsKCiAgICAgICAgdmFyIGxvY2FsUG9pbnQgPSB0aGlzLnNuYXBUb0dyaWQoeyB4OiBldnQuY2xpZW50WCwgeTogZXZ0LmNsaWVudFkgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHZpZXcpIHsKCiAgICAgICAgICAgIHRoaXMuc291cmNlVmlldyA9IHZpZXc7CgogICAgICAgICAgICB2aWV3LnBvaW50ZXJkb3duKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgdGhpcy50cmlnZ2VyKCdibGFuazpwb2ludGVyZG93bicsIGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcm1vdmU6IGZ1bmN0aW9uKGV2dCkgewoKICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldnQgPSBqb2ludC51dGlsLm5vcm1hbGl6ZUV2ZW50KGV2dCk7CgogICAgICAgIGlmICh0aGlzLnNvdXJjZVZpZXcpIHsKCiAgICAgICAgICAgIC8vIE1vdXNlIG1vdmVkLgogICAgICAgICAgICB0aGlzLl9tb3VzZW1vdmVkID0gdHJ1ZTsKCiAgICAgICAgICAgIHZhciBsb2NhbFBvaW50ID0gdGhpcy5zbmFwVG9HcmlkKHsgeDogZXZ0LmNsaWVudFgsIHk6IGV2dC5jbGllbnRZIH0pOwoKICAgICAgICAgICAgdGhpcy5zb3VyY2VWaWV3LnBvaW50ZXJtb3ZlKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwogICAgICAgIH0KICAgIH0sCgogICAgcG9pbnRlcnVwOiBmdW5jdGlvbihldnQpIHsKCiAgICAgICAgZXZ0ID0gam9pbnQudXRpbC5ub3JtYWxpemVFdmVudChldnQpOwoKICAgICAgICB2YXIgbG9jYWxQb2ludCA9IHRoaXMuc25hcFRvR3JpZCh7IHg6IGV2dC5jbGllbnRYLCB5OiBldnQuY2xpZW50WSB9KTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5zb3VyY2VWaWV3KSB7CgogICAgICAgICAgICB0aGlzLnNvdXJjZVZpZXcucG9pbnRlcnVwKGV2dCwgbG9jYWxQb2ludC54LCBsb2NhbFBvaW50LnkpOwoKICAgICAgICAgICAgLy8iZGVsZXRlIHNvdXJjZVZpZXciIG9jY2FzaW9uYWxseSB0aHJvd3MgYW4gZXJyb3IgaW4gY2hyb21lIChpbGxlZ2FsIGFjY2VzcyBleGNlcHRpb24pCgkgICAgdGhpcy5zb3VyY2VWaWV3ID0gbnVsbDsKCiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIHRoaXMudHJpZ2dlcignYmxhbms6cG9pbnRlcnVwJywgZXZ0LCBsb2NhbFBvaW50LngsIGxvY2FsUG9pbnQueSk7CiAgICAgICAgfQogICAgfQp9KTsKCgovLyAgICAgIEpvaW50SlMgbGlicmFyeS4KLy8gICAgICAoYykgMjAxMS0yMDEzIGNsaWVudCBJTwoKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczoge30sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnQ6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnQsCiAgICAgICAgICAgIEVsZW1lbnRWaWV3OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50VmlldwogICAgICAgIH0KICAgIH07CiAgICB2YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpOwp9CgoKam9pbnQuc2hhcGVzLmJhc2ljID0ge307CgoKam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgICAgICAKICAgICAgICB0eXBlOiAnYmFzaWMuR2VuZXJpYycsCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy4nOiB7IGZpbGw6ICcjRkZGRkZGJywgc3Ryb2tlOiAnbm9uZScgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LmRpYS5FbGVtZW50LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuUmVjdCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cmVjdC8+PC9nPjx0ZXh0Lz48L2c+JywKICAgIAogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewogICAgCiAgICAgICAgdHlwZTogJ2Jhc2ljLlJlY3QnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdyZWN0JzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJywgd2lkdGg6IDEwMCwgaGVpZ2h0OiA2MCB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3JlZi14JzogLjUsICdyZWYteSc6IC41LCByZWY6ICdyZWN0JywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsICd4LWFsaWdubWVudCc6ICdtaWRkbGUnLCBmaWxsOiAnYmxhY2snLCAnZm9udC1mYW1pbHknOiAnQXJpYWwsIGhlbHZldGljYSwgc2Fucy1zZXJpZicgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuVGV4dCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48dGV4dC8+PC9nPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgCiAgICAgICAgdHlwZTogJ2Jhc2ljLlRleHQnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICd0ZXh0JzogeyAnZm9udC1zaXplJzogMTgsIGZpbGw6ICdibGFjaycgfQogICAgICAgIH0KICAgICAgICAKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxjaXJjbGUvPjwvZz48dGV4dC8+PC9nPicsCiAgICAKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2Jhc2ljLkNpcmNsZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNjAsIGhlaWdodDogNjAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnY2lyY2xlJzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJywgcjogMzAsIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgzMCwgMzApJyB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLXknOiAuNSwgcmVmOiAnY2lyY2xlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsIGZpbGw6ICdibGFjaycsICdmb250LWZhbWlseSc6ICdBcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5iYXNpYy5JbWFnZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48aW1hZ2UvPjwvZz48dGV4dC8+PC9nPicsCiAgICAKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2Jhc2ljLkltYWdlJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLWR5JzogMjAsIHJlZjogJ2ltYWdlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsIGZpbGw6ICdibGFjaycsICdmb250LWZhbWlseSc6ICdBcmlhbCwgaGVsdmV0aWNhLCBzYW5zLXNlcmlmJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5iYXNpYy5QYXRoID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxwYXRoLz48L2c+PHRleHQvPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdiYXNpYy5QYXRoJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA2MCwgaGVpZ2h0OiA2MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdwYXRoJzogeyBmaWxsOiAnI0ZGRkZGRicsIHN0cm9rZTogJ2JsYWNrJyB9LAogICAgICAgICAgICAndGV4dCc6IHsgJ2ZvbnQtc2l6ZSc6IDE0LCB0ZXh0OiAnJywgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsICdyZWYteCc6IC41LCAncmVmLWR5JzogMjAsIHJlZjogJ3BhdGgnLCAneS1hbGlnbm1lbnQnOiAnbWlkZGxlJywgZmlsbDogJ2JsYWNrJywgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWYnIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmJhc2ljLlJob21idXMgPSBqb2ludC5zaGFwZXMuYmFzaWMuUGF0aC5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgIAogICAgICAgIHR5cGU6ICdiYXNpYy5SaG9tYnVzJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAncGF0aCc6IHsgZDogJ00gMzAgMCBMIDYwIDMwIDMwIDYwIDAgMzAgeicgfSwKICAgICAgICAgICAgJ3RleHQnOiB7ICdyZWYteSc6IC41IH0KICAgICAgICB9CiAgICAgICAgCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuUGF0aC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKCi8vIFBvcnRzTW9kZWxJbnRlcmZhY2UgaXMgYSBjb21tb24gaW50ZXJmYWNlIGZvciBzaGFwZXMgdGhhdCBoYXZlIHBvcnRzLiBUaGlzIGludGVyZmFjZSBtYWtlcyBpdCBlYXN5Ci8vIHRvIGNyZWF0ZSBuZXcgc2hhcGVzIHdpdGggcG9ydHMgZnVuY3Rpb25hbGl0eS4gSXQgaXMgYXNzdW1lZCB0aGF0IHRoZSBuZXcgc2hhcGVzIGhhdmUKLy8gYGluUG9ydHNgIGFuZCBgb3V0UG9ydHNgIGFycmF5IHByb3BlcnRpZXMuIE9ubHkgdGhlc2UgcHJvcGVydGllcyBzaG91bGQgYmUgdXNlZCB0byBzZXQgcG9ydHMuCi8vIEluIG90aGVyIHdvcmRzLCB1c2luZyB0aGlzIGludGVyZmFjZSwgaXQgaXMgbm8gbG9uZ2VyIHJlY29tbWVuZGVkIHRvIHNldCBwb3J0cyBkaXJlY3RseSB0aHJvdWdoIHRoZQovLyBgYXR0cnNgIG9iamVjdC4KCi8vIFVzYWdlOgovLyBqb2ludC5zaGFwZXMuY3VzdG9tLk15RWxlbWVudFdpdGhQb3J0cyA9IGpvaW50LnNoYXBlcy5iYXNpYy5QYXRoLmV4dGVuZChfLmV4dGVuZCh7fSwgam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UsIHsKLy8gICAgIGdldFBvcnRBdHRyczogZnVuY3Rpb24ocG9ydE5hbWUsIGluZGV4LCB0b3RhbCwgc2VsZWN0b3IsIHR5cGUpIHsKLy8gICAgICAgICB2YXIgYXR0cnMgPSB7fTsKLy8gICAgICAgICB2YXIgcG9ydENsYXNzID0gJ3BvcnQnICsgaW5kZXg7Ci8vICAgICAgICAgdmFyIHBvcnRTZWxlY3RvciA9IHNlbGVjdG9yICsgJz4uJyArIHBvcnRDbGFzczsKLy8gICAgICAgICB2YXIgcG9ydFRleHRTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+dGV4dCc7Ci8vICAgICAgICAgdmFyIHBvcnRDaXJjbGVTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+Y2lyY2xlJzsKLy8KLy8gICAgICAgICBhdHRyc1twb3J0VGV4dFNlbGVjdG9yXSA9IHsgdGV4dDogcG9ydE5hbWUgfTsKLy8gICAgICAgICBhdHRyc1twb3J0Q2lyY2xlU2VsZWN0b3JdID0geyBwb3J0OiB7IGlkOiBwb3J0TmFtZSB8fCBfLnVuaXF1ZUlkKHR5cGUpICwgdHlwZTogdHlwZSB9IH07Ci8vICAgICAgICAgYXR0cnNbcG9ydFNlbGVjdG9yXSA9IHsgcmVmOiAncmVjdCcsICdyZWYteSc6IChpbmRleCArIDAuNSkgKiAoMSAvIHRvdGFsKSB9OwovLwovLyAgICAgICAgIGlmIChzZWxlY3RvciA9PT0gJy5vdXRQb3J0cycpIHsgYXR0cnNbcG9ydFNlbGVjdG9yXVsncmVmLWR4J10gPSAwOyB9Ci8vCi8vICAgICAgICAgcmV0dXJuIGF0dHJzOwovLyAgICAgfQovL30pKTsKam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UgPSB7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMudXBkYXRlUG9ydHNBdHRycygpOwogICAgICAgIHRoaXMub24oJ2NoYW5nZTppblBvcnRzIGNoYW5nZTpvdXRQb3J0cycsIHRoaXMudXBkYXRlUG9ydHNBdHRycywgdGhpcyk7CgogICAgICAgIC8vIENhbGwgdGhlIGBpbml0aWFsaXplKClgIG9mIHRoZSBwYXJlbnQuCiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fX3N1cGVyX18uY29uc3RydWN0b3IuX19zdXBlcl9fLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICAKICAgIHVwZGF0ZVBvcnRzQXR0cnM6IGZ1bmN0aW9uKGV2ZW50TmFtZSkgewoKICAgICAgICAvLyBEZWxldGUgcHJldmlvdXNseSBzZXQgYXR0cmlidXRlcyBmb3IgcG9ydHMuCiAgICAgICAgdmFyIGN1cnJBdHRycyA9IHRoaXMuZ2V0KCdhdHRycycpOwogICAgICAgIF8uZWFjaCh0aGlzLl9wb3J0U2VsZWN0b3JzLCBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICAgICAgICBpZiAoY3VyckF0dHJzW3NlbGVjdG9yXSkgZGVsZXRlIGN1cnJBdHRyc1tzZWxlY3Rvcl07CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgLy8gVGhpcyBob2xkcyBrZXlzIHRvIHRoZSBgYXR0cnNgIG9iamVjdCBmb3IgYWxsIHRoZSBwb3J0IHNwZWNpZmljIGF0dHJpYnV0ZSB0aGF0CiAgICAgICAgLy8gd2Ugc2V0IGluIHRoaXMgbWV0aG9kLiBUaGlzIGlzIG5lY2Vzc2FyeSBpbiBvcmRlciB0byByZW1vdmUgcHJldmlvdXNseSBzZXQKICAgICAgICAvLyBhdHRyaWJ1dGVzIGZvciBwcmV2aW91cyBwb3J0cy4KICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gW107CiAgICAgICAgCiAgICAgICAgdmFyIGF0dHJzID0ge307CiAgICAgICAgCiAgICAgICAgXy5lYWNoKHRoaXMuZ2V0KCdpblBvcnRzJyksIGZ1bmN0aW9uKHBvcnROYW1lLCBpbmRleCwgcG9ydHMpIHsKICAgICAgICAgICAgdmFyIHBvcnRBdHRyaWJ1dGVzID0gdGhpcy5nZXRQb3J0QXR0cnMocG9ydE5hbWUsIGluZGV4LCBwb3J0cy5sZW5ndGgsICcuaW5Qb3J0cycsICdpbicpOwogICAgICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gdGhpcy5fcG9ydFNlbGVjdG9ycy5jb25jYXQoXy5rZXlzKHBvcnRBdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKGF0dHJzLCBwb3J0QXR0cmlidXRlcyk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgCiAgICAgICAgXy5lYWNoKHRoaXMuZ2V0KCdvdXRQb3J0cycpLCBmdW5jdGlvbihwb3J0TmFtZSwgaW5kZXgsIHBvcnRzKSB7CiAgICAgICAgICAgIHZhciBwb3J0QXR0cmlidXRlcyA9IHRoaXMuZ2V0UG9ydEF0dHJzKHBvcnROYW1lLCBpbmRleCwgcG9ydHMubGVuZ3RoLCAnLm91dFBvcnRzJywgJ291dCcpOwogICAgICAgICAgICB0aGlzLl9wb3J0U2VsZWN0b3JzID0gdGhpcy5fcG9ydFNlbGVjdG9ycy5jb25jYXQoXy5rZXlzKHBvcnRBdHRyaWJ1dGVzKSk7CiAgICAgICAgICAgIF8uZXh0ZW5kKGF0dHJzLCBwb3J0QXR0cmlidXRlcyk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIC8vIFNpbGVudGx5IHNldCBgYXR0cnNgIG9uIHRoZSBjZWxsIHNvIHRoYXQgbm9vbmUga25vd3MgdGhlIGF0dHJzIGhhdmUgY2hhbmdlZC4gVGhpcyBtYWtlcyBzdXJlCiAgICAgICAgLy8gdGhhdCwgZm9yIGV4YW1wbGUsIGNvbW1hbmQgbWFuYWdlciBkb2VzIG5vdCByZWdpc3RlciBgY2hhbmdlOmF0dHJzYCBjb21tYW5kIGJ1dCBvbmx5CiAgICAgICAgLy8gdGhlIGltcG9ydGFudCBgY2hhbmdlOmluUG9ydHNgL2BjaGFuZ2U6b3V0UG9ydHNgIGNvbW1hbmQuCiAgICAgICAgdGhpcy5hdHRyKGF0dHJzLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgICAgICAvLyBNYW51YWxseSBjYWxsIHRoZSBgcHJvY2Vzc1BvcnRzKClgIG1ldGhvZCB0aGF0IGlzIG5vcm1hbGx5IGNhbGxlZCBvbiBgY2hhbmdlOmF0dHJzYCAodGhhdCB3ZSBqdXN0IG1hZGUgc2lsZW50KS4KICAgICAgICB0aGlzLnByb2Nlc3NQb3J0cygpOwogICAgICAgIC8vIExldCB0aGUgb3V0c2lkZSB3b3JsZCAobWFpbmx5IHRoZSBgTW9kZWxWaWV3YCkga25vdyB0aGF0IHdlJ3JlIGRvbmUgY29uZmlndXJpbmcgdGhlIGBhdHRyc2Agb2JqZWN0LgogICAgICAgIHRoaXMudHJpZ2dlcigncHJvY2Vzczpwb3J0cycpOwogICAgfSwKCiAgICBnZXRQb3J0U2VsZWN0b3I6IGZ1bmN0aW9uKG5hbWUpIHsKCiAgICAgICAgdmFyIHNlbGVjdG9yID0gJy5pblBvcnRzJzsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmdldCgnaW5Qb3J0cycpLmluZGV4T2YobmFtZSk7CgogICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgc2VsZWN0b3IgPSAnLm91dFBvcnRzJzsKICAgICAgICAgICAgaW5kZXggPSB0aGlzLmdldCgnb3V0UG9ydHMnKS5pbmRleE9mKG5hbWUpOwoKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkgdGhyb3cgbmV3IEVycm9yKCJnZXRQb3J0U2VsZWN0b3IoKTogUG9ydCBkb2Vzbid0IGV4aXN0LiIpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHNlbGVjdG9yICsgJz5nOm50aC1jaGlsZCgnICsgKGluZGV4ICsgMSkgKyAnKT5jaXJjbGUnOwogICAgfQp9OwoKam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzVmlld0ludGVyZmFjZSA9IHsKICAgIAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIGBNb2RlbGAgZW1pdHMgdGhlIGBwcm9jZXNzOnBvcnRzYCB3aGVuZXZlciBpdCdzIGRvbmUgY29uZmlndXJpbmcgdGhlIGBhdHRyc2Agb2JqZWN0IGZvciBwb3J0cy4KICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsICdwcm9jZXNzOnBvcnRzJywgdGhpcy51cGRhdGUpOwogICAgICAgIAogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICB1cGRhdGU6IGZ1bmN0aW9uKCkgewoKICAgICAgICAvLyBGaXJzdCByZW5kZXIgcG9ydHMgc28gdGhhdCBgYXR0cnNgIGNhbiBiZSBhcHBsaWVkIHRvIHRob3NlIG5ld2x5IGNyZWF0ZWQgRE9NIGVsZW1lbnRzCiAgICAgICAgLy8gaW4gYEVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUoKWAuCiAgICAgICAgdGhpcy5yZW5kZXJQb3J0cygpOwogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUudXBkYXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHJlbmRlclBvcnRzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyICRpblBvcnRzID0gdGhpcy4kKCcuaW5Qb3J0cycpLmVtcHR5KCk7CiAgICAgICAgdmFyICRvdXRQb3J0cyA9IHRoaXMuJCgnLm91dFBvcnRzJykuZW1wdHkoKTsKCiAgICAgICAgdmFyIHBvcnRUZW1wbGF0ZSA9IF8udGVtcGxhdGUodGhpcy5tb2RlbC5wb3J0TWFya3VwKTsKCiAgICAgICAgXy5lYWNoKF8uZmlsdGVyKHRoaXMubW9kZWwucG9ydHMsIGZ1bmN0aW9uKHApIHsgcmV0dXJuIHAudHlwZSA9PT0gJ2luJyB9KSwgZnVuY3Rpb24ocG9ydCwgaW5kZXgpIHsKCiAgICAgICAgICAgICRpblBvcnRzLmFwcGVuZChWKHBvcnRUZW1wbGF0ZSh7IGlkOiBpbmRleCwgcG9ydDogcG9ydCB9KSkubm9kZSk7CiAgICAgICAgfSk7CiAgICAgICAgXy5lYWNoKF8uZmlsdGVyKHRoaXMubW9kZWwucG9ydHMsIGZ1bmN0aW9uKHApIHsgcmV0dXJuIHAudHlwZSA9PT0gJ291dCcgfSksIGZ1bmN0aW9uKHBvcnQsIGluZGV4KSB7CgogICAgICAgICAgICAkb3V0UG9ydHMuYXBwZW5kKFYocG9ydFRlbXBsYXRlKHsgaWQ6IGluZGV4LCBwb3J0OiBwb3J0IH0pKS5ub2RlKTsKICAgICAgICB9KTsKICAgIH0KfTsKCmpvaW50LnNoYXBlcy5iYXNpYy5UZXh0QmxvY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogWyc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0Lz48L2c+PHN3aXRjaD4nLAoKICAgICAgICAgICAgIC8vIGlmIGZvcmVpZ25PYmplY3Qgc3VwcG9ydGVkCgogICAgICAgICAgICAgJzxmb3JlaWduT2JqZWN0IHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgY2xhc3M9ImZvYmoiPicsCiAgICAgICAgICAgICAnPGJvZHkgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiPjxkaXYvPjwvYm9keT4nLAogICAgICAgICAgICAgJzwvZm9yZWlnbk9iamVjdD4nLAoKICAgICAgICAgICAgIC8vIGVsc2UgZm9yZWlnbk9iamVjdCBpcyBub3Qgc3VwcG9ydGVkIChmYWxsYmFjayBmb3IgSUUpCiAgICAgICAgICAgICAnPHRleHQgY2xhc3M9ImNvbnRlbnQiLz4nLAoKICAgICAgICAgICAgICc8L3N3aXRjaD48L2c+J10uam9pbignJyksCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnYmFzaWMuVGV4dEJsb2NrJywKCiAgICAgICAgLy8gc2VlIGpvaW50LmNzcyBmb3IgbW9yZSBlbGVtZW50IHN0eWxlcwogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHJlY3Q6IHsKICAgICAgICAgICAgICAgIGZpbGw6ICcjZmZmZmZmJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJyMwMDAwMDAnLAogICAgICAgICAgICAgICAgd2lkdGg6IDgwLAogICAgICAgICAgICAgICAgaGVpZ2h0OiAxMDAKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgZmlsbDogJyMwMDAwMDAnLAogICAgICAgICAgICAgICAgJ2ZvbnQtc2l6ZSc6IDE0LAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsLCBoZWx2ZXRpY2EsIHNhbnMtc2VyaWYnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuY29udGVudCc6IHsKICAgICAgICAgICAgICAgIHRleHQ6ICcnLAogICAgICAgICAgICAgICAgcmVmOiAncmVjdCcsCiAgICAgICAgICAgICAgICAncmVmLXgnOiAuNSwKICAgICAgICAgICAgICAgICdyZWYteSc6IC41LAogICAgICAgICAgICAgICAgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgY29udGVudDogJycKCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpLAoKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZiAodHlwZW9mIFNWR0ZvcmVpZ25PYmplY3RFbGVtZW50ICE9PSAndW5kZWZpbmVkJykgewoKICAgICAgICAgICAgLy8gZm9yZWlnbk9iamVjdCBzdXBwb3J0ZWQKICAgICAgICAgICAgdGhpcy5zZXRGb3JlaWduT2JqZWN0U2l6ZSh0aGlzLCB0aGlzLmdldCgnc2l6ZScpKTsKICAgICAgICAgICAgdGhpcy5zZXREaXZDb250ZW50KHRoaXMsIHRoaXMuZ2V0KCdjb250ZW50JykpOwogICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMsICdjaGFuZ2U6c2l6ZScsIHRoaXMuc2V0Rm9yZWlnbk9iamVjdFNpemUpOwogICAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMsICdjaGFuZ2U6Y29udGVudCcsIHRoaXMuc2V0RGl2Q29udGVudCk7CgogICAgICAgIH0KCiAgICAgICAgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgc2V0Rm9yZWlnbk9iamVjdFNpemU6IGZ1bmN0aW9uKGNlbGwsIHNpemUpIHsKCiAgICAgICAgLy8gU2VsZWN0b3IgYGZvcmVpZ25PYmplY3QnIGRvZXNuJ3Qgd29yayBhY2Nyb3NzIGFsbCBicm93c2Vycywgd2UnciB1c2luZyBjbGFzcyBzZWxlY3RvciBpbnN0ZWFkLgogICAgICAgIC8vIFdlIGhhdmUgdG8gY2xvbmUgc2l6ZSBhcyB3ZSBkb24ndCB3YW50IGF0dHJpYnV0ZXMuZGl2LnN0eWxlIHRvIGJlIHNhbWUgb2JqZWN0IGFzIGF0dHJpYnV0ZXMuc2l6ZS4KICAgICAgICBjZWxsLmF0dHIoewogICAgICAgICAgICAnLmZvYmonOiBfLmNsb25lKHNpemUpLAogICAgICAgICAgICBkaXY6IHsgc3R5bGU6IF8uY2xvbmUoc2l6ZSkgfQogICAgICAgIH0pOwogICAgfSwKCiAgICBzZXREaXZDb250ZW50OiBmdW5jdGlvbihjZWxsLCBjb250ZW50KSB7CgogICAgICAgIC8vIEFwcGVuZCB0aGUgY29udGVudCB0byBkaXYgYXMgaHRtbC4KICAgICAgICBjZWxsLmF0dHIoeyBkaXYgOiB7CiAgICAgICAgICAgIGh0bWw6IGNvbnRlbnQKICAgICAgICB9fSk7CiAgICB9Cgp9KTsKCi8vIFRleHRCbG9ja1ZpZXcgaW1wbGVtZW50cyB0aGUgZmFsbGJhY2sgZm9yIElFIHdoZW4gbm8gZm9yZWlnbk9iamVjdCBleGlzdHMgYW5kCi8vIHRoZSB0ZXh0IG5lZWRzIHRvIGJlIG1hbnVhbGx5IGJyb2tlbi4Kam9pbnQuc2hhcGVzLmJhc2ljLlRleHRCbG9ja1ZpZXcgPSBqb2ludC5kaWEuRWxlbWVudFZpZXcuZXh0ZW5kKHsKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICAgIGlmICh0eXBlb2YgU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQgPT09ICd1bmRlZmluZWQnKSB7CgogICAgICAgICAgICB0aGlzLm5vU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQgPSB0cnVlOwoKICAgICAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCAnY2hhbmdlOmNvbnRlbnQnLCBmdW5jdGlvbihjZWxsKSB7CiAgICAgICAgICAgICAgICAvLyBhdm9pZGluZyBwYXNzIG9mIGV4dHJhIHBhcmFtdGVycwogICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb250ZW50KGNlbGwpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZTogZnVuY3Rpb24oY2VsbCwgcmVuZGVyaW5nT25seUF0dHJzKSB7CgogICAgICAgIGlmICh0aGlzLm5vU1ZHRm9yZWlnbk9iamVjdEVsZW1lbnQpIHsKCiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMubW9kZWw7CgogICAgICAgICAgICAvLyBVcGRhdGUgZXZlcnl0aGluZyBidXQgdGhlIGNvbnRlbnQgZmlyc3QuCiAgICAgICAgICAgIHZhciBub1RleHRBdHRycyA9IF8ub21pdChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgbW9kZWwuZ2V0KCdhdHRycycpLCAnLmNvbnRlbnQnKTsKICAgICAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBtb2RlbCwgbm9UZXh0QXR0cnMpOwoKICAgICAgICAgICAgaWYgKCFyZW5kZXJpbmdPbmx5QXR0cnMgfHwgXy5oYXMocmVuZGVyaW5nT25seUF0dHJzLCAnLmNvbnRlbnQnKSkgewogICAgICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjb250ZW50IGl0c2VsZi4KICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQ29udGVudChtb2RlbCwgcmVuZGVyaW5nT25seUF0dHJzKTsKICAgICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBtb2RlbCwgcmVuZGVyaW5nT25seUF0dHJzKTsKICAgICAgICB9CiAgICB9LAoKICAgIHVwZGF0ZUNvbnRlbnQ6IGZ1bmN0aW9uKGNlbGwsIHJlbmRlcmluZ09ubHlBdHRycykgewoKICAgICAgICAvLyBDcmVhdGUgY29weSBvZiB0aGUgdGV4dCBhdHRyaWJ1dGVzCiAgICAgICAgdmFyIHRleHRBdHRycyA9IF8ubWVyZ2Uoe30sIChyZW5kZXJpbmdPbmx5QXR0cnMgfHwgY2VsbC5nZXQoJ2F0dHJzJykpWycuY29udGVudCddKTsKCiAgICAgICAgZGVsZXRlIHRleHRBdHRycy50ZXh0OwoKICAgICAgICAvLyBCcmVhayB0aGUgY29udGVudCB0byBmaXQgdGhlIGVsZW1lbnQgc2l6ZSB0YWtpbmcgaW50byBhY2NvdW50IHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgLy8gc2V0IG9uIHRoZSBtb2RlbC4KICAgICAgICB2YXIgdGV4dCA9IGpvaW50LnV0aWwuYnJlYWtUZXh0KGNlbGwuZ2V0KCdjb250ZW50JyksIGNlbGwuZ2V0KCdzaXplJyksIHRleHRBdHRycywgewogICAgICAgICAgICAvLyBtZWFzdXJpbmcgc2FuZGJveCBzdmcgZG9jdW1lbnQKICAgICAgICAgICAgc3ZnRG9jdW1lbnQ6IHRoaXMucGFwZXIuc3ZnCiAgICAgICAgfSk7CgogICAgICAgIC8vIENyZWF0ZSBhIG5ldyBhdHRycyB3aXRoIHNhbWUgc3RydWN0dXJlIGFzIHRoZSBtb2RlbCBhdHRycyB7IHRleHQ6IHsgKnRleHRBdHRyaWJ1dGVzKiB9fQogICAgICAgIHZhciBhdHRycyA9IGpvaW50LnV0aWwuc2V0QnlQYXRoKHt9LCAnLmNvbnRlbnQnLCB0ZXh0QXR0cnMsJy8nKTsKCiAgICAgICAgLy8gUmVwbGFjZSB0ZXh0IGF0dHJpYnV0ZSB3aXRoIHRoZSBvbmUgd2UganVzdCBwcm9jZXNzZWQuCiAgICAgICAgYXR0cnNbJy5jb250ZW50J10udGV4dCA9IHRleHQ7CgogICAgICAgIC8vIFVwZGF0ZSB0aGUgdmlldyB1c2luZyByZW5kZXJpbmdPbmx5QXR0cmlidXRlcyBwYXJhbWV0ZXIuCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS51cGRhdGUuY2FsbCh0aGlzLCBjZWxsLCBhdHRycyk7CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLmJhc2ljOwp9Cgpqb2ludC5yb3V0ZXJzLm9ydGhvZ29uYWwgPSBmdW5jdGlvbigpIHsKCiAgICB2YXIgc291cmNlQkJveCwgdGFyZ2V0QkJveDsKCiAgICAvLyBSZXR1cm4gdGhlIGRpcmVjdGlvbiB0aGF0IG9uZSB3b3VsZCBoYXZlIHRvIHRha2UgdHJhdmVsaW5nIGZyb20gYHAxYCB0byBgcDJgLgogICAgLy8gVGhpcyBmdW5jdGlvbiBhc3N1bWVzIHRoZSBsaW5lIGJldHdlZW4gYHAxYCBhbmQgYHAyYCBpcyBvcnRob2dvbmFsLgogICAgZnVuY3Rpb24gZGlyZWN0aW9uKHAxLCBwMikgewogICAgICAgIAogICAgICAgIGlmIChwMS55IDwgcDIueSAmJiBwMS54ID09PSBwMi54KSB7CiAgICAgICAgICAgIHJldHVybiAnZG93bic7CiAgICAgICAgfSBlbHNlIGlmIChwMS55ID4gcDIueSAmJiBwMS54ID09PSBwMi54KSB7CiAgICAgICAgICAgIHJldHVybiAndXAnOwogICAgICAgIH0gZWxzZSBpZiAocDEueCA8IHAyLnggJiYgcDEueSA9PT0gcDIueSkgewogICAgICAgICAgICByZXR1cm4gJ3JpZ2h0JzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICdsZWZ0JzsKICAgIH0KCiAgICBmdW5jdGlvbiBiZXN0RGlyZWN0aW9uKHAxLCBwMiwgcHJlZmVycmVkRGlyZWN0aW9uKSB7CgogICAgICAgIHZhciBkaXJlY3Rpb25zOwoKICAgICAgICAvLyBUaGlzIGJyYW5jaGluZyBkZXRlcm1pbmVzIHBvc3NpYmxlIGRpcmVjdGlvbnMgdGhhdCBvbmUgY2FuIHRha2UgdG8gdHJhdmVsCiAgICAgICAgLy8gZnJvbSBgcDFgIHRvIGBwMmAuCiAgICAgICAgaWYgKHAxLnggPCBwMi54KSB7CgogICAgICAgICAgICBpZiAocDEueSA+IHAyLnkpIHsgZGlyZWN0aW9ucyA9IFsndXAnLCAncmlnaHQnXTsgfQogICAgICAgICAgICBlbHNlIGlmIChwMS55IDwgcDIueSkgeyBkaXJlY3Rpb25zID0gWydkb3duJywgJ3JpZ2h0J107IH0KICAgICAgICAgICAgZWxzZSB7IGRpcmVjdGlvbnMgPSBbJ3JpZ2h0J107IH0KCiAgICAgICAgfSBlbHNlIGlmIChwMS54ID4gcDIueCkgewoKICAgICAgICAgICAgaWYgKHAxLnkgPiBwMi55KSB7IGRpcmVjdGlvbnMgPSBbJ3VwJywgJ2xlZnQnXTsgfQogICAgICAgICAgICBlbHNlIGlmIChwMS55IDwgcDIueSkgeyBkaXJlY3Rpb25zID0gWydkb3duJywgJ2xlZnQnXTsgfQogICAgICAgICAgICBlbHNlIHsgZGlyZWN0aW9ucyA9IFsnbGVmdCddOyB9CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAocDEueSA+IHAyLnkpIHsgZGlyZWN0aW9ucyA9IFsndXAnXTsgfQogICAgICAgICAgICBlbHNlIHsgZGlyZWN0aW9ucyA9IFsnZG93biddOyB9CiAgICAgICAgfQoKICAgICAgICBpZiAoXy5jb250YWlucyhkaXJlY3Rpb25zLCBwcmVmZXJyZWREaXJlY3Rpb24pKSB7CiAgICAgICAgICAgIHJldHVybiBwcmVmZXJyZWREaXJlY3Rpb247CiAgICAgICAgfQoKICAgICAgICB2YXIgZGlyZWN0aW9uID0gXy5maXJzdChkaXJlY3Rpb25zKTsKCiAgICAgICAgLy8gU2hvdWxkIHRoZSBkaXJlY3Rpb24gYmUgdGhlIGV4YWN0IG9wcG9zaXRlIG9mIHRoZSBwcmVmZXJyZWQgZGlyZWN0aW9uLAogICAgICAgIC8vIHRyeSBhbm90aGVyIG9uZSBpZiBzdWNoIGRpcmVjdGlvbiBleGlzdHMuCiAgICAgICAgc3dpdGNoIChwcmVmZXJyZWREaXJlY3Rpb24pIHsKICAgICAgICBjYXNlICdkb3duJzogaWYgKGRpcmVjdGlvbiA9PT0gJ3VwJykgcmV0dXJuIF8ubGFzdChkaXJlY3Rpb25zKTsgYnJlYWs7CiAgICAgICAgY2FzZSAndXAnOiBpZiAoZGlyZWN0aW9uID09PSAnZG93bicpIHJldHVybiBfLmxhc3QoZGlyZWN0aW9ucyk7IGJyZWFrOwogICAgICAgIGNhc2UgJ2xlZnQnOiBpZiAoZGlyZWN0aW9uID09PSAncmlnaHQnKSByZXR1cm4gXy5sYXN0KGRpcmVjdGlvbnMpOyBicmVhazsKICAgICAgICBjYXNlICdyaWdodCc6IGlmIChkaXJlY3Rpb24gPT09ICdsZWZ0JykgcmV0dXJuIF8ubGFzdChkaXJlY3Rpb25zKTsgYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJldHVybiBkaXJlY3Rpb247CiAgICB9OwoKICAgIC8vIEZpbmQgYSB2ZXJ0ZXggaW4gYmV0d2VlbiB0aGUgdmVydGljZXMgYHAxYCBhbmQgYHAyYCBzbyB0aGF0IHRoZSByb3V0ZSBiZXR3ZWVuIHRob3NlIHZlcnRpY2VzCiAgICAvLyBpcyBvcnRob2dvbmFsLiBQcmVmZXIgZ29pbmcgdGhlIGRpcmVjdGlvbiBkZXRlcm1pbmVkIGJ5IGBwcmVmZXJyZWREaXJlY3Rpb25gLgogICAgZnVuY3Rpb24gZmluZE1pZGRsZVZlcnRleChwMSwgcDIsIHByZWZlcnJlZERpcmVjdGlvbikgewogICAgICAgIAogICAgICAgIHZhciBkaXJlY3Rpb24gPSBiZXN0RGlyZWN0aW9uKHAxLCBwMiwgcHJlZmVycmVkRGlyZWN0aW9uKTsKICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAnZG93bicgfHwgZGlyZWN0aW9uID09PSAndXAnKSB7CiAgICAgICAgICAgIHJldHVybiB7IHg6IHAxLngsIHk6IHAyLnksIGQ6IGRpcmVjdGlvbiB9OwogICAgICAgIH0KICAgICAgICByZXR1cm4geyB4OiBwMi54LCB5OiBwMS55LCBkOiBkaXJlY3Rpb24gfTsKICAgIH0KCiAgICAvLyBSZXR1cm4gcG9pbnRzIHRoYXQgb25lIG5lZWRzIHRvIGRyYXcgYSBjb25uZWN0aW9uIHRocm91Z2ggaW4gb3JkZXIgdG8gaGF2ZSBhIG9ydGhvZ29uYWwgbGluawogICAgLy8gcm91dGluZyBmcm9tIHNvdXJjZSB0byB0YXJnZXQgZ29pbmcgdGhyb3VnaCBgdmVydGljZXNgLgogICAgZnVuY3Rpb24gZmluZE9ydGhvZ29uYWxSb3V0ZSh2ZXJ0aWNlcykgewoKICAgICAgICB2ZXJ0aWNlcyA9ICh2ZXJ0aWNlcyB8fCBbXSkuc2xpY2UoKTsKICAgICAgICB2YXIgb3J0aG9nb25hbFZlcnRpY2VzID0gW107CgogICAgICAgIHZhciBzb3VyY2VDZW50ZXIgPSBzb3VyY2VCQm94LmNlbnRlcigpOwogICAgICAgIHZhciB0YXJnZXRDZW50ZXIgPSB0YXJnZXRCQm94LmNlbnRlcigpOwoKICAgICAgICBpZiAoIXZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNvdXJjZUNlbnRlci54IC0gdGFyZ2V0Q2VudGVyLngpIDwgKHNvdXJjZUJCb3gud2lkdGggLyAyKSB8fAogICAgICAgICAgICAgICAgTWF0aC5hYnMoc291cmNlQ2VudGVyLnkgLSB0YXJnZXRDZW50ZXIueSkgPCAoc291cmNlQkJveC5oZWlnaHQgLyAyKQogICAgICAgICAgICApIHsKCiAgICAgICAgICAgICAgICB2ZXJ0aWNlcyA9IFt7CiAgICAgICAgICAgICAgICAgICAgeDogTWF0aC5taW4oc291cmNlQ2VudGVyLngsIHRhcmdldENlbnRlci54KSArCiAgICAgICAgICAgICAgICAgICAgICAgIE1hdGguYWJzKHNvdXJjZUNlbnRlci54IC0gdGFyZ2V0Q2VudGVyLngpIC8gMiwKICAgICAgICAgICAgICAgICAgICB5OiBNYXRoLm1pbihzb3VyY2VDZW50ZXIueSwgdGFyZ2V0Q2VudGVyLnkpICsKICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5hYnMoc291cmNlQ2VudGVyLnkgLSB0YXJnZXRDZW50ZXIueSkgLyAyCiAgICAgICAgICAgICAgICB9XTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmVydGljZXMudW5zaGlmdChzb3VyY2VDZW50ZXIpOwogICAgICAgIHZlcnRpY2VzLnB1c2godGFyZ2V0Q2VudGVyKTsKCiAgICAgICAgdmFyIG9ydGhvZ29uYWxWZXJ0ZXg7CiAgICAgICAgdmFyIGxhc3RPcnRob2dvbmFsVmVydGV4OwogICAgICAgIHZhciB2ZXJ0ZXg7CiAgICAgICAgdmFyIG5leHRWZXJ0ZXg7CgogICAgICAgIC8vIEZvciBhbGwgdGhlIHBhaXJzIG9mIGxpbmsgbW9kZWwgdmVydGljZXMuLi4KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZlcnRpY2VzLmxlbmd0aCAtIDE7IGkrKykgewoKICAgICAgICAgICAgdmVydGV4ID0gdmVydGljZXNbaV07CiAgICAgICAgICAgIG5leHRWZXJ0ZXggPSB2ZXJ0aWNlc1tpICsgMV07CiAgICAgICAgICAgIGxhc3RPcnRob2dvbmFsVmVydGV4ID0gXy5sYXN0KG9ydGhvZ29uYWxWZXJ0aWNlcyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoaSA+IDApIHsKICAgICAgICAgICAgICAgIC8vIFB1c2ggYWxsIHRoZSBsaW5rIHZlcnRpY2VzIHRvIHRoZSBvcnRob2dvbmFsIHJvdXRlLgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleCA9IHZlcnRleDsKICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBhIGRpcmVjdGlvbiBiZXR3ZWVuIHRoZSBsYXN0IHZlcnRleCBhbmQgdGhlIG5ldyBvbmUuCiAgICAgICAgICAgICAgICAvLyBUaGVyZWZvcmUsIGVhY2ggdmVydGV4IGNvbnRhaW5zIHRoZSBgZGAgcHJvcGVydHkgZGVzY3JpYmluZyB0aGUgZGlyZWN0aW9uIHRoYXQgb25lCiAgICAgICAgICAgICAgICAvLyB3b3VsZCBoYXZlIHRvIHRha2UgdG8gdHJhdmVsIHRvIHRoYXQgdmVydGV4LgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleC5kID0gbGFzdE9ydGhvZ29uYWxWZXJ0ZXgKICAgICAgICAgICAgICAgICAgICA/IGRpcmVjdGlvbihsYXN0T3J0aG9nb25hbFZlcnRleCwgdmVydGV4KQogICAgICAgICAgICAgICAgICAgIDogJ3RvcCc7CgogICAgICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRpY2VzLnB1c2gob3J0aG9nb25hbFZlcnRleCk7CiAgICAgICAgICAgICAgICBsYXN0T3J0aG9nb25hbFZlcnRleCA9IG9ydGhvZ29uYWxWZXJ0ZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlIGRvbid0IGNyZWF0ZSBhIHZlcnRleCB0aGF0IHdvdWxkIGdvIHRoZSBvcHBvc2l0ZSBkaXJlY3Rpb24gdGhlbgogICAgICAgICAgICAvLyB0aGF0IG9mIHRoZSBwcmV2aW91cyBvbmUuCiAgICAgICAgICAgIC8vIE90aHdlcndpc2UsIGEgJ3NwaWtlJyBzZWdtZW50IHdvdWxkIGJlIGNyZWF0ZWQgd2hpY2ggaXMgbm90IGRlc2lyYWJsZS4KICAgICAgICAgICAgLy8gRmluZCBhIGR1bW15IHZlcnRleCB0byBrZWVwIHRoZSBsaW5rIG9ydGhvZ29uYWwuIFByZWZlcmFibHksIHRha2UgdGhlIHNhbWUgZGlyZWN0aW9uCiAgICAgICAgICAgIC8vIGFzIHRoZSBwcmV2aW91cyBvbmUuCiAgICAgICAgICAgIHZhciBkID0gbGFzdE9ydGhvZ29uYWxWZXJ0ZXggJiYgbGFzdE9ydGhvZ29uYWxWZXJ0ZXguZDsKICAgICAgICAgICAgb3J0aG9nb25hbFZlcnRleCA9IGZpbmRNaWRkbGVWZXJ0ZXgodmVydGV4LCBuZXh0VmVydGV4LCBkKTsKCiAgICAgICAgICAgIC8vIERvIG5vdCBhZGQgYSBuZXcgdmVydGV4IHRoYXQgaXMgdGhlIHNhbWUgYXMgb25lIG9mIHRoZSB2ZXJ0aWNlcyBhbHJlYWR5IGFkZGVkLgogICAgICAgICAgICBpZiAoIWcucG9pbnQob3J0aG9nb25hbFZlcnRleCkuZXF1YWxzKGcucG9pbnQodmVydGV4KSkgJiYKICAgICAgICAgICAgICAgICFnLnBvaW50KG9ydGhvZ29uYWxWZXJ0ZXgpLmVxdWFscyhnLnBvaW50KG5leHRWZXJ0ZXgpKSkgewoKICAgICAgICAgICAgICAgIG9ydGhvZ29uYWxWZXJ0aWNlcy5wdXNoKG9ydGhvZ29uYWxWZXJ0ZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBvcnRob2dvbmFsVmVydGljZXM7CiAgICB9OwoKICAgIHJldHVybiBmdW5jdGlvbih2ZXJ0aWNlcykgewoKICAgICAgICBzb3VyY2VCQm94ID0gdGhpcy5zb3VyY2VCQm94OwogICAgICAgIHRhcmdldEJCb3ggPSB0aGlzLnRhcmdldEJCb3g7CgogICAgICAgIHJldHVybiBmaW5kT3J0aG9nb25hbFJvdXRlKHZlcnRpY2VzKTsKICAgIH07Cgp9KCk7Cgpqb2ludC5yb3V0ZXJzLm1hbmhhdHRhbiA9IChmdW5jdGlvbigpIHsKCiAgICAndXNlIHN0cmljdCc7CgogICAgdmFyIGNvbmZpZyA9IHsKCiAgICAgICAgLy8gc2l6ZSBvZiB0aGUgc3RlcCB0byBmaW5kIGEgcm91dGUKICAgICAgICBzdGVwOiAxMCwKCiAgICAgICAgLy8gdXNlIG9mIHRoZSBwZXJwZW5kaWN1bGFyIGxpbmtWaWV3IG9wdGlvbiB0byBjb25uZWN0IGNlbnRlciBvZiBlbGVtZW50IHdpdGggZmlyc3QgdmVydGV4CiAgICAgICAgcGVycGVuZGljdWxhcjogdHJ1ZSwKCiAgICAgICAgLy8gdGVsbHMgaG93IHRvIGRpdmlkZSB0aGUgcGFwZXIgd2hlbiBjcmVhdGluZyB0aGUgZWxlbWVudHMgbWFwCiAgICAgICAgbWFwR3JpZFNpemU6IDEwMCwKCiAgICAgICAgLy8gc2hvdWxkIGJlIHNvdXJjZSBvciB0YXJnZXQgbm90IHRvIGJlIGNvbnNpZGVyIGFzIGFuIG9ic3RhY2xlCiAgICAgICAgZXhjbHVkZUVuZHM6IFtdLCAvLyAnc291cmNlJywgJ3RhcmdldCcKCiAgICAgICAgLy8gc2hvdWxkIGJlIGFueSBlbGVtZW50IHdpdGggYSBjZXJ0YWluIHR5cGUgbm90IHRvIGJlIGNvbnNpZGVyIGFzIGFuIG9ic3RhY2xlCiAgICAgICAgZXhjbHVkZVR5cGVzOiBbJ2Jhc2ljLlRleHQnXSwKCiAgICAgICAgLy8gaWYgbnVtYmVyIG9mIHJvdXRlIGZpbmRpbmcgbG9vcHMgZXhjZWVkIHRoZSBtYXhpbXVtLCBzdG9wcyBzZWFyY2hpbmcgYW5kIHJldHVybnMKICAgICAgICAvLyBmYWxsYmFjayByb3V0ZQogICAgICAgIG1heGltdW1Mb29wczogNTAwLAoKICAgICAgICAvLyBwb3NzaWJsZSBzdGFydGluZyBkaXJlY3Rpb25zIGZyb20gYW4gZWxlbWVudAogICAgICAgIHN0YXJ0RGlyZWN0aW9uczogWydsZWZ0JywncmlnaHQnLCd0b3AnLCdib3R0b20nXSwKCiAgICAgICAgLy8gcG9zc2libGUgZW5kaW5nIGRpcmVjdGlvbnMgdG8gYW4gZWxlbWVudAogICAgICAgIGVuZERpcmVjdGlvbnM6IFsnbGVmdCcsJ3JpZ2h0JywndG9wJywnYm90dG9tJ10sCgogICAgICAgIC8vIHNwZWNpZnkgZGlyZWN0aW9ucyBhYm92ZQogICAgICAgIGRpcmVjdGlvbk1hcDogewogICAgICAgICAgICByaWdodDogeyB4OiAxLCB5OiAwIH0sCiAgICAgICAgICAgIGJvdHRvbTogeyB4OiAwLCB5OiAxIH0sCiAgICAgICAgICAgIGxlZnQ6IHsgeDogLTEsIHk6IDAgfSwKICAgICAgICAgICAgdG9wOiB7IHg6IDAsIHk6IC0xIH0KICAgICAgICB9LAoKICAgICAgICAvLyBtYXhpbXVtIGNoYW5nZSBvZiB0aGUgZGlyZWN0aW9uCiAgICAgICAgbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZTogMSwKCiAgICAgICAgLy8gcGFkZGluZyBhcHBsaWVkIG9uIHRoZSBlbGVtZW50IGJvdW5kaW5nIGJveGVzCiAgICAgICAgcGFkZGluZ0JveDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc3RlcCA9IHRoaXMuc3RlcDsKCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB4OiAtc3RlcCwKICAgICAgICAgICAgICAgIHk6IC1zdGVwLAogICAgICAgICAgICAgICAgd2lkdGg6IDIqc3RlcCwKICAgICAgICAgICAgICAgIGhlaWdodDogMipzdGVwCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBhbiBhcnJheSBvZiBkaXJlY3Rpb25zIHRvIGZpbmQgbmV4dCBwb2ludHMgb24gdGhlIHJvdXRlCiAgICAgICAgZGlyZWN0aW9uczogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB2YXIgc3RlcCA9IHRoaXMuc3RlcDsKCiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IHN0ZXAgICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogc3RlcCAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IC1zdGVwICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogLXN0ZXAgLCBjb3N0OiBzdGVwIH0KICAgICAgICAgICAgXTsKICAgICAgICB9LAoKICAgICAgICAvLyBhIHBlbmFsdHkgcmVjZWl2ZWQgZm9yIGRpcmVjdGlvbiBjaGFuZ2UKICAgICAgICBwZW5hbHRpZXM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgcmV0dXJuIFswLCB0aGlzLnN0ZXAgLyAyLCB0aGlzLnN0ZXBdOwogICAgICAgIH0sCgogICAgICAgIC8vIGhldXJlc3RpYyBtZXRob2QgdG8gZGV0ZXJtaW5lIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byBwb2ludHMKICAgICAgICBlc3RpbWF0ZUNvc3Q6IGZ1bmN0aW9uKGZyb20sIHRvKSB7CgogICAgICAgICAgICByZXR1cm4gZnJvbS5tYW5oYXR0YW5EaXN0YW5jZSh0byk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gYSBzaW1wbGUgcm91dGUgdXNlZCBpbiBzaXR1YXRpb25zLCB3aGVuIG1haW4gcm91dGluZyBtZXRob2QgZmFpbHMKICAgICAgICAvLyAoZXhjZWVkIGxvb3BzLCBpbmFjY2Vzc2libGUpLgogICAgICAgIGZhbGxiYWNrUm91dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7CgogICAgICAgICAgICAvLyBGaW5kIGFuIG9ydGhvZ29uYWwgcm91dGUgaWdub3Jpbmcgb2JzdGFjbGVzLgoKICAgICAgICAgICAgdmFyIHByZXZEaXJJbmRleGVzID0gb3B0cy5wcmV2RGlySW5kZXhlcyB8fCB7fTsKCiAgICAgICAgICAgIHZhciBwb2ludCA9IChwcmV2RGlySW5kZXhlc1tmcm9tXSB8fCAwKSAlIDIKICAgICAgICAgICAgICAgICAgICA/IGcucG9pbnQoZnJvbS54LCB0by55KQogICAgICAgICAgICAgICAgICAgIDogZy5wb2ludCh0by54LCBmcm9tLnkpOwoKICAgICAgICAgICAgcmV0dXJuIFtwb2ludCwgdG9dOwogICAgICAgIH0sCgogICAgICAgIC8vIGlmIGEgZnVuY3Rpb24gaXMgcHJvdmlkZWQsIGl0J3MgdXNlZCB0byByb3V0ZSB0aGUgbGluayB3aGlsZSBkcmFnZ2luZyBhbiBlbmQKICAgICAgICAvLyBpLmUuIGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7IHJldHVybiBbXTsgfQogICAgICAgIGRyYWdnaW5nUm91dGU6IG51bGwKICAgIH07CgogICAgLy8gcmVjb25zdHJ1Y3RzIGEgcm91dGUgYnkgY29uY2F0aW5nIHBvaW50cyB3aXRoIHRoZWlyIHBhcmVudHMKICAgIGZ1bmN0aW9uIHJlY29uc3RydWN0Um91dGUocGFyZW50cywgcG9pbnQpIHsKCiAgICAgICAgdmFyIHJvdXRlID0gW107CiAgICAgICAgdmFyIHByZXZEaWZmID0geyB4OiAwLCB5OiAwIH07CiAgICAgICAgdmFyIGN1cnJlbnQgPSBwb2ludDsKICAgICAgICB2YXIgcGFyZW50OwoKICAgICAgICB3aGlsZSAoKHBhcmVudCA9IHBhcmVudHNbY3VycmVudF0pKSB7CgogICAgICAgICAgICB2YXIgZGlmZiA9IHBhcmVudC5kaWZmZXJlbmNlKGN1cnJlbnQpOwoKICAgICAgICAgICAgaWYgKCFkaWZmLmVxdWFscyhwcmV2RGlmZikpIHsKCiAgICAgICAgICAgICAgICByb3V0ZS51bnNoaWZ0KGN1cnJlbnQpOwogICAgICAgICAgICAgICAgcHJldkRpZmYgPSBkaWZmOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjdXJyZW50ID0gcGFyZW50OwogICAgICAgIH0KCiAgICAgICAgcm91dGUudW5zaGlmdChjdXJyZW50KTsKCiAgICAgICAgcmV0dXJuIHJvdXRlOwogICAgfTsKCiAgICAvLyBmaW5kIHBvaW50cyBhcm91bmQgdGhlIHJlY3RhbmdsZSB0YWtpbmcgZ2l2ZW4gZGlyZWN0aW9ucyBpbiB0aGUgYWNjb3VudAogICAgZnVuY3Rpb24gZ2V0UmVjdFBvaW50cyhiYm94LCBkaXJlY3Rpb25MaXN0LCBvcHRzKSB7CgogICAgICAgIHZhciBzdGVwID0gb3B0cy5zdGVwOwoKICAgICAgICB2YXIgY2VudGVyID0gYmJveC5jZW50ZXIoKTsKCiAgICAgICAgdmFyIHN0YXJ0UG9pbnRzID0gXy5jaGFpbihvcHRzLmRpcmVjdGlvbk1hcCkucGljayhkaXJlY3Rpb25MaXN0KS5tYXAoZnVuY3Rpb24oZGlyZWN0aW9uKSB7CgogICAgICAgICAgICB2YXIgeCA9IGRpcmVjdGlvbi54ICogYmJveC53aWR0aCAvIDI7CiAgICAgICAgICAgIHZhciB5ID0gZGlyZWN0aW9uLnkgKiBiYm94LmhlaWdodCAvIDI7CgogICAgICAgICAgICB2YXIgcG9pbnQgPSBnLnBvaW50KGNlbnRlcikub2Zmc2V0KHgseSkuc25hcFRvR3JpZChzdGVwKTsKCiAgICAgICAgICAgIGlmIChiYm94LmNvbnRhaW5zUG9pbnQocG9pbnQpKSB7CgogICAgICAgICAgICAgICAgcG9pbnQub2Zmc2V0KGRpcmVjdGlvbi54ICogc3RlcCwgZGlyZWN0aW9uLnkgKiBzdGVwKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBvaW50OwoKICAgICAgICB9KS52YWx1ZSgpOwoKICAgICAgICByZXR1cm4gc3RhcnRQb2ludHM7CiAgICB9OwoKICAgIC8vIHJldHVybnMgYSBkaXJlY3Rpb24gaW5kZXggZnJvbSBzdGFydCBwb2ludCB0byBlbmQgcG9pbnQKICAgIGZ1bmN0aW9uIGdldERpcmVjdGlvbihzdGFydCwgZW5kLCBkaXJMZW4pIHsKCiAgICAgICAgdmFyIGRpckFuZ2xlID0gMzYwIC8gZGlyTGVuOwoKICAgICAgICB2YXIgcSA9IE1hdGguZmxvb3Ioc3RhcnQudGhldGEoZW5kKSAvIGRpckFuZ2xlKTsKCiAgICAgICAgcmV0dXJuIGRpckxlbiAtIHE7CiAgICB9CgogICAgLy8gZmluZHMgdGhlIHJvdXRlIGJldHdlZW4gdG8gcG9pbnRzL3JlY3RhbmdsZXMgaW1wbGVtZW50aW5nIEEqIGFsZ2hvcml0bQogICAgZnVuY3Rpb24gZmluZFJvdXRlKHN0YXJ0LCBlbmQsIG1hcCwgb3B0KSB7CgogICAgICAgIHZhciBzdGFydERpcmVjdGlvbnMgPSBvcHQucmV2ZXJzZWQgPyBvcHQuZW5kRGlyZWN0aW9ucyA6IG9wdC5zdGFydERpcmVjdGlvbnM7CiAgICAgICAgdmFyIGVuZERpcmVjdGlvbnMgPSBvcHQucmV2ZXJzZWQgPyBvcHQuc3RhcnREaXJlY3Rpb25zIDogb3B0LmVuZERpcmVjdGlvbnM7CgogICAgICAgIC8vIHNldCBvZiBwb2ludHMgd2Ugc3RhcnQgcGF0aGZpbmRpbmcgZnJvbQogICAgICAgIHZhciBzdGFydFNldCA9IHN0YXJ0IGluc3RhbmNlb2YgZy5yZWN0CiAgICAgICAgICAgICAgICA/IGdldFJlY3RQb2ludHMoc3RhcnQsIHN0YXJ0RGlyZWN0aW9ucywgb3B0KQogICAgICAgICAgICAgICAgOiBbc3RhcnRdOwoKICAgICAgICAvLyBzZXQgb2YgcG9pbnRzIHdlIHdhbnQgdGhlIHBhdGhmaW5kaW5nIHRvIGZpbmlzaCBhdAogICAgICAgIHZhciBlbmRTZXQgPSBlbmQgaW5zdGFuY2VvZiBnLnJlY3QKICAgICAgICAgICAgICAgID8gZ2V0UmVjdFBvaW50cyhlbmQsIGVuZERpcmVjdGlvbnMsIG9wdCkKICAgICAgICAgICAgICAgIDogW2VuZF07CgogICAgICAgIHZhciBzdGFydENlbnRlciA9IHN0YXJ0U2V0Lmxlbmd0aCA+IDEgPyBzdGFydC5jZW50ZXIoKSA6IHN0YXJ0U2V0WzBdOwogICAgICAgIHZhciBlbmRDZW50ZXIgPSBlbmRTZXQubGVuZ3RoID4gMSA/IGVuZC5jZW50ZXIoKSA6IGVuZFNldFswXTsKCiAgICAgICAgLy8gdGFrZSBpbnRvIGFjY291bnQgIG9ubHkgYWNjZXNzaWJsZSBlbmQgcG9pbnRzCiAgICAgICAgdmFyIGVuZFBvaW50cyA9IF8uZmlsdGVyKGVuZFNldCwgZnVuY3Rpb24ocG9pbnQpIHsKCiAgICAgICAgICAgIHZhciBtYXBLZXkgPSBnLnBvaW50KHBvaW50KS5zbmFwVG9HcmlkKG9wdC5tYXBHcmlkU2l6ZSkudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIHZhciBhY2Nlc2libGUgPSBfLmV2ZXJ5KG1hcFttYXBLZXldLCBmdW5jdGlvbihvYnN0YWNsZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICFvYnN0YWNsZS5jb250YWluc1BvaW50KHBvaW50KTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gYWNjZXNpYmxlOwogICAgICAgIH0pOwoKCiAgICAgICAgaWYgKGVuZFBvaW50cy5sZW5ndGgpIHsKCiAgICAgICAgICAgIHZhciBzdGVwID0gb3B0LnN0ZXA7CiAgICAgICAgICAgIHZhciBwZW5hbHRpZXMgPSBvcHQucGVuYWx0aWVzOwoKICAgICAgICAgICAgLy8gY2hvb3NlIHRoZSBlbmQgcG9pbnQgd2l0aCB0aGUgc2hvcnRlc3QgZXN0aW1hdGVkIHBhdGggY29zdAogICAgICAgICAgICB2YXIgZW5kUG9pbnQgPSBfLmNoYWluKGVuZFBvaW50cykuaW52b2tlKCdzbmFwVG9HcmlkJywgc3RlcCkubWluKGZ1bmN0aW9uKHBvaW50KSB7CgogICAgICAgICAgICAgICAgcmV0dXJuIG9wdC5lc3RpbWF0ZUNvc3Qoc3RhcnRDZW50ZXIsIHBvaW50KTsKCiAgICAgICAgICAgIH0pLnZhbHVlKCk7CgogICAgICAgICAgICB2YXIgcGFyZW50cyA9IHt9OwogICAgICAgICAgICB2YXIgY29zdEZyb21TdGFydCA9IHt9OwogICAgICAgICAgICB2YXIgdG90YWxDb3N0ID0ge307CgogICAgICAgICAgICAvLyBkaXJlY3Rpb25zCiAgICAgICAgICAgIHZhciBkaXJzID0gb3B0LmRpcmVjdGlvbnM7CiAgICAgICAgICAgIHZhciBkaXJMZW4gPSBkaXJzLmxlbmd0aDsKICAgICAgICAgICAgdmFyIGRpckhhbGZMZW4gPSBkaXJMZW4gLyAyOwogICAgICAgICAgICB2YXIgZGlySW5kZXhlcyA9IG9wdC5wcmV2aW91c0RpckluZGV4ZXMgfHwge307CgogICAgICAgICAgICAvLyBUaGUgc2V0IG9mIHBvaW50IGFscmVhZHkgZXZhbHVhdGVkLgogICAgICAgICAgICB2YXIgY2xvc2VIYXNoID0ge307IC8vIGtlZXBzIG9ubHkgaW5mb3JtYXRpb24gd2hldGhlciBhIHBvaW50IHdhcyBldmFsdWF0ZWQnCgogICAgICAgICAgICAvLyBUaGUgc2V0IG9mIHRlbnRhdGl2ZSBwb2ludHMgdG8gYmUgZXZhbHVhdGVkLCBpbml0aWFsbHkgY29udGFpbmluZyB0aGUgc3RhcnQgcG9pbnRzCiAgICAgICAgICAgIHZhciBvcGVuSGFzaCA9IHt9OyAvLyBrZWVwcyBvbmx5IGluZm9ybWF0aW9uIHdoZXRoZXIgYSBwb2ludCBpcyB0byBiZSBldmFsdWF0ZWQnCiAgICAgICAgICAgIHZhciBvcGVuU2V0ID0gXy5jaGFpbihzdGFydFNldCkuaW52b2tlKCdzbmFwVG9HcmlkJywgc3RlcCkuZWFjaChmdW5jdGlvbihwb2ludCkgewoKICAgICAgICAgICAgICAgIHZhciBrZXkgPSBwb2ludC50b1N0cmluZygpOwoKICAgICAgICAgICAgICAgIGNvc3RGcm9tU3RhcnRba2V5XSA9IDA7IC8vIENvc3QgZnJvbSBzdGFydCBhbG9uZyBiZXN0IGtub3duIHBhdGguCiAgICAgICAgICAgICAgICB0b3RhbENvc3Rba2V5XSA9IG9wdC5lc3RpbWF0ZUNvc3QocG9pbnQsIGVuZFBvaW50KTsKICAgICAgICAgICAgICAgIGRpckluZGV4ZXNba2V5XSA9IGRpckluZGV4ZXNba2V5XSB8fCBnZXREaXJlY3Rpb24oc3RhcnRDZW50ZXIsIHBvaW50LCBkaXJMZW4pOwogICAgICAgICAgICAgICAgb3Blbkhhc2hba2V5XSA9IHRydWU7CgogICAgICAgICAgICB9KS5tYXAoZnVuY3Rpb24ocG9pbnQpIHsKCiAgICAgICAgICAgICAgICByZXR1cm4gcG9pbnQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgIH0pLnNvcnRCeShmdW5jdGlvbihwb2ludEtleSkgewoKICAgICAgICAgICAgICAgIHJldHVybiB0b3RhbENvc3RbcG9pbnRLZXldOwoKICAgICAgICAgICAgfSkudmFsdWUoKTsKCiAgICAgICAgICAgIHZhciBsb29wQ291bnRlciA9IG9wdC5tYXhpbXVtTG9vcHM7CgogICAgICAgICAgICB2YXIgbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZSA9IG9wdC5tYXhBbGxvd2VkRGlyZWN0aW9uQ2hhbmdlOwoKICAgICAgICAgICAgLy8gbWFpbiByb3V0ZSBmaW5kaW5nIGxvb3AKICAgICAgICAgICAgd2hpbGUgKG9wZW5TZXQubGVuZ3RoICYmIGxvb3BDb3VudGVyLS0pIHsKCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEtleSA9IG9wZW5TZXRbMF07CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFBvaW50ID0gZy5wb2ludChjdXJyZW50S2V5KTsKCiAgICAgICAgICAgICAgICBpZiAoZW5kUG9pbnQuZXF1YWxzKGN1cnJlbnRQb2ludCkpIHsKCiAgICAgICAgICAgICAgICAgICAgb3B0LnByZXZpb3VzRGlySW5kZXhlcyA9IF8ucGljayhkaXJJbmRleGVzLCBjdXJyZW50S2V5KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25zdHJ1Y3RSb3V0ZShwYXJlbnRzLCBjdXJyZW50UG9pbnQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBjdXJyZW50IGZyb20gdGhlIG9wZW4gbGlzdAogICAgICAgICAgICAgICAgb3BlblNldC5zcGxpY2UoMCwgMSk7CiAgICAgICAgICAgICAgICBvcGVuSGFzaFtuZWlnaGJvcktleV0gPSBudWxsOwoKICAgICAgICAgICAgICAgIC8vIGFkZCBjdXJyZW50IHRvIHRoZSBjbG9zZSBsaXN0CiAgICAgICAgICAgICAgICBjbG9zZUhhc2hbbmVpZ2hib3JLZXldID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB2YXIgY3VycmVudERpckluZGV4ID0gZGlySW5kZXhlc1tjdXJyZW50S2V5XTsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RGlzdCA9IGNvc3RGcm9tU3RhcnRbY3VycmVudEtleV07CgogICAgICAgICAgICAgICAgZm9yICh2YXIgZGlySW5kZXggPSAwOyBkaXJJbmRleCA8IGRpckxlbjsgZGlySW5kZXgrKykgewoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlyQ2hhbmdlID0gTWF0aC5hYnMoZGlySW5kZXggLSBjdXJyZW50RGlySW5kZXgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZGlyQ2hhbmdlID4gZGlySGFsZkxlbikgewoKICAgICAgICAgICAgICAgICAgICAgICAgZGlyQ2hhbmdlID0gZGlyTGVuIC0gZGlyQ2hhbmdlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGRpcmVjdGlvbiBjaGFuZ2VkIHJhcGlkbHkgZG9uJ3QgdXNlIHRoaXMgcG9pbnQKICAgICAgICAgICAgICAgICAgICBpZiAoZGlyQ2hhbmdlID4gbWF4QWxsb3dlZERpcmVjdGlvbkNoYW5nZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgZGlyID0gZGlyc1tkaXJJbmRleF07CgogICAgICAgICAgICAgICAgICAgIHZhciBuZWlnaGJvclBvaW50ID0gZy5wb2ludChjdXJyZW50UG9pbnQpLm9mZnNldChkaXIub2Zmc2V0WCwgZGlyLm9mZnNldFkpOwogICAgICAgICAgICAgICAgICAgIHZhciBuZWlnaGJvcktleSA9IG5laWdoYm9yUG9pbnQudG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNsb3NlSGFzaFtuZWlnaGJvcktleV0pIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gaXMgcG9pbnQgYWNjZXNpYmxlIC0gbm8gb2JzdGFjbGUgaW4gdGhlIHdheQoKICAgICAgICAgICAgICAgICAgICB2YXIgbWFwS2V5ID0gZy5wb2ludChuZWlnaGJvclBvaW50KS5zbmFwVG9HcmlkKG9wdC5tYXBHcmlkU2l6ZSkudG9TdHJpbmcoKTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGlzQWNjZXNpYmxlID0gXy5ldmVyeShtYXBbbWFwS2V5XSwgZnVuY3Rpb24ob2JzdGFjbGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFvYnN0YWNsZS5jb250YWluc1BvaW50KG5laWdoYm9yUG9pbnQpOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWNjZXNpYmxlKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBpbk9wZW5TZXQgPSBfLmhhcyhvcGVuSGFzaCwgbmVpZ2hib3JLZXkpOwoKICAgICAgICAgICAgICAgICAgICB2YXIgY29zdFRvTmVpZ2hib3IgPSBjdXJyZW50RGlzdCArIGRpci5jb3N0OwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWluT3BlblNldCB8fCBjb3N0VG9OZWlnaGJvciA8IGNvc3RGcm9tU3RhcnRbbmVpZ2hib3JLZXldKSB7CgogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzW25laWdoYm9yS2V5XSA9IGN1cnJlbnRQb2ludDsKICAgICAgICAgICAgICAgICAgICAgICAgZGlySW5kZXhlc1tuZWlnaGJvcktleV0gPSBkaXJJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgY29zdEZyb21TdGFydFtuZWlnaGJvcktleV0gPSBjb3N0VG9OZWlnaGJvcjsKCiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsQ29zdFtuZWlnaGJvcktleV0gPSBjb3N0VG9OZWlnaGJvciArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHQuZXN0aW1hdGVDb3N0KG5laWdoYm9yUG9pbnQsIGVuZFBvaW50KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5hbHRpZXNbZGlyQ2hhbmdlXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5PcGVuU2V0KSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wZW5JbmRleCA9IF8uc29ydGVkSW5kZXgob3BlblNldCwgbmVpZ2hib3JLZXksIGZ1bmN0aW9uKG9wZW5LZXkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRvdGFsQ29zdFtvcGVuS2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5TZXQuc3BsaWNlKG9wZW5JbmRleCwgMCwgbmVpZ2hib3JLZXkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3Blbkhhc2hbbmVpZ2hib3JLZXldID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBubyByb3V0ZSBmb3VuZCAoJ3RvJyBwb2ludCB3YXNuJ3QgZWl0aGVyIGFjY2Vzc2libGUgb3IgZmluZGluZyByb3V0ZSB0b29rCiAgICAgICAgLy8gd2F5IHRvIG11Y2ggY2FsY3VsYXRpb25zKQogICAgICAgIHJldHVybiBvcHQuZmFsbGJhY2tSb3V0ZShzdGFydENlbnRlciwgZW5kQ2VudGVyLCBvcHQpOwogICAgfTsKCiAgICAvLyBpbml0aWF0aW9uIG9mIHRoZSByb3V0ZSBmaW5kaW5nCiAgICBmdW5jdGlvbiByb3V0ZXIob2xkVmVydGljZXMsIG9wdCkgewoKICAgICAgICAvLyByZXNvbHZlIHNvbWUgb2YgdGhlIG9wdGlvbnMKICAgICAgICBvcHQuZGlyZWN0aW9ucyA9IF8ucmVzdWx0KG9wdCwgJ2RpcmVjdGlvbnMnKTsKICAgICAgICBvcHQucGVuYWx0aWVzID0gXy5yZXN1bHQob3B0LCAncGVuYWx0aWVzJyk7CiAgICAgICAgb3B0LnBhZGRpbmdCb3ggPSBfLnJlc3VsdChvcHQsICdwYWRkaW5nQm94Jyk7CgogICAgICAgIC8vIGVuYWJsZS9kaXNhYmxlIGxpbmtWaWV3IHBlcnBlbmRpY3VsYXIgb3B0aW9uCiAgICAgICAgdGhpcy5vcHRpb25zLnBlcnBlbmRpY3VsYXIgPSAhIW9wdC5wZXJwZW5kaWN1bGFyOwoKICAgICAgICAvLyBBcyByb3V0ZSBjaGFuZ2VzIGl0cyBzaGFwZSByYXBpZGx5IHdoZW4gd2Ugc3RhcnQgZmluZGluZyByb3V0ZSBmcm9tIGRpZmZlcmVudCBwb2ludAogICAgICAgIC8vIGl0J3MgbmVjZXNzYXJ5IHRvIHN0YXJ0IGZyb20gdGhlIGVsZW1lbnQgdGhhdCB3YXMgbm90IGludGVyYWN0ZWQgd2l0aAogICAgICAgIC8vICh0aGUgcG9zaXRpb24gd2FzIGNoYW5nZWQpIGF0IHZlcnkgbGFzdC4KICAgICAgICB2YXIgcmV2ZXJzZVJvdXRpbmcgPSBvcHQucmV2ZXJzZWQgPSAodGhpcy5sYXN0RW5kQ2hhbmdlID09PSAnc291cmNlJyk7CgogICAgICAgIHZhciBzb3VyY2VCQm94ID0gcmV2ZXJzZVJvdXRpbmcgPyBnLnJlY3QodGhpcy50YXJnZXRCQm94KSA6IGcucmVjdCh0aGlzLnNvdXJjZUJCb3gpOwogICAgICAgIHZhciB0YXJnZXRCQm94ID0gcmV2ZXJzZVJvdXRpbmcgPyBnLnJlY3QodGhpcy5zb3VyY2VCQm94KSA6IGcucmVjdCh0aGlzLnRhcmdldEJCb3gpOwoKICAgICAgICAvLyBleHBhbmQgYm94ZXMgYnkgc3BlY2lmaWMgcGFkZGluZwogICAgICAgIHNvdXJjZUJCb3gubW92ZUFuZEV4cGFuZChvcHQucGFkZGluZ0JveCk7CiAgICAgICAgdGFyZ2V0QkJveC5tb3ZlQW5kRXhwYW5kKG9wdC5wYWRkaW5nQm94KTsKCiAgICAgICAgLy8gYnVpbGRpbmcgYW4gZWxlbWVudHMgbWFwCgogICAgICAgIHZhciBsaW5rID0gdGhpcy5tb2RlbDsKICAgICAgICB2YXIgZ3JhcGggPSB0aGlzLnBhcGVyLm1vZGVsOwoKICAgICAgICAvLyBzb3VyY2Ugb3IgdGFyZ2V0IGVsZW1lbnQgY291bGQgYmUgZXhjbHVkZWQgZnJvbSBzZXQgb2Ygb2JzdGFjbGVzCiAgICAgICAgdmFyIGV4Y2x1ZGVkRW5kcyA9IF8uY2hhaW4ob3B0LmV4Y2x1ZGVFbmRzKQogICAgICAgICAgICAgICAgLm1hcChsaW5rLmdldCwgbGluaykKICAgICAgICAgICAgICAgIC5wbHVjaygnaWQnKQogICAgICAgICAgICAgICAgLm1hcChncmFwaC5nZXRDZWxsLCBncmFwaCkudmFsdWUoKTsKCiAgICAgICAgdmFyIG1hcEdyaWRTaXplID0gb3B0Lm1hcEdyaWRTaXplOwoKICAgICAgICAvLyBidWlsZHMgYSBtYXAgb2YgYWxsIGVsZW1lbnRzIGZvciBxdWlja2VyIG9ic3RhY2xlIHF1ZXJpZXMgKGkuZS4gaXMgYSBwb2ludCBjb250YWluZWQKICAgICAgICAvLyBpbiBhbnkgb2JzdGFjbGU/KSAoYSBzaW1wbGlmaWVkIGdyaWQgc2VhcmNoKQogICAgICAgIC8vIFRoZSBwYXBlciBpcyBkaXZpZGVkIHRvIHNtYWxsZXIgY2VsbHMsIHdoZXJlIGVhY2ggb2YgdGhlbSBob2xkcyBhbiBpbmZvcm1hdGlvbiB3aGljaAogICAgICAgIC8vIGVsZW1lbnRzIGJlbG9uZyB0byBpdC4gV2hlbiB3ZSBxdWVyeSB3aGV0aGVyIGEgcG9pbnQgaXMgaW4gYW4gb2JzdGFjbGUgd2UgZG9uJ3QgbmVlZAogICAgICAgIC8vIHRvIGdvIHRocm91Z2ggYWxsIG9ic3RhY2xlcywgd2UgY2hlY2sgb25seSB0aG9zZSBpbiBhIHBhcnRpY3VsYXIgY2VsbC4KICAgICAgICB2YXIgbWFwID0gXy5jaGFpbihncmFwaC5nZXRFbGVtZW50cygpKQogICAgICAgICAgICAvLyByZW1vdmUgc291cmNlIGFuZCB0YXJnZXQgZWxlbWVudCBpZiByZXF1aXJlZAogICAgICAgICAgICAuZGlmZmVyZW5jZShleGNsdWRlZEVuZHMpCiAgICAgICAgICAgIC8vIHJlbW92ZSBhbGwgZWxlbWVudHMgd2hvc2UgdHlwZSBpcyBsaXN0ZWQgaW4gZXhjbHVkZWRUeXBlcyBhcnJheQogICAgICAgICAgICAucmVqZWN0KGZ1bmN0aW9uKGVsZW1lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfLmNvbnRhaW5zKG9wdC5leGNsdWRlVHlwZXMsIGVsZW1lbnQuZ2V0KCd0eXBlJykpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAvLyBjaGFuZ2UgZWxlbWVudHMgKG1vZGVscykgdG8gdGhlaXIgYm91bmRpbmcgYm94ZXMKICAgICAgICAgICAgLmludm9rZSgnZ2V0QkJveCcpCiAgICAgICAgICAgIC8vIGV4cGFuZCB0aGVpciBib3hlcyBieSBzcGVjaWZpYyBwYWRkaW5nCiAgICAgICAgICAgIC5pbnZva2UoJ21vdmVBbmRFeHBhbmQnLCBvcHQucGFkZGluZ0JveCkKICAgICAgICAgICAgLy8gYnVpbGQgdGhlIG1hcAogICAgICAgICAgICAuZm9sZGwoZnVuY3Rpb24ocmVzLCBiYm94KSB7CgogICAgICAgICAgICAgICAgdmFyIG9yaWdpbiA9IGJib3gub3JpZ2luKCkuc25hcFRvR3JpZChtYXBHcmlkU2l6ZSk7CiAgICAgICAgICAgICAgICB2YXIgY29ybmVyID0gYmJveC5jb3JuZXIoKS5zbmFwVG9HcmlkKG1hcEdyaWRTaXplKTsKCiAgICAgICAgICAgICAgICBmb3IgKHZhciB4ID0gb3JpZ2luLng7IHggPD0gY29ybmVyLng7IHggKz0gbWFwR3JpZFNpemUpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB5ID0gb3JpZ2luLnk7IHkgPD0gY29ybmVyLnk7IHkgKz0gbWFwR3JpZFNpemUpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmlkS2V5ID0geCArICdAJyArIHk7CgogICAgICAgICAgICAgICAgICAgICAgICByZXNbZ3JpZEtleV0gPSByZXNbZ3JpZEtleV0gfHwgW107CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc1tncmlkS2V5XS5wdXNoKGJib3gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwoKICAgICAgICAgICAgfSwge30pLnZhbHVlKCk7CgogICAgICAgIC8vIHBhdGhmaW5kaW5nCgogICAgICAgIHZhciBuZXdWZXJ0aWNlcyA9IFtdOwoKICAgICAgICB2YXIgcG9pbnRzID0gXy5tYXAob2xkVmVydGljZXMsIGcucG9pbnQpOwoKICAgICAgICB2YXIgdGFpbFBvaW50ID0gc291cmNlQkJveC5jZW50ZXIoKTsKCiAgICAgICAgLy8gZmluZCBhIHJvdXRlIGJ5IGNvbmNhdGluZyBhbGwgcGFydGlhbCByb3V0ZXMgKHJvdXRlcyBuZWVkIHRvIGdvIHRocm91Z2ggdGhlIHZlcnRpY2VzKQogICAgICAgIC8vIHN0YXJ0RWxlbWVudCAtPiB2ZXJ0ZXhbMV0gLT4gLi4uIC0+IHZlcnRleFtuXSAtPiBlbmRFbGVtZW50CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPD0gbGVuOyBpKyspIHsKCiAgICAgICAgICAgIHZhciBwYXJ0aWFsUm91dGUgPSBudWxsOwoKICAgICAgICAgICAgdmFyIGZyb20gPSB0byB8fCBzb3VyY2VCQm94OwogICAgICAgICAgICB2YXIgdG8gPSBwb2ludHNbaV07CgogICAgICAgICAgICBpZiAoIXRvKSB7CgogICAgICAgICAgICAgICAgdG8gPSB0YXJnZXRCQm94OwoKICAgICAgICAgICAgICAgIC8vICd0bycgaXMgbm90IGEgdmVydGV4LiBJZiB0aGUgdGFyZ2V0IGlzIGEgcG9pbnQgKGkuZS4gaXQncyBub3QgYW4gZWxlbWVudCksIHdlCiAgICAgICAgICAgICAgICAvLyBtaWdodCB1c2UgZHJhZ2dpbmcgcm91dGUgaW5zdGVhZCBvZiBtYWluIHJvdXRpbmcgbWV0aG9kIGlmIHRoYXQgaXMgZW5hYmxlZC4KICAgICAgICAgICAgICAgIHZhciBlbmRpbmdBdFBvaW50ID0gIXRoaXMubW9kZWwuZ2V0KCdzb3VyY2UnKS5pZCB8fCAhdGhpcy5tb2RlbC5nZXQoJ3RhcmdldCcpLmlkOwoKICAgICAgICAgICAgICAgIGlmIChlbmRpbmdBdFBvaW50ICYmIF8uaXNGdW5jdGlvbihvcHQuZHJhZ2dpbmdSb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgd2UgcGFzc2luZyBwb2ludHMgb25seSAobm90IHJlY3RzKS4KICAgICAgICAgICAgICAgICAgICB2YXIgZHJhZ0Zyb20gPSBmcm9tIGluc3RhbmNlb2YgZy5yZWN0ID8gZnJvbS5jZW50ZXIoKSA6IGZyb207CiAgICAgICAgICAgICAgICAgICAgcGFydGlhbFJvdXRlID0gb3B0LmRyYWdnaW5nUm91dGUoZHJhZ0Zyb20sIHRvLm9yaWdpbigpLCBvcHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBpZiBwYXJ0aWFsIHJvdXRlIGhhcyBub3QgYmVlbiBjYWxjdWxhdGVkIHlldCB1c2UgdGhlIG1haW4gcm91dGluZyBtZXRob2QgdG8gZmluZCBvbmUKICAgICAgICAgICAgcGFydGlhbFJvdXRlID0gcGFydGlhbFJvdXRlIHx8IGZpbmRSb3V0ZShmcm9tLCB0bywgbWFwLCBvcHQpOwoKICAgICAgICAgICAgdmFyIGxlYWRQb2ludCA9IF8uZmlyc3QocGFydGlhbFJvdXRlKTsKCiAgICAgICAgICAgIGlmIChsZWFkUG9pbnQgJiYgbGVhZFBvaW50LmVxdWFscyh0YWlsUG9pbnQpKSB7CgogICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHRoZSBmaXJzdCBwb2ludCBpZiB0aGUgcHJldmlvdXMgcGFydGlhbCByb3V0ZSBoYWQgdGhlIHNhbWUgcG9pbnQgYXMgbGFzdAogICAgICAgICAgICAgICAgcGFydGlhbFJvdXRlLnNoaWZ0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhaWxQb2ludCA9IF8ubGFzdChwYXJ0aWFsUm91dGUpIHx8IHRhaWxQb2ludDsKCiAgICAgICAgICAgIG5ld1ZlcnRpY2VzID0gbmV3VmVydGljZXMuY29uY2F0KHBhcnRpYWxSb3V0ZSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gd2UgbWlnaHQgaGF2ZSB0byByZXZlcnNlIHRoZSByZXN1bHQgaWYgd2Ugc3dhcHBlZCBzb3VyY2UgYW5kIHRhcmdldCBhdCB0aGUgYmVnaW5uaW5nCiAgICAgICAgcmV0dXJuIHJldmVyc2VSb3V0aW5nID8gbmV3VmVydGljZXMucmV2ZXJzZSgpIDogbmV3VmVydGljZXM7CiAgICB9OwoKICAgIC8vIHB1YmxpYyBmdW5jdGlvbgogICAgcmV0dXJuIGZ1bmN0aW9uKHZlcnRpY2VzLCBvcHQsIGxpbmtWaWV3KSB7CgogICAgICAgIHJldHVybiByb3V0ZXIuY2FsbChsaW5rVmlldywgdmVydGljZXMsIF8uZXh0ZW5kKHt9LCBjb25maWcsIG9wdCkpOwogICAgfTsKCn0pKCk7Cgpqb2ludC5yb3V0ZXJzLm1ldHJvID0gKGZ1bmN0aW9uKCkgewoKICAgIGlmICghXy5pc0Z1bmN0aW9uKGpvaW50LnJvdXRlcnMubWFuaGF0dGFuKSkgewoKICAgICAgICB0aHJvdygnTWV0cm8gcmVxdWlyZXMgdGhlIG1hbmhhdHRhbiByb3V0ZXIuJyk7CiAgICB9CgogICAgdmFyIGNvbmZpZyA9IHsKCiAgICAgICAgLy8gY29zdCBvZiBhIGRpYWdvbmFsIHN0ZXAgKGNhbGN1bGF0ZWQgaWYgbm90IGRlZmluZWQpLgogICAgICAgIGRpYWdvbmFsQ29zdDogbnVsbCwKCiAgICAgICAgLy8gYW4gYXJyYXkgb2YgZGlyZWN0aW9ucyB0byBmaW5kIG5leHQgcG9pbnRzIG9uIHRoZSByb3V0ZQogICAgICAgIGRpcmVjdGlvbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgdmFyIHN0ZXAgPSB0aGlzLnN0ZXA7CiAgICAgICAgICAgIHZhciBkaWFnb25hbENvc3QgPSB0aGlzLmRpYWdvbmFsQ29zdCB8fCBNYXRoLmNlaWwoTWF0aC5zcXJ0KHN0ZXAgKiBzdGVwIDw8IDEpKTsKCiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IHN0ZXAgICwgb2Zmc2V0WTogMCAgICAgLCBjb3N0OiBzdGVwICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogc3RlcCAgLCBvZmZzZXRZOiBzdGVwICAsIGNvc3Q6IGRpYWdvbmFsQ29zdCB9LAogICAgICAgICAgICAgICAgeyBvZmZzZXRYOiAwICAgICAsIG9mZnNldFk6IHN0ZXAgICwgY29zdDogc3RlcCAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IC1zdGVwICwgb2Zmc2V0WTogc3RlcCAgLCBjb3N0OiBkaWFnb25hbENvc3QgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogLXN0ZXAgLCBvZmZzZXRZOiAwICAgICAsIGNvc3Q6IHN0ZXAgICAgICAgICB9LAogICAgICAgICAgICAgICAgeyBvZmZzZXRYOiAtc3RlcCAsIG9mZnNldFk6IC1zdGVwICwgY29zdDogZGlhZ29uYWxDb3N0IH0sCiAgICAgICAgICAgICAgICB7IG9mZnNldFg6IDAgICAgICwgb2Zmc2V0WTogLXN0ZXAgLCBjb3N0OiBzdGVwICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHsgb2Zmc2V0WDogc3RlcCAgLCBvZmZzZXRZOiAtc3RlcCAsIGNvc3Q6IGRpYWdvbmFsQ29zdCB9CiAgICAgICAgICAgIF07CiAgICAgICAgfSwKCiAgICAgICAgLy8gYSBzaW1wbGUgcm91dGUgdXNlZCBpbiBzaXR1YXRpb25zLCB3aGVuIG1haW4gcm91dGluZyBtZXRob2QgZmFpbHMKICAgICAgICAvLyAoZXhjZWVkIGxvb3BzLCBpbmFjY2Vzc2libGUpLgogICAgICAgIGZhbGxiYWNrUm91dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBvcHRzKSB7CgogICAgICAgICAgICAvLyBGaW5kIGEgcm91dGUgd2hpY2ggYnJlYWtzIGJ5IDQ1IGRlZ3JlZXMgaWdub3JpbmcgYWxsIG9ic3RhY2xlcy4KCiAgICAgICAgICAgIHZhciB0aGV0YSA9IGZyb20udGhldGEodG8pOwoKICAgICAgICAgICAgdmFyIGEgPSB7IHg6IHRvLngsIHk6IGZyb20ueSB9OwogICAgICAgICAgICB2YXIgYiA9IHsgeDogZnJvbS54LCB5OiB0by55IH07CgogICAgICAgICAgICBpZiAodGhldGEgJSAxODAgPiA5MCkgewogICAgICAgICAgICAgICAgdmFyIHQgPSBhOwogICAgICAgICAgICAgICAgYSA9IGI7CiAgICAgICAgICAgICAgICBiID0gdDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHAxID0gKHRoZXRhICUgOTApIDwgNDUgPyBhIDogYjsKCiAgICAgICAgICAgIHZhciBsMSA9IGcubGluZShmcm9tLCBwMSk7CgogICAgICAgICAgICB2YXIgYWxwaGEgPSA5MCAqIE1hdGguY2VpbCh0aGV0YSAvIDkwKTsKCiAgICAgICAgICAgIHZhciBwMiA9IGcucG9pbnQuZnJvbVBvbGFyKGwxLnNxdWFyZWRMZW5ndGgoKSwgZy50b1JhZChhbHBoYSArIDEzNSksIHAxKTsKCiAgICAgICAgICAgIHZhciBsMiA9IGcubGluZSh0bywgcDIpOwoKICAgICAgICAgICAgdmFyIHBvaW50ID0gbDEuaW50ZXJzZWN0aW9uKGwyKTsKCiAgICAgICAgICAgIHJldHVybiBwb2ludCA/IFtwb2ludC5yb3VuZCgpLCB0b10gOiBbdG9dOwogICAgICAgIH0KICAgIH07CgogICAgLy8gcHVibGljIGZ1bmN0aW9uCiAgICByZXR1cm4gZnVuY3Rpb24odmVydGljZXMsIG9wdHMsIGxpbmtWaWV3KSB7CgogICAgICAgIHJldHVybiBqb2ludC5yb3V0ZXJzLm1hbmhhdHRhbih2ZXJ0aWNlcywgXy5leHRlbmQoe30sIGNvbmZpZywgb3B0cyksIGxpbmtWaWV3KTsKICAgIH07Cgp9KSgpOwoKam9pbnQuY29ubmVjdG9ycy5ub3JtYWwgPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzKSB7CgogICAgLy8gQ29uc3RydWN0IHRoZSBgZGAgYXR0cmlidXRlIG9mIHRoZSBgPHBhdGg+YCBlbGVtZW50LgogICAgdmFyIGQgPSBbJ00nLCBzb3VyY2VQb2ludC54LCBzb3VyY2VQb2ludC55XTsKCiAgICBfLmVhY2godmVydGljZXMsIGZ1bmN0aW9uKHZlcnRleCkgewoKICAgICAgICBkLnB1c2godmVydGV4LngsIHZlcnRleC55KTsKICAgIH0pOwoKICAgIGQucHVzaCh0YXJnZXRQb2ludC54LCB0YXJnZXRQb2ludC55KTsKCiAgICByZXR1cm4gZC5qb2luKCcgJyk7Cn07Cgpqb2ludC5jb25uZWN0b3JzLnJvdW5kZWQgPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzLCBvcHRzKSB7CgogICAgdmFyIG9mZnNldCA9IG9wdHMucmFkaXVzIHx8IDEwOwoKICAgIHZhciBjMSwgYzIsIGQxLCBkMiwgcHJldiwgbmV4dDsKCiAgICAvLyBDb25zdHJ1Y3QgdGhlIGBkYCBhdHRyaWJ1dGUgb2YgdGhlIGA8cGF0aD5gIGVsZW1lbnQuCiAgICB2YXIgZCA9IFsnTScsIHNvdXJjZVBvaW50LngsIHNvdXJjZVBvaW50LnldOwoKICAgIF8uZWFjaCh2ZXJ0aWNlcywgZnVuY3Rpb24odmVydGV4LCBpbmRleCkgewoKICAgICAgICAvLyB0aGUgY2xvc2VzdCB2ZXJ0aWNlcwogICAgICAgIHByZXYgPSB2ZXJ0aWNlc1tpbmRleC0xXSB8fCBzb3VyY2VQb2ludDsKICAgICAgICBuZXh0ID0gdmVydGljZXNbaW5kZXgrMV0gfHwgdGFyZ2V0UG9pbnQ7CgogICAgICAgIC8vIGEgaGFsZiBkaXN0YW5jZSB0byB0aGUgY2xvc2VzdCB2ZXJ0ZXgKICAgICAgICBkMSA9IGQyIHx8IGcucG9pbnQodmVydGV4KS5kaXN0YW5jZShwcmV2KSAvIDI7CiAgICAgICAgZDIgPSBnLnBvaW50KHZlcnRleCkuZGlzdGFuY2UobmV4dCkgLyAyOwoKICAgICAgICAvLyBjb250cm9sIHBvaW50cwogICAgICAgIGMxID0gZy5wb2ludCh2ZXJ0ZXgpLm1vdmUocHJldiwgLU1hdGgubWluKG9mZnNldCwgZDEpKS5yb3VuZCgpOwogICAgICAgIGMyID0gZy5wb2ludCh2ZXJ0ZXgpLm1vdmUobmV4dCwgLU1hdGgubWluKG9mZnNldCwgZDIpKS5yb3VuZCgpOwoKICAgICAgICBkLnB1c2goYzEueCwgYzEueSwgJ1MnLCB2ZXJ0ZXgueCwgdmVydGV4LnksIGMyLngsIGMyLnksICdMJyk7CiAgICB9KTsKCiAgICBkLnB1c2godGFyZ2V0UG9pbnQueCwgdGFyZ2V0UG9pbnQueSk7CgogICAgcmV0dXJuIGQuam9pbignICcpOwp9OwoKam9pbnQuY29ubmVjdG9ycy5zbW9vdGggPSBmdW5jdGlvbihzb3VyY2VQb2ludCwgdGFyZ2V0UG9pbnQsIHZlcnRpY2VzKSB7CgogICAgdmFyIGQ7CgogICAgaWYgKHZlcnRpY2VzLmxlbmd0aCkgewoKICAgICAgICBkID0gZy5iZXppZXIuY3VydmVUaHJvdWdoUG9pbnRzKFtzb3VyY2VQb2ludF0uY29uY2F0KHZlcnRpY2VzKS5jb25jYXQoW3RhcmdldFBvaW50XSkpOwoKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gaWYgd2UgaGF2ZSBubyB2ZXJ0aWNlcyB1c2UgYSBkZWZhdWx0IGN1YmljIGJlemllciBjdXJ2ZSwgY3ViaWMgYmV6aWVyIHJlcXVpcmVzCiAgICAgICAgLy8gdHdvIGNvbnRyb2wgcG9pbnRzLiBUaGUgdHdvIGNvbnRyb2wgcG9pbnRzIGFyZSBib3RoIGRlZmluZWQgd2l0aCBYIGFzIG1pZCB3YXkKICAgICAgICAvLyBiZXR3ZWVuIHRoZSBzb3VyY2UgYW5kIHRhcmdldCBwb2ludHMuIFNvdXJjZUNvbnRyb2xQb2ludCBZIGlzIGVxdWFsIHRvIHNvdXJjZVBvaW50IFkKICAgICAgICAvLyBhbmQgdGFyZ2V0Q29udHJvbFBvaW50WSBiZWluZyBlcXVhbCB0byB0YXJnZXRQb2ludFkuIEhhbmRsZSBzaXR1YXRpb24gd2VyZQogICAgICAgIC8vIHNvdXJjZVBvaW50WCBpcyBncmVhdGVyIG9yIGxlc3MgdGhlbiB0YXJnZXRQb2ludFguCiAgICAgICAgdmFyIGNvbnRyb2xQb2ludFggPSAoc291cmNlUG9pbnQueCA8IHRhcmdldFBvaW50LngpIAogICAgICAgICAgICAgICAgPyB0YXJnZXRQb2ludC54IC0gKCh0YXJnZXRQb2ludC54IC0gc291cmNlUG9pbnQueCkgLyAyKQogICAgICAgICAgICAgICAgOiBzb3VyY2VQb2ludC54IC0gKChzb3VyY2VQb2ludC54IC0gdGFyZ2V0UG9pbnQueCkgLyAyKTsKCiAgICAgICAgZCA9IFsKICAgICAgICAgICAgJ00nLCBzb3VyY2VQb2ludC54LCBzb3VyY2VQb2ludC55LAogICAgICAgICAgICAnQycsIGNvbnRyb2xQb2ludFgsIHNvdXJjZVBvaW50LnksIGNvbnRyb2xQb2ludFgsIHRhcmdldFBvaW50LnksCiAgICAgICAgICAgIHRhcmdldFBvaW50LngsIHRhcmdldFBvaW50LnkKICAgICAgICBdOwogICAgfQoKICAgIHJldHVybiBkLmpvaW4oJyAnKTsKfTsKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczoge30sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnQ6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnQsCiAgICAgICAgICAgIExpbms6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEubGluaycpLkxpbmsKICAgICAgICB9CiAgICB9Owp9CgoKam9pbnQuc2hhcGVzLmVyZCA9IHt9OwoKam9pbnQuc2hhcGVzLmVyZC5FbnRpdHkgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHBvbHlnb24gY2xhc3M9Im91dGVyIi8+PHBvbHlnb24gY2xhc3M9ImlubmVyIi8+PC9nPjx0ZXh0Lz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdlcmQuRW50aXR5JywKICAgICAgICBzaXplOiB7IHdpZHRoOiAxNTAsIGhlaWdodDogNjAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm91dGVyJzogewogICAgICAgICAgICAgICAgZmlsbDogJyMyRUNDNzEnLCBzdHJva2U6ICcjMjdBRTYwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBwb2ludHM6ICcxMDAsMCAxMDAsNjAgMCw2MCAwLDAnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuaW5uZXInOiB7CiAgICAgICAgICAgICAgICBmaWxsOiAnIzJFQ0M3MScsIHN0cm9rZTogJyMyN0FFNjAnLCAnc3Ryb2tlLXdpZHRoJzogMiwKICAgICAgICAgICAgICAgIHBvaW50czogJzk1LDUgOTUsNTUgNSw1NSA1LDUnLAogICAgICAgICAgICAgICAgZGlzcGxheTogJ25vbmUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRleHQ6IHsKICAgICAgICAgICAgICAgIHRleHQ6ICdFbnRpdHknLAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0FyaWFsJywgJ2ZvbnQtc2l6ZSc6IDE0LAogICAgICAgICAgICAgICAgcmVmOiAnLm91dGVyJywgJ3JlZi14JzogLjUsICdyZWYteSc6IC41LAogICAgICAgICAgICAgICAgJ3gtYWxpZ25tZW50JzogJ21pZGRsZScsICd5LWFsaWdubWVudCc6ICdtaWRkbGUnCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuZGlhLkVsZW1lbnQucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5lcmQuV2Vha0VudGl0eSA9IGpvaW50LnNoYXBlcy5lcmQuRW50aXR5LmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZXJkLldlYWtFbnRpdHknLAoKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLmlubmVyJyA6IHsgZGlzcGxheTogJ2F1dG8nIH0sCiAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ1dlYWsgRW50aXR5JyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5lcmQuRW50aXR5LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZXJkLlJlbGF0aW9uc2hpcCA9IGpvaW50LmRpYS5FbGVtZW50LmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cG9seWdvbiBjbGFzcz0ib3V0ZXIiLz48cG9seWdvbiBjbGFzcz0iaW5uZXIiLz48L2c+PHRleHQvPjwvZz4nLAogICAgCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdlcmQuUmVsYXRpb25zaGlwJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA4MCwgaGVpZ2h0OiA4MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcub3V0ZXInOiB7CiAgICAgICAgICAgICAgICBmaWxsOiAnIzM0OThEQicsIHN0cm9rZTogJyMyOTgwQjknLCAnc3Ryb2tlLXdpZHRoJzogMiwKICAgICAgICAgICAgICAgIHBvaW50czogJzQwLDAgODAsNDAgNDAsODAgMCw0MCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy5pbm5lcic6IHsKICAgICAgICAgICAgICAgIGZpbGw6ICcjMzQ5OERCJywgc3Ryb2tlOiAnIzI5ODBCOScsICdzdHJva2Utd2lkdGgnOiAyLAogICAgICAgICAgICAgICAgcG9pbnRzOiAnNDAsNSA3NSw0MCA0MCw3NSA1LDQwJywKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICdub25lJwogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZXh0OiB7CiAgICAgICAgICAgICAgICB0ZXh0OiAnUmVsYXRpb25zaGlwJywKICAgICAgICAgICAgICAgICdmb250LWZhbWlseSc6ICdBcmlhbCcsICdmb250LXNpemUnOiAxMiwKICAgICAgICAgICAgICAgIHJlZjogJy4nLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogLjUsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmVyZC5JZGVudGlmeWluZ1JlbGF0aW9uc2hpcCA9IGpvaW50LnNoYXBlcy5lcmQuUmVsYXRpb25zaGlwLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZXJkLklkZW50aWZ5aW5nUmVsYXRpb25zaGlwJywKCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5pbm5lcic6IHsgZGlzcGxheTogJ2F1dG8nIH0sCiAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ0lkZW50aWZ5aW5nJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5lcmQuUmVsYXRpb25zaGlwLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZSA9IGpvaW50LmRpYS5FbGVtZW50LmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZWxsaXBzZSBjbGFzcz0ib3V0ZXIiLz48ZWxsaXBzZSBjbGFzcz0iaW5uZXIiLz48L2c+PHRleHQvPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5BdHRyaWJ1dGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEwMCwgaGVpZ2h0OiA1MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICdlbGxpcHNlJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDUwLCAyNSknCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcub3V0ZXInOiB7CiAgICAgICAgICAgICAgICBzdHJva2U6ICcjRDM1NDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBjeDogMCwgY3k6IDAsIHJ4OiA1MCwgcnk6IDI1LAogICAgICAgICAgICAgICAgZmlsbDogJyNFNjdFMjInCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcuaW5uZXInOiB7CiAgICAgICAgICAgICAgICBzdHJva2U6ICcjRDM1NDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICBjeDogMCwgY3k6IDAsIHJ4OiA0NSwgcnk6IDIwLAogICAgICAgICAgICAgICAgZmlsbDogJ3RyYW5zcGFyZW50JywgZGlzcGxheTogJ25vbmUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRleHQ6IHsKICAgICAgICAgICAgICAgICAnZm9udC1mYW1pbHknOiAnQXJpYWwnLCAnZm9udC1zaXplJzogMTQsCiAgICAgICAgICAgICAgICAgcmVmOiAnLicsICdyZWYteCc6IC41LCAncmVmLXknOiAuNSwKICAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgIH0KICAgICAgICAgfQoKICAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCgogfSk7Cgogam9pbnQuc2hhcGVzLmVyZC5NdWx0aXZhbHVlZCA9IGpvaW50LnNoYXBlcy5lcmQuQXR0cmlidXRlLmV4dGVuZCh7CgogICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgIHR5cGU6ICdlcmQuTXVsdGl2YWx1ZWQnLAoKICAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgICcuaW5uZXInOiB7IGRpc3BsYXk6ICdibG9jaycgfSwKICAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ211bHRpdmFsdWVkJyB9CiAgICAgICAgIH0KICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCiB9KTsKCiBqb2ludC5zaGFwZXMuZXJkLkRlcml2ZWQgPSBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5leHRlbmQoewoKICAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgICB0eXBlOiAnZXJkLkRlcml2ZWQnLAoKICAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgICcub3V0ZXInOiB7ICdzdHJva2UtZGFzaGFycmF5JzogJzMsNScgfSwKICAgICAgICAgICAgIHRleHQ6IHsgdGV4dDogJ2Rlcml2ZWQnIH0KICAgICAgICAgfQoKICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCiB9KTsKCiBqb2ludC5zaGFwZXMuZXJkLktleSA9IGpvaW50LnNoYXBlcy5lcmQuQXR0cmlidXRlLmV4dGVuZCh7CgogICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgIHR5cGU6ICdlcmQuS2V5JywKCiAgICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICBlbGxpcHNlOiB7ICdzdHJva2Utd2lkdGgnOiA0IH0sCiAgICAgICAgICAgICB0ZXh0OiB7IHRleHQ6ICdrZXknLCAnZm9udC13ZWlnaHQnOiAnYm9sZCcsICd0ZXh0LWRlY29yYXRpb24nOiAndW5kZXJsaW5lJyB9CiAgICAgICAgIH0KICAgICB9LCBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmVyZC5Ob3JtYWwgPSBqb2ludC5zaGFwZXMuZXJkLkF0dHJpYnV0ZS5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5Ob3JtYWwnLAoKICAgICAgICBhdHRyczogeyB0ZXh0OiB7IHRleHQ6ICdOb3JtYWwnIH19CgogICAgfSwgam9pbnQuc2hhcGVzLmVyZC5BdHRyaWJ1dGUucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5lcmQuSVNBID0gam9pbnQuZGlhLkVsZW1lbnQuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxwb2x5Z29uLz48L2c+PHRleHQvPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2VyZC5JU0EnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEwMCwgaGVpZ2h0OiA1MCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHBvbHlnb246IHsKICAgICAgICAgICAgICAgIHBvaW50czogJzAsMCA1MCw1MCAxMDAsMCcsCiAgICAgICAgICAgICAgICBmaWxsOiAnI0YxQzQwRicsIHN0cm9rZTogJyNGMzlDMTInLCAnc3Ryb2tlLXdpZHRoJzogMgogICAgICAgICAgICB9LAogICAgICAgICAgICB0ZXh0OiB7CiAgICAgICAgICAgICAgICB0ZXh0OiAnSVNBJywKICAgICAgICAgICAgICAgIHJlZjogJy4nLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogLjMsCiAgICAgICAgICAgICAgICAneC1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ3ktYWxpZ25tZW50JzogJ21pZGRsZScKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCgp9KTsKCmpvaW50LnNoYXBlcy5lcmQuTGluZSA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IHsgdHlwZTogImVyZC5MaW5lIiB9LAoKICAgIGNhcmRpbmFsaXR5OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0KCdsYWJlbHMnLCBbeyBwb3NpdGlvbjogLTIwLCBhdHRyczogeyB0ZXh0OiB7IGR5OiAtOCwgdGV4dDogdmFsdWUgfX19XSk7CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLmVyZDsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudDogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5lbGVtZW50JykuRWxlbWVudCwKICAgICAgICAgICAgTGluazogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5saW5rJykuTGluawogICAgICAgIH0KICAgIH07Cn0KCmpvaW50LnNoYXBlcy5mc2EgPSB7fTsKCmpvaW50LnNoYXBlcy5mc2EuU3RhdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlLmV4dGVuZCh7CiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgdHlwZTogJ2ZzYS5TdGF0ZScsCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgY2lyY2xlOiB7ICdzdHJva2Utd2lkdGgnOiAzIH0sCiAgICAgICAgICAgIHRleHQ6IHsgJ2ZvbnQtd2VpZ2h0JzogJ2JvbGQnIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuQ2lyY2xlLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZnNhLlN0YXJ0U3RhdGUgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZS8+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2ZzYS5TdGFydFN0YXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyMCwgaGVpZ2h0OiAyMCB9LAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIGNpcmNsZTogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogMTAsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuZGlhLkVsZW1lbnQucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5mc2EuRW5kU3RhdGUgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZSBjbGFzcz0ib3V0ZXIiLz48Y2lyY2xlIGNsYXNzPSJpbm5lciIvPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdmc2EuRW5kU3RhdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDIwLCBoZWlnaHQ6IDIwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5vdXRlcic6IHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxMCwgMTApJywKICAgICAgICAgICAgICAgIHI6IDEwLAogICAgICAgICAgICAgICAgZmlsbDogJyNGRkZGRkYnLAogICAgICAgICAgICAgICAgc3Ryb2tlOiAnYmxhY2snCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnLmlubmVyJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogNiwKICAgICAgICAgICAgICAgIGZpbGw6ICcjMDAwMDAwJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LmRpYS5FbGVtZW50LnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZnNhLkFycm93ID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7Cgl0eXBlOiAnZnNhLkFycm93JywKICAgICAgICBhdHRyczogeyAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JyB9fSwKICAgICAgICBzbW9vdGg6IHRydWUKICAgIH0sIGpvaW50LmRpYS5MaW5rLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuZnNhOwp9CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgdmFyIGpvaW50ID0gewogICAgICAgIHV0aWw6IHJlcXVpcmUoJy4uL3NyYy9jb3JlJykudXRpbCwKICAgICAgICBzaGFwZXM6IHt9LAogICAgICAgIGRpYTogewogICAgICAgICAgICBFbGVtZW50OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKfQoKam9pbnQuc2hhcGVzLm9yZyA9IHt9OwoKam9pbnQuc2hhcGVzLm9yZy5NZW1iZXIgPSBqb2ludC5kaWEuRWxlbWVudC5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHJlY3QgY2xhc3M9ImNhcmQiLz48aW1hZ2UvPjwvZz48dGV4dCBjbGFzcz0icmFuayIvPjx0ZXh0IGNsYXNzPSJuYW1lIi8+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnb3JnLk1lbWJlcicsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMTgwLCBoZWlnaHQ6IDcwIH0sCiAgICAgICAgYXR0cnM6IHsKCiAgICAgICAgICAgIHJlY3Q6IHsgd2lkdGg6IDE3MCwgaGVpZ2h0OiA2MCB9LAoKICAgICAgICAgICAgJy5jYXJkJzogewogICAgICAgICAgICAgICAgZmlsbDogJyNGRkZGRkYnLCBzdHJva2U6ICcjMDAwMDAwJywgJ3N0cm9rZS13aWR0aCc6IDIsCiAgICAgICAgICAgICAgICAncG9pbnRlci1ldmVudHMnOiAndmlzaWJsZVBhaW50ZWQnLCByeDogMTAsIHJ5OiAxMAogICAgICAgICAgICB9LAoKICAgICAgICAgICAgaW1hZ2U6IHsKCQl3aWR0aDogNDgsIGhlaWdodDogNDgsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDEwLCAncmVmLXknOiA1CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIAogICAgICAgICAgICAnLnJhbmsnOiB7CiAgICAgICAgICAgICAgICAndGV4dC1kZWNvcmF0aW9uJzogJ3VuZGVybGluZScsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDAuOSwgJ3JlZi15JzogMC4yLAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0LAoJCSd0ZXh0LWFuY2hvcic6ICdlbmQnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnLm5hbWUnOiB7CiAgICAgICAgICAgICAgICAnZm9udC13ZWlnaHQnOiAnYm9sZCcsCiAgICAgICAgICAgICAgICByZWY6ICcuY2FyZCcsICdyZWYteCc6IDAuOSwgJ3JlZi15JzogMC42LAogICAgICAgICAgICAgICAgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0LAoJCSd0ZXh0LWFuY2hvcic6ICdlbmQnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBqb2ludC5kaWEuRWxlbWVudC5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLm9yZy5BcnJvdyA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IHsKICAgICAgICB0eXBlOiAnb3JnLkFycm93JywKICAgICAgICBzb3VyY2U6IHsgc2VsZWN0b3I6ICcuY2FyZCcgfSwgdGFyZ2V0OiB7IHNlbGVjdG9yOiAnLmNhcmQnIH0sCiAgICAgICAgYXR0cnM6IHsgJy5jb25uZWN0aW9uJzogeyBzdHJva2U6ICcjNTg1ODU4JywgJ3N0cm9rZS13aWR0aCc6IDMgfX0sCiAgICAgICAgejogLTEKICAgIH0KfSk7CgoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLm9yZzsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHt9CiAgICB9Owp9Cgpqb2ludC5zaGFwZXMuY2hlc3MgPSB7fTsKCmpvaW50LnNoYXBlcy5jaGVzcy5LaW5nV2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9ImZpbGw6bm9uZTsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPjxwYXRoICAgICAgZD0iTSAyMi41LDExLjYzIEwgMjIuNSw2IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMjAsOCBMIDI1LDgiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyMi41LDI1IEMgMjIuNSwyNSAyNywxNy41IDI1LjUsMTQuNSBDIDI1LjUsMTQuNSAyNC41LDEyIDIyLjUsMTIgQyAyMC41LDEyIDE5LjUsMTQuNSAxOS41LDE0LjUgQyAxOCwxNy41IDIyLjUsMjUgMjIuNSwyNSIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLWxpbmVjYXA6YnV0dDsgc3Ryb2tlLWxpbmVqb2luOm1pdGVyOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLjUsMzcgQyAxNyw0MC41IDI3LDQwLjUgMzIuNSwzNyBMIDMyLjUsMzAgQyAzMi41LDMwIDQxLjUsMjUuNSAzOC41LDE5LjUgQyAzNC41LDEzIDI1LDE2IDIyLjUsMjMuNSBMIDIyLjUsMjcgTCAyMi41LDIzLjUgQyAxOSwxNiA5LjUsMTMgNi41LDE5LjUgQyAzLjUsMjUuNSAxMS41LDI5LjUgMTEuNSwyOS41IEwgMTEuNSwzNyB6ICIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMS41LDMwIEMgMTcsMjcgMjcsMjcgMzIuNSwzMCIgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMS41LDMzLjUgQyAxNywzMC41IDI3LDMwLjUgMzIuNSwzMy41IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLjUsMzcgQyAxNywzNCAyNywzNCAzMi41LDM3IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS2luZ1doaXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA0MiwgaGVpZ2h0OiAzOCB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5LaW5nQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9ImZpbGw6bm9uZTsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8cGF0aCAgICAgICBkPSJNIDIyLjUsMTEuNjMgTCAyMi41LDYiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAgICAgICBpZD0icGF0aDY1NzAiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMjIuNSwyNSBDIDIyLjUsMjUgMjcsMTcuNSAyNS41LDE0LjUgQyAyNS41LDE0LjUgMjQuNSwxMiAyMi41LDEyIEMgMjAuNSwxMiAxOS41LDE0LjUgMTkuNSwxNC41IEMgMTgsMTcuNSAyMi41LDI1IDIyLjUsMjUiICAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7ZmlsbC1vcGFjaXR5OjE7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMTEuNSwzNyBDIDE3LDQwLjUgMjcsNDAuNSAzMi41LDM3IEwgMzIuNSwzMCBDIDMyLjUsMzAgNDEuNSwyNS41IDM4LjUsMTkuNSBDIDM0LjUsMTMgMjUsMTYgMjIuNSwyMy41IEwgMjIuNSwyNyBMIDIyLjUsMjMuNSBDIDE5LDE2IDkuNSwxMyA2LjUsMTkuNSBDIDMuNSwyNS41IDExLjUsMjkuNSAxMS41LDI5LjUgTCAxMS41LDM3IHogIiAgICAgICBzdHlsZT0iZmlsbDojMDAwMDAwOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMjAsOCBMIDI1LDgiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgICBkPSJNIDMyLDI5LjUgQyAzMiwyOS41IDQwLjUsMjUuNSAzOC4wMywxOS44NSBDIDM0LjE1LDE0IDI1LDE4IDIyLjUsMjQuNSBMIDIyLjUxLDI2LjYgTCAyMi41LDI0LjUgQyAyMCwxOCA5LjkwNiwxNCA2Ljk5NywxOS44NSBDIDQuNSwyNS41IDExLjg1LDI4Ljg1IDExLjg1LDI4Ljg1IiAgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6I2ZmZmZmZjsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gMTEuNSwzMCBDIDE3LDI3IDI3LDI3IDMyLjUsMzAgTSAxMS41LDMzLjUgQyAxNywzMC41IDI3LDMwLjUgMzIuNSwzMy41IE0gMTEuNSwzNyBDIDE3LDM0IDI3LDM0IDMyLjUsMzciICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS2luZ0JsYWNrJywKICAgICAgICBzaXplOiB7IHdpZHRoOiA0MiwgaGVpZ2h0OiAzOCB9CiAgICAgICAgCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlF1ZWVuV2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDojZmZmZmZmOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEsLTEpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSAxMyBBIDIgMiAwIDEgMSAgNSwxMyBBIDIgMiAwIDEgMSAgOSAxMyB6IiAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE1LjUsLTUuNSkiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzIsLTEpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSAxMyBBIDIgMiAwIDEgMSAgNSwxMyBBIDIgMiAwIDEgMSAgOSAxMyB6IiAgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDcsLTQuNSkiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5IDEzIEEgMiAyIDAgMSAxICA1LDEzIEEgMiAyIDAgMSAxICA5IDEzIHoiICAgICAgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjQsLTQpIiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSwyNiBDIDE3LjUsMjQuNSAzMCwyNC41IDM2LDI2IEwgMzgsMTQgTCAzMSwyNSBMIDMxLDExIEwgMjUuNSwyNC41IEwgMjIuNSw5LjUgTCAxOS41LDI0LjUgTCAxNCwxMC41IEwgMTQsMjUgTCA3LDE0IEwgOSwyNiB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSA5LDI2IEMgOSwyOCAxMC41LDI4IDExLjUsMzAgQyAxMi41LDMxLjUgMTIuNSwzMSAxMiwzMy41IEMgMTAuNSwzNC41IDEwLjUsMzYgMTAuNSwzNiBDIDksMzcuNSAxMSwzOC41IDExLDM4LjUgQyAxNy41LDM5LjUgMjcuNSwzOS41IDM0LDM4LjUgQyAzNCwzOC41IDM1LjUsMzcuNSAzNCwzNiBDIDM0LDM2IDM0LjUsMzQuNSAzMywzMy41IEMgMzIuNSwzMSAzMi41LDMxLjUgMzMuNSwzMCBDIDM0LjUsMjggMzYsMjggMzYsMjYgQyAyNy41LDI0LjUgMTcuNSwyNC41IDksMjYgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTEuNSwzMCBDIDE1LDI5IDMwLDI5IDMzLjUsMzAiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzMy41IEMgMTgsMzIuNSAyNywzMi41IDMzLDMzLjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsiIC8+ICA8L2c+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlF1ZWVuV2hpdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDQyLCBoZWlnaHQ6IDM4IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlF1ZWVuQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDojMDAwMDAwOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxnIHN0eWxlPSJmaWxsOiMwMDAwMDA7IHN0cm9rZTpub25lOyI+ICAgICAgPGNpcmNsZSBjeD0iNiIgICAgY3k9IjEyIiByPSIyLjc1IiAvPiAgICAgIDxjaXJjbGUgY3g9IjE0IiAgIGN5PSI5IiAgcj0iMi43NSIgLz4gICAgICA8Y2lyY2xlIGN4PSIyMi41IiBjeT0iOCIgIHI9IjIuNzUiIC8+ICAgICAgPGNpcmNsZSBjeD0iMzEiICAgY3k9IjkiICByPSIyLjc1IiAvPiAgICAgIDxjaXJjbGUgY3g9IjM5IiAgIGN5PSIxMiIgcj0iMi43NSIgLz4gICAgPC9nPiAgICA8cGF0aCAgICAgICBkPSJNIDksMjYgQyAxNy41LDI0LjUgMzAsMjQuNSAzNiwyNiBMIDM4LjUsMTMuNSBMIDMxLDI1IEwgMzAuNywxMC45IEwgMjUuNSwyNC41IEwgMjIuNSwxMCBMIDE5LjUsMjQuNSBMIDE0LjMsMTAuOSBMIDE0LDI1IEwgNi41LDEzLjUgTCA5LDI2IHoiICAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgIGQ9Ik0gOSwyNiBDIDksMjggMTAuNSwyOCAxMS41LDMwIEMgMTIuNSwzMS41IDEyLjUsMzEgMTIsMzMuNSBDIDEwLjUsMzQuNSAxMC41LDM2IDEwLjUsMzYgQyA5LDM3LjUgMTEsMzguNSAxMSwzOC41IEMgMTcuNSwzOS41IDI3LjUsMzkuNSAzNCwzOC41IEMgMzQsMzguNSAzNS41LDM3LjUgMzQsMzYgQyAzNCwzNiAzNC41LDM0LjUgMzMsMzMuNSBDIDMyLjUsMzEgMzIuNSwzMS41IDMzLjUsMzAgQyAzNC41LDI4IDM2LDI4IDM2LDI2IEMgMjcuNSwyNC41IDE3LjUsMjQuNSA5LDI2IHoiICAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMSwzOC41IEEgMzUsMzUgMSAwIDAgMzQsMzguNSIgICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgICBkPSJNIDExLDI5IEEgMzUsMzUgMSAwIDEgMzQsMjkiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMi41LDMxLjUgTCAzMi41LDMxLjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMS41LDM0LjUgQSAzNSwzNSAxIDAgMCAzMy41LDM0LjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICAgZD0iTSAxMC41LDM3LjUgQSAzNSwzNSAxIDAgMCAzNC41LDM3LjUiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuUXVlZW5CbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNDIsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuUm9va1doaXRlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxnIHN0eWxlPSJvcGFjaXR5OjE7IGZpbGw6I2ZmZmZmZjsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpldmVub2RkOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8cGF0aCAgICAgIGQ9Ik0gOSwzOSBMIDM2LDM5IEwgMzYsMzYgTCA5LDM2IEwgOSwzOSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzNiBMIDEyLDMyIEwgMzMsMzIgTCAzMywzNiBMIDEyLDM2IHogIiAgICAgIHN0eWxlPSJzdHJva2UtbGluZWNhcDpidXR0OyIgLz4gICAgPHBhdGggICAgICBkPSJNIDExLDE0IEwgMTEsOSBMIDE1LDkgTCAxNSwxMSBMIDIwLDExIEwgMjAsOSBMIDI1LDkgTCAyNSwxMSBMIDMwLDExIEwgMzAsOSBMIDM0LDkgTCAzNCwxNCIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAzNCwxNCBMIDMxLDE3IEwgMTQsMTcgTCAxMSwxNCIgLz4gICAgPHBhdGggICAgICBkPSJNIDMxLDE3IEwgMzEsMjkuNSBMIDE0LDI5LjUgTCAxNCwxNyIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsgc3Ryb2tlLWxpbmVqb2luOm1pdGVyOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDMxLDI5LjUgTCAzMi41LDMyIEwgMTIuNSwzMiBMIDE0LDI5LjUiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMSwxNCBMIDM0LDE0IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5Sb29rV2hpdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDMyLCBoZWlnaHQ6IDM0IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlJvb2tCbGFjayA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZyBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOiMwMDAwMDA7IGZpbGwtb3BhY2l0eToxOyBmaWxsLXJ1bGU6ZXZlbm9kZDsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2UtbWl0ZXJsaW1pdDo0OyBzdHJva2UtZGFzaGFycmF5Om5vbmU7IHN0cm9rZS1vcGFjaXR5OjE7Ij4gICAgPHBhdGggICAgICBkPSJNIDksMzkgTCAzNiwzOSBMIDM2LDM2IEwgOSwzNiBMIDksMzkgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTIuNSwzMiBMIDE0LDI5LjUgTCAzMSwyOS41IEwgMzIuNSwzMiBMIDEyLjUsMzIgeiAiICAgICAgc3R5bGU9InN0cm9rZS1saW5lY2FwOmJ1dHQ7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTIsMzYgTCAxMiwzMiBMIDMzLDMyIEwgMzMsMzYgTCAxMiwzNiB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxNCwyOS41IEwgMTQsMTYuNSBMIDMxLDE2LjUgTCAzMSwyOS41IEwgMTQsMjkuNSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDtzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMTYuNSBMIDExLDE0IEwgMzQsMTQgTCAzMSwxNi41IEwgMTQsMTYuNSB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMSwxNCBMIDExLDkgTCAxNSw5IEwgMTUsMTEgTCAyMCwxMSBMIDIwLDkgTCAyNSw5IEwgMjUsMTEgTCAzMCwxMSBMIDMwLDkgTCAzNCw5IEwgMzQsMTQgTCAxMSwxNCB6ICIgICAgICBzdHlsZT0ic3Ryb2tlLWxpbmVjYXA6YnV0dDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAxMiwzNS41IEwgMzMsMzUuNSBMIDMzLDM1LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTMsMzEuNSBMIDMyLDMxLjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMjkuNSBMIDMxLDI5LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTQsMTYuNSBMIDMxLDE2LjUiICAgICAgc3R5bGU9ImZpbGw6bm9uZTsgc3Ryb2tlOiNmZmZmZmY7IHN0cm9rZS13aWR0aDoxOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMTEsMTQgTCAzNCwxNCIgICAgICBzdHlsZT0iZmlsbDpub25lOyBzdHJva2U6I2ZmZmZmZjsgc3Ryb2tlLXdpZHRoOjE7IHN0cm9rZS1saW5lam9pbjptaXRlcjsiIC8+ICA8L2c+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlJvb2tCbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzIsIGhlaWdodDogMzQgfQogICAgICAgIAogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5CaXNob3BXaGl0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48ZyBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOm5vbmU7IGZpbGwtcnVsZTpldmVub2RkOyBmaWxsLW9wYWNpdHk6MTsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kOyBzdHJva2UtbGluZWpvaW46cm91bmQ7IHN0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiPiAgICA8ZyBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLWxpbmVjYXA6YnV0dDsiPiAgICAgICA8cGF0aCAgICAgICAgZD0iTSA5LDM2IEMgMTIuMzksMzUuMDMgMTkuMTEsMzYuNDMgMjIuNSwzNCBDIDI1Ljg5LDM2LjQzIDMyLjYxLDM1LjAzIDM2LDM2IEMgMzYsMzYgMzcuNjUsMzYuNTQgMzksMzggQyAzOC4zMiwzOC45NyAzNy4zNSwzOC45OSAzNiwzOC41IEMgMzIuNjEsMzcuNTMgMjUuODksMzguOTYgMjIuNSwzNy41IEMgMTkuMTEsMzguOTYgMTIuMzksMzcuNTMgOSwzOC41IEMgNy42NDYsMzguOTkgNi42NzcsMzguOTcgNiwzOCBDIDcuMzU0LDM2LjA2IDksMzYgOSwzNiB6IiAvPiAgICAgIDxwYXRoICAgICAgICBkPSJNIDE1LDMyIEMgMTcuNSwzNC41IDI3LjUsMzQuNSAzMCwzMiBDIDMwLjUsMzAuNSAzMCwzMCAzMCwzMCBDIDMwLDI3LjUgMjcuNSwyNiAyNy41LDI2IEMgMzMsMjQuNSAzMy41LDE0LjUgMjIuNSwxMC41IEMgMTEuNSwxNC41IDEyLDI0LjUgMTcuNSwyNiBDIDE3LjUsMjYgMTUsMjcuNSAxNSwzMCBDIDE1LDMwIDE0LjUsMzAuNSAxNSwzMiB6IiAvPiAgICAgIDxwYXRoICAgICAgICBkPSJNIDI1IDggQSAyLjUgMi41IDAgMSAxICAyMCw4IEEgMi41IDIuNSAwIDEgMSAgMjUgOCB6IiAvPiAgICA8L2c+ICAgIDxwYXRoICAgICAgZD0iTSAxNy41LDI2IEwgMjcuNSwyNiBNIDE1LDMwIEwgMzAsMzAgTSAyMi41LDE1LjUgTCAyMi41LDIwLjUgTSAyMCwxOCBMIDI1LDE4IiAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojMDAwMDAwOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5CaXNob3BXaGl0ZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuQmlzaG9wQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLXJ1bGU6ZXZlbm9kZDsgZmlsbC1vcGFjaXR5OjE7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDsgc3Ryb2tlLWxpbmVqb2luOnJvdW5kOyBzdHJva2UtbWl0ZXJsaW1pdDo0OyBzdHJva2UtZGFzaGFycmF5Om5vbmU7IHN0cm9rZS1vcGFjaXR5OjE7Ij4gICAgPGcgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS1saW5lY2FwOmJ1dHQ7Ij4gICAgICAgPHBhdGggICAgICAgIGQ9Ik0gOSwzNiBDIDEyLjM5LDM1LjAzIDE5LjExLDM2LjQzIDIyLjUsMzQgQyAyNS44OSwzNi40MyAzMi42MSwzNS4wMyAzNiwzNiBDIDM2LDM2IDM3LjY1LDM2LjU0IDM5LDM4IEMgMzguMzIsMzguOTcgMzcuMzUsMzguOTkgMzYsMzguNSBDIDMyLjYxLDM3LjUzIDI1Ljg5LDM4Ljk2IDIyLjUsMzcuNSBDIDE5LjExLDM4Ljk2IDEyLjM5LDM3LjUzIDksMzguNSBDIDcuNjQ2LDM4Ljk5IDYuNjc3LDM4Ljk3IDYsMzggQyA3LjM1NCwzNi4wNiA5LDM2IDksMzYgeiIgLz4gICAgICA8cGF0aCAgICAgICAgZD0iTSAxNSwzMiBDIDE3LjUsMzQuNSAyNy41LDM0LjUgMzAsMzIgQyAzMC41LDMwLjUgMzAsMzAgMzAsMzAgQyAzMCwyNy41IDI3LjUsMjYgMjcuNSwyNiBDIDMzLDI0LjUgMzMuNSwxNC41IDIyLjUsMTAuNSBDIDExLjUsMTQuNSAxMiwyNC41IDE3LjUsMjYgQyAxNy41LDI2IDE1LDI3LjUgMTUsMzAgQyAxNSwzMCAxNC41LDMwLjUgMTUsMzIgeiIgLz4gICAgICA8cGF0aCAgICAgICAgZD0iTSAyNSA4IEEgMi41IDIuNSAwIDEgMSAgMjAsOCBBIDIuNSAyLjUgMCAxIDEgIDI1IDggeiIgLz4gICAgPC9nPiAgICA8cGF0aCAgICAgICBkPSJNIDE3LjUsMjYgTCAyNy41LDI2IE0gMTUsMzAgTCAzMCwzMCBNIDIyLjUsMTUuNSBMIDIyLjUsMjAuNSBNIDIwLDE4IEwgMjUsMTgiICAgICAgIHN0eWxlPSJmaWxsOm5vbmU7IHN0cm9rZTojZmZmZmZmOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5CaXNob3BCbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzggfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuS25pZ2h0V2hpdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSAyMiwxMCBDIDMyLjUsMTEgMzguNSwxOCAzOCwzOSBMIDE1LDM5IEMgMTUsMzAgMjUsMzIuNSAyMywxOCIgICAgICBzdHlsZT0iZmlsbDojZmZmZmZmOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyNCwxOCBDIDI0LjM4LDIwLjkxIDE4LjQ1LDI1LjM3IDE2LDI3IEMgMTMsMjkgMTMuMTgsMzEuMzQgMTEsMzEgQyA5Ljk1OCwzMC4wNiAxMi40MSwyNy45NiAxMSwyOCBDIDEwLDI4IDExLjE5LDI5LjIzIDEwLDMwIEMgOSwzMCA1Ljk5NywzMSA2LDI2IEMgNiwyNCAxMiwxNCAxMiwxNCBDIDEyLDE0IDEzLjg5LDEyLjEgMTQsMTAuNSBDIDEzLjI3LDkuNTA2IDEzLjUsOC41IDEzLjUsNy41IEMgMTQuNSw2LjUgMTYuNSwxMCAxNi41LDEwIEwgMTguNSwxMCBDIDE4LjUsMTAgMTkuMjgsOC4wMDggMjEsNyBDIDIyLDcgMjIsMTAgMjIsMTAiICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOS41IDI1LjUgQSAwLjUgMC41IDAgMSAxIDguNSwyNS41IEEgMC41IDAuNSAwIDEgMSA5LjUgMjUuNSB6IiAgICAgIHN0eWxlPSJmaWxsOiMwMDAwMDA7IHN0cm9rZTojMDAwMDAwOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDE1IDE1LjUgQSAwLjUgMS41IDAgMSAxICAxNCwxNS41IEEgMC41IDEuNSAwIDEgMSAgMTUgMTUuNSB6IiAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDAuODY2LDAuNSwtMC41LDAuODY2LDkuNjkzLC01LjE3MykiICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgPC9nPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdjaGVzcy5LbmlnaHRXaGl0ZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMzgsIGhlaWdodDogMzcgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuY2hlc3MuS25pZ2h0QmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGcgc3R5bGU9Im9wYWNpdHk6MTsgZmlsbDpub25lOyBmaWxsLW9wYWNpdHk6MTsgZmlsbC1ydWxlOmV2ZW5vZGQ7IHN0cm9rZTojMDAwMDAwOyBzdHJva2Utd2lkdGg6MS41OyBzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46cm91bmQ7c3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyI+ICAgIDxwYXRoICAgICAgZD0iTSAyMiwxMCBDIDMyLjUsMTEgMzguNSwxOCAzOCwzOSBMIDE1LDM5IEMgMTUsMzAgMjUsMzIuNSAyMywxOCIgICAgICBzdHlsZT0iZmlsbDojMDAwMDAwOyBzdHJva2U6IzAwMDAwMDsiIC8+ICAgIDxwYXRoICAgICAgZD0iTSAyNCwxOCBDIDI0LjM4LDIwLjkxIDE4LjQ1LDI1LjM3IDE2LDI3IEMgMTMsMjkgMTMuMTgsMzEuMzQgMTEsMzEgQyA5Ljk1OCwzMC4wNiAxMi40MSwyNy45NiAxMSwyOCBDIDEwLDI4IDExLjE5LDI5LjIzIDEwLDMwIEMgOSwzMCA1Ljk5NywzMSA2LDI2IEMgNiwyNCAxMiwxNCAxMiwxNCBDIDEyLDE0IDEzLjg5LDEyLjEgMTQsMTAuNSBDIDEzLjI3LDkuNTA2IDEzLjUsOC41IDEzLjUsNy41IEMgMTQuNSw2LjUgMTYuNSwxMCAxNi41LDEwIEwgMTguNSwxMCBDIDE4LjUsMTAgMTkuMjgsOC4wMDggMjEsNyBDIDIyLDcgMjIsMTAgMjIsMTAiICAgICAgc3R5bGU9ImZpbGw6IzAwMDAwMDsgc3Ryb2tlOiMwMDAwMDA7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gOS41IDI1LjUgQSAwLjUgMC41IDAgMSAxIDguNSwyNS41IEEgMC41IDAuNSAwIDEgMSA5LjUgMjUuNSB6IiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTojZmZmZmZmOyIgLz4gICAgPHBhdGggICAgICBkPSJNIDE1IDE1LjUgQSAwLjUgMS41IDAgMSAxICAxNCwxNS41IEEgMC41IDEuNSAwIDEgMSAgMTUgMTUuNSB6IiAgICAgIHRyYW5zZm9ybT0ibWF0cml4KDAuODY2LDAuNSwtMC41LDAuODY2LDkuNjkzLC01LjE3MykiICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjsgc3Ryb2tlOiNmZmZmZmY7IiAvPiAgICA8cGF0aCAgICAgIGQ9Ik0gMjQuNTUsMTAuNCBMIDI0LjEsMTEuODUgTCAyNC42LDEyIEMgMjcuNzUsMTMgMzAuMjUsMTQuNDkgMzIuNSwxOC43NSBDIDM0Ljc1LDIzLjAxIDM1Ljc1LDI5LjA2IDM1LjI1LDM5IEwgMzUuMiwzOS41IEwgMzcuNDUsMzkuNSBMIDM3LjUsMzkgQyAzOCwyOC45NCAzNi42MiwyMi4xNSAzNC4yNSwxNy42NiBDIDMxLjg4LDEzLjE3IDI4LjQ2LDExLjAyIDI1LjA2LDEwLjUgTCAyNC41NSwxMC40IHogIiAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7IHN0cm9rZTpub25lOyIgLz4gIDwvZz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuS25pZ2h0QmxhY2snLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDM4LCBoZWlnaHQ6IDM3IH0KCiAgICB9LCBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuZGVmYXVsdHMpCn0pOwoKam9pbnQuc2hhcGVzLmNoZXNzLlBhd25XaGl0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiAnPGcgY2xhc3M9InJvdGF0YWJsZSI+PGcgY2xhc3M9InNjYWxhYmxlIj48cGF0aCBkPSJNIDIyLDkgQyAxOS43OSw5IDE4LDEwLjc5IDE4LDEzIEMgMTgsMTMuODkgMTguMjksMTQuNzEgMTguNzgsMTUuMzggQyAxNi44MywxNi41IDE1LjUsMTguNTkgMTUuNSwyMSBDIDE1LjUsMjMuMDMgMTYuNDQsMjQuODQgMTcuOTEsMjYuMDMgQyAxNC45MSwyNy4wOSAxMC41LDMxLjU4IDEwLjUsMzkuNSBMIDMzLjUsMzkuNSBDIDMzLjUsMzEuNTggMjkuMDksMjcuMDkgMjYuMDksMjYuMDMgQyAyNy41NiwyNC44NCAyOC41LDIzLjAzIDI4LjUsMjEgQyAyOC41LDE4LjU5IDI3LjE3LDE2LjUgMjUuMjIsMTUuMzggQyAyNS43MSwxNC43MSAyNiwxMy44OSAyNiwxMyBDIDI2LDEwLjc5IDI0LjIxLDkgMjIsOSB6ICIgIHN0eWxlPSJvcGFjaXR5OjE7IGZpbGw6I2ZmZmZmZjsgZmlsbC1vcGFjaXR5OjE7IGZpbGwtcnVsZTpub256ZXJvOyBzdHJva2U6IzAwMDAwMDsgc3Ryb2tlLXdpZHRoOjEuNTsgc3Ryb2tlLWxpbmVjYXA6cm91bmQ7IHN0cm9rZS1saW5lam9pbjptaXRlcjsgc3Ryb2tlLW1pdGVybGltaXQ6NDsgc3Ryb2tlLWRhc2hhcnJheTpub25lOyBzdHJva2Utb3BhY2l0eToxOyIgLz48L2c+PC9nPicsCgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnY2hlc3MuUGF3bldoaXRlJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyOCwgaGVpZ2h0OiAzMyB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmpvaW50LnNoYXBlcy5jaGVzcy5QYXduQmxhY2sgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PHBhdGggZD0iTSAyMiw5IEMgMTkuNzksOSAxOCwxMC43OSAxOCwxMyBDIDE4LDEzLjg5IDE4LjI5LDE0LjcxIDE4Ljc4LDE1LjM4IEMgMTYuODMsMTYuNSAxNS41LDE4LjU5IDE1LjUsMjEgQyAxNS41LDIzLjAzIDE2LjQ0LDI0Ljg0IDE3LjkxLDI2LjAzIEMgMTQuOTEsMjcuMDkgMTAuNSwzMS41OCAxMC41LDM5LjUgTCAzMy41LDM5LjUgQyAzMy41LDMxLjU4IDI5LjA5LDI3LjA5IDI2LjA5LDI2LjAzIEMgMjcuNTYsMjQuODQgMjguNSwyMy4wMyAyOC41LDIxIEMgMjguNSwxOC41OSAyNy4xNywxNi41IDI1LjIyLDE1LjM4IEMgMjUuNzEsMTQuNzEgMjYsMTMuODkgMjYsMTMgQyAyNiwxMC43OSAyNC4yMSw5IDIyLDkgeiAiICBzdHlsZT0ib3BhY2l0eToxOyBmaWxsOiMwMDAwMDA7IGZpbGwtb3BhY2l0eToxOyBmaWxsLXJ1bGU6bm9uemVybzsgc3Ryb2tlOiMwMDAwMDA7IHN0cm9rZS13aWR0aDoxLjU7IHN0cm9rZS1saW5lY2FwOnJvdW5kOyBzdHJva2UtbGluZWpvaW46bWl0ZXI7IHN0cm9rZS1taXRlcmxpbWl0OjQ7IHN0cm9rZS1kYXNoYXJyYXk6bm9uZTsgc3Ryb2tlLW9wYWNpdHk6MTsiIC8+PC9nPjwvZz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ2NoZXNzLlBhd25CbGFjaycsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogMjgsIGhlaWdodDogMzMgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7CgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuY2hlc3M7Cn0KCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICB2YXIgam9pbnQgPSB7CiAgICAgICAgdXRpbDogcmVxdWlyZSgnLi4vc3JjL2NvcmUnKS51dGlsLAogICAgICAgIHNoYXBlczogewogICAgICAgICAgICBiYXNpYzogcmVxdWlyZSgnLi9qb2ludC5zaGFwZXMuYmFzaWMnKQogICAgICAgIH0sCiAgICAgICAgZGlhOiB7CiAgICAgICAgICAgIEVsZW1lbnRWaWV3OiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmVsZW1lbnQnKS5FbGVtZW50VmlldywKICAgICAgICAgICAgTGluazogcmVxdWlyZSgnLi4vc3JjL2pvaW50LmRpYS5saW5rJykuTGluawogICAgICAgIH0KICAgIH07Cn0KCmpvaW50LnNoYXBlcy5wbiA9IHt9OwoKam9pbnQuc2hhcGVzLnBuLlBsYWNlID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxjaXJjbGUgY2xhc3M9InJvb3QiLz48ZyBjbGFzcz0idG9rZW5zIiAvPjwvZz48dGV4dCBjbGFzcz0ibGFiZWwiLz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdwbi5QbGFjZScsCiAgICAgICAgc2l6ZTogeyB3aWR0aDogNTAsIGhlaWdodDogNTAgfSwKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLnJvb3QnOiB7CiAgICAgICAgICAgICAgICByOiAyNSwKICAgICAgICAgICAgICAgIGZpbGw6ICd3aGl0ZScsCiAgICAgICAgICAgICAgICBzdHJva2U6ICdibGFjaycsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDI1KScKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy5sYWJlbCc6IHsKICAgICAgICAgICAgICAgICd0ZXh0LWFuY2hvcic6ICdtaWRkbGUnLAogICAgICAgICAgICAgICAgJ3JlZi14JzogLjUsCiAgICAgICAgICAgICAgICAncmVmLXknOiAtMjAsCiAgICAgICAgICAgICAgICByZWY6ICcucm9vdCcsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snLAogICAgICAgICAgICAgICAgJ2ZvbnQtc2l6ZSc6IDEyCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudG9rZW5zID4gY2lyY2xlJzogewogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgIHI6IDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy50b2tlbnMub25lID4gY2lyY2xlJzogeyB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDI1KScgfSwKICAgICAgICAgICAgCiAgICAgICAgICAgICcudG9rZW5zLnR3byA+IGNpcmNsZTpudGgtY2hpbGQoMSknOiB7IHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxOSwgMjUpJyB9LAogICAgICAgICAgICAnLnRva2Vucy50d28gPiBjaXJjbGU6bnRoLWNoaWxkKDIpJzogeyB0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMzEsIDI1KScgfSwKICAgICAgICAgICAgCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgxKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDE4LCAyOSknIH0sCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgyKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDI1LCAxOSknIH0sCiAgICAgICAgICAgICcudG9rZW5zLnRocmVlID4gY2lyY2xlOm50aC1jaGlsZCgzKSc6IHsgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDMyLCAyOSknIH0sCgogICAgICAgICAgICAnLnRva2Vucy5hbG90ID4gdGV4dCc6IHsKCQl0cmFuc2Zvcm06ICd0cmFuc2xhdGUoMjUsIDE4KScsCgkJJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICBmaWxsOiAnYmxhY2snCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCgpqb2ludC5zaGFwZXMucG4uUGxhY2VWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3LmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKICAgICAgICB0aGlzLm1vZGVsLm9uKCdjaGFuZ2U6dG9rZW5zJywgZnVuY3Rpb24oKSB7CgogICAgICAgICAgICB0aGlzLnJlbmRlclRva2VucygpOwogICAgICAgICAgICB0aGlzLnVwZGF0ZSgpOwoKICAgICAgICB9LCB0aGlzKTsKICAgIH0sCgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKCiAgICAgICAgam9pbnQuZGlhLkVsZW1lbnRWaWV3LnByb3RvdHlwZS5yZW5kZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgICAgICAgdGhpcy5yZW5kZXJUb2tlbnMoKTsKICAgICAgICB0aGlzLnVwZGF0ZSgpOwogICAgfSwKCiAgICByZW5kZXJUb2tlbnM6IGZ1bmN0aW9uKCkgewoKICAgICAgICB2YXIgJHRva2VucyA9IHRoaXMuJCgnLnRva2VucycpLmVtcHR5KCk7CiAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCA9ICd0b2tlbnMnOwoKICAgICAgICB2YXIgdG9rZW5zID0gdGhpcy5tb2RlbC5nZXQoJ3Rva2VucycpOwoKICAgICAgICBpZiAoIXRva2VucykgcmV0dXJuOwoKICAgICAgICBzd2l0Y2ggKHRva2VucykgewoKICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCArPSAnIG9uZSc7CiAgICAgICAgICAgICR0b2tlbnMuYXBwZW5kKFYoJzxjaXJjbGUvPicpLm5vZGUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgCiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICR0b2tlbnNbMF0uY2xhc3NOYW1lLmJhc2VWYWwgKz0gJyB0d28nOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAkdG9rZW5zWzBdLmNsYXNzTmFtZS5iYXNlVmFsICs9ICcgdGhyZWUnOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlLCBWKCc8Y2lyY2xlLz4nKS5ub2RlKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgJHRva2Vuc1swXS5jbGFzc05hbWUuYmFzZVZhbCArPSAnIGFsb3QnOwogICAgICAgICAgICAkdG9rZW5zLmFwcGVuZChWKCc8dGV4dC8+JykudGV4dCh0b2tlbnMgKyAnJyApLm5vZGUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICB9Cn0pOwoKCmpvaW50LnNoYXBlcy5wbi5UcmFuc2l0aW9uID0gam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMuZXh0ZW5kKHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0IGNsYXNzPSJyb290Ii8+PC9nPjwvZz48dGV4dCBjbGFzcz0ibGFiZWwiLz4nLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3BuLlRyYW5zaXRpb24nLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDEyLCBoZWlnaHQ6IDUwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJ3JlY3QnOiB7CiAgICAgICAgICAgICAgICB3aWR0aDogMTIsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IDUwLAogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJ2JsYWNrJwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLmxhYmVsJzogewogICAgICAgICAgICAgICAgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAncmVmLXgnOiAuNSwKICAgICAgICAgICAgICAgICdyZWYteSc6IC0yMCwKICAgICAgICAgICAgICAgIHJlZjogJ3JlY3QnLAogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgICdmb250LXNpemUnOiAxMgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMucG4uTGluayA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICBhdHRyczogeyAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JyB9fQogICAgICAgIAogICAgfSwgam9pbnQuZGlhLkxpbmsucHJvdG90eXBlLmRlZmF1bHRzKQp9KTsKCmlmICh0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcpIHsKCiAgICBtb2R1bGUuZXhwb3J0cyA9IGpvaW50LnNoYXBlcy5wbjsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudFZpZXc6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnRWaWV3LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCmpvaW50LnNoYXBlcy5kZXZzID0ge307Cgpqb2ludC5zaGFwZXMuZGV2cy5Nb2RlbCA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZChfLmV4dGVuZCh7fSwgam9pbnQuc2hhcGVzLmJhc2ljLlBvcnRzTW9kZWxJbnRlcmZhY2UsIHsKCiAgICBtYXJrdXA6ICc8ZyBjbGFzcz0icm90YXRhYmxlIj48ZyBjbGFzcz0ic2NhbGFibGUiPjxyZWN0IGNsYXNzPSJib2R5Ii8+PC9nPjx0ZXh0IGNsYXNzPSJsYWJlbCIvPjxnIGNsYXNzPSJpblBvcnRzIi8+PGcgY2xhc3M9Im91dFBvcnRzIi8+PC9nPicsCiAgICBwb3J0TWFya3VwOiAnPGcgY2xhc3M9InBvcnQgcG9ydDwlPSBpZCAlPiI+PGNpcmNsZSBjbGFzcz0icG9ydC1ib2R5Ii8+PHRleHQgY2xhc3M9InBvcnQtbGFiZWwiLz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICdkZXZzLk1vZGVsJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAxLCBoZWlnaHQ6IDEgfSwKICAgICAgICAKICAgICAgICBpblBvcnRzOiBbXSwKICAgICAgICBvdXRQb3J0czogW10sCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcuJzogeyBtYWduZXQ6IGZhbHNlIH0sCiAgICAgICAgICAgICcuYm9keSc6IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAxNTAsIGhlaWdodDogMjUwLAogICAgICAgICAgICAgICAgc3Ryb2tlOiAnYmxhY2snCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcucG9ydC1ib2R5JzogewogICAgICAgICAgICAgICAgcjogMTAsCiAgICAgICAgICAgICAgICBtYWduZXQ6IHRydWUsCiAgICAgICAgICAgICAgICBzdHJva2U6ICdibGFjaycKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdGV4dDogewogICAgICAgICAgICAgICAgZmlsbDogJ2JsYWNrJywKICAgICAgICAgICAgICAgICdwb2ludGVyLWV2ZW50cyc6ICdub25lJwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLmxhYmVsJzogeyB0ZXh0OiAnTW9kZWwnLCAncmVmLXgnOiAuMywgJ3JlZi15JzogLjIgfSwKICAgICAgICAgICAgJy5pblBvcnRzIC5wb3J0LWxhYmVsJzogeyB4Oi0xNSwgZHk6IDQsICd0ZXh0LWFuY2hvcic6ICdlbmQnIH0sCiAgICAgICAgICAgICcub3V0UG9ydHMgLnBvcnQtbGFiZWwnOnsgeDogMTUsIGR5OiA0IH0KICAgICAgICB9CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBnZXRQb3J0QXR0cnM6IGZ1bmN0aW9uKHBvcnROYW1lLCBpbmRleCwgdG90YWwsIHNlbGVjdG9yLCB0eXBlKSB7CgogICAgICAgIHZhciBhdHRycyA9IHt9OwoKICAgICAgICB2YXIgcG9ydENsYXNzID0gJ3BvcnQnICsgaW5kZXg7CiAgICAgICAgdmFyIHBvcnRTZWxlY3RvciA9IHNlbGVjdG9yICsgJz4uJyArIHBvcnRDbGFzczsKICAgICAgICB2YXIgcG9ydExhYmVsU2VsZWN0b3IgPSBwb3J0U2VsZWN0b3IgKyAnPi5wb3J0LWxhYmVsJzsKICAgICAgICB2YXIgcG9ydEJvZHlTZWxlY3RvciA9IHBvcnRTZWxlY3RvciArICc+LnBvcnQtYm9keSc7CgogICAgICAgIGF0dHJzW3BvcnRMYWJlbFNlbGVjdG9yXSA9IHsgdGV4dDogcG9ydE5hbWUgfTsKICAgICAgICBhdHRyc1twb3J0Qm9keVNlbGVjdG9yXSA9IHsgcG9ydDogeyBpZDogcG9ydE5hbWUgfHwgXy51bmlxdWVJZCh0eXBlKSAsIHR5cGU6IHR5cGUgfSB9OwogICAgICAgIGF0dHJzW3BvcnRTZWxlY3Rvcl0gPSB7IHJlZjogJy5ib2R5JywgJ3JlZi15JzogKGluZGV4ICsgMC41KSAqICgxIC8gdG90YWwpIH07CgogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJy5vdXRQb3J0cycpIHsgYXR0cnNbcG9ydFNlbGVjdG9yXVsncmVmLWR4J10gPSAwOyB9CgogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KfSkpOwoKCmpvaW50LnNoYXBlcy5kZXZzLkF0b21pYyA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZGV2cy5BdG9taWMnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDgwLCBoZWlnaHQ6IDgwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5ib2R5JzogeyBmaWxsOiAnc2FsbW9uJyB9LAogICAgICAgICAgICAnLmxhYmVsJzogeyB0ZXh0OiAnQXRvbWljJyB9LAogICAgICAgICAgICAnLmluUG9ydHMgLnBvcnQtYm9keSc6IHsgZmlsbDogJ1BhbGVHcmVlbicgfSwKICAgICAgICAgICAgJy5vdXRQb3J0cyAucG9ydC1ib2R5JzogeyBmaWxsOiAnVG9tYXRvJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLnByb3RvdHlwZS5kZWZhdWx0cykKCn0pOwoKam9pbnQuc2hhcGVzLmRldnMuQ291cGxlZCA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLmV4dGVuZCh7CgogICAgZGVmYXVsdHM6IGpvaW50LnV0aWwuZGVlcFN1cHBsZW1lbnQoewoKICAgICAgICB0eXBlOiAnZGV2cy5Db3VwbGVkJywKICAgICAgICBzaXplOiB7IHdpZHRoOiAyMDAsIGhlaWdodDogMzAwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJy5ib2R5JzogeyBmaWxsOiAnc2VhR3JlZW4nIH0sCiAgICAgICAgICAgICcubGFiZWwnOiB7IHRleHQ6ICdDb3VwbGVkJyB9LAogICAgICAgICAgICAnLmluUG9ydHMgLnBvcnQtYm9keSc6IHsgZmlsbDogJ1BhbGVHcmVlbicgfSwKICAgICAgICAgICAgJy5vdXRQb3J0cyAucG9ydC1ib2R5JzogeyBmaWxsOiAnVG9tYXRvJyB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsLnByb3RvdHlwZS5kZWZhdWx0cykKfSk7Cgpqb2ludC5zaGFwZXMuZGV2cy5MaW5rID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICdkZXZzLkxpbmsnLAogICAgICAgIGF0dHJzOiB7ICcuY29ubmVjdGlvbicgOiB7ICdzdHJva2Utd2lkdGgnIDogIDIgfX0KICAgIH0KfSk7Cgpqb2ludC5zaGFwZXMuZGV2cy5Nb2RlbFZpZXcgPSBqb2ludC5kaWEuRWxlbWVudFZpZXcuZXh0ZW5kKGpvaW50LnNoYXBlcy5iYXNpYy5Qb3J0c1ZpZXdJbnRlcmZhY2UpOwpqb2ludC5zaGFwZXMuZGV2cy5BdG9taWNWaWV3ID0gam9pbnQuc2hhcGVzLmRldnMuTW9kZWxWaWV3Owpqb2ludC5zaGFwZXMuZGV2cy5Db3VwbGVkVmlldyA9IGpvaW50LnNoYXBlcy5kZXZzLk1vZGVsVmlldzsKCgppZiAodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKSB7CgogICAgbW9kdWxlLmV4cG9ydHMgPSBqb2ludC5zaGFwZXMuZGV2czsKfQoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIHZhciBqb2ludCA9IHsKICAgICAgICB1dGlsOiByZXF1aXJlKCcuLi9zcmMvY29yZScpLnV0aWwsCiAgICAgICAgc2hhcGVzOiB7CiAgICAgICAgICAgIGJhc2ljOiByZXF1aXJlKCcuL2pvaW50LnNoYXBlcy5iYXNpYycpCiAgICAgICAgfSwKICAgICAgICBkaWE6IHsKICAgICAgICAgICAgRWxlbWVudFZpZXc6IHJlcXVpcmUoJy4uL3NyYy9qb2ludC5kaWEuZWxlbWVudCcpLkVsZW1lbnRWaWV3LAogICAgICAgICAgICBMaW5rOiByZXF1aXJlKCcuLi9zcmMvam9pbnQuZGlhLmxpbmsnKS5MaW5rCiAgICAgICAgfQogICAgfTsKICAgIHZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7Cn0KCmpvaW50LnNoYXBlcy51bWwgPSB7fQoKam9pbnQuc2hhcGVzLnVtbC5DbGFzcyA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJyb3RhdGFibGUiPicsCiAgICAgICAgICAnPGcgY2xhc3M9InNjYWxhYmxlIj4nLAogICAgICAgICAgICAnPHJlY3QgY2xhc3M9InVtbC1jbGFzcy1uYW1lLXJlY3QiLz48cmVjdCBjbGFzcz0idW1sLWNsYXNzLWF0dHJzLXJlY3QiLz48cmVjdCBjbGFzcz0idW1sLWNsYXNzLW1ldGhvZHMtcmVjdCIvPicsCiAgICAgICAgICAnPC9nPicsCiAgICAgICAgICAnPHRleHQgY2xhc3M9InVtbC1jbGFzcy1uYW1lLXRleHQiLz48dGV4dCBjbGFzcz0idW1sLWNsYXNzLWF0dHJzLXRleHQiLz48dGV4dCBjbGFzcz0idW1sLWNsYXNzLW1ldGhvZHMtdGV4dCIvPicsCiAgICAgICAgJzwvZz4nCiAgICBdLmpvaW4oJycpLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5DbGFzcycsCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgIHJlY3Q6IHsgJ3dpZHRoJzogMjAwIH0sCgogICAgICAgICAgICAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnOiB7ICdzdHJva2UnOiAnYmxhY2snLCAnc3Ryb2tlLXdpZHRoJzogMiwgJ2ZpbGwnOiAnIzM0OThkYicgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtYXR0cnMtcmVjdCc6IHsgJ3N0cm9rZSc6ICdibGFjaycsICdzdHJva2Utd2lkdGgnOiAyLCAnZmlsbCc6ICcjMjk4MGI5JyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1tZXRob2RzLXJlY3QnOiB7ICdzdHJva2UnOiAnYmxhY2snLCAnc3Ryb2tlLXdpZHRoJzogMiwgJ2ZpbGwnOiAnIzI5ODBiOScgfSwKCiAgICAgICAgICAgICcudW1sLWNsYXNzLW5hbWUtdGV4dCc6IHsKICAgICAgICAgICAgICAgICdyZWYnOiAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnLCAncmVmLXknOiAuNSwgJ3JlZi14JzogLjUsICd0ZXh0LWFuY2hvcic6ICdtaWRkbGUnLCAneS1hbGlnbm1lbnQnOiAnbWlkZGxlJywgJ2ZvbnQtd2VpZ2h0JzogJ2JvbGQnLAogICAgICAgICAgICAgICAgJ2ZpbGwnOiAnYmxhY2snLCAnZm9udC1zaXplJzogMTIsICdmb250LWZhbWlseSc6ICdUaW1lcyBOZXcgUm9tYW4nCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudW1sLWNsYXNzLWF0dHJzLXRleHQnOiB7CiAgICAgICAgICAgICAgICAncmVmJzogJy51bWwtY2xhc3MtYXR0cnMtcmVjdCcsICdyZWYteSc6IDUsICdyZWYteCc6IDUsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICdibGFjaycsICdmb250LXNpemUnOiAxMiwgJ2ZvbnQtZmFtaWx5JzogJ1RpbWVzIE5ldyBSb21hbicKICAgICAgICAgICAgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtbWV0aG9kcy10ZXh0JzogewogICAgICAgICAgICAgICAgJ3JlZic6ICcudW1sLWNsYXNzLW1ldGhvZHMtcmVjdCcsICdyZWYteSc6IDUsICdyZWYteCc6IDUsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICdibGFjaycsICdmb250LXNpemUnOiAxMiwgJ2ZvbnQtZmFtaWx5JzogJ1RpbWVzIE5ldyBSb21hbicKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIG5hbWU6IFtdLAogICAgICAgIGF0dHJpYnV0ZXM6IFtdLAogICAgICAgIG1ldGhvZHM6IFtdCgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5vbignY2hhbmdlOm5hbWUgY2hhbmdlOmF0dHJpYnV0ZXMgY2hhbmdlOm1ldGhvZHMnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVSZWN0YW5nbGVzKCk7CgkgICAgdGhpcy50cmlnZ2VyKCd1bWwtdXBkYXRlJyk7CiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHRoaXMudXBkYXRlUmVjdGFuZ2xlcygpOwoKICAgICAgICBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICBnZXRDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmdldCgnbmFtZScpOwogICAgfSwKCiAgICB1cGRhdGVSZWN0YW5nbGVzOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdmFyIGF0dHJzID0gdGhpcy5nZXQoJ2F0dHJzJyk7CgogICAgICAgIHZhciByZWN0cyA9IFsKICAgICAgICAgICAgeyB0eXBlOiAnbmFtZScsIHRleHQ6IHRoaXMuZ2V0Q2xhc3NOYW1lKCkgfSwKICAgICAgICAgICAgeyB0eXBlOiAnYXR0cnMnLCB0ZXh0OiB0aGlzLmdldCgnYXR0cmlidXRlcycpIH0sCiAgICAgICAgICAgIHsgdHlwZTogJ21ldGhvZHMnLCB0ZXh0OiB0aGlzLmdldCgnbWV0aG9kcycpIH0KICAgICAgICBdOwoKICAgICAgICB2YXIgb2Zmc2V0WSA9IDA7CgogICAgICAgIF8uZWFjaChyZWN0cywgZnVuY3Rpb24ocmVjdCkgewoKICAgICAgICAgICAgdmFyIGxpbmVzID0gXy5pc0FycmF5KHJlY3QudGV4dCkgPyByZWN0LnRleHQgOiBbcmVjdC50ZXh0XTsKCSAgICB2YXIgcmVjdEhlaWdodCA9IGxpbmVzLmxlbmd0aCAqIDIwICsgMjA7CgogICAgICAgICAgICBhdHRyc1snLnVtbC1jbGFzcy0nICsgcmVjdC50eXBlICsgJy10ZXh0J10udGV4dCA9IGxpbmVzLmpvaW4oJ1xuJyk7CiAgICAgICAgICAgIGF0dHJzWycudW1sLWNsYXNzLScgKyByZWN0LnR5cGUgKyAnLXJlY3QnXS5oZWlnaHQgPSByZWN0SGVpZ2h0OwogICAgICAgICAgICBhdHRyc1snLnVtbC1jbGFzcy0nICsgcmVjdC50eXBlICsgJy1yZWN0J10udHJhbnNmb3JtID0gJ3RyYW5zbGF0ZSgwLCcrIG9mZnNldFkgKyAnKSc7CgogICAgICAgICAgICBvZmZzZXRZICs9IHJlY3RIZWlnaHQ7CiAgICAgICAgfSk7CiAgICB9Cgp9KTsKCmpvaW50LnNoYXBlcy51bWwuQ2xhc3NWaWV3ID0gam9pbnQuZGlhLkVsZW1lbnRWaWV3LmV4dGVuZCh7CgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGpvaW50LmRpYS5FbGVtZW50Vmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoKCXRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgJ3VtbC11cGRhdGUnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhpcy51cGRhdGUoKTsKICAgICAgICAgICAgdGhpcy5yZXNpemUoKTsKICAgICAgICB9KTsKICAgIH0KfSk7Cgpqb2ludC5zaGFwZXMudW1sLkFic3RyYWN0ID0gam9pbnQuc2hhcGVzLnVtbC5DbGFzcy5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKICAgICAgICB0eXBlOiAndW1sLkFic3RyYWN0JywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLnVtbC1jbGFzcy1uYW1lLXJlY3QnOiB7IGZpbGwgOiAnI2U3NGMzYycgfSwKICAgICAgICAgICAgJy51bWwtY2xhc3MtYXR0cnMtcmVjdCc6IHsgZmlsbCA6ICcjYzAzOTJiJyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1tZXRob2RzLXJlY3QnOiB7IGZpbGwgOiAnI2MwMzkyYicgfQogICAgICAgIH0KICAgIH0sIGpvaW50LnNoYXBlcy51bWwuQ2xhc3MucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBnZXRDbGFzc05hbWU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBbJzw8QWJzdHJhY3Q+PicsIHRoaXMuZ2V0KCduYW1lJyldOwogICAgfQoKfSk7CmpvaW50LnNoYXBlcy51bWwuQWJzdHJhY3RWaWV3ID0gam9pbnQuc2hhcGVzLnVtbC5DbGFzc1ZpZXc7Cgpqb2ludC5zaGFwZXMudW1sLkludGVyZmFjZSA9IGpvaW50LnNoYXBlcy51bWwuQ2xhc3MuZXh0ZW5kKHsKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CiAgICAgICAgdHlwZTogJ3VtbC5JbnRlcmZhY2UnLAogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcudW1sLWNsYXNzLW5hbWUtcmVjdCc6IHsgZmlsbCA6ICcjZjFjNDBmJyB9LAogICAgICAgICAgICAnLnVtbC1jbGFzcy1hdHRycy1yZWN0JzogeyBmaWxsIDogJyNmMzljMTInIH0sCiAgICAgICAgICAgICcudW1sLWNsYXNzLW1ldGhvZHMtcmVjdCc6IHsgZmlsbCA6ICcjZjM5YzEyJyB9CiAgICAgICAgfQogICAgfSwgam9pbnQuc2hhcGVzLnVtbC5DbGFzcy5wcm90b3R5cGUuZGVmYXVsdHMpLAoKICAgIGdldENsYXNzTmFtZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFsnPDxJbnRlcmZhY2U+PicsIHRoaXMuZ2V0KCduYW1lJyldOwogICAgfQoKfSk7CmpvaW50LnNoYXBlcy51bWwuSW50ZXJmYWNlVmlldyA9IGpvaW50LnNoYXBlcy51bWwuQ2xhc3NWaWV3OwoKam9pbnQuc2hhcGVzLnVtbC5HZW5lcmFsaXphdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuR2VuZXJhbGl6YXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gMjAgMCBMIDAgMTAgTCAyMCAyMCB6JywgZmlsbDogJ3doaXRlJyB9fQogICAgfQp9KTsKCmpvaW50LnNoYXBlcy51bWwuSW1wbGVtZW50YXRpb24gPSBqb2ludC5kaWEuTGluay5leHRlbmQoewogICAgZGVmYXVsdHM6IHsKICAgICAgICB0eXBlOiAndW1sLkltcGxlbWVudGF0aW9uJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDIwIDAgTCAwIDEwIEwgMjAgMjAgeicsIGZpbGw6ICd3aGl0ZScgfSwKICAgICAgICAgICAgJy5jb25uZWN0aW9uJzogeyAnc3Ryb2tlLWRhc2hhcnJheSc6ICczLDMnIH0KICAgICAgICB9CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5BZ2dyZWdhdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuQWdncmVnYXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gNDAgMTAgTCAyMCAyMCBMIDAgMTAgTCAyMCAwIHonLCBmaWxsOiAnd2hpdGUnIH19CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5Db21wb3NpdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogewogICAgICAgIHR5cGU6ICd1bWwuQ29tcG9zaXRpb24nLAogICAgICAgIGF0dHJzOiB7ICcubWFya2VyLXRhcmdldCc6IHsgZDogJ00gNDAgMTAgTCAyMCAyMCBMIDAgMTAgTCAyMCAwIHonLCBmaWxsOiAnYmxhY2snIH19CiAgICB9Cn0pOwoKam9pbnQuc2hhcGVzLnVtbC5Bc3NvY2lhdGlvbiA9IGpvaW50LmRpYS5MaW5rLmV4dGVuZCh7CiAgICBkZWZhdWx0czogeyB0eXBlOiAndW1sLkFzc29jaWF0aW9uJyB9Cn0pOwoKLy8gU3RhdGVjaGFydAoKam9pbnQuc2hhcGVzLnVtbC5TdGF0ZSA9IGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLmV4dGVuZCh7CgogICAgbWFya3VwOiBbCiAgICAgICAgJzxnIGNsYXNzPSJyb3RhdGFibGUiPicsCiAgICAgICAgICAnPGcgY2xhc3M9InNjYWxhYmxlIj4nLAogICAgICAgICAgICAnPHJlY3QgY2xhc3M9InVtbC1zdGF0ZS1ib2R5Ii8+JywKICAgICAgICAgICc8L2c+JywKICAgICAgICAgICc8cGF0aCBjbGFzcz0idW1sLXN0YXRlLXNlcGFyYXRvciIvPicsCiAgICAgICAgICAnPHRleHQgY2xhc3M9InVtbC1zdGF0ZS1uYW1lIi8+JywKICAgICAgICAgICc8dGV4dCBjbGFzcz0idW1sLXN0YXRlLWV2ZW50cyIvPicsCiAgICAgICAgJzwvZz4nCiAgICBdLmpvaW4oJycpLAoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5TdGF0ZScsCgogICAgICAgIGF0dHJzOiB7CiAgICAgICAgICAgICcudW1sLXN0YXRlLWJvZHknOiB7CiAgICAgICAgICAgICAgICAnd2lkdGgnOiAyMDAsICdoZWlnaHQnOiAyMDAsICdyeCc6IDEwLCAncnknOiAxMCwKICAgICAgICAgICAgICAgICdmaWxsJzogJyNlY2YwZjEnLCAnc3Ryb2tlJzogJyNiZGMzYzcnLCAnc3Ryb2tlLXdpZHRoJzogMwogICAgICAgICAgICB9LAogICAgICAgICAgICAnLnVtbC1zdGF0ZS1zZXBhcmF0b3InOiB7CiAgICAgICAgICAgICAgICAnc3Ryb2tlJzogJyNiZGMzYzcnLCAnc3Ryb2tlLXdpZHRoJzogMgogICAgICAgICAgICB9LAogICAgICAgICAgICAnLnVtbC1zdGF0ZS1uYW1lJzogewogICAgICAgICAgICAgICAgJ3JlZic6ICcudW1sLXN0YXRlLWJvZHknLCAncmVmLXgnOiAuNSwgJ3JlZi15JzogNSwgJ3RleHQtYW5jaG9yJzogJ21pZGRsZScsCiAgICAgICAgICAgICAgICAnZmlsbCc6ICcjMDAwMDAwJywgJ2ZvbnQtZmFtaWx5JzogJ0NvdXJpZXIgTmV3JywgJ2ZvbnQtc2l6ZSc6IDE0CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICcudW1sLXN0YXRlLWV2ZW50cyc6IHsKICAgICAgICAgICAgICAgICdyZWYnOiAnLnVtbC1zdGF0ZS1zZXBhcmF0b3InLCAncmVmLXgnOiA1LCAncmVmLXknOiA1LAogICAgICAgICAgICAgICAgJ2ZpbGwnOiAnIzAwMDAwMCcsICdmb250LWZhbWlseSc6ICdDb3VyaWVyIE5ldycsICdmb250LXNpemUnOiAxNAogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgbmFtZTogJ1N0YXRlJywKICAgICAgICBldmVudHM6IFtdCgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkdlbmVyaWMucHJvdG90eXBlLmRlZmF1bHRzKSwKCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHsKCiAgICAgICAgdGhpcy5vbih7CiAgICAgICAgICAgICdjaGFuZ2U6bmFtZSc6IHRoaXMudXBkYXRlTmFtZSwKICAgICAgICAgICAgJ2NoYW5nZTpldmVudHMnOiB0aGlzLnVwZGF0ZUV2ZW50cywKICAgICAgICAgICAgJ2NoYW5nZTpzaXplJzogdGhpcy51cGRhdGVQYXRoCiAgICAgICAgfSwgdGhpcyk7CgogICAgICAgIHRoaXMudXBkYXRlTmFtZSgpOwogICAgICAgIHRoaXMudXBkYXRlRXZlbnRzKCk7CiAgICAgICAgdGhpcy51cGRhdGVQYXRoKCk7CgogICAgICAgIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIHVwZGF0ZU5hbWU6IGZ1bmN0aW9uKCkgewoKICAgICAgICB0aGlzLmF0dHIoJy51bWwtc3RhdGUtbmFtZS90ZXh0JywgdGhpcy5nZXQoJ25hbWUnKSk7CiAgICB9LAoKICAgIHVwZGF0ZUV2ZW50czogZnVuY3Rpb24oKSB7CgogICAgICAgIHRoaXMuYXR0cignLnVtbC1zdGF0ZS1ldmVudHMvdGV4dCcsIHRoaXMuZ2V0KCdldmVudHMnKS5qb2luKCdcbicpKTsKICAgIH0sCgogICAgdXBkYXRlUGF0aDogZnVuY3Rpb24oKSB7CgogICAgICAgIHZhciBkID0gJ00gMCAyMCBMICcgKyB0aGlzLmdldCgnc2l6ZScpLndpZHRoICsgJyAyMCc7CgogICAgICAgIC8vIFdlIGFyZSB1c2luZyBgc2lsZW50OiB0cnVlYCBoZXJlIGJlY2F1c2UgdXBkYXRlUGF0aCgpIGlzIG1lYW50IHRvIGJlIGNhbGxlZAogICAgICAgIC8vIG9uIHJlc2l6ZSBhbmQgdGhlcmUncyBubyBuZWVkIHRvIHRvIHVwZGF0ZSB0aGUgZWxlbWVudCB0d2ljZSAoYGNoYW5nZTpzaXplYAogICAgICAgIC8vIHRyaWdnZXJzIGFsc28gYW4gdXBkYXRlKS4KICAgICAgICB0aGlzLmF0dHIoJy51bWwtc3RhdGUtc2VwYXJhdG9yL2QnLCBkLCB7IHNpbGVudDogdHJ1ZSB9KTsKICAgIH0KCn0pOwoKam9pbnQuc2hhcGVzLnVtbC5TdGFydFN0YXRlID0gam9pbnQuc2hhcGVzLmJhc2ljLkNpcmNsZS5leHRlbmQoewoKICAgIGRlZmF1bHRzOiBqb2ludC51dGlsLmRlZXBTdXBwbGVtZW50KHsKCiAgICAgICAgdHlwZTogJ3VtbC5TdGFydFN0YXRlJywKICAgICAgICBhdHRyczogeyBjaXJjbGU6IHsgJ2ZpbGwnOiAnIzM0NDk1ZScsICdzdHJva2UnOiAnIzJjM2U1MCcsICdzdHJva2Utd2lkdGgnOiAyLCAncngnOiAxIH19CgogICAgfSwgam9pbnQuc2hhcGVzLmJhc2ljLkNpcmNsZS5wcm90b3R5cGUuZGVmYXVsdHMpCgp9KTsKCmpvaW50LnNoYXBlcy51bWwuRW5kU3RhdGUgPSBqb2ludC5zaGFwZXMuYmFzaWMuR2VuZXJpYy5leHRlbmQoewoKICAgIG1hcmt1cDogJzxnIGNsYXNzPSJyb3RhdGFibGUiPjxnIGNsYXNzPSJzY2FsYWJsZSI+PGNpcmNsZSBjbGFzcz0ib3V0ZXIiLz48Y2lyY2xlIGNsYXNzPSJpbm5lciIvPjwvZz48L2c+JywKCiAgICBkZWZhdWx0czogam9pbnQudXRpbC5kZWVwU3VwcGxlbWVudCh7CgogICAgICAgIHR5cGU6ICd1bWwuRW5kU3RhdGUnLAogICAgICAgIHNpemU6IHsgd2lkdGg6IDIwLCBoZWlnaHQ6IDIwIH0sCiAgICAgICAgYXR0cnM6IHsKICAgICAgICAgICAgJ2NpcmNsZS5vdXRlcic6IHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogJ3RyYW5zbGF0ZSgxMCwgMTApJywKICAgICAgICAgICAgICAgIHI6IDEwLAogICAgICAgICAgICAgICAgZmlsbDogJ3doaXRlJywKICAgICAgICAgICAgICAgIHN0cm9rZTogJyMyYzNlNTAnCiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAnY2lyY2xlLmlubmVyJzogewogICAgICAgICAgICAgICAgdHJhbnNmb3JtOiAndHJhbnNsYXRlKDEwLCAxMCknLAogICAgICAgICAgICAgICAgcjogNiwKICAgICAgICAgICAgICAgIGZpbGw6ICcjMzQ0OTVlJwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sIGpvaW50LnNoYXBlcy5iYXNpYy5HZW5lcmljLnByb3RvdHlwZS5kZWZhdWx0cykKCn0pOwoKam9pbnQuc2hhcGVzLnVtbC5UcmFuc2l0aW9uID0gam9pbnQuZGlhLkxpbmsuZXh0ZW5kKHsKICAgIGRlZmF1bHRzOiB7CiAgICAgICAgdHlwZTogJ3VtbC5UcmFuc2l0aW9uJywKICAgICAgICBhdHRyczogewogICAgICAgICAgICAnLm1hcmtlci10YXJnZXQnOiB7IGQ6ICdNIDEwIDAgTCAwIDUgTCAxMCAxMCB6JywgZmlsbDogJyMzNDQ5NWUnLCBzdHJva2U6ICcjMmMzZTUwJyB9LAogICAgICAgICAgICAnLmNvbm5lY3Rpb24nOiB7IHN0cm9rZTogJyMyYzNlNTAnIH0KICAgICAgICB9CiAgICB9Cn0pOwoKaWYgKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewoKICAgIG1vZHVsZS5leHBvcnRzID0gam9pbnQuc2hhcGVzLnVtbDsKfQoKOyhmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09ImZ1bmN0aW9uIiYmcmVxdWlyZTtpZighdSYmYSlyZXR1cm4gYShvLCEwKTtpZihpKXJldHVybiBpKG8sITApO3Rocm93IG5ldyBFcnJvcigiQ2Fubm90IGZpbmQgbW9kdWxlICciK28rIiciKX12YXIgZj1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwoZi5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxmLGYuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT0iZnVuY3Rpb24iJiZyZXF1aXJlO2Zvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXMocltvXSk7cmV0dXJuIHN9KSh7MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBnbG9iYWw9dHlwZW9mIHNlbGYgIT09ICJ1bmRlZmluZWQiID8gc2VsZiA6IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93IDoge307LyoqCiAqIEBsaWNlbnNlCiAqIENvcHlyaWdodCAoYykgMjAxMi0yMDEzIENocmlzIFBldHRpdHQKICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAqCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCiAqIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTgogKiBUSEUgU09GVFdBUkUuCiAqLwpnbG9iYWwuZGFncmUgPSByZXF1aXJlKCIuL2luZGV4Iik7Cgp9LHsiLi9pbmRleCI6Mn1dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKgpDb3B5cmlnaHQgKGMpIDIwMTItMjAxMyBDaHJpcyBQZXR0aXR0CgpQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Cm9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCmluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbApjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKClRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluCmFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCkZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQpBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCkxJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCk9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4KVEhFIFNPRlRXQVJFLgoqLwpleHBvcnRzLkRpZ3JhcGggPSByZXF1aXJlKCJncmFwaGxpYiIpLkRpZ3JhcGg7CmV4cG9ydHMuR3JhcGggPSByZXF1aXJlKCJncmFwaGxpYiIpLkdyYXBoOwpleHBvcnRzLmxheW91dCA9IHJlcXVpcmUoIi4vbGliL2xheW91dCIpOwpleHBvcnRzLnZlcnNpb24gPSByZXF1aXJlKCIuL2xpYi92ZXJzaW9uIik7Cgp9LHsiLi9saWIvbGF5b3V0IjozLCIuL2xpYi92ZXJzaW9uIjoxOCwiZ3JhcGhsaWIiOjI0fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyksCiAgICByYW5rID0gcmVxdWlyZSgnLi9yYW5rJyksCiAgICBvcmRlciA9IHJlcXVpcmUoJy4vb3JkZXInKSwKICAgIENHcmFwaCA9IHJlcXVpcmUoJ2dyYXBobGliJykuQ0dyYXBoLAogICAgQ0RpZ3JhcGggPSByZXF1aXJlKCdncmFwaGxpYicpLkNEaWdyYXBoOwoKbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbigpIHsKICAvLyBFeHRlcm5hbCBjb25maWd1cmF0aW9uCiAgdmFyIGNvbmZpZyA9IHsKICAgIC8vIEhvdyBtdWNoIGRlYnVnIGluZm9ybWF0aW9uIHRvIGluY2x1ZGU/CiAgICBkZWJ1Z0xldmVsOiAwLAogICAgLy8gTWF4IG51bWJlciBvZiBzd2VlcHMgdG8gcGVyZm9ybSBpbiBvcmRlciBwaGFzZQogICAgb3JkZXJNYXhTd2VlcHM6IG9yZGVyLkRFRkFVTFRfTUFYX1NXRUVQUywKICAgIC8vIFVzZSBuZXR3b3JrIHNpbXBsZXggYWxnb3JpdGhtIGluIHJhbmtpbmcKICAgIHJhbmtTaW1wbGV4OiBmYWxzZSwKICAgIC8vIFJhbmsgZGlyZWN0aW9uLiBWYWxpZCB2YWx1ZXMgYXJlIChUQiwgTFIpCiAgICByYW5rRGlyOiAnVEInCiAgfTsKCiAgLy8gUGhhc2UgZnVuY3Rpb25zCiAgdmFyIHBvc2l0aW9uID0gcmVxdWlyZSgnLi9wb3NpdGlvbicpKCk7CgogIC8vIFRoaXMgbGF5b3V0IG9iamVjdAogIHZhciBzZWxmID0ge307CgogIHNlbGYub3JkZXJJdGVycyA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdvcmRlck1heFN3ZWVwcycpOwoKICBzZWxmLnJhbmtTaW1wbGV4ID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ3JhbmtTaW1wbGV4Jyk7CgogIHNlbGYubm9kZVNlcCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24ubm9kZVNlcCk7CiAgc2VsZi5lZGdlU2VwID0gZGVsZWdhdGVQcm9wZXJ0eShwb3NpdGlvbi5lZGdlU2VwKTsKICBzZWxmLnVuaXZlcnNhbFNlcCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24udW5pdmVyc2FsU2VwKTsKICBzZWxmLnJhbmtTZXAgPSBkZWxlZ2F0ZVByb3BlcnR5KHBvc2l0aW9uLnJhbmtTZXApOwogIHNlbGYucmFua0RpciA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdyYW5rRGlyJyk7CiAgc2VsZi5kZWJ1Z0FsaWdubWVudCA9IGRlbGVnYXRlUHJvcGVydHkocG9zaXRpb24uZGVidWdBbGlnbm1lbnQpOwoKICBzZWxmLmRlYnVnTGV2ZWwgPSB1dGlsLnByb3BlcnR5QWNjZXNzb3Ioc2VsZiwgY29uZmlnLCAnZGVidWdMZXZlbCcsIGZ1bmN0aW9uKHgpIHsKICAgIHV0aWwubG9nLmxldmVsID0geDsKICAgIHBvc2l0aW9uLmRlYnVnTGV2ZWwoeCk7CiAgfSk7CgogIHNlbGYucnVuID0gdXRpbC50aW1lKCdUb3RhbCBsYXlvdXQnLCBydW4pOwoKICBzZWxmLl9ub3JtYWxpemUgPSBub3JtYWxpemU7CgogIHJldHVybiBzZWxmOwoKICAvKgogICAqIENvbnN0cnVjdHMgYW4gYWRqYWNlbmN5IGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgc3BlY2lmaWVkIHRocm91Z2gKICAgKiBjb25maWcuIEZvciBlYWNoIG5vZGUgYW5kIGVkZ2Ugd2UgYWRkIGEgcHJvcGVydHkgYGRhZ3JlYCB0aGF0IGNvbnRhaW5zIGFuCiAgICogb2JqZWN0IHRoYXQgd2lsbCBob2xkIGludGVybWVkaWF0ZSBhbmQgZmluYWwgbGF5b3V0IGluZm9ybWF0aW9uLiBTb21lIG9mCiAgICogdGhlIGNvbnRlbnRzIGluY2x1ZGU6CiAgICoKICAgKiAgMSkgQSBnZW5lcmF0ZWQgSUQgdGhhdCB1bmlxdWVseSBpZGVudGlmaWVzIHRoZSBvYmplY3QuCiAgICogIDIpIERpbWVuc2lvbiBpbmZvcm1hdGlvbiBmb3Igbm9kZXMgKGNvcGllZCBmcm9tIHRoZSBzb3VyY2Ugbm9kZSkuCiAgICogIDMpIE9wdGlvbmFsIGRpbWVuc2lvbiBpbmZvcm1hdGlvbiBmb3IgZWRnZXMuCiAgICoKICAgKiBBZnRlciB0aGUgYWRqYWNlbmN5IGdyYXBoIGlzIGNvbnN0cnVjdGVkIHRoZSBjb2RlIG5vIGxvbmdlciBuZWVkcyB0byB1c2UKICAgKiB0aGUgb3JpZ2luYWwgbm9kZXMgYW5kIGVkZ2VzIHBhc3NlZCBpbiB2aWEgY29uZmlnLgogICAqLwogIGZ1bmN0aW9uIGluaXRMYXlvdXRHcmFwaChpbnB1dEdyYXBoKSB7CiAgICB2YXIgZyA9IG5ldyBDRGlncmFwaCgpOwoKICAgIGlucHV0R3JhcGguZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHZhbHVlID0ge307CiAgICAgIGcuYWRkTm9kZSh1LCB7CiAgICAgICAgd2lkdGg6IHZhbHVlLndpZHRoLAogICAgICAgIGhlaWdodDogdmFsdWUuaGVpZ2h0CiAgICAgIH0pOwogICAgICBpZiAodmFsdWUuaGFzT3duUHJvcGVydHkoJ3JhbmsnKSkgewogICAgICAgIGcubm9kZSh1KS5wcmVmUmFuayA9IHZhbHVlLnJhbms7CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIFNldCB1cCBzdWJncmFwaHMKICAgIGlmIChpbnB1dEdyYXBoLnBhcmVudCkgewogICAgICBpbnB1dEdyYXBoLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgICAgZy5wYXJlbnQodSwgaW5wdXRHcmFwaC5wYXJlbnQodSkpOwogICAgICB9KTsKICAgIH0KCiAgICBpbnB1dEdyYXBoLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB2YWx1ZSA9IHt9OwogICAgICB2YXIgbmV3VmFsdWUgPSB7CiAgICAgICAgZTogZSwKICAgICAgICBtaW5MZW46IHZhbHVlLm1pbkxlbiB8fCAxLAogICAgICAgIHdpZHRoOiB2YWx1ZS53aWR0aCB8fCAwLAogICAgICAgIGhlaWdodDogdmFsdWUuaGVpZ2h0IHx8IDAsCiAgICAgICAgcG9pbnRzOiBbXQogICAgICB9OwoKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIG5ld1ZhbHVlKTsKICAgIH0pOwoKICAgIC8vIEluaXRpYWwgZ3JhcGggYXR0cmlidXRlcwogICAgdmFyIGdyYXBoVmFsdWUgPSBpbnB1dEdyYXBoLmdyYXBoKCkgfHwge307CiAgICBnLmdyYXBoKHsKICAgICAgcmFua0RpcjogZ3JhcGhWYWx1ZS5yYW5rRGlyIHx8IGNvbmZpZy5yYW5rRGlyLAogICAgICBvcmRlclJlc3RhcnRzOiBncmFwaFZhbHVlLm9yZGVyUmVzdGFydHMKICAgIH0pOwoKICAgIHJldHVybiBnOwogIH0KCiAgZnVuY3Rpb24gcnVuKGlucHV0R3JhcGgpIHsKICAgIHZhciByYW5rU2VwID0gc2VsZi5yYW5rU2VwKCk7CiAgICB2YXIgZzsKICAgIHRyeSB7CiAgICAgIC8vIEJ1aWxkIGludGVybmFsIGdyYXBoCiAgICAgIGcgPSB1dGlsLnRpbWUoJ2luaXRMYXlvdXRHcmFwaCcsIGluaXRMYXlvdXRHcmFwaCkoaW5wdXRHcmFwaCk7CgogICAgICBpZiAoZy5vcmRlcigpID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGc7CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3BhY2UgZm9yIGVkZ2UgbGFiZWxzCiAgICAgIGcuZWFjaEVkZ2UoZnVuY3Rpb24oZSwgcywgdCwgYSkgewogICAgICAgIGEubWluTGVuICo9IDI7CiAgICAgIH0pOwogICAgICBzZWxmLnJhbmtTZXAocmFua1NlcCAvIDIpOwoKICAgICAgLy8gRGV0ZXJtaW5lIHRoZSByYW5rIGZvciBlYWNoIG5vZGUuIE5vZGVzIHdpdGggYSBsb3dlciByYW5rIHdpbGwgYXBwZWFyCiAgICAgIC8vIGFib3ZlIG5vZGVzIG9mIGhpZ2hlciByYW5rLgogICAgICB1dGlsLnRpbWUoJ3JhbmsucnVuJywgcmFuay5ydW4pKGcsIGNvbmZpZy5yYW5rU2ltcGxleCk7CgogICAgICAvLyBOb3JtYWxpemUgdGhlIGdyYXBoIGJ5IGVuc3VyaW5nIHRoYXQgZXZlcnkgZWRnZSBpcyBwcm9wZXIgKGVhY2ggZWRnZSBoYXMKICAgICAgLy8gYSBsZW5ndGggb2YgMSkuIFdlIGFjaGlldmUgdGhpcyBieSBhZGRpbmcgZHVtbXkgbm9kZXMgdG8gbG9uZyBlZGdlcywKICAgICAgLy8gdGh1cyBzaG9ydGVuaW5nIHRoZW0uCiAgICAgIHV0aWwudGltZSgnbm9ybWFsaXplJywgbm9ybWFsaXplKShnKTsKCiAgICAgIC8vIE9yZGVyIHRoZSBub2RlcyBzbyB0aGF0IGVkZ2UgY3Jvc3NpbmdzIGFyZSBtaW5pbWl6ZWQuCiAgICAgIHV0aWwudGltZSgnb3JkZXInLCBvcmRlcikoZywgY29uZmlnLm9yZGVyTWF4U3dlZXBzKTsKCiAgICAgIC8vIEZpbmQgdGhlIHggYW5kIHkgY29vcmRpbmF0ZXMgZm9yIGV2ZXJ5IG5vZGUgaW4gdGhlIGdyYXBoLgogICAgICB1dGlsLnRpbWUoJ3Bvc2l0aW9uJywgcG9zaXRpb24ucnVuKShnKTsKCiAgICAgIC8vIERlLW5vcm1hbGl6ZSB0aGUgZ3JhcGggYnkgcmVtb3ZpbmcgZHVtbXkgbm9kZXMgYW5kIGF1Z21lbnRpbmcgdGhlCiAgICAgIC8vIG9yaWdpbmFsIGxvbmcgZWRnZXMgd2l0aCBjb29yZGluYXRlIGluZm9ybWF0aW9uLgogICAgICB1dGlsLnRpbWUoJ3VuZG9Ob3JtYWxpemUnLCB1bmRvTm9ybWFsaXplKShnKTsKCiAgICAgIC8vIFJldmVyc2VzIHBvaW50cyBmb3IgZWRnZXMgdGhhdCBhcmUgaW4gYSByZXZlcnNlZCBzdGF0ZS4KICAgICAgdXRpbC50aW1lKCdmaXh1cEVkZ2VQb2ludHMnLCBmaXh1cEVkZ2VQb2ludHMpKGcpOwoKICAgICAgLy8gUmVzdG9yZSBkZWxldGUgZWRnZXMgYW5kIHJldmVyc2UgZWRnZXMgdGhhdCB3ZXJlIHJldmVyc2VkIGluIHRoZSByYW5rCiAgICAgIC8vIHBoYXNlLgogICAgICB1dGlsLnRpbWUoJ3JhbmsucmVzdG9yZUVkZ2VzJywgcmFuay5yZXN0b3JlRWRnZXMpKGcpOwoKICAgICAgLy8gQ29uc3RydWN0IGZpbmFsIHJlc3VsdCBncmFwaCBhbmQgcmV0dXJuIGl0CiAgICAgIHJldHVybiB1dGlsLnRpbWUoJ2NyZWF0ZUZpbmFsR3JhcGgnLCBjcmVhdGVGaW5hbEdyYXBoKShnLCBpbnB1dEdyYXBoLmlzRGlyZWN0ZWQoKSk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZWxmLnJhbmtTZXAocmFua1NlcCk7CiAgICB9CiAgfQoKICAvKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgcmVzcG9uc2libGUgZm9yICdub3JtYWxpemluZycgdGhlIGdyYXBoLiBUaGUgcHJvY2VzcyBvZgogICAqIG5vcm1hbGl6YXRpb24gZW5zdXJlcyB0aGF0IG5vIGVkZ2UgaW4gdGhlIGdyYXBoIGhhcyBzcGFucyBtb3JlIHRoYW4gb25lCiAgICogcmFuay4gVG8gZG8gdGhpcyBpdCBpbnNlcnRzIGR1bW15IG5vZGVzIGFzIG5lZWRlZCBhbmQgbGlua3MgdGhlbSBieSBhZGRpbmcKICAgKiBkdW1teSBlZGdlcy4gVGhpcyBmdW5jdGlvbiBrZWVwcyBlbm91Z2ggaW5mb3JtYXRpb24gaW4gdGhlIGR1bW15IG5vZGVzIGFuZAogICAqIGVkZ2VzIHRvIGVuc3VyZSB0aGF0IHRoZSBvcmlnaW5hbCBncmFwaCBjYW4gYmUgcmVjb25zdHJ1Y3RlZCBsYXRlci4KICAgKgogICAqIFRoaXMgbWV0aG9kIGFzc3VtZXMgdGhhdCB0aGUgaW5wdXQgZ3JhcGggaXMgY3ljbGUgZnJlZS4KICAgKi8KICBmdW5jdGlvbiBub3JtYWxpemUoZykgewogICAgdmFyIGR1bW15Q291bnQgPSAwOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCBzLCB0LCBhKSB7CiAgICAgIHZhciBzb3VyY2VSYW5rID0gZy5ub2RlKHMpLnJhbms7CiAgICAgIHZhciB0YXJnZXRSYW5rID0gZy5ub2RlKHQpLnJhbms7CiAgICAgIGlmIChzb3VyY2VSYW5rICsgMSA8IHRhcmdldFJhbmspIHsKICAgICAgICBmb3IgKHZhciB1ID0gcywgcmFuayA9IHNvdXJjZVJhbmsgKyAxLCBpID0gMDsgcmFuayA8IHRhcmdldFJhbms7ICsrcmFuaywgKytpKSB7CiAgICAgICAgICB2YXIgdiA9ICdfRCcgKyAoKytkdW1teUNvdW50KTsKICAgICAgICAgIHZhciBub2RlID0gewogICAgICAgICAgICB3aWR0aDogYS53aWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBhLmhlaWdodCwKICAgICAgICAgICAgZWRnZTogeyBpZDogZSwgc291cmNlOiBzLCB0YXJnZXQ6IHQsIGF0dHJzOiBhIH0sCiAgICAgICAgICAgIHJhbms6IHJhbmssCiAgICAgICAgICAgIGR1bW15OiB0cnVlCiAgICAgICAgICB9OwoKICAgICAgICAgIC8vIElmIHRoaXMgbm9kZSByZXByZXNlbnRzIGEgYmVuZCB0aGVuIHdlIHdpbGwgdXNlIGl0IGFzIGEgY29udHJvbAogICAgICAgICAgLy8gcG9pbnQuIEZvciBlZGdlcyB3aXRoIDIgc2VnbWVudHMgdGhpcyB3aWxsIGJlIHRoZSBjZW50ZXIgZHVtbXkKICAgICAgICAgIC8vIG5vZGUuIEZvciBlZGdlcyB3aXRoIG1vcmUgdGhhbiB0d28gc2VnbWVudHMsIHRoaXMgd2lsbCBiZSB0aGUKICAgICAgICAgIC8vIGZpcnN0IGFuZCBsYXN0IGR1bW15IG5vZGUuCiAgICAgICAgICBpZiAoaSA9PT0gMCkgbm9kZS5pbmRleCA9IDA7CiAgICAgICAgICBlbHNlIGlmIChyYW5rICsgMSA9PT0gdGFyZ2V0UmFuaykgbm9kZS5pbmRleCA9IDE7CgogICAgICAgICAgZy5hZGROb2RlKHYsIG5vZGUpOwogICAgICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHt9KTsKICAgICAgICAgIHUgPSB2OwogICAgICAgIH0KICAgICAgICBnLmFkZEVkZ2UobnVsbCwgdSwgdCwge30pOwogICAgICAgIGcuZGVsRWRnZShlKTsKICAgICAgfQogICAgfSk7CiAgfQoKICAvKgogICAqIFJlY29uc3RydWN0cyB0aGUgZ3JhcGggYXMgaXQgd2FzIGJlZm9yZSBub3JtYWxpemF0aW9uLiBUaGUgcG9zaXRpb25zIG9mCiAgICogZHVtbXkgbm9kZXMgYXJlIHVzZWQgdG8gYnVpbGQgYW4gYXJyYXkgb2YgcG9pbnRzIGZvciB0aGUgb3JpZ2luYWwgJ2xvbmcnCiAgICogZWRnZS4gRHVtbXkgbm9kZXMgYW5kIGVkZ2VzIGFyZSByZW1vdmVkLgogICAqLwogIGZ1bmN0aW9uIHVuZG9Ob3JtYWxpemUoZykgewogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1LCBhKSB7CiAgICAgIGlmIChhLmR1bW15KSB7CiAgICAgICAgaWYgKCdpbmRleCcgaW4gYSkgewogICAgICAgICAgdmFyIGVkZ2UgPSBhLmVkZ2U7CiAgICAgICAgICBpZiAoIWcuaGFzRWRnZShlZGdlLmlkKSkgewogICAgICAgICAgICBnLmFkZEVkZ2UoZWRnZS5pZCwgZWRnZS5zb3VyY2UsIGVkZ2UudGFyZ2V0LCBlZGdlLmF0dHJzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwb2ludHMgPSBnLmVkZ2UoZWRnZS5pZCkucG9pbnRzOwogICAgICAgICAgcG9pbnRzW2EuaW5kZXhdID0geyB4OiBhLngsIHk6IGEueSwgdWw6IGEudWwsIHVyOiBhLnVyLCBkbDogYS5kbCwgZHI6IGEuZHIgfTsKICAgICAgICB9CiAgICAgICAgZy5kZWxOb2RlKHUpOwogICAgICB9CiAgICB9KTsKICB9CgogIC8qCiAgICogRm9yIGVhY2ggZWRnZSB0aGF0IHdhcyByZXZlcnNlZCBkdXJpbmcgdGhlIGBhY3ljbGljYCBzdGVwLCByZXZlcnNlIGl0cwogICAqIGFycmF5IG9mIHBvaW50cy4KICAgKi8KICBmdW5jdGlvbiBmaXh1cEVkZ2VQb2ludHMoZykgewogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCBzLCB0LCBhKSB7IGlmIChhLnJldmVyc2VkKSBhLnBvaW50cy5yZXZlcnNlKCk7IH0pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlRmluYWxHcmFwaChnLCBpc0RpcmVjdGVkKSB7CiAgICB2YXIgb3V0ID0gaXNEaXJlY3RlZCA/IG5ldyBDRGlncmFwaCgpIDogbmV3IENHcmFwaCgpOwogICAgb3V0LmdyYXBoKGcuZ3JhcGgoKSk7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7IG91dC5hZGROb2RlKHUsIHZhbHVlKTsgfSk7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsgb3V0LnBhcmVudCh1LCBnLnBhcmVudCh1KSk7IH0pOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgICBvdXQuYWRkRWRnZSh2YWx1ZS5lLCB1LCB2LCB2YWx1ZSk7CiAgICB9KTsKCiAgICAvLyBBdHRhY2ggYm91bmRpbmcgYm94IGluZm9ybWF0aW9uCiAgICB2YXIgbWF4WCA9IDAsIG1heFkgPSAwOwogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgewogICAgICBpZiAoIWcuY2hpbGRyZW4odSkubGVuZ3RoKSB7CiAgICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIHZhbHVlLnggKyB2YWx1ZS53aWR0aCAvIDIpOwogICAgICAgIG1heFkgPSBNYXRoLm1heChtYXhZLCB2YWx1ZS55ICsgdmFsdWUuaGVpZ2h0IC8gMik7CiAgICAgIH0KICAgIH0pOwogICAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgICB2YXIgbWF4WFBvaW50cyA9IE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlLnBvaW50cy5tYXAoZnVuY3Rpb24ocCkgeyByZXR1cm4gcC54OyB9KSk7CiAgICAgIHZhciBtYXhZUG9pbnRzID0gTWF0aC5tYXguYXBwbHkoTWF0aCwgdmFsdWUucG9pbnRzLm1hcChmdW5jdGlvbihwKSB7IHJldHVybiBwLnk7IH0pKTsKICAgICAgbWF4WCA9IE1hdGgubWF4KG1heFgsIG1heFhQb2ludHMgKyB2YWx1ZS53aWR0aCAvIDIpOwogICAgICBtYXhZID0gTWF0aC5tYXgobWF4WSwgbWF4WVBvaW50cyArIHZhbHVlLmhlaWdodCAvIDIpOwogICAgfSk7CiAgICBvdXQuZ3JhcGgoKS53aWR0aCA9IG1heFg7CiAgICBvdXQuZ3JhcGgoKS5oZWlnaHQgPSBtYXhZOwoKICAgIHJldHVybiBvdXQ7CiAgfQoKICAvKgogICAqIEdpdmVuIGEgZnVuY3Rpb24sIGEgbmV3IGZ1bmN0aW9uIGlzIHJldHVybmVkIHRoYXQgaW52b2tlcyB0aGUgZ2l2ZW4KICAgKiBmdW5jdGlvbi4gVGhlIHJldHVybiB2YWx1ZSBmcm9tIHRoZSBmdW5jdGlvbiBpcyBhbHdheXMgdGhlIGBzZWxmYCBvYmplY3QuCiAgICovCiAgZnVuY3Rpb24gZGVsZWdhdGVQcm9wZXJ0eShmKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGYoKTsKICAgICAgZi5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICByZXR1cm4gc2VsZjsKICAgIH07CiAgfQp9OwoKCn0seyIuL29yZGVyIjo0LCIuL3Bvc2l0aW9uIjo5LCIuL3JhbmsiOjEwLCIuL3V0aWwiOjE3LCJncmFwaGxpYiI6MjR9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKSwKICAgIGNyb3NzQ291bnQgPSByZXF1aXJlKCcuL29yZGVyL2Nyb3NzQ291bnQnKSwKICAgIGluaXRMYXllckdyYXBocyA9IHJlcXVpcmUoJy4vb3JkZXIvaW5pdExheWVyR3JhcGhzJyksCiAgICBpbml0T3JkZXIgPSByZXF1aXJlKCcuL29yZGVyL2luaXRPcmRlcicpLAogICAgc29ydExheWVyID0gcmVxdWlyZSgnLi9vcmRlci9zb3J0TGF5ZXInKTsKCm1vZHVsZS5leHBvcnRzID0gb3JkZXI7CgovLyBUaGUgbWF4aW11bSBudW1iZXIgb2Ygc3dlZXBzIHRvIHBlcmZvcm0gYmVmb3JlIGZpbmlzaGluZyB0aGUgb3JkZXIgcGhhc2UuCnZhciBERUZBVUxUX01BWF9TV0VFUFMgPSAyNDsKb3JkZXIuREVGQVVMVF9NQVhfU1dFRVBTID0gREVGQVVMVF9NQVhfU1dFRVBTOwoKLyoKICogUnVucyB0aGUgb3JkZXIgcGhhc2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGBncmFwaCwgYG1heFN3ZWVwc2AsIGFuZAogKiBgZGVidWdMZXZlbGAuIElmIGBtYXhTd2VlcHNgIGlzIG5vdCBzcGVjaWZpZWQgd2UgdXNlIGBERUZBVUxUX01BWF9TV0VFUFNgLgogKiBJZiBgZGVidWdMZXZlbGAgaXMgbm90IHNldCB3ZSBhc3N1bWUgMC4KICovCmZ1bmN0aW9uIG9yZGVyKGcsIG1heFN3ZWVwcykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMikgewogICAgbWF4U3dlZXBzID0gREVGQVVMVF9NQVhfU1dFRVBTOwogIH0KCiAgdmFyIHJlc3RhcnRzID0gZy5ncmFwaCgpLm9yZGVyUmVzdGFydHMgfHwgMDsKCiAgdmFyIGxheWVyR3JhcGhzID0gaW5pdExheWVyR3JhcGhzKGcpOwogIC8vIFRPRE86IHJlbW92ZSB0aGlzIHdoZW4gd2UgYWRkIGJhY2sgc3VwcG9ydCBmb3Igb3JkZXJpbmcgY2x1c3RlcnMKICBsYXllckdyYXBocy5mb3JFYWNoKGZ1bmN0aW9uKGxnKSB7CiAgICBsZyA9IGxnLmZpbHRlck5vZGVzKGZ1bmN0aW9uKHUpIHsgcmV0dXJuICFnLmNoaWxkcmVuKHUpLmxlbmd0aDsgfSk7CiAgfSk7CgogIHZhciBpdGVycyA9IDAsCiAgICAgIGN1cnJlbnRCZXN0Q0MsCiAgICAgIGFsbFRpbWVCZXN0Q0MgPSBOdW1iZXIuTUFYX1ZBTFVFLAogICAgICBhbGxUaW1lQmVzdCA9IHt9OwoKICBmdW5jdGlvbiBzYXZlQWxsVGltZUJlc3QoKSB7CiAgICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7IGFsbFRpbWVCZXN0W3VdID0gdmFsdWUub3JkZXI7IH0pOwogIH0KCiAgZm9yICh2YXIgaiA9IDA7IGogPCBOdW1iZXIocmVzdGFydHMpICsgMSAmJiBhbGxUaW1lQmVzdENDICE9PSAwOyArK2opIHsKICAgIGN1cnJlbnRCZXN0Q0MgPSBOdW1iZXIuTUFYX1ZBTFVFOwogICAgaW5pdE9yZGVyKGcsIHJlc3RhcnRzID4gMCk7CgogICAgdXRpbC5sb2coMiwgJ09yZGVyIHBoYXNlIHN0YXJ0IGNyb3NzIGNvdW50OiAnICsgZy5ncmFwaCgpLm9yZGVySW5pdENDKTsKCiAgICB2YXIgaSwgbGFzdEJlc3QsIGNjOwogICAgZm9yIChpID0gMCwgbGFzdEJlc3QgPSAwOyBsYXN0QmVzdCA8IDQgJiYgaSA8IG1heFN3ZWVwcyAmJiBjdXJyZW50QmVzdENDID4gMDsgKytpLCArK2xhc3RCZXN0LCArK2l0ZXJzKSB7CiAgICAgIHN3ZWVwKGcsIGxheWVyR3JhcGhzLCBpKTsKICAgICAgY2MgPSBjcm9zc0NvdW50KGcpOwogICAgICBpZiAoY2MgPCBjdXJyZW50QmVzdENDKSB7CiAgICAgICAgbGFzdEJlc3QgPSAwOwogICAgICAgIGN1cnJlbnRCZXN0Q0MgPSBjYzsKICAgICAgICBpZiAoY2MgPCBhbGxUaW1lQmVzdENDKSB7CiAgICAgICAgICBzYXZlQWxsVGltZUJlc3QoKTsKICAgICAgICAgIGFsbFRpbWVCZXN0Q0MgPSBjYzsKICAgICAgICB9CiAgICAgIH0KICAgICAgdXRpbC5sb2coMywgJ09yZGVyIHBoYXNlIHN0YXJ0ICcgKyBqICsgJyBpdGVyICcgKyBpICsgJyBjcm9zcyBjb3VudDogJyArIGNjKTsKICAgIH0KICB9CgogIE9iamVjdC5rZXlzKGFsbFRpbWVCZXN0KS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIGlmICghZy5jaGlsZHJlbiB8fCAhZy5jaGlsZHJlbih1KS5sZW5ndGgpIHsKICAgICAgZy5ub2RlKHUpLm9yZGVyID0gYWxsVGltZUJlc3RbdV07CiAgICB9CiAgfSk7CiAgZy5ncmFwaCgpLm9yZGVyQ0MgPSBhbGxUaW1lQmVzdENDOwoKICB1dGlsLmxvZygyLCAnT3JkZXIgaXRlcmF0aW9uczogJyArIGl0ZXJzKTsKICB1dGlsLmxvZygyLCAnT3JkZXIgcGhhc2UgYmVzdCBjcm9zcyBjb3VudDogJyArIGcuZ3JhcGgoKS5vcmRlckNDKTsKfQoKZnVuY3Rpb24gcHJlZGVjZXNzb3JXZWlnaHRzKGcsIG5vZGVzKSB7CiAgdmFyIHdlaWdodHMgPSB7fTsKICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIHdlaWdodHNbdV0gPSBnLmluRWRnZXModSkubWFwKGZ1bmN0aW9uKGUpIHsKICAgICAgcmV0dXJuIGcubm9kZShnLnNvdXJjZShlKSkub3JkZXI7CiAgICB9KTsKICB9KTsKICByZXR1cm4gd2VpZ2h0czsKfQoKZnVuY3Rpb24gc3VjY2Vzc29yV2VpZ2h0cyhnLCBub2RlcykgewogIHZhciB3ZWlnaHRzID0ge307CiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICB3ZWlnaHRzW3VdID0gZy5vdXRFZGdlcyh1KS5tYXAoZnVuY3Rpb24oZSkgewogICAgICByZXR1cm4gZy5ub2RlKGcudGFyZ2V0KGUpKS5vcmRlcjsKICAgIH0pOwogIH0pOwogIHJldHVybiB3ZWlnaHRzOwp9CgpmdW5jdGlvbiBzd2VlcChnLCBsYXllckdyYXBocywgaXRlcikgewogIGlmIChpdGVyICUgMiA9PT0gMCkgewogICAgc3dlZXBEb3duKGcsIGxheWVyR3JhcGhzLCBpdGVyKTsKICB9IGVsc2UgewogICAgc3dlZXBVcChnLCBsYXllckdyYXBocywgaXRlcik7CiAgfQp9CgpmdW5jdGlvbiBzd2VlcERvd24oZywgbGF5ZXJHcmFwaHMpIHsKICB2YXIgY2c7CiAgZm9yIChpID0gMTsgaSA8IGxheWVyR3JhcGhzLmxlbmd0aDsgKytpKSB7CiAgICBjZyA9IHNvcnRMYXllcihsYXllckdyYXBoc1tpXSwgY2csIHByZWRlY2Vzc29yV2VpZ2h0cyhnLCBsYXllckdyYXBoc1tpXS5ub2RlcygpKSk7CiAgfQp9CgpmdW5jdGlvbiBzd2VlcFVwKGcsIGxheWVyR3JhcGhzKSB7CiAgdmFyIGNnOwogIGZvciAoaSA9IGxheWVyR3JhcGhzLmxlbmd0aCAtIDI7IGkgPj0gMDsgLS1pKSB7CiAgICBzb3J0TGF5ZXIobGF5ZXJHcmFwaHNbaV0sIGNnLCBzdWNjZXNzb3JXZWlnaHRzKGcsIGxheWVyR3JhcGhzW2ldLm5vZGVzKCkpKTsKICB9Cn0KCn0seyIuL29yZGVyL2Nyb3NzQ291bnQiOjUsIi4vb3JkZXIvaW5pdExheWVyR3JhcGhzIjo2LCIuL29yZGVyL2luaXRPcmRlciI6NywiLi9vcmRlci9zb3J0TGF5ZXIiOjgsIi4vdXRpbCI6MTd9XSw1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGNyb3NzQ291bnQ7CgovKgogKiBSZXR1cm5zIHRoZSBjcm9zcyBjb3VudCBmb3IgdGhlIGdpdmVuIGdyYXBoLgogKi8KZnVuY3Rpb24gY3Jvc3NDb3VudChnKSB7CiAgdmFyIGNjID0gMDsKICB2YXIgb3JkZXJpbmcgPSB1dGlsLm9yZGVyaW5nKGcpOwogIGZvciAodmFyIGkgPSAxOyBpIDwgb3JkZXJpbmcubGVuZ3RoOyArK2kpIHsKICAgIGNjICs9IHR3b0xheWVyQ3Jvc3NDb3VudChnLCBvcmRlcmluZ1tpLTFdLCBvcmRlcmluZ1tpXSk7CiAgfQogIHJldHVybiBjYzsKfQoKLyoKICogVGhpcyBmdW5jdGlvbiBzZWFyY2hlcyB0aHJvdWdoIGEgcmFua2VkIGFuZCBvcmRlcmVkIGdyYXBoIGFuZCBjb3VudHMgdGhlCiAqIG51bWJlciBvZiBlZGdlcyB0aGF0IGNyb3NzLiBUaGlzIGFsZ29yaXRobSBpcyBkZXJpdmVkIGZyb206CiAqCiAqICAgIFcuIEJhcnRoIGV0IGFsLiwgQmlsYXllciBDcm9zcyBDb3VudGluZywgSkdBQSwgOCgyKSAxNznigJMxOTQgKDIwMDQpCiAqLwpmdW5jdGlvbiB0d29MYXllckNyb3NzQ291bnQoZywgbGF5ZXIxLCBsYXllcjIpIHsKICB2YXIgaW5kaWNlcyA9IFtdOwogIGxheWVyMS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIHZhciBub2RlSW5kaWNlcyA9IFtdOwogICAgZy5vdXRFZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsgbm9kZUluZGljZXMucHVzaChnLm5vZGUoZy50YXJnZXQoZSkpLm9yZGVyKTsgfSk7CiAgICBub2RlSW5kaWNlcy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsgcmV0dXJuIHggLSB5OyB9KTsKICAgIGluZGljZXMgPSBpbmRpY2VzLmNvbmNhdChub2RlSW5kaWNlcyk7CiAgfSk7CgogIHZhciBmaXJzdEluZGV4ID0gMTsKICB3aGlsZSAoZmlyc3RJbmRleCA8IGxheWVyMi5sZW5ndGgpIGZpcnN0SW5kZXggPDw9IDE7CgogIHZhciB0cmVlU2l6ZSA9IDIgKiBmaXJzdEluZGV4IC0gMTsKICBmaXJzdEluZGV4IC09IDE7CgogIHZhciB0cmVlID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmVlU2l6ZTsgKytpKSB7IHRyZWVbaV0gPSAwOyB9CgogIHZhciBjYyA9IDA7CiAgaW5kaWNlcy5mb3JFYWNoKGZ1bmN0aW9uKGkpIHsKICAgIHZhciB0cmVlSW5kZXggPSBpICsgZmlyc3RJbmRleDsKICAgICsrdHJlZVt0cmVlSW5kZXhdOwogICAgd2hpbGUgKHRyZWVJbmRleCA+IDApIHsKICAgICAgaWYgKHRyZWVJbmRleCAlIDIpIHsKICAgICAgICBjYyArPSB0cmVlW3RyZWVJbmRleCArIDFdOwogICAgICB9CiAgICAgIHRyZWVJbmRleCA9ICh0cmVlSW5kZXggLSAxKSA+PiAxOwogICAgICArK3RyZWVbdHJlZUluZGV4XTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIGNjOwp9Cgp9LHsiLi4vdXRpbCI6MTd9XSw2OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIG5vZGVzRnJvbUxpc3QgPSByZXF1aXJlKCdncmFwaGxpYicpLmZpbHRlci5ub2Rlc0Zyb21MaXN0LAogICAgLyoganNoaW50IC1XMDc5ICovCiAgICBTZXQgPSByZXF1aXJlKCdjcC1kYXRhJykuU2V0OwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0TGF5ZXJHcmFwaHM7CgovKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGEgY29tcG91bmQgbGF5ZXJlZCBncmFwaCwgZywgYW5kIHByb2R1Y2VzIGFuIGFycmF5IG9mCiAqIGxheWVyIGdyYXBocy4gRWFjaCBlbnRyeSBpbiB0aGUgYXJyYXkgcmVwcmVzZW50cyBhIHN1YmdyYXBoIG9mIG5vZGVzCiAqIHJlbGV2YW50IGZvciBwZXJmb3JtaW5nIGNyb3NzaW5nIHJlZHVjdGlvbiBvbiB0aGF0IGxheWVyLgogKi8KZnVuY3Rpb24gaW5pdExheWVyR3JhcGhzKGcpIHsKICB2YXIgcmFua3MgPSBbXTsKCiAgZnVuY3Rpb24gZGZzKHUpIHsKICAgIGlmICh1ID09PSBudWxsKSB7CiAgICAgIGcuY2hpbGRyZW4odSkuZm9yRWFjaChmdW5jdGlvbih2KSB7IGRmcyh2KTsgfSk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdmFsdWUgPSBnLm5vZGUodSk7CiAgICB2YWx1ZS5taW5SYW5rID0gKCdyYW5rJyBpbiB2YWx1ZSkgPyB2YWx1ZS5yYW5rIDogTnVtYmVyLk1BWF9WQUxVRTsKICAgIHZhbHVlLm1heFJhbmsgPSAoJ3JhbmsnIGluIHZhbHVlKSA/IHZhbHVlLnJhbmsgOiBOdW1iZXIuTUlOX1ZBTFVFOwogICAgdmFyIHVSYW5rcyA9IG5ldyBTZXQoKTsKICAgIGcuY2hpbGRyZW4odSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBycyA9IGRmcyh2KTsKICAgICAgdVJhbmtzID0gU2V0LnVuaW9uKFt1UmFua3MsIHJzXSk7CiAgICAgIHZhbHVlLm1pblJhbmsgPSBNYXRoLm1pbih2YWx1ZS5taW5SYW5rLCBnLm5vZGUodikubWluUmFuayk7CiAgICAgIHZhbHVlLm1heFJhbmsgPSBNYXRoLm1heCh2YWx1ZS5tYXhSYW5rLCBnLm5vZGUodikubWF4UmFuayk7CiAgICB9KTsKCiAgICBpZiAoJ3JhbmsnIGluIHZhbHVlKSB1UmFua3MuYWRkKHZhbHVlLnJhbmspOwoKICAgIHVSYW5rcy5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbihyKSB7CiAgICAgIGlmICghKHIgaW4gcmFua3MpKSByYW5rc1tyXSA9IFtdOwogICAgICByYW5rc1tyXS5wdXNoKHUpOwogICAgfSk7CgogICAgcmV0dXJuIHVSYW5rczsKICB9CiAgZGZzKG51bGwpOwoKICB2YXIgbGF5ZXJHcmFwaHMgPSBbXTsKICByYW5rcy5mb3JFYWNoKGZ1bmN0aW9uKHVzLCByYW5rKSB7CiAgICBsYXllckdyYXBoc1tyYW5rXSA9IGcuZmlsdGVyTm9kZXMobm9kZXNGcm9tTGlzdCh1cykpOwogIH0pOwoKICByZXR1cm4gbGF5ZXJHcmFwaHM7Cn0KCn0seyJjcC1kYXRhIjoxOSwiZ3JhcGhsaWIiOjI0fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBjcm9zc0NvdW50ID0gcmVxdWlyZSgnLi9jcm9zc0NvdW50JyksCiAgICB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0T3JkZXI7CgovKgogKiBHaXZlbiBhIGdyYXBoIHdpdGggYSBzZXQgb2YgbGF5ZXJlZCBub2RlcyAoaS5lLiBub2RlcyB0aGF0IGhhdmUgYSBgcmFua2AKICogYXR0cmlidXRlKSB0aGlzIGZ1bmN0aW9uIGF0dGFjaGVzIGFuIGBvcmRlcmAgYXR0cmlidXRlIHRoYXQgdW5pcXVlbHkKICogYXJyYW5nZXMgZWFjaCBub2RlIG9mIGVhY2ggcmFuay4gSWYgbm8gY29uc3RyYWludCBncmFwaCBpcyBwcm92aWRlZCB0aGUKICogb3JkZXIgb2YgdGhlIG5vZGVzIGluIGVhY2ggcmFuayBpcyBlbnRpcmVseSBhcmJpdHJhcnkuCiAqLwpmdW5jdGlvbiBpbml0T3JkZXIoZywgcmFuZG9tKSB7CiAgdmFyIGxheWVycyA9IFtdOwoKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB2YXIgbGF5ZXIgPSBsYXllcnNbdmFsdWUucmFua107CiAgICBpZiAoZy5jaGlsZHJlbiAmJiBnLmNoaWxkcmVuKHUpLmxlbmd0aCA+IDApIHJldHVybjsKICAgIGlmICghbGF5ZXIpIHsKICAgICAgbGF5ZXIgPSBsYXllcnNbdmFsdWUucmFua10gPSBbXTsKICAgIH0KICAgIGxheWVyLnB1c2godSk7CiAgfSk7CgogIGxheWVycy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICBpZiAocmFuZG9tKSB7CiAgICAgIHV0aWwuc2h1ZmZsZShsYXllcik7CiAgICB9CiAgICBsYXllci5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgICAgZy5ub2RlKHUpLm9yZGVyID0gaTsKICAgIH0pOwogIH0pOwoKICB2YXIgY2MgPSBjcm9zc0NvdW50KGcpOwogIGcuZ3JhcGgoKS5vcmRlckluaXRDQyA9IGNjOwogIGcuZ3JhcGgoKS5vcmRlckNDID0gTnVtYmVyLk1BWF9WQUxVRTsKfQoKfSx7Ii4uL3V0aWwiOjE3LCIuL2Nyb3NzQ291bnQiOjV9XSw4OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Ci8qCiAgICBEaWdyYXBoID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5EaWdyYXBoLAogICAgdG9wc29ydCA9IHJlcXVpcmUoJ2dyYXBobGliJykuYWxnLnRvcHNvcnQsCiAgICBub2Rlc0Zyb21MaXN0ID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5maWx0ZXIubm9kZXNGcm9tTGlzdDsKKi8KCm1vZHVsZS5leHBvcnRzID0gc29ydExheWVyOwoKLyoKZnVuY3Rpb24gc29ydExheWVyKGcsIGNnLCB3ZWlnaHRzKSB7CiAgdmFyIHJlc3VsdCA9IHNvcnRMYXllclN1YmdyYXBoKGcsIG51bGwsIGNnLCB3ZWlnaHRzKTsKICByZXN1bHQubGlzdC5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgIGcubm9kZSh1KS5vcmRlciA9IGk7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdC5jb25zdHJhaW50R3JhcGg7Cn0KKi8KCmZ1bmN0aW9uIHNvcnRMYXllcihnLCBjZywgd2VpZ2h0cykgewogIHZhciBvcmRlcmluZyA9IFtdOwogIHZhciBicyA9IHt9OwogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIG9yZGVyaW5nW3ZhbHVlLm9yZGVyXSA9IHU7CiAgICB2YXIgd3MgPSB3ZWlnaHRzW3VdOwogICAgaWYgKHdzLmxlbmd0aCkgewogICAgICBic1t1XSA9IHV0aWwuc3VtKHdzKSAvIHdzLmxlbmd0aDsKICAgIH0KICB9KTsKCiAgdmFyIHRvU29ydCA9IGcubm9kZXMoKS5maWx0ZXIoZnVuY3Rpb24odSkgeyByZXR1cm4gYnNbdV0gIT09IHVuZGVmaW5lZDsgfSk7CiAgdG9Tb3J0LnNvcnQoZnVuY3Rpb24oeCwgeSkgewogICAgcmV0dXJuIGJzW3hdIC0gYnNbeV0gfHwgZy5ub2RlKHgpLm9yZGVyIC0gZy5ub2RlKHkpLm9yZGVyOwogIH0pOwoKICBmb3IgKHZhciBpID0gMCwgaiA9IDAsIGpsID0gdG9Tb3J0Lmxlbmd0aDsgaiA8IGpsOyArK2kpIHsKICAgIGlmIChic1tvcmRlcmluZ1tpXV0gIT09IHVuZGVmaW5lZCkgewogICAgICBnLm5vZGUodG9Tb3J0W2orK10pLm9yZGVyID0gaTsKICAgIH0KICB9Cn0KCi8vIFRPT0Q6IHJlLWVuYWJsZSBjb25zdHJhaW5lZCBzb3J0aW5nIG9uY2Ugd2UgaGF2ZSBhIHN0cmF0ZWd5IGZvciBoYW5kbGluZwovLyB1bmRlZmluZWQgYmFyeWNlbnRlcnMuCi8qCmZ1bmN0aW9uIHNvcnRMYXllclN1YmdyYXBoKGcsIHNnLCBjZywgd2VpZ2h0cykgewogIGNnID0gY2cgPyBjZy5maWx0ZXJOb2Rlcyhub2Rlc0Zyb21MaXN0KGcuY2hpbGRyZW4oc2cpKSkgOiBuZXcgRGlncmFwaCgpOwoKICB2YXIgbm9kZURhdGEgPSB7fTsKICBnLmNoaWxkcmVuKHNnKS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgIGlmIChnLmNoaWxkcmVuKHUpLmxlbmd0aCkgewogICAgICBub2RlRGF0YVt1XSA9IHNvcnRMYXllclN1YmdyYXBoKGcsIHUsIGNnLCB3ZWlnaHRzKTsKICAgICAgbm9kZURhdGFbdV0uZmlyc3RTRyA9IHU7CiAgICAgIG5vZGVEYXRhW3VdLmxhc3RTRyA9IHU7CiAgICB9IGVsc2UgewogICAgICB2YXIgd3MgPSB3ZWlnaHRzW3VdOwogICAgICBub2RlRGF0YVt1XSA9IHsKICAgICAgICBkZWdyZWU6IHdzLmxlbmd0aCwKICAgICAgICBiYXJ5Y2VudGVyOiB3cy5sZW5ndGggPiAwID8gdXRpbC5zdW0od3MpIC8gd3MubGVuZ3RoIDogMCwKICAgICAgICBsaXN0OiBbdV0KICAgICAgfTsKICAgIH0KICB9KTsKCiAgcmVzb2x2ZVZpb2xhdGVkQ29uc3RyYWludHMoZywgY2csIG5vZGVEYXRhKTsKCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhub2RlRGF0YSk7CiAga2V5cy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsKICAgIHJldHVybiBub2RlRGF0YVt4XS5iYXJ5Y2VudGVyIC0gbm9kZURhdGFbeV0uYmFyeWNlbnRlcjsKICB9KTsKCiAgdmFyIHJlc3VsdCA9ICBrZXlzLm1hcChmdW5jdGlvbih1KSB7IHJldHVybiBub2RlRGF0YVt1XTsgfSkKICAgICAgICAgICAgICAgICAgICAucmVkdWNlKGZ1bmN0aW9uKGxocywgcmhzKSB7IHJldHVybiBtZXJnZU5vZGVEYXRhKGcsIGxocywgcmhzKTsgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQoKLyoKZnVuY3Rpb24gbWVyZ2VOb2RlRGF0YShnLCBsaHMsIHJocykgewogIHZhciBjZyA9IG1lcmdlRGlncmFwaHMobGhzLmNvbnN0cmFpbnRHcmFwaCwgcmhzLmNvbnN0cmFpbnRHcmFwaCk7CgogIGlmIChsaHMubGFzdFNHICE9PSB1bmRlZmluZWQgJiYgcmhzLmZpcnN0U0cgIT09IHVuZGVmaW5lZCkgewogICAgaWYgKGNnID09PSB1bmRlZmluZWQpIHsKICAgICAgY2cgPSBuZXcgRGlncmFwaCgpOwogICAgfQogICAgaWYgKCFjZy5oYXNOb2RlKGxocy5sYXN0U0cpKSB7IGNnLmFkZE5vZGUobGhzLmxhc3RTRyk7IH0KICAgIGNnLmFkZE5vZGUocmhzLmZpcnN0U0cpOwogICAgY2cuYWRkRWRnZShudWxsLCBsaHMubGFzdFNHLCByaHMuZmlyc3RTRyk7CiAgfQoKICByZXR1cm4gewogICAgZGVncmVlOiBsaHMuZGVncmVlICsgcmhzLmRlZ3JlZSwKICAgIGJhcnljZW50ZXI6IChsaHMuYmFyeWNlbnRlciAqIGxocy5kZWdyZWUgKyByaHMuYmFyeWNlbnRlciAqIHJocy5kZWdyZWUpIC8KICAgICAgICAgICAgICAgIChsaHMuZGVncmVlICsgcmhzLmRlZ3JlZSksCiAgICBsaXN0OiBsaHMubGlzdC5jb25jYXQocmhzLmxpc3QpLAogICAgZmlyc3RTRzogbGhzLmZpcnN0U0cgIT09IHVuZGVmaW5lZCA/IGxocy5maXJzdFNHIDogcmhzLmZpcnN0U0csCiAgICBsYXN0U0c6IHJocy5sYXN0U0cgIT09IHVuZGVmaW5lZCA/IHJocy5sYXN0U0cgOiBsaHMubGFzdFNHLAogICAgY29uc3RyYWludEdyYXBoOiBjZwogIH07Cn0KCmZ1bmN0aW9uIG1lcmdlRGlncmFwaHMobGhzLCByaHMpIHsKICBpZiAobGhzID09PSB1bmRlZmluZWQpIHJldHVybiByaHM7CiAgaWYgKHJocyA9PT0gdW5kZWZpbmVkKSByZXR1cm4gbGhzOwoKICBsaHMgPSBsaHMuY29weSgpOwogIHJocy5ub2RlcygpLmZvckVhY2goZnVuY3Rpb24odSkgeyBsaHMuYWRkTm9kZSh1KTsgfSk7CiAgcmhzLmVkZ2VzKCkuZm9yRWFjaChmdW5jdGlvbihlLCB1LCB2KSB7IGxocy5hZGRFZGdlKG51bGwsIHUsIHYpOyB9KTsKICByZXR1cm4gbGhzOwp9CgpmdW5jdGlvbiByZXNvbHZlVmlvbGF0ZWRDb25zdHJhaW50cyhnLCBjZywgbm9kZURhdGEpIHsKICAvLyBSZW1vdmVzIG5vZGVzIGB1YCBhbmQgYHZgIGZyb20gYGNnYCBhbmQgbWFrZXMgYW55IGVkZ2VzIGluY2lkZW50IG9uIHRoZW0KICAvLyBpbmNpZGVudCBvbiBgd2AgaW5zdGVhZC4KICBmdW5jdGlvbiBjb2xsYXBzZU5vZGVzKHUsIHYsIHcpIHsKICAgIC8vIFRPRE8gb3JpZ2luYWwgcGFwZXIgcmVtb3ZlcyBzZWxmIGxvb3BzLCBidXQgaXQgaXMgbm90IG9idmlvdXMgd2hlbiB0aGlzIHdvdWxkIGhhcHBlbgogICAgY2cuaW5FZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgY2cuZGVsRWRnZShlKTsKICAgICAgY2cuYWRkRWRnZShudWxsLCBjZy5zb3VyY2UoZSksIHcpOwogICAgfSk7CgogICAgY2cub3V0RWRnZXModikuZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGNnLmRlbEVkZ2UoZSk7CiAgICAgIGNnLmFkZEVkZ2UobnVsbCwgdywgY2cudGFyZ2V0KGUpKTsKICAgIH0pOwoKICAgIGNnLmRlbE5vZGUodSk7CiAgICBjZy5kZWxOb2RlKHYpOwogIH0KCiAgdmFyIHZpb2xhdGVkOwogIHdoaWxlICgodmlvbGF0ZWQgPSBmaW5kVmlvbGF0ZWRDb25zdHJhaW50KGNnLCBub2RlRGF0YSkpICE9PSB1bmRlZmluZWQpIHsKICAgIHZhciBzb3VyY2UgPSBjZy5zb3VyY2UodmlvbGF0ZWQpLAogICAgICAgIHRhcmdldCA9IGNnLnRhcmdldCh2aW9sYXRlZCk7CgogICAgdmFyIHY7CiAgICB3aGlsZSAoKHYgPSBjZy5hZGROb2RlKG51bGwpKSAmJiBnLmhhc05vZGUodikpIHsKICAgICAgY2cuZGVsTm9kZSh2KTsKICAgIH0KCiAgICAvLyBDb2xsYXBzZSBiYXJ5Y2VudGVyIGFuZCBsaXN0CiAgICBub2RlRGF0YVt2XSA9IG1lcmdlTm9kZURhdGEoZywgbm9kZURhdGFbc291cmNlXSwgbm9kZURhdGFbdGFyZ2V0XSk7CiAgICBkZWxldGUgbm9kZURhdGFbc291cmNlXTsKICAgIGRlbGV0ZSBub2RlRGF0YVt0YXJnZXRdOwoKICAgIGNvbGxhcHNlTm9kZXMoc291cmNlLCB0YXJnZXQsIHYpOwogICAgaWYgKGNnLmluY2lkZW50RWRnZXModikubGVuZ3RoID09PSAwKSB7IGNnLmRlbE5vZGUodik7IH0KICB9Cn0KCmZ1bmN0aW9uIGZpbmRWaW9sYXRlZENvbnN0cmFpbnQoY2csIG5vZGVEYXRhKSB7CiAgdmFyIHVzID0gdG9wc29ydChjZyk7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cy5sZW5ndGg7ICsraSkgewogICAgdmFyIHUgPSB1c1tpXTsKICAgIHZhciBpbkVkZ2VzID0gY2cuaW5FZGdlcyh1KTsKICAgIGZvciAodmFyIGogPSAwOyBqIDwgaW5FZGdlcy5sZW5ndGg7ICsraikgewogICAgICB2YXIgZSA9IGluRWRnZXNbal07CiAgICAgIGlmIChub2RlRGF0YVtjZy5zb3VyY2UoZSldLmJhcnljZW50ZXIgPj0gbm9kZURhdGFbdV0uYmFyeWNlbnRlcikgewogICAgICAgIHJldHVybiBlOwogICAgICB9CiAgICB9CiAgfQp9CiovCgp9LHsiLi4vdXRpbCI6MTd9XSw5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIHV0aWwgPSByZXF1aXJlKCcuL3V0aWwnKTsKCi8qCiAqIFRoZSBhbGdvcml0aG1zIGhlcmUgYXJlIGJhc2VkIG9uIEJyYW5kZXMgYW5kIEvDtnBmLCAiRmFzdCBhbmQgU2ltcGxlCiAqIEhvcml6b250YWwgQ29vcmRpbmF0ZSBBc3NpZ25tZW50Ii4KICovCm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oKSB7CiAgLy8gRXh0ZXJuYWwgY29uZmlndXJhdGlvbgogIHZhciBjb25maWcgPSB7CiAgICBub2RlU2VwOiA1MCwKICAgIGVkZ2VTZXA6IDEwLAogICAgdW5pdmVyc2FsU2VwOiBudWxsLAogICAgcmFua1NlcDogMzAKICB9OwoKICB2YXIgc2VsZiA9IHt9OwoKICBzZWxmLm5vZGVTZXAgPSB1dGlsLnByb3BlcnR5QWNjZXNzb3Ioc2VsZiwgY29uZmlnLCAnbm9kZVNlcCcpOwogIHNlbGYuZWRnZVNlcCA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdlZGdlU2VwJyk7CiAgLy8gSWYgbm90IG51bGwgdGhpcyBzZXBhcmF0aW9uIHZhbHVlIGlzIHVzZWQgZm9yIGFsbCBub2RlcyBhbmQgZWRnZXMKICAvLyByZWdhcmRsZXNzIG9mIHRoZWlyIHdpZHRocy4gYG5vZGVTZXBgIGFuZCBgZWRnZVNlcGAgYXJlIGlnbm9yZWQgd2l0aCB0aGlzCiAgLy8gb3B0aW9uLgogIHNlbGYudW5pdmVyc2FsU2VwID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ3VuaXZlcnNhbFNlcCcpOwogIHNlbGYucmFua1NlcCA9IHV0aWwucHJvcGVydHlBY2Nlc3NvcihzZWxmLCBjb25maWcsICdyYW5rU2VwJyk7CiAgc2VsZi5kZWJ1Z0xldmVsID0gdXRpbC5wcm9wZXJ0eUFjY2Vzc29yKHNlbGYsIGNvbmZpZywgJ2RlYnVnTGV2ZWwnKTsKCiAgc2VsZi5ydW4gPSBydW47CgogIHJldHVybiBzZWxmOwoKICBmdW5jdGlvbiBydW4oZykgewogICAgZyA9IGcuZmlsdGVyTm9kZXModXRpbC5maWx0ZXJOb25TdWJncmFwaHMoZykpOwoKICAgIHZhciBsYXllcmluZyA9IHV0aWwub3JkZXJpbmcoZyk7CgogICAgdmFyIGNvbmZsaWN0cyA9IGZpbmRDb25mbGljdHMoZywgbGF5ZXJpbmcpOwoKICAgIHZhciB4c3MgPSB7fTsKICAgIFsndScsICdkJ10uZm9yRWFjaChmdW5jdGlvbih2ZXJ0RGlyKSB7CiAgICAgIGlmICh2ZXJ0RGlyID09PSAnZCcpIGxheWVyaW5nLnJldmVyc2UoKTsKCiAgICAgIFsnbCcsICdyJ10uZm9yRWFjaChmdW5jdGlvbihob3JpekRpcikgewogICAgICAgIGlmIChob3JpekRpciA9PT0gJ3InKSByZXZlcnNlSW5uZXJPcmRlcihsYXllcmluZyk7CgogICAgICAgIHZhciBkaXIgPSB2ZXJ0RGlyICsgaG9yaXpEaXI7CiAgICAgICAgdmFyIGFsaWduID0gdmVydGljYWxBbGlnbm1lbnQoZywgbGF5ZXJpbmcsIGNvbmZsaWN0cywgdmVydERpciA9PT0gJ3UnID8gJ3ByZWRlY2Vzc29ycycgOiAnc3VjY2Vzc29ycycpOwogICAgICAgIHhzc1tkaXJdPSBob3Jpem9udGFsQ29tcGFjdGlvbihnLCBsYXllcmluZywgYWxpZ24ucG9zLCBhbGlnbi5yb290LCBhbGlnbi5hbGlnbik7CgogICAgICAgIGlmIChjb25maWcuZGVidWdMZXZlbCA+PSAzKQogICAgICAgICAgZGVidWdQb3NpdGlvbmluZyh2ZXJ0RGlyICsgaG9yaXpEaXIsIGcsIGxheWVyaW5nLCB4c3NbZGlyXSk7CgogICAgICAgIGlmIChob3JpekRpciA9PT0gJ3InKSBmbGlwSG9yaXpvbnRhbGx5KHhzc1tkaXJdKTsKCiAgICAgICAgaWYgKGhvcml6RGlyID09PSAncicpIHJldmVyc2VJbm5lck9yZGVyKGxheWVyaW5nKTsKICAgICAgfSk7CgogICAgICBpZiAodmVydERpciA9PT0gJ2QnKSBsYXllcmluZy5yZXZlcnNlKCk7CiAgICB9KTsKCiAgICBiYWxhbmNlKGcsIGxheWVyaW5nLCB4c3MpOwoKICAgIGcuZWFjaE5vZGUoZnVuY3Rpb24odikgewogICAgICB2YXIgeHMgPSBbXTsKICAgICAgZm9yICh2YXIgYWxpZ25tZW50IGluIHhzcykgewogICAgICAgIHZhciBhbGlnbm1lbnRYID0geHNzW2FsaWdubWVudF1bdl07CiAgICAgICAgcG9zWERlYnVnKGFsaWdubWVudCwgZywgdiwgYWxpZ25tZW50WCk7CiAgICAgICAgeHMucHVzaChhbGlnbm1lbnRYKTsKICAgICAgfQogICAgICB4cy5zb3J0KGZ1bmN0aW9uKHgsIHkpIHsgcmV0dXJuIHggLSB5OyB9KTsKICAgICAgcG9zWChnLCB2LCAoeHNbMV0gKyB4c1syXSkgLyAyKTsKICAgIH0pOwoKICAgIC8vIEFsaWduIHkgY29vcmRpbmF0ZXMgd2l0aCByYW5rcwogICAgdmFyIHkgPSAwLCByZXZlcnNlWSA9IGcuZ3JhcGgoKS5yYW5rRGlyID09PSAnQlQnIHx8IGcuZ3JhcGgoKS5yYW5rRGlyID09PSAnUkwnOwogICAgbGF5ZXJpbmcuZm9yRWFjaChmdW5jdGlvbihsYXllcikgewogICAgICB2YXIgbWF4SGVpZ2h0ID0gdXRpbC5tYXgobGF5ZXIubWFwKGZ1bmN0aW9uKHUpIHsgcmV0dXJuIGhlaWdodChnLCB1KTsgfSkpOwogICAgICB5ICs9IG1heEhlaWdodCAvIDI7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAgIHBvc1koZywgdSwgcmV2ZXJzZVkgPyAteSA6IHkpOwogICAgICB9KTsKICAgICAgeSArPSBtYXhIZWlnaHQgLyAyICsgY29uZmlnLnJhbmtTZXA7CiAgICB9KTsKCiAgICAvLyBUcmFuc2xhdGUgbGF5b3V0IHNvIHRoYXQgdG9wIGxlZnQgY29ybmVyIG9mIGJvdW5kaW5nIHJlY3RhbmdsZSBoYXMKICAgIC8vIGNvb3JkaW5hdGUgKDAsIDApLgogICAgdmFyIG1pblggPSB1dGlsLm1pbihnLm5vZGVzKCkubWFwKGZ1bmN0aW9uKHUpIHsgcmV0dXJuIHBvc1goZywgdSkgLSB3aWR0aChnLCB1KSAvIDI7IH0pKTsKICAgIHZhciBtaW5ZID0gdXRpbC5taW4oZy5ub2RlcygpLm1hcChmdW5jdGlvbih1KSB7IHJldHVybiBwb3NZKGcsIHUpIC0gaGVpZ2h0KGcsIHUpIC8gMjsgfSkpOwogICAgZy5lYWNoTm9kZShmdW5jdGlvbih1KSB7CiAgICAgIHBvc1goZywgdSwgcG9zWChnLCB1KSAtIG1pblgpOwogICAgICBwb3NZKGcsIHUsIHBvc1koZywgdSkgLSBtaW5ZKTsKICAgIH0pOwogIH0KCiAgLyoKICAgKiBHZW5lcmF0ZSBhbiBJRCB0aGF0IGNhbiBiZSB1c2VkIHRvIHJlcHJlc2VudCBhbnkgdW5kaXJlY3RlZCBlZGdlIHRoYXQgaXMKICAgKiBpbmNpZGVudCBvbiBgdWAgYW5kIGB2YC4KICAgKi8KICBmdW5jdGlvbiB1bmRpckVkZ2VJZCh1LCB2KSB7CiAgICByZXR1cm4gdSA8IHYKICAgICAgPyB1LnRvU3RyaW5nKCkubGVuZ3RoICsgJzonICsgdSArICctJyArIHYKICAgICAgOiB2LnRvU3RyaW5nKCkubGVuZ3RoICsgJzonICsgdiArICctJyArIHU7CiAgfQoKICBmdW5jdGlvbiBmaW5kQ29uZmxpY3RzKGcsIGxheWVyaW5nKSB7CiAgICB2YXIgY29uZmxpY3RzID0ge30sIC8vIFNldCBvZiBjb25mbGljdGluZyBlZGdlIGlkcwogICAgICAgIHBvcyA9IHt9LCAgICAgICAvLyBQb3NpdGlvbiBvZiBub2RlIGluIGl0cyBsYXllcgogICAgICAgIHByZXZMYXllciwKICAgICAgICBjdXJyTGF5ZXIsCiAgICAgICAgazAsICAgICAvLyBQb3NpdGlvbiBvZiB0aGUgbGFzdCBpbm5lciBzZWdtZW50IGluIHRoZSBwcmV2aW91cyBsYXllcgogICAgICAgIGwsICAgICAgLy8gQ3VycmVudCBwb3NpdGlvbiBpbiB0aGUgY3VycmVudCBsYXllciAoZm9yIGl0ZXJhdGlvbiB1cCB0byBgbDFgKQogICAgICAgIGsxOyAgICAgLy8gUG9zaXRpb24gb2YgdGhlIG5leHQgaW5uZXIgc2VnbWVudCBpbiB0aGUgcHJldmlvdXMgbGF5ZXIgb3IKICAgICAgICAgICAgICAgIC8vIHRoZSBwb3NpdGlvbiBvZiB0aGUgbGFzdCBlbGVtZW50IGluIHRoZSBwcmV2aW91cyBsYXllcgoKICAgIGlmIChsYXllcmluZy5sZW5ndGggPD0gMikgcmV0dXJuIGNvbmZsaWN0czsKCiAgICBmdW5jdGlvbiB1cGRhdGVDb25mbGljdHModikgewogICAgICB2YXIgayA9IHBvc1t2XTsKICAgICAgaWYgKGsgPCBrMCB8fCBrID4gazEpIHsKICAgICAgICBjb25mbGljdHNbdW5kaXJFZGdlSWQoY3VyckxheWVyW2xdLCB2KV0gPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgbGF5ZXJpbmdbMV0uZm9yRWFjaChmdW5jdGlvbih1LCBpKSB7IHBvc1t1XSA9IGk7IH0pOwogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBsYXllcmluZy5sZW5ndGggLSAxOyArK2kpIHsKICAgICAgcHJldkxheWVyID0gbGF5ZXJpbmdbaV07CiAgICAgIGN1cnJMYXllciA9IGxheWVyaW5nW2krMV07CiAgICAgIGswID0gMDsKICAgICAgbCA9IDA7CgogICAgICAvLyBTY2FuIGN1cnJlbnQgbGF5ZXIgZm9yIG5leHQgbm9kZSB0aGF0IGlzIGluY2lkZW50IHRvIGFuIGlubmVyIHNlZ2VtZW50CiAgICAgIC8vIGJldHdlZW4gbGF5ZXJpbmdbaSsxXSBhbmQgbGF5ZXJpbmdbaV0uCiAgICAgIGZvciAodmFyIGwxID0gMDsgbDEgPCBjdXJyTGF5ZXIubGVuZ3RoOyArK2wxKSB7CiAgICAgICAgdmFyIHUgPSBjdXJyTGF5ZXJbbDFdOyAvLyBOZXh0IGlubmVyIHNlZ21lbnQgaW4gdGhlIGN1cnJlbnQgbGF5ZXIgb3IKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGxhc3Qgbm9kZSBpbiB0aGUgY3VycmVudCBsYXllcgogICAgICAgIHBvc1t1XSA9IGwxOwogICAgICAgIGsxID0gdW5kZWZpbmVkOwoKICAgICAgICBpZiAoZy5ub2RlKHUpLmR1bW15KSB7CiAgICAgICAgICB2YXIgdVByZWQgPSBnLnByZWRlY2Vzc29ycyh1KVswXTsKICAgICAgICAgIC8vIE5vdGU6IEluIHRoZSBjYXNlIG9mIHNlbGYgbG9vcHMgYW5kIHNpZGV3YXlzIGVkZ2VzIGl0IGlzIHBvc3NpYmxlCiAgICAgICAgICAvLyBmb3IgYSBkdW1teSBub3QgdG8gaGF2ZSBhIHByZWRlY2Vzc29yLgogICAgICAgICAgaWYgKHVQcmVkICE9PSB1bmRlZmluZWQgJiYgZy5ub2RlKHVQcmVkKS5kdW1teSkKICAgICAgICAgICAgazEgPSBwb3NbdVByZWRdOwogICAgICAgIH0KICAgICAgICBpZiAoazEgPT09IHVuZGVmaW5lZCAmJiBsMSA9PT0gY3VyckxheWVyLmxlbmd0aCAtIDEpCiAgICAgICAgICBrMSA9IHByZXZMYXllci5sZW5ndGggLSAxOwoKICAgICAgICBpZiAoazEgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgZm9yICg7IGwgPD0gbDE7ICsrbCkgewogICAgICAgICAgICBnLnByZWRlY2Vzc29ycyhjdXJyTGF5ZXJbbF0pLmZvckVhY2godXBkYXRlQ29uZmxpY3RzKTsKICAgICAgICAgIH0KICAgICAgICAgIGswID0gazE7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGNvbmZsaWN0czsKICB9CgogIGZ1bmN0aW9uIHZlcnRpY2FsQWxpZ25tZW50KGcsIGxheWVyaW5nLCBjb25mbGljdHMsIHJlbGF0aW9uc2hpcCkgewogICAgdmFyIHBvcyA9IHt9LCAgIC8vIFBvc2l0aW9uIGZvciBhIG5vZGUgaW4gaXRzIGxheWVyCiAgICAgICAgcm9vdCA9IHt9LCAgLy8gUm9vdCBvZiB0aGUgYmxvY2sgdGhhdCB0aGUgbm9kZSBwYXJ0aWNpcGF0ZXMgaW4KICAgICAgICBhbGlnbiA9IHt9OyAvLyBQb2ludHMgdG8gdGhlIG5leHQgbm9kZSBpbiB0aGUgYmxvY2sgb3IsIGlmIHRoZSBsYXN0CiAgICAgICAgICAgICAgICAgICAgLy8gZWxlbWVudCBpbiB0aGUgYmxvY2ssIHBvaW50cyB0byB0aGUgZmlyc3QgYmxvY2sncyByb290CgogICAgbGF5ZXJpbmcuZm9yRWFjaChmdW5jdGlvbihsYXllcikgewogICAgICBsYXllci5mb3JFYWNoKGZ1bmN0aW9uKHUsIGkpIHsKICAgICAgICByb290W3VdID0gdTsKICAgICAgICBhbGlnblt1XSA9IHU7CiAgICAgICAgcG9zW3VdID0gaTsKICAgICAgfSk7CiAgICB9KTsKCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIHZhciBwcmV2SWR4ID0gLTE7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHZhciByZWxhdGVkID0gZ1tyZWxhdGlvbnNoaXBdKHYpLCAvLyBBZGphY2VudCBub2RlcyBmcm9tIHRoZSBwcmV2aW91cyBsYXllcgogICAgICAgICAgICBtaWQ7ICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgbWlkIHBvaW50IGluIHRoZSByZWxhdGVkIGFycmF5CgogICAgICAgIGlmIChyZWxhdGVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHJlbGF0ZWQuc29ydChmdW5jdGlvbih4LCB5KSB7IHJldHVybiBwb3NbeF0gLSBwb3NbeV07IH0pOwogICAgICAgICAgbWlkID0gKHJlbGF0ZWQubGVuZ3RoIC0gMSkgLyAyOwogICAgICAgICAgcmVsYXRlZC5zbGljZShNYXRoLmZsb29yKG1pZCksIE1hdGguY2VpbChtaWQpICsgMSkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgICAgICAgIGlmIChhbGlnblt2XSA9PT0gdikgewogICAgICAgICAgICAgIGlmICghY29uZmxpY3RzW3VuZGlyRWRnZUlkKHUsIHYpXSAmJiBwcmV2SWR4IDwgcG9zW3VdKSB7CiAgICAgICAgICAgICAgICBhbGlnblt1XSA9IHY7CiAgICAgICAgICAgICAgICBhbGlnblt2XSA9IHJvb3Rbdl0gPSByb290W3VdOwogICAgICAgICAgICAgICAgcHJldklkeCA9IHBvc1t1XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICByZXR1cm4geyBwb3M6IHBvcywgcm9vdDogcm9vdCwgYWxpZ246IGFsaWduIH07CiAgfQoKICAvLyBUaGlzIGZ1bmN0aW9uIGRldmlhdGVzIGZyb20gdGhlIHN0YW5kYXJkIEJLIGFsZ29yaXRobSBpbiB0d28gd2F5cy4gRmlyc3QKICAvLyBpdCB0YWtlcyBpbnRvIGFjY291bnQgdGhlIHNpemUgb2YgdGhlIG5vZGVzLiBTZWNvbmQgaXQgaW5jbHVkZXMgYSBmaXggdG8KICAvLyB0aGUgb3JpZ2luYWwgYWxnb3JpdGhtIHRoYXQgaXMgZGVzY3JpYmVkIGluIENhcnN0ZW5zLCAiTm9kZSBhbmQgTGFiZWwKICAvLyBQbGFjZW1lbnQgaW4gYSBMYXllcmVkIExheW91dCBBbGdvcml0aG0iLgogIGZ1bmN0aW9uIGhvcml6b250YWxDb21wYWN0aW9uKGcsIGxheWVyaW5nLCBwb3MsIHJvb3QsIGFsaWduKSB7CiAgICB2YXIgc2luayA9IHt9LCAgICAgICAvLyBNYXBwaW5nIG9mIG5vZGUgaWQgLT4gc2luayBub2RlIGlkIGZvciBjbGFzcwogICAgICAgIG1heWJlU2hpZnQgPSB7fSwgLy8gTWFwcGluZyBvZiBzaW5rIG5vZGUgaWQgLT4geyBjbGFzcyBub2RlIGlkLCBtaW4gc2hpZnQgfQogICAgICAgIHNoaWZ0ID0ge30sICAgICAgLy8gTWFwcGluZyBvZiBzaW5rIG5vZGUgaWQgLT4gc2hpZnQKICAgICAgICBwcmVkID0ge30sICAgICAgIC8vIE1hcHBpbmcgb2Ygbm9kZSBpZCAtPiBwcmVkZWNlc3NvciBub2RlIChvciBudWxsKQogICAgICAgIHhzID0ge307ICAgICAgICAgLy8gQ2FsY3VsYXRlZCBYIHBvc2l0aW9ucwoKICAgIGxheWVyaW5nLmZvckVhY2goZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgbGF5ZXIuZm9yRWFjaChmdW5jdGlvbih1LCBpKSB7CiAgICAgICAgc2lua1t1XSA9IHU7CiAgICAgICAgbWF5YmVTaGlmdFt1XSA9IHt9OwogICAgICAgIGlmIChpID4gMCkKICAgICAgICAgIHByZWRbdV0gPSBsYXllcltpIC0gMV07CiAgICAgIH0pOwogICAgfSk7CgogICAgZnVuY3Rpb24gdXBkYXRlU2hpZnQodG9TaGlmdCwgbmVpZ2hib3IsIGRlbHRhKSB7CiAgICAgIGlmICghKG5laWdoYm9yIGluIG1heWJlU2hpZnRbdG9TaGlmdF0pKSB7CiAgICAgICAgbWF5YmVTaGlmdFt0b1NoaWZ0XVtuZWlnaGJvcl0gPSBkZWx0YTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtYXliZVNoaWZ0W3RvU2hpZnRdW25laWdoYm9yXSA9IE1hdGgubWluKG1heWJlU2hpZnRbdG9TaGlmdF1bbmVpZ2hib3JdLCBkZWx0YSk7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBwbGFjZUJsb2NrKHYpIHsKICAgICAgaWYgKCEodiBpbiB4cykpIHsKICAgICAgICB4c1t2XSA9IDA7CiAgICAgICAgdmFyIHcgPSB2OwogICAgICAgIGRvIHsKICAgICAgICAgIGlmIChwb3Nbd10gPiAwKSB7CiAgICAgICAgICAgIHZhciB1ID0gcm9vdFtwcmVkW3ddXTsKICAgICAgICAgICAgcGxhY2VCbG9jayh1KTsKICAgICAgICAgICAgaWYgKHNpbmtbdl0gPT09IHYpIHsKICAgICAgICAgICAgICBzaW5rW3ZdID0gc2lua1t1XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsdGEgPSBzZXAoZywgcHJlZFt3XSkgKyBzZXAoZywgdyk7CiAgICAgICAgICAgIGlmIChzaW5rW3ZdICE9PSBzaW5rW3VdKSB7CiAgICAgICAgICAgICAgdXBkYXRlU2hpZnQoc2lua1t1XSwgc2lua1t2XSwgeHNbdl0gLSB4c1t1XSAtIGRlbHRhKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4c1t2XSA9IE1hdGgubWF4KHhzW3ZdLCB4c1t1XSArIGRlbHRhKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdyA9IGFsaWduW3ddOwogICAgICAgIH0gd2hpbGUgKHcgIT09IHYpOwogICAgICB9CiAgICB9CgogICAgLy8gUm9vdCBjb29yZGluYXRlcyByZWxhdGl2ZSB0byBzaW5rCiAgICB1dGlsLnZhbHVlcyhyb290KS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgcGxhY2VCbG9jayh2KTsKICAgIH0pOwoKICAgIC8vIEFic29sdXRlIGNvb3JkaW5hdGVzCiAgICAvLyBUaGVyZSBpcyBhbiBhc3N1bXB0aW9uIGhlcmUgdGhhdCB3ZSd2ZSByZXNvbHZlZCBzaGlmdHMgZm9yIGFueSBjbGFzc2VzCiAgICAvLyB0aGF0IGJlZ2luIGF0IGFuIGVhcmxpZXIgbGF5ZXIuIFdlIGd1YXJhbnRlZSB0aGlzIGJ5IHZpc2l0aW5nIGxheWVycyBpbgogICAgLy8gb3JkZXIuCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHhzW3ZdID0geHNbcm9vdFt2XV07CiAgICAgICAgaWYgKHYgPT09IHJvb3Rbdl0gJiYgdiA9PT0gc2lua1t2XSkgewogICAgICAgICAgdmFyIG1pblNoaWZ0ID0gMDsKICAgICAgICAgIGlmICh2IGluIG1heWJlU2hpZnQgJiYgT2JqZWN0LmtleXMobWF5YmVTaGlmdFt2XSkubGVuZ3RoID4gMCkgewogICAgICAgICAgICBtaW5TaGlmdCA9IHV0aWwubWluKE9iamVjdC5rZXlzKG1heWJlU2hpZnRbdl0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtYXliZVNoaWZ0W3ZdW3VdICsgKHUgaW4gc2hpZnQgPyBzaGlmdFt1XSA6IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSk7CiAgICAgICAgICB9CiAgICAgICAgICBzaGlmdFt2XSA9IG1pblNoaWZ0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIGxheWVyLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgIHhzW3ZdICs9IHNoaWZ0W3Npbmtbcm9vdFt2XV1dIHx8IDA7CiAgICAgIH0pOwogICAgfSk7CgogICAgcmV0dXJuIHhzOwogIH0KCiAgZnVuY3Rpb24gZmluZE1pbkNvb3JkKGcsIGxheWVyaW5nLCB4cykgewogICAgcmV0dXJuIHV0aWwubWluKGxheWVyaW5nLm1hcChmdW5jdGlvbihsYXllcikgewogICAgICB2YXIgdSA9IGxheWVyWzBdOwogICAgICByZXR1cm4geHNbdV07CiAgICB9KSk7CiAgfQoKICBmdW5jdGlvbiBmaW5kTWF4Q29vcmQoZywgbGF5ZXJpbmcsIHhzKSB7CiAgICByZXR1cm4gdXRpbC5tYXgobGF5ZXJpbmcubWFwKGZ1bmN0aW9uKGxheWVyKSB7CiAgICAgIHZhciB1ID0gbGF5ZXJbbGF5ZXIubGVuZ3RoIC0gMV07CiAgICAgIHJldHVybiB4c1t1XTsKICAgIH0pKTsKICB9CgogIGZ1bmN0aW9uIGJhbGFuY2UoZywgbGF5ZXJpbmcsIHhzcykgewogICAgdmFyIG1pbiA9IHt9LCAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNaW4gY29vcmRpbmF0ZSBmb3IgdGhlIGFsaWdubWVudAogICAgICAgIG1heCA9IHt9LCAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBNYXggY29vcmRpbmF0ZSBmb3IgdGhlIGFsZ2lubWVudAogICAgICAgIHNtYWxsZXN0QWxpZ25tZW50LAogICAgICAgIHNoaWZ0ID0ge307ICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBbW91bnQgdG8gc2hpZnQgYSBnaXZlbiBhbGlnbm1lbnQKCiAgICBmdW5jdGlvbiB1cGRhdGVBbGlnbm1lbnQodikgewogICAgICB4c3NbYWxpZ25tZW50XVt2XSArPSBzaGlmdFthbGlnbm1lbnRdOwogICAgfQoKICAgIHZhciBzbWFsbGVzdCA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIGZvciAodmFyIGFsaWdubWVudCBpbiB4c3MpIHsKICAgICAgdmFyIHhzID0geHNzW2FsaWdubWVudF07CiAgICAgIG1pblthbGlnbm1lbnRdID0gZmluZE1pbkNvb3JkKGcsIGxheWVyaW5nLCB4cyk7CiAgICAgIG1heFthbGlnbm1lbnRdID0gZmluZE1heENvb3JkKGcsIGxheWVyaW5nLCB4cyk7CiAgICAgIHZhciB3ID0gbWF4W2FsaWdubWVudF0gLSBtaW5bYWxpZ25tZW50XTsKICAgICAgaWYgKHcgPCBzbWFsbGVzdCkgewogICAgICAgIHNtYWxsZXN0ID0gdzsKICAgICAgICBzbWFsbGVzdEFsaWdubWVudCA9IGFsaWdubWVudDsKICAgICAgfQogICAgfQoKICAgIC8vIERldGVybWluZSBob3cgbXVjaCB0byBhZGp1c3QgcG9zaXRpb25pbmcgZm9yIGVhY2ggYWxpZ25tZW50CiAgICBbJ3UnLCAnZCddLmZvckVhY2goZnVuY3Rpb24odmVydERpcikgewogICAgICBbJ2wnLCAnciddLmZvckVhY2goZnVuY3Rpb24oaG9yaXpEaXIpIHsKICAgICAgICB2YXIgYWxpZ25tZW50ID0gdmVydERpciArIGhvcml6RGlyOwogICAgICAgIHNoaWZ0W2FsaWdubWVudF0gPSBob3JpekRpciA9PT0gJ2wnCiAgICAgICAgICAgID8gbWluW3NtYWxsZXN0QWxpZ25tZW50XSAtIG1pblthbGlnbm1lbnRdCiAgICAgICAgICAgIDogbWF4W3NtYWxsZXN0QWxpZ25tZW50XSAtIG1heFthbGlnbm1lbnRdOwogICAgICB9KTsKICAgIH0pOwoKICAgIC8vIEZpbmQgYXZlcmFnZSBvZiBtZWRpYW5zIGZvciB4c3MgYXJyYXkKICAgIGZvciAoYWxpZ25tZW50IGluIHhzcykgewogICAgICBnLmVhY2hOb2RlKHVwZGF0ZUFsaWdubWVudCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBmbGlwSG9yaXpvbnRhbGx5KHhzKSB7CiAgICBmb3IgKHZhciB1IGluIHhzKSB7CiAgICAgIHhzW3VdID0gLXhzW3VdOwogICAgfQogIH0KCiAgZnVuY3Rpb24gcmV2ZXJzZUlubmVyT3JkZXIobGF5ZXJpbmcpIHsKICAgIGxheWVyaW5nLmZvckVhY2goZnVuY3Rpb24obGF5ZXIpIHsKICAgICAgbGF5ZXIucmV2ZXJzZSgpOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB3aWR0aChnLCB1KSB7CiAgICBzd2l0Y2ggKGcuZ3JhcGgoKS5yYW5rRGlyKSB7CiAgICAgIGNhc2UgJ0xSJzogcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICAgIGNhc2UgJ1JMJzogcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICAgIGRlZmF1bHQ6ICAgcmV0dXJuIGcubm9kZSh1KS53aWR0aDsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhlaWdodChnLCB1KSB7CiAgICBzd2l0Y2goZy5ncmFwaCgpLnJhbmtEaXIpIHsKICAgICAgY2FzZSAnTFInOiByZXR1cm4gZy5ub2RlKHUpLndpZHRoOwogICAgICBjYXNlICdSTCc6IHJldHVybiBnLm5vZGUodSkud2lkdGg7CiAgICAgIGRlZmF1bHQ6ICAgcmV0dXJuIGcubm9kZSh1KS5oZWlnaHQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBzZXAoZywgdSkgewogICAgaWYgKGNvbmZpZy51bml2ZXJzYWxTZXAgIT09IG51bGwpIHsKICAgICAgcmV0dXJuIGNvbmZpZy51bml2ZXJzYWxTZXA7CiAgICB9CiAgICB2YXIgdyA9IHdpZHRoKGcsIHUpOwogICAgdmFyIHMgPSBnLm5vZGUodSkuZHVtbXkgPyBjb25maWcuZWRnZVNlcCA6IGNvbmZpZy5ub2RlU2VwOwogICAgcmV0dXJuICh3ICsgcykgLyAyOwogIH0KCiAgZnVuY3Rpb24gcG9zWChnLCB1LCB4KSB7CiAgICBpZiAoZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdMUicgfHwgZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdSTCcpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS55OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS55ID0geDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS54OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS54ID0geDsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcG9zWERlYnVnKG5hbWUsIGcsIHUsIHgpIHsKICAgIGlmIChnLmdyYXBoKCkucmFua0RpciA9PT0gJ0xSJyB8fCBnLmdyYXBoKCkucmFua0RpciA9PT0gJ1JMJykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDMpIHsKICAgICAgICByZXR1cm4gZy5ub2RlKHUpW25hbWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KVtuYW1lXSA9IHg7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAgIHJldHVybiBnLm5vZGUodSlbbmFtZV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZy5ub2RlKHUpW25hbWVdID0geDsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcG9zWShnLCB1LCB5KSB7CiAgICBpZiAoZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdMUicgfHwgZy5ncmFwaCgpLnJhbmtEaXIgPT09ICdSTCcpIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS54OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS54ID0geTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPCAzKSB7CiAgICAgICAgcmV0dXJuIGcubm9kZSh1KS55OwogICAgICB9IGVsc2UgewogICAgICAgIGcubm9kZSh1KS55ID0geTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZGVidWdQb3NpdGlvbmluZyhhbGlnbiwgZywgbGF5ZXJpbmcsIHhzKSB7CiAgICBsYXllcmluZy5mb3JFYWNoKGZ1bmN0aW9uKGwsIGxpKSB7CiAgICAgIHZhciB1LCB4VTsKICAgICAgbC5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgICB2YXIgeFYgPSB4c1t2XTsKICAgICAgICBpZiAodSkgewogICAgICAgICAgdmFyIHMgPSBzZXAoZywgdSkgKyBzZXAoZywgdik7CiAgICAgICAgICBpZiAoeFYgLSB4VSA8IHMpCiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQb3NpdGlvbiBwaGFzZTogc2VwIHZpb2xhdGlvbi4gQWxpZ246ICcgKyBhbGlnbiArICcuIExheWVyOiAnICsgbGkgKyAnLiAnICsKICAgICAgICAgICAgICAnVTogJyArIHUgKyAnIFY6ICcgKyB2ICsgJy4gQWN0dWFsIHNlcDogJyArICh4ViAtIHhVKSArICcgRXhwZWN0ZWQgc2VwOiAnICsgcyk7CiAgICAgICAgfQogICAgICAgIHUgPSB2OwogICAgICAgIHhVID0geFY7CiAgICAgIH0pOwogICAgfSk7CiAgfQp9OwoKfSx7Ii4vdXRpbCI6MTd9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyksCiAgICBhY3ljbGljID0gcmVxdWlyZSgnLi9yYW5rL2FjeWNsaWMnKSwKICAgIGluaXRSYW5rID0gcmVxdWlyZSgnLi9yYW5rL2luaXRSYW5rJyksCiAgICBmZWFzaWJsZVRyZWUgPSByZXF1aXJlKCcuL3JhbmsvZmVhc2libGVUcmVlJyksCiAgICBjb25zdHJhaW50cyA9IHJlcXVpcmUoJy4vcmFuay9jb25zdHJhaW50cycpLAogICAgc2ltcGxleCA9IHJlcXVpcmUoJy4vcmFuay9zaW1wbGV4JyksCiAgICBjb21wb25lbnRzID0gcmVxdWlyZSgnZ3JhcGhsaWInKS5hbGcuY29tcG9uZW50cywKICAgIGZpbHRlciA9IHJlcXVpcmUoJ2dyYXBobGliJykuZmlsdGVyOwoKZXhwb3J0cy5ydW4gPSBydW47CmV4cG9ydHMucmVzdG9yZUVkZ2VzID0gcmVzdG9yZUVkZ2VzOwoKLyoKICogSGV1cmlzdGljIGZ1bmN0aW9uIHRoYXQgYXNzaWducyBhIHJhbmsgdG8gZWFjaCBub2RlIG9mIHRoZSBpbnB1dCBncmFwaCB3aXRoCiAqIHRoZSBpbnRlbnQgb2YgbWluaW1pemluZyBlZGdlIGxlbmd0aHMsIHdoaWxlIHJlc3BlY3RpbmcgdGhlIGBtaW5MZW5gCiAqIGF0dHJpYnV0ZSBvZiBpbmNpZGVudCBlZGdlcy4KICoKICogUHJlcmVxdWlzaXRlczoKICoKICogICogRWFjaCBlZGdlIGluIHRoZSBpbnB1dCBncmFwaCBtdXN0IGhhdmUgYW4gYXNzaWduZWQgJ21pbkxlbicgYXR0cmlidXRlCiAqLwpmdW5jdGlvbiBydW4oZywgdXNlU2ltcGxleCkgewogIGV4cGFuZFNlbGZMb29wcyhnKTsKCiAgLy8gSWYgdGhlcmUgYXJlIHJhbmsgY29uc3RyYWludHMgb24gbm9kZXMsIHRoZW4gYnVpbGQgYSBuZXcgZ3JhcGggdGhhdAogIC8vIGVuY29kZXMgdGhlIGNvbnN0cmFpbnRzLgogIHV0aWwudGltZSgnY29uc3RyYWludHMuYXBwbHknLCBjb25zdHJhaW50cy5hcHBseSkoZyk7CgogIGV4cGFuZFNpZGV3YXlzRWRnZXMoZyk7CgogIC8vIFJldmVyc2UgZWRnZXMgdG8gZ2V0IGFuIGFjeWNsaWMgZ3JhcGgsIHdlIGtlZXAgdGhlIGdyYXBoIGluIGFuIGFjeWNsaWMKICAvLyBzdGF0ZSB1bnRpbCB0aGUgdmVyeSBlbmQuCiAgdXRpbC50aW1lKCdhY3ljbGljJywgYWN5Y2xpYykoZyk7CgogIC8vIENvbnZlcnQgdGhlIGdyYXBoIGludG8gYSBmbGF0IGdyYXBoIGZvciByYW5raW5nCiAgdmFyIGZsYXRHcmFwaCA9IGcuZmlsdGVyTm9kZXModXRpbC5maWx0ZXJOb25TdWJncmFwaHMoZykpOwoKICAvLyBBc3NpZ24gYW4gaW5pdGlhbCByYW5raW5nIHVzaW5nIERGUy4KICBpbml0UmFuayhmbGF0R3JhcGgpOwoKICAvLyBGb3IgZWFjaCBjb21wb25lbnQgaW1wcm92ZSB0aGUgYXNzaWduZWQgcmFua3MuCiAgY29tcG9uZW50cyhmbGF0R3JhcGgpLmZvckVhY2goZnVuY3Rpb24oY21wdCkgewogICAgdmFyIHN1YmdyYXBoID0gZmxhdEdyYXBoLmZpbHRlck5vZGVzKGZpbHRlci5ub2Rlc0Zyb21MaXN0KGNtcHQpKTsKICAgIHJhbmtDb21wb25lbnQoc3ViZ3JhcGgsIHVzZVNpbXBsZXgpOwogIH0pOwoKICAvLyBSZWxheCBvcmlnaW5hbCBjb25zdHJhaW50cwogIHV0aWwudGltZSgnY29uc3RyYWludHMucmVsYXgnLCBjb25zdHJhaW50cy5yZWxheChnKSk7CgogIC8vIFdoZW4gaGFuZGxpbmcgbm9kZXMgd2l0aCBjb25zdHJhaW5lZCByYW5rcyBpdCBpcyBwb3NzaWJsZSB0byBlbmQgdXAgd2l0aAogIC8vIGVkZ2VzIHRoYXQgcG9pbnQgdG8gcHJldmlvdXMgcmFua3MuIE1vc3Qgb2YgdGhlIHN1YnNlcXVlbnQgYWxnb3JpdGhtcyBhc3N1bWUKICAvLyB0aGF0IGVkZ2VzIGFyZSBwb2ludGluZyB0byBzdWNjZXNzaXZlIHJhbmtzIG9ubHkuIEhlcmUgd2UgcmV2ZXJzZSBhbnkgImJhY2sKICAvLyBlZGdlcyIgYW5kIG1hcmsgdGhlbSBhcyBzdWNoLiBUaGUgYWN5Y2xpYyBhbGdvcml0aG0gd2lsbCByZXZlcnNlIHRoZW0gYXMgYQogIC8vIHBvc3QgcHJvY2Vzc2luZyBzdGVwLgogIHV0aWwudGltZSgncmVvcmllbnRFZGdlcycsIHJlb3JpZW50RWRnZXMpKGcpOwp9CgpmdW5jdGlvbiByZXN0b3JlRWRnZXMoZykgewogIGFjeWNsaWMudW5kbyhnKTsKfQoKLyoKICogRXhwYW5kIHNlbGYgbG9vcHMgaW50byB0aHJlZSBkdW1teSBub2Rlcy4gT25lIHdpbGwgc2l0IGFib3ZlIHRoZSBpbmNpZGVudAogKiBub2RlLCBvbmUgd2lsbCBiZSBhdCB0aGUgc2FtZSBsZXZlbCwgYW5kIG9uZSBiZWxvdy4gVGhlIHJlc3VsdCBsb29rcyBsaWtlOgogKgogKiAgICAgICAgIC8tLTwtLXgtLS0+LS1cCiAqICAgICBub2RlICAgICAgICAgICAgICB5CiAqICAgICAgICAgXC0tPC0tei0tLT4tLS8KICoKICogRHVtbXkgbm9kZXMgeCwgeSwgeiBnaXZlIHVzIHRoZSBzaGFwZSBvZiBhIGxvb3AgYW5kIG5vZGUgeSBpcyB3aGVyZSB3ZSBwbGFjZQogKiB0aGUgbGFiZWwuCiAqCiAqIFRPRE86IGNvbnNvbGlkYXRlIGtub3dsZWRnZSBvZiBkdW1teSBub2RlIGNvbnN0cnVjdGlvbi4KICogVE9ETzogc3VwcG9ydCBtaW5MZW4gPSAyCiAqLwpmdW5jdGlvbiBleHBhbmRTZWxmTG9vcHMoZykgewogIGcuZWFjaEVkZ2UoZnVuY3Rpb24oZSwgdSwgdiwgYSkgewogICAgaWYgKHUgPT09IHYpIHsKICAgICAgdmFyIHggPSBhZGREdW1teU5vZGUoZywgZSwgdSwgdiwgYSwgMCwgZmFsc2UpLAogICAgICAgICAgeSA9IGFkZER1bW15Tm9kZShnLCBlLCB1LCB2LCBhLCAxLCB0cnVlKSwKICAgICAgICAgIHogPSBhZGREdW1teU5vZGUoZywgZSwgdSwgdiwgYSwgMiwgZmFsc2UpOwogICAgICBnLmFkZEVkZ2UobnVsbCwgeCwgdSwge21pbkxlbjogMSwgc2VsZkxvb3A6IHRydWV9KTsKICAgICAgZy5hZGRFZGdlKG51bGwsIHgsIHksIHttaW5MZW46IDEsIHNlbGZMb29wOiB0cnVlfSk7CiAgICAgIGcuYWRkRWRnZShudWxsLCB1LCB6LCB7bWluTGVuOiAxLCBzZWxmTG9vcDogdHJ1ZX0pOwogICAgICBnLmFkZEVkZ2UobnVsbCwgeSwgeiwge21pbkxlbjogMSwgc2VsZkxvb3A6IHRydWV9KTsKICAgICAgZy5kZWxFZGdlKGUpOwogICAgfQogIH0pOwp9CgpmdW5jdGlvbiBleHBhbmRTaWRld2F5c0VkZ2VzKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIGEpIHsKICAgIGlmICh1ID09PSB2KSB7CiAgICAgIHZhciBvcmlnRWRnZSA9IGEub3JpZ2luYWxFZGdlLAogICAgICAgICAgZHVtbXkgPSBhZGREdW1teU5vZGUoZywgb3JpZ0VkZ2UuZSwgb3JpZ0VkZ2UudSwgb3JpZ0VkZ2Uudiwgb3JpZ0VkZ2UudmFsdWUsIDAsIHRydWUpOwogICAgICBnLmFkZEVkZ2UobnVsbCwgdSwgZHVtbXksIHttaW5MZW46IDF9KTsKICAgICAgZy5hZGRFZGdlKG51bGwsIGR1bW15LCB2LCB7bWluTGVuOiAxfSk7CiAgICAgIGcuZGVsRWRnZShlKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gYWRkRHVtbXlOb2RlKGcsIGUsIHUsIHYsIGEsIGluZGV4LCBpc0xhYmVsKSB7CiAgcmV0dXJuIGcuYWRkTm9kZShudWxsLCB7CiAgICB3aWR0aDogaXNMYWJlbCA/IGEud2lkdGggOiAwLAogICAgaGVpZ2h0OiBpc0xhYmVsID8gYS5oZWlnaHQgOiAwLAogICAgZWRnZTogeyBpZDogZSwgc291cmNlOiB1LCB0YXJnZXQ6IHYsIGF0dHJzOiBhIH0sCiAgICBkdW1teTogdHJ1ZSwKICAgIGluZGV4OiBpbmRleAogIH0pOwp9CgpmdW5jdGlvbiByZW9yaWVudEVkZ2VzKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBpZiAoZy5ub2RlKHUpLnJhbmsgPiBnLm5vZGUodikucmFuaykgewogICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgIHZhbHVlLnJldmVyc2VkID0gdHJ1ZTsKICAgICAgZy5hZGRFZGdlKGUsIHYsIHUsIHZhbHVlKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gcmFua0NvbXBvbmVudChzdWJncmFwaCwgdXNlU2ltcGxleCkgewogIHZhciBzcGFubmluZ1RyZWUgPSBmZWFzaWJsZVRyZWUoc3ViZ3JhcGgpOwoKICBpZiAodXNlU2ltcGxleCkgewogICAgdXRpbC5sb2coMSwgJ1VzaW5nIG5ldHdvcmsgc2ltcGxleCBmb3IgcmFua2luZycpOwogICAgc2ltcGxleChzdWJncmFwaCwgc3Bhbm5pbmdUcmVlKTsKICB9CiAgbm9ybWFsaXplKHN1YmdyYXBoKTsKfQoKZnVuY3Rpb24gbm9ybWFsaXplKGcpIHsKICB2YXIgbSA9IHV0aWwubWluKGcubm9kZXMoKS5tYXAoZnVuY3Rpb24odSkgeyByZXR1cm4gZy5ub2RlKHUpLnJhbms7IH0pKTsKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIG5vZGUpIHsgbm9kZS5yYW5rIC09IG07IH0pOwp9Cgp9LHsiLi9yYW5rL2FjeWNsaWMiOjExLCIuL3JhbmsvY29uc3RyYWludHMiOjEyLCIuL3JhbmsvZmVhc2libGVUcmVlIjoxMywiLi9yYW5rL2luaXRSYW5rIjoxNCwiLi9yYW5rL3NpbXBsZXgiOjE2LCIuL3V0aWwiOjE3LCJncmFwaGxpYiI6MjR9XSwxMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpOwoKbW9kdWxlLmV4cG9ydHMgPSBhY3ljbGljOwptb2R1bGUuZXhwb3J0cy51bmRvID0gdW5kbzsKCi8qCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYSBkaXJlY3RlZCBncmFwaCB0aGF0IG1heSBoYXZlIGN5Y2xlcyBhbmQgcmV2ZXJzZXMgZWRnZXMKICogYXMgYXBwcm9wcmlhdGUgdG8gYnJlYWsgdGhlc2UgY3ljbGVzLiBFYWNoIHJldmVyc2VkIGVkZ2UgaXMgYXNzaWduZWQgYQogKiBgcmV2ZXJzZWRgIGF0dHJpYnV0ZSB3aXRoIHRoZSB2YWx1ZSBgdHJ1ZWAuCiAqCiAqIFRoZXJlIHNob3VsZCBiZSBubyBzZWxmIGxvb3BzIGluIHRoZSBncmFwaC4KICovCmZ1bmN0aW9uIGFjeWNsaWMoZykgewogIHZhciBvblN0YWNrID0ge30sCiAgICAgIHZpc2l0ZWQgPSB7fSwKICAgICAgcmV2ZXJzZUNvdW50ID0gMDsKICAKICBmdW5jdGlvbiBkZnModSkgewogICAgaWYgKHUgaW4gdmlzaXRlZCkgcmV0dXJuOwogICAgdmlzaXRlZFt1XSA9IG9uU3RhY2tbdV0gPSB0cnVlOwogICAgZy5vdXRFZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIHQgPSBnLnRhcmdldChlKSwKICAgICAgICAgIHZhbHVlOwoKICAgICAgaWYgKHUgPT09IHQpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdXYXJuaW5nOiBmb3VuZCBzZWxmIGxvb3AgIicgKyBlICsgJyIgZm9yIG5vZGUgIicgKyB1ICsgJyInKTsKICAgICAgfSBlbHNlIGlmICh0IGluIG9uU3RhY2spIHsKICAgICAgICB2YWx1ZSA9IGcuZWRnZShlKTsKICAgICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgICAgICsrcmV2ZXJzZUNvdW50OwogICAgICAgIGcuYWRkRWRnZShlLCB0LCB1LCB2YWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGZzKHQpOwogICAgICB9CiAgICB9KTsKCiAgICBkZWxldGUgb25TdGFja1t1XTsKICB9CgogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSkgeyBkZnModSk7IH0pOwoKICB1dGlsLmxvZygyLCAnQWN5Y2xpYyBQaGFzZTogcmV2ZXJzZWQgJyArIHJldmVyc2VDb3VudCArICcgZWRnZShzKScpOwoKICByZXR1cm4gcmV2ZXJzZUNvdW50Owp9CgovKgogKiBHaXZlbiBhIGdyYXBoIHRoYXQgaGFzIGhhZCB0aGUgYWN5Y2xpYyBvcGVyYXRpb24gYXBwbGllZCwgdGhpcyBmdW5jdGlvbgogKiB1bmRvZXMgdGhhdCBvcGVyYXRpb24uIE1vcmUgc3BlY2lmaWNhbGx5LCBhbnkgZWRnZSB3aXRoIHRoZSBgcmV2ZXJzZWRgCiAqIGF0dHJpYnV0ZSBpcyBhZ2FpbiByZXZlcnNlZCB0byByZXN0b3JlIHRoZSBvcmlnaW5hbCBkaXJlY3Rpb24gb2YgdGhlIGVkZ2UuCiAqLwpmdW5jdGlvbiB1bmRvKGcpIHsKICBnLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHMsIHQsIGEpIHsKICAgIGlmIChhLnJldmVyc2VkKSB7CiAgICAgIGRlbGV0ZSBhLnJldmVyc2VkOwogICAgICBnLmRlbEVkZ2UoZSk7CiAgICAgIGcuYWRkRWRnZShlLCB0LCBzLCBhKTsKICAgIH0KICB9KTsKfQoKfSx7Ii4uL3V0aWwiOjE3fV0sMTI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewpleHBvcnRzLmFwcGx5ID0gZnVuY3Rpb24oZykgewogIGZ1bmN0aW9uIGRmcyhzZykgewogICAgdmFyIHJhbmtTZXRzID0ge307CiAgICBnLmNoaWxkcmVuKHNnKS5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgICAgaWYgKGcuY2hpbGRyZW4odSkubGVuZ3RoKSB7CiAgICAgICAgZGZzKHUpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHZhbHVlID0gZy5ub2RlKHUpLAogICAgICAgICAgcHJlZlJhbmsgPSB2YWx1ZS5wcmVmUmFuazsKICAgICAgaWYgKHByZWZSYW5rICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAoIWNoZWNrU3VwcG9ydGVkUHJlZlJhbmsocHJlZlJhbmspKSB7IHJldHVybjsgfQoKICAgICAgICBpZiAoIShwcmVmUmFuayBpbiByYW5rU2V0cykpIHsKICAgICAgICAgIHJhbmtTZXRzLnByZWZSYW5rID0gW3VdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByYW5rU2V0cy5wcmVmUmFuay5wdXNoKHUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIG5ld1UgPSByYW5rU2V0c1twcmVmUmFua107CiAgICAgICAgaWYgKG5ld1UgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgbmV3VSA9IHJhbmtTZXRzW3ByZWZSYW5rXSA9IGcuYWRkTm9kZShudWxsLCB7IG9yaWdpbmFsTm9kZXM6IFtdIH0pOwogICAgICAgICAgZy5wYXJlbnQobmV3VSwgc2cpOwogICAgICAgIH0KCiAgICAgICAgcmVkaXJlY3RJbkVkZ2VzKGcsIHUsIG5ld1UsIHByZWZSYW5rID09PSAnbWluJyk7CiAgICAgICAgcmVkaXJlY3RPdXRFZGdlcyhnLCB1LCBuZXdVLCBwcmVmUmFuayA9PT0gJ21heCcpOwoKICAgICAgICAvLyBTYXZlIG9yaWdpbmFsIG5vZGUgYW5kIHJlbW92ZSBpdCBmcm9tIHJlZHVjZWQgZ3JhcGgKICAgICAgICBnLm5vZGUobmV3VSkub3JpZ2luYWxOb2Rlcy5wdXNoKHsgdTogdSwgdmFsdWU6IHZhbHVlLCBwYXJlbnQ6IHNnIH0pOwogICAgICAgIGcuZGVsTm9kZSh1KTsKICAgICAgfQogICAgfSk7CgogICAgYWRkTGlnaHRFZGdlc0Zyb21NaW5Ob2RlKGcsIHNnLCByYW5rU2V0cy5taW4pOwogICAgYWRkTGlnaHRFZGdlc1RvTWF4Tm9kZShnLCBzZywgcmFua1NldHMubWF4KTsKICB9CgogIGRmcyhudWxsKTsKfTsKCmZ1bmN0aW9uIGNoZWNrU3VwcG9ydGVkUHJlZlJhbmsocHJlZlJhbmspIHsKICBpZiAocHJlZlJhbmsgIT09ICdtaW4nICYmIHByZWZSYW5rICE9PSAnbWF4JyAmJiBwcmVmUmFuay5pbmRleE9mKCdzYW1lXycpICE9PSAwKSB7CiAgICBjb25zb2xlLmVycm9yKCdVbnN1cHBvcnRlZCByYW5rIHR5cGU6ICcgKyBwcmVmUmFuayk7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CgpmdW5jdGlvbiByZWRpcmVjdEluRWRnZXMoZywgdSwgbmV3VSwgcmV2ZXJzZSkgewogIGcuaW5FZGdlcyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgIHZhciBvcmlnVmFsdWUgPSBnLmVkZ2UoZSksCiAgICAgICAgdmFsdWU7CiAgICBpZiAob3JpZ1ZhbHVlLm9yaWdpbmFsRWRnZSkgewogICAgICB2YWx1ZSA9IG9yaWdWYWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHZhbHVlID0gIHsKICAgICAgICBvcmlnaW5hbEVkZ2U6IHsgZTogZSwgdTogZy5zb3VyY2UoZSksIHY6IGcudGFyZ2V0KGUpLCB2YWx1ZTogb3JpZ1ZhbHVlIH0sCiAgICAgICAgbWluTGVuOiBnLmVkZ2UoZSkubWluTGVuCiAgICAgIH07CiAgICB9CgogICAgLy8gRG8gbm90IHJldmVyc2UgZWRnZXMgZm9yIHNlbGYtbG9vcHMuCiAgICBpZiAob3JpZ1ZhbHVlLnNlbGZMb29wKSB7CiAgICAgIHJldmVyc2UgPSBmYWxzZTsKICAgIH0KCiAgICBpZiAocmV2ZXJzZSkgewogICAgICAvLyBFbnN1cmUgdGhhdCBhbGwgZWRnZXMgdG8gbWluIGFyZSByZXZlcnNlZAogICAgICBnLmFkZEVkZ2UobnVsbCwgbmV3VSwgZy5zb3VyY2UoZSksIHZhbHVlKTsKICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIGcuc291cmNlKGUpLCBuZXdVLCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIHJlZGlyZWN0T3V0RWRnZXMoZywgdSwgbmV3VSwgcmV2ZXJzZSkgewogIGcub3V0RWRnZXModSkuZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICB2YXIgb3JpZ1ZhbHVlID0gZy5lZGdlKGUpLAogICAgICAgIHZhbHVlOwogICAgaWYgKG9yaWdWYWx1ZS5vcmlnaW5hbEVkZ2UpIHsKICAgICAgdmFsdWUgPSBvcmlnVmFsdWU7CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9ICB7CiAgICAgICAgb3JpZ2luYWxFZGdlOiB7IGU6IGUsIHU6IGcuc291cmNlKGUpLCB2OiBnLnRhcmdldChlKSwgdmFsdWU6IG9yaWdWYWx1ZSB9LAogICAgICAgIG1pbkxlbjogZy5lZGdlKGUpLm1pbkxlbgogICAgICB9OwogICAgfQoKICAgIC8vIERvIG5vdCByZXZlcnNlIGVkZ2VzIGZvciBzZWxmLWxvb3BzLgogICAgaWYgKG9yaWdWYWx1ZS5zZWxmTG9vcCkgewogICAgICByZXZlcnNlID0gZmFsc2U7CiAgICB9CgogICAgaWYgKHJldmVyc2UpIHsKICAgICAgLy8gRW5zdXJlIHRoYXQgYWxsIGVkZ2VzIGZyb20gbWF4IGFyZSByZXZlcnNlZAogICAgICBnLmFkZEVkZ2UobnVsbCwgZy50YXJnZXQoZSksIG5ld1UsIHZhbHVlKTsKICAgICAgdmFsdWUucmV2ZXJzZWQgPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIG5ld1UsIGcudGFyZ2V0KGUpLCB2YWx1ZSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGFkZExpZ2h0RWRnZXNGcm9tTWluTm9kZShnLCBzZywgbWluTm9kZSkgewogIGlmIChtaW5Ob2RlICE9PSB1bmRlZmluZWQpIHsKICAgIGcuY2hpbGRyZW4oc2cpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAvLyBUaGUgZHVtbXkgY2hlY2sgZW5zdXJlcyB3ZSBkb24ndCBhZGQgYW4gZWRnZSBpZiB0aGUgbm9kZSBpcyBpbnZvbHZlZAogICAgICAvLyBpbiBhIHNlbGYgbG9vcCBvciBzaWRld2F5cyBlZGdlLgogICAgICBpZiAodSAhPT0gbWluTm9kZSAmJiAhZy5vdXRFZGdlcyhtaW5Ob2RlLCB1KS5sZW5ndGggJiYgIWcubm9kZSh1KS5kdW1teSkgewogICAgICAgIGcuYWRkRWRnZShudWxsLCBtaW5Ob2RlLCB1LCB7IG1pbkxlbjogMCB9KTsKICAgICAgfQogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBhZGRMaWdodEVkZ2VzVG9NYXhOb2RlKGcsIHNnLCBtYXhOb2RlKSB7CiAgaWYgKG1heE5vZGUgIT09IHVuZGVmaW5lZCkgewogICAgZy5jaGlsZHJlbihzZykuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIC8vIFRoZSBkdW1teSBjaGVjayBlbnN1cmVzIHdlIGRvbid0IGFkZCBhbiBlZGdlIGlmIHRoZSBub2RlIGlzIGludm9sdmVkCiAgICAgIC8vIGluIGEgc2VsZiBsb29wIG9yIHNpZGV3YXlzIGVkZ2UuCiAgICAgIGlmICh1ICE9PSBtYXhOb2RlICYmICFnLm91dEVkZ2VzKHUsIG1heE5vZGUpLmxlbmd0aCAmJiAhZy5ub2RlKHUpLmR1bW15KSB7CiAgICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIG1heE5vZGUsIHsgbWluTGVuOiAwIH0pOwogICAgICB9CiAgICB9KTsKICB9Cn0KCi8qCiAqIFRoaXMgZnVuY3Rpb24gInJlbGF4ZXMiIHRoZSBjb25zdHJhaW50cyBhcHBsaWVkIHByZXZpb3VzbHkgYnkgdGhlICJhcHBseSIKICogZnVuY3Rpb24uIEl0IGV4cGFuZHMgYW55IG5vZGVzIHRoYXQgd2VyZSBjb2xsYXBzZWQgYW5kIGFzc2lnbnMgdGhlIHJhbmsgb2YKICogdGhlIGNvbGxhcHNlZCBub2RlIHRvIGVhY2ggb2YgdGhlIGV4cGFuZGVkIG5vZGVzLiBJdCBhbHNvIHJlc3RvcmVzIHRoZQogKiBvcmlnaW5hbCBlZGdlcyBhbmQgcmVtb3ZlcyBhbnkgZHVtbXkgZWRnZXMgcG9pbnRpbmcgYXQgdGhlIGNvbGxhcHNlZCBub2Rlcy4KICoKICogTm90ZSB0aGF0IHRoZSBwcm9jZXNzIG9mIHJlbW92aW5nIGNvbGxhcHNlZCBub2RlcyBhbHNvIHJlbW92ZXMgZHVtbXkgZWRnZXMKICogYXV0b21hdGljYWxseS4KICovCmV4cG9ydHMucmVsYXggPSBmdW5jdGlvbihnKSB7CiAgLy8gU2F2ZSBvcmlnaW5hbCBlZGdlcwogIHZhciBvcmlnaW5hbEVkZ2VzID0gW107CiAgZy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgdmFyIG9yaWdpbmFsRWRnZSA9IHZhbHVlLm9yaWdpbmFsRWRnZTsKICAgIGlmIChvcmlnaW5hbEVkZ2UpIHsKICAgICAgb3JpZ2luYWxFZGdlcy5wdXNoKG9yaWdpbmFsRWRnZSk7CiAgICB9CiAgfSk7CgogIC8vIEV4cGFuZCBjb2xsYXBzZWQgbm9kZXMKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB2YXIgb3JpZ2luYWxOb2RlcyA9IHZhbHVlLm9yaWdpbmFsTm9kZXM7CiAgICBpZiAob3JpZ2luYWxOb2RlcykgewogICAgICBvcmlnaW5hbE5vZGVzLmZvckVhY2goZnVuY3Rpb24ob3JpZ2luYWxOb2RlKSB7CiAgICAgICAgb3JpZ2luYWxOb2RlLnZhbHVlLnJhbmsgPSB2YWx1ZS5yYW5rOwogICAgICAgIGcuYWRkTm9kZShvcmlnaW5hbE5vZGUudSwgb3JpZ2luYWxOb2RlLnZhbHVlKTsKICAgICAgICBnLnBhcmVudChvcmlnaW5hbE5vZGUudSwgb3JpZ2luYWxOb2RlLnBhcmVudCk7CiAgICAgIH0pOwogICAgICBnLmRlbE5vZGUodSk7CiAgICB9CiAgfSk7CgogIC8vIFJlc3RvcmUgb3JpZ2luYWwgZWRnZXMKICBvcmlnaW5hbEVkZ2VzLmZvckVhY2goZnVuY3Rpb24oZWRnZSkgewogICAgZy5hZGRFZGdlKGVkZ2UuZSwgZWRnZS51LCBlZGdlLnYsIGVkZ2UudmFsdWUpOwogIH0pOwp9OwoKfSx7fV0sMTM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKiBqc2hpbnQgLVcwNzkgKi8KdmFyIFNldCA9IHJlcXVpcmUoJ2NwLWRhdGEnKS5TZXQsCi8qIGpzaGludCArVzA3OSAqLwogICAgRGlncmFwaCA9IHJlcXVpcmUoJ2dyYXBobGliJykuRGlncmFwaCwKICAgIHV0aWwgPSByZXF1aXJlKCcuLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IGZlYXNpYmxlVHJlZTsKCi8qCiAqIEdpdmVuIGFuIGFjeWNsaWMgZ3JhcGggd2l0aCBlYWNoIG5vZGUgYXNzaWduZWQgYSBgcmFua2AgYXR0cmlidXRlLCB0aGlzCiAqIGZ1bmN0aW9uIGNvbnN0cnVjdHMgYW5kIHJldHVybnMgYSBzcGFubmluZyB0cmVlLiBUaGlzIGZ1bmN0aW9uIG1heSByZWR1Y2UKICogdGhlIGxlbmd0aCBvZiBzb21lIGVkZ2VzIGZyb20gdGhlIGluaXRpYWwgcmFuayBhc3NpZ25tZW50IHdoaWxlIG1haW50YWluaW5nCiAqIHRoZSBgbWluTGVuYCBzcGVjaWZpZWQgYnkgZWFjaCBlZGdlLgogKgogKiBQcmVyZXF1aXNpdGVzOgogKgogKiAqIFRoZSBpbnB1dCBncmFwaCBpcyBhY3ljbGljCiAqICogRWFjaCBub2RlIGluIHRoZSBpbnB1dCBncmFwaCBoYXMgYW4gYXNzaWduZWQgYHJhbmtgIGF0dHJpYnV0ZQogKiAqIEVhY2ggZWRnZSBpbiB0aGUgaW5wdXQgZ3JhcGggaGFzIGFuIGFzc2lnbmVkIGBtaW5MZW5gIGF0dHJpYnV0ZQogKgogKiBPdXRwdXRzOgogKgogKiBBIGZlYXNpYmxlIHNwYW5uaW5nIHRyZWUgZm9yIHRoZSBpbnB1dCBncmFwaCAoaS5lLiBhIHNwYW5uaW5nIHRyZWUgdGhhdAogKiByZXNwZWN0cyBlYWNoIGdyYXBoIGVkZ2UncyBgbWluTGVuYCBhdHRyaWJ1dGUpIHJlcHJlc2VudGVkIGFzIGEgRGlncmFwaCB3aXRoCiAqIGEgYHJvb3RgIGF0dHJpYnV0ZSBvbiBncmFwaC4KICoKICogTm9kZXMgaGF2ZSB0aGUgc2FtZSBpZCBhbmQgdmFsdWUgYXMgdGhhdCBpbiB0aGUgaW5wdXQgZ3JhcGguCiAqCiAqIEVkZ2VzIGluIHRoZSB0cmVlIGhhdmUgYXJiaXRyYXJpbHkgYXNzaWduZWQgaWRzLiBUaGUgYXR0cmlidXRlcyBmb3IgZWRnZXMKICogaW5jbHVkZSBgcmV2ZXJzZWRgLiBgcmV2ZXJzZWRgIGluZGljYXRlcyB0aGF0IHRoZSBlZGdlIGlzIGEKICogYmFjayBlZGdlIGluIHRoZSBpbnB1dCBncmFwaC4KICovCmZ1bmN0aW9uIGZlYXNpYmxlVHJlZShnKSB7CiAgdmFyIHJlbWFpbmluZyA9IG5ldyBTZXQoZy5ub2RlcygpKSwKICAgICAgdHJlZSA9IG5ldyBEaWdyYXBoKCk7CgogIGlmIChyZW1haW5pbmcuc2l6ZSgpID09PSAxKSB7CiAgICB2YXIgcm9vdCA9IGcubm9kZXMoKVswXTsKICAgIHRyZWUuYWRkTm9kZShyb290LCB7fSk7CiAgICB0cmVlLmdyYXBoKHsgcm9vdDogcm9vdCB9KTsKICAgIHJldHVybiB0cmVlOwogIH0KCiAgZnVuY3Rpb24gYWRkVGlnaHRFZGdlcyh2KSB7CiAgICB2YXIgY29udGludWVUb1NjYW4gPSB0cnVlOwogICAgZy5wcmVkZWNlc3NvcnModikuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIGlmIChyZW1haW5pbmcuaGFzKHUpICYmICFzbGFjayhnLCB1LCB2KSkgewogICAgICAgIGlmIChyZW1haW5pbmcuaGFzKHYpKSB7CiAgICAgICAgICB0cmVlLmFkZE5vZGUodiwge30pOwogICAgICAgICAgcmVtYWluaW5nLnJlbW92ZSh2KTsKICAgICAgICAgIHRyZWUuZ3JhcGgoeyByb290OiB2IH0pOwogICAgICAgIH0KCiAgICAgICAgdHJlZS5hZGROb2RlKHUsIHt9KTsKICAgICAgICB0cmVlLmFkZEVkZ2UobnVsbCwgdSwgdiwgeyByZXZlcnNlZDogdHJ1ZSB9KTsKICAgICAgICByZW1haW5pbmcucmVtb3ZlKHUpOwogICAgICAgIGFkZFRpZ2h0RWRnZXModSk7CiAgICAgICAgY29udGludWVUb1NjYW4gPSBmYWxzZTsKICAgICAgfQogICAgfSk7CgogICAgZy5zdWNjZXNzb3JzKHYpLmZvckVhY2goZnVuY3Rpb24odykgIHsKICAgICAgaWYgKHJlbWFpbmluZy5oYXModykgJiYgIXNsYWNrKGcsIHYsIHcpKSB7CiAgICAgICAgaWYgKHJlbWFpbmluZy5oYXModikpIHsKICAgICAgICAgIHRyZWUuYWRkTm9kZSh2LCB7fSk7CiAgICAgICAgICByZW1haW5pbmcucmVtb3ZlKHYpOwogICAgICAgICAgdHJlZS5ncmFwaCh7IHJvb3Q6IHYgfSk7CiAgICAgICAgfQoKICAgICAgICB0cmVlLmFkZE5vZGUodywge30pOwogICAgICAgIHRyZWUuYWRkRWRnZShudWxsLCB2LCB3LCB7fSk7CiAgICAgICAgcmVtYWluaW5nLnJlbW92ZSh3KTsKICAgICAgICBhZGRUaWdodEVkZ2VzKHcpOwogICAgICAgIGNvbnRpbnVlVG9TY2FuID0gZmFsc2U7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGNvbnRpbnVlVG9TY2FuOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlVGlnaHRFZGdlKCkgewogICAgdmFyIG1pblNsYWNrID0gTnVtYmVyLk1BWF9WQUxVRTsKICAgIHJlbWFpbmluZy5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGcucHJlZGVjZXNzb3JzKHYpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgICAgIGlmICghcmVtYWluaW5nLmhhcyh1KSkgewogICAgICAgICAgdmFyIGVkZ2VTbGFjayA9IHNsYWNrKGcsIHUsIHYpOwogICAgICAgICAgaWYgKE1hdGguYWJzKGVkZ2VTbGFjaykgPCBNYXRoLmFicyhtaW5TbGFjaykpIHsKICAgICAgICAgICAgbWluU2xhY2sgPSAtZWRnZVNsYWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICBnLnN1Y2Nlc3NvcnModikuZm9yRWFjaChmdW5jdGlvbih3KSB7CiAgICAgICAgaWYgKCFyZW1haW5pbmcuaGFzKHcpKSB7CiAgICAgICAgICB2YXIgZWRnZVNsYWNrID0gc2xhY2soZywgdiwgdyk7CiAgICAgICAgICBpZiAoTWF0aC5hYnMoZWRnZVNsYWNrKSA8IE1hdGguYWJzKG1pblNsYWNrKSkgewogICAgICAgICAgICBtaW5TbGFjayA9IGVkZ2VTbGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CgogICAgdHJlZS5lYWNoTm9kZShmdW5jdGlvbih1KSB7IGcubm9kZSh1KS5yYW5rIC09IG1pblNsYWNrOyB9KTsKICB9CgogIHdoaWxlIChyZW1haW5pbmcuc2l6ZSgpKSB7CiAgICB2YXIgbm9kZXNUb1NlYXJjaCA9ICF0cmVlLm9yZGVyKCkgPyByZW1haW5pbmcua2V5cygpIDogdHJlZS5ub2RlcygpOwogICAgZm9yICh2YXIgaSA9IDAsIGlsID0gbm9kZXNUb1NlYXJjaC5sZW5ndGg7CiAgICAgICAgIGkgPCBpbCAmJiBhZGRUaWdodEVkZ2VzKG5vZGVzVG9TZWFyY2hbaV0pOwogICAgICAgICArK2kpOwogICAgaWYgKHJlbWFpbmluZy5zaXplKCkpIHsKICAgICAgY3JlYXRlVGlnaHRFZGdlKCk7CiAgICB9CiAgfQoKICByZXR1cm4gdHJlZTsKfQoKZnVuY3Rpb24gc2xhY2soZywgdSwgdikgewogIHZhciByYW5rRGlmZiA9IGcubm9kZSh2KS5yYW5rIC0gZy5ub2RlKHUpLnJhbms7CiAgdmFyIG1heE1pbkxlbiA9IHV0aWwubWF4KGcub3V0RWRnZXModSwgdikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24oZSkgeyByZXR1cm4gZy5lZGdlKGUpLm1pbkxlbjsgfSkpOwogIHJldHVybiByYW5rRGlmZiAtIG1heE1pbkxlbjsKfQoKfSx7Ii4uL3V0aWwiOjE3LCJjcC1kYXRhIjoxOSwiZ3JhcGhsaWIiOjI0fV0sMTQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgdXRpbCA9IHJlcXVpcmUoJy4uL3V0aWwnKSwKICAgIHRvcHNvcnQgPSByZXF1aXJlKCdncmFwaGxpYicpLmFsZy50b3Bzb3J0OwoKbW9kdWxlLmV4cG9ydHMgPSBpbml0UmFuazsKCi8qCiAqIEFzc2lnbnMgYSBgcmFua2AgYXR0cmlidXRlIHRvIGVhY2ggbm9kZSBpbiB0aGUgaW5wdXQgZ3JhcGggYW5kIGVuc3VyZXMgdGhhdAogKiB0aGlzIHJhbmsgcmVzcGVjdHMgdGhlIGBtaW5MZW5gIGF0dHJpYnV0ZSBvZiBpbmNpZGVudCBlZGdlcy4KICoKICogUHJlcmVxdWlzaXRlczoKICoKICogICogVGhlIGlucHV0IGdyYXBoIG11c3QgYmUgYWN5Y2xpYwogKiAgKiBFYWNoIGVkZ2UgaW4gdGhlIGlucHV0IGdyYXBoIG11c3QgaGF2ZSBhbiBhc3NpZ25lZCAnbWluTGVuJyBhdHRyaWJ1dGUKICovCmZ1bmN0aW9uIGluaXRSYW5rKGcpIHsKICB2YXIgc29ydGVkID0gdG9wc29ydChnKTsKCiAgc29ydGVkLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgdmFyIGluRWRnZXMgPSBnLmluRWRnZXModSk7CiAgICBpZiAoaW5FZGdlcy5sZW5ndGggPT09IDApIHsKICAgICAgZy5ub2RlKHUpLnJhbmsgPSAwOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIG1pbkxlbnMgPSBpbkVkZ2VzLm1hcChmdW5jdGlvbihlKSB7CiAgICAgIHJldHVybiBnLm5vZGUoZy5zb3VyY2UoZSkpLnJhbmsgKyBnLmVkZ2UoZSkubWluTGVuOwogICAgfSk7CiAgICBnLm5vZGUodSkucmFuayA9IHV0aWwubWF4KG1pbkxlbnMpOwogIH0pOwp9Cgp9LHsiLi4vdXRpbCI6MTcsImdyYXBobGliIjoyNH1dLDE1OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSB7CiAgc2xhY2s6IHNsYWNrCn07CgovKgogKiBBIGhlbHBlciB0byBjYWxjdWxhdGUgdGhlIHNsYWNrIGJldHdlZW4gdHdvIG5vZGVzIChgdWAgYW5kIGB2YCkgZ2l2ZW4gYQogKiBgbWluTGVuYCBjb25zdHJhaW50LiBUaGUgc2xhY2sgcmVwcmVzZW50cyBob3cgbXVjaCB0aGUgZGlzdGFuY2UgYmV0d2VlbiBgdWAKICogYW5kIGB2YCBjb3VsZCBzaHJpbmsgd2hpbGUgbWFpbnRhaW5pbmcgdGhlIGBtaW5MZW5gIGNvbnN0cmFpbnQuIElmIHRoZSB2YWx1ZQogKiBpcyBuZWdhdGl2ZSB0aGVuIHRoZSBjb25zdHJhaW50IGlzIGN1cnJlbnRseSB2aW9sYXRlZC4KICoKICBUaGlzIGZ1bmN0aW9uIHJlcXVpcmVzIHRoYXQgYHVgIGFuZCBgdmAgYXJlIGluIGBncmFwaGAgYW5kIHRoZXkgYm90aCBoYXZlIGEKICBgcmFua2AgYXR0cmlidXRlLgogKi8KZnVuY3Rpb24gc2xhY2soZ3JhcGgsIHUsIHYsIG1pbkxlbikgewogIHJldHVybiBNYXRoLmFicyhncmFwaC5ub2RlKHUpLnJhbmsgLSBncmFwaC5ub2RlKHYpLnJhbmspIC0gbWluTGVuOwp9Cgp9LHt9XSwxNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi4vdXRpbCcpLAogICAgcmFua1V0aWwgPSByZXF1aXJlKCcuL3JhbmtVdGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IHNpbXBsZXg7CgpmdW5jdGlvbiBzaW1wbGV4KGdyYXBoLCBzcGFubmluZ1RyZWUpIHsKICAvLyBUaGUgbmV0d29yayBzaW1wbGV4IGFsZ29yaXRobSByZXBlYXRlZGx5IHJlcGxhY2VzIGVkZ2VzIG9mCiAgLy8gdGhlIHNwYW5uaW5nIHRyZWUgd2l0aCBuZWdhdGl2ZSBjdXQgdmFsdWVzIHVudGlsIG5vIHN1Y2gKICAvLyBlZGdlIGV4aXN0cy4KICBpbml0Q3V0VmFsdWVzKGdyYXBoLCBzcGFubmluZ1RyZWUpOwogIHdoaWxlICh0cnVlKSB7CiAgICB2YXIgZSA9IGxlYXZlRWRnZShzcGFubmluZ1RyZWUpOwogICAgaWYgKGUgPT09IG51bGwpIGJyZWFrOwogICAgdmFyIGYgPSBlbnRlckVkZ2UoZ3JhcGgsIHNwYW5uaW5nVHJlZSwgZSk7CiAgICBleGNoYW5nZShncmFwaCwgc3Bhbm5pbmdUcmVlLCBlLCBmKTsKICB9Cn0KCi8qCiAqIFNldCB0aGUgY3V0IHZhbHVlcyBvZiBlZGdlcyBpbiB0aGUgc3Bhbm5pbmcgdHJlZSBieSBhIGRlcHRoLWZpcnN0CiAqIHBvc3RvcmRlciB0cmF2ZXJzYWwuICBUaGUgY3V0IHZhbHVlIGNvcnJlc3BvbmRzIHRvIHRoZSBjb3N0LCBpbgogKiB0ZXJtcyBvZiBhIHJhbmtpbmcncyBlZGdlIGxlbmd0aCBzdW0sIG9mIGxlbmd0aGVuaW5nIGFuIGVkZ2UuCiAqIE5lZ2F0aXZlIGN1dCB2YWx1ZXMgdHlwaWNhbGx5IGluZGljYXRlIGVkZ2VzIHRoYXQgd291bGQgeWllbGQgYQogKiBzbWFsbGVyIGVkZ2UgbGVuZ3RoIHN1bSBpZiB0aGV5IHdlcmUgbGVuZ3RoZW5lZC4KICovCmZ1bmN0aW9uIGluaXRDdXRWYWx1ZXMoZ3JhcGgsIHNwYW5uaW5nVHJlZSkgewogIGNvbXB1dGVMb3dMaW0oc3Bhbm5pbmdUcmVlKTsKCiAgc3Bhbm5pbmdUcmVlLmVhY2hFZGdlKGZ1bmN0aW9uKGlkLCB1LCB2LCB0cmVlVmFsdWUpIHsKICAgIHRyZWVWYWx1ZS5jdXRWYWx1ZSA9IDA7CiAgfSk7CgogIC8vIFByb3BhZ2F0ZSBjdXQgdmFsdWVzIHVwIHRoZSB0cmVlLgogIGZ1bmN0aW9uIGRmcyhuKSB7CiAgICB2YXIgY2hpbGRyZW4gPSBzcGFubmluZ1RyZWUuc3VjY2Vzc29ycyhuKTsKICAgIGZvciAodmFyIGMgaW4gY2hpbGRyZW4pIHsKICAgICAgdmFyIGNoaWxkID0gY2hpbGRyZW5bY107CiAgICAgIGRmcyhjaGlsZCk7CiAgICB9CiAgICBpZiAobiAhPT0gc3Bhbm5pbmdUcmVlLmdyYXBoKCkucm9vdCkgewogICAgICBzZXRDdXRWYWx1ZShncmFwaCwgc3Bhbm5pbmdUcmVlLCBuKTsKICAgIH0KICB9CiAgZGZzKHNwYW5uaW5nVHJlZS5ncmFwaCgpLnJvb3QpOwp9CgovKgogKiBQZXJmb3JtIGEgREZTIHBvc3RvcmRlciB0cmF2ZXJzYWwsIGxhYmVsaW5nIGVhY2ggbm9kZSB2IHdpdGgKICogaXRzIHRyYXZlcnNhbCBvcmRlciAnbGltKHYpJyBhbmQgdGhlIG1pbmltdW0gdHJhdmVyc2FsIG51bWJlcgogKiBvZiBhbnkgb2YgaXRzIGRlc2NlbmRhbnRzICdsb3codiknLiAgVGhpcyBwcm92aWRlcyBhbiBlZmZpY2llbnQKICogd2F5IHRvIHRlc3Qgd2hldGhlciB1IGlzIGFuIGFuY2VzdG9yIG9mIHYgc2luY2UKICogbG93KHUpIDw9IGxpbSh2KSA8PSBsaW0odSkgaWYgYW5kIG9ubHkgaWYgdSBpcyBhbiBhbmNlc3Rvci4KICovCmZ1bmN0aW9uIGNvbXB1dGVMb3dMaW0odHJlZSkgewogIHZhciBwb3N0T3JkZXJOdW0gPSAwOwogIAogIGZ1bmN0aW9uIGRmcyhuKSB7CiAgICB2YXIgY2hpbGRyZW4gPSB0cmVlLnN1Y2Nlc3NvcnMobik7CiAgICB2YXIgbG93ID0gcG9zdE9yZGVyTnVtOwogICAgZm9yICh2YXIgYyBpbiBjaGlsZHJlbikgewogICAgICB2YXIgY2hpbGQgPSBjaGlsZHJlbltjXTsKICAgICAgZGZzKGNoaWxkKTsKICAgICAgbG93ID0gTWF0aC5taW4obG93LCB0cmVlLm5vZGUoY2hpbGQpLmxvdyk7CiAgICB9CiAgICB0cmVlLm5vZGUobikubG93ID0gbG93OwogICAgdHJlZS5ub2RlKG4pLmxpbSA9IHBvc3RPcmRlck51bSsrOwogIH0KCiAgZGZzKHRyZWUuZ3JhcGgoKS5yb290KTsKfQoKLyoKICogVG8gY29tcHV0ZSB0aGUgY3V0IHZhbHVlIG9mIHRoZSBlZGdlIHBhcmVudCAtPiBjaGlsZCwgd2UgY29uc2lkZXIKICogaXQgYW5kIGFueSBvdGhlciBncmFwaCBlZGdlcyB0byBvciBmcm9tIHRoZSBjaGlsZC4KICogICAgICAgICAgcGFyZW50CiAqICAgICAgICAgICAgIHwKICogICAgICAgICAgIGNoaWxkCiAqICAgICAgICAgIC8gICAgICBcCiAqICAgICAgICAgdSAgICAgICAgdgogKi8KZnVuY3Rpb24gc2V0Q3V0VmFsdWUoZ3JhcGgsIHRyZWUsIGNoaWxkKSB7CiAgdmFyIHBhcmVudEVkZ2UgPSB0cmVlLmluRWRnZXMoY2hpbGQpWzBdOwoKICAvLyBMaXN0IG9mIGNoaWxkJ3MgY2hpbGRyZW4gaW4gdGhlIHNwYW5uaW5nIHRyZWUuCiAgdmFyIGdyYW5kY2hpbGRyZW4gPSBbXTsKICB2YXIgZ3JhbmRjaGlsZEVkZ2VzID0gdHJlZS5vdXRFZGdlcyhjaGlsZCk7CiAgZm9yICh2YXIgZ2NlIGluIGdyYW5kY2hpbGRFZGdlcykgewogICAgZ3JhbmRjaGlsZHJlbi5wdXNoKHRyZWUudGFyZ2V0KGdyYW5kY2hpbGRFZGdlc1tnY2VdKSk7CiAgfQoKICB2YXIgY3V0VmFsdWUgPSAwOwoKICAvLyBUT0RPOiBSZXBsYWNlIHVuaXQgaW5jcmVtZW50L2RlY3JlbWVudCB3aXRoIGVkZ2Ugd2VpZ2h0cy4KICB2YXIgRSA9IDA7ICAgIC8vIEVkZ2VzIGZyb20gY2hpbGQgdG8gZ3JhbmRjaGlsZCdzIHN1YnRyZWUuCiAgdmFyIEYgPSAwOyAgICAvLyBFZGdlcyB0byBjaGlsZCBmcm9tIGdyYW5kY2hpbGQncyBzdWJ0cmVlLgogIHZhciBHID0gMDsgICAgLy8gRWRnZXMgZnJvbSBjaGlsZCB0byBub2RlcyBvdXRzaWRlIG9mIGNoaWxkJ3Mgc3VidHJlZS4KICB2YXIgSCA9IDA7ICAgIC8vIEVkZ2VzIGZyb20gbm9kZXMgb3V0c2lkZSBvZiBjaGlsZCdzIHN1YnRyZWUgdG8gY2hpbGQuCgogIC8vIENvbnNpZGVyIGFsbCBncmFwaCBlZGdlcyBmcm9tIGNoaWxkLgogIHZhciBvdXRFZGdlcyA9IGdyYXBoLm91dEVkZ2VzKGNoaWxkKTsKICB2YXIgZ2M7CiAgZm9yICh2YXIgb2UgaW4gb3V0RWRnZXMpIHsKICAgIHZhciBzdWNjID0gZ3JhcGgudGFyZ2V0KG91dEVkZ2VzW29lXSk7CiAgICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgICAgaWYgKGluU3VidHJlZSh0cmVlLCBzdWNjLCBncmFuZGNoaWxkcmVuW2djXSkpIHsKICAgICAgICBFKys7CiAgICAgIH0KICAgIH0KICAgIGlmICghaW5TdWJ0cmVlKHRyZWUsIHN1Y2MsIGNoaWxkKSkgewogICAgICBHKys7CiAgICB9CiAgfQoKICAvLyBDb25zaWRlciBhbGwgZ3JhcGggZWRnZXMgdG8gY2hpbGQuCiAgdmFyIGluRWRnZXMgPSBncmFwaC5pbkVkZ2VzKGNoaWxkKTsKICBmb3IgKHZhciBpZSBpbiBpbkVkZ2VzKSB7CiAgICB2YXIgcHJlZCA9IGdyYXBoLnNvdXJjZShpbkVkZ2VzW2llXSk7CiAgICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgICAgaWYgKGluU3VidHJlZSh0cmVlLCBwcmVkLCBncmFuZGNoaWxkcmVuW2djXSkpIHsKICAgICAgICBGKys7CiAgICAgIH0KICAgIH0KICAgIGlmICghaW5TdWJ0cmVlKHRyZWUsIHByZWQsIGNoaWxkKSkgewogICAgICBIKys7CiAgICB9CiAgfQoKICAvLyBDb250cmlidXRpb25zIGRlcGVuZCBvbiB0aGUgYWxpZ25tZW50IG9mIHRoZSBwYXJlbnQgLT4gY2hpbGQgZWRnZQogIC8vIGFuZCB0aGUgY2hpbGQgLT4gdSBvciB2IGVkZ2VzLgogIHZhciBncmFuZGNoaWxkQ3V0U3VtID0gMDsKICBmb3IgKGdjIGluIGdyYW5kY2hpbGRyZW4pIHsKICAgIHZhciBjdiA9IHRyZWUuZWRnZShncmFuZGNoaWxkRWRnZXNbZ2NdKS5jdXRWYWx1ZTsKICAgIGlmICghdHJlZS5lZGdlKGdyYW5kY2hpbGRFZGdlc1tnY10pLnJldmVyc2VkKSB7CiAgICAgIGdyYW5kY2hpbGRDdXRTdW0gKz0gY3Y7CiAgICB9IGVsc2UgewogICAgICBncmFuZGNoaWxkQ3V0U3VtIC09IGN2OwogICAgfQogIH0KCiAgaWYgKCF0cmVlLmVkZ2UocGFyZW50RWRnZSkucmV2ZXJzZWQpIHsKICAgIGN1dFZhbHVlICs9IGdyYW5kY2hpbGRDdXRTdW0gLSBFICsgRiAtIEcgKyBIOwogIH0gZWxzZSB7CiAgICBjdXRWYWx1ZSAtPSBncmFuZGNoaWxkQ3V0U3VtIC0gRSArIEYgLSBHICsgSDsKICB9CgogIHRyZWUuZWRnZShwYXJlbnRFZGdlKS5jdXRWYWx1ZSA9IGN1dFZhbHVlOwp9CgovKgogKiBSZXR1cm4gd2hldGhlciBuIGlzIGEgbm9kZSBpbiB0aGUgc3VidHJlZSB3aXRoIHRoZSBnaXZlbgogKiByb290LgogKi8KZnVuY3Rpb24gaW5TdWJ0cmVlKHRyZWUsIG4sIHJvb3QpIHsKICByZXR1cm4gKHRyZWUubm9kZShyb290KS5sb3cgPD0gdHJlZS5ub2RlKG4pLmxpbSAmJgogICAgICAgICAgdHJlZS5ub2RlKG4pLmxpbSA8PSB0cmVlLm5vZGUocm9vdCkubGltKTsKfQoKLyoKICogUmV0dXJuIGFuIGVkZ2UgZnJvbSB0aGUgdHJlZSB3aXRoIGEgbmVnYXRpdmUgY3V0IHZhbHVlLCBvciBudWxsIGlmIHRoZXJlCiAqIGlzIG5vbmUuCiAqLwpmdW5jdGlvbiBsZWF2ZUVkZ2UodHJlZSkgewogIHZhciBlZGdlcyA9IHRyZWUuZWRnZXMoKTsKICBmb3IgKHZhciBuIGluIGVkZ2VzKSB7CiAgICB2YXIgZSA9IGVkZ2VzW25dOwogICAgdmFyIHRyZWVWYWx1ZSA9IHRyZWUuZWRnZShlKTsKICAgIGlmICh0cmVlVmFsdWUuY3V0VmFsdWUgPCAwKSB7CiAgICAgIHJldHVybiBlOwogICAgfQogIH0KICByZXR1cm4gbnVsbDsKfQoKLyoKICogVGhlIGVkZ2UgZSBzaG91bGQgYmUgYW4gZWRnZSBpbiB0aGUgdHJlZSwgd2l0aCBhbiB1bmRlcmx5aW5nIGVkZ2UKICogaW4gdGhlIGdyYXBoLCB3aXRoIGEgbmVnYXRpdmUgY3V0IHZhbHVlLiAgT2YgdGhlIHR3byBub2RlcyBpbmNpZGVudAogKiBvbiB0aGUgZWRnZSwgdGFrZSB0aGUgbG93ZXIgb25lLiAgZW50ZXJFZGdlIHJldHVybnMgYW4gZWRnZSB3aXRoCiAqIG1pbmltdW0gc2xhY2sgZ29pbmcgZnJvbSBvdXRzaWRlIG9mIHRoYXQgbm9kZSdzIHN1YnRyZWUgdG8gaW5zaWRlCiAqIG9mIHRoYXQgbm9kZSdzIHN1YnRyZWUuCiAqLwpmdW5jdGlvbiBlbnRlckVkZ2UoZ3JhcGgsIHRyZWUsIGUpIHsKICB2YXIgc291cmNlID0gdHJlZS5zb3VyY2UoZSk7CiAgdmFyIHRhcmdldCA9IHRyZWUudGFyZ2V0KGUpOwogIHZhciBsb3dlciA9IHRyZWUubm9kZSh0YXJnZXQpLmxpbSA8IHRyZWUubm9kZShzb3VyY2UpLmxpbSA/IHRhcmdldCA6IHNvdXJjZTsKCiAgLy8gSXMgdGhlIHRyZWUgZWRnZSBhbGlnbmVkIHdpdGggdGhlIGdyYXBoIGVkZ2U/CiAgdmFyIGFsaWduZWQgPSAhdHJlZS5lZGdlKGUpLnJldmVyc2VkOwoKICB2YXIgbWluU2xhY2sgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgdmFyIG1pblNsYWNrRWRnZTsKICBpZiAoYWxpZ25lZCkgewogICAgZ3JhcGguZWFjaEVkZ2UoZnVuY3Rpb24oaWQsIHUsIHYsIHZhbHVlKSB7CiAgICAgIGlmIChpZCAhPT0gZSAmJiBpblN1YnRyZWUodHJlZSwgdSwgbG93ZXIpICYmICFpblN1YnRyZWUodHJlZSwgdiwgbG93ZXIpKSB7CiAgICAgICAgdmFyIHNsYWNrID0gcmFua1V0aWwuc2xhY2soZ3JhcGgsIHUsIHYsIHZhbHVlLm1pbkxlbik7CiAgICAgICAgaWYgKHNsYWNrIDwgbWluU2xhY2spIHsKICAgICAgICAgIG1pblNsYWNrID0gc2xhY2s7CiAgICAgICAgICBtaW5TbGFja0VkZ2UgPSBpZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0gZWxzZSB7CiAgICBncmFwaC5lYWNoRWRnZShmdW5jdGlvbihpZCwgdSwgdiwgdmFsdWUpIHsKICAgICAgaWYgKGlkICE9PSBlICYmICFpblN1YnRyZWUodHJlZSwgdSwgbG93ZXIpICYmIGluU3VidHJlZSh0cmVlLCB2LCBsb3dlcikpIHsKICAgICAgICB2YXIgc2xhY2sgPSByYW5rVXRpbC5zbGFjayhncmFwaCwgdSwgdiwgdmFsdWUubWluTGVuKTsKICAgICAgICBpZiAoc2xhY2sgPCBtaW5TbGFjaykgewogICAgICAgICAgbWluU2xhY2sgPSBzbGFjazsKICAgICAgICAgIG1pblNsYWNrRWRnZSA9IGlkOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAobWluU2xhY2tFZGdlID09PSB1bmRlZmluZWQpIHsKICAgIHZhciBvdXRzaWRlID0gW107CiAgICB2YXIgaW5zaWRlID0gW107CiAgICBncmFwaC5lYWNoTm9kZShmdW5jdGlvbihpZCkgewogICAgICBpZiAoIWluU3VidHJlZSh0cmVlLCBpZCwgbG93ZXIpKSB7CiAgICAgICAgb3V0c2lkZS5wdXNoKGlkKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpbnNpZGUucHVzaChpZCk7CiAgICAgIH0KICAgIH0pOwogICAgdGhyb3cgbmV3IEVycm9yKCdObyBlZGdlIGZvdW5kIGZyb20gb3V0c2lkZSBvZiB0cmVlIHRvIGluc2lkZScpOwogIH0KCiAgcmV0dXJuIG1pblNsYWNrRWRnZTsKfQoKLyoKICogUmVwbGFjZSBlZGdlIGUgd2l0aCBlZGdlIGYgaW4gdGhlIHRyZWUsIHJlY2FsY3VsYXRpbmcgdGhlIHRyZWUgcm9vdCwKICogdGhlIG5vZGVzJyBsb3cgYW5kIGxpbSBwcm9wZXJ0aWVzIGFuZCB0aGUgZWRnZXMnIGN1dCB2YWx1ZXMuCiAqLwpmdW5jdGlvbiBleGNoYW5nZShncmFwaCwgdHJlZSwgZSwgZikgewogIHRyZWUuZGVsRWRnZShlKTsKICB2YXIgc291cmNlID0gZ3JhcGguc291cmNlKGYpOwogIHZhciB0YXJnZXQgPSBncmFwaC50YXJnZXQoZik7CgogIC8vIFJlZGlyZWN0IGVkZ2VzIHNvIHRoYXQgdGFyZ2V0IGlzIHRoZSByb290IG9mIGl0cyBzdWJ0cmVlLgogIGZ1bmN0aW9uIHJlZGlyZWN0KHYpIHsKICAgIHZhciBlZGdlcyA9IHRyZWUuaW5FZGdlcyh2KTsKICAgIGZvciAodmFyIGkgaW4gZWRnZXMpIHsKICAgICAgdmFyIGUgPSBlZGdlc1tpXTsKICAgICAgdmFyIHUgPSB0cmVlLnNvdXJjZShlKTsKICAgICAgdmFyIHZhbHVlID0gdHJlZS5lZGdlKGUpOwogICAgICByZWRpcmVjdCh1KTsKICAgICAgdHJlZS5kZWxFZGdlKGUpOwogICAgICB2YWx1ZS5yZXZlcnNlZCA9ICF2YWx1ZS5yZXZlcnNlZDsKICAgICAgdHJlZS5hZGRFZGdlKGUsIHYsIHUsIHZhbHVlKTsKICAgIH0KICB9CgogIHJlZGlyZWN0KHRhcmdldCk7CgogIHZhciByb290ID0gc291cmNlOwogIHZhciBlZGdlcyA9IHRyZWUuaW5FZGdlcyhyb290KTsKICB3aGlsZSAoZWRnZXMubGVuZ3RoID4gMCkgewogICAgcm9vdCA9IHRyZWUuc291cmNlKGVkZ2VzWzBdKTsKICAgIGVkZ2VzID0gdHJlZS5pbkVkZ2VzKHJvb3QpOwogIH0KCiAgdHJlZS5ncmFwaCgpLnJvb3QgPSByb290OwoKICB0cmVlLmFkZEVkZ2UobnVsbCwgc291cmNlLCB0YXJnZXQsIHtjdXRWYWx1ZTogMH0pOwoKICBpbml0Q3V0VmFsdWVzKGdyYXBoLCB0cmVlKTsKCiAgYWRqdXN0UmFua3MoZ3JhcGgsIHRyZWUpOwp9CgovKgogKiBSZXNldCB0aGUgcmFua3Mgb2YgYWxsIG5vZGVzIGJhc2VkIG9uIHRoZSBjdXJyZW50IHNwYW5uaW5nIHRyZWUuCiAqIFRoZSByYW5rIG9mIHRoZSB0cmVlJ3Mgcm9vdCByZW1haW5zIHVuY2hhbmdlZCwgd2hpbGUgYWxsIG90aGVyCiAqIG5vZGVzIGFyZSBzZXQgdG8gdGhlIHN1bSBvZiBtaW5pbXVtIGxlbmd0aCBjb25zdHJhaW50cyBhbG9uZwogKiB0aGUgcGF0aCBmcm9tIHRoZSByb290LgogKi8KZnVuY3Rpb24gYWRqdXN0UmFua3MoZ3JhcGgsIHRyZWUpIHsKICBmdW5jdGlvbiBkZnMocCkgewogICAgdmFyIGNoaWxkcmVuID0gdHJlZS5zdWNjZXNzb3JzKHApOwogICAgY2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjKSB7CiAgICAgIHZhciBtaW5MZW4gPSBtaW5pbXVtTGVuZ3RoKGdyYXBoLCBwLCBjKTsKICAgICAgZ3JhcGgubm9kZShjKS5yYW5rID0gZ3JhcGgubm9kZShwKS5yYW5rICsgbWluTGVuOwogICAgICBkZnMoYyk7CiAgICB9KTsKICB9CgogIGRmcyh0cmVlLmdyYXBoKCkucm9vdCk7Cn0KCi8qCiAqIElmIHUgYW5kIHYgYXJlIGNvbm5lY3RlZCBieSBzb21lIGVkZ2VzIGluIHRoZSBncmFwaCwgcmV0dXJuIHRoZQogKiBtaW5pbXVtIGxlbmd0aCBvZiB0aG9zZSBlZGdlcywgYXMgYSBwb3NpdGl2ZSBudW1iZXIgaWYgdiBzdWNjZWVkcwogKiB1IGFuZCBhcyBhIG5lZ2F0aXZlIG51bWJlciBpZiB2IHByZWNlZGVzIHUuCiAqLwpmdW5jdGlvbiBtaW5pbXVtTGVuZ3RoKGdyYXBoLCB1LCB2KSB7CiAgdmFyIG91dEVkZ2VzID0gZ3JhcGgub3V0RWRnZXModSwgdik7CiAgaWYgKG91dEVkZ2VzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiB1dGlsLm1heChvdXRFZGdlcy5tYXAoZnVuY3Rpb24oZSkgewogICAgICByZXR1cm4gZ3JhcGguZWRnZShlKS5taW5MZW47CiAgICB9KSk7CiAgfQoKICB2YXIgaW5FZGdlcyA9IGdyYXBoLmluRWRnZXModSwgdik7CiAgaWYgKGluRWRnZXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIC11dGlsLm1heChpbkVkZ2VzLm1hcChmdW5jdGlvbihlKSB7CiAgICAgIHJldHVybiBncmFwaC5lZGdlKGUpLm1pbkxlbjsKICAgIH0pKTsKICB9Cn0KCn0seyIuLi91dGlsIjoxNywiLi9yYW5rVXRpbCI6MTV9XSwxNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qCiAqIFJldHVybnMgdGhlIHNtYWxsZXN0IHZhbHVlIGluIHRoZSBhcnJheS4KICovCmV4cG9ydHMubWluID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIE1hdGgubWluLmFwcGx5KE1hdGgsIHZhbHVlcyk7Cn07CgovKgogKiBSZXR1cm5zIHRoZSBsYXJnZXN0IHZhbHVlIGluIHRoZSBhcnJheS4KICovCmV4cG9ydHMubWF4ID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIE1hdGgubWF4LmFwcGx5KE1hdGgsIHZhbHVlcyk7Cn07CgovKgogKiBSZXR1cm5zIGB0cnVlYCBvbmx5IGlmIGBmKHgpYCBpcyBgdHJ1ZWAgZm9yIGFsbCBgeGAgaW4gYHhzYC4gT3RoZXJ3aXNlCiAqIHJldHVybnMgYGZhbHNlYC4gVGhpcyBmdW5jdGlvbiB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBpdCBmaW5kcyBhCiAqIGNhc2Ugd2hlcmUgYGYoeClgIGRvZXMgbm90IGhvbGQuCiAqLwpleHBvcnRzLmFsbCA9IGZ1bmN0aW9uKHhzLCBmKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB4cy5sZW5ndGg7ICsraSkgewogICAgaWYgKCFmKHhzW2ldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9OwoKLyoKICogQWNjdW11bGF0ZXMgdGhlIHN1bSBvZiBlbGVtZW50cyBpbiB0aGUgZ2l2ZW4gYXJyYXkgdXNpbmcgdGhlIGArYCBvcGVyYXRvci4KICovCmV4cG9ydHMuc3VtID0gZnVuY3Rpb24odmFsdWVzKSB7CiAgcmV0dXJuIHZhbHVlcy5yZWR1Y2UoZnVuY3Rpb24oYWNjLCB4KSB7IHJldHVybiBhY2MgKyB4OyB9LCAwKTsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgYWxsIHZhbHVlcyBpbiB0aGUgZ2l2ZW4gb2JqZWN0LgogKi8KZXhwb3J0cy52YWx1ZXMgPSBmdW5jdGlvbihvYmopIHsKICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5tYXAoZnVuY3Rpb24oaykgeyByZXR1cm4gb2JqW2tdOyB9KTsKfTsKCmV4cG9ydHMuc2h1ZmZsZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgZm9yIChpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+IDA7IC0taSkgewogICAgdmFyIGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaSArIDEpKTsKICAgIHZhciBhaiA9IGFycmF5W2pdOwogICAgYXJyYXlbal0gPSBhcnJheVtpXTsKICAgIGFycmF5W2ldID0gYWo7CiAgfQp9OwoKZXhwb3J0cy5wcm9wZXJ0eUFjY2Vzc29yID0gZnVuY3Rpb24oc2VsZiwgY29uZmlnLCBmaWVsZCwgc2V0SG9vaykgewogIHJldHVybiBmdW5jdGlvbih4KSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBjb25maWdbZmllbGRdOwogICAgY29uZmlnW2ZpZWxkXSA9IHg7CiAgICBpZiAoc2V0SG9vaykgc2V0SG9vayh4KTsKICAgIHJldHVybiBzZWxmOwogIH07Cn07CgovKgogKiBHaXZlbiBhIGxheWVyZWQsIGRpcmVjdGVkIGdyYXBoIHdpdGggYHJhbmtgIGFuZCBgb3JkZXJgIG5vZGUgYXR0cmlidXRlcywKICogdGhpcyBmdW5jdGlvbiByZXR1cm5zIGFuIGFycmF5IG9mIG9yZGVyZWQgcmFua3MuIEVhY2ggcmFuayBjb250YWlucyBhbiBhcnJheQogKiBvZiB0aGUgaWRzIG9mIHRoZSBub2RlcyBpbiB0aGF0IHJhbmsgaW4gdGhlIG9yZGVyIHNwZWNpZmllZCBieSB0aGUgYG9yZGVyYAogKiBhdHRyaWJ1dGUuCiAqLwpleHBvcnRzLm9yZGVyaW5nID0gZnVuY3Rpb24oZykgewogIHZhciBvcmRlcmluZyA9IFtdOwogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIHZhciByYW5rID0gb3JkZXJpbmdbdmFsdWUucmFua10gfHwgKG9yZGVyaW5nW3ZhbHVlLnJhbmtdID0gW10pOwogICAgcmFua1t2YWx1ZS5vcmRlcl0gPSB1OwogIH0pOwogIHJldHVybiBvcmRlcmluZzsKfTsKCi8qCiAqIEEgZmlsdGVyIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCBgZmlsdGVyTm9kZXNgIHRvIGdldCBhIGdyYXBoIHRoYXQgb25seQogKiBpbmNsdWRlcyBub2RlcyB0aGF0IGRvIG5vdCBjb250YWluIG90aGVycyBub2Rlcy4KICovCmV4cG9ydHMuZmlsdGVyTm9uU3ViZ3JhcGhzID0gZnVuY3Rpb24oZykgewogIHJldHVybiBmdW5jdGlvbih1KSB7CiAgICByZXR1cm4gZy5jaGlsZHJlbih1KS5sZW5ndGggPT09IDA7CiAgfTsKfTsKCi8qCiAqIFJldHVybnMgYSBuZXcgZnVuY3Rpb24gdGhhdCB3cmFwcyBgZnVuY2Agd2l0aCBhIHRpbWVyLiBUaGUgd3JhcHBlciBsb2dzIHRoZQogKiB0aW1lIGl0IHRha2VzIHRvIGV4ZWN1dGUgdGhlIGZ1bmN0aW9uLgogKgogKiBUaGUgdGltZXIgd2lsbCBiZSBlbmFibGVkIHByb3ZpZGVkIGBsb2cubGV2ZWwgPj0gMWAuCiAqLwpmdW5jdGlvbiB0aW1lKG5hbWUsIGZ1bmMpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgc3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiBmdW5jLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICB9IGZpbmFsbHkgewogICAgICBsb2coMSwgbmFtZSArICcgdGltZTogJyArIChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHN0YXJ0KSArICdtcycpOwogICAgfQogIH07Cn0KdGltZS5lbmFibGVkID0gZmFsc2U7CgpleHBvcnRzLnRpbWUgPSB0aW1lOwoKLyoKICogQSBnbG9iYWwgbG9nZ2VyIHdpdGggdGhlIHNwZWNpZmljYXRpb24gYGxvZyhsZXZlbCwgbWVzc2FnZSwgLi4uKWAgdGhhdAogKiB3aWxsIGxvZyBhIG1lc3NhZ2UgdG8gdGhlIGNvbnNvbGUgaWYgYGxvZy5sZXZlbCA+PSBsZXZlbGAuCiAqLwpmdW5jdGlvbiBsb2cobGV2ZWwpIHsKICBpZiAobG9nLmxldmVsID49IGxldmVsKSB7CiAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICB9Cn0KbG9nLmxldmVsID0gMDsKCmV4cG9ydHMubG9nID0gbG9nOwoKfSx7fV0sMTg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9ICcwLjQuNSc7Cgp9LHt9XSwxOTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMuU2V0ID0gcmVxdWlyZSgnLi9saWIvU2V0Jyk7CmV4cG9ydHMuUHJpb3JpdHlRdWV1ZSA9IHJlcXVpcmUoJy4vbGliL1ByaW9yaXR5UXVldWUnKTsKZXhwb3J0cy52ZXJzaW9uID0gcmVxdWlyZSgnLi9saWIvdmVyc2lvbicpOwoKfSx7Ii4vbGliL1ByaW9yaXR5UXVldWUiOjIwLCIuL2xpYi9TZXQiOjIxLCIuL2xpYi92ZXJzaW9uIjoyM31dLDIwOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKbW9kdWxlLmV4cG9ydHMgPSBQcmlvcml0eVF1ZXVlOwoKLyoqCiAqIEEgbWluLXByaW9yaXR5IHF1ZXVlIGRhdGEgc3RydWN0dXJlLiBUaGlzIGFsZ29yaXRobSBpcyBkZXJpdmVkIGZyb20gQ29ybWVuLAogKiBldCBhbC4sICJJbnRyb2R1Y3Rpb24gdG8gQWxnb3JpdGhtcyIuIFRoZSBiYXNpYyBpZGVhIG9mIGEgbWluLXByaW9yaXR5CiAqIHF1ZXVlIGlzIHRoYXQgeW91IGNhbiBlZmZpY2llbnRseSAoaW4gTygxKSB0aW1lKSBnZXQgdGhlIHNtYWxsZXN0IGtleSBpbgogKiB0aGUgcXVldWUuIEFkZGluZyBhbmQgcmVtb3ZpbmcgZWxlbWVudHMgdGFrZXMgTyhsb2cgbikgdGltZS4gQSBrZXkgY2FuCiAqIGhhdmUgaXRzIHByaW9yaXR5IGRlY3JlYXNlZCBpbiBPKGxvZyBuKSB0aW1lLgogKi8KZnVuY3Rpb24gUHJpb3JpdHlRdWV1ZSgpIHsKICB0aGlzLl9hcnIgPSBbXTsKICB0aGlzLl9rZXlJbmRpY2VzID0ge307Cn0KCi8qKgogKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIHF1ZXVlLiBUYWtlcyBgTygxKWAgdGltZS4KICovClByaW9yaXR5UXVldWUucHJvdG90eXBlLnNpemUgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5fYXJyLmxlbmd0aDsKfTsKCi8qKgogKiBSZXR1cm5zIHRoZSBrZXlzIHRoYXQgYXJlIGluIHRoZSBxdWV1ZS4gVGFrZXMgYE8obilgIHRpbWUuCiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuX2Fyci5tYXAoZnVuY3Rpb24oeCkgeyByZXR1cm4geC5rZXk7IH0pOwp9OwoKLyoqCiAqIFJldHVybnMgYHRydWVgIGlmICoqa2V5KiogaXMgaW4gdGhlIHF1ZXVlIGFuZCBgZmFsc2VgIGlmIG5vdC4KICovClByaW9yaXR5UXVldWUucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uKGtleSkgewogIHJldHVybiBrZXkgaW4gdGhpcy5fa2V5SW5kaWNlczsKfTsKCi8qKgogKiBSZXR1cm5zIHRoZSBwcmlvcml0eSBmb3IgKiprZXkqKi4gSWYgKiprZXkqKiBpcyBub3QgcHJlc2VudCBpbiB0aGUgcXVldWUKICogdGhlbiB0aGlzIGZ1bmN0aW9uIHJldHVybnMgYHVuZGVmaW5lZGAuIFRha2VzIGBPKDEpYCB0aW1lLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5CiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5wcmlvcml0eSA9IGZ1bmN0aW9uKGtleSkgewogIHZhciBpbmRleCA9IHRoaXMuX2tleUluZGljZXNba2V5XTsKICBpZiAoaW5kZXggIT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuIHRoaXMuX2FycltpbmRleF0ucHJpb3JpdHk7CiAgfQp9OwoKLyoqCiAqIFJldHVybnMgdGhlIGtleSBmb3IgdGhlIG1pbmltdW0gZWxlbWVudCBpbiB0aGlzIHF1ZXVlLiBJZiB0aGUgcXVldWUgaXMKICogZW1wdHkgdGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUubWluID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuc2l6ZSgpID09PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIlF1ZXVlIHVuZGVyZmxvdyIpOwogIH0KICByZXR1cm4gdGhpcy5fYXJyWzBdLmtleTsKfTsKCi8qKgogKiBJbnNlcnRzIGEgbmV3IGtleSBpbnRvIHRoZSBwcmlvcml0eSBxdWV1ZS4gSWYgdGhlIGtleSBhbHJlYWR5IGV4aXN0cyBpbgogKiB0aGUgcXVldWUgdGhpcyBmdW5jdGlvbiByZXR1cm5zIGBmYWxzZWA7IG90aGVyd2lzZSBpdCB3aWxsIHJldHVybiBgdHJ1ZWAuCiAqIFRha2VzIGBPKG4pYCB0aW1lLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5IHRoZSBrZXkgdG8gYWRkCiAqIEBwYXJhbSB7TnVtYmVyfSBwcmlvcml0eSB0aGUgaW5pdGlhbCBwcmlvcml0eSBmb3IgdGhlIGtleQogKi8KUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24oa2V5LCBwcmlvcml0eSkgewogIHZhciBrZXlJbmRpY2VzID0gdGhpcy5fa2V5SW5kaWNlczsKICBpZiAoIShrZXkgaW4ga2V5SW5kaWNlcykpIHsKICAgIHZhciBhcnIgPSB0aGlzLl9hcnI7CiAgICB2YXIgaW5kZXggPSBhcnIubGVuZ3RoOwogICAga2V5SW5kaWNlc1trZXldID0gaW5kZXg7CiAgICBhcnIucHVzaCh7a2V5OiBrZXksIHByaW9yaXR5OiBwcmlvcml0eX0pOwogICAgdGhpcy5fZGVjcmVhc2UoaW5kZXgpOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCi8qKgogKiBSZW1vdmVzIGFuZCByZXR1cm5zIHRoZSBzbWFsbGVzdCBrZXkgaW4gdGhlIHF1ZXVlLiBUYWtlcyBgTyhsb2cgbilgIHRpbWUuCiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5yZW1vdmVNaW4gPSBmdW5jdGlvbigpIHsKICB0aGlzLl9zd2FwKDAsIHRoaXMuX2Fyci5sZW5ndGggLSAxKTsKICB2YXIgbWluID0gdGhpcy5fYXJyLnBvcCgpOwogIGRlbGV0ZSB0aGlzLl9rZXlJbmRpY2VzW21pbi5rZXldOwogIHRoaXMuX2hlYXBpZnkoMCk7CiAgcmV0dXJuIG1pbi5rZXk7Cn07CgovKioKICogRGVjcmVhc2VzIHRoZSBwcmlvcml0eSBmb3IgKiprZXkqKiB0byAqKnByaW9yaXR5KiouIElmIHRoZSBuZXcgcHJpb3JpdHkgaXMKICogZ3JlYXRlciB0aGFuIHRoZSBwcmV2aW91cyBwcmlvcml0eSwgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge09iamVjdH0ga2V5IHRoZSBrZXkgZm9yIHdoaWNoIHRvIHJhaXNlIHByaW9yaXR5CiAqIEBwYXJhbSB7TnVtYmVyfSBwcmlvcml0eSB0aGUgbmV3IHByaW9yaXR5IGZvciB0aGUga2V5CiAqLwpQcmlvcml0eVF1ZXVlLnByb3RvdHlwZS5kZWNyZWFzZSA9IGZ1bmN0aW9uKGtleSwgcHJpb3JpdHkpIHsKICB2YXIgaW5kZXggPSB0aGlzLl9rZXlJbmRpY2VzW2tleV07CiAgaWYgKHByaW9yaXR5ID4gdGhpcy5fYXJyW2luZGV4XS5wcmlvcml0eSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJOZXcgcHJpb3JpdHkgaXMgZ3JlYXRlciB0aGFuIGN1cnJlbnQgcHJpb3JpdHkuICIgKwogICAgICAgICJLZXk6ICIgKyBrZXkgKyAiIE9sZDogIiArIHRoaXMuX2FycltpbmRleF0ucHJpb3JpdHkgKyAiIE5ldzogIiArIHByaW9yaXR5KTsKICB9CiAgdGhpcy5fYXJyW2luZGV4XS5wcmlvcml0eSA9IHByaW9yaXR5OwogIHRoaXMuX2RlY3JlYXNlKGluZGV4KTsKfTsKClByaW9yaXR5UXVldWUucHJvdG90eXBlLl9oZWFwaWZ5ID0gZnVuY3Rpb24oaSkgewogIHZhciBhcnIgPSB0aGlzLl9hcnI7CiAgdmFyIGwgPSAyICogaSwKICAgICAgciA9IGwgKyAxLAogICAgICBsYXJnZXN0ID0gaTsKICBpZiAobCA8IGFyci5sZW5ndGgpIHsKICAgIGxhcmdlc3QgPSBhcnJbbF0ucHJpb3JpdHkgPCBhcnJbbGFyZ2VzdF0ucHJpb3JpdHkgPyBsIDogbGFyZ2VzdDsKICAgIGlmIChyIDwgYXJyLmxlbmd0aCkgewogICAgICBsYXJnZXN0ID0gYXJyW3JdLnByaW9yaXR5IDwgYXJyW2xhcmdlc3RdLnByaW9yaXR5ID8gciA6IGxhcmdlc3Q7CiAgICB9CiAgICBpZiAobGFyZ2VzdCAhPT0gaSkgewogICAgICB0aGlzLl9zd2FwKGksIGxhcmdlc3QpOwogICAgICB0aGlzLl9oZWFwaWZ5KGxhcmdlc3QpOwogICAgfQogIH0KfTsKClByaW9yaXR5UXVldWUucHJvdG90eXBlLl9kZWNyZWFzZSA9IGZ1bmN0aW9uKGluZGV4KSB7CiAgdmFyIGFyciA9IHRoaXMuX2FycjsKICB2YXIgcHJpb3JpdHkgPSBhcnJbaW5kZXhdLnByaW9yaXR5OwogIHZhciBwYXJlbnQ7CiAgd2hpbGUgKGluZGV4ICE9PSAwKSB7CiAgICBwYXJlbnQgPSBpbmRleCA+PiAxOwogICAgaWYgKGFycltwYXJlbnRdLnByaW9yaXR5IDwgcHJpb3JpdHkpIHsKICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl9zd2FwKGluZGV4LCBwYXJlbnQpOwogICAgaW5kZXggPSBwYXJlbnQ7CiAgfQp9OwoKUHJpb3JpdHlRdWV1ZS5wcm90b3R5cGUuX3N3YXAgPSBmdW5jdGlvbihpLCBqKSB7CiAgdmFyIGFyciA9IHRoaXMuX2FycjsKICB2YXIga2V5SW5kaWNlcyA9IHRoaXMuX2tleUluZGljZXM7CiAgdmFyIG9yaWdBcnJJID0gYXJyW2ldOwogIHZhciBvcmlnQXJySiA9IGFycltqXTsKICBhcnJbaV0gPSBvcmlnQXJySjsKICBhcnJbal0gPSBvcmlnQXJySTsKICBrZXlJbmRpY2VzW29yaWdBcnJKLmtleV0gPSBpOwogIGtleUluZGljZXNbb3JpZ0Fyckkua2V5XSA9IGo7Cn07Cgp9LHt9XSwyMTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB1dGlsID0gcmVxdWlyZSgnLi91dGlsJyk7Cgptb2R1bGUuZXhwb3J0cyA9IFNldDsKCi8qKgogKiBDb25zdHJ1Y3RzIGEgbmV3IFNldCB3aXRoIGFuIG9wdGlvbmFsIHNldCBvZiBgaW5pdGlhbEtleXNgLgogKgogKiBJdCBpcyBpbXBvcnRhbnQgdG8gbm90ZSB0aGF0IGtleXMgYXJlIGNvZXJjZWQgdG8gU3RyaW5nIGZvciBtb3N0IHB1cnBvc2VzCiAqIHdpdGggdGhpcyBvYmplY3QsIHNpbWlsYXIgdG8gdGhlIGJlaGF2aW9yIG9mIEphdmFTY3JpcHQncyBPYmplY3QuIEZvcgogKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIHdpbGwgYWRkIG9ubHkgb25lIGtleToKICoKICogICAgIHZhciBzID0gbmV3IFNldCgpOwogKiAgICAgcy5hZGQoMSk7CiAqICAgICBzLmFkZCgiMSIpOwogKgogKiBIb3dldmVyLCB0aGUgdHlwZSBvZiB0aGUga2V5IGlzIHByZXNlcnZlZCBpbnRlcm5hbGx5IHNvIHRoYXQgYGtleXNgIHJldHVybnMKICogdGhlIG9yaWdpbmFsIGtleSBzZXQgdW5jb2VyY2VkLiBGb3IgdGhlIGFib3ZlIGV4YW1wbGUsIGBrZXlzYCB3b3VsZCByZXR1cm4KICogYFsxXWAuCiAqLwpmdW5jdGlvbiBTZXQoaW5pdGlhbEtleXMpIHsKICB0aGlzLl9zaXplID0gMDsKICB0aGlzLl9rZXlzID0ge307CgogIGlmIChpbml0aWFsS2V5cykgewogICAgZm9yICh2YXIgaSA9IDAsIGlsID0gaW5pdGlhbEtleXMubGVuZ3RoOyBpIDwgaWw7ICsraSkgewogICAgICB0aGlzLmFkZChpbml0aWFsS2V5c1tpXSk7CiAgICB9CiAgfQp9CgovKioKICogUmV0dXJucyBhIG5ldyBTZXQgdGhhdCByZXByZXNlbnRzIHRoZSBzZXQgaW50ZXJzZWN0aW9uIG9mIHRoZSBhcnJheSBvZiBnaXZlbgogKiBzZXRzLgogKi8KU2V0LmludGVyc2VjdCA9IGZ1bmN0aW9uKHNldHMpIHsKICBpZiAoc2V0cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBuZXcgU2V0KCk7CiAgfQoKICB2YXIgcmVzdWx0ID0gbmV3IFNldCghdXRpbC5pc0FycmF5KHNldHNbMF0pID8gc2V0c1swXS5rZXlzKCkgOiBzZXRzWzBdKTsKICBmb3IgKHZhciBpID0gMSwgaWwgPSBzZXRzLmxlbmd0aDsgaSA8IGlsOyArK2kpIHsKICAgIHZhciByZXN1bHRLZXlzID0gcmVzdWx0LmtleXMoKSwKICAgICAgICBvdGhlciA9ICF1dGlsLmlzQXJyYXkoc2V0c1tpXSkgPyBzZXRzW2ldIDogbmV3IFNldChzZXRzW2ldKTsKICAgIGZvciAodmFyIGogPSAwLCBqbCA9IHJlc3VsdEtleXMubGVuZ3RoOyBqIDwgamw7ICsraikgewogICAgICB2YXIga2V5ID0gcmVzdWx0S2V5c1tqXTsKICAgICAgaWYgKCFvdGhlci5oYXMoa2V5KSkgewogICAgICAgIHJlc3VsdC5yZW1vdmUoa2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBSZXR1cm5zIGEgbmV3IFNldCB0aGF0IHJlcHJlc2VudHMgdGhlIHNldCB1bmlvbiBvZiB0aGUgYXJyYXkgb2YgZ2l2ZW4gc2V0cy4KICovClNldC51bmlvbiA9IGZ1bmN0aW9uKHNldHMpIHsKICB2YXIgdG90YWxFbGVtcyA9IHV0aWwucmVkdWNlKHNldHMsIGZ1bmN0aW9uKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzICsgKHJocy5zaXplID8gcmhzLnNpemUoKSA6IHJocy5sZW5ndGgpOwogIH0sIDApOwogIHZhciBhcnIgPSBuZXcgQXJyYXkodG90YWxFbGVtcyk7CgogIHZhciBrID0gMDsKICBmb3IgKHZhciBpID0gMCwgaWwgPSBzZXRzLmxlbmd0aDsgaSA8IGlsOyArK2kpIHsKICAgIHZhciBjdXIgPSBzZXRzW2ldLAogICAgICAgIGtleXMgPSAhdXRpbC5pc0FycmF5KGN1cikgPyBjdXIua2V5cygpIDogY3VyOwogICAgZm9yICh2YXIgaiA9IDAsIGpsID0ga2V5cy5sZW5ndGg7IGogPCBqbDsgKytqKSB7CiAgICAgIGFycltrKytdID0ga2V5c1tqXTsKICAgIH0KICB9CgogIHJldHVybiBuZXcgU2V0KGFycik7Cn07CgovKioKICogUmV0dXJucyB0aGUgc2l6ZSBvZiB0aGlzIHNldCBpbiBgTygxKWAgdGltZS4KICovClNldC5wcm90b3R5cGUuc2l6ZSA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0aGlzLl9zaXplOwp9OwoKLyoqCiAqIFJldHVybnMgdGhlIGtleXMgaW4gdGhpcyBzZXQuIFRha2VzIGBPKG4pYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5rZXlzID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHZhbHVlcyh0aGlzLl9rZXlzKTsKfTsKCi8qKgogKiBUZXN0cyBpZiBhIGtleSBpcyBwcmVzZW50IGluIHRoaXMgU2V0LiBSZXR1cm5zIGB0cnVlYCBpZiBpdCBpcyBhbmQgYGZhbHNlYAogKiBpZiBub3QuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5oYXMgPSBmdW5jdGlvbihrZXkpIHsKICByZXR1cm4ga2V5IGluIHRoaXMuX2tleXM7Cn07CgovKioKICogQWRkcyBhIG5ldyBrZXkgdG8gdGhpcyBTZXQgaWYgaXQgaXMgbm90IGFscmVhZHkgcHJlc2VudC4gUmV0dXJucyBgdHJ1ZWAgaWYKICogdGhlIGtleSB3YXMgYWRkZWQgYW5kIGBmYWxzZWAgaWYgaXQgd2FzIGFscmVhZHkgcHJlc2VudC4gVGFrZXMgYE8oMSlgIHRpbWUuCiAqLwpTZXQucHJvdG90eXBlLmFkZCA9IGZ1bmN0aW9uKGtleSkgewogIGlmICghKGtleSBpbiB0aGlzLl9rZXlzKSkgewogICAgdGhpcy5fa2V5c1trZXldID0ga2V5OwogICAgKyt0aGlzLl9zaXplOwogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBmYWxzZTsKfTsKCi8qKgogKiBSZW1vdmVzIGEga2V5IGZyb20gdGhpcyBTZXQuIElmIHRoZSBrZXkgd2FzIHJlbW92ZWQgdGhpcyBmdW5jdGlvbiByZXR1cm5zCiAqIGB0cnVlYC4gSWYgbm90LCBpdCByZXR1cm5zIGBmYWxzZWAuIFRha2VzIGBPKDEpYCB0aW1lLgogKi8KU2V0LnByb3RvdHlwZS5yZW1vdmUgPSBmdW5jdGlvbihrZXkpIHsKICBpZiAoa2V5IGluIHRoaXMuX2tleXMpIHsKICAgIGRlbGV0ZSB0aGlzLl9rZXlzW2tleV07CiAgICAtLXRoaXMuX3NpemU7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBhbGwgdmFsdWVzIGZvciBwcm9wZXJ0aWVzIG9mICoqbyoqLgogKi8KZnVuY3Rpb24gdmFsdWVzKG8pIHsKICB2YXIga3MgPSBPYmplY3Qua2V5cyhvKSwKICAgICAgbGVuID0ga3MubGVuZ3RoLAogICAgICByZXN1bHQgPSBuZXcgQXJyYXkobGVuKSwKICAgICAgaTsKICBmb3IgKGkgPSAwOyBpIDwgbGVuOyArK2kpIHsKICAgIHJlc3VsdFtpXSA9IG9ba3NbaV1dOwogIH0KICByZXR1cm4gcmVzdWx0Owp9Cgp9LHsiLi91dGlsIjoyMn1dLDIyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogVGhpcyBwb2x5ZmlsbCBjb21lcyBmcm9tCiAqIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L2lzQXJyYXkKICovCmlmKCFBcnJheS5pc0FycmF5KSB7CiAgZXhwb3J0cy5pc0FycmF5ID0gZnVuY3Rpb24gKHZBcmcpIHsKICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodkFyZykgPT09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKfSBlbHNlIHsKICBleHBvcnRzLmlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp9CgovKgogKiBTbGlnaHRseSBhZGFwdGVkIHBvbHlmaWxsIGZyb20KICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvQXJyYXkvUmVkdWNlCiAqLwppZiAoJ2Z1bmN0aW9uJyAhPT0gdHlwZW9mIEFycmF5LnByb3RvdHlwZS5yZWR1Y2UpIHsKICBleHBvcnRzLnJlZHVjZSA9IGZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgaWYgKG51bGwgPT09IGFycmF5IHx8ICd1bmRlZmluZWQnID09PSB0eXBlb2YgYXJyYXkpIHsKICAgICAgLy8gQXQgdGhlIG1vbWVudCBhbGwgbW9kZXJuIGJyb3dzZXJzLCB0aGF0IHN1cHBvcnQgc3RyaWN0IG1vZGUsIGhhdmUKICAgICAgLy8gbmF0aXZlIGltcGxlbWVudGF0aW9uIG9mIEFycmF5LnByb3RvdHlwZS5yZWR1Y2UuIEZvciBpbnN0YW5jZSwgSUU4CiAgICAgIC8vIGRvZXMgbm90IHN1cHBvcnQgc3RyaWN0IG1vZGUsIHNvIHRoaXMgY2hlY2sgaXMgYWN0dWFsbHkgdXNlbGVzcy4KICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigKICAgICAgICAgICdBcnJheS5wcm90b3R5cGUucmVkdWNlIGNhbGxlZCBvbiBudWxsIG9yIHVuZGVmaW5lZCcpOwogICAgfQogICAgaWYgKCdmdW5jdGlvbicgIT09IHR5cGVvZiBjYWxsYmFjaykgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGNhbGxiYWNrICsgJyBpcyBub3QgYSBmdW5jdGlvbicpOwogICAgfQogICAgdmFyIGluZGV4LCB2YWx1ZSwKICAgICAgICBsZW5ndGggPSBhcnJheS5sZW5ndGggPj4+IDAsCiAgICAgICAgaXNWYWx1ZVNldCA9IGZhbHNlOwogICAgaWYgKDEgPCBhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgIHZhbHVlID0gb3B0X2luaXRpYWxWYWx1ZTsKICAgICAgaXNWYWx1ZVNldCA9IHRydWU7CiAgICB9CiAgICBmb3IgKGluZGV4ID0gMDsgbGVuZ3RoID4gaW5kZXg7ICsraW5kZXgpIHsKICAgICAgaWYgKGFycmF5Lmhhc093blByb3BlcnR5KGluZGV4KSkgewogICAgICAgIGlmIChpc1ZhbHVlU2V0KSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKHZhbHVlLCBhcnJheVtpbmRleF0sIGluZGV4LCBhcnJheSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgdmFsdWUgPSBhcnJheVtpbmRleF07CiAgICAgICAgICBpc1ZhbHVlU2V0ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICghaXNWYWx1ZVNldCkgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKfSBlbHNlIHsKICBleHBvcnRzLnJlZHVjZSA9IGZ1bmN0aW9uKGFycmF5LCBjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSkgewogICAgcmV0dXJuIGFycmF5LnJlZHVjZShjYWxsYmFjaywgb3B0X2luaXRpYWxWYWx1ZSk7CiAgfTsKfQoKfSx7fV0sMjM6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9ICcxLjEuMyc7Cgp9LHt9XSwyNDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CmV4cG9ydHMuR3JhcGggPSByZXF1aXJlKCIuL2xpYi9HcmFwaCIpOwpleHBvcnRzLkRpZ3JhcGggPSByZXF1aXJlKCIuL2xpYi9EaWdyYXBoIik7CmV4cG9ydHMuQ0dyYXBoID0gcmVxdWlyZSgiLi9saWIvQ0dyYXBoIik7CmV4cG9ydHMuQ0RpZ3JhcGggPSByZXF1aXJlKCIuL2xpYi9DRGlncmFwaCIpOwpyZXF1aXJlKCIuL2xpYi9ncmFwaC1jb252ZXJ0ZXJzIik7CgpleHBvcnRzLmFsZyA9IHsKICBpc0FjeWNsaWM6IHJlcXVpcmUoIi4vbGliL2FsZy9pc0FjeWNsaWMiKSwKICBjb21wb25lbnRzOiByZXF1aXJlKCIuL2xpYi9hbGcvY29tcG9uZW50cyIpLAogIGRpamtzdHJhOiByZXF1aXJlKCIuL2xpYi9hbGcvZGlqa3N0cmEiKSwKICBkaWprc3RyYUFsbDogcmVxdWlyZSgiLi9saWIvYWxnL2RpamtzdHJhQWxsIiksCiAgZmluZEN5Y2xlczogcmVxdWlyZSgiLi9saWIvYWxnL2ZpbmRDeWNsZXMiKSwKICBmbG95ZFdhcnNoYWxsOiByZXF1aXJlKCIuL2xpYi9hbGcvZmxveWRXYXJzaGFsbCIpLAogIHBvc3RvcmRlcjogcmVxdWlyZSgiLi9saWIvYWxnL3Bvc3RvcmRlciIpLAogIHByZW9yZGVyOiByZXF1aXJlKCIuL2xpYi9hbGcvcHJlb3JkZXIiKSwKICBwcmltOiByZXF1aXJlKCIuL2xpYi9hbGcvcHJpbSIpLAogIHRhcmphbjogcmVxdWlyZSgiLi9saWIvYWxnL3RhcmphbiIpLAogIHRvcHNvcnQ6IHJlcXVpcmUoIi4vbGliL2FsZy90b3Bzb3J0IikKfTsKCmV4cG9ydHMuY29udmVydGVyID0gewogIGpzb246IHJlcXVpcmUoIi4vbGliL2NvbnZlcnRlci9qc29uLmpzIikKfTsKCnZhciBmaWx0ZXIgPSByZXF1aXJlKCIuL2xpYi9maWx0ZXIiKTsKZXhwb3J0cy5maWx0ZXIgPSB7CiAgYWxsOiBmaWx0ZXIuYWxsLAogIG5vZGVzRnJvbUxpc3Q6IGZpbHRlci5ub2Rlc0Zyb21MaXN0Cn07CgpleHBvcnRzLnZlcnNpb24gPSByZXF1aXJlKCIuL2xpYi92ZXJzaW9uIik7Cgp9LHsiLi9saWIvQ0RpZ3JhcGgiOjI2LCIuL2xpYi9DR3JhcGgiOjI3LCIuL2xpYi9EaWdyYXBoIjoyOCwiLi9saWIvR3JhcGgiOjI5LCIuL2xpYi9hbGcvY29tcG9uZW50cyI6MzAsIi4vbGliL2FsZy9kaWprc3RyYSI6MzEsIi4vbGliL2FsZy9kaWprc3RyYUFsbCI6MzIsIi4vbGliL2FsZy9maW5kQ3ljbGVzIjozMywiLi9saWIvYWxnL2Zsb3lkV2Fyc2hhbGwiOjM0LCIuL2xpYi9hbGcvaXNBY3ljbGljIjozNSwiLi9saWIvYWxnL3Bvc3RvcmRlciI6MzYsIi4vbGliL2FsZy9wcmVvcmRlciI6MzcsIi4vbGliL2FsZy9wcmltIjozOCwiLi9saWIvYWxnL3RhcmphbiI6MzksIi4vbGliL2FsZy90b3Bzb3J0Ijo0MCwiLi9saWIvY29udmVydGVyL2pzb24uanMiOjQyLCIuL2xpYi9maWx0ZXIiOjQzLCIuL2xpYi9ncmFwaC1jb252ZXJ0ZXJzIjo0NCwiLi9saWIvdmVyc2lvbiI6NDZ9XSwyNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IEJhc2VHcmFwaDsKCmZ1bmN0aW9uIEJhc2VHcmFwaCgpIHsKICAvLyBUaGUgdmFsdWUgYXNzaWduZWQgdG8gdGhlIGdyYXBoIGl0c2VsZi4KICB0aGlzLl92YWx1ZSA9IHVuZGVmaW5lZDsKCiAgLy8gTWFwIG9mIG5vZGUgaWQgLT4geyBpZCwgdmFsdWUgfQogIHRoaXMuX25vZGVzID0ge307CgogIC8vIE1hcCBvZiBlZGdlIGlkIC0+IHsgaWQsIHUsIHYsIHZhbHVlIH0KICB0aGlzLl9lZGdlcyA9IHt9OwoKICAvLyBVc2VkIHRvIGdlbmVyYXRlIGEgdW5pcXVlIGlkIGluIHRoZSBncmFwaAogIHRoaXMuX25leHRJZCA9IDA7Cn0KCi8vIE51bWJlciBvZiBub2RlcwpCYXNlR3JhcGgucHJvdG90eXBlLm9yZGVyID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX25vZGVzKS5sZW5ndGg7Cn07CgovLyBOdW1iZXIgb2YgZWRnZXMKQmFzZUdyYXBoLnByb3RvdHlwZS5zaXplID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2VkZ2VzKS5sZW5ndGg7Cn07CgovLyBBY2Nlc3NvciBmb3IgZ3JhcGggbGV2ZWwgdmFsdWUKQmFzZUdyYXBoLnByb3RvdHlwZS5ncmFwaCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB0aGlzLl92YWx1ZTsKICB9CiAgdGhpcy5fdmFsdWUgPSB2YWx1ZTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuaGFzTm9kZSA9IGZ1bmN0aW9uKHUpIHsKICByZXR1cm4gdSBpbiB0aGlzLl9ub2RlczsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUubm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgdmFyIG5vZGUgPSB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gbm9kZS52YWx1ZTsKICB9CiAgbm9kZS52YWx1ZSA9IHZhbHVlOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5ub2RlcyA9IGZ1bmN0aW9uKCkgewogIHZhciBub2RlcyA9IFtdOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24oaWQpIHsgbm9kZXMucHVzaChpZCk7IH0pOwogIHJldHVybiBub2RlczsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuZWFjaE5vZGUgPSBmdW5jdGlvbihmdW5jKSB7CiAgZm9yICh2YXIgayBpbiB0aGlzLl9ub2RlcykgewogICAgdmFyIG5vZGUgPSB0aGlzLl9ub2Rlc1trXTsKICAgIGZ1bmMobm9kZS5pZCwgbm9kZS52YWx1ZSk7CiAgfQp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5oYXNFZGdlID0gZnVuY3Rpb24oZSkgewogIHJldHVybiBlIGluIHRoaXMuX2VkZ2VzOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5lZGdlID0gZnVuY3Rpb24oZSwgdmFsdWUpIHsKICB2YXIgZWRnZSA9IHRoaXMuX3N0cmljdEdldEVkZ2UoZSk7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIHJldHVybiBlZGdlLnZhbHVlOwogIH0KICBlZGdlLnZhbHVlID0gdmFsdWU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLmVkZ2VzID0gZnVuY3Rpb24oKSB7CiAgdmFyIGVzID0gW107CiAgdGhpcy5lYWNoRWRnZShmdW5jdGlvbihpZCkgeyBlcy5wdXNoKGlkKTsgfSk7CiAgcmV0dXJuIGVzOwp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5lYWNoRWRnZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICBmb3IgKHZhciBrIGluIHRoaXMuX2VkZ2VzKSB7CiAgICB2YXIgZWRnZSA9IHRoaXMuX2VkZ2VzW2tdOwogICAgZnVuYyhlZGdlLmlkLCBlZGdlLnUsIGVkZ2UudiwgZWRnZS52YWx1ZSk7CiAgfQp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5pbmNpZGVudE5vZGVzID0gZnVuY3Rpb24oZSkgewogIHZhciBlZGdlID0gdGhpcy5fc3RyaWN0R2V0RWRnZShlKTsKICByZXR1cm4gW2VkZ2UudSwgZWRnZS52XTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuYWRkTm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgaWYgKHUgPT09IHVuZGVmaW5lZCB8fCB1ID09PSBudWxsKSB7CiAgICBkbyB7CiAgICAgIHUgPSAiXyIgKyAoKyt0aGlzLl9uZXh0SWQpOwogICAgfSB3aGlsZSAodGhpcy5oYXNOb2RlKHUpKTsKICB9IGVsc2UgaWYgKHRoaXMuaGFzTm9kZSh1KSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJHcmFwaCBhbHJlYWR5IGhhcyBub2RlICciICsgdSArICInIik7CiAgfQogIHRoaXMuX25vZGVzW3VdID0geyBpZDogdSwgdmFsdWU6IHZhbHVlIH07CiAgcmV0dXJuIHU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLmRlbE5vZGUgPSBmdW5jdGlvbih1KSB7CiAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKICB0aGlzLmluY2lkZW50RWRnZXModSkuZm9yRWFjaChmdW5jdGlvbihlKSB7IHRoaXMuZGVsRWRnZShlKTsgfSwgdGhpcyk7CiAgZGVsZXRlIHRoaXMuX25vZGVzW3VdOwp9OwoKLy8gaW5NYXAgYW5kIG91dE1hcCBhcmUgb3Bwb3NpdGUgc2lkZXMgb2YgYW4gaW5jaWRlbmNlIG1hcC4gRm9yIGV4YW1wbGUsIGZvcgovLyBHcmFwaCB0aGVzZSB3b3VsZCBib3RoIGNvbWUgZnJvbSB0aGUgX2luY2lkZW50RWRnZXMgbWFwLCB3aGlsZSBmb3IgRGlncmFwaAovLyB0aGV5IHdvdWxkIGNvbWUgZnJvbSBfaW5FZGdlcyBhbmQgX291dEVkZ2VzLgpCYXNlR3JhcGgucHJvdG90eXBlLl9hZGRFZGdlID0gZnVuY3Rpb24oZSwgdSwgdiwgdmFsdWUsIGluTWFwLCBvdXRNYXApIHsKICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIHRoaXMuX3N0cmljdEdldE5vZGUodik7CgogIGlmIChlID09PSB1bmRlZmluZWQgfHwgZSA9PT0gbnVsbCkgewogICAgZG8gewogICAgICBlID0gIl8iICsgKCsrdGhpcy5fbmV4dElkKTsKICAgIH0gd2hpbGUgKHRoaXMuaGFzRWRnZShlKSk7CiAgfQogIGVsc2UgaWYgKHRoaXMuaGFzRWRnZShlKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJHcmFwaCBhbHJlYWR5IGhhcyBlZGdlICciICsgZSArICInIik7CiAgfQoKICB0aGlzLl9lZGdlc1tlXSA9IHsgaWQ6IGUsIHU6IHUsIHY6IHYsIHZhbHVlOiB2YWx1ZSB9OwogIGFkZEVkZ2VUb01hcChpbk1hcFt2XSwgdSwgZSk7CiAgYWRkRWRnZVRvTWFwKG91dE1hcFt1XSwgdiwgZSk7CgogIHJldHVybiBlOwp9OwoKLy8gU2VlIG5vdGUgZm9yIF9hZGRFZGdlIHJlZ2FyZGluZyBpbk1hcCBhbmQgb3V0TWFwLgpCYXNlR3JhcGgucHJvdG90eXBlLl9kZWxFZGdlID0gZnVuY3Rpb24oZSwgaW5NYXAsIG91dE1hcCkgewogIHZhciBlZGdlID0gdGhpcy5fc3RyaWN0R2V0RWRnZShlKTsKICBkZWxFZGdlRnJvbU1hcChpbk1hcFtlZGdlLnZdLCBlZGdlLnUsIGUpOwogIGRlbEVkZ2VGcm9tTWFwKG91dE1hcFtlZGdlLnVdLCBlZGdlLnYsIGUpOwogIGRlbGV0ZSB0aGlzLl9lZGdlc1tlXTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKCkgewogIHZhciBjb3B5ID0gbmV3IHRoaXMuY29uc3RydWN0b3IoKTsKICBjb3B5LmdyYXBoKHRoaXMuZ3JhcGgoKSk7CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgeyBjb3B5LmFkZE5vZGUodSwgdmFsdWUpOyB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7IGNvcHkuYWRkRWRnZShlLCB1LCB2LCB2YWx1ZSk7IH0pOwogIGNvcHkuX25leHRJZCA9IHRoaXMuX25leHRJZDsKICByZXR1cm4gY29weTsKfTsKCkJhc2VHcmFwaC5wcm90b3R5cGUuZmlsdGVyTm9kZXMgPSBmdW5jdGlvbihmaWx0ZXIpIHsKICB2YXIgY29weSA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKCk7CiAgY29weS5ncmFwaCh0aGlzLmdyYXBoKCkpOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIGlmIChmaWx0ZXIodSkpIHsKICAgICAgY29weS5hZGROb2RlKHUsIHZhbHVlKTsKICAgIH0KICB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBpZiAoY29weS5oYXNOb2RlKHUpICYmIGNvcHkuaGFzTm9kZSh2KSkgewogICAgICBjb3B5LmFkZEVkZ2UoZSwgdSwgdiwgdmFsdWUpOwogICAgfQogIH0pOwogIHJldHVybiBjb3B5Owp9OwoKQmFzZUdyYXBoLnByb3RvdHlwZS5fc3RyaWN0R2V0Tm9kZSA9IGZ1bmN0aW9uKHUpIHsKICB2YXIgbm9kZSA9IHRoaXMuX25vZGVzW3VdOwogIGlmIChub2RlID09PSB1bmRlZmluZWQpIHsKICAgIHRocm93IG5ldyBFcnJvcigiTm9kZSAnIiArIHUgKyAiJyBpcyBub3QgaW4gZ3JhcGgiKTsKICB9CiAgcmV0dXJuIG5vZGU7Cn07CgpCYXNlR3JhcGgucHJvdG90eXBlLl9zdHJpY3RHZXRFZGdlID0gZnVuY3Rpb24oZSkgewogIHZhciBlZGdlID0gdGhpcy5fZWRnZXNbZV07CiAgaWYgKGVkZ2UgPT09IHVuZGVmaW5lZCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJFZGdlICciICsgZSArICInIGlzIG5vdCBpbiBncmFwaCIpOwogIH0KICByZXR1cm4gZWRnZTsKfTsKCmZ1bmN0aW9uIGFkZEVkZ2VUb01hcChtYXAsIHYsIGUpIHsKICAobWFwW3ZdIHx8IChtYXBbdl0gPSBuZXcgU2V0KCkpKS5hZGQoZSk7Cn0KCmZ1bmN0aW9uIGRlbEVkZ2VGcm9tTWFwKG1hcCwgdiwgZSkgewogIHZhciB2RW50cnkgPSBtYXBbdl07CiAgdkVudHJ5LnJlbW92ZShlKTsKICBpZiAodkVudHJ5LnNpemUoKSA9PT0gMCkgewogICAgZGVsZXRlIG1hcFt2XTsKICB9Cn0KCgp9LHsiY3AtZGF0YSI6MTl9XSwyNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBEaWdyYXBoID0gcmVxdWlyZSgiLi9EaWdyYXBoIiksCiAgICBjb21wb3VuZGlmeSA9IHJlcXVpcmUoIi4vY29tcG91bmRpZnkiKTsKCnZhciBDRGlncmFwaCA9IGNvbXBvdW5kaWZ5KERpZ3JhcGgpOwoKbW9kdWxlLmV4cG9ydHMgPSBDRGlncmFwaDsKCkNEaWdyYXBoLmZyb21EaWdyYXBoID0gZnVuY3Rpb24oc3JjKSB7CiAgdmFyIGcgPSBuZXcgQ0RpZ3JhcGgoKSwKICAgICAgZ3JhcGhWYWx1ZSA9IHNyYy5ncmFwaCgpOwoKICBpZiAoZ3JhcGhWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBnLmdyYXBoKGdyYXBoVmFsdWUpOwogIH0KCiAgc3JjLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICBnLmFkZE5vZGUodSk7CiAgICB9IGVsc2UgewogICAgICBnLmFkZE5vZGUodSwgdmFsdWUpOwogICAgfQogIH0pOwogIHNyYy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYpOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIH0KICB9KTsKICByZXR1cm4gZzsKfTsKCkNEaWdyYXBoLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAiQ0RpZ3JhcGggIiArIEpTT04uc3RyaW5naWZ5KHRoaXMsIG51bGwsIDIpOwp9OwoKfSx7Ii4vRGlncmFwaCI6MjgsIi4vY29tcG91bmRpZnkiOjQxfV0sMjc6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewp2YXIgR3JhcGggPSByZXF1aXJlKCIuL0dyYXBoIiksCiAgICBjb21wb3VuZGlmeSA9IHJlcXVpcmUoIi4vY29tcG91bmRpZnkiKTsKCnZhciBDR3JhcGggPSBjb21wb3VuZGlmeShHcmFwaCk7Cgptb2R1bGUuZXhwb3J0cyA9IENHcmFwaDsKCkNHcmFwaC5mcm9tR3JhcGggPSBmdW5jdGlvbihzcmMpIHsKICB2YXIgZyA9IG5ldyBDR3JhcGgoKSwKICAgICAgZ3JhcGhWYWx1ZSA9IHNyYy5ncmFwaCgpOwoKICBpZiAoZ3JhcGhWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICBnLmdyYXBoKGdyYXBoVmFsdWUpOwogIH0KCiAgc3JjLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICBnLmFkZE5vZGUodSk7CiAgICB9IGVsc2UgewogICAgICBnLmFkZE5vZGUodSwgdmFsdWUpOwogICAgfQogIH0pOwogIHNyYy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYpOwogICAgfSBlbHNlIHsKICAgICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIH0KICB9KTsKICByZXR1cm4gZzsKfTsKCkNHcmFwaC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gIkNHcmFwaCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgMik7Cn07Cgp9LHsiLi9HcmFwaCI6MjksIi4vY29tcG91bmRpZnkiOjQxfV0sMjg6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovKgogKiBUaGlzIGZpbGUgaXMgb3JnYW5pemVkIHdpdGggaW4gdGhlIGZvbGxvd2luZyBvcmRlcjoKICoKICogRXhwb3J0cwogKiBHcmFwaCBjb25zdHJ1Y3RvcnMKICogR3JhcGggcXVlcmllcyAoZS5nLiBub2RlcygpLCBlZGdlcygpCiAqIEdyYXBoIG11dGF0b3JzCiAqIEhlbHBlciBmdW5jdGlvbnMKICovCgp2YXIgdXRpbCA9IHJlcXVpcmUoIi4vdXRpbCIpLAogICAgQmFzZUdyYXBoID0gcmVxdWlyZSgiLi9CYXNlR3JhcGgiKSwKLyoganNoaW50IC1XMDc5ICovCiAgICBTZXQgPSByZXF1aXJlKCJjcC1kYXRhIikuU2V0OwovKiBqc2hpbnQgK1cwNzkgKi8KCm1vZHVsZS5leHBvcnRzID0gRGlncmFwaDsKCi8qCiAqIENvbnN0cnVjdG9yIHRvIGNyZWF0ZSBhIG5ldyBkaXJlY3RlZCBtdWx0aS1ncmFwaC4KICovCmZ1bmN0aW9uIERpZ3JhcGgoKSB7CiAgQmFzZUdyYXBoLmNhbGwodGhpcyk7CgogIC8qISBNYXAgb2Ygc291cmNlSWQgLT4ge3RhcmdldElkIC0+IFNldCBvZiBlZGdlIGlkc30gKi8KICB0aGlzLl9pbkVkZ2VzID0ge307CgogIC8qISBNYXAgb2YgdGFyZ2V0SWQgLT4ge3NvdXJjZUlkIC0+IFNldCBvZiBlZGdlIGlkc30gKi8KICB0aGlzLl9vdXRFZGdlcyA9IHt9Owp9CgpEaWdyYXBoLnByb3RvdHlwZSA9IG5ldyBCYXNlR3JhcGgoKTsKRGlncmFwaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBEaWdyYXBoOwoKLyoKICogQWx3YXlzIHJldHVybnMgYHRydWVgLgogKi8KRGlncmFwaC5wcm90b3R5cGUuaXNEaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiB0cnVlOwp9OwoKLyoKICogUmV0dXJucyBhbGwgc3VjY2Vzc29ycyBvZiB0aGUgbm9kZSB3aXRoIHRoZSBpZCBgdWAuIFRoYXQgaXMsIGFsbCBub2RlcwogKiB0aGF0IGhhdmUgdGhlIG5vZGUgYHVgIGFzIHRoZWlyIHNvdXJjZSBhcmUgcmV0dXJuZWQuCiAqIAogKiBJZiBubyBub2RlIGB1YCBleGlzdHMgaW4gdGhlIGdyYXBoIHRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdSBhIG5vZGUgaWQKICovCkRpZ3JhcGgucHJvdG90eXBlLnN1Y2Nlc3NvcnMgPSBmdW5jdGlvbih1KSB7CiAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fb3V0RWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbGwgcHJlZGVjZXNzb3JzIG9mIHRoZSBub2RlIHdpdGggdGhlIGlkIGB1YC4gVGhhdCBpcywgYWxsIG5vZGVzCiAqIHRoYXQgaGF2ZSB0aGUgbm9kZSBgdWAgYXMgdGhlaXIgdGFyZ2V0IGFyZSByZXR1cm5lZC4KICogCiAqIElmIG5vIG5vZGUgYHVgIGV4aXN0cyBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUucHJlZGVjZXNzb3JzID0gZnVuY3Rpb24odSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodSk7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2luRWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbGwgbm9kZXMgdGhhdCBhcmUgYWRqYWNlbnQgdG8gdGhlIG5vZGUgd2l0aCB0aGUgaWQgYHVgLiBJbiBvdGhlcgogKiB3b3JkcywgdGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBzZXQgb2YgYWxsIHN1Y2Nlc3NvcnMgYW5kIHByZWRlY2Vzc29ycyBvZgogKiBub2RlIGB1YC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5uZWlnaGJvcnMgPSBmdW5jdGlvbih1KSB7CiAgcmV0dXJuIFNldC51bmlvbihbdGhpcy5zdWNjZXNzb3JzKHUpLCB0aGlzLnByZWRlY2Vzc29ycyh1KV0pLmtleXMoKTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIGluIHRoZSBncmFwaCB0aGF0IGhhdmUgbm8gaW4tZWRnZXMuCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5zb3VyY2VzID0gZnVuY3Rpb24oKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwogIHJldHVybiB0aGlzLl9maWx0ZXJOb2RlcyhmdW5jdGlvbih1KSB7CiAgICAvLyBUaGlzIGNvdWxkIGhhdmUgYmV0dGVyIHNwYWNlIGNoYXJhY3RlcmlzdGljcyBpZiB3ZSBoYWQgYW4gaW5EZWdyZWUgZnVuY3Rpb24uCiAgICByZXR1cm4gc2VsZi5pbkVkZ2VzKHUpLmxlbmd0aCA9PT0gMDsKICB9KTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIGluIHRoZSBncmFwaCB0aGF0IGhhdmUgbm8gb3V0LWVkZ2VzLgogKi8KRGlncmFwaC5wcm90b3R5cGUuc2lua3MgPSBmdW5jdGlvbigpIHsKICB2YXIgc2VsZiA9IHRoaXM7CiAgcmV0dXJuIHRoaXMuX2ZpbHRlck5vZGVzKGZ1bmN0aW9uKHUpIHsKICAgIC8vIFRoaXMgY291bGQgaGF2ZSBiZXR0ZXIgc3BhY2UgY2hhcmFjdGVyaXN0aWNzIGlmIHdlIGhhdmUgYW4gb3V0RGVncmVlIGZ1bmN0aW9uLgogICAgcmV0dXJuIHNlbGYub3V0RWRnZXModSkubGVuZ3RoID09PSAwOwogIH0pOwp9OwoKLyoKICogUmV0dXJucyB0aGUgc291cmNlIG5vZGUgaW5jaWRlbnQgb24gdGhlIGVkZ2UgaWRlbnRpZmllZCBieSB0aGUgaWQgYGVgLiBJZiBubwogKiBzdWNoIGVkZ2UgZXhpc3RzIGluIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uIHRocm93cyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IGUgYW4gZWRnZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUuc291cmNlID0gZnVuY3Rpb24oZSkgewogIHJldHVybiB0aGlzLl9zdHJpY3RHZXRFZGdlKGUpLnU7Cn07CgovKgogKiBSZXR1cm5zIHRoZSB0YXJnZXQgbm9kZSBpbmNpZGVudCBvbiB0aGUgZWRnZSBpZGVudGlmaWVkIGJ5IHRoZSBpZCBgZWAuIElmIG5vCiAqIHN1Y2ggZWRnZSBleGlzdHMgaW4gdGhlIGdyYXBoIHRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS50YXJnZXQgPSBmdW5jdGlvbihlKSB7CiAgcmV0dXJuIHRoaXMuX3N0cmljdEdldEVkZ2UoZSkudjsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgaWRzIGZvciBhbGwgZWRnZXMgaW4gdGhlIGdyYXBoIHRoYXQgaGF2ZSB0aGUgbm9kZQogKiBgdGFyZ2V0YCBhcyB0aGVpciB0YXJnZXQuIElmIHRoZSBub2RlIGB0YXJnZXRgIGlzIG5vdCBpbiB0aGUgZ3JhcGggdGhpcwogKiBmdW5jdGlvbiByYWlzZXMgYW4gRXJyb3IuCiAqCiAqIE9wdGlvbmFsbHkgYSBgc291cmNlYCBub2RlIGNhbiBhbHNvIGJlIHNwZWNpZmllZC4gVGhpcyBjYXVzZXMgdGhlIHJlc3VsdHMKICogdG8gYmUgZmlsdGVyZWQgc3VjaCB0aGF0IG9ubHkgZWRnZXMgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YCBhcmUgaW5jbHVkZWQuCiAqIElmIHRoZSBub2RlIGBzb3VyY2VgIGlzIHNwZWNpZmllZCBidXQgaXMgbm90IGluIHRoZSBncmFwaCB0aGVuIHRoaXMgZnVuY3Rpb24KICogcmFpc2VzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdGFyZ2V0IHRoZSB0YXJnZXQgbm9kZSBpZAogKiBAcGFyYW0ge1N0cmluZ30gW3NvdXJjZV0gYW4gb3B0aW9uYWwgc291cmNlIG5vZGUgaWQKICovCkRpZ3JhcGgucHJvdG90eXBlLmluRWRnZXMgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodGFyZ2V0KTsKICB2YXIgcmVzdWx0cyA9IFNldC51bmlvbih1dGlsLnZhbHVlcyh0aGlzLl9pbkVkZ2VzW3RhcmdldF0pKS5rZXlzKCk7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICB0aGlzLl9zdHJpY3RHZXROb2RlKHNvdXJjZSk7CiAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIoZnVuY3Rpb24oZSkgeyByZXR1cm4gdGhpcy5zb3VyY2UoZSkgPT09IHNvdXJjZTsgfSwgdGhpcyk7CiAgfQogIHJldHVybiByZXN1bHRzOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBpZHMgZm9yIGFsbCBlZGdlcyBpbiB0aGUgZ3JhcGggdGhhdCBoYXZlIHRoZSBub2RlCiAqIGBzb3VyY2VgIGFzIHRoZWlyIHNvdXJjZS4gSWYgdGhlIG5vZGUgYHNvdXJjZWAgaXMgbm90IGluIHRoZSBncmFwaCB0aGlzCiAqIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogT3B0aW9uYWxseSBhIGB0YXJnZXRgIG5vZGUgbWF5IGFsc28gYmUgc3BlY2lmaWVkLiBUaGlzIGNhdXNlcyB0aGUgcmVzdWx0cwogKiB0byBiZSBmaWx0ZXJlZCBzdWNoIHRoYXQgb25seSBlZGdlcyBmcm9tIGBzb3VyY2VgIHRvIGB0YXJnZXRgIGFyZSBpbmNsdWRlZC4KICogSWYgdGhlIG5vZGUgYHRhcmdldGAgaXMgc3BlY2lmaWVkIGJ1dCBpcyBub3QgaW4gdGhlIGdyYXBoIHRoZW4gdGhpcyBmdW5jdGlvbgogKiByYWlzZXMgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSBzb3VyY2UgdGhlIHNvdXJjZSBub2RlIGlkCiAqIEBwYXJhbSB7U3RyaW5nfSBbdGFyZ2V0XSBhbiBvcHRpb25hbCB0YXJnZXQgbm9kZSBpZAogKi8KRGlncmFwaC5wcm90b3R5cGUub3V0RWRnZXMgPSBmdW5jdGlvbihzb3VyY2UsIHRhcmdldCkgewogIHRoaXMuX3N0cmljdEdldE5vZGUoc291cmNlKTsKICB2YXIgcmVzdWx0cyA9IFNldC51bmlvbih1dGlsLnZhbHVlcyh0aGlzLl9vdXRFZGdlc1tzb3VyY2VdKSkua2V5cygpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh0YXJnZXQpOwogICAgcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKGZ1bmN0aW9uKGUpIHsgcmV0dXJuIHRoaXMudGFyZ2V0KGUpID09PSB0YXJnZXQ7IH0sIHRoaXMpOwogIH0KICByZXR1cm4gcmVzdWx0czsKfTsKCi8qCiAqIFJldHVybnMgYW4gYXJyYXkgb2YgaWRzIGZvciBhbGwgZWRnZXMgaW4gdGhlIGdyYXBoIHRoYXQgaGF2ZSB0aGUgYHVgIGFzCiAqIHRoZWlyIHNvdXJjZSBvciB0aGVpciB0YXJnZXQuIElmIHRoZSBub2RlIGB1YCBpcyBub3QgaW4gdGhlIGdyYXBoIHRoaXMKICogZnVuY3Rpb24gcmFpc2VzIGFuIEVycm9yLgogKgogKiBPcHRpb25hbGx5IGEgYHZgIG5vZGUgbWF5IGFsc28gYmUgc3BlY2lmaWVkLiBUaGlzIGNhdXNlcyB0aGUgcmVzdWx0cyB0byBiZQogKiBmaWx0ZXJlZCBzdWNoIHRoYXQgb25seSBlZGdlcyBiZXR3ZWVuIGB1YCBhbmQgYHZgIC0gaW4gZWl0aGVyIGRpcmVjdGlvbiAtCiAqIGFyZSBpbmNsdWRlZC4gSUYgdGhlIG5vZGUgYHZgIGlzIHNwZWNpZmllZCBidXQgbm90IGluIHRoZSBncmFwaCB0aGVuIHRoaXMKICogZnVuY3Rpb24gcmFpc2VzIGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gdSB0aGUgbm9kZSBmb3Igd2hpY2ggdG8gZmluZCBpbmNpZGVudCBlZGdlcwogKiBAcGFyYW0ge1N0cmluZ30gW3ZdIG9wdGlvbiBub2RlIHRoYXQgbXVzdCBiZSBhZGphY2VudCB0byBgdWAKICovCkRpZ3JhcGgucHJvdG90eXBlLmluY2lkZW50RWRnZXMgPSBmdW5jdGlvbih1LCB2KSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKFt0aGlzLm91dEVkZ2VzKHUsIHYpLCB0aGlzLm91dEVkZ2VzKHYsIHUpXSkua2V5cygpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKFt0aGlzLmluRWRnZXModSksIHRoaXMub3V0RWRnZXModSldKS5rZXlzKCk7CiAgfQp9OwoKLyoKICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGdyYXBoLgogKi8KRGlncmFwaC5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gIkRpZ3JhcGggIiArIEpTT04uc3RyaW5naWZ5KHRoaXMsIG51bGwsIDIpOwp9OwoKLyoKICogQWRkcyBhIG5ldyBub2RlIHdpdGggdGhlIGlkIGB1YCB0byB0aGUgZ3JhcGggYW5kIGFzc2lnbnMgaXQgdGhlIHZhbHVlCiAqIGB2YWx1ZWAuIElmIGEgbm9kZSB3aXRoIHRoZSBpZCBpcyBhbHJlYWR5IGEgcGFydCBvZiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbgogKiB0aHJvd3MgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKiBAcGFyYW0ge09iamVjdH0gW3ZhbHVlXSBhbiBvcHRpb25hbCB2YWx1ZSB0byBhdHRhY2ggdG8gdGhlIG5vZGUKICovCkRpZ3JhcGgucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbih1LCB2YWx1ZSkgewogIHUgPSBCYXNlR3JhcGgucHJvdG90eXBlLmFkZE5vZGUuY2FsbCh0aGlzLCB1LCB2YWx1ZSk7CiAgdGhpcy5faW5FZGdlc1t1XSA9IHt9OwogIHRoaXMuX291dEVkZ2VzW3VdID0ge307CiAgcmV0dXJuIHU7Cn07CgovKgogKiBSZW1vdmVzIGEgbm9kZSBmcm9tIHRoZSBncmFwaCB0aGF0IGhhcyB0aGUgaWQgYHVgLiBBbnkgZWRnZXMgaW5jaWRlbnQgb24gdGhlCiAqIG5vZGUgYXJlIGFsc28gcmVtb3ZlZC4gSWYgdGhlIGdyYXBoIGRvZXMgbm90IGNvbnRhaW4gYSBub2RlIHdpdGggdGhlIGlkIHRoaXMKICogZnVuY3Rpb24gd2lsbCB0aHJvdyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5kZWxOb2RlID0gZnVuY3Rpb24odSkgewogIEJhc2VHcmFwaC5wcm90b3R5cGUuZGVsTm9kZS5jYWxsKHRoaXMsIHUpOwogIGRlbGV0ZSB0aGlzLl9pbkVkZ2VzW3VdOwogIGRlbGV0ZSB0aGlzLl9vdXRFZGdlc1t1XTsKfTsKCi8qCiAqIEFkZHMgYSBuZXcgZWRnZSB0byB0aGUgZ3JhcGggd2l0aCB0aGUgaWQgYGVgIGZyb20gYSBub2RlIHdpdGggdGhlIGlkIGBzb3VyY2VgCiAqIHRvIGEgbm9kZSB3aXRoIGFuIGlkIGB0YXJnZXRgIGFuZCBhc3NpZ25zIGl0IHRoZSB2YWx1ZSBgdmFsdWVgLiBUaGlzIGdyYXBoCiAqIGFsbG93cyBtb3JlIHRoYW4gb25lIGVkZ2UgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YCBhcyBsb25nIGFzIHRoZSBpZCBgZWAKICogaXMgdW5pcXVlIGluIHRoZSBzZXQgb2YgZWRnZXMuIElmIGBlYCBpcyBgbnVsbGAgdGhlIGdyYXBoIHdpbGwgYXNzaWduIGEKICogdW5pcXVlIGlkZW50aWZpZXIgdG8gdGhlIGVkZ2UuCiAqCiAqIElmIGBzb3VyY2VgIG9yIGB0YXJnZXRgIGFyZSBub3QgcHJlc2VudCBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB3aWxsCiAqIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gW2VdIGFuIGVkZ2UgaWQKICogQHBhcmFtIHtTdHJpbmd9IHNvdXJjZSB0aGUgc291cmNlIG5vZGUgaWQKICogQHBhcmFtIHtTdHJpbmd9IHRhcmdldCB0aGUgdGFyZ2V0IG5vZGUgaWQKICogQHBhcmFtIHtPYmplY3R9IFt2YWx1ZV0gYW4gb3B0aW9uYWwgdmFsdWUgdG8gYXR0YWNoIHRvIHRoZSBlZGdlCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5hZGRFZGdlID0gZnVuY3Rpb24oZSwgc291cmNlLCB0YXJnZXQsIHZhbHVlKSB7CiAgcmV0dXJuIEJhc2VHcmFwaC5wcm90b3R5cGUuX2FkZEVkZ2UuY2FsbCh0aGlzLCBlLCBzb3VyY2UsIHRhcmdldCwgdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbkVkZ2VzLCB0aGlzLl9vdXRFZGdlcyk7Cn07CgovKgogKiBSZW1vdmVzIGFuIGVkZ2UgaW4gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYC4gSWYgbm8gZWRnZSBpbiB0aGUgZ3JhcGggaGFzCiAqIHRoZSBpZCBgZWAgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpEaWdyYXBoLnByb3RvdHlwZS5kZWxFZGdlID0gZnVuY3Rpb24oZSkgewogIEJhc2VHcmFwaC5wcm90b3R5cGUuX2RlbEVkZ2UuY2FsbCh0aGlzLCBlLCB0aGlzLl9pbkVkZ2VzLCB0aGlzLl9vdXRFZGdlcyk7Cn07CgovLyBVbmxpa2UgQmFzZUdyYXBoLmZpbHRlck5vZGVzLCB0aGlzIGhlbHBlciBqdXN0IHJldHVybnMgbm9kZXMgdGhhdAovLyBzYXRpc2Z5IGEgcHJlZGljYXRlLgpEaWdyYXBoLnByb3RvdHlwZS5fZmlsdGVyTm9kZXMgPSBmdW5jdGlvbihwcmVkKSB7CiAgdmFyIGZpbHRlcmVkID0gW107CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1KSB7CiAgICBpZiAocHJlZCh1KSkgewogICAgICBmaWx0ZXJlZC5wdXNoKHUpOwogICAgfQogIH0pOwogIHJldHVybiBmaWx0ZXJlZDsKfTsKCgp9LHsiLi9CYXNlR3JhcGgiOjI1LCIuL3V0aWwiOjQ1LCJjcC1kYXRhIjoxOX1dLDI5OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKLyoKICogVGhpcyBmaWxlIGlzIG9yZ2FuaXplZCB3aXRoIGluIHRoZSBmb2xsb3dpbmcgb3JkZXI6CiAqCiAqIEV4cG9ydHMKICogR3JhcGggY29uc3RydWN0b3JzCiAqIEdyYXBoIHF1ZXJpZXMgKGUuZy4gbm9kZXMoKSwgZWRnZXMoKQogKiBHcmFwaCBtdXRhdG9ycwogKiBIZWxwZXIgZnVuY3Rpb25zCiAqLwoKdmFyIHV0aWwgPSByZXF1aXJlKCIuL3V0aWwiKSwKICAgIEJhc2VHcmFwaCA9IHJlcXVpcmUoIi4vQmFzZUdyYXBoIiksCi8qIGpzaGludCAtVzA3OSAqLwogICAgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IEdyYXBoOwoKLyoKICogQ29uc3RydWN0b3IgdG8gY3JlYXRlIGEgbmV3IHVuZGlyZWN0ZWQgbXVsdGktZ3JhcGguCiAqLwpmdW5jdGlvbiBHcmFwaCgpIHsKICBCYXNlR3JhcGguY2FsbCh0aGlzKTsKCiAgLyohIE1hcCBvZiBub2RlSWQgLT4geyBvdGhlck5vZGVJZCAtPiBTZXQgb2YgZWRnZSBpZHMgfSAqLwogIHRoaXMuX2luY2lkZW50RWRnZXMgPSB7fTsKfQoKR3JhcGgucHJvdG90eXBlID0gbmV3IEJhc2VHcmFwaCgpOwpHcmFwaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBHcmFwaDsKCi8qCiAqIEFsd2F5cyByZXR1cm5zIGBmYWxzZWAuCiAqLwpHcmFwaC5wcm90b3R5cGUuaXNEaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBmYWxzZTsKfTsKCi8qCiAqIFJldHVybnMgYWxsIG5vZGVzIHRoYXQgYXJlIGFkamFjZW50IHRvIHRoZSBub2RlIHdpdGggdGhlIGlkIGB1YC4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqLwpHcmFwaC5wcm90b3R5cGUubmVpZ2hib3JzID0gZnVuY3Rpb24odSkgewogIHRoaXMuX3N0cmljdEdldE5vZGUodSk7CiAgcmV0dXJuIE9iamVjdC5rZXlzKHRoaXMuX2luY2lkZW50RWRnZXNbdV0pCiAgICAgICAgICAgICAgIC5tYXAoZnVuY3Rpb24odikgeyByZXR1cm4gdGhpcy5fbm9kZXNbdl0uaWQ7IH0sIHRoaXMpOwp9OwoKLyoKICogUmV0dXJucyBhbiBhcnJheSBvZiBpZHMgZm9yIGFsbCBlZGdlcyBpbiB0aGUgZ3JhcGggdGhhdCBhcmUgaW5jaWRlbnQgb24gYHVgLgogKiBJZiB0aGUgbm9kZSBgdWAgaXMgbm90IGluIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogT3B0aW9uYWxseSBhIGB2YCBub2RlIG1heSBhbHNvIGJlIHNwZWNpZmllZC4gVGhpcyBjYXVzZXMgdGhlIHJlc3VsdHMgdG8gYmUKICogZmlsdGVyZWQgc3VjaCB0aGF0IG9ubHkgZWRnZXMgYmV0d2VlbiBgdWAgYW5kIGB2YCBhcmUgaW5jbHVkZWQuIElmIHRoZSBub2RlCiAqIGB2YCBpcyBzcGVjaWZpZWQgYnV0IG5vdCBpbiB0aGUgZ3JhcGggdGhlbiB0aGlzIGZ1bmN0aW9uIHJhaXNlcyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgdGhlIG5vZGUgZm9yIHdoaWNoIHRvIGZpbmQgaW5jaWRlbnQgZWRnZXMKICogQHBhcmFtIHtTdHJpbmd9IFt2XSBvcHRpb24gbm9kZSB0aGF0IG11c3QgYmUgYWRqYWNlbnQgdG8gYHVgCiAqLwpHcmFwaC5wcm90b3R5cGUuaW5jaWRlbnRFZGdlcyA9IGZ1bmN0aW9uKHUsIHYpIHsKICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh2KTsKICAgIHJldHVybiB2IGluIHRoaXMuX2luY2lkZW50RWRnZXNbdV0gPyB0aGlzLl9pbmNpZGVudEVkZ2VzW3VdW3ZdLmtleXMoKSA6IFtdOwogIH0gZWxzZSB7CiAgICByZXR1cm4gU2V0LnVuaW9uKHV0aWwudmFsdWVzKHRoaXMuX2luY2lkZW50RWRnZXNbdV0pKS5rZXlzKCk7CiAgfQp9OwoKLyoKICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIGdyYXBoLgogKi8KR3JhcGgucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuICJHcmFwaCAiICsgSlNPTi5zdHJpbmdpZnkodGhpcywgbnVsbCwgMik7Cn07CgovKgogKiBBZGRzIGEgbmV3IG5vZGUgd2l0aCB0aGUgaWQgYHVgIHRvIHRoZSBncmFwaCBhbmQgYXNzaWducyBpdCB0aGUgdmFsdWUKICogYHZhbHVlYC4gSWYgYSBub2RlIHdpdGggdGhlIGlkIGlzIGFscmVhZHkgYSBwYXJ0IG9mIHRoZSBncmFwaCB0aGlzIGZ1bmN0aW9uCiAqIHRocm93cyBhbiBFcnJvci4KICoKICogQHBhcmFtIHtTdHJpbmd9IHUgYSBub2RlIGlkCiAqIEBwYXJhbSB7T2JqZWN0fSBbdmFsdWVdIGFuIG9wdGlvbmFsIHZhbHVlIHRvIGF0dGFjaCB0byB0aGUgbm9kZQogKi8KR3JhcGgucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbih1LCB2YWx1ZSkgewogIHUgPSBCYXNlR3JhcGgucHJvdG90eXBlLmFkZE5vZGUuY2FsbCh0aGlzLCB1LCB2YWx1ZSk7CiAgdGhpcy5faW5jaWRlbnRFZGdlc1t1XSA9IHt9OwogIHJldHVybiB1Owp9OwoKLyoKICogUmVtb3ZlcyBhIG5vZGUgZnJvbSB0aGUgZ3JhcGggdGhhdCBoYXMgdGhlIGlkIGB1YC4gQW55IGVkZ2VzIGluY2lkZW50IG9uIHRoZQogKiBub2RlIGFyZSBhbHNvIHJlbW92ZWQuIElmIHRoZSBncmFwaCBkb2VzIG5vdCBjb250YWluIGEgbm9kZSB3aXRoIHRoZSBpZCB0aGlzCiAqIGZ1bmN0aW9uIHdpbGwgdGhyb3cgYW4gRXJyb3IuCiAqCiAqIEBwYXJhbSB7U3RyaW5nfSB1IGEgbm9kZSBpZAogKi8KR3JhcGgucHJvdG90eXBlLmRlbE5vZGUgPSBmdW5jdGlvbih1KSB7CiAgQmFzZUdyYXBoLnByb3RvdHlwZS5kZWxOb2RlLmNhbGwodGhpcywgdSk7CiAgZGVsZXRlIHRoaXMuX2luY2lkZW50RWRnZXNbdV07Cn07CgovKgogKiBBZGRzIGEgbmV3IGVkZ2UgdG8gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYCBiZXR3ZWVuIGEgbm9kZSB3aXRoIHRoZSBpZCBgdWAKICogYW5kIGEgbm9kZSB3aXRoIGFuIGlkIGB2YCBhbmQgYXNzaWducyBpdCB0aGUgdmFsdWUgYHZhbHVlYC4gVGhpcyBncmFwaAogKiBhbGxvd3MgbW9yZSB0aGFuIG9uZSBlZGdlIGJldHdlZW4gYHVgIGFuZCBgdmAgYXMgbG9uZyBhcyB0aGUgaWQgYGVgCiAqIGlzIHVuaXF1ZSBpbiB0aGUgc2V0IG9mIGVkZ2VzLiBJZiBgZWAgaXMgYG51bGxgIHRoZSBncmFwaCB3aWxsIGFzc2lnbiBhCiAqIHVuaXF1ZSBpZGVudGlmaWVyIHRvIHRoZSBlZGdlLgogKgogKiBJZiBgdWAgb3IgYHZgIGFyZSBub3QgcHJlc2VudCBpbiB0aGUgZ3JhcGggdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuCiAqIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gW2VdIGFuIGVkZ2UgaWQKICogQHBhcmFtIHtTdHJpbmd9IHUgdGhlIG5vZGUgaWQgb2Ygb25lIG9mIHRoZSBhZGphY2VudCBub2RlcwogKiBAcGFyYW0ge1N0cmluZ30gdiB0aGUgbm9kZSBpZCBvZiB0aGUgb3RoZXIgYWRqYWNlbnQgbm9kZQogKiBAcGFyYW0ge09iamVjdH0gW3ZhbHVlXSBhbiBvcHRpb25hbCB2YWx1ZSB0byBhdHRhY2ggdG8gdGhlIGVkZ2UKICovCkdyYXBoLnByb3RvdHlwZS5hZGRFZGdlID0gZnVuY3Rpb24oZSwgdSwgdiwgdmFsdWUpIHsKICByZXR1cm4gQmFzZUdyYXBoLnByb3RvdHlwZS5fYWRkRWRnZS5jYWxsKHRoaXMsIGUsIHUsIHYsIHZhbHVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5jaWRlbnRFZGdlcywgdGhpcy5faW5jaWRlbnRFZGdlcyk7Cn07CgovKgogKiBSZW1vdmVzIGFuIGVkZ2UgaW4gdGhlIGdyYXBoIHdpdGggdGhlIGlkIGBlYC4gSWYgbm8gZWRnZSBpbiB0aGUgZ3JhcGggaGFzCiAqIHRoZSBpZCBgZWAgdGhpcyBmdW5jdGlvbiB3aWxsIHRocm93IGFuIEVycm9yLgogKgogKiBAcGFyYW0ge1N0cmluZ30gZSBhbiBlZGdlIGlkCiAqLwpHcmFwaC5wcm90b3R5cGUuZGVsRWRnZSA9IGZ1bmN0aW9uKGUpIHsKICBCYXNlR3JhcGgucHJvdG90eXBlLl9kZWxFZGdlLmNhbGwodGhpcywgZSwgdGhpcy5faW5jaWRlbnRFZGdlcywgdGhpcy5faW5jaWRlbnRFZGdlcyk7Cn07CgoKfSx7Ii4vQmFzZUdyYXBoIjoyNSwiLi91dGlsIjo0NSwiY3AtZGF0YSI6MTl9XSwzMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IGNvbXBvbmVudHM7CgovKioKICogRmluZHMgYWxsIFtjb25uZWN0ZWQgY29tcG9uZW50c11bXSBpbiBhIGdyYXBoIGFuZCByZXR1cm5zIGFuIGFycmF5IG9mIHRoZXNlCiAqIGNvbXBvbmVudHMuIEVhY2ggY29tcG9uZW50IGlzIGl0c2VsZiBhbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSBpZHMgb2Ygbm9kZXMKICogaW4gdGhlIGNvbXBvbmVudC4KICoKICogVGhpcyBmdW5jdGlvbiBvbmx5IHdvcmtzIHdpdGggdW5kaXJlY3RlZCBHcmFwaHMuCiAqCiAqIFtjb25uZWN0ZWQgY29tcG9uZW50c106IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29ubmVjdGVkX2NvbXBvbmVudF8oZ3JhcGhfdGhlb3J5KQogKgogKiBAcGFyYW0ge0dyYXBofSBnIHRoZSBncmFwaCB0byBzZWFyY2ggZm9yIGNvbXBvbmVudHMKICovCmZ1bmN0aW9uIGNvbXBvbmVudHMoZykgewogIHZhciByZXN1bHRzID0gW107CiAgdmFyIHZpc2l0ZWQgPSBuZXcgU2V0KCk7CgogIGZ1bmN0aW9uIGRmcyh2LCBjb21wb25lbnQpIHsKICAgIGlmICghdmlzaXRlZC5oYXModikpIHsKICAgICAgdmlzaXRlZC5hZGQodik7CiAgICAgIGNvbXBvbmVudC5wdXNoKHYpOwogICAgICBnLm5laWdoYm9ycyh2KS5mb3JFYWNoKGZ1bmN0aW9uKHcpIHsKICAgICAgICBkZnModywgY29tcG9uZW50KTsKICAgICAgfSk7CiAgICB9CiAgfQoKICBnLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICB2YXIgY29tcG9uZW50ID0gW107CiAgICBkZnModiwgY29tcG9uZW50KTsKICAgIGlmIChjb21wb25lbnQubGVuZ3RoID4gMCkgewogICAgICByZXN1bHRzLnB1c2goY29tcG9uZW50KTsKICAgIH0KICB9KTsKCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCn0seyJjcC1kYXRhIjoxOX1dLDMxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIFByaW9yaXR5UXVldWUgPSByZXF1aXJlKCJjcC1kYXRhIikuUHJpb3JpdHlRdWV1ZTsKCm1vZHVsZS5leHBvcnRzID0gZGlqa3N0cmE7CgovKioKICogVGhpcyBmdW5jdGlvbiBpcyBhbiBpbXBsZW1lbnRhdGlvbiBvZiBbRGlqa3N0cmEncyBhbGdvcml0aG1dW10gd2hpY2ggZmluZHMKICogdGhlIHNob3J0ZXN0IHBhdGggZnJvbSAqKnNvdXJjZSoqIHRvIGFsbCBvdGhlciBub2RlcyBpbiAqKmcqKi4gVGhpcwogKiBmdW5jdGlvbiByZXR1cm5zIGEgbWFwIG9mIGB1IC0+IHsgZGlzdGFuY2UsIHByZWRlY2Vzc29yIH1gLiBUaGUgZGlzdGFuY2UKICogcHJvcGVydHkgaG9sZHMgdGhlIHN1bSBvZiB0aGUgd2VpZ2h0cyBmcm9tICoqc291cmNlKiogdG8gYHVgIGFsb25nIHRoZQogKiBzaG9ydGVzdCBwYXRoIG9yIGBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlgIGlmIHRoZXJlIGlzIG5vIHBhdGggZnJvbQogKiAqKnNvdXJjZSoqLiBUaGUgcHJlZGVjZXNzb3IgcHJvcGVydHkgY2FuIGJlIHVzZWQgdG8gd2FsayB0aGUgaW5kaXZpZHVhbAogKiBlbGVtZW50cyBvZiB0aGUgcGF0aCBmcm9tICoqc291cmNlKiogdG8gKip1KiogaW4gcmV2ZXJzZSBvcmRlci4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgd2VpZ2h0RnVuYyhlKWAgd2hpY2ggcmV0dXJucyB0aGUKICogd2VpZ2h0IG9mIHRoZSBlZGdlIGBlYC4gSWYgbm8gd2VpZ2h0RnVuYyBpcyBzdXBwbGllZCB0aGVuIGVhY2ggZWRnZSBpcwogKiBhc3N1bWVkIHRvIGhhdmUgYSB3ZWlnaHQgb2YgMS4gVGhpcyBmdW5jdGlvbiB0aHJvd3MgYW4gRXJyb3IgaWYgYW55IG9mCiAqIHRoZSB0cmF2ZXJzZWQgZWRnZXMgaGF2ZSBhIG5lZ2F0aXZlIGVkZ2Ugd2VpZ2h0LgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGFuIG9wdGlvbmFsIGBpbmNpZGVudEZ1bmModSlgIHdoaWNoIHJldHVybnMgdGhlIGlkcyBvZgogKiBhbGwgZWRnZXMgaW5jaWRlbnQgdG8gdGhlIG5vZGUgYHVgIGZvciB0aGUgcHVycG9zZXMgb2Ygc2hvcnRlc3QgcGF0aAogKiB0cmF2ZXJzYWwuIEJ5IGRlZmF1bHQgdGhpcyBmdW5jdGlvbiB1c2VzIHRoZSBgZy5vdXRFZGdlc2AgZm9yIERpZ3JhcGhzIGFuZAogKiBgZy5pbmNpZGVudEVkZ2VzYCBmb3IgR3JhcGhzLgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGBPKCh8RXwgKyB8VnwpICogbG9nIHxWfClgIHRpbWUuCiAqCiAqIFtEaWprc3RyYSdzIGFsZ29yaXRobV06IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGlqa3N0cmElMjdzX2FsZ29yaXRobQogKgogKiBAcGFyYW0ge0dyYXBofSBnIHRoZSBncmFwaCB0byBzZWFyY2ggZm9yIHNob3J0ZXN0IHBhdGhzIGZyb20gKipzb3VyY2UqKgogKiBAcGFyYW0ge09iamVjdH0gc291cmNlIHRoZSBzb3VyY2UgZnJvbSB3aGljaCB0byBzdGFydCB0aGUgc2VhcmNoCiAqIEBwYXJhbSB7RnVuY3Rpb259IFt3ZWlnaHRGdW5jXSBvcHRpb25hbCB3ZWlnaHQgZnVuY3Rpb24KICogQHBhcmFtIHtGdW5jdGlvbn0gW2luY2lkZW50RnVuY10gb3B0aW9uYWwgaW5jaWRlbnQgZnVuY3Rpb24KICovCmZ1bmN0aW9uIGRpamtzdHJhKGcsIHNvdXJjZSwgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKSB7CiAgdmFyIHJlc3VsdHMgPSB7fSwKICAgICAgcHEgPSBuZXcgUHJpb3JpdHlRdWV1ZSgpOwoKICBmdW5jdGlvbiB1cGRhdGVOZWlnaGJvcnMoZSkgewogICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgdiA9IGluY2lkZW50Tm9kZXNbMF0gIT09IHUgPyBpbmNpZGVudE5vZGVzWzBdIDogaW5jaWRlbnROb2Rlc1sxXSwKICAgICAgICB2RW50cnkgPSByZXN1bHRzW3ZdLAogICAgICAgIHdlaWdodCA9IHdlaWdodEZ1bmMoZSksCiAgICAgICAgZGlzdGFuY2UgPSB1RW50cnkuZGlzdGFuY2UgKyB3ZWlnaHQ7CgogICAgaWYgKHdlaWdodCA8IDApIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJkaWprc3RyYSBkb2VzIG5vdCBhbGxvdyBuZWdhdGl2ZSBlZGdlIHdlaWdodHMuIEJhZCBlZGdlOiAiICsgZSArICIgV2VpZ2h0OiAiICsgd2VpZ2h0KTsKICAgIH0KCiAgICBpZiAoZGlzdGFuY2UgPCB2RW50cnkuZGlzdGFuY2UpIHsKICAgICAgdkVudHJ5LmRpc3RhbmNlID0gZGlzdGFuY2U7CiAgICAgIHZFbnRyeS5wcmVkZWNlc3NvciA9IHU7CiAgICAgIHBxLmRlY3JlYXNlKHYsIGRpc3RhbmNlKTsKICAgIH0KICB9CgogIHdlaWdodEZ1bmMgPSB3ZWlnaHRGdW5jIHx8IGZ1bmN0aW9uKCkgeyByZXR1cm4gMTsgfTsKICBpbmNpZGVudEZ1bmMgPSBpbmNpZGVudEZ1bmMgfHwgKGcuaXNEaXJlY3RlZCgpCiAgICAgID8gZnVuY3Rpb24odSkgeyByZXR1cm4gZy5vdXRFZGdlcyh1KTsgfQogICAgICA6IGZ1bmN0aW9uKHUpIHsgcmV0dXJuIGcuaW5jaWRlbnRFZGdlcyh1KTsgfSk7CgogIGcuZWFjaE5vZGUoZnVuY3Rpb24odSkgewogICAgdmFyIGRpc3RhbmNlID0gdSA9PT0gc291cmNlID8gMCA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIHJlc3VsdHNbdV0gPSB7IGRpc3RhbmNlOiBkaXN0YW5jZSB9OwogICAgcHEuYWRkKHUsIGRpc3RhbmNlKTsKICB9KTsKCiAgdmFyIHUsIHVFbnRyeTsKICB3aGlsZSAocHEuc2l6ZSgpID4gMCkgewogICAgdSA9IHBxLnJlbW92ZU1pbigpOwogICAgdUVudHJ5ID0gcmVzdWx0c1t1XTsKICAgIGlmICh1RW50cnkuZGlzdGFuY2UgPT09IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSkgewogICAgICBicmVhazsKICAgIH0KCiAgICBpbmNpZGVudEZ1bmModSkuZm9yRWFjaCh1cGRhdGVOZWlnaGJvcnMpOwogIH0KCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCn0seyJjcC1kYXRhIjoxOX1dLDMyOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIGRpamtzdHJhID0gcmVxdWlyZSgiLi9kaWprc3RyYSIpOwoKbW9kdWxlLmV4cG9ydHMgPSBkaWprc3RyYUFsbDsKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIGZpbmRzIHRoZSBzaG9ydGVzdCBwYXRoIGZyb20gZWFjaCBub2RlIHRvIGV2ZXJ5IG90aGVyCiAqIHJlYWNoYWJsZSBub2RlIGluIHRoZSBncmFwaC4gSXQgaXMgc2ltaWxhciB0byBbYWxnLmRpamtzdHJhXVtdLCBidXQKICogaW5zdGVhZCBvZiByZXR1cm5pbmcgYSBzaW5nbGUtc291cmNlIGFycmF5LCBpdCByZXR1cm5zIGEgbWFwcGluZyBvZgogKiBvZiBgc291cmNlIC0+IGFsZy5kaWprc3RhKGcsIHNvdXJjZSwgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKWAuCiAqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYW4gb3B0aW9uYWwgYHdlaWdodEZ1bmMoZSlgIHdoaWNoIHJldHVybnMgdGhlCiAqIHdlaWdodCBvZiB0aGUgZWRnZSBgZWAuIElmIG5vIHdlaWdodEZ1bmMgaXMgc3VwcGxpZWQgdGhlbiBlYWNoIGVkZ2UgaXMKICogYXNzdW1lZCB0byBoYXZlIGEgd2VpZ2h0IG9mIDEuIFRoaXMgZnVuY3Rpb24gdGhyb3dzIGFuIEVycm9yIGlmIGFueSBvZgogKiB0aGUgdHJhdmVyc2VkIGVkZ2VzIGhhdmUgYSBuZWdhdGl2ZSBlZGdlIHdlaWdodC4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgaW5jaWRlbnRGdW5jKHUpYCB3aGljaCByZXR1cm5zIHRoZSBpZHMgb2YKICogYWxsIGVkZ2VzIGluY2lkZW50IHRvIHRoZSBub2RlIGB1YCBmb3IgdGhlIHB1cnBvc2VzIG9mIHNob3J0ZXN0IHBhdGgKICogdHJhdmVyc2FsLiBCeSBkZWZhdWx0IHRoaXMgZnVuY3Rpb24gdXNlcyB0aGUgYG91dEVkZ2VzYCBmdW5jdGlvbiBvbiB0aGUKICogc3VwcGxpZWQgZ3JhcGguCiAqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYE8ofFZ8ICogKHxFfCArIHxWfCkgKiBsb2cgfFZ8KWAgdGltZS4KICoKICogW2FsZy5kaWprc3RyYV06IGRpamtzdHJhLmpzLmh0bWwjZGlqa3N0cmEKICoKICogQHBhcmFtIHtHcmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBzaG9ydGVzdCBwYXRocyBmcm9tICoqc291cmNlKioKICogQHBhcmFtIHtGdW5jdGlvbn0gW3dlaWdodEZ1bmNdIG9wdGlvbmFsIHdlaWdodCBmdW5jdGlvbgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaW5jaWRlbnRGdW5jXSBvcHRpb25hbCBpbmNpZGVudCBmdW5jdGlvbgogKi8KZnVuY3Rpb24gZGlqa3N0cmFBbGwoZywgd2VpZ2h0RnVuYywgaW5jaWRlbnRGdW5jKSB7CiAgdmFyIHJlc3VsdHMgPSB7fTsKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsKICAgIHJlc3VsdHNbdV0gPSBkaWprc3RyYShnLCB1LCB3ZWlnaHRGdW5jLCBpbmNpZGVudEZ1bmMpOwogIH0pOwogIHJldHVybiByZXN1bHRzOwp9Cgp9LHsiLi9kaWprc3RyYSI6MzF9XSwzMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0YXJqYW4gPSByZXF1aXJlKCIuL3RhcmphbiIpOwoKbW9kdWxlLmV4cG9ydHMgPSBmaW5kQ3ljbGVzOwoKLyoKICogR2l2ZW4gYSBEaWdyYXBoICoqZyoqIHRoaXMgZnVuY3Rpb24gcmV0dXJucyBhbGwgbm9kZXMgdGhhdCBhcmUgcGFydCBvZiBhCiAqIGN5Y2xlLiBTaW5jZSB0aGVyZSBtYXkgYmUgbW9yZSB0aGFuIG9uZSBjeWNsZSBpbiBhIGdyYXBoIHRoaXMgZnVuY3Rpb24KICogcmV0dXJucyBhbiBhcnJheSBvZiB0aGVzZSBjeWNsZXMsIHdoZXJlIGVhY2ggY3ljbGUgaXMgaXRzZWxmIHJlcHJlc2VudGVkCiAqIGJ5IGFuIGFycmF5IG9mIGlkcyBmb3IgZWFjaCBub2RlIGludm9sdmVkIGluIHRoYXQgY3ljbGUuCiAqCiAqIFthbGcuaXNBY3ljbGljXVtdIGlzIG1vcmUgZWZmaWNpZW50IGlmIHlvdSBvbmx5IG5lZWQgdG8gZGV0ZXJtaW5lIHdoZXRoZXIKICogYSBncmFwaCBoYXMgYSBjeWNsZSBvciBub3QuCiAqCiAqIFthbGcuaXNBY3ljbGljXTogaXNBY3ljbGljLmpzLmh0bWwjaXNBY3ljbGljCiAqCiAqIEBwYXJhbSB7RGlncmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBjeWNsZXMuCiAqLwpmdW5jdGlvbiBmaW5kQ3ljbGVzKGcpIHsKICByZXR1cm4gdGFyamFuKGcpLmZpbHRlcihmdW5jdGlvbihjbXB0KSB7IHJldHVybiBjbXB0Lmxlbmd0aCA+IDE7IH0pOwp9Cgp9LHsiLi90YXJqYW4iOjM5fV0sMzQ6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IGZsb3lkV2Fyc2hhbGw7CgovKioKICogVGhpcyBmdW5jdGlvbiBpcyBhbiBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgW0Zsb3lkLVdhcnNoYWxsIGFsZ29yaXRobV1bXSwKICogd2hpY2ggZmluZHMgdGhlIHNob3J0ZXN0IHBhdGggZnJvbSBlYWNoIG5vZGUgdG8gZXZlcnkgb3RoZXIgcmVhY2hhYmxlIG5vZGUKICogaW4gdGhlIGdyYXBoLiBJdCBpcyBzaW1pbGFyIHRvIFthbGcuZGlqa3N0cmFBbGxdW10sIGJ1dCBpdCBoYW5kbGVzIG5lZ2F0aXZlCiAqIGVkZ2Ugd2VpZ2h0cyBhbmQgaXMgbW9yZSBlZmZpY2llbnQgZm9yIHNvbWUgdHlwZXMgb2YgZ3JhcGhzLiBUaGlzIGZ1bmN0aW9uCiAqIHJldHVybnMgYSBtYXAgb2YgYHNvdXJjZSAtPiB7IHRhcmdldCAtPiB7IGRpc3RhbmNlLCBwcmVkZWNlc3NvciB9YC4gVGhlCiAqIGRpc3RhbmNlIHByb3BlcnR5IGhvbGRzIHRoZSBzdW0gb2YgdGhlIHdlaWdodHMgZnJvbSBgc291cmNlYCB0byBgdGFyZ2V0YAogKiBhbG9uZyB0aGUgc2hvcnRlc3QgcGF0aCBvZiBgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZYCBpZiB0aGVyZSBpcyBubyBwYXRoCiAqIGZyb20gYHNvdXJjZWAuIFRoZSBwcmVkZWNlc3NvciBwcm9wZXJ0eSBjYW4gYmUgdXNlZCB0byB3YWxrIHRoZSBpbmRpdmlkdWFsCiAqIGVsZW1lbnRzIG9mIHRoZSBwYXRoIGZyb20gYHNvdXJjZWAgdG8gYHRhcmdldGAgaW4gcmV2ZXJzZSBvcmRlci4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgd2VpZ2h0RnVuYyhlKWAgd2hpY2ggcmV0dXJucyB0aGUKICogd2VpZ2h0IG9mIHRoZSBlZGdlIGBlYC4gSWYgbm8gd2VpZ2h0RnVuYyBpcyBzdXBwbGllZCB0aGVuIGVhY2ggZWRnZSBpcwogKiBhc3N1bWVkIHRvIGhhdmUgYSB3ZWlnaHQgb2YgMS4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBhbiBvcHRpb25hbCBgaW5jaWRlbnRGdW5jKHUpYCB3aGljaCByZXR1cm5zIHRoZSBpZHMgb2YKICogYWxsIGVkZ2VzIGluY2lkZW50IHRvIHRoZSBub2RlIGB1YCBmb3IgdGhlIHB1cnBvc2VzIG9mIHNob3J0ZXN0IHBhdGgKICogdHJhdmVyc2FsLiBCeSBkZWZhdWx0IHRoaXMgZnVuY3Rpb24gdXNlcyB0aGUgYG91dEVkZ2VzYCBmdW5jdGlvbiBvbiB0aGUKICogc3VwcGxpZWQgZ3JhcGguCiAqCiAqIFRoaXMgYWxnb3JpdGhtIHRha2VzIE8ofFZ8XjMpIHRpbWUuCiAqCiAqIFtGbG95ZC1XYXJzaGFsbCBhbGdvcml0aG1dOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9GbG95ZC1XYXJzaGFsbF9hbGdvcml0aG0KICogW2FsZy5kaWprc3RyYUFsbF06IGRpamtzdHJhQWxsLmpzLmh0bWwjZGlqa3N0cmFBbGwKICoKICogQHBhcmFtIHtHcmFwaH0gZyB0aGUgZ3JhcGggdG8gc2VhcmNoIGZvciBzaG9ydGVzdCBwYXRocyBmcm9tICoqc291cmNlKioKICogQHBhcmFtIHtGdW5jdGlvbn0gW3dlaWdodEZ1bmNdIG9wdGlvbmFsIHdlaWdodCBmdW5jdGlvbgogKiBAcGFyYW0ge0Z1bmN0aW9ufSBbaW5jaWRlbnRGdW5jXSBvcHRpb25hbCBpbmNpZGVudCBmdW5jdGlvbgogKi8KZnVuY3Rpb24gZmxveWRXYXJzaGFsbChnLCB3ZWlnaHRGdW5jLCBpbmNpZGVudEZ1bmMpIHsKICB2YXIgcmVzdWx0cyA9IHt9LAogICAgICBub2RlcyA9IGcubm9kZXMoKTsKCiAgd2VpZ2h0RnVuYyA9IHdlaWdodEZ1bmMgfHwgZnVuY3Rpb24oKSB7IHJldHVybiAxOyB9OwogIGluY2lkZW50RnVuYyA9IGluY2lkZW50RnVuYyB8fCAoZy5pc0RpcmVjdGVkKCkKICAgICAgPyBmdW5jdGlvbih1KSB7IHJldHVybiBnLm91dEVkZ2VzKHUpOyB9CiAgICAgIDogZnVuY3Rpb24odSkgeyByZXR1cm4gZy5pbmNpZGVudEVkZ2VzKHUpOyB9KTsKCiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICByZXN1bHRzW3VdID0ge307CiAgICByZXN1bHRzW3VdW3VdID0geyBkaXN0YW5jZTogMCB9OwogICAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICh1ICE9PSB2KSB7CiAgICAgICAgcmVzdWx0c1t1XVt2XSA9IHsgZGlzdGFuY2U6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWSB9OwogICAgICB9CiAgICB9KTsKICAgIGluY2lkZW50RnVuYyh1KS5mb3JFYWNoKGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgICB2ID0gaW5jaWRlbnROb2Rlc1swXSAhPT0gdSA/IGluY2lkZW50Tm9kZXNbMF0gOiBpbmNpZGVudE5vZGVzWzFdLAogICAgICAgICAgZCA9IHdlaWdodEZ1bmMoZSk7CiAgICAgIGlmIChkIDwgcmVzdWx0c1t1XVt2XS5kaXN0YW5jZSkgewogICAgICAgIHJlc3VsdHNbdV1bdl0gPSB7IGRpc3RhbmNlOiBkLCBwcmVkZWNlc3NvcjogdSB9OwogICAgICB9CiAgICB9KTsKICB9KTsKCiAgbm9kZXMuZm9yRWFjaChmdW5jdGlvbihrKSB7CiAgICB2YXIgcm93SyA9IHJlc3VsdHNba107CiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgdmFyIHJvd0kgPSByZXN1bHRzW2ldOwogICAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKGopIHsKICAgICAgICB2YXIgaWsgPSByb3dJW2tdOwogICAgICAgIHZhciBraiA9IHJvd0tbal07CiAgICAgICAgdmFyIGlqID0gcm93SVtqXTsKICAgICAgICB2YXIgYWx0RGlzdGFuY2UgPSBpay5kaXN0YW5jZSArIGtqLmRpc3RhbmNlOwogICAgICAgIGlmIChhbHREaXN0YW5jZSA8IGlqLmRpc3RhbmNlKSB7CiAgICAgICAgICBpai5kaXN0YW5jZSA9IGFsdERpc3RhbmNlOwogICAgICAgICAgaWoucHJlZGVjZXNzb3IgPSBrai5wcmVkZWNlc3NvcjsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfSk7CgogIHJldHVybiByZXN1bHRzOwp9Cgp9LHt9XSwzNTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciB0b3Bzb3J0ID0gcmVxdWlyZSgiLi90b3Bzb3J0Iik7Cgptb2R1bGUuZXhwb3J0cyA9IGlzQWN5Y2xpYzsKCi8qCiAqIEdpdmVuIGEgRGlncmFwaCAqKmcqKiB0aGlzIGZ1bmN0aW9uIHJldHVybnMgYHRydWVgIGlmIHRoZSBncmFwaCBoYXMgbm8KICogY3ljbGVzIGFuZCByZXR1cm5zIGBmYWxzZWAgaWYgaXQgZG9lcy4gVGhpcyBhbGdvcml0aG0gcmV0dXJucyBhcyBzb29uIGFzIGl0CiAqIGRldGVjdHMgdGhlIGZpcnN0IGN5Y2xlLgogKgogKiBVc2UgW2FsZy5maW5kQ3ljbGVzXVtdIGlmIHlvdSBuZWVkIHRoZSBhY3R1YWwgbGlzdCBvZiBjeWNsZXMgaW4gYSBncmFwaC4KICoKICogW2FsZy5maW5kQ3ljbGVzXTogZmluZEN5Y2xlcy5qcy5odG1sI2ZpbmRDeWNsZXMKICoKICogQHBhcmFtIHtEaWdyYXBofSBnIHRoZSBncmFwaCB0byB0ZXN0IGZvciBjeWNsZXMKICovCmZ1bmN0aW9uIGlzQWN5Y2xpYyhnKSB7CiAgdHJ5IHsKICAgIHRvcHNvcnQoZyk7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGUgaW5zdGFuY2VvZiB0b3Bzb3J0LkN5Y2xlRXhjZXB0aW9uKSByZXR1cm4gZmFsc2U7CiAgICB0aHJvdyBlOwogIH0KICByZXR1cm4gdHJ1ZTsKfQoKfSx7Ii4vdG9wc29ydCI6NDB9XSwzNjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IHBvc3RvcmRlcjsKCi8vIFBvc3RvcmRlciB0cmF2ZXJzYWwgb2YgZywgY2FsbGluZyBmIGZvciBlYWNoIHZpc2l0ZWQgbm9kZS4gQXNzdW1lcyB0aGUgZ3JhcGgKLy8gaXMgYSB0cmVlLgpmdW5jdGlvbiBwb3N0b3JkZXIoZywgcm9vdCwgZikgewogIHZhciB2aXNpdGVkID0gbmV3IFNldCgpOwogIGlmIChnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGZ1bmN0aW9uIG9ubHkgd29ya3MgZm9yIHVuZGlyZWN0ZWQgZ3JhcGhzIik7CiAgfQogIGZ1bmN0aW9uIGRmcyh1LCBwcmV2KSB7CiAgICBpZiAodmlzaXRlZC5oYXModSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgaW5wdXQgZ3JhcGggaXMgbm90IGEgdHJlZTogIiArIGcpOwogICAgfQogICAgdmlzaXRlZC5hZGQodSk7CiAgICBnLm5laWdoYm9ycyh1KS5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgaWYgKHYgIT09IHByZXYpIGRmcyh2LCB1KTsKICAgIH0pOwogICAgZih1KTsKICB9CiAgZGZzKHJvb3QpOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSwzNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgptb2R1bGUuZXhwb3J0cyA9IHByZW9yZGVyOwoKLy8gUHJlb3JkZXIgdHJhdmVyc2FsIG9mIGcsIGNhbGxpbmcgZiBmb3IgZWFjaCB2aXNpdGVkIG5vZGUuIEFzc3VtZXMgdGhlIGdyYXBoCi8vIGlzIGEgdHJlZS4KZnVuY3Rpb24gcHJlb3JkZXIoZywgcm9vdCwgZikgewogIHZhciB2aXNpdGVkID0gbmV3IFNldCgpOwogIGlmIChnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGZ1bmN0aW9uIG9ubHkgd29ya3MgZm9yIHVuZGlyZWN0ZWQgZ3JhcGhzIik7CiAgfQogIGZ1bmN0aW9uIGRmcyh1LCBwcmV2KSB7CiAgICBpZiAodmlzaXRlZC5oYXModSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgaW5wdXQgZ3JhcGggaXMgbm90IGEgdHJlZTogIiArIGcpOwogICAgfQogICAgdmlzaXRlZC5hZGQodSk7CiAgICBmKHUpOwogICAgZy5uZWlnaGJvcnModSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICh2ICE9PSBwcmV2KSBkZnModiwgdSk7CiAgICB9KTsKICB9CiAgZGZzKHJvb3QpOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSwzODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBHcmFwaCA9IHJlcXVpcmUoIi4uL0dyYXBoIiksCiAgICBQcmlvcml0eVF1ZXVlID0gcmVxdWlyZSgiY3AtZGF0YSIpLlByaW9yaXR5UXVldWU7Cgptb2R1bGUuZXhwb3J0cyA9IHByaW07CgovKioKICogW1ByaW0ncyBhbGdvcml0aG1dW10gdGFrZXMgYSBjb25uZWN0ZWQgdW5kaXJlY3RlZCBncmFwaCBhbmQgZ2VuZXJhdGVzIGEKICogW21pbmltdW0gc3Bhbm5pbmcgdHJlZV1bXS4gVGhpcyBmdW5jdGlvbiByZXR1cm5zIHRoZSBtaW5pbXVtIHNwYW5uaW5nCiAqIHRyZWUgYXMgYW4gdW5kaXJlY3RlZCBncmFwaC4gVGhpcyBhbGdvcml0aG0gaXMgZGVyaXZlZCBmcm9tIHRoZSBkZXNjcmlwdGlvbgogKiBpbiAiSW50cm9kdWN0aW9uIHRvIEFsZ29yaXRobXMiLCBUaGlyZCBFZGl0aW9uLCBDb3JtZW4sIGV0IGFsLiwgUGcgNjM0LgogKgogKiBUaGlzIGZ1bmN0aW9uIHRha2VzIGEgYHdlaWdodEZ1bmMoZSlgIHdoaWNoIHJldHVybnMgdGhlIHdlaWdodCBvZiB0aGUgZWRnZQogKiBgZWAuIEl0IHRocm93cyBhbiBFcnJvciBpZiB0aGUgZ3JhcGggaXMgbm90IGNvbm5lY3RlZC4KICoKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBgTyh8RXwgbG9nIHxWfClgIHRpbWUuCiAqCiAqIFtQcmltJ3MgYWxnb3JpdGhtXTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbSdzX2FsZ29yaXRobQogKiBbbWluaW11bSBzcGFubmluZyB0cmVlXTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTWluaW11bV9zcGFubmluZ190cmVlCiAqCiAqIEBwYXJhbSB7R3JhcGh9IGcgdGhlIGdyYXBoIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIG1pbmltdW0gc3Bhbm5pbmcgdHJlZQogKiBAcGFyYW0ge0Z1bmN0aW9ufSB3ZWlnaHRGdW5jIHRoZSB3ZWlnaHQgZnVuY3Rpb24gdG8gdXNlCiAqLwpmdW5jdGlvbiBwcmltKGcsIHdlaWdodEZ1bmMpIHsKICB2YXIgcmVzdWx0ID0gbmV3IEdyYXBoKCksCiAgICAgIHBhcmVudHMgPSB7fSwKICAgICAgcHEgPSBuZXcgUHJpb3JpdHlRdWV1ZSgpLAogICAgICB1OwoKICBmdW5jdGlvbiB1cGRhdGVOZWlnaGJvcnMoZSkgewogICAgdmFyIGluY2lkZW50Tm9kZXMgPSBnLmluY2lkZW50Tm9kZXMoZSksCiAgICAgICAgdiA9IGluY2lkZW50Tm9kZXNbMF0gIT09IHUgPyBpbmNpZGVudE5vZGVzWzBdIDogaW5jaWRlbnROb2Rlc1sxXSwKICAgICAgICBwcmkgPSBwcS5wcmlvcml0eSh2KTsKICAgIGlmIChwcmkgIT09IHVuZGVmaW5lZCkgewogICAgICB2YXIgZWRnZVdlaWdodCA9IHdlaWdodEZ1bmMoZSk7CiAgICAgIGlmIChlZGdlV2VpZ2h0IDwgcHJpKSB7CiAgICAgICAgcGFyZW50c1t2XSA9IHU7CiAgICAgICAgcHEuZGVjcmVhc2UodiwgZWRnZVdlaWdodCk7CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChnLm9yZGVyKCkgPT09IDApIHsKICAgIHJldHVybiByZXN1bHQ7CiAgfQoKICBnLmVhY2hOb2RlKGZ1bmN0aW9uKHUpIHsKICAgIHBxLmFkZCh1LCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpOwogICAgcmVzdWx0LmFkZE5vZGUodSk7CiAgfSk7CgogIC8vIFN0YXJ0IGZyb20gYW4gYXJiaXRyYXJ5IG5vZGUKICBwcS5kZWNyZWFzZShnLm5vZGVzKClbMF0sIDApOwoKICB2YXIgaW5pdCA9IGZhbHNlOwogIHdoaWxlIChwcS5zaXplKCkgPiAwKSB7CiAgICB1ID0gcHEucmVtb3ZlTWluKCk7CiAgICBpZiAodSBpbiBwYXJlbnRzKSB7CiAgICAgIHJlc3VsdC5hZGRFZGdlKG51bGwsIHUsIHBhcmVudHNbdV0pOwogICAgfSBlbHNlIGlmIChpbml0KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgZ3JhcGggaXMgbm90IGNvbm5lY3RlZDogIiArIGcpOwogICAgfSBlbHNlIHsKICAgICAgaW5pdCA9IHRydWU7CiAgICB9CgogICAgZy5pbmNpZGVudEVkZ2VzKHUpLmZvckVhY2godXBkYXRlTmVpZ2hib3JzKTsKICB9CgogIHJldHVybiByZXN1bHQ7Cn0KCn0seyIuLi9HcmFwaCI6MjksImNwLWRhdGEiOjE5fV0sMzk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewptb2R1bGUuZXhwb3J0cyA9IHRhcmphbjsKCi8qKgogKiBUaGlzIGZ1bmN0aW9uIGlzIGFuIGltcGxlbWVudGF0aW9uIG9mIFtUYXJqYW4ncyBhbGdvcml0aG1dW10gd2hpY2ggZmluZHMKICogYWxsIFtzdHJvbmdseSBjb25uZWN0ZWQgY29tcG9uZW50c11bXSBpbiB0aGUgZGlyZWN0ZWQgZ3JhcGggKipnKiouIEVhY2gKICogc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudCBpcyBjb21wb3NlZCBvZiBub2RlcyB0aGF0IGNhbiByZWFjaCBhbGwgb3RoZXIKICogbm9kZXMgaW4gdGhlIGNvbXBvbmVudCB2aWEgZGlyZWN0ZWQgZWRnZXMuIEEgc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudAogKiBjYW4gY29uc2lzdCBvZiBhIHNpbmdsZSBub2RlIGlmIHRoYXQgbm9kZSBjYW5ub3QgYm90aCByZWFjaCBhbmQgYmUgcmVhY2hlZAogKiBieSBhbnkgb3RoZXIgc3BlY2lmaWMgbm9kZSBpbiB0aGUgZ3JhcGguIENvbXBvbmVudHMgb2YgbW9yZSB0aGFuIG9uZSBub2RlCiAqIGFyZSBndWFyYW50ZWVkIHRvIGhhdmUgYXQgbGVhc3Qgb25lIGN5Y2xlLgogKgogKiBUaGlzIGZ1bmN0aW9uIHJldHVybnMgYW4gYXJyYXkgb2YgY29tcG9uZW50cy4gRWFjaCBjb21wb25lbnQgaXMgaXRzZWxmIGFuCiAqIGFycmF5IHRoYXQgY29udGFpbnMgdGhlIGlkcyBvZiBhbGwgbm9kZXMgaW4gdGhlIGNvbXBvbmVudC4KICoKICogW1RhcmphbidzIGFsZ29yaXRobV06IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVGFyamFuJ3Nfc3Ryb25nbHlfY29ubmVjdGVkX2NvbXBvbmVudHNfYWxnb3JpdGhtCiAqIFtzdHJvbmdseSBjb25uZWN0ZWQgY29tcG9uZW50c106IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU3Ryb25nbHlfY29ubmVjdGVkX2NvbXBvbmVudAogKgogKiBAcGFyYW0ge0RpZ3JhcGh9IGcgdGhlIGdyYXBoIHRvIHNlYXJjaCBmb3Igc3Ryb25nbHkgY29ubmVjdGVkIGNvbXBvbmVudHMKICovCmZ1bmN0aW9uIHRhcmphbihnKSB7CiAgaWYgKCFnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJ0YXJqYW4gY2FuIG9ubHkgYmUgYXBwbGllZCB0byBhIGRpcmVjdGVkIGdyYXBoLiBCYWQgaW5wdXQ6ICIgKyBnKTsKICB9CgogIHZhciBpbmRleCA9IDAsCiAgICAgIHN0YWNrID0gW10sCiAgICAgIHZpc2l0ZWQgPSB7fSwgLy8gbm9kZSBpZCAtPiB7IG9uU3RhY2ssIGxvd2xpbmssIGluZGV4IH0KICAgICAgcmVzdWx0cyA9IFtdOwoKICBmdW5jdGlvbiBkZnModSkgewogICAgdmFyIGVudHJ5ID0gdmlzaXRlZFt1XSA9IHsKICAgICAgb25TdGFjazogdHJ1ZSwKICAgICAgbG93bGluazogaW5kZXgsCiAgICAgIGluZGV4OiBpbmRleCsrCiAgICB9OwogICAgc3RhY2sucHVzaCh1KTsKCiAgICBnLnN1Y2Nlc3NvcnModSkuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIGlmICghKHYgaW4gdmlzaXRlZCkpIHsKICAgICAgICBkZnModik7CiAgICAgICAgZW50cnkubG93bGluayA9IE1hdGgubWluKGVudHJ5Lmxvd2xpbmssIHZpc2l0ZWRbdl0ubG93bGluayk7CiAgICAgIH0gZWxzZSBpZiAodmlzaXRlZFt2XS5vblN0YWNrKSB7CiAgICAgICAgZW50cnkubG93bGluayA9IE1hdGgubWluKGVudHJ5Lmxvd2xpbmssIHZpc2l0ZWRbdl0uaW5kZXgpOwogICAgICB9CiAgICB9KTsKCiAgICBpZiAoZW50cnkubG93bGluayA9PT0gZW50cnkuaW5kZXgpIHsKICAgICAgdmFyIGNtcHQgPSBbXSwKICAgICAgICAgIHY7CiAgICAgIGRvIHsKICAgICAgICB2ID0gc3RhY2sucG9wKCk7CiAgICAgICAgdmlzaXRlZFt2XS5vblN0YWNrID0gZmFsc2U7CiAgICAgICAgY21wdC5wdXNoKHYpOwogICAgICB9IHdoaWxlICh1ICE9PSB2KTsKICAgICAgcmVzdWx0cy5wdXNoKGNtcHQpOwogICAgfQogIH0KCiAgZy5ub2RlcygpLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgaWYgKCEodSBpbiB2aXNpdGVkKSkgewogICAgICBkZnModSk7CiAgICB9CiAgfSk7CgogIHJldHVybiByZXN1bHRzOwp9Cgp9LHt9XSw0MDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gdG9wc29ydDsKdG9wc29ydC5DeWNsZUV4Y2VwdGlvbiA9IEN5Y2xlRXhjZXB0aW9uOwoKLyoKICogR2l2ZW4gYSBncmFwaCAqKmcqKiwgdGhpcyBmdW5jdGlvbiByZXR1cm5zIGFuIG9yZGVyZWQgbGlzdCBvZiBub2RlcyBzdWNoCiAqIHRoYXQgZm9yIGVhY2ggZWRnZSBgdSAtPiB2YCwgYHVgIGFwcGVhcnMgYmVmb3JlIGB2YCBpbiB0aGUgbGlzdC4gSWYgdGhlCiAqIGdyYXBoIGhhcyBhIGN5Y2xlIGl0IGlzIGltcG9zc2libGUgdG8gZ2VuZXJhdGUgc3VjaCBhIGxpc3QgYW5kCiAqICoqQ3ljbGVFeGNlcHRpb24qKiBpcyB0aHJvd24uCiAqCiAqIFNlZSBbdG9wb2xvZ2ljYWwgc29ydGluZ10oaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVG9wb2xvZ2ljYWxfc29ydGluZykKICogZm9yIG1vcmUgZGV0YWlscyBhYm91dCBob3cgdGhpcyBhbGdvcml0aG0gd29ya3MuCiAqCiAqIEBwYXJhbSB7RGlncmFwaH0gZyB0aGUgZ3JhcGggdG8gc29ydAogKi8KZnVuY3Rpb24gdG9wc29ydChnKSB7CiAgaWYgKCFnLmlzRGlyZWN0ZWQoKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJ0b3Bzb3J0IGNhbiBvbmx5IGJlIGFwcGxpZWQgdG8gYSBkaXJlY3RlZCBncmFwaC4gQmFkIGlucHV0OiAiICsgZyk7CiAgfQoKICB2YXIgdmlzaXRlZCA9IHt9OwogIHZhciBzdGFjayA9IHt9OwogIHZhciByZXN1bHRzID0gW107CgogIGZ1bmN0aW9uIHZpc2l0KG5vZGUpIHsKICAgIGlmIChub2RlIGluIHN0YWNrKSB7CiAgICAgIHRocm93IG5ldyBDeWNsZUV4Y2VwdGlvbigpOwogICAgfQoKICAgIGlmICghKG5vZGUgaW4gdmlzaXRlZCkpIHsKICAgICAgc3RhY2tbbm9kZV0gPSB0cnVlOwogICAgICB2aXNpdGVkW25vZGVdID0gdHJ1ZTsKICAgICAgZy5wcmVkZWNlc3NvcnMobm9kZSkuZm9yRWFjaChmdW5jdGlvbihwcmVkKSB7CiAgICAgICAgdmlzaXQocHJlZCk7CiAgICAgIH0pOwogICAgICBkZWxldGUgc3RhY2tbbm9kZV07CiAgICAgIHJlc3VsdHMucHVzaChub2RlKTsKICAgIH0KICB9CgogIHZhciBzaW5rcyA9IGcuc2lua3MoKTsKICBpZiAoZy5vcmRlcigpICE9PSAwICYmIHNpbmtzLmxlbmd0aCA9PT0gMCkgewogICAgdGhyb3cgbmV3IEN5Y2xlRXhjZXB0aW9uKCk7CiAgfQoKICBnLnNpbmtzKCkuZm9yRWFjaChmdW5jdGlvbihzaW5rKSB7CiAgICB2aXNpdChzaW5rKTsKICB9KTsKCiAgcmV0dXJuIHJlc3VsdHM7Cn0KCmZ1bmN0aW9uIEN5Y2xlRXhjZXB0aW9uKCkge30KCkN5Y2xlRXhjZXB0aW9uLnByb3RvdHlwZS50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogIHJldHVybiAiR3JhcGggaGFzIGF0IGxlYXN0IG9uZSBjeWNsZSI7Cn07Cgp9LHt9XSw0MTpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8vIFRoaXMgZmlsZSBwcm92aWRlcyBhIGhlbHBlciBmdW5jdGlvbiB0aGF0IG1peGVzLWluIERvdCBiZWhhdmlvciB0byBhbgovLyBleGlzdGluZyBncmFwaCBwcm90b3R5cGUuCgovKiBqc2hpbnQgLVcwNzkgKi8KdmFyIFNldCA9IHJlcXVpcmUoImNwLWRhdGEiKS5TZXQ7Ci8qIGpzaGludCArVzA3OSAqLwoKbW9kdWxlLmV4cG9ydHMgPSBjb21wb3VuZGlmeTsKCi8vIEV4dGVuZHMgdGhlIGdpdmVuIFN1cGVyQ29uc3RydWN0b3Igd2l0aCB0aGUgYWJpbGl0eSBmb3Igbm9kZXMgdG8gY29udGFpbgovLyBvdGhlciBub2Rlcy4gQSBzcGVjaWFsIG5vZGUgaWQgYG51bGxgIGlzIHVzZWQgdG8gaW5kaWNhdGUgdGhlIHJvb3QgZ3JhcGguCmZ1bmN0aW9uIGNvbXBvdW5kaWZ5KFN1cGVyQ29uc3RydWN0b3IpIHsKICBmdW5jdGlvbiBDb25zdHJ1Y3RvcigpIHsKICAgIFN1cGVyQ29uc3RydWN0b3IuY2FsbCh0aGlzKTsKCiAgICAvLyBNYXAgb2Ygb2JqZWN0IGlkIC0+IHBhcmVudCBpZCAob3IgbnVsbCBmb3Igcm9vdCBncmFwaCkKICAgIHRoaXMuX3BhcmVudHMgPSB7fTsKCiAgICAvLyBNYXAgb2YgaWQgKG9yIG51bGwpIC0+IGNoaWxkcmVuIHNldAogICAgdGhpcy5fY2hpbGRyZW4gPSB7fTsKICAgIHRoaXMuX2NoaWxkcmVuW251bGxdID0gbmV3IFNldCgpOwogIH0KCiAgQ29uc3RydWN0b3IucHJvdG90eXBlID0gbmV3IFN1cGVyQ29uc3RydWN0b3IoKTsKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBDb25zdHJ1Y3RvcjsKCiAgQ29uc3RydWN0b3IucHJvdG90eXBlLnBhcmVudCA9IGZ1bmN0aW9uKHUsIHBhcmVudCkgewogICAgdGhpcy5fc3RyaWN0R2V0Tm9kZSh1KTsKCiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IDIpIHsKICAgICAgcmV0dXJuIHRoaXMuX3BhcmVudHNbdV07CiAgICB9CgogICAgaWYgKHUgPT09IHBhcmVudCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBtYWtlICIgKyB1ICsgIiBhIHBhcmVudCBvZiBpdHNlbGYiKTsKICAgIH0KICAgIGlmIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgdGhpcy5fc3RyaWN0R2V0Tm9kZShwYXJlbnQpOwogICAgfQoKICAgIHRoaXMuX2NoaWxkcmVuW3RoaXMuX3BhcmVudHNbdV1dLnJlbW92ZSh1KTsKICAgIHRoaXMuX3BhcmVudHNbdV0gPSBwYXJlbnQ7CiAgICB0aGlzLl9jaGlsZHJlbltwYXJlbnRdLmFkZCh1KTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY2hpbGRyZW4gPSBmdW5jdGlvbih1KSB7CiAgICBpZiAodSAhPT0gbnVsbCkgewogICAgICB0aGlzLl9zdHJpY3RHZXROb2RlKHUpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX2NoaWxkcmVuW3VdLmtleXMoKTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuYWRkTm9kZSA9IGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICB1ID0gU3VwZXJDb25zdHJ1Y3Rvci5wcm90b3R5cGUuYWRkTm9kZS5jYWxsKHRoaXMsIHUsIHZhbHVlKTsKICAgIHRoaXMuX3BhcmVudHNbdV0gPSBudWxsOwogICAgdGhpcy5fY2hpbGRyZW5bdV0gPSBuZXcgU2V0KCk7CiAgICB0aGlzLl9jaGlsZHJlbltudWxsXS5hZGQodSk7CiAgICByZXR1cm4gdTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuZGVsTm9kZSA9IGZ1bmN0aW9uKHUpIHsKICAgIC8vIFByb21vdGUgYWxsIGNoaWxkcmVuIHRvIHRoZSBwYXJlbnQgb2YgdGhlIHN1YmdyYXBoCiAgICB2YXIgcGFyZW50ID0gdGhpcy5wYXJlbnQodSk7CiAgICB0aGlzLl9jaGlsZHJlblt1XS5rZXlzKCkuZm9yRWFjaChmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLnBhcmVudChjaGlsZCwgcGFyZW50KTsKICAgIH0sIHRoaXMpOwoKICAgIHRoaXMuX2NoaWxkcmVuW3BhcmVudF0ucmVtb3ZlKHUpOwogICAgZGVsZXRlIHRoaXMuX3BhcmVudHNbdV07CiAgICBkZWxldGUgdGhpcy5fY2hpbGRyZW5bdV07CgogICAgcmV0dXJuIFN1cGVyQ29uc3RydWN0b3IucHJvdG90eXBlLmRlbE5vZGUuY2FsbCh0aGlzLCB1KTsKICB9OwoKICBDb25zdHJ1Y3Rvci5wcm90b3R5cGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvcHkgPSBTdXBlckNvbnN0cnVjdG9yLnByb3RvdHlwZS5jb3B5LmNhbGwodGhpcyk7CiAgICB0aGlzLm5vZGVzKCkuZm9yRWFjaChmdW5jdGlvbih1KSB7CiAgICAgIGNvcHkucGFyZW50KHUsIHRoaXMucGFyZW50KHUpKTsKICAgIH0sIHRoaXMpOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgQ29uc3RydWN0b3IucHJvdG90eXBlLmZpbHRlck5vZGVzID0gZnVuY3Rpb24oZmlsdGVyKSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgY29weSA9IFN1cGVyQ29uc3RydWN0b3IucHJvdG90eXBlLmZpbHRlck5vZGVzLmNhbGwodGhpcywgZmlsdGVyKTsKCiAgICB2YXIgcGFyZW50cyA9IHt9OwogICAgZnVuY3Rpb24gZmluZFBhcmVudCh1KSB7CiAgICAgIHZhciBwYXJlbnQgPSBzZWxmLnBhcmVudCh1KTsKICAgICAgaWYgKHBhcmVudCA9PT0gbnVsbCB8fCBjb3B5Lmhhc05vZGUocGFyZW50KSkgewogICAgICAgIHBhcmVudHNbdV0gPSBwYXJlbnQ7CiAgICAgICAgcmV0dXJuIHBhcmVudDsKICAgICAgfSBlbHNlIGlmIChwYXJlbnQgaW4gcGFyZW50cykgewogICAgICAgIHJldHVybiBwYXJlbnRzW3BhcmVudF07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZpbmRQYXJlbnQocGFyZW50KTsKICAgICAgfQogICAgfQoKICAgIGNvcHkuZWFjaE5vZGUoZnVuY3Rpb24odSkgeyBjb3B5LnBhcmVudCh1LCBmaW5kUGFyZW50KHUpKTsgfSk7CgogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgcmV0dXJuIENvbnN0cnVjdG9yOwp9Cgp9LHsiY3AtZGF0YSI6MTl9XSw0MjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CnZhciBHcmFwaCA9IHJlcXVpcmUoIi4uL0dyYXBoIiksCiAgICBEaWdyYXBoID0gcmVxdWlyZSgiLi4vRGlncmFwaCIpLAogICAgQ0dyYXBoID0gcmVxdWlyZSgiLi4vQ0dyYXBoIiksCiAgICBDRGlncmFwaCA9IHJlcXVpcmUoIi4uL0NEaWdyYXBoIik7CgpleHBvcnRzLmRlY29kZSA9IGZ1bmN0aW9uKG5vZGVzLCBlZGdlcywgQ3RvcikgewogIEN0b3IgPSBDdG9yIHx8IERpZ3JhcGg7CgogIGlmICh0eXBlT2Yobm9kZXMpICE9PSAiQXJyYXkiKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vZGVzIGlzIG5vdCBhbiBBcnJheSIpOwogIH0KCiAgaWYgKHR5cGVPZihlZGdlcykgIT09ICJBcnJheSIpIHsKICAgIHRocm93IG5ldyBFcnJvcigiZWRnZXMgaXMgbm90IGFuIEFycmF5Iik7CiAgfQoKICBpZiAodHlwZW9mIEN0b3IgPT09ICJzdHJpbmciKSB7CiAgICBzd2l0Y2goQ3RvcikgewogICAgICBjYXNlICJncmFwaCI6IEN0b3IgPSBHcmFwaDsgYnJlYWs7CiAgICAgIGNhc2UgImRpZ3JhcGgiOiBDdG9yID0gRGlncmFwaDsgYnJlYWs7CiAgICAgIGNhc2UgImNncmFwaCI6IEN0b3IgPSBDR3JhcGg7IGJyZWFrOwogICAgICBjYXNlICJjZGlncmFwaCI6IEN0b3IgPSBDRGlncmFwaDsgYnJlYWs7CiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIGdyYXBoIHR5cGU6ICIgKyBDdG9yKTsKICAgIH0KICB9CgogIHZhciBncmFwaCA9IG5ldyBDdG9yKCk7CgogIG5vZGVzLmZvckVhY2goZnVuY3Rpb24odSkgewogICAgZ3JhcGguYWRkTm9kZSh1LmlkLCB1LnZhbHVlKTsKICB9KTsKCiAgLy8gSWYgdGhlIGdyYXBoIGlzIGNvbXBvdW5kLCBzZXQgdXAgY2hpbGRyZW4uLi4KICBpZiAoZ3JhcGgucGFyZW50KSB7CiAgICBub2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKHUpIHsKICAgICAgaWYgKHUuY2hpbGRyZW4pIHsKICAgICAgICB1LmNoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24odikgewogICAgICAgICAgZ3JhcGgucGFyZW50KHYsIHUuaWQpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CgogIGVkZ2VzLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgZ3JhcGguYWRkRWRnZShlLmlkLCBlLnUsIGUudiwgZS52YWx1ZSk7CiAgfSk7CgogIHJldHVybiBncmFwaDsKfTsKCmV4cG9ydHMuZW5jb2RlID0gZnVuY3Rpb24oZ3JhcGgpIHsKICB2YXIgbm9kZXMgPSBbXTsKICB2YXIgZWRnZXMgPSBbXTsKCiAgZ3JhcGguZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsKICAgIHZhciBub2RlID0ge2lkOiB1LCB2YWx1ZTogdmFsdWV9OwogICAgaWYgKGdyYXBoLmNoaWxkcmVuKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGdyYXBoLmNoaWxkcmVuKHUpOwogICAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgbm9kZS5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICB9CiAgICB9CiAgICBub2Rlcy5wdXNoKG5vZGUpOwogIH0pOwoKICBncmFwaC5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgZWRnZXMucHVzaCh7aWQ6IGUsIHU6IHUsIHY6IHYsIHZhbHVlOiB2YWx1ZX0pOwogIH0pOwoKICB2YXIgdHlwZTsKICBpZiAoZ3JhcGggaW5zdGFuY2VvZiBDRGlncmFwaCkgewogICAgdHlwZSA9ICJjZGlncmFwaCI7CiAgfSBlbHNlIGlmIChncmFwaCBpbnN0YW5jZW9mIENHcmFwaCkgewogICAgdHlwZSA9ICJjZ3JhcGgiOwogIH0gZWxzZSBpZiAoZ3JhcGggaW5zdGFuY2VvZiBEaWdyYXBoKSB7CiAgICB0eXBlID0gImRpZ3JhcGgiOwogIH0gZWxzZSBpZiAoZ3JhcGggaW5zdGFuY2VvZiBHcmFwaCkgewogICAgdHlwZSA9ICJncmFwaCI7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGRuJ3QgZGV0ZXJtaW5lIHR5cGUgb2YgZ3JhcGg6ICIgKyBncmFwaCk7CiAgfQoKICByZXR1cm4geyBub2Rlczogbm9kZXMsIGVkZ2VzOiBlZGdlcywgdHlwZTogdHlwZSB9Owp9OwoKZnVuY3Rpb24gdHlwZU9mKG9iaikgewogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKS5zbGljZSg4LCAtMSk7Cn0KCn0seyIuLi9DRGlncmFwaCI6MjYsIi4uL0NHcmFwaCI6MjcsIi4uL0RpZ3JhcGgiOjI4LCIuLi9HcmFwaCI6Mjl9XSw0MzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Ci8qIGpzaGludCAtVzA3OSAqLwp2YXIgU2V0ID0gcmVxdWlyZSgiY3AtZGF0YSIpLlNldDsKLyoganNoaW50ICtXMDc5ICovCgpleHBvcnRzLmFsbCA9IGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbigpIHsgcmV0dXJuIHRydWU7IH07Cn07CgpleHBvcnRzLm5vZGVzRnJvbUxpc3QgPSBmdW5jdGlvbihub2RlcykgewogIHZhciBzZXQgPSBuZXcgU2V0KG5vZGVzKTsKICByZXR1cm4gZnVuY3Rpb24odSkgewogICAgcmV0dXJuIHNldC5oYXModSk7CiAgfTsKfTsKCn0seyJjcC1kYXRhIjoxOX1dLDQ0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKdmFyIEdyYXBoID0gcmVxdWlyZSgiLi9HcmFwaCIpLAogICAgRGlncmFwaCA9IHJlcXVpcmUoIi4vRGlncmFwaCIpOwoKLy8gU2lkZS1lZmZlY3QgYmFzZWQgY2hhbmdlcyBhcmUgbG91c3ksIGJ1dCBub2RlIGRvZXNuJ3Qgc2VlbSB0byByZXNvbHZlIHRoZQovLyByZXF1aXJlcyBjeWNsZS4KCi8qKgogKiBSZXR1cm5zIGEgbmV3IGRpcmVjdGVkIGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgZnJvbSB0aGlzIGdyYXBoLiBUaGUKICogbmV3IGdyYXBoIHdpbGwgaGF2ZSB0aGUgc2FtZSBub2RlcywgYnV0IHdpbGwgaGF2ZSB0d2ljZSB0aGUgbnVtYmVyIG9mIGVkZ2VzOgogKiBlYWNoIGVkZ2UgaXMgc3BsaXQgaW50byB0d28gZWRnZXMgd2l0aCBvcHBvc2l0ZSBkaXJlY3Rpb25zLiBFZGdlIGlkcywKICogY29uc2VxdWVudGx5LCBhcmUgbm90IHByZXNlcnZlZCBieSB0aGlzIHRyYW5zZm9ybWF0aW9uLgogKi8KR3JhcGgucHJvdG90eXBlLnRvRGlncmFwaCA9CkdyYXBoLnByb3RvdHlwZS5hc0RpcmVjdGVkID0gZnVuY3Rpb24oKSB7CiAgdmFyIGcgPSBuZXcgRGlncmFwaCgpOwogIHRoaXMuZWFjaE5vZGUoZnVuY3Rpb24odSwgdmFsdWUpIHsgZy5hZGROb2RlKHUsIHZhbHVlKTsgfSk7CiAgdGhpcy5lYWNoRWRnZShmdW5jdGlvbihlLCB1LCB2LCB2YWx1ZSkgewogICAgZy5hZGRFZGdlKG51bGwsIHUsIHYsIHZhbHVlKTsKICAgIGcuYWRkRWRnZShudWxsLCB2LCB1LCB2YWx1ZSk7CiAgfSk7CiAgcmV0dXJuIGc7Cn07CgovKioKICogUmV0dXJucyBhIG5ldyB1bmRpcmVjdGVkIGdyYXBoIHVzaW5nIHRoZSBub2RlcyBhbmQgZWRnZXMgZnJvbSB0aGlzIGdyYXBoLgogKiBUaGUgbmV3IGdyYXBoIHdpbGwgaGF2ZSB0aGUgc2FtZSBub2RlcywgYnV0IHRoZSBlZGdlcyB3aWxsIGJlIG1hZGUKICogdW5kaXJlY3RlZC4gRWRnZSBpZHMgYXJlIHByZXNlcnZlZCBpbiB0aGlzIHRyYW5zZm9ybWF0aW9uLgogKi8KRGlncmFwaC5wcm90b3R5cGUudG9HcmFwaCA9CkRpZ3JhcGgucHJvdG90eXBlLmFzVW5kaXJlY3RlZCA9IGZ1bmN0aW9uKCkgewogIHZhciBnID0gbmV3IEdyYXBoKCk7CiAgdGhpcy5lYWNoTm9kZShmdW5jdGlvbih1LCB2YWx1ZSkgeyBnLmFkZE5vZGUodSwgdmFsdWUpOyB9KTsKICB0aGlzLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICBnLmFkZEVkZ2UoZSwgdSwgdiwgdmFsdWUpOwogIH0pOwogIHJldHVybiBnOwp9OwoKfSx7Ii4vRGlncmFwaCI6MjgsIi4vR3JhcGgiOjI5fV0sNDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewovLyBSZXR1cm5zIGFuIGFycmF5IG9mIGFsbCB2YWx1ZXMgZm9yIHByb3BlcnRpZXMgb2YgKipvKiouCmV4cG9ydHMudmFsdWVzID0gZnVuY3Rpb24obykgewogIHZhciBrcyA9IE9iamVjdC5rZXlzKG8pLAogICAgICBsZW4gPSBrcy5sZW5ndGgsCiAgICAgIHJlc3VsdCA9IG5ldyBBcnJheShsZW4pLAogICAgICBpOwogIGZvciAoaSA9IDA7IGkgPCBsZW47ICsraSkgewogICAgcmVzdWx0W2ldID0gb1trc1tpXV07CiAgfQogIHJldHVybiByZXN1bHQ7Cn07Cgp9LHt9XSw0NjpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7Cm1vZHVsZS5leHBvcnRzID0gJzAuNy40JzsKCn0se31dfSx7fSxbMV0pCjsKam9pbnQubGF5b3V0LkRpcmVjdGVkR3JhcGggPSB7CgogICAgbGF5b3V0OiBmdW5jdGlvbihncmFwaCwgb3B0KSB7CgogICAgICAgIG9wdCA9IG9wdCB8fCB7fTsKCiAgICAgICAgdmFyIGlucHV0R3JhcGggPSB0aGlzLl9wcmVwYXJlRGF0YShncmFwaCk7CiAgICAgICAgdmFyIHJ1bm5lciA9IGRhZ3JlLmxheW91dCgpOwoKICAgICAgICBpZiAob3B0LmRlYnVnTGV2ZWwpIHsgcnVubmVyLmRlYnVnTGV2ZWwob3B0LmRlYnVnTGV2ZWwpOyB9CiAgICAgICAgaWYgKG9wdC5yYW5rRGlyKSB7IHJ1bm5lci5yYW5rRGlyKG9wdC5yYW5rRGlyKTsgfQogICAgICAgIGlmIChvcHQucmFua1NlcCkgeyBydW5uZXIucmFua1NlcChvcHQucmFua1NlcCk7IH0KICAgICAgICBpZiAob3B0LmVkZ2VTZXApIHsgcnVubmVyLmVkZ2VTZXAob3B0LmVkZ2VTZXApOyB9CiAgICAgICAgaWYgKG9wdC5ub2RlU2VwKSB7IHJ1bm5lci5ub2RlU2VwKG9wdC5ub2RlU2VwKTsgfQoKICAgICAgICB2YXIgbGF5b3V0R3JhcGggPSBydW5uZXIucnVuKGlucHV0R3JhcGgpOwogICAgICAgIAogICAgICAgIGxheW91dEdyYXBoLmVhY2hOb2RlKGZ1bmN0aW9uKHUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICghdmFsdWUuZHVtbXkpIHsKCgkJdmFyIGNlbGwgPSBncmFwaC5nZXRDZWxsKHUpOwoJCW9wdC5zZXRQb3NpdGlvbiAKCQkgICAgPyBvcHQuc2V0UG9zaXRpb24oY2VsbCwgdmFsdWUpCgkJICAgIDogZ3JhcGguZ2V0KCdjZWxscycpLmdldCh1KS5zZXQoJ3Bvc2l0aW9uJywgewoJCQl4OiB2YWx1ZS54IC0gdmFsdWUud2lkdGgvMiwKCQkJeTogdmFsdWUueSAtIHZhbHVlLmhlaWdodC8yCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKCiAgICAgICAgaWYgKG9wdC5zZXRMaW5rVmVydGljZXMpIHsKCiAgICAgICAgICAgIGxheW91dEdyYXBoLmVhY2hFZGdlKGZ1bmN0aW9uKGUsIHUsIHYsIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgbGluayA9IGdyYXBoLmdldENlbGwoZSk7CiAgICAgICAgICAgICAgICBpZiAobGluaykgewoJCSAgICBvcHQuc2V0VmVydGljZXMKCQkJPyBvcHQuc2V0VmVydGljZXMobGluaywgdmFsdWUucG9pbnRzKQoJCQk6IGxpbmsuc2V0KCd2ZXJ0aWNlcycsIHZhbHVlLnBvaW50cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgd2lkdGg6IGxheW91dEdyYXBoLmdyYXBoKCkud2lkdGgsIGhlaWdodDogbGF5b3V0R3JhcGguZ3JhcGgoKS5oZWlnaHQgfTsKICAgIH0sCiAgICAKICAgIF9wcmVwYXJlRGF0YTogZnVuY3Rpb24oZ3JhcGgpIHsKCiAgICAgICAgdmFyIGRhZ3JlR3JhcGggPSBuZXcgZGFncmUuRGlncmFwaCgpOwoKICAgICAgICAvLyBGb3IgZWFjaCBlbGVtZW50LgogICAgICAgIF8uZWFjaChncmFwaC5nZXRFbGVtZW50cygpLCBmdW5jdGlvbihjZWxsKSB7CgogICAgICAgICAgICBpZiAoZGFncmVHcmFwaC5oYXNOb2RlKGNlbGwuaWQpKSByZXR1cm47CgogICAgICAgICAgICBkYWdyZUdyYXBoLmFkZE5vZGUoY2VsbC5pZCwgewogICAgICAgICAgICAgICAgd2lkdGg6IGNlbGwuZ2V0KCdzaXplJykud2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGNlbGwuZ2V0KCdzaXplJykuaGVpZ2h0LAogICAgICAgICAgICAgICAgcmFuazogY2VsbC5nZXQoJ3JhbmsnKQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gRm9yIGVhY2ggbGluay4KICAgICAgICBfLmVhY2goZ3JhcGguZ2V0TGlua3MoKSwgZnVuY3Rpb24oY2VsbCkgewoKICAgICAgICAgICAgaWYgKGRhZ3JlR3JhcGguaGFzRWRnZShjZWxsLmlkKSkgcmV0dXJuOwoKICAgICAgICAgICAgdmFyIHNvdXJjZUlkID0gY2VsbC5nZXQoJ3NvdXJjZScpLmlkOwogICAgICAgICAgICB2YXIgdGFyZ2V0SWQgPSBjZWxsLmdldCgndGFyZ2V0JykuaWQ7CgogICAgICAgICAgICBkYWdyZUdyYXBoLmFkZEVkZ2UoY2VsbC5pZCwgc291cmNlSWQsIHRhcmdldElkLCB7IG1pbkxlbjogY2VsbC5nZXQoJ21pbkxlbicpIHx8IDEgfSk7CiAgICAgICAgfSk7CgogICAgICAgIHJldHVybiBkYWdyZUdyYXBoOwogICAgfQp9Owo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 05:41:43 GMT",
                    "Content-Length": "926573",
                    "Date": "Fri, 07 Nov 2014 05:41:44 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}