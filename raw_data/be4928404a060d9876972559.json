{
    "url": "http://localhost:9999/allmobilize/amazeui/js/ui.add2home.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>document.location.href</b> and written to <b>history.replaceState()</b> via the following statement:<ul><li>history.replaceState('', window.document.title, document.location.href.replace(/(\\/)?$/, '/ath$1'));</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/allmobilize/amazeui/js/ui.add2home.js",
                "path": "/allmobilize/amazeui/js/ui.add2home.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hbGxtb2JpbGl6ZS9hbWF6ZXVpL2pzL3VpLmFkZDJob21lLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTkyODQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMDY6NTU6MTEgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjU1OjA5IEdNVA0KDQondXNlIHN0cmljdCc7Cgp2YXIgJCA9IHJlcXVpcmUoJ2pxdWVyeScpOwpyZXF1aXJlKCcuL2NvcmUnKTsKCi8qIGpzaGludCAtVzEwMSwgLVcxMDYgKi8KLyogQWRkIHRvIEhvbWVzY3JlZW4gdjMuMC44IH4gKGMpIDIwMTQgTWF0dGVvIFNwaW5lbGxpIH4gQGxpY2Vuc2U6IGh0dHA6Ly9jdWJpcS5vcmcvbGljZW5zZSAqLwoKLy8gQ2hlY2sgaWYgZG9jdW1lbnQgaXMgbG9hZGVkLCBuZWVkZWQgYnkgYXV0b3N0YXJ0CnZhciBfRE9NUmVhZHkgPSBmYWxzZTsKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICBfRE9NUmVhZHkgPSB0cnVlOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgbG9hZGVkLCBmYWxzZSk7Cn0KCmZ1bmN0aW9uIGxvYWRlZCgpIHsKICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9hZCcsIGxvYWRlZCwgZmFsc2UpOwogIF9ET01SZWFkeSA9IHRydWU7Cn0KCi8vIHJlZ2V4IHVzZWQgdG8gZGV0ZWN0IGlmIGFwcCBoYXMgYmVlbiBhZGRlZCB0byB0aGUgaG9tZXNjcmVlbgp2YXIgX3JlU21hcnRVUkwgPSAvXC9hdGgoXC8pPyQvOwp2YXIgX3JlUXVlcnlTdHJpbmcgPSAvKFtcPyZdYXRoPVteJl0qJHwmYXRoPVteJl0qKCYpKS87CgovLyBzaW5nbGV0b24KdmFyIF9pbnN0YW5jZTsKCmZ1bmN0aW9uIGF0aChvcHRpb25zKSB7CiAgX2luc3RhbmNlID0gX2luc3RhbmNlIHx8IG5ldyBhdGguQ2xhc3Mob3B0aW9ucyk7CgogIHJldHVybiBfaW5zdGFuY2U7Cn0KCi8vIG1lc3NhZ2UgaW4gYWxsIHN1cHBvcnRlZCBsYW5ndWFnZXMKYXRoLmludGwgPSB7CiAgZW5fdXM6IHsKICAgIG1lc3NhZ2U6ICdUbyBhZGQgdGhpcyB3ZWIgYXBwIHRvIHRoZSBob21lIHNjcmVlbjogdGFwICVpY29uIGFuZCB0aGVuIDxzdHJvbmc+JWFjdGlvbjwvc3Ryb25nPi4nLAogICAgYWN0aW9uOiB7CiAgICAgIGlvczogJ0FkZCB0byBIb21lIFNjcmVlbicsCiAgICAgIGFuZHJvaWQ6ICdBZGQgdG8gaG9tZXNjcmVlbicsCiAgICAgIHdpbmRvd3M6ICdwaW4gdG8gc3RhcnQnCiAgICB9CiAgfSwKCiAgemhfY246IHsKICAgIG1lc3NhZ2U6ICflpoLopoHmiorlupTnlKjnqIvlvI/liqDoh7PkuLvlsY/luZUs6K+354K55Ye7JWljb24sIOeEtuWQjjxzdHJvbmc+JWFjdGlvbjwvc3Ryb25nPicsCiAgICBhY3Rpb246IHtpb3M6ICfliqDoh7PkuLvlsY/luZUnLCBhbmRyb2lkOiAn5Yqg6Iez5Li75bGP5bmVJywgd2luZG93czogJ+aMieS9j+WQr+WKqCd9CiAgfSwKCiAgemhfdHc6IHsKICAgIG1lc3NhZ2U6ICflpoLopoHmiormh4nnlKjnqIvlvI/liqDoh7PkuLvlsY/luZUsIOiri+m7nuaTiiVpY29uLCDnhLblvow8c3Ryb25nPiVhY3Rpb248L3N0cm9uZz4uJywKICAgIGFjdGlvbjoge2lvczogJ+WKoOiHs+S4u+Wxj+W5lScsIGFuZHJvaWQ6ICfliqDoh7PkuLvlsY/luZUnLCB3aW5kb3dzOiAn5oyJ5L2P5ZWf5YuVJ30KICB9Cn07CgovLyBBZGQgMiBjaGFyYWN0ZXJzIGxhbmd1YWdlIHN1cHBvcnQgKEFuZHJvaWQgbW9zdGx5KQpmb3IgKHZhciBsYW5nIGluIGF0aC5pbnRsKSB7CiAgYXRoLmludGxbbGFuZy5zdWJzdHIoMCwgMildID0gYXRoLmludGxbbGFuZ107Cn0KCi8vIGRlZmF1bHQgb3B0aW9ucwphdGguZGVmYXVsdHMgPSB7CiAgYXBwSUQ6ICdvcmcuY3ViaXEuYWRkdG9ob21lJywJCS8vIGxvY2FsIHN0b3JhZ2UgbmFtZSAobm8gbmVlZCB0byBjaGFuZ2UpCiAgZm9udFNpemU6IDE1LAkJCQkvLyBiYXNlIGZvbnQgc2l6ZSwgdXNlZCB0byBwcm9wZXJseSByZXNpemUgdGhlIHBvcHVwIGJhc2VkIG9uIHZpZXdwb3J0IHNjYWxlIGZhY3RvcgogIGRlYnVnOiBmYWxzZSwJCQkJLy8gb3ZlcnJpZGUgYnJvd3NlciBjaGVja3MKICBtb2RhbDogZmFsc2UsCQkJCS8vIHByZXZlbnQgZnVydGhlciBhY3Rpb25zIHVudGlsIHRoZSBtZXNzYWdlIGlzIGNsb3NlZAogIG1hbmRhdG9yeTogZmFsc2UsCQkJLy8geW91IGNhbid0IHByb2NlZWQgaWYgeW91IGRvbid0IGFkZCB0aGUgYXBwIHRvIHRoZSBob21lc2NyZWVuCiAgYXV0b3N0YXJ0OiB0cnVlLAkJCS8vIHNob3cgdGhlIG1lc3NhZ2UgYXV0b21hdGljYWxseQogIHNraXBGaXJzdFZpc2l0OiBmYWxzZSwJCS8vIHNob3cgb25seSB0byByZXR1cm5pbmcgdmlzaXRvcnMgKGllOiBza2lwIHRoZSBmaXJzdCB0aW1lIHlvdSB2aXNpdCkKICBzdGFydERlbGF5OiAxLAkJCQkvLyBkaXNwbGF5IHRoZSBtZXNzYWdlIGFmdGVyIHRoYXQgbWFueSBzZWNvbmRzIGZyb20gcGFnZSBsb2FkCiAgbGlmZXNwYW46IDE1LAkJCQkvLyBsaWZlIG9mIHRoZSBtZXNzYWdlIGluIHNlY29uZHMKICBkaXNwbGF5UGFjZTogMTQ0MCwJCQkvLyBtaW51dGVzIGJlZm9yZSB0aGUgbWVzc2FnZSBpcyBzaG93biBhZ2FpbiAoMDogZGlzcGxheSBldmVyeSB0aW1lLCBkZWZhdWx0IDI0IGhvdXJzKQogIG1heERpc3BsYXlDb3VudDogMCwJCQkvLyBhYnNvbHV0ZSBtYXhpbXVtIG51bWJlciBvZiB0aW1lcyB0aGUgbWVzc2FnZSB3aWxsIGJlIHNob3duIHRvIHRoZSB1c2VyICgwOiBubyBsaW1pdCkKICBpY29uOiB0cnVlLAkJCQkJLy8gYWRkIHRvdWNoIGljb24gdG8gdGhlIG1lc3NhZ2UKICBtZXNzYWdlOiAnJywJCQkJLy8gdGhlIG1lc3NhZ2UgY2FuIGJlIGN1c3RvbWl6ZWQKICB2YWxpZExvY2F0aW9uOiBbXSwJCQkvLyBsaXN0IG9mIHBhZ2VzIHdoZXJlIHRoZSBtZXNzYWdlIHdpbGwgYmUgc2hvd24gKGFycmF5IG9mIHJlZ2V4ZXMpCiAgb25Jbml0OiBudWxsLAkJCQkvLyBleGVjdXRlZCBvbiBpbnN0YW5jZSBjcmVhdGlvbgogIG9uU2hvdzogbnVsbCwJCQkJLy8gZXhlY3V0ZWQgd2hlbiB0aGUgbWVzc2FnZSBpcyBzaG93bgogIG9uUmVtb3ZlOiBudWxsLAkJCQkvLyBleGVjdXRlZCB3aGVuIHRoZSBtZXNzYWdlIGlzIHJlbW92ZWQKICBvbkFkZDogbnVsbCwJCQkJLy8gd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgbGF1bmNoZWQgdGhlIGZpcnN0IHRpbWUgZnJvbSB0aGUgaG9tZXNjcmVlbiAoZ3Vlc3N0aW1hdGUpCiAgb25Qcml2YXRlOiBudWxsLAkJCS8vIGV4ZWN1dGVkIGlmIHVzZXIgaXMgaW4gcHJpdmF0ZSBtb2RlCiAgZGV0ZWN0SG9tZXNjcmVlbjogZmFsc2UJCS8vIHRyeSB0byBkZXRlY3QgaWYgdGhlIHNpdGUgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGhvbWVzY3JlZW4gKGZhbHNlIHwgdHJ1ZSB8ICdoYXNoJyB8ICdxdWVyeVN0cmluZycgfCAnc21hcnRVUkwnKQp9OwoKLy8gYnJvd3NlciBpbmZvIGFuZCBjYXBhYmlsaXR5CnZhciBfdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCnZhciBfbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKX2V4dGVuZChhdGgsIHsKICBoYXNUb2tlbjogZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9PSAnI2F0aCcgfHwgX3JlU21hcnRVUkwudGVzdChkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSB8fCBfcmVRdWVyeVN0cmluZy50ZXN0KGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaCksCiAgaXNSZXRpbmE6IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvICYmIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvID4gMSwKICBpc0lEZXZpY2U6ICgvaXBob25lfGlwb2R8aXBhZC9pKS50ZXN0KF91YSksCiAgaXNNb2JpbGVDaHJvbWU6IF91YS5pbmRleE9mKCdBbmRyb2lkJykgPiAtMSAmJiAoL0Nocm9tZVwvWy4wLTldKi8pLnRlc3QoX3VhKSwKICBpc01vYmlsZUlFOiBfdWEuaW5kZXhPZignV2luZG93cyBQaG9uZScpID4gLTEsCiAgbGFuZ3VhZ2U6IF9uYXYubGFuZ3VhZ2UgJiYgX25hdi5sYW5ndWFnZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJy0nLCAnXycpIHx8ICcnCn0pOwoKLy8gZmFsbHMgYmFjayB0byBlbl91cyBpZiBsYW5ndWFnZSBpcyB1bnN1cHBvcnRlZAphdGgubGFuZ3VhZ2UgPSBhdGgubGFuZ3VhZ2UgJiYgYXRoLmxhbmd1YWdlIGluIGF0aC5pbnRsID8gYXRoLmxhbmd1YWdlIDogJ2VuX3VzJzsKCmF0aC5pc01vYmlsZVNhZmFyaSA9IGF0aC5pc0lEZXZpY2UgJiYgX3VhLmluZGV4T2YoJ1NhZmFyaScpID4gLTEgJiYgX3VhLmluZGV4T2YoJ0NyaU9TJykgPCAwOwphdGguT1MgPSBhdGguaXNJRGV2aWNlID8gJ2lvcycgOiBhdGguaXNNb2JpbGVDaHJvbWUgPyAnYW5kcm9pZCcgOiBhdGguaXNNb2JpbGVJRSA/ICd3aW5kb3dzJyA6ICd1bnN1cHBvcnRlZCc7CgphdGguT1NWZXJzaW9uID0gX3VhLm1hdGNoKC8oT1N8QW5kcm9pZCkgKFxkK1tfXC5dXGQrKS8pOwphdGguT1NWZXJzaW9uID0gYXRoLk9TVmVyc2lvbiAmJiBhdGguT1NWZXJzaW9uWzJdID8gK2F0aC5PU1ZlcnNpb25bMl0ucmVwbGFjZSgnXycsICcuJykgOiAwOwoKYXRoLmlzU3RhbmRhbG9uZSA9IHdpbmRvdy5uYXZpZ2F0b3Iuc3RhbmRhbG9uZSB8fCAoIGF0aC5pc01vYmlsZUNocm9tZSAmJiAoIHNjcmVlbi5oZWlnaHQgLSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0IDwgNDAgKSApOwkvLyBUT0RPOiBjaGVjayB0aGUgbGFtZSBwb2x5ZmlsbAphdGguaXNUYWJsZXQgPSAoYXRoLmlzTW9iaWxlU2FmYXJpICYmIF91YS5pbmRleE9mKCdpUGFkJykgPiAtMSkgfHwgKGF0aC5pc01vYmlsZUNocm9tZSAmJiBfdWEuaW5kZXhPZignTW9iaWxlJykgPCAwKTsKCmF0aC5pc0NvbXBhdGlibGUgPSAoYXRoLmlzTW9iaWxlU2FmYXJpICYmIGF0aC5PU1ZlcnNpb24gPj0gNikgfHwgYXRoLmlzTW9iaWxlQ2hyb21lOwkvLyBUT0RPOiBhZGQgd2lucGhvbmUKCnZhciBfZGVmYXVsdFNlc3Npb24gPSB7CiAgbGFzdERpc3BsYXlUaW1lOiAwLAkJCS8vIGxhc3QgdGltZSB3ZSBkaXNwbGF5ZWQgdGhlIG1lc3NhZ2UKICByZXR1cm5pbmdWaXNpdG9yOiBmYWxzZSwJLy8gaXMgdGhpcyB0aGUgZmlyc3QgdGltZSB5b3UgdmlzaXQKICBkaXNwbGF5Q291bnQ6IDAsCQkJLy8gbnVtYmVyIG9mIHRpbWVzIHRoZSBtZXNzYWdlIGhhcyBiZWVuIHNob3duCiAgb3B0ZWRvdXQ6IGZhbHNlLAkJCS8vIGhhcyB0aGUgdXNlciBvcHRlZCBvdXQKICBhZGRlZDogZmFsc2UJCQkJLy8gaGFzIGJlZW4gYWN0dWFsbHkgYWRkZWQgdG8gdGhlIGhvbWVzY3JlZW4KfTsKCmF0aC5yZW1vdmVTZXNzaW9uID0gZnVuY3Rpb24oYXBwSUQpIHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oYXBwSUQgfHwgYXRoLmRlZmF1bHRzLmFwcElEKTsKICB9IGNhdGNoIChlKSB7CiAgICAvLyB3ZSBhcmUgbW9zdCBsaWtlbHkgaW4gcHJpdmF0ZSBtb2RlCiAgfQp9OwoKYXRoLkNsYXNzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIC8vIG1lcmdlIGRlZmF1bHQgb3B0aW9ucyB3aXRoIHVzZXIgY29uZmlnCiAgdGhpcy5vcHRpb25zID0gX2V4dGVuZCh7fSwgYXRoLmRlZmF1bHRzKTsKICBfZXh0ZW5kKHRoaXMub3B0aW9ucywgb3B0aW9ucyk7CgogIC8vIG5vcm1hbGl6ZSBzb21lIG9wdGlvbnMKICB0aGlzLm9wdGlvbnMubWFuZGF0b3J5ID0gdGhpcy5vcHRpb25zLm1hbmRhdG9yeSAmJiAoICdzdGFuZGFsb25lJyBpbiB3aW5kb3cubmF2aWdhdG9yIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyApOwogIHRoaXMub3B0aW9ucy5tb2RhbCA9IHRoaXMub3B0aW9ucy5tb2RhbCB8fCB0aGlzLm9wdGlvbnMubWFuZGF0b3J5OwogIGlmICh0aGlzLm9wdGlvbnMubWFuZGF0b3J5KSB7CiAgICB0aGlzLm9wdGlvbnMuc3RhcnREZWxheSA9IC0wLjU7CQkvLyBtYWtlIHRoZSBwb3B1cCBoYXN0eQogIH0KICB0aGlzLm9wdGlvbnMuZGV0ZWN0SG9tZXNjcmVlbiA9IHRoaXMub3B0aW9ucy5kZXRlY3RIb21lc2NyZWVuID09PSB0cnVlID8gJ2hhc2gnIDogdGhpcy5vcHRpb25zLmRldGVjdEhvbWVzY3JlZW47CgogIC8vIHNldHVwIHRoZSBkZWJ1ZyBlbnZpcm9ubWVudAogIGlmICh0aGlzLm9wdGlvbnMuZGVidWcpIHsKICAgIGF0aC5pc0NvbXBhdGlibGUgPSB0cnVlOwogICAgYXRoLk9TID0gdHlwZW9mIHRoaXMub3B0aW9ucy5kZWJ1ZyA9PSAnc3RyaW5nJyA/IHRoaXMub3B0aW9ucy5kZWJ1ZyA6IGF0aC5PUyA9PSAndW5zdXBwb3J0ZWQnID8gJ2FuZHJvaWQnIDogYXRoLk9TOwogICAgYXRoLk9TVmVyc2lvbiA9IGF0aC5PUyA9PSAnaW9zJyA/ICc4JyA6ICc0JzsKICB9CgogIC8vIHRoZSBlbGVtZW50IHRoZSBtZXNzYWdlIHdpbGwgYmUgYXBwZW5kZWQgdG8KICB0aGlzLmNvbnRhaW5lciA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCiAgLy8gbG9hZCBzZXNzaW9uCiAgdGhpcy5zZXNzaW9uID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5vcHRpb25zLmFwcElEKTsKICB0aGlzLnNlc3Npb24gPSB0aGlzLnNlc3Npb24gPyBKU09OLnBhcnNlKHRoaXMuc2Vzc2lvbikgOiB1bmRlZmluZWQ7CgogIC8vIHVzZXIgbW9zdCBsaWtlbHkgY2FtZSBmcm9tIGEgZGlyZWN0IGxpbmsgY29udGFpbmluZyBvdXIgdG9rZW4sIHdlIGRvbid0IG5lZWQgaXQgYW5kIHdlIHJlbW92ZSBpdAogIGlmIChhdGguaGFzVG9rZW4gJiYgKCAhYXRoLmlzQ29tcGF0aWJsZSB8fCAhdGhpcy5zZXNzaW9uICkpIHsKICAgIGF0aC5oYXNUb2tlbiA9IGZhbHNlOwogICAgX3JlbW92ZVRva2VuKCk7CiAgfQoKICAvLyB0aGUgZGV2aWNlIGlzIG5vdCBzdXBwb3J0ZWQKICBpZiAoIWF0aC5pc0NvbXBhdGlibGUpIHsKICAgIHJldHVybjsKICB9CgogIHRoaXMuc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbiB8fCBfZGVmYXVsdFNlc3Npb247CgogIC8vIGNoZWNrIGlmIHdlIGNhbiB1c2UgdGhlIGxvY2FsIHN0b3JhZ2UKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5vcHRpb25zLmFwcElELCBKU09OLnN0cmluZ2lmeSh0aGlzLnNlc3Npb24pKTsKICAgIGF0aC5oYXNMb2NhbFN0b3JhZ2UgPSB0cnVlOwogIH0gY2F0Y2ggKGUpIHsKICAgIC8vIHdlIGFyZSBtb3N0IGxpa2VseSBpbiBwcml2YXRlIG1vZGUKICAgIGF0aC5oYXNMb2NhbFN0b3JhZ2UgPSBmYWxzZTsKCiAgICBpZiAodGhpcy5vcHRpb25zLm9uUHJpdmF0ZSkgewogICAgICB0aGlzLm9wdGlvbnMub25Qcml2YXRlLmNhbGwodGhpcyk7CiAgICB9CiAgfQoKICAvLyBjaGVjayBpZiB0aGlzIGlzIGEgdmFsaWQgbG9jYXRpb24KICB2YXIgaXNWYWxpZExvY2F0aW9uID0gIXRoaXMub3B0aW9ucy52YWxpZExvY2F0aW9uLmxlbmd0aDsKICBmb3IgKHZhciBpID0gdGhpcy5vcHRpb25zLnZhbGlkTG9jYXRpb24ubGVuZ3RoOyBpLS07KSB7CiAgICBpZiAodGhpcy5vcHRpb25zLnZhbGlkTG9jYXRpb25baV0udGVzdChkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSkgewogICAgICBpc1ZhbGlkTG9jYXRpb24gPSB0cnVlOwogICAgICBicmVhazsKICAgIH0KICB9CgogIC8vIGNoZWNrIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgdmVyc2lvbnMgb2YgYWRkIHRvIGhvbWVzY3JlZW4uIE9wdC1vdXQgaWYgYW4gb2xkIHNlc3Npb24gaXMgZm91bmQKICBpZiAobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2FkZFRvSG9tZScpKSB7CiAgICB0aGlzLm9wdE91dCgpOwogIH0KCiAgLy8gY3JpdGljYWwgZXJyb3JzOgogIC8vIHVzZXIgb3B0ZWQgb3V0LCBhbHJlYWR5IGFkZGVkIHRvIHRoZSBob21lc2NyZWVuLCBub3QgYSB2YWxpZCBsb2NhdGlvbgogIGlmICh0aGlzLnNlc3Npb24ub3B0ZWRvdXQgfHwgdGhpcy5zZXNzaW9uLmFkZGVkIHx8ICFpc1ZhbGlkTG9jYXRpb24pIHsKICAgIHJldHVybjsKICB9CgogIC8vIGNoZWNrIGlmIHRoZSBhcHAgaXMgaW4gc3RhbmQgYWxvbmUgbW9kZQogIGlmIChhdGguaXNTdGFuZGFsb25lKSB7CiAgICAvLyBleGVjdXRlIHRoZSBvbkFkZCBldmVudCBpZiB3ZSBoYXZlbid0IGFscmVhZHkKICAgIGlmICghdGhpcy5zZXNzaW9uLmFkZGVkKSB7CiAgICAgIHRoaXMuc2Vzc2lvbi5hZGRlZCA9IHRydWU7CiAgICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwoKICAgICAgaWYgKHRoaXMub3B0aW9ucy5vbkFkZCAmJiBhdGguaGFzTG9jYWxTdG9yYWdlKSB7CS8vIGRvdWJsZSBjaGVjayBvbiBsb2NhbHN0b3JhZ2UgdG8gYXZvaWQgbXVsdGlwbGUgY2FsbHMgdG8gdGhlIGN1c3RvbSBldmVudAogICAgICAgIHRoaXMub3B0aW9ucy5vbkFkZC5jYWxsKHRoaXMpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuOwogIH0KCiAgLy8gKHRyeSB0bykgY2hlY2sgaWYgdGhlIHBhZ2UgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGhvbWVzY3JlZW4KICBpZiAodGhpcy5vcHRpb25zLmRldGVjdEhvbWVzY3JlZW4pIHsKICAgIC8vIHRoZSBVUkwgaGFzIHRoZSB0b2tlbiwgd2UgYXJlIGxpa2VseSBjb21pbmcgZnJvbSB0aGUgaG9tZXNjcmVlbgogICAgaWYgKGF0aC5oYXNUb2tlbikgewogICAgICBfcmVtb3ZlVG9rZW4oKTsJCS8vIHdlIGRvbid0IGFjdHVhbGx5IG5lZWQgdGhlIHRva2VuIGFueW1vcmUsIHdlIHJlbW92ZSBpdCB0byBwcmV2ZW50IHJlZGlzdHJpYnV0aW9uCgogICAgICAvLyB0aGlzIGlzIGNhbGxlZCB0aGUgZmlyc3QgdGltZSB0aGUgdXNlciBvcGVucyB0aGUgYXBwIGZyb20gdGhlIGhvbWVzY3JlZW4KICAgICAgaWYgKCF0aGlzLnNlc3Npb24uYWRkZWQpIHsKICAgICAgICB0aGlzLnNlc3Npb24uYWRkZWQgPSB0cnVlOwogICAgICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwoKICAgICAgICBpZiAodGhpcy5vcHRpb25zLm9uQWRkICYmIGF0aC5oYXNMb2NhbFN0b3JhZ2UpIHsJLy8gZG91YmxlIGNoZWNrIG9uIGxvY2Fsc3RvcmFnZSB0byBhdm9pZCBtdWx0aXBsZSBjYWxscyB0byB0aGUgY3VzdG9tIGV2ZW50CiAgICAgICAgICB0aGlzLm9wdGlvbnMub25BZGQuY2FsbCh0aGlzKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBVUkwgZG9lc24ndCBoYXZlIHRoZSB0b2tlbiwgc28gYWRkIGl0CiAgICBpZiAodGhpcy5vcHRpb25zLmRldGVjdEhvbWVzY3JlZW4gPT0gJ2hhc2gnKSB7CiAgICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKCcnLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgKyAnI2F0aCcpOwogICAgfSBlbHNlIGlmICh0aGlzLm9wdGlvbnMuZGV0ZWN0SG9tZXNjcmVlbiA9PSAnc21hcnRVUkwnKSB7CiAgICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKCcnLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKFwvKT8kLywgJy9hdGgkMScpKTsKICAgIH0gZWxzZSB7CiAgICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKCcnLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgKyAoZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoID8gJyYnIDogJz8nICkgKyAnYXRoPScpOwogICAgfQogIH0KCiAgLy8gY2hlY2sgaWYgdGhpcyBpcyBhIHJldHVybmluZyB2aXNpdG9yCiAgaWYgKCF0aGlzLnNlc3Npb24ucmV0dXJuaW5nVmlzaXRvcikgewogICAgdGhpcy5zZXNzaW9uLnJldHVybmluZ1Zpc2l0b3IgPSB0cnVlOwogICAgdGhpcy51cGRhdGVTZXNzaW9uKCk7CgogICAgLy8gd2UgZG8gbm90IHNob3cgdGhlIG1lc3NhZ2UgaWYgdGhpcyBpcyB5b3VyIGZpcnN0IHZpc2l0CiAgICBpZiAodGhpcy5vcHRpb25zLnNraXBGaXJzdFZpc2l0KSB7CiAgICAgIHJldHVybjsKICAgIH0KICB9CgogIC8vIHdlIGRvIG5vIHNob3cgdGhlIG1lc3NhZ2UgaW4gcHJpdmF0ZSBtb2RlCiAgaWYgKCFhdGguaGFzTG9jYWxTdG9yYWdlKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyBhbGwgY2hlY2tzIHBhc3NlZCwgcmVhZHkgdG8gZGlzcGxheQogIHRoaXMucmVhZHkgPSB0cnVlOwoKICBpZiAodGhpcy5vcHRpb25zLm9uSW5pdCkgewogICAgdGhpcy5vcHRpb25zLm9uSW5pdC5jYWxsKHRoaXMpOwogIH0KCiAgaWYgKHRoaXMub3B0aW9ucy5hdXRvc3RhcnQpIHsKICAgIHRoaXMuc2hvdygpOwogIH0KfTsKCmF0aC5DbGFzcy5wcm90b3R5cGUgPSB7CiAgLy8gZXZlbnQgdHlwZSB0byBtZXRob2QgY29udmVyc2lvbgogIGV2ZW50czogewogICAgbG9hZDogJ19kZWxheWVkU2hvdycsCiAgICBlcnJvcjogJ19kZWxheWVkU2hvdycsCiAgICBvcmllbnRhdGlvbmNoYW5nZTogJ3Jlc2l6ZScsCiAgICByZXNpemU6ICdyZXNpemUnLAogICAgc2Nyb2xsOiAncmVzaXplJywKICAgIGNsaWNrOiAncmVtb3ZlJywKICAgIHRvdWNobW92ZTogJ19wcmV2ZW50RGVmYXVsdCcsCiAgICB0cmFuc2l0aW9uZW5kOiAnX3JlbW92ZUVsZW1lbnRzJywKICAgIHdlYmtpdFRyYW5zaXRpb25FbmQ6ICdfcmVtb3ZlRWxlbWVudHMnLAogICAgTVNUcmFuc2l0aW9uRW5kOiAnX3JlbW92ZUVsZW1lbnRzJwogIH0sCgogIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CiAgICB2YXIgdHlwZSA9IHRoaXMuZXZlbnRzW2UudHlwZV07CiAgICBpZiAodHlwZSkgewogICAgICB0aGlzW3R5cGVdKGUpOwogICAgfQogIH0sCgogIHNob3c6IGZ1bmN0aW9uKGZvcmNlKSB7CiAgICAvLyBpbiBhdXRvc3RhcnQgbW9kZSB3YWl0IGZvciB0aGUgZG9jdW1lbnQgdG8gYmUgcmVhZHkKICAgIGlmICh0aGlzLm9wdGlvbnMuYXV0b3N0YXJ0ICYmICFfRE9NUmVhZHkpIHsKICAgICAgc2V0VGltZW91dCh0aGlzLnNob3cuYmluZCh0aGlzKSwgNTApOwogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gbWVzc2FnZSBhbHJlYWR5IG9uIHNjcmVlbgogICAgaWYgKHRoaXMuc2hvd24pIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBub3cgPSBEYXRlLm5vdygpOwogICAgdmFyIGxhc3REaXNwbGF5VGltZSA9IHRoaXMuc2Vzc2lvbi5sYXN0RGlzcGxheVRpbWU7CgogICAgaWYgKGZvcmNlICE9PSB0cnVlKSB7CiAgICAgIC8vIHRoaXMgaXMgbmVlZGVkIGlmIGF1dG9zdGFydCBpcyBkaXNhYmxlZCBhbmQgeW91IHByb2dyYW1tYXRpY2FsbHkgY2FsbCB0aGUgc2hvdygpIG1ldGhvZAogICAgICBpZiAoIXRoaXMucmVhZHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIHdlIG9iZXkgdGhlIGRpc3BsYXkgcGFjZSAocHJldmVudCB0aGUgbWVzc2FnZSB0byBwb3B1cCB0b28gb2Z0ZW4pCiAgICAgIGlmIChub3cgLSBsYXN0RGlzcGxheVRpbWUgPCB0aGlzLm9wdGlvbnMuZGlzcGxheVBhY2UgKiA2MDAwMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gb2JleSB0aGUgbWF4aW11bSBudW1iZXIgb2YgZGlzcGxheSBjb3VudAogICAgICBpZiAodGhpcy5vcHRpb25zLm1heERpc3BsYXlDb3VudCAmJiB0aGlzLnNlc3Npb24uZGlzcGxheUNvdW50ID49IHRoaXMub3B0aW9ucy5tYXhEaXNwbGF5Q291bnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLnNob3duID0gdHJ1ZTsKCiAgICAvLyBpbmNyZW1lbnQgdGhlIGRpc3BsYXkgY291bnQKICAgIHRoaXMuc2Vzc2lvbi5sYXN0RGlzcGxheVRpbWUgPSBub3c7CiAgICB0aGlzLnNlc3Npb24uZGlzcGxheUNvdW50Kys7CiAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKCiAgICAvLyB0cnkgdG8gZ2V0IHRoZSBoaWdoZXN0IHJlc29sdXRpb24gYXBwbGljYXRpb24gaWNvbgogICAgaWYgKCF0aGlzLmFwcGxpY2F0aW9uSWNvbikgewogICAgICBpZiAoYXRoLk9TID09ICdpb3MnKSB7CiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbkljb24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkIGxpbmtbcmVsXj1hcHBsZS10b3VjaC1pY29uXVtzaXplcz0iMTUyeDE1MiJdLGhlYWQgbGlua1tyZWxePWFwcGxlLXRvdWNoLWljb25dW3NpemVzPSIxNDR4MTQ0Il0saGVhZCBsaW5rW3JlbF49YXBwbGUtdG91Y2gtaWNvbl1bc2l6ZXM9IjEyMHgxMjAiXSxoZWFkIGxpbmtbcmVsXj1hcHBsZS10b3VjaC1pY29uXVtzaXplcz0iMTE0eDExNCJdLGhlYWQgbGlua1tyZWxePWFwcGxlLXRvdWNoLWljb25dJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbkljb24gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkIGxpbmtbcmVsXj0ic2hvcnRjdXQgaWNvbiJdW3NpemVzPSIxOTZ4MTk2Il0saGVhZCBsaW5rW3JlbF49YXBwbGUtdG91Y2gtaWNvbl0nKTsKICAgICAgfQogICAgfQoKICAgIHZhciBtZXNzYWdlID0gJyc7CgogICAgaWYgKHRoaXMub3B0aW9ucy5tZXNzYWdlIGluIGF0aC5pbnRsKSB7CQkvLyB5b3UgY2FuIGZvcmNlIHRoZSBsb2NhbGUKICAgICAgbWVzc2FnZSA9IGF0aC5pbnRsW3RoaXMub3B0aW9ucy5tZXNzYWdlXS5tZXNzYWdlLnJlcGxhY2UoJyVhY3Rpb24nLCBhdGguaW50bFt0aGlzLm9wdGlvbnMubWVzc2FnZV0uYWN0aW9uW2F0aC5PU10pOwogICAgfSBlbHNlIGlmICh0aGlzLm9wdGlvbnMubWVzc2FnZSAhPT0gJycpIHsJCS8vIG9yIHVzZSBhIGN1c3RvbSBtZXNzYWdlCiAgICAgIG1lc3NhZ2UgPSB0aGlzLm9wdGlvbnMubWVzc2FnZTsKICAgIH0gZWxzZSB7CQkJCQkJCQkJCS8vIG90aGVyd2lzZSB3ZSB1c2Ugb3VyIG1lc3NhZ2UKICAgICAgbWVzc2FnZSA9IGF0aC5pbnRsW2F0aC5sYW5ndWFnZV0ubWVzc2FnZS5yZXBsYWNlKCclYWN0aW9uJywgYXRoLmludGxbYXRoLmxhbmd1YWdlXS5hY3Rpb25bYXRoLk9TXSk7CiAgICB9CgogICAgLy8gYWRkIHRoZSBhY3Rpb24gaWNvbgogICAgbWVzc2FnZSA9ICc8cD4nICsgbWVzc2FnZS5yZXBsYWNlKCclaWNvbicsICc8c3BhbiBjbGFzcz0iYXRoLWFjdGlvbi1pY29uIj5pY29uPC9zcGFuPicpICsgJzwvcD4nOwoKICAgIC8vIGNyZWF0ZSB0aGUgbWVzc2FnZSBjb250YWluZXIKICAgIHRoaXMudmlld3BvcnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHRoaXMudmlld3BvcnQuY2xhc3NOYW1lID0gJ2F0aC12aWV3cG9ydCc7CiAgICBpZiAodGhpcy5vcHRpb25zLm1vZGFsKSB7CiAgICAgIHRoaXMudmlld3BvcnQuY2xhc3NOYW1lICs9ICcgYXRoLW1vZGFsJzsKICAgIH0KICAgIGlmICh0aGlzLm9wdGlvbnMubWFuZGF0b3J5KSB7CiAgICAgIHRoaXMudmlld3BvcnQuY2xhc3NOYW1lICs9ICcgYXRoLW1hbmRhdG9yeSc7CiAgICB9CiAgICB0aGlzLnZpZXdwb3J0LnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJzsKCiAgICAvLyBjcmVhdGUgdGhlIGFjdHVhbCBtZXNzYWdlIGVsZW1lbnQKICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgdGhpcy5lbGVtZW50LmNsYXNzTmFtZSA9ICdhdGgtY29udGFpbmVyIGF0aC0nICsgYXRoLk9TICsgJyBhdGgtJyArIGF0aC5PUyArIChhdGguT1NWZXJzaW9uICsgJycpLnN1YnN0cigwLCAxKSArICcgYXRoLScgKyAoYXRoLmlzVGFibGV0ID8gJ3RhYmxldCcgOiAncGhvbmUnKTsKICAgIHRoaXMuZWxlbWVudC5zdHlsZS5jc3NUZXh0ID0gJy13ZWJraXQtdHJhbnNpdGlvbi1wcm9wZXJ0eTotd2Via2l0LXRyYW5zZm9ybSxvcGFjaXR5Oy13ZWJraXQtdHJhbnNpdGlvbi1kdXJhdGlvbjowOy13ZWJraXQtdHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTt0cmFuc2l0aW9uLXByb3BlcnR5OnRyYW5zZm9ybSxvcGFjaXR5O3RyYW5zaXRpb24tZHVyYXRpb246MDt0cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOy13ZWJraXQtdHJhbnNpdGlvbi10aW1pbmctZnVuY3Rpb246ZWFzZS1vdXQnOwogICAgdGhpcy5lbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgwLC0nICsgd2luZG93LmlubmVySGVpZ2h0ICsgJ3B4LDApJzsKICAgIHRoaXMuZWxlbWVudC5zdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPSAnMHMnOwoKICAgIC8vIGFkZCB0aGUgYXBwbGljYXRpb24gaWNvbgogICAgaWYgKHRoaXMub3B0aW9ucy5pY29uICYmIHRoaXMuYXBwbGljYXRpb25JY29uKSB7CiAgICAgIHRoaXMuZWxlbWVudC5jbGFzc05hbWUgKz0gJyBhdGgtaWNvbic7CiAgICAgIHRoaXMuaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgIHRoaXMuaW1nLmNsYXNzTmFtZSA9ICdhdGgtYXBwbGljYXRpb24taWNvbic7CiAgICAgIHRoaXMuaW1nLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCB0aGlzLCBmYWxzZSk7CiAgICAgIHRoaXMuaW1nLmFkZEV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgdGhpcywgZmFsc2UpOwoKICAgICAgdGhpcy5pbWcuc3JjID0gdGhpcy5hcHBsaWNhdGlvbkljb24uaHJlZjsKICAgICAgdGhpcy5lbGVtZW50LmFwcGVuZENoaWxkKHRoaXMuaW1nKTsKICAgIH0KCiAgICB0aGlzLmVsZW1lbnQuaW5uZXJIVE1MICs9IG1lc3NhZ2U7CgogICAgLy8gd2UgYXJlIG5vdCByZWFkeSB0byBzaG93LCBwbGFjZSB0aGUgbWVzc2FnZSBvdXQgb2Ygc2lnaHQKICAgIHRoaXMudmlld3BvcnQuc3R5bGUubGVmdCA9ICctOTk5OTllbSc7CgogICAgLy8gYXR0YWNoIGFsbCBlbGVtZW50cyB0byB0aGUgRE9NCiAgICB0aGlzLnZpZXdwb3J0LmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudCk7CiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLnZpZXdwb3J0KTsKCiAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIHRvIHdhaXQgZm9yIGFuIGltYWdlIHRvIGxvYWQsIHNob3cgdGhlIG1lc3NhZ2UgcmlnaHQgYXdheQogICAgaWYgKCF0aGlzLmltZykgewogICAgICB0aGlzLl9kZWxheWVkU2hvdygpOwogICAgfQogIH0sCgogIF9kZWxheWVkU2hvdzogZnVuY3Rpb24oZSkgewogICAgc2V0VGltZW91dCh0aGlzLl9zaG93LmJpbmQodGhpcyksIHRoaXMub3B0aW9ucy5zdGFydERlbGF5ICogMTAwMCArIDUwMCk7CiAgfSwKCiAgX3Nob3c6IGZ1bmN0aW9uKCkgewogICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgIC8vIHVwZGF0ZSB0aGUgdmlld3BvcnQgc2l6ZSBhbmQgb3JpZW50YXRpb24KICAgIHRoaXMudXBkYXRlVmlld3BvcnQoKTsKCiAgICAvLyByZXBvc2l0aW9uL3Jlc2l6ZSB0aGUgbWVzc2FnZSBvbiBvcmllbnRhdGlvbiBjaGFuZ2UKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLCBmYWxzZSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcywgZmFsc2UpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcywgZmFsc2UpOwoKICAgIGlmICh0aGlzLm9wdGlvbnMubW9kYWwpIHsKICAgICAgLy8gbG9jayBhbnkgb3RoZXIgaW50ZXJhY3Rpb24KICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcywgdHJ1ZSk7CiAgICB9CgogICAgLy8gRW5hYmxlIGNsb3NpbmcgYWZ0ZXIgMSBzZWNvbmQKICAgIGlmICghdGhpcy5vcHRpb25zLm1hbmRhdG9yeSkgewogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoYXQsIHRydWUpOwogICAgICB9LCAxMDAwKTsKICAgIH0KCiAgICAvLyBraWNrIHRoZSBhbmltYXRpb24KICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuZWxlbWVudC5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAndHJhbnNsYXRlM2QoMCwwLDApJzsKICAgICAgdGhhdC5lbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICcxLjJzJzsKICAgIH0sIDApOwoKICAgIC8vIHNldCB0aGUgZGVzdHJveSB0aW1lcgogICAgaWYgKHRoaXMub3B0aW9ucy5saWZlc3BhbikgewogICAgICB0aGlzLnJlbW92ZVRpbWVyID0gc2V0VGltZW91dCh0aGlzLnJlbW92ZS5iaW5kKHRoaXMpLCB0aGlzLm9wdGlvbnMubGlmZXNwYW4gKiAxMDAwKTsKICAgIH0KCiAgICAvLyBmaXJlIHRoZSBjdXN0b20gb25TaG93IGV2ZW50CiAgICBpZiAodGhpcy5vcHRpb25zLm9uU2hvdykgewogICAgICB0aGlzLm9wdGlvbnMub25TaG93LmNhbGwodGhpcyk7CiAgICB9CiAgfSwKCiAgcmVtb3ZlOiBmdW5jdGlvbigpIHsKICAgIGNsZWFyVGltZW91dCh0aGlzLnJlbW92ZVRpbWVyKTsKCiAgICAvLyBjbGVhciB1cCB0aGUgZXZlbnQgbGlzdGVuZXJzCiAgICBpZiAodGhpcy5pbWcpIHsKICAgICAgdGhpcy5pbWcucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMsIGZhbHNlKTsKICAgICAgdGhpcy5pbWcucmVtb3ZlRXZlbnRMaXN0ZW5lcignZXJyb3InLCB0aGlzLCBmYWxzZSk7CiAgICB9CgogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMsIGZhbHNlKTsKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLCBmYWxzZSk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCB0aGlzLCBmYWxzZSk7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLCB0cnVlKTsKICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMsIHRydWUpOwoKICAgIC8vIHJlbW92ZSB0aGUgbWVzc2FnZSBlbGVtZW50IG9uIHRyYW5zaXRpb24gZW5kCiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMsIGZhbHNlKTsKICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgdGhpcywgZmFsc2UpOwogICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ01TVHJhbnNpdGlvbkVuZCcsIHRoaXMsIGZhbHNlKTsKCiAgICAvLyBzdGFydCB0aGUgZmFkZSBvdXQgYW5pbWF0aW9uCiAgICB0aGlzLmVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gJzAuM3MnOwogICAgdGhpcy5lbGVtZW50LnN0eWxlLm9wYWNpdHkgPSAnMCc7CiAgfSwKCiAgX3JlbW92ZUVsZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd0cmFuc2l0aW9uZW5kJywgdGhpcywgZmFsc2UpOwogICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCB0aGlzLCBmYWxzZSk7CiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNUcmFuc2l0aW9uRW5kJywgdGhpcywgZmFsc2UpOwoKICAgIC8vIHJlbW92ZSB0aGUgbWVzc2FnZSBmcm9tIHRoZSBET00KICAgIHRoaXMuY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMudmlld3BvcnQpOwoKICAgIHRoaXMuc2hvd24gPSBmYWxzZTsKCiAgICAvLyBmaXJlIHRoZSBjdXN0b20gb25SZW1vdmUgZXZlbnQKICAgIGlmICh0aGlzLm9wdGlvbnMub25SZW1vdmUpIHsKICAgICAgdGhpcy5vcHRpb25zLm9uUmVtb3ZlLmNhbGwodGhpcyk7CiAgICB9CiAgfSwKCiAgdXBkYXRlVmlld3BvcnQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLnNob3duKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnZpZXdwb3J0LnN0eWxlLndpZHRoID0gd2luZG93LmlubmVyV2lkdGggKyAncHgnOwogICAgdGhpcy52aWV3cG9ydC5zdHlsZS5oZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgKyAncHgnOwogICAgdGhpcy52aWV3cG9ydC5zdHlsZS5sZWZ0ID0gd2luZG93LnNjcm9sbFggKyAncHgnOwogICAgdGhpcy52aWV3cG9ydC5zdHlsZS50b3AgPSB3aW5kb3cuc2Nyb2xsWSArICdweCc7CgogICAgdmFyIGNsaWVudFdpZHRoID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudFdpZHRoOwoKICAgIHRoaXMub3JpZW50YXRpb24gPSBjbGllbnRXaWR0aCA+IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQgPyAnbGFuZHNjYXBlJyA6ICdwb3J0cmFpdCc7CgogICAgdmFyIHNjcmVlbldpZHRoID0gYXRoLk9TID09ICdpb3MnID8gdGhpcy5vcmllbnRhdGlvbiA9PSAncG9ydHJhaXQnID8gc2NyZWVuLndpZHRoIDogc2NyZWVuLmhlaWdodCA6IHNjcmVlbi53aWR0aDsKICAgIHRoaXMuc2NhbGUgPSBzY3JlZW4ud2lkdGggPiBjbGllbnRXaWR0aCA/IDEgOiBzY3JlZW5XaWR0aCAvIHdpbmRvdy5pbm5lcldpZHRoOwoKICAgIHRoaXMuZWxlbWVudC5zdHlsZS5mb250U2l6ZSA9IHRoaXMub3B0aW9ucy5mb250U2l6ZSAvIHRoaXMuc2NhbGUgKyAncHgnOwogIH0sCgogIHJlc2l6ZTogZnVuY3Rpb24oKSB7CiAgICBjbGVhclRpbWVvdXQodGhpcy5yZXNpemVUaW1lcik7CiAgICB0aGlzLnJlc2l6ZVRpbWVyID0gc2V0VGltZW91dCh0aGlzLnVwZGF0ZVZpZXdwb3J0LmJpbmQodGhpcyksIDEwMCk7CiAgfSwKCiAgdXBkYXRlU2Vzc2lvbjogZnVuY3Rpb24oKSB7CiAgICBpZiAoYXRoLmhhc0xvY2FsU3RvcmFnZSA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMub3B0aW9ucy5hcHBJRCwgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXNzaW9uKSk7CiAgfSwKCiAgY2xlYXJTZXNzaW9uOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2Vzc2lvbiA9IF9kZWZhdWx0U2Vzc2lvbjsKICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwogIH0sCgogIG9wdE91dDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlc3Npb24ub3B0ZWRvdXQgPSB0cnVlOwogICAgdGhpcy51cGRhdGVTZXNzaW9uKCk7CiAgfSwKCiAgb3B0SW46IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZXNzaW9uLm9wdGVkb3V0ID0gZmFsc2U7CiAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKICB9LAoKICBjbGVhckRpc3BsYXlDb3VudDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlc3Npb24uZGlzcGxheUNvdW50ID0gMDsKICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwogIH0sCgogIF9wcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oZSkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICB9Cn07CgovLyB1dGlsaXR5CmZ1bmN0aW9uIF9leHRlbmQodGFyZ2V0LCBvYmopIHsKICBmb3IgKHZhciBpIGluIG9iaikgewogICAgdGFyZ2V0W2ldID0gb2JqW2ldOwogIH0KCiAgcmV0dXJuIHRhcmdldDsKfQoKZnVuY3Rpb24gX3JlbW92ZVRva2VuKCkgewogIGlmIChkb2N1bWVudC5sb2NhdGlvbi5oYXNoID09ICcjYXRoJykgewogICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUoJycsIHdpbmRvdy5kb2N1bWVudC50aXRsZSwgZG9jdW1lbnQubG9jYXRpb24uaHJlZi5zcGxpdCgnIycpWzBdKTsKICB9CgogIGlmIChfcmVTbWFydFVSTC50ZXN0KGRvY3VtZW50LmxvY2F0aW9uLmhyZWYpKSB7CiAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgd2luZG93LmRvY3VtZW50LnRpdGxlLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoX3JlU21hcnRVUkwsICckMScpKTsKICB9CgogIGlmIChfcmVRdWVyeVN0cmluZy50ZXN0KGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaCkpIHsKICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKCcnLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYucmVwbGFjZShfcmVRdWVyeVN0cmluZywgJyQyJykpOwogIH0KfQoKLyoganNoaW50ICtXMTAxLCArVzEwNiAqLwoKJC5BTVVJLmFkZFRvSG9tZXNjcmVlbiA9IGF0aDsKCm1vZHVsZS5leHBvcnRzID0gYXRoOwo=",
                "body": "J3VzZSBzdHJpY3QnOwoKdmFyICQgPSByZXF1aXJlKCdqcXVlcnknKTsKcmVxdWlyZSgnLi9jb3JlJyk7CgovKiBqc2hpbnQgLVcxMDEsIC1XMTA2ICovCi8qIEFkZCB0byBIb21lc2NyZWVuIHYzLjAuOCB+IChjKSAyMDE0IE1hdHRlbyBTcGluZWxsaSB+IEBsaWNlbnNlOiBodHRwOi8vY3ViaXEub3JnL2xpY2Vuc2UgKi8KCi8vIENoZWNrIGlmIGRvY3VtZW50IGlzIGxvYWRlZCwgbmVlZGVkIGJ5IGF1dG9zdGFydAp2YXIgX0RPTVJlYWR5ID0gZmFsc2U7CmlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgX0RPTVJlYWR5ID0gdHJ1ZTsKfSBlbHNlIHsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGxvYWRlZCwgZmFsc2UpOwp9CgpmdW5jdGlvbiBsb2FkZWQoKSB7CiAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBsb2FkZWQsIGZhbHNlKTsKICBfRE9NUmVhZHkgPSB0cnVlOwp9CgovLyByZWdleCB1c2VkIHRvIGRldGVjdCBpZiBhcHAgaGFzIGJlZW4gYWRkZWQgdG8gdGhlIGhvbWVzY3JlZW4KdmFyIF9yZVNtYXJ0VVJMID0gL1wvYXRoKFwvKT8kLzsKdmFyIF9yZVF1ZXJ5U3RyaW5nID0gLyhbXD8mXWF0aD1bXiZdKiR8JmF0aD1bXiZdKigmKSkvOwoKLy8gc2luZ2xldG9uCnZhciBfaW5zdGFuY2U7CgpmdW5jdGlvbiBhdGgob3B0aW9ucykgewogIF9pbnN0YW5jZSA9IF9pbnN0YW5jZSB8fCBuZXcgYXRoLkNsYXNzKG9wdGlvbnMpOwoKICByZXR1cm4gX2luc3RhbmNlOwp9CgovLyBtZXNzYWdlIGluIGFsbCBzdXBwb3J0ZWQgbGFuZ3VhZ2VzCmF0aC5pbnRsID0gewogIGVuX3VzOiB7CiAgICBtZXNzYWdlOiAnVG8gYWRkIHRoaXMgd2ViIGFwcCB0byB0aGUgaG9tZSBzY3JlZW46IHRhcCAlaWNvbiBhbmQgdGhlbiA8c3Ryb25nPiVhY3Rpb248L3N0cm9uZz4uJywKICAgIGFjdGlvbjogewogICAgICBpb3M6ICdBZGQgdG8gSG9tZSBTY3JlZW4nLAogICAgICBhbmRyb2lkOiAnQWRkIHRvIGhvbWVzY3JlZW4nLAogICAgICB3aW5kb3dzOiAncGluIHRvIHN0YXJ0JwogICAgfQogIH0sCgogIHpoX2NuOiB7CiAgICBtZXNzYWdlOiAn5aaC6KaB5oqK5bqU55So56iL5byP5Yqg6Iez5Li75bGP5bmVLOivt+eCueWHuyVpY29uLCDnhLblkI48c3Ryb25nPiVhY3Rpb248L3N0cm9uZz4nLAogICAgYWN0aW9uOiB7aW9zOiAn5Yqg6Iez5Li75bGP5bmVJywgYW5kcm9pZDogJ+WKoOiHs+S4u+Wxj+W5lScsIHdpbmRvd3M6ICfmjInkvY/lkK/liqgnfQogIH0sCgogIHpoX3R3OiB7CiAgICBtZXNzYWdlOiAn5aaC6KaB5oqK5oeJ55So56iL5byP5Yqg6Iez5Li75bGP5bmVLCDoq4vpu57mk4olaWNvbiwg54S25b6MPHN0cm9uZz4lYWN0aW9uPC9zdHJvbmc+LicsCiAgICBhY3Rpb246IHtpb3M6ICfliqDoh7PkuLvlsY/luZUnLCBhbmRyb2lkOiAn5Yqg6Iez5Li75bGP5bmVJywgd2luZG93czogJ+aMieS9j+WVn+WLlSd9CiAgfQp9OwoKLy8gQWRkIDIgY2hhcmFjdGVycyBsYW5ndWFnZSBzdXBwb3J0IChBbmRyb2lkIG1vc3RseSkKZm9yICh2YXIgbGFuZyBpbiBhdGguaW50bCkgewogIGF0aC5pbnRsW2xhbmcuc3Vic3RyKDAsIDIpXSA9IGF0aC5pbnRsW2xhbmddOwp9CgovLyBkZWZhdWx0IG9wdGlvbnMKYXRoLmRlZmF1bHRzID0gewogIGFwcElEOiAnb3JnLmN1YmlxLmFkZHRvaG9tZScsCQkvLyBsb2NhbCBzdG9yYWdlIG5hbWUgKG5vIG5lZWQgdG8gY2hhbmdlKQogIGZvbnRTaXplOiAxNSwJCQkJLy8gYmFzZSBmb250IHNpemUsIHVzZWQgdG8gcHJvcGVybHkgcmVzaXplIHRoZSBwb3B1cCBiYXNlZCBvbiB2aWV3cG9ydCBzY2FsZSBmYWN0b3IKICBkZWJ1ZzogZmFsc2UsCQkJCS8vIG92ZXJyaWRlIGJyb3dzZXIgY2hlY2tzCiAgbW9kYWw6IGZhbHNlLAkJCQkvLyBwcmV2ZW50IGZ1cnRoZXIgYWN0aW9ucyB1bnRpbCB0aGUgbWVzc2FnZSBpcyBjbG9zZWQKICBtYW5kYXRvcnk6IGZhbHNlLAkJCS8vIHlvdSBjYW4ndCBwcm9jZWVkIGlmIHlvdSBkb24ndCBhZGQgdGhlIGFwcCB0byB0aGUgaG9tZXNjcmVlbgogIGF1dG9zdGFydDogdHJ1ZSwJCQkvLyBzaG93IHRoZSBtZXNzYWdlIGF1dG9tYXRpY2FsbHkKICBza2lwRmlyc3RWaXNpdDogZmFsc2UsCQkvLyBzaG93IG9ubHkgdG8gcmV0dXJuaW5nIHZpc2l0b3JzIChpZTogc2tpcCB0aGUgZmlyc3QgdGltZSB5b3UgdmlzaXQpCiAgc3RhcnREZWxheTogMSwJCQkJLy8gZGlzcGxheSB0aGUgbWVzc2FnZSBhZnRlciB0aGF0IG1hbnkgc2Vjb25kcyBmcm9tIHBhZ2UgbG9hZAogIGxpZmVzcGFuOiAxNSwJCQkJLy8gbGlmZSBvZiB0aGUgbWVzc2FnZSBpbiBzZWNvbmRzCiAgZGlzcGxheVBhY2U6IDE0NDAsCQkJLy8gbWludXRlcyBiZWZvcmUgdGhlIG1lc3NhZ2UgaXMgc2hvd24gYWdhaW4gKDA6IGRpc3BsYXkgZXZlcnkgdGltZSwgZGVmYXVsdCAyNCBob3VycykKICBtYXhEaXNwbGF5Q291bnQ6IDAsCQkJLy8gYWJzb2x1dGUgbWF4aW11bSBudW1iZXIgb2YgdGltZXMgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBzaG93biB0byB0aGUgdXNlciAoMDogbm8gbGltaXQpCiAgaWNvbjogdHJ1ZSwJCQkJCS8vIGFkZCB0b3VjaCBpY29uIHRvIHRoZSBtZXNzYWdlCiAgbWVzc2FnZTogJycsCQkJCS8vIHRoZSBtZXNzYWdlIGNhbiBiZSBjdXN0b21pemVkCiAgdmFsaWRMb2NhdGlvbjogW10sCQkJLy8gbGlzdCBvZiBwYWdlcyB3aGVyZSB0aGUgbWVzc2FnZSB3aWxsIGJlIHNob3duIChhcnJheSBvZiByZWdleGVzKQogIG9uSW5pdDogbnVsbCwJCQkJLy8gZXhlY3V0ZWQgb24gaW5zdGFuY2UgY3JlYXRpb24KICBvblNob3c6IG51bGwsCQkJCS8vIGV4ZWN1dGVkIHdoZW4gdGhlIG1lc3NhZ2UgaXMgc2hvd24KICBvblJlbW92ZTogbnVsbCwJCQkJLy8gZXhlY3V0ZWQgd2hlbiB0aGUgbWVzc2FnZSBpcyByZW1vdmVkCiAgb25BZGQ6IG51bGwsCQkJCS8vIHdoZW4gdGhlIGFwcGxpY2F0aW9uIGlzIGxhdW5jaGVkIHRoZSBmaXJzdCB0aW1lIGZyb20gdGhlIGhvbWVzY3JlZW4gKGd1ZXNzdGltYXRlKQogIG9uUHJpdmF0ZTogbnVsbCwJCQkvLyBleGVjdXRlZCBpZiB1c2VyIGlzIGluIHByaXZhdGUgbW9kZQogIGRldGVjdEhvbWVzY3JlZW46IGZhbHNlCQkvLyB0cnkgdG8gZGV0ZWN0IGlmIHRoZSBzaXRlIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBob21lc2NyZWVuIChmYWxzZSB8IHRydWUgfCAnaGFzaCcgfCAncXVlcnlTdHJpbmcnIHwgJ3NtYXJ0VVJMJykKfTsKCi8vIGJyb3dzZXIgaW5mbyBhbmQgY2FwYWJpbGl0eQp2YXIgX3VhID0gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQ7Cgp2YXIgX25hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7Cl9leHRlbmQoYXRoLCB7CiAgaGFzVG9rZW46IGRvY3VtZW50LmxvY2F0aW9uLmhhc2ggPT0gJyNhdGgnIHx8IF9yZVNtYXJ0VVJMLnRlc3QoZG9jdW1lbnQubG9jYXRpb24uaHJlZikgfHwgX3JlUXVlcnlTdHJpbmcudGVzdChkb2N1bWVudC5sb2NhdGlvbi5zZWFyY2gpLAogIGlzUmV0aW5hOiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyAmJiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyA+IDEsCiAgaXNJRGV2aWNlOiAoL2lwaG9uZXxpcG9kfGlwYWQvaSkudGVzdChfdWEpLAogIGlzTW9iaWxlQ2hyb21lOiBfdWEuaW5kZXhPZignQW5kcm9pZCcpID4gLTEgJiYgKC9DaHJvbWVcL1suMC05XSovKS50ZXN0KF91YSksCiAgaXNNb2JpbGVJRTogX3VhLmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA+IC0xLAogIGxhbmd1YWdlOiBfbmF2Lmxhbmd1YWdlICYmIF9uYXYubGFuZ3VhZ2UudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCctJywgJ18nKSB8fCAnJwp9KTsKCi8vIGZhbGxzIGJhY2sgdG8gZW5fdXMgaWYgbGFuZ3VhZ2UgaXMgdW5zdXBwb3J0ZWQKYXRoLmxhbmd1YWdlID0gYXRoLmxhbmd1YWdlICYmIGF0aC5sYW5ndWFnZSBpbiBhdGguaW50bCA/IGF0aC5sYW5ndWFnZSA6ICdlbl91cyc7CgphdGguaXNNb2JpbGVTYWZhcmkgPSBhdGguaXNJRGV2aWNlICYmIF91YS5pbmRleE9mKCdTYWZhcmknKSA+IC0xICYmIF91YS5pbmRleE9mKCdDcmlPUycpIDwgMDsKYXRoLk9TID0gYXRoLmlzSURldmljZSA/ICdpb3MnIDogYXRoLmlzTW9iaWxlQ2hyb21lID8gJ2FuZHJvaWQnIDogYXRoLmlzTW9iaWxlSUUgPyAnd2luZG93cycgOiAndW5zdXBwb3J0ZWQnOwoKYXRoLk9TVmVyc2lvbiA9IF91YS5tYXRjaCgvKE9TfEFuZHJvaWQpIChcZCtbX1wuXVxkKykvKTsKYXRoLk9TVmVyc2lvbiA9IGF0aC5PU1ZlcnNpb24gJiYgYXRoLk9TVmVyc2lvblsyXSA/ICthdGguT1NWZXJzaW9uWzJdLnJlcGxhY2UoJ18nLCAnLicpIDogMDsKCmF0aC5pc1N0YW5kYWxvbmUgPSB3aW5kb3cubmF2aWdhdG9yLnN0YW5kYWxvbmUgfHwgKCBhdGguaXNNb2JpbGVDaHJvbWUgJiYgKCBzY3JlZW4uaGVpZ2h0IC0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCA8IDQwICkgKTsJLy8gVE9ETzogY2hlY2sgdGhlIGxhbWUgcG9seWZpbGwKYXRoLmlzVGFibGV0ID0gKGF0aC5pc01vYmlsZVNhZmFyaSAmJiBfdWEuaW5kZXhPZignaVBhZCcpID4gLTEpIHx8IChhdGguaXNNb2JpbGVDaHJvbWUgJiYgX3VhLmluZGV4T2YoJ01vYmlsZScpIDwgMCk7CgphdGguaXNDb21wYXRpYmxlID0gKGF0aC5pc01vYmlsZVNhZmFyaSAmJiBhdGguT1NWZXJzaW9uID49IDYpIHx8IGF0aC5pc01vYmlsZUNocm9tZTsJLy8gVE9ETzogYWRkIHdpbnBob25lCgp2YXIgX2RlZmF1bHRTZXNzaW9uID0gewogIGxhc3REaXNwbGF5VGltZTogMCwJCQkvLyBsYXN0IHRpbWUgd2UgZGlzcGxheWVkIHRoZSBtZXNzYWdlCiAgcmV0dXJuaW5nVmlzaXRvcjogZmFsc2UsCS8vIGlzIHRoaXMgdGhlIGZpcnN0IHRpbWUgeW91IHZpc2l0CiAgZGlzcGxheUNvdW50OiAwLAkJCS8vIG51bWJlciBvZiB0aW1lcyB0aGUgbWVzc2FnZSBoYXMgYmVlbiBzaG93bgogIG9wdGVkb3V0OiBmYWxzZSwJCQkvLyBoYXMgdGhlIHVzZXIgb3B0ZWQgb3V0CiAgYWRkZWQ6IGZhbHNlCQkJCS8vIGhhcyBiZWVuIGFjdHVhbGx5IGFkZGVkIHRvIHRoZSBob21lc2NyZWVuCn07CgphdGgucmVtb3ZlU2Vzc2lvbiA9IGZ1bmN0aW9uKGFwcElEKSB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGFwcElEIHx8IGF0aC5kZWZhdWx0cy5hcHBJRCk7CiAgfSBjYXRjaCAoZSkgewogICAgLy8gd2UgYXJlIG1vc3QgbGlrZWx5IGluIHByaXZhdGUgbW9kZQogIH0KfTsKCmF0aC5DbGFzcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAvLyBtZXJnZSBkZWZhdWx0IG9wdGlvbnMgd2l0aCB1c2VyIGNvbmZpZwogIHRoaXMub3B0aW9ucyA9IF9leHRlbmQoe30sIGF0aC5kZWZhdWx0cyk7CiAgX2V4dGVuZCh0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwoKICAvLyBub3JtYWxpemUgc29tZSBvcHRpb25zCiAgdGhpcy5vcHRpb25zLm1hbmRhdG9yeSA9IHRoaXMub3B0aW9ucy5tYW5kYXRvcnkgJiYgKCAnc3RhbmRhbG9uZScgaW4gd2luZG93Lm5hdmlnYXRvciB8fCB0aGlzLm9wdGlvbnMuZGVidWcgKTsKICB0aGlzLm9wdGlvbnMubW9kYWwgPSB0aGlzLm9wdGlvbnMubW9kYWwgfHwgdGhpcy5vcHRpb25zLm1hbmRhdG9yeTsKICBpZiAodGhpcy5vcHRpb25zLm1hbmRhdG9yeSkgewogICAgdGhpcy5vcHRpb25zLnN0YXJ0RGVsYXkgPSAtMC41OwkJLy8gbWFrZSB0aGUgcG9wdXAgaGFzdHkKICB9CiAgdGhpcy5vcHRpb25zLmRldGVjdEhvbWVzY3JlZW4gPSB0aGlzLm9wdGlvbnMuZGV0ZWN0SG9tZXNjcmVlbiA9PT0gdHJ1ZSA/ICdoYXNoJyA6IHRoaXMub3B0aW9ucy5kZXRlY3RIb21lc2NyZWVuOwoKICAvLyBzZXR1cCB0aGUgZGVidWcgZW52aXJvbm1lbnQKICBpZiAodGhpcy5vcHRpb25zLmRlYnVnKSB7CiAgICBhdGguaXNDb21wYXRpYmxlID0gdHJ1ZTsKICAgIGF0aC5PUyA9IHR5cGVvZiB0aGlzLm9wdGlvbnMuZGVidWcgPT0gJ3N0cmluZycgPyB0aGlzLm9wdGlvbnMuZGVidWcgOiBhdGguT1MgPT0gJ3Vuc3VwcG9ydGVkJyA/ICdhbmRyb2lkJyA6IGF0aC5PUzsKICAgIGF0aC5PU1ZlcnNpb24gPSBhdGguT1MgPT0gJ2lvcycgPyAnOCcgOiAnNCc7CiAgfQoKICAvLyB0aGUgZWxlbWVudCB0aGUgbWVzc2FnZSB3aWxsIGJlIGFwcGVuZGVkIHRvCiAgdGhpcy5jb250YWluZXIgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgogIC8vIGxvYWQgc2Vzc2lvbgogIHRoaXMuc2Vzc2lvbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMub3B0aW9ucy5hcHBJRCk7CiAgdGhpcy5zZXNzaW9uID0gdGhpcy5zZXNzaW9uID8gSlNPTi5wYXJzZSh0aGlzLnNlc3Npb24pIDogdW5kZWZpbmVkOwoKICAvLyB1c2VyIG1vc3QgbGlrZWx5IGNhbWUgZnJvbSBhIGRpcmVjdCBsaW5rIGNvbnRhaW5pbmcgb3VyIHRva2VuLCB3ZSBkb24ndCBuZWVkIGl0IGFuZCB3ZSByZW1vdmUgaXQKICBpZiAoYXRoLmhhc1Rva2VuICYmICggIWF0aC5pc0NvbXBhdGlibGUgfHwgIXRoaXMuc2Vzc2lvbiApKSB7CiAgICBhdGguaGFzVG9rZW4gPSBmYWxzZTsKICAgIF9yZW1vdmVUb2tlbigpOwogIH0KCiAgLy8gdGhlIGRldmljZSBpcyBub3Qgc3VwcG9ydGVkCiAgaWYgKCFhdGguaXNDb21wYXRpYmxlKSB7CiAgICByZXR1cm47CiAgfQoKICB0aGlzLnNlc3Npb24gPSB0aGlzLnNlc3Npb24gfHwgX2RlZmF1bHRTZXNzaW9uOwoKICAvLyBjaGVjayBpZiB3ZSBjYW4gdXNlIHRoZSBsb2NhbCBzdG9yYWdlCiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMub3B0aW9ucy5hcHBJRCwgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXNzaW9uKSk7CiAgICBhdGguaGFzTG9jYWxTdG9yYWdlID0gdHJ1ZTsKICB9IGNhdGNoIChlKSB7CiAgICAvLyB3ZSBhcmUgbW9zdCBsaWtlbHkgaW4gcHJpdmF0ZSBtb2RlCiAgICBhdGguaGFzTG9jYWxTdG9yYWdlID0gZmFsc2U7CgogICAgaWYgKHRoaXMub3B0aW9ucy5vblByaXZhdGUpIHsKICAgICAgdGhpcy5vcHRpb25zLm9uUHJpdmF0ZS5jYWxsKHRoaXMpOwogICAgfQogIH0KCiAgLy8gY2hlY2sgaWYgdGhpcyBpcyBhIHZhbGlkIGxvY2F0aW9uCiAgdmFyIGlzVmFsaWRMb2NhdGlvbiA9ICF0aGlzLm9wdGlvbnMudmFsaWRMb2NhdGlvbi5sZW5ndGg7CiAgZm9yICh2YXIgaSA9IHRoaXMub3B0aW9ucy52YWxpZExvY2F0aW9uLmxlbmd0aDsgaS0tOykgewogICAgaWYgKHRoaXMub3B0aW9ucy52YWxpZExvY2F0aW9uW2ldLnRlc3QoZG9jdW1lbnQubG9jYXRpb24uaHJlZikpIHsKICAgICAgaXNWYWxpZExvY2F0aW9uID0gdHJ1ZTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQoKICAvLyBjaGVjayBjb21wYXRpYmlsaXR5IHdpdGggb2xkIHZlcnNpb25zIG9mIGFkZCB0byBob21lc2NyZWVuLiBPcHQtb3V0IGlmIGFuIG9sZCBzZXNzaW9uIGlzIGZvdW5kCiAgaWYgKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdhZGRUb0hvbWUnKSkgewogICAgdGhpcy5vcHRPdXQoKTsKICB9CgogIC8vIGNyaXRpY2FsIGVycm9yczoKICAvLyB1c2VyIG9wdGVkIG91dCwgYWxyZWFkeSBhZGRlZCB0byB0aGUgaG9tZXNjcmVlbiwgbm90IGEgdmFsaWQgbG9jYXRpb24KICBpZiAodGhpcy5zZXNzaW9uLm9wdGVkb3V0IHx8IHRoaXMuc2Vzc2lvbi5hZGRlZCB8fCAhaXNWYWxpZExvY2F0aW9uKSB7CiAgICByZXR1cm47CiAgfQoKICAvLyBjaGVjayBpZiB0aGUgYXBwIGlzIGluIHN0YW5kIGFsb25lIG1vZGUKICBpZiAoYXRoLmlzU3RhbmRhbG9uZSkgewogICAgLy8gZXhlY3V0ZSB0aGUgb25BZGQgZXZlbnQgaWYgd2UgaGF2ZW4ndCBhbHJlYWR5CiAgICBpZiAoIXRoaXMuc2Vzc2lvbi5hZGRlZCkgewogICAgICB0aGlzLnNlc3Npb24uYWRkZWQgPSB0cnVlOwogICAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMub25BZGQgJiYgYXRoLmhhc0xvY2FsU3RvcmFnZSkgewkvLyBkb3VibGUgY2hlY2sgb24gbG9jYWxzdG9yYWdlIHRvIGF2b2lkIG11bHRpcGxlIGNhbGxzIHRvIHRoZSBjdXN0b20gZXZlbnQKICAgICAgICB0aGlzLm9wdGlvbnMub25BZGQuY2FsbCh0aGlzKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybjsKICB9CgogIC8vICh0cnkgdG8pIGNoZWNrIGlmIHRoZSBwYWdlIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBob21lc2NyZWVuCiAgaWYgKHRoaXMub3B0aW9ucy5kZXRlY3RIb21lc2NyZWVuKSB7CiAgICAvLyB0aGUgVVJMIGhhcyB0aGUgdG9rZW4sIHdlIGFyZSBsaWtlbHkgY29taW5nIGZyb20gdGhlIGhvbWVzY3JlZW4KICAgIGlmIChhdGguaGFzVG9rZW4pIHsKICAgICAgX3JlbW92ZVRva2VuKCk7CQkvLyB3ZSBkb24ndCBhY3R1YWxseSBuZWVkIHRoZSB0b2tlbiBhbnltb3JlLCB3ZSByZW1vdmUgaXQgdG8gcHJldmVudCByZWRpc3RyaWJ1dGlvbgoKICAgICAgLy8gdGhpcyBpcyBjYWxsZWQgdGhlIGZpcnN0IHRpbWUgdGhlIHVzZXIgb3BlbnMgdGhlIGFwcCBmcm9tIHRoZSBob21lc2NyZWVuCiAgICAgIGlmICghdGhpcy5zZXNzaW9uLmFkZGVkKSB7CiAgICAgICAgdGhpcy5zZXNzaW9uLmFkZGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5vbkFkZCAmJiBhdGguaGFzTG9jYWxTdG9yYWdlKSB7CS8vIGRvdWJsZSBjaGVjayBvbiBsb2NhbHN0b3JhZ2UgdG8gYXZvaWQgbXVsdGlwbGUgY2FsbHMgdG8gdGhlIGN1c3RvbSBldmVudAogICAgICAgICAgdGhpcy5vcHRpb25zLm9uQWRkLmNhbGwodGhpcyk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gVVJMIGRvZXNuJ3QgaGF2ZSB0aGUgdG9rZW4sIHNvIGFkZCBpdAogICAgaWYgKHRoaXMub3B0aW9ucy5kZXRlY3RIb21lc2NyZWVuID09ICdoYXNoJykgewogICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgd2luZG93LmRvY3VtZW50LnRpdGxlLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmICsgJyNhdGgnKTsKICAgIH0gZWxzZSBpZiAodGhpcy5vcHRpb25zLmRldGVjdEhvbWVzY3JlZW4gPT0gJ3NtYXJ0VVJMJykgewogICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgd2luZG93LmRvY3VtZW50LnRpdGxlLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhcLyk/JC8sICcvYXRoJDEnKSk7CiAgICB9IGVsc2UgewogICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgd2luZG93LmRvY3VtZW50LnRpdGxlLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmICsgKGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaCA/ICcmJyA6ICc/JyApICsgJ2F0aD0nKTsKICAgIH0KICB9CgogIC8vIGNoZWNrIGlmIHRoaXMgaXMgYSByZXR1cm5pbmcgdmlzaXRvcgogIGlmICghdGhpcy5zZXNzaW9uLnJldHVybmluZ1Zpc2l0b3IpIHsKICAgIHRoaXMuc2Vzc2lvbi5yZXR1cm5pbmdWaXNpdG9yID0gdHJ1ZTsKICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwoKICAgIC8vIHdlIGRvIG5vdCBzaG93IHRoZSBtZXNzYWdlIGlmIHRoaXMgaXMgeW91ciBmaXJzdCB2aXNpdAogICAgaWYgKHRoaXMub3B0aW9ucy5za2lwRmlyc3RWaXNpdCkgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICAvLyB3ZSBkbyBubyBzaG93IHRoZSBtZXNzYWdlIGluIHByaXZhdGUgbW9kZQogIGlmICghYXRoLmhhc0xvY2FsU3RvcmFnZSkgewogICAgcmV0dXJuOwogIH0KCiAgLy8gYWxsIGNoZWNrcyBwYXNzZWQsIHJlYWR5IHRvIGRpc3BsYXkKICB0aGlzLnJlYWR5ID0gdHJ1ZTsKCiAgaWYgKHRoaXMub3B0aW9ucy5vbkluaXQpIHsKICAgIHRoaXMub3B0aW9ucy5vbkluaXQuY2FsbCh0aGlzKTsKICB9CgogIGlmICh0aGlzLm9wdGlvbnMuYXV0b3N0YXJ0KSB7CiAgICB0aGlzLnNob3coKTsKICB9Cn07CgphdGguQ2xhc3MucHJvdG90eXBlID0gewogIC8vIGV2ZW50IHR5cGUgdG8gbWV0aG9kIGNvbnZlcnNpb24KICBldmVudHM6IHsKICAgIGxvYWQ6ICdfZGVsYXllZFNob3cnLAogICAgZXJyb3I6ICdfZGVsYXllZFNob3cnLAogICAgb3JpZW50YXRpb25jaGFuZ2U6ICdyZXNpemUnLAogICAgcmVzaXplOiAncmVzaXplJywKICAgIHNjcm9sbDogJ3Jlc2l6ZScsCiAgICBjbGljazogJ3JlbW92ZScsCiAgICB0b3VjaG1vdmU6ICdfcHJldmVudERlZmF1bHQnLAogICAgdHJhbnNpdGlvbmVuZDogJ19yZW1vdmVFbGVtZW50cycsCiAgICB3ZWJraXRUcmFuc2l0aW9uRW5kOiAnX3JlbW92ZUVsZW1lbnRzJywKICAgIE1TVHJhbnNpdGlvbkVuZDogJ19yZW1vdmVFbGVtZW50cycKICB9LAoKICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgdmFyIHR5cGUgPSB0aGlzLmV2ZW50c1tlLnR5cGVdOwogICAgaWYgKHR5cGUpIHsKICAgICAgdGhpc1t0eXBlXShlKTsKICAgIH0KICB9LAoKICBzaG93OiBmdW5jdGlvbihmb3JjZSkgewogICAgLy8gaW4gYXV0b3N0YXJ0IG1vZGUgd2FpdCBmb3IgdGhlIGRvY3VtZW50IHRvIGJlIHJlYWR5CiAgICBpZiAodGhpcy5vcHRpb25zLmF1dG9zdGFydCAmJiAhX0RPTVJlYWR5KSB7CiAgICAgIHNldFRpbWVvdXQodGhpcy5zaG93LmJpbmQodGhpcyksIDUwKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIG1lc3NhZ2UgYWxyZWFkeSBvbiBzY3JlZW4KICAgIGlmICh0aGlzLnNob3duKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgbm93ID0gRGF0ZS5ub3coKTsKICAgIHZhciBsYXN0RGlzcGxheVRpbWUgPSB0aGlzLnNlc3Npb24ubGFzdERpc3BsYXlUaW1lOwoKICAgIGlmIChmb3JjZSAhPT0gdHJ1ZSkgewogICAgICAvLyB0aGlzIGlzIG5lZWRlZCBpZiBhdXRvc3RhcnQgaXMgZGlzYWJsZWQgYW5kIHlvdSBwcm9ncmFtbWF0aWNhbGx5IGNhbGwgdGhlIHNob3coKSBtZXRob2QKICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyB3ZSBvYmV5IHRoZSBkaXNwbGF5IHBhY2UgKHByZXZlbnQgdGhlIG1lc3NhZ2UgdG8gcG9wdXAgdG9vIG9mdGVuKQogICAgICBpZiAobm93IC0gbGFzdERpc3BsYXlUaW1lIDwgdGhpcy5vcHRpb25zLmRpc3BsYXlQYWNlICogNjAwMDApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIG9iZXkgdGhlIG1heGltdW0gbnVtYmVyIG9mIGRpc3BsYXkgY291bnQKICAgICAgaWYgKHRoaXMub3B0aW9ucy5tYXhEaXNwbGF5Q291bnQgJiYgdGhpcy5zZXNzaW9uLmRpc3BsYXlDb3VudCA+PSB0aGlzLm9wdGlvbnMubWF4RGlzcGxheUNvdW50KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CgogICAgdGhpcy5zaG93biA9IHRydWU7CgogICAgLy8gaW5jcmVtZW50IHRoZSBkaXNwbGF5IGNvdW50CiAgICB0aGlzLnNlc3Npb24ubGFzdERpc3BsYXlUaW1lID0gbm93OwogICAgdGhpcy5zZXNzaW9uLmRpc3BsYXlDb3VudCsrOwogICAgdGhpcy51cGRhdGVTZXNzaW9uKCk7CgogICAgLy8gdHJ5IHRvIGdldCB0aGUgaGlnaGVzdCByZXNvbHV0aW9uIGFwcGxpY2F0aW9uIGljb24KICAgIGlmICghdGhpcy5hcHBsaWNhdGlvbkljb24pIHsKICAgICAgaWYgKGF0aC5PUyA9PSAnaW9zJykgewogICAgICAgIHRoaXMuYXBwbGljYXRpb25JY29uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCBsaW5rW3JlbF49YXBwbGUtdG91Y2gtaWNvbl1bc2l6ZXM9IjE1MngxNTIiXSxoZWFkIGxpbmtbcmVsXj1hcHBsZS10b3VjaC1pY29uXVtzaXplcz0iMTQ0eDE0NCJdLGhlYWQgbGlua1tyZWxePWFwcGxlLXRvdWNoLWljb25dW3NpemVzPSIxMjB4MTIwIl0saGVhZCBsaW5rW3JlbF49YXBwbGUtdG91Y2gtaWNvbl1bc2l6ZXM9IjExNHgxMTQiXSxoZWFkIGxpbmtbcmVsXj1hcHBsZS10b3VjaC1pY29uXScpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXBwbGljYXRpb25JY29uID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCBsaW5rW3JlbF49InNob3J0Y3V0IGljb24iXVtzaXplcz0iMTk2eDE5NiJdLGhlYWQgbGlua1tyZWxePWFwcGxlLXRvdWNoLWljb25dJyk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgbWVzc2FnZSA9ICcnOwoKICAgIGlmICh0aGlzLm9wdGlvbnMubWVzc2FnZSBpbiBhdGguaW50bCkgewkJLy8geW91IGNhbiBmb3JjZSB0aGUgbG9jYWxlCiAgICAgIG1lc3NhZ2UgPSBhdGguaW50bFt0aGlzLm9wdGlvbnMubWVzc2FnZV0ubWVzc2FnZS5yZXBsYWNlKCclYWN0aW9uJywgYXRoLmludGxbdGhpcy5vcHRpb25zLm1lc3NhZ2VdLmFjdGlvblthdGguT1NdKTsKICAgIH0gZWxzZSBpZiAodGhpcy5vcHRpb25zLm1lc3NhZ2UgIT09ICcnKSB7CQkvLyBvciB1c2UgYSBjdXN0b20gbWVzc2FnZQogICAgICBtZXNzYWdlID0gdGhpcy5vcHRpb25zLm1lc3NhZ2U7CiAgICB9IGVsc2UgewkJCQkJCQkJCQkvLyBvdGhlcndpc2Ugd2UgdXNlIG91ciBtZXNzYWdlCiAgICAgIG1lc3NhZ2UgPSBhdGguaW50bFthdGgubGFuZ3VhZ2VdLm1lc3NhZ2UucmVwbGFjZSgnJWFjdGlvbicsIGF0aC5pbnRsW2F0aC5sYW5ndWFnZV0uYWN0aW9uW2F0aC5PU10pOwogICAgfQoKICAgIC8vIGFkZCB0aGUgYWN0aW9uIGljb24KICAgIG1lc3NhZ2UgPSAnPHA+JyArIG1lc3NhZ2UucmVwbGFjZSgnJWljb24nLCAnPHNwYW4gY2xhc3M9ImF0aC1hY3Rpb24taWNvbiI+aWNvbjwvc3Bhbj4nKSArICc8L3A+JzsKCiAgICAvLyBjcmVhdGUgdGhlIG1lc3NhZ2UgY29udGFpbmVyCiAgICB0aGlzLnZpZXdwb3J0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB0aGlzLnZpZXdwb3J0LmNsYXNzTmFtZSA9ICdhdGgtdmlld3BvcnQnOwogICAgaWYgKHRoaXMub3B0aW9ucy5tb2RhbCkgewogICAgICB0aGlzLnZpZXdwb3J0LmNsYXNzTmFtZSArPSAnIGF0aC1tb2RhbCc7CiAgICB9CiAgICBpZiAodGhpcy5vcHRpb25zLm1hbmRhdG9yeSkgewogICAgICB0aGlzLnZpZXdwb3J0LmNsYXNzTmFtZSArPSAnIGF0aC1tYW5kYXRvcnknOwogICAgfQogICAgdGhpcy52aWV3cG9ydC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CgogICAgLy8gY3JlYXRlIHRoZSBhY3R1YWwgbWVzc2FnZSBlbGVtZW50CiAgICB0aGlzLmVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHRoaXMuZWxlbWVudC5jbGFzc05hbWUgPSAnYXRoLWNvbnRhaW5lciBhdGgtJyArIGF0aC5PUyArICcgYXRoLScgKyBhdGguT1MgKyAoYXRoLk9TVmVyc2lvbiArICcnKS5zdWJzdHIoMCwgMSkgKyAnIGF0aC0nICsgKGF0aC5pc1RhYmxldCA/ICd0YWJsZXQnIDogJ3Bob25lJyk7CiAgICB0aGlzLmVsZW1lbnQuc3R5bGUuY3NzVGV4dCA9ICctd2Via2l0LXRyYW5zaXRpb24tcHJvcGVydHk6LXdlYmtpdC10cmFuc2Zvcm0sb3BhY2l0eTstd2Via2l0LXRyYW5zaXRpb24tZHVyYXRpb246MDstd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7dHJhbnNpdGlvbi1wcm9wZXJ0eTp0cmFuc2Zvcm0sb3BhY2l0eTt0cmFuc2l0aW9uLWR1cmF0aW9uOjA7dHJhbnNmb3JtOnRyYW5zbGF0ZTNkKDAsMCwwKTstd2Via2l0LXRyYW5zaXRpb24tdGltaW5nLWZ1bmN0aW9uOmVhc2Utb3V0JzsKICAgIHRoaXMuZWxlbWVudC5zdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSAndHJhbnNsYXRlM2QoMCwtJyArIHdpbmRvdy5pbm5lckhlaWdodCArICdweCwwKSc7CiAgICB0aGlzLmVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gJzBzJzsKCiAgICAvLyBhZGQgdGhlIGFwcGxpY2F0aW9uIGljb24KICAgIGlmICh0aGlzLm9wdGlvbnMuaWNvbiAmJiB0aGlzLmFwcGxpY2F0aW9uSWNvbikgewogICAgICB0aGlzLmVsZW1lbnQuY2xhc3NOYW1lICs9ICcgYXRoLWljb24nOwogICAgICB0aGlzLmltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgICB0aGlzLmltZy5jbGFzc05hbWUgPSAnYXRoLWFwcGxpY2F0aW9uLWljb24nOwogICAgICB0aGlzLmltZy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgdGhpcywgZmFsc2UpOwogICAgICB0aGlzLmltZy5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIHRoaXMsIGZhbHNlKTsKCiAgICAgIHRoaXMuaW1nLnNyYyA9IHRoaXMuYXBwbGljYXRpb25JY29uLmhyZWY7CiAgICAgIHRoaXMuZWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLmltZyk7CiAgICB9CgogICAgdGhpcy5lbGVtZW50LmlubmVySFRNTCArPSBtZXNzYWdlOwoKICAgIC8vIHdlIGFyZSBub3QgcmVhZHkgdG8gc2hvdywgcGxhY2UgdGhlIG1lc3NhZ2Ugb3V0IG9mIHNpZ2h0CiAgICB0aGlzLnZpZXdwb3J0LnN0eWxlLmxlZnQgPSAnLTk5OTk5ZW0nOwoKICAgIC8vIGF0dGFjaCBhbGwgZWxlbWVudHMgdG8gdGhlIERPTQogICAgdGhpcy52aWV3cG9ydC5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQpOwogICAgdGhpcy5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy52aWV3cG9ydCk7CgogICAgLy8gaWYgd2UgZG9uJ3QgaGF2ZSB0byB3YWl0IGZvciBhbiBpbWFnZSB0byBsb2FkLCBzaG93IHRoZSBtZXNzYWdlIHJpZ2h0IGF3YXkKICAgIGlmICghdGhpcy5pbWcpIHsKICAgICAgdGhpcy5fZGVsYXllZFNob3coKTsKICAgIH0KICB9LAoKICBfZGVsYXllZFNob3c6IGZ1bmN0aW9uKGUpIHsKICAgIHNldFRpbWVvdXQodGhpcy5fc2hvdy5iaW5kKHRoaXMpLCB0aGlzLm9wdGlvbnMuc3RhcnREZWxheSAqIDEwMDAgKyA1MDApOwogIH0sCgogIF9zaG93OiBmdW5jdGlvbigpIHsKICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICAvLyB1cGRhdGUgdGhlIHZpZXdwb3J0IHNpemUgYW5kIG9yaWVudGF0aW9uCiAgICB0aGlzLnVwZGF0ZVZpZXdwb3J0KCk7CgogICAgLy8gcmVwb3NpdGlvbi9yZXNpemUgdGhlIG1lc3NhZ2Ugb24gb3JpZW50YXRpb24gY2hhbmdlCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcywgZmFsc2UpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMsIGZhbHNlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIHRoaXMsIGZhbHNlKTsKCiAgICBpZiAodGhpcy5vcHRpb25zLm1vZGFsKSB7CiAgICAgIC8vIGxvY2sgYW55IG90aGVyIGludGVyYWN0aW9uCiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMsIHRydWUpOwogICAgfQoKICAgIC8vIEVuYWJsZSBjbG9zaW5nIGFmdGVyIDEgc2Vjb25kCiAgICBpZiAoIXRoaXMub3B0aW9ucy5tYW5kYXRvcnkpIHsKICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICB0aGF0LmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGF0LCB0cnVlKTsKICAgICAgfSwgMTAwMCk7CiAgICB9CgogICAgLy8ga2ljayB0aGUgYW5pbWF0aW9uCiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICB0aGF0LmVsZW1lbnQuc3R5bGUud2Via2l0VHJhbnNmb3JtID0gJ3RyYW5zbGF0ZTNkKDAsMCwwKSc7CiAgICAgIHRoYXQuZWxlbWVudC5zdHlsZS53ZWJraXRUcmFuc2l0aW9uRHVyYXRpb24gPSAnMS4ycyc7CiAgICB9LCAwKTsKCiAgICAvLyBzZXQgdGhlIGRlc3Ryb3kgdGltZXIKICAgIGlmICh0aGlzLm9wdGlvbnMubGlmZXNwYW4pIHsKICAgICAgdGhpcy5yZW1vdmVUaW1lciA9IHNldFRpbWVvdXQodGhpcy5yZW1vdmUuYmluZCh0aGlzKSwgdGhpcy5vcHRpb25zLmxpZmVzcGFuICogMTAwMCk7CiAgICB9CgogICAgLy8gZmlyZSB0aGUgY3VzdG9tIG9uU2hvdyBldmVudAogICAgaWYgKHRoaXMub3B0aW9ucy5vblNob3cpIHsKICAgICAgdGhpcy5vcHRpb25zLm9uU2hvdy5jYWxsKHRoaXMpOwogICAgfQogIH0sCgogIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICBjbGVhclRpbWVvdXQodGhpcy5yZW1vdmVUaW1lcik7CgogICAgLy8gY2xlYXIgdXAgdGhlIGV2ZW50IGxpc3RlbmVycwogICAgaWYgKHRoaXMuaW1nKSB7CiAgICAgIHRoaXMuaW1nLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCB0aGlzLCBmYWxzZSk7CiAgICAgIHRoaXMuaW1nLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2Vycm9yJywgdGhpcywgZmFsc2UpOwogICAgfQoKICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLCBmYWxzZSk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcywgZmFsc2UpOwogICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgdGhpcywgZmFsc2UpOwogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcywgdHJ1ZSk7CiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLCB0cnVlKTsKCiAgICAvLyByZW1vdmUgdGhlIG1lc3NhZ2UgZWxlbWVudCBvbiB0cmFuc2l0aW9uIGVuZAogICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCB0aGlzLCBmYWxzZSk7CiAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2Via2l0VHJhbnNpdGlvbkVuZCcsIHRoaXMsIGZhbHNlKTsKICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdNU1RyYW5zaXRpb25FbmQnLCB0aGlzLCBmYWxzZSk7CgogICAgLy8gc3RhcnQgdGhlIGZhZGUgb3V0IGFuaW1hdGlvbgogICAgdGhpcy5lbGVtZW50LnN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9ICcwLjNzJzsKICAgIHRoaXMuZWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gJzAnOwogIH0sCgogIF9yZW1vdmVFbGVtZW50czogZnVuY3Rpb24oKSB7CiAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsIHRoaXMsIGZhbHNlKTsKICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd3ZWJraXRUcmFuc2l0aW9uRW5kJywgdGhpcywgZmFsc2UpOwogICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ01TVHJhbnNpdGlvbkVuZCcsIHRoaXMsIGZhbHNlKTsKCiAgICAvLyByZW1vdmUgdGhlIG1lc3NhZ2UgZnJvbSB0aGUgRE9NCiAgICB0aGlzLmNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzLnZpZXdwb3J0KTsKCiAgICB0aGlzLnNob3duID0gZmFsc2U7CgogICAgLy8gZmlyZSB0aGUgY3VzdG9tIG9uUmVtb3ZlIGV2ZW50CiAgICBpZiAodGhpcy5vcHRpb25zLm9uUmVtb3ZlKSB7CiAgICAgIHRoaXMub3B0aW9ucy5vblJlbW92ZS5jYWxsKHRoaXMpOwogICAgfQogIH0sCgogIHVwZGF0ZVZpZXdwb3J0OiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5zaG93bikgewogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy52aWV3cG9ydC5zdHlsZS53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoICsgJ3B4JzsKICAgIHRoaXMudmlld3BvcnQuc3R5bGUuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0ICsgJ3B4JzsKICAgIHRoaXMudmlld3BvcnQuc3R5bGUubGVmdCA9IHdpbmRvdy5zY3JvbGxYICsgJ3B4JzsKICAgIHRoaXMudmlld3BvcnQuc3R5bGUudG9wID0gd2luZG93LnNjcm9sbFkgKyAncHgnOwoKICAgIHZhciBjbGllbnRXaWR0aCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsKCiAgICB0aGlzLm9yaWVudGF0aW9uID0gY2xpZW50V2lkdGggPiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0ID8gJ2xhbmRzY2FwZScgOiAncG9ydHJhaXQnOwoKICAgIHZhciBzY3JlZW5XaWR0aCA9IGF0aC5PUyA9PSAnaW9zJyA/IHRoaXMub3JpZW50YXRpb24gPT0gJ3BvcnRyYWl0JyA/IHNjcmVlbi53aWR0aCA6IHNjcmVlbi5oZWlnaHQgOiBzY3JlZW4ud2lkdGg7CiAgICB0aGlzLnNjYWxlID0gc2NyZWVuLndpZHRoID4gY2xpZW50V2lkdGggPyAxIDogc2NyZWVuV2lkdGggLyB3aW5kb3cuaW5uZXJXaWR0aDsKCiAgICB0aGlzLmVsZW1lbnQuc3R5bGUuZm9udFNpemUgPSB0aGlzLm9wdGlvbnMuZm9udFNpemUgLyB0aGlzLnNjYWxlICsgJ3B4JzsKICB9LAoKICByZXNpemU6IGZ1bmN0aW9uKCkgewogICAgY2xlYXJUaW1lb3V0KHRoaXMucmVzaXplVGltZXIpOwogICAgdGhpcy5yZXNpemVUaW1lciA9IHNldFRpbWVvdXQodGhpcy51cGRhdGVWaWV3cG9ydC5iaW5kKHRoaXMpLCAxMDApOwogIH0sCgogIHVwZGF0ZVNlc3Npb246IGZ1bmN0aW9uKCkgewogICAgaWYgKGF0aC5oYXNMb2NhbFN0b3JhZ2UgPT09IGZhbHNlKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLm9wdGlvbnMuYXBwSUQsIEpTT04uc3RyaW5naWZ5KHRoaXMuc2Vzc2lvbikpOwogIH0sCgogIGNsZWFyU2Vzc2lvbjogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnNlc3Npb24gPSBfZGVmYXVsdFNlc3Npb247CiAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKICB9LAoKICBvcHRPdXQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZXNzaW9uLm9wdGVkb3V0ID0gdHJ1ZTsKICAgIHRoaXMudXBkYXRlU2Vzc2lvbigpOwogIH0sCgogIG9wdEluOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuc2Vzc2lvbi5vcHRlZG91dCA9IGZhbHNlOwogICAgdGhpcy51cGRhdGVTZXNzaW9uKCk7CiAgfSwKCiAgY2xlYXJEaXNwbGF5Q291bnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5zZXNzaW9uLmRpc3BsYXlDb3VudCA9IDA7CiAgICB0aGlzLnVwZGF0ZVNlc3Npb24oKTsKICB9LAoKICBfcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgfQp9OwoKLy8gdXRpbGl0eQpmdW5jdGlvbiBfZXh0ZW5kKHRhcmdldCwgb2JqKSB7CiAgZm9yICh2YXIgaSBpbiBvYmopIHsKICAgIHRhcmdldFtpXSA9IG9ialtpXTsKICB9CgogIHJldHVybiB0YXJnZXQ7Cn0KCmZ1bmN0aW9uIF9yZW1vdmVUb2tlbigpIHsKICBpZiAoZG9jdW1lbnQubG9jYXRpb24uaGFzaCA9PSAnI2F0aCcpIHsKICAgIGhpc3RvcnkucmVwbGFjZVN0YXRlKCcnLCB3aW5kb3cuZG9jdW1lbnQudGl0bGUsIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVswXSk7CiAgfQoKICBpZiAoX3JlU21hcnRVUkwudGVzdChkb2N1bWVudC5sb2NhdGlvbi5ocmVmKSkgewogICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUoJycsIHdpbmRvdy5kb2N1bWVudC50aXRsZSwgZG9jdW1lbnQubG9jYXRpb24uaHJlZi5yZXBsYWNlKF9yZVNtYXJ0VVJMLCAnJDEnKSk7CiAgfQoKICBpZiAoX3JlUXVlcnlTdHJpbmcudGVzdChkb2N1bWVudC5sb2NhdGlvbi5zZWFyY2gpKSB7CiAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSgnJywgd2luZG93LmRvY3VtZW50LnRpdGxlLCBkb2N1bWVudC5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoX3JlUXVlcnlTdHJpbmcsICckMicpKTsKICB9Cn0KCi8qIGpzaGludCArVzEwMSwgK1cxMDYgKi8KCiQuQU1VSS5hZGRUb0hvbWVzY3JlZW4gPSBhdGg7Cgptb2R1bGUuZXhwb3J0cyA9IGF0aDsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:55:09 GMT",
                    "Content-Length": "19284",
                    "Date": "Thu, 06 Nov 2014 06:55:11 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}