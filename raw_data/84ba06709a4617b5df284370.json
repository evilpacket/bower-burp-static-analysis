{
    "url": "http://localhost:9999/saschagehlich/string_score/tests/testrunner.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.href</b> via the following statement:<ul><li>location.href = location.href.match(/^(.+?)(\\?.*)?$/)[1] + \"?\" + encodeURIComponent($.trim(target.text()));</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/saschagehlich/string_score/tests/testrunner.js",
                "path": "/saschagehlich/string_score/tests/testrunner.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zYXNjaGFnZWhsaWNoL3N0cmluZ19zY29yZS90ZXN0cy90ZXN0cnVubmVyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjI2MjYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFNhdCwgMDggTm92IDIwMTQgMTQ6NTY6MDkgR01UDQpMYXN0LU1vZGlmaWVkOiBTYXQsIDA4IE5vdiAyMDE0IDE0OjU2OjA5IEdNVA0KDQovKgogKiBRVW5pdCAtIGpRdWVyeSB1bml0IHRlc3RydW5uZXIKICogCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vUVVuaXQKICoKICogQ29weXJpZ2h0IChjKSAyMDA4IEpvaG4gUmVzaWcsIErDtnJuIFphZWZmZXJlcgogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkKICogYW5kIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICoKICogJElkJAogKi8KCihmdW5jdGlvbigkKSB7CgovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLgovLyBEaXNjdXNzaW9ucyBhbmQgcmVmZXJlbmNlOiBodHRwOi8vcGhpbHJhdGhlLmNvbS9hcnRpY2xlcy9lcXVpdgovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYKLy8gQXV0aG9yOiBQaGlsaXBwZSBSYXRow6kgPHByYXRoZUBnbWFpbC5jb20+CnZhciBlcXVpdiA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24KICAgIHZhciBjYWxsZXJzID0gW107IC8vIHN0YWNrIHRvIGRlY2lkZSBiZXR3ZWVuIHNraXAvYWJvcnQgZnVuY3Rpb25zCgoKICAgIC8vIERldGVybWluZSB3aGF0IGlzIG8uCiAgICBmdW5jdGlvbiBob296aXQobykgewogICAgICAgIGlmIChvLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwogICAgICAgICAgICAKICAgICAgICB9IGVsc2UgaWYgKG8uY29uc3RydWN0b3IgPT09IEJvb2xlYW4pIHsKICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKCiAgICAgICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBOdW1iZXIpIHsKCiAgICAgICAgICAgIGlmIChpc05hTihvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJuYW4iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QKICAgICAgICB9IGVsc2UgaWYgKG8gPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CiAgICAgICAgCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBuZXcgRGF0ZSgpID09PSBvYmplY3QKICAgICAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICAgIHJldHVybiAiZGF0ZSI7CgogICAgICAgIC8vIGNvbnNpZGVyOiAvLi8gaW5zdGFuY2VvZiBPYmplY3Q7CiAgICAgICAgLy8gICAgICAgICAgIC8uLyBpbnN0YW5jZW9mIFJlZ0V4cDsKICAgICAgICAvLyAgICAgICAgICB0eXBlb2YgLy4vID09PSAiZnVuY3Rpb24iOyAvLyA9PiBmYWxzZSBpbiBJRSBhbmQgT3BlcmEsCiAgICAgICAgLy8gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnVlIGluIEZGIGFuZCBTYWZhcmkKICAgICAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuICJyZWdleHAiOwoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CgogICAgICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7CiAgICAgICAgICAgIHJldHVybiAiZnVuY3Rpb24iOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfQogICAgfQoKICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICBmdW5jdGlvbiBiaW5kQ2FsbGJhY2tzKG8sIGNhbGxiYWNrcywgYXJncykgewogICAgICAgIHZhciBwcm9wID0gaG9veml0KG8pOwogICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgIGlmIChob296aXQoY2FsbGJhY2tzW3Byb3BdKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXTsgLy8gb3IgdW5kZWZpbmVkCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY2FsbGVyICE9PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICBpZiAoICEgKGhvb3ppdChiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAoKICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7Cgp2YXIgR0VUUGFyYW1zID0gJC5tYXAoIGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpLCBkZWNvZGVVUklDb21wb25lbnQgKSwKCW5naW5kZXggPSAkLmluQXJyYXkoIm5vZ2xvYmFscyIsIEdFVFBhcmFtcyksCglub2dsb2JhbHMgPSBuZ2luZGV4ICE9PSAtMTsKCmlmKCBub2dsb2JhbHMgKQoJR0VUUGFyYW1zLnNwbGljZSggbmdpbmRleCwgMSApOwoJCnZhciBjb25maWcgPSB7CglzdGF0czogewoJCWFsbDogMCwKCQliYWQ6IDAKCX0sCglxdWV1ZTogW10sCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQoJYmxvY2tpbmc6IHRydWUsCgkvL3Jlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCWZpbHRlcnM6IEdFVFBhcmFtcywKCWlzTG9jYWw6ICEhKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCA9PSAnZmlsZTonKQp9OwoKLy8gcHVibGljIEFQSSBhcyBnbG9iYWwgbWV0aG9kcwokLmV4dGVuZCh3aW5kb3csIHsKCXRlc3Q6IHRlc3QsCgltb2R1bGU6IG1vZHVsZSwKCWV4cGVjdDogZXhwZWN0LAoJb2s6IG9rLAoJZXF1YWxzOiBlcXVhbHMsCglzdGFydDogc3RhcnQsCglzdG9wOiBzdG9wLAoJcmVzZXQ6IHJlc2V0LAoJaXNMb2NhbDogY29uZmlnLmlzTG9jYWwsCglzYW1lOiBmdW5jdGlvbihhLCBiLCBtZXNzYWdlKSB7CgkJcHVzaChlcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7Cgl9LAoJUVVuaXQ6IHsKCQllcXVpdjogZXF1aXYsCgkJb2s6IG9rLAoJCWRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCl7fSwKCQlsb2c6IGZ1bmN0aW9uKHJlc3VsdCwgbWVzc2FnZSl7fQoJfSwKCS8vIGxlZ2FjeSBtZXRob2RzIGJlbG93Cglpc1NldDogaXNTZXQsCglpc09iajogaXNPYmosCgljb21wYXJlOiBmdW5jdGlvbigpIHsKCQl0aHJvdyAiY29tcGFyZSBpcyBkZXByZWNhdGVkIC0gdXNlIHNhbWUoKSBpbnN0ZWFkIjsKCX0sCgljb21wYXJlMjogZnVuY3Rpb24oKSB7CgkJdGhyb3cgImNvbXBhcmUyIGlzIGRlcHJlY2F0ZWQgLSB1c2Ugc2FtZSgpIGluc3RlYWQiOwoJfSwKCXNlcmlhbEFycmF5OiBmdW5jdGlvbigpIHsKCQl0aHJvdyAic2VyaWFsQXJyYXkgaXMgZGVwcmVjYXRlZCAtIHVzZSBqc0R1bXAucGFyc2UoKSBpbnN0ZWFkIjsKCX0sCglxOiBxLAoJdDogdCwKCXVybDogdXJsLAoJdHJpZ2dlckV2ZW50OiB0cmlnZ2VyRXZlbnQKfSk7CgokKHdpbmRvdykubG9hZChmdW5jdGlvbigpIHsKCQoJaWYgKCEkKCIjaGVhZGVyLCAjYmFubmVyLCAjdXNlckFnZW50LCAjdGVzdHMiKS5sZW5ndGgpIHsKCQkkKCdib2R5JykucHJlcGVuZCgKCQkJJzxoMSBpZD0iaGVhZGVyIj4nICsgZG9jdW1lbnQudGl0bGUgKyAnPC9oMT4nICsKCQkJJzxoMiBpZD0iYmFubmVyIj48L2gyPicgKwoJCQknPGgyIGlkPSJ1c2VyQWdlbnQiPjwvaDI+JyArCgkJCSc8b2wgaWQ9InRlc3RzIj48L29sPicKCQkpOwoJfQoJCgkkKCcjdXNlckFnZW50JykuaHRtbChuYXZpZ2F0b3IudXNlckFnZW50KTsKCXZhciBoZWFkID0gJCgnPGRpdiBjbGFzcz0idGVzdHJ1bm5lci10b29sYmFyIj48bGFiZWwgZm9yPSJmaWx0ZXItcGFzcyI+SGlkZSBwYXNzZWQgdGVzdHM8L2xhYmVsPjwvZGl2PicpLmluc2VydEFmdGVyKCIjdXNlckFnZW50Iik7CgkkKCc8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJmaWx0ZXItcGFzcyIgLz4nKS5hdHRyKCJkaXNhYmxlZCIsIHRydWUpLnByZXBlbmRUbyhoZWFkKS5jbGljayhmdW5jdGlvbigpIHsKCQkkKCdsaS5wYXNzJylbdGhpcy5jaGVja2VkID8gJ2hpZGUnIDogJ3Nob3cnXSgpOwoJfSk7CgkkKCc8aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJmaWx0ZXItbWlzc2luZyI+JykuYXR0cigiZGlzYWJsZWQiLCB0cnVlKS5hcHBlbmRUbyhoZWFkKS5jbGljayhmdW5jdGlvbigpIHsKCQkkKCJsaS5mYWlsOmNvbnRhaW5zKCdtaXNzaW5nIHRlc3QgLSB1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlJykiKS5wYXJlbnQoJ29sJykucGFyZW50KCdsaS5mYWlsJylbdGhpcy5jaGVja2VkID8gJ2hpZGUnIDogJ3Nob3cnXSgpOwoJfSk7CgkkKCIjZmlsdGVyLW1pc3NpbmciKS5hZnRlcignPGxhYmVsIGZvcj0iZmlsdGVyLW1pc3NpbmciPkhpZGUgbWlzc2luZyB0ZXN0cyAodW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZSk8L2xhYmVsPicpOwoJcnVuVGVzdCgpOwkKfSk7CgpmdW5jdGlvbiBzeW5jaHJvbml6ZShjYWxsYmFjaykgewoJY29uZmlnLnF1ZXVlLnB1c2goY2FsbGJhY2spOwoJaWYoIWNvbmZpZy5ibG9ja2luZykgewoJCXByb2Nlc3MoKTsKCX0KfQoKZnVuY3Rpb24gcHJvY2VzcygpIHsKCXdoaWxlKGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZykgewoJCWNvbmZpZy5xdWV1ZS5zaGlmdCgpKCk7Cgl9Cn0KCmZ1bmN0aW9uIHN0b3AodGltZW91dCkgewoJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCWlmICh0aW1lb3V0KQoJCWNvbmZpZy50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CgkJCXN0YXJ0KCk7CgkJfSwgdGltZW91dCk7Cn0KZnVuY3Rpb24gc3RhcnQoKSB7CgkvLyBBIHNsaWdodCBkZWxheSwgdG8gYXZvaWQgYW55IGN1cnJlbnQgY2FsbGJhY2tzCglzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCWlmKGNvbmZpZy50aW1lb3V0KQoJCQljbGVhclRpbWVvdXQoY29uZmlnLnRpbWVvdXQpOwoJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCXByb2Nlc3MoKTsKCX0sIDEzKTsKfQoKZnVuY3Rpb24gdmFsaWRUZXN0KCBuYW1lICkgewoJdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsCgkJcnVuID0gZmFsc2U7CgoJaWYoICFpICkKCQlyZXR1cm4gdHJ1ZTsKCQoJd2hpbGUoIGktLSApewoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7CgkJaWYoIG5vdCApIAoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7CgkJaWYoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9IC0xICkKCQkJcmV0dXJuICFub3Q7CgkJaWYoIG5vdCApCgkJCXJ1biA9IHRydWU7Cgl9CglyZXR1cm4gcnVuOwp9CgpmdW5jdGlvbiBydW5UZXN0KCkgewoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7Cgl2YXIgc3RhcnRlZCA9ICtuZXcgRGF0ZTsKCWNvbmZpZy5maXh0dXJlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4nKS5pbm5lckhUTUw7Cgljb25maWcuYWpheFNldHRpbmdzID0gJC5hamF4U2V0dGluZ3M7CglzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkkKCc8cCBpZD0idGVzdHJlc3VsdCIgY2xhc3M9InJlc3VsdCIvPicpLmh0bWwoWydUZXN0cyBjb21wbGV0ZWQgaW4gJywKCQkJK25ldyBEYXRlIC0gc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAoJCQknPHNwYW4gY2xhc3M9ImJhZCI+JywgY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJhbGwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgJywgY29uZmlnLnN0YXRzLmJhZCwnIGZhaWxlZC4nXQoJCQkuam9pbignJykpCgkJCS5hcHBlbmRUbygiYm9keSIpOwoJCSQoIiNiYW5uZXIiKS5hZGRDbGFzcyhjb25maWcuc3RhdHMuYmFkID8gImZhaWwiIDogInBhc3MiKTsKCQlRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7Cgl9KTsKfQoKdmFyIHBvbGx1dGlvbjsKCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKXsKCXBvbGx1dGlvbiA9IFsgXTsKCQoJaWYoIG5vZ2xvYmFscyApCgkJZm9yKCB2YXIga2V5IGluIHdpbmRvdyApCgkJCXBvbGx1dGlvbi5wdXNoKGtleSk7Cn0KZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKXsKCXZhciBvbGQgPSBwb2xsdXRpb247CglzYXZlR2xvYmFsKCk7CgkKCWlmKCBwb2xsdXRpb24ubGVuZ3RoID4gb2xkLmxlbmd0aCApewoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGlmZihvbGQsIHBvbGx1dGlvbikuam9pbigiLCAiKSApOwoJCWNvbmZpZy5leHBlY3RlZCsrOwoJfQp9CgpmdW5jdGlvbiBkaWZmKCBjbGVhbiwgZGlydHkgKXsKCXJldHVybiAkLmdyZXAoIGRpcnR5LCBmdW5jdGlvbihuYW1lKXsKCQlyZXR1cm4gJC5pbkFycmF5KCBuYW1lLCBjbGVhbiApID09IC0xOwoJfSk7Cn0KCmZ1bmN0aW9uIHRlc3QobmFtZSwgY2FsbGJhY2spIHsKCWlmKGNvbmZpZy5jdXJyZW50TW9kdWxlKQoJCW5hbWUgPSBjb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiA8c3Bhbj4iICsgbmFtZSArICI8L3NwYW4+IjsKCXZhciBsaWZlY3ljbGUgPSAkLmV4dGVuZCh7CgkJc2V0dXA6IGZ1bmN0aW9uKCkge30sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkge30KCX0sIGNvbmZpZy5tb2R1bGVMaWZlY3ljbGUpOwoJCglpZiAoICF2YWxpZFRlc3QobmFtZSkgKQoJCXJldHVybjsKCQoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJY29uZmlnLmFzc2VydGlvbnMgPSBbXTsKCQljb25maWcuZXhwZWN0ZWQgPSBudWxsOwoJCXRyeSB7CgkJCWlmKCAhcG9sbHV0aW9uICkKCQkJCXNhdmVHbG9iYWwoKTsKCQkJbGlmZWN5Y2xlLnNldHVwKCk7CgkJfSBjYXRjaChlKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQl9Cgl9KQoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJY2FsbGJhY2soKTsKCQl9IGNhdGNoKGUpIHsKCQkJaWYoIHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCQkJY29uc29sZS5lcnJvcigiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiKTsKCQkJCWNvbnNvbGUuZXJyb3IoZSk7CgkJCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgkJCX0KCQkJUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSApOwoJCQkvLyBlbHNlIG5leHQgdGVzdCB3aWxsIGNhcnJ5IHRoZSByZXNwb25zaWJpbGl0eQoJCQlzYXZlR2xvYmFsKCk7CgkJfQoJfSk7CglzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQl0cnkgewoJCQljaGVja1BvbGx1dGlvbigpOwoJCQlsaWZlY3ljbGUudGVhcmRvd24oKTsKCQl9IGNhdGNoKGUpIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCX0KCX0pCglzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQl0cnkgewoJCQlyZXNldCgpOwoJCX0gY2F0Y2goZSkgewoJCQlpZiggdHlwZW9mIGNvbnNvbGUgIT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7CgkJCQljb25zb2xlLmVycm9yKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIG5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiKTsKCQkJCWNvbnNvbGUuZXJyb3IoZSk7CgkJCQljb25zb2xlLndhcm4ocmVzZXQudG9TdHJpbmcoKSk7CgkJCX0KCQl9CgkJCgkJaWYoY29uZmlnLmV4cGVjdGVkICYmIGNvbmZpZy5leHBlY3RlZCAhPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGgpIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiRXhwZWN0ZWQgIiArIGNvbmZpZy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOwoJCX0KCQkKCQl2YXIgZ29vZCA9IDAsIGJhZCA9IDA7CgkJdmFyIG9sICA9ICQoIjxvbC8+IikuaGlkZSgpOwoJCWNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQl2YXIgYXNzZXJ0aW9uID0gY29uZmlnLmFzc2VydGlvbnNbaV07CgkJCSQoIjxsaS8+IikuYWRkQ2xhc3MoYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIikudGV4dChhc3NlcnRpb24ubWVzc2FnZSB8fCAiKG5vIG1lc3NhZ2UpIikuYXBwZW5kVG8ob2wpOwoJCQlhc3NlcnRpb24ucmVzdWx0ID8gZ29vZCsrIDogYmFkKys7CgkJfQoJCWNvbmZpZy5zdGF0cy5iYWQgKz0gYmFkOwoJCgkJdmFyIGIgPSAkKCI8c3Ryb25nLz4iKS5odG1sKG5hbWUgKyAiIDxiIHN0eWxlPSdjb2xvcjpibGFjazsnPig8YiBjbGFzcz0nZmFpbCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzcyc+IiArIGdvb2QgKyAiPC9iPiwgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiIpCgkJLmNsaWNrKGZ1bmN0aW9uKCl7CgkJCSQodGhpcykubmV4dCgpLnRvZ2dsZSgpOwoJCX0pCgkJLmRibGNsaWNrKGZ1bmN0aW9uKGV2ZW50KSB7CgkJCXZhciB0YXJnZXQgPSAkKGV2ZW50LnRhcmdldCkuZmlsdGVyKCJzdHJvbmciKS5jbG9uZSgpOwoJCQlpZiAoIHRhcmdldC5sZW5ndGggKSB7CgkJCQl0YXJnZXQuY2hpbGRyZW4oKS5yZW1vdmUoKTsKCQkJCWxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KCQudHJpbSh0YXJnZXQudGV4dCgpKSk7CgkJCX0KCQl9KTsKCQkKCQkkKCI8bGkvPiIpLmFkZENsYXNzKGJhZCA/ICJmYWlsIiA6ICJwYXNzIikuYXBwZW5kKGIpLmFwcGVuZChvbCkuYXBwZW5kVG8oIiN0ZXN0cyIpOwoJCgkJaWYoYmFkKSB7CgkJCSQoIiNmaWx0ZXItcGFzcyIpLmF0dHIoImRpc2FibGVkIiwgbnVsbCk7CgkJCSQoIiNmaWx0ZXItbWlzc2luZyIpLmF0dHIoImRpc2FibGVkIiwgbnVsbCk7CgkJfQoJfSk7Cn0KCi8vIGNhbGwgb24gc3RhcnQgb2YgbW9kdWxlIHRlc3QgdG8gcHJlcGVuZCBuYW1lIHRvIGFsbCB0ZXN0cwpmdW5jdGlvbiBtb2R1bGUobmFtZSwgbGlmZWN5Y2xlKSB7Cgljb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7Cgljb25maWcubW9kdWxlTGlmZWN5Y2xlID0gbGlmZWN5Y2xlOwp9CgovKioKICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgogKi8KZnVuY3Rpb24gZXhwZWN0KGFzc2VydHMpIHsKCWNvbmZpZy5leHBlY3RlZCA9IGFzc2VydHM7Cn0KCi8qKgogKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KICovCmZ1bmN0aW9uIHJlc2V0KCkgewoJJCgiI21haW4iKS5odG1sKCBjb25maWcuZml4dHVyZSApOwoJJC5ldmVudC5nbG9iYWwgPSB7fTsKCSQuYWpheFNldHRpbmdzID0gJC5leHRlbmQoe30sIGNvbmZpZy5hamF4U2V0dGluZ3MpOwp9CgovKioKICogQXNzZXJ0cyB0cnVlLgogKiBAZXhhbXBsZSBvayggJCgiYSIpLnNpemUoKSA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgYW5jaG9ycyIgKTsKICovCmZ1bmN0aW9uIG9rKGEsIG1zZykgewoJUVVuaXQubG9nKGEsIG1zZyk7CgoJY29uZmlnLmFzc2VydGlvbnMucHVzaCh7CgkJcmVzdWx0OiAhIWEsCgkJbWVzc2FnZTogbXNnCgl9KTsKfQoKLyoqCiAqIEFzc2VydHMgdGhhdCB0d28gYXJyYXlzIGFyZSB0aGUgc2FtZQogKi8KZnVuY3Rpb24gaXNTZXQoYSwgYiwgbXNnKSB7CglmdW5jdGlvbiBzZXJpYWxBcnJheSggYSApIHsKCQl2YXIgciA9IFtdOwoJCQoJCWlmICggYSAmJiBhLmxlbmd0aCApCgkgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKysgKSB7CgkgICAgICAgICAgICB2YXIgc3RyID0gYVtpXS5ub2RlTmFtZTsKCSAgICAgICAgICAgIGlmICggc3RyICkgewoJICAgICAgICAgICAgICAgIHN0ciA9IHN0ci50b0xvd2VyQ2FzZSgpOwoJICAgICAgICAgICAgICAgIGlmICggYVtpXS5pZCApCgkgICAgICAgICAgICAgICAgICAgIHN0ciArPSAiIyIgKyBhW2ldLmlkOwoJICAgICAgICAgICAgfSBlbHNlCgkgICAgICAgICAgICAgICAgc3RyID0gYVtpXTsKCSAgICAgICAgICAgIHIucHVzaCggc3RyICk7CgkgICAgICAgIH0KCQoJCXJldHVybiAiWyAiICsgci5qb2luKCIsICIpICsgIiBdIjsKCX0KCXZhciByZXQgPSB0cnVlOwoJaWYgKCBhICYmIGIgJiYgYS5sZW5ndGggIT0gdW5kZWZpbmVkICYmIGEubGVuZ3RoID09IGIubGVuZ3RoICkgewoJCWZvciAoIHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKysgKQoJCQlpZiAoIGFbaV0gIT0gYltpXSApCgkJCQlyZXQgPSBmYWxzZTsKCX0gZWxzZQoJCXJldCA9IGZhbHNlOwoJUVVuaXQub2soIHJldCwgIXJldCA/IChtc2cgKyAiIGV4cGVjdGVkOiAiICsgc2VyaWFsQXJyYXkoYikgKyAiIHJlc3VsdDogIiArIHNlcmlhbEFycmF5KGEpKSA6IG1zZyApOwp9CgovKioKICogQXNzZXJ0cyB0aGF0IHR3byBvYmplY3RzIGFyZSBlcXVpdmFsZW50CiAqLwpmdW5jdGlvbiBpc09iaihhLCBiLCBtc2cpIHsKCXZhciByZXQgPSB0cnVlOwoJCglpZiAoIGEgJiYgYiApIHsKCQlmb3IgKCB2YXIgaSBpbiBhICkKCQkJaWYgKCBhW2ldICE9IGJbaV0gKQoJCQkJcmV0ID0gZmFsc2U7CgoJCWZvciAoIGkgaW4gYiApCgkJCWlmICggYVtpXSAhPSBiW2ldICkKCQkJCXJldCA9IGZhbHNlOwoJfSBlbHNlCgkJcmV0ID0gZmFsc2U7CgogICAgUVVuaXQub2soIHJldCwgbXNnICk7Cn0KCi8qKgogKiBSZXR1cm5zIGFuIGFycmF5IG9mIGVsZW1lbnRzIHdpdGggdGhlIGdpdmVuIElEcywgZWcuCiAqIEBleGFtcGxlIHEoIm1haW4iLCAiZm9vIiwgImJhciIpCiAqIEByZXN1bHQgWzxkaXYgaWQ9Im1haW4iPiwgPHNwYW4gaWQ9ImZvbyI+LCA8aW5wdXQgaWQ9ImJhciI+XQogKi8KZnVuY3Rpb24gcSgpIHsKCXZhciByID0gW107Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKysgKQoJCXIucHVzaCggZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGFyZ3VtZW50c1tpXSApICk7CglyZXR1cm4gcjsKfQoKLyoqCiAqIEFzc2VydHMgdGhhdCBhIHNlbGVjdCBtYXRjaGVzIHRoZSBnaXZlbiBJRHMKICogQGV4YW1wbGUgdCgiQ2hlY2sgZm9yIHNvbWV0aGluZyIsICIvL1thXSIsIFsiZm9vIiwgImJhYXIiXSk7CiAqIEByZXN1bHQgcmV0dXJucyB0cnVlIGlmICIvL1thXSIgcmV0dXJuIHR3byBlbGVtZW50cyB3aXRoIHRoZSBJRHMgJ2ZvbycgYW5kICdiYWFyJwogKi8KZnVuY3Rpb24gdChhLGIsYykgewoJdmFyIGYgPSAkKGIpOwoJdmFyIHMgPSAiIjsKCWZvciAoIHZhciBpID0gMDsgaSA8IGYubGVuZ3RoOyBpKysgKQoJCXMgKz0gKHMgJiYgIiwiKSArICciJyArIGZbaV0uaWQgKyAnIic7Cglpc1NldChmLCBxLmFwcGx5KHEsYyksIGEgKyAiICgiICsgYiArICIpIik7Cn0KCi8qKgogKiBBZGQgcmFuZG9tIG51bWJlciB0byB1cmwgdG8gc3RvcCBJRSBmcm9tIGNhY2hpbmcKICoKICogQGV4YW1wbGUgdXJsKCJkYXRhL3Rlc3QuaHRtbCIpCiAqIEByZXN1bHQgImRhdGEvdGVzdC5odG1sPzEwNTM4MzU4NDI4OTQzIgogKgogKiBAZXhhbXBsZSB1cmwoImRhdGEvdGVzdC5waHA/Zm9vPWJhciIpCiAqIEByZXN1bHQgImRhdGEvdGVzdC5waHA/Zm9vPWJhciYxMDUzODM1ODM0NTU1NCIKICovCmZ1bmN0aW9uIHVybCh2YWx1ZSkgewoJcmV0dXJuIHZhbHVlICsgKC9cPy8udGVzdCh2YWx1ZSkgPyAiJiIgOiAiPyIpICsgbmV3IERhdGUoKS5nZXRUaW1lKCkgKyAiIiArIHBhcnNlSW50KE1hdGgucmFuZG9tKCkqMTAwMDAwKTsKfQoKLyoqCiAqIENoZWNrcyB0aGF0IHRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSBlcXVhbCwgd2l0aCBhbiBvcHRpb25hbCBtZXNzYWdlLgogKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCiAqCiAqIFByZWZlcmVkIHRvIG9rKCBhY3R1YWwgPT0gZXhwZWN0ZWQsIG1lc3NhZ2UgKQogKgogKiBAZXhhbXBsZSBlcXVhbHMoICQuZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsKICoKICogQHBhcmFtIE9iamVjdCBhY3R1YWwKICogQHBhcmFtIE9iamVjdCBleHBlY3RlZAogKiBAcGFyYW0gU3RyaW5nIG1lc3NhZ2UgKG9wdGlvbmFsKQogKi8KZnVuY3Rpb24gZXF1YWxzKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCXB1c2goZXhwZWN0ZWQgPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKfQoKZnVuY3Rpb24gcHVzaChyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCW1lc3NhZ2UgPSBtZXNzYWdlIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CglRVW5pdC5vayggcmVzdWx0LCByZXN1bHQgPyBtZXNzYWdlICsgIjogIiArIGV4cGVjdGVkIDogbWVzc2FnZSArICIsIGV4cGVjdGVkOiAiICsganNEdW1wLnBhcnNlKGV4cGVjdGVkKSArICIgcmVzdWx0OiAiICsganNEdW1wLnBhcnNlKGFjdHVhbCkgKTsKfQoKLyoqCiAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KICoKICogQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7CiAqCiAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0KICogQHBhcmFtIFN0cmluZyB0eXBlCiAqLwpmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoIGVsZW0sIHR5cGUsIGV2ZW50ICkgewoJaWYgKCAkLmJyb3dzZXIubW96aWxsYSB8fCAkLmJyb3dzZXIub3BlcmEgKSB7CgkJZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCgkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCQllbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7Cgl9IGVsc2UgaWYgKCAkLmJyb3dzZXIubXNpZSApIHsKCQllbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOwoJfQp9Cgp9KShqUXVlcnkpOwoKLyoqCiAqIGpzRHVtcAogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkKICogRGF0ZTogNS8xNS8yMDA4CiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogKiBAdmVyc2lvbiAxLjAuMAogKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogKi8KKGZ1bmN0aW9uKCl7CglmdW5jdGlvbiBxdW90ZSggc3RyICl7CgkJcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOwoJfTsKCWZ1bmN0aW9uIGxpdGVyYWwoIG8gKXsKCQlyZXR1cm4gbyArICcnOwkKCX07CglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApewoJCXZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAoJCQliYXNlID0ganNEdW1wLmluZGVudCgpOwoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CgkJaWYoIGFyci5qb2luICkKCQkJYXJyID0gYXJyLmpvaW4oICcsJyArIHMgKyBpbm5lciApOwoJCWlmKCAhYXJyICkKCQkJcmV0dXJuIHByZSArIHBvc3Q7CgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwoJfTsKCWZ1bmN0aW9uIGFycmF5KCBhcnIgKXsKCQl2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwkJCQkJCgkJdGhpcy51cCgpOwoJCXdoaWxlKCBpLS0gKQoJCQlyZXRbaV0gPSB0aGlzLnBhcnNlKCBhcnJbaV0gKTsJCQkJCgkJdGhpcy5kb3duKCk7CgkJcmV0dXJuIGpvaW4oICdbJywgcmV0LCAnXScgKTsKCX07CgkKCXZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsKCQoJdmFyIGpzRHVtcCA9IHdpbmRvdy5qc0R1bXAgPSB7CgkJcGFyc2U6ZnVuY3Rpb24oIG9iaiwgdHlwZSApey8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCgkJCXZhcglwYXJzZXIgPSB0aGlzLnBhcnNlcnNbIHR5cGUgfHwgdGhpcy50eXBlT2Yob2JqKSBdOwoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsJCQkKCQkJCgkJCXJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCggdGhpcywgb2JqICkgOgoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7CgkJfSwKCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApewoJCQl2YXIgdHlwZSA9IHR5cGVvZiBvYmosCgkJCQlmID0gJ2Z1bmN0aW9uJzsvL3dlJ2xsIHVzZSBpdCAzIHRpbWVzLCBzYXZlIGl0CgkJCXJldHVybiB0eXBlICE9ICdvYmplY3QnICYmIHR5cGUgIT0gZiA/IHR5cGUgOgoJCQkJIW9iaiA/ICdudWxsJyA6CgkJCQlvYmouZXhlYyA/ICdyZWdleHAnIDovLyBzb21lIGJyb3dzZXJzIChGRikgY29uc2lkZXIgcmVnZXhwcyBmdW5jdGlvbnMKCQkJCW9iai5nZXRIb3VycyA/ICdkYXRlJyA6CgkJCQlvYmouc2Nyb2xsQnkgPyAgJ3dpbmRvdycgOgoJCQkJb2JqLm5vZGVOYW1lID09ICcjZG9jdW1lbnQnID8gJ2RvY3VtZW50JyA6CgkJCQlvYmoubm9kZU5hbWUgPyAnbm9kZScgOgoJCQkJb2JqLml0ZW0gPyAnbm9kZWxpc3QnIDogLy8gU2FmYXJpIHJlcG9ydHMgbm9kZWxpc3RzIGFzIGZ1bmN0aW9ucwoJCQkJb2JqLmNhbGxlZSA/ICdhcmd1bWVudHMnIDoKCQkJCW9iai5jYWxsIHx8IG9iai5jb25zdHJ1Y3RvciAhPSBBcnJheSAmJiAvL2FuIGFycmF5IHdvdWxkIGFsc28gZmFsbCBvbiB0aGlzIGhhY2sKCQkJCQkob2JqKycnKS5pbmRleE9mKGYpICE9IC0xID8gZiA6IC8vSUUgcmVwb3J0cyBmdW5jdGlvbnMgbGlrZSBhbGVydCwgYXMgb2JqZWN0cwoJCQkJJ2xlbmd0aCcgaW4gb2JqID8gJ2FycmF5JyA6CgkJCQl0eXBlOwoJCX0sCgkJc2VwYXJhdG9yOmZ1bmN0aW9uKCl7CgkJCXJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwoJCX0sCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApey8vIGV4dHJhIGNhbiBiZSBhIG51bWJlciwgc2hvcnRjdXQgZm9yIGluY3JlYXNpbmctY2FsbGluZy1kZWNyZWFzaW5nCgkJCWlmKCAhdGhpcy5tdWx0aWxpbmUgKQoJCQkJcmV0dXJuICcnOwoJCQl2YXIgY2hyID0gdGhpcy5pbmRlbnRDaGFyOwoJCQlpZiggdGhpcy5IVE1MICkKCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOwoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CgkJfSwKCQl1cDpmdW5jdGlvbiggYSApewoJCQl0aGlzLl9kZXB0aF8gKz0gYSB8fCAxOwoJCX0sCgkJZG93bjpmdW5jdGlvbiggYSApewoJCQl0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOwoJCX0sCgkJc2V0UGFyc2VyOmZ1bmN0aW9uKCBuYW1lLCBwYXJzZXIgKXsKCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwoJCX0sCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtCgkJcXVvdGU6cXVvdGUsIAoJCWxpdGVyYWw6bGl0ZXJhbCwKCQlqb2luOmpvaW4sCgkJLy8KCQlfZGVwdGhfOiAxLAoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCgkJcGFyc2Vyczp7CgkJCXdpbmRvdzogJ1tXaW5kb3ddJywKCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuCgkJCXVua25vd246ICdbVW5rbm93bl0nLAoJCQknbnVsbCc6J251bGwnLAoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsCgkJCSdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICl7CgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCQkJCWlmKCBuYW1lICkKCQkJCQlyZXQgKz0gJyAnICsgbmFtZTsKCQkJCXJldCArPSAnKCc7CgkJCQkKCQkJCXJldCA9IFsgcmV0LCB0aGlzLnBhcnNlKCBmbiwgJ2Z1bmN0aW9uQXJncycgKSwgJyl7J10uam9pbignJyk7CgkJCQlyZXR1cm4gam9pbiggcmV0LCB0aGlzLnBhcnNlKGZuLCdmdW5jdGlvbkNvZGUnKSwgJ30nICk7CgkJCX0sCgkJCWFycmF5OiBhcnJheSwKCQkJbm9kZWxpc3Q6IGFycmF5LAoJCQlhcmd1bWVudHM6IGFycmF5LAoJCQlvYmplY3Q6ZnVuY3Rpb24oIG1hcCApewoJCQkJdmFyIHJldCA9IFsgXTsKCQkJCXRoaXMudXAoKTsKCQkJCWZvciggdmFyIGtleSBpbiBtYXAgKQoJCQkJCXJldC5wdXNoKCB0aGlzLnBhcnNlKGtleSwna2V5JykgKyAnOiAnICsgdGhpcy5wYXJzZShtYXBba2V5XSkgKTsKCQkJCXRoaXMuZG93bigpOwoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKCQkJfSwKCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApewoJCQkJdmFyIG9wZW4gPSB0aGlzLkhUTUwgPyAnJmx0OycgOiAnPCcsCgkJCQkJY2xvc2UgPSB0aGlzLkhUTUwgPyAnJmd0OycgOiAnPic7CgkJCQkJCgkJCQl2YXIgdGFnID0gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCXJldCA9IG9wZW4gKyB0YWc7CgkJCQkJCgkJCQlmb3IoIHZhciBhIGluIHRoaXMuRE9NQXR0cnMgKXsKCQkJCQl2YXIgdmFsID0gbm9kZVt0aGlzLkRPTUF0dHJzW2FdXTsKCQkJCQlpZiggdmFsICkKCQkJCQkJcmV0ICs9ICcgJyArIGEgKyAnPScgKyB0aGlzLnBhcnNlKCB2YWwsICdhdHRyaWJ1dGUnICk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7CgkJCX0sCgkJCWZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKXsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbgoJCQkJdmFyIGwgPSBmbi5sZW5ndGg7CgkJCQlpZiggIWwgKSByZXR1cm4gJyc7CQkJCQoJCQkJCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOwoJCQkJd2hpbGUoIGwtLSApCgkJCQkJYXJnc1tsXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcrbCk7Ly85NyBpcyAnYScKCQkJCXJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7CgkJCX0sCgkJCWtleTpxdW90ZSwgLy9vYmplY3QgY2FsbHMgaXQgaW50ZXJuYWxseSwgdGhlIGtleSBwYXJ0IG9mIGFuIGl0ZW0gaW4gYSBtYXAKCQkJZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uCgkJCWF0dHJpYnV0ZTpxdW90ZSwgLy9ub2RlIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgYW4gaHRtbCBhdHRyaWJ1dGUgdmFsdWUKCQkJc3RyaW5nOnF1b3RlLAoJCQlkYXRlOnF1b3RlLAoJCQlyZWdleHA6bGl0ZXJhbCwgLy9yZWdleAoJCQludW1iZXI6bGl0ZXJhbCwKCQkJJ2Jvb2xlYW4nOmxpdGVyYWwKCQl9LAoJCURPTUF0dHJzOnsvL2F0dHJpYnV0ZXMgdG8gZHVtcCBmcm9tIG5vZGVzLCBuYW1lPT5yZWFsTmFtZQoJCQlpZDonaWQnLAoJCQluYW1lOiduYW1lJywKCQkJJ2NsYXNzJzonY2xhc3NOYW1lJwoJCX0sCgkJSFRNTDpmYWxzZSwvL2lmIHRydWUsIGVudGl0aWVzIGFyZSBlc2NhcGVkICggPCwgPiwgXHQsIHNwYWNlIGFuZCBcbiApCgkJaW5kZW50Q2hhcjonICAgJywvL2luZGVudGF0aW9uIHVuaXQKCQltdWx0aWxpbmU6dHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KCX07Cgp9KSgpOwo=",
                "body": "LyoKICogUVVuaXQgLSBqUXVlcnkgdW5pdCB0ZXN0cnVubmVyCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOCBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqCiAqICRJZCQKICovCgooZnVuY3Rpb24oJCkgewoKLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMOpIDxwcmF0aGVAZ21haWwuY29tPgp2YXIgZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwoKCiAgICAvLyBEZXRlcm1pbmUgd2hhdCBpcyBvLgogICAgZnVuY3Rpb24gaG9veml0KG8pIHsKICAgICAgICBpZiAoby5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgCiAgICAgICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CgogICAgICAgIH0gZWxzZSBpZiAoby5jb25zdHJ1Y3RvciA9PT0gTnVtYmVyKSB7CgogICAgICAgICAgICBpZiAoaXNOYU4obykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gInVuZGVmaW5lZCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAibnVsbCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgW10gPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgIAogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbmV3IERhdGUoKSA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICByZXR1cm4gImRhdGUiOwoKICAgICAgICAvLyBjb25zaWRlcjogLy4vIGluc3RhbmNlb2YgT2JqZWN0OwogICAgICAgIC8vICAgICAgICAgICAvLi8gaW5zdGFuY2VvZiBSZWdFeHA7CiAgICAgICAgLy8gICAgICAgICAgdHlwZW9mIC8uLyA9PT0gImZ1bmN0aW9uIjsgLy8gPT4gZmFsc2UgaW4gSUUgYW5kIE9wZXJhLAogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSBpbiBGRiBhbmQgU2FmYXJpCiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiAicmVnZXhwIjsKCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgICAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLgogICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICB2YXIgcHJvcCA9IGhvb3ppdChvKTsKICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBpZiAoaG9veml0KGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyBmb3Igc3RyaW5nLCBib29sZWFuLCBudW1iZXIgYW5kIG51bGwKICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7CiAgICAgICAgICAgIGlmIChiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgLy8gdG8gY2F0Y2ggc2hvcnQgYW5ub3RhaW9uIFZTICduZXcnIGFubm90YXRpb24gb2YgYSBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7CiAgICAgICAgICAgICAgICAvLyAgICAgIHZhciBqID0gbmV3IE51bWJlcigxKTsKICAgICAgICAgICAgICAgIHJldHVybiBhID09IGI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVtYmVyIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICJuYW4iOiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKGIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImRhdGUiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gInJlZ2V4cCIgJiYKICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZgogICAgICAgICAgICAgICAgICAgIGEuZ2xvYmFsID09PSBiLmdsb2JhbCAmJiAvLyBhbmQgaXRzIG1vZGlmZXJzIChnbWkpIC4uLgogICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmCiAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApCiAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5CiAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICB2YXIgbGVuOwoKICAgICAgICAgICAgICAgIC8vIGIgY291bGQgYmUgYW4gb2JqZWN0IGxpdGVyYWwgaGVyZQogICAgICAgICAgICAgICAgaWYgKCAhIChob296aXQoYikgPT09ICJhcnJheSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxlbiA9IGEubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYoICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQKICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgaWYgKCBhLmNvbnN0cnVjdG9yICE9PSBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKCiAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcwoKICAgICAgICAgICAgICAgICAgICBpZiAoICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0oKTsKCiAgICBpbm5lckVxdWl2ID0gZnVuY3Rpb24gKCkgeyAvLyBjYW4gdGFrZSBtdWx0aXBsZSBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGVuZCB0cmFuc2l0aW9uCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IGhvb3ppdChhKSAhPT0gaG9veml0KGIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7CiAgICB9OwoKICAgIHJldHVybiBpbm5lckVxdWl2OwoKfSgpOwoKdmFyIEdFVFBhcmFtcyA9ICQubWFwKCBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKSwgZGVjb2RlVVJJQ29tcG9uZW50ICksCgluZ2luZGV4ID0gJC5pbkFycmF5KCJub2dsb2JhbHMiLCBHRVRQYXJhbXMpLAoJbm9nbG9iYWxzID0gbmdpbmRleCAhPT0gLTE7CgppZiggbm9nbG9iYWxzICkKCUdFVFBhcmFtcy5zcGxpY2UoIG5naW5kZXgsIDEgKTsKCQp2YXIgY29uZmlnID0gewoJc3RhdHM6IHsKCQlhbGw6IDAsCgkJYmFkOiAwCgl9LAoJcXVldWU6IFtdLAoJLy8gYmxvY2sgdW50aWwgZG9jdW1lbnQgcmVhZHkKCWJsb2NraW5nOiB0cnVlLAoJLy9yZXN0cmljdCBtb2R1bGVzL3Rlc3RzIGJ5IGdldCBwYXJhbWV0ZXJzCglmaWx0ZXJzOiBHRVRQYXJhbXMsCglpc0xvY2FsOiAhISh3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgPT0gJ2ZpbGU6JykKfTsKCi8vIHB1YmxpYyBBUEkgYXMgZ2xvYmFsIG1ldGhvZHMKJC5leHRlbmQod2luZG93LCB7Cgl0ZXN0OiB0ZXN0LAoJbW9kdWxlOiBtb2R1bGUsCglleHBlY3Q6IGV4cGVjdCwKCW9rOiBvaywKCWVxdWFsczogZXF1YWxzLAoJc3RhcnQ6IHN0YXJ0LAoJc3RvcDogc3RvcCwKCXJlc2V0OiByZXNldCwKCWlzTG9jYWw6IGNvbmZpZy5pc0xvY2FsLAoJc2FtZTogZnVuY3Rpb24oYSwgYiwgbWVzc2FnZSkgewoJCXB1c2goZXF1aXYoYSwgYiksIGEsIGIsIG1lc3NhZ2UpOwoJfSwKCVFVbml0OiB7CgkJZXF1aXY6IGVxdWl2LAoJCW9rOiBvaywKCQlkb25lOiBmdW5jdGlvbihmYWlsdXJlcywgdG90YWwpe30sCgkJbG9nOiBmdW5jdGlvbihyZXN1bHQsIG1lc3NhZ2Upe30KCX0sCgkvLyBsZWdhY3kgbWV0aG9kcyBiZWxvdwoJaXNTZXQ6IGlzU2V0LAoJaXNPYmo6IGlzT2JqLAoJY29tcGFyZTogZnVuY3Rpb24oKSB7CgkJdGhyb3cgImNvbXBhcmUgaXMgZGVwcmVjYXRlZCAtIHVzZSBzYW1lKCkgaW5zdGVhZCI7Cgl9LAoJY29tcGFyZTI6IGZ1bmN0aW9uKCkgewoJCXRocm93ICJjb21wYXJlMiBpcyBkZXByZWNhdGVkIC0gdXNlIHNhbWUoKSBpbnN0ZWFkIjsKCX0sCglzZXJpYWxBcnJheTogZnVuY3Rpb24oKSB7CgkJdGhyb3cgInNlcmlhbEFycmF5IGlzIGRlcHJlY2F0ZWQgLSB1c2UganNEdW1wLnBhcnNlKCkgaW5zdGVhZCI7Cgl9LAoJcTogcSwKCXQ6IHQsCgl1cmw6IHVybCwKCXRyaWdnZXJFdmVudDogdHJpZ2dlckV2ZW50Cn0pOwoKJCh3aW5kb3cpLmxvYWQoZnVuY3Rpb24oKSB7CgkKCWlmICghJCgiI2hlYWRlciwgI2Jhbm5lciwgI3VzZXJBZ2VudCwgI3Rlc3RzIikubGVuZ3RoKSB7CgkJJCgnYm9keScpLnByZXBlbmQoCgkJCSc8aDEgaWQ9ImhlYWRlciI+JyArIGRvY3VtZW50LnRpdGxlICsgJzwvaDE+JyArCgkJCSc8aDIgaWQ9ImJhbm5lciI+PC9oMj4nICsKCQkJJzxoMiBpZD0idXNlckFnZW50Ij48L2gyPicgKwoJCQknPG9sIGlkPSJ0ZXN0cyI+PC9vbD4nCgkJKTsKCX0KCQoJJCgnI3VzZXJBZ2VudCcpLmh0bWwobmF2aWdhdG9yLnVzZXJBZ2VudCk7Cgl2YXIgaGVhZCA9ICQoJzxkaXYgY2xhc3M9InRlc3RydW5uZXItdG9vbGJhciI+PGxhYmVsIGZvcj0iZmlsdGVyLXBhc3MiPkhpZGUgcGFzc2VkIHRlc3RzPC9sYWJlbD48L2Rpdj4nKS5pbnNlcnRBZnRlcigiI3VzZXJBZ2VudCIpOwoJJCgnPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iZmlsdGVyLXBhc3MiIC8+JykuYXR0cigiZGlzYWJsZWQiLCB0cnVlKS5wcmVwZW5kVG8oaGVhZCkuY2xpY2soZnVuY3Rpb24oKSB7CgkJJCgnbGkucGFzcycpW3RoaXMuY2hlY2tlZCA/ICdoaWRlJyA6ICdzaG93J10oKTsKCX0pOwoJJCgnPGlucHV0IHR5cGU9ImNoZWNrYm94IiBpZD0iZmlsdGVyLW1pc3NpbmciPicpLmF0dHIoImRpc2FibGVkIiwgdHJ1ZSkuYXBwZW5kVG8oaGVhZCkuY2xpY2soZnVuY3Rpb24oKSB7CgkJJCgibGkuZmFpbDpjb250YWlucygnbWlzc2luZyB0ZXN0IC0gdW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZScpIikucGFyZW50KCdvbCcpLnBhcmVudCgnbGkuZmFpbCcpW3RoaXMuY2hlY2tlZCA/ICdoaWRlJyA6ICdzaG93J10oKTsKCX0pOwoJJCgiI2ZpbHRlci1taXNzaW5nIikuYWZ0ZXIoJzxsYWJlbCBmb3I9ImZpbHRlci1taXNzaW5nIj5IaWRlIG1pc3NpbmcgdGVzdHMgKHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUpPC9sYWJlbD4nKTsKCXJ1blRlc3QoKTsJCn0pOwoKZnVuY3Rpb24gc3luY2hyb25pemUoY2FsbGJhY2spIHsKCWNvbmZpZy5xdWV1ZS5wdXNoKGNhbGxiYWNrKTsKCWlmKCFjb25maWcuYmxvY2tpbmcpIHsKCQlwcm9jZXNzKCk7Cgl9Cn0KCmZ1bmN0aW9uIHByb2Nlc3MoKSB7Cgl3aGlsZShjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcpIHsKCQljb25maWcucXVldWUuc2hpZnQoKSgpOwoJfQp9CgpmdW5jdGlvbiBzdG9wKHRpbWVvdXQpIHsKCWNvbmZpZy5ibG9ja2luZyA9IHRydWU7CglpZiAodGltZW91dCkKCQljb25maWcudGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwoJCQlzdGFydCgpOwoJCX0sIHRpbWVvdXQpOwp9CmZ1bmN0aW9uIHN0YXJ0KCkgewoJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwoJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQlpZihjb25maWcudGltZW91dCkKCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQlwcm9jZXNzKCk7Cgl9LCAxMyk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoKCWlmKCAhaSApCgkJcmV0dXJuIHRydWU7CgkKCXdoaWxlKCBpLS0gKXsKCQl2YXIgZmlsdGVyID0gY29uZmlnLmZpbHRlcnNbaV0sCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoJCWlmKCBub3QgKSAKCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwoJCWlmKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPSAtMSApCgkJCXJldHVybiAhbm90OwoJCWlmKCBub3QgKQoJCQlydW4gPSB0cnVlOwoJfQoJcmV0dXJuIHJ1bjsKfQoKZnVuY3Rpb24gcnVuVGVzdCgpIHsKCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJdmFyIHN0YXJ0ZWQgPSArbmV3IERhdGU7Cgljb25maWcuZml4dHVyZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluJykuaW5uZXJIVE1MOwoJY29uZmlnLmFqYXhTZXR0aW5ncyA9ICQuYWpheFNldHRpbmdzOwoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJJCgnPHAgaWQ9InRlc3RyZXN1bHQiIGNsYXNzPSJyZXN1bHQiLz4nKS5odG1sKFsnVGVzdHMgY29tcGxldGVkIGluICcsCgkJCStuZXcgRGF0ZSAtIHN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywKCQkJJzxzcGFuIGNsYXNzPSJiYWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0iYWxsIj4nLCBjb25maWcuc3RhdHMuYWxsLCAnPC9zcGFuPiBwYXNzZWQsICcsIGNvbmZpZy5zdGF0cy5iYWQsJyBmYWlsZWQuJ10KCQkJLmpvaW4oJycpKQoJCQkuYXBwZW5kVG8oImJvZHkiKTsKCQkkKCIjYmFubmVyIikuYWRkQ2xhc3MoY29uZmlnLnN0YXRzLmJhZCA/ICJmYWlsIiA6ICJwYXNzIik7CgkJUVVuaXQuZG9uZSggY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCApOwoJfSk7Cn0KCnZhciBwb2xsdXRpb247CgpmdW5jdGlvbiBzYXZlR2xvYmFsKCl7Cglwb2xsdXRpb24gPSBbIF07CgkKCWlmKCBub2dsb2JhbHMgKQoJCWZvciggdmFyIGtleSBpbiB3aW5kb3cgKQoJCQlwb2xsdXRpb24ucHVzaChrZXkpOwp9CmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICl7Cgl2YXIgb2xkID0gcG9sbHV0aW9uOwoJc2F2ZUdsb2JhbCgpOwoJCglpZiggcG9sbHV0aW9uLmxlbmd0aCA+IG9sZC5sZW5ndGggKXsKCQlvayggZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRpZmYob2xkLCBwb2xsdXRpb24pLmpvaW4oIiwgIikgKTsKCQljb25maWcuZXhwZWN0ZWQrKzsKCX0KfQoKZnVuY3Rpb24gZGlmZiggY2xlYW4sIGRpcnR5ICl7CglyZXR1cm4gJC5ncmVwKCBkaXJ0eSwgZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuICQuaW5BcnJheSggbmFtZSwgY2xlYW4gKSA9PSAtMTsKCX0pOwp9CgpmdW5jdGlvbiB0ZXN0KG5hbWUsIGNhbGxiYWNrKSB7CglpZihjb25maWcuY3VycmVudE1vZHVsZSkKCQluYW1lID0gY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiIG1vZHVsZTogPHNwYW4+IiArIG5hbWUgKyAiPC9zcGFuPiI7Cgl2YXIgbGlmZWN5Y2xlID0gJC5leHRlbmQoewoJCXNldHVwOiBmdW5jdGlvbigpIHt9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9Cgl9LCBjb25maWcubW9kdWxlTGlmZWN5Y2xlKTsKCQoJaWYgKCAhdmFsaWRUZXN0KG5hbWUpICkKCQlyZXR1cm47CgkKCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCWNvbmZpZy5hc3NlcnRpb25zID0gW107CgkJY29uZmlnLmV4cGVjdGVkID0gbnVsbDsKCQl0cnkgewoJCQlpZiggIXBvbGx1dGlvbiApCgkJCQlzYXZlR2xvYmFsKCk7CgkJCWxpZmVjeWNsZS5zZXR1cCgpOwoJCX0gY2F0Y2goZSkgewoJCQlRVW5pdC5vayggZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJfQoJfSkKCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCXRyeSB7CgkJCWNhbGxiYWNrKCk7CgkJfSBjYXRjaChlKSB7CgkJCWlmKCB0eXBlb2YgY29uc29sZSAhPSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQkJCWNvbnNvbGUuZXJyb3IoIlRlc3QgIiArIG5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIik7CgkJCQljb25zb2xlLmVycm9yKGUpOwoJCQkJY29uc29sZS53YXJuKGNhbGxiYWNrLnRvU3RyaW5nKCkpOwoJCQl9CgkJCVFVbml0Lm9rKCBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArIChjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAxKSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKCQkJc2F2ZUdsb2JhbCgpOwoJCX0KCX0pOwoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJY2hlY2tQb2xsdXRpb24oKTsKCQkJbGlmZWN5Y2xlLnRlYXJkb3duKCk7CgkJfSBjYXRjaChlKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQl9Cgl9KQoJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJcmVzZXQoKTsKCQl9IGNhdGNoKGUpIHsKCQkJaWYoIHR5cGVvZiBjb25zb2xlICE9ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCQkJY29uc29sZS5lcnJvcigicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyBuYW1lICsgIiwgZXhjZXB0aW9uIGFuZCByZXNldCBmbiBmb2xsb3dzIik7CgkJCQljb25zb2xlLmVycm9yKGUpOwoJCQkJY29uc29sZS53YXJuKHJlc2V0LnRvU3RyaW5nKCkpOwoJCQl9CgkJfQoJCQoJCWlmKGNvbmZpZy5leHBlY3RlZCAmJiBjb25maWcuZXhwZWN0ZWQgIT0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoKSB7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKCQl9CgkJCgkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwOwoJCXZhciBvbCAgPSAkKCI8b2wvPiIpLmhpZGUoKTsKCQljb25maWcuc3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJdmFyIGFzc2VydGlvbiA9IGNvbmZpZy5hc3NlcnRpb25zW2ldOwoJCQkkKCI8bGkvPiIpLmFkZENsYXNzKGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCIpLnRleHQoYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgIihubyBtZXNzYWdlKSIpLmFwcGVuZFRvKG9sKTsKCQkJYXNzZXJ0aW9uLnJlc3VsdCA/IGdvb2QrKyA6IGJhZCsrOwoJCX0KCQljb25maWcuc3RhdHMuYmFkICs9IGJhZDsKCQoJCXZhciBiID0gJCgiPHN0cm9uZy8+IikuaHRtbChuYW1lICsgIiA8YiBzdHlsZT0nY29sb3I6YmxhY2s7Jz4oPGIgY2xhc3M9J2ZhaWwnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3MnPiIgKyBnb29kICsgIjwvYj4sICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iKQoJCS5jbGljayhmdW5jdGlvbigpewoJCQkkKHRoaXMpLm5leHQoKS50b2dnbGUoKTsKCQl9KQoJCS5kYmxjbGljayhmdW5jdGlvbihldmVudCkgewoJCQl2YXIgdGFyZ2V0ID0gJChldmVudC50YXJnZXQpLmZpbHRlcigic3Ryb25nIikuY2xvbmUoKTsKCQkJaWYgKCB0YXJnZXQubGVuZ3RoICkgewoJCQkJdGFyZ2V0LmNoaWxkcmVuKCkucmVtb3ZlKCk7CgkJCQlsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCgkLnRyaW0odGFyZ2V0LnRleHQoKSkpOwoJCQl9CgkJfSk7CgkJCgkJJCgiPGxpLz4iKS5hZGRDbGFzcyhiYWQgPyAiZmFpbCIgOiAicGFzcyIpLmFwcGVuZChiKS5hcHBlbmQob2wpLmFwcGVuZFRvKCIjdGVzdHMiKTsKCQoJCWlmKGJhZCkgewoJCQkkKCIjZmlsdGVyLXBhc3MiKS5hdHRyKCJkaXNhYmxlZCIsIG51bGwpOwoJCQkkKCIjZmlsdGVyLW1pc3NpbmciKS5hdHRyKCJkaXNhYmxlZCIsIG51bGwpOwoJCX0KCX0pOwp9CgovLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKZnVuY3Rpb24gbW9kdWxlKG5hbWUsIGxpZmVjeWNsZSkgewoJY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOwoJY29uZmlnLm1vZHVsZUxpZmVjeWNsZSA9IGxpZmVjeWNsZTsKfQoKLyoqCiAqIFNwZWNpZnkgdGhlIG51bWJlciBvZiBleHBlY3RlZCBhc3NlcnRpb25zIHRvIGd1cmFudGVlIHRoYXQgZmFpbGVkIHRlc3QgKG5vIGFzc2VydGlvbnMgYXJlIHJ1biBhdCBhbGwpIGRvbid0IHNsaXAgdGhyb3VnaC4KICovCmZ1bmN0aW9uIGV4cGVjdChhc3NlcnRzKSB7Cgljb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwp9CgovKioKICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCiAqLwpmdW5jdGlvbiByZXNldCgpIHsKCSQoIiNtYWluIikuaHRtbCggY29uZmlnLmZpeHR1cmUgKTsKCSQuZXZlbnQuZ2xvYmFsID0ge307CgkkLmFqYXhTZXR0aW5ncyA9ICQuZXh0ZW5kKHt9LCBjb25maWcuYWpheFNldHRpbmdzKTsKfQoKLyoqCiAqIEFzc2VydHMgdHJ1ZS4KICogQGV4YW1wbGUgb2soICQoImEiKS5zaXplKCkgPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGFuY2hvcnMiICk7CiAqLwpmdW5jdGlvbiBvayhhLCBtc2cpIHsKCVFVbml0LmxvZyhhLCBtc2cpOwoKCWNvbmZpZy5hc3NlcnRpb25zLnB1c2goewoJCXJlc3VsdDogISFhLAoJCW1lc3NhZ2U6IG1zZwoJfSk7Cn0KCi8qKgogKiBBc3NlcnRzIHRoYXQgdHdvIGFycmF5cyBhcmUgdGhlIHNhbWUKICovCmZ1bmN0aW9uIGlzU2V0KGEsIGIsIG1zZykgewoJZnVuY3Rpb24gc2VyaWFsQXJyYXkoIGEgKSB7CgkJdmFyIHIgPSBbXTsKCQkKCQlpZiAoIGEgJiYgYS5sZW5ndGggKQoJICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrICkgewoJICAgICAgICAgICAgdmFyIHN0ciA9IGFbaV0ubm9kZU5hbWU7CgkgICAgICAgICAgICBpZiAoIHN0ciApIHsKCSAgICAgICAgICAgICAgICBzdHIgPSBzdHIudG9Mb3dlckNhc2UoKTsKCSAgICAgICAgICAgICAgICBpZiAoIGFbaV0uaWQgKQoJICAgICAgICAgICAgICAgICAgICBzdHIgKz0gIiMiICsgYVtpXS5pZDsKCSAgICAgICAgICAgIH0gZWxzZQoJICAgICAgICAgICAgICAgIHN0ciA9IGFbaV07CgkgICAgICAgICAgICByLnB1c2goIHN0ciApOwoJICAgICAgICB9CgkKCQlyZXR1cm4gIlsgIiArIHIuam9pbigiLCAiKSArICIgXSI7Cgl9Cgl2YXIgcmV0ID0gdHJ1ZTsKCWlmICggYSAmJiBiICYmIGEubGVuZ3RoICE9IHVuZGVmaW5lZCAmJiBhLmxlbmd0aCA9PSBiLmxlbmd0aCApIHsKCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrICkKCQkJaWYgKCBhW2ldICE9IGJbaV0gKQoJCQkJcmV0ID0gZmFsc2U7Cgl9IGVsc2UKCQlyZXQgPSBmYWxzZTsKCVFVbml0Lm9rKCByZXQsICFyZXQgPyAobXNnICsgIiBleHBlY3RlZDogIiArIHNlcmlhbEFycmF5KGIpICsgIiByZXN1bHQ6ICIgKyBzZXJpYWxBcnJheShhKSkgOiBtc2cgKTsKfQoKLyoqCiAqIEFzc2VydHMgdGhhdCB0d28gb2JqZWN0cyBhcmUgZXF1aXZhbGVudAogKi8KZnVuY3Rpb24gaXNPYmooYSwgYiwgbXNnKSB7Cgl2YXIgcmV0ID0gdHJ1ZTsKCQoJaWYgKCBhICYmIGIgKSB7CgkJZm9yICggdmFyIGkgaW4gYSApCgkJCWlmICggYVtpXSAhPSBiW2ldICkKCQkJCXJldCA9IGZhbHNlOwoKCQlmb3IgKCBpIGluIGIgKQoJCQlpZiAoIGFbaV0gIT0gYltpXSApCgkJCQlyZXQgPSBmYWxzZTsKCX0gZWxzZQoJCXJldCA9IGZhbHNlOwoKICAgIFFVbml0Lm9rKCByZXQsIG1zZyApOwp9CgovKioKICogUmV0dXJucyBhbiBhcnJheSBvZiBlbGVtZW50cyB3aXRoIHRoZSBnaXZlbiBJRHMsIGVnLgogKiBAZXhhbXBsZSBxKCJtYWluIiwgImZvbyIsICJiYXIiKQogKiBAcmVzdWx0IFs8ZGl2IGlkPSJtYWluIj4sIDxzcGFuIGlkPSJmb28iPiwgPGlucHV0IGlkPSJiYXIiPl0KICovCmZ1bmN0aW9uIHEoKSB7Cgl2YXIgciA9IFtdOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrICkKCQlyLnB1c2goIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBhcmd1bWVudHNbaV0gKSApOwoJcmV0dXJuIHI7Cn0KCi8qKgogKiBBc3NlcnRzIHRoYXQgYSBzZWxlY3QgbWF0Y2hlcyB0aGUgZ2l2ZW4gSURzCiAqIEBleGFtcGxlIHQoIkNoZWNrIGZvciBzb21ldGhpbmciLCAiLy9bYV0iLCBbImZvbyIsICJiYWFyIl0pOwogKiBAcmVzdWx0IHJldHVybnMgdHJ1ZSBpZiAiLy9bYV0iIHJldHVybiB0d28gZWxlbWVudHMgd2l0aCB0aGUgSURzICdmb28nIGFuZCAnYmFhcicKICovCmZ1bmN0aW9uIHQoYSxiLGMpIHsKCXZhciBmID0gJChiKTsKCXZhciBzID0gIiI7Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCBmLmxlbmd0aDsgaSsrICkKCQlzICs9IChzICYmICIsIikgKyAnIicgKyBmW2ldLmlkICsgJyInOwoJaXNTZXQoZiwgcS5hcHBseShxLGMpLCBhICsgIiAoIiArIGIgKyAiKSIpOwp9CgovKioKICogQWRkIHJhbmRvbSBudW1iZXIgdG8gdXJsIHRvIHN0b3AgSUUgZnJvbSBjYWNoaW5nCiAqCiAqIEBleGFtcGxlIHVybCgiZGF0YS90ZXN0Lmh0bWwiKQogKiBAcmVzdWx0ICJkYXRhL3Rlc3QuaHRtbD8xMDUzODM1ODQyODk0MyIKICoKICogQGV4YW1wbGUgdXJsKCJkYXRhL3Rlc3QucGhwP2Zvbz1iYXIiKQogKiBAcmVzdWx0ICJkYXRhL3Rlc3QucGhwP2Zvbz1iYXImMTA1MzgzNTgzNDU1NTQiCiAqLwpmdW5jdGlvbiB1cmwodmFsdWUpIHsKCXJldHVybiB2YWx1ZSArICgvXD8vLnRlc3QodmFsdWUpID8gIiYiIDogIj8iKSArIG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgIiIgKyBwYXJzZUludChNYXRoLnJhbmRvbSgpKjEwMDAwMCk7Cn0KCi8qKgogKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLgogKgogKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKICoKICogQGV4YW1wbGUgZXF1YWxzKCAkLmZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CiAqCiAqIEBwYXJhbSBPYmplY3QgYWN0dWFsCiAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKICovCmZ1bmN0aW9uIGVxdWFscyhhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CglwdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cn0KCmZ1bmN0aW9uIHB1c2gocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgltZXNzYWdlID0gbWVzc2FnZSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJUVVuaXQub2soIHJlc3VsdCwgcmVzdWx0ID8gbWVzc2FnZSArICI6ICIgKyBleHBlY3RlZCA6IG1lc3NhZ2UgKyAiLCBleHBlY3RlZDogIiArIGpzRHVtcC5wYXJzZShleHBlY3RlZCkgKyAiIHJlc3VsdDogIiArIGpzRHVtcC5wYXJzZShhY3R1YWwpICk7Cn0KCi8qKgogKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCiAqCiAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwogKgogKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtCiAqIEBwYXJhbSBTdHJpbmcgdHlwZQogKi8KZnVuY3Rpb24gdHJpZ2dlckV2ZW50KCBlbGVtLCB0eXBlLCBldmVudCApIHsKCWlmICggJC5icm93c2VyLm1vemlsbGEgfHwgJC5icm93c2VyLm9wZXJhICkgewoJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CgkJZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LAoJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CgkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoJfSBlbHNlIGlmICggJC5icm93c2VyLm1zaWUgKSB7CgkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsKCX0KfQoKfSkoalF1ZXJ5KTsKCi8qKgogKiBqc0R1bXAKICogQ29weXJpZ2h0IChjKSAyMDA4IEFyaWVsIEZsZXNsZXIgLSBhZmxlc2xlcihhdClnbWFpbChkb3QpY29tIHwgaHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tCiAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApCiAqIERhdGU6IDUvMTUvMjAwOAogKiBAcHJvamVjdERlc2NyaXB0aW9uIEFkdmFuY2VkIGFuZCBleHRlbnNpYmxlIGRhdGEgZHVtcGluZyBmb3IgSmF2YXNjcmlwdC4KICogQHZlcnNpb24gMS4wLjAKICogQGF1dGhvciBBcmllbCBGbGVzbGVyCiAqIEBsaW5rIHtodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20vMjAwOC8wNS9qc2R1bXAtcHJldHR5LWR1bXAtb2YtYW55LWphdmFzY3JpcHQuaHRtbH0KICovCihmdW5jdGlvbigpewoJZnVuY3Rpb24gcXVvdGUoIHN0ciApewoJCXJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKCX07CglmdW5jdGlvbiBsaXRlcmFsKCBvICl7CgkJcmV0dXJuIG8gKyAnJzsJCgl9OwoJZnVuY3Rpb24gam9pbiggcHJlLCBhcnIsIHBvc3QgKXsKCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKTsKCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwoJCWlmKCBhcnIuam9pbiApCgkJCWFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsKCQlpZiggIWFyciApCgkJCXJldHVybiBwcmUgKyBwb3N0OwoJCXJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsKCX07CglmdW5jdGlvbiBhcnJheSggYXJyICl7CgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsJCQkJCQoJCXRoaXMudXAoKTsKCQl3aGlsZSggaS0tICkKCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CQkJCQoJCXRoaXMuZG93bigpOwoJCXJldHVybiBqb2luKCAnWycsIHJldCwgJ10nICk7Cgl9OwoJCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgkKCXZhciBqc0R1bXAgPSB3aW5kb3cuanNEdW1wID0gewoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKXsvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQoJCQl2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKCQkJdHlwZSA9IHR5cGVvZiBwYXJzZXI7CQkJCgkJCQoJCQlyZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwoIHRoaXMsIG9iaiApIDoKCQkJCSAgIHR5cGUgPT0gJ3N0cmluZycgPyBwYXJzZXIgOgoJCQkJICAgdGhpcy5wYXJzZXJzLmVycm9yOwoJCX0sCgkJdHlwZU9mOmZ1bmN0aW9uKCBvYmogKXsKCQkJdmFyIHR5cGUgPSB0eXBlb2Ygb2JqLAoJCQkJZiA9ICdmdW5jdGlvbic7Ly93ZSdsbCB1c2UgaXQgMyB0aW1lcywgc2F2ZSBpdAoJCQlyZXR1cm4gdHlwZSAhPSAnb2JqZWN0JyAmJiB0eXBlICE9IGYgPyB0eXBlIDoKCQkJCSFvYmogPyAnbnVsbCcgOgoJCQkJb2JqLmV4ZWMgPyAncmVnZXhwJyA6Ly8gc29tZSBicm93c2VycyAoRkYpIGNvbnNpZGVyIHJlZ2V4cHMgZnVuY3Rpb25zCgkJCQlvYmouZ2V0SG91cnMgPyAnZGF0ZScgOgoJCQkJb2JqLnNjcm9sbEJ5ID8gICd3aW5kb3cnIDoKCQkJCW9iai5ub2RlTmFtZSA9PSAnI2RvY3VtZW50JyA/ICdkb2N1bWVudCcgOgoJCQkJb2JqLm5vZGVOYW1lID8gJ25vZGUnIDoKCQkJCW9iai5pdGVtID8gJ25vZGVsaXN0JyA6IC8vIFNhZmFyaSByZXBvcnRzIG5vZGVsaXN0cyBhcyBmdW5jdGlvbnMKCQkJCW9iai5jYWxsZWUgPyAnYXJndW1lbnRzJyA6CgkJCQlvYmouY2FsbCB8fCBvYmouY29uc3RydWN0b3IgIT0gQXJyYXkgJiYgLy9hbiBhcnJheSB3b3VsZCBhbHNvIGZhbGwgb24gdGhpcyBoYWNrCgkJCQkJKG9iaisnJykuaW5kZXhPZihmKSAhPSAtMSA/IGYgOiAvL0lFIHJlcG9ydHMgZnVuY3Rpb25zIGxpa2UgYWxlcnQsIGFzIG9iamVjdHMKCQkJCSdsZW5ndGgnIGluIG9iaiA/ICdhcnJheScgOgoJCQkJdHlwZTsKCQl9LAoJCXNlcGFyYXRvcjpmdW5jdGlvbigpewoJCQlyZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsKCQl9LAoJCWluZGVudDpmdW5jdGlvbiggZXh0cmEgKXsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwoJCQlpZiggIXRoaXMubXVsdGlsaW5lICkKCQkJCXJldHVybiAnJzsKCQkJdmFyIGNociA9IHRoaXMuaW5kZW50Q2hhcjsKCQkJaWYoIHRoaXMuSFRNTCApCgkJCQljaHIgPSBjaHIucmVwbGFjZSgvXHQvZywnICAgJykucmVwbGFjZSgvIC9nLCcmbmJzcDsnKTsKCQkJcmV0dXJuIEFycmF5KCB0aGlzLl9kZXB0aF8gKyAoZXh0cmF8fDApICkuam9pbihjaHIpOwoJCX0sCgkJdXA6ZnVuY3Rpb24oIGEgKXsKCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKCQl9LAoJCWRvd246ZnVuY3Rpb24oIGEgKXsKCQkJdGhpcy5fZGVwdGhfIC09IGEgfHwgMTsKCQl9LAoJCXNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICl7CgkJCXRoaXMucGFyc2Vyc1tuYW1lXSA9IHBhcnNlcjsKCQl9LAoJCS8vIFRoZSBuZXh0IDMgYXJlIGV4cG9zZWQgc28geW91IGNhbiB1c2UgdGhlbQoJCXF1b3RlOnF1b3RlLCAKCQlsaXRlcmFsOmxpdGVyYWwsCgkJam9pbjpqb2luLAoJCS8vCgkJX2RlcHRoXzogMSwKCQkvLyBUaGlzIGlzIHRoZSBsaXN0IG9mIHBhcnNlcnMsIHRvIG1vZGlmeSB0aGVtLCB1c2UganNEdW1wLnNldFBhcnNlcgoJCXBhcnNlcnM6ewoJCQl3aW5kb3c6ICdbV2luZG93XScsCgkJCWRvY3VtZW50OiAnW0RvY3VtZW50XScsCgkJCWVycm9yOidbRVJST1JdJywgLy93aGVuIG5vIHBhcnNlciBpcyBmb3VuZCwgc2hvdWxkbid0IGhhcHBlbgoJCQl1bmtub3duOiAnW1Vua25vd25dJywKCQkJJ251bGwnOidudWxsJywKCQkJdW5kZWZpbmVkOid1bmRlZmluZWQnLAoJCQknZnVuY3Rpb24nOmZ1bmN0aW9uKCBmbiApewoJCQkJdmFyIHJldCA9ICdmdW5jdGlvbicsCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFCgkJCQlpZiggbmFtZSApCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7CgkJCQlyZXQgKz0gJygnOwoJCQkJCgkJCQlyZXQgPSBbIHJldCwgdGhpcy5wYXJzZSggZm4sICdmdW5jdGlvbkFyZ3MnICksICcpeyddLmpvaW4oJycpOwoJCQkJcmV0dXJuIGpvaW4oIHJldCwgdGhpcy5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOwoJCQl9LAoJCQlhcnJheTogYXJyYXksCgkJCW5vZGVsaXN0OiBhcnJheSwKCQkJYXJndW1lbnRzOiBhcnJheSwKCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKXsKCQkJCXZhciByZXQgPSBbIF07CgkJCQl0aGlzLnVwKCk7CgkJCQlmb3IoIHZhciBrZXkgaW4gbWFwICkKCQkJCQlyZXQucHVzaCggdGhpcy5wYXJzZShrZXksJ2tleScpICsgJzogJyArIHRoaXMucGFyc2UobWFwW2tleV0pICk7CgkJCQl0aGlzLmRvd24oKTsKCQkJCXJldHVybiBqb2luKCAneycsIHJldCwgJ30nICk7CgkJCX0sCgkJCW5vZGU6ZnVuY3Rpb24oIG5vZGUgKXsKCQkJCXZhciBvcGVuID0gdGhpcy5IVE1MID8gJyZsdDsnIDogJzwnLAoJCQkJCWNsb3NlID0gdGhpcy5IVE1MID8gJyZndDsnIDogJz4nOwoJCQkJCQoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJCQlyZXQgPSBvcGVuICsgdGFnOwoJCQkJCQoJCQkJZm9yKCB2YXIgYSBpbiB0aGlzLkRPTUF0dHJzICl7CgkJCQkJdmFyIHZhbCA9IG5vZGVbdGhpcy5ET01BdHRyc1thXV07CgkJCQkJaWYoIHZhbCApCgkJCQkJCXJldCArPSAnICcgKyBhICsgJz0nICsgdGhpcy5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOwoJCQkJfQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOwoJCQl9LAoJCQlmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24oIGZuICl7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24KCQkJCXZhciBsID0gZm4ubGVuZ3RoOwoJCQkJaWYoICFsICkgcmV0dXJuICcnOwkJCQkKCQkJCQoJCQkJdmFyIGFyZ3MgPSBBcnJheShsKTsKCQkJCXdoaWxlKCBsLS0gKQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwoJCQl9LAoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCgkJCXN0cmluZzpxdW90ZSwKCQkJZGF0ZTpxdW90ZSwKCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKCQkJbnVtYmVyOmxpdGVyYWwsCgkJCSdib29sZWFuJzpsaXRlcmFsCgkJfSwKCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKCQkJaWQ6J2lkJywKCQkJbmFtZTonbmFtZScsCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScKCQl9LAoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQoJCWluZGVudENoYXI6JyAgICcsLy9pbmRlbnRhdGlvbiB1bml0CgkJbXVsdGlsaW5lOnRydWUgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuCgl9OwoKfSkoKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 14:56:09 GMT",
                    "Content-Length": "22626",
                    "Date": "Sat, 08 Nov 2014 14:56:09 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}