{
    "url": "http://localhost:9999/julien-c/jQueryAutocompletePlugin/docs/js/jquery.tabs.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.hash</b> and written to <b>$()</b> via the following statement:<ul><li>var toShow = $(location.hash);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/julien-c/jQueryAutocompletePlugin/docs/js/jquery.tabs.js",
                "path": "/julien-c/jQueryAutocompletePlugin/docs/js/jquery.tabs.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qdWxpZW4tYy9qUXVlcnlBdXRvY29tcGxldGVQbHVnaW4vZG9jcy9qcy9qcXVlcnkudGFicy5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzIwMDENCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDU6NTE6NDAgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA1OjUxOjQwIEdNVA0KDQovKioKICogVGFicyAtIGpRdWVyeSBwbHVnaW4gZm9yIGFjY2Vzc2libGUsIHVub2J0cnVzaXZlIHRhYnMKICogQHJlcXVpcmVzIGpRdWVyeSB2MS4wLjMKICoKICogaHR0cDovL3N0aWxidWVyby5kZS90YWJzLwogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDYgS2xhdXMgSGFydGwgKHN0aWxidWVyby5kZSkKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqIGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy9ncGwuaHRtbAogKgogKiBWZXJzaW9uOiAyLjcuNAogKi8KCihmdW5jdGlvbigkKSB7IC8vIGJsb2NrIHNjb3BlCgokLmV4dGVuZCh7CiAgICB0YWJzOiB7CiAgICAgICAgcmVtb3RlQ291bnQ6IDAgLy8gVE9ETyBpbiBUYWJzIDMgdGhpcyBpcyBnb2luZyB0byBiZSBtb3JlIGNsZWFubHkgaW4gb25lIHNpbmdsZSBuYW1lc3BhY2UKICAgIH0KfSk7CgovKioKICogQ3JlYXRlIGFuIGFjY2Vzc2libGUsIHVub2J0cnVzaXZlIHRhYiBpbnRlcmZhY2UgYmFzZWQgb24gYSBwYXJ0aWN1bGFyIEhUTUwgc3RydWN0dXJlLgogKgogKiBUaGUgdW5kZXJseWluZyBIVE1MIGhhcyB0byBsb29rIGxpa2UgdGhpczoKICoKICogPGRpdiBpZD0iY29udGFpbmVyIj4KICogICAgIDx1bD4KICogICAgICAgICA8bGk+PGEgaHJlZj0iI2ZyYWdtZW50LTEiPlNlY3Rpb24gMTwvYT48L2xpPgogKiAgICAgICAgIDxsaT48YSBocmVmPSIjZnJhZ21lbnQtMiI+U2VjdGlvbiAyPC9hPjwvbGk+CiAqICAgICAgICAgPGxpPjxhIGhyZWY9IiNmcmFnbWVudC0zIj5TZWN0aW9uIDM8L2E+PC9saT4KICogICAgIDwvdWw+CiAqICAgICA8ZGl2IGlkPSJmcmFnbWVudC0xIj4KICoKICogICAgIDwvZGl2PgogKiAgICAgPGRpdiBpZD0iZnJhZ21lbnQtMiI+CiAqCiAqICAgICA8L2Rpdj4KICogICAgIDxkaXYgaWQ9ImZyYWdtZW50LTMiPgogKgogKiAgICAgPC9kaXY+CiAqIDwvZGl2PgogKgogKiBFYWNoIGFuY2hvciBpbiB0aGUgdW5vcmRlcmVkIGxpc3QgcG9pbnRzIGRpcmVjdGx5IHRvIGEgc2VjdGlvbiBiZWxvdyByZXByZXNlbnRlZCBieSBvbmUgb2YgdGhlCiAqIGRpdnMgKHRoZSBVUkkgaW4gdGhlIGFuY2hvcidzIGhyZWYgYXR0cmlidXRlIHJlZmVycyB0byB0aGUgZnJhZ21lbnQgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBpZCkuCiAqIEJlY2F1c2Ugc3VjaCBIVE1MIHN0cnVjdHVyZSBpcyBmdWxseSBmdW5jdGlvbmFsIG9uIGl0cyBvd24sIGUuZy4gd2l0aG91dCBKYXZhU2NyaXB0LCB0aGUgdGFiCiAqIGludGVyZmFjZSBpcyBhY2Nlc3NpYmxlIGFuZCB1bm9idHJ1c2l2ZS4KICoKICogQSB0YWIgaXMgYWxzbyBib29rbWFya2FibGUgdmlhIGhhc2ggaW4gdGhlIFVSTC4gVXNlIHRoZSBIaXN0b3J5L1JlbW90ZSBwbHVnaW4gKFRhYnMgd2lsbAogKiBhdXRvLWRldGVjdCBpdHMgcHJlc2VuY2UpIHRvIGZpeCB0aGUgYmFjayAoYW5kIGZvcndhcmQpIGJ1dHRvbi4KICoKICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRhYnMoKTsKICogQGRlc2MgQ3JlYXRlIGEgYmFzaWMgdGFiIGludGVyZmFjZS4KICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRhYnMoMik7CiAqIEBkZXNjIENyZWF0ZSBhIGJhc2ljIHRhYiBpbnRlcmZhY2Ugd2l0aCB0aGUgc2Vjb25kIHRhYiBpbml0aWFsbHkgYWN0aXZhdGVkLgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudGFicyh7ZGlzYWJsZWQ6IFszLCA0XX0pOwogKiBAZGVzYyBDcmVhdGUgYSB0YWIgaW50ZXJmYWNlIHdpdGggdGhlIHRoaXJkIGFuZCBmb3VydGggdGFiIGJlaW5nIGRpc2FibGVkLgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudGFicyh7ZnhTbGlkZTogdHJ1ZX0pOwogKiBAZGVzYyBDcmVhdGUgYSB0YWIgaW50ZXJmYWNlIHRoYXQgdXNlcyBzbGlkZSBkb3duL3VwIGFuaW1hdGlvbnMgZm9yIHNob3dpbmcvaGlkaW5nIHRhYgogKiAgICAgICBjb250ZW50IHVwb24gdGFiIHN3aXRjaGluZy4KICoKICogQHBhcmFtIE51bWJlciBpbml0aWFsIEFuIGludGVnZXIgc3BlY2lmeWluZyB0aGUgcG9zaXRpb24gb2YgdGhlIHRhYiAobm8gemVyby1iYXNlZCBpbmRleCkgdGhhdAogKiAgICAgICAgICAgICAgICAgICAgICAgZ2V0cyBhY3RpdmF0ZWQgYXQgZmlyc3QgKG9uIHBhZ2UgbG9hZCkuIFR3byBhbHRlcm5hdGl2ZSB3YXlzIHRvIHNwZWNpZnkKICogICAgICAgICAgICAgICAgICAgICAgIHRoZSBhY3RpdmUgdGFiIHdpbGwgb3ZlcnJ1bGUgdGhpcyBhcmd1bWVudC4gRmlyc3QgYSBsaSBlbGVtZW50CiAqICAgICAgICAgICAgICAgICAgICAgICAocmVwcmVzZW50aW5nIG9uZSBzaW5nbGUgdGFiKSBiZWxvbmdpbmcgdG8gdGhlIHNlbGVjdGVkIHRhYiBjbGFzcywgZS5nLgogKiAgICAgICAgICAgICAgICAgICAgICAgc2V0IHRoZSBzZWxlY3RlZCB0YWIgY2xhc3MgKGRlZmF1bHQ6ICJ0YWJzLXNlbGVjdGVkIiwgc2VlIG9wdGlvbgogKiAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRDbGFzcykgZm9yIG9uZSBvZiB0aGUgdW5vcmRlcmVkIGxpIGVsZW1lbnRzIGluIHRoZSBIVE1MIHNvdXJjZS4KICogICAgICAgICAgICAgICAgICAgICAgIEluIGFkZGl0aW9uIGlmIGEgZnJhZ21lbnQgaWRlbnRpZmllci9oYXNoIGluIHRoZSBVUkwgb2YgdGhlIHBhZ2UgcmVmZXJzCiAqICAgICAgICAgICAgICAgICAgICAgICB0byB0aGUgaWQgb2YgYSB0YWIgY29udGFpbmVyIG9mIGEgdGFiIGludGVyZmFjZSB0aGUgY29ycmVzcG9uZGluZyB0YWIgd2lsbAogKiAgICAgICAgICAgICAgICAgICAgICAgYmUgYWN0aXZhdGVkIGFuZCBib3RoIHRoZSBpbml0aWFsIGFyZ3VtZW50IGFzIHdlbGwgYXMgYW4gZXZlbnR1YWxseQogKiAgICAgICAgICAgICAgICAgICAgICAgZGVjbGFyZWQgY2xhc3MgYXR0cmlidXRlIHdpbGwgYmUgb3ZlcnJ1bGVkLiBEZWZhdWx0cyB0byAxIGlmIG9taXR0ZWQuCiAqIEBwYXJhbSBPYmplY3Qgc2V0dGluZ3MgQW4gb2JqZWN0IGxpdGVyYWwgY29udGFpbmluZyBrZXkvdmFsdWUgcGFpcnMgdG8gcHJvdmlkZSBvcHRpb25hbCBzZXR0aW5ncy4KICogQG9wdGlvbiBBcnJheTxOdW1iZXI+IGRpc2FibGVkIEFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSB0YWJzIChubyB6ZXJvLWJhc2VkIGluZGV4KQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdCBzaG91bGQgYmUgZGlzYWJsZWQgb24gaW5pdGlhbGl6YXRpb24uIERlZmF1bHQgdmFsdWU6IG51bGwuCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBIHRhYiBjYW4gYWxzbyBiZSBkaXNhYmxlZCBieSBzaW1wbHkgYWRkaW5nIHRoZSBkaXNhYmxpbmcgY2xhc3MKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChkZWZhdWx0OiAidGFicy1kaXNhYmxlZCIsIHNlZSBvcHRpb24gZGlzYWJsZWRDbGFzcykgdG8gdGhlIGxpCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50IHJlcHJlc2VudGluZyB0aGF0IHBhcnRpY3VsYXIgdGFiLgogKiBAb3B0aW9uIEJvb2xlYW4gYm9va21hcmthYmxlIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIGlmIHN1cHBvcnQgZm9yIGJvb2ttYXJraW5nIGFuZCBoaXN0b3J5ICh2aWEKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2luZyBoYXNoIGluIHRoZSBVUkwgb2YgdGhlIGJyb3dzZXIpIGlzIGVuYWJsZWQuIERlZmF1bHQgdmFsdWU6CiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFsc2UsIHVubGVzcyB0aGUgSGlzdG9yeS9SZW1vdGUgcGx1Z2luIGlzIGluY2x1ZGVkLiBJbiB0aGF0IGNhc2UgdGhlCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCB2YWx1ZSBiZWNvbWVzIHRydWUuIEBzZWUgJC5hamF4SGlzdG9yeS5pbml0aWFsaXplCiAqIEBvcHRpb24gQm9vbGVhbiByZW1vdGUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgdGhhdCB0YWIgY29udGVudCBoYXMgdG8gYmUgbG9hZGVkIHJlbW90ZWx5IGZyb20KICogICAgICAgICAgICAgICAgICAgICAgICB0aGUgdXJsIGdpdmVuIGluIHRoZSBocmVmIGF0dHJpYnV0ZSBvZiB0aGUgdGFiIG1lbnUgYW5jaG9yIGVsZW1lbnRzLgogKiBAb3B0aW9uIFN0cmluZyBzcGlubmVyIFRoZSBjb250ZW50IG9mIHRoaXMgc3RyaW5nIGlzIHNob3duIGluIGEgdGFiIHdoaWxlIHJlbW90ZSBjb250ZW50IGlzIGxvYWRpbmcuCiAqICAgICAgICAgICAgICAgICAgICAgICAgSW5zZXJ0IHBsYWluIHRleHQgYXMgd2VsbCBhcyBhbiBpbWcgaGVyZS4gVG8gdHVybiBvZmYgdGhpcyBub3RpZmljYXRpb24KICogICAgICAgICAgICAgICAgICAgICAgICBwYXNzIGFuIGVtcHR5IHN0cmluZyBvciBudWxsLiBEZWZhdWx0OiAiTG9hZGluZyYjODIzMDsiLgogKiBAb3B0aW9uIFN0cmluZyBoYXNoUHJlZml4IEEgU3RyaW5nIHRoYXQgaXMgdXNlZCBmb3IgY29uc3RydWN0aW5nIHRoZSBoYXNoIHRoZSBsaW5rJ3MgaHJlZiBhdHRyaWJ1dGUKICogICAgICAgICAgICAgICAgICAgICAgICAgICBvZiBhIHJlbW90ZSB0YWIgZ2V0cyBhbHRlcmVkIHRvLCBzdWNoIGFzICIjcmVtb3RlLTEiLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICJyZW1vdGUtdGFiLSIuCiAqIEBvcHRpb24gQm9vbGVhbiBmeEZhZGUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgd2hldGhlciBmYWRlIGluL291dCBhbmltYXRpb25zIGFyZSB1c2VkIGZvciB0YWIKICogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hpbmcuIENhbiBiZSBjb21iaW5lZCB3aXRoIGZ4U2xpZGUuIFdpbGwgb3ZlcnJ1bGUgZnhTaG93L2Z4SGlkZS4KICogICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBmYWxzZS4KICogQG9wdGlvbiBCb29sZWFuIGZ4U2xpZGUgQm9vbGVhbiBmbGFnIGluZGljYXRpbmcgd2hldGhlciBzbGlkZSBkb3duL3VwIGFuaW1hdGlvbnMgYXJlIHVzZWQgZm9yIHRhYgogKiAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hpbmcuIENhbiBiZSBjb21iaW5lZCB3aXRoIGZ4RmFkZS4gV2lsbCBvdmVycnVsZSBmeFNob3cvZnhIaWRlLgogKiAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBmYWxzZS4KICogQG9wdGlvbiBTdHJpbmd8TnVtYmVyIGZ4U3BlZWQgQSBzdHJpbmcgcmVwcmVzZW50aW5nIG9uZSBvZiB0aGUgdGhyZWUgcHJlZGVmaW5lZCBzcGVlZHMgKCJzbG93IiwKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5vcm1hbCIsIG9yICJmYXN0Iikgb3IgdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgKGUuZy4gMTAwMCkgdG8KICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVuIGFuIGFuaW1hdGlvbi4gRGVmYXVsdCB2YWx1ZTogIm5vcm1hbCIuCiAqIEBvcHRpb24gT2JqZWN0IGZ4U2hvdyBBbiBvYmplY3QgbGl0ZXJhbCBvZiB0aGUgZm9ybSBqUXVlcnkncyBhbmltYXRlIGZ1bmN0aW9uIGV4cGVjdHMgZm9yIG1ha2luZwogKiAgICAgICAgICAgICAgICAgICAgICAgeW91ciBvd24sIGN1c3RvbSBhbmltYXRpb24gdG8gcmV2ZWFsIGEgdGFiIHVwb24gdGFiIHN3aXRjaC4gVW5saWtlIGZ4RmFkZQogKiAgICAgICAgICAgICAgICAgICAgICAgb3IgZnhTbGlkZSB0aGlzIGFuaW1hdGlvbiBpcyBpbmRlcGVuZGVudCBmcm9tIGFuIG9wdGlvbmFsIGhpZGUgYW5pbWF0aW9uLgogKiAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogbnVsbC4gQHNlZSBhbmltYXRlCiAqIEBvcHRpb24gT2JqZWN0IGZ4SGlkZSBBbiBvYmplY3QgbGl0ZXJhbCBvZiB0aGUgZm9ybSBqUXVlcnkncyBhbmltYXRlIGZ1bmN0aW9uIGV4cGVjdHMgZm9yIG1ha2luZwogKiAgICAgICAgICAgICAgICAgICAgICAgeW91ciBvd24sIGN1c3RvbSBhbmltYXRpb24gdG8gaGlkZSBhIHRhYiB1cG9uIHRhYiBzd2l0Y2guIFVubGlrZSBmeEZhZGUKICogICAgICAgICAgICAgICAgICAgICAgIG9yIGZ4U2xpZGUgdGhpcyBhbmltYXRpb24gaXMgaW5kZXBlbmRlbnQgZnJvbSBhbiBvcHRpb25hbCBzaG93IGFuaW1hdGlvbi4KICogICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IG51bGwuIEBzZWUgYW5pbWF0ZQogKiBAb3B0aW9uIFN0cmluZ3xOdW1iZXIgZnhTaG93U3BlZWQgQSBzdHJpbmcgcmVwcmVzZW50aW5nIG9uZSBvZiB0aGUgdGhyZWUgcHJlZGVmaW5lZCBzcGVlZHMKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICgic2xvdyIsICJub3JtYWwiLCBvciAiZmFzdCIpIG9yIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZS5nLiAxMDAwKSB0byBydW4gdGhlIGFuaW1hdGlvbiBzcGVjaWZpZWQgaW4gZnhTaG93LgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogZnhTcGVlZC4KICogQG9wdGlvbiBTdHJpbmd8TnVtYmVyIGZ4SGlkZVNwZWVkIEEgc3RyaW5nIHJlcHJlc2VudGluZyBvbmUgb2YgdGhlIHRocmVlIHByZWRlZmluZWQgc3BlZWRzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoInNsb3ciLCAibm9ybWFsIiwgb3IgImZhc3QiKSBvciB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGUuZy4gMTAwMCkgdG8gcnVuIHRoZSBhbmltYXRpb24gc3BlY2lmaWVkIGluIGZ4SGlkZS4KICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IGZ4U3BlZWQuCiAqIEBvcHRpb24gQm9vbGVhbiBmeEF1dG9IZWlnaHQgQm9vbGVhbiBmbGFnIHRoYXQgaWYgc2V0IHRvIHRydWUgY2F1c2VzIGFsbCB0YWIgaGVpZ2h0cwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvIGJlIGNvbnN0YW50IChiZWluZyB0aGUgaGVpZ2h0IG9mIHRoZSB0YWxsZXN0IHRhYikuCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogZmFsc2UuCiAqIEBvcHRpb24gRnVuY3Rpb24gb25DbGljayBBIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgdXBvbiB0YWIgc3dpdGNoLCBpbW1lZGlhdGx5IGFmdGVyIGEgdGFiIGhhcwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgYmVlbiBjbGlja2VkLCBlLmcuIGJlZm9yZSB0aGUgb3RoZXIncyB0YWIgY29udGVudCBnZXRzIGhpZGRlbi4gVGhlCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiBnZXRzIHBhc3NlZCB0aHJlZSBhcmd1bWVudHM6IHRoZSBmaXJzdCBvbmUgaXMgdGhlIGNsaWNrZWQKICogICAgICAgICAgICAgICAgICAgICAgICAgIHRhYiAoZS5nLiBhbiBhbmNob3IgZWxlbWVudCksIHRoZSBzZWNvbmQgb25lIGlzIHRoZSBET00gZWxlbWVudAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmluZyB0aGUgY29udGVudCBvZiB0aGUgY2xpY2tlZCB0YWIgKGUuZy4gdGhlIGRpdiksIHRoZSB0aGlyZAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgYXJndW1lbnQgaXMgdGhlIG9uZSBvZiB0aGUgdGFiIHRoYXQgZ2V0cyBoaWRkZW4uIElmIHRoaXMgY2FsbGJhY2sKICogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybnMgZmFsc2UsIHRoZSB0YWIgc3dpdGNoIGlzIGNhbmNlbGVkICh1c2UgdG8gZGlzYWxsb3cgdGFiCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hpbmcgZm9yIHRoZSByZWFzb24gb2YgYSBmYWlsZWQgZm9ybSB2YWxpZGF0aW9uIGZvciBleGFtcGxlKS4KICogICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IG51bGwuCiAqIEBvcHRpb24gRnVuY3Rpb24gb25IaWRlIEEgZnVuY3Rpb24gdG8gYmUgaW52b2tlZCB1cG9uIHRhYiBzd2l0Y2gsIGltbWVkaWF0bHkgYWZ0ZXIgb25lIHRhYidzCiAqICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgZ290IGhpZGRlbiAod2l0aCBvciB3aXRob3V0IGFuIGFuaW1hdGlvbikgYW5kIHJpZ2h0IGJlZm9yZSB0aGUKICogICAgICAgICAgICAgICAgICAgICAgICAgbmV4dCB0YWIgaXMgcmV2ZWFsZWQuIFRoZSBmdW5jdGlvbiBnZXRzIHBhc3NlZCB0aHJlZSBhcmd1bWVudHM6IHRoZQogKiAgICAgICAgICAgICAgICAgICAgICAgICBmaXJzdCBvbmUgaXMgdGhlIGNsaWNrZWQgdGFiIChlLmcuIGFuIGFuY2hvciBlbGVtZW50KSwgdGhlIHNlY29uZCBvbmUKICogICAgICAgICAgICAgICAgICAgICAgICAgaXMgdGhlIERPTSBlbGVtZW50IGNvbnRhaW5pbmcgdGhlIGNvbnRlbnQgb2YgdGhlIGNsaWNrZWQgdGFiLCAoZS5nLiB0aGUKICogICAgICAgICAgICAgICAgICAgICAgICAgZGl2KSwgdGhlIHRoaXJkIGFyZ3VtZW50IGlzIHRoZSBvbmUgb2YgdGhlIHRhYiB0aGF0IGdldHMgaGlkZGVuLgogKiAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBudWxsLgogKiBAb3B0aW9uIEZ1bmN0aW9uIG9uU2hvdyBBIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgdXBvbiB0YWIgc3dpdGNoLiBUaGlzIGZ1bmN0aW9uIGlzIGludm9rZWQKICogICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXIgdGhlIG5ldyB0YWIgaGFzIGJlZW4gcmV2ZWFsZWQsIGUuZy4gYWZ0ZXIgdGhlIHN3aXRjaCBpcyBjb21wbGV0ZWQuCiAqICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBmdW5jdGlvbiBnZXRzIHBhc3NlZCB0aHJlZSBhcmd1bWVudHM6IHRoZSBmaXJzdCBvbmUgaXMgdGhlIGNsaWNrZWQKICogICAgICAgICAgICAgICAgICAgICAgICAgdGFiIChlLmcuIGFuIGFuY2hvciBlbGVtZW50KSwgdGhlIHNlY29uZCBvbmUgaXMgdGhlIERPTSBlbGVtZW50CiAqICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5pbmcgdGhlIGNvbnRlbnQgb2YgdGhlIGNsaWNrZWQgdGFiLCAoZS5nLiB0aGUgZGl2KSwgdGhlIHRoaXJkCiAqICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IGlzIHRoZSBvbmUgb2YgdGhlIHRhYiB0aGF0IGdldHMgaGlkZGVuLiBEZWZhdWx0IHZhbHVlOiBudWxsLgogKiBAb3B0aW9uIFN0cmluZyBuYXZDbGFzcyBBIENTUyBjbGFzcyB0aGF0IGlzIHVzZWQgdG8gaWRlbnRpZnkgdGhlIHRhYnMgdW5vcmRlcmVkIGxpc3QgYnkgY2xhc3MgaWYKICogICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHJlcXVpcmVkIEhUTUwgc3RydWN0dXJlIGRpZmZlcnMgZnJvbSB0aGUgZGVmYXVsdCBvbmUuCiAqICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICJ0YWJzLW5hdiIuCiAqIEBvcHRpb24gU3RyaW5nIHNlbGVjdGVkQ2xhc3MgVGhlIENTUyBjbGFzcyBhdHRhY2hlZCB0byB0aGUgbGkgZWxlbWVudCByZXByZXNlbnRpbmcgdGhlCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudGx5IHNlbGVjdGVkIChhY3RpdmUpIHRhYi4gRGVmYXVsdCB2YWx1ZTogInRhYnMtc2VsZWN0ZWQiLgogKiBAb3B0aW9uIFN0cmluZyBkaXNhYmxlZENsYXNzIFRoZSBDU1MgY2xhc3MgYXR0YWNoZWQgdG8gdGhlIGxpIGVsZW1lbnQgcmVwcmVzZW50aW5nIGEgZGlzYWJsZWQKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWIuIERlZmF1bHQgdmFsdWU6ICJ0YWJzLWRpc2FibGVkIi4KICogQG9wdGlvbiBTdHJpbmcgY29udGFpbmVyQ2xhc3MgQSBDU1MgY2xhc3MgdGhhdCBpcyB1c2VkIHRvIGlkZW50aWZ5IHRhYiBjb250YWluZXJzIGJ5IGNsYXNzIGlmCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSByZXF1aXJlZCBIVE1MIHN0cnVjdHVyZSBkaWZmZXJzIGZyb20gdGhlIGRlZmF1bHQgb25lLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAidGFicy1jb250YWluZXIiLgogKiBAb3B0aW9uIFN0cmluZyBoaWRlQ2xhc3MgVGhlIENTUyBjbGFzcyB1c2VkIGZvciBoaWRpbmcgaW5hY3RpdmUgdGFicy4gQSBjbGFzcyBpcyB1c2VkIGluc3RlYWQKICogICAgICAgICAgICAgICAgICAgICAgICAgIG9mICJkaXNwbGF5OiBub25lIiBpbiB0aGUgc3R5bGUgYXR0cmlidXRlIHRvIG1haW50YWluIGNvbnRyb2wgb3ZlcgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmlzaWJpbGl0eSBpbiBvdGhlciBtZWRpYSB0eXBlcyB0aGFuIHNjcmVlbiwgbW9zdCBub3RhYmx5IHByaW50LgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogInRhYnMtaGlkZSIuCiAqIEBvcHRpb24gU3RyaW5nIGxvYWRpbmdDbGFzcyBUaGUgQ1NTIGNsYXNzIHVzZWQgZm9yIGluZGljYXRpbmcgdGhhdCBhbiBBamF4IHRhYiBpcyBjdXJyZW50bHkKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRpbmcsIGZvciBleGFtcGxlIGJ5IHNob3dpbmcgYSBzcGlubmVyLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogInRhYnMtbG9hZGluZyIuCiAqIEBvcHRpb24gU3RyaW5nIHRhYlN0cnVjdCBAZGVwcmVjYXRlZCBBIENTUyBzZWxlY3RvciBvciBiYXNpYyBYUGF0aCBleHByZXNzaW9uIHJlZmxlY3RpbmcgYQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgbmVzdGVkIEhUTUwgc3RydWN0dXJlIHRoYXQgaXMgZGlmZmVyZW50IGZyb20gdGhlIGRlZmF1bHQgc2luZ2xlIGRpdgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RydWN0dXJlIChvbmUgZGl2IHdpdGggYW4gaWQgaW5zaWRlIHRoZSBvdmVyYWxsIGNvbnRhaW5lciBob2xkcyBvbmUKICogICAgICAgICAgICAgICAgICAgICAgICAgIHRhYidzIGNvbnRlbnQpLiBJZiBmb3IgaW5zdGFuY2UgYW4gYWRkaXRpb25hbCBkaXYgaXMgcmVxdWlyZWQgdG8gd3JhcAogKiAgICAgICAgICAgICAgICAgICAgICAgICAgdXAgdGhlIHNldmVyYWwgdGFiIGNvbnRhaW5lcnMgc3VjaCBhIHN0cnVjdHVyZSBpcyBleHByZXNzZWQgYnkgImRpdj5kaXYiLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogImRpdiIuCiAqIEB0eXBlIGpRdWVyeQogKgogKiBAbmFtZSB0YWJzCiAqIEBjYXQgUGx1Z2lucy9UYWJzCiAqIEBhdXRob3IgS2xhdXMgSGFydGwva2xhdXMuaGFydGxAc3RpbGJ1ZXJvLmRlCiAqLwokLmZuLnRhYnMgPSBmdW5jdGlvbihpbml0aWFsLCBzZXR0aW5ncykgewoKICAgIC8vIHNldHRpbmdzCiAgICBpZiAodHlwZW9mIGluaXRpYWwgPT0gJ29iamVjdCcpIHNldHRpbmdzID0gaW5pdGlhbDsgLy8gbm8gaW5pdGlhbCB0YWIgZ2l2ZW4gYnV0IGEgc2V0dGluZ3Mgb2JqZWN0CiAgICBzZXR0aW5ncyA9ICQuZXh0ZW5kKHsKICAgICAgICBpbml0aWFsOiAoaW5pdGlhbCAmJiB0eXBlb2YgaW5pdGlhbCA9PSAnbnVtYmVyJyAmJiBpbml0aWFsID4gMCkgPyAtLWluaXRpYWwgOiAwLAogICAgICAgIGRpc2FibGVkOiBudWxsLAogICAgICAgIGJvb2ttYXJrYWJsZTogJC5hamF4SGlzdG9yeSA/IHRydWUgOiBmYWxzZSwKICAgICAgICByZW1vdGU6IGZhbHNlLAogICAgICAgIHNwaW5uZXI6ICdMb2FkaW5nJiM4MjMwOycsCiAgICAgICAgaGFzaFByZWZpeDogJ3JlbW90ZS10YWItJywKICAgICAgICBmeEZhZGU6IG51bGwsCiAgICAgICAgZnhTbGlkZTogbnVsbCwKICAgICAgICBmeFNob3c6IG51bGwsCiAgICAgICAgZnhIaWRlOiBudWxsLAogICAgICAgIGZ4U3BlZWQ6ICdub3JtYWwnLAogICAgICAgIGZ4U2hvd1NwZWVkOiBudWxsLAogICAgICAgIGZ4SGlkZVNwZWVkOiBudWxsLAogICAgICAgIGZ4QXV0b0hlaWdodDogZmFsc2UsCiAgICAgICAgb25DbGljazogbnVsbCwKICAgICAgICBvbkhpZGU6IG51bGwsCiAgICAgICAgb25TaG93OiBudWxsLAogICAgICAgIG9uUmVtb3RlTG9hZDogbnVsbCwKICAgICAgICBuYXZDbGFzczogJ3RhYnMtbmF2JywKICAgICAgICBzZWxlY3RlZENsYXNzOiAndGFicy1zZWxlY3RlZCcsCiAgICAgICAgZGlzYWJsZWRDbGFzczogJ3RhYnMtZGlzYWJsZWQnLAogICAgICAgIGNvbnRhaW5lckNsYXNzOiAndGFicy1jb250YWluZXInLAogICAgICAgIGhpZGVDbGFzczogJ3RhYnMtaGlkZScsCiAgICAgICAgbG9hZGluZ0NsYXNzOiAndGFicy1sb2FkaW5nJywKICAgICAgICB0YWJTdHJ1Y3Q6ICdkaXYnCiAgICB9LCBzZXR0aW5ncyB8fCB7fSk7CgogICAgJC5icm93c2VyLm1zaWU2ID0gJC5icm93c2VyLm1zaWUgJiYgKCQuYnJvd3Nlci52ZXJzaW9uICYmICQuYnJvd3Nlci52ZXJzaW9uIDwgNyB8fCAvNi4wLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpKTsgICAgCgogICAgLy8gaGVscGVyIHRvIHByZXZlbnQgc2Nyb2xsIHRvIGZyYWdtZW50CiAgICBmdW5jdGlvbiB1bkZvY3VzKCkgewogICAgICAgIHNjcm9sbFRvKDAsIDApOwogICAgfQoKICAgIC8vIGluaXRpYWxpemUgdGFicwogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCiAgICAgICAgLy8gcmVtZW1iZXIgd3JhcHBlciBmb3IgbGF0ZXIKICAgICAgICB2YXIgY29udGFpbmVyID0gdGhpczsKCiAgICAgICAgLy8gc2V0dXAgbmF2CiAgICAgICAgdmFyIG5hdiA9ICQoJ3VsLicgKyBzZXR0aW5ncy5uYXZDbGFzcywgY29udGFpbmVyKTsKICAgICAgICBuYXYgPSBuYXYuc2l6ZSgpICYmIG5hdiB8fCAkKCc+dWw6ZXEoMCknLCBjb250YWluZXIpOyAvLyBmYWxsYmFjayB0byBkZWZhdWx0IHN0cnVjdHVyZQogICAgICAgIHZhciB0YWJzID0gJCgnYScsIG5hdik7CgogICAgICAgIC8vIHByZXBhcmUgcmVtb3RlIHRhYnMKICAgICAgICBpZiAoc2V0dGluZ3MucmVtb3RlKSB7CiAgICAgICAgICAgIHRhYnMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgCWlmICggIS8jLy50ZXN0KCB0aGlzLmhyZWYgKSApIHsKICAgICAgICAgICAgCXRoaXMucmVtb3RlID0gInJlbW90ZSI7CiAgICAgICAgICAgICAgICB2YXIgaWQgPSBzZXR0aW5ncy5oYXNoUHJlZml4ICsgKCsrJC50YWJzLnJlbW90ZUNvdW50KSwgaGFzaCA9ICcjJyArIGlkLCB1cmwgPSB0aGlzLmhyZWY7CiAgICAgICAgICAgICAgICB0aGlzLmhyZWYgPSBoYXNoOwogICAgICAgICAgICAgICAgJCgnPGRpdiBpZD0iJyArIGlkICsgJyIgY2xhc3M9IicgKyBzZXR0aW5ncy5jb250YWluZXJDbGFzcyArICciPjwvZGl2PicpLmFwcGVuZFRvKGNvbnRhaW5lcik7CgogICAgICAgICAgICAgICAgJCh0aGlzKS5iaW5kKCdsb2FkUmVtb3RlVGFiJywgZnVuY3Rpb24oZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgIAlpZiAoICEkKGhhc2gpLmh0bWwoKSApIHsKCQkJCQkJdmFyICQkID0gJCh0aGlzKS5hZGRDbGFzcyhzZXR0aW5ncy5sb2FkaW5nQ2xhc3MpLCBzcGFuID0gJCgnc3BhbicsIHRoaXMpWzBdLCB0YWJUaXRsZSA9IHNwYW4uaW5uZXJIVE1MOwoJCQkJCQlpZiAoc2V0dGluZ3Muc3Bpbm5lcikgewoJCQkJCQkJLy8gVE9ETyBpZiBzcGlubmVyIGlzIGltYWdlCgkJCQkJCQlzcGFuLmlubmVySFRNTCA9ICc8ZW0+JyArIHNldHRpbmdzLnNwaW5uZXIgKyAnPC9lbT4nOyAvLyBXQVJOSU5HOiBodG1sKC4uLikgY3Jhc2hlcyBTYWZhcmkgd2l0aCBqUXVlcnkgMS4xLjIKCQkJCQkJfQoJCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAvLyBUaW1lb3V0IGlzIGFnYWluIHJlcXVpcmVkIGluIElFLCAid2FpdCIgZm9yIGlkIGJlaW5nIHJlc3RvcmVkCgkJCQkJCQkkKGhhc2gpLmxvYWQodXJsLCBmdW5jdGlvbigpIHsKCQkJCQkJCQlpZiAoc2V0dGluZ3Muc3Bpbm5lcikgewoJCQkJCQkJCQlzcGFuLmlubmVySFRNTCA9IHRhYlRpdGxlOyAvLyBXQVJOSU5HOiBodG1sKC4uLikgY3Jhc2hlcyBTYWZhcmkgd2l0aCBqUXVlcnkgMS4xLjIKCQkJCQkJCQl9CgkJCQkJCQkJJCQucmVtb3ZlQ2xhc3Moc2V0dGluZ3MubG9hZGluZ0NsYXNzKTsKCQkJCQkJCQlqUXVlcnkuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2soKTsKCQkJCQkJCQlqUXVlcnkuaXNGdW5jdGlvbihzZXR0aW5ncy5vblJlbW90ZUxvYWQpICYmIHNldHRpbmdzLm9uUmVtb3RlTG9hZC5jYWxsKCB0aGlzICk7CgkJCQkJCQl9KTsKCQkJCQkJfSwgMCk7CgkJCQkJfSBlbHNlCgkJCQkJCWpRdWVyeS5pc0Z1bmN0aW9uKGNhbGxiYWNrKSAmJiBjYWxsYmFjaygpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgLy8gc2V0IHVwIGNvbnRhaW5lcnMKICAgICAgICB2YXIgY29udGFpbmVycyA9ICQoJz4gZGl2LicgKyBzZXR0aW5ncy5jb250YWluZXJDbGFzcywgY29udGFpbmVyKTsKICAgICAgICBjb250YWluZXJzID0gY29udGFpbmVycy5zaXplKCkgJiYgY29udGFpbmVycyB8fCAkKCc+JyArIHNldHRpbmdzLnRhYlN0cnVjdCwgY29udGFpbmVyKTsgLy8gZmFsbGJhY2sgdG8gZGVmYXVsdCBzdHJ1Y3R1cmUKCiAgICAgICAgLy8gYXR0YWNoIGNsYXNzZXMgZm9yIHN0eWxpbmcgaWYgbm90IHByZXNlbnQKICAgICAgICBuYXYuaXMoJy4nICsgc2V0dGluZ3MubmF2Q2xhc3MpIHx8IG5hdi5hZGRDbGFzcyhzZXR0aW5ncy5uYXZDbGFzcyk7CiAgICAgICAgY29udGFpbmVycy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgJCQgPSAkKHRoaXMpOwogICAgICAgICAgICAkJC5pcygnLicgKyBzZXR0aW5ncy5jb250YWluZXJDbGFzcykgfHwgJCQuYWRkQ2xhc3Moc2V0dGluZ3MuY29udGFpbmVyQ2xhc3MpOwogICAgICAgIH0pOwoKICAgICAgICAvLyB0cnkgdG8gcmV0cmlldmUgYWN0aXZlIHRhYiBmcm9tIGNsYXNzIGluIEhUTUwKICAgICAgICB2YXIgaGFzU2VsZWN0ZWRDbGFzcyA9ICQoJ2xpJywgbmF2KS5pbmRleCggJCgnbGkuJyArIHNldHRpbmdzLnNlbGVjdGVkQ2xhc3MsIG5hdilbMF0gKTsKICAgICAgICBpZiAoaGFzU2VsZWN0ZWRDbGFzcyA+PSAwKSB7CiAgICAgICAgICAgc2V0dGluZ3MuaW5pdGlhbCA9IGhhc1NlbGVjdGVkQ2xhc3M7CiAgICAgICAgfQoKICAgICAgICAvLyB0cnkgdG8gcmV0cmlldmUgYWN0aXZlIHRhYiBmcm9tIGhhc2ggaW4gdXJsLCB3aWxsIG92ZXJyaWRlIGNsYXNzIGluIEhUTUwKICAgICAgICBpZiAobG9jYXRpb24uaGFzaCkgewogICAgICAgICAgICB0YWJzLmVhY2goZnVuY3Rpb24oaSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuaGFzaCA9PSBsb2NhdGlvbi5oYXNoKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3MuaW5pdGlhbCA9IGk7CiAgICAgICAgICAgICAgICAgICAgLy8gcHJldmVudCBwYWdlIHNjcm9sbCB0byBmcmFnbWVudAogICAgICAgICAgICAgICAgICAgIGlmICgoJC5icm93c2VyLm1zaWUgfHwgJC5icm93c2VyLm9wZXJhKSAmJiAhdGhpcy5yZW1vdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvU2hvdyA9ICQobG9jYXRpb24uaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b1Nob3dJZCA9IHRvU2hvdy5hdHRyKCdpZCcpOwogICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cuYXR0cignaWQnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cuYXR0cignaWQnLCB0b1Nob3dJZCk7IC8vIHJlc3RvcmUgaWQKICAgICAgICAgICAgICAgICAgICAgICAgfSwgNTAwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdW5Gb2N1cygpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gYnJlYWsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICgkLmJyb3dzZXIubXNpZSkgewogICAgICAgICAgICB1bkZvY3VzKCk7IC8vIGZpeCBJRSBmb2N1c3NpbmcgYm90dG9tIG9mIHRoZSBwYWdlIGZvciBzb21lIHVua25vd24gcmVhc29uCiAgICAgICAgfQoKICAgICAgICAvLyBoaWdobGlnaHQgdGFiIGFjY29yZGluZ2x5CiAgICAgICAgY29udGFpbmVycy5maWx0ZXIoJzplcSgnICsgc2V0dGluZ3MuaW5pdGlhbCArICcpJykuc2hvdygpLmVuZCgpLm5vdCgnOmVxKCcgKyBzZXR0aW5ncy5pbml0aWFsICsgJyknKS5hZGRDbGFzcyhzZXR0aW5ncy5oaWRlQ2xhc3MpOwogICAgICAgICQoJ2xpJywgbmF2KS5yZW1vdmVDbGFzcyhzZXR0aW5ncy5zZWxlY3RlZENsYXNzKS5zbGljZShzZXR0aW5ncy5pbml0aWFsLHNldHRpbmdzLmluaXRpYWwrMSkuYWRkQ2xhc3Moc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcyk7IC8vIHdlIG5lZWQgdG8gcmVtb3ZlIGNsYXNzZXMgZXZlbnR1YWxseSBpZiBoYXNoIHRha2VzIHByZWNlZGVuY2Ugb3ZlciBjbGFzcwogICAgICAgIC8vIHRyaWdnZXIgbG9hZCBvZiBpbml0aWFsIHRhYgogICAgICAgIHRhYnMuc2xpY2Uoc2V0dGluZ3MuaW5pdGlhbCxzZXR0aW5ncy5pbml0aWFsKzEpLnRyaWdnZXIoJ2xvYWRSZW1vdGVUYWInKS5lbmQoKTsKCiAgICAgICAgLy8gc2V0dXAgYXV0byBoZWlnaHQKICAgICAgICBpZiAoc2V0dGluZ3MuZnhBdXRvSGVpZ2h0KSB7CiAgICAgICAgICAgIC8vIGhlbHBlcgogICAgICAgICAgICB2YXIgX3NldEF1dG9IZWlnaHQgPSBmdW5jdGlvbihyZXNldCkgewogICAgICAgICAgICAgICAgLy8gZ2V0IHRhYiBoZWlnaHRzIGluIHRvcCB0byBib3R0b20gb3JkZXJlZCBhcnJheQogICAgICAgICAgICAgICAgdmFyIGhlaWdodHMgPSAkLm1hcChjb250YWluZXJzLmdldCgpLCBmdW5jdGlvbihlbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBoLCBqcSA9ICQoZWwpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXNldCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5icm93c2VyLm1zaWU2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zdHlsZS5yZW1vdmVFeHByZXNzaW9uKCdiZWhhdmlvdXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmhlaWdodCA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwubWluSGVpZ2h0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBoID0ganEuY3NzKHsnbWluLWhlaWdodCc6ICcnfSkuaGVpZ2h0KCk7IC8vIHVzZSBqUXVlcnkncyBoZWlnaHQoKSB0byBnZXQgaGlkZGVuIGVsZW1lbnQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaCA9IGpxLmhlaWdodCgpOyAvLyB1c2UgalF1ZXJ5J3MgaGVpZ2h0KCkgdG8gZ2V0IGhpZGRlbiBlbGVtZW50IHZhbHVlcwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gaDsKICAgICAgICAgICAgICAgIH0pLnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBiIC0gYTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5tc2llNikgewogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcnMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5taW5IZWlnaHQgPSBoZWlnaHRzWzBdICsgJ3B4JzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdHlsZS5zZXRFeHByZXNzaW9uKCdiZWhhdmlvdXInLCAndGhpcy5zdHlsZS5oZWlnaHQgPSB0aGlzLm1pbkhlaWdodCA/IHRoaXMubWluSGVpZ2h0IDogIjFweCInKTsgLy8gdXNpbmcgYW4gZXhwcmVzc2lvbiB0byBub3QgbWFrZSBwcmludCBzdHlsZXMgdXNlbGVzcwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJzLmNzcyh7J21pbi1oZWlnaHQnOiBoZWlnaHRzWzBdICsgJ3B4J30pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICAvLyBjYWxsIG9uY2UgZm9yIGluaXRpYWxpemF0aW9uCiAgICAgICAgICAgIF9zZXRBdXRvSGVpZ2h0KCk7CiAgICAgICAgICAgIC8vIHRyaWdnZXIgYXV0byBoZWlnaHQgYWRqdXN0bWVudCBpZiBuZWVkZWQKICAgICAgICAgICAgdmFyIGNhY2hlZFdpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICB2YXIgY2FjaGVkSGVpZ2h0ID0gY29udGFpbmVyLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgdmFyIHdhdGNoRm9udFNpemUgPSAkKCcjdGFicy13YXRjaC1mb250LXNpemUnKS5nZXQoMCkgfHwgJCgnPHNwYW4gaWQ9InRhYnMtd2F0Y2gtZm9udC1zaXplIj5NPC9zcGFuPicpLmNzcyh7ZGlzcGxheTogJ2Jsb2NrJywgcG9zaXRpb246ICdhYnNvbHV0ZScsIHZpc2liaWxpdHk6ICdoaWRkZW4nfSkuYXBwZW5kVG8oZG9jdW1lbnQuYm9keSkuZ2V0KDApOwogICAgICAgICAgICB2YXIgY2FjaGVkRm9udFNpemUgPSB3YXRjaEZvbnRTaXplLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFdpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIZWlnaHQgPSBjb250YWluZXIub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRGb250U2l6ZSA9IHdhdGNoRm9udFNpemUub2Zmc2V0SGVpZ2h0OwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRIZWlnaHQgPiBjYWNoZWRIZWlnaHQgfHwgY3VycmVudFdpZHRoICE9IGNhY2hlZFdpZHRoIHx8IGN1cnJlbnRGb250U2l6ZSAhPSBjYWNoZWRGb250U2l6ZSkgewogICAgICAgICAgICAgICAgICAgIF9zZXRBdXRvSGVpZ2h0KChjdXJyZW50V2lkdGggPiBjYWNoZWRXaWR0aCB8fCBjdXJyZW50Rm9udFNpemUgPCBjYWNoZWRGb250U2l6ZSkpOyAvLyBpZiBoZWlnaHRzIGdldHMgc21hbGxlciByZXNldCBtaW4taGVpZ2h0CiAgICAgICAgICAgICAgICAgICAgY2FjaGVkV2lkdGggPSBjdXJyZW50V2lkdGg7CiAgICAgICAgICAgICAgICAgICAgY2FjaGVkSGVpZ2h0ID0gY3VycmVudEhlaWdodDsKICAgICAgICAgICAgICAgICAgICBjYWNoZWRGb250U2l6ZSA9IGN1cnJlbnRGb250U2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwgNTApOwogICAgICAgIH0KCiAgICAgICAgLy8gc2V0dXAgYW5pbWF0aW9ucwogICAgICAgIHZhciBzaG93QW5pbSA9IHt9LCBoaWRlQW5pbSA9IHt9LCBzaG93U3BlZWQgPSBzZXR0aW5ncy5meFNob3dTcGVlZCB8fCBzZXR0aW5ncy5meFNwZWVkLCBoaWRlU3BlZWQgPSBzZXR0aW5ncy5meEhpZGVTcGVlZCB8fCBzZXR0aW5ncy5meFNwZWVkOwogICAgICAgIGlmIChzZXR0aW5ncy5meFNsaWRlIHx8IHNldHRpbmdzLmZ4RmFkZSkgewogICAgICAgICAgICBpZiAoc2V0dGluZ3MuZnhTbGlkZSkgewogICAgICAgICAgICAgICAgc2hvd0FuaW1bJ2hlaWdodCddID0gJ3Nob3cnOwogICAgICAgICAgICAgICAgaGlkZUFuaW1bJ2hlaWdodCddID0gJ2hpZGUnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5meEZhZGUpIHsKICAgICAgICAgICAgICAgIHNob3dBbmltWydvcGFjaXR5J10gPSAnc2hvdyc7CiAgICAgICAgICAgICAgICBoaWRlQW5pbVsnb3BhY2l0eSddID0gJ2hpZGUnOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmZ4U2hvdykgewogICAgICAgICAgICAgICAgc2hvd0FuaW0gPSBzZXR0aW5ncy5meFNob3c7CiAgICAgICAgICAgIH0gZWxzZSB7IC8vIHVzZSBzb21lIGtpbmQgb2YgYW5pbWF0aW9uIHRvIHByZXZlbnQgYnJvd3NlciBzY3JvbGxpbmcgdG8gdGhlIHRhYgogICAgICAgICAgICAgICAgc2hvd0FuaW1bJ21pbi13aWR0aCddID0gMDsgLy8gYXZvaWQgb3BhY2l0eSwgY2F1c2VzIGZsaWNrZXIgaW4gRmlyZWZveAogICAgICAgICAgICAgICAgc2hvd1NwZWVkID0gMTsgLy8gYXMgbGl0dGxlIGFzIDEgaXMgc3VmZmljaWVudAogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5meEhpZGUpIHsKICAgICAgICAgICAgICAgIGhpZGVBbmltID0gc2V0dGluZ3MuZnhIaWRlOwogICAgICAgICAgICB9IGVsc2UgeyAvLyB1c2Ugc29tZSBraW5kIG9mIGFuaW1hdGlvbiB0byBwcmV2ZW50IGJyb3dzZXIgc2Nyb2xsaW5nIHRvIHRoZSB0YWIKICAgICAgICAgICAgICAgIGhpZGVBbmltWydtaW4td2lkdGgnXSA9IDA7IC8vIGF2b2lkIG9wYWNpdHksIGNhdXNlcyBmbGlja2VyIGluIEZpcmVmb3gKICAgICAgICAgICAgICAgIGhpZGVTcGVlZCA9IDE7IC8vIGFzIGxpdHRsZSBhcyAxIGlzIHN1ZmZpY2llbnQKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbGJhY2tzCiAgICAgICAgdmFyIG9uQ2xpY2sgPSBzZXR0aW5ncy5vbkNsaWNrLCBvbkhpZGUgPSBzZXR0aW5ncy5vbkhpZGUsIG9uU2hvdyA9IHNldHRpbmdzLm9uU2hvdzsKCiAgICAgICAgLy8gYXR0YWNoIGFjdGl2YXRlVGFiIGV2ZW50LCByZXF1aXJlZCBmb3IgYWN0aXZhdGluZyBhIHRhYiBwcm9ncmFtbWF0aWNhbGx5CiAgICAgICAgdGFicy5iaW5kKCd0cmlnZ2VyVGFiJywgZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvLyBpZiB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQgb3IgZGlzYWJsZWQgb3IgYW5pbWF0aW9uIGlzIHN0aWxsIHJ1bm5pbmcgc3RvcCBoZXJlCiAgICAgICAgICAgIHZhciBsaSA9ICQodGhpcykucGFyZW50cygnbGk6ZXEoMCknKTsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5sb2NrZWQgfHwgbGkuaXMoJy4nICsgc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcykgfHwgbGkuaXMoJy4nICsgc2V0dGluZ3MuZGlzYWJsZWRDbGFzcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIGhhc2ggPSB0aGlzLmhhc2g7CgogICAgICAgICAgICBpZiAoJC5icm93c2VyLm1zaWUpIHsKCiAgICAgICAgICAgICAgICAkKHRoaXMpLnRyaWdnZXIoJ2NsaWNrJyk7CiAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuYm9va21hcmthYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgJC5hamF4SGlzdG9yeS51cGRhdGUoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9IGhhc2gucmVwbGFjZSgnIycsICcnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoJC5icm93c2VyLnNhZmFyaSkgewoKICAgICAgICAgICAgICAgIC8vIFNpbXBseSBzZXR0aW5nIGxvY2F0aW9uLmhhc2ggcHV0cyBTYWZhcmkgaW50byB0aGUgZXRlcm5hbCBsb2FkIHN0YXRlLi4uIHVnaCEgU3VibWl0IGEgZm9ybSBpbnN0ZWFkLgogICAgICAgICAgICAgICAgdmFyIHRlbXBGb3JtID0gJCgnPGZvcm0gYWN0aW9uPSInICsgaGFzaCArICciPjxkaXY+PGlucHV0IHR5cGU9InN1Ym1pdCIgdmFsdWU9ImgiIC8+PC9kaXY+PC9mb3JtPicpLmdldCgwKTsgLy8gbm8gbmVlZCB0byBhcHBlbmQgaXQgdG8gdGhlIGJvZHkKICAgICAgICAgICAgICAgIHRlbXBGb3JtLnN1Ym1pdCgpOyAvLyBkb2VzIG5vdCB0cmlnZ2VyIHRoZSBmb3JtJ3Mgc3VibWl0IGV2ZW50Li4uCiAgICAgICAgICAgICAgICAkKHRoaXMpLnRyaWdnZXIoJ2NsaWNrJyk7IC8vIC4uLnRodXMgZG8gc3R1ZmYgaGVyZQogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmJvb2ttYXJrYWJsZSkgewogICAgICAgICAgICAgICAgICAgICQuYWpheEhpc3RvcnkudXBkYXRlKGhhc2gpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuYm9va21hcmthYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgbG9jYXRpb24uaGFzaCA9IGhhc2gucmVwbGFjZSgnIycsICcnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS50cmlnZ2VyKCdjbGljaycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfQoKICAgICAgICB9KTsKCiAgICAgICAgLy8gYXR0YWNoIGRpc2FibGUgZXZlbnQsIHJlcXVpcmVkIGZvciBkaXNhYmxpbmcgYSB0YWIKICAgICAgICB0YWJzLmJpbmQoJ2Rpc2FibGVUYWInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGxpID0gJCh0aGlzKS5wYXJlbnRzKCdsaTplcSgwKScpOwogICAgICAgICAgICBpZiAoJC5icm93c2VyLnNhZmFyaSkgeyAvKiBmaXggb3BhY2l0eSBvZiB0YWIgYWZ0ZXIgZGlzYWJsaW5nIGluIFNhZmFyaS4uLiAqLwogICAgICAgICAgICAgICAgbGkuYW5pbWF0ZSh7IG9wYWNpdHk6IDAgfSwgMSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICBsaS5jc3Moe29wYWNpdHk6ICcnfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsaS5hZGRDbGFzcyhzZXR0aW5ncy5kaXNhYmxlZENsYXNzKTsKCiAgICAgICAgfSk7CgogICAgICAgIC8vIGRpc2FibGVkIGZyb20gc2V0dGluZ3MKICAgICAgICBpZiAoc2V0dGluZ3MuZGlzYWJsZWQgJiYgc2V0dGluZ3MuZGlzYWJsZWQubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBrID0gc2V0dGluZ3MuZGlzYWJsZWQubGVuZ3RoOyBpIDwgazsgaSsrKSB7CiAgICAgICAgICAgICAgICB0YWJzLnNsaWNlKC0tc2V0dGluZ3MuZGlzYWJsZWRbaV0sc2V0dGluZ3MuZGlzYWJsZWRbaV0rMSkudHJpZ2dlcignZGlzYWJsZVRhYicpLmVuZCgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgLy8gYXR0YWNoIGVuYWJsZSBldmVudCwgcmVxdWlyZWQgZm9yIHJlZW5hYmxpbmcgYSB0YWIKICAgICAgICB0YWJzLmJpbmQoJ2VuYWJsZVRhYicsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgbGkgPSAkKHRoaXMpLnBhcmVudHMoJ2xpOmVxKDApJyk7CiAgICAgICAgICAgIGxpLnJlbW92ZUNsYXNzKHNldHRpbmdzLmRpc2FibGVkQ2xhc3MpOwogICAgICAgICAgICBpZiAoJC5icm93c2VyLnNhZmFyaSkgeyAvKiBmaXggZGlzYXBwZWFyaW5nIHRhYiBhZnRlciBlbmFibGluZyBpbiBTYWZhcmkuLi4gKi8KICAgICAgICAgICAgICAgIGxpLmFuaW1hdGUoeyBvcGFjaXR5OiAxIH0sIDEsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGxpLmNzcyh7b3BhY2l0eTogJyd9KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgICAgIC8vIGF0dGFjaCBjbGljayBldmVudAogICAgICAgIHRhYnMuYmluZCgnY2xpY2snLCBmdW5jdGlvbihlKSB7CgogICAgICAgICAgICB2YXIgdHJ1ZUNsaWNrID0gZS5jbGllbnRYOyAvLyBhZGQgdG8gaGlzdG9yeSBvbmx5IGlmIHRydWUgY2xpY2sgb2NjdXJlZCwgbm90IGEgdHJpZ2dlcmVkIGNsaWNrCiAgICAgICAgICAgIHZhciBjbGlja2VkID0gdGhpcywgbGkgPSAkKHRoaXMpLnBhcmVudHMoJ2xpOmVxKDApJyksIHRvU2hvdyA9IGNvbnRhaW5lcnMuZmlsdGVyKHRoaXMuaGFzaCksIHRvSGlkZSA9IGNvbnRhaW5lcnMuZmlsdGVyKCc6dmlzaWJsZScpOwoKICAgICAgICAgICAgLy8gaWYgYW5pbWF0aW9uIGlzIHN0aWxsIHJ1bm5pbmcsIHRhYiBpcyBzZWxlY3RlZCBvciBkaXNhYmxlZCBvciBvbkNsaWNrIGNhbGxiYWNrIHJldHVybnMgZmFsc2Ugc3RvcCBoZXJlCiAgICAgICAgICAgIC8vIGNoZWNrIGlmIG9uQ2xpY2sgcmV0dXJucyBmYWxzZSBsYXN0IHNvIHRoYXQgaXQgaXMgbm90IGV4ZWN1dGVkIGZvciBhIGRpc2FibGVkIHRhYgogICAgICAgICAgICBpZiAoY29udGFpbmVyWydsb2NrZWQnXSB8fCBsaS5pcygnLicgKyBzZXR0aW5ncy5zZWxlY3RlZENsYXNzKSB8fCBsaS5pcygnLicgKyBzZXR0aW5ncy5kaXNhYmxlZENsYXNzKSB8fCB0eXBlb2Ygb25DbGljayA9PSAnZnVuY3Rpb24nICYmIG9uQ2xpY2suY2FsbCh0aGlzLCB0b1Nob3dbMF0sIHRvSGlkZVswXSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJsdXIoKTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29udGFpbmVyWydsb2NrZWQnXSA9IHRydWU7CgogICAgICAgICAgICAvLyBzaG93IG5ldyB0YWIKICAgICAgICAgICAgaWYgKHRvU2hvdy5zaXplKCkpIHsKCiAgICAgICAgICAgICAgICAvLyBwcmV2ZW50IHNjcm9sbGJhciBzY3JvbGxpbmcgdG8gMCBhbmQgdGhhbiBiYWNrIGluIElFNywgaGFwcGVucyBvbmx5IGlmIGJvb2ttYXJraW5nL2hpc3RvcnkgaXMgZW5hYmxlZAogICAgICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5tc2llICYmIHNldHRpbmdzLmJvb2ttYXJrYWJsZSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0b1Nob3dJZCA9IHRoaXMuaGFzaC5yZXBsYWNlKCcjJywgJycpOwogICAgICAgICAgICAgICAgICAgIHRvU2hvdy5hdHRyKCdpZCcsICcnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cuYXR0cignaWQnLCB0b1Nob3dJZCk7IC8vIHJlc3RvcmUgaWQKICAgICAgICAgICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgcmVzZXRDU1MgPSB7IGRpc3BsYXk6ICcnLCBvdmVyZmxvdzogJycsIGhlaWdodDogJycgfTsKICAgICAgICAgICAgICAgIGlmICghJC5icm93c2VyLm1zaWUpIHsgLy8gbm90IGluIElFIHRvIHByZXZlbnQgQ2xlYXJUeXBlIGZvbnQgaXNzdWUKICAgICAgICAgICAgICAgICAgICByZXNldENTU1snb3BhY2l0eSddID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vIHN3aXRjaCB0YWIsIGFuaW1hdGlvbiBwcmV2ZW50cyBicm93c2VyIHNjcm9sbGluZyB0byB0aGUgZnJhZ21lbnQKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHN3aXRjaFRhYigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2V0dGluZ3MuYm9va21hcmthYmxlICYmIHRydWVDbGljaykgeyAvLyBhZGQgdG8gaGlzdG9yeSBvbmx5IGlmIHRydWUgY2xpY2sgb2NjdXJlZCwgbm90IGEgdHJpZ2dlcmVkIGNsaWNrCiAgICAgICAgICAgICAgICAgICAgICAgICQuYWpheEhpc3RvcnkudXBkYXRlKGNsaWNrZWQuaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRvSGlkZS5hbmltYXRlKGhpZGVBbmltLCBoaWRlU3BlZWQsIGZ1bmN0aW9uKCkgeyAvLwogICAgICAgICAgICAgICAgICAgICAgICAkKGNsaWNrZWQpLnBhcmVudHMoJ2xpOmVxKDApJykuYWRkQ2xhc3Moc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcykuc2libGluZ3MoKS5yZW1vdmVDbGFzcyhzZXR0aW5ncy5zZWxlY3RlZENsYXNzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9IaWRlLmFkZENsYXNzKHNldHRpbmdzLmhpZGVDbGFzcykuY3NzKHJlc2V0Q1NTKTsgLy8gbWFpbnRhaW4gZmxleGlibGUgaGVpZ2h0IGFuZCBhY2Nlc3NpYmlsaXR5IGluIHByaW50IGV0Yy4gICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbkhpZGUgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25IaWRlLmNhbGwoY2xpY2tlZCwgdG9TaG93WzBdLCB0b0hpZGVbMF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKHNldHRpbmdzLmZ4U2xpZGUgfHwgc2V0dGluZ3MuZnhGYWRlIHx8IHNldHRpbmdzLmZ4U2hvdykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvU2hvdy5jc3MoJ2Rpc3BsYXknLCAnYmxvY2snKTsgLy8gcHJldmVudCBvY2Nhc2lvbmFsbHkgb2NjdXJpbmcgZmxpY2tlciBpbiBGaXJlZm94IGNhdXNlIGJ5IGdhcCBiZXR3ZWVuIHNob3dpbmcgYW5kIGhpZGluZyB0aGUgdGFiIGNvbnRhaW5lcnMKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cuYW5pbWF0ZShzaG93QW5pbSwgc2hvd1NwZWVkLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvU2hvdy5yZW1vdmVDbGFzcyhzZXR0aW5ncy5oaWRlQ2xhc3MpLmNzcyhyZXNldENTUyk7IC8vIG1haW50YWluIGZsZXhpYmxlIGhlaWdodCBhbmQgYWNjZXNzaWJpbGl0eSBpbiBwcmludCBldGMuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJC5icm93c2VyLm1zaWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b0hpZGVbMF0uc3R5bGUuZmlsdGVyID0gJyc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9TaG93WzBdLnN0eWxlLmZpbHRlciA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblNob3cgPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uU2hvdy5jYWxsKGNsaWNrZWQsIHRvU2hvd1swXSwgdG9IaWRlWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lclsnbG9ja2VkJ10gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoIWNsaWNrZWQucmVtb3RlKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoVGFiKCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQoY2xpY2tlZCkudHJpZ2dlcignbG9hZFJlbW90ZVRhYicsIFtzd2l0Y2hUYWJdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhbGVydCgnVGhlcmUgaXMgbm8gc3VjaCBjb250YWluZXIuJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNldCBzY3JvbGxiYXIgdG8gc2F2ZWQgcG9zaXRpb24gLSBuZWVkIHRvIHVzZSB0aW1lb3V0IHdpdGggMCB0byBwcmV2ZW50IGJyb3dzZXIgc2Nyb2xsIHRvIHRhcmdldCBvZiBoYXNoCiAgICAgICAgICAgIHZhciBzY3JvbGxYID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQgfHwgMDsKICAgICAgICAgICAgdmFyIHNjcm9sbFkgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgMDsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbyhzY3JvbGxYLCBzY3JvbGxZKTsKICAgICAgICAgICAgfSwgMCk7CgogICAgICAgICAgICB0aGlzLmJsdXIoKTsgLy8gcHJldmVudCBJRSBmcm9tIGtlZXBpbmcgb3RoZXIgbGluayBmb2N1c3NlZCB3aGVuIHVzaW5nIHRoZSBiYWNrIGJ1dHRvbgoKICAgICAgICAgICAgcmV0dXJuIHNldHRpbmdzLmJvb2ttYXJrYWJsZSAmJiAhIXRydWVDbGljazsgLy8gY29udmVydCB1bmRlZmluZWQgdG8gQm9vbGVhbiBmb3IgSUUKCiAgICAgICAgfSk7CgogICAgICAgIC8vIGVuYWJsZSBoaXN0b3J5IHN1cHBvcnQgaWYgYm9va21hcmtpbmcgYW5kIGhpc3RvcnkgaXMgdHVybmVkIG9uCiAgICAgICAgaWYgKHNldHRpbmdzLmJvb2ttYXJrYWJsZSkgewogICAgICAgICAgICAkLmFqYXhIaXN0b3J5LmluaXRpYWxpemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0YWJzLnNsaWNlKHNldHRpbmdzLmluaXRpYWwsc2V0dGluZ3MuaW5pdGlhbCsxKS50cmlnZ2VyKCdjbGljaycpLmVuZCgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgfSk7Cgp9OwoKLyoqCiAqIEFjdGl2YXRlIGEgdGFiIHByb2dyYW1tYXRpY2FsbHkgd2l0aCB0aGUgZ2l2ZW4gcG9zaXRpb24gKG5vIHplcm8tYmFzZWQgaW5kZXgpCiAqIG9yIGl0cyBpZCwgZS5nLiB0aGUgVVJMJ3MgZnJhZ21lbnQgaWRlbnRpZmllci9oYXNoIHJlcHJlc2VudGluZyBhIHRhYiwgYXMgaWYgdGhlIHRhYgogKiBpdHNlbGYgd2VyZSBjbGlja2VkLgogKgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudHJpZ2dlclRhYigyKTsKICogQGRlc2MgQWN0aXZhdGUgdGhlIHNlY29uZCB0YWIgb2YgdGhlIHRhYiBpbnRlcmZhY2UgY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudHJpZ2dlclRhYigxKTsKICogQGRlc2MgQWN0aXZhdGUgdGhlIGZpcnN0IHRhYiBvZiB0aGUgdGFiIGludGVyZmFjZSBjb250YWluZWQgaW4gPGRpdiBpZD0iY29udGFpbmVyIj4uCiAqIEBleGFtcGxlICQoJyNjb250YWluZXInKS50cmlnZ2VyVGFiKCk7CiAqIEBkZXNjIEFjdGl2YXRlIHRoZSBmaXJzdCB0YWIgb2YgdGhlIHRhYiBpbnRlcmZhY2UgY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudHJpZ2dlclRhYignZnJhZ21lbnQtMicpOwogKiBAZGVzYyBBY3RpdmF0ZSBhIHRhYiB2aWEgaXRzIFVSTCBmcmFnbWVudCBpZGVudGlmaWVyIHJlcHJlc2VudGF0aW9uLgogKgogKiBAcGFyYW0gU3RyaW5nfE51bWJlciB0YWIgRWl0aGVyIGEgc3RyaW5nIHRoYXQgbWF0Y2hlcyB0aGUgaWQgb2YgdGhlIHRhYiAodGhlIFVSTCdzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudCBpZGVudGlmaWVyL2hhc2ggcmVwcmVzZW50aW5nIGEgdGFiKSBvciBhbiBpbnRlZ2VyCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZ5aW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdGFiIChubyB6ZXJvLWJhc2VkIGluZGV4KSB0bwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgYmUgYWN0aXZhdGVkLiBJZiB0aGlzIHBhcmFtZXRlciBpcyBvbWl0dGVkLCB0aGUgZmlyc3QgdGFiCiAqICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGFjdGl2YXRlZC4KICogQHR5cGUgalF1ZXJ5CiAqCiAqIEBuYW1lIHRyaWdnZXJUYWIKICogQGNhdCBQbHVnaW5zL1RhYnMKICogQGF1dGhvciBLbGF1cyBIYXJ0bC9rbGF1cy5oYXJ0bEBzdGlsYnVlcm8uZGUKICovCgovKioKICogRGlzYWJsZSBhIHRhYiwgc28gdGhhdCBjbGlja2luZyBpdCBoYXMgbm8gZWZmZWN0LgogKgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykuZGlzYWJsZVRhYigyKTsKICogQGRlc2MgRGlzYWJsZSB0aGUgc2Vjb25kIHRhYiBvZiB0aGUgdGFiIGludGVyZmFjZSBjb250YWluZWQgaW4gPGRpdiBpZD0iY29udGFpbmVyIj4uCiAqCiAqIEBwYXJhbSBTdHJpbmd8TnVtYmVyIHRhYiBFaXRoZXIgYSBzdHJpbmcgdGhhdCBtYXRjaGVzIHRoZSBpZCBvZiB0aGUgdGFiICh0aGUgVVJMJ3MKICogICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50IGlkZW50aWZpZXIvaGFzaCByZXByZXNlbnRpbmcgYSB0YWIpIG9yIGFuIGludGVnZXIKICogICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZnlpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSB0YWIgKG5vIHplcm8tYmFzZWQgaW5kZXgpIHRvCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBiZSBkaXNhYmxlZC4gSWYgdGhpcyBwYXJhbWV0ZXIgaXMgb21pdHRlZCwgdGhlIGZpcnN0IHRhYgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSBkaXNhYmxlZC4KICogQHR5cGUgalF1ZXJ5CiAqCiAqIEBuYW1lIGRpc2FibGVUYWIKICogQGNhdCBQbHVnaW5zL1RhYnMKICogQGF1dGhvciBLbGF1cyBIYXJ0bC9rbGF1cy5oYXJ0bEBzdGlsYnVlcm8uZGUKICovCgovKioKICogRW5hYmxlIGEgdGFiIHRoYXQgaGFzIGJlZW4gZGlzYWJsZWQuCiAqCiAqIEBleGFtcGxlICQoJyNjb250YWluZXInKS5lbmFibGVUYWIoMik7CiAqIEBkZXNjIEVuYWJsZSB0aGUgc2Vjb25kIHRhYiBvZiB0aGUgdGFiIGludGVyZmFjZSBjb250YWluZWQgaW4gPGRpdiBpZD0iY29udGFpbmVyIj4uCiAqCiAqIEBwYXJhbSBTdHJpbmd8TnVtYmVyIHRhYiBFaXRoZXIgYSBzdHJpbmcgdGhhdCBtYXRjaGVzIHRoZSBpZCBvZiB0aGUgdGFiICh0aGUgVVJMJ3MKICogICAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50IGlkZW50aWZpZXIvaGFzaCByZXByZXNlbnRpbmcgYSB0YWIpIG9yIGFuIGludGVnZXIKICogICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWNpZnlpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSB0YWIgKG5vIHplcm8tYmFzZWQgaW5kZXgpIHRvCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBiZSBlbmFibGVkLiBJZiB0aGlzIHBhcmFtZXRlciBpcyBvbWl0dGVkLCB0aGUgZmlyc3QgdGFiCiAqICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlIGVuYWJsZWQuCiAqIEB0eXBlIGpRdWVyeQogKgogKiBAbmFtZSBlbmFibGVUYWIKICogQGNhdCBQbHVnaW5zL1RhYnMKICogQGF1dGhvciBLbGF1cyBIYXJ0bC9rbGF1cy5oYXJ0bEBzdGlsYnVlcm8uZGUKICovCgp2YXIgdGFiRXZlbnRzID0gWyd0cmlnZ2VyVGFiJywgJ2Rpc2FibGVUYWInLCAnZW5hYmxlVGFiJ107CmZvciAodmFyIGkgPSAwOyBpIDwgdGFiRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAkLmZuW3RhYkV2ZW50c1tpXV0gPSAoZnVuY3Rpb24odGFiRXZlbnQpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24odGFiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgbmF2ID0gJCgndWwudGFicy1uYXYnICwgdGhpcyk7CiAgICAgICAgICAgICAgICBuYXYgPSBuYXYuc2l6ZSgpICYmIG5hdiB8fCAkKCc+dWw6ZXEoMCknLCB0aGlzKTsgLy8gZmFsbGJhY2sgdG8gZGVmYXVsdCBzdHJ1Y3R1cmUKICAgICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgICAgaWYgKCF0YWIgfHwgdHlwZW9mIHRhYiA9PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgIHZhciB0bnVtID0gKHRhYiAmJiB0YWIgPiAwICYmIHRhYiAtIDEgfHwgMCk7CiAgICAgICAgICAgICAgICAgICAgYSA9ICQoJ2xpIGEnLCBuYXYpLnNsaWNlKHRudW0sIHRudW0rMSk7IC8vIGZhbGwgYmFjayB0byAwCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0YWIgPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhID0gJCgnbGkgYVtAaHJlZiQ9IiMnICsgdGFiICsgJyJdJywgbmF2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGEudHJpZ2dlcih0YWJFdmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH07CiAgICB9KSh0YWJFdmVudHNbaV0pOwp9CgovKioKICogR2V0IHRoZSBwb3NpdGlvbiBvZiB0aGUgY3VycmVudGx5IHNlbGVjdGVkIHRhYiAobm8gemVyby1iYXNlZCBpbmRleCkuCiAqCiAqIEBleGFtcGxlICQoJyNjb250YWluZXInKS5hY3RpdmVUYWIoKTsKICogQGRlc2MgR2V0IHRoZSBwb3NpdGlvbiBvZiB0aGUgY3VycmVudGx5IHNlbGVjdGVkIHRhYiBvZiBhbiBpbnRlcmZhY2UKICogY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKgogKiBAdHlwZSBOdW1iZXIKICoKICogQG5hbWUgYWN0aXZlVGFiCiAqIEBjYXQgUGx1Z2lucy9UYWJzCiAqIEBhdXRob3IgS2xhdXMgSGFydGwva2xhdXMuaGFydGxAc3RpbGJ1ZXJvLmRlCiAqLwoKJC5mbi5hY3RpdmVUYWIgPSBmdW5jdGlvbigpIHsKICAgIHZhciBzZWxlY3RlZFRhYnMgPSBbXTsKICAgIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbmF2ID0gJCgndWwudGFicy1uYXYnICwgdGhpcyk7CiAgICAgICAgbmF2ID0gbmF2LnNpemUoKSAmJiBuYXYgfHwgJCgnPnVsOmVxKDApJywgdGhpcyk7IC8vZmFsbGJhY2sgdG8gZGVmYXVsdCBzdHJ1Y3R1cmUKICAgICAgICB2YXIgbGlzID0gJCgnbGknLCBuYXYpOwogICAgICAgIHNlbGVjdGVkVGFicy5wdXNoKGxpcy5pbmRleCggbGlzLmZpbHRlcignLnRhYnMtc2VsZWN0ZWQnKVswXSApICsgMSk7CiAgICB9KTsKICAgIHJldHVybiBzZWxlY3RlZFRhYnNbMF07Cn07Cgp9KShqUXVlcnkpOwo=",
                "body": "LyoqCiAqIFRhYnMgLSBqUXVlcnkgcGx1Z2luIGZvciBhY2Nlc3NpYmxlLCB1bm9idHJ1c2l2ZSB0YWJzCiAqIEByZXF1aXJlcyBqUXVlcnkgdjEuMC4zCiAqCiAqIGh0dHA6Ly9zdGlsYnVlcm8uZGUvdGFicy8KICoKICogQ29weXJpZ2h0IChjKSAyMDA2IEtsYXVzIEhhcnRsIChzdGlsYnVlcm8uZGUpCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzOgogKiBodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocAogKiBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogVmVyc2lvbjogMi43LjQKICovCgooZnVuY3Rpb24oJCkgeyAvLyBibG9jayBzY29wZQoKJC5leHRlbmQoewogICAgdGFiczogewogICAgICAgIHJlbW90ZUNvdW50OiAwIC8vIFRPRE8gaW4gVGFicyAzIHRoaXMgaXMgZ29pbmcgdG8gYmUgbW9yZSBjbGVhbmx5IGluIG9uZSBzaW5nbGUgbmFtZXNwYWNlCiAgICB9Cn0pOwoKLyoqCiAqIENyZWF0ZSBhbiBhY2Nlc3NpYmxlLCB1bm9idHJ1c2l2ZSB0YWIgaW50ZXJmYWNlIGJhc2VkIG9uIGEgcGFydGljdWxhciBIVE1MIHN0cnVjdHVyZS4KICoKICogVGhlIHVuZGVybHlpbmcgSFRNTCBoYXMgdG8gbG9vayBsaWtlIHRoaXM6CiAqCiAqIDxkaXYgaWQ9ImNvbnRhaW5lciI+CiAqICAgICA8dWw+CiAqICAgICAgICAgPGxpPjxhIGhyZWY9IiNmcmFnbWVudC0xIj5TZWN0aW9uIDE8L2E+PC9saT4KICogICAgICAgICA8bGk+PGEgaHJlZj0iI2ZyYWdtZW50LTIiPlNlY3Rpb24gMjwvYT48L2xpPgogKiAgICAgICAgIDxsaT48YSBocmVmPSIjZnJhZ21lbnQtMyI+U2VjdGlvbiAzPC9hPjwvbGk+CiAqICAgICA8L3VsPgogKiAgICAgPGRpdiBpZD0iZnJhZ21lbnQtMSI+CiAqCiAqICAgICA8L2Rpdj4KICogICAgIDxkaXYgaWQ9ImZyYWdtZW50LTIiPgogKgogKiAgICAgPC9kaXY+CiAqICAgICA8ZGl2IGlkPSJmcmFnbWVudC0zIj4KICoKICogICAgIDwvZGl2PgogKiA8L2Rpdj4KICoKICogRWFjaCBhbmNob3IgaW4gdGhlIHVub3JkZXJlZCBsaXN0IHBvaW50cyBkaXJlY3RseSB0byBhIHNlY3Rpb24gYmVsb3cgcmVwcmVzZW50ZWQgYnkgb25lIG9mIHRoZQogKiBkaXZzICh0aGUgVVJJIGluIHRoZSBhbmNob3IncyBocmVmIGF0dHJpYnV0ZSByZWZlcnMgdG8gdGhlIGZyYWdtZW50IHdpdGggdGhlIGNvcnJlc3BvbmRpbmcgaWQpLgogKiBCZWNhdXNlIHN1Y2ggSFRNTCBzdHJ1Y3R1cmUgaXMgZnVsbHkgZnVuY3Rpb25hbCBvbiBpdHMgb3duLCBlLmcuIHdpdGhvdXQgSmF2YVNjcmlwdCwgdGhlIHRhYgogKiBpbnRlcmZhY2UgaXMgYWNjZXNzaWJsZSBhbmQgdW5vYnRydXNpdmUuCiAqCiAqIEEgdGFiIGlzIGFsc28gYm9va21hcmthYmxlIHZpYSBoYXNoIGluIHRoZSBVUkwuIFVzZSB0aGUgSGlzdG9yeS9SZW1vdGUgcGx1Z2luIChUYWJzIHdpbGwKICogYXV0by1kZXRlY3QgaXRzIHByZXNlbmNlKSB0byBmaXggdGhlIGJhY2sgKGFuZCBmb3J3YXJkKSBidXR0b24uCiAqCiAqIEBleGFtcGxlICQoJyNjb250YWluZXInKS50YWJzKCk7CiAqIEBkZXNjIENyZWF0ZSBhIGJhc2ljIHRhYiBpbnRlcmZhY2UuCiAqIEBleGFtcGxlICQoJyNjb250YWluZXInKS50YWJzKDIpOwogKiBAZGVzYyBDcmVhdGUgYSBiYXNpYyB0YWIgaW50ZXJmYWNlIHdpdGggdGhlIHNlY29uZCB0YWIgaW5pdGlhbGx5IGFjdGl2YXRlZC4KICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRhYnMoe2Rpc2FibGVkOiBbMywgNF19KTsKICogQGRlc2MgQ3JlYXRlIGEgdGFiIGludGVyZmFjZSB3aXRoIHRoZSB0aGlyZCBhbmQgZm91cnRoIHRhYiBiZWluZyBkaXNhYmxlZC4KICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRhYnMoe2Z4U2xpZGU6IHRydWV9KTsKICogQGRlc2MgQ3JlYXRlIGEgdGFiIGludGVyZmFjZSB0aGF0IHVzZXMgc2xpZGUgZG93bi91cCBhbmltYXRpb25zIGZvciBzaG93aW5nL2hpZGluZyB0YWIKICogICAgICAgY29udGVudCB1cG9uIHRhYiBzd2l0Y2hpbmcuCiAqCiAqIEBwYXJhbSBOdW1iZXIgaW5pdGlhbCBBbiBpbnRlZ2VyIHNwZWNpZnlpbmcgdGhlIHBvc2l0aW9uIG9mIHRoZSB0YWIgKG5vIHplcm8tYmFzZWQgaW5kZXgpIHRoYXQKICogICAgICAgICAgICAgICAgICAgICAgIGdldHMgYWN0aXZhdGVkIGF0IGZpcnN0IChvbiBwYWdlIGxvYWQpLiBUd28gYWx0ZXJuYXRpdmUgd2F5cyB0byBzcGVjaWZ5CiAqICAgICAgICAgICAgICAgICAgICAgICB0aGUgYWN0aXZlIHRhYiB3aWxsIG92ZXJydWxlIHRoaXMgYXJndW1lbnQuIEZpcnN0IGEgbGkgZWxlbWVudAogKiAgICAgICAgICAgICAgICAgICAgICAgKHJlcHJlc2VudGluZyBvbmUgc2luZ2xlIHRhYikgYmVsb25naW5nIHRvIHRoZSBzZWxlY3RlZCB0YWIgY2xhc3MsIGUuZy4KICogICAgICAgICAgICAgICAgICAgICAgIHNldCB0aGUgc2VsZWN0ZWQgdGFiIGNsYXNzIChkZWZhdWx0OiAidGFicy1zZWxlY3RlZCIsIHNlZSBvcHRpb24KICogICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkQ2xhc3MpIGZvciBvbmUgb2YgdGhlIHVub3JkZXJlZCBsaSBlbGVtZW50cyBpbiB0aGUgSFRNTCBzb3VyY2UuCiAqICAgICAgICAgICAgICAgICAgICAgICBJbiBhZGRpdGlvbiBpZiBhIGZyYWdtZW50IGlkZW50aWZpZXIvaGFzaCBpbiB0aGUgVVJMIG9mIHRoZSBwYWdlIHJlZmVycwogKiAgICAgICAgICAgICAgICAgICAgICAgdG8gdGhlIGlkIG9mIGEgdGFiIGNvbnRhaW5lciBvZiBhIHRhYiBpbnRlcmZhY2UgdGhlIGNvcnJlc3BvbmRpbmcgdGFiIHdpbGwKICogICAgICAgICAgICAgICAgICAgICAgIGJlIGFjdGl2YXRlZCBhbmQgYm90aCB0aGUgaW5pdGlhbCBhcmd1bWVudCBhcyB3ZWxsIGFzIGFuIGV2ZW50dWFsbHkKICogICAgICAgICAgICAgICAgICAgICAgIGRlY2xhcmVkIGNsYXNzIGF0dHJpYnV0ZSB3aWxsIGJlIG92ZXJydWxlZC4gRGVmYXVsdHMgdG8gMSBpZiBvbWl0dGVkLgogKiBAcGFyYW0gT2JqZWN0IHNldHRpbmdzIEFuIG9iamVjdCBsaXRlcmFsIGNvbnRhaW5pbmcga2V5L3ZhbHVlIHBhaXJzIHRvIHByb3ZpZGUgb3B0aW9uYWwgc2V0dGluZ3MuCiAqIEBvcHRpb24gQXJyYXk8TnVtYmVyPiBkaXNhYmxlZCBBbiBhcnJheSBjb250YWluaW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdGFicyAobm8gemVyby1iYXNlZCBpbmRleCkKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQgc2hvdWxkIGJlIGRpc2FibGVkIG9uIGluaXRpYWxpemF0aW9uLiBEZWZhdWx0IHZhbHVlOiBudWxsLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQSB0YWIgY2FuIGFsc28gYmUgZGlzYWJsZWQgYnkgc2ltcGx5IGFkZGluZyB0aGUgZGlzYWJsaW5nIGNsYXNzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoZGVmYXVsdDogInRhYnMtZGlzYWJsZWQiLCBzZWUgb3B0aW9uIGRpc2FibGVkQ2xhc3MpIHRvIHRoZSBsaQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxlbWVudCByZXByZXNlbnRpbmcgdGhhdCBwYXJ0aWN1bGFyIHRhYi4KICogQG9wdGlvbiBCb29sZWFuIGJvb2ttYXJrYWJsZSBCb29sZWFuIGZsYWcgaW5kaWNhdGluZyBpZiBzdXBwb3J0IGZvciBib29rbWFya2luZyBhbmQgaGlzdG9yeSAodmlhCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdpbmcgaGFzaCBpbiB0aGUgVVJMIG9mIHRoZSBicm93c2VyKSBpcyBlbmFibGVkLiBEZWZhdWx0IHZhbHVlOgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbHNlLCB1bmxlc3MgdGhlIEhpc3RvcnkvUmVtb3RlIHBsdWdpbiBpcyBpbmNsdWRlZC4gSW4gdGhhdCBjYXNlIHRoZQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQgdmFsdWUgYmVjb21lcyB0cnVlLiBAc2VlICQuYWpheEhpc3RvcnkuaW5pdGlhbGl6ZQogKiBAb3B0aW9uIEJvb2xlYW4gcmVtb3RlIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIHRoYXQgdGFiIGNvbnRlbnQgaGFzIHRvIGJlIGxvYWRlZCByZW1vdGVseSBmcm9tCiAqICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHVybCBnaXZlbiBpbiB0aGUgaHJlZiBhdHRyaWJ1dGUgb2YgdGhlIHRhYiBtZW51IGFuY2hvciBlbGVtZW50cy4KICogQG9wdGlvbiBTdHJpbmcgc3Bpbm5lciBUaGUgY29udGVudCBvZiB0aGlzIHN0cmluZyBpcyBzaG93biBpbiBhIHRhYiB3aGlsZSByZW1vdGUgY29udGVudCBpcyBsb2FkaW5nLgogKiAgICAgICAgICAgICAgICAgICAgICAgIEluc2VydCBwbGFpbiB0ZXh0IGFzIHdlbGwgYXMgYW4gaW1nIGhlcmUuIFRvIHR1cm4gb2ZmIHRoaXMgbm90aWZpY2F0aW9uCiAqICAgICAgICAgICAgICAgICAgICAgICAgcGFzcyBhbiBlbXB0eSBzdHJpbmcgb3IgbnVsbC4gRGVmYXVsdDogIkxvYWRpbmcmIzgyMzA7Ii4KICogQG9wdGlvbiBTdHJpbmcgaGFzaFByZWZpeCBBIFN0cmluZyB0aGF0IGlzIHVzZWQgZm9yIGNvbnN0cnVjdGluZyB0aGUgaGFzaCB0aGUgbGluaydzIGhyZWYgYXR0cmlidXRlCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgb2YgYSByZW1vdGUgdGFiIGdldHMgYWx0ZXJlZCB0bywgc3VjaCBhcyAiI3JlbW90ZS0xIi4KICogICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAicmVtb3RlLXRhYi0iLgogKiBAb3B0aW9uIEJvb2xlYW4gZnhGYWRlIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgZmFkZSBpbi9vdXQgYW5pbWF0aW9ucyBhcmUgdXNlZCBmb3IgdGFiCiAqICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoaW5nLiBDYW4gYmUgY29tYmluZWQgd2l0aCBmeFNsaWRlLiBXaWxsIG92ZXJydWxlIGZ4U2hvdy9meEhpZGUuCiAqICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogZmFsc2UuCiAqIEBvcHRpb24gQm9vbGVhbiBmeFNsaWRlIEJvb2xlYW4gZmxhZyBpbmRpY2F0aW5nIHdoZXRoZXIgc2xpZGUgZG93bi91cCBhbmltYXRpb25zIGFyZSB1c2VkIGZvciB0YWIKICogICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoaW5nLiBDYW4gYmUgY29tYmluZWQgd2l0aCBmeEZhZGUuIFdpbGwgb3ZlcnJ1bGUgZnhTaG93L2Z4SGlkZS4KICogICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogZmFsc2UuCiAqIEBvcHRpb24gU3RyaW5nfE51bWJlciBmeFNwZWVkIEEgc3RyaW5nIHJlcHJlc2VudGluZyBvbmUgb2YgdGhlIHRocmVlIHByZWRlZmluZWQgc3BlZWRzICgic2xvdyIsCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJub3JtYWwiLCBvciAiZmFzdCIpIG9yIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIChlLmcuIDEwMDApIHRvCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1biBhbiBhbmltYXRpb24uIERlZmF1bHQgdmFsdWU6ICJub3JtYWwiLgogKiBAb3B0aW9uIE9iamVjdCBmeFNob3cgQW4gb2JqZWN0IGxpdGVyYWwgb2YgdGhlIGZvcm0galF1ZXJ5J3MgYW5pbWF0ZSBmdW5jdGlvbiBleHBlY3RzIGZvciBtYWtpbmcKICogICAgICAgICAgICAgICAgICAgICAgIHlvdXIgb3duLCBjdXN0b20gYW5pbWF0aW9uIHRvIHJldmVhbCBhIHRhYiB1cG9uIHRhYiBzd2l0Y2guIFVubGlrZSBmeEZhZGUKICogICAgICAgICAgICAgICAgICAgICAgIG9yIGZ4U2xpZGUgdGhpcyBhbmltYXRpb24gaXMgaW5kZXBlbmRlbnQgZnJvbSBhbiBvcHRpb25hbCBoaWRlIGFuaW1hdGlvbi4KICogICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IG51bGwuIEBzZWUgYW5pbWF0ZQogKiBAb3B0aW9uIE9iamVjdCBmeEhpZGUgQW4gb2JqZWN0IGxpdGVyYWwgb2YgdGhlIGZvcm0galF1ZXJ5J3MgYW5pbWF0ZSBmdW5jdGlvbiBleHBlY3RzIGZvciBtYWtpbmcKICogICAgICAgICAgICAgICAgICAgICAgIHlvdXIgb3duLCBjdXN0b20gYW5pbWF0aW9uIHRvIGhpZGUgYSB0YWIgdXBvbiB0YWIgc3dpdGNoLiBVbmxpa2UgZnhGYWRlCiAqICAgICAgICAgICAgICAgICAgICAgICBvciBmeFNsaWRlIHRoaXMgYW5pbWF0aW9uIGlzIGluZGVwZW5kZW50IGZyb20gYW4gb3B0aW9uYWwgc2hvdyBhbmltYXRpb24uCiAqICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBudWxsLiBAc2VlIGFuaW1hdGUKICogQG9wdGlvbiBTdHJpbmd8TnVtYmVyIGZ4U2hvd1NwZWVkIEEgc3RyaW5nIHJlcHJlc2VudGluZyBvbmUgb2YgdGhlIHRocmVlIHByZWRlZmluZWQgc3BlZWRzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoInNsb3ciLCAibm9ybWFsIiwgb3IgImZhc3QiKSBvciB0aGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGUuZy4gMTAwMCkgdG8gcnVuIHRoZSBhbmltYXRpb24gc3BlY2lmaWVkIGluIGZ4U2hvdy4KICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IGZ4U3BlZWQuCiAqIEBvcHRpb24gU3RyaW5nfE51bWJlciBmeEhpZGVTcGVlZCBBIHN0cmluZyByZXByZXNlbnRpbmcgb25lIG9mIHRoZSB0aHJlZSBwcmVkZWZpbmVkIHNwZWVkcwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKCJzbG93IiwgIm5vcm1hbCIsIG9yICJmYXN0Iikgb3IgdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChlLmcuIDEwMDApIHRvIHJ1biB0aGUgYW5pbWF0aW9uIHNwZWNpZmllZCBpbiBmeEhpZGUuCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBmeFNwZWVkLgogKiBAb3B0aW9uIEJvb2xlYW4gZnhBdXRvSGVpZ2h0IEJvb2xlYW4gZmxhZyB0aGF0IGlmIHNldCB0byB0cnVlIGNhdXNlcyBhbGwgdGFiIGhlaWdodHMKICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0byBiZSBjb25zdGFudCAoYmVpbmcgdGhlIGhlaWdodCBvZiB0aGUgdGFsbGVzdCB0YWIpLgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6IGZhbHNlLgogKiBAb3B0aW9uIEZ1bmN0aW9uIG9uQ2xpY2sgQSBmdW5jdGlvbiB0byBiZSBpbnZva2VkIHVwb24gdGFiIHN3aXRjaCwgaW1tZWRpYXRseSBhZnRlciBhIHRhYiBoYXMKICogICAgICAgICAgICAgICAgICAgICAgICAgIGJlZW4gY2xpY2tlZCwgZS5nLiBiZWZvcmUgdGhlIG90aGVyJ3MgdGFiIGNvbnRlbnQgZ2V0cyBoaWRkZW4uIFRoZQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gZ2V0cyBwYXNzZWQgdGhyZWUgYXJndW1lbnRzOiB0aGUgZmlyc3Qgb25lIGlzIHRoZSBjbGlja2VkCiAqICAgICAgICAgICAgICAgICAgICAgICAgICB0YWIgKGUuZy4gYW4gYW5jaG9yIGVsZW1lbnQpLCB0aGUgc2Vjb25kIG9uZSBpcyB0aGUgRE9NIGVsZW1lbnQKICogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5pbmcgdGhlIGNvbnRlbnQgb2YgdGhlIGNsaWNrZWQgdGFiIChlLmcuIHRoZSBkaXYpLCB0aGUgdGhpcmQKICogICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3VtZW50IGlzIHRoZSBvbmUgb2YgdGhlIHRhYiB0aGF0IGdldHMgaGlkZGVuLiBJZiB0aGlzIGNhbGxiYWNrCiAqICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5zIGZhbHNlLCB0aGUgdGFiIHN3aXRjaCBpcyBjYW5jZWxlZCAodXNlIHRvIGRpc2FsbG93IHRhYgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoaW5nIGZvciB0aGUgcmVhc29uIG9mIGEgZmFpbGVkIGZvcm0gdmFsaWRhdGlvbiBmb3IgZXhhbXBsZSkuCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiBudWxsLgogKiBAb3B0aW9uIEZ1bmN0aW9uIG9uSGlkZSBBIGZ1bmN0aW9uIHRvIGJlIGludm9rZWQgdXBvbiB0YWIgc3dpdGNoLCBpbW1lZGlhdGx5IGFmdGVyIG9uZSB0YWIncwogKiAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50IGdvdCBoaWRkZW4gKHdpdGggb3Igd2l0aG91dCBhbiBhbmltYXRpb24pIGFuZCByaWdodCBiZWZvcmUgdGhlCiAqICAgICAgICAgICAgICAgICAgICAgICAgIG5leHQgdGFiIGlzIHJldmVhbGVkLiBUaGUgZnVuY3Rpb24gZ2V0cyBwYXNzZWQgdGhyZWUgYXJndW1lbnRzOiB0aGUKICogICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3Qgb25lIGlzIHRoZSBjbGlja2VkIHRhYiAoZS5nLiBhbiBhbmNob3IgZWxlbWVudCksIHRoZSBzZWNvbmQgb25lCiAqICAgICAgICAgICAgICAgICAgICAgICAgIGlzIHRoZSBET00gZWxlbWVudCBjb250YWluaW5nIHRoZSBjb250ZW50IG9mIHRoZSBjbGlja2VkIHRhYiwgKGUuZy4gdGhlCiAqICAgICAgICAgICAgICAgICAgICAgICAgIGRpdiksIHRoZSB0aGlyZCBhcmd1bWVudCBpcyB0aGUgb25lIG9mIHRoZSB0YWIgdGhhdCBnZXRzIGhpZGRlbi4KICogICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogbnVsbC4KICogQG9wdGlvbiBGdW5jdGlvbiBvblNob3cgQSBmdW5jdGlvbiB0byBiZSBpbnZva2VkIHVwb24gdGFiIHN3aXRjaC4gVGhpcyBmdW5jdGlvbiBpcyBpbnZva2VkCiAqICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyIHRoZSBuZXcgdGFiIGhhcyBiZWVuIHJldmVhbGVkLCBlLmcuIGFmdGVyIHRoZSBzd2l0Y2ggaXMgY29tcGxldGVkLgogKiAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZnVuY3Rpb24gZ2V0cyBwYXNzZWQgdGhyZWUgYXJndW1lbnRzOiB0aGUgZmlyc3Qgb25lIGlzIHRoZSBjbGlja2VkCiAqICAgICAgICAgICAgICAgICAgICAgICAgIHRhYiAoZS5nLiBhbiBhbmNob3IgZWxlbWVudCksIHRoZSBzZWNvbmQgb25lIGlzIHRoZSBET00gZWxlbWVudAogKiAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluaW5nIHRoZSBjb250ZW50IG9mIHRoZSBjbGlja2VkIHRhYiwgKGUuZy4gdGhlIGRpdiksIHRoZSB0aGlyZAogKiAgICAgICAgICAgICAgICAgICAgICAgICBhcmd1bWVudCBpcyB0aGUgb25lIG9mIHRoZSB0YWIgdGhhdCBnZXRzIGhpZGRlbi4gRGVmYXVsdCB2YWx1ZTogbnVsbC4KICogQG9wdGlvbiBTdHJpbmcgbmF2Q2xhc3MgQSBDU1MgY2xhc3MgdGhhdCBpcyB1c2VkIHRvIGlkZW50aWZ5IHRoZSB0YWJzIHVub3JkZXJlZCBsaXN0IGJ5IGNsYXNzIGlmCiAqICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSByZXF1aXJlZCBIVE1MIHN0cnVjdHVyZSBkaWZmZXJzIGZyb20gdGhlIGRlZmF1bHQgb25lLgogKiAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0IHZhbHVlOiAidGFicy1uYXYiLgogKiBAb3B0aW9uIFN0cmluZyBzZWxlY3RlZENsYXNzIFRoZSBDU1MgY2xhc3MgYXR0YWNoZWQgdG8gdGhlIGxpIGVsZW1lbnQgcmVwcmVzZW50aW5nIHRoZQogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRseSBzZWxlY3RlZCAoYWN0aXZlKSB0YWIuIERlZmF1bHQgdmFsdWU6ICJ0YWJzLXNlbGVjdGVkIi4KICogQG9wdGlvbiBTdHJpbmcgZGlzYWJsZWRDbGFzcyBUaGUgQ1NTIGNsYXNzIGF0dGFjaGVkIHRvIHRoZSBsaSBlbGVtZW50IHJlcHJlc2VudGluZyBhIGRpc2FibGVkCiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFiLiBEZWZhdWx0IHZhbHVlOiAidGFicy1kaXNhYmxlZCIuCiAqIEBvcHRpb24gU3RyaW5nIGNvbnRhaW5lckNsYXNzIEEgQ1NTIGNsYXNzIHRoYXQgaXMgdXNlZCB0byBpZGVudGlmeSB0YWIgY29udGFpbmVycyBieSBjbGFzcyBpZgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgcmVxdWlyZWQgSFRNTCBzdHJ1Y3R1cmUgZGlmZmVycyBmcm9tIHRoZSBkZWZhdWx0IG9uZS4KICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVmYXVsdCB2YWx1ZTogInRhYnMtY29udGFpbmVyIi4KICogQG9wdGlvbiBTdHJpbmcgaGlkZUNsYXNzIFRoZSBDU1MgY2xhc3MgdXNlZCBmb3IgaGlkaW5nIGluYWN0aXZlIHRhYnMuIEEgY2xhc3MgaXMgdXNlZCBpbnN0ZWFkCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBvZiAiZGlzcGxheTogbm9uZSIgaW4gdGhlIHN0eWxlIGF0dHJpYnV0ZSB0byBtYWludGFpbiBjb250cm9sIG92ZXIKICogICAgICAgICAgICAgICAgICAgICAgICAgIHZpc2liaWxpdHkgaW4gb3RoZXIgbWVkaWEgdHlwZXMgdGhhbiBzY3JlZW4sIG1vc3Qgbm90YWJseSBwcmludC4KICogICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICJ0YWJzLWhpZGUiLgogKiBAb3B0aW9uIFN0cmluZyBsb2FkaW5nQ2xhc3MgVGhlIENTUyBjbGFzcyB1c2VkIGZvciBpbmRpY2F0aW5nIHRoYXQgYW4gQWpheCB0YWIgaXMgY3VycmVudGx5CiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkaW5nLCBmb3IgZXhhbXBsZSBieSBzaG93aW5nIGEgc3Bpbm5lci4KICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICJ0YWJzLWxvYWRpbmciLgogKiBAb3B0aW9uIFN0cmluZyB0YWJTdHJ1Y3QgQGRlcHJlY2F0ZWQgQSBDU1Mgc2VsZWN0b3Igb3IgYmFzaWMgWFBhdGggZXhwcmVzc2lvbiByZWZsZWN0aW5nIGEKICogICAgICAgICAgICAgICAgICAgICAgICAgIG5lc3RlZCBIVE1MIHN0cnVjdHVyZSB0aGF0IGlzIGRpZmZlcmVudCBmcm9tIHRoZSBkZWZhdWx0IHNpbmdsZSBkaXYKICogICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVjdHVyZSAob25lIGRpdiB3aXRoIGFuIGlkIGluc2lkZSB0aGUgb3ZlcmFsbCBjb250YWluZXIgaG9sZHMgb25lCiAqICAgICAgICAgICAgICAgICAgICAgICAgICB0YWIncyBjb250ZW50KS4gSWYgZm9yIGluc3RhbmNlIGFuIGFkZGl0aW9uYWwgZGl2IGlzIHJlcXVpcmVkIHRvIHdyYXAKICogICAgICAgICAgICAgICAgICAgICAgICAgIHVwIHRoZSBzZXZlcmFsIHRhYiBjb250YWluZXJzIHN1Y2ggYSBzdHJ1Y3R1cmUgaXMgZXhwcmVzc2VkIGJ5ICJkaXY+ZGl2Ii4KICogICAgICAgICAgICAgICAgICAgICAgICAgIERlZmF1bHQgdmFsdWU6ICJkaXYiLgogKiBAdHlwZSBqUXVlcnkKICoKICogQG5hbWUgdGFicwogKiBAY2F0IFBsdWdpbnMvVGFicwogKiBAYXV0aG9yIEtsYXVzIEhhcnRsL2tsYXVzLmhhcnRsQHN0aWxidWVyby5kZQogKi8KJC5mbi50YWJzID0gZnVuY3Rpb24oaW5pdGlhbCwgc2V0dGluZ3MpIHsKCiAgICAvLyBzZXR0aW5ncwogICAgaWYgKHR5cGVvZiBpbml0aWFsID09ICdvYmplY3QnKSBzZXR0aW5ncyA9IGluaXRpYWw7IC8vIG5vIGluaXRpYWwgdGFiIGdpdmVuIGJ1dCBhIHNldHRpbmdzIG9iamVjdAogICAgc2V0dGluZ3MgPSAkLmV4dGVuZCh7CiAgICAgICAgaW5pdGlhbDogKGluaXRpYWwgJiYgdHlwZW9mIGluaXRpYWwgPT0gJ251bWJlcicgJiYgaW5pdGlhbCA+IDApID8gLS1pbml0aWFsIDogMCwKICAgICAgICBkaXNhYmxlZDogbnVsbCwKICAgICAgICBib29rbWFya2FibGU6ICQuYWpheEhpc3RvcnkgPyB0cnVlIDogZmFsc2UsCiAgICAgICAgcmVtb3RlOiBmYWxzZSwKICAgICAgICBzcGlubmVyOiAnTG9hZGluZyYjODIzMDsnLAogICAgICAgIGhhc2hQcmVmaXg6ICdyZW1vdGUtdGFiLScsCiAgICAgICAgZnhGYWRlOiBudWxsLAogICAgICAgIGZ4U2xpZGU6IG51bGwsCiAgICAgICAgZnhTaG93OiBudWxsLAogICAgICAgIGZ4SGlkZTogbnVsbCwKICAgICAgICBmeFNwZWVkOiAnbm9ybWFsJywKICAgICAgICBmeFNob3dTcGVlZDogbnVsbCwKICAgICAgICBmeEhpZGVTcGVlZDogbnVsbCwKICAgICAgICBmeEF1dG9IZWlnaHQ6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IG51bGwsCiAgICAgICAgb25IaWRlOiBudWxsLAogICAgICAgIG9uU2hvdzogbnVsbCwKICAgICAgICBvblJlbW90ZUxvYWQ6IG51bGwsCiAgICAgICAgbmF2Q2xhc3M6ICd0YWJzLW5hdicsCiAgICAgICAgc2VsZWN0ZWRDbGFzczogJ3RhYnMtc2VsZWN0ZWQnLAogICAgICAgIGRpc2FibGVkQ2xhc3M6ICd0YWJzLWRpc2FibGVkJywKICAgICAgICBjb250YWluZXJDbGFzczogJ3RhYnMtY29udGFpbmVyJywKICAgICAgICBoaWRlQ2xhc3M6ICd0YWJzLWhpZGUnLAogICAgICAgIGxvYWRpbmdDbGFzczogJ3RhYnMtbG9hZGluZycsCiAgICAgICAgdGFiU3RydWN0OiAnZGl2JwogICAgfSwgc2V0dGluZ3MgfHwge30pOwoKICAgICQuYnJvd3Nlci5tc2llNiA9ICQuYnJvd3Nlci5tc2llICYmICgkLmJyb3dzZXIudmVyc2lvbiAmJiAkLmJyb3dzZXIudmVyc2lvbiA8IDcgfHwgLzYuMC8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSk7ICAgIAoKICAgIC8vIGhlbHBlciB0byBwcmV2ZW50IHNjcm9sbCB0byBmcmFnbWVudAogICAgZnVuY3Rpb24gdW5Gb2N1cygpIHsKICAgICAgICBzY3JvbGxUbygwLCAwKTsKICAgIH0KCiAgICAvLyBpbml0aWFsaXplIHRhYnMKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgogICAgICAgIC8vIHJlbWVtYmVyIHdyYXBwZXIgZm9yIGxhdGVyCiAgICAgICAgdmFyIGNvbnRhaW5lciA9IHRoaXM7CgogICAgICAgIC8vIHNldHVwIG5hdgogICAgICAgIHZhciBuYXYgPSAkKCd1bC4nICsgc2V0dGluZ3MubmF2Q2xhc3MsIGNvbnRhaW5lcik7CiAgICAgICAgbmF2ID0gbmF2LnNpemUoKSAmJiBuYXYgfHwgJCgnPnVsOmVxKDApJywgY29udGFpbmVyKTsgLy8gZmFsbGJhY2sgdG8gZGVmYXVsdCBzdHJ1Y3R1cmUKICAgICAgICB2YXIgdGFicyA9ICQoJ2EnLCBuYXYpOwoKICAgICAgICAvLyBwcmVwYXJlIHJlbW90ZSB0YWJzCiAgICAgICAgaWYgKHNldHRpbmdzLnJlbW90ZSkgewogICAgICAgICAgICB0YWJzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIAlpZiAoICEvIy8udGVzdCggdGhpcy5ocmVmICkgKSB7CiAgICAgICAgICAgIAl0aGlzLnJlbW90ZSA9ICJyZW1vdGUiOwogICAgICAgICAgICAgICAgdmFyIGlkID0gc2V0dGluZ3MuaGFzaFByZWZpeCArICgrKyQudGFicy5yZW1vdGVDb3VudCksIGhhc2ggPSAnIycgKyBpZCwgdXJsID0gdGhpcy5ocmVmOwogICAgICAgICAgICAgICAgdGhpcy5ocmVmID0gaGFzaDsKICAgICAgICAgICAgICAgICQoJzxkaXYgaWQ9IicgKyBpZCArICciIGNsYXNzPSInICsgc2V0dGluZ3MuY29udGFpbmVyQ2xhc3MgKyAnIj48L2Rpdj4nKS5hcHBlbmRUbyhjb250YWluZXIpOwoKICAgICAgICAgICAgICAgICQodGhpcykuYmluZCgnbG9hZFJlbW90ZVRhYicsIGZ1bmN0aW9uKGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAJaWYgKCAhJChoYXNoKS5odG1sKCkgKSB7CgkJCQkJCXZhciAkJCA9ICQodGhpcykuYWRkQ2xhc3Moc2V0dGluZ3MubG9hZGluZ0NsYXNzKSwgc3BhbiA9ICQoJ3NwYW4nLCB0aGlzKVswXSwgdGFiVGl0bGUgPSBzcGFuLmlubmVySFRNTDsKCQkJCQkJaWYgKHNldHRpbmdzLnNwaW5uZXIpIHsKCQkJCQkJCS8vIFRPRE8gaWYgc3Bpbm5lciBpcyBpbWFnZQoJCQkJCQkJc3Bhbi5pbm5lckhUTUwgPSAnPGVtPicgKyBzZXR0aW5ncy5zcGlubmVyICsgJzwvZW0+JzsgLy8gV0FSTklORzogaHRtbCguLi4pIGNyYXNoZXMgU2FmYXJpIHdpdGggalF1ZXJ5IDEuMS4yCgkJCQkJCX0KCQkJCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsgLy8gVGltZW91dCBpcyBhZ2FpbiByZXF1aXJlZCBpbiBJRSwgIndhaXQiIGZvciBpZCBiZWluZyByZXN0b3JlZAoJCQkJCQkJJChoYXNoKS5sb2FkKHVybCwgZnVuY3Rpb24oKSB7CgkJCQkJCQkJaWYgKHNldHRpbmdzLnNwaW5uZXIpIHsKCQkJCQkJCQkJc3Bhbi5pbm5lckhUTUwgPSB0YWJUaXRsZTsgLy8gV0FSTklORzogaHRtbCguLi4pIGNyYXNoZXMgU2FmYXJpIHdpdGggalF1ZXJ5IDEuMS4yCgkJCQkJCQkJfQoJCQkJCQkJCSQkLnJlbW92ZUNsYXNzKHNldHRpbmdzLmxvYWRpbmdDbGFzcyk7CgkJCQkJCQkJalF1ZXJ5LmlzRnVuY3Rpb24oY2FsbGJhY2spICYmIGNhbGxiYWNrKCk7CgkJCQkJCQkJalF1ZXJ5LmlzRnVuY3Rpb24oc2V0dGluZ3Mub25SZW1vdGVMb2FkKSAmJiBzZXR0aW5ncy5vblJlbW90ZUxvYWQuY2FsbCggdGhpcyApOwoJCQkJCQkJfSk7CgkJCQkJCX0sIDApOwoJCQkJCX0gZWxzZQoJCQkJCQlqUXVlcnkuaXNGdW5jdGlvbihjYWxsYmFjaykgJiYgY2FsbGJhY2soKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIC8vIHNldCB1cCBjb250YWluZXJzCiAgICAgICAgdmFyIGNvbnRhaW5lcnMgPSAkKCc+IGRpdi4nICsgc2V0dGluZ3MuY29udGFpbmVyQ2xhc3MsIGNvbnRhaW5lcik7CiAgICAgICAgY29udGFpbmVycyA9IGNvbnRhaW5lcnMuc2l6ZSgpICYmIGNvbnRhaW5lcnMgfHwgJCgnPicgKyBzZXR0aW5ncy50YWJTdHJ1Y3QsIGNvbnRhaW5lcik7IC8vIGZhbGxiYWNrIHRvIGRlZmF1bHQgc3RydWN0dXJlCgogICAgICAgIC8vIGF0dGFjaCBjbGFzc2VzIGZvciBzdHlsaW5nIGlmIG5vdCBwcmVzZW50CiAgICAgICAgbmF2LmlzKCcuJyArIHNldHRpbmdzLm5hdkNsYXNzKSB8fCBuYXYuYWRkQ2xhc3Moc2V0dGluZ3MubmF2Q2xhc3MpOwogICAgICAgIGNvbnRhaW5lcnMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyICQkID0gJCh0aGlzKTsKICAgICAgICAgICAgJCQuaXMoJy4nICsgc2V0dGluZ3MuY29udGFpbmVyQ2xhc3MpIHx8ICQkLmFkZENsYXNzKHNldHRpbmdzLmNvbnRhaW5lckNsYXNzKTsKICAgICAgICB9KTsKCiAgICAgICAgLy8gdHJ5IHRvIHJldHJpZXZlIGFjdGl2ZSB0YWIgZnJvbSBjbGFzcyBpbiBIVE1MCiAgICAgICAgdmFyIGhhc1NlbGVjdGVkQ2xhc3MgPSAkKCdsaScsIG5hdikuaW5kZXgoICQoJ2xpLicgKyBzZXR0aW5ncy5zZWxlY3RlZENsYXNzLCBuYXYpWzBdICk7CiAgICAgICAgaWYgKGhhc1NlbGVjdGVkQ2xhc3MgPj0gMCkgewogICAgICAgICAgIHNldHRpbmdzLmluaXRpYWwgPSBoYXNTZWxlY3RlZENsYXNzOwogICAgICAgIH0KCiAgICAgICAgLy8gdHJ5IHRvIHJldHJpZXZlIGFjdGl2ZSB0YWIgZnJvbSBoYXNoIGluIHVybCwgd2lsbCBvdmVycmlkZSBjbGFzcyBpbiBIVE1MCiAgICAgICAgaWYgKGxvY2F0aW9uLmhhc2gpIHsKICAgICAgICAgICAgdGFicy5lYWNoKGZ1bmN0aW9uKGkpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc2ggPT0gbG9jYXRpb24uaGFzaCkgewogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzLmluaXRpYWwgPSBpOwogICAgICAgICAgICAgICAgICAgIC8vIHByZXZlbnQgcGFnZSBzY3JvbGwgdG8gZnJhZ21lbnQKICAgICAgICAgICAgICAgICAgICBpZiAoKCQuYnJvd3Nlci5tc2llIHx8ICQuYnJvd3Nlci5vcGVyYSkgJiYgIXRoaXMucmVtb3RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b1Nob3cgPSAkKGxvY2F0aW9uLmhhc2gpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9TaG93SWQgPSB0b1Nob3cuYXR0cignaWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9TaG93LmF0dHIoJ2lkJywgJycpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9TaG93LmF0dHIoJ2lkJywgdG9TaG93SWQpOyAvLyByZXN0b3JlIGlkCiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDUwMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHVuRm9jdXMoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoJC5icm93c2VyLm1zaWUpIHsKICAgICAgICAgICAgdW5Gb2N1cygpOyAvLyBmaXggSUUgZm9jdXNzaW5nIGJvdHRvbSBvZiB0aGUgcGFnZSBmb3Igc29tZSB1bmtub3duIHJlYXNvbgogICAgICAgIH0KCiAgICAgICAgLy8gaGlnaGxpZ2h0IHRhYiBhY2NvcmRpbmdseQogICAgICAgIGNvbnRhaW5lcnMuZmlsdGVyKCc6ZXEoJyArIHNldHRpbmdzLmluaXRpYWwgKyAnKScpLnNob3coKS5lbmQoKS5ub3QoJzplcSgnICsgc2V0dGluZ3MuaW5pdGlhbCArICcpJykuYWRkQ2xhc3Moc2V0dGluZ3MuaGlkZUNsYXNzKTsKICAgICAgICAkKCdsaScsIG5hdikucmVtb3ZlQ2xhc3Moc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcykuc2xpY2Uoc2V0dGluZ3MuaW5pdGlhbCxzZXR0aW5ncy5pbml0aWFsKzEpLmFkZENsYXNzKHNldHRpbmdzLnNlbGVjdGVkQ2xhc3MpOyAvLyB3ZSBuZWVkIHRvIHJlbW92ZSBjbGFzc2VzIGV2ZW50dWFsbHkgaWYgaGFzaCB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgY2xhc3MKICAgICAgICAvLyB0cmlnZ2VyIGxvYWQgb2YgaW5pdGlhbCB0YWIKICAgICAgICB0YWJzLnNsaWNlKHNldHRpbmdzLmluaXRpYWwsc2V0dGluZ3MuaW5pdGlhbCsxKS50cmlnZ2VyKCdsb2FkUmVtb3RlVGFiJykuZW5kKCk7CgogICAgICAgIC8vIHNldHVwIGF1dG8gaGVpZ2h0CiAgICAgICAgaWYgKHNldHRpbmdzLmZ4QXV0b0hlaWdodCkgewogICAgICAgICAgICAvLyBoZWxwZXIKICAgICAgICAgICAgdmFyIF9zZXRBdXRvSGVpZ2h0ID0gZnVuY3Rpb24ocmVzZXQpIHsKICAgICAgICAgICAgICAgIC8vIGdldCB0YWIgaGVpZ2h0cyBpbiB0b3AgdG8gYm90dG9tIG9yZGVyZWQgYXJyYXkKICAgICAgICAgICAgICAgIHZhciBoZWlnaHRzID0gJC5tYXAoY29udGFpbmVycy5nZXQoKSwgZnVuY3Rpb24oZWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaCwganEgPSAkKGVsKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5tc2llNikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGUucmVtb3ZlRXhwcmVzc2lvbignYmVoYXZpb3VyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5zdHlsZS5oZWlnaHQgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLm1pbkhlaWdodCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaCA9IGpxLmNzcyh7J21pbi1oZWlnaHQnOiAnJ30pLmhlaWdodCgpOyAvLyB1c2UgalF1ZXJ5J3MgaGVpZ2h0KCkgdG8gZ2V0IGhpZGRlbiBlbGVtZW50IHZhbHVlcwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGggPSBqcS5oZWlnaHQoKTsgLy8gdXNlIGpRdWVyeSdzIGhlaWdodCgpIHRvIGdldCBoaWRkZW4gZWxlbWVudCB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGg7CiAgICAgICAgICAgICAgICB9KS5zb3J0KGZ1bmN0aW9uKGEsIGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYiAtIGE7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmICgkLmJyb3dzZXIubXNpZTYpIHsKICAgICAgICAgICAgICAgICAgICBjb250YWluZXJzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWluSGVpZ2h0ID0gaGVpZ2h0c1swXSArICdweCc7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R5bGUuc2V0RXhwcmVzc2lvbignYmVoYXZpb3VyJywgJ3RoaXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5taW5IZWlnaHQgPyB0aGlzLm1pbkhlaWdodCA6ICIxcHgiJyk7IC8vIHVzaW5nIGFuIGV4cHJlc3Npb24gdG8gbm90IG1ha2UgcHJpbnQgc3R5bGVzIHVzZWxlc3MKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVycy5jc3MoeydtaW4taGVpZ2h0JzogaGVpZ2h0c1swXSArICdweCd9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gY2FsbCBvbmNlIGZvciBpbml0aWFsaXphdGlvbgogICAgICAgICAgICBfc2V0QXV0b0hlaWdodCgpOwogICAgICAgICAgICAvLyB0cmlnZ2VyIGF1dG8gaGVpZ2h0IGFkanVzdG1lbnQgaWYgbmVlZGVkCiAgICAgICAgICAgIHZhciBjYWNoZWRXaWR0aCA9IGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgdmFyIGNhY2hlZEhlaWdodCA9IGNvbnRhaW5lci5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICAgIHZhciB3YXRjaEZvbnRTaXplID0gJCgnI3RhYnMtd2F0Y2gtZm9udC1zaXplJykuZ2V0KDApIHx8ICQoJzxzcGFuIGlkPSJ0YWJzLXdhdGNoLWZvbnQtc2l6ZSI+TTwvc3Bhbj4nKS5jc3Moe2Rpc3BsYXk6ICdibG9jaycsIHBvc2l0aW9uOiAnYWJzb2x1dGUnLCB2aXNpYmlsaXR5OiAnaGlkZGVuJ30pLmFwcGVuZFRvKGRvY3VtZW50LmJvZHkpLmdldCgwKTsKICAgICAgICAgICAgdmFyIGNhY2hlZEZvbnRTaXplID0gd2F0Y2hGb250U2l6ZS5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICAgIHNldEludGVydmFsKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRXaWR0aCA9IGNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SGVpZ2h0ID0gY29udGFpbmVyLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Rm9udFNpemUgPSB3YXRjaEZvbnRTaXplLm9mZnNldEhlaWdodDsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SGVpZ2h0ID4gY2FjaGVkSGVpZ2h0IHx8IGN1cnJlbnRXaWR0aCAhPSBjYWNoZWRXaWR0aCB8fCBjdXJyZW50Rm9udFNpemUgIT0gY2FjaGVkRm9udFNpemUpIHsKICAgICAgICAgICAgICAgICAgICBfc2V0QXV0b0hlaWdodCgoY3VycmVudFdpZHRoID4gY2FjaGVkV2lkdGggfHwgY3VycmVudEZvbnRTaXplIDwgY2FjaGVkRm9udFNpemUpKTsgLy8gaWYgaGVpZ2h0cyBnZXRzIHNtYWxsZXIgcmVzZXQgbWluLWhlaWdodAogICAgICAgICAgICAgICAgICAgIGNhY2hlZFdpZHRoID0gY3VycmVudFdpZHRoOwogICAgICAgICAgICAgICAgICAgIGNhY2hlZEhlaWdodCA9IGN1cnJlbnRIZWlnaHQ7CiAgICAgICAgICAgICAgICAgICAgY2FjaGVkRm9udFNpemUgPSBjdXJyZW50Rm9udFNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDUwKTsKICAgICAgICB9CgogICAgICAgIC8vIHNldHVwIGFuaW1hdGlvbnMKICAgICAgICB2YXIgc2hvd0FuaW0gPSB7fSwgaGlkZUFuaW0gPSB7fSwgc2hvd1NwZWVkID0gc2V0dGluZ3MuZnhTaG93U3BlZWQgfHwgc2V0dGluZ3MuZnhTcGVlZCwgaGlkZVNwZWVkID0gc2V0dGluZ3MuZnhIaWRlU3BlZWQgfHwgc2V0dGluZ3MuZnhTcGVlZDsKICAgICAgICBpZiAoc2V0dGluZ3MuZnhTbGlkZSB8fCBzZXR0aW5ncy5meEZhZGUpIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmZ4U2xpZGUpIHsKICAgICAgICAgICAgICAgIHNob3dBbmltWydoZWlnaHQnXSA9ICdzaG93JzsKICAgICAgICAgICAgICAgIGhpZGVBbmltWydoZWlnaHQnXSA9ICdoaWRlJzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2V0dGluZ3MuZnhGYWRlKSB7CiAgICAgICAgICAgICAgICBzaG93QW5pbVsnb3BhY2l0eSddID0gJ3Nob3cnOwogICAgICAgICAgICAgICAgaGlkZUFuaW1bJ29wYWNpdHknXSA9ICdoaWRlJzsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5meFNob3cpIHsKICAgICAgICAgICAgICAgIHNob3dBbmltID0gc2V0dGluZ3MuZnhTaG93OwogICAgICAgICAgICB9IGVsc2UgeyAvLyB1c2Ugc29tZSBraW5kIG9mIGFuaW1hdGlvbiB0byBwcmV2ZW50IGJyb3dzZXIgc2Nyb2xsaW5nIHRvIHRoZSB0YWIKICAgICAgICAgICAgICAgIHNob3dBbmltWydtaW4td2lkdGgnXSA9IDA7IC8vIGF2b2lkIG9wYWNpdHksIGNhdXNlcyBmbGlja2VyIGluIEZpcmVmb3gKICAgICAgICAgICAgICAgIHNob3dTcGVlZCA9IDE7IC8vIGFzIGxpdHRsZSBhcyAxIGlzIHN1ZmZpY2llbnQKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2V0dGluZ3MuZnhIaWRlKSB7CiAgICAgICAgICAgICAgICBoaWRlQW5pbSA9IHNldHRpbmdzLmZ4SGlkZTsKICAgICAgICAgICAgfSBlbHNlIHsgLy8gdXNlIHNvbWUga2luZCBvZiBhbmltYXRpb24gdG8gcHJldmVudCBicm93c2VyIHNjcm9sbGluZyB0byB0aGUgdGFiCiAgICAgICAgICAgICAgICBoaWRlQW5pbVsnbWluLXdpZHRoJ10gPSAwOyAvLyBhdm9pZCBvcGFjaXR5LCBjYXVzZXMgZmxpY2tlciBpbiBGaXJlZm94CiAgICAgICAgICAgICAgICBoaWRlU3BlZWQgPSAxOyAvLyBhcyBsaXR0bGUgYXMgMSBpcyBzdWZmaWNpZW50CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIGNhbGxiYWNrcwogICAgICAgIHZhciBvbkNsaWNrID0gc2V0dGluZ3Mub25DbGljaywgb25IaWRlID0gc2V0dGluZ3Mub25IaWRlLCBvblNob3cgPSBzZXR0aW5ncy5vblNob3c7CgogICAgICAgIC8vIGF0dGFjaCBhY3RpdmF0ZVRhYiBldmVudCwgcmVxdWlyZWQgZm9yIGFjdGl2YXRpbmcgYSB0YWIgcHJvZ3JhbW1hdGljYWxseQogICAgICAgIHRhYnMuYmluZCgndHJpZ2dlclRhYicsIGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gaWYgdGhlIHRhYiBpcyBhbHJlYWR5IHNlbGVjdGVkIG9yIGRpc2FibGVkIG9yIGFuaW1hdGlvbiBpcyBzdGlsbCBydW5uaW5nIHN0b3AgaGVyZQogICAgICAgICAgICB2YXIgbGkgPSAkKHRoaXMpLnBhcmVudHMoJ2xpOmVxKDApJyk7CiAgICAgICAgICAgIGlmIChjb250YWluZXIubG9ja2VkIHx8IGxpLmlzKCcuJyArIHNldHRpbmdzLnNlbGVjdGVkQ2xhc3MpIHx8IGxpLmlzKCcuJyArIHNldHRpbmdzLmRpc2FibGVkQ2xhc3MpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBoYXNoID0gdGhpcy5oYXNoOwoKICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5tc2llKSB7CgogICAgICAgICAgICAgICAgJCh0aGlzKS50cmlnZ2VyKCdjbGljaycpOwogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmJvb2ttYXJrYWJsZSkgewogICAgICAgICAgICAgICAgICAgICQuYWpheEhpc3RvcnkudXBkYXRlKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBoYXNoLnJlcGxhY2UoJyMnLCAnJyk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgaWYgKCQuYnJvd3Nlci5zYWZhcmkpIHsKCiAgICAgICAgICAgICAgICAvLyBTaW1wbHkgc2V0dGluZyBsb2NhdGlvbi5oYXNoIHB1dHMgU2FmYXJpIGludG8gdGhlIGV0ZXJuYWwgbG9hZCBzdGF0ZS4uLiB1Z2ghIFN1Ym1pdCBhIGZvcm0gaW5zdGVhZC4KICAgICAgICAgICAgICAgIHZhciB0ZW1wRm9ybSA9ICQoJzxmb3JtIGFjdGlvbj0iJyArIGhhc2ggKyAnIj48ZGl2PjxpbnB1dCB0eXBlPSJzdWJtaXQiIHZhbHVlPSJoIiAvPjwvZGl2PjwvZm9ybT4nKS5nZXQoMCk7IC8vIG5vIG5lZWQgdG8gYXBwZW5kIGl0IHRvIHRoZSBib2R5CiAgICAgICAgICAgICAgICB0ZW1wRm9ybS5zdWJtaXQoKTsgLy8gZG9lcyBub3QgdHJpZ2dlciB0aGUgZm9ybSdzIHN1Ym1pdCBldmVudC4uLgogICAgICAgICAgICAgICAgJCh0aGlzKS50cmlnZ2VyKCdjbGljaycpOyAvLyAuLi50aHVzIGRvIHN0dWZmIGhlcmUKICAgICAgICAgICAgICAgIGlmIChzZXR0aW5ncy5ib29rbWFya2FibGUpIHsKICAgICAgICAgICAgICAgICAgICAkLmFqYXhIaXN0b3J5LnVwZGF0ZShoYXNoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmJvb2ttYXJrYWJsZSkgewogICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLmhhc2ggPSBoYXNoLnJlcGxhY2UoJyMnLCAnJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICQodGhpcykudHJpZ2dlcignY2xpY2snKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KCiAgICAgICAgfSk7CgogICAgICAgIC8vIGF0dGFjaCBkaXNhYmxlIGV2ZW50LCByZXF1aXJlZCBmb3IgZGlzYWJsaW5nIGEgdGFiCiAgICAgICAgdGFicy5iaW5kKCdkaXNhYmxlVGFiJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBsaSA9ICQodGhpcykucGFyZW50cygnbGk6ZXEoMCknKTsKICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5zYWZhcmkpIHsgLyogZml4IG9wYWNpdHkgb2YgdGFiIGFmdGVyIGRpc2FibGluZyBpbiBTYWZhcmkuLi4gKi8KICAgICAgICAgICAgICAgIGxpLmFuaW1hdGUoeyBvcGFjaXR5OiAwIH0sIDEsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgbGkuY3NzKHtvcGFjaXR5OiAnJ30pOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGkuYWRkQ2xhc3Moc2V0dGluZ3MuZGlzYWJsZWRDbGFzcyk7CgogICAgICAgIH0pOwoKICAgICAgICAvLyBkaXNhYmxlZCBmcm9tIHNldHRpbmdzCiAgICAgICAgaWYgKHNldHRpbmdzLmRpc2FibGVkICYmIHNldHRpbmdzLmRpc2FibGVkLmxlbmd0aCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgayA9IHNldHRpbmdzLmRpc2FibGVkLmxlbmd0aDsgaSA8IGs7IGkrKykgewogICAgICAgICAgICAgICAgdGFicy5zbGljZSgtLXNldHRpbmdzLmRpc2FibGVkW2ldLHNldHRpbmdzLmRpc2FibGVkW2ldKzEpLnRyaWdnZXIoJ2Rpc2FibGVUYWInKS5lbmQoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIC8vIGF0dGFjaCBlbmFibGUgZXZlbnQsIHJlcXVpcmVkIGZvciByZWVuYWJsaW5nIGEgdGFiCiAgICAgICAgdGFicy5iaW5kKCdlbmFibGVUYWInLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGxpID0gJCh0aGlzKS5wYXJlbnRzKCdsaTplcSgwKScpOwogICAgICAgICAgICBsaS5yZW1vdmVDbGFzcyhzZXR0aW5ncy5kaXNhYmxlZENsYXNzKTsKICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5zYWZhcmkpIHsgLyogZml4IGRpc2FwcGVhcmluZyB0YWIgYWZ0ZXIgZW5hYmxpbmcgaW4gU2FmYXJpLi4uICovCiAgICAgICAgICAgICAgICBsaS5hbmltYXRlKHsgb3BhY2l0eTogMSB9LCAxLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBsaS5jc3Moe29wYWNpdHk6ICcnfSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAvLyBhdHRhY2ggY2xpY2sgZXZlbnQKICAgICAgICB0YWJzLmJpbmQoJ2NsaWNrJywgZnVuY3Rpb24oZSkgewoKICAgICAgICAgICAgdmFyIHRydWVDbGljayA9IGUuY2xpZW50WDsgLy8gYWRkIHRvIGhpc3Rvcnkgb25seSBpZiB0cnVlIGNsaWNrIG9jY3VyZWQsIG5vdCBhIHRyaWdnZXJlZCBjbGljawogICAgICAgICAgICB2YXIgY2xpY2tlZCA9IHRoaXMsIGxpID0gJCh0aGlzKS5wYXJlbnRzKCdsaTplcSgwKScpLCB0b1Nob3cgPSBjb250YWluZXJzLmZpbHRlcih0aGlzLmhhc2gpLCB0b0hpZGUgPSBjb250YWluZXJzLmZpbHRlcignOnZpc2libGUnKTsKCiAgICAgICAgICAgIC8vIGlmIGFuaW1hdGlvbiBpcyBzdGlsbCBydW5uaW5nLCB0YWIgaXMgc2VsZWN0ZWQgb3IgZGlzYWJsZWQgb3Igb25DbGljayBjYWxsYmFjayByZXR1cm5zIGZhbHNlIHN0b3AgaGVyZQogICAgICAgICAgICAvLyBjaGVjayBpZiBvbkNsaWNrIHJldHVybnMgZmFsc2UgbGFzdCBzbyB0aGF0IGl0IGlzIG5vdCBleGVjdXRlZCBmb3IgYSBkaXNhYmxlZCB0YWIKICAgICAgICAgICAgaWYgKGNvbnRhaW5lclsnbG9ja2VkJ10gfHwgbGkuaXMoJy4nICsgc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcykgfHwgbGkuaXMoJy4nICsgc2V0dGluZ3MuZGlzYWJsZWRDbGFzcykgfHwgdHlwZW9mIG9uQ2xpY2sgPT0gJ2Z1bmN0aW9uJyAmJiBvbkNsaWNrLmNhbGwodGhpcywgdG9TaG93WzBdLCB0b0hpZGVbMF0pID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgdGhpcy5ibHVyKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnRhaW5lclsnbG9ja2VkJ10gPSB0cnVlOwoKICAgICAgICAgICAgLy8gc2hvdyBuZXcgdGFiCiAgICAgICAgICAgIGlmICh0b1Nob3cuc2l6ZSgpKSB7CgogICAgICAgICAgICAgICAgLy8gcHJldmVudCBzY3JvbGxiYXIgc2Nyb2xsaW5nIHRvIDAgYW5kIHRoYW4gYmFjayBpbiBJRTcsIGhhcHBlbnMgb25seSBpZiBib29rbWFya2luZy9oaXN0b3J5IGlzIGVuYWJsZWQKICAgICAgICAgICAgICAgIGlmICgkLmJyb3dzZXIubXNpZSAmJiBzZXR0aW5ncy5ib29rbWFya2FibGUpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG9TaG93SWQgPSB0aGlzLmhhc2gucmVwbGFjZSgnIycsICcnKTsKICAgICAgICAgICAgICAgICAgICB0b1Nob3cuYXR0cignaWQnLCAnJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9TaG93LmF0dHIoJ2lkJywgdG9TaG93SWQpOyAvLyByZXN0b3JlIGlkCiAgICAgICAgICAgICAgICAgICAgfSwgMCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdmFyIHJlc2V0Q1NTID0geyBkaXNwbGF5OiAnJywgb3ZlcmZsb3c6ICcnLCBoZWlnaHQ6ICcnIH07CiAgICAgICAgICAgICAgICBpZiAoISQuYnJvd3Nlci5tc2llKSB7IC8vIG5vdCBpbiBJRSB0byBwcmV2ZW50IENsZWFyVHlwZSBmb250IGlzc3VlCiAgICAgICAgICAgICAgICAgICAgcmVzZXRDU1NbJ29wYWNpdHknXSA9ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAvLyBzd2l0Y2ggdGFiLCBhbmltYXRpb24gcHJldmVudHMgYnJvd3NlciBzY3JvbGxpbmcgdG8gdGhlIGZyYWdtZW50CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzd2l0Y2hUYWIoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNldHRpbmdzLmJvb2ttYXJrYWJsZSAmJiB0cnVlQ2xpY2spIHsgLy8gYWRkIHRvIGhpc3Rvcnkgb25seSBpZiB0cnVlIGNsaWNrIG9jY3VyZWQsIG5vdCBhIHRyaWdnZXJlZCBjbGljawogICAgICAgICAgICAgICAgICAgICAgICAkLmFqYXhIaXN0b3J5LnVwZGF0ZShjbGlja2VkLmhhc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0b0hpZGUuYW5pbWF0ZShoaWRlQW5pbSwgaGlkZVNwZWVkLCBmdW5jdGlvbigpIHsgLy8KICAgICAgICAgICAgICAgICAgICAgICAgJChjbGlja2VkKS5wYXJlbnRzKCdsaTplcSgwKScpLmFkZENsYXNzKHNldHRpbmdzLnNlbGVjdGVkQ2xhc3MpLnNpYmxpbmdzKCkucmVtb3ZlQ2xhc3Moc2V0dGluZ3Muc2VsZWN0ZWRDbGFzcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvSGlkZS5hZGRDbGFzcyhzZXR0aW5ncy5oaWRlQ2xhc3MpLmNzcyhyZXNldENTUyk7IC8vIG1haW50YWluIGZsZXhpYmxlIGhlaWdodCBhbmQgYWNjZXNzaWJpbGl0eSBpbiBwcmludCBldGMuICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25IaWRlID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uSGlkZS5jYWxsKGNsaWNrZWQsIHRvU2hvd1swXSwgdG9IaWRlWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShzZXR0aW5ncy5meFNsaWRlIHx8IHNldHRpbmdzLmZ4RmFkZSB8fCBzZXR0aW5ncy5meFNob3cpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cuY3NzKCdkaXNwbGF5JywgJ2Jsb2NrJyk7IC8vIHByZXZlbnQgb2NjYXNpb25hbGx5IG9jY3VyaW5nIGZsaWNrZXIgaW4gRmlyZWZveCBjYXVzZSBieSBnYXAgYmV0d2VlbiBzaG93aW5nIGFuZCBoaWRpbmcgdGhlIHRhYiBjb250YWluZXJzCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdG9TaG93LmFuaW1hdGUoc2hvd0FuaW0sIHNob3dTcGVlZCwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1Nob3cucmVtb3ZlQ2xhc3Moc2V0dGluZ3MuaGlkZUNsYXNzKS5jc3MocmVzZXRDU1MpOyAvLyBtYWludGFpbiBmbGV4aWJsZSBoZWlnaHQgYW5kIGFjY2Vzc2liaWxpdHkgaW4gcHJpbnQgZXRjLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQuYnJvd3Nlci5tc2llKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9IaWRlWzBdLnN0eWxlLmZpbHRlciA9ICcnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvU2hvd1swXS5zdHlsZS5maWx0ZXIgPSAnJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25TaG93ID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblNob3cuY2FsbChjbGlja2VkLCB0b1Nob3dbMF0sIHRvSGlkZVswXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXJbJ2xvY2tlZCddID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFjbGlja2VkLnJlbW90ZSkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaFRhYigpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAkKGNsaWNrZWQpLnRyaWdnZXIoJ2xvYWRSZW1vdGVUYWInLCBbc3dpdGNoVGFiXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWxlcnQoJ1RoZXJlIGlzIG5vIHN1Y2ggY29udGFpbmVyLicpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTZXQgc2Nyb2xsYmFyIHRvIHNhdmVkIHBvc2l0aW9uIC0gbmVlZCB0byB1c2UgdGltZW91dCB3aXRoIDAgdG8gcHJldmVudCBicm93c2VyIHNjcm9sbCB0byB0YXJnZXQgb2YgaGFzaAogICAgICAgICAgICB2YXIgc2Nyb2xsWCA9IHdpbmRvdy5wYWdlWE9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0IHx8IDA7CiAgICAgICAgICAgIHZhciBzY3JvbGxZID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wIHx8IDA7CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oc2Nyb2xsWCwgc2Nyb2xsWSk7CiAgICAgICAgICAgIH0sIDApOwoKICAgICAgICAgICAgdGhpcy5ibHVyKCk7IC8vIHByZXZlbnQgSUUgZnJvbSBrZWVwaW5nIG90aGVyIGxpbmsgZm9jdXNzZWQgd2hlbiB1c2luZyB0aGUgYmFjayBidXR0b24KCiAgICAgICAgICAgIHJldHVybiBzZXR0aW5ncy5ib29rbWFya2FibGUgJiYgISF0cnVlQ2xpY2s7IC8vIGNvbnZlcnQgdW5kZWZpbmVkIHRvIEJvb2xlYW4gZm9yIElFCgogICAgICAgIH0pOwoKICAgICAgICAvLyBlbmFibGUgaGlzdG9yeSBzdXBwb3J0IGlmIGJvb2ttYXJraW5nIGFuZCBoaXN0b3J5IGlzIHR1cm5lZCBvbgogICAgICAgIGlmIChzZXR0aW5ncy5ib29rbWFya2FibGUpIHsKICAgICAgICAgICAgJC5hamF4SGlzdG9yeS5pbml0aWFsaXplKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGFicy5zbGljZShzZXR0aW5ncy5pbml0aWFsLHNldHRpbmdzLmluaXRpYWwrMSkudHJpZ2dlcignY2xpY2snKS5lbmQoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgIH0pOwoKfTsKCi8qKgogKiBBY3RpdmF0ZSBhIHRhYiBwcm9ncmFtbWF0aWNhbGx5IHdpdGggdGhlIGdpdmVuIHBvc2l0aW9uIChubyB6ZXJvLWJhc2VkIGluZGV4KQogKiBvciBpdHMgaWQsIGUuZy4gdGhlIFVSTCdzIGZyYWdtZW50IGlkZW50aWZpZXIvaGFzaCByZXByZXNlbnRpbmcgYSB0YWIsIGFzIGlmIHRoZSB0YWIKICogaXRzZWxmIHdlcmUgY2xpY2tlZC4KICoKICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRyaWdnZXJUYWIoMik7CiAqIEBkZXNjIEFjdGl2YXRlIHRoZSBzZWNvbmQgdGFiIG9mIHRoZSB0YWIgaW50ZXJmYWNlIGNvbnRhaW5lZCBpbiA8ZGl2IGlkPSJjb250YWluZXIiPi4KICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRyaWdnZXJUYWIoMSk7CiAqIEBkZXNjIEFjdGl2YXRlIHRoZSBmaXJzdCB0YWIgb2YgdGhlIHRhYiBpbnRlcmZhY2UgY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykudHJpZ2dlclRhYigpOwogKiBAZGVzYyBBY3RpdmF0ZSB0aGUgZmlyc3QgdGFiIG9mIHRoZSB0YWIgaW50ZXJmYWNlIGNvbnRhaW5lZCBpbiA8ZGl2IGlkPSJjb250YWluZXIiPi4KICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLnRyaWdnZXJUYWIoJ2ZyYWdtZW50LTInKTsKICogQGRlc2MgQWN0aXZhdGUgYSB0YWIgdmlhIGl0cyBVUkwgZnJhZ21lbnQgaWRlbnRpZmllciByZXByZXNlbnRhdGlvbi4KICoKICogQHBhcmFtIFN0cmluZ3xOdW1iZXIgdGFiIEVpdGhlciBhIHN0cmluZyB0aGF0IG1hdGNoZXMgdGhlIGlkIG9mIHRoZSB0YWIgKHRoZSBVUkwncwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgaWRlbnRpZmllci9oYXNoIHJlcHJlc2VudGluZyBhIHRhYikgb3IgYW4gaW50ZWdlcgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY2lmeWluZyB0aGUgcG9zaXRpb24gb2YgdGhlIHRhYiAobm8gemVyby1iYXNlZCBpbmRleCkgdG8KICogICAgICAgICAgICAgICAgICAgICAgICAgIGJlIGFjdGl2YXRlZC4gSWYgdGhpcyBwYXJhbWV0ZXIgaXMgb21pdHRlZCwgdGhlIGZpcnN0IHRhYgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSBhY3RpdmF0ZWQuCiAqIEB0eXBlIGpRdWVyeQogKgogKiBAbmFtZSB0cmlnZ2VyVGFiCiAqIEBjYXQgUGx1Z2lucy9UYWJzCiAqIEBhdXRob3IgS2xhdXMgSGFydGwva2xhdXMuaGFydGxAc3RpbGJ1ZXJvLmRlCiAqLwoKLyoqCiAqIERpc2FibGUgYSB0YWIsIHNvIHRoYXQgY2xpY2tpbmcgaXQgaGFzIG5vIGVmZmVjdC4KICoKICogQGV4YW1wbGUgJCgnI2NvbnRhaW5lcicpLmRpc2FibGVUYWIoMik7CiAqIEBkZXNjIERpc2FibGUgdGhlIHNlY29uZCB0YWIgb2YgdGhlIHRhYiBpbnRlcmZhY2UgY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKgogKiBAcGFyYW0gU3RyaW5nfE51bWJlciB0YWIgRWl0aGVyIGEgc3RyaW5nIHRoYXQgbWF0Y2hlcyB0aGUgaWQgb2YgdGhlIHRhYiAodGhlIFVSTCdzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudCBpZGVudGlmaWVyL2hhc2ggcmVwcmVzZW50aW5nIGEgdGFiKSBvciBhbiBpbnRlZ2VyCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZ5aW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdGFiIChubyB6ZXJvLWJhc2VkIGluZGV4KSB0bwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgYmUgZGlzYWJsZWQuIElmIHRoaXMgcGFyYW1ldGVyIGlzIG9taXR0ZWQsIHRoZSBmaXJzdCB0YWIKICogICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGwgYmUgZGlzYWJsZWQuCiAqIEB0eXBlIGpRdWVyeQogKgogKiBAbmFtZSBkaXNhYmxlVGFiCiAqIEBjYXQgUGx1Z2lucy9UYWJzCiAqIEBhdXRob3IgS2xhdXMgSGFydGwva2xhdXMuaGFydGxAc3RpbGJ1ZXJvLmRlCiAqLwoKLyoqCiAqIEVuYWJsZSBhIHRhYiB0aGF0IGhhcyBiZWVuIGRpc2FibGVkLgogKgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykuZW5hYmxlVGFiKDIpOwogKiBAZGVzYyBFbmFibGUgdGhlIHNlY29uZCB0YWIgb2YgdGhlIHRhYiBpbnRlcmZhY2UgY29udGFpbmVkIGluIDxkaXYgaWQ9ImNvbnRhaW5lciI+LgogKgogKiBAcGFyYW0gU3RyaW5nfE51bWJlciB0YWIgRWl0aGVyIGEgc3RyaW5nIHRoYXQgbWF0Y2hlcyB0aGUgaWQgb2YgdGhlIHRhYiAodGhlIFVSTCdzCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBmcmFnbWVudCBpZGVudGlmaWVyL2hhc2ggcmVwcmVzZW50aW5nIGEgdGFiKSBvciBhbiBpbnRlZ2VyCiAqICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVjaWZ5aW5nIHRoZSBwb3NpdGlvbiBvZiB0aGUgdGFiIChubyB6ZXJvLWJhc2VkIGluZGV4KSB0bwogKiAgICAgICAgICAgICAgICAgICAgICAgICAgYmUgZW5hYmxlZC4gSWYgdGhpcyBwYXJhbWV0ZXIgaXMgb21pdHRlZCwgdGhlIGZpcnN0IHRhYgogKiAgICAgICAgICAgICAgICAgICAgICAgICAgd2lsbCBiZSBlbmFibGVkLgogKiBAdHlwZSBqUXVlcnkKICoKICogQG5hbWUgZW5hYmxlVGFiCiAqIEBjYXQgUGx1Z2lucy9UYWJzCiAqIEBhdXRob3IgS2xhdXMgSGFydGwva2xhdXMuaGFydGxAc3RpbGJ1ZXJvLmRlCiAqLwoKdmFyIHRhYkV2ZW50cyA9IFsndHJpZ2dlclRhYicsICdkaXNhYmxlVGFiJywgJ2VuYWJsZVRhYiddOwpmb3IgKHZhciBpID0gMDsgaSA8IHRhYkV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgJC5mblt0YWJFdmVudHNbaV1dID0gKGZ1bmN0aW9uKHRhYkV2ZW50KSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHRhYikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIG5hdiA9ICQoJ3VsLnRhYnMtbmF2JyAsIHRoaXMpOwogICAgICAgICAgICAgICAgbmF2ID0gbmF2LnNpemUoKSAmJiBuYXYgfHwgJCgnPnVsOmVxKDApJywgdGhpcyk7IC8vIGZhbGxiYWNrIHRvIGRlZmF1bHQgc3RydWN0dXJlCiAgICAgICAgICAgICAgICB2YXIgYTsKICAgICAgICAgICAgICAgIGlmICghdGFiIHx8IHR5cGVvZiB0YWIgPT0gJ251bWJlcicpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdG51bSA9ICh0YWIgJiYgdGFiID4gMCAmJiB0YWIgLSAxIHx8IDApOwogICAgICAgICAgICAgICAgICAgIGEgPSAkKCdsaSBhJywgbmF2KS5zbGljZSh0bnVtLCB0bnVtKzEpOyAvLyBmYWxsIGJhY2sgdG8gMAogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGFiID09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgYSA9ICQoJ2xpIGFbQGhyZWYkPSIjJyArIHRhYiArICciXScsIG5hdik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhLnRyaWdnZXIodGFiRXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9OwogICAgfSkodGFiRXZlbnRzW2ldKTsKfQoKLyoqCiAqIEdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGN1cnJlbnRseSBzZWxlY3RlZCB0YWIgKG5vIHplcm8tYmFzZWQgaW5kZXgpLgogKgogKiBAZXhhbXBsZSAkKCcjY29udGFpbmVyJykuYWN0aXZlVGFiKCk7CiAqIEBkZXNjIEdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGN1cnJlbnRseSBzZWxlY3RlZCB0YWIgb2YgYW4gaW50ZXJmYWNlCiAqIGNvbnRhaW5lZCBpbiA8ZGl2IGlkPSJjb250YWluZXIiPi4KICoKICogQHR5cGUgTnVtYmVyCiAqCiAqIEBuYW1lIGFjdGl2ZVRhYgogKiBAY2F0IFBsdWdpbnMvVGFicwogKiBAYXV0aG9yIEtsYXVzIEhhcnRsL2tsYXVzLmhhcnRsQHN0aWxidWVyby5kZQogKi8KCiQuZm4uYWN0aXZlVGFiID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZWN0ZWRUYWJzID0gW107CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIG5hdiA9ICQoJ3VsLnRhYnMtbmF2JyAsIHRoaXMpOwogICAgICAgIG5hdiA9IG5hdi5zaXplKCkgJiYgbmF2IHx8ICQoJz51bDplcSgwKScsIHRoaXMpOyAvL2ZhbGxiYWNrIHRvIGRlZmF1bHQgc3RydWN0dXJlCiAgICAgICAgdmFyIGxpcyA9ICQoJ2xpJywgbmF2KTsKICAgICAgICBzZWxlY3RlZFRhYnMucHVzaChsaXMuaW5kZXgoIGxpcy5maWx0ZXIoJy50YWJzLXNlbGVjdGVkJylbMF0gKSArIDEpOwogICAgfSk7CiAgICByZXR1cm4gc2VsZWN0ZWRUYWJzWzBdOwp9OwoKfSkoalF1ZXJ5KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 05:51:40 GMT",
                    "Content-Length": "32001",
                    "Date": "Fri, 07 Nov 2014 05:51:40 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}