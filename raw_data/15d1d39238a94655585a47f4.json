{
    "url": "http://localhost:9999/AlphaHydrae/tableling/lib/bundles/tableling.backbone.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/AlphaHydrae/tableling/lib/bundles/tableling.backbone.js",
                "path": "/AlphaHydrae/tableling/lib/bundles/tableling.backbone.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9BbHBoYUh5ZHJhZS90YWJsZWxpbmcvbGliL2J1bmRsZXMvdGFibGVsaW5nLmJhY2tib25lLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjAwMzA2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDE1OjE3OjM4IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAxNToxNzozOCBHTVQNCg0KLy8gICAgIEJhY2tib25lLmpzIDEuMS4yCgovLyAgICAgKGMpIDIwMTAtMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgogIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZShbJ3VuZGVyc2NvcmUnLCAnanF1ZXJ5JywgJ2V4cG9ydHMnXSwgZnVuY3Rpb24oXywgJCwgZXhwb3J0cykgewogICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAogICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgogICAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCBleHBvcnRzLCBfLCAkKTsKICAgIH0pOwoKICAvLyBOZXh0IGZvciBOb2RlLmpzIG9yIENvbW1vbkpTLiBqUXVlcnkgbWF5IG5vdCBiZSBuZWVkZWQgYXMgYSBtb2R1bGUuCiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwogICAgZmFjdG9yeShyb290LCBleHBvcnRzLCBfKTsKCiAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KICB9IGVsc2UgewogICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgogIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9ICQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCiAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsgcmV0dXJuOwogICAgfQogIH07CgogIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgogIC8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCiAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogIC8vIGxpc3RlbmluZyB0by4KICBfLmVhY2gobGlzdGVuTWV0aG9kcywgZnVuY3Rpb24oaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CiAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgfQogICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgogICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgbWV0aG9kLCB4aHIsIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gSWYgd2UncmUgbm90IHdhaXRpbmcgYW5kIGF0dHJpYnV0ZXMgZXhpc3QsIHNhdmUgYWN0cyBhcwogICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgogICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCiAgICAgIGlmIChhdHRycyAmJiAhb3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0KICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CiAgICAgICAgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwKICAgICAgICB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgaWYgKG1lcmdlKSB7CiAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCiAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpIG9yZGVyLnB1c2gobW9kZWwpOwogICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCgogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAvLyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHJldHVybiBhdHRyczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKSBtb2RlbC5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbicsICdzYW1wbGUnXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAogICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgdmFyIHhociA9IG9wdGlvbnMueGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgdmFyIG5vWGhyUGF0Y2ggPQogICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgogICAgICAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgogICAgLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCiAgICBleGVjdXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYXJncykgewogICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAoKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CiAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgogICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgogIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBBcmUgd2UgYXQgdGhlIGFwcCByb290PwogICAgYXRSb290OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICB9LAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHZhciBmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSI+Jyk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGlmICh0aGlzLl9jaGVja1VybEludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCiAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CgogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICB9CgogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgogICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwogICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAvLyBsYXRlci4KICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgogICAgcmV0dXJuIGNoaWxkOwogIH07CgogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKCiAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgogIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgfTsKCiAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCiAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKICB9OwoKICByZXR1cm4gQmFja2JvbmU7Cgp9KSk7CgovLyBNYXJpb25ldHRlSlMgKEJhY2tib25lLk1hcmlvbmV0dGUpCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gdjIuMi4wCi8vCi8vIENvcHlyaWdodCAoYykyMDE0IERlcmljayBCYWlsZXksIE11dGVkIFNvbHV0aW9ucywgTExDLgovLyBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQovLwovLyBodHRwOi8vbWFyaW9uZXR0ZWpzLmNvbQoKCi8qIQogKiBJbmNsdWRlcyBCYWJ5U2l0dGVyCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUuYmFieXNpdHRlci8KICoKICogSW5jbHVkZXMgV3JlcXIKICogaHR0cHM6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxci8KICovCgoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoWydiYWNrYm9uZScsICd1bmRlcnNjb3JlJ10sIGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7CiAgICAgIHJldHVybiAocm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCBCYWNrYm9uZSwgXykpOwogICAgfSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyb290LCBCYWNrYm9uZSwgXyk7CiAgfSBlbHNlIHsKICAgIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgcm9vdC5CYWNrYm9uZSwgcm9vdC5fKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIC8vIEJhY2tib25lLkJhYnlTaXR0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gdjAuMS40CiAgLy8KICAvLyBDb3B5cmlnaHQgKGMpMjAxNCBEZXJpY2sgQmFpbGV5LCBNdXRlZCBTb2x1dGlvbnMsIExMQy4KICAvLyBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQogIC8vCiAgLy8gaHR0cDovL2dpdGh1Yi5jb20vbWFyaW9uZXR0ZWpzL2JhY2tib25lLmJhYnlzaXR0ZXIKICAoZnVuY3Rpb24oQmFja2JvbmUsIF8pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBwcmV2aW91c0NoaWxkVmlld0NvbnRhaW5lciA9IEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lcjsKICAgIC8vIEJhYnlTaXR0ZXIuQ2hpbGRWaWV3Q29udGFpbmVyCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8KICAgIC8vIFByb3ZpZGUgYSBjb250YWluZXIgdG8gc3RvcmUsIHJldHJpZXZlIGFuZAogICAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogICAgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyID0gZnVuY3Rpb24oQmFja2JvbmUsIF8pIHsKICAgICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICB2YXIgQ29udGFpbmVyID0gZnVuY3Rpb24odmlld3MpIHsKICAgICAgICB0aGlzLl92aWV3cyA9IHt9OwogICAgICAgIHRoaXMuX2luZGV4QnlNb2RlbCA9IHt9OwogICAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICBfLmVhY2godmlld3MsIHRoaXMuYWRkLCB0aGlzKTsKICAgICAgfTsKICAgICAgLy8gQ29udGFpbmVyIE1ldGhvZHMKICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAgIC8vIEFkZCBhIHZpZXcgdG8gdGhpcyBjb250YWluZXIuIFN0b3JlcyB0aGUgdmlldwogICAgICAgIC8vIGJ5IGBjaWRgIGFuZCBtYWtlcyBpdCBzZWFyY2hhYmxlIGJ5IHRoZSBtb2RlbAogICAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAgIC8vIGEgY3VzdG9tIGtleSB0byBzdG9yZSBhbiByZXRyaWV2ZSB0aGUgdmlldy4KICAgICAgICBhZGQ6IGZ1bmN0aW9uKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB2YXIgdmlld0NpZCA9IHZpZXcuY2lkOwogICAgICAgICAgLy8gc3RvcmUgdGhlIHZpZXcKICAgICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAgIC8vIGluZGV4IGl0IGJ5IG1vZGVsCiAgICAgICAgICBpZiAodmlldy5tb2RlbCkgewogICAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGluZGV4IGJ5IGN1c3RvbQogICAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICAgIHRoaXMuX2luZGV4QnlDdXN0b21bY3VzdG9tSW5kZXhdID0gdmlld0NpZDsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgICAvLyBpdC4gVXNlcyB0aGUgbW9kZWwncyBgY2lkYCB0byBmaW5kIGl0LgogICAgICAgIGZpbmRCeU1vZGVsOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5TW9kZWxDaWQobW9kZWwuY2lkKTsKICAgICAgICB9LAogICAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgICAvLyBpdC4gVXNlcyB0aGUgbW9kZWwncyBgY2lkYCB0byBmaW5kIHRoZSB2aWV3IGBjaWRgIGFuZAogICAgICAgIC8vIHJldHJpZXZlIHRoZSB2aWV3IHVzaW5nIGl0LgogICAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbihtb2RlbENpZCkgewogICAgICAgICAgdmFyIHZpZXdDaWQgPSB0aGlzLl9pbmRleEJ5TW9kZWxbbW9kZWxDaWRdOwogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBhIHZpZXcgYnkgYSBjdXN0b20gaW5kZXhlci4KICAgICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlDdXN0b21baW5kZXhdOwogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBieSBpbmRleC4gVGhpcyBpcyBub3QgZ3VhcmFudGVlZCB0byBiZSBhCiAgICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICAgIGZpbmRCeUluZGV4OiBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgICAgfSwKICAgICAgICAvLyByZXRyaWV2ZSBhIHZpZXcgYnkgaXRzIGBjaWRgIGRpcmVjdGx5CiAgICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbihjaWQpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl92aWV3c1tjaWRdOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgdmlldwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odmlldykgewogICAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAgIC8vIGRlbGV0ZSBtb2RlbCBpbmRleAogICAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4QnlNb2RlbFt2aWV3Lm1vZGVsLmNpZF07CiAgICAgICAgICB9CiAgICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgICBfLmFueSh0aGlzLl9pbmRleEJ5Q3VzdG9tLCBmdW5jdGlvbihjaWQsIGtleSkgewogICAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4QnlDdXN0b21ba2V5XTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAvLyByZW1vdmUgdGhlIHZpZXcgZnJvbSB0aGUgY29udGFpbmVyCiAgICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgICAvLyB1cGRhdGUgdGhlIGxlbmd0aAogICAgICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYSBtZXRob2Qgb24gZXZlcnkgdmlldyBpbiB0aGUgY29udGFpbmVyLAogICAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgICAvLyB0aW1lLCBsaWtlIGBmdW5jdGlvbi5jYWxsYC4KICAgICAgICBjYWxsOiBmdW5jdGlvbihtZXRob2QpIHsKICAgICAgICAgIHRoaXMuYXBwbHkobWV0aG9kLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICAgICAgfSwKICAgICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgICAgLy8gcGFzc2luZyBwYXJhbWV0ZXJzIHRvIHRoZSBjYWxsIG1ldGhvZCBvbmUgYXQgYQogICAgICAgIC8vIHRpbWUsIGxpa2UgYGZ1bmN0aW9uLmFwcGx5YC4KICAgICAgICBhcHBseTogZnVuY3Rpb24obWV0aG9kLCBhcmdzKSB7CiAgICAgICAgICBfLmVhY2godGhpcy5fdmlld3MsIGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3W21ldGhvZF0pKSB7CiAgICAgICAgICAgICAgdmlld1ttZXRob2RdLmFwcGx5KHZpZXcsIGFyZ3MgfHwgW10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICAgIF91cGRhdGVMZW5ndGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgICAvLyBodHRwOi8vYmFja2JvbmVqcy5vcmcvZG9jcy9iYWNrYm9uZS5odG1sI3NlY3Rpb24tMTA2CiAgICAgIC8vCiAgICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAgIC8vIGNvbGxlY3Rpb24gcmVsYXRlZCBmZWF0dXJlcy4KICAgICAgdmFyIG1ldGhvZHMgPSBbICJmb3JFYWNoIiwgImVhY2giLCAibWFwIiwgImZpbmQiLCAiZGV0ZWN0IiwgImZpbHRlciIsICJzZWxlY3QiLCAicmVqZWN0IiwgImV2ZXJ5IiwgImFsbCIsICJzb21lIiwgImFueSIsICJpbmNsdWRlIiwgImNvbnRhaW5zIiwgImludm9rZSIsICJ0b0FycmF5IiwgImZpcnN0IiwgImluaXRpYWwiLCAicmVzdCIsICJsYXN0IiwgIndpdGhvdXQiLCAiaXNFbXB0eSIsICJwbHVjayIgXTsKICAgICAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZpZXdzID0gXy52YWx1ZXModGhpcy5fdmlld3MpOwogICAgICAgICAgdmFyIGFyZ3MgPSBbIHZpZXdzIF0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfSk7CiAgICAgIC8vIHJldHVybiB0aGUgcHVibGljIEFQSQogICAgICByZXR1cm4gQ29udGFpbmVyOwogICAgfShCYWNrYm9uZSwgXyk7CiAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIuVkVSU0lPTiA9ICIwLjEuNCI7CiAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIgPSBwcmV2aW91c0NoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgcmV0dXJuIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lcjsKICB9KShCYWNrYm9uZSwgXyk7CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgLy8gQmFja2JvbmUuV3JlcXIgKEJhY2tib25lLk1hcmlvbmV0dGUpCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIHYxLjMuMQogIC8vCiAgLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCiAgLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIGxpY2Vuc2UKICAvLwogIC8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxcgogIChmdW5jdGlvbihCYWNrYm9uZSwgXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIHByZXZpb3VzV3JlcXIgPSBCYWNrYm9uZS5XcmVxcjsKICAgIHZhciBXcmVxciA9IEJhY2tib25lLldyZXFyID0ge307CiAgICBCYWNrYm9uZS5XcmVxci5WRVJTSU9OID0gIjEuMy4xIjsKICAgIEJhY2tib25lLldyZXFyLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuV3JlcXIgPSBwcmV2aW91c1dyZXFyOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvLyBIYW5kbGVycwogICAgLy8gLS0tLS0tLS0KICAgIC8vIEEgcmVnaXN0cnkgb2YgZnVuY3Rpb25zIHRvIGNhbGwsIGdpdmVuIGEgbmFtZQogICAgV3JlcXIuSGFuZGxlcnMgPSBmdW5jdGlvbihCYWNrYm9uZSwgXykgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIC8vIENvbnN0cnVjdG9yCiAgICAgIC8vIC0tLS0tLS0tLS0tCiAgICAgIHZhciBIYW5kbGVycyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEhhbmRsZXJzLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgICAgLy8gSW5zdGFuY2UgTWVtYmVycwogICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgICAgIF8uZXh0ZW5kKEhhbmRsZXJzLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgICAgLy8gQWRkIG11bHRpcGxlIGhhbmRsZXJzIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIGNvbmZpZ3VyYXRpb24KICAgICAgICBzZXRIYW5kbGVyczogZnVuY3Rpb24oaGFuZGxlcnMpIHsKICAgICAgICAgIF8uZWFjaChoYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlciwgbmFtZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGhhbmRsZXIpICYmICFfLmlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gaGFuZGxlci5jb250ZXh0OwogICAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVyLmNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0SGFuZGxlcihuYW1lLCBoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0sCiAgICAgICAgLy8gQWRkIGEgaGFuZGxlciBmb3IgdGhlIGdpdmVuIG5hbWUsIHdpdGggYW4KICAgICAgICAvLyBvcHRpb25hbCBjb250ZXh0IHRvIHJ1biB0aGUgaGFuZGxlciB3aXRoaW4KICAgICAgICBzZXRIYW5kbGVyOiBmdW5jdGlvbihuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgICBjYWxsYmFjazogaGFuZGxlciwKICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV0gPSBjb25maWc7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImhhbmRsZXI6YWRkIiwgbmFtZSwgaGFuZGxlciwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICAvLyBEZXRlcm1pbmUgd2hldGhlciBvciBub3QgYSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQKICAgICAgICBoYXNIYW5kbGVyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gISF0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50bHkgcmVnaXN0ZXJlZCBoYW5kbGVyIGZvcgogICAgICAgIC8vIHRoZSBzcGVjaWZpZWQgbmFtZS4gVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZgogICAgICAgIC8vIG5vIGhhbmRsZXIgaXMgZm91bmQuCiAgICAgICAgZ2V0SGFuZGxlcjogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV07CiAgICAgICAgICBpZiAoIWNvbmZpZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiBjb25maWcuY2FsbGJhY2suYXBwbHkoY29uZmlnLmNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIC8vIFJlbW92ZSBhIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgbmFtZQogICAgICAgIHJlbW92ZUhhbmRsZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoaXMgcmVnaXN0cnkKICAgICAgICByZW1vdmVBbGxIYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLl93cmVxckhhbmRsZXJzID0ge307CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIEhhbmRsZXJzOwogICAgfShCYWNrYm9uZSwgXyk7CiAgICAvLyBXcmVxci5Db21tYW5kU3RvcmFnZQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBTdG9yZSBhbmQgcmV0cmlldmUgY29tbWFuZHMgZm9yIGV4ZWN1dGlvbi4KICAgIFdyZXFyLkNvbW1hbmRTdG9yYWdlID0gZnVuY3Rpb24oKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgLy8gQ29uc3RydWN0b3IgZnVuY3Rpb24KICAgICAgdmFyIENvbW1hbmRTdG9yYWdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgdGhpcy5fY29tbWFuZHMgPSB7fTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgICAgXy5leHRlbmQoQ29tbWFuZFN0b3JhZ2UucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgICAvLyBHZXQgYW4gb2JqZWN0IGxpdGVyYWwgYnkgY29tbWFuZCBuYW1lLCB0aGF0IGNvbnRhaW5zCiAgICAgICAgLy8gdGhlIGBjb21tYW5kTmFtZWAgYW5kIHRoZSBgaW5zdGFuY2VzYCBvZiBhbGwgY29tbWFuZHMKICAgICAgICAvLyByZXByZXNlbnRlZCBhcyBhbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gcHJvY2VzcwogICAgICAgIGdldENvbW1hbmRzOiBmdW5jdGlvbihjb21tYW5kTmFtZSkgewogICAgICAgICAgdmFyIGNvbW1hbmRzID0gdGhpcy5fY29tbWFuZHNbY29tbWFuZE5hbWVdOwogICAgICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBpdCwgc28gYWRkIGl0CiAgICAgICAgICBpZiAoIWNvbW1hbmRzKSB7CiAgICAgICAgICAgIC8vIGJ1aWxkIHRoZSBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGNvbW1hbmRzID0gewogICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLAogICAgICAgICAgICAgIGluc3RhbmNlczogW10KICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gc3RvcmUgaXQKICAgICAgICAgICAgdGhpcy5fY29tbWFuZHNbY29tbWFuZE5hbWVdID0gY29tbWFuZHM7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29tbWFuZHM7CiAgICAgICAgfSwKICAgICAgICAvLyBBZGQgYSBjb21tYW5kIGJ5IG5hbWUsIHRvIHRoZSBzdG9yYWdlIGFuZCBzdG9yZSB0aGUKICAgICAgICAvLyBhcmdzIGZvciB0aGUgY29tbWFuZAogICAgICAgIGFkZENvbW1hbmQ6IGZ1bmN0aW9uKGNvbW1hbmROYW1lLCBhcmdzKSB7CiAgICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZHMoY29tbWFuZE5hbWUpOwogICAgICAgICAgY29tbWFuZC5pbnN0YW5jZXMucHVzaChhcmdzKTsKICAgICAgICB9LAogICAgICAgIC8vIENsZWFyIGFsbCBjb21tYW5kcyBmb3IgdGhlIGdpdmVuIGBjb21tYW5kTmFtZWAKICAgICAgICBjbGVhckNvbW1hbmRzOiBmdW5jdGlvbihjb21tYW5kTmFtZSkgewogICAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICAgIGNvbW1hbmQuaW5zdGFuY2VzID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIENvbW1hbmRTdG9yYWdlOwogICAgfSgpOwogICAgLy8gV3JlcXIuQ29tbWFuZHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgICAvLwogICAgLy8gQSBzaW1wbGUgY29tbWFuZCBwYXR0ZXJuIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhIGNvbW1hbmQKICAgIC8vIGhhbmRsZXIgYW5kIGV4ZWN1dGUgaXQuCiAgICBXcmVxci5Db21tYW5kcyA9IGZ1bmN0aW9uKFdyZXFyKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgcmV0dXJuIFdyZXFyLkhhbmRsZXJzLmV4dGVuZCh7CiAgICAgICAgLy8gZGVmYXVsdCBzdG9yYWdlIHR5cGUKICAgICAgICBzdG9yYWdlVHlwZTogV3JlcXIuQ29tbWFuZFN0b3JhZ2UsCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICB0aGlzLl9pbml0aWFsaXplU3RvcmFnZSh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgdGhpcy5vbigiaGFuZGxlcjphZGQiLCB0aGlzLl9leGVjdXRlQ29tbWFuZHMsIHRoaXMpOwogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgV3JlcXIuSGFuZGxlcnMucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0sCiAgICAgICAgLy8gRXhlY3V0ZSBhIG5hbWVkIGNvbW1hbmQgd2l0aCB0aGUgc3VwcGxpZWQgYXJncwogICAgICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgICAgdGhpcy5nZXRIYW5kbGVyKG5hbWUpLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zdG9yYWdlLmFkZENvbW1hbmQobmFtZSwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaGFuZGxlIGJ1bGsgZXhlY3V0aW9uIG9mIHN0b3JlZCBjb21tYW5kcwogICAgICAgIF9leGVjdXRlQ29tbWFuZHM6IGZ1bmN0aW9uKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5zdG9yYWdlLmdldENvbW1hbmRzKG5hbWUpOwogICAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFuZCBleGVjdXRlIGFsbCB0aGUgc3RvcmVkIGNvbW1hbmQgaW5zdGFuY2VzCiAgICAgICAgICBfLmVhY2goY29tbWFuZC5pbnN0YW5jZXMsIGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5zdG9yYWdlLmNsZWFyQ29tbWFuZHMobmFtZSk7CiAgICAgICAgfSwKICAgICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSBzdG9yYWdlIGVpdGhlciBmcm9tIHRoZSB0eXBlJ3MKICAgICAgICAvLyBgc3RvcmFnZVR5cGVgIG9yIHRoZSBpbnN0YW5jZSBgb3B0aW9ucy5zdG9yYWdlVHlwZWAuCiAgICAgICAgX2luaXRpYWxpemVTdG9yYWdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICB2YXIgc3RvcmFnZTsKICAgICAgICAgIHZhciBTdG9yYWdlVHlwZSA9IG9wdGlvbnMuc3RvcmFnZVR5cGUgfHwgdGhpcy5zdG9yYWdlVHlwZTsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24oU3RvcmFnZVR5cGUpKSB7CiAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgU3RvcmFnZVR5cGUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0b3JhZ2UgPSBTdG9yYWdlVHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0oV3JlcXIpOwogICAgLy8gV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBBIHNpbXBsZSByZXF1ZXN0L3Jlc3BvbnNlIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhCiAgICAvLyByZXF1ZXN0IGhhbmRsZXIsIGFuZCByZXR1cm4gYSByZXNwb25zZSBmcm9tIGl0CiAgICBXcmVxci5SZXF1ZXN0UmVzcG9uc2UgPSBmdW5jdGlvbihXcmVxcikgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICBpZiAodGhpcy5oYXNIYW5kbGVyKG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEhhbmRsZXIobmFtZSkuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0oV3JlcXIpOwogICAgLy8gRXZlbnQgQWdncmVnYXRvcgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gQSBwdWItc3ViIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRlY291cGxlIHZhcmlvdXMgcGFydHMKICAgIC8vIG9mIGFuIGFwcGxpY2F0aW9uIHRocm91Z2ggZXZlbnQtZHJpdmVuIGFyY2hpdGVjdHVyZS4KICAgIFdyZXFyLkV2ZW50QWdncmVnYXRvciA9IGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIEVBID0gZnVuY3Rpb24oKSB7fTsKICAgICAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICAgICAgRUEuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgICAvLyBDb3B5IHRoZSBiYXNpYyBCYWNrYm9uZS5FdmVudHMgb24gdG8gdGhlIGV2ZW50IGFnZ3JlZ2F0b3IKICAgICAgXy5leHRlbmQoRUEucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMpOwogICAgICByZXR1cm4gRUE7CiAgICB9KEJhY2tib25lLCBfKTsKICAgIC8vIFdyZXFyLkNoYW5uZWwKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgICAvLwogICAgLy8gQW4gb2JqZWN0IHRoYXQgd3JhcHMgdGhlIHRocmVlIG1lc3NhZ2luZyBzeXN0ZW1zOgogICAgLy8gRXZlbnRBZ2dyZWdhdG9yLCBSZXF1ZXN0UmVzcG9uc2UsIENvbW1hbmRzCiAgICBXcmVxci5DaGFubmVsID0gZnVuY3Rpb24oV3JlcXIpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgQ2hhbm5lbCA9IGZ1bmN0aW9uKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgdGhpcy52ZW50ID0gbmV3IEJhY2tib25lLldyZXFyLkV2ZW50QWdncmVnYXRvcigpOwogICAgICAgIHRoaXMucmVxcmVzID0gbmV3IEJhY2tib25lLldyZXFyLlJlcXVlc3RSZXNwb25zZSgpOwogICAgICAgIHRoaXMuY29tbWFuZHMgPSBuZXcgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMoKTsKICAgICAgICB0aGlzLmNoYW5uZWxOYW1lID0gY2hhbm5lbE5hbWU7CiAgICAgIH07CiAgICAgIF8uZXh0ZW5kKENoYW5uZWwucHJvdG90eXBlLCB7CiAgICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoZSBtZXNzYWdpbmcgc3lzdGVtcyBvZiB0aGlzIGNoYW5uZWwKICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnZlbnQub2ZmKCk7CiAgICAgICAgICB0aGlzLnZlbnQuc3RvcExpc3RlbmluZygpOwogICAgICAgICAgdGhpcy5yZXFyZXMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ29ubmVjdCBhIGhhc2ggb2YgZXZlbnRzOyBvbmUgZm9yIGVhY2ggbWVzc2FnaW5nIHN5c3RlbQogICAgICAgIGNvbm5lY3RFdmVudHM6IGZ1bmN0aW9uKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIHRoaXMuX2Nvbm5lY3QoInZlbnQiLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgY29ubmVjdENvbW1hbmRzOiBmdW5jdGlvbihoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgICB0aGlzLl9jb25uZWN0KCJjb21tYW5kcyIsIGhhc2gsIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBjb25uZWN0UmVxdWVzdHM6IGZ1bmN0aW9uKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIHRoaXMuX2Nvbm5lY3QoInJlcXJlcyIsIGhhc2gsIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBBdHRhY2ggdGhlIGhhbmRsZXJzIHRvIGEgZ2l2ZW4gbWVzc2FnZSBzeXN0ZW0gYHR5cGVgCiAgICAgICAgX2Nvbm5lY3Q6IGZ1bmN0aW9uKHR5cGUsIGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgICAgdmFyIG1ldGhvZCA9IHR5cGUgPT09ICJ2ZW50IiA/ICJvbiIgOiAic2V0SGFuZGxlciI7CiAgICAgICAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24oZm4sIGV2ZW50TmFtZSkgewogICAgICAgICAgICB0aGlzW3R5cGVdW21ldGhvZF0oZXZlbnROYW1lLCBfLmJpbmQoZm4sIGNvbnRleHQpKTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBDaGFubmVsOwogICAgfShXcmVxcik7CiAgICAvLyBXcmVxci5SYWRpbwogICAgLy8gLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBBbiBvYmplY3QgdGhhdCBsZXRzIHlvdSBjb21tdW5pY2F0ZSB3aXRoIG1hbnkgY2hhbm5lbHMuCiAgICBXcmVxci5yYWRpbyA9IGZ1bmN0aW9uKFdyZXFyKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIFJhZGlvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fY2hhbm5lbHMgPSB7fTsKICAgICAgICB0aGlzLnZlbnQgPSB7fTsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CiAgICAgICAgdGhpcy5yZXFyZXMgPSB7fTsKICAgICAgICB0aGlzLl9wcm94eU1ldGhvZHMoKTsKICAgICAgfTsKICAgICAgXy5leHRlbmQoUmFkaW8ucHJvdG90eXBlLCB7CiAgICAgICAgY2hhbm5lbDogZnVuY3Rpb24oY2hhbm5lbE5hbWUpIHsKICAgICAgICAgIGlmICghY2hhbm5lbE5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGFubmVsIG11c3QgcmVjZWl2ZSBhIG5hbWUiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICB9LAogICAgICAgIF9nZXRDaGFubmVsOiBmdW5jdGlvbihjaGFubmVsTmFtZSkgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSB0aGlzLl9jaGFubmVsc1tjaGFubmVsTmFtZV07CiAgICAgICAgICBpZiAoIWNoYW5uZWwpIHsKICAgICAgICAgICAgY2hhbm5lbCA9IG5ldyBXcmVxci5DaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY2hhbm5lbHNbY2hhbm5lbE5hbWVdID0gY2hhbm5lbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGFubmVsOwogICAgICAgIH0sCiAgICAgICAgX3Byb3h5TWV0aG9kczogZnVuY3Rpb24oKSB7CiAgICAgICAgICBfLmVhY2goWyAidmVudCIsICJjb21tYW5kcyIsICJyZXFyZXMiIF0sIGZ1bmN0aW9uKHN5c3RlbSkgewogICAgICAgICAgICBfLmVhY2gobWVzc2FnZVN5c3RlbXNbc3lzdGVtXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICAgICAgICAgICAgdGhpc1tzeXN0ZW1dW21ldGhvZF0gPSBwcm94eU1ldGhvZCh0aGlzLCBzeXN0ZW0sIG1ldGhvZCk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdmFyIG1lc3NhZ2VTeXN0ZW1zID0gewogICAgICAgIHZlbnQ6IFsgIm9uIiwgIm9mZiIsICJ0cmlnZ2VyIiwgIm9uY2UiLCAic3RvcExpc3RlbmluZyIsICJsaXN0ZW5UbyIsICJsaXN0ZW5Ub09uY2UiIF0sCiAgICAgICAgY29tbWFuZHM6IFsgImV4ZWN1dGUiLCAic2V0SGFuZGxlciIsICJzZXRIYW5kbGVycyIsICJyZW1vdmVIYW5kbGVyIiwgInJlbW92ZUFsbEhhbmRsZXJzIiBdLAogICAgICAgIHJlcXJlczogWyAicmVxdWVzdCIsICJzZXRIYW5kbGVyIiwgInNldEhhbmRsZXJzIiwgInJlbW92ZUhhbmRsZXIiLCAicmVtb3ZlQWxsSGFuZGxlcnMiIF0KICAgICAgfTsKICAgICAgdmFyIHByb3h5TWV0aG9kID0gZnVuY3Rpb24ocmFkaW8sIHN5c3RlbSwgbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZVN5c3RlbSA9IHJhZGlvLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKVtzeXN0ZW1dOwogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VTeXN0ZW1bbWV0aG9kXS5hcHBseShtZXNzYWdlU3lzdGVtLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9OwogICAgICByZXR1cm4gbmV3IFJhZGlvKCk7CiAgICB9KFdyZXFyKTsKICAgIHJldHVybiBCYWNrYm9uZS5XcmVxcjsKICB9KShCYWNrYm9uZSwgXyk7CgogIHZhciBwcmV2aW91c01hcmlvbmV0dGUgPSByb290Lk1hcmlvbmV0dGU7CgogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwoKICBNYXJpb25ldHRlLlZFUlNJT04gPSAnMi4yLjAnOwoKICBNYXJpb25ldHRlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuTWFyaW9uZXR0ZSA9IHByZXZpb3VzTWFyaW9uZXR0ZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIEJhY2tib25lLk1hcmlvbmV0dGUgPSBNYXJpb25ldHRlOwoKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwoKICAvKiBqc2hpbnQgdW51c2VkOiBmYWxzZSAqLwogIAogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCiAgCiAgLy8gRm9yIHNsaWNpbmcgYGFyZ3VtZW50c2AgaW4gZnVuY3Rpb25zCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIAogIC8vIE1hcmlvbmV0dGUuZXh0ZW5kCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBCb3Jyb3cgdGhlIEJhY2tib25lIGBleHRlbmRgIG1ldGhvZCBzbyB3ZSBjYW4gdXNlIGl0IGFzIG5lZWRlZAogIE1hcmlvbmV0dGUuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogIAogIC8vIE1hcmlvbmV0dGUuZ2V0T3B0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBSZXRyaWV2ZSBhbiBvYmplY3QsIGZ1bmN0aW9uIG9yIG90aGVyIHZhbHVlIGZyb20gYSB0YXJnZXQKICAvLyBvYmplY3Qgb3IgaXRzIGBvcHRpb25zYCwgd2l0aCBgb3B0aW9uc2AgdGFraW5nIHByZWNlZGVuY2UuCiAgTWFyaW9uZXR0ZS5nZXRPcHRpb24gPSBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7IHJldHVybjsgfQogICAgdmFyIHZhbHVlOwogIAogICAgaWYgKHRhcmdldC5vcHRpb25zICYmICh0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSkgewogICAgICB2YWx1ZSA9IHRhcmdldC5vcHRpb25zW29wdGlvbk5hbWVdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSB0YXJnZXRbb3B0aW9uTmFtZV07CiAgICB9CiAgCiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICAKICAvLyBQcm94eSBgTWFyaW9uZXR0ZS5nZXRPcHRpb25gCiAgTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbiA9IGZ1bmN0aW9uKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIAogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uKGhhc2gpIHsKICAgIHZhciBub3JtYWxpemVkSGFzaCA9IHt9OwogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uKG1ldGhvZCwgbmFtZSkgewogICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgICAgbWV0aG9kID0gdGhpc1ttZXRob2RdOwogICAgICB9CiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG5vcm1hbGl6ZWRIYXNoW25hbWVdID0gbWV0aG9kOwogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gbm9ybWFsaXplZEhhc2g7CiAgfTsKICAKICAvLyB1dGlsaXR5IG1ldGhvZCBmb3IgcGFyc2luZyBAdWkuIHN5bnRheCBzdHJpbmdzCiAgLy8gaW50byBhc3NvY2lhdGVkIHNlbGVjdG9yCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyA9IGZ1bmN0aW9uKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24ocikgewogICAgICByZXR1cm4gdWlbci5zbGljZSg0KV07CiAgICB9KTsKICB9OwogIAogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiBrZXkgZm9yIHRyaWdnZXJzIGFuZCBldmVudHMKICAvLyBzd2FwcyB0aGUgQHVpIHdpdGggdGhlIGFzc29jaWF0ZWQgc2VsZWN0b3IuCiAgLy8gUmV0dXJucyBhIG5ldywgbm9uLW11dGF0ZWQsIHBhcnNlZCBldmVudHMgaGFzaC4KICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyA9IGZ1bmN0aW9uKGhhc2gsIHVpKSB7CiAgICBpZiAodHlwZW9mKGhhc2gpID09PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm47CiAgICB9CiAgCiAgICBoYXNoID0gXy5jbG9uZShoYXNoKTsKICAKICAgIF8uZWFjaChfLmtleXMoaGFzaCksIGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgbm9ybWFsaXplZEtleSA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlTdHJpbmcoa2V5LCB1aSk7CiAgICAgIGlmIChub3JtYWxpemVkS2V5ICE9PSBrZXkpIHsKICAgICAgICBoYXNoW25vcm1hbGl6ZWRLZXldID0gaGFzaFtrZXldOwogICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGhhc2g7CiAgfTsKICAKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4gdmFsdWUgZm9yIHJlZ2lvbnMKICAvLyBzd2FwcyB0aGUgQHVpIHdpdGggdGhlIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJVmFsdWVzID0gZnVuY3Rpb24oaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YoaGFzaCkgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gaGFzaDsKICB9OwogIAogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG9iamVjdCwgbGlzdFByb3BlcnR5KSB7CiAgICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLAogICAgICAnc2VsZWN0JywgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsCiAgICAgICdjb250YWlucycsICdpbnZva2UnLCAndG9BcnJheScsICdmaXJzdCcsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgICAnbGFzdCcsICd3aXRob3V0JywgJ2lzRW1wdHknLCAncGx1Y2snXTsKICAKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgICAgb2JqZWN0W21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgCiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbihldmVudCkgewogIAogICAgLy8gc3BsaXQgdGhlIGV2ZW50IG5hbWUgb24gdGhlICI6IgogICAgdmFyIHNwbGl0dGVyID0gLyhefDopKFx3KS9naTsKICAKICAgIC8vIHRha2UgdGhlIGV2ZW50IHNlY3Rpb24gKCJzZWN0aW9uMTpzZWN0aW9uMjpzZWN0aW9uMyIpCiAgICAvLyBhbmQgdHVybiBpdCBpbiB0byB1cHBlcmNhc2UgbmFtZQogICAgZnVuY3Rpb24gZ2V0RXZlbnROYW1lKG1hdGNoLCBwcmVmaXgsIGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gZXZlbnROYW1lLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgCiAgICAvLyBnZXQgdGhlIG1ldGhvZCBuYW1lIGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIHZhciBtZXRob2ROYW1lID0gJ29uJyArIGV2ZW50LnJlcGxhY2Uoc3BsaXR0ZXIsIGdldEV2ZW50TmFtZSk7CiAgICB2YXIgbWV0aG9kID0gdGhpc1ttZXRob2ROYW1lXTsKICAgIHZhciByZXN1bHQ7CiAgCiAgICAvLyBjYWxsIHRoZSBvbk1ldGhvZE5hbWUgaWYgaXQgZXhpc3RzCiAgICBpZiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgLy8gcGFzcyBhbGwgYXJndW1lbnRzLCBleGNlcHQgdGhlIGV2ZW50IG5hbWUKICAgICAgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIF8udGFpbChhcmd1bWVudHMpKTsKICAgIH0KICAKICAgIC8vIHRyaWdnZXIgdGhlIGV2ZW50LCBpZiBhIHRyaWdnZXIgbWV0aG9kIGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnRyaWdnZXIpKSB7CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIAogIC8vIHRyaWdnZXJNZXRob2RPbiBpbnZva2VzIHRyaWdnZXJNZXRob2Qgb24gYSBzcGVjaWZpYyBjb250ZXh0CiAgLy8KICAvLyBlLmcuIGBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpYAogIC8vIHdpbGwgdHJpZ2dlciBhICJzaG93IiBldmVudCBvciBpbnZva2Ugb25TaG93IHRoZSB2aWV3LgogIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIHZhciBhcmdzID0gXy50YWlsKGFyZ3VtZW50cywgMik7CiAgICB2YXIgZm5jOwogIAogICAgaWYgKF8uaXNGdW5jdGlvbihjb250ZXh0LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgIGZuYyA9IGNvbnRleHQudHJpZ2dlck1ldGhvZDsKICAgIH0gZWxzZSB7CiAgICAgIGZuYyA9IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZDsKICAgIH0KICAKICAgIHJldHVybiBmbmMuYXBwbHkoY29udGV4dCwgW2V2ZW50XS5jb25jYXQoYXJncykpOwogIH07CiAgCiAgLy8gRE9NUmVmcmVzaAogIC8vIC0tLS0tLS0tLS0KICAvLwogIC8vIE1vbml0b3IgYSB2aWV3J3Mgc3RhdGUsIGFuZCBhZnRlciBpdCBoYXMgYmVlbiByZW5kZXJlZCBhbmQgc2hvd24KICAvLyBpbiB0aGUgRE9NLCB0cmlnZ2VyIGEgImRvbTpyZWZyZXNoIiBldmVudCBldmVyeSB0aW1lIGl0IGlzCiAgLy8gcmUtcmVuZGVyZWQuCiAgCiAgTWFyaW9uZXR0ZS5Nb25pdG9yRE9NUmVmcmVzaCA9IChmdW5jdGlvbihkb2N1bWVudEVsZW1lbnQpIHsKICAgIC8vIHRyYWNrIHdoZW4gdGhlIHZpZXcgaGFzIGJlZW4gc2hvd24gaW4gdGhlIERPTSwKICAgIC8vIHVzaW5nIGEgTWFyaW9uZXR0ZS5SZWdpb24gKG9yIGJ5IG90aGVyIG1lYW5zIG9mIHRyaWdnZXJpbmcgInNob3ciKQogICAgZnVuY3Rpb24gaGFuZGxlU2hvdyh2aWV3KSB7CiAgICAgIHZpZXcuX2lzU2hvd24gPSB0cnVlOwogICAgICB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KTsKICAgIH0KICAKICAgIC8vIHRyYWNrIHdoZW4gdGhlIHZpZXcgaGFzIGJlZW4gcmVuZGVyZWQKICAgIGZ1bmN0aW9uIGhhbmRsZVJlbmRlcih2aWV3KSB7CiAgICAgIHZpZXcuX2lzUmVuZGVyZWQgPSB0cnVlOwogICAgICB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KTsKICAgIH0KICAKICAgIC8vIFRyaWdnZXIgdGhlICJkb206cmVmcmVzaCIgZXZlbnQgYW5kIGNvcnJlc3BvbmRpbmcgIm9uRG9tUmVmcmVzaCIgbWV0aG9kCiAgICBmdW5jdGlvbiB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KSB7CiAgICAgIGlmICh2aWV3Ll9pc1Nob3duICYmIHZpZXcuX2lzUmVuZGVyZWQgJiYgaXNJbkRPTSh2aWV3KSkgewogICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlldy50cmlnZ2VyTWV0aG9kKSkgewogICAgICAgICAgdmlldy50cmlnZ2VyTWV0aG9kKCdkb206cmVmcmVzaCcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gaXNJbkRPTSh2aWV3KSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS4kLmNvbnRhaW5zKGRvY3VtZW50RWxlbWVudCwgdmlldy5lbCk7CiAgICB9CiAgCiAgICAvLyBFeHBvcnQgcHVibGljIEFQSQogICAgcmV0dXJuIGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZVNob3codmlldyk7CiAgICAgIH0pOwogIAogICAgICB2aWV3Lmxpc3RlblRvKHZpZXcsICdyZW5kZXInLCBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVSZW5kZXIodmlldyk7CiAgICAgIH0pOwogICAgfTsKICB9KShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogIAoKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgCiAgKGZ1bmN0aW9uKE1hcmlvbmV0dGUpIHsKICAgICd1c2Ugc3RyaWN0JzsKICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgCiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogIAogICAgICAgIHZhciBtZXRob2QgPSB0YXJnZXRbbWV0aG9kTmFtZV07CiAgICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsKICAgICAgICAgICAgJyIgd2FzIGNvbmZpZ3VyZWQgYXMgYW4gZXZlbnQgaGFuZGxlciwgYnV0IGRvZXMgbm90IGV4aXN0LicpOwogICAgICAgIH0KICAKICAgICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICAgIH0pOwogICAgfQogIAogICAgLy8gQmluZCB0aGUgZXZlbnQgdG8gYSBzdXBwbGllZCBjYWxsYmFjayBmdW5jdGlvbgogICAgZnVuY3Rpb24gYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5saXN0ZW5UbyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgIH0KICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gdW5iaW5kRnJvbVN0cmluZ3ModGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcykgewogICAgICB2YXIgbWV0aG9kTmFtZXMgPSBtZXRob2RzLnNwbGl0KC9ccysvKTsKICAKICAgICAgXy5lYWNoKG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IHRhcmdldFttZXRob2ROYW1lXTsKICAgICAgICB0YXJnZXQuc3RvcExpc3RlbmluZyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBhIHN1cHBsaWVkIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiB1bmJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQuc3RvcExpc3RlbmluZyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgIH0KICAKICAKICAgIC8vIGdlbmVyaWMgbG9vcGluZyBmdW5jdGlvbgogICAgZnVuY3Rpb24gaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIGZ1bmN0aW9uQ2FsbGJhY2ssIHN0cmluZ0NhbGxiYWNrKSB7CiAgICAgIGlmICghZW50aXR5IHx8ICFiaW5kaW5ncykgeyByZXR1cm47IH0KICAKICAgICAgLy8gdHlwZS1jaGVjayBiaW5kaW5ncwogICAgICBpZiAoIV8uaXNGdW5jdGlvbihiaW5kaW5ncykgJiYgIV8uaXNPYmplY3QoYmluZGluZ3MpKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbWVzc2FnZTogJ0JpbmRpbmdzIG11c3QgYmUgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uLicsCiAgICAgICAgICB1cmw6ICdtYXJpb25ldHRlLmZ1bmN0aW9ucy5odG1sI21hcmlvbmV0dGViaW5kZW50aXR5ZXZlbnRzJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIC8vIGFsbG93IHRoZSBiaW5kaW5ncyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYmluZGluZ3MpKSB7CiAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5ncy5jYWxsKHRhcmdldCk7CiAgICAgIH0KICAKICAgICAgLy8gaXRlcmF0ZSB0aGUgYmluZGluZ3MgYW5kIGJpbmQgdGhlbQogICAgICBfLmVhY2goYmluZGluZ3MsIGZ1bmN0aW9uKG1ldGhvZHMsIGV2dCkgewogIAogICAgICAgIC8vIGFsbG93IGZvciBhIGZ1bmN0aW9uIGFzIHRoZSBoYW5kbGVyLAogICAgICAgIC8vIG9yIGEgbGlzdCBvZiBldmVudCBuYW1lcyBhcyBhIHN0cmluZwogICAgICAgIGlmIChfLmlzRnVuY3Rpb24obWV0aG9kcykpIHsKICAgICAgICAgIGZ1bmN0aW9uQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmluZ0NhbGxiYWNrKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpOwogICAgICAgIH0KICAKICAgICAgfSk7CiAgICB9CiAgCiAgICAvLyBFeHBvcnQgUHVibGljIEFQSQogICAgTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgCiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncykgewogICAgICBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgdW5iaW5kVG9GdW5jdGlvbiwgdW5iaW5kRnJvbVN0cmluZ3MpOwogICAgfTsKICAKICAgIC8vIFByb3h5IGBiaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbihlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHModGhpcywgZW50aXR5LCBiaW5kaW5ncyk7CiAgICB9OwogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlVbmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbihlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfSkoTWFyaW9uZXR0ZSk7CiAgCgogIHZhciBlcnJvclByb3BzID0gWydkZXNjcmlwdGlvbicsICdmaWxlTmFtZScsICdsaW5lTnVtYmVyJywgJ25hbWUnLCAnbWVzc2FnZScsICdudW1iZXInXTsKICAKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgIGlmIChfLmlzT2JqZWN0KG1lc3NhZ2UpKSB7CiAgICAgICAgb3B0aW9ucyA9IG1lc3NhZ2U7CiAgICAgICAgbWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgfSBlbHNlIGlmICghb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQogIAogICAgICB2YXIgZXJyb3IgPSBFcnJvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2soZXJyb3IsIGVycm9yUHJvcHMpLCBfLnBpY2sob3B0aW9ucywgZXJyb3JQcm9wcykpOwogIAogICAgICB0aGlzLmNhcHR1cmVTdGFja1RyYWNlKCk7CiAgCiAgICAgIGlmIChvcHRpb25zLnVybCkgewogICAgICAgIHRoaXMudXJsID0gdGhpcy51cmxSb290ICsgb3B0aW9ucy51cmw7CiAgICAgIH0KICAgIH0sCiAgCiAgICBjYXB0dXJlU3RhY2tUcmFjZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIE1hcmlvbmV0dGUuRXJyb3IpOwogICAgICB9CiAgICB9LAogIAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgCiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAKICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2RlZmVycmVkID0gTWFyaW9uZXR0ZS5EZWZlcnJlZCgpOwogICAgdGhpcy5fY2FsbGJhY2tzID0gW107CiAgfTsKICAKICBfLmV4dGVuZChNYXJpb25ldHRlLkNhbGxiYWNrcy5wcm90b3R5cGUsIHsKICAKICAgIC8vIEFkZCBhIGNhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkLiBDYWxsYmFja3MgYWRkZWQgaGVyZSBhcmUKICAgIC8vIGd1YXJhbnRlZWQgdG8gZXhlY3V0ZSwgZXZlbiBpZiB0aGV5IGFyZSBhZGRlZCBhZnRlciB0aGUKICAgIC8vIGBydW5gIG1ldGhvZCBpcyBjYWxsZWQuCiAgICBhZGQ6IGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0T3ZlcnJpZGUpIHsKICAgICAgdmFyIHByb21pc2UgPSBfLnJlc3VsdCh0aGlzLl9kZWZlcnJlZCwgJ3Byb21pc2UnKTsKICAKICAgICAgdGhpcy5fY2FsbGJhY2tzLnB1c2goe2NiOiBjYWxsYmFjaywgY3R4OiBjb250ZXh0T3ZlcnJpZGV9KTsKICAKICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKXsgYXJncy5jb250ZXh0ID0gY29udGV4dE92ZXJyaWRlOyB9CiAgICAgICAgY2FsbGJhY2suY2FsbChhcmdzLmNvbnRleHQsIGFyZ3Mub3B0aW9ucyk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIFJ1biBhbGwgcmVnaXN0ZXJlZCBjYWxsYmFja3Mgd2l0aCB0aGUgY29udGV4dCBzcGVjaWZpZWQuCiAgICAvLyBBZGRpdGlvbmFsIGNhbGxiYWNrcyBjYW4gYmUgYWRkZWQgYWZ0ZXIgdGhpcyBoYXMgYmVlbiBydW4KICAgIC8vIGFuZCB0aGV5IHdpbGwgc3RpbGwgYmUgZXhlY3V0ZWQuCiAgICBydW46IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5fZGVmZXJyZWQucmVzb2x2ZSh7CiAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIFJlc2V0cyB0aGUgbGlzdCBvZiBjYWxsYmFja3MgdG8gYmUgcnVuLCBhbGxvd2luZyB0aGUgc2FtZSBsaXN0CiAgICAvLyB0byBiZSBydW4gbXVsdGlwbGUgdGltZXMgLSB3aGVuZXZlciB0aGUgYHJ1bmAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIAogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbihjYikgewogICAgICAgIHRoaXMuYWRkKGNiLmNiLCBjYi5jdHgpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAKICAvLyBNYXJpb25ldHRlIENvbnRyb2xsZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgbXVsdGktcHVycG9zZSBvYmplY3QgdG8gdXNlIGFzIGEgY29udHJvbGxlciBmb3IKICAvLyBtb2R1bGVzIGFuZCByb3V0ZXJzLCBhbmQgYXMgYSBtZWRpYXRvciBmb3Igd29ya2Zsb3cKICAvLyBhbmQgY29vcmRpbmF0aW9uIG9mIG90aGVyIG9iamVjdHMsIHZpZXdzLCBhbmQgbW9yZS4KICBNYXJpb25ldHRlLkNvbnRyb2xsZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZSh0aGlzLm9wdGlvbnMpOwogICAgfQogIH07CiAgCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIAogIC8vIENvbnRyb2xsZXIgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgCiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuQ29udHJvbGxlci5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogIAogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIAogIH0pOwogIAogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgCiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIAogIE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIAogIC8vIE9iamVjdCBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAKICBfLmV4dGVuZChNYXJpb25ldHRlLk9iamVjdC5wcm90b3R5cGUsIHsKICAKICAgIC8vdGhpcyBpcyBhIG5vb3AgbWV0aG9kIGludGVuZGVkIHRvIGJlIG92ZXJyaWRkZW4gYnkgY2xhc3NlcyB0aGF0IGV4dGVuZCBmcm9tIHRoaXMgYmFzZQogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpkZXN0cm95Jyk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnZGVzdHJveScpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgIH0sCiAgCiAgICAvLyBJbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZCwKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIAogIC8vIEVuc3VyZSBpdCBjYW4gdHJpZ2dlciBldmVudHMgd2l0aCBCYWNrYm9uZS5FdmVudHMKICBfLmV4dGVuZChNYXJpb25ldHRlLk9iamVjdC5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cyk7CiAgCiAgLyoganNoaW50IG1heGNvbXBsZXhpdHk6IDEwLCBtYXhzdGF0ZW1lbnRzOiAyOSAqLwogIAogIC8vIFJlZ2lvbgogIC8vIC0tLS0tLQogIC8vCiAgLy8gTWFuYWdlIHRoZSB2aXN1YWwgcmVnaW9ucyBvZiB5b3VyIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbi4gU2VlCiAgLy8gaHR0cDovL2xvc3RlY2hpZXMuY29tL2Rlcmlja2JhaWxleS8yMDExLzEyLzEyL2NvbXBvc2l0ZS1qcy1hcHBzLXJlZ2lvbnMtYW5kLXJlZ2lvbi1tYW5hZ2Vycy8KICAKICBNYXJpb25ldHRlLlJlZ2lvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgCiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgCiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogIAogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogIAogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIAogIAogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgCiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIGlmIChfLmlzU3RyaW5nKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3IocmVnaW9uQ29uZmlnLCBEZWZhdWx0UmVnaW9uQ2xhc3MpOwogICAgICB9CiAgCiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgfHwgcmVnaW9uQ29uZmlnLmVsIHx8IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcykgewogICAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbkZyb21PYmplY3QocmVnaW9uQ29uZmlnLCBEZWZhdWx0UmVnaW9uQ2xhc3MpOwogICAgICB9CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ocmVnaW9uQ29uZmlnKSkgewogICAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbkZyb21SZWdpb25DbGFzcyhyZWdpb25Db25maWcpOwogICAgICB9CiAgCiAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAnSW1wcm9wZXIgcmVnaW9uIGNvbmZpZ3VyYXRpb24gdHlwZS4nLAogICAgICAgIHVybDogJ21hcmlvbmV0dGUucmVnaW9uLmh0bWwjcmVnaW9uLWNvbmZpZ3VyYXRpb24tdHlwZXMnCiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIHN0cmluZyBzZWxlY3RvciBsaWtlICcjZm9vLXJlZ2lvbicKICAgIF9idWlsZFJlZ2lvbkZyb21TZWxlY3RvcjogZnVuY3Rpb24oc2VsZWN0b3IsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICByZXR1cm4gbmV3IERlZmF1bHRSZWdpb25DbGFzcyh7IGVsOiBzZWxlY3RvciB9KTsKICAgIH0sCiAgCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgLy8gYGBganMKICAgIC8vIHsgc2VsZWN0b3I6ICcjZm9vJywgcmVnaW9uQ2xhc3M6IEZvb1JlZ2lvbiB9CiAgICAvLyBgYGAKICAgIF9idWlsZFJlZ2lvbkZyb21PYmplY3Q6IGZ1bmN0aW9uKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgCiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgCiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgCiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICBpZiAoXy5pc09iamVjdChlbCkpIHsKICAgICAgICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudEVsID0gcmVnaW9uQ29uZmlnLnBhcmVudEVsOwogICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihwYXJlbnRFbCkpIHsKICAgICAgICAgICAgcGFyZW50RWwgPSBwYXJlbnRFbCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudEVsLmZpbmQoZWwpOwogICAgICAgIH07CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgIH0sCiAgCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGRpcmVjdGx5IGZyb20gYSBnaXZlbiBgUmVnaW9uQ2xhc3NgCiAgICBfYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3M6IGZ1bmN0aW9uKFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgUmVnaW9uQ2xhc3MoKTsKICAgIH0KICAKICB9KTsKICAKICAvLyBSZWdpb24gSW5zdGFuY2UgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5SZWdpb24ucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAKICAgIC8vIERpc3BsYXlzIGEgYmFja2JvbmUgdmlldyBpbnN0YW5jZSBpbnNpZGUgb2YgdGhlIHJlZ2lvbi4KICAgIC8vIEhhbmRsZXMgY2FsbGluZyB0aGUgYHJlbmRlcmAgbWV0aG9kIGZvciB5b3UuIFJlYWRzIGNvbnRlbnQKICAgIC8vIGRpcmVjdGx5IGZyb20gdGhlIGBlbGAgYXR0cmlidXRlLiBBbHNvIGNhbGxzIGFuIG9wdGlvbmFsCiAgICAvLyBgb25TaG93YCBhbmQgYG9uRGVzdHJveWAgbWV0aG9kIG9uIHlvdXIgdmlldywganVzdCBhZnRlciBzaG93aW5nCiAgICAvLyBvciBqdXN0IGJlZm9yZSBkZXN0cm95aW5nIHRoZSB2aWV3LCByZXNwZWN0aXZlbHkuCiAgICAvLyBUaGUgYHByZXZlbnREZXN0cm95YCBvcHRpb24gY2FuIGJlIHVzZWQgdG8gcHJldmVudCBhIHZpZXcgZnJvbQogICAgLy8gdGhlIG9sZCB2aWV3IGJlaW5nIGRlc3Ryb3llZCBvbiBzaG93LgogICAgLy8gVGhlIGBmb3JjZVNob3dgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBmb3JjZSBhIHZpZXcgdG8gYmUKICAgIC8vIHJlLXJlbmRlcmVkIGlmIGl0J3MgYWxyZWFkeSBzaG93biBpbiB0aGUgcmVnaW9uLgogIAogICAgc2hvdzogZnVuY3Rpb24odmlldywgb3B0aW9ucyl7CiAgICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAKICAgICAgdmFyIHNob3dPcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGlzRGlmZmVyZW50VmlldyA9IHZpZXcgIT09IHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHZhciBwcmV2ZW50RGVzdHJveSA9ICAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgCiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgCiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgCiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgCiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogIAogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgCiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogIAogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgCiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgCiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogIAogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICghXy5pc09iamVjdCh0aGlzLmVsKSkgewogICAgICAgIHRoaXMuJGVsID0gdGhpcy5nZXRFbCh0aGlzLmVsKTsKICAgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIH0KICAKICAgICAgaWYgKCF0aGlzLiRlbCB8fCB0aGlzLiRlbC5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignQW4gImVsIiAnICsgdGhpcy4kZWwuc2VsZWN0b3IgKyAnIG11c3QgZXhpc3QgaW4gRE9NJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBjaGFuZ2UgaG93IHRoZSByZWdpb24gZmluZHMgdGhlCiAgICAvLyBET00gZWxlbWVudCB0aGF0IGl0IG1hbmFnZXMuIFJldHVybiBhIGpRdWVyeSBzZWxlY3RvciBvYmplY3QuCiAgICBnZXRFbDogZnVuY3Rpb24oZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbih2aWV3KSB7CiAgICAgIC8vIGVtcHR5IHRoZSBub2RlIGFuZCBhcHBlbmQgbmV3IHZpZXcKICAgICAgdGhpcy5lbC5pbm5lckhUTUw9Jyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogIAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogIAogICAgICAvLyBJZiB0aGVyZSBpcyBubyB2aWV3IGluIHRoZSByZWdpb24KICAgICAgLy8gd2Ugc2hvdWxkIG5vdCByZW1vdmUgYW55dGhpbmcKICAgICAgaWYgKCF2aWV3KSB7IHJldHVybjsgfQogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgCiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY3VycmVudFZpZXc7CiAgCiAgICAgIGlmICh2aWV3LmRlc3Ryb3kgJiYgIXZpZXcuaXNEZXN0cm95ZWQpIHsKICAgICAgICB2aWV3LmRlc3Ryb3koKTsKICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgIHZpZXcucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBBdHRhY2ggYW4gZXhpc3RpbmcgdmlldyB0byB0aGUgcmVnaW9uLiBUaGlzCiAgICAvLyB3aWxsIG5vdCBjYWxsIGByZW5kZXJgIG9yIGBvblNob3dgIGZvciB0aGUgbmV3IHZpZXcsCiAgICAvLyBhbmQgd2lsbCBub3QgcmVwbGFjZSB0aGUgY3VycmVudCBIVE1MIGZvciB0aGUgYGVsYAogICAgLy8gb2YgdGhlIHJlZ2lvbi4KICAgIGF0dGFjaFZpZXc6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdGhpcy5jdXJyZW50VmlldyA9IHZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIENoZWNrcyB3aGV0aGVyIGEgdmlldyBpcyBjdXJyZW50bHkgcHJlc2VudCB3aXRoaW4KICAgIC8vIHRoZSByZWdpb24uIFJldHVybnMgYHRydWVgIGlmIHRoZXJlIGlzIGFuZCBgZmFsc2VgIGlmCiAgICAvLyBubyB2aWV3IGlzIHByZXNlbnQuCiAgICBoYXNWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5lbXB0eSgpOwogIAogICAgICBpZiAodGhpcy4kZWwpIHsKICAgICAgICB0aGlzLmVsID0gdGhpcy4kZWwuc2VsZWN0b3I7CiAgICAgIH0KICAKICAgICAgZGVsZXRlIHRoaXMuJGVsOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbiwKICAKICAgIC8vIGltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kCiAgfSk7CiAgCiAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICBNYXJpb25ldHRlLlJlZ2lvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvLyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIE1hbmFnZSBvbmUgb3IgbW9yZSByZWxhdGVkIGBNYXJpb25ldHRlLlJlZ2lvbmAgb2JqZWN0cy4KICBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIgPSAoZnVuY3Rpb24oTWFyaW9uZXR0ZSkgewogIAogICAgdmFyIFJlZ2lvbk1hbmFnZXIgPSBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLl9yZWdpb25zID0ge307CiAgICAgICAgTWFyaW9uZXR0ZS5Db250cm9sbGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAgIH0sCiAgCiAgICAgIC8vIEFkZCBtdWx0aXBsZSByZWdpb25zIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIG9yIGEKICAgICAgLy8gZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIG9iamVjdCBsaXRlcmFsLCB3aGVyZQogICAgICAvLyBlYWNoIGtleSBiZWNvbWVzIHRoZSByZWdpb24gbmFtZSwgYW5kIGVhY2ggdmFsdWUgaXMKICAgICAgLy8gdGhlIHJlZ2lvbiBkZWZpbml0aW9uLgogICAgICBhZGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAKICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogIAogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24oZGVmaW5pdGlvbiwgbmFtZSkgewogICAgICAgICAgaWYgKF8uaXNTdHJpbmcoZGVmaW5pdGlvbikpIHsKICAgICAgICAgICAgZGVmaW5pdGlvbiA9IHtzZWxlY3RvcjogZGVmaW5pdGlvbn07CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24obmFtZSwgZGVmaW5pdGlvbikgewogICAgICAgIHZhciByZWdpb247CiAgCiAgICAgICAgaWYgKGRlZmluaXRpb24gaW5zdGFuY2VvZiBNYXJpb25ldHRlLlJlZ2lvbikgewogICAgICAgICAgcmVnaW9uID0gZGVmaW5pdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVnaW9uID0gTWFyaW9uZXR0ZS5SZWdpb24uYnVpbGRSZWdpb24oZGVmaW5pdGlvbiwgTWFyaW9uZXR0ZS5SZWdpb24pOwogICAgICAgIH0KICAKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAKICAgICAgICB0aGlzLl9zdG9yZShuYW1lLCByZWdpb24pOwogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgICAgfSwKICAKICAgICAgLy8gR2V0IGEgcmVnaW9uIGJ5IG5hbWUKICAgICAgZ2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbnNbbmFtZV07CiAgICAgIH0sCiAgCiAgICAgIC8vIEdldHMgYWxsIHRoZSByZWdpb25zIGNvbnRhaW5lZCB3aXRoaW4KICAgICAgLy8gdGhlIGByZWdpb25NYW5hZ2VyYCBpbnN0YW5jZS4KICAgICAgZ2V0UmVnaW9uczogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9yZWdpb25zKTsKICAgICAgfSwKICAKICAgICAgLy8gUmVtb3ZlIGEgcmVnaW9uIGJ5IG5hbWUKICAgICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbbmFtZV07CiAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgCiAgICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgICAgfSwKICAKICAgICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIHJlZ2lvbiBtYW5hZ2VyLCBhbmQKICAgICAgLy8gcmVtb3ZlIHRoZW0KICAgICAgcmVtb3ZlUmVnaW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24ocmVnaW9uLCBuYW1lKSB7CiAgICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB9LCB0aGlzKTsKICAKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAKICAgICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIHJlZ2lvbiBtYW5hZ2VyLCBidXQKICAgICAgLy8gbGVhdmUgdGhlbSBhdHRhY2hlZAogICAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByZWdpb25zID0gdGhpcy5nZXRSZWdpb25zKCk7CiAgICAgICAgXy5lYWNoKHJlZ2lvbnMsIGZ1bmN0aW9uKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgCiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZW1vdmVSZWdpb25zKCk7CiAgICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuQ29udHJvbGxlci5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9LAogIAogICAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gc3RvcmUgcmVnaW9ucwogICAgICBfc3RvcmU6IGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIHRoaXMuX3JlZ2lvbnNbbmFtZV0gPSByZWdpb247CiAgICAgICAgdGhpcy5fc2V0TGVuZ3RoKCk7CiAgICAgIH0sCiAgCiAgICAgIC8vIGludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSByZWdpb24KICAgICAgX3JlbW92ZTogZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogIAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxlbmd0aCA9IF8uc2l6ZSh0aGlzLl9yZWdpb25zKTsKICAgICAgfQogIAogICAgfSk7CiAgCiAgICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbihSZWdpb25NYW5hZ2VyLnByb3RvdHlwZSwgJ19yZWdpb25zJyk7CiAgCiAgICByZXR1cm4gUmVnaW9uTWFuYWdlcjsKICB9KShNYXJpb25ldHRlKTsKICAKCiAgLy8gVGVtcGxhdGUgQ2FjaGUKICAvLyAtLS0tLS0tLS0tLS0tLQogIAogIC8vIE1hbmFnZSB0ZW1wbGF0ZXMgc3RvcmVkIGluIGA8c2NyaXB0PmAgYmxvY2tzLAogIC8vIGNhY2hpbmcgdGhlbSBmb3IgZmFzdGVyIGFjY2Vzcy4KICBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUgPSBmdW5jdGlvbih0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgCiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIGNhY2hlZFRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXTsKICAKICAgICAgaWYgKCFjYWNoZWRUZW1wbGF0ZSkgewogICAgICAgIGNhY2hlZFRlbXBsYXRlID0gbmV3IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSh0ZW1wbGF0ZUlkKTsKICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGVzW3RlbXBsYXRlSWRdID0gY2FjaGVkVGVtcGxhdGU7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGNhY2hlZFRlbXBsYXRlLmxvYWQoKTsKICAgIH0sCiAgCiAgICAvLyBDbGVhciB0ZW1wbGF0ZXMgZnJvbSB0aGUgY2FjaGUuIElmIG5vIGFyZ3VtZW50cwogICAgLy8gYXJlIHNwZWNpZmllZCwgY2xlYXJzIGFsbCB0ZW1wbGF0ZXM6CiAgICAvLyBgY2xlYXIoKWAKICAgIC8vCiAgICAvLyBJZiBhcmd1bWVudHMgYXJlIHNwZWNpZmllZCwgY2xlYXJzIGVhY2ggb2YgdGhlCiAgICAvLyBzcGVjaWZpZWQgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlOgogICAgLy8gYGNsZWFyKCIjdDEiLCAiI3QyIiwgIi4uLiIpYAogICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaTsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHZhciBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICAKICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLnRlbXBsYXRlQ2FjaGVzW2FyZ3NbaV1dOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGVzID0ge307CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBUZW1wbGF0ZUNhY2hlIGluc3RhbmNlIG1ldGhvZHMsIGFsbG93aW5nIGVhY2gKICAvLyB0ZW1wbGF0ZSBjYWNoZSBvYmplY3QgdG8gbWFuYWdlIGl0cyBvd24gc3RhdGUKICAvLyBhbmQga25vdyB3aGV0aGVyIG9yIG5vdCBpdCBoYXMgYmVlbiBsb2FkZWQKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUucHJvdG90eXBlLCB7CiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9hZCB0aGUgdGVtcGxhdGUKICAgIGxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAKICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogIAogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVJZCkgewogICAgICB2YXIgdGVtcGxhdGUgPSBCYWNrYm9uZS4kKHRlbXBsYXRlSWQpLmh0bWwoKTsKICAKICAgICAgaWYgKCF0ZW1wbGF0ZSB8fCB0ZW1wbGF0ZS5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9UZW1wbGF0ZUVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCB0ZW1wbGF0ZTogIicgKyB0ZW1wbGF0ZUlkICsgJyInCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfSwKICAKICAgIC8vIFByZS1jb21waWxlIHRoZSB0ZW1wbGF0ZSBiZWZvcmUgY2FjaGluZyBpdC4gT3ZlcnJpZGUKICAgIC8vIHRoaXMgbWV0aG9kIGlmIHlvdSBkbyBub3QgbmVlZCB0byBwcmUtY29tcGlsZSBhIHRlbXBsYXRlCiAgICAvLyAoSlNUIC8gUmVxdWlyZUpTIGZvciBleGFtcGxlKSBvciBpZiB5b3Ugd2FudCB0byBjaGFuZ2UKICAgIC8vIHRoZSB0ZW1wbGF0ZSBlbmdpbmUgdXNlZCAoSGFuZGViYXJzLCBldGMpLgogICAgY29tcGlsZVRlbXBsYXRlOiBmdW5jdGlvbihyYXdUZW1wbGF0ZSkgewogICAgICByZXR1cm4gXy50ZW1wbGF0ZShyYXdUZW1wbGF0ZSk7CiAgICB9CiAgfSk7CiAgCiAgLy8gUmVuZGVyZXIKICAvLyAtLS0tLS0tLQogIAogIC8vIFJlbmRlciBhIHRlbXBsYXRlIHdpdGggZGF0YSBieSBwYXNzaW5nIGluIHRoZSB0ZW1wbGF0ZQogIC8vIHNlbGVjdG9yIGFuZCB0aGUgZGF0YSB0byByZW5kZXIuCiAgTWFyaW9uZXR0ZS5SZW5kZXJlciA9IHsKICAKICAgIC8vIFJlbmRlciBhIHRlbXBsYXRlIHdpdGggZGF0YS4gVGhlIGB0ZW1wbGF0ZWAgcGFyYW1ldGVyIGlzCiAgICAvLyBwYXNzZWQgdG8gdGhlIGBUZW1wbGF0ZUNhY2hlYCBvYmplY3QgdG8gcmV0cmlldmUgdGhlCiAgICAvLyB0ZW1wbGF0ZSBmdW5jdGlvbi4gT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gcHJvdmlkZSB5b3VyIG93bgogICAgLy8gY3VzdG9tIHJlbmRlcmluZyBhbmQgdGVtcGxhdGUgaGFuZGxpbmcgZm9yIGFsbCBvZiBNYXJpb25ldHRlLgogICAgcmVuZGVyOiBmdW5jdGlvbih0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAKCiAgLyoganNoaW50IG1heGxlbjogMTE0LCBub25ldzogZmFsc2UgKi8KICAvLyBNYXJpb25ldHRlLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAKICAvLyBUaGUgY29yZSB2aWV3IGNsYXNzIHRoYXQgb3RoZXIgTWFyaW9uZXR0ZSB2aWV3cyBleHRlbmQgZnJvbS4KICBNYXJpb25ldHRlLlZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogIAogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgCiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogIAogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogIAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlJyk7CiAgICB9LAogIAogICAgLy8gU2VyaWFsaXplIGEgbW9kZWwgYnkgcmV0dXJuaW5nIGl0cyBhdHRyaWJ1dGVzLiBDbG9uZXMKICAgIC8vIHRoZSBhdHRyaWJ1dGVzIHRvIGFsbG93IG1vZGlmaWNhdGlvbi4KICAgIHNlcmlhbGl6ZU1vZGVsOiBmdW5jdGlvbihtb2RlbCl7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogIAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307CiAgICAgIHZhciB0ZW1wbGF0ZUhlbHBlcnMgPSB0aGlzLmdldE9wdGlvbigndGVtcGxhdGVIZWxwZXJzJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGVtcGxhdGVIZWxwZXJzKSkgewogICAgICAgIHRlbXBsYXRlSGVscGVycyA9IHRlbXBsYXRlSGVscGVycy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHJldHVybiBfLmV4dGVuZCh0YXJnZXQsIHRlbXBsYXRlSGVscGVycyk7CiAgICB9LAogIAogICAgLy8gbm9ybWFsaXplIHRoZSBrZXlzIG9mIHBhc3NlZCBoYXNoIHdpdGggdGhlIHZpZXdzIGB1aWAgc2VsZWN0b3JzLgogICAgLy8gYHsiQHVpLmZvbyI6ICJiYXIifWAKICAgIG5vcm1hbGl6ZVVJS2V5czogZnVuY3Rpb24oaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGhhc2gsIHVpQmluZGluZ3MgfHwgdWkpOwogICAgfSwKICAKICAgIC8vIG5vcm1hbGl6ZSB0aGUgdmFsdWVzIG9mIHBhc3NlZCBoYXNoIHdpdGggdGhlIHZpZXdzIGB1aWAgc2VsZWN0b3JzLgogICAgLy8gYHtmb286ICJAdWkuYmFyIn1gCiAgICBub3JtYWxpemVVSVZhbHVlczogZnVuY3Rpb24oaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogIAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy50cmlnZ2VycykgeyByZXR1cm47IH0KICAKICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogIAogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdHJpZ2dlckV2ZW50c1trZXldID0gdGhpcy5fYnVpbGRWaWV3VHJpZ2dlcih2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICByZXR1cm4gdHJpZ2dlckV2ZW50czsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkaW5nIEJhY2tib25lLlZpZXcncyBkZWxlZ2F0ZUV2ZW50cyB0byBoYW5kbGUKICAgIC8vIHRoZSBgdHJpZ2dlcnNgLCBgbW9kZWxFdmVudHNgLCBhbmQgYGNvbGxlY3Rpb25FdmVudHNgIGNvbmZpZ3VyYXRpb24KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgdGhpcy5fZGVsZWdhdGVET01FdmVudHMoZXZlbnRzKTsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKHRoaXMubW9kZWwsIHRoaXMuZ2V0T3B0aW9uKCdtb2RlbEV2ZW50cycpKTsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgCiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24oZXZlbnRzQXJnKSB7CiAgICAgIHZhciBldmVudHMgPSBldmVudHNBcmcgfHwgdGhpcy5ldmVudHM7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgeyBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsgfQogIAogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZihfLmlzVW5kZWZpbmVkKGV2ZW50c0FyZykpIHt0aGlzLmV2ZW50cyA9IGV2ZW50czt9CiAgCiAgICAgIHZhciBjb21iaW5lZEV2ZW50cyA9IHt9OwogIAogICAgICAvLyBsb29rIHVwIGlmIHRoaXMgdmlldyBoYXMgYmVoYXZpb3IgZXZlbnRzCiAgICAgIHZhciBiZWhhdmlvckV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdiZWhhdmlvckV2ZW50cycpIHx8IHt9OwogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLmNvbmZpZ3VyZVRyaWdnZXJzKCk7CiAgICAgIHZhciBiZWhhdmlvclRyaWdnZXJzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yVHJpZ2dlcnMnKSB8fCB7fTsKICAKICAgICAgLy8gYmVoYXZpb3IgZXZlbnRzIHdpbGwgYmUgb3ZlcnJpZGVuIGJ5IHZpZXcgZXZlbnRzIGFuZCBvciB0cmlnZ2VycwogICAgICBfLmV4dGVuZChjb21iaW5lZEV2ZW50cywgYmVoYXZpb3JFdmVudHMsIGV2ZW50cywgdHJpZ2dlcnMsIGJlaGF2aW9yVHJpZ2dlcnMpOwogIAogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5kZWxlZ2F0ZUV2ZW50cy5jYWxsKHRoaXMsIGNvbWJpbmVkRXZlbnRzKTsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkaW5nIEJhY2tib25lLlZpZXcncyB1bmRlbGVnYXRlRXZlbnRzIHRvIGhhbmRsZSB1bmJpbmRpbmcKICAgIC8vIHRoZSBgdHJpZ2dlcnNgLCBgbW9kZWxFdmVudHNgLCBhbmQgYGNvbGxlY3Rpb25FdmVudHNgIGNvbmZpZwogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogIAogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgCiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMubW9kZWwsIGJlaGF2aW9yLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgICAgYmVoYXZpb3IudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgYmVoYXZpb3IuZ2V0T3B0aW9uKCdjb2xsZWN0aW9uRXZlbnRzJykpOwogICAgICB9LCB0aGlzKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLCBoYW5kbGVzIHRoZSBgc2hvd2AgZXZlbnQuCiAgICBvblNob3dDYWxsZWQ6IGZ1bmN0aW9uKCkge30sCiAgCiAgICAvLyBJbnRlcm5hbCBoZWxwZXIgbWV0aG9kIHRvIHZlcmlmeSB3aGV0aGVyIHRoZSB2aWV3IGhhc24ndCBiZWVuIGRlc3Ryb3llZAogICAgX2Vuc3VyZVZpZXdJc0ludGFjdDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1ZpZXdEZXN0cm95ZWRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnVmlldyAoY2lkOiAiJyArIHRoaXMuY2lkICsgJyIpIGhhcyBhbHJlYWR5IGJlZW4gZGVzdHJveWVkIGFuZCBjYW5ub3QgYmUgdXNlZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBEZWZhdWx0IGBkZXN0cm95YCBpbXBsZW1lbnRhdGlvbiwgZm9yIHJlbW92aW5nIGEgdmlldyBmcm9tIHRoZQogICAgLy8gRE9NIGFuZCB1bmJpbmRpbmcgaXQuIFJlZ2lvbnMgd2lsbCBjYWxsIHRoaXMgbWV0aG9kCiAgICAvLyBmb3IgeW91LiBZb3UgY2FuIHNwZWNpZnkgYW4gYG9uRGVzdHJveWAgbWV0aG9kIGluIHlvdXIgdmlldyB0bwogICAgLy8gYWRkIGN1c3RvbSBjb2RlIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSB2aWV3IGlzIGRlc3Ryb3llZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgeyByZXR1cm47IH0KICAKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2JlZm9yZTpkZXN0cm95J10uY29uY2F0KGFyZ3MpKTsKICAKICAgICAgLy8gbWFyayBhcyBkZXN0cm95ZWQgYmVmb3JlIGRvaW5nIHRoZSBhY3R1YWwgZGVzdHJveSwgdG8KICAgICAgLy8gcHJldmVudCBpbmZpbml0ZSBsb29wcyB3aXRoaW4gImRlc3Ryb3kiIGV2ZW50IGhhbmRsZXJzCiAgICAgIC8vIHRoYXQgYXJlIHRyeWluZyB0byBkZXN0cm95IG90aGVyIHZpZXdzCiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydkZXN0cm95J10uY29uY2F0KGFyZ3MpKTsKICAKICAgICAgLy8gdW5iaW5kIFVJIGVsZW1lbnRzCiAgICAgIHRoaXMudW5iaW5kVUlFbGVtZW50cygpOwogIAogICAgICAvLyByZW1vdmUgdGhlIHZpZXcgZnJvbSB0aGUgRE9NCiAgICAgIHRoaXMucmVtb3ZlKCk7CiAgCiAgICAgIC8vIENhbGwgZGVzdHJveSBvbiBlYWNoIGJlaGF2aW9yIGFmdGVyCiAgICAgIC8vIGRlc3Ryb3lpbmcgdGhlIHZpZXcuCiAgICAgIC8vIFRoaXMgdW5iaW5kcyBldmVudCBsaXN0ZW5lcnMKICAgICAgLy8gdGhhdCBiZWhhdmlvcnMgaGF2ZSByZWdpc3RlcmQgZm9yLgogICAgICBfLmludm9rZSh0aGlzLl9iZWhhdmlvcnMsICdkZXN0cm95JywgYXJncyk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIGJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogIAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy51aSkgeyByZXR1cm47IH0KICAKICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAKICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogIAogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBzZWxlY3RvciA9IGJpbmRpbmdzW2tleV07CiAgICAgICAgdGhpcy51aVtrZXldID0gdGhpcy4kKHNlbGVjdG9yKTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogIAogICAgLy8gVGhpcyBtZXRob2QgdW5iaW5kcyB0aGUgZWxlbWVudHMgc3BlY2lmaWVkIGluIHRoZSAidWkiIGhhc2gKICAgIHVuYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fdW5iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogIAogICAgX3VuYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIGRlbGV0ZSBhbGwgb2YgdGhlIGV4aXN0aW5nIHVpIGJpbmRpbmdzCiAgICAgIF8uZWFjaCh0aGlzLnVpLCBmdW5jdGlvbigkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgCiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24odHJpZ2dlckRlZikgewogICAgICB2YXIgaGFzT3B0aW9ucyA9IF8uaXNPYmplY3QodHJpZ2dlckRlZik7CiAgCiAgICAgIHZhciBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgKGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30pLCB7CiAgICAgICAgcHJldmVudERlZmF1bHQ6IHRydWUsCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiB0cnVlCiAgICAgIH0pOwogIAogICAgICB2YXIgZXZlbnROYW1lID0gaGFzT3B0aW9ucyA/IG9wdGlvbnMuZXZlbnQgOiB0cmlnZ2VyRGVmOwogIAogICAgICByZXR1cm4gZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogIAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciByZXQgPSBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICRlbCB0byB0aGUgdmlldydzICRlbC4KICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSBhIHZpZXcncyAkZWwgcHJveHkKICAgICAgLy8gaXMgbm90IHNldCB1bnRpbCBhZnRlciBzZXRFbGVtZW50IGlzIGNhbGxlZC4KICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCAncHJveHlWaWV3UHJvcGVydGllcycsIHRoaXMpOwogIAogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAKICAgIC8vIGltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgdHJpZ2dlck1ldGhvZCA9IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZDsKICAKICAgICAgdmFyIHJldCA9IHRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIAogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIAogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgCiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgICBNYXJpb25ldHRlLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBTZXJpYWxpemUgdGhlIG1vZGVsIG9yIGNvbGxlY3Rpb24gZm9yIHRoZSB2aWV3LiBJZiBhIG1vZGVsIGlzCiAgICAvLyBmb3VuZCwgdGhlIHZpZXcncyBgc2VyaWFsaXplTW9kZWxgIGlzIGNhbGxlZC4gSWYgYSBjb2xsZWN0aW9uIGlzIGZvdW5kLAogICAgLy8gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbiBpcyBzZXJpYWxpemVkIGJ5IGNhbGxpbmcKICAgIC8vIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZUNvbGxlY3Rpb25gIGFuZCBwdXQgaW50byBhbiBgaXRlbXNgIGFycmF5IGluCiAgICAvLyB0aGUgcmVzdWx0aW5nIGRhdGEuIElmIGJvdGggYXJlIGZvdW5kLCBkZWZhdWx0cyB0byB0aGUgbW9kZWwuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcgZGVmaW5pdGlvbiwKICAgIC8vIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbigpewogICAgICB2YXIgZGF0YSA9IHt9OwogIAogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogIAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24udG9KU09OLmFwcGx5KGNvbGxlY3Rpb24sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIHRoZSB2aWV3LCBkZWZhdWx0aW5nIHRvIHVuZGVyc2NvcmUuanMgdGVtcGxhdGVzLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGlzIGluIHlvdXIgdmlldyBkZWZpbml0aW9uIHRvIHByb3ZpZGUKICAgIC8vIGEgdmVyeSBzcGVjaWZpYyByZW5kZXJpbmcgZm9yIHlvdXIgdmlldy4gSW4gZ2VuZXJhbCwgdGhvdWdoLAogICAgLy8geW91IHNob3VsZCBvdmVycmlkZSB0aGUgYE1hcmlvbmV0dGUuUmVuZGVyZXJgIG9iamVjdCB0bwogICAgLy8gY2hhbmdlIGhvdyBNYXJpb25ldHRlIHJlbmRlcnMgdmlld3MuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgCiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMuZ2V0VGVtcGxhdGUoKTsKICAKICAgICAgLy8gQWxsb3cgdGVtcGxhdGUtbGVzcyBpdGVtIHZpZXdzCiAgICAgIGlmICh0ZW1wbGF0ZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdVbmRlZmluZWRUZW1wbGF0ZUVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdDYW5ub3QgcmVuZGVyIHRoZSB0ZW1wbGF0ZSBzaW5jZSBpdCBpcyBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgLy8gQWRkIGluIGVudGl0eSBkYXRhIGFuZCB0ZW1wbGF0ZSBoZWxwZXJzCiAgICAgIHZhciBkYXRhID0gdGhpcy5zZXJpYWxpemVEYXRhKCk7CiAgICAgIGRhdGEgPSB0aGlzLm1peGluVGVtcGxhdGVIZWxwZXJzKGRhdGEpOwogIAogICAgICAvLyBSZW5kZXIgYW5kIGFkZCB0byBlbAogICAgICB2YXIgaHRtbCA9IE1hcmlvbmV0dGUuUmVuZGVyZXIucmVuZGVyKHRlbXBsYXRlLCBkYXRhLCB0aGlzKTsKICAgICAgdGhpcy5hdHRhY2hFbENvbnRlbnQoaHRtbCk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIEF0dGFjaGVzIHRoZSBjb250ZW50IG9mIGEgZ2l2ZW4gdmlldy4KICAgIC8vIFRoaXMgbWV0aG9kIGNhbiBiZSBvdmVycmlkZGVuIHRvIG9wdGltaXplIHJlbmRlcmluZywKICAgIC8vIG9yIHRvIHJlbmRlciBpbiBhIG5vbiBzdGFuZGFyZCB3YXkuCiAgICAvLwogICAgLy8gRm9yIGV4YW1wbGUsIHVzaW5nIGBpbm5lckhUTUxgIGluc3RlYWQgb2YgYCRlbC5odG1sYAogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyBhdHRhY2hFbENvbnRlbnQ6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIC8vICAgdGhpcy5lbC5pbm5lckhUTUwgPSBodG1sOwogICAgLy8gICByZXR1cm4gdGhpczsKICAgIC8vIH0KICAgIC8vIGBgYAogICAgYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwoaHRtbCk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIE92ZXJyaWRlIHRoZSBkZWZhdWx0IGRlc3Ryb3kgZXZlbnQgdG8gYWRkIGEgZmV3CiAgICAvLyBtb3JlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQuCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHJldHVybiBNYXJpb25ldHRlLlZpZXcucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9KTsKICAKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTQgKi8KICAvKiBqc2hpbnQgbWF4bGVuOiAyMDAgKi8KICAKICAvLyBDb2xsZWN0aW9uIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAKICAvLyBBIHZpZXcgdGhhdCBpdGVyYXRlcyBvdmVyIGEgQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIGFuZCByZW5kZXJzIGFuIGluZGl2aWR1YWwgY2hpbGQgdmlldyBmb3IgZWFjaCBtb2RlbC4KICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgCiAgICAvLyB1c2VkIGFzIHRoZSBwcmVmaXggZm9yIGNoaWxkIHZpZXcgZXZlbnRzCiAgICAvLyB0aGF0IGFyZSBmb3J3YXJkZWQgdGhyb3VnaCB0aGUgY29sbGVjdGlvbnZpZXcKICAgIGNoaWxkVmlld0V2ZW50UHJlZml4OiAnY2hpbGR2aWV3JywKICAKICAgIC8vIGNvbnN0cnVjdG9yCiAgICAvLyBvcHRpb24gdG8gcGFzcyBge3NvcnQ6IGZhbHNlfWAgdG8gcHJldmVudCB0aGUgYENvbGxlY3Rpb25WaWV3YCBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucyl7CiAgICAgIHZhciBpbml0T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuc29ydCA9IF8uaXNVbmRlZmluZWQoaW5pdE9wdGlvbnMuc29ydCkgPyB0cnVlIDogaW5pdE9wdGlvbnMuc29ydDsKICAKICAgICAgaWYgKGluaXRPcHRpb25zLmNvbGxlY3Rpb24gJiYgIShpbml0T3B0aW9ucy5jb2xsZWN0aW9uIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbikpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignVGhlIENvbGxlY3Rpb24gb3B0aW9uIHBhc3NlZCB0byB0aGlzIHZpZXcgbmVlZHMgdG8gYmUgYW4gaW5zdGFuY2Ugb2YgYSBCYWNrYm9uZS5Db2xsZWN0aW9uJyk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbmNlKCdyZW5kZXInLCB0aGlzLl9pbml0aWFsRXZlbnRzKTsKICAKICAgICAgdGhpcy5faW5pdENoaWxkVmlld1N0b3JhZ2UoKTsKICAKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgfSwKICAKICAgIC8vIEluc3RlYWQgb2YgaW5zZXJ0aW5nIGVsZW1lbnRzIG9uZSBieSBvbmUgaW50byB0aGUgcGFnZSwKICAgIC8vIGl0J3MgbXVjaCBtb3JlIHBlcmZvcm1hbnQgdG8gaW5zZXJ0IGVsZW1lbnRzIGludG8gYSBkb2N1bWVudAogICAgLy8gZnJhZ21lbnQgYW5kIHRoZW4gaW5zZXJ0IHRoYXQgZG9jdW1lbnQgZnJhZ21lbnQgaW50byB0aGUgcGFnZQogICAgaW5pdFJlbmRlckJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZWxCdWZmZXIgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgIH0sCiAgCiAgICBzdGFydEJ1ZmZlcmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX3RyaWdnZXJCZWZvcmVTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmF0dGFjaEJ1ZmZlcih0aGlzLCB0aGlzLmVsQnVmZmVyKTsKICAgICAgdGhpcy5fdHJpZ2dlclNob3dCdWZmZXJlZENoaWxkcmVuKCk7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgfSwKICAKICAgIF90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdiZWZvcmU6c2hvdycpKTsKICAgICAgfQogICAgfSwKICAKICAgIF90cmlnZ2VyU2hvd0J1ZmZlcmVkQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogIAogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uKGV2ZW50LCBjaGlsZFZpZXcpIHsKICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24oY2hpbGRWaWV3LCBldmVudCk7CiAgICB9LAogIAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAvLyBiaW5kcyB0by4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnYWRkJywgdGhpcy5fb25Db2xsZWN0aW9uQWRkKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3JlbW92ZScsIHRoaXMuX29uQ29sbGVjdGlvblJlbW92ZSk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZXNldCcsIHRoaXMucmVuZGVyKTsKICAKICAgICAgICBpZiAodGhpcy5zb3J0KSB7CiAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3NvcnQnLCB0aGlzLl9zb3J0Vmlld3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8vIEhhbmRsZSBhIGNoaWxkIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uCiAgICBfb25Db2xsZWN0aW9uQWRkOiBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChtb2RlbCk7CiAgICAgIHRoaXMucmVtb3ZlQ2hpbGRWaWV3KHZpZXcpOwogICAgICB0aGlzLmNoZWNrRW1wdHkoKTsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkZSBmcm9tIGBNYXJpb25ldHRlLlZpZXdgIHRvIHRyaWdnZXIgc2hvdyBvbiBjaGlsZCB2aWV3cwogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ3Nob3cnKSk7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIGNoaWxkcmVuIHZpZXdzLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0bwogICAgLy8gcHJvdmlkZSB5b3VyIG93biBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlbmRlciBmdW5jdGlvbiBmb3IKICAgIC8vIHRoZSBjb2xsZWN0aW9uIHZpZXcuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGNoZWNrcyBmb3IgYW55IGNoYW5nZXMgaW4gdGhlIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gSWYgdGhlIGluZGV4IG9mIGFueSB2aWV3IGRvZXNuJ3QgbWF0Y2gsIGl0IHdpbGwgcmVuZGVyLgogICAgX3NvcnRWaWV3czogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNoZWNrIGZvciBhbnkgY2hhbmdlcyBpbiBzb3J0IG9yZGVyIG9mIHZpZXdzCiAgICAgIHZhciBvcmRlckNoYW5nZWQgPSB0aGlzLmNvbGxlY3Rpb24uZmluZChmdW5jdGlvbihpdGVtLCBpbmRleCl7CiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmNoaWxkcmVuLmZpbmRCeU1vZGVsKGl0ZW0pOwogICAgICAgIHJldHVybiAhdmlldyB8fCB2aWV3Ll9pbmRleCAhPT0gaW5kZXg7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICBpZiAob3JkZXJDaGFuZ2VkKSB7CiAgICAgICAgdGhpcy5yZXNvcnRWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIFNlcGFyYXRlZCBzbyB0aGF0IENvbXBvc2l0ZVZpZXcgY2FuIGhhdmUKICAgIC8vIG1vcmUgY29udHJvbCBvdmVyIGV2ZW50cyBiZWluZyB0cmlnZ2VyZWQsIGFyb3VuZCB0aGUgcmVuZGVyaW5nCiAgICAvLyBwcm9jZXNzCiAgICBfcmVuZGVyQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdGhpcy5kZXN0cm95Q2hpbGRyZW4oKTsKICAKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmNvbGxlY3Rpb24nLCB0aGlzKTsKICAgICAgICB0aGlzLnN0YXJ0QnVmZmVyaW5nKCk7CiAgICAgICAgdGhpcy5zaG93Q29sbGVjdGlvbigpOwogICAgICAgIHRoaXMuZW5kQnVmZmVyaW5nKCk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGxvb3AgdGhyb3VnaCBjb2xsZWN0aW9uIGFuZCBzaG93IGVhY2ggY2hpbGQgdmlldy4KICAgIHNob3dDb2xsZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24oY2hpbGQsIGluZGV4KSB7CiAgICAgICAgQ2hpbGRWaWV3ID0gdGhpcy5nZXRDaGlsZFZpZXcoY2hpbGQpOwogICAgICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQsIENoaWxkVmlldywgaW5kZXgpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2hvdyBhbiBlbXB0eSB2aWV3IGluIHBsYWNlIG9mCiAgICAvLyBhIGNvbGxlY3Rpb24gb2YgY2hpbGQgdmlld3MsIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkKICAgIHNob3dFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgRW1wdHlWaWV3ID0gdGhpcy5nZXRFbXB0eVZpZXcoKTsKICAKICAgICAgaWYgKEVtcHR5VmlldyAmJiAhdGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjplbXB0eScpOwogIAogICAgICAgIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXcgPSB0cnVlOwogICAgICAgIHZhciBtb2RlbCA9IG5ldyBCYWNrYm9uZS5Nb2RlbCgpOwogICAgICAgIHRoaXMuYWRkRW1wdHlWaWV3KG1vZGVsLCBFbXB0eVZpZXcpOwogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOmVtcHR5Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gZGVzdHJveSBhbiBleGlzdGluZyBlbXB0eVZpZXcgaW5zdGFuY2UKICAgIC8vIGlmIG9uZSBleGlzdHMuIENhbGxlZCB3aGVuIGEgY29sbGVjdGlvbiB2aWV3IGhhcyBiZWVuCiAgICAvLyByZW5kZXJlZCBlbXB0eSwgYW5kIHRoZW4gYSBjaGlsZCBpcyBhZGRlZCB0byB0aGUgY29sbGVjdGlvbi4KICAgIGRlc3Ryb3lFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogIAogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRPcHRpb24oJ2VtcHR5VmlldycpOwogICAgfSwKICAKICAgIC8vIFJlbmRlciBhbmQgc2hvdyB0aGUgZW1wdHlWaWV3LiBTaW1pbGFyIHRvIGFkZENoaWxkIG1ldGhvZAogICAgLy8gYnV0ICJjaGlsZDphZGRlZCIgZXZlbnRzIGFyZSBub3QgZmlyZWQsIGFuZCB0aGUgZXZlbnQgZnJvbQogICAgLy8gZW1wdHlWaWV3IGFyZSBub3QgZm9yd2FyZGVkCiAgICBhZGRFbXB0eVZpZXc6IGZ1bmN0aW9uKGNoaWxkLCBFbXB0eVZpZXcpIHsKICAKICAgICAgLy8gZ2V0IHRoZSBlbXB0eVZpZXdPcHRpb25zLCBmYWxsaW5nIGJhY2sgdG8gY2hpbGRWaWV3T3B0aW9ucwogICAgICB2YXIgZW1wdHlWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXdPcHRpb25zJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZW1wdHlWaWV3T3B0aW9ucykpewogICAgICAgIGVtcHR5Vmlld09wdGlvbnMgPSBlbXB0eVZpZXdPcHRpb25zLmNhbGwodGhpcyk7CiAgICAgIH0KICAKICAgICAgLy8gYnVpbGQgdGhlIGVtcHR5IHZpZXcKICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBFbXB0eVZpZXcsIGVtcHR5Vmlld09wdGlvbnMpOwogIAogICAgICAvLyBQcm94eSBlbXB0eVZpZXcgZXZlbnRzCiAgICAgIHRoaXMucHJveHlDaGlsZEV2ZW50cyh2aWV3KTsKICAKICAgICAgLy8gdHJpZ2dlciB0aGUgJ2JlZm9yZTpzaG93JyBldmVudCBvbiBgdmlld2AgaWYgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgICAvLyBoYXMgYWxyZWFkeSBiZWVuIHNob3duCiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgIH0KICAKICAgICAgLy8gU3RvcmUgdGhlIGBlbXB0eVZpZXdgIGxpa2UgYSBgY2hpbGRWaWV3YCBzbyB3ZSBjYW4gcHJvcGVybHkKICAgICAgLy8gcmVtb3ZlIGFuZC9vciBjbG9zZSBpdCBsYXRlcgogICAgICB0aGlzLmNoaWxkcmVuLmFkZCh2aWV3KTsKICAKICAgICAgLy8gUmVuZGVyIGl0IGFuZCBzaG93IGl0CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIC0xKTsKICAKICAgICAgLy8gY2FsbCB0aGUgJ3Nob3cnIG1ldGhvZCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gUmV0cmlldmUgdGhlIGBjaGlsZFZpZXdgIGNsYXNzLCBlaXRoZXIgZnJvbSBgdGhpcy5vcHRpb25zLmNoaWxkVmlld2AKICAgIC8vIG9yIGZyb20gdGhlIGBjaGlsZFZpZXdgIGluIHRoZSBvYmplY3QgZGVmaW5pdGlvbi4gVGhlICJvcHRpb25zIgogICAgLy8gdGFrZXMgcHJlY2VkZW5jZS4KICAgIC8vIFRoaXMgbWV0aG9kIHJlY2VpdmVzIHRoZSBtb2RlbCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBpbnN0YW5jZQogICAgLy8gY3JlYXRlZCBmcm9tIHRoaXMgYGNoaWxkVmlld2AuIE92ZXJyaWRpbmcgbWV0aG9kcyBtYXkgdXNlIHRoZSBjaGlsZAogICAgLy8gdG8gZGV0ZXJtaW5lIHdoYXQgYGNoaWxkVmlld2AgY2xhc3MgdG8gcmV0dXJuLgogICAgZ2V0Q2hpbGRWaWV3OiBmdW5jdGlvbihjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogIAogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIHZhciBjaGlsZFZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld09wdGlvbnMnKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihjaGlsZFZpZXdPcHRpb25zKSkgewogICAgICAgIGNoaWxkVmlld09wdGlvbnMgPSBjaGlsZFZpZXdPcHRpb25zLmNhbGwodGhpcywgY2hpbGQsIGluZGV4KTsKICAgICAgfQogIAogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIENoaWxkVmlldywgY2hpbGRWaWV3T3B0aW9ucyk7CiAgCiAgICAgIC8vIGluY3JlbWVudCBpbmRpY2VzIG9mIHZpZXdzIGFmdGVyIHRoaXMgb25lCiAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgdHJ1ZSwgaW5kZXgpOwogIAogICAgICB0aGlzLl9hZGRDaGlsZFZpZXcodmlldywgaW5kZXgpOwogIAogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIFRoaXMgZGVjcmVtZW50cyBvciBpbmNyZW1lbnRzIHRoZSBpbmRpY2VzIG9mIHZpZXdzIGFmdGVyIHRoZQogICAgLy8gYWRkZWQvcmVtb3ZlZCB2aWV3IHRvIGtlZXAgaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgX3VwZGF0ZUluZGljZXM6IGZ1bmN0aW9uKHZpZXcsIGluY3JlbWVudCwgaW5kZXgpIHsKICAgICAgaWYgKCF0aGlzLnNvcnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgaWYgKGluY3JlbWVudCkgewogICAgICAgIC8vIGFzc2lnbiB0aGUgaW5kZXggdG8gdGhlIHZpZXcKICAgICAgICB2aWV3Ll9pbmRleCA9IGluZGV4OwogIAogICAgICAgIC8vIGluY3JlbWVudCB0aGUgaW5kZXggb2Ygdmlld3MgYWZ0ZXIgdGhpcyBvbmUKICAgICAgICB0aGlzLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24gKGxhdGVyVmlldykgewogICAgICAgICAgaWYgKGxhdGVyVmlldy5faW5kZXggPj0gdmlldy5faW5kZXgpIHsKICAgICAgICAgICAgbGF0ZXJWaWV3Ll9pbmRleCsrOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIC8vIGRlY3JlbWVudCB0aGUgaW5kZXggb2Ygdmlld3MgYWZ0ZXIgdGhpcyBvbmUKICAgICAgICB0aGlzLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24gKGxhdGVyVmlldykgewogICAgICAgICAgaWYgKGxhdGVyVmlldy5faW5kZXggPj0gdmlldy5faW5kZXgpIHsKICAgICAgICAgICAgbGF0ZXJWaWV3Ll9pbmRleC0tOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogIAogICAgLy8gSW50ZXJuYWwgTWV0aG9kLiBBZGQgdGhlIHZpZXcgdG8gY2hpbGRyZW4gYW5kIHJlbmRlciBpdCBhdAogICAgLy8gdGhlIGdpdmVuIGluZGV4LgogICAgX2FkZENoaWxkVmlldzogZnVuY3Rpb24odmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogIAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uKHZpZXcsIGluZGV4KSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIHRoaXMuYXR0YWNoSHRtbCh0aGlzLCB2aWV3LCBpbmRleCk7CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAKICAgIC8vIEJ1aWxkIGEgYGNoaWxkVmlld2AgZm9yIGEgbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBidWlsZENoaWxkVmlldzogZnVuY3Rpb24oY2hpbGQsIENoaWxkVmlld0NsYXNzLCBjaGlsZFZpZXdPcHRpb25zKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe21vZGVsOiBjaGlsZH0sIGNoaWxkVmlld09wdGlvbnMpOwogICAgICByZXR1cm4gbmV3IENoaWxkVmlld0NsYXNzKG9wdGlvbnMpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZSB0aGUgY2hpbGQgdmlldyBhbmQgZGVzdHJveSBpdC4KICAgIC8vIFRoaXMgZnVuY3Rpb24gYWxzbyB1cGRhdGVzIHRoZSBpbmRpY2VzIG9mCiAgICAvLyBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbiBpbiBvcmRlciB0byBrZWVwCiAgICAvLyB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgcmVtb3ZlQ2hpbGRWaWV3OiBmdW5jdGlvbih2aWV3KSB7CiAgCiAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gY2FsbCAnZGVzdHJveScgb3IgJ3JlbW92ZScsIGRlcGVuZGluZyBvbiB3aGljaCBpcyBmb3VuZAogICAgICAgIGlmICh2aWV3LmRlc3Ryb3kpIHsgdmlldy5kZXN0cm95KCk7IH0KICAgICAgICBlbHNlIGlmICh2aWV3LnJlbW92ZSkgeyB2aWV3LnJlbW92ZSgpOyB9CiAgCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgCiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICF0aGlzLmNvbGxlY3Rpb24gfHwgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMDsKICAgIH0sCiAgCiAgICAvLyBJZiBlbXB0eSwgc2hvdyB0aGUgZW1wdHkgdmlldwogICAgY2hlY2tFbXB0eTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzRW1wdHkodGhpcy5jb2xsZWN0aW9uKSkgewogICAgICAgIHRoaXMuc2hvd0VtcHR5VmlldygpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24oY29sbGVjdGlvblZpZXcsIGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgaWYgKGNvbGxlY3Rpb25WaWV3LmlzQnVmZmVyaW5nKSB7CiAgICAgICAgLy8gYnVmZmVyaW5nIGhhcHBlbnMgb24gcmVzZXQgZXZlbnRzIGFuZCBpbml0aWFsIHJlbmRlcnMKICAgICAgICAvLyBpbiBvcmRlciB0byByZWR1Y2UgdGhlIG51bWJlciBvZiBpbnNlcnRzIGludG8gdGhlCiAgICAgICAgLy8gZG9jdW1lbnQsIHdoaWNoIGFyZSBleHBlbnNpdmUuCiAgICAgICAgY29sbGVjdGlvblZpZXcuZWxCdWZmZXIuYXBwZW5kQ2hpbGQoY2hpbGRWaWV3LmVsKTsKICAgICAgICBjb2xsZWN0aW9uVmlldy5fYnVmZmVyZWRDaGlsZHJlbi5wdXNoKGNoaWxkVmlldyk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgLy8gSWYgd2UndmUgYWxyZWFkeSByZW5kZXJlZCB0aGUgbWFpbiBjb2xsZWN0aW9uLCBhcHBlbmQKICAgICAgICAvLyB0aGUgbmV3IGNoaWxkIGludG8gdGhlIGNvcnJlY3Qgb3JkZXIgaWYgd2UgbmVlZCB0by4gT3RoZXJ3aXNlCiAgICAgICAgLy8gYXBwZW5kIHRvIHRoZSBlbmQuCiAgICAgICAgaWYgKCFjb2xsZWN0aW9uVmlldy5faW5zZXJ0QmVmb3JlKGNoaWxkVmlldywgaW5kZXgpKXsKICAgICAgICAgIGNvbGxlY3Rpb25WaWV3Ll9pbnNlcnRBZnRlcihjaGlsZFZpZXcpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQ2hlY2sgd2hldGhlciB3ZSBuZWVkIHRvIGluc2VydCB0aGUgdmlldyBpbnRvCiAgICAvLyB0aGUgY29ycmVjdCBwb3NpdGlvbi4KICAgIF9pbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIChpbmRleCA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChmaW5kUG9zaXRpb24pIHsKICAgICAgICAvLyBGaW5kIHRoZSB2aWV3IGFmdGVyIHRoaXMgb25lCiAgICAgICAgY3VycmVudFZpZXcgPSB0aGlzLmNoaWxkcmVuLmZpbmQoZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIHJldHVybiB2aWV3Ll9pbmRleCA9PT0gaW5kZXggKyAxOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGlmIChjdXJyZW50VmlldykgewogICAgICAgIGN1cnJlbnRWaWV3LiRlbC5iZWZvcmUoY2hpbGRWaWV3LmVsKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogIAogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBBcHBlbmQgYSB2aWV3IHRvIHRoZSBlbmQgb2YgdGhlICRlbAogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbihjaGlsZFZpZXcpIHsKICAgICAgdGhpcy4kZWwuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldCB1cCB0aGUgYGNoaWxkcmVuYCBvYmplY3QgZm9yCiAgICAvLyBzdG9yaW5nIGFsbCBvZiB0aGUgY2hpbGQgdmlld3MKICAgIF9pbml0Q2hpbGRWaWV3U3RvcmFnZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogIAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogIAogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuY2hpbGRyZW4ubWFwKF8uaWRlbnRpdHkpOwogICAgICB0aGlzLmNoaWxkcmVuLmVhY2godGhpcy5yZW1vdmVDaGlsZFZpZXcsIHRoaXMpOwogICAgICB0aGlzLmNoZWNrRW1wdHkoKTsKICAgICAgcmV0dXJuIGNoaWxkVmlld3M7CiAgICB9LAogIAogICAgLy8gU2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcuIFVzZXMgYSAiY2hpbGR2aWV3OiIKICAgIC8vIHByZWZpeCBpbiBmcm9udCBvZiBhbGwgZm9yd2FyZGVkIGV2ZW50cy4KICAgIHByb3h5Q2hpbGRFdmVudHM6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdmFyIHByZWZpeCA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdFdmVudFByZWZpeCcpOwogIAogICAgICAvLyBGb3J3YXJkIGFsbCBjaGlsZCB2aWV3IGV2ZW50cyB0aHJvdWdoIHRoZSBwYXJlbnQsCiAgICAgIC8vIHByZXBlbmRpbmcgImNoaWxkdmlldzoiIHRvIHRoZSBldmVudCBuYW1lCiAgICAgIHRoaXMubGlzdGVuVG8odmlldywgJ2FsbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgCiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIAogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogIAogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICAgIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBDb25maWd1cmVkIHRoZSBpbml0aWFsIGV2ZW50cyB0aGF0IHRoZSBjb21wb3NpdGUgdmlldwogICAgLy8gYmluZHMgdG8uIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHByZXZlbnQgdGhlIGluaXRpYWwKICAgIC8vIGV2ZW50cywgb3IgdG8gYWRkIHlvdXIgb3duIGluaXRpYWwgZXZlbnRzLgogICAgX2luaXRpYWxFdmVudHM6IGZ1bmN0aW9uKCkgewogIAogICAgICAvLyBCaW5kIG9ubHkgYWZ0ZXIgY29tcG9zaXRlIHZpZXcgaXMgcmVuZGVyZWQgdG8gYXZvaWQgYWRkaW5nIGNoaWxkIHZpZXdzCiAgICAgIC8vIHRvIG5vbmV4aXN0ZW50IGNoaWxkVmlld0NvbnRhaW5lcgogIAogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5fcmVuZGVyQ2hpbGRyZW4pOwogIAogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLy8gUmV0cmlldmUgdGhlIGBjaGlsZFZpZXdgIHRvIGJlIHVzZWQgd2hlbiByZW5kZXJpbmcgZWFjaCBvZgogICAgLy8gdGhlIGl0ZW1zIGluIHRoZSBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpcyB0byByZXR1cm4KICAgIC8vIGB0aGlzLmNoaWxkVmlld2Agb3IgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3IGlmIG5vIGBjaGlsZFZpZXdgCiAgICAvLyBoYXMgYmVlbiBkZWZpbmVkCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAKICAgICAgaWYgKHRoaXMubW9kZWwpewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogIAogICAgICByZXR1cm4gZGF0YTsKICAgIH0sCiAgCiAgICAvLyBSZW5kZXJzIHRoZSBtb2RlbCBvbmNlLCBhbmQgdGhlIGNvbGxlY3Rpb24gb25jZS4gQ2FsbGluZwogICAgLy8gdGhpcyBhZ2FpbiB3aWxsIHRlbGwgdGhlIG1vZGVsJ3MgdmlldyB0byByZS1yZW5kZXIgaXRzZWxmCiAgICAvLyBidXQgdGhlIGNvbGxlY3Rpb24gd2lsbCBub3QgcmUtcmVuZGVyLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgCiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzUmVuZGVyZWQpIHsKICAgICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LnByb3RvdHlwZS5fcmVuZGVyQ2hpbGRyZW4uY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIFJlbmRlciB0aGUgcm9vdCB0ZW1wbGF0ZSB0aGF0IHRoZSBjaGlsZHJlbgogICAgLy8gdmlld3MgYXJlIGFwcGVuZGVkIHRvCiAgICBfcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBkYXRhID0gdGhpcy5zZXJpYWxpemVEYXRhKCk7CiAgICAgIGRhdGEgPSB0aGlzLm1peGluVGVtcGxhdGVIZWxwZXJzKGRhdGEpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6dGVtcGxhdGUnKTsKICAKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5nZXRUZW1wbGF0ZSgpOwogICAgICB2YXIgaHRtbCA9IE1hcmlvbmV0dGUuUmVuZGVyZXIucmVuZGVyKHRlbXBsYXRlLCBkYXRhLCB0aGlzKTsKICAgICAgdGhpcy5hdHRhY2hFbENvbnRlbnQoaHRtbCk7CiAgCiAgICAgIC8vIHRoZSB1aSBiaW5kaW5ncyBpcyBkb25lIGhlcmUgYW5kIG5vdCBhdCB0aGUgZW5kIG9mIHJlbmRlciBzaW5jZSB0aGV5CiAgICAgIC8vIHdpbGwgbm90IGJlIGF2YWlsYWJsZSB1bnRpbCBhZnRlciB0aGUgbW9kZWwgaXMgcmVuZGVyZWQsIGJ1dCBzaG91bGQgYmUKICAgICAgLy8gYXZhaWxhYmxlIGJlZm9yZSB0aGUgY29sbGVjdGlvbiBpcyByZW5kZXJlZC4KICAgICAgdGhpcy5iaW5kVUlFbGVtZW50cygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjp0ZW1wbGF0ZScpOwogICAgfSwKICAKICAgIC8vIEF0dGFjaGVzIHRoZSBjb250ZW50IG9mIHRoZSByb290LgogICAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRkZW4gdG8gb3B0aW1pemUgcmVuZGVyaW5nLAogICAgLy8gb3IgdG8gcmVuZGVyIGluIGEgbm9uIHN0YW5kYXJkIHdheS4KICAgIC8vCiAgICAvLyBGb3IgZXhhbXBsZSwgdXNpbmcgYGlubmVySFRNTGAgaW5zdGVhZCBvZiBgJGVsLmh0bWxgCiAgICAvLwogICAgLy8gYGBganMKICAgIC8vIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24oaHRtbCkgewogICAgLy8gICB0aGlzLmVsLmlubmVySFRNTCA9IGh0bWw7CiAgICAvLyAgIHJldHVybiB0aGlzOwogICAgLy8gfQogICAgLy8gYGBgCiAgICBhdHRhY2hFbENvbnRlbnQ6IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uKGNvbXBvc2l0ZVZpZXcsIGJ1ZmZlcikgewogICAgICB2YXIgJGNvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRWaWV3Q29udGFpbmVyKGNvbXBvc2l0ZVZpZXcpOwogICAgICAkY29udGFpbmVyLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwuCiAgICAvLyBPdmVyaWRkZW4gZnJvbSBDb2xsZWN0aW9uVmlldyB0byBlbnN1cmUgdmlldyBpcyBhcHBlbmRlZCB0bwogICAgLy8gY2hpbGRWaWV3Q29udGFpbmVyCiAgICBfaW5zZXJ0QWZ0ZXI6IGZ1bmN0aW9uIChjaGlsZFZpZXcpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcih0aGlzKTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gZW5zdXJlIGFuIGAkY2hpbGRWaWV3Q29udGFpbmVyYCBleGlzdHMsIGZvciB0aGUKICAgIC8vIGBhdHRhY2hIdG1sYCBtZXRob2QgdG8gdXNlLgogICAgZ2V0Q2hpbGRWaWV3Q29udGFpbmVyOiBmdW5jdGlvbihjb250YWluZXJWaWV3KSB7CiAgICAgIGlmICgnJGNoaWxkVmlld0NvbnRhaW5lcicgaW4gY29udGFpbmVyVmlldykgewogICAgICAgIHJldHVybiBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXI7CiAgICAgIH0KICAKICAgICAgdmFyIGNvbnRhaW5lcjsKICAgICAgdmFyIGNoaWxkVmlld0NvbnRhaW5lciA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKGNvbnRhaW5lclZpZXcsICdjaGlsZFZpZXdDb250YWluZXInKTsKICAgICAgaWYgKGNoaWxkVmlld0NvbnRhaW5lcikgewogIAogICAgICAgIHZhciBzZWxlY3RvciA9IF8uaXNGdW5jdGlvbihjaGlsZFZpZXdDb250YWluZXIpID8gY2hpbGRWaWV3Q29udGFpbmVyLmNhbGwoY29udGFpbmVyVmlldykgOiBjaGlsZFZpZXdDb250YWluZXI7CiAgCiAgICAgICAgaWYgKHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gJ0AnICYmIGNvbnRhaW5lclZpZXcudWkpIHsKICAgICAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lclZpZXcudWlbc2VsZWN0b3Iuc3Vic3RyKDQpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy4kKHNlbGVjdG9yKTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgICBuYW1lOiAnQ2hpbGRWaWV3Q29udGFpbmVyTWlzc2luZ0Vycm9yJywKICAgICAgICAgICAgbWVzc2FnZTogJ1RoZSBzcGVjaWZpZWQgImNoaWxkVmlld0NvbnRhaW5lciIgd2FzIG5vdCBmb3VuZDogJyArIGNvbnRhaW5lclZpZXcuY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy4kZWw7CiAgICAgIH0KICAKICAgICAgY29udGFpbmVyVmlldy4kY2hpbGRWaWV3Q29udGFpbmVyID0gY29udGFpbmVyOwogICAgICByZXR1cm4gY29udGFpbmVyOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZXNldCB0aGUgYCRjaGlsZFZpZXdDb250YWluZXJgIG9uIHJlbmRlcgogICAgcmVzZXRDaGlsZFZpZXdDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogIAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICAgIHRoaXMuX2ZpcnN0UmVuZGVyID0gdHJ1ZTsKICAgICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgCiAgICAgIE1hcmlvbmV0dGUuSXRlbVZpZXcuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIH0sCiAgCiAgICAvLyBMYXlvdXRWaWV3J3MgcmVuZGVyIHdpbGwgdXNlIHRoZSBleGlzdGluZyByZWdpb24gb2JqZWN0cyB0aGUKICAgIC8vIGZpcnN0IHRpbWUgaXQgaXMgY2FsbGVkLiBTdWJzZXF1ZW50IGNhbGxzIHdpbGwgZGVzdHJveSB0aGUKICAgIC8vIHZpZXdzIHRoYXQgdGhlIHJlZ2lvbnMgYXJlIHNob3dpbmcgYW5kIHRoZW4gcmVzZXQgdGhlIGBlbGAKICAgIC8vIGZvciB0aGUgcmVnaW9ucyB0byB0aGUgbmV3bHkgcmVuZGVyZWQgRE9NIGVsZW1lbnRzLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgCiAgICAgIGlmICh0aGlzLl9maXJzdFJlbmRlcikgewogICAgICAgIC8vIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHJlbmRlciwgZG9uJ3QgZG8gYW55dGhpbmcgdG8KICAgICAgICAvLyByZXNldCB0aGUgcmVnaW9ucwogICAgICAgIHRoaXMuX2ZpcnN0UmVuZGVyID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgdGhlIGZpcnN0IHJlbmRlciBjYWxsLCB0aGVuIHdlIG5lZWQgdG8KICAgICAgICAvLyByZS1pbml0aWFsaXplIHRoZSBgZWxgIGZvciBlYWNoIHJlZ2lvbgogICAgICAgIHRoaXMuX3JlSW5pdGlhbGl6ZVJlZ2lvbnMoKTsKICAgICAgfQogIAogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gSGFuZGxlIGRlc3Ryb3lpbmcgcmVnaW9ucywgYW5kIHRoZW4gZGVzdHJveSB0aGUgdmlldyBpdHNlbGYuCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuIHRoaXM7IH0KICAKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmRlc3Ryb3koKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuSXRlbVZpZXcucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBBZGQgYSBzaW5nbGUgcmVnaW9uLCBieSBuYW1lLCB0byB0aGUgbGF5b3V0VmlldwogICAgYWRkUmVnaW9uOiBmdW5jdGlvbihuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogIAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25zKSB7CiAgICAgIHRoaXMucmVnaW9ucyA9IF8uZXh0ZW5kKHt9LCB0aGlzLnJlZ2lvbnMsIHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25zKHJlZ2lvbnMpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZSBhIHNpbmdsZSByZWdpb24gZnJvbSB0aGUgTGF5b3V0VmlldywgYnkgbmFtZQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjpyZW1vdmUnLCBuYW1lKTsKICAgICAgZGVsZXRlIHRoaXMucmVnaW9uc1tuYW1lXTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5yZW1vdmVSZWdpb24obmFtZSk7CiAgICB9LAogIAogICAgLy8gUHJvdmlkZXMgYWx0ZXJuYXRpdmUgYWNjZXNzIHRvIHJlZ2lvbnMKICAgIC8vIEFjY2VwdHMgdGhlIHJlZ2lvbiBuYW1lCiAgICAvLyBnZXRSZWdpb24oJ21haW4nKQogICAgZ2V0UmVnaW9uOiBmdW5jdGlvbihyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLnJlZ2lvbk1hbmFnZXIuZ2V0UmVnaW9ucygpOwogICAgfSwKICAKICAgIC8vIGludGVybmFsIG1ldGhvZCB0byBidWlsZCByZWdpb25zCiAgICBfYnVpbGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGF0LiRlbDsgfQogICAgICB9OwogIAogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucywgZGVmYXVsdHMpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHRoZSByZWdpb25zIHRoYXQgaGF2ZSBiZWVuIGRlZmluZWQgaW4gYQogICAgLy8gYHJlZ2lvbnNgIGF0dHJpYnV0ZSBvbiB0aGlzIGxheW91dFZpZXcuCiAgICBfaW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIHJlZ2lvbnM7CiAgICAgIHRoaXMuX2luaXRSZWdpb25NYW5hZ2VyKCk7CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5yZWdpb25zKSkgewogICAgICAgIHJlZ2lvbnMgPSB0aGlzLnJlZ2lvbnMob3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyB8fCB7fTsKICAgICAgfQogIAogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBhcyBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgcmVnaW9uT3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uLmNhbGwob3B0aW9ucywgJ3JlZ2lvbnMnKTsKICAKICAgICAgLy8gZW5hYmxlIHJlZ2lvbiBvcHRpb25zIHRvIGJlIGEgZnVuY3Rpb24KICAgICAgaWYgKF8uaXNGdW5jdGlvbihyZWdpb25PcHRpb25zKSkgewogICAgICAgIHJlZ2lvbk9wdGlvbnMgPSByZWdpb25PcHRpb25zLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAKICAgICAgXy5leHRlbmQocmVnaW9ucywgcmVnaW9uT3B0aW9ucyk7CiAgCiAgICAgIC8vIE5vcm1hbGl6ZSByZWdpb24gc2VsZWN0b3JzIGhhc2ggdG8gYWxsb3cKICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgIHJlZ2lvbnMgPSB0aGlzLm5vcm1hbGl6ZVVJVmFsdWVzKHJlZ2lvbnMpOwogIAogICAgICB0aGlzLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlLWluaXRpYWxpemUgYWxsIG9mIHRoZSByZWdpb25zIGJ5IHVwZGF0aW5nIHRoZSBgZWxgIHRoYXQKICAgIC8vIHRoZXkgcG9pbnQgdG8KICAgIF9yZUluaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbihyZWdpb24pIHsKICAgICAgICByZWdpb24ucmVzZXQoKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLy8gRW5hYmxlIGVhc3kgb3ZlcnJpZGluZyBvZiB0aGUgZGVmYXVsdCBgUmVnaW9uTWFuYWdlcmAKICAgIC8vIGZvciBjdXN0b21pemVkIHJlZ2lvbiBpbnRlcmFjdGlvbnMgYW5kIGJ1c2luZXNzIHNwZWNpZmljCiAgICAvLyB2aWV3IGxvZ2ljIGZvciBiZXR0ZXIgY29udHJvbCBvdmVyIHNpbmdsZSByZWdpb25zLgogICAgZ2V0UmVnaW9uTWFuYWdlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICAvLyBhbmQgYWxsIHJlZ2lvbnMgaW4gaXQKICAgIF9pbml0UmVnaW9uTWFuYWdlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5yZWdpb25NYW5hZ2VyLCAnYWRkOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIHRoaXNbbmFtZV0gPSByZWdpb247CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdhZGQ6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgCgogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAKICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IChmdW5jdGlvbihfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgID0gXy5leHRlbmQoe30sIHRoaXMuZGVmYXVsdHMsIG9wdGlvbnMpOwogIAogICAgICAvLyBwcm94eSBiZWhhdmlvciAkIG1ldGhvZCB0byB0aGUgdmlldwogICAgICAvLyB0aGlzIGlzIHVzZWZ1bCBmb3IgZG9pbmcganF1ZXJ5IERPTSBsb29rdXBzCiAgICAgIC8vIHNjb3BlZCB0byBiZWhhdmlvcnMgdmlldy4KICAgICAgdGhpcy4kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKICAKICAgICAgLy8gc3RvcExpc3RlbmluZyB0byBiZWhhdmlvciBgb25MaXN0ZW5gIGV2ZW50cy4KICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogIAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogIAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgCiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfSkoXywgQmFja2JvbmUpOwogIAogIC8qIGpzaGludCBtYXhsZW46IDE0MyAqLwogIC8vIE1hcmlvbmV0dGUuQmVoYXZpb3JzCiAgLy8gLS0tLS0tLS0KICAKICAvLyBCZWhhdmlvcnMgaXMgYSB1dGlsaXR5IGNsYXNzIHRoYXQgdGFrZXMgY2FyZSBvZgogIC8vIGdsdWluZyB5b3VyIGJlaGF2aW9yIGluc3RhbmNlcyB0byB0aGVpciBnaXZlbiBWaWV3LgogIC8vIFRoZSBtb3N0IGltcG9ydGFudCBwYXJ0IG9mIHRoaXMgY2xhc3MgaXMgdGhhdCB5b3UKICAvLyAqKk1VU1QqKiBvdmVycmlkZSB0aGUgY2xhc3MgbGV2ZWwgYmVoYXZpb3JzTG9va3VwCiAgLy8gbWV0aG9kIGZvciB0aGluZ3MgdG8gd29yayBwcm9wZXJseS4KICAKICBNYXJpb25ldHRlLkJlaGF2aW9ycyA9IChmdW5jdGlvbihNYXJpb25ldHRlLCBfKSB7CiAgCiAgICBmdW5jdGlvbiBCZWhhdmlvcnModmlldywgYmVoYXZpb3JzKSB7CiAgCiAgICAgIGlmICghXy5pc09iamVjdCh2aWV3LmJlaGF2aW9ycykpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAKICAgICAgLy8gQmVoYXZpb3JzIGRlZmluZWQgb24gYSB2aWV3IGNhbiBiZSBhIGZsYXQgb2JqZWN0IGxpdGVyYWwKICAgICAgLy8gb3IgaXQgY2FuIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIG9iamVjdC4KICAgICAgYmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIGJlaGF2aW9ycyB8fCBfLnJlc3VsdCh2aWV3LCAnYmVoYXZpb3JzJykpOwogIAogICAgICAvLyBXcmFwcyBzZXZlcmFsIG9mIHRoZSB2aWV3J3MgbWV0aG9kcwogICAgICAvLyBjYWxsaW5nIHRoZSBtZXRob2RzIGZpcnN0IG9uIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gYW5kIHRoZW4gZXZlbnR1YWxseSBjYWxsaW5nIHRoZSBtZXRob2Qgb24gdGhlIHZpZXcuCiAgICAgIEJlaGF2aW9ycy53cmFwKHZpZXcsIGJlaGF2aW9ycywgXy5rZXlzKG1ldGhvZHMpKTsKICAgICAgcmV0dXJuIGJlaGF2aW9yczsKICAgIH0KICAKICAgIHZhciBtZXRob2RzID0gewogICAgICBiZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbihiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbihiZWhhdmlvckV2ZW50cywgYmVoYXZpb3JzKSB7CiAgICAgICAgdmFyIF9iZWhhdmlvcnNFdmVudHMgPSB7fTsKICAgICAgICB2YXIgdmlld1VJID0gXy5yZXN1bHQodGhpcywgJ3VpJyk7CiAgCiAgICAgICAgXy5lYWNoKGJlaGF2aW9ycywgZnVuY3Rpb24oYiwgaSkgewogICAgICAgICAgdmFyIF9ldmVudHMgPSB7fTsKICAgICAgICAgIHZhciBiZWhhdmlvckV2ZW50cyA9IF8uY2xvbmUoXy5yZXN1bHQoYiwgJ2V2ZW50cycpKSB8fCB7fTsKICAgICAgICAgIHZhciBiZWhhdmlvclVJID0gXy5yZXN1bHQoYiwgJ3VpJyk7CiAgCiAgICAgICAgICAvLyBDb25zdHJ1Y3QgYW4gaW50ZXJuYWwgVUkgaGFzaCBmaXJzdCB1c2luZwogICAgICAgICAgLy8gdGhlIHZpZXdzIFVJIGhhc2ggYW5kIHRoZW4gdGhlIGJlaGF2aW9ycyBVSSBoYXNoLgogICAgICAgICAgLy8gVGhpcyBhbGxvd3MgdGhlIHVzZXIgdG8gdXNlIFVJIGhhc2ggZWxlbWVudHMKICAgICAgICAgIC8vIGRlZmluZWQgaW4gdGhlIHBhcmVudCB2aWV3IGFzIHdlbGwgYXMgdGhvc2UKICAgICAgICAgIC8vIGRlZmluZWQgaW4gdGhlIGdpdmVuIGJlaGF2aW9yLgogICAgICAgICAgdmFyIHVpID0gXy5leHRlbmQoe30sIHZpZXdVSSwgYmVoYXZpb3JVSSk7CiAgCiAgICAgICAgICAvLyBOb3JtYWxpemUgYmVoYXZpb3IgZXZlbnRzIGhhc2ggdG8gYWxsb3cKICAgICAgICAgIC8vIGEgdXNlciB0byB1c2UgdGhlIEB1aS4gc3ludGF4LgogICAgICAgICAgYmVoYXZpb3JFdmVudHMgPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyhiZWhhdmlvckV2ZW50cywgdWkpOwogIAogICAgICAgICAgXy5lYWNoKF8ua2V5cyhiZWhhdmlvckV2ZW50cyksIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogIAogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSAobmV3IEFycmF5KGkgKyAyKSkuam9pbignICcpOwogICAgICAgICAgICB2YXIgZXZlbnRLZXkgICA9IGtleSArIHdoaXRlc3BhY2U7CiAgICAgICAgICAgIHZhciBoYW5kbGVyICAgID0gXy5pc0Z1bmN0aW9uKGJlaGF2aW9yRXZlbnRzW2tleV0pID8gYmVoYXZpb3JFdmVudHNba2V5XSA6IGJbYmVoYXZpb3JFdmVudHNba2V5XV07CiAgCiAgICAgICAgICAgIF9ldmVudHNbZXZlbnRLZXldID0gXy5iaW5kKGhhbmRsZXIsIGIpOwogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBfYmVoYXZpb3JzRXZlbnRzID0gXy5leHRlbmQoX2JlaGF2aW9yc0V2ZW50cywgX2V2ZW50cyk7CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmV0dXJuIF9iZWhhdmlvcnNFdmVudHM7CiAgICAgIH0KICAgIH07CiAgCiAgICBfLmV4dGVuZChCZWhhdmlvcnMsIHsKICAKICAgICAgLy8gUGxhY2Vob2xkZXIgbWV0aG9kIHRvIGJlIGV4dGVuZGVkIGJ5IHRoZSB1c2VyLgogICAgICAvLyBUaGUgbWV0aG9kIHNob3VsZCBkZWZpbmUgdGhlIG9iamVjdCB0aGF0IHN0b3JlcyB0aGUgYmVoYXZpb3JzLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGBgYGpzCiAgICAgIC8vIE1hcmlvbmV0dGUuQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vICAgcmV0dXJuIEFwcC5CZWhhdmlvcnMKICAgICAgLy8gfQogICAgICAvLyBgYGAKICAgICAgYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogIAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24ob3B0aW9ucywga2V5KSB7CiAgICAgICAgaWYgKG9wdGlvbnMuYmVoYXZpb3JDbGFzcykgewogICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYmVoYXZpb3JDbGFzczsKICAgICAgICB9CiAgCiAgICAgICAgLy8gR2V0IGJlaGF2aW9yIGNsYXNzIGNhbiBiZSBlaXRoZXIgYSBmbGF0IG9iamVjdCBvciBhIG1ldGhvZAogICAgICAgIHJldHVybiBfLmlzRnVuY3Rpb24oQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cCkgPyBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cylba2V5XSA6IEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXBba2V5XTsKICAgICAgfSwKICAKICAgICAgLy8gSXRlcmF0ZSBvdmVyIHRoZSBiZWhhdmlvcnMgb2JqZWN0LCBmb3IgZWFjaCBiZWhhdmlvcgogICAgICAvLyBpbnN0YW50aWF0ZSBpdCBhbmQgZ2V0IGl0cyBncm91cGVkIGJlaGF2aW9ycy4KICAgICAgcGFyc2VCZWhhdmlvcnM6IGZ1bmN0aW9uKHZpZXcsIGJlaGF2aW9ycykgewogICAgICAgIHJldHVybiBfLmNoYWluKGJlaGF2aW9ycykubWFwKGZ1bmN0aW9uKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogIAogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogIAogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbih2aWV3LCBiZWhhdmlvcnMsIG1ldGhvZE5hbWVzKSB7CiAgICAgICAgXy5lYWNoKG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgICB2aWV3W21ldGhvZE5hbWVdID0gXy5wYXJ0aWFsKG1ldGhvZHNbbWV0aG9kTmFtZV0sIHZpZXdbbWV0aG9kTmFtZV0sIGJlaGF2aW9ycyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIAogICAgLy8gQ2xhc3MgdG8gYnVpbGQgaGFuZGxlcnMgZm9yIGB0cmlnZ2Vyc2Agb24gYmVoYXZpb3JzCiAgICAvLyBmb3Igdmlld3MKICAgIGZ1bmN0aW9uIEJlaGF2aW9yVHJpZ2dlcnNCdWlsZGVyKHZpZXcsIGJlaGF2aW9ycykgewogICAgICB0aGlzLl92aWV3ICAgICAgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgICAgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyAgPSB7fTsKICAgIH0KICAKICAgIF8uZXh0ZW5kKEJlaGF2aW9yVHJpZ2dlcnNCdWlsZGVyLnByb3RvdHlwZSwgewogICAgICAvLyBNYWluIG1ldGhvZCB0byBidWlsZCB0aGUgdHJpZ2dlcnMgaGFzaCB3aXRoIGV2ZW50IGtleXMgYW5kIGhhbmRsZXJzCiAgICAgIGJ1aWxkQmVoYXZpb3JUcmlnZ2VyczogZnVuY3Rpb24oKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogIAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uKGJlaGF2aW9yLCBpKSB7CiAgICAgICAgdmFyIHVpID0gXy5leHRlbmQoe30sIHRoaXMuX3ZpZXdVSSwgXy5yZXN1bHQoYmVoYXZpb3IsICd1aScpKTsKICAgICAgICB2YXIgdHJpZ2dlcnNIYXNoID0gXy5jbG9uZShfLnJlc3VsdChiZWhhdmlvciwgJ3RyaWdnZXJzJykpIHx8IHt9OwogIAogICAgICAgIHRyaWdnZXJzSGFzaCA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKHRyaWdnZXJzSGFzaCwgdWkpOwogIAogICAgICAgIF8uZWFjaCh0cmlnZ2Vyc0hhc2gsIF8ucGFydGlhbCh0aGlzLl9zZXRIYW5kbGVyRm9yQmVoYXZpb3IsIGJlaGF2aW9yLCBpKSwgdGhpcyk7CiAgICAgIH0sCiAgCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBjcmVhdGUgYW5kIGFzc2lnbiB0aGUgdHJpZ2dlciBoYW5kbGVyIGZvciBhIGdpdmVuCiAgICAgIC8vIGJlaGF2aW9yCiAgICAgIF9zZXRIYW5kbGVyRm9yQmVoYXZpb3I6IGZ1bmN0aW9uKGJlaGF2aW9yLCBpLCBldmVudE5hbWUsIHRyaWdnZXIpIHsKICAgICAgICAvLyBVbmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIGB0aGlzLl90cmlnZ2Vyc2AgaGFzaAogICAgICAgIHZhciB0cmlnZ2VyS2V5ID0gdHJpZ2dlci5yZXBsYWNlKC9eXFMrLywgZnVuY3Rpb24odHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgCiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIEJlaGF2aW9yczsKICAKICB9KShNYXJpb25ldHRlLCBfKTsKICAKCiAgLy8gQXBwUm91dGVyCiAgLy8gLS0tLS0tLS0tCiAgCiAgLy8gUmVkdWNlIHRoZSBib2lsZXJwbGF0ZSBjb2RlIG9mIGhhbmRsaW5nIHJvdXRlIGV2ZW50cwogIC8vIGFuZCB0aGVuIGNhbGxpbmcgYSBzaW5nbGUgbWV0aG9kIG9uIGFub3RoZXIgb2JqZWN0LgogIC8vIEhhdmUgeW91ciByb3V0ZXJzIGNvbmZpZ3VyZWQgdG8gY2FsbCB0aGUgbWV0aG9kIG9uCiAgLy8geW91ciBvYmplY3QsIGRpcmVjdGx5LgogIC8vCiAgLy8gQ29uZmlndXJlIGFuIEFwcFJvdXRlciB3aXRoIGBhcHBSb3V0ZXNgLgogIC8vCiAgLy8gQXBwIHJvdXRlcnMgY2FuIG9ubHkgdGFrZSBvbmUgYGNvbnRyb2xsZXJgIG9iamVjdC4KICAvLyBJdCBpcyByZWNvbW1lbmRlZCB0aGF0IHlvdSBkaXZpZGUgeW91ciBjb250cm9sbGVyCiAgLy8gb2JqZWN0cyBpbiB0byBzbWFsbGVyIHBpZWNlcyBvZiByZWxhdGVkIGZ1bmN0aW9uYWxpdHkKICAvLyBhbmQgaGF2ZSBtdWx0aXBsZSByb3V0ZXJzIC8gY29udHJvbGxlcnMsIGluc3RlYWQgb2YKICAvLyBqdXN0IG9uZSBnaWFudCByb3V0ZXIgYW5kIGNvbnRyb2xsZXIuCiAgLy8KICAvLyBZb3UgY2FuIGFsc28gYWRkIHN0YW5kYXJkIHJvdXRlcyB0byBhbiBBcHBSb3V0ZXIuCiAgCiAgTWFyaW9uZXR0ZS5BcHBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLlJvdXRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgICB2YXIgYXBwUm91dGVzID0gdGhpcy5nZXRPcHRpb24oJ2FwcFJvdXRlcycpOwogICAgICB2YXIgY29udHJvbGxlciA9IHRoaXMuX2dldENvbnRyb2xsZXIoKTsKICAgICAgdGhpcy5wcm9jZXNzQXBwUm91dGVzKGNvbnRyb2xsZXIsIGFwcFJvdXRlcyk7CiAgICAgIHRoaXMub24oJ3JvdXRlJywgdGhpcy5fcHJvY2Vzc09uUm91dGUsIHRoaXMpOwogICAgfSwKICAKICAgIC8vIFNpbWlsYXIgdG8gcm91dGUgbWV0aG9kIG9uIGEgQmFja2JvbmUgUm91dGVyIGJ1dAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCBvbiB0aGUgY29udHJvbGxlcgogICAgYXBwUm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogIAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24ocm91dGVOYW1lLCByb3V0ZUFyZ3MpIHsKICAgICAgLy8gZmluZCB0aGUgcGF0aCB0aGF0IG1hdGNoZWQKICAgICAgdmFyIHJvdXRlUGF0aCA9IF8uaW52ZXJ0KHRoaXMuZ2V0T3B0aW9uKCdhcHBSb3V0ZXMnKSlbcm91dGVOYW1lXTsKICAKICAgICAgLy8gbWFrZSBzdXJlIGFuIG9uUm91dGUgaXMgdGhlcmUsIGFuZCBjYWxsIGl0CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5vblJvdXRlKSkgewogICAgICAgIHRoaXMub25Sb3V0ZShyb3V0ZU5hbWUsIHJvdXRlUGF0aCwgcm91dGVBcmdzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBwcm9jZXNzIHRoZSBgYXBwUm91dGVzYCBmb3IgdGhlCiAgICAvLyByb3V0ZXIsIGFuZCB0dXJuIHRoZW0gaW4gdG8gcm91dGVzIHRoYXQgdHJpZ2dlciB0aGUKICAgIC8vIHNwZWNpZmllZCBtZXRob2Qgb24gdGhlIHNwZWNpZmllZCBgY29udHJvbGxlcmAuCiAgICBwcm9jZXNzQXBwUm91dGVzOiBmdW5jdGlvbihjb250cm9sbGVyLCBhcHBSb3V0ZXMpIHsKICAgICAgaWYgKCFhcHBSb3V0ZXMpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHZhciByb3V0ZU5hbWVzID0gXy5rZXlzKGFwcFJvdXRlcykucmV2ZXJzZSgpOyAvLyBCYWNrYm9uZSByZXF1aXJlcyByZXZlcnRlZCBvcmRlciBvZiByb3V0ZXMKICAKICAgICAgXy5lYWNoKHJvdXRlTmFtZXMsIGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgICAgdGhpcy5fYWRkQXBwUm91dGUoY29udHJvbGxlciwgcm91dGUsIGFwcFJvdXRlc1tyb3V0ZV0pOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgCiAgICBfZ2V0Q29udHJvbGxlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24oY29udHJvbGxlciwgcm91dGUsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIG1ldGhvZCA9IGNvbnRyb2xsZXJbbWV0aG9kTmFtZV07CiAgCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ01ldGhvZCAiJyArIG1ldGhvZE5hbWUgKyAnIiB3YXMgbm90IGZvdW5kIG9uIHRoZSBjb250cm9sbGVyJyk7CiAgICAgIH0KICAKICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgbWV0aG9kTmFtZSwgXy5iaW5kKG1ldGhvZCwgY29udHJvbGxlcikpOwogICAgfSwKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uCiAgfSk7CiAgCiAgLy8gQXBwbGljYXRpb24KICAvLyAtLS0tLS0tLS0tLQogIAogIC8vIENvbnRhaW4gYW5kIG1hbmFnZSB0aGUgY29tcG9zaXRlIGFwcGxpY2F0aW9uIGFzIGEgd2hvbGUuCiAgLy8gU3RvcmVzIGFuZCBzdGFydHMgdXAgYFJlZ2lvbmAgb2JqZWN0cywgaW5jbHVkZXMgYW4KICAvLyBldmVudCBhZ2dyZWdhdG9yIGFzIGBhcHAudmVudGAKICBNYXJpb25ldHRlLkFwcGxpY2F0aW9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgIHRoaXMuX2luaXRDaGFubmVsKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuQXBwbGljYXRpb24ucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9LAogIAogICAgLy8gQ29tbWFuZCBleGVjdXRpb24sIGZhY2lsaXRhdGVkIGJ5IEJhY2tib25lLldyZXFyLkNvbW1hbmRzCiAgICBleGVjdXRlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxcmVzLnJlcXVlc3QuYXBwbHkodGhpcy5yZXFyZXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gQWRkIGFuIGluaXRpYWxpemVyIHRoYXQgaXMgZWl0aGVyIHJ1biBhdCB3aGVuIHRoZSBgc3RhcnRgCiAgICAvLyBtZXRob2QgaXMgY2FsbGVkLCBvciBydW4gaW1tZWRpYXRlbHkgaWYgYWRkZWQgYWZ0ZXIgYHN0YXJ0YAogICAgLy8gaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQuCiAgICBhZGRJbml0aWFsaXplcjogZnVuY3Rpb24oaW5pdGlhbGl6ZXIpIHsKICAgICAgdGhpcy5faW5pdENhbGxiYWNrcy5hZGQoaW5pdGlhbGl6ZXIpOwogICAgfSwKICAKICAgIC8vIGtpY2sgb2ZmIGFsbCBvZiB0aGUgYXBwbGljYXRpb24ncyBwcm9jZXNzZXMuCiAgICAvLyBpbml0aWFsaXplcyBhbGwgb2YgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gYWRkZWQKICAgIC8vIHRvIHRoZSBhcHAsIGFuZCBydW5zIGFsbCBvZiB0aGUgaW5pdGlhbGl6ZXIgZnVuY3Rpb25zCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uKHJlZ2lvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgCiAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgYXBwLCB3aXRob3V0IHJlbW92aW5nIHRoZW0KICAgIGVtcHR5UmVnaW9uczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZXMgYSByZWdpb24gZnJvbSB5b3VyIGFwcCwgYnkgbmFtZQogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9ucyBuYW1lCiAgICAvLyByZW1vdmVSZWdpb24oJ215UmVnaW9uJykKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24ocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24ocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldChyZWdpb24pOwogICAgfSwKICAKICAgIC8vIEdldCBhbGwgdGhlIHJlZ2lvbnMgZnJvbSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbihtb2R1bGVOYW1lcywgbW9kdWxlRGVmaW5pdGlvbikgewogIAogICAgICAvLyBPdmVyd3JpdGUgdGhlIG1vZHVsZSBjbGFzcyBpZiB0aGUgdXNlciBzcGVjaWZpZXMgb25lCiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IE1hcmlvbmV0dGUuTW9kdWxlLmdldENsYXNzKG1vZHVsZURlZmluaXRpb24pOwogIAogICAgICAvLyBzbGljZSB0aGUgYXJncywgYW5kIGFkZCB0aGlzIGFwcGxpY2F0aW9uIG9iamVjdCBhcyB0aGUKICAgICAgLy8gZmlyc3QgYXJndW1lbnQgb2YgdGhlIGFycmF5CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcyk7CiAgCiAgICAgIC8vIHNlZSB0aGUgTWFyaW9uZXR0ZS5Nb2R1bGUgb2JqZWN0IGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgIHJldHVybiBNb2R1bGVDbGFzcy5jcmVhdGUuYXBwbHkoTW9kdWxlQ2xhc3MsIGFyZ3MpOwogICAgfSwKICAKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcy1zcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IE1hcmlvbmV0dGUuUmVnaW9uTWFuYWdlcigpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHRoZSByZWdpb25zIHRoYXQgaGF2ZSBiZWVuIGRlZmluZWQgaW4gYQogICAgLy8gYHJlZ2lvbnNgIGF0dHJpYnV0ZSBvbiB0aGUgYXBwbGljYXRpb24gaW5zdGFuY2UKICAgIF9pbml0aWFsaXplUmVnaW9uczogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogIAogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgCiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgCiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fcmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuX3JlZ2lvbk1hbmFnZXIsICdiZWZvcmU6YWRkOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuX3JlZ2lvbk1hbmFnZXIsICdhZGQ6cmVnaW9uJywgZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAncmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXR1cCB0aGUgV3JlcXIucmFkaW8gY2hhbm5lbAogICAgX2luaXRDaGFubmVsOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIAogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbihtb2R1bGVOYW1lLCBhcHAsIG9wdGlvbnMpIHsKICAgIHRoaXMubW9kdWxlTmFtZSA9IG1vZHVsZU5hbWU7CiAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgIC8vIEFsbG93IGZvciBhIHVzZXIgdG8gb3ZlcmlkZSB0aGUgaW5pdGlhbGl6ZQogICAgLy8gZm9yIGEgZ2l2ZW4gbW9kdWxlIGluc3RhbmNlLgogICAgdGhpcy5pbml0aWFsaXplID0gb3B0aW9ucy5pbml0aWFsaXplIHx8IHRoaXMuaW5pdGlhbGl6ZTsKICAKICAgIC8vIFNldCB1cCBhbiBpbnRlcm5hbCBzdG9yZSBmb3Igc3ViLW1vZHVsZXMuCiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAKICAgIHRoaXMuX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVycygpOwogIAogICAgLy8gU2V0IGFuIGludGVybmFsIHJlZmVyZW5jZSB0byB0aGUgYXBwCiAgICAvLyB3aXRoaW4gYSBtb2R1bGUuCiAgICB0aGlzLmFwcCA9IGFwcDsKICAKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICB0aGlzLmluaXRpYWxpemUobW9kdWxlTmFtZSwgYXBwLCB0aGlzLm9wdGlvbnMpOwogICAgfQogIH07CiAgCiAgTWFyaW9uZXR0ZS5Nb2R1bGUuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgCiAgLy8gRXh0ZW5kIHRoZSBNb2R1bGUgcHJvdG90eXBlIHdpdGggZXZlbnRzIC8gbGlzdGVuVG8sIHNvIHRoYXQgdGhlIG1vZHVsZQogIC8vIGNhbiBiZSB1c2VkIGFzIGFuIGV2ZW50IGFnZ3JlZ2F0b3Igb3IgcHViL3N1Yi4KICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogIAogICAgLy8gQnkgZGVmYXVsdCBtb2R1bGVzIHN0YXJ0IHdpdGggdGhlaXIgcGFyZW50cy4KICAgIHN0YXJ0V2l0aFBhcmVudDogdHJ1ZSwKICAKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMgd2hlbiBleHRlbmRpbmcgTWFyaW9uZXR0ZS5Nb2R1bGUuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9LAogIAogICAgLy8gSW5pdGlhbGl6ZXIgZm9yIGEgc3BlY2lmaWMgbW9kdWxlLiBJbml0aWFsaXplcnMgYXJlIHJ1biB3aGVuIHRoZQogICAgLy8gbW9kdWxlJ3MgYHN0YXJ0YCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLmFkZChjYWxsYmFjayk7CiAgICB9LAogIAogICAgLy8gRmluYWxpemVycyBhcmUgcnVuIHdoZW4gYSBtb2R1bGUgaXMgc3RvcHBlZC4gVGhleSBhcmUgdXNlZCB0byB0ZWFyZG93bgogICAgLy8gYW5kIGZpbmFsaXplIGFueSB2YXJpYWJsZXMsIHJlZmVyZW5jZXMsIGV2ZW50cyBhbmQgb3RoZXIgY29kZSB0aGF0IHRoZQogICAgLy8gbW9kdWxlIGhhZCBzZXQgdXAuCiAgICBhZGRGaW5hbGl6ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIC8vIFByZXZlbnQgcmUtc3RhcnRpbmcgYSBtb2R1bGUgdGhhdCBpcyBhbHJlYWR5IHN0YXJ0ZWQKICAgICAgaWYgKHRoaXMuX2lzSW5pdGlhbGl6ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbihtb2QpIHsKICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgd2Ugc2hvdWxkIHN0YXJ0IHRoZSBzdWItbW9kdWxlIHdpdGggdGhpcyBwYXJlbnQKICAgICAgICBpZiAobW9kLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIC8vIHJ1biB0aGUgY2FsbGJhY2tzIHRvICJzdGFydCIgdGhlIGN1cnJlbnQgbW9kdWxlCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0YXJ0Jywgb3B0aW9ucyk7CiAgCiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy5faXNJbml0aWFsaXplZCA9IHRydWU7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc3RhcnQnLCBvcHRpb25zKTsKICAgIH0sCiAgCiAgICAvLyBTdG9wIHRoaXMgbW9kdWxlIGJ5IHJ1bm5pbmcgaXRzIGZpbmFsaXplcnMgYW5kIHRoZW4gc3RvcCBhbGwgb2YKICAgIC8vIHRoZSBzdWItbW9kdWxlcyBmb3IgdGhpcyBtb2R1bGUKICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAvLyBpZiB3ZSBhcmUgbm90IGluaXRpYWxpemVkLCBkb24ndCBib3RoZXIgZmluYWxpemluZwogICAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHsgcmV0dXJuOyB9CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3RvcCcpOwogIAogICAgICAvLyBzdG9wIHRoZSBzdWItbW9kdWxlczsgZGVwdGgtZmlyc3QsIHRvIG1ha2Ugc3VyZSB0aGUKICAgICAgLy8gc3ViLW1vZHVsZXMgYXJlIHN0b3BwZWQgLyBmaW5hbGl6ZWQgYmVmb3JlIHBhcmVudHMKICAgICAgXy5lYWNoKHRoaXMuc3VibW9kdWxlcywgZnVuY3Rpb24obW9kKSB7IG1vZC5zdG9wKCk7IH0pOwogIAogICAgICAvLyBydW4gdGhlIGZpbmFsaXplcnMKICAgICAgdGhpcy5fZmluYWxpemVyQ2FsbGJhY2tzLnJ1bih1bmRlZmluZWQsIHRoaXMpOwogIAogICAgICAvLyByZXNldCB0aGUgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLnJlc2V0KCk7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0b3AnKTsKICAgIH0sCiAgCiAgICAvLyBDb25maWd1cmUgdGhlIG1vZHVsZSB3aXRoIGEgZGVmaW5pdGlvbiBmdW5jdGlvbiBhbmQgYW55IGN1c3RvbSBhcmdzCiAgICAvLyB0aGF0IGFyZSB0byBiZSBwYXNzZWQgaW4gdG8gdGhlIGRlZmluaXRpb24gZnVuY3Rpb24KICAgIGFkZERlZmluaXRpb246IGZ1bmN0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpIHsKICAgICAgdGhpcy5fcnVuTW9kdWxlRGVmaW5pdGlvbihtb2R1bGVEZWZpbml0aW9uLCBjdXN0b21BcmdzKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2Q6IHJ1biB0aGUgbW9kdWxlIGRlZmluaXRpb24gZnVuY3Rpb24gd2l0aCB0aGUgY29ycmVjdAogICAgLy8gYXJndW1lbnRzCiAgICBfcnVuTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24oZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIGJ1aWxkIHRoZSBjb3JyZWN0IGxpc3Qgb2YgYXJndW1lbnRzIGZvciB0aGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgdmFyIGFyZ3MgPSBfLmZsYXR0ZW4oWwogICAgICAgIHRoaXMsCiAgICAgICAgdGhpcy5hcHAsCiAgICAgICAgQmFja2JvbmUsCiAgICAgICAgTWFyaW9uZXR0ZSwKICAgICAgICBCYWNrYm9uZS4kLCBfLAogICAgICAgIGN1c3RvbUFyZ3MKICAgICAgXSk7CiAgCiAgICAgIGRlZmluaXRpb24uYXBwbHkodGhpcywgYXJncyk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kOiBzZXQgdXAgbmV3IGNvcGllcyBvZiBpbml0aWFsaXplcnMgYW5kIGZpbmFsaXplcnMuCiAgICAvLyBDYWxsaW5nIHRoaXMgbWV0aG9kIHdpbGwgd2lwZSBvdXQgYWxsIGV4aXN0aW5nIGluaXRpYWxpemVycyBhbmQKICAgIC8vIGZpbmFsaXplcnMuCiAgICBfc2V0dXBJbml0aWFsaXplcnNBbmRGaW5hbGl6ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgICAgdGhpcy5fZmluYWxpemVyQ2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QKICB9KTsKICAKICAvLyBDbGFzcyBtZXRob2RzIHRvIGNyZWF0ZSBtb2R1bGVzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUsIHsKICAKICAgIC8vIENyZWF0ZSBhIG1vZHVsZSwgaGFuZ2luZyBvZmYgdGhlIGFwcCBwYXJhbWV0ZXIgYXMgdGhlIHBhcmVudCBvYmplY3QuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgCiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogIAogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24obW9kdWxlTmFtZSwgaSkgewogICAgICAgIHZhciBwYXJlbnRNb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgbW9kdWxlID0gdGhpcy5fZ2V0TW9kdWxlKHBhcmVudE1vZHVsZSwgbW9kdWxlTmFtZSwgYXBwLCBtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgICB0aGlzLl9hZGRNb2R1bGVEZWZpbml0aW9uKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBtb2R1bGVEZWZpbml0aW9uc1tpXSwgY3VzdG9tQXJncyk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICAvLyBSZXR1cm4gdGhlIGxhc3QgbW9kdWxlIGluIHRoZSBkZWZpbml0aW9uIGNoYWluCiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogIAogICAgX2dldE1vZHVsZTogZnVuY3Rpb24ocGFyZW50TW9kdWxlLCBtb2R1bGVOYW1lLCBhcHAsIGRlZiwgYXJncykgewogICAgICB2YXIgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBkZWYpOwogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSB0aGlzLmdldENsYXNzKGRlZik7CiAgCiAgICAgIC8vIEdldCBhbiBleGlzdGluZyBtb2R1bGUgb2YgdGhpcyBuYW1lIGlmIHdlIGhhdmUgb25lCiAgICAgIHZhciBtb2R1bGUgPSBwYXJlbnRNb2R1bGVbbW9kdWxlTmFtZV07CiAgCiAgICAgIGlmICghbW9kdWxlKSB7CiAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSBpZiB3ZSBkb24ndCBoYXZlIG9uZQogICAgICAgIG1vZHVsZSA9IG5ldyBNb2R1bGVDbGFzcyhtb2R1bGVOYW1lLCBhcHAsIG9wdGlvbnMpOwogICAgICAgIHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIG9uIHRoZSBwYXJlbnQKICAgICAgICBwYXJlbnRNb2R1bGUuc3VibW9kdWxlc1ttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgICAgfQogIAogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAKICAgIC8vICMjIE1vZHVsZSBDbGFzc2VzCiAgICAvLwogICAgLy8gTW9kdWxlIGNsYXNzZXMgY2FuIGJlIHVzZWQgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmluZSBwYXR0ZXJuLgogICAgLy8gVGhlIGV4dGVuZCBmdW5jdGlvbiBvZiBhIE1vZHVsZSBpcyBpZGVudGljYWwgdG8gdGhlIGV4dGVuZCBmdW5jdGlvbnMKICAgIC8vIG9uIG90aGVyIEJhY2tib25lIGFuZCBNYXJpb25ldHRlIGNsYXNzZXMuCiAgICAvLyBUaGlzIGFsbG93cyBtb2R1bGUgbGlmZWN5bGUgZXZlbnRzIGxpa2UgYG9uU3RhcnRgIGFuZCBgb25TdG9wYCB0byBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICBnZXRDbGFzczogZnVuY3Rpb24obW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgCiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgCiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24ocGFyZW50TW9kdWxlLCBtb2R1bGUsIGRlZiwgYXJncykgewogICAgICB2YXIgZm4gPSB0aGlzLl9nZXREZWZpbmUoZGVmKTsKICAgICAgdmFyIHN0YXJ0V2l0aFBhcmVudCA9IHRoaXMuX2dldFN0YXJ0V2l0aFBhcmVudChkZWYsIG1vZHVsZSk7CiAgCiAgICAgIGlmIChmbikgewogICAgICAgIG1vZHVsZS5hZGREZWZpbml0aW9uKGZuLCBhcmdzKTsKICAgICAgfQogIAogICAgICB0aGlzLl9hZGRTdGFydFdpdGhQYXJlbnQocGFyZW50TW9kdWxlLCBtb2R1bGUsIHN0YXJ0V2l0aFBhcmVudCk7CiAgICB9LAogIAogICAgX2dldFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24oZGVmLCBtb2R1bGUpIHsKICAgICAgdmFyIHN3cDsKICAKICAgICAgaWYgKF8uaXNGdW5jdGlvbihkZWYpICYmIChkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAKICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgX2dldERlZmluZTogZnVuY3Rpb24oZGVmKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZGVmKSAmJiAhKGRlZi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNYXJpb25ldHRlLk1vZHVsZSkpIHsKICAgICAgICByZXR1cm4gZGVmOwogICAgICB9CiAgCiAgICAgIGlmIChfLmlzT2JqZWN0KGRlZikpIHsKICAgICAgICByZXR1cm4gZGVmLmRlZmluZTsKICAgICAgfQogIAogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgCiAgICBfYWRkU3RhcnRXaXRoUGFyZW50OiBmdW5jdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgc3RhcnRXaXRoUGFyZW50KSB7CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgPSBtb2R1bGUuc3RhcnRXaXRoUGFyZW50ICYmIHN0YXJ0V2l0aFBhcmVudDsKICAKICAgICAgaWYgKCFtb2R1bGUuc3RhcnRXaXRoUGFyZW50IHx8ICEhbW9kdWxlLnN0YXJ0V2l0aFBhcmVudElzQ29uZmlndXJlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogIAogICAgICBtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkID0gdHJ1ZTsKICAKICAgICAgcGFyZW50TW9kdWxlLmFkZEluaXRpYWxpemVyKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgCgogIHJldHVybiBNYXJpb25ldHRlOwp9KSk7CgovKiEKICogVGFibGVsaW5nIHYwLjEuMQogKiBDb3B5cmlnaHQgKGMpIDIwMTItMjAxNCBTaW1vbiBPdWxldmF5IChBbHBoYSBIeWRyYWUpIDxoeWRyYWUuYWxwaGFAZ21haWwuY29tPgogKiBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQogKiBodHRwczovL2dpdGh1Yi5jb20vQWxwaGFIeWRyYWUvdGFibGVsaW5nCiAqLwpCYWNrYm9uZS5UYWJsZWxpbmcgPSBUYWJsZWxpbmcgPSAoZnVuY3Rpb24oQmFja2JvbmUsIF8sICQpewoKICB2YXIgVGFibGVsaW5nID0gewogICAgdmVyc2lvbiA6ICIwLjEuMSIKICB9OwoKLy8gVGFibGVsaW5nCi8vIC0tLS0tLS0tLQovLwovLyBBIHRhYmxlbGluZyB0YWJsZSBpcyBhIE1hcmlvbmV0dGUgbGF5b3V0IHdoaWNoIGZldGNoZXMgZGF0YQovLyBmcm9tIGEgQmFja2JvbmUgY29sbGVjdGlvbi4gSXQgaXMgY29udHJvbGxlZCB3aXRoIGFuIEV2ZW50QWdncmVnYXRvci4KVGFibGVsaW5nLlRhYmxlID0gQmFja2JvbmUuTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LmV4dGVuZCh7CgogIGNsYXNzTmFtZTogJ3RhYmxlbGluZycsCgogIC8vIERlZmF1bHQgdGFibGUgb3B0aW9ucyBjYW4gYmUgb3ZlcnJpZGVuIGJ5IHN1YmNsYXNzZXMuCiAgY29uZmlnOiB7CiAgICBwYWdlOiAxCiAgfSwKCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCF0aGlzLmdldENvbGxlY3Rpb24odGhpcy5nZXRSZXNvdXJjZSgpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgY29sbGVjdGlvbjsgcGFzcyBpdCB0byB0aGUgY29uc3RydWN0b3Igb3Igb3ZlcnJpZGUgI2dldENvbGxlY3Rpb24nKTsKICAgIH0KCiAgICAvLyBUYWJsZSBvcHRpb25zIGNhbiBhbHNvIGJlIG92ZXJyaWRlbiBmb3IgZWFjaCBpbnN0YW5jZSBhdCBjb25zdHJ1Y3Rpb24uCiAgICB0aGlzLmNvbmZpZyA9IF8uZXh0ZW5kKF8uY2xvbmUodGhpcy5jb25maWcgfHwge30pLCBfLnJlc3VsdChvcHRpb25zLCAnY29uZmlnJykgfHwge30pOwoKICAgIC8vIFdlIHVzZSBhbiBldmVudCBhZ2dyZWdhdG9yIHRvIG1hbmFnZSB0aGUgbGF5b3V0IGFuZCBpdHMgY29tcG9uZW50cy4KICAgIC8vIFlvdSBjYW4gdXNlIHlvdXIgb3duIGJ5IHBhc3NpbmcgYSBgdmVudGAgb3B0aW9uLgogICAgdGhpcy52ZW50ID0gb3B0aW9ucy52ZW50IHx8IG5ldyBCYWNrYm9uZS5XcmVxci5FdmVudEFnZ3JlZ2F0b3IoKTsKCiAgICB0aGlzLmZldGNoT3B0aW9ucyA9IF8uZXh0ZW5kKF8uY2xvbmUodGhpcy5mZXRjaE9wdGlvbnMgfHwge30pLCBfLnJlc3VsdChvcHRpb25zLCAnZmV0Y2hPcHRpb25zJykgfHwge30pOwoKICAgIGlmICh0eXBlb2Yob3B0aW9ucy5hdXRvVXBkYXRlKSAhPSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmF1dG9VcGRhdGUgPSBvcHRpb25zLmF1dG9VcGRhdGU7CiAgICB9CgogICAgaWYgKHR5cGVvZih0aGlzLmF1dG9VcGRhdGUpID09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMuYXV0b1VwZGF0ZSA9IHRydWU7CiAgICB9CgogICAgLy8gQ29tcG9uZW50cyBzaG91bGQgdHJpZ2dlciB0aGUgYHRhYmxlOnVwZGF0ZWAgZXZlbnQgdG8gdXBkYXRlCiAgICAvLyB0aGUgdGFibGUgKGUuZy4gY2hhbmdlIHBhZ2Ugc2l6ZSwgc29ydCkgYW5kIGZldGNoIHRoZSBuZXcgZGF0YS4KICAgIHRoaXMudmVudC5vbigndGFibGU6dXBkYXRlJywgdGhpcy5vblVwZGF0ZSwgdGhpcyk7CgogICAgdGhpcy5vbmNlKCdyZW5kZXInLCB0aGlzLnNldHVwLCB0aGlzKTsKCiAgICBpZiAodHlwZW9mKHRoaXMuaW5pdGlhbGl6ZVRhYmxlKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZVRhYmxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIC8vIENhbGxlZCBvbmNlIHJlbmRlcmluZyBpcyBjb21wbGV0ZS4gQnkgZGVmYXVsdCwgaXQgdXBkYXRlcyB0aGUgdGFibGUuCiAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgdGhpcy52ZW50VHJpZ2dlcigndGFibGU6c2V0dXAnLCB0aGlzLmNvbmZpZyk7CiAgICBpZiAodGhpcy5hdXRvVXBkYXRlKSB7CiAgICAgIHRoaXMudmVudFRyaWdnZXIoJ3RhYmxlOnVwZGF0ZScpOwogICAgfQogIH0sCgogIGdldFJlc291cmNlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb24gfHwgdGhpcy5tb2RlbDsKICB9LAoKICAvLyBTdWJjbGFzc2VzIG11c3QgcmV0dXJuIHRoZSBCYWNrYm9uZS5Db2xsZWN0aW9uIHVzZWQgdG8gZmV0Y2ggZGF0YS4KICBnZXRDb2xsZWN0aW9uOiBmdW5jdGlvbihyZXNvdXJjZSkgewogICAgcmV0dXJuIHRoaXMuY29sbGVjdGlvbjsKICB9LAoKICAvLyAjIyMgUmVmcmVzaGluZyB0aGUgdGFibGUKICB1cGRhdGU6IGZ1bmN0aW9uKGNvbmZpZywgb3B0aW9ucykgewogICAgdGhpcy52ZW50VHJpZ2dlcigndGFibGU6dXBkYXRlJywgY29uZmlnLCBvcHRpb25zKTsKICB9LAoKICBvblVwZGF0ZTogZnVuY3Rpb24oY29uZmlnLCBvcHRpb25zKSB7CgogICAgXy5lYWNoKGNvbmZpZyB8fCB7fSwgXy5iaW5kKHRoaXMudXBkYXRlVmFsdWUsIHRoaXMpKTsKCiAgICAvLyBTZXQgdGhlIGByZWZyZXNoYCBvcHRpb24gdG8gZmFsc2UgdG8gdXBkYXRlIHRoZSB0YWJsZSBjb25maWd1cmF0aW9uCiAgICAvLyB3aXRob3V0IHJlZnJlc2hpbmcuCiAgICBpZiAoIW9wdGlvbnMgfHwgdHlwZW9mKG9wdGlvbnMucmVmcmVzaCkgPT0gJ3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZWZyZXNoKSB7CiAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgfQogIH0sCgogIHVwZGF0ZVZhbHVlOiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICBpZiAodmFsdWUgJiYgdmFsdWUudG9TdHJpbmcoKS5sZW5ndGgpIHsKICAgICAgdGhpcy5jb25maWdba2V5XSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgLy8gQmxhbmsgdmFsdWVzIGFyZSBkZWxldGVkIHRvIGF2b2lkIHNlbmRpbmcgdGhlbSBpbiBhamF4IHJlcXVlc3RzLgogICAgICBkZWxldGUgdGhpcy5jb25maWdba2V5XTsKICAgIH0KICB9LAoKICByZWZyZXNoOiBmdW5jdGlvbigpIHsKCiAgICAvLyBZb3UgY2FuIHByb3ZpZGUgYGZldGNoT3B0aW9uc2AgdG8gYWRkIHByb3BlcnRpZXMgdG8gdGhlCiAgICAvLyBmZXRjaCByZXF1ZXN0LgogICAgLy8KICAgIC8vICAgICB2YXIgTXlUYWJsZSA9IFRhYmxlbGluZy5UYWJsZS5leHRlbmQoewogICAgLy8gICAgICAgZmV0Y2hPcHRpb25zOiB7CiAgICAvLyAgICAgICAgIHR5cGU6ICdQT1NUJyAvLyBmZXRjaCBkYXRhIHdpdGggUE9TVAogICAgLy8gICAgICAgfQogICAgLy8gICAgIH0pOwogICAgLy8KICAgIC8vICAgICAvLyBZb3UgY2FuIGFsc28gb3ZlcnJpZGUgZm9yIGVhY2ggaW5zdGFuY2UuCiAgICAvLyAgICAgbmV3IE15VGFibGUoewogICAgLy8gICAgICAgZmV0Y2hPcHRpb25zOiB7CiAgICAvLyAgICAgICAgIHR5cGU6ICdHRVQnCiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgfSk7CiAgICB2YXIgb3B0aW9ucyA9IF8uY2xvbmUodGhpcy5mZXRjaE9wdGlvbnMpOwogICAgb3B0aW9ucy5kYXRhID0gdGhpcy5yZXF1ZXN0RGF0YSgpOwogICAgb3B0aW9ucy5zdWNjZXNzID0gXy5iaW5kKHRoaXMucHJvY2Vzc1Jlc3BvbnNlLCB0aGlzKTsKICAgIG9wdGlvbnMucmVzZXQgPSB0cnVlOwoKICAgIC8vIGB0YWJsZTpyZWZyZXNoaW5nYCBpcyB0cmlnZ2VyZWQgZXZlcnkgdGltZSBuZXcgZGF0YSBpcyBiZWluZyBmZXRjaGVkLgogICAgLy8gVGhlIGZpcnN0IGFyZ3VtZW50IGlzIHRoZSByZXF1ZXN0IGRhdGEuCiAgICB0aGlzLnZlbnRUcmlnZ2VyKCd0YWJsZTpyZWZyZXNoaW5nJywgb3B0aW9ucy5kYXRhKTsKCiAgICB0aGlzLmdldFJlc291cmNlKCkuZmV0Y2gob3B0aW9ucyk7CiAgfSwKCiAgLy8gIyMjIFJlcXVlc3QKICByZXF1ZXN0RGF0YTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5jb25maWc7CiAgfSwKCiAgLy8gIyMjIFJlc3BvbnNlCiAgcHJvY2Vzc1Jlc3BvbnNlOiBmdW5jdGlvbihyZXNvdXJjZSwgcmVzcG9uc2UpIHsKCiAgICB0aGlzLmNvbmZpZy5sZW5ndGggPSB0aGlzLmdldENvbGxlY3Rpb24ocmVzb3VyY2UpLmxlbmd0aDsKCiAgICAvLyBUYWJsZWxpbmcgZXhwZWN0cyB0aGUgcmVzcG9uc2UgZnJvbSBhIGZldGNoIHRvIGhhdmUgYSBgdG90YWxgIHByb3BlcnR5CiAgICAvLyB3aGljaCBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIGl0ZW1zIChub3QganVzdCBpbiB0aGUgY3VycmVudCBwYWdlKS4KICAgIHRoaXMuY29uZmlnLnRvdGFsID0gcmVzcG9uc2UudG90YWw7CgogICAgLy8gVGhlIHNlcnZlciBtYXkgb3ZlcnJpZGUgdGhlIGBwYWdlYCBwcm9wZXJ0eSwgZm9yIGV4YW1wbGUgaWYgdGhlCiAgICAvLyByZXF1ZXN0ZWQgcGFnZSB3YXMgb3V0c2lkZSB0aGUgcmFuZ2Ugb2YgYXZhaWxhYmxlIHBhZ2VzLgogICAgaWYgKHJlc3BvbnNlLnBhZ2UpIHsKICAgICAgdGhpcy5jb25maWcucGFnZSA9IHJlc3BvbnNlLnBhZ2U7CiAgICB9CgogICAgLy8gYHRhYmxlbGluZzpyZWZyZXNoZWRgIGlzIHRyaWdnZXJlZCBhZnRlciBldmVyeSByZWZyZXNoLiBUaGUgZmlyc3QgYXJndW1lbnQKICAgIC8vIGlzIHRoZSBjdXJyZW50IHRhYmxlIGNvbmZpZ3VyYXRpb24gd2l0aCB0aGUgZm9sbG93aW5nIGFkZGl0aW9uYWwgbWV0YSBkYXRhOgogICAgLy8KICAgIC8vICogYHRvdGFsYCAtIHRoZSB0b3RhbCBudW1iZXIgb2YgaXRlbXMKICAgIC8vICogYGxlbmd0aGAgLSB0aGUgbnVtYmVyIG9mIGl0ZW1zIGluIHRoZSBjdXJyZW50IHBhZ2UKICAgIHRoaXMudmVudFRyaWdnZXIoJ3RhYmxlOnJlZnJlc2hlZCcsIHRoaXMuY29uZmlnKTsKICB9LAoKICAvLyBUcmlnZ2VycyBhbiBldmVudCBpbiB0aGUgZXZlbnQgYWdncmVnYXRvci4gSWYgYFRhYmxlbGluZy5kZWJ1Z2AgaXMgc2V0LCBpdCBhbHNvCiAgLy8gbG9ncyB0aGUgZXZlbnQgYW5kIGl0cyBhcmd1bWVudHMuCiAgdmVudFRyaWdnZXI6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIGlmIChUYWJsZWxpbmcuZGVidWcpIHsKICAgICAgY29uc29sZS5sb2coXy5maXJzdChhcmdzKSArICcgLSAnICsgSlNPTi5zdHJpbmdpZnkoYXJncy5zbGljZSgxKSkpOwogICAgfQoKICAgIHRoaXMudmVudC50cmlnZ2VyLmFwcGx5KHRoaXMudmVudCwgYXJncyk7CiAgfQp9KTsKCi8vIFRhYmxlbGluZy5Db2xsZWN0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vCi8vIFRhYmxlbGluZyBleHBlY3RzIGZldGNoIHJlc3BvbnNlcyB0byBoYXZlIGEgYHRvdGFsYCBwcm9wZXJ0eSBpbiBhZGRpdGlvbgovLyB0byB0aGUgbW9kZWwgZGF0YS4gWW91IGNhbiBleHRlbmQgdGhpcyBCYWNrYm9uZS5Db2xsZWN0aW9uIHN1YmNsYXNzIHdoaWNoCi8vIGV4cGVjdHMgdGhlIGZvbGxvd2luZyByZXNwb25zZSBmb3JtYXQ6Ci8vCi8vICAgICB7Ci8vICAgICAgICJ0b3RhbCI6IDEyLAovLyAgICAgICAiZGF0YSI6IFsKLy8gICAgICAgICB7IC8qIC4uLiBtb2RlbCBkYXRhIC4uLiAqLyB9LAovLyAgICAgICAgIHsgLyogLi4uIG1vZGVsIGRhdGEgLi4uICovIH0KLy8gICAgICAgXQovLyAgICAgfQpUYWJsZWxpbmcuQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKCiAgcGFyc2U6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICB9Cn0pOwoKLy8gSW1wbGVtZW50YXRpb25zCi8vIC0tLS0tLS0tLS0tLS0tLQovLwovLyA8YSBocmVmPSJ0YWJsZWxpbmcuYm9vdHN0cmFwLmh0bWwiPnRhYmxlbGluZy5ib290c3RyYXA8L2E+IHByb3ZpZGVzIHZpZXdzIHN0eWxlZAovLyB3aXRoIFtUd2l0dGVyIEJvb3RzdHJhcF0oaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvKSBjbGFzc2VzLgoKLy8gVGFibGVsaW5nLk1vZHVsYXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0KLy8KLy8gVGFibGVsaW5nIHN1YmNsYXNzIHdoaWNoIHNwbGl0cyBmdW5jdGlvbmFsaXR5IGludG8gKm1vZHVsZXMqCi8vIGFuZCBoYW5kbGVzIHJlbmRlcmluZy4KVGFibGVsaW5nLk1vZHVsYXIgPSBUYWJsZWxpbmcuVGFibGUuZXh0ZW5kKHsKCiAgLy8gVGhlIGxpc3Qgb2YgbW9kdWxlIG5hbWVzIG11c3QgYmUgc3BlY2lmaWVkIGJ5IHN1YmNsYXNzZXMuCiAgbW9kdWxlczogW10sCgogIC8vIE1vZHVsZXMgYXJlIHNldCB1cCBhZnRlciByZW5kZXJpbmcsIGJlZm9yZSByZWZyZXNoaW5nLgogIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICB0aGlzLm1vZHVsZVZpZXdzID0ge307CiAgICBfLmVhY2godGhpcy5tb2R1bGVzLCB0aGlzLnNldHVwTW9kdWxlLCB0aGlzKTsKCiAgICBUYWJsZWxpbmcuVGFibGUucHJvdG90eXBlLnNldHVwLmNhbGwodGhpcyk7CiAgfSwKCiAgLy8gIyMjIE1vZHVsZXMKICAvLyBFYWNoIG1vZHVsZSBpcyBpZGVudGlmaWVkIGJ5IGEgbmFtZSwgZm9yIGV4YW1wbGUgYHBhZ2VTaXplYC4KICBzZXR1cE1vZHVsZTogZnVuY3Rpb24obmFtZSkgewoKICAgIC8vIFRoZSBsYXlvdXQgbXVzdCBoYXZlIGEgcmVnaW9uIG5hbWVkIGFmdGVyIHRoZSBtb2R1bGUsIGUuZy4gYHBhZ2VTaXplUmVnaW9uYC4KICAgIHZhciByZWdpb24gPSBuYW1lICsgJ1JlZ2lvbic7CgogICAgLy8gSXQgbXVzdCBoYXZlIGEgdmlldyBjbGFzcywgZS5nLiBgcGFnZVNpemVWaWV3YCwgd2hpY2ggd2lsbCBiZSBzaG93biBpbnRvCiAgICAvLyB0aGUgcmVnaW9uLgogICAgdmFyIHZpZXdDbGFzcyA9IHRoaXNbbmFtZSArICdWaWV3J107CgogICAgLy8gV2hlbiBpbnN0YW50aWF0ZWQsIHRoZSB2aWV3IGNsYXNzIHdpbGwgYmUgcGFzc2VkIHRoZSBldmVudAogICAgLy8gYWdncmVnYXRvciBhcyB0aGUgYHZlbnRgIG9wdGlvbi4gQWRkaXRpb25hbCBvcHRpb25zIGNhbiBiZQogICAgLy8gZ2l2ZW4gbmFtZWQgYWZ0ZXIgdGhlIHZpZXcgY2xhc3MsIGUuZy4gYHBhZ2VTaXplVmlld09wdGlvbnNgLgogICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh0aGlzLmdldE1vZHVsZU9wdGlvbnMobmFtZSksIHsgdmVudDogdGhpcy52ZW50IH0pOwoKICAgIC8vIFRoZSBjb2xsZWN0aW9uIGlzIGFsc28gcGFzc2VkIHRvIHZpZXcgY2xhc3Nlcy4KICAgIF8uZGVmYXVsdHMob3B0aW9ucywgeyBjb2xsZWN0aW9uOiB0aGlzLmdldENvbGxlY3Rpb24odGhpcy5nZXRSZXNvdXJjZSgpKSB9KTsKCiAgICB2YXIgdmlldyA9IG5ldyB2aWV3Q2xhc3Mob3B0aW9ucyk7CgogICAgLy8gTW9kdWxlIHZpZXcgaW5zdGFuY2VzIGFyZSBzdG9yZWQgYnkgbmFtZSBpbiB0aGUgYG1vZHVsZVZpZXdzYCBwcm9wZXJ0eQogICAgLy8gZm9yIGZ1dHVyZSByZWZlcmVuY2UuCiAgICB0aGlzLm1vZHVsZVZpZXdzW25hbWVdID0gdmlldzsKCiAgICB0aGlzW3JlZ2lvbl0uc2hvdyh2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIC8vIEJ5IGRlZmF1bHQgdGhlIGNvbGxlY3Rpb24gaXMgdGhlIG9uZSBnaXZlbiBhdCBjb25zdHJ1Y3Rpb24uCiAgLy8gT3RoZXJ3aXNlLCBhIG1vZHVsYXIgdGFibGUgZXhwZWN0cyBhIGB0YWJsZWAgbW9kdWxlIHdoaWNoCiAgLy8gc2hvdWxkIGhhdmUgYSBjb2xsZWN0aW9uIChlLmcuIGEgTWFyaW9uZXR0ZSBDb21wb3NpdGVWaWV3IG9yCiAgLy8gQ29sbGVjdGlvblZpZXcpLiBJZiB5b3VyIHN1YmNsYXNzIGRvZXMgbm90IGhhdmUgZWl0aGVyLCBpdAogIC8vIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byByZXR1cm4gdGhlIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyB1c2VkIHRvIGZldGNoIHRhYmxlIGRhdGEuCiAgZ2V0Q29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9uIHx8ICh0aGlzLm1vZHVsZVZpZXdzICYmIHRoaXMubW9kdWxlVmlld3MudGFibGUgPyB0aGlzLm1vZHVsZVZpZXdzLnRhYmxlLmNvbGxlY3Rpb24gOiB1bmRlZmluZWQpOwogIH0sCgogIGdldE1vZHVsZU9wdGlvbnM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHJldHVybiBfLnJlc3VsdCh0aGlzLCBuYW1lICsgJ1ZpZXdPcHRpb25zJykgfHwge307CiAgfQp9KTsKCi8vICMjIyBFeGFtcGxlCi8vIFRoaXMgaXMgaG93IGEgYFBhZ2VTaXplVmlld2AgbW9kdWxlIG1pZ2h0IGJlIHJlZ2lzdGVyZWQgaW4gYSBzdWJjbGFzczoKLy8KLy8gICAgIHZhciBNeVRhYmxlID0gVGFibGVsaW5nLk1vZHVsYXIuZXh0ZW5kKHsKLy8KLy8gICAgICAgbW9kdWxlczogWyAncGFnZVNpemUnIF0sCi8vCi8vICAgICAgIHBhZ2VTaXplVmlldzogUGFnZVNpemVWaWV3LAovLyAgICAgICBwYWdlU2l6ZVZpZXdPcHRpb25zOiB7Ci8vICAgICAgICAgY2hpbGRWaWV3OiBQYWdlU2l6ZUl0ZW0KLy8gICAgICAgfSwKLy8KLy8gICAgICAgcmVnaW9uczogewovLyAgICAgICAgIHBhZ2VTaXplUmVnaW9uOiAnLnBhZ2VTaXplJwovLyAgICAgICB9Ci8vICAgICB9KTsKCi8vIFRhYmxlbGluZy5Nb2R1bGUKLy8gLS0tLS0tLS0tLS0tLS0tLQovLwovLyBBIG1vZHVsZSBpcyBhbiBpdGVtIHZpZXcgdGhhdCBpcyBhdXRvbWF0aWNhbGx5IGJvdW5kIHRvIHRoZSB0YWJsZSdzCi8vIGV2ZW50IGFnZ3JlZ2F0b3IuClRhYmxlbGluZy5Nb2R1bGUgPSBCYWNrYm9uZS5NYXJpb25ldHRlLkl0ZW1WaWV3LmV4dGVuZCh7CgogIGkxOG46IHt9LAogIHRlbXBsYXRlSGVscGVyczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5pMThuOwogIH0sCgogIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCiAgICB0aGlzLnZlbnQgPSBvcHRpb25zLnZlbnQ7CgogICAgLy8gVGhlIGBzZXR1cGAgbWV0aG9kIG9mIHRoZSB2aWV3IGlzIGNhbGxlZCB3aGVuIHRoZSB0YWJsZQogICAgLy8gaXMgZmlyc3Qgc2V0IHVwLgogICAgdGhpcy52ZW50Lm9uKCd0YWJsZTpzZXR1cCcsIHRoaXMuc2V0dXAsIHRoaXMpOwoKICAgIC8vIFRoZSBgcmVmcmVzaGAgbWV0aG9kIG9mIHRoZSB2aWV3IGlzIGNhbGxlZCBldmVyeSB0aW1lIHRoZSB0YWJsZQogICAgLy8gaXMgcmVmcmVzaGVkLgogICAgdGhpcy52ZW50Lm9uKCd0YWJsZTpyZWZyZXNoZWQnLCB0aGlzLnJlZnJlc2gsIHRoaXMpOwoKICAgIHRoaXMuaTE4biA9IF8uY2xvbmUob3B0aW9ucy5pMThuIHx8IHRoaXMuaTE4bik7CgogICAgaWYgKHR5cGVvZih0aGlzLmluaXRpYWxpemVNb2R1bGUpID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5pbml0aWFsaXplTW9kdWxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIC8vIENhbGwgYHVwZGF0ZWAgdG8gdHJpZ2dlciBhbiB1cGRhdGUgb2YgdGhlIHRhYmxlLgogIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgdGhpcy5jb25maWcoKSk7CiAgfSwKCiAgLy8gSW1wbGVtZW50YXRpb25zIHNob3VsZCBvdmVycmlkZSB0aGlzIHRvIHNldCBpbml0aWFsIHZhbHVlcy4KICBzZXR1cDogZnVuY3Rpb24oY29uZmlnKSB7CiAgfSwKCiAgLy8gSW1wbGVtZW50YXRpb25zIHNob3VsZCBvdmVycmlkZSB0aGlzIHRvIHN0YXkgdXAgdG8gZGF0ZSB3aXRoCiAgLy8gdGhlIHRhYmxlIHN0YXRlLgogIHJlZnJlc2g6IGZ1bmN0aW9uKGNvbmZpZykgewogIH0sCgogIC8vIE5ldyB0YWJsZSBjb25maWd1cmF0aW9uIHRvIGJlIHNlbnQgb24gdXBkYXRlcy4gRm9yIGV4YW1wbGUsCiAgLy8gYSBwYWdlIHNpemUgdmlldyBtaWdodCB1cGRhdGUgdGhlIGBwYWdlU2l6ZWAgcHJvcGVydHkuCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7fTsKICB9Cn0pOwoKLy8gVGFibGVsaW5nLkZpZWxkTW9kdWxlCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLwovLyBBIGJhc2ljIG1vZHVsZSB3aXRoIGEgc2luZ2xlIGZvcm0gZmllbGQuIEl0IGNvbWVzIHdpdGggc2Vuc2libGUKLy8gZGVmYXVsdHMgYW5kIG9ubHkgcmVxdWlyZXMgYSBgbmFtZWAgYW5kIGEgYHRlbXBsYXRlYCBwYXJhbWV0ZXIuClRhYmxlbGluZy5GaWVsZE1vZHVsZSA9IFRhYmxlbGluZy5Nb2R1bGUuZXh0ZW5kKHsKCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgaWYgKCFfLmlzU3RyaW5nKHRoaXMubmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYWJsZWxpbmcgbW9kdWxlIG11c3QgaGF2ZSBhIG5hbWUgcHJvcGVydHkuIik7CiAgICB9CgogICAgaWYgKCF0aGlzLnVpKSB7CiAgICAgIHRoaXMudWkgPSB7fTsKICAgIH0KICAgIC8vIFRoZSBuYW1lIGF0dHJpYnV0ZSBvZiB0aGUgZm9ybSBmaWVsZCBpcyB0aGUgc2FtZSBhcyB0aGUKICAgIC8vIG1vZHVsZSdzLCBlLmcuIGBwYWdlU2l6ZWAuCiAgICB0aGlzLnVpLmZpZWxkID0gJ1tuYW1lPSInICsgdGhpcy5uYW1lICsgJyJdJzsKCiAgICBpZiAoIXRoaXMuZXZlbnRzKSB7CiAgICAgIHRoaXMuZXZlbnRzID0ge307CiAgICB9CiAgICB0aGlzLmV2ZW50cy5zdWJtaXQgPSAnb25TdWJtaXQnOwogICAgdGhpcy5ldmVudHNbJ2NoYW5nZSBbbmFtZT0iJyArIHRoaXMubmFtZSArICciXSddID0gJ3VwZGF0ZSc7CgogICAgVGFibGVsaW5nLk1vZHVsZS5wcm90b3R5cGUuaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIH0sCgogIHNldHVwOiBmdW5jdGlvbihjb25maWcpIHsKICAgIHRoaXMuc2V0dXBWYWx1ZShjb25maWdbdGhpcy5uYW1lXSk7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgdGhpcy5jb25maWcoKSwgeyByZWZyZXNoOiBmYWxzZSB9KTsKICB9LAoKICBzZXR1cFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdGhpcy51aS5maWVsZC52YWwodmFsdWUpOwogIH0sCgogIC8vIFRoZSB0YWJsZSBwcm9wZXJ0eSB1cGRhdGVkIGlzIHRoZSBvbmUgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIHRoZSBtb2R1bGUuCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHZhciBjb25maWcgPSB7fTsKICAgIGNvbmZpZ1t0aGlzLm5hbWVdID0gdGhpcy51aS5maWVsZC52YWwoKTsKICAgIHJldHVybiBjb25maWc7CiAgfSwKCiAgb25TdWJtaXQ6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0pOwoKLy8gVGhpcyBpcyBob3cgYSBgUGFnZVNpemVWaWV3YCBtb2R1bGUgbWlnaHQgYmUgaW1wbGVtZW50ZWQ6Ci8vCi8vICAgICB2YXIgaHRtbCA9ICc8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0icGFnZVNpemUiIC8+JzsKLy8KLy8gICAgIHZhciBQYWdlU2l6ZVZpZXcgPSBUYWJsZWxpbmcuRmllbGRNb2R1bGUuZXh0ZW5kKHsKLy8gICAgICAgICBuYW1lOiAncGFnZVNpemUnCi8vICAgICAgICAgdGVtcGxhdGU6IF8udGVtcGxhdGUoaHRtbCkKLy8gICAgIH0pOwovLwovLyBXaGVuIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQgZmllbGQgY2hhbmdlcywgdGhlIGV2ZW50IGFnZ3JlZ2F0b3Igd2lsbAovLyByZWNlaXZlIGEgYHRhYmxlbGluZzp1cGRhdGVgIGV2ZW50IHdpdGggdGhlIGBwYWdlU2l6ZWAgcHJvcGVydHkgc2V0Ci8vIHRvIHRoYXQgdmFsdWUuCgpUYWJsZWxpbmcuUGxhaW4gPSB7fTsKClRhYmxlbGluZy5QbGFpbi5UYWJsZSA9IFRhYmxlbGluZy5Nb2R1bGFyLmV4dGVuZCh7CgogIGNsYXNzTmFtZTogJ3RhYmxlbGluZycsCiAgbW9kdWxlczogWyAndGFibGUnLCAncGFnZVNpemUnLCAncXVpY2tTZWFyY2gnLCAnaW5mbycsICdwYWdlJyBdLAogIHRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPSJoZWFkZXIiPjxkaXYgY2xhc3M9InBhZ2VTaXplIiAvPjxkaXYgY2xhc3M9InF1aWNrU2VhcmNoIiAvPjwvZGl2PjxkaXYgY2xhc3M9InRhYmxlIiAvPjxkaXYgY2xhc3M9ImZvb3RlciI+PGRpdiBjbGFzcz0iaW5mbyIgLz48ZGl2IGNsYXNzPSJwYWdlIiAvPjwvZGl2PicpLAoKICByZWdpb25zOiB7CiAgICB0YWJsZVJlZ2lvbjogJy50YWJsZScsCiAgICBwYWdlU2l6ZVJlZ2lvbjogJy5wYWdlU2l6ZScsCiAgICBxdWlja1NlYXJjaFJlZ2lvbjogJy5xdWlja1NlYXJjaCcsCiAgICBpbmZvUmVnaW9uOiAnLmluZm8nLAogICAgcGFnZVJlZ2lvbjogJy5wYWdlJwogIH0KfSk7CgovLyBUT0RPOiBtYWtlIHRhYmxlIHZpZXcgYSBtb2R1bGUKVGFibGVsaW5nLlBsYWluLlRhYmxlVmlldyA9IEJhY2tib25lLk1hcmlvbmV0dGUuQ29tcG9zaXRlVmlldy5leHRlbmQoewoKICBtb2R1bGVFdmVudHM6IHsKICAgICdjbGljayB0aGVhZCB0aC5zb3J0aW5nJzogJ3VwZGF0ZVNvcnQnLAogICAgJ2NsaWNrIHRoZWFkIHRoLnNvcnRpbmctYXNjJzogJ3VwZGF0ZVNvcnQnLAogICAgJ2NsaWNrIHRoZWFkIHRoLnNvcnRpbmctZGVzYyc6ICd1cGRhdGVTb3J0JwogIH0sCgogIC8vIFRPRE86IGFkZCBhdXRvLXNvcnQKICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CgogICAgdGhpcy52ZW50ID0gb3B0aW9ucy52ZW50OwogICAgdGhpcy5zb3J0ID0gW107CiAgICB0aGlzLnZlbnQub24oJ3RhYmxlOnNldHVwJywgdGhpcy5zZXRTb3J0LCB0aGlzKTsKICAgIHRoaXMudmVudC5vbigndGFibGU6cmVmcmVzaGVkJywgdGhpcy5zZXRTb3J0LCB0aGlzKTsKICAgIHRoaXMuZXZlbnRzID0gXy5leHRlbmQoe30sIHRoaXMuZXZlbnRzIHx8IHt9LCB0aGlzLm1vZHVsZUV2ZW50cyk7CgogICAgaWYgKHR5cGVvZih0aGlzLmluaXRpYWxpemVNb2R1bGUpID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5pbml0aWFsaXplTW9kdWxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIHVwZGF0ZVNvcnQ6IGZ1bmN0aW9uKGV2KSB7CgogICAgdmFyIGVsID0gJChldi5jdXJyZW50VGFyZ2V0KTsKICAgIGlmICghKGVsLmhhc0NsYXNzKCdzb3J0aW5nJykgfHwgZWwuaGFzQ2xhc3MoJ3NvcnRpbmctYXNjJykgfHwgZWwuaGFzQ2xhc3MoJ3NvcnRpbmctZGVzYycpKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGZpZWxkID0gdGhpcy5maWVsZE5hbWUoZWwpOwoKICAgIGlmIChldi5zaGlmdEtleSB8fCB0aGlzLnNvcnQubGVuZ3RoID09IDEpIHsKCiAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICBfLmZpbmQodGhpcy5zb3J0LCBmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgaWYgKGl0ZW0uc3BsaXQoJyAnKVswXSA9PSBmaWVsZCkgewogICAgICAgICAgaW5kZXggPSBpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBpZiAoaW5kZXggPj0gMCkgewoKICAgICAgICB2YXIgcGFydHMgPSB0aGlzLnNvcnRbaW5kZXhdLnNwbGl0KCcgJyk7CiAgICAgICAgdGhpcy5zb3J0W2luZGV4XSA9IHBhcnRzWzBdICsgJyAnICsgKHBhcnRzWzFdID09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYycpOwogICAgICAgIHRoaXMuc2hvd1NvcnQoKTsKICAgICAgICByZXR1cm4gdGhpcy52ZW50LnRyaWdnZXIoJ3RhYmxlOnVwZGF0ZScsIHRoaXMuY29uZmlnKCkpOwogICAgICB9CiAgICB9CgogICAgaWYgKCFldi5zaGlmdEtleSkgewogICAgICB0aGlzLnNvcnQubGVuZ3RoID0gMDsKICAgIH0KCiAgICB0aGlzLnNvcnQucHVzaChmaWVsZCArICcgYXNjJyk7CgogICAgdGhpcy5zaG93U29ydCgpOwoKICAgIHRoaXMudmVudC50cmlnZ2VyKCd0YWJsZTp1cGRhdGUnLCB0aGlzLmNvbmZpZygpKTsKICB9LAoKICBzZXRTb3J0OiBmdW5jdGlvbihjb25maWcpIHsKICAgIGlmIChjb25maWcgJiYgY29uZmlnLnNvcnQpIHsKICAgICAgdGhpcy5zb3J0ID0gY29uZmlnLnNvcnQuc2xpY2UoMCk7CiAgICAgIHRoaXMuc2hvd1NvcnQoKTsKICAgIH0KICB9LAoKICBzaG93U29ydDogZnVuY3Rpb24oKSB7CgogICAgdGhpcy4kZWwuZmluZCgndGhlYWQgdGguc29ydGluZywgdGhlYWQgdGguc29ydGluZy1hc2MsIHRoZWFkIHRoLnNvcnRpbmctZGVzYycpLnJlbW92ZUNsYXNzKCdzb3J0aW5nIHNvcnRpbmctYXNjIHNvcnRpbmctZGVzYycpLmFkZENsYXNzKCdzb3J0aW5nJyk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNvcnQubGVuZ3RoOyBpKyspIHsKCiAgICAgIHZhciBwYXJ0cyA9IHRoaXMuc29ydFtpXS5zcGxpdCgnICcpOwogICAgICB2YXIgbmFtZSA9IHBhcnRzWzBdOwogICAgICB2YXIgZGlyZWN0aW9uID0gcGFydHNbMV07CiAgICAgIAogICAgICBmaWVsZCA9IHRoaXMuJGVsLmZpbmQoJ3RoZWFkIFtkYXRhLWZpZWxkPSInICsgbmFtZSArICciXScpOwogICAgICBpZiAoIWZpZWxkLmxlbmd0aCkgewogICAgICAgIGZpZWxkID0gdGhpcy4kZWwuZmluZCgndGhlYWQgdGg6Y29udGFpbnMoIicgKyBuYW1lICsgJyIpJyk7CiAgICAgIH0KCiAgICAgIGlmIChmaWVsZC5sZW5ndGgpIHsKICAgICAgICBmaWVsZC5yZW1vdmVDbGFzcygnc29ydGluZycpLmFkZENsYXNzKGRpcmVjdGlvbiA9PSAnZGVzYycgPyAnc29ydGluZy1kZXNjJyA6ICdzb3J0aW5nLWFzYycpOwogICAgICB9CiAgICB9CiAgfSwKCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHBhZ2U6IDEsCiAgICAgIHNvcnQ6IHRoaXMuc29ydENvbmZpZygpCiAgICB9OwogIH0sCgogIHNvcnRDb25maWc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc29ydC5sZW5ndGggPyB0aGlzLnNvcnQgOiBudWxsOwogIH0sCgogIGZpZWxkTmFtZTogZnVuY3Rpb24oZWwpIHsKICAgIHJldHVybiBlbC5kYXRhKCdmaWVsZCcpIHx8IGVsLnRleHQoKTsKICB9Cn0pOwoKVGFibGVsaW5nLlBsYWluLlBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5QbGFpbi5UYWJsZS5wcm90b3R5cGUucGFnZVNpemVWaWV3ID0gVGFibGVsaW5nLkZpZWxkTW9kdWxlLmV4dGVuZCh7CgogIC8vIFRPRE86IHVwZGF0ZSBjdXJyZW50IHBhZ2UgaW50ZWxsaWdlbnRseQogIG5hbWU6ICdwYWdlU2l6ZScsCiAgdGVtcGxhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBfLnRlbXBsYXRlKCc8c2VsZWN0IG5hbWU9InBhZ2VTaXplIiAvPiA8JS0gZW50cmllcyAlPicpKGRhdGEpOwogIH0sCgogIGkxOG46IHsKICAgIGVudHJpZXM6ICdlbnRyaWVzIHBlciBwYWdlJwogIH0sCiAgc2l6ZXM6IFsgMTAsIDE1LCAyMCwgMjUsIDUwIF0sCgogIHVpOiB7CiAgICBmaWVsZDogJ3NlbGVjdCcKICB9LAoKICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLnNpemVzID0gXy5jbG9uZShvcHRpb25zLnNpemVzIHx8IHRoaXMuc2l6ZXMpOwogICAgVGFibGVsaW5nLkZpZWxkTW9kdWxlLnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfSwKCiAgb25SZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdGhpcy51aS5maWVsZC5lbXB0eSgpOwogICAgXy5lYWNoKHRoaXMuc2l6ZXMsIF8uYmluZCh0aGlzLmFkZFNpemUsIHRoaXMpKTsKICB9LAoKICBhZGRTaXplOiBmdW5jdGlvbihzaXplKSB7CiAgICAkKCc8b3B0aW9uIC8+JykudGV4dChzaXplKS5hcHBlbmRUbyh0aGlzLnVpLmZpZWxkKTsKICB9LAoKICBzZXR1cFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlKSB7CiAgICAgIFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuc2V0dXBWYWx1ZS5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKICAgIH0KICB9LAoKICBjb25maWc6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbmZpZyA9IFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuY29uZmlnLmNhbGwodGhpcyk7CiAgICBjb25maWcucGFnZSA9IDE7CiAgICByZXR1cm4gY29uZmlnOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uUXVpY2tTZWFyY2hWaWV3ID0gVGFibGVsaW5nLlBsYWluLlRhYmxlLnByb3RvdHlwZS5xdWlja1NlYXJjaFZpZXcgPSBUYWJsZWxpbmcuRmllbGRNb2R1bGUuZXh0ZW5kKHsKCiAgbmFtZTogJ3F1aWNrU2VhcmNoJywKICB0ZW1wbGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIF8udGVtcGxhdGUoJzxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJxdWlja1NlYXJjaCIgcGxhY2Vob2xkZXI9IjwlLSBxdWlja1NlYXJjaCAlPiIgLz4nKShkYXRhKTsKICB9LAoKICBpMThuOiB7CiAgICBxdWlja1NlYXJjaDogJ1F1aWNrIHNlYXJjaC4uLicKICB9LAoKICBjb25maWc6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbmZpZyA9IFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuY29uZmlnLmNhbGwodGhpcyk7CiAgICBjb25maWcucGFnZSA9IDE7CiAgICByZXR1cm4gY29uZmlnOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uSW5mb1ZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGUucHJvdG90eXBlLmluZm9WaWV3ID0gVGFibGVsaW5nLk1vZHVsZS5leHRlbmQoewoKICB0ZW1wbGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIF8udGVtcGxhdGUoZGF0YS50ZW1wbGF0ZSkoewogICAgICBmaXJzdDogJzxzcGFuIGNsYXNzPSJmaXJzdCI+MDwvc3Bhbj4nLAogICAgICBsYXN0OiAnPHNwYW4gY2xhc3M9Imxhc3QiPjA8L3NwYW4+JywKICAgICAgdG90YWw6ICc8c3BhbiBjbGFzcz0idG90YWwiPjA8L3NwYW4+JwogICAgfSk7CiAgfSwKCiAgaTE4bjogewogICAgdGVtcGxhdGU6ICdTaG93aW5nIDwlPSBmaXJzdCAlPiB0byA8JT0gbGFzdCAlPiBvZiA8JT0gdG90YWwgJT4gZW50cmllcycKICB9LAoKICB1aTogewogICAgZmlyc3Q6ICcuZmlyc3QnLAogICAgbGFzdDogJy5sYXN0JywKICAgIHRvdGFsOiAnLnRvdGFsJwogIH0sCgogIHJlZnJlc2g6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGlmIChkYXRhKSB7CiAgICAgIHRoaXMudWkuZmlyc3QudGV4dCh0aGlzLmZpcnN0UmVjb3JkKGRhdGEpKTsKICAgICAgdGhpcy51aS5sYXN0LnRleHQodGhpcy5sYXN0UmVjb3JkKGRhdGEpKTsKICAgICAgdGhpcy51aS50b3RhbC50ZXh0KGRhdGEudG90YWwpOwogICAgfQogIH0sCgogIGZpcnN0UmVjb3JkOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gZGF0YS5sZW5ndGggPyAoKGRhdGEucGFnZSB8fCAxKSAtIDEpICogZGF0YS5wYWdlU2l6ZSArIDEgOiAwOwogIH0sCgogIGxhc3RSZWNvcmQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBkYXRhLmxlbmd0aCA/IHRoaXMuZmlyc3RSZWNvcmQoZGF0YSkgKyBkYXRhLmxlbmd0aCAtIDEgOiAwOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uUGFnZVZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGUucHJvdG90eXBlLnBhZ2VWaWV3ID0gVGFibGVsaW5nLk1vZHVsZS5leHRlbmQoewogICAgCiAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJzx1bCBjbGFzcz0icGFnaW5hdGlvbiI+PGxpIGNsYXNzPSJmaXJzdCI+PGEgaHJlZj0iIyI+Jmx0OyZsdDs8L2E+PC9saT48bGkgY2xhc3M9InByZXZpb3VzIj48YSBocmVmPSIjIj4mbHQ7PC9hPjwvbGk+PGxpIGNsYXNzPSJuZXh0Ij48YSBocmVmPSIjIj4mZ3Q7PC9hPjwvbGk+PGxpIGNsYXNzPSJsYXN0Ij48YSBocmVmPSIjIj4mZ3Q7Jmd0OzwvYT48L2xpPjwvdWw+JyksCiAgcGFnZVRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8bGkgY2xhc3M9InBhZ2UiPjxhIGhyZWY9IiMiPjwlLSBudW1iZXIgJT48L2E+PC9saT4nKSwKCiAgdWk6IHsKICAgIGZpcnN0OiAnLmZpcnN0JywKICAgIHByZXZpb3VzOiAnLnByZXZpb3VzJywKICAgIG5leHQ6ICcubmV4dCcsCiAgICBsYXN0OiAnLmxhc3QnCiAgfSwKCiAgZXZlbnRzOiB7CiAgICAnY2xpY2sgLmZpcnN0Om5vdCguZGlzYWJsZWQpJzogJ2dvVG9GaXJzdFBhZ2UnLAogICAgJ2NsaWNrIC5wcmV2aW91czpub3QoLmRpc2FibGVkKSc6ICdnb1RvUHJldmlvdXNQYWdlJywKICAgICdjbGljayAucGFnZTpub3QoLmRpc2FibGVkKSc6ICdnb1RvUGFnZScsCiAgICAnY2xpY2sgLm5leHQ6bm90KC5kaXNhYmxlZCknOiAnZ29Ub05leHRQYWdlJywKICAgICdjbGljayAubGFzdDpub3QoLmRpc2FibGVkKSc6ICdnb1RvTGFzdFBhZ2UnCiAgfSwKCiAgcmVmcmVzaDogZnVuY3Rpb24oZGF0YSkgewogICAgdGhpcy4kZWwuZmluZCgnLnBhZ2UnKS5yZW1vdmUoKTsKICAgIGlmICghZGF0YSB8fCAhZGF0YS5sZW5ndGgpIHsKICAgICAgdGhpcy51aS5maXJzdC5hZGRDbGFzcygnZGlzYWJsZWQnKTsKICAgICAgdGhpcy51aS5wcmV2aW91cy5hZGRDbGFzcygnZGlzYWJsZWQnKTsKICAgICAgdGhpcy51aS5uZXh0LmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgICB0aGlzLnVpLmxhc3QuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgICB0aGlzLmVuYWJsZSh0aGlzLnVpLmZpcnN0LCB0aGlzLmdldFBhZ2UoZGF0YSkgPiAxKTsKICAgICAgdGhpcy5lbmFibGUodGhpcy51aS5wcmV2aW91cywgdGhpcy5nZXRQYWdlKGRhdGEpID4gMSk7CiAgICAgIHRoaXMuc2V0dXBQYWdlcygpOwogICAgICB0aGlzLmVuYWJsZSh0aGlzLnVpLm5leHQsIHRoaXMuZ2V0UGFnZShkYXRhKSA8IHRoaXMubnVtYmVyT2ZQYWdlcyhkYXRhKSk7CiAgICAgIHRoaXMuZW5hYmxlKHRoaXMudWkubGFzdCwgdGhpcy5nZXRQYWdlKGRhdGEpIDwgdGhpcy5udW1iZXJPZlBhZ2VzKGRhdGEpKTsKICAgIH0KICB9LAoKICBzZXR1cFBhZ2VzOiBmdW5jdGlvbigpIHsKCiAgICB2YXIgcGFnZSA9IHRoaXMuZ2V0UGFnZSh0aGlzLmRhdGEpOwogICAgdmFyIHRvdGFsID0gdGhpcy5udW1iZXJPZlBhZ2VzKCk7CgogICAgdmFyIGZpcnN0ID0gcGFnZSAtIDI7CiAgICBpZiAodG90YWwgLSBmaXJzdCA8IDQpIHsKICAgICAgZmlyc3QgPSB0b3RhbCAtIDQ7CiAgICB9CgogICAgaWYgKGZpcnN0IDwgMSkgewogICAgICBmaXJzdCA9IDE7CiAgICB9CgogICAgdmFyIG4gPSA1OwogICAgaWYgKGZpcnN0ICsgbiAtIDEgPiB0b3RhbCkgewogICAgICBuID0gdG90YWwgLSBmaXJzdCArIDE7CiAgICB9CgogICAgXy50aW1lcyhuLCBmdW5jdGlvbihpKSB7CiAgICAgICQodGhpcy5wYWdlVGVtcGxhdGUoeyBudW1iZXI6IGZpcnN0ICsgaSB9KSkuaW5zZXJ0QmVmb3JlKHRoaXMudWkubmV4dCk7CiAgICB9LCB0aGlzKTsKCiAgICB2YXIgaSA9IHBhZ2UgLSBmaXJzdDsKICAgIHRoaXMuJGVsLmZpbmQoJy5wYWdlJykuc2xpY2UoaSwgaSArIDEpLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogIH0sCgogIGVuYWJsZTogZnVuY3Rpb24oZWwsIGVuYWJsZWQpIHsKICAgIGVsLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpOwogICAgaWYgKCFlbmFibGVkKSB7CiAgICAgIGVsLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgfQogIH0sCgogIG51bWJlck9mUGFnZXM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE1hdGguY2VpbCh0aGlzLmRhdGEudG90YWwgLyB0aGlzLmRhdGEucGFnZVNpemUpOwogIH0sCgogIGdvVG9GaXJzdFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIoMSk7CiAgfSwKCiAgZ29Ub1ByZXZpb3VzUGFnZTogZnVuY3Rpb24oZSkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgdGhpcy5nb1RvUGFnZU51bWJlcih0aGlzLmdldFBhZ2UodGhpcy5kYXRhKSAtIDEpOwogIH0sCgogIGdvVG9QYWdlOiBmdW5jdGlvbihlKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB0aGlzLmdvVG9QYWdlTnVtYmVyKHBhcnNlSW50KCQoZS50YXJnZXQpLnRleHQoKSwgMTApKTsKICB9LAoKICBnb1RvTmV4dFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIodGhpcy5nZXRQYWdlKHRoaXMuZGF0YSkgKyAxKTsKICB9LAoKICBnb1RvTGFzdFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIodGhpcy5udW1iZXJPZlBhZ2VzKCkpOwogIH0sCgogIGdvVG9QYWdlTnVtYmVyOiBmdW5jdGlvbihuKSB7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgeyBwYWdlOiBuIH0pOwogIH0sCgogIGdldFBhZ2U6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBkYXRhLnBhZ2UgfHwgMTsKICB9Cn0pOwoKVGFibGVsaW5nLkJvb3RzdHJhcCA9IHt9OwoKVGFibGVsaW5nLkJvb3RzdHJhcC5UYWJsZSA9IFRhYmxlbGluZy5QbGFpbi5UYWJsZS5leHRlbmQoewogIHRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPSJoZWFkZXIgY2xlYXJmaXgiPjxkaXYgY2xhc3M9InBhZ2VTaXplIHB1bGwtbGVmdCIgLz48ZGl2IGNsYXNzPSJxdWlja1NlYXJjaCBwdWxsLXJpZ2h0IiAvPjwvZGl2PjxkaXYgY2xhc3M9InRhYmxlIiAvPjxkaXYgY2xhc3M9ImZvb3RlciBjbGVhcmZpeCI+PGRpdiBjbGFzcz0iaW5mbyBwdWxsLWxlZnQiIC8+PGRpdiBjbGFzcz0icGFnZSBwdWxsLXJpZ2h0IiAvPjwvZGl2PicpCn0pOwoKVGFibGVsaW5nLkJvb3RzdHJhcC5UYWJsZVZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGVWaWV3LmV4dGVuZCh7fSk7CgpUYWJsZWxpbmcuQm9vdHN0cmFwLlBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5QbGFpbi5QYWdlU2l6ZVZpZXcuZXh0ZW5kKHsKCiAgdGFnTmFtZTogJ2Zvcm0nLAogIGNsYXNzTmFtZTogJ2Zvcm0taW5saW5lJywKICBhdHRyaWJ1dGVzOiB7CiAgICByb2xlOiAnZm9ybScKICB9LAogIHRlbXBsYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz0iZm9ybUdyb3VwIj48c2VsZWN0IG5hbWU9InBhZ2VTaXplIiBjbGFzcz0iZm9ybS1jb250cm9sIj48b3B0aW9uPjU8L29wdGlvbj48b3B0aW9uPjEwPC9vcHRpb24+PG9wdGlvbj4xNTwvb3B0aW9uPjwvc2VsZWN0PiA8JS0gZW50cmllcyAlPjwvZGl2PicpKGRhdGEpOwogIH0KfSk7CgpUYWJsZWxpbmcuQm9vdHN0cmFwLlF1aWNrU2VhcmNoVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnF1aWNrU2VhcmNoVmlldyA9IFRhYmxlbGluZy5QbGFpbi5RdWlja1NlYXJjaFZpZXcuZXh0ZW5kKHsKCiAgdGFnTmFtZTogJ2Zvcm0nLAogIGNsYXNzTmFtZTogJ2Zvcm0taW5saW5lJywKICBhdHRyaWJ1dGVzOiB7CiAgICByb2xlOiAnZm9ybScKICB9LAogIHRlbXBsYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz0iZm9ybUdyb3VwIj48aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0icXVpY2tTZWFyY2giIGNsYXNzPSJmb3JtLWNvbnRyb2wiIHBsYWNlaG9sZGVyPSI8JS0gcXVpY2tTZWFyY2ggJT4iIC8+PC9kaXY+JykoZGF0YSk7CiAgfQp9KTsKClRhYmxlbGluZy5Cb290c3RyYXAuSW5mb1ZpZXcgPSBUYWJsZWxpbmcuQm9vdHN0cmFwLlRhYmxlLnByb3RvdHlwZS5pbmZvVmlldyA9IFRhYmxlbGluZy5QbGFpbi5JbmZvVmlldy5leHRlbmQoe30pOwoKVGFibGVsaW5nLkJvb3RzdHJhcC5QYWdlVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnBhZ2VWaWV3ID0gVGFibGVsaW5nLlBsYWluLlBhZ2VWaWV3LmV4dGVuZCh7fSk7CgogIHJldHVybiBUYWJsZWxpbmc7Cgp9KShCYWNrYm9uZSwgXywgJCB8fCB3aW5kb3cualF1ZXJ5IHx8IHdpbmRvdy5aZXB0byB8fCB3aW5kb3cuZW5kZXIpOwo=",
                "body": "Ly8gICAgIEJhY2tib25lLmpzIDEuMS4yCgovLyAgICAgKGMpIDIwMTAtMjAxNCBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgYW5kIEludmVzdGlnYXRpdmUgUmVwb3J0ZXJzICYgRWRpdG9ycwovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgogIC8vIFNldCB1cCBCYWNrYm9uZSBhcHByb3ByaWF0ZWx5IGZvciB0aGUgZW52aXJvbm1lbnQuIFN0YXJ0IHdpdGggQU1ELgogIGlmICh0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIGRlZmluZShbJ3VuZGVyc2NvcmUnLCAnanF1ZXJ5JywgJ2V4cG9ydHMnXSwgZnVuY3Rpb24oXywgJCwgZXhwb3J0cykgewogICAgICAvLyBFeHBvcnQgZ2xvYmFsIGV2ZW4gaW4gQU1EIGNhc2UgaW4gY2FzZSB0aGlzIHNjcmlwdCBpcyBsb2FkZWQgd2l0aAogICAgICAvLyBvdGhlcnMgdGhhdCBtYXkgc3RpbGwgZXhwZWN0IGEgZ2xvYmFsIEJhY2tib25lLgogICAgICByb290LkJhY2tib25lID0gZmFjdG9yeShyb290LCBleHBvcnRzLCBfLCAkKTsKICAgIH0pOwoKICAvLyBOZXh0IGZvciBOb2RlLmpzIG9yIENvbW1vbkpTLiBqUXVlcnkgbWF5IG5vdCBiZSBuZWVkZWQgYXMgYSBtb2R1bGUuCiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBfID0gcmVxdWlyZSgndW5kZXJzY29yZScpOwogICAgZmFjdG9yeShyb290LCBleHBvcnRzLCBfKTsKCiAgLy8gRmluYWxseSwgYXMgYSBicm93c2VyIGdsb2JhbC4KICB9IGVsc2UgewogICAgcm9vdC5CYWNrYm9uZSA9IGZhY3Rvcnkocm9vdCwge30sIHJvb3QuXywgKHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlciB8fCByb290LiQpKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfLCAkKSB7CgogIC8vIEluaXRpYWwgU2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgQmFja2JvbmVgIHZhcmlhYmxlLCBzbyB0aGF0IGl0IGNhbiBiZQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7CgogIC8vIENyZWF0ZSBsb2NhbCByZWZlcmVuY2VzIHRvIGFycmF5IG1ldGhvZHMgd2UnbGwgd2FudCB0byB1c2UgbGF0ZXIuCiAgdmFyIGFycmF5ID0gW107CiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOwogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOwogIHZhciBzcGxpY2UgPSBhcnJheS5zcGxpY2U7CgogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuCiAgQmFja2JvbmUuVkVSU0lPTiA9ICcxLjEuMic7CgogIC8vIEZvciBCYWNrYm9uZSdzIHB1cnBvc2VzLCBqUXVlcnksIFplcHRvLCBFbmRlciwgb3IgTXkgTGlicmFyeSAoa2lkZGluZykgb3ducwogIC8vIHRoZSBgJGAgdmFyaWFibGUuCiAgQmFja2JvbmUuJCA9ICQ7CgogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQogIC8vIHRvIGl0cyBwcmV2aW91cyBvd25lci4gUmV0dXJucyBhIHJlZmVyZW5jZSB0byB0aGlzIEJhY2tib25lIG9iamVjdC4KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7CiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIFR1cm4gb24gYGVtdWxhdGVIVFRQYCB0byBzdXBwb3J0IGxlZ2FjeSBIVFRQIHNlcnZlcnMuIFNldHRpbmcgdGhpcyBvcHRpb24KICAvLyB3aWxsIGZha2UgYCJQQVRDSCJgLCBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQKICAvLyBzZXQgYSBgWC1IdHRwLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7CgogIC8vIFR1cm4gb24gYGVtdWxhdGVKU09OYCB0byBzdXBwb3J0IGxlZ2FjeSBzZXJ2ZXJzIHRoYXQgY2FuJ3QgZGVhbCB3aXRoIGRpcmVjdAogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMKICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGEKICAvLyBmb3JtIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsKCiAgLy8gQmFja2JvbmUuRXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tCgogIC8vIEEgbW9kdWxlIHRoYXQgY2FuIGJlIG1peGVkIGluIHRvICphbnkgb2JqZWN0KiBpbiBvcmRlciB0byBwcm92aWRlIGl0IHdpdGgKICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4KICAvLyBzdWNjZXNzaW9uLgogIC8vCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsKICAvLyAgICAgXy5leHRlbmQob2JqZWN0LCBCYWNrYm9uZS5FdmVudHMpOwogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsKICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOwogIC8vCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsKCiAgICAvLyBCaW5kIGFuIGV2ZW50IHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZAogICAgLy8gdGhlIGNhbGxiYWNrIHRvIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ29uJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgfHwgIWNhbGxiYWNrKSByZXR1cm4gdGhpczsKICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7CiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV0gfHwgKHRoaXMuX2V2ZW50c1tuYW1lXSA9IFtdKTsKICAgICAgZXZlbnRzLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgYW4gZXZlbnQgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUKICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuCiAgICBvbmNlOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgewogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pIHx8ICFjYWxsYmFjaykgcmV0dXJuIHRoaXM7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7CiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7CiAgICAgICAgY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfSk7CiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOwogICAgfSwKCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwKICAgIC8vIGNhbGxiYWNrcyBmb3IgdGhlIGV2ZW50LiBJZiBgbmFtZWAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQKICAgIC8vIGNhbGxiYWNrcyBmb3IgYWxsIGV2ZW50cy4KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgdmFyIHJldGFpbiwgZXYsIGV2ZW50cywgbmFtZXMsIGksIGwsIGosIGs7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgewogICAgICAgIHRoaXMuX2V2ZW50cyA9IHZvaWQgMDsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsKICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG5hbWUgPSBuYW1lc1tpXTsKICAgICAgICBpZiAoZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICB0aGlzLl9ldmVudHNbbmFtZV0gPSByZXRhaW4gPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBldmVudHMubGVuZ3RoOyBqIDwgazsgaisrKSB7CiAgICAgICAgICAgICAgZXYgPSBldmVudHNbal07CiAgICAgICAgICAgICAgaWYgKChjYWxsYmFjayAmJiBjYWxsYmFjayAhPT0gZXYuY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IGV2LmNhbGxiYWNrLl9jYWxsYmFjaykgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIHJldGFpbi5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghcmV0YWluLmxlbmd0aCkgZGVsZXRlIHRoaXMuX2V2ZW50c1tuYW1lXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyhldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3IKICAgIC8vIHRvIGV2ZXJ5IG9iamVjdCBpdCdzIGN1cnJlbnRseSBsaXN0ZW5pbmcgdG8uCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvOwogICAgICBpZiAoIWxpc3RlbmluZ1RvKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHJlbW92ZSA9ICFuYW1lICYmICFjYWxsYmFjazsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgaWYgKG9iaikgKGxpc3RlbmluZ1RvID0ge30pW29iai5fbGlzdGVuSWRdID0gb2JqOwogICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5pbmdUbykgewogICAgICAgIG9iaiA9IGxpc3RlbmluZ1RvW2lkXTsKICAgICAgICBvYmoub2ZmKG5hbWUsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAocmVtb3ZlIHx8IF8uaXNFbXB0eShvYmouX2V2ZW50cykpIGRlbGV0ZSB0aGlzLl9saXN0ZW5pbmdUb1tpZF07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogIH07CgogIC8vIFJlZ3VsYXIgZXhwcmVzc2lvbiB1c2VkIHRvIHNwbGl0IGV2ZW50IHN0cmluZ3MuCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsKCiAgLy8gSW1wbGVtZW50IGZhbmN5IGZlYXR1cmVzIG9mIHRoZSBFdmVudHMgQVBJIHN1Y2ggYXMgbXVsdGlwbGUgZXZlbnQKICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YAogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuCiAgdmFyIGV2ZW50c0FwaSA9IGZ1bmN0aW9uKG9iaiwgYWN0aW9uLCBuYW1lLCByZXN0KSB7CiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOwoKICAgIC8vIEhhbmRsZSBldmVudCBtYXBzLgogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0JykgewogICAgICBmb3IgKHZhciBrZXkgaW4gbmFtZSkgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBIYW5kbGUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50IG5hbWVzLgogICAgaWYgKGV2ZW50U3BsaXR0ZXIudGVzdChuYW1lKSkgewogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW25hbWVzW2ldXS5jb25jYXQocmVzdCkpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvLyBBIGRpZmZpY3VsdC10by1iZWxpZXZlLCBidXQgb3B0aW1pemVkIGludGVybmFsIGRpc3BhdGNoIGZ1bmN0aW9uIGZvcgogIC8vIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0byBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgaW50ZXJuYWwKICAvLyBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuCiAgdmFyIHRyaWdnZXJFdmVudHMgPSBmdW5jdGlvbihldmVudHMsIGFyZ3MpIHsKICAgIHZhciBldiwgaSA9IC0xLCBsID0gZXZlbnRzLmxlbmd0aCwgYTEgPSBhcmdzWzBdLCBhMiA9IGFyZ3NbMV0sIGEzID0gYXJnc1syXTsKICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsKICAgICAgY2FzZSAwOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCk7IHJldHVybjsKICAgICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEpOyByZXR1cm47CiAgICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGExLCBhMik7IHJldHVybjsKICAgICAgY2FzZSAzOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYTEsIGEyLCBhMyk7IHJldHVybjsKICAgICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsgcmV0dXJuOwogICAgfQogIH07CgogIHZhciBsaXN0ZW5NZXRob2RzID0ge2xpc3RlblRvOiAnb24nLCBsaXN0ZW5Ub09uY2U6ICdvbmNlJ307CgogIC8vIEludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb25zIG9mIGBvbmAgYW5kIGBvbmNlYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvCiAgLy8gbGlzdGVuIHRvIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncwogIC8vIGxpc3RlbmluZyB0by4KICBfLmVhY2gobGlzdGVuTWV0aG9kcywgZnVuY3Rpb24oaW1wbGVtZW50YXRpb24sIG1ldGhvZCkgewogICAgRXZlbnRzW21ldGhvZF0gPSBmdW5jdGlvbihvYmosIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIHZhciBsaXN0ZW5pbmdUbyA9IHRoaXMuX2xpc3RlbmluZ1RvIHx8ICh0aGlzLl9saXN0ZW5pbmdUbyA9IHt9KTsKICAgICAgdmFyIGlkID0gb2JqLl9saXN0ZW5JZCB8fCAob2JqLl9saXN0ZW5JZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmluZ1RvW2lkXSA9IG9iajsKICAgICAgaWYgKCFjYWxsYmFjayAmJiB0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIGNhbGxiYWNrID0gdGhpczsKICAgICAgb2JqW2ltcGxlbWVudGF0aW9uXShuYW1lLCBjYWxsYmFjaywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICB9KTsKCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCiAgRXZlbnRzLmJpbmQgICA9IEV2ZW50cy5vbjsKICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsKCiAgLy8gQWxsb3cgdGhlIGBCYWNrYm9uZWAgb2JqZWN0IHRvIHNlcnZlIGFzIGEgZ2xvYmFsIGV2ZW50IGJ1cywgZm9yIGZvbGtzIHdobwogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsKCiAgLy8gQmFja2JvbmUuTW9kZWwKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBCYWNrYm9uZSAqKk1vZGVscyoqIGFyZSB0aGUgYmFzaWMgZGF0YSBvYmplY3QgaW4gdGhlIGZyYW1ld29yayAtLQogIC8vIGZyZXF1ZW50bHkgcmVwcmVzZW50aW5nIGEgcm93IGluIGEgdGFibGUgaW4gYSBkYXRhYmFzZSBvbiB5b3VyIHNlcnZlci4KICAvLyBBIGRpc2NyZXRlIGNodW5rIG9mIGRhdGEgYW5kIGEgYnVuY2ggb2YgdXNlZnVsLCByZWxhdGVkIG1ldGhvZHMgZm9yCiAgLy8gcGVyZm9ybWluZyBjb21wdXRhdGlvbnMgYW5kIHRyYW5zZm9ybWF0aW9ucyBvbiB0aGF0IGRhdGEuCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIHRoZSBzcGVjaWZpZWQgYXR0cmlidXRlcy4gQSBjbGllbnQgaWQgKGBjaWRgKQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91LgogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9OwogICAgaWYgKG9wdGlvbnMuY29sbGVjdGlvbikgdGhpcy5jb2xsZWN0aW9uID0gb3B0aW9ucy5jb2xsZWN0aW9uOwogICAgaWYgKG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycywgb3B0aW9ucykgfHwge307CiAgICBhdHRycyA9IF8uZGVmYXVsdHMoe30sIGF0dHJzLCBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSk7CiAgICB0aGlzLnNldChhdHRycywgb3B0aW9ucyk7CiAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CgogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLgogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLgogICAgY2hhbmdlZDogbnVsbCwKCiAgICAvLyBUaGUgdmFsdWUgcmV0dXJuZWQgZHVyaW5nIHRoZSBsYXN0IGZhaWxlZCB2YWxpZGF0aW9uLgogICAgdmFsaWRhdGlvbkVycm9yOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0IC0tIGJ1dCBvdmVycmlkZSB0aGlzIGlmIHlvdSBuZWVkCiAgICAvLyBjdXN0b20gc3luY2luZyBzZW1hbnRpY3MgZm9yICp0aGlzKiBwYXJ0aWN1bGFyIG1vZGVsLgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAuIFRoaXMgaXMKICAgIC8vIHRoZSBjb3JlIHByaW1pdGl2ZSBvcGVyYXRpb24gb2YgYSBtb2RlbCwgdXBkYXRpbmcgdGhlIGRhdGEgYW5kIG5vdGlmeWluZwogICAgLy8gYW55b25lIHdobyBuZWVkcyB0byBrbm93IGFib3V0IHRoZSBjaGFuZ2UgaW4gc3RhdGUuIFRoZSBoZWFydCBvZiB0aGUgYmVhc3QuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRycywgdW5zZXQsIGNoYW5nZXMsIHNpbGVudCwgY2hhbmdpbmcsIHByZXYsIGN1cnJlbnQ7CiAgICAgIGlmIChrZXkgPT0gbnVsbCkgcmV0dXJuIHRoaXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLgogICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB1bnNldCAgICAgICAgICAgPSBvcHRpb25zLnVuc2V0OwogICAgICBzaWxlbnQgICAgICAgICAgPSBvcHRpb25zLnNpbGVudDsKICAgICAgY2hhbmdlcyAgICAgICAgID0gW107CiAgICAgIGNoYW5naW5nICAgICAgICA9IHRoaXMuX2NoYW5naW5nOwogICAgICB0aGlzLl9jaGFuZ2luZyAgPSB0cnVlOwoKICAgICAgaWYgKCFjaGFuZ2luZykgewogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgfQogICAgICBjdXJyZW50ID0gdGhpcy5hdHRyaWJ1dGVzLCBwcmV2ID0gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzOwoKICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4KICAgICAgaWYgKHRoaXMuaWRBdHRyaWJ1dGUgaW4gYXR0cnMpIHRoaXMuaWQgPSBhdHRyc1t0aGlzLmlkQXR0cmlidXRlXTsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZSwgdXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZS4KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7CiAgICAgICAgdmFsID0gYXR0cnNbYXR0cl07CiAgICAgICAgaWYgKCFfLmlzRXF1YWwoY3VycmVudFthdHRyXSwgdmFsKSkgY2hhbmdlcy5wdXNoKGF0dHIpOwogICAgICAgIGlmICghXy5pc0VxdWFsKHByZXZbYXR0cl0sIHZhbCkpIHsKICAgICAgICAgIHRoaXMuY2hhbmdlZFthdHRyXSA9IHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGVsZXRlIHRoaXMuY2hhbmdlZFthdHRyXTsKICAgICAgICB9CiAgICAgICAgdW5zZXQgPyBkZWxldGUgY3VycmVudFthdHRyXSA6IGN1cnJlbnRbYXR0cl0gPSB2YWw7CiAgICAgIH0KCiAgICAgIC8vIFRyaWdnZXIgYWxsIHJlbGV2YW50IGF0dHJpYnV0ZSBjaGFuZ2VzLgogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgdGhpcy5fcGVuZGluZyA9IG9wdGlvbnM7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjaGFuZ2VzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIGNoYW5nZXNbaV0sIHRoaXMsIGN1cnJlbnRbY2hhbmdlc1tpXV0sIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gWW91IG1pZ2h0IGJlIHdvbmRlcmluZyB3aHkgdGhlcmUncyBhIGB3aGlsZWAgbG9vcCBoZXJlLiBDaGFuZ2VzIGNhbgogICAgICAvLyBiZSByZWN1cnNpdmVseSBuZXN0ZWQgd2l0aGluIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwogICAgICBpZiAoIXNpbGVudCkgewogICAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7CiAgICAgICAgICBvcHRpb25zID0gdGhpcy5fcGVuZGluZzsKICAgICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhbiBhdHRyaWJ1dGUgZnJvbSB0aGUgbW9kZWwsIGZpcmluZyBgImNoYW5nZSJgLiBgdW5zZXRgIGlzIGEgbm9vcAogICAgLy8gaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2U7CiAgICAgIHZhciBvbGQgPSB0aGlzLl9jaGFuZ2luZyA/IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA6IHRoaXMuYXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0CiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4KICAgIHByZXZpb3VzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7CiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cwogICAgLy8gYCJjaGFuZ2UiYCBldmVudC4KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGRlbiwKICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50LgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgbW9kZWwgPSB0aGlzOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3AsIG9wdGlvbnMpLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzLCBhbmQgc3luYyB0aGUgbW9kZWwgdG8gdGhlIHNlcnZlci4KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncwogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4KICAgIHNhdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycywgbWV0aG9kLCB4aHIsIGF0dHJpYnV0ZXMgPSB0aGlzLmF0dHJpYnV0ZXM7CgogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4KICAgICAgaWYgKGtleSA9PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHt2YWxpZGF0ZTogdHJ1ZX0sIG9wdGlvbnMpOwoKICAgICAgLy8gSWYgd2UncmUgbm90IHdhaXRpbmcgYW5kIGF0dHJpYnV0ZXMgZXhpc3QsIHNhdmUgYWN0cyBhcwogICAgICAvLyBgc2V0KGF0dHIpLnNhdmUobnVsbCwgb3B0cylgIHdpdGggdmFsaWRhdGlvbi4gT3RoZXJ3aXNlLCBjaGVjayBpZgogICAgICAvLyB0aGUgbW9kZWwgd2lsbCBiZSB2YWxpZCB3aGVuIHRoZSBhdHRyaWJ1dGVzLCBpZiBhbnksIGFyZSBzZXQuCiAgICAgIGlmIChhdHRycyAmJiAhb3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKCF0aGlzLnNldChhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICAvLyBTZXQgdGVtcG9yYXJ5IGF0dHJpYnV0ZXMgaWYgYHt3YWl0OiB0cnVlfWAuCiAgICAgIGlmIChhdHRycyAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBfLmV4dGVuZCh7fSwgYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB9CgogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkKICAgICAgLy8gdXBkYXRlZCB3aXRoIHRoZSBzZXJ2ZXItc2lkZSBzdGF0ZS4KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgLy8gRW5zdXJlIGF0dHJpYnV0ZXMgYXJlIHJlc3RvcmVkIGR1cmluZyBzeW5jaHJvbm91cyBzYXZlcy4KICAgICAgICBtb2RlbC5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKICAgICAgICB2YXIgc2VydmVyQXR0cnMgPSBtb2RlbC5wYXJzZShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7CiAgICAgICAgaWYgKF8uaXNPYmplY3Qoc2VydmVyQXR0cnMpICYmICFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CgogICAgICBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsKICAgICAgaWYgKG1ldGhvZCA9PT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOwogICAgICB4aHIgPSB0aGlzLnN5bmMobWV0aG9kLCB0aGlzLCBvcHRpb25zKTsKCiAgICAgIC8vIFJlc3RvcmUgYXR0cmlidXRlcy4KICAgICAgaWYgKGF0dHJzICYmIG9wdGlvbnMud2FpdCkgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlczsKCiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4KICAgIC8vIE9wdGltaXN0aWNhbGx5IHJlbW92ZXMgdGhlIG1vZGVsIGZyb20gaXRzIGNvbGxlY3Rpb24sIGlmIGl0IGhhcyBvbmUuCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLgogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgdmFyIG1vZGVsID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CgogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCB8fCBtb2RlbC5pc05ldygpKSBkZXN0cm95KCk7CiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmICghbW9kZWwuaXNOZXcoKSkgbW9kZWwudHJpZ2dlcignc3luYycsIG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgd3JhcEVycm9yKHRoaXMsIG9wdGlvbnMpOwoKICAgICAgdmFyIHhociA9IHRoaXMuc3luYygnZGVsZXRlJywgdGhpcywgb3B0aW9ucyk7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7CiAgICAgIHJldHVybiB4aHI7CiAgICB9LAoKICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQogICAgLy8gdXNpbmcgQmFja2JvbmUncyByZXN0ZnVsIG1ldGhvZHMsIG92ZXJyaWRlIHRoaXMgdG8gY2hhbmdlIHRoZSBlbmRwb2ludAogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4KICAgIHVybDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBiYXNlID0KICAgICAgICBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8CiAgICAgICAgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwKICAgICAgICB1cmxFcnJvcigpOwogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsKICAgICAgcmV0dXJuIGJhc2UucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJykgKyBlbmNvZGVVUklDb21wb25lbnQodGhpcy5pZCk7CiAgICB9LAoKICAgIC8vICoqcGFyc2UqKiBjb252ZXJ0cyBhIHJlc3BvbnNlIGludG8gdGhlIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBgc2V0YCBvbgogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLgogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3AsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHJlc3A7CiAgICB9LAoKICAgIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCB3aXRoIGlkZW50aWNhbCBhdHRyaWJ1dGVzIHRvIHRoaXMgb25lLgogICAgY2xvbmU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsKICAgIH0sCgogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLgogICAgaXNOZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gIXRoaXMuaGFzKHRoaXMuaWRBdHRyaWJ1dGUpOwogICAgfSwKCiAgICAvLyBDaGVjayBpZiB0aGUgbW9kZWwgaXMgY3VycmVudGx5IGluIGEgdmFsaWQgc3RhdGUuCiAgICBpc1ZhbGlkOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0ZSh7fSwgXy5leHRlbmQob3B0aW9ucyB8fCB7fSwgeyB2YWxpZGF0ZTogdHJ1ZSB9KSk7CiAgICB9LAoKICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsCiAgICAvLyByZXR1cm5pbmcgYHRydWVgIGlmIGFsbCBpcyB3ZWxsLiBPdGhlcndpc2UsIGZpcmUgYW4gYCJpbnZhbGlkImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghb3B0aW9ucy52YWxpZGF0ZSB8fCAhdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRpb25FcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpIHx8IG51bGw7CiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOwogICAgICB0aGlzLnRyaWdnZXIoJ2ludmFsaWQnLCB0aGlzLCBlcnJvciwgXy5leHRlbmQob3B0aW9ucywge3ZhbGlkYXRpb25FcnJvcjogZXJyb3J9KSk7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgfSk7CgogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBNb2RlbC4KICB2YXIgbW9kZWxNZXRob2RzID0gWydrZXlzJywgJ3ZhbHVlcycsICdwYWlycycsICdpbnZlcnQnLCAncGljaycsICdvbWl0J107CgogIC8vIE1peCBpbiBlYWNoIFVuZGVyc2NvcmUgbWV0aG9kIGFzIGEgcHJveHkgdG8gYE1vZGVsI2F0dHJpYnV0ZXNgLgogIF8uZWFjaChtb2RlbE1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgTW9kZWwucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSWYgbW9kZWxzIHRlbmQgdG8gcmVwcmVzZW50IGEgc2luZ2xlIHJvdyBvZiBkYXRhLCBhIEJhY2tib25lIENvbGxlY3Rpb24gaXMKICAvLyBtb3JlIGFuYWxhZ291cyB0byBhIHRhYmxlIGZ1bGwgb2YgZGF0YSAuLi4gb3IgYSBzbWFsbCBzbGljZSBvciBwYWdlIG9mIHRoYXQKICAvLyB0YWJsZSwgb3IgYSBjb2xsZWN0aW9uIG9mIHJvd3MgdGhhdCBiZWxvbmcgdG9nZXRoZXIgZm9yIGEgcGFydGljdWxhciByZWFzb24KICAvLyAtLSBhbGwgb2YgdGhlIG1lc3NhZ2VzIGluIHRoaXMgcGFydGljdWxhciBmb2xkZXIsIGFsbCBvZiB0aGUgZG9jdW1lbnRzCiAgLy8gYmVsb25naW5nIHRvIHRoaXMgcGFydGljdWxhciBhdXRob3IsIGFuZCBzbyBvbi4gQ29sbGVjdGlvbnMgbWFpbnRhaW4KICAvLyBpbmRleGVzIG9mIHRoZWlyIG1vZGVscywgYm90aCBpbiBvcmRlciwgYW5kIGZvciBsb29rdXAgYnkgYGlkYC4KCiAgLy8gQ3JlYXRlIGEgbmV3ICoqQ29sbGVjdGlvbioqLCBwZXJoYXBzIHRvIGNvbnRhaW4gYSBzcGVjaWZpYyB0eXBlIG9mIGBtb2RlbGAuCiAgLy8gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmYXVsdCBvcHRpb25zIGZvciBgQ29sbGVjdGlvbiNzZXRgLgogIHZhciBzZXRPcHRpb25zID0ge2FkZDogdHJ1ZSwgcmVtb3ZlOiB0cnVlLCBtZXJnZTogdHJ1ZX07CiAgdmFyIGFkZE9wdGlvbnMgPSB7YWRkOiB0cnVlLCByZW1vdmU6IGZhbHNlfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLnNldChtb2RlbHMsIF8uZXh0ZW5kKHttZXJnZTogZmFsc2V9LCBvcHRpb25zLCBhZGRPcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIHZhciBzaW5ndWxhciA9ICFfLmlzQXJyYXkobW9kZWxzKTsKICAgICAgbW9kZWxzID0gc2luZ3VsYXIgPyBbbW9kZWxzXSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsKICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXSA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7CiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwuaWRdOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmNpZF07CiAgICAgICAgaW5kZXggPSB0aGlzLmluZGV4T2YobW9kZWwpOwogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgdGhpcy5sZW5ndGgtLTsKICAgICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB7CiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7CiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpbmd1bGFyID8gbW9kZWxzWzBdIDogbW9kZWxzOwogICAgfSwKCiAgICAvLyBVcGRhdGUgYSBjb2xsZWN0aW9uIGJ5IGBzZXRgLWluZyBhIG5ldyBsaXN0IG9mIG1vZGVscywgYWRkaW5nIG5ldyBvbmVzLAogICAgLy8gcmVtb3ZpbmcgbW9kZWxzIHRoYXQgYXJlIG5vIGxvbmdlciBwcmVzZW50LCBhbmQgbWVyZ2luZyBtb2RlbHMgdGhhdAogICAgLy8gYWxyZWFkeSBleGlzdCBpbiB0aGUgY29sbGVjdGlvbiwgYXMgbmVjZXNzYXJ5LiBTaW1pbGFyIHRvICoqTW9kZWwjc2V0KiosCiAgICAvLyB0aGUgY29yZSBvcGVyYXRpb24gZm9yIHVwZGF0aW5nIHRoZSBkYXRhIGNvbnRhaW5lZCBieSB0aGUgY29sbGVjdGlvbi4KICAgIHNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHt9LCBvcHRpb25zLCBzZXRPcHRpb25zKTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UpIG1vZGVscyA9IHRoaXMucGFyc2UobW9kZWxzLCBvcHRpb25zKTsKICAgICAgdmFyIHNpbmd1bGFyID0gIV8uaXNBcnJheShtb2RlbHMpOwogICAgICBtb2RlbHMgPSBzaW5ndWxhciA/IChtb2RlbHMgPyBbbW9kZWxzXSA6IFtdKSA6IF8uY2xvbmUobW9kZWxzKTsKICAgICAgdmFyIGksIGwsIGlkLCBtb2RlbCwgYXR0cnMsIGV4aXN0aW5nLCBzb3J0OwogICAgICB2YXIgYXQgPSBvcHRpb25zLmF0OwogICAgICB2YXIgdGFyZ2V0TW9kZWwgPSB0aGlzLm1vZGVsOwogICAgICB2YXIgc29ydGFibGUgPSB0aGlzLmNvbXBhcmF0b3IgJiYgKGF0ID09IG51bGwpICYmIG9wdGlvbnMuc29ydCAhPT0gZmFsc2U7CiAgICAgIHZhciBzb3J0QXR0ciA9IF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSA/IHRoaXMuY29tcGFyYXRvciA6IG51bGw7CiAgICAgIHZhciB0b0FkZCA9IFtdLCB0b1JlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgYWRkID0gb3B0aW9ucy5hZGQsIG1lcmdlID0gb3B0aW9ucy5tZXJnZSwgcmVtb3ZlID0gb3B0aW9ucy5yZW1vdmU7CiAgICAgIHZhciBvcmRlciA9ICFzb3J0YWJsZSAmJiBhZGQgJiYgcmVtb3ZlID8gW10gOiBmYWxzZTsKCiAgICAgIC8vIFR1cm4gYmFyZSBvYmplY3RzIGludG8gbW9kZWwgcmVmZXJlbmNlcywgYW5kIHByZXZlbnQgaW52YWxpZCBtb2RlbHMKICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBhdHRycyA9IG1vZGVsc1tpXSB8fCB7fTsKICAgICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgICAgaWQgPSBtb2RlbCA9IGF0dHJzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZCA9IGF0dHJzW3RhcmdldE1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZSB8fCAnaWQnXTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4KICAgICAgICBpZiAoZXhpc3RpbmcgPSB0aGlzLmdldChpZCkpIHsKICAgICAgICAgIGlmIChyZW1vdmUpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgICAgaWYgKG1lcmdlKSB7CiAgICAgICAgICAgIGF0dHJzID0gYXR0cnMgPT09IG1vZGVsID8gbW9kZWwuYXR0cmlidXRlcyA6IGF0dHJzOwogICAgICAgICAgICBpZiAob3B0aW9ucy5wYXJzZSkgYXR0cnMgPSBleGlzdGluZy5wYXJzZShhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGV4aXN0aW5nLnNldChhdHRycywgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChzb3J0YWJsZSAmJiAhc29ydCAmJiBleGlzdGluZy5oYXNDaGFuZ2VkKHNvcnRBdHRyKSkgc29ydCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBtb2RlbHNbaV0gPSBleGlzdGluZzsKCiAgICAgICAgLy8gSWYgdGhpcyBpcyBhIG5ldywgdmFsaWQgbW9kZWwsIHB1c2ggaXQgdG8gdGhlIGB0b0FkZGAgbGlzdC4KICAgICAgICB9IGVsc2UgaWYgKGFkZCkgewogICAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV0gPSB0aGlzLl9wcmVwYXJlTW9kZWwoYXR0cnMsIG9wdGlvbnMpOwogICAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7CiAgICAgICAgICB0b0FkZC5wdXNoKG1vZGVsKTsKICAgICAgICAgIHRoaXMuX2FkZFJlZmVyZW5jZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgICAgfQoKICAgICAgICAvLyBEbyBub3QgYWRkIG11bHRpcGxlIG1vZGVscyB3aXRoIHRoZSBzYW1lIGBpZGAuCiAgICAgICAgbW9kZWwgPSBleGlzdGluZyB8fCBtb2RlbDsKICAgICAgICBpZiAob3JkZXIgJiYgKG1vZGVsLmlzTmV3KCkgfHwgIW1vZGVsTWFwW21vZGVsLmlkXSkpIG9yZGVyLnB1c2gobW9kZWwpOwogICAgICAgIG1vZGVsTWFwW21vZGVsLmlkXSA9IHRydWU7CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBub25leGlzdGVudCBtb2RlbHMgaWYgYXBwcm9wcmlhdGUuCiAgICAgIGlmIChyZW1vdmUpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyArK2kpIHsKICAgICAgICAgIGlmICghbW9kZWxNYXBbKG1vZGVsID0gdGhpcy5tb2RlbHNbaV0pLmNpZF0pIHRvUmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgICBpZiAodG9SZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZSh0b1JlbW92ZSwgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKHRvQWRkLmxlbmd0aCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgewogICAgICAgIGlmIChzb3J0YWJsZSkgc29ydCA9IHRydWU7CiAgICAgICAgdGhpcy5sZW5ndGggKz0gdG9BZGQubGVuZ3RoOwogICAgICAgIGlmIChhdCAhPSBudWxsKSB7CiAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShhdCArIGksIDAsIHRvQWRkW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKG9yZGVyKSB0aGlzLm1vZGVscy5sZW5ndGggPSAwOwogICAgICAgICAgdmFyIG9yZGVyZWRNb2RlbHMgPSBvcmRlciB8fCB0b0FkZDsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBvcmRlcmVkTW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICB0aGlzLm1vZGVscy5wdXNoKG9yZGVyZWRNb2RlbHNbaV0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2lsZW50bHkgc29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKHNvcnQpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7CgogICAgICAvLyBVbmxlc3Mgc2lsZW5jZWQsIGl0J3MgdGltZSB0byBmaXJlIGFsbCBhcHByb3ByaWF0ZSBhZGQvc29ydCBldmVudHMuCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICBmb3IgKGkgPSAwLCBsID0gdG9BZGQubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAobW9kZWwgPSB0b0FkZFtpXSkudHJpZ2dlcignYWRkJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc29ydCB8fCAob3JkZXIgJiYgb3JkZXIubGVuZ3RoKSkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiB0aGUgYWRkZWQgKG9yIG1lcmdlZCkgbW9kZWwgKG9yIG1vZGVscykuCiAgICAgIHJldHVybiBzaW5ndWxhciA/IG1vZGVsc1swXSA6IG1vZGVsczsKICAgIH0sCgogICAgLy8gV2hlbiB5b3UgaGF2ZSBtb3JlIGl0ZW1zIHRoYW4geW91IHdhbnQgdG8gYWRkIG9yIHJlbW92ZSBpbmRpdmlkdWFsbHksCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nCiAgICAvLyBhbnkgZ3JhbnVsYXIgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuCiAgICAvLyBVc2VmdWwgZm9yIGJ1bGsgb3BlcmF0aW9ucyBhbmQgb3B0aW1pemF0aW9ucy4KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0sIG9wdGlvbnMpOwogICAgICB9CiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsKICAgICAgdGhpcy5fcmVzZXQoKTsKICAgICAgbW9kZWxzID0gdGhpcy5hZGQobW9kZWxzLCBfLmV4dGVuZCh7c2lsZW50OiB0cnVlfSwgb3B0aW9ucykpOwogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbHM7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBlbmQgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICByZXR1cm4gdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KHRoaXMubGVuZ3RoIC0gMSk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgdW5zaGlmdDogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7CiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uCiAgICBzbGljZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzbGljZS5hcHBseSh0aGlzLm1vZGVscywgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmpdIHx8IHRoaXMuX2J5SWRbb2JqLmlkXSB8fCB0aGlzLl9ieUlkW29iai5jaWRdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YKICAgIC8vIGBmaWx0ZXJgLgogICAgd2hlcmU6IGZ1bmN0aW9uKGF0dHJzLCBmaXJzdCkgewogICAgICBpZiAoXy5pc0VtcHR5KGF0dHJzKSkgcmV0dXJuIGZpcnN0ID8gdm9pZCAwIDogW107CiAgICAgIHJldHVybiB0aGlzW2ZpcnN0ID8gJ2ZpbmQnIDogJ2ZpbHRlciddKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBSZXR1cm4gdGhlIGZpcnN0IG1vZGVsIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMKICAgIC8vIG9mIGBmaW5kYC4KICAgIGZpbmRXaGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgcmV0dXJuIHRoaXMud2hlcmUoYXR0cnMsIHRydWUpOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsKICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKCiAgICAgIC8vIFJ1biBzb3J0IGJhc2VkIG9uIHR5cGUgb2YgYGNvbXBhcmF0b3JgLgogICAgICBpZiAoXy5pc1N0cmluZyh0aGlzLmNvbXBhcmF0b3IpIHx8IHRoaXMuY29tcGFyYXRvci5sZW5ndGggPT09IDEpIHsKICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5tb2RlbHMuc29ydChfLmJpbmQodGhpcy5jb21wYXJhdG9yLCB0aGlzKSk7CiAgICAgIH0KCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcignc29ydCcsIHRoaXMsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiBfLmludm9rZSh0aGlzLm1vZGVscywgJ2dldCcsIGF0dHIpOwogICAgfSwKCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUKICAgIC8vIGNvbGxlY3Rpb24gd2hlbiB0aGV5IGFycml2ZS4gSWYgYHJlc2V0OiB0cnVlYCBpcyBwYXNzZWQsIHRoZSByZXNwb25zZQogICAgLy8gZGF0YSB3aWxsIGJlIHBhc3NlZCB0aHJvdWdoIHRoZSBgcmVzZXRgIG1ldGhvZCBpbnN0ZWFkIG9mIGBzZXRgLgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOwogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVzZXQgPyAncmVzZXQnIDogJ3NldCc7CiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICAgIGNvbGxlY3Rpb24udHJpZ2dlcignc3luYycsIGNvbGxlY3Rpb24sIHJlc3AsIG9wdGlvbnMpOwogICAgICB9OwogICAgICB3cmFwRXJyb3IodGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzLnN5bmMoJ3JlYWQnLCB0aGlzLCBvcHRpb25zKTsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIGEgbW9kZWwgaW4gdGhpcyBjb2xsZWN0aW9uLiBBZGQgdGhlIG1vZGVsIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UKICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9OwogICAgICBpZiAoIShtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucykpKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSB0aGlzLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKG1vZGVsLCByZXNwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIG1vZGVsOwogICAgfSwKCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgaXQgdGhyb3VnaC4KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwLCBvcHRpb25zKSB7CiAgICAgIHJldHVybiByZXNwOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4KICAgIGNsb25lOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsKICAgIH0sCgogICAgLy8gUHJpdmF0ZSBtZXRob2QgdG8gcmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaXMgZmlyc3QgaW5pdGlhbGl6ZWQgb3IgcmVzZXQuCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmxlbmd0aCA9IDA7CiAgICAgIHRoaXMubW9kZWxzID0gW107CiAgICAgIHRoaXMuX2J5SWQgID0ge307CiAgICB9LAoKICAgIC8vIFByZXBhcmUgYSBoYXNoIG9mIGF0dHJpYnV0ZXMgKG9yIG90aGVyIG1vZGVsKSB0byBiZSBhZGRlZCB0byB0aGlzCiAgICAvLyBjb2xsZWN0aW9uLgogICAgX3ByZXBhcmVNb2RlbDogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsKICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHJldHVybiBhdHRyczsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC52YWxpZGF0aW9uRXJyb3IpIHJldHVybiBtb2RlbDsKICAgICAgdGhpcy50cmlnZ2VyKCdpbnZhbGlkJywgdGhpcywgbW9kZWwudmFsaWRhdGlvbkVycm9yLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4KICAgIF9hZGRSZWZlcmVuY2U6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIHRoaXMuX2J5SWRbbW9kZWwuY2lkXSA9IG1vZGVsOwogICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsKICAgICAgaWYgKCFtb2RlbC5jb2xsZWN0aW9uKSBtb2RlbC5jb2xsZWN0aW9uID0gdGhpczsKICAgICAgbW9kZWwub24oJ2FsbCcsIHRoaXMuX29uTW9kZWxFdmVudCwgdGhpcyk7CiAgICB9LAoKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXZlciBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgLy8gOTAlIG9mIHRoZSBjb3JlIHVzZWZ1bG5lc3Mgb2YgQmFja2JvbmUgQ29sbGVjdGlvbnMgaXMgYWN0dWFsbHkgaW1wbGVtZW50ZWQKICAvLyByaWdodCBoZXJlOgogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywKICAgICdpbmplY3QnLCAncmVkdWNlUmlnaHQnLCAnZm9sZHInLCAnZmluZCcsICdkZXRlY3QnLCAnZmlsdGVyJywgJ3NlbGVjdCcsCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsCiAgICAnbWF4JywgJ21pbicsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywgJ2luaXRpYWwnLCAncmVzdCcsCiAgICAndGFpbCcsICdkcm9wJywgJ2xhc3QnLCAnd2l0aG91dCcsICdkaWZmZXJlbmNlJywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsCiAgICAnbGFzdEluZGV4T2YnLCAnaXNFbXB0eScsICdjaGFpbicsICdzYW1wbGUnXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeScsICdpbmRleEJ5J107CgogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4KICBfLmVhY2goYXR0cmlidXRlTWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7CiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsKICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgICByZXR1cm4gbW9kZWwuZ2V0KHZhbHVlKTsKICAgICAgfTsKICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfTsKICB9KTsKCiAgLy8gQmFja2JvbmUuVmlldwogIC8vIC0tLS0tLS0tLS0tLS0KCiAgLy8gQmFja2JvbmUgVmlld3MgYXJlIGFsbW9zdCBtb3JlIGNvbnZlbnRpb24gdGhhbiB0aGV5IGFyZSBhY3R1YWwgY29kZS4gQSBWaWV3CiAgLy8gaXMgc2ltcGx5IGEgSmF2YVNjcmlwdCBvYmplY3QgdGhhdCByZXByZXNlbnRzIGEgbG9naWNhbCBjaHVuayBvZiBVSSBpbiB0aGUKICAvLyBET00uIFRoaXMgbWlnaHQgYmUgYSBzaW5nbGUgaXRlbSwgYW4gZW50aXJlIGxpc3QsIGEgc2lkZWJhciBvciBwYW5lbCwgb3IKICAvLyBldmVuIHRoZSBzdXJyb3VuZGluZyBmcmFtZSB3aGljaCB3cmFwcyB5b3VyIHdob2xlIGFwcC4gRGVmaW5pbmcgYSBjaHVuayBvZgogIC8vIFVJIGFzIGEgKipWaWV3KiogYWxsb3dzIHlvdSB0byBkZWZpbmUgeW91ciBET00gZXZlbnRzIGRlY2xhcmF0aXZlbHksIHdpdGhvdXQKICAvLyBoYXZpbmcgdG8gd29ycnkgYWJvdXQgcmVuZGVyIG9yZGVyIC4uLiBhbmQgbWFrZXMgaXQgZWFzeSBmb3IgdGhlIHZpZXcgdG8KICAvLyByZWFjdCB0byBzcGVjaWZpYyBjaGFuZ2VzIGluIHRoZSBzdGF0ZSBvZiB5b3VyIG1vZGVscy4KCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4KICB2YXIgVmlldyA9IEJhY2tib25lLlZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsKICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogIH07CgogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLgogIHZhciBkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIgPSAvXihcUyspXHMqKC4qKSQvOwoKICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4KICB2YXIgdmlld09wdGlvbnMgPSBbJ21vZGVsJywgJ2NvbGxlY3Rpb24nLCAnZWwnLCAnaWQnLCAnYXR0cmlidXRlcycsICdjbGFzc05hbWUnLCAndGFnTmFtZScsICdldmVudHMnXTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFZpZXcucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLgogICAgdGFnTmFtZTogJ2RpdicsCgogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlCiAgICAvLyBjdXJyZW50IHZpZXcuIFRoaXMgc2hvdWxkIGJlIHByZWZlcnJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4KICAgICQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsKICAgIH0sCgogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwKCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXIKICAgIC8vIHRvIHBvcHVsYXRlIGl0cyBlbGVtZW50IChgdGhpcy5lbGApLCB3aXRoIHRoZSBhcHByb3ByaWF0ZSBIVE1MLiBUaGUKICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gUmVtb3ZlIHRoaXMgdmlldyBieSB0YWtpbmcgdGhlIGVsZW1lbnQgb3V0IG9mIHRoZSBET00sIGFuZCByZW1vdmluZyBhbnkKICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnJlbW92ZSgpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudAogICAgLy8gcmUtZGVsZWdhdGlvbi4KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7CiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHRoaXMuJGVsID0gZWxlbWVudCBpbnN0YW5jZW9mIEJhY2tib25lLiQgPyBlbGVtZW50IDogQmFja2JvbmUuJChlbGVtZW50KTsKICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOwogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBTZXQgY2FsbGJhY2tzLCB3aGVyZSBgdGhpcy5ldmVudHNgIGlzIGEgaGFzaCBvZgogICAgLy8KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qCiAgICAvLwogICAgLy8gICAgIHsKICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywKICAgIC8vICAgICAgICdjbGljayAuYnV0dG9uJzogICAgICdzYXZlJywKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybiB0aGlzOwogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgICAgZm9yICh2YXIga2V5IGluIGV2ZW50cykgewogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsKICAgICAgICBpZiAoIW1ldGhvZCkgY29udGludWU7CgogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5vbihldmVudE5hbWUsIG1ldGhvZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuJGVsLm9uKGV2ZW50TmFtZSwgc2VsZWN0b3IsIG1ldGhvZCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQogICAgLy8gQmFja2JvbmUgdmlld3MgYXR0YWNoZWQgdG8gdGhlIHNhbWUgRE9NIGVsZW1lbnQuCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwub2ZmKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gRW5zdXJlIHRoYXQgdGhlIFZpZXcgaGFzIGEgRE9NIGVsZW1lbnQgdG8gcmVuZGVyIGludG8uCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QKICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUKICAgIC8vIGFuIGVsZW1lbnQgZnJvbSB0aGUgYGlkYCwgYGNsYXNzTmFtZWAgYW5kIGB0YWdOYW1lYCBwcm9wZXJ0aWVzLgogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgICB2YXIgYXR0cnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ2F0dHJpYnV0ZXMnKSk7CiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7CiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsKICAgICAgICB2YXIgJGVsID0gQmFja2JvbmUuJCgnPCcgKyBfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpICsgJz4nKS5hdHRyKGF0dHJzKTsKICAgICAgICB0aGlzLnNldEVsZW1lbnQoJGVsLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMKICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUKICAvLyBtb2RlbCBpbiBxdWVzdGlvbi4gQnkgZGVmYXVsdCwgbWFrZXMgYSBSRVNUZnVsIEFqYXggcmVxdWVzdAogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6CiAgLy8KICAvLyAqIFVzZSBgc2V0VGltZW91dGAgdG8gYmF0Y2ggcmFwaWQtZmlyZSB1cGRhdGVzIGludG8gYSBzaW5nbGUgcmVxdWVzdC4KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLgogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4LgogIC8vCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLAogIC8vIGFzIHdlbGwgYXMgYWxsIHJlcXVlc3RzIHdpdGggdGhlIGJvZHkgYXMgYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAKICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQogIC8vIGl0IGRpZmZpY3VsdCB0byByZWFkIHRoZSBib2R5IG9mIGBQVVRgIHJlcXVlc3RzLgogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOwoKICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgewogICAgICBlbXVsYXRlSFRUUDogQmFja2JvbmUuZW11bGF0ZUhUVFAsCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTgogICAgfSk7CgogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4KICAgIGlmICghb3B0aW9ucy51cmwpIHsKICAgICAgcGFyYW1zLnVybCA9IF8ucmVzdWx0KG1vZGVsLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgIH0KCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIHRoZSBhcHByb3ByaWF0ZSByZXF1ZXN0IGRhdGEuCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsKICAgICAgcGFyYW1zLmRhdGEgPSBKU09OLnN0cmluZ2lmeShvcHRpb25zLmF0dHJzIHx8IG1vZGVsLnRvSlNPTihvcHRpb25zKSk7CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSlNPTiBieSBlbmNvZGluZyB0aGUgcmVxdWVzdCBpbnRvIGFuIEhUTUwtZm9ybS4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOwogICAgICBwYXJhbXMuZGF0YSA9IHBhcmFtcy5kYXRhID8ge21vZGVsOiBwYXJhbXMuZGF0YX0gOiB7fTsKICAgIH0KCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBIVFRQIGJ5IG1pbWlja2luZyB0aGUgSFRUUCBtZXRob2Qgd2l0aCBgX21ldGhvZGAKICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLgogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7CiAgICAgIHBhcmFtcy50eXBlID0gJ1BPU1QnOwogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7CiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOwogICAgICBvcHRpb25zLmJlZm9yZVNlbmQgPSBmdW5jdGlvbih4aHIpIHsKICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOwogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9OwogICAgfQoKICAgIC8vIERvbid0IHByb2Nlc3MgZGF0YSBvbiBhIG5vbi1HRVQgcmVxdWVzdC4KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsKICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7CiAgICB9CgogICAgLy8gSWYgd2UncmUgc2VuZGluZyBhIGBQQVRDSGAgcmVxdWVzdCwgYW5kIHdlJ3JlIGluIGFuIG9sZCBJbnRlcm5ldCBFeHBsb3JlcgogICAgLy8gdGhhdCBzdGlsbCBoYXMgQWN0aXZlWCBlbmFibGVkIGJ5IGRlZmF1bHQsIG92ZXJyaWRlIGpRdWVyeSB0byB1c2UgdGhhdAogICAgLy8gZm9yIFhIUiBpbnN0ZWFkLiBSZW1vdmUgdGhpcyBsaW5lIHdoZW4galF1ZXJ5IHN1cHBvcnRzIGBQQVRDSGAgb24gSUU4LgogICAgaWYgKHBhcmFtcy50eXBlID09PSAnUEFUQ0gnICYmIG5vWGhyUGF0Y2gpIHsKICAgICAgcGFyYW1zLnhociA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLgogICAgdmFyIHhociA9IG9wdGlvbnMueGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsKICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIHJldHVybiB4aHI7CiAgfTsKCiAgdmFyIG5vWGhyUGF0Y2ggPQogICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgISF3aW5kb3cuQWN0aXZlWE9iamVjdCAmJgogICAgICAhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAobmV3IFhNTEh0dHBSZXF1ZXN0KS5kaXNwYXRjaEV2ZW50KTsKCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uCiAgdmFyIG1ldGhvZE1hcCA9IHsKICAgICdjcmVhdGUnOiAnUE9TVCcsCiAgICAndXBkYXRlJzogJ1BVVCcsCiAgICAncGF0Y2gnOiAgJ1BBVENIJywKICAgICdkZWxldGUnOiAnREVMRVRFJywKICAgICdyZWFkJzogICAnR0VUJwogIH07CgogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuCiAgLy8gT3ZlcnJpZGUgdGhpcyBpZiB5b3UnZCBsaWtlIHRvIHVzZSBhIGRpZmZlcmVudCBsaWJyYXJ5LgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBCYWNrYm9uZS5Sb3V0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUKICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5LgogIHZhciBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOwogICAgdGhpcy5fYmluZFJvdXRlcygpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZAogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuCiAgdmFyIG9wdGlvbmFsUGFyYW0gPSAvXCgoLio/KVwpL2c7CiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvKFwoXD8pPzpcdysvZzsKICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOwogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7CgogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToKICAgIC8vCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7CiAgICAvLyAgICAgICAuLi4KICAgIC8vICAgICB9KTsKICAgIC8vCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7CiAgICAgIGlmICghXy5pc1JlZ0V4cChyb3V0ZSkpIHJvdXRlID0gdGhpcy5fcm91dGVUb1JlZ0V4cChyb3V0ZSk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgICBjYWxsYmFjayA9IG5hbWU7CiAgICAgICAgbmFtZSA9ICcnOwogICAgICB9CiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsKICAgICAgdmFyIHJvdXRlciA9IHRoaXM7CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIGZ1bmN0aW9uKGZyYWdtZW50KSB7CiAgICAgICAgdmFyIGFyZ3MgPSByb3V0ZXIuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7CiAgICAgICAgcm91dGVyLmV4ZWN1dGUoY2FsbGJhY2ssIGFyZ3MpOwogICAgICAgIHJvdXRlci50cmlnZ2VyLmFwcGx5KHJvdXRlciwgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICByb3V0ZXIudHJpZ2dlcigncm91dGUnLCBuYW1lLCBhcmdzKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgcm91dGVyLCBuYW1lLCBhcmdzKTsKICAgICAgfSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBFeGVjdXRlIGEgcm91dGUgaGFuZGxlciB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzLiAgVGhpcyBpcyBhbgogICAgLy8gZXhjZWxsZW50IHBsYWNlIHRvIGRvIHByZS1yb3V0ZSBzZXR1cCBvciBwb3N0LXJvdXRlIGNsZWFudXAuCiAgICBleGVjdXRlOiBmdW5jdGlvbihjYWxsYmFjaywgYXJncykgewogICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgfSwKCiAgICAvLyBTaW1wbGUgcHJveHkgdG8gYEJhY2tib25lLmhpc3RvcnlgIHRvIHNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoaXN0b3J5LgogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQmluZCBhbGwgZGVmaW5lZCByb3V0ZXMgdG8gYEJhY2tib25lLmhpc3RvcnlgLiBXZSBoYXZlIHRvIHJldmVyc2UgdGhlCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLgogICAgX2JpbmRSb3V0ZXM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47CiAgICAgIHRoaXMucm91dGVzID0gXy5yZXN1bHQodGhpcywgJ3JvdXRlcycpOwogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7CiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsKICAgICAgICB0aGlzLnJvdXRlKHJvdXRlLCB0aGlzLnJvdXRlc1tyb3V0ZV0pOwogICAgICB9CiAgICB9LAoKICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guCiAgICBfcm91dGVUb1JlZ0V4cDogZnVuY3Rpb24ocm91dGUpIHsKICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2UobmFtZWRQYXJhbSwgZnVuY3Rpb24obWF0Y2gsIG9wdGlvbmFsKSB7CiAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25hbCA/IG1hdGNoIDogJyhbXi8/XSspJzsKICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKFteP10qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnKD86XFw/KFtcXHNcXFNdKikpPyQnKTsKICAgIH0sCgogICAgLy8gR2l2ZW4gYSByb3V0ZSwgYW5kIGEgVVJMIGZyYWdtZW50IHRoYXQgaXQgbWF0Y2hlcywgcmV0dXJuIHRoZSBhcnJheSBvZgogICAgLy8gZXh0cmFjdGVkIGRlY29kZWQgcGFyYW1ldGVycy4gRW1wdHkgb3IgdW5tYXRjaGVkIHBhcmFtZXRlcnMgd2lsbCBiZQogICAgLy8gdHJlYXRlZCBhcyBgbnVsbGAgdG8gbm9ybWFsaXplIGNyb3NzLWJyb3dzZXIgYmVoYXZpb3IuCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgewogICAgICB2YXIgcGFyYW1zID0gcm91dGUuZXhlYyhmcmFnbWVudCkuc2xpY2UoMSk7CiAgICAgIHJldHVybiBfLm1hcChwYXJhbXMsIGZ1bmN0aW9uKHBhcmFtLCBpKSB7CiAgICAgICAgLy8gRG9uJ3QgZGVjb2RlIHRoZSBzZWFyY2ggcGFyYW1zLgogICAgICAgIGlmIChpID09PSBwYXJhbXMubGVuZ3RoIC0gMSkgcmV0dXJuIHBhcmFtIHx8IG51bGw7CiAgICAgICAgcmV0dXJuIHBhcmFtID8gZGVjb2RlVVJJQ29tcG9uZW50KHBhcmFtKSA6IG51bGw7CiAgICAgIH0pOwogICAgfQoKICB9KTsKCiAgLy8gQmFja2JvbmUuSGlzdG9yeQogIC8vIC0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gZWl0aGVyCiAgLy8gW3B1c2hTdGF0ZV0oaHR0cDovL2RpdmVpbnRvaHRtbDUuaW5mby9oaXN0b3J5Lmh0bWwpIGFuZCByZWFsIFVSTHMsIG9yCiAgLy8gW29uaGFzaGNoYW5nZV0oaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9ET00vd2luZG93Lm9uaGFzaGNoYW5nZSkKICAvLyBhbmQgVVJMIGZyYWdtZW50cy4gSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgbmVpdGhlciAob2xkIElFLCBuYXRjaCksCiAgLy8gZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgdXJscyBvZiBoYXNoLgogIHZhciBwYXRoU3RyaXBwZXIgPSAvIy4qJC87CgogIC8vIEhhcyB0aGUgaGlzdG9yeSBoYW5kbGluZyBhbHJlYWR5IGJlZW4gc3RhcnRlZD8KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLkhpc3RvcnkqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLgogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBUaGUgZGVmYXVsdCBpbnRlcnZhbCB0byBwb2xsIGZvciBoYXNoIGNoYW5nZXMsIGlmIG5lY2Vzc2FyeSwgaXMKICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4KICAgIGludGVydmFsOiA1MCwKCiAgICAvLyBBcmUgd2UgYXQgdGhlIGFwcCByb290PwogICAgYXRSb290OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMubG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7CiAgICB9LAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IGRlY29kZVVSSSh0aGlzLmxvY2F0aW9uLnBhdGhuYW1lICsgdGhpcy5sb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7CiAgICAgICAgICBpZiAoIWZyYWdtZW50LmluZGV4T2Yocm9vdCkpIGZyYWdtZW50ID0gZnJhZ21lbnQuc2xpY2Uocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHtyb290OiAnLyd9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpOwogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsKICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOwogICAgICB0aGlzLl93YW50c1B1c2hTdGF0ZSAgPSAhIXRoaXMub3B0aW9ucy5wdXNoU3RhdGU7CiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOwogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIHZhciBkb2NNb2RlICAgICAgICAgICA9IGRvY3VtZW50LmRvY3VtZW50TW9kZTsKICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsKCiAgICAgIC8vIE5vcm1hbGl6ZSByb290IHRvIGFsd2F5cyBpbmNsdWRlIGEgbGVhZGluZyBhbmQgdHJhaWxpbmcgc2xhc2guCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOwoKICAgICAgaWYgKG9sZElFICYmIHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHZhciBmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSI+Jyk7CiAgICAgICAgdGhpcy5pZnJhbWUgPSBmcmFtZS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5vbigncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7CiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLm9uKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7CiAgICAgICAgdGhpcy5fY2hlY2tVcmxJbnRlcnZhbCA9IHNldEludGVydmFsKHRoaXMuY2hlY2tVcmwsIHRoaXMuaW50ZXJ2YWwpOwogICAgICB9CgogICAgICAvLyBEZXRlcm1pbmUgaWYgd2UgbmVlZCB0byBjaGFuZ2UgdGhlIGJhc2UgdXJsLCBmb3IgYSBwdXNoU3RhdGUgbGluawogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKICAgICAgdmFyIGxvYyA9IHRoaXMubG9jYXRpb247CgogICAgICAvLyBUcmFuc2l0aW9uIGZyb20gaGFzaENoYW5nZSB0byBwdXNoU3RhdGUgb3IgdmljZSB2ZXJzYSBpZiBib3RoIGFyZQogICAgICAvLyByZXF1ZXN0ZWQuCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUpIHsKCiAgICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkCiAgICAgICAgLy8gYnJvd3NlciwgYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4KICAgICAgICBpZiAoIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhdGhpcy5hdFJvb3QoKSkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwKICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAgIC8vIGluIGEgYnJvd3NlciB3aGVyZSBpdCBjb3VsZCBiZSBgcHVzaFN0YXRlYC1iYXNlZCBpbnN0ZWFkLi4uCiAgICAgICAgfSBlbHNlIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUgJiYgdGhpcy5hdFJvb3QoKSAmJiBsb2MuaGFzaCkgewogICAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpLnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOwogICAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQpOwogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOwogICAgfSwKCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwKICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLgogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIEJhY2tib25lLiQod2luZG93KS5vZmYoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkub2ZmKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7CiAgICAgIGlmICh0aGlzLl9jaGVja1VybEludGVydmFsKSBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOwogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsKICAgIH0sCgogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcgogICAgLy8gbWF5IG92ZXJyaWRlIHByZXZpb3VzIHJvdXRlcy4KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsKICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOwogICAgfSwKCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywKICAgIC8vIGNhbGxzIGBsb2FkVXJsYCwgbm9ybWFsaXppbmcgYWNyb3NzIHRoZSBoaWRkZW4gaWZyYW1lLgogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsKICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50ICYmIHRoaXMuaWZyYW1lKSB7CiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7CiAgICAgIH0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOwogICAgICB0aGlzLmxvYWRVcmwoKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudCkgewogICAgICBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50KTsKICAgICAgcmV0dXJuIF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nCiAgICAvLyB0aGUgZnJhZ21lbnQgaW4gYWR2YW5jZS4KICAgIC8vCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlCiAgICAvLyByb3V0ZSBjYWxsYmFjayBiZSBmaXJlZCAobm90IHVzdWFsbHkgZGVzaXJhYmxlKSwgb3IgYHJlcGxhY2U6IHRydWVgLCBpZgogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgewogICAgICBpZiAoIUhpc3Rvcnkuc3RhcnRlZCkgcmV0dXJuIGZhbHNlOwogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiAhIW9wdGlvbnN9OwoKICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIChmcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQoZnJhZ21lbnQgfHwgJycpKTsKCiAgICAgIC8vIFN0cmlwIHRoZSBoYXNoIGZvciBtYXRjaGluZy4KICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKHBhdGhTdHJpcHBlciwgJycpOwoKICAgICAgaWYgKHRoaXMuZnJhZ21lbnQgPT09IGZyYWdtZW50KSByZXR1cm47CiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsKCiAgICAgIC8vIERvbid0IGluY2x1ZGUgYSB0cmFpbGluZyBzbGFzaCBvbiB0aGUgcm9vdC4KICAgICAgaWYgKGZyYWdtZW50ID09PSAnJyAmJiB1cmwgIT09ICcvJykgdXJsID0gdXJsLnNsaWNlKDAsIC0xKTsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSByZXR1cm4gdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgIH0sCgogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcKICAgIC8vIGEgbmV3IG9uZSB0byB0aGUgYnJvd3NlciBoaXN0b3J5LgogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgewogICAgICBpZiAocmVwbGFjZSkgewogICAgICAgIHZhciBocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKC8oamF2YXNjcmlwdDp8IykuKiQvLCAnJyk7CiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIFNvbWUgYnJvd3NlcnMgcmVxdWlyZSB0aGF0IGBoYXNoYCBjb250YWlucyBhIGxlYWRpbmcgIy4KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5LgogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsKCiAgLy8gSGVscGVycwogIC8vIC0tLS0tLS0KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuCiAgLy8gU2ltaWxhciB0byBgZ29vZy5pbmhlcml0c2AsIGJ1dCB1c2VzIGEgaGFzaCBvZiBwcm90b3R5cGUgcHJvcGVydGllcyBhbmQKICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLgogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgewogICAgdmFyIHBhcmVudCA9IHRoaXM7CiAgICB2YXIgY2hpbGQ7CgogICAgLy8gVGhlIGNvbnN0cnVjdG9yIGZ1bmN0aW9uIGZvciB0aGUgbmV3IHN1YmNsYXNzIGlzIGVpdGhlciBkZWZpbmVkIGJ5IHlvdQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZAogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLgogICAgaWYgKHByb3RvUHJvcHMgJiYgXy5oYXMocHJvdG9Qcm9wcywgJ2NvbnN0cnVjdG9yJykpIHsKICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOwogICAgfSBlbHNlIHsKICAgICAgY2hpbGQgPSBmdW5jdGlvbigpeyByZXR1cm4gcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07CiAgICB9CgogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuCiAgICBfLmV4dGVuZChjaGlsZCwgcGFyZW50LCBzdGF0aWNQcm9wcyk7CgogICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcKICAgIC8vIGBwYXJlbnRgJ3MgY29uc3RydWN0b3IgZnVuY3Rpb24uCiAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9OwogICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7CiAgICBjaGlsZC5wcm90b3R5cGUgPSBuZXcgU3Vycm9nYXRlOwoKICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLAogICAgLy8gaWYgc3VwcGxpZWQuCiAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsKCiAgICAvLyBTZXQgYSBjb252ZW5pZW5jZSBwcm9wZXJ0eSBpbiBjYXNlIHRoZSBwYXJlbnQncyBwcm90b3R5cGUgaXMgbmVlZGVkCiAgICAvLyBsYXRlci4KICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7CgogICAgcmV0dXJuIGNoaWxkOwogIH07CgogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsKCiAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLgogIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCdBICJ1cmwiIHByb3BlcnR5IG9yIGZ1bmN0aW9uIG11c3QgYmUgc3BlY2lmaWVkJyk7CiAgfTsKCiAgLy8gV3JhcCBhbiBvcHRpb25hbCBlcnJvciBjYWxsYmFjayB3aXRoIGEgZmFsbGJhY2sgZXJyb3IgZXZlbnQuCiAgdmFyIHdyYXBFcnJvciA9IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHJlc3ApIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIG1vZGVsLnRyaWdnZXIoJ2Vycm9yJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKICB9OwoKICByZXR1cm4gQmFja2JvbmU7Cgp9KSk7CgovLyBNYXJpb25ldHRlSlMgKEJhY2tib25lLk1hcmlvbmV0dGUpCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gdjIuMi4wCi8vCi8vIENvcHlyaWdodCAoYykyMDE0IERlcmljayBCYWlsZXksIE11dGVkIFNvbHV0aW9ucywgTExDLgovLyBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQovLwovLyBodHRwOi8vbWFyaW9uZXR0ZWpzLmNvbQoKCi8qIQogKiBJbmNsdWRlcyBCYWJ5U2l0dGVyCiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUuYmFieXNpdHRlci8KICoKICogSW5jbHVkZXMgV3JlcXIKICogaHR0cHM6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxci8KICovCgoKKGZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICBpZiAodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoWydiYWNrYm9uZScsICd1bmRlcnNjb3JlJ10sIGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7CiAgICAgIHJldHVybiAocm9vdC5NYXJpb25ldHRlID0gZmFjdG9yeShyb290LCBCYWNrYm9uZSwgXykpOwogICAgfSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHZhciBCYWNrYm9uZSA9IHJlcXVpcmUoJ2JhY2tib25lJyk7CiAgICB2YXIgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeShyb290LCBCYWNrYm9uZSwgXyk7CiAgfSBlbHNlIHsKICAgIHJvb3QuTWFyaW9uZXR0ZSA9IGZhY3Rvcnkocm9vdCwgcm9vdC5CYWNrYm9uZSwgcm9vdC5fKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKHJvb3QsIEJhY2tib25lLCBfKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogIC8vIEJhY2tib25lLkJhYnlTaXR0ZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gdjAuMS40CiAgLy8KICAvLyBDb3B5cmlnaHQgKGMpMjAxNCBEZXJpY2sgQmFpbGV5LCBNdXRlZCBTb2x1dGlvbnMsIExMQy4KICAvLyBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQogIC8vCiAgLy8gaHR0cDovL2dpdGh1Yi5jb20vbWFyaW9uZXR0ZWpzL2JhY2tib25lLmJhYnlzaXR0ZXIKICAoZnVuY3Rpb24oQmFja2JvbmUsIF8pIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBwcmV2aW91c0NoaWxkVmlld0NvbnRhaW5lciA9IEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lcjsKICAgIC8vIEJhYnlTaXR0ZXIuQ2hpbGRWaWV3Q29udGFpbmVyCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8KICAgIC8vIFByb3ZpZGUgYSBjb250YWluZXIgdG8gc3RvcmUsIHJldHJpZXZlIGFuZAogICAgLy8gc2h1dCBkb3duIGNoaWxkIHZpZXdzLgogICAgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyID0gZnVuY3Rpb24oQmFja2JvbmUsIF8pIHsKICAgICAgLy8gQ29udGFpbmVyIENvbnN0cnVjdG9yCiAgICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgICB2YXIgQ29udGFpbmVyID0gZnVuY3Rpb24odmlld3MpIHsKICAgICAgICB0aGlzLl92aWV3cyA9IHt9OwogICAgICAgIHRoaXMuX2luZGV4QnlNb2RlbCA9IHt9OwogICAgICAgIHRoaXMuX2luZGV4QnlDdXN0b20gPSB7fTsKICAgICAgICB0aGlzLl91cGRhdGVMZW5ndGgoKTsKICAgICAgICBfLmVhY2godmlld3MsIHRoaXMuYWRkLCB0aGlzKTsKICAgICAgfTsKICAgICAgLy8gQ29udGFpbmVyIE1ldGhvZHMKICAgICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAgICAgXy5leHRlbmQoQ29udGFpbmVyLnByb3RvdHlwZSwgewogICAgICAgIC8vIEFkZCBhIHZpZXcgdG8gdGhpcyBjb250YWluZXIuIFN0b3JlcyB0aGUgdmlldwogICAgICAgIC8vIGJ5IGBjaWRgIGFuZCBtYWtlcyBpdCBzZWFyY2hhYmxlIGJ5IHRoZSBtb2RlbAogICAgICAgIC8vIGNpZCAoYW5kIG1vZGVsIGl0c2VsZikuIE9wdGlvbmFsbHkgc3BlY2lmeQogICAgICAgIC8vIGEgY3VzdG9tIGtleSB0byBzdG9yZSBhbiByZXRyaWV2ZSB0aGUgdmlldy4KICAgICAgICBhZGQ6IGZ1bmN0aW9uKHZpZXcsIGN1c3RvbUluZGV4KSB7CiAgICAgICAgICB2YXIgdmlld0NpZCA9IHZpZXcuY2lkOwogICAgICAgICAgLy8gc3RvcmUgdGhlIHZpZXcKICAgICAgICAgIHRoaXMuX3ZpZXdzW3ZpZXdDaWRdID0gdmlldzsKICAgICAgICAgIC8vIGluZGV4IGl0IGJ5IG1vZGVsCiAgICAgICAgICBpZiAodmlldy5tb2RlbCkgewogICAgICAgICAgICB0aGlzLl9pbmRleEJ5TW9kZWxbdmlldy5tb2RlbC5jaWRdID0gdmlld0NpZDsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGluZGV4IGJ5IGN1c3RvbQogICAgICAgICAgaWYgKGN1c3RvbUluZGV4KSB7CiAgICAgICAgICAgIHRoaXMuX2luZGV4QnlDdXN0b21bY3VzdG9tSW5kZXhdID0gdmlld0NpZDsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX3VwZGF0ZUxlbmd0aCgpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBGaW5kIGEgdmlldyBieSB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgICAvLyBpdC4gVXNlcyB0aGUgbW9kZWwncyBgY2lkYCB0byBmaW5kIGl0LgogICAgICAgIGZpbmRCeU1vZGVsOiBmdW5jdGlvbihtb2RlbCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5TW9kZWxDaWQobW9kZWwuY2lkKTsKICAgICAgICB9LAogICAgICAgIC8vIEZpbmQgYSB2aWV3IGJ5IHRoZSBgY2lkYCBvZiB0aGUgbW9kZWwgdGhhdCB3YXMgYXR0YWNoZWQgdG8KICAgICAgICAvLyBpdC4gVXNlcyB0aGUgbW9kZWwncyBgY2lkYCB0byBmaW5kIHRoZSB2aWV3IGBjaWRgIGFuZAogICAgICAgIC8vIHJldHJpZXZlIHRoZSB2aWV3IHVzaW5nIGl0LgogICAgICAgIGZpbmRCeU1vZGVsQ2lkOiBmdW5jdGlvbihtb2RlbENpZCkgewogICAgICAgICAgdmFyIHZpZXdDaWQgPSB0aGlzLl9pbmRleEJ5TW9kZWxbbW9kZWxDaWRdOwogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBhIHZpZXcgYnkgYSBjdXN0b20gaW5kZXhlci4KICAgICAgICBmaW5kQnlDdXN0b206IGZ1bmN0aW9uKGluZGV4KSB7CiAgICAgICAgICB2YXIgdmlld0NpZCA9IHRoaXMuX2luZGV4QnlDdXN0b21baW5kZXhdOwogICAgICAgICAgcmV0dXJuIHRoaXMuZmluZEJ5Q2lkKHZpZXdDaWQpOwogICAgICAgIH0sCiAgICAgICAgLy8gRmluZCBieSBpbmRleC4gVGhpcyBpcyBub3QgZ3VhcmFudGVlZCB0byBiZSBhCiAgICAgICAgLy8gc3RhYmxlIGluZGV4LgogICAgICAgIGZpbmRCeUluZGV4OiBmdW5jdGlvbihpbmRleCkgewogICAgICAgICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuX3ZpZXdzKVtpbmRleF07CiAgICAgICAgfSwKICAgICAgICAvLyByZXRyaWV2ZSBhIHZpZXcgYnkgaXRzIGBjaWRgIGRpcmVjdGx5CiAgICAgICAgZmluZEJ5Q2lkOiBmdW5jdGlvbihjaWQpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl92aWV3c1tjaWRdOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgdmlldwogICAgICAgIHJlbW92ZTogZnVuY3Rpb24odmlldykgewogICAgICAgICAgdmFyIHZpZXdDaWQgPSB2aWV3LmNpZDsKICAgICAgICAgIC8vIGRlbGV0ZSBtb2RlbCBpbmRleAogICAgICAgICAgaWYgKHZpZXcubW9kZWwpIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4QnlNb2RlbFt2aWV3Lm1vZGVsLmNpZF07CiAgICAgICAgICB9CiAgICAgICAgICAvLyBkZWxldGUgY3VzdG9tIGluZGV4CiAgICAgICAgICBfLmFueSh0aGlzLl9pbmRleEJ5Q3VzdG9tLCBmdW5jdGlvbihjaWQsIGtleSkgewogICAgICAgICAgICBpZiAoY2lkID09PSB2aWV3Q2lkKSB7CiAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2luZGV4QnlDdXN0b21ba2V5XTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgICAvLyByZW1vdmUgdGhlIHZpZXcgZnJvbSB0aGUgY29udGFpbmVyCiAgICAgICAgICBkZWxldGUgdGhpcy5fdmlld3Nbdmlld0NpZF07CiAgICAgICAgICAvLyB1cGRhdGUgdGhlIGxlbmd0aAogICAgICAgICAgdGhpcy5fdXBkYXRlTGVuZ3RoKCk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYSBtZXRob2Qgb24gZXZlcnkgdmlldyBpbiB0aGUgY29udGFpbmVyLAogICAgICAgIC8vIHBhc3NpbmcgcGFyYW1ldGVycyB0byB0aGUgY2FsbCBtZXRob2Qgb25lIGF0IGEKICAgICAgICAvLyB0aW1lLCBsaWtlIGBmdW5jdGlvbi5jYWxsYC4KICAgICAgICBjYWxsOiBmdW5jdGlvbihtZXRob2QpIHsKICAgICAgICAgIHRoaXMuYXBwbHkobWV0aG9kLCBfLnRhaWwoYXJndW1lbnRzKSk7CiAgICAgICAgfSwKICAgICAgICAvLyBBcHBseSBhIG1ldGhvZCBvbiBldmVyeSB2aWV3IGluIHRoZSBjb250YWluZXIsCiAgICAgICAgLy8gcGFzc2luZyBwYXJhbWV0ZXJzIHRvIHRoZSBjYWxsIG1ldGhvZCBvbmUgYXQgYQogICAgICAgIC8vIHRpbWUsIGxpa2UgYGZ1bmN0aW9uLmFwcGx5YC4KICAgICAgICBhcHBseTogZnVuY3Rpb24obWV0aG9kLCBhcmdzKSB7CiAgICAgICAgICBfLmVhY2godGhpcy5fdmlld3MsIGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbih2aWV3W21ldGhvZF0pKSB7CiAgICAgICAgICAgICAgdmlld1ttZXRob2RdLmFwcGx5KHZpZXcsIGFyZ3MgfHwgW10pOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICB9LAogICAgICAgIC8vIFVwZGF0ZSB0aGUgYC5sZW5ndGhgIGF0dHJpYnV0ZSBvbiB0aGlzIGNvbnRhaW5lcgogICAgICAgIF91cGRhdGVMZW5ndGg6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5sZW5ndGggPSBfLnNpemUodGhpcy5fdmlld3MpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogICAgICAvLyBodHRwOi8vYmFja2JvbmVqcy5vcmcvZG9jcy9iYWNrYm9uZS5odG1sI3NlY3Rpb24tMTA2CiAgICAgIC8vCiAgICAgIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgICAgIC8vIGNvbGxlY3Rpb24gcmVsYXRlZCBmZWF0dXJlcy4KICAgICAgdmFyIG1ldGhvZHMgPSBbICJmb3JFYWNoIiwgImVhY2giLCAibWFwIiwgImZpbmQiLCAiZGV0ZWN0IiwgImZpbHRlciIsICJzZWxlY3QiLCAicmVqZWN0IiwgImV2ZXJ5IiwgImFsbCIsICJzb21lIiwgImFueSIsICJpbmNsdWRlIiwgImNvbnRhaW5zIiwgImludm9rZSIsICJ0b0FycmF5IiwgImZpcnN0IiwgImluaXRpYWwiLCAicmVzdCIsICJsYXN0IiwgIndpdGhvdXQiLCAiaXNFbXB0eSIsICJwbHVjayIgXTsKICAgICAgXy5lYWNoKG1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgICAgIENvbnRhaW5lci5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHZpZXdzID0gXy52YWx1ZXModGhpcy5fdmlld3MpOwogICAgICAgICAgdmFyIGFyZ3MgPSBbIHZpZXdzIF0uY29uY2F0KF8udG9BcnJheShhcmd1bWVudHMpKTsKICAgICAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfSk7CiAgICAgIC8vIHJldHVybiB0aGUgcHVibGljIEFQSQogICAgICByZXR1cm4gQ29udGFpbmVyOwogICAgfShCYWNrYm9uZSwgXyk7CiAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIuVkVSU0lPTiA9ICIwLjEuNCI7CiAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgICBCYWNrYm9uZS5DaGlsZFZpZXdDb250YWluZXIgPSBwcmV2aW91c0NoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgcmV0dXJuIEJhY2tib25lLkNoaWxkVmlld0NvbnRhaW5lcjsKICB9KShCYWNrYm9uZSwgXyk7CgogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCiAgLy8gQmFja2JvbmUuV3JlcXIgKEJhY2tib25lLk1hcmlvbmV0dGUpCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogIC8vIHYxLjMuMQogIC8vCiAgLy8gQ29weXJpZ2h0IChjKTIwMTQgRGVyaWNrIEJhaWxleSwgTXV0ZWQgU29sdXRpb25zLCBMTEMuCiAgLy8gRGlzdHJpYnV0ZWQgdW5kZXIgTUlUIGxpY2Vuc2UKICAvLwogIC8vIGh0dHA6Ly9naXRodWIuY29tL21hcmlvbmV0dGVqcy9iYWNrYm9uZS53cmVxcgogIChmdW5jdGlvbihCYWNrYm9uZSwgXykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIHByZXZpb3VzV3JlcXIgPSBCYWNrYm9uZS5XcmVxcjsKICAgIHZhciBXcmVxciA9IEJhY2tib25lLldyZXFyID0ge307CiAgICBCYWNrYm9uZS5XcmVxci5WRVJTSU9OID0gIjEuMy4xIjsKICAgIEJhY2tib25lLldyZXFyLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuV3JlcXIgPSBwcmV2aW91c1dyZXFyOwogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICAvLyBIYW5kbGVycwogICAgLy8gLS0tLS0tLS0KICAgIC8vIEEgcmVnaXN0cnkgb2YgZnVuY3Rpb25zIHRvIGNhbGwsIGdpdmVuIGEgbmFtZQogICAgV3JlcXIuSGFuZGxlcnMgPSBmdW5jdGlvbihCYWNrYm9uZSwgXykgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIC8vIENvbnN0cnVjdG9yCiAgICAgIC8vIC0tLS0tLS0tLS0tCiAgICAgIHZhciBIYW5kbGVycyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnMgPSB7fTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIEhhbmRsZXJzLmV4dGVuZCA9IEJhY2tib25lLk1vZGVsLmV4dGVuZDsKICAgICAgLy8gSW5zdGFuY2UgTWVtYmVycwogICAgICAvLyAtLS0tLS0tLS0tLS0tLS0tCiAgICAgIF8uZXh0ZW5kKEhhbmRsZXJzLnByb3RvdHlwZSwgQmFja2JvbmUuRXZlbnRzLCB7CiAgICAgICAgLy8gQWRkIG11bHRpcGxlIGhhbmRsZXJzIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIGNvbmZpZ3VyYXRpb24KICAgICAgICBzZXRIYW5kbGVyczogZnVuY3Rpb24oaGFuZGxlcnMpIHsKICAgICAgICAgIF8uZWFjaChoYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlciwgbmFtZSkgewogICAgICAgICAgICB2YXIgY29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KGhhbmRsZXIpICYmICFfLmlzRnVuY3Rpb24oaGFuZGxlcikpIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gaGFuZGxlci5jb250ZXh0OwogICAgICAgICAgICAgIGhhbmRsZXIgPSBoYW5kbGVyLmNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuc2V0SGFuZGxlcihuYW1lLCBoYW5kbGVyLCBjb250ZXh0KTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0sCiAgICAgICAgLy8gQWRkIGEgaGFuZGxlciBmb3IgdGhlIGdpdmVuIG5hbWUsIHdpdGggYW4KICAgICAgICAvLyBvcHRpb25hbCBjb250ZXh0IHRvIHJ1biB0aGUgaGFuZGxlciB3aXRoaW4KICAgICAgICBzZXRIYW5kbGVyOiBmdW5jdGlvbihuYW1lLCBoYW5kbGVyLCBjb250ZXh0KSB7CiAgICAgICAgICB2YXIgY29uZmlnID0gewogICAgICAgICAgICBjYWxsYmFjazogaGFuZGxlciwKICAgICAgICAgICAgY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV0gPSBjb25maWc7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImhhbmRsZXI6YWRkIiwgbmFtZSwgaGFuZGxlciwgY29udGV4dCk7CiAgICAgICAgfSwKICAgICAgICAvLyBEZXRlcm1pbmUgd2hldGhlciBvciBub3QgYSBoYW5kbGVyIGlzIHJlZ2lzdGVyZWQKICAgICAgICBoYXNIYW5kbGVyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICByZXR1cm4gISF0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIH0sCiAgICAgICAgLy8gR2V0IHRoZSBjdXJyZW50bHkgcmVnaXN0ZXJlZCBoYW5kbGVyIGZvcgogICAgICAgIC8vIHRoZSBzcGVjaWZpZWQgbmFtZS4gVGhyb3dzIGFuIGV4Y2VwdGlvbiBpZgogICAgICAgIC8vIG5vIGhhbmRsZXIgaXMgZm91bmQuCiAgICAgICAgZ2V0SGFuZGxlcjogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgdmFyIGNvbmZpZyA9IHRoaXMuX3dyZXFySGFuZGxlcnNbbmFtZV07CiAgICAgICAgICBpZiAoIWNvbmZpZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIHJldHVybiBjb25maWcuY2FsbGJhY2suYXBwbHkoY29uZmlnLmNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfTsKICAgICAgICB9LAogICAgICAgIC8vIFJlbW92ZSBhIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgbmFtZQogICAgICAgIHJlbW92ZUhhbmRsZXI6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLl93cmVxckhhbmRsZXJzW25hbWVdOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoaXMgcmVnaXN0cnkKICAgICAgICByZW1vdmVBbGxIYW5kbGVyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLl93cmVxckhhbmRsZXJzID0ge307CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIEhhbmRsZXJzOwogICAgfShCYWNrYm9uZSwgXyk7CiAgICAvLyBXcmVxci5Db21tYW5kU3RvcmFnZQogICAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBTdG9yZSBhbmQgcmV0cmlldmUgY29tbWFuZHMgZm9yIGV4ZWN1dGlvbi4KICAgIFdyZXFyLkNvbW1hbmRTdG9yYWdlID0gZnVuY3Rpb24oKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgLy8gQ29uc3RydWN0b3IgZnVuY3Rpb24KICAgICAgdmFyIENvbW1hbmRTdG9yYWdlID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgdGhpcy5fY29tbWFuZHMgPSB7fTsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMuaW5pdGlhbGl6ZSkpIHsKICAgICAgICAgIHRoaXMuaW5pdGlhbGl6ZShvcHRpb25zKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgICAgXy5leHRlbmQoQ29tbWFuZFN0b3JhZ2UucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgICAvLyBHZXQgYW4gb2JqZWN0IGxpdGVyYWwgYnkgY29tbWFuZCBuYW1lLCB0aGF0IGNvbnRhaW5zCiAgICAgICAgLy8gdGhlIGBjb21tYW5kTmFtZWAgYW5kIHRoZSBgaW5zdGFuY2VzYCBvZiBhbGwgY29tbWFuZHMKICAgICAgICAvLyByZXByZXNlbnRlZCBhcyBhbiBhcnJheSBvZiBhcmd1bWVudHMgdG8gcHJvY2VzcwogICAgICAgIGdldENvbW1hbmRzOiBmdW5jdGlvbihjb21tYW5kTmFtZSkgewogICAgICAgICAgdmFyIGNvbW1hbmRzID0gdGhpcy5fY29tbWFuZHNbY29tbWFuZE5hbWVdOwogICAgICAgICAgLy8gd2UgZG9uJ3QgaGF2ZSBpdCwgc28gYWRkIGl0CiAgICAgICAgICBpZiAoIWNvbW1hbmRzKSB7CiAgICAgICAgICAgIC8vIGJ1aWxkIHRoZSBjb25maWd1cmF0aW9uCiAgICAgICAgICAgIGNvbW1hbmRzID0gewogICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLAogICAgICAgICAgICAgIGluc3RhbmNlczogW10KICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gc3RvcmUgaXQKICAgICAgICAgICAgdGhpcy5fY29tbWFuZHNbY29tbWFuZE5hbWVdID0gY29tbWFuZHM7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29tbWFuZHM7CiAgICAgICAgfSwKICAgICAgICAvLyBBZGQgYSBjb21tYW5kIGJ5IG5hbWUsIHRvIHRoZSBzdG9yYWdlIGFuZCBzdG9yZSB0aGUKICAgICAgICAvLyBhcmdzIGZvciB0aGUgY29tbWFuZAogICAgICAgIGFkZENvbW1hbmQ6IGZ1bmN0aW9uKGNvbW1hbmROYW1lLCBhcmdzKSB7CiAgICAgICAgICB2YXIgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZHMoY29tbWFuZE5hbWUpOwogICAgICAgICAgY29tbWFuZC5pbnN0YW5jZXMucHVzaChhcmdzKTsKICAgICAgICB9LAogICAgICAgIC8vIENsZWFyIGFsbCBjb21tYW5kcyBmb3IgdGhlIGdpdmVuIGBjb21tYW5kTmFtZWAKICAgICAgICBjbGVhckNvbW1hbmRzOiBmdW5jdGlvbihjb21tYW5kTmFtZSkgewogICAgICAgICAgdmFyIGNvbW1hbmQgPSB0aGlzLmdldENvbW1hbmRzKGNvbW1hbmROYW1lKTsKICAgICAgICAgIGNvbW1hbmQuaW5zdGFuY2VzID0gW107CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIENvbW1hbmRTdG9yYWdlOwogICAgfSgpOwogICAgLy8gV3JlcXIuQ29tbWFuZHMKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgICAvLwogICAgLy8gQSBzaW1wbGUgY29tbWFuZCBwYXR0ZXJuIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhIGNvbW1hbmQKICAgIC8vIGhhbmRsZXIgYW5kIGV4ZWN1dGUgaXQuCiAgICBXcmVxci5Db21tYW5kcyA9IGZ1bmN0aW9uKFdyZXFyKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgcmV0dXJuIFdyZXFyLkhhbmRsZXJzLmV4dGVuZCh7CiAgICAgICAgLy8gZGVmYXVsdCBzdG9yYWdlIHR5cGUKICAgICAgICBzdG9yYWdlVHlwZTogV3JlcXIuQ29tbWFuZFN0b3JhZ2UsCiAgICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgICAgICB0aGlzLl9pbml0aWFsaXplU3RvcmFnZSh0aGlzLm9wdGlvbnMpOwogICAgICAgICAgdGhpcy5vbigiaGFuZGxlcjphZGQiLCB0aGlzLl9leGVjdXRlQ29tbWFuZHMsIHRoaXMpOwogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgICAgV3JlcXIuSGFuZGxlcnMucHJvdG90eXBlLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0sCiAgICAgICAgLy8gRXhlY3V0ZSBhIG5hbWVkIGNvbW1hbmQgd2l0aCB0aGUgc3VwcGxpZWQgYXJncwogICAgICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKG5hbWUsIGFyZ3MpIHsKICAgICAgICAgIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKICAgICAgICAgIGlmICh0aGlzLmhhc0hhbmRsZXIobmFtZSkpIHsKICAgICAgICAgICAgdGhpcy5nZXRIYW5kbGVyKG5hbWUpLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5zdG9yYWdlLmFkZENvbW1hbmQobmFtZSwgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaGFuZGxlIGJ1bGsgZXhlY3V0aW9uIG9mIHN0b3JlZCBjb21tYW5kcwogICAgICAgIF9leGVjdXRlQ29tbWFuZHM6IGZ1bmN0aW9uKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICAgICAgICAgIHZhciBjb21tYW5kID0gdGhpcy5zdG9yYWdlLmdldENvbW1hbmRzKG5hbWUpOwogICAgICAgICAgLy8gbG9vcCB0aHJvdWdoIGFuZCBleGVjdXRlIGFsbCB0aGUgc3RvcmVkIGNvbW1hbmQgaW5zdGFuY2VzCiAgICAgICAgICBfLmVhY2goY29tbWFuZC5pbnN0YW5jZXMsIGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICAgICAgaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdGhpcy5zdG9yYWdlLmNsZWFyQ29tbWFuZHMobmFtZSk7CiAgICAgICAgfSwKICAgICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gaW5pdGlhbGl6ZSBzdG9yYWdlIGVpdGhlciBmcm9tIHRoZSB0eXBlJ3MKICAgICAgICAvLyBgc3RvcmFnZVR5cGVgIG9yIHRoZSBpbnN0YW5jZSBgb3B0aW9ucy5zdG9yYWdlVHlwZWAuCiAgICAgICAgX2luaXRpYWxpemVTdG9yYWdlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICB2YXIgc3RvcmFnZTsKICAgICAgICAgIHZhciBTdG9yYWdlVHlwZSA9IG9wdGlvbnMuc3RvcmFnZVR5cGUgfHwgdGhpcy5zdG9yYWdlVHlwZTsKICAgICAgICAgIGlmIChfLmlzRnVuY3Rpb24oU3RvcmFnZVR5cGUpKSB7CiAgICAgICAgICAgIHN0b3JhZ2UgPSBuZXcgU3RvcmFnZVR5cGUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0b3JhZ2UgPSBTdG9yYWdlVHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0oV3JlcXIpOwogICAgLy8gV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBBIHNpbXBsZSByZXF1ZXN0L3Jlc3BvbnNlIGltcGxlbWVudGF0aW9uLiBSZWdpc3RlciBhCiAgICAvLyByZXF1ZXN0IGhhbmRsZXIsIGFuZCByZXR1cm4gYSByZXNwb25zZSBmcm9tIGl0CiAgICBXcmVxci5SZXF1ZXN0UmVzcG9uc2UgPSBmdW5jdGlvbihXcmVxcikgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHJldHVybiBXcmVxci5IYW5kbGVycy5leHRlbmQoewogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgICAgICBpZiAodGhpcy5oYXNIYW5kbGVyKG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldEhhbmRsZXIobmFtZSkuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0oV3JlcXIpOwogICAgLy8gRXZlbnQgQWdncmVnYXRvcgogICAgLy8gLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gQSBwdWItc3ViIG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIHRvIGRlY291cGxlIHZhcmlvdXMgcGFydHMKICAgIC8vIG9mIGFuIGFwcGxpY2F0aW9uIHRocm91Z2ggZXZlbnQtZHJpdmVuIGFyY2hpdGVjdHVyZS4KICAgIFdyZXFyLkV2ZW50QWdncmVnYXRvciA9IGZ1bmN0aW9uKEJhY2tib25lLCBfKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIEVBID0gZnVuY3Rpb24oKSB7fTsKICAgICAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICAgICAgRUEuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogICAgICAvLyBDb3B5IHRoZSBiYXNpYyBCYWNrYm9uZS5FdmVudHMgb24gdG8gdGhlIGV2ZW50IGFnZ3JlZ2F0b3IKICAgICAgXy5leHRlbmQoRUEucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMpOwogICAgICByZXR1cm4gRUE7CiAgICB9KEJhY2tib25lLCBfKTsKICAgIC8vIFdyZXFyLkNoYW5uZWwKICAgIC8vIC0tLS0tLS0tLS0tLS0tCiAgICAvLwogICAgLy8gQW4gb2JqZWN0IHRoYXQgd3JhcHMgdGhlIHRocmVlIG1lc3NhZ2luZyBzeXN0ZW1zOgogICAgLy8gRXZlbnRBZ2dyZWdhdG9yLCBSZXF1ZXN0UmVzcG9uc2UsIENvbW1hbmRzCiAgICBXcmVxci5DaGFubmVsID0gZnVuY3Rpb24oV3JlcXIpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgQ2hhbm5lbCA9IGZ1bmN0aW9uKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgdGhpcy52ZW50ID0gbmV3IEJhY2tib25lLldyZXFyLkV2ZW50QWdncmVnYXRvcigpOwogICAgICAgIHRoaXMucmVxcmVzID0gbmV3IEJhY2tib25lLldyZXFyLlJlcXVlc3RSZXNwb25zZSgpOwogICAgICAgIHRoaXMuY29tbWFuZHMgPSBuZXcgQmFja2JvbmUuV3JlcXIuQ29tbWFuZHMoKTsKICAgICAgICB0aGlzLmNoYW5uZWxOYW1lID0gY2hhbm5lbE5hbWU7CiAgICAgIH07CiAgICAgIF8uZXh0ZW5kKENoYW5uZWwucHJvdG90eXBlLCB7CiAgICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmcm9tIHRoZSBtZXNzYWdpbmcgc3lzdGVtcyBvZiB0aGlzIGNoYW5uZWwKICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnZlbnQub2ZmKCk7CiAgICAgICAgICB0aGlzLnZlbnQuc3RvcExpc3RlbmluZygpOwogICAgICAgICAgdGhpcy5yZXFyZXMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlQWxsSGFuZGxlcnMoKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ29ubmVjdCBhIGhhc2ggb2YgZXZlbnRzOyBvbmUgZm9yIGVhY2ggbWVzc2FnaW5nIHN5c3RlbQogICAgICAgIGNvbm5lY3RFdmVudHM6IGZ1bmN0aW9uKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIHRoaXMuX2Nvbm5lY3QoInZlbnQiLCBoYXNoLCBjb250ZXh0KTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgY29ubmVjdENvbW1hbmRzOiBmdW5jdGlvbihoYXNoLCBjb250ZXh0KSB7CiAgICAgICAgICB0aGlzLl9jb25uZWN0KCJjb21tYW5kcyIsIGhhc2gsIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBjb25uZWN0UmVxdWVzdHM6IGZ1bmN0aW9uKGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIHRoaXMuX2Nvbm5lY3QoInJlcXJlcyIsIGhhc2gsIGNvbnRleHQpOwogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICAvLyBBdHRhY2ggdGhlIGhhbmRsZXJzIHRvIGEgZ2l2ZW4gbWVzc2FnZSBzeXN0ZW0gYHR5cGVgCiAgICAgICAgX2Nvbm5lY3Q6IGZ1bmN0aW9uKHR5cGUsIGhhc2gsIGNvbnRleHQpIHsKICAgICAgICAgIGlmICghaGFzaCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzOwogICAgICAgICAgdmFyIG1ldGhvZCA9IHR5cGUgPT09ICJ2ZW50IiA/ICJvbiIgOiAic2V0SGFuZGxlciI7CiAgICAgICAgICBfLmVhY2goaGFzaCwgZnVuY3Rpb24oZm4sIGV2ZW50TmFtZSkgewogICAgICAgICAgICB0aGlzW3R5cGVdW21ldGhvZF0oZXZlbnROYW1lLCBfLmJpbmQoZm4sIGNvbnRleHQpKTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiBDaGFubmVsOwogICAgfShXcmVxcik7CiAgICAvLyBXcmVxci5SYWRpbwogICAgLy8gLS0tLS0tLS0tLS0tLS0KICAgIC8vCiAgICAvLyBBbiBvYmplY3QgdGhhdCBsZXRzIHlvdSBjb21tdW5pY2F0ZSB3aXRoIG1hbnkgY2hhbm5lbHMuCiAgICBXcmVxci5yYWRpbyA9IGZ1bmN0aW9uKFdyZXFyKSB7CiAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgdmFyIFJhZGlvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5fY2hhbm5lbHMgPSB7fTsKICAgICAgICB0aGlzLnZlbnQgPSB7fTsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CiAgICAgICAgdGhpcy5yZXFyZXMgPSB7fTsKICAgICAgICB0aGlzLl9wcm94eU1ldGhvZHMoKTsKICAgICAgfTsKICAgICAgXy5leHRlbmQoUmFkaW8ucHJvdG90eXBlLCB7CiAgICAgICAgY2hhbm5lbDogZnVuY3Rpb24oY2hhbm5lbE5hbWUpIHsKICAgICAgICAgIGlmICghY2hhbm5lbE5hbWUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGFubmVsIG11c3QgcmVjZWl2ZSBhIG5hbWUiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICB9LAogICAgICAgIF9nZXRDaGFubmVsOiBmdW5jdGlvbihjaGFubmVsTmFtZSkgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSB0aGlzLl9jaGFubmVsc1tjaGFubmVsTmFtZV07CiAgICAgICAgICBpZiAoIWNoYW5uZWwpIHsKICAgICAgICAgICAgY2hhbm5lbCA9IG5ldyBXcmVxci5DaGFubmVsKGNoYW5uZWxOYW1lKTsKICAgICAgICAgICAgdGhpcy5fY2hhbm5lbHNbY2hhbm5lbE5hbWVdID0gY2hhbm5lbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGFubmVsOwogICAgICAgIH0sCiAgICAgICAgX3Byb3h5TWV0aG9kczogZnVuY3Rpb24oKSB7CiAgICAgICAgICBfLmVhY2goWyAidmVudCIsICJjb21tYW5kcyIsICJyZXFyZXMiIF0sIGZ1bmN0aW9uKHN5c3RlbSkgewogICAgICAgICAgICBfLmVhY2gobWVzc2FnZVN5c3RlbXNbc3lzdGVtXSwgZnVuY3Rpb24obWV0aG9kKSB7CiAgICAgICAgICAgICAgdGhpc1tzeXN0ZW1dW21ldGhvZF0gPSBwcm94eU1ldGhvZCh0aGlzLCBzeXN0ZW0sIG1ldGhvZCk7CiAgICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgICAgfSwgdGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgdmFyIG1lc3NhZ2VTeXN0ZW1zID0gewogICAgICAgIHZlbnQ6IFsgIm9uIiwgIm9mZiIsICJ0cmlnZ2VyIiwgIm9uY2UiLCAic3RvcExpc3RlbmluZyIsICJsaXN0ZW5UbyIsICJsaXN0ZW5Ub09uY2UiIF0sCiAgICAgICAgY29tbWFuZHM6IFsgImV4ZWN1dGUiLCAic2V0SGFuZGxlciIsICJzZXRIYW5kbGVycyIsICJyZW1vdmVIYW5kbGVyIiwgInJlbW92ZUFsbEhhbmRsZXJzIiBdLAogICAgICAgIHJlcXJlczogWyAicmVxdWVzdCIsICJzZXRIYW5kbGVyIiwgInNldEhhbmRsZXJzIiwgInJlbW92ZUhhbmRsZXIiLCAicmVtb3ZlQWxsSGFuZGxlcnMiIF0KICAgICAgfTsKICAgICAgdmFyIHByb3h5TWV0aG9kID0gZnVuY3Rpb24ocmFkaW8sIHN5c3RlbSwgbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGNoYW5uZWxOYW1lKSB7CiAgICAgICAgICB2YXIgbWVzc2FnZVN5c3RlbSA9IHJhZGlvLl9nZXRDaGFubmVsKGNoYW5uZWxOYW1lKVtzeXN0ZW1dOwogICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VTeXN0ZW1bbWV0aG9kXS5hcHBseShtZXNzYWdlU3lzdGVtLCBhcmdzKTsKICAgICAgICB9OwogICAgICB9OwogICAgICByZXR1cm4gbmV3IFJhZGlvKCk7CiAgICB9KFdyZXFyKTsKICAgIHJldHVybiBCYWNrYm9uZS5XcmVxcjsKICB9KShCYWNrYm9uZSwgXyk7CgogIHZhciBwcmV2aW91c01hcmlvbmV0dGUgPSByb290Lk1hcmlvbmV0dGU7CgogIHZhciBNYXJpb25ldHRlID0gQmFja2JvbmUuTWFyaW9uZXR0ZSA9IHt9OwoKICBNYXJpb25ldHRlLlZFUlNJT04gPSAnMi4yLjAnOwoKICBNYXJpb25ldHRlLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuTWFyaW9uZXR0ZSA9IHByZXZpb3VzTWFyaW9uZXR0ZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIEJhY2tib25lLk1hcmlvbmV0dGUgPSBNYXJpb25ldHRlOwoKICAvLyBHZXQgdGhlIERlZmVycmVkIGNyZWF0b3IgZm9yIGxhdGVyIHVzZQogIE1hcmlvbmV0dGUuRGVmZXJyZWQgPSBCYWNrYm9uZS4kLkRlZmVycmVkOwoKICAvKiBqc2hpbnQgdW51c2VkOiBmYWxzZSAqLwogIAogIC8vIEhlbHBlcnMKICAvLyAtLS0tLS0tCiAgCiAgLy8gRm9yIHNsaWNpbmcgYGFyZ3VtZW50c2AgaW4gZnVuY3Rpb25zCiAgdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwogIAogIC8vIE1hcmlvbmV0dGUuZXh0ZW5kCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBCb3Jyb3cgdGhlIEJhY2tib25lIGBleHRlbmRgIG1ldGhvZCBzbyB3ZSBjYW4gdXNlIGl0IGFzIG5lZWRlZAogIE1hcmlvbmV0dGUuZXh0ZW5kID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kOwogIAogIC8vIE1hcmlvbmV0dGUuZ2V0T3B0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBSZXRyaWV2ZSBhbiBvYmplY3QsIGZ1bmN0aW9uIG9yIG90aGVyIHZhbHVlIGZyb20gYSB0YXJnZXQKICAvLyBvYmplY3Qgb3IgaXRzIGBvcHRpb25zYCwgd2l0aCBgb3B0aW9uc2AgdGFraW5nIHByZWNlZGVuY2UuCiAgTWFyaW9uZXR0ZS5nZXRPcHRpb24gPSBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbk5hbWUpIHsKICAgIGlmICghdGFyZ2V0IHx8ICFvcHRpb25OYW1lKSB7IHJldHVybjsgfQogICAgdmFyIHZhbHVlOwogIAogICAgaWYgKHRhcmdldC5vcHRpb25zICYmICh0YXJnZXQub3B0aW9uc1tvcHRpb25OYW1lXSAhPT0gdW5kZWZpbmVkKSkgewogICAgICB2YWx1ZSA9IHRhcmdldC5vcHRpb25zW29wdGlvbk5hbWVdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSB0YXJnZXRbb3B0aW9uTmFtZV07CiAgICB9CiAgCiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICAKICAvLyBQcm94eSBgTWFyaW9uZXR0ZS5nZXRPcHRpb25gCiAgTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbiA9IGZ1bmN0aW9uKG9wdGlvbk5hbWUpIHsKICAgIHJldHVybiBNYXJpb25ldHRlLmdldE9wdGlvbih0aGlzLCBvcHRpb25OYW1lKTsKICB9OwogIAogIC8vIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAKICAvLyBQYXNzIGluIGEgbWFwcGluZyBvZiBldmVudHMgPT4gZnVuY3Rpb25zIG9yIGZ1bmN0aW9uIG5hbWVzCiAgLy8gYW5kIHJldHVybiBhIG1hcHBpbmcgb2YgZXZlbnRzID0+IGZ1bmN0aW9ucwogIE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcyA9IGZ1bmN0aW9uKGhhc2gpIHsKICAgIHZhciBub3JtYWxpemVkSGFzaCA9IHt9OwogICAgXy5lYWNoKGhhc2gsIGZ1bmN0aW9uKG1ldGhvZCwgbmFtZSkgewogICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSB7CiAgICAgICAgbWV0aG9kID0gdGhpc1ttZXRob2RdOwogICAgICB9CiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIG5vcm1hbGl6ZWRIYXNoW25hbWVdID0gbWV0aG9kOwogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gbm9ybWFsaXplZEhhc2g7CiAgfTsKICAKICAvLyB1dGlsaXR5IG1ldGhvZCBmb3IgcGFyc2luZyBAdWkuIHN5bnRheCBzdHJpbmdzCiAgLy8gaW50byBhc3NvY2lhdGVkIHNlbGVjdG9yCiAgTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyA9IGZ1bmN0aW9uKHVpU3RyaW5nLCB1aSkgewogICAgcmV0dXJuIHVpU3RyaW5nLnJlcGxhY2UoL0B1aVwuW2EtekEtWl8kMC05XSovZywgZnVuY3Rpb24ocikgewogICAgICByZXR1cm4gdWlbci5zbGljZSg0KV07CiAgICB9KTsKICB9OwogIAogIC8vIGFsbG93cyBmb3IgdGhlIHVzZSBvZiB0aGUgQHVpLiBzeW50YXggd2l0aGluCiAgLy8gYSBnaXZlbiBrZXkgZm9yIHRyaWdnZXJzIGFuZCBldmVudHMKICAvLyBzd2FwcyB0aGUgQHVpIHdpdGggdGhlIGFzc29jaWF0ZWQgc2VsZWN0b3IuCiAgLy8gUmV0dXJucyBhIG5ldywgbm9uLW11dGF0ZWQsIHBhcnNlZCBldmVudHMgaGFzaC4KICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyA9IGZ1bmN0aW9uKGhhc2gsIHVpKSB7CiAgICBpZiAodHlwZW9mKGhhc2gpID09PSAndW5kZWZpbmVkJykgewogICAgICByZXR1cm47CiAgICB9CiAgCiAgICBoYXNoID0gXy5jbG9uZShoYXNoKTsKICAKICAgIF8uZWFjaChfLmtleXMoaGFzaCksIGZ1bmN0aW9uKGtleSkgewogICAgICB2YXIgbm9ybWFsaXplZEtleSA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlTdHJpbmcoa2V5LCB1aSk7CiAgICAgIGlmIChub3JtYWxpemVkS2V5ICE9PSBrZXkpIHsKICAgICAgICBoYXNoW25vcm1hbGl6ZWRLZXldID0gaGFzaFtrZXldOwogICAgICAgIGRlbGV0ZSBoYXNoW2tleV07CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIGhhc2g7CiAgfTsKICAKICAvLyBhbGxvd3MgZm9yIHRoZSB1c2Ugb2YgdGhlIEB1aS4gc3ludGF4IHdpdGhpbgogIC8vIGEgZ2l2ZW4gdmFsdWUgZm9yIHJlZ2lvbnMKICAvLyBzd2FwcyB0aGUgQHVpIHdpdGggdGhlIGFzc29jaWF0ZWQgc2VsZWN0b3IKICBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJVmFsdWVzID0gZnVuY3Rpb24oaGFzaCwgdWkpIHsKICAgIGlmICh0eXBlb2YoaGFzaCkgPT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAKICAgIF8uZWFjaChoYXNoLCBmdW5jdGlvbih2YWwsIGtleSkgewogICAgICBpZiAoXy5pc1N0cmluZyh2YWwpKSB7CiAgICAgICAgaGFzaFtrZXldID0gTWFyaW9uZXR0ZS5ub3JtYWxpemVVSVN0cmluZyh2YWwsIHVpKTsKICAgICAgfQogICAgfSk7CiAgCiAgICByZXR1cm4gaGFzaDsKICB9OwogIAogIC8vIE1peCBpbiBtZXRob2RzIGZyb20gVW5kZXJzY29yZSwgZm9yIGl0ZXJhdGlvbiwgYW5kIG90aGVyCiAgLy8gY29sbGVjdGlvbiByZWxhdGVkIGZlYXR1cmVzLgogIC8vIEJvcnJvd2luZyB0aGlzIGNvZGUgZnJvbSBCYWNrYm9uZS5Db2xsZWN0aW9uOgogIC8vIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZy9kb2NzL2JhY2tib25lLmh0bWwjc2VjdGlvbi0xMjEKICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG9iamVjdCwgbGlzdFByb3BlcnR5KSB7CiAgICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLAogICAgICAnc2VsZWN0JywgJ3JlamVjdCcsICdldmVyeScsICdhbGwnLCAnc29tZScsICdhbnknLCAnaW5jbHVkZScsCiAgICAgICdjb250YWlucycsICdpbnZva2UnLCAndG9BcnJheScsICdmaXJzdCcsICdpbml0aWFsJywgJ3Jlc3QnLAogICAgICAnbGFzdCcsICd3aXRob3V0JywgJ2lzRW1wdHknLCAncGx1Y2snXTsKICAKICAgIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgICAgb2JqZWN0W21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbGlzdCA9IF8udmFsdWVzKF8ucmVzdWx0KHRoaXMsIGxpc3RQcm9wZXJ0eSkpOwogICAgICAgIHZhciBhcmdzID0gW2xpc3RdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSk7CiAgICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgCiAgLy8gVHJpZ2dlciBhbiBldmVudCBhbmQvb3IgYSBjb3JyZXNwb25kaW5nIG1ldGhvZCBuYW1lLiBFeGFtcGxlczoKICAvLwogIC8vIGB0aGlzLnRyaWdnZXJNZXRob2QoImZvbyIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb28iIGV2ZW50IGFuZAogIC8vIGNhbGwgdGhlICJvbkZvbyIgbWV0aG9kLgogIC8vCiAgLy8gYHRoaXMudHJpZ2dlck1ldGhvZCgiZm9vOmJhciIpYCB3aWxsIHRyaWdnZXIgdGhlICJmb286YmFyIiBldmVudCBhbmQKICAvLyBjYWxsIHRoZSAib25Gb29CYXIiIG1ldGhvZC4KICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QgPSBmdW5jdGlvbihldmVudCkgewogIAogICAgLy8gc3BsaXQgdGhlIGV2ZW50IG5hbWUgb24gdGhlICI6IgogICAgdmFyIHNwbGl0dGVyID0gLyhefDopKFx3KS9naTsKICAKICAgIC8vIHRha2UgdGhlIGV2ZW50IHNlY3Rpb24gKCJzZWN0aW9uMTpzZWN0aW9uMjpzZWN0aW9uMyIpCiAgICAvLyBhbmQgdHVybiBpdCBpbiB0byB1cHBlcmNhc2UgbmFtZQogICAgZnVuY3Rpb24gZ2V0RXZlbnROYW1lKG1hdGNoLCBwcmVmaXgsIGV2ZW50TmFtZSkgewogICAgICByZXR1cm4gZXZlbnROYW1lLnRvVXBwZXJDYXNlKCk7CiAgICB9CiAgCiAgICAvLyBnZXQgdGhlIG1ldGhvZCBuYW1lIGZyb20gdGhlIGV2ZW50IG5hbWUKICAgIHZhciBtZXRob2ROYW1lID0gJ29uJyArIGV2ZW50LnJlcGxhY2Uoc3BsaXR0ZXIsIGdldEV2ZW50TmFtZSk7CiAgICB2YXIgbWV0aG9kID0gdGhpc1ttZXRob2ROYW1lXTsKICAgIHZhciByZXN1bHQ7CiAgCiAgICAvLyBjYWxsIHRoZSBvbk1ldGhvZE5hbWUgaWYgaXQgZXhpc3RzCiAgICBpZiAoXy5pc0Z1bmN0aW9uKG1ldGhvZCkpIHsKICAgICAgLy8gcGFzcyBhbGwgYXJndW1lbnRzLCBleGNlcHQgdGhlIGV2ZW50IG5hbWUKICAgICAgcmVzdWx0ID0gbWV0aG9kLmFwcGx5KHRoaXMsIF8udGFpbChhcmd1bWVudHMpKTsKICAgIH0KICAKICAgIC8vIHRyaWdnZXIgdGhlIGV2ZW50LCBpZiBhIHRyaWdnZXIgbWV0aG9kIGV4aXN0cwogICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLnRyaWdnZXIpKSB7CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIAogIC8vIHRyaWdnZXJNZXRob2RPbiBpbnZva2VzIHRyaWdnZXJNZXRob2Qgb24gYSBzcGVjaWZpYyBjb250ZXh0CiAgLy8KICAvLyBlLmcuIGBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpYAogIC8vIHdpbGwgdHJpZ2dlciBhICJzaG93IiBldmVudCBvciBpbnZva2Ugb25TaG93IHRoZSB2aWV3LgogIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIHZhciBhcmdzID0gXy50YWlsKGFyZ3VtZW50cywgMik7CiAgICB2YXIgZm5jOwogIAogICAgaWYgKF8uaXNGdW5jdGlvbihjb250ZXh0LnRyaWdnZXJNZXRob2QpKSB7CiAgICAgIGZuYyA9IGNvbnRleHQudHJpZ2dlck1ldGhvZDsKICAgIH0gZWxzZSB7CiAgICAgIGZuYyA9IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZDsKICAgIH0KICAKICAgIHJldHVybiBmbmMuYXBwbHkoY29udGV4dCwgW2V2ZW50XS5jb25jYXQoYXJncykpOwogIH07CiAgCiAgLy8gRE9NUmVmcmVzaAogIC8vIC0tLS0tLS0tLS0KICAvLwogIC8vIE1vbml0b3IgYSB2aWV3J3Mgc3RhdGUsIGFuZCBhZnRlciBpdCBoYXMgYmVlbiByZW5kZXJlZCBhbmQgc2hvd24KICAvLyBpbiB0aGUgRE9NLCB0cmlnZ2VyIGEgImRvbTpyZWZyZXNoIiBldmVudCBldmVyeSB0aW1lIGl0IGlzCiAgLy8gcmUtcmVuZGVyZWQuCiAgCiAgTWFyaW9uZXR0ZS5Nb25pdG9yRE9NUmVmcmVzaCA9IChmdW5jdGlvbihkb2N1bWVudEVsZW1lbnQpIHsKICAgIC8vIHRyYWNrIHdoZW4gdGhlIHZpZXcgaGFzIGJlZW4gc2hvd24gaW4gdGhlIERPTSwKICAgIC8vIHVzaW5nIGEgTWFyaW9uZXR0ZS5SZWdpb24gKG9yIGJ5IG90aGVyIG1lYW5zIG9mIHRyaWdnZXJpbmcgInNob3ciKQogICAgZnVuY3Rpb24gaGFuZGxlU2hvdyh2aWV3KSB7CiAgICAgIHZpZXcuX2lzU2hvd24gPSB0cnVlOwogICAgICB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KTsKICAgIH0KICAKICAgIC8vIHRyYWNrIHdoZW4gdGhlIHZpZXcgaGFzIGJlZW4gcmVuZGVyZWQKICAgIGZ1bmN0aW9uIGhhbmRsZVJlbmRlcih2aWV3KSB7CiAgICAgIHZpZXcuX2lzUmVuZGVyZWQgPSB0cnVlOwogICAgICB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KTsKICAgIH0KICAKICAgIC8vIFRyaWdnZXIgdGhlICJkb206cmVmcmVzaCIgZXZlbnQgYW5kIGNvcnJlc3BvbmRpbmcgIm9uRG9tUmVmcmVzaCIgbWV0aG9kCiAgICBmdW5jdGlvbiB0cmlnZ2VyRE9NUmVmcmVzaCh2aWV3KSB7CiAgICAgIGlmICh2aWV3Ll9pc1Nob3duICYmIHZpZXcuX2lzUmVuZGVyZWQgJiYgaXNJbkRPTSh2aWV3KSkgewogICAgICAgIGlmIChfLmlzRnVuY3Rpb24odmlldy50cmlnZ2VyTWV0aG9kKSkgewogICAgICAgICAgdmlldy50cmlnZ2VyTWV0aG9kKCdkb206cmVmcmVzaCcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgZnVuY3Rpb24gaXNJbkRPTSh2aWV3KSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS4kLmNvbnRhaW5zKGRvY3VtZW50RWxlbWVudCwgdmlldy5lbCk7CiAgICB9CiAgCiAgICAvLyBFeHBvcnQgcHVibGljIEFQSQogICAgcmV0dXJuIGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdmlldy5saXN0ZW5Ubyh2aWV3LCAnc2hvdycsIGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZVNob3codmlldyk7CiAgICAgIH0pOwogIAogICAgICB2aWV3Lmxpc3RlblRvKHZpZXcsICdyZW5kZXInLCBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVSZW5kZXIodmlldyk7CiAgICAgIH0pOwogICAgfTsKICB9KShkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpOwogIAoKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA1ICovCiAgCiAgLy8gTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzICYgdW5iaW5kRW50aXR5RXZlbnRzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBUaGVzZSBtZXRob2RzIGFyZSB1c2VkIHRvIGJpbmQvdW5iaW5kIGEgYmFja2JvbmUgImVudGl0eSIgKGNvbGxlY3Rpb24vbW9kZWwpCiAgLy8gdG8gbWV0aG9kcyBvbiBhIHRhcmdldCBvYmplY3QuCiAgLy8KICAvLyBUaGUgZmlyc3QgcGFyYW1ldGVyLCBgdGFyZ2V0YCwgbXVzdCBoYXZlIGEgYGxpc3RlblRvYCBtZXRob2QgZnJvbSB0aGUKICAvLyBFdmVudEJpbmRlciBvYmplY3QuCiAgLy8KICAvLyBUaGUgc2Vjb25kIHBhcmFtZXRlciBpcyB0aGUgZW50aXR5IChCYWNrYm9uZS5Nb2RlbCBvciBCYWNrYm9uZS5Db2xsZWN0aW9uKQogIC8vIHRvIGJpbmQgdGhlIGV2ZW50cyBmcm9tLgogIC8vCiAgLy8gVGhlIHRoaXJkIHBhcmFtZXRlciBpcyBhIGhhc2ggb2YgeyAiZXZlbnQ6bmFtZSI6ICJldmVudEhhbmRsZXIiIH0KICAvLyBjb25maWd1cmF0aW9uLiBNdWx0aXBsZSBoYW5kbGVycyBjYW4gYmUgc2VwYXJhdGVkIGJ5IGEgc3BhY2UuIEEKICAvLyBmdW5jdGlvbiBjYW4gYmUgc3VwcGxpZWQgaW5zdGVhZCBvZiBhIHN0cmluZyBoYW5kbGVyIG5hbWUuCiAgCiAgKGZ1bmN0aW9uKE1hcmlvbmV0dGUpIHsKICAgICd1c2Ugc3RyaWN0JzsKICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gYmluZEZyb21TdHJpbmdzKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpIHsKICAgICAgdmFyIG1ldGhvZE5hbWVzID0gbWV0aG9kcy5zcGxpdCgvXHMrLyk7CiAgCiAgICAgIF8uZWFjaChtZXRob2ROYW1lcywgZnVuY3Rpb24obWV0aG9kTmFtZSkgewogIAogICAgICAgIHZhciBtZXRob2QgPSB0YXJnZXRbbWV0aG9kTmFtZV07CiAgICAgICAgaWYgKCFtZXRob2QpIHsKICAgICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKCdNZXRob2QgIicgKyBtZXRob2ROYW1lICsKICAgICAgICAgICAgJyIgd2FzIGNvbmZpZ3VyZWQgYXMgYW4gZXZlbnQgaGFuZGxlciwgYnV0IGRvZXMgbm90IGV4aXN0LicpOwogICAgICAgIH0KICAKICAgICAgICB0YXJnZXQubGlzdGVuVG8oZW50aXR5LCBldnQsIG1ldGhvZCk7CiAgICAgIH0pOwogICAgfQogIAogICAgLy8gQmluZCB0aGUgZXZlbnQgdG8gYSBzdXBwbGllZCBjYWxsYmFjayBmdW5jdGlvbgogICAgZnVuY3Rpb24gYmluZFRvRnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kKSB7CiAgICAgIHRhcmdldC5saXN0ZW5UbyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgIH0KICAKICAgIC8vIEJpbmQgdGhlIGV2ZW50IHRvIGhhbmRsZXJzIHNwZWNpZmllZCBhcyBhIHN0cmluZyBvZgogICAgLy8gaGFuZGxlciBuYW1lcyBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZnVuY3Rpb24gdW5iaW5kRnJvbVN0cmluZ3ModGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcykgewogICAgICB2YXIgbWV0aG9kTmFtZXMgPSBtZXRob2RzLnNwbGl0KC9ccysvKTsKICAKICAgICAgXy5lYWNoKG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IHRhcmdldFttZXRob2ROYW1lXTsKICAgICAgICB0YXJnZXQuc3RvcExpc3RlbmluZyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgICAgfSk7CiAgICB9CiAgCiAgICAvLyBCaW5kIHRoZSBldmVudCB0byBhIHN1cHBsaWVkIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICBmdW5jdGlvbiB1bmJpbmRUb0Z1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZCkgewogICAgICB0YXJnZXQuc3RvcExpc3RlbmluZyhlbnRpdHksIGV2dCwgbWV0aG9kKTsKICAgIH0KICAKICAKICAgIC8vIGdlbmVyaWMgbG9vcGluZyBmdW5jdGlvbgogICAgZnVuY3Rpb24gaXRlcmF0ZUV2ZW50cyh0YXJnZXQsIGVudGl0eSwgYmluZGluZ3MsIGZ1bmN0aW9uQ2FsbGJhY2ssIHN0cmluZ0NhbGxiYWNrKSB7CiAgICAgIGlmICghZW50aXR5IHx8ICFiaW5kaW5ncykgeyByZXR1cm47IH0KICAKICAgICAgLy8gdHlwZS1jaGVjayBiaW5kaW5ncwogICAgICBpZiAoIV8uaXNGdW5jdGlvbihiaW5kaW5ncykgJiYgIV8uaXNPYmplY3QoYmluZGluZ3MpKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbWVzc2FnZTogJ0JpbmRpbmdzIG11c3QgYmUgYW4gb2JqZWN0IG9yIGZ1bmN0aW9uLicsCiAgICAgICAgICB1cmw6ICdtYXJpb25ldHRlLmZ1bmN0aW9ucy5odG1sI21hcmlvbmV0dGViaW5kZW50aXR5ZXZlbnRzJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIC8vIGFsbG93IHRoZSBiaW5kaW5ncyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24oYmluZGluZ3MpKSB7CiAgICAgICAgYmluZGluZ3MgPSBiaW5kaW5ncy5jYWxsKHRhcmdldCk7CiAgICAgIH0KICAKICAgICAgLy8gaXRlcmF0ZSB0aGUgYmluZGluZ3MgYW5kIGJpbmQgdGhlbQogICAgICBfLmVhY2goYmluZGluZ3MsIGZ1bmN0aW9uKG1ldGhvZHMsIGV2dCkgewogIAogICAgICAgIC8vIGFsbG93IGZvciBhIGZ1bmN0aW9uIGFzIHRoZSBoYW5kbGVyLAogICAgICAgIC8vIG9yIGEgbGlzdCBvZiBldmVudCBuYW1lcyBhcyBhIHN0cmluZwogICAgICAgIGlmIChfLmlzRnVuY3Rpb24obWV0aG9kcykpIHsKICAgICAgICAgIGZ1bmN0aW9uQ2FsbGJhY2sodGFyZ2V0LCBlbnRpdHksIGV2dCwgbWV0aG9kcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0cmluZ0NhbGxiYWNrKHRhcmdldCwgZW50aXR5LCBldnQsIG1ldGhvZHMpOwogICAgICAgIH0KICAKICAgICAgfSk7CiAgICB9CiAgCiAgICAvLyBFeHBvcnQgUHVibGljIEFQSQogICAgTWFyaW9uZXR0ZS5iaW5kRW50aXR5RXZlbnRzID0gZnVuY3Rpb24odGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIGl0ZXJhdGVFdmVudHModGFyZ2V0LCBlbnRpdHksIGJpbmRpbmdzLCBiaW5kVG9GdW5jdGlvbiwgYmluZEZyb21TdHJpbmdzKTsKICAgIH07CiAgCiAgICBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncykgewogICAgICBpdGVyYXRlRXZlbnRzKHRhcmdldCwgZW50aXR5LCBiaW5kaW5ncywgdW5iaW5kVG9GdW5jdGlvbiwgdW5iaW5kRnJvbVN0cmluZ3MpOwogICAgfTsKICAKICAgIC8vIFByb3h5IGBiaW5kRW50aXR5RXZlbnRzYAogICAgTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbihlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLmJpbmRFbnRpdHlFdmVudHModGhpcywgZW50aXR5LCBiaW5kaW5ncyk7CiAgICB9OwogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AKICAgIE1hcmlvbmV0dGUucHJveHlVbmJpbmRFbnRpdHlFdmVudHMgPSBmdW5jdGlvbihlbnRpdHksIGJpbmRpbmdzKSB7CiAgICAgIHJldHVybiBNYXJpb25ldHRlLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLCBlbnRpdHksIGJpbmRpbmdzKTsKICAgIH07CiAgfSkoTWFyaW9uZXR0ZSk7CiAgCgogIHZhciBlcnJvclByb3BzID0gWydkZXNjcmlwdGlvbicsICdmaWxlTmFtZScsICdsaW5lTnVtYmVyJywgJ25hbWUnLCAnbWVzc2FnZScsICdudW1iZXInXTsKICAKICBNYXJpb25ldHRlLkVycm9yID0gTWFyaW9uZXR0ZS5leHRlbmQuY2FsbChFcnJvciwgewogICAgdXJsUm9vdDogJ2h0dHA6Ly9tYXJpb25ldHRlanMuY29tL2RvY3MvJyArIE1hcmlvbmV0dGUuVkVSU0lPTiArICcvJywKICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihtZXNzYWdlLCBvcHRpb25zKSB7CiAgICAgIGlmIChfLmlzT2JqZWN0KG1lc3NhZ2UpKSB7CiAgICAgICAgb3B0aW9ucyA9IG1lc3NhZ2U7CiAgICAgICAgbWVzc2FnZSA9IG9wdGlvbnMubWVzc2FnZTsKICAgICAgfSBlbHNlIGlmICghb3B0aW9ucykgewogICAgICAgIG9wdGlvbnMgPSB7fTsKICAgICAgfQogIAogICAgICB2YXIgZXJyb3IgPSBFcnJvci5jYWxsKHRoaXMsIG1lc3NhZ2UpOwogICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2soZXJyb3IsIGVycm9yUHJvcHMpLCBfLnBpY2sob3B0aW9ucywgZXJyb3JQcm9wcykpOwogIAogICAgICB0aGlzLmNhcHR1cmVTdGFja1RyYWNlKCk7CiAgCiAgICAgIGlmIChvcHRpb25zLnVybCkgewogICAgICAgIHRoaXMudXJsID0gdGhpcy51cmxSb290ICsgb3B0aW9ucy51cmw7CiAgICAgIH0KICAgIH0sCiAgCiAgICBjYXB0dXJlU3RhY2tUcmFjZTogZnVuY3Rpb24oKSB7CiAgICAgIGlmIChFcnJvci5jYXB0dXJlU3RhY2tUcmFjZSkgewogICAgICAgIEVycm9yLmNhcHR1cmVTdGFja1RyYWNlKHRoaXMsIE1hcmlvbmV0dGUuRXJyb3IpOwogICAgICB9CiAgICB9LAogIAogICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5uYW1lICsgJzogJyArIHRoaXMubWVzc2FnZSArICh0aGlzLnVybCA/ICcgU2VlOiAnICsgdGhpcy51cmwgOiAnJyk7CiAgICB9CiAgfSk7CiAgCiAgTWFyaW9uZXR0ZS5FcnJvci5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvLyBDYWxsYmFja3MKICAvLyAtLS0tLS0tLS0KICAKICAvLyBBIHNpbXBsZSB3YXkgb2YgbWFuYWdpbmcgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcwogIC8vIGFuZCBleGVjdXRpbmcgdGhlbSBhdCBhIGxhdGVyIHBvaW50IGluIHRpbWUsIHVzaW5nIGpRdWVyeSdzCiAgLy8gYERlZmVycmVkYCBvYmplY3QuCiAgTWFyaW9uZXR0ZS5DYWxsYmFja3MgPSBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2RlZmVycmVkID0gTWFyaW9uZXR0ZS5EZWZlcnJlZCgpOwogICAgdGhpcy5fY2FsbGJhY2tzID0gW107CiAgfTsKICAKICBfLmV4dGVuZChNYXJpb25ldHRlLkNhbGxiYWNrcy5wcm90b3R5cGUsIHsKICAKICAgIC8vIEFkZCBhIGNhbGxiYWNrIHRvIGJlIGV4ZWN1dGVkLiBDYWxsYmFja3MgYWRkZWQgaGVyZSBhcmUKICAgIC8vIGd1YXJhbnRlZWQgdG8gZXhlY3V0ZSwgZXZlbiBpZiB0aGV5IGFyZSBhZGRlZCBhZnRlciB0aGUKICAgIC8vIGBydW5gIG1ldGhvZCBpcyBjYWxsZWQuCiAgICBhZGQ6IGZ1bmN0aW9uKGNhbGxiYWNrLCBjb250ZXh0T3ZlcnJpZGUpIHsKICAgICAgdmFyIHByb21pc2UgPSBfLnJlc3VsdCh0aGlzLl9kZWZlcnJlZCwgJ3Byb21pc2UnKTsKICAKICAgICAgdGhpcy5fY2FsbGJhY2tzLnB1c2goe2NiOiBjYWxsYmFjaywgY3R4OiBjb250ZXh0T3ZlcnJpZGV9KTsKICAKICAgICAgcHJvbWlzZS50aGVuKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICBpZiAoY29udGV4dE92ZXJyaWRlKXsgYXJncy5jb250ZXh0ID0gY29udGV4dE92ZXJyaWRlOyB9CiAgICAgICAgY2FsbGJhY2suY2FsbChhcmdzLmNvbnRleHQsIGFyZ3Mub3B0aW9ucyk7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIFJ1biBhbGwgcmVnaXN0ZXJlZCBjYWxsYmFja3Mgd2l0aCB0aGUgY29udGV4dCBzcGVjaWZpZWQuCiAgICAvLyBBZGRpdGlvbmFsIGNhbGxiYWNrcyBjYW4gYmUgYWRkZWQgYWZ0ZXIgdGhpcyBoYXMgYmVlbiBydW4KICAgIC8vIGFuZCB0aGV5IHdpbGwgc3RpbGwgYmUgZXhlY3V0ZWQuCiAgICBydW46IGZ1bmN0aW9uKG9wdGlvbnMsIGNvbnRleHQpIHsKICAgICAgdGhpcy5fZGVmZXJyZWQucmVzb2x2ZSh7CiAgICAgICAgb3B0aW9uczogb3B0aW9ucywKICAgICAgICBjb250ZXh0OiBjb250ZXh0CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIFJlc2V0cyB0aGUgbGlzdCBvZiBjYWxsYmFja3MgdG8gYmUgcnVuLCBhbGxvd2luZyB0aGUgc2FtZSBsaXN0CiAgICAvLyB0byBiZSBydW4gbXVsdGlwbGUgdGltZXMgLSB3aGVuZXZlciB0aGUgYHJ1bmAgbWV0aG9kIGlzIGNhbGxlZC4KICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNhbGxiYWNrcyA9IHRoaXMuX2NhbGxiYWNrczsKICAgICAgdGhpcy5fZGVmZXJyZWQgPSBNYXJpb25ldHRlLkRlZmVycmVkKCk7CiAgICAgIHRoaXMuX2NhbGxiYWNrcyA9IFtdOwogIAogICAgICBfLmVhY2goY2FsbGJhY2tzLCBmdW5jdGlvbihjYikgewogICAgICAgIHRoaXMuYWRkKGNiLmNiLCBjYi5jdHgpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAKICAvLyBNYXJpb25ldHRlIENvbnRyb2xsZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIEEgbXVsdGktcHVycG9zZSBvYmplY3QgdG8gdXNlIGFzIGEgY29udHJvbGxlciBmb3IKICAvLyBtb2R1bGVzIGFuZCByb3V0ZXJzLCBhbmQgYXMgYSBtZWRpYXRvciBmb3Igd29ya2Zsb3cKICAvLyBhbmQgY29vcmRpbmF0aW9uIG9mIG90aGVyIG9iamVjdHMsIHZpZXdzLCBhbmQgbW9yZS4KICBNYXJpb25ldHRlLkNvbnRyb2xsZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgaWYgKF8uaXNGdW5jdGlvbih0aGlzLmluaXRpYWxpemUpKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZSh0aGlzLm9wdGlvbnMpOwogICAgfQogIH07CiAgCiAgTWFyaW9uZXR0ZS5Db250cm9sbGVyLmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIAogIC8vIENvbnRyb2xsZXIgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tCiAgCiAgLy8gRW5zdXJlIGl0IGNhbiB0cmlnZ2VyIGV2ZW50cyB3aXRoIEJhY2tib25lLkV2ZW50cwogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuQ29udHJvbGxlci5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydiZWZvcmU6ZGVzdHJveSddLmNvbmNhdChhcmdzKSk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2Rlc3Ryb3knXS5jb25jYXQoYXJncykpOwogIAogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgdGhpcy5vZmYoKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIAogIH0pOwogIAogIC8vIE1hcmlvbmV0dGUgT2JqZWN0CiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8KICAvLyBBIEJhc2UgQ2xhc3MgdGhhdCBvdGhlciBDbGFzc2VzIHNob3VsZCBkZXNjZW5kIGZyb20uCiAgLy8gT2JqZWN0IGJvcnJvd3MgbWFueSBjb252ZW50aW9ucyBhbmQgdXRpbGl0aWVzIGZyb20gQmFja2JvbmUuCiAgTWFyaW9uZXR0ZS5PYmplY3QgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgCiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIAogIE1hcmlvbmV0dGUuT2JqZWN0LmV4dGVuZCA9IE1hcmlvbmV0dGUuZXh0ZW5kOwogIAogIC8vIE9iamVjdCBNZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0KICAKICBfLmV4dGVuZChNYXJpb25ldHRlLk9iamVjdC5wcm90b3R5cGUsIHsKICAKICAgIC8vdGhpcyBpcyBhIG5vb3AgbWV0aG9kIGludGVuZGVkIHRvIGJlIG92ZXJyaWRkZW4gYnkgY2xhc3NlcyB0aGF0IGV4dGVuZCBmcm9tIHRoaXMgYmFzZQogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKICAKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpkZXN0cm95Jyk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnZGVzdHJveScpOwogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsKICAgIH0sCiAgCiAgICAvLyBJbXBvcnQgdGhlIGB0cmlnZ2VyTWV0aG9kYCB0byB0cmlnZ2VyIGV2ZW50cyB3aXRoIGNvcnJlc3BvbmRpbmcKICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgIHRyaWdnZXJNZXRob2Q6IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZCwKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIAogIC8vIEVuc3VyZSBpdCBjYW4gdHJpZ2dlciBldmVudHMgd2l0aCBCYWNrYm9uZS5FdmVudHMKICBfLmV4dGVuZChNYXJpb25ldHRlLk9iamVjdC5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cyk7CiAgCiAgLyoganNoaW50IG1heGNvbXBsZXhpdHk6IDEwLCBtYXhzdGF0ZW1lbnRzOiAyOSAqLwogIAogIC8vIFJlZ2lvbgogIC8vIC0tLS0tLQogIC8vCiAgLy8gTWFuYWdlIHRoZSB2aXN1YWwgcmVnaW9ucyBvZiB5b3VyIGNvbXBvc2l0ZSBhcHBsaWNhdGlvbi4gU2VlCiAgLy8gaHR0cDovL2xvc3RlY2hpZXMuY29tL2Rlcmlja2JhaWxleS8yMDExLzEyLzEyL2NvbXBvc2l0ZS1qcy1hcHBzLXJlZ2lvbnMtYW5kLXJlZ2lvbi1tYW5hZ2Vycy8KICAKICBNYXJpb25ldHRlLlJlZ2lvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICB0aGlzLmVsID0gdGhpcy5nZXRPcHRpb24oJ2VsJyk7CiAgCiAgICAvLyBIYW5kbGUgd2hlbiB0aGlzLmVsIGlzIHBhc3NlZCBpbiBhcyBhICQgd3JhcHBlZCBlbGVtZW50LgogICAgdGhpcy5lbCA9IHRoaXMuZWwgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gdGhpcy5lbFswXSA6IHRoaXMuZWw7CiAgCiAgICBpZiAoIXRoaXMuZWwpIHsKICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgIG5hbWU6ICdOb0VsRXJyb3InLAogICAgICAgIG1lc3NhZ2U6ICdBbiAiZWwiIG11c3QgYmUgc3BlY2lmaWVkIGZvciBhIHJlZ2lvbi4nCiAgICAgIH0pOwogICAgfQogIAogICAgdGhpcy4kZWwgPSB0aGlzLmdldEVsKHRoaXMuZWwpOwogIAogICAgaWYgKHRoaXMuaW5pdGlhbGl6ZSkgewogICAgICB2YXIgYXJncyA9IHNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0KICB9OwogIAogIAogIC8vIFJlZ2lvbiBDbGFzcyBtZXRob2RzCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQogIAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuUmVnaW9uLCB7CiAgCiAgICAvLyBCdWlsZCBhbiBpbnN0YW5jZSBvZiBhIHJlZ2lvbiBieSBwYXNzaW5nIGluIGEgY29uZmlndXJhdGlvbiBvYmplY3QKICAgIC8vIGFuZCBhIGRlZmF1bHQgcmVnaW9uIGNsYXNzIHRvIHVzZSBpZiBub25lIGlzIHNwZWNpZmllZCBpbiB0aGUgY29uZmlnLgogICAgLy8KICAgIC8vIFRoZSBjb25maWcgb2JqZWN0IHNob3VsZCBlaXRoZXIgYmUgYSBzdHJpbmcgYXMgYSBqUXVlcnkgRE9NIHNlbGVjdG9yLAogICAgLy8gYSBSZWdpb24gY2xhc3MgZGlyZWN0bHksIG9yIGFuIG9iamVjdCBsaXRlcmFsIHRoYXQgc3BlY2lmaWVzIGJvdGgKICAgIC8vIGEgc2VsZWN0b3IgYW5kIHJlZ2lvbkNsYXNzOgogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyB7CiAgICAvLyAgIHNlbGVjdG9yOiAiI2ZvbyIsCiAgICAvLyAgIHJlZ2lvbkNsYXNzOiBNeUN1c3RvbVJlZ2lvbgogICAgLy8gfQogICAgLy8gYGBgCiAgICAvLwogICAgYnVpbGRSZWdpb246IGZ1bmN0aW9uKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIGlmIChfLmlzU3RyaW5nKHJlZ2lvbkNvbmZpZykpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25Gcm9tU2VsZWN0b3IocmVnaW9uQ29uZmlnLCBEZWZhdWx0UmVnaW9uQ2xhc3MpOwogICAgICB9CiAgCiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgfHwgcmVnaW9uQ29uZmlnLmVsIHx8IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcykgewogICAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbkZyb21PYmplY3QocmVnaW9uQ29uZmlnLCBEZWZhdWx0UmVnaW9uQ2xhc3MpOwogICAgICB9CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ocmVnaW9uQ29uZmlnKSkgewogICAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbkZyb21SZWdpb25DbGFzcyhyZWdpb25Db25maWcpOwogICAgICB9CiAgCiAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAnSW1wcm9wZXIgcmVnaW9uIGNvbmZpZ3VyYXRpb24gdHlwZS4nLAogICAgICAgIHVybDogJ21hcmlvbmV0dGUucmVnaW9uLmh0bWwjcmVnaW9uLWNvbmZpZ3VyYXRpb24tdHlwZXMnCiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIEJ1aWxkIHRoZSByZWdpb24gZnJvbSBhIHN0cmluZyBzZWxlY3RvciBsaWtlICcjZm9vLXJlZ2lvbicKICAgIF9idWlsZFJlZ2lvbkZyb21TZWxlY3RvcjogZnVuY3Rpb24oc2VsZWN0b3IsIERlZmF1bHRSZWdpb25DbGFzcykgewogICAgICByZXR1cm4gbmV3IERlZmF1bHRSZWdpb25DbGFzcyh7IGVsOiBzZWxlY3RvciB9KTsKICAgIH0sCiAgCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGZyb20gYSBjb25maWd1cmF0aW9uIG9iamVjdAogICAgLy8gYGBganMKICAgIC8vIHsgc2VsZWN0b3I6ICcjZm9vJywgcmVnaW9uQ2xhc3M6IEZvb1JlZ2lvbiB9CiAgICAvLyBgYGAKICAgIF9idWlsZFJlZ2lvbkZyb21PYmplY3Q6IGZ1bmN0aW9uKHJlZ2lvbkNvbmZpZywgRGVmYXVsdFJlZ2lvbkNsYXNzKSB7CiAgICAgIHZhciBSZWdpb25DbGFzcyA9IHJlZ2lvbkNvbmZpZy5yZWdpb25DbGFzcyB8fCBEZWZhdWx0UmVnaW9uQ2xhc3M7CiAgICAgIHZhciBvcHRpb25zID0gXy5vbWl0KHJlZ2lvbkNvbmZpZywgJ3NlbGVjdG9yJywgJ3JlZ2lvbkNsYXNzJyk7CiAgCiAgICAgIGlmIChyZWdpb25Db25maWcuc2VsZWN0b3IgJiYgIW9wdGlvbnMuZWwpIHsKICAgICAgICBvcHRpb25zLmVsID0gcmVnaW9uQ29uZmlnLnNlbGVjdG9yOwogICAgICB9CiAgCiAgICAgIHZhciByZWdpb24gPSBuZXcgUmVnaW9uQ2xhc3Mob3B0aW9ucyk7CiAgCiAgICAgIC8vIG92ZXJyaWRlIHRoZSBgZ2V0RWxgIGZ1bmN0aW9uIGlmIHdlIGhhdmUgYSBwYXJlbnRFbAogICAgICAvLyB0aGlzIG11c3QgYmUgb3ZlcnJpZGRlbiB0byBlbnN1cmUgdGhlIHNlbGVjdG9yIGlzIGZvdW5kCiAgICAgIC8vIG9uIHRoZSBmaXJzdCB1c2Ugb2YgdGhlIHJlZ2lvbi4gaWYgd2UgdHJ5IHRvIGFzc2lnbiB0aGUKICAgICAgLy8gcmVnaW9uJ3MgYGVsYCB0byBgcGFyZW50RWwuZmluZChzZWxlY3RvcilgIGluIHRoZSBvYmplY3QKICAgICAgLy8gbGl0ZXJhbCB0byBidWlsZCB0aGUgcmVnaW9uLCB0aGUgZWxlbWVudCB3aWxsIG5vdCBiZQogICAgICAvLyBndWFyYW50ZWVkIHRvIGJlIGluIHRoZSBET00gYWxyZWFkeSwgYW5kIHdpbGwgY2F1c2UgcHJvYmxlbXMKICAgICAgaWYgKHJlZ2lvbkNvbmZpZy5wYXJlbnRFbCkgewogICAgICAgIHJlZ2lvbi5nZXRFbCA9IGZ1bmN0aW9uKGVsKSB7CiAgICAgICAgICBpZiAoXy5pc09iamVjdChlbCkpIHsKICAgICAgICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudEVsID0gcmVnaW9uQ29uZmlnLnBhcmVudEVsOwogICAgICAgICAgaWYgKF8uaXNGdW5jdGlvbihwYXJlbnRFbCkpIHsKICAgICAgICAgICAgcGFyZW50RWwgPSBwYXJlbnRFbCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudEVsLmZpbmQoZWwpOwogICAgICAgIH07CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgIH0sCiAgCiAgICAvLyBCdWlsZCB0aGUgcmVnaW9uIGRpcmVjdGx5IGZyb20gYSBnaXZlbiBgUmVnaW9uQ2xhc3NgCiAgICBfYnVpbGRSZWdpb25Gcm9tUmVnaW9uQ2xhc3M6IGZ1bmN0aW9uKFJlZ2lvbkNsYXNzKSB7CiAgICAgIHJldHVybiBuZXcgUmVnaW9uQ2xhc3MoKTsKICAgIH0KICAKICB9KTsKICAKICAvLyBSZWdpb24gSW5zdGFuY2UgTWV0aG9kcwogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5SZWdpb24ucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAKICAgIC8vIERpc3BsYXlzIGEgYmFja2JvbmUgdmlldyBpbnN0YW5jZSBpbnNpZGUgb2YgdGhlIHJlZ2lvbi4KICAgIC8vIEhhbmRsZXMgY2FsbGluZyB0aGUgYHJlbmRlcmAgbWV0aG9kIGZvciB5b3UuIFJlYWRzIGNvbnRlbnQKICAgIC8vIGRpcmVjdGx5IGZyb20gdGhlIGBlbGAgYXR0cmlidXRlLiBBbHNvIGNhbGxzIGFuIG9wdGlvbmFsCiAgICAvLyBgb25TaG93YCBhbmQgYG9uRGVzdHJveWAgbWV0aG9kIG9uIHlvdXIgdmlldywganVzdCBhZnRlciBzaG93aW5nCiAgICAvLyBvciBqdXN0IGJlZm9yZSBkZXN0cm95aW5nIHRoZSB2aWV3LCByZXNwZWN0aXZlbHkuCiAgICAvLyBUaGUgYHByZXZlbnREZXN0cm95YCBvcHRpb24gY2FuIGJlIHVzZWQgdG8gcHJldmVudCBhIHZpZXcgZnJvbQogICAgLy8gdGhlIG9sZCB2aWV3IGJlaW5nIGRlc3Ryb3llZCBvbiBzaG93LgogICAgLy8gVGhlIGBmb3JjZVNob3dgIG9wdGlvbiBjYW4gYmUgdXNlZCB0byBmb3JjZSBhIHZpZXcgdG8gYmUKICAgIC8vIHJlLXJlbmRlcmVkIGlmIGl0J3MgYWxyZWFkeSBzaG93biBpbiB0aGUgcmVnaW9uLgogIAogICAgc2hvdzogZnVuY3Rpb24odmlldywgb3B0aW9ucyl7CiAgICAgIHRoaXMuX2Vuc3VyZUVsZW1lbnQoKTsKICAKICAgICAgdmFyIHNob3dPcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIGlzRGlmZmVyZW50VmlldyA9IHZpZXcgIT09IHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHZhciBwcmV2ZW50RGVzdHJveSA9ICAhIXNob3dPcHRpb25zLnByZXZlbnREZXN0cm95OwogICAgICB2YXIgZm9yY2VTaG93ID0gISFzaG93T3B0aW9ucy5mb3JjZVNob3c7CiAgCiAgICAgIC8vIHdlIGFyZSBvbmx5IGNoYW5naW5nIHRoZSB2aWV3IGlmIHRoZXJlIGlzIGEgdmlldyB0byBjaGFuZ2UgdG8gYmVnaW4gd2l0aAogICAgICB2YXIgaXNDaGFuZ2luZ1ZpZXcgPSAhIXRoaXMuY3VycmVudFZpZXc7CiAgCiAgICAgIC8vIG9ubHkgZGVzdHJveSB0aGUgdmlldyBpZiB3ZSBkb24ndCB3YW50IHRvIHByZXZlbnREZXN0cm95IGFuZCB0aGUgdmlldyBpcyBkaWZmZXJlbnQKICAgICAgdmFyIF9zaG91bGREZXN0cm95VmlldyA9ICFwcmV2ZW50RGVzdHJveSAmJiBpc0RpZmZlcmVudFZpZXc7CiAgCiAgICAgIC8vIHNob3cgdGhlIHZpZXcgaWYgdGhlIHZpZXcgaXMgZGlmZmVyZW50IG9yIGlmIHlvdSB3YW50IHRvIHJlLXNob3cgdGhlIHZpZXcKICAgICAgdmFyIF9zaG91bGRTaG93VmlldyA9IGlzRGlmZmVyZW50VmlldyB8fCBmb3JjZVNob3c7CiAgCiAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgfQogIAogICAgICBpZiAoX3Nob3VsZERlc3Ryb3lWaWV3KSB7CiAgICAgICAgdGhpcy5lbXB0eSgpOwogICAgICB9CiAgCiAgICAgIGlmIChfc2hvdWxkU2hvd1ZpZXcpIHsKICAKICAgICAgICAvLyBXZSBuZWVkIHRvIGxpc3RlbiBmb3IgaWYgYSB2aWV3IGlzIGRlc3Ryb3llZAogICAgICAgIC8vIGluIGEgd2F5IG90aGVyIHRoYW4gdGhyb3VnaCB0aGUgcmVnaW9uLgogICAgICAgIC8vIElmIHRoaXMgaGFwcGVucyB3ZSBuZWVkIHRvIHJlbW92ZSB0aGUgcmVmZXJlbmNlCiAgICAgICAgLy8gdG8gdGhlIGN1cnJlbnRWaWV3IHNpbmNlIG9uY2UgYSB2aWV3IGhhcyBiZWVuIGRlc3Ryb3llZAogICAgICAgIC8vIHdlIGNhbiBub3QgcmV1c2UgaXQuCiAgICAgICAgdmlldy5vbmNlKCdkZXN0cm95JywgXy5iaW5kKHRoaXMuZW1wdHksIHRoaXMpKTsKICAgICAgICB2aWV3LnJlbmRlcigpOwogIAogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3dhcCcsIHZpZXcpOwogICAgICAgIH0KICAKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzaG93Jywgdmlldyk7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgCiAgICAgICAgaWYgKGlzQ2hhbmdpbmdWaWV3KSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N3YXBPdXQnLCB0aGlzLmN1cnJlbnRWaWV3KTsKICAgICAgICB9CiAgCiAgICAgICAgdGhpcy5hdHRhY2hIdG1sKHZpZXcpOwogICAgICAgIHRoaXMuY3VycmVudFZpZXcgPSB2aWV3OwogIAogICAgICAgIGlmIChpc0NoYW5naW5nVmlldykgewogICAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzd2FwJywgdmlldyk7CiAgICAgICAgfQogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc2hvdycsIHZpZXcpOwogICAgICAgIE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uKHZpZXcsICdzaG93Jyk7CiAgCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICghXy5pc09iamVjdCh0aGlzLmVsKSkgewogICAgICAgIHRoaXMuJGVsID0gdGhpcy5nZXRFbCh0aGlzLmVsKTsKICAgICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07CiAgICAgIH0KICAKICAgICAgaWYgKCF0aGlzLiRlbCB8fCB0aGlzLiRlbC5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignQW4gImVsIiAnICsgdGhpcy4kZWwuc2VsZWN0b3IgKyAnIG11c3QgZXhpc3QgaW4gRE9NJyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBjaGFuZ2UgaG93IHRoZSByZWdpb24gZmluZHMgdGhlCiAgICAvLyBET00gZWxlbWVudCB0aGF0IGl0IG1hbmFnZXMuIFJldHVybiBhIGpRdWVyeSBzZWxlY3RvciBvYmplY3QuCiAgICBnZXRFbDogZnVuY3Rpb24oZWwpIHsKICAgICAgcmV0dXJuIEJhY2tib25lLiQoZWwpOwogICAgfSwKICAKICAgIC8vIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGNoYW5nZSBob3cgdGhlIG5ldyB2aWV3IGlzCiAgICAvLyBhcHBlbmRlZCB0byB0aGUgYCRlbGAgdGhhdCB0aGUgcmVnaW9uIGlzIG1hbmFnaW5nCiAgICBhdHRhY2hIdG1sOiBmdW5jdGlvbih2aWV3KSB7CiAgICAgIC8vIGVtcHR5IHRoZSBub2RlIGFuZCBhcHBlbmQgbmV3IHZpZXcKICAgICAgdGhpcy5lbC5pbm5lckhUTUw9Jyc7CiAgICAgIHRoaXMuZWwuYXBwZW5kQ2hpbGQodmlldy5lbCk7CiAgICB9LAogIAogICAgLy8gRGVzdHJveSB0aGUgY3VycmVudCB2aWV3LCBpZiB0aGVyZSBpcyBvbmUuIElmIHRoZXJlIGlzIG5vCiAgICAvLyBjdXJyZW50IHZpZXcsIGl0IGRvZXMgbm90aGluZyBhbmQgcmV0dXJucyBpbW1lZGlhdGVseS4KICAgIGVtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZpZXcgPSB0aGlzLmN1cnJlbnRWaWV3OwogIAogICAgICAvLyBJZiB0aGVyZSBpcyBubyB2aWV3IGluIHRoZSByZWdpb24KICAgICAgLy8gd2Ugc2hvdWxkIG5vdCByZW1vdmUgYW55dGhpbmcKICAgICAgaWYgKCF2aWV3KSB7IHJldHVybjsgfQogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTplbXB0eScsIHZpZXcpOwogICAgICB0aGlzLl9kZXN0cm95VmlldygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2VtcHR5Jywgdmlldyk7CiAgCiAgICAgIC8vIFJlbW92ZSByZWdpb24gcG9pbnRlciB0byB0aGUgY3VycmVudFZpZXcKICAgICAgZGVsZXRlIHRoaXMuY3VycmVudFZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIGNhbGwgJ2Rlc3Ryb3knIG9yICdyZW1vdmUnLCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgZm91bmQKICAgIC8vIG9uIHRoZSB2aWV3IChpZiBzaG93aW5nIGEgcmF3IEJhY2tib25lIHZpZXcgb3IgYSBNYXJpb25ldHRlIFZpZXcpCiAgICBfZGVzdHJveVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdmlldyA9IHRoaXMuY3VycmVudFZpZXc7CiAgCiAgICAgIGlmICh2aWV3LmRlc3Ryb3kgJiYgIXZpZXcuaXNEZXN0cm95ZWQpIHsKICAgICAgICB2aWV3LmRlc3Ryb3koKTsKICAgICAgfSBlbHNlIGlmICh2aWV3LnJlbW92ZSkgewogICAgICAgIHZpZXcucmVtb3ZlKCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBBdHRhY2ggYW4gZXhpc3RpbmcgdmlldyB0byB0aGUgcmVnaW9uLiBUaGlzCiAgICAvLyB3aWxsIG5vdCBjYWxsIGByZW5kZXJgIG9yIGBvblNob3dgIGZvciB0aGUgbmV3IHZpZXcsCiAgICAvLyBhbmQgd2lsbCBub3QgcmVwbGFjZSB0aGUgY3VycmVudCBIVE1MIGZvciB0aGUgYGVsYAogICAgLy8gb2YgdGhlIHJlZ2lvbi4KICAgIGF0dGFjaFZpZXc6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdGhpcy5jdXJyZW50VmlldyA9IHZpZXc7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIENoZWNrcyB3aGV0aGVyIGEgdmlldyBpcyBjdXJyZW50bHkgcHJlc2VudCB3aXRoaW4KICAgIC8vIHRoZSByZWdpb24uIFJldHVybnMgYHRydWVgIGlmIHRoZXJlIGlzIGFuZCBgZmFsc2VgIGlmCiAgICAvLyBubyB2aWV3IGlzIHByZXNlbnQuCiAgICBoYXNWaWV3OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50VmlldzsKICAgIH0sCiAgCiAgICAvLyBSZXNldCB0aGUgcmVnaW9uIGJ5IGRlc3Ryb3lpbmcgYW55IGV4aXN0aW5nIHZpZXcgYW5kCiAgICAvLyBjbGVhcmluZyBvdXQgdGhlIGNhY2hlZCBgJGVsYC4gVGhlIG5leHQgdGltZSBhIHZpZXcKICAgIC8vIGlzIHNob3duIHZpYSB0aGlzIHJlZ2lvbiwgdGhlIHJlZ2lvbiB3aWxsIHJlLXF1ZXJ5IHRoZQogICAgLy8gRE9NIGZvciB0aGUgcmVnaW9uJ3MgYGVsYC4KICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5lbXB0eSgpOwogIAogICAgICBpZiAodGhpcy4kZWwpIHsKICAgICAgICB0aGlzLmVsID0gdGhpcy4kZWwuc2VsZWN0b3I7CiAgICAgIH0KICAKICAgICAgZGVsZXRlIHRoaXMuJGVsOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbiwKICAKICAgIC8vIGltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kCiAgfSk7CiAgCiAgLy8gQ29weSB0aGUgYGV4dGVuZGAgZnVuY3Rpb24gdXNlZCBieSBCYWNrYm9uZSdzIGNsYXNzZXMKICBNYXJpb25ldHRlLlJlZ2lvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvLyBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAvLwogIC8vIE1hbmFnZSBvbmUgb3IgbW9yZSByZWxhdGVkIGBNYXJpb25ldHRlLlJlZ2lvbmAgb2JqZWN0cy4KICBNYXJpb25ldHRlLlJlZ2lvbk1hbmFnZXIgPSAoZnVuY3Rpb24oTWFyaW9uZXR0ZSkgewogIAogICAgdmFyIFJlZ2lvbk1hbmFnZXIgPSBNYXJpb25ldHRlLkNvbnRyb2xsZXIuZXh0ZW5kKHsKICAgICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICB0aGlzLl9yZWdpb25zID0ge307CiAgICAgICAgTWFyaW9uZXR0ZS5Db250cm9sbGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAgIH0sCiAgCiAgICAgIC8vIEFkZCBtdWx0aXBsZSByZWdpb25zIHVzaW5nIGFuIG9iamVjdCBsaXRlcmFsIG9yIGEKICAgICAgLy8gZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIG9iamVjdCBsaXRlcmFsLCB3aGVyZQogICAgICAvLyBlYWNoIGtleSBiZWNvbWVzIHRoZSByZWdpb24gbmFtZSwgYW5kIGVhY2ggdmFsdWUgaXMKICAgICAgLy8gdGhlIHJlZ2lvbiBkZWZpbml0aW9uLgogICAgICBhZGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25EZWZpbml0aW9ucywgZGVmYXVsdHMpIHsKICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHJlZ2lvbkRlZmluaXRpb25zKSkgewogICAgICAgICAgcmVnaW9uRGVmaW5pdGlvbnMgPSByZWdpb25EZWZpbml0aW9ucy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAKICAgICAgICB2YXIgcmVnaW9ucyA9IHt9OwogIAogICAgICAgIF8uZWFjaChyZWdpb25EZWZpbml0aW9ucywgZnVuY3Rpb24oZGVmaW5pdGlvbiwgbmFtZSkgewogICAgICAgICAgaWYgKF8uaXNTdHJpbmcoZGVmaW5pdGlvbikpIHsKICAgICAgICAgICAgZGVmaW5pdGlvbiA9IHtzZWxlY3RvcjogZGVmaW5pdGlvbn07CiAgICAgICAgICB9CiAgCiAgICAgICAgICBpZiAoZGVmaW5pdGlvbi5zZWxlY3RvcikgewogICAgICAgICAgICBkZWZpbml0aW9uID0gXy5kZWZhdWx0cyh7fSwgZGVmaW5pdGlvbiwgZGVmYXVsdHMpOwogICAgICAgICAgfQogIAogICAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuYWRkUmVnaW9uKG5hbWUsIGRlZmluaXRpb24pOwogICAgICAgICAgcmVnaW9uc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB9LCB0aGlzKTsKICAKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAKICAgICAgLy8gQWRkIGFuIGluZGl2aWR1YWwgcmVnaW9uIHRvIHRoZSByZWdpb24gbWFuYWdlciwKICAgICAgLy8gYW5kIHJldHVybiB0aGUgcmVnaW9uIGluc3RhbmNlCiAgICAgIGFkZFJlZ2lvbjogZnVuY3Rpb24obmFtZSwgZGVmaW5pdGlvbikgewogICAgICAgIHZhciByZWdpb247CiAgCiAgICAgICAgaWYgKGRlZmluaXRpb24gaW5zdGFuY2VvZiBNYXJpb25ldHRlLlJlZ2lvbikgewogICAgICAgICAgcmVnaW9uID0gZGVmaW5pdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVnaW9uID0gTWFyaW9uZXR0ZS5SZWdpb24uYnVpbGRSZWdpb24oZGVmaW5pdGlvbiwgTWFyaW9uZXR0ZS5SZWdpb24pOwogICAgICAgIH0KICAKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAKICAgICAgICB0aGlzLl9zdG9yZShuYW1lLCByZWdpb24pOwogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgICAgfSwKICAKICAgICAgLy8gR2V0IGEgcmVnaW9uIGJ5IG5hbWUKICAgICAgZ2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbnNbbmFtZV07CiAgICAgIH0sCiAgCiAgICAgIC8vIEdldHMgYWxsIHRoZSByZWdpb25zIGNvbnRhaW5lZCB3aXRoaW4KICAgICAgLy8gdGhlIGByZWdpb25NYW5hZ2VyYCBpbnN0YW5jZS4KICAgICAgZ2V0UmVnaW9uczogZnVuY3Rpb24oKXsKICAgICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9yZWdpb25zKTsKICAgICAgfSwKICAKICAgICAgLy8gUmVtb3ZlIGEgcmVnaW9uIGJ5IG5hbWUKICAgICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdmFyIHJlZ2lvbiA9IHRoaXMuX3JlZ2lvbnNbbmFtZV07CiAgICAgICAgdGhpcy5fcmVtb3ZlKG5hbWUsIHJlZ2lvbik7CiAgCiAgICAgICAgcmV0dXJuIHJlZ2lvbjsKICAgICAgfSwKICAKICAgICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIHJlZ2lvbiBtYW5hZ2VyLCBhbmQKICAgICAgLy8gcmVtb3ZlIHRoZW0KICAgICAgcmVtb3ZlUmVnaW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHJlZ2lvbnMgPSB0aGlzLmdldFJlZ2lvbnMoKTsKICAgICAgICBfLmVhY2godGhpcy5fcmVnaW9ucywgZnVuY3Rpb24ocmVnaW9uLCBuYW1lKSB7CiAgICAgICAgICB0aGlzLl9yZW1vdmUobmFtZSwgcmVnaW9uKTsKICAgICAgICB9LCB0aGlzKTsKICAKICAgICAgICByZXR1cm4gcmVnaW9uczsKICAgICAgfSwKICAKICAgICAgLy8gRW1wdHkgYWxsIHJlZ2lvbnMgaW4gdGhlIHJlZ2lvbiBtYW5hZ2VyLCBidXQKICAgICAgLy8gbGVhdmUgdGhlbSBhdHRhY2hlZAogICAgICBlbXB0eVJlZ2lvbnM6IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciByZWdpb25zID0gdGhpcy5nZXRSZWdpb25zKCk7CiAgICAgICAgXy5lYWNoKHJlZ2lvbnMsIGZ1bmN0aW9uKHJlZ2lvbikgewogICAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgfSwgdGhpcyk7CiAgCiAgICAgICAgcmV0dXJuIHJlZ2lvbnM7CiAgICAgIH0sCiAgCiAgICAgIC8vIERlc3Ryb3kgYWxsIHJlZ2lvbnMgYW5kIHNodXQgZG93biB0aGUgcmVnaW9uCiAgICAgIC8vIG1hbmFnZXIgZW50aXJlbHkKICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5yZW1vdmVSZWdpb25zKCk7CiAgICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuQ29udHJvbGxlci5wcm90b3R5cGUuZGVzdHJveS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9LAogIAogICAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gc3RvcmUgcmVnaW9ucwogICAgICBfc3RvcmU6IGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIHRoaXMuX3JlZ2lvbnNbbmFtZV0gPSByZWdpb247CiAgICAgICAgdGhpcy5fc2V0TGVuZ3RoKCk7CiAgICAgIH0sCiAgCiAgICAgIC8vIGludGVybmFsIG1ldGhvZCB0byByZW1vdmUgYSByZWdpb24KICAgICAgX3JlbW92ZTogZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgICAgcmVnaW9uLmVtcHR5KCk7CiAgICAgICAgcmVnaW9uLnN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICBkZWxldGUgdGhpcy5fcmVnaW9uc1tuYW1lXTsKICAgICAgICB0aGlzLl9zZXRMZW5ndGgoKTsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbW92ZTpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9LAogIAogICAgICAvLyBzZXQgdGhlIG51bWJlciBvZiByZWdpb25zIGN1cnJlbnQgaGVsZAogICAgICBfc2V0TGVuZ3RoOiBmdW5jdGlvbigpIHsKICAgICAgICB0aGlzLmxlbmd0aCA9IF8uc2l6ZSh0aGlzLl9yZWdpb25zKTsKICAgICAgfQogIAogICAgfSk7CiAgCiAgICBNYXJpb25ldHRlLmFjdEFzQ29sbGVjdGlvbihSZWdpb25NYW5hZ2VyLnByb3RvdHlwZSwgJ19yZWdpb25zJyk7CiAgCiAgICByZXR1cm4gUmVnaW9uTWFuYWdlcjsKICB9KShNYXJpb25ldHRlKTsKICAKCiAgLy8gVGVtcGxhdGUgQ2FjaGUKICAvLyAtLS0tLS0tLS0tLS0tLQogIAogIC8vIE1hbmFnZSB0ZW1wbGF0ZXMgc3RvcmVkIGluIGA8c2NyaXB0PmAgYmxvY2tzLAogIC8vIGNhY2hpbmcgdGhlbSBmb3IgZmFzdGVyIGFjY2Vzcy4KICBNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUgPSBmdW5jdGlvbih0ZW1wbGF0ZUlkKSB7CiAgICB0aGlzLnRlbXBsYXRlSWQgPSB0ZW1wbGF0ZUlkOwogIH07CiAgCiAgLy8gVGVtcGxhdGVDYWNoZSBvYmplY3QtbGV2ZWwgbWV0aG9kcy4gTWFuYWdlIHRoZSB0ZW1wbGF0ZQogIC8vIGNhY2hlcyBmcm9tIHRoZXNlIG1ldGhvZCBjYWxscyBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgLy8geW91ciBvd24gVGVtcGxhdGVDYWNoZSBpbnN0YW5jZXMKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUsIHsKICAgIHRlbXBsYXRlQ2FjaGVzOiB7fSwKICAKICAgIC8vIEdldCB0aGUgc3BlY2lmaWVkIHRlbXBsYXRlIGJ5IGlkLiBFaXRoZXIKICAgIC8vIHJldHJpZXZlcyB0aGUgY2FjaGVkIHZlcnNpb24sIG9yIGxvYWRzIGl0CiAgICAvLyBmcm9tIHRoZSBET00uCiAgICBnZXQ6IGZ1bmN0aW9uKHRlbXBsYXRlSWQpIHsKICAgICAgdmFyIGNhY2hlZFRlbXBsYXRlID0gdGhpcy50ZW1wbGF0ZUNhY2hlc1t0ZW1wbGF0ZUlkXTsKICAKICAgICAgaWYgKCFjYWNoZWRUZW1wbGF0ZSkgewogICAgICAgIGNhY2hlZFRlbXBsYXRlID0gbmV3IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZSh0ZW1wbGF0ZUlkKTsKICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGVzW3RlbXBsYXRlSWRdID0gY2FjaGVkVGVtcGxhdGU7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGNhY2hlZFRlbXBsYXRlLmxvYWQoKTsKICAgIH0sCiAgCiAgICAvLyBDbGVhciB0ZW1wbGF0ZXMgZnJvbSB0aGUgY2FjaGUuIElmIG5vIGFyZ3VtZW50cwogICAgLy8gYXJlIHNwZWNpZmllZCwgY2xlYXJzIGFsbCB0ZW1wbGF0ZXM6CiAgICAvLyBgY2xlYXIoKWAKICAgIC8vCiAgICAvLyBJZiBhcmd1bWVudHMgYXJlIHNwZWNpZmllZCwgY2xlYXJzIGVhY2ggb2YgdGhlCiAgICAvLyBzcGVjaWZpZWQgdGVtcGxhdGVzIGZyb20gdGhlIGNhY2hlOgogICAgLy8gYGNsZWFyKCIjdDEiLCAiI3QyIiwgIi4uLiIpYAogICAgY2xlYXI6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaTsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHZhciBsZW5ndGggPSBhcmdzLmxlbmd0aDsKICAKICAgICAgaWYgKGxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLnRlbXBsYXRlQ2FjaGVzW2FyZ3NbaV1dOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGVzID0ge307CiAgICAgIH0KICAgIH0KICB9KTsKICAKICAvLyBUZW1wbGF0ZUNhY2hlIGluc3RhbmNlIG1ldGhvZHMsIGFsbG93aW5nIGVhY2gKICAvLyB0ZW1wbGF0ZSBjYWNoZSBvYmplY3QgdG8gbWFuYWdlIGl0cyBvd24gc3RhdGUKICAvLyBhbmQga25vdyB3aGV0aGVyIG9yIG5vdCBpdCBoYXMgYmVlbiBsb2FkZWQKICBfLmV4dGVuZChNYXJpb25ldHRlLlRlbXBsYXRlQ2FjaGUucHJvdG90eXBlLCB7CiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gbG9hZCB0aGUgdGVtcGxhdGUKICAgIGxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAvLyBHdWFyZCBjbGF1c2UgdG8gcHJldmVudCBsb2FkaW5nIHRoaXMgdGVtcGxhdGUgbW9yZSB0aGFuIG9uY2UKICAgICAgaWYgKHRoaXMuY29tcGlsZWRUZW1wbGF0ZSkgewogICAgICAgIHJldHVybiB0aGlzLmNvbXBpbGVkVGVtcGxhdGU7CiAgICAgIH0KICAKICAgICAgLy8gTG9hZCB0aGUgdGVtcGxhdGUgYW5kIGNvbXBpbGUgaXQKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5sb2FkVGVtcGxhdGUodGhpcy50ZW1wbGF0ZUlkKTsKICAgICAgdGhpcy5jb21waWxlZFRlbXBsYXRlID0gdGhpcy5jb21waWxlVGVtcGxhdGUodGVtcGxhdGUpOwogIAogICAgICByZXR1cm4gdGhpcy5jb21waWxlZFRlbXBsYXRlOwogICAgfSwKICAKICAgIC8vIExvYWQgYSB0ZW1wbGF0ZSBmcm9tIHRoZSBET00sIGJ5IGRlZmF1bHQuIE92ZXJyaWRlCiAgICAvLyB0aGlzIG1ldGhvZCB0byBwcm92aWRlIHlvdXIgb3duIHRlbXBsYXRlIHJldHJpZXZhbAogICAgLy8gRm9yIGFzeW5jaHJvbm91cyBsb2FkaW5nIHdpdGggQU1EL1JlcXVpcmVKUywgY29uc2lkZXIKICAgIC8vIHVzaW5nIGEgdGVtcGxhdGUtbG9hZGVyIHBsdWdpbiBhcyBkZXNjcmliZWQgaGVyZToKICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJpb25ldHRlanMvYmFja2JvbmUubWFyaW9uZXR0ZS93aWtpL1VzaW5nLW1hcmlvbmV0dGUtd2l0aC1yZXF1aXJlanMKICAgIGxvYWRUZW1wbGF0ZTogZnVuY3Rpb24odGVtcGxhdGVJZCkgewogICAgICB2YXIgdGVtcGxhdGUgPSBCYWNrYm9uZS4kKHRlbXBsYXRlSWQpLmh0bWwoKTsKICAKICAgICAgaWYgKCF0ZW1wbGF0ZSB8fCB0ZW1wbGF0ZS5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9UZW1wbGF0ZUVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdDb3VsZCBub3QgZmluZCB0ZW1wbGF0ZTogIicgKyB0ZW1wbGF0ZUlkICsgJyInCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfSwKICAKICAgIC8vIFByZS1jb21waWxlIHRoZSB0ZW1wbGF0ZSBiZWZvcmUgY2FjaGluZyBpdC4gT3ZlcnJpZGUKICAgIC8vIHRoaXMgbWV0aG9kIGlmIHlvdSBkbyBub3QgbmVlZCB0byBwcmUtY29tcGlsZSBhIHRlbXBsYXRlCiAgICAvLyAoSlNUIC8gUmVxdWlyZUpTIGZvciBleGFtcGxlKSBvciBpZiB5b3Ugd2FudCB0byBjaGFuZ2UKICAgIC8vIHRoZSB0ZW1wbGF0ZSBlbmdpbmUgdXNlZCAoSGFuZGViYXJzLCBldGMpLgogICAgY29tcGlsZVRlbXBsYXRlOiBmdW5jdGlvbihyYXdUZW1wbGF0ZSkgewogICAgICByZXR1cm4gXy50ZW1wbGF0ZShyYXdUZW1wbGF0ZSk7CiAgICB9CiAgfSk7CiAgCiAgLy8gUmVuZGVyZXIKICAvLyAtLS0tLS0tLQogIAogIC8vIFJlbmRlciBhIHRlbXBsYXRlIHdpdGggZGF0YSBieSBwYXNzaW5nIGluIHRoZSB0ZW1wbGF0ZQogIC8vIHNlbGVjdG9yIGFuZCB0aGUgZGF0YSB0byByZW5kZXIuCiAgTWFyaW9uZXR0ZS5SZW5kZXJlciA9IHsKICAKICAgIC8vIFJlbmRlciBhIHRlbXBsYXRlIHdpdGggZGF0YS4gVGhlIGB0ZW1wbGF0ZWAgcGFyYW1ldGVyIGlzCiAgICAvLyBwYXNzZWQgdG8gdGhlIGBUZW1wbGF0ZUNhY2hlYCBvYmplY3QgdG8gcmV0cmlldmUgdGhlCiAgICAvLyB0ZW1wbGF0ZSBmdW5jdGlvbi4gT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gcHJvdmlkZSB5b3VyIG93bgogICAgLy8gY3VzdG9tIHJlbmRlcmluZyBhbmQgdGVtcGxhdGUgaGFuZGxpbmcgZm9yIGFsbCBvZiBNYXJpb25ldHRlLgogICAgcmVuZGVyOiBmdW5jdGlvbih0ZW1wbGF0ZSwgZGF0YSkgewogICAgICBpZiAoIXRlbXBsYXRlKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1RlbXBsYXRlTm90Rm91bmRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQ2Fubm90IHJlbmRlciB0aGUgdGVtcGxhdGUgc2luY2UgaXRzIGZhbHNlLCBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgdmFyIHRlbXBsYXRlRnVuYzsKICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IHRlbXBsYXRlOwogICAgICB9IGVsc2UgewogICAgICAgIHRlbXBsYXRlRnVuYyA9IE1hcmlvbmV0dGUuVGVtcGxhdGVDYWNoZS5nZXQodGVtcGxhdGUpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB0ZW1wbGF0ZUZ1bmMoZGF0YSk7CiAgICB9CiAgfTsKICAKCiAgLyoganNoaW50IG1heGxlbjogMTE0LCBub25ldzogZmFsc2UgKi8KICAvLyBNYXJpb25ldHRlLlZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAKICAvLyBUaGUgY29yZSB2aWV3IGNsYXNzIHRoYXQgb3RoZXIgTWFyaW9uZXR0ZSB2aWV3cyBleHRlbmQgZnJvbS4KICBNYXJpb25ldHRlLlZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7CiAgCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBfLmJpbmRBbGwodGhpcywgJ3JlbmRlcicpOwogIAogICAgICAvLyB0aGlzIGV4cG9zZXMgdmlldyBvcHRpb25zIHRvIHRoZSB2aWV3IGluaXRpYWxpemVyCiAgICAgIC8vIHRoaXMgaXMgYSBiYWNrZmlsbCBzaW5jZSBiYWNrYm9uZSByZW1vdmVkIHRoZSBhc3NpZ25tZW50CiAgICAgIC8vIG9mIHRoaXMub3B0aW9ucwogICAgICAvLyBhdCBzb21lIHBvaW50IGhvd2V2ZXIgdGhpcyBtYXkgYmUgcmVtb3ZlZAogICAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgXy5pc0Z1bmN0aW9uKG9wdGlvbnMpID8gb3B0aW9ucy5jYWxsKHRoaXMpIDogb3B0aW9ucyk7CiAgCiAgICAgIHRoaXMuX2JlaGF2aW9ycyA9IE1hcmlvbmV0dGUuQmVoYXZpb3JzKHRoaXMpOwogIAogICAgICBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIE1hcmlvbmV0dGUuTW9uaXRvckRPTVJlZnJlc2godGhpcyk7CiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgJ3Nob3cnLCB0aGlzLm9uU2hvd0NhbGxlZCk7CiAgICB9LAogIAogICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZSBmb3IgdGhpcyB2aWV3CiAgICAvLyBpbnN0YW5jZS4gWW91IGNhbiBzZXQgYSBgdGVtcGxhdGVgIGF0dHJpYnV0ZSBpbiB0aGUgdmlldwogICAgLy8gZGVmaW5pdGlvbiBvciBwYXNzIGEgYHRlbXBsYXRlOiAid2hhdGV2ZXIiYCBwYXJhbWV0ZXIgaW4KICAgIC8vIHRvIHRoZSBjb25zdHJ1Y3RvciBvcHRpb25zLgogICAgZ2V0VGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRPcHRpb24oJ3RlbXBsYXRlJyk7CiAgICB9LAogIAogICAgLy8gU2VyaWFsaXplIGEgbW9kZWwgYnkgcmV0dXJuaW5nIGl0cyBhdHRyaWJ1dGVzLiBDbG9uZXMKICAgIC8vIHRoZSBhdHRyaWJ1dGVzIHRvIGFsbG93IG1vZGlmaWNhdGlvbi4KICAgIHNlcmlhbGl6ZU1vZGVsOiBmdW5jdGlvbihtb2RlbCl7CiAgICAgIHJldHVybiBtb2RlbC50b0pTT04uYXBwbHkobW9kZWwsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogIAogICAgLy8gTWl4IGluIHRlbXBsYXRlIGhlbHBlciBtZXRob2RzLiBMb29rcyBmb3IgYQogICAgLy8gYHRlbXBsYXRlSGVscGVyc2AgYXR0cmlidXRlLCB3aGljaCBjYW4gZWl0aGVyIGJlIGFuCiAgICAvLyBvYmplY3QgbGl0ZXJhbCwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgYW4gb2JqZWN0CiAgICAvLyBsaXRlcmFsLiBBbGwgbWV0aG9kcyBhbmQgYXR0cmlidXRlcyBmcm9tIHRoaXMgb2JqZWN0CiAgICAvLyBhcmUgY29waWVzIHRvIHRoZSBvYmplY3QgcGFzc2VkIGluLgogICAgbWl4aW5UZW1wbGF0ZUhlbHBlcnM6IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB0YXJnZXQgPSB0YXJnZXQgfHwge307CiAgICAgIHZhciB0ZW1wbGF0ZUhlbHBlcnMgPSB0aGlzLmdldE9wdGlvbigndGVtcGxhdGVIZWxwZXJzJyk7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGVtcGxhdGVIZWxwZXJzKSkgewogICAgICAgIHRlbXBsYXRlSGVscGVycyA9IHRlbXBsYXRlSGVscGVycy5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIHJldHVybiBfLmV4dGVuZCh0YXJnZXQsIHRlbXBsYXRlSGVscGVycyk7CiAgICB9LAogIAogICAgLy8gbm9ybWFsaXplIHRoZSBrZXlzIG9mIHBhc3NlZCBoYXNoIHdpdGggdGhlIHZpZXdzIGB1aWAgc2VsZWN0b3JzLgogICAgLy8gYHsiQHVpLmZvbyI6ICJiYXIifWAKICAgIG5vcm1hbGl6ZVVJS2V5czogZnVuY3Rpb24oaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKGhhc2gsIHVpQmluZGluZ3MgfHwgdWkpOwogICAgfSwKICAKICAgIC8vIG5vcm1hbGl6ZSB0aGUgdmFsdWVzIG9mIHBhc3NlZCBoYXNoIHdpdGggdGhlIHZpZXdzIGB1aWAgc2VsZWN0b3JzLgogICAgLy8gYHtmb286ICJAdWkuYmFyIn1gCiAgICBub3JtYWxpemVVSVZhbHVlczogZnVuY3Rpb24oaGFzaCkgewogICAgICB2YXIgdWkgPSBfLnJlc3VsdCh0aGlzLCAndWknKTsKICAgICAgdmFyIHVpQmluZGluZ3MgPSBfLnJlc3VsdCh0aGlzLCAnX3VpQmluZGluZ3MnKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUubm9ybWFsaXplVUlWYWx1ZXMoaGFzaCwgdWlCaW5kaW5ncyB8fCB1aSk7CiAgICB9LAogIAogICAgLy8gQ29uZmlndXJlIGB0cmlnZ2Vyc2AgdG8gZm9yd2FyZCBET00gZXZlbnRzIHRvIHZpZXcKICAgIC8vIGV2ZW50cy4gYHRyaWdnZXJzOiB7ImNsaWNrIC5mb28iOiAiZG86Zm9vIn1gCiAgICBjb25maWd1cmVUcmlnZ2VyczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy50cmlnZ2VycykgeyByZXR1cm47IH0KICAKICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSB7fTsKICAKICAgICAgLy8gQWxsb3cgYHRyaWdnZXJzYCB0byBiZSBjb25maWd1cmVkIGFzIGEgZnVuY3Rpb24KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5ub3JtYWxpemVVSUtleXMoXy5yZXN1bHQodGhpcywgJ3RyaWdnZXJzJykpOwogIAogICAgICAvLyBDb25maWd1cmUgdGhlIHRyaWdnZXJzLCBwcmV2ZW50IGRlZmF1bHQKICAgICAgLy8gYWN0aW9uIGFuZCBzdG9wIHByb3BhZ2F0aW9uIG9mIERPTSBldmVudHMKICAgICAgXy5lYWNoKHRyaWdnZXJzLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdHJpZ2dlckV2ZW50c1trZXldID0gdGhpcy5fYnVpbGRWaWV3VHJpZ2dlcih2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICByZXR1cm4gdHJpZ2dlckV2ZW50czsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkaW5nIEJhY2tib25lLlZpZXcncyBkZWxlZ2F0ZUV2ZW50cyB0byBoYW5kbGUKICAgIC8vIHRoZSBgdHJpZ2dlcnNgLCBgbW9kZWxFdmVudHNgLCBhbmQgYGNvbGxlY3Rpb25FdmVudHNgIGNvbmZpZ3VyYXRpb24KICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpIHsKICAgICAgdGhpcy5fZGVsZWdhdGVET01FdmVudHMoZXZlbnRzKTsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKHRoaXMubW9kZWwsIHRoaXMuZ2V0T3B0aW9uKCdtb2RlbEV2ZW50cycpKTsKICAgICAgdGhpcy5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgCiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCBiZWhhdmlvci5nZXRPcHRpb24oJ21vZGVsRXZlbnRzJykpOwogICAgICAgIGJlaGF2aW9yLmJpbmRFbnRpdHlFdmVudHModGhpcy5jb2xsZWN0aW9uLCBiZWhhdmlvci5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBpbnRlcm5hbCBtZXRob2QgdG8gZGVsZWdhdGUgRE9NIGV2ZW50cyBhbmQgdHJpZ2dlcnMKICAgIF9kZWxlZ2F0ZURPTUV2ZW50czogZnVuY3Rpb24oZXZlbnRzQXJnKSB7CiAgICAgIHZhciBldmVudHMgPSBldmVudHNBcmcgfHwgdGhpcy5ldmVudHM7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZXZlbnRzKSkgeyBldmVudHMgPSBldmVudHMuY2FsbCh0aGlzKTsgfQogIAogICAgICAvLyBub3JtYWxpemUgdWkga2V5cwogICAgICBldmVudHMgPSB0aGlzLm5vcm1hbGl6ZVVJS2V5cyhldmVudHMpOwogICAgICBpZihfLmlzVW5kZWZpbmVkKGV2ZW50c0FyZykpIHt0aGlzLmV2ZW50cyA9IGV2ZW50czt9CiAgCiAgICAgIHZhciBjb21iaW5lZEV2ZW50cyA9IHt9OwogIAogICAgICAvLyBsb29rIHVwIGlmIHRoaXMgdmlldyBoYXMgYmVoYXZpb3IgZXZlbnRzCiAgICAgIHZhciBiZWhhdmlvckV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdiZWhhdmlvckV2ZW50cycpIHx8IHt9OwogICAgICB2YXIgdHJpZ2dlcnMgPSB0aGlzLmNvbmZpZ3VyZVRyaWdnZXJzKCk7CiAgICAgIHZhciBiZWhhdmlvclRyaWdnZXJzID0gXy5yZXN1bHQodGhpcywgJ2JlaGF2aW9yVHJpZ2dlcnMnKSB8fCB7fTsKICAKICAgICAgLy8gYmVoYXZpb3IgZXZlbnRzIHdpbGwgYmUgb3ZlcnJpZGVuIGJ5IHZpZXcgZXZlbnRzIGFuZCBvciB0cmlnZ2VycwogICAgICBfLmV4dGVuZChjb21iaW5lZEV2ZW50cywgYmVoYXZpb3JFdmVudHMsIGV2ZW50cywgdHJpZ2dlcnMsIGJlaGF2aW9yVHJpZ2dlcnMpOwogIAogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5kZWxlZ2F0ZUV2ZW50cy5jYWxsKHRoaXMsIGNvbWJpbmVkRXZlbnRzKTsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkaW5nIEJhY2tib25lLlZpZXcncyB1bmRlbGVnYXRlRXZlbnRzIHRvIGhhbmRsZSB1bmJpbmRpbmcKICAgIC8vIHRoZSBgdHJpZ2dlcnNgLCBgbW9kZWxFdmVudHNgLCBhbmQgYGNvbGxlY3Rpb25FdmVudHNgIGNvbmZpZwogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS51bmRlbGVnYXRlRXZlbnRzLmFwcGx5KHRoaXMsIGFyZ3MpOwogIAogICAgICB0aGlzLnVuYmluZEVudGl0eUV2ZW50cyh0aGlzLm1vZGVsLCB0aGlzLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgIHRoaXMudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgdGhpcy5nZXRPcHRpb24oJ2NvbGxlY3Rpb25FdmVudHMnKSk7CiAgCiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGJlaGF2aW9yKSB7CiAgICAgICAgYmVoYXZpb3IudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMubW9kZWwsIGJlaGF2aW9yLmdldE9wdGlvbignbW9kZWxFdmVudHMnKSk7CiAgICAgICAgYmVoYXZpb3IudW5iaW5kRW50aXR5RXZlbnRzKHRoaXMuY29sbGVjdGlvbiwgYmVoYXZpb3IuZ2V0T3B0aW9uKCdjb2xsZWN0aW9uRXZlbnRzJykpOwogICAgICB9LCB0aGlzKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLCBoYW5kbGVzIHRoZSBgc2hvd2AgZXZlbnQuCiAgICBvblNob3dDYWxsZWQ6IGZ1bmN0aW9uKCkge30sCiAgCiAgICAvLyBJbnRlcm5hbCBoZWxwZXIgbWV0aG9kIHRvIHZlcmlmeSB3aGV0aGVyIHRoZSB2aWV3IGhhc24ndCBiZWVuIGRlc3Ryb3llZAogICAgX2Vuc3VyZVZpZXdJc0ludGFjdDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzRGVzdHJveWVkKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgbmFtZTogJ1ZpZXdEZXN0cm95ZWRFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnVmlldyAoY2lkOiAiJyArIHRoaXMuY2lkICsgJyIpIGhhcyBhbHJlYWR5IGJlZW4gZGVzdHJveWVkIGFuZCBjYW5ub3QgYmUgdXNlZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBEZWZhdWx0IGBkZXN0cm95YCBpbXBsZW1lbnRhdGlvbiwgZm9yIHJlbW92aW5nIGEgdmlldyBmcm9tIHRoZQogICAgLy8gRE9NIGFuZCB1bmJpbmRpbmcgaXQuIFJlZ2lvbnMgd2lsbCBjYWxsIHRoaXMgbWV0aG9kCiAgICAvLyBmb3IgeW91LiBZb3UgY2FuIHNwZWNpZnkgYW4gYG9uRGVzdHJveWAgbWV0aG9kIGluIHlvdXIgdmlldyB0bwogICAgLy8gYWRkIGN1c3RvbSBjb2RlIHRoYXQgaXMgY2FsbGVkIGFmdGVyIHRoZSB2aWV3IGlzIGRlc3Ryb3llZC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5pc0Rlc3Ryb3llZCkgeyByZXR1cm47IH0KICAKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZC5hcHBseSh0aGlzLCBbJ2JlZm9yZTpkZXN0cm95J10uY29uY2F0KGFyZ3MpKTsKICAKICAgICAgLy8gbWFyayBhcyBkZXN0cm95ZWQgYmVmb3JlIGRvaW5nIHRoZSBhY3R1YWwgZGVzdHJveSwgdG8KICAgICAgLy8gcHJldmVudCBpbmZpbml0ZSBsb29wcyB3aXRoaW4gImRlc3Ryb3kiIGV2ZW50IGhhbmRsZXJzCiAgICAgIC8vIHRoYXQgYXJlIHRyeWluZyB0byBkZXN0cm95IG90aGVyIHZpZXdzCiAgICAgIHRoaXMuaXNEZXN0cm95ZWQgPSB0cnVlOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgWydkZXN0cm95J10uY29uY2F0KGFyZ3MpKTsKICAKICAgICAgLy8gdW5iaW5kIFVJIGVsZW1lbnRzCiAgICAgIHRoaXMudW5iaW5kVUlFbGVtZW50cygpOwogIAogICAgICAvLyByZW1vdmUgdGhlIHZpZXcgZnJvbSB0aGUgRE9NCiAgICAgIHRoaXMucmVtb3ZlKCk7CiAgCiAgICAgIC8vIENhbGwgZGVzdHJveSBvbiBlYWNoIGJlaGF2aW9yIGFmdGVyCiAgICAgIC8vIGRlc3Ryb3lpbmcgdGhlIHZpZXcuCiAgICAgIC8vIFRoaXMgdW5iaW5kcyBldmVudCBsaXN0ZW5lcnMKICAgICAgLy8gdGhhdCBiZWhhdmlvcnMgaGF2ZSByZWdpc3RlcmQgZm9yLgogICAgICBfLmludm9rZSh0aGlzLl9iZWhhdmlvcnMsICdkZXN0cm95JywgYXJncyk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIGJpbmRVSUVsZW1lbnRzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fYmluZFVJRWxlbWVudHMoKTsKICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCB0aGlzLl9iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogIAogICAgLy8gVGhpcyBtZXRob2QgYmluZHMgdGhlIGVsZW1lbnRzIHNwZWNpZmllZCBpbiB0aGUgInVpIiBoYXNoIGluc2lkZSB0aGUgdmlldydzIGNvZGUgd2l0aAogICAgLy8gdGhlIGFzc29jaWF0ZWQgalF1ZXJ5IHNlbGVjdG9ycy4KICAgIF9iaW5kVUlFbGVtZW50czogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy51aSkgeyByZXR1cm47IH0KICAKICAgICAgLy8gc3RvcmUgdGhlIHVpIGhhc2ggaW4gX3VpQmluZGluZ3Mgc28gdGhleSBjYW4gYmUgcmVzZXQgbGF0ZXIKICAgICAgLy8gYW5kIHNvIHJlLXJlbmRlcmluZyB0aGUgdmlldyB3aWxsIGJlIGFibGUgdG8gZmluZCB0aGUgYmluZGluZ3MKICAgICAgaWYgKCF0aGlzLl91aUJpbmRpbmdzKSB7CiAgICAgICAgdGhpcy5fdWlCaW5kaW5ncyA9IHRoaXMudWk7CiAgICAgIH0KICAKICAgICAgLy8gZ2V0IHRoZSBiaW5kaW5ncyByZXN1bHQsIGFzIGEgZnVuY3Rpb24gb3Igb3RoZXJ3aXNlCiAgICAgIHZhciBiaW5kaW5ncyA9IF8ucmVzdWx0KHRoaXMsICdfdWlCaW5kaW5ncycpOwogIAogICAgICAvLyBlbXB0eSB0aGUgdWkgc28gd2UgZG9uJ3QgaGF2ZSBhbnl0aGluZyB0byBzdGFydCB3aXRoCiAgICAgIHRoaXMudWkgPSB7fTsKICAKICAgICAgLy8gYmluZCBlYWNoIG9mIHRoZSBzZWxlY3RvcnMKICAgICAgXy5lYWNoKF8ua2V5cyhiaW5kaW5ncyksIGZ1bmN0aW9uKGtleSkgewogICAgICAgIHZhciBzZWxlY3RvciA9IGJpbmRpbmdzW2tleV07CiAgICAgICAgdGhpcy51aVtrZXldID0gdGhpcy4kKHNlbGVjdG9yKTsKICAgICAgfSwgdGhpcyk7CiAgICB9LAogIAogICAgLy8gVGhpcyBtZXRob2QgdW5iaW5kcyB0aGUgZWxlbWVudHMgc3BlY2lmaWVkIGluIHRoZSAidWkiIGhhc2gKICAgIHVuYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl91bmJpbmRVSUVsZW1lbnRzKCk7CiAgICAgIF8uaW52b2tlKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fdW5iaW5kVUlFbGVtZW50cyk7CiAgICB9LAogIAogICAgX3VuYmluZFVJRWxlbWVudHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAoIXRoaXMudWkgfHwgIXRoaXMuX3VpQmluZGluZ3MpIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIGRlbGV0ZSBhbGwgb2YgdGhlIGV4aXN0aW5nIHVpIGJpbmRpbmdzCiAgICAgIF8uZWFjaCh0aGlzLnVpLCBmdW5jdGlvbigkZWwsIG5hbWUpIHsKICAgICAgICBkZWxldGUgdGhpcy51aVtuYW1lXTsKICAgICAgfSwgdGhpcyk7CiAgCiAgICAgIC8vIHJlc2V0IHRoZSB1aSBlbGVtZW50IHRvIHRoZSBvcmlnaW5hbCBiaW5kaW5ncyBjb25maWd1cmF0aW9uCiAgICAgIHRoaXMudWkgPSB0aGlzLl91aUJpbmRpbmdzOwogICAgICBkZWxldGUgdGhpcy5fdWlCaW5kaW5nczsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gY3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgZ2l2ZW4gYHRyaWdnZXJEZWZgIGxpa2UKICAgIC8vICdjbGljazpmb28nCiAgICBfYnVpbGRWaWV3VHJpZ2dlcjogZnVuY3Rpb24odHJpZ2dlckRlZikgewogICAgICB2YXIgaGFzT3B0aW9ucyA9IF8uaXNPYmplY3QodHJpZ2dlckRlZik7CiAgCiAgICAgIHZhciBvcHRpb25zID0gXy5kZWZhdWx0cyh7fSwgKGhhc09wdGlvbnMgPyB0cmlnZ2VyRGVmIDoge30pLCB7CiAgICAgICAgcHJldmVudERlZmF1bHQ6IHRydWUsCiAgICAgICAgc3RvcFByb3BhZ2F0aW9uOiB0cnVlCiAgICAgIH0pOwogIAogICAgICB2YXIgZXZlbnROYW1lID0gaGFzT3B0aW9ucyA/IG9wdGlvbnMuZXZlbnQgOiB0cmlnZ2VyRGVmOwogIAogICAgICByZXR1cm4gZnVuY3Rpb24oZSkgewogICAgICAgIGlmIChlKSB7CiAgICAgICAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCAmJiBvcHRpb25zLnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIH0KICAKICAgICAgICAgIGlmIChlLnN0b3BQcm9wYWdhdGlvbiAmJiBvcHRpb25zLnN0b3BQcm9wYWdhdGlvbikgewogICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgfQogICAgICAgIH0KICAKICAgICAgICB2YXIgYXJncyA9IHsKICAgICAgICAgIHZpZXc6IHRoaXMsCiAgICAgICAgICBtb2RlbDogdGhpcy5tb2RlbCwKICAgICAgICAgIGNvbGxlY3Rpb246IHRoaXMuY29sbGVjdGlvbgogICAgICAgIH07CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKGV2ZW50TmFtZSwgYXJncyk7CiAgICAgIH07CiAgICB9LAogIAogICAgc2V0RWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciByZXQgPSBCYWNrYm9uZS5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIC8vIHByb3h5IGJlaGF2aW9yICRlbCB0byB0aGUgdmlldydzICRlbC4KICAgICAgLy8gVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSBhIHZpZXcncyAkZWwgcHJveHkKICAgICAgLy8gaXMgbm90IHNldCB1bnRpbCBhZnRlciBzZXRFbGVtZW50IGlzIGNhbGxlZC4KICAgICAgXy5pbnZva2UodGhpcy5fYmVoYXZpb3JzLCAncHJveHlWaWV3UHJvcGVydGllcycsIHRoaXMpOwogIAogICAgICByZXR1cm4gcmV0OwogICAgfSwKICAKICAgIC8vIGltcG9ydCB0aGUgYHRyaWdnZXJNZXRob2RgIHRvIHRyaWdnZXIgZXZlbnRzIHdpdGggY29ycmVzcG9uZGluZwogICAgLy8gbWV0aG9kcyBpZiB0aGUgbWV0aG9kIGV4aXN0cwogICAgdHJpZ2dlck1ldGhvZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgdHJpZ2dlck1ldGhvZCA9IE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZDsKICAKICAgICAgdmFyIHJldCA9IHRyaWdnZXJNZXRob2QuYXBwbHkodGhpcywgYXJncyk7CiAgICAgIF8uZWFjaCh0aGlzLl9iZWhhdmlvcnMsIGZ1bmN0aW9uKGIpIHsKICAgICAgICB0cmlnZ2VyTWV0aG9kLmFwcGx5KGIsIGFyZ3MpOwogICAgICB9KTsKICAKICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgCiAgICAvLyBJbXBvcnRzIHRoZSAibm9ybWFsaXplTWV0aG9kcyIgdG8gdHJhbnNmb3JtIGhhc2hlcyBvZgogICAgLy8gZXZlbnRzPT5mdW5jdGlvbiByZWZlcmVuY2VzL25hbWVzIHRvIGEgaGFzaCBvZiBldmVudHM9PmZ1bmN0aW9uIHJlZmVyZW5jZXMKICAgIG5vcm1hbGl6ZU1ldGhvZHM6IE1hcmlvbmV0dGUubm9ybWFsaXplTWV0aG9kcywKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgLy8gUHJveHkgYHVuYmluZEVudGl0eUV2ZW50c2AgdG8gZW5hYmxlIGJpbmRpbmcgdmlldydzIGV2ZW50cyBmcm9tIGFub3RoZXIgZW50aXR5LgogICAgYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eUJpbmRFbnRpdHlFdmVudHMsCiAgCiAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgIHVuYmluZEVudGl0eUV2ZW50czogTWFyaW9uZXR0ZS5wcm94eVVuYmluZEVudGl0eUV2ZW50cwogIH0pOwogIAogIC8vIEl0ZW0gVmlldwogIC8vIC0tLS0tLS0tLQogIAogIC8vIEEgc2luZ2xlIGl0ZW0gdmlldyBpbXBsZW1lbnRhdGlvbiB0aGF0IGNvbnRhaW5zIGNvZGUgZm9yIHJlbmRlcmluZwogIC8vIHdpdGggdW5kZXJzY29yZS5qcyB0ZW1wbGF0ZXMsIHNlcmlhbGl6aW5nIHRoZSB2aWV3J3MgbW9kZWwgb3IgY29sbGVjdGlvbiwKICAvLyBhbmQgY2FsbGluZyBzZXZlcmFsIG1ldGhvZHMgb24gZXh0ZW5kZWQgdmlld3MsIHN1Y2ggYXMgYG9uUmVuZGVyYC4KICBNYXJpb25ldHRlLkl0ZW1WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgCiAgICAvLyBTZXR0aW5nIHVwIHRoZSBpbmhlcml0YW5jZSBjaGFpbiB3aGljaCBhbGxvd3MgY2hhbmdlcyB0bwogICAgLy8gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5jb25zdHJ1Y3RvciB3aGljaCBhbGxvd3Mgb3ZlcnJpZGluZwogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgICBNYXJpb25ldHRlLlZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBTZXJpYWxpemUgdGhlIG1vZGVsIG9yIGNvbGxlY3Rpb24gZm9yIHRoZSB2aWV3LiBJZiBhIG1vZGVsIGlzCiAgICAvLyBmb3VuZCwgdGhlIHZpZXcncyBgc2VyaWFsaXplTW9kZWxgIGlzIGNhbGxlZC4gSWYgYSBjb2xsZWN0aW9uIGlzIGZvdW5kLAogICAgLy8gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbiBpcyBzZXJpYWxpemVkIGJ5IGNhbGxpbmcKICAgIC8vIHRoZSB2aWV3J3MgYHNlcmlhbGl6ZUNvbGxlY3Rpb25gIGFuZCBwdXQgaW50byBhbiBgaXRlbXNgIGFycmF5IGluCiAgICAvLyB0aGUgcmVzdWx0aW5nIGRhdGEuIElmIGJvdGggYXJlIGZvdW5kLCBkZWZhdWx0cyB0byB0aGUgbW9kZWwuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcgZGVmaW5pdGlvbiwKICAgIC8vIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbigpewogICAgICB2YXIgZGF0YSA9IHt9OwogIAogICAgICBpZiAodGhpcy5tb2RlbCkgewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgICBlbHNlIGlmICh0aGlzLmNvbGxlY3Rpb24pIHsKICAgICAgICBkYXRhID0geyBpdGVtczogXy5wYXJ0aWFsKHRoaXMuc2VyaWFsaXplQ29sbGVjdGlvbiwgdGhpcy5jb2xsZWN0aW9uKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIH07CiAgICAgIH0KICAKICAgICAgcmV0dXJuIGRhdGE7CiAgICB9LAogIAogICAgLy8gU2VyaWFsaXplIGEgY29sbGVjdGlvbiBieSBzZXJpYWxpemluZyBlYWNoIG9mIGl0cyBtb2RlbHMuCiAgICBzZXJpYWxpemVDb2xsZWN0aW9uOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24udG9KU09OLmFwcGx5KGNvbGxlY3Rpb24sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIHRoZSB2aWV3LCBkZWZhdWx0aW5nIHRvIHVuZGVyc2NvcmUuanMgdGVtcGxhdGVzLgogICAgLy8gWW91IGNhbiBvdmVycmlkZSB0aGlzIGluIHlvdXIgdmlldyBkZWZpbml0aW9uIHRvIHByb3ZpZGUKICAgIC8vIGEgdmVyeSBzcGVjaWZpYyByZW5kZXJpbmcgZm9yIHlvdXIgdmlldy4gSW4gZ2VuZXJhbCwgdGhvdWdoLAogICAgLy8geW91IHNob3VsZCBvdmVycmlkZSB0aGUgYE1hcmlvbmV0dGUuUmVuZGVyZXJgIG9iamVjdCB0bwogICAgLy8gY2hhbmdlIGhvdyBNYXJpb25ldHRlIHJlbmRlcnMgdmlld3MuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgCiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuYmluZFVJRWxlbWVudHMoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXInLCB0aGlzKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbmRlciB0aGUgdGVtcGxhdGUgd2l0aCB0aGUgc2VyaWFsaXplZCBkYXRhCiAgICAvLyBhbmQgdGVtcGxhdGUgaGVscGVycyB2aWEgdGhlIGBNYXJpb25ldHRlLlJlbmRlcmVyYCBvYmplY3QuCiAgICAvLyBUaHJvd3MgYW4gYFVuZGVmaW5lZFRlbXBsYXRlRXJyb3JgIGVycm9yIGlmIHRoZSB0ZW1wbGF0ZSBpcwogICAgLy8gYW55IGZhbHNlbHkgdmFsdWUgYnV0IGxpdGVyYWwgYGZhbHNlYC4KICAgIF9yZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciB0ZW1wbGF0ZSA9IHRoaXMuZ2V0VGVtcGxhdGUoKTsKICAKICAgICAgLy8gQWxsb3cgdGVtcGxhdGUtbGVzcyBpdGVtIHZpZXdzCiAgICAgIGlmICh0ZW1wbGF0ZSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgaWYgKCF0ZW1wbGF0ZSkgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdVbmRlZmluZWRUZW1wbGF0ZUVycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdDYW5ub3QgcmVuZGVyIHRoZSB0ZW1wbGF0ZSBzaW5jZSBpdCBpcyBudWxsIG9yIHVuZGVmaW5lZC4nCiAgICAgICAgfSk7CiAgICAgIH0KICAKICAgICAgLy8gQWRkIGluIGVudGl0eSBkYXRhIGFuZCB0ZW1wbGF0ZSBoZWxwZXJzCiAgICAgIHZhciBkYXRhID0gdGhpcy5zZXJpYWxpemVEYXRhKCk7CiAgICAgIGRhdGEgPSB0aGlzLm1peGluVGVtcGxhdGVIZWxwZXJzKGRhdGEpOwogIAogICAgICAvLyBSZW5kZXIgYW5kIGFkZCB0byBlbAogICAgICB2YXIgaHRtbCA9IE1hcmlvbmV0dGUuUmVuZGVyZXIucmVuZGVyKHRlbXBsYXRlLCBkYXRhLCB0aGlzKTsKICAgICAgdGhpcy5hdHRhY2hFbENvbnRlbnQoaHRtbCk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIEF0dGFjaGVzIHRoZSBjb250ZW50IG9mIGEgZ2l2ZW4gdmlldy4KICAgIC8vIFRoaXMgbWV0aG9kIGNhbiBiZSBvdmVycmlkZGVuIHRvIG9wdGltaXplIHJlbmRlcmluZywKICAgIC8vIG9yIHRvIHJlbmRlciBpbiBhIG5vbiBzdGFuZGFyZCB3YXkuCiAgICAvLwogICAgLy8gRm9yIGV4YW1wbGUsIHVzaW5nIGBpbm5lckhUTUxgIGluc3RlYWQgb2YgYCRlbC5odG1sYAogICAgLy8KICAgIC8vIGBgYGpzCiAgICAvLyBhdHRhY2hFbENvbnRlbnQ6IGZ1bmN0aW9uKGh0bWwpIHsKICAgIC8vICAgdGhpcy5lbC5pbm5lckhUTUwgPSBodG1sOwogICAgLy8gICByZXR1cm4gdGhpczsKICAgIC8vIH0KICAgIC8vIGBgYAogICAgYXR0YWNoRWxDb250ZW50OiBmdW5jdGlvbihodG1sKSB7CiAgICAgIHRoaXMuJGVsLmh0bWwoaHRtbCk7CiAgCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIE92ZXJyaWRlIHRoZSBkZWZhdWx0IGRlc3Ryb3kgZXZlbnQgdG8gYWRkIGEgZmV3CiAgICAvLyBtb3JlIGV2ZW50cyB0aGF0IGFyZSB0cmlnZ2VyZWQuCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHJldHVybiBNYXJpb25ldHRlLlZpZXcucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0KICB9KTsKICAKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTQgKi8KICAvKiBqc2hpbnQgbWF4bGVuOiAyMDAgKi8KICAKICAvLyBDb2xsZWN0aW9uIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAKICAvLyBBIHZpZXcgdGhhdCBpdGVyYXRlcyBvdmVyIGEgQmFja2JvbmUuQ29sbGVjdGlvbgogIC8vIGFuZCByZW5kZXJzIGFuIGluZGl2aWR1YWwgY2hpbGQgdmlldyBmb3IgZWFjaCBtb2RlbC4KICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3ID0gTWFyaW9uZXR0ZS5WaWV3LmV4dGVuZCh7CiAgCiAgICAvLyB1c2VkIGFzIHRoZSBwcmVmaXggZm9yIGNoaWxkIHZpZXcgZXZlbnRzCiAgICAvLyB0aGF0IGFyZSBmb3J3YXJkZWQgdGhyb3VnaCB0aGUgY29sbGVjdGlvbnZpZXcKICAgIGNoaWxkVmlld0V2ZW50UHJlZml4OiAnY2hpbGR2aWV3JywKICAKICAgIC8vIGNvbnN0cnVjdG9yCiAgICAvLyBvcHRpb24gdG8gcGFzcyBge3NvcnQ6IGZhbHNlfWAgdG8gcHJldmVudCB0aGUgYENvbGxlY3Rpb25WaWV3YCBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24ob3B0aW9ucyl7CiAgICAgIHZhciBpbml0T3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICAgIHRoaXMuc29ydCA9IF8uaXNVbmRlZmluZWQoaW5pdE9wdGlvbnMuc29ydCkgPyB0cnVlIDogaW5pdE9wdGlvbnMuc29ydDsKICAKICAgICAgaWYgKGluaXRPcHRpb25zLmNvbGxlY3Rpb24gJiYgIShpbml0T3B0aW9ucy5jb2xsZWN0aW9uIGluc3RhbmNlb2YgQmFja2JvbmUuQ29sbGVjdGlvbikpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcignVGhlIENvbGxlY3Rpb24gb3B0aW9uIHBhc3NlZCB0byB0aGlzIHZpZXcgbmVlZHMgdG8gYmUgYW4gaW5zdGFuY2Ugb2YgYSBCYWNrYm9uZS5Db2xsZWN0aW9uJyk7CiAgICAgIH0KICAKICAgICAgdGhpcy5vbmNlKCdyZW5kZXInLCB0aGlzLl9pbml0aWFsRXZlbnRzKTsKICAKICAgICAgdGhpcy5faW5pdENoaWxkVmlld1N0b3JhZ2UoKTsKICAKICAgICAgTWFyaW9uZXR0ZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgCiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgfSwKICAKICAgIC8vIEluc3RlYWQgb2YgaW5zZXJ0aW5nIGVsZW1lbnRzIG9uZSBieSBvbmUgaW50byB0aGUgcGFnZSwKICAgIC8vIGl0J3MgbXVjaCBtb3JlIHBlcmZvcm1hbnQgdG8gaW5zZXJ0IGVsZW1lbnRzIGludG8gYSBkb2N1bWVudAogICAgLy8gZnJhZ21lbnQgYW5kIHRoZW4gaW5zZXJ0IHRoYXQgZG9jdW1lbnQgZnJhZ21lbnQgaW50byB0aGUgcGFnZQogICAgaW5pdFJlbmRlckJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuZWxCdWZmZXIgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CiAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgIH0sCiAgCiAgICBzdGFydEJ1ZmZlcmluZzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gdHJ1ZTsKICAgIH0sCiAgCiAgICBlbmRCdWZmZXJpbmc6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmlzQnVmZmVyaW5nID0gZmFsc2U7CiAgICAgIHRoaXMuX3RyaWdnZXJCZWZvcmVTaG93QnVmZmVyZWRDaGlsZHJlbigpOwogICAgICB0aGlzLmF0dGFjaEJ1ZmZlcih0aGlzLCB0aGlzLmVsQnVmZmVyKTsKICAgICAgdGhpcy5fdHJpZ2dlclNob3dCdWZmZXJlZENoaWxkcmVuKCk7CiAgICAgIHRoaXMuaW5pdFJlbmRlckJ1ZmZlcigpOwogICAgfSwKICAKICAgIF90cmlnZ2VyQmVmb3JlU2hvd0J1ZmZlcmVkQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdiZWZvcmU6c2hvdycpKTsKICAgICAgfQogICAgfSwKICAKICAgIF90cmlnZ2VyU2hvd0J1ZmZlcmVkQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5faXNTaG93bikgewogICAgICAgIF8uZWFjaCh0aGlzLl9idWZmZXJlZENoaWxkcmVuLCBfLnBhcnRpYWwodGhpcy5fdHJpZ2dlck1ldGhvZE9uQ2hpbGQsICdzaG93JykpOwogIAogICAgICAgIHRoaXMuX2J1ZmZlcmVkQ2hpbGRyZW4gPSBbXTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCBmb3IgXy5lYWNoIGxvb3BzIHRvIGNhbGwgYE1hcmlvbmV0dGUudHJpZ2dlck1ldGhvZE9uYCBvbgogICAgLy8gYSBjaGlsZCB2aWV3CiAgICBfdHJpZ2dlck1ldGhvZE9uQ2hpbGQ6IGZ1bmN0aW9uKGV2ZW50LCBjaGlsZFZpZXcpIHsKICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24oY2hpbGRWaWV3LCBldmVudCk7CiAgICB9LAogIAogICAgLy8gQ29uZmlndXJlZCB0aGUgaW5pdGlhbCBldmVudHMgdGhhdCB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAvLyBiaW5kcyB0by4KICAgIF9pbml0aWFsRXZlbnRzOiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuY29sbGVjdGlvbikgewogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnYWRkJywgdGhpcy5fb25Db2xsZWN0aW9uQWRkKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3JlbW92ZScsIHRoaXMuX29uQ29sbGVjdGlvblJlbW92ZSk7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdyZXNldCcsIHRoaXMucmVuZGVyKTsKICAKICAgICAgICBpZiAodGhpcy5zb3J0KSB7CiAgICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3NvcnQnLCB0aGlzLl9zb3J0Vmlld3MpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8vIEhhbmRsZSBhIGNoaWxkIGFkZGVkIHRvIHRoZSBjb2xsZWN0aW9uCiAgICBfb25Db2xsZWN0aW9uQWRkOiBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdmFyIENoaWxkVmlldyA9IHRoaXMuZ2V0Q2hpbGRWaWV3KGNoaWxkKTsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YoY2hpbGQpOwogICAgICB0aGlzLmFkZENoaWxkKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KTsKICAgIH0sCiAgCiAgICAvLyBnZXQgdGhlIGNoaWxkIHZpZXcgYnkgbW9kZWwgaXQgaG9sZHMsIGFuZCByZW1vdmUgaXQKICAgIF9vbkNvbGxlY3Rpb25SZW1vdmU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpcy5jaGlsZHJlbi5maW5kQnlNb2RlbChtb2RlbCk7CiAgICAgIHRoaXMucmVtb3ZlQ2hpbGRWaWV3KHZpZXcpOwogICAgICB0aGlzLmNoZWNrRW1wdHkoKTsKICAgIH0sCiAgCiAgICAvLyBPdmVycmlkZSBmcm9tIGBNYXJpb25ldHRlLlZpZXdgIHRvIHRyaWdnZXIgc2hvdyBvbiBjaGlsZCB2aWV3cwogICAgb25TaG93Q2FsbGVkOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jaGlsZHJlbi5lYWNoKF8ucGFydGlhbCh0aGlzLl90cmlnZ2VyTWV0aG9kT25DaGlsZCwgJ3Nob3cnKSk7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIGNoaWxkcmVuIHZpZXdzLiBPdmVycmlkZSB0aGlzIG1ldGhvZCB0bwogICAgLy8gcHJvdmlkZSB5b3VyIG93biBpbXBsZW1lbnRhdGlvbiBvZiBhIHJlbmRlciBmdW5jdGlvbiBmb3IKICAgIC8vIHRoZSBjb2xsZWN0aW9uIHZpZXcuCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLl9lbnN1cmVWaWV3SXNJbnRhY3QoKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIC8vIFJlbmRlciB2aWV3IGFmdGVyIHNvcnRpbmcuIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvCiAgICAvLyBjaGFuZ2UgaG93IHRoZSB2aWV3IHJlbmRlcnMgYWZ0ZXIgYSBgc29ydGAgb24gdGhlIGNvbGxlY3Rpb24uCiAgICAvLyBBbiBleGFtcGxlIG9mIHRoaXMgd291bGQgYmUgdG8gb25seSBgcmVuZGVyQ2hpbGRyZW5gIGluIGEgYENvbXBvc2l0ZVZpZXdgCiAgICAvLyByYXRoZXIgdGhhbiB0aGUgZnVsbCB2aWV3LgogICAgcmVzb3J0VmlldzogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVuZGVyKCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBUaGlzIGNoZWNrcyBmb3IgYW55IGNoYW5nZXMgaW4gdGhlIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gSWYgdGhlIGluZGV4IG9mIGFueSB2aWV3IGRvZXNuJ3QgbWF0Y2gsIGl0IHdpbGwgcmVuZGVyLgogICAgX3NvcnRWaWV3czogZnVuY3Rpb24oKSB7CiAgICAgIC8vIGNoZWNrIGZvciBhbnkgY2hhbmdlcyBpbiBzb3J0IG9yZGVyIG9mIHZpZXdzCiAgICAgIHZhciBvcmRlckNoYW5nZWQgPSB0aGlzLmNvbGxlY3Rpb24uZmluZChmdW5jdGlvbihpdGVtLCBpbmRleCl7CiAgICAgICAgdmFyIHZpZXcgPSB0aGlzLmNoaWxkcmVuLmZpbmRCeU1vZGVsKGl0ZW0pOwogICAgICAgIHJldHVybiAhdmlldyB8fCB2aWV3Ll9pbmRleCAhPT0gaW5kZXg7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICBpZiAob3JkZXJDaGFuZ2VkKSB7CiAgICAgICAgdGhpcy5yZXNvcnRWaWV3KCk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIFNlcGFyYXRlZCBzbyB0aGF0IENvbXBvc2l0ZVZpZXcgY2FuIGhhdmUKICAgIC8vIG1vcmUgY29udHJvbCBvdmVyIGV2ZW50cyBiZWluZyB0cmlnZ2VyZWQsIGFyb3VuZCB0aGUgcmVuZGVyaW5nCiAgICAvLyBwcm9jZXNzCiAgICBfcmVuZGVyQ2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmRlc3Ryb3lFbXB0eVZpZXcoKTsKICAgICAgdGhpcy5kZXN0cm95Q2hpbGRyZW4oKTsKICAKICAgICAgaWYgKHRoaXMuaXNFbXB0eSh0aGlzLmNvbGxlY3Rpb24pKSB7CiAgICAgICAgdGhpcy5zaG93RW1wdHlWaWV3KCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyOmNvbGxlY3Rpb24nLCB0aGlzKTsKICAgICAgICB0aGlzLnN0YXJ0QnVmZmVyaW5nKCk7CiAgICAgICAgdGhpcy5zaG93Q29sbGVjdGlvbigpOwogICAgICAgIHRoaXMuZW5kQnVmZmVyaW5nKCk7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW5kZXI6Y29sbGVjdGlvbicsIHRoaXMpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGxvb3AgdGhyb3VnaCBjb2xsZWN0aW9uIGFuZCBzaG93IGVhY2ggY2hpbGQgdmlldy4KICAgIHNob3dDb2xsZWN0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIENoaWxkVmlldzsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmVhY2goZnVuY3Rpb24oY2hpbGQsIGluZGV4KSB7CiAgICAgICAgQ2hpbGRWaWV3ID0gdGhpcy5nZXRDaGlsZFZpZXcoY2hpbGQpOwogICAgICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQsIENoaWxkVmlldywgaW5kZXgpOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2hvdyBhbiBlbXB0eSB2aWV3IGluIHBsYWNlIG9mCiAgICAvLyBhIGNvbGxlY3Rpb24gb2YgY2hpbGQgdmlld3MsIHdoZW4gdGhlIGNvbGxlY3Rpb24gaXMgZW1wdHkKICAgIHNob3dFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgRW1wdHlWaWV3ID0gdGhpcy5nZXRFbXB0eVZpZXcoKTsKICAKICAgICAgaWYgKEVtcHR5VmlldyAmJiAhdGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbmRlcjplbXB0eScpOwogIAogICAgICAgIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXcgPSB0cnVlOwogICAgICAgIHZhciBtb2RlbCA9IG5ldyBCYWNrYm9uZS5Nb2RlbCgpOwogICAgICAgIHRoaXMuYWRkRW1wdHlWaWV3KG1vZGVsLCBFbXB0eVZpZXcpOwogIAogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyOmVtcHR5Jyk7CiAgICAgIH0KICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gZGVzdHJveSBhbiBleGlzdGluZyBlbXB0eVZpZXcgaW5zdGFuY2UKICAgIC8vIGlmIG9uZSBleGlzdHMuIENhbGxlZCB3aGVuIGEgY29sbGVjdGlvbiB2aWV3IGhhcyBiZWVuCiAgICAvLyByZW5kZXJlZCBlbXB0eSwgYW5kIHRoZW4gYSBjaGlsZCBpcyBhZGRlZCB0byB0aGUgY29sbGVjdGlvbi4KICAgIGRlc3Ryb3lFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5fc2hvd2luZ0VtcHR5VmlldykgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlbW92ZTplbXB0eScpOwogIAogICAgICAgIHRoaXMuZGVzdHJveUNoaWxkcmVuKCk7CiAgICAgICAgZGVsZXRlIHRoaXMuX3Nob3dpbmdFbXB0eVZpZXc7CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6ZW1wdHknKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIFJldHJpZXZlIHRoZSBlbXB0eSB2aWV3IGNsYXNzCiAgICBnZXRFbXB0eVZpZXc6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRPcHRpb24oJ2VtcHR5VmlldycpOwogICAgfSwKICAKICAgIC8vIFJlbmRlciBhbmQgc2hvdyB0aGUgZW1wdHlWaWV3LiBTaW1pbGFyIHRvIGFkZENoaWxkIG1ldGhvZAogICAgLy8gYnV0ICJjaGlsZDphZGRlZCIgZXZlbnRzIGFyZSBub3QgZmlyZWQsIGFuZCB0aGUgZXZlbnQgZnJvbQogICAgLy8gZW1wdHlWaWV3IGFyZSBub3QgZm9yd2FyZGVkCiAgICBhZGRFbXB0eVZpZXc6IGZ1bmN0aW9uKGNoaWxkLCBFbXB0eVZpZXcpIHsKICAKICAgICAgLy8gZ2V0IHRoZSBlbXB0eVZpZXdPcHRpb25zLCBmYWxsaW5nIGJhY2sgdG8gY2hpbGRWaWV3T3B0aW9ucwogICAgICB2YXIgZW1wdHlWaWV3T3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uKCdlbXB0eVZpZXdPcHRpb25zJykgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdPcHRpb25zJyk7CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZW1wdHlWaWV3T3B0aW9ucykpewogICAgICAgIGVtcHR5Vmlld09wdGlvbnMgPSBlbXB0eVZpZXdPcHRpb25zLmNhbGwodGhpcyk7CiAgICAgIH0KICAKICAgICAgLy8gYnVpbGQgdGhlIGVtcHR5IHZpZXcKICAgICAgdmFyIHZpZXcgPSB0aGlzLmJ1aWxkQ2hpbGRWaWV3KGNoaWxkLCBFbXB0eVZpZXcsIGVtcHR5Vmlld09wdGlvbnMpOwogIAogICAgICAvLyBQcm94eSBlbXB0eVZpZXcgZXZlbnRzCiAgICAgIHRoaXMucHJveHlDaGlsZEV2ZW50cyh2aWV3KTsKICAKICAgICAgLy8gdHJpZ2dlciB0aGUgJ2JlZm9yZTpzaG93JyBldmVudCBvbiBgdmlld2AgaWYgdGhlIGNvbGxlY3Rpb24gdmlldwogICAgICAvLyBoYXMgYWxyZWFkeSBiZWVuIHNob3duCiAgICAgIGlmICh0aGlzLl9pc1Nob3duKSB7CiAgICAgICAgTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kT24odmlldywgJ2JlZm9yZTpzaG93Jyk7CiAgICAgIH0KICAKICAgICAgLy8gU3RvcmUgdGhlIGBlbXB0eVZpZXdgIGxpa2UgYSBgY2hpbGRWaWV3YCBzbyB3ZSBjYW4gcHJvcGVybHkKICAgICAgLy8gcmVtb3ZlIGFuZC9vciBjbG9zZSBpdCBsYXRlcgogICAgICB0aGlzLmNoaWxkcmVuLmFkZCh2aWV3KTsKICAKICAgICAgLy8gUmVuZGVyIGl0IGFuZCBzaG93IGl0CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIC0xKTsKICAKICAgICAgLy8gY2FsbCB0aGUgJ3Nob3cnIG1ldGhvZCBpZiB0aGUgY29sbGVjdGlvbiB2aWV3CiAgICAgIC8vIGhhcyBhbHJlYWR5IGJlZW4gc2hvd24KICAgICAgaWYgKHRoaXMuX2lzU2hvd24pIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gUmV0cmlldmUgdGhlIGBjaGlsZFZpZXdgIGNsYXNzLCBlaXRoZXIgZnJvbSBgdGhpcy5vcHRpb25zLmNoaWxkVmlld2AKICAgIC8vIG9yIGZyb20gdGhlIGBjaGlsZFZpZXdgIGluIHRoZSBvYmplY3QgZGVmaW5pdGlvbi4gVGhlICJvcHRpb25zIgogICAgLy8gdGFrZXMgcHJlY2VkZW5jZS4KICAgIC8vIFRoaXMgbWV0aG9kIHJlY2VpdmVzIHRoZSBtb2RlbCB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBpbnN0YW5jZQogICAgLy8gY3JlYXRlZCBmcm9tIHRoaXMgYGNoaWxkVmlld2AuIE92ZXJyaWRpbmcgbWV0aG9kcyBtYXkgdXNlIHRoZSBjaGlsZAogICAgLy8gdG8gZGV0ZXJtaW5lIHdoYXQgYGNoaWxkVmlld2AgY2xhc3MgdG8gcmV0dXJuLgogICAgZ2V0Q2hpbGRWaWV3OiBmdW5jdGlvbihjaGlsZCkgewogICAgICB2YXIgY2hpbGRWaWV3ID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlldycpOwogIAogICAgICBpZiAoIWNoaWxkVmlldykgewogICAgICAgIHRocm93IG5ldyBNYXJpb25ldHRlLkVycm9yKHsKICAgICAgICAgIG5hbWU6ICdOb0NoaWxkVmlld0Vycm9yJywKICAgICAgICAgIG1lc3NhZ2U6ICdBICJjaGlsZFZpZXciIG11c3QgYmUgc3BlY2lmaWVkJwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIHJldHVybiBjaGlsZFZpZXc7CiAgICB9LAogIAogICAgLy8gUmVuZGVyIHRoZSBjaGlsZCdzIHZpZXcgYW5kIGFkZCBpdCB0byB0aGUKICAgIC8vIEhUTUwgZm9yIHRoZSBjb2xsZWN0aW9uIHZpZXcgYXQgYSBnaXZlbiBpbmRleC4KICAgIC8vIFRoaXMgd2lsbCBhbHNvIHVwZGF0ZSB0aGUgaW5kaWNlcyBvZiBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbgogICAgLy8gaW4gb3JkZXIgdG8ga2VlcCB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgYWRkQ2hpbGQ6IGZ1bmN0aW9uKGNoaWxkLCBDaGlsZFZpZXcsIGluZGV4KSB7CiAgICAgIHZhciBjaGlsZFZpZXdPcHRpb25zID0gdGhpcy5nZXRPcHRpb24oJ2NoaWxkVmlld09wdGlvbnMnKTsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihjaGlsZFZpZXdPcHRpb25zKSkgewogICAgICAgIGNoaWxkVmlld09wdGlvbnMgPSBjaGlsZFZpZXdPcHRpb25zLmNhbGwodGhpcywgY2hpbGQsIGluZGV4KTsKICAgICAgfQogIAogICAgICB2YXIgdmlldyA9IHRoaXMuYnVpbGRDaGlsZFZpZXcoY2hpbGQsIENoaWxkVmlldywgY2hpbGRWaWV3T3B0aW9ucyk7CiAgCiAgICAgIC8vIGluY3JlbWVudCBpbmRpY2VzIG9mIHZpZXdzIGFmdGVyIHRoaXMgb25lCiAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgdHJ1ZSwgaW5kZXgpOwogIAogICAgICB0aGlzLl9hZGRDaGlsZFZpZXcodmlldywgaW5kZXgpOwogIAogICAgICByZXR1cm4gdmlldzsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QuIFRoaXMgZGVjcmVtZW50cyBvciBpbmNyZW1lbnRzIHRoZSBpbmRpY2VzIG9mIHZpZXdzIGFmdGVyIHRoZQogICAgLy8gYWRkZWQvcmVtb3ZlZCB2aWV3IHRvIGtlZXAgaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgX3VwZGF0ZUluZGljZXM6IGZ1bmN0aW9uKHZpZXcsIGluY3JlbWVudCwgaW5kZXgpIHsKICAgICAgaWYgKCF0aGlzLnNvcnQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAKICAgICAgaWYgKGluY3JlbWVudCkgewogICAgICAgIC8vIGFzc2lnbiB0aGUgaW5kZXggdG8gdGhlIHZpZXcKICAgICAgICB2aWV3Ll9pbmRleCA9IGluZGV4OwogIAogICAgICAgIC8vIGluY3JlbWVudCB0aGUgaW5kZXggb2Ygdmlld3MgYWZ0ZXIgdGhpcyBvbmUKICAgICAgICB0aGlzLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24gKGxhdGVyVmlldykgewogICAgICAgICAgaWYgKGxhdGVyVmlldy5faW5kZXggPj0gdmlldy5faW5kZXgpIHsKICAgICAgICAgICAgbGF0ZXJWaWV3Ll9pbmRleCsrOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIC8vIGRlY3JlbWVudCB0aGUgaW5kZXggb2Ygdmlld3MgYWZ0ZXIgdGhpcyBvbmUKICAgICAgICB0aGlzLmNoaWxkcmVuLmVhY2goZnVuY3Rpb24gKGxhdGVyVmlldykgewogICAgICAgICAgaWYgKGxhdGVyVmlldy5faW5kZXggPj0gdmlldy5faW5kZXgpIHsKICAgICAgICAgICAgbGF0ZXJWaWV3Ll9pbmRleC0tOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogIAogIAogICAgLy8gSW50ZXJuYWwgTWV0aG9kLiBBZGQgdGhlIHZpZXcgdG8gY2hpbGRyZW4gYW5kIHJlbmRlciBpdCBhdAogICAgLy8gdGhlIGdpdmVuIGluZGV4LgogICAgX2FkZENoaWxkVmlldzogZnVuY3Rpb24odmlldywgaW5kZXgpIHsKICAgICAgLy8gc2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcKICAgICAgdGhpcy5wcm94eUNoaWxkRXZlbnRzKHZpZXcpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6Y2hpbGQnLCB2aWV3KTsKICAKICAgICAgLy8gU3RvcmUgdGhlIGNoaWxkIHZpZXcgaXRzZWxmIHNvIHdlIGNhbiBwcm9wZXJseQogICAgICAvLyByZW1vdmUgYW5kL29yIGRlc3Ryb3kgaXQgbGF0ZXIKICAgICAgdGhpcy5jaGlsZHJlbi5hZGQodmlldyk7CiAgICAgIHRoaXMucmVuZGVyQ2hpbGRWaWV3KHZpZXcsIGluZGV4KTsKICAKICAgICAgaWYgKHRoaXMuX2lzU2hvd24gJiYgIXRoaXMuaXNCdWZmZXJpbmcpIHsKICAgICAgICBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2RPbih2aWV3LCAnc2hvdycpOwogICAgICB9CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYWRkOmNoaWxkJywgdmlldyk7CiAgICB9LAogIAogICAgLy8gcmVuZGVyIHRoZSBjaGlsZCB2aWV3CiAgICByZW5kZXJDaGlsZFZpZXc6IGZ1bmN0aW9uKHZpZXcsIGluZGV4KSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICAgIHRoaXMuYXR0YWNoSHRtbCh0aGlzLCB2aWV3LCBpbmRleCk7CiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAKICAgIC8vIEJ1aWxkIGEgYGNoaWxkVmlld2AgZm9yIGEgbW9kZWwgaW4gdGhlIGNvbGxlY3Rpb24uCiAgICBidWlsZENoaWxkVmlldzogZnVuY3Rpb24oY2hpbGQsIENoaWxkVmlld0NsYXNzLCBjaGlsZFZpZXdPcHRpb25zKSB7CiAgICAgIHZhciBvcHRpb25zID0gXy5leHRlbmQoe21vZGVsOiBjaGlsZH0sIGNoaWxkVmlld09wdGlvbnMpOwogICAgICByZXR1cm4gbmV3IENoaWxkVmlld0NsYXNzKG9wdGlvbnMpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZSB0aGUgY2hpbGQgdmlldyBhbmQgZGVzdHJveSBpdC4KICAgIC8vIFRoaXMgZnVuY3Rpb24gYWxzbyB1cGRhdGVzIHRoZSBpbmRpY2VzIG9mCiAgICAvLyBsYXRlciB2aWV3cyBpbiB0aGUgY29sbGVjdGlvbiBpbiBvcmRlciB0byBrZWVwCiAgICAvLyB0aGUgY2hpbGRyZW4gaW4gc3luYyB3aXRoIHRoZSBjb2xsZWN0aW9uLgogICAgcmVtb3ZlQ2hpbGRWaWV3OiBmdW5jdGlvbih2aWV3KSB7CiAgCiAgICAgIGlmICh2aWV3KSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgICAgICAgLy8gY2FsbCAnZGVzdHJveScgb3IgJ3JlbW92ZScsIGRlcGVuZGluZyBvbiB3aGljaCBpcyBmb3VuZAogICAgICAgIGlmICh2aWV3LmRlc3Ryb3kpIHsgdmlldy5kZXN0cm95KCk7IH0KICAgICAgICBlbHNlIGlmICh2aWV3LnJlbW92ZSkgeyB2aWV3LnJlbW92ZSgpOyB9CiAgCiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKHZpZXcpOwogICAgICAgIHRoaXMuY2hpbGRyZW4ucmVtb3ZlKHZpZXcpOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOmNoaWxkJywgdmlldyk7CiAgCiAgICAgICAgLy8gZGVjcmVtZW50IHRoZSBpbmRleCBvZiB2aWV3cyBhZnRlciB0aGlzIG9uZQogICAgICAgIHRoaXMuX3VwZGF0ZUluZGljZXModmlldywgZmFsc2UpOwogICAgICB9CiAgCiAgICAgIHJldHVybiB2aWV3OwogICAgfSwKICAKICAgIC8vIGNoZWNrIGlmIHRoZSBjb2xsZWN0aW9uIGlzIGVtcHR5CiAgICBpc0VtcHR5OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuICF0aGlzLmNvbGxlY3Rpb24gfHwgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMDsKICAgIH0sCiAgCiAgICAvLyBJZiBlbXB0eSwgc2hvdyB0aGUgZW1wdHkgdmlldwogICAgY2hlY2tFbXB0eTogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzRW1wdHkodGhpcy5jb2xsZWN0aW9uKSkgewogICAgICAgIHRoaXMuc2hvd0VtcHR5VmlldygpOwogICAgICB9CiAgICB9LAogIAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uKGNvbGxlY3Rpb25WaWV3LCBidWZmZXIpIHsKICAgICAgY29sbGVjdGlvblZpZXcuJGVsLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAKICAgIC8vIEFwcGVuZCB0aGUgSFRNTCB0byB0aGUgY29sbGVjdGlvbidzIGBlbGAuCiAgICAvLyBPdmVycmlkZSB0aGlzIG1ldGhvZCB0byBkbyBzb21ldGhpbmcgb3RoZXIKICAgIC8vIHRoYW4gYC5hcHBlbmRgLgogICAgYXR0YWNoSHRtbDogZnVuY3Rpb24oY29sbGVjdGlvblZpZXcsIGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgaWYgKGNvbGxlY3Rpb25WaWV3LmlzQnVmZmVyaW5nKSB7CiAgICAgICAgLy8gYnVmZmVyaW5nIGhhcHBlbnMgb24gcmVzZXQgZXZlbnRzIGFuZCBpbml0aWFsIHJlbmRlcnMKICAgICAgICAvLyBpbiBvcmRlciB0byByZWR1Y2UgdGhlIG51bWJlciBvZiBpbnNlcnRzIGludG8gdGhlCiAgICAgICAgLy8gZG9jdW1lbnQsIHdoaWNoIGFyZSBleHBlbnNpdmUuCiAgICAgICAgY29sbGVjdGlvblZpZXcuZWxCdWZmZXIuYXBwZW5kQ2hpbGQoY2hpbGRWaWV3LmVsKTsKICAgICAgICBjb2xsZWN0aW9uVmlldy5fYnVmZmVyZWRDaGlsZHJlbi5wdXNoKGNoaWxkVmlldyk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgLy8gSWYgd2UndmUgYWxyZWFkeSByZW5kZXJlZCB0aGUgbWFpbiBjb2xsZWN0aW9uLCBhcHBlbmQKICAgICAgICAvLyB0aGUgbmV3IGNoaWxkIGludG8gdGhlIGNvcnJlY3Qgb3JkZXIgaWYgd2UgbmVlZCB0by4gT3RoZXJ3aXNlCiAgICAgICAgLy8gYXBwZW5kIHRvIHRoZSBlbmQuCiAgICAgICAgaWYgKCFjb2xsZWN0aW9uVmlldy5faW5zZXJ0QmVmb3JlKGNoaWxkVmlldywgaW5kZXgpKXsKICAgICAgICAgIGNvbGxlY3Rpb25WaWV3Ll9pbnNlcnRBZnRlcihjaGlsZFZpZXcpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQ2hlY2sgd2hldGhlciB3ZSBuZWVkIHRvIGluc2VydCB0aGUgdmlldyBpbnRvCiAgICAvLyB0aGUgY29ycmVjdCBwb3NpdGlvbi4KICAgIF9pbnNlcnRCZWZvcmU6IGZ1bmN0aW9uKGNoaWxkVmlldywgaW5kZXgpIHsKICAgICAgdmFyIGN1cnJlbnRWaWV3OwogICAgICB2YXIgZmluZFBvc2l0aW9uID0gdGhpcy5zb3J0ICYmIChpbmRleCA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMSk7CiAgICAgIGlmIChmaW5kUG9zaXRpb24pIHsKICAgICAgICAvLyBGaW5kIHRoZSB2aWV3IGFmdGVyIHRoaXMgb25lCiAgICAgICAgY3VycmVudFZpZXcgPSB0aGlzLmNoaWxkcmVuLmZpbmQoZnVuY3Rpb24gKHZpZXcpIHsKICAgICAgICAgIHJldHVybiB2aWV3Ll9pbmRleCA9PT0gaW5kZXggKyAxOwogICAgICAgIH0pOwogICAgICB9CiAgCiAgICAgIGlmIChjdXJyZW50VmlldykgewogICAgICAgIGN1cnJlbnRWaWV3LiRlbC5iZWZvcmUoY2hpbGRWaWV3LmVsKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogIAogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kLiBBcHBlbmQgYSB2aWV3IHRvIHRoZSBlbmQgb2YgdGhlICRlbAogICAgX2luc2VydEFmdGVyOiBmdW5jdGlvbihjaGlsZFZpZXcpIHsKICAgICAgdGhpcy4kZWwuYXBwZW5kKGNoaWxkVmlldy5lbCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHNldCB1cCB0aGUgYGNoaWxkcmVuYCBvYmplY3QgZm9yCiAgICAvLyBzdG9yaW5nIGFsbCBvZiB0aGUgY2hpbGQgdmlld3MKICAgIF9pbml0Q2hpbGRWaWV3U3RvcmFnZTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY2hpbGRyZW4gPSBuZXcgQmFja2JvbmUuQ2hpbGRWaWV3Q29udGFpbmVyKCk7CiAgICB9LAogIAogICAgLy8gSGFuZGxlIGNsZWFudXAgYW5kIG90aGVyIGRlc3Ryb3lpbmcgbmVlZHMgZm9yIHRoZSBjb2xsZWN0aW9uIG9mIHZpZXdzCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmRlc3Ryb3k6Y29sbGVjdGlvbicpOwogICAgICB0aGlzLmRlc3Ryb3lDaGlsZHJlbigpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2Rlc3Ryb3k6Y29sbGVjdGlvbicpOwogIAogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5WaWV3LnByb3RvdHlwZS5kZXN0cm95LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gRGVzdHJveSB0aGUgY2hpbGQgdmlld3MgdGhhdCB0aGlzIGNvbGxlY3Rpb24gdmlldwogICAgLy8gaXMgaG9sZGluZyBvbiB0bywgaWYgYW55CiAgICBkZXN0cm95Q2hpbGRyZW46IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY2hpbGRWaWV3cyA9IHRoaXMuY2hpbGRyZW4ubWFwKF8uaWRlbnRpdHkpOwogICAgICB0aGlzLmNoaWxkcmVuLmVhY2godGhpcy5yZW1vdmVDaGlsZFZpZXcsIHRoaXMpOwogICAgICB0aGlzLmNoZWNrRW1wdHkoKTsKICAgICAgcmV0dXJuIGNoaWxkVmlld3M7CiAgICB9LAogIAogICAgLy8gU2V0IHVwIHRoZSBjaGlsZCB2aWV3IGV2ZW50IGZvcndhcmRpbmcuIFVzZXMgYSAiY2hpbGR2aWV3OiIKICAgIC8vIHByZWZpeCBpbiBmcm9udCBvZiBhbGwgZm9yd2FyZGVkIGV2ZW50cy4KICAgIHByb3h5Q2hpbGRFdmVudHM6IGZ1bmN0aW9uKHZpZXcpIHsKICAgICAgdmFyIHByZWZpeCA9IHRoaXMuZ2V0T3B0aW9uKCdjaGlsZFZpZXdFdmVudFByZWZpeCcpOwogIAogICAgICAvLyBGb3J3YXJkIGFsbCBjaGlsZCB2aWV3IGV2ZW50cyB0aHJvdWdoIHRoZSBwYXJlbnQsCiAgICAgIC8vIHByZXBlbmRpbmcgImNoaWxkdmlldzoiIHRvIHRoZSBldmVudCBuYW1lCiAgICAgIHRoaXMubGlzdGVuVG8odmlldywgJ2FsbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICAgIHZhciByb290RXZlbnQgPSBhcmdzWzBdOwogICAgICAgIHZhciBjaGlsZEV2ZW50cyA9IHRoaXMubm9ybWFsaXplTWV0aG9kcyhfLnJlc3VsdCh0aGlzLCAnY2hpbGRFdmVudHMnKSk7CiAgCiAgICAgICAgYXJnc1swXSA9IHByZWZpeCArICc6JyArIHJvb3RFdmVudDsKICAgICAgICBhcmdzLnNwbGljZSgxLCAwLCB2aWV3KTsKICAKICAgICAgICAvLyBjYWxsIGNvbGxlY3Rpb25WaWV3IGNoaWxkRXZlbnQgaWYgZGVmaW5lZAogICAgICAgIGlmICh0eXBlb2YgY2hpbGRFdmVudHMgIT09ICd1bmRlZmluZWQnICYmIF8uaXNGdW5jdGlvbihjaGlsZEV2ZW50c1tyb290RXZlbnRdKSkgewogICAgICAgICAgY2hpbGRFdmVudHNbcm9vdEV2ZW50XS5hcHBseSh0aGlzLCBhcmdzLnNsaWNlKDEpKTsKICAgICAgICB9CiAgCiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9LCB0aGlzKTsKICAgIH0KICB9KTsKICAKICAvKiBqc2hpbnQgbWF4c3RhdGVtZW50czogMTcsIG1heGxlbjogMTE3ICovCiAgCiAgLy8gQ29tcG9zaXRlIFZpZXcKICAvLyAtLS0tLS0tLS0tLS0tLQogIAogIC8vIFVzZWQgZm9yIHJlbmRlcmluZyBhIGJyYW5jaC1sZWFmLCBoaWVyYXJjaGljYWwgc3RydWN0dXJlLgogIC8vIEV4dGVuZHMgZGlyZWN0bHkgZnJvbSBDb2xsZWN0aW9uVmlldyBhbmQgYWxzbyByZW5kZXJzIGFuCiAgLy8gYSBjaGlsZCB2aWV3IGFzIGBtb2RlbFZpZXdgLCBmb3IgdGhlIHRvcCBsZWFmCiAgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3ID0gTWFyaW9uZXR0ZS5Db2xsZWN0aW9uVmlldy5leHRlbmQoewogIAogICAgLy8gU2V0dGluZyB1cCB0aGUgaW5oZXJpdGFuY2UgY2hhaW4gd2hpY2ggYWxsb3dzIGNoYW5nZXMgdG8KICAgIC8vIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcucHJvdG90eXBlLmNvbnN0cnVjdG9yIHdoaWNoIGFsbG93cyBvdmVycmlkaW5nCiAgICAvLyBvcHRpb24gdG8gcGFzcyAne3NvcnQ6IGZhbHNlfScgdG8gcHJldmVudCB0aGUgQ29tcG9zaXRlVmlldyBmcm9tCiAgICAvLyBtYWludGFpbmluZyB0aGUgc29ydGVkIG9yZGVyIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgLy8gVGhpcyB3aWxsIGZhbGxiYWNrIG9udG8gYXBwZW5kaW5nIGNoaWxkVmlldydzIHRvIHRoZSBlbmQuCiAgICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICAgIE1hcmlvbmV0dGUuQ29sbGVjdGlvblZpZXcuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBDb25maWd1cmVkIHRoZSBpbml0aWFsIGV2ZW50cyB0aGF0IHRoZSBjb21wb3NpdGUgdmlldwogICAgLy8gYmluZHMgdG8uIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIHByZXZlbnQgdGhlIGluaXRpYWwKICAgIC8vIGV2ZW50cywgb3IgdG8gYWRkIHlvdXIgb3duIGluaXRpYWwgZXZlbnRzLgogICAgX2luaXRpYWxFdmVudHM6IGZ1bmN0aW9uKCkgewogIAogICAgICAvLyBCaW5kIG9ubHkgYWZ0ZXIgY29tcG9zaXRlIHZpZXcgaXMgcmVuZGVyZWQgdG8gYXZvaWQgYWRkaW5nIGNoaWxkIHZpZXdzCiAgICAgIC8vIHRvIG5vbmV4aXN0ZW50IGNoaWxkVmlld0NvbnRhaW5lcgogIAogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNvbGxlY3Rpb24sICdhZGQnLCB0aGlzLl9vbkNvbGxlY3Rpb25BZGQpOwogICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAncmVtb3ZlJywgdGhpcy5fb25Db2xsZWN0aW9uUmVtb3ZlKTsKICAgICAgICB0aGlzLmxpc3RlblRvKHRoaXMuY29sbGVjdGlvbiwgJ3Jlc2V0JywgdGhpcy5fcmVuZGVyQ2hpbGRyZW4pOwogIAogICAgICAgIGlmICh0aGlzLnNvcnQpIHsKICAgICAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnc29ydCcsIHRoaXMuX3NvcnRWaWV3cyk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogIAogICAgLy8gUmV0cmlldmUgdGhlIGBjaGlsZFZpZXdgIHRvIGJlIHVzZWQgd2hlbiByZW5kZXJpbmcgZWFjaCBvZgogICAgLy8gdGhlIGl0ZW1zIGluIHRoZSBjb2xsZWN0aW9uLiBUaGUgZGVmYXVsdCBpcyB0byByZXR1cm4KICAgIC8vIGB0aGlzLmNoaWxkVmlld2Agb3IgTWFyaW9uZXR0ZS5Db21wb3NpdGVWaWV3IGlmIG5vIGBjaGlsZFZpZXdgCiAgICAvLyBoYXMgYmVlbiBkZWZpbmVkCiAgICBnZXRDaGlsZFZpZXc6IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgIHZhciBjaGlsZFZpZXcgPSB0aGlzLmdldE9wdGlvbignY2hpbGRWaWV3JykgfHwgdGhpcy5jb25zdHJ1Y3RvcjsKICAKICAgICAgaWYgKCFjaGlsZFZpZXcpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBuYW1lOiAnTm9DaGlsZFZpZXdFcnJvcicsCiAgICAgICAgICBtZXNzYWdlOiAnQSAiY2hpbGRWaWV3IiBtdXN0IGJlIHNwZWNpZmllZCcKICAgICAgICB9KTsKICAgICAgfQogIAogICAgICByZXR1cm4gY2hpbGRWaWV3OwogICAgfSwKICAKICAgIC8vIFNlcmlhbGl6ZSB0aGUgY29sbGVjdGlvbiBmb3IgdGhlIHZpZXcuCiAgICAvLyBZb3UgY2FuIG92ZXJyaWRlIHRoZSBgc2VyaWFsaXplRGF0YWAgbWV0aG9kIGluIHlvdXIgb3duIHZpZXcKICAgIC8vIGRlZmluaXRpb24sIHRvIHByb3ZpZGUgY3VzdG9tIHNlcmlhbGl6YXRpb24gZm9yIHlvdXIgdmlldydzIGRhdGEuCiAgICBzZXJpYWxpemVEYXRhOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGRhdGEgPSB7fTsKICAKICAgICAgaWYgKHRoaXMubW9kZWwpewogICAgICAgIGRhdGEgPSBfLnBhcnRpYWwodGhpcy5zZXJpYWxpemVNb2RlbCwgdGhpcy5tb2RlbCkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogIAogICAgICByZXR1cm4gZGF0YTsKICAgIH0sCiAgCiAgICAvLyBSZW5kZXJzIHRoZSBtb2RlbCBvbmNlLCBhbmQgdGhlIGNvbGxlY3Rpb24gb25jZS4gQ2FsbGluZwogICAgLy8gdGhpcyBhZ2FpbiB3aWxsIHRlbGwgdGhlIG1vZGVsJ3MgdmlldyB0byByZS1yZW5kZXIgaXRzZWxmCiAgICAvLyBidXQgdGhlIGNvbGxlY3Rpb24gd2lsbCBub3QgcmUtcmVuZGVyLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7CiAgICAgIHRoaXMucmVzZXRDaGlsZFZpZXdDb250YWluZXIoKTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVuZGVyJywgdGhpcyk7CiAgCiAgICAgIHRoaXMuX3JlbmRlclRlbXBsYXRlKCk7CiAgICAgIHRoaXMuX3JlbmRlckNoaWxkcmVuKCk7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVuZGVyJywgdGhpcyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAKICAgIF9yZW5kZXJDaGlsZHJlbjogZnVuY3Rpb24oKSB7CiAgICAgIGlmICh0aGlzLmlzUmVuZGVyZWQpIHsKICAgICAgICBNYXJpb25ldHRlLkNvbGxlY3Rpb25WaWV3LnByb3RvdHlwZS5fcmVuZGVyQ2hpbGRyZW4uY2FsbCh0aGlzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIFJlbmRlciB0aGUgcm9vdCB0ZW1wbGF0ZSB0aGF0IHRoZSBjaGlsZHJlbgogICAgLy8gdmlld3MgYXJlIGFwcGVuZGVkIHRvCiAgICBfcmVuZGVyVGVtcGxhdGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZGF0YSA9IHt9OwogICAgICBkYXRhID0gdGhpcy5zZXJpYWxpemVEYXRhKCk7CiAgICAgIGRhdGEgPSB0aGlzLm1peGluVGVtcGxhdGVIZWxwZXJzKGRhdGEpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpyZW5kZXI6dGVtcGxhdGUnKTsKICAKICAgICAgdmFyIHRlbXBsYXRlID0gdGhpcy5nZXRUZW1wbGF0ZSgpOwogICAgICB2YXIgaHRtbCA9IE1hcmlvbmV0dGUuUmVuZGVyZXIucmVuZGVyKHRlbXBsYXRlLCBkYXRhLCB0aGlzKTsKICAgICAgdGhpcy5hdHRhY2hFbENvbnRlbnQoaHRtbCk7CiAgCiAgICAgIC8vIHRoZSB1aSBiaW5kaW5ncyBpcyBkb25lIGhlcmUgYW5kIG5vdCBhdCB0aGUgZW5kIG9mIHJlbmRlciBzaW5jZSB0aGV5CiAgICAgIC8vIHdpbGwgbm90IGJlIGF2YWlsYWJsZSB1bnRpbCBhZnRlciB0aGUgbW9kZWwgaXMgcmVuZGVyZWQsIGJ1dCBzaG91bGQgYmUKICAgICAgLy8gYXZhaWxhYmxlIGJlZm9yZSB0aGUgY29sbGVjdGlvbiBpcyByZW5kZXJlZC4KICAgICAgdGhpcy5iaW5kVUlFbGVtZW50cygpOwogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3JlbmRlcjp0ZW1wbGF0ZScpOwogICAgfSwKICAKICAgIC8vIEF0dGFjaGVzIHRoZSBjb250ZW50IG9mIHRoZSByb290LgogICAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRkZW4gdG8gb3B0aW1pemUgcmVuZGVyaW5nLAogICAgLy8gb3IgdG8gcmVuZGVyIGluIGEgbm9uIHN0YW5kYXJkIHdheS4KICAgIC8vCiAgICAvLyBGb3IgZXhhbXBsZSwgdXNpbmcgYGlubmVySFRNTGAgaW5zdGVhZCBvZiBgJGVsLmh0bWxgCiAgICAvLwogICAgLy8gYGBganMKICAgIC8vIGF0dGFjaEVsQ29udGVudDogZnVuY3Rpb24oaHRtbCkgewogICAgLy8gICB0aGlzLmVsLmlubmVySFRNTCA9IGh0bWw7CiAgICAvLyAgIHJldHVybiB0aGlzOwogICAgLy8gfQogICAgLy8gYGBgCiAgICBhdHRhY2hFbENvbnRlbnQ6IGZ1bmN0aW9uKGh0bWwpIHsKICAgICAgdGhpcy4kZWwuaHRtbChodG1sKTsKICAKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogIAogICAgLy8gWW91IG1pZ2h0IG5lZWQgdG8gb3ZlcnJpZGUgdGhpcyBpZiB5b3UndmUgb3ZlcnJpZGRlbiBhdHRhY2hIdG1sCiAgICBhdHRhY2hCdWZmZXI6IGZ1bmN0aW9uKGNvbXBvc2l0ZVZpZXcsIGJ1ZmZlcikgewogICAgICB2YXIgJGNvbnRhaW5lciA9IHRoaXMuZ2V0Q2hpbGRWaWV3Q29udGFpbmVyKGNvbXBvc2l0ZVZpZXcpOwogICAgICAkY29udGFpbmVyLmFwcGVuZChidWZmZXIpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZC4gQXBwZW5kIGEgdmlldyB0byB0aGUgZW5kIG9mIHRoZSAkZWwuCiAgICAvLyBPdmVyaWRkZW4gZnJvbSBDb2xsZWN0aW9uVmlldyB0byBlbnN1cmUgdmlldyBpcyBhcHBlbmRlZCB0bwogICAgLy8gY2hpbGRWaWV3Q29udGFpbmVyCiAgICBfaW5zZXJ0QWZ0ZXI6IGZ1bmN0aW9uIChjaGlsZFZpZXcpIHsKICAgICAgdmFyICRjb250YWluZXIgPSB0aGlzLmdldENoaWxkVmlld0NvbnRhaW5lcih0aGlzKTsKICAgICAgJGNvbnRhaW5lci5hcHBlbmQoY2hpbGRWaWV3LmVsKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gZW5zdXJlIGFuIGAkY2hpbGRWaWV3Q29udGFpbmVyYCBleGlzdHMsIGZvciB0aGUKICAgIC8vIGBhdHRhY2hIdG1sYCBtZXRob2QgdG8gdXNlLgogICAgZ2V0Q2hpbGRWaWV3Q29udGFpbmVyOiBmdW5jdGlvbihjb250YWluZXJWaWV3KSB7CiAgICAgIGlmICgnJGNoaWxkVmlld0NvbnRhaW5lcicgaW4gY29udGFpbmVyVmlldykgewogICAgICAgIHJldHVybiBjb250YWluZXJWaWV3LiRjaGlsZFZpZXdDb250YWluZXI7CiAgICAgIH0KICAKICAgICAgdmFyIGNvbnRhaW5lcjsKICAgICAgdmFyIGNoaWxkVmlld0NvbnRhaW5lciA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKGNvbnRhaW5lclZpZXcsICdjaGlsZFZpZXdDb250YWluZXInKTsKICAgICAgaWYgKGNoaWxkVmlld0NvbnRhaW5lcikgewogIAogICAgICAgIHZhciBzZWxlY3RvciA9IF8uaXNGdW5jdGlvbihjaGlsZFZpZXdDb250YWluZXIpID8gY2hpbGRWaWV3Q29udGFpbmVyLmNhbGwoY29udGFpbmVyVmlldykgOiBjaGlsZFZpZXdDb250YWluZXI7CiAgCiAgICAgICAgaWYgKHNlbGVjdG9yLmNoYXJBdCgwKSA9PT0gJ0AnICYmIGNvbnRhaW5lclZpZXcudWkpIHsKICAgICAgICAgIGNvbnRhaW5lciA9IGNvbnRhaW5lclZpZXcudWlbc2VsZWN0b3Iuc3Vic3RyKDQpXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy4kKHNlbGVjdG9yKTsKICAgICAgICB9CiAgCiAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPD0gMCkgewogICAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoewogICAgICAgICAgICBuYW1lOiAnQ2hpbGRWaWV3Q29udGFpbmVyTWlzc2luZ0Vycm9yJywKICAgICAgICAgICAgbWVzc2FnZTogJ1RoZSBzcGVjaWZpZWQgImNoaWxkVmlld0NvbnRhaW5lciIgd2FzIG5vdCBmb3VuZDogJyArIGNvbnRhaW5lclZpZXcuY2hpbGRWaWV3Q29udGFpbmVyCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgCiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29udGFpbmVyID0gY29udGFpbmVyVmlldy4kZWw7CiAgICAgIH0KICAKICAgICAgY29udGFpbmVyVmlldy4kY2hpbGRWaWV3Q29udGFpbmVyID0gY29udGFpbmVyOwogICAgICByZXR1cm4gY29udGFpbmVyOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byByZXNldCB0aGUgYCRjaGlsZFZpZXdDb250YWluZXJgIG9uIHJlbmRlcgogICAgcmVzZXRDaGlsZFZpZXdDb250YWluZXI6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy4kY2hpbGRWaWV3Q29udGFpbmVyKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuJGNoaWxkVmlld0NvbnRhaW5lcjsKICAgICAgfQogICAgfQogIH0pOwogIAogIC8vIExheW91dFZpZXcKICAvLyAtLS0tLS0tLS0tCiAgCiAgLy8gVXNlZCBmb3IgbWFuYWdpbmcgYXBwbGljYXRpb24gbGF5b3V0Vmlld3MsIG5lc3RlZCBsYXlvdXRWaWV3cyBhbmQKICAvLyBtdWx0aXBsZSByZWdpb25zIHdpdGhpbiBhbiBhcHBsaWNhdGlvbiBvciBzdWItYXBwbGljYXRpb24uCiAgLy8KICAvLyBBIHNwZWNpYWxpemVkIHZpZXcgY2xhc3MgdGhhdCByZW5kZXJzIGFuIGFyZWEgb2YgSFRNTCBhbmQgdGhlbgogIC8vIGF0dGFjaGVzIGBSZWdpb25gIGluc3RhbmNlcyB0byB0aGUgc3BlY2lmaWVkIGByZWdpb25zYC4KICAvLyBVc2VkIGZvciBjb21wb3NpdGUgdmlldyBtYW5hZ2VtZW50IGFuZCBzdWItYXBwbGljYXRpb24gYXJlYXMuCiAgTWFyaW9uZXR0ZS5MYXlvdXRWaWV3ID0gTWFyaW9uZXR0ZS5JdGVtVmlldy5leHRlbmQoewogICAgcmVnaW9uQ2xhc3M6IE1hcmlvbmV0dGUuUmVnaW9uLAogIAogICAgLy8gRW5zdXJlIHRoZSByZWdpb25zIGFyZSBhdmFpbGFibGUgd2hlbiB0aGUgYGluaXRpYWxpemVgIG1ldGhvZAogICAgLy8gaXMgY2FsbGVkLgogICAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgCiAgICAgIHRoaXMuX2ZpcnN0UmVuZGVyID0gdHJ1ZTsKICAgICAgdGhpcy5faW5pdGlhbGl6ZVJlZ2lvbnMob3B0aW9ucyk7CiAgCiAgICAgIE1hcmlvbmV0dGUuSXRlbVZpZXcuY2FsbCh0aGlzLCBvcHRpb25zKTsKICAgIH0sCiAgCiAgICAvLyBMYXlvdXRWaWV3J3MgcmVuZGVyIHdpbGwgdXNlIHRoZSBleGlzdGluZyByZWdpb24gb2JqZWN0cyB0aGUKICAgIC8vIGZpcnN0IHRpbWUgaXQgaXMgY2FsbGVkLiBTdWJzZXF1ZW50IGNhbGxzIHdpbGwgZGVzdHJveSB0aGUKICAgIC8vIHZpZXdzIHRoYXQgdGhlIHJlZ2lvbnMgYXJlIHNob3dpbmcgYW5kIHRoZW4gcmVzZXQgdGhlIGBlbGAKICAgIC8vIGZvciB0aGUgcmVnaW9ucyB0byB0aGUgbmV3bHkgcmVuZGVyZWQgRE9NIGVsZW1lbnRzLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fZW5zdXJlVmlld0lzSW50YWN0KCk7CiAgCiAgICAgIGlmICh0aGlzLl9maXJzdFJlbmRlcikgewogICAgICAgIC8vIGlmIHRoaXMgaXMgdGhlIGZpcnN0IHJlbmRlciwgZG9uJ3QgZG8gYW55dGhpbmcgdG8KICAgICAgICAvLyByZXNldCB0aGUgcmVnaW9ucwogICAgICAgIHRoaXMuX2ZpcnN0UmVuZGVyID0gZmFsc2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgdGhpcyBpcyBub3QgdGhlIGZpcnN0IHJlbmRlciBjYWxsLCB0aGVuIHdlIG5lZWQgdG8KICAgICAgICAvLyByZS1pbml0aWFsaXplIHRoZSBgZWxgIGZvciBlYWNoIHJlZ2lvbgogICAgICAgIHRoaXMuX3JlSW5pdGlhbGl6ZVJlZ2lvbnMoKTsKICAgICAgfQogIAogICAgICByZXR1cm4gTWFyaW9uZXR0ZS5JdGVtVmlldy5wcm90b3R5cGUucmVuZGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gSGFuZGxlIGRlc3Ryb3lpbmcgcmVnaW9ucywgYW5kIHRoZW4gZGVzdHJveSB0aGUgdmlldyBpdHNlbGYuCiAgICBkZXN0cm95OiBmdW5jdGlvbigpIHsKICAgICAgaWYgKHRoaXMuaXNEZXN0cm95ZWQpIHsgcmV0dXJuIHRoaXM7IH0KICAKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmRlc3Ryb3koKTsKICAgICAgcmV0dXJuIE1hcmlvbmV0dGUuSXRlbVZpZXcucHJvdG90eXBlLmRlc3Ryb3kuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0sCiAgCiAgICAvLyBBZGQgYSBzaW5nbGUgcmVnaW9uLCBieSBuYW1lLCB0byB0aGUgbGF5b3V0VmlldwogICAgYWRkUmVnaW9uOiBmdW5jdGlvbihuYW1lLCBkZWZpbml0aW9uKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjphZGQnLCBuYW1lKTsKICAgICAgdmFyIHJlZ2lvbnMgPSB7fTsKICAgICAgcmVnaW9uc1tuYW1lXSA9IGRlZmluaXRpb247CiAgICAgIHJldHVybiB0aGlzLl9idWlsZFJlZ2lvbnMocmVnaW9ucylbbmFtZV07CiAgICB9LAogIAogICAgLy8gQWRkIG11bHRpcGxlIHJlZ2lvbnMgYXMgYSB7bmFtZTogZGVmaW5pdGlvbiwgbmFtZTI6IGRlZjJ9IG9iamVjdCBsaXRlcmFsCiAgICBhZGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25zKSB7CiAgICAgIHRoaXMucmVnaW9ucyA9IF8uZXh0ZW5kKHt9LCB0aGlzLnJlZ2lvbnMsIHJlZ2lvbnMpOwogICAgICByZXR1cm4gdGhpcy5fYnVpbGRSZWdpb25zKHJlZ2lvbnMpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZSBhIHNpbmdsZSByZWdpb24gZnJvbSB0aGUgTGF5b3V0VmlldywgYnkgbmFtZQogICAgcmVtb3ZlUmVnaW9uOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnJlZ2lvbjpyZW1vdmUnLCBuYW1lKTsKICAgICAgZGVsZXRlIHRoaXMucmVnaW9uc1tuYW1lXTsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5yZW1vdmVSZWdpb24obmFtZSk7CiAgICB9LAogIAogICAgLy8gUHJvdmlkZXMgYWx0ZXJuYXRpdmUgYWNjZXNzIHRvIHJlZ2lvbnMKICAgIC8vIEFjY2VwdHMgdGhlIHJlZ2lvbiBuYW1lCiAgICAvLyBnZXRSZWdpb24oJ21haW4nKQogICAgZ2V0UmVnaW9uOiBmdW5jdGlvbihyZWdpb24pIHsKICAgICAgcmV0dXJuIHRoaXMucmVnaW9uTWFuYWdlci5nZXQocmVnaW9uKTsKICAgIH0sCiAgCiAgICAvLyBHZXQgYWxsIHJlZ2lvbnMKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLnJlZ2lvbk1hbmFnZXIuZ2V0UmVnaW9ucygpOwogICAgfSwKICAKICAgIC8vIGludGVybmFsIG1ldGhvZCB0byBidWlsZCByZWdpb25zCiAgICBfYnVpbGRSZWdpb25zOiBmdW5jdGlvbihyZWdpb25zKSB7CiAgICAgIHZhciB0aGF0ID0gdGhpczsKICAKICAgICAgdmFyIGRlZmF1bHRzID0gewogICAgICAgIHJlZ2lvbkNsYXNzOiB0aGlzLmdldE9wdGlvbigncmVnaW9uQ2xhc3MnKSwKICAgICAgICBwYXJlbnRFbDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGF0LiRlbDsgfQogICAgICB9OwogIAogICAgICByZXR1cm4gdGhpcy5yZWdpb25NYW5hZ2VyLmFkZFJlZ2lvbnMocmVnaW9ucywgZGVmYXVsdHMpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHRoZSByZWdpb25zIHRoYXQgaGF2ZSBiZWVuIGRlZmluZWQgaW4gYQogICAgLy8gYHJlZ2lvbnNgIGF0dHJpYnV0ZSBvbiB0aGlzIGxheW91dFZpZXcuCiAgICBfaW5pdGlhbGl6ZVJlZ2lvbnM6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIHJlZ2lvbnM7CiAgICAgIHRoaXMuX2luaXRSZWdpb25NYW5hZ2VyKCk7CiAgCiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5yZWdpb25zKSkgewogICAgICAgIHJlZ2lvbnMgPSB0aGlzLnJlZ2lvbnMob3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVnaW9ucyA9IHRoaXMucmVnaW9ucyB8fCB7fTsKICAgICAgfQogIAogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBhcyBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgcmVnaW9uT3B0aW9ucyA9IHRoaXMuZ2V0T3B0aW9uLmNhbGwob3B0aW9ucywgJ3JlZ2lvbnMnKTsKICAKICAgICAgLy8gZW5hYmxlIHJlZ2lvbiBvcHRpb25zIHRvIGJlIGEgZnVuY3Rpb24KICAgICAgaWYgKF8uaXNGdW5jdGlvbihyZWdpb25PcHRpb25zKSkgewogICAgICAgIHJlZ2lvbk9wdGlvbnMgPSByZWdpb25PcHRpb25zLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgICAgIH0KICAKICAgICAgXy5leHRlbmQocmVnaW9ucywgcmVnaW9uT3B0aW9ucyk7CiAgCiAgICAgIC8vIE5vcm1hbGl6ZSByZWdpb24gc2VsZWN0b3JzIGhhc2ggdG8gYWxsb3cKICAgICAgLy8gYSB1c2VyIHRvIHVzZSB0aGUgQHVpLiBzeW50YXguCiAgICAgIHJlZ2lvbnMgPSB0aGlzLm5vcm1hbGl6ZVVJVmFsdWVzKHJlZ2lvbnMpOwogIAogICAgICB0aGlzLmFkZFJlZ2lvbnMocmVnaW9ucyk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlLWluaXRpYWxpemUgYWxsIG9mIHRoZSByZWdpb25zIGJ5IHVwZGF0aW5nIHRoZSBgZWxgIHRoYXQKICAgIC8vIHRoZXkgcG9pbnQgdG8KICAgIF9yZUluaXRpYWxpemVSZWdpb25zOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgICB0aGlzLnJlZ2lvbk1hbmFnZXIuZWFjaChmdW5jdGlvbihyZWdpb24pIHsKICAgICAgICByZWdpb24ucmVzZXQoKTsKICAgICAgfSk7CiAgICB9LAogIAogICAgLy8gRW5hYmxlIGVhc3kgb3ZlcnJpZGluZyBvZiB0aGUgZGVmYXVsdCBgUmVnaW9uTWFuYWdlcmAKICAgIC8vIGZvciBjdXN0b21pemVkIHJlZ2lvbiBpbnRlcmFjdGlvbnMgYW5kIGJ1c2luZXNzIHNwZWNpZmljCiAgICAvLyB2aWV3IGxvZ2ljIGZvciBiZXR0ZXIgY29udHJvbCBvdmVyIHNpbmdsZSByZWdpb25zLgogICAgZ2V0UmVnaW9uTWFuYWdlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgTWFyaW9uZXR0ZS5SZWdpb25NYW5hZ2VyKCk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIGluaXRpYWxpemUgdGhlIHJlZ2lvbiBtYW5hZ2VyCiAgICAvLyBhbmQgYWxsIHJlZ2lvbnMgaW4gaXQKICAgIF9pbml0UmVnaW9uTWFuYWdlcjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMucmVnaW9uTWFuYWdlciwgJ2JlZm9yZTphZGQ6cmVnaW9uJywgZnVuY3Rpb24obmFtZSkgewogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOmFkZDpyZWdpb24nLCBuYW1lKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5yZWdpb25NYW5hZ2VyLCAnYWRkOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIHRoaXNbbmFtZV0gPSByZWdpb247CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdhZGQ6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgCiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLnJlZ2lvbk1hbmFnZXIsICdyZW1vdmU6cmVnaW9uJywgZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbbmFtZV07CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdyZW1vdmU6cmVnaW9uJywgbmFtZSwgcmVnaW9uKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgCgogIC8vIEJlaGF2aW9yCiAgLy8gLS0tLS0tLS0tLS0KICAKICAvLyBBIEJlaGF2aW9yIGlzIGFuIGlzb2xhdGVkIHNldCBvZiBET00gLwogIC8vIHVzZXIgaW50ZXJhY3Rpb25zIHRoYXQgY2FuIGJlIG1peGVkIGludG8gYW55IFZpZXcuCiAgLy8gQmVoYXZpb3JzIGFsbG93IHlvdSB0byBibGFja2JveCBWaWV3IHNwZWNpZmljIGludGVyYWN0aW9ucwogIC8vIGludG8gcG9ydGFibGUgbG9naWNhbCBjaHVua3MsIGtlZXBpbmcgeW91ciB2aWV3cyBzaW1wbGUgYW5kIHlvdXIgY29kZSBEUlkuCiAgCiAgTWFyaW9uZXR0ZS5CZWhhdmlvciA9IChmdW5jdGlvbihfLCBCYWNrYm9uZSkgewogICAgZnVuY3Rpb24gQmVoYXZpb3Iob3B0aW9ucywgdmlldykgewogICAgICAvLyBTZXR1cCByZWZlcmVuY2UgdG8gdGhlIHZpZXcuCiAgICAgIC8vIHRoaXMgY29tZXMgaW4gaGFuZGxlIHdoZW4gYSBiZWhhdmlvcgogICAgICAvLyB3YW50cyB0byBkaXJlY3RseSB0YWxrIHVwIHRoZSBjaGFpbgogICAgICAvLyB0byB0aGUgdmlldy4KICAgICAgdGhpcy52aWV3ID0gdmlldzsKICAgICAgdGhpcy5kZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpIHx8IHt9OwogICAgICB0aGlzLm9wdGlvbnMgID0gXy5leHRlbmQoe30sIHRoaXMuZGVmYXVsdHMsIG9wdGlvbnMpOwogIAogICAgICAvLyBwcm94eSBiZWhhdmlvciAkIG1ldGhvZCB0byB0aGUgdmlldwogICAgICAvLyB0aGlzIGlzIHVzZWZ1bCBmb3IgZG9pbmcganF1ZXJ5IERPTSBsb29rdXBzCiAgICAgIC8vIHNjb3BlZCB0byBiZWhhdmlvcnMgdmlldy4KICAgICAgdGhpcy4kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy4kLmFwcGx5KHRoaXMudmlldywgYXJndW1lbnRzKTsKICAgICAgfTsKICAKICAgICAgLy8gQ2FsbCB0aGUgaW5pdGlhbGl6ZSBtZXRob2QgcGFzc2luZwogICAgICAvLyB0aGUgYXJndW1lbnRzIGZyb20gdGhlIGluc3RhbmNlIGNvbnN0cnVjdG9yCiAgICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQogIAogICAgXy5leHRlbmQoQmVoYXZpb3IucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSwKICAKICAgICAgLy8gc3RvcExpc3RlbmluZyB0byBiZWhhdmlvciBgb25MaXN0ZW5gIGV2ZW50cy4KICAgICAgZGVzdHJveTogZnVuY3Rpb24oKSB7CiAgICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIH0sCiAgCiAgICAgIHByb3h5Vmlld1Byb3BlcnRpZXM6IGZ1bmN0aW9uICh2aWV3KSB7CiAgICAgICAgdGhpcy4kZWwgPSB2aWV3LiRlbDsKICAgICAgICB0aGlzLmVsID0gdmlldy5lbDsKICAgICAgfSwKICAKICAgICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAgIC8vIG1ldGhvZHMgaWYgdGhlIG1ldGhvZCBleGlzdHMKICAgICAgdHJpZ2dlck1ldGhvZDogTWFyaW9uZXR0ZS50cmlnZ2VyTWV0aG9kLAogIAogICAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uLAogIAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgYmluZGluZyB2aWV3J3MgZXZlbnRzIGZyb20gYW5vdGhlciBlbnRpdHkuCiAgICAgIGJpbmRFbnRpdHlFdmVudHM6IE1hcmlvbmV0dGUucHJveHlCaW5kRW50aXR5RXZlbnRzLAogIAogICAgICAvLyBQcm94eSBgdW5iaW5kRW50aXR5RXZlbnRzYCB0byBlbmFibGUgdW5iaW5kaW5nIHZpZXcncyBldmVudHMgZnJvbSBhbm90aGVyIGVudGl0eS4KICAgICAgdW5iaW5kRW50aXR5RXZlbnRzOiBNYXJpb25ldHRlLnByb3h5VW5iaW5kRW50aXR5RXZlbnRzCiAgICB9KTsKICAKICAgIC8vIEJvcnJvdyBCYWNrYm9uZXMgZXh0ZW5kIGltcGxlbWVudGF0aW9uCiAgICAvLyB0aGlzIGFsbG93cyB1cyB0byBzZXR1cCBhIHByb3BlcgogICAgLy8gaW5oZXJpdGFuY2UgcGF0dGVybiB0aGF0IGZvbGxvd3Mgc3VpdAogICAgLy8gd2l0aCB0aGUgcmVzdCBvZiBNYXJpb25ldHRlIHZpZXdzLgogICAgQmVoYXZpb3IuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgCiAgICByZXR1cm4gQmVoYXZpb3I7CiAgfSkoXywgQmFja2JvbmUpOwogIAogIC8qIGpzaGludCBtYXhsZW46IDE0MyAqLwogIC8vIE1hcmlvbmV0dGUuQmVoYXZpb3JzCiAgLy8gLS0tLS0tLS0KICAKICAvLyBCZWhhdmlvcnMgaXMgYSB1dGlsaXR5IGNsYXNzIHRoYXQgdGFrZXMgY2FyZSBvZgogIC8vIGdsdWluZyB5b3VyIGJlaGF2aW9yIGluc3RhbmNlcyB0byB0aGVpciBnaXZlbiBWaWV3LgogIC8vIFRoZSBtb3N0IGltcG9ydGFudCBwYXJ0IG9mIHRoaXMgY2xhc3MgaXMgdGhhdCB5b3UKICAvLyAqKk1VU1QqKiBvdmVycmlkZSB0aGUgY2xhc3MgbGV2ZWwgYmVoYXZpb3JzTG9va3VwCiAgLy8gbWV0aG9kIGZvciB0aGluZ3MgdG8gd29yayBwcm9wZXJseS4KICAKICBNYXJpb25ldHRlLkJlaGF2aW9ycyA9IChmdW5jdGlvbihNYXJpb25ldHRlLCBfKSB7CiAgCiAgICBmdW5jdGlvbiBCZWhhdmlvcnModmlldywgYmVoYXZpb3JzKSB7CiAgCiAgICAgIGlmICghXy5pc09iamVjdCh2aWV3LmJlaGF2aW9ycykpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAKICAgICAgLy8gQmVoYXZpb3JzIGRlZmluZWQgb24gYSB2aWV3IGNhbiBiZSBhIGZsYXQgb2JqZWN0IGxpdGVyYWwKICAgICAgLy8gb3IgaXQgY2FuIGJlIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGFuIG9iamVjdC4KICAgICAgYmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIGJlaGF2aW9ycyB8fCBfLnJlc3VsdCh2aWV3LCAnYmVoYXZpb3JzJykpOwogIAogICAgICAvLyBXcmFwcyBzZXZlcmFsIG9mIHRoZSB2aWV3J3MgbWV0aG9kcwogICAgICAvLyBjYWxsaW5nIHRoZSBtZXRob2RzIGZpcnN0IG9uIGVhY2ggYmVoYXZpb3IKICAgICAgLy8gYW5kIHRoZW4gZXZlbnR1YWxseSBjYWxsaW5nIHRoZSBtZXRob2Qgb24gdGhlIHZpZXcuCiAgICAgIEJlaGF2aW9ycy53cmFwKHZpZXcsIGJlaGF2aW9ycywgXy5rZXlzKG1ldGhvZHMpKTsKICAgICAgcmV0dXJuIGJlaGF2aW9yczsKICAgIH0KICAKICAgIHZhciBtZXRob2RzID0gewogICAgICBiZWhhdmlvclRyaWdnZXJzOiBmdW5jdGlvbihiZWhhdmlvclRyaWdnZXJzLCBiZWhhdmlvcnMpIHsKICAgICAgICB2YXIgdHJpZ2dlckJ1aWxkZXIgPSBuZXcgQmVoYXZpb3JUcmlnZ2Vyc0J1aWxkZXIodGhpcywgYmVoYXZpb3JzKTsKICAgICAgICByZXR1cm4gdHJpZ2dlckJ1aWxkZXIuYnVpbGRCZWhhdmlvclRyaWdnZXJzKCk7CiAgICAgIH0sCiAgCiAgICAgIGJlaGF2aW9yRXZlbnRzOiBmdW5jdGlvbihiZWhhdmlvckV2ZW50cywgYmVoYXZpb3JzKSB7CiAgICAgICAgdmFyIF9iZWhhdmlvcnNFdmVudHMgPSB7fTsKICAgICAgICB2YXIgdmlld1VJID0gXy5yZXN1bHQodGhpcywgJ3VpJyk7CiAgCiAgICAgICAgXy5lYWNoKGJlaGF2aW9ycywgZnVuY3Rpb24oYiwgaSkgewogICAgICAgICAgdmFyIF9ldmVudHMgPSB7fTsKICAgICAgICAgIHZhciBiZWhhdmlvckV2ZW50cyA9IF8uY2xvbmUoXy5yZXN1bHQoYiwgJ2V2ZW50cycpKSB8fCB7fTsKICAgICAgICAgIHZhciBiZWhhdmlvclVJID0gXy5yZXN1bHQoYiwgJ3VpJyk7CiAgCiAgICAgICAgICAvLyBDb25zdHJ1Y3QgYW4gaW50ZXJuYWwgVUkgaGFzaCBmaXJzdCB1c2luZwogICAgICAgICAgLy8gdGhlIHZpZXdzIFVJIGhhc2ggYW5kIHRoZW4gdGhlIGJlaGF2aW9ycyBVSSBoYXNoLgogICAgICAgICAgLy8gVGhpcyBhbGxvd3MgdGhlIHVzZXIgdG8gdXNlIFVJIGhhc2ggZWxlbWVudHMKICAgICAgICAgIC8vIGRlZmluZWQgaW4gdGhlIHBhcmVudCB2aWV3IGFzIHdlbGwgYXMgdGhvc2UKICAgICAgICAgIC8vIGRlZmluZWQgaW4gdGhlIGdpdmVuIGJlaGF2aW9yLgogICAgICAgICAgdmFyIHVpID0gXy5leHRlbmQoe30sIHZpZXdVSSwgYmVoYXZpb3JVSSk7CiAgCiAgICAgICAgICAvLyBOb3JtYWxpemUgYmVoYXZpb3IgZXZlbnRzIGhhc2ggdG8gYWxsb3cKICAgICAgICAgIC8vIGEgdXNlciB0byB1c2UgdGhlIEB1aS4gc3ludGF4LgogICAgICAgICAgYmVoYXZpb3JFdmVudHMgPSBNYXJpb25ldHRlLm5vcm1hbGl6ZVVJS2V5cyhiZWhhdmlvckV2ZW50cywgdWkpOwogIAogICAgICAgICAgXy5lYWNoKF8ua2V5cyhiZWhhdmlvckV2ZW50cyksIGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAvLyBBcHBlbmQgd2hpdGUtc3BhY2UgYXQgdGhlIGVuZCBvZiBlYWNoIGtleSB0byBwcmV2ZW50IGJlaGF2aW9yIGtleSBjb2xsaXNpb25zLgogICAgICAgICAgICAvLyBUaGlzIGlzIHJlbHlpbmcgb24gdGhlIGZhY3QgdGhhdCBiYWNrYm9uZSBldmVudHMgY29uc2lkZXJzICJjbGljayAuZm9vIiB0aGUgc2FtZSBhcwogICAgICAgICAgICAvLyAiY2xpY2sgLmZvbyAiLgogIAogICAgICAgICAgICAvLyArMiBpcyB1c2VkIGJlY2F1c2UgbmV3IEFycmF5KDEpIG9yIDAgaXMgIiIgYW5kIG5vdCAiICIKICAgICAgICAgICAgdmFyIHdoaXRlc3BhY2UgPSAobmV3IEFycmF5KGkgKyAyKSkuam9pbignICcpOwogICAgICAgICAgICB2YXIgZXZlbnRLZXkgICA9IGtleSArIHdoaXRlc3BhY2U7CiAgICAgICAgICAgIHZhciBoYW5kbGVyICAgID0gXy5pc0Z1bmN0aW9uKGJlaGF2aW9yRXZlbnRzW2tleV0pID8gYmVoYXZpb3JFdmVudHNba2V5XSA6IGJbYmVoYXZpb3JFdmVudHNba2V5XV07CiAgCiAgICAgICAgICAgIF9ldmVudHNbZXZlbnRLZXldID0gXy5iaW5kKGhhbmRsZXIsIGIpOwogICAgICAgICAgfSk7CiAgCiAgICAgICAgICBfYmVoYXZpb3JzRXZlbnRzID0gXy5leHRlbmQoX2JlaGF2aW9yc0V2ZW50cywgX2V2ZW50cyk7CiAgICAgICAgfSk7CiAgCiAgICAgICAgcmV0dXJuIF9iZWhhdmlvcnNFdmVudHM7CiAgICAgIH0KICAgIH07CiAgCiAgICBfLmV4dGVuZChCZWhhdmlvcnMsIHsKICAKICAgICAgLy8gUGxhY2Vob2xkZXIgbWV0aG9kIHRvIGJlIGV4dGVuZGVkIGJ5IHRoZSB1c2VyLgogICAgICAvLyBUaGUgbWV0aG9kIHNob3VsZCBkZWZpbmUgdGhlIG9iamVjdCB0aGF0IHN0b3JlcyB0aGUgYmVoYXZpb3JzLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGBgYGpzCiAgICAgIC8vIE1hcmlvbmV0dGUuQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vICAgcmV0dXJuIEFwcC5CZWhhdmlvcnMKICAgICAgLy8gfQogICAgICAvLyBgYGAKICAgICAgYmVoYXZpb3JzTG9va3VwOiBmdW5jdGlvbigpIHsKICAgICAgICB0aHJvdyBuZXcgTWFyaW9uZXR0ZS5FcnJvcih7CiAgICAgICAgICBtZXNzYWdlOiAnWW91IG11c3QgZGVmaW5lIHdoZXJlIHlvdXIgYmVoYXZpb3JzIGFyZSBzdG9yZWQuJywKICAgICAgICAgIHVybDogJ21hcmlvbmV0dGUuYmVoYXZpb3JzLmh0bWwjYmVoYXZpb3JzbG9va3VwJwogICAgICAgIH0pOwogICAgICB9LAogIAogICAgICAvLyBUYWtlcyBjYXJlIG9mIGdldHRpbmcgdGhlIGJlaGF2aW9yIGNsYXNzCiAgICAgIC8vIGdpdmVuIG9wdGlvbnMgYW5kIGEga2V5LgogICAgICAvLyBJZiBhIHVzZXIgcGFzc2VzIGluIG9wdGlvbnMuYmVoYXZpb3JDbGFzcwogICAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoYXQuIE90aGVyd2lzZSBkZWxlZ2F0ZQogICAgICAvLyB0aGUgbG9va3VwIHRvIHRoZSB1c2VycyBgYmVoYXZpb3JzTG9va3VwYCBpbXBsZW1lbnRhdGlvbi4KICAgICAgZ2V0QmVoYXZpb3JDbGFzczogZnVuY3Rpb24ob3B0aW9ucywga2V5KSB7CiAgICAgICAgaWYgKG9wdGlvbnMuYmVoYXZpb3JDbGFzcykgewogICAgICAgICAgcmV0dXJuIG9wdGlvbnMuYmVoYXZpb3JDbGFzczsKICAgICAgICB9CiAgCiAgICAgICAgLy8gR2V0IGJlaGF2aW9yIGNsYXNzIGNhbiBiZSBlaXRoZXIgYSBmbGF0IG9iamVjdCBvciBhIG1ldGhvZAogICAgICAgIHJldHVybiBfLmlzRnVuY3Rpb24oQmVoYXZpb3JzLmJlaGF2aW9yc0xvb2t1cCkgPyBCZWhhdmlvcnMuYmVoYXZpb3JzTG9va3VwLmFwcGx5KHRoaXMsIGFyZ3VtZW50cylba2V5XSA6IEJlaGF2aW9ycy5iZWhhdmlvcnNMb29rdXBba2V5XTsKICAgICAgfSwKICAKICAgICAgLy8gSXRlcmF0ZSBvdmVyIHRoZSBiZWhhdmlvcnMgb2JqZWN0LCBmb3IgZWFjaCBiZWhhdmlvcgogICAgICAvLyBpbnN0YW50aWF0ZSBpdCBhbmQgZ2V0IGl0cyBncm91cGVkIGJlaGF2aW9ycy4KICAgICAgcGFyc2VCZWhhdmlvcnM6IGZ1bmN0aW9uKHZpZXcsIGJlaGF2aW9ycykgewogICAgICAgIHJldHVybiBfLmNoYWluKGJlaGF2aW9ycykubWFwKGZ1bmN0aW9uKG9wdGlvbnMsIGtleSkgewogICAgICAgICAgdmFyIEJlaGF2aW9yQ2xhc3MgPSBCZWhhdmlvcnMuZ2V0QmVoYXZpb3JDbGFzcyhvcHRpb25zLCBrZXkpOwogIAogICAgICAgICAgdmFyIGJlaGF2aW9yID0gbmV3IEJlaGF2aW9yQ2xhc3Mob3B0aW9ucywgdmlldyk7CiAgICAgICAgICB2YXIgbmVzdGVkQmVoYXZpb3JzID0gQmVoYXZpb3JzLnBhcnNlQmVoYXZpb3JzKHZpZXcsIF8ucmVzdWx0KGJlaGF2aW9yLCAnYmVoYXZpb3JzJykpOwogIAogICAgICAgICAgcmV0dXJuIFtiZWhhdmlvcl0uY29uY2F0KG5lc3RlZEJlaGF2aW9ycyk7CiAgICAgICAgfSkuZmxhdHRlbigpLnZhbHVlKCk7CiAgICAgIH0sCiAgCiAgICAgIC8vIFdyYXAgdmlldyBpbnRlcm5hbCBtZXRob2RzIHNvIHRoYXQgdGhleSBkZWxlZ2F0ZSB0byBiZWhhdmlvcnMuIEZvciBleGFtcGxlLAogICAgICAvLyBgb25EZXN0cm95YCBzaG91bGQgdHJpZ2dlciBkZXN0cm95IG9uIGFsbCBvZiB0aGUgYmVoYXZpb3JzIGFuZCB0aGVuIGRlc3Ryb3kgaXRzZWxmLgogICAgICAvLyBpLmUuCiAgICAgIC8vCiAgICAgIC8vIGB2aWV3LmRlbGVnYXRlRXZlbnRzID0gXy5wYXJ0aWFsKG1ldGhvZHMuZGVsZWdhdGVFdmVudHMsIHZpZXcuZGVsZWdhdGVFdmVudHMsIGJlaGF2aW9ycyk7YAogICAgICB3cmFwOiBmdW5jdGlvbih2aWV3LCBiZWhhdmlvcnMsIG1ldGhvZE5hbWVzKSB7CiAgICAgICAgXy5lYWNoKG1ldGhvZE5hbWVzLCBmdW5jdGlvbihtZXRob2ROYW1lKSB7CiAgICAgICAgICB2aWV3W21ldGhvZE5hbWVdID0gXy5wYXJ0aWFsKG1ldGhvZHNbbWV0aG9kTmFtZV0sIHZpZXdbbWV0aG9kTmFtZV0sIGJlaGF2aW9ycyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIAogICAgLy8gQ2xhc3MgdG8gYnVpbGQgaGFuZGxlcnMgZm9yIGB0cmlnZ2Vyc2Agb24gYmVoYXZpb3JzCiAgICAvLyBmb3Igdmlld3MKICAgIGZ1bmN0aW9uIEJlaGF2aW9yVHJpZ2dlcnNCdWlsZGVyKHZpZXcsIGJlaGF2aW9ycykgewogICAgICB0aGlzLl92aWV3ICAgICAgPSB2aWV3OwogICAgICB0aGlzLl92aWV3VUkgICAgPSBfLnJlc3VsdCh2aWV3LCAndWknKTsKICAgICAgdGhpcy5fYmVoYXZpb3JzID0gYmVoYXZpb3JzOwogICAgICB0aGlzLl90cmlnZ2VycyAgPSB7fTsKICAgIH0KICAKICAgIF8uZXh0ZW5kKEJlaGF2aW9yVHJpZ2dlcnNCdWlsZGVyLnByb3RvdHlwZSwgewogICAgICAvLyBNYWluIG1ldGhvZCB0byBidWlsZCB0aGUgdHJpZ2dlcnMgaGFzaCB3aXRoIGV2ZW50IGtleXMgYW5kIGhhbmRsZXJzCiAgICAgIGJ1aWxkQmVoYXZpb3JUcmlnZ2VyczogZnVuY3Rpb24oKSB7CiAgICAgICAgXy5lYWNoKHRoaXMuX2JlaGF2aW9ycywgdGhpcy5fYnVpbGRUcmlnZ2VySGFuZGxlcnNGb3JCZWhhdmlvciwgdGhpcyk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RyaWdnZXJzOwogICAgICB9LAogIAogICAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gYnVpbGQgYWxsIHRyaWdnZXIgaGFuZGxlcnMgZm9yIGEgZ2l2ZW4gYmVoYXZpb3IKICAgICAgX2J1aWxkVHJpZ2dlckhhbmRsZXJzRm9yQmVoYXZpb3I6IGZ1bmN0aW9uKGJlaGF2aW9yLCBpKSB7CiAgICAgICAgdmFyIHVpID0gXy5leHRlbmQoe30sIHRoaXMuX3ZpZXdVSSwgXy5yZXN1bHQoYmVoYXZpb3IsICd1aScpKTsKICAgICAgICB2YXIgdHJpZ2dlcnNIYXNoID0gXy5jbG9uZShfLnJlc3VsdChiZWhhdmlvciwgJ3RyaWdnZXJzJykpIHx8IHt9OwogIAogICAgICAgIHRyaWdnZXJzSGFzaCA9IE1hcmlvbmV0dGUubm9ybWFsaXplVUlLZXlzKHRyaWdnZXJzSGFzaCwgdWkpOwogIAogICAgICAgIF8uZWFjaCh0cmlnZ2Vyc0hhc2gsIF8ucGFydGlhbCh0aGlzLl9zZXRIYW5kbGVyRm9yQmVoYXZpb3IsIGJlaGF2aW9yLCBpKSwgdGhpcyk7CiAgICAgIH0sCiAgCiAgICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBjcmVhdGUgYW5kIGFzc2lnbiB0aGUgdHJpZ2dlciBoYW5kbGVyIGZvciBhIGdpdmVuCiAgICAgIC8vIGJlaGF2aW9yCiAgICAgIF9zZXRIYW5kbGVyRm9yQmVoYXZpb3I6IGZ1bmN0aW9uKGJlaGF2aW9yLCBpLCBldmVudE5hbWUsIHRyaWdnZXIpIHsKICAgICAgICAvLyBVbmlxdWUgaWRlbnRpZmllciBmb3IgdGhlIGB0aGlzLl90cmlnZ2Vyc2AgaGFzaAogICAgICAgIHZhciB0cmlnZ2VyS2V5ID0gdHJpZ2dlci5yZXBsYWNlKC9eXFMrLywgZnVuY3Rpb24odHJpZ2dlck5hbWUpIHsKICAgICAgICAgIHJldHVybiB0cmlnZ2VyTmFtZSArICcuJyArICdiZWhhdmlvcnRyaWdnZXJzJyArIGk7CiAgICAgICAgfSk7CiAgCiAgICAgICAgdGhpcy5fdHJpZ2dlcnNbdHJpZ2dlcktleV0gPSB0aGlzLl92aWV3Ll9idWlsZFZpZXdUcmlnZ2VyKGV2ZW50TmFtZSk7CiAgICAgIH0KICAgIH0pOwogIAogICAgcmV0dXJuIEJlaGF2aW9yczsKICAKICB9KShNYXJpb25ldHRlLCBfKTsKICAKCiAgLy8gQXBwUm91dGVyCiAgLy8gLS0tLS0tLS0tCiAgCiAgLy8gUmVkdWNlIHRoZSBib2lsZXJwbGF0ZSBjb2RlIG9mIGhhbmRsaW5nIHJvdXRlIGV2ZW50cwogIC8vIGFuZCB0aGVuIGNhbGxpbmcgYSBzaW5nbGUgbWV0aG9kIG9uIGFub3RoZXIgb2JqZWN0LgogIC8vIEhhdmUgeW91ciByb3V0ZXJzIGNvbmZpZ3VyZWQgdG8gY2FsbCB0aGUgbWV0aG9kIG9uCiAgLy8geW91ciBvYmplY3QsIGRpcmVjdGx5LgogIC8vCiAgLy8gQ29uZmlndXJlIGFuIEFwcFJvdXRlciB3aXRoIGBhcHBSb3V0ZXNgLgogIC8vCiAgLy8gQXBwIHJvdXRlcnMgY2FuIG9ubHkgdGFrZSBvbmUgYGNvbnRyb2xsZXJgIG9iamVjdC4KICAvLyBJdCBpcyByZWNvbW1lbmRlZCB0aGF0IHlvdSBkaXZpZGUgeW91ciBjb250cm9sbGVyCiAgLy8gb2JqZWN0cyBpbiB0byBzbWFsbGVyIHBpZWNlcyBvZiByZWxhdGVkIGZ1bmN0aW9uYWxpdHkKICAvLyBhbmQgaGF2ZSBtdWx0aXBsZSByb3V0ZXJzIC8gY29udHJvbGxlcnMsIGluc3RlYWQgb2YKICAvLyBqdXN0IG9uZSBnaWFudCByb3V0ZXIgYW5kIGNvbnRyb2xsZXIuCiAgLy8KICAvLyBZb3UgY2FuIGFsc28gYWRkIHN0YW5kYXJkIHJvdXRlcyB0byBhbiBBcHBSb3V0ZXIuCiAgCiAgTWFyaW9uZXR0ZS5BcHBSb3V0ZXIgPSBCYWNrYm9uZS5Sb3V0ZXIuZXh0ZW5kKHsKICAKICAgIGNvbnN0cnVjdG9yOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIEJhY2tib25lLlJvdXRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIAogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIAogICAgICB2YXIgYXBwUm91dGVzID0gdGhpcy5nZXRPcHRpb24oJ2FwcFJvdXRlcycpOwogICAgICB2YXIgY29udHJvbGxlciA9IHRoaXMuX2dldENvbnRyb2xsZXIoKTsKICAgICAgdGhpcy5wcm9jZXNzQXBwUm91dGVzKGNvbnRyb2xsZXIsIGFwcFJvdXRlcyk7CiAgICAgIHRoaXMub24oJ3JvdXRlJywgdGhpcy5fcHJvY2Vzc09uUm91dGUsIHRoaXMpOwogICAgfSwKICAKICAgIC8vIFNpbWlsYXIgdG8gcm91dGUgbWV0aG9kIG9uIGEgQmFja2JvbmUgUm91dGVyIGJ1dAogICAgLy8gbWV0aG9kIGlzIGNhbGxlZCBvbiB0aGUgY29udHJvbGxlcgogICAgYXBwUm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBtZXRob2ROYW1lKSB7CiAgICAgIHZhciBjb250cm9sbGVyID0gdGhpcy5fZ2V0Q29udHJvbGxlcigpOwogICAgICB0aGlzLl9hZGRBcHBSb3V0ZShjb250cm9sbGVyLCByb3V0ZSwgbWV0aG9kTmFtZSk7CiAgICB9LAogIAogICAgLy8gcHJvY2VzcyB0aGUgcm91dGUgZXZlbnQgYW5kIHRyaWdnZXIgdGhlIG9uUm91dGUKICAgIC8vIG1ldGhvZCBjYWxsLCBpZiBpdCBleGlzdHMKICAgIF9wcm9jZXNzT25Sb3V0ZTogZnVuY3Rpb24ocm91dGVOYW1lLCByb3V0ZUFyZ3MpIHsKICAgICAgLy8gZmluZCB0aGUgcGF0aCB0aGF0IG1hdGNoZWQKICAgICAgdmFyIHJvdXRlUGF0aCA9IF8uaW52ZXJ0KHRoaXMuZ2V0T3B0aW9uKCdhcHBSb3V0ZXMnKSlbcm91dGVOYW1lXTsKICAKICAgICAgLy8gbWFrZSBzdXJlIGFuIG9uUm91dGUgaXMgdGhlcmUsIGFuZCBjYWxsIGl0CiAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5vblJvdXRlKSkgewogICAgICAgIHRoaXMub25Sb3V0ZShyb3V0ZU5hbWUsIHJvdXRlUGF0aCwgcm91dGVBcmdzKTsKICAgICAgfQogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBwcm9jZXNzIHRoZSBgYXBwUm91dGVzYCBmb3IgdGhlCiAgICAvLyByb3V0ZXIsIGFuZCB0dXJuIHRoZW0gaW4gdG8gcm91dGVzIHRoYXQgdHJpZ2dlciB0aGUKICAgIC8vIHNwZWNpZmllZCBtZXRob2Qgb24gdGhlIHNwZWNpZmllZCBgY29udHJvbGxlcmAuCiAgICBwcm9jZXNzQXBwUm91dGVzOiBmdW5jdGlvbihjb250cm9sbGVyLCBhcHBSb3V0ZXMpIHsKICAgICAgaWYgKCFhcHBSb3V0ZXMpIHsgcmV0dXJuOyB9CiAgCiAgICAgIHZhciByb3V0ZU5hbWVzID0gXy5rZXlzKGFwcFJvdXRlcykucmV2ZXJzZSgpOyAvLyBCYWNrYm9uZSByZXF1aXJlcyByZXZlcnRlZCBvcmRlciBvZiByb3V0ZXMKICAKICAgICAgXy5lYWNoKHJvdXRlTmFtZXMsIGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgICAgdGhpcy5fYWRkQXBwUm91dGUoY29udHJvbGxlciwgcm91dGUsIGFwcFJvdXRlc1tyb3V0ZV0pOwogICAgICB9LCB0aGlzKTsKICAgIH0sCiAgCiAgICBfZ2V0Q29udHJvbGxlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE9wdGlvbignY29udHJvbGxlcicpOwogICAgfSwKICAKICAgIF9hZGRBcHBSb3V0ZTogZnVuY3Rpb24oY29udHJvbGxlciwgcm91dGUsIG1ldGhvZE5hbWUpIHsKICAgICAgdmFyIG1ldGhvZCA9IGNvbnRyb2xsZXJbbWV0aG9kTmFtZV07CiAgCiAgICAgIGlmICghbWV0aG9kKSB7CiAgICAgICAgdGhyb3cgbmV3IE1hcmlvbmV0dGUuRXJyb3IoJ01ldGhvZCAiJyArIG1ldGhvZE5hbWUgKyAnIiB3YXMgbm90IGZvdW5kIG9uIHRoZSBjb250cm9sbGVyJyk7CiAgICAgIH0KICAKICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgbWV0aG9kTmFtZSwgXy5iaW5kKG1ldGhvZCwgY29udHJvbGxlcikpOwogICAgfSwKICAKICAgIC8vIFByb3h5IGBnZXRPcHRpb25gIHRvIGVuYWJsZSBnZXR0aW5nIG9wdGlvbnMgZnJvbSB0aGlzIG9yIHRoaXMub3B0aW9ucyBieSBuYW1lLgogICAgZ2V0T3B0aW9uOiBNYXJpb25ldHRlLnByb3h5R2V0T3B0aW9uCiAgfSk7CiAgCiAgLy8gQXBwbGljYXRpb24KICAvLyAtLS0tLS0tLS0tLQogIAogIC8vIENvbnRhaW4gYW5kIG1hbmFnZSB0aGUgY29tcG9zaXRlIGFwcGxpY2F0aW9uIGFzIGEgd2hvbGUuCiAgLy8gU3RvcmVzIGFuZCBzdGFydHMgdXAgYFJlZ2lvbmAgb2JqZWN0cywgaW5jbHVkZXMgYW4KICAvLyBldmVudCBhZ2dyZWdhdG9yIGFzIGBhcHAudmVudGAKICBNYXJpb25ldHRlLkFwcGxpY2F0aW9uID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMuX2luaXRpYWxpemVSZWdpb25zKG9wdGlvbnMpOwogICAgdGhpcy5faW5pdENhbGxiYWNrcyA9IG5ldyBNYXJpb25ldHRlLkNhbGxiYWNrcygpOwogICAgdGhpcy5zdWJtb2R1bGVzID0ge307CiAgICBfLmV4dGVuZCh0aGlzLCBvcHRpb25zKTsKICAgIHRoaXMuX2luaXRDaGFubmVsKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwogIAogIF8uZXh0ZW5kKE1hcmlvbmV0dGUuQXBwbGljYXRpb24ucHJvdG90eXBlLCBCYWNrYm9uZS5FdmVudHMsIHsKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9LAogIAogICAgLy8gQ29tbWFuZCBleGVjdXRpb24sIGZhY2lsaXRhdGVkIGJ5IEJhY2tib25lLldyZXFyLkNvbW1hbmRzCiAgICBleGVjdXRlOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jb21tYW5kcy5leGVjdXRlLmFwcGx5KHRoaXMuY29tbWFuZHMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gUmVxdWVzdC9yZXNwb25zZSwgZmFjaWxpdGF0ZWQgYnkgQmFja2JvbmUuV3JlcXIuUmVxdWVzdFJlc3BvbnNlCiAgICByZXF1ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMucmVxcmVzLnJlcXVlc3QuYXBwbHkodGhpcy5yZXFyZXMsIGFyZ3VtZW50cyk7CiAgICB9LAogIAogICAgLy8gQWRkIGFuIGluaXRpYWxpemVyIHRoYXQgaXMgZWl0aGVyIHJ1biBhdCB3aGVuIHRoZSBgc3RhcnRgCiAgICAvLyBtZXRob2QgaXMgY2FsbGVkLCBvciBydW4gaW1tZWRpYXRlbHkgaWYgYWRkZWQgYWZ0ZXIgYHN0YXJ0YAogICAgLy8gaGFzIGFscmVhZHkgYmVlbiBjYWxsZWQuCiAgICBhZGRJbml0aWFsaXplcjogZnVuY3Rpb24oaW5pdGlhbGl6ZXIpIHsKICAgICAgdGhpcy5faW5pdENhbGxiYWNrcy5hZGQoaW5pdGlhbGl6ZXIpOwogICAgfSwKICAKICAgIC8vIGtpY2sgb2ZmIGFsbCBvZiB0aGUgYXBwbGljYXRpb24ncyBwcm9jZXNzZXMuCiAgICAvLyBpbml0aWFsaXplcyBhbGwgb2YgdGhlIHJlZ2lvbnMgdGhhdCBoYXZlIGJlZW4gYWRkZWQKICAgIC8vIHRvIHRoZSBhcHAsIGFuZCBydW5zIGFsbCBvZiB0aGUgaW5pdGlhbGl6ZXIgZnVuY3Rpb25zCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTpzdGFydCcsIG9wdGlvbnMpOwogICAgICB0aGlzLl9pbml0Q2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdzdGFydCcsIG9wdGlvbnMpOwogICAgfSwKICAKICAgIC8vIEFkZCByZWdpb25zIHRvIHlvdXIgYXBwLgogICAgLy8gQWNjZXB0cyBhIGhhc2ggb2YgbmFtZWQgc3RyaW5ncyBvciBSZWdpb24gb2JqZWN0cwogICAgLy8gYWRkUmVnaW9ucyh7c29tZXRoaW5nOiAiI3NvbWVSZWdpb24ifSkKICAgIC8vIGFkZFJlZ2lvbnMoe3NvbWV0aGluZzogUmVnaW9uLmV4dGVuZCh7ZWw6ICIjc29tZVJlZ2lvbiJ9KSB9KTsKICAgIGFkZFJlZ2lvbnM6IGZ1bmN0aW9uKHJlZ2lvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JlZ2lvbk1hbmFnZXIuYWRkUmVnaW9ucyhyZWdpb25zKTsKICAgIH0sCiAgCiAgICAvLyBFbXB0eSBhbGwgcmVnaW9ucyBpbiB0aGUgYXBwLCB3aXRob3V0IHJlbW92aW5nIHRoZW0KICAgIGVtcHR5UmVnaW9uczogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmVtcHR5UmVnaW9ucygpOwogICAgfSwKICAKICAgIC8vIFJlbW92ZXMgYSByZWdpb24gZnJvbSB5b3VyIGFwcCwgYnkgbmFtZQogICAgLy8gQWNjZXB0cyB0aGUgcmVnaW9ucyBuYW1lCiAgICAvLyByZW1vdmVSZWdpb24oJ215UmVnaW9uJykKICAgIHJlbW92ZVJlZ2lvbjogZnVuY3Rpb24ocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLnJlbW92ZVJlZ2lvbihyZWdpb24pOwogICAgfSwKICAKICAgIC8vIFByb3ZpZGVzIGFsdGVybmF0aXZlIGFjY2VzcyB0byByZWdpb25zCiAgICAvLyBBY2NlcHRzIHRoZSByZWdpb24gbmFtZQogICAgLy8gZ2V0UmVnaW9uKCdtYWluJykKICAgIGdldFJlZ2lvbjogZnVuY3Rpb24ocmVnaW9uKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldChyZWdpb24pOwogICAgfSwKICAKICAgIC8vIEdldCBhbGwgdGhlIHJlZ2lvbnMgZnJvbSB0aGUgcmVnaW9uIG1hbmFnZXIKICAgIGdldFJlZ2lvbnM6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLl9yZWdpb25NYW5hZ2VyLmdldFJlZ2lvbnMoKTsKICAgIH0sCiAgCiAgICAvLyBDcmVhdGUgYSBtb2R1bGUsIGF0dGFjaGVkIHRvIHRoZSBhcHBsaWNhdGlvbgogICAgbW9kdWxlOiBmdW5jdGlvbihtb2R1bGVOYW1lcywgbW9kdWxlRGVmaW5pdGlvbikgewogIAogICAgICAvLyBPdmVyd3JpdGUgdGhlIG1vZHVsZSBjbGFzcyBpZiB0aGUgdXNlciBzcGVjaWZpZXMgb25lCiAgICAgIHZhciBNb2R1bGVDbGFzcyA9IE1hcmlvbmV0dGUuTW9kdWxlLmdldENsYXNzKG1vZHVsZURlZmluaXRpb24pOwogIAogICAgICAvLyBzbGljZSB0aGUgYXJncywgYW5kIGFkZCB0aGlzIGFwcGxpY2F0aW9uIG9iamVjdCBhcyB0aGUKICAgICAgLy8gZmlyc3QgYXJndW1lbnQgb2YgdGhlIGFycmF5CiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICBhcmdzLnVuc2hpZnQodGhpcyk7CiAgCiAgICAgIC8vIHNlZSB0aGUgTWFyaW9uZXR0ZS5Nb2R1bGUgb2JqZWN0IGZvciBtb3JlIGluZm9ybWF0aW9uCiAgICAgIHJldHVybiBNb2R1bGVDbGFzcy5jcmVhdGUuYXBwbHkoTW9kdWxlQ2xhc3MsIGFyZ3MpOwogICAgfSwKICAKICAgIC8vIEVuYWJsZSBlYXN5IG92ZXJyaWRpbmcgb2YgdGhlIGRlZmF1bHQgYFJlZ2lvbk1hbmFnZXJgCiAgICAvLyBmb3IgY3VzdG9taXplZCByZWdpb24gaW50ZXJhY3Rpb25zIGFuZCBidXNpbmVzcy1zcGVjaWZpYwogICAgLy8gdmlldyBsb2dpYyBmb3IgYmV0dGVyIGNvbnRyb2wgb3ZlciBzaW5nbGUgcmVnaW9ucy4KICAgIGdldFJlZ2lvbk1hbmFnZXI6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gbmV3IE1hcmlvbmV0dGUuUmVnaW9uTWFuYWdlcigpOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBpbml0aWFsaXplIHRoZSByZWdpb25zIHRoYXQgaGF2ZSBiZWVuIGRlZmluZWQgaW4gYQogICAgLy8gYHJlZ2lvbnNgIGF0dHJpYnV0ZSBvbiB0aGUgYXBwbGljYXRpb24gaW5zdGFuY2UKICAgIF9pbml0aWFsaXplUmVnaW9uczogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICB2YXIgcmVnaW9ucyA9IF8uaXNGdW5jdGlvbih0aGlzLnJlZ2lvbnMpID8gdGhpcy5yZWdpb25zKG9wdGlvbnMpIDogdGhpcy5yZWdpb25zIHx8IHt9OwogIAogICAgICB0aGlzLl9pbml0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICAvLyBFbmFibGUgdXNlcnMgdG8gZGVmaW5lIGByZWdpb25zYCBpbiBpbnN0YW5jZSBvcHRpb25zLgogICAgICB2YXIgb3B0aW9uUmVnaW9ucyA9IE1hcmlvbmV0dGUuZ2V0T3B0aW9uKG9wdGlvbnMsICdyZWdpb25zJyk7CiAgCiAgICAgIC8vIEVuYWJsZSByZWdpb24gb3B0aW9ucyB0byBiZSBhIGZ1bmN0aW9uCiAgICAgIGlmIChfLmlzRnVuY3Rpb24ob3B0aW9uUmVnaW9ucykpIHsKICAgICAgICBvcHRpb25SZWdpb25zID0gb3B0aW9uUmVnaW9ucy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgICB9CiAgCiAgICAgIC8vIE92ZXJ3cml0ZSBjdXJyZW50IHJlZ2lvbnMgd2l0aCB0aG9zZSBwYXNzZWQgaW4gb3B0aW9ucwogICAgICBfLmV4dGVuZChyZWdpb25zLCBvcHRpb25SZWdpb25zKTsKICAKICAgICAgdGhpcy5hZGRSZWdpb25zKHJlZ2lvbnMpOwogIAogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gc2V0IHVwIHRoZSByZWdpb24gbWFuYWdlcgogICAgX2luaXRSZWdpb25NYW5hZ2VyOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5fcmVnaW9uTWFuYWdlciA9IHRoaXMuZ2V0UmVnaW9uTWFuYWdlcigpOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuX3JlZ2lvbk1hbmFnZXIsICdiZWZvcmU6YWRkOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2JlZm9yZTphZGQ6cmVnaW9uJywgbmFtZSk7CiAgICAgIH0pOwogIAogICAgICB0aGlzLmxpc3RlblRvKHRoaXMuX3JlZ2lvbk1hbmFnZXIsICdhZGQ6cmVnaW9uJywgZnVuY3Rpb24obmFtZSwgcmVnaW9uKSB7CiAgICAgICAgdGhpc1tuYW1lXSA9IHJlZ2lvbjsKICAgICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ2FkZDpyZWdpb24nLCBuYW1lLCByZWdpb24pOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAnYmVmb3JlOnJlbW92ZTpyZWdpb24nLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6cmVtb3ZlOnJlZ2lvbicsIG5hbWUpOwogICAgICB9KTsKICAKICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLl9yZWdpb25NYW5hZ2VyLCAncmVtb3ZlOnJlZ2lvbicsIGZ1bmN0aW9uKG5hbWUsIHJlZ2lvbikgewogICAgICAgIGRlbGV0ZSB0aGlzW25hbWVdOwogICAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgncmVtb3ZlOnJlZ2lvbicsIG5hbWUsIHJlZ2lvbik7CiAgICAgIH0pOwogICAgfSwKICAKICAgIC8vIEludGVybmFsIG1ldGhvZCB0byBzZXR1cCB0aGUgV3JlcXIucmFkaW8gY2hhbm5lbAogICAgX2luaXRDaGFubmVsOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5jaGFubmVsTmFtZSA9IF8ucmVzdWx0KHRoaXMsICdjaGFubmVsTmFtZScpIHx8ICdnbG9iYWwnOwogICAgICB0aGlzLmNoYW5uZWwgPSBfLnJlc3VsdCh0aGlzLCAnY2hhbm5lbCcpIHx8IEJhY2tib25lLldyZXFyLnJhZGlvLmNoYW5uZWwodGhpcy5jaGFubmVsTmFtZSk7CiAgICAgIHRoaXMudmVudCA9IF8ucmVzdWx0KHRoaXMsICd2ZW50JykgfHwgdGhpcy5jaGFubmVsLnZlbnQ7CiAgICAgIHRoaXMuY29tbWFuZHMgPSBfLnJlc3VsdCh0aGlzLCAnY29tbWFuZHMnKSB8fCB0aGlzLmNoYW5uZWwuY29tbWFuZHM7CiAgICAgIHRoaXMucmVxcmVzID0gXy5yZXN1bHQodGhpcywgJ3JlcXJlcycpIHx8IHRoaXMuY2hhbm5lbC5yZXFyZXM7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QsCiAgCiAgICAvLyBQcm94eSBgZ2V0T3B0aW9uYCB0byBlbmFibGUgZ2V0dGluZyBvcHRpb25zIGZyb20gdGhpcyBvciB0aGlzLm9wdGlvbnMgYnkgbmFtZS4KICAgIGdldE9wdGlvbjogTWFyaW9uZXR0ZS5wcm94eUdldE9wdGlvbgogIH0pOwogIAogIC8vIENvcHkgdGhlIGBleHRlbmRgIGZ1bmN0aW9uIHVzZWQgYnkgQmFja2JvbmUncyBjbGFzc2VzCiAgTWFyaW9uZXR0ZS5BcHBsaWNhdGlvbi5leHRlbmQgPSBNYXJpb25ldHRlLmV4dGVuZDsKICAKICAvKiBqc2hpbnQgbWF4cGFyYW1zOiA5ICovCiAgCiAgLy8gTW9kdWxlCiAgLy8gLS0tLS0tCiAgCiAgLy8gQSBzaW1wbGUgbW9kdWxlIHN5c3RlbSwgdXNlZCB0byBjcmVhdGUgcHJpdmFjeSBhbmQgZW5jYXBzdWxhdGlvbiBpbgogIC8vIE1hcmlvbmV0dGUgYXBwbGljYXRpb25zCiAgTWFyaW9uZXR0ZS5Nb2R1bGUgPSBmdW5jdGlvbihtb2R1bGVOYW1lLCBhcHAsIG9wdGlvbnMpIHsKICAgIHRoaXMubW9kdWxlTmFtZSA9IG1vZHVsZU5hbWU7CiAgICB0aGlzLm9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgIC8vIEFsbG93IGZvciBhIHVzZXIgdG8gb3ZlcmlkZSB0aGUgaW5pdGlhbGl6ZQogICAgLy8gZm9yIGEgZ2l2ZW4gbW9kdWxlIGluc3RhbmNlLgogICAgdGhpcy5pbml0aWFsaXplID0gb3B0aW9ucy5pbml0aWFsaXplIHx8IHRoaXMuaW5pdGlhbGl6ZTsKICAKICAgIC8vIFNldCB1cCBhbiBpbnRlcm5hbCBzdG9yZSBmb3Igc3ViLW1vZHVsZXMuCiAgICB0aGlzLnN1Ym1vZHVsZXMgPSB7fTsKICAKICAgIHRoaXMuX3NldHVwSW5pdGlhbGl6ZXJzQW5kRmluYWxpemVycygpOwogIAogICAgLy8gU2V0IGFuIGludGVybmFsIHJlZmVyZW5jZSB0byB0aGUgYXBwCiAgICAvLyB3aXRoaW4gYSBtb2R1bGUuCiAgICB0aGlzLmFwcCA9IGFwcDsKICAKICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5pbml0aWFsaXplKSkgewogICAgICB0aGlzLmluaXRpYWxpemUobW9kdWxlTmFtZSwgYXBwLCB0aGlzLm9wdGlvbnMpOwogICAgfQogIH07CiAgCiAgTWFyaW9uZXR0ZS5Nb2R1bGUuZXh0ZW5kID0gTWFyaW9uZXR0ZS5leHRlbmQ7CiAgCiAgLy8gRXh0ZW5kIHRoZSBNb2R1bGUgcHJvdG90eXBlIHdpdGggZXZlbnRzIC8gbGlzdGVuVG8sIHNvIHRoYXQgdGhlIG1vZHVsZQogIC8vIGNhbiBiZSB1c2VkIGFzIGFuIGV2ZW50IGFnZ3JlZ2F0b3Igb3IgcHViL3N1Yi4KICBfLmV4dGVuZChNYXJpb25ldHRlLk1vZHVsZS5wcm90b3R5cGUsIEJhY2tib25lLkV2ZW50cywgewogIAogICAgLy8gQnkgZGVmYXVsdCBtb2R1bGVzIHN0YXJ0IHdpdGggdGhlaXIgcGFyZW50cy4KICAgIHN0YXJ0V2l0aFBhcmVudDogdHJ1ZSwKICAKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMgd2hlbiBleHRlbmRpbmcgTWFyaW9uZXR0ZS5Nb2R1bGUuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpIHt9LAogIAogICAgLy8gSW5pdGlhbGl6ZXIgZm9yIGEgc3BlY2lmaWMgbW9kdWxlLiBJbml0aWFsaXplcnMgYXJlIHJ1biB3aGVuIHRoZQogICAgLy8gbW9kdWxlJ3MgYHN0YXJ0YCBtZXRob2QgaXMgY2FsbGVkLgogICAgYWRkSW5pdGlhbGl6ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLmFkZChjYWxsYmFjayk7CiAgICB9LAogIAogICAgLy8gRmluYWxpemVycyBhcmUgcnVuIHdoZW4gYSBtb2R1bGUgaXMgc3RvcHBlZC4gVGhleSBhcmUgdXNlZCB0byB0ZWFyZG93bgogICAgLy8gYW5kIGZpbmFsaXplIGFueSB2YXJpYWJsZXMsIHJlZmVyZW5jZXMsIGV2ZW50cyBhbmQgb3RoZXIgY29kZSB0aGF0IHRoZQogICAgLy8gbW9kdWxlIGhhZCBzZXQgdXAuCiAgICBhZGRGaW5hbGl6ZXI6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5hZGQoY2FsbGJhY2spOwogICAgfSwKICAKICAgIC8vIFN0YXJ0IHRoZSBtb2R1bGUsIGFuZCBydW4gYWxsIG9mIGl0cyBpbml0aWFsaXplcnMKICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIC8vIFByZXZlbnQgcmUtc3RhcnRpbmcgYSBtb2R1bGUgdGhhdCBpcyBhbHJlYWR5IHN0YXJ0ZWQKICAgICAgaWYgKHRoaXMuX2lzSW5pdGlhbGl6ZWQpIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIHN0YXJ0IHRoZSBzdWItbW9kdWxlcyAoZGVwdGgtZmlyc3QgaGllcmFyY2h5KQogICAgICBfLmVhY2godGhpcy5zdWJtb2R1bGVzLCBmdW5jdGlvbihtb2QpIHsKICAgICAgICAvLyBjaGVjayB0byBzZWUgaWYgd2Ugc2hvdWxkIHN0YXJ0IHRoZSBzdWItbW9kdWxlIHdpdGggdGhpcyBwYXJlbnQKICAgICAgICBpZiAobW9kLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgCiAgICAgIC8vIHJ1biB0aGUgY2FsbGJhY2tzIHRvICJzdGFydCIgdGhlIGN1cnJlbnQgbW9kdWxlCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnYmVmb3JlOnN0YXJ0Jywgb3B0aW9ucyk7CiAgCiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLnJ1bihvcHRpb25zLCB0aGlzKTsKICAgICAgdGhpcy5faXNJbml0aWFsaXplZCA9IHRydWU7CiAgCiAgICAgIHRoaXMudHJpZ2dlck1ldGhvZCgnc3RhcnQnLCBvcHRpb25zKTsKICAgIH0sCiAgCiAgICAvLyBTdG9wIHRoaXMgbW9kdWxlIGJ5IHJ1bm5pbmcgaXRzIGZpbmFsaXplcnMgYW5kIHRoZW4gc3RvcCBhbGwgb2YKICAgIC8vIHRoZSBzdWItbW9kdWxlcyBmb3IgdGhpcyBtb2R1bGUKICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICAvLyBpZiB3ZSBhcmUgbm90IGluaXRpYWxpemVkLCBkb24ndCBib3RoZXIgZmluYWxpemluZwogICAgICBpZiAoIXRoaXMuX2lzSW5pdGlhbGl6ZWQpIHsgcmV0dXJuOyB9CiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSBmYWxzZTsKICAKICAgICAgdGhpcy50cmlnZ2VyTWV0aG9kKCdiZWZvcmU6c3RvcCcpOwogIAogICAgICAvLyBzdG9wIHRoZSBzdWItbW9kdWxlczsgZGVwdGgtZmlyc3QsIHRvIG1ha2Ugc3VyZSB0aGUKICAgICAgLy8gc3ViLW1vZHVsZXMgYXJlIHN0b3BwZWQgLyBmaW5hbGl6ZWQgYmVmb3JlIHBhcmVudHMKICAgICAgXy5lYWNoKHRoaXMuc3VibW9kdWxlcywgZnVuY3Rpb24obW9kKSB7IG1vZC5zdG9wKCk7IH0pOwogIAogICAgICAvLyBydW4gdGhlIGZpbmFsaXplcnMKICAgICAgdGhpcy5fZmluYWxpemVyQ2FsbGJhY2tzLnJ1bih1bmRlZmluZWQsIHRoaXMpOwogIAogICAgICAvLyByZXNldCB0aGUgaW5pdGlhbGl6ZXJzIGFuZCBmaW5hbGl6ZXJzCiAgICAgIHRoaXMuX2luaXRpYWxpemVyQ2FsbGJhY2tzLnJlc2V0KCk7CiAgICAgIHRoaXMuX2ZpbmFsaXplckNhbGxiYWNrcy5yZXNldCgpOwogIAogICAgICB0aGlzLnRyaWdnZXJNZXRob2QoJ3N0b3AnKTsKICAgIH0sCiAgCiAgICAvLyBDb25maWd1cmUgdGhlIG1vZHVsZSB3aXRoIGEgZGVmaW5pdGlvbiBmdW5jdGlvbiBhbmQgYW55IGN1c3RvbSBhcmdzCiAgICAvLyB0aGF0IGFyZSB0byBiZSBwYXNzZWQgaW4gdG8gdGhlIGRlZmluaXRpb24gZnVuY3Rpb24KICAgIGFkZERlZmluaXRpb246IGZ1bmN0aW9uKG1vZHVsZURlZmluaXRpb24sIGN1c3RvbUFyZ3MpIHsKICAgICAgdGhpcy5fcnVuTW9kdWxlRGVmaW5pdGlvbihtb2R1bGVEZWZpbml0aW9uLCBjdXN0b21BcmdzKTsKICAgIH0sCiAgCiAgICAvLyBJbnRlcm5hbCBtZXRob2Q6IHJ1biB0aGUgbW9kdWxlIGRlZmluaXRpb24gZnVuY3Rpb24gd2l0aCB0aGUgY29ycmVjdAogICAgLy8gYXJndW1lbnRzCiAgICBfcnVuTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24oZGVmaW5pdGlvbiwgY3VzdG9tQXJncykgewogICAgICAvLyBJZiB0aGVyZSBpcyBubyBkZWZpbml0aW9uIHNob3J0IGNpcmN1dCB0aGUgbWV0aG9kLgogICAgICBpZiAoIWRlZmluaXRpb24pIHsgcmV0dXJuOyB9CiAgCiAgICAgIC8vIGJ1aWxkIHRoZSBjb3JyZWN0IGxpc3Qgb2YgYXJndW1lbnRzIGZvciB0aGUgbW9kdWxlIGRlZmluaXRpb24KICAgICAgdmFyIGFyZ3MgPSBfLmZsYXR0ZW4oWwogICAgICAgIHRoaXMsCiAgICAgICAgdGhpcy5hcHAsCiAgICAgICAgQmFja2JvbmUsCiAgICAgICAgTWFyaW9uZXR0ZSwKICAgICAgICBCYWNrYm9uZS4kLCBfLAogICAgICAgIGN1c3RvbUFyZ3MKICAgICAgXSk7CiAgCiAgICAgIGRlZmluaXRpb24uYXBwbHkodGhpcywgYXJncyk7CiAgICB9LAogIAogICAgLy8gSW50ZXJuYWwgbWV0aG9kOiBzZXQgdXAgbmV3IGNvcGllcyBvZiBpbml0aWFsaXplcnMgYW5kIGZpbmFsaXplcnMuCiAgICAvLyBDYWxsaW5nIHRoaXMgbWV0aG9kIHdpbGwgd2lwZSBvdXQgYWxsIGV4aXN0aW5nIGluaXRpYWxpemVycyBhbmQKICAgIC8vIGZpbmFsaXplcnMuCiAgICBfc2V0dXBJbml0aWFsaXplcnNBbmRGaW5hbGl6ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5faW5pdGlhbGl6ZXJDYWxsYmFja3MgPSBuZXcgTWFyaW9uZXR0ZS5DYWxsYmFja3MoKTsKICAgICAgdGhpcy5fZmluYWxpemVyQ2FsbGJhY2tzID0gbmV3IE1hcmlvbmV0dGUuQ2FsbGJhY2tzKCk7CiAgICB9LAogIAogICAgLy8gaW1wb3J0IHRoZSBgdHJpZ2dlck1ldGhvZGAgdG8gdHJpZ2dlciBldmVudHMgd2l0aCBjb3JyZXNwb25kaW5nCiAgICAvLyBtZXRob2RzIGlmIHRoZSBtZXRob2QgZXhpc3RzCiAgICB0cmlnZ2VyTWV0aG9kOiBNYXJpb25ldHRlLnRyaWdnZXJNZXRob2QKICB9KTsKICAKICAvLyBDbGFzcyBtZXRob2RzIHRvIGNyZWF0ZSBtb2R1bGVzCiAgXy5leHRlbmQoTWFyaW9uZXR0ZS5Nb2R1bGUsIHsKICAKICAgIC8vIENyZWF0ZSBhIG1vZHVsZSwgaGFuZ2luZyBvZmYgdGhlIGFwcCBwYXJhbWV0ZXIgYXMgdGhlIHBhcmVudCBvYmplY3QuCiAgICBjcmVhdGU6IGZ1bmN0aW9uKGFwcCwgbW9kdWxlTmFtZXMsIG1vZHVsZURlZmluaXRpb24pIHsKICAgICAgdmFyIG1vZHVsZSA9IGFwcDsKICAKICAgICAgLy8gZ2V0IHRoZSBjdXN0b20gYXJncyBwYXNzZWQgaW4gYWZ0ZXIgdGhlIG1vZHVsZSBkZWZpbml0aW9uIGFuZAogICAgICAvLyBnZXQgcmlkIG9mIHRoZSBtb2R1bGUgbmFtZSBhbmQgZGVmaW5pdGlvbiBmdW5jdGlvbgogICAgICB2YXIgY3VzdG9tQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgICAgY3VzdG9tQXJncy5zcGxpY2UoMCwgMyk7CiAgCiAgICAgIC8vIFNwbGl0IHRoZSBtb2R1bGUgbmFtZXMgYW5kIGdldCB0aGUgbnVtYmVyIG9mIHN1Ym1vZHVsZXMuCiAgICAgIC8vIGkuZS4gYW4gZXhhbXBsZSBtb2R1bGUgbmFtZSBvZiBgRG9nZS5Xb3cuQW1hemVgIHdvdWxkCiAgICAgIC8vIHRoZW4gaGF2ZSB0aGUgcG90ZW50aWFsIGZvciAzIG1vZHVsZSBkZWZpbml0aW9ucy4KICAgICAgbW9kdWxlTmFtZXMgPSBtb2R1bGVOYW1lcy5zcGxpdCgnLicpOwogICAgICB2YXIgbGVuZ3RoID0gbW9kdWxlTmFtZXMubGVuZ3RoOwogIAogICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIGRlZmluaXRpb24gZm9yIHRoZSBsYXN0IG1vZHVsZSBpbiB0aGUgY2hhaW4KICAgICAgdmFyIG1vZHVsZURlZmluaXRpb25zID0gW107CiAgICAgIG1vZHVsZURlZmluaXRpb25zW2xlbmd0aCAtIDFdID0gbW9kdWxlRGVmaW5pdGlvbjsKICAKICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgcGFydHMgb2YgdGhlIG1vZHVsZSBkZWZpbml0aW9uCiAgICAgIF8uZWFjaChtb2R1bGVOYW1lcywgZnVuY3Rpb24obW9kdWxlTmFtZSwgaSkgewogICAgICAgIHZhciBwYXJlbnRNb2R1bGUgPSBtb2R1bGU7CiAgICAgICAgbW9kdWxlID0gdGhpcy5fZ2V0TW9kdWxlKHBhcmVudE1vZHVsZSwgbW9kdWxlTmFtZSwgYXBwLCBtb2R1bGVEZWZpbml0aW9uKTsKICAgICAgICB0aGlzLl9hZGRNb2R1bGVEZWZpbml0aW9uKHBhcmVudE1vZHVsZSwgbW9kdWxlLCBtb2R1bGVEZWZpbml0aW9uc1tpXSwgY3VzdG9tQXJncyk7CiAgICAgIH0sIHRoaXMpOwogIAogICAgICAvLyBSZXR1cm4gdGhlIGxhc3QgbW9kdWxlIGluIHRoZSBkZWZpbml0aW9uIGNoYWluCiAgICAgIHJldHVybiBtb2R1bGU7CiAgICB9LAogIAogICAgX2dldE1vZHVsZTogZnVuY3Rpb24ocGFyZW50TW9kdWxlLCBtb2R1bGVOYW1lLCBhcHAsIGRlZiwgYXJncykgewogICAgICB2YXIgb3B0aW9ucyA9IF8uZXh0ZW5kKHt9LCBkZWYpOwogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSB0aGlzLmdldENsYXNzKGRlZik7CiAgCiAgICAgIC8vIEdldCBhbiBleGlzdGluZyBtb2R1bGUgb2YgdGhpcyBuYW1lIGlmIHdlIGhhdmUgb25lCiAgICAgIHZhciBtb2R1bGUgPSBwYXJlbnRNb2R1bGVbbW9kdWxlTmFtZV07CiAgCiAgICAgIGlmICghbW9kdWxlKSB7CiAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSBpZiB3ZSBkb24ndCBoYXZlIG9uZQogICAgICAgIG1vZHVsZSA9IG5ldyBNb2R1bGVDbGFzcyhtb2R1bGVOYW1lLCBhcHAsIG9wdGlvbnMpOwogICAgICAgIHBhcmVudE1vZHVsZVttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgICAgICAvLyBzdG9yZSB0aGUgbW9kdWxlIG9uIHRoZSBwYXJlbnQKICAgICAgICBwYXJlbnRNb2R1bGUuc3VibW9kdWxlc1ttb2R1bGVOYW1lXSA9IG1vZHVsZTsKICAgICAgfQogIAogICAgICByZXR1cm4gbW9kdWxlOwogICAgfSwKICAKICAgIC8vICMjIE1vZHVsZSBDbGFzc2VzCiAgICAvLwogICAgLy8gTW9kdWxlIGNsYXNzZXMgY2FuIGJlIHVzZWQgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gdGhlIGRlZmluZSBwYXR0ZXJuLgogICAgLy8gVGhlIGV4dGVuZCBmdW5jdGlvbiBvZiBhIE1vZHVsZSBpcyBpZGVudGljYWwgdG8gdGhlIGV4dGVuZCBmdW5jdGlvbnMKICAgIC8vIG9uIG90aGVyIEJhY2tib25lIGFuZCBNYXJpb25ldHRlIGNsYXNzZXMuCiAgICAvLyBUaGlzIGFsbG93cyBtb2R1bGUgbGlmZWN5bGUgZXZlbnRzIGxpa2UgYG9uU3RhcnRgIGFuZCBgb25TdG9wYCB0byBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICBnZXRDbGFzczogZnVuY3Rpb24obW9kdWxlRGVmaW5pdGlvbikgewogICAgICB2YXIgTW9kdWxlQ2xhc3MgPSBNYXJpb25ldHRlLk1vZHVsZTsKICAKICAgICAgaWYgKCFtb2R1bGVEZWZpbml0aW9uKSB7CiAgICAgICAgcmV0dXJuIE1vZHVsZUNsYXNzOwogICAgICB9CiAgCiAgICAgIC8vIElmIGFsbCBvZiB0aGUgbW9kdWxlJ3MgZnVuY3Rpb25hbGl0eSBpcyBkZWZpbmVkIGluc2lkZSBpdHMgY2xhc3MsCiAgICAgIC8vIHRoZW4gdGhlIGNsYXNzIGNhbiBiZSBwYXNzZWQgaW4gZGlyZWN0bHkuIGBNeUFwcC5tb2R1bGUoIkZvbyIsIEZvb01vZHVsZSlgLgogICAgICBpZiAobW9kdWxlRGVmaW5pdGlvbi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNb2R1bGVDbGFzcykgewogICAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uOwogICAgICB9CiAgCiAgICAgIHJldHVybiBtb2R1bGVEZWZpbml0aW9uLm1vZHVsZUNsYXNzIHx8IE1vZHVsZUNsYXNzOwogICAgfSwKICAKICAgIC8vIEFkZCB0aGUgbW9kdWxlIGRlZmluaXRpb24gYW5kIGFkZCBhIHN0YXJ0V2l0aFBhcmVudCBpbml0aWFsaXplciBmdW5jdGlvbi4KICAgIC8vIFRoaXMgaXMgY29tcGxpY2F0ZWQgYmVjYXVzZSBtb2R1bGUgZGVmaW5pdGlvbnMgYXJlIGhlYXZpbHkgb3ZlcmxvYWRlZAogICAgLy8gYW5kIHN1cHBvcnQgYW4gYW5vbnltb3VzIGZ1bmN0aW9uLCBtb2R1bGUgY2xhc3MsIG9yIG9wdGlvbnMgb2JqZWN0CiAgICBfYWRkTW9kdWxlRGVmaW5pdGlvbjogZnVuY3Rpb24ocGFyZW50TW9kdWxlLCBtb2R1bGUsIGRlZiwgYXJncykgewogICAgICB2YXIgZm4gPSB0aGlzLl9nZXREZWZpbmUoZGVmKTsKICAgICAgdmFyIHN0YXJ0V2l0aFBhcmVudCA9IHRoaXMuX2dldFN0YXJ0V2l0aFBhcmVudChkZWYsIG1vZHVsZSk7CiAgCiAgICAgIGlmIChmbikgewogICAgICAgIG1vZHVsZS5hZGREZWZpbml0aW9uKGZuLCBhcmdzKTsKICAgICAgfQogIAogICAgICB0aGlzLl9hZGRTdGFydFdpdGhQYXJlbnQocGFyZW50TW9kdWxlLCBtb2R1bGUsIHN0YXJ0V2l0aFBhcmVudCk7CiAgICB9LAogIAogICAgX2dldFN0YXJ0V2l0aFBhcmVudDogZnVuY3Rpb24oZGVmLCBtb2R1bGUpIHsKICAgICAgdmFyIHN3cDsKICAKICAgICAgaWYgKF8uaXNGdW5jdGlvbihkZWYpICYmIChkZWYucHJvdG90eXBlIGluc3RhbmNlb2YgTWFyaW9uZXR0ZS5Nb2R1bGUpKSB7CiAgICAgICAgc3dwID0gbW9kdWxlLmNvbnN0cnVjdG9yLnByb3RvdHlwZS5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAKICAgICAgaWYgKF8uaXNPYmplY3QoZGVmKSkgewogICAgICAgIHN3cCA9IGRlZi5zdGFydFdpdGhQYXJlbnQ7CiAgICAgICAgcmV0dXJuIF8uaXNVbmRlZmluZWQoc3dwKSA/IHRydWUgOiBzd3A7CiAgICAgIH0KICAKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAogIAogICAgX2dldERlZmluZTogZnVuY3Rpb24oZGVmKSB7CiAgICAgIGlmIChfLmlzRnVuY3Rpb24oZGVmKSAmJiAhKGRlZi5wcm90b3R5cGUgaW5zdGFuY2VvZiBNYXJpb25ldHRlLk1vZHVsZSkpIHsKICAgICAgICByZXR1cm4gZGVmOwogICAgICB9CiAgCiAgICAgIGlmIChfLmlzT2JqZWN0KGRlZikpIHsKICAgICAgICByZXR1cm4gZGVmLmRlZmluZTsKICAgICAgfQogIAogICAgICByZXR1cm4gbnVsbDsKICAgIH0sCiAgCiAgICBfYWRkU3RhcnRXaXRoUGFyZW50OiBmdW5jdGlvbihwYXJlbnRNb2R1bGUsIG1vZHVsZSwgc3RhcnRXaXRoUGFyZW50KSB7CiAgICAgIG1vZHVsZS5zdGFydFdpdGhQYXJlbnQgPSBtb2R1bGUuc3RhcnRXaXRoUGFyZW50ICYmIHN0YXJ0V2l0aFBhcmVudDsKICAKICAgICAgaWYgKCFtb2R1bGUuc3RhcnRXaXRoUGFyZW50IHx8ICEhbW9kdWxlLnN0YXJ0V2l0aFBhcmVudElzQ29uZmlndXJlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogIAogICAgICBtb2R1bGUuc3RhcnRXaXRoUGFyZW50SXNDb25maWd1cmVkID0gdHJ1ZTsKICAKICAgICAgcGFyZW50TW9kdWxlLmFkZEluaXRpYWxpemVyKGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICBpZiAobW9kdWxlLnN0YXJ0V2l0aFBhcmVudCkgewogICAgICAgICAgbW9kdWxlLnN0YXJ0KG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgCgogIHJldHVybiBNYXJpb25ldHRlOwp9KSk7CgovKiEKICogVGFibGVsaW5nIHYwLjEuMQogKiBDb3B5cmlnaHQgKGMpIDIwMTItMjAxNCBTaW1vbiBPdWxldmF5IChBbHBoYSBIeWRyYWUpIDxoeWRyYWUuYWxwaGFAZ21haWwuY29tPgogKiBEaXN0cmlidXRlZCB1bmRlciBNSVQgbGljZW5zZQogKiBodHRwczovL2dpdGh1Yi5jb20vQWxwaGFIeWRyYWUvdGFibGVsaW5nCiAqLwpCYWNrYm9uZS5UYWJsZWxpbmcgPSBUYWJsZWxpbmcgPSAoZnVuY3Rpb24oQmFja2JvbmUsIF8sICQpewoKICB2YXIgVGFibGVsaW5nID0gewogICAgdmVyc2lvbiA6ICIwLjEuMSIKICB9OwoKLy8gVGFibGVsaW5nCi8vIC0tLS0tLS0tLQovLwovLyBBIHRhYmxlbGluZyB0YWJsZSBpcyBhIE1hcmlvbmV0dGUgbGF5b3V0IHdoaWNoIGZldGNoZXMgZGF0YQovLyBmcm9tIGEgQmFja2JvbmUgY29sbGVjdGlvbi4gSXQgaXMgY29udHJvbGxlZCB3aXRoIGFuIEV2ZW50QWdncmVnYXRvci4KVGFibGVsaW5nLlRhYmxlID0gQmFja2JvbmUuTWFyaW9uZXR0ZS5MYXlvdXRWaWV3LmV4dGVuZCh7CgogIGNsYXNzTmFtZTogJ3RhYmxlbGluZycsCgogIC8vIERlZmF1bHQgdGFibGUgb3B0aW9ucyBjYW4gYmUgb3ZlcnJpZGVuIGJ5IHN1YmNsYXNzZXMuCiAgY29uZmlnOiB7CiAgICBwYWdlOiAxCiAgfSwKCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgaWYgKCF0aGlzLmdldENvbGxlY3Rpb24odGhpcy5nZXRSZXNvdXJjZSgpKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoJ01pc3NpbmcgY29sbGVjdGlvbjsgcGFzcyBpdCB0byB0aGUgY29uc3RydWN0b3Igb3Igb3ZlcnJpZGUgI2dldENvbGxlY3Rpb24nKTsKICAgIH0KCiAgICAvLyBUYWJsZSBvcHRpb25zIGNhbiBhbHNvIGJlIG92ZXJyaWRlbiBmb3IgZWFjaCBpbnN0YW5jZSBhdCBjb25zdHJ1Y3Rpb24uCiAgICB0aGlzLmNvbmZpZyA9IF8uZXh0ZW5kKF8uY2xvbmUodGhpcy5jb25maWcgfHwge30pLCBfLnJlc3VsdChvcHRpb25zLCAnY29uZmlnJykgfHwge30pOwoKICAgIC8vIFdlIHVzZSBhbiBldmVudCBhZ2dyZWdhdG9yIHRvIG1hbmFnZSB0aGUgbGF5b3V0IGFuZCBpdHMgY29tcG9uZW50cy4KICAgIC8vIFlvdSBjYW4gdXNlIHlvdXIgb3duIGJ5IHBhc3NpbmcgYSBgdmVudGAgb3B0aW9uLgogICAgdGhpcy52ZW50ID0gb3B0aW9ucy52ZW50IHx8IG5ldyBCYWNrYm9uZS5XcmVxci5FdmVudEFnZ3JlZ2F0b3IoKTsKCiAgICB0aGlzLmZldGNoT3B0aW9ucyA9IF8uZXh0ZW5kKF8uY2xvbmUodGhpcy5mZXRjaE9wdGlvbnMgfHwge30pLCBfLnJlc3VsdChvcHRpb25zLCAnZmV0Y2hPcHRpb25zJykgfHwge30pOwoKICAgIGlmICh0eXBlb2Yob3B0aW9ucy5hdXRvVXBkYXRlKSAhPSAndW5kZWZpbmVkJykgewogICAgICB0aGlzLmF1dG9VcGRhdGUgPSBvcHRpb25zLmF1dG9VcGRhdGU7CiAgICB9CgogICAgaWYgKHR5cGVvZih0aGlzLmF1dG9VcGRhdGUpID09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMuYXV0b1VwZGF0ZSA9IHRydWU7CiAgICB9CgogICAgLy8gQ29tcG9uZW50cyBzaG91bGQgdHJpZ2dlciB0aGUgYHRhYmxlOnVwZGF0ZWAgZXZlbnQgdG8gdXBkYXRlCiAgICAvLyB0aGUgdGFibGUgKGUuZy4gY2hhbmdlIHBhZ2Ugc2l6ZSwgc29ydCkgYW5kIGZldGNoIHRoZSBuZXcgZGF0YS4KICAgIHRoaXMudmVudC5vbigndGFibGU6dXBkYXRlJywgdGhpcy5vblVwZGF0ZSwgdGhpcyk7CgogICAgdGhpcy5vbmNlKCdyZW5kZXInLCB0aGlzLnNldHVwLCB0aGlzKTsKCiAgICBpZiAodHlwZW9mKHRoaXMuaW5pdGlhbGl6ZVRhYmxlKSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZVRhYmxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIC8vIENhbGxlZCBvbmNlIHJlbmRlcmluZyBpcyBjb21wbGV0ZS4gQnkgZGVmYXVsdCwgaXQgdXBkYXRlcyB0aGUgdGFibGUuCiAgc2V0dXA6IGZ1bmN0aW9uKCkgewogICAgdGhpcy52ZW50VHJpZ2dlcigndGFibGU6c2V0dXAnLCB0aGlzLmNvbmZpZyk7CiAgICBpZiAodGhpcy5hdXRvVXBkYXRlKSB7CiAgICAgIHRoaXMudmVudFRyaWdnZXIoJ3RhYmxlOnVwZGF0ZScpOwogICAgfQogIH0sCgogIGdldFJlc291cmNlOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLmNvbGxlY3Rpb24gfHwgdGhpcy5tb2RlbDsKICB9LAoKICAvLyBTdWJjbGFzc2VzIG11c3QgcmV0dXJuIHRoZSBCYWNrYm9uZS5Db2xsZWN0aW9uIHVzZWQgdG8gZmV0Y2ggZGF0YS4KICBnZXRDb2xsZWN0aW9uOiBmdW5jdGlvbihyZXNvdXJjZSkgewogICAgcmV0dXJuIHRoaXMuY29sbGVjdGlvbjsKICB9LAoKICAvLyAjIyMgUmVmcmVzaGluZyB0aGUgdGFibGUKICB1cGRhdGU6IGZ1bmN0aW9uKGNvbmZpZywgb3B0aW9ucykgewogICAgdGhpcy52ZW50VHJpZ2dlcigndGFibGU6dXBkYXRlJywgY29uZmlnLCBvcHRpb25zKTsKICB9LAoKICBvblVwZGF0ZTogZnVuY3Rpb24oY29uZmlnLCBvcHRpb25zKSB7CgogICAgXy5lYWNoKGNvbmZpZyB8fCB7fSwgXy5iaW5kKHRoaXMudXBkYXRlVmFsdWUsIHRoaXMpKTsKCiAgICAvLyBTZXQgdGhlIGByZWZyZXNoYCBvcHRpb24gdG8gZmFsc2UgdG8gdXBkYXRlIHRoZSB0YWJsZSBjb25maWd1cmF0aW9uCiAgICAvLyB3aXRob3V0IHJlZnJlc2hpbmcuCiAgICBpZiAoIW9wdGlvbnMgfHwgdHlwZW9mKG9wdGlvbnMucmVmcmVzaCkgPT0gJ3VuZGVmaW5lZCcgfHwgb3B0aW9ucy5yZWZyZXNoKSB7CiAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgfQogIH0sCgogIHVwZGF0ZVZhbHVlOiBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICBpZiAodmFsdWUgJiYgdmFsdWUudG9TdHJpbmcoKS5sZW5ndGgpIHsKICAgICAgdGhpcy5jb25maWdba2V5XSA9IHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgLy8gQmxhbmsgdmFsdWVzIGFyZSBkZWxldGVkIHRvIGF2b2lkIHNlbmRpbmcgdGhlbSBpbiBhamF4IHJlcXVlc3RzLgogICAgICBkZWxldGUgdGhpcy5jb25maWdba2V5XTsKICAgIH0KICB9LAoKICByZWZyZXNoOiBmdW5jdGlvbigpIHsKCiAgICAvLyBZb3UgY2FuIHByb3ZpZGUgYGZldGNoT3B0aW9uc2AgdG8gYWRkIHByb3BlcnRpZXMgdG8gdGhlCiAgICAvLyBmZXRjaCByZXF1ZXN0LgogICAgLy8KICAgIC8vICAgICB2YXIgTXlUYWJsZSA9IFRhYmxlbGluZy5UYWJsZS5leHRlbmQoewogICAgLy8gICAgICAgZmV0Y2hPcHRpb25zOiB7CiAgICAvLyAgICAgICAgIHR5cGU6ICdQT1NUJyAvLyBmZXRjaCBkYXRhIHdpdGggUE9TVAogICAgLy8gICAgICAgfQogICAgLy8gICAgIH0pOwogICAgLy8KICAgIC8vICAgICAvLyBZb3UgY2FuIGFsc28gb3ZlcnJpZGUgZm9yIGVhY2ggaW5zdGFuY2UuCiAgICAvLyAgICAgbmV3IE15VGFibGUoewogICAgLy8gICAgICAgZmV0Y2hPcHRpb25zOiB7CiAgICAvLyAgICAgICAgIHR5cGU6ICdHRVQnCiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgfSk7CiAgICB2YXIgb3B0aW9ucyA9IF8uY2xvbmUodGhpcy5mZXRjaE9wdGlvbnMpOwogICAgb3B0aW9ucy5kYXRhID0gdGhpcy5yZXF1ZXN0RGF0YSgpOwogICAgb3B0aW9ucy5zdWNjZXNzID0gXy5iaW5kKHRoaXMucHJvY2Vzc1Jlc3BvbnNlLCB0aGlzKTsKICAgIG9wdGlvbnMucmVzZXQgPSB0cnVlOwoKICAgIC8vIGB0YWJsZTpyZWZyZXNoaW5nYCBpcyB0cmlnZ2VyZWQgZXZlcnkgdGltZSBuZXcgZGF0YSBpcyBiZWluZyBmZXRjaGVkLgogICAgLy8gVGhlIGZpcnN0IGFyZ3VtZW50IGlzIHRoZSByZXF1ZXN0IGRhdGEuCiAgICB0aGlzLnZlbnRUcmlnZ2VyKCd0YWJsZTpyZWZyZXNoaW5nJywgb3B0aW9ucy5kYXRhKTsKCiAgICB0aGlzLmdldFJlc291cmNlKCkuZmV0Y2gob3B0aW9ucyk7CiAgfSwKCiAgLy8gIyMjIFJlcXVlc3QKICByZXF1ZXN0RGF0YTogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5jb25maWc7CiAgfSwKCiAgLy8gIyMjIFJlc3BvbnNlCiAgcHJvY2Vzc1Jlc3BvbnNlOiBmdW5jdGlvbihyZXNvdXJjZSwgcmVzcG9uc2UpIHsKCiAgICB0aGlzLmNvbmZpZy5sZW5ndGggPSB0aGlzLmdldENvbGxlY3Rpb24ocmVzb3VyY2UpLmxlbmd0aDsKCiAgICAvLyBUYWJsZWxpbmcgZXhwZWN0cyB0aGUgcmVzcG9uc2UgZnJvbSBhIGZldGNoIHRvIGhhdmUgYSBgdG90YWxgIHByb3BlcnR5CiAgICAvLyB3aGljaCBpcyB0aGUgdG90YWwgbnVtYmVyIG9mIGl0ZW1zIChub3QganVzdCBpbiB0aGUgY3VycmVudCBwYWdlKS4KICAgIHRoaXMuY29uZmlnLnRvdGFsID0gcmVzcG9uc2UudG90YWw7CgogICAgLy8gVGhlIHNlcnZlciBtYXkgb3ZlcnJpZGUgdGhlIGBwYWdlYCBwcm9wZXJ0eSwgZm9yIGV4YW1wbGUgaWYgdGhlCiAgICAvLyByZXF1ZXN0ZWQgcGFnZSB3YXMgb3V0c2lkZSB0aGUgcmFuZ2Ugb2YgYXZhaWxhYmxlIHBhZ2VzLgogICAgaWYgKHJlc3BvbnNlLnBhZ2UpIHsKICAgICAgdGhpcy5jb25maWcucGFnZSA9IHJlc3BvbnNlLnBhZ2U7CiAgICB9CgogICAgLy8gYHRhYmxlbGluZzpyZWZyZXNoZWRgIGlzIHRyaWdnZXJlZCBhZnRlciBldmVyeSByZWZyZXNoLiBUaGUgZmlyc3QgYXJndW1lbnQKICAgIC8vIGlzIHRoZSBjdXJyZW50IHRhYmxlIGNvbmZpZ3VyYXRpb24gd2l0aCB0aGUgZm9sbG93aW5nIGFkZGl0aW9uYWwgbWV0YSBkYXRhOgogICAgLy8KICAgIC8vICogYHRvdGFsYCAtIHRoZSB0b3RhbCBudW1iZXIgb2YgaXRlbXMKICAgIC8vICogYGxlbmd0aGAgLSB0aGUgbnVtYmVyIG9mIGl0ZW1zIGluIHRoZSBjdXJyZW50IHBhZ2UKICAgIHRoaXMudmVudFRyaWdnZXIoJ3RhYmxlOnJlZnJlc2hlZCcsIHRoaXMuY29uZmlnKTsKICB9LAoKICAvLyBUcmlnZ2VycyBhbiBldmVudCBpbiB0aGUgZXZlbnQgYWdncmVnYXRvci4gSWYgYFRhYmxlbGluZy5kZWJ1Z2AgaXMgc2V0LCBpdCBhbHNvCiAgLy8gbG9ncyB0aGUgZXZlbnQgYW5kIGl0cyBhcmd1bWVudHMuCiAgdmVudFRyaWdnZXI6IGZ1bmN0aW9uKCkgewoKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKICAgIGlmIChUYWJsZWxpbmcuZGVidWcpIHsKICAgICAgY29uc29sZS5sb2coXy5maXJzdChhcmdzKSArICcgLSAnICsgSlNPTi5zdHJpbmdpZnkoYXJncy5zbGljZSgxKSkpOwogICAgfQoKICAgIHRoaXMudmVudC50cmlnZ2VyLmFwcGx5KHRoaXMudmVudCwgYXJncyk7CiAgfQp9KTsKCi8vIFRhYmxlbGluZy5Db2xsZWN0aW9uCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vCi8vIFRhYmxlbGluZyBleHBlY3RzIGZldGNoIHJlc3BvbnNlcyB0byBoYXZlIGEgYHRvdGFsYCBwcm9wZXJ0eSBpbiBhZGRpdGlvbgovLyB0byB0aGUgbW9kZWwgZGF0YS4gWW91IGNhbiBleHRlbmQgdGhpcyBCYWNrYm9uZS5Db2xsZWN0aW9uIHN1YmNsYXNzIHdoaWNoCi8vIGV4cGVjdHMgdGhlIGZvbGxvd2luZyByZXNwb25zZSBmb3JtYXQ6Ci8vCi8vICAgICB7Ci8vICAgICAgICJ0b3RhbCI6IDEyLAovLyAgICAgICAiZGF0YSI6IFsKLy8gICAgICAgICB7IC8qIC4uLiBtb2RlbCBkYXRhIC4uLiAqLyB9LAovLyAgICAgICAgIHsgLyogLi4uIG1vZGVsIGRhdGEgLi4uICovIH0KLy8gICAgICAgXQovLyAgICAgfQpUYWJsZWxpbmcuQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKCiAgcGFyc2U6IGZ1bmN0aW9uKHJlc3BvbnNlKSB7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YTsKICB9Cn0pOwoKLy8gSW1wbGVtZW50YXRpb25zCi8vIC0tLS0tLS0tLS0tLS0tLQovLwovLyA8YSBocmVmPSJ0YWJsZWxpbmcuYm9vdHN0cmFwLmh0bWwiPnRhYmxlbGluZy5ib290c3RyYXA8L2E+IHByb3ZpZGVzIHZpZXdzIHN0eWxlZAovLyB3aXRoIFtUd2l0dGVyIEJvb3RzdHJhcF0oaHR0cDovL3R3aXR0ZXIuZ2l0aHViLmNvbS9ib290c3RyYXAvKSBjbGFzc2VzLgoKLy8gVGFibGVsaW5nLk1vZHVsYXIKLy8gLS0tLS0tLS0tLS0tLS0tLS0KLy8KLy8gVGFibGVsaW5nIHN1YmNsYXNzIHdoaWNoIHNwbGl0cyBmdW5jdGlvbmFsaXR5IGludG8gKm1vZHVsZXMqCi8vIGFuZCBoYW5kbGVzIHJlbmRlcmluZy4KVGFibGVsaW5nLk1vZHVsYXIgPSBUYWJsZWxpbmcuVGFibGUuZXh0ZW5kKHsKCiAgLy8gVGhlIGxpc3Qgb2YgbW9kdWxlIG5hbWVzIG11c3QgYmUgc3BlY2lmaWVkIGJ5IHN1YmNsYXNzZXMuCiAgbW9kdWxlczogW10sCgogIC8vIE1vZHVsZXMgYXJlIHNldCB1cCBhZnRlciByZW5kZXJpbmcsIGJlZm9yZSByZWZyZXNoaW5nLgogIHNldHVwOiBmdW5jdGlvbigpIHsKCiAgICB0aGlzLm1vZHVsZVZpZXdzID0ge307CiAgICBfLmVhY2godGhpcy5tb2R1bGVzLCB0aGlzLnNldHVwTW9kdWxlLCB0aGlzKTsKCiAgICBUYWJsZWxpbmcuVGFibGUucHJvdG90eXBlLnNldHVwLmNhbGwodGhpcyk7CiAgfSwKCiAgLy8gIyMjIE1vZHVsZXMKICAvLyBFYWNoIG1vZHVsZSBpcyBpZGVudGlmaWVkIGJ5IGEgbmFtZSwgZm9yIGV4YW1wbGUgYHBhZ2VTaXplYC4KICBzZXR1cE1vZHVsZTogZnVuY3Rpb24obmFtZSkgewoKICAgIC8vIFRoZSBsYXlvdXQgbXVzdCBoYXZlIGEgcmVnaW9uIG5hbWVkIGFmdGVyIHRoZSBtb2R1bGUsIGUuZy4gYHBhZ2VTaXplUmVnaW9uYC4KICAgIHZhciByZWdpb24gPSBuYW1lICsgJ1JlZ2lvbic7CgogICAgLy8gSXQgbXVzdCBoYXZlIGEgdmlldyBjbGFzcywgZS5nLiBgcGFnZVNpemVWaWV3YCwgd2hpY2ggd2lsbCBiZSBzaG93biBpbnRvCiAgICAvLyB0aGUgcmVnaW9uLgogICAgdmFyIHZpZXdDbGFzcyA9IHRoaXNbbmFtZSArICdWaWV3J107CgogICAgLy8gV2hlbiBpbnN0YW50aWF0ZWQsIHRoZSB2aWV3IGNsYXNzIHdpbGwgYmUgcGFzc2VkIHRoZSBldmVudAogICAgLy8gYWdncmVnYXRvciBhcyB0aGUgYHZlbnRgIG9wdGlvbi4gQWRkaXRpb25hbCBvcHRpb25zIGNhbiBiZQogICAgLy8gZ2l2ZW4gbmFtZWQgYWZ0ZXIgdGhlIHZpZXcgY2xhc3MsIGUuZy4gYHBhZ2VTaXplVmlld09wdGlvbnNgLgogICAgdmFyIG9wdGlvbnMgPSBfLmV4dGVuZCh0aGlzLmdldE1vZHVsZU9wdGlvbnMobmFtZSksIHsgdmVudDogdGhpcy52ZW50IH0pOwoKICAgIC8vIFRoZSBjb2xsZWN0aW9uIGlzIGFsc28gcGFzc2VkIHRvIHZpZXcgY2xhc3Nlcy4KICAgIF8uZGVmYXVsdHMob3B0aW9ucywgeyBjb2xsZWN0aW9uOiB0aGlzLmdldENvbGxlY3Rpb24odGhpcy5nZXRSZXNvdXJjZSgpKSB9KTsKCiAgICB2YXIgdmlldyA9IG5ldyB2aWV3Q2xhc3Mob3B0aW9ucyk7CgogICAgLy8gTW9kdWxlIHZpZXcgaW5zdGFuY2VzIGFyZSBzdG9yZWQgYnkgbmFtZSBpbiB0aGUgYG1vZHVsZVZpZXdzYCBwcm9wZXJ0eQogICAgLy8gZm9yIGZ1dHVyZSByZWZlcmVuY2UuCiAgICB0aGlzLm1vZHVsZVZpZXdzW25hbWVdID0gdmlldzsKCiAgICB0aGlzW3JlZ2lvbl0uc2hvdyh2aWV3KTsKICAgIHJldHVybiB2aWV3OwogIH0sCgogIC8vIEJ5IGRlZmF1bHQgdGhlIGNvbGxlY3Rpb24gaXMgdGhlIG9uZSBnaXZlbiBhdCBjb25zdHJ1Y3Rpb24uCiAgLy8gT3RoZXJ3aXNlLCBhIG1vZHVsYXIgdGFibGUgZXhwZWN0cyBhIGB0YWJsZWAgbW9kdWxlIHdoaWNoCiAgLy8gc2hvdWxkIGhhdmUgYSBjb2xsZWN0aW9uIChlLmcuIGEgTWFyaW9uZXR0ZSBDb21wb3NpdGVWaWV3IG9yCiAgLy8gQ29sbGVjdGlvblZpZXcpLiBJZiB5b3VyIHN1YmNsYXNzIGRvZXMgbm90IGhhdmUgZWl0aGVyLCBpdAogIC8vIHNob3VsZCBvdmVycmlkZSB0aGlzIG1ldGhvZCB0byByZXR1cm4gdGhlIEJhY2tib25lLkNvbGxlY3Rpb24KICAvLyB1c2VkIHRvIGZldGNoIHRhYmxlIGRhdGEuCiAgZ2V0Q29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5jb2xsZWN0aW9uIHx8ICh0aGlzLm1vZHVsZVZpZXdzICYmIHRoaXMubW9kdWxlVmlld3MudGFibGUgPyB0aGlzLm1vZHVsZVZpZXdzLnRhYmxlLmNvbGxlY3Rpb24gOiB1bmRlZmluZWQpOwogIH0sCgogIGdldE1vZHVsZU9wdGlvbnM6IGZ1bmN0aW9uKG5hbWUpIHsKICAgIHJldHVybiBfLnJlc3VsdCh0aGlzLCBuYW1lICsgJ1ZpZXdPcHRpb25zJykgfHwge307CiAgfQp9KTsKCi8vICMjIyBFeGFtcGxlCi8vIFRoaXMgaXMgaG93IGEgYFBhZ2VTaXplVmlld2AgbW9kdWxlIG1pZ2h0IGJlIHJlZ2lzdGVyZWQgaW4gYSBzdWJjbGFzczoKLy8KLy8gICAgIHZhciBNeVRhYmxlID0gVGFibGVsaW5nLk1vZHVsYXIuZXh0ZW5kKHsKLy8KLy8gICAgICAgbW9kdWxlczogWyAncGFnZVNpemUnIF0sCi8vCi8vICAgICAgIHBhZ2VTaXplVmlldzogUGFnZVNpemVWaWV3LAovLyAgICAgICBwYWdlU2l6ZVZpZXdPcHRpb25zOiB7Ci8vICAgICAgICAgY2hpbGRWaWV3OiBQYWdlU2l6ZUl0ZW0KLy8gICAgICAgfSwKLy8KLy8gICAgICAgcmVnaW9uczogewovLyAgICAgICAgIHBhZ2VTaXplUmVnaW9uOiAnLnBhZ2VTaXplJwovLyAgICAgICB9Ci8vICAgICB9KTsKCi8vIFRhYmxlbGluZy5Nb2R1bGUKLy8gLS0tLS0tLS0tLS0tLS0tLQovLwovLyBBIG1vZHVsZSBpcyBhbiBpdGVtIHZpZXcgdGhhdCBpcyBhdXRvbWF0aWNhbGx5IGJvdW5kIHRvIHRoZSB0YWJsZSdzCi8vIGV2ZW50IGFnZ3JlZ2F0b3IuClRhYmxlbGluZy5Nb2R1bGUgPSBCYWNrYm9uZS5NYXJpb25ldHRlLkl0ZW1WaWV3LmV4dGVuZCh7CgogIGkxOG46IHt9LAogIHRlbXBsYXRlSGVscGVyczogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5pMThuOwogIH0sCgogIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCiAgICB0aGlzLnZlbnQgPSBvcHRpb25zLnZlbnQ7CgogICAgLy8gVGhlIGBzZXR1cGAgbWV0aG9kIG9mIHRoZSB2aWV3IGlzIGNhbGxlZCB3aGVuIHRoZSB0YWJsZQogICAgLy8gaXMgZmlyc3Qgc2V0IHVwLgogICAgdGhpcy52ZW50Lm9uKCd0YWJsZTpzZXR1cCcsIHRoaXMuc2V0dXAsIHRoaXMpOwoKICAgIC8vIFRoZSBgcmVmcmVzaGAgbWV0aG9kIG9mIHRoZSB2aWV3IGlzIGNhbGxlZCBldmVyeSB0aW1lIHRoZSB0YWJsZQogICAgLy8gaXMgcmVmcmVzaGVkLgogICAgdGhpcy52ZW50Lm9uKCd0YWJsZTpyZWZyZXNoZWQnLCB0aGlzLnJlZnJlc2gsIHRoaXMpOwoKICAgIHRoaXMuaTE4biA9IF8uY2xvbmUob3B0aW9ucy5pMThuIHx8IHRoaXMuaTE4bik7CgogICAgaWYgKHR5cGVvZih0aGlzLmluaXRpYWxpemVNb2R1bGUpID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5pbml0aWFsaXplTW9kdWxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIC8vIENhbGwgYHVwZGF0ZWAgdG8gdHJpZ2dlciBhbiB1cGRhdGUgb2YgdGhlIHRhYmxlLgogIHVwZGF0ZTogZnVuY3Rpb24oKSB7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgdGhpcy5jb25maWcoKSk7CiAgfSwKCiAgLy8gSW1wbGVtZW50YXRpb25zIHNob3VsZCBvdmVycmlkZSB0aGlzIHRvIHNldCBpbml0aWFsIHZhbHVlcy4KICBzZXR1cDogZnVuY3Rpb24oY29uZmlnKSB7CiAgfSwKCiAgLy8gSW1wbGVtZW50YXRpb25zIHNob3VsZCBvdmVycmlkZSB0aGlzIHRvIHN0YXkgdXAgdG8gZGF0ZSB3aXRoCiAgLy8gdGhlIHRhYmxlIHN0YXRlLgogIHJlZnJlc2g6IGZ1bmN0aW9uKGNvbmZpZykgewogIH0sCgogIC8vIE5ldyB0YWJsZSBjb25maWd1cmF0aW9uIHRvIGJlIHNlbnQgb24gdXBkYXRlcy4gRm9yIGV4YW1wbGUsCiAgLy8gYSBwYWdlIHNpemUgdmlldyBtaWdodCB1cGRhdGUgdGhlIGBwYWdlU2l6ZWAgcHJvcGVydHkuCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7fTsKICB9Cn0pOwoKLy8gVGFibGVsaW5nLkZpZWxkTW9kdWxlCi8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLwovLyBBIGJhc2ljIG1vZHVsZSB3aXRoIGEgc2luZ2xlIGZvcm0gZmllbGQuIEl0IGNvbWVzIHdpdGggc2Vuc2libGUKLy8gZGVmYXVsdHMgYW5kIG9ubHkgcmVxdWlyZXMgYSBgbmFtZWAgYW5kIGEgYHRlbXBsYXRlYCBwYXJhbWV0ZXIuClRhYmxlbGluZy5GaWVsZE1vZHVsZSA9IFRhYmxlbGluZy5Nb2R1bGUuZXh0ZW5kKHsKCiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykgewogICAgaWYgKCFfLmlzU3RyaW5nKHRoaXMubmFtZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYWJsZWxpbmcgbW9kdWxlIG11c3QgaGF2ZSBhIG5hbWUgcHJvcGVydHkuIik7CiAgICB9CgogICAgaWYgKCF0aGlzLnVpKSB7CiAgICAgIHRoaXMudWkgPSB7fTsKICAgIH0KICAgIC8vIFRoZSBuYW1lIGF0dHJpYnV0ZSBvZiB0aGUgZm9ybSBmaWVsZCBpcyB0aGUgc2FtZSBhcyB0aGUKICAgIC8vIG1vZHVsZSdzLCBlLmcuIGBwYWdlU2l6ZWAuCiAgICB0aGlzLnVpLmZpZWxkID0gJ1tuYW1lPSInICsgdGhpcy5uYW1lICsgJyJdJzsKCiAgICBpZiAoIXRoaXMuZXZlbnRzKSB7CiAgICAgIHRoaXMuZXZlbnRzID0ge307CiAgICB9CiAgICB0aGlzLmV2ZW50cy5zdWJtaXQgPSAnb25TdWJtaXQnOwogICAgdGhpcy5ldmVudHNbJ2NoYW5nZSBbbmFtZT0iJyArIHRoaXMubmFtZSArICciXSddID0gJ3VwZGF0ZSc7CgogICAgVGFibGVsaW5nLk1vZHVsZS5wcm90b3R5cGUuaW5pdGlhbGl6ZS5jYWxsKHRoaXMsIG9wdGlvbnMpOwogIH0sCgogIHNldHVwOiBmdW5jdGlvbihjb25maWcpIHsKICAgIHRoaXMuc2V0dXBWYWx1ZShjb25maWdbdGhpcy5uYW1lXSk7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgdGhpcy5jb25maWcoKSwgeyByZWZyZXNoOiBmYWxzZSB9KTsKICB9LAoKICBzZXR1cFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgdGhpcy51aS5maWVsZC52YWwodmFsdWUpOwogIH0sCgogIC8vIFRoZSB0YWJsZSBwcm9wZXJ0eSB1cGRhdGVkIGlzIHRoZSBvbmUgd2l0aCB0aGUgc2FtZSBuYW1lIGFzIHRoZSBtb2R1bGUuCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHZhciBjb25maWcgPSB7fTsKICAgIGNvbmZpZ1t0aGlzLm5hbWVdID0gdGhpcy51aS5maWVsZC52YWwoKTsKICAgIHJldHVybiBjb25maWc7CiAgfSwKCiAgb25TdWJtaXQ6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHJldHVybiBmYWxzZTsKICB9Cn0pOwoKLy8gVGhpcyBpcyBob3cgYSBgUGFnZVNpemVWaWV3YCBtb2R1bGUgbWlnaHQgYmUgaW1wbGVtZW50ZWQ6Ci8vCi8vICAgICB2YXIgaHRtbCA9ICc8aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0icGFnZVNpemUiIC8+JzsKLy8KLy8gICAgIHZhciBQYWdlU2l6ZVZpZXcgPSBUYWJsZWxpbmcuRmllbGRNb2R1bGUuZXh0ZW5kKHsKLy8gICAgICAgICBuYW1lOiAncGFnZVNpemUnCi8vICAgICAgICAgdGVtcGxhdGU6IF8udGVtcGxhdGUoaHRtbCkKLy8gICAgIH0pOwovLwovLyBXaGVuIHRoZSB2YWx1ZSBvZiB0aGUgaW5wdXQgZmllbGQgY2hhbmdlcywgdGhlIGV2ZW50IGFnZ3JlZ2F0b3Igd2lsbAovLyByZWNlaXZlIGEgYHRhYmxlbGluZzp1cGRhdGVgIGV2ZW50IHdpdGggdGhlIGBwYWdlU2l6ZWAgcHJvcGVydHkgc2V0Ci8vIHRvIHRoYXQgdmFsdWUuCgpUYWJsZWxpbmcuUGxhaW4gPSB7fTsKClRhYmxlbGluZy5QbGFpbi5UYWJsZSA9IFRhYmxlbGluZy5Nb2R1bGFyLmV4dGVuZCh7CgogIGNsYXNzTmFtZTogJ3RhYmxlbGluZycsCiAgbW9kdWxlczogWyAndGFibGUnLCAncGFnZVNpemUnLCAncXVpY2tTZWFyY2gnLCAnaW5mbycsICdwYWdlJyBdLAogIHRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPSJoZWFkZXIiPjxkaXYgY2xhc3M9InBhZ2VTaXplIiAvPjxkaXYgY2xhc3M9InF1aWNrU2VhcmNoIiAvPjwvZGl2PjxkaXYgY2xhc3M9InRhYmxlIiAvPjxkaXYgY2xhc3M9ImZvb3RlciI+PGRpdiBjbGFzcz0iaW5mbyIgLz48ZGl2IGNsYXNzPSJwYWdlIiAvPjwvZGl2PicpLAoKICByZWdpb25zOiB7CiAgICB0YWJsZVJlZ2lvbjogJy50YWJsZScsCiAgICBwYWdlU2l6ZVJlZ2lvbjogJy5wYWdlU2l6ZScsCiAgICBxdWlja1NlYXJjaFJlZ2lvbjogJy5xdWlja1NlYXJjaCcsCiAgICBpbmZvUmVnaW9uOiAnLmluZm8nLAogICAgcGFnZVJlZ2lvbjogJy5wYWdlJwogIH0KfSk7CgovLyBUT0RPOiBtYWtlIHRhYmxlIHZpZXcgYSBtb2R1bGUKVGFibGVsaW5nLlBsYWluLlRhYmxlVmlldyA9IEJhY2tib25lLk1hcmlvbmV0dGUuQ29tcG9zaXRlVmlldy5leHRlbmQoewoKICBtb2R1bGVFdmVudHM6IHsKICAgICdjbGljayB0aGVhZCB0aC5zb3J0aW5nJzogJ3VwZGF0ZVNvcnQnLAogICAgJ2NsaWNrIHRoZWFkIHRoLnNvcnRpbmctYXNjJzogJ3VwZGF0ZVNvcnQnLAogICAgJ2NsaWNrIHRoZWFkIHRoLnNvcnRpbmctZGVzYyc6ICd1cGRhdGVTb3J0JwogIH0sCgogIC8vIFRPRE86IGFkZCBhdXRvLXNvcnQKICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CgogICAgdGhpcy52ZW50ID0gb3B0aW9ucy52ZW50OwogICAgdGhpcy5zb3J0ID0gW107CiAgICB0aGlzLnZlbnQub24oJ3RhYmxlOnNldHVwJywgdGhpcy5zZXRTb3J0LCB0aGlzKTsKICAgIHRoaXMudmVudC5vbigndGFibGU6cmVmcmVzaGVkJywgdGhpcy5zZXRTb3J0LCB0aGlzKTsKICAgIHRoaXMuZXZlbnRzID0gXy5leHRlbmQoe30sIHRoaXMuZXZlbnRzIHx8IHt9LCB0aGlzLm1vZHVsZUV2ZW50cyk7CgogICAgaWYgKHR5cGVvZih0aGlzLmluaXRpYWxpemVNb2R1bGUpID09ICdmdW5jdGlvbicpIHsKICAgICAgdGhpcy5pbml0aWFsaXplTW9kdWxlKG9wdGlvbnMpOwogICAgfQogIH0sCgogIHVwZGF0ZVNvcnQ6IGZ1bmN0aW9uKGV2KSB7CgogICAgdmFyIGVsID0gJChldi5jdXJyZW50VGFyZ2V0KTsKICAgIGlmICghKGVsLmhhc0NsYXNzKCdzb3J0aW5nJykgfHwgZWwuaGFzQ2xhc3MoJ3NvcnRpbmctYXNjJykgfHwgZWwuaGFzQ2xhc3MoJ3NvcnRpbmctZGVzYycpKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGZpZWxkID0gdGhpcy5maWVsZE5hbWUoZWwpOwoKICAgIGlmIChldi5zaGlmdEtleSB8fCB0aGlzLnNvcnQubGVuZ3RoID09IDEpIHsKCiAgICAgIHZhciBpbmRleCA9IC0xOwogICAgICBfLmZpbmQodGhpcy5zb3J0LCBmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgaWYgKGl0ZW0uc3BsaXQoJyAnKVswXSA9PSBmaWVsZCkgewogICAgICAgICAgaW5kZXggPSBpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBpZiAoaW5kZXggPj0gMCkgewoKICAgICAgICB2YXIgcGFydHMgPSB0aGlzLnNvcnRbaW5kZXhdLnNwbGl0KCcgJyk7CiAgICAgICAgdGhpcy5zb3J0W2luZGV4XSA9IHBhcnRzWzBdICsgJyAnICsgKHBhcnRzWzFdID09ICdhc2MnID8gJ2Rlc2MnIDogJ2FzYycpOwogICAgICAgIHRoaXMuc2hvd1NvcnQoKTsKICAgICAgICByZXR1cm4gdGhpcy52ZW50LnRyaWdnZXIoJ3RhYmxlOnVwZGF0ZScsIHRoaXMuY29uZmlnKCkpOwogICAgICB9CiAgICB9CgogICAgaWYgKCFldi5zaGlmdEtleSkgewogICAgICB0aGlzLnNvcnQubGVuZ3RoID0gMDsKICAgIH0KCiAgICB0aGlzLnNvcnQucHVzaChmaWVsZCArICcgYXNjJyk7CgogICAgdGhpcy5zaG93U29ydCgpOwoKICAgIHRoaXMudmVudC50cmlnZ2VyKCd0YWJsZTp1cGRhdGUnLCB0aGlzLmNvbmZpZygpKTsKICB9LAoKICBzZXRTb3J0OiBmdW5jdGlvbihjb25maWcpIHsKICAgIGlmIChjb25maWcgJiYgY29uZmlnLnNvcnQpIHsKICAgICAgdGhpcy5zb3J0ID0gY29uZmlnLnNvcnQuc2xpY2UoMCk7CiAgICAgIHRoaXMuc2hvd1NvcnQoKTsKICAgIH0KICB9LAoKICBzaG93U29ydDogZnVuY3Rpb24oKSB7CgogICAgdGhpcy4kZWwuZmluZCgndGhlYWQgdGguc29ydGluZywgdGhlYWQgdGguc29ydGluZy1hc2MsIHRoZWFkIHRoLnNvcnRpbmctZGVzYycpLnJlbW92ZUNsYXNzKCdzb3J0aW5nIHNvcnRpbmctYXNjIHNvcnRpbmctZGVzYycpLmFkZENsYXNzKCdzb3J0aW5nJyk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnNvcnQubGVuZ3RoOyBpKyspIHsKCiAgICAgIHZhciBwYXJ0cyA9IHRoaXMuc29ydFtpXS5zcGxpdCgnICcpOwogICAgICB2YXIgbmFtZSA9IHBhcnRzWzBdOwogICAgICB2YXIgZGlyZWN0aW9uID0gcGFydHNbMV07CiAgICAgIAogICAgICBmaWVsZCA9IHRoaXMuJGVsLmZpbmQoJ3RoZWFkIFtkYXRhLWZpZWxkPSInICsgbmFtZSArICciXScpOwogICAgICBpZiAoIWZpZWxkLmxlbmd0aCkgewogICAgICAgIGZpZWxkID0gdGhpcy4kZWwuZmluZCgndGhlYWQgdGg6Y29udGFpbnMoIicgKyBuYW1lICsgJyIpJyk7CiAgICAgIH0KCiAgICAgIGlmIChmaWVsZC5sZW5ndGgpIHsKICAgICAgICBmaWVsZC5yZW1vdmVDbGFzcygnc29ydGluZycpLmFkZENsYXNzKGRpcmVjdGlvbiA9PSAnZGVzYycgPyAnc29ydGluZy1kZXNjJyA6ICdzb3J0aW5nLWFzYycpOwogICAgICB9CiAgICB9CiAgfSwKCiAgY29uZmlnOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB7CiAgICAgIHBhZ2U6IDEsCiAgICAgIHNvcnQ6IHRoaXMuc29ydENvbmZpZygpCiAgICB9OwogIH0sCgogIHNvcnRDb25maWc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRoaXMuc29ydC5sZW5ndGggPyB0aGlzLnNvcnQgOiBudWxsOwogIH0sCgogIGZpZWxkTmFtZTogZnVuY3Rpb24oZWwpIHsKICAgIHJldHVybiBlbC5kYXRhKCdmaWVsZCcpIHx8IGVsLnRleHQoKTsKICB9Cn0pOwoKVGFibGVsaW5nLlBsYWluLlBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5QbGFpbi5UYWJsZS5wcm90b3R5cGUucGFnZVNpemVWaWV3ID0gVGFibGVsaW5nLkZpZWxkTW9kdWxlLmV4dGVuZCh7CgogIC8vIFRPRE86IHVwZGF0ZSBjdXJyZW50IHBhZ2UgaW50ZWxsaWdlbnRseQogIG5hbWU6ICdwYWdlU2l6ZScsCiAgdGVtcGxhdGU6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBfLnRlbXBsYXRlKCc8c2VsZWN0IG5hbWU9InBhZ2VTaXplIiAvPiA8JS0gZW50cmllcyAlPicpKGRhdGEpOwogIH0sCgogIGkxOG46IHsKICAgIGVudHJpZXM6ICdlbnRyaWVzIHBlciBwYWdlJwogIH0sCiAgc2l6ZXM6IFsgMTAsIDE1LCAyMCwgMjUsIDUwIF0sCgogIHVpOiB7CiAgICBmaWVsZDogJ3NlbGVjdCcKICB9LAoKICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB0aGlzLnNpemVzID0gXy5jbG9uZShvcHRpb25zLnNpemVzIHx8IHRoaXMuc2l6ZXMpOwogICAgVGFibGVsaW5nLkZpZWxkTW9kdWxlLnByb3RvdHlwZS5pbml0aWFsaXplLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfSwKCiAgb25SZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdGhpcy51aS5maWVsZC5lbXB0eSgpOwogICAgXy5lYWNoKHRoaXMuc2l6ZXMsIF8uYmluZCh0aGlzLmFkZFNpemUsIHRoaXMpKTsKICB9LAoKICBhZGRTaXplOiBmdW5jdGlvbihzaXplKSB7CiAgICAkKCc8b3B0aW9uIC8+JykudGV4dChzaXplKS5hcHBlbmRUbyh0aGlzLnVpLmZpZWxkKTsKICB9LAoKICBzZXR1cFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgaWYgKHZhbHVlKSB7CiAgICAgIFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuc2V0dXBWYWx1ZS5hcHBseSh0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKICAgIH0KICB9LAoKICBjb25maWc6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbmZpZyA9IFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuY29uZmlnLmNhbGwodGhpcyk7CiAgICBjb25maWcucGFnZSA9IDE7CiAgICByZXR1cm4gY29uZmlnOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uUXVpY2tTZWFyY2hWaWV3ID0gVGFibGVsaW5nLlBsYWluLlRhYmxlLnByb3RvdHlwZS5xdWlja1NlYXJjaFZpZXcgPSBUYWJsZWxpbmcuRmllbGRNb2R1bGUuZXh0ZW5kKHsKCiAgbmFtZTogJ3F1aWNrU2VhcmNoJywKICB0ZW1wbGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIF8udGVtcGxhdGUoJzxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJxdWlja1NlYXJjaCIgcGxhY2Vob2xkZXI9IjwlLSBxdWlja1NlYXJjaCAlPiIgLz4nKShkYXRhKTsKICB9LAoKICBpMThuOiB7CiAgICBxdWlja1NlYXJjaDogJ1F1aWNrIHNlYXJjaC4uLicKICB9LAoKICBjb25maWc6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbmZpZyA9IFRhYmxlbGluZy5GaWVsZE1vZHVsZS5wcm90b3R5cGUuY29uZmlnLmNhbGwodGhpcyk7CiAgICBjb25maWcucGFnZSA9IDE7CiAgICByZXR1cm4gY29uZmlnOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uSW5mb1ZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGUucHJvdG90eXBlLmluZm9WaWV3ID0gVGFibGVsaW5nLk1vZHVsZS5leHRlbmQoewoKICB0ZW1wbGF0ZTogZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuIF8udGVtcGxhdGUoZGF0YS50ZW1wbGF0ZSkoewogICAgICBmaXJzdDogJzxzcGFuIGNsYXNzPSJmaXJzdCI+MDwvc3Bhbj4nLAogICAgICBsYXN0OiAnPHNwYW4gY2xhc3M9Imxhc3QiPjA8L3NwYW4+JywKICAgICAgdG90YWw6ICc8c3BhbiBjbGFzcz0idG90YWwiPjA8L3NwYW4+JwogICAgfSk7CiAgfSwKCiAgaTE4bjogewogICAgdGVtcGxhdGU6ICdTaG93aW5nIDwlPSBmaXJzdCAlPiB0byA8JT0gbGFzdCAlPiBvZiA8JT0gdG90YWwgJT4gZW50cmllcycKICB9LAoKICB1aTogewogICAgZmlyc3Q6ICcuZmlyc3QnLAogICAgbGFzdDogJy5sYXN0JywKICAgIHRvdGFsOiAnLnRvdGFsJwogIH0sCgogIHJlZnJlc2g6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIGlmIChkYXRhKSB7CiAgICAgIHRoaXMudWkuZmlyc3QudGV4dCh0aGlzLmZpcnN0UmVjb3JkKGRhdGEpKTsKICAgICAgdGhpcy51aS5sYXN0LnRleHQodGhpcy5sYXN0UmVjb3JkKGRhdGEpKTsKICAgICAgdGhpcy51aS50b3RhbC50ZXh0KGRhdGEudG90YWwpOwogICAgfQogIH0sCgogIGZpcnN0UmVjb3JkOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gZGF0YS5sZW5ndGggPyAoKGRhdGEucGFnZSB8fCAxKSAtIDEpICogZGF0YS5wYWdlU2l6ZSArIDEgOiAwOwogIH0sCgogIGxhc3RSZWNvcmQ6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBkYXRhLmxlbmd0aCA/IHRoaXMuZmlyc3RSZWNvcmQoZGF0YSkgKyBkYXRhLmxlbmd0aCAtIDEgOiAwOwogIH0KfSk7CgpUYWJsZWxpbmcuUGxhaW4uUGFnZVZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGUucHJvdG90eXBlLnBhZ2VWaWV3ID0gVGFibGVsaW5nLk1vZHVsZS5leHRlbmQoewogICAgCiAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJzx1bCBjbGFzcz0icGFnaW5hdGlvbiI+PGxpIGNsYXNzPSJmaXJzdCI+PGEgaHJlZj0iIyI+Jmx0OyZsdDs8L2E+PC9saT48bGkgY2xhc3M9InByZXZpb3VzIj48YSBocmVmPSIjIj4mbHQ7PC9hPjwvbGk+PGxpIGNsYXNzPSJuZXh0Ij48YSBocmVmPSIjIj4mZ3Q7PC9hPjwvbGk+PGxpIGNsYXNzPSJsYXN0Ij48YSBocmVmPSIjIj4mZ3Q7Jmd0OzwvYT48L2xpPjwvdWw+JyksCiAgcGFnZVRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8bGkgY2xhc3M9InBhZ2UiPjxhIGhyZWY9IiMiPjwlLSBudW1iZXIgJT48L2E+PC9saT4nKSwKCiAgdWk6IHsKICAgIGZpcnN0OiAnLmZpcnN0JywKICAgIHByZXZpb3VzOiAnLnByZXZpb3VzJywKICAgIG5leHQ6ICcubmV4dCcsCiAgICBsYXN0OiAnLmxhc3QnCiAgfSwKCiAgZXZlbnRzOiB7CiAgICAnY2xpY2sgLmZpcnN0Om5vdCguZGlzYWJsZWQpJzogJ2dvVG9GaXJzdFBhZ2UnLAogICAgJ2NsaWNrIC5wcmV2aW91czpub3QoLmRpc2FibGVkKSc6ICdnb1RvUHJldmlvdXNQYWdlJywKICAgICdjbGljayAucGFnZTpub3QoLmRpc2FibGVkKSc6ICdnb1RvUGFnZScsCiAgICAnY2xpY2sgLm5leHQ6bm90KC5kaXNhYmxlZCknOiAnZ29Ub05leHRQYWdlJywKICAgICdjbGljayAubGFzdDpub3QoLmRpc2FibGVkKSc6ICdnb1RvTGFzdFBhZ2UnCiAgfSwKCiAgcmVmcmVzaDogZnVuY3Rpb24oZGF0YSkgewogICAgdGhpcy4kZWwuZmluZCgnLnBhZ2UnKS5yZW1vdmUoKTsKICAgIGlmICghZGF0YSB8fCAhZGF0YS5sZW5ndGgpIHsKICAgICAgdGhpcy51aS5maXJzdC5hZGRDbGFzcygnZGlzYWJsZWQnKTsKICAgICAgdGhpcy51aS5wcmV2aW91cy5hZGRDbGFzcygnZGlzYWJsZWQnKTsKICAgICAgdGhpcy51aS5uZXh0LmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgICB0aGlzLnVpLmxhc3QuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmRhdGEgPSBkYXRhOwogICAgICB0aGlzLmVuYWJsZSh0aGlzLnVpLmZpcnN0LCB0aGlzLmdldFBhZ2UoZGF0YSkgPiAxKTsKICAgICAgdGhpcy5lbmFibGUodGhpcy51aS5wcmV2aW91cywgdGhpcy5nZXRQYWdlKGRhdGEpID4gMSk7CiAgICAgIHRoaXMuc2V0dXBQYWdlcygpOwogICAgICB0aGlzLmVuYWJsZSh0aGlzLnVpLm5leHQsIHRoaXMuZ2V0UGFnZShkYXRhKSA8IHRoaXMubnVtYmVyT2ZQYWdlcyhkYXRhKSk7CiAgICAgIHRoaXMuZW5hYmxlKHRoaXMudWkubGFzdCwgdGhpcy5nZXRQYWdlKGRhdGEpIDwgdGhpcy5udW1iZXJPZlBhZ2VzKGRhdGEpKTsKICAgIH0KICB9LAoKICBzZXR1cFBhZ2VzOiBmdW5jdGlvbigpIHsKCiAgICB2YXIgcGFnZSA9IHRoaXMuZ2V0UGFnZSh0aGlzLmRhdGEpOwogICAgdmFyIHRvdGFsID0gdGhpcy5udW1iZXJPZlBhZ2VzKCk7CgogICAgdmFyIGZpcnN0ID0gcGFnZSAtIDI7CiAgICBpZiAodG90YWwgLSBmaXJzdCA8IDQpIHsKICAgICAgZmlyc3QgPSB0b3RhbCAtIDQ7CiAgICB9CgogICAgaWYgKGZpcnN0IDwgMSkgewogICAgICBmaXJzdCA9IDE7CiAgICB9CgogICAgdmFyIG4gPSA1OwogICAgaWYgKGZpcnN0ICsgbiAtIDEgPiB0b3RhbCkgewogICAgICBuID0gdG90YWwgLSBmaXJzdCArIDE7CiAgICB9CgogICAgXy50aW1lcyhuLCBmdW5jdGlvbihpKSB7CiAgICAgICQodGhpcy5wYWdlVGVtcGxhdGUoeyBudW1iZXI6IGZpcnN0ICsgaSB9KSkuaW5zZXJ0QmVmb3JlKHRoaXMudWkubmV4dCk7CiAgICB9LCB0aGlzKTsKCiAgICB2YXIgaSA9IHBhZ2UgLSBmaXJzdDsKICAgIHRoaXMuJGVsLmZpbmQoJy5wYWdlJykuc2xpY2UoaSwgaSArIDEpLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogIH0sCgogIGVuYWJsZTogZnVuY3Rpb24oZWwsIGVuYWJsZWQpIHsKICAgIGVsLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpOwogICAgaWYgKCFlbmFibGVkKSB7CiAgICAgIGVsLmFkZENsYXNzKCdkaXNhYmxlZCcpOwogICAgfQogIH0sCgogIG51bWJlck9mUGFnZXM6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIE1hdGguY2VpbCh0aGlzLmRhdGEudG90YWwgLyB0aGlzLmRhdGEucGFnZVNpemUpOwogIH0sCgogIGdvVG9GaXJzdFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIoMSk7CiAgfSwKCiAgZ29Ub1ByZXZpb3VzUGFnZTogZnVuY3Rpb24oZSkgewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgdGhpcy5nb1RvUGFnZU51bWJlcih0aGlzLmdldFBhZ2UodGhpcy5kYXRhKSAtIDEpOwogIH0sCgogIGdvVG9QYWdlOiBmdW5jdGlvbihlKSB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICB0aGlzLmdvVG9QYWdlTnVtYmVyKHBhcnNlSW50KCQoZS50YXJnZXQpLnRleHQoKSwgMTApKTsKICB9LAoKICBnb1RvTmV4dFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIodGhpcy5nZXRQYWdlKHRoaXMuZGF0YSkgKyAxKTsKICB9LAoKICBnb1RvTGFzdFBhZ2U6IGZ1bmN0aW9uKGUpIHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHRoaXMuZ29Ub1BhZ2VOdW1iZXIodGhpcy5udW1iZXJPZlBhZ2VzKCkpOwogIH0sCgogIGdvVG9QYWdlTnVtYmVyOiBmdW5jdGlvbihuKSB7CiAgICB0aGlzLnZlbnQudHJpZ2dlcigndGFibGU6dXBkYXRlJywgeyBwYWdlOiBuIH0pOwogIH0sCgogIGdldFBhZ2U6IGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiBkYXRhLnBhZ2UgfHwgMTsKICB9Cn0pOwoKVGFibGVsaW5nLkJvb3RzdHJhcCA9IHt9OwoKVGFibGVsaW5nLkJvb3RzdHJhcC5UYWJsZSA9IFRhYmxlbGluZy5QbGFpbi5UYWJsZS5leHRlbmQoewogIHRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPSJoZWFkZXIgY2xlYXJmaXgiPjxkaXYgY2xhc3M9InBhZ2VTaXplIHB1bGwtbGVmdCIgLz48ZGl2IGNsYXNzPSJxdWlja1NlYXJjaCBwdWxsLXJpZ2h0IiAvPjwvZGl2PjxkaXYgY2xhc3M9InRhYmxlIiAvPjxkaXYgY2xhc3M9ImZvb3RlciBjbGVhcmZpeCI+PGRpdiBjbGFzcz0iaW5mbyBwdWxsLWxlZnQiIC8+PGRpdiBjbGFzcz0icGFnZSBwdWxsLXJpZ2h0IiAvPjwvZGl2PicpCn0pOwoKVGFibGVsaW5nLkJvb3RzdHJhcC5UYWJsZVZpZXcgPSBUYWJsZWxpbmcuUGxhaW4uVGFibGVWaWV3LmV4dGVuZCh7fSk7CgpUYWJsZWxpbmcuQm9vdHN0cmFwLlBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnBhZ2VTaXplVmlldyA9IFRhYmxlbGluZy5QbGFpbi5QYWdlU2l6ZVZpZXcuZXh0ZW5kKHsKCiAgdGFnTmFtZTogJ2Zvcm0nLAogIGNsYXNzTmFtZTogJ2Zvcm0taW5saW5lJywKICBhdHRyaWJ1dGVzOiB7CiAgICByb2xlOiAnZm9ybScKICB9LAogIHRlbXBsYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz0iZm9ybUdyb3VwIj48c2VsZWN0IG5hbWU9InBhZ2VTaXplIiBjbGFzcz0iZm9ybS1jb250cm9sIj48b3B0aW9uPjU8L29wdGlvbj48b3B0aW9uPjEwPC9vcHRpb24+PG9wdGlvbj4xNTwvb3B0aW9uPjwvc2VsZWN0PiA8JS0gZW50cmllcyAlPjwvZGl2PicpKGRhdGEpOwogIH0KfSk7CgpUYWJsZWxpbmcuQm9vdHN0cmFwLlF1aWNrU2VhcmNoVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnF1aWNrU2VhcmNoVmlldyA9IFRhYmxlbGluZy5QbGFpbi5RdWlja1NlYXJjaFZpZXcuZXh0ZW5kKHsKCiAgdGFnTmFtZTogJ2Zvcm0nLAogIGNsYXNzTmFtZTogJ2Zvcm0taW5saW5lJywKICBhdHRyaWJ1dGVzOiB7CiAgICByb2xlOiAnZm9ybScKICB9LAogIHRlbXBsYXRlOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz0iZm9ybUdyb3VwIj48aW5wdXQgdHlwZT0idGV4dCIgbmFtZT0icXVpY2tTZWFyY2giIGNsYXNzPSJmb3JtLWNvbnRyb2wiIHBsYWNlaG9sZGVyPSI8JS0gcXVpY2tTZWFyY2ggJT4iIC8+PC9kaXY+JykoZGF0YSk7CiAgfQp9KTsKClRhYmxlbGluZy5Cb290c3RyYXAuSW5mb1ZpZXcgPSBUYWJsZWxpbmcuQm9vdHN0cmFwLlRhYmxlLnByb3RvdHlwZS5pbmZvVmlldyA9IFRhYmxlbGluZy5QbGFpbi5JbmZvVmlldy5leHRlbmQoe30pOwoKVGFibGVsaW5nLkJvb3RzdHJhcC5QYWdlVmlldyA9IFRhYmxlbGluZy5Cb290c3RyYXAuVGFibGUucHJvdG90eXBlLnBhZ2VWaWV3ID0gVGFibGVsaW5nLlBsYWluLlBhZ2VWaWV3LmV4dGVuZCh7fSk7CgogIHJldHVybiBUYWJsZWxpbmc7Cgp9KShCYWNrYm9uZSwgXywgJCB8fCB3aW5kb3cualF1ZXJ5IHx8IHdpbmRvdy5aZXB0byB8fCB3aW5kb3cuZW5kZXIpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 15:17:38 GMT",
                    "Content-Length": "200306",
                    "Date": "Sat, 08 Nov 2014 15:17:38 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}