{
    "url": "http://localhost:9999/krasimir/absurd/client-side/build/absurd.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statement:<ul><li>window.location.href = window.location.href.replace(/#(.*)$/, '') + '#' + path;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/krasimir/absurd/client-side/build/absurd.js",
                "path": "/krasimir/absurd/client-side/build/absurd.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rcmFzaW1pci9hYnN1cmQvY2xpZW50LXNpZGUvYnVpbGQvYWJzdXJkLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODE0ODYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMDY6MDU6MTUgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjA1OjE1IEdNVA0KDQovKiB2ZXJzaW9uOiAwLjMuMzEsIGJvcm46IDE3LTEwLTIwMTQgMjM6NDggKi8KdmFyIEFic3VyZCA9IChmdW5jdGlvbih3KSB7CnZhciBsaWIgPSB7IAogICAgYXBpOiB7fSwKICAgIGhlbHBlcnM6IHt9LAogICAgcGx1Z2luczoge30sCiAgICBwcm9jZXNzb3JzOiB7IAogICAgICAgIGNzczogeyBwbHVnaW5zOiB7fX0sCiAgICAgICAgaHRtbDogeyAKICAgICAgICAgICAgcGx1Z2luczoge30sCiAgICAgICAgICAgIGhlbHBlcnM6IHt9CiAgICAgICAgfSwKICAgICAgICBjb21wb25lbnQ6IHsgcGx1Z2luczoge319CiAgICB9Cn07CnZhciByZXF1aXJlID0gZnVuY3Rpb24odikgewogICAgLy8gY3NzIHByZXByb2Nlc3NvcgogICAgaWYodi5pbmRleE9mKCdjc3MvQ1NTLmpzJykgPiAwIHx8IHYgPT0gJy8uLi9DU1MuanMnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmNzcy5DU1M7CiAgICB9IGVsc2UgaWYodi5pbmRleE9mKCdodG1sL0hUTUwuanMnKSA+IDApIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuaHRtbC5IVE1MOwogICAgfSBlbHNlIGlmKHYuaW5kZXhPZignY29tcG9uZW50L0NvbXBvbmVudC5qcycpID4gMCkgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5jb21wb25lbnQuQ29tcG9uZW50OwogICAgfSBlbHNlIGlmKHYgPT0gJ2pzLWJlYXV0aWZ5JykgewogICAgICAgIHJldHVybiB7IAogICAgICAgICAgICBodG1sOiBmdW5jdGlvbihodG1sKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaHRtbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZih2ID09ICcuL2hlbHBlcnMvUHJvcEFuYWx5emVyJykgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5odG1sLmhlbHBlcnMuUHJvcEFuYWx5emVyOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uLy4uL2hlbHBlcnMvVHJhbnNmb3JtVXBwZXJjYXNlJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5UcmFuc2Zvcm1VcHBlcmNhc2U7CiAgICB9IGVsc2UgaWYodiA9PSAnLi9oZWxwZXJzL1RlbXBsYXRlRW5naW5lJyB8fCB2ID09ICcuLi9odG1sL2hlbHBlcnMvVGVtcGxhdGVFbmdpbmUnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmh0bWwuaGVscGVycy5UZW1wbGF0ZUVuZ2luZTsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL0V4dGVuZCcpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuRXh0ZW5kOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uL2hlbHBlcnMvQ2xvbmUnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLkNsb25lOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uL2hlbHBlcnMvUHJlZml4ZXMnIHx8IHYgPT0gJy8uLi8uLi8uLi9oZWxwZXJzL1ByZWZpeGVzJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5QcmVmaXhlczsKICAgIH0gZWxzZSBpZih2ID09IF9fZGlybmFtZSArICcvLi4vLi4vLi4vLi4vJykgewogICAgICAgIHJldHVybiBBYnN1cmQ7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vaGVscGVycy9DU1NQYXJzZScpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuQ1NTUGFyc2U7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmdW5jdGlvbigpIHt9CiAgICB9Cn07CnZhciBfX2Rpcm5hbWUgPSAiIjsKdmFyIHF1ZXVlICA9IGZ1bmN0aW9uKGZ1bmNzLCBzY29wZSkgewoJKGZ1bmN0aW9uIG5leHQoKSB7CgkJaWYoZnVuY3MubGVuZ3RoID4gMCkgewoJCQlmdW5jcy5zaGlmdCgpLmFwcGx5KHNjb3BlIHx8IHt9LCBbbmV4dF0uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpKTsKCQl9Cgl9KSgpOwp9CnZhciBzdHIyRE9NRWxlbWVudCA9IGZ1bmN0aW9uKGh0bWwpIHsKICAgdmFyIHdyYXBNYXAgPSB7CiAgICAgICAgb3B0aW9uOiBbIDEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiIgXSwKICAgICAgICBsZWdlbmQ6IFsgMSwgIjxmaWVsZHNldD4iLCAiPC9maWVsZHNldD4iIF0sCiAgICAgICAgYXJlYTogWyAxLCAiPG1hcD4iLCAiPC9tYXA+IiBdLAogICAgICAgIHBhcmFtOiBbIDEsICI8b2JqZWN0PiIsICI8L29iamVjdD4iIF0sCiAgICAgICAgdGhlYWQ6IFsgMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iIF0sCiAgICAgICAgdHI6IFsgMiwgIjx0YWJsZT48dGJvZHk+IiwgIjwvdGJvZHk+PC90YWJsZT4iIF0sCiAgICAgICAgY29sOiBbIDIsICI8dGFibGU+PHRib2R5PjwvdGJvZHk+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+IiBdLAogICAgICAgIHRkOiBbIDMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+IiBdLAogICAgICAgIGJvZHk6IFswLCAiIiwgIiJdLAogICAgICAgIF9kZWZhdWx0OiBbIDEsICI8ZGl2PiIsICI8L2Rpdj4iICBdCiAgICB9OwogICAgd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uOwogICAgd3JhcE1hcC50Ym9keSA9IHdyYXBNYXAudGZvb3QgPSB3cmFwTWFwLmNvbGdyb3VwID0gd3JhcE1hcC5jYXB0aW9uID0gd3JhcE1hcC50aGVhZDsKICAgIHdyYXBNYXAudGggPSB3cmFwTWFwLnRkOwogICAgdmFyIG1hdGNoID0gLzxccypcdy4qPz4vZy5leGVjKGh0bWwpOwogICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGlmKG1hdGNoICE9IG51bGwpIHsKICAgICAgICB2YXIgdGFnID0gbWF0Y2hbMF0ucmVwbGFjZSgvPC9nLCAnJykucmVwbGFjZSgvPi9nLCAnJykuc3BsaXQoJyAnKVswXTsKICAgICAgICBpZih0YWcudG9Mb3dlckNhc2UoKSA9PT0gJ2JvZHknKSB7CiAgICAgICAgICAgIHZhciBkb20gPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVEb2N1bWVudCgnaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCcsICdodG1sJywgbnVsbCk7CiAgICAgICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYm9keSIpOwogICAgICAgICAgICAvLyBrZWVwaW5nIHRoZSBhdHRyaWJ1dGVzCiAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbC5yZXBsYWNlKC88Ym9keS9nLCAnPGRpdicpLnJlcGxhY2UoLzxcL2JvZHk+L2csICc8L2Rpdj4nKTsKICAgICAgICAgICAgdmFyIGF0dHJzID0gZWxlbWVudC5maXJzdENoaWxkLmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGJvZHkuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8YXR0cnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGJvZHkuc2V0QXR0cmlidXRlKGF0dHJzW2ldLm5hbWUsIGF0dHJzW2ldLnZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYm9keTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbWFwID0gd3JhcE1hcFt0YWddIHx8IHdyYXBNYXAuX2RlZmF1bHQsIGVsZW1lbnQ7CiAgICAgICAgICAgIGh0bWwgPSBtYXBbMV0gKyBodG1sICsgbWFwWzJdOwogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgICB2YXIgaiA9IG1hcFswXSsxOwogICAgICAgICAgICB3aGlsZShqLS0pIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lmxhc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIGVsZW1lbnQgPSBlbGVtZW50Lmxhc3RDaGlsZDsKICAgIH0KICAgIHJldHVybiBlbGVtZW50Owp9CnZhciBhZGRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ob2JqLCBldnQsIGZuYykgewogICAgaWYgKG9iai5hZGRFdmVudExpc3RlbmVyKSB7IC8vIFczQyBtb2RlbAogICAgICAgIG9iai5hZGRFdmVudExpc3RlbmVyKGV2dCwgZm5jLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKG9iai5hdHRhY2hFdmVudCkgeyAvLyBNaWNyb3NvZnQgbW9kZWwKICAgICAgICByZXR1cm4gb2JqLmF0dGFjaEV2ZW50KCdvbicgKyBldnQsIGZuYyk7CiAgICB9Cn0KdmFyIHJlbW92ZUVtcHR5VGV4dE5vZGVzID0gZnVuY3Rpb24oZWxlbSkgewogICAgdmFyIGNoaWxkcmVuID0gZWxlbS5jaGlsZE5vZGVzOwogICAgdmFyIGNoaWxkOwogICAgdmFyIGxlbiA9IGNoaWxkcmVuLmxlbmd0aDsKICAgIHZhciBpID0gMDsKICAgIHZhciB3aGl0ZXNwYWNlID0gL15ccyokLzsKICAgIGZvcig7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBpZihjaGlsZC5ub2RlVHlwZSA9PSAzKXsKICAgICAgICAgICAgaWYod2hpdGVzcGFjZS50ZXN0KGNoaWxkLm5vZGVWYWx1ZSkpewogICAgICAgICAgICAgICAgZWxlbS5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICBsZW4tLTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtOwp9CnZhciBjcmVhdGVOb2RlID0gZnVuY3Rpb24odHlwZSwgYXR0cnMsIGNvbnRlbnQpIHsKCXZhciBub2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlKTsKCWZvcih2YXIgaT0wOyBpPGF0dHJzLmxlbmd0aCwgYT1hdHRyc1tpXTsgaSsrKSB7CgkJbm9kZS5zZXRBdHRyaWJ1dGUoYS5uYW1lLCBhLnZhbHVlKTsKCX0KCW5vZGUuaW5uZXJIVE1MID0gY29udGVudDsKCXJldHVybiBub2RlOwp9CnZhciBxcyA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBwYXJlbnQpIHsKICAgIGlmKHBhcmVudCA9PT0gZmFsc2UpIHsgcGFyZW50ID0gZG9jdW1lbnQ7IH0KICAgIGVsc2UgeyBwYXJlbnQgPSBwYXJlbnQgfHwgdGhpcy5lbCB8fCBkb2N1bWVudDsgfQogICAgcmV0dXJuIHBhcmVudC5xdWVyeVNlbGVjdG9yKHNlbGVjdG9yKTsKfTsKdmFyIHFzYSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBwYXJlbnQpIHsKICAgIGlmKHBhcmVudCA9PT0gZmFsc2UpIHsgcGFyZW50ID0gZG9jdW1lbnQ7IH0KICAgIGVsc2UgeyBwYXJlbnQgPSBwYXJlbnQgfHwgdGhpcy5lbCB8fCBkb2N1bWVudDsgfQogICAgcmV0dXJuIHBhcmVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKfTsKdmFyIGdldFN0eWxlID0gZnVuY3Rpb24oc3R5bGVQcm9wLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgaWYoZWwgJiYgZWwuY3VycmVudFN0eWxlKSB7CiAgICAgICAgcmV0dXJuIGVsLmN1cnJlbnRTdHlsZVtzdHlsZVByb3BdOwogICAgfSBlbHNlIGlmICh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgIHJldHVybiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKS5nZXRQcm9wZXJ0eVZhbHVlKHN0eWxlUHJvcCk7CiAgICB9CiAgICByZXR1cm4gbnVsbDsKfTsKdmFyIGFkZENsYXNzID0gZnVuY3Rpb24oY2xhc3NOYW1lLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgaWYoZWwuY2xhc3NMaXN0KSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LmFkZChjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3VycmVudCA9IGVsLmNsYXNzTmFtZTsKICAgICAgICBpZihjdXJyZW50LmluZGV4T2YoY2xhc3NOYW1lKSA8IDApIHsKICAgICAgICAgICAgaWYoY3VycmVudCA9PSAnJykgZWwuY2xhc3NOYW1lID0gY2xhc3NOYW1lOwogICAgICAgICAgICBlbHNlIGVsLmNsYXNzTmFtZSArPSAnICcgKyBjbGFzc05hbWU7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRoaXM7Cn07CnZhciByZW1vdmVDbGFzcyA9IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgICAgICBlbC5jbGFzc0xpc3QucmVtb3ZlKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciBjdXJyZW50ID0gZWwuY2xhc3NOYW1lLnNwbGl0KCcgJyk7CiAgICAgICAgdmFyIG5ld0NsYXNzZXMgPSBbXTsKICAgICAgICBmb3IodmFyIGk9MDsgaTxjdXJyZW50Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmKGN1cnJlbnRbaV0gIT0gY2xhc3NOYW1lKSBuZXdDbGFzc2VzLnB1c2goY3VycmVudFtpXSk7CiAgICAgICAgfQogICAgICAgIGVsLmNsYXNzTmFtZSA9IG5ld0NsYXNzZXMuam9pbignICcpOwogICAgfQogICAgcmV0dXJuIHRoaXM7Cn0KdmFyIHJlcGxhY2VDbGFzcyA9IGZ1bmN0aW9uKGNsYXNzTmFtZUEsIGNsYXNzTmFtZUIsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICB2YXIgY3VycmVudCA9IGVsLmNsYXNzTmFtZS5zcGxpdCgnICcpLCBmb3VuZCA9IGZhbHNlOwogICAgZm9yKHZhciBpPTA7IGk8Y3VycmVudC5sZW5ndGg7IGkrKykgewogICAgICAgIGlmKGN1cnJlbnRbaV0gPT0gY2xhc3NOYW1lQSkgewogICAgICAgICAgICBmb3VuZCA9IHRydWU7CiAgICAgICAgICAgIGN1cnJlbnRbaV0gPSBjbGFzc05hbWVCOwogICAgICAgIH0KICAgIH0KICAgIGlmKCFmb3VuZCkgewogICAgICAgIHJldHVybiBhZGRDbGFzcyhjbGFzc05hbWVCLCBlbCk7CiAgICB9CiAgICBlbC5jbGFzc05hbWUgPSBjdXJyZW50LmpvaW4oJyAnKTsKICAgIHJldHVybiB0aGlzOwp9CnZhciB0b2dnbGVDbGFzcyA9IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgICAgICBlbC5jbGFzc0xpc3QudG9nZ2xlKGNsYXNzTmFtZSk7CiAgICB9IGVsc2UgewogICAgICAgIHZhciBjbGFzc2VzID0gZWwuY2xhc3NOYW1lLnNwbGl0KCcgJyk7CiAgICAgICAgdmFyIGV4aXN0aW5nSW5kZXggPSAtMTsKICAgICAgICBmb3IgKHZhciBpID0gY2xhc3Nlcy5sZW5ndGg7IGktLTspIHsKICAgICAgICAgICAgaWYgKGNsYXNzZXNbaV0gPT09IGNsYXNzTmFtZSkKICAgICAgICAgICAgICAgIGV4aXN0aW5nSW5kZXggPSBpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZihleGlzdGluZ0luZGV4ID49IDApCiAgICAgICAgICAgIGNsYXNzZXMuc3BsaWNlKGV4aXN0aW5nSW5kZXgsIDEpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKGNsYXNzTmFtZSk7CgogICAgICAgIGVsLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwogICAgfQogICAgcmV0dXJuIHRoaXM7Cn0KdmFyIGJpbmQgPSBmdW5jdGlvbihmdW5jLCBzY29wZSwgYXJncykgewogICAgaWYoc2NvcGUgaW5zdGFuY2VvZiBBcnJheSkgeyBhcmdzID0gc2NvcGU7IHNjb3BlID0gdGhpczsgfQogICAgaWYoIXNjb3BlKSBzY29wZSA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuYy5hcHBseShzY29wZSwgKGFyZ3MgfHwgW10pLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSk7CiAgICB9Cn0KdmFyIENvbXBvbmVudCA9IGZ1bmN0aW9uKGNvbXBvbmVudE5hbWUsIGFic3VyZCwgZXZlbnRCdXMsIGNscykgewoJdmFyIGFwaSA9IGxpYi5oZWxwZXJzLkV4dGVuZCh7CgkJX19uYW1lOiBjb21wb25lbnROYW1lCgl9LCBjbHMpOwoJdmFyIGV4dGVuZCA9IGxpYi5oZWxwZXJzLkV4dGVuZDsKdmFyIGwgPSBbXTsKYXBpLmxpc3RlbmVycyA9IGw7CmFwaS5vbiA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIHNjb3BlKSB7CglpZighbFtldmVudE5hbWVdKSB7CgkJbFtldmVudE5hbWVdID0gW107Cgl9CglsW2V2ZW50TmFtZV0ucHVzaCh7Y2FsbGJhY2s6IGNhbGxiYWNrLCBzY29wZTogc2NvcGV9KTsKCXJldHVybiB0aGlzOwp9OwphcGkub2ZmID0gZnVuY3Rpb24oZXZlbnROYW1lLCBoYW5kbGVyKSB7CglpZighbFtldmVudE5hbWVdKSByZXR1cm4gdGhpczsKCWlmKCFoYW5kbGVyKSBsW2V2ZW50TmFtZV0gPSBbXTsgcmV0dXJuIHRoaXM7Cgl2YXIgbmV3QXJyID0gW107Cglmb3IodmFyIGk9MDsgaTxsW2V2ZW50TmFtZV0ubGVuZ3RoOyBpKyspIHsKCQlpZihsW2V2ZW50TmFtZV1baV0uY2FsbGJhY2sgIT09IGhhbmRsZXIpIHsKCQkJbmV3QXJyLnB1c2gobFtldmVudE5hbWVdW2ldKTsKCQl9Cgl9CglsW2V2ZW50TmFtZV0gPSBuZXdBcnI7CglyZXR1cm4gdGhpczsKfTsKYXBpLmRpc3BhdGNoID0gZnVuY3Rpb24oZXZlbnROYW1lLCBkYXRhLCBzY29wZSkgewoJaWYoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcgJiYgIShkYXRhIGluc3RhbmNlb2YgQXJyYXkpKSB7CgkJZGF0YS50YXJnZXQgPSB0aGlzOwoJfQoJaWYobFtldmVudE5hbWVdKSB7CgkJZm9yKHZhciBpPTA7IGk8bFtldmVudE5hbWVdLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBjYWxsYmFjayA9IGxbZXZlbnROYW1lXVtpXS5jYWxsYmFjazsKCQkJY2FsbGJhY2suYXBwbHkoc2NvcGUgfHwgbFtldmVudE5hbWVdW2ldLnNjb3BlIHx8IHt9LCBbZGF0YV0pOwoJCX0KCX0KCWlmKHRoaXNbZXZlbnROYW1lXSAmJiB0eXBlb2YgdGhpc1tldmVudE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CgkJdGhpc1tldmVudE5hbWVdKGRhdGEpOwoJfQoJaWYoZXZlbnRCdXMpIGV2ZW50QnVzLmRpc3BhdGNoKGV2ZW50TmFtZSwgZGF0YSk7CglyZXR1cm4gdGhpczsKfTsKdmFyIHN0b3JhZ2UgPSB7fTsKYXBpLnNldCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKCXN0b3JhZ2Vba2V5XSA9IHZhbHVlOwoJcmV0dXJuIHRoaXM7Cn07CmFwaS5nZXQgPSBmdW5jdGlvbihrZXkpIHsKCXJldHVybiBzdG9yYWdlW2tleV07Cn07CnZhciBDU1MgPSBmYWxzZTsKYXBpLl9faGFuZGxlQ1NTID0gZnVuY3Rpb24obmV4dCkgewoJaWYodGhpcy5jc3MpIHsKCQlhYnN1cmQuZmx1c2goKS5tb3JwaCgnZHluYW1pYy1jc3MnKS5hZGQodGhpcy5jc3MpLmNvbXBpbGUoZnVuY3Rpb24oZXJyLCBjc3MpIHsKCQkJaWYoIUNTUykgewoJCQkJdmFyIHN0eWxlID0gY3JlYXRlTm9kZSgKCQkJCQknc3R5bGUnLCBbCgkJCQkJCXsgbmFtZTogImlkIiwgdmFsdWU6IGNvbXBvbmVudE5hbWUgKyAnLWNzcycgfSwKCQkJCQkJeyBuYW1lOiAidHlwZSIsIHZhbHVlOiAidGV4dC9jc3MifQoJCQkJCV0sCgkJCQkJIGNzcwoJCQkJKTsKCQkJCShxcygiaGVhZCIpIHx8IHFzKCJib2R5IikpLmFwcGVuZENoaWxkKHN0eWxlKTsKCQkJCUNTUyA9IHsgcmF3OiBjc3MsIGVsZW1lbnQ6IHN0eWxlIH07CgkJCX0gZWxzZSBpZihDU1MucmF3ICE9PSBjc3MpIHsKCQkJCUNTUy5yYXcgPSBjc3M7CgkJCQlDU1MuZWxlbWVudC5pbm5lckhUTUwgPSBjc3M7CgkJCX0KCQkJbmV4dCgpOwoJCX0sIHRoaXMpOwoJfSBlbHNlIHsKCQluZXh0KCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKYXBpLmFwcGx5Q1NTID0gZnVuY3Rpb24oZGF0YSwgcHJldmVudENvbXBvc2l0aW9uLCBza2lwQXV0b1BvcHVsYXRpb24pIHsKCWlmKHRoaXMuaHRtbCAmJiB0eXBlb2YgdGhpcy5odG1sID09PSAnc3RyaW5nJyAmJiAhcHJldmVudENvbXBvc2l0aW9uKSB7CgkJdmFyIHJlcyA9IHt9OwoJCXJlc1t0aGlzLmh0bWxdID0gZGF0YTsKCQlkYXRhID0gcmVzOwoJfQoJdGhpcy5jc3MgPSBkYXRhOwoJaWYoIXNraXBBdXRvUG9wdWxhdGlvbikgewoJCXRoaXMucG9wdWxhdGUoKTsKCX0KCXJldHVybiB0aGlzOwp9Owp2YXIgSFRNTFNvdXJjZSA9IGZhbHNlOwoKYXBpLl9fbWVyZ2VET01FbGVtZW50cyA9IGZ1bmN0aW9uKGUxLCBlMikgewkKCXJlbW92ZUVtcHR5VGV4dE5vZGVzKGUxKTsKCXJlbW92ZUVtcHR5VGV4dE5vZGVzKGUyKTsKCWlmKHR5cGVvZiBlMSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIGUyID09PSAndW5kZWZpbmVkJyB8fCBlMS5pc0VxdWFsTm9kZShlMikpIHJldHVybjsKCS8vIHJlcGxhY2UgdGhlIHdob2xlIG5vZGUKCWlmKGUxLm5vZGVOYW1lICE9PSBlMi5ub2RlTmFtZSkgewoJCWlmKGUxLnBhcmVudE5vZGUpIHsKCQkJZTEucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoZTIsIGUxKTsKCQl9CgkJcmV0dXJuOwoJfQoJLy8gbm9kZVZhbHVlCglpZihlMS5ub2RlVmFsdWUgIT09IGUyLm5vZGVWYWx1ZSkgewoJCWUxLm5vZGVWYWx1ZSA9IGUyLm5vZGVWYWx1ZTsKCX0KCS8vIGF0dHJpYnV0ZXMKCWlmKGUxLmF0dHJpYnV0ZXMpIHsKCQl2YXIgYXR0cjEgPSBlMS5hdHRyaWJ1dGVzLCBhdHRyMiA9IGUyLmF0dHJpYnV0ZXMsIGExLCBhMiwgZm91bmQgPSB7fTsKCQlmb3IodmFyIGk9MDsgaTxhdHRyMS5sZW5ndGgsIGExPWF0dHIxW2ldOyBpKyspIHsKCQkJZm9yKHZhciBqPTA7IGo8YXR0cjIubGVuZ3RoLCBhMj1hdHRyMltqXTsgaisrKSB7CgkJCQlpZihhMS5uYW1lID09PSBhMi5uYW1lKSB7CgkJCQkJZTEuc2V0QXR0cmlidXRlKGExLm5hbWUsIGEyLnZhbHVlKTsKCQkJCQlmb3VuZFthMS5uYW1lXSA9IHRydWU7CgkJCQkJaWYoYTEubmFtZSA9PT0gJ3ZhbHVlJykgewoJCQkJCQllMS52YWx1ZSA9IGEyLnZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpZighZm91bmRbYTEubmFtZV0pIHsKCQkJCWUxLnJlbW92ZUF0dHJpYnV0ZShhMS5uYW1lKTsKCQkJfQoJCX0KCQlmb3IodmFyIGk9MDsgaTxhdHRyMi5sZW5ndGgsIGEyPWF0dHIyW2ldOyBpKyspIHsKCQkJaWYoIWZvdW5kW2EyLm5hbWVdKSB7CgkJCQllMS5zZXRBdHRyaWJ1dGUoYTIubmFtZSwgYTIudmFsdWUpOwoJCQkJaWYoYTIubmFtZSA9PT0gJ3ZhbHVlJykgewoJCQkJCWUxLnZhbHVlID0gYTIudmFsdWU7CgkJCQl9CgkJCX0KCQl9Cgl9CgkvLyBjaGlsZHMKCXZhciBuZXdOb2Rlc1RvTWVyZ2UgPSBbXTsKCWlmKGUxLmNoaWxkTm9kZXMubGVuZ3RoID49IGUyLmNoaWxkTm9kZXMubGVuZ3RoKSB7CgkJZm9yKHZhciBpPTA7IGk8ZTEuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewoJCQlpZighZTIuY2hpbGROb2Rlc1tpXSkgeyBlMi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiIikpOyB9CgkJCW5ld05vZGVzVG9NZXJnZS5wdXNoKFtlMS5jaGlsZE5vZGVzW2ldLCBlMi5jaGlsZE5vZGVzW2ldXSk7CgkJfQoJfSBlbHNlIHsKCQlmb3IodmFyIGk9MDsgaTxlMi5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7CgkJCWUxLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIiKSk7CQkJCQkJCgkJCW5ld05vZGVzVG9NZXJnZS5wdXNoKFtlMS5jaGlsZE5vZGVzW2ldLCBlMi5jaGlsZE5vZGVzW2ldXSk7CgkJfQoJfQoJZm9yKHZhciBpPTA7IGk8bmV3Tm9kZXNUb01lcmdlLmxlbmd0aDsgaSsrKSB7CgkJYXBpLl9fbWVyZ2VET01FbGVtZW50cyhuZXdOb2Rlc1RvTWVyZ2VbaV1bMF0sIG5ld05vZGVzVG9NZXJnZVtpXVsxXSk7Cgl9Cn07CmFwaS5fX2hhbmRsZUhUTUwgPSBmdW5jdGlvbihuZXh0KSB7Cgl2YXIgc2VsZiA9IHRoaXM7Cgl2YXIgY29tcGlsZSA9IGZ1bmN0aW9uKCkgewoJCWFic3VyZC5mbHVzaCgpLm1vcnBoKCJodG1sIikuYWRkKEhUTUxTb3VyY2UpLmNvbXBpbGUoZnVuY3Rpb24oZXJyLCBodG1sKSB7CgkJCWlmKCFzZWxmLmVsKSB7CgkJCQlzZWxmLmVsID0gc3RyMkRPTUVsZW1lbnQoaHRtbCk7CgkJCX0gZWxzZSB7CgkJCQlhcGkuX19tZXJnZURPTUVsZW1lbnRzKHNlbGYuZWwsIHN0cjJET01FbGVtZW50KGh0bWwpKTsKCQkJfQoJCQluZXh0KCk7CgkJfSwgc2VsZik7Cgl9CglpZih0aGlzLmh0bWwpIHsKCQlpZih0eXBlb2YgdGhpcy5odG1sID09PSAnc3RyaW5nJykgewoJCQlpZighdGhpcy5lbCkgewoJCQkJdmFyIGVsZW1lbnQgPSBxcyh0aGlzLmh0bWwpOwoJCQkJaWYoZWxlbWVudCkgewoJCQkJCXRoaXMuZWwgPSBlbGVtZW50OwoJCQkJCUhUTUxTb3VyY2UgPSB7Jyc6IHRoaXMuZWwub3V0ZXJIVE1MLnJlcGxhY2UoLyZsdDsvZywgJzwnKS5yZXBsYWNlKC8mZ3Q7L2csICc+JykgfTsKCQkJCX0KCQkJfQoJCQljb21waWxlKCk7CgkJfSBlbHNlIGlmKHR5cGVvZiB0aGlzLmh0bWwgPT09ICdvYmplY3QnKSB7CgkJCUhUTUxTb3VyY2UgPSBleHRlbmQoe30sIHRoaXMuaHRtbCk7CgkJCWNvbXBpbGUoKTsJCQoJCX0gZWxzZSB7CgkJCW5leHQoKTsKCQl9Cgl9IGVsc2UgewoJCW5leHQoKTsKCX0KCXJldHVybiB0aGlzOwp9OwphcGkuYXBwbHlIVE1MID0gZnVuY3Rpb24oZGF0YSwgc2tpcEF1dG9Qb3B1bGF0aW9uKSB7Cgl0aGlzLmh0bWwgPSBkYXRhOwoJaWYoIXNraXBBdXRvUG9wdWxhdGlvbikgewoJCXRoaXMucG9wdWxhdGUoKTsKCX0KCXJldHVybiB0aGlzOwp9Owp2YXIJYXBwZW5kZWQgPSBmYWxzZQphcGkuX19hcHBlbmQgPSBmdW5jdGlvbihuZXh0KSB7CglpZighYXBwZW5kZWQgJiYgdGhpcy5lbCAmJiB0aGlzLmdldCgicGFyZW50IikpIHsKCQlhcHBlbmRlZCA9IHRydWU7CgkJdGhpcy5nZXQoInBhcmVudCIpLmFwcGVuZENoaWxkKHRoaXMuZWwpOwoJfQoJbmV4dCgpOwoJcmV0dXJuIHRoaXM7Cn0KdmFyIGNhY2hlID0geyBldmVudHM6IHt9IH07CmFwaS5fX2hhbmRsZUV2ZW50cyA9IGZ1bmN0aW9uKG5leHQpIHsJCQoJaWYodGhpcy5lbCkgewoJCXZhciBzZWxmID0gdGhpczsKCQl2YXIgcmVnaXN0ZXJFdmVudCA9IGZ1bmN0aW9uKGVsKSB7CgkJCXZhciBhdHRyVmFsdWUgPSBlbC5nZXRBdHRyaWJ1dGUoJ2RhdGEtYWJzdXJkLWV2ZW50Jyk7CgkJCXZhciBwcm9jZXNzQXR0cmlidXRlcyA9IGZ1bmN0aW9uKGF0dHJWYWx1ZSkgewoJCQkJYXR0clZhbHVlID0gYXR0clZhbHVlLnNwbGl0KCI6Iik7CgkJCQlpZihhdHRyVmFsdWUubGVuZ3RoID49IDIpIHsKCQkJCQl2YXIgZXZlbnRUeXBlID0gYXR0clZhbHVlWzBdOwoJCQkJCXZhciBtZXRob2ROYW1lID0gYXR0clZhbHVlWzFdOwoJCQkJCWF0dHJWYWx1ZS5zcGxpY2UoMCwgMik7CgkJCQkJdmFyIGFyZ3MgPSBhdHRyVmFsdWU7CgkJCQkJaWYoIWNhY2hlLmV2ZW50c1tldmVudFR5cGVdIHx8IGNhY2hlLmV2ZW50c1tldmVudFR5cGVdLmluZGV4T2YoZWwpIDwgMCkgewoJCQkJCQlpZighY2FjaGUuZXZlbnRzW2V2ZW50VHlwZV0pIGNhY2hlLmV2ZW50c1tldmVudFR5cGVdID0gW107CgkJCQkJCWNhY2hlLmV2ZW50c1tldmVudFR5cGVdLnB1c2goZWwpOwoJCQkJCQlhZGRFdmVudExpc3RlbmVyKGVsLCBldmVudFR5cGUsIGZ1bmN0aW9uKGUpIHsKCQkJCQkJCWlmKHR5cGVvZiBzZWxmW21ldGhvZE5hbWVdID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQkJdmFyIGYgPSBzZWxmW21ldGhvZE5hbWVdOwoJCQkJCQkJCWYuYXBwbHkoc2VsZiwgW2VdLmNvbmNhdChhcmdzKSk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlhdHRyVmFsdWUgPSBhdHRyVmFsdWUuc3BsaXQoLywgPy9nKTsKCQkJZm9yKHZhciBpPTA7IGk8YXR0clZhbHVlLmxlbmd0aDsgaSsrKSBwcm9jZXNzQXR0cmlidXRlcyhhdHRyVmFsdWVbaV0pOwoJCX0KCQlpZih0aGlzLmVsLmhhc0F0dHJpYnV0ZSAmJiB0aGlzLmVsLmhhc0F0dHJpYnV0ZSgnZGF0YS1hYnN1cmQtZXZlbnQnKSkgewoJCQlyZWdpc3RlckV2ZW50KHRoaXMuZWwpOwoJCX0KCQl2YXIgZWxzID0gdGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsID8gdGhpcy5lbC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1hYnN1cmQtZXZlbnRdJykgOiBbXTsKCQlmb3IodmFyIGk9MDsgaTxlbHMubGVuZ3RoOyBpKyspIHsKCQkJcmVnaXN0ZXJFdmVudChlbHNbaV0pOwoJCX0KCX0KCW5leHQoKTsKCXJldHVybiB0aGlzOwp9CmFwaS5fX2dldEFuaW1BbmRUcmFuc0VuZEV2ZW50TmFtZSA9IGZ1bmN0aW9uKGVsKSB7CglpZighZWwpIHJldHVybjsKICAgIHZhciBhOwogICAgdmFyIGFuaW1hdGlvbnMgPSB7CiAgICAgICdhbmltYXRpb24nOiBbJ2FuaW1hdGlvbmVuZCcsICd0cmFuc2l0aW9uZW5kJ10sCiAgICAgICdPQW5pbWF0aW9uJzogWydvQW5pbWF0aW9uRW5kJywgJ29UcmFuc2l0aW9uRW5kJ10sCiAgICAgICdNb3pBbmltYXRpb24nOiBbJ2FuaW1hdGlvbmVuZCcsICd0cmFuc2l0aW9uZW5kJ10sCiAgICAgICdXZWJraXRBbmltYXRpb24nOiBbJ3dlYmtpdEFuaW1hdGlvbkVuZCcsICd3ZWJraXRUcmFuc2l0aW9uRW5kJ10KICAgIH0KICAgIGZvcihhIGluIGFuaW1hdGlvbnMpewogICAgICAgIGlmKCBlbC5zdHlsZVthXSAhPT0gdW5kZWZpbmVkICl7CiAgICAgICAgICAgIHJldHVybiBhbmltYXRpb25zW2FdOwogICAgICAgIH0KICAgIH0KfQphcGkub25BbmltYXRpb25FbmQgPSBmdW5jdGlvbihlbCwgZnVuYykgewoJaWYoYXJndW1lbnRzLmxlbmd0aCA9PSAxKSB7CgkJZnVuYyA9IGVsOwoJCWVsID0gdGhpcy5lbDsKCX0KCXZhciBzZWxmID0gdGhpczsKCXZhciBldmVudE5hbWUgPSBhcGkuX19nZXRBbmltQW5kVHJhbnNFbmRFdmVudE5hbWUoZWwpOwoJaWYoIWV2ZW50TmFtZSkgeyBmdW5jLmFwcGx5KHRoaXMsIFt7ZXJyb3I6ICdBbmltYXRpb25zIG5vdCBzdXBwb3J0ZWQuJ31dKTsgcmV0dXJuOyB9OwoJdGhpcy5hZGRFdmVudExpc3RlbmVyKGVsLCBldmVudE5hbWVbMF0sIGZ1bmN0aW9uKGUpIHsKCQlmdW5jLmFwcGx5KHNlbGYsIFtlXSk7Cgl9KTsKfQphcGkub25UcmFuc2l0aW9uRW5kID0gZnVuY3Rpb24oZWwsIGZ1bmMpIHsKCWlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCWZ1bmMgPSBlbDsKCQllbCA9IHRoaXMuZWw7Cgl9Cgl2YXIgc2VsZiA9IHRoaXM7Cgl2YXIgZXZlbnROYW1lID0gYXBpLl9fZ2V0QW5pbUFuZFRyYW5zRW5kRXZlbnROYW1lKGVsKTsKCWlmKCFldmVudE5hbWUpIHsgZnVuYy5hcHBseSh0aGlzLCBbe2Vycm9yOiAnQW5pbWF0aW9ucyBub3Qgc3VwcG9ydGVkLid9XSk7IHJldHVybjsgfTsKCXRoaXMuYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnROYW1lWzFdLCBmdW5jdGlvbihlKSB7CgkJZnVuYy5hcHBseShzZWxmLCBbZV0pOwoJfSk7Cn0KdmFyCWFzeW5jID0geyBmdW5jczoge30sIGluZGV4OiAwIH07CmFwaS5fX2hhbmRsZUFzeW5jRnVuY3Rpb25zID0gZnVuY3Rpb24obmV4dCkgewoJaWYodGhpcy5lbCkgewoJCXZhciBmdW5jcyA9IFtdOwoJCWlmKHRoaXMuZWwuaGFzQXR0cmlidXRlICYmIHRoaXMuZWwuaGFzQXR0cmlidXRlKCJkYXRhLWFic3VyZC1hc3luYyIpKSB7CgkJCWZ1bmNzLnB1c2godGhpcy5lbCk7CgkJfSBlbHNlIHsKCQkJdmFyIGVscyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCA/IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYWJzdXJkLWFzeW5jXScpIDogW107CgkJCWZvcih2YXIgaT0wOyBpPGVscy5sZW5ndGg7IGkrKykgewoJCQkJZnVuY3MucHVzaChlbHNbaV0pOwoJCQl9CgkJfQkJCgkJaWYoZnVuY3MubGVuZ3RoID09PSAwKSB7CgkJCW5leHQoKTsKCQl9IGVsc2UgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCShmdW5jdGlvbiBjYWxsRnVuY3MoKSB7CgkJCQlpZihmdW5jcy5sZW5ndGggPT09IDApIHsJCQkJCQkKCQkJCQluZXh0KCk7CgkJCQl9IGVsc2UgewoJCQkJCXZhciBlbCA9IGZ1bmNzLnNoaWZ0KCksCgkJCQkJCXZhbHVlID0gZWwuZ2V0QXR0cmlidXRlKCJkYXRhLWFic3VyZC1hc3luYyIpLAoJCQkJCQlyZXBsYWNlTm9kZXMgPSBmdW5jdGlvbihjaGlsZEVsZW1lbnQpIHsKCQkJCQkJCWlmKHR5cGVvZiBjaGlsZEVsZW1lbnQgPT09ICdzdHJpbmcnKSB7CgkJCQkJCQkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoc3RyMkRPTUVsZW1lbnQoY2hpbGRFbGVtZW50KSwgZWwpOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQllbC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChjaGlsZEVsZW1lbnQsIGVsKTsKCQkJCQkJCX0KCQkJCQkJCWNhbGxGdW5jcygpOwoJCQkJCQl9OwoJCQkJCWlmKHR5cGVvZiBzZWxmW2FzeW5jLmZ1bmNzW3ZhbHVlXS5uYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQlzZWxmW2FzeW5jLmZ1bmNzW3ZhbHVlXS5uYW1lXS5hcHBseShzZWxmLCBbcmVwbGFjZU5vZGVzXS5jb25jYXQoYXN5bmMuZnVuY3NbdmFsdWVdLmFyZ3MpKTsKCQkJCQl9IGVsc2UgaWYodHlwZW9mIGFzeW5jLmZ1bmNzW3ZhbHVlXS5mdW5jID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCWFzeW5jLmZ1bmNzW3ZhbHVlXS5mdW5jLmFwcGx5KHNlbGYsIFtyZXBsYWNlTm9kZXNdLmNvbmNhdChhc3luYy5mdW5jc1t2YWx1ZV0uYXJncykpOwoJCQkJCX0KCQkJCX0KCQkJfSkoKTsKCQl9CQkJCgl9IGVsc2UgewoJCW5leHQoKTsKCX0JCglyZXR1cm4gdGhpczsJCn0KYXBpLmFzeW5jID0gZnVuY3Rpb24oKSB7Cgl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCksCgkJZnVuYyA9IGFyZ3Muc2hpZnQoKSwKCQlpbmRleCA9ICdfJyArIChhc3luYy5pbmRleCsrKTsKCWFzeW5jLmZ1bmNzW2luZGV4XSA9IHthcmdzOiBhcmdzLCBuYW1lOiBmdW5jfTsKCXJldHVybiAnPHNjcmlwdCBkYXRhLWFic3VyZC1hc3luYz0iJyArIGluZGV4ICsgJyI+PC9zY3JpcHQ+JzsKfTsKYXBpLmNoaWxkID0gZnVuY3Rpb24oKSB7Cgl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCksCgkJY2hpbGRyZW4gPSB0aGlzLmdldCgiY2hpbGRyZW4iKSwKCQljb21wb25lbnQgPSBjaGlsZHJlbiAmJiBjaGlsZHJlblthcmdzLnNoaWZ0KCldLAoJCWluZGV4ID0gJ18nICsgKGFzeW5jLmluZGV4KyspOwoJYXN5bmMuZnVuY3NbaW5kZXhdID0ge2FyZ3M6IGFyZ3MsIGZ1bmM6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJY29tcG9uZW50LnBvcHVsYXRlKHtjYWxsYmFjazogZnVuY3Rpb24oZGF0YSkgewoJCQljYWxsYmFjayhkYXRhLmh0bWwuZWxlbWVudCk7CgkJfX0pOwoJfX07CglyZXR1cm4gJzxzY3JpcHQgZGF0YS1hYnN1cmQtYXN5bmM9IicgKyBpbmRleCArICciPjwvc2NyaXB0Pic7Cn07CmFwaS53aXJlID0gZnVuY3Rpb24oZXZlbnQpIHsKCWFic3VyZC5jb21wb25lbnRzLmV2ZW50cy5vbihldmVudCwgdGhpc1tldmVudF0gfHwgZnVuY3Rpb24oKSB7fSwgdGhpcyk7CglyZXR1cm4gdGhpczsKfTsKdmFyIGlzUG9wdWxhdGVJblByb2dyZXNzID0gZmFsc2U7CmFwaS5wb3B1bGF0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKCWlmKGlzUG9wdWxhdGVJblByb2dyZXNzKSByZXR1cm47Cglpc1BvcHVsYXRlSW5Qcm9ncmVzcyA9IHRydWU7CglxdWV1ZShbCgkJYXBpLl9faGFuZGxlQ1NTLAoJCWFwaS5fX2hhbmRsZUhUTUwsCgkJYXBpLl9fYXBwZW5kLCAKCQlhcGkuX19oYW5kbGVFdmVudHMsCgkJYXBpLl9faGFuZGxlQXN5bmNGdW5jdGlvbnMsCgkJZnVuY3Rpb24oKSB7CgkJCWlzUG9wdWxhdGVJblByb2dyZXNzID0gZmFsc2U7CgkJCWFzeW5jID0geyBmdW5jczoge30sIGluZGV4OiAwIH0KCQkJdmFyIGRhdGEgPSB7CgkJCQljc3M6IENTUywgCgkJCQlodG1sOiB7IAoJCQkJCWVsZW1lbnQ6IHRoaXMuZWwgCgkJCQl9CgkJCX07CgkJCXRoaXMuZGlzcGF0Y2goInBvcHVsYXRlZCIsIGRhdGEpOwoJCQlpZihvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLmNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7IG9wdGlvbnMuY2FsbGJhY2soZGF0YSk7IH0KCQl9CgldLCB0aGlzKTsKCXJldHVybiB0aGlzOwp9OwphcGkuc3RyMkRPTUVsZW1lbnQgPSBzdHIyRE9NRWxlbWVudDsKYXBpLmFkZEV2ZW50TGlzdGVuZXIgPSBhZGRFdmVudExpc3RlbmVyOwphcGkucXVldWUgPSBxdWV1ZTsKYXBpLnFzID0gcXM7CmFwaS5xc2EgPSBxc2E7CmFwaS5nZXRTdHlsZSA9IGdldFN0eWxlOwphcGkuYWRkQ2xhc3MgPSBhZGRDbGFzczsKYXBpLnJlbW92ZUNsYXNzID0gcmVtb3ZlQ2xhc3M7CmFwaS5yZXBsYWNlQ2xhc3MgPSByZXBsYWNlQ2xhc3M7CmFwaS5iaW5kID0gYmluZDsKYXBpLnRvZ2dsZUNsYXNzID0gdG9nZ2xlQ2xhc3M7CmFwaS5jb21waWxlSFRNTCA9IGZ1bmN0aW9uKEhUTUwsIGNhbGxiYWNrLCBkYXRhKSB7CglhYnN1cmQuZmx1c2goKS5tb3JwaCgiaHRtbCIpLmFkZChIVE1MKS5jb21waWxlKGNhbGxiYWNrLCBkYXRhKTsKfTsKYXBpLmNvbXBpbGVDU1MgPSBmdW5jdGlvbihDU1MsIGNhbGxiYWNrLCBvcHRpb25zKSB7CglhYnN1cmQuZmx1c2goKS5hZGQoQ1NTKS5jb21waWxlKGNhbGxiYWNrLCBvcHRpb25zKTsKfTsKYXBpLmRlbGF5ID0gZnVuY3Rpb24odGltZSwgZm4sIGFyZ3MpIHsKCXZhciBzZWxmID0gdGhpczsKCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJZm4uYXBwbHkoc2VsZiwgYXJncyk7Cgl9LCB0aW1lKTsKfQoJcmV0dXJuIGFwaTsKfTsKdmFyIGluamVjdGluZyA9IGZ1bmN0aW9uKGFic3VyZCkgewphYnN1cmQuZGkucmVnaXN0ZXIoJ2lzJywgewoJYXBwZW5kZWQ6IGZ1bmN0aW9uKHNlbGVjdG9yKSB7CgkJaWYodHlwZW9mIHNlbGVjdG9yID09ICd1bmRlZmluZWQnKSBzZWxlY3RvciA9IHRoaXMuaG9zdC5odG1sOwoJCXJldHVybiBxcyhzZWxlY3RvcikgPyB0cnVlIDogZmFsc2U7Cgl9LAoJaGlkZGVuOiBmdW5jdGlvbihlbCkgewoJCWVsID0gZWwgfHwgdGhpcy5ob3N0LmVsOwoJCXJldHVybiBlbC5vZmZzZXRQYXJlbnQgPT09IG51bGw7Cgl9Cn0pOwphYnN1cmQuZGkucmVnaXN0ZXIoJ3JvdXRlcicsIHsKCXJvdXRlczogW10sCgltb2RlOiBudWxsLAoJcm9vdDogJy8nLAoJZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBmcmFnbWVudCA9ICcnOwoJCWlmKHRoaXMubW9kZSA9PT0gJ2hpc3RvcnknKSB7CgkJCWlmKCFsb2NhdGlvbikgcmV0dXJuICcnOwoJCQlmcmFnbWVudCA9IHRoaXMuY2xlYXJTbGFzaGVzKGRlY29kZVVSSShsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaCkpOwoJCQlmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UoL1w/KC4qKSQvLCAnJyk7CgkJCWZyYWdtZW50ID0gdGhpcy5yb290ICE9ICcvJyA/IGZyYWdtZW50LnJlcGxhY2UodGhpcy5yb290LCAnJykgOiBmcmFnbWVudDsKCQl9IGVsc2UgewoJCQlpZighd2luZG93KSByZXR1cm4gJyc7CgkJCXZhciBtYXRjaCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC8jKC4qKSQvKTsKCQkJZnJhZ21lbnQgPSBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CgkJfQoJCXJldHVybiB0aGlzLmNsZWFyU2xhc2hlcyhmcmFnbWVudCk7Cgl9LAogICAgY2xlYXJTbGFzaGVzOiBmdW5jdGlvbihwYXRoKSB7CiAgICAJcmV0dXJuIHBhdGgudG9TdHJpbmcoKS5yZXBsYWNlKC9cLyQvLCAnJykucmVwbGFjZSgvXlwvLywgJycpOwogICAgfSwKCWFkZDogZnVuY3Rpb24ocmUsIGhhbmRsZXIpIHsKCQlpZih0eXBlb2YgcmUgPT0gJ2Z1bmN0aW9uJykgewoJCQloYW5kbGVyID0gcmU7CgkJCXJlID0gJyc7CgkJfQoJCXRoaXMucm91dGVzLnB1c2goeyByZTogcmUsIGhhbmRsZXI6IGhhbmRsZXJ9KTsKCQlyZXR1cm4gdGhpczsKCX0sCglyZW1vdmU6IGZ1bmN0aW9uKHBhcmFtKSB7CgkJZm9yKHZhciBpPTAsIHI7IGk8dGhpcy5yb3V0ZXMubGVuZ3RoLCByID0gdGhpcy5yb3V0ZXNbaV07IGkrKykgewoJCQlpZihyLmhhbmRsZXIgPT09IHBhcmFtIHx8IHIucmUgPT09IHBhcmFtKSB7CgkJCQl0aGlzLnJvdXRlcy5zcGxpY2UoaSwgMSk7IAoJCQkJcmV0dXJuIHRoaXM7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoJZmx1c2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMucm91dGVzID0gW107CgkJdGhpcy5tb2RlID0gbnVsbDsKCQl0aGlzLnJvb3QgPSAnLyc7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJY29uZmlnOiBmdW5jdGlvbihvcHRpb25zKSB7CgkJdGhpcy5tb2RlID0gb3B0aW9ucyAmJiBvcHRpb25zLm1vZGUgJiYgb3B0aW9ucy5tb2RlID09ICdoaXN0b3J5JyAmJiAhIShoaXN0b3J5LnB1c2hTdGF0ZSkgPyAnaGlzdG9yeScgOiAnaGFzaCc7CgkJdGhpcy5yb290ID0gb3B0aW9ucyAmJiBvcHRpb25zLnJvb3QgPyAnLycgKyB0aGlzLmNsZWFyU2xhc2hlcyhvcHRpb25zLnJvb3QpICsgJy8nIDogJy8nOwoJCXJldHVybiB0aGlzOwoJfSwKCWxpc3RlbjogZnVuY3Rpb24obG9vcEludGVydmFsKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCXZhciBjdXJyZW50ID0gc2VsZi5nZXRGcmFnbWVudCgpOwoJCXZhciBmbiA9IGZ1bmN0aW9uKCkgewoJCQlpZihjdXJyZW50ICE9PSBzZWxmLmdldEZyYWdtZW50KCkpIHsKCQkJCWN1cnJlbnQgPSBzZWxmLmdldEZyYWdtZW50KCk7CgkJCQlzZWxmLmNoZWNrKGN1cnJlbnQpOwoJCQl9CgkJfQoJCWNsZWFySW50ZXJ2YWwodGhpcy5pbnRlcnZhbCk7CgkJdGhpcy5pbnRlcnZhbCA9IHNldEludGVydmFsKGZuLCBsb29wSW50ZXJ2YWwgfHwgNTApOwoJCXJldHVybiB0aGlzOwoJfSwKCWNoZWNrOiBmdW5jdGlvbihmKSB7CgkJdmFyIGZyYWdtZW50ID0gZiB8fCB0aGlzLmdldEZyYWdtZW50KCk7CgkJZm9yKHZhciBpPTA7IGk8dGhpcy5yb3V0ZXMubGVuZ3RoOyBpKyspIHsKCQkJdmFyIG1hdGNoID0gZnJhZ21lbnQubWF0Y2godGhpcy5yb3V0ZXNbaV0ucmUpOwoJCQlpZihtYXRjaCkgewoJCQkJbWF0Y2guc2hpZnQoKTsKCQkJCXRoaXMucm91dGVzW2ldLmhhbmRsZXIuYXBwbHkodGhpcy5ob3N0IHx8IHt9LCBtYXRjaCk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfQkJCQoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgluYXZpZ2F0ZTogZnVuY3Rpb24ocGF0aCkgewoJCXBhdGggPSBwYXRoID8gcGF0aCA6ICcnOwoJCWlmKHRoaXMubW9kZSA9PT0gJ2hpc3RvcnknKSB7CgkJCWhpc3RvcnkucHVzaFN0YXRlKG51bGwsIG51bGwsIHRoaXMucm9vdCArIHRoaXMuY2xlYXJTbGFzaGVzKHBhdGgpKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJCXdpbmRvdy5sb2NhdGlvbi5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWYucmVwbGFjZSgvIyguKikkLywgJycpICsgJyMnICsgcGF0aDsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cn0pOwphYnN1cmQuZGkucmVnaXN0ZXIoJ2FqYXgnLCB7CglyZXF1ZXN0OiBmdW5jdGlvbihvcHMpIHsKCgkJaWYodHlwZW9mIG9wcyA9PSAnc3RyaW5nJykgb3BzID0geyB1cmw6IG9wcyB9OwoJCW9wcy51cmwgPSBvcHMudXJsIHx8ICcnOwoJCW9wcy5tZXRob2QgPSBvcHMubWV0aG9kIHx8ICdnZXQnCgkJb3BzLmRhdGEgPSBvcHMuZGF0YSB8fCB7fTsKCgkJdmFyIGdldFBhcmFtcyA9IGZ1bmN0aW9uKGRhdGEsIHVybCkgewoJCQl2YXIgYXJyID0gW10sIHN0cjsKCQkJZm9yKHZhciBuYW1lIGluIGRhdGEpIHsKCQkJCWFyci5wdXNoKG5hbWUgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZGF0YVtuYW1lXSkpOwoJCQl9CgkJCXN0ciA9IGFyci5qb2luKCcmJyk7CgkJCWlmKHN0ciAhPSAnJykgewoJCQkJcmV0dXJuIHVybCA/ICh1cmwuaW5kZXhPZignPycpIDwgMCA/ICc/JyArIHN0ciA6ICcmJyArIHN0cikgOiBzdHI7CgkJCX0KCQkJcmV0dXJuICcnOwoJCX0KCgkJdmFyIGFwaSA9IHsKCQkJaG9zdDogdGhpcy5ob3N0IHx8IHt9LAoJCQlwcm9jZXNzOiBmdW5jdGlvbihvcHMpIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCXRoaXMueGhyID0gbnVsbDsKCQkJCWlmKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7IHRoaXMueGhyID0gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7IH0KCQkJCWVsc2UgaWYod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7IHRoaXMueGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7IH0KCQkJCWlmKHRoaXMueGhyKSB7CgkJCQkJdGhpcy54aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCQkJCWlmKHNlbGYueGhyLnJlYWR5U3RhdGUgPT0gNCAmJiBzZWxmLnhoci5zdGF0dXMgPT0gMjAwKSB7CgkJCQkJCQl2YXIgcmVzdWx0ID0gc2VsZi54aHIucmVzcG9uc2VUZXh0OwoJCQkJCQkJaWYob3BzLmpzb24gPT09IHRydWUgJiYgdHlwZW9mIEpTT04gIT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJCQlyZXN1bHQgPSBKU09OLnBhcnNlKHJlc3VsdCk7CgkJCQkJCQl9CgkJCQkJCQlzZWxmLmRvbmVDYWxsYmFjayAmJiBzZWxmLmRvbmVDYWxsYmFjay5hcHBseShzZWxmLmhvc3QsIFtyZXN1bHQsIHNlbGYueGhyXSk7CgkJCQkJCX0gZWxzZSBpZihzZWxmLnhoci5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJCXNlbGYuZmFpbENhbGxiYWNrICYmIHNlbGYuZmFpbENhbGxiYWNrLmFwcGx5KHNlbGYuaG9zdCwgW3NlbGYueGhyXSk7CgkJCQkJCX0KCQkJCQkJc2VsZi5hbHdheXNDYWxsYmFjayAmJiBzZWxmLmFsd2F5c0NhbGxiYWNrLmFwcGx5KHNlbGYuaG9zdCwgW3NlbGYueGhyXSk7CgkJCQkJfQoJCQkJCQoJCQkJCWlmKG9wcy5tZXRob2QgPT0gJ2dldCcpIHsKCQkJCQkJdGhpcy54aHIub3BlbigiR0VUIiwgb3BzLnVybCArIGdldFBhcmFtcyhvcHMuZGF0YSwgb3BzLnVybCksIHRydWUpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRoaXMueGhyLm9wZW4ob3BzLm1ldGhvZCwgb3BzLnVybCwgdHJ1ZSk7CgkJCQkJCXRoaXMuc2V0SGVhZGVycyh7CgkJCQkJCQknWC1SZXF1ZXN0ZWQtV2l0aCc6ICdYTUxIdHRwUmVxdWVzdCcsCgkJCQkJCQknQ29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcKCQkJCQkJfSk7CgkJCQkJfQoJCQkJCWlmKG9wcy5oZWFkZXJzICYmIHR5cGVvZiBvcHMuaGVhZGVycyA9PSAnb2JqZWN0JykgewoJCQkJCQl0aGlzLnNldEhlYWRlcnMob3BzLmhlYWRlcnMpOwoJCQkJCX0JCQoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IAoJCQkJCQlvcHMubWV0aG9kID09ICdnZXQnID8gc2VsZi54aHIuc2VuZCgpIDogc2VsZi54aHIuc2VuZChnZXRQYXJhbXMob3BzLmRhdGEpKTsgCgkJCQkJfSwgMjApOwkKCQkJCX0KCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQlkb25lOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCQkJdGhpcy5kb25lQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQlmYWlsOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCQkJdGhpcy5mYWlsQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQkJCXJldHVybiB0aGlzOwoJCQl9LAoJCQlhbHdheXM6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CgkJCQl0aGlzLmFsd2F5c0NhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJc2V0SGVhZGVyczogZnVuY3Rpb24oaGVhZGVycykgewoJCQkJZm9yKHZhciBuYW1lIGluIGhlYWRlcnMpIHsKCQkJCQl0aGlzLnhociAmJiB0aGlzLnhoci5zZXRSZXF1ZXN0SGVhZGVyKG5hbWUsIGhlYWRlcnNbbmFtZV0pOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gYXBpLnByb2Nlc3Mob3BzKTsKCgl9Cn0pOwp2YXIgZG9tID0gZnVuY3Rpb24oZWwsIHBhcmVudCkgewoJdmFyIGhvc3QgPSBkb20ucHJvdG90eXBlLmhvc3Q7Cgl2YXIgYXBpID0geyBlbDogbnVsbCB9OwoJLy8gZGVmaW5pbmcgdGhlIHNjb3BlCglzd2l0Y2godHlwZW9mIGVsKSB7CgkJY2FzZSAndW5kZWZpbmVkJzoKCQkJYXBpLmVsID0gaG9zdC5lbDsKCQlicmVhazsKCQljYXNlICdzdHJpbmcnOgoJCQlwYXJlbnQgPSBwYXJlbnQgJiYgdHlwZW9mIHBhcmVudCA9PT0gJ3N0cmluZycgPyBxcy5hcHBseShob3N0LCBbcGFyZW50XSkgOiBwYXJlbnQ7CgkJCWFwaS5lbCA9IHFzKGVsLCBwYXJlbnQgfHwgaG9zdC5lbCB8fCBkb2N1bWVudCk7CgkJYnJlYWs7CgkJY2FzZSAnb2JqZWN0JzogCgkJCWlmKHR5cGVvZiBlbC5ub2RlTmFtZSAhPSAndW5kZWZpbmVkJykgewoJICAgICAgICAgICAgYXBpLmVsID0gZWw7CgkgICAgICAgIH0gZWxzZSB7CgkgICAgICAgIAl2YXIgbG9vcCA9IGZ1bmN0aW9uKHZhbHVlLCBvYmopIHsKICAgICAgICAgICAgCQlvYmogPSBvYmogfHwgdGhpczsKICAgICAgICAgICAgCQlmb3IodmFyIHByb3AgaW4gb2JqKSB7CiAgICAgICAgCQkJCWlmKHR5cGVvZiBvYmpbcHJvcF0uZWwgIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAJCQkJCW9ialtwcm9wXSA9IG9ialtwcm9wXS52YWwodmFsdWUpOwogICAgICAgIAkJCQl9IGVsc2UgaWYodHlwZW9mIG9ialtwcm9wXSA9PSAnb2JqZWN0JykgewogICAgICAgIAkJCQkJb2JqW3Byb3BdID0gbG9vcCh2YWx1ZSwgb2JqW3Byb3BdKTsKICAgICAgICAJCQkJfQogICAgICAgICAgICAJCX0KICAgICAgICAgICAgCQlkZWxldGUgb2JqLnZhbDsKICAgICAgICAgICAgCQlyZXR1cm4gb2JqOwoJICAgICAgICAJfQoJICAgICAgICAgICAgdmFyIHJlcyA9IHsgdmFsOiBsb29wIH07CgkgICAgICAgICAgICBmb3IodmFyIGtleSBpbiBlbCkgewoJICAgICAgICAgICAgICAgIHJlc1trZXldID0gZG9tLmFwcGx5KHRoaXMsIFtlbFtrZXldXSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gcmVzOwoJICAgICAgICB9CgkJYnJlYWs7Cgl9CgkvLyBnZXR0aW5nIG9yIHNldHRpbmcgYSB2YWx1ZQoJYXBpLnZhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJaWYoIXRoaXMuZWwpIHJldHVybiBudWxsOwoJCXZhciBzZXQgPSAhIXZhbHVlOwoJCXZhciB1c2VWYWx1ZVByb3BlcnR5ID0gZnVuY3Rpb24odmFsdWUpIHsKCQkJaWYoc2V0KSB7IHRoaXMuZWwudmFsdWUgPSB2YWx1ZTsgcmV0dXJuIGFwaTsgfQoJCQllbHNlIHsgcmV0dXJuIHRoaXMuZWwudmFsdWU7IH0KCQl9CiAgICAgICAgc3dpdGNoKHRoaXMuZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgIAljYXNlICdpbnB1dCc6CiAgICAgICAgCQl2YXIgdHlwZSA9IHRoaXMuZWwuZ2V0QXR0cmlidXRlKCd0eXBlJyk7CiAgICAgICAgCQlpZih0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSB7CgkgICAgICAgICAgICAgICAgdmFyIGVscyA9IHFzYSgnW25hbWU9IicgKyB0aGlzLmVsLmdldEF0dHJpYnV0ZSgnbmFtZScpICsgJyJdJywgcGFyZW50KTsKCSAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gW107CgkgICAgICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8ZWxzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgICAgIGlmKHNldCAmJiBlbHNbaV0uY2hlY2tlZCAmJiBlbHNbaV0udmFsdWUgIT09IHZhbHVlKSB7CgkgICAgICAgICAgICAgICAgICAgICAgICBlbHNbaV0ucmVtb3ZlQXR0cmlidXRlKCdjaGVja2VkJyk7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihzZXQgJiYgZWxzW2ldLnZhbHVlID09PSB2YWx1ZSkgewoJICAgICAgICAgICAgICAgICAgICAJZWxzW2ldLnNldEF0dHJpYnV0ZSgnY2hlY2tlZCcsICdjaGVja2VkJyk7CgkgICAgICAgICAgICAgICAgICAgIAllbHNbaV0uY2hlY2tlZCA9ICdjaGVja2VkJzsKCSAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmKGVsc1tpXS5jaGVja2VkKSB7CgkgICAgICAgICAgICAgICAgICAgIAl2YWx1ZXMucHVzaChlbHNbaV0udmFsdWUpOwoJICAgICAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIGlmKCFzZXQpIHsgcmV0dXJuIHR5cGUgPT0gJ3JhZGlvJyA/IHZhbHVlc1swXSA6IHZhbHVlczsgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIAlyZXR1cm4gdXNlVmFsdWVQcm9wZXJ0eS5hcHBseSh0aGlzLCBbdmFsdWVdKTsKCSAgICAgICAgICAgIH0KICAgICAgICAJYnJlYWs7CiAgICAgICAgCWNhc2UgJ3RleHRhcmVhJzogcmV0dXJuIHVzZVZhbHVlUHJvcGVydHkuYXBwbHkodGhpcywgW3ZhbHVlXSk7IGJyZWFrOwogICAgICAgIAljYXNlICdzZWxlY3QnOgogICAgICAgIAkJaWYoc2V0KSB7CiAgICAgICAgICAgIAkJdmFyIG9wdGlvbnMgPSBxc2EoJ29wdGlvbicsIHRoaXMuZWwpOwogICAgICAgICAgICAJCWZvcih2YXIgaT0wOyBpPG9wdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgCQkJaWYob3B0aW9uc1tpXS5nZXRBdHRyaWJ1dGUoJ3ZhbHVlJykgPT09IHZhbHVlKSB7CiAgICAgICAgICAgIAkJCQl0aGlzLmVsLnNlbGVjdGVkSW5kZXggPSBpOwogICAgICAgICAgICAJCQl9IGVsc2UgewogICAgICAgICAgICAJCQkJb3B0aW9uc1tpXS5yZW1vdmVBdHRyaWJ1dGUoJ3NlbGVjdGVkJyk7CiAgICAgICAgICAgIAkJCX0KICAgICAgICAgICAgCQl9CiAgICAgICAgICAgIAl9IGVsc2UgewogICAgICAgICAgICAgICAgCXJldHVybiB0aGlzLmVsLnZhbHVlOwogICAgICAgICAgICAJfQogICAgICAgIAlicmVhazsKICAgICAgICAJZGVmYXVsdDogCiAgICAgICAgCQlpZihzZXQpIHsKICAgICAgICAJCQl0aGlzLmVsLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIAkJfSBlbHNlIHsKCSAgICAgICAgCQlpZih0eXBlb2YgdGhpcy5lbC50ZXh0Q29udGVudCAhPSAndW5kZWZpbmVkJykgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbC50ZXh0Q29udGVudDsKCQkgICAgICAgICAgICB9IGVsc2UgaWYodHlwZW9mIHRoaXMuZWwuaW5uZXJUZXh0ICE9ICd1bmRlZmluZWQnKSB7CgkJICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdGhpcy5lbC5pbm5lclRleHQ7CgkJICAgICAgICAgICAgfSBlbHNlIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWwuaW5uZXJIVE1MOwoJCSAgICAgICAgICAgIH0KCSAgICAgICAgCX0KICAgICAgICAJYnJlYWs7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzZXQgPyBhcGkgOiBudWxsOwoJfQoJLy8gY2hhaW5pbmcgZG9tIG1vZHVsZQoJYXBpLmRvbSA9IGZ1bmN0aW9uKGVsLCBwYXJlbnQpIHsKCQlyZXR1cm4gZG9tKGVsLCBwYXJlbnQgfHwgYXBpLmVsKTsKCX0KCXJldHVybiBhcGk7Cn0KYWJzdXJkLmRpLnJlZ2lzdGVyKCdkb20nLCBkb20pOwp2YXIgbXEgPSBmdW5jdGlvbihxdWVyeSwgY2FsbGJhY2ssIHVzZVBvbHlmaWxsKSB7Cgl2YXIgaG9zdCA9IG1xLnByb3RvdHlwZS5ob3N0OwoJdmFyIGlzTWF0Y2hNZWRpYVN1cHBvcnRlZCA9ICEhKHdpbmRvdyAmJiB3aW5kb3cubWF0Y2hNZWRpYSkgJiYgIXVzZVBvbHlmaWxsOwoJaWYoaXNNYXRjaE1lZGlhU3VwcG9ydGVkKSB7CgkJdmFyIHJlcyA9IHdpbmRvdy5tYXRjaE1lZGlhKHF1ZXJ5KTsKCQljYWxsYmFjay5hcHBseShob3N0LCBbcmVzLm1hdGNoZXMsIHJlcy5tZWRpYV0pOwoJCXJlcy5hZGRMaXN0ZW5lcihmdW5jdGlvbihjaGFuZ2VkKSB7CgkJCWNhbGxiYWNrLmFwcGx5KGhvc3QsIFtjaGFuZ2VkLm1hdGNoZXMsIGNoYW5nZWQubWVkaWFdKTsKCQl9KTsKCX0gZWxzZSB7CgkJdmFyIGlkID0gIi5tYXRjaC1tZWRpYS0iICsgYWJzdXJkLmNvbXBvbmVudHMubnVtT2ZDb21wb25lbnRzOwoJCXZhciBjc3MgPSB7fSwgaHRtbCA9IHt9OwoJCWNzc1tpZF0gPSB7IGRpc3BsYXk6ICdibG9jaycgfTsKCQljc3NbaWRdWydAbWVkaWEgJyArIHF1ZXJ5XSA9IHsgZGlzcGxheTogJ25vbmUnIH07CgkJaHRtbFsnc3BhbicgKyBpZF0gPSAnJzsKCQlhYnN1cmQuY29tcG9uZW50KGlkICsgJy1jb21wb25lbnQnLCB7CgkJCWNzczogY3NzLAoJCQlodG1sOiBodG1sLAoJCQlpbnRlcnZhbGlUaW1lOiAzMCwKCQkJc3RhdHVzOiAnJywKCQkJbG9vcDogZnVuY3Rpb24oZG9tKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQlpZih0aGlzLmVsKSB7CgkJCQkJdmFyIGQgPSB0aGlzLmdldFN0eWxlKCdkaXNwbGF5Jyk7CgkJCQkJaWYodGhpcy5zdGF0dXMgIT0gZCkgewoJCQkJCQl0aGlzLnN0YXR1cyA9IGQ7CgkJCQkJCWNhbGxiYWNrLmFwcGx5KGhvc3QsIFtkID09PSAnbm9uZSddKQoJCQkJCX0KCQkJCX0KCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNlbGYubG9vcCgpOyB9LCB0aGlzLmludGVydmFsaVRpbWUpOwoJCQl9LAoJCQljb25zdHJ1Y3RvcjogWydkb20nLCBmdW5jdGlvbihkb20pIHsKCQkJCXZhciBzZWxmID0gdGhpczsKCQkJCXRoaXMuc2V0KCdwYXJlbnQnLCBkb20oJ2JvZHknKS5lbCkucG9wdWxhdGUoKTsKCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHNlbGYubG9vcCgpOyB9LCB0aGlzLmludGVydmFsaVRpbWUpOwoJCQl9XQoJCX0pKCk7Cgl9Cn07CmFic3VyZC5kaS5yZWdpc3RlcignbXEnLCBtcSk7Cn0KdmFyIGNsaWVudCA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuIGZ1bmN0aW9uKGFyZykgewoKCQkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBDb3BpZWQgZGlyZWN0bHkgZnJvbSAvbGliL0FQSS5qcyAqLwoKCQl2YXIgZXh0ZW5kID0gZnVuY3Rpb24oZGVzdGluYXRpb24sIHNvdXJjZSkgewoJCQlmb3IgKHZhciBrZXkgaW4gc291cmNlKSB7CgkJCQlpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNvdXJjZSwga2V5KSkgewoJCQkJCWRlc3RpbmF0aW9uW2tleV0gPSBzb3VyY2Vba2V5XTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZGVzdGluYXRpb247CgkJfTsKCgkJdmFyIF9hcGkgPSB7IAoJCQkJZGVmYXVsdFByb2Nlc3NvcjogbGliLnByb2Nlc3NvcnMuY3NzLkNTUygpIAoJCQl9LAoJCQlfcnVsZXMgPSB7fSwKCQkJX3N0b3JhZ2UgPSB7fSwKCQkJX3BsdWdpbnMgPSB7fSwKCQkJX2hvb2tzID0ge307CgoJCV9hcGkuZ2V0UnVsZXMgPSBmdW5jdGlvbihzdHlsZXNoZWV0KSB7CgkJCWlmKHR5cGVvZiBzdHlsZXNoZWV0ID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuIF9ydWxlczsKCQkJfSBlbHNlIHsKCQkJCWlmKHR5cGVvZiBfcnVsZXNbc3R5bGVzaGVldF0gPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJX3J1bGVzW3N0eWxlc2hlZXRdID0gW107CgkJCQl9CgkJCQlyZXR1cm4gX3J1bGVzW3N0eWxlc2hlZXRdOwoJCQl9CgkJfQoJCV9hcGkuZ2V0UGx1Z2lucyA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gX3BsdWdpbnM7CQkKCQl9CgkJX2FwaS5nZXRTdG9yYWdlID0gZnVuY3Rpb24oKSB7CgkJCXJldHVybiBfc3RvcmFnZTsKCQl9CgkJX2FwaS5mbHVzaCA9IGZ1bmN0aW9uKCkgewoJCQlfcnVsZXMgPSB7fTsKCQkJX3N0b3JhZ2UgPSBbXTsKCQkJX2hvb2tzID0ge307CgkJCV9hcGkuZGVmYXVsdFByb2Nlc3NvciA9IGxpYi5wcm9jZXNzb3JzLmNzcy5DU1MoKTsKCQkJcmV0dXJuIF9hcGk7CgkJfQoJCV9hcGlbJ2ltcG9ydCddID0gZnVuY3Rpb24oKSB7IAoJCQlpZihfYXBpLmNhbGxIb29rcygiaW1wb3J0IiwgYXJndW1lbnRzKSkgcmV0dXJuIF9hcGk7CgkJCXJldHVybiBfYXBpOyAKCQl9CgkJX2FwaS5oYW5kbGVjc3MgPSBmdW5jdGlvbihwYXJzZWQsIHBhdGgpIHsKCQkJdmFyIHBsdWdpbnMgPSBfYXBpLmdldFBsdWdpbnMoKTsKCQkJaWYocGFyc2VkICYmIHBhcnNlZC50eXBlID09PSAnc3R5bGVzaGVldCcgJiYgcGFyc2VkLnN0eWxlc2hlZXQgJiYgcGFyc2VkLnN0eWxlc2hlZXQucnVsZXMpIHsKCQkJCXZhciBydWxlcyA9IHBhcnNlZC5zdHlsZXNoZWV0LnJ1bGVzOwoJCQkJZm9yKHZhciBpPTA7IHJ1bGU9cnVsZXNbaV07IGkrKykgewoJCQkJCXN3aXRjaChydWxlLnR5cGUpIHsKCQkJCQkJY2FzZSAicnVsZSI6IF9hcGkuaGFuZGxlY3NzcnVsZShydWxlKTsgYnJlYWs7CgkJCQkJCWNhc2UgImltcG9ydCI6IF9hcGkuaGFuZGxlY3NzaW1wb3J0KHJ1bGUsIHBhdGgpOyBicmVhazsKCQkJCQkJZGVmYXVsdDoKCQkJCQkJCWlmKHBsdWdpbnNbcnVsZS50eXBlXSkgewoJCQkJCQkJCXBsdWdpbnNbcnVsZS50eXBlXShfYXBpLCBydWxlKTsKCQkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQl9CgkJCXJldHVybiBfYXBpOwoJCX0KCQlfYXBpLmhhbmRsZWNzc2ltcG9ydCA9IGZ1bmN0aW9uKHJ1bGUsIGNzc1BhdGgpIHsKCQkJcmV0dXJuIF9hcGk7CgkJfQoJCV9hcGkuaGFuZGxlY3NzcnVsZSA9IGZ1bmN0aW9uKHJ1bGUsIHN0eWxlc2hlZXQpIHsJCQoJCQl2YXIgYWJzdXJkT2JqID0ge30sIGFic3VyZFByb3BzID0ge307CgkJCWlmKHJ1bGUuZGVjbGFyYXRpb25zICYmIHJ1bGUuZGVjbGFyYXRpb25zLmxlbmd0aCA+IDApIHsKCQkJCWZvcih2YXIgaT0wOyBkZWNsPXJ1bGUuZGVjbGFyYXRpb25zW2ldOyBpKyspIHsKCQkJCQlpZihkZWNsLnR5cGUgPT09ICJkZWNsYXJhdGlvbiIpIHsKCQkJCQkJYWJzdXJkUHJvcHNbZGVjbC5wcm9wZXJ0eV0gPSBkZWNsLnZhbHVlOwoJCQkJCX0KCQkJCX0KCQkJCS8vIGFic3VyZE9ialtydWxlLnNlbGVjdG9ycy5qb2luKCIsICIpXSA9IGFic3VyZFByb3BzOwoJCQkJaWYocnVsZS5zZWxlY3RvcnMgJiYgcnVsZS5zZWxlY3RvcnMubGVuZ3RoID4gMCkgewoJCQkJCWZvcih2YXIgaT0wOyBzZWxlY3Rvcj1ydWxlLnNlbGVjdG9yc1tpXTsgaSsrKSB7CgkJCQkJCWFic3VyZE9ialtzZWxlY3Rvcl0gPSBleHRlbmQoe30sIGFic3VyZFByb3BzKTsKCQkJCQl9CgkJCQl9CgkJCQlfYXBpLmFkZChhYnN1cmRPYmosIHN0eWxlc2hlZXQpOwoJCQl9CgkJCXJldHVybiBfYXBpOwoJCX0KCgkJLy8gaG9va3MKCQlfYXBpLmFkZEhvb2sgPSBmdW5jdGlvbihtZXRob2QsIGNhbGxiYWNrKSB7CgkJCWlmKCFfaG9va3NbbWV0aG9kXSkgX2hvb2tzW21ldGhvZF0gPSBbXTsKCQkJdmFyIGlzQWxyZWFkeUFkZGVkID0gZmFsc2U7CgkJCWZvcih2YXIgaT0wOyBjPV9ob29rc1ttZXRob2RdW2ldOyBpKyspIHsKCQkJCWlmKGMgPT09IGNhbGxiYWNrKSB7CgkJCQkJaXNBbHJlYWR5QWRkZWQgPSB0cnVlOwoJCQkJfQoJCQl9CgkJCWlzQWxyZWFkeUFkZGVkID09PSBmYWxzZSA/IF9ob29rc1ttZXRob2RdLnB1c2goY2FsbGJhY2spIDogbnVsbDsKCQl9CgkJX2FwaS5jYWxsSG9va3MgPSBmdW5jdGlvbihtZXRob2QsIGFyZ3MpIHsKCQkJaWYoX2hvb2tzW21ldGhvZF0pIHsKCQkJCWZvcih2YXIgaT0wOyBjPV9ob29rc1ttZXRob2RdW2ldOyBpKyspIHsKCQkJCQlpZihjLmFwcGx5KF9hcGksIGFyZ3MpID09PSB0cnVlKSByZXR1cm4gdHJ1ZTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBpbnRlcm5hbCB2YXJpYWJsZXMKCQlfYXBpLm51bU9mQWRkZWRSdWxlcyA9IDA7CgoJCS8vIGFic3VyZC5jb21wb25lbnRzIEFQSQoJCV9hcGkuY29tcG9uZW50cyA9IChmdW5jdGlvbihhcGkpIHsKCQkJdmFyIGV4dGVuZCA9IGxpYi5oZWxwZXJzLkV4dGVuZCwKCQkJCWNsb25lID0gbGliLmhlbHBlcnMuQ2xvbmUsCgkJCQljb21wcyA9IHt9LCAKCQkJCWluc3RhbmNlcyA9IFtdLAoJCQkJZXZlbnRzID0gZXh0ZW5kKHt9LCBDb21wb25lbnQoKSksCgkJCQlleHBvcnRzID0ge307CgoJCQkoZnVuY3Rpb24oZm4pIHsKCQkJCWlmKCF3aW5kb3cpIHJldHVybjsKCQkJCWlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikgewoJCQkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZm4pOwoJCQkJfSBlbHNlIGlmKHdpbmRvdy5hdHRhY2hFdmVudCkgewoJCQkJCXdpbmRvdy5hdHRhY2hFdmVudCgnb25sb2FkJywgZm4pOwoJCQkJfQoJCQl9KShmdW5jdGlvbigpIHsKCQkJCWV4cG9ydHMuYnJvYWRjYXN0KCJyZWFkeSIpOwoJCQl9KQoKCQkJcmV0dXJuIGV4cG9ydHMgPSB7CgkJCQludW1PZkNvbXBvbmVudHM6IDAsCgkJCQlldmVudHM6IGV2ZW50cywKCQkJCXJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCBjbHMpIHsKCQkJCQl0aGlzLm51bU9mQ29tcG9uZW50cyArPSAxOwoJCQkJCXJldHVybiBjb21wc1tuYW1lXSA9IGZ1bmN0aW9uKCkgewoJCQkJCQl2YXIgYyA9IGV4dGVuZCh7fSwgQ29tcG9uZW50KG5hbWUsIGFwaSwgZXZlbnRzLCBjbG9uZShjbHMpKSk7CgkJCQkJCWFwaS5kaS5yZXNvbHZlT2JqZWN0KGMpOwoJCQkJCQlpbnN0YW5jZXMucHVzaChjKTsKCQkJCQkJaWYodHlwZW9mIGMuY29uc3RydWN0b3IgPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJCWMuY29uc3RydWN0b3IuYXBwbHkoYywgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIGM7CgkJCQkJfTsKCQkJCX0sCgkJCQlnZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKCQkJCQlpZihjb21wc1tuYW1lXSkgeyByZXR1cm4gY29tcHNbbmFtZV07IH0KCQkJCQllbHNlIHsgdGhyb3cgbmV3IEVycm9yKCJUaGVyZSBpcyBubyBjb21wb25lbnQgd2l0aCBuYW1lICciICsgbmFtZSArICInLiIpOyB9CgkJCQl9LAoJCQkJcmVtb3ZlOiBmdW5jdGlvbihuYW1lKSB7CgkJCQkJaWYoY29tcHNbbmFtZV0pIHsgZGVsZXRlIGNvbXBzW25hbWVdOyByZXR1cm4gdHJ1ZTsgfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0sCgkJCQlsaXN0OiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbCA9IFtdOwoJCQkJCWZvcih2YXIgbmFtZSBpbiBjb21wcykgbC5wdXNoKG5hbWUpOwoJCQkJCXJldHVybiBsOwoJCQkJfSwKCQkJCWZsdXNoOiBmdW5jdGlvbigpIHsKCQkJCQljb21wcyA9IHt9OwoJCQkJCWluc3RhbmNlcyA9IFtdOwoJCQkJCXJldHVybiB0aGlzOwoJCQkJfSwKCQkJCWJyb2FkY2FzdDogZnVuY3Rpb24oZXZlbnQsIGRhdGEpIHsKCQkJCQlmb3IodmFyIGk9MDsgaTxpbnN0YW5jZXMubGVuZ3RoLCBpbnN0YW5jZT1pbnN0YW5jZXNbaV07IGkrKykgewoJCQkJCQlpZih0eXBlb2YgaW5zdGFuY2VbZXZlbnRdID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQlpbnN0YW5jZVtldmVudF0oZGF0YSk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJcmV0dXJuIHRoaXM7CgkJCQl9CgkJCX0KCQl9KShfYXBpKTsKCgkJLy8gYWJzdXJkLmNvbXBvbmVudCBzaG9ydGN1dAoJCV9hcGkuY29tcG9uZW50ID0gKGZ1bmN0aW9uKGFwaSkgewoJCQlyZXR1cm4gZnVuY3Rpb24obmFtZSwgY2xzKSB7CgkJCQlpZih0eXBlb2YgY2xzID09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0dXJuIGFwaS5jb21wb25lbnRzLmdldChuYW1lKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIGFwaS5jb21wb25lbnRzLnJlZ2lzdGVyKG5hbWUsIGNscyk7CgkJCQl9CgkJCX0KCQl9KShfYXBpKTsKCgkJLy8gZGVwZW5kZW5jeSBpbmplY3RvcgoJCV9hcGkuZGkgPSBsaWIuREkoX2FwaSk7CgkJaW5qZWN0aW5nKF9hcGkpOwoKCQkvKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiBDb3BpZWQgZGlyZWN0bHkgZnJvbSAvbGliL0FQSS5qcyAqLwoKCQkvLyBjbGllbnQgc2lkZSBzcGVjaWZpYyBtZXRob2RzIAoJCV9hcGkuY29tcGlsZSA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBvcHRpb25zKSB7CgkJCWlmKF9hcGkuY2FsbEhvb2tzKCJjb21waWxlIiwgYXJndW1lbnRzKSkgcmV0dXJuIF9hcGk7CgkJCXZhciBkZWZhdWx0T3B0aW9ucyA9IHsKCQkJCWNvbWJpbmVTZWxlY3RvcnM6IHRydWUsCgkJCQltaW5pZnk6IGZhbHNlLAoJCQkJcHJvY2Vzc29yOiBfYXBpLmRlZmF1bHRQcm9jZXNzb3IsCgkJCQlrZWVwQ2FtZWxDYXNlOiBmYWxzZSwKCQkJCWFwaTogX2FwaQoJCQl9OwoJCQlvcHRpb25zID0gZXh0ZW5kKGRlZmF1bHRPcHRpb25zLCBvcHRpb25zIHx8IHt9KTsKCQkJdmFyIHJlcyA9IG9wdGlvbnMucHJvY2Vzc29yKAoJCQkJX2FwaS5nZXRSdWxlcygpLAoJCQkJY2FsbGJhY2sgfHwgZnVuY3Rpb24oKSB7fSwKCQkJCW9wdGlvbnMKCQkJKTsKCQkJX2FwaS5mbHVzaCgpOwoJCQlyZXR1cm4gcmVzOwoJCX0KCgkJLy8gcmVnaXN0ZXJpbmcgYXBpIG1ldGhvZHMKCQlmb3IodmFyIG1ldGhvZCBpbiBsaWIuYXBpKSB7CgkJCWlmKG1ldGhvZCAhPT0gImNvbXBpbGUiKSB7CgkJCQlfYXBpW21ldGhvZF0gPSBsaWIuYXBpW21ldGhvZF0oX2FwaSk7CgkJCQlfYXBpW21ldGhvZF0gPSAoZnVuY3Rpb24obWV0aG9kKSB7CgkJCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJCQl2YXIgZiA9IGxpYi5hcGlbbWV0aG9kXShfYXBpKTsKCQkJCQkJaWYoX2FwaS5jYWxsSG9va3MobWV0aG9kLCBhcmd1bWVudHMpKSByZXR1cm4gX2FwaTsKCQkJCQkJcmV0dXJuIGYuYXBwbHkoX2FwaSwgYXJndW1lbnRzKTsKCQkJCQl9CgkJCQl9KShtZXRob2QpOwkJCgkJCX0KCQl9CgoJCS8vIHJlZ2lzdGVyaW5nIHBsdWdpbnMKCQlmb3IodmFyIHBsdWdpbk5hbWUgaW4gbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMpIHsKCQkJX2FwaS5wbHVnaW4ocGx1Z2luTmFtZSwgbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnNbcGx1Z2luTmFtZV0oKSk7CgkJfQoKCQkvLyBhY2NlcHQgZnVuY3Rpb24KCQlpZih0eXBlb2YgYXJnID09PSAiZnVuY3Rpb24iKSB7CgkJCWFyZyhfYXBpKTsKCQl9CgoJCS8vIGNoZWNrIGZvciBPcmdhbmljCgkJaWYodHlwZW9mIE9yZ2FuaWMgIT0gJ3VuZGVmaW5lZCcpIHsKCQkJT3JnYW5pYy5pbml0KF9hcGkpOwoJCX0KCgkJLy8gYXR0YWNoaW5nIHV0aWxzIGZ1bmN0aW9ucwoJCV9hcGkudXRpbHMgPSB7CgkJCXN0cjJET01FbGVtZW50OiBzdHIyRE9NRWxlbWVudAoJCX0KCgkJcmV0dXJuIF9hcGk7CgoJfQp9O2xpYi5ESSA9IGZ1bmN0aW9uKGFwaSkgewoJdmFyIGluamVjdG9yID0gewoJICAgIGRlcGVuZGVuY2llczoge30sCgkgICAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKCSAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXNba2V5XSA9IHZhbHVlOwoJICAgICAgICByZXR1cm4gdGhpczsKCSAgICB9LAoJICAgIHJlc29sdmU6IGZ1bmN0aW9uKCkgewoJICAgICAgICB2YXIgZnVuYywgZGVwcywgc2NvcGUsIHNlbGYgPSB0aGlzLCBpc0ZvclJlc29sdmluZyA9IGZhbHNlOwoJICAgICAgICBpZih0eXBlb2YgYXJndW1lbnRzWzBdID09PSAnc3RyaW5nJykgewoJICAgICAgICAgICAgZnVuYyA9IGFyZ3VtZW50c1sxXTsKCSAgICAgICAgICAgIGRlcHMgPSBhcmd1bWVudHNbMF0ucmVwbGFjZSgvIC9nLCAnJykuc3BsaXQoJywnKTsKCSAgICAgICAgICAgIHNjb3BlID0gYXJndW1lbnRzWzJdIHx8IHt9OwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgZnVuYyA9IGFyZ3VtZW50c1swXTsKCSAgICAgICAgICAgIGRlcHMgPSBmdW5jLnRvU3RyaW5nKCkubWF0Y2goL15mdW5jdGlvblxzKlteXChdKlwoXHMqKFteXCldKilcKS9tKVsxXS5yZXBsYWNlKC8gL2csICcnKS5zcGxpdCgnLCcpOwoJICAgICAgICAgICAgc2NvcGUgPSBhcmd1bWVudHNbMV0gfHwge307CgkgICAgICAgIH0KCSAgICAgICAgZm9yKHZhciBpPTA7IGk8ZGVwcy5sZW5ndGg7IGkrKykgewoJICAgICAgICAJaWYodHlwZW9mIHRoaXMuZGVwZW5kZW5jaWVzW2RlcHNbaV1dICE9ICd1bmRlZmluZWQnKSBpc0ZvclJlc29sdmluZyA9IHRydWU7CgkgICAgICAgIH0KCSAgICAgICAgaWYoaXNGb3JSZXNvbHZpbmcpIHsKCQkgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKCQkgICAgICAgIAl2YXIgYXJncyA9IFtdOwoJCSAgICAgICAgICAgIHZhciBhID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKTsKCQkgICAgICAgICAgICBmb3IodmFyIGk9MDsgaTxkZXBzLmxlbmd0aDsgaSsrKSB7CgkJICAgICAgICAgICAgICAgIHZhciBkID0gZGVwc1tpXTsKCQkgICAgICAgICAgICAgICAgaWYodHlwZW9mIHNlbGYuZGVwZW5kZW5jaWVzW2RdICE9ICd1bmRlZmluZWQnKSB7CgkJICAgICAgICAgICAgICAgIAl2YXIgZGlNb2R1bGUgPSBzZWxmLmRlcGVuZGVuY2llc1tkXTsKCQkgICAgICAgICAgICAgICAgCWlmKHR5cGVvZiBkaU1vZHVsZSA9PSAnZnVuY3Rpb24nKSB7CgkJICAgICAgICAgICAgICAgIAkJZGlNb2R1bGUucHJvdG90eXBlLmhvc3QgPSBzY29wZTsKCQkgICAgICAgICAgICAgICAgCX0gZWxzZSBpZih0eXBlb2YgZGlNb2R1bGUgPT0gJ29iamVjdCcpIHsKCQkgICAgICAgICAgICAgICAgCQlkaU1vZHVsZS5ob3N0ID0gc2NvcGU7CgkJICAgICAgICAgICAgICAgIAl9CgkJCQkJCQlhcmdzLnB1c2goZGlNb2R1bGUpOwoJCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJCSAgICAgICAgICAgICAgICAJYXJncy5wdXNoKGEuc2hpZnQoKSkKCQkgICAgICAgICAgICAgICAgfQoJCSAgICAgICAgICAgIH0KCQkgICAgICAgICAgICByZXR1cm4gZnVuYy5hcHBseShzY29wZSwgYXJncyk7CgkJICAgICAgICB9CgkgICAgCX0KCSAgICAJcmV0dXJuIGZ1bmM7CgkgICAgfSwKCSAgICByZXNvbHZlT2JqZWN0OiBmdW5jdGlvbihvKSB7CgkgICAgCWlmKHR5cGVvZiBvID09ICdvYmplY3QnKSB7CgkgICAgCQlmb3IodmFyIGtleSBpbiBvKSB7CgkgICAgCQkJaWYodHlwZW9mIG9ba2V5XSA9PSAnZnVuY3Rpb24nKSB7CgkgICAgCQkJCW9ba2V5XSA9IHRoaXMucmVzb2x2ZShvW2tleV0sIG8pOwoJICAgIAkJCX0gZWxzZSBpZihvW2tleV0gaW5zdGFuY2VvZiBBcnJheSAmJiBvW2tleV0ubGVuZ3RoID09IDIgJiYgdHlwZW9mIG9ba2V5XVswXSA9PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb1trZXldWzFdID09ICdmdW5jdGlvbicpIHsJICAgIAkJCQkKCSAgICAJCQkJb1trZXldID0gdGhpcy5yZXNvbHZlKG9ba2V5XVswXSwgb1trZXldWzFdLCBvKTsKCSAgICAJCQl9CgkgICAgCQl9CgkgICAgCX0KCSAgICAJcmV0dXJuIHRoaXM7CgkgICAgfSwKCSAgICBmbHVzaDogZnVuY3Rpb24oKSB7CgkgICAgCXRoaXMuZGVwZW5kZW5jaWVzID0ge307CgkgICAgCXJldHVybiB0aGlzOwoJICAgIH0KCX0KCXJldHVybiBpbmplY3RvcjsKfTsKbGliLmFwaS5hZGQgPSBmdW5jdGlvbihBUEkpIHsKCXZhciBleHRlbmQgPSByZXF1aXJlKCIuLi9oZWxwZXJzL0V4dGVuZCIpLAoJCXByZWZpeGVzID0gcmVxdWlyZSgiLi4vaGVscGVycy9QcmVmaXhlcyIpLAoJCXRvUmVnaXN0ZXIgPSBbXSwKCQlvcHRpb25zID0gewoJCQljb21iaW5lU2VsZWN0b3JzOiB0cnVlLAoJCQlwcmV2ZW50Q29tYmluaW5nOiBbJ0Bmb250LWZhY2UnXQoJCX07CgoJdmFyIGNoZWNrQW5kRXhlY3V0ZVBsdWdpbiA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBwcm9wLCB2YWx1ZSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpIHsKCQl2YXIgcHJlZml4ID0gcHJlZml4ZXMubm9uUHJlZml4UHJvcChwcm9wKTsKCQl2YXIgcGx1Z2luID0gQVBJLmdldFBsdWdpbnMoKVtwcmVmaXgucHJvcF07CgkJLy8gY29uc29sZS5sb2coIlxuQ2hlY2tpbmcgZm9yIHBsdWdpbjogIiArIHByZWZpeC5wcm9wICsgIiAoIiArIHByb3AgKyAiKSIpOwoJCWlmKHR5cGVvZiBwbHVnaW4gIT09ICd1bmRlZmluZWQnKSB7CgkJCXZhciBwbHVnaW5SZXNwb25zZSA9IHBsdWdpbihBUEksIHZhbHVlLCBwcmVmaXgucHJlZml4KTsKCQkJaWYocGx1Z2luUmVzcG9uc2UpIHsKCQkJCWFkZFJ1bGUoc2VsZWN0b3IsIHBsdWdpblJlc3BvbnNlLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCXZhciBhZGRSdWxlID0gZnVuY3Rpb24oc2VsZWN0b3IsIHByb3BzLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3RvcikgewoJCS8vIGNvbnNvbGUubG9nKCJcbi0tLS0tLS0tLS0gYWRkUnVsZSAtLS0tLS0tLS0iLCBwYXJlbnRTZWxlY3RvciArICcgPj4+ICcgKyBzZWxlY3RvciwgIlxuIiwgcHJvcHMpOwoKCQlzdHlsZXNoZWV0ID0gc3R5bGVzaGVldCB8fCAibWFpbnN0cmVhbSI7CgoJCS8vIGNhdGNoaW5nIG51bGwgdmFsdWVzCgkJaWYocHJvcHMgPT09IG51bGwgfHwgdHlwZW9mIHByb3BzID09PSAndW5kZWZpbmVkJyB8fCBwcm9wcyA9PT0gZmFsc2UpIHJldHVybjsKCQlpZighcGFyZW50U2VsZWN0b3IgJiYgIXNlbGVjdG9yKSBzZWxlY3RvciA9ICcnOwoKCQkvLyBjbGFzc2lmeQoJCWlmKHR5cGVvZiBwcm9wcy5jbGFzc2lmeSAhPSAndW5kZWZpbmVkJyAmJiBwcm9wcy5jbGFzc2lmeSA9PT0gdHJ1ZSkgewoJCQlwcm9wcyA9IHR5cGVvZiBwcm9wcy50b0pTT04gIT0gJ3VuZGVmaW5lZCcgPyBwcm9wcy50b0pTT04oKSA6IHByb3BzLnRvU3RyaW5nKCk7CgkJfQoKCQkvLyBtdWx0aXBsZSBzZWxlY3RvcnMKCQlpZigvLCA/L2cudGVzdChzZWxlY3RvcikgJiYgb3B0aW9ucy5jb21iaW5lU2VsZWN0b3JzKSB7CgkJCXZhciBwYXJ0cyA9IHNlbGVjdG9yLnJlcGxhY2UoLywgL2csICcsJykuc3BsaXQoJywnKTsKCQkJZm9yKHZhciBpPTA7IGk8cGFydHMubGVuZ3RoLCBwPXBhcnRzW2ldOyBpKyspIHsKCQkJCWFkZFJ1bGUocCwgcHJvcHMsIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKTsJCgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJLy8gY2hlY2sgZm9yIHBsdWdpbgoJCWlmKGNoZWNrQW5kRXhlY3V0ZVBsdWdpbihudWxsLCBzZWxlY3RvciwgcHJvcHMsIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKSkgewoJCQlyZXR1cm47CQoJCX0KCgkJLy8gaWYgYXJyYXkgaXMgcGFzc2VkCgkJaWYodHlwZW9mIHByb3BzLmxlbmd0aCAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIHByb3BzID09PSAib2JqZWN0IikgewoJCQlmb3IodmFyIGk9MDsgaTxwcm9wcy5sZW5ndGg7IGkrKykgewoJCQkJcHJvcD1wcm9wc1tpXTsKCQkJCWlmKHByb3ApIHsKCQkJCQlhZGRSdWxlKHNlbGVjdG9yLCBwcm9wLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CgkJCQl9CgkJCX0KCQkJcmV0dXJuOwoJCX0KCgkJdmFyIF9wcm9wcyA9IHt9LCAKCQkJX3NlbGVjdG9yID0gc2VsZWN0b3IsCgkJCV9vYmplY3RzID0ge30sIAoJCQlfZnVuY3Rpb25zID0ge307CgoJCS8vIHByb2Nlc3NpbmcgcHJvcHMKCQlmb3IodmFyIHByb3AgaW4gcHJvcHMpIHsKCQkJLy8gY2xhc3NpZnkKCQkJaWYocHJvcHNbcHJvcF0gJiYgdHlwZW9mIHByb3BzW3Byb3BdLmNsYXNzaWZ5ICE9ICd1bmRlZmluZWQnICYmIHByb3BzW3Byb3BdLmNsYXNzaWZ5ID09PSB0cnVlKSB7CgkJCQlwcm9wc1twcm9wXSA9IHR5cGVvZiBwcm9wc1twcm9wXS50b0pTT04gIT0gJ3VuZGVmaW5lZCcgPyBwcm9wc1twcm9wXS50b0pTT04oKSA6IHByb3BzW3Byb3BdLnRvU3RyaW5nKCk7CgkJCX0KCQkJdmFyIHR5cGUgPSB0eXBlb2YgcHJvcHNbcHJvcF07CgkJCWlmKHR5cGUgIT09ICdvYmplY3QnICYmIHR5cGUgIT09ICdmdW5jdGlvbicgJiYgcHJvcHNbcHJvcF0gIT09IGZhbHNlICYmIHByb3BzW3Byb3BdICE9PSB0cnVlKSB7CgkJCQlpZihjaGVja0FuZEV4ZWN1dGVQbHVnaW4oc2VsZWN0b3IsIHByb3AsIHByb3BzW3Byb3BdLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3RvcikgPT09IGZhbHNlKSB7CgkJCQkJLy8gbW92aW5nIHRoZSBzZWxlY3RvciB0byB0aGUgdG9wIG9mIHRoZSBjaGFpbgoJCQkJCWlmKF9zZWxlY3Rvci5pbmRleE9mKCJeIikgPT09IDApIHsKCQkJCQkJX3NlbGVjdG9yID0gX3NlbGVjdG9yLnN1YnN0cigxLCBfc2VsZWN0b3IubGVuZ3RoLTEpICsgKHR5cGVvZiBwYXJlbnRTZWxlY3RvciAhPT0gInVuZGVmaW5lZCIgPyAiICIgKyBwYXJlbnRTZWxlY3RvciA6ICcnKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfc2VsZWN0b3IgPSB0eXBlb2YgcGFyZW50U2VsZWN0b3IgIT09ICJ1bmRlZmluZWQiID8gcGFyZW50U2VsZWN0b3IgKyAiICIgKyBzZWxlY3RvciA6IHNlbGVjdG9yOwoJCQkJCX0KCQkJCQlfcHJvcHNbcHJvcF0gPSBwcm9wc1twcm9wXTsKCQkJCQlwcmVmaXhlcy5hZGRQcmVmaXhlcyhwcm9wLCBfcHJvcHMpOwoJCQkJfQoJCQl9IGVsc2UgaWYodHlwZSA9PT0gJ29iamVjdCcpIHsKCQkJCV9vYmplY3RzW3Byb3BdID0gcHJvcHNbcHJvcF07CgkJCX0gZWxzZSBpZih0eXBlID09PSAnZnVuY3Rpb24nKSB7CgkJCQlfZnVuY3Rpb25zW3Byb3BdID0gcHJvcHNbcHJvcF07CgkJCX0KCQl9CgoJCXRvUmVnaXN0ZXIucHVzaCh7CgkJCXNlbGVjdG9yOiBfc2VsZWN0b3IsCgkJCXByb3BzOiBfcHJvcHMsCgkJCXN0eWxlc2hlZXQ6IHN0eWxlc2hlZXQKCQl9KTsKCgkJZm9yKHZhciBwcm9wIGluIF9vYmplY3RzKSB7CgkJCS8vIGNoZWNrIGZvciBwc2V1ZG8gY2xhc3NlcwkJCQoJCQlpZihwcm9wLmNoYXJBdCgwKSA9PT0gIjoiKSB7CgkJCQlhZGRSdWxlKHNlbGVjdG9yICsgcHJvcCwgX29iamVjdHNbcHJvcF0sIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKTsKCQkgICAgLy8gY2hlY2sgZm9yIGFtcGVyc2FuZCBvcGVyYXRvcgoJCQl9IGVsc2UgaWYoLyYvZy50ZXN0KHByb3ApKSB7CgkJCQlpZigvLCA/L2cudGVzdChwcm9wKSAmJiBvcHRpb25zLmNvbWJpbmVTZWxlY3RvcnMpIHsKCQkJCQl2YXIgcGFydHMgPSBwcm9wLnJlcGxhY2UoLywgL2csICcsJykuc3BsaXQoJywnKTsKCQkJCQlmb3IodmFyIGk9MDsgaTxwYXJ0cy5sZW5ndGgsIHA9cGFydHNbaV07IGkrKykgewoJCQkJCQlpZihwLmluZGV4T2YoJyYnKSA+PSAwKSB7CgkJCQkJCQlhZGRSdWxlKHAucmVwbGFjZSgvJi9nLCBzZWxlY3RvciksIF9vYmplY3RzW3Byb3BdLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlhZGRSdWxlKHAsIF9vYmplY3RzW3Byb3BdLCBzdHlsZXNoZWV0LCB0eXBlb2YgcGFyZW50U2VsZWN0b3IgIT09ICJ1bmRlZmluZWQiID8gcGFyZW50U2VsZWN0b3IgKyAiICIgKyBzZWxlY3RvciA6IHNlbGVjdG9yKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJYWRkUnVsZShwcm9wLnJlcGxhY2UoLyYvZywgc2VsZWN0b3IpLCBfb2JqZWN0c1twcm9wXSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpOwoJCQkJfQoJCQkvLyBjaGVjayBmb3IgbWVkaWEgcXVlcnkKCQkJfSBlbHNlIGlmKHByb3AuaW5kZXhPZigiQG1lZGlhIikgPT09IDAgfHwgcHJvcC5pbmRleE9mKCJAc3VwcG9ydHMiKSA9PT0gMCkgewoJCQkJYWRkUnVsZShzZWxlY3RvciwgX29iamVjdHNbcHJvcF0sIHByb3AsIHBhcmVudFNlbGVjdG9yKTsKCQkJLy8gY2hlY2sgZm9yIG1lZGlhIHF1ZXJ5CgkJCX0gZWxzZSBpZihzZWxlY3Rvci5pbmRleE9mKCJAbWVkaWEiKSA9PT0gMCB8fCBwcm9wLmluZGV4T2YoIkBzdXBwb3J0cyIpID09PSAwKSB7CgkJCQlhZGRSdWxlKHByb3AsIF9vYmplY3RzW3Byb3BdLCBzZWxlY3RvciwgcGFyZW50U2VsZWN0b3IpOwoJCQkvLyBtb3ZpbmcgdGhlIHNlbGVjdG9yIHRvIHRoZSB0b3Agb2YgdGhlIGNoYWluCgkJCX0gZWxzZSBpZihzZWxlY3Rvci5pbmRleE9mKCJeIikgPT09IDApIHsKCQkJCS8vIHNlbGVjdG9yLCBwcm9wcywgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IKCQkJCWFkZFJ1bGUoCgkJCQkJc2VsZWN0b3Iuc3Vic3RyKDEsIHNlbGVjdG9yLmxlbmd0aC0xKSArICh0eXBlb2YgcGFyZW50U2VsZWN0b3IgIT09ICJ1bmRlZmluZWQiID8gIiAiICsgcGFyZW50U2VsZWN0b3IgOiAnJykgKyAiICIgKyBwcm9wLAoJCQkJCV9vYmplY3RzW3Byb3BdLCAKCQkJCQlzdHlsZXNoZWV0CgkJCQkpOwoJCQkvLyBjaGVjayBmb3IgcGx1Z2lucwoJCQl9IGVsc2UgaWYoY2hlY2tBbmRFeGVjdXRlUGx1Z2luKHNlbGVjdG9yLCBwcm9wLCBfb2JqZWN0c1twcm9wXSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpID09PSBmYWxzZSkgewoJCQkJYWRkUnVsZShwcm9wLCBfb2JqZWN0c1twcm9wXSwgc3R5bGVzaGVldCwgKHBhcmVudFNlbGVjdG9yID8gcGFyZW50U2VsZWN0b3IgKyAiICIgOiAiIikgKyBzZWxlY3Rvcik7CgkJCX0KCQl9CgoJCWZvcih2YXIgcHJvcCBpbiBfZnVuY3Rpb25zKSB7CgkJCXZhciBvID0ge307CgkJCW9bcHJvcF0gPSBfZnVuY3Rpb25zW3Byb3BdKCk7CgkJCWFkZFJ1bGUoc2VsZWN0b3IsIG8sIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKTsKCQl9CgkJCgl9CgoJdmFyIGFkZCA9IGZ1bmN0aW9uKHJ1bGVzLCBzdHlsZXNoZWV0LCBvcHRzKSB7CgoJCWlmKEFQSS5qc29uaWZ5KSB7CgkJCWV4dGVuZChBUEkuZ2V0UnVsZXMoc3R5bGVzaGVldCB8fCAnbWFpbnN0cmVhbScpLCBydWxlcyk7CgkJCXJldHVybiBBUEk7CgkJfQoKCQl0cnkgewoKCQkJdG9SZWdpc3RlciA9IFtdOwoJCQlBUEkubnVtT2ZBZGRlZFJ1bGVzICs9IDE7CgoJCQlpZih0eXBlb2Ygc3R5bGVzaGVldCA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG9wdHMgPT09ICd1bmRlZmluZWQnKSB7CgkJCQlvcHRpb25zID0gewoJCQkJCWNvbWJpbmVTZWxlY3RvcnM6IHR5cGVvZiBzdHlsZXNoZWV0LmNvbWJpbmVTZWxlY3RvcnMgIT0gJ3VuZGVmaW5lZCcgPyBzdHlsZXNoZWV0LmNvbWJpbmVTZWxlY3RvcnMgOiBvcHRpb25zLmNvbWJpbmVTZWxlY3RvcnMsCgkJCQkJcHJldmVudENvbWJpbmluZzogb3B0aW9ucy5wcmV2ZW50Q29tYmluaW5nLmNvbmNhdChzdHlsZXNoZWV0LnByZXZlbnRDb21iaW5pbmcgfHwgW10pCgkJCQl9OwoJCQkJc3R5bGVzaGVldCA9IG51bGw7CgkJCX0KCQkJaWYodHlwZW9mIG9wdHMgIT0gJ3VuZGVmaW5lZCcpIHsKCQkJCW9wdGlvbnMgPSB7CgkJCQkJY29tYmluZVNlbGVjdG9yczogb3B0cy5jb21iaW5lU2VsZWN0b3JzIHx8IG9wdGlvbnMuY29tYmluZVNlbGVjdG9ycywKCQkJCQlwcmV2ZW50Q29tYmluaW5nOiBvcHRpb25zLnByZXZlbnRDb21iaW5pbmcuY29uY2F0KG9wdHMucHJldmVudENvbWJpbmluZyB8fCBbXSkKCQkJCX07CgkJCX0KCgkJCXZhciB0eXBlT2ZQcmVwcm9jZXNzb3IgPSBBUEkuZGVmYXVsdFByb2Nlc3Nvci50eXBlLCB1aWQ7CgoJCQlmb3IodmFyIHNlbGVjdG9yIGluIHJ1bGVzKSB7CgkJCQlhZGRSdWxlKHNlbGVjdG9yLCBydWxlc1tzZWxlY3Rvcl0sIHN0eWxlc2hlZXQgfHwgIm1haW5zdHJlYW0iKTsKCQkJfQoKCQkJLy8gbG9vcGluZyB0aHJvdWdoIHRoZSBydWxlcyBmb3IgcmVnaXN0ZXJpbmcKCQkJZm9yKHZhciBpPTA7IGk8dG9SZWdpc3Rlci5sZW5ndGg7IGkrKykgewoJCQkJdmFyIHN0eWxlc2hlZXQgPSB0b1JlZ2lzdGVyW2ldLnN0eWxlc2hlZXQsCgkJCQkJc2VsZWN0b3IgPSB0b1JlZ2lzdGVyW2ldLnNlbGVjdG9yLAoJCQkJCXByb3BzID0gdG9SZWdpc3RlcltpXS5wcm9wcywKCQkJCQlhbGxSdWxlcyA9IEFQSS5nZXRSdWxlcyhzdHlsZXNoZWV0KTsKCQkJCXZhciBwYyA9IG9wdGlvbnMgJiYgb3B0aW9ucy5wcmV2ZW50Q29tYmluaW5nID8gJ3wnICsgb3B0aW9ucy5wcmV2ZW50Q29tYmluaW5nLmpvaW4oJ3wnKSA6ICcnOwoJCQkJdmFyIHVpZCA9IHBjLmluZGV4T2YoJ3wnICsgc2VsZWN0b3IucmVwbGFjZSgvXiUuKj8lLywgJycpKSA+PSAwID8gJ35+JyArIEFQSS5udW1PZkFkZGVkUnVsZXMgKyAnfn4nIDogJyc7CgkJCQkvLyBvdmVyd3JpdGUgYWxyZWFkeSBhZGRlZCB2YWx1ZQoJCQkJdmFyIGN1cnJlbnQgPSBhbGxSdWxlc1t1aWQgKyBzZWxlY3Rvcl0gfHwge307CgkJCQlmb3IodmFyIHByb3BOZXcgaW4gcHJvcHMpIHsKCQkJCQl2YXIgdmFsdWUgPSBwcm9wc1twcm9wTmV3XTsKCQkJCQlwcm9wTmV3ID0gdWlkICsgcHJvcE5ldzsKCQkJCQlpZih0eXBlb2YgdmFsdWUgIT0gJ29iamVjdCcpIHsKCQkJCQkJaWYodHlwZU9mUHJlcHJvY2Vzc29yID09ICJjc3MiKSB7CgkJCQkJCQkvLyBhcHBlbmRpbmcgdmFsdWVzCgkJCQkJCQlpZih2YWx1ZS50b1N0cmluZygpLmNoYXJBdCgwKSA9PT0gIisiKSB7CgkJCQkJCQkJaWYoY3VycmVudCAmJiBjdXJyZW50W3Byb3BOZXddKSB7CgkJCQkJCQkJCWN1cnJlbnRbcHJvcE5ld10gPSBjdXJyZW50W3Byb3BOZXddICsgIiwgIiArIHZhbHVlLnN1YnN0cigxLCB2YWx1ZS5sZW5ndGgtMSk7CQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWN1cnJlbnRbcHJvcE5ld10gPSB2YWx1ZS5zdWJzdHIoMSwgdmFsdWUubGVuZ3RoLTEpOwkKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgaWYodmFsdWUudG9TdHJpbmcoKS5jaGFyQXQoMCkgPT09ICI+IikgewoJCQkJCQkJCWlmKGN1cnJlbnQgJiYgY3VycmVudFtwcm9wTmV3XSkgewoJCQkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gY3VycmVudFtwcm9wTmV3XSArICIgIiArIHZhbHVlLnN1YnN0cigxLCB2YWx1ZS5sZW5ndGgtMSk7CQoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCWN1cnJlbnRbcHJvcE5ld10gPSB2YWx1ZS5zdWJzdHIoMSwgdmFsdWUubGVuZ3RoLTEpOwkKCQkJCQkJCQl9CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWN1cnJlbnRbcHJvcE5ld10gPSB2YWx1ZTsKCQkJCQkJCX0KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWN1cnJlbnRbcHJvcE5ld10gPSB2YWx1ZTsKCQkJCQkJfQoJCQkJCQkKCQkJCQl9CgkJCQl9CgkJCQlhbGxSdWxlc1t1aWQgKyBzZWxlY3Rvcl0gPSBjdXJyZW50OwoJCQl9CgoJCXJldHVybiBBUEk7CgoJCX0gY2F0Y2goZXJyKSB7CgkJCXRocm93IG5ldyBFcnJvcigiRXJyb3IgYWRkaW5nOiAiICsgSlNPTi5zdHJpbmdpZnkoe3J1bGVzOiBydWxlcywgZXJyb3I6IGVyci50b1N0cmluZygpfSkpOwoJCX0KCX0KCXJldHVybiBhZGQ7Cn0KCnZhciBleHRlbmQgPSByZXF1aXJlKCIuLi9oZWxwZXJzL0V4dGVuZCIpOwoKbGliLmFwaS5jb21waWxlID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24oKSB7CgkJdmFyIHBhdGggPSBudWxsLCBjYWxsYmFjayA9IGZ1bmN0aW9uKCkge30sIG9wdGlvbnMgPSBudWxsOwoJCWZvcih2YXIgaT0wOyBpPGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQlzd2l0Y2godHlwZW9mIGFyZ3VtZW50c1tpXSkgewoJCQkJY2FzZSAiZnVuY3Rpb24iOiBjYWxsYmFjayA9IGFyZ3VtZW50c1tpXTsgYnJlYWs7CgkJCQljYXNlICJzdHJpbmciOiBwYXRoID0gYXJndW1lbnRzW2ldOyBicmVhazsKCQkJCWNhc2UgIm9iamVjdCI6IG9wdGlvbnMgPSBhcmd1bWVudHNbaV07IGJyZWFrOwoJCQl9CgkJfQoKCQl2YXIgX2RlZmF1bHRPcHRpb25zID0gewoJCQljb21iaW5lU2VsZWN0b3JzOiB0cnVlLAoJCQltaW5pZnk6IGZhbHNlLAoJCQlrZWVwQ2FtZWxDYXNlOiBmYWxzZSwKCQkJcHJvY2Vzc29yOiBhcGkuZGVmYXVsdFByb2Nlc3NvciwKCQkJYXBpOiBhcGkKCQl9OwoJCW9wdGlvbnMgPSBleHRlbmQoX2RlZmF1bHRPcHRpb25zLCBvcHRpb25zIHx8IHt9KTsKCgkJcmV0dXJuIG9wdGlvbnMucHJvY2Vzc29yKAoJCQlhcGkuZ2V0UnVsZXMoKSwKCQkJZnVuY3Rpb24oZXJyLCByZXN1bHQpIHsKCQkJCWlmKHBhdGggIT0gbnVsbCkgewoJCQkJCXRyeSB7CgkJCQkJCXZhciBmaWxlQ29udGVudCA9IHJlc3VsdDsKCQkJCQkJaWYoJ29iamVjdCcgPT09IHR5cGVvZiBmaWxlQ29udGVudCkgewoJCQkJCQkJZmlsZUNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShmaWxlQ29udGVudCk7CgkJCQkJCX0KCQkJCQkJZnMud3JpdGVGaWxlKHBhdGgsIGZpbGVDb250ZW50LCBmdW5jdGlvbiAoZXJyKSB7CgkJCQkJCQljYWxsYmFjayhlcnIsIHJlc3VsdCk7CgkJCQkJCX0pOwoJCQkJCX0gY2F0Y2goZXJyKSB7CgkJCQkJCWNhbGxiYWNrLmFwcGx5KHt9LCBhcmd1bWVudHMpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJY2FsbGJhY2suYXBwbHkoe30sIGFyZ3VtZW50cyk7CgkJCQl9CgkJCQlhcGkuZmx1c2goKTsKCQkJfSwKCQkJb3B0aW9ucwoJCSk7CgkJCgl9Cn0KCmxpYi5hcGkuY29tcGlsZUZpbGUgPSBmdW5jdGlvbihhcGkpIHsKCXJldHVybiBhcGkuY29tcGlsZTsKfQp2YXIgQ29sb3JMdW1pbmFuY2UgPSBmdW5jdGlvbiAoaGV4LCBsdW0pIHsKCgkvLyB2YWxpZGF0ZSBoZXggc3RyaW5nCgloZXggPSBTdHJpbmcoaGV4KS5yZXBsYWNlKC9bXjAtOWEtZl0vZ2ksICcnKTsKCWlmIChoZXgubGVuZ3RoIDwgNikgewoJCWhleCA9IGhleFswXStoZXhbMF0raGV4WzFdK2hleFsxXStoZXhbMl0raGV4WzJdOwoJfQoJbHVtID0gbHVtIHx8IDA7CgoJLy8gY29udmVydCB0byBkZWNpbWFsIGFuZCBjaGFuZ2UgbHVtaW5vc2l0eQoJdmFyIHJnYiA9ICIjIiwgYywgaTsKCWZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKCQljID0gcGFyc2VJbnQoaGV4LnN1YnN0cihpKjIsMiksIDE2KTsKCQljID0gTWF0aC5yb3VuZChNYXRoLm1pbihNYXRoLm1heCgwLCBjICsgKGMgKiBsdW0pKSwgMjU1KSkudG9TdHJpbmcoMTYpOwoJCXJnYiArPSAoIjAwIitjKS5zdWJzdHIoYy5sZW5ndGgpOwoJfQoKCXJldHVybiByZ2I7Cn07CmxpYi5hcGkuZGFya2VuID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24oY29sb3IsIHBlcmNlbnRzKSB7CgkJcmV0dXJuIENvbG9yTHVtaW5hbmNlKGNvbG9yLCAtKHBlcmNlbnRzLzEwMCkpOwoJfQp9CmxpYi5hcGkuZGVmaW5lID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24ocHJvcCwgdmFsdWUpIHsKCQlpZighYXBpLmdldFN0b3JhZ2UoKS5fX2RlZmluZWQpIGFwaS5nZXRTdG9yYWdlKCkuX19kZWZpbmVkID0ge307CgkJYXBpLmdldFN0b3JhZ2UoKS5fX2RlZmluZWRbcHJvcF0gPSB2YWx1ZTsKCQlyZXR1cm4gYXBpOwoJfQp9CmxpYi5hcGkuaG9vayA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKG1ldGhvZCwgY2FsbGJhY2spIHsKCQlhcGkuYWRkSG9vayhtZXRob2QsIGNhbGxiYWNrKTsKCQlyZXR1cm4gYXBpOwoJfQp9CmxpYi5hcGkuaW1wb3J0Q1NTID0gZnVuY3Rpb24oYXBpKSB7Cgl2YXIgQ1NTUGFyc2UgPSByZXF1aXJlKCIuLi9oZWxwZXJzL0NTU1BhcnNlIik7CglyZXR1cm4gZnVuY3Rpb24oY3NzRGF0YSkgewoJCXRyeSB7CgkJCXZhciBwYXJzZWQgPSBDU1NQYXJzZShjc3NEYXRhKTsKCQkJYXBpLmhhbmRsZWNzcyhwYXJzZWQsICcnKTsKCQl9IGNhdGNoKGVycikgewoJCQljb25zb2xlLmxvZygiRXJyb3IgaW4gdGhlIENTUzogICciICsgY3NzRGF0YSArICInIiwgZXJyLCBlcnIuc3RhY2spOwoJCX0KCQlyZXR1cm4gYXBpOwoJfQp9CnZhciBDb2xvckx1bWluYW5jZSA9IGZ1bmN0aW9uIChoZXgsIGx1bSkgewoKCS8vIHZhbGlkYXRlIGhleCBzdHJpbmcKCWhleCA9IFN0cmluZyhoZXgpLnJlcGxhY2UoL1teMC05YS1mXS9naSwgJycpOwoJaWYgKGhleC5sZW5ndGggPCA2KSB7CgkJaGV4ID0gaGV4WzBdK2hleFswXStoZXhbMV0raGV4WzFdK2hleFsyXStoZXhbMl07Cgl9CglsdW0gPSBsdW0gfHwgMDsKCgkvLyBjb252ZXJ0IHRvIGRlY2ltYWwgYW5kIGNoYW5nZSBsdW1pbm9zaXR5Cgl2YXIgcmdiID0gIiMiLCBjLCBpOwoJZm9yIChpID0gMDsgaSA8IDM7IGkrKykgewoJCWMgPSBwYXJzZUludChoZXguc3Vic3RyKGkqMiwyKSwgMTYpOwoJCWMgPSBNYXRoLnJvdW5kKE1hdGgubWluKE1hdGgubWF4KDAsIGMgKyAoYyAqIGx1bSkpLCAyNTUpKS50b1N0cmluZygxNik7CgkJcmdiICs9ICgiMDAiK2MpLnN1YnN0cihjLmxlbmd0aCk7Cgl9CgoJcmV0dXJuIHJnYjsKfTsKbGliLmFwaS5saWdodGVuID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24oY29sb3IsIHBlcmNlbnRzKSB7CgkJcmV0dXJuIENvbG9yTHVtaW5hbmNlKGNvbG9yLCBwZXJjZW50cy8xMDApOwoJfQp9CnZhciBtZXRhbW9ycGhvc2lzID0gewoJaHRtbDogZnVuY3Rpb24oYXBpKSB7CgkJYXBpLmRlZmF1bHRQcm9jZXNzb3IgPSByZXF1aXJlKF9fZGlybmFtZSArICIvLi4vcHJvY2Vzc29ycy9odG1sL0hUTUwuanMiKSgpOwoJCWFwaS5ob29rKCJhZGQiLCBmdW5jdGlvbih0YWdzLCB0ZW1wbGF0ZSkgewoJCQlhcGkuZ2V0UnVsZXModGVtcGxhdGUgfHwgIm1haW5zdHJlYW0iKS5wdXNoKHRhZ3MpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsKCX0sCgljb21wb25lbnQ6IGZ1bmN0aW9uKGFwaSkgewoJCWFwaS5kZWZhdWx0UHJvY2Vzc29yID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uL3Byb2Nlc3NvcnMvY29tcG9uZW50L0NvbXBvbmVudC5qcyIpKCk7CgkJYXBpLmhvb2soImFkZCIsIGZ1bmN0aW9uKGNvbXBvbmVudCkgewoJCQlpZighKGNvbXBvbmVudCBpbnN0YW5jZW9mIEFycmF5KSkgY29tcG9uZW50ID0gW2NvbXBvbmVudF07CgkJCWZvcih2YXIgaT0wOyBpPGNvbXBvbmVudC5sZW5ndGgsIGMgPSBjb21wb25lbnRbaV07IGkrKykgewoJCQkJYXBpLmdldFJ1bGVzKCJtYWluc3RyZWFtIikucHVzaChjKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCQl9KTsJCgl9LAoJanNvbmlmeTogZnVuY3Rpb24oYXBpKSB7CgkJYXBpLmpzb25pZnkgPSB0cnVlOwoJfSwKCSdkeW5hbWljLWNzcyc6IGZ1bmN0aW9uKGFwaSkgewoJCWFwaS5keW5hbWljQ1NTID0gdHJ1ZTsKCX0KfQpsaWIuYXBpLm1vcnBoID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24odHlwZSkgewoJCWlmKG1ldGFtb3JwaG9zaXNbdHlwZV0pIHsKCQkJYXBpLmZsdXNoKCk7CgkJCW1ldGFtb3JwaG9zaXNbdHlwZV0oYXBpKTsKCQl9CgkJcmV0dXJuIGFwaTsKCX0KfQpsaWIuYXBpLnBsdWdpbiA9IGZ1bmN0aW9uKGFwaSkgewoJdmFyIHBsdWdpbiA9IGZ1bmN0aW9uKG5hbWUsIGZ1bmMpIHsKCQlhcGkuZ2V0UGx1Z2lucygpW25hbWVdID0gZnVuYzsKCQlyZXR1cm4gYXBpOwoJfQoJcmV0dXJuIHBsdWdpbjsJCn0KbGliLmFwaS5yYXcgPSBmdW5jdGlvbihhcGkpIHsKCXJldHVybiBmdW5jdGlvbihyYXcpIHsKCQl2YXIgbyA9IHt9LCB2ID0ge307CgkJdmFyIGlkID0gIl9fX19yYXdfIiArIGFwaS5udW1PZkFkZGVkUnVsZXM7CgkJdltpZF0gPSByYXc7CgkJb1tpZF0gPSB2OwoJCWFwaS5hZGQobyk7CgkJcmV0dXJuIGFwaTsKCX0KfQp2YXIgZnMgPSByZXF1aXJlKCJmcyIpLAoJcGF0aCA9IHJlcXVpcmUoInBhdGgiKTsKCmxpYi5hcGkucmF3SW1wb3J0ID0gZnVuY3Rpb24oQVBJKSB7CgkKCXZhciBpbXBvcnRGaWxlID0gZnVuY3Rpb24ocGF0aCkgewoJCXZhciBmaWxlQ29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLCB7ZW5jb2Rpbmc6ICJ1dGY4In0pOwoJCUFQSS5yYXcoZmlsZUNvbnRlbnQpOwoJfQoJCglyZXR1cm4gZnVuY3Rpb24ocGF0aCkgewoJCXZhciBwLCBfaSwgX2xlbjsKCQlpZiAodHlwZW9mIHBhdGggPT09ICdzdHJpbmcnKSB7CgkJCWltcG9ydEZpbGUocGF0aCk7CgkJfSBlbHNlIHsKCQkJZm9yIChfaSA9IDAsIF9sZW4gPSBwYXRoLmxlbmd0aDsgX2kgPCBfbGVuOyBfaSsrKSB7CgkJCQlwID0gcGF0aFtfaV07CgkJCQlpbXBvcnRGaWxlKHApOwoJCQl9CgkJfQoJCXJldHVybiBBUEk7CiAgICB9Owp9CgpsaWIuYXBpLnJlZ2lzdGVyID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24obWV0aG9kLCBmdW5jKSB7CgkJYXBpW21ldGhvZF0gPSBmdW5jOwoJCXJldHVybiBhcGk7Cgl9Cn0KbGliLmFwaS5zdG9yYWdlID0gZnVuY3Rpb24oQVBJKSB7Cgl2YXIgX3MgPSBBUEkuZ2V0U3RvcmFnZSgpOwoJdmFyIHN0b3JhZ2UgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewoJCWlmKHR5cGVvZiB2YWx1ZSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJX3NbbmFtZV0gPSB2YWx1ZTsKCQl9IGVsc2UgaWYodHlwZW9mIG5hbWUgPT09ICJvYmplY3QiKSB7CgkJCWZvcih2YXIgX25hbWUgaW4gbmFtZSkgewoJCQkJaWYoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG5hbWUsIF9uYW1lKSkgewoJCQkJCXN0b3JhZ2UoX25hbWUsIG5hbWVbX25hbWVdKTsKCQkJCX0KCQkJfQogICAgfSBlbHNlIHsKCQkJaWYoX3NbbmFtZV0pIHsKCQkJCXJldHVybiBfc1tuYW1lXTsKCQkJfSBlbHNlIHsKCQkJCXRocm93IG5ldyBFcnJvcigiVGhlcmUgaXMgbm8gZGF0YSBpbiB0aGUgc3RvcmFnZSBhc3NvY2lhdGVkIHdpdGggJyIgKyBuYW1lICsgIiciKTsKCQkJfQoJCX0KCQlyZXR1cm4gQVBJOwoJfQoJcmV0dXJuIHN0b3JhZ2U7Cn0KLy8gTW9kdWxlIGJ5IHZpc2lvbm1lZGlhCi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9yZXdvcmtjc3MvY3NzLXBhcnNlCi8vCi8vIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL2dyYW1tYXIuaHRtbAovLyBodHRwczovL2dpdGh1Yi5jb20vdmlzaW9ubWVkaWEvY3NzLXBhcnNlL3B1bGwvNDkjaXNzdWVjb21tZW50LTMwMDg4MDI3CnZhciBjb21tZW50cmUgPSAvXC9cKlteKl0qXCorKFteLypdW14qXSpcKispKlwvL2cKCmxpYi5oZWxwZXJzLkNTU1BhcnNlID0gZnVuY3Rpb24oY3NzLCBvcHRpb25zKXsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBvcHRpb25zLnBvc2l0aW9uID0gb3B0aW9ucy5wb3NpdGlvbiA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7CgogIC8qKgogICAqIFBvc2l0aW9uYWwuCiAgICovCgogIHZhciBsaW5lbm8gPSAxOwogIHZhciBjb2x1bW4gPSAxOwoKICAvKioKICAgKiBVcGRhdGUgbGluZW5vIGFuZCBjb2x1bW4gYmFzZWQgb24gYHN0cmAuCiAgICovCgogIGZ1bmN0aW9uIHVwZGF0ZVBvc2l0aW9uKHN0cikgewogICAgdmFyIGxpbmVzID0gc3RyLm1hdGNoKC9cbi9nKTsKICAgIGlmIChsaW5lcykgbGluZW5vICs9IGxpbmVzLmxlbmd0aDsKICAgIHZhciBpID0gc3RyLmxhc3RJbmRleE9mKCdcbicpOwogICAgY29sdW1uID0gfmkgPyBzdHIubGVuZ3RoIC0gaSA6IGNvbHVtbiArIHN0ci5sZW5ndGg7CiAgfQoKICAvKioKICAgKiBNYXJrIHBvc2l0aW9uIGFuZCBwYXRjaCBgbm9kZS5wb3NpdGlvbmAuCiAgICovCgogIGZ1bmN0aW9uIHBvc2l0aW9uKCkgewogICAgdmFyIHN0YXJ0ID0geyBsaW5lOiBsaW5lbm8sIGNvbHVtbjogY29sdW1uIH07CiAgICBpZiAoIW9wdGlvbnMucG9zaXRpb24pIHJldHVybiBwb3NpdGlvbk5vb3A7CgogICAgcmV0dXJuIGZ1bmN0aW9uKG5vZGUpewogICAgICBub2RlLnBvc2l0aW9uID0gbmV3IFBvc2l0aW9uKHN0YXJ0KTsKICAgICAgd2hpdGVzcGFjZSgpOwogICAgICByZXR1cm4gbm9kZTsKICAgIH07CiAgfQoKICAvKioKICAgKiBTdG9yZSBwb3NpdGlvbiBpbmZvcm1hdGlvbiBmb3IgYSBub2RlCiAgICovCgogIGZ1bmN0aW9uIFBvc2l0aW9uKHN0YXJ0KSB7CiAgICB0aGlzLnN0YXJ0ID0gc3RhcnQ7CiAgICB0aGlzLmVuZCA9IHsgbGluZTogbGluZW5vLCBjb2x1bW46IGNvbHVtbiB9OwogICAgdGhpcy5zb3VyY2UgPSBvcHRpb25zLnNvdXJjZTsKICB9CgogIC8qKgogICAqIE5vbi1lbnVtZXJhYmxlIHNvdXJjZSBzdHJpbmcKICAgKi8KCiAgUG9zaXRpb24ucHJvdG90eXBlLmNvbnRlbnQgPSBjc3M7CgogIC8qKgogICAqIFJldHVybiBgbm9kZWAuCiAgICovCgogIGZ1bmN0aW9uIHBvc2l0aW9uTm9vcChub2RlKSB7CiAgICB3aGl0ZXNwYWNlKCk7CiAgICByZXR1cm4gbm9kZTsKICB9CgogIC8qKgogICAqIEVycm9yIGBtc2dgLgogICAqLwoKICBmdW5jdGlvbiBlcnJvcihtc2cpIHsKICAgIHZhciBlcnIgPSBuZXcgRXJyb3IobXNnICsgJyBuZWFyIGxpbmUgJyArIGxpbmVubyArICc6JyArIGNvbHVtbik7CiAgICBlcnIuZmlsZW5hbWUgPSBvcHRpb25zLnNvdXJjZTsKICAgIGVyci5saW5lID0gbGluZW5vOwogICAgZXJyLmNvbHVtbiA9IGNvbHVtbjsKICAgIGVyci5zb3VyY2UgPSBjc3M7CiAgICB0aHJvdyBlcnI7CiAgfQoKICAvKioKICAgKiBQYXJzZSBzdHlsZXNoZWV0LgogICAqLwoKICBmdW5jdGlvbiBzdHlsZXNoZWV0KCkgewogICAgcmV0dXJuIHsKICAgICAgdHlwZTogJ3N0eWxlc2hlZXQnLAogICAgICBzdHlsZXNoZWV0OiB7CiAgICAgICAgcnVsZXM6IHJ1bGVzKCkKICAgICAgfQogICAgfTsKICB9CgogIC8qKgogICAqIE9wZW5pbmcgYnJhY2UuCiAgICovCgogIGZ1bmN0aW9uIG9wZW4oKSB7CiAgICByZXR1cm4gbWF0Y2goL157XHMqLyk7CiAgfQoKICAvKioKICAgKiBDbG9zaW5nIGJyYWNlLgogICAqLwoKICBmdW5jdGlvbiBjbG9zZSgpIHsKICAgIHJldHVybiBtYXRjaCgvXn0vKTsKICB9CgogIC8qKgogICAqIFBhcnNlIHJ1bGVzZXQuCiAgICovCgogIGZ1bmN0aW9uIHJ1bGVzKCkgewogICAgdmFyIG5vZGU7CiAgICB2YXIgcnVsZXMgPSBbXTsKICAgIHdoaXRlc3BhY2UoKTsKICAgIGNvbW1lbnRzKHJ1bGVzKTsKICAgIHdoaWxlIChjc3MubGVuZ3RoICYmIGNzcy5jaGFyQXQoMCkgIT0gJ30nICYmIChub2RlID0gYXRydWxlKCkgfHwgcnVsZSgpKSkgewogICAgICBydWxlcy5wdXNoKG5vZGUpOwogICAgICBjb21tZW50cyhydWxlcyk7CiAgICB9CiAgICByZXR1cm4gcnVsZXM7CiAgfQoKICAvKioKICAgKiBNYXRjaCBgcmVgIGFuZCByZXR1cm4gY2FwdHVyZXMuCiAgICovCgogIGZ1bmN0aW9uIG1hdGNoKHJlKSB7CiAgICB2YXIgbSA9IHJlLmV4ZWMoY3NzKTsKICAgIGlmICghbSkgcmV0dXJuOwogICAgdmFyIHN0ciA9IG1bMF07CiAgICB1cGRhdGVQb3NpdGlvbihzdHIpOwogICAgY3NzID0gY3NzLnNsaWNlKHN0ci5sZW5ndGgpOwogICAgcmV0dXJuIG07CiAgfQoKICAvKioKICAgKiBQYXJzZSB3aGl0ZXNwYWNlLgogICAqLwoKICBmdW5jdGlvbiB3aGl0ZXNwYWNlKCkgewogICAgbWF0Y2goL15ccyovKTsKICB9CgogIC8qKgogICAqIFBhcnNlIGNvbW1lbnRzOwogICAqLwoKICBmdW5jdGlvbiBjb21tZW50cyhydWxlcykgewogICAgdmFyIGM7CiAgICBydWxlcyA9IHJ1bGVzIHx8IFtdOwogICAgd2hpbGUgKGMgPSBjb21tZW50KCkpIHJ1bGVzLnB1c2goYyk7CiAgICByZXR1cm4gcnVsZXM7CiAgfQoKICAvKioKICAgKiBQYXJzZSBjb21tZW50LgogICAqLwoKICBmdW5jdGlvbiBjb21tZW50KCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICBpZiAoJy8nICE9IGNzcy5jaGFyQXQoMCkgfHwgJyonICE9IGNzcy5jaGFyQXQoMSkpIHJldHVybjsKCiAgICB2YXIgaSA9IDI7CiAgICB3aGlsZSAoIiIgIT0gY3NzLmNoYXJBdChpKSAmJiAoJyonICE9IGNzcy5jaGFyQXQoaSkgfHwgJy8nICE9IGNzcy5jaGFyQXQoaSArIDEpKSkgKytpOwogICAgaSArPSAyOwoKICAgIGlmICgiIiA9PT0gY3NzLmNoYXJBdChpLTEpKSB7CiAgICAgIHJldHVybiBlcnJvcignRW5kIG9mIGNvbW1lbnQgbWlzc2luZycpOwogICAgfQoKICAgIHZhciBzdHIgPSBjc3Muc2xpY2UoMiwgaSAtIDIpOwogICAgY29sdW1uICs9IDI7CiAgICB1cGRhdGVQb3NpdGlvbihzdHIpOwogICAgY3NzID0gY3NzLnNsaWNlKGkpOwogICAgY29sdW1uICs9IDI7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdjb21tZW50JywKICAgICAgY29tbWVudDogc3RyCiAgICB9KTsKICB9CgogIC8qKgogICAqIFBhcnNlIHNlbGVjdG9yLgogICAqLwoKICBmdW5jdGlvbiBzZWxlY3RvcigpIHsKICAgIHZhciBtID0gbWF0Y2goL14oW157XSspLyk7CiAgICBpZiAoIW0pIHJldHVybjsKICAgIC8qIEBmaXggUmVtb3ZlIGFsbCBjb21tZW50cyBmcm9tIHNlbGVjdG9ycwogICAgICogaHR0cDovL29zdGVybWlsbGVyLm9yZy9maW5kY29tbWVudC5odG1sICovCiAgICByZXR1cm4gdHJpbShtWzBdKS5yZXBsYWNlKC9cL1wqKFteKl18W1xyXG5dfChcKisoW14qL118W1xyXG5dKSkpKlwqXC8rL2csICcnKS5zcGxpdCgvXHMqLFxzKi8pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgZGVjbGFyYXRpb24uCiAgICovCgogIGZ1bmN0aW9uIGRlY2xhcmF0aW9uKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CgogICAgLy8gcHJvcAogICAgdmFyIHByb3AgPSBtYXRjaCgvXihcKj9bLSNcL1wqXHddKyhcW1swLTlhLXpfLV0rXF0pPylccyovKTsKICAgIGlmICghcHJvcCkgcmV0dXJuOwogICAgcHJvcCA9IHRyaW0ocHJvcFswXSk7CgogICAgLy8gOgogICAgaWYgKCFtYXRjaCgvXjpccyovKSkgcmV0dXJuIGVycm9yKCJwcm9wZXJ0eSBtaXNzaW5nICc6JyIpOwoKICAgIC8vIHZhbAogICAgdmFyIHZhbCA9IG1hdGNoKC9eKCg/OicoPzpcXCd8LikqPyd8Iig/OlxcInwuKSo/InxcKFteXCldKj9cKXxbXn07XSkrKS8pOwogICAgaWYgKCF2YWwpIHJldHVybiBlcnJvcigncHJvcGVydHkgbWlzc2luZyB2YWx1ZScpOwoKICAgIHZhciByZXQgPSBwb3MoewogICAgICB0eXBlOiAnZGVjbGFyYXRpb24nLAogICAgICBwcm9wZXJ0eTogcHJvcC5yZXBsYWNlKGNvbW1lbnRyZSwgJycpLAogICAgICB2YWx1ZTogdHJpbSh2YWxbMF0pLnJlcGxhY2UoY29tbWVudHJlLCAnJykKICAgIH0pOwoKICAgIC8vIDsKICAgIG1hdGNoKC9eWztcc10qLyk7CgogICAgcmV0dXJuIHJldDsKICB9CgogIC8qKgogICAqIFBhcnNlIGRlY2xhcmF0aW9ucy4KICAgKi8KCiAgZnVuY3Rpb24gZGVjbGFyYXRpb25zKCkgewogICAgdmFyIGRlY2xzID0gW107CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigibWlzc2luZyAneyciKTsKICAgIGNvbW1lbnRzKGRlY2xzKTsKCiAgICAvLyBkZWNsYXJhdGlvbnMKICAgIHZhciBkZWNsOwogICAgd2hpbGUgKGRlY2wgPSBkZWNsYXJhdGlvbigpKSB7CiAgICAgIGRlY2xzLnB1c2goZGVjbCk7CiAgICAgIGNvbW1lbnRzKGRlY2xzKTsKICAgIH0KCiAgICBpZiAoIWNsb3NlKCkpIHJldHVybiBlcnJvcigibWlzc2luZyAnfSciKTsKICAgIHJldHVybiBkZWNsczsKICB9CgogIC8qKgogICAqIFBhcnNlIGtleWZyYW1lLgogICAqLwoKICBmdW5jdGlvbiBrZXlmcmFtZSgpIHsKICAgIHZhciBtOwogICAgdmFyIHZhbHMgPSBbXTsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwoKICAgIHdoaWxlIChtID0gbWF0Y2goL14oKFxkK1wuXGQrfFwuXGQrfFxkKyklP3xbYS16XSspXHMqLykpIHsKICAgICAgdmFscy5wdXNoKG1bMV0pOwogICAgICBtYXRjaCgvXixccyovKTsKICAgIH0KCiAgICBpZiAoIXZhbHMubGVuZ3RoKSByZXR1cm47CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdrZXlmcmFtZScsCiAgICAgIHZhbHVlczogdmFscywKICAgICAgZGVjbGFyYXRpb25zOiBkZWNsYXJhdGlvbnMoKQogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBrZXlmcmFtZXMuCiAgICovCgogIGZ1bmN0aW9uIGF0a2V5ZnJhbWVzKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQChbLVx3XSspP2tleWZyYW1lcyAqLyk7CgogICAgaWYgKCFtKSByZXR1cm47CiAgICB2YXIgdmVuZG9yID0gbVsxXTsKCiAgICAvLyBpZGVudGlmaWVyCiAgICB2YXIgbSA9IG1hdGNoKC9eKFstXHddKylccyovKTsKICAgIGlmICghbSkgcmV0dXJuIGVycm9yKCJAa2V5ZnJhbWVzIG1pc3NpbmcgbmFtZSIpOwogICAgdmFyIG5hbWUgPSBtWzFdOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIkBrZXlmcmFtZXMgbWlzc2luZyAneyciKTsKCiAgICB2YXIgZnJhbWU7CiAgICB2YXIgZnJhbWVzID0gY29tbWVudHMoKTsKICAgIHdoaWxlIChmcmFtZSA9IGtleWZyYW1lKCkpIHsKICAgICAgZnJhbWVzLnB1c2goZnJhbWUpOwogICAgICBmcmFtZXMgPSBmcmFtZXMuY29uY2F0KGNvbW1lbnRzKCkpOwogICAgfQoKICAgIGlmICghY2xvc2UoKSkgcmV0dXJuIGVycm9yKCJAa2V5ZnJhbWVzIG1pc3NpbmcgJ30nIik7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdrZXlmcmFtZXMnLAogICAgICBuYW1lOiBuYW1lLAogICAgICB2ZW5kb3I6IHZlbmRvciwKICAgICAga2V5ZnJhbWVzOiBmcmFtZXMKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2Ugc3VwcG9ydHMuCiAgICovCgogIGZ1bmN0aW9uIGF0c3VwcG9ydHMoKSB7CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKICAgIHZhciBtID0gbWF0Y2goL15Ac3VwcG9ydHMgKihbXntdKykvKTsKCiAgICBpZiAoIW0pIHJldHVybjsKICAgIHZhciBzdXBwb3J0cyA9IHRyaW0obVsxXSk7CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQHN1cHBvcnRzIG1pc3NpbmcgJ3snIik7CgogICAgdmFyIHN0eWxlID0gY29tbWVudHMoKS5jb25jYXQocnVsZXMoKSk7CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBzdXBwb3J0cyBtaXNzaW5nICd9JyIpOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAnc3VwcG9ydHMnLAogICAgICBzdXBwb3J0czogc3VwcG9ydHMsCiAgICAgIHJ1bGVzOiBzdHlsZQogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBob3N0LgogICAqLwoKICBmdW5jdGlvbiBhdGhvc3QoKSB7CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKICAgIHZhciBtID0gbWF0Y2goL15AaG9zdCAqLyk7CgogICAgaWYgKCFtKSByZXR1cm47CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQGhvc3QgbWlzc2luZyAneyciKTsKCiAgICB2YXIgc3R5bGUgPSBjb21tZW50cygpLmNvbmNhdChydWxlcygpKTsKCiAgICBpZiAoIWNsb3NlKCkpIHJldHVybiBlcnJvcigiQGhvc3QgbWlzc2luZyAnfSciKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ2hvc3QnLAogICAgICBydWxlczogc3R5bGUKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgbWVkaWEuCiAgICovCgogIGZ1bmN0aW9uIGF0bWVkaWEoKSB7CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKICAgIHZhciBtID0gbWF0Y2goL15AbWVkaWEgKihbXntdKykvKTsKCiAgICBpZiAoIW0pIHJldHVybjsKICAgIHZhciBtZWRpYSA9IHRyaW0obVsxXSk7CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQG1lZGlhIG1pc3NpbmcgJ3snIik7CgogICAgdmFyIHN0eWxlID0gY29tbWVudHMoKS5jb25jYXQocnVsZXMoKSk7CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBtZWRpYSBtaXNzaW5nICd9JyIpOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAnbWVkaWEnLAogICAgICBtZWRpYTogbWVkaWEsCiAgICAgIHJ1bGVzOiBzdHlsZQogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBwYWdlZCBtZWRpYS4KICAgKi8KCiAgZnVuY3Rpb24gYXRwYWdlKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQHBhZ2UgKi8pOwogICAgaWYgKCFtKSByZXR1cm47CgogICAgdmFyIHNlbCA9IHNlbGVjdG9yKCkgfHwgW107CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQHBhZ2UgbWlzc2luZyAneyciKTsKICAgIHZhciBkZWNscyA9IGNvbW1lbnRzKCk7CgogICAgLy8gZGVjbGFyYXRpb25zCiAgICB2YXIgZGVjbDsKICAgIHdoaWxlIChkZWNsID0gZGVjbGFyYXRpb24oKSkgewogICAgICBkZWNscy5wdXNoKGRlY2wpOwogICAgICBkZWNscyA9IGRlY2xzLmNvbmNhdChjb21tZW50cygpKTsKICAgIH0KCiAgICBpZiAoIWNsb3NlKCkpIHJldHVybiBlcnJvcigiQHBhZ2UgbWlzc2luZyAnfSciKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ3BhZ2UnLAogICAgICBzZWxlY3RvcnM6IHNlbCwKICAgICAgZGVjbGFyYXRpb25zOiBkZWNscwogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBkb2N1bWVudC4KICAgKi8KCiAgZnVuY3Rpb24gYXRkb2N1bWVudCgpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgdmFyIG0gPSBtYXRjaCgvXkAoWy1cd10rKT9kb2N1bWVudCAqKFtee10rKS8pOwogICAgaWYgKCFtKSByZXR1cm47CgogICAgdmFyIHZlbmRvciA9IHRyaW0obVsxXSk7CiAgICB2YXIgZG9jID0gdHJpbShtWzJdKTsKCiAgICBpZiAoIW9wZW4oKSkgcmV0dXJuIGVycm9yKCJAZG9jdW1lbnQgbWlzc2luZyAneyciKTsKCiAgICB2YXIgc3R5bGUgPSBjb21tZW50cygpLmNvbmNhdChydWxlcygpKTsKCiAgICBpZiAoIWNsb3NlKCkpIHJldHVybiBlcnJvcigiQGRvY3VtZW50IG1pc3NpbmcgJ30nIik7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdkb2N1bWVudCcsCiAgICAgIGRvY3VtZW50OiBkb2MsCiAgICAgIHZlbmRvcjogdmVuZG9yLAogICAgICBydWxlczogc3R5bGUKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgZm9udC1mYWNlLgogICAqLwoKICBmdW5jdGlvbiBhdGZvbnRmYWNlKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQGZvbnQtZmFjZSAqLyk7CiAgICBpZiAoIW0pIHJldHVybjsKCiAgICBpZiAoIW9wZW4oKSkgcmV0dXJuIGVycm9yKCJAZm9udC1mYWNlIG1pc3NpbmcgJ3snIik7CiAgICB2YXIgZGVjbHMgPSBjb21tZW50cygpOwoKICAgIC8vIGRlY2xhcmF0aW9ucwogICAgdmFyIGRlY2w7CiAgICB3aGlsZSAoZGVjbCA9IGRlY2xhcmF0aW9uKCkpIHsKICAgICAgZGVjbHMucHVzaChkZWNsKTsKICAgICAgZGVjbHMgPSBkZWNscy5jb25jYXQoY29tbWVudHMoKSk7CiAgICB9CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBmb250LWZhY2UgbWlzc2luZyAnfSciKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ2ZvbnQtZmFjZScsCiAgICAgIGRlY2xhcmF0aW9uczogZGVjbHMKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgaW1wb3J0CiAgICovCgogIHZhciBhdGltcG9ydCA9IF9jb21waWxlQXRydWxlKCdpbXBvcnQnKTsKCiAgLyoqCiAgICogUGFyc2UgY2hhcnNldAogICAqLwoKICB2YXIgYXRjaGFyc2V0ID0gX2NvbXBpbGVBdHJ1bGUoJ2NoYXJzZXQnKTsKCiAgLyoqCiAgICogUGFyc2UgbmFtZXNwYWNlCiAgICovCgogIHZhciBhdG5hbWVzcGFjZSA9IF9jb21waWxlQXRydWxlKCduYW1lc3BhY2UnKTsKCiAgLyoqCiAgICogUGFyc2Ugbm9uLWJsb2NrIGF0LXJ1bGVzCiAgICovCgoKICBmdW5jdGlvbiBfY29tcGlsZUF0cnVsZShuYW1lKSB7CiAgICB2YXIgcmUgPSBuZXcgUmVnRXhwKCdeQCcgKyBuYW1lICsgJyAqKFteO1xcbl0rKTsnKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICAgIHZhciBtID0gbWF0Y2gocmUpOwogICAgICBpZiAoIW0pIHJldHVybjsKICAgICAgdmFyIHJldCA9IHsgdHlwZTogbmFtZSB9OwogICAgICByZXRbbmFtZV0gPSBtWzFdLnRyaW0oKTsKICAgICAgcmV0dXJuIHBvcyhyZXQpOwogICAgfQogIH0KCiAgLyoqCiAgICogUGFyc2UgYXQgcnVsZS4KICAgKi8KCiAgZnVuY3Rpb24gYXRydWxlKCkgewogICAgaWYgKGNzc1swXSAhPSAnQCcpIHJldHVybjsKCiAgICByZXR1cm4gYXRrZXlmcmFtZXMoKQogICAgICB8fCBhdG1lZGlhKCkKICAgICAgfHwgYXRzdXBwb3J0cygpCiAgICAgIHx8IGF0aW1wb3J0KCkKICAgICAgfHwgYXRjaGFyc2V0KCkKICAgICAgfHwgYXRuYW1lc3BhY2UoKQogICAgICB8fCBhdGRvY3VtZW50KCkKICAgICAgfHwgYXRwYWdlKCkKICAgICAgfHwgYXRob3N0KCkKICAgICAgfHwgYXRmb250ZmFjZSgpOwogIH0KCiAgLyoqCiAgICogUGFyc2UgcnVsZS4KICAgKi8KCiAgZnVuY3Rpb24gcnVsZSgpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgdmFyIHNlbCA9IHNlbGVjdG9yKCk7CgogICAgaWYgKCFzZWwpIHJldHVybiBlcnJvcignc2VsZWN0b3IgbWlzc2luZycpOwogICAgY29tbWVudHMoKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ3J1bGUnLAogICAgICBzZWxlY3RvcnM6IHNlbCwKICAgICAgZGVjbGFyYXRpb25zOiBkZWNsYXJhdGlvbnMoKQogICAgfSk7CiAgfQoKICByZXR1cm4gc3R5bGVzaGVldCgpOwp9OwoKLyoqCiAqIFRyaW0gYHN0cmAuCiAqLwoKZnVuY3Rpb24gdHJpbShzdHIpIHsKICByZXR1cm4gc3RyID8gc3RyLnJlcGxhY2UoL15ccyt8XHMrJC9nLCAnJykgOiAnJzsKfQpsaWIuaGVscGVycy5DbG9uZSA9IGZ1bmN0aW9uIGNsb25lKGl0ZW0pIHsKICAgIGlmICghaXRlbSkgeyByZXR1cm4gaXRlbTsgfSAvLyBudWxsLCB1bmRlZmluZWQgdmFsdWVzIGNoZWNrCgogICAgdmFyIHR5cGVzID0gWyBOdW1iZXIsIFN0cmluZywgQm9vbGVhbiBdLCAKICAgICAgICByZXN1bHQ7CgogICAgLy8gbm9ybWFsaXppbmcgcHJpbWl0aXZlcyBpZiBzb21lb25lIGRpZCBuZXcgU3RyaW5nKCdhYWEnKSwgb3IgbmV3IE51bWJlcignNDQ0Jyk7CiAgICBmb3IodmFyIGk9MDsgaTx0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB0eXBlID0gdHlwZXNbaV07CiAgICAgICAgaWYoaXRlbSBpbnN0YW5jZW9mIHR5cGUpIHsKICAgICAgICAgICAgcmVzdWx0ID0gdHlwZSggaXRlbSApOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodHlwZW9mIHJlc3VsdCA9PSAidW5kZWZpbmVkIikgewogICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIGl0ZW0gKSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgICAgICAgICByZXN1bHQgPSBbXTsKICAgICAgICAgICAgaXRlbS5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkLCBpbmRleCwgYXJyYXkpIHsgCiAgICAgICAgICAgICAgICByZXN1bHRbaW5kZXhdID0gY2xvbmUoIGNoaWxkICk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgLy8gdGVzdGluZyB0aGF0IHRoaXMgaXMgRE9NCiAgICAgICAgICAgIGlmIChpdGVtLm5vZGVUeXBlICYmIHR5cGVvZiBpdGVtLmNsb25lTm9kZSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gaXRlbS5jbG9uZU5vZGUoIHRydWUgKTsgICAgCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWl0ZW0ucHJvdG90eXBlKSB7IC8vIGNoZWNrIHRoYXQgdGhpcyBpcyBhIGxpdGVyYWwKICAgICAgICAgICAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IG5ldyBEYXRlKGl0ZW0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBpdCBpcyBhbiBvYmplY3QgbGl0ZXJhbAogICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gaXRlbSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRbaV0gPSBjbG9uZSggaXRlbVtpXSApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIGRlcGVuZGluZyB3aGF0IHlvdSB3b3VsZCBsaWtlIGhlcmUsCiAgICAgICAgICAgICAgICAvLyBqdXN0IGtlZXAgdGhlIHJlZmVyZW5jZSwgb3IgY3JlYXRlIG5ldyBvYmplY3QKICAgICAgICAgICAgICAgIGlmIChmYWxzZSAmJiBpdGVtLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gd291bGQgbm90IGFkdmljZSB0byBkbyB0aGF0LCByZWFzb24/IFJlYWQgYmVsb3cKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgaXRlbS5jb25zdHJ1Y3RvcigpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBpdGVtOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0ID0gaXRlbTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3VsdDsKfQovLyBjcmVkaXRzOiBodHRwOi8vd3d3LnNpdGVwb2ludC5jb20vamF2YXNjcmlwdC1nZW5lcmF0ZS1saWdodGVyLWRhcmtlci1jb2xvci8KbGliLmhlbHBlcnMuQ29sb3JMdW1pbmFuY2UgPSBmdW5jdGlvbiAoaGV4LCBsdW0pIHsKCgkvLyB2YWxpZGF0ZSBoZXggc3RyaW5nCgloZXggPSBTdHJpbmcoaGV4KS5yZXBsYWNlKC9bXjAtOWEtZl0vZ2ksICcnKTsKCWlmIChoZXgubGVuZ3RoIDwgNikgewoJCWhleCA9IGhleFswXStoZXhbMF0raGV4WzFdK2hleFsxXStoZXhbMl0raGV4WzJdOwoJfQoJbHVtID0gbHVtIHx8IDA7CgoJLy8gY29udmVydCB0byBkZWNpbWFsIGFuZCBjaGFuZ2UgbHVtaW5vc2l0eQoJdmFyIHJnYiA9ICIjIiwgYywgaTsKCWZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKCQljID0gcGFyc2VJbnQoaGV4LnN1YnN0cihpKjIsMiksIDE2KTsKCQljID0gTWF0aC5yb3VuZChNYXRoLm1pbihNYXRoLm1heCgwLCBjICsgKGMgKiBsdW0pKSwgMjU1KSkudG9TdHJpbmcoMTYpOwoJCXJnYiArPSAoIjAwIitjKS5zdWJzdHIoYy5sZW5ndGgpOwoJfQoKCXJldHVybiByZ2I7Cn0KbGliLmhlbHBlcnMuRXh0ZW5kID0gZnVuY3Rpb24oKSB7Cgl2YXIgcHJvY2VzcyA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsJCgkgICAgZm9yKHZhciBrZXkgaW4gc291cmNlKSB7CgkJCWlmKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKCQkJICAgIGRlc3RpbmF0aW9uW2tleV0gPSBzb3VyY2Vba2V5XTsKCQkJfQoJICAgIH0KCSAgICByZXR1cm4gZGVzdGluYXRpb247Cgl9OwoJdmFyIHJlc3VsdCA9IGFyZ3VtZW50c1swXTsKCWZvcih2YXIgaT0xOyBpPGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCXJlc3VsdCA9IHByb2Nlc3MocmVzdWx0LCBhcmd1bWVudHNbaV0pOwoJfQoJcmV0dXJuIHJlc3VsdDsKfQovLyBodHRwOi8vZG9jcy5lbW1ldC5pby9jc3MtYWJicmV2aWF0aW9ucy92ZW5kb3ItcHJlZml4ZXMvICh3OiB3ZWJraXQsIG06IG1veiwgczogbXMsIG86IG8pCnZhciBwcmVmaXhFeHRyYWN0ID0gZnVuY3Rpb24ocHJvcCkgewoJdmFyIHJlc3VsdCwgbWF0Y2g7CglpZigobWF0Y2ggPSBwcm9wLm1hdGNoKC9eXC0od3xtfHN8bykrXC0vKSB8fCBwcm9wLmNoYXJBdCgwKSA9PT0gJy0nKSAmJiAhcHJvcC5tYXRjaCgvXlwtKHdlYmtpdHxtb3p8bXMpK1wtLykpIHsKCQlpZihtYXRjaCAhPT0gbnVsbCAmJiBtYXRjaFswXSkgewoJCQlyZXN1bHQgPSB7IHByZWZpeDogbWF0Y2hbMF0ucmVwbGFjZSgvLS9nLCAnJykgfQoJCQlyZXN1bHQucHJvcCA9IHByb3AucmVwbGFjZShtYXRjaFswXSwgJycpOwoJCX0gZWxzZSB7CgkJCXJlc3VsdCA9IHsgcHJlZml4OiAnJyB9CgkJCXJlc3VsdC5wcm9wID0gcHJvcC5zdWJzdHIoMSwgcHJvcC5sZW5ndGgpOwoJCX0KCX0gZWxzZSB7CgkJcmVzdWx0ID0gewoJCQlwcmVmaXg6IGZhbHNlLAoJCQlwcm9wOiBwcm9wCgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQpsaWIuaGVscGVycy5QcmVmaXhlcyA9IHsKCWFkZFByZWZpeGVzOiBmdW5jdGlvbihwcm9wLCBvYmopIHsKCQl2YXIgb3JpZ2luYWxQcm9wID0gcHJvcCwgcCA9IHByZWZpeEV4dHJhY3QocHJvcCksIHZhbHVlID0gb2JqW3Byb3BdOwoJCWlmKHAucHJlZml4ICE9PSBmYWxzZSkgewoJCQlkZWxldGUgb2JqW29yaWdpbmFsUHJvcF07CgkJCW9ialtwLnByb3BdID0gdmFsdWU7CgkJCWlmKHAucHJlZml4ID09PSAnJyB8fCBwLnByZWZpeC5pbmRleE9mKCd3JykgPj0gMCkKCQkJCW9ialsnLXdlYmtpdC0nICsgcC5wcm9wXSA9IHZhbHVlOwoJCQlpZihwLnByZWZpeCA9PT0gJycgfHwgcC5wcmVmaXguaW5kZXhPZignbScpID49IDApCgkJCQlvYmpbJy1tb3otJyArIHAucHJvcF0gPSB2YWx1ZTsKCQkJaWYocC5wcmVmaXggPT09ICcnIHx8IHAucHJlZml4LmluZGV4T2YoJ3MnKSA+PSAwKQoJCQkJb2JqWyctbXMtJyArIHAucHJvcF0gPSB2YWx1ZTsKCQkJaWYocC5wcmVmaXggPT09ICcnIHx8IHAucHJlZml4LmluZGV4T2YoJ28nKSA+PSAwKQoJCQkJb2JqWyctby0nICsgcC5wcm9wXSA9IHZhbHVlOwoJCX0KCX0sCglub25QcmVmaXhQcm9wOiBmdW5jdGlvbihwcm9wKSB7CgkJdmFyIHAgPSBwcmVmaXhFeHRyYWN0KHByb3ApOwoJCWlmKHAucHJlZml4ICE9PSBmYWxzZSkgewoJCQlpZihwLnByZWZpeCA9PSAnJykgeyAKCQkJCXAucHJlZml4ID0gJy0nOwoJCQl9IGVsc2UgewoJCQkJcC5wcmVmaXggPSAnLScgKyBwLnByZWZpeCArICctJzsgCgkJCX0KCQl9CgkJcmV0dXJuIHA7Cgl9Cn0KbGliLmhlbHBlcnMuUmVxdWlyZVVuY2FjaGVkID0gZnVuY3Rpb24obW9kdWxlKSB7CglkZWxldGUgcmVxdWlyZS5jYWNoZVtyZXF1aXJlLnJlc29sdmUobW9kdWxlKV0KICAgIHJldHVybiByZXF1aXJlKG1vZHVsZSk7Cn0KbGliLmhlbHBlcnMuVHJhbnNmb3JtVXBwZXJjYXNlID0gZnVuY3Rpb24ocHJvcCwgb3B0aW9ucykgewoJdmFyIHRyYW5zZm9ybWVkID0gIiI7Cglmb3IodmFyIGk9MDsgYz1wcm9wLmNoYXJBdChpKTsgaSsrKSB7CgkJaWYoYyA9PT0gYy50b1VwcGVyQ2FzZSgpICYmIGMudG9Mb3dlckNhc2UoKSAhPT0gYy50b1VwcGVyQ2FzZSgpKSB7CgkJCXRyYW5zZm9ybWVkICs9ICItIiArIGMudG9Mb3dlckNhc2UoKTsKCQl9IGVsc2UgewoJCQl0cmFuc2Zvcm1lZCArPSBjOwoJCX0KCX0KCXJldHVybiB0cmFuc2Zvcm1lZDsKfQp2YXIgY29tcGlsZUNvbXBvbmVudCA9IGZ1bmN0aW9uKGlucHV0LCBjYWxsYmFjaywgb3B0aW9ucykgewoKCXZhciBjc3MgPSAiIiwgCgkJaHRtbCA9ICIiLCAKCQlhbGwgPSBbXSwKCQlhcGkgPSBvcHRpb25zLmFwaTsKCQljc3NQcmVwcm9jZXNzb3IgPSByZXF1aXJlKF9fZGlybmFtZSArICIvLi4vY3NzL0NTUy5qcyIpKCksCgkJaHRtbFByZXByb2Nlc3NvciA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi9odG1sL0hUTUwuanMiKSgpOwoKCXZhciBwcm9jZXNzQ1NTID0gZnVuY3Rpb24oY2xiKSB7CgkJZm9yKHZhciBpPTA7IGk8YWxsLmxlbmd0aCwgY29tcG9uZW50PWFsbFtpXTsgaSsrKSB7CgkJCWlmKHR5cGVvZiBjb21wb25lbnQgPT09ICJmdW5jdGlvbiIpIHsgY29tcG9uZW50ID0gY29tcG9uZW50KCk7IH0KCQkJYXBpLmFkZChjb21wb25lbnQuY3NzID8gY29tcG9uZW50LmNzcyA6IHt9KTsKCQl9CgkJY3NzUHJlcHJvY2Vzc29yKGFwaS5nZXRSdWxlcygpLCBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewoJCQljc3MgKz0gcmVzdWx0OwoJCQljbGIoZXJyKTsKCQl9LCBvcHRpb25zKTsKCX0KCXZhciBwcm9jZXNzSFRNTCA9IGZ1bmN0aW9uKGNsYikgewoJCXZhciBpbmRleCA9IDA7CgkJdmFyIGVycm9yID0gbnVsbDsKCQl2YXIgcHJvY2Vzc0NvbXBvbmVudCA9IGZ1bmN0aW9uKCkgewoJCQlpZihpbmRleCA+IGlucHV0Lmxlbmd0aC0xKSB7CgkJCQljbGIoZXJyb3IpOwoJCQkJcmV0dXJuOwoJCQl9CgkJCXZhciBjID0gaW5wdXRbaW5kZXhdOwoJCQlpZih0eXBlb2YgYyA9PT0gImZ1bmN0aW9uIikgeyBjID0gYygpOyB9CgkJCWFwaS5tb3JwaCgiaHRtbCIpLmFkZChjLmh0bWwgPyBjLmh0bWwgOiB7fSk7CgkJCWh0bWxQcmVwcm9jZXNzb3IoYXBpLmdldFJ1bGVzKCksIGZ1bmN0aW9uKGVyciwgcmVzdWx0KSB7CgkJCQlodG1sICs9IHJlc3VsdDsKCQkJCWluZGV4ICs9IDE7CgkJCQllcnJvciA9IGVycjsKCQkJCXByb2Nlc3NDb21wb25lbnQoKTsKCQkJfSwgb3B0aW9ucyk7CgkJfQoJCXByb2Nlc3NDb21wb25lbnQoKTsKCX0KCXZhciBjaGVja0Zvck5lc3RpbmcgPSBmdW5jdGlvbihvKSB7CgkJZm9yKHZhciBrZXkgaW4gbykgewoJCQlpZihrZXkgPT09ICJfaW5jbHVkZSIpIHsKCQkJCWlmKG9ba2V5XSBpbnN0YW5jZW9mIEFycmF5KSB7CgkJCQkJZm9yKHZhciBpPTA7IGk8b1trZXldLmxlbmd0aCwgYz1vW2tleV1baV07IGkrKykgewoJCQkJCQlpZih0eXBlb2YgYyA9PT0gImZ1bmN0aW9uIikgeyBjID0gYygpOyB9CgkJCQkJCWFsbC5wdXNoKGMpOwoJCQkJCQljaGVja0Zvck5lc3RpbmcoYyk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlpZih0eXBlb2Ygb1trZXldID09PSAiZnVuY3Rpb24iKSB7IG9ba2V5XSA9IG9ba2V5XSgpOyB9CgkJCQkJYWxsLnB1c2gob1trZXldKTsKCQkJCQljaGVja0Zvck5lc3Rpbmcob1trZXldKTsKCQkJCX0KCQkJfSBlbHNlIGlmKHR5cGVvZiBvW2tleV0gPT09ICJvYmplY3QiKSB7CgkJCQljaGVja0Zvck5lc3Rpbmcob1trZXldKTsKCQkJfQoJCX0KCX0KCgkvLyBDaGVja2luZyBmb3IgbmVzdGluZy4gSS5lLiBjb2xsZWN0aW5nIHRoZSBjc3MgYW5kIGh0bWwuCglmb3IodmFyIGk9MDsgaTxpbnB1dC5sZW5ndGgsIGM9aW5wdXRbaV07IGkrKykgewoJCWlmKHR5cGVvZiBjID09PSAiZnVuY3Rpb24iKSB7IGMgPSBjKCk7IH0KCQlhbGwucHVzaChjKTsKCQljaGVja0Zvck5lc3RpbmcoYyk7Cgl9CgoJYXBpLmZsdXNoKCk7Cglwcm9jZXNzQ1NTKGZ1bmN0aW9uKGVyckNTUykgewoJCWFwaS5tb3JwaCgiaHRtbCIpOwoJCXByb2Nlc3NIVE1MKGZ1bmN0aW9uKGVyckhUTUwpIHsKCQkJY2FsbGJhY2soCgkJCQllcnJDU1MgfHwgZXJySFRNTCA/IHtlcnJvcjoge2NzczogZXJyQ1NTLCBodG1sOiBlcnJIVE1MIH19IDogbnVsbCwKCQkJCWNzcywKCQkJCWh0bWwKCQkJKQoJCX0pOwoJfSk7CgkKfQpsaWIucHJvY2Vzc29ycy5jb21wb25lbnQuQ29tcG9uZW50ID0gZnVuY3Rpb24oKSB7Cgl2YXIgcHJvY2Vzc29yID0gZnVuY3Rpb24ocnVsZXMsIGNhbGxiYWNrLCBvcHRpb25zKSB7CgkJY29tcGlsZUNvbXBvbmVudChydWxlcy5tYWluc3RyZWFtLCBjYWxsYmFjaywgb3B0aW9ucyk7Cgl9Cglwcm9jZXNzb3IudHlwZSA9ICJjb21wb25lbnQiOwoJcmV0dXJuIHByb2Nlc3NvcjsKfQp2YXIgbmV3bGluZSA9ICdcbicsCglkZWZhdWx0T3B0aW9ucyA9IHsKCQljb21iaW5lU2VsZWN0b3JzOiB0cnVlLAoJCW1pbmlmeTogZmFsc2UsCgkJa2VlcENhbWVsQ2FzZTogZmFsc2UKCX0sCgl0cmFuc2Zvcm1VcHBlcmNhc2UgPSByZXF1aXJlKCIuLi8uLi9oZWxwZXJzL1RyYW5zZm9ybVVwcGVyY2FzZSIpLAoJZXh0ZW5kID0gcmVxdWlyZSgiLi4vLi4vaGVscGVycy9FeHRlbmQiKTsKCnZhciB0b0NTUyA9IGZ1bmN0aW9uKHJ1bGVzLCBvcHRpb25zLCBpbmRlbnQpIHsKCXZhciBjc3MgPSAnJzsKCWluZGVudCA9IGluZGVudCB8fCBbJycsICcgICddOwoJZm9yKHZhciBzZWxlY3RvciBpbiBydWxlcykgewoJCS8vIGhhbmRsaW5nIHJhdyBjb250ZW50CgkJaWYoc2VsZWN0b3IuaW5kZXhPZigiX19fX3JhdyIpID09PSAwKSB7CgkJCWNzcyArPSBydWxlc1tzZWxlY3Rvcl1bc2VsZWN0b3JdICsgbmV3bGluZTsKCQkvLyBoYW5kbGluZyBub3JtYWwgc3R5bGVzCgkJfSBlbHNlIHsKCQkJdmFyIGVudGl0eVN0eWxlID0gaW5kZW50WzBdICsgc2VsZWN0b3IucmVwbGFjZSgvfn4oLispfn4vLCAnJykucmVwbGFjZSgvXiUuKj8lLywgJycpICsgJyB7JyArIG5ld2xpbmU7CgkJCXZhciBlbnRpdHkgPSAnJzsKCQkJZm9yKHZhciBwcm9wIGluIHJ1bGVzW3NlbGVjdG9yXSkgewoJCQkJdmFyIHZhbHVlID0gcnVsZXNbc2VsZWN0b3JdW3Byb3BdOwoJCQkJaWYodmFsdWUgPT09ICIiKSB7CgkJCQkJdmFsdWUgPSAnIiInOwoJCQkJfQoJCQkJcHJvcCA9IHByb3AucmVwbGFjZSgvfn4oLispfn4vLCAnJykucmVwbGFjZSgvXiUuKj8lLywgJycpOwoJCQkJaWYob3B0aW9ucyAmJiBvcHRpb25zLmtlZXBDYW1lbENhc2UgPT09IHRydWUpIHsKCQkJCQllbnRpdHkgKz0gaW5kZW50WzFdICsgcHJvcCArICc6ICcgKyB2YWx1ZSArICc7JyArIG5ld2xpbmU7CgkJCQl9IGVsc2UgewoJCQkJCWVudGl0eSArPSBpbmRlbnRbMV0gKyB0cmFuc2Zvcm1VcHBlcmNhc2UocHJvcCkgKyAnOiAnICsgdmFsdWUgKyAnOycgKyBuZXdsaW5lOwoJCQkJfQoJCQl9CgkJCWlmKGVudGl0eSAhPSAnJykgewoJCQkJZW50aXR5U3R5bGUgKz0gZW50aXR5OwoJCQkJZW50aXR5U3R5bGUgKz0gaW5kZW50WzBdICsgJ30nICsgbmV3bGluZTsKCQkJCWNzcyArPSBlbnRpdHlTdHlsZTsKCQkJfQoJCX0KCX0KCXJldHVybiBjc3M7Cn0KCnZhciB0b0pTT04gPSBmdW5jdGlvbihydWxlcywgb3B0aW9ucykgewoJdmFyIHJlc3VsdCA9IHt9OwoJZm9yKHZhciBzdHlsZXNoZWV0IGluIHJ1bGVzKSB7CgkJdmFyIHN0eWxlcyA9IHJ1bGVzW3N0eWxlc2hlZXRdOwoJCWlmKHN0eWxlc2hlZXQgPT0gJ21haW5zdHJlYW0nKSB7CgkJCWZvcih2YXIgc2VsZWN0b3IgaW4gc3R5bGVzKSB7CgkJCQlyZXN1bHRbc2VsZWN0b3JdID0ge30KCQkJCWZvcih2YXIgcHJvcCBpbiBzdHlsZXNbc2VsZWN0b3JdKSB7CgkJCQkJcmVzdWx0W3NlbGVjdG9yXVtwcm9wXSA9IHN0eWxlc1tzZWxlY3Rvcl1bcHJvcF07CgkJCQl9CgkJCX0JCQkKCQl9IGVsc2UgaWYoc3R5bGVzaGVldC5pbmRleE9mKCdAbWVkaWEnKSA+PSAwKSB7CgkJCXJlc3VsdFtzdHlsZXNoZWV0XSA9IHt9OwoJCQlmb3IodmFyIHNlbGVjdG9yIGluIHN0eWxlcykgewoJCQkJcmVzdWx0W3N0eWxlc2hlZXRdW3NlbGVjdG9yXSA9IHt9CgkJCQlmb3IodmFyIHByb3AgaW4gc3R5bGVzW3NlbGVjdG9yXSkgewoJCQkJCXJlc3VsdFtzdHlsZXNoZWV0XVtzZWxlY3Rvcl1bcHJvcF0gPSBzdHlsZXNbc2VsZWN0b3JdW3Byb3BdOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKLy8gY29tYmluaW5nIHNlbGVjdG9ycwp2YXIgY29tYmluZVNlbGVjdG9ycyA9IGZ1bmN0aW9uKHJ1bGVzLCBwcmV2ZW50Q29tYmluaW5nKSB7CgoJdmFyIG1hcCA9IFtdLCBhcnIgPSB7fTsKCXZhciBwcmV2ZW50Q29tYmluaW5nID0gW10uY29uY2F0KHByZXZlbnRDb21iaW5pbmcgfHwgW10pOwoJcHJldmVudENvbWJpbmluZy5zcGxpY2UoMCwgMCwgJycpOwoJcHJldmVudENvbWJpbmluZyA9IHByZXZlbnRDb21iaW5pbmcuam9pbignfCcpOwoKCS8vIGV4dHJhY3RpbmcgZXZlcnkgcHJvcGVydHkKCWZvcih2YXIgc2VsZWN0b3IgaW4gcnVsZXMpIHsKCQl2YXIgcHJvcHMgPSBydWxlc1tzZWxlY3Rvcl07CgkJZm9yKHZhciBwcm9wIGluIHByb3BzKSB7CgkJCW1hcC5wdXNoKHsKCQkJCXNlbGVjdG9yOiBzZWxlY3RvciwgCgkJCQlwcm9wOiBwcm9wLCAKCQkJCXZhbHVlOiBwcm9wc1twcm9wXSwgCgkJCQljb21iaW5lOiBwcmV2ZW50Q29tYmluaW5nLmluZGV4T2YoJ3wnICsgcHJvcCkgPCAwICYmIHNlbGVjdG9yLmluZGV4T2YoJ0Bmb250LWZhY2UnKSA8IDAKCQkJfSk7CgkJfQoJfQoKCS8vIGNvbWJpbmluZwoJZm9yKHZhciBpPTA7IGk8bWFwLmxlbmd0aDsgaSsrKSB7CgkJaWYobWFwW2ldLmNvbWJpbmUgPT09IHRydWUgJiYgbWFwW2ldLnNlbGVjdG9yICE9PSBmYWxzZSkgewoJCQlmb3IodmFyIGo9aSsxO2o8bWFwLmxlbmd0aDsgaisrKSB7CgkJCQlpZihtYXBbaV0ucHJvcCA9PT0gbWFwW2pdLnByb3AgJiYgbWFwW2ldLnZhbHVlID09PSBtYXBbal0udmFsdWUpIHsKCQkJCQltYXBbaV0uc2VsZWN0b3IgKz0gJywgJyArIG1hcFtqXS5zZWxlY3Rvci5yZXBsYWNlKC9+figuKyl+fi8sICcnKS5yZXBsYWNlKC9eJS4qPyUvLCAnJyk7CgkJCQkJbWFwW2pdLnNlbGVjdG9yID0gZmFsc2U7IC8vIG1hcmtpbmcgZm9yIHJlbW92YWwKCQkJCX0KCQkJfQoJCX0KCX0KCgkvLyBwcmVwYXJpbmcgdGhlIHJlc3VsdAoJZm9yKHZhciBpPTA7IGk8bWFwLmxlbmd0aDsgaSsrKSB7CgkJaWYobWFwW2ldLnNlbGVjdG9yICE9PSBmYWxzZSkgewoJCQlpZighYXJyW21hcFtpXS5zZWxlY3Rvcl0pIGFyclttYXBbaV0uc2VsZWN0b3JdID0ge30KCQkJYXJyW21hcFtpXS5zZWxlY3Rvcl1bbWFwW2ldLnByb3BdID0gbWFwW2ldLnZhbHVlOwoJCX0KCX0KCQoJcmV0dXJuIGFycjsKfQoKdmFyIG1pbmltaXplID0gZnVuY3Rpb24oY29udGVudCkgewogICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggL1wvXCooPzooPyFcKlwvKVtcc1xTXSkqXCpcL3xbXHJcblx0XSsvZywgJycgKTsKICAgIC8vIG5vdyBhbGwgY29tbWVudHMsIG5ld2xpbmVzIGFuZCB0YWJzIGhhdmUgYmVlbiByZW1vdmVkCiAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKCAvIHsyLH0vZywgJyAnICk7CiAgICAvLyBub3cgdGhlcmUgYXJlIG5vIG1vcmUgdGhhbiBzaW5nbGUgYWRqYWNlbnQgc3BhY2VzIGxlZnQKICAgIC8vIG5vdyB1bm5lY2Vzc2FyeTogY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggLyhccykrXC4vZywgJyAuJyApOwogICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggLyAoW3s6fV0pIC9nLCAnJDEnICk7CiAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKCAvKFs7LF0pIC9nLCAnJDEnICk7CiAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKCAvICEvZywgJyEnICk7CiAgICByZXR1cm4gY29udGVudDsKfQoKdmFyIHJlcGxhY2VEZWZpbmVkID0gZnVuY3Rpb24oY3NzLCBvcHRpb25zKSB7CglpZihvcHRpb25zICYmIG9wdGlvbnMuYXBpICYmIG9wdGlvbnMuYXBpLmdldFN0b3JhZ2UoKS5fX2RlZmluZWQpIHsKCQl2YXIgc3RvcmFnZSA9IG9wdGlvbnMuYXBpLmdldFN0b3JhZ2UoKS5fX2RlZmluZWQ7CgkJZm9yKHZhciBwcm9wIGluIHN0b3JhZ2UpIHsKCQkJdmFyIHJlID0gbmV3IFJlZ0V4cCgnPCUoICk/JyArIHByb3AgKyAnKCApPyU+JywgJ2cnKTsKCQkJaWYodHlwZW9mIHN0b3JhZ2VbcHJvcF0gIT0gJ2Z1bmN0aW9uJykgewoJCQkJY3NzID0gY3NzLnJlcGxhY2UocmUsIHN0b3JhZ2VbcHJvcF0pOwoJCQl9IGVsc2UgewoJCQkJY3NzID0gY3NzLnJlcGxhY2UocmUsIHN0b3JhZ2VbcHJvcF0oKSk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gY3NzOwp9CgpsaWIucHJvY2Vzc29ycy5jc3MuQ1NTID0gZnVuY3Rpb24oKSB7Cgl2YXIgcHJvY2Vzc29yID0gZnVuY3Rpb24ocnVsZXMsIGNhbGxiYWNrLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwgZGVmYXVsdE9wdGlvbnM7CgkJaWYob3B0aW9ucy5hcGkgJiYgb3B0aW9ucy5hcGkuanNvbmlmeSkgewoJCQl2YXIganNvbiA9IHRvSlNPTihydWxlcywgb3B0aW9ucyk7CgkJCWNhbGxiYWNrKG51bGwsIGpzb24pOwoJCQlyZXR1cm4ganNvbjsKCQl9CgkJdmFyIGNzcyA9ICcnOwoJCWZvcih2YXIgc3R5bGVzaGVldCBpbiBydWxlcykgewoJCQl2YXIgciA9IHJ1bGVzW3N0eWxlc2hlZXRdOwoJCQlyID0gb3B0aW9ucy5jb21iaW5lU2VsZWN0b3JzID8gY29tYmluZVNlbGVjdG9ycyhyLCBvcHRpb25zLnByZXZlbnRDb21iaW5pbmcpIDogcjsKCQkJaWYoc3R5bGVzaGVldCA9PT0gIm1haW5zdHJlYW0iKSB7CgkJCQljc3MgKz0gdG9DU1Mociwgb3B0aW9ucyk7CgkJCX0gZWxzZSB7CgkJCQljc3MgKz0gc3R5bGVzaGVldCArICIgeyIgKyBuZXdsaW5lICsgdG9DU1Mociwgb3B0aW9ucywgWycgICcsICcgICAgJ10pICsgIn0iICsgbmV3bGluZTsKCQkJfQkJCgkJfQoJCWNzcyA9IHJlcGxhY2VEZWZpbmVkKGNzcywgb3B0aW9ucyk7CgkJLy8gRHluYW1pYyBDU1MKCQlpZihvcHRpb25zICYmIG9wdGlvbnMuYXBpICYmIG9wdGlvbnMuYXBpLmR5bmFtaWNDU1MpIHsKCQkJY3NzID0gcmVxdWlyZSgiLi4vaHRtbC9oZWxwZXJzL1RlbXBsYXRlRW5naW5lIikoY3NzLCBvcHRpb25zKTsKCQl9CgkJLy8gTWluaWZpY2F0aW9uCgkJaWYob3B0aW9ucy5taW5pZnkpIHsKCQkJY3NzID0gbWluaW1pemUoY3NzKTsKCQkJaWYoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwsIGNzcyk7CgkJfSBlbHNlIHsKCQkJaWYoY2FsbGJhY2spIGNhbGxiYWNrKG51bGwsIGNzcyk7CgkJfQoJCXJldHVybiBjc3M7Cgl9Cglwcm9jZXNzb3IudHlwZSA9ICJjc3MiOwoJcmV0dXJuIHByb2Nlc3NvcjsKfQoKbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMuY2hhcnNldCA9IGZ1bmN0aW9uKCkgewkKCXJldHVybiBmdW5jdGlvbihhcGksIGNoYXJzZXRWYWx1ZSkgewoJCWlmKHR5cGVvZiBjaGFyc2V0VmFsdWUgPT09ICJzdHJpbmciKSB7CgkJCWFwaS5yYXcoIkBjaGFyc2V0OiBcIiIgKyBjaGFyc2V0VmFsdWUgKyAiXCI7Iik7CgkJfSBlbHNlIGlmKHR5cGVvZiBjaGFyc2V0VmFsdWUgPT09ICJvYmplY3QiKSB7CgkJCWNoYXJzZXRWYWx1ZSA9IGNoYXJzZXRWYWx1ZS5jaGFyc2V0LnJlcGxhY2UoLzovZywgJycpLnJlcGxhY2UoLycvZywgJycpLnJlcGxhY2UoLyIvZywgJycpLnJlcGxhY2UoLyAvZywgJycpOwoJCQlhcGkucmF3KCJAY2hhcnNldDogXCIiICsgY2hhcnNldFZhbHVlICsgIlwiOyIpOwoJCX0KCX0KfQpsaWIucHJvY2Vzc29ycy5jc3MucGx1Z2lucy5kb2N1bWVudCA9IGZ1bmN0aW9uKCkgewkKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewoJCQl2YXIgc3R5bGVzaGVldCA9ICcnOwoJCQlzdHlsZXNoZWV0ICs9ICdAJyArIHZhbHVlLnZlbmRvciArICdkb2N1bWVudCc7CgkJCXN0eWxlc2hlZXQgKz0gJyAnICsgdmFsdWUuZG9jdW1lbnQ7CgkJCWlmKHZhbHVlLnJ1bGVzICYmIHZhbHVlLnJ1bGVzLmxlbmd0aCkgewoJCQkJZm9yKHZhciBpPTA7IHJ1bGU9dmFsdWUucnVsZXNbaV07IGkrKykgewoJCQkJCWFwaS5oYW5kbGVjc3NydWxlKHJ1bGUsIHN0eWxlc2hlZXQpOwoJCQkJfQoJCQl9IGVsc2UgaWYodHlwZW9mIHZhbHVlLnN0eWxlcyAhPSAidW5kZWZpbmVkIikgewoJCQkJYXBpLmFkZCh2YWx1ZS5zdHlsZXMsIHN0eWxlc2hlZXQpOwoJCQl9CgkJfQoJfQp9CmxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zLmtleWZyYW1lcyA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuIGZ1bmN0aW9uKGFwaSwgdmFsdWUpIHsKCQl2YXIgcHJvY2Vzc29yID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uL0NTUy5qcyIpKCk7CgkJdmFyIHByZWZpeGVzID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uLy4uLy4uL2hlbHBlcnMvUHJlZml4ZXMiKTsKCQlpZih0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CgkJCS8vIGpzIG9yIGpzb24KCQkJdmFyIGZyYW1lczsKCQkJaWYodHlwZW9mIHZhbHVlLmZyYW1lcyAhPSAidW5kZWZpbmVkIikgewoJCQkJZnJhbWVzID0gdmFsdWUuZnJhbWVzOwoJCQkvLyBjc3MKCQkJfSBlbHNlIGlmKHR5cGVvZiB2YWx1ZS5rZXlmcmFtZXMgIT0gInVuZGVmaW5lZCIpIHsKCQkJCWZyYW1lcyA9IHt9OwoJCQkJZm9yKHZhciBpPTA7IHJ1bGU9dmFsdWUua2V5ZnJhbWVzW2ldOyBpKyspIHsKCQkJCQlpZihydWxlLnR5cGUgPT09ICJrZXlmcmFtZSIpIHsKCQkJCQkJdmFyIGYgPSBmcmFtZXNbcnVsZS52YWx1ZXNdID0ge307CgkJCQkJCWZvcih2YXIgaj0wOyBkZWNsYXJhdGlvbj1ydWxlLmRlY2xhcmF0aW9uc1tqXTsgaisrKSB7CgkJCQkJCQlpZihkZWNsYXJhdGlvbi50eXBlID09PSAiZGVjbGFyYXRpb24iKSB7CgkJCQkJCQkJZltkZWNsYXJhdGlvbi5wcm9wZXJ0eV0gPSBkZWNsYXJhdGlvbi52YWx1ZTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQlpZihhcGkuanNvbmlmeSkgewoJCQkJdmFyIHIgPSB7fTsKCQkJCXIua2V5ZnJhbWVzID0gewoJCQkJCW5hbWU6IHZhbHVlLm5hbWUsCgkJCQkJZnJhbWVzOiBmcmFtZXMKCQkJCX0KCQkJCWFwaS5hZGQocik7CgkJCX0gZWxzZSB7CgkJCQl2YXIgYWJzdXJkID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAnLy4uLy4uLy4uLy4uLycpKCk7CgkJCQlhYnN1cmQuYWRkKGZyYW1lcykuY29tcGlsZShmdW5jdGlvbihlcnIsIGNzcykgewoJCQkJCXZhciBjb250ZW50ID0gJ0BrZXlmcmFtZXMgJyArIHZhbHVlLm5hbWUgKyAiIHtcbiI7CgkJCQkJY29udGVudCArPSBjc3M7CgkJCQkJY29udGVudCArPSAifSI7CgkJCQkJY29udGVudCA9IGNvbnRlbnQgKyAiXG4iICsgY29udGVudC5yZXBsYWNlKCJAa2V5ZnJhbWVzIiwgIkAtd2Via2l0LWtleWZyYW1lcyIpOwoJCQkJCWFwaS5yYXcoY29udGVudCk7CgkJCQl9LCB7Y29tYmluZVNlbGVjdG9yczogZmFsc2V9KTsJCgkJCX0JCQkKCQl9Cgl9Cn0KbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMubWVkaWEgPSBmdW5jdGlvbigpIHsKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJdmFyIHByb2Nlc3NvciA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi9DU1MuanMiKSgpOwoJCWlmKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJdmFyIGNvbnRlbnQgPSAnQG1lZGlhICcgKyB2YWx1ZS5tZWRpYSArICIge1xuIjsKCQkJdmFyIHJ1bGVzID0ge30sIGpzb24gPSB7fTsKCQkJZm9yKHZhciBpPTA7IHJ1bGU9dmFsdWUucnVsZXNbaV07IGkrKykgewoJCQkJdmFyCgkJCQkJciwgcmpzb247CgkJCQlpZiAocnVsZS5zZWxlY3RvcnMpIHsKCQkJCQlyID0gcnVsZXNbcnVsZS5zZWxlY3RvcnMudG9TdHJpbmcoKV0gPSB7fTsKCQkJCQlyanNvbiA9IGpzb25bcnVsZS5zZWxlY3RvcnMudG9TdHJpbmcoKV0gPSB7fTsKCQkJCQlpZihydWxlLnR5cGUgPT09ICJydWxlIikgewoJCQkJCQlmb3IodmFyIGo9MDsgZGVjbGFyYXRpb249cnVsZS5kZWNsYXJhdGlvbnNbal07IGorKykgewoJCQkJCQkJaWYoZGVjbGFyYXRpb24udHlwZSA9PT0gImRlY2xhcmF0aW9uIikgewoJCQkJCQkJCXJbZGVjbGFyYXRpb24ucHJvcGVydHldID0gZGVjbGFyYXRpb24udmFsdWU7CgkJCQkJCQkJcmpzb25bZGVjbGFyYXRpb24ucHJvcGVydHldID0gZGVjbGFyYXRpb24udmFsdWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQkKCQkJfQoJCQljb250ZW50ICs9IHByb2Nlc3Nvcih7bWFpbnN0cmVhbTogcnVsZXN9KTsKCQkJY29udGVudCArPSAifSI7CgkJCWlmKGFwaS5qc29uaWZ5KSB7CgkJCQlhcGkuYWRkKGpzb24sICdAbWVkaWEgJyArIHZhbHVlLm1lZGlhKTsKCQkJfSBlbHNlIHsKCQkJCWFwaS5yYXcoY29udGVudCk7CgkJCX0KCQl9Cgl9Cn0KbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMubmFtZXNwYWNlID0gZnVuY3Rpb24oKSB7CQoJcmV0dXJuIGZ1bmN0aW9uKGFwaSwgdmFsdWUpIHsKCQlpZih0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CgkJCWFwaS5yYXcoIkBuYW1lc3BhY2U6IFwiIiArIHZhbHVlICsgIlwiOyIpOwoJCX0gZWxzZSBpZih0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CgkJCXZhbHVlID0gdmFsdWUubmFtZXNwYWNlLnJlcGxhY2UoLzogL2csICcnKS5yZXBsYWNlKC8nL2csICcnKS5yZXBsYWNlKC8iL2csICcnKS5yZXBsYWNlKC8gL2csICcnKS5yZXBsYWNlKC86aC9nLCAnaCcpOwoJCQlhcGkucmF3KCJAbmFtZXNwYWNlOiBcIiIgKyB2YWx1ZSArICJcIjsiKTsKCQl9Cgl9Cn0KbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMucGFnZSA9IGZ1bmN0aW9uKCkgewkKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewoJCQl2YXIgY29udGVudCA9ICIiOyAKCQkJaWYodmFsdWUuc2VsZWN0b3JzLmxlbmd0aCA+IDApIHsKCQkJCWNvbnRlbnQgKz0gIkBwYWdlICIgKyB2YWx1ZS5zZWxlY3RvcnMuam9pbigiLCAiKSArICIge1xuIjsKCQkJfSBlbHNlIHsKCQkJCWNvbnRlbnQgKz0gIkBwYWdlIHtcbiI7CgkJCX0KCQkJZm9yKHZhciBpPTA7IGRlY2xhcmF0aW9uPXZhbHVlLmRlY2xhcmF0aW9uc1tpXTsgaSsrKSB7CgkJCQlpZihkZWNsYXJhdGlvbi50eXBlID09ICJkZWNsYXJhdGlvbiIpIHsKCQkJCQljb250ZW50ICs9ICIgICIgKyBkZWNsYXJhdGlvbi5wcm9wZXJ0eSArICI6ICIgKyBkZWNsYXJhdGlvbi52YWx1ZSArICI7XG4iOwoJCQkJfQoJCQl9CgkJCWNvbnRlbnQgKz0gIn0iOwoJCQlhcGkucmF3KGNvbnRlbnQpOwoJCX0KCX0KfQpsaWIucHJvY2Vzc29ycy5jc3MucGx1Z2lucy5zdXBwb3J0cyA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuIGZ1bmN0aW9uKGFwaSwgdmFsdWUpIHsKCQl2YXIgcHJvY2Vzc29yID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uL0NTUy5qcyIpKCk7CgkJaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewoJCQl2YXIgY29udGVudCA9ICdAc3VwcG9ydHMgJyArIHZhbHVlLnN1cHBvcnRzICsgIiB7XG4iOwoJCQl2YXIgcnVsZXMgPSB7fTsKCQkJZm9yKHZhciBpPTA7IHJ1bGU9dmFsdWUucnVsZXNbaV07IGkrKykgewkJCQkKCQkJCXZhciByID0gcnVsZXNbcnVsZS5zZWxlY3RvcnMudG9TdHJpbmcoKV0gPSB7fTsKCQkJCWlmKHJ1bGUudHlwZSA9PT0gInJ1bGUiKSB7CgkJCQkJZm9yKHZhciBqPTA7IGRlY2xhcmF0aW9uPXJ1bGUuZGVjbGFyYXRpb25zW2pdOyBqKyspIHsKCQkJCQkJaWYoZGVjbGFyYXRpb24udHlwZSA9PT0gImRlY2xhcmF0aW9uIikgewoJCQkJCQkJcltkZWNsYXJhdGlvbi5wcm9wZXJ0eV0gPSBkZWNsYXJhdGlvbi52YWx1ZTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQljb250ZW50ICs9IHByb2Nlc3Nvcih7bWFpbnN0cmVhbTogcnVsZXN9KTsKCQkJY29udGVudCArPSAifSI7CgkJCWFwaS5yYXcoY29udGVudCk7CgkJfQoJfQp9CnZhciBkYXRhID0gbnVsbCwKCW5ld2xpbmUgPSAnXG4nLAoJZGVmYXVsdE9wdGlvbnMgPSB7fSwKCXRhZ3MgPSBbXSwKCWJlYXV0aWZ5SFRNTCA9IHJlcXVpcmUoJ2pzLWJlYXV0aWZ5JykuaHRtbCwKCXR1ID0gcmVxdWlyZSgiLi4vLi4vaGVscGVycy9UcmFuc2Zvcm1VcHBlcmNhc2UiKSwKCXBhc3NlZE9wdGlvbnMgPSB7fTsKCnZhciBwcm9jZXNzVGVtcGxhdGUgPSBmdW5jdGlvbih0ZW1wbGF0ZU5hbWUpIHsKCXZhciBodG1sID0gJyc7Cglmb3IodmFyIHRlbXBsYXRlIGluIGRhdGEpIHsKCQlpZih0ZW1wbGF0ZSA9PSB0ZW1wbGF0ZU5hbWUpIHsKCQkJdmFyIG51bU9mUnVsZXMgPSBkYXRhW3RlbXBsYXRlXS5sZW5ndGg7CgkJCWZvcih2YXIgaT0wOyBpPG51bU9mUnVsZXM7IGkrKykgewoJCQkJaHRtbCArPSBwcm9jZXNzKCcnLCBkYXRhW3RlbXBsYXRlXVtpXSk7CgkJCX0KCQl9Cgl9CglyZXR1cm4gaHRtbDsKfQp2YXIgcHJlcGFyZVByb3BlcnR5ID0gZnVuY3Rpb24ocHJvcCwgb3B0aW9ucykgewoJaWYob3B0aW9ucyAmJiBvcHRpb25zLmtlZXBDYW1lbENhc2UgPT09IHRydWUpIHsKCQlyZXR1cm4gcHJvcDsKCX0gZWxzZSB7CgkJcmV0dXJuIHR1KHByb3AsIG9wdGlvbnMpOwoJfQp9CnZhciBwcm9jZXNzID0gZnVuY3Rpb24odGFnTmFtZSwgb2JqKSB7CgkvLyBjb25zb2xlLmxvZygiLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4iLCB0YWdOYW1lLCAiPiIsIG9iaik7CgoJdmFyIGh0bWwgPSAnJywgYXR0cnMgPSAnJywgY2hpbGRzID0gJyc7CgoJdmFyIHRhZ0FuYWxpemVkID0gcmVxdWlyZSgiLi9oZWxwZXJzL1Byb3BBbmFseXplciIpKHRhZ05hbWUpOwoJdGFnTmFtZSA9IHRhZ0FuYWxpemVkLnRhZzsKCWlmKHRhZ0FuYWxpemVkLmF0dHJzICE9ICIiKSB7CgkJYXR0cnMgKz0gIiAiICsgdGFnQW5hbGl6ZWQuYXR0cnM7Cgl9CgoJaWYodHlwZW9mIG9iaiA9PT0gInN0cmluZyIgfHwgb2JqID09PSBudWxsKSB7CgkJcmV0dXJuIHBhY2tUYWcodGFnTmFtZSwgYXR0cnMsIG9iaik7Cgl9CgoJdmFyIGFkZFRvQ2hpbGRzID0gZnVuY3Rpb24odmFsdWUpIHsKCQlpZihjaGlsZHMgIT0gJycpIHsgY2hpbGRzICs9IG5ld2xpbmU7IH0KCQljaGlsZHMgKz0gdmFsdWU7Cgl9CgoJLy8gcHJvY2VzcyBkaXJlY3RpdmVzCglmb3IodmFyIGRpcmVjdGl2ZU5hbWUgaW4gb2JqKSB7CgkJdmFyIHZhbHVlID0gb2JqW2RpcmVjdGl2ZU5hbWVdOwoJCXN3aXRjaChkaXJlY3RpdmVOYW1lKSB7CgkJCWNhc2UgIl9hdHRycyI6CgkJCQlmb3IodmFyIGF0dHJOYW1lIGluIHZhbHVlKSB7CgkJCQkJaWYodHlwZW9mIHZhbHVlW2F0dHJOYW1lXSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQlhdHRycyArPSAiICIgKyBwcmVwYXJlUHJvcGVydHkoYXR0ck5hbWUsIHBhc3NlZE9wdGlvbnMpICsgIj1cIiIgKyB2YWx1ZVthdHRyTmFtZV0oKSArICJcIiI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJYXR0cnMgKz0gIiAiICsgcHJlcGFyZVByb3BlcnR5KGF0dHJOYW1lLCBwYXNzZWRPcHRpb25zKSArICI9XCIiICsgdmFsdWVbYXR0ck5hbWVdICsgIlwiIjsKCQkJCQl9CgkJCQl9CgkJCWJyZWFrOwoJCQljYXNlICJfIjoKCQkJCWFkZFRvQ2hpbGRzKHZhbHVlKTsKCQkJYnJlYWs7CgkJCWNhc2UgIl90cGwiOiAKCQkJCWlmKHR5cGVvZiB2YWx1ZSA9PSAic3RyaW5nIikgewoJCQkJCWFkZFRvQ2hpbGRzKHByb2Nlc3NUZW1wbGF0ZSh2YWx1ZSkpOwoJCQkJfSBlbHNlIGlmKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHsKCQkJCQl2YXIgdG1wID0gJyc7CgkJCQkJZm9yKHZhciBpPTA7IHRwbD12YWx1ZVtpXTsgaSsrKSB7CgkJCQkJCXRtcCArPSBwcm9jZXNzVGVtcGxhdGUodHBsKQoJCQkJCQlpZihpIDwgdmFsdWUubGVuZ3RoLTEpIHRtcCArPSBuZXdsaW5lOwoJCQkJCX0KCQkJCQlhZGRUb0NoaWxkcyh0bXApOwoJCQkJfQoJCQlicmVhazsKCQkJY2FzZSAiX2luY2x1ZGUiOgoJCQkJdmFyIHRtcCA9ICcnOwoJCQkJdmFyIGFkZCA9IGZ1bmN0aW9uKG8pIHsKCQkJCQlpZih0eXBlb2YgbyA9PT0gImZ1bmN0aW9uIikgeyBvID0gbygpOyB9CgkJCQkJaWYoby5jc3MgJiYgby5odG1sKSB7IG8gPSBvLmh0bWw7IH0gLy8gY2F0Y2hpbmcgYSBjb21wb25lbnQKCQkJCQl0bXAgKz0gcHJvY2VzcygnJywgbyk7CgkJCQl9CgkJCQlpZih2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CgkJCQkJZm9yKHZhciBpPTA7IGk8dmFsdWUubGVuZ3RoLCBvPXZhbHVlW2ldOyBpKyspIHsKCQkJCQkJYWRkKG8pOwoJCQkJCX0KCQkJCX0gZWxzZSBpZih0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKXsKCQkJCQlhZGQodmFsdWUpOwoJCQkJfQoJCQkJYWRkVG9DaGlsZHModG1wKTsKCQkJYnJlYWs7CgkJCWRlZmF1bHQ6CgkJCQlzd2l0Y2godHlwZW9mIHZhbHVlKSB7CgkJCQkJY2FzZSAic3RyaW5nIjogYWRkVG9DaGlsZHMocHJvY2VzcyhkaXJlY3RpdmVOYW1lLCB2YWx1ZSkpOyBicmVhazsKCQkJCQljYXNlICJvYmplY3QiOiAKCQkJCQkJaWYodmFsdWUgJiYgdmFsdWUubGVuZ3RoICYmIHZhbHVlLmxlbmd0aCA+IDApIHsKCQkJCQkJCXZhciB0bXAgPSAnJzsKCQkJCQkJCWZvcih2YXIgaT0wOyB2PXZhbHVlW2ldOyBpKyspIHsKCQkJCQkJCQl0bXAgKz0gcHJvY2VzcygnJywgdHlwZW9mIHYgPT0gImZ1bmN0aW9uIiA/IHYoKSA6IHYpOwoJCQkJCQkJCWlmKGkgPCB2YWx1ZS5sZW5ndGgtMSkgdG1wICs9IG5ld2xpbmU7CgkJCQkJCQl9CgkJCQkJCQlhZGRUb0NoaWxkcyhwcm9jZXNzKGRpcmVjdGl2ZU5hbWUsIHRtcCkpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJYWRkVG9DaGlsZHMocHJvY2VzcyhkaXJlY3RpdmVOYW1lLCB2YWx1ZSkpOwoJCQkJCQl9CgkJCQkJYnJlYWs7CgkJCQkJY2FzZSAiZnVuY3Rpb24iOiBhZGRUb0NoaWxkcyhwcm9jZXNzKGRpcmVjdGl2ZU5hbWUsIHZhbHVlKCkpKTsgYnJlYWs7CgkJCQl9CgkJCWJyZWFrOwoJCX0KCX0KCglpZih0YWdOYW1lICE9ICcnKSB7CgkJaHRtbCArPSBwYWNrVGFnKHRhZ05hbWUsIGF0dHJzLCBjaGlsZHMpOwoJfSBlbHNlIHsKCQlodG1sICs9IGNoaWxkczsKCX0KCglyZXR1cm4gaHRtbDsKfQp2YXIgcGFja1RhZyA9IGZ1bmN0aW9uKHRhZ05hbWUsIGF0dHJzLCBjaGlsZHMpIHsKCXZhciBodG1sID0gJyc7CglpZih0YWdOYW1lID09ICcnICYmIGF0dHJzID09ICcnICYmIGNoaWxkcyAhPSAnJykgewoJCXJldHVybiBjaGlsZHM7Cgl9Cgl0YWdOYW1lID0gdGFnTmFtZSA9PSAnJyA/ICdkaXYnIDogdGFnTmFtZTsKCWlmKGNoaWxkcyAhPT0gbnVsbCkgewoJCWh0bWwgKz0gJzwnICsgcHJlcGFyZVByb3BlcnR5KHRhZ05hbWUsIHBhc3NlZE9wdGlvbnMpICsgYXR0cnMgKyAnPicgKyBuZXdsaW5lICsgY2hpbGRzICsgbmV3bGluZSArICc8LycgKyBwcmVwYXJlUHJvcGVydHkodGFnTmFtZSwgcGFzc2VkT3B0aW9ucykgKyAnPic7Cgl9IGVsc2UgewoJCWh0bWwgKz0gJzwnICsgcHJlcGFyZVByb3BlcnR5KHRhZ05hbWUsIHBhc3NlZE9wdGlvbnMpICsgYXR0cnMgKyAnLz4nOwoJfQoJcmV0dXJuIGh0bWw7Cn0KdmFyIHByZXBhcmVIVE1MID0gZnVuY3Rpb24oaHRtbCkgewoJaHRtbCA9IHJlcXVpcmUoIi4vaGVscGVycy9UZW1wbGF0ZUVuZ2luZSIpKGh0bWwucmVwbGFjZSgvW1xyXHRcbl0vZywgJycpLCBwYXNzZWRPcHRpb25zKTsKCWlmKHBhc3NlZE9wdGlvbnMubWluaWZ5KSB7CgkJcmV0dXJuIGh0bWw7Cgl9IGVsc2UgewoJCXJldHVybiBiZWF1dGlmeUhUTUwoaHRtbCwge2luZGVudF9zaXplOiBwYXNzZWRPcHRpb25zLmluZGVudFNpemUgfHwgNH0pOwoJfQp9CmxpYi5wcm9jZXNzb3JzLmh0bWwuSFRNTCA9IGZ1bmN0aW9uKCkgewoJdmFyIHByb2Nlc3NvciA9IGZ1bmN0aW9uKHJ1bGVzLCBjYWxsYmFjaywgb3B0aW9ucykgewoJCWRhdGEgPSBydWxlczsKCQljYWxsYmFjayA9IGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCkge307CgkJb3B0aW9ucyA9IHBhc3NlZE9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRPcHRpb25zOwoJCXZhciBodG1sID0gcHJlcGFyZUhUTUwocHJvY2Vzc1RlbXBsYXRlKCJtYWluc3RyZWFtIikpOwoJCWNhbGxiYWNrKG51bGwsIGh0bWwpOwoJCXJldHVybiBodG1sOwoJfQoJcHJvY2Vzc29yLnR5cGUgPSAiaHRtbCI7CglyZXR1cm4gcHJvY2Vzc29yOwp9CmxpYi5wcm9jZXNzb3JzLmh0bWwuaGVscGVycy5Qcm9wQW5hbHl6ZXIgPSBmdW5jdGlvbihwcm9wKSB7Cgl2YXIgcmVzID0geyAKCQkJdGFnOiAnJywKCQkJYXR0cnM6ICcnCgkJfSwKCQludW1PZkNoYXJzID0gcHJvcC5sZW5ndGgsCgkJdGFnTmFtZSA9ICIiLAoJCWNsYXNzTmFtZSA9ICIiLCByZWFkaW5nQ2xhc3MgPSBmYWxzZSwgY2xhc3NlcyA9IFtdLAoJCWlkTmFtZSA9ICIiLCByZWFkaW5nSWQgPSBmYWxzZSwgaWRzID0gW10sCgkJYXR0cmlidXRlcyA9ICIiLCByZWFkaW5nQXR0cmlidXRlcyA9IGZhbHNlOwoKCWlmKC8oI3xcLnxcW3xcXSkvZ2kudGVzdChwcm9wKSA9PT0gZmFsc2UpIHsKCQlyZXR1cm4gewoJCQl0YWc6IHByb3AsCgkJCWF0dHJzOiAnJwoJCX07Cgl9CgoJZm9yKHZhciBpPTA7IGk8cHJvcC5sZW5ndGgsIGM9cHJvcFtpXTsgaSsrKSB7CgkJaWYoYyA9PT0gIlsiICYmICFyZWFkaW5nQXR0cmlidXRlcykgewoJCQlyZWFkaW5nQXR0cmlidXRlcyA9IHRydWU7CgkJfSBlbHNlIGlmKHJlYWRpbmdBdHRyaWJ1dGVzKSB7CgkJCWlmKGMgIT0gIl0iKSB7CgkJCQlhdHRyaWJ1dGVzICs9IGM7CgkJCX0gZWxzZSB7CgkJCQlyZWFkaW5nQXR0cmlidXRlcyA9IGZhbHNlOwoJCQkJaSAtPSAxOwoJCQl9CgkJfSBlbHNlIGlmKGMgPT09ICIuIiAmJiAhcmVhZGluZ0NsYXNzKSB7CgkJCXJlYWRpbmdDbGFzcyA9IHRydWU7CgkJfSBlbHNlIGlmKHJlYWRpbmdDbGFzcykgewoJCQlpZihjICE9ICIuIiAmJiBjICE9ICIjIiAmJiBjICE9ICJbIiAmJiBjICE9ICJdIikgewoJCQkJY2xhc3NOYW1lICs9IGM7CgkJCX0gZWxzZSB7CgkJCQljbGFzc2VzLnB1c2goY2xhc3NOYW1lKTsKCQkJCXJlYWRpbmdDbGFzcyA9IGZhbHNlOwoJCQkJY2xhc3NOYW1lID0gIiI7CgkJCQlpIC09IDE7CgkJCX0KCQl9IGVsc2UgaWYoYyA9PT0gIiMiICYmICFyZWFkaW5nSWQpIHsKCQkJcmVhZGluZ0lkID0gdHJ1ZTsKCQl9IGVsc2UgaWYocmVhZGluZ0lkKSB7CgkJCWlmKGMgIT0gIi4iICYmIGMgIT0gIiMiICYmIGMgIT0gIlsiICYmIGMgIT0gIl0iKSB7CgkJCQlpZE5hbWUgKz0gYzsKCQkJfSBlbHNlIHsKCQkJCXJlYWRpbmdJZCA9IGZhbHNlOwoJCQkJaSAtPSAxOwoJCQl9CgkJfSBlbHNlIGlmKGMgIT0gIi4iICYmIGMgIT0gIiMiICYmIGMgIT0gIlsiICYmIGMgIT0gIl0iKSB7CgkJCXJlcy50YWcgKz0gYzsKCQl9Cgl9CgoJLy8gaWYgZW5kcyB3aXRoIGEgY2xhc3MKCWlmKGNsYXNzTmFtZSAhPSAiIikgY2xhc3Nlcy5wdXNoKGNsYXNzTmFtZSk7CgoJLy8gY29sbGVjdGluZyBjbGFzc2VzCgl2YXIgY2xzU3RyID0gJyc7Cglmb3IodmFyIGk9MDsgY2xzPWNsYXNzZXNbaV07IGkrKykgewoJCWNsc1N0ciArPSBjbHNTdHIgPT09ICIiID8gY2xzIDogIiAiICsgY2xzOwoJfQoJcmVzLmF0dHJzICs9IGNsc1N0ciAhPSAiIiA/ICdjbGFzcz0iJyArIGNsc1N0ciArICciJyA6ICcnOwoKCS8vIGlmIGVuZHMgb24gaWQKCWlmKGlkTmFtZSAhPSAiIikgewoJCXJlcy5hdHRycyArPSAocmVzLmF0dHJzICE9ICIiID8gIiAiIDogIiIpICsgJ2lkPSInICsgaWROYW1lICsgJyInOwoJfQoKCS8vIGlmIGRpdiB0YWcgbmFtZSBpcyBza2lwcGVkCglpZihyZXMudGFnID09PSAiIiAmJiByZXMuYXR0cnMgIT0gIiIpIHJlcy50YWcgPSAiZGl2IjsKCgkvLyBjb2xsZWN0aW5nIGF0dHJpYnV0ZXMKCWlmKGF0dHJpYnV0ZXMgIT0gIiIpIHsKCQlyZXMuYXR0cnMgKz0gKHJlcy5hdHRycyAhPSAiIiA/ICIgIiA6ICIiKSArIGF0dHJpYnV0ZXM7Cgl9CgoJcmV0dXJuIHJlczsKfQpsaWIucHJvY2Vzc29ycy5odG1sLmhlbHBlcnMuVGVtcGxhdGVFbmdpbmUgPSBmdW5jdGlvbihodG1sLCBvcHRpb25zKSB7Cgl2YXIgcmUgPSAvPCUoLis/KSU+L2csIAoJCXJlRXhwID0gLyheKCApPyh2YXJ8aWZ8Zm9yfGVsc2V8c3dpdGNofGNhc2V8YnJlYWt8e3x9fDspKSguKik/L2csIAoJCWNvZGUgPSAnd2l0aChvYmopIHsgdmFyIHI9W107XG4nLCAKCQljdXJzb3IgPSAwLCAKCQlyZXN1bHQ7Cgl2YXIgYWRkID0gZnVuY3Rpb24obGluZSwganMpIHsKCQlqcz8gKGNvZGUgKz0gbGluZS5tYXRjaChyZUV4cCkgPyBsaW5lICsgJ1xuJyA6ICdyLnB1c2goJyArIGxpbmUgKyAnKTtcbicpIDoKCQkJKGNvZGUgKz0gbGluZSAhPSAnJyA/ICdyLnB1c2goIicgKyBsaW5lLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyIpO1xuJyA6ICcnKTsKCQlyZXR1cm4gYWRkOwoJfQoJd2hpbGUobWF0Y2ggPSByZS5leGVjKGh0bWwpKSB7CgkJYWRkKGh0bWwuc2xpY2UoY3Vyc29yLCBtYXRjaC5pbmRleCkpKG1hdGNoWzFdLCB0cnVlKTsKCQljdXJzb3IgPSBtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aDsKCX0KCWFkZChodG1sLnN1YnN0cihjdXJzb3IsIGh0bWwubGVuZ3RoIC0gY3Vyc29yKSk7Cgljb2RlID0gKGNvZGUgKyAncmV0dXJuIHIuam9pbigiIik7IH0nKS5yZXBsYWNlKC9bXHJcdFxuXS9nLCAnJyk7Cgl0cnkgeyByZXN1bHQgPSBuZXcgRnVuY3Rpb24oJ29iaicsIGNvZGUpLmFwcGx5KG9wdGlvbnMsIFtvcHRpb25zXSk7IH0KCWNhdGNoKGVycikgeyBjb25zb2xlLmVycm9yKCInIiArIGVyci5tZXNzYWdlICsgIiciLCAiIGluIFxuXG5Db2RlOlxuIiwgY29kZSwgIlxuIik7IH0KCXJldHVybiByZXN1bHQ7Cn07CnJldHVybiBjbGllbnQoKTsKfSkod2luZG93KTs=",
                "body": "LyogdmVyc2lvbjogMC4zLjMxLCBib3JuOiAxNy0xMC0yMDE0IDIzOjQ4ICovCnZhciBBYnN1cmQgPSAoZnVuY3Rpb24odykgewp2YXIgbGliID0geyAKICAgIGFwaToge30sCiAgICBoZWxwZXJzOiB7fSwKICAgIHBsdWdpbnM6IHt9LAogICAgcHJvY2Vzc29yczogeyAKICAgICAgICBjc3M6IHsgcGx1Z2luczoge319LAogICAgICAgIGh0bWw6IHsgCiAgICAgICAgICAgIHBsdWdpbnM6IHt9LAogICAgICAgICAgICBoZWxwZXJzOiB7fQogICAgICAgIH0sCiAgICAgICAgY29tcG9uZW50OiB7IHBsdWdpbnM6IHt9fQogICAgfQp9Owp2YXIgcmVxdWlyZSA9IGZ1bmN0aW9uKHYpIHsKICAgIC8vIGNzcyBwcmVwcm9jZXNzb3IKICAgIGlmKHYuaW5kZXhPZignY3NzL0NTUy5qcycpID4gMCB8fCB2ID09ICcvLi4vQ1NTLmpzJykgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5jc3MuQ1NTOwogICAgfSBlbHNlIGlmKHYuaW5kZXhPZignaHRtbC9IVE1MLmpzJykgPiAwKSB7CiAgICAgICAgcmV0dXJuIGxpYi5wcm9jZXNzb3JzLmh0bWwuSFRNTDsKICAgIH0gZWxzZSBpZih2LmluZGV4T2YoJ2NvbXBvbmVudC9Db21wb25lbnQuanMnKSA+IDApIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuY29tcG9uZW50LkNvbXBvbmVudDsKICAgIH0gZWxzZSBpZih2ID09ICdqcy1iZWF1dGlmeScpIHsKICAgICAgICByZXR1cm4geyAKICAgICAgICAgICAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGh0bWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYodiA9PSAnLi9oZWxwZXJzL1Byb3BBbmFseXplcicpIHsKICAgICAgICByZXR1cm4gbGliLnByb2Nlc3NvcnMuaHRtbC5oZWxwZXJzLlByb3BBbmFseXplcjsKICAgIH0gZWxzZSBpZih2ID09ICcuLi8uLi9oZWxwZXJzL1RyYW5zZm9ybVVwcGVyY2FzZScpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuVHJhbnNmb3JtVXBwZXJjYXNlOwogICAgfSBlbHNlIGlmKHYgPT0gJy4vaGVscGVycy9UZW1wbGF0ZUVuZ2luZScgfHwgdiA9PSAnLi4vaHRtbC9oZWxwZXJzL1RlbXBsYXRlRW5naW5lJykgewogICAgICAgIHJldHVybiBsaWIucHJvY2Vzc29ycy5odG1sLmhlbHBlcnMuVGVtcGxhdGVFbmdpbmU7CiAgICB9IGVsc2UgaWYodiA9PSAnLi4vaGVscGVycy9FeHRlbmQnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLkV4dGVuZDsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL0Nsb25lJykgewogICAgICAgIHJldHVybiBsaWIuaGVscGVycy5DbG9uZTsKICAgIH0gZWxzZSBpZih2ID09ICcuLi9oZWxwZXJzL1ByZWZpeGVzJyB8fCB2ID09ICcvLi4vLi4vLi4vaGVscGVycy9QcmVmaXhlcycpIHsKICAgICAgICByZXR1cm4gbGliLmhlbHBlcnMuUHJlZml4ZXM7CiAgICB9IGVsc2UgaWYodiA9PSBfX2Rpcm5hbWUgKyAnLy4uLy4uLy4uLy4uLycpIHsKICAgICAgICByZXR1cm4gQWJzdXJkOwogICAgfSBlbHNlIGlmKHYgPT0gJy4uL2hlbHBlcnMvQ1NTUGFyc2UnKSB7CiAgICAgICAgcmV0dXJuIGxpYi5oZWxwZXJzLkNTU1BhcnNlOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7fQogICAgfQp9Owp2YXIgX19kaXJuYW1lID0gIiI7CnZhciBxdWV1ZSAgPSBmdW5jdGlvbihmdW5jcywgc2NvcGUpIHsKCShmdW5jdGlvbiBuZXh0KCkgewoJCWlmKGZ1bmNzLmxlbmd0aCA+IDApIHsKCQkJZnVuY3Muc2hpZnQoKS5hcHBseShzY29wZSB8fCB7fSwgW25leHRdLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApKSk7CgkJfQoJfSkoKTsKfQp2YXIgc3RyMkRPTUVsZW1lbnQgPSBmdW5jdGlvbihodG1sKSB7CiAgIHZhciB3cmFwTWFwID0gewogICAgICAgIG9wdGlvbjogWyAxLCAiPHNlbGVjdCBtdWx0aXBsZT0nbXVsdGlwbGUnPiIsICI8L3NlbGVjdD4iIF0sCiAgICAgICAgbGVnZW5kOiBbIDEsICI8ZmllbGRzZXQ+IiwgIjwvZmllbGRzZXQ+IiBdLAogICAgICAgIGFyZWE6IFsgMSwgIjxtYXA+IiwgIjwvbWFwPiIgXSwKICAgICAgICBwYXJhbTogWyAxLCAiPG9iamVjdD4iLCAiPC9vYmplY3Q+IiBdLAogICAgICAgIHRoZWFkOiBbIDEsICI8dGFibGU+IiwgIjwvdGFibGU+IiBdLAogICAgICAgIHRyOiBbIDIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+IiBdLAogICAgICAgIGNvbDogWyAyLCAiPHRhYmxlPjx0Ym9keT48L3Rib2R5Pjxjb2xncm91cD4iLCAiPC9jb2xncm91cD48L3RhYmxlPiIgXSwKICAgICAgICB0ZDogWyAzLCAiPHRhYmxlPjx0Ym9keT48dHI+IiwgIjwvdHI+PC90Ym9keT48L3RhYmxlPiIgXSwKICAgICAgICBib2R5OiBbMCwgIiIsICIiXSwKICAgICAgICBfZGVmYXVsdDogWyAxLCAiPGRpdj4iLCAiPC9kaXY+IiAgXQogICAgfTsKICAgIHdyYXBNYXAub3B0Z3JvdXAgPSB3cmFwTWFwLm9wdGlvbjsKICAgIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgICB3cmFwTWFwLnRoID0gd3JhcE1hcC50ZDsKICAgIHZhciBtYXRjaCA9IC88XHMqXHcuKj8+L2cuZXhlYyhodG1sKTsKICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBpZihtYXRjaCAhPSBudWxsKSB7CiAgICAgICAgdmFyIHRhZyA9IG1hdGNoWzBdLnJlcGxhY2UoLzwvZywgJycpLnJlcGxhY2UoLz4vZywgJycpLnNwbGl0KCcgJylbMF07CiAgICAgICAgaWYodGFnLnRvTG93ZXJDYXNlKCkgPT09ICdib2R5JykgewogICAgICAgICAgICB2YXIgZG9tID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlRG9jdW1lbnQoJ2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwnLCAnaHRtbCcsIG51bGwpOwogICAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImJvZHkiKTsKICAgICAgICAgICAgLy8ga2VlcGluZyB0aGUgYXR0cmlidXRlcwogICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IGh0bWwucmVwbGFjZSgvPGJvZHkvZywgJzxkaXYnKS5yZXBsYWNlKC88XC9ib2R5Pi9nLCAnPC9kaXY+Jyk7CiAgICAgICAgICAgIHZhciBhdHRycyA9IGVsZW1lbnQuZmlyc3RDaGlsZC5hdHRyaWJ1dGVzOwogICAgICAgICAgICBib2R5LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGF0dHJzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBib2R5LnNldEF0dHJpYnV0ZShhdHRyc1tpXS5uYW1lLCBhdHRyc1tpXS52YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJvZHk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG1hcCA9IHdyYXBNYXBbdGFnXSB8fCB3cmFwTWFwLl9kZWZhdWx0LCBlbGVtZW50OwogICAgICAgICAgICBodG1sID0gbWFwWzFdICsgaHRtbCArIG1hcFsyXTsKICAgICAgICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgICAgICAvLyBEZXNjZW5kIHRocm91Z2ggd3JhcHBlcnMgdG8gdGhlIHJpZ2h0IGNvbnRlbnQKICAgICAgICAgICAgdmFyIGogPSBtYXBbMF0rMTsKICAgICAgICAgICAgd2hpbGUoai0tKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5sYXN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5sYXN0Q2hpbGQ7CiAgICB9CiAgICByZXR1cm4gZWxlbWVudDsKfQp2YXIgYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKG9iaiwgZXZ0LCBmbmMpIHsKICAgIGlmIChvYmouYWRkRXZlbnRMaXN0ZW5lcikgeyAvLyBXM0MgbW9kZWwKICAgICAgICBvYmouYWRkRXZlbnRMaXN0ZW5lcihldnQsIGZuYywgZmFsc2UpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIGlmIChvYmouYXR0YWNoRXZlbnQpIHsgLy8gTWljcm9zb2Z0IG1vZGVsCiAgICAgICAgcmV0dXJuIG9iai5hdHRhY2hFdmVudCgnb24nICsgZXZ0LCBmbmMpOwogICAgfQp9CnZhciByZW1vdmVFbXB0eVRleHROb2RlcyA9IGZ1bmN0aW9uKGVsZW0pIHsKICAgIHZhciBjaGlsZHJlbiA9IGVsZW0uY2hpbGROb2RlczsKICAgIHZhciBjaGlsZDsKICAgIHZhciBsZW4gPSBjaGlsZHJlbi5sZW5ndGg7CiAgICB2YXIgaSA9IDA7CiAgICB2YXIgd2hpdGVzcGFjZSA9IC9eXHMqJC87CiAgICBmb3IoOyBpIDwgbGVuOyBpKyspewogICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgaWYoY2hpbGQubm9kZVR5cGUgPT0gMyl7CiAgICAgICAgICAgIGlmKHdoaXRlc3BhY2UudGVzdChjaGlsZC5ub2RlVmFsdWUpKXsKICAgICAgICAgICAgICAgIGVsZW0ucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgbGVuLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbTsKfQp2YXIgY3JlYXRlTm9kZSA9IGZ1bmN0aW9uKHR5cGUsIGF0dHJzLCBjb250ZW50KSB7Cgl2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7Cglmb3IodmFyIGk9MDsgaTxhdHRycy5sZW5ndGgsIGE9YXR0cnNbaV07IGkrKykgewoJCW5vZGUuc2V0QXR0cmlidXRlKGEubmFtZSwgYS52YWx1ZSk7Cgl9Cglub2RlLmlubmVySFRNTCA9IGNvbnRlbnQ7CglyZXR1cm4gbm9kZTsKfQp2YXIgcXMgPSBmdW5jdGlvbihzZWxlY3RvciwgcGFyZW50KSB7CiAgICBpZihwYXJlbnQgPT09IGZhbHNlKSB7IHBhcmVudCA9IGRvY3VtZW50OyB9CiAgICBlbHNlIHsgcGFyZW50ID0gcGFyZW50IHx8IHRoaXMuZWwgfHwgZG9jdW1lbnQ7IH0KICAgIHJldHVybiBwYXJlbnQucXVlcnlTZWxlY3RvcihzZWxlY3Rvcik7Cn07CnZhciBxc2EgPSBmdW5jdGlvbihzZWxlY3RvciwgcGFyZW50KSB7CiAgICBpZihwYXJlbnQgPT09IGZhbHNlKSB7IHBhcmVudCA9IGRvY3VtZW50OyB9CiAgICBlbHNlIHsgcGFyZW50ID0gcGFyZW50IHx8IHRoaXMuZWwgfHwgZG9jdW1lbnQ7IH0KICAgIHJldHVybiBwYXJlbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3Rvcik7Cn07CnZhciBnZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlUHJvcCwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmKGVsICYmIGVsLmN1cnJlbnRTdHlsZSkgewogICAgICAgIHJldHVybiBlbC5jdXJyZW50U3R5bGVbc3R5bGVQcm9wXTsKICAgIH0gZWxzZSBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQuZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShzdHlsZVByb3ApOwogICAgfQogICAgcmV0dXJuIG51bGw7Cn07CnZhciBhZGRDbGFzcyA9IGZ1bmN0aW9uKGNsYXNzTmFtZSwgZWwpIHsKICAgIGVsID0gZWwgfHwgdGhpcy5lbDsKICAgIGlmKGVsLmNsYXNzTGlzdCkgewogICAgICAgIGVsLmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGN1cnJlbnQgPSBlbC5jbGFzc05hbWU7CiAgICAgICAgaWYoY3VycmVudC5pbmRleE9mKGNsYXNzTmFtZSkgPCAwKSB7CiAgICAgICAgICAgIGlmKGN1cnJlbnQgPT0gJycpIGVsLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTsKICAgICAgICAgICAgZWxzZSBlbC5jbGFzc05hbWUgKz0gJyAnICsgY2xhc3NOYW1lOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aGlzOwp9Owp2YXIgcmVtb3ZlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWUsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LnJlbW92ZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgY3VycmVudCA9IGVsLmNsYXNzTmFtZS5zcGxpdCgnICcpOwogICAgICAgIHZhciBuZXdDbGFzc2VzID0gW107CiAgICAgICAgZm9yKHZhciBpPTA7IGk8Y3VycmVudC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZihjdXJyZW50W2ldICE9IGNsYXNzTmFtZSkgbmV3Q2xhc3Nlcy5wdXNoKGN1cnJlbnRbaV0pOwogICAgICAgIH0KICAgICAgICBlbC5jbGFzc05hbWUgPSBuZXdDbGFzc2VzLmpvaW4oJyAnKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9CnZhciByZXBsYWNlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWVBLCBjbGFzc05hbWVCLCBlbCkgewogICAgZWwgPSBlbCB8fCB0aGlzLmVsOwogICAgdmFyIGN1cnJlbnQgPSBlbC5jbGFzc05hbWUuc3BsaXQoJyAnKSwgZm91bmQgPSBmYWxzZTsKICAgIGZvcih2YXIgaT0wOyBpPGN1cnJlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZihjdXJyZW50W2ldID09IGNsYXNzTmFtZUEpIHsKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBjdXJyZW50W2ldID0gY2xhc3NOYW1lQjsKICAgICAgICB9CiAgICB9CiAgICBpZighZm91bmQpIHsKICAgICAgICByZXR1cm4gYWRkQ2xhc3MoY2xhc3NOYW1lQiwgZWwpOwogICAgfQogICAgZWwuY2xhc3NOYW1lID0gY3VycmVudC5qb2luKCcgJyk7CiAgICByZXR1cm4gdGhpczsKfQp2YXIgdG9nZ2xlQ2xhc3MgPSBmdW5jdGlvbihjbGFzc05hbWUsIGVsKSB7CiAgICBlbCA9IGVsIHx8IHRoaXMuZWw7CiAgICBpZiAoZWwuY2xhc3NMaXN0KSB7CiAgICAgICAgZWwuY2xhc3NMaXN0LnRvZ2dsZShjbGFzc05hbWUpOwogICAgfSBlbHNlIHsKICAgICAgICB2YXIgY2xhc3NlcyA9IGVsLmNsYXNzTmFtZS5zcGxpdCgnICcpOwogICAgICAgIHZhciBleGlzdGluZ0luZGV4ID0gLTE7CiAgICAgICAgZm9yICh2YXIgaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KSB7CiAgICAgICAgICAgIGlmIChjbGFzc2VzW2ldID09PSBjbGFzc05hbWUpCiAgICAgICAgICAgICAgICBleGlzdGluZ0luZGV4ID0gaTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYoZXhpc3RpbmdJbmRleCA+PSAwKQogICAgICAgICAgICBjbGFzc2VzLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIGNsYXNzZXMucHVzaChjbGFzc05hbWUpOwoKICAgICAgICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwp9CnZhciBiaW5kID0gZnVuY3Rpb24oZnVuYywgc2NvcGUsIGFyZ3MpIHsKICAgIGlmKHNjb3BlIGluc3RhbmNlb2YgQXJyYXkpIHsgYXJncyA9IHNjb3BlOyBzY29wZSA9IHRoaXM7IH0KICAgIGlmKCFzY29wZSkgc2NvcGUgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmMuYXBwbHkoc2NvcGUsIChhcmdzIHx8IFtdKS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAwKSkpOwogICAgfQp9CnZhciBDb21wb25lbnQgPSBmdW5jdGlvbihjb21wb25lbnROYW1lLCBhYnN1cmQsIGV2ZW50QnVzLCBjbHMpIHsKCXZhciBhcGkgPSBsaWIuaGVscGVycy5FeHRlbmQoewoJCV9fbmFtZTogY29tcG9uZW50TmFtZQoJfSwgY2xzKTsKCXZhciBleHRlbmQgPSBsaWIuaGVscGVycy5FeHRlbmQ7CnZhciBsID0gW107CmFwaS5saXN0ZW5lcnMgPSBsOwphcGkub24gPSBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrLCBzY29wZSkgewoJaWYoIWxbZXZlbnROYW1lXSkgewoJCWxbZXZlbnROYW1lXSA9IFtdOwoJfQoJbFtldmVudE5hbWVdLnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgc2NvcGU6IHNjb3BlfSk7CglyZXR1cm4gdGhpczsKfTsKYXBpLm9mZiA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgaGFuZGxlcikgewoJaWYoIWxbZXZlbnROYW1lXSkgcmV0dXJuIHRoaXM7CglpZighaGFuZGxlcikgbFtldmVudE5hbWVdID0gW107IHJldHVybiB0aGlzOwoJdmFyIG5ld0FyciA9IFtdOwoJZm9yKHZhciBpPTA7IGk8bFtldmVudE5hbWVdLmxlbmd0aDsgaSsrKSB7CgkJaWYobFtldmVudE5hbWVdW2ldLmNhbGxiYWNrICE9PSBoYW5kbGVyKSB7CgkJCW5ld0Fyci5wdXNoKGxbZXZlbnROYW1lXVtpXSk7CgkJfQoJfQoJbFtldmVudE5hbWVdID0gbmV3QXJyOwoJcmV0dXJuIHRoaXM7Cn07CmFwaS5kaXNwYXRjaCA9IGZ1bmN0aW9uKGV2ZW50TmFtZSwgZGF0YSwgc2NvcGUpIHsKCWlmKGRhdGEgJiYgdHlwZW9mIGRhdGEgPT09ICdvYmplY3QnICYmICEoZGF0YSBpbnN0YW5jZW9mIEFycmF5KSkgewoJCWRhdGEudGFyZ2V0ID0gdGhpczsKCX0KCWlmKGxbZXZlbnROYW1lXSkgewoJCWZvcih2YXIgaT0wOyBpPGxbZXZlbnROYW1lXS5sZW5ndGg7IGkrKykgewoJCQl2YXIgY2FsbGJhY2sgPSBsW2V2ZW50TmFtZV1baV0uY2FsbGJhY2s7CgkJCWNhbGxiYWNrLmFwcGx5KHNjb3BlIHx8IGxbZXZlbnROYW1lXVtpXS5zY29wZSB8fCB7fSwgW2RhdGFdKTsKCQl9Cgl9CglpZih0aGlzW2V2ZW50TmFtZV0gJiYgdHlwZW9mIHRoaXNbZXZlbnROYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewoJCXRoaXNbZXZlbnROYW1lXShkYXRhKTsKCX0KCWlmKGV2ZW50QnVzKSBldmVudEJ1cy5kaXNwYXRjaChldmVudE5hbWUsIGRhdGEpOwoJcmV0dXJuIHRoaXM7Cn07CnZhciBzdG9yYWdlID0ge307CmFwaS5zZXQgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CglzdG9yYWdlW2tleV0gPSB2YWx1ZTsKCXJldHVybiB0aGlzOwp9OwphcGkuZ2V0ID0gZnVuY3Rpb24oa2V5KSB7CglyZXR1cm4gc3RvcmFnZVtrZXldOwp9Owp2YXIgQ1NTID0gZmFsc2U7CmFwaS5fX2hhbmRsZUNTUyA9IGZ1bmN0aW9uKG5leHQpIHsKCWlmKHRoaXMuY3NzKSB7CgkJYWJzdXJkLmZsdXNoKCkubW9ycGgoJ2R5bmFtaWMtY3NzJykuYWRkKHRoaXMuY3NzKS5jb21waWxlKGZ1bmN0aW9uKGVyciwgY3NzKSB7CgkJCWlmKCFDU1MpIHsKCQkJCXZhciBzdHlsZSA9IGNyZWF0ZU5vZGUoCgkJCQkJJ3N0eWxlJywgWwoJCQkJCQl7IG5hbWU6ICJpZCIsIHZhbHVlOiBjb21wb25lbnROYW1lICsgJy1jc3MnIH0sCgkJCQkJCXsgbmFtZTogInR5cGUiLCB2YWx1ZTogInRleHQvY3NzIn0KCQkJCQldLAoJCQkJCSBjc3MKCQkJCSk7CgkJCQkocXMoImhlYWQiKSB8fCBxcygiYm9keSIpKS5hcHBlbmRDaGlsZChzdHlsZSk7CgkJCQlDU1MgPSB7IHJhdzogY3NzLCBlbGVtZW50OiBzdHlsZSB9OwoJCQl9IGVsc2UgaWYoQ1NTLnJhdyAhPT0gY3NzKSB7CgkJCQlDU1MucmF3ID0gY3NzOwoJCQkJQ1NTLmVsZW1lbnQuaW5uZXJIVE1MID0gY3NzOwoJCQl9CgkJCW5leHQoKTsKCQl9LCB0aGlzKTsKCX0gZWxzZSB7CgkJbmV4dCgpOwoJfQoJcmV0dXJuIHRoaXM7Cn07CmFwaS5hcHBseUNTUyA9IGZ1bmN0aW9uKGRhdGEsIHByZXZlbnRDb21wb3NpdGlvbiwgc2tpcEF1dG9Qb3B1bGF0aW9uKSB7CglpZih0aGlzLmh0bWwgJiYgdHlwZW9mIHRoaXMuaHRtbCA9PT0gJ3N0cmluZycgJiYgIXByZXZlbnRDb21wb3NpdGlvbikgewoJCXZhciByZXMgPSB7fTsKCQlyZXNbdGhpcy5odG1sXSA9IGRhdGE7CgkJZGF0YSA9IHJlczsKCX0KCXRoaXMuY3NzID0gZGF0YTsKCWlmKCFza2lwQXV0b1BvcHVsYXRpb24pIHsKCQl0aGlzLnBvcHVsYXRlKCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKdmFyIEhUTUxTb3VyY2UgPSBmYWxzZTsKCmFwaS5fX21lcmdlRE9NRWxlbWVudHMgPSBmdW5jdGlvbihlMSwgZTIpIHsJCglyZW1vdmVFbXB0eVRleHROb2RlcyhlMSk7CglyZW1vdmVFbXB0eVRleHROb2RlcyhlMik7CglpZih0eXBlb2YgZTEgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiBlMiA9PT0gJ3VuZGVmaW5lZCcgfHwgZTEuaXNFcXVhbE5vZGUoZTIpKSByZXR1cm47CgkvLyByZXBsYWNlIHRoZSB3aG9sZSBub2RlCglpZihlMS5ub2RlTmFtZSAhPT0gZTIubm9kZU5hbWUpIHsKCQlpZihlMS5wYXJlbnROb2RlKSB7CgkJCWUxLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGUyLCBlMSk7CgkJfQoJCXJldHVybjsKCX0KCS8vIG5vZGVWYWx1ZQoJaWYoZTEubm9kZVZhbHVlICE9PSBlMi5ub2RlVmFsdWUpIHsKCQllMS5ub2RlVmFsdWUgPSBlMi5ub2RlVmFsdWU7Cgl9CgkvLyBhdHRyaWJ1dGVzCglpZihlMS5hdHRyaWJ1dGVzKSB7CgkJdmFyIGF0dHIxID0gZTEuYXR0cmlidXRlcywgYXR0cjIgPSBlMi5hdHRyaWJ1dGVzLCBhMSwgYTIsIGZvdW5kID0ge307CgkJZm9yKHZhciBpPTA7IGk8YXR0cjEubGVuZ3RoLCBhMT1hdHRyMVtpXTsgaSsrKSB7CgkJCWZvcih2YXIgaj0wOyBqPGF0dHIyLmxlbmd0aCwgYTI9YXR0cjJbal07IGorKykgewoJCQkJaWYoYTEubmFtZSA9PT0gYTIubmFtZSkgewoJCQkJCWUxLnNldEF0dHJpYnV0ZShhMS5uYW1lLCBhMi52YWx1ZSk7CgkJCQkJZm91bmRbYTEubmFtZV0gPSB0cnVlOwoJCQkJCWlmKGExLm5hbWUgPT09ICd2YWx1ZScpIHsKCQkJCQkJZTEudmFsdWUgPSBhMi52YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWYoIWZvdW5kW2ExLm5hbWVdKSB7CgkJCQllMS5yZW1vdmVBdHRyaWJ1dGUoYTEubmFtZSk7CgkJCX0KCQl9CgkJZm9yKHZhciBpPTA7IGk8YXR0cjIubGVuZ3RoLCBhMj1hdHRyMltpXTsgaSsrKSB7CgkJCWlmKCFmb3VuZFthMi5uYW1lXSkgewoJCQkJZTEuc2V0QXR0cmlidXRlKGEyLm5hbWUsIGEyLnZhbHVlKTsKCQkJCWlmKGEyLm5hbWUgPT09ICd2YWx1ZScpIHsKCQkJCQllMS52YWx1ZSA9IGEyLnZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJLy8gY2hpbGRzCgl2YXIgbmV3Tm9kZXNUb01lcmdlID0gW107CglpZihlMS5jaGlsZE5vZGVzLmxlbmd0aCA+PSBlMi5jaGlsZE5vZGVzLmxlbmd0aCkgewoJCWZvcih2YXIgaT0wOyBpPGUxLmNoaWxkTm9kZXMubGVuZ3RoOyBpKyspIHsKCQkJaWYoIWUyLmNoaWxkTm9kZXNbaV0pIHsgZTIuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIiIpKTsgfQoJCQluZXdOb2Rlc1RvTWVyZ2UucHVzaChbZTEuY2hpbGROb2Rlc1tpXSwgZTIuY2hpbGROb2Rlc1tpXV0pOwoJCX0KCX0gZWxzZSB7CgkJZm9yKHZhciBpPTA7IGk8ZTIuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykgewoJCQllMS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiIikpOwkJCQkJCQoJCQluZXdOb2Rlc1RvTWVyZ2UucHVzaChbZTEuY2hpbGROb2Rlc1tpXSwgZTIuY2hpbGROb2Rlc1tpXV0pOwoJCX0KCX0KCWZvcih2YXIgaT0wOyBpPG5ld05vZGVzVG9NZXJnZS5sZW5ndGg7IGkrKykgewoJCWFwaS5fX21lcmdlRE9NRWxlbWVudHMobmV3Tm9kZXNUb01lcmdlW2ldWzBdLCBuZXdOb2Rlc1RvTWVyZ2VbaV1bMV0pOwoJfQp9OwphcGkuX19oYW5kbGVIVE1MID0gZnVuY3Rpb24obmV4dCkgewoJdmFyIHNlbGYgPSB0aGlzOwoJdmFyIGNvbXBpbGUgPSBmdW5jdGlvbigpIHsKCQlhYnN1cmQuZmx1c2goKS5tb3JwaCgiaHRtbCIpLmFkZChIVE1MU291cmNlKS5jb21waWxlKGZ1bmN0aW9uKGVyciwgaHRtbCkgewoJCQlpZighc2VsZi5lbCkgewoJCQkJc2VsZi5lbCA9IHN0cjJET01FbGVtZW50KGh0bWwpOwoJCQl9IGVsc2UgewoJCQkJYXBpLl9fbWVyZ2VET01FbGVtZW50cyhzZWxmLmVsLCBzdHIyRE9NRWxlbWVudChodG1sKSk7CgkJCX0KCQkJbmV4dCgpOwoJCX0sIHNlbGYpOwoJfQoJaWYodGhpcy5odG1sKSB7CgkJaWYodHlwZW9mIHRoaXMuaHRtbCA9PT0gJ3N0cmluZycpIHsKCQkJaWYoIXRoaXMuZWwpIHsKCQkJCXZhciBlbGVtZW50ID0gcXModGhpcy5odG1sKTsKCQkJCWlmKGVsZW1lbnQpIHsKCQkJCQl0aGlzLmVsID0gZWxlbWVudDsKCQkJCQlIVE1MU291cmNlID0geycnOiB0aGlzLmVsLm91dGVySFRNTC5yZXBsYWNlKC8mbHQ7L2csICc8JykucmVwbGFjZSgvJmd0Oy9nLCAnPicpIH07CgkJCQl9CgkJCX0KCQkJY29tcGlsZSgpOwoJCX0gZWxzZSBpZih0eXBlb2YgdGhpcy5odG1sID09PSAnb2JqZWN0JykgewoJCQlIVE1MU291cmNlID0gZXh0ZW5kKHt9LCB0aGlzLmh0bWwpOwoJCQljb21waWxlKCk7CQkKCQl9IGVsc2UgewoJCQluZXh0KCk7CgkJfQoJfSBlbHNlIHsKCQluZXh0KCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKYXBpLmFwcGx5SFRNTCA9IGZ1bmN0aW9uKGRhdGEsIHNraXBBdXRvUG9wdWxhdGlvbikgewoJdGhpcy5odG1sID0gZGF0YTsKCWlmKCFza2lwQXV0b1BvcHVsYXRpb24pIHsKCQl0aGlzLnBvcHVsYXRlKCk7Cgl9CglyZXR1cm4gdGhpczsKfTsKdmFyCWFwcGVuZGVkID0gZmFsc2UKYXBpLl9fYXBwZW5kID0gZnVuY3Rpb24obmV4dCkgewoJaWYoIWFwcGVuZGVkICYmIHRoaXMuZWwgJiYgdGhpcy5nZXQoInBhcmVudCIpKSB7CgkJYXBwZW5kZWQgPSB0cnVlOwoJCXRoaXMuZ2V0KCJwYXJlbnQiKS5hcHBlbmRDaGlsZCh0aGlzLmVsKTsKCX0KCW5leHQoKTsKCXJldHVybiB0aGlzOwp9CnZhciBjYWNoZSA9IHsgZXZlbnRzOiB7fSB9OwphcGkuX19oYW5kbGVFdmVudHMgPSBmdW5jdGlvbihuZXh0KSB7CQkKCWlmKHRoaXMuZWwpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJdmFyIHJlZ2lzdGVyRXZlbnQgPSBmdW5jdGlvbihlbCkgewoJCQl2YXIgYXR0clZhbHVlID0gZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWFic3VyZC1ldmVudCcpOwoJCQl2YXIgcHJvY2Vzc0F0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyVmFsdWUpIHsKCQkJCWF0dHJWYWx1ZSA9IGF0dHJWYWx1ZS5zcGxpdCgiOiIpOwoJCQkJaWYoYXR0clZhbHVlLmxlbmd0aCA+PSAyKSB7CgkJCQkJdmFyIGV2ZW50VHlwZSA9IGF0dHJWYWx1ZVswXTsKCQkJCQl2YXIgbWV0aG9kTmFtZSA9IGF0dHJWYWx1ZVsxXTsKCQkJCQlhdHRyVmFsdWUuc3BsaWNlKDAsIDIpOwoJCQkJCXZhciBhcmdzID0gYXR0clZhbHVlOwoJCQkJCWlmKCFjYWNoZS5ldmVudHNbZXZlbnRUeXBlXSB8fCBjYWNoZS5ldmVudHNbZXZlbnRUeXBlXS5pbmRleE9mKGVsKSA8IDApIHsKCQkJCQkJaWYoIWNhY2hlLmV2ZW50c1tldmVudFR5cGVdKSBjYWNoZS5ldmVudHNbZXZlbnRUeXBlXSA9IFtdOwoJCQkJCQljYWNoZS5ldmVudHNbZXZlbnRUeXBlXS5wdXNoKGVsKTsKCQkJCQkJYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnRUeXBlLCBmdW5jdGlvbihlKSB7CgkJCQkJCQlpZih0eXBlb2Ygc2VsZlttZXRob2ROYW1lXSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJCXZhciBmID0gc2VsZlttZXRob2ROYW1lXTsKCQkJCQkJCQlmLmFwcGx5KHNlbGYsIFtlXS5jb25jYXQoYXJncykpOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQkJYXR0clZhbHVlID0gYXR0clZhbHVlLnNwbGl0KC8sID8vZyk7CgkJCWZvcih2YXIgaT0wOyBpPGF0dHJWYWx1ZS5sZW5ndGg7IGkrKykgcHJvY2Vzc0F0dHJpYnV0ZXMoYXR0clZhbHVlW2ldKTsKCQl9CgkJaWYodGhpcy5lbC5oYXNBdHRyaWJ1dGUgJiYgdGhpcy5lbC5oYXNBdHRyaWJ1dGUoJ2RhdGEtYWJzdXJkLWV2ZW50JykpIHsKCQkJcmVnaXN0ZXJFdmVudCh0aGlzLmVsKTsKCQl9CgkJdmFyIGVscyA9IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCA/IHRoaXMuZWwucXVlcnlTZWxlY3RvckFsbCgnW2RhdGEtYWJzdXJkLWV2ZW50XScpIDogW107CgkJZm9yKHZhciBpPTA7IGk8ZWxzLmxlbmd0aDsgaSsrKSB7CgkJCXJlZ2lzdGVyRXZlbnQoZWxzW2ldKTsKCQl9Cgl9CgluZXh0KCk7CglyZXR1cm4gdGhpczsKfQphcGkuX19nZXRBbmltQW5kVHJhbnNFbmRFdmVudE5hbWUgPSBmdW5jdGlvbihlbCkgewoJaWYoIWVsKSByZXR1cm47CiAgICB2YXIgYTsKICAgIHZhciBhbmltYXRpb25zID0gewogICAgICAnYW5pbWF0aW9uJzogWydhbmltYXRpb25lbmQnLCAndHJhbnNpdGlvbmVuZCddLAogICAgICAnT0FuaW1hdGlvbic6IFsnb0FuaW1hdGlvbkVuZCcsICdvVHJhbnNpdGlvbkVuZCddLAogICAgICAnTW96QW5pbWF0aW9uJzogWydhbmltYXRpb25lbmQnLCAndHJhbnNpdGlvbmVuZCddLAogICAgICAnV2Via2l0QW5pbWF0aW9uJzogWyd3ZWJraXRBbmltYXRpb25FbmQnLCAnd2Via2l0VHJhbnNpdGlvbkVuZCddCiAgICB9CiAgICBmb3IoYSBpbiBhbmltYXRpb25zKXsKICAgICAgICBpZiggZWwuc3R5bGVbYV0gIT09IHVuZGVmaW5lZCApewogICAgICAgICAgICByZXR1cm4gYW5pbWF0aW9uc1thXTsKICAgICAgICB9CiAgICB9Cn0KYXBpLm9uQW5pbWF0aW9uRW5kID0gZnVuY3Rpb24oZWwsIGZ1bmMpIHsKCWlmKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkgewoJCWZ1bmMgPSBlbDsKCQllbCA9IHRoaXMuZWw7Cgl9Cgl2YXIgc2VsZiA9IHRoaXM7Cgl2YXIgZXZlbnROYW1lID0gYXBpLl9fZ2V0QW5pbUFuZFRyYW5zRW5kRXZlbnROYW1lKGVsKTsKCWlmKCFldmVudE5hbWUpIHsgZnVuYy5hcHBseSh0aGlzLCBbe2Vycm9yOiAnQW5pbWF0aW9ucyBub3Qgc3VwcG9ydGVkLid9XSk7IHJldHVybjsgfTsKCXRoaXMuYWRkRXZlbnRMaXN0ZW5lcihlbCwgZXZlbnROYW1lWzBdLCBmdW5jdGlvbihlKSB7CgkJZnVuYy5hcHBseShzZWxmLCBbZV0pOwoJfSk7Cn0KYXBpLm9uVHJhbnNpdGlvbkVuZCA9IGZ1bmN0aW9uKGVsLCBmdW5jKSB7CglpZihhcmd1bWVudHMubGVuZ3RoID09IDEpIHsKCQlmdW5jID0gZWw7CgkJZWwgPSB0aGlzLmVsOwoJfQoJdmFyIHNlbGYgPSB0aGlzOwoJdmFyIGV2ZW50TmFtZSA9IGFwaS5fX2dldEFuaW1BbmRUcmFuc0VuZEV2ZW50TmFtZShlbCk7CglpZighZXZlbnROYW1lKSB7IGZ1bmMuYXBwbHkodGhpcywgW3tlcnJvcjogJ0FuaW1hdGlvbnMgbm90IHN1cHBvcnRlZC4nfV0pOyByZXR1cm47IH07Cgl0aGlzLmFkZEV2ZW50TGlzdGVuZXIoZWwsIGV2ZW50TmFtZVsxXSwgZnVuY3Rpb24oZSkgewoJCWZ1bmMuYXBwbHkoc2VsZiwgW2VdKTsKCX0pOwp9CnZhcglhc3luYyA9IHsgZnVuY3M6IHt9LCBpbmRleDogMCB9OwphcGkuX19oYW5kbGVBc3luY0Z1bmN0aW9ucyA9IGZ1bmN0aW9uKG5leHQpIHsKCWlmKHRoaXMuZWwpIHsKCQl2YXIgZnVuY3MgPSBbXTsKCQlpZih0aGlzLmVsLmhhc0F0dHJpYnV0ZSAmJiB0aGlzLmVsLmhhc0F0dHJpYnV0ZSgiZGF0YS1hYnN1cmQtYXN5bmMiKSkgewoJCQlmdW5jcy5wdXNoKHRoaXMuZWwpOwoJCX0gZWxzZSB7CgkJCXZhciBlbHMgPSB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwgPyB0aGlzLmVsLnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWFic3VyZC1hc3luY10nKSA6IFtdOwoJCQlmb3IodmFyIGk9MDsgaTxlbHMubGVuZ3RoOyBpKyspIHsKCQkJCWZ1bmNzLnB1c2goZWxzW2ldKTsKCQkJfQoJCX0JCQoJCWlmKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewoJCQluZXh0KCk7CgkJfSBlbHNlIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkoZnVuY3Rpb24gY2FsbEZ1bmNzKCkgewoJCQkJaWYoZnVuY3MubGVuZ3RoID09PSAwKSB7CQkJCQkJCgkJCQkJbmV4dCgpOwoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgZWwgPSBmdW5jcy5zaGlmdCgpLAoJCQkJCQl2YWx1ZSA9IGVsLmdldEF0dHJpYnV0ZSgiZGF0YS1hYnN1cmQtYXN5bmMiKSwKCQkJCQkJcmVwbGFjZU5vZGVzID0gZnVuY3Rpb24oY2hpbGRFbGVtZW50KSB7CgkJCQkJCQlpZih0eXBlb2YgY2hpbGRFbGVtZW50ID09PSAnc3RyaW5nJykgewoJCQkJCQkJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHN0cjJET01FbGVtZW50KGNoaWxkRWxlbWVudCksIGVsKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJZWwucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQoY2hpbGRFbGVtZW50LCBlbCk7CgkJCQkJCQl9CgkJCQkJCQljYWxsRnVuY3MoKTsKCQkJCQkJfTsKCQkJCQlpZih0eXBlb2Ygc2VsZlthc3luYy5mdW5jc1t2YWx1ZV0ubmFtZV0gPT09ICdmdW5jdGlvbicpIHsKCQkJCQkJc2VsZlthc3luYy5mdW5jc1t2YWx1ZV0ubmFtZV0uYXBwbHkoc2VsZiwgW3JlcGxhY2VOb2Rlc10uY29uY2F0KGFzeW5jLmZ1bmNzW3ZhbHVlXS5hcmdzKSk7CgkJCQkJfSBlbHNlIGlmKHR5cGVvZiBhc3luYy5mdW5jc1t2YWx1ZV0uZnVuYyA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQlhc3luYy5mdW5jc1t2YWx1ZV0uZnVuYy5hcHBseShzZWxmLCBbcmVwbGFjZU5vZGVzXS5jb25jYXQoYXN5bmMuZnVuY3NbdmFsdWVdLmFyZ3MpKTsKCQkJCQl9CgkJCQl9CgkJCX0pKCk7CgkJfQkJCQoJfSBlbHNlIHsKCQluZXh0KCk7Cgl9CQoJcmV0dXJuIHRoaXM7CQp9CmFwaS5hc3luYyA9IGZ1bmN0aW9uKCkgewoJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApLAoJCWZ1bmMgPSBhcmdzLnNoaWZ0KCksCgkJaW5kZXggPSAnXycgKyAoYXN5bmMuaW5kZXgrKyk7Cglhc3luYy5mdW5jc1tpbmRleF0gPSB7YXJnczogYXJncywgbmFtZTogZnVuY307CglyZXR1cm4gJzxzY3JpcHQgZGF0YS1hYnN1cmQtYXN5bmM9IicgKyBpbmRleCArICciPjwvc2NyaXB0Pic7Cn07CmFwaS5jaGlsZCA9IGZ1bmN0aW9uKCkgewoJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDApLAoJCWNoaWxkcmVuID0gdGhpcy5nZXQoImNoaWxkcmVuIiksCgkJY29tcG9uZW50ID0gY2hpbGRyZW4gJiYgY2hpbGRyZW5bYXJncy5zaGlmdCgpXSwKCQlpbmRleCA9ICdfJyArIChhc3luYy5pbmRleCsrKTsKCWFzeW5jLmZ1bmNzW2luZGV4XSA9IHthcmdzOiBhcmdzLCBmdW5jOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCWNvbXBvbmVudC5wb3B1bGF0ZSh7Y2FsbGJhY2s6IGZ1bmN0aW9uKGRhdGEpIHsKCQkJY2FsbGJhY2soZGF0YS5odG1sLmVsZW1lbnQpOwoJCX19KTsKCX19OwoJcmV0dXJuICc8c2NyaXB0IGRhdGEtYWJzdXJkLWFzeW5jPSInICsgaW5kZXggKyAnIj48L3NjcmlwdD4nOwp9OwphcGkud2lyZSA9IGZ1bmN0aW9uKGV2ZW50KSB7CglhYnN1cmQuY29tcG9uZW50cy5ldmVudHMub24oZXZlbnQsIHRoaXNbZXZlbnRdIHx8IGZ1bmN0aW9uKCkge30sIHRoaXMpOwoJcmV0dXJuIHRoaXM7Cn07CnZhciBpc1BvcHVsYXRlSW5Qcm9ncmVzcyA9IGZhbHNlOwphcGkucG9wdWxhdGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CglpZihpc1BvcHVsYXRlSW5Qcm9ncmVzcykgcmV0dXJuOwoJaXNQb3B1bGF0ZUluUHJvZ3Jlc3MgPSB0cnVlOwoJcXVldWUoWwoJCWFwaS5fX2hhbmRsZUNTUywKCQlhcGkuX19oYW5kbGVIVE1MLAoJCWFwaS5fX2FwcGVuZCwgCgkJYXBpLl9faGFuZGxlRXZlbnRzLAoJCWFwaS5fX2hhbmRsZUFzeW5jRnVuY3Rpb25zLAoJCWZ1bmN0aW9uKCkgewoJCQlpc1BvcHVsYXRlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQlhc3luYyA9IHsgZnVuY3M6IHt9LCBpbmRleDogMCB9CgkJCXZhciBkYXRhID0gewoJCQkJY3NzOiBDU1MsIAoJCQkJaHRtbDogeyAKCQkJCQllbGVtZW50OiB0aGlzLmVsIAoJCQkJfQoJCQl9OwoJCQl0aGlzLmRpc3BhdGNoKCJwb3B1bGF0ZWQiLCBkYXRhKTsKCQkJaWYob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5jYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgeyBvcHRpb25zLmNhbGxiYWNrKGRhdGEpOyB9CgkJfQoJXSwgdGhpcyk7CglyZXR1cm4gdGhpczsKfTsKYXBpLnN0cjJET01FbGVtZW50ID0gc3RyMkRPTUVsZW1lbnQ7CmFwaS5hZGRFdmVudExpc3RlbmVyID0gYWRkRXZlbnRMaXN0ZW5lcjsKYXBpLnF1ZXVlID0gcXVldWU7CmFwaS5xcyA9IHFzOwphcGkucXNhID0gcXNhOwphcGkuZ2V0U3R5bGUgPSBnZXRTdHlsZTsKYXBpLmFkZENsYXNzID0gYWRkQ2xhc3M7CmFwaS5yZW1vdmVDbGFzcyA9IHJlbW92ZUNsYXNzOwphcGkucmVwbGFjZUNsYXNzID0gcmVwbGFjZUNsYXNzOwphcGkuYmluZCA9IGJpbmQ7CmFwaS50b2dnbGVDbGFzcyA9IHRvZ2dsZUNsYXNzOwphcGkuY29tcGlsZUhUTUwgPSBmdW5jdGlvbihIVE1MLCBjYWxsYmFjaywgZGF0YSkgewoJYWJzdXJkLmZsdXNoKCkubW9ycGgoImh0bWwiKS5hZGQoSFRNTCkuY29tcGlsZShjYWxsYmFjaywgZGF0YSk7Cn07CmFwaS5jb21waWxlQ1NTID0gZnVuY3Rpb24oQ1NTLCBjYWxsYmFjaywgb3B0aW9ucykgewoJYWJzdXJkLmZsdXNoKCkuYWRkKENTUykuY29tcGlsZShjYWxsYmFjaywgb3B0aW9ucyk7Cn07CmFwaS5kZWxheSA9IGZ1bmN0aW9uKHRpbWUsIGZuLCBhcmdzKSB7Cgl2YXIgc2VsZiA9IHRoaXM7CglzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCWZuLmFwcGx5KHNlbGYsIGFyZ3MpOwoJfSwgdGltZSk7Cn0KCXJldHVybiBhcGk7Cn07CnZhciBpbmplY3RpbmcgPSBmdW5jdGlvbihhYnN1cmQpIHsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdpcycsIHsKCWFwcGVuZGVkOiBmdW5jdGlvbihzZWxlY3RvcikgewoJCWlmKHR5cGVvZiBzZWxlY3RvciA9PSAndW5kZWZpbmVkJykgc2VsZWN0b3IgPSB0aGlzLmhvc3QuaHRtbDsKCQlyZXR1cm4gcXMoc2VsZWN0b3IpID8gdHJ1ZSA6IGZhbHNlOwoJfSwKCWhpZGRlbjogZnVuY3Rpb24oZWwpIHsKCQllbCA9IGVsIHx8IHRoaXMuaG9zdC5lbDsKCQlyZXR1cm4gZWwub2Zmc2V0UGFyZW50ID09PSBudWxsOwoJfQp9KTsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdyb3V0ZXInLCB7Cglyb3V0ZXM6IFtdLAoJbW9kZTogbnVsbCwKCXJvb3Q6ICcvJywKCWdldEZyYWdtZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgZnJhZ21lbnQgPSAnJzsKCQlpZih0aGlzLm1vZGUgPT09ICdoaXN0b3J5JykgewoJCQlpZighbG9jYXRpb24pIHJldHVybiAnJzsKCQkJZnJhZ21lbnQgPSB0aGlzLmNsZWFyU2xhc2hlcyhkZWNvZGVVUkkobG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2gpKTsKCQkJZnJhZ21lbnQgPSBmcmFnbWVudC5yZXBsYWNlKC9cPyguKikkLywgJycpOwoJCQlmcmFnbWVudCA9IHRoaXMucm9vdCAhPSAnLycgPyBmcmFnbWVudC5yZXBsYWNlKHRoaXMucm9vdCwgJycpIDogZnJhZ21lbnQ7CgkJfSBlbHNlIHsKCQkJaWYoIXdpbmRvdykgcmV0dXJuICcnOwoJCQl2YXIgbWF0Y2ggPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CgkJCWZyYWdtZW50ID0gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOwoJCX0KCQlyZXR1cm4gdGhpcy5jbGVhclNsYXNoZXMoZnJhZ21lbnQpOwoJfSwKICAgIGNsZWFyU2xhc2hlczogZnVuY3Rpb24ocGF0aCkgewogICAgCXJldHVybiBwYXRoLnRvU3RyaW5nKCkucmVwbGFjZSgvXC8kLywgJycpLnJlcGxhY2UoL15cLy8sICcnKTsKICAgIH0sCglhZGQ6IGZ1bmN0aW9uKHJlLCBoYW5kbGVyKSB7CgkJaWYodHlwZW9mIHJlID09ICdmdW5jdGlvbicpIHsKCQkJaGFuZGxlciA9IHJlOwoJCQlyZSA9ICcnOwoJCX0KCQl0aGlzLnJvdXRlcy5wdXNoKHsgcmU6IHJlLCBoYW5kbGVyOiBoYW5kbGVyfSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJcmVtb3ZlOiBmdW5jdGlvbihwYXJhbSkgewoJCWZvcih2YXIgaT0wLCByOyBpPHRoaXMucm91dGVzLmxlbmd0aCwgciA9IHRoaXMucm91dGVzW2ldOyBpKyspIHsKCQkJaWYoci5oYW5kbGVyID09PSBwYXJhbSB8fCByLnJlID09PSBwYXJhbSkgewoJCQkJdGhpcy5yb3V0ZXMuc3BsaWNlKGksIDEpOyAKCQkJCXJldHVybiB0aGlzOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCWZsdXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLnJvdXRlcyA9IFtdOwoJCXRoaXMubW9kZSA9IG51bGw7CgkJdGhpcy5yb290ID0gJy8nOwoJCXJldHVybiB0aGlzOwoJfSwKCWNvbmZpZzogZnVuY3Rpb24ob3B0aW9ucykgewoJCXRoaXMubW9kZSA9IG9wdGlvbnMgJiYgb3B0aW9ucy5tb2RlICYmIG9wdGlvbnMubW9kZSA9PSAnaGlzdG9yeScgJiYgISEoaGlzdG9yeS5wdXNoU3RhdGUpID8gJ2hpc3RvcnknIDogJ2hhc2gnOwoJCXRoaXMucm9vdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5yb290ID8gJy8nICsgdGhpcy5jbGVhclNsYXNoZXMob3B0aW9ucy5yb290KSArICcvJyA6ICcvJzsKCQlyZXR1cm4gdGhpczsKCX0sCglsaXN0ZW46IGZ1bmN0aW9uKGxvb3BJbnRlcnZhbCkgewoJCXZhciBzZWxmID0gdGhpczsKCQl2YXIgY3VycmVudCA9IHNlbGYuZ2V0RnJhZ21lbnQoKTsKCQl2YXIgZm4gPSBmdW5jdGlvbigpIHsKCQkJaWYoY3VycmVudCAhPT0gc2VsZi5nZXRGcmFnbWVudCgpKSB7CgkJCQljdXJyZW50ID0gc2VsZi5nZXRGcmFnbWVudCgpOwoJCQkJc2VsZi5jaGVjayhjdXJyZW50KTsKCQkJfQoJCX0KCQljbGVhckludGVydmFsKHRoaXMuaW50ZXJ2YWwpOwoJCXRoaXMuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmbiwgbG9vcEludGVydmFsIHx8IDUwKTsKCQlyZXR1cm4gdGhpczsKCX0sCgljaGVjazogZnVuY3Rpb24oZikgewoJCXZhciBmcmFnbWVudCA9IGYgfHwgdGhpcy5nZXRGcmFnbWVudCgpOwoJCWZvcih2YXIgaT0wOyBpPHRoaXMucm91dGVzLmxlbmd0aDsgaSsrKSB7CgkJCXZhciBtYXRjaCA9IGZyYWdtZW50Lm1hdGNoKHRoaXMucm91dGVzW2ldLnJlKTsKCQkJaWYobWF0Y2gpIHsKCQkJCW1hdGNoLnNoaWZ0KCk7CgkJCQl0aGlzLnJvdXRlc1tpXS5oYW5kbGVyLmFwcGx5KHRoaXMuaG9zdCB8fCB7fSwgbWF0Y2gpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0JCQkKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoJbmF2aWdhdGU6IGZ1bmN0aW9uKHBhdGgpIHsKCQlwYXRoID0gcGF0aCA/IHBhdGggOiAnJzsKCQlpZih0aGlzLm1vZGUgPT09ICdoaXN0b3J5JykgewoJCQloaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBudWxsLCB0aGlzLnJvb3QgKyB0aGlzLmNsZWFyU2xhc2hlcyhwYXRoKSk7CgkJfSBlbHNlIHsKCQkJd2luZG93LmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOwoJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyMoLiopJC8sICcnKSArICcjJyArIHBhdGg7CgkJfQoJCXJldHVybiB0aGlzOwoJfQp9KTsKYWJzdXJkLmRpLnJlZ2lzdGVyKCdhamF4JywgewoJcmVxdWVzdDogZnVuY3Rpb24ob3BzKSB7CgoJCWlmKHR5cGVvZiBvcHMgPT0gJ3N0cmluZycpIG9wcyA9IHsgdXJsOiBvcHMgfTsKCQlvcHMudXJsID0gb3BzLnVybCB8fCAnJzsKCQlvcHMubWV0aG9kID0gb3BzLm1ldGhvZCB8fCAnZ2V0JwoJCW9wcy5kYXRhID0gb3BzLmRhdGEgfHwge307CgoJCXZhciBnZXRQYXJhbXMgPSBmdW5jdGlvbihkYXRhLCB1cmwpIHsKCQkJdmFyIGFyciA9IFtdLCBzdHI7CgkJCWZvcih2YXIgbmFtZSBpbiBkYXRhKSB7CgkJCQlhcnIucHVzaChuYW1lICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFbbmFtZV0pKTsKCQkJfQoJCQlzdHIgPSBhcnIuam9pbignJicpOwoJCQlpZihzdHIgIT0gJycpIHsKCQkJCXJldHVybiB1cmwgPyAodXJsLmluZGV4T2YoJz8nKSA8IDAgPyAnPycgKyBzdHIgOiAnJicgKyBzdHIpIDogc3RyOwoJCQl9CgkJCXJldHVybiAnJzsKCQl9CgoJCXZhciBhcGkgPSB7CgkJCWhvc3Q6IHRoaXMuaG9zdCB8fCB7fSwKCQkJcHJvY2VzczogZnVuY3Rpb24ob3BzKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQl0aGlzLnhociA9IG51bGw7CgkJCQlpZih3aW5kb3cuQWN0aXZlWE9iamVjdCkgeyB0aGlzLnhociA9IG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOyB9CgkJCQllbHNlIGlmKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCkgeyB0aGlzLnhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOyB9CgkJCQlpZih0aGlzLnhocikgewoJCQkJCXRoaXMueGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCkgewoJCQkJCQlpZihzZWxmLnhoci5yZWFkeVN0YXRlID09IDQgJiYgc2VsZi54aHIuc3RhdHVzID09IDIwMCkgewoJCQkJCQkJdmFyIHJlc3VsdCA9IHNlbGYueGhyLnJlc3BvbnNlVGV4dDsKCQkJCQkJCWlmKG9wcy5qc29uID09PSB0cnVlICYmIHR5cGVvZiBKU09OICE9ICd1bmRlZmluZWQnKSB7CgkJCQkJCQkJcmVzdWx0ID0gSlNPTi5wYXJzZShyZXN1bHQpOwoJCQkJCQkJfQoJCQkJCQkJc2VsZi5kb25lQ2FsbGJhY2sgJiYgc2VsZi5kb25lQ2FsbGJhY2suYXBwbHkoc2VsZi5ob3N0LCBbcmVzdWx0LCBzZWxmLnhocl0pOwoJCQkJCQl9IGVsc2UgaWYoc2VsZi54aHIucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQkJCQlzZWxmLmZhaWxDYWxsYmFjayAmJiBzZWxmLmZhaWxDYWxsYmFjay5hcHBseShzZWxmLmhvc3QsIFtzZWxmLnhocl0pOwoJCQkJCQl9CgkJCQkJCXNlbGYuYWx3YXlzQ2FsbGJhY2sgJiYgc2VsZi5hbHdheXNDYWxsYmFjay5hcHBseShzZWxmLmhvc3QsIFtzZWxmLnhocl0pOwoJCQkJCX0KCQkJCQkKCQkJCQlpZihvcHMubWV0aG9kID09ICdnZXQnKSB7CgkJCQkJCXRoaXMueGhyLm9wZW4oIkdFVCIsIG9wcy51cmwgKyBnZXRQYXJhbXMob3BzLmRhdGEsIG9wcy51cmwpLCB0cnVlKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnhoci5vcGVuKG9wcy5tZXRob2QsIG9wcy51cmwsIHRydWUpOwoJCQkJCQl0aGlzLnNldEhlYWRlcnMoewoJCQkJCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQkJCQkJJ0NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnCgkJCQkJCX0pOwoJCQkJCX0KCQkJCQlpZihvcHMuaGVhZGVycyAmJiB0eXBlb2Ygb3BzLmhlYWRlcnMgPT0gJ29iamVjdCcpIHsKCQkJCQkJdGhpcy5zZXRIZWFkZXJzKG9wcy5oZWFkZXJzKTsKCQkJCQl9CQkKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyAKCQkJCQkJb3BzLm1ldGhvZCA9PSAnZ2V0JyA/IHNlbGYueGhyLnNlbmQoKSA6IHNlbGYueGhyLnNlbmQoZ2V0UGFyYW1zKG9wcy5kYXRhKSk7IAoJCQkJCX0sIDIwKTsJCgkJCQl9CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJZG9uZTogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXRoaXMuZG9uZUNhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJZmFpbDogZnVuY3Rpb24oY2FsbGJhY2spIHsKCQkJCXRoaXMuZmFpbENhbGxiYWNrID0gY2FsbGJhY2s7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSwKCQkJYWx3YXlzOiBmdW5jdGlvbihjYWxsYmFjaykgewoJCQkJdGhpcy5hbHdheXNDYWxsYmFjayA9IGNhbGxiYWNrOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0sCgkJCXNldEhlYWRlcnM6IGZ1bmN0aW9uKGhlYWRlcnMpIHsKCQkJCWZvcih2YXIgbmFtZSBpbiBoZWFkZXJzKSB7CgkJCQkJdGhpcy54aHIgJiYgdGhpcy54aHIuc2V0UmVxdWVzdEhlYWRlcihuYW1lLCBoZWFkZXJzW25hbWVdKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIGFwaS5wcm9jZXNzKG9wcyk7CgoJfQp9KTsKdmFyIGRvbSA9IGZ1bmN0aW9uKGVsLCBwYXJlbnQpIHsKCXZhciBob3N0ID0gZG9tLnByb3RvdHlwZS5ob3N0OwoJdmFyIGFwaSA9IHsgZWw6IG51bGwgfTsKCS8vIGRlZmluaW5nIHRoZSBzY29wZQoJc3dpdGNoKHR5cGVvZiBlbCkgewoJCWNhc2UgJ3VuZGVmaW5lZCc6CgkJCWFwaS5lbCA9IGhvc3QuZWw7CgkJYnJlYWs7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcGFyZW50ID0gcGFyZW50ICYmIHR5cGVvZiBwYXJlbnQgPT09ICdzdHJpbmcnID8gcXMuYXBwbHkoaG9zdCwgW3BhcmVudF0pIDogcGFyZW50OwoJCQlhcGkuZWwgPSBxcyhlbCwgcGFyZW50IHx8IGhvc3QuZWwgfHwgZG9jdW1lbnQpOwoJCWJyZWFrOwoJCWNhc2UgJ29iamVjdCc6IAoJCQlpZih0eXBlb2YgZWwubm9kZU5hbWUgIT0gJ3VuZGVmaW5lZCcpIHsKCSAgICAgICAgICAgIGFwaS5lbCA9IGVsOwoJICAgICAgICB9IGVsc2UgewoJICAgICAgICAJdmFyIGxvb3AgPSBmdW5jdGlvbih2YWx1ZSwgb2JqKSB7CiAgICAgICAgICAgIAkJb2JqID0gb2JqIHx8IHRoaXM7CiAgICAgICAgICAgIAkJZm9yKHZhciBwcm9wIGluIG9iaikgewogICAgICAgIAkJCQlpZih0eXBlb2Ygb2JqW3Byb3BdLmVsICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgCQkJCQlvYmpbcHJvcF0gPSBvYmpbcHJvcF0udmFsKHZhbHVlKTsKICAgICAgICAJCQkJfSBlbHNlIGlmKHR5cGVvZiBvYmpbcHJvcF0gPT0gJ29iamVjdCcpIHsKICAgICAgICAJCQkJCW9ialtwcm9wXSA9IGxvb3AodmFsdWUsIG9ialtwcm9wXSk7CiAgICAgICAgCQkJCX0KICAgICAgICAgICAgCQl9CiAgICAgICAgICAgIAkJZGVsZXRlIG9iai52YWw7CiAgICAgICAgICAgIAkJcmV0dXJuIG9iajsKCSAgICAgICAgCX0KCSAgICAgICAgICAgIHZhciByZXMgPSB7IHZhbDogbG9vcCB9OwoJICAgICAgICAgICAgZm9yKHZhciBrZXkgaW4gZWwpIHsKCSAgICAgICAgICAgICAgICByZXNba2V5XSA9IGRvbS5hcHBseSh0aGlzLCBbZWxba2V5XV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgcmV0dXJuIHJlczsKCSAgICAgICAgfQoJCWJyZWFrOwoJfQoJLy8gZ2V0dGluZyBvciBzZXR0aW5nIGEgdmFsdWUKCWFwaS52YWwgPSBmdW5jdGlvbih2YWx1ZSkgewoJCWlmKCF0aGlzLmVsKSByZXR1cm4gbnVsbDsKCQl2YXIgc2V0ID0gISF2YWx1ZTsKCQl2YXIgdXNlVmFsdWVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJCWlmKHNldCkgeyB0aGlzLmVsLnZhbHVlID0gdmFsdWU7IHJldHVybiBhcGk7IH0KCQkJZWxzZSB7IHJldHVybiB0aGlzLmVsLnZhbHVlOyB9CgkJfQogICAgICAgIHN3aXRjaCh0aGlzLmVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAJY2FzZSAnaW5wdXQnOgogICAgICAgIAkJdmFyIHR5cGUgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZSgndHlwZScpOwogICAgICAgIAkJaWYodHlwZSA9PSAncmFkaW8nIHx8IHR5cGUgPT0gJ2NoZWNrYm94JykgewoJICAgICAgICAgICAgICAgIHZhciBlbHMgPSBxc2EoJ1tuYW1lPSInICsgdGhpcy5lbC5nZXRBdHRyaWJ1dGUoJ25hbWUnKSArICciXScsIHBhcmVudCk7CgkgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IFtdOwoJICAgICAgICAgICAgICAgIGZvcih2YXIgaT0wOyBpPGVscy5sZW5ndGg7IGkrKykgewoJICAgICAgICAgICAgICAgICAgICBpZihzZXQgJiYgZWxzW2ldLmNoZWNrZWQgJiYgZWxzW2ldLnZhbHVlICE9PSB2YWx1ZSkgewoJICAgICAgICAgICAgICAgICAgICAgICAgZWxzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnY2hlY2tlZCcpOwoJICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYoc2V0ICYmIGVsc1tpXS52YWx1ZSA9PT0gdmFsdWUpIHsKCSAgICAgICAgICAgICAgICAgICAgCWVsc1tpXS5zZXRBdHRyaWJ1dGUoJ2NoZWNrZWQnLCAnY2hlY2tlZCcpOwoJICAgICAgICAgICAgICAgICAgICAJZWxzW2ldLmNoZWNrZWQgPSAnY2hlY2tlZCc7CgkgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZihlbHNbaV0uY2hlY2tlZCkgewoJICAgICAgICAgICAgICAgICAgICAJdmFsdWVzLnB1c2goZWxzW2ldLnZhbHVlKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICBpZighc2V0KSB7IHJldHVybiB0eXBlID09ICdyYWRpbycgPyB2YWx1ZXNbMF0gOiB2YWx1ZXM7IH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAJcmV0dXJuIHVzZVZhbHVlUHJvcGVydHkuYXBwbHkodGhpcywgW3ZhbHVlXSk7CgkgICAgICAgICAgICB9CiAgICAgICAgCWJyZWFrOwogICAgICAgIAljYXNlICd0ZXh0YXJlYSc6IHJldHVybiB1c2VWYWx1ZVByb3BlcnR5LmFwcGx5KHRoaXMsIFt2YWx1ZV0pOyBicmVhazsKICAgICAgICAJY2FzZSAnc2VsZWN0JzoKICAgICAgICAJCWlmKHNldCkgewogICAgICAgICAgICAJCXZhciBvcHRpb25zID0gcXNhKCdvcHRpb24nLCB0aGlzLmVsKTsKICAgICAgICAgICAgCQlmb3IodmFyIGk9MDsgaTxvcHRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIAkJCWlmKG9wdGlvbnNbaV0uZ2V0QXR0cmlidXRlKCd2YWx1ZScpID09PSB2YWx1ZSkgewogICAgICAgICAgICAJCQkJdGhpcy5lbC5zZWxlY3RlZEluZGV4ID0gaTsKICAgICAgICAgICAgCQkJfSBlbHNlIHsKICAgICAgICAgICAgCQkJCW9wdGlvbnNbaV0ucmVtb3ZlQXR0cmlidXRlKCdzZWxlY3RlZCcpOwogICAgICAgICAgICAJCQl9CiAgICAgICAgICAgIAkJfQogICAgICAgICAgICAJfSBlbHNlIHsKICAgICAgICAgICAgICAgIAlyZXR1cm4gdGhpcy5lbC52YWx1ZTsKICAgICAgICAgICAgCX0KICAgICAgICAJYnJlYWs7CiAgICAgICAgCWRlZmF1bHQ6IAogICAgICAgIAkJaWYoc2V0KSB7CiAgICAgICAgCQkJdGhpcy5lbC5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICAJCX0gZWxzZSB7CgkgICAgICAgIAkJaWYodHlwZW9mIHRoaXMuZWwudGV4dENvbnRlbnQgIT0gJ3VuZGVmaW5lZCcpIHsKCQkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWwudGV4dENvbnRlbnQ7CgkJICAgICAgICAgICAgfSBlbHNlIGlmKHR5cGVvZiB0aGlzLmVsLmlubmVyVGV4dCAhPSAndW5kZWZpbmVkJykgewoJCSAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHRoaXMuZWwuaW5uZXJUZXh0OwoJCSAgICAgICAgICAgIH0gZWxzZSB7CgkJICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVsLmlubmVySFRNTDsKCQkgICAgICAgICAgICB9CgkgICAgICAgIAl9CiAgICAgICAgCWJyZWFrOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc2V0ID8gYXBpIDogbnVsbDsKCX0KCS8vIGNoYWluaW5nIGRvbSBtb2R1bGUKCWFwaS5kb20gPSBmdW5jdGlvbihlbCwgcGFyZW50KSB7CgkJcmV0dXJuIGRvbShlbCwgcGFyZW50IHx8IGFwaS5lbCk7Cgl9CglyZXR1cm4gYXBpOwp9CmFic3VyZC5kaS5yZWdpc3RlcignZG9tJywgZG9tKTsKdmFyIG1xID0gZnVuY3Rpb24ocXVlcnksIGNhbGxiYWNrLCB1c2VQb2x5ZmlsbCkgewoJdmFyIGhvc3QgPSBtcS5wcm90b3R5cGUuaG9zdDsKCXZhciBpc01hdGNoTWVkaWFTdXBwb3J0ZWQgPSAhISh3aW5kb3cgJiYgd2luZG93Lm1hdGNoTWVkaWEpICYmICF1c2VQb2x5ZmlsbDsKCWlmKGlzTWF0Y2hNZWRpYVN1cHBvcnRlZCkgewoJCXZhciByZXMgPSB3aW5kb3cubWF0Y2hNZWRpYShxdWVyeSk7CgkJY2FsbGJhY2suYXBwbHkoaG9zdCwgW3Jlcy5tYXRjaGVzLCByZXMubWVkaWFdKTsKCQlyZXMuYWRkTGlzdGVuZXIoZnVuY3Rpb24oY2hhbmdlZCkgewoJCQljYWxsYmFjay5hcHBseShob3N0LCBbY2hhbmdlZC5tYXRjaGVzLCBjaGFuZ2VkLm1lZGlhXSk7CgkJfSk7Cgl9IGVsc2UgewoJCXZhciBpZCA9ICIubWF0Y2gtbWVkaWEtIiArIGFic3VyZC5jb21wb25lbnRzLm51bU9mQ29tcG9uZW50czsKCQl2YXIgY3NzID0ge30sIGh0bWwgPSB7fTsKCQljc3NbaWRdID0geyBkaXNwbGF5OiAnYmxvY2snIH07CgkJY3NzW2lkXVsnQG1lZGlhICcgKyBxdWVyeV0gPSB7IGRpc3BsYXk6ICdub25lJyB9OwoJCWh0bWxbJ3NwYW4nICsgaWRdID0gJyc7CgkJYWJzdXJkLmNvbXBvbmVudChpZCArICctY29tcG9uZW50JywgewoJCQljc3M6IGNzcywKCQkJaHRtbDogaHRtbCwKCQkJaW50ZXJ2YWxpVGltZTogMzAsCgkJCXN0YXR1czogJycsCgkJCWxvb3A6IGZ1bmN0aW9uKGRvbSkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkJaWYodGhpcy5lbCkgewoJCQkJCXZhciBkID0gdGhpcy5nZXRTdHlsZSgnZGlzcGxheScpOwoJCQkJCWlmKHRoaXMuc3RhdHVzICE9IGQpIHsKCQkJCQkJdGhpcy5zdGF0dXMgPSBkOwoJCQkJCQljYWxsYmFjay5hcHBseShob3N0LCBbZCA9PT0gJ25vbmUnXSkKCQkJCQl9CgkJCQl9CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvb3AoKTsgfSwgdGhpcy5pbnRlcnZhbGlUaW1lKTsKCQkJfSwKCQkJY29uc3RydWN0b3I6IFsnZG9tJywgZnVuY3Rpb24oZG9tKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQl0aGlzLnNldCgncGFyZW50JywgZG9tKCdib2R5JykuZWwpLnBvcHVsYXRlKCk7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBzZWxmLmxvb3AoKTsgfSwgdGhpcy5pbnRlcnZhbGlUaW1lKTsKCQkJfV0KCQl9KSgpOwoJfQp9OwphYnN1cmQuZGkucmVnaXN0ZXIoJ21xJywgbXEpOwp9CnZhciBjbGllbnQgPSBmdW5jdGlvbigpIHsKCXJldHVybiBmdW5jdGlvbihhcmcpIHsKCgkJLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogQ29waWVkIGRpcmVjdGx5IGZyb20gL2xpYi9BUEkuanMgKi8KCgkJdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKGRlc3RpbmF0aW9uLCBzb3VyY2UpIHsKCQkJZm9yICh2YXIga2V5IGluIHNvdXJjZSkgewoJCQkJaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzb3VyY2UsIGtleSkpIHsKCQkJCQlkZXN0aW5hdGlvbltrZXldID0gc291cmNlW2tleV07CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGRlc3RpbmF0aW9uOwoJCX07CgoJCXZhciBfYXBpID0geyAKCQkJCWRlZmF1bHRQcm9jZXNzb3I6IGxpYi5wcm9jZXNzb3JzLmNzcy5DU1MoKSAKCQkJfSwKCQkJX3J1bGVzID0ge30sCgkJCV9zdG9yYWdlID0ge30sCgkJCV9wbHVnaW5zID0ge30sCgkJCV9ob29rcyA9IHt9OwoKCQlfYXBpLmdldFJ1bGVzID0gZnVuY3Rpb24oc3R5bGVzaGVldCkgewoJCQlpZih0eXBlb2Ygc3R5bGVzaGVldCA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybiBfcnVsZXM7CgkJCX0gZWxzZSB7CgkJCQlpZih0eXBlb2YgX3J1bGVzW3N0eWxlc2hlZXRdID09PSAndW5kZWZpbmVkJykgewoJCQkJCV9ydWxlc1tzdHlsZXNoZWV0XSA9IFtdOwoJCQkJfQoJCQkJcmV0dXJuIF9ydWxlc1tzdHlsZXNoZWV0XTsKCQkJfQoJCX0KCQlfYXBpLmdldFBsdWdpbnMgPSBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIF9wbHVnaW5zOwkJCgkJfQoJCV9hcGkuZ2V0U3RvcmFnZSA9IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gX3N0b3JhZ2U7CgkJfQoJCV9hcGkuZmx1c2ggPSBmdW5jdGlvbigpIHsKCQkJX3J1bGVzID0ge307CgkJCV9zdG9yYWdlID0gW107CgkJCV9ob29rcyA9IHt9OwoJCQlfYXBpLmRlZmF1bHRQcm9jZXNzb3IgPSBsaWIucHJvY2Vzc29ycy5jc3MuQ1NTKCk7CgkJCXJldHVybiBfYXBpOwoJCX0KCQlfYXBpWydpbXBvcnQnXSA9IGZ1bmN0aW9uKCkgeyAKCQkJaWYoX2FwaS5jYWxsSG9va3MoImltcG9ydCIsIGFyZ3VtZW50cykpIHJldHVybiBfYXBpOwoJCQlyZXR1cm4gX2FwaTsgCgkJfQoJCV9hcGkuaGFuZGxlY3NzID0gZnVuY3Rpb24ocGFyc2VkLCBwYXRoKSB7CgkJCXZhciBwbHVnaW5zID0gX2FwaS5nZXRQbHVnaW5zKCk7CgkJCWlmKHBhcnNlZCAmJiBwYXJzZWQudHlwZSA9PT0gJ3N0eWxlc2hlZXQnICYmIHBhcnNlZC5zdHlsZXNoZWV0ICYmIHBhcnNlZC5zdHlsZXNoZWV0LnJ1bGVzKSB7CgkJCQl2YXIgcnVsZXMgPSBwYXJzZWQuc3R5bGVzaGVldC5ydWxlczsKCQkJCWZvcih2YXIgaT0wOyBydWxlPXJ1bGVzW2ldOyBpKyspIHsKCQkJCQlzd2l0Y2gocnVsZS50eXBlKSB7CgkJCQkJCWNhc2UgInJ1bGUiOiBfYXBpLmhhbmRsZWNzc3J1bGUocnVsZSk7IGJyZWFrOwoJCQkJCQljYXNlICJpbXBvcnQiOiBfYXBpLmhhbmRsZWNzc2ltcG9ydChydWxlLCBwYXRoKTsgYnJlYWs7CgkJCQkJCWRlZmF1bHQ6CgkJCQkJCQlpZihwbHVnaW5zW3J1bGUudHlwZV0pIHsKCQkJCQkJCQlwbHVnaW5zW3J1bGUudHlwZV0oX2FwaSwgcnVsZSk7CgkJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQlyZXR1cm4gX2FwaTsKCQl9CgkJX2FwaS5oYW5kbGVjc3NpbXBvcnQgPSBmdW5jdGlvbihydWxlLCBjc3NQYXRoKSB7CgkJCXJldHVybiBfYXBpOwoJCX0KCQlfYXBpLmhhbmRsZWNzc3J1bGUgPSBmdW5jdGlvbihydWxlLCBzdHlsZXNoZWV0KSB7CQkKCQkJdmFyIGFic3VyZE9iaiA9IHt9LCBhYnN1cmRQcm9wcyA9IHt9OwoJCQlpZihydWxlLmRlY2xhcmF0aW9ucyAmJiBydWxlLmRlY2xhcmF0aW9ucy5sZW5ndGggPiAwKSB7CgkJCQlmb3IodmFyIGk9MDsgZGVjbD1ydWxlLmRlY2xhcmF0aW9uc1tpXTsgaSsrKSB7CgkJCQkJaWYoZGVjbC50eXBlID09PSAiZGVjbGFyYXRpb24iKSB7CgkJCQkJCWFic3VyZFByb3BzW2RlY2wucHJvcGVydHldID0gZGVjbC52YWx1ZTsKCQkJCQl9CgkJCQl9CgkJCQkvLyBhYnN1cmRPYmpbcnVsZS5zZWxlY3RvcnMuam9pbigiLCAiKV0gPSBhYnN1cmRQcm9wczsKCQkJCWlmKHJ1bGUuc2VsZWN0b3JzICYmIHJ1bGUuc2VsZWN0b3JzLmxlbmd0aCA+IDApIHsKCQkJCQlmb3IodmFyIGk9MDsgc2VsZWN0b3I9cnVsZS5zZWxlY3RvcnNbaV07IGkrKykgewoJCQkJCQlhYnN1cmRPYmpbc2VsZWN0b3JdID0gZXh0ZW5kKHt9LCBhYnN1cmRQcm9wcyk7CgkJCQkJfQoJCQkJfQoJCQkJX2FwaS5hZGQoYWJzdXJkT2JqLCBzdHlsZXNoZWV0KTsKCQkJfQoJCQlyZXR1cm4gX2FwaTsKCQl9CgoJCS8vIGhvb2tzCgkJX2FwaS5hZGRIb29rID0gZnVuY3Rpb24obWV0aG9kLCBjYWxsYmFjaykgewoJCQlpZighX2hvb2tzW21ldGhvZF0pIF9ob29rc1ttZXRob2RdID0gW107CgkJCXZhciBpc0FscmVhZHlBZGRlZCA9IGZhbHNlOwoJCQlmb3IodmFyIGk9MDsgYz1faG9va3NbbWV0aG9kXVtpXTsgaSsrKSB7CgkJCQlpZihjID09PSBjYWxsYmFjaykgewoJCQkJCWlzQWxyZWFkeUFkZGVkID0gdHJ1ZTsKCQkJCX0KCQkJfQoJCQlpc0FscmVhZHlBZGRlZCA9PT0gZmFsc2UgPyBfaG9va3NbbWV0aG9kXS5wdXNoKGNhbGxiYWNrKSA6IG51bGw7CgkJfQoJCV9hcGkuY2FsbEhvb2tzID0gZnVuY3Rpb24obWV0aG9kLCBhcmdzKSB7CgkJCWlmKF9ob29rc1ttZXRob2RdKSB7CgkJCQlmb3IodmFyIGk9MDsgYz1faG9va3NbbWV0aG9kXVtpXTsgaSsrKSB7CgkJCQkJaWYoYy5hcHBseShfYXBpLCBhcmdzKSA9PT0gdHJ1ZSkgcmV0dXJuIHRydWU7CgkJCQl9CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gaW50ZXJuYWwgdmFyaWFibGVzCgkJX2FwaS5udW1PZkFkZGVkUnVsZXMgPSAwOwoKCQkvLyBhYnN1cmQuY29tcG9uZW50cyBBUEkKCQlfYXBpLmNvbXBvbmVudHMgPSAoZnVuY3Rpb24oYXBpKSB7CgkJCXZhciBleHRlbmQgPSBsaWIuaGVscGVycy5FeHRlbmQsCgkJCQljbG9uZSA9IGxpYi5oZWxwZXJzLkNsb25lLAoJCQkJY29tcHMgPSB7fSwgCgkJCQlpbnN0YW5jZXMgPSBbXSwKCQkJCWV2ZW50cyA9IGV4dGVuZCh7fSwgQ29tcG9uZW50KCkpLAoJCQkJZXhwb3J0cyA9IHt9OwoKCQkJKGZ1bmN0aW9uKGZuKSB7CgkJCQlpZighd2luZG93KSByZXR1cm47CgkJCQlpZiAod2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKCQkJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGZuKTsKCQkJCX0gZWxzZSBpZih3aW5kb3cuYXR0YWNoRXZlbnQpIHsKCQkJCQl3aW5kb3cuYXR0YWNoRXZlbnQoJ29ubG9hZCcsIGZuKTsKCQkJCX0KCQkJfSkoZnVuY3Rpb24oKSB7CgkJCQlleHBvcnRzLmJyb2FkY2FzdCgicmVhZHkiKTsKCQkJfSkKCgkJCXJldHVybiBleHBvcnRzID0gewoJCQkJbnVtT2ZDb21wb25lbnRzOiAwLAoJCQkJZXZlbnRzOiBldmVudHMsCgkJCQlyZWdpc3RlcjogZnVuY3Rpb24obmFtZSwgY2xzKSB7CgkJCQkJdGhpcy5udW1PZkNvbXBvbmVudHMgKz0gMTsKCQkJCQlyZXR1cm4gY29tcHNbbmFtZV0gPSBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIGMgPSBleHRlbmQoe30sIENvbXBvbmVudChuYW1lLCBhcGksIGV2ZW50cywgY2xvbmUoY2xzKSkpOwoJCQkJCQlhcGkuZGkucmVzb2x2ZU9iamVjdChjKTsKCQkJCQkJaW5zdGFuY2VzLnB1c2goYyk7CgkJCQkJCWlmKHR5cGVvZiBjLmNvbnN0cnVjdG9yID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJCQljLmNvbnN0cnVjdG9yLmFwcGx5KGMsIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCkpOwoJCQkJCQl9CgkJCQkJCXJldHVybiBjOwoJCQkJCX07CgkJCQl9LAoJCQkJZ2V0OiBmdW5jdGlvbihuYW1lKSB7CgkJCQkJaWYoY29tcHNbbmFtZV0pIHsgcmV0dXJuIGNvbXBzW25hbWVdOyB9CgkJCQkJZWxzZSB7IHRocm93IG5ldyBFcnJvcigiVGhlcmUgaXMgbm8gY29tcG9uZW50IHdpdGggbmFtZSAnIiArIG5hbWUgKyAiJy4iKTsgfQoJCQkJfSwKCQkJCXJlbW92ZTogZnVuY3Rpb24obmFtZSkgewoJCQkJCWlmKGNvbXBzW25hbWVdKSB7IGRlbGV0ZSBjb21wc1tuYW1lXTsgcmV0dXJuIHRydWU7IH0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9LAoJCQkJbGlzdDogZnVuY3Rpb24oKSB7CgkJCQkJdmFyIGwgPSBbXTsKCQkJCQlmb3IodmFyIG5hbWUgaW4gY29tcHMpIGwucHVzaChuYW1lKTsKCQkJCQlyZXR1cm4gbDsKCQkJCX0sCgkJCQlmbHVzaDogZnVuY3Rpb24oKSB7CgkJCQkJY29tcHMgPSB7fTsKCQkJCQlpbnN0YW5jZXMgPSBbXTsKCQkJCQlyZXR1cm4gdGhpczsKCQkJCX0sCgkJCQlicm9hZGNhc3Q6IGZ1bmN0aW9uKGV2ZW50LCBkYXRhKSB7CgkJCQkJZm9yKHZhciBpPTA7IGk8aW5zdGFuY2VzLmxlbmd0aCwgaW5zdGFuY2U9aW5zdGFuY2VzW2ldOyBpKyspIHsKCQkJCQkJaWYodHlwZW9mIGluc3RhbmNlW2V2ZW50XSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCQkJaW5zdGFuY2VbZXZlbnRdKGRhdGEpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldHVybiB0aGlzOwoJCQkJfQoJCQl9CgkJfSkoX2FwaSk7CgoJCS8vIGFic3VyZC5jb21wb25lbnQgc2hvcnRjdXQKCQlfYXBpLmNvbXBvbmVudCA9IChmdW5jdGlvbihhcGkpIHsKCQkJcmV0dXJuIGZ1bmN0aW9uKG5hbWUsIGNscykgewoJCQkJaWYodHlwZW9mIGNscyA9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldHVybiBhcGkuY29tcG9uZW50cy5nZXQobmFtZSk7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiBhcGkuY29tcG9uZW50cy5yZWdpc3RlcihuYW1lLCBjbHMpOwoJCQkJfQoJCQl9CgkJfSkoX2FwaSk7CgoJCS8vIGRlcGVuZGVuY3kgaW5qZWN0b3IKCQlfYXBpLmRpID0gbGliLkRJKF9hcGkpOwoJCWluamVjdGluZyhfYXBpKTsKCgkJLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogQ29waWVkIGRpcmVjdGx5IGZyb20gL2xpYi9BUEkuanMgKi8KCgkJLy8gY2xpZW50IHNpZGUgc3BlY2lmaWMgbWV0aG9kcyAKCQlfYXBpLmNvbXBpbGUgPSBmdW5jdGlvbihjYWxsYmFjaywgb3B0aW9ucykgewoJCQlpZihfYXBpLmNhbGxIb29rcygiY29tcGlsZSIsIGFyZ3VtZW50cykpIHJldHVybiBfYXBpOwoJCQl2YXIgZGVmYXVsdE9wdGlvbnMgPSB7CgkJCQljb21iaW5lU2VsZWN0b3JzOiB0cnVlLAoJCQkJbWluaWZ5OiBmYWxzZSwKCQkJCXByb2Nlc3NvcjogX2FwaS5kZWZhdWx0UHJvY2Vzc29yLAoJCQkJa2VlcENhbWVsQ2FzZTogZmFsc2UsCgkJCQlhcGk6IF9hcGkKCQkJfTsKCQkJb3B0aW9ucyA9IGV4dGVuZChkZWZhdWx0T3B0aW9ucywgb3B0aW9ucyB8fCB7fSk7CgkJCXZhciByZXMgPSBvcHRpb25zLnByb2Nlc3NvcigKCQkJCV9hcGkuZ2V0UnVsZXMoKSwKCQkJCWNhbGxiYWNrIHx8IGZ1bmN0aW9uKCkge30sCgkJCQlvcHRpb25zCgkJCSk7CgkJCV9hcGkuZmx1c2goKTsKCQkJcmV0dXJuIHJlczsKCQl9CgoJCS8vIHJlZ2lzdGVyaW5nIGFwaSBtZXRob2RzCgkJZm9yKHZhciBtZXRob2QgaW4gbGliLmFwaSkgewoJCQlpZihtZXRob2QgIT09ICJjb21waWxlIikgewoJCQkJX2FwaVttZXRob2RdID0gbGliLmFwaVttZXRob2RdKF9hcGkpOwoJCQkJX2FwaVttZXRob2RdID0gKGZ1bmN0aW9uKG1ldGhvZCkgewoJCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQkJdmFyIGYgPSBsaWIuYXBpW21ldGhvZF0oX2FwaSk7CgkJCQkJCWlmKF9hcGkuY2FsbEhvb2tzKG1ldGhvZCwgYXJndW1lbnRzKSkgcmV0dXJuIF9hcGk7CgkJCQkJCXJldHVybiBmLmFwcGx5KF9hcGksIGFyZ3VtZW50cyk7CgkJCQkJfQoJCQkJfSkobWV0aG9kKTsJCQoJCQl9CgkJfQoKCQkvLyByZWdpc3RlcmluZyBwbHVnaW5zCgkJZm9yKHZhciBwbHVnaW5OYW1lIGluIGxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zKSB7CgkJCV9hcGkucGx1Z2luKHBsdWdpbk5hbWUsIGxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zW3BsdWdpbk5hbWVdKCkpOwoJCX0KCgkJLy8gYWNjZXB0IGZ1bmN0aW9uCgkJaWYodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIikgewoJCQlhcmcoX2FwaSk7CgkJfQoKCQkvLyBjaGVjayBmb3IgT3JnYW5pYwoJCWlmKHR5cGVvZiBPcmdhbmljICE9ICd1bmRlZmluZWQnKSB7CgkJCU9yZ2FuaWMuaW5pdChfYXBpKTsKCQl9CgoJCS8vIGF0dGFjaGluZyB1dGlscyBmdW5jdGlvbnMKCQlfYXBpLnV0aWxzID0gewoJCQlzdHIyRE9NRWxlbWVudDogc3RyMkRPTUVsZW1lbnQKCQl9CgoJCXJldHVybiBfYXBpOwoKCX0KfTtsaWIuREkgPSBmdW5jdGlvbihhcGkpIHsKCXZhciBpbmplY3RvciA9IHsKCSAgICBkZXBlbmRlbmNpZXM6IHt9LAoJICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CgkgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzW2tleV0gPSB2YWx1ZTsKCSAgICAgICAgcmV0dXJuIHRoaXM7CgkgICAgfSwKCSAgICByZXNvbHZlOiBmdW5jdGlvbigpIHsKCSAgICAgICAgdmFyIGZ1bmMsIGRlcHMsIHNjb3BlLCBzZWxmID0gdGhpcywgaXNGb3JSZXNvbHZpbmcgPSBmYWxzZTsKCSAgICAgICAgaWYodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gJ3N0cmluZycpIHsKCSAgICAgICAgICAgIGZ1bmMgPSBhcmd1bWVudHNbMV07CgkgICAgICAgICAgICBkZXBzID0gYXJndW1lbnRzWzBdLnJlcGxhY2UoLyAvZywgJycpLnNwbGl0KCcsJyk7CgkgICAgICAgICAgICBzY29wZSA9IGFyZ3VtZW50c1syXSB8fCB7fTsKCSAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgIGZ1bmMgPSBhcmd1bWVudHNbMF07CgkgICAgICAgICAgICBkZXBzID0gZnVuYy50b1N0cmluZygpLm1hdGNoKC9eZnVuY3Rpb25ccypbXlwoXSpcKFxzKihbXlwpXSopXCkvbSlbMV0ucmVwbGFjZSgvIC9nLCAnJykuc3BsaXQoJywnKTsKCSAgICAgICAgICAgIHNjb3BlID0gYXJndW1lbnRzWzFdIHx8IHt9OwoJICAgICAgICB9CgkgICAgICAgIGZvcih2YXIgaT0wOyBpPGRlcHMubGVuZ3RoOyBpKyspIHsKCSAgICAgICAgCWlmKHR5cGVvZiB0aGlzLmRlcGVuZGVuY2llc1tkZXBzW2ldXSAhPSAndW5kZWZpbmVkJykgaXNGb3JSZXNvbHZpbmcgPSB0cnVlOwoJICAgICAgICB9CgkgICAgICAgIGlmKGlzRm9yUmVzb2x2aW5nKSB7CgkJICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CgkJICAgICAgICAJdmFyIGFyZ3MgPSBbXTsKCQkgICAgICAgICAgICB2YXIgYSA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7CgkJICAgICAgICAgICAgZm9yKHZhciBpPTA7IGk8ZGVwcy5sZW5ndGg7IGkrKykgewoJCSAgICAgICAgICAgICAgICB2YXIgZCA9IGRlcHNbaV07CgkJICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBzZWxmLmRlcGVuZGVuY2llc1tkXSAhPSAndW5kZWZpbmVkJykgewoJCSAgICAgICAgICAgICAgICAJdmFyIGRpTW9kdWxlID0gc2VsZi5kZXBlbmRlbmNpZXNbZF07CgkJICAgICAgICAgICAgICAgIAlpZih0eXBlb2YgZGlNb2R1bGUgPT0gJ2Z1bmN0aW9uJykgewoJCSAgICAgICAgICAgICAgICAJCWRpTW9kdWxlLnByb3RvdHlwZS5ob3N0ID0gc2NvcGU7CgkJICAgICAgICAgICAgICAgIAl9IGVsc2UgaWYodHlwZW9mIGRpTW9kdWxlID09ICdvYmplY3QnKSB7CgkJICAgICAgICAgICAgICAgIAkJZGlNb2R1bGUuaG9zdCA9IHNjb3BlOwoJCSAgICAgICAgICAgICAgICAJfQoJCQkJCQkJYXJncy5wdXNoKGRpTW9kdWxlKTsKCQkgICAgICAgICAgICAgICAgfSBlbHNlIHsKCQkgICAgICAgICAgICAgICAgCWFyZ3MucHVzaChhLnNoaWZ0KCkpCgkJICAgICAgICAgICAgICAgIH0KCQkgICAgICAgICAgICB9CgkJICAgICAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkoc2NvcGUsIGFyZ3MpOwoJCSAgICAgICAgfQoJICAgIAl9CgkgICAgCXJldHVybiBmdW5jOwoJICAgIH0sCgkgICAgcmVzb2x2ZU9iamVjdDogZnVuY3Rpb24obykgewoJICAgIAlpZih0eXBlb2YgbyA9PSAnb2JqZWN0JykgewoJICAgIAkJZm9yKHZhciBrZXkgaW4gbykgewoJICAgIAkJCWlmKHR5cGVvZiBvW2tleV0gPT0gJ2Z1bmN0aW9uJykgewoJICAgIAkJCQlvW2tleV0gPSB0aGlzLnJlc29sdmUob1trZXldLCBvKTsKCSAgICAJCQl9IGVsc2UgaWYob1trZXldIGluc3RhbmNlb2YgQXJyYXkgJiYgb1trZXldLmxlbmd0aCA9PSAyICYmIHR5cGVvZiBvW2tleV1bMF0gPT0gJ3N0cmluZycgJiYgdHlwZW9mIG9ba2V5XVsxXSA9PSAnZnVuY3Rpb24nKSB7CSAgICAJCQkJCgkgICAgCQkJCW9ba2V5XSA9IHRoaXMucmVzb2x2ZShvW2tleV1bMF0sIG9ba2V5XVsxXSwgbyk7CgkgICAgCQkJfQoJICAgIAkJfQoJICAgIAl9CgkgICAgCXJldHVybiB0aGlzOwoJICAgIH0sCgkgICAgZmx1c2g6IGZ1bmN0aW9uKCkgewoJICAgIAl0aGlzLmRlcGVuZGVuY2llcyA9IHt9OwoJICAgIAlyZXR1cm4gdGhpczsKCSAgICB9Cgl9CglyZXR1cm4gaW5qZWN0b3I7Cn07CmxpYi5hcGkuYWRkID0gZnVuY3Rpb24oQVBJKSB7Cgl2YXIgZXh0ZW5kID0gcmVxdWlyZSgiLi4vaGVscGVycy9FeHRlbmQiKSwKCQlwcmVmaXhlcyA9IHJlcXVpcmUoIi4uL2hlbHBlcnMvUHJlZml4ZXMiKSwKCQl0b1JlZ2lzdGVyID0gW10sCgkJb3B0aW9ucyA9IHsKCQkJY29tYmluZVNlbGVjdG9yczogdHJ1ZSwKCQkJcHJldmVudENvbWJpbmluZzogWydAZm9udC1mYWNlJ10KCQl9OwoKCXZhciBjaGVja0FuZEV4ZWN1dGVQbHVnaW4gPSBmdW5jdGlvbihzZWxlY3RvciwgcHJvcCwgdmFsdWUsIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKSB7CgkJdmFyIHByZWZpeCA9IHByZWZpeGVzLm5vblByZWZpeFByb3AocHJvcCk7CgkJdmFyIHBsdWdpbiA9IEFQSS5nZXRQbHVnaW5zKClbcHJlZml4LnByb3BdOwoJCS8vIGNvbnNvbGUubG9nKCJcbkNoZWNraW5nIGZvciBwbHVnaW46ICIgKyBwcmVmaXgucHJvcCArICIgKCIgKyBwcm9wICsgIikiKTsKCQlpZih0eXBlb2YgcGx1Z2luICE9PSAndW5kZWZpbmVkJykgewoJCQl2YXIgcGx1Z2luUmVzcG9uc2UgPSBwbHVnaW4oQVBJLCB2YWx1ZSwgcHJlZml4LnByZWZpeCk7CgkJCWlmKHBsdWdpblJlc3BvbnNlKSB7CgkJCQlhZGRSdWxlKHNlbGVjdG9yLCBwbHVnaW5SZXNwb25zZSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoJCX0gZWxzZSB7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9Cgl2YXIgYWRkUnVsZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBwcm9wcywgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpIHsKCQkvLyBjb25zb2xlLmxvZygiXG4tLS0tLS0tLS0tIGFkZFJ1bGUgLS0tLS0tLS0tIiwgcGFyZW50U2VsZWN0b3IgKyAnID4+PiAnICsgc2VsZWN0b3IsICJcbiIsIHByb3BzKTsKCgkJc3R5bGVzaGVldCA9IHN0eWxlc2hlZXQgfHwgIm1haW5zdHJlYW0iOwoKCQkvLyBjYXRjaGluZyBudWxsIHZhbHVlcwoJCWlmKHByb3BzID09PSBudWxsIHx8IHR5cGVvZiBwcm9wcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcHJvcHMgPT09IGZhbHNlKSByZXR1cm47CgkJaWYoIXBhcmVudFNlbGVjdG9yICYmICFzZWxlY3Rvcikgc2VsZWN0b3IgPSAnJzsKCgkJLy8gY2xhc3NpZnkKCQlpZih0eXBlb2YgcHJvcHMuY2xhc3NpZnkgIT0gJ3VuZGVmaW5lZCcgJiYgcHJvcHMuY2xhc3NpZnkgPT09IHRydWUpIHsKCQkJcHJvcHMgPSB0eXBlb2YgcHJvcHMudG9KU09OICE9ICd1bmRlZmluZWQnID8gcHJvcHMudG9KU09OKCkgOiBwcm9wcy50b1N0cmluZygpOwoJCX0KCgkJLy8gbXVsdGlwbGUgc2VsZWN0b3JzCgkJaWYoLywgPy9nLnRlc3Qoc2VsZWN0b3IpICYmIG9wdGlvbnMuY29tYmluZVNlbGVjdG9ycykgewoJCQl2YXIgcGFydHMgPSBzZWxlY3Rvci5yZXBsYWNlKC8sIC9nLCAnLCcpLnNwbGl0KCcsJyk7CgkJCWZvcih2YXIgaT0wOyBpPHBhcnRzLmxlbmd0aCwgcD1wYXJ0c1tpXTsgaSsrKSB7CgkJCQlhZGRSdWxlKHAsIHByb3BzLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CQoJCQl9CgkJCXJldHVybjsKCQl9CgoJCS8vIGNoZWNrIGZvciBwbHVnaW4KCQlpZihjaGVja0FuZEV4ZWN1dGVQbHVnaW4obnVsbCwgc2VsZWN0b3IsIHByb3BzLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3RvcikpIHsKCQkJcmV0dXJuOwkKCQl9CgoJCS8vIGlmIGFycmF5IGlzIHBhc3NlZAoJCWlmKHR5cGVvZiBwcm9wcy5sZW5ndGggIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBwcm9wcyA9PT0gIm9iamVjdCIpIHsKCQkJZm9yKHZhciBpPTA7IGk8cHJvcHMubGVuZ3RoOyBpKyspIHsKCQkJCXByb3A9cHJvcHNbaV07CgkJCQlpZihwcm9wKSB7CgkJCQkJYWRkUnVsZShzZWxlY3RvciwgcHJvcCwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpOwoJCQkJfQoJCQl9CgkJCXJldHVybjsKCQl9CgoJCXZhciBfcHJvcHMgPSB7fSwgCgkJCV9zZWxlY3RvciA9IHNlbGVjdG9yLAoJCQlfb2JqZWN0cyA9IHt9LCAKCQkJX2Z1bmN0aW9ucyA9IHt9OwoKCQkvLyBwcm9jZXNzaW5nIHByb3BzCgkJZm9yKHZhciBwcm9wIGluIHByb3BzKSB7CgkJCS8vIGNsYXNzaWZ5CgkJCWlmKHByb3BzW3Byb3BdICYmIHR5cGVvZiBwcm9wc1twcm9wXS5jbGFzc2lmeSAhPSAndW5kZWZpbmVkJyAmJiBwcm9wc1twcm9wXS5jbGFzc2lmeSA9PT0gdHJ1ZSkgewoJCQkJcHJvcHNbcHJvcF0gPSB0eXBlb2YgcHJvcHNbcHJvcF0udG9KU09OICE9ICd1bmRlZmluZWQnID8gcHJvcHNbcHJvcF0udG9KU09OKCkgOiBwcm9wc1twcm9wXS50b1N0cmluZygpOwoJCQl9CgkJCXZhciB0eXBlID0gdHlwZW9mIHByb3BzW3Byb3BdOwoJCQlpZih0eXBlICE9PSAnb2JqZWN0JyAmJiB0eXBlICE9PSAnZnVuY3Rpb24nICYmIHByb3BzW3Byb3BdICE9PSBmYWxzZSAmJiBwcm9wc1twcm9wXSAhPT0gdHJ1ZSkgewoJCQkJaWYoY2hlY2tBbmRFeGVjdXRlUGx1Z2luKHNlbGVjdG9yLCBwcm9wLCBwcm9wc1twcm9wXSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpID09PSBmYWxzZSkgewoJCQkJCS8vIG1vdmluZyB0aGUgc2VsZWN0b3IgdG8gdGhlIHRvcCBvZiB0aGUgY2hhaW4KCQkJCQlpZihfc2VsZWN0b3IuaW5kZXhPZigiXiIpID09PSAwKSB7CgkJCQkJCV9zZWxlY3RvciA9IF9zZWxlY3Rvci5zdWJzdHIoMSwgX3NlbGVjdG9yLmxlbmd0aC0xKSArICh0eXBlb2YgcGFyZW50U2VsZWN0b3IgIT09ICJ1bmRlZmluZWQiID8gIiAiICsgcGFyZW50U2VsZWN0b3IgOiAnJyk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX3NlbGVjdG9yID0gdHlwZW9mIHBhcmVudFNlbGVjdG9yICE9PSAidW5kZWZpbmVkIiA/IHBhcmVudFNlbGVjdG9yICsgIiAiICsgc2VsZWN0b3IgOiBzZWxlY3RvcjsKCQkJCQl9CgkJCQkJX3Byb3BzW3Byb3BdID0gcHJvcHNbcHJvcF07CgkJCQkJcHJlZml4ZXMuYWRkUHJlZml4ZXMocHJvcCwgX3Byb3BzKTsKCQkJCX0KCQkJfSBlbHNlIGlmKHR5cGUgPT09ICdvYmplY3QnKSB7CgkJCQlfb2JqZWN0c1twcm9wXSA9IHByb3BzW3Byb3BdOwoJCQl9IGVsc2UgaWYodHlwZSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJX2Z1bmN0aW9uc1twcm9wXSA9IHByb3BzW3Byb3BdOwoJCQl9CgkJfQoKCQl0b1JlZ2lzdGVyLnB1c2goewoJCQlzZWxlY3RvcjogX3NlbGVjdG9yLAoJCQlwcm9wczogX3Byb3BzLAoJCQlzdHlsZXNoZWV0OiBzdHlsZXNoZWV0CgkJfSk7CgoJCWZvcih2YXIgcHJvcCBpbiBfb2JqZWN0cykgewoJCQkvLyBjaGVjayBmb3IgcHNldWRvIGNsYXNzZXMJCQkKCQkJaWYocHJvcC5jaGFyQXQoMCkgPT09ICI6IikgewoJCQkJYWRkUnVsZShzZWxlY3RvciArIHByb3AsIF9vYmplY3RzW3Byb3BdLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CgkJICAgIC8vIGNoZWNrIGZvciBhbXBlcnNhbmQgb3BlcmF0b3IKCQkJfSBlbHNlIGlmKC8mL2cudGVzdChwcm9wKSkgewoJCQkJaWYoLywgPy9nLnRlc3QocHJvcCkgJiYgb3B0aW9ucy5jb21iaW5lU2VsZWN0b3JzKSB7CgkJCQkJdmFyIHBhcnRzID0gcHJvcC5yZXBsYWNlKC8sIC9nLCAnLCcpLnNwbGl0KCcsJyk7CgkJCQkJZm9yKHZhciBpPTA7IGk8cGFydHMubGVuZ3RoLCBwPXBhcnRzW2ldOyBpKyspIHsKCQkJCQkJaWYocC5pbmRleE9mKCcmJykgPj0gMCkgewoJCQkJCQkJYWRkUnVsZShwLnJlcGxhY2UoLyYvZywgc2VsZWN0b3IpLCBfb2JqZWN0c1twcm9wXSwgc3R5bGVzaGVldCwgcGFyZW50U2VsZWN0b3IpOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJYWRkUnVsZShwLCBfb2JqZWN0c1twcm9wXSwgc3R5bGVzaGVldCwgdHlwZW9mIHBhcmVudFNlbGVjdG9yICE9PSAidW5kZWZpbmVkIiA/IHBhcmVudFNlbGVjdG9yICsgIiAiICsgc2VsZWN0b3IgOiBzZWxlY3Rvcik7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWFkZFJ1bGUocHJvcC5yZXBsYWNlKC8mL2csIHNlbGVjdG9yKSwgX29iamVjdHNbcHJvcF0sIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKTsKCQkJCX0KCQkJLy8gY2hlY2sgZm9yIG1lZGlhIHF1ZXJ5CgkJCX0gZWxzZSBpZihwcm9wLmluZGV4T2YoIkBtZWRpYSIpID09PSAwIHx8IHByb3AuaW5kZXhPZigiQHN1cHBvcnRzIikgPT09IDApIHsKCQkJCWFkZFJ1bGUoc2VsZWN0b3IsIF9vYmplY3RzW3Byb3BdLCBwcm9wLCBwYXJlbnRTZWxlY3Rvcik7CgkJCS8vIGNoZWNrIGZvciBtZWRpYSBxdWVyeQoJCQl9IGVsc2UgaWYoc2VsZWN0b3IuaW5kZXhPZigiQG1lZGlhIikgPT09IDAgfHwgcHJvcC5pbmRleE9mKCJAc3VwcG9ydHMiKSA9PT0gMCkgewoJCQkJYWRkUnVsZShwcm9wLCBfb2JqZWN0c1twcm9wXSwgc2VsZWN0b3IsIHBhcmVudFNlbGVjdG9yKTsKCQkJLy8gbW92aW5nIHRoZSBzZWxlY3RvciB0byB0aGUgdG9wIG9mIHRoZSBjaGFpbgoJCQl9IGVsc2UgaWYoc2VsZWN0b3IuaW5kZXhPZigiXiIpID09PSAwKSB7CgkJCQkvLyBzZWxlY3RvciwgcHJvcHMsIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yCgkJCQlhZGRSdWxlKAoJCQkJCXNlbGVjdG9yLnN1YnN0cigxLCBzZWxlY3Rvci5sZW5ndGgtMSkgKyAodHlwZW9mIHBhcmVudFNlbGVjdG9yICE9PSAidW5kZWZpbmVkIiA/ICIgIiArIHBhcmVudFNlbGVjdG9yIDogJycpICsgIiAiICsgcHJvcCwKCQkJCQlfb2JqZWN0c1twcm9wXSwgCgkJCQkJc3R5bGVzaGVldAoJCQkJKTsKCQkJLy8gY2hlY2sgZm9yIHBsdWdpbnMKCQkJfSBlbHNlIGlmKGNoZWNrQW5kRXhlY3V0ZVBsdWdpbihzZWxlY3RvciwgcHJvcCwgX29iamVjdHNbcHJvcF0sIHN0eWxlc2hlZXQsIHBhcmVudFNlbGVjdG9yKSA9PT0gZmFsc2UpIHsKCQkJCWFkZFJ1bGUocHJvcCwgX29iamVjdHNbcHJvcF0sIHN0eWxlc2hlZXQsIChwYXJlbnRTZWxlY3RvciA/IHBhcmVudFNlbGVjdG9yICsgIiAiIDogIiIpICsgc2VsZWN0b3IpOwoJCQl9CgkJfQoKCQlmb3IodmFyIHByb3AgaW4gX2Z1bmN0aW9ucykgewoJCQl2YXIgbyA9IHt9OwoJCQlvW3Byb3BdID0gX2Z1bmN0aW9uc1twcm9wXSgpOwoJCQlhZGRSdWxlKHNlbGVjdG9yLCBvLCBzdHlsZXNoZWV0LCBwYXJlbnRTZWxlY3Rvcik7CgkJfQoJCQoJfQoKCXZhciBhZGQgPSBmdW5jdGlvbihydWxlcywgc3R5bGVzaGVldCwgb3B0cykgewoKCQlpZihBUEkuanNvbmlmeSkgewoJCQlleHRlbmQoQVBJLmdldFJ1bGVzKHN0eWxlc2hlZXQgfHwgJ21haW5zdHJlYW0nKSwgcnVsZXMpOwoJCQlyZXR1cm4gQVBJOwoJCX0KCgkJdHJ5IHsKCgkJCXRvUmVnaXN0ZXIgPSBbXTsKCQkJQVBJLm51bU9mQWRkZWRSdWxlcyArPSAxOwoKCQkJaWYodHlwZW9mIHN0eWxlc2hlZXQgPT09ICdvYmplY3QnICYmIHR5cGVvZiBvcHRzID09PSAndW5kZWZpbmVkJykgewoJCQkJb3B0aW9ucyA9IHsKCQkJCQljb21iaW5lU2VsZWN0b3JzOiB0eXBlb2Ygc3R5bGVzaGVldC5jb21iaW5lU2VsZWN0b3JzICE9ICd1bmRlZmluZWQnID8gc3R5bGVzaGVldC5jb21iaW5lU2VsZWN0b3JzIDogb3B0aW9ucy5jb21iaW5lU2VsZWN0b3JzLAoJCQkJCXByZXZlbnRDb21iaW5pbmc6IG9wdGlvbnMucHJldmVudENvbWJpbmluZy5jb25jYXQoc3R5bGVzaGVldC5wcmV2ZW50Q29tYmluaW5nIHx8IFtdKQoJCQkJfTsKCQkJCXN0eWxlc2hlZXQgPSBudWxsOwoJCQl9CgkJCWlmKHR5cGVvZiBvcHRzICE9ICd1bmRlZmluZWQnKSB7CgkJCQlvcHRpb25zID0gewoJCQkJCWNvbWJpbmVTZWxlY3RvcnM6IG9wdHMuY29tYmluZVNlbGVjdG9ycyB8fCBvcHRpb25zLmNvbWJpbmVTZWxlY3RvcnMsCgkJCQkJcHJldmVudENvbWJpbmluZzogb3B0aW9ucy5wcmV2ZW50Q29tYmluaW5nLmNvbmNhdChvcHRzLnByZXZlbnRDb21iaW5pbmcgfHwgW10pCgkJCQl9OwoJCQl9CgoJCQl2YXIgdHlwZU9mUHJlcHJvY2Vzc29yID0gQVBJLmRlZmF1bHRQcm9jZXNzb3IudHlwZSwgdWlkOwoKCQkJZm9yKHZhciBzZWxlY3RvciBpbiBydWxlcykgewoJCQkJYWRkUnVsZShzZWxlY3RvciwgcnVsZXNbc2VsZWN0b3JdLCBzdHlsZXNoZWV0IHx8ICJtYWluc3RyZWFtIik7CgkJCX0KCgkJCS8vIGxvb3BpbmcgdGhyb3VnaCB0aGUgcnVsZXMgZm9yIHJlZ2lzdGVyaW5nCgkJCWZvcih2YXIgaT0wOyBpPHRvUmVnaXN0ZXIubGVuZ3RoOyBpKyspIHsKCQkJCXZhciBzdHlsZXNoZWV0ID0gdG9SZWdpc3RlcltpXS5zdHlsZXNoZWV0LAoJCQkJCXNlbGVjdG9yID0gdG9SZWdpc3RlcltpXS5zZWxlY3RvciwKCQkJCQlwcm9wcyA9IHRvUmVnaXN0ZXJbaV0ucHJvcHMsCgkJCQkJYWxsUnVsZXMgPSBBUEkuZ2V0UnVsZXMoc3R5bGVzaGVldCk7CgkJCQl2YXIgcGMgPSBvcHRpb25zICYmIG9wdGlvbnMucHJldmVudENvbWJpbmluZyA/ICd8JyArIG9wdGlvbnMucHJldmVudENvbWJpbmluZy5qb2luKCd8JykgOiAnJzsKCQkJCXZhciB1aWQgPSBwYy5pbmRleE9mKCd8JyArIHNlbGVjdG9yLnJlcGxhY2UoL14lLio/JS8sICcnKSkgPj0gMCA/ICd+ficgKyBBUEkubnVtT2ZBZGRlZFJ1bGVzICsgJ35+JyA6ICcnOwoJCQkJLy8gb3ZlcndyaXRlIGFscmVhZHkgYWRkZWQgdmFsdWUKCQkJCXZhciBjdXJyZW50ID0gYWxsUnVsZXNbdWlkICsgc2VsZWN0b3JdIHx8IHt9OwoJCQkJZm9yKHZhciBwcm9wTmV3IGluIHByb3BzKSB7CgkJCQkJdmFyIHZhbHVlID0gcHJvcHNbcHJvcE5ld107CgkJCQkJcHJvcE5ldyA9IHVpZCArIHByb3BOZXc7CgkJCQkJaWYodHlwZW9mIHZhbHVlICE9ICdvYmplY3QnKSB7CgkJCQkJCWlmKHR5cGVPZlByZXByb2Nlc3NvciA9PSAiY3NzIikgewoJCQkJCQkJLy8gYXBwZW5kaW5nIHZhbHVlcwoJCQkJCQkJaWYodmFsdWUudG9TdHJpbmcoKS5jaGFyQXQoMCkgPT09ICIrIikgewoJCQkJCQkJCWlmKGN1cnJlbnQgJiYgY3VycmVudFtwcm9wTmV3XSkgewoJCQkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gY3VycmVudFtwcm9wTmV3XSArICIsICIgKyB2YWx1ZS5zdWJzdHIoMSwgdmFsdWUubGVuZ3RoLTEpOwkKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gdmFsdWUuc3Vic3RyKDEsIHZhbHVlLmxlbmd0aC0xKTsJCgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIGlmKHZhbHVlLnRvU3RyaW5nKCkuY2hhckF0KDApID09PSAiPiIpIHsKCQkJCQkJCQlpZihjdXJyZW50ICYmIGN1cnJlbnRbcHJvcE5ld10pIHsKCQkJCQkJCQkJY3VycmVudFtwcm9wTmV3XSA9IGN1cnJlbnRbcHJvcE5ld10gKyAiICIgKyB2YWx1ZS5zdWJzdHIoMSwgdmFsdWUubGVuZ3RoLTEpOwkKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gdmFsdWUuc3Vic3RyKDEsIHZhbHVlLmxlbmd0aC0xKTsJCgkJCQkJCQkJfQoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gdmFsdWU7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQljdXJyZW50W3Byb3BOZXddID0gdmFsdWU7CgkJCQkJCX0KCQkJCQkJCgkJCQkJfQoJCQkJfQoJCQkJYWxsUnVsZXNbdWlkICsgc2VsZWN0b3JdID0gY3VycmVudDsKCQkJfQoKCQlyZXR1cm4gQVBJOwoKCQl9IGNhdGNoKGVycikgewoJCQl0aHJvdyBuZXcgRXJyb3IoIkVycm9yIGFkZGluZzogIiArIEpTT04uc3RyaW5naWZ5KHtydWxlczogcnVsZXMsIGVycm9yOiBlcnIudG9TdHJpbmcoKX0pKTsKCQl9Cgl9CglyZXR1cm4gYWRkOwp9Cgp2YXIgZXh0ZW5kID0gcmVxdWlyZSgiLi4vaGVscGVycy9FeHRlbmQiKTsKCmxpYi5hcGkuY29tcGlsZSA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCXZhciBwYXRoID0gbnVsbCwgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHt9LCBvcHRpb25zID0gbnVsbDsKCQlmb3IodmFyIGk9MDsgaTxhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJc3dpdGNoKHR5cGVvZiBhcmd1bWVudHNbaV0pIHsKCQkJCWNhc2UgImZ1bmN0aW9uIjogY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07IGJyZWFrOwoJCQkJY2FzZSAic3RyaW5nIjogcGF0aCA9IGFyZ3VtZW50c1tpXTsgYnJlYWs7CgkJCQljYXNlICJvYmplY3QiOiBvcHRpb25zID0gYXJndW1lbnRzW2ldOyBicmVhazsKCQkJfQoJCX0KCgkJdmFyIF9kZWZhdWx0T3B0aW9ucyA9IHsKCQkJY29tYmluZVNlbGVjdG9yczogdHJ1ZSwKCQkJbWluaWZ5OiBmYWxzZSwKCQkJa2VlcENhbWVsQ2FzZTogZmFsc2UsCgkJCXByb2Nlc3NvcjogYXBpLmRlZmF1bHRQcm9jZXNzb3IsCgkJCWFwaTogYXBpCgkJfTsKCQlvcHRpb25zID0gZXh0ZW5kKF9kZWZhdWx0T3B0aW9ucywgb3B0aW9ucyB8fCB7fSk7CgoJCXJldHVybiBvcHRpb25zLnByb2Nlc3NvcigKCQkJYXBpLmdldFJ1bGVzKCksCgkJCWZ1bmN0aW9uKGVyciwgcmVzdWx0KSB7CgkJCQlpZihwYXRoICE9IG51bGwpIHsKCQkJCQl0cnkgewoJCQkJCQl2YXIgZmlsZUNvbnRlbnQgPSByZXN1bHQ7CgkJCQkJCWlmKCdvYmplY3QnID09PSB0eXBlb2YgZmlsZUNvbnRlbnQpIHsKCQkJCQkJCWZpbGVDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoZmlsZUNvbnRlbnQpOwoJCQkJCQl9CgkJCQkJCWZzLndyaXRlRmlsZShwYXRoLCBmaWxlQ29udGVudCwgZnVuY3Rpb24gKGVycikgewoJCQkJCQkJY2FsbGJhY2soZXJyLCByZXN1bHQpOwoJCQkJCQl9KTsKCQkJCQl9IGNhdGNoKGVycikgewoJCQkJCQljYWxsYmFjay5hcHBseSh7fSwgYXJndW1lbnRzKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWNhbGxiYWNrLmFwcGx5KHt9LCBhcmd1bWVudHMpOwoJCQkJfQoJCQkJYXBpLmZsdXNoKCk7CgkJCX0sCgkJCW9wdGlvbnMKCQkpOwoJCQoJfQp9CgpsaWIuYXBpLmNvbXBpbGVGaWxlID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gYXBpLmNvbXBpbGU7Cn0KdmFyIENvbG9yTHVtaW5hbmNlID0gZnVuY3Rpb24gKGhleCwgbHVtKSB7CgoJLy8gdmFsaWRhdGUgaGV4IHN0cmluZwoJaGV4ID0gU3RyaW5nKGhleCkucmVwbGFjZSgvW14wLTlhLWZdL2dpLCAnJyk7CglpZiAoaGV4Lmxlbmd0aCA8IDYpIHsKCQloZXggPSBoZXhbMF0raGV4WzBdK2hleFsxXStoZXhbMV0raGV4WzJdK2hleFsyXTsKCX0KCWx1bSA9IGx1bSB8fCAwOwoKCS8vIGNvbnZlcnQgdG8gZGVjaW1hbCBhbmQgY2hhbmdlIGx1bWlub3NpdHkKCXZhciByZ2IgPSAiIyIsIGMsIGk7Cglmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CgkJYyA9IHBhcnNlSW50KGhleC5zdWJzdHIoaSoyLDIpLCAxNik7CgkJYyA9IE1hdGgucm91bmQoTWF0aC5taW4oTWF0aC5tYXgoMCwgYyArIChjICogbHVtKSksIDI1NSkpLnRvU3RyaW5nKDE2KTsKCQlyZ2IgKz0gKCIwMCIrYykuc3Vic3RyKGMubGVuZ3RoKTsKCX0KCglyZXR1cm4gcmdiOwp9OwpsaWIuYXBpLmRhcmtlbiA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKGNvbG9yLCBwZXJjZW50cykgewoJCXJldHVybiBDb2xvckx1bWluYW5jZShjb2xvciwgLShwZXJjZW50cy8xMDApKTsKCX0KfQpsaWIuYXBpLmRlZmluZSA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKHByb3AsIHZhbHVlKSB7CgkJaWYoIWFwaS5nZXRTdG9yYWdlKCkuX19kZWZpbmVkKSBhcGkuZ2V0U3RvcmFnZSgpLl9fZGVmaW5lZCA9IHt9OwoJCWFwaS5nZXRTdG9yYWdlKCkuX19kZWZpbmVkW3Byb3BdID0gdmFsdWU7CgkJcmV0dXJuIGFwaTsKCX0KfQpsaWIuYXBpLmhvb2sgPSBmdW5jdGlvbihhcGkpIHsKCXJldHVybiBmdW5jdGlvbihtZXRob2QsIGNhbGxiYWNrKSB7CgkJYXBpLmFkZEhvb2sobWV0aG9kLCBjYWxsYmFjayk7CgkJcmV0dXJuIGFwaTsKCX0KfQpsaWIuYXBpLmltcG9ydENTUyA9IGZ1bmN0aW9uKGFwaSkgewoJdmFyIENTU1BhcnNlID0gcmVxdWlyZSgiLi4vaGVscGVycy9DU1NQYXJzZSIpOwoJcmV0dXJuIGZ1bmN0aW9uKGNzc0RhdGEpIHsKCQl0cnkgewoJCQl2YXIgcGFyc2VkID0gQ1NTUGFyc2UoY3NzRGF0YSk7CgkJCWFwaS5oYW5kbGVjc3MocGFyc2VkLCAnJyk7CgkJfSBjYXRjaChlcnIpIHsKCQkJY29uc29sZS5sb2coIkVycm9yIGluIHRoZSBDU1M6ICAnIiArIGNzc0RhdGEgKyAiJyIsIGVyciwgZXJyLnN0YWNrKTsKCQl9CgkJcmV0dXJuIGFwaTsKCX0KfQp2YXIgQ29sb3JMdW1pbmFuY2UgPSBmdW5jdGlvbiAoaGV4LCBsdW0pIHsKCgkvLyB2YWxpZGF0ZSBoZXggc3RyaW5nCgloZXggPSBTdHJpbmcoaGV4KS5yZXBsYWNlKC9bXjAtOWEtZl0vZ2ksICcnKTsKCWlmIChoZXgubGVuZ3RoIDwgNikgewoJCWhleCA9IGhleFswXStoZXhbMF0raGV4WzFdK2hleFsxXStoZXhbMl0raGV4WzJdOwoJfQoJbHVtID0gbHVtIHx8IDA7CgoJLy8gY29udmVydCB0byBkZWNpbWFsIGFuZCBjaGFuZ2UgbHVtaW5vc2l0eQoJdmFyIHJnYiA9ICIjIiwgYywgaTsKCWZvciAoaSA9IDA7IGkgPCAzOyBpKyspIHsKCQljID0gcGFyc2VJbnQoaGV4LnN1YnN0cihpKjIsMiksIDE2KTsKCQljID0gTWF0aC5yb3VuZChNYXRoLm1pbihNYXRoLm1heCgwLCBjICsgKGMgKiBsdW0pKSwgMjU1KSkudG9TdHJpbmcoMTYpOwoJCXJnYiArPSAoIjAwIitjKS5zdWJzdHIoYy5sZW5ndGgpOwoJfQoKCXJldHVybiByZ2I7Cn07CmxpYi5hcGkubGlnaHRlbiA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKGNvbG9yLCBwZXJjZW50cykgewoJCXJldHVybiBDb2xvckx1bWluYW5jZShjb2xvciwgcGVyY2VudHMvMTAwKTsKCX0KfQp2YXIgbWV0YW1vcnBob3NpcyA9IHsKCWh0bWw6IGZ1bmN0aW9uKGFwaSkgewoJCWFwaS5kZWZhdWx0UHJvY2Vzc29yID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uL3Byb2Nlc3NvcnMvaHRtbC9IVE1MLmpzIikoKTsKCQlhcGkuaG9vaygiYWRkIiwgZnVuY3Rpb24odGFncywgdGVtcGxhdGUpIHsKCQkJYXBpLmdldFJ1bGVzKHRlbXBsYXRlIHx8ICJtYWluc3RyZWFtIikucHVzaCh0YWdzKTsKCQkJcmV0dXJuIHRydWU7CgkJfSk7Cgl9LAoJY29tcG9uZW50OiBmdW5jdGlvbihhcGkpIHsKCQlhcGkuZGVmYXVsdFByb2Nlc3NvciA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi9wcm9jZXNzb3JzL2NvbXBvbmVudC9Db21wb25lbnQuanMiKSgpOwoJCWFwaS5ob29rKCJhZGQiLCBmdW5jdGlvbihjb21wb25lbnQpIHsKCQkJaWYoIShjb21wb25lbnQgaW5zdGFuY2VvZiBBcnJheSkpIGNvbXBvbmVudCA9IFtjb21wb25lbnRdOwoJCQlmb3IodmFyIGk9MDsgaTxjb21wb25lbnQubGVuZ3RoLCBjID0gY29tcG9uZW50W2ldOyBpKyspIHsKCQkJCWFwaS5nZXRSdWxlcygibWFpbnN0cmVhbSIpLnB1c2goYyk7CgkJCX0KCQkJcmV0dXJuIHRydWU7CgkJfSk7CQoJfSwKCWpzb25pZnk6IGZ1bmN0aW9uKGFwaSkgewoJCWFwaS5qc29uaWZ5ID0gdHJ1ZTsKCX0sCgknZHluYW1pYy1jc3MnOiBmdW5jdGlvbihhcGkpIHsKCQlhcGkuZHluYW1pY0NTUyA9IHRydWU7Cgl9Cn0KbGliLmFwaS5tb3JwaCA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKHR5cGUpIHsKCQlpZihtZXRhbW9ycGhvc2lzW3R5cGVdKSB7CgkJCWFwaS5mbHVzaCgpOwoJCQltZXRhbW9ycGhvc2lzW3R5cGVdKGFwaSk7CgkJfQoJCXJldHVybiBhcGk7Cgl9Cn0KbGliLmFwaS5wbHVnaW4gPSBmdW5jdGlvbihhcGkpIHsKCXZhciBwbHVnaW4gPSBmdW5jdGlvbihuYW1lLCBmdW5jKSB7CgkJYXBpLmdldFBsdWdpbnMoKVtuYW1lXSA9IGZ1bmM7CgkJcmV0dXJuIGFwaTsKCX0KCXJldHVybiBwbHVnaW47CQp9CmxpYi5hcGkucmF3ID0gZnVuY3Rpb24oYXBpKSB7CglyZXR1cm4gZnVuY3Rpb24ocmF3KSB7CgkJdmFyIG8gPSB7fSwgdiA9IHt9OwoJCXZhciBpZCA9ICJfX19fcmF3XyIgKyBhcGkubnVtT2ZBZGRlZFJ1bGVzOwoJCXZbaWRdID0gcmF3OwoJCW9baWRdID0gdjsKCQlhcGkuYWRkKG8pOwoJCXJldHVybiBhcGk7Cgl9Cn0KdmFyIGZzID0gcmVxdWlyZSgiZnMiKSwKCXBhdGggPSByZXF1aXJlKCJwYXRoIik7CgpsaWIuYXBpLnJhd0ltcG9ydCA9IGZ1bmN0aW9uKEFQSSkgewoJCgl2YXIgaW1wb3J0RmlsZSA9IGZ1bmN0aW9uKHBhdGgpIHsKCQl2YXIgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMocGF0aCwge2VuY29kaW5nOiAidXRmOCJ9KTsKCQlBUEkucmF3KGZpbGVDb250ZW50KTsKCX0KCQoJcmV0dXJuIGZ1bmN0aW9uKHBhdGgpIHsKCQl2YXIgcCwgX2ksIF9sZW47CgkJaWYgKHR5cGVvZiBwYXRoID09PSAnc3RyaW5nJykgewoJCQlpbXBvcnRGaWxlKHBhdGgpOwoJCX0gZWxzZSB7CgkJCWZvciAoX2kgPSAwLCBfbGVuID0gcGF0aC5sZW5ndGg7IF9pIDwgX2xlbjsgX2krKykgewoJCQkJcCA9IHBhdGhbX2ldOwoJCQkJaW1wb3J0RmlsZShwKTsKCQkJfQoJCX0KCQlyZXR1cm4gQVBJOwogICAgfTsKfQoKbGliLmFwaS5yZWdpc3RlciA9IGZ1bmN0aW9uKGFwaSkgewoJcmV0dXJuIGZ1bmN0aW9uKG1ldGhvZCwgZnVuYykgewoJCWFwaVttZXRob2RdID0gZnVuYzsKCQlyZXR1cm4gYXBpOwoJfQp9CmxpYi5hcGkuc3RvcmFnZSA9IGZ1bmN0aW9uKEFQSSkgewoJdmFyIF9zID0gQVBJLmdldFN0b3JhZ2UoKTsKCXZhciBzdG9yYWdlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKCQlpZih0eXBlb2YgdmFsdWUgIT09ICJ1bmRlZmluZWQiKSB7CgkJCV9zW25hbWVdID0gdmFsdWU7CgkJfSBlbHNlIGlmKHR5cGVvZiBuYW1lID09PSAib2JqZWN0IikgewoJCQlmb3IodmFyIF9uYW1lIGluIG5hbWUpIHsKCQkJCWlmKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChuYW1lLCBfbmFtZSkpIHsKCQkJCQlzdG9yYWdlKF9uYW1lLCBuYW1lW19uYW1lXSk7CgkJCQl9CgkJCX0KICAgIH0gZWxzZSB7CgkJCWlmKF9zW25hbWVdKSB7CgkJCQlyZXR1cm4gX3NbbmFtZV07CgkJCX0gZWxzZSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoIlRoZXJlIGlzIG5vIGRhdGEgaW4gdGhlIHN0b3JhZ2UgYXNzb2NpYXRlZCB3aXRoICciICsgbmFtZSArICInIik7CgkJCX0KCQl9CgkJcmV0dXJuIEFQSTsKCX0KCXJldHVybiBzdG9yYWdlOwp9Ci8vIE1vZHVsZSBieSB2aXNpb25tZWRpYQovLyBodHRwczovL2dpdGh1Yi5jb20vcmV3b3JrY3NzL2Nzcy1wYXJzZQovLwovLyBodHRwOi8vd3d3LnczLm9yZy9UUi9DU1MyMS9ncmFtbWFyLmh0bWwKLy8gaHR0cHM6Ly9naXRodWIuY29tL3Zpc2lvbm1lZGlhL2Nzcy1wYXJzZS9wdWxsLzQ5I2lzc3VlY29tbWVudC0zMDA4ODAyNwp2YXIgY29tbWVudHJlID0gL1wvXCpbXipdKlwqKyhbXi8qXVteKl0qXCorKSpcLy9nCgpsaWIuaGVscGVycy5DU1NQYXJzZSA9IGZ1bmN0aW9uKGNzcywgb3B0aW9ucyl7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgb3B0aW9ucy5wb3NpdGlvbiA9IG9wdGlvbnMucG9zaXRpb24gPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlOwoKICAvKioKICAgKiBQb3NpdGlvbmFsLgogICAqLwoKICB2YXIgbGluZW5vID0gMTsKICB2YXIgY29sdW1uID0gMTsKCiAgLyoqCiAgICogVXBkYXRlIGxpbmVubyBhbmQgY29sdW1uIGJhc2VkIG9uIGBzdHJgLgogICAqLwoKICBmdW5jdGlvbiB1cGRhdGVQb3NpdGlvbihzdHIpIHsKICAgIHZhciBsaW5lcyA9IHN0ci5tYXRjaCgvXG4vZyk7CiAgICBpZiAobGluZXMpIGxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICB2YXIgaSA9IHN0ci5sYXN0SW5kZXhPZignXG4nKTsKICAgIGNvbHVtbiA9IH5pID8gc3RyLmxlbmd0aCAtIGkgOiBjb2x1bW4gKyBzdHIubGVuZ3RoOwogIH0KCiAgLyoqCiAgICogTWFyayBwb3NpdGlvbiBhbmQgcGF0Y2ggYG5vZGUucG9zaXRpb25gLgogICAqLwoKICBmdW5jdGlvbiBwb3NpdGlvbigpIHsKICAgIHZhciBzdGFydCA9IHsgbGluZTogbGluZW5vLCBjb2x1bW46IGNvbHVtbiB9OwogICAgaWYgKCFvcHRpb25zLnBvc2l0aW9uKSByZXR1cm4gcG9zaXRpb25Ob29wOwoKICAgIHJldHVybiBmdW5jdGlvbihub2RlKXsKICAgICAgbm9kZS5wb3NpdGlvbiA9IG5ldyBQb3NpdGlvbihzdGFydCk7CiAgICAgIHdoaXRlc3BhY2UoKTsKICAgICAgcmV0dXJuIG5vZGU7CiAgICB9OwogIH0KCiAgLyoqCiAgICogU3RvcmUgcG9zaXRpb24gaW5mb3JtYXRpb24gZm9yIGEgbm9kZQogICAqLwoKICBmdW5jdGlvbiBQb3NpdGlvbihzdGFydCkgewogICAgdGhpcy5zdGFydCA9IHN0YXJ0OwogICAgdGhpcy5lbmQgPSB7IGxpbmU6IGxpbmVubywgY29sdW1uOiBjb2x1bW4gfTsKICAgIHRoaXMuc291cmNlID0gb3B0aW9ucy5zb3VyY2U7CiAgfQoKICAvKioKICAgKiBOb24tZW51bWVyYWJsZSBzb3VyY2Ugc3RyaW5nCiAgICovCgogIFBvc2l0aW9uLnByb3RvdHlwZS5jb250ZW50ID0gY3NzOwoKICAvKioKICAgKiBSZXR1cm4gYG5vZGVgLgogICAqLwoKICBmdW5jdGlvbiBwb3NpdGlvbk5vb3Aobm9kZSkgewogICAgd2hpdGVzcGFjZSgpOwogICAgcmV0dXJuIG5vZGU7CiAgfQoKICAvKioKICAgKiBFcnJvciBgbXNnYC4KICAgKi8KCiAgZnVuY3Rpb24gZXJyb3IobXNnKSB7CiAgICB2YXIgZXJyID0gbmV3IEVycm9yKG1zZyArICcgbmVhciBsaW5lICcgKyBsaW5lbm8gKyAnOicgKyBjb2x1bW4pOwogICAgZXJyLmZpbGVuYW1lID0gb3B0aW9ucy5zb3VyY2U7CiAgICBlcnIubGluZSA9IGxpbmVubzsKICAgIGVyci5jb2x1bW4gPSBjb2x1bW47CiAgICBlcnIuc291cmNlID0gY3NzOwogICAgdGhyb3cgZXJyOwogIH0KCiAgLyoqCiAgICogUGFyc2Ugc3R5bGVzaGVldC4KICAgKi8KCiAgZnVuY3Rpb24gc3R5bGVzaGVldCgpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICdzdHlsZXNoZWV0JywKICAgICAgc3R5bGVzaGVldDogewogICAgICAgIHJ1bGVzOiBydWxlcygpCiAgICAgIH0KICAgIH07CiAgfQoKICAvKioKICAgKiBPcGVuaW5nIGJyYWNlLgogICAqLwoKICBmdW5jdGlvbiBvcGVuKCkgewogICAgcmV0dXJuIG1hdGNoKC9ee1xzKi8pOwogIH0KCiAgLyoqCiAgICogQ2xvc2luZyBicmFjZS4KICAgKi8KCiAgZnVuY3Rpb24gY2xvc2UoKSB7CiAgICByZXR1cm4gbWF0Y2goL159Lyk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBydWxlc2V0LgogICAqLwoKICBmdW5jdGlvbiBydWxlcygpIHsKICAgIHZhciBub2RlOwogICAgdmFyIHJ1bGVzID0gW107CiAgICB3aGl0ZXNwYWNlKCk7CiAgICBjb21tZW50cyhydWxlcyk7CiAgICB3aGlsZSAoY3NzLmxlbmd0aCAmJiBjc3MuY2hhckF0KDApICE9ICd9JyAmJiAobm9kZSA9IGF0cnVsZSgpIHx8IHJ1bGUoKSkpIHsKICAgICAgcnVsZXMucHVzaChub2RlKTsKICAgICAgY29tbWVudHMocnVsZXMpOwogICAgfQogICAgcmV0dXJuIHJ1bGVzOwogIH0KCiAgLyoqCiAgICogTWF0Y2ggYHJlYCBhbmQgcmV0dXJuIGNhcHR1cmVzLgogICAqLwoKICBmdW5jdGlvbiBtYXRjaChyZSkgewogICAgdmFyIG0gPSByZS5leGVjKGNzcyk7CiAgICBpZiAoIW0pIHJldHVybjsKICAgIHZhciBzdHIgPSBtWzBdOwogICAgdXBkYXRlUG9zaXRpb24oc3RyKTsKICAgIGNzcyA9IGNzcy5zbGljZShzdHIubGVuZ3RoKTsKICAgIHJldHVybiBtOwogIH0KCiAgLyoqCiAgICogUGFyc2Ugd2hpdGVzcGFjZS4KICAgKi8KCiAgZnVuY3Rpb24gd2hpdGVzcGFjZSgpIHsKICAgIG1hdGNoKC9eXHMqLyk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBjb21tZW50czsKICAgKi8KCiAgZnVuY3Rpb24gY29tbWVudHMocnVsZXMpIHsKICAgIHZhciBjOwogICAgcnVsZXMgPSBydWxlcyB8fCBbXTsKICAgIHdoaWxlIChjID0gY29tbWVudCgpKSBydWxlcy5wdXNoKGMpOwogICAgcmV0dXJuIHJ1bGVzOwogIH0KCiAgLyoqCiAgICogUGFyc2UgY29tbWVudC4KICAgKi8KCiAgZnVuY3Rpb24gY29tbWVudCgpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgaWYgKCcvJyAhPSBjc3MuY2hhckF0KDApIHx8ICcqJyAhPSBjc3MuY2hhckF0KDEpKSByZXR1cm47CgogICAgdmFyIGkgPSAyOwogICAgd2hpbGUgKCIiICE9IGNzcy5jaGFyQXQoaSkgJiYgKCcqJyAhPSBjc3MuY2hhckF0KGkpIHx8ICcvJyAhPSBjc3MuY2hhckF0KGkgKyAxKSkpICsraTsKICAgIGkgKz0gMjsKCiAgICBpZiAoIiIgPT09IGNzcy5jaGFyQXQoaS0xKSkgewogICAgICByZXR1cm4gZXJyb3IoJ0VuZCBvZiBjb21tZW50IG1pc3NpbmcnKTsKICAgIH0KCiAgICB2YXIgc3RyID0gY3NzLnNsaWNlKDIsIGkgLSAyKTsKICAgIGNvbHVtbiArPSAyOwogICAgdXBkYXRlUG9zaXRpb24oc3RyKTsKICAgIGNzcyA9IGNzcy5zbGljZShpKTsKICAgIGNvbHVtbiArPSAyOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAnY29tbWVudCcsCiAgICAgIGNvbW1lbnQ6IHN0cgogICAgfSk7CiAgfQoKICAvKioKICAgKiBQYXJzZSBzZWxlY3Rvci4KICAgKi8KCiAgZnVuY3Rpb24gc2VsZWN0b3IoKSB7CiAgICB2YXIgbSA9IG1hdGNoKC9eKFtee10rKS8pOwogICAgaWYgKCFtKSByZXR1cm47CiAgICAvKiBAZml4IFJlbW92ZSBhbGwgY29tbWVudHMgZnJvbSBzZWxlY3RvcnMKICAgICAqIGh0dHA6Ly9vc3Rlcm1pbGxlci5vcmcvZmluZGNvbW1lbnQuaHRtbCAqLwogICAgcmV0dXJuIHRyaW0obVswXSkucmVwbGFjZSgvXC9cKihbXipdfFtcclxuXXwoXCorKFteKi9dfFtcclxuXSkpKSpcKlwvKy9nLCAnJykuc3BsaXQoL1xzKixccyovKTsKICB9CgogIC8qKgogICAqIFBhcnNlIGRlY2xhcmF0aW9uLgogICAqLwoKICBmdW5jdGlvbiBkZWNsYXJhdGlvbigpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwoKICAgIC8vIHByb3AKICAgIHZhciBwcm9wID0gbWF0Y2goL14oXCo/Wy0jXC9cKlx3XSsoXFtbMC05YS16Xy1dK1xdKT8pXHMqLyk7CiAgICBpZiAoIXByb3ApIHJldHVybjsKICAgIHByb3AgPSB0cmltKHByb3BbMF0pOwoKICAgIC8vIDoKICAgIGlmICghbWF0Y2goL146XHMqLykpIHJldHVybiBlcnJvcigicHJvcGVydHkgbWlzc2luZyAnOiciKTsKCiAgICAvLyB2YWwKICAgIHZhciB2YWwgPSBtYXRjaCgvXigoPzonKD86XFwnfC4pKj8nfCIoPzpcXCJ8LikqPyJ8XChbXlwpXSo/XCl8W159O10pKykvKTsKICAgIGlmICghdmFsKSByZXR1cm4gZXJyb3IoJ3Byb3BlcnR5IG1pc3NpbmcgdmFsdWUnKTsKCiAgICB2YXIgcmV0ID0gcG9zKHsKICAgICAgdHlwZTogJ2RlY2xhcmF0aW9uJywKICAgICAgcHJvcGVydHk6IHByb3AucmVwbGFjZShjb21tZW50cmUsICcnKSwKICAgICAgdmFsdWU6IHRyaW0odmFsWzBdKS5yZXBsYWNlKGNvbW1lbnRyZSwgJycpCiAgICB9KTsKCiAgICAvLyA7CiAgICBtYXRjaCgvXls7XHNdKi8pOwoKICAgIHJldHVybiByZXQ7CiAgfQoKICAvKioKICAgKiBQYXJzZSBkZWNsYXJhdGlvbnMuCiAgICovCgogIGZ1bmN0aW9uIGRlY2xhcmF0aW9ucygpIHsKICAgIHZhciBkZWNscyA9IFtdOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIm1pc3NpbmcgJ3snIik7CiAgICBjb21tZW50cyhkZWNscyk7CgogICAgLy8gZGVjbGFyYXRpb25zCiAgICB2YXIgZGVjbDsKICAgIHdoaWxlIChkZWNsID0gZGVjbGFyYXRpb24oKSkgewogICAgICBkZWNscy5wdXNoKGRlY2wpOwogICAgICBjb21tZW50cyhkZWNscyk7CiAgICB9CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIm1pc3NpbmcgJ30nIik7CiAgICByZXR1cm4gZGVjbHM7CiAgfQoKICAvKioKICAgKiBQYXJzZSBrZXlmcmFtZS4KICAgKi8KCiAgZnVuY3Rpb24ga2V5ZnJhbWUoKSB7CiAgICB2YXIgbTsKICAgIHZhciB2YWxzID0gW107CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKCiAgICB3aGlsZSAobSA9IG1hdGNoKC9eKChcZCtcLlxkK3xcLlxkK3xcZCspJT98W2Etel0rKVxzKi8pKSB7CiAgICAgIHZhbHMucHVzaChtWzFdKTsKICAgICAgbWF0Y2goL14sXHMqLyk7CiAgICB9CgogICAgaWYgKCF2YWxzLmxlbmd0aCkgcmV0dXJuOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAna2V5ZnJhbWUnLAogICAgICB2YWx1ZXM6IHZhbHMsCiAgICAgIGRlY2xhcmF0aW9uczogZGVjbGFyYXRpb25zKCkKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2Uga2V5ZnJhbWVzLgogICAqLwoKICBmdW5jdGlvbiBhdGtleWZyYW1lcygpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgdmFyIG0gPSBtYXRjaCgvXkAoWy1cd10rKT9rZXlmcmFtZXMgKi8pOwoKICAgIGlmICghbSkgcmV0dXJuOwogICAgdmFyIHZlbmRvciA9IG1bMV07CgogICAgLy8gaWRlbnRpZmllcgogICAgdmFyIG0gPSBtYXRjaCgvXihbLVx3XSspXHMqLyk7CiAgICBpZiAoIW0pIHJldHVybiBlcnJvcigiQGtleWZyYW1lcyBtaXNzaW5nIG5hbWUiKTsKICAgIHZhciBuYW1lID0gbVsxXTsKCiAgICBpZiAoIW9wZW4oKSkgcmV0dXJuIGVycm9yKCJAa2V5ZnJhbWVzIG1pc3NpbmcgJ3snIik7CgogICAgdmFyIGZyYW1lOwogICAgdmFyIGZyYW1lcyA9IGNvbW1lbnRzKCk7CiAgICB3aGlsZSAoZnJhbWUgPSBrZXlmcmFtZSgpKSB7CiAgICAgIGZyYW1lcy5wdXNoKGZyYW1lKTsKICAgICAgZnJhbWVzID0gZnJhbWVzLmNvbmNhdChjb21tZW50cygpKTsKICAgIH0KCiAgICBpZiAoIWNsb3NlKCkpIHJldHVybiBlcnJvcigiQGtleWZyYW1lcyBtaXNzaW5nICd9JyIpOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAna2V5ZnJhbWVzJywKICAgICAgbmFtZTogbmFtZSwKICAgICAgdmVuZG9yOiB2ZW5kb3IsCiAgICAgIGtleWZyYW1lczogZnJhbWVzCiAgICB9KTsKICB9CgogIC8qKgogICAqIFBhcnNlIHN1cHBvcnRzLgogICAqLwoKICBmdW5jdGlvbiBhdHN1cHBvcnRzKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQHN1cHBvcnRzICooW157XSspLyk7CgogICAgaWYgKCFtKSByZXR1cm47CiAgICB2YXIgc3VwcG9ydHMgPSB0cmltKG1bMV0pOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIkBzdXBwb3J0cyBtaXNzaW5nICd7JyIpOwoKICAgIHZhciBzdHlsZSA9IGNvbW1lbnRzKCkuY29uY2F0KHJ1bGVzKCkpOwoKICAgIGlmICghY2xvc2UoKSkgcmV0dXJuIGVycm9yKCJAc3VwcG9ydHMgbWlzc2luZyAnfSciKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ3N1cHBvcnRzJywKICAgICAgc3VwcG9ydHM6IHN1cHBvcnRzLAogICAgICBydWxlczogc3R5bGUKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgaG9zdC4KICAgKi8KCiAgZnVuY3Rpb24gYXRob3N0KCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQGhvc3QgKi8pOwoKICAgIGlmICghbSkgcmV0dXJuOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIkBob3N0IG1pc3NpbmcgJ3snIik7CgogICAgdmFyIHN0eWxlID0gY29tbWVudHMoKS5jb25jYXQocnVsZXMoKSk7CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBob3N0IG1pc3NpbmcgJ30nIik7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdob3N0JywKICAgICAgcnVsZXM6IHN0eWxlCiAgICB9KTsKICB9CgogIC8qKgogICAqIFBhcnNlIG1lZGlhLgogICAqLwoKICBmdW5jdGlvbiBhdG1lZGlhKCkgewogICAgdmFyIHBvcyA9IHBvc2l0aW9uKCk7CiAgICB2YXIgbSA9IG1hdGNoKC9eQG1lZGlhICooW157XSspLyk7CgogICAgaWYgKCFtKSByZXR1cm47CiAgICB2YXIgbWVkaWEgPSB0cmltKG1bMV0pOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIkBtZWRpYSBtaXNzaW5nICd7JyIpOwoKICAgIHZhciBzdHlsZSA9IGNvbW1lbnRzKCkuY29uY2F0KHJ1bGVzKCkpOwoKICAgIGlmICghY2xvc2UoKSkgcmV0dXJuIGVycm9yKCJAbWVkaWEgbWlzc2luZyAnfSciKTsKCiAgICByZXR1cm4gcG9zKHsKICAgICAgdHlwZTogJ21lZGlhJywKICAgICAgbWVkaWE6IG1lZGlhLAogICAgICBydWxlczogc3R5bGUKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgcGFnZWQgbWVkaWEuCiAgICovCgogIGZ1bmN0aW9uIGF0cGFnZSgpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgdmFyIG0gPSBtYXRjaCgvXkBwYWdlICovKTsKICAgIGlmICghbSkgcmV0dXJuOwoKICAgIHZhciBzZWwgPSBzZWxlY3RvcigpIHx8IFtdOwoKICAgIGlmICghb3BlbigpKSByZXR1cm4gZXJyb3IoIkBwYWdlIG1pc3NpbmcgJ3snIik7CiAgICB2YXIgZGVjbHMgPSBjb21tZW50cygpOwoKICAgIC8vIGRlY2xhcmF0aW9ucwogICAgdmFyIGRlY2w7CiAgICB3aGlsZSAoZGVjbCA9IGRlY2xhcmF0aW9uKCkpIHsKICAgICAgZGVjbHMucHVzaChkZWNsKTsKICAgICAgZGVjbHMgPSBkZWNscy5jb25jYXQoY29tbWVudHMoKSk7CiAgICB9CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBwYWdlIG1pc3NpbmcgJ30nIik7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdwYWdlJywKICAgICAgc2VsZWN0b3JzOiBzZWwsCiAgICAgIGRlY2xhcmF0aW9uczogZGVjbHMKICAgIH0pOwogIH0KCiAgLyoqCiAgICogUGFyc2UgZG9jdW1lbnQuCiAgICovCgogIGZ1bmN0aW9uIGF0ZG9jdW1lbnQoKSB7CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKICAgIHZhciBtID0gbWF0Y2goL15AKFstXHddKyk/ZG9jdW1lbnQgKihbXntdKykvKTsKICAgIGlmICghbSkgcmV0dXJuOwoKICAgIHZhciB2ZW5kb3IgPSB0cmltKG1bMV0pOwogICAgdmFyIGRvYyA9IHRyaW0obVsyXSk7CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQGRvY3VtZW50IG1pc3NpbmcgJ3snIik7CgogICAgdmFyIHN0eWxlID0gY29tbWVudHMoKS5jb25jYXQocnVsZXMoKSk7CgogICAgaWYgKCFjbG9zZSgpKSByZXR1cm4gZXJyb3IoIkBkb2N1bWVudCBtaXNzaW5nICd9JyIpOwoKICAgIHJldHVybiBwb3MoewogICAgICB0eXBlOiAnZG9jdW1lbnQnLAogICAgICBkb2N1bWVudDogZG9jLAogICAgICB2ZW5kb3I6IHZlbmRvciwKICAgICAgcnVsZXM6IHN0eWxlCiAgICB9KTsKICB9CgogIC8qKgogICAqIFBhcnNlIGZvbnQtZmFjZS4KICAgKi8KCiAgZnVuY3Rpb24gYXRmb250ZmFjZSgpIHsKICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgdmFyIG0gPSBtYXRjaCgvXkBmb250LWZhY2UgKi8pOwogICAgaWYgKCFtKSByZXR1cm47CgogICAgaWYgKCFvcGVuKCkpIHJldHVybiBlcnJvcigiQGZvbnQtZmFjZSBtaXNzaW5nICd7JyIpOwogICAgdmFyIGRlY2xzID0gY29tbWVudHMoKTsKCiAgICAvLyBkZWNsYXJhdGlvbnMKICAgIHZhciBkZWNsOwogICAgd2hpbGUgKGRlY2wgPSBkZWNsYXJhdGlvbigpKSB7CiAgICAgIGRlY2xzLnB1c2goZGVjbCk7CiAgICAgIGRlY2xzID0gZGVjbHMuY29uY2F0KGNvbW1lbnRzKCkpOwogICAgfQoKICAgIGlmICghY2xvc2UoKSkgcmV0dXJuIGVycm9yKCJAZm9udC1mYWNlIG1pc3NpbmcgJ30nIik7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdmb250LWZhY2UnLAogICAgICBkZWNsYXJhdGlvbnM6IGRlY2xzCiAgICB9KTsKICB9CgogIC8qKgogICAqIFBhcnNlIGltcG9ydAogICAqLwoKICB2YXIgYXRpbXBvcnQgPSBfY29tcGlsZUF0cnVsZSgnaW1wb3J0Jyk7CgogIC8qKgogICAqIFBhcnNlIGNoYXJzZXQKICAgKi8KCiAgdmFyIGF0Y2hhcnNldCA9IF9jb21waWxlQXRydWxlKCdjaGFyc2V0Jyk7CgogIC8qKgogICAqIFBhcnNlIG5hbWVzcGFjZQogICAqLwoKICB2YXIgYXRuYW1lc3BhY2UgPSBfY29tcGlsZUF0cnVsZSgnbmFtZXNwYWNlJyk7CgogIC8qKgogICAqIFBhcnNlIG5vbi1ibG9jayBhdC1ydWxlcwogICAqLwoKCiAgZnVuY3Rpb24gX2NvbXBpbGVBdHJ1bGUobmFtZSkgewogICAgdmFyIHJlID0gbmV3IFJlZ0V4cCgnXkAnICsgbmFtZSArICcgKihbXjtcXG5dKyk7Jyk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBwb3MgPSBwb3NpdGlvbigpOwogICAgICB2YXIgbSA9IG1hdGNoKHJlKTsKICAgICAgaWYgKCFtKSByZXR1cm47CiAgICAgIHZhciByZXQgPSB7IHR5cGU6IG5hbWUgfTsKICAgICAgcmV0W25hbWVdID0gbVsxXS50cmltKCk7CiAgICAgIHJldHVybiBwb3MocmV0KTsKICAgIH0KICB9CgogIC8qKgogICAqIFBhcnNlIGF0IHJ1bGUuCiAgICovCgogIGZ1bmN0aW9uIGF0cnVsZSgpIHsKICAgIGlmIChjc3NbMF0gIT0gJ0AnKSByZXR1cm47CgogICAgcmV0dXJuIGF0a2V5ZnJhbWVzKCkKICAgICAgfHwgYXRtZWRpYSgpCiAgICAgIHx8IGF0c3VwcG9ydHMoKQogICAgICB8fCBhdGltcG9ydCgpCiAgICAgIHx8IGF0Y2hhcnNldCgpCiAgICAgIHx8IGF0bmFtZXNwYWNlKCkKICAgICAgfHwgYXRkb2N1bWVudCgpCiAgICAgIHx8IGF0cGFnZSgpCiAgICAgIHx8IGF0aG9zdCgpCiAgICAgIHx8IGF0Zm9udGZhY2UoKTsKICB9CgogIC8qKgogICAqIFBhcnNlIHJ1bGUuCiAgICovCgogIGZ1bmN0aW9uIHJ1bGUoKSB7CiAgICB2YXIgcG9zID0gcG9zaXRpb24oKTsKICAgIHZhciBzZWwgPSBzZWxlY3RvcigpOwoKICAgIGlmICghc2VsKSByZXR1cm4gZXJyb3IoJ3NlbGVjdG9yIG1pc3NpbmcnKTsKICAgIGNvbW1lbnRzKCk7CgogICAgcmV0dXJuIHBvcyh7CiAgICAgIHR5cGU6ICdydWxlJywKICAgICAgc2VsZWN0b3JzOiBzZWwsCiAgICAgIGRlY2xhcmF0aW9uczogZGVjbGFyYXRpb25zKCkKICAgIH0pOwogIH0KCiAgcmV0dXJuIHN0eWxlc2hlZXQoKTsKfTsKCi8qKgogKiBUcmltIGBzdHJgLgogKi8KCmZ1bmN0aW9uIHRyaW0oc3RyKSB7CiAgcmV0dXJuIHN0ciA/IHN0ci5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpIDogJyc7Cn0KbGliLmhlbHBlcnMuQ2xvbmUgPSBmdW5jdGlvbiBjbG9uZShpdGVtKSB7CiAgICBpZiAoIWl0ZW0pIHsgcmV0dXJuIGl0ZW07IH0gLy8gbnVsbCwgdW5kZWZpbmVkIHZhbHVlcyBjaGVjawoKICAgIHZhciB0eXBlcyA9IFsgTnVtYmVyLCBTdHJpbmcsIEJvb2xlYW4gXSwgCiAgICAgICAgcmVzdWx0OwoKICAgIC8vIG5vcm1hbGl6aW5nIHByaW1pdGl2ZXMgaWYgc29tZW9uZSBkaWQgbmV3IFN0cmluZygnYWFhJyksIG9yIG5ldyBOdW1iZXIoJzQ0NCcpOwogICAgZm9yKHZhciBpPTA7IGk8dHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdHlwZSA9IHR5cGVzW2ldOwogICAgICAgIGlmKGl0ZW0gaW5zdGFuY2VvZiB0eXBlKSB7CiAgICAgICAgICAgIHJlc3VsdCA9IHR5cGUoIGl0ZW0gKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHR5cGVvZiByZXN1bHQgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBpdGVtICkgPT09ICJbb2JqZWN0IEFycmF5XSIpIHsKICAgICAgICAgICAgcmVzdWx0ID0gW107CiAgICAgICAgICAgIGl0ZW0uZm9yRWFjaChmdW5jdGlvbihjaGlsZCwgaW5kZXgsIGFycmF5KSB7IAogICAgICAgICAgICAgICAgcmVzdWx0W2luZGV4XSA9IGNsb25lKCBjaGlsZCApOwogICAgICAgICAgICB9KTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpdGVtID09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIC8vIHRlc3RpbmcgdGhhdCB0aGlzIGlzIERPTQogICAgICAgICAgICBpZiAoaXRlbS5ub2RlVHlwZSAmJiB0eXBlb2YgaXRlbS5jbG9uZU5vZGUgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGl0ZW0uY2xvbmVOb2RlKCB0cnVlICk7ICAgIAogICAgICAgICAgICB9IGVsc2UgaWYgKCFpdGVtLnByb3RvdHlwZSkgeyAvLyBjaGVjayB0aGF0IHRoaXMgaXMgYSBsaXRlcmFsCiAgICAgICAgICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBuZXcgRGF0ZShpdGVtKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gaXQgaXMgYW4gb2JqZWN0IGxpdGVyYWwKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSB7fTsKICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmUoIGl0ZW1baV0gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBkZXBlbmRpbmcgd2hhdCB5b3Ugd291bGQgbGlrZSBoZXJlLAogICAgICAgICAgICAgICAgLy8ganVzdCBrZWVwIHRoZSByZWZlcmVuY2UsIG9yIGNyZWF0ZSBuZXcgb2JqZWN0CiAgICAgICAgICAgICAgICBpZiAoZmFsc2UgJiYgaXRlbS5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIC8vIHdvdWxkIG5vdCBhZHZpY2UgdG8gZG8gdGhhdCwgcmVhc29uPyBSZWFkIGJlbG93CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gbmV3IGl0ZW0uY29uc3RydWN0b3IoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0gaXRlbTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGl0ZW07CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiByZXN1bHQ7Cn0KLy8gY3JlZGl0czogaHR0cDovL3d3dy5zaXRlcG9pbnQuY29tL2phdmFzY3JpcHQtZ2VuZXJhdGUtbGlnaHRlci1kYXJrZXItY29sb3IvCmxpYi5oZWxwZXJzLkNvbG9yTHVtaW5hbmNlID0gZnVuY3Rpb24gKGhleCwgbHVtKSB7CgoJLy8gdmFsaWRhdGUgaGV4IHN0cmluZwoJaGV4ID0gU3RyaW5nKGhleCkucmVwbGFjZSgvW14wLTlhLWZdL2dpLCAnJyk7CglpZiAoaGV4Lmxlbmd0aCA8IDYpIHsKCQloZXggPSBoZXhbMF0raGV4WzBdK2hleFsxXStoZXhbMV0raGV4WzJdK2hleFsyXTsKCX0KCWx1bSA9IGx1bSB8fCAwOwoKCS8vIGNvbnZlcnQgdG8gZGVjaW1hbCBhbmQgY2hhbmdlIGx1bWlub3NpdHkKCXZhciByZ2IgPSAiIyIsIGMsIGk7Cglmb3IgKGkgPSAwOyBpIDwgMzsgaSsrKSB7CgkJYyA9IHBhcnNlSW50KGhleC5zdWJzdHIoaSoyLDIpLCAxNik7CgkJYyA9IE1hdGgucm91bmQoTWF0aC5taW4oTWF0aC5tYXgoMCwgYyArIChjICogbHVtKSksIDI1NSkpLnRvU3RyaW5nKDE2KTsKCQlyZ2IgKz0gKCIwMCIrYykuc3Vic3RyKGMubGVuZ3RoKTsKCX0KCglyZXR1cm4gcmdiOwp9CmxpYi5oZWxwZXJzLkV4dGVuZCA9IGZ1bmN0aW9uKCkgewoJdmFyIHByb2Nlc3MgPSBmdW5jdGlvbihkZXN0aW5hdGlvbiwgc291cmNlKSB7CQoJICAgIGZvcih2YXIga2V5IGluIHNvdXJjZSkgewoJCQlpZihPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoc291cmNlLCBrZXkpKSB7CgkJCSAgICBkZXN0aW5hdGlvbltrZXldID0gc291cmNlW2tleV07CgkJCX0KCSAgICB9CgkgICAgcmV0dXJuIGRlc3RpbmF0aW9uOwoJfTsKCXZhciByZXN1bHQgPSBhcmd1bWVudHNbMF07Cglmb3IodmFyIGk9MTsgaTxhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQlyZXN1bHQgPSBwcm9jZXNzKHJlc3VsdCwgYXJndW1lbnRzW2ldKTsKCX0KCXJldHVybiByZXN1bHQ7Cn0KLy8gaHR0cDovL2RvY3MuZW1tZXQuaW8vY3NzLWFiYnJldmlhdGlvbnMvdmVuZG9yLXByZWZpeGVzLyAodzogd2Via2l0LCBtOiBtb3osIHM6IG1zLCBvOiBvKQp2YXIgcHJlZml4RXh0cmFjdCA9IGZ1bmN0aW9uKHByb3ApIHsKCXZhciByZXN1bHQsIG1hdGNoOwoJaWYoKG1hdGNoID0gcHJvcC5tYXRjaCgvXlwtKHd8bXxzfG8pK1wtLykgfHwgcHJvcC5jaGFyQXQoMCkgPT09ICctJykgJiYgIXByb3AubWF0Y2goL15cLSh3ZWJraXR8bW96fG1zKStcLS8pKSB7CgkJaWYobWF0Y2ggIT09IG51bGwgJiYgbWF0Y2hbMF0pIHsKCQkJcmVzdWx0ID0geyBwcmVmaXg6IG1hdGNoWzBdLnJlcGxhY2UoLy0vZywgJycpIH0KCQkJcmVzdWx0LnByb3AgPSBwcm9wLnJlcGxhY2UobWF0Y2hbMF0sICcnKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSB7IHByZWZpeDogJycgfQoJCQlyZXN1bHQucHJvcCA9IHByb3Auc3Vic3RyKDEsIHByb3AubGVuZ3RoKTsKCQl9Cgl9IGVsc2UgewoJCXJlc3VsdCA9IHsKCQkJcHJlZml4OiBmYWxzZSwKCQkJcHJvcDogcHJvcAoJCX0KCX0KCXJldHVybiByZXN1bHQ7Cn0KbGliLmhlbHBlcnMuUHJlZml4ZXMgPSB7CglhZGRQcmVmaXhlczogZnVuY3Rpb24ocHJvcCwgb2JqKSB7CgkJdmFyIG9yaWdpbmFsUHJvcCA9IHByb3AsIHAgPSBwcmVmaXhFeHRyYWN0KHByb3ApLCB2YWx1ZSA9IG9ialtwcm9wXTsKCQlpZihwLnByZWZpeCAhPT0gZmFsc2UpIHsKCQkJZGVsZXRlIG9ialtvcmlnaW5hbFByb3BdOwoJCQlvYmpbcC5wcm9wXSA9IHZhbHVlOwoJCQlpZihwLnByZWZpeCA9PT0gJycgfHwgcC5wcmVmaXguaW5kZXhPZigndycpID49IDApCgkJCQlvYmpbJy13ZWJraXQtJyArIHAucHJvcF0gPSB2YWx1ZTsKCQkJaWYocC5wcmVmaXggPT09ICcnIHx8IHAucHJlZml4LmluZGV4T2YoJ20nKSA+PSAwKQoJCQkJb2JqWyctbW96LScgKyBwLnByb3BdID0gdmFsdWU7CgkJCWlmKHAucHJlZml4ID09PSAnJyB8fCBwLnByZWZpeC5pbmRleE9mKCdzJykgPj0gMCkKCQkJCW9ialsnLW1zLScgKyBwLnByb3BdID0gdmFsdWU7CgkJCWlmKHAucHJlZml4ID09PSAnJyB8fCBwLnByZWZpeC5pbmRleE9mKCdvJykgPj0gMCkKCQkJCW9ialsnLW8tJyArIHAucHJvcF0gPSB2YWx1ZTsKCQl9Cgl9LAoJbm9uUHJlZml4UHJvcDogZnVuY3Rpb24ocHJvcCkgewoJCXZhciBwID0gcHJlZml4RXh0cmFjdChwcm9wKTsKCQlpZihwLnByZWZpeCAhPT0gZmFsc2UpIHsKCQkJaWYocC5wcmVmaXggPT0gJycpIHsgCgkJCQlwLnByZWZpeCA9ICctJzsKCQkJfSBlbHNlIHsKCQkJCXAucHJlZml4ID0gJy0nICsgcC5wcmVmaXggKyAnLSc7IAoJCQl9CgkJfQoJCXJldHVybiBwOwoJfQp9CmxpYi5oZWxwZXJzLlJlcXVpcmVVbmNhY2hlZCA9IGZ1bmN0aW9uKG1vZHVsZSkgewoJZGVsZXRlIHJlcXVpcmUuY2FjaGVbcmVxdWlyZS5yZXNvbHZlKG1vZHVsZSldCiAgICByZXR1cm4gcmVxdWlyZShtb2R1bGUpOwp9CmxpYi5oZWxwZXJzLlRyYW5zZm9ybVVwcGVyY2FzZSA9IGZ1bmN0aW9uKHByb3AsIG9wdGlvbnMpIHsKCXZhciB0cmFuc2Zvcm1lZCA9ICIiOwoJZm9yKHZhciBpPTA7IGM9cHJvcC5jaGFyQXQoaSk7IGkrKykgewoJCWlmKGMgPT09IGMudG9VcHBlckNhc2UoKSAmJiBjLnRvTG93ZXJDYXNlKCkgIT09IGMudG9VcHBlckNhc2UoKSkgewoJCQl0cmFuc2Zvcm1lZCArPSAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJfSBlbHNlIHsKCQkJdHJhbnNmb3JtZWQgKz0gYzsKCQl9Cgl9CglyZXR1cm4gdHJhbnNmb3JtZWQ7Cn0KdmFyIGNvbXBpbGVDb21wb25lbnQgPSBmdW5jdGlvbihpbnB1dCwgY2FsbGJhY2ssIG9wdGlvbnMpIHsKCgl2YXIgY3NzID0gIiIsIAoJCWh0bWwgPSAiIiwgCgkJYWxsID0gW10sCgkJYXBpID0gb3B0aW9ucy5hcGk7CgkJY3NzUHJlcHJvY2Vzc29yID0gcmVxdWlyZShfX2Rpcm5hbWUgKyAiLy4uL2Nzcy9DU1MuanMiKSgpLAoJCWh0bWxQcmVwcm9jZXNzb3IgPSByZXF1aXJlKF9fZGlybmFtZSArICIvLi4vaHRtbC9IVE1MLmpzIikoKTsKCgl2YXIgcHJvY2Vzc0NTUyA9IGZ1bmN0aW9uKGNsYikgewoJCWZvcih2YXIgaT0wOyBpPGFsbC5sZW5ndGgsIGNvbXBvbmVudD1hbGxbaV07IGkrKykgewoJCQlpZih0eXBlb2YgY29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7IGNvbXBvbmVudCA9IGNvbXBvbmVudCgpOyB9CgkJCWFwaS5hZGQoY29tcG9uZW50LmNzcyA/IGNvbXBvbmVudC5jc3MgOiB7fSk7CgkJfQoJCWNzc1ByZXByb2Nlc3NvcihhcGkuZ2V0UnVsZXMoKSwgZnVuY3Rpb24oZXJyLCByZXN1bHQpIHsKCQkJY3NzICs9IHJlc3VsdDsKCQkJY2xiKGVycik7CgkJfSwgb3B0aW9ucyk7Cgl9Cgl2YXIgcHJvY2Vzc0hUTUwgPSBmdW5jdGlvbihjbGIpIHsKCQl2YXIgaW5kZXggPSAwOwoJCXZhciBlcnJvciA9IG51bGw7CgkJdmFyIHByb2Nlc3NDb21wb25lbnQgPSBmdW5jdGlvbigpIHsKCQkJaWYoaW5kZXggPiBpbnB1dC5sZW5ndGgtMSkgewoJCQkJY2xiKGVycm9yKTsKCQkJCXJldHVybjsKCQkJfQoJCQl2YXIgYyA9IGlucHV0W2luZGV4XTsKCQkJaWYodHlwZW9mIGMgPT09ICJmdW5jdGlvbiIpIHsgYyA9IGMoKTsgfQoJCQlhcGkubW9ycGgoImh0bWwiKS5hZGQoYy5odG1sID8gYy5odG1sIDoge30pOwoJCQlodG1sUHJlcHJvY2Vzc29yKGFwaS5nZXRSdWxlcygpLCBmdW5jdGlvbihlcnIsIHJlc3VsdCkgewoJCQkJaHRtbCArPSByZXN1bHQ7CgkJCQlpbmRleCArPSAxOwoJCQkJZXJyb3IgPSBlcnI7CgkJCQlwcm9jZXNzQ29tcG9uZW50KCk7CgkJCX0sIG9wdGlvbnMpOwoJCX0KCQlwcm9jZXNzQ29tcG9uZW50KCk7Cgl9Cgl2YXIgY2hlY2tGb3JOZXN0aW5nID0gZnVuY3Rpb24obykgewoJCWZvcih2YXIga2V5IGluIG8pIHsKCQkJaWYoa2V5ID09PSAiX2luY2x1ZGUiKSB7CgkJCQlpZihvW2tleV0gaW5zdGFuY2VvZiBBcnJheSkgewoJCQkJCWZvcih2YXIgaT0wOyBpPG9ba2V5XS5sZW5ndGgsIGM9b1trZXldW2ldOyBpKyspIHsKCQkJCQkJaWYodHlwZW9mIGMgPT09ICJmdW5jdGlvbiIpIHsgYyA9IGMoKTsgfQoJCQkJCQlhbGwucHVzaChjKTsKCQkJCQkJY2hlY2tGb3JOZXN0aW5nKGMpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJaWYodHlwZW9mIG9ba2V5XSA9PT0gImZ1bmN0aW9uIikgeyBvW2tleV0gPSBvW2tleV0oKTsgfQoJCQkJCWFsbC5wdXNoKG9ba2V5XSk7CgkJCQkJY2hlY2tGb3JOZXN0aW5nKG9ba2V5XSk7CgkJCQl9CgkJCX0gZWxzZSBpZih0eXBlb2Ygb1trZXldID09PSAib2JqZWN0IikgewoJCQkJY2hlY2tGb3JOZXN0aW5nKG9ba2V5XSk7CgkJCX0KCQl9Cgl9CgoJLy8gQ2hlY2tpbmcgZm9yIG5lc3RpbmcuIEkuZS4gY29sbGVjdGluZyB0aGUgY3NzIGFuZCBodG1sLgoJZm9yKHZhciBpPTA7IGk8aW5wdXQubGVuZ3RoLCBjPWlucHV0W2ldOyBpKyspIHsKCQlpZih0eXBlb2YgYyA9PT0gImZ1bmN0aW9uIikgeyBjID0gYygpOyB9CgkJYWxsLnB1c2goYyk7CgkJY2hlY2tGb3JOZXN0aW5nKGMpOwoJfQoKCWFwaS5mbHVzaCgpOwoJcHJvY2Vzc0NTUyhmdW5jdGlvbihlcnJDU1MpIHsKCQlhcGkubW9ycGgoImh0bWwiKTsKCQlwcm9jZXNzSFRNTChmdW5jdGlvbihlcnJIVE1MKSB7CgkJCWNhbGxiYWNrKAoJCQkJZXJyQ1NTIHx8IGVyckhUTUwgPyB7ZXJyb3I6IHtjc3M6IGVyckNTUywgaHRtbDogZXJySFRNTCB9fSA6IG51bGwsCgkJCQljc3MsCgkJCQlodG1sCgkJCSkKCQl9KTsKCX0pOwoJCn0KbGliLnByb2Nlc3NvcnMuY29tcG9uZW50LkNvbXBvbmVudCA9IGZ1bmN0aW9uKCkgewoJdmFyIHByb2Nlc3NvciA9IGZ1bmN0aW9uKHJ1bGVzLCBjYWxsYmFjaywgb3B0aW9ucykgewoJCWNvbXBpbGVDb21wb25lbnQocnVsZXMubWFpbnN0cmVhbSwgY2FsbGJhY2ssIG9wdGlvbnMpOwoJfQoJcHJvY2Vzc29yLnR5cGUgPSAiY29tcG9uZW50IjsKCXJldHVybiBwcm9jZXNzb3I7Cn0KdmFyIG5ld2xpbmUgPSAnXG4nLAoJZGVmYXVsdE9wdGlvbnMgPSB7CgkJY29tYmluZVNlbGVjdG9yczogdHJ1ZSwKCQltaW5pZnk6IGZhbHNlLAoJCWtlZXBDYW1lbENhc2U6IGZhbHNlCgl9LAoJdHJhbnNmb3JtVXBwZXJjYXNlID0gcmVxdWlyZSgiLi4vLi4vaGVscGVycy9UcmFuc2Zvcm1VcHBlcmNhc2UiKSwKCWV4dGVuZCA9IHJlcXVpcmUoIi4uLy4uL2hlbHBlcnMvRXh0ZW5kIik7Cgp2YXIgdG9DU1MgPSBmdW5jdGlvbihydWxlcywgb3B0aW9ucywgaW5kZW50KSB7Cgl2YXIgY3NzID0gJyc7CglpbmRlbnQgPSBpbmRlbnQgfHwgWycnLCAnICAnXTsKCWZvcih2YXIgc2VsZWN0b3IgaW4gcnVsZXMpIHsKCQkvLyBoYW5kbGluZyByYXcgY29udGVudAoJCWlmKHNlbGVjdG9yLmluZGV4T2YoIl9fX19yYXciKSA9PT0gMCkgewoJCQljc3MgKz0gcnVsZXNbc2VsZWN0b3JdW3NlbGVjdG9yXSArIG5ld2xpbmU7CgkJLy8gaGFuZGxpbmcgbm9ybWFsIHN0eWxlcwoJCX0gZWxzZSB7CgkJCXZhciBlbnRpdHlTdHlsZSA9IGluZGVudFswXSArIHNlbGVjdG9yLnJlcGxhY2UoL35+KC4rKX5+LywgJycpLnJlcGxhY2UoL14lLio/JS8sICcnKSArICcgeycgKyBuZXdsaW5lOwoJCQl2YXIgZW50aXR5ID0gJyc7CgkJCWZvcih2YXIgcHJvcCBpbiBydWxlc1tzZWxlY3Rvcl0pIHsKCQkJCXZhciB2YWx1ZSA9IHJ1bGVzW3NlbGVjdG9yXVtwcm9wXTsKCQkJCWlmKHZhbHVlID09PSAiIikgewoJCQkJCXZhbHVlID0gJyIiJzsKCQkJCX0KCQkJCXByb3AgPSBwcm9wLnJlcGxhY2UoL35+KC4rKX5+LywgJycpLnJlcGxhY2UoL14lLio/JS8sICcnKTsKCQkJCWlmKG9wdGlvbnMgJiYgb3B0aW9ucy5rZWVwQ2FtZWxDYXNlID09PSB0cnVlKSB7CgkJCQkJZW50aXR5ICs9IGluZGVudFsxXSArIHByb3AgKyAnOiAnICsgdmFsdWUgKyAnOycgKyBuZXdsaW5lOwoJCQkJfSBlbHNlIHsKCQkJCQllbnRpdHkgKz0gaW5kZW50WzFdICsgdHJhbnNmb3JtVXBwZXJjYXNlKHByb3ApICsgJzogJyArIHZhbHVlICsgJzsnICsgbmV3bGluZTsKCQkJCX0KCQkJfQoJCQlpZihlbnRpdHkgIT0gJycpIHsKCQkJCWVudGl0eVN0eWxlICs9IGVudGl0eTsKCQkJCWVudGl0eVN0eWxlICs9IGluZGVudFswXSArICd9JyArIG5ld2xpbmU7CgkJCQljc3MgKz0gZW50aXR5U3R5bGU7CgkJCX0KCQl9Cgl9CglyZXR1cm4gY3NzOwp9Cgp2YXIgdG9KU09OID0gZnVuY3Rpb24ocnVsZXMsIG9wdGlvbnMpIHsKCXZhciByZXN1bHQgPSB7fTsKCWZvcih2YXIgc3R5bGVzaGVldCBpbiBydWxlcykgewoJCXZhciBzdHlsZXMgPSBydWxlc1tzdHlsZXNoZWV0XTsKCQlpZihzdHlsZXNoZWV0ID09ICdtYWluc3RyZWFtJykgewoJCQlmb3IodmFyIHNlbGVjdG9yIGluIHN0eWxlcykgewoJCQkJcmVzdWx0W3NlbGVjdG9yXSA9IHt9CgkJCQlmb3IodmFyIHByb3AgaW4gc3R5bGVzW3NlbGVjdG9yXSkgewoJCQkJCXJlc3VsdFtzZWxlY3Rvcl1bcHJvcF0gPSBzdHlsZXNbc2VsZWN0b3JdW3Byb3BdOwoJCQkJfQoJCQl9CQkJCgkJfSBlbHNlIGlmKHN0eWxlc2hlZXQuaW5kZXhPZignQG1lZGlhJykgPj0gMCkgewoJCQlyZXN1bHRbc3R5bGVzaGVldF0gPSB7fTsKCQkJZm9yKHZhciBzZWxlY3RvciBpbiBzdHlsZXMpIHsKCQkJCXJlc3VsdFtzdHlsZXNoZWV0XVtzZWxlY3Rvcl0gPSB7fQoJCQkJZm9yKHZhciBwcm9wIGluIHN0eWxlc1tzZWxlY3Rvcl0pIHsKCQkJCQlyZXN1bHRbc3R5bGVzaGVldF1bc2VsZWN0b3JdW3Byb3BdID0gc3R5bGVzW3NlbGVjdG9yXVtwcm9wXTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiByZXN1bHQ7Cn0KCi8vIGNvbWJpbmluZyBzZWxlY3RvcnMKdmFyIGNvbWJpbmVTZWxlY3RvcnMgPSBmdW5jdGlvbihydWxlcywgcHJldmVudENvbWJpbmluZykgewoKCXZhciBtYXAgPSBbXSwgYXJyID0ge307Cgl2YXIgcHJldmVudENvbWJpbmluZyA9IFtdLmNvbmNhdChwcmV2ZW50Q29tYmluaW5nIHx8IFtdKTsKCXByZXZlbnRDb21iaW5pbmcuc3BsaWNlKDAsIDAsICcnKTsKCXByZXZlbnRDb21iaW5pbmcgPSBwcmV2ZW50Q29tYmluaW5nLmpvaW4oJ3wnKTsKCgkvLyBleHRyYWN0aW5nIGV2ZXJ5IHByb3BlcnR5Cglmb3IodmFyIHNlbGVjdG9yIGluIHJ1bGVzKSB7CgkJdmFyIHByb3BzID0gcnVsZXNbc2VsZWN0b3JdOwoJCWZvcih2YXIgcHJvcCBpbiBwcm9wcykgewoJCQltYXAucHVzaCh7CgkJCQlzZWxlY3Rvcjogc2VsZWN0b3IsIAoJCQkJcHJvcDogcHJvcCwgCgkJCQl2YWx1ZTogcHJvcHNbcHJvcF0sIAoJCQkJY29tYmluZTogcHJldmVudENvbWJpbmluZy5pbmRleE9mKCd8JyArIHByb3ApIDwgMCAmJiBzZWxlY3Rvci5pbmRleE9mKCdAZm9udC1mYWNlJykgPCAwCgkJCX0pOwoJCX0KCX0KCgkvLyBjb21iaW5pbmcKCWZvcih2YXIgaT0wOyBpPG1hcC5sZW5ndGg7IGkrKykgewoJCWlmKG1hcFtpXS5jb21iaW5lID09PSB0cnVlICYmIG1hcFtpXS5zZWxlY3RvciAhPT0gZmFsc2UpIHsKCQkJZm9yKHZhciBqPWkrMTtqPG1hcC5sZW5ndGg7IGorKykgewoJCQkJaWYobWFwW2ldLnByb3AgPT09IG1hcFtqXS5wcm9wICYmIG1hcFtpXS52YWx1ZSA9PT0gbWFwW2pdLnZhbHVlKSB7CgkJCQkJbWFwW2ldLnNlbGVjdG9yICs9ICcsICcgKyBtYXBbal0uc2VsZWN0b3IucmVwbGFjZSgvfn4oLispfn4vLCAnJykucmVwbGFjZSgvXiUuKj8lLywgJycpOwoJCQkJCW1hcFtqXS5zZWxlY3RvciA9IGZhbHNlOyAvLyBtYXJraW5nIGZvciByZW1vdmFsCgkJCQl9CgkJCX0KCQl9Cgl9CgoJLy8gcHJlcGFyaW5nIHRoZSByZXN1bHQKCWZvcih2YXIgaT0wOyBpPG1hcC5sZW5ndGg7IGkrKykgewoJCWlmKG1hcFtpXS5zZWxlY3RvciAhPT0gZmFsc2UpIHsKCQkJaWYoIWFyclttYXBbaV0uc2VsZWN0b3JdKSBhcnJbbWFwW2ldLnNlbGVjdG9yXSA9IHt9CgkJCWFyclttYXBbaV0uc2VsZWN0b3JdW21hcFtpXS5wcm9wXSA9IG1hcFtpXS52YWx1ZTsKCQl9Cgl9CgkKCXJldHVybiBhcnI7Cn0KCnZhciBtaW5pbWl6ZSA9IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoIC9cL1wqKD86KD8hXCpcLylbXHNcU10pKlwqXC98W1xyXG5cdF0rL2csICcnICk7CiAgICAvLyBub3cgYWxsIGNvbW1lbnRzLCBuZXdsaW5lcyBhbmQgdGFicyBoYXZlIGJlZW4gcmVtb3ZlZAogICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggLyB7Mix9L2csICcgJyApOwogICAgLy8gbm93IHRoZXJlIGFyZSBubyBtb3JlIHRoYW4gc2luZ2xlIGFkamFjZW50IHNwYWNlcyBsZWZ0CiAgICAvLyBub3cgdW5uZWNlc3Nhcnk6IGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoIC8oXHMpK1wuL2csICcgLicgKTsKICAgIGNvbnRlbnQgPSBjb250ZW50LnJlcGxhY2UoIC8gKFt7On1dKSAvZywgJyQxJyApOwogICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggLyhbOyxdKSAvZywgJyQxJyApOwogICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSggLyAhL2csICchJyApOwogICAgcmV0dXJuIGNvbnRlbnQ7Cn0KCnZhciByZXBsYWNlRGVmaW5lZCA9IGZ1bmN0aW9uKGNzcywgb3B0aW9ucykgewoJaWYob3B0aW9ucyAmJiBvcHRpb25zLmFwaSAmJiBvcHRpb25zLmFwaS5nZXRTdG9yYWdlKCkuX19kZWZpbmVkKSB7CgkJdmFyIHN0b3JhZ2UgPSBvcHRpb25zLmFwaS5nZXRTdG9yYWdlKCkuX19kZWZpbmVkOwoJCWZvcih2YXIgcHJvcCBpbiBzdG9yYWdlKSB7CgkJCXZhciByZSA9IG5ldyBSZWdFeHAoJzwlKCApPycgKyBwcm9wICsgJyggKT8lPicsICdnJyk7CgkJCWlmKHR5cGVvZiBzdG9yYWdlW3Byb3BdICE9ICdmdW5jdGlvbicpIHsKCQkJCWNzcyA9IGNzcy5yZXBsYWNlKHJlLCBzdG9yYWdlW3Byb3BdKTsKCQkJfSBlbHNlIHsKCQkJCWNzcyA9IGNzcy5yZXBsYWNlKHJlLCBzdG9yYWdlW3Byb3BdKCkpOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGNzczsKfQoKbGliLnByb2Nlc3NvcnMuY3NzLkNTUyA9IGZ1bmN0aW9uKCkgewoJdmFyIHByb2Nlc3NvciA9IGZ1bmN0aW9uKHJ1bGVzLCBjYWxsYmFjaywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRPcHRpb25zOwoJCWlmKG9wdGlvbnMuYXBpICYmIG9wdGlvbnMuYXBpLmpzb25pZnkpIHsKCQkJdmFyIGpzb24gPSB0b0pTT04ocnVsZXMsIG9wdGlvbnMpOwoJCQljYWxsYmFjayhudWxsLCBqc29uKTsKCQkJcmV0dXJuIGpzb247CgkJfQoJCXZhciBjc3MgPSAnJzsKCQlmb3IodmFyIHN0eWxlc2hlZXQgaW4gcnVsZXMpIHsKCQkJdmFyIHIgPSBydWxlc1tzdHlsZXNoZWV0XTsKCQkJciA9IG9wdGlvbnMuY29tYmluZVNlbGVjdG9ycyA/IGNvbWJpbmVTZWxlY3RvcnMociwgb3B0aW9ucy5wcmV2ZW50Q29tYmluaW5nKSA6IHI7CgkJCWlmKHN0eWxlc2hlZXQgPT09ICJtYWluc3RyZWFtIikgewoJCQkJY3NzICs9IHRvQ1NTKHIsIG9wdGlvbnMpOwoJCQl9IGVsc2UgewoJCQkJY3NzICs9IHN0eWxlc2hlZXQgKyAiIHsiICsgbmV3bGluZSArIHRvQ1NTKHIsIG9wdGlvbnMsIFsnICAnLCAnICAgICddKSArICJ9IiArIG5ld2xpbmU7CgkJCX0JCQoJCX0KCQljc3MgPSByZXBsYWNlRGVmaW5lZChjc3MsIG9wdGlvbnMpOwoJCS8vIER5bmFtaWMgQ1NTCgkJaWYob3B0aW9ucyAmJiBvcHRpb25zLmFwaSAmJiBvcHRpb25zLmFwaS5keW5hbWljQ1NTKSB7CgkJCWNzcyA9IHJlcXVpcmUoIi4uL2h0bWwvaGVscGVycy9UZW1wbGF0ZUVuZ2luZSIpKGNzcywgb3B0aW9ucyk7CgkJfQoJCS8vIE1pbmlmaWNhdGlvbgoJCWlmKG9wdGlvbnMubWluaWZ5KSB7CgkJCWNzcyA9IG1pbmltaXplKGNzcyk7CgkJCWlmKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBjc3MpOwoJCX0gZWxzZSB7CgkJCWlmKGNhbGxiYWNrKSBjYWxsYmFjayhudWxsLCBjc3MpOwoJCX0KCQlyZXR1cm4gY3NzOwoJfQoJcHJvY2Vzc29yLnR5cGUgPSAiY3NzIjsKCXJldHVybiBwcm9jZXNzb3I7Cn0KCmxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zLmNoYXJzZXQgPSBmdW5jdGlvbigpIHsJCglyZXR1cm4gZnVuY3Rpb24oYXBpLCBjaGFyc2V0VmFsdWUpIHsKCQlpZih0eXBlb2YgY2hhcnNldFZhbHVlID09PSAic3RyaW5nIikgewoJCQlhcGkucmF3KCJAY2hhcnNldDogXCIiICsgY2hhcnNldFZhbHVlICsgIlwiOyIpOwoJCX0gZWxzZSBpZih0eXBlb2YgY2hhcnNldFZhbHVlID09PSAib2JqZWN0IikgewoJCQljaGFyc2V0VmFsdWUgPSBjaGFyc2V0VmFsdWUuY2hhcnNldC5yZXBsYWNlKC86L2csICcnKS5yZXBsYWNlKC8nL2csICcnKS5yZXBsYWNlKC8iL2csICcnKS5yZXBsYWNlKC8gL2csICcnKTsKCQkJYXBpLnJhdygiQGNoYXJzZXQ6IFwiIiArIGNoYXJzZXRWYWx1ZSArICJcIjsiKTsKCQl9Cgl9Cn0KbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMuZG9jdW1lbnQgPSBmdW5jdGlvbigpIHsJCglyZXR1cm4gZnVuY3Rpb24oYXBpLCB2YWx1ZSkgewoJCWlmKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJdmFyIHN0eWxlc2hlZXQgPSAnJzsKCQkJc3R5bGVzaGVldCArPSAnQCcgKyB2YWx1ZS52ZW5kb3IgKyAnZG9jdW1lbnQnOwoJCQlzdHlsZXNoZWV0ICs9ICcgJyArIHZhbHVlLmRvY3VtZW50OwoJCQlpZih2YWx1ZS5ydWxlcyAmJiB2YWx1ZS5ydWxlcy5sZW5ndGgpIHsKCQkJCWZvcih2YXIgaT0wOyBydWxlPXZhbHVlLnJ1bGVzW2ldOyBpKyspIHsKCQkJCQlhcGkuaGFuZGxlY3NzcnVsZShydWxlLCBzdHlsZXNoZWV0KTsKCQkJCX0KCQkJfSBlbHNlIGlmKHR5cGVvZiB2YWx1ZS5zdHlsZXMgIT0gInVuZGVmaW5lZCIpIHsKCQkJCWFwaS5hZGQodmFsdWUuc3R5bGVzLCBzdHlsZXNoZWV0KTsKCQkJfQoJCX0KCX0KfQpsaWIucHJvY2Vzc29ycy5jc3MucGx1Z2lucy5rZXlmcmFtZXMgPSBmdW5jdGlvbigpIHsKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJdmFyIHByb2Nlc3NvciA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi9DU1MuanMiKSgpOwoJCXZhciBwcmVmaXhlcyA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi8uLi8uLi9oZWxwZXJzL1ByZWZpeGVzIik7CgkJaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewoJCQkvLyBqcyBvciBqc29uCgkJCXZhciBmcmFtZXM7CgkJCWlmKHR5cGVvZiB2YWx1ZS5mcmFtZXMgIT0gInVuZGVmaW5lZCIpIHsKCQkJCWZyYW1lcyA9IHZhbHVlLmZyYW1lczsKCQkJLy8gY3NzCgkJCX0gZWxzZSBpZih0eXBlb2YgdmFsdWUua2V5ZnJhbWVzICE9ICJ1bmRlZmluZWQiKSB7CgkJCQlmcmFtZXMgPSB7fTsKCQkJCWZvcih2YXIgaT0wOyBydWxlPXZhbHVlLmtleWZyYW1lc1tpXTsgaSsrKSB7CgkJCQkJaWYocnVsZS50eXBlID09PSAia2V5ZnJhbWUiKSB7CgkJCQkJCXZhciBmID0gZnJhbWVzW3J1bGUudmFsdWVzXSA9IHt9OwoJCQkJCQlmb3IodmFyIGo9MDsgZGVjbGFyYXRpb249cnVsZS5kZWNsYXJhdGlvbnNbal07IGorKykgewoJCQkJCQkJaWYoZGVjbGFyYXRpb24udHlwZSA9PT0gImRlY2xhcmF0aW9uIikgewoJCQkJCQkJCWZbZGVjbGFyYXRpb24ucHJvcGVydHldID0gZGVjbGFyYXRpb24udmFsdWU7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQkJaWYoYXBpLmpzb25pZnkpIHsKCQkJCXZhciByID0ge307CgkJCQlyLmtleWZyYW1lcyA9IHsKCQkJCQluYW1lOiB2YWx1ZS5uYW1lLAoJCQkJCWZyYW1lczogZnJhbWVzCgkJCQl9CgkJCQlhcGkuYWRkKHIpOwoJCQl9IGVsc2UgewoJCQkJdmFyIGFic3VyZCA9IHJlcXVpcmUoX19kaXJuYW1lICsgJy8uLi8uLi8uLi8uLi8nKSgpOwoJCQkJYWJzdXJkLmFkZChmcmFtZXMpLmNvbXBpbGUoZnVuY3Rpb24oZXJyLCBjc3MpIHsKCQkJCQl2YXIgY29udGVudCA9ICdAa2V5ZnJhbWVzICcgKyB2YWx1ZS5uYW1lICsgIiB7XG4iOwoJCQkJCWNvbnRlbnQgKz0gY3NzOwoJCQkJCWNvbnRlbnQgKz0gIn0iOwoJCQkJCWNvbnRlbnQgPSBjb250ZW50ICsgIlxuIiArIGNvbnRlbnQucmVwbGFjZSgiQGtleWZyYW1lcyIsICJALXdlYmtpdC1rZXlmcmFtZXMiKTsKCQkJCQlhcGkucmF3KGNvbnRlbnQpOwoJCQkJfSwge2NvbWJpbmVTZWxlY3RvcnM6IGZhbHNlfSk7CQoJCQl9CQkJCgkJfQoJfQp9CmxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zLm1lZGlhID0gZnVuY3Rpb24oKSB7CglyZXR1cm4gZnVuY3Rpb24oYXBpLCB2YWx1ZSkgewoJCXZhciBwcm9jZXNzb3IgPSByZXF1aXJlKF9fZGlybmFtZSArICIvLi4vQ1NTLmpzIikoKTsKCQlpZih0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CgkJCXZhciBjb250ZW50ID0gJ0BtZWRpYSAnICsgdmFsdWUubWVkaWEgKyAiIHtcbiI7CgkJCXZhciBydWxlcyA9IHt9LCBqc29uID0ge307CgkJCWZvcih2YXIgaT0wOyBydWxlPXZhbHVlLnJ1bGVzW2ldOyBpKyspIHsKCQkJCXZhcgoJCQkJCXIsIHJqc29uOwoJCQkJaWYgKHJ1bGUuc2VsZWN0b3JzKSB7CgkJCQkJciA9IHJ1bGVzW3J1bGUuc2VsZWN0b3JzLnRvU3RyaW5nKCldID0ge307CgkJCQkJcmpzb24gPSBqc29uW3J1bGUuc2VsZWN0b3JzLnRvU3RyaW5nKCldID0ge307CgkJCQkJaWYocnVsZS50eXBlID09PSAicnVsZSIpIHsKCQkJCQkJZm9yKHZhciBqPTA7IGRlY2xhcmF0aW9uPXJ1bGUuZGVjbGFyYXRpb25zW2pdOyBqKyspIHsKCQkJCQkJCWlmKGRlY2xhcmF0aW9uLnR5cGUgPT09ICJkZWNsYXJhdGlvbiIpIHsKCQkJCQkJCQlyW2RlY2xhcmF0aW9uLnByb3BlcnR5XSA9IGRlY2xhcmF0aW9uLnZhbHVlOwoJCQkJCQkJCXJqc29uW2RlY2xhcmF0aW9uLnByb3BlcnR5XSA9IGRlY2xhcmF0aW9uLnZhbHVlOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJCgkJCX0KCQkJY29udGVudCArPSBwcm9jZXNzb3Ioe21haW5zdHJlYW06IHJ1bGVzfSk7CgkJCWNvbnRlbnQgKz0gIn0iOwoJCQlpZihhcGkuanNvbmlmeSkgewoJCQkJYXBpLmFkZChqc29uLCAnQG1lZGlhICcgKyB2YWx1ZS5tZWRpYSk7CgkJCX0gZWxzZSB7CgkJCQlhcGkucmF3KGNvbnRlbnQpOwoJCQl9CgkJfQoJfQp9CmxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zLm5hbWVzcGFjZSA9IGZ1bmN0aW9uKCkgewkKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJaWYodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewoJCQlhcGkucmF3KCJAbmFtZXNwYWNlOiBcIiIgKyB2YWx1ZSArICJcIjsiKTsKCQl9IGVsc2UgaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewoJCQl2YWx1ZSA9IHZhbHVlLm5hbWVzcGFjZS5yZXBsYWNlKC86IC9nLCAnJykucmVwbGFjZSgvJy9nLCAnJykucmVwbGFjZSgvIi9nLCAnJykucmVwbGFjZSgvIC9nLCAnJykucmVwbGFjZSgvOmgvZywgJ2gnKTsKCQkJYXBpLnJhdygiQG5hbWVzcGFjZTogXCIiICsgdmFsdWUgKyAiXCI7Iik7CgkJfQoJfQp9CmxpYi5wcm9jZXNzb3JzLmNzcy5wbHVnaW5zLnBhZ2UgPSBmdW5jdGlvbigpIHsJCglyZXR1cm4gZnVuY3Rpb24oYXBpLCB2YWx1ZSkgewoJCWlmKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJdmFyIGNvbnRlbnQgPSAiIjsgCgkJCWlmKHZhbHVlLnNlbGVjdG9ycy5sZW5ndGggPiAwKSB7CgkJCQljb250ZW50ICs9ICJAcGFnZSAiICsgdmFsdWUuc2VsZWN0b3JzLmpvaW4oIiwgIikgKyAiIHtcbiI7CgkJCX0gZWxzZSB7CgkJCQljb250ZW50ICs9ICJAcGFnZSB7XG4iOwoJCQl9CgkJCWZvcih2YXIgaT0wOyBkZWNsYXJhdGlvbj12YWx1ZS5kZWNsYXJhdGlvbnNbaV07IGkrKykgewoJCQkJaWYoZGVjbGFyYXRpb24udHlwZSA9PSAiZGVjbGFyYXRpb24iKSB7CgkJCQkJY29udGVudCArPSAiICAiICsgZGVjbGFyYXRpb24ucHJvcGVydHkgKyAiOiAiICsgZGVjbGFyYXRpb24udmFsdWUgKyAiO1xuIjsKCQkJCX0KCQkJfQoJCQljb250ZW50ICs9ICJ9IjsKCQkJYXBpLnJhdyhjb250ZW50KTsKCQl9Cgl9Cn0KbGliLnByb2Nlc3NvcnMuY3NzLnBsdWdpbnMuc3VwcG9ydHMgPSBmdW5jdGlvbigpIHsKCXJldHVybiBmdW5jdGlvbihhcGksIHZhbHVlKSB7CgkJdmFyIHByb2Nlc3NvciA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi8uLi9DU1MuanMiKSgpOwoJCWlmKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIpIHsKCQkJdmFyIGNvbnRlbnQgPSAnQHN1cHBvcnRzICcgKyB2YWx1ZS5zdXBwb3J0cyArICIge1xuIjsKCQkJdmFyIHJ1bGVzID0ge307CgkJCWZvcih2YXIgaT0wOyBydWxlPXZhbHVlLnJ1bGVzW2ldOyBpKyspIHsJCQkJCgkJCQl2YXIgciA9IHJ1bGVzW3J1bGUuc2VsZWN0b3JzLnRvU3RyaW5nKCldID0ge307CgkJCQlpZihydWxlLnR5cGUgPT09ICJydWxlIikgewoJCQkJCWZvcih2YXIgaj0wOyBkZWNsYXJhdGlvbj1ydWxlLmRlY2xhcmF0aW9uc1tqXTsgaisrKSB7CgkJCQkJCWlmKGRlY2xhcmF0aW9uLnR5cGUgPT09ICJkZWNsYXJhdGlvbiIpIHsKCQkJCQkJCXJbZGVjbGFyYXRpb24ucHJvcGVydHldID0gZGVjbGFyYXRpb24udmFsdWU7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQkJY29udGVudCArPSBwcm9jZXNzb3Ioe21haW5zdHJlYW06IHJ1bGVzfSk7CgkJCWNvbnRlbnQgKz0gIn0iOwoJCQlhcGkucmF3KGNvbnRlbnQpOwoJCX0KCX0KfQp2YXIgZGF0YSA9IG51bGwsCgluZXdsaW5lID0gJ1xuJywKCWRlZmF1bHRPcHRpb25zID0ge30sCgl0YWdzID0gW10sCgliZWF1dGlmeUhUTUwgPSByZXF1aXJlKCdqcy1iZWF1dGlmeScpLmh0bWwsCgl0dSA9IHJlcXVpcmUoIi4uLy4uL2hlbHBlcnMvVHJhbnNmb3JtVXBwZXJjYXNlIiksCglwYXNzZWRPcHRpb25zID0ge307Cgp2YXIgcHJvY2Vzc1RlbXBsYXRlID0gZnVuY3Rpb24odGVtcGxhdGVOYW1lKSB7Cgl2YXIgaHRtbCA9ICcnOwoJZm9yKHZhciB0ZW1wbGF0ZSBpbiBkYXRhKSB7CgkJaWYodGVtcGxhdGUgPT0gdGVtcGxhdGVOYW1lKSB7CgkJCXZhciBudW1PZlJ1bGVzID0gZGF0YVt0ZW1wbGF0ZV0ubGVuZ3RoOwoJCQlmb3IodmFyIGk9MDsgaTxudW1PZlJ1bGVzOyBpKyspIHsKCQkJCWh0bWwgKz0gcHJvY2VzcygnJywgZGF0YVt0ZW1wbGF0ZV1baV0pOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGh0bWw7Cn0KdmFyIHByZXBhcmVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHByb3AsIG9wdGlvbnMpIHsKCWlmKG9wdGlvbnMgJiYgb3B0aW9ucy5rZWVwQ2FtZWxDYXNlID09PSB0cnVlKSB7CgkJcmV0dXJuIHByb3A7Cgl9IGVsc2UgewoJCXJldHVybiB0dShwcm9wLCBvcHRpb25zKTsKCX0KfQp2YXIgcHJvY2VzcyA9IGZ1bmN0aW9uKHRhZ05hbWUsIG9iaikgewoJLy8gY29uc29sZS5sb2coIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuIiwgdGFnTmFtZSwgIj4iLCBvYmopOwoKCXZhciBodG1sID0gJycsIGF0dHJzID0gJycsIGNoaWxkcyA9ICcnOwoKCXZhciB0YWdBbmFsaXplZCA9IHJlcXVpcmUoIi4vaGVscGVycy9Qcm9wQW5hbHl6ZXIiKSh0YWdOYW1lKTsKCXRhZ05hbWUgPSB0YWdBbmFsaXplZC50YWc7CglpZih0YWdBbmFsaXplZC5hdHRycyAhPSAiIikgewoJCWF0dHJzICs9ICIgIiArIHRhZ0FuYWxpemVkLmF0dHJzOwoJfQoKCWlmKHR5cGVvZiBvYmogPT09ICJzdHJpbmciIHx8IG9iaiA9PT0gbnVsbCkgewoJCXJldHVybiBwYWNrVGFnKHRhZ05hbWUsIGF0dHJzLCBvYmopOwoJfQoKCXZhciBhZGRUb0NoaWxkcyA9IGZ1bmN0aW9uKHZhbHVlKSB7CgkJaWYoY2hpbGRzICE9ICcnKSB7IGNoaWxkcyArPSBuZXdsaW5lOyB9CgkJY2hpbGRzICs9IHZhbHVlOwoJfQoKCS8vIHByb2Nlc3MgZGlyZWN0aXZlcwoJZm9yKHZhciBkaXJlY3RpdmVOYW1lIGluIG9iaikgewoJCXZhciB2YWx1ZSA9IG9ialtkaXJlY3RpdmVOYW1lXTsKCQlzd2l0Y2goZGlyZWN0aXZlTmFtZSkgewoJCQljYXNlICJfYXR0cnMiOgoJCQkJZm9yKHZhciBhdHRyTmFtZSBpbiB2YWx1ZSkgewoJCQkJCWlmKHR5cGVvZiB2YWx1ZVthdHRyTmFtZV0gPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJYXR0cnMgKz0gIiAiICsgcHJlcGFyZVByb3BlcnR5KGF0dHJOYW1lLCBwYXNzZWRPcHRpb25zKSArICI9XCIiICsgdmFsdWVbYXR0ck5hbWVdKCkgKyAiXCIiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWF0dHJzICs9ICIgIiArIHByZXBhcmVQcm9wZXJ0eShhdHRyTmFtZSwgcGFzc2VkT3B0aW9ucykgKyAiPVwiIiArIHZhbHVlW2F0dHJOYW1lXSArICJcIiI7CgkJCQkJfQoJCQkJfQoJCQlicmVhazsKCQkJY2FzZSAiXyI6CgkJCQlhZGRUb0NoaWxkcyh2YWx1ZSk7CgkJCWJyZWFrOwoJCQljYXNlICJfdHBsIjogCgkJCQlpZih0eXBlb2YgdmFsdWUgPT0gInN0cmluZyIpIHsKCQkJCQlhZGRUb0NoaWxkcyhwcm9jZXNzVGVtcGxhdGUodmFsdWUpKTsKCQkJCX0gZWxzZSBpZih2YWx1ZSBpbnN0YW5jZW9mIEFycmF5KSB7CgkJCQkJdmFyIHRtcCA9ICcnOwoJCQkJCWZvcih2YXIgaT0wOyB0cGw9dmFsdWVbaV07IGkrKykgewoJCQkJCQl0bXAgKz0gcHJvY2Vzc1RlbXBsYXRlKHRwbCkKCQkJCQkJaWYoaSA8IHZhbHVlLmxlbmd0aC0xKSB0bXAgKz0gbmV3bGluZTsKCQkJCQl9CgkJCQkJYWRkVG9DaGlsZHModG1wKTsKCQkJCX0KCQkJYnJlYWs7CgkJCWNhc2UgIl9pbmNsdWRlIjoKCQkJCXZhciB0bXAgPSAnJzsKCQkJCXZhciBhZGQgPSBmdW5jdGlvbihvKSB7CgkJCQkJaWYodHlwZW9mIG8gPT09ICJmdW5jdGlvbiIpIHsgbyA9IG8oKTsgfQoJCQkJCWlmKG8uY3NzICYmIG8uaHRtbCkgeyBvID0gby5odG1sOyB9IC8vIGNhdGNoaW5nIGEgY29tcG9uZW50CgkJCQkJdG1wICs9IHByb2Nlc3MoJycsIG8pOwoJCQkJfQoJCQkJaWYodmFsdWUgaW5zdGFuY2VvZiBBcnJheSkgewoJCQkJCWZvcih2YXIgaT0wOyBpPHZhbHVlLmxlbmd0aCwgbz12YWx1ZVtpXTsgaSsrKSB7CgkJCQkJCWFkZChvKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0Iil7CgkJCQkJYWRkKHZhbHVlKTsKCQkJCX0KCQkJCWFkZFRvQ2hpbGRzKHRtcCk7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OgoJCQkJc3dpdGNoKHR5cGVvZiB2YWx1ZSkgewoJCQkJCWNhc2UgInN0cmluZyI6IGFkZFRvQ2hpbGRzKHByb2Nlc3MoZGlyZWN0aXZlTmFtZSwgdmFsdWUpKTsgYnJlYWs7CgkJCQkJY2FzZSAib2JqZWN0IjogCgkJCQkJCWlmKHZhbHVlICYmIHZhbHVlLmxlbmd0aCAmJiB2YWx1ZS5sZW5ndGggPiAwKSB7CgkJCQkJCQl2YXIgdG1wID0gJyc7CgkJCQkJCQlmb3IodmFyIGk9MDsgdj12YWx1ZVtpXTsgaSsrKSB7CgkJCQkJCQkJdG1wICs9IHByb2Nlc3MoJycsIHR5cGVvZiB2ID09ICJmdW5jdGlvbiIgPyB2KCkgOiB2KTsKCQkJCQkJCQlpZihpIDwgdmFsdWUubGVuZ3RoLTEpIHRtcCArPSBuZXdsaW5lOwoJCQkJCQkJfQoJCQkJCQkJYWRkVG9DaGlsZHMocHJvY2VzcyhkaXJlY3RpdmVOYW1lLCB0bXApKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWFkZFRvQ2hpbGRzKHByb2Nlc3MoZGlyZWN0aXZlTmFtZSwgdmFsdWUpKTsKCQkJCQkJfQoJCQkJCWJyZWFrOwoJCQkJCWNhc2UgImZ1bmN0aW9uIjogYWRkVG9DaGlsZHMocHJvY2VzcyhkaXJlY3RpdmVOYW1lLCB2YWx1ZSgpKSk7IGJyZWFrOwoJCQkJfQoJCQlicmVhazsKCQl9Cgl9CgoJaWYodGFnTmFtZSAhPSAnJykgewoJCWh0bWwgKz0gcGFja1RhZyh0YWdOYW1lLCBhdHRycywgY2hpbGRzKTsKCX0gZWxzZSB7CgkJaHRtbCArPSBjaGlsZHM7Cgl9CgoJcmV0dXJuIGh0bWw7Cn0KdmFyIHBhY2tUYWcgPSBmdW5jdGlvbih0YWdOYW1lLCBhdHRycywgY2hpbGRzKSB7Cgl2YXIgaHRtbCA9ICcnOwoJaWYodGFnTmFtZSA9PSAnJyAmJiBhdHRycyA9PSAnJyAmJiBjaGlsZHMgIT0gJycpIHsKCQlyZXR1cm4gY2hpbGRzOwoJfQoJdGFnTmFtZSA9IHRhZ05hbWUgPT0gJycgPyAnZGl2JyA6IHRhZ05hbWU7CglpZihjaGlsZHMgIT09IG51bGwpIHsKCQlodG1sICs9ICc8JyArIHByZXBhcmVQcm9wZXJ0eSh0YWdOYW1lLCBwYXNzZWRPcHRpb25zKSArIGF0dHJzICsgJz4nICsgbmV3bGluZSArIGNoaWxkcyArIG5ld2xpbmUgKyAnPC8nICsgcHJlcGFyZVByb3BlcnR5KHRhZ05hbWUsIHBhc3NlZE9wdGlvbnMpICsgJz4nOwoJfSBlbHNlIHsKCQlodG1sICs9ICc8JyArIHByZXBhcmVQcm9wZXJ0eSh0YWdOYW1lLCBwYXNzZWRPcHRpb25zKSArIGF0dHJzICsgJy8+JzsKCX0KCXJldHVybiBodG1sOwp9CnZhciBwcmVwYXJlSFRNTCA9IGZ1bmN0aW9uKGh0bWwpIHsKCWh0bWwgPSByZXF1aXJlKCIuL2hlbHBlcnMvVGVtcGxhdGVFbmdpbmUiKShodG1sLnJlcGxhY2UoL1tcclx0XG5dL2csICcnKSwgcGFzc2VkT3B0aW9ucyk7CglpZihwYXNzZWRPcHRpb25zLm1pbmlmeSkgewoJCXJldHVybiBodG1sOwoJfSBlbHNlIHsKCQlyZXR1cm4gYmVhdXRpZnlIVE1MKGh0bWwsIHtpbmRlbnRfc2l6ZTogcGFzc2VkT3B0aW9ucy5pbmRlbnRTaXplIHx8IDR9KTsKCX0KfQpsaWIucHJvY2Vzc29ycy5odG1sLkhUTUwgPSBmdW5jdGlvbigpIHsKCXZhciBwcm9jZXNzb3IgPSBmdW5jdGlvbihydWxlcywgY2FsbGJhY2ssIG9wdGlvbnMpIHsKCQlkYXRhID0gcnVsZXM7CgkJY2FsbGJhY2sgPSBjYWxsYmFjayB8fCBmdW5jdGlvbigpIHt9OwoJCW9wdGlvbnMgPSBwYXNzZWRPcHRpb25zID0gb3B0aW9ucyB8fCBkZWZhdWx0T3B0aW9uczsKCQl2YXIgaHRtbCA9IHByZXBhcmVIVE1MKHByb2Nlc3NUZW1wbGF0ZSgibWFpbnN0cmVhbSIpKTsKCQljYWxsYmFjayhudWxsLCBodG1sKTsKCQlyZXR1cm4gaHRtbDsKCX0KCXByb2Nlc3Nvci50eXBlID0gImh0bWwiOwoJcmV0dXJuIHByb2Nlc3NvcjsKfQpsaWIucHJvY2Vzc29ycy5odG1sLmhlbHBlcnMuUHJvcEFuYWx5emVyID0gZnVuY3Rpb24ocHJvcCkgewoJdmFyIHJlcyA9IHsgCgkJCXRhZzogJycsCgkJCWF0dHJzOiAnJwoJCX0sCgkJbnVtT2ZDaGFycyA9IHByb3AubGVuZ3RoLAoJCXRhZ05hbWUgPSAiIiwKCQljbGFzc05hbWUgPSAiIiwgcmVhZGluZ0NsYXNzID0gZmFsc2UsIGNsYXNzZXMgPSBbXSwKCQlpZE5hbWUgPSAiIiwgcmVhZGluZ0lkID0gZmFsc2UsIGlkcyA9IFtdLAoJCWF0dHJpYnV0ZXMgPSAiIiwgcmVhZGluZ0F0dHJpYnV0ZXMgPSBmYWxzZTsKCglpZigvKCN8XC58XFt8XF0pL2dpLnRlc3QocHJvcCkgPT09IGZhbHNlKSB7CgkJcmV0dXJuIHsKCQkJdGFnOiBwcm9wLAoJCQlhdHRyczogJycKCQl9OwoJfQoKCWZvcih2YXIgaT0wOyBpPHByb3AubGVuZ3RoLCBjPXByb3BbaV07IGkrKykgewoJCWlmKGMgPT09ICJbIiAmJiAhcmVhZGluZ0F0dHJpYnV0ZXMpIHsKCQkJcmVhZGluZ0F0dHJpYnV0ZXMgPSB0cnVlOwoJCX0gZWxzZSBpZihyZWFkaW5nQXR0cmlidXRlcykgewoJCQlpZihjICE9ICJdIikgewoJCQkJYXR0cmlidXRlcyArPSBjOwoJCQl9IGVsc2UgewoJCQkJcmVhZGluZ0F0dHJpYnV0ZXMgPSBmYWxzZTsKCQkJCWkgLT0gMTsKCQkJfQoJCX0gZWxzZSBpZihjID09PSAiLiIgJiYgIXJlYWRpbmdDbGFzcykgewoJCQlyZWFkaW5nQ2xhc3MgPSB0cnVlOwoJCX0gZWxzZSBpZihyZWFkaW5nQ2xhc3MpIHsKCQkJaWYoYyAhPSAiLiIgJiYgYyAhPSAiIyIgJiYgYyAhPSAiWyIgJiYgYyAhPSAiXSIpIHsKCQkJCWNsYXNzTmFtZSArPSBjOwoJCQl9IGVsc2UgewoJCQkJY2xhc3Nlcy5wdXNoKGNsYXNzTmFtZSk7CgkJCQlyZWFkaW5nQ2xhc3MgPSBmYWxzZTsKCQkJCWNsYXNzTmFtZSA9ICIiOwoJCQkJaSAtPSAxOwoJCQl9CgkJfSBlbHNlIGlmKGMgPT09ICIjIiAmJiAhcmVhZGluZ0lkKSB7CgkJCXJlYWRpbmdJZCA9IHRydWU7CgkJfSBlbHNlIGlmKHJlYWRpbmdJZCkgewoJCQlpZihjICE9ICIuIiAmJiBjICE9ICIjIiAmJiBjICE9ICJbIiAmJiBjICE9ICJdIikgewoJCQkJaWROYW1lICs9IGM7CgkJCX0gZWxzZSB7CgkJCQlyZWFkaW5nSWQgPSBmYWxzZTsKCQkJCWkgLT0gMTsKCQkJfQoJCX0gZWxzZSBpZihjICE9ICIuIiAmJiBjICE9ICIjIiAmJiBjICE9ICJbIiAmJiBjICE9ICJdIikgewoJCQlyZXMudGFnICs9IGM7CgkJfQoJfQoKCS8vIGlmIGVuZHMgd2l0aCBhIGNsYXNzCglpZihjbGFzc05hbWUgIT0gIiIpIGNsYXNzZXMucHVzaChjbGFzc05hbWUpOwoKCS8vIGNvbGxlY3RpbmcgY2xhc3NlcwoJdmFyIGNsc1N0ciA9ICcnOwoJZm9yKHZhciBpPTA7IGNscz1jbGFzc2VzW2ldOyBpKyspIHsKCQljbHNTdHIgKz0gY2xzU3RyID09PSAiIiA/IGNscyA6ICIgIiArIGNsczsKCX0KCXJlcy5hdHRycyArPSBjbHNTdHIgIT0gIiIgPyAnY2xhc3M9IicgKyBjbHNTdHIgKyAnIicgOiAnJzsKCgkvLyBpZiBlbmRzIG9uIGlkCglpZihpZE5hbWUgIT0gIiIpIHsKCQlyZXMuYXR0cnMgKz0gKHJlcy5hdHRycyAhPSAiIiA/ICIgIiA6ICIiKSArICdpZD0iJyArIGlkTmFtZSArICciJzsKCX0KCgkvLyBpZiBkaXYgdGFnIG5hbWUgaXMgc2tpcHBlZAoJaWYocmVzLnRhZyA9PT0gIiIgJiYgcmVzLmF0dHJzICE9ICIiKSByZXMudGFnID0gImRpdiI7CgoJLy8gY29sbGVjdGluZyBhdHRyaWJ1dGVzCglpZihhdHRyaWJ1dGVzICE9ICIiKSB7CgkJcmVzLmF0dHJzICs9IChyZXMuYXR0cnMgIT0gIiIgPyAiICIgOiAiIikgKyBhdHRyaWJ1dGVzOwoJfQoKCXJldHVybiByZXM7Cn0KbGliLnByb2Nlc3NvcnMuaHRtbC5oZWxwZXJzLlRlbXBsYXRlRW5naW5lID0gZnVuY3Rpb24oaHRtbCwgb3B0aW9ucykgewoJdmFyIHJlID0gLzwlKC4rPyklPi9nLCAKCQlyZUV4cCA9IC8oXiggKT8odmFyfGlmfGZvcnxlbHNlfHN3aXRjaHxjYXNlfGJyZWFrfHt8fXw7KSkoLiopPy9nLCAKCQljb2RlID0gJ3dpdGgob2JqKSB7IHZhciByPVtdO1xuJywgCgkJY3Vyc29yID0gMCwgCgkJcmVzdWx0OwoJdmFyIGFkZCA9IGZ1bmN0aW9uKGxpbmUsIGpzKSB7CgkJanM/IChjb2RlICs9IGxpbmUubWF0Y2gocmVFeHApID8gbGluZSArICdcbicgOiAnci5wdXNoKCcgKyBsaW5lICsgJyk7XG4nKSA6CgkJCShjb2RlICs9IGxpbmUgIT0gJycgPyAnci5wdXNoKCInICsgbGluZS5yZXBsYWNlKC8iL2csICdcXCInKSArICciKTtcbicgOiAnJyk7CgkJcmV0dXJuIGFkZDsKCX0KCXdoaWxlKG1hdGNoID0gcmUuZXhlYyhodG1sKSkgewoJCWFkZChodG1sLnNsaWNlKGN1cnNvciwgbWF0Y2guaW5kZXgpKShtYXRjaFsxXSwgdHJ1ZSk7CgkJY3Vyc29yID0gbWF0Y2guaW5kZXggKyBtYXRjaFswXS5sZW5ndGg7Cgl9CglhZGQoaHRtbC5zdWJzdHIoY3Vyc29yLCBodG1sLmxlbmd0aCAtIGN1cnNvcikpOwoJY29kZSA9IChjb2RlICsgJ3JldHVybiByLmpvaW4oIiIpOyB9JykucmVwbGFjZSgvW1xyXHRcbl0vZywgJycpOwoJdHJ5IHsgcmVzdWx0ID0gbmV3IEZ1bmN0aW9uKCdvYmonLCBjb2RlKS5hcHBseShvcHRpb25zLCBbb3B0aW9uc10pOyB9CgljYXRjaChlcnIpIHsgY29uc29sZS5lcnJvcigiJyIgKyBlcnIubWVzc2FnZSArICInIiwgIiBpbiBcblxuQ29kZTpcbiIsIGNvZGUsICJcbiIpOyB9CglyZXR1cm4gcmVzdWx0Owp9OwpyZXR1cm4gY2xpZW50KCk7Cn0pKHdpbmRvdyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:05:15 GMT",
                    "Content-Length": "81486",
                    "Date": "Thu, 06 Nov 2014 06:05:15 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}