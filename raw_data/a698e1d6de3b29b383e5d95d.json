{
    "url": "http://localhost:9999/dextermilo/jquery.threedubmedia/jquery/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statement:<ul><li>window.location.href = window.location.href.match(/^(.+?)(\\?.*)?$/)[1] + \"?\" + encodeURIComponent(text);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/dextermilo/jquery.threedubmedia/jquery/qunit.js",
                "path": "/dextermilo/jquery.threedubmedia/jquery/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kZXh0ZXJtaWxvL2pxdWVyeS50aHJlZWR1Ym1lZGlhL2pxdWVyeS9xdW5pdC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzAxMDgNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDY6MTU6MDMgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA2OjE1OjAzIEdNVA0KDQovKg0KICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yaw0KICogDQogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0DQogKg0KICogQ29weXJpZ2h0IChjKSAyMDA5IEpvaG4gUmVzaWcsIEr2cm4gWmFlZmZlcmVyDQogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkNCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuDQogKi8NCg0KKGZ1bmN0aW9uKHdpbmRvdykgew0KDQp2YXIgUVVuaXQgPSB7DQoNCgkvLyBJbml0aWFsaXplIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMNCglpbml0OiBmdW5jdGlvbigpIHsNCgkJY29uZmlnID0gew0KCQkJc3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwNCgkJCW1vZHVsZVN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sDQoJCQlzdGFydGVkOiArbmV3IERhdGUsDQoJCQl1cGRhdGVSYXRlOiAxMDAwLA0KCQkJYmxvY2tpbmc6IGZhbHNlLA0KCQkJYXV0b3J1bjogZmFsc2UsDQoJCQlhc3NlcnRpb25zOiBbXSwNCgkJCWZpbHRlcnM6IFtdLA0KCQkJcXVldWU6IFtdDQoJCX07DQoNCgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksDQoJCQliYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksDQoJCQlyZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOw0KDQoJCWlmICggdGVzdHMgKSB7DQoJCQl0ZXN0cy5pbm5lckhUTUwgPSAiIjsNCgkJfQ0KDQoJCWlmICggYmFubmVyICkgew0KCQkJYmFubmVyLmNsYXNzTmFtZSA9ICIiOw0KCQl9DQoNCgkJaWYgKCByZXN1bHQgKSB7DQoJCQlyZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmVzdWx0ICk7DQoJCX0NCgl9LA0KCQ0KCS8vIGNhbGwgb24gc3RhcnQgb2YgbW9kdWxlIHRlc3QgdG8gcHJlcGVuZCBuYW1lIHRvIGFsbCB0ZXN0cw0KCW1vZHVsZTogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7DQoJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsNCg0KCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7DQoJCQkJUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsNCgkJCX0NCg0KCQkJY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOw0KCQkJY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsNCgkJCWNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsNCg0KCQkJUVVuaXQubW9kdWxlU3RhcnQoIG5hbWUsIHRlc3RFbnZpcm9ubWVudCApOw0KCQl9KTsNCgl9LA0KDQoJYXN5bmNUZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7DQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsNCgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IDA7DQoJCX0NCg0KCQlRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOw0KCX0sDQoJDQoJdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsNCgkJdmFyIG5hbWUgPSB0ZXN0TmFtZSwgdGVzdEVudmlyb25tZW50LCB0ZXN0RW52aXJvbm1lbnRBcmc7DQoNCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgew0KCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsNCgkJCWV4cGVjdGVkID0gbnVsbDsNCgkJfQ0KCQkvLyBpcyAybmQgYXJndW1lbnQgYSB0ZXN0RW52aXJvbm1lbnQ/DQoJCWlmICggZXhwZWN0ZWQgJiYgdHlwZW9mIGV4cGVjdGVkID09PSAnb2JqZWN0Jykgew0KCQkJdGVzdEVudmlyb25tZW50QXJnID0gIGV4cGVjdGVkOw0KCQkJZXhwZWN0ZWQgPSBudWxsOw0KCQl9DQoNCgkJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsNCgkJCW5hbWUgPSBjb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiAiICsgbmFtZTsNCgkJfQ0KDQoJCWlmICggIXZhbGlkVGVzdChuYW1lKSApIHsNCgkJCXJldHVybjsNCgkJfQ0KDQoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgew0KCQkJUVVuaXQudGVzdFN0YXJ0KCB0ZXN0TmFtZSApOw0KDQoJCQl0ZXN0RW52aXJvbm1lbnQgPSBleHRlbmQoew0KCQkJCXNldHVwOiBmdW5jdGlvbigpIHt9LA0KCQkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9DQoJCQl9LCBjb25maWcubW9kdWxlVGVzdEVudmlyb25tZW50KTsNCgkJCWlmICh0ZXN0RW52aXJvbm1lbnRBcmcpIHsNCgkJCQlleHRlbmQodGVzdEVudmlyb25tZW50LHRlc3RFbnZpcm9ubWVudEFyZyk7DQoJCQl9DQoNCgkJCS8vIGFsbG93IHV0aWxpdHkgZnVuY3Rpb25zIHRvIGFjY2VzcyB0aGUgY3VycmVudCB0ZXN0IGVudmlyb25tZW50DQoJCQlRVW5pdC5jdXJyZW50X3Rlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsNCgkJCQ0KCQkJY29uZmlnLmFzc2VydGlvbnMgPSBbXTsNCgkJCWNvbmZpZy5leHBlY3RlZCA9IGV4cGVjdGVkOw0KDQoJCQl0cnkgew0KCQkJCWlmICggIWNvbmZpZy5wb2xsdXRpb24gKSB7DQoJCQkJCXNhdmVHbG9iYWwoKTsNCgkJCQl9DQoNCgkJCQl0ZXN0RW52aXJvbm1lbnQuc2V0dXAuY2FsbCh0ZXN0RW52aXJvbm1lbnQpOw0KCQkJfSBjYXRjaChlKSB7DQoJCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOw0KCQkJfQ0KDQoJCQlpZiAoIGFzeW5jICkgew0KCQkJCVFVbml0LnN0b3AoKTsNCgkJCX0NCg0KCQkJdHJ5IHsNCgkJCQljYWxsYmFjay5jYWxsKHRlc3RFbnZpcm9ubWVudCk7DQoJCQl9IGNhdGNoKGUpIHsNCgkJCQlmYWlsKCJUZXN0ICIgKyBuYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIsIGUsIGNhbGxiYWNrKTsNCgkJCQlRVW5pdC5vayggZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAoY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiOiAiICsgZS5tZXNzYWdlICk7DQoJCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkNCgkJCQlzYXZlR2xvYmFsKCk7DQoNCgkJCQkvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nDQoJCQkJaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7DQoJCQkJCXN0YXJ0KCk7DQoJCQkJfQ0KCQkJfQ0KCQl9KTsNCg0KCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCXRyeSB7DQoJCQkJY2hlY2tQb2xsdXRpb24oKTsNCgkJCQl0ZXN0RW52aXJvbm1lbnQudGVhcmRvd24uY2FsbCh0ZXN0RW52aXJvbm1lbnQpOw0KCQkJfSBjYXRjaChlKSB7DQoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOw0KCQkJfQ0KDQoJCQl0cnkgew0KCQkJCVFVbml0LnJlc2V0KCk7DQoJCQl9IGNhdGNoKGUpIHsNCgkJCQlmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIG5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCByZXNldCk7DQoJCQl9DQoNCgkJCWlmICggY29uZmlnLmV4cGVjdGVkICYmIGNvbmZpZy5leHBlY3RlZCAhPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKSB7DQoJCQkJUVVuaXQub2soIGZhbHNlLCAiRXhwZWN0ZWQgIiArIGNvbmZpZy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOw0KCQkJfQ0KDQoJCQl2YXIgZ29vZCA9IDAsIGJhZCA9IDAsDQoJCQkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsNCg0KCQkJY29uZmlnLnN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7DQoJCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsNCg0KCQkJaWYgKCB0ZXN0cyApIHsNCgkJCQl2YXIgb2wgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsNCgkJCQlvbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KDQoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7DQoJCQkJCXZhciBhc3NlcnRpb24gPSBjb25maWcuYXNzZXJ0aW9uc1tpXTsNCg0KCQkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOw0KCQkJCQlsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOw0KCQkJCQlsaS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShhc3NlcnRpb24ubWVzc2FnZSB8fCAiKG5vIG1lc3NhZ2UpIikpOw0KCQkJCQlvbC5hcHBlbmRDaGlsZCggbGkgKTsNCg0KCQkJCQlpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7DQoJCQkJCQlnb29kKys7DQoJCQkJCX0gZWxzZSB7DQoJCQkJCQliYWQrKzsNCgkJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsNCgkJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7DQoJCQkJYi5pbm5lckhUTUwgPSBuYW1lICsgIiA8YiBzdHlsZT0nY29sb3I6YmxhY2s7Jz4oPGIgY2xhc3M9J2ZhaWwnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3MnPiIgKyBnb29kICsgIjwvYj4sICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOw0KCQkJCQ0KCQkJCWFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgew0KCQkJCQl2YXIgbmV4dCA9IGIubmV4dFNpYmxpbmcsIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7DQoJCQkJCW5leHQuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXkgPT09ICJub25lIiA/ICJibG9jayIgOiAibm9uZSI7DQoJCQkJfSk7DQoJCQkJDQoJCQkJYWRkRXZlbnQoYiwgImRibGNsaWNrIiwgZnVuY3Rpb24oZSkgew0KCQkJCQl2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7DQoJCQkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgew0KCQkJCQkJdmFyIHRleHQgPSAiIiwgbm9kZSA9IHRhcmdldC5maXJzdENoaWxkOw0KDQoJCQkJCQl3aGlsZSAoIG5vZGUubm9kZVR5cGUgPT09IDMgKSB7DQoJCQkJCQkJdGV4dCArPSBub2RlLm5vZGVWYWx1ZTsNCgkJCQkJCQlub2RlID0gbm9kZS5uZXh0U2libGluZzsNCgkJCQkJCX0NCg0KCQkJCQkJdGV4dCA9IHRleHQucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpOw0KDQoJCQkJCQlpZiAoIHdpbmRvdy5sb2NhdGlvbiApIHsNCgkJCQkJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRleHQpOw0KCQkJCQkJfQ0KCQkJCQl9DQoJCQkJfSk7DQoNCgkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOw0KCQkJCWxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsNCgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOw0KCQkJCWxpLmFwcGVuZENoaWxkKCBvbCApOw0KCQkJCXRlc3RzLmFwcGVuZENoaWxkKCBsaSApOw0KDQoJCQkJaWYgKCBiYWQgKSB7DQoJCQkJCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOw0KCQkJCQlpZiAoIHRvb2xiYXIgKSB7DQoJCQkJCQl0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOw0KCQkJCQkJaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOw0KCQkJCQkJaWQoInF1bml0LWZpbHRlci1taXNzaW5nIikuZGlzYWJsZWQgPSBudWxsOw0KCQkJCQl9DQoJCQkJfQ0KDQoJCQl9IGVsc2Ugew0KCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgew0KCQkJCQlpZiAoICFjb25maWcuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7DQoJCQkJCQliYWQrKzsNCgkJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsNCgkJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsNCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCg0KCQkJUVVuaXQudGVzdERvbmUoIHRlc3ROYW1lLCBiYWQsIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApOw0KDQoJCQlpZiAoICF3aW5kb3cuc2V0VGltZW91dCAmJiAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsNCgkJCQlkb25lKCk7DQoJCQl9DQoJCX0pOw0KDQoJCWlmICggd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5kb25lVGltZXIgKSB7DQoJCQljb25maWcuZG9uZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCgkJCQlpZiAoICFjb25maWcucXVldWUubGVuZ3RoICkgew0KCQkJCQlkb25lKCk7DQoJCQkJfSBlbHNlIHsNCgkJCQkJc3luY2hyb25pemUoIGRvbmUgKTsNCgkJCQl9DQoJCQl9LCAxMyk7DQoJCX0NCgl9LA0KCQ0KCS8qKg0KCSAqIFNwZWNpZnkgdGhlIG51bWJlciBvZiBleHBlY3RlZCBhc3NlcnRpb25zIHRvIGd1cmFudGVlIHRoYXQgZmFpbGVkIHRlc3QgKG5vIGFzc2VydGlvbnMgYXJlIHJ1biBhdCBhbGwpIGRvbid0IHNsaXAgdGhyb3VnaC4NCgkgKi8NCglleHBlY3Q6IGZ1bmN0aW9uKGFzc2VydHMpIHsNCgkJY29uZmlnLmV4cGVjdGVkID0gYXNzZXJ0czsNCgl9LA0KDQoJLyoqDQoJICogQXNzZXJ0cyB0cnVlLg0KCSAqIEBleGFtcGxlIG9rKCAiYXNkZmFzZGYiLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnMiICk7DQoJICovDQoJb2s6IGZ1bmN0aW9uKGEsIG1zZykgew0KCQlRVW5pdC5sb2coYSwgbXNnKTsNCg0KCQljb25maWcuYXNzZXJ0aW9ucy5wdXNoKHsNCgkJCXJlc3VsdDogISFhLA0KCQkJbWVzc2FnZTogbXNnDQoJCX0pOw0KCX0sDQoNCgkvKioNCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4NCgkgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuDQoJICoNCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkNCgkgKg0KCSAqIEBleGFtcGxlIGVxdWFsKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOw0KCSAqDQoJICogQHBhcmFtIE9iamVjdCBhY3R1YWwNCgkgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkDQoJICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkNCgkgKi8NCgllcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlwdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCg0KCW5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCXB1c2goZXhwZWN0ZWQgIT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KCQ0KCWRlZXBFcXVhbDogZnVuY3Rpb24oYSwgYiwgbWVzc2FnZSkgew0KCQlwdXNoKFFVbml0LmVxdWl2KGEsIGIpLCBhLCBiLCBtZXNzYWdlKTsNCgl9LA0KDQoJbm90RGVlcEVxdWFsOiBmdW5jdGlvbihhLCBiLCBtZXNzYWdlKSB7DQoJCXB1c2goIVFVbml0LmVxdWl2KGEsIGIpLCBhLCBiLCBtZXNzYWdlKTsNCgl9LA0KDQoJc3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJcHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KDQoJbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJcHVzaChleHBlY3RlZCAhPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsNCgl9LA0KCQ0KCXN0YXJ0OiBmdW5jdGlvbigpIHsNCgkJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcw0KCQlpZiAoIHdpbmRvdy5zZXRUaW1lb3V0ICkgew0KCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQoJCQkJaWYgKCBjb25maWcudGltZW91dCApIHsNCgkJCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsNCgkJCQl9DQoNCgkJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsNCgkJCQlwcm9jZXNzKCk7DQoJCQl9LCAxMyk7DQoJCX0gZWxzZSB7DQoJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsNCgkJCXByb2Nlc3MoKTsNCgkJfQ0KCX0sDQoJDQoJc3RvcDogZnVuY3Rpb24odGltZW91dCkgew0KCQljb25maWcuYmxvY2tpbmcgPSB0cnVlOw0KDQoJCWlmICggdGltZW91dCAmJiB3aW5kb3cuc2V0VGltZW91dCApIHsNCgkJCWNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7DQoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7DQoJCQkJUVVuaXQuc3RhcnQoKTsNCgkJCX0sIHRpbWVvdXQpOw0KCQl9DQoJfSwNCgkNCgkvKioNCgkgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4NCgkgKi8NCglyZXNldDogZnVuY3Rpb24oKSB7DQoJCWlmICggd2luZG93LmpRdWVyeSApIHsNCgkJCWpRdWVyeSgiI21haW4iKS5odG1sKCBjb25maWcuZml4dHVyZSApOw0KCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbCA9IHt9Ow0KCQkJalF1ZXJ5LmFqYXhTZXR0aW5ncyA9IGV4dGVuZCh7fSwgY29uZmlnLmFqYXhTZXR0aW5ncyk7DQoJCX0NCgl9LA0KCQ0KCS8qKg0KCSAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4NCgkgKg0KCSAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOw0KCSAqDQoJICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQ0KCSAqIEBwYXJhbSBTdHJpbmcgdHlwZQ0KCSAqLw0KCXRyaWdnZXJFdmVudDogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGV2ZW50ICkgew0KCQlpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgew0KCQkJZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsNCgkJCWV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywNCgkJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7DQoJCQllbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7DQoNCgkJfSBlbHNlIGlmICggZWxlbS5maXJlRXZlbnQgKSB7DQoJCQllbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOw0KCQl9DQoJfSwNCgkNCgkvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nDQoJaXM6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7DQoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIG9iaiApID09PSAiW29iamVjdCAiKyB0eXBlICsiXSI7DQoJfSwNCgkNCgkvLyBMb2dnaW5nIGNhbGxiYWNrcw0KCWRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCkge30sDQoJbG9nOiBmdW5jdGlvbihyZXN1bHQsIG1lc3NhZ2UpIHt9LA0KCXRlc3RTdGFydDogZnVuY3Rpb24obmFtZSkge30sDQoJdGVzdERvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30sDQoJbW9kdWxlU3RhcnQ6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkge30sDQoJbW9kdWxlRG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fQ0KfTsNCg0KLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGRlcHJlY2F0ZWQNClFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOw0KUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsNCg0KLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUNCnZhciBjb25maWcgPSB7DQoJLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bg0KCXF1ZXVlOiBbXSwNCg0KCS8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5DQoJYmxvY2tpbmc6IHRydWUNCn07DQoNCi8vIExvYWQgcGFyYW1hdGVycw0KKGZ1bmN0aW9uKCkgew0KCXZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDogIiIsIHByb3RvY29sOiAiZmlsZToiIH0sDQoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOw0KDQoJZm9yICggdmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrICkgew0KCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOw0KCQlpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vZ2xvYmFscyIgKSB7DQoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7DQoJCQlpLS07DQoJCQljb25maWcubm9nbG9iYWxzID0gdHJ1ZTsNCgkJfSBlbHNlIGlmICggR0VUUGFyYW1zW2ldLnNlYXJjaCgnPScpID4gLTEgKSB7DQoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7DQoJCQlpLS07DQoJCX0NCgl9DQoJDQoJLy8gcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycw0KCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOw0KCQ0KCS8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgcnVubmluZyB0aGUgdGVzdHMgZnJvbSBhIHNlcnZlciBvciBub3QNCglRVW5pdC5pc0xvY2FsID0gISEobG9jYXRpb24ucHJvdG9jb2wgPT09ICdmaWxlOicpOw0KfSkoKTsNCg0KLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJw0KLy8gb2JqZWN0IGV4aXN0cywgaW4gdGhhdCBjYXNlIHdlIGFzc3VtZSB3ZSdyZSBpbiBDb21tb25KUw0KaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHJlcXVpcmUgPT09ICJ1bmRlZmluZWQiICkgew0KCWV4dGVuZCh3aW5kb3csIFFVbml0KTsNCgl3aW5kb3cuUVVuaXQgPSBRVW5pdDsNCn0gZWxzZSB7DQoJZXh0ZW5kKGV4cG9ydHMsIFFVbml0KTsNCglleHBvcnRzLlFVbml0ID0gUVVuaXQ7DQp9DQoNCmlmICggdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgew0KCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsNCn0NCg0KYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgew0KCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUNCgl2YXIgb2xkY29uZmlnID0gZXh0ZW5kKHt9LCBjb25maWcpOw0KCVFVbml0LmluaXQoKTsNCglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOw0KDQoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoNCgl2YXIgdXNlckFnZW50ID0gaWQoInF1bml0LXVzZXJBZ2VudCIpOw0KCWlmICggdXNlckFnZW50ICkgew0KCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsNCgl9DQoJDQoJdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7DQoJaWYgKCB0b29sYmFyICkgew0KCQl0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7DQoJCQ0KCQl2YXIgZmlsdGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsNCgkJZmlsdGVyLnR5cGUgPSAiY2hlY2tib3giOw0KCQlmaWx0ZXIuaWQgPSAicXVuaXQtZmlsdGVyLXBhc3MiOw0KCQlmaWx0ZXIuZGlzYWJsZWQgPSB0cnVlOw0KCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOw0KCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7DQoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigicGFzcyIpID4gLTEgKSB7DQoJCQkJCWxpW2ldLnN0eWxlLmRpc3BsYXkgPSBmaWx0ZXIuY2hlY2tlZCA/ICJub25lIiA6ICIiOw0KCQkJCX0NCgkJCX0NCgkJfSk7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOw0KDQoJCXZhciBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7DQoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7DQoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7DQoNCgkJdmFyIG1pc3NpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOw0KCQltaXNzaW5nLnR5cGUgPSAiY2hlY2tib3giOw0KCQltaXNzaW5nLmlkID0gInF1bml0LWZpbHRlci1taXNzaW5nIjsNCgkJbWlzc2luZy5kaXNhYmxlZCA9IHRydWU7DQoJCWFkZEV2ZW50KCBtaXNzaW5nLCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOw0KCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7DQoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigiZmFpbCIpID4gLTEgJiYgbGlbaV0uaW5uZXJIVE1MLmluZGV4T2YoJ21pc3NpbmcgdGVzdCAtIHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUnKSA+IC0gMSApIHsNCgkJCQkJbGlbaV0ucGFyZW50Tm9kZS5wYXJlbnROb2RlLnN0eWxlLmRpc3BsYXkgPSBtaXNzaW5nLmNoZWNrZWQgPyAibm9uZSIgOiAiYmxvY2siOw0KCQkJCX0NCgkJCX0NCgkJfSk7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIG1pc3NpbmcgKTsNCg0KCQlsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7DQoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1taXNzaW5nIik7DQoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIG1pc3NpbmcgdGVzdHMgKHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUpIjsNCgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsNCgl9DQoNCgl2YXIgbWFpbiA9IGlkKCdtYWluJyk7DQoJaWYgKCBtYWluICkgew0KCQljb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOw0KCX0NCg0KCWlmICggd2luZG93LmpRdWVyeSApIHsNCgkJY29uZmlnLmFqYXhTZXR0aW5ncyA9IHdpbmRvdy5qUXVlcnkuYWpheFNldHRpbmdzOw0KCX0NCg0KCVFVbml0LnN0YXJ0KCk7DQp9KTsNCg0KZnVuY3Rpb24gZG9uZSgpIHsNCglpZiAoIGNvbmZpZy5kb25lVGltZXIgJiYgd2luZG93LmNsZWFyVGltZW91dCApIHsNCgkJd2luZG93LmNsZWFyVGltZW91dCggY29uZmlnLmRvbmVUaW1lciApOw0KCQljb25maWcuZG9uZVRpbWVyID0gbnVsbDsNCgl9DQoNCglpZiAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7DQoJCWNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpew0KCQkJaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsNCgkJCQlkb25lKCk7DQoJCQl9IGVsc2Ugew0KCQkJCXN5bmNocm9uaXplKCBkb25lICk7DQoJCQl9DQoJCX0sIDEzKTsNCg0KCQlyZXR1cm47DQoJfQ0KDQoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOw0KDQoJLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzDQoJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsNCgkJUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsNCgl9DQoNCgl2YXIgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLA0KCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLA0KCQlodG1sID0gWydUZXN0cyBjb21wbGV0ZWQgaW4gJywNCgkJK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywNCgkJJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwnPC9zcGFuPiBmYWlsZWQuJ10uam9pbignJyk7DQoNCglpZiAoIGJhbm5lciApIHsNCgkJYmFubmVyLmNsYXNzTmFtZSA9IChjb25maWcuc3RhdHMuYmFkID8gInF1bml0LWZhaWwiIDogInF1bml0LXBhc3MiKTsNCgl9DQoNCglpZiAoIHRlc3RzICkgewkNCgkJdmFyIHJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7DQoNCgkJaWYgKCAhcmVzdWx0ICkgew0KCQkJcmVzdWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOw0KCQkJcmVzdWx0LmlkID0gInF1bml0LXRlc3RyZXN1bHQiOw0KCQkJcmVzdWx0LmNsYXNzTmFtZSA9ICJyZXN1bHQiOw0KCQkJdGVzdHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHJlc3VsdCwgdGVzdHMubmV4dFNpYmxpbmcgKTsNCgkJfQ0KDQoJCXJlc3VsdC5pbm5lckhUTUwgPSBodG1sOw0KCX0NCg0KCVFVbml0LmRvbmUoIGNvbmZpZy5zdGF0cy5iYWQsIGNvbmZpZy5zdGF0cy5hbGwgKTsNCn0NCg0KZnVuY3Rpb24gdmFsaWRUZXN0KCBuYW1lICkgew0KCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLA0KCQlydW4gPSBmYWxzZTsNCg0KCWlmICggIWkgKSB7DQoJCXJldHVybiB0cnVlOw0KCX0NCgkNCgl3aGlsZSAoIGktLSApIHsNCgkJdmFyIGZpbHRlciA9IGNvbmZpZy5maWx0ZXJzW2ldLA0KCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7DQoNCgkJaWYgKCBub3QgKSB7DQoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7DQoJCX0NCg0KCQlpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsNCgkJCXJldHVybiAhbm90Ow0KCQl9DQoNCgkJaWYgKCBub3QgKSB7DQoJCQlydW4gPSB0cnVlOw0KCQl9DQoJfQ0KDQoJcmV0dXJuIHJ1bjsNCn0NCg0KZnVuY3Rpb24gcHVzaChyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgltZXNzYWdlID0gbWVzc2FnZSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOw0KCVFVbml0Lm9rKCByZXN1bHQsIHJlc3VsdCA/IG1lc3NhZ2UgKyAiOiAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSA6IG1lc3NhZ2UgKyAiLCBleHBlY3RlZDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkgKyAiIHJlc3VsdDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpICk7DQp9DQoNCmZ1bmN0aW9uIHN5bmNocm9uaXplKCBjYWxsYmFjayApIHsNCgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsNCg0KCWlmICggY29uZmlnLmF1dG9ydW4gJiYgIWNvbmZpZy5ibG9ja2luZyApIHsNCgkJcHJvY2VzcygpOw0KCX0NCn0NCg0KZnVuY3Rpb24gcHJvY2VzcygpIHsNCgl2YXIgc3RhcnQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOw0KDQoJd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7DQoJCWlmICggY29uZmlnLnVwZGF0ZVJhdGUgPD0gMCB8fCAoKChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSBzdGFydCkgPCBjb25maWcudXBkYXRlUmF0ZSkgKSB7DQoJCQljb25maWcucXVldWUuc2hpZnQoKSgpOw0KDQoJCX0gZWxzZSB7DQoJCQlzZXRUaW1lb3V0KCBwcm9jZXNzLCAxMyApOw0KCQkJYnJlYWs7DQoJCX0NCgl9DQp9DQoNCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7DQoJY29uZmlnLnBvbGx1dGlvbiA9IFtdOw0KCQ0KCWlmICggY29uZmlnLm5vZ2xvYmFscyApIHsNCgkJZm9yICggdmFyIGtleSBpbiB3aW5kb3cgKSB7DQoJCQljb25maWcucG9sbHV0aW9uLnB1c2goIGtleSApOw0KCQl9DQoJfQ0KfQ0KDQpmdW5jdGlvbiBjaGVja1BvbGx1dGlvbiggbmFtZSApIHsNCgl2YXIgb2xkID0gY29uZmlnLnBvbGx1dGlvbjsNCglzYXZlR2xvYmFsKCk7DQoJDQoJdmFyIG5ld0dsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsNCglpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsNCgkJb2soIGZhbHNlLCAiSW50cm9kdWNlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBuZXdHbG9iYWxzLmpvaW4oIiwgIikgKTsNCgkJY29uZmlnLmV4cGVjdGVkKys7DQoJfQ0KDQoJdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7DQoJaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgew0KCQlvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsNCgkJY29uZmlnLmV4cGVjdGVkKys7DQoJfQ0KfQ0KDQovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiDQpmdW5jdGlvbiBkaWZmKCBhLCBiICkgew0KCXZhciByZXN1bHQgPSBhLnNsaWNlKCk7DQoJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrICkgew0KCQlmb3IgKCB2YXIgaiA9IDA7IGogPCBiLmxlbmd0aDsgaisrICkgew0KCQkJaWYgKCByZXN1bHRbaV0gPT09IGJbal0gKSB7DQoJCQkJcmVzdWx0LnNwbGljZShpLCAxKTsNCgkJCQlpLS07DQoJCQkJYnJlYWs7DQoJCQl9DQoJCX0NCgl9DQoJcmV0dXJuIHJlc3VsdDsNCn0NCg0KZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7DQoJaWYgKCB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7DQoJCWNvbnNvbGUuZXJyb3IobWVzc2FnZSk7DQoJCWNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsNCgkJY29uc29sZS53YXJuKGNhbGxiYWNrLnRvU3RyaW5nKCkpOw0KDQoJfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsNCgkJb3BlcmEucG9zdEVycm9yKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2sudG9TdHJpbmcpOw0KCX0NCn0NCg0KZnVuY3Rpb24gZXh0ZW5kKGEsIGIpIHsNCglmb3IgKCB2YXIgcHJvcCBpbiBiICkgew0KCQlhW3Byb3BdID0gYltwcm9wXTsNCgl9DQoNCglyZXR1cm4gYTsNCn0NCg0KZnVuY3Rpb24gYWRkRXZlbnQoZWxlbSwgdHlwZSwgZm4pIHsNCglpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsNCgkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsNCgl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgew0KCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZm4gKTsNCgl9IGVsc2Ugew0KCQlmbigpOw0KCX0NCn0NCg0KZnVuY3Rpb24gaWQobmFtZSkgew0KCXJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJg0KCQlkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbmFtZSApOw0KfQ0KDQovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLg0KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYNCi8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdg0KLy8gQXV0aG9yOiBQaGlsaXBwZSBSYXRo6SA8cHJhdGhlQGdtYWlsLmNvbT4NClFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgew0KDQogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uDQogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMNCiAgICB2YXIgcGFyZW50cyA9IFtdOyAvLyBzdGFjayB0byBhdm9pZGluZyBsb29wcyBmcm9tIGNpcmN1bGFyIHJlZmVyZW5jaW5nDQoNCg0KICAgIC8vIERldGVybWluZSB3aGF0IGlzIG8uDQogICAgZnVuY3Rpb24gaG9veml0KG8pIHsNCiAgICAgICAgaWYgKFFVbml0LmlzKCJTdHJpbmciLCBvKSkgew0KICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOw0KICAgICAgICAgICAgDQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkJvb2xlYW4iLCBvKSkgew0KICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsNCg0KICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJOdW1iZXIiLCBvKSkgew0KDQogICAgICAgICAgICBpZiAoaXNOYU4obykpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIm5hbiI7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAidW5kZWZpbmVkIikgew0KICAgICAgICAgICAgcmV0dXJuICJ1bmRlZmluZWQiOw0KDQogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0DQogICAgICAgIH0gZWxzZSBpZiAobyA9PT0gbnVsbCkgew0KICAgICAgICAgICAgcmV0dXJuICJudWxsIjsNCg0KICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIFtdID09PSBvYmplY3QNCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIkFycmF5IiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOw0KICAgICAgICANCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBuZXcgRGF0ZSgpID09PSBvYmplY3QNCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIkRhdGUiLCBvKSkgew0KICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsNCg0KICAgICAgICAvLyBjb25zaWRlcjogLy4vIGluc3RhbmNlb2YgT2JqZWN0Ow0KICAgICAgICAvLyAgICAgICAgICAgLy4vIGluc3RhbmNlb2YgUmVnRXhwOw0KICAgICAgICAvLyAgICAgICAgICB0eXBlb2YgLy4vID09PSAiZnVuY3Rpb24iOyAvLyA9PiBmYWxzZSBpbiBJRSBhbmQgT3BlcmEsDQogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSBpbiBGRiBhbmQgU2FmYXJpDQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJSZWdFeHAiLCBvKSkgew0KICAgICAgICAgICAgcmV0dXJuICJyZWdleHAiOw0KDQogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7DQogICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7DQoNCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIkZ1bmN0aW9uIiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAiZnVuY3Rpb24iOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuDQogICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsNCiAgICAgICAgdmFyIHByb3AgPSBob296aXQobyk7DQogICAgICAgIGlmIChwcm9wKSB7DQogICAgICAgICAgICBpZiAoaG9veml0KGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZA0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KICAgIA0KICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7DQoNCiAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsDQogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsNCiAgICAgICAgICAgIGlmIChiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3Rvcikgew0KICAgICAgICAgICAgICAgIC8vIHRvIGNhdGNoIHNob3J0IGFubm90YWlvbiBWUyAnbmV3JyBhbm5vdGF0aW9uIG9mIGEgZGVjbGFyYXRpb24NCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsNCiAgICAgICAgICAgICAgICAvLyAgICAgIHZhciBqID0gbmV3IE51bWJlcigxKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PSBiOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYjsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksDQogICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LA0KICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LA0KICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwNCg0KICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKGIpOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgImRhdGUiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAicmVnZXhwIjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJg0KICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZg0KICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4NCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYNCiAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApDQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwNCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkNCiAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uICgpIHsNCiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOw0KICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJg0KICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOw0KICAgICAgICAgICAgICAgIHZhciBsZW47DQoNCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUNCiAgICAgICAgICAgICAgICBpZiAoICEgKGhvb3ppdChiKSA9PT0gImFycmF5IikpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0gICANCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsNCiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXINCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzDQogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOw0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgew0KICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspew0KICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSl7DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7Ly9kb250IHJld2FsayBhcnJheQ0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7DQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgew0KICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOw0KICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0DQogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncw0KDQogICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YNCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMNCiAgICAgICAgICAgICAgICBjYWxsZXJzLnB1c2goYS5jb25zdHJ1Y3Rvcik7DQogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcw0KICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXANCiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7IC8vZG9uJ3QgZ28gZG93biB0aGUgc2FtZSBwYXRoIHR3aWNlDQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcw0KDQogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7DQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lDQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsNCg0KICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7DQogICAgICAgICAgICAgICAgICAgIGJQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYidzIHByb3BlcnRpZXMNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBFbnN1cmVzIGlkZW50aWNhbCBwcm9wZXJ0aWVzIG5hbWUNCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgfSgpOw0KDQogICAgaW5uZXJFcXVpdiA9IGZ1bmN0aW9uICgpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzDQogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7DQogICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbg0KICAgICAgICB9DQoNCiAgICAgICAgcmV0dXJuIChmdW5jdGlvbiAoYSwgYikgew0KICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbg0KICAgICAgICAgICAgfSBlbHNlIGlmIChhID09PSBudWxsIHx8IGIgPT09IG51bGwgfHwgdHlwZW9mIGEgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fCBob296aXQoYSkgIT09IGhvb3ppdChiKSkgew0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRDYWxsYmFja3MoYSwgY2FsbGJhY2tzLCBbYiwgYV0pOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gd2l0aCAoMS4ubikgYXJndW1lbnRzDQogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsNCiAgICB9Ow0KDQogICAgcmV0dXJuIGlubmVyRXF1aXY7DQoNCn0oKTsNCg0KLyoqDQogKiBqc0R1bXANCiAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQ0KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkNCiAqIERhdGU6IDUvMTUvMjAwOA0KICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuDQogKiBAdmVyc2lvbiAxLjAuMA0KICogQGF1dGhvciBBcmllbCBGbGVzbGVyDQogKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9DQogKi8NClFVbml0LmpzRHVtcCA9IChmdW5jdGlvbigpIHsNCglmdW5jdGlvbiBxdW90ZSggc3RyICkgew0KCQlyZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7DQoJfTsNCglmdW5jdGlvbiBsaXRlcmFsKCBvICkgew0KCQlyZXR1cm4gbyArICcnOwkNCgl9Ow0KCWZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgew0KCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwNCgkJCWJhc2UgPSBqc0R1bXAuaW5kZW50KCksDQoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7DQoJCWlmICggYXJyLmpvaW4gKQ0KCQkJYXJyID0gYXJyLmpvaW4oICcsJyArIHMgKyBpbm5lciApOw0KCQlpZiAoICFhcnIgKQ0KCQkJcmV0dXJuIHByZSArIHBvc3Q7DQoJCXJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsNCgl9Ow0KCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7DQoJCXZhciBpID0gYXJyLmxlbmd0aCwJcmV0ID0gQXJyYXkoaSk7CQkJCQkNCgkJdGhpcy51cCgpOw0KCQl3aGlsZSAoIGktLSApDQoJCQlyZXRbaV0gPSB0aGlzLnBhcnNlKCBhcnJbaV0gKTsJCQkJDQoJCXRoaXMuZG93bigpOw0KCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOw0KCX07DQoJDQoJdmFyIHJlTmFtZSA9IC9eZnVuY3Rpb24gKFx3KykvOw0KCQ0KCXZhciBqc0R1bXAgPSB7DQoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlDQoJCQl2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsNCgkJCXR5cGUgPSB0eXBlb2YgcGFyc2VyOwkJCQ0KCQkJDQoJCQlyZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwoIHRoaXMsIG9iaiApIDoNCgkJCQkgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoNCgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7DQoJCX0sDQoJCXR5cGVPZjpmdW5jdGlvbiggb2JqICkgew0KCQkJdmFyIHR5cGU7DQoJCQlpZiAoIG9iaiA9PT0gbnVsbCApIHsNCgkJCQl0eXBlID0gIm51bGwiOw0KCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgew0KCQkJCXR5cGUgPSAidW5kZWZpbmVkIjsNCgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG9iaikpIHsNCgkJCQl0eXBlID0gInJlZ2V4cCI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJEYXRlIiwgb2JqKSkgew0KCQkJCXR5cGUgPSAiZGF0ZSI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsNCgkJCQl0eXBlID0gImZ1bmN0aW9uIjsNCgkJCX0gZWxzZSBpZiAob2JqLnNldEludGVydmFsICYmIG9iai5kb2N1bWVudCAmJiAhb2JqLm5vZGVUeXBlKSB7DQoJCQkJdHlwZSA9ICJ3aW5kb3ciOw0KCQkJfSBlbHNlIGlmIChvYmoubm9kZVR5cGUgPT09IDkpIHsNCgkJCQl0eXBlID0gImRvY3VtZW50IjsNCgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7DQoJCQkJdHlwZSA9ICJub2RlIjsNCgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIG9iai5sZW5ndGggPj0gMCkgew0KCQkJCXR5cGUgPSAiYXJyYXkiOw0KCQkJfSBlbHNlIHsNCgkJCQl0eXBlID0gdHlwZW9mIG9iajsNCgkJCX0NCgkJCXJldHVybiB0eXBlOw0KCQl9LA0KCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7DQoJCQlyZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsNCgkJfSwNCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZw0KCQkJaWYgKCAhdGhpcy5tdWx0aWxpbmUgKQ0KCQkJCXJldHVybiAnJzsNCgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7DQoJCQlpZiAoIHRoaXMuSFRNTCApDQoJCQkJY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csJyAgICcpLnJlcGxhY2UoLyAvZywnJm5ic3A7Jyk7DQoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7DQoJCX0sDQoJCXVwOmZ1bmN0aW9uKCBhICkgew0KCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsNCgkJfSwNCgkJZG93bjpmdW5jdGlvbiggYSApIHsNCgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7DQoJCX0sDQoJCXNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgew0KCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOw0KCQl9LA0KCQkvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0NCgkJcXVvdGU6cXVvdGUsIA0KCQlsaXRlcmFsOmxpdGVyYWwsDQoJCWpvaW46am9pbiwNCgkJLy8NCgkJX2RlcHRoXzogMSwNCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXINCgkJcGFyc2Vyczp7DQoJCQl3aW5kb3c6ICdbV2luZG93XScsDQoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLA0KCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuDQoJCQl1bmtub3duOiAnW1Vua25vd25dJywNCgkJCSdudWxsJzonbnVsbCcsDQoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsDQoJCQknZnVuY3Rpb24nOmZ1bmN0aW9uKCBmbiApIHsNCgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywNCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFDQoJCQkJaWYgKCBuYW1lICkNCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7DQoJCQkJcmV0ICs9ICcoJzsNCgkJCQkNCgkJCQlyZXQgPSBbIHJldCwgdGhpcy5wYXJzZSggZm4sICdmdW5jdGlvbkFyZ3MnICksICcpeyddLmpvaW4oJycpOw0KCQkJCXJldHVybiBqb2luKCByZXQsIHRoaXMucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsNCgkJCX0sDQoJCQlhcnJheTogYXJyYXksDQoJCQlub2RlbGlzdDogYXJyYXksDQoJCQlhcmd1bWVudHM6IGFycmF5LA0KCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7DQoJCQkJdmFyIHJldCA9IFsgXTsNCgkJCQl0aGlzLnVwKCk7DQoJCQkJZm9yICggdmFyIGtleSBpbiBtYXAgKQ0KCQkJCQlyZXQucHVzaCggdGhpcy5wYXJzZShrZXksJ2tleScpICsgJzogJyArIHRoaXMucGFyc2UobWFwW2tleV0pICk7DQoJCQkJdGhpcy5kb3duKCk7DQoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsNCgkJCX0sDQoJCQlub2RlOmZ1bmN0aW9uKCBub2RlICkgew0KCQkJCXZhciBvcGVuID0gdGhpcy5IVE1MID8gJyZsdDsnIDogJzwnLA0KCQkJCQljbG9zZSA9IHRoaXMuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsNCgkJCQkJDQoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwNCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsNCgkJCQkJDQoJCQkJZm9yICggdmFyIGEgaW4gdGhpcy5ET01BdHRycyApIHsNCgkJCQkJdmFyIHZhbCA9IG5vZGVbdGhpcy5ET01BdHRyc1thXV07DQoJCQkJCWlmICggdmFsICkNCgkJCQkJCXJldCArPSAnICcgKyBhICsgJz0nICsgdGhpcy5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOw0KCQkJCX0NCgkJCQlyZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7DQoJCQl9LA0KCQkJZnVuY3Rpb25BcmdzOmZ1bmN0aW9uKCBmbiApIHsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbg0KCQkJCXZhciBsID0gZm4ubGVuZ3RoOw0KCQkJCWlmICggIWwgKSByZXR1cm4gJyc7CQkJCQ0KCQkJCQ0KCQkJCXZhciBhcmdzID0gQXJyYXkobCk7DQoJCQkJd2hpbGUgKCBsLS0gKQ0KCQkJCQlhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJw0KCQkJCXJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7DQoJCQl9LA0KCQkJa2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcA0KCQkJZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uDQoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlDQoJCQlzdHJpbmc6cXVvdGUsDQoJCQlkYXRlOnF1b3RlLA0KCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgNCgkJCW51bWJlcjpsaXRlcmFsLA0KCQkJJ2Jvb2xlYW4nOmxpdGVyYWwNCgkJfSwNCgkJRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lDQoJCQlpZDonaWQnLA0KCQkJbmFtZTonbmFtZScsDQoJCQknY2xhc3MnOidjbGFzc05hbWUnDQoJCX0sDQoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQ0KCQlpbmRlbnRDaGFyOicgICAnLC8vaW5kZW50YXRpb24gdW5pdA0KCQltdWx0aWxpbmU6ZmFsc2UgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuDQoJfTsNCg0KCXJldHVybiBqc0R1bXA7DQp9KSgpOw0KDQp9KSh0aGlzKTs=",
                "body": "LyoNCiAqIFFVbml0IC0gQSBKYXZhU2NyaXB0IFVuaXQgVGVzdGluZyBGcmFtZXdvcmsNCiAqIA0KICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdA0KICoNCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBK9nJuIFphZWZmZXJlcg0KICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpDQogKiBhbmQgR1BMIChHUEwtTElDRU5TRS50eHQpIGxpY2Vuc2VzLg0KICovDQoNCihmdW5jdGlvbih3aW5kb3cpIHsNCg0KdmFyIFFVbml0ID0gew0KDQoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiBvcHRpb25zDQoJaW5pdDogZnVuY3Rpb24oKSB7DQoJCWNvbmZpZyA9IHsNCgkJCXN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sDQoJCQltb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LA0KCQkJc3RhcnRlZDogK25ldyBEYXRlLA0KCQkJdXBkYXRlUmF0ZTogMTAwMCwNCgkJCWJsb2NraW5nOiBmYWxzZSwNCgkJCWF1dG9ydW46IGZhbHNlLA0KCQkJYXNzZXJ0aW9uczogW10sDQoJCQlmaWx0ZXJzOiBbXSwNCgkJCXF1ZXVlOiBbXQ0KCQl9Ow0KDQoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLA0KCQkJYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLA0KCQkJcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsNCg0KCQlpZiAoIHRlc3RzICkgew0KCQkJdGVzdHMuaW5uZXJIVE1MID0gIiI7DQoJCX0NCg0KCQlpZiAoIGJhbm5lciApIHsNCgkJCWJhbm5lci5jbGFzc05hbWUgPSAiIjsNCgkJfQ0KDQoJCWlmICggcmVzdWx0ICkgew0KCQkJcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHJlc3VsdCApOw0KCQl9DQoJfSwNCgkNCgkvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMNCgltb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgew0KCQljb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7DQoNCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7DQoJCQlpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgew0KCQkJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7DQoJCQl9DQoNCgkJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsNCgkJCWNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7DQoJCQljb25maWcubW9kdWxlU3RhdHMgPSB7IGFsbDogMCwgYmFkOiAwIH07DQoNCgkJCVFVbml0Lm1vZHVsZVN0YXJ0KCBuYW1lLCB0ZXN0RW52aXJvbm1lbnQgKTsNCgkJfSk7DQoJfSwNCg0KCWFzeW5jVGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaykgew0KCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7DQoJCQljYWxsYmFjayA9IGV4cGVjdGVkOw0KCQkJZXhwZWN0ZWQgPSAwOw0KCQl9DQoNCgkJUVVuaXQudGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCB0cnVlKTsNCgl9LA0KCQ0KCXRlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIGFzeW5jKSB7DQoJCXZhciBuYW1lID0gdGVzdE5hbWUsIHRlc3RFbnZpcm9ubWVudCwgdGVzdEVudmlyb25tZW50QXJnOw0KDQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsNCgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7DQoJCQlleHBlY3RlZCA9IG51bGw7DQoJCX0NCgkJLy8gaXMgMm5kIGFyZ3VtZW50IGEgdGVzdEVudmlyb25tZW50Pw0KCQlpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsNCgkJCXRlc3RFbnZpcm9ubWVudEFyZyA9ICBleHBlY3RlZDsNCgkJCWV4cGVjdGVkID0gbnVsbDsNCgkJfQ0KDQoJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7DQoJCQluYW1lID0gY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiIG1vZHVsZTogIiArIG5hbWU7DQoJCX0NCg0KCQlpZiAoICF2YWxpZFRlc3QobmFtZSkgKSB7DQoJCQlyZXR1cm47DQoJCX0NCg0KCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsNCgkJCVFVbml0LnRlc3RTdGFydCggdGVzdE5hbWUgKTsNCg0KCQkJdGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsNCgkJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwNCgkJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7fQ0KCQkJfSwgY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7DQoJCQlpZiAodGVzdEVudmlyb25tZW50QXJnKSB7DQoJCQkJZXh0ZW5kKHRlc3RFbnZpcm9ubWVudCx0ZXN0RW52aXJvbm1lbnRBcmcpOw0KCQkJfQ0KDQoJCQkvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudA0KCQkJUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7DQoJCQkNCgkJCWNvbmZpZy5hc3NlcnRpb25zID0gW107DQoJCQljb25maWcuZXhwZWN0ZWQgPSBleHBlY3RlZDsNCg0KCQkJdHJ5IHsNCgkJCQlpZiAoICFjb25maWcucG9sbHV0aW9uICkgew0KCQkJCQlzYXZlR2xvYmFsKCk7DQoJCQkJfQ0KDQoJCQkJdGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGVzdEVudmlyb25tZW50KTsNCgkJCX0gY2F0Y2goZSkgew0KCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsNCgkJCX0NCg0KCQkJaWYgKCBhc3luYyApIHsNCgkJCQlRVW5pdC5zdG9wKCk7DQoJCQl9DQoNCgkJCXRyeSB7DQoJCQkJY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOw0KCQkJfSBjYXRjaChlKSB7DQoJCQkJZmFpbCgiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCBjYWxsYmFjayk7DQoJCQkJUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSApOw0KCQkJCS8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5DQoJCQkJc2F2ZUdsb2JhbCgpOw0KDQoJCQkJLy8gUmVzdGFydCB0aGUgdGVzdHMgaWYgdGhleSdyZSBibG9ja2luZw0KCQkJCWlmICggY29uZmlnLmJsb2NraW5nICkgew0KCQkJCQlzdGFydCgpOw0KCQkJCX0NCgkJCX0NCgkJfSk7DQoNCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7DQoJCQl0cnkgew0KCQkJCWNoZWNrUG9sbHV0aW9uKCk7DQoJCQkJdGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGVzdEVudmlyb25tZW50KTsNCgkJCX0gY2F0Y2goZSkgew0KCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsNCgkJCX0NCg0KCQkJdHJ5IHsNCgkJCQlRVW5pdC5yZXNldCgpOw0KCQkJfSBjYXRjaChlKSB7DQoJCQkJZmFpbCgicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyBuYW1lICsgIiwgZXhjZXB0aW9uIGFuZCByZXNldCBmbiBmb2xsb3dzIiwgZSwgcmVzZXQpOw0KCQkJfQ0KDQoJCQlpZiAoIGNvbmZpZy5leHBlY3RlZCAmJiBjb25maWcuZXhwZWN0ZWQgIT0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICkgew0KCQkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsNCgkJCX0NCg0KCQkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwLA0KCQkJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7DQoNCgkJCWNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOw0KCQkJY29uZmlnLm1vZHVsZVN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7DQoNCgkJCWlmICggdGVzdHMgKSB7DQoJCQkJdmFyIG9sICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7DQoJCQkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsNCg0KCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgew0KCQkJCQl2YXIgYXNzZXJ0aW9uID0gY29uZmlnLmFzc2VydGlvbnNbaV07DQoNCgkJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCgkJCQkJbGkuY2xhc3NOYW1lID0gYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIjsNCgkJCQkJbGkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgIihubyBtZXNzYWdlKSIpKTsNCgkJCQkJb2wuYXBwZW5kQ2hpbGQoIGxpICk7DQoNCgkJCQkJaWYgKCBhc3NlcnRpb24ucmVzdWx0ICkgew0KCQkJCQkJZ29vZCsrOw0KCQkJCQl9IGVsc2Ugew0KCQkJCQkJYmFkKys7DQoJCQkJCQljb25maWcuc3RhdHMuYmFkKys7DQoJCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7DQoJCQkJCX0NCgkJCQl9DQoNCgkJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOw0KCQkJCWIuaW5uZXJIVE1MID0gbmFtZSArICIgPGIgc3R5bGU9J2NvbG9yOmJsYWNrOyc+KDxiIGNsYXNzPSdmYWlsJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzJz4iICsgZ29vZCArICI8L2I+LCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsNCgkJCQkNCgkJCQlhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsNCgkJCQkJdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5Ow0KCQkJCQluZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOw0KCQkJCX0pOw0KCQkJCQ0KCQkJCWFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKGUpIHsNCgkJCQkJdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50Ow0KCQkJCQlpZiAoIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic3Ryb25nIiApIHsNCgkJCQkJCXZhciB0ZXh0ID0gIiIsIG5vZGUgPSB0YXJnZXQuZmlyc3RDaGlsZDsNCg0KCQkJCQkJd2hpbGUgKCBub2RlLm5vZGVUeXBlID09PSAzICkgew0KCQkJCQkJCXRleHQgKz0gbm9kZS5ub2RlVmFsdWU7DQoJCQkJCQkJbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7DQoJCQkJCQl9DQoNCgkJCQkJCXRleHQgPSB0ZXh0LnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKTsNCg0KCQkJCQkJaWYgKCB3aW5kb3cubG9jYXRpb24gKSB7DQoJCQkJCQkJd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCh0ZXh0KTsNCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0pOw0KDQoJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsNCgkJCQlsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7DQoJCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsNCgkJCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsNCgkJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsNCg0KCQkJCWlmICggYmFkICkgew0KCQkJCQl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsNCgkJCQkJaWYgKCB0b29sYmFyICkgew0KCQkJCQkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsNCgkJCQkJCWlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmRpc2FibGVkID0gbnVsbDsNCgkJCQkJCWlkKCJxdW5pdC1maWx0ZXItbWlzc2luZyIpLmRpc2FibGVkID0gbnVsbDsNCgkJCQkJfQ0KCQkJCX0NCg0KCQkJfSBlbHNlIHsNCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsNCgkJCQkJaWYgKCAhY29uZmlnLmFzc2VydGlvbnNbaV0ucmVzdWx0ICkgew0KCQkJCQkJYmFkKys7DQoJCQkJCQljb25maWcuc3RhdHMuYmFkKys7DQoJCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7DQoJCQkJCX0NCgkJCQl9DQoJCQl9DQoNCgkJCVFVbml0LnRlc3REb25lKCB0ZXN0TmFtZSwgYmFkLCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKTsNCg0KCQkJaWYgKCAhd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7DQoJCQkJZG9uZSgpOw0KCQkJfQ0KCQl9KTsNCg0KCQlpZiAoIHdpbmRvdy5zZXRUaW1lb3V0ICYmICFjb25maWcuZG9uZVRpbWVyICkgew0KCQkJY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7DQoJCQkJaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsNCgkJCQkJZG9uZSgpOw0KCQkJCX0gZWxzZSB7DQoJCQkJCXN5bmNocm9uaXplKCBkb25lICk7DQoJCQkJfQ0KCQkJfSwgMTMpOw0KCQl9DQoJfSwNCgkNCgkvKioNCgkgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guDQoJICovDQoJZXhwZWN0OiBmdW5jdGlvbihhc3NlcnRzKSB7DQoJCWNvbmZpZy5leHBlY3RlZCA9IGFzc2VydHM7DQoJfSwNCg0KCS8qKg0KCSAqIEFzc2VydHMgdHJ1ZS4NCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOw0KCSAqLw0KCW9rOiBmdW5jdGlvbihhLCBtc2cpIHsNCgkJUVVuaXQubG9nKGEsIG1zZyk7DQoNCgkJY29uZmlnLmFzc2VydGlvbnMucHVzaCh7DQoJCQlyZXN1bHQ6ICEhYSwNCgkJCW1lc3NhZ2U6IG1zZw0KCQl9KTsNCgl9LA0KDQoJLyoqDQoJICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuDQoJICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLg0KCSAqDQoJICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApDQoJICoNCgkgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsNCgkgKg0KCSAqIEBwYXJhbSBPYmplY3QgYWN0dWFsDQoJICogQHBhcmFtIE9iamVjdCBleHBlY3RlZA0KCSAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpDQoJICovDQoJZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsNCgkJcHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOw0KCX0sDQoNCglub3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgew0KCQlwdXNoKGV4cGVjdGVkICE9IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCgkNCglkZWVwRXF1YWw6IGZ1bmN0aW9uKGEsIGIsIG1lc3NhZ2UpIHsNCgkJcHVzaChRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7DQoJfSwNCg0KCW5vdERlZXBFcXVhbDogZnVuY3Rpb24oYSwgYiwgbWVzc2FnZSkgew0KCQlwdXNoKCFRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7DQoJfSwNCg0KCXN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCXB1c2goZXhwZWN0ZWQgPT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCg0KCW5vdFN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJCXB1c2goZXhwZWN0ZWQgIT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7DQoJfSwNCgkNCglzdGFydDogZnVuY3Rpb24oKSB7DQoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MNCgkJaWYgKCB3aW5kb3cuc2V0VGltZW91dCApIHsNCgkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KCQkJCWlmICggY29uZmlnLnRpbWVvdXQgKSB7DQoJCQkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7DQoJCQkJfQ0KDQoJCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoJCQkJcHJvY2VzcygpOw0KCQkJfSwgMTMpOw0KCQl9IGVsc2Ugew0KCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7DQoJCQlwcm9jZXNzKCk7DQoJCX0NCgl9LA0KCQ0KCXN0b3A6IGZ1bmN0aW9uKHRpbWVvdXQpIHsNCgkJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsNCg0KCQlpZiAoIHRpbWVvdXQgJiYgd2luZG93LnNldFRpbWVvdXQgKSB7DQoJCQljb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgew0KCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOw0KCQkJCVFVbml0LnN0YXJ0KCk7DQoJCQl9LCB0aW1lb3V0KTsNCgkJfQ0KCX0sDQoJDQoJLyoqDQoJICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uDQoJICovDQoJcmVzZXQ6IGZ1bmN0aW9uKCkgew0KCQlpZiAoIHdpbmRvdy5qUXVlcnkgKSB7DQoJCQlqUXVlcnkoIiNtYWluIikuaHRtbCggY29uZmlnLmZpeHR1cmUgKTsNCgkJCWpRdWVyeS5ldmVudC5nbG9iYWwgPSB7fTsNCgkJCWpRdWVyeS5hamF4U2V0dGluZ3MgPSBleHRlbmQoe30sIGNvbmZpZy5hamF4U2V0dGluZ3MpOw0KCQl9DQoJfSwNCgkNCgkvKioNCgkgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuDQoJICoNCgkgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsNCgkgKg0KCSAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0NCgkgKiBAcGFyYW0gU3RyaW5nIHR5cGUNCgkgKi8NCgl0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsNCgkJaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudCApIHsNCgkJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7DQoJCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsDQoJCQkJMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOw0KCQkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOw0KDQoJCX0gZWxzZSBpZiAoIGVsZW0uZmlyZUV2ZW50ICkgew0KCQkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsNCgkJfQ0KCX0sDQoJDQoJLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZw0KCWlzOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgew0KCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBvYmogKSA9PT0gIltvYmplY3QgIisgdHlwZSArIl0iOw0KCX0sDQoJDQoJLy8gTG9nZ2luZyBjYWxsYmFja3MNCglkb25lOiBmdW5jdGlvbihmYWlsdXJlcywgdG90YWwpIHt9LA0KCWxvZzogZnVuY3Rpb24ocmVzdWx0LCBtZXNzYWdlKSB7fSwNCgl0ZXN0U3RhcnQ6IGZ1bmN0aW9uKG5hbWUpIHt9LA0KCXRlc3REb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9LA0KCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LA0KCW1vZHVsZURvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30NCn07DQoNCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkDQpRVW5pdC5lcXVhbHMgPSBRVW5pdC5lcXVhbDsNClFVbml0LnNhbWUgPSBRVW5pdC5kZWVwRXF1YWw7DQoNCi8vIE1haW50YWluIGludGVybmFsIHN0YXRlDQp2YXIgY29uZmlnID0gew0KCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4NCglxdWV1ZTogW10sDQoNCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQ0KCWJsb2NraW5nOiB0cnVlDQp9Ow0KDQovLyBMb2FkIHBhcmFtYXRlcnMNCihmdW5jdGlvbigpIHsNCgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LA0KCQlHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsNCg0KCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsNCgkJR0VUUGFyYW1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KCBHRVRQYXJhbXNbaV0gKTsNCgkJaWYgKCBHRVRQYXJhbXNbaV0gPT09ICJub2dsb2JhbHMiICkgew0KCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOw0KCQkJaS0tOw0KCQkJY29uZmlnLm5vZ2xvYmFscyA9IHRydWU7DQoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xICkgew0KCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOw0KCQkJaS0tOw0KCQl9DQoJfQ0KCQ0KCS8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMNCgljb25maWcuZmlsdGVycyA9IEdFVFBhcmFtczsNCgkNCgkvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90DQoJUVVuaXQuaXNMb2NhbCA9ICEhKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKTsNCn0pKCk7DQoNCi8vIEV4cG9zZSB0aGUgQVBJIGFzIGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycNCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMNCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsNCglleHRlbmQod2luZG93LCBRVW5pdCk7DQoJd2luZG93LlFVbml0ID0gUVVuaXQ7DQp9IGVsc2Ugew0KCWV4dGVuZChleHBvcnRzLCBRVW5pdCk7DQoJZXhwb3J0cy5RVW5pdCA9IFFVbml0Ow0KfQ0KDQppZiAoIHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsNCgljb25maWcuYXV0b3J1biA9IHRydWU7DQp9DQoNCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsNCgkvLyBJbml0aWFsaXplIHRoZSBjb25maWcsIHNhdmluZyB0aGUgZXhlY3V0aW9uIHF1ZXVlDQoJdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsNCglRVW5pdC5pbml0KCk7DQoJZXh0ZW5kKGNvbmZpZywgb2xkY29uZmlnKTsNCg0KCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOw0KDQoJdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsNCglpZiAoIHVzZXJBZ2VudCApIHsNCgkJdXNlckFnZW50LmlubmVySFRNTCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7DQoJfQ0KCQ0KCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOw0KCWlmICggdG9vbGJhciApIHsNCgkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOw0KCQkNCgkJdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7DQoJCWZpbHRlci50eXBlID0gImNoZWNrYm94IjsNCgkJZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsNCgkJZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsNCgkJYWRkRXZlbnQoIGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24oKSB7DQoJCQl2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsNCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgew0KCQkJCWlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoInBhc3MiKSA+IC0xICkgew0KCQkJCQlsaVtpXS5zdHlsZS5kaXNwbGF5ID0gZmlsdGVyLmNoZWNrZWQgPyAibm9uZSIgOiAiIjsNCgkJCQl9DQoJCQl9DQoJCX0pOw0KCQl0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsNCg0KCQl2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOw0KCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOw0KCQlsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBwYXNzZWQgdGVzdHMiOw0KCQl0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOw0KDQoJCXZhciBtaXNzaW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsNCgkJbWlzc2luZy50eXBlID0gImNoZWNrYm94IjsNCgkJbWlzc2luZy5pZCA9ICJxdW5pdC1maWx0ZXItbWlzc2luZyI7DQoJCW1pc3NpbmcuZGlzYWJsZWQgPSB0cnVlOw0KCQlhZGRFdmVudCggbWlzc2luZywgImNsaWNrIiwgZnVuY3Rpb24oKSB7DQoJCQl2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsNCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgew0KCQkJCWlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoImZhaWwiKSA+IC0xICYmIGxpW2ldLmlubmVySFRNTC5pbmRleE9mKCdtaXNzaW5nIHRlc3QgLSB1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlJykgPiAtIDEgKSB7DQoJCQkJCWxpW2ldLnBhcmVudE5vZGUucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gbWlzc2luZy5jaGVja2VkID8gIm5vbmUiIDogImJsb2NrIjsNCgkJCQl9DQoJCQl9DQoJCX0pOw0KCQl0b29sYmFyLmFwcGVuZENoaWxkKCBtaXNzaW5nICk7DQoNCgkJbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOw0KCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItbWlzc2luZyIpOw0KCQlsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBtaXNzaW5nIHRlc3RzICh1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlKSI7DQoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7DQoJfQ0KDQoJdmFyIG1haW4gPSBpZCgnbWFpbicpOw0KCWlmICggbWFpbiApIHsNCgkJY29uZmlnLmZpeHR1cmUgPSBtYWluLmlubmVySFRNTDsNCgl9DQoNCglpZiAoIHdpbmRvdy5qUXVlcnkgKSB7DQoJCWNvbmZpZy5hamF4U2V0dGluZ3MgPSB3aW5kb3cualF1ZXJ5LmFqYXhTZXR0aW5nczsNCgl9DQoNCglRVW5pdC5zdGFydCgpOw0KfSk7DQoNCmZ1bmN0aW9uIGRvbmUoKSB7DQoJaWYgKCBjb25maWcuZG9uZVRpbWVyICYmIHdpbmRvdy5jbGVhclRpbWVvdXQgKSB7DQoJCXdpbmRvdy5jbGVhclRpbWVvdXQoIGNvbmZpZy5kb25lVGltZXIgKTsNCgkJY29uZmlnLmRvbmVUaW1lciA9IG51bGw7DQoJfQ0KDQoJaWYgKCBjb25maWcucXVldWUubGVuZ3RoICkgew0KCQljb25maWcuZG9uZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKXsNCgkJCWlmICggIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7DQoJCQkJZG9uZSgpOw0KCQkJfSBlbHNlIHsNCgkJCQlzeW5jaHJvbml6ZSggZG9uZSApOw0KCQkJfQ0KCQl9LCAxMyk7DQoNCgkJcmV0dXJuOw0KCX0NCg0KCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsNCg0KCS8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cw0KCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7DQoJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7DQoJfQ0KDQoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwNCgkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwNCgkJaHRtbCA9IFsnVGVzdHMgY29tcGxldGVkIGluICcsDQoJCStuZXcgRGF0ZSAtIGNvbmZpZy5zdGFydGVkLCAnIG1pbGxpc2Vjb25kcy48YnIvPicsDQoJCSc8c3BhbiBjbGFzcz0icGFzc2VkIj4nLCBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9InRvdGFsIj4nLCBjb25maWcuc3RhdHMuYWxsLCAnPC9zcGFuPiBwYXNzZWQsIDxzcGFuIGNsYXNzPSJmYWlsZWQiPicsIGNvbmZpZy5zdGF0cy5iYWQsJzwvc3Bhbj4gZmFpbGVkLiddLmpvaW4oJycpOw0KDQoJaWYgKCBiYW5uZXIgKSB7DQoJCWJhbm5lci5jbGFzc05hbWUgPSAoY29uZmlnLnN0YXRzLmJhZCA/ICJxdW5pdC1mYWlsIiA6ICJxdW5pdC1wYXNzIik7DQoJfQ0KDQoJaWYgKCB0ZXN0cyApIHsJDQoJCXZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOw0KDQoJCWlmICggIXJlc3VsdCApIHsNCgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsNCgkJCXJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsNCgkJCXJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsNCgkJCXRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7DQoJCX0NCg0KCQlyZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsNCgl9DQoNCglRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7DQp9DQoNCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsNCgl2YXIgaSA9IGNvbmZpZy5maWx0ZXJzLmxlbmd0aCwNCgkJcnVuID0gZmFsc2U7DQoNCglpZiAoICFpICkgew0KCQlyZXR1cm4gdHJ1ZTsNCgl9DQoJDQoJd2hpbGUgKCBpLS0gKSB7DQoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwNCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOw0KDQoJCWlmICggbm90ICkgew0KCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOw0KCQl9DQoNCgkJaWYgKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPT0gLTEgKSB7DQoJCQlyZXR1cm4gIW5vdDsNCgkJfQ0KDQoJCWlmICggbm90ICkgew0KCQkJcnVuID0gdHJ1ZTsNCgkJfQ0KCX0NCg0KCXJldHVybiBydW47DQp9DQoNCmZ1bmN0aW9uIHB1c2gocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7DQoJbWVzc2FnZSA9IG1lc3NhZ2UgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsNCglRVW5pdC5vayggcmVzdWx0LCByZXN1bHQgPyBtZXNzYWdlICsgIjogIiArIFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkgOiBtZXNzYWdlICsgIiwgZXhwZWN0ZWQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpICsgIiByZXN1bHQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSApOw0KfQ0KDQpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7DQoJY29uZmlnLnF1ZXVlLnB1c2goIGNhbGxiYWNrICk7DQoNCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7DQoJCXByb2Nlc3MoKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIHByb2Nlc3MoKSB7DQoJdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsNCg0KCXdoaWxlICggY29uZmlnLnF1ZXVlLmxlbmd0aCAmJiAhY29uZmlnLmJsb2NraW5nICkgew0KCQlpZiAoIGNvbmZpZy51cGRhdGVSYXRlIDw9IDAgfHwgKCgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQpIDwgY29uZmlnLnVwZGF0ZVJhdGUpICkgew0KCQkJY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsNCg0KCQl9IGVsc2Ugew0KCQkJc2V0VGltZW91dCggcHJvY2VzcywgMTMgKTsNCgkJCWJyZWFrOw0KCQl9DQoJfQ0KfQ0KDQpmdW5jdGlvbiBzYXZlR2xvYmFsKCkgew0KCWNvbmZpZy5wb2xsdXRpb24gPSBbXTsNCgkNCglpZiAoIGNvbmZpZy5ub2dsb2JhbHMgKSB7DQoJCWZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgew0KCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsNCgkJfQ0KCX0NCn0NCg0KZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7DQoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247DQoJc2F2ZUdsb2JhbCgpOw0KCQ0KCXZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7DQoJaWYgKCBuZXdHbG9iYWxzLmxlbmd0aCA+IDAgKSB7DQoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7DQoJCWNvbmZpZy5leHBlY3RlZCsrOw0KCX0NCg0KCXZhciBkZWxldGVkR2xvYmFscyA9IGRpZmYoIGNvbmZpZy5wb2xsdXRpb24sIG9sZCApOw0KCWlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsNCgkJb2soIGZhbHNlLCAiRGVsZXRlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBkZWxldGVkR2xvYmFscy5qb2luKCIsICIpICk7DQoJCWNvbmZpZy5leHBlY3RlZCsrOw0KCX0NCn0NCg0KLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYg0KZnVuY3Rpb24gZGlmZiggYSwgYiApIHsNCgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOw0KCWZvciAoIHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKyApIHsNCgkJZm9yICggdmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKyApIHsNCgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgew0KCQkJCXJlc3VsdC5zcGxpY2UoaSwgMSk7DQoJCQkJaS0tOw0KCQkJCWJyZWFrOw0KCQkJfQ0KCQl9DQoJfQ0KCXJldHVybiByZXN1bHQ7DQp9DQoNCmZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgew0KCWlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgew0KCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOw0KCQljb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7DQoJCWNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsNCg0KCX0gZWxzZSBpZiAoIHdpbmRvdy5vcGVyYSAmJiBvcGVyYS5wb3N0RXJyb3IgKSB7DQoJCW9wZXJhLnBvc3RFcnJvcihtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrLnRvU3RyaW5nKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7DQoJZm9yICggdmFyIHByb3AgaW4gYiApIHsNCgkJYVtwcm9wXSA9IGJbcHJvcF07DQoJfQ0KDQoJcmV0dXJuIGE7DQp9DQoNCmZ1bmN0aW9uIGFkZEV2ZW50KGVsZW0sIHR5cGUsIGZuKSB7DQoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7DQoJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZm4sIGZhbHNlICk7DQoJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsNCgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7DQoJfSBlbHNlIHsNCgkJZm4oKTsNCgl9DQp9DQoNCmZ1bmN0aW9uIGlkKG5hbWUpIHsNCglyZXR1cm4gISEodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgJiYNCgkJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG5hbWUgKTsNCn0NCg0KLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4NCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2DQovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYNCi8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aOkgPHByYXRoZUBnbWFpbC5jb20+DQpRVW5pdC5lcXVpdiA9IGZ1bmN0aW9uICgpIHsNCg0KICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbg0KICAgIHZhciBjYWxsZXJzID0gW107IC8vIHN0YWNrIHRvIGRlY2lkZSBiZXR3ZWVuIHNraXAvYWJvcnQgZnVuY3Rpb25zDQogICAgdmFyIHBhcmVudHMgPSBbXTsgLy8gc3RhY2sgdG8gYXZvaWRpbmcgbG9vcHMgZnJvbSBjaXJjdWxhciByZWZlcmVuY2luZw0KDQoNCiAgICAvLyBEZXRlcm1pbmUgd2hhdCBpcyBvLg0KICAgIGZ1bmN0aW9uIGhvb3ppdChvKSB7DQogICAgICAgIGlmIChRVW5pdC5pcygiU3RyaW5nIiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsNCiAgICAgICAgICAgIA0KICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJCb29sZWFuIiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7DQoNCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiTnVtYmVyIiwgbykpIHsNCg0KICAgICAgICAgICAgaWYgKGlzTmFOKG8pKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuICJuYW4iOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gInVuZGVmaW5lZCIpIHsNCiAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIjsNCg0KICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG51bGwgPT09IG9iamVjdA0KICAgICAgICB9IGVsc2UgaWYgKG8gPT09IG51bGwpIHsNCiAgICAgICAgICAgIHJldHVybiAibnVsbCI7DQoNCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0DQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJBcnJheSIsIG8pKSB7DQogICAgICAgICAgICByZXR1cm4gImFycmF5IjsNCiAgICAgICAgDQogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbmV3IERhdGUoKSA9PT0gb2JqZWN0DQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJEYXRlIiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAiZGF0ZSI7DQoNCiAgICAgICAgLy8gY29uc2lkZXI6IC8uLyBpbnN0YW5jZW9mIE9iamVjdDsNCiAgICAgICAgLy8gICAgICAgICAgIC8uLyBpbnN0YW5jZW9mIFJlZ0V4cDsNCiAgICAgICAgLy8gICAgICAgICAgdHlwZW9mIC8uLyA9PT0gImZ1bmN0aW9uIjsgLy8gPT4gZmFsc2UgaW4gSUUgYW5kIE9wZXJhLA0KICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUgaW4gRkYgYW5kIFNhZmFyaQ0KICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCAiUmVnRXhwIiwgbykpIHsNCiAgICAgICAgICAgIHJldHVybiAicmVnZXhwIjsNCg0KICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAib2JqZWN0Iikgew0KICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOw0KDQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJGdW5jdGlvbiIsIG8pKSB7DQogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLg0KICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7DQogICAgICAgIHZhciBwcm9wID0gaG9veml0KG8pOw0KICAgICAgICBpZiAocHJvcCkgew0KICAgICAgICAgICAgaWYgKGhvb3ppdChjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCiAgICANCiAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgew0KDQogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbA0KICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7DQogICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsNCiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uDQogICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7DQogICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7DQogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gew0KICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LA0KICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwNCiAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksDQogICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksDQoNCiAgICAgICAgICAgICJuYW4iOiBmdW5jdGlvbiAoYikgew0KICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gInJlZ2V4cCIgJiYNCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYNCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uDQogICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmDQogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsNCiAgICAgICAgICAgIH0sDQoNCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQ0KICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsDQogICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5DQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7DQogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsNCiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYNCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOw0KICAgICAgICAgICAgfSwNCg0KICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsNCiAgICAgICAgICAgICAgICB2YXIgbGVuOw0KDQogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlDQogICAgICAgICAgICAgICAgaWYgKCAhIChob296aXQoYikgPT09ICJhcnJheSIpKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9ICAgDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7DQogICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyDQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcw0KICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsNCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsNCiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOy8vZG9udCByZXdhbGsgYXJyYXkNCiAgICAgICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOw0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9LA0KDQogICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsNCiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsNCiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdA0KICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MNCg0KICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mDQogICAgICAgICAgICAgICAgaWYgKCBhLmNvbnN0cnVjdG9yICE9PSBiLmNvbnN0cnVjdG9yKSB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzDQogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOw0KICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMNCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgZm9yIChpIGluIGEpIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5IGFuZCBnbyBkZWVwDQogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsNCiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7DQogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOyAvL2Rvbid0IGdvIGRvd24gdGhlIHNhbWUgcGF0aCB0d2ljZQ0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMNCg0KICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOw0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQ0KICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7DQoNCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYikgew0KICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzDQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lDQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9Ow0KICAgIH0oKTsNCg0KICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cw0KICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOw0KICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7DQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24NCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsNCiAgICAgICAgICAgIGlmIChhID09PSBiKSB7DQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNhdGNoIHRoZSBtb3N0IHlvdSBjYW4NCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzDQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cw0KICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7DQogICAgfTsNCg0KICAgIHJldHVybiBpbm5lckVxdWl2Ow0KDQp9KCk7DQoNCi8qKg0KICoganNEdW1wDQogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20NCiAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApDQogKiBEYXRlOiA1LzE1LzIwMDgNCiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0Lg0KICogQHZlcnNpb24gMS4wLjANCiAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcg0KICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQ0KICovDQpRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7DQoJZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsNCgkJcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOw0KCX07DQoJZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsNCgkJcmV0dXJuIG8gKyAnJzsJDQoJfTsNCglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsNCgkJdmFyIHMgPSBqc0R1bXAuc2VwYXJhdG9yKCksDQoJCQliYXNlID0ganNEdW1wLmluZGVudCgpLA0KCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOw0KCQlpZiAoIGFyci5qb2luICkNCgkJCWFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsNCgkJaWYgKCAhYXJyICkNCgkJCXJldHVybiBwcmUgKyBwb3N0Ow0KCQlyZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7DQoJfTsNCglmdW5jdGlvbiBhcnJheSggYXJyICkgew0KCQl2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwkJCQkJDQoJCXRoaXMudXAoKTsNCgkJd2hpbGUgKCBpLS0gKQ0KCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CQkJCQ0KCQl0aGlzLmRvd24oKTsNCgkJcmV0dXJuIGpvaW4oICdbJywgcmV0LCAnXScgKTsNCgl9Ow0KCQ0KCXZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsNCgkNCgl2YXIganNEdW1wID0gew0KCQlwYXJzZTpmdW5jdGlvbiggb2JqLCB0eXBlICkgeyAvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQ0KCQkJdmFyCXBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07DQoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsJCQkNCgkJCQ0KCQkJcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6DQoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6DQoJCQkJICAgdGhpcy5wYXJzZXJzLmVycm9yOw0KCQl9LA0KCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApIHsNCgkJCXZhciB0eXBlOw0KCQkJaWYgKCBvYmogPT09IG51bGwgKSB7DQoJCQkJdHlwZSA9ICJudWxsIjsNCgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsNCgkJCQl0eXBlID0gInVuZGVmaW5lZCI7DQoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7DQoJCQkJdHlwZSA9ICJyZWdleHAiOw0KCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG9iaikpIHsNCgkJCQl0eXBlID0gImRhdGUiOw0KCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRnVuY3Rpb24iLCBvYmopKSB7DQoJCQkJdHlwZSA9ICJmdW5jdGlvbiI7DQoJCQl9IGVsc2UgaWYgKG9iai5zZXRJbnRlcnZhbCAmJiBvYmouZG9jdW1lbnQgJiYgIW9iai5ub2RlVHlwZSkgew0KCQkJCXR5cGUgPSAid2luZG93IjsNCgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlID09PSA5KSB7DQoJCQkJdHlwZSA9ICJkb2N1bWVudCI7DQoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSkgew0KCQkJCXR5cGUgPSAibm9kZSI7DQoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAibnVtYmVyIiAmJiBvYmoubGVuZ3RoID49IDApIHsNCgkJCQl0eXBlID0gImFycmF5IjsNCgkJCX0gZWxzZSB7DQoJCQkJdHlwZSA9IHR5cGVvZiBvYmo7DQoJCQl9DQoJCQlyZXR1cm4gdHlwZTsNCgkJfSwNCgkJc2VwYXJhdG9yOmZ1bmN0aW9uKCkgew0KCQkJcmV0dXJuIHRoaXMubXVsdGlsaW5lID8JdGhpcy5IVE1MID8gJzxiciAvPicgOiAnXG4nIDogdGhpcy5IVE1MID8gJyZuYnNwOycgOiAnICc7DQoJCX0sDQoJCWluZGVudDpmdW5jdGlvbiggZXh0cmEgKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcNCgkJCWlmICggIXRoaXMubXVsdGlsaW5lICkNCgkJCQlyZXR1cm4gJyc7DQoJCQl2YXIgY2hyID0gdGhpcy5pbmRlbnRDaGFyOw0KCQkJaWYgKCB0aGlzLkhUTUwgKQ0KCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOw0KCQkJcmV0dXJuIEFycmF5KCB0aGlzLl9kZXB0aF8gKyAoZXh0cmF8fDApICkuam9pbihjaHIpOw0KCQl9LA0KCQl1cDpmdW5jdGlvbiggYSApIHsNCgkJCXRoaXMuX2RlcHRoXyArPSBhIHx8IDE7DQoJCX0sDQoJCWRvd246ZnVuY3Rpb24oIGEgKSB7DQoJCQl0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOw0KCQl9LA0KCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsNCgkJCXRoaXMucGFyc2Vyc1tuYW1lXSA9IHBhcnNlcjsNCgkJfSwNCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtDQoJCXF1b3RlOnF1b3RlLCANCgkJbGl0ZXJhbDpsaXRlcmFsLA0KCQlqb2luOmpvaW4sDQoJCS8vDQoJCV9kZXB0aF86IDEsDQoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyDQoJCXBhcnNlcnM6ew0KCQkJd2luZG93OiAnW1dpbmRvd10nLA0KCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywNCgkJCWVycm9yOidbRVJST1JdJywgLy93aGVuIG5vIHBhcnNlciBpcyBmb3VuZCwgc2hvdWxkbid0IGhhcHBlbg0KCQkJdW5rbm93bjogJ1tVbmtub3duXScsDQoJCQknbnVsbCc6J251bGwnLA0KCQkJdW5kZWZpbmVkOid1bmRlZmluZWQnLA0KCQkJJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7DQoJCQkJdmFyIHJldCA9ICdmdW5jdGlvbicsDQoJCQkJCW5hbWUgPSAnbmFtZScgaW4gZm4gPyBmbi5uYW1lIDogKHJlTmFtZS5leGVjKGZuKXx8W10pWzFdOy8vZnVuY3Rpb25zIG5ldmVyIGhhdmUgbmFtZSBpbiBJRQ0KCQkJCWlmICggbmFtZSApDQoJCQkJCXJldCArPSAnICcgKyBuYW1lOw0KCQkJCXJldCArPSAnKCc7DQoJCQkJDQoJCQkJcmV0ID0gWyByZXQsIHRoaXMucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsNCgkJCQlyZXR1cm4gam9pbiggcmV0LCB0aGlzLnBhcnNlKGZuLCdmdW5jdGlvbkNvZGUnKSwgJ30nICk7DQoJCQl9LA0KCQkJYXJyYXk6IGFycmF5LA0KCQkJbm9kZWxpc3Q6IGFycmF5LA0KCQkJYXJndW1lbnRzOiBhcnJheSwNCgkJCW9iamVjdDpmdW5jdGlvbiggbWFwICkgew0KCQkJCXZhciByZXQgPSBbIF07DQoJCQkJdGhpcy51cCgpOw0KCQkJCWZvciAoIHZhciBrZXkgaW4gbWFwICkNCgkJCQkJcmV0LnB1c2goIHRoaXMucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyB0aGlzLnBhcnNlKG1hcFtrZXldKSApOw0KCQkJCXRoaXMuZG93bigpOw0KCQkJCXJldHVybiBqb2luKCAneycsIHJldCwgJ30nICk7DQoJCQl9LA0KCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsNCgkJCQl2YXIgb3BlbiA9IHRoaXMuSFRNTCA/ICcmbHQ7JyA6ICc8JywNCgkJCQkJY2xvc2UgPSB0aGlzLkhUTUwgPyAnJmd0OycgOiAnPic7DQoJCQkJCQ0KCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksDQoJCQkJCXJldCA9IG9wZW4gKyB0YWc7DQoJCQkJCQ0KCQkJCWZvciAoIHZhciBhIGluIHRoaXMuRE9NQXR0cnMgKSB7DQoJCQkJCXZhciB2YWwgPSBub2RlW3RoaXMuRE9NQXR0cnNbYV1dOw0KCQkJCQlpZiAoIHZhbCApDQoJCQkJCQlyZXQgKz0gJyAnICsgYSArICc9JyArIHRoaXMucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsNCgkJCQl9DQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOw0KCQkJfSwNCgkJCWZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24NCgkJCQl2YXIgbCA9IGZuLmxlbmd0aDsNCgkJCQlpZiAoICFsICkgcmV0dXJuICcnOwkJCQkNCgkJCQkNCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOw0KCQkJCXdoaWxlICggbC0tICkNCgkJCQkJYXJnc1tsXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcrbCk7Ly85NyBpcyAnYScNCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOw0KCQkJfSwNCgkJCWtleTpxdW90ZSwgLy9vYmplY3QgY2FsbHMgaXQgaW50ZXJuYWxseSwgdGhlIGtleSBwYXJ0IG9mIGFuIGl0ZW0gaW4gYSBtYXANCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbg0KCQkJYXR0cmlidXRlOnF1b3RlLCAvL25vZGUgY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyBhbiBodG1sIGF0dHJpYnV0ZSB2YWx1ZQ0KCQkJc3RyaW5nOnF1b3RlLA0KCQkJZGF0ZTpxdW90ZSwNCgkJCXJlZ2V4cDpsaXRlcmFsLCAvL3JlZ2V4DQoJCQludW1iZXI6bGl0ZXJhbCwNCgkJCSdib29sZWFuJzpsaXRlcmFsDQoJCX0sDQoJCURPTUF0dHJzOnsvL2F0dHJpYnV0ZXMgdG8gZHVtcCBmcm9tIG5vZGVzLCBuYW1lPT5yZWFsTmFtZQ0KCQkJaWQ6J2lkJywNCgkJCW5hbWU6J25hbWUnLA0KCQkJJ2NsYXNzJzonY2xhc3NOYW1lJw0KCQl9LA0KCQlIVE1MOmZhbHNlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkNCgkJaW5kZW50Q2hhcjonICAgJywvL2luZGVudGF0aW9uIHVuaXQNCgkJbXVsdGlsaW5lOmZhbHNlIC8vaWYgdHJ1ZSwgaXRlbXMgaW4gYSBjb2xsZWN0aW9uLCBhcmUgc2VwYXJhdGVkIGJ5IGEgXG4sIGVsc2UganVzdCBhIHNwYWNlLg0KCX07DQoNCglyZXR1cm4ganNEdW1wOw0KfSkoKTsNCg0KfSkodGhpcyk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:15:03 GMT",
                    "Content-Length": "30108",
                    "Date": "Fri, 07 Nov 2014 06:15:03 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}