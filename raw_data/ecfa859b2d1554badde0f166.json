{
    "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.3.1.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location</b> and written to <b>$()</b> via the following statement:<ul><li>$(\"&lt;a href='...\" + location+ \"' data-\" + $.mobile.ns+ \"icon='del...\" + $.mobile.ns+ \"iconpos='...\" + this .options.closeBtnTe...+ \"&lt;/a&gt;\" ) </li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.3.1.js",
                "path": "/marcorinck/jquery-mobile-iscrollview/demo/source/javascripts/jquery.mobile-1.3.1.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9tYXJjb3JpbmNrL2pxdWVyeS1tb2JpbGUtaXNjcm9sbHZpZXcvZGVtby9zb3VyY2UvamF2YXNjcmlwdHMvanF1ZXJ5Lm1vYmlsZS0xLjMuMS5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzU5MDA2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDA2OjQ5OjQzIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwNjo0OTo0MyBHTVQNCg0KLyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBXZWQgQXByIDEwIDIwMTMgMjE6NTc6MjMgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fTsKCgkvLyBqUXVlcnkubW9iaWxlIGNvbmZpZ3VyYWJsZSBvcHRpb25zCgkkLm1vYmlsZSA9ICQuZXh0ZW5kKCQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMy4xIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiZSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRlZmluZSB0aGUgd2luZG93IGFuZCB0aGUgZG9jdW1lbnQgb2JqZWN0cwoJCXdpbmRvdzogJCggd2luZG93ICksCgkJZG9jdW1lbnQ6ICQoIGRvY3VtZW50ICksCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJC5tb2JpbGUuZG9jdW1lbnQudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKSwgOmpxbURhdGEocm9sZT0iZGlhbG9nIiknICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuICRzZXQ7CgkJCX0KCgkJCXZhciBjb3VudCA9ICRzZXQubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZDsKCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9ICRzZXQuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gJHNldFsgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQl2YXIgYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKTsKCQl9Cgl9LCAkLm1vYmlsZSApOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKXsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCApOwoJCQl9IGVsc2UgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wLCB2YWx1ZSApOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXN1bHQgPSAkLmRhdGEoIGVsZW0sIHByb3AgPyAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApIDogcHJvcCwgdmFsdWUgKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5mbi5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIHByb3AgKSB7CgkJcmV0dXJuIHRoaXMucmVtb3ZlRGF0YSggJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCApIHsKCQlyZXR1cm4gJC5yZW1vdmVEYXRhKCBlbGVtLCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuZm4ucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbigpIHsKCQkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCB0aGlzICk7Cgl9OwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICk7CgoJCSggJGVsZW0uanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCggdGhpcyApLCBuZXdEZXBlbmRlbnRzICk7Cgl9OwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBkZXBlbmRlbnRzID0gJCggZWxlbSApLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKTsKCgkJJCggZWxlbSApLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZSggZGVwZW5kZW50cywgbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCggdGhpcyApLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IHYxLjEwLjBwcmUgLSAyMDEyLTExLTEzIChmZjA1NWEwYzM1M2MzYzhjZTZlNWJmYTA3YWQ3Y2IwM2U4ODg1YmM1KQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQluYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdOwoKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUudG9Mb3dlckNhc2UoKSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9LAoJCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQkJfTsKCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJCX07CgkJCX0pKCk7CgkJfQoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyBiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IDogbmFtZQoJfSwgcHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RnVsbE5hbWU6IGZ1bGxOYW1lCgl9KTsKCgkvLyBJZiB0aGlzIHdpZGdldCBpcyBiZWluZyByZWRlZmluZWQgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgYWxsIHdpZGdldHMgdGhhdAoJLy8gYXJlIGluaGVyaXRpbmcgZnJvbSBpdCBhbmQgcmVkZWZpbmUgYWxsIG9mIHRoZW0gc28gdGhhdCB0aGV5IGluaGVyaXQgZnJvbQoJLy8gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoaXMgd2lkZ2V0LiBXZSdyZSBlc3NlbnRpYWxseSB0cnlpbmcgdG8gcmVwbGFjZSBvbmUKCS8vIGxldmVsIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoIGV4aXN0aW5nQ29uc3RydWN0b3IgKSB7CgkJJC5lYWNoKCBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9ycywgZnVuY3Rpb24oIGksIGNoaWxkICkgewoJCQl2YXIgY2hpbGRQcm90b3R5cGUgPSBjaGlsZC5wcm90b3R5cGU7CgoJCQkvLyByZWRlZmluZSB0aGUgY2hpbGQgd2lkZ2V0IHVzaW5nIHRoZSBzYW1lIHByb3RvdHlwZSB0aGF0IHdhcwoJCQkvLyBvcmlnaW5hbGx5IHVzZWQsIGJ1dCBpbmhlcml0IGZyb20gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBiYXNlCgkJCSQud2lkZ2V0KCBjaGlsZFByb3RvdHlwZS5uYW1lc3BhY2UgKyAiLiIgKyBjaGlsZFByb3RvdHlwZS53aWRnZXROYW1lLCBjb25zdHJ1Y3RvciwgY2hpbGQuX3Byb3RvICk7CgkJfSk7CgkJLy8gcmVtb3ZlIHRoZSBsaXN0IG9mIGV4aXN0aW5nIGNoaWxkIGNvbnN0cnVjdG9ycyBmcm9tIHRoZSBvbGQgY29uc3RydWN0b3IKCQkvLyBzbyB0aGUgb2xkIGNoaWxkIGNvbnN0cnVjdG9ycyBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQKCQlkZWxldGUgZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnM7Cgl9IGVsc2UgewoJCWJhc2UuX2NoaWxkQ29uc3RydWN0b3JzLnB1c2goIGNvbnN0cnVjdG9yICk7Cgl9CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCBjb25zdHJ1Y3RvciApOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgdWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCB0aGlzLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAkKCB0YXJnZXQgKSksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKSwgc2VsZiA9IHRoaXM7CgoJCS8vIGlmIGlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCB0byB0cnVlIHRoZSBmcmFtZXdvcmsgc2hvdWxkCgkJLy8gb25seSBlbmhhbmNlIHRoZSBzZWxlY3RlZCBlbGVtZW50cyB3aGVuIHRoZXkgZG8gTk9UIGhhdmUgYQoJCS8vIHBhcmVudCB3aXRoIHRoZSBkYXRhLW5hbWVzcGFjZS1pZ25vcmUgYXR0cmlidXRlCgkJJHdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoICR3aWRnZXRFbGVtZW50cyApOwoKCQlpZiAoIHVzZUtlZXBOYXRpdmUgJiYgJHdpZGdldEVsZW1lbnRzLmxlbmd0aCApIHsKCQkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCQkvLyBDdXJyZW50bHkgdGhlIGtlZXBOYXRpdmUgdmFsdWUgaXMgZGVmaW5lZCBvbiB0aGUgcGFnZSBwcm90b3R5cGUgc28KCQkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJCXBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICR3aWRnZXRFbGVtZW50cyApOwoJCQlrZWVwTmF0aXZlID0gKCBwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdzaG93JywgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdoaWRlJyApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj4iICsKCQkJIjxoMT48L2gxPiIgKwoJCQkiPC9kaXY+IiwKCgkJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQlmYWtlRml4TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCXRoaXMuZWxlbWVudAoJCQkJLmNzcyh7CgkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0LnRvcCA8IHNjcm9sbFRvcCB8fCAoIG9mZnNldC50b3AgLSBzY3JvbGxUb3AgKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQkJdGhpcy5mYWtlRml4TG9hZGVyKCk7CgkJCQkkd2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsICRoZWFkZXIsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUodGhlbWUpID09PSAib2JqZWN0IiApIHsKCQkJCWxvYWRTZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCB0aGVtZSApOwoKCQkJCS8vIHByZWZlciBvYmplY3QgcHJvcGVydHkgZnJvbSB0aGUgcGFyYW0gdGhlbiB0aGUgb2xkIHRoZW1lIHNldHRpbmcKCQkJCXRoZW1lID0gbG9hZFNldHRpbmdzLnRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW0gdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUgfHwgbG9hZFNldHRpbmdzLnRoZW1lOwoJCQl9CgoJCQkvLyBzZXQgdGhlIG1lc3NhZ2UgdGV4dCwgcHJlZmVyIHRoZSBwYXJhbSwgdGhlbiB0aGUgc2V0dGluZ3Mgb2JqZWN0CgkJCS8vIHRoZW4gbG9hZGluZyBtZXNzYWdlCgkJCW1lc3NhZ2UgPSBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIHx8IGxvYWRTZXR0aW5ncy50ZXh0OwoKCQkJLy8gcHJlcGFyZSB0aGUgZG9tCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgIT09IGZhbHNlIHx8IGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJLy8gYm9vbGVhbiB2YWx1ZXMgcmVxdWlyZSBhIGJpdCBtb3JlIHdvcmsgOlAsIHN1cHBvcnRzIG9iamVjdCBwcm9wZXJ0aWVzCgkJCQkvLyBhbmQgb2xkIHNldHRpbmdzCgkJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0ZXh0VmlzaWJsZSA9ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU7CgkJCQl9IGVsc2UgewoJCQkJCXRleHRWaXNpYmxlID0gbG9hZFNldHRpbmdzLnRleHRWaXNpYmxlOwoJCQkJfQoKCQkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJCS8vIGlmIHRoZSB0ZXh0IHdhcyBleHBsaWNpdGx5IHNldCBpbiB0aGUgb2JqZWN0IGFyZ3MKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJCSIgdWktbG9hZGVyLSIgKyAoIHRleHRWaXNpYmxlIHx8IG1zZ1RleHQgfHwgdGhlbWUudGV4dCA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsKCQkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJCS8vICAgICAgdGhpcyBtaWdodCBiZSBvdmVybHkgZGVmZW5zaXZlIGluIHByZXZlbnRpbmcgdW5rbm93aW5nIHhzcwoJCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQkJaWYgKCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICJoMSIgKS50ZXh0KCBtZXNzYWdlICk7CgkJCQl9CgoJCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJCS8vIG9uIHNjcm9sbCBjaGVjayB0aGUgbG9hZGVyIHBvc2l0aW9uCgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7CgoJJHdpbmRvdy5iaW5kKCAncGFnZWNvbnRhaW5lcmNyZWF0ZScsIGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLmxvYWRlcldpZGdldCA9ICQubW9iaWxlLmxvYWRlcldpZGdldCB8fCAkKCAkLm1vYmlsZS5sb2FkZXIucHJvdG90eXBlLmRlZmF1bHRIdG1sICkubG9hZGVyKCk7Cgl9KTsKfSkoalF1ZXJ5LCB0aGlzKTsKCgovLyBTY3JpcHQ6IGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50Ci8vIAovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24oIHZhbCApIHsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpIHsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8qISBtYXRjaE1lZGlhKCkgcG9seWZpbGwgLSBUZXN0IGEgQ1NTIG1lZGlhIHR5cGUvcXVlcnkgaW4gSlMuIEF1dGhvcnMgJiBjb3B5cmlnaHQgKGMpIDIwMTI6IFNjb3R0IEplaGwsIFBhdWwgSXJpc2gsIE5pY2hvbGFzIFpha2FzLiBEdWFsIE1JVC9CU0QgbGljZW5zZSAqLwoJd2luZG93Lm1hdGNoTWVkaWEgPSB3aW5kb3cubWF0Y2hNZWRpYSB8fCAoZnVuY3Rpb24oIGRvYywgdW5kZWZpbmVkICkgewoKCQkKCgkJdmFyIGJvb2wsCgkJCWRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50LAoJCQlyZWZOb2RlID0gZG9jRWxlbS5maXJzdEVsZW1lbnRDaGlsZCB8fCBkb2NFbGVtLmZpcnN0Q2hpbGQsCgkJCS8vIGZha2VCb2R5IHJlcXVpcmVkIGZvciA8RkY0IHdoZW4gZXhlY3V0ZWQgaW4gPGhlYWQ+CgkJCWZha2VCb2R5ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJib2R5IiApLAoJCQlkaXYgPSBkb2MuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCgkJZGl2LmlkID0gIm1xLXRlc3QtMSI7CgkJZGl2LnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7dG9wOi0xMDBlbSI7CgkJZmFrZUJvZHkuc3R5bGUuYmFja2dyb3VuZCA9ICJub25lIjsKCQlmYWtlQm9keS5hcHBlbmRDaGlsZChkaXYpOwoKCQlyZXR1cm4gZnVuY3Rpb24ocSl7CgoJCQlkaXYuaW5uZXJIVE1MID0gIiZzaHk7PHN0eWxlIG1lZGlhPVwiIiArIHEgKyAiXCI+ICNtcS10ZXN0LTEgeyB3aWR0aDogNDJweDsgfTwvc3R5bGU+IjsKCgkJCWRvY0VsZW0uaW5zZXJ0QmVmb3JlKCBmYWtlQm9keSwgcmVmTm9kZSApOwoJCQlib29sID0gZGl2Lm9mZnNldFdpZHRoID09PSA0MjsKCQkJZG9jRWxlbS5yZW1vdmVDaGlsZCggZmFrZUJvZHkgKTsKCgkJCXJldHVybiB7CgkJCQltYXRjaGVzOiBib29sLAoJCQkJbWVkaWE6IHEKCQkJfTsKCgkJfTsKCgl9KCBkb2N1bWVudCApKTsKCgkvLyAkLm1vYmlsZS5tZWRpYSB1c2VzIG1hdGNoTWVkaWEgdG8gcmV0dXJuIGEgYm9vbGVhbi4KCSQubW9iaWxlLm1lZGlhID0gZnVuY3Rpb24oIHEgKSB7CgkJcmV0dXJuIHdpbmRvdy5tYXRjaE1lZGlhKCBxICkubWF0Y2hlczsKCX07Cgp9KShqUXVlcnkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBzdXBwb3J0ID0gewoJCQl0b3VjaDogIm9udG91Y2hlbmQiIGluIGRvY3VtZW50CgkJfTsKCgkJJC5tb2JpbGUuc3VwcG9ydCA9ICQubW9iaWxlLnN1cHBvcnQgfHwge307CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgc3VwcG9ydCApOwoJCSQuZXh0ZW5kKCAkLm1vYmlsZS5zdXBwb3J0LCBzdXBwb3J0ICk7Cgl9KCBqUXVlcnkgKSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgewoJCQlvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdwoJCX0pOwoJfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyB0aHggTW9kZXJuaXpyCmZ1bmN0aW9uIHByb3BFeGlzdHMoIHByb3AgKSB7Cgl2YXIgdWNfcHJvcCA9IHByb3AuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHByb3Auc3Vic3RyKCAxICksCgkJcHJvcHMgPSAoIHByb3AgKyAiICIgKyB2ZW5kb3JzLmpvaW4oIHVjX3Byb3AgKyAiICIgKSArIHVjX3Byb3AgKS5zcGxpdCggIiAiICk7CgoJZm9yICggdmFyIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICk7IC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoKCmZ1bmN0aW9uIHZhbGlkU3R5bGUoIHByb3AsIHZhbHVlLCBjaGVja192ZW5kICkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJdWMgPSBmdW5jdGlvbiggdHh0ICkgewoJCQlyZXR1cm4gdHh0LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyB0eHQuc3Vic3RyKCAxICk7CgkJfSwKCQl2ZW5kX3ByZWYgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJaWYoIHZlbmQgPT09ICIiICkgewoJCQkJcmV0dXJuICIiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCQl9CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgKCB1Y192ZW5kID09PSAiIiA/IHByb3AgOiB1YyggcHJvcCApICk7CgoJCQlkaXYuc2V0QXR0cmlidXRlKCAic3R5bGUiLCB2ZW5kX3Byb3AgKTsKCgkJCWlmICggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gY2hlY2tfdmVuZCA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggdmFyIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICk7CgoJaWYoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQl0cmFuc2Zvcm1zID0gewoJCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCQknTW96VHJhbnNmb3JtJzonLW1vei10cmFuc2Zvcm0nLAoJCQkndHJhbnNmb3JtJzondHJhbnNmb3JtJwoJCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHZhciB0IGluIHRyYW5zZm9ybXMgKSB7CgkJaWYoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApewoJCQllbC5zdHlsZVsgdCBdID0gJ3RyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSc7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ3gnICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICdwb2ludGVyRXZlbnRzJyBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdhdXRvJzsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICd4JzsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAnJyApLnBvaW50ZXJFdmVudHMgPT09ICdhdXRvJzsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZigKCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJLy8gT3BlcmEgTWluaQoJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJLy8gTWVlR28KCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHJ1ZTsKfQoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fAoJCXZhbGlkU3R5bGUoICd0cmFuc2l0aW9uJywgJ2hlaWdodCAxMDBtcyBsaW5lYXInLCBbICJXZWJraXQiLCAiTW96IiwgIiIgXSApICYmCgkJISQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgIW9wZXJhLAoKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA3ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLCBoaXN0b3J5OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9LAoJCQkJaHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYoIGV2ZW50Lmhpc3RvcnlTdGF0ZSApewoJCQkJJC5leHRlbmQoc3RhdGUsIGV2ZW50Lmhpc3RvcnlTdGF0ZSk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBOT1RFIHdlIGxldCB0aGUgY3VycmVudCBzdGFjayB1bndpbmQgYmVjYXVzZSBhbnkgYXNzaWdubWVudCB0bwoJCQkvLyAgICAgIGxvY2F0aW9uLmhhc2ggd2lsbCBzdG9wIHRoZSB3b3JsZCBhbmQgcnVuIHRoaXMgZXZlbnQgaGFuZGxlci4gQnkKCQkJLy8gICAgICBkb2luZyB0aGlzIHdlIGNyZWF0ZSBhIHNpbWlsYXIgYmVoYXZpb3IgdG8gaGFzaGNoYW5nZSBvbiBoYXNoCgkJCS8vICAgICAgYXNzaWdubWVudAoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJCXN0YXRlOiBzdGF0ZQoJCQkJfSk7CgkJCX0sIDApOwoJCX0sCgoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKTsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcyApIHsKCQkJaWYoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsIGRvY3VtZW50QmFzZSwgJGJhc2UsIGRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyI7CgoJCSQubW9iaWxlLnBhdGggPSBwYXRoID0gewoJCQl1aVN0YXRlS2V5OiAiJnVpLXN0YXRlIiwKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL15ccyooKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8JZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdXJpID0gdXJsID8gdGhpcy5wYXJzZVVybCggdXJsICkgOiBsb2NhdGlvbiwKCQkJCQloYXNoID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKS5oYXNoOwoKCQkJCS8vIG1pbWljIHRoZSBicm93c2VyIHdpdGggYW4gZW1wdHkgc3RyaW5nIHdoZW4gdGhlIGhhc2ggaXMgZW1wdHkKCQkJCWhhc2ggPSBoYXNoID09PSAiIyIgPyAiIiA6IGhhc2g7CgoJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZyBsb2NhdGlvbi5oYXNoCgkJCQkvLyBpcyBhdXRvZGVjb2RlZCBpbiBmaXJlZm94LCB0aGUgcmVzdCBvZiB0aGUgdXJsIHNob3VsZCBiZSBmcm9tIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcwoJCQkJLy8gd2UncmUgdGVzdGluZykgdG8gYXZvaWQgdGhlIGluY2x1c2lvbiBvZiB0aGUgYXV0aG9yaXR5CgkJCQlyZXR1cm4gdXJpLnByb3RvY29sICsgIi8vIiArIHVyaS5ob3N0ICsgdXJpLnBhdGhuYW1lICsgdXJpLnNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJdmFyIGFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW10sCgkJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCXZhciBkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgc3RhdGUsIGhyZWYsIGNsZWFuZWRVcmwsIHNlYXJjaCwgc3RhdGVJbmRleCwKCQkJCQlpc1BhdGggPSB0aGlzLmlzUGF0aCggdXJsICksCgkJCQkJdXJpID0gdGhpcy5wYXJzZVVybCggdXJsICksCgkJCQkJcHJlc2VydmVkSGFzaCA9IHVyaS5oYXNoLAoJCQkJCXVpU3RhdGUgPSAiIjsKCgkJCQkvLyBwcm9kdWNlIGEgdXJsIGFnYWluc3Qgd2hpY2ggd2UgY2FuIHJlc29sZSB0aGUgcHJvdmlkZWQgcGF0aAoJCQkJcmVzb2x1dGlvblVybCA9IHJlc29sdXRpb25VcmwgfHwgKHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLmdldExvY2F0aW9uKCkgOiBwYXRoLmdldERvY3VtZW50VXJsKCkpOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYW55dGhpbmcgYnV0IGEgc2ltcGxlIHN0cmluZywgcmVtb3ZlIGFueSBwcmVjZWRpbmcgaGFzaAoJCQkJLy8gZWcgI2Zvby9iYXIgLT4gZm9vL2JhcgoJCQkJLy8gICAgI2ZvbyAtPiAjZm9vCgkJCQljbGVhbmVkVXJsID0gaXNQYXRoID8gcGF0aC5zdHJpcEhhc2goIHVybCApIDogdXJsOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYSBmdWxsIHVybCB3aXRoIGEgaGFzaCBjaGVjayBpZiB0aGUgcGFyc2VkIGhhc2ggaXMgYSBwYXRoCgkJCQkvLyBpZiBpdCBpcywgc3RyaXAgdGhlICMsIGFuZCB1c2UgaXQgb3RoZXJ3aXNlIGNvbnRpbnVlIHdpdGhvdXQgY2hhbmdlCgkJCQljbGVhbmVkVXJsID0gcGF0aC5pc1BhdGgoIHVyaS5oYXNoICkgPyBwYXRoLnN0cmlwSGFzaCggdXJpLmhhc2ggKSA6IGNsZWFuZWRVcmw7CgoJCQkJLy8gU3BsaXQgdGhlIFVJIFN0YXRlIGtleXMgb2ZmIHRoZSBocmVmCgkJCQlzdGF0ZUluZGV4ID0gY2xlYW5lZFVybC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKTsKCgkJCQkvLyBzdG9yZSB0aGUgdWkgc3RhdGUga2V5cyBmb3IgdXNlCgkJCQlpZiggc3RhdGVJbmRleCA+IC0xICl7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSl7CgkJCQkJCXByZXNlcnZlZEhhc2ggKz0gdWlTdGF0ZTsKCQkJCQl9CgoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHBvdW5kIGlzIG9uIHRoZSBmcm9udCBvZiB0aGUgaGFzaAoJCQkJCWlmKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQlwYXRoLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRVcmwgKSA6IHBhdGguZG9jdW1lbnRVcmwuaHJlZjsKCQl9OwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoOwoKCSQubW9iaWxlLkhpc3RvcnkgPSBmdW5jdGlvbiggc3RhY2ssIGluZGV4ICkgewoJCXRoaXMuc3RhY2sgPSBzdGFjayB8fCBbXTsKCQl0aGlzLmFjdGl2ZUluZGV4ID0gaW5kZXggfHwgMDsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuSGlzdG9yeS5wcm90b3R5cGUsIHsKCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCBdOwoJCX0sCgoJCWdldExhc3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5wcmV2aW91c0luZGV4IF07CgkJfSwKCgkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4ICsgMSBdOwoJCX0sCgoJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCAtIDEgXTsKCQl9LAoKCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJYWRkOiBmdW5jdGlvbiggdXJsLCBkYXRhICl7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiggZWFybHlSZXR1cm4gKSB7CgkJCQkJCXJldHVybiBpbmRleDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBpbmRleDsKCQl9LAoKCQljbG9zZXN0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgY2xvc2VzdCwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBGaXJzdCwgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICdiYWNrJyApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICdmb3J3YXJkJyApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2g7CgoJCQkvLyBHcmFiIHRoZSBoYXNoIGZvciByZWNvcmRpbmcuIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aAoJCQkvLyB3ZSB1c2VkIHRoZSBwYXJzZWQgdmVyc2lvbiBvZiB0aGUgc3F1YXNoZWQgdXJsIHRvIHJlY29uc3RydWN0LAoJCQkvLyBvdGhlcndpc2Ugd2UgYXNzdW1lIGl0J3MgYSBoYXNoIGFuZCBzdG9yZSBpdCBkaXJlY3RseQoJCQlwYXJzZWQgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJbG9jID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCQlpZiggbG9jLnBhdGhuYW1lICsgbG9jLnNlYXJjaCA9PT0gcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaCApIHsKCQkJCS8vIElmIHRoZSBwYXRobmFtZSBhbmQgc2VhcmNoIG9mIHRoZSBwYXNzZWQgdXJsIGlzIGlkZW50aWNhbCB0byB0aGUgY3VycmVudCBsb2MKCQkJCS8vIHRoZW4gd2UgbXVzdCB1c2UgdGhlIGhhc2guIE90aGVyd2lzZSB0aGVyZSB3aWxsIGJlIG5vIGV2ZW50CgkJCQkvLyBlZywgdXJsID0gIi9mb28vYmFyP2JheiNiYW5nIiwgbG9jYXRpb24uaHJlZiA9ICJodHRwOi8vZXhhbXBsZS5jb20vZm9vL2Jhcj9iYXoiCgkJCQloYXNoID0gcGFyc2VkLmhhc2ggPyBwYXJzZWQuaGFzaCA6IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2g7CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKHVybCkgKSB7CgkJCQl2YXIgcmVzb2x2ZWQgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkvLyBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgsIG1ha2UgaXQgZG9tYWluIHJlbGF0aXZlIGFuZCByZW1vdmUgYW55IHRyYWlsaW5nIGhhc2gKCQkJCWhhc2ggPSByZXNvbHZlZC5wYXRobmFtZSArIHJlc29sdmVkLnNlYXJjaCArIChwYXRoLmlzUHJlc2VydmFibGVIYXNoKCByZXNvbHZlZC5oYXNoICk/IHJlc29sdmVkLmhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogIiIpOwoJCQl9IGVsc2UgewoJCQkJaGFzaCA9IHVybDsKCQkJfQoKCQkJcmV0dXJuIGhhc2g7CgkJfSwKCgkJLy8gVE9ETyByZWNvbnNpZGVyIG5hbWUKCQlnbzogZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCwgcG9wc3RhdGVFdmVudCwKCQkJCWlzUG9wU3RhdGVFdmVudCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKTsKCgkJCS8vIEdldCB0aGUgdXJsIGFzIGl0IHdvdWxkIGxvb2sgc3F1YXNoZWQgb24gdG8gdGhlIGN1cnJlbnQgcmVzb2x1dGlvbiB1cmwKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIHNvcnQgb3V0IHdoYXQgdGhlIGhhc2ggc291bGQgYmUgZnJvbSB0aGUgdXJsCgkJCWhhc2ggPSB0aGlzLmhhc2goIHVybCwgaHJlZiApOwoKCQkJLy8gSGVyZSB3ZSBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggY2hhbmdlIG9yIHBvcHN0YXRlIGV2ZW50IGZyb20gZG9pbmcgYW55CgkJCS8vIGhpc3RvcnkgbWFuYWdlbWVudC4gSW4gdGhlIGNhc2Ugb2YgaGFzaGNoYW5nZSB3ZSBkb24ndCBzd2FsbG93IGl0CgkJCS8vIGlmIHRoZXJlIHdpbGwgYmUgbm8gaGFzaGNoYW5nZSBmaXJlZCAoc2luY2UgdGhhdCB3b24ndCByZXNldCB0aGUgdmFsdWUpCgkJCS8vIGFuZCB3aWxsIHN3YWxsb3cgdGhlIGZvbGxvd2luZyBoYXNoY2hhbmdlCgkJCWlmKCBub0V2ZW50cyAmJiBoYXNoICE9PSBwYXRoLnN0cmlwSGFzaChwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gbm9FdmVudHM7CgkJCX0KCgkJCS8vIElNUE9SVEFOVCBpbiB0aGUgY2FzZSB3aGVyZSBwb3BzdGF0ZSBpcyBzdXBwb3J0ZWQgdGhlIGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkCgkJCS8vICAgICAgZGlyZWN0bHksIHN0b3BwaW5nIGZ1cnRoZXIgZXhlY3V0aW9uIC0gaWUsIGludGVydXB0aW5nIHRoZSBmbG93IG9mIHRoaXMKCQkJLy8gICAgICBtZXRob2QgY2FsbCB0byBmaXJlIGJpbmRpbmdzIGF0IHRoaXMgZXhwcmVzc2lvbi4gQmVsb3cgdGhlIG5hdmlnYXRlIG1ldGhvZAoJCQkvLyAgICAgIHRoZXJlIGlzIGEgYmluZGluZyB0byBjYXRjaCB0aGlzIGV2ZW50IGFuZCBzdG9wIGl0cyBwcm9wYWdhdGlvbi4KCQkJLy8KCQkJLy8gICAgICBXZSB0aGVuIHRyaWdnZXIgYSBuZXcgcG9wc3RhdGUgZXZlbnQgb24gdGhlIHdpbmRvdyB3aXRoIGEgbnVsbCBzdGF0ZQoJCQkvLyAgICAgIHNvIHRoYXQgdGhlIG5hdmlnYXRlIGV2ZW50cyBjYW4gY29uY2x1ZGUgdGhlaXIgd29yayBwcm9wZXJseQoJCQkvLwoJCQkvLyBpZiB0aGUgdXJsIGlzIGEgcGF0aCB3ZSB3YW50IHRvIHByZXNlcnZlIHRoZSBxdWVyeSBwYXJhbXMgdGhhdCBhcmUgYXZhaWxhYmxlIG9uCgkJCS8vIHRoZSBjdXJyZW50IHVybC4KCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gdHJ1ZTsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSBoYXNoOwoKCQkJLy8gSWYgcG9wc3RhdGUgaXMgZW5hYmxlZCBhbmQgdGhlIGJyb3dzZXIgdHJpZ2dlcnMgYHBvcHN0YXRlYCBldmVudHMgd2hlbiB0aGUgaGFzaAoJCQkvLyBpcyBzZXQgKHRoaXMgb2Z0ZW4gaGFwcGVucyBpbW1lZGlhdGVseSBpbiBicm93c2VycyBsaWtlIENocm9tZSksIHRoZW4gdGhlCgkJCS8vIHRoaXMgZmxhZyB3aWxsIGJlIHNldCB0byBmYWxzZSBhbHJlYWR5LiBJZiBpdCdzIGEgYnJvd3NlciB0aGF0IGRvZXMgbm90IHRyaWdnZXIKCQkJLy8gYSBgcG9wc3RhdGVgIG9uIGhhc2ggYXNzaWduZW1lbnQgb3IgYHJlcGxhY2VTdGF0ZWAgdGhlbiB3ZSBuZWVkIGF2b2lkIHRoZSBicmFuY2gKCQkJLy8gdGhhdCBzd2FsbG93cyB0aGUgZXZlbnQgY3JlYXRlZCBieSB0aGUgcG9wc3RhdGUgZ2VuZXJhdGVkIGJ5IHRoZSBoYXNoIGFzc2lnbm1lbnQKCQkJLy8gQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nIHRoaXMgaGFwcGVucyB3aXRoIE9wZXJhIDEyIGFuZCBzb21lIHZlcnNpb24gb2YgSUUKCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCXVybDogaHJlZiwKCQkJCWhhc2g6IGhhc2gsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJfSwgZGF0YSk7CgoJCQlpZiggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYoICFub0V2ZW50cyApIHsKCQkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gdHJ1ZTsKCQkJCQkkLm1vYmlsZS53aW5kb3cudHJpZ2dlciggcG9wc3RhdGVFdmVudCApOwoJCQkJfQoJCQl9CgoJCQkvLyByZWNvcmQgdGhlIGhpc3RvcnkgZW50cnkgc28gdGhhdCB0aGUgaW5mb3JtYXRpb24gY2FuIGJlIGluY2x1ZGVkCgkJCS8vIGluIGhhc2hjaGFuZ2UgZXZlbnQgZHJpdmVuIG5hdmlnYXRlIGV2ZW50cyBpbiBhIHNpbWlsYXIgZmFzaGlvbiB0bwoJCQkvLyB0aGUgc3RhdGUgdGhhdCdzIHByb3ZpZGVkIGJ5IHBvcHN0YXRlCgkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCQl9LAoKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYWN0aXZlLCBoYXNoLCBzdGF0ZSwgY2xvc2VzdEluZGV4OwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGJ5IHRoZSBhY3R1YWwgYWx0ZXJhdGlvbiBvZiB0aGUgaGFzaAoJCQkvLyBwcmV2ZW50IGl0IGNvbXBsZXRlbHkuIEhpc3RvcnkgaXMgdHJhY2tlZCBtYW51YWxseQoJCQlpZiggdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlICkgewoJCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBgcmVwbGFjZVN0YXRlYCBjYWxsIGluIHRoZSBnbwoJCQkvLyBtZXRob2QsIHRoZW4gc2ltcGx5IGlnbm9yZSBpdC4gVGhlIGhpc3RvcnkgZW50cnkgaGFzIGFscmVhZHkgYmVlbiBjYXB0dXJlZAoJCQlpZiggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJgoJCQkJdGhpcy5oaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMSAmJgoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSApIHsKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSBmYWxzZTsKCgkJCQlpZiAoIGxvY2F0aW9uLmhyZWYgPT09IGluaXRpYWxIcmVmICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBhY2NvdW50IGZvciBkaXJlY3QgbWFuaXB1bGF0aW9uIG9mIHRoZSBoYXNoLiBUaGF0IGlzLCB3ZSB3aWxsIHJlY2VpdmUgYSBwb3BzdGF0ZQoJCQkvLyB3aGVuIHRoZSBoYXNoIGlzIGNoYW5nZWQgYnkgYXNzaWdubWVudCwgYW5kIGl0IHdvbid0IGhhdmUgYSBzdGF0ZSBhc3NvY2lhdGVkLiBXZQoJCQkvLyB0aGVuIG5lZWQgdG8gc3F1YXNoIHRoZSBoYXNoLiBTZWUgYmVsb3cgZm9yIGhhbmRsaW5nIG9mIGhhc2ggYXNzaWdubWVudCB0aGF0CgkJCS8vIG1hdGNoZXMgYW4gZXhpc3RpbmcgaGlzdG9yeSBlbnRyeQoJCQkvLyBUT0RPIGl0IG1pZ2h0IGJlIGJldHRlciB0byBvbmx5IGFkZCB0byB0aGUgaGlzdG9yeSBzdGFjawoJCQkvLyAgICAgIHdoZW4gdGhlIGhhc2ggaXMgYWRqYWNlbnQgdG8gdGhlIGFjdGl2ZSBoaXN0b3J5IGVudHJ5CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQlpZiggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYgaGFzaCApIHsKCQkJCS8vIHNxdWFzaCB0aGUgaGFzaCB0aGF0J3MgYmVlbiBhc3NpZ25lZCBvbiB0aGUgVVJMIHdpdGggcmVwbGFjZVN0YXRlCgkJCQkvLyBhbHNvIGdyYWIgdGhlIHJlc3VsdGluZyBzdGF0ZSBvYmplY3QgZm9yIHN0b3JhZ2UKCQkJCXN0YXRlID0gdGhpcy5zcXVhc2goIGhhc2ggKTsKCgkJCQkvLyByZWNvcmQgdGhlIG5ldyBoYXNoIGFzIGFuIGFkZGl0aW9uYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gdG8gbWF0Y2ggdGhlIGJyb3dzZXIncyB0cmVhdG1lbnQgb2YgaGFzaCBhc3NpZ25tZW50CgkJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgoJCQkJLy8gcGFzcyB0aGUgbmV3bHkgY3JlYXRlZCBzdGF0ZSBpbmZvcm1hdGlvbgoJCQkJLy8gYWxvbmcgd2l0aCB0aGUgZXZlbnQKCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9IHN0YXRlOwoKCQkJCS8vIGRvIG5vdCBhbHRlciBoaXN0b3J5LCB3ZSd2ZSBhZGRlZCBhIG5ldyBoaXN0b3J5IGVudHJ5CgkJCQkvLyBzbyB3ZSBrbm93IHdoZXJlIHdlIGFyZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhbGwgZWxzZSBmYWlscyB0aGlzIGlzIGEgcG9wc3RhdGUgdGhhdCBjb21lcyBmcm9tIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9ucwoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseSwgYW5kIHJlY29yZCB0aGUgZGlyZWN0aW9uYWxpdHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IChldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9KS51cmwgfHwgaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJLy8gTk9URSBtdXN0IGJpbmQgYmVmb3JlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudCBoYXNoY2hhbmdlIGJpbmRpbmcgb3RoZXJ3aXNlIHRoZQoJCS8vICAgICAgbmF2aWdhdGlvbiBkYXRhIHdvbid0IGJlIGF0dGFjaGVkIHRvIHRoZSBoYXNoY2hhbmdlIGV2ZW50IGluIHRpbWUgZm9yIHRob3NlCgkJLy8gICAgICBiaW5kaW5ncyB0byBhdHRhY2ggaXQgdG8gdGhlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudAoJCS8vIFRPRE8gYWRkIGEgY2hlY2sgaGVyZSB0aGF0IGBoYXNoY2hhbmdlLm5hdmlnYXRlYCBpcyBib3VuZCBhbHJlYWR5IG90aGVyd2lzZSBpdCdzCgkJLy8gICAgICBicm9rZW4gKGV4Y2VwdGlvbj8pCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGlzdG9yeSwgaGFzaDsKCgkJCS8vIElmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGV4cGxpY2l0bHkgZGlzYWJsZWQgb3IgcHVzaHN0YXRlIGlzIHN1cHBvcnRlZAoJCQkvLyBhdm9pZCBtYWtpbmcgdXNlIG9mIHRoZSBoYXNoY2hhbmdlIGhhbmRsZXIuCgkJCWlmKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYoIHRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlICl7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhpc3RvcnkgPSB0aGlzLmhpc3Rvcnk7CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoKCQkJLy8gSWYgdGhpcyBpcyBhIGhhc2hjaGFuZ2UgY2F1c2VkIGJ5IHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfSwKCgkJCQkvLyBXaGVuIHdlIGRvbid0IGZpbmQgYSBoYXNoIGluIG91ciBoaXN0b3J5IGNsZWFybHkgd2UncmUgYWltaW5nIHRvIGdvIHRoZXJlCgkJCQkvLyByZWNvcmQgdGhlIGVudHJ5IGFzIG5ldyBmb3IgZnV0dXJlIHRyYXZlcnNhbAoJCQkJLy8KCQkJCS8vIE5PVEUgaXQncyBub3QgZW50aXJlbHkgY2xlYXIgdGhhdCB0aGlzIGlzIHRoZSByaWdodCB0aGluZyB0byBkbyBnaXZlbiB0aGF0IHdlCgkJCQkvLyAgICAgIGNhbid0IGtub3cgdGhlIHVzZXJzIGludGVudGlvbi4gSXQgbWlnaHQgYmUgYmV0dGVyIHRvIGV4cGxpY2l0bHkgX25vdF8KCQkJCS8vICAgICAgc3VwcG9ydCBsb2NhdGlvbi5oYXNoIGFzc2lnbm1lbnQgaW4gcHJlZmVyZW5jZSB0byAkLm5hdmlnYXRlIGNhbGxzCgkJCQkvLyBUT0RPIGZpcnN0IGFyZyB0byBhZGQgc2hvdWxkIGJlIHRoZSBocmVmLCBidXQgaXQgY2F1c2VzIGlzc3VlcyBpbiBpZGVudGlmeWluZwoJCQkJLy8gICAgICBlbWJlZGVkIHBhZ2VzCgkJCQltaXNzaW5nOiBmdW5jdGlvbigpIHsKCQkJCQloaXN0b3J5LmFkZCggaGFzaCwgewoJCQkJCQloYXNoOiBoYXNoLAoJCQkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkvLyBUT0RPIGNvbnNpZGVyIHF1ZXVlaW5nIG5hdmlnYXRpb24gYWN0aXZpdHkgdW50aWwgcHJldmlvdXMgYWN0aXZpdGllcyBoYXZlIGNvbXBsZXRlZAoJLy8gICAgICBzbyB0aGF0IGVuZCB1c2VycyBkb24ndCBoYXZlIHRvIHRoaW5rIGFib3V0IGl0LiBQdW50aW5nIGZvciBub3cKCS8vIFRPRE8gISEgbW92ZSB0aGUgZXZlbnQgYmluZGluZ3MgaW50byBjYWxsYmFja3Mgb24gdGhlIG5hdmlnYXRlIGV2ZW50CgkkLm1vYmlsZS5uYXZpZ2F0ZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5nbyggdXJsLCBkYXRhLCBub0V2ZW50cyApOwoJfTsKCgkvLyBleHBvc2UgdGhlIGhpc3Rvcnkgb24gdGhlIG5hdmlnYXRlIG1ldGhvZCBpbiBhbnRpY2lwYXRpb24gb2YgZnVsbCBpbnRlZ3JhdGlvbiB3aXRoCgkvLyBleGlzdGluZyBuYXZpZ2F0aW9uIGZ1bmN0aW9uYWx0eSB0aGF0IGlzIHRpZ2h0bHkgY291cGxlZCB0byB0aGUgaGlzdG9yeSBpbmZvcm1hdGlvbgoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSA9IG5ldyAkLm1vYmlsZS5IaXN0b3J5KCk7CgoJLy8gaW5zdGFudGlhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIG5hdmlnYXRvciBmb3IgdXNlIHdpdGhpbiB0aGUgJC5uYXZpZ2F0ZSBtZXRob2QKCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvciA9IG5ldyAkLm1vYmlsZS5OYXZpZ2F0b3IoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgKTsKCgl2YXIgbG9jID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCk7CgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggbG9jLmhyZWYsIHtoYXNoOiBsb2MuaGFzaH0gKTsKfSkoIGpRdWVyeSApOwoKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9ICk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEgKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKSB7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICk7CgoJLy8gYWRkIG5ldyBldmVudCBzaG9ydGN1dHMKCSQuZWFjaCggKCAidG91Y2hzdGFydCB0b3VjaG1vdmUgdG91Y2hlbmQgIiArCgkJInRhcCB0YXBob2xkICIgKwoJCSJzd2lwZSBzd2lwZWxlZnQgc3dpcGVyaWdodCAiICsKCQkic2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCQkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBmbiA/IHRoaXMuYmluZCggbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggbmFtZSApOwoJCX07CgoJCS8vIGpRdWVyeSA8IDEuOAoJCWlmICggJC5hdHRyRm4gKSB7CgkJCSQuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwoJCX0KCX0pOwoKCXZhciBzdXBwb3J0VG91Y2ggPSAkLm1vYmlsZS5zdXBwb3J0LnRvdWNoLAoJCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCQl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgoJZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQgKSB7CgkJdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGU7CgkJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCQkkLmV2ZW50LmRpc3BhdGNoLmNhbGwoIG9iaiwgZXZlbnQgKTsKCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJc2Nyb2xsaW5nLAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQkJfQoKCQkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCQl9CgoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJCX0sIDUwICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKCSQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CgkJdGFwaG9sZFRocmVzaG9sZDogNzUwLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkZG9jdW1lbnQuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAoJJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJCXNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQ6IDMwLCAvLyBNb3JlIHRoYW4gdGhpcyBob3Jpem9udGFsIGRpc3BsYWNlbWVudCwgYW5kIHdlIHdpbGwgc3VwcHJlc3Mgc2Nyb2xsaW5nLgoKCQlkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCQl2ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkOiA3NSwgIC8vIFN3aXBlIHZlcnRpY2FsIGRpc3BsYWNlbWVudCBtdXN0IGJlIGxlc3MgdGhhbiB0aGlzLgoKCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfTsKCQl9LAoKCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0KCQkJCQl9OwoJCX0sCgoJCWhhbmRsZVN3aXBlOiBmdW5jdGlvbiggc3RhcnQsIHN0b3AgKSB7CgkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgoJCQkJc3RhcnQub3JpZ2luLnRyaWdnZXIoICJzd2lwZSIgKQoJCQkJCS50cmlnZ2VyKCBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCIgKTsKCQkJfQoJCX0sCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBzdGFydCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdGFydCggZXZlbnQgKSwKCQkJCQlzdG9wOwoKCQkJCWZ1bmN0aW9uIG1vdmVIYW5kbGVyKCBldmVudCApIHsKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJc3RvcCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdG9wKCBldmVudCApOwoKCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQkJaWYgKCBzdGFydCAmJiBzdG9wICkgewoJCQkJCQkJJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCApOwoJCQkJCQl9CgkJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCQl9KTsKCQkJfSk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCXNwZWNpYWxfZXZlbnQsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9OwoKCS8vIEl0IHNlZW1zIHRoYXQgc29tZSBkZXZpY2UvYnJvd3NlciB2ZW5kb3JzIHVzZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWVzIDAgYW5kIDE4MCB0bwoJLy8gZGVub3RlIHRoZSAiZGVmYXVsdCIgb3JpZW50YXRpb24uIEZvciBpT1MgZGV2aWNlcywgYW5kIG1vc3Qgb3RoZXIgc21hcnQtcGhvbmVzIHRlc3RlZCwKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzIGFsd2F5cyAicG9ydHJhaXQiLCBidXQgaW4gc29tZSBBbmRyb2lkIGFuZCBSSU0gYmFzZWQgdGFibGV0cywKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzICJsYW5kc2NhcGUiLiBUaGUgZm9sbG93aW5nIGNvZGUgYXR0ZW1wdHMgdG8gdXNlIHRoZSB3aW5kb3cKCS8vIGRpbWVuc2lvbnMgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIGlzLCBhbmQgdGhlbiBtYWtlcyBhZGp1c3RtZW50cwoJLy8gdG8gdGhlIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseSBkZWNvZGUgdGhlCgkvLyB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJLy8KCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgb3JpZW50YXRpb24gdGhlIGJyb3dzZXIKCS8vIHRoaW5rcyBpdCBpcyBpbjoKCS8vCgkvLyAgICAgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSAkLm1vYmlsZS5tZWRpYSgiYWxsIGFuZCAob3JpZW50YXRpb246IGxhbmRzY2FwZSkiKTsKCS8vCgkvLyBidXQgdGhlcmUgd2FzIGFuIGlQaG9uZS9pUG9kIFRvdWNoIGJ1ZyBiZWdpbm5pbmcgd2l0aCBpT1MgNC4yLCB1cCB0aHJvdWdoIGlPUyA1LjEsCgkvLyB3aGVyZSB0aGUgYnJvd3NlciAqQUxXQVlTKiBhcHBsaWVkIHRoZSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkuIFRoaXMgYnVnIGRvZXMgbm90CgkvLyBoYXBwZW4gb24gaVBhZC4KCglpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCgkJLy8gQ2hlY2sgdGhlIHdpbmRvdyB3aWR0aCBhbmQgaGVpZ2h0IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbgoJCS8vIG9mIHRoZSBkZXZpY2UgaXMgYXQgdGhpcyBtb21lbnQuIE5vdGUgdGhhdCB3ZSd2ZSBpbml0aWFsaXplZCB0aGUgcG9ydHJhaXQgbWFwCgkJLy8gdmFsdWVzIHRvIDAgYW5kIDE4MCwgKkFORCogd2UgcHVycG9zZWx5IGNoZWNrIGZvciBsYW5kc2NhcGUgc28gdGhhdCBpZiB3ZSBndWVzcwoJCS8vIHdyb25nLCAsIHdlIGRlZmF1bHQgdG8gdGhlIGFzc3VtcHRpb24gdGhhdCBwb3J0cmFpdCBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbi4KCQkvLyBXZSB1c2UgYSB0aHJlc2hvbGQgY2hlY2sgYmVsb3cgYmVjYXVzZSBvbiBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUywgdGhlIGlQaG9uZQoJCS8vIGZvcm0tZmFjdG9yIGNhbiByZXBvcnQgYSBsYXJnZXIgd2lkdGggdGhhbiBoZWlnaHQgaWYgdGhlIHVzZXIgdHVybnMgb24gdGhlCgkJLy8gZGV2ZWxvcGVyIGNvbnNvbGUuIFRoZSBhY3R1YWwgdGhyZXNob2xkIHZhbHVlIGlzIHNvbWV3aGF0IGFyYml0cmFyeSwgd2UganVzdAoJCS8vIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGlzIGxhcmdlIGVub3VnaCB0byBleGNsdWRlIHRoZSBkZXZlbG9wZXIgY29uc29sZSBjYXNlLgoKCQl2YXIgd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpLAoJCQlsYW5kc2NhcGVfdGhyZXNob2xkID0gNTA7CgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gd3cgPiB3aCAmJiAoIHd3IC0gd2ggKSA+IGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIGlmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRoaXMuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggZSApIHsKCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCX0sCgoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCgkvLyBzZXQgdGhlIHBhZ2UgY29udGFpbmVyIGJhY2tncm91bmQgdG8gdGhlIHBhZ2UgdGhlbWUKCXNldENvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCB0aGVtZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArICggdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lICkgKTsKCQl9Cgl9LAoKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlICk7CgoJCWlmICgga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICkgewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbiggIiwgIiApOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGNyZWF0ZUhhbmRsZXIgPSBmdW5jdGlvbiggc2VxdWVudGlhbCApIHsKCgkvLyBEZWZhdWx0IHRvIHNlcXVlbnRpYWwKCWlmICggc2VxdWVudGlhbCA9PT0gdW5kZWZpbmVkICkgewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoKCXJldHVybiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCgkJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG9TY3JvbGwgPSBhY3RpdmUubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCW1heFRyYW5zaXRpb25PdmVycmlkZSA9ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUud2luZG93LndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIgfHwgTWF0aC5tYXgoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSwgdG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKSwKCQkJdG9QcmVDbGFzcyA9ICIgdWktcGFnZS1wcmUtaW4iLAoJCQl0b2dnbGVWaWV3cG9ydENsYXNzID0gZnVuY3Rpb24oKSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUgKTsKCQkJfSwKCQkJc2Nyb2xsUGFnZSA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0b1Njcm9sbCApOwoKCQkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQkJfSwgMTUwICk7CgkJCX0sCgkJCWNsZWFuRnJvbSA9IGZ1bmN0aW9uKCkgewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiBpdCdzIG5vdCBzZXF1ZW50aWFsLCBjYWxsIHRoZSBkb25lT3V0IHRyYW5zaXRpb24gdG8gc3RhcnQgdGhlIFRPIHBhZ2UgYW5pbWF0aW5nIGluIHNpbXVsdGFuZW91c2x5CgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCQkvLyBOb3RlOiBzZXR0aW5nIGFuIGV4cGxpY2l0IGhlaWdodCBoZWxwcyBlbGltaW5hdGUgdGlsaW5nIGluIHRoZSB0cmFuc2l0aW9ucwoJCQkJJGZyb20KCQkJCQkuaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCgkJCQlzdGFydEluKCk7CgkJCX0sCgoJCQlzdGFydEluID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CgoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgoJCQkJc2Nyb2xsUGFnZSgpOwoKCQkJCS8vIFJlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlOiBhZGRlZCB0b2dldGhlciB3aXRoICR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgkJCQkkdG8uY3NzKCAiei1pbmRleCIsICIiICk7CgoJCQkJaWYgKCAhbm9uZSApIHsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggdG9QcmVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCgkJCQlpZiAoIG5vbmUgKSB7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgoJCQl9LAoKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCgkJCQkJaWYgKCAkZnJvbSApIHsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoKCQkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQkJaWYgKCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICkgewoJCQkJCXNjcm9sbFBhZ2UoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCB0cnVlICk7CgkJCX07CgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9OwoKLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCnZhciBzZXF1ZW50aWFsSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoKSwKCXNpbXVsdGFuZW91c0hhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCBmYWxzZSApLAoJZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCi8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCiQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9IHNlcXVlbnRpYWxIYW5kbGVyOwoKLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCSJkZWZhdWx0IjogJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJInNlcXVlbnRpYWwiOiBzZXF1ZW50aWFsSGFuZGxlciwKCSJzaW11bHRhbmVvdXMiOiBzaW11bHRhbmVvdXNIYW5kbGVyCn07CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgovLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCiQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJaWYgKCB0cmFuc2l0aW9uICYmICEkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJcmV0dXJuIHRyYW5zaXRpb247Cn07CgovLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gfHwgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb247Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkkaHRtbCA9ICQoICdodG1sJyApLAoJCSRoZWFkID0gJCggJ2hlYWQnICksCgoJCS8vIE5PVEU6IHBhdGggZXh0ZW5zaW9ucyBkZXBlbmRlbnQgb24gY29yZSBhdHRyaWJ1dGVzLiBNb3ZlZCBoZXJlIHRvIHJlbW92ZSBkZXBzIGZyb20KCQkvLyAgICAgICAkLm1vYmlsZS5wYXRoIGRlZmluaXRpb24KCQlwYXRoID0gJC5leHRlbmQoJC5tb2JpbGUucGF0aCwgewoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLmRvY3VtZW50QmFzZSApICksCgoJCQkJCS8vIERvZXMgdGhlIHVybCBoYXZlIHRoZSBzYW1lIHBhdGggYXMgdGhlIGRvY3VtZW50PwoJCQkJCXNhbWVQYXRoID0gdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkvLyBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQlkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSksCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGwsCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5CgkJZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnksCgoJCS8vZGVmaW5lIGZpcnN0IHNlbGVjdG9yIHRvIHJlY2VpdmUgZm9jdXMgd2hlbiBhIHBhZ2UgaXMgc2hvd24KCQlmb2N1c2FibGUgPSAiW3RhYmluZGV4XSxhLGJ1dHRvbjp2aXNpYmxlLHNlbGVjdDp2aXNpYmxlLGlucHV0IiwKCgkJLy9xdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgkJcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvL2luZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZSwKCgkJLy9ub25zZW5zZSBoYXNoIGNoYW5nZSBrZXkgZm9yIGRpYWxvZ3MsIHNvIHRoZXkgY3JlYXRlIGEgaGlzdG9yeSBlbnRyeQoJCWRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyIsCgoJCS8vZXhpc3RpbmcgYmFzZSB0YWc/CgkJJGJhc2UgPSAkaGVhZC5jaGlsZHJlbiggImJhc2UiICksCgoJCS8vdHVjayBhd2F5IHRoZSBvcmlnaW5hbCBkb2N1bWVudCBVUkwgbWludXMgYW55IGZyYWdtZW50LgoJCWRvY3VtZW50VXJsID0gcGF0aC5kb2N1bWVudFVybCwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSBwYXRoLmRvY3VtZW50QmFzZSwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSBwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMsCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKGhyZWYpLmhyZWZOb0hhc2g7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJfSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBkb2N1bWVudEJhc2UuaHJlZk5vU2VhcmNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gcGF0aC5nZXREb2N1bWVudEJhc2U7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApewoJCQluYXYuYXBwLmJhY2tIaXN0b3J5KCk7CgkJfSBlbHNlIHsKCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCX0KCX07CgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiAoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmICggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYgKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCX0pOwoKCS8vIGhhbmRsZSBpbml0aWFsIGhhc2hjaGFuZ2UgZnJvbSBjaHJvbWUgOigKCSR3aW5kb3cub25lKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJfSk7CgoJLy8gd2FpdCB1bnRpbCB0aGUgbW9iaWxlIHBhZ2UgY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgdG8gYmluZCB0byBwYWdlY2hhbmdlCgkkd2luZG93Lm9uZSggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCSR3aW5kb3cudW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCgkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvL2Z1bmN0aW9uIGZvciB0cmFuc2l0aW9uaW5nIGJldHdlZW4gdHdvIGV4aXN0aW5nIHBhZ2VzCglmdW5jdGlvbiB0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHRyYW5zaXRpb24sIHJldmVyc2UgKSB7CgkJaWYgKCBmcm9tUGFnZSApIHsKCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoKCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiB8fCAiZGVmYXVsdCIgXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkJCXByb21pc2UgPSB0aCggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG9QYWdlLCBmcm9tUGFnZSApOwoKCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmICggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHBhZ2VzaG93LCBkZWZpbmUgcHJldlBhZ2UgYXMgZWl0aGVyIGZyb21QYWdlIG9yIGVtcHR5IGpRdWVyeSBvYmoKCQkJdG9QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ID0gZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBoZWlnaHQgKSB7CgkJdmFyIGFQYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCWFQYWdlUGFkVCA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggInBhZGRpbmctdG9wIiApICksCgkJCWFQYWdlUGFkQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggInBhZGRpbmctYm90dG9tIiApICksCgkJCWFQYWdlQm9yZGVyVCA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKSwKCQkJYVBhZ2VCb3JkZXJCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApOwoKCQloZWlnaHQgPSAoIHR5cGVvZiBoZWlnaHQgPT09ICJudW1iZXIiICk/IGhlaWdodCA6IGdldFNjcmVlbkhlaWdodCgpOwoJCQoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSBhUGFnZVBhZFQgLSBhUGFnZVBhZEIgLSBhUGFnZUJvcmRlclQgLSBhUGFnZUJvcmRlckIgKTsKCX07CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCWZ1bmN0aW9uIGZpbmRCYXNlV2l0aERlZmF1bHQoKSB7CgkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCQoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCQkKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBwYWdlIG1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIGJhc2UgaWYgaXRzIG5vdCBhIHByZWZldGNoIAoJCQkJaWYoIGJhc2UgJiYgIW9wdGlvbnMucHJlZmV0Y2ggKXsKCQkJCQliYXNlLnNldCh1cmwpOwoJCQkJfQoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCS8vIG9ubHkgcmVzZXQgaWYgd2UgYXJlIG5vdCBwcmVmZXRjaGluZyAKCQlpZiAoIGJhc2UgJiYgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiICkgewoJCQliYXNlLnJlc2V0KCk7CgkJfQoKCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fCBwYXRoLmlzU2FtZURvbWFpbiggZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJfSBlbHNlIHsKCQkJLy8gTG9hZCB0aGUgbmV3IHBhZ2UuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiBmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJCXZhciBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICksCgoJCQkJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCQkJCW5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMSwKCgkJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCQkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCgkJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUKCQkJCQkvLyBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeSBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICYmCgkJCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQkJdXJsID0gZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoICQoICI8ZGl2PiIgKyBSZWdFeHAuJDEgKyAiPC9kaXY+IiApLnRleHQoKSApOwoJCQkJCX0KCQkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCQlpZiAoIGJhc2UgJiYgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArICggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKyAiPC9kaXY+IiApOwoJCQkJCX0KCgkJCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJCQlpZiAoIH5uZXdQYWdlVGl0bGUuaW5kZXhPZiggIiYiICkgKSB7CgkJCQkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQkJCX0KCQkJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJCQl9CgoJCQkJCS8vcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwKCQkJCQlpZiAoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQoIHRoaXMgKS5pcyggJ1tzcmNdJyApID8gJ3NyYycgOiAnYWN0aW9uJywKCQkJCQkJCQl0aGlzVXJsID0gJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAnJyApOwoKCQkJCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkJCQkkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJLy9hcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndCByZW1vdmVkCgkJCQkJLy8gICAgICBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlIGluIG1hbnkKCQkJCQkvLyAgICAgIHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQkJCXBhZ2UKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGZpbGVVcmwgKSApCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKQoJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJLy8gd2FpdCBmb3IgcGFnZSBjcmVhdGlvbiB0byBsZXZlcmFnZSBvcHRpb25zIGRlZmluZWQgb24gd2lkZ2V0CgkJCQkJcGFnZS5vbmUoICdwYWdlY3JlYXRlJywgJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlICk7CgoJCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkJCS8vIEVuaGFuY2luZyB0aGUgcGFnZSBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBwYWdlcyBiZWluZyBpbnNlcnRlZAoJCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItcGFnZSwgdGhhdCBpcyB0aGUKCQkJCQkvLyByZWFsIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYgKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwgaXNUb1BhZ2VTdHJpbmc7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCWlzVG9QYWdlU3RyaW5nID0gKHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciKTsKCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdG9QYWdlOiB0b1BhZ2UsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZSBzaW1wbGlmaWVkCgkJLy8gICAgICAgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkvLyAgICAgICB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtCgkJLy8gICAgICAgaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCWlmICggaXNUb1BhZ2VTdHJpbmcgKSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvUGFnZSwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJfSBlbHNlIHsKCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHRvUGFnZS5kYXRhKCAnYWJzVXJsJyApOwoJCX0KCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCQkvLwoJCS8vIFdlIGFsc28gbmVlZCB0byByZS1ldmFsdWF0ZSB3aGV0aGVyIGl0IGlzIGEgc3RyaW5nLCBiZWNhdXNlIGFuIG9iamVjdCBjYW4KCQkvLyBhbHNvIGJlIHJlcGxhY2VkIGJ5IGEgc3RyaW5nCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCQkvLyBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbSB0aGUgaGFzaAoJCQkvLyB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtCgkJCS8vIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQkJc2V0dGluZ3MudGFyZ2V0ID0gdG9QYWdlOwoKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCgkJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJCS8vIHRvIGV2ZW50cyBpbiB0aGUgdHJpZ2dlckRhdGEgb2YgdGhlIHN1YnNlcXVlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJbmV3UGFnZS5kYXRhKCAnYWJzVXJsJywgdHJpZ2dlckRhdGEuYWJzVXJsICk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCgkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudCBtYW51YWxseS9keW5hbWljYWxseQoJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCS8vIHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbgoJCS8vIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4KCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJLy8gZm9ybVBhZ2UgYW5kIHRvUGFnZSBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LgoJCS8vIEl0IGlzIHVwIHRvIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbgoJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYgIXNldHRpbmdzLmFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uICkgewoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBFdmVuIGlmIHRoZXJlIGlzIG5vIHBhZ2UgY2hhbmdlIHRvIGJlIGRvbmUsIHdlIHNob3VsZCBrZWVwIHRoZSB1cmxIaXN0b3J5IGluIHN5bmMgd2l0aCB0aGUgaGFzaCBjaGFuZ2VzCgkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5LmRpcmVjdCh7IHVybDogdXJsIH0pOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQloaXN0b3J5RGlyID0gb3B0aW9ucy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnYm9keScgKSB7CgkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7fQoKCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCXZhciBhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgoJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUgaGFzaC4KCQkJLy8gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kIHdlJ3JlCgkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkvLyBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUgb3JpZ2luYWwgZGlhbG9nCgkJCWlmICggYWN0aXZlLnVybCAmJgoJCQkJYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSAmJgoJCQkJISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICYmCgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCX0KCgkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24gb2YgYSBzdGFsZSBkaWFsb2csCgkJCS8vIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkvLyBhY2NvdW50IGZvciBhYnNvbHV0ZSB1cmxzIGluc3RlYWQgb2YganVzdCByZWxhdGl2ZSB1cmxzIHVzZSBhcyBoYXNoZXMKCQkJaWYoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgKz0gIiMiICsgZGlhbG9nSGFzaEtleTsKCQkJfQoKCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfQoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCWlmICggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQl1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnBhZ2VVcmwgPSBwYWdlVXJsOwoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmICggdXJsICYmICFzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdmFyIHBhcmFtczsKCgkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJaWYoICFwYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCXVybCA9ICIjIiArIHVybDsKCQkJfQoKCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQlwYXJhbXMgPSB7CgkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJdGl0bGU6IHBhZ2VUaXRsZSwKCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCX07CgoJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJfSBlbHNlIGlmICggdG9QYWdlWyAwIF0gIT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCX0KCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlLiBNb3ZlZCBmcm9tIHByb21pc2UgLmRvbmUgYmluZGluZyBpbiB0cmFuc2l0aW9uUGFnZXMKCQkJCS8vIGl0c2VsZiB0byBhdm9pZCBpZSBidWcgdGhhdCByZXBvcnRzIG9mZnNldFdpZHRoIGFzID4gMCAoY29yZSBjaGVjayBmb3IgdmlzaWJpbGl0eSkKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJCgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gcGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGEgPSBnZXRBamF4Rm9ybURhdGEoICQoIHRoaXMgKSApOwoKCQkJaWYgKCBmb3JtRGF0YSApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmIHBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmICEkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIGJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKSwKCgkJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdmFyIHVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKSwKCgkJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoIHBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCh1cmwpLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoLCBOT1RFIHRoYXQgdGhlIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cwoJCQkJLy8gaGlzdG9yeSBlbnRyeQoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUsCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfTsKCgkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSwgewoJCQkJdHJhbnNpdGlvbjogKHVybEhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9KS50cmFuc2l0aW9uIHx8IHRyYW5zaXRpb24KCQkJfSk7CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiB1cmxIaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCWlmKCBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siICkgewoJCQkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOwoJCQkJCX0KCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdG8gPSBkYXRhLnBhZ2VVcmw7CgkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQl0cmFuc2l0aW9uOiBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gIXBhdGguaXNQYXRoKCB0byApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEgcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50CgkJCQkvLyBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZCB1cCBpbiB0aGUgaW5pdGlhbCB1cmxIaXN0b3J5IGVudHJ5CgkJCQlpZiAoIHRvID09PSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdXJsSGlzdG9yeS5pbml0aWFsRHN0LCBkb2N1bWVudEJhc2UgKSAmJgoJCQkJCXVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICYmIHVybEhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9ICQubW9iaWxlLmZpcnN0UGFnZTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCgkJCQkvL3RoZXJlJ3Mgbm8gaGFzaCwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGRvbQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CgkJfTsKCgkJLy8gVE9ETyByb2xsIHRoZSBsb2dpYyBoZXJlIGludG8gdGhlIGhhbmRsZUhhc2hDaGFuZ2UgbWV0aG9kCgkJJHdpbmRvdy5iaW5kKCAibmF2aWdhdGUiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLm9yaWdpbmFsRXZlbnROYW1lLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmKCAhdXJsICkgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJfQoKCQkJaWYoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsb3cgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsb3cgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciBwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkKCBlLnRhcmdldCApICksIG9wdGlvbnM7CgoJaWYgKCAhcGFnZSApIHsKCQlyZXR1cm47Cgl9CgoJb3B0aW9ucyA9IHBhZ2Uub3B0aW9uczsKCgkvLyBkZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCSQoIGUudGFyZ2V0ICkuZmluZCggImlucHV0IiApLm5vdCggcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiOwoKCQlpZiAoIG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQl2YXIgaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCAkdGhpcy5jbG9uZSgpICkuaHRtbCgpLAoJCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTEsCgkJCQlmaW5kc3RyID0gaGFzVHlwZSA/IC9ccyt0eXBlPVsiJ10/XHcrWyciXT8vIDogL1wvPz4vLAoJCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQkkdGhpcy5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb3JuZXJDbGFzcyA9ICEhdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsgY29ybmVyQ2xhc3MKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwud3JhcElubmVyKCBkaWFsb2dXcmFwICk7CgoJCS8qIGJpbmQgZXZlbnRzCgkJCS0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cgb3BlbmVkIHdpdGgKCQkJCXVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fb24oICRlbCwgewoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NyZWF0ZUNvbXBsZXRlOiBmYWxzZQoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBzZWxmID0gdGhpcywgYnRuLCBsb2NhdGlvbjsKCgkJaWYgKCB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiApIHsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24ucmVtb3ZlKCk7CgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gbnVsbDsKCQl9CgkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCQlsb2NhdGlvbiA9ICggdmFsdWUgPT09ICJsZWZ0IiA/ICJsZWZ0IiA6ICJyaWdodCIgKTsKCQkJYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1idG4tIiArIGxvY2F0aW9uICsgIicgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nZGVsZXRlJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zPSdub3RleHQnPiIrIHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgKyAiPC9hPiIgKTsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCkucHJlcGVuZCggYnRuICk7CgkJCWlmICggdGhpcy5fY3JlYXRlQ29tcGxldGUgJiYgJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQlidG4uYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJdGhpcy5fY3JlYXRlQ29tcGxldGUgPSB0cnVlOwoKCQkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkJLy8gdGhlIGNsb3NlIG1ldGhvZC4gVGhpcyBpcyBhIGNoYW5nZSBmcm9tIHByZXZpb3VzbHkganVzdCBkZWZpbmluZyBkYXRhLXJlbD1iYWNrCgkJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCQkvLwoJCQkvLyBVc2UgY2xpY2sgcmF0aGVyIHRoYW4gdmNsaWNrIGluIG9yZGVyIHRvIHByZXZlbnQgdGhlIHBvc3NpYmlsaXR5IG9mIHVuaW50ZW50aW9uYWxseQoJCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQkJYnRuLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5jbG9zZSgpOwoJCQl9KTsKCgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJjbG9zZUJ0biIgKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oKSB7CgkkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLmVuaGFuY2UoIHRoaXMgKTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKLy8gTk9URSBiaW5kIHVzZWQgdG8gZm9yY2UgdGhpcyBiaW5kaW5nIHRvIHJ1biBiZWZvcmUgdGhlIGJ1dHRvbk1hcmt1cCBiaW5kaW5nCi8vICAgICAgd2hpY2ggZXhwZWN0cyAudWktZm9vdGVyIHRvcCBiZSBhcHBsaWVkIGluIGl0cyBnaWdhbnRpYyBzZWxlY3RvcgovLyBUT0RPIHJlbW92ZSB0aGUgYnV0dG9uTWFya3VwIGdpYW50IHNlbGVjdG9yIGFuZCBtb3ZlIGl0IHRvIHRoZSB2YXJpb3VzIG1vZHVsZXMKLy8gICAgICBvbiB3aGljaCBpdCBkZXBlbmRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgJHBhZ2UgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiKSB7CgkJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJCXJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoKCQkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCX0KCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmCgkJCQlyb2xlID09PSAiaGVhZGVyIiAmJgoJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCSRwYWdlLmpxbURhdGEoICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSFsZWZ0YnRuICkgewoKCQkJCWJhY2tCdG4gPSAkKCAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0JyBkYXRhLSIrICQubW9iaWxlLm5zICsicmVsPSdiYWNrJyBkYXRhLSIrICQubW9iaWxlLm5zICsiaWNvbj0nYXJyb3ctbCc+Iisgby5iYWNrQnRuVGV4dCArIjwvYT4iICkKCQkJCQkvLyBJZiB0aGVtZSBpcyBwcm92aWRlZCwgb3ZlcnJpZGUgZGVmYXVsdCBpbmhlcml0YW5jZQoJCQkJCS5hdHRyKCAiZGF0YS0iKyAkLm1vYmlsZS5ucyArInRoZW1lIiwgby5iYWNrQnRuVGhlbWUgfHwgdGhpc1RoZW1lICkKCQkJCQkucHJlcGVuZFRvKCAkdGhpcyApOwoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRoaXMgZnVuY3Rpb24gY2FsbHMgZ2V0QXR0cmlidXRlLCB3aGljaCBzaG91bGQgYmUgc2FmZSBmb3IgZGF0YS0qIGF0dHJpYnV0ZXMKdmFyIGdldEF0dHJGaXhlZCA9IGZ1bmN0aW9uKCBlLCBrZXkgKSB7Cgl2YXIgdmFsdWUgPSBlLmdldEF0dHJpYnV0ZSgga2V5ICk7CgoJcmV0dXJuIHZhbHVlID09PSAidHJ1ZSIgPyB0cnVlIDoKCQl2YWx1ZSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQl2YWx1ZSA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHZhbHVlOwp9OwoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXZhciAkd29ya2luZ1NldCA9IHRoaXMsCgkJbnNLZXkgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJa2V5OwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09PSAib2JqZWN0IiApICk/IG9wdGlvbnMgOiB7fTsKCWZvciAoIHZhciBpID0gMDsgaSA8ICR3b3JraW5nU2V0Lmxlbmd0aDsgaSsrICkgewoJCXZhciBlbCA9ICR3b3JraW5nU2V0LmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb24iICksCgkJCQlpY29ucG9zOiAgICBvcHRpb25zLmljb25wb3MgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnBvcyAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApLAoJCQkJaW5saW5lOiAgICAgb3B0aW9ucy5pbmxpbmUgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmlubGluZSAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImlubGluZSIgKSwKCQkJCXNoYWRvdzogICAgIG9wdGlvbnMuc2hhZG93ICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zaGFkb3cgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiY29ybmVycyIgKSwKCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uc2hhZG93IDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29uc2hhZG93IiApLAoJCQkJbWluaTogICAgICAgb3B0aW9ucy5taW5pICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1pbmkgICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJaG92ZXIgPSBmYWxzZSwKCQkJc3RhdGUgPSAidXAiLAoJCQkvLyBCdXR0b24gaW5uZXIgbWFya3VwCgkJCWJ1dHRvbklubmVyLAoJCQlidXR0b25UZXh0LAoJCQlidXR0b25JY29uLAoJCQlidXR0b25FbGVtZW50czsKCgkJZm9yICgga2V5IGluIG8gKSB7CgkJCWlmICggb1sga2V5IF0gPT09IHVuZGVmaW5lZCB8fCBvWyBrZXkgXSA9PT0gbnVsbCApIHsKCQkJCWVsLnJlbW92ZUF0dHIoIG5zS2V5ICsga2V5ICk7CgkJCX0gZWxzZSB7CgkJCQllLnNldEF0dHJpYnV0ZSggbnNLZXkgKyBrZXksIG9bIGtleSBdICk7CgkJCX0KCQl9CgoJCWlmICggZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJyZWwiICkgPT09ICJwb3B1cCIgJiYgZWwuYXR0ciggImhyZWYiICkgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBlbC5hdHRyKCAiaHJlZiIgKSApOwoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhpcyBlbGVtZW50IGlzIGFscmVhZHkgZW5oYW5jZWQKCQlidXR0b25FbGVtZW50cyA9ICQuZGF0YSggKCAoIGUudGFnTmFtZSA9PT0gIklOUFVUIiB8fCBlLnRhZ05hbWUgPT09ICJCVVRUT04iICkgPyBlLnBhcmVudE5vZGUgOiBlICksICJidXR0b25FbGVtZW50cyIgKTsKCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZSA9IGJ1dHRvbkVsZW1lbnRzLm91dGVyOwoJCQllbCA9ICQoIGUgKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoIGJ1dHRvbkVsZW1lbnRzLmljb24gKS5yZW1vdmUoKTsKCQkJYnV0dG9uRWxlbWVudHMuaWNvbiA9IG51bGw7CgkJCWhvdmVyID0gYnV0dG9uRWxlbWVudHMuaG92ZXI7CgkJCXN0YXRlID0gYnV0dG9uRWxlbWVudHMuc3RhdGU7CgkJfQoJCWVsc2UgewoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJfQoJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoKCQkvLyBpZiBub3QsIHRyeSB0byBmaW5kIGNsb3Nlc3QgdGhlbWUgY29udGFpbmVyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CgkJfQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gIjsKCQlidXR0b25DbGFzcyArPSAoIGhvdmVyID8gInVpLWJ0bi1ob3Zlci0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gKCBzdGF0ZSA/ICIgdWktYnRuLSIgKyBzdGF0ZSArICItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoKCQlpZiAoIG8uaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBpbmxpbmVgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gdHJ1ZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIHVpLWJ0bi1ibG9jayI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJaG92ZXIgOiBob3ZlciwKCQkJc3RhdGUgOiBzdGF0ZSwKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9CgpmdW5jdGlvbiB1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgY2xhc3NUb1JlbW92ZSwgY2xhc3NUb0FkZCwgaG92ZXIsIHN0YXRlICkgewoJdmFyIGJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAkYnRuWyAwIF0sICJidXR0b25FbGVtZW50cyIgKTsKCSRidG4ucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKS5hZGRDbGFzcyggY2xhc3NUb0FkZCApOwoJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQlidXR0b25FbGVtZW50cy5iY2xzID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApCgkJCS5hZGRDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyArICIgIiArIGNsYXNzVG9BZGQgKQoJCQkucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKQoJCQkuYXR0ciggImNsYXNzIiApOwoJCWlmICggaG92ZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJYnV0dG9uRWxlbWVudHMuaG92ZXIgPSBob3ZlcjsKCQl9CgkJYnV0dG9uRWxlbWVudHMuc3RhdGUgPSBzdGF0ZTsKCX0KfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlpc1RvdWNoRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9edG91Y2gvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApLAoJCQkJZXZ0ID0gZXZlbnQudHlwZTsKCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlob3YgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIHVuZGVmaW5lZCwgInVwIiApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCBmYWxzZSwgInVwIiApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZUNsYXNzZXMgPSAiIjsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5jb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uOwoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbjsKCgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5pY29ucG9zID0gJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvczsKCgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBTZXQgY29ybmVycyBmb3IgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZXMgdG8gZmFsc2Ugd2hlbiBpbiBhIGNvbGxhcHNpYmxlLXNldAoJCQlvLmNvcm5lcnMgPSBmYWxzZTsKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBmb3IgbWluaSBpbiB0aGUgc2V0CgkJCWlmICggIW8ubWluaSApIHsKCQkJCW8ubWluaSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJtaW5pIiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gZ2V0IGluaGVyaXRlZCB0aGVtZSBpZiBub3QgYSBzZXQgYW5kIG5vIHRoZW1lIGhhcyBiZWVuIHNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCQl9CgkJfQoKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtaW5zZXQiOwoJCQlpZiAoICEhby5jb3JuZXJzICkgewoJCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29ybmVyLWFsbCIgOwoJCQl9CgkJfQoJCWlmICggby5jb250ZW50VGhlbWUgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50IjsKCQkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9CgkJaWYgKCBjb2xsYXBzaWJsZUNsYXNzZXMgIT09ICIiICkgewoJCQljb2xsYXBzaWJsZS5hZGRDbGFzcyggY29sbGFwc2libGVDbGFzc2VzICk7CgkJfQoJCQoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvbnBvczogby5pY29ucG9zLAoJCQkJCWljb246IG8uY29sbGFwc2VkSWNvbiwKCQkJCQltaW5pOiBvLm1pbmksCgkJCQkJdGhlbWU6IG8udGhlbWUKCQkJCX0pOwoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICk7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvLmV4cGFuZGVkSWNvbiwgIWlzQ29sbGFwc2UgKQoJCQkJCQkJLy8gbG9naWMgb3IgY2F1c2Ugc2FtZSBpY29uIGZvciBleHBhbmRlZC9jb2xsYXBzZWQgc3RhdGUgd291bGQgcmVtb3ZlIHRoZSB1aS1pY29uLWNsYXNzCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvLmV4cGFuZGVkSWNvbiA9PT0gby5jb2xsYXBzZWRJY29uICkgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJY29sbGFwc2libGVDb250ZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJCQl9CgkJCX0pCgkJCS50cmlnZ2VyKCBvLmNvbGxhcHNlZCA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLmJpbmQoICJ0YXAiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQljb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggImEiICkuZmlyc3QoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQl2YXIgdHlwZSA9IGNvbGxhcHNpYmxlSGVhZGluZy5pcyggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSA/ICJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29ybmVyIHN0eWxpbmcgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvcm5lcnMgKSB7CgkJCW8uY29ybmVycyA9ICRlbC5qcW1EYXRhKCAiY29ybmVycyIgKTsKCQl9CgkJCgkJaWYgKCAkZWwuanFtRGF0YSggImluc2V0IiApICE9PSB1bmRlZmluZWQgKSB7CgkJCW8uaW5zZXQgPSAkZWwuanFtRGF0YSggImluc2V0IiApOwoJCX0KCQlvLmluc2V0ID0gby5pbnNldCAhPT0gdW5kZWZpbmVkID8gby5pbnNldCA6IHRydWU7CgkJby5jb3JuZXJzID0gby5jb3JuZXJzICE9PSB1bmRlZmluZWQgPyBvLmNvcm5lcnMgOiB0cnVlOwoJCQoJCWlmICggISFvLmNvcm5lcnMgJiYgISFvLmluc2V0ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLl9yZWZyZXNoKCAidHJ1ZSIgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICk7CgoJCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlKCBjb2xsYXBzaWJsZXNJblNldC5ub3QoICIudWktY29sbGFwc2libGUiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyB1aS1idG4taW5uZXIgaXMgcmV0dXJuZWQgYXMgdGFyZ2V0CgkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5pcyggImEiICkgPyAkKCB0aGlzICkgOiAkKCB0aGlzICkucGFyZW50KCAiYSIgKTsKCQkJCgkJCWlmICggIXRhcmdldC5pcyggIi51aS1kaXNhYmxlZCwgLnVpLWJ0bi1hY3RpdmUiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJdmFyIGFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCQkJCQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCWljb246ICJhcnJvdy1yIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IiA6ICIiOwoKCQlpZiAoICEhdC5vcHRpb25zLmluc2V0ICkgewoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiI7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJfQoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzOwoJCX0pOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGlzdGljb24gPSAkbGlzdC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoKCQlpZiAoIG9sICkgewoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQoJCX0KCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJZm9yICggdmFyIHBvcyA9IDAsIG51bWxpID0gbGkubGVuZ3RoOyBwb3MgPCBudW1saTsgcG9zKysgKSB7CgkJCWl0ZW0gPSBsaS5lcSggcG9zICk7CgkJCWl0ZW1DbGFzcyA9ICJ1aS1saSI7CgoJCQkvLyBJZiB3ZSdyZSBjcmVhdGluZyB0aGUgZWxlbWVudCwgd2UgdXBkYXRlIGl0IHJlZ2FyZGxlc3MKCQkJaWYgKCBjcmVhdGUgfHwgIWl0ZW0uaGFzQ2xhc3MoICJ1aS1saSIgKSApIHsKCQkJCWl0ZW1UaGVtZSA9IGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IG8udGhlbWU7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCXZhciBpc0RpdmlkZXIgPSAoIGl0ZW0uanFtRGF0YSggInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiAhaXNEaXZpZGVyICkgewoJCQkJCWljb24gPSBpdGVtLmpxbURhdGEoICJpY29uIiApOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8IGxpc3RpY29uIHx8IG8uaWNvbiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09PSAxICkgKSB7CgkJCQkJCWl0ZW0uYWRkQ2xhc3MoICJ1aS1saS1oYXMtYXJyb3ciICk7CgkJCQkJfQoKCQkJCQlhLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCAidWktbGluay1pbmhlcml0IiApOwoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBsaXN0c3BsaXR0aGVtZSB8fCBsYXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWU7CgkJCQkJCWxpbmtJY29uID0gbGFzdC5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJCWxhc3QuYXBwZW5kVG8oIGl0ZW0gKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsICQudHJpbShsYXN0LmdldEVuY29kZWRUZXh0KCkpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArICggaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgZGl2aWRlcnRoZW1lICk7CgkJCQkJaXRlbS5hdHRyKCAicm9sZSIsICJoZWFkaW5nIiApOwoKCQkJCQlpZiAoIG9sICkgewoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYnRuLXVwLSIgKyBpdGVtVGhlbWU7CgkJCQl9CgkJCX0KCgkJCWlmICggb2wgJiYganNDb3VudCAmJiBpdGVtQ2xhc3MuaW5kZXhPZiggInVpLWxpLWRpdmlkZXIiICkgPCAwICkgewoJCQkJY291bnRQYXJlbnQgPSBpdGVtQ2xhc3MuaW5kZXhPZiggInVpLWxpLXN0YXRpYyIgKSA+IDAgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKCBjb3VudGVyKysgKSArICIuIDwvc3Bhbj4iICk7CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0gYW5kIGl0cwoJCQkvLyBidG4taW5uZXIgYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0KCQkvLyBhbmQgdGhlaXIgYnRuLWlubmVyIGVsZW1lbnRzLiBUaGUgbWFpbiByZWFzb24gd2UgZGlkbid0IGRvIHRoaXMKCQkvLyBpbiB0aGUgZm9yLWxvb3AgYWJvdmUgaXMgYmVjYXVzZSB3ZSBjYW4gZWxpbWluYXRlIHBlci1pdGVtIGZ1bmN0aW9uIG92ZXJoZWFkCgkJLy8gYnkgY2FsbGluZyBhZGRDbGFzcygpIGFuZCBjaGlsZHJlbigpIG9uY2Ugb3IgdHdpY2UgYWZ0ZXJ3YXJkcy4gVGhpcwoJCS8vIGNhbiBnaXZlIHVzIGEgc2lnbmlmaWNhbnQgYm9vc3Qgb24gcGxhdGZvcm1zIGxpa2UgV1A3LjUuCgoJCWZvciAoIGl0ZW1DbGFzcyBpbiBpdGVtQ2xhc3NEaWN0ICkgewoJCQkkKCBpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKS5jaGlsZHJlbiggIi51aS1idG4taW5uZXIiICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJJGxpc3QuZmluZCggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkuYWRkQ2xhc3MoICJ1aS1saS1oZWFkaW5nIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICJwLCBkbCIgKS5hZGRDbGFzcyggInVpLWxpLWRlc2MiICkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1hc2lkZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJCS8vIGF1dG9kaXZpZGVycyBiaW5kcyB0byB0aGlzIHRvIHJlZHJhdyBkaXZpZGVycyBhZnRlciB0aGUgbGlzdHZpZXcgcmVmcmVzaAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcnJlZnJlc2giICk7Cgl9LAoKCS8vY3JlYXRlIGEgc3RyaW5nIGZvciBJRC9zdWJwYWdlIHVybCBjcmVhdGlvbgoJX2lkU3RyaW5nRXNjYXBlOiBmdW5jdGlvbiggc3RyICkgewoJCXJldHVybiBzdHIucmVwbGFjZSgvW15hLXpBLVowLTldL2csICctJyk7Cgl9LAoKCV9jcmVhdGVTdWJQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudExpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBwYXJlbnRMaXN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJcGFyZW50VXJsID0gcGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQlwYXJlbnRJZCA9IHBhcmVudFVybCB8fCBwYXJlbnRQYWdlWyAwIF1bICQuZXhwYW5kbyBdLAoJCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0LmF0dHIoICJpZCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJZG5zID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlzZWxmID0gdGhpcywKCQkJcGVyc2lzdGVudEZvb3RlcklEID0gcGFyZW50UGFnZS5maW5kKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkuanFtRGF0YSggImlkIiApLAoJCQloYXNTdWJQYWdlczsKCgkJaWYgKCB0eXBlb2YgbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPSAtMTsKCQl9CgoJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3RJZCB8fCArK2xpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF07CgoJCSQoIHBhcmVudExpc3QuZmluZCggImxpPnVsLCBsaT5vbCIgKS50b0FycmF5KCkucmV2ZXJzZSgpICkuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbGlzdCA9ICQoIHRoaXMgKSwKCQkJCWxpc3RJZCA9IGxpc3QuYXR0ciggImlkIiApIHx8IHBhcmVudExpc3RJZCArICItIiArIGksCgkJCQlwYXJlbnQgPSBsaXN0LnBhcmVudCgpLAoJCQkJbm9kZUVsc0Z1bGwgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVsc0Z1bGwubGVuZ3RoID8gbm9kZUVsc0Z1bGwgOiAkKCAiPHNwYW4+IiArICQudHJpbShwYXJlbnQuY29udGVudHMoKVsgMCBdLm5vZGVWYWx1ZSkgKyAiPC9zcGFuPiIgKSwKCQkJCXRpdGxlID0gbm9kZUVscy5maXJzdCgpLmdldEVuY29kZWRUZXh0KCksLy91cmwgbGltaXRzIHRvIGZpcnN0IDMwIGNoYXJzIG9mIHRleHQKCQkJCWlkID0gKCBwYXJlbnRVcmwgfHwgIiIgKSArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiPSIgKyBsaXN0SWQsCgkJCQl0aGVtZSA9IGxpc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8udGhlbWUsCgkJCQljb3VudFRoZW1lID0gbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBwYXJlbnRMaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IG8uY291bnRUaGVtZSwKCQkJCW5ld1BhZ2UsIGFuY2hvcjsKCgkJCS8vZGVmaW5lIGhhc1N1YlBhZ2VzIGZvciB1c2UgaW4gbGF0ZXIgcmVtb3ZhbAoJCQloYXNTdWJQYWdlcyA9IHRydWU7CgoJCQluZXdQYWdlID0gbGlzdC5kZXRhY2goKQoJCQkJCQkud3JhcCggIjxkaXYgIiArIGRucyArICJyb2xlPSdwYWdlJyAiICsgZG5zICsgInVybD0nIiArIGlkICsgIicgIiArIGRucyArICJ0aGVtZT0nIiArIHRoZW1lICsgIicgIiArIGRucyArICJjb3VudC10aGVtZT0nIiArIGNvdW50VGhlbWUgKyAiJz48ZGl2ICIgKyBkbnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+PC9kaXY+IiApCgkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJLmJlZm9yZSggIjxkaXYgIiArIGRucyArICJyb2xlPSdoZWFkZXInICIgKyBkbnMgKyAidGhlbWU9JyIgKyBvLmhlYWRlclRoZW1lICsgIic+PGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyB0aXRsZSArICI8L2Rpdj48L2Rpdj4iICkKCQkJCQkJCS5hZnRlciggcGVyc2lzdGVudEZvb3RlcklEID8gJCggIjxkaXYgIiArIGRucyArICJyb2xlPSdmb290ZXInICIgKyBkbnMgKyAiaWQ9JyIrIHBlcnNpc3RlbnRGb290ZXJJRCArIic+IiApIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCAnYTpmaXJzdCcgKTsKCgkJCWlmICggIWFuY2hvci5sZW5ndGggKSB7CgkJCQlhbmNob3IgPSAkKCAiPGEvPiIgKS5odG1sKCBub2RlRWxzIHx8IHRpdGxlICkucHJlcGVuZFRvKCBwYXJlbnQuZW1wdHkoKSApOwoJCQl9CgoJCQlhbmNob3IuYXR0ciggImhyZWYiLCAiIyIgKyBpZCApOwoKCQl9KS5saXN0dmlldygpOwoKCQkvLyBvbiBwYWdlaGlkZSwgcmVtb3ZlIGFueSBuZXN0ZWQgcGFnZXMgYWxvbmcgd2l0aCB0aGUgcGFyZW50IHBhZ2UsIGFzIGxvbmcgYXMgdGhleSBhcmVuJ3QgYWN0aXZlCgkJLy8gYW5kIGFyZW4ndCBlbWJlZGRlZAoJCWlmICggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiAoIHVpLm5leHRQYWdlICkgewoJCQkJCW5wVVJMID0gbmV4dFBhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCQlpZiAoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApIHsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UudHJpZ2dlciggcHJFdmVudCApOwoJCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50VXJsID0gdGhpcy5wYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCXJldHVybiAkKCAiOmpxbURhdGEodXJsXj0nIisgIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiJykiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSksIGlucHV0W3R5cGU9J2ZpbGUnXSIsCgkJY2xlYXJCdG46IGZhbHNlLAoJCWNsZWFyU2VhcmNoQnV0dG9uVGV4dDogbnVsbCwgLy9kZXByZWNhdGluZyBmb3IgMS4zLi4uCgkJY2xlYXJCdG5UZXh0OiAiY2xlYXIgdGV4dCIsCgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGVtZSA9IG8udGhlbWUgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lY2xhc3MgID0gIiB1aS1ib2R5LSIgKyB0aGVtZSwKCQkJbWluaWNsYXNzID0gby5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlpc1NlYXJjaCA9IGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJZm9jdXNlZEVsLAoJCQljbGVhcmJ0biwKCQkJY2xlYXJCdG5UZXh0ID0gby5jbGVhclNlYXJjaEJ1dHRvblRleHQgfHwgby5jbGVhckJ0blRleHQsCgkJCWNsZWFyQnRuQmxhY2tsaXN0ID0gaW5wdXQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJaW5wdXROZWVkc0NsZWFyQnRuID0gISFvLmNsZWFyQnRuICYmICFjbGVhckJ0bkJsYWNrbGlzdCwKCQkJaW5wdXROZWVkc1dyYXAgPSBpbnB1dC5pcyggImlucHV0IiApICYmICFpbnB1dC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICk7CgoJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCX0sIDAgKTsKCQl9CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcyggInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggaXNTZWFyY2ggKSB7CgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC1zZWFyY2ggdWktc2hhZG93LWluc2V0IHVpLWJ0bi1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3cgdWktaWNvbi1zZWFyY2hmaWVsZCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0gZWxzZSBpZiAoIGlucHV0TmVlZHNXcmFwICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtdGV4dCB1aS1zaGFkb3ctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJfQoKCQlpZiggaW5wdXROZWVkc0NsZWFyQnRuIHx8IGlzU2VhcmNoICkgewoJCQljbGVhcmJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXInIHRpdGxlPSciICsgY2xlYXJCdG5UZXh0ICsgIic+IiArIGNsZWFyQnRuVGV4dCArICI8L2E+IiApCgkJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0CgkJCQkJCS52YWwoICIiICkKCQkJCQkJLmZvY3VzKCkKCQkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQltaW5pOiBvLm1pbmkKCQkJCX0pOwoJCQkJCgkJCWlmICggIWlzU2VhcmNoICkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggInBhc3RlIGN1dCBrZXl1cCBpbnB1dCBmb2N1cyBjaGFuZ2UgYmx1ciIsIHRvZ2dsZUNsZWFyICk7CgkJfQoJCWVsc2UgaWYgKCAhaW5wdXROZWVkc1dyYXAgJiYgIWlzU2VhcmNoICkgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQkJCQoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQkJCQkKCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQl0aGlzLl9rZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCXZhciBwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIGlucHV0LmNzcyggInBhZGRpbmctYm90dG9tIiApICksCgkJCQkJCXBhZGRpbmdIZWlnaHQgPSBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbTsKCQkJCQkKCQkJCQlpbnB1dC5oZWlnaHQoIHNjcm9sbEhlaWdodCAtIHBhZGRpbmdIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQgKTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0Lm9uKCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiwgZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUuZG9jdW1lbnQsIHsgInBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgkJCQoJCWlmICggcGFyZW50TmVlZHNEaXNhYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNFbmFibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoKCQlpZiAoIHBhcmVudE5lZWRzRW5hYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclJldmVhbCA9IGZhbHNlOwovLyBUT0RPIHJlbmFtZSBjYWxsYmFjay9kZXByZWNhdGUgYW5kIGRlZmF1bHQgdG8gdGhlIGl0ZW0gaXRzZWxmIGFzIHRoZSBmaXJzdCBhcmd1bWVudAp2YXIgZGVmYXVsdEZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlLCBpdGVtICkgewoJCXJldHVybiB0ZXh0LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKCX07CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsIG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7Cgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJbGlzdC5jaGlsZHJlbigpLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSkuc3VibWl0KCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWFyY2guYmx1cigpOwoJCX0pLAoJCW9uS2V5VXAgPSBmdW5jdGlvbiggZSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxpID0gbGlzdC5jaGlsZHJlbigpLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgoJCQkJaWYgKCAhbGlzdEl0ZW1zLmxlbmd0aCAmJiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgISFsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApOwoJCQl9CgkJCWxpc3R2aWV3Ll9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgbGlzdHZpZXcuX2dldFZpc2libGVzKCBsaSwgZmFsc2UgKSwgZmFsc2UgKTsKCQl9LAoJCXNlYXJjaCA9ICQoICI8aW5wdXQ+IiwgewoJCQlwbGFjZWhvbGRlcjogbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlcgoJCX0pCgkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiwgInNlYXJjaCIgKQoJCS5qcW1EYXRhKCAibGFzdHZhbCIsICIiICkKCQkuYmluZCggImtleXVwIGNoYW5nZSBpbnB1dCIsIG9uS2V5VXAgKQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9OwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7CgkKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwgaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9ICQoIGlucHV0ICkuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDogJCggaW5wdXQgKS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmluZCggImxhYmVsIiApLmZpbHRlciggIltmb3I9JyIgKyBpbnB1dFswXS5pZCArICInXSIgKS5maXJzdCgpLAoJCQlpbnB1dHR5cGUgPSBpbnB1dFswXS50eXBlLAoJCQltaW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbnBvcyA9IGluaGVyaXRBdHRyKCBpbnB1dCwgImljb25wb3MiICksCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGU7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJbGFiZWw6IGxhYmVsLAoJCQlpbnB1dHR5cGU6IGlucHV0dHlwZSwKCQkJY2hlY2tlZENsYXNzOiBjaGVja2VkQ2xhc3MsCgkJCXVuY2hlY2tlZENsYXNzOiB1bmNoZWNrZWRDbGFzcywKCQkJY2hlY2tlZGljb246IGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkU3RhdGUKCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWljb246IHVuY2hlY2tlZFN0YXRlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQltaW5pOiBtaW5pLAoJCQlpY29ucG9zOiBpY29ucG9zCgkJfSk7CgoJCS8vIFdyYXAgdGhlIGlucHV0ICsgbGFiZWwgaW4gYSBkaXYKCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCXdyYXBwZXIuY2xhc3NOYW1lID0gJ3VpLScgKyBpbnB1dHR5cGU7CgoJCWlucHV0LmFkZCggbGFiZWwgKS53cmFwQWxsKCB3cmFwcGVyICk7CgoJCWxhYmVsLmJpbmQoewoJCQl2bW91c2VvdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5wYXJlbnQoKS5pcyggIi51aS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJfSwKCgkJCXZjbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCgkJCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIGlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJCQkvLyBob3cgbGFiZWwgY2xpY2tzIGJlaGF2ZSBub3JtYWxseSBpbiB0aGUgYnJvd3NlcnMKCQkJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCQkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkJCS8vICAgICAgIHdyYXBwZXIgZWxlbWVudCBsZXZlbAoJCQkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICdjbGljaycgKTsKCgkJCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJCQkvLyBidXR0b25zLCBidXQgd2lsbCBub3QgZm9yIGNoZWNrYm94ZXMuIGNsZWFyaW5nIHRoZSBjaGVja2VkIHN0YXR1cwoJCQkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkJLy8gQWRkcyBjaGVja2VkIGF0dHJpYnV0ZSB0byBjaGVja2VkIGlucHV0IHdoZW4ga2V5Ym9hcmQgaXMgdXNlZAoJCQkJCWlmICggJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgdHJ1ZSk7CgkJCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCAkdGhpcyApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmpxbURhdGEoICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCWFjdGl2ZSA9ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQljaGVja2VkQ2xhc3MgPSB0aGlzLmNoZWNrZWRDbGFzcyArICggdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktY29udHJvbGdyb3VwLWhvcml6b250YWwiICkubGVuZ3RoID8gYWN0aXZlIDogIiIgKSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICsgYWN0aXZlICkuYWRkQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLmNoZWNrZWRpY29uIH0gKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKS5idXR0b25NYXJrdXAoIHsgaWNvbjogdGhpcy51bmNoZWNrZWRpY29uIH0gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5saW5lOiBudWxsLAoJCW1pbmk6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJJGJ1dHRvbiwKCQkJLy8gY3JlYXRlIGEgY29weSBvZiB0aGlzLm9wdGlvbnMgd2UgY2FuIHBhc3MgdG8gYnV0dG9uTWFya3VwCgkJCW8gPSAoIGZ1bmN0aW9uKCB0ZG8gKSB7CgkJCQl2YXIga2V5LCByZXQgPSB7fTsKCgkJCQlmb3IgKCBrZXkgaW4gdGRvICkgewoJCQkJCWlmICggdGRvWyBrZXkgXSAhPT0gbnVsbCAmJiBrZXkgIT09ICJpbml0U2VsZWN0b3IiICkgewoJCQkJCQlyZXRbIGtleSBdID0gdGRvWyBrZXkgXTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHJldDsKCQkJfSApKCB0aGlzLm9wdGlvbnMgKSwKCQkJY2xhc3NlcyA9ICIiLAoJCQkkYnV0dG9uUGxhY2Vob2xkZXI7CgoJCS8vIGlmIHRoaXMgaXMgYSBsaW5rLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiAoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCQkJaWYgKCAhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJJGVsLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoICAkZWwuYXR0ciggInR5cGUiICkgPT09ICJzdWJtaXQiIHx8ICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInJlc2V0IiApIHsKCQkJaWYgKCBjbGFzc2VzICkgewoJCQkJY2xhc3NlcyArPSAiIHVpLXN1Ym1pdCI7CgkJCX0gZWxzZSB7CgkJCQljbGFzc2VzID0gInVpLXN1Ym1pdCI7CgkJCX0KCQl9CgkJJCggImxhYmVsW2Zvcj0nIiArICRlbC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1zdWJtaXQiICk7CgoJCS8vIEFkZCBBUklBIHJvbGUKCQl0aGlzLmJ1dHRvbiA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQlbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKQoJCQkuaW5zZXJ0QmVmb3JlKCAkZWwgKQoJCQkuYnV0dG9uTWFya3VwKCBvICkKCQkJLmFkZENsYXNzKCBjbGFzc2VzICkKCQkJLmFwcGVuZCggJGVsLmFkZENsYXNzKCAidWktYnRuLWhpZGRlbiIgKSApOwoKICAgICAgICAkYnV0dG9uID0gdGhpcy5idXR0b247CgoJCSRlbC5iaW5kKHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcCA9IHt9OwoKCQlvcFsga2V5IF0gPSB2YWx1ZTsKCQlpZiAoIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCXRoaXMuYnV0dG9uLmJ1dHRvbk1hcmt1cCggb3AgKTsKCQkJLy8gUmVjb3JkIHRoZSBvcHRpb24gY2hhbmdlIGluIHRoZSBvcHRpb25zIGFuZCBpbiB0aGUgRE9NIGRhdGEtKiBhdHRyaWJ1dGVzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQl9CgkJdGhpcy5fc3VwZXIoICJfc2V0T3B0aW9uIiwga2V5LCB2YWx1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggJGVsLnByb3AoImRpc2FibGVkIikgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoKCQkvLyBHcmFiIHRoZSBidXR0b24ncyB0ZXh0IGVsZW1lbnQgZnJvbSBpdHMgaW1wbGVtZW50YXRpb24taW5kZXBlbmRlbnQgZGF0YSBpdGVtCgkJJCggdGhpcy5idXR0b24uZGF0YSggJ2J1dHRvbkVsZW1lbnRzJyApLnRleHQgKVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbnRyb2wsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1NlbGVjdCA9IHRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBjVHlwZSA9PT0gInNlbGVjdCIsCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQlsYWJlbCA9ICRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICksCgkJCW1pbiA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgkJCW9wdGlvbnMsCgkJCXdyYXBwZXI7CgkJCQoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFt0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciAiIDogInVpLXNsaWRlci10cmFjayAiLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiLCBtaW5pQ2xhc3NdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCB2YXIgaiA9IDAsIGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDsgaiA8IGxlbmd0aDsgaisrICkgewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZCggZG9tU2xpZGVyLmNoaWxkTm9kZXNbal0gKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCB3cmFwcGVyICk7CgoJCQkvLyBzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQl2YXIgc2lkZSA9ICFpID8gImIiIDogImEiLAoJCQkJCXNsaWRlclRoZW1lID0gIWkgPyAiIHVpLWJ0bi1kb3duLSIgKyB0cmFja1RoZW1lIDogKCAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLAoJCQkJCXNsaWRlckxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIHNsaWRlclRoZW1lLCAiIHVpLWJ0bi1jb3JuZXItYWxsIl0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgkJCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoJCQkKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4ICsgdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQkKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQoJCQkJLy8gdGhpcy5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQl0aGlzLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoJCQkJCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoJCQoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItdHJhY2siLCIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUsJyB1aS1idG4tY29ybmVyLWFsbCcsICggdGhpcy5vcHRpb25zLm1pbmkgKSA/ICIgdWktbWluaSI6IiJdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KTsKCgkJdmFyIHB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoLAoJCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKSwKCQkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCQkJCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIG5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhciB2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJdmFyIGFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXZhciBwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVlbm93IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZXRleHQiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAidGl0bGUiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5jc3MoICJ3aWR0aCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl9CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGFiID0gJCggdGhpcyApLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWRpc2FibGVkOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlY29uZExhYmVsLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWVsQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiA6ICJ1aS1yYW5nZXNsaWRlciIsCgkJCV9pbnB1dEZpcnN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLAoJCQlfaW5wdXRMYXN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5sYXN0KCksCgkJCWxhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyRmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPVwidWktcmFuZ2VzbGlkZXItc2xpZGVyc1wiIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCQkJCgkJCWlmICggJGVsLmZpbmQoICJsYWJlbCIgKS5sZW5ndGggPiAxICkgewoJCQkJc2Vjb25kTGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmxhc3QoKS5oaWRlKCk7CgkJCX0KCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCQkJCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCWxhYmVsLnByZXBlbmRUbyggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoJCQkKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKXsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgkJCQoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250IAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXJBcHBseSggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQkkZWwuZmluZCggImlucHV0IiApLnNsaWRlcih7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCXRyYWNrVGhlbWU6IG8udHJhY2tUaGVtZSwKCQkJCWRpc2FibGVkOiBvLmRpc2FibGVkLAoJCQkJbWluaTogby5taW5pLAoJCQkJaGlnaGxpZ2h0OiBvLmhpZ2hsaWdodAoJCQl9KS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQl9LAoKCQlfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggZXZlbnQudHlwZSA9PT0gImtleXVwIiApIHsKCQkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQltaW4gPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpLCAxMCApLAoJCQkJbWF4ID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRMYXN0LnZhbCgpLCAxMCApLAoJCQkJZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApLAoJCQkJdGhpc1NsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRGaXJzdCA6IHRoaXMuX2lucHV0TGFzdCwKCQkJCW90aGVyU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoJCQkKCQkJCgkJCWlmKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiggZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgKXsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIG1pbiA+IG1heCAmJiAhdGhpcy5fc2xpZGVyVGFyZ2V0ICkgewoJCQkJLy90aGlzIHByZXZlbnRzIG1pbiBmcm9tIGJlaW5nIGdyZWF0ZXIgdGhlbiBtYXgKCQkJCXRoaXNTbGlkZXIudmFsKCBmaXJzdCA/IG1heDogbWluICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCXRoaXMuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCX0gZWxzZSBpZiAoIG1pbiA+IG1heCApIHsKCQkJCS8vdGhpcyBtYWtlcyBpdCBzbyBjbGlja3Mgb24gdGhlIHRhcmdldCBvbiBlaXRoZXIgZXh0cmVtZSBnbyB0byB0aGUgY2xvc2VzdCBoYW5kbGUKCQkJCXRoaXNTbGlkZXIudmFsKCB0aGlzLl90YXJnZXRWYWwgKS5zbGlkZXIoICJyZWZyZXNoIiApOwoKCQkJCS8vWW91IG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBzbyBmaXJzdCBzbGlkZXIgaXMgdXBkYXRlZCBiZWZvcmUgdXBkYXRpbmcgc2Vjb25kCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlvdGhlclNsaWRlci52YWwoIGZpcnN0ID8gbWluOiBtYXggKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMCApOwoJCQl9IGVsc2UgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCQkJCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCXdpZHRoID0gKG1heCAtIG1pbik7CgoJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItYmciICkuY3NzKHsKCQkJCSJtYXJnaW4tbGVmdCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKS5maW5kKCAibGFiZWwiICkuc2hvdygpOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSk7CgokLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQubW9iaWxlLnJhbmdlc2xpZGVyLCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnJhbmdlc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImFycm93LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpICkiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SUQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElEICsiJ10iICkuYWRkQ2xhc3MoICJ1aS1zZWxlY3QiICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLnNlbGVjdCwgImMiICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCIgKSA/ICJ1aS1idG4tbGVmdCIgOiAidWktYnRuLXJpZ2h0IiApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWlubGluZSA9IG9wdGlvbnMuaW5saW5lIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvcHRpb25zLm1pbmkgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggIm1pbmkiICksCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQkvLyBJRSB0aHJvd3MgYW4gZXhjZXB0aW9uIGF0IG9wdGlvbnMuaXRlbSgpIGZ1bmN0aW9uIHdoZW4KCQkJLy8gdGhlcmUgaXMgbm8gc2VsZWN0ZWQgaXRlbQoJCQkvLyBzZWxlY3QgZmlyc3QgaW4gdGhpcyBjYXNlCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXggPT09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IGljb25wb3MsCgkJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQkJY29ybmVyczogb3B0aW9ucy5jb3JuZXJzLAoJCQkJCXNoYWRvdzogb3B0aW9ucy5zaGFkb3csCgkJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93LAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQkJCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uZmluZCggIi51aS1idG4tdGV4dCIgKS5odG1sKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuLnRleHQoIHRleHQgKQoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKTsKCQl9KTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCWZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5TaXplLCBzZWdTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7CgkJdmFyIHJldCA9IGRlc2lyZWQ7CgoJCWlmICggd2luU2l6ZSA8IHNlZ1NpemUgKSB7CgkJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJCX0gZWxzZSB7CgkJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglmdW5jdGlvbiB3aW5kb3dDb29yZHMoKSB7CgkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3c7CgoJCXJldHVybiB7CgkJCXg6ICR3aW4uc2Nyb2xsTGVmdCgpLAoJCQl5OiAkd2luLnNjcm9sbFRvcCgpLAoJCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkd2luLndpZHRoKCkgKSwKCQkJY3k6ICggd2luZG93LmlubmVySGVpZ2h0IHx8ICR3aW4uaGVpZ2h0KCkgKQoJCX07Cgl9CgoJJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJCXNoYWRvdzogdHJ1ZSwKCQkJY29ybmVyczogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQkJdG9sZXJhbmNlOiBudWxsLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiwKCQkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJCW5hdmlnYXRlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAiLAoJCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCgkJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJCS8vCgkJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCQl9LAoKCQlfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIHNpemUgaXMgaW5jcmVhc2VkIGJleW9uZCB0aGUgcGFnZSBoZWlnaHQgaWYgdGhlIHBvcHVwJ3MgY2F1c2VzIHRoZSBkb2N1bWVudCB0byBpbmNyZWFzZSBpbiBoZWlnaHQKCQlfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIGUua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggZSApOwoJCQl9CgkJfSwKCgkJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQkJdmFyIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpOwoKCQkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQkJaWYgKCB3aW5Db29yZHMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueCAmJgoJCQkJCXdpbkNvb3Jkcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy55ICYmCgkJCQkJd2luQ29vcmRzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeCAmJgoJCQkJCXdpbkNvb3Jkcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3kgKSB7CgkJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCQl0aW1lb3V0SWQ6IHNldFRpbWVvdXQoICQucHJveHkoIHRoaXMsICJfcmVzaXplVGltZW91dCIgKSwgMjAwICksCgkJCQl3aW5Db29yZHM6IHdpbkNvb3JkcwoJCQl9OwoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoJCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCQl9CgoJCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0sCgoJCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCQl9CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHNlbGYuX2lnbm9yZVJlc2l6ZVRvID0gMDsgfSwgMTAwMCApOwoJCX0sCgoJCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkKCQkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQkJfQoJCX0sCgoJCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCgkJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciB0Z3QgPSBlLnRhcmdldCwgJHRndCwgdWkgPSB0aGlzLl91aTsKCgkJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB0Z3QgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJJHRndCA9ICQoIGUudGFyZ2V0ICk7CgkJCQlpZiAoIDAgPT09ICR0Z3QucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSR0Z3QuYmx1cigpOwoJCQkJCX0pOwoJCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCQl1aS5mb2N1c0VsZW1lbnQgPSAkdGd0OwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVpID0gewoJCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuJz48L2Rpdj4iICksCgkJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQkJY29udGFpbmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktcG9wdXAtY29udGFpbmVyIHVpLXBvcHVwLWhpZGRlbic+PC9kaXY+IiApCgkJCQl9LAoJCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQkJbXlJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQkJdGhpcy5vcHRpb25zLmhpc3RvcnkgPSB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJdGhpc1BhZ2UgPSAkKCAiYm9keSIgKTsKCQkJfQoKCQkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkJLy8gVE9ETyB0aGlzIHdvdWxkIGJlIG5pY2UgYXQgdGhlIHRoZSBtb2JpbGUgd2lkZ2V0IGxldmVsCgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIgPSB0aGlzLm9wdGlvbnMuY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJdGhpc1BhZ2UuYXBwZW5kKCB1aS5zY3JlZW4gKTsKCQkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGlzLmVsZW1lbnQgKTsKCQkJaWYgKCBteUlkICkgewoJCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCQl9CgkJCXVpLmNvbnRhaW5lci5hcHBlbmQoIHRoaXMuZWxlbWVudCApOwoJCQl1aS5mb2N1c0VsZW1lbnQgPSB1aS5jb250YWluZXI7CgoJCQkvLyBBZGQgY2xhc3MgdG8gcG9wdXAgZWxlbWVudAoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1wb3B1cCIgKTsKCgkJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9zY3JvbGxUb3A6IDAsCgkJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCQlfdWk6IHVpLAoJCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQkJX3ByZXJlcXM6IG51bGwsCgkJCQlfaXNPcGVuOiBmYWxzZSwKCQkJCV90b2xlcmFuY2U6IG51bGwsCgkJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJCX0pOwoKCQkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJLy8gQ2F1c2UgaW5pdGlhbCBvcHRpb25zIHRvIGJlIGFwcGxpZWQgYnkgdGhlaXIgaGFuZGxlciBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIHRoZSBvcHRpb24gdG8gdW5kZWZpbmVkCgkJCQkvLyAtIHRoZSBoYW5kbGVyIHRoZW4gc2V0cyBpdCB0byB0aGUgaW5pdGlhbCB2YWx1ZQoJCQkJc2VsZi5vcHRpb25zWyBrZXkgXSA9IHVuZGVmaW5lZDsKCQkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSwgdHJ1ZSApOwoJCQl9KTsKCgkJCXVpLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgJC5wcm94eSggdGhpcywgIl9lYXRFdmVudEFuZENsb3NlIiApICk7CgoJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7CgkJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCQl9KTsKCQkJdGhpcy5fb24oICQubW9iaWxlLmRvY3VtZW50LCB7CgkJCQlmb2N1c2luOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgKQoJCQl9KTsKCQl9LAoKCQlfYXBwbHlUaGVtZTogZnVuY3Rpb24oIGRzdCwgdGhlbWUsIHByZWZpeCApIHsKCQkJdmFyIGNsYXNzZXMgPSAoIGRzdC5hdHRyKCAiY2xhc3MiICkgfHwgIiIpLnNwbGl0KCAiICIgKSwKCQkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCQljdXJyZW50VGhlbWUgPSBudWxsLAoJCQkJbWF0Y2hlcywKCQkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQkJd2hpbGUgKCBjbGFzc2VzLmxlbmd0aCA+IDAgKSB7CgkJCQljdXJyZW50VGhlbWUgPSBjbGFzc2VzLnBvcCgpOwoJCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCBtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMSApIHsKCQkJCQljdXJyZW50VGhlbWUgPSBtYXRjaGVzWyAxIF07CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICggdGhlbWUgIT09IGN1cnJlbnRUaGVtZSApIHsKCQkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggISAoIHRoZW1lID09PSBudWxsIHx8IHRoZW1lID09PSAibm9uZSIgKSApIHsKCQkJCQlkc3QuYWRkQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgdGhlbWVTdHIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLmVsZW1lbnQsIHZhbHVlLCAiYm9keSIgKTsKCQl9LAoKCQlfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuX3VpLnNjcmVlbiwgdmFsdWUsICJvdmVybGF5IiApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAmJiB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0sCgoJCV9zZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9OwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJCWNhc2UgMToKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCQljYXNlIDI6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJCWNhc2UgNDoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJZGVmYXVsdDoKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIGV4Y2x1c2lvbnMsIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJLy8gVE9ETyBSRU1PVkUgRk9SIDEuMi4xIGJ5IG1vdmluZyB0aGVtIG91dCB0byBhIGRlZmF1bHQgb3B0aW9ucyBvYmplY3QKCQkJZXhjbHVzaW9ucyA9IFsKCQkJCSJpbml0U2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua1NlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtFdmVudHMiLAoJCQkJIm5hdmlnYXRlRXZlbnRzIiwKCQkJCSJjbG9zZUV2ZW50cyIsCgkJCQkiaGlzdG9yeSIsCgkJCQkiY29udGFpbmVyIgoJCQldOwoKCQkJJC5tb2JpbGUud2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJaWYgKCAkLmluQXJyYXkoIGtleSwgZXhjbHVzaW9ucyApID09PSAtMSApIHsKCQkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCQlfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJdmFyCgkJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJCXJjID0gewoJCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQkJY3g6IHdpbkNvb3Jkcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQkJY3k6IHdpbkNvb3Jkcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJCX0sCgkJCQltZW51U2l6ZSwgcmV0OwoKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQkJbWVudVNpemUgPSB7CgkJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCQl9OwoKCQkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQkJcmV0ID0gewoJCQkJeDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN4LCBtZW51U2l6ZS5jeCwgcmMueCwgZGVzaXJlZC54ICksCgkJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCQl9OwoKCQkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCQkvLyBmaXggZm9yICQubW9iaWxlLmRvY3VtZW50LmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCQl2YXIgZG9jRWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGRvY0JvZHkgPSBkb2N1bWVudC5ib2R5LAoJCQkJZG9jSGVpZ2h0ID0gTWF0aC5tYXgoIGRvY0VsLmNsaWVudEhlaWdodCwgZG9jQm9keS5zY3JvbGxIZWlnaHQsIGRvY0JvZHkub2Zmc2V0SGVpZ2h0LCBkb2NFbC5zY3JvbGxIZWlnaHQsIGRvY0VsLm9mZnNldEhlaWdodCApOwoKCQkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCQlyZXR1cm4geyBsZWZ0OiByZXQueCwgdG9wOiByZXQueSB9OwoJCX0sCgoJCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIHByZXJlcXM7CgoJCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyBhbmQgc2VsZi5fcHJlcmVxcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4KCQkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkJLy8gc2VsZi5fcHJlcmVxcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZAoJCQkvLyBuZXh0IHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2gKCQkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCQkvLyB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZAoJCQkvLyAtIG1ha2luZyBpdCBzdGFsZS4gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUgc2VsZi5fcHJlcmVxcyBlbnN1cmVzIHRoYXQKCQkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCQlwcmVyZXFzID0gewoJCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCQl9OwoKCQkJcHJlcmVxcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2NyZWVuUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJcHJlcmVxcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzZWxmLl9wcmVyZXFzID0gbnVsbDsKCQkJCQl3aGVuRG9uZSgpOwoJCQkJfQoJCQl9KTsKCgkJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJCX0sCgoJCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVzb2x2ZSB0aGUgZGVmZXJyZWQKCQkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQkJYXJncy5wcmVyZXFzLnNjcmVlbi5yZXNvbHZlKCk7CgoJCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBhcmdzLnRyYW5zaXRpb24gKTsKCQkJCX0KCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCQl9LAoKCQkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCQkvLyB4IGFuZCB5IGNvb3JkaW5hdGVzIGJ5IHNwZWNpZnlpbmcgdGhlIGNlbnRlciBtaWRkbGUgb2YgdGhlIHdpbmRvdyBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIGFic2VudC4KCQkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCQlfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG8gKSB7CgkJCXZhciBkc3QgPSBudWxsLCBvZmZzZXQsIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpLCB4ID0gby54LCB5ID0gby55LCBwVG8gPSBvLnBvc2l0aW9uVG87CgoJCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJCWlmICggcFRvID09PSAid2luZG93IiApIHsKCQkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCQl9IGVsc2UgewoJCQkJCXRyeSB7CgkJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJCWlmICggZHN0ICkgewoJCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJCWRzdCA9IG51bGw7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCQlpZiAoIGRzdCApIHsKCQkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJfQoJCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJfQoKCQkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJCX0sCgoJCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCQlvID0geyB4OiBvLngsIHk6IG8ueSwgcG9zaXRpb25Ubzogby5wb3NpdGlvblRvIH07CgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIG8gKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvICkgKSApOwoJCX0sCgoJCXJlcG9zaXRpb246IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCQkJfQoJCX0sCgoJCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJCX0sCgoJCV9vcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIG8gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSgpKTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5ub29wLAoJCQkJJC5ub29wLAoJCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxc0NvbXBsZXRlIiApICk7CgoJCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG8udHJhbnNpdGlvbjsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvLnRyYW5zaXRpb24gKTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCB0aGlzLl9wYWdlLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5fcGFnZSwgImMiICkgKTsKCQkJfQoKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQkJLy8gR2l2ZSBhcHBsaWNhdGlvbnMgYSBjaGFuY2UgdG8gbW9kaWZ5IHRoZSBjb250ZW50cyBvZiB0aGUgY29udGFpbmVyIGJlZm9yZSBpdCBhcHBlYXJzCgkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkJLyogVE9ETzoKCQkJCVRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkCgkJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQkJdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6CgkJCQlodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgoJCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkJKi8KCgkJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCQl9CgkJCXRoaXMuX2FuaW1hdGUoewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJCXRyYW5zaXRpb246IG8udHJhbnNpdGlvbiwKCQkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCQl9KTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxc0RvbmU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCQl9LAoKCQlfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcVNjcmVlbiIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxc0RvbmUiICkgKTsKCgkJCXRoaXMuX2FuaW1hdGUoIHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQkJdHJhbnNpdGlvbjogKCBpbW1lZGlhdGUgPyAibm9uZSIgOiAoIHRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgKSwKCQkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQkJdGhpcy5fc2V0VGhlbWUoICJub25lIiApOwoJCQl0aGlzLmVsZW1lbnQKCQkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkJLy8gaW5zZXJ0QWZ0ZXIoKSB3aWxsIGRvIG5vdGhpbmcgaWYgdGhlIHBheWxvYWQgZGl2IHdhcyBub3QgYXR0YWNoZWQKCQkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJCS8vIElmIHRoYXQgaGFwcGVucyBhbmQgd2UgcmVtb3ZlIHRoZSBjb250YWluZXIgYSBmZXcgbGluZXMgYmVsb3csIHdlCgkJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCQkuZGV0YWNoKCkKCQkJCS5pbnNlcnRBZnRlciggdGhpcy5fdWkucGxhY2Vob2xkZXIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCQl9CgkJfSwKCgkJX2Nsb3NlUG9wdXA6IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgcGFyc2VkRHN0LCB0b1VybCwgbyA9IHRoaXMub3B0aW9ucywgaW1tZWRpYXRlID0gZmFsc2U7CgoJCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQkJaWYgKCBlICYmIGUudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJCS8vIHRha2UgdGhlIHRpbWUgdG8gcnVuIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24KCQkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJCX0gZWxzZSB7CgkJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCX0KCQkJCXBhcnNlZERzdCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHBhcnNlZERzdCApOwoJCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkJLy8gR29pbmcgdG8gYSBkaWZmZXJlbnQgcGFnZSAtIGNsb3NlIGltbWVkaWF0ZWx5CgkJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJCW8uY29udGFpbmVyLnVuYmluZCggby5jbG9zZUV2ZW50cyApOwoJCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBvLmNsb3NlTGlua1NlbGVjdG9yLCBvLmNsb3NlTGlua0V2ZW50cyApOwoKCQkJdGhpcy5fY2xvc2UoIGltbWVkaWF0ZSApOwoJCX0sCgoJCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCQkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCQkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyCgkJCQkub25lKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJCX0sCgoJCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCQkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCQlvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gdGhpcy5vcHRpb25zLCB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeTsKCgkJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gaWYgaGlzdG9yeSBhbHRlcmF0aW9uIGlzIGRpc2FibGVkIGNsb3NlIG9uIG5hdmlnYXRlIGV2ZW50cwoJCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCQlpZiggISggb3B0cy5oaXN0b3J5ICkgKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLmRlbGVnYXRlKCBvcHRzLmNsb3NlTGlua1NlbGVjdG9yLCBvcHRzLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pOwoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUudXJsSGlzdG9yeTsKCQkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCQljdXJyZW50SXNEaWFsb2cgPSBhY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKTsKCQkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoICIjIiApID4gLTEgPyBoYXNoa2V5IDogIiMiICsgaGFzaGtleSk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQkJfQoKCQkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBoYXNoa2V5OwoJCQl9CgoJCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkJJCh3aW5kb3cpLm9uZSggImJlZm9yZW5hdmlnYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJfSk7CgoJCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7cm9sZTogImRpYWxvZyJ9ICk7CgkJfSwKCgkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCQl9CgkJfQoJfSk7CgoKCS8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7CgkJdmFyIGNsb3Nlc3RQYWdlID0gJGxpbmsuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJuIHRoZSBhYnNvbHV0ZSBocmVmCgkJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQkJb2Zmc2V0OwoKCQlpZiAoIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCQl9KTsKCQl9CgoJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCS8vIENoZWNrIGlmIHdlIGFyZSBpbiBhIGxpc3R2aWV3CgkJCXZhciAkcGFyZW50ID0gJGxpbmsucGFyZW50KCkucGFyZW50KCk7CgkJCWlmICgkcGFyZW50Lmhhc0NsYXNzKCJ1aS1saSIpKSB7CgkJCQkkbGluayA9ICRwYXJlbnQucGFyZW50KCk7CgkJCX0KCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSwgMzAwICk7Cgl9OwoKCS8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQlpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSk7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCSQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJb3JpZ0Rlc3Ryb3kgPSB3aWRnZXQuX2Rlc3Ryb3ksCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJcHJlZml4ID0gKCBzZWxlY3RJRCA/IHNlbGVjdElEIDogKCAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidXVpZC0iICsgd2lkZ2V0LnV1aWQgKSApLAoJCQlwb3B1cElEID0gcHJlZml4ICsgIi1saXN0Ym94IiwKCQkJZGlhbG9nSUQgPSBwcmVmaXggKyAiLWRpYWxvZyIsCgkJCWxhYmVsID0gd2lkZ2V0LmxhYmVsLAoJCQl0aGlzUGFnZSA9IHdpZGdldC5zZWxlY3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlzZWxlY3RPcHRpb25zID0gd2lkZ2V0Ll9zZWxlY3RPcHRpb25zKCksCgkJCWlzTXVsdGlwbGUgPSB3aWRnZXQuaXNNdWx0aXBsZSA9IHdpZGdldC5zZWxlY3RbIDAgXS5tdWx0aXBsZSwKCQkJYnV0dG9uSWQgPSBzZWxlY3RJRCArICItYnV0dG9uIiwKCQkJbWVudUlkID0gc2VsZWN0SUQgKyAiLW1lbnUiLAoJCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgaWQ9JyIgKyBkaWFsb2dJRCArICInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElEICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZSIsIHdpZGdldC5vcHRpb25zLmRpdmlkZXJUaGVtZSApCgkJCQkJLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoKCQkJaGVhZGVyID0gJCggIjxkaXY+IiwgewoJCQkJImNsYXNzIjogInVpLWhlYWRlciB1aS1iYXItIiArIHdpZGdldC5vcHRpb25zLnRoZW1lCgkJCX0pLnByZXBlbmRUbyggbGlzdGJveCApLAoKCQkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS10aXRsZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApLAoKCQkJbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLAoJCQloZWFkZXJDbG9zZTsKCgkJaWYgKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElEOiBwb3B1cElELAoJCQlkaWFsb2dJRDogZGlhbG9nSUQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCWlmICggc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSBzZWxmLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJCQkvLyBub25lIHByZXNlbnQuCgkJCQkJc2VsZi5fb3JpZ1RhYkluZGV4ID0gKCBzZWxmLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkIHx8IHNlbGYuaXNPcGVuICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoZXZlbnQudHlwZSA9PT0gInZjbGljayIgfHwKCQkJCQkJCWV2ZW50LmtleUNvZGUgJiYgKGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCWV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQkJCQlzZWxmLl9kZWNpZGVGb3JtYXQoKTsKCQkJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHNlbGYucG9wdXBJRCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBzZWxmLmRpYWxvZ0lEICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQkJCQl9CgkJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCQkJc2VsZi5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICkKCQkJCQkuYmluZCggImZvY3VzaW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkJCS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYgKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmICggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQljYXNlIDEzOgoJCQkJCQljYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkJCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJCQkJLy8KCQkJCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCQkJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCQkJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkJCQkvLwoJCQkJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCQkJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJCQkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCQkJCS8vCgkJCQkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJCQkJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlLmNhbGwoIHNlbGYudGhpc1BhZ2UgKTsKCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBvbiB0aGUgcG9wdXAKCQkJCXNlbGYubGlzdGJveC5iaW5kKCAicG9wdXBhZnRlcmNsb3NlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoKCQkJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJc2VsZi5oZWFkZXJDbG9zZS5jbGljayhmdW5jdGlvbigpIHsKCQkJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIiApOwoJCQl9LAoKCQkJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlUmVidWlsZCAsIGZvbyApIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlpbmRpY2llczsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAoIGl0ZW0uaXMoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKSApIHsKCQkJCQkJCQkJaXRlbS5uZXh0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJaXRlbS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJfSwKCgkJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJCQl9CgoJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJCQl9LAoKCQkJb3BlbjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmJ1dHRvbi5jbGljaygpOwoJCQl9LAoKCQkJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJCQltZW51V2lkdGggPSBzZWxmTGlzdFBhcmVudC5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkd2luZG93LndpZHRoKCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQl2YXIgc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIGEiICk7CgkJCQkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCQkJCXNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICJsaS51aS1idG46bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkgYSIgKTsKCQkJCQl9CgkJCQkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZQoJCQkJCQkub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJfSkKCQkJCQkJLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYubGlzdGJveC5vbmUoICJwb3B1cGFmdGVyb3BlbiIsIGZvY3VzTWVudUl0ZW0gKTsKCQkJCX0KCQkJfSwKCgkJCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQl2YXIgJG9wdGlvbnMgPSBzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLAoJCQkJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGgsCgkJCQkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXSwKCQkJCQlkYXRhUHJlZml4ID0gJ2RhdGEtJyArICQubW9iaWxlLm5zLAoJCQkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgJ29wdGlvbi1pbmRleCcsCgkJCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICdpY29uJywKCQkJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgJ3JvbGUnLAoJCQkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgJ3BsYWNlaG9sZGVyJywKCQkJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQkJCW9wdEdyb3VwOwoKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJCQl2YXIgb3B0aW9uID0gJG9wdGlvbnNbaV0sCgkJCQkJCSRvcHRpb24gPSAkKCBvcHRpb24gKSwKCQkJCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGUsCgkJCQkJCXRleHQgPSAkb3B0aW9uLnRleHQoKSwKCQkJCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdhJyApLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICdocmVmJywgJyMnICk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggJ2xhYmVsJyApOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCByZWNvcmQgdGhlIGZhY3QgdGhhdCBpdCB3YXMKCQkJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCQkJaWYgKCBudWxsID09PSBvcHRpb24uZ2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyICkgKSB7CgkJCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJCQl9CgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsaSApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQkJCXRoaXMuaGVhZGVyLmhpZGUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJCQl9CgoJCQkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCQkJfSwKCgkJCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfSwKCgkJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuY2xvc2UoKTsKCgkJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQkJdGhpcy5fc2VsZWN0T3B0aW9ucygpLnJlbW92ZUF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJwbGFjZWhvbGRlciIgKTsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCQl0aGlzLmxpc3Rib3gucmVtb3ZlKCk7CgoJCQkJLy8gQ2hhaW4gdXAKCQkJCW9yaWdEZXN0cm95LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBzZWxlY3RtZW51V2lkZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuZGF0YSggIm1vYmlsZS1zZWxlY3RtZW51IiApOwoKCQlpZiAoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSAmJgoJCQkJc2VsZWN0bWVudVdpZGdldC5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCQlvcHRpb25zOiB7CgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IHRydWUsCgkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJCW1pbmk6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXVpID0gewoJCQkJCWlubmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICksCgkJCQkJbGVnZW5kOiAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz48L2Rpdj4iICkKCQkJCX0sCgkJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCSRlbC53cmFwSW5uZXIoIHVpLmlubmVyICk7CgkJCWlmICggZ3JvdXBsZWdlbmQubGVuZ3RoICkgewoJCQkJdWkubGVnZW5kLmFwcGVuZCggZ3JvdXBsZWdlbmQgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCX0KCQkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAiICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2luaXRpYWxSZWZyZXNoOiB0cnVlCgkJCX0pOwoKCQkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJLy8gQ2F1c2UgaW5pdGlhbCBvcHRpb25zIHRvIGJlIGFwcGxpZWQgYnkgdGhlaXIgaGFuZGxlciBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIHRoZSBvcHRpb24gdG8gdW5kZWZpbmVkCgkJCQkvLyAtIHRoZSBoYW5kbGVyIHRoZW4gc2V0cyBpdCB0byB0aGUgaW5pdGlhbCB2YWx1ZQoJCQkJc2VsZi5vcHRpb25zWyBrZXkgXSA9IHVuZGVmaW5lZDsKCQkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSwgdHJ1ZSApOwoJCQl9KTsKCQl9LAoKCQlfaW5pdDogZnVuY3Rpb24oKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl2YXIgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJCWlmICggdGhpc1sgc2V0dGVyIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXNbIHNldHRlciBdKCB2YWx1ZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJfSwKCgkJX3NldFR5cGU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgdmFsdWUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFNoYWRvdzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCX0sCgoJCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWNvbnRyb2xzIiApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgZWxzID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktYnRuIiApLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApLAoJCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiOm1vYmlsZS1jaGVja2JveHJhZGlvIiApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCQl9CgkJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywgdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywgY3JlYXRlICk7CgkJCXRoaXMuX2luaXRpYWxSZWZyZXNoID0gZmFsc2U7CgkJfQoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKCS8vIFRPRE86IEltcGxlbWVudCBhIG1lY2hhbmlzbSB0byBhbGxvdyB3aWRnZXRzIHRvIGJlY29tZSBlbmhhbmNlZCBpbiB0aGUKCS8vIGNvcnJlY3Qgb3JkZXIgd2hlbiB0aGVpciBjb3JyZWN0IGVuaGFuY2VtZW50IGRlcGVuZHMgb24gb3RoZXIgd2lkZ2V0cyBpbgoJLy8gdGhlIHBhZ2UgYmVpbmcgY29ycmVjdGx5IGVuaGFuY2VkIGFscmVhZHkuCgkvLwoJLy8gRm9yIG5vdywgd2Ugd2FpdCB1bnRpbCBkb20tcmVhZHkgdG8gYXR0YWNoIHRoZSBjb250cm9sZ3JvdXAncyBlbmhhbmNlbWVudAoJLy8gaG9vaywgYmVjYXVzZSBieSB0aGF0IHRpbWUsIGFsbCB0aGUgb3RoZXIgd2lkZ2V0cycgZW5oYW5jZW1lbnQgaG9va3Mgc2hvdWxkCgkvLyBhbHJlYWR5IGJlIGluIHBsYWNlLCBlbnN1cmluZyB0aGF0IGFsbCB3aWRnZXRzIHRoYXQgbmVlZCB0byBiZSBncm91cGVkIHdpbGwKCS8vIGFscmVhZHkgaGF2ZSBiZWVuIGVuaGFuY2VkIGJ5IHRoZSB0aW1lIHRoZSBjb250cm9sZ3JvdXAgaXMgY3JlYXRlZC4KCSQoIGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgIHsKCQkJJC5tb2JpbGUuY29udHJvbGdyb3VwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJCX0pOwoJfSk7Cn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYgKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXNlbGYuZGVzdHJveSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZml4ZWQiICk7CgoJCQkvLyAiZnVsbHNjcmVlbiIgb3ZlcmxheSBwb3NpdGlvbmluZwoJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV90aGlzUGFnZTogbnVsbAoJCQl9KTsKIAoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaXMoICIudWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHRoaXMuX3RoaXNQYWdlLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggIW8udmlzaWJsZU9uUGFnZVNob3cgKSB7CgkJCQl0aGlzLmhpZGUoIHRydWUgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVBbmltYXRpb25TdGFydDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCksCgkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4gCgkJCXRiUGFnZSA9ICggdGJQYWdlICYmIHRiUGFnZS50eXBlID09PSB1bmRlZmluZWQgJiYgdGJQYWdlICkgfHwgdGhpcy5fdGhpc1BhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICsgcG9zICk7CgkJfSwKCgkJX3VzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGJ0eXBlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGJ0eXBlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCdpbicpOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWU7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaCAKCQkJCQkvL3Bvc2l0aW9ucyBmaXhlZCB0b29sYmFycyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBzY3JlZW4gb24gcG9wIGlmIHRoZSBpbnB1dCBpcyBuZWFyIHRoZSB0b3Agb3IKCQkJCQkvL2JvdHRvbSBvZiB0aGUgc2NyZWVuIGFkZHJlc3NlcyBpc3N1ZXMgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJLy9hbmQgaXNzdWUgIzQxMTMgSGVhZGVyIGFuZCBmb290ZXIgY2hhbmdlIHRoZWlyIHBvc2l0aW9uIGFmdGVyIGtleWJvYXJkIHBvcHVwIC0gaU9TCgkJCQkJLy9hbmQgaXNzdWUgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCAxMDI1ICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQkvL0ZpeCBmb3IgaXNzdWUgIzQ3MjQgTW92aW5nIHRocm91Z2ggZm9ybSBpbiBNb2JpbGUgU2FmYXJpIHdpdGggIk5leHQiIGFuZCAiUHJldmlvdXMiIHN5c3RlbSAKCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsgCgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsgCgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJC5tb2JpbGUuZG9jdW1lbnQKCQkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJCQkvLyBERVBSRUNBVEVEIGluIDEuMTogc3VwcG9ydCBmb3IgZGF0YS1mdWxsc2NyZWVuPXRydWV8ZmFsc2Ugb24gdGhlIHBhZ2UgZWxlbWVudC4KCQkJLy8gVGhpcyBsaW5lIGVuc3VyZXMgaXQgc3RpbGwgd29ya3MsIGJ1dCB3ZSByZWNvbW1lbmQgbW92aW5nIHRoZSBhdHRyaWJ1dGUgdG8gdGhlIHRvb2xiYXJzIHRoZW1zZWx2ZXMuCgkJCWlmICggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJCSQoICQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubm90KCAiOmpxbURhdGEoZnVsbHNjcmVlbikiICkuanFtRGF0YSggImZ1bGxzY3JlZW4iLCB0cnVlICk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKCQl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUuZml4ZWR0b29sYmFyLCB7CgoJCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCQl9LAoKCQkJLy9jaGVjayB0aGUgYnJvd3NlciBhbmQgdmVyc2lvbiBhbmQgcnVuIG5lZWRlZCB3b3JrYXJvdW5kcwoJCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQlvcyA9IG51bGwsCgkJCQlzZWxmID0gdGhpczsKCQkJCS8vc2V0IHRoZSBvcyB3ZSBhcmUgd29ya2luZyBpbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCQlpZiggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKXsKCQkJCQlvcyA9ICJpb3MiOwoJCQkJfSBlbHNlIGlmKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiYW5kcm9pZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCQlpZiggb3MgPT09ICJpb3MiICkgewoJCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgaWYoIG9zID09PSAiYW5kcm9pZCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHsKCQkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQkJc2VsZi5fYmluZExpc3RUaHVtYldvcmthcm91bmQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9LAoKCQkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQkJX3ZpZXdwb3J0T2Zmc2V0OiBmdW5jdGlvbigpIHsKCQkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCQlvZmZzZXQgPSBNYXRoLmFicygkZWwub2Zmc2V0KCkudG9wIC0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpKTsKCQkJCWlmKCAhaGVhZGVyICkgewoJCQkJCW9mZnNldCA9IE1hdGgucm91bmQob2Zmc2V0IC0gJC5tb2JpbGUud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkpLTYwOwoJCQkJfQoJCQkJcmV0dXJuIG9mZnNldDsKCQkJfSwKCgkJCS8vYmluZCBldmVudHMgZm9yIF90cmlnZ2VyUmVkcmF3KCkgZnVuY3Rpb24gCgkJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQkJaWYoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlKSB7CgkJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCQl9CgkJCQl9fSk7CgkJCX0sCgoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZSIpLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQkJfSwKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkgCgkJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJCXZhciBwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsicHgiICk7CgkJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCQkvL3RoaXMgaXMgaW5kZXBlbmRhbnQgb2YgSlFNIHRoZSBicm93c2VyIHNlZW1zIHRvIG5lZWQgdGhlIHRpbWUgdG8gcmVhY3QuCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJCX0sIDAgKTsKCQkJfSwKCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fc3VwZXIoKTsKCQkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54IAoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoIi51aS1wYWdlLWFjdGl2ZSIpLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJCX0KCX0pOwoKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlUGFuZWw6ICJ1aS1wYWdlLXBhbmVsIiwKCQkJcGFnZVBhbmVsT3BlbjogInVpLXBhZ2UtcGFuZWwtb3BlbiIsCgkJCWNvbnRlbnRXcmFwOiAidWktcGFuZWwtY29udGVudC13cmFwIiwKCQkJY29udGVudFdyYXBPcGVuOiAidWktcGFuZWwtY29udGVudC13cmFwLW9wZW4iLAoJCQljb250ZW50V3JhcENsb3NlZDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1jbG9zZWQiLAoJCQljb250ZW50Rml4ZWRUb29sYmFyOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyIiwKCQkJY29udGVudEZpeGVkVG9vbGJhck9wZW46ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXItb3BlbiIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXItY2xvc2VkIiwKCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiAiYyIsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BhbmVsJykiLAoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX3BhbmVsSUQ6IG51bGwsCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcjogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJcGFnZSA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlfZ2V0UGFnZVRoZW1lID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoZW1lID0gJC5kYXRhKCBwYWdlWzBdLCAibW9iaWxlUGFnZSIgKS5vcHRpb25zLnRoZW1lLAoJCQkJJHBhZ2VUaGVtZUNsYXNzID0gInVpLWJvZHktIiArICR0aGVtZTsKCQkJCXJldHVybiAkcGFnZVRoZW1lQ2xhc3M7CgkJCX0sCgkJCV9nZXRQYW5lbElubmVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHBhbmVsSW5uZXIgPSAkZWwuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoJCQkJaWYgKCAkcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJHBhbmVsSW5uZXIgPSAkZWwuY2hpbGRyZW4oKS53cmFwQWxsKCAnPGRpdiBjbGFzcz0iJyArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCX0KCQkJCXJldHVybiAkcGFuZWxJbm5lcjsKCQkJfSwKCQkJX2dldFdyYXBwZXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkd3JhcHBlciA9IHBhZ2UuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKTsKCQkJCWlmICggJHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSR3cmFwcGVyID0gcGFnZS5jaGlsZHJlbiggIi51aS1oZWFkZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSwgLnVpLWNvbnRlbnQ6bm90KDpqcW1EYXRhKHJvbGU9J3BvcHVwJykpLCAudWktZm9vdGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSkiICkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcCArICcgJyArIF9nZXRQYWdlVGhlbWUoKSArICciIC8+JyApLnBhcmVudCgpOwoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCQkJCSR3cmFwcGVyLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICR3cmFwcGVyOwoJCQl9LAoJCQlfZ2V0Rml4ZWRUb29sYmFyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJaWYgKCAkZml4ZWRUb29sYmFyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkZml4ZWRUb29sYmFyID0gcGFnZS5maW5kKCAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpLCAudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiICkuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkZml4ZWRUb29sYmFyLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICRmaXhlZFRvb2xiYXI7CgkJCX07CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiAkZWwuYXR0ciggImlkIiApLAoJCQlfY2xvc2VMaW5rOiAkZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhZ2U6ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlfcGFnZVRoZW1lOiBfZ2V0UGFnZVRoZW1lKCksCgkJCV9wYW5lbElubmVyOiBfZ2V0UGFuZWxJbm5lcigpLAoJCQlfd3JhcHBlcjogX2dldFdyYXBwZXIoKSwKCQkJX2ZpeGVkVG9vbGJhcjogX2dldEZpeGVkVG9vbGJhcigpCgkJfSk7CgkJCgkJc2VsZi5fYWRkUGFuZWxDbGFzc2VzKCk7CgkJc2VsZi5fd3JhcHBlci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCQlzZWxmLl9maXhlZFRvb2xiYXIuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKTsKCQkvLyBhZGQgY2xhc3MgdG8gcGFnZSBzbyB3ZSBjYW4gc2V0ICJvdmVyZmxvdy14OiBoaWRkZW47IiBmb3IgaXQgdG8gZml4IEFuZHJvaWQgem9vbSBpc3N1ZQoJCXNlbGYuX3BhZ2UuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhZ2VQYW5lbCApOwoJCQoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCQkKCQlzZWxmLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJc2VsZi5fYmluZENsb3NlRXZlbnRzKCk7CgkJc2VsZi5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhc2VsZi5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQlzZWxmLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJc2VsZi5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInIGRhdGEtcGFuZWxpZD0nIiArIHNlbGYuX3BhbmVsSUQgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGhpcy5fcGFnZSApOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiB1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWU7CgkJfQoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQ7CgkJfQoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKCBlICkgewoJCQlzZWxmLmNsb3NlKCk7CgkJfSk7CQkKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJc2VsZi5fc2Nyb2xsSW50b1ZpZXcoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQl9IGVsc2UgewoJCQlzZWxmLl9maXhQYW5lbCgpOwoJCX0KCX0sCgoJX3Njcm9sbEludG9WaWV3OiBmdW5jdGlvbiggcGFuZWxJbm5lckhlaWdodCApIHsKCQlpZiAoIHBhbmVsSW5uZXJIZWlnaHQgPCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSApIHsKCQkJd2luZG93LnNjcm9sbFRvKCAwLCAwICk7CgkJfQkKCX0sCgoJX2JpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICQoIHdpbmRvdyApLCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAiX3Bvc2l0aW9uUGFuZWwiIH0pOwoJfSwKCglfdW5iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29mZiggJCggd2luZG93ICksICJ0aHJvdHRsZWRyZXNpemUiICk7Cgl9LAoKCV91bmZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2ZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgkKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5lbGVtZW50Lm9uKCAidXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fcGFnZS5vbiggImNsaWNrLnBhbmVsIiAsICJhIiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5ocmVmLnNwbGl0KCAiIyIgKVsgMSBdID09PSBzZWxmLl9wYW5lbElEICYmIHNlbGYuX3BhbmVsSUQgIT09IHVuZGVmaW5lZCApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKTsKCQkJCWlmICggISAkbGluay5oYXNDbGFzcyggInVpLWxpbmsiICkgKSB7CgkJCQkJJGxpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJc2VsZi5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCX0pOwoJCQkJfQoJCQkJc2VsZi50b2dnbGUoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoJfSwKCQoJX2JpbmRTd2lwZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmVhID0gc2VsZi5fbW9kYWwgPyBzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl9tb2RhbCApIDogc2VsZi5lbGVtZW50OwoJCQoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWFyZWEub24oICJzd2lwZXJpZ2h0LnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQkKCQlzZWxmLl9wYWdlCgkJCS8vIENsb3NlIHRoZSBwYW5lbCBpZiBhbm90aGVyIHBhbmVsIG9uIHRoZSBwYWdlIG9wZW5zCgkJCS5vbiggInBhbmVsYmVmb3Jlb3BlbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICYmIGUudGFyZ2V0ICE9PSBzZWxmLmVsZW1lbnRbIDAgXSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pCgkJCS8vIGNsZWFuIHVwIG9wZW4gcGFuZWxzIGFmdGVyIHBhZ2UgaGlkZQoJCQkub24oICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLy8gb24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoKCV9jb250ZW50V3JhcE9wZW5DbGFzc2VzOiBudWxsLAoJX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX3BhZ2Uub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlLmpxbURhdGEoICJwYW5lbCIsICJvcGVuIiApOwoJCQkJCQoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCQkJCQkKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlCgkJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJCQkKCQkJCQkvLyBGaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIuY3NzKCAibWluLWhlaWdodCIsIHNlbGYuX3BhZ2UuY3NzKCAibWluLWhlaWdodCIgKSApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5jb250ZW50V3JhcCApOwoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzICsgIiAiICsgby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCQkJCQoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJc2VsZi5fcGFnZS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLmxlbmd0aCA8IDAgKSB7CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9CgkJCQoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCQkJCgkJCWlmICggc2VsZi5fcGFnZS5qcW1EYXRhKCdwYW5lbCcpID09PSAib3BlbiIgKSB7CgkJCQlzZWxmLl9wYWdlLm9uKCAicGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCV9vcGVuUGFuZWwoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJX29wZW5QYW5lbCgpOwoJCQl9CgkJCQoJCQlzZWxmLl9vcGVuID0gdHJ1ZTsKCQl9Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQlzZWxmID0gdGhpcywKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuX3BhZ2UucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQkJc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgkJCQkJc2VsZi5fd3JhcHBlci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCQkJCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApOwoJCQkJCQkvLyByZXNldCBmaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCAiIiApOwoJCQkJCX0KCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgkJCQkJCgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4UGFuZWwoKTsKCQkJCQlzZWxmLl91bmJpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQkJCQoJCQkJCXNlbGYuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgkJCQkKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgkKCXRvZ2dsZTogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaGFzT3RoZXJTaWJsaW5nUGFuZWxzID0gdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiLiIgKyBjbGFzc2VzLnBhbmVsICkubGVuZ3RoOwoKCQkvLyBjcmVhdGUKCQlpZiAoICFoYXNPdGhlclNpYmxpbmdQYW5lbHMgKSB7CgkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJdGhpcy5fcGFnZS5maW5kKCAiYSIgKS51bmJpbmQoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQkJfQoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9IGVsc2UgaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQl0aGlzLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQlpZiAoIHRoZW1lICkgewoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQl9CgkJfQoJCQoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCBbIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpLCBjbGFzc2VzLnBhbmVsQW5pbWF0ZSBdLmpvaW4oICIgIiApICkKCQkJLm9mZiggInN3aXBlbGVmdC5wYW5lbCBzd2lwZXJpZ2h0LnBhbmVsIiApCgkJCS5vZmYoICJwYW5lbGJlZm9yZW9wZW4iICkKCQkJLm9mZiggInBhbmVsaGlkZSIgKQoJCQkub2ZmKCAia2V5dXAucGFuZWwiICkKCQkJLm9mZiggInVwZGF0ZWxheW91dCIgKTsKCgkJdGhpcy5fY2xvc2VMaW5rLm9mZiggImNsaWNrLnBhbmVsIiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9CgoJCS8vIG9wZW4gYW5kIGNsb3NlCgkJdGhpcy5lbGVtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApCgkJCS5yZW1vdmVDbGFzcyggWyBjbGFzc2VzLnBhbmVsVW5maXhlZCwgY2xhc3Nlcy5wYW5lbENsb3NlZCwgY2xhc3Nlcy5wYW5lbE9wZW4gXS5qb2luKCAiICIgKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUucGFuZWwucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLndpZGdldCwgewoKCQlvcHRpb25zOiB7CgkJCWNsYXNzZXM6IHsKCQkJCXRhYmxlOiAidWktdGFibGUiCgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJc2VsZi5yZWZyZXNoKCB0cnVlICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24gKGNyZWF0ZSkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQl0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQkJaWYgKCBjcmVhdGUgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJCX0KCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQlzZWxmLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5IGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJc2VsZi5hbGxIZWFkZXJzID0gc2VsZi5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCgkJCXRycy5lYWNoKGZ1bmN0aW9uKCl7CgoJCQkJdmFyIGNvbHRhbGx5ID0gMDsKCgkJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uKCBpICl7CgoJCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQkJc2VsID0gIjpudGgtY2hpbGQoIiArICggY29sdGFsbHkgKyAxICkgKyAiKSI7CgkJCQkJJCggdGhpcyApCgkJCQkJCS5qcW1EYXRhKCAiY29sc3RhcnQiLCBjb2x0YWxseSArIDEgKTsKCgkJCQkJaWYoIHNwYW4gKXsKCQkJCQkJZm9yKCB2YXIgaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICl7CgkJCQkJCQljb2x0YWxseSsrOwoJCQkJCQkJc2VsICs9ICIsIDpudGgtY2hpbGQoIiArICggY29sdGFsbHkgKyAxICkgKyAiKSI7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggY3JlYXRlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSQodGhpcykuanFtRGF0YSgiY2VsbHMiLCAiIik7CgkJCQkJfQoJCQkJCS8vIFN0b3JlICJjZWxscyIgZGF0YSBvbiBoZWFkZXIgYXMgYSByZWZlcmVuY2UgdG8gYWxsIGNlbGxzIGluIHRoZSBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkJJCggdGhpcyApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBzZWxmLmVsZW1lbnQuZmluZCggInRyIiApLm5vdCggdHJzLmVxKDApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbCApICk7CgoJCQkJCWNvbHRhbGx5Kys7CgoJCQkJfSk7CgoJCQl9KTsKCgkJCS8vIHVwZGF0ZSB0YWJsZSBtb2RlcwoJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICdyZWZyZXNoJyApOwoJCQl9Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLm1vZGUgPSAiY29sdW1udG9nZ2xlIjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtblBvcHVwVGhlbWUgPSBudWxsOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uQnRuVGV4dCA9ICJDb2x1bW5zLi4uIjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMgPSAkLmV4dGVuZCgKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsCgl7CgkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgkKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCWV2ZW50ID0gZS50eXBlLAoJCW8gPSBzZWxmLm9wdGlvbnMsCgkJbnMgPSAkLm1vYmlsZS5ucywKCQlpZCA9ICggJHRhYmxlLmF0dHIoICJpZCIgKSB8fCBvLmNsYXNzZXMucG9wdXAgKSArICItcG9wdXAiLCAvKiBUT0RPIEJFVFRFUiBGQUxMQkFDSyBJRCBIRVJFICovCgkJJG1lbnVCdXR0b24sCgkJJHBvcHVwLAoJCSRtZW51LAoJCSRzd2l0Y2hib2FyZDsKCglpZiAoIG8ubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCgkJJG1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInIGNsYXNzPSciICsgby5jbGFzc2VzLmNvbHVtbkJ0biArICInIGRhdGEtIiArIG5zICsgInJlbD0ncG9wdXAnIGRhdGEtIiArIG5zICsgIm1pbmk9J3RydWUnPiIgKyBvLmNvbHVtbkJ0blRleHQgKyAiPC9hPiIgKSwKCQkkcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG8uY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iKSwKCQkkbWVudSA9ICQoIjxmaWVsZHNldCBkYXRhLSIgKyBucyArICJyb2xlPSdjb250cm9sZ3JvdXAnPjwvZmllbGRzZXQ+Iik7Cgl9CgkKCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCXNlbGYuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQl2YXIgcHJpb3JpdHkgPSAkKCB0aGlzICkuanFtRGF0YSggInByaW9yaXR5IiApLAoJCQkkY2VsbHMgPSAkKCB0aGlzICkuYWRkKCAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApICk7CgoJCWlmICggcHJpb3JpdHkgKSB7CgoJCQkkY2VsbHMuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wcmlvcml0eVByZWZpeCArIHByaW9yaXR5ICk7CgoJCQlpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArICQoIHRoaXMgKS50ZXh0KCkgKyAiPC9sYWJlbD4iICkKCQkJCQkuYXBwZW5kVG8oICRtZW51ICkKCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCAkY2VsbHMgKQoJCQkJCS5jaGVja2JveHJhZGlvKHsKCQkJCQkJdGhlbWU6IG8uY29sdW1uUG9wdXBUaGVtZQoJCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJCggJyMnICsgaWQgKyAnIGZpZWxkc2V0IGRpdjplcSgnICsgaSArJyknKS5maW5kKCdpbnB1dCcpLmpxbURhdGEoICdjZWxscycsICRjZWxscyApOwoJCQl9CgkJfQoJfSk7CgkKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkbWVudS5hcHBlbmRUbyggJHBvcHVwICk7Cgl9CgoJLy8gYmluZCBjaGFuZ2UgZXZlbnQgbGlzdGVuZXJzIHRvIGlucHV0cyAtIFRPRE86IG1vdmUgdG8gYSBwcml2YXRlIG1ldGhvZD8KCWlmICggJG1lbnUgPT09IHVuZGVmaW5lZCApIHsKCQkkc3dpdGNoYm9hcmQgPSAkKCcjJyArIGlkICsgJyBmaWVsZHNldCcpOwoJfSBlbHNlIHsKCQkkc3dpdGNoYm9hcmQgPSAkbWVudTsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJHN3aXRjaGJvYXJkLm9uKCAiY2hhbmdlIiwgImlucHV0IiwgZnVuY3Rpb24oIGUgKXsKCQkJaWYoIHRoaXMuY2hlY2tlZCApewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApOwoJCQl9CgkJfSk7CgoJCSRtZW51QnV0dG9uCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8uY29sdW1uQnRuVGhlbWUKCQkJfSk7CgoJCSRwb3B1cAoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkucG9wdXAoKTsKCX0KCgkvLyByZWZyZXNoIG1ldGhvZAoJc2VsZi51cGRhdGUgPSBmdW5jdGlvbigpewoJCSRzd2l0Y2hib2FyZC5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMuY2hlY2tlZCkgewoJCQkJdGhpcy5jaGVja2VkID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5lcSgwKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCQlpZiAoZXZlbnQgPT09ICJyZWZyZXNoIikgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtdmlzaWJsZScpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC1oaWRkZW4nKTsKCQkJfQoJCQkkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9OwoKCSQubW9iaWxlLndpbmRvdy5vbiggInRocm90dGxlZHJlc2l6ZSIsIHNlbGYudXBkYXRlICk7CgoJc2VsZi51cGRhdGUoKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gInJlZmxvdyI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlldmVudCA9IGUudHlwZSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJbyA9IHNlbGYub3B0aW9uczsKCgkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCglpZiggby5tb2RlICE9PSAicmVmbG93IiApewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCX0KCgkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCXZhciByZXZlcnNlSGVhZGVycyA9ICAkKCBzZWxmLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICk7CgoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJcmV2ZXJzZUhlYWRlcnMuZWFjaChmdW5jdGlvbiggaSApewoJCXZhciAkY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQljb2xzdGFydCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY29sc3RhcnQiICksCgkJCWhpZXJhcmNoeUNsYXNzID0gJGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJdGV4dCA9ICQodGhpcykudGV4dCgpOwoKCQkJaWYoIHRleHQgIT09ICIiICApewoKCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApewoJCQkJCXZhciBpdGVyYXRpb24gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJaWYoIGl0ZXJhdGlvbiApewoJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJfQoJCQkJCSRjZWxscy5maWx0ZXIoIGZpbHRlciApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRjZWxscy5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoKCQkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJaWYoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICl7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCl7CgkJaWYoICQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCApewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpIHsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBmaW5kIGFuZCBlbmhhbmNlIHRoZSBwYWdlcyBpbiB0aGUgZG9tIGFuZCB0cmFuc2l0aW9uIHRvIHRoZSBmaXJzdCBwYWdlLgoJCWluaXRpYWxpemVQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gZmluZCBwcmVzZW50IHBhZ2VzCgkJCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQkJCSRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9IHBhdGguc3RyaXBIYXNoKCBwYXRoLnN0cmlwUXVlcnlQYXJhbXMocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAnOmpxbURhdGEocm9sZT0icGFnZSIpJyApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "body": "LyoKKiBqUXVlcnkgTW9iaWxlIDEuMy4xCiogR2l0IEhFQUQgaGFzaDogNzRiNGJlYzA0OWZkOTNlNGZlNDAyMDVlNjE1N2RlMTZlYjY0ZWI0NiA8PiBEYXRlOiBXZWQgQXByIDEwIDIwMTMgMjE6NTc6MjMgVVRDCiogaHR0cDovL2pxdWVyeW1vYmlsZS5jb20KKgoqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uLCBJbmMuIGFuZCBvdGhlciBjb250cmlidXRvcnMKKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiogaHR0cDovL2pxdWVyeS5vcmcvbGljZW5zZQoqCiovCgoKKGZ1bmN0aW9uICggcm9vdCwgZG9jLCBmYWN0b3J5ICkgewoJaWYgKCB0eXBlb2YgZGVmaW5lID09PSAiZnVuY3Rpb24iICYmIGRlZmluZS5hbWQgKSB7CgkJLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlLgoJCWRlZmluZSggWyAianF1ZXJ5IiBdLCBmdW5jdGlvbiAoICQgKSB7CgkJCWZhY3RvcnkoICQsIHJvb3QsIGRvYyApOwoJCQlyZXR1cm4gJC5tb2JpbGU7CgkJfSk7Cgl9IGVsc2UgewoJCS8vIEJyb3dzZXIgZ2xvYmFscwoJCWZhY3RvcnkoIHJvb3QualF1ZXJ5LCByb290LCBkb2MgKTsKCX0KfSggdGhpcywgZG9jdW1lbnQsIGZ1bmN0aW9uICggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7CihmdW5jdGlvbiggJCApIHsKCSQubW9iaWxlID0ge307Cn0oIGpRdWVyeSApKTsKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciBuc05vcm1hbGl6ZURpY3QgPSB7fTsKCgkvLyBqUXVlcnkubW9iaWxlIGNvbmZpZ3VyYWJsZSBvcHRpb25zCgkkLm1vYmlsZSA9ICQuZXh0ZW5kKCQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuMy4xIiwKCgkJLy8gTmFtZXNwYWNlIHVzZWQgZnJhbWV3b3JrLXdpZGUgZm9yIGRhdGEtYXR0cnMuIERlZmF1bHQgaXMgbm8gbmFtZXNwYWNlCgkJbnM6ICIiLAoKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCS8vIENsYXNzIGFzc2lnbmVkIHRvIHBhZ2UgY3VycmVudGx5IGluIHZpZXcsIGFuZCBkdXJpbmcgdHJhbnNpdGlvbnMKCQlhY3RpdmVQYWdlQ2xhc3M6ICJ1aS1wYWdlLWFjdGl2ZSIsCgoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gQ2xhc3MgdXNlZCBmb3IgImZvY3VzIiBmb3JtIGVsZW1lbnQgc3RhdGUsIGZyb20gQ1NTIGZyYW1ld29yawoJCWZvY3VzQ2xhc3M6ICJ1aS1mb2N1cyIsCgoJCS8vIEF1dG9tYXRpY2FsbHkgaGFuZGxlIGNsaWNrcyBhbmQgZm9ybSBzdWJtaXNzaW9ucyB0aHJvdWdoIEFqYXgsIHdoZW4gc2FtZS1kb21haW4KCQlhamF4RW5hYmxlZDogdHJ1ZSwKCgkJLy8gQXV0b21hdGljYWxseSBsb2FkIGFuZCBzaG93IHBhZ2VzIGJhc2VkIG9uIGxvY2F0aW9uLmhhc2gKCQloYXNoTGlzdGVuaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gZGlzYWJsZSB0byBwcmV2ZW50IGpxdWVyeSBmcm9tIGJvdGhlcmluZyB3aXRoIGxpbmtzCgkJbGlua0JpbmRpbmdFbmFibGVkOiB0cnVlLAoKCQkvLyBTZXQgZGVmYXVsdCBwYWdlIHRyYW5zaXRpb24gLSAnbm9uZScgZm9yIG5vIHRyYW5zaXRpb25zCgkJZGVmYXVsdFBhZ2VUcmFuc2l0aW9uOiAiZmFkZSIsCgoJCS8vIFNldCBtYXhpbXVtIHdpbmRvdyB3aWR0aCBmb3IgdHJhbnNpdGlvbnMgdG8gYXBwbHkgLSAnZmFsc2UnIGZvciBubyBsaW1pdAoJCW1heFRyYW5zaXRpb25XaWR0aDogZmFsc2UsCgoJCS8vIE1pbmltdW0gc2Nyb2xsIGRpc3RhbmNlIHRoYXQgd2lsbCBiZSByZW1lbWJlcmVkIHdoZW4gcmV0dXJuaW5nIHRvIGEgcGFnZQoJCW1pblNjcm9sbEJhY2s6IDI1MCwKCgkJLy8gREVQUkVDQVRFRDogdGhlIGZvbGxvd2luZyBwcm9wZXJ0eSBpcyBubyBsb25nZXIgaW4gdXNlLCBidXQgZGVmaW5lZCB1bnRpbCAyLjAgdG8gcHJldmVudCBjb25mbGljdHMKCQl0b3VjaE92ZXJmbG93RW5hYmxlZDogZmFsc2UsCgoJCS8vIFNldCBkZWZhdWx0IGRpYWxvZyB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHREaWFsb2dUcmFuc2l0aW9uOiAicG9wIiwKCgkJLy8gRXJyb3IgcmVzcG9uc2UgbWVzc2FnZSAtIGFwcGVhcnMgd2hlbiBhbiBBamF4IHBhZ2UgcmVxdWVzdCBmYWlscwoJCXBhZ2VMb2FkRXJyb3JNZXNzYWdlOiAiRXJyb3IgTG9hZGluZyBQYWdlIiwKCgkJLy8gRm9yIGVycm9yIG1lc3NhZ2VzLCB3aGljaCB0aGVtZSBkb2VzIHRoZSBib3ggdXNlcz8KCQlwYWdlTG9hZEVycm9yTWVzc2FnZVRoZW1lOiAiZSIsCgoJCS8vIHJlcGxhY2UgY2FsbHMgdG8gd2luZG93Lmhpc3RvcnkuYmFjayB3aXRoIHBob25lZ2FwcyBuYXZpZ2F0aW9uIGhlbHBlcgoJCS8vIHdoZXJlIGl0IGlzIHByb3ZpZGVkIG9uIHRoZSB3aW5kb3cgb2JqZWN0CgkJcGhvbmVnYXBOYXZpZ2F0aW9uRW5hYmxlZDogZmFsc2UsCgoJCS8vYXV0b21hdGljYWxseSBpbml0aWFsaXplIHRoZSBET00gd2hlbiBpdCdzIHJlYWR5CgkJYXV0b0luaXRpYWxpemVQYWdlOiB0cnVlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQkvLyBhbGxvd3MgdXNlcnMgdG8gb3B0IGluIHRvIGlnbm9yaW5nIGNvbnRlbnQgYnkgbWFya2luZyBhIHBhcmVudCBlbGVtZW50IGFzCgkJLy8gZGF0YS1pZ25vcmVkCgkJaWdub3JlQ29udGVudEVuYWJsZWQ6IGZhbHNlLAoKCQkvLyB0dXJuIG9mIGJpbmRpbmcgdG8gdGhlIG5hdGl2ZSBvcmllbnRhdGlvbmNoYW5nZSBkdWUgdG8gYW5kcm9pZCBvcmllbnRhdGlvbiBiZWhhdmlvcgoJCW9yaWVudGF0aW9uQ2hhbmdlRW5hYmxlZDogdHJ1ZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRlZmluZSB0aGUgd2luZG93IGFuZCB0aGUgZG9jdW1lbnQgb2JqZWN0cwoJCXdpbmRvdzogJCggd2luZG93ICksCgkJZG9jdW1lbnQ6ICQoIGRvY3VtZW50ICksCgoJCS8vIFRPRE8gbWlnaHQgYmUgdXNlZnVsIHVwc3RyZWFtIGluIGpxdWVyeSBpdHNlbGYgPwoJCWtleUNvZGU6IHsKCQkJQUxUOiAxOCwKCQkJQkFDS1NQQUNFOiA4LAoJCQlDQVBTX0xPQ0s6IDIwLAoJCQlDT01NQTogMTg4LAoJCQlDT01NQU5EOiA5MSwKCQkJQ09NTUFORF9MRUZUOiA5MSwgLy8gQ09NTUFORAoJCQlDT01NQU5EX1JJR0hUOiA5MywKCQkJQ09OVFJPTDogMTcsCgkJCURFTEVURTogNDYsCgkJCURPV046IDQwLAoJCQlFTkQ6IDM1LAoJCQlFTlRFUjogMTMsCgkJCUVTQ0FQRTogMjcsCgkJCUhPTUU6IDM2LAoJCQlJTlNFUlQ6IDQ1LAoJCQlMRUZUOiAzNywKCQkJTUVOVTogOTMsIC8vIENPTU1BTkRfUklHSFQKCQkJTlVNUEFEX0FERDogMTA3LAoJCQlOVU1QQURfREVDSU1BTDogMTEwLAoJCQlOVU1QQURfRElWSURFOiAxMTEsCgkJCU5VTVBBRF9FTlRFUjogMTA4LAoJCQlOVU1QQURfTVVMVElQTFk6IDEwNiwKCQkJTlVNUEFEX1NVQlRSQUNUOiAxMDksCgkJCVBBR0VfRE9XTjogMzQsCgkJCVBBR0VfVVA6IDMzLAoJCQlQRVJJT0Q6IDE5MCwKCQkJUklHSFQ6IDM5LAoJCQlTSElGVDogMTYsCgkJCVNQQUNFOiAzMiwKCQkJVEFCOiA5LAoJCQlVUDogMzgsCgkJCVdJTkRPV1M6IDkxIC8vIENPTU1BTkQKCQl9LAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgeXBvcyApOwoJCQkJJC5tb2JpbGUuZG9jdW1lbnQudHJpZ2dlciggInNpbGVudHNjcm9sbCIsIHsgeDogMCwgeTogeXBvcyB9KTsKCQkJfSwgMjAgKTsKCgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQl9LCAxNTAgKTsKCQl9LAoKCQkvLyBFeHBvc2Ugb3VyIGNhY2hlIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgoJCW5zTm9ybWFsaXplRGljdDogbnNOb3JtYWxpemVEaWN0LAoKCQkvLyBUYWtlIGEgZGF0YSBhdHRyaWJ1dGUgcHJvcGVydHksIHByZXBlbmQgdGhlIG5hbWVzcGFjZQoJCS8vIGFuZCB0aGVuIGNhbWVsIGNhc2UgdGhlIGF0dHJpYnV0ZSBzdHJpbmcuIEFkZCB0aGUgcmVzdWx0CgkJLy8gdG8gb3VyIG5zTm9ybWFsaXplRGljdCBzbyB3ZSBkb24ndCBoYXZlIHRvIGRvIHRoaXMgYWdhaW4uCgkJbnNOb3JtYWxpemU6IGZ1bmN0aW9uKCBwcm9wICkgewoJCQlpZiAoICFwcm9wICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gbnNOb3JtYWxpemVEaWN0WyBwcm9wIF0gfHwgKCBuc05vcm1hbGl6ZURpY3RbIHByb3AgXSA9ICQuY2FtZWxDYXNlKCAkLm1vYmlsZS5ucyArIHByb3AgKSApOwoJCX0sCgoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFyZW50IHdpdGggYSB0aGVtZSBjbGFzcyBvbiBpdC4gTm90ZSB0aGF0CgkJLy8gd2UgYXJlIG5vdCB1c2luZyAkLmZuLmNsb3Nlc3QoKSBvbiBwdXJwb3NlIGhlcmUgYmVjYXVzZSB0aGlzCgkJLy8gbWV0aG9kIGdldHMgY2FsbGVkIHF1aXRlIGEgYml0IGFuZCB3ZSBuZWVkIGl0IHRvIGJlIGFzIGZhc3QKCQkvLyBhcyBwb3NzaWJsZS4KCQlnZXRJbmhlcml0ZWRUaGVtZTogZnVuY3Rpb24oIGVsLCBkZWZhdWx0VGhlbWUgKSB7CgkJCXZhciBlID0gZWxbIDAgXSwKCQkJCWx0ciA9ICIiLAoJCQkJcmUgPSAvdWktKGJhcnxib2R5fG92ZXJsYXkpLShbYS16XSlcYi8sCgkJCQljLCBtOwoKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgoJCQkvLyBSZXR1cm4gdGhlIHRoZW1lIGxldHRlciB3ZSBmb3VuZCwgaWYgbm9uZSwgcmV0dXJuIHRoZQoJCQkvLyBzcGVjaWZpZWQgZGVmYXVsdC4KCgkJCXJldHVybiBsdHIgfHwgZGVmYXVsdFRoZW1lIHx8ICJhIjsKCQl9LAoKCQkvLyBUT0RPIHRoZSBmb2xsb3dpbmcgJCBhbmQgJC5mbiBleHRlbnNpb25zIGNhbi9wcm9iYWJseSBzaG91bGQgYmUgbW92ZWQgaW50byBqcXVlcnkubW9iaWxlLmNvcmUuaGVscGVycwoJCS8vCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggJzpqcW1EYXRhKHJvbGU9InBhZ2UiKSwgOmpxbURhdGEocm9sZT0iZGlhbG9nIiknICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCAkc2V0ICkgewoJCQlyZXR1cm4gdGhpcy5oYXZlUGFyZW50cyggJHNldCwgImVuaGFuY2UiICk7CgkJfSwKCgkJaGlqYWNrYWJsZTogZnVuY3Rpb24oICRzZXQgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCAkc2V0LCAiYWpheCIgKTsKCQl9LAoKCQloYXZlUGFyZW50czogZnVuY3Rpb24oICRzZXQsIGF0dHIgKSB7CgkJCWlmICggISQubW9iaWxlLmlnbm9yZUNvbnRlbnRFbmFibGVkICkgewoJCQkJcmV0dXJuICRzZXQ7CgkJCX0KCgkJCXZhciBjb3VudCA9ICRzZXQubGVuZ3RoLAoJCQkJJG5ld1NldCA9ICQoKSwKCQkJCWUsICRlbGVtZW50LCBleGNsdWRlZDsKCgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvdW50OyBpKysgKSB7CgkJCQkkZWxlbWVudCA9ICRzZXQuZXEoIGkgKTsKCQkJCWV4Y2x1ZGVkID0gZmFsc2U7CgkJCQllID0gJHNldFsgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQl2YXIgYyA9IGUuZ2V0QXR0cmlidXRlID8gZS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArIGF0dHIgKSA6ICIiOwoKCQkJCQlpZiAoIGMgPT09ICJmYWxzZSIgKSB7CgkJCQkJCWV4Y2x1ZGVkID0gdHJ1ZTsKCQkJCQkJYnJlYWs7CgkJCQkJfQoKCQkJCQllID0gZS5wYXJlbnROb2RlOwoJCQkJfQoKCQkJCWlmICggIWV4Y2x1ZGVkICkgewoJCQkJCSRuZXdTZXQgPSAkbmV3U2V0LmFkZCggJGVsZW1lbnQgKTsKCQkJCX0KCQkJfQoKCQkJcmV0dXJuICRuZXdTZXQ7CgkJfSwKCgkJZ2V0U2NyZWVuSGVpZ2h0OiBmdW5jdGlvbigpIHsKCQkJLy8gTmF0aXZlIGlubmVySGVpZ2h0IHJldHVybnMgbW9yZSBhY2N1cmF0ZSB2YWx1ZSBmb3IgdGhpcyBhY3Jvc3MgcGxhdGZvcm1zLAoJCQkvLyBqUXVlcnkgdmVyc2lvbiBpcyBoZXJlIGFzIGEgbm9ybWFsaXplZCBmYWxsYmFjayBmb3IgcGxhdGZvcm1zIGxpa2UgU3ltYmlhbgoJCQlyZXR1cm4gd2luZG93LmlubmVySGVpZ2h0IHx8ICQubW9iaWxlLndpbmRvdy5oZWlnaHQoKTsKCQl9Cgl9LCAkLm1vYmlsZSApOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYoIGFyZ3VtZW50cy5sZW5ndGggPCAyIHx8IHZhbHVlID09PSB1bmRlZmluZWQgKXsKCQkJCXJlc3VsdCA9IHRoaXMuZGF0YSggcHJvcCApOwoJCQl9IGVsc2UgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wLCB2YWx1ZSApOwoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9OwoKCSQuanFtRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlyZXN1bHQgPSAkLmRhdGEoIGVsZW0sIHByb3AgPyAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApIDogcHJvcCwgdmFsdWUgKTsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5mbi5qcW1SZW1vdmVEYXRhID0gZnVuY3Rpb24oIHByb3AgKSB7CgkJcmV0dXJuIHRoaXMucmVtb3ZlRGF0YSggJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKSApOwoJfTsKCgkkLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggZWxlbSwgcHJvcCApIHsKCQlyZXR1cm4gJC5yZW1vdmVEYXRhKCBlbGVtLCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuZm4ucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbigpIHsKCQkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCB0aGlzICk7Cgl9OwoKCSQucmVtb3ZlV2l0aERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICk7CgoJCSggJGVsZW0uanFtRGF0YSggJ2RlcGVuZGVudHMnICkgfHwgJCgpICkucmVtb3ZlKCk7CgkJJGVsZW0ucmVtb3ZlKCk7Cgl9OwoKCSQuZm4uYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuZXdEZXBlbmRlbnRzICkgewoJCSQuYWRkRGVwZW5kZW50cyggJCggdGhpcyApLCBuZXdEZXBlbmRlbnRzICk7Cgl9OwoKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBlbGVtLCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBkZXBlbmRlbnRzID0gJCggZWxlbSApLmpxbURhdGEoICdkZXBlbmRlbnRzJyApIHx8ICQoKTsKCgkJJCggZWxlbSApLmpxbURhdGEoICdkZXBlbmRlbnRzJywgJC5tZXJnZSggZGVwZW5kZW50cywgbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJLy8gb3Igc2V0dGluZyBvZiBhbiBodG1sIGVsZW1lbnQncyB0ZXh0LCBpdHMgb25seSBwdXJwb3NlIGlzCgkvLyB0byByZXR1cm4gdGhlIGh0bWwgZW5jb2RlZCB2ZXJzaW9uIG9mIHRoZSB0ZXh0IGluIGFsbCBjYXNlcy4gKHRodXMgdGhlIG5hbWUpCgkkLmZuLmdldEVuY29kZWRUZXh0ID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2Lz4iICkudGV4dCggJCggdGhpcyApLnRleHQoKSApLmh0bWwoKTsKCX07CgoJLy8gZmx1ZW50IGhlbHBlciBmdW5jdGlvbiBmb3IgdGhlIG1vYmlsZSBuYW1lc3BhY2VkIGVxdWl2YWxlbnQKCSQuZm4uanFtRW5oYW5jZWFibGUgPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCX07CgoJJC5mbi5qcW1IaWphY2thYmxlID0gZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCX07CgoJLy8gTW9ua2V5LXBhdGNoaW5nIFNpenpsZSB0byBmaWx0ZXIgdGhlIDpqcW1EYXRhIHNlbGVjdG9yCgl2YXIgb2xkRmluZCA9ICQuZmluZCwKCQlqcW1EYXRhUkUgPSAvOmpxbURhdGFcKChbXildKilcKS9nOwoKCSQuZmluZCA9IGZ1bmN0aW9uKCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApIHsKCQlzZWxlY3RvciA9IHNlbGVjdG9yLnJlcGxhY2UoIGpxbURhdGFSRSwgIltkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAiJDFdIiApOwoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKfSkoIGpRdWVyeSwgdGhpcyApOwoKCi8qIQogKiBqUXVlcnkgVUkgV2lkZ2V0IHYxLjEwLjBwcmUgLSAyMDEyLTExLTEzIChmZjA1NWEwYzM1M2MzYzhjZTZlNWJmYTA3YWQ3Y2IwM2U4ODg1YmM1KQogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEwLCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQluYW1lc3BhY2UgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMCBdOwoKCW5hbWUgPSBuYW1lLnNwbGl0KCAiLiIgKVsgMSBdOwoJZnVsbE5hbWUgPSBuYW1lc3BhY2UgKyAiLSIgKyBuYW1lOwoKCWlmICggIXByb3RvdHlwZSApIHsKCQlwcm90b3R5cGUgPSBiYXNlOwoJCWJhc2UgPSAkLldpZGdldDsKCX0KCgkvLyBjcmVhdGUgc2VsZWN0b3IgZm9yIHBsdWdpbgoJJC5leHByWyAiOiIgXVsgZnVsbE5hbWUudG9Mb3dlckNhc2UoKSBdID0gZnVuY3Rpb24oIGVsZW0gKSB7CgkJcmV0dXJuICEhJC5kYXRhKCBlbGVtLCBmdWxsTmFtZSApOwoJfTsKCgkkWyBuYW1lc3BhY2UgXSA9ICRbIG5hbWVzcGFjZSBdIHx8IHt9OwoJZXhpc3RpbmdDb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF07Cgljb25zdHJ1Y3RvciA9ICRbIG5hbWVzcGFjZSBdWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQkvLyBhbGxvdyBpbnN0YW50aWF0aW9uIHdpdGhvdXQgIm5ldyIga2V5d29yZAoJCWlmICggIXRoaXMuX2NyZWF0ZVdpZGdldCApIHsKCQkJcmV0dXJuIG5ldyBjb25zdHJ1Y3Rvciggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0IGluaXRpYWxpemluZyBmb3Igc2ltcGxlIGluaGVyaXRhbmNlCgkJLy8gbXVzdCB1c2UgIm5ldyIga2V5d29yZCAodGhlIGNvZGUgYWJvdmUgYWx3YXlzIHBhc3NlcyBhcmdzKQoJCWlmICggYXJndW1lbnRzLmxlbmd0aCApIHsKCQkJdGhpcy5fY3JlYXRlV2lkZ2V0KCBvcHRpb25zLCBlbGVtZW50ICk7CgkJfQoJfTsKCS8vIGV4dGVuZCB3aXRoIHRoZSBleGlzdGluZyBjb25zdHJ1Y3RvciB0byBjYXJyeSBvdmVyIGFueSBzdGF0aWMgcHJvcGVydGllcwoJJC5leHRlbmQoIGNvbnN0cnVjdG9yLCBleGlzdGluZ0NvbnN0cnVjdG9yLCB7CgkJdmVyc2lvbjogcHJvdG90eXBlLnZlcnNpb24sCgkJLy8gY29weSB0aGUgb2JqZWN0IHVzZWQgdG8gY3JlYXRlIHRoZSBwcm90b3R5cGUgaW4gY2FzZSB3ZSBuZWVkIHRvCgkJLy8gcmVkZWZpbmUgdGhlIHdpZGdldCBsYXRlcgoJCV9wcm90bzogJC5leHRlbmQoIHt9LCBwcm90b3R5cGUgKSwKCQkvLyB0cmFjayB3aWRnZXRzIHRoYXQgaW5oZXJpdCBmcm9tIHRoaXMgd2lkZ2V0IGluIGNhc2UgdGhpcyB3aWRnZXQgaXMKCQkvLyByZWRlZmluZWQgYWZ0ZXIgYSB3aWRnZXQgaW5oZXJpdHMgZnJvbSBpdAoJCV9jaGlsZENvbnN0cnVjdG9yczogW10KCX0pOwoKCWJhc2VQcm90b3R5cGUgPSBuZXcgYmFzZSgpOwoJLy8gd2UgbmVlZCB0byBtYWtlIHRoZSBvcHRpb25zIGhhc2ggYSBwcm9wZXJ0eSBkaXJlY3RseSBvbiB0aGUgbmV3IGluc3RhbmNlCgkvLyBvdGhlcndpc2Ugd2UnbGwgbW9kaWZ5IHRoZSBvcHRpb25zIGhhc2ggb24gdGhlIHByb3RvdHlwZSB0aGF0IHdlJ3JlCgkvLyBpbmhlcml0aW5nIGZyb20KCWJhc2VQcm90b3R5cGUub3B0aW9ucyA9ICQud2lkZ2V0LmV4dGVuZCgge30sIGJhc2VQcm90b3R5cGUub3B0aW9ucyApOwoJJC5lYWNoKCBwcm90b3R5cGUsIGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQlpZiAoICQuaXNGdW5jdGlvbiggdmFsdWUgKSApIHsKCQkJcHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCQl2YXIgX3N1cGVyID0gZnVuY3Rpb24oKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJCQl9LAoJCQkJCV9zdXBlckFwcGx5ID0gZnVuY3Rpb24oIGFyZ3MgKSB7CgkJCQkJCXJldHVybiBiYXNlLnByb3RvdHlwZVsgcHJvcCBdLmFwcGx5KCB0aGlzLCBhcmdzICk7CgkJCQkJfTsKCQkJCXJldHVybiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgX19zdXBlciA9IHRoaXMuX3N1cGVyLAoJCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCQlyZXR1cm5WYWx1ZTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfc3VwZXI7CgkJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCQlyZXR1cm5WYWx1ZSA9IHZhbHVlLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCgkJCQkJdGhpcy5fc3VwZXIgPSBfX3N1cGVyOwoJCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQkJCX07CgkJCX0pKCk7CgkJfQoJfSk7Cgljb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSAkLndpZGdldC5leHRlbmQoIGJhc2VQcm90b3R5cGUsIHsKCQkvLyBUT0RPOiByZW1vdmUgc3VwcG9ydCBmb3Igd2lkZ2V0RXZlbnRQcmVmaXgKCQkvLyBhbHdheXMgdXNlIHRoZSBuYW1lICsgYSBjb2xvbiBhcyB0aGUgcHJlZml4LCBlLmcuLCBkcmFnZ2FibGU6c3RhcnQKCQkvLyBkb24ndCBwcmVmaXggZm9yIHdpZGdldHMgdGhhdCBhcmVuJ3QgRE9NLWJhc2VkCgkJd2lkZ2V0RXZlbnRQcmVmaXg6IGV4aXN0aW5nQ29uc3RydWN0b3IgPyBiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IDogbmFtZQoJfSwgcHJvdG90eXBlLCB7CgkJY29uc3RydWN0b3I6IGNvbnN0cnVjdG9yLAoJCW5hbWVzcGFjZTogbmFtZXNwYWNlLAoJCXdpZGdldE5hbWU6IG5hbWUsCgkJd2lkZ2V0RnVsbE5hbWU6IGZ1bGxOYW1lCgl9KTsKCgkvLyBJZiB0aGlzIHdpZGdldCBpcyBiZWluZyByZWRlZmluZWQgdGhlbiB3ZSBuZWVkIHRvIGZpbmQgYWxsIHdpZGdldHMgdGhhdAoJLy8gYXJlIGluaGVyaXRpbmcgZnJvbSBpdCBhbmQgcmVkZWZpbmUgYWxsIG9mIHRoZW0gc28gdGhhdCB0aGV5IGluaGVyaXQgZnJvbQoJLy8gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoaXMgd2lkZ2V0LiBXZSdyZSBlc3NlbnRpYWxseSB0cnlpbmcgdG8gcmVwbGFjZSBvbmUKCS8vIGxldmVsIGluIHRoZSBwcm90b3R5cGUgY2hhaW4uCglpZiAoIGV4aXN0aW5nQ29uc3RydWN0b3IgKSB7CgkJJC5lYWNoKCBleGlzdGluZ0NvbnN0cnVjdG9yLl9jaGlsZENvbnN0cnVjdG9ycywgZnVuY3Rpb24oIGksIGNoaWxkICkgewoJCQl2YXIgY2hpbGRQcm90b3R5cGUgPSBjaGlsZC5wcm90b3R5cGU7CgoJCQkvLyByZWRlZmluZSB0aGUgY2hpbGQgd2lkZ2V0IHVzaW5nIHRoZSBzYW1lIHByb3RvdHlwZSB0aGF0IHdhcwoJCQkvLyBvcmlnaW5hbGx5IHVzZWQsIGJ1dCBpbmhlcml0IGZyb20gdGhlIG5ldyB2ZXJzaW9uIG9mIHRoZSBiYXNlCgkJCSQud2lkZ2V0KCBjaGlsZFByb3RvdHlwZS5uYW1lc3BhY2UgKyAiLiIgKyBjaGlsZFByb3RvdHlwZS53aWRnZXROYW1lLCBjb25zdHJ1Y3RvciwgY2hpbGQuX3Byb3RvICk7CgkJfSk7CgkJLy8gcmVtb3ZlIHRoZSBsaXN0IG9mIGV4aXN0aW5nIGNoaWxkIGNvbnN0cnVjdG9ycyBmcm9tIHRoZSBvbGQgY29uc3RydWN0b3IKCQkvLyBzbyB0aGUgb2xkIGNoaWxkIGNvbnN0cnVjdG9ycyBjYW4gYmUgZ2FyYmFnZSBjb2xsZWN0ZWQKCQlkZWxldGUgZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnM7Cgl9IGVsc2UgewoJCWJhc2UuX2NoaWxkQ29uc3RydWN0b3JzLnB1c2goIGNvbnN0cnVjdG9yICk7Cgl9CgoJJC53aWRnZXQuYnJpZGdlKCBuYW1lLCBjb25zdHJ1Y3RvciApOwp9OwoKJC53aWRnZXQuZXh0ZW5kID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCXZhciBpbnB1dCA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCWlucHV0SW5kZXggPSAwLAoJCWlucHV0TGVuZ3RoID0gaW5wdXQubGVuZ3RoLAoJCWtleSwKCQl2YWx1ZTsKCWZvciAoIDsgaW5wdXRJbmRleCA8IGlucHV0TGVuZ3RoOyBpbnB1dEluZGV4KysgKSB7CgkJZm9yICgga2V5IGluIGlucHV0WyBpbnB1dEluZGV4IF0gKSB7CgkJCXZhbHVlID0gaW5wdXRbIGlucHV0SW5kZXggXVsga2V5IF07CgkJCWlmICggaW5wdXRbIGlucHV0SW5kZXggXS5oYXNPd25Qcm9wZXJ0eSgga2V5ICkgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCS8vIENsb25lIG9iamVjdHMKCQkJCWlmICggJC5pc1BsYWluT2JqZWN0KCB2YWx1ZSApICkgewoJCQkJCXRhcmdldFsga2V5IF0gPSAkLmlzUGxhaW5PYmplY3QoIHRhcmdldFsga2V5IF0gKSA/CgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHRhcmdldFsga2V5IF0sIHZhbHVlICkgOgoJCQkJCQkvLyBEb24ndCBleHRlbmQgc3RyaW5ncywgYXJyYXlzLCBldGMuIHdpdGggb2JqZWN0cwoJCQkJCQkkLndpZGdldC5leHRlbmQoIHt9LCB2YWx1ZSApOwoJCQkJLy8gQ29weSBldmVyeXRoaW5nIGVsc2UgYnkgcmVmZXJlbmNlCgkJCQl9IGVsc2UgewoJCQkJCXRhcmdldFsga2V5IF0gPSB2YWx1ZTsKCQkJCX0KCQkJfQoJCX0KCX0KCXJldHVybiB0YXJnZXQ7Cn07CgokLndpZGdldC5icmlkZ2UgPSBmdW5jdGlvbiggbmFtZSwgb2JqZWN0ICkgewoJdmFyIGZ1bGxOYW1lID0gb2JqZWN0LnByb3RvdHlwZS53aWRnZXRGdWxsTmFtZSB8fCBuYW1lOwoJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGlzTWV0aG9kQ2FsbCA9IHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiwKCQkJYXJncyA9IHNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMSApLAoJCQlyZXR1cm5WYWx1ZSA9IHRoaXM7CgoJCS8vIGFsbG93IG11bHRpcGxlIGhhc2hlcyB0byBiZSBwYXNzZWQgb24gaW5pdAoJCW9wdGlvbnMgPSAhaXNNZXRob2RDYWxsICYmIGFyZ3MubGVuZ3RoID8KCQkJJC53aWRnZXQuZXh0ZW5kLmFwcGx5KCBudWxsLCBbIG9wdGlvbnMgXS5jb25jYXQoYXJncykgKSA6CgkJCW9wdGlvbnM7CgoJCWlmICggaXNNZXRob2RDYWxsICkgewoJCQl0aGlzLmVhY2goZnVuY3Rpb24oKSB7CgkJCQl2YXIgbWV0aG9kVmFsdWUsCgkJCQkJaW5zdGFuY2UgPSAkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lICk7CgkJCQlpZiAoICFpbnN0YW5jZSApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggImNhbm5vdCBjYWxsIG1ldGhvZHMgb24gIiArIG5hbWUgKyAiIHByaW9yIHRvIGluaXRpYWxpemF0aW9uOyAiICsKCQkJCQkJImF0dGVtcHRlZCB0byBjYWxsIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyIgKTsKCQkJCX0KCQkJCWlmICggISQuaXNGdW5jdGlvbiggaW5zdGFuY2Vbb3B0aW9uc10gKSB8fCBvcHRpb25zLmNoYXJBdCggMCApID09PSAiXyIgKSB7CgkJCQkJcmV0dXJuICQuZXJyb3IoICJubyBzdWNoIG1ldGhvZCAnIiArIG9wdGlvbnMgKyAiJyBmb3IgIiArIG5hbWUgKyAiIHdpZGdldCBpbnN0YW5jZSIgKTsKCQkJCX0KCQkJCW1ldGhvZFZhbHVlID0gaW5zdGFuY2VbIG9wdGlvbnMgXS5hcHBseSggaW5zdGFuY2UsIGFyZ3MgKTsKCQkJCWlmICggbWV0aG9kVmFsdWUgIT09IGluc3RhbmNlICYmIG1ldGhvZFZhbHVlICE9PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuVmFsdWUgPSBtZXRob2RWYWx1ZSAmJiBtZXRob2RWYWx1ZS5qcXVlcnkgPwoJCQkJCQlyZXR1cm5WYWx1ZS5wdXNoU3RhY2soIG1ldGhvZFZhbHVlLmdldCgpICkgOgoJCQkJCQltZXRob2RWYWx1ZTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0pOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggaW5zdGFuY2UgKSB7CgkJCQkJaW5zdGFuY2Uub3B0aW9uKCBvcHRpb25zIHx8IHt9ICkuX2luaXQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSwgbmV3IG9iamVjdCggb3B0aW9ucywgdGhpcyApICk7CgkJCQl9CgkJCX0pOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfTsKfTsKCiQuV2lkZ2V0ID0gZnVuY3Rpb24oIC8qIG9wdGlvbnMsIGVsZW1lbnQgKi8gKSB7fTsKJC5XaWRnZXQuX2NoaWxkQ29uc3RydWN0b3JzID0gW107CgokLldpZGdldC5wcm90b3R5cGUgPSB7Cgl3aWRnZXROYW1lOiAid2lkZ2V0IiwKCXdpZGdldEV2ZW50UHJlZml4OiAiIiwKCWRlZmF1bHRFbGVtZW50OiAiPGRpdj4iLAoJb3B0aW9uczogewoJCWRpc2FibGVkOiBmYWxzZSwKCgkJLy8gY2FsbGJhY2tzCgkJY3JlYXRlOiBudWxsCgl9LAoJX2NyZWF0ZVdpZGdldDogZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJZWxlbWVudCA9ICQoIGVsZW1lbnQgfHwgdGhpcy5kZWZhdWx0RWxlbWVudCB8fCB0aGlzIClbIDAgXTsKCQl0aGlzLmVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJdGhpcy51dWlkID0gdXVpZCsrOwoJCXRoaXMuZXZlbnROYW1lc3BhY2UgPSAiLiIgKyB0aGlzLndpZGdldE5hbWUgKyB0aGlzLnV1aWQ7CgkJdGhpcy5vcHRpb25zID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwKCQkJdGhpcy5vcHRpb25zLAoJCQl0aGlzLl9nZXRDcmVhdGVPcHRpb25zKCksCgkJCW9wdGlvbnMgKTsKCgkJdGhpcy5iaW5kaW5ncyA9ICQoKTsKCQl0aGlzLmhvdmVyYWJsZSA9ICQoKTsKCQl0aGlzLmZvY3VzYWJsZSA9ICQoKTsKCgkJaWYgKCBlbGVtZW50ICE9PSB0aGlzICkgewoJCQkkLmRhdGEoIGVsZW1lbnQsIHRoaXMud2lkZ2V0RnVsbE5hbWUsIHRoaXMgKTsKCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZWxlbWVudCwgewoJCQkJcmVtb3ZlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkJaWYgKCBldmVudC50YXJnZXQgPT09IGVsZW1lbnQgKSB7CgkJCQkJCXRoaXMuZGVzdHJveSgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJCXRoaXMuZG9jdW1lbnQgPSAkKCBlbGVtZW50LnN0eWxlID8KCQkJCS8vIGVsZW1lbnQgd2l0aGluIHRoZSBkb2N1bWVudAoJCQkJZWxlbWVudC5vd25lckRvY3VtZW50IDoKCQkJCS8vIGVsZW1lbnQgaXMgd2luZG93IG9yIGRvY3VtZW50CgkJCQllbGVtZW50LmRvY3VtZW50IHx8IGVsZW1lbnQgKTsKCQkJdGhpcy53aW5kb3cgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmRlZmF1bHRWaWV3IHx8IHRoaXMuZG9jdW1lbnRbMF0ucGFyZW50V2luZG93ICk7CgkJfQoKCQl0aGlzLl9jcmVhdGUoKTsKCQl0aGlzLl90cmlnZ2VyKCAiY3JlYXRlIiwgbnVsbCwgdGhpcy5fZ2V0Q3JlYXRlRXZlbnREYXRhKCkgKTsKCQl0aGlzLl9pbml0KCk7Cgl9LAoJX2dldENyZWF0ZU9wdGlvbnM6ICQubm9vcCwKCV9nZXRDcmVhdGVFdmVudERhdGE6ICQubm9vcCwKCV9jcmVhdGU6ICQubm9vcCwKCV9pbml0OiAkLm5vb3AsCgoJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZGVzdHJveSgpOwoJCS8vIHdlIGNhbiBwcm9iYWJseSByZW1vdmUgdGhlIHVuYmluZCBjYWxscyBpbiAyLjAKCQkvLyBhbGwgZXZlbnQgYmluZGluZ3Mgc2hvdWxkIGdvIHRocm91Z2ggdGhpcy5fb24oKQoJCXRoaXMuZWxlbWVudAoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLy8gMS45IEJDIGZvciAjNzgxMAoJCQkvLyBUT0RPIHJlbW92ZSBkdWFsIHN0b3JhZ2UKCQkJLnJlbW92ZURhdGEoIHRoaXMud2lkZ2V0TmFtZSApCgkJCS5yZW1vdmVEYXRhKCB0aGlzLndpZGdldEZ1bGxOYW1lICkKCQkJLy8gc3VwcG9ydDoganF1ZXJ5IDwxLjYuMwoJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzCgkJCS5yZW1vdmVEYXRhKCAkLmNhbWVsQ2FzZSggdGhpcy53aWRnZXRGdWxsTmFtZSApICk7CgkJdGhpcy53aWRnZXQoKQoJCQkudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICkKCQkJLnJlbW92ZUF0dHIoICJhcmlhLWRpc2FibGVkIiApCgkJCS5yZW1vdmVDbGFzcygKCQkJCXRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkICIgKwoJCQkJInVpLXN0YXRlLWRpc2FibGVkIiApOwoKCQkvLyBjbGVhbiB1cCBldmVudHMgYW5kIHN0YXRlcwoJCXRoaXMuYmluZGluZ3MudW5iaW5kKCB0aGlzLmV2ZW50TmFtZXNwYWNlICk7CgkJdGhpcy5ob3ZlcmFibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJfSwKCV9kZXN0cm95OiAkLm5vb3AsCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJfSwKCglvcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcHRpb25zID0ga2V5LAoJCQlwYXJ0cywKCQkJY3VyT3B0aW9uLAoJCQlpOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDAgKSB7CgkJCS8vIGRvbid0IHJldHVybiBhIHJlZmVyZW5jZSB0byB0aGUgaW50ZXJuYWwgaGFzaAoJCQlyZXR1cm4gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zICk7CgkJfQoKCQlpZiAoIHR5cGVvZiBrZXkgPT09ICJzdHJpbmciICkgewoJCQkvLyBoYW5kbGUgbmVzdGVkIGtleXMsIGUuZy4sICJmb28uYmFyIiA9PiB7IGZvbzogeyBiYXI6IF9fXyB9IH0KCQkJb3B0aW9ucyA9IHt9OwoJCQlwYXJ0cyA9IGtleS5zcGxpdCggIi4iICk7CgkJCWtleSA9IHBhcnRzLnNoaWZ0KCk7CgkJCWlmICggcGFydHMubGVuZ3RoICkgewoJCQkJY3VyT3B0aW9uID0gb3B0aW9uc1sga2V5IF0gPSAkLndpZGdldC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnNbIGtleSBdICk7CgkJCQlmb3IgKCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aCAtIDE7IGkrKyApIHsKCQkJCQljdXJPcHRpb25bIHBhcnRzWyBpIF0gXSA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdIHx8IHt9OwoJCQkJCWN1ck9wdGlvbiA9IGN1ck9wdGlvblsgcGFydHNbIGkgXSBdOwoJCQkJfQoJCQkJa2V5ID0gcGFydHMucG9wKCk7CgkJCQlpZiAoIHZhbHVlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0dXJuIGN1ck9wdGlvblsga2V5IF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBjdXJPcHRpb25bIGtleSBdOwoJCQkJfQoJCQkJY3VyT3B0aW9uWyBrZXkgXSA9IHZhbHVlOwoJCQl9IGVsc2UgewoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiB0aGlzLm9wdGlvbnNbIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogdGhpcy5vcHRpb25zWyBrZXkgXTsKCQkJCX0KCQkJCW9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgkJCX0KCQl9CgoJCXRoaXMuX3NldE9wdGlvbnMoIG9wdGlvbnMgKTsKCgkJcmV0dXJuIHRoaXM7Cgl9LAoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXk7CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoJCQl0aGlzLl9zZXRPcHRpb24oIGtleSwgb3B0aW9uc1sga2V5IF0gKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXRoaXMub3B0aW9uc1sga2V5IF0gPSB2YWx1ZTsKCgkJaWYgKCBrZXkgPT09ICJkaXNhYmxlZCIgKSB7CgkJCXRoaXMud2lkZ2V0KCkKCQkJCS50b2dnbGVDbGFzcyggdGhpcy53aWRnZXRGdWxsTmFtZSArICItZGlzYWJsZWQgdWktc3RhdGUtZGlzYWJsZWQiLCAhIXZhbHVlICkKCQkJCS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCXRoaXMuZm9jdXNhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZm9jdXMiICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW5hYmxlOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJfSwKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIHRydWUgKTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLndpZGdldCIsIHsKCS8vIGRlY29yYXRlIHRoZSBwYXJlbnQgX2NyZWF0ZVdpZGdldCB0byB0cmlnZ2VyIGB3aWRnZXRpbml0YCBmb3IgdXNlcnMKCS8vIHdobyB3aXNoIHRvIGRvIHBvc3QgcG9zdCBgd2lkZ2V0Y3JlYXRlYCBhbHRlcmF0aW9ucy9hZGRpdGlvbnMKCS8vCgkvLyBUT0RPIGNyZWF0ZSBhIHB1bGwgcmVxdWVzdCBmb3IganF1ZXJ5IHVpIHRvIHRyaWdnZXIgdGhpcyBldmVudAoJLy8gaW4gdGhlIG9yaWdpbmFsIF9jcmVhdGVXaWRnZXQKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAnaW5pdCcgKTsKCX0sCgoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0aW9ucyA9IHt9OwoKCQkkLmVhY2goIHRoaXMub3B0aW9ucywgZnVuY3Rpb24oIG9wdGlvbiApIHsKCgkJCXZhciB2YWx1ZSA9IGVsZW0uanFtRGF0YSggb3B0aW9uLnJlcGxhY2UoIC9bQS1aXS9nLCBmdW5jdGlvbiggYyApIHsKCQkJCQkJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7CgkJCQkJCX0pCgkJCQkJKTsKCgkJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCW9wdGlvbnNbIG9wdGlvbiBdID0gdmFsdWU7CgkJCX0KCQl9KTsKCgkJcmV0dXJuIG9wdGlvbnM7Cgl9LAoKCWVuaGFuY2VXaXRoaW46IGZ1bmN0aW9uKCB0YXJnZXQsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdGhpcy5lbmhhbmNlKCAkKCB0aGlzLm9wdGlvbnMuaW5pdFNlbGVjdG9yLCAkKCB0YXJnZXQgKSksIHVzZUtlZXBOYXRpdmUgKTsKCX0sCgoJZW5oYW5jZTogZnVuY3Rpb24oIHRhcmdldHMsIHVzZUtlZXBOYXRpdmUgKSB7CgkJdmFyIHBhZ2UsIGtlZXBOYXRpdmUsICR3aWRnZXRFbGVtZW50cyA9ICQoIHRhcmdldHMgKSwgc2VsZiA9IHRoaXM7CgoJCS8vIGlmIGlnbm9yZUNvbnRlbnRFbmFibGVkIGlzIHNldCB0byB0cnVlIHRoZSBmcmFtZXdvcmsgc2hvdWxkCgkJLy8gb25seSBlbmhhbmNlIHRoZSBzZWxlY3RlZCBlbGVtZW50cyB3aGVuIHRoZXkgZG8gTk9UIGhhdmUgYQoJCS8vIHBhcmVudCB3aXRoIHRoZSBkYXRhLW5hbWVzcGFjZS1pZ25vcmUgYXR0cmlidXRlCgkJJHdpZGdldEVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoICR3aWRnZXRFbGVtZW50cyApOwoKCQlpZiAoIHVzZUtlZXBOYXRpdmUgJiYgJHdpZGdldEVsZW1lbnRzLmxlbmd0aCApIHsKCQkJLy8gVE9ETyByZW1vdmUgZGVwZW5kZW5jeSBvbiB0aGUgcGFnZSB3aWRnZXQgZm9yIHRoZSBrZWVwTmF0aXZlLgoJCQkvLyBDdXJyZW50bHkgdGhlIGtlZXBOYXRpdmUgdmFsdWUgaXMgZGVmaW5lZCBvbiB0aGUgcGFnZSBwcm90b3R5cGUgc28KCQkJLy8gdGhlIG1ldGhvZCBpcyBhcyB3ZWxsCgkJCXBhZ2UgPSAkLm1vYmlsZS5jbG9zZXN0UGFnZURhdGEoICR3aWRnZXRFbGVtZW50cyApOwoJCQlrZWVwTmF0aXZlID0gKCBwYWdlICYmIHBhZ2Uua2VlcE5hdGl2ZVNlbGVjdG9yKCkpIHx8ICIiOwoKCQkJJHdpZGdldEVsZW1lbnRzID0gJHdpZGdldEVsZW1lbnRzLm5vdCgga2VlcE5hdGl2ZSApOwoJCX0KCgkJJHdpZGdldEVsZW1lbnRzWyB0aGlzLndpZGdldE5hbWUgXSgpOwoJfSwKCglyYWlzZTogZnVuY3Rpb24oIG1zZyApIHsKCQl0aHJvdyAiV2lkZ2V0IFsiICsgdGhpcy53aWRnZXROYW1lICsgIl06ICIgKyBtc2c7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJLy8gREVQUkVDQVRFRAoJLy8gTk9URSBnbG9iYWwgbW9iaWxlIG9iamVjdCBzZXR0aW5ncwoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gREVQUkVDQVRFRCBTaG91bGQgdGhlIHRleHQgYmUgdmlzYmxlIGluIHRoZSBsb2FkaW5nIG1lc3NhZ2U/CgkJbG9hZGluZ01lc3NhZ2VUZXh0VmlzaWJsZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIFdoZW4gdGhlIHRleHQgaXMgdmlzaWJsZSwgd2hhdCB0aGVtZSBkb2VzIHRoZSBsb2FkaW5nIGJveCB1c2U/CgkJbG9hZGluZ01lc3NhZ2VUaGVtZTogdW5kZWZpbmVkLAoKCQkvLyBERVBSRUNBVEVEIGRlZmF1bHQgbWVzc2FnZSBzZXR0aW5nCgkJbG9hZGluZ01lc3NhZ2U6IHVuZGVmaW5lZCwKCgkJLy8gREVQUkVDQVRFRAoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQlzaG93UGFnZUxvYWRpbmdNc2c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdzaG93JywgdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICk7CgkJfSwKCgkJLy8gREVQUkVDQVRFRAoJCWhpZGVQYWdlTG9hZGluZ01zZzogZnVuY3Rpb24oKSB7CgkJCSQubW9iaWxlLmxvYWRpbmcoICdoaWRlJyApOwoJCX0sCgoJCWxvYWRpbmc6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmxvYWRlcldpZGdldC5sb2FkZXIuYXBwbHkoIHRoaXMubG9hZGVyV2lkZ2V0LCBhcmd1bWVudHMgKTsKCQl9Cgl9KTsKCgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKSwgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbiB1aS1pY29uLWxvYWRpbmcnPjwvc3Bhbj4iICsKCQkJIjxoMT48L2gxPiIgKwoJCQkiPC9kaXY+IiwKCgkJLy8gRm9yIG5vbi1maXhlZCBzdXBwb3J0aW4gYnJvd3NlcnMuIFBvc2l0aW9uIGF0IHkgY2VudGVyIChpZiBzY3JvbGxUb3Agc3VwcG9ydGVkKSwgYWJvdmUgdGhlIGFjdGl2ZUJ0biAoaWYgZGVmaW5lZCksIG9yIGp1c3QgMTAwcHggZnJvbSB0b3AKCQlmYWtlRml4TG9hZGVyOiBmdW5jdGlvbigpIHsKCQkJdmFyIGFjdGl2ZUJ0biA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZmlyc3QoKTsKCgkJCXRoaXMuZWxlbWVudAoJCQkJLmNzcyh7CgkJCQkJdG9wOiAkLnN1cHBvcnQuc2Nyb2xsVG9wICYmICR3aW5kb3cuc2Nyb2xsVG9wKCkgKyAkd2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQlzY3JlZW5IZWlnaHQgPSAkLm1vYmlsZS5nZXRTY3JlZW5IZWlnaHQoKTsKCgkJCWlmICggb2Zmc2V0LnRvcCA8IHNjcm9sbFRvcCB8fCAoIG9mZnNldC50b3AgLSBzY3JvbGxUb3AgKSA+IHNjcmVlbkhlaWdodCApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQkJdGhpcy5mYWtlRml4TG9hZGVyKCk7CgkJCQkkd2luZG93CgkJCQkJLnVuYmluZCggInNjcm9sbCIsIHRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbiApCgkJCQkJLmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmZha2VGaXhMb2FkZXIsIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJcmVzZXRIdG1sOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50Lmh0bWwoICQoIHRoaXMuZGVmYXVsdEh0bWwgKS5odG1sKCkgKTsKCQl9LAoKCQkvLyBUdXJuIG9uL29mZiBwYWdlIGxvYWRpbmcgbWVzc2FnZS4gVGhlbWUgZG91YmxlcyBhcyBhbiBvYmplY3QgYXJndW1lbnQKCQkvLyB3aXRoIHRoZSBmb2xsb3dpbmcgc2hhcGU6IHsgdGhlbWU6ICcnLCB0ZXh0OiAnJywgaHRtbDogJycsIHRleHRWaXNpYmxlOiAnJyB9CgkJLy8gTk9URSB0aGF0IHRoZSAkLm1vYmlsZS5sb2FkaW5nKiBzZXR0aW5ncyBhbmQgcGFyYW1zIHBhc3QgdGhlIGZpcnN0IGFyZSBkZXByZWNhdGVkCgkJLy8gVE9ETyBzd2VldCBqZXN1cyB3ZSBuZWVkIHRvIGJyZWFrIHNvbWUgb2YgdGhpcyBvdXQKCQlzaG93OiBmdW5jdGlvbiggdGhlbWUsIG1zZ1RleHQsIHRleHRvbmx5ICkgewoJCQl2YXIgdGV4dFZpc2libGUsIG1lc3NhZ2UsICRoZWFkZXIsIGxvYWRTZXR0aW5nczsKCgkJCXRoaXMucmVzZXRIdG1sKCk7CgoJCQkvLyB1c2UgdGhlIHByb3RvdHlwZSBvcHRpb25zIHNvIHRoYXQgcGVvcGxlIGNhbiBzZXQgdGhlbSBnbG9iYWxseSBhdAoJCQkvLyBtb2JpbGUgaW5pdC4gQ29uc2lzdGVuY3ksIGl0J3Mgd2hhdCdzIGZvciBkaW5uZXIKCQkJaWYgKCAkLnR5cGUodGhlbWUpID09PSAib2JqZWN0IiApIHsKCQkJCWxvYWRTZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zLCB0aGVtZSApOwoKCQkJCS8vIHByZWZlciBvYmplY3QgcHJvcGVydHkgZnJvbSB0aGUgcGFyYW0gdGhlbiB0aGUgb2xkIHRoZW1lIHNldHRpbmcKCQkJCXRoZW1lID0gbG9hZFNldHRpbmdzLnRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWU7CgkJCX0gZWxzZSB7CgkJCQlsb2FkU2V0dGluZ3MgPSB0aGlzLm9wdGlvbnM7CgoJCQkJLy8gaGVyZSB3ZSBwcmVmZXIgdGhlIHRoZW0gdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGhlbWUgfHwgbG9hZFNldHRpbmdzLnRoZW1lOwoJCQl9CgoJCQkvLyBzZXQgdGhlIG1lc3NhZ2UgdGV4dCwgcHJlZmVyIHRoZSBwYXJhbSwgdGhlbiB0aGUgc2V0dGluZ3Mgb2JqZWN0CgkJCS8vIHRoZW4gbG9hZGluZyBtZXNzYWdlCgkJCW1lc3NhZ2UgPSBtc2dUZXh0IHx8ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlIHx8IGxvYWRTZXR0aW5ncy50ZXh0OwoKCQkJLy8gcHJlcGFyZSB0aGUgZG9tCgkJCSRodG1sLmFkZENsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgIT09IGZhbHNlIHx8IGxvYWRTZXR0aW5ncy5odG1sICkgewoJCQkJLy8gYm9vbGVhbiB2YWx1ZXMgcmVxdWlyZSBhIGJpdCBtb3JlIHdvcmsgOlAsIHN1cHBvcnRzIG9iamVjdCBwcm9wZXJ0aWVzCgkJCQkvLyBhbmQgb2xkIHNldHRpbmdzCgkJCQlpZiAoICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQl0ZXh0VmlzaWJsZSA9ICQubW9iaWxlLmxvYWRpbmdNZXNzYWdlVGV4dFZpc2libGU7CgkJCQl9IGVsc2UgewoJCQkJCXRleHRWaXNpYmxlID0gbG9hZFNldHRpbmdzLnRleHRWaXNpYmxlOwoJCQkJfQoKCQkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJCS8vIEZvcmNlIHRleHQgdmlzaWJpbGl0eSBpZiB0aGUgc2Vjb25kIGFyZ3VtZW50IHdhcyBzdXBwbGllZCwgb3IKCQkJCS8vIGlmIHRoZSB0ZXh0IHdhcyBleHBsaWNpdGx5IHNldCBpbiB0aGUgb2JqZWN0IGFyZ3MKCQkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCQkiIHVpLWNvcm5lci1hbGwgdWktYm9keS0iICsgdGhlbWUgKwoJCQkJCSIgdWktbG9hZGVyLSIgKyAoIHRleHRWaXNpYmxlIHx8IG1zZ1RleHQgfHwgdGhlbWUudGV4dCA/ICJ2ZXJib3NlIiA6ICJkZWZhdWx0IiApICsKCQkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCQkvLyBUT0RPIHZlcmlmeSB0aGF0IGpxdWVyeS5mbi5odG1sIGlzIG9rIHRvIHVzZSBpbiBib3RoIGNhc2VzIGhlcmUKCQkJCS8vICAgICAgdGhpcyBtaWdodCBiZSBvdmVybHkgZGVmZW5zaXZlIGluIHByZXZlbnRpbmcgdW5rbm93aW5nIHhzcwoJCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCQkvLyBvdGhlcndpc2UgdXNlIHRoZSBmYWxsYmFja3MgZnJvbSBhYm92ZQoJCQkJaWYgKCBsb2FkU2V0dGluZ3MuaHRtbCApIHsKCQkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5lbGVtZW50LmZpbmQoICJoMSIgKS50ZXh0KCBtZXNzYWdlICk7CgkJCQl9CgoJCQkJLy8gYXR0YWNoIHRoZSBsb2FkZXIgdG8gdGhlIERPTQoJCQkJdGhpcy5lbGVtZW50LmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJCXRoaXMuY2hlY2tMb2FkZXJQb3NpdGlvbigpOwoKCQkJCS8vIG9uIHNjcm9sbCBjaGVjayB0aGUgbG9hZGVyIHBvc2l0aW9uCgkJCQkkd2luZG93LmJpbmQoICJzY3JvbGwiLCAkLnByb3h5KCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24sIHRoaXMgKSApOwoJCQl9CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oKSB7CgkJCSRodG1sLnJlbW92ZUNsYXNzKCAidWktbG9hZGluZyIgKTsKCgkJCWlmICggJC5tb2JpbGUubG9hZGluZ01lc3NhZ2UgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJfQoKCQkJJC5tb2JpbGUud2luZG93LnVuYmluZCggInNjcm9sbCIsIHRoaXMuZmFrZUZpeExvYWRlciApOwoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICk7CgkJfQoJfSk7CgoJJHdpbmRvdy5iaW5kKCAncGFnZWNvbnRhaW5lcmNyZWF0ZScsIGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLmxvYWRlcldpZGdldCA9ICQubW9iaWxlLmxvYWRlcldpZGdldCB8fCAkKCAkLm1vYmlsZS5sb2FkZXIucHJvdG90eXBlLmRlZmF1bHRIdG1sICkubG9hZGVyKCk7Cgl9KTsKfSkoalF1ZXJ5LCB0aGlzKTsKCgovLyBTY3JpcHQ6IGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50Ci8vIAovLyAqVmVyc2lvbjogMS4zLCBMYXN0IHVwZGF0ZWQ6IDcvMjEvMjAxMCoKLy8gCi8vIFByb2plY3QgSG9tZSAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UtcGx1Z2luLwovLyBHaXRIdWIgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvCi8vIFNvdXJjZSAgICAgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLmpzCi8vIChNaW5pZmllZCkgICAtIGh0dHA6Ly9naXRodWIuY29tL2Nvd2JveS9qcXVlcnktaGFzaGNoYW5nZS9yYXcvbWFzdGVyL2pxdWVyeS5iYS1oYXNoY2hhbmdlLm1pbi5qcyAoMC44a2IgZ3ppcHBlZCkKLy8gCi8vIEFib3V0OiBMaWNlbnNlCi8vIAovLyBDb3B5cmlnaHQgKGMpIDIwMTAgIkNvd2JveSIgQmVuIEFsbWFuLAovLyBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgYW5kIEdQTCBsaWNlbnNlcy4KLy8gaHR0cDovL2JlbmFsbWFuLmNvbS9hYm91dC9saWNlbnNlLwovLyAKLy8gQWJvdXQ6IEV4YW1wbGVzCi8vIAovLyBUaGVzZSB3b3JraW5nIGV4YW1wbGVzLCBjb21wbGV0ZSB3aXRoIGZ1bGx5IGNvbW1lbnRlZCBjb2RlLCBpbGx1c3RyYXRlIGEgZmV3Ci8vIHdheXMgaW4gd2hpY2ggdGhpcyBwbHVnaW4gY2FuIGJlIHVzZWQuCi8vIAovLyBoYXNoY2hhbmdlIGV2ZW50IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2hhc2hjaGFuZ2UvCi8vIGRvY3VtZW50LmRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9kb2N1bWVudF9kb21haW4vCi8vIAovLyBBYm91dDogU3VwcG9ydCBhbmQgVGVzdGluZwovLyAKLy8gSW5mb3JtYXRpb24gYWJvdXQgd2hhdCB2ZXJzaW9uIG9yIHZlcnNpb25zIG9mIGpRdWVyeSB0aGlzIHBsdWdpbiBoYXMgYmVlbgovLyB0ZXN0ZWQgd2l0aCwgd2hhdCBicm93c2VycyBpdCBoYXMgYmVlbiB0ZXN0ZWQgaW4sIGFuZCB3aGVyZSB0aGUgdW5pdCB0ZXN0cwovLyByZXNpZGUgKHNvIHlvdSBjYW4gdGVzdCBpdCB5b3Vyc2VsZikuCi8vIAovLyBqUXVlcnkgVmVyc2lvbnMgLSAxLjIuNiwgMS4zLjIsIDEuNC4xLCAxLjQuMgovLyBCcm93c2VycyBUZXN0ZWQgLSBJbnRlcm5ldCBFeHBsb3JlciA2LTgsIEZpcmVmb3ggMi00LCBDaHJvbWUgNS02LCBTYWZhcmkgMy4yLTUsCi8vICAgICAgICAgICAgICAgICAgIE9wZXJhIDkuNi0xMC42MCwgaVBob25lIDMuMSwgQW5kcm9pZCAxLjYtMi4yLCBCbGFja0JlcnJ5IDQuNi01LgovLyBVbml0IFRlc3RzICAgICAgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvdW5pdC8KLy8gCi8vIEFib3V0OiBLbm93biBpc3N1ZXMKLy8gCi8vIFdoaWxlIHRoaXMgalF1ZXJ5IGhhc2hjaGFuZ2UgZXZlbnQgaW1wbGVtZW50YXRpb24gaXMgcXVpdGUgc3RhYmxlIGFuZAovLyByb2J1c3QsIHRoZXJlIGFyZSBhIGZldyB1bmZvcnR1bmF0ZSBicm93c2VyIGJ1Z3Mgc3Vycm91bmRpbmcgZXhwZWN0ZWQKLy8gaGFzaGNoYW5nZSBldmVudC1iYXNlZCBiZWhhdmlvcnMsIGluZGVwZW5kZW50IG9mIGFueSBKYXZhU2NyaXB0Ci8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgYWJzdHJhY3Rpb24uIFNlZSB0aGUgZm9sbG93aW5nIGV4YW1wbGVzIGZvciBtb3JlCi8vIGluZm9ybWF0aW9uOgovLyAKLy8gQ2hyb21lOiBCYWNrIEJ1dHRvbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctY2hyb21lLWJhY2stYnV0dG9uLwovLyBGaXJlZm94OiBSZW1vdGUgWE1MSHR0cFJlcXVlc3QgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWZpcmVmb3gtcmVtb3RlLXhoci8KLy8gV2ViS2l0OiBCYWNrIEJ1dHRvbiBpbiBhbiBJZnJhbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXdlYmtpdC1oYXNoLWlmcmFtZS8KLy8gU2FmYXJpOiBCYWNrIEJ1dHRvbiBmcm9tIGEgZGlmZmVyZW50IGRvbWFpbiAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9idWctc2FmYXJpLWJhY2stZnJvbS1kaWZmLWRvbWFpbi8KLy8gCi8vIEFsc28gbm90ZSB0aGF0IHNob3VsZCBhIGJyb3dzZXIgbmF0aXZlbHkgc3VwcG9ydCB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSAKLy8gZXZlbnQsIGJ1dCBub3QgcmVwb3J0IHRoYXQgaXQgZG9lcywgdGhlIGZhbGxiYWNrIHBvbGxpbmcgbG9vcCB3aWxsIGJlIHVzZWQuCi8vIAovLyBBYm91dDogUmVsZWFzZSBIaXN0b3J5Ci8vIAovLyAxLjMgICAtICg3LzIxLzIwMTApIFJlb3JnYW5pemVkIElFNi83IElmcmFtZSBjb2RlIHRvIG1ha2UgaXQgbW9yZQovLyAgICAgICAgICJyZW1vdmFibGUiIGZvciBtb2JpbGUtb25seSBkZXZlbG9wbWVudC4gQWRkZWQgSUU2LzcgZG9jdW1lbnQudGl0bGUKLy8gICAgICAgICBzdXBwb3J0LiBBdHRlbXB0ZWQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlIGJ5IHVzaW5nCi8vICAgICAgICAgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuIEFkZGVkIAovLyAgICAgICAgIHN1cHBvcnQgZm9yIHRoZSAic2hvcnRjdXQiIGZvcm1hdCAkKHdpbmRvdykuaGFzaGNoYW5nZSggZm4gKSBhbmQKLy8gICAgICAgICAkKHdpbmRvdykuaGFzaGNoYW5nZSgpIGxpa2UgalF1ZXJ5IHByb3ZpZGVzIGZvciBidWlsdC1pbiBldmVudHMuCi8vICAgICAgICAgUmVuYW1lZCBqUXVlcnkuaGFzaGNoYW5nZURlbGF5IHRvIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gYW5kCi8vICAgICAgICAgbG93ZXJlZCBpdHMgZGVmYXVsdCB2YWx1ZSB0byA1MC4gQWRkZWQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4KLy8gICAgICAgICBhbmQgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydGllcyBwbHVzIGRvY3VtZW50LWRvbWFpbi5odG1sCi8vICAgICAgICAgZmlsZSB0byBhZGRyZXNzIGFjY2VzcyBkZW5pZWQgaXNzdWVzIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gaW4KLy8gICAgICAgICBJRTYvNy4KLy8gMS4yICAgLSAoMi8xMS8yMDEwKSBGaXhlZCBhIGJ1ZyB3aGVyZSBjb21pbmcgYmFjayB0byBhIHBhZ2UgdXNpbmcgdGhpcyBwbHVnaW4KLy8gICAgICAgICBmcm9tIGEgcGFnZSBvbiBhbm90aGVyIGRvbWFpbiB3b3VsZCBjYXVzZSBhbiBlcnJvciBpbiBTYWZhcmkgNC4gQWxzbywKLy8gICAgICAgICBJRTYvNyBJZnJhbWUgaXMgbm93IGluc2VydGVkIGFmdGVyIHRoZSBib2R5ICh0aGlzIGFjdHVhbGx5IHdvcmtzKSwKLy8gICAgICAgICB3aGljaCBwcmV2ZW50cyB0aGUgcGFnZSBmcm9tIHNjcm9sbGluZyB3aGVuIHRoZSBldmVudCBpcyBmaXJzdCBib3VuZC4KLy8gICAgICAgICBFdmVudCBjYW4gYWxzbyBub3cgYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IGl0IHdvbid0IGJlIHVzYWJsZQovLyAgICAgICAgIGJlZm9yZSB0aGVuIGluIElFNi83LgovLyAxLjEgICAtICgxLzIxLzIwMTApIEluY29ycG9yYXRlZCBkb2N1bWVudC5kb2N1bWVudE1vZGUgdGVzdCB0byBmaXggSUU4IGJ1ZwovLyAgICAgICAgIHdoZXJlIGJyb3dzZXIgdmVyc2lvbiBpcyBpbmNvcnJlY3RseSByZXBvcnRlZCBhcyA4LjAsIGRlc3BpdGUKLy8gICAgICAgICBpbmNsdXNpb24gb2YgdGhlIFgtVUEtQ29tcGF0aWJsZSBJRT1FbXVsYXRlSUU3IG1ldGEgdGFnLgovLyAxLjAgICAtICgxLzkvMjAxMCkgSW5pdGlhbCBSZWxlYXNlLiBCcm9rZSBvdXQgdGhlIGpRdWVyeSBCQlEgZXZlbnQuc3BlY2lhbAovLyAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZnVuY3Rpb25hbGl0eSBpbnRvIGEgc2VwYXJhdGUgcGx1Z2luIGZvciB1c2VycwovLyAgICAgICAgIHdobyB3YW50IGp1c3QgdGhlIGJhc2ljIGV2ZW50ICYgYmFjayBidXR0b24gc3VwcG9ydCwgd2l0aG91dCBhbGwgdGhlCi8vICAgICAgICAgZXh0cmEgYXdlc29tZW5lc3MgdGhhdCBCQlEgcHJvdmlkZXMuIFRoaXMgcGx1Z2luIHdpbGwgYmUgaW5jbHVkZWQgYXMKLy8gICAgICAgICBwYXJ0IG9mIGpRdWVyeSBCQlEsIGJ1dCBhbHNvIGJlIGF2YWlsYWJsZSBzZXBhcmF0ZWx5LgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKICAvLyBSZXVzZWQgc3RyaW5nLgogIHZhciBzdHJfaGFzaGNoYW5nZSA9ICdoYXNoY2hhbmdlJywKICAgIAogICAgLy8gTWV0aG9kIC8gb2JqZWN0IHJlZmVyZW5jZXMuCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIGZha2Vfb25oYXNoY2hhbmdlLAogICAgc3BlY2lhbCA9ICQuZXZlbnQuc3BlY2lhbCwKICAgIAogICAgLy8gRG9lcyB0aGUgYnJvd3NlciBzdXBwb3J0IHdpbmRvdy5vbmhhc2hjaGFuZ2U/IE5vdGUgdGhhdCBJRTggcnVubmluZyBpbgogICAgLy8gSUU3IGNvbXBhdGliaWxpdHkgbW9kZSByZXBvcnRzIHRydWUgZm9yICdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdywgZXZlbgogICAgLy8gdGhvdWdoIHRoZSBldmVudCBpc24ndCBzdXBwb3J0ZWQsIHNvIGFsc28gdGVzdCBkb2N1bWVudC5kb2N1bWVudE1vZGUuCiAgICBkb2NfbW9kZSA9IGRvYy5kb2N1bWVudE1vZGUsCiAgICBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgPSAnb24nICsgc3RyX2hhc2hjaGFuZ2UgaW4gd2luZG93ICYmICggZG9jX21vZGUgPT09IHVuZGVmaW5lZCB8fCBkb2NfbW9kZSA+IDcgKTsKICAKICAvLyBHZXQgbG9jYXRpb24uaGFzaCAob3Igd2hhdCB5b3UnZCBleHBlY3QgbG9jYXRpb24uaGFzaCB0byBiZSkgc2FucyBhbnkKICAvLyBsZWFkaW5nICMuIFRoYW5rcyBmb3IgbWFraW5nIHRoaXMgbmVjZXNzYXJ5LCBGaXJlZm94IQogIGZ1bmN0aW9uIGdldF9mcmFnbWVudCggdXJsICkgewogICAgdXJsID0gdXJsIHx8IGxvY2F0aW9uLmhyZWY7CiAgICByZXR1cm4gJyMnICsgdXJsLnJlcGxhY2UoIC9eW14jXSojPyguKikkLywgJyQxJyApOwogIH07CiAgCiAgLy8gTWV0aG9kOiBqUXVlcnkuZm4uaGFzaGNoYW5nZQogIC8vIAogIC8vIEJpbmQgYSBoYW5kbGVyIHRvIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IG9yIHRyaWdnZXIgYWxsIGJvdW5kCiAgLy8gd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycy4gVGhpcyBiZWhhdmlvciBpcyBjb25zaXN0ZW50IHdpdGgKICAvLyBqUXVlcnkncyBidWlsdC1pbiBldmVudCBoYW5kbGVycy4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoIFsgaGFuZGxlciBdICk7CiAgLy8gCiAgLy8gQXJndW1lbnRzOgogIC8vIAogIC8vICBoYW5kbGVyIC0gKEZ1bmN0aW9uKSBPcHRpb25hbCBoYW5kbGVyIHRvIGJlIGJvdW5kIHRvIHRoZSBoYXNoY2hhbmdlCiAgLy8gICAgZXZlbnQuIFRoaXMgaXMgYSAic2hvcnRjdXQiIGZvciB0aGUgbW9yZSB2ZXJib3NlIGZvcm06CiAgLy8gICAgalF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBoYW5kbGVyICkuIElmIGhhbmRsZXIgaXMgb21pdHRlZCwKICAvLyAgICBhbGwgYm91bmQgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBoYW5kbGVycyB3aWxsIGJlIHRyaWdnZXJlZC4gVGhpcwogIC8vICAgIGlzIGEgc2hvcnRjdXQgZm9yIHRoZSBtb3JlIHZlcmJvc2UKICAvLyAgICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4gVGhlc2UgZm9ybXMgYXJlIGRlc2NyaWJlZCBpbgogIC8vICAgIHRoZSA8aGFzaGNoYW5nZSBldmVudD4gc2VjdGlvbi4KICAvLyAKICAvLyBSZXR1cm5zOgogIC8vIAogIC8vICAoalF1ZXJ5KSBUaGUgaW5pdGlhbCBqUXVlcnkgY29sbGVjdGlvbiBvZiBlbGVtZW50cy4KICAKICAvLyBBbGxvdyB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJChlbGVtKS5oYXNoY2hhbmdlKCBmbiApIGZvciBiaW5kaW5nIGFuZAogIC8vICQoZWxlbSkuaGFzaGNoYW5nZSgpIGZvciB0cmlnZ2VyaW5nLCBsaWtlIGpRdWVyeSBkb2VzIGZvciBidWlsdC1pbiBldmVudHMuCiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXSA9IGZ1bmN0aW9uKCBmbiApIHsKICAgIHJldHVybiBmbiA/IHRoaXMuYmluZCggc3RyX2hhc2hjaGFuZ2UsIGZuICkgOiB0aGlzLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgfTsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXkKICAvLyAKICAvLyBUaGUgbnVtZXJpYyBpbnRlcnZhbCAoaW4gbWlsbGlzZWNvbmRzKSBhdCB3aGljaCB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+CiAgLy8gcG9sbGluZyBsb29wIGV4ZWN1dGVzLiBEZWZhdWx0cyB0byA1MC4KICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZG9tYWluCiAgLy8gCiAgLy8gSWYgeW91J3JlIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluIHlvdXIgSmF2YVNjcmlwdCwgYW5kIHlvdSB3YW50IGhhc2gKICAvLyBoaXN0b3J5IHRvIHdvcmsgaW4gSUU2LzcsIG5vdCBvbmx5IG11c3QgdGhpcyBwcm9wZXJ0eSBiZSBzZXQsIGJ1dCB5b3UgbXVzdAogIC8vIGFsc28gc2V0IGRvY3VtZW50LmRvbWFpbiBCRUZPUkUgalF1ZXJ5IGlzIGxvYWRlZCBpbnRvIHRoZSBwYWdlLiBUaGlzCiAgLy8gcHJvcGVydHkgaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZwogIC8vIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gSW4gYWRkaXRpb24sIHRoZSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjPiBwcm9wZXJ0eSBtdXN0IGJlIHNldCB0byB0aGUKICAvLyBwYXRoIG9mIHRoZSBpbmNsdWRlZCAiZG9jdW1lbnQtZG9tYWluLmh0bWwiIGZpbGUsIHdoaWNoIGNhbiBiZSByZW5hbWVkIG9yCiAgLy8gbW9kaWZpZWQgaWYgbmVjZXNzYXJ5IChub3RlIHRoYXQgdGhlIGRvY3VtZW50LmRvbWFpbiBzcGVjaWZpZWQgbXVzdCBiZSB0aGUKICAvLyBzYW1lIGluIGJvdGggeW91ciBtYWluIEphdmFTY3JpcHQgYXMgd2VsbCBhcyBpbiB0aGlzIGZpbGUpLgogIC8vIAogIC8vIFVzYWdlOgogIC8vIAogIC8vIGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbiA9IGRvY3VtZW50LmRvbWFpbjsKICAKICAvLyBQcm9wZXJ0eTogalF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjCiAgLy8gCiAgLy8gSWYsIGZvciBzb21lIHJlYXNvbiwgeW91IG5lZWQgdG8gc3BlY2lmeSBhbiBJZnJhbWUgc3JjIGZpbGUgKGZvciBleGFtcGxlLAogIC8vIHdoZW4gc2V0dGluZyBkb2N1bWVudC5kb21haW4gYXMgaW4gPGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbj4pLCB5b3UgY2FuCiAgLy8gZG8gc28gdXNpbmcgdGhpcyBwcm9wZXJ0eS4gTm90ZSB0aGF0IHdoZW4gdXNpbmcgdGhpcyBwcm9wZXJ0eSwgaGlzdG9yeQogIC8vIHdvbid0IGJlIHJlY29yZGVkIGluIElFNi83IHVudGlsIHRoZSBJZnJhbWUgc3JjIGZpbGUgbG9hZHMuIFRoaXMgcHJvcGVydHkKICAvLyBpcyBvbmx5IGFwcGxpY2FibGUgaWYgeW91IGFyZSBzdXBwb3J0aW5nIElFNi83IChvciBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmMgPSAncGF0aC90by9maWxlLmh0bWwnOwogIAogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgPSA1MDsKICAvKgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZG9tYWluID0gbnVsbDsKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYyA9IG51bGw7CiAgKi8KICAKICAvLyBFdmVudDogaGFzaGNoYW5nZSBldmVudAogIC8vIAogIC8vIEZpcmVkIHdoZW4gbG9jYXRpb24uaGFzaCBjaGFuZ2VzLiBJbiBicm93c2VycyB0aGF0IHN1cHBvcnQgaXQsIHRoZSBuYXRpdmUKICAvLyBIVE1MNSB3aW5kb3cub25oYXNoY2hhbmdlIGV2ZW50IGlzIHVzZWQsIG90aGVyd2lzZSBhIHBvbGxpbmcgbG9vcCBpcwogIC8vIGluaXRpYWxpemVkLCBydW5uaW5nIGV2ZXJ5IDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kZWxheT4gbWlsbGlzZWNvbmRzIHRvCiAgLy8gc2VlIGlmIHRoZSBoYXNoIGhhcyBjaGFuZ2VkLiBJbiBJRTYvNyAoYW5kIElFOCBvcGVyYXRpbmcgaW4gIklFNwogIC8vIGNvbXBhdGliaWxpdHkiIG1vZGUpLCBhIGhpZGRlbiBJZnJhbWUgaXMgY3JlYXRlZCB0byBhbGxvdyB0aGUgYmFjayBidXR0b24KICAvLyBhbmQgaGFzaC1iYXNlZCBoaXN0b3J5IHRvIHdvcmsuCiAgLy8gCiAgLy8gVXNhZ2UgYXMgZGVzY3JpYmVkIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZT46CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKTsKICAvLyAKICAvLyBBIG1vcmUgdmVyYm9zZSB1c2FnZSB0aGF0IGFsbG93cyBmb3IgZXZlbnQgbmFtZXNwYWNpbmc6CiAgLy8gCiAgLy8gPiAvLyBCaW5kIGFuIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5iaW5kKCAnaGFzaGNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAvLyA+ICAgdmFyIGhhc2ggPSBsb2NhdGlvbi5oYXNoOwogIC8vID4gICAuLi4KICAvLyA+IH0pOwogIC8vID4gCiAgLy8gPiAvLyBNYW51YWxseSB0cmlnZ2VyIHRoZSBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICk7CiAgLy8gCiAgLy8gQWRkaXRpb25hbCBOb3RlczoKICAvLyAKICAvLyAqIFRoZSBwb2xsaW5nIGxvb3AgYW5kIElmcmFtZSBhcmUgbm90IGNyZWF0ZWQgdW50aWwgYXQgbGVhc3Qgb25lIGhhbmRsZXIKICAvLyAgIGlzIGFjdHVhbGx5IGJvdW5kIHRvIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQuCiAgLy8gKiBJZiB5b3UgbmVlZCB0aGUgYm91bmQgaGFuZGxlcihzKSB0byBleGVjdXRlIGltbWVkaWF0ZWx5LCBpbiBjYXNlcyB3aGVyZQogIC8vICAgYSBsb2NhdGlvbi5oYXNoIGV4aXN0cyBvbiBwYWdlIGxvYWQsIHZpYSBib29rbWFyayBvciBwYWdlIHJlZnJlc2ggZm9yCiAgLy8gICBleGFtcGxlLCB1c2UgalF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSgpIG9yIHRoZSBtb3JlIHZlcmJvc2UgCiAgLy8gICBqUXVlcnkod2luZG93KS50cmlnZ2VyKCAnaGFzaGNoYW5nZScgKS4KICAvLyAqIFRoZSBldmVudCBjYW4gYmUgYm91bmQgYmVmb3JlIERPTSByZWFkeSwgYnV0IHNpbmNlIGl0IHdvbid0IGJlIHVzYWJsZQogIC8vICAgYmVmb3JlIHRoZW4gaW4gSUU2LzcgKGR1ZSB0byB0aGUgbmVjZXNzYXJ5IElmcmFtZSksIHJlY29tbWVuZGVkIHVzYWdlIGlzCiAgLy8gICB0byBiaW5kIGl0IGluc2lkZSBhIERPTSByZWFkeSBoYW5kbGVyLgogIAogIC8vIE92ZXJyaWRlIGV4aXN0aW5nICQuZXZlbnQuc3BlY2lhbC5oYXNoY2hhbmdlIG1ldGhvZHMgKGFsbG93aW5nIHRoaXMgcGx1Z2luCiAgLy8gdG8gYmUgZGVmaW5lZCBhZnRlciBqUXVlcnkgQkJRIGluIEJCUSdzIHNvdXJjZSBjb2RlKS4KICBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdID0gJC5leHRlbmQoIHNwZWNpYWxbIHN0cl9oYXNoY2hhbmdlIF0sIHsKICAgIAogICAgLy8gQ2FsbGVkIG9ubHkgd2hlbiB0aGUgZmlyc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIGJvdW5kIHRvIHdpbmRvdy4KICAgIHNldHVwOiBmdW5jdGlvbigpIHsKICAgICAgLy8gSWYgd2luZG93Lm9uaGFzaGNoYW5nZSBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoZXJlJ3Mgbm90aGluZyB0byBkby4uCiAgICAgIGlmICggc3VwcG9ydHNfb25oYXNoY2hhbmdlICkgeyByZXR1cm4gZmFsc2U7IH0KICAgICAgCiAgICAgIC8vIE90aGVyd2lzZSwgd2UgbmVlZCB0byBjcmVhdGUgb3VyIG93bi4gQW5kIHdlIGRvbid0IHdhbnQgdG8gY2FsbCB0aGlzCiAgICAgIC8vIHVudGlsIHRoZSB1c2VyIGJpbmRzIHRvIHRoZSBldmVudCwganVzdCBpbiBjYXNlIHRoZXkgbmV2ZXIgZG8sIHNpbmNlIGl0CiAgICAgIC8vIHdpbGwgY3JlYXRlIGEgcG9sbGluZyBsb29wIGFuZCBwb3NzaWJseSBldmVuIGEgaGlkZGVuIElmcmFtZS4KICAgICAgJCggZmFrZV9vbmhhc2hjaGFuZ2Uuc3RhcnQgKTsKICAgIH0sCiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGxhc3QgJ2hhc2hjaGFuZ2UnIGV2ZW50IGlzIHVuYm91bmQgZnJvbSB3aW5kb3cuCiAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gc3RvcCBvdXJzIChpZiBwb3NzaWJsZSkuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0b3AgKTsKICAgIH0KICAgIAogIH0pOwogIAogIC8vIGZha2Vfb25oYXNoY2hhbmdlIGRvZXMgYWxsIHRoZSB3b3JrIG9mIHRyaWdnZXJpbmcgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UKICAvLyBldmVudCBmb3IgYnJvd3NlcnMgdGhhdCBkb24ndCBuYXRpdmVseSBzdXBwb3J0IGl0LCBpbmNsdWRpbmcgY3JlYXRpbmcgYQogIC8vIHBvbGxpbmcgbG9vcCB0byB3YXRjaCBmb3IgaGFzaCBjaGFuZ2VzIGFuZCBpbiBJRSA2LzcgY3JlYXRpbmcgYSBoaWRkZW4KICAvLyBJZnJhbWUgdG8gZW5hYmxlIGJhY2sgYW5kIGZvcndhcmQuCiAgZmFrZV9vbmhhc2hjaGFuZ2UgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgc2VsZiA9IHt9LAogICAgICB0aW1lb3V0X2lkLAogICAgICAKICAgICAgLy8gUmVtZW1iZXIgdGhlIGluaXRpYWwgaGFzaCBzbyBpdCBkb2Vzbid0IGdldCB0cmlnZ2VyZWQgaW1tZWRpYXRlbHkuCiAgICAgIGxhc3RfaGFzaCA9IGdldF9mcmFnbWVudCgpLAogICAgICAKICAgICAgZm5fcmV0dmFsID0gZnVuY3Rpb24oIHZhbCApIHsgcmV0dXJuIHZhbDsgfSwKICAgICAgaGlzdG9yeV9zZXQgPSBmbl9yZXR2YWwsCiAgICAgIGhpc3RvcnlfZ2V0ID0gZm5fcmV0dmFsOwogICAgCiAgICAvLyBTdGFydCB0aGUgcG9sbGluZyBsb29wLgogICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkIHx8IHBvbGwoKTsKICAgIH07CiAgICAKICAgIC8vIFN0b3AgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICB0aW1lb3V0X2lkICYmIGNsZWFyVGltZW91dCggdGltZW91dF9pZCApOwogICAgICB0aW1lb3V0X2lkID0gdW5kZWZpbmVkOwogICAgfTsKICAgIAogICAgLy8gVGhpcyBwb2xsaW5nIGxvb3AgY2hlY2tzIGV2ZXJ5ICQuZm4uaGFzaGNoYW5nZS5kZWxheSBtaWxsaXNlY29uZHMgdG8gc2VlCiAgICAvLyBpZiBsb2NhdGlvbi5oYXNoIGhhcyBjaGFuZ2VkLCBhbmQgdHJpZ2dlcnMgdGhlICdoYXNoY2hhbmdlJyBldmVudCBvbgogICAgLy8gd2luZG93IHdoZW4gbmVjZXNzYXJ5LgogICAgZnVuY3Rpb24gcG9sbCgpIHsKICAgICAgdmFyIGhhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgICBoaXN0b3J5X2hhc2ggPSBoaXN0b3J5X2dldCggbGFzdF9oYXNoICk7CiAgICAgIAogICAgICBpZiAoIGhhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBoaXN0b3J5X3NldCggbGFzdF9oYXNoID0gaGFzaCwgaGlzdG9yeV9oYXNoICk7CiAgICAgICAgCiAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoIHN0cl9oYXNoY2hhbmdlICk7CiAgICAgICAgCiAgICAgIH0gZWxzZSBpZiAoIGhpc3RvcnlfaGFzaCAhPT0gbGFzdF9oYXNoICkgewogICAgICAgIGxvY2F0aW9uLmhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoIC8jLiovLCAnJyApICsgaGlzdG9yeV9oYXNoOwogICAgICB9CiAgICAgIAogICAgICB0aW1lb3V0X2lkID0gc2V0VGltZW91dCggcG9sbCwgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kZWxheSApOwogICAgfTsKICAgIAogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2IFJFTU9WRSBJRiBOT1QgU1VQUE9SVElORyBJRTYvNy84IHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgd2luZG93LmF0dGFjaEV2ZW50ICYmICF3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciAmJiAhc3VwcG9ydHNfb25oYXNoY2hhbmdlICYmIChmdW5jdGlvbigpIHsKICAgICAgLy8gTm90IG9ubHkgZG8gSUU2LzcgbmVlZCB0aGUgIm1hZ2ljYWwiIElmcmFtZSB0cmVhdG1lbnQsIGJ1dCBzbyBkb2VzIElFOAogICAgICAvLyB3aGVuIHJ1bm5pbmcgaW4gIklFNyBjb21wYXRpYmlsaXR5IiBtb2RlLgogICAgICAKICAgICAgdmFyIGlmcmFtZSwKICAgICAgICBpZnJhbWVfc3JjOwogICAgICAKICAgICAgLy8gV2hlbiB0aGUgZXZlbnQgaXMgYm91bmQgYW5kIHBvbGxpbmcgc3RhcnRzIGluIElFIDYvNywgY3JlYXRlIGEgaGlkZGVuCiAgICAgIC8vIElmcmFtZSBmb3IgaGlzdG9yeSBoYW5kbGluZy4KICAgICAgc2VsZi5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICggIWlmcmFtZSApIHsKICAgICAgICAgIGlmcmFtZV9zcmMgPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLnNyYzsKICAgICAgICAgIGlmcmFtZV9zcmMgPSBpZnJhbWVfc3JjICYmIGlmcmFtZV9zcmMgKyBnZXRfZnJhZ21lbnQoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gQ3JlYXRlIGhpZGRlbiBJZnJhbWUuIEF0dGVtcHQgdG8gbWFrZSBJZnJhbWUgYXMgaGlkZGVuIGFzIHBvc3NpYmxlCiAgICAgICAgICAvLyBieSB1c2luZyB0ZWNobmlxdWVzIGZyb20gaHR0cDovL3d3dy5wYWNpZWxsb2dyb3VwLmNvbS9ibG9nLz9wPTYwNC4KICAgICAgICAgIGlmcmFtZSA9ICQoJzxpZnJhbWUgdGFiaW5kZXg9Ii0xIiB0aXRsZT0iZW1wdHkiLz4nKS5oaWRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIFdoZW4gSWZyYW1lIGhhcyBjb21wbGV0ZWx5IGxvYWRlZCwgaW5pdGlhbGl6ZSB0aGUgaGlzdG9yeSBhbmQKICAgICAgICAgICAgLy8gc3RhcnQgcG9sbGluZy4KICAgICAgICAgICAgLm9uZSggJ2xvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZnJhbWVfc3JjIHx8IGhpc3Rvcnlfc2V0KCBnZXRfZnJhZ21lbnQoKSApOwogICAgICAgICAgICAgIHBvbGwoKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIExvYWQgSWZyYW1lIHNyYyBpZiBzcGVjaWZpZWQsIG90aGVyd2lzZSBub3RoaW5nLgogICAgICAgICAgICAuYXR0ciggJ3NyYycsIGlmcmFtZV9zcmMgfHwgJ2phdmFzY3JpcHQ6MCcgKQogICAgICAgICAgICAKICAgICAgICAgICAgLy8gQXBwZW5kIElmcmFtZSBhZnRlciB0aGUgZW5kIG9mIHRoZSBib2R5IHRvIHByZXZlbnQgdW5uZWNlc3NhcnkKICAgICAgICAgICAgLy8gaW5pdGlhbCBwYWdlIHNjcm9sbGluZyAoeWVzLCB0aGlzIHdvcmtzKS4KICAgICAgICAgICAgLmluc2VydEFmdGVyKCAnYm9keScgKVswXS5jb250ZW50V2luZG93OwogICAgICAgICAgCiAgICAgICAgICAvLyBXaGVuZXZlciBgZG9jdW1lbnQudGl0bGVgIGNoYW5nZXMsIHVwZGF0ZSB0aGUgSWZyYW1lJ3MgdGl0bGUgdG8KICAgICAgICAgIC8vIHByZXR0aWZ5IHRoZSBiYWNrL25leHQgaGlzdG9yeSBtZW51IGVudHJpZXMuIFNpbmNlIElFIHNvbWV0aW1lcwogICAgICAgICAgLy8gZXJyb3JzIHdpdGggIlVuc3BlY2lmaWVkIGVycm9yIiB0aGUgdmVyeSBmaXJzdCB0aW1lIHRoaXMgaXMgc2V0CiAgICAgICAgICAvLyAoeWVzLCB2ZXJ5IHVzZWZ1bCkgd3JhcCB0aGlzIHdpdGggYSB0cnkvY2F0Y2ggYmxvY2suCiAgICAgICAgICBkb2Mub25wcm9wZXJ0eWNoYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGlmICggZXZlbnQucHJvcGVydHlOYW1lID09PSAndGl0bGUnICkgewogICAgICAgICAgICAgICAgaWZyYW1lLmRvY3VtZW50LnRpdGxlID0gZG9jLnRpdGxlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaChlKSB7fQogICAgICAgICAgfTsKICAgICAgICAgIAogICAgICAgIH0KICAgICAgfTsKICAgICAgCiAgICAgIC8vIE92ZXJyaWRlIHRoZSAic3RvcCIgbWV0aG9kIHNpbmNlIGFuIElFNi83IElmcmFtZSB3YXMgY3JlYXRlZC4gRXZlbgogICAgICAvLyBpZiB0aGVyZSBhcmUgbm8gbG9uZ2VyIGFueSBib3VuZCBldmVudCBoYW5kbGVycywgdGhlIHBvbGxpbmcgbG9vcAogICAgICAvLyBpcyBzdGlsbCBuZWNlc3NhcnkgZm9yIGJhY2svbmV4dCB0byB3b3JrIGF0IGFsbCEKICAgICAgc2VsZi5zdG9wID0gZm5fcmV0dmFsOwogICAgICAKICAgICAgLy8gR2V0IGhpc3RvcnkgYnkgbG9va2luZyBhdCB0aGUgaGlkZGVuIElmcmFtZSdzIGxvY2F0aW9uLmhhc2guCiAgICAgIGhpc3RvcnlfZ2V0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldF9mcmFnbWVudCggaWZyYW1lLmxvY2F0aW9uLmhyZWYgKTsKICAgICAgfTsKICAgICAgCiAgICAgIC8vIFNldCBhIG5ldyBoaXN0b3J5IGl0ZW0gYnkgb3BlbmluZyBhbmQgdGhlbiBjbG9zaW5nIHRoZSBJZnJhbWUKICAgICAgLy8gZG9jdW1lbnQsICp0aGVuKiBzZXR0aW5nIGl0cyBsb2NhdGlvbi5oYXNoLiBJZiBkb2N1bWVudC5kb21haW4gaGFzCiAgICAgIC8vIGJlZW4gc2V0LCB1cGRhdGUgdGhhdCBhcyB3ZWxsLgogICAgICBoaXN0b3J5X3NldCA9IGZ1bmN0aW9uKCBoYXNoLCBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgdmFyIGlmcmFtZV9kb2MgPSBpZnJhbWUuZG9jdW1lbnQsCiAgICAgICAgICBkb21haW4gPSAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbjsKICAgICAgICAKICAgICAgICBpZiAoIGhhc2ggIT09IGhpc3RvcnlfaGFzaCApIHsKICAgICAgICAgIC8vIFVwZGF0ZSBJZnJhbWUgd2l0aCBhbnkgaW5pdGlhbCBgZG9jdW1lbnQudGl0bGVgIHRoYXQgbWlnaHQgYmUgc2V0LgogICAgICAgICAgaWZyYW1lX2RvYy50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgIAogICAgICAgICAgLy8gT3BlbmluZyB0aGUgSWZyYW1lJ3MgZG9jdW1lbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gY2xvc2VkIGlzIHdoYXQKICAgICAgICAgIC8vIGFjdHVhbGx5IGFkZHMgYSBoaXN0b3J5IGVudHJ5LgogICAgICAgICAgaWZyYW1lX2RvYy5vcGVuKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFNldCBkb2N1bWVudC5kb21haW4gZm9yIHRoZSBJZnJhbWUgZG9jdW1lbnQgYXMgd2VsbCwgaWYgbmVjZXNzYXJ5LgogICAgICAgICAgZG9tYWluICYmIGlmcmFtZV9kb2Mud3JpdGUoICc8c2NyaXB0PmRvY3VtZW50LmRvbWFpbj0iJyArIGRvbWFpbiArICciPC9zY3JpcHQ+JyApOwogICAgICAgICAgCiAgICAgICAgICBpZnJhbWVfZG9jLmNsb3NlKCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgSWZyYW1lJ3MgaGFzaCwgZm9yIGdyZWF0IGp1c3RpY2UuCiAgICAgICAgICBpZnJhbWUubG9jYXRpb24uaGFzaCA9IGhhc2g7CiAgICAgICAgfQogICAgICB9OwogICAgICAKICAgIH0pKCk7CiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl4gUkVNT1ZFIElGIE5PVCBTVVBQT1JUSU5HIElFNi83LzggXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAKICAgIHJldHVybiBzZWxmOwogIH0pKCk7CiAgCn0pKGpRdWVyeSx0aGlzKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8qISBtYXRjaE1lZGlhKCkgcG9seWZpbGwgLSBUZXN0IGEgQ1NTIG1lZGlhIHR5cGUvcXVlcnkgaW4gSlMuIEF1dGhvcnMgJiBjb3B5cmlnaHQgKGMpIDIwMTI6IFNjb3R0IEplaGwsIFBhdWwgSXJpc2gsIE5pY2hvbGFzIFpha2FzLiBEdWFsIE1JVC9CU0QgbGljZW5zZSAqLwoJd2luZG93Lm1hdGNoTWVkaWEgPSB3aW5kb3cubWF0Y2hNZWRpYSB8fCAoZnVuY3Rpb24oIGRvYywgdW5kZWZpbmVkICkgewoKCQkKCgkJdmFyIGJvb2wsCgkJCWRvY0VsZW0gPSBkb2MuZG9jdW1lbnRFbGVtZW50LAoJCQlyZWZOb2RlID0gZG9jRWxlbS5maXJzdEVsZW1lbnRDaGlsZCB8fCBkb2NFbGVtLmZpcnN0Q2hpbGQsCgkJCS8vIGZha2VCb2R5IHJlcXVpcmVkIGZvciA8RkY0IHdoZW4gZXhlY3V0ZWQgaW4gPGhlYWQ+CgkJCWZha2VCb2R5ID0gZG9jLmNyZWF0ZUVsZW1lbnQoICJib2R5IiApLAoJCQlkaXYgPSBkb2MuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCgkJZGl2LmlkID0gIm1xLXRlc3QtMSI7CgkJZGl2LnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7dG9wOi0xMDBlbSI7CgkJZmFrZUJvZHkuc3R5bGUuYmFja2dyb3VuZCA9ICJub25lIjsKCQlmYWtlQm9keS5hcHBlbmRDaGlsZChkaXYpOwoKCQlyZXR1cm4gZnVuY3Rpb24ocSl7CgoJCQlkaXYuaW5uZXJIVE1MID0gIiZzaHk7PHN0eWxlIG1lZGlhPVwiIiArIHEgKyAiXCI+ICNtcS10ZXN0LTEgeyB3aWR0aDogNDJweDsgfTwvc3R5bGU+IjsKCgkJCWRvY0VsZW0uaW5zZXJ0QmVmb3JlKCBmYWtlQm9keSwgcmVmTm9kZSApOwoJCQlib29sID0gZGl2Lm9mZnNldFdpZHRoID09PSA0MjsKCQkJZG9jRWxlbS5yZW1vdmVDaGlsZCggZmFrZUJvZHkgKTsKCgkJCXJldHVybiB7CgkJCQltYXRjaGVzOiBib29sLAoJCQkJbWVkaWE6IHEKCQkJfTsKCgkJfTsKCgl9KCBkb2N1bWVudCApKTsKCgkvLyAkLm1vYmlsZS5tZWRpYSB1c2VzIG1hdGNoTWVkaWEgdG8gcmV0dXJuIGEgYm9vbGVhbi4KCSQubW9iaWxlLm1lZGlhID0gZnVuY3Rpb24oIHEgKSB7CgkJcmV0dXJuIHdpbmRvdy5tYXRjaE1lZGlhKCBxICkubWF0Y2hlczsKCX07Cgp9KShqUXVlcnkpOwoKCShmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJCXZhciBzdXBwb3J0ID0gewoJCQl0b3VjaDogIm9udG91Y2hlbmQiIGluIGRvY3VtZW50CgkJfTsKCgkJJC5tb2JpbGUuc3VwcG9ydCA9ICQubW9iaWxlLnN1cHBvcnQgfHwge307CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgc3VwcG9ydCApOwoJCSQuZXh0ZW5kKCAkLm1vYmlsZS5zdXBwb3J0LCBzdXBwb3J0ICk7Cgl9KCBqUXVlcnkgKSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJJC5leHRlbmQoICQuc3VwcG9ydCwgewoJCQlvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiBpbiB3aW5kb3cgJiYgIm9ub3JpZW50YXRpb25jaGFuZ2UiIGluIHdpbmRvdwoJCX0pOwoJfSggalF1ZXJ5ICkpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovLyB0aHggTW9kZXJuaXpyCmZ1bmN0aW9uIHByb3BFeGlzdHMoIHByb3AgKSB7Cgl2YXIgdWNfcHJvcCA9IHByb3AuY2hhckF0KCAwICkudG9VcHBlckNhc2UoKSArIHByb3Auc3Vic3RyKCAxICksCgkJcHJvcHMgPSAoIHByb3AgKyAiICIgKyB2ZW5kb3JzLmpvaW4oIHVjX3Byb3AgKyAiICIgKSArIHVjX3Byb3AgKS5zcGxpdCggIiAiICk7CgoJZm9yICggdmFyIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICk7IC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoKCmZ1bmN0aW9uIHZhbGlkU3R5bGUoIHByb3AsIHZhbHVlLCBjaGVja192ZW5kICkgewoJdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdkaXYnICksCgkJdWMgPSBmdW5jdGlvbiggdHh0ICkgewoJCQlyZXR1cm4gdHh0LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyB0eHQuc3Vic3RyKCAxICk7CgkJfSwKCQl2ZW5kX3ByZWYgPSBmdW5jdGlvbiggdmVuZCApIHsKCQkJaWYoIHZlbmQgPT09ICIiICkgewoJCQkJcmV0dXJuICIiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuICAiLSIgKyB2ZW5kLmNoYXJBdCggMCApLnRvTG93ZXJDYXNlKCkgKyB2ZW5kLnN1YnN0ciggMSApICsgIi0iOwoJCQl9CgkJfSwKCQljaGVja19zdHlsZSA9IGZ1bmN0aW9uKCB2ZW5kICkgewoJCQl2YXIgdmVuZF9wcm9wID0gdmVuZF9wcmVmKCB2ZW5kICkgKyBwcm9wICsgIjogIiArIHZhbHVlICsgIjsiLAoJCQkJdWNfdmVuZCA9IHVjKCB2ZW5kICksCgkJCQlwcm9wU3R5bGUgPSB1Y192ZW5kICsgKCB1Y192ZW5kID09PSAiIiA/IHByb3AgOiB1YyggcHJvcCApICk7CgoJCQlkaXYuc2V0QXR0cmlidXRlKCAic3R5bGUiLCB2ZW5kX3Byb3AgKTsKCgkJCWlmICggISFkaXYuc3R5bGVbIHByb3BTdHlsZSBdICkgewoJCQkJcmV0ID0gdHJ1ZTsKCQkJfQoJCX0sCgkJY2hlY2tfdmVuZHMgPSBjaGVja192ZW5kID8gY2hlY2tfdmVuZCA6IHZlbmRvcnMsCgkJcmV0OwoKCWZvciggdmFyIGkgPSAwOyBpIDwgY2hlY2tfdmVuZHMubGVuZ3RoOyBpKysgKSB7CgkJY2hlY2tfc3R5bGUoIGNoZWNrX3ZlbmRzW2ldICk7Cgl9CglyZXR1cm4gISFyZXQ7Cn0KCmZ1bmN0aW9uIHRyYW5zZm9ybTNkVGVzdCgpIHsKCXZhciBtcVByb3AgPSAidHJhbnNmb3JtLTNkIiwKCQkvLyBCZWNhdXNlIHRoZSBgdHJhbnNsYXRlM2RgIHRlc3QgYmVsb3cgdGhyb3dzIGZhbHNlIHBvc2l0aXZlcyBpbiBBbmRyb2lkOgoJCXJldCA9ICQubW9iaWxlLm1lZGlhKCAiKC0iICsgdmVuZG9ycy5qb2luKCAiLSIgKyBtcVByb3AgKyAiKSwoLSIgKSArICItIiArIG1xUHJvcCArICIpLCgiICsgbXFQcm9wICsgIikiICk7CgoJaWYoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQl0cmFuc2Zvcm1zID0gewoJCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCQknTW96VHJhbnNmb3JtJzonLW1vei10cmFuc2Zvcm0nLAoJCQkndHJhbnNmb3JtJzondHJhbnNmb3JtJwoJCX07CgoJZmFrZUJvZHkuYXBwZW5kKCBlbCApOwoKCWZvciAoIHZhciB0IGluIHRyYW5zZm9ybXMgKSB7CgkJaWYoIGVsLnN0eWxlWyB0IF0gIT09IHVuZGVmaW5lZCApewoJCQllbC5zdHlsZVsgdCBdID0gJ3RyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSc7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ3gnICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICdwb2ludGVyRXZlbnRzJyBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdhdXRvJzsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICd4JzsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAnJyApLnBvaW50ZXJFdmVudHMgPT09ICdhdXRvJzsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZigKCQkvLyBpT1MgNC4zIGFuZCBvbGRlciA6IFBsYXRmb3JtIGlzIGlQaG9uZS9QYWQvVG91Y2ggYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzQgKGlvczUpCgkJKCAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHx8CgkJLy8gT3BlcmEgTWluaQoJCSggdy5vcGVyYW1pbmkgJiYgKHt9KS50b1N0cmluZy5jYWxsKCB3Lm9wZXJhbWluaSApID09PSAiW29iamVjdCBPcGVyYU1pbmldIiApIHx8CgkJKCBvcGVyYW1tb2JpbGVtYXRjaCAmJiBvbXZlcnNpb24gPCA3NDU4ICkJfHwKCQkvL0FuZHJvaWQgbHRlIDIuMTogUGxhdGZvcm0gaXMgQW5kcm9pZCBhbmQgV2Via2l0IHZlcnNpb24gaXMgbGVzcyB0aGFuIDUzMyAoQW5kcm9pZCAyLjIpCgkJKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzMgKSB8fAoJCS8vIEZpcmVmb3ggTW9iaWxlIGJlZm9yZSA2LjAgLQoJCSggZmZ2ZXJzaW9uICYmIGZmdmVyc2lvbiA8IDYgKSB8fAoJCS8vIFdlYk9TIGxlc3MgdGhhbiAzCgkJKCAicGFsbUdldFJlc291cmNlIiBpbiB3aW5kb3cgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApCXx8CgkJLy8gTWVlR28KCQkoIHVhLmluZGV4T2YoICJNZWVHbyIgKSA+IC0xICYmIHVhLmluZGV4T2YoICJOb2tpYUJyb3dzZXIvOC41LjAiICkgPiAtMSApICkgewoJCXJldHVybiBmYWxzZTsKCX0KCglyZXR1cm4gdHJ1ZTsKfQoKJC5leHRlbmQoICQuc3VwcG9ydCwgewoJY3NzVHJhbnNpdGlvbnM6ICJXZWJLaXRUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdyB8fAoJCXZhbGlkU3R5bGUoICd0cmFuc2l0aW9uJywgJ2hlaWdodCAxMDBtcyBsaW5lYXInLCBbICJXZWJraXQiLCAiTW96IiwgIiIgXSApICYmCgkJISQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgIW9wZXJhLAoKCS8vIE5vdGUsIENocm9tZSBmb3IgaU9TIGhhcyBhbiBleHRyZW1lbHkgcXVpcmt5IGltcGxlbWVudGF0aW9uIG9mIHBvcHN0YXRlLgoJLy8gV2UndmUgY2hvc2VuIHRvIHRha2UgdGhlIHNob3J0ZXN0IHBhdGggdG8gYSBidWcgZml4IGhlcmUgZm9yIGlzc3VlICM1NDI2CgkvLyBTZWUgdGhlIGZvbGxvd2luZyBsaW5rIGZvciBpbmZvcm1hdGlvbiBhYm91dCB0aGUgcmVnZXggY2hvc2VuCgkvLyBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9jaHJvbWUvbW9iaWxlL2RvY3MvdXNlci1hZ2VudCNjaHJvbWVfZm9yX2lvc191c2VyLWFnZW50CglwdXNoU3RhdGU6ICJwdXNoU3RhdGUiIGluIGhpc3RvcnkgJiYKCQkicmVwbGFjZVN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJLy8gV2hlbiBydW5uaW5nIGluc2lkZSBhIEZGIGlmcmFtZSwgY2FsbGluZyByZXBsYWNlU3RhdGUgY2F1c2VzIGFuIGVycm9yCgkJISggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkZpcmVmb3giICkgPj0gMCAmJiB3aW5kb3cudG9wICE9PSB3aW5kb3cgKSAmJgoJCSggd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuc2VhcmNoKC9DcmlPUy8pID09PSAtMSApLAoKCW1lZGlhcXVlcnk6ICQubW9iaWxlLm1lZGlhKCAib25seSBhbGwiICksCgljc3NQc2V1ZG9FbGVtZW50OiAhIXByb3BFeGlzdHMoICJjb250ZW50IiApLAoJdG91Y2hPdmVyZmxvdzogISFwcm9wRXhpc3RzKCAib3ZlcmZsb3dTY3JvbGxpbmciICksCgljc3NUcmFuc2Zvcm0zZDogdHJhbnNmb3JtM2RUZXN0KCksCglib3hTaGFkb3c6ICEhcHJvcEV4aXN0cyggImJveFNoYWRvdyIgKSAmJiAhYmIsCglmaXhlZFBvc2l0aW9uOiBmaXhlZFBvc2l0aW9uKCksCglzY3JvbGxUb3A6ICgicGFnZVhPZmZzZXQiIGluIHdpbmRvdyB8fAoJCSJzY3JvbGxUb3AiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fAoJCSJzY3JvbGxUb3AiIGluIGZha2VCb2R5WyAwIF0pICYmICF3ZWJvcyAmJiAhb3BlcmFtaW5pLAoKCWR5bmFtaWNCYXNlVGFnOiBiYXNlVGFnVGVzdCgpLAoJY3NzUG9pbnRlckV2ZW50czogY3NzUG9pbnRlckV2ZW50c1Rlc3QoKSwKCWJvdW5kaW5nUmVjdDogYm91bmRpbmdSZWN0KCkKfSk7CgpmYWtlQm9keS5yZW1vdmUoKTsKCgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCnZhciBub2tpYUxURTdfMyA9IChmdW5jdGlvbigpIHsKCgl2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKCgkvL1RoZSBmb2xsb3dpbmcgaXMgYW4gYXR0ZW1wdCB0byBtYXRjaCBOb2tpYSBicm93c2VycyB0aGF0IGFyZSBydW5uaW5nIFN5bWJpYW4vczYwLCB3aXRoIHdlYmtpdCwgdmVyc2lvbiA3LjMgb3Igb2xkZXIKCXJldHVybiB1YS5pbmRleE9mKCAiTm9raWEiICkgPiAtMSAmJgoJCQkoIHVhLmluZGV4T2YoICJTeW1iaWFuLzMiICkgPiAtMSB8fCB1YS5pbmRleE9mKCAiU2VyaWVzNjAvNSIgKSA+IC0xICkgJiYKCQkJdWEuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEgJiYKCQkJdWEubWF0Y2goIC8oQnJvd3Nlck5HfE5va2lhQnJvd3NlcilcLzdcLlswLTNdLyApOwp9KSgpOwoKLy8gU3VwcG9ydCBjb25kaXRpb25zIHRoYXQgbXVzdCBiZSBtZXQgaW4gb3JkZXIgdG8gcHJvY2VlZAovLyBkZWZhdWx0IGVuaGFuY2VkIHF1YWxpZmljYXRpb25zIGFyZSBtZWRpYSBxdWVyeSBzdXBwb3J0IE9SIElFIDcrCgokLm1vYmlsZS5ncmFkZUEgPSBmdW5jdGlvbigpIHsKCXJldHVybiAoICQuc3VwcG9ydC5tZWRpYXF1ZXJ5IHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA3ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbW9iaWxlLW5vc3VwcG9ydC1ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLCBoaXN0b3J5OwoKCSQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZSA9IHNlbGYgPSB7CgkJYm91bmQ6IGZhbHNlLAoKCQlwdXNoU3RhdGVFbmFibGVkOiB0cnVlLAoKCQlvcmlnaW5hbEV2ZW50TmFtZTogdW5kZWZpbmVkLAoKCQkvLyBJZiBwdXNoc3RhdGUgc3VwcG9ydCBpcyBwcmVzZW50IGFuZCBwdXNoIHN0YXRlIHN1cHBvcnQgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIHRydWUgb24gdGhlIG1vYmlsZSBuYW1lc3BhY2UuCgkJaXNQdXNoU3RhdGVFbmFibGVkOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQuc3VwcG9ydC5wdXNoU3RhdGUgJiYKCQkJCSQubW9iaWxlLnB1c2hTdGF0ZUVuYWJsZWQgPT09IHRydWUgJiYKCQkJCXRoaXMuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpOwoJCX0sCgoJCS8vICEhIGFzc3VtZXMgbW9iaWxlIG5hbWVzcGFjZSBpcyBwcmVzZW50CgkJaXNIYXNoQ2hhbmdlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCA9PT0gdHJ1ZTsKCQl9LAoKCQkvLyBUT0RPIGEgbG90IG9mIGR1cGxpY2F0aW9uIGJldHdlZW4gcG9wc3RhdGUgYW5kIGhhc2hjaGFuZ2UKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApLAoJCQkJc3RhdGUgPSBldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9LAoJCQkJaHJlZiA9IGxvY2F0aW9uLmhyZWY7CgoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiggYmVmb3JlTmF2aWdhdGUuaXNEZWZhdWx0UHJldmVudGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYoIGV2ZW50Lmhpc3RvcnlTdGF0ZSApewoJCQkJJC5leHRlbmQoc3RhdGUsIGV2ZW50Lmhpc3RvcnlTdGF0ZSk7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB0aGUgb3JpZ2luYWwgZXZlbnQgaXMgdHJhY2tlZCBmb3IgdGhlIGVuZAoJCQkvLyB1c2VyIHRvIGluc3BlY3QgaW5jYXNlIHRoZXkgd2FudCB0byBkbyBzb21ldGhpbmcgc3BlY2lhbAoJCQluZXdFdmVudC5vcmlnaW5hbEV2ZW50ID0gZXZlbnQ7CgoJCQkvLyBOT1RFIHdlIGxldCB0aGUgY3VycmVudCBzdGFjayB1bndpbmQgYmVjYXVzZSBhbnkgYXNzaWdubWVudCB0bwoJCQkvLyAgICAgIGxvY2F0aW9uLmhhc2ggd2lsbCBzdG9wIHRoZSB3b3JsZCBhbmQgcnVuIHRoaXMgZXZlbnQgaGFuZGxlci4gQnkKCQkJLy8gICAgICBkb2luZyB0aGlzIHdlIGNyZWF0ZSBhIHNpbWlsYXIgYmVoYXZpb3IgdG8gaGFzaGNoYW5nZSBvbiBoYXNoCgkJCS8vICAgICAgYXNzaWdubWVudAoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJJHdpbi50cmlnZ2VyKCBuZXdFdmVudCwgewoJCQkJCXN0YXRlOiBzdGF0ZQoJCQkJfSk7CgkJCX0sIDApOwoJCX0sCgoJCWhhc2hjaGFuZ2U6IGZ1bmN0aW9uKCBldmVudCwgZGF0YSApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKTsKCgkJCSR3aW4udHJpZ2dlciggYmVmb3JlTmF2aWdhdGUgKTsKCgkJCWlmKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlcyApIHsKCQkJaWYoIHNlbGYuYm91bmQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNlbGYuYm91bmQgPSB0cnVlOwoKCQkJaWYoIHNlbGYuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlzZWxmLm9yaWdpbmFsRXZlbnROYW1lID0gInBvcHN0YXRlIjsKCQkJCSR3aW4uYmluZCggInBvcHN0YXRlLm5hdmlnYXRlIiwgc2VsZi5wb3BzdGF0ZSApOwoJCQl9IGVsc2UgaWYgKCBzZWxmLmlzSGFzaENoYW5nZUVuYWJsZWQoKSApewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsIGRvY3VtZW50QmFzZSwgJGJhc2UsIGRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyI7CgoJCSQubW9iaWxlLnBhdGggPSBwYXRoID0gewoJCQl1aVN0YXRlS2V5OiAiJnVpLXN0YXRlIiwKCgkJCS8vIFRoaXMgc2NhcnkgbG9va2luZyByZWd1bGFyIGV4cHJlc3Npb24gcGFyc2VzIGFuIGFic29sdXRlIFVSTCBvciBpdHMgcmVsYXRpdmUKCQkJLy8gdmFyaWFudHMgKHByb3RvY29sLCBzaXRlLCBkb2N1bWVudCwgcXVlcnksIGFuZCBoYXNoKSwgaW50byB0aGUgdmFyaW91cwoJCQkvLyBjb21wb25lbnRzIChwcm90b2NvbCwgaG9zdCwgcGF0aCwgcXVlcnksIGZyYWdtZW50LCBldGMgdGhhdCBtYWtlIHVwIHRoZQoJCQkvLyBVUkwgYXMgd2VsbCBhcyBzb21lIG90aGVyIGNvbW1vbmx5IHVzZWQgc3ViLXBhcnRzLiBXaGVuIHVzZWQgd2l0aCBSZWdFeHAuZXhlYygpCgkJCS8vIG9yIFN0cmluZy5tYXRjaCwgaXQgcGFyc2VzIHRoZSBVUkwgaW50byBhIHJlc3VsdHMgYXJyYXkgdGhhdCBsb29rcyBsaWtlIHRoaXM6CgkJCS8vCgkJCS8vICAgICBbMF06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveD9tc2c9MTIzNCZ0eXBlPXVucmVhZCNtc2ctY29udGVudAoJCQkvLyAgICAgWzFdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgIFsyXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94CgkJCS8vICAgICBbM106IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgIFs0XTogaHR0cDoKCQkJLy8gICAgIFs1XTogLy8KCQkJLy8gICAgIFs2XTogamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbN106IGpibGFzOnBhc3N3b3JkCgkJCS8vICAgICBbOF06IGpibGFzCgkJCS8vICAgICBbOV06IHBhc3N3b3JkCgkJCS8vICAgIFsxMF06IG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICBbMTFdOiBteWNvbXBhbnkuY29tCgkJCS8vICAgIFsxMl06IDgwODAKCQkJLy8gICAgWzEzXTogL21haWwvaW5ib3gKCQkJLy8gICAgWzE0XTogL21haWwvCgkJCS8vICAgIFsxNV06IGluYm94CgkJCS8vICAgIFsxNl06ID9tc2c9MTIzNCZ0eXBlPXVucmVhZAoJCQkvLyAgICBbMTddOiAjbXNnLWNvbnRlbnQKCQkJLy8KCQkJdXJsUGFyc2VSRTogL15ccyooKCgoW146XC8jXD9dKzopPyg/OihcL1wvKSgoPzooKFteOkBcLyNcP10rKSg/Olw6KFteOkBcLyNcP10rKSk/KUApPygoW146XC8jXD9cXVxbXSt8XFtbXlwvXF1AIz9dK1xdKSg/Olw6KFswLTldKykpPykpPyk/KT8oKFwvPyg/OlteXC9cPyNdK1wvKykqKShbXlw/I10qKSkpPyhcP1teI10rKT8pKCMuKik/LywKCgkJCS8vIEFic3RyYWN0aW9uIHRvIGFkZHJlc3MgeHNzIChJc3N1ZSAjNDc4NykgYnkgcmVtb3ZpbmcgdGhlIGF1dGhvcml0eSBpbgoJCQkvLyBicm93c2VycyB0aGF0IGF1dG8JZGVjb2RlIGl0LiBBbGwgcmVmZXJlbmNlcyB0byBsb2NhdGlvbi5ocmVmIHNob3VsZCBiZQoJCQkvLyByZXBsYWNlZCB3aXRoIGEgY2FsbCB0byB0aGlzIG1ldGhvZCBzbyB0aGF0IGl0IGNhbiBiZSBkZWFsdCB3aXRoIHByb3Blcmx5IGhlcmUKCQkJZ2V0TG9jYXRpb246IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdXJpID0gdXJsID8gdGhpcy5wYXJzZVVybCggdXJsICkgOiBsb2NhdGlvbiwKCQkJCQloYXNoID0gdGhpcy5wYXJzZVVybCggdXJsIHx8IGxvY2F0aW9uLmhyZWYgKS5oYXNoOwoKCQkJCS8vIG1pbWljIHRoZSBicm93c2VyIHdpdGggYW4gZW1wdHkgc3RyaW5nIHdoZW4gdGhlIGhhc2ggaXMgZW1wdHkKCQkJCWhhc2ggPSBoYXNoID09PSAiIyIgPyAiIiA6IGhhc2g7CgoJCQkJLy8gTWFrZSBzdXJlIHRvIHBhcnNlIHRoZSB1cmwgb3IgdGhlIGxvY2F0aW9uIG9iamVjdCBmb3IgdGhlIGhhc2ggYmVjYXVzZSB1c2luZyBsb2NhdGlvbi5oYXNoCgkJCQkvLyBpcyBhdXRvZGVjb2RlZCBpbiBmaXJlZm94LCB0aGUgcmVzdCBvZiB0aGUgdXJsIHNob3VsZCBiZSBmcm9tIHRoZSBvYmplY3QgKGxvY2F0aW9uIHVubGVzcwoJCQkJLy8gd2UncmUgdGVzdGluZykgdG8gYXZvaWQgdGhlIGluY2x1c2lvbiBvZiB0aGUgYXV0aG9yaXR5CgkJCQlyZXR1cm4gdXJpLnByb3RvY29sICsgIi8vIiArIHVyaS5ob3N0ICsgdXJpLnBhdGhuYW1lICsgdXJpLnNlYXJjaCArIGhhc2g7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJdmFyIGFic1N0YWNrID0gYWJzUGF0aCA/IGFic1BhdGguc3BsaXQoICIvIiApIDogW10sCgkJCQkJcmVsU3RhY2sgPSByZWxQYXRoLnNwbGl0KCAiLyIgKTsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IHJlbFN0YWNrLmxlbmd0aDsgaSsrICkgewoJCQkJCXZhciBkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgJycgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgc3RhdGUsIGhyZWYsIGNsZWFuZWRVcmwsIHNlYXJjaCwgc3RhdGVJbmRleCwKCQkJCQlpc1BhdGggPSB0aGlzLmlzUGF0aCggdXJsICksCgkJCQkJdXJpID0gdGhpcy5wYXJzZVVybCggdXJsICksCgkJCQkJcHJlc2VydmVkSGFzaCA9IHVyaS5oYXNoLAoJCQkJCXVpU3RhdGUgPSAiIjsKCgkJCQkvLyBwcm9kdWNlIGEgdXJsIGFnYWluc3Qgd2hpY2ggd2UgY2FuIHJlc29sZSB0aGUgcHJvdmlkZWQgcGF0aAoJCQkJcmVzb2x1dGlvblVybCA9IHJlc29sdXRpb25VcmwgfHwgKHBhdGguaXNQYXRoKHVybCkgPyBwYXRoLmdldExvY2F0aW9uKCkgOiBwYXRoLmdldERvY3VtZW50VXJsKCkpOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYW55dGhpbmcgYnV0IGEgc2ltcGxlIHN0cmluZywgcmVtb3ZlIGFueSBwcmVjZWRpbmcgaGFzaAoJCQkJLy8gZWcgI2Zvby9iYXIgLT4gZm9vL2JhcgoJCQkJLy8gICAgI2ZvbyAtPiAjZm9vCgkJCQljbGVhbmVkVXJsID0gaXNQYXRoID8gcGF0aC5zdHJpcEhhc2goIHVybCApIDogdXJsOwoKCQkJCS8vIElmIHRoZSB1cmwgaXMgYSBmdWxsIHVybCB3aXRoIGEgaGFzaCBjaGVjayBpZiB0aGUgcGFyc2VkIGhhc2ggaXMgYSBwYXRoCgkJCQkvLyBpZiBpdCBpcywgc3RyaXAgdGhlICMsIGFuZCB1c2UgaXQgb3RoZXJ3aXNlIGNvbnRpbnVlIHdpdGhvdXQgY2hhbmdlCgkJCQljbGVhbmVkVXJsID0gcGF0aC5pc1BhdGgoIHVyaS5oYXNoICkgPyBwYXRoLnN0cmlwSGFzaCggdXJpLmhhc2ggKSA6IGNsZWFuZWRVcmw7CgoJCQkJLy8gU3BsaXQgdGhlIFVJIFN0YXRlIGtleXMgb2ZmIHRoZSBocmVmCgkJCQlzdGF0ZUluZGV4ID0gY2xlYW5lZFVybC5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKTsKCgkJCQkvLyBzdG9yZSB0aGUgdWkgc3RhdGUga2V5cyBmb3IgdXNlCgkJCQlpZiggc3RhdGVJbmRleCA+IC0xICl7CgkJCQkJdWlTdGF0ZSA9IGNsZWFuZWRVcmwuc2xpY2UoIHN0YXRlSW5kZXggKTsKCQkJCQljbGVhbmVkVXJsID0gY2xlYW5lZFVybC5zbGljZSggMCwgc3RhdGVJbmRleCApOwoJCQkJfQoKCQkJCS8vIG1ha2UgdGhlIGNsZWFuZWRVcmwgYWJzb2x1dGUgcmVsYXRpdmUgdG8gdGhlIHJlc29sdXRpb24gdXJsCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGNsZWFuZWRVcmwsIHJlc29sdXRpb25VcmwgKTsKCgkJCQkvLyBncmFiIHRoZSBzZWFyY2ggZnJvbSB0aGUgcmVzb2x2ZWQgdXJsIHNpbmNlIHBhcnNpbmcgZnJvbQoJCQkJLy8gdGhlIHBhc3NlZCB1cmwgbWF5IG5vdCB5aWVsZCB0aGUgY29ycmVjdCByZXN1bHQKCQkJCXNlYXJjaCA9IHRoaXMucGFyc2VVcmwoIGhyZWYgKS5zZWFyY2g7CgoJCQkJLy8gVE9ETyBhbGwgdGhpcyBjcmFwIGlzIHRlcnJpYmxlLCBjbGVhbiBpdCB1cAoJCQkJaWYgKCBpc1BhdGggKSB7CgkJCQkJLy8gcmVqZWN0IHRoZSBoYXNoIGlmIGl0J3MgYSBwYXRoIG9yIGl0J3MganVzdCBhIGRpYWxvZyBrZXkKCQkJCQlpZiggcGF0aC5pc1BhdGgoIHByZXNlcnZlZEhhc2ggKSB8fCBwcmVzZXJ2ZWRIYXNoLnJlcGxhY2UoIiMiLCAiIikuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDApIHsKCQkJCQkJcHJlc2VydmVkSGFzaCA9ICIiOwoJCQkJCX0KCgkJCQkJLy8gQXBwZW5kIHRoZSBVSSBTdGF0ZSBrZXlzIHdoZXJlIGl0IGV4aXN0cyBhbmQgaXQncyBiZWVuIHJlbW92ZWQKCQkJCQkvLyBmcm9tIHRoZSB1cmwKCQkJCQlpZiggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSl7CgkJCQkJCXByZXNlcnZlZEhhc2ggKz0gdWlTdGF0ZTsKCQkJCQl9CgoJCQkJCS8vIG1ha2Ugc3VyZSB0aGF0IHBvdW5kIGlzIG9uIHRoZSBmcm9udCBvZiB0aGUgaGFzaAoJCQkJCWlmKCBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoICIjIiApID09PSAtMSAmJiBwcmVzZXJ2ZWRIYXNoICE9PSAiIiApewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQlwYXRoLmdldERvY3VtZW50VXJsID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRVcmwgKSA6IHBhdGguZG9jdW1lbnRVcmwuaHJlZjsKCQl9OwoKCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQlwYXRoLmdldERvY3VtZW50QmFzZSA9IGZ1bmN0aW9uKCBhc1BhcnNlZE9iamVjdCApIHsKCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50QmFzZSApIDogcGF0aC5kb2N1bWVudEJhc2UuaHJlZjsKCQl9Owp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoOwoKCSQubW9iaWxlLkhpc3RvcnkgPSBmdW5jdGlvbiggc3RhY2ssIGluZGV4ICkgewoJCXRoaXMuc3RhY2sgPSBzdGFjayB8fCBbXTsKCQl0aGlzLmFjdGl2ZUluZGV4ID0gaW5kZXggfHwgMDsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuSGlzdG9yeS5wcm90b3R5cGUsIHsKCQlnZXRBY3RpdmU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCBdOwoJCX0sCgoJCWdldExhc3Q6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5wcmV2aW91c0luZGV4IF07CgkJfSwKCgkJZ2V0TmV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4ICsgMSBdOwoJCX0sCgoJCWdldFByZXY6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5zdGFja1sgdGhpcy5hY3RpdmVJbmRleCAtIDEgXTsKCQl9LAoKCQkvLyBhZGROZXcgaXMgdXNlZCB3aGVuZXZlciBhIG5ldyBwYWdlIGlzIGFkZGVkCgkJYWRkOiBmdW5jdGlvbiggdXJsLCBkYXRhICl7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmKCBkYXRhLmhhc2ggJiYgZGF0YS5oYXNoLmluZGV4T2YoICIjIiApID09PSAtMSkgewoJCQkJZGF0YS5oYXNoID0gIiMiICsgZGF0YS5oYXNoOwoJCQl9CgoJCQlkYXRhLnVybCA9IHVybDsKCQkJdGhpcy5zdGFjay5wdXNoKCBkYXRhICk7CgkJCXRoaXMuYWN0aXZlSW5kZXggPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7CgkJfSwKCgkJLy93aXBlIHVybHMgYWhlYWQgb2YgYWN0aXZlIGluZGV4CgkJY2xlYXJGb3J3YXJkOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5zdGFjayA9IHRoaXMuc3RhY2suc2xpY2UoIDAsIHRoaXMuYWN0aXZlSW5kZXggKyAxICk7CgkJfSwKCgkJZmluZDogZnVuY3Rpb24oIHVybCwgc3RhY2ssIGVhcmx5UmV0dXJuICkgewoJCQlzdGFjayA9IHN0YWNrIHx8IHRoaXMuc3RhY2s7CgoJCQl2YXIgZW50cnksIGksIGxlbmd0aCA9IHN0YWNrLmxlbmd0aCwgaW5kZXg7CgoJCQlmb3IgKCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrICkgewoJCQkJZW50cnkgPSBzdGFja1tpXTsKCgkJCQlpZiAoIGRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkudXJsKSB8fAoJCQkJCWRlY29kZVVSSUNvbXBvbmVudCh1cmwpID09PSBkZWNvZGVVUklDb21wb25lbnQoZW50cnkuaGFzaCkgKSB7CgkJCQkJaW5kZXggPSBpOwoKCQkJCQlpZiggZWFybHlSZXR1cm4gKSB7CgkJCQkJCXJldHVybiBpbmRleDsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCXJldHVybiBpbmRleDsKCQl9LAoKCQljbG9zZXN0OiBmdW5jdGlvbiggdXJsICkgewoJCQl2YXIgY2xvc2VzdCwgYSA9IHRoaXMuYWN0aXZlSW5kZXg7CgoJCQkvLyBGaXJzdCwgdGFrZSB0aGUgc2xpY2Ugb2YgdGhlIGhpc3Rvcnkgc3RhY2sgYmVmb3JlIHRoZSBjdXJyZW50IGluZGV4IGFuZCBzZWFyY2gKCQkJLy8gZm9yIGEgdXJsIG1hdGNoLiBJZiBvbmUgaXMgZm91bmQsIHdlJ2xsIGF2b2lkIGF2b2lkIGxvb2tpbmcgdGhyb3VnaCBmb3J3YXJkIGhpc3RvcnkKCQkJLy8gTk9URSB0aGUgcHJlZmVyZW5jZSBmb3IgYmFja3dhcmQgaGlzdG9yeSBtb3ZlbWVudCBpcyBkcml2ZW4gYnkgdGhlIGZhY3QgdGhhdAoJCQkvLyAgICAgIG1vc3QgbW9iaWxlIGJyb3dzZXJzIG9ubHkgaGF2ZSBhIGRlZGljYXRlZCBiYWNrIGJ1dHRvbiwgYW5kIHVzZXJzIHJhcmVseSB1c2UKCQkJLy8gICAgICB0aGUgZm9yd2FyZCBidXR0b24gaW4gZGVza3RvcCBicm93c2VyIGFueWhvdwoJCQljbG9zZXN0ID0gdGhpcy5maW5kKCB1cmwsIHRoaXMuc3RhY2suc2xpY2UoMCwgYSkgKTsKCgkJCS8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGluIGJhY2t3YXJkIGhpc3RvcnkgY2hlY2sgZm9yd2FyZC4gVGhlIGB0cnVlYAoJCQkvLyB2YWx1ZSBwYXNzZWQgYXMgdGhlIHRoaXJkIHBhcmFtZXRlciBjYXVzZXMgdGhlIGZpbmQgbWV0aG9kIHRvIGJyZWFrCgkJCS8vIG9uIHRoZSBmaXJzdCBtYXRjaCBpbiB0aGUgZm9yd2FyZCBoaXN0b3J5IHNsaWNlLiBUaGUgc3RhcnRpbmcgaW5kZXgKCQkJLy8gb2YgdGhlIHNsaWNlIG11c3QgdGhlbiBiZSBhZGRlZCB0byB0aGUgcmVzdWx0IHRvIGdldCB0aGUgZWxlbWVudCBpbmRleAoJCQkvLyBpbiB0aGUgb3JpZ2luYWwgaGlzdG9yeSBzdGFjayA6KCA6KAoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgaHlwZXIgY29uZnVzaW5nIGFuZCBzaG91bGQgYmUgY2xlYW5lZCB1cCAodWdoIHNvIGJhZCkKCQkJaWYoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmKCBuZXdBY3RpdmVJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4OwoJCQkJdGhpcy5wcmV2aW91c0luZGV4ID0gYTsKCQkJfQoKCQkJLy8gaW52b2tlIGNhbGxiYWNrcyB3aGVyZSBhcHByb3ByaWF0ZQoJCQkvLwoJCQkvLyBUT0RPIHRoaXMgaXMgYWxzbyBjb252b2x1dGVkIGFuZCBjb25mdXNpbmcKCQkJaWYgKCBuZXdBY3RpdmVJbmRleCA8IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmJhY2sgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICdiYWNrJyApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA+IGEgKSB7CgkJCQkoIG9wdHMucHJlc2VudCB8fCBvcHRzLmZvcndhcmQgfHwgJC5ub29wICkoIHRoaXMuZ2V0QWN0aXZlKCksICdmb3J3YXJkJyApOwoJCQl9IGVsc2UgaWYgKCBuZXdBY3RpdmVJbmRleCA9PT0gdW5kZWZpbmVkICYmIG9wdHMubWlzc2luZyApewoJCQkJb3B0cy5taXNzaW5nKCB0aGlzLmdldEFjdGl2ZSgpICk7CgkJCX0KCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2g7CgoJCQkvLyBHcmFiIHRoZSBoYXNoIGZvciByZWNvcmRpbmcuIElmIHRoZSBwYXNzZWQgdXJsIGlzIGEgcGF0aAoJCQkvLyB3ZSB1c2VkIHRoZSBwYXJzZWQgdmVyc2lvbiBvZiB0aGUgc3F1YXNoZWQgdXJsIHRvIHJlY29uc3RydWN0LAoJCQkvLyBvdGhlcndpc2Ugd2UgYXNzdW1lIGl0J3MgYSBoYXNoIGFuZCBzdG9yZSBpdCBkaXJlY3RseQoJCQlwYXJzZWQgPSBwYXRoLnBhcnNlVXJsKCB1cmwgKTsKCQkJbG9jID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCQlpZiggbG9jLnBhdGhuYW1lICsgbG9jLnNlYXJjaCA9PT0gcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaCApIHsKCQkJCS8vIElmIHRoZSBwYXRobmFtZSBhbmQgc2VhcmNoIG9mIHRoZSBwYXNzZWQgdXJsIGlzIGlkZW50aWNhbCB0byB0aGUgY3VycmVudCBsb2MKCQkJCS8vIHRoZW4gd2UgbXVzdCB1c2UgdGhlIGhhc2guIE90aGVyd2lzZSB0aGVyZSB3aWxsIGJlIG5vIGV2ZW50CgkJCQkvLyBlZywgdXJsID0gIi9mb28vYmFyP2JheiNiYW5nIiwgbG9jYXRpb24uaHJlZiA9ICJodHRwOi8vZXhhbXBsZS5jb20vZm9vL2Jhcj9iYXoiCgkJCQloYXNoID0gcGFyc2VkLmhhc2ggPyBwYXJzZWQuaGFzaCA6IHBhcnNlZC5wYXRobmFtZSArIHBhcnNlZC5zZWFyY2g7CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNQYXRoKHVybCkgKSB7CgkJCQl2YXIgcmVzb2x2ZWQgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkvLyBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgsIG1ha2UgaXQgZG9tYWluIHJlbGF0aXZlIGFuZCByZW1vdmUgYW55IHRyYWlsaW5nIGhhc2gKCQkJCWhhc2ggPSByZXNvbHZlZC5wYXRobmFtZSArIHJlc29sdmVkLnNlYXJjaCArIChwYXRoLmlzUHJlc2VydmFibGVIYXNoKCByZXNvbHZlZC5oYXNoICk/IHJlc29sdmVkLmhhc2gucmVwbGFjZSggIiMiLCAiIiApIDogIiIpOwoJCQl9IGVsc2UgewoJCQkJaGFzaCA9IHVybDsKCQkJfQoKCQkJcmV0dXJuIGhhc2g7CgkJfSwKCgkJLy8gVE9ETyByZWNvbnNpZGVyIG5hbWUKCQlnbzogZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJCXZhciBzdGF0ZSwgaHJlZiwgaGFzaCwgcG9wc3RhdGVFdmVudCwKCQkJCWlzUG9wU3RhdGVFdmVudCA9ICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKTsKCgkJCS8vIEdldCB0aGUgdXJsIGFzIGl0IHdvdWxkIGxvb2sgc3F1YXNoZWQgb24gdG8gdGhlIGN1cnJlbnQgcmVzb2x1dGlvbiB1cmwKCQkJaHJlZiA9IHBhdGguc3F1YXNoKCB1cmwgKTsKCgkJCS8vIHNvcnQgb3V0IHdoYXQgdGhlIGhhc2ggc291bGQgYmUgZnJvbSB0aGUgdXJsCgkJCWhhc2ggPSB0aGlzLmhhc2goIHVybCwgaHJlZiApOwoKCQkJLy8gSGVyZSB3ZSBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggY2hhbmdlIG9yIHBvcHN0YXRlIGV2ZW50IGZyb20gZG9pbmcgYW55CgkJCS8vIGhpc3RvcnkgbWFuYWdlbWVudC4gSW4gdGhlIGNhc2Ugb2YgaGFzaGNoYW5nZSB3ZSBkb24ndCBzd2FsbG93IGl0CgkJCS8vIGlmIHRoZXJlIHdpbGwgYmUgbm8gaGFzaGNoYW5nZSBmaXJlZCAoc2luY2UgdGhhdCB3b24ndCByZXNldCB0aGUgdmFsdWUpCgkJCS8vIGFuZCB3aWxsIHN3YWxsb3cgdGhlIGZvbGxvd2luZyBoYXNoY2hhbmdlCgkJCWlmKCBub0V2ZW50cyAmJiBoYXNoICE9PSBwYXRoLnN0cmlwSGFzaChwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoKSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gbm9FdmVudHM7CgkJCX0KCgkJCS8vIElNUE9SVEFOVCBpbiB0aGUgY2FzZSB3aGVyZSBwb3BzdGF0ZSBpcyBzdXBwb3J0ZWQgdGhlIGV2ZW50IHdpbGwgYmUgdHJpZ2dlcmVkCgkJCS8vICAgICAgZGlyZWN0bHksIHN0b3BwaW5nIGZ1cnRoZXIgZXhlY3V0aW9uIC0gaWUsIGludGVydXB0aW5nIHRoZSBmbG93IG9mIHRoaXMKCQkJLy8gICAgICBtZXRob2QgY2FsbCB0byBmaXJlIGJpbmRpbmdzIGF0IHRoaXMgZXhwcmVzc2lvbi4gQmVsb3cgdGhlIG5hdmlnYXRlIG1ldGhvZAoJCQkvLyAgICAgIHRoZXJlIGlzIGEgYmluZGluZyB0byBjYXRjaCB0aGlzIGV2ZW50IGFuZCBzdG9wIGl0cyBwcm9wYWdhdGlvbi4KCQkJLy8KCQkJLy8gICAgICBXZSB0aGVuIHRyaWdnZXIgYSBuZXcgcG9wc3RhdGUgZXZlbnQgb24gdGhlIHdpbmRvdyB3aXRoIGEgbnVsbCBzdGF0ZQoJCQkvLyAgICAgIHNvIHRoYXQgdGhlIG5hdmlnYXRlIGV2ZW50cyBjYW4gY29uY2x1ZGUgdGhlaXIgd29yayBwcm9wZXJseQoJCQkvLwoJCQkvLyBpZiB0aGUgdXJsIGlzIGEgcGF0aCB3ZSB3YW50IHRvIHByZXNlcnZlIHRoZSBxdWVyeSBwYXJhbXMgdGhhdCBhcmUgYXZhaWxhYmxlIG9uCgkJCS8vIHRoZSBjdXJyZW50IHVybC4KCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gdHJ1ZTsKCQkJd2luZG93LmxvY2F0aW9uLmhhc2ggPSBoYXNoOwoKCQkJLy8gSWYgcG9wc3RhdGUgaXMgZW5hYmxlZCBhbmQgdGhlIGJyb3dzZXIgdHJpZ2dlcnMgYHBvcHN0YXRlYCBldmVudHMgd2hlbiB0aGUgaGFzaAoJCQkvLyBpcyBzZXQgKHRoaXMgb2Z0ZW4gaGFwcGVucyBpbW1lZGlhdGVseSBpbiBicm93c2VycyBsaWtlIENocm9tZSksIHRoZW4gdGhlCgkJCS8vIHRoaXMgZmxhZyB3aWxsIGJlIHNldCB0byBmYWxzZSBhbHJlYWR5LiBJZiBpdCdzIGEgYnJvd3NlciB0aGF0IGRvZXMgbm90IHRyaWdnZXIKCQkJLy8gYSBgcG9wc3RhdGVgIG9uIGhhc2ggYXNzaWduZW1lbnQgb3IgYHJlcGxhY2VTdGF0ZWAgdGhlbiB3ZSBuZWVkIGF2b2lkIHRoZSBicmFuY2gKCQkJLy8gdGhhdCBzd2FsbG93cyB0aGUgZXZlbnQgY3JlYXRlZCBieSB0aGUgcG9wc3RhdGUgZ2VuZXJhdGVkIGJ5IHRoZSBoYXNoIGFzc2lnbm1lbnQKCQkJLy8gQXQgdGhlIHRpbWUgb2YgdGhpcyB3cml0aW5nIHRoaXMgaGFwcGVucyB3aXRoIE9wZXJhIDEyIGFuZCBzb21lIHZlcnNpb24gb2YgSUUKCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgoJCQlzdGF0ZSA9ICQuZXh0ZW5kKHsKCQkJCXVybDogaHJlZiwKCQkJCWhhc2g6IGhhc2gsCgkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJfSwgZGF0YSk7CgoJCQlpZiggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYoICFub0V2ZW50cyApIHsKCQkJCQl0aGlzLmlnbm9yZVBvcFN0YXRlID0gdHJ1ZTsKCQkJCQkkLm1vYmlsZS53aW5kb3cudHJpZ2dlciggcG9wc3RhdGVFdmVudCApOwoJCQkJfQoJCQl9CgoJCQkvLyByZWNvcmQgdGhlIGhpc3RvcnkgZW50cnkgc28gdGhhdCB0aGUgaW5mb3JtYXRpb24gY2FuIGJlIGluY2x1ZGVkCgkJCS8vIGluIGhhc2hjaGFuZ2UgZXZlbnQgZHJpdmVuIG5hdmlnYXRlIGV2ZW50cyBpbiBhIHNpbWlsYXIgZmFzaGlvbiB0bwoJCQkvLyB0aGUgc3RhdGUgdGhhdCdzIHByb3ZpZGVkIGJ5IHBvcHN0YXRlCgkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCQl9LAoKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgYWN0aXZlLCBoYXNoLCBzdGF0ZSwgY2xvc2VzdEluZGV4OwoKCQkJLy8gUGFydGx5IHRvIHN1cHBvcnQgb3VyIHRlc3Qgc3VpdGUgd2hpY2ggbWFudWFsbHkgYWx0ZXJzIHRoZSBzdXBwb3J0CgkJCS8vIHZhbHVlIHRvIHRlc3QgaGFzaGNoYW5nZS4gUGFydGx5IHRvIHByZXZlbnQgYWxsIGFyb3VuZCB3ZWlyZG5lc3MKCQkJaWYoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKXsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGJ5IHRoZSBhY3R1YWwgYWx0ZXJhdGlvbiBvZiB0aGUgaGFzaAoJCQkvLyBwcmV2ZW50IGl0IGNvbXBsZXRlbHkuIEhpc3RvcnkgaXMgdHJhY2tlZCBtYW51YWxseQoJCQlpZiggdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlICkgewoJCQkJdGhpcy5wcmV2ZW50SGFzaEFzc2lnblBvcFN0YXRlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhpcyBpcyB0aGUgcG9wc3RhdGUgdHJpZ2dlcmVkIGFmdGVyIHRoZSBgcmVwbGFjZVN0YXRlYCBjYWxsIGluIHRoZSBnbwoJCQkvLyBtZXRob2QsIHRoZW4gc2ltcGx5IGlnbm9yZSBpdC4gVGhlIGhpc3RvcnkgZW50cnkgaGFzIGFscmVhZHkgYmVlbiBjYXB0dXJlZAoJCQlpZiggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJgoJCQkJdGhpcy5oaXN0b3J5LnN0YWNrLmxlbmd0aCA9PT0gMSAmJgoJCQkJdGhpcy5pZ25vcmVJbml0aWFsSGFzaENoYW5nZSApIHsKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSBmYWxzZTsKCgkJCQlpZiAoIGxvY2F0aW9uLmhyZWYgPT09IGluaXRpYWxIcmVmICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBhY2NvdW50IGZvciBkaXJlY3QgbWFuaXB1bGF0aW9uIG9mIHRoZSBoYXNoLiBUaGF0IGlzLCB3ZSB3aWxsIHJlY2VpdmUgYSBwb3BzdGF0ZQoJCQkvLyB3aGVuIHRoZSBoYXNoIGlzIGNoYW5nZWQgYnkgYXNzaWdubWVudCwgYW5kIGl0IHdvbid0IGhhdmUgYSBzdGF0ZSBhc3NvY2lhdGVkLiBXZQoJCQkvLyB0aGVuIG5lZWQgdG8gc3F1YXNoIHRoZSBoYXNoLiBTZWUgYmVsb3cgZm9yIGhhbmRsaW5nIG9mIGhhc2ggYXNzaWdubWVudCB0aGF0CgkJCS8vIG1hdGNoZXMgYW4gZXhpc3RpbmcgaGlzdG9yeSBlbnRyeQoJCQkvLyBUT0RPIGl0IG1pZ2h0IGJlIGJldHRlciB0byBvbmx5IGFkZCB0byB0aGUgaGlzdG9yeSBzdGFjawoJCQkvLyAgICAgIHdoZW4gdGhlIGhhc2ggaXMgYWRqYWNlbnQgdG8gdGhlIGFjdGl2ZSBoaXN0b3J5IGVudHJ5CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCQlpZiggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYgaGFzaCApIHsKCQkJCS8vIHNxdWFzaCB0aGUgaGFzaCB0aGF0J3MgYmVlbiBhc3NpZ25lZCBvbiB0aGUgVVJMIHdpdGggcmVwbGFjZVN0YXRlCgkJCQkvLyBhbHNvIGdyYWIgdGhlIHJlc3VsdGluZyBzdGF0ZSBvYmplY3QgZm9yIHN0b3JhZ2UKCQkJCXN0YXRlID0gdGhpcy5zcXVhc2goIGhhc2ggKTsKCgkJCQkvLyByZWNvcmQgdGhlIG5ldyBoYXNoIGFzIGFuIGFkZGl0aW9uYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gdG8gbWF0Y2ggdGhlIGJyb3dzZXIncyB0cmVhdG1lbnQgb2YgaGFzaCBhc3NpZ25tZW50CgkJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgoJCQkJLy8gcGFzcyB0aGUgbmV3bHkgY3JlYXRlZCBzdGF0ZSBpbmZvcm1hdGlvbgoJCQkJLy8gYWxvbmcgd2l0aCB0aGUgZXZlbnQKCQkJCWV2ZW50Lmhpc3RvcnlTdGF0ZSA9IHN0YXRlOwoKCQkJCS8vIGRvIG5vdCBhbHRlciBoaXN0b3J5LCB3ZSd2ZSBhZGRlZCBhIG5ldyBoaXN0b3J5IGVudHJ5CgkJCQkvLyBzbyB3ZSBrbm93IHdoZXJlIHdlIGFyZQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBJZiBhbGwgZWxzZSBmYWlscyB0aGlzIGlzIGEgcG9wc3RhdGUgdGhhdCBjb21lcyBmcm9tIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9ucwoJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IHRoZSBzdGF0ZSBvZiBvdXIgaGlzdG9yeSBzdGFjayBwcm9wZXJseSwgYW5kIHJlY29yZCB0aGUgZGlyZWN0aW9uYWxpdHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IChldmVudC5vcmlnaW5hbEV2ZW50LnN0YXRlIHx8IHt9KS51cmwgfHwgaGFzaCwKCgkJCQkvLyBXaGVuIHRoZSB1cmwgaXMgZWl0aGVyIGZvcndhcmQgb3IgYmFja3dhcmQgaW4gaGlzdG9yeSBpbmNsdWRlIHRoZSBlbnRyeQoJCQkJLy8gYXMgZGF0YSBvbiB0aGUgZXZlbnQgb2JqZWN0IGZvciBtZXJnaW5nIGFzIGRhdGEgaW4gdGhlIG5hdmlnYXRlIGV2ZW50CgkJCQlwcmVzZW50OiBmdW5jdGlvbiggaGlzdG9yeUVudHJ5LCBkaXJlY3Rpb24gKSB7CgkJCQkJLy8gbWFrZSBzdXJlIHRvIGNyZWF0ZSBhIG5ldyBvYmplY3QgdG8gcGFzcyBkb3duIGFzIHRoZSBuYXZpZ2F0ZSBldmVudCBkYXRhCgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gJC5leHRlbmQoe30sIGhpc3RvcnlFbnRyeSk7CgkJCQkJZXZlbnQuaGlzdG9yeVN0YXRlLmRpcmVjdGlvbiA9IGRpcmVjdGlvbjsKCQkJCX0KCQkJfSk7CgkJfSwKCgkJLy8gTk9URSBtdXN0IGJpbmQgYmVmb3JlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudCBoYXNoY2hhbmdlIGJpbmRpbmcgb3RoZXJ3aXNlIHRoZQoJCS8vICAgICAgbmF2aWdhdGlvbiBkYXRhIHdvbid0IGJlIGF0dGFjaGVkIHRvIHRoZSBoYXNoY2hhbmdlIGV2ZW50IGluIHRpbWUgZm9yIHRob3NlCgkJLy8gICAgICBiaW5kaW5ncyB0byBhdHRhY2ggaXQgdG8gdGhlIGBuYXZpZ2F0ZWAgc3BlY2lhbCBldmVudAoJCS8vIFRPRE8gYWRkIGEgY2hlY2sgaGVyZSB0aGF0IGBoYXNoY2hhbmdlLm5hdmlnYXRlYCBpcyBib3VuZCBhbHJlYWR5IG90aGVyd2lzZSBpdCdzCgkJLy8gICAgICBicm9rZW4gKGV4Y2VwdGlvbj8pCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGlzdG9yeSwgaGFzaDsKCgkJCS8vIElmIGhhc2hjaGFuZ2UgbGlzdGVuaW5nIGlzIGV4cGxpY2l0bHkgZGlzYWJsZWQgb3IgcHVzaHN0YXRlIGlzIHN1cHBvcnRlZAoJCQkvLyBhdm9pZCBtYWtpbmcgdXNlIG9mIHRoZSBoYXNoY2hhbmdlIGhhbmRsZXIuCgkJCWlmKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYoIHRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlICl7CgkJCQl0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSA9IGZhbHNlOwoJCQkJZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWhpc3RvcnkgPSB0aGlzLmhpc3Rvcnk7CgkJCWhhc2ggPSBwYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoKCQkJLy8gSWYgdGhpcyBpcyBhIGhhc2hjaGFuZ2UgY2F1c2VkIGJ5IHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5CgkJCXRoaXMuaGlzdG9yeS5kaXJlY3QoewoJCQkJdXJsOiBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oYXNoY2hhbmdlU3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfSwKCgkJCQkvLyBXaGVuIHdlIGRvbid0IGZpbmQgYSBoYXNoIGluIG91ciBoaXN0b3J5IGNsZWFybHkgd2UncmUgYWltaW5nIHRvIGdvIHRoZXJlCgkJCQkvLyByZWNvcmQgdGhlIGVudHJ5IGFzIG5ldyBmb3IgZnV0dXJlIHRyYXZlcnNhbAoJCQkJLy8KCQkJCS8vIE5PVEUgaXQncyBub3QgZW50aXJlbHkgY2xlYXIgdGhhdCB0aGlzIGlzIHRoZSByaWdodCB0aGluZyB0byBkbyBnaXZlbiB0aGF0IHdlCgkJCQkvLyAgICAgIGNhbid0IGtub3cgdGhlIHVzZXJzIGludGVudGlvbi4gSXQgbWlnaHQgYmUgYmV0dGVyIHRvIGV4cGxpY2l0bHkgX25vdF8KCQkJCS8vICAgICAgc3VwcG9ydCBsb2NhdGlvbi5oYXNoIGFzc2lnbm1lbnQgaW4gcHJlZmVyZW5jZSB0byAkLm5hdmlnYXRlIGNhbGxzCgkJCQkvLyBUT0RPIGZpcnN0IGFyZyB0byBhZGQgc2hvdWxkIGJlIHRoZSBocmVmLCBidXQgaXQgY2F1c2VzIGlzc3VlcyBpbiBpZGVudGlmeWluZwoJCQkJLy8gICAgICBlbWJlZGVkIHBhZ2VzCgkJCQltaXNzaW5nOiBmdW5jdGlvbigpIHsKCQkJCQloaXN0b3J5LmFkZCggaGFzaCwgewoJCQkJCQloYXNoOiBoYXNoLAoJCQkJCQl0aXRsZTogZG9jdW1lbnQudGl0bGUKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkvLyBUT0RPIGNvbnNpZGVyIHF1ZXVlaW5nIG5hdmlnYXRpb24gYWN0aXZpdHkgdW50aWwgcHJldmlvdXMgYWN0aXZpdGllcyBoYXZlIGNvbXBsZXRlZAoJLy8gICAgICBzbyB0aGF0IGVuZCB1c2VycyBkb24ndCBoYXZlIHRvIHRoaW5rIGFib3V0IGl0LiBQdW50aW5nIGZvciBub3cKCS8vIFRPRE8gISEgbW92ZSB0aGUgZXZlbnQgYmluZGluZ3MgaW50byBjYWxsYmFja3Mgb24gdGhlIG5hdmlnYXRlIGV2ZW50CgkkLm1vYmlsZS5uYXZpZ2F0ZSA9IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5nbyggdXJsLCBkYXRhLCBub0V2ZW50cyApOwoJfTsKCgkvLyBleHBvc2UgdGhlIGhpc3Rvcnkgb24gdGhlIG5hdmlnYXRlIG1ldGhvZCBpbiBhbnRpY2lwYXRpb24gb2YgZnVsbCBpbnRlZ3JhdGlvbiB3aXRoCgkvLyBleGlzdGluZyBuYXZpZ2F0aW9uIGZ1bmN0aW9uYWx0eSB0aGF0IGlzIHRpZ2h0bHkgY291cGxlZCB0byB0aGUgaGlzdG9yeSBpbmZvcm1hdGlvbgoJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSA9IG5ldyAkLm1vYmlsZS5IaXN0b3J5KCk7CgoJLy8gaW5zdGFudGlhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIG5hdmlnYXRvciBmb3IgdXNlIHdpdGhpbiB0aGUgJC5uYXZpZ2F0ZSBtZXRob2QKCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvciA9IG5ldyAkLm1vYmlsZS5OYXZpZ2F0b3IoICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkgKTsKCgl2YXIgbG9jID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCk7CgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFkZCggbG9jLmhyZWYsIHtoYXNoOiBsb2MuaGFzaH0gKTsKfSkoIGpRdWVyeSApOwoKCi8vIFRoaXMgcGx1Z2luIGlzIGFuIGV4cGVyaW1lbnQgZm9yIGFic3RyYWN0aW5nIGF3YXkgdGhlIHRvdWNoIGFuZCBtb3VzZQovLyBldmVudHMgc28gdGhhdCBkZXZlbG9wZXJzIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgd2hpY2ggbWV0aG9kIG9mIGlucHV0Ci8vIHRoZSBkZXZpY2UgdGhlaXIgZG9jdW1lbnQgaXMgbG9hZGVkIG9uIHN1cHBvcnRzLgovLwovLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGFsbG93IHRoZSBkZXZlbG9wZXIgdG8gcmVnaXN0ZXIgbGlzdGVuZXJzIGZvciB0aGUKLy8gYmFzaWMgbW91c2UgZXZlbnRzLCBzdWNoIGFzIG1vdXNlZG93biwgbW91c2Vtb3ZlLCBtb3VzZXVwLCBhbmQgY2xpY2ssCi8vIGFuZCB0aGUgcGx1Z2luIHdpbGwgdGFrZSBjYXJlIG9mIHJlZ2lzdGVyaW5nIHRoZSBjb3JyZWN0IGxpc3RlbmVycwovLyBiZWhpbmQgdGhlIHNjZW5lcyB0byBpbnZva2UgdGhlIGxpc3RlbmVyIGF0IHRoZSBmYXN0ZXN0IHBvc3NpYmxlIHRpbWUKLy8gZm9yIHRoYXQgZGV2aWNlLCB3aGlsZSBzdGlsbCByZXRhaW5pbmcgdGhlIG9yZGVyIG9mIGV2ZW50IGZpcmluZyBpbgovLyB0aGUgdHJhZGl0aW9uYWwgbW91c2UgZW52aXJvbm1lbnQsIHNob3VsZCBtdWx0aXBsZSBoYW5kbGVycyBiZSByZWdpc3RlcmVkCi8vIG9uIHRoZSBzYW1lIGVsZW1lbnQgZm9yIGRpZmZlcmVudCBldmVudHMuCi8vCi8vIFRoZSBjdXJyZW50IHZlcnNpb24gZXhwb3NlcyB0aGUgZm9sbG93aW5nIHZpcnR1YWwgZXZlbnRzIHRvIGpRdWVyeSBiaW5kIG1ldGhvZHM6Ci8vICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIKCihmdW5jdGlvbiggJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewoKdmFyIGRhdGFQcm9wZXJ0eU5hbWUgPSAidmlydHVhbE1vdXNlQmluZGluZ3MiLAoJdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUgPSAidmlydHVhbFRvdWNoSUQiLAoJdmlydHVhbEV2ZW50TmFtZXMgPSAidm1vdXNlb3ZlciB2bW91c2Vkb3duIHZtb3VzZW1vdmUgdm1vdXNldXAgdmNsaWNrIHZtb3VzZW91dCB2bW91c2VjYW5jZWwiLnNwbGl0KCAiICIgKSwKCXRvdWNoRXZlbnRQcm9wcyA9ICJjbGllbnRYIGNsaWVudFkgcGFnZVggcGFnZVkgc2NyZWVuWCBzY3JlZW5ZIi5zcGxpdCggIiAiICksCgltb3VzZUhvb2tQcm9wcyA9ICQuZXZlbnQubW91c2VIb29rcyA/ICQuZXZlbnQubW91c2VIb29rcy5wcm9wcyA6IFtdLAoJbW91c2VFdmVudFByb3BzID0gJC5ldmVudC5wcm9wcy5jb25jYXQoIG1vdXNlSG9va1Byb3BzICksCglhY3RpdmVEb2NIYW5kbGVycyA9IHt9LAoJcmVzZXRUaW1lcklEID0gMCwKCXN0YXJ0WCA9IDAsCglzdGFydFkgPSAwLAoJZGlkU2Nyb2xsID0gZmFsc2UsCgljbGlja0Jsb2NrTGlzdCA9IFtdLAoJYmxvY2tNb3VzZVRyaWdnZXJzID0gZmFsc2UsCglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZSwKCWV2ZW50Q2FwdHVyZVN1cHBvcnRlZCA9ICJhZGRFdmVudExpc3RlbmVyIiBpbiBkb2N1bWVudCwKCSRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICksCgluZXh0VG91Y2hJRCA9IDEsCglsYXN0VG91Y2hJRCA9IDAsIHRocmVzaG9sZDsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICk7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmFyIHZlID0gdHJpZ2dlclZpcnR1YWxFdmVudCggInYiICsgZXZlbnQudHlwZSwgZXZlbnQgKTsKCQlpZiAoIHZlICkgewoJCQlpZiAoIHZlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCQlpZiAoIHZlLmlzUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJfQoJCQlpZiAoIHZlLmlzSW1tZWRpYXRlUHJvcGFnYXRpb25TdG9wcGVkKCkgKSB7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJfQoJCX0KCX0KfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCggZXZlbnQgKSB7CgoJdmFyIHRvdWNoZXMgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzLAoJCXRhcmdldCwgZmxhZ3M7CgoJaWYgKCB0b3VjaGVzICYmIHRvdWNoZXMubGVuZ3RoID09PSAxICkgewoKCQl0YXJnZXQgPSBldmVudC50YXJnZXQ7CgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCB0YXJnZXQgKTsKCgkJaWYgKCBmbGFncy5oYXNWaXJ0dWFsQmluZGluZyApIHsKCgkJCWxhc3RUb3VjaElEID0gbmV4dFRvdWNoSUQrKzsKCQkJJC5kYXRhKCB0YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lLCBsYXN0VG91Y2hJRCApOwoKCQkJY2xlYXJSZXNldFRpbWVyKCk7CgoJCQlkaXNhYmxlTW91c2VCaW5kaW5ncygpOwoJCQlkaWRTY3JvbGwgPSBmYWxzZTsKCgkJCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdOwoJCQlzdGFydFggPSB0LnBhZ2VYOwoJCQlzdGFydFkgPSB0LnBhZ2VZOwoKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZW92ZXIiLCBldmVudCwgZmxhZ3MgKTsKCQkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWRvd24iLCBldmVudCwgZmxhZ3MgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGhhbmRsZVNjcm9sbCggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJaWYgKCAhZGlkU2Nyb2xsICkgewoJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VjYW5jZWwiLCBldmVudCwgZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICkgKTsKCX0KCglkaWRTY3JvbGwgPSB0cnVlOwoJc3RhcnRSZXNldFRpbWVyKCk7Cn0KCmZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSggZXZlbnQgKSB7CglpZiAoIGJsb2NrVG91Y2hUcmlnZ2VycyApIHsKCQlyZXR1cm47Cgl9CgoJdmFyIHQgPSBnZXROYXRpdmVFdmVudCggZXZlbnQgKS50b3VjaGVzWyAwIF0sCgkJZGlkQ2FuY2VsID0gZGlkU2Nyb2xsLAoJCW1vdmVUaHJlc2hvbGQgPSAkLnZtb3VzZS5tb3ZlRGlzdGFuY2VUaHJlc2hvbGQsCgkJZmxhZ3MgPSBnZXRWaXJ0dWFsQmluZGluZ0ZsYWdzKCBldmVudC50YXJnZXQgKTsKCgkJZGlkU2Nyb2xsID0gZGlkU2Nyb2xsIHx8CgkJCSggTWF0aC5hYnMoIHQucGFnZVggLSBzdGFydFggKSA+IG1vdmVUaHJlc2hvbGQgfHwKCQkJCU1hdGguYWJzKCB0LnBhZ2VZIC0gc3RhcnRZICkgPiBtb3ZlVGhyZXNob2xkICk7CgoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdDsKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2V1cCIsIGV2ZW50LCBmbGFncyApOwoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl2YXIgdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbiggZGF0YSwgbmFtZXNwYWNlICkgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBmaXJzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgZm9yIHRoaXMgZWxlbWVudCwKCQkJLy8gYWRkIGEgYmluZGluZ3Mgb2JqZWN0IHRvIGl0cyBkYXRhLgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUsIHt9ICk7CgkJCX0KCgkJCS8vIElmIHNldHVwIGlzIGNhbGxlZCwgd2Uga25vdyBpdCBpcyB0aGUgZmlyc3QgYmluZGluZyBmb3IgdGhpcwoJCQkvLyBldmVudFR5cGUsIHNvIGluaXRpYWxpemUgdGhlIGNvdW50IGZvciB0aGUgZXZlbnRUeXBlIHRvIHplcm8uCgkJCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggdGhpcywgZGF0YVByb3BlcnR5TmFtZSApOwoJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSB0cnVlOwoKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBldmVudCBmb3IgdGhpcyB0eXBlLAoJCQkvLyByZWdpc3RlciBhIGdsb2JhbCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9ICggYWN0aXZlRG9jSGFuZGxlcnNbIGV2ZW50VHlwZSBdIHx8IDAgKSArIDE7CgoJCQlpZiAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSA9PT0gMSApIHsKCQkJCSRkb2N1bWVudC5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCS8vIFNvbWUgYnJvd3NlcnMsIGxpa2UgT3BlcmEgTWluaSwgd29uJ3QgZGlzcGF0Y2ggbW91c2UvY2xpY2sgZXZlbnRzCgkJCS8vIGZvciBlbGVtZW50cyB1bmxlc3MgdGhleSBhY3R1YWxseSBoYXZlIGhhbmRsZXJzIHJlZ2lzdGVyZWQgb24gdGhlbS4KCQkJLy8gVG8gZ2V0IGFyb3VuZCB0aGlzLCB3ZSByZWdpc3RlciBkdW1teSBoYW5kbGVycyBvbiB0aGUgZWxlbWVudHMuCgoJCQkkKCB0aGlzICkuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBGb3Igbm93LCBpZiBldmVudCBjYXB0dXJlIGlzIG5vdCBzdXBwb3J0ZWQsIHdlIHJlbHkgb24gbW91c2UgaGFuZGxlcnMuCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGUgZG9jdW1lbnQsCgkJCQkvLyByZWdpc3RlciBvdXIgdG91Y2hzdGFydCBoYW5kbGVyIG9uIHRoZSBkb2N1bWVudC4KCgkJCQlhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSB8fCAwKSArIDE7CgoJCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gPT09IDEgKSB7CgkJCQkJJGRvY3VtZW50LmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgoJCQkJCQkvLyBPbiB0b3VjaCBwbGF0Zm9ybXMsIHRvdWNoaW5nIHRoZSBzY3JlZW4gYW5kIHRoZW4gZHJhZ2dpbmcgeW91ciBmaW5nZXIKCQkJCQkJLy8gY2F1c2VzIHRoZSB3aW5kb3cgY29udGVudCB0byBzY3JvbGwgYWZ0ZXIgc29tZSBkaXN0YW5jZSB0aHJlc2hvbGQgaXMKCQkJCQkJLy8gZXhjZWVkZWQuIE9uIHRoZXNlIHBsYXRmb3JtcywgYSBzY3JvbGwgcHJldmVudHMgYSBjbGljayBldmVudCBmcm9tIGJlaW5nCgkJCQkJCS8vIGRpc3BhdGNoZWQsIGFuZCBvbiBzb21lIHBsYXRmb3JtcywgZXZlbiB0aGUgdG91Y2hlbmQgaXMgc3VwcHJlc3NlZC4gVG8KCQkJCQkJLy8gbWltaWMgdGhlIHN1cHByZXNzaW9uIG9mIHRoZSBjbGljayBldmVudCwgd2UgbmVlZCB0byB3YXRjaCBmb3IgYSBzY3JvbGwKCQkJCQkJLy8gZXZlbnQuIFVuZm9ydHVuYXRlbHksIHNvbWUgcGxhdGZvcm1zIGxpa2UgaU9TIGRvbid0IGRpc3BhdGNoIHNjcm9sbAoJCQkJCQkvLyBldmVudHMgdW50aWwgKkFGVEVSKiB0aGUgdXNlciBsaWZ0cyB0aGVpciBmaW5nZXIgKHRvdWNoZW5kKS4gVGhpcyBtZWFucwoJCQkJCQkvLyB3ZSBuZWVkIHRvIHdhdGNoIGJvdGggc2Nyb2xsIGFuZCB0b3VjaG1vdmUgZXZlbnRzIHRvIGZpZ3VyZSBvdXQgd2hldGhlcgoJCQkJCQkvLyBvciBub3QgYSBzY3JvbGwgaGFwcGVuZW5zIGJlZm9yZSB0aGUgdG91Y2hlbmQgZXZlbnQgaXMgZmlyZWQuCgoJCQkJCQkuYmluZCggInRvdWNobW92ZSIsIGhhbmRsZVRvdWNoTW92ZSApCgkJCQkJCS5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCQl9LAoKCQl0ZWFyZG93bjogZnVuY3Rpb24oIGRhdGEsIG5hbWVzcGFjZSApIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIGJpbmRpbmcgZm9yIHRoaXMgZXZlbnRUeXBlLAoJCQkvLyByZW1vdmUgaXRzIGdsb2JhbCBoYW5kbGVyIGZyb20gdGhlIGRvY3VtZW50LgoKCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF07CgoJCQlpZiAoICFhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gKSB7CgkJCQkkZG9jdW1lbnQudW5iaW5kKCByZWFsVHlwZSwgbW91c2VFdmVudENhbGxiYWNrICk7CgkJCX0KCgkJCWlmICggZXZlbnRDYXB0dXJlU3VwcG9ydGVkICkgewoJCQkJLy8gSWYgdGhpcyBpcyB0aGUgbGFzdCB2aXJ0dWFsIG1vdXNlIGJpbmRpbmcgaW4gZXhpc3RlbmNlLAoJCQkJLy8gcmVtb3ZlIG91ciBkb2N1bWVudCB0b3VjaHN0YXJ0IGxpc3RlbmVyLgoKCQkJCS0tYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdOwoKCQkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyAidG91Y2hzdGFydCIgXSApIHsKCQkJCQkkZG9jdW1lbnQudW5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkudW5iaW5kKCAidG91Y2htb3ZlIiwgaGFuZGxlVG91Y2hNb3ZlICkKCQkJCQkJLnVuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoJCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgaGFuZGxlU2Nyb2xsICk7CgkJCQl9CgkJCX0KCgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCWJpbmRpbmdzID0gJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lICk7CgoJCQkvLyB0ZWFyZG93biBtYXkgYmUgY2FsbGVkIHdoZW4gYW4gZWxlbWVudCB3YXMKCQkJLy8gcmVtb3ZlZCBmcm9tIHRoZSBET00uIElmIHRoaXMgaXMgdGhlIGNhc2UsCgkJCS8vIGpRdWVyeSBjb3JlIG1heSBoYXZlIGFscmVhZHkgc3RyaXBwZWQgdGhlIGVsZW1lbnQKCQkJLy8gb2YgYW55IGRhdGEgYmluZGluZ3Mgc28gd2UgbmVlZCB0byBjaGVjayBpdCBiZWZvcmUKCQkJLy8gdXNpbmcgaXQuCgkJCWlmICggYmluZGluZ3MgKSB7CgkJCQliaW5kaW5nc1sgZXZlbnRUeXBlIF0gPSBmYWxzZTsKCQkJfQoKCQkJLy8gVW5yZWdpc3RlciB0aGUgZHVtbXkgZXZlbnQgaGFuZGxlci4KCgkJCSR0aGlzLnVuYmluZCggcmVhbFR5cGUsIGR1bW15TW91c2VIYW5kbGVyICk7CgoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBvbiB0aGUKCQkJLy8gZWxlbWVudCwgcmVtb3ZlIHRoZSBiaW5kaW5nIGRhdGEgZnJvbSB0aGUgZWxlbWVudC4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJHRoaXMucmVtb3ZlRGF0YSggZGF0YVByb3BlcnR5TmFtZSApOwoJCQl9CgkJfQoJfTsKfQoKLy8gRXhwb3NlIG91ciBjdXN0b20gZXZlbnRzIHRvIHRoZSBqUXVlcnkgYmluZC91bmJpbmQgbWVjaGFuaXNtLgoKZm9yICggdmFyIGkgPSAwOyBpIDwgdmlydHVhbEV2ZW50TmFtZXMubGVuZ3RoOyBpKysgKSB7CgkkLmV2ZW50LnNwZWNpYWxbIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gXSA9IGdldFNwZWNpYWxFdmVudE9iamVjdCggdmlydHVhbEV2ZW50TmFtZXNbIGkgXSApOwp9CgovLyBBZGQgYSBjYXB0dXJlIGNsaWNrIGhhbmRsZXIgdG8gYmxvY2sgY2xpY2tzLgovLyBOb3RlIHRoYXQgd2UgcmVxdWlyZSBldmVudCBjYXB0dXJlIHN1cHBvcnQgZm9yIHRoaXMgc28gaWYgdGhlIGRldmljZQovLyBkb2Vzbid0IHN1cHBvcnQgaXQsIHdlIHB1bnQgZm9yIG5vdyBhbmQgcmVseSBzb2xlbHkgb24gbW91c2UgZXZlbnRzLgppZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoICJjbGljayIsIGZ1bmN0aW9uKCBlICkgewoJCXZhciBjbnQgPSBjbGlja0Jsb2NrTGlzdC5sZW5ndGgsCgkJCXRhcmdldCA9IGUudGFyZ2V0LAoJCQl4LCB5LCBlbGUsIGksIG8sIHRvdWNoSUQ7CgoJCWlmICggY250ICkgewoJCQl4ID0gZS5jbGllbnRYOwoJCQl5ID0gZS5jbGllbnRZOwoJCQl0aHJlc2hvbGQgPSAkLnZtb3VzZS5jbGlja0Rpc3RhbmNlVGhyZXNob2xkOwoKCQkJLy8gVGhlIGlkZWEgaGVyZSBpcyB0byBydW4gdGhyb3VnaCB0aGUgY2xpY2tCbG9ja0xpc3QgdG8gc2VlIGlmCgkJCS8vIHRoZSBjdXJyZW50IGNsaWNrIGV2ZW50IGlzIGluIHRoZSBwcm94aW1pdHkgb2Ygb25lIG9mIG91cgoJCQkvLyB2Y2xpY2sgZXZlbnRzIHRoYXQgaGFkIHByZXZlbnREZWZhdWx0KCkgY2FsbGVkIG9uIGl0LiBJZiB3ZSBmaW5kCgkJCS8vIG9uZSwgdGhlbiB3ZSBibG9jayB0aGUgY2xpY2suCgkJCS8vCgkJCS8vIFdoeSBkbyB3ZSBoYXZlIHRvIHJlbHkgb24gcHJveGltaXR5PwoJCQkvLwoJCQkvLyBCZWNhdXNlIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoIGV2ZW50IHRoYXQgdHJpZ2dlcmVkIHRoZSB2Y2xpY2sKCQkJLy8gY2FuIGJlIGRpZmZlcmVudCBmcm9tIHRoZSB0YXJnZXQgb2YgdGhlIGNsaWNrIGV2ZW50IHN5bnRoZXNpemVkCgkJCS8vIGJ5IHRoZSBicm93c2VyLiBUaGUgdGFyZ2V0IG9mIGEgbW91c2UvY2xpY2sgZXZlbnQgdGhhdCBpcyBzeW50ZWhzaXplZAoJCQkvLyBmcm9tIGEgdG91Y2ggZXZlbnQgc2VlbXMgdG8gYmUgaW1wbGVtZW50YXRpb24gc3BlY2lmaWMuIEZvciBleGFtcGxlLAoJCQkvLyBzb21lIGJyb3dzZXJzIHdpbGwgZmlyZSBtb3VzZS9jbGljayBldmVudHMgZm9yIGEgbGluayB0aGF0IGlzIG5lYXIKCQkJLy8gYSB0b3VjaCBldmVudCwgZXZlbiB0aG91Z2ggdGhlIHRhcmdldCBvZiB0aGUgdG91Y2hzdGFydC90b3VjaGVuZCBldmVudAoJCQkvLyBzYXlzIHRoZSB1c2VyIHRvdWNoZWQgb3V0c2lkZSB0aGUgbGluay4gQWxzbywgaXQgc2VlbXMgdGhhdCB3aXRoIG1vc3QKCQkJLy8gYnJvd3NlcnMsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIGV2ZW50IGlzIG5vdCBjYWxjdWxhdGVkIHVudGlsIHRoZQoJCQkvLyB0aW1lIGl0IGlzIGRpc3BhdGNoZWQsIHNvIGlmIHlvdSByZXBsYWNlIGFuIGVsZW1lbnQgdGhhdCB5b3UgdG91Y2hlZAoJCQkvLyB3aXRoIGFub3RoZXIgZWxlbWVudCwgdGhlIHRhcmdldCBvZiB0aGUgbW91c2UvY2xpY2sgd2lsbCBiZSB0aGUgbmV3CgkJCS8vIGVsZW1lbnQgdW5kZXJuZWF0aCB0aGF0IHBvaW50LgoJCQkvLwoJCQkvLyBBc2lkZSBmcm9tIHByb3hpbWl0eSwgd2UgYWxzbyBjaGVjayB0byBzZWUgaWYgdGhlIHRhcmdldCBhbmQgYW55CgkJCS8vIG9mIGl0cyBhbmNlc3RvcnMgd2VyZSB0aGUgb25lcyB0aGF0IGJsb2NrZWQgYSBjbGljay4gVGhpcyBpcyBuZWNlc3NhcnkKCQkJLy8gYmVjYXVzZSBvZiB0aGUgc3RyYW5nZSBtb3VzZS9jbGljayB0YXJnZXQgY2FsY3VsYXRpb24gZG9uZSBpbiB0aGUKCQkJLy8gQW5kcm9pZCAyLjEgYnJvd3Nlciwgd2hlcmUgaWYgeW91IGNsaWNrIG9uIGFuIGVsZW1lbnQsIGFuZCB0aGVyZSBpcyBhCgkJCS8vIG1vdXNlL2NsaWNrIGhhbmRsZXIgb24gb25lIG9mIGl0cyBhbmNlc3RvcnMsIHRoZSB0YXJnZXQgd2lsbCBiZSB0aGUKCQkJLy8gaW5uZXJtb3N0IGNoaWxkIG9mIHRoZSB0b3VjaGVkIGVsZW1lbnQsIGV2ZW4gaWYgdGhhdCBjaGlsZCBpcyBubyB3aGVyZQoJCQkvLyBuZWFyIHRoZSBwb2ludCBvZiB0b3VjaC4KCgkJCWVsZSA9IHRhcmdldDsKCgkJCXdoaWxlICggZWxlICkgewoJCQkJZm9yICggaSA9IDA7IGkgPCBjbnQ7IGkrKyApIHsKCQkJCQlvID0gY2xpY2tCbG9ja0xpc3RbIGkgXTsKCQkJCQl0b3VjaElEID0gMDsKCgkJCQkJaWYgKCAoIGVsZSA9PT0gdGFyZ2V0ICYmIE1hdGguYWJzKCBvLnggLSB4ICkgPCB0aHJlc2hvbGQgJiYgTWF0aC5hYnMoIG8ueSAtIHkgKSA8IHRocmVzaG9sZCApIHx8CgkJCQkJCQkJJC5kYXRhKCBlbGUsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICkgPT09IG8udG91Y2hJRCApIHsKCQkJCQkJLy8gWFhYOiBXZSBtYXkgd2FudCB0byBjb25zaWRlciByZW1vdmluZyBtYXRjaGVzIGZyb20gdGhlIGJsb2NrIGxpc3QKCQkJCQkJLy8gICAgICBpbnN0ZWFkIG9mIHdhaXRpbmcgZm9yIHRoZSByZXNldCB0aW1lciB0byBmaXJlLgoJCQkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQkJCWUuc3RvcFByb3BhZ2F0aW9uKCk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgkJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQkJfQoJCX0KCX0sIHRydWUpOwp9Cn0pKCBqUXVlcnksIHdpbmRvdywgZG9jdW1lbnQgKTsKCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyICRkb2N1bWVudCA9ICQoIGRvY3VtZW50ICk7CgoJLy8gYWRkIG5ldyBldmVudCBzaG9ydGN1dHMKCSQuZWFjaCggKCAidG91Y2hzdGFydCB0b3VjaG1vdmUgdG91Y2hlbmQgIiArCgkJInRhcCB0YXBob2xkICIgKwoJCSJzd2lwZSBzd2lwZWxlZnQgc3dpcGVyaWdodCAiICsKCQkic2Nyb2xsc3RhcnQgc2Nyb2xsc3RvcCIgKS5zcGxpdCggIiAiICksIGZ1bmN0aW9uKCBpLCBuYW1lICkgewoKCQkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJCXJldHVybiBmbiA/IHRoaXMuYmluZCggbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggbmFtZSApOwoJCX07CgoJCS8vIGpRdWVyeSA8IDEuOAoJCWlmICggJC5hdHRyRm4gKSB7CgkJCSQuYXR0ckZuWyBuYW1lIF0gPSB0cnVlOwoJCX0KCX0pOwoKCXZhciBzdXBwb3J0VG91Y2ggPSAkLm1vYmlsZS5zdXBwb3J0LnRvdWNoLAoJCXNjcm9sbEV2ZW50ID0gInRvdWNobW92ZSBzY3JvbGwiLAoJCXRvdWNoU3RhcnRFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaHN0YXJ0IiA6ICJtb3VzZWRvd24iLAoJCXRvdWNoU3RvcEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoZW5kIiA6ICJtb3VzZXVwIiwKCQl0b3VjaE1vdmVFdmVudCA9IHN1cHBvcnRUb3VjaCA/ICJ0b3VjaG1vdmUiIDogIm1vdXNlbW92ZSI7CgoJZnVuY3Rpb24gdHJpZ2dlckN1c3RvbUV2ZW50KCBvYmosIGV2ZW50VHlwZSwgZXZlbnQgKSB7CgkJdmFyIG9yaWdpbmFsVHlwZSA9IGV2ZW50LnR5cGU7CgkJZXZlbnQudHlwZSA9IGV2ZW50VHlwZTsKCQkkLmV2ZW50LmRpc3BhdGNoLmNhbGwoIG9iaiwgZXZlbnQgKTsKCQlldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwoJfQoKCS8vIGFsc28gaGFuZGxlcyBzY3JvbGxzdG9wCgkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQgPSB7CgoJCWVuYWJsZWQ6IHRydWUsCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApLAoJCQkJc2Nyb2xsaW5nLAoJCQkJdGltZXI7CgoJCQlmdW5jdGlvbiB0cmlnZ2VyKCBldmVudCwgc3RhdGUgKSB7CgkJCQlzY3JvbGxpbmcgPSBzdGF0ZTsKCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgc2Nyb2xsaW5nID8gInNjcm9sbHN0YXJ0IiA6ICJzY3JvbGxzdG9wIiwgZXZlbnQgKTsKCQkJfQoKCQkJLy8gaVBob25lIHRyaWdnZXJzIHNjcm9sbCBhZnRlciBhIHNtYWxsIGRlbGF5OyB1c2UgdG91Y2htb3ZlIGluc3RlYWQKCQkJJHRoaXMuYmluZCggc2Nyb2xsRXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKCAhc2Nyb2xsaW5nICkgewoJCQkJCXRyaWdnZXIoIGV2ZW50LCB0cnVlICk7CgkJCQl9CgoJCQkJY2xlYXJUaW1lb3V0KCB0aW1lciApOwoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgZmFsc2UgKTsKCQkJCX0sIDUwICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHRhcGhvbGQKCSQuZXZlbnQuc3BlY2lhbC50YXAgPSB7CgkJdGFwaG9sZFRocmVzaG9sZDogNzUwLAoKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCXZhciB0aGlzT2JqZWN0ID0gdGhpcywKCQkJCSR0aGlzID0gJCggdGhpc09iamVjdCApOwoKCQkJJHRoaXMuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCBldmVudC53aGljaCAmJiBldmVudC53aGljaCAhPT0gMSApIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIG9yaWdUYXJnZXQgPSBldmVudC50YXJnZXQsCgkJCQkJb3JpZ0V2ZW50ID0gZXZlbnQub3JpZ2luYWxFdmVudCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCBvcmlnVGFyZ2V0ID09PSBldmVudC50YXJnZXQgKSB7CgkJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcCIsIGV2ZW50ICk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoICJ2bW91c2V1cCIsIGNsZWFyVGFwVGltZXIgKQoJCQkJCS5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICk7CgkJCQkkZG9jdW1lbnQuYmluZCggInZtb3VzZWNhbmNlbCIsIGNsZWFyVGFwSGFuZGxlcnMgKTsKCgkJCQl0aW1lciA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0KCX07CgoJLy8gYWxzbyBoYW5kbGVzIHN3aXBlbGVmdCwgc3dpcGVyaWdodAoJJC5ldmVudC5zcGVjaWFsLnN3aXBlID0gewoJCXNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQ6IDMwLCAvLyBNb3JlIHRoYW4gdGhpcyBob3Jpem9udGFsIGRpc3BsYWNlbWVudCwgYW5kIHdlIHdpbGwgc3VwcHJlc3Mgc2Nyb2xsaW5nLgoKCQlkdXJhdGlvblRocmVzaG9sZDogMTAwMCwgLy8gTW9yZSB0aW1lIHRoYW4gdGhpcywgYW5kIGl0IGlzbid0IGEgc3dpcGUuCgoJCWhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZDogMzAsICAvLyBTd2lwZSBob3Jpem9udGFsIGRpc3BsYWNlbWVudCBtdXN0IGJlIG1vcmUgdGhhbiB0aGlzLgoKCQl2ZXJ0aWNhbERpc3RhbmNlVGhyZXNob2xkOiA3NSwgIC8vIFN3aXBlIHZlcnRpY2FsIGRpc3BsYWNlbWVudCBtdXN0IGJlIGxlc3MgdGhhbiB0aGlzLgoKCQlzdGFydDogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZGF0YSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlcyA/CgkJCQkJZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzWyAwIF0gOiBldmVudDsKCQkJcmV0dXJuIHsKCQkJCQkJdGltZTogKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpLAoJCQkJCQljb29yZHM6IFsgZGF0YS5wYWdlWCwgZGF0YS5wYWdlWSBdLAoJCQkJCQlvcmlnaW46ICQoIGV2ZW50LnRhcmdldCApCgkJCQkJfTsKCQl9LAoKCQlzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0KCQkJCQl9OwoJCX0sCgoJCWhhbmRsZVN3aXBlOiBmdW5jdGlvbiggc3RhcnQsIHN0b3AgKSB7CgkJCWlmICggc3RvcC50aW1lIC0gc3RhcnQudGltZSA8ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5kdXJhdGlvblRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhvcml6b250YWxEaXN0YW5jZVRocmVzaG9sZCAmJgoJCQkJTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMSBdIC0gc3RvcC5jb29yZHNbIDEgXSApIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLnZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQgKSB7CgoJCQkJc3RhcnQub3JpZ2luLnRyaWdnZXIoICJzd2lwZSIgKQoJCQkJCS50cmlnZ2VyKCBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCIgKTsKCQkJfQoJCX0sCgoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICk7CgoJCQkkdGhpcy5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCXZhciBzdGFydCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdGFydCggZXZlbnQgKSwKCQkJCQlzdG9wOwoKCQkJCWZ1bmN0aW9uIG1vdmVIYW5kbGVyKCBldmVudCApIHsKCQkJCQlpZiAoICFzdGFydCApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJc3RvcCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zdG9wKCBldmVudCApOwoKCQkJCQkvLyBwcmV2ZW50IHNjcm9sbGluZwoJCQkJCWlmICggTWF0aC5hYnMoIHN0YXJ0LmNvb3Jkc1sgMCBdIC0gc3RvcC5jb29yZHNbIDAgXSApID4gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnNjcm9sbFN1cHJlc3Npb25UaHJlc2hvbGQgKSB7CgkJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0aGlzLmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApCgkJCQkJLm9uZSggdG91Y2hTdG9wRXZlbnQsIGZ1bmN0aW9uKCkgewoJCQkJCQkkdGhpcy51bmJpbmQoIHRvdWNoTW92ZUV2ZW50LCBtb3ZlSGFuZGxlciApOwoKCQkJCQkJaWYgKCBzdGFydCAmJiBzdG9wICkgewoJCQkJCQkJJC5ldmVudC5zcGVjaWFsLnN3aXBlLmhhbmRsZVN3aXBlKCBzdGFydCwgc3RvcCApOwoJCQkJCQl9CgkJCQkJCXN0YXJ0ID0gc3RvcCA9IHVuZGVmaW5lZDsKCQkJCQl9KTsKCQkJfSk7CgkJfQoJfTsKCSQuZWFjaCh7CgkJc2Nyb2xsc3RvcDogInNjcm9sbHN0YXJ0IiwKCQl0YXBob2xkOiAidGFwIiwKCQlzd2lwZWxlZnQ6ICJzd2lwZSIsCgkJc3dpcGVyaWdodDogInN3aXBlIgoJfSwgZnVuY3Rpb24oIGV2ZW50LCBzb3VyY2VFdmVudCApIHsKCgkJJC5ldmVudC5zcGVjaWFsWyBldmVudCBdID0gewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkuYmluZCggc291cmNlRXZlbnQsICQubm9vcCApOwoJCQl9CgkJfTsKCX0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKCgkvLyB0aHJvdHRsZWQgcmVzaXplIGV2ZW50CgkoZnVuY3Rpb24oICQgKSB7CgkJJC5ldmVudC5zcGVjaWFsLnRocm90dGxlZHJlc2l6ZSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS51bmJpbmQoICJyZXNpemUiLCBoYW5kbGVyICk7CgkJCX0KCQl9OwoKCQl2YXIgdGhyb3R0bGUgPSAyNTAsCgkJCWhhbmRsZXIgPSBmdW5jdGlvbigpIHsKCQkJCWN1cnIgPSAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCk7CgkJCQlkaWZmID0gY3VyciAtIGxhc3RDYWxsOwoKCQkJCWlmICggZGlmZiA+PSB0aHJvdHRsZSApIHsKCgkJCQkJbGFzdENhbGwgPSBjdXJyOwoJCQkJCSQoIHRoaXMgKS50cmlnZ2VyKCAidGhyb3R0bGVkcmVzaXplIiApOwoKCQkJCX0gZWxzZSB7CgoJCQkJCWlmICggaGVsZENhbGwgKSB7CgkJCQkJCWNsZWFyVGltZW91dCggaGVsZENhbGwgKTsKCQkJCQl9CgoJCQkJCS8vIFByb21pc2UgYSBoZWxkIGNhbGwgd2lsbCBzdGlsbCBleGVjdXRlCgkJCQkJaGVsZENhbGwgPSBzZXRUaW1lb3V0KCBoYW5kbGVyLCB0aHJvdHRsZSAtIGRpZmYgKTsKCQkJCX0KCQkJfSwKCQkJbGFzdENhbGwgPSAwLAoJCQloZWxkQ2FsbCwKCQkJY3VyciwKCQkJZGlmZjsKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoJdmFyIHdpbiA9ICQoIHdpbmRvdyApLAoJCWV2ZW50X25hbWUgPSAib3JpZW50YXRpb25jaGFuZ2UiLAoJCXNwZWNpYWxfZXZlbnQsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9OwoKCS8vIEl0IHNlZW1zIHRoYXQgc29tZSBkZXZpY2UvYnJvd3NlciB2ZW5kb3JzIHVzZSB3aW5kb3cub3JpZW50YXRpb24gdmFsdWVzIDAgYW5kIDE4MCB0bwoJLy8gZGVub3RlIHRoZSAiZGVmYXVsdCIgb3JpZW50YXRpb24uIEZvciBpT1MgZGV2aWNlcywgYW5kIG1vc3Qgb3RoZXIgc21hcnQtcGhvbmVzIHRlc3RlZCwKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzIGFsd2F5cyAicG9ydHJhaXQiLCBidXQgaW4gc29tZSBBbmRyb2lkIGFuZCBSSU0gYmFzZWQgdGFibGV0cywKCS8vIHRoZSBkZWZhdWx0IG9yaWVudGF0aW9uIGlzICJsYW5kc2NhcGUiLiBUaGUgZm9sbG93aW5nIGNvZGUgYXR0ZW1wdHMgdG8gdXNlIHRoZSB3aW5kb3cKCS8vIGRpbWVuc2lvbnMgdG8gZmlndXJlIG91dCB3aGF0IHRoZSBjdXJyZW50IG9yaWVudGF0aW9uIGlzLCBhbmQgdGhlbiBtYWtlcyBhZGp1c3RtZW50cwoJLy8gdG8gdGhlIHRvIHRoZSBwb3J0cmFpdF9tYXAgaWYgbmVjZXNzYXJ5LCBzbyB0aGF0IHdlIGNhbiBwcm9wZXJseSBkZWNvZGUgdGhlCgkvLyB3aW5kb3cub3JpZW50YXRpb24gdmFsdWUgd2hlbmV2ZXIgZ2V0X29yaWVudGF0aW9uKCkgaXMgY2FsbGVkLgoJLy8KCS8vIE5vdGUgdGhhdCB3ZSB1c2VkIHRvIHVzZSBhIG1lZGlhIHF1ZXJ5IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgb3JpZW50YXRpb24gdGhlIGJyb3dzZXIKCS8vIHRoaW5rcyBpdCBpcyBpbjoKCS8vCgkvLyAgICAgaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUgPSAkLm1vYmlsZS5tZWRpYSgiYWxsIGFuZCAob3JpZW50YXRpb246IGxhbmRzY2FwZSkiKTsKCS8vCgkvLyBidXQgdGhlcmUgd2FzIGFuIGlQaG9uZS9pUG9kIFRvdWNoIGJ1ZyBiZWdpbm5pbmcgd2l0aCBpT1MgNC4yLCB1cCB0aHJvdWdoIGlPUyA1LjEsCgkvLyB3aGVyZSB0aGUgYnJvd3NlciAqQUxXQVlTKiBhcHBsaWVkIHRoZSBsYW5kc2NhcGUgbWVkaWEgcXVlcnkuIFRoaXMgYnVnIGRvZXMgbm90CgkvLyBoYXBwZW4gb24gaVBhZC4KCglpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiApIHsKCgkJLy8gQ2hlY2sgdGhlIHdpbmRvdyB3aWR0aCBhbmQgaGVpZ2h0IHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbgoJCS8vIG9mIHRoZSBkZXZpY2UgaXMgYXQgdGhpcyBtb21lbnQuIE5vdGUgdGhhdCB3ZSd2ZSBpbml0aWFsaXplZCB0aGUgcG9ydHJhaXQgbWFwCgkJLy8gdmFsdWVzIHRvIDAgYW5kIDE4MCwgKkFORCogd2UgcHVycG9zZWx5IGNoZWNrIGZvciBsYW5kc2NhcGUgc28gdGhhdCBpZiB3ZSBndWVzcwoJCS8vIHdyb25nLCAsIHdlIGRlZmF1bHQgdG8gdGhlIGFzc3VtcHRpb24gdGhhdCBwb3J0cmFpdCBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbi4KCQkvLyBXZSB1c2UgYSB0aHJlc2hvbGQgY2hlY2sgYmVsb3cgYmVjYXVzZSBvbiBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUywgdGhlIGlQaG9uZQoJCS8vIGZvcm0tZmFjdG9yIGNhbiByZXBvcnQgYSBsYXJnZXIgd2lkdGggdGhhbiBoZWlnaHQgaWYgdGhlIHVzZXIgdHVybnMgb24gdGhlCgkJLy8gZGV2ZWxvcGVyIGNvbnNvbGUuIFRoZSBhY3R1YWwgdGhyZXNob2xkIHZhbHVlIGlzIHNvbWV3aGF0IGFyYml0cmFyeSwgd2UganVzdAoJCS8vIG5lZWQgdG8gbWFrZSBzdXJlIGl0IGlzIGxhcmdlIGVub3VnaCB0byBleGNsdWRlIHRoZSBkZXZlbG9wZXIgY29uc29sZSBjYXNlLgoKCQl2YXIgd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKSwKCQkJd2ggPSB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgd2luLmhlaWdodCgpLAoJCQlsYW5kc2NhcGVfdGhyZXNob2xkID0gNTA7CgoJCWluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gd3cgPiB3aCAmJiAoIHd3IC0gd2ggKSA+IGxhbmRzY2FwZV90aHJlc2hvbGQ7CgoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCgkJCWhhbmRsZU9iai5oYW5kbGVyID0gZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJLy8gTW9kaWZ5IGV2ZW50IG9iamVjdCwgYWRkaW5nIHRoZSAub3JpZW50YXRpb24gcHJvcGVydHkuCgkJCQlldmVudC5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJCS8vIENhbGwgdGhlIG9yaWdpbmFsbHktYm91bmQgZXZlbnQgaGFuZGxlciBhbmQgcmV0dXJuIGl0cyByZXN1bHQuCgkJCQlyZXR1cm4gb2xkX2hhbmRsZXIuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoJCQl9OwoJCX0KCX0pOwoKCS8vIElmIHRoZSBldmVudCBpcyBub3Qgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGlzIGhhbmRsZXIgd2lsbCBiZSBib3VuZCB0bwoJLy8gdGhlIHdpbmRvdyByZXNpemUgZXZlbnQgdG8gc2ltdWxhdGUgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50LgoJZnVuY3Rpb24gaGFuZGxlcigpIHsKCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24uCgkJdmFyIG9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCWlmICggb3JpZW50YXRpb24gIT09IGxhc3Rfb3JpZW50YXRpb24gKSB7CgkJCS8vIFRoZSBvcmllbnRhdGlvbiBoYXMgY2hhbmdlZCwgc28gdHJpZ2dlciB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCgkJCWxhc3Rfb3JpZW50YXRpb24gPSBvcmllbnRhdGlvbjsKCQkJd2luLnRyaWdnZXIoIGV2ZW50X25hbWUgKTsKCQl9Cgl9CgoJLy8gR2V0IHRoZSBjdXJyZW50IHBhZ2Ugb3JpZW50YXRpb24uIFRoaXMgbWV0aG9kIGlzIGV4cG9zZWQgcHVibGljbHksIHNob3VsZCBpdAoJLy8gYmUgbmVlZGVkLCBhcyBqUXVlcnkuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbigpCgkkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2Uub3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24gPSBmdW5jdGlvbigpIHsKCQl2YXIgaXNQb3J0cmFpdCA9IHRydWUsIGVsZW0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CgoJCS8vIHByZWZlciB3aW5kb3cgb3JpZW50YXRpb24gdG8gdGhlIGNhbGN1bGF0aW9uIGJhc2VkIG9uIHNjcmVlbnNpemUgYXMKCQkvLyB0aGUgYWN0dWFsIHNjcmVlbiByZXNpemUgdGFrZXMgcGxhY2UgYmVmb3JlIG9yIGFmdGVyIHRoZSBvcmllbnRhdGlvbiBjaGFuZ2UgZXZlbnQKCQkvLyBoYXMgYmVlbiBmaXJlZCBkZXBlbmRpbmcgb24gaW1wbGVtZW50YXRpb24gKGVnIGFuZHJvaWQgMi4zIGlzIGJlZm9yZSwgaXBob25lIGFmdGVyKS4KCQkvLyBNb3JlIHRlc3RpbmcgaXMgcmVxdWlyZWQgdG8gZGV0ZXJtaW5lIGlmIGEgbW9yZSByZWxpYWJsZSBtZXRob2Qgb2YgZGV0ZXJtaW5pbmcgdGhlIG5ldyBzY3JlZW5zaXplCgkJLy8gaXMgcG9zc2libGUgd2hlbiBvcmllbnRhdGlvbmNoYW5nZSBpcyBmaXJlZC4gKGVnLCB1c2UgbWVkaWEgcXVlcmllcyArIGVsZW1lbnQgKyBvcGFjaXR5KQoJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICkgewoJCQkvLyBpZiB0aGUgd2luZG93IG9yaWVudGF0aW9uIHJlZ2lzdGVycyBhcyAwIG9yIDE4MCBkZWdyZWVzIHJlcG9ydAoJCQkvLyBwb3J0cmFpdCwgb3RoZXJ3aXNlIGxhbmRzY2FwZQoJCQlpc1BvcnRyYWl0ID0gcG9ydHJhaXRfbWFwWyB3aW5kb3cub3JpZW50YXRpb24gXTsKCQl9IGVsc2UgewoJCQlpc1BvcnRyYWl0ID0gZWxlbSAmJiBlbGVtLmNsaWVudFdpZHRoIC8gZWxlbS5jbGllbnRIZWlnaHQgPCAxLjE7CgkJfQoKCQlyZXR1cm4gaXNQb3J0cmFpdCA/ICJwb3J0cmFpdCIgOiAibGFuZHNjYXBlIjsKCX07CgoJJC5mblsgZXZlbnRfbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCXJldHVybiBmbiA/IHRoaXMuYmluZCggZXZlbnRfbmFtZSwgZm4gKSA6IHRoaXMudHJpZ2dlciggZXZlbnRfbmFtZSApOwoJfTsKCgkvLyBqUXVlcnkgPCAxLjgKCWlmICggJC5hdHRyRm4gKSB7CgkJJC5hdHRyRm5bIGV2ZW50X25hbWUgXSA9IHRydWU7Cgl9Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFnZSIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYyIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoJCWtlZXBOYXRpdmVEZWZhdWx0OiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCS8vIGlmIGZhbHNlIGlzIHJldHVybmVkIGJ5IHRoZSBjYWxsYmFja3MgZG8gbm90IGNyZWF0ZSB0aGUgcGFnZQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZWNyZWF0ZSIgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRoaXMuZWxlbWVudAoJCQkuYXR0ciggInRhYmluZGV4IiwgIjAiICkKCQkJLmFkZENsYXNzKCAidWktcGFnZSB1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKTsKCgkJdGhpcy5fb24oIHRoaXMuZWxlbWVudCwgewoJCQlwYWdlYmVmb3JlaGlkZTogInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiLAoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiggZSApIHsKCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoKTsKCX0sCgoJcmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZDogZnVuY3Rpb24oKSB7CgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLW92ZXJsYXktIiArICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQucGFyZW50KCkgKSApOwoJfSwKCgkvLyBzZXQgdGhlIHBhZ2UgY29udGFpbmVyIGJhY2tncm91bmQgdG8gdGhlIHBhZ2UgdGhlbWUKCXNldENvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCB0aGVtZSApIHsKCQlpZiAoIHRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArICggdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lICkgKTsKCQl9Cgl9LAoKCWtlZXBOYXRpdmVTZWxlY3RvcjogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCWtlZXBOYXRpdmVEZWZpbmVkID0gb3B0aW9ucy5rZWVwTmF0aXZlICYmICQudHJpbSggb3B0aW9ucy5rZWVwTmF0aXZlICk7CgoJCWlmICgga2VlcE5hdGl2ZURlZmluZWQgJiYgb3B0aW9ucy5rZWVwTmF0aXZlICE9PSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0ICkgewoJCQlyZXR1cm4gW29wdGlvbnMua2VlcE5hdGl2ZSwgb3B0aW9ucy5rZWVwTmF0aXZlRGVmYXVsdF0uam9pbiggIiwgIiApOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQ7Cgl9Cn0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKdmFyIGNyZWF0ZUhhbmRsZXIgPSBmdW5jdGlvbiggc2VxdWVudGlhbCApIHsKCgkvLyBEZWZhdWx0IHRvIHNlcXVlbnRpYWwKCWlmICggc2VxdWVudGlhbCA9PT0gdW5kZWZpbmVkICkgewoJCXNlcXVlbnRpYWwgPSB0cnVlOwoJfQoKCXJldHVybiBmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSApIHsKCgkJdmFyIGRlZmVycmVkID0gbmV3ICQuRGVmZXJyZWQoKSwKCQkJcmV2ZXJzZUNsYXNzID0gcmV2ZXJzZSA/ICIgcmV2ZXJzZSIgOiAiIiwKCQkJYWN0aXZlCT0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJdG9TY3JvbGwgPSBhY3RpdmUubGFzdFNjcm9sbCB8fCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCwKCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCW1heFRyYW5zaXRpb25PdmVycmlkZSA9ICQubW9iaWxlLm1heFRyYW5zaXRpb25XaWR0aCAhPT0gZmFsc2UgJiYgJC5tb2JpbGUud2luZG93LndpZHRoKCkgPiAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGgsCgkJCW5vbmUgPSAhJC5zdXBwb3J0LmNzc1RyYW5zaXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhbmFtZSB8fCBuYW1lID09PSAibm9uZSIgfHwgTWF0aC5tYXgoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSwgdG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKSwKCQkJdG9QcmVDbGFzcyA9ICIgdWktcGFnZS1wcmUtaW4iLAoJCQl0b2dnbGVWaWV3cG9ydENsYXNzID0gZnVuY3Rpb24oKSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIG5hbWUgKTsKCQkJfSwKCQkJc2Nyb2xsUGFnZSA9IGZ1bmN0aW9uKCkgewoJCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJCS8vIEp1c3QgdG8gYmUgcHJlY2F1dGlvcywgZGlzYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB0b1Njcm9sbCApOwoKCQkJCS8vIHJlZW5hYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgPSB0cnVlOwoJCQkJfSwgMTUwICk7CgkJCX0sCgkJCWNsZWFuRnJvbSA9IGZ1bmN0aW9uKCkgewoJCQkJJGZyb20KCQkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIG5hbWUgKQoJCQkJCS5oZWlnaHQoICIiICk7CgkJCX0sCgkJCXN0YXJ0T3V0ID0gZnVuY3Rpb24oKSB7CgkJCQkvLyBpZiBpdCdzIG5vdCBzZXF1ZW50aWFsLCBjYWxsIHRoZSBkb25lT3V0IHRyYW5zaXRpb24gdG8gc3RhcnQgdGhlIFRPIHBhZ2UgYW5pbWF0aW5nIGluIHNpbXVsdGFuZW91c2x5CgkJCQlpZiAoICFzZXF1ZW50aWFsICkgewoJCQkJCWRvbmVPdXQoKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCBkb25lT3V0ICk7CgkJCQl9CgoJCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCQkvLyBOb3RlOiBzZXR0aW5nIGFuIGV4cGxpY2l0IGhlaWdodCBoZWxwcyBlbGltaW5hdGUgdGlsaW5nIGluIHRoZSB0cmFuc2l0aW9ucwoJCQkJJGZyb20KCQkJCQkuaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgKQoJCQkJCS5hZGRDbGFzcyggbmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCQl9LAoKCQkJZG9uZU91dCA9IGZ1bmN0aW9uKCkgewoKCQkJCWlmICggJGZyb20gJiYgc2VxdWVudGlhbCApIHsKCQkJCQljbGVhbkZyb20oKTsKCQkJCX0KCgkJCQlzdGFydEluKCk7CgkJCX0sCgoJCQlzdGFydEluID0gZnVuY3Rpb24oKSB7CgoJCQkJLy8gUHJldmVudCBmbGlja2VyaW5nIGluIHBob25lZ2FwIGNvbnRhaW5lcjogc2VlIGNvbW1lbnRzIGF0ICM0MDI0IHJlZ2FyZGluZyBpT1MKCQkJCSR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgoJCQkJJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0b1ByZUNsYXNzICk7CgoJCQkJLy8gU2VuZCBmb2N1cyB0byBwYWdlIGFzIGl0IGlzIG5vdyBkaXNwbGF5OiBibG9jawoJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCAkdG8gKTsKCgkJCQkvLyBTZXQgdG8gcGFnZSBoZWlnaHQKCQkJCSR0by5oZWlnaHQoIHNjcmVlbkhlaWdodCArIHRvU2Nyb2xsICk7CgoJCQkJc2Nyb2xsUGFnZSgpOwoKCQkJCS8vIFJlc3RvcmVzIHZpc2liaWxpdHkgb2YgdGhlIG5ldyBwYWdlOiBhZGRlZCB0b2dldGhlciB3aXRoICR0by5jc3MoICJ6LWluZGV4IiwgLTEwICk7CgkJCQkkdG8uY3NzKCAiei1pbmRleCIsICIiICk7CgoJCQkJaWYgKCAhbm9uZSApIHsKCQkJCQkkdG8uYW5pbWF0aW9uQ29tcGxldGUoIGRvbmVJbiApOwoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggdG9QcmVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCBuYW1lICsgIiBpbiIgKyByZXZlcnNlQ2xhc3MgKTsKCgkJCQlpZiAoIG5vbmUgKSB7CgkJCQkJZG9uZUluKCk7CgkJCQl9CgoJCQl9LAoKCQkJZG9uZUluID0gZnVuY3Rpb24oKSB7CgoJCQkJaWYgKCAhc2VxdWVudGlhbCApIHsKCgkJCQkJaWYgKCAkZnJvbSApIHsKCQkJCQkJY2xlYW5Gcm9tKCk7CgkJCQkJfQoJCQkJfQoKCQkJCSR0bwoJCQkJCS5yZW1vdmVDbGFzcyggIm91dCBpbiByZXZlcnNlICIgKyBuYW1lICkKCQkJCQkuaGVpZ2h0KCAiIiApOwoKCQkJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJCQkvLyBJbiBzb21lIGJyb3dzZXJzIChpT1M1KSwgM0QgdHJhbnNpdGlvbnMgYmxvY2sgdGhlIGFiaWxpdHkgdG8gc2Nyb2xsIHRvIHRoZSBkZXNpcmVkIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0aW9uCgkJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQkJaWYgKCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgIT09IHRvU2Nyb2xsICkgewoJCQkJCXNjcm9sbFBhZ2UoKTsKCQkJCX0KCgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBuYW1lLCByZXZlcnNlLCAkdG8sICRmcm9tLCB0cnVlICk7CgkJCX07CgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3MoKTsKCgkJaWYgKCAkZnJvbSAmJiAhbm9uZSApIHsKCQkJc3RhcnRPdXQoKTsKCQl9CgkJZWxzZSB7CgkJCWRvbmVPdXQoKTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9Owp9OwoKLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCnZhciBzZXF1ZW50aWFsSGFuZGxlciA9IGNyZWF0ZUhhbmRsZXIoKSwKCXNpbXVsdGFuZW91c0hhbmRsZXIgPSBjcmVhdGVIYW5kbGVyKCBmYWxzZSApLAoJZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCi8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCiQubW9iaWxlLmRlZmF1bHRUcmFuc2l0aW9uSGFuZGxlciA9IHNlcXVlbnRpYWxIYW5kbGVyOwoKLy90cmFuc2l0aW9uIGhhbmRsZXIgZGljdGlvbmFyeSBmb3IgM3JkIHBhcnR5IHRyYW5zaXRpb25zCiQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCSJkZWZhdWx0IjogJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyLAoJInNlcXVlbnRpYWwiOiBzZXF1ZW50aWFsSGFuZGxlciwKCSJzaW11bHRhbmVvdXMiOiBzaW11bHRhbmVvdXNIYW5kbGVyCn07CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgovLyBJZiB0cmFuc2l0aW9uIGlzIGRlZmluZWQsIGNoZWNrIGlmIGNzcyAzRCB0cmFuc2Zvcm1zIGFyZSBzdXBwb3J0ZWQsIGFuZCBpZiBub3QsIGlmIGEgZmFsbGJhY2sgaXMgc3BlY2lmaWVkCiQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uID0gZnVuY3Rpb24oIHRyYW5zaXRpb24gKSB7CgkJaWYgKCB0cmFuc2l0aW9uICYmICEkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrc1sgdHJhbnNpdGlvbiBdOwoJCX0KCgkJcmV0dXJuIHRyYW5zaXRpb247Cn07CgovLyBTZXQgdGhlIGdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gdG8gZGVmYXVsdCBpZiBubyBpbXBsZW1lbnRhdGlvbiB3YXMgc2V0IGJ5IHVzZXIKJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiA9ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gfHwgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb247Cn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vZGVmaW5lIHZhcnMgZm9yIGludGVyYWwgdXNlCgl2YXIgJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkkaHRtbCA9ICQoICdodG1sJyApLAoJCSRoZWFkID0gJCggJ2hlYWQnICksCgoJCS8vIE5PVEU6IHBhdGggZXh0ZW5zaW9ucyBkZXBlbmRlbnQgb24gY29yZSBhdHRyaWJ1dGVzLiBNb3ZlZCBoZXJlIHRvIHJlbW92ZSBkZXBzIGZyb20KCQkvLyAgICAgICAkLm1vYmlsZS5wYXRoIGRlZmluaXRpb24KCQlwYXRoID0gJC5leHRlbmQoJC5tb2JpbGUucGF0aCwgewoKCQkJLy9yZXR1cm4gdGhlIHN1YnN0cmluZyBvZiBhIGZpbGVwYXRoIGJlZm9yZSB0aGUgc3ViLXBhZ2Uga2V5LCBmb3IgbWFraW5nIGEgc2VydmVyIHJlcXVlc3QKCQkJZ2V0RmlsZVBhdGg6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJdmFyIHNwbGl0a2V5ID0gJyYnICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleTsKCQkJCXJldHVybiBwYXRoICYmIHBhdGguc3BsaXQoIHNwbGl0a2V5IClbMF0uc3BsaXQoIGRpYWxvZ0hhc2hLZXkgKVswXTsKCQkJfSwKCgkJCS8vY2hlY2sgaWYgdGhlIHNwZWNpZmllZCB1cmwgcmVmZXJzIHRvIHRoZSBmaXJzdCBwYWdlIGluIHRoZSBtYWluIGFwcGxpY2F0aW9uIGRvY3VtZW50LgoJCQlpc0ZpcnN0UGFnZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCS8vIFdlIG9ubHkgZGVhbCB3aXRoIGFic29sdXRlIHBhdGhzLgoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLmRvY3VtZW50QmFzZSApICksCgoJCQkJCS8vIERvZXMgdGhlIHVybCBoYXZlIHRoZSBzYW1lIHBhdGggYXMgdGhlIGRvY3VtZW50PwoJCQkJCXNhbWVQYXRoID0gdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50VXJsLmhyZWZOb0hhc2ggfHwgKCB0aGlzLmRvY3VtZW50QmFzZURpZmZlcnMgJiYgdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQgb2YgdGhlCgkJCQkvLyBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYgKCAhdS5oYXNoIHx8IHUuaGFzaCA9PT0gIiMiIHx8ICggZnBJZCAmJiB1Lmhhc2gucmVwbGFjZSggL14jLywgIiIgKSA9PT0gZnBJZCApICk7CgkJCX0sCgoJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJLy8gcmVxdWVzdHMgaWYgdGhlIGRvY3VtZW50IGRvaW5nIHRoZSByZXF1ZXN0IHdhcyBsb2FkZWQgdmlhIHRoZSBmaWxlOi8vIHByb3RvY29sLgoJCQkvLyBUaGlzIGlzIHVzdWFsbHkgdG8gYWxsb3cgdGhlIGFwcGxpY2F0aW9uIHRvICJwaG9uZSBob21lIiBhbmQgZmV0Y2ggYXBwIHNwZWNpZmljCgkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJLy8gYWxsb3dDcm9zc0RvbWFpblBhZ2VzIG9wdGlvbiBpcyB0cnVlLCB3ZSB3aWxsIGFsbG93IGNyb3NzLWRvbWFpbiBodHRwL2h0dHBzCgkJCS8vIHJlcXVlc3RzIHRvIGdvIHRocm91Z2ggb3VyIHBhZ2UgbG9hZGluZyBsb2dpYy4KCQkJaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3Q6IGZ1bmN0aW9uKCBkb2NVcmwsIHJlcVVybCApIHsKCQkJCXJldHVybiAkLm1vYmlsZS5hbGxvd0Nyb3NzRG9tYWluUGFnZXMgJiYKCQkJCQlkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgJiYKCQkJCQlyZXFVcmwuc2VhcmNoKCAvXmh0dHBzPzovICkgIT09IC0xOwoJCQl9CgkJfSksCgoJCS8vIHVzZWQgdG8gdHJhY2sgbGFzdCB2Y2xpY2tlZCBlbGVtZW50IHRvIG1ha2Ugc3VyZSBpdHMgdmFsdWUgaXMgYWRkZWQgdG8gZm9ybSBkYXRhCgkJJGxhc3RWQ2xpY2tlZCA9IG51bGwsCgoJCS8vd2lsbCBiZSBkZWZpbmVkIHdoZW4gYSBsaW5rIGlzIGNsaWNrZWQgYW5kIGdpdmVuIGFuIGFjdGl2ZSBjbGFzcwoJCSRhY3RpdmVDbGlja2VkTGluayA9IG51bGwsCgoJCS8vIHJlc29sdmVkIG9uIGRvbXJlYWR5CgkJZG9tcmVhZHlEZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJLy91cmxIaXN0b3J5IGlzIHB1cmVseSBoZXJlIHRvIG1ha2UgZ3Vlc3NlcyBhdCB3aGV0aGVyIHRoZSBiYWNrIG9yIGZvcndhcmQgYnV0dG9uIHdhcyBjbGlja2VkCgkJLy9hbmQgcHJvdmlkZSBhbiBhcHByb3ByaWF0ZSB0cmFuc2l0aW9uCgkJdXJsSGlzdG9yeSA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnksCgoJCS8vZGVmaW5lIGZpcnN0IHNlbGVjdG9yIHRvIHJlY2VpdmUgZm9jdXMgd2hlbiBhIHBhZ2UgaXMgc2hvd24KCQlmb2N1c2FibGUgPSAiW3RhYmluZGV4XSxhLGJ1dHRvbjp2aXNpYmxlLHNlbGVjdDp2aXNpYmxlLGlucHV0IiwKCgkJLy9xdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgkJcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvL2luZGljYXRlcyB3aGV0aGVyIG9yIG5vdCBwYWdlIGlzIGluIHByb2Nlc3Mgb2YgdHJhbnNpdGlvbmluZwoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZSwKCgkJLy9ub25zZW5zZSBoYXNoIGNoYW5nZSBrZXkgZm9yIGRpYWxvZ3MsIHNvIHRoZXkgY3JlYXRlIGEgaGlzdG9yeSBlbnRyeQoJCWRpYWxvZ0hhc2hLZXkgPSAiJnVpLXN0YXRlPWRpYWxvZyIsCgoJCS8vZXhpc3RpbmcgYmFzZSB0YWc/CgkJJGJhc2UgPSAkaGVhZC5jaGlsZHJlbiggImJhc2UiICksCgoJCS8vdHVjayBhd2F5IHRoZSBvcmlnaW5hbCBkb2N1bWVudCBVUkwgbWludXMgYW55IGZyYWdtZW50LgoJCWRvY3VtZW50VXJsID0gcGF0aC5kb2N1bWVudFVybCwKCgkJLy9pZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGVtYmVkZGVkIGJhc2UgdGFnLCBkb2N1bWVudEJhc2UgaXMgc2V0IHRvIGl0cwoJCS8vaW5pdGlhbCB2YWx1ZS4gSWYgYSBiYXNlIHRhZyBkb2VzIG5vdCBleGlzdCwgdGhlbiB3ZSBkZWZhdWx0IHRvIHRoZSBkb2N1bWVudFVybC4KCQlkb2N1bWVudEJhc2UgPSBwYXRoLmRvY3VtZW50QmFzZSwKCgkJLy9jYWNoZSB0aGUgY29tcGFyaXNvbiBvbmNlLgoJCWRvY3VtZW50QmFzZURpZmZlcnMgPSBwYXRoLmRvY3VtZW50QmFzZURpZmZlcnMsCgoJCWdldFNjcmVlbkhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodDsKCgkJLy9iYXNlIGVsZW1lbnQgbWFuYWdlbWVudCwgZGVmaW5lZCBkZXBlbmRpbmcgb24gZHluYW1pYyBiYXNlIHRhZyBzdXBwb3J0CgkJdmFyIGJhc2UgPSAkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgPyB7CgoJCQkvL2RlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gQWpheC1yZXF1ZXN0ZWQgbWFya3VwCgkJCWVsZW1lbnQ6ICggJGJhc2UubGVuZ3RoID8gJGJhc2UgOiAkKCAiPGJhc2U+IiwgeyBocmVmOiBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkaGVhZCApICksCgoJCQkvL3NldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgYXR0cmlidXRlIHRvIGEgbmV3IHBhZ2UncyBiYXNlIHBhdGgKCQkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKGhyZWYpLmhyZWZOb0hhc2g7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgZG9jdW1lbnRCYXNlICkgKTsKCQkJfSwKCgkJCS8vc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiBhdHRyaWJ1dGUgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCQlyZXNldDogZnVuY3Rpb24oKSB7CgkJCQliYXNlLmVsZW1lbnQuYXR0ciggImhyZWYiLCBkb2N1bWVudEJhc2UuaHJlZk5vU2VhcmNoICk7CgkJCX0KCgkJfSA6IHVuZGVmaW5lZDsKCgoJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwoKCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJJC5tb2JpbGUuZ2V0RG9jdW1lbnRCYXNlID0gcGF0aC5nZXREb2N1bWVudEJhc2U7CgoJLyogaW50ZXJuYWwgdXRpbGl0eSBmdW5jdGlvbnMgKi8KCgkvLyBOT1RFIElzc3VlICM0OTUwIEFuZHJvaWQgcGhvbmVnYXAgZG9lc24ndCBuYXZpZ2F0ZSBiYWNrIHByb3Blcmx5CgkvLyAgICAgIHdoZW4gYSBmdWxsIHBhZ2UgcmVmcmVzaCBoYXMgdGFrZW4gcGxhY2UuIEl0IGFwcGVhcnMgdGhhdCBoYXNoY2hhbmdlCgkvLyAgICAgIGFuZCByZXBsYWNlc3RhdGUgaGlzdG9yeSBhbHRlcmF0aW9ucyB3b3JrIGZpbmUgYnV0IHdlIG5lZWQgdG8gc3VwcG9ydAoJLy8gICAgICBib3RoIGZvcm1zIG9mIGhpc3RvcnkgdHJhdmVyc2FsIGluIG91ciBjb2RlIHRoYXQgdXNlcyBiYWNrd2FyZCBoaXN0b3J5CgkvLyAgICAgIG1vdmVtZW50CgkkLm1vYmlsZS5iYWNrID0gZnVuY3Rpb24oKSB7CgkJdmFyIG5hdiA9IHdpbmRvdy5uYXZpZ2F0b3I7CgoJCS8vIGlmIHRoZSBzZXR0aW5nIGlzIG9uIGFuZCB0aGUgbmF2aWdhdG9yIG9iamVjdCBpcwoJCS8vIGF2YWlsYWJsZSB1c2UgdGhlIHBob25lZ2FwIG5hdmlnYXRpb24gY2FwYWJpbGl0eQoJCWlmKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApewoJCQluYXYuYXBwLmJhY2tIaXN0b3J5KCk7CgkJfSBlbHNlIHsKCQkJd2luZG93Lmhpc3RvcnkuYmFjaygpOwoJCX0KCX07CgoJLy9kaXJlY3QgZm9jdXMgdG8gdGhlIHBhZ2UgdGl0bGUsIG9yIG90aGVyd2lzZSBmaXJzdCBmb2N1c2FibGUgZWxlbWVudAoJJC5tb2JpbGUuZm9jdXNQYWdlID0gZnVuY3Rpb24gKCBwYWdlICkgewoJCXZhciBhdXRvZm9jdXMgPSBwYWdlLmZpbmQoICJbYXV0b2ZvY3VzXSIgKSwKCQkJcGFnZVRpdGxlID0gcGFnZS5maW5kKCAiLnVpLXRpdGxlOmVxKDApIiApOwoKCQlpZiAoIGF1dG9mb2N1cy5sZW5ndGggKSB7CgkJCWF1dG9mb2N1cy5mb2N1cygpOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHBhZ2VUaXRsZS5sZW5ndGggKSB7CgkJCXBhZ2VUaXRsZS5mb2N1cygpOwoJCX0gZWxzZXsKCQkJcGFnZS5mb2N1cygpOwoJCX0KCX07CgoJLy9yZW1vdmUgYWN0aXZlIGNsYXNzZXMgYWZ0ZXIgcGFnZSB0cmFuc2l0aW9uIG9yIGVycm9yCglmdW5jdGlvbiByZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIGZvcmNlUmVtb3ZhbCApIHsKCQlpZiAoICEhJGFjdGl2ZUNsaWNrZWRMaW5rICYmICggISRhY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwgZm9yY2VSZW1vdmFsICkgKSB7CgkJCSRhY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9CgkJJGFjdGl2ZUNsaWNrZWRMaW5rID0gbnVsbDsKCX0KCglmdW5jdGlvbiByZWxlYXNlUGFnZVRyYW5zaXRpb25Mb2NrKCkgewoJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQlpZiAoIHBhZ2VUcmFuc2l0aW9uUXVldWUubGVuZ3RoID4gMCApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZS5hcHBseSggbnVsbCwgcGFnZVRyYW5zaXRpb25RdWV1ZS5wb3AoKSApOwoJCX0KCX0KCgkvLyBTYXZlIHRoZSBsYXN0IHNjcm9sbCBkaXN0YW5jZSBwZXIgcGFnZSwgYmVmb3JlIGl0IGlzIGhpZGRlbgoJdmFyIHNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZSwKCQlzZXRMYXN0U2Nyb2xsLCBkZWxheWVkU2V0TGFzdFNjcm9sbDsKCglzZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbiB0aGUgYnJvd3NlcgoJCS8vIHNjcm9sbGluZyB0aGUgd2luZG93IGJhc2VkIG9uIGEgaGFzaGNoYW5nZQoJCWlmICggIXNldExhc3RTY3JvbGxFbmFibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgYWN0aXZlID0gJC5tb2JpbGUudXJsSGlzdG9yeS5nZXRBY3RpdmUoKTsKCgkJaWYgKCBhY3RpdmUgKSB7CgkJCXZhciBsYXN0U2Nyb2xsID0gJHdpbmRvdy5zY3JvbGxUb3AoKTsKCgkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4KCQkJLy8gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlIHNjcm9sbGluZyB0byBpcyBsZXNzIHRoYW4gbWluU2Nyb2xsQmFjaywgbGV0IGl0IGdvLgoJCQlhY3RpdmUubGFzdFNjcm9sbCA9IGxhc3RTY3JvbGwgPCAkLm1vYmlsZS5taW5TY3JvbGxCYWNrID8gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgOiBsYXN0U2Nyb2xsOwoJCX0KCX07CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIHRvIGdhdGhlciBzY3JvbGwgcG9zaXRpb24uIFRoZSBkZWxheSBhbGxvd3MgZm9yIHRoZSBoYXNoY2hhbmdlCgkvLyBldmVudCB0byBmaXJlIGFuZCBkaXNhYmxlIHNjcm9sbCByZWNvcmRpbmcgaW4gdGhlIGNhc2Ugd2hlcmUgdGhlIGJyb3dzZXIgc2Nyb2xscwoJLy8gdG8gdGhlIGhhc2ggdGFyZ2V0cyBsb2NhdGlvbiAoc29tZXRpbWVzIHRoZSB0b3Agb2YgdGhlIHBhZ2UpLiBvbmNlIHBhZ2VjaGFuZ2UgZmlyZXMKCS8vIGdldExhc3RTY3JvbGwgaXMgYWdhaW4gcGVybWl0dGVkIHRvIG9wZXJhdGUKCWRlbGF5ZWRTZXRMYXN0U2Nyb2xsID0gZnVuY3Rpb24oKSB7CgkJc2V0VGltZW91dCggc2V0TGFzdFNjcm9sbCwgMTAwICk7Cgl9OwoKCS8vIGRpc2FibGUgYW4gc2Nyb2xsIHNldHRpbmcgd2hlbiBhIGhhc2hjaGFuZ2UgaGFzIGJlZW4gZmlyZWQsIHRoaXMgb25seSB3b3JrcwoJLy8gYmVjYXVzZSB0aGUgcmVjb3JkaW5nIG9mIHRoZSBzY3JvbGwgcG9zaXRpb24gaXMgZGVsYXllZCBmb3IgMTAwbXMgYWZ0ZXIKCS8vIHRoZSBicm93c2VyIG1pZ2h0IGhhdmUgY2hhbmdlZCB0aGUgcG9zaXRpb24gYmVjYXVzZSBvZiB0aGUgaGFzaGNoYW5nZQoJJHdpbmRvdy5iaW5kKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSBmYWxzZTsKCX0pOwoKCS8vIGhhbmRsZSBpbml0aWFsIGhhc2hjaGFuZ2UgZnJvbSBjaHJvbWUgOigKCSR3aW5kb3cub25lKCAkLnN1cHBvcnQucHVzaFN0YXRlID8gInBvcHN0YXRlIiA6ICJoYXNoY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgkJc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJfSk7CgoJLy8gd2FpdCB1bnRpbCB0aGUgbW9iaWxlIHBhZ2UgY29udGFpbmVyIGhhcyBiZWVuIGRldGVybWluZWQgdG8gYmluZCB0byBwYWdlY2hhbmdlCgkkd2luZG93Lm9uZSggInBhZ2Vjb250YWluZXJjcmVhdGUiLCBmdW5jdGlvbigpIHsKCQkvLyBvbmNlIHRoZSBwYWdlIGhhcyBjaGFuZ2VkLCByZS1lbmFibGUgdGhlIHNjcm9sbCByZWNvcmRpbmcKCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLmJpbmQoICJwYWdlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CgoJCQlzZXRMYXN0U2Nyb2xsRW5hYmxlZCA9IHRydWU7CgoJCQkvLyByZW1vdmUgYW55IGJpbmRpbmcgdGhhdCBwcmV2aW91c2x5IGV4aXN0ZWQgb24gdGhlIGdldCBzY3JvbGwKCQkJLy8gd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgZGlmZmVyZW50IHRoYW4gdGhlIHNjcm9sbCBlbGVtZW50IGRldGVybWluZWQgZm9yCgkJCS8vIHRoaXMgcGFnZSBwcmV2aW91c2x5CgkJCSR3aW5kb3cudW5iaW5kKCAic2Nyb2xsc3RvcCIsIGRlbGF5ZWRTZXRMYXN0U2Nyb2xsICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlIHdpbmRvdwoJCQkvLyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB3aXRoIHRvdWNoIG92ZXJmbG93CgkJCSR3aW5kb3cuYmluZCggInNjcm9sbHN0b3AiLCBkZWxheWVkU2V0TGFzdFNjcm9sbCApOwoJCX0pOwoJfSk7CgoJLy8gYmluZCB0byBzY3JvbGxzdG9wIGZvciB0aGUgZmlyc3QgcGFnZSBhcyAicGFnZWNoYW5nZSIgd29uJ3QgYmUgZmlyZWQgaW4gdGhhdCBjYXNlCgkkd2luZG93LmJpbmQoICJzY3JvbGxzdG9wIiwgZGVsYXllZFNldExhc3RTY3JvbGwgKTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvL2Z1bmN0aW9uIGZvciB0cmFuc2l0aW9uaW5nIGJldHdlZW4gdHdvIGV4aXN0aW5nIHBhZ2VzCglmdW5jdGlvbiB0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHRyYW5zaXRpb24sIHJldmVyc2UgKSB7CgkJaWYgKCBmcm9tUGFnZSApIHsKCQkJLy90cmlnZ2VyIGJlZm9yZSBzaG93L2hpZGUgZXZlbnRzCgkJCWZyb21QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZWhpZGUiLCBudWxsLCB7IG5leHRQYWdlOiB0b1BhZ2UgfSApOwoJCX0KCgkJdG9QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggImJlZm9yZXNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCgkJLy9jbGVhciBwYWdlIGxvYWRlcgoJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoKCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJLy9maW5kIHRoZSB0cmFuc2l0aW9uIGhhbmRsZXIgZm9yIHRoZSBzcGVjaWZpZWQgdHJhbnNpdGlvbi4gSWYgdGhlcmUKCQkvL2lzbid0IG9uZSBpbiBvdXIgdHJhbnNpdGlvbkhhbmRsZXJzIGRpY3Rpb25hcnksIHVzZSB0aGUgZGVmYXVsdCBvbmUuCgkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCXZhciB0aCA9ICQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVyc1sgdHJhbnNpdGlvbiB8fCAiZGVmYXVsdCIgXSB8fCAkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIsCgkJCXByb21pc2UgPSB0aCggdHJhbnNpdGlvbiwgcmV2ZXJzZSwgdG9QYWdlLCBmcm9tUGFnZSApOwoKCQlwcm9taXNlLmRvbmUoZnVuY3Rpb24oKSB7CgkJCS8vdHJpZ2dlciBzaG93L2hpZGUgZXZlbnRzCgkJCWlmICggZnJvbVBhZ2UgKSB7CgkJCQlmcm9tUGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkuX3RyaWdnZXIoICJoaWRlIiwgbnVsbCwgeyBuZXh0UGFnZTogdG9QYWdlIH0gKTsKCQkJfQoKCQkJLy90cmlnZ2VyIHBhZ2VzaG93LCBkZWZpbmUgcHJldlBhZ2UgYXMgZWl0aGVyIGZyb21QYWdlIG9yIGVtcHR5IGpRdWVyeSBvYmoKCQkJdG9QYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5fdHJpZ2dlciggInNob3ciLCBudWxsLCB7IHByZXZQYWdlOiBmcm9tUGFnZSB8fCAkKCAiIiApIH0gKTsKCQl9KTsKCgkJcmV0dXJuIHByb21pc2U7Cgl9CgoJLy9zaW1wbHkgc2V0IHRoZSBhY3RpdmUgcGFnZSdzIG1pbmltdW0gaGVpZ2h0IHRvIHNjcmVlbiBoZWlnaHQsIGRlcGVuZGluZyBvbiBvcmllbnRhdGlvbgoJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ID0gZnVuY3Rpb24gcmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBoZWlnaHQgKSB7CgkJdmFyIGFQYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCWFQYWdlUGFkVCA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggInBhZGRpbmctdG9wIiApICksCgkJCWFQYWdlUGFkQiA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggInBhZGRpbmctYm90dG9tIiApICksCgkJCWFQYWdlQm9yZGVyVCA9IHBhcnNlRmxvYXQoIGFQYWdlLmNzcyggImJvcmRlci10b3Atd2lkdGgiICkgKSwKCQkJYVBhZ2VCb3JkZXJCID0gcGFyc2VGbG9hdCggYVBhZ2UuY3NzKCAiYm9yZGVyLWJvdHRvbS13aWR0aCIgKSApOwoKCQloZWlnaHQgPSAoIHR5cGVvZiBoZWlnaHQgPT09ICJudW1iZXIiICk/IGhlaWdodCA6IGdldFNjcmVlbkhlaWdodCgpOwoJCQoJCWFQYWdlLmNzcyggIm1pbi1oZWlnaHQiLCBoZWlnaHQgLSBhUGFnZVBhZFQgLSBhUGFnZVBhZEIgLSBhUGFnZUJvcmRlclQgLSBhUGFnZUJvcmRlckIgKTsKCX07CgoJLy9zaGFyZWQgcGFnZSBlbmhhbmNlbWVudHMKCWZ1bmN0aW9uIGVuaGFuY2VQYWdlKCAkcGFnZSwgcm9sZSApIHsKCQkvLyBJZiBhIHJvbGUgd2FzIHNwZWNpZmllZCwgbWFrZSBzdXJlIHRoZSBkYXRhLXJvbGUgYXR0cmlidXRlCgkJLy8gb24gdGhlIHBhZ2UgZWxlbWVudCBpcyBpbiBzeW5jLgoJCWlmICggcm9sZSApIHsKCQkJJHBhZ2UuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCByb2xlICk7CgkJfQoKCQkvL3J1biBwYWdlIHBsdWdpbgoJCSRwYWdlLnBhZ2UoKTsKCX0KCgkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCWZ1bmN0aW9uIGZpbmRCYXNlV2l0aERlZmF1bHQoKSB7CgkJdmFyIGNsb3Nlc3RCYXNlID0gKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmIGdldENsb3Nlc3RCYXNlVXJsKCAkLm1vYmlsZS5hY3RpdmVQYWdlICkgKTsKCQlyZXR1cm4gY2xvc2VzdEJhc2UgfHwgZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7Cgl9CgoJLyogZXhwb3NlZCAkLm1vYmlsZSBtZXRob2RzICovCgoJLy9hbmltYXRpb24gY29tcGxldGUgY2FsbGJhY2sKCSQuZm4uYW5pbWF0aW9uQ29tcGxldGUgPSBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJaWYgKCAkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgKSB7CgkJCXJldHVybiAkKCB0aGlzICkub25lKCAnd2Via2l0QW5pbWF0aW9uRW5kIGFuaW1hdGlvbmVuZCcsIGNhbGxiYWNrICk7CgkJfQoJCWVsc2V7CgkJCS8vIGRlZmVyIGV4ZWN1dGlvbiBmb3IgY29uc2lzdGVuY3kgYmV0d2VlbiB3ZWJraXQvbm9uIHdlYmtpdAoJCQlzZXRUaW1lb3V0KCBjYWxsYmFjaywgMCApOwoJCQlyZXR1cm4gJCggdGhpcyApOwoJCX0KCX07CgoJLy9leHBvc2UgcGF0aCBvYmplY3Qgb24gJC5tb2JpbGUKCSQubW9iaWxlLnBhdGggPSBwYXRoOwoKCS8vZXhwb3NlIGJhc2Ugb2JqZWN0IG9uICQubW9iaWxlCgkkLm1vYmlsZS5iYXNlID0gYmFzZTsKCgkvL2hpc3Rvcnkgc3RhY2sKCSQubW9iaWxlLnVybEhpc3RvcnkgPSB1cmxIaXN0b3J5OwoKCSQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgPSBkaWFsb2dIYXNoS2V5OwoKCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCSQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyA9IGZhbHNlOwoKCSQubW9iaWxlLl9iaW5kUGFnZVJlbW92ZSA9IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gJCggdGhpcyApOwoKCQkvLyB3aGVuIGRvbSBjYWNoaW5nIGlzIG5vdCBlbmFibGVkIG9yIHRoZSBwYWdlIGlzIGVtYmVkZGVkIGJpbmQgdG8gcmVtb3ZlIHRoZSBwYWdlIG9uIGhpZGUKCQlpZiAoICFwYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlICYmCgkJCXBhZ2UuaXMoICI6anFtRGF0YShleHRlcm5hbC1wYWdlPSd0cnVlJykiICkgKSB7CgoJCQlwYWdlLmJpbmQoICdwYWdlaGlkZS5yZW1vdmUnLCBmdW5jdGlvbiggZSApIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQlwckV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlcmVtb3ZlIiApOwoKCQkJCSR0aGlzLnRyaWdnZXIoIHByRXZlbnQgKTsKCgkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCSR0aGlzLnJlbW92ZVdpdGhEZXBlbmRlbnRzKCk7CgkJCQl9CgkJCX0pOwoJCX0KCX07CgoJLy8gTG9hZCBhIHBhZ2UgaW50byB0aGUgRE9NLgoJJC5tb2JpbGUubG9hZFBhZ2UgPSBmdW5jdGlvbiggdXJsLCBvcHRpb25zICkgewoJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJLy8ga25vdyB3aGVuIHRoZSBwYWdlIGlzIGRvbmUgbG9hZGluZywgb3IgaWYgYW4gZXJyb3IgaGFzIG9jY3VycmVkLgoJCXZhciBkZWZlcnJlZCA9ICQuRGVmZXJyZWQoKSwKCgkJCS8vIFRoZSBkZWZhdWx0IGxvYWRQYWdlIG9wdGlvbnMgd2l0aCBvdmVycmlkZXMgc3BlY2lmaWVkIGJ5CgkJCS8vIHRoZSBjYWxsZXIuCgkJCXNldHRpbmdzID0gJC5leHRlbmQoIHt9LCAkLm1vYmlsZS5sb2FkUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJLy8gVGhlIERPTSBlbGVtZW50IGZvciB0aGUgcGFnZSBhZnRlciBpdCBoYXMgYmVlbiBsb2FkZWQuCgkJCXBhZ2UgPSBudWxsLAoKCQkJLy8gSWYgdGhlIHJlbG9hZFBhZ2Ugb3B0aW9uIGlzIHRydWUsIGFuZCB0aGUgcGFnZSBpcyBhbHJlYWR5CgkJCS8vIGluIHRoZSBET00sIGR1cENhY2hlZFBhZ2Ugd2lsbCBiZSBzZXQgdG8gdGhlIHBhZ2UgZWxlbWVudAoJCQkvLyBzbyB0aGF0IGl0IGNhbiBiZSByZW1vdmVkIGFmdGVyIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUKCQkJLy8gcGFnZSBpcyBsb2FkZWQgb2ZmIHRoZSBuZXR3b3JrLgoJCQlkdXBDYWNoZWRQYWdlID0gbnVsbCwKCgkJCS8vIFRoZSBhYnNvbHV0ZSB2ZXJzaW9uIG9mIHRoZSBVUkwgcGFzc2VkIGludG8gdGhlIGZ1bmN0aW9uLiBUaGlzCgkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3VicGFnZSBwYXJhbXMgaW4gaXQuCgkJCWFic1VybCA9IHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGZpbmRCYXNlV2l0aERlZmF1bHQoKSApOwoKCQkvLyBJZiB0aGUgY2FsbGVyIHByb3ZpZGVkIGRhdGEsIGFuZCB3ZSdyZSB1c2luZyAiZ2V0IiByZXF1ZXN0LAoJCS8vIGFwcGVuZCB0aGUgZGF0YSB0byB0aGUgVVJMLgoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJYWJzVXJsID0gcGF0aC5hZGRTZWFyY2hQYXJhbXMoIGFic1VybCwgc2V0dGluZ3MuZGF0YSApOwoJCQlzZXR0aW5ncy5kYXRhID0gdW5kZWZpbmVkOwoJCX0KCgkJLy8gSWYgdGhlIGNhbGxlciBpcyB1c2luZyBhICJwb3N0IiByZXF1ZXN0LCByZWxvYWRQYWdlIG11c3QgYmUgdHJ1ZQoJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAicG9zdCIgKSB7CgkJCXNldHRpbmdzLnJlbG9hZFBhZ2UgPSB0cnVlOwoJCX0KCgkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YnBhZ2UgcGFyYW1zLgoJCS8vIEluIG90aGVyd29yZHMgdGhlIHJlYWwgVVJMIG9mIHRoZSBwYWdlIHRvIGJlIGxvYWRlZC4KCQl2YXIgZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoIGFic1VybCApLAoKCQkJLy8gVGhlIHZlcnNpb24gb2YgdGhlIFVybCBhY3R1YWxseSBzdG9yZWQgaW4gdGhlIGRhdGEtdXJsIGF0dHJpYnV0ZSBvZgoJCQkvLyB0aGUgcGFnZS4gRm9yIGVtYmVkZGVkIHBhZ2VzLCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yIHBhZ2VzCgkJCS8vIHdpdGhpbiB0aGUgc2FtZSBkb21haW4gYXMgdGhlIGRvY3VtZW50IGJhc2UsIGl0IGlzIHRoZSBzaXRlIHJlbGF0aXZlCgkJCS8vIHBhdGguIEZvciBjcm9zcy1kb21haW4gcGFnZXMgKFBob25lIEdhcCBvbmx5KSB0aGUgZW50aXJlIGFic29sdXRlIFVybAoJCQkvLyB1c2VkIHRvIGxvYWQgdGhlIHBhZ2UuCgkJCWRhdGFVcmwgPSBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGFic1VybCApOwoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHBhZ2VDb250YWluZXIgdG8gd29yayB3aXRoLgoJCXNldHRpbmdzLnBhZ2VDb250YWluZXIgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB0aGUgcGFnZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgRE9NLgoJCS8vIE5PVEUgZG8gX25vdF8gdXNlIHRoZSA6anFtRGF0YSBwc3VlZG8gc2VsZWN0b3IgYmVjYXVzZSBwYXJlbnRoZXNpcwoJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJcGFnZSA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIuY2hpbGRyZW4oICJbZGF0YS0iICsgJC5tb2JpbGUubnMgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoKCQkvLyBJZiB3ZSBmYWlsZWQgdG8gZmluZCB0aGUgcGFnZSwgY2hlY2sgdG8gc2VlIGlmIHRoZSB1cmwgaXMgYQoJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCS8vIGluamVjdGVkIGJ5IGEgZGV2ZWxvcGVyLCBpbiB3aGljaCBjYXNlIGl0IHdvdWxkIGJlIGxhY2tpbmcgYSBkYXRhLXVybAoJCS8vIGF0dHJpYnV0ZSBhbmQgaW4gbmVlZCBvZiBlbmhhbmNlbWVudC4KCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgIXBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiIyIgKyBkYXRhVXJsICkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgZGF0YVVybCApCgkJCQkuanFtRGF0YSggInVybCIsIGRhdGFVcmwgKTsKCQl9CgoJCQoJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCS8vIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgYXBwbGljYXRpb24uIElmIGl0IGlzbid0IGEgcmVmZXJlbmNlCgkJLy8gdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlZmVycyB0byBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSwgZXJyb3Igb3V0LgoJCWlmICggcGFnZS5sZW5ndGggPT09IDAgKSB7CgkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlICYmIHBhdGguaXNGaXJzdFBhZ2VVcmwoIGZpbGVVcmwgKSApIHsKCQkJCS8vIENoZWNrIHRvIG1ha2Ugc3VyZSBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkKCQkJCS8vIGluIHRoZSBET00uIFNvbWUgdXNlciBkZXBsb3llZCBhcHBzIGFyZSBwcnVuaW5nIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBmcm9tIHRoZSBET00gZm9yIHZhcmlvdXMgcmVhc29ucywgd2UgY2hlY2sgZm9yIHRoaXMKCQkJCS8vIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGggYW4gaWQKCQkJCS8vIGZhbGxpbmcgdGhyb3VnaCB0byB0aGUgbm9uLWV4aXN0ZW50IGVtYmVkZGVkIHBhZ2UgZXJyb3IKCQkJCS8vIGNhc2UuIElmIHRoZSBmaXJzdC1wYWdlIGlzIG5vdCBpbiB0aGUgRE9NLCB0aGVuIHdlIGxldAoJCQkJLy8gdGhpbmdzIGZhbGwgdGhyb3VnaCB0byB0aGUgYWpheCBsb2FkaW5nIGNvZGUgYmVsb3cgc28KCQkJCS8vIHRoYXQgaXQgZ2V0cyByZWxvYWRlZC4KCQkJCWlmICggJC5tb2JpbGUuZmlyc3RQYWdlLnBhcmVudCgpLmxlbmd0aCApIHsKCQkJCQlwYWdlID0gJCggJC5tb2JpbGUuZmlyc3RQYWdlICk7CgkJCQl9CgkJCX0gZWxzZSBpZiAoIHBhdGguaXNFbWJlZGRlZFBhZ2UoIGZpbGVVcmwgKSAgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCX0KCQkKCQkvLyBJZiB0aGUgcGFnZSB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJLy8gYW5kIHRoZSBjYWxsZXIgZGlkIG5vdCBpbmRpY2F0ZSB0aGF0IHdlIHNob3VsZCBmb3JjZSBhCgkJLy8gcmVsb2FkIG9mIHRoZSBmaWxlLCB3ZSBhcmUgZG9uZS4gT3RoZXJ3aXNlLCB0cmFjayB0aGUKCQkvLyBleGlzdGluZyBwYWdlIGFzIGEgZHVwbGljYXRlZC4KCQlpZiAoIHBhZ2UubGVuZ3RoICkgewoJCQlpZiAoICFzZXR0aW5ncy5yZWxvYWRQYWdlICkgewoJCQkJZW5oYW5jZVBhZ2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCQkJCWRlZmVycmVkLnJlc29sdmUoIGFic1VybCwgb3B0aW9ucywgcGFnZSApOwoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBwYWdlIG1ha2Ugc3VyZSB3ZSB1cGRhdGUgdGhlIGJhc2UgaWYgaXRzIG5vdCBhIHByZWZldGNoIAoJCQkJaWYoIGJhc2UgJiYgIW9wdGlvbnMucHJlZmV0Y2ggKXsKCQkJCQliYXNlLnNldCh1cmwpOwoJCQkJfQoJCQkJcmV0dXJuIGRlZmVycmVkLnByb21pc2UoKTsKCQkJfQoJCQlkdXBDYWNoZWRQYWdlID0gcGFnZTsKCQl9CgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBibEV2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlbG9hZCIgKSwKCQkJdHJpZ2dlckRhdGEgPSB7IHVybDogdXJsLCBhYnNVcmw6IGFic1VybCwgZGF0YVVybDogZGF0YVVybCwgZGVmZXJyZWQ6IGRlZmVycmVkLCBvcHRpb25zOiBzZXR0aW5ncyB9OwoKCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBhIHBhZ2UuCgkJbXBjLnRyaWdnZXIoIHBibEV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQlpZiAoIHBibEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQlyZXR1cm4gZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCgkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCgkJCS8vIFRoaXMgY29uZmlndXJhYmxlIHRpbWVvdXQgYWxsb3dzIGNhY2hlZCBwYWdlcyBhIGJyaWVmIGRlbGF5IHRvIGxvYWQgd2l0aG91dCBzaG93aW5nIGEgbWVzc2FnZQoJCQl2YXIgbG9hZE1zZ0RlbGF5ID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCQkJCX0sIHNldHRpbmdzLmxvYWRNc2dEZWxheSApLAoKCQkJCS8vIFNoYXJlZCBsb2dpYyBmb3IgY2xlYXJpbmcgdGltZW91dCBhbmQgcmVtb3ZpbmcgbWVzc2FnZS4KCQkJCWhpZGVNc2cgPSBmdW5jdGlvbigpIHsKCgkJCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJCQljbGVhclRpbWVvdXQoIGxvYWRNc2dEZWxheSApOwoKCQkJCQkvLyBIaWRlIGxvYWRpbmcgbWVzc2FnZQoJCQkJCSQubW9iaWxlLmhpZGVQYWdlTG9hZGluZ01zZygpOwoJCQkJfTsKCQl9CgkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCS8vIG9ubHkgcmVzZXQgaWYgd2UgYXJlIG5vdCBwcmVmZXRjaGluZyAKCQlpZiAoIGJhc2UgJiYgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiICkgewoJCQliYXNlLnJlc2V0KCk7CgkJfQoKCQlpZiAoICEoICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyB8fCBwYXRoLmlzU2FtZURvbWFpbiggZG9jdW1lbnRVcmwsIGFic1VybCApICkgKSB7CgkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBvcHRpb25zICk7CgkJfSBlbHNlIHsKCQkJLy8gTG9hZCB0aGUgbmV3IHBhZ2UuCgkJCSQuYWpheCh7CgkJCQl1cmw6IGZpbGVVcmwsCgkJCQl0eXBlOiBzZXR0aW5ncy50eXBlLAoJCQkJZGF0YTogc2V0dGluZ3MuZGF0YSwKCQkJCWNvbnRlbnRUeXBlOiBzZXR0aW5ncy5jb250ZW50VHlwZSwKCQkJCWRhdGFUeXBlOiAiaHRtbCIsCgkJCQlzdWNjZXNzOiBmdW5jdGlvbiggaHRtbCwgdGV4dFN0YXR1cywgeGhyICkgewoJCQkJCS8vcHJlLXBhcnNlIGh0bWwgdG8gY2hlY2sgZm9yIGEgZGF0YS11cmwsCgkJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJCXZhciBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICksCgoJCQkJCQkvL3BhZ2UgdGl0bGUgcmVnZXhwCgkJCQkJCW5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMSwKCgkJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQkJcGFnZUVsZW1SZWdleCA9IG5ldyBSZWdFeHAoICIoPFtePl0rXFxiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT1bXCInXT9wYWdlW1wiJ10/W14+XSo+KSIgKSwKCQkJCQkJZGF0YVVybFJlZ2V4ID0gbmV3IFJlZ0V4cCggIlxcYmRhdGEtIiArICQubW9iaWxlLm5zICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCgkJCQkJLy8gZGF0YS11cmwgbXVzdCBiZSBwcm92aWRlZCBmb3IgdGhlIGJhc2UgdGFnIHNvIHJlc291cmNlIHJlcXVlc3RzIGNhbiBiZSBkaXJlY3RlZCB0byB0aGUKCQkJCQkvLyBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeSBlbGVtZW50IG1ha2VzIHRoZXNlIHJlcXVlc3RzIGltbWVkaWF0ZWx5CgkJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCQkJUmVnRXhwLiQxICYmCgkJCQkJCQlkYXRhVXJsUmVnZXgudGVzdCggUmVnRXhwLiQxICkgJiYKCQkJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQkJdXJsID0gZmlsZVVybCA9IHBhdGguZ2V0RmlsZVBhdGgoICQoICI8ZGl2PiIgKyBSZWdFeHAuJDEgKyAiPC9kaXY+IiApLnRleHQoKSApOwoJCQkJCX0KCQkJCQkvL2RvbnQgdXBkYXRlIHRoZSBiYXNlIHRhZyBpZiB3ZSBhcmUgcHJlZmV0Y2hpbmcKCQkJCQlpZiAoIGJhc2UgJiYgdHlwZW9mIG9wdGlvbnMucHJlZmV0Y2ggPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCWJhc2Uuc2V0KCBmaWxlVXJsICk7CgkJCQkJfQoKCQkJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCQkJYWxsLmdldCggMCApLmlubmVySFRNTCA9IGh0bWw7CgkJCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJCQkvL2lmIHBhZ2UgZWxlbSBjb3VsZG4ndCBiZSBmb3VuZCwgY3JlYXRlIG9uZSBhbmQgaW5zZXJ0IHRoZSBib2R5IGVsZW1lbnQncyBjb250ZW50cwoJCQkJCWlmICggIXBhZ2UubGVuZ3RoICkgewoJCQkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSc+IiArICggaHRtbC5zcGxpdCggLzxcLz9ib2R5W14+XSo+L2dtaSApWzFdIHx8ICIiICkgKyAiPC9kaXY+IiApOwoJCQkJCX0KCgkJCQkJaWYgKCBuZXdQYWdlVGl0bGUgJiYgIXBhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQkJCQlpZiAoIH5uZXdQYWdlVGl0bGUuaW5kZXhPZiggIiYiICkgKSB7CgkJCQkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQkJCX0KCQkJCQkJcGFnZS5qcW1EYXRhKCAidGl0bGUiLCBuZXdQYWdlVGl0bGUgKTsKCQkJCQl9CgoJCQkJCS8vcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwKCQkJCQlpZiAoICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWcgKSB7CgkJCQkJCXZhciBuZXdQYXRoID0gcGF0aC5nZXQoIGZpbGVVcmwgKTsKCQkJCQkJcGFnZS5maW5kKCAiW3NyY10sIGxpbmtbaHJlZl0sIGFbcmVsPSdleHRlcm5hbCddLCA6anFtRGF0YShhamF4PSdmYWxzZScpLCBhW3RhcmdldF0iICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCQkJCXZhciB0aGlzQXR0ciA9ICQoIHRoaXMgKS5pcyggJ1tocmVmXScgKSA/ICdocmVmJyA6CgkJCQkJCQkJCSQoIHRoaXMgKS5pcyggJ1tzcmNdJyApID8gJ3NyYycgOiAnYWN0aW9uJywKCQkJCQkJCQl0aGlzVXJsID0gJCggdGhpcyApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCQkJCS8vaWYgZnVsbCBwYXRoIGV4aXN0cyBhbmQgaXMgc2FtZSwgY2hvcCBpdCAtIGhlbHBzIElFIG91dAoJCQkJCQkJdGhpc1VybCA9IHRoaXNVcmwucmVwbGFjZSggbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAnJyApOwoKCQkJCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkJCQkkKCB0aGlzICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJLy9hcHBlbmQgdG8gcGFnZSBhbmQgZW5oYW5jZQoJCQkJCS8vIFRPRE8gdGFnaW5nIGEgcGFnZSB3aXRoIGV4dGVybmFsIHRvIG1ha2Ugc3VyZSB0aGF0IGVtYmVkZGVkIHBhZ2VzIGFyZW4ndCByZW1vdmVkCgkJCQkJLy8gICAgICBieSB0aGUgdmFyaW91cyBwYWdlIGhhbmRsaW5nIGNvZGUgaXMgYmFkLiBIYXZpbmcgcGFnZSBoYW5kbGluZyBjb2RlIGluIG1hbnkKCQkJCQkvLyAgICAgIHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQkJCXBhZ2UKCQkJCQkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCBwYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoIGZpbGVVcmwgKSApCgkJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKQoJCQkJCQkuYXBwZW5kVG8oIHNldHRpbmdzLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJLy8gd2FpdCBmb3IgcGFnZSBjcmVhdGlvbiB0byBsZXZlcmFnZSBvcHRpb25zIGRlZmluZWQgb24gd2lkZ2V0CgkJCQkJcGFnZS5vbmUoICdwYWdlY3JlYXRlJywgJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlICk7CgoJCQkJCWVuaGFuY2VQYWdlKCBwYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCQkJCS8vIEVuaGFuY2luZyB0aGUgcGFnZSBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBwYWdlcyBiZWluZyBpbnNlcnRlZAoJCQkJCS8vIGludG8gdGhlIERPTS4gSWYgdGhlIG9yaWdpbmFsIGFic1VybCByZWZlcnMgdG8gYSBzdWItcGFnZSwgdGhhdCBpcyB0aGUKCQkJCQkvLyByZWFsIHBhZ2Ugd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQkJaWYgKCBhYnNVcmwuaW5kZXhPZiggIiYiICsgJC5tb2JpbGUuc3ViUGFnZVVybEtleSApID4gLTEgKSB7CgkJCQkJCXBhZ2UgPSBzZXR0aW5ncy5wYWdlQ29udGFpbmVyLmNoaWxkcmVuKCAiW2RhdGEtIiArICQubW9iaWxlLm5zICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCQkJCQl9CgoJCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCQkJaGlkZU1zZygpOwoJCQkJCX0KCgkJCQkJLy8gQWRkIHRoZSBwYWdlIHJlZmVyZW5jZSBhbmQgeGhyIHRvIG91ciB0cmlnZ2VyRGF0YS4KCQkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQkJdHJpZ2dlckRhdGEucGFnZSA9IHBhZ2U7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2Vsb2FkIiwgdHJpZ2dlckRhdGEgKTsKCgkJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBvcHRpb25zLCBwYWdlLCBkdXBDYWNoZWRQYWdlICk7CgkJCQl9LAoJCQkJZXJyb3I6IGZ1bmN0aW9uKCB4aHIsIHRleHRTdGF0dXMsIGVycm9yVGhyb3duICkgewoJCQkJCS8vc2V0IGJhc2UgYmFjayB0byBjdXJyZW50IHBhdGgKCQkJCQlpZiAoIGJhc2UgKSB7CgkJCQkJCWJhc2Uuc2V0KCBwYXRoLmdldCgpICk7CgkJCQkJfQoKCQkJCQkvLyBBZGQgZXJyb3IgaW5mbyB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJCXRyaWdnZXJEYXRhLnRleHRTdGF0dXMgPSB0ZXh0U3RhdHVzOwoJCQkJCXRyaWdnZXJEYXRhLmVycm9yVGhyb3duID0gZXJyb3JUaHJvd247CgoJCQkJCXZhciBwbGZFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZWxvYWRmYWlsZWQiICk7CgoJCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCQlzZXR0aW5ncy5wYWdlQ29udGFpbmVyLnRyaWdnZXIoIHBsZkV2ZW50LCB0cmlnZ2VyRGF0YSApOwoKCQkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCQkvLyBOb3RlIHRoYXQgaXQgaXMgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBsaXN0ZW5lci9oYW5kbGVyCgkJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQkJaWYgKCBwbGZFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoKCQkJCQkJLy8gUmVtb3ZlIGxvYWRpbmcgbWVzc2FnZS4KCQkJCQkJaGlkZU1zZygpOwoKCQkJCQkJLy8gc2hvdyBlcnJvciBtZXNzYWdlCgkJCQkJCSQubW9iaWxlLnNob3dQYWdlTG9hZGluZ01zZyggJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZSwgJC5tb2JpbGUucGFnZUxvYWRFcnJvck1lc3NhZ2UsIHRydWUgKTsKCgkJCQkJCS8vIGhpZGUgYWZ0ZXIgZGVsYXkKCQkJCQkJc2V0VGltZW91dCggJC5tb2JpbGUuaGlkZVBhZ2VMb2FkaW5nTXNnLCAxNTAwICk7CgkJCQkJfQoKCQkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgb3B0aW9ucyApOwoJCQkJfQoJCQl9KTsKCQl9CgoJCXJldHVybiBkZWZlcnJlZC5wcm9taXNlKCk7Cgl9OwoKCSQubW9iaWxlLmxvYWRQYWdlLmRlZmF1bHRzID0gewoJCXR5cGU6ICJnZXQiLAoJCWRhdGE6IHVuZGVmaW5lZCwKCQlyZWxvYWRQYWdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlzaG93TG9hZE1zZzogZmFsc2UsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCWxvYWRNc2dEZWxheTogNTAgLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0byBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCX07CgoJLy8gU2hvdyBhIHNwZWNpZmljIHBhZ2UgaW4gdGhlIHBhZ2UgY29udGFpbmVyLgoJJC5tb2JpbGUuY2hhbmdlUGFnZSA9IGZ1bmN0aW9uKCB0b1BhZ2UsIG9wdGlvbnMgKSB7CgkJLy8gSWYgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBhIHRyYW5zaXRpb24sIHF1ZXVlIHRoZSBjdXJyZW50IHJlcXVlc3QuCgkJLy8gV2UnbGwgY2FsbCBjaGFuZ2VQYWdlKCkgb25jZSB3ZSdyZSBkb25lIHdpdGggdGhlIGN1cnJlbnQgdHJhbnNpdGlvbiB0bwoJCS8vIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJaWYgKCBpc1BhZ2VUcmFuc2l0aW9uaW5nICkgewoJCQlwYWdlVHJhbnNpdGlvblF1ZXVlLnVuc2hpZnQoIGFyZ3VtZW50cyApOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sICQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMsIG9wdGlvbnMgKSwgaXNUb1BhZ2VTdHJpbmc7CgoJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgcGFnZUNvbnRhaW5lciB0byB3b3JrIHdpdGguCgkJc2V0dGluZ3MucGFnZUNvbnRhaW5lciA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIgfHwgJC5tb2JpbGUucGFnZUNvbnRhaW5lcjsKCgkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSBmcm9tUGFnZS4KCQlzZXR0aW5ncy5mcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlIHx8ICQubW9iaWxlLmFjdGl2ZVBhZ2U7CgoJCWlzVG9QYWdlU3RyaW5nID0gKHR5cGVvZiB0b1BhZ2UgPT09ICJzdHJpbmciKTsKCgkJdmFyIG1wYyA9IHNldHRpbmdzLnBhZ2VDb250YWluZXIsCgkJCXBiY0V2ZW50ID0gbmV3ICQuRXZlbnQoICJwYWdlYmVmb3JlY2hhbmdlIiApLAoJCQl0cmlnZ2VyRGF0YSA9IHsgdG9QYWdlOiB0b1BhZ2UsIG9wdGlvbnM6IHNldHRpbmdzIH07CgoJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZSBzaW1wbGlmaWVkCgkJLy8gICAgICAgZWcsIHJlbW92aW5nIHVpLXN0YXRlLCBhbmQgcmVtb3ZpbmcgcXVlcnkgcGFyYW1zIGZyb20gdGhlIGhhc2gKCQkvLyAgICAgICB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtCgkJLy8gICAgICAgaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCWlmICggaXNUb1BhZ2VTdHJpbmcgKSB7CgkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBzdHJpbmcgc2ltcGx5IGNvbnZlcnQgaXQKCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvUGFnZSwgZmluZEJhc2VXaXRoRGVmYXVsdCgpICk7CgkJfSBlbHNlIHsKCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIGpRdWVyeSBvYmplY3QgZ3JhYiB0aGUgYWJzb2x1dGUgdXJsIHN0b3JlZAoJCQkvLyBpbiB0aGUgbG9hZFBhZ2UgY2FsbGJhY2sgd2hlcmUgaXQgZXhpc3RzCgkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHRvUGFnZS5kYXRhKCAnYWJzVXJsJyApOwoJCX0KCgkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCW1wYy50cmlnZ2VyKCBwYmNFdmVudCwgdHJpZ2dlckRhdGEgKTsKCgkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvUGFnZSBpbiB0aGUgdHJpZ2dlcgoJCS8vIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0b1BhZ2UgaXMgdXBkYXRlZC4KCQkvLwoJCS8vIFdlIGFsc28gbmVlZCB0byByZS1ldmFsdWF0ZSB3aGV0aGVyIGl0IGlzIGEgc3RyaW5nLCBiZWNhdXNlIGFuIG9iamVjdCBjYW4KCQkvLyBhbHNvIGJlIHJlcGxhY2VkIGJ5IGEgc3RyaW5nCgoJCXRvUGFnZSA9IHRyaWdnZXJEYXRhLnRvUGFnZTsKCQlpc1RvUGFnZVN0cmluZyA9ICh0eXBlb2YgdG9QYWdlID09PSAic3RyaW5nIik7CgoJCS8vIFNldCB0aGUgaXNQYWdlVHJhbnNpdGlvbmluZyBmbGFnIHRvIHByZXZlbnQgYW55IHJlcXVlc3RzIGZyb20KCQkvLyBlbnRlcmluZyB0aGlzIG1ldGhvZCB3aGlsZSB3ZSBhcmUgaW4gdGhlIG1pZHN0IG9mIGxvYWRpbmcgYSBwYWdlCgkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gdHJ1ZTsKCgkJLy8gSWYgdGhlIGNhbGxlciBwYXNzZWQgdXMgYSB1cmwsIGNhbGwgbG9hZFBhZ2UoKQoJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkvLyB0byB0aGUgcHJvbWlzZSBvYmplY3QgaXQgcmV0dXJucyBzbyB3ZSBrbm93IHdoZW4KCQkvLyBpdCBpcyBkb25lIGxvYWRpbmcgb3IgaWYgYW4gZXJyb3Igb2N1cnJlZC4KCQlpZiAoIGlzVG9QYWdlU3RyaW5nICkgewoJCQkvLyBwcmVzZXJ2ZSB0aGUgb3JpZ2luYWwgdGFyZ2V0IGFzIHRoZSBkYXRhVXJsIHZhbHVlIHdpbGwgYmUgc2ltcGxpZmllZAoJCQkvLyBlZywgcmVtb3ZpbmcgdWktc3RhdGUsIGFuZCByZW1vdmluZyBxdWVyeSBwYXJhbXMgZnJvbSB0aGUgaGFzaAoJCQkvLyB0aGlzIGlzIHNvIHRoYXQgdXNlcnMgd2hvIHdhbnQgdG8gdXNlIHF1ZXJ5IHBhcmFtcyBoYXZlIGFjY2VzcyB0byB0aGVtCgkJCS8vIGluIHRoZSBldmVudCBiaW5kaW5ncyBmb3IgdGhlIHBhZ2UgbGlmZSBjeWNsZSBTZWUgaXNzdWUgIzUwODUKCQkJc2V0dGluZ3MudGFyZ2V0ID0gdG9QYWdlOwoKCQkJJC5tb2JpbGUubG9hZFBhZ2UoIHRvUGFnZSwgc2V0dGluZ3MgKQoJCQkJLmRvbmUoZnVuY3Rpb24oIHVybCwgb3B0aW9ucywgbmV3UGFnZSwgZHVwQ2FjaGVkUGFnZSApIHsKCQkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQkJb3B0aW9ucy5kdXBsaWNhdGVDYWNoZWRQYWdlID0gZHVwQ2FjaGVkUGFnZTsKCgkJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJCS8vIHRvIGV2ZW50cyBpbiB0aGUgdHJpZ2dlckRhdGEgb2YgdGhlIHN1YnNlcXVlbnQgY2hhbmdlUGFnZSBjYWxsCgkJCQkJbmV3UGFnZS5kYXRhKCAnYWJzVXJsJywgdHJpZ2dlckRhdGEuYWJzVXJsICk7CgkJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggbmV3UGFnZSwgb3B0aW9ucyApOwoJCQkJfSkKCQkJCS5mYWlsKGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgoJCQkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCQkJcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgoJCQkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCQkJcmVsZWFzZVBhZ2VUcmFuc2l0aW9uTG9jaygpOwoJCQkJCXNldHRpbmdzLnBhZ2VDb250YWluZXIudHJpZ2dlciggInBhZ2VjaGFuZ2VmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoJCQkJfSk7CgkJCXJldHVybjsKCQl9CgoJCS8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZmlyc3QtcGFnZSBvZiB0aGUgYXBwbGljYXRpb24sIHdlIG5lZWQgdG8gbWFrZQoJCS8vIHN1cmUgc2V0dGluZ3MuZGF0YVVybCBpcyBzZXQgdG8gdGhlIGFwcGxpY2F0aW9uIGRvY3VtZW50IHVybC4gVGhpcyBhbGxvd3MKCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkvLyBmaXJzdC1wYWdlIG9mIHRoZSBkb2N1bWVudCBoYXMgYW4gaWQgYXR0cmlidXRlIHNwZWNpZmllZC4KCQlpZiAoIHRvUGFnZVsgMCBdID09PSAkLm1vYmlsZS5maXJzdFBhZ2VbIDAgXSAmJiAhc2V0dGluZ3MuZGF0YVVybCApIHsKCQkJc2V0dGluZ3MuZGF0YVVybCA9IGRvY3VtZW50VXJsLmhyZWZOb0hhc2g7CgkJfQoKCQkvLyBUaGUgY2FsbGVyIHBhc3NlZCB1cyBhIHJlYWwgcGFnZSBET00gZWxlbWVudC4gVXBkYXRlIG91cgoJCS8vIGludGVybmFsIHN0YXRlIGFuZCB0aGVuIHRyaWdnZXIgYSB0cmFuc2l0aW9uIHRvIHRoZSBwYWdlLgoJCXZhciBmcm9tUGFnZSA9IHNldHRpbmdzLmZyb21QYWdlLAoJCQl1cmwgPSAoIHNldHRpbmdzLmRhdGFVcmwgJiYgcGF0aC5jb252ZXJ0VXJsVG9EYXRhVXJsKCBzZXR0aW5ncy5kYXRhVXJsICkgKSB8fCB0b1BhZ2UuanFtRGF0YSggInVybCIgKSwKCQkJLy8gVGhlIHBhZ2VVcmwgdmFyIGlzIHVzdWFsbHkgdGhlIHNhbWUgYXMgdXJsLCBleGNlcHQgd2hlbiB1cmwgaXMgb2JzY3VyZWQgYXMgYSBkaWFsb2cgdXJsLiBwYWdlVXJsIGFsd2F5cyBjb250YWlucyB0aGUgZmlsZSBwYXRoCgkJCXBhZ2VVcmwgPSB1cmwsCgkJCWZpbGVVcmwgPSBwYXRoLmdldEZpbGVQYXRoKCB1cmwgKSwKCQkJYWN0aXZlID0gdXJsSGlzdG9yeS5nZXRBY3RpdmUoKSwKCQkJYWN0aXZlSXNJbml0aWFsUGFnZSA9IHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAsCgkJCWhpc3RvcnlEaXIgPSAwLAoJCQlwYWdlVGl0bGUgPSBkb2N1bWVudC50aXRsZSwKCQkJaXNEaWFsb2cgPSBzZXR0aW5ncy5yb2xlID09PSAiZGlhbG9nIiB8fCB0b1BhZ2UuanFtRGF0YSggInJvbGUiICkgPT09ICJkaWFsb2ciOwoKCgkJLy8gQnkgZGVmYXVsdCwgd2UgcHJldmVudCBjaGFuZ2VQYWdlIHJlcXVlc3RzIHdoZW4gdGhlIGZyb21QYWdlIGFuZCB0b1BhZ2UKCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudCBtYW51YWxseS9keW5hbWljYWxseQoJCS8vIGFuZCByZXVzZSBwYWdlcyB3YW50IHRvIGJlIGFibGUgdG8gdHJhbnNpdGlvbiB0byB0aGUgc2FtZSBwYWdlLiBUbyBhbGxvdwoJCS8vIHRoaXMsIHRoZXkgd2lsbCBuZWVkIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbgoJCS8vIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4KCQkvLyBJdCBzaG91bGQgYmUgbm90ZWQgdGhhdCBvdXIgZGVmYXVsdCB0cmFuc2l0aW9uIGFuaW1hdGlvbnMgYXNzdW1lIHRoYXQgdGhlCgkJLy8gZm9ybVBhZ2UgYW5kIHRvUGFnZSBhcmUgZGlmZmVyZW50IGVsZW1lbnRzLCBzbyB0aGV5IG1heSBiZWhhdmUgdW5leHBlY3RlZGx5LgoJCS8vIEl0IGlzIHVwIHRvIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbgoJCS8vIHRvIGVpdGhlciB0dXJuIG9mZiB0cmFuc2l0aW9uIGFuaW1hdGlvbnMsIG9yIG1ha2Ugc3VyZSB0aGF0IGFuIGFwcHJvcHJpYXRlCgkJLy8gYW5pbWF0aW9uIHRyYW5zaXRpb24gaXMgdXNlZC4KCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYgIXNldHRpbmdzLmFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uICkgewoJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBFdmVuIGlmIHRoZXJlIGlzIG5vIHBhZ2UgY2hhbmdlIHRvIGJlIGRvbmUsIHdlIHNob3VsZCBrZWVwIHRoZSB1cmxIaXN0b3J5IGluIHN5bmMgd2l0aCB0aGUgaGFzaCBjaGFuZ2VzCgkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQl1cmxIaXN0b3J5LmRpcmVjdCh7IHVybDogdXJsIH0pOwoJCQl9CgoJCQlyZXR1cm47CgkJfQoKCQkvLyBXZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFnZSB3ZSBhcmUgZ2l2ZW4gaGFzIGFscmVhZHkgYmVlbiBlbmhhbmNlZC4KCQllbmhhbmNlUGFnZSggdG9QYWdlLCBzZXR0aW5ncy5yb2xlICk7CgoJCS8vIElmIHRoZSBjaGFuZ2VQYWdlIHJlcXVlc3Qgd2FzIHNlbnQgZnJvbSBhIGhhc2hDaGFuZ2UgZXZlbnQsIGNoZWNrIHRvIHNlZSBpZiB0aGUKCQkvLyBwYWdlIGlzIGFscmVhZHkgd2l0aGluIHRoZSB1cmxIaXN0b3J5IHN0YWNrLiBJZiBzbywgd2UnbGwgYXNzdW1lIHRoZSB1c2VyIGhpdAoJCS8vIHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUgdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQlpZiAoIHNldHRpbmdzLmZyb21IYXNoQ2hhbmdlICkgewoJCQloaXN0b3J5RGlyID0gb3B0aW9ucy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQl9CgoJCS8vIEtpbGwgdGhlIGtleWJvYXJkLgoJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4gSW5zdGVhZCwKCQkvLyAgICAgICAgICAgIHdlIHNob3VsZCBiZSB0cmFja2luZyBmb2N1cyB3aXRoIGEgZGVsZWdhdGUoKSBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZQoJCS8vICAgICAgICAgICAgdGhlIGVsZW1lbnQgaW4gaGFuZCBhdCB0aGlzIHBvaW50LgoJCS8vIFdyYXAgdGhpcyBpbiBhIHRyeS9jYXRjaCBibG9jayBzaW5jZSBJRTkgdGhyb3cgIlVuc3BlY2lmaWVkIGVycm9yIiBpZiBkb2N1bWVudC5hY3RpdmVFbGVtZW50CgkJLy8gaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQl0cnkgewoJCQlpZiAoIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAnYm9keScgKSB7CgkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQl9IGVsc2UgewoJCQkJJCggImlucHV0OmZvY3VzLCB0ZXh0YXJlYTpmb2N1cywgc2VsZWN0OmZvY3VzIiApLmJsdXIoKTsKCQkJfQoJCX0gY2F0Y2goIGUgKSB7fQoKCQkvLyBSZWNvcmQgd2hldGhlciB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHdoZXJlIGEgZGlhbG9nIHVzZWQgdG8gYmUgLSBpZiBzbywgZG8gbm90IGFkZCBhIG5ldyBoaXN0b3J5IGVudHJ5IGFuZCBkbyBub3QgY2hhbmdlIHRoZSBoYXNoIGVpdGhlcgoJCXZhciBhbHJlYWR5VGhlcmUgPSBmYWxzZTsKCgkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJLy8gZm9yIHRoZSBkaWFsb2cgY29udGVudCB0byBiZSB1c2VkIGluIHRoZSBoYXNoLiBJbnN0ZWFkLCB3ZSB3YW50CgkJLy8gdG8gYXBwZW5kIHRoZSBkaWFsb2dIYXNoS2V5IHRvIHRoZSB1cmwgb2YgdGhlIGN1cnJlbnQgcGFnZS4KCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJLy8gb24gdGhlIGluaXRpYWwgcGFnZSBsb2FkIGFjdGl2ZS51cmwgaXMgdW5kZWZpbmVkIGFuZCBpbiB0aGF0IGNhc2Ugc2hvdWxkCgkJCS8vIGJlIGFuIGVtcHR5IHN0cmluZy4gTW92aW5nIHRoZSB1bmRlZmluZWQgLT4gZW1wdHkgc3RyaW5nIGJhY2sgaW50bwoJCQkvLyB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIgcmVwcmVzZW50cwoJCQkvLyB0aGUgdXJsIHN0YXRlCgoJCQkvLyBJZiB3ZSBhcmUgYXQgYSBwbGFjZSBpbiBoaXN0b3J5IHRoYXQgb25jZSBiZWxvbmdlZCB0byBhIGRpYWxvZywgcmV1c2UKCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUgaGFzaC4KCQkJLy8gSG93ZXZlciwgaWYgYSBkaWFsb2cgaXMgYWxyZWFkeSBkaXNwbGF5ZWQgYXQgdGhpcyBwb2ludCwgYW5kIHdlJ3JlCgkJCS8vIGFib3V0IHRvIGRpc3BsYXkgYW5vdGhlciBkaWFsb2csIHRoZW4gd2UgbXVzdCBhZGQgYW5vdGhlciBoYXNoIGFuZAoJCQkvLyBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUgb3JpZ2luYWwgZGlhbG9nCgkJCWlmICggYWN0aXZlLnVybCAmJgoJCQkJYWN0aXZlLnVybC5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSAmJgoJCQkJISQubW9iaWxlLmFjdGl2ZVBhZ2UuaXMoICIudWktZGlhbG9nIiApICYmCgkJCQl1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCQkJCXNldHRpbmdzLmNoYW5nZUhhc2ggPSBmYWxzZTsKCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCX0KCgkJCS8vIE5vcm1hbGx5LCB3ZSB0YWNrIG9uIGEgZGlhbG9nIGhhc2gga2V5LCBidXQgaWYgdGhpcyBpcyB0aGUgbG9jYXRpb24gb2YgYSBzdGFsZSBkaWFsb2csCgkJCS8vIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJdXJsID0gKCBhY3RpdmUudXJsIHx8ICIiICk7CgoJCQkvLyBhY2NvdW50IGZvciBhYnNvbHV0ZSB1cmxzIGluc3RlYWQgb2YganVzdCByZWxhdGl2ZSB1cmxzIHVzZSBhcyBoYXNoZXMKCQkJaWYoICFhbHJlYWR5VGhlcmUgJiYgdXJsLmluZGV4T2YoIiMiKSA+IC0xICkgewoJCQkJdXJsICs9IGRpYWxvZ0hhc2hLZXk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgKz0gIiMiICsgZGlhbG9nSGFzaEtleTsKCQkJfQoKCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCS8vIHRoaXMgbWFrZXMgc3VyZSB0aGF0IGEgaGlzdG9yeSBlbnRyeSBpcyBjcmVhdGVkIGZvciB0aGlzIGRpYWxvZwoJCQlpZiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPT09IDAgJiYgdXJsID09PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QgKSB7CgkJCQl1cmwgKz0gZGlhbG9nSGFzaEtleTsKCQkJfQoJCX0KCgkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCS8vIElmIHRoaXMgaXMgYSBkZWVwLWxpbmsgb3IgYSByZWxvYWQgKCBhY3RpdmUgPT09IHVuZGVmaW5lZCApIHRoZW4ganVzdCB1c2UgcGFnZVRpdGxlCgkJdmFyIG5ld1BhZ2VUaXRsZSA9ICggIWFjdGl2ZSApPyBwYWdlVGl0bGUgOiB0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApIHx8IHRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCWlmICggISFuZXdQYWdlVGl0bGUgJiYgcGFnZVRpdGxlID09PSBkb2N1bWVudC50aXRsZSApIHsKCQkJcGFnZVRpdGxlID0gbmV3UGFnZVRpdGxlOwoJCX0KCQlpZiAoICF0b1BhZ2UuanFtRGF0YSggInRpdGxlIiApICkgewoJCQl0b1BhZ2UuanFtRGF0YSggInRpdGxlIiwgcGFnZVRpdGxlICk7CgkJfQoKCQkvLyBNYWtlIHN1cmUgd2UgaGF2ZSBhIHRyYW5zaXRpb24gZGVmaW5lZC4KCQlzZXR0aW5ncy50cmFuc2l0aW9uID0gc2V0dGluZ3MudHJhbnNpdGlvbiB8fAoJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkoIGlzRGlhbG9nID8gJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb24gOiAkLm1vYmlsZS5kZWZhdWx0UGFnZVRyYW5zaXRpb24gKTsKCgkJLy9hZGQgcGFnZSB0byBoaXN0b3J5IHN0YWNrIGlmIGl0J3Mgbm90IGJhY2sgb3IgZm9yd2FyZAoJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQl1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnBhZ2VVcmwgPSBwYWdlVXJsOwoJCX0KCgkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCWlmICggdXJsICYmICFzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJdmFyIHBhcmFtczsKCgkJCS8vIHJlYnVpbGRpbmcgdGhlIGhhc2ggaGVyZSBzaW5jZSB3ZSBsb29zZSBpdCBlYXJsaWVyIG9uCgkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJaWYoICFwYXRoLmlzUGF0aCggdXJsICkgJiYgdXJsLmluZGV4T2YoICIjIiApIDwgMCApIHsKCQkJCXVybCA9ICIjIiArIHVybDsKCQkJfQoKCQkJLy8gVE9ETyB0aGUgcHJvcGVydHkgbmFtZXMgaGVyZSBhcmUganVzdCBzaWxseQoJCQlwYXJhbXMgPSB7CgkJCQl0cmFuc2l0aW9uOiBzZXR0aW5ncy50cmFuc2l0aW9uLAoJCQkJdGl0bGU6IHBhZ2VUaXRsZSwKCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQlyb2xlOiBzZXR0aW5ncy5yb2xlCgkJCX07CgoJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUoIHVybCwgcGFyYW1zLCB0cnVlKTsKCQkJfSBlbHNlIGlmICggdG9QYWdlWyAwIF0gIT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCX0KCQl9CgoJCS8vc2V0IHBhZ2UgdGl0bGUKCQlkb2N1bWVudC50aXRsZSA9IHBhZ2VUaXRsZTsKCgkJLy9zZXQgInRvUGFnZSIgYXMgYWN0aXZlUGFnZQoJCSQubW9iaWxlLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCS8vIElmIHdlJ3JlIG5hdmlnYXRpbmcgYmFjayBpbiB0aGUgVVJMIGhpc3RvcnksIHNldCByZXZlcnNlIGFjY29yZGluZ2x5LgoJCXNldHRpbmdzLnJldmVyc2UgPSBzZXR0aW5ncy5yZXZlcnNlIHx8IGhpc3RvcnlEaXIgPCAwOwoKCQl0cmFuc2l0aW9uUGFnZXMoIHRvUGFnZSwgZnJvbVBhZ2UsIHNldHRpbmdzLnRyYW5zaXRpb24sIHNldHRpbmdzLnJldmVyc2UgKQoJCQkuZG9uZShmdW5jdGlvbiggbmFtZSwgcmV2ZXJzZSwgJHRvLCAkZnJvbSwgYWxyZWFkeUZvY3VzZWQgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoKTsKCgkJCQkvL2lmIHRoZXJlJ3MgYSBkdXBsaWNhdGVDYWNoZWRQYWdlLCByZW1vdmUgaXQgZnJvbSB0aGUgRE9NIG5vdyB0aGF0IGl0J3MgaGlkZGVuCgkJCQlpZiAoIHNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UgKSB7CgkJCQkJc2V0dGluZ3MuZHVwbGljYXRlQ2FjaGVkUGFnZS5yZW1vdmUoKTsKCQkJCX0KCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHRoZSBuZXdseSBzaG93biBwYWdlLiBNb3ZlZCBmcm9tIHByb21pc2UgLmRvbmUgYmluZGluZyBpbiB0cmFuc2l0aW9uUGFnZXMKCQkJCS8vIGl0c2VsZiB0byBhdm9pZCBpZSBidWcgdGhhdCByZXBvcnRzIG9mZnNldFdpZHRoIGFzID4gMCAoY29yZSBjaGVjayBmb3IgdmlzaWJpbGl0eSkKCQkJCS8vIGRlc3BpdGUgdmlzaWJpbGl0eTogaGlkZGVuIGFkZHJlc3NlcyBpc3N1ZSAjMjk2NQoJCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8yOTY1CgkJCQlpZiAoICFhbHJlYWR5Rm9jdXNlZCApIHsKCQkJCQkkLm1vYmlsZS5mb2N1c1BhZ2UoIHRvUGFnZSApOwoJCQkJfQoKCQkJCXJlbGVhc2VQYWdlVHJhbnNpdGlvbkxvY2soKTsKCQkJCW1wYy50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgkJCX0pOwoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlLmRlZmF1bHRzID0gewoJCXRyYW5zaXRpb246IHVuZGVmaW5lZCwKCQlyZXZlcnNlOiBmYWxzZSwKCQljaGFuZ2VIYXNoOiB0cnVlLAoJCWZyb21IYXNoQ2hhbmdlOiBmYWxzZSwKCQlyb2xlOiB1bmRlZmluZWQsIC8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQlkdXBsaWNhdGVDYWNoZWRQYWdlOiB1bmRlZmluZWQsCgkJcGFnZUNvbnRhaW5lcjogdW5kZWZpbmVkLAoJCXNob3dMb2FkTXNnOiB0cnVlLCAvL2xvYWRpbmcgbWVzc2FnZSBzaG93cyBieSBkZWZhdWx0IHdoZW4gcGFnZXMgYXJlIGJlaW5nIGZldGNoZWQgZHVyaW5nIGNoYW5nZVBhZ2UKCQlkYXRhVXJsOiB1bmRlZmluZWQsCgkJZnJvbVBhZ2U6IHVuZGVmaW5lZCwKCQlhbGxvd1NhbWVQYWdlVHJhbnNpdGlvbjogZmFsc2UKCX07CgovKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCgl7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCS8vIExvb2sgZm9yIHRoZSBjbG9zZXN0IGVsZW1lbnQgd2l0aCBhIG5vZGVOYW1lIG9mICJhIi4KCQkJLy8gTm90ZSB0aGF0IHdlIGFyZSBjaGVja2luZyBpZiB3ZSBoYXZlIGEgdmFsaWQgbm9kZU5hbWUKCQkJLy8gYmVmb3JlIGF0dGVtcHRpbmcgdG8gYWNjZXNzIGl0LiBUaGlzIGlzIGJlY2F1c2UgdGhlCgkJCS8vIG5vZGUgd2UgZ2V0IGNhbGxlZCB3aXRoIGNvdWxkIGhhdmUgb3JpZ2luYXRlZCBmcm9tIHdpdGhpbgoJCQkvLyBhbiBlbWJlZGRlZCBTVkcgZG9jdW1lbnQgd2hlcmUgc29tZSBzeW1ib2wgaW5zdGFuY2UgZWxlbWVudHMKCQkJLy8gZG9uJ3QgaGF2ZSBub2RlTmFtZSBkZWZpbmVkIG9uIHRoZW0sIG9yIHN0cmluZ3MgYXJlIG9mIHR5cGUKCQkJLy8gU1ZHQW5pbWF0ZWRTdHJpbmcuCgkJCWlmICggKCB0eXBlb2YgZWxlLm5vZGVOYW1lID09PSAic3RyaW5nIiApICYmIGVsZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiYSIgKSB7CgkJCQlicmVhazsKCQkJfQoJCQllbGUgPSBlbGUucGFyZW50Tm9kZTsKCQl9CgkJcmV0dXJuIGVsZTsKCX0KCgkvLyBUaGUgYmFzZSBVUkwgZm9yIGFueSBnaXZlbiBlbGVtZW50IGRlcGVuZHMgb24gdGhlIHBhZ2UgaXQgcmVzaWRlcyBpbi4KCWZ1bmN0aW9uIGdldENsb3Nlc3RCYXNlVXJsKCBlbGUgKQoJewoJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQl2YXIgdXJsID0gJCggZWxlICkuY2xvc2VzdCggIi51aS1wYWdlIiApLmpxbURhdGEoICJ1cmwiICksCgkJCWJhc2UgPSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaDsKCgkJaWYgKCAhdXJsIHx8ICFwYXRoLmlzUGF0aCggdXJsICkgKSB7CgkJCXVybCA9IGJhc2U7CgkJfQoKCQlyZXR1cm4gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIHVybCwgYmFzZSk7Cgl9CgoJLy9UaGUgZm9sbG93aW5nIGV2ZW50IGJpbmRpbmdzIHNob3VsZCBiZSBib3VuZCBhZnRlciBtb2JpbGVpbml0IGhhcyBiZWVuIHRyaWdnZXJlZAoJLy90aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJCgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkIHx8CgkJCQkJLy8gdGVzdCB0aGF0IHRoZSBmb3JtIGlzLCBpdHNlbGYsIGFqYXggZmFsc2UKCQkJCQkkZm9ybS5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgaXMgc2V0IGFuZAoJCQkJCS8vIHRoZSBmb3JtIG9yIG9uZSBvZiBpdCdzIHBhcmVudHMgaXMgYWpheD1mYWxzZQoJCQkJCSEkZm9ybS5qcW1IaWphY2thYmxlKCkubGVuZ3RoIHx8CgkJCQkJJGZvcm0uYXR0ciggInRhcmdldCIgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdXJsID0gJGZvcm0uYXR0ciggImFjdGlvbiIgKTsKCQkJbWV0aG9kID0gKCAkZm9ybS5hdHRyKCAibWV0aG9kIiApIHx8ICJnZXQiICkudG9Mb3dlckNhc2UoKTsKCgkJCS8vIElmIG5vIGFjdGlvbiBpcyBzcGVjaWZpZWQsIGJyb3dzZXJzIGRlZmF1bHQgdG8gdXNpbmcgdGhlCgkJCS8vIFVSTCBvZiB0aGUgZG9jdW1lbnQgY29udGFpbmluZyB0aGUgZm9ybS4gU2luY2Ugd2UgZHluYW1pY2FsbHkKCQkJLy8gcHVsbCBpbiBwYWdlcyBmcm9tIGV4dGVybmFsIGRvY3VtZW50cywgdGhlIGZvcm0gc2hvdWxkIHN1Ym1pdAoJCQkvLyB0byB0aGUgVVJMIGZvciB0aGUgc291cmNlIGRvY3VtZW50IG9mIHRoZSBwYWdlIGNvbnRhaW5pbmcKCQkJLy8gdGhlIGZvcm0uCgkJCWlmICggIXVybCApIHsKCQkJCS8vIEdldCB0aGUgQGRhdGEtdXJsIGZvciB0aGUgcGFnZSBjb250YWluaW5nIHRoZSBmb3JtLgoJCQkJdXJsID0gZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICk7CgoJCQkJLy8gTk9URTogSWYgdGhlIG1ldGhvZCBpcyAiZ2V0Iiwgd2UgbmVlZCB0byBzdHJpcCBvZmYgdGhlIHF1ZXJ5IHN0cmluZwoJCQkJLy8gYmVjYXVzZSBpdCB3aWxsIGdldCByZXBsYWNlZCB3aXRoIHRoZSBuZXcgZm9ybSBkYXRhLiBTZWUgaXNzdWUgIzU3MTAuCgkJCQlpZiAoIG1ldGhvZCA9PT0gImdldCIgKSB7CgkJCQkJdXJsID0gcGF0aC5wYXJzZVVybCggdXJsICkuaHJlZk5vU2VhcmNoOwoJCQkJfQoKCQkJCWlmICggdXJsID09PSBkb2N1bWVudEJhc2UuaHJlZk5vSGFzaCApIHsKCQkJCQkvLyBUaGUgdXJsIHdlIGdvdCBiYWNrIG1hdGNoZXMgdGhlIGRvY3VtZW50IGJhc2UsCgkJCQkJLy8gd2hpY2ggbWVhbnMgdGhlIHBhZ2UgbXVzdCBiZSBhbiBpbnRlcm5hbC9lbWJlZGRlZCBwYWdlLAoJCQkJCS8vIHNvIGRlZmF1bHQgdG8gdXNpbmcgdGhlIGFjdHVhbCBkb2N1bWVudCB1cmwgYXMgYSBicm93c2VyCgkJCQkJLy8gd291bGQuCgkJCQkJdXJsID0gZG9jdW1lbnRVcmwuaHJlZk5vU2VhcmNoOwoJCQkJfQoJCQl9CgoJCQl1cmwgPSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggIHVybCwgZ2V0Q2xvc2VzdEJhc2VVcmwoICRmb3JtICkgKTsKCgkJCWlmICggKCBwYXRoLmlzRXh0ZXJuYWwoIHVybCApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgdXJsICkgKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJaWYgKCAhY2FsY3VsYXRlT25seSApIHsKCQkJCWZvcm1EYXRhID0gJGZvcm0uc2VyaWFsaXplQXJyYXkoKTsKCgkJCQlpZiAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZFsgMCBdLmZvcm0gPT09ICRmb3JtWyAwIF0gKSB7CgkJCQkJdmNsaWNrZWROYW1lID0gJGxhc3RWQ2xpY2tlZC5hdHRyKCAibmFtZSIgKTsKCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJLy8gTWFrZSBzdXJlIHRoZSBsYXN0IGNsaWNrZWQgZWxlbWVudCBpcyBpbmNsdWRlZCBpbiB0aGUgZm9ybQoJCQkJCQkkLmVhY2goIGZvcm1EYXRhLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJCQkJCWlmICggdmFsdWUubmFtZSA9PT0gdmNsaWNrZWROYW1lICkgewoJCQkJCQkJCS8vIFVuc2V0IHZjbGlja2VkTmFtZSAtIHdlJ3ZlIGZvdW5kIGl0IGluIHRoZSBzZXJpYWxpemVkIGRhdGEgYWxyZWFkeQoJCQkJCQkJCXZjbGlja2VkTmFtZSA9ICIiOwoJCQkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJCWlmICggdmNsaWNrZWROYW1lICkgewoJCQkJCQkJZm9ybURhdGEucHVzaCggeyBuYW1lOiB2Y2xpY2tlZE5hbWUsIHZhbHVlOiAkbGFzdFZDbGlja2VkLmF0dHIoICJ2YWx1ZSIgKSB9ICk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgoJCQkJcmV0ID0gewoJCQkJCXVybDogdXJsLAoJCQkJCW9wdGlvbnM6IHsKCQkJCQkJdHlwZToJCW1ldGhvZCwKCQkJCQkJZGF0YToJCSQucGFyYW0oIGZvcm1EYXRhICksCgkJCQkJCXRyYW5zaXRpb246CSRmb3JtLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApLAoJCQkJCQlyZXZlcnNlOgkkZm9ybS5qcW1EYXRhKCAiZGlyZWN0aW9uIiApID09PSAicmV2ZXJzZSIsCgkJCQkJCXJlbG9hZFBhZ2U6CXRydWUKCQkJCQl9CgkJCQl9OwoJCQl9CgoJCQlyZXR1cm4gcmV0OwoJCX07CgoJCS8vYmluZCB0byBmb3JtIHN1Ym1pdCBldmVudHMsIGhhbmRsZSB3aXRoIEFqYXgKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggImZvcm0iLCAic3VibWl0IiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZm9ybURhdGEgPSBnZXRBamF4Rm9ybURhdGEoICQoIHRoaXMgKSApOwoKCQkJaWYgKCBmb3JtRGF0YSApIHsKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJfQoJCX0pOwoKCQkvL2FkZCBhY3RpdmUgc3RhdGUgb24gdmNsaWNrCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInZjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICRidG4sIGJ0bkVscywgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0LCBuZWVkQ2xvc2VzdCA9IGZhbHNlOwoJCQkvLyBpZiB0aGlzIGlzbid0IGEgbGVmdCBjbGljayB3ZSBkb24ndCBjYXJlLiBJdHMgaW1wb3J0YW50IHRvIG5vdGUKCQkJLy8gdGhhdCB3aGVuIHRoZSB2aXJ0dWFsIGV2ZW50IGlzIGdlbmVyYXRlZCBpdCB3aWxsIGNyZWF0ZSB0aGUgd2hpY2ggYXR0cgoJCQlpZiAoIGV2ZW50LndoaWNoID4gMSB8fCAhJC5tb2JpbGUubGlua0JpbmRpbmdFbmFibGVkICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBSZWNvcmQgdGhhdCB0aGlzIGVsZW1lbnQgd2FzIGNsaWNrZWQsIGluIGNhc2Ugd2UgbmVlZCBpdCBmb3IgY29ycmVjdAoJCQkvLyBmb3JtIHN1Ym1pc3Npb24gZHVyaW5nIHRoZSAic3VibWl0IiBoYW5kbGVyIGFib3ZlCgkJCSRsYXN0VkNsaWNrZWQgPSAkKCB0YXJnZXQgKTsKCgkJCS8vIFRyeSB0byBmaW5kIGEgdGFyZ2V0IGVsZW1lbnQgdG8gd2hpY2ggdGhlIGFjdGl2ZSBjbGFzcyB3aWxsIGJlIGFwcGxpZWQKCQkJaWYgKCAkLmRhdGEoIHRhcmdldCwgIm1vYmlsZS1idXR0b24iICkgKSB7CgkJCQkvLyBJZiB0aGUgZm9ybSB3aWxsIG5vdCBiZSBzdWJtaXR0ZWQgdmlhIEFKQVgsIGRvIG5vdCBhZGQgYWN0aXZlIGNsYXNzCgkJCQlpZiAoICFnZXRBamF4Rm9ybURhdGEoICQoIHRhcmdldCApLmNsb3Nlc3QoICJmb3JtIiApLCB0cnVlICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJLy8gV2Ugd2lsbCBhcHBseSB0aGUgYWN0aXZlIHN0YXRlIHRvIHRoaXMgYnV0dG9uIHdpZGdldCAtIHRoZSBwYXJlbnQKCQkJCS8vIG9mIHRoZSBpbnB1dCB0aGF0IHdhcyBjbGlja2VkIHdpbGwgaGF2ZSB0aGUgYXNzb2NpYXRlZCBkYXRhCgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCXRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGFyZ2V0ID0gZmluZENsb3Nlc3RMaW5rKCB0YXJnZXQgKTsKCQkJCWlmICggISggdGFyZ2V0ICYmIHBhdGgucGFyc2VVcmwoIHRhcmdldC5nZXRBdHRyaWJ1dGUoICJocmVmIiApIHx8ICIjIiApLmhhc2ggIT09ICIjIiApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZQoJCQkJLy8gbGluayB3cmFwcGluZyBjYW4gYmUgYXZvaWRlZAoJCQkJaWYgKCAhJCggdGFyZ2V0ICkuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCX0KCgkJCS8vIEF2b2lkIGNhbGxpbmcgLmNsb3Nlc3QgYnkgdXNpbmcgdGhlIGRhdGEgc2V0IGR1cmluZyAuYnV0dG9uTWFya3VwKCkKCQkJLy8gTGlzdCBpdGVtcyBoYXZlIHRoZSBidXR0b24gZGF0YSBpbiB0aGUgcGFyZW50IG9mIHRoZSBlbGVtZW50IGNsaWNrZWQKCQkJaWYgKCAhIX50YXJnZXQuY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1saW5rLWluaGVyaXQiICkgKSB7CgkJCQlpZiAoIHRhcmdldC5wYXJlbnROb2RlICkgewoJCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LnBhcmVudE5vZGUsICJidXR0b25FbGVtZW50cyIgKTsKCQkJCX0KCQkJLy8gT3RoZXJ3aXNlLCBsb29rIGZvciB0aGUgZGF0YSBvbiB0aGUgdGFyZ2V0IGl0c2VsZgoJCQl9IGVsc2UgewoJCQkJYnRuRWxzID0gJC5kYXRhKCB0YXJnZXQsICJidXR0b25FbGVtZW50cyIgKTsKCQkJfQoJCQkvLyBJZiBmb3VuZCwgZ3JhYiB0aGUgYnV0dG9uJ3Mgb3V0ZXIgZWxlbWVudAoJCQlpZiAoIGJ0bkVscyApIHsKCQkJCXRhcmdldCA9IGJ0bkVscy5vdXRlcjsKCQkJfSBlbHNlIHsKCQkJCW5lZWRDbG9zZXN0ID0gdHJ1ZTsKCQkJfQoKCQkJJGJ0biA9ICQoIHRhcmdldCApOwoJCQkvLyBJZiB0aGUgb3V0ZXIgZWxlbWVudCB3YXNuJ3QgZm91bmQgYnkgdGhlIG91ciBoZXVyaXN0aWNzLCB1c2UgLmNsb3Nlc3QoKQoJCQlpZiAoIG5lZWRDbG9zZXN0ICkgewoJCQkJJGJ0biA9ICRidG4uY2xvc2VzdCggIi51aS1idG4iICk7CgkJCX0KCgkJCWlmICggJGJ0bi5sZW5ndGggPiAwICYmICEkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSB7CgkJCQlyZW1vdmVBY3RpdmVMaW5rQ2xhc3MoIHRydWUgKTsKCQkJCSRhY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkYWN0aXZlQ2xpY2tlZExpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0KCQl9KTsKCgkJLy8gY2xpY2sgcm91dGluZyAtIGRpcmVjdCB0byBIVFRQIG9yIEFqYXgsIGFjY29yZGluZ2x5CgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQlpZiAoICEkLm1vYmlsZS5saW5rQmluZGluZ0VuYWJsZWQgfHwgZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBsaW5rID0gZmluZENsb3Nlc3RMaW5rKCBldmVudC50YXJnZXQgKSwgJGxpbmsgPSAkKCBsaW5rICksIGh0dHBDbGVhbnVwOwoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gbGluayBhc3NvY2lhdGVkIHdpdGggdGhlIGNsaWNrIG9yIGl0cyBub3QgYSBsZWZ0CgkJCS8vIGNsaWNrIHdlIHdhbnQgdG8gaWdub3JlIHRoZSBjbGljawoJCQkvLyBUT0RPIHRlYWNoICQubW9iaWxlLmhpamFja2FibGUgdG8gb3BlcmF0ZSBvbiByYXcgZG9tIGVsZW1lbnRzIHNvIHRoZSBsaW5rIHdyYXBwaW5nCgkJCS8vIGNhbiBiZSBhdm9pZGVkCgkJCWlmICggIWxpbmsgfHwgZXZlbnQud2hpY2ggPiAxIHx8ICEkbGluay5qcW1IaWphY2thYmxlKCkubGVuZ3RoICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3JlbW92ZSBhY3RpdmUgbGluayBjbGFzcyBpZiBleHRlcm5hbCAodGhlbiBpdCB3b24ndCBiZSB0aGVyZSBpZiB5b3UgY29tZSBiYWNrKQoJCQlodHRwQ2xlYW51cCA9IGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJfTsKCgkJCS8vaWYgdGhlcmUncyBhIGRhdGEtcmVsPWJhY2sgYXR0ciwgZ28gYmFjayBpbiBoaXN0b3J5CgkJCWlmICggJGxpbmsuaXMoICI6anFtRGF0YShyZWw9J2JhY2snKSIgKSApIHsKCQkJCSQubW9iaWxlLmJhY2soKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJdmFyIGJhc2VVcmwgPSBnZXRDbG9zZXN0QmFzZVVybCggJGxpbmsgKSwKCgkJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRsaW5rLmF0dHIoICJocmVmIiApIHx8ICIjIiwgYmFzZVVybCApOwoKCQkJLy9pZiBhamF4IGlzIGRpc2FibGVkLCBleGl0IGVhcmx5CgkJCWlmICggISQubW9iaWxlLmFqYXhFbmFibGVkICYmICFwYXRoLmlzRW1iZWRkZWRQYWdlKCBocmVmICkgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBYWFhfamJsYXM6IElkZWFsbHkgbGlua3MgdG8gYXBwbGljYXRpb24gcGFnZXMgc2hvdWxkIGJlIHNwZWNpZmllZCBhcwoJCQkvLyAgICAgICAgICAgIGFuIHVybCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgd2l0aCBhIGhhc2ggdGhhdCBpcyBlaXRoZXIKCQkJLy8gICAgICAgICAgICB0aGUgc2l0ZSByZWxhdGl2ZSBwYXRoIG9yIGlkIHRvIHRoZSBwYWdlLiBCdXQgc29tZSBvZiB0aGUKCQkJLy8gICAgICAgICAgICBpbnRlcm5hbCBjb2RlIHRoYXQgZHluYW1pY2FsbHkgZ2VuZXJhdGVzIHN1Yi1wYWdlcyBmb3IgbmVzdGVkCgkJCS8vICAgICAgICAgICAgbGlzdHMgYW5kIHNlbGVjdCBkaWFsb2dzLCBqdXN0IHdyaXRlIGEgaGFzaCBpbiB0aGUgbGluayB0aGV5CgkJCS8vICAgICAgICAgICAgY3JlYXRlLiBUaGlzIG1lYW5zIHRoZSBhY3R1YWwgVVJMIHBhdGggaXMgYmFzZWQgb24gd2hhdGV2ZXIKCQkJLy8gICAgICAgICAgICB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgYmFzZSB0YWcgaXMgYXQgdGhlIHRpbWUgdGhpcyBjb2RlCgkJCS8vICAgICAgICAgICAgaXMgY2FsbGVkLiBGb3Igbm93IHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoYXQgYW55IHVybCB3aXRoIGEKCQkJLy8gICAgICAgICAgICBoYXNoIGluIGl0IGlzIGFuIGFwcGxpY2F0aW9uIHBhZ2UgcmVmZXJlbmNlLgoJCQlpZiAoIGhyZWYuc2VhcmNoKCAiIyIgKSAhPT0gLTEgKSB7CgkJCQlocmVmID0gaHJlZi5yZXBsYWNlKCAvW14jXSojLywgIiIgKTsKCQkJCWlmICggIWhyZWYgKSB7CgkJCQkJLy9saW5rIHdhcyBhbiBlbXB0eSBoYXNoIG1lYW50IHB1cmVseQoJCQkJCS8vZm9yIGludGVyYWN0aW9uLCBzbyB3ZSBpZ25vcmUgaXQuCgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzUGF0aCggaHJlZiApICkgewoJCQkJCS8vd2UgaGF2ZSBhcGF0aCBzbyBtYWtlIGl0IHRoZSBocmVmIHdlIHdhbnQgdG8gbG9hZC4KCQkJCQlocmVmID0gcGF0aC5tYWtlVXJsQWJzb2x1dGUoIGhyZWYsIGJhc2VVcmwgKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy93ZSBoYXZlIGEgc2ltcGxlIGlkIHNvIHVzZSB0aGUgZG9jdW1lbnRVcmwgYXMgaXRzIGJhc2UuCgkJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCAiIyIgKyBocmVmLCBkb2N1bWVudFVybC5ocmVmTm9IYXNoICk7CgkJCQl9CgkJCX0KCgkJCQkvLyBTaG91bGQgd2UgaGFuZGxlIHRoaXMgbGluaywgb3IgbGV0IHRoZSBicm93c2VyIGRlYWwgd2l0aCBpdD8KCQkJdmFyIHVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKSwKCgkJCQkvLyBTb21lIGVtYmVkZGVkIGJyb3dzZXJzLCBsaWtlIHRoZSB3ZWIgdmlldyBpbiBQaG9uZSBHYXAsIGFsbG93IGNyb3NzLWRvbWFpbiBYSFIKCQkJCS8vIHJlcXVlc3RzIGlmIHRoZSBkb2N1bWVudCBkb2luZyB0aGUgcmVxdWVzdCB3YXMgbG9hZGVkIHZpYSB0aGUgZmlsZTovLyBwcm90b2NvbC4KCQkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJCS8vIGRhdGEuIFdlIG5vcm1hbGx5IGxldCB0aGUgYnJvd3NlciBoYW5kbGUgZXh0ZXJuYWwvY3Jvc3MtZG9tYWluIHVybHMsIGJ1dCBpZiB0aGUKCQkJCS8vIGFsbG93Q3Jvc3NEb21haW5QYWdlcyBvcHRpb24gaXMgdHJ1ZSwgd2Ugd2lsbCBhbGxvdyBjcm9zcy1kb21haW4gaHR0cC9odHRwcwoJCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJCS8vY2hlY2sgZm9yIHByb3RvY29sIG9yIHJlbCBhbmQgaXRzIG5vdCBhbiBlbWJlZGRlZCBwYWdlCgkJCQkvL1RPRE8gb3ZlcmxhcCBpbiBsb2dpYyBmcm9tIGlzRXh0ZXJuYWwsIHJlbD1leHRlcm5hbCBjaGVjayBzaG91bGQgYmUKCQkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQkJaXNFeHRlcm5hbCA9IHVzZURlZmF1bHRVcmxIYW5kbGluZyB8fCAoIHBhdGguaXNFeHRlcm5hbCggaHJlZiApICYmICFwYXRoLmlzUGVybWl0dGVkQ3Jvc3NEb21haW5SZXF1ZXN0KCBkb2N1bWVudFVybCwgaHJlZiApICk7CgoJCQlpZiAoIGlzRXh0ZXJuYWwgKSB7CgkJCQlodHRwQ2xlYW51cCgpOwoJCQkJLy91c2UgZGVmYXVsdCBjbGljayBoYW5kbGluZwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvL3VzZSBhamF4CgkJCXZhciB0cmFuc2l0aW9uID0gJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCQkvLyBkZXByZWNhdGVkIC0gcmVtb3ZlIGJ5IDEuMAoJCQkJCQkJJGxpbmsuanFtRGF0YSggImJhY2siICksCgoJCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJCXJvbGUgPSAkbGluay5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiApIHx8IHVuZGVmaW5lZDsKCgkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGhyZWYsIHsgdHJhbnNpdGlvbjogdHJhbnNpdGlvbiwgcmV2ZXJzZTogcmV2ZXJzZSwgcm9sZTogcm9sZSwgbGluazogJGxpbmsgfSApOwoJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCX0pOwoKCQkvL3ByZWZldGNoIHBhZ2VzIHdoZW4gYW5jaG9ycyB3aXRoIGRhdGEtcHJlZmV0Y2ggYXJlIGVuY291bnRlcmVkCgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktcGFnZSIsICJwYWdlc2hvdy5wcmVmZXRjaCIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgdXJscyA9IFtdOwoJCQkkKCB0aGlzICkuZmluZCggImE6anFtRGF0YShwcmVmZXRjaCkiICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKSwKCQkJCQl1cmwgPSAkbGluay5hdHRyKCAiaHJlZiIgKTsKCgkJCQlpZiAoIHVybCAmJiAkLmluQXJyYXkoIHVybCwgdXJscyApID09PSAtMSApIHsKCQkJCQl1cmxzLnB1c2goIHVybCApOwoKCQkJCQkkLm1vYmlsZS5sb2FkUGFnZSggdXJsLCB7IHJvbGU6ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkscHJlZmV0Y2g6IHRydWUgfSApOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJJC5tb2JpbGUuX2hhbmRsZUhhc2hDaGFuZ2UgPSBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQl2YXIgdG8gPSBwYXRoLnN0cmlwSGFzaCh1cmwpLAoJCQkJLy90cmFuc2l0aW9uIGlzIGZhbHNlIGlmIGl0J3MgdGhlIGZpcnN0IHBhZ2UsIHVuZGVmaW5lZCBvdGhlcndpc2UgKGFuZCBtYXkgYmUgb3ZlcnJpZGRlbiBieSBkZWZhdWx0KQoJCQkJdHJhbnNpdGlvbiA9ICQubW9iaWxlLnVybEhpc3Rvcnkuc3RhY2subGVuZ3RoID09PSAwID8gIm5vbmUiIDogdW5kZWZpbmVkLAoKCQkJCS8vIGRlZmF1bHQgb3B0aW9ucyBmb3IgdGhlIGNoYW5nUGFnZSBjYWxscyBtYWRlIGFmdGVyIGV4YW1pbmluZyB0aGUgY3VycmVudCBzdGF0ZQoJCQkJLy8gb2YgdGhlIHBhZ2UgYW5kIHRoZSBoYXNoLCBOT1RFIHRoYXQgdGhlIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cwoJCQkJLy8gaGlzdG9yeSBlbnRyeQoJCQkJY2hhbmdlUGFnZU9wdGlvbnMgPSB7CgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUsCgkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJfTsKCgkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSwgewoJCQkJdHJhbnNpdGlvbjogKHVybEhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9KS50cmFuc2l0aW9uIHx8IHRyYW5zaXRpb24KCQkJfSk7CgoJCQkvLyBzcGVjaWFsIGNhc2UgZm9yIGRpYWxvZ3MKCQkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCAmJiB0by5pbmRleE9mKCBkaWFsb2dIYXNoS2V5ICkgPiAtMSAmJiB1cmxIaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCS8vIElmIGN1cnJlbnQgYWN0aXZlIHBhZ2UgaXMgbm90IGEgZGlhbG9nIHNraXAgdGhlIGRpYWxvZyBhbmQgY29udGludWUKCQkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQkJaWYgKCAkLm1vYmlsZS5hY3RpdmVQYWdlICYmICEkLm1vYmlsZS5hY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKSApIHsKCQkJCQkvL2RldGVybWluZSBpZiB3ZSdyZSBoZWFkaW5nIGZvcndhcmQgb3IgYmFja3dhcmQgYW5kIGNvbnRpbnVlIGFjY29yZGluZ2x5IHBhc3QKCQkJCQkvL3RoZSBjdXJyZW50IGRpYWxvZwoJCQkJCWlmKCBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siICkgewoJCQkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJd2luZG93Lmhpc3RvcnkuZm9yd2FyZCgpOwoJCQkJCX0KCgkJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCQlyZXR1cm47CgkJCQl9IGVsc2UgewoJCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkJLy8gdG8gYSBkaWFsb2cgdXNlIHRoZSBkaWFsb2cgb2JqZWN0ZWQgc2F2ZWQgaW4gdGhlIHN0YWNrCgkJCQkJdG8gPSBkYXRhLnBhZ2VVcmw7CgkJCQkJdmFyIGFjdGl2ZSA9ICQubW9iaWxlLnVybEhpc3RvcnkuZ2V0QWN0aXZlKCk7CgoJCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkJLy8gYXMgbW9zdCBvZiB0aGlzIGlzIGxvc3QgYnkgdGhlIGRvbUNhY2hlIGNsZWFuaW5nCgkJCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCB7CgkJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCQl0cmFuc2l0aW9uOiBhY3RpdmUudHJhbnNpdGlvbiwKCQkJCQkJcmV2ZXJzZTogZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIgoJCQkJCX0pOwoJCQkJfQoJCQl9CgoJCQkvL2lmIHRvIGlzIGRlZmluZWQsIGxvYWQgaXQKCQkJaWYgKCB0byApIHsKCQkJCS8vIEF0IHRoaXMgcG9pbnQsICd0bycgY2FuIGJlIG9uZSBvZiAzIHRoaW5ncywgYSBjYWNoZWQgcGFnZSBlbGVtZW50IGZyb20KCQkJCS8vIGEgaGlzdG9yeSBzdGFjayBlbnRyeSwgYW4gaWQsIG9yIHNpdGUtcmVsYXRpdmUvYWJzb2x1dGUgVVJMLiBJZiAndG8nIGlzCgkJCQkvLyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QgdGhlIGRvY3VtZW50QmFzZSwgbm90IHRoZSBsb2NhdGlvbi5ocmVmLAoJCQkJLy8gc2luY2UgdGhlIGhhc2hjaGFuZ2UgY291bGQndmUgYmVlbiB0aGUgcmVzdWx0IG9mIGEgZm9yd2FyZC9iYWNrd2FyZCBuYXZpZ2F0aW9uCgkJCQkvLyB0aGF0IGNyb3NzZXMgZnJvbSBhbiBleHRlcm5hbCBwYWdlL2RpYWxvZyB0byBhbiBpbnRlcm5hbCBwYWdlL2RpYWxvZy4KCQkJCXRvID0gIXBhdGguaXNQYXRoKCB0byApID8gKCBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdG8sIGRvY3VtZW50QmFzZSApICkgOiB0bzsKCgkJCQkvLyBJZiB3ZSdyZSBhYm91dCB0byBnbyB0byBhbiBpbml0aWFsIFVSTCB0aGF0IGNvbnRhaW5zIGEgcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50CgkJCQkvLyBpbnRlcm5hbCBwYWdlLCBnbyB0byB0aGUgZmlyc3QgcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZCB1cCBpbiB0aGUgaW5pdGlhbCB1cmxIaXN0b3J5IGVudHJ5CgkJCQlpZiAoIHRvID09PSBwYXRoLm1ha2VVcmxBYnNvbHV0ZSggJyMnICsgdXJsSGlzdG9yeS5pbml0aWFsRHN0LCBkb2N1bWVudEJhc2UgKSAmJgoJCQkJCXVybEhpc3Rvcnkuc3RhY2subGVuZ3RoICYmIHVybEhpc3Rvcnkuc3RhY2tbMF0udXJsICE9PSB1cmxIaXN0b3J5LmluaXRpYWxEc3QucmVwbGFjZSggZGlhbG9nSGFzaEtleSwgIiIgKSApIHsKCQkJCQl0byA9ICQubW9iaWxlLmZpcnN0UGFnZTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCB0bywgY2hhbmdlUGFnZU9wdGlvbnMgKTsKCQkJfQllbHNlIHsKCgkJCQkvL3RoZXJlJ3Mgbm8gaGFzaCwgZ28gdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGRvbQoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCBjaGFuZ2VQYWdlT3B0aW9ucyApOwoJCQl9CgkJfTsKCgkJLy8gVE9ETyByb2xsIHRoZSBsb2dpYyBoZXJlIGludG8gdGhlIGhhbmRsZUhhc2hDaGFuZ2UgbWV0aG9kCgkJJHdpbmRvdy5iaW5kKCAibmF2aWdhdGUiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQkJdmFyIHVybDsKCgkJCWlmICggZS5vcmlnaW5hbEV2ZW50ICYmIGUub3JpZ2luYWxFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdXJsID0gJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLm9yaWdpbmFsRXZlbnROYW1lLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmKCAhdXJsICkgewoJCQkJdXJsID0gJC5tb2JpbGUucGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJfQoKCQkJaWYoICF1cmwgfHwgdXJsID09PSAiIyIgfHwgdXJsLmluZGV4T2YoICIjIiArICQubW9iaWxlLnBhdGgudWlTdGF0ZUtleSApID09PSAwICl7CgkJCQl1cmwgPSBsb2NhdGlvbi5ocmVmOwoJCQl9CgoJCQkkLm1vYmlsZS5faGFuZGxlSGFzaENoYW5nZSggdXJsLCBkYXRhLnN0YXRlICk7CgkJfSk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciBmbGlwIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5mbGlwID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIGZsb3cgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLmZsb3cgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGUgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgovLyBVc2UgdGhlIHNpbXVsdGFuZW91cyB0cmFuc2l0aW9ucyBoYW5kbGVyIGZvciBzbGlkZSB0cmFuc2l0aW9ucwokLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2xpZGUgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2ltdWx0YW5lb3VzOwoKLy8gU2V0IHRoZSBzbGlkZSB0cmFuc2l0aW9ucydzIGZhbGxiYWNrIHRvICJmYWRlIgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRlID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZG93biBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGVkb3duID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7Ci8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGV1cCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3Muc2xpZGV1cCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKLyoKKiBmYWxsYmFjayB0cmFuc2l0aW9uIGZvciB0dXJuIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy50dXJuID0gImZhZGUiOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmRlZ3JhZGVJbnB1dHMgPSB7Cgljb2xvcjogZmFsc2UsCglkYXRlOiBmYWxzZSwKCWRhdGV0aW1lOiBmYWxzZSwKCSJkYXRldGltZS1sb2NhbCI6IGZhbHNlLAoJZW1haWw6IGZhbHNlLAoJbW9udGg6IGZhbHNlLAoJbnVtYmVyOiBmYWxzZSwKCXJhbmdlOiAibnVtYmVyIiwKCXNlYXJjaDogInRleHQiLAoJdGVsOiBmYWxzZSwKCXRpbWU6IGZhbHNlLAoJdXJsOiBmYWxzZSwKCXdlZWs6IGZhbHNlCn07CgoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoKCXZhciBwYWdlID0gJC5tb2JpbGUuY2xvc2VzdFBhZ2VEYXRhKCAkKCBlLnRhcmdldCApICksIG9wdGlvbnM7CgoJaWYgKCAhcGFnZSApIHsKCQlyZXR1cm47Cgl9CgoJb3B0aW9ucyA9IHBhZ2Uub3B0aW9uczsKCgkvLyBkZWdyYWRlIGlucHV0cyB0byBhdm9pZCBwb29ybHkgaW1wbGVtZW50ZWQgbmF0aXZlIGZ1bmN0aW9uYWxpdHkKCSQoIGUudGFyZ2V0ICkuZmluZCggImlucHV0IiApLm5vdCggcGFnZS5rZWVwTmF0aXZlU2VsZWN0b3IoKSApLmVhY2goZnVuY3Rpb24oKSB7CgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gb3B0aW9ucy5kZWdyYWRlSW5wdXRzWyB0eXBlIF0gfHwgInRleHQiOwoKCQlpZiAoIG9wdGlvbnMuZGVncmFkZUlucHV0c1sgdHlwZSBdICkgewoJCQl2YXIgaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCAkdGhpcy5jbG9uZSgpICkuaHRtbCgpLAoJCQkJLy8gSW4gSUUgYnJvd3NlcnMsIHRoZSB0eXBlIHNvbWV0aW1lcyBkb2Vzbid0IGV4aXN0IGluIHRoZSBjbG9uZWQgbWFya3VwLCBzbyB3ZSByZXBsYWNlIHRoZSBjbG9zaW5nIHRhZyBpbnN0ZWFkCgkJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTEsCgkJCQlmaW5kc3RyID0gaGFzVHlwZSA/IC9ccyt0eXBlPVsiJ10/XHcrWyciXT8vIDogL1wvPz4vLAoJCQkJcmVwc3RyID0gIiB0eXBlPVwiIiArIG9wdFR5cGUgKyAiXCIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZT1cIiIgKyB0eXBlICsgIlwiIiArICggaGFzVHlwZSA/ICIiIDogIj4iICk7CgoJCQkkdGhpcy5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZGlhbG9nIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQljb3JuZXJDbGFzcyA9ICEhdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCWRpYWxvZ1dyYXAgPSAkKCAiPGRpdi8+IiwgewoJCQkJCSJyb2xlIiA6ICJkaWFsb2ciLAoJCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsgY29ybmVyQ2xhc3MKCQkJCX0pOwoKCQkkZWwuYWRkQ2xhc3MoICJ1aS1kaWFsb2cgdWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZwoJCS8vIFNldCBhcmlhIHJvbGUKCQkkZWwud3JhcElubmVyKCBkaWFsb2dXcmFwICk7CgoJCS8qIGJpbmQgZXZlbnRzCgkJCS0gY2xpY2tzIGFuZCBzdWJtaXRzIHNob3VsZCB1c2UgdGhlIGNsb3NpbmcgdHJhbnNpdGlvbiB0aGF0IHRoZSBkaWFsb2cgb3BlbmVkIHdpdGgKCQkJCXVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJCQktIGlmIHRoZSBjbGljayB3YXMgb24gdGhlIGNsb3NlIGJ1dHRvbiwgb3IgdGhlIGxpbmsgaGFzIGEgZGF0YS1yZWw9ImJhY2siIGl0J2xsIGdvIGJhY2sgaW4gaGlzdG9yeSBuYXR1cmFsbHkKCQkqLwoJCSRlbC5iaW5kKCAidmNsaWNrIHN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyICR0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5jbG9zZXN0KCBldmVudC50eXBlID09PSAidmNsaWNrIiA/ICJhIiA6ICJmb3JtIiApLAoJCQkJYWN0aXZlOwoKCQkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCgkJCQlhY3RpdmUgPSAkLm1vYmlsZS51cmxIaXN0b3J5LmdldEFjdGl2ZSgpIHx8IHt9OwoKCQkJCSR0YXJnZXQuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRyYW5zaXRpb24iLCAoIGFjdGl2ZS50cmFuc2l0aW9uIHx8ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uICkgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiwgInJldmVyc2UiICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fb24oICRlbCwgewoJCQlwYWdlYmVmb3Jlc2hvdzogIl9oYW5kbGVQYWdlQmVmb3JlU2hvdyIKCQl9KTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NyZWF0ZUNvbXBsZXRlOiBmYWxzZQoJCX0pOwoKCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7Cgl9LAoKCV9zZXRDbG9zZUJ0bjogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBzZWxmID0gdGhpcywgYnRuLCBsb2NhdGlvbjsKCgkJaWYgKCB0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiApIHsKCQkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24ucmVtb3ZlKCk7CgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gbnVsbDsKCQl9CgkJaWYgKCB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkvLyBTYW5pdGl6ZSB2YWx1ZQoJCQlsb2NhdGlvbiA9ICggdmFsdWUgPT09ICJsZWZ0IiA/ICJsZWZ0IiA6ICJyaWdodCIgKTsKCQkJYnRuID0gJCggIjxhIGhyZWY9JyMnIGNsYXNzPSd1aS1idG4tIiArIGxvY2F0aW9uICsgIicgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiaWNvbj0nZGVsZXRlJyBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29ucG9zPSdub3RleHQnPiIrIHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgKyAiPC9hPiIgKTsKCQkJdGhpcy5lbGVtZW50LmNoaWxkcmVuKCkuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCkucHJlcGVuZCggYnRuICk7CgkJCWlmICggdGhpcy5fY3JlYXRlQ29tcGxldGUgJiYgJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQlidG4uYnV0dG9uTWFya3VwKCk7CgkJCX0KCQkJdGhpcy5fY3JlYXRlQ29tcGxldGUgPSB0cnVlOwoKCQkJLy8gdGhpcyBtdXN0IGJlIGFuIGFub255bW91cyBmdW5jdGlvbiBzbyB0aGF0IHNlbGVjdCBtZW51IGRpYWxvZ3MgY2FuIHJlcGxhY2UKCQkJLy8gdGhlIGNsb3NlIG1ldGhvZC4gVGhpcyBpcyBhIGNoYW5nZSBmcm9tIHByZXZpb3VzbHkganVzdCBkZWZpbmluZyBkYXRhLXJlbD1iYWNrCgkJCS8vIG9uIHRoZSBidXR0b24gYW5kIGxldHRpbmcgbmF2IGhhbmRsZSBpdAoJCQkvLwoJCQkvLyBVc2UgY2xpY2sgcmF0aGVyIHRoYW4gdmNsaWNrIGluIG9yZGVyIHRvIHByZXZlbnQgdGhlIHBvc3NpYmlsaXR5IG9mIHVuaW50ZW50aW9uYWxseQoJCQkvLyByZW9wZW5pbmcgdGhlIGRpYWxvZyBpZiB0aGUgZGlhbG9nIG9wZW5pbmcgaXRlbSB3YXMgZGlyZWN0bHkgdW5kZXIgdGhlIGNsb3NlIGJ1dHRvbi4KCQkJYnRuLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5jbG9zZSgpOwoJCQl9KTsKCgkJCXRoaXMuX2hlYWRlckNsb3NlQnV0dG9uID0gYnRuOwoJCX0KCX0sCgoJX3NldE9wdGlvbjogZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJaWYgKCBrZXkgPT09ICJjbG9zZUJ0biIgKSB7CgkJCXRoaXMuX3NldENsb3NlQnRuKCB2YWx1ZSApOwoJCX0KCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJfSwKCgkvLyBDbG9zZSBtZXRob2QgZ29lcyBiYWNrIGluIGhpc3RvcnkKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQl2YXIgaWR4LCBkc3QsIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQlpZHggPSBNYXRoLm1heCggMCwgaGlzdC5hY3RpdmVJbmRleCAtIDEgKTsKCQkJCWRzdCA9IGhpc3Quc3RhY2tbIGlkeCBdLnBhZ2VVcmwgfHwgaGlzdC5zdGFja1sgaWR4IF0udXJsOwoJCQkJaGlzdC5wcmV2aW91c0luZGV4ID0gaGlzdC5hY3RpdmVJbmRleDsKCQkJCWhpc3QuYWN0aXZlSW5kZXggPSBpZHg7CgkJCQlpZiAoICEkLm1vYmlsZS5wYXRoLmlzUGF0aCggZHN0ICkgKSB7CgkJCQkJZHN0ID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGRzdCApOwoJCQkJfQoKCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGRzdCwgeyBkaXJlY3Rpb246ICJiYWNrIiwgY2hhbmdlSGFzaDogZmFsc2UsIGZyb21IYXNoQ2hhbmdlOiB0cnVlIH0gKTsKCQkJfQoJCX0KCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICQubW9iaWxlLmRpYWxvZy5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oKSB7CgkkLm1vYmlsZS5kaWFsb2cucHJvdG90eXBlLmVuaGFuY2UoIHRoaXMgKTsKfSk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuYmFja0J0blRleHQgID0gIkJhY2siOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmFkZEJhY2tCdG4gICA9IGZhbHNlOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmJhY2tCdG5UaGVtZSA9IG51bGw7CiQubW9iaWxlLnBhZ2UucHJvdG90eXBlLm9wdGlvbnMuaGVhZGVyVGhlbWUgID0gImEiOwokLm1vYmlsZS5wYWdlLnByb3RvdHlwZS5vcHRpb25zLmZvb3RlclRoZW1lICA9ICJhIjsKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5jb250ZW50VGhlbWUgPSBudWxsOwoKLy8gTk9URSBiaW5kIHVzZWQgdG8gZm9yY2UgdGhpcyBiaW5kaW5nIHRvIHJ1biBiZWZvcmUgdGhlIGJ1dHRvbk1hcmt1cCBiaW5kaW5nCi8vICAgICAgd2hpY2ggZXhwZWN0cyAudWktZm9vdGVyIHRvcCBiZSBhcHBsaWVkIGluIGl0cyBnaWdhbnRpYyBzZWxlY3RvcgovLyBUT0RPIHJlbW92ZSB0aGUgYnV0dG9uTWFya3VwIGdpYW50IHNlbGVjdG9yIGFuZCBtb3ZlIGl0IHRvIHRoZSB2YXJpb3VzIG1vZHVsZXMKLy8gICAgICBvbiB3aGljaCBpdCBkZXBlbmRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7Cgl2YXIgJHBhZ2UgPSAkKCBlLnRhcmdldCApLAoJCW8gPSAkcGFnZS5kYXRhKCAibW9iaWxlLXBhZ2UiICkub3B0aW9ucywKCQlwYWdlUm9sZSA9ICRwYWdlLmpxbURhdGEoICJyb2xlIiApLAoJCXBhZ2VUaGVtZSA9IG8udGhlbWU7CgoJJCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpLCA6anFtRGF0YShyb2xlPSdmb290ZXInKSwgOmpxbURhdGEocm9sZT0nY29udGVudCcpIiwgJHBhZ2UgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmVhY2goZnVuY3Rpb24oKSB7CgoJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJcm9sZSA9ICR0aGlzLmpxbURhdGEoICJyb2xlIiApLAoJCQl0aGVtZSA9ICR0aGlzLmpxbURhdGEoICJ0aGVtZSIgKSwKCQkJY29udGVudFRoZW1lID0gdGhlbWUgfHwgby5jb250ZW50VGhlbWUgfHwgKCBwYWdlUm9sZSA9PT0gImRpYWxvZyIgJiYgcGFnZVRoZW1lICksCgkJCSRoZWFkZXJhbmNob3JzLAoJCQlsZWZ0YnRuLAoJCQlyaWdodGJ0biwKCQkJYmFja0J0bjsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS0iICsgcm9sZSApOwoKCQkvL2FwcGx5IHRoZW1pbmcgYW5kIG1hcmt1cCBtb2RpZmljYXRpb25zIHRvIHBhZ2UsaGVhZGVyLGNvbnRlbnQsZm9vdGVyCgkJaWYgKCByb2xlID09PSAiaGVhZGVyIiB8fCByb2xlID09PSAiZm9vdGVyIiApIHsKCgkJCXZhciB0aGlzVGhlbWUgPSB0aGVtZSB8fCAoIHJvbGUgPT09ICJoZWFkZXIiID8gby5oZWFkZXJUaGVtZSA6IG8uZm9vdGVyVGhlbWUgKSB8fCBwYWdlVGhlbWU7CgoJCQkkdGhpcwoJCQkJLy9hZGQgdGhlbWUgY2xhc3MKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgdGhpc1RoZW1lICkKCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCS5hdHRyKCAicm9sZSIsIHJvbGUgPT09ICJoZWFkZXIiID8gImJhbm5lciIgOiAiY29udGVudGluZm8iICk7CgoJCQlpZiAoIHJvbGUgPT09ICJoZWFkZXIiKSB7CgkJCQkvLyBSaWdodCxsZWZ0IGJ1dHRvbnMKCQkJCSRoZWFkZXJhbmNob3JzCT0gJHRoaXMuY2hpbGRyZW4oICJhLCBidXR0b24iICk7CgkJCQlsZWZ0YnRuCT0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJCXJpZ2h0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tcmlnaHQiICk7CgoJCQkJbGVmdGJ0biA9IGxlZnRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDAgKS5ub3QoICIudWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLWxlZnQiICkubGVuZ3RoOwoKCQkJCXJpZ2h0YnRuID0gcmlnaHRidG4gfHwgJGhlYWRlcmFuY2hvcnMuZXEoIDEgKS5hZGRDbGFzcyggInVpLWJ0bi1yaWdodCIgKS5sZW5ndGg7CgkJCX0KCgkJCS8vIEF1dG8tYWRkIGJhY2sgYnRuIG9uIHBhZ2VzIGJleW9uZCBmaXJzdCB2aWV3CgkJCWlmICggby5hZGRCYWNrQnRuICYmCgkJCQlyb2xlID09PSAiaGVhZGVyIiAmJgoJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCSRwYWdlLmpxbURhdGEoICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCSFsZWZ0YnRuICkgewoKCQkJCWJhY2tCdG4gPSAkKCAiPGEgaHJlZj0namF2YXNjcmlwdDp2b2lkKDApOycgY2xhc3M9J3VpLWJ0bi1sZWZ0JyBkYXRhLSIrICQubW9iaWxlLm5zICsicmVsPSdiYWNrJyBkYXRhLSIrICQubW9iaWxlLm5zICsiaWNvbj0nYXJyb3ctbCc+Iisgby5iYWNrQnRuVGV4dCArIjwvYT4iICkKCQkJCQkvLyBJZiB0aGVtZSBpcyBwcm92aWRlZCwgb3ZlcnJpZGUgZGVmYXVsdCBpbmhlcml0YW5jZQoJCQkJCS5hdHRyKCAiZGF0YS0iKyAkLm1vYmlsZS5ucyArInRoZW1lIiwgby5iYWNrQnRuVGhlbWUgfHwgdGhpc1RoZW1lICkKCQkJCQkucHJlcGVuZFRvKCAkdGhpcyApOwoJCQl9CgoJCQkvLyBQYWdlIHRpdGxlCgkJCSR0aGlzLmNoaWxkcmVuKCAiaDEsIGgyLCBoMywgaDQsIGg1LCBoNiIgKQoJCQkJLmFkZENsYXNzKCAidWktdGl0bGUiICkKCQkJCS8vIFJlZ2FyZGxlc3Mgb2YgaCBlbGVtZW50IG51bWJlciBpbiBzcmMsIGl0IGJlY29tZXMgaDEgZm9yIHRoZSBlbmhhbmNlZCBwYWdlCgkJCQkuYXR0cih7CgkJCQkJInJvbGUiOiAiaGVhZGluZyIsCgkJCQkJImFyaWEtbGV2ZWwiOiAiMSIKCQkJCX0pOwoKCQl9IGVsc2UgaWYgKCByb2xlID09PSAiY29udGVudCIgKSB7CgkJCWlmICggY29udGVudFRoZW1lICkgewoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyAoIGNvbnRlbnRUaGVtZSApICk7CgkJCX0KCgkJCS8vIEFkZCBBUklBIHJvbGUKCQkJJHRoaXMuYXR0ciggInJvbGUiLCAibWFpbiIgKTsKCQl9Cgl9KTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIFRoaXMgZnVuY3Rpb24gY2FsbHMgZ2V0QXR0cmlidXRlLCB3aGljaCBzaG91bGQgYmUgc2FmZSBmb3IgZGF0YS0qIGF0dHJpYnV0ZXMKdmFyIGdldEF0dHJGaXhlZCA9IGZ1bmN0aW9uKCBlLCBrZXkgKSB7Cgl2YXIgdmFsdWUgPSBlLmdldEF0dHJpYnV0ZSgga2V5ICk7CgoJcmV0dXJuIHZhbHVlID09PSAidHJ1ZSIgPyB0cnVlIDoKCQl2YWx1ZSA9PT0gImZhbHNlIiA/IGZhbHNlIDoKCQl2YWx1ZSA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IHZhbHVlOwp9OwoKJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXZhciAkd29ya2luZ1NldCA9IHRoaXMsCgkJbnNLZXkgPSAiZGF0YS0iICsgJC5tb2JpbGUubnMsCgkJa2V5OwoKCS8vIEVuZm9yY2Ugb3B0aW9ucyB0byBiZSBvZiB0eXBlIHN0cmluZwoJb3B0aW9ucyA9ICggb3B0aW9ucyAmJiAoICQudHlwZSggb3B0aW9ucyApID09PSAib2JqZWN0IiApICk/IG9wdGlvbnMgOiB7fTsKCWZvciAoIHZhciBpID0gMDsgaSA8ICR3b3JraW5nU2V0Lmxlbmd0aDsgaSsrICkgewoJCXZhciBlbCA9ICR3b3JraW5nU2V0LmVxKCBpICksCgkJCWUgPSBlbFsgMCBdLAoJCQlvID0gJC5leHRlbmQoIHt9LCAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cywgewoJCQkJaWNvbjogICAgICAgb3B0aW9ucy5pY29uICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmljb24gICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImljb24iICksCgkJCQlpY29ucG9zOiAgICBvcHRpb25zLmljb25wb3MgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuaWNvbnBvcyAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiaWNvbnBvcyIgKSwKCQkJCXRoZW1lOiAgICAgIG9wdGlvbnMudGhlbWUgICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy50aGVtZSAgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggZWwsICJjIiApLAoJCQkJaW5saW5lOiAgICAgb3B0aW9ucy5pbmxpbmUgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLmlubGluZSAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgImlubGluZSIgKSwKCQkJCXNoYWRvdzogICAgIG9wdGlvbnMuc2hhZG93ICAgICAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5zaGFkb3cgICAgIDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJzaGFkb3ciICksCgkJCQljb3JuZXJzOiAgICBvcHRpb25zLmNvcm5lcnMgICAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMuY29ybmVycyAgICA6IGdldEF0dHJGaXhlZCggZSwgbnNLZXkgKyAiY29ybmVycyIgKSwKCQkJCWljb25zaGFkb3c6IG9wdGlvbnMuaWNvbnNoYWRvdyAhPT0gdW5kZWZpbmVkID8gb3B0aW9ucy5pY29uc2hhZG93IDogZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJpY29uc2hhZG93IiApLAoJCQkJbWluaTogICAgICAgb3B0aW9ucy5taW5pICAgICAgICE9PSB1bmRlZmluZWQgPyBvcHRpb25zLm1pbmkgICAgICAgOiBnZXRBdHRyRml4ZWQoIGUsIG5zS2V5ICsgIm1pbmkiICkKCQkJfSwgb3B0aW9ucyApLAoKCQkJLy8gQ2xhc3NlcyBEZWZpbmVkCgkJCWlubmVyQ2xhc3MgPSAidWktYnRuLWlubmVyIiwKCQkJdGV4dENsYXNzID0gInVpLWJ0bi10ZXh0IiwKCQkJYnV0dG9uQ2xhc3MsIGljb25DbGFzcywKCQkJaG92ZXIgPSBmYWxzZSwKCQkJc3RhdGUgPSAidXAiLAoJCQkvLyBCdXR0b24gaW5uZXIgbWFya3VwCgkJCWJ1dHRvbklubmVyLAoJCQlidXR0b25UZXh0LAoJCQlidXR0b25JY29uLAoJCQlidXR0b25FbGVtZW50czsKCgkJZm9yICgga2V5IGluIG8gKSB7CgkJCWlmICggb1sga2V5IF0gPT09IHVuZGVmaW5lZCB8fCBvWyBrZXkgXSA9PT0gbnVsbCApIHsKCQkJCWVsLnJlbW92ZUF0dHIoIG5zS2V5ICsga2V5ICk7CgkJCX0gZWxzZSB7CgkJCQllLnNldEF0dHJpYnV0ZSggbnNLZXkgKyBrZXksIG9bIGtleSBdICk7CgkJCX0KCQl9CgoJCWlmICggZ2V0QXR0ckZpeGVkKCBlLCBuc0tleSArICJyZWwiICkgPT09ICJwb3B1cCIgJiYgZWwuYXR0ciggImhyZWYiICkgKSB7CgkJCWUuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJZS5zZXRBdHRyaWJ1dGUoICJhcmlhLW93bnMiLCBlbC5hdHRyKCAiaHJlZiIgKSApOwoJCX0KCgkJLy8gQ2hlY2sgaWYgdGhpcyBlbGVtZW50IGlzIGFscmVhZHkgZW5oYW5jZWQKCQlidXR0b25FbGVtZW50cyA9ICQuZGF0YSggKCAoIGUudGFnTmFtZSA9PT0gIklOUFVUIiB8fCBlLnRhZ05hbWUgPT09ICJCVVRUT04iICkgPyBlLnBhcmVudE5vZGUgOiBlICksICJidXR0b25FbGVtZW50cyIgKTsKCgkJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQkJZSA9IGJ1dHRvbkVsZW1lbnRzLm91dGVyOwoJCQllbCA9ICQoIGUgKTsKCQkJYnV0dG9uSW5uZXIgPSBidXR0b25FbGVtZW50cy5pbm5lcjsKCQkJYnV0dG9uVGV4dCA9IGJ1dHRvbkVsZW1lbnRzLnRleHQ7CgkJCS8vIFdlIHdpbGwgcmVjcmVhdGUgdGhpcyBpY29uIGJlbG93CgkJCSQoIGJ1dHRvbkVsZW1lbnRzLmljb24gKS5yZW1vdmUoKTsKCQkJYnV0dG9uRWxlbWVudHMuaWNvbiA9IG51bGw7CgkJCWhvdmVyID0gYnV0dG9uRWxlbWVudHMuaG92ZXI7CgkJCXN0YXRlID0gYnV0dG9uRWxlbWVudHMuc3RhdGU7CgkJfQoJCWVsc2UgewoJCQlidXR0b25Jbm5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIG8ud3JhcHBlckVscyApOwoJCQlidXR0b25UZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggby53cmFwcGVyRWxzICk7CgkJfQoJCWJ1dHRvbkljb24gPSBvLmljb24gPyBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSA6IG51bGw7CgoJCWlmICggYXR0YWNoRXZlbnRzICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYXR0YWNoRXZlbnRzKCk7CgkJfQoKCQkvLyBpZiBub3QsIHRyeSB0byBmaW5kIGNsb3Nlc3QgdGhlbWUgY29udGFpbmVyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCBlbCwgImMiICk7CgkJfQoKCQlidXR0b25DbGFzcyA9ICJ1aS1idG4gIjsKCQlidXR0b25DbGFzcyArPSAoIGhvdmVyID8gInVpLWJ0bi1ob3Zlci0iICsgby50aGVtZSA6ICIiICk7CgkJYnV0dG9uQ2xhc3MgKz0gKCBzdGF0ZSA/ICIgdWktYnRuLSIgKyBzdGF0ZSArICItIiArIG8udGhlbWUgOiAiIiApOwoJCWJ1dHRvbkNsYXNzICs9IG8uc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJYnV0dG9uQ2xhc3MgKz0gby5jb3JuZXJzID8gIiB1aS1idG4tY29ybmVyLWFsbCIgOiAiIjsKCgkJaWYgKCBvLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJLy8gVXNlZCB0byBjb250cm9sIHN0eWxpbmcgaW4gaGVhZGVycy9mb290ZXJzLCB3aGVyZSBidXR0b25zIGRlZmF1bHQgdG8gYG1pbmlgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLm1pbmkgPT09IHRydWUgPyAiIHVpLW1pbmkiIDogIiB1aS1mdWxsc2l6ZSI7CgkJfQoKCQlpZiAoIG8uaW5saW5lICE9PSB1bmRlZmluZWQgKSB7CgkJCS8vIFVzZWQgdG8gY29udHJvbCBzdHlsaW5nIGluIGhlYWRlcnMvZm9vdGVycywgd2hlcmUgYnV0dG9ucyBkZWZhdWx0IHRvIGBpbmxpbmVgIHN0eWxlLgoJCQlidXR0b25DbGFzcyArPSBvLmlubGluZSA9PT0gdHJ1ZSA/ICIgdWktYnRuLWlubGluZSIgOiAiIHVpLWJ0bi1ibG9jayI7CgkJfQoKCQlpZiAoIG8uaWNvbiApIHsKCQkJby5pY29uID0gInVpLWljb24tIiArIG8uaWNvbjsKCQkJby5pY29ucG9zID0gby5pY29ucG9zIHx8ICJsZWZ0IjsKCgkJCWljb25DbGFzcyA9ICJ1aS1pY29uICIgKyBvLmljb247CgoJCQlpZiAoIG8uaWNvbnNoYWRvdyApIHsKCQkJCWljb25DbGFzcyArPSAiIHVpLWljb24tc2hhZG93IjsKCQkJfQoJCX0KCgkJaWYgKCBvLmljb25wb3MgKSB7CgkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tIiArIG8uaWNvbnBvczsKCgkJCWlmICggby5pY29ucG9zID09PSAibm90ZXh0IiAmJiAhZWwuYXR0ciggInRpdGxlIiApICkgewoJCQkJZWwuYXR0ciggInRpdGxlIiwgZWwuZ2V0RW5jb2RlZFRleHQoKSApOwoJCQl9CgkJfQoKCQlpZiAoIGJ1dHRvbkVsZW1lbnRzICkgewoJCQllbC5yZW1vdmVDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyB8fCAiIiApOwoJCX0KCQllbC5yZW1vdmVDbGFzcyggInVpLWxpbmsiICkuYWRkQ2xhc3MoIGJ1dHRvbkNsYXNzICk7CgoJCWJ1dHRvbklubmVyLmNsYXNzTmFtZSA9IGlubmVyQ2xhc3M7CgkJYnV0dG9uVGV4dC5jbGFzc05hbWUgPSB0ZXh0Q2xhc3M7CgkJaWYgKCAhYnV0dG9uRWxlbWVudHMgKSB7CgkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25UZXh0ICk7CgkJfQoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJYnV0dG9uSWNvbi5jbGFzc05hbWUgPSBpY29uQ2xhc3M7CgkJCWlmICggISggYnV0dG9uRWxlbWVudHMgJiYgYnV0dG9uRWxlbWVudHMuaWNvbiApICkgewoJCQkJYnV0dG9uSWNvbi5pbm5lckhUTUwgPSAiJiMxNjA7IjsKCQkJCWJ1dHRvbklubmVyLmFwcGVuZENoaWxkKCBidXR0b25JY29uICk7CgkJCX0KCQl9CgoJCXdoaWxlICggZS5maXJzdENoaWxkICYmICFidXR0b25FbGVtZW50cyApIHsKCQkJYnV0dG9uVGV4dC5hcHBlbmRDaGlsZCggZS5maXJzdENoaWxkICk7CgkJfQoKCQlpZiAoICFidXR0b25FbGVtZW50cyApIHsKCQkJZS5hcHBlbmRDaGlsZCggYnV0dG9uSW5uZXIgKTsKCQl9CgoJCS8vIEFzc2lnbiBhIHN0cnVjdHVyZSBjb250YWluaW5nIHRoZSBlbGVtZW50cyBvZiB0aGlzIGJ1dHRvbiB0byB0aGUgZWxlbWVudHMgb2YgdGhpcyBidXR0b24uIFRoaXMKCQkvLyB3aWxsIGFsbG93IHVzIHRvIHJlY29nbml6ZSB0aGlzIGFzIGFuIGFscmVhZHktZW5oYW5jZWQgYnV0dG9uIGluIGZ1dHVyZSBjYWxscyB0byBidXR0b25NYXJrdXAoKS4KCQlidXR0b25FbGVtZW50cyA9IHsKCQkJaG92ZXIgOiBob3ZlciwKCQkJc3RhdGUgOiBzdGF0ZSwKCQkJYmNscyAgOiBidXR0b25DbGFzcywKCQkJb3V0ZXIgOiBlLAoJCQlpbm5lciA6IGJ1dHRvbklubmVyLAoJCQl0ZXh0ICA6IGJ1dHRvblRleHQsCgkJCWljb24gIDogYnV0dG9uSWNvbgoJCX07CgoJCSQuZGF0YSggZSwgICAgICAgICAgICdidXR0b25FbGVtZW50cycsIGJ1dHRvbkVsZW1lbnRzICk7CgkJJC5kYXRhKCBidXR0b25Jbm5lciwgJ2J1dHRvbkVsZW1lbnRzJywgYnV0dG9uRWxlbWVudHMgKTsKCQkkLmRhdGEoIGJ1dHRvblRleHQsICAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCWlmICggYnV0dG9uSWNvbiApIHsKCQkJJC5kYXRhKCBidXR0b25JY29uLCAnYnV0dG9uRWxlbWVudHMnLCBidXR0b25FbGVtZW50cyApOwoJCX0KCX0KCglyZXR1cm4gdGhpczsKfTsKCiQuZm4uYnV0dG9uTWFya3VwLmRlZmF1bHRzID0gewoJY29ybmVyczogdHJ1ZSwKCXNoYWRvdzogdHJ1ZSwKCWljb25zaGFkb3c6IHRydWUsCgl3cmFwcGVyRWxzOiAic3BhbiIKfTsKCmZ1bmN0aW9uIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBlbGVtZW50ICkgewogICAgdmFyIGNuYW1lOwoKICAgIHdoaWxlICggZWxlbWVudCApIHsKCQkvLyBOb3RlIHRoYXQgd2UgY2hlY2sgZm9yIHR5cGVvZiBjbGFzc05hbWUgYmVsb3cgYmVjYXVzZSB0aGUgZWxlbWVudCB3ZQoJCS8vIGhhbmRlZCBjb3VsZCBiZSBpbiBhbiBTVkcgRE9NIHdoZXJlIGNsYXNzTmFtZSBvbiBTVkcgZWxlbWVudHMgaXMgZGVmaW5lZCB0bwoJCS8vIGJlIG9mIGEgZGlmZmVyZW50IHR5cGUgKFNWR0FuaW1hdGVkU3RyaW5nKS4gV2Ugb25seSBvcGVyYXRlIG9uIEhUTUwgRE9NCgkJLy8gZWxlbWVudHMsIHNvIHdlIGxvb2sgZm9yIHBsYWluICJzdHJpbmciLgogICAgICAgIGNuYW1lID0gKCB0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgPT09ICdzdHJpbmcnICkgJiYgKCBlbGVtZW50LmNsYXNzTmFtZSArICcgJyApOwogICAgICAgIGlmICggY25hbWUgJiYgY25hbWUuaW5kZXhPZiggInVpLWJ0biAiICkgPiAtMSAmJiBjbmFtZS5pbmRleE9mKCAidWktZGlzYWJsZWQgIiApIDwgMCApIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBlbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwogICAgfQoKICAgIHJldHVybiBlbGVtZW50Owp9CgpmdW5jdGlvbiB1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgY2xhc3NUb1JlbW92ZSwgY2xhc3NUb0FkZCwgaG92ZXIsIHN0YXRlICkgewoJdmFyIGJ1dHRvbkVsZW1lbnRzID0gJC5kYXRhKCAkYnRuWyAwIF0sICJidXR0b25FbGVtZW50cyIgKTsKCSRidG4ucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKS5hZGRDbGFzcyggY2xhc3NUb0FkZCApOwoJaWYgKCBidXR0b25FbGVtZW50cyApIHsKCQlidXR0b25FbGVtZW50cy5iY2xzID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSApCgkJCS5hZGRDbGFzcyggYnV0dG9uRWxlbWVudHMuYmNscyArICIgIiArIGNsYXNzVG9BZGQgKQoJCQkucmVtb3ZlQ2xhc3MoIGNsYXNzVG9SZW1vdmUgKQoJCQkuYXR0ciggImNsYXNzIiApOwoJCWlmICggaG92ZXIgIT09IHVuZGVmaW5lZCApIHsKCQkJYnV0dG9uRWxlbWVudHMuaG92ZXIgPSBob3ZlcjsKCQl9CgkJYnV0dG9uRWxlbWVudHMuc3RhdGUgPSBzdGF0ZTsKCX0KfQoKdmFyIGF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJdmFyIGhvdmVyRGVsYXkgPSAkLm1vYmlsZS5idXR0b25NYXJrdXAuaG92ZXJEZWxheSwgaG92LCBmb2M7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggewoJCSJ2bW91c2Vkb3duIHZtb3VzZWNhbmNlbCB2bW91c2V1cCB2bW91c2VvdmVyIHZtb3VzZW91dCBmb2N1cyBibHVyIHNjcm9sbHN0YXJ0IjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgdGhlbWUsCgkJCQkkYnRuID0gJCggY2xvc2VzdEVuYWJsZWRCdXR0b24oIGV2ZW50LnRhcmdldCApICksCgkJCQlpc1RvdWNoRXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ICYmIC9edG91Y2gvLnRlc3QoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudHlwZSApLAoJCQkJZXZ0ID0gZXZlbnQudHlwZTsKCgkJCWlmICggJGJ0bi5sZW5ndGggKSB7CgkJCQl0aGVtZSA9ICRidG4uYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiApOwoKCQkJCWlmICggZXZ0ID09PSAidm1vdXNlZG93biIgKSB7CgkJCQkJaWYgKCBpc1RvdWNoRXZlbnQgKSB7CgkJCQkJCS8vIFVzZSBhIHNob3J0IGRlbGF5IHRvIGRldGVybWluZSBpZiB0aGUgdXNlciBpcyBzY3JvbGxpbmcgYmVmb3JlIGhpZ2hsaWdodGluZwoJCQkJCQlob3YgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQkJfSwgaG92ZXJEZWxheSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXVwZGF0ZUJ1dHRvbkNsYXNzKCAkYnRuLCAidWktYnRuLXVwLSIgKyB0aGVtZSwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgdW5kZWZpbmVkLCAiZG93biIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VjYW5jZWwiIHx8IGV2dCA9PT0gInZtb3VzZXVwIiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1kb3duLSIgKyB0aGVtZSwgInVpLWJ0bi11cC0iICsgdGhlbWUsIHVuZGVmaW5lZCwgInVwIiApOwoJCQkJfSBlbHNlIGlmICggZXZ0ID09PSAidm1vdXNlb3ZlciIgfHwgZXZ0ID09PSAiZm9jdXMiICkgewoJCQkJCWlmICggaXNUb3VjaEV2ZW50ICkgewoJCQkJCQkvLyBVc2UgYSBzaG9ydCBkZWxheSB0byBkZXRlcm1pbmUgaWYgdGhlIHVzZXIgaXMgc2Nyb2xsaW5nIGJlZm9yZSBoaWdobGlnaHRpbmcKCQkJCQkJZm9jID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi11cC0iICsgdGhlbWUsICJ1aS1idG4taG92ZXItIiArIHRoZW1lLCB0cnVlLCAiIiApOwoJCQkJCQl9LCBob3ZlckRlbGF5ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdXBkYXRlQnV0dG9uQ2xhc3MoICRidG4sICJ1aS1idG4tdXAtIiArIHRoZW1lLCAidWktYnRuLWhvdmVyLSIgKyB0aGVtZSwgdHJ1ZSwgIiIgKTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKCBldnQgPT09ICJ2bW91c2VvdXQiIHx8IGV2dCA9PT0gImJsdXIiIHx8IGV2dCA9PT0gInNjcm9sbHN0YXJ0IiApIHsKCQkJCQl1cGRhdGVCdXR0b25DbGFzcyggJGJ0biwgInVpLWJ0bi1ob3Zlci0iICsgdGhlbWUgICsgIiB1aS1idG4tZG93bi0iICsgdGhlbWUsICJ1aS1idG4tdXAtIiArIHRoZW1lLCBmYWxzZSwgInVwIiApOwoJCQkJCWlmICggaG92ICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhvdiApOwoJCQkJCX0KCQkJCQlpZiAoIGZvYyApIHsKCQkJCQkJY2xlYXJUaW1lb3V0KCBmb2MgKTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9LAoJCSJmb2N1c2luIGZvY3VzIjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkkKCBjbG9zZXN0RW5hYmxlZEJ1dHRvbiggZXZlbnQudGFyZ2V0ICkgKS5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCX0sCgkJImZvY3Vzb3V0IGJsdXIiOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCSQoIGNsb3Nlc3RFbmFibGVkQnV0dG9uKCBldmVudC50YXJnZXQgKSApLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJfQoJfSk7CgoJYXR0YWNoRXZlbnRzID0gbnVsbDsKfTsKCi8vbGlua3MgaW4gYmFycywgb3IgdGhvc2Ugd2l0aCAgZGF0YS1yb2xlIGJlY29tZSBidXR0b25zCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCgkkKCAiOmpxbURhdGEocm9sZT0nYnV0dG9uJyksIC51aS1iYXIgPiBhLCAudWktaGVhZGVyID4gYSwgLnVpLWZvb3RlciA+IGEsIC51aS1iYXIgPiA6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSA+IGEiLCBlLnRhcmdldCApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiYnV0dG9uLCBpbnB1dCwgLnVpLWJ0biwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYnV0dG9uTWFya3VwKCk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY29sbGFwc2libGUiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgkJY29sbGFwc2VDdWVUZXh0OiAiIGNsaWNrIHRvIGNvbGxhcHNlIGNvbnRlbnRzIiwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJCWV4cGFuZGVkSWNvbjogIm1pbnVzIiwKCQlpY29ucG9zOiAibGVmdCIsCgkJdGhlbWU6IG51bGwsCgkJY29udGVudFRoZW1lOiBudWxsLAoJCWluc2V0OiB0cnVlLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJY29sbGFwc2libGUgPSAkZWwuYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSIgKSwKCQkJY29sbGFwc2libGVIZWFkaW5nID0gJGVsLmNoaWxkcmVuKCBvLmhlYWRpbmcgKS5maXJzdCgpLAoJCQljb2xsYXBzaWJsZUNvbnRlbnQgPSBjb2xsYXBzaWJsZS53cmFwSW5uZXIoICI8ZGl2IGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1jb250ZW50Jz48L2Rpdj4iICkuY2hpbGRyZW4oICIudWktY29sbGFwc2libGUtY29udGVudCIgKSwKCQkJY29sbGFwc2libGVTZXQgPSAkZWwuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlLXNldCcpIiApLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQljb2xsYXBzaWJsZUNsYXNzZXMgPSAiIjsKCgkJLy8gUmVwbGFjZSBjb2xsYXBzaWJsZUhlYWRpbmcgaWYgaXQncyBhIGxlZ2VuZAoJCWlmICggY29sbGFwc2libGVIZWFkaW5nLmlzKCAibGVnZW5kIiApICkgewoJCQljb2xsYXBzaWJsZUhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyBjb2xsYXBzaWJsZUhlYWRpbmcuaHRtbCgpICsiPC9kaXY+IiApLmluc2VydEJlZm9yZSggY29sbGFwc2libGVIZWFkaW5nICk7CgkJCWNvbGxhcHNpYmxlSGVhZGluZy5uZXh0KCkucmVtb3ZlKCk7CgkJfQoKCQkvLyBJZiB3ZSBhcmUgaW4gYSBjb2xsYXBzaWJsZSBzZXQKCQlpZiAoIGNvbGxhcHNpYmxlU2V0Lmxlbmd0aCApIHsKCQkJLy8gSW5oZXJpdCB0aGUgdGhlbWUgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQkJaWYgKCAhby50aGVtZSApIHsKCQkJCW8udGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAidGhlbWUiICkgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbGxhcHNpYmxlU2V0LCAiYyIgKTsKCQkJfQoJCQkvLyBJbmhlcml0IHRoZSBjb250ZW50LXRoZW1lIGZyb20gY29sbGFwc2libGUtc2V0CgkJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQkJby5jb250ZW50VGhlbWUgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQkJfQoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBjb2xsYXBzZWQgaWNvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5jb2xsYXBzZWRJY29uID0gJGVsLmpxbURhdGEoICJjb2xsYXBzZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiY29sbGFwc2VkLWljb24iICkgfHwgby5jb2xsYXBzZWRJY29uOwoKCQkJLy8gR2V0IHRoZSBwcmVmZXJlbmNlIGZvciBleHBhbmRlZCBpY29uIGluIHRoZSBzZXQsIGJ1dCBvdmVycmlkZSB3aXRoIGRhdGEtIGF0dHJpYnV0ZSBvbiB0aGUgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZQoJCQlvLmV4cGFuZGVkSWNvbiA9ICRlbC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiZXhwYW5kZWQtaWNvbiIgKSB8fCBvLmV4cGFuZGVkSWNvbjsKCgkJCS8vIEdldHMgdGhlIHByZWZlcmVuY2UgaWNvbiBwb3NpdGlvbiBpbiB0aGUgc2V0LCBidXQgb3ZlcnJpZGUgd2l0aCBkYXRhLSBhdHRyaWJ1dGUgb24gdGhlIGluZGl2aWR1YWwgY29sbGFwc2libGUKCQkJby5pY29ucG9zID0gJGVsLmpxbURhdGEoICJpY29ucG9zIiApIHx8IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJpY29ucG9zIiApIHx8IG8uaWNvbnBvczsKCgkJCS8vIEluaGVyaXQgdGhlIHByZWZlcmVuY2UgZm9yIGluc2V0IGZyb20gY29sbGFwc2libGUtc2V0IG9yIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSB0byBlbnN1cmUgZXF1YWx0eSB3aXRoaW4gYSBzZXQKCQkJaWYgKCBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICkgIT09IHVuZGVmaW5lZCApIHsKCQkJCW8uaW5zZXQgPSBjb2xsYXBzaWJsZVNldC5qcW1EYXRhKCAiaW5zZXQiICk7CgkJCX0gZWxzZSB7CgkJCQlvLmluc2V0ID0gdHJ1ZTsKCQkJfQoJCQkvLyBTZXQgY29ybmVycyBmb3IgaW5kaXZpZHVhbCBjb2xsYXBzaWJsZXMgdG8gZmFsc2Ugd2hlbiBpbiBhIGNvbGxhcHNpYmxlLXNldAoJCQlvLmNvcm5lcnMgPSBmYWxzZTsKCQkJLy8gR2V0cyB0aGUgcHJlZmVyZW5jZSBmb3IgbWluaSBpbiB0aGUgc2V0CgkJCWlmICggIW8ubWluaSApIHsKCQkJCW8ubWluaSA9IGNvbGxhcHNpYmxlU2V0LmpxbURhdGEoICJtaW5pIiApOwoJCQl9CgkJfSBlbHNlIHsKCQkJLy8gZ2V0IGluaGVyaXRlZCB0aGVtZSBpZiBub3QgYSBzZXQgYW5kIG5vIHRoZW1lIGhhcyBiZWVuIHNldAoJCQlpZiAoICFvLnRoZW1lICkgewoJCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCAkZWwsICJjIiApOwoJCQl9CgkJfQoKCQlpZiAoICEhby5pbnNldCApIHsKCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29sbGFwc2libGUtaW5zZXQiOwoJCQlpZiAoICEhby5jb3JuZXJzICkgewoJCQkJY29sbGFwc2libGVDbGFzc2VzICs9ICIgdWktY29ybmVyLWFsbCIgOwoJCQl9CgkJfQoJCWlmICggby5jb250ZW50VGhlbWUgKSB7CgkJCWNvbGxhcHNpYmxlQ2xhc3NlcyArPSAiIHVpLWNvbGxhcHNpYmxlLXRoZW1lZC1jb250ZW50IjsKCQkJY29sbGFwc2libGVDb250ZW50LmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9CgkJaWYgKCBjb2xsYXBzaWJsZUNsYXNzZXMgIT09ICIiICkgewoJCQljb2xsYXBzaWJsZS5hZGRDbGFzcyggY29sbGFwc2libGVDbGFzc2VzICk7CgkJfQoJCQoJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkvL2Ryb3AgaGVhZGluZyBpbiBiZWZvcmUgY29udGVudAoJCQkuaW5zZXJ0QmVmb3JlKCBjb2xsYXBzaWJsZUNvbnRlbnQgKQoJCQkvL21vZGlmeSBtYXJrdXAgJiBhdHRyaWJ1dGVzCgkJCS5hZGRDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmciICkKCQkJLmFwcGVuZCggIjxzcGFuIGNsYXNzPSd1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyc+PC9zcGFuPiIgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5idXR0b25NYXJrdXAoewoJCQkJCXNoYWRvdzogZmFsc2UsCgkJCQkJY29ybmVyczogZmFsc2UsCgkJCQkJaWNvbnBvczogby5pY29ucG9zLAoJCQkJCWljb246IG8uY29sbGFwc2VkSWNvbiwKCQkJCQltaW5pOiBvLm1pbmksCgkJCQkJdGhlbWU6IG8udGhlbWUKCQkJCX0pOwoKCQkvL2V2ZW50cwoJCWNvbGxhcHNpYmxlCgkJCS5iaW5kKCAiZXhwYW5kIGNvbGxhcHNlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJCQlpc0NvbGxhcHNlID0gKCBldmVudC50eXBlID09PSAiY29sbGFwc2UiICk7CgoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJCWNvbGxhcHNpYmxlSGVhZGluZwoJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkJCQkuZmluZCggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLXN0YXR1cyIgKQoJCQkJCQkJLnRleHQoIGlzQ29sbGFwc2UgPyBvLmV4cGFuZEN1ZVRleHQgOiBvLmNvbGxhcHNlQ3VlVGV4dCApCgkJCQkJCS5lbmQoKQoJCQkJCQkuZmluZCggIi51aS1pY29uIiApCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvLmV4cGFuZGVkSWNvbiwgIWlzQ29sbGFwc2UgKQoJCQkJCQkJLy8gbG9naWMgb3IgY2F1c2Ugc2FtZSBpY29uIGZvciBleHBhbmRlZC9jb2xsYXBzZWQgc3RhdGUgd291bGQgcmVtb3ZlIHRoZSB1aS1pY29uLWNsYXNzCgkJCQkJCQkudG9nZ2xlQ2xhc3MoICJ1aS1pY29uLSIgKyBvLmNvbGxhcHNlZEljb24sICggaXNDb2xsYXBzZSB8fCBvLmV4cGFuZGVkSWNvbiA9PT0gby5jb2xsYXBzZWRJY29uICkgKQoJCQkJCQkuZW5kKCkKCQkJCQkJLmZpbmQoICJhIiApLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJCSR0aGlzLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApOwoJCQkJCWNvbGxhcHNpYmxlQ29udGVudC50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWNvbnRlbnQtY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApLmF0dHIoICJhcmlhLWhpZGRlbiIsIGlzQ29sbGFwc2UgKTsKCgkJCQkJY29sbGFwc2libGVDb250ZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJCQl9CgkJCX0pCgkJCS50cmlnZ2VyKCBvLmNvbGxhcHNlZCA/ICJjb2xsYXBzZSIgOiAiZXhwYW5kIiApOwoKCQljb2xsYXBzaWJsZUhlYWRpbmcKCQkJLmJpbmQoICJ0YXAiLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQljb2xsYXBzaWJsZUhlYWRpbmcuZmluZCggImEiICkuZmlyc3QoKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQl2YXIgdHlwZSA9IGNvbGxhcHNpYmxlSGVhZGluZy5pcyggIi51aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSA/ICJleHBhbmQiIDogImNvbGxhcHNlIjsKCgkJCQljb2xsYXBzaWJsZS50cmlnZ2VyKCB0eXBlICk7CgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzID0gewoJX2dldFZpc2libGVzOiBmdW5jdGlvbiggJGVscywgY3JlYXRlICkgewoJCXZhciB2aXNpYmxlczsKCgkJaWYgKCBjcmVhdGUgKSB7CgkJCXZpc2libGVzID0gJGVscy5ub3QoICIudWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9IGVsc2UgewoJCQl2aXNpYmxlcyA9ICRlbHMuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCWlmICggdmlzaWJsZXMubGVuZ3RoID09PSAwICkgewoJCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gdmlzaWJsZXM7Cgl9LAoKCV9hZGRGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscywgJHZpc2libGVzLCBjcmVhdGUgKSB7CgkJJGVscy5yZW1vdmVDbGFzcyggInVpLWZpcnN0LWNoaWxkIHVpLWxhc3QtY2hpbGQiICk7CgkJJHZpc2libGVzLmVxKCAwICkuYWRkQ2xhc3MoICJ1aS1maXJzdC1jaGlsZCIgKS5lbmQoKS5sYXN0KCkuYWRkQ2xhc3MoICJ1aS1sYXN0LWNoaWxkIiApOwoJCWlmICggIWNyZWF0ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJ1cGRhdGVsYXlvdXQiICk7CgkJfQoJfQp9OwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5jb2xsYXBzaWJsZXNldCIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIKCX0sCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApLAoJCQlvID0gdGhpcy5vcHRpb25zOwoKCQkvLyBJbmhlcml0IHRoZSB0aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8udGhlbWUgKSB7CgkJCW8udGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggJGVsLCAiYyIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29udGVudC10aGVtZSBmcm9tIGNvbGxhcHNpYmxlLXNldAoJCWlmICggIW8uY29udGVudFRoZW1lICkgewoJCQlvLmNvbnRlbnRUaGVtZSA9ICRlbC5qcW1EYXRhKCAiY29udGVudC10aGVtZSIgKTsKCQl9CgkJLy8gSW5oZXJpdCB0aGUgY29ybmVyIHN0eWxpbmcgZnJvbSBjb2xsYXBzaWJsZS1zZXQKCQlpZiAoICFvLmNvcm5lcnMgKSB7CgkJCW8uY29ybmVycyA9ICRlbC5qcW1EYXRhKCAiY29ybmVycyIgKTsKCQl9CgkJCgkJaWYgKCAkZWwuanFtRGF0YSggImluc2V0IiApICE9PSB1bmRlZmluZWQgKSB7CgkJCW8uaW5zZXQgPSAkZWwuanFtRGF0YSggImluc2V0IiApOwoJCX0KCQlvLmluc2V0ID0gby5pbnNldCAhPT0gdW5kZWZpbmVkID8gby5pbnNldCA6IHRydWU7CgkJby5jb3JuZXJzID0gby5jb3JuZXJzICE9PSB1bmRlZmluZWQgPyBvLmNvcm5lcnMgOiB0cnVlOwoJCQoJCWlmICggISFvLmNvcm5lcnMgJiYgISFvLmluc2V0ICkgewoJCQkkZWwuYWRkQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiApOwoJCX0KCgkJLy8gSW5pdGlhbGl6ZSB0aGUgY29sbGFwc2libGUgc2V0IGlmIGl0J3Mgbm90IGFscmVhZHkgaW5pdGlhbGl6ZWQKCQlpZiAoICEkZWwuanFtRGF0YSggImNvbGxhcHNpYmxlYm91bmQiICkgKSB7CgkJCSRlbAoJCQkJLmpxbURhdGEoICJjb2xsYXBzaWJsZWJvdW5kIiwgdHJ1ZSApCgkJCQkuYmluZCggImV4cGFuZCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQl2YXIgY2xvc2VzdENvbGxhcHNpYmxlID0gJCggZXZlbnQudGFyZ2V0ICkKCQkJCQkJLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgkJCQkJaWYgKCBjbG9zZXN0Q29sbGFwc2libGUucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZS1zZXQnKSIgKSApIHsKCQkJCQkJY2xvc2VzdENvbGxhcHNpYmxlCgkJCQkJCQkuc2libGluZ3MoICIudWktY29sbGFwc2libGUiICkKCQkJCQkJCS50cmlnZ2VyKCAiY29sbGFwc2UiICk7CgkJCQkJfQoJCQkJfSk7CgkJfQoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJY29sbGFwc2libGVzSW5TZXQgPSAkZWwuY2hpbGRyZW4oICI6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZScpIiApLAoJCQlleHBhbmRlZCA9IGNvbGxhcHNpYmxlc0luU2V0LmZpbHRlciggIjpqcW1EYXRhKGNvbGxhcHNlZD0nZmFsc2UnKSIgKTsKCQl0aGlzLl9yZWZyZXNoKCAidHJ1ZSIgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCWV4cGFuZGVkLnRyaWdnZXIoICJleHBhbmQiICk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXZhciBjb2xsYXBzaWJsZXNJblNldCA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2NvbGxhcHNpYmxlJykiICk7CgoJCSQubW9iaWxlLmNvbGxhcHNpYmxlLnByb3RvdHlwZS5lbmhhbmNlKCBjb2xsYXBzaWJsZXNJblNldC5ub3QoICIudWktY29sbGFwc2libGUiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggY29sbGFwc2libGVzSW5TZXQsIHRoaXMuX2dldFZpc2libGVzKCBjb2xsYXBzaWJsZXNJblNldCwgY3JlYXRlICksIGNyZWF0ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJfQp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuYWRkRmlyc3RMYXN0Q2xhc3NlcyApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jb2xsYXBzaWJsZXNldC5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIGZpbHRlciBmdW5jdGlvbiByZW1vdmVzIHdoaXRlc3BhY2UgYmV0d2VlbiBsYWJlbCBhbmQgZm9ybSBlbGVtZW50IHNvIHdlIGNhbiB1c2UgaW5saW5lLWJsb2NrIChub2RlVHlwZSAzID0gdGV4dCkKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCXJldHVybiB0aGlzCgkJLmFkZENsYXNzKCAidWktZmllbGQtY29udGFpbiB1aS1ib2R5IHVpLWJyIiApCgkJLmNvbnRlbnRzKCkuZmlsdGVyKCBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICggdGhpcy5ub2RlVHlwZSA9PT0gMyAmJiAhL1xTLy50ZXN0KCB0aGlzLm5vZGVWYWx1ZSApICk7CgkJfSkucmVtb3ZlKCk7Cn07CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQoICI6anFtRGF0YShyb2xlPSdmaWVsZGNvbnRhaW4nKSIsIGUudGFyZ2V0ICkuanFtRW5oYW5jZWFibGUoKS5maWVsZGNvbnRhaW4oKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yOwoKCQkJaWYgKCAhZ3JpZCApIHsKCQkJCWlmICggJGtpZHMubGVuZ3RoIDw9IDUgKSB7CgkJCQkJZm9yICggdmFyIGxldHRlciBpbiBncmlkQ29scyApIHsKCQkJCQkJaWYgKCBncmlkQ29sc1sgbGV0dGVyIF0gPT09ICRraWRzLmxlbmd0aCApIHsKCQkJCQkJCWdyaWQgPSBsZXR0ZXI7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWdyaWQgPSAiYSI7CgkJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLWR1byIgKTsKCQkJCX0KCQkJfQoJCQlpdGVyYXRvciA9IGdyaWRDb2xzW2dyaWRdOwoKCQkkdGhpcy5hZGRDbGFzcyggInVpLWdyaWQtIiArIGdyaWQgKTsKCgkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisxKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWEiICk7CgoJCWlmICggaXRlcmF0b3IgPiAxICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzIpIiApLmFkZENsYXNzKCAidWktYmxvY2stYiIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDIgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMykiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1jIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gMyApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis0KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWQiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiA0ICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzUpIiApLmFkZENsYXNzKCAidWktYmxvY2stZSIgKTsKCQl9Cgl9KTsKfTsKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5uYXZiYXIiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQlpY29ucG9zOiAidG9wIiwKCQlncmlkOiBudWxsLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J25hdmJhcicpIgoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJdmFyICRuYXZiYXIgPSB0aGlzLmVsZW1lbnQsCgkJCSRuYXZidG5zID0gJG5hdmJhci5maW5kKCAiYSIgKSwKCQkJaWNvbnBvcyA9ICRuYXZidG5zLmZpbHRlciggIjpqcW1EYXRhKGljb24pIiApLmxlbmd0aCA/CgkJCQkJCQkJCXRoaXMub3B0aW9ucy5pY29ucG9zIDogdW5kZWZpbmVkOwoKCQkkbmF2YmFyLmFkZENsYXNzKCAidWktbmF2YmFyIHVpLW1pbmkiICkKCQkJLmF0dHIoICJyb2xlIiwgIm5hdmlnYXRpb24iICkKCQkJLmZpbmQoICJ1bCIgKQoJCQkuanFtRW5oYW5jZWFibGUoKQoJCQkuZ3JpZCh7IGdyaWQ6IHRoaXMub3B0aW9ucy5ncmlkIH0pOwoKCQkkbmF2YnRucy5idXR0b25NYXJrdXAoewoJCQljb3JuZXJzOglmYWxzZSwKCQkJc2hhZG93OgkJZmFsc2UsCgkJCWlubGluZTogICAgIHRydWUsCgkJCWljb25wb3M6CWljb25wb3MKCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyB1aS1idG4taW5uZXIgaXMgcmV0dXJuZWQgYXMgdGFyZ2V0CgkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKS5pcyggImEiICkgPyAkKCB0aGlzICkgOiAkKCB0aGlzICkucGFyZW50KCAiYSIgKTsKCQkJCgkJCWlmICggIXRhcmdldC5pcyggIi51aS1kaXNhYmxlZCwgLnVpLWJ0bi1hY3RpdmUiICkgKSB7CgkJCQkkbmF2YnRucy5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJdmFyIGFjdGl2ZUJ0biA9ICQoIHRoaXMgKTsKCQkJCQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5uYXZiYXIucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgovL0tlZXBzIHRyYWNrIG9mIHRoZSBudW1iZXIgb2YgbGlzdHMgcGVyIHBhZ2UgVUlECi8vVGhpcyBhbGxvd3Mgc3VwcG9ydCBmb3IgbXVsdGlwbGUgbmVzdGVkIGxpc3QgaW4gdGhlIHNhbWUgcGFnZQovL2h0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMTYxNwp2YXIgbGlzdENvdW50UGVyUGFnZSA9IHt9OwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS53aWRnZXQsICQuZXh0ZW5kKCB7CgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWNvdW50VGhlbWU6ICJjIiwKCQloZWFkZXJUaGVtZTogImIiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCWljb246ICJhcnJvdy1yIiwKCQlzcGxpdEljb246ICJhcnJvdy1yIiwKCQlzcGxpdFRoZW1lOiAiYiIsCgkJY29ybmVyczogdHJ1ZSwKCQlzaGFkb3c6IHRydWUsCgkJaW5zZXQ6IGZhbHNlLAoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2xpc3R2aWV3JykiCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ID0gdGhpcywKCQkJbGlzdHZpZXdDbGFzc2VzID0gIiI7CgoJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuaW5zZXQgPyAiIHVpLWxpc3R2aWV3LWluc2V0IiA6ICIiOwoKCQlpZiAoICEhdC5vcHRpb25zLmluc2V0ICkgewoJCQlsaXN0dmlld0NsYXNzZXMgKz0gdC5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiI7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiI7CgkJfQoKCQkvLyBjcmVhdGUgbGlzdHZpZXcgbWFya3VwCgkJdC5lbGVtZW50LmFkZENsYXNzKGZ1bmN0aW9uKCBpLCBvcmlnICkgewoJCQlyZXR1cm4gb3JpZyArICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzOwoJCX0pOwoKCQl0LnJlZnJlc2goIHRydWUgKTsKCX0sCgoJLy8gVGhpcyBpcyBhIGdlbmVyaWMgdXRpbGl0eSBtZXRob2QgZm9yIGZpbmRpbmcgdGhlIGZpcnN0CgkvLyBub2RlIHdpdGggYSBnaXZlbiBub2RlTmFtZS4gSXQgdXNlcyBiYXNpYyBET00gdHJhdmVyc2FsCgkvLyB0byBiZSBmYXN0IGFuZCBpcyBtZWFudCB0byBiZSBhIHN1YnN0aXR1dGUgZm9yIHNpbXBsZQoJLy8gJC5mbi5jbG9zZXN0KCkgYW5kICQuZm4uY2hpbGRyZW4oKSBjYWxscyBvbiBhIHNpbmdsZQoJLy8gZWxlbWVudC4gTm90ZSB0aGF0IGNhbGxlcnMgbXVzdCBwYXNzIGJvdGggdGhlIGxvd2VyQ2FzZQoJLy8gYW5kIHVwcGVyQ2FzZSB2ZXJzaW9uIG9mIHRoZSBub2RlTmFtZSB0aGV5IGFyZSBsb29raW5nIGZvci4KCS8vIFRoZSBtYWluIHJlYXNvbiBmb3IgdGhpcyBpcyB0aGF0IHRoaXMgZnVuY3Rpb24gd2lsbCBiZQoJLy8gY2FsbGVkIG1hbnkgdGltZXMgYW5kIHdlIHdhbnQgdG8gYXZvaWQgaGF2aW5nIHRvIGxvd2VyY2FzZQoJLy8gdGhlIG5vZGVOYW1lIGZyb20gdGhlIGVsZW1lbnQgZXZlcnkgdGltZSB0byBlbnN1cmUgd2UgaGF2ZQoJLy8gYSBtYXRjaC4gTm90ZSB0aGF0IHRoaXMgZnVuY3Rpb24gbGl2ZXMgaGVyZSBmb3Igbm93LCBidXQgbWF5CgkvLyBiZSBtb3ZlZCBpbnRvICQubW9iaWxlIGlmIG90aGVyIGNvbXBvbmVudHMgbmVlZCBhIHNpbWlsYXIgbWV0aG9kLgoJX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWU6IGZ1bmN0aW9uKCBlbGUsIG5leHRQcm9wLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmV0dXJuIGVsZTsKCQkJfQoJCQllbGUgPSBlbGVbIG5leHRQcm9wIF07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCV9nZXRDaGlsZHJlbkJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbGNOYW1lLCB1Y05hbWUgKSB7CgkJdmFyIHJlc3VsdHMgPSBbXSwKCQkJZGljdCA9IHt9OwoJCWRpY3RbIGxjTmFtZSBdID0gZGljdFsgdWNOYW1lIF0gPSB0cnVlOwoJCWVsZSA9IGVsZS5maXJzdENoaWxkOwoJCXdoaWxlICggZWxlICkgewoJCQlpZiAoIGRpY3RbIGVsZS5ub2RlTmFtZSBdICkgewoJCQkJcmVzdWx0cy5wdXNoKCBlbGUgKTsKCQkJfQoJCQllbGUgPSBlbGUubmV4dFNpYmxpbmc7CgkJfQoJCXJldHVybiAkKCByZXN1bHRzICk7Cgl9LAoKCV9hZGRUaHVtYkNsYXNzZXM6IGZ1bmN0aW9uKCBjb250YWluZXJzICkgewoJCXZhciBpLCBpbWcsIGxlbiA9IGNvbnRhaW5lcnMubGVuZ3RoOwoJCWZvciAoIGkgPSAwOyBpIDwgbGVuOyBpKysgKSB7CgkJCWltZyA9ICQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGNvbnRhaW5lcnNbIGkgXS5maXJzdENoaWxkLCAibmV4dFNpYmxpbmciLCAiaW1nIiwgIklNRyIgKSApOwoJCQlpZiAoIGltZy5sZW5ndGggKSB7CgkJCQlpbWcuYWRkQ2xhc3MoICJ1aS1saS10aHVtYiIgKTsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5pcyggIi51aS1saS1pY29uIiApID8gInVpLWxpLWhhcy1pY29uIiA6ICJ1aS1saS1oYXMtdGh1bWIiICk7CgkJCX0KCQl9Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5wYXJlbnRQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQl0aGlzLl9jcmVhdGVTdWJQYWdlcygpOwoKCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJJGxpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXNlbGYgPSB0aGlzLAoJCQlkaXZpZGVydGhlbWUgPSAkbGlzdC5qcW1EYXRhKCAiZGl2aWRlcnRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lLAoJCQlsaXN0c3BsaXR0aGVtZSA9ICRsaXN0LmpxbURhdGEoICJzcGxpdHRoZW1lIiApLAoJCQlsaXN0c3BsaXRpY29uID0gJGxpc3QuanFtRGF0YSggInNwbGl0aWNvbiIgKSwKCQkJbGlzdGljb24gPSAkbGlzdC5qcW1EYXRhKCAiaWNvbiIgKSwKCQkJbGkgPSB0aGlzLl9nZXRDaGlsZHJlbkJ5VGFnTmFtZSggJGxpc3RbIDAgXSwgImxpIiwgIkxJIiApLAoJCQlvbCA9ICEhJC5ub2RlTmFtZSggJGxpc3RbIDAgXSwgIm9sIiApLAoJCQlqc0NvdW50ID0gISQuc3VwcG9ydC5jc3NQc2V1ZG9FbGVtZW50LAoJCQlzdGFydCA9ICRsaXN0LmF0dHIoICJzdGFydCIgKSwKCQkJaXRlbUNsYXNzRGljdCA9IHt9LAoJCQlpdGVtLCBpdGVtQ2xhc3MsIGl0ZW1UaGVtZSwKCQkJYSwgbGFzdCwgc3BsaXR0aGVtZSwgY291bnRlciwgc3RhcnRDb3VudCwgbmV3U3RhcnRDb3VudCwgY291bnRQYXJlbnQsIGljb24sIGltZ1BhcmVudHMsIGltZywgbGlua0ljb247CgoJCWlmICggb2wgJiYganNDb3VudCApIHsKCQkJJGxpc3QuZmluZCggIi51aS1saS1kZWMiICkucmVtb3ZlKCk7CgkJfQoKCQlpZiAoIG9sICkgewoJCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQkJaWYgKCBzdGFydCB8fCBzdGFydCA9PT0gMCApIHsKCQkJCWlmICggIWpzQ291bnQgKSB7CgkJCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCAsIDEwICkgLSAxOwoJCQkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCQkJfSBlbHNlIHsKCQkJCQljb3VudGVyID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKTsKCQkJCX0KCQkJfSBlbHNlIGlmICgganNDb3VudCApIHsKCQkJCQljb3VudGVyID0gMTsKCQkJfQoJCX0KCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJZm9yICggdmFyIHBvcyA9IDAsIG51bWxpID0gbGkubGVuZ3RoOyBwb3MgPCBudW1saTsgcG9zKysgKSB7CgkJCWl0ZW0gPSBsaS5lcSggcG9zICk7CgkJCWl0ZW1DbGFzcyA9ICJ1aS1saSI7CgoJCQkvLyBJZiB3ZSdyZSBjcmVhdGluZyB0aGUgZWxlbWVudCwgd2UgdXBkYXRlIGl0IHJlZ2FyZGxlc3MKCQkJaWYgKCBjcmVhdGUgfHwgIWl0ZW0uaGFzQ2xhc3MoICJ1aS1saSIgKSApIHsKCQkJCWl0ZW1UaGVtZSA9IGl0ZW0uanFtRGF0YSggInRoZW1lIiApIHx8IG8udGhlbWU7CgkJCQlhID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIGl0ZW1bIDAgXSwgImEiLCAiQSIgKTsKCQkJCXZhciBpc0RpdmlkZXIgPSAoIGl0ZW0uanFtRGF0YSggInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiAhaXNEaXZpZGVyICkgewoJCQkJCWljb24gPSBpdGVtLmpxbURhdGEoICJpY29uIiApOwoKCQkJCQlpdGVtLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCXdyYXBwZXJFbHM6ICJkaXYiLAoJCQkJCQlzaGFkb3c6IGZhbHNlLAoJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJaWNvbnBvczogInJpZ2h0IiwKCQkJCQkJaWNvbjogYS5sZW5ndGggPiAxIHx8IGljb24gPT09IGZhbHNlID8gZmFsc2UgOiBpY29uIHx8IGxpc3RpY29uIHx8IG8uaWNvbiwKCQkJCQkJdGhlbWU6IGl0ZW1UaGVtZQoJCQkJCX0pOwoKCQkJCQlpZiAoICggaWNvbiAhPT0gZmFsc2UgKSAmJiAoIGEubGVuZ3RoID09PSAxICkgKSB7CgkJCQkJCWl0ZW0uYWRkQ2xhc3MoICJ1aS1saS1oYXMtYXJyb3ciICk7CgkJCQkJfQoKCQkJCQlhLmZpcnN0KCkucmVtb3ZlQ2xhc3MoICJ1aS1saW5rIiApLmFkZENsYXNzKCAidWktbGluay1pbmhlcml0IiApOwoKCQkJCQlpZiAoIGEubGVuZ3RoID4gMSApIHsKCQkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktaGFzLWFsdCI7CgoJCQkJCQlsYXN0ID0gYS5sYXN0KCk7CgkJCQkJCXNwbGl0dGhlbWUgPSBsaXN0c3BsaXR0aGVtZSB8fCBsYXN0LmpxbURhdGEoICJ0aGVtZSIgKSB8fCBvLnNwbGl0VGhlbWU7CgkJCQkJCWxpbmtJY29uID0gbGFzdC5qcW1EYXRhKCAiaWNvbiIgKTsKCgkJCQkJCWxhc3QuYXBwZW5kVG8oIGl0ZW0gKQoJCQkJCQkJLmF0dHIoICJ0aXRsZSIsICQudHJpbShsYXN0LmdldEVuY29kZWRUZXh0KCkpICkKCQkJCQkJCS5hZGRDbGFzcyggInVpLWxpLWxpbmstYWx0IiApCgkJCQkJCQkuZW1wdHkoKQoJCQkJCQkJLmJ1dHRvbk1hcmt1cCh7CgkJCQkJCQkJc2hhZG93OiBmYWxzZSwKCQkJCQkJCQljb3JuZXJzOiBmYWxzZSwKCQkJCQkJCQl0aGVtZTogaXRlbVRoZW1lLAoJCQkJCQkJCWljb246IGZhbHNlLAoJCQkJCQkJCWljb25wb3M6ICJub3RleHQiCgkJCQkJCQl9KQoJCQkJCQkJLmZpbmQoICIudWktYnRuLWlubmVyIiApCgkJCQkJCQkJLmFwcGVuZCgKCQkJCQkJCQkJJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKS5idXR0b25NYXJrdXAoewoJCQkJCQkJCQkJc2hhZG93OiB0cnVlLAoJCQkJCQkJCQkJY29ybmVyczogdHJ1ZSwKCQkJCQkJCQkJCXRoZW1lOiBzcGxpdHRoZW1lLAoJCQkJCQkJCQkJaWNvbnBvczogIm5vdGV4dCIsCgkJCQkJCQkJCQkvLyBsaW5rIGljb24gb3ZlcnJpZGVzIGxpc3QgaXRlbSBpY29uIG92ZXJyaWRlcyB1bCBlbGVtZW50IG92ZXJyaWRlcyBvcHRpb25zCgkJCQkJCQkJCQlpY29uOiBsaW5rSWNvbiB8fCBpY29uIHx8IGxpc3RzcGxpdGljb24gfHwgby5zcGxpdEljb24KCQkJCQkJCQkJfSkKCQkJCQkJCQkpOwoJCQkJCX0KCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCgkJCQkJaXRlbUNsYXNzICs9ICIgdWktbGktZGl2aWRlciB1aS1iYXItIiArICggaXRlbS5qcW1EYXRhKCAidGhlbWUiICkgfHwgZGl2aWRlcnRoZW1lICk7CgkJCQkJaXRlbS5hdHRyKCAicm9sZSIsICJoZWFkaW5nIiApOwoKCQkJCQlpZiAoIG9sICkgewoJCQkJCQkvL3Jlc2V0IGNvdW50ZXIgd2hlbiBhIGRpdmlkZXIgaGVhZGluZyBpcyBlbmNvdW50ZXJlZAoJCQkJCQlpZiAoIHN0YXJ0IHx8IHN0YXJ0ID09PSAwICkgewoJCQkJCQkJaWYgKCAhanNDb3VudCApIHsKCQkJCQkJCQluZXdTdGFydENvdW50ID0gcGFyc2VJbnQoIHN0YXJ0ICwgMTAgKSAtIDE7CgkJCQkJCQkJaXRlbS5jc3MoICJjb3VudGVyLXJlc2V0IiwgImxpc3RudW1iZXJpbmcgIiArIG5ld1N0YXJ0Q291bnQgKTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJY291bnRlciA9IHBhcnNlSW50KCBzdGFydCAsIDEwICk7CgkJCQkJCQl9CgkJCQkJCX0gZWxzZSBpZiAoIGpzQ291bnQgKSB7CgkJCQkJCQkJY291bnRlciA9IDE7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfSBlbHNlIHsKCQkJCQlpdGVtQ2xhc3MgKz0gIiB1aS1saS1zdGF0aWMgdWktYnRuLXVwLSIgKyBpdGVtVGhlbWU7CgkJCQl9CgkJCX0KCgkJCWlmICggb2wgJiYganNDb3VudCAmJiBpdGVtQ2xhc3MuaW5kZXhPZiggInVpLWxpLWRpdmlkZXIiICkgPCAwICkgewoJCQkJY291bnRQYXJlbnQgPSBpdGVtQ2xhc3MuaW5kZXhPZiggInVpLWxpLXN0YXRpYyIgKSA+IDAgPyBpdGVtIDogaXRlbS5maW5kKCAiLnVpLWxpbmstaW5oZXJpdCIgKTsKCgkJCQljb3VudFBhcmVudC5hZGRDbGFzcyggInVpLWxpLWpzbnVtYmVyaW5nIiApCgkJCQkJLnByZXBlbmQoICI8c3BhbiBjbGFzcz0ndWktbGktZGVjJz4iICsgKCBjb3VudGVyKysgKSArICIuIDwvc3Bhbj4iICk7CgkJCX0KCgkJCS8vIEluc3RlYWQgb2Ygc2V0dGluZyBpdGVtIGNsYXNzIGRpcmVjdGx5IG9uIHRoZSBsaXN0IGl0ZW0gYW5kIGl0cwoJCQkvLyBidG4taW5uZXIgYXQgdGhpcyBwb2ludCBpbiB0aW1lLCBwdXNoIHRoZSBpdGVtIGludG8gYSBkaWN0aW9uYXJ5CgkJCS8vIHRoYXQgdGVsbHMgdXMgd2hhdCBjbGFzcyB0byBzZXQgb24gaXQgc28gd2UgY2FuIGRvIHRoaXMgYWZ0ZXIgdGhpcwoJCQkvLyBwcm9jZXNzaW5nIGxvb3AgaXMgZmluaXNoZWQuCgoJCQlpZiAoICFpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApIHsKCQkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdID0gW107CgkJCX0KCgkJCWl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdLnB1c2goIGl0ZW1bIDAgXSApOwoJCX0KCgkJLy8gU2V0IHRoZSBhcHByb3ByaWF0ZSBsaXN0dmlldyBpdGVtIGNsYXNzZXMgb24gZWFjaCBsaXN0IGl0ZW0KCQkvLyBhbmQgdGhlaXIgYnRuLWlubmVyIGVsZW1lbnRzLiBUaGUgbWFpbiByZWFzb24gd2UgZGlkbid0IGRvIHRoaXMKCQkvLyBpbiB0aGUgZm9yLWxvb3AgYWJvdmUgaXMgYmVjYXVzZSB3ZSBjYW4gZWxpbWluYXRlIHBlci1pdGVtIGZ1bmN0aW9uIG92ZXJoZWFkCgkJLy8gYnkgY2FsbGluZyBhZGRDbGFzcygpIGFuZCBjaGlsZHJlbigpIG9uY2Ugb3IgdHdpY2UgYWZ0ZXJ3YXJkcy4gVGhpcwoJCS8vIGNhbiBnaXZlIHVzIGEgc2lnbmlmaWNhbnQgYm9vc3Qgb24gcGxhdGZvcm1zIGxpa2UgV1A3LjUuCgoJCWZvciAoIGl0ZW1DbGFzcyBpbiBpdGVtQ2xhc3NEaWN0ICkgewoJCQkkKCBpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSApLmFkZENsYXNzKCBpdGVtQ2xhc3MgKS5jaGlsZHJlbiggIi51aS1idG4taW5uZXIiICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJJGxpc3QuZmluZCggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkuYWRkQ2xhc3MoICJ1aS1saS1oZWFkaW5nIiApCgkJCS5lbmQoKQoKCQkJLmZpbmQoICJwLCBkbCIgKS5hZGRDbGFzcyggInVpLWxpLWRlc2MiICkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1hc2lkZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCQkJCQkkdGhpcy5wcmVwZW5kVG8oICR0aGlzLnBhcmVudCgpICk7IC8vc2hpZnQgYXNpZGUgdG8gZnJvbnQgZm9yIGNzcyBmbG9hdAoJCQkJfSkKCQkJLmVuZCgpCgoJCQkuZmluZCggIi51aS1saS1jb3VudCIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCSQoIHRoaXMgKS5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS1saS1oYXMtY291bnQiICk7CgkJCQl9KS5hZGRDbGFzcyggInVpLWJ0bi11cC0iICsgKCAkbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCB0aGlzLm9wdGlvbnMuY291bnRUaGVtZSkgKyAiIHVpLWJ0bi1jb3JuZXItYWxsIiApOwoKCQkvLyBUaGUgaWRlYSBoZXJlIGlzIHRvIGxvb2sgYXQgdGhlIGZpcnN0IGltYWdlIGluIHRoZSBsaXN0IGl0ZW0KCQkvLyBpdHNlbGYsIGFuZCBhbnkgLnVpLWxpbmstaW5oZXJpdCBlbGVtZW50IGl0IG1heSBjb250YWluLCBzbyB3ZQoJCS8vIGNhbiBwbGFjZSB0aGUgYXBwcm9wcmlhdGUgY2xhc3NlcyBvbiB0aGUgaW1hZ2UgYW5kIGxpc3QgaXRlbS4KCQkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2Ugc29tZXRoaW5nIGxpa2U6CgkJLy8KCQkvLyAgICBsaS5maW5kKCI+aW1nOmVxKDApLCAudWktbGluay1pbmhlcml0PmltZzplcSgwKSIpLmVhY2goIC4uLiApOwoJCS8vCgkJLy8gQnV0IGV4ZWN1dGluZyBhIGZpbmQoKSBsaWtlIHRoYXQgb24gV2luZG93cyBQaG9uZSA3LjUgdG9vayBhCgkJLy8gcmVhbGx5IGxvbmcgdGltZS4gV2Fsa2luZyB0aGluZ3MgbWFudWFsbHkgd2l0aCB0aGUgY29kZSBiZWxvdwoJCS8vIGFsbG93cyB0aGUgNDAwIGxpc3R2aWV3IGl0ZW0gcGFnZSB0byBsb2FkIGluIGFib3V0IDMgc2Vjb25kcyBhcwoJCS8vIG9wcG9zZWQgdG8gMzAgc2Vjb25kcy4KCgkJdGhpcy5fYWRkVGh1bWJDbGFzc2VzKCBsaSApOwoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggJGxpc3QuZmluZCggIi51aS1saW5rLWluaGVyaXQiICkgKTsKCgkJdGhpcy5fYWRkRmlyc3RMYXN0Q2xhc3NlcyggbGksIHRoaXMuX2dldFZpc2libGVzKCBsaSwgY3JlYXRlICksIGNyZWF0ZSApOwoJCS8vIGF1dG9kaXZpZGVycyBiaW5kcyB0byB0aGlzIHRvIHJlZHJhdyBkaXZpZGVycyBhZnRlciB0aGUgbGlzdHZpZXcgcmVmcmVzaAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcnJlZnJlc2giICk7Cgl9LAoKCS8vY3JlYXRlIGEgc3RyaW5nIGZvciBJRC9zdWJwYWdlIHVybCBjcmVhdGlvbgoJX2lkU3RyaW5nRXNjYXBlOiBmdW5jdGlvbiggc3RyICkgewoJCXJldHVybiBzdHIucmVwbGFjZSgvW15hLXpBLVowLTldL2csICctJyk7Cgl9LAoKCV9jcmVhdGVTdWJQYWdlczogZnVuY3Rpb24oKSB7CgkJdmFyIHBhcmVudExpc3QgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFBhZ2UgPSBwYXJlbnRMaXN0LmNsb3Nlc3QoICIudWktcGFnZSIgKSwKCQkJcGFyZW50VXJsID0gcGFyZW50UGFnZS5qcW1EYXRhKCAidXJsIiApLAoJCQlwYXJlbnRJZCA9IHBhcmVudFVybCB8fCBwYXJlbnRQYWdlWyAwIF1bICQuZXhwYW5kbyBdLAoJCQlwYXJlbnRMaXN0SWQgPSBwYXJlbnRMaXN0LmF0dHIoICJpZCIgKSwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJZG5zID0gImRhdGEtIiArICQubW9iaWxlLm5zLAoJCQlzZWxmID0gdGhpcywKCQkJcGVyc2lzdGVudEZvb3RlcklEID0gcGFyZW50UGFnZS5maW5kKCAiOmpxbURhdGEocm9sZT0nZm9vdGVyJykiICkuanFtRGF0YSggImlkIiApLAoJCQloYXNTdWJQYWdlczsKCgkJaWYgKCB0eXBlb2YgbGlzdENvdW50UGVyUGFnZVsgcGFyZW50SWQgXSA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCWxpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF0gPSAtMTsKCQl9CgoJCXBhcmVudExpc3RJZCA9IHBhcmVudExpc3RJZCB8fCArK2xpc3RDb3VudFBlclBhZ2VbIHBhcmVudElkIF07CgoJCSQoIHBhcmVudExpc3QuZmluZCggImxpPnVsLCBsaT5vbCIgKS50b0FycmF5KCkucmV2ZXJzZSgpICkuZWFjaChmdW5jdGlvbiggaSApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbGlzdCA9ICQoIHRoaXMgKSwKCQkJCWxpc3RJZCA9IGxpc3QuYXR0ciggImlkIiApIHx8IHBhcmVudExpc3RJZCArICItIiArIGksCgkJCQlwYXJlbnQgPSBsaXN0LnBhcmVudCgpLAoJCQkJbm9kZUVsc0Z1bGwgPSAkKCBsaXN0LnByZXZBbGwoKS50b0FycmF5KCkucmV2ZXJzZSgpICksCgkJCQlub2RlRWxzID0gbm9kZUVsc0Z1bGwubGVuZ3RoID8gbm9kZUVsc0Z1bGwgOiAkKCAiPHNwYW4+IiArICQudHJpbShwYXJlbnQuY29udGVudHMoKVsgMCBdLm5vZGVWYWx1ZSkgKyAiPC9zcGFuPiIgKSwKCQkJCXRpdGxlID0gbm9kZUVscy5maXJzdCgpLmdldEVuY29kZWRUZXh0KCksLy91cmwgbGltaXRzIHRvIGZpcnN0IDMwIGNoYXJzIG9mIHRleHQKCQkJCWlkID0gKCBwYXJlbnRVcmwgfHwgIiIgKSArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiPSIgKyBsaXN0SWQsCgkJCQl0aGVtZSA9IGxpc3QuanFtRGF0YSggInRoZW1lIiApIHx8IG8udGhlbWUsCgkJCQljb3VudFRoZW1lID0gbGlzdC5qcW1EYXRhKCAiY291bnR0aGVtZSIgKSB8fCBwYXJlbnRMaXN0LmpxbURhdGEoICJjb3VudHRoZW1lIiApIHx8IG8uY291bnRUaGVtZSwKCQkJCW5ld1BhZ2UsIGFuY2hvcjsKCgkJCS8vZGVmaW5lIGhhc1N1YlBhZ2VzIGZvciB1c2UgaW4gbGF0ZXIgcmVtb3ZhbAoJCQloYXNTdWJQYWdlcyA9IHRydWU7CgoJCQluZXdQYWdlID0gbGlzdC5kZXRhY2goKQoJCQkJCQkud3JhcCggIjxkaXYgIiArIGRucyArICJyb2xlPSdwYWdlJyAiICsgZG5zICsgInVybD0nIiArIGlkICsgIicgIiArIGRucyArICJ0aGVtZT0nIiArIHRoZW1lICsgIicgIiArIGRucyArICJjb3VudC10aGVtZT0nIiArIGNvdW50VGhlbWUgKyAiJz48ZGl2ICIgKyBkbnMgKyAicm9sZT0nY29udGVudCc+PC9kaXY+PC9kaXY+IiApCgkJCQkJCS5wYXJlbnQoKQoJCQkJCQkJLmJlZm9yZSggIjxkaXYgIiArIGRucyArICJyb2xlPSdoZWFkZXInICIgKyBkbnMgKyAidGhlbWU9JyIgKyBvLmhlYWRlclRoZW1lICsgIic+PGRpdiBjbGFzcz0ndWktdGl0bGUnPiIgKyB0aXRsZSArICI8L2Rpdj48L2Rpdj4iICkKCQkJCQkJCS5hZnRlciggcGVyc2lzdGVudEZvb3RlcklEID8gJCggIjxkaXYgIiArIGRucyArICJyb2xlPSdmb290ZXInICIgKyBkbnMgKyAiaWQ9JyIrIHBlcnNpc3RlbnRGb290ZXJJRCArIic+IiApIDogIiIgKQoJCQkJCQkJLnBhcmVudCgpCgkJCQkJCQkJLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCQluZXdQYWdlLnBhZ2UoKTsKCgkJCWFuY2hvciA9IHBhcmVudC5maW5kKCAnYTpmaXJzdCcgKTsKCgkJCWlmICggIWFuY2hvci5sZW5ndGggKSB7CgkJCQlhbmNob3IgPSAkKCAiPGEvPiIgKS5odG1sKCBub2RlRWxzIHx8IHRpdGxlICkucHJlcGVuZFRvKCBwYXJlbnQuZW1wdHkoKSApOwoJCQl9CgoJCQlhbmNob3IuYXR0ciggImhyZWYiLCAiIyIgKyBpZCApOwoKCQl9KS5saXN0dmlldygpOwoKCQkvLyBvbiBwYWdlaGlkZSwgcmVtb3ZlIGFueSBuZXN0ZWQgcGFnZXMgYWxvbmcgd2l0aCB0aGUgcGFyZW50IHBhZ2UsIGFzIGxvbmcgYXMgdGhleSBhcmVuJ3QgYWN0aXZlCgkJLy8gYW5kIGFyZW4ndCBlbWJlZGRlZAoJCWlmICggaGFzU3ViUGFnZXMgJiYKCQkJcGFyZW50UGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSAmJgoJCQlwYXJlbnRQYWdlLmRhdGEoICJtb2JpbGUtcGFnZSIgKS5vcHRpb25zLmRvbUNhY2hlID09PSBmYWxzZSApIHsKCgkJCXZhciBuZXdSZW1vdmUgPSBmdW5jdGlvbiggZSwgdWkgKSB7CgkJCQl2YXIgbmV4dFBhZ2UgPSB1aS5uZXh0UGFnZSwgbnBVUkwsCgkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQlpZiAoIHVpLm5leHRQYWdlICkgewoJCQkJCW5wVVJMID0gbmV4dFBhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCQlpZiAoIG5wVVJMLmluZGV4T2YoIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKSAhPT0gMCApIHsKCQkJCQkJc2VsZi5jaGlsZFBhZ2VzKCkucmVtb3ZlKCk7CgkJCQkJCXBhcmVudFBhZ2UudHJpZ2dlciggcHJFdmVudCApOwoJCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkJcGFyZW50UGFnZS5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9OwoKCQkJLy8gdW5iaW5kIHRoZSBvcmlnaW5hbCBwYWdlIHJlbW92ZSBhbmQgcmVwbGFjZSB3aXRoIG91ciBzcGVjaWFsaXplZCB2ZXJzaW9uCgkJCXBhcmVudFBhZ2UKCQkJCS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICkKCQkJCS5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiwgbmV3UmVtb3ZlKTsKCQl9Cgl9LAoKCS8vIFRPRE8gc29ydCBvdXQgYSBiZXR0ZXIgd2F5IHRvIHRyYWNrIHN1YiBwYWdlcyBvZiB0aGUgbGlzdHZpZXcgdGhpcyBpcyBicml0dGxlCgljaGlsZFBhZ2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgcGFyZW50VXJsID0gdGhpcy5wYXJlbnRQYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCXJldHVybiAkKCAiOmpxbURhdGEodXJsXj0nIisgIHBhcmVudFVybCArICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXkgKyAiJykiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLndpZGdldCwgewoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ndGV4dCddLCBpbnB1dFt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJyksIGlucHV0W3R5cGU9J251bWJlciddLCA6anFtRGF0YSh0eXBlPSdudW1iZXInKSwgaW5wdXRbdHlwZT0ncGFzc3dvcmQnXSwgaW5wdXRbdHlwZT0nZW1haWwnXSwgaW5wdXRbdHlwZT0ndXJsJ10sIGlucHV0W3R5cGU9J3RlbCddLCB0ZXh0YXJlYSwgaW5wdXRbdHlwZT0ndGltZSddLCBpbnB1dFt0eXBlPSdkYXRlJ10sIGlucHV0W3R5cGU9J21vbnRoJ10sIGlucHV0W3R5cGU9J3dlZWsnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUnXSwgaW5wdXRbdHlwZT0nZGF0ZXRpbWUtbG9jYWwnXSwgaW5wdXRbdHlwZT0nY29sb3InXSwgaW5wdXQ6bm90KFt0eXBlXSksIGlucHV0W3R5cGU9J2ZpbGUnXSIsCgkJY2xlYXJCdG46IGZhbHNlLAoJCWNsZWFyU2VhcmNoQnV0dG9uVGV4dDogbnVsbCwgLy9kZXByZWNhdGluZyBmb3IgMS4zLi4uCgkJY2xlYXJCdG5UZXh0OiAiY2xlYXIgdGV4dCIsCgkJZGlzYWJsZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWlucHV0ID0gdGhpcy5lbGVtZW50LAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQl0aGVtZSA9IG8udGhlbWUgfHwgJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICksCgkJCXRoZW1lY2xhc3MgID0gIiB1aS1ib2R5LSIgKyB0aGVtZSwKCQkJbWluaWNsYXNzID0gby5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlpc1NlYXJjaCA9IGlucHV0LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJZm9jdXNlZEVsLAoJCQljbGVhcmJ0biwKCQkJY2xlYXJCdG5UZXh0ID0gby5jbGVhclNlYXJjaEJ1dHRvblRleHQgfHwgby5jbGVhckJ0blRleHQsCgkJCWNsZWFyQnRuQmxhY2tsaXN0ID0gaW5wdXQuaXMoICJ0ZXh0YXJlYSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJaW5wdXROZWVkc0NsZWFyQnRuID0gISFvLmNsZWFyQnRuICYmICFjbGVhckJ0bkJsYWNrbGlzdCwKCQkJaW5wdXROZWVkc1dyYXAgPSBpbnB1dC5pcyggImlucHV0IiApICYmICFpbnB1dC5pcyggIjpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICk7CgoJCWZ1bmN0aW9uIHRvZ2dsZUNsZWFyKCkgewoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCWNsZWFyYnRuLnRvZ2dsZUNsYXNzKCAidWktaW5wdXQtY2xlYXItaGlkZGVuIiwgIWlucHV0LnZhbCgpICk7CgkJCX0sIDAgKTsKCQl9CgoJCSQoICJsYWJlbFtmb3I9JyIgKyBpbnB1dC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1pbnB1dC10ZXh0IiApOwoKCQlmb2N1c2VkRWwgPSBpbnB1dC5hZGRDbGFzcyggInVpLWlucHV0LXRleHQgdWktYm9keS0iKyB0aGVtZSApOwoKCQkvLyBYWFg6IFRlbXBvcmFyeSB3b3JrYXJvdW5kIGZvciBpc3N1ZSA3ODUgKEFwcGxlIGJ1ZyA4OTEwNTg5KS4KCQkvLyAgICAgIFR1cm4gb2ZmIGF1dG9jb3JyZWN0IGFuZCBhdXRvY29tcGxldGUgb24gbm9uLWlPUyA1IGRldmljZXMKCQkvLyAgICAgIHNpbmNlIHRoZSBwb3B1cCB0aGV5IHVzZSBjYW4ndCBiZSBkaXNtaXNzZWQgYnkgdGhlIHVzZXIuIE5vdGUKCQkvLyAgICAgIHRoYXQgd2UgdGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIHRoZSBmZWF0dXJlIGJ5IGxvb2tpbmcgZm9yCgkJLy8gICAgICB0aGUgYXV0b2NvcnJlY3QgcHJvcGVydHkgb24gdGhlIGlucHV0IGVsZW1lbnQuIFdlIGN1cnJlbnRseQoJCS8vICAgICAgaGF2ZSBubyB0ZXN0IGZvciBpT1MgNSBvciBuZXdlciBzbyB3ZSdyZSB0ZW1wb3JhcmlseSB1c2luZwoJCS8vICAgICAgdGhlIHRvdWNoT3ZlcmZsb3cgc3VwcG9ydCBmbGFnIGZvciBqUU0gMS4wLiBZZXMsIEkgZmVlbCBkaXJ0eS4gLSBqYmxhcwoJCWlmICggdHlwZW9mIGlucHV0WzBdLmF1dG9jb3JyZWN0ICE9PSAidW5kZWZpbmVkIiAmJiAhJC5zdXBwb3J0LnRvdWNoT3ZlcmZsb3cgKSB7CgkJCS8vIFNldCB0aGUgYXR0cmlidXRlIGluc3RlYWQgb2YgdGhlIHByb3BlcnR5IGp1c3QgaW4gY2FzZSB0aGVyZQoJCQkvLyBpcyBjb2RlIHRoYXQgYXR0ZW1wdHMgdG8gbWFrZSBtb2RpZmljYXRpb25zIHZpYSBIVE1MLgoJCQlpbnB1dFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCWlucHV0WzBdLnNldEF0dHJpYnV0ZSggImF1dG9jb21wbGV0ZSIsICJvZmYiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggaXNTZWFyY2ggKSB7CgkJCWZvY3VzZWRFbCA9IGlucHV0LndyYXAoICI8ZGl2IGNsYXNzPSd1aS1pbnB1dC1zZWFyY2ggdWktc2hhZG93LWluc2V0IHVpLWJ0bi1jb3JuZXItYWxsIHVpLWJ0bi1zaGFkb3cgdWktaWNvbi1zZWFyY2hmaWVsZCIgKyB0aGVtZWNsYXNzICsgbWluaWNsYXNzICsgIic+PC9kaXY+IiApLnBhcmVudCgpOwoJCX0gZWxzZSBpZiAoIGlucHV0TmVlZHNXcmFwICkgewoJCQlmb2N1c2VkRWwgPSBpbnB1dC53cmFwKCAiPGRpdiBjbGFzcz0ndWktaW5wdXQtdGV4dCB1aS1zaGFkb3ctaW5zZXQgdWktY29ybmVyLWFsbCB1aS1idG4tc2hhZG93IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKyAiJz48L2Rpdj4iICkucGFyZW50KCk7CgkJfQoKCQlpZiggaW5wdXROZWVkc0NsZWFyQnRuIHx8IGlzU2VhcmNoICkgewoJCQljbGVhcmJ0biA9ICQoICI8YSBocmVmPScjJyBjbGFzcz0ndWktaW5wdXQtY2xlYXInIHRpdGxlPSciICsgY2xlYXJCdG5UZXh0ICsgIic+IiArIGNsZWFyQnRuVGV4dCArICI8L2E+IiApCgkJCQkuYmluZCggImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlucHV0CgkJCQkJCS52YWwoICIiICkKCQkJCQkJLmZvY3VzKCkKCQkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJY2xlYXJidG4uYWRkQ2xhc3MoICJ1aS1pbnB1dC1jbGVhci1oaWRkZW4iICk7CgkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCX0pCgkJCQkuYXBwZW5kVG8oIGZvY3VzZWRFbCApCgkJCQkuYnV0dG9uTWFya3VwKHsKCQkJCQlpY29uOiAiZGVsZXRlIiwKCQkJCQlpY29ucG9zOiAibm90ZXh0IiwKCQkJCQljb3JuZXJzOiB0cnVlLAoJCQkJCXNoYWRvdzogdHJ1ZSwKCQkJCQltaW5pOiBvLm1pbmkKCQkJCX0pOwoJCQkJCgkJCWlmICggIWlzU2VhcmNoICkgewoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl9CgoJCQl0b2dnbGVDbGVhcigpOwoKCQkJaW5wdXQuYmluZCggInBhc3RlIGN1dCBrZXl1cCBpbnB1dCBmb2N1cyBjaGFuZ2UgYmx1ciIsIHRvZ2dsZUNsZWFyICk7CgkJfQoJCWVsc2UgaWYgKCAhaW5wdXROZWVkc1dyYXAgJiYgIWlzU2VhcmNoICkgewoJCQlpbnB1dC5hZGRDbGFzcyggInVpLWNvcm5lci1hbGwgdWktc2hhZG93LWluc2V0IiArIHRoZW1lY2xhc3MgKyBtaW5pY2xhc3MgKTsKCQl9CgoJCWlucHV0LmZvY3VzKGZ1bmN0aW9uKCkgewoJCQkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIGlucHV0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQkJCWlmICggby5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQkJfQkJCQoJCQkJZm9jdXNlZEVsLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5ibHVyKGZ1bmN0aW9uKCkgewoJCQkJZm9jdXNlZEVsLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCQlpZiAoIG8ucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCQkJfQkJCQkKCQkJfSk7CgoJCS8vIEF1dG9ncm93CgkJaWYgKCBpbnB1dC5pcyggInRleHRhcmVhIiApICkgewoJCQl2YXIgZXh0cmFMaW5lSGVpZ2h0ID0gMTUsCgkJCQlrZXl1cFRpbWVvdXRCdWZmZXIgPSAxMDAsCgkJCQlrZXl1cFRpbWVvdXQ7CgoJCQl0aGlzLl9rZXl1cCA9IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNjcm9sbEhlaWdodCA9IGlucHV0WyAwIF0uc2Nyb2xsSGVpZ2h0LAoJCQkJCWNsaWVudEhlaWdodCA9IGlucHV0WyAwIF0uY2xpZW50SGVpZ2h0OwoKCQkJCWlmICggY2xpZW50SGVpZ2h0IDwgc2Nyb2xsSGVpZ2h0ICkgewoJCQkJCXZhciBwYWRkaW5nVG9wID0gcGFyc2VGbG9hdCggaW5wdXQuY3NzKCAicGFkZGluZy10b3AiICkgKSwKCQkJCQkJcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoIGlucHV0LmNzcyggInBhZGRpbmctYm90dG9tIiApICksCgkJCQkJCXBhZGRpbmdIZWlnaHQgPSBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbTsKCQkJCQkKCQkJCQlpbnB1dC5oZWlnaHQoIHNjcm9sbEhlaWdodCAtIHBhZGRpbmdIZWlnaHQgKyBleHRyYUxpbmVIZWlnaHQgKTsKCQkJCX0KCQkJfTsKCgkJCWlucHV0Lm9uKCAia2V5dXAgY2hhbmdlIGlucHV0IHBhc3RlIiwgZnVuY3Rpb24oKSB7CgkJCQljbGVhclRpbWVvdXQoIGtleXVwVGltZW91dCApOwoJCQkJa2V5dXBUaW1lb3V0ID0gc2V0VGltZW91dCggc2VsZi5fa2V5dXAsIGtleXVwVGltZW91dEJ1ZmZlciApOwoJCQl9KTsKCgkJCS8vIGJpbmRpbmcgdG8gcGFnZWNoYW5nZSBoZXJlIGVuc3VyZXMgdGhhdCBmb3IgcGFnZXMgbG9hZGVkIHZpYQoJCQkvLyBhamF4IHRoZSBoZWlnaHQgaXMgcmVjYWxjdWxhdGVkIHdpdGhvdXQgdXNlciBpbnB1dAoJCQl0aGlzLl9vbiggdHJ1ZSwgJC5tb2JpbGUuZG9jdW1lbnQsIHsgInBhZ2VjaGFuZ2UiOiAiX2tleXVwIiB9KTsKCgkJCS8vIElzc3VlIDUwOTogdGhlIGJyb3dzZXIgaXMgbm90IHByb3ZpZGluZyBzY3JvbGxIZWlnaHQgcHJvcGVybHkgdW50aWwgdGhlIHN0eWxlcyBsb2FkCgkJCWlmICggJC50cmltKCBpbnB1dC52YWwoKSApICkgewoJCQkJLy8gYmluZCB0byB0aGUgd2luZG93IGxvYWQgdG8gbWFrZSBzdXJlIHRoZSBoZWlnaHQgaXMgY2FsY3VsYXRlZCBiYXNlZCBvbiBCT1RICgkJCQkvLyB0aGUgRE9NIGFuZCBDU1MKCQkJCXRoaXMuX29uKCB0cnVlLCAkLm1vYmlsZS53aW5kb3csIHsibG9hZCI6ICJfa2V5dXAifSk7CgkJCX0KCQl9CgkJaWYgKCBpbnB1dC5hdHRyKCAiZGlzYWJsZWQiICkgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCX0sCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCwKCQkJaXNTZWFyY2ggPSB0aGlzLmVsZW1lbnQuaXMoICJbdHlwZT0nc2VhcmNoJ10sIDpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9IHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApICYmICF0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YSh0eXBlPSdyYW5nZScpIiApLAoJCQlwYXJlbnROZWVkc0Rpc2FibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIHRydWUgKQkmJiAoIGlucHV0TmVlZHNXcmFwIHx8IGlzU2VhcmNoICk7CgkJCQoJCWlmICggcGFyZW50TmVlZHNEaXNhYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdHJ1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwsCgkJCWlzU2VhcmNoID0gdGhpcy5lbGVtZW50LmlzKCAiW3R5cGU9J3NlYXJjaCddLCA6anFtRGF0YSh0eXBlPSdzZWFyY2gnKSIgKSwKCQkJaW5wdXROZWVkc1dyYXAgPSB0aGlzLmVsZW1lbnQuaXMoICJpbnB1dCIgKSAmJiAhdGhpcy5lbGVtZW50LmlzKCAiOmpxbURhdGEodHlwZT0ncmFuZ2UnKSIgKSwKCQkJcGFyZW50TmVlZHNFbmFibGVkID0gdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIsIGZhbHNlICkJJiYgKCBpbnB1dE5lZWRzV3JhcCB8fCBpc1NlYXJjaCApOwoKCQlpZiAoIHBhcmVudE5lZWRzRW5hYmxlZCApIHsKCQkJJGVsID0gdGhpcy5lbGVtZW50LnBhcmVudCgpOwoJCX0gZWxzZSB7CgkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCQl9CgkJJGVsLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgZmFsc2UgKTsKCX0KfSk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS50ZXh0aW5wdXQucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0LCB0cnVlICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXIgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyUGxhY2Vob2xkZXIgPSAiRmlsdGVyIGl0ZW1zLi4uIjsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyVGhlbWUgPSAiYyI7CiQubW9iaWxlLmxpc3R2aWV3LnByb3RvdHlwZS5vcHRpb25zLmZpbHRlclJldmVhbCA9IGZhbHNlOwovLyBUT0RPIHJlbmFtZSBjYWxsYmFjay9kZXByZWNhdGUgYW5kIGRlZmF1bHQgdG8gdGhlIGl0ZW0gaXRzZWxmIGFzIHRoZSBmaXJzdCBhcmd1bWVudAp2YXIgZGVmYXVsdEZpbHRlckNhbGxiYWNrID0gZnVuY3Rpb24oIHRleHQsIHNlYXJjaFZhbHVlLCBpdGVtICkgewoJCXJldHVybiB0ZXh0LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKS5pbmRleE9mKCBzZWFyY2hWYWx1ZSApID09PSAtMTsKCX07CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGRlZmF1bHRGaWx0ZXJDYWxsYmFjazsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAidWwsIG9sIiwgImxpc3R2aWV3Y3JlYXRlIiwgZnVuY3Rpb24oKSB7Cgl2YXIgbGlzdCA9ICQoIHRoaXMgKSwKCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5maWx0ZXIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJSZXZlYWwgKSB7CgkJbGlzdC5jaGlsZHJlbigpLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCX0KCgl2YXIgd3JhcHBlciA9ICQoICI8Zm9ybT4iLCB7CgkJCSJjbGFzcyI6ICJ1aS1saXN0dmlldy1maWx0ZXIgdWktYmFyLSIgKyBsaXN0dmlldy5vcHRpb25zLmZpbHRlclRoZW1lLAoJCQkicm9sZSI6ICJzZWFyY2giCgkJfSkuc3VibWl0KCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWFyY2guYmx1cigpOwoJCX0pLAoJCW9uS2V5VXAgPSBmdW5jdGlvbiggZSApIHsKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJdmFsID0gdGhpcy52YWx1ZS50b0xvd2VyQ2FzZSgpLAoJCQkJbGlzdEl0ZW1zID0gbnVsbCwKCQkJCWxpID0gbGlzdC5jaGlsZHJlbigpLAoJCQkJbGFzdHZhbCA9ICR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiApICsgIiIsCgkJCQljaGlsZEl0ZW1zID0gZmFsc2UsCgkJCQlpdGVtdGV4dCA9ICIiLAoJCQkJaXRlbSwKCQkJCS8vIENoZWNrIGlmIGEgY3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzCgkJCQlpc0N1c3RvbUZpbHRlckNhbGxiYWNrID0gbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJDYWxsYmFjayAhPT0gZGVmYXVsdEZpbHRlckNhbGxiYWNrOwoKCQkJaWYgKCBsYXN0dmFsICYmIGxhc3R2YWwgPT09IHZhbCApIHsKCQkJCS8vIEV4ZWN1dGUgdGhlIGhhbmRsZXIgb25seSBvbmNlIHBlciB2YWx1ZSBjaGFuZ2UKCQkJCXJldHVybjsKCQkJfQoKCQkJbGlzdHZpZXcuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogdGhpcyB9ICk7CgoJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCSR0aGlzLmpxbURhdGEoICJsYXN0dmFsIiAsIHZhbCApOwoJCQlpZiAoIGlzQ3VzdG9tRmlsdGVyQ2FsbGJhY2sgfHwgdmFsLmxlbmd0aCA8IGxhc3R2YWwubGVuZ3RoIHx8IHZhbC5pbmRleE9mKCBsYXN0dmFsICkgIT09IDAgKSB7CgoJCQkJLy8gQ3VzdG9tIGZpbHRlciBjYWxsYmFjayBhcHBsaWVzIG9yIHJlbW92ZWQgY2hhcnMgb3IgcGFzdGVkIHNvbWV0aGluZyB0b3RhbGx5IGRpZmZlcmVudCwgY2hlY2sgYWxsIGl0ZW1zCgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCk7CgkJCX0gZWxzZSB7CgoJCQkJLy8gT25seSBjaGFycyBhZGRlZCwgbm90IHJlbW92ZWQsIG9ubHkgdXNlIHZpc2libGUgc3Vic2V0CgkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiOm5vdCgudWktc2NyZWVuLWhpZGRlbikiICk7CgoJCQkJaWYgKCAhbGlzdEl0ZW1zLmxlbmd0aCAmJiBsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApIHsKCQkJCQlsaXN0SXRlbXMgPSBsaXN0LmNoaWxkcmVuKCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCX0KCgkJCWlmICggdmFsICkgewoKCQkJCS8vIFRoaXMgaGFuZGxlcyBoaWRpbmcgcmVndWxhciByb3dzIHdpdGhvdXQgdGhlIHRleHQgd2Ugc2VhcmNoIGZvcgoJCQkJLy8gYW5kIGFueSBsaXN0IGRpdmlkZXJzIHdpdGhvdXQgcmVndWxhciByb3dzIHNob3duIHVuZGVyIGl0CgoJCQkJZm9yICggdmFyIGkgPSBsaXN0SXRlbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0gKSB7CgkJCQkJaXRlbSA9ICQoIGxpc3RJdGVtc1sgaSBdICk7CgkJCQkJaXRlbXRleHQgPSBpdGVtLmpxbURhdGEoICJmaWx0ZXJ0ZXh0IiApIHx8IGl0ZW0udGV4dCgpOwoKCQkJCQlpZiAoIGl0ZW0uaXMoICJsaTpqcW1EYXRhKHJvbGU9bGlzdC1kaXZpZGVyKSIgKSApIHsKCgkJCQkJCWl0ZW0udG9nZ2xlQ2xhc3MoICJ1aS1maWx0ZXItaGlkZXF1ZXVlIiAsICFjaGlsZEl0ZW1zICk7CgoJCQkJCQkvLyBOZXcgYnVja2V0IQoJCQkJCQljaGlsZEl0ZW1zID0gZmFsc2U7CgoJCQkJCX0gZWxzZSBpZiAoIGxpc3R2aWV3Lm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2soIGl0ZW10ZXh0LCB2YWwsIGl0ZW0gKSApIHsKCgkJCQkJCS8vbWFyayB0byBiZSBoaWRkZW4KCQkJCQkJaXRlbS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiICwgdHJ1ZSApOwoJCQkJCX0gZWxzZSB7CgoJCQkJCQkvLyBUaGVyZSdzIGEgc2hvd24gaXRlbSBpbiB0aGUgYnVja2V0CgkJCQkJCWNoaWxkSXRlbXMgPSB0cnVlOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTaG93IGl0ZW1zLCBub3QgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIjpub3QoLnVpLWZpbHRlci1oaWRlcXVldWUpIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIGZhbHNlICk7CgoJCQkJLy8gSGlkZSBpdGVtcywgbWFya2VkIHRvIGJlIGhpZGRlbgoJCQkJbGlzdEl0ZW1zCgkJCQkJLmZpbHRlciggIi51aS1maWx0ZXItaGlkZXF1ZXVlIiApCgkJCQkJLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIHRydWUgKQoJCQkJCS50b2dnbGVDbGFzcyggInVpLWZpbHRlci1oaWRlcXVldWUiLCBmYWxzZSApOwoKCQkJfSBlbHNlIHsKCgkJCQkvL2ZpbHRlcnZhbHVlIGlzIGVtcHR5ID0+IHNob3cgYWxsCgkJCQlsaXN0SXRlbXMudG9nZ2xlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiwgISFsaXN0dmlldy5vcHRpb25zLmZpbHRlclJldmVhbCApOwoJCQl9CgkJCWxpc3R2aWV3Ll9hZGRGaXJzdExhc3RDbGFzc2VzKCBsaSwgbGlzdHZpZXcuX2dldFZpc2libGVzKCBsaSwgZmFsc2UgKSwgZmFsc2UgKTsKCQl9LAoJCXNlYXJjaCA9ICQoICI8aW5wdXQ+IiwgewoJCQlwbGFjZWhvbGRlcjogbGlzdHZpZXcub3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlcgoJCX0pCgkJLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0eXBlIiwgInNlYXJjaCIgKQoJCS5qcW1EYXRhKCAibGFzdHZhbCIsICIiICkKCQkuYmluZCggImtleXVwIGNoYW5nZSBpbnB1dCIsIG9uS2V5VXAgKQoJCS5hcHBlbmRUbyggd3JhcHBlciApCgkJLnRleHRpbnB1dCgpOwoKCWlmICggbGlzdHZpZXcub3B0aW9ucy5pbnNldCApIHsKCQl3cmFwcGVyLmFkZENsYXNzKCAidWktbGlzdHZpZXctZmlsdGVyLWluc2V0IiApOwoJfQoKCXdyYXBwZXIuYmluZCggInN1Ym1pdCIsIGZ1bmN0aW9uKCkgewoJCXJldHVybiBmYWxzZTsKCX0pCgkuaW5zZXJ0QmVmb3JlKCBsaXN0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saXN0dmlldy5wcm90b3R5cGUub3B0aW9ucy5hdXRvZGl2aWRlcnMgPSBmYWxzZTsKJC5tb2JpbGUubGlzdHZpZXcucHJvdG90eXBlLm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IgPSBmdW5jdGlvbiggZWx0ICkgewoJLy8gbG9vayBmb3IgdGhlIHRleHQgaW4gdGhlIGdpdmVuIGVsZW1lbnQKCXZhciB0ZXh0ID0gJC50cmltKCBlbHQudGV4dCgpICkgfHwgbnVsbDsKCglpZiAoICF0ZXh0ICkgewoJCXJldHVybiBudWxsOwoJfQoKCS8vIGNyZWF0ZSB0aGUgdGV4dCBmb3IgdGhlIGRpdmlkZXIgKGZpcnN0IHVwcGVyY2FzZWQgbGV0dGVyKQoJdGV4dCA9IHRleHQuc2xpY2UoIDAsIDEgKS50b1VwcGVyQ2FzZSgpOwoKCXJldHVybiB0ZXh0Owp9OwoKJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJ1bCxvbCIsICJsaXN0dmlld2NyZWF0ZSIsIGZ1bmN0aW9uKCkgewoKCXZhciBsaXN0ID0gJCggdGhpcyApLAoJCQlsaXN0dmlldyA9IGxpc3QuZGF0YSggIm1vYmlsZS1saXN0dmlldyIgKTsKCglpZiAoICFsaXN0dmlldyB8fCAhbGlzdHZpZXcub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciByZXBsYWNlRGl2aWRlcnMgPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC5maW5kKCAibGk6anFtRGF0YShyb2xlPSdsaXN0LWRpdmlkZXInKSIgKS5yZW1vdmUoKTsKCgkJdmFyIGxpcyA9IGxpc3QuZmluZCggJ2xpJyApLAoJCQlsYXN0RGl2aWRlclRleHQgPSBudWxsLCBsaSwgZGl2aWRlclRleHQ7CgoJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpcy5sZW5ndGggOyBpKysgKSB7CgkJCWxpID0gbGlzW2ldOwoJCQlkaXZpZGVyVGV4dCA9IGxpc3R2aWV3Lm9wdGlvbnMuYXV0b2RpdmlkZXJzU2VsZWN0b3IoICQoIGxpICkgKTsKCgkJCWlmICggZGl2aWRlclRleHQgJiYgbGFzdERpdmlkZXJUZXh0ICE9PSBkaXZpZGVyVGV4dCApIHsKCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIGRpdmlkZXJUZXh0ICkgKTsKCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAnZGF0YS0nICsgJC5tb2JpbGUubnMgKyAncm9sZScsICdsaXN0LWRpdmlkZXInICk7CgkJCQlsaS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggZGl2aWRlciwgbGkgKTsKCQkJfQoKCQkJbGFzdERpdmlkZXJUZXh0ID0gZGl2aWRlclRleHQ7CgkJfQoJfTsKCgl2YXIgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggPSBmdW5jdGlvbiAoKSB7CgkJbGlzdC51bmJpbmQoICdsaXN0dmlld2FmdGVycmVmcmVzaCcsIGFmdGVyTGlzdHZpZXdSZWZyZXNoICk7CgkJcmVwbGFjZURpdmlkZXJzKCk7CgkJbGlzdHZpZXcucmVmcmVzaCgpOwoJCWxpc3QuYmluZCggJ2xpc3R2aWV3YWZ0ZXJyZWZyZXNoJywgYWZ0ZXJMaXN0dmlld1JlZnJlc2ggKTsKCX07CgoJYWZ0ZXJMaXN0dmlld1JlZnJlc2goKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkKCAiOmpxbURhdGEocm9sZT0nbm9qcycpIiwgZS50YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7CgkKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQltaW5pOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdjaGVja2JveCddLGlucHV0W3R5cGU9J3JhZGlvJ10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwgaW5wdXQuY2xvc2VzdCggImZvcm0sIGZpZWxkc2V0IiApLmpxbURhdGEoIGRhdGFBdHRyICk7CgkJCX0sCgkJCS8vIE5PVEU6IFdpbmRvd3MgUGhvbmUgY291bGQgbm90IGZpbmQgdGhlIGxhYmVsIHRocm91Z2ggYSBzZWxlY3RvcgoJCQkvLyBmaWx0ZXIgd29ya3MgdGhvdWdoLgoJCQlwYXJlbnRMYWJlbCA9ICQoIGlucHV0ICkuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDogJCggaW5wdXQgKS5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQsIDpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkuZmluZCggImxhYmVsIiApLmZpbHRlciggIltmb3I9JyIgKyBpbnB1dFswXS5pZCArICInXSIgKS5maXJzdCgpLAoJCQlpbnB1dHR5cGUgPSBpbnB1dFswXS50eXBlLAoJCQltaW5pID0gaW5oZXJpdEF0dHIoIGlucHV0LCAibWluaSIgKSB8fCBvLm1pbmksCgkJCWNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb24iLAoJCQl1bmNoZWNrZWRTdGF0ZSA9IGlucHV0dHlwZSArICItb2ZmIiwKCQkJaWNvbnBvcyA9IGluaGVyaXRBdHRyKCBpbnB1dCwgImljb25wb3MiICksCgkJCWNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgY2hlY2tlZFN0YXRlLAoJCQl1bmNoZWNrZWRDbGFzcyA9ICJ1aS0iICsgdW5jaGVja2VkU3RhdGU7CgoJCWlmICggaW5wdXR0eXBlICE9PSAiY2hlY2tib3giICYmIGlucHV0dHlwZSAhPT0gInJhZGlvIiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gRXhwb3NlIGZvciBvdGhlciBtZXRob2RzCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJbGFiZWw6IGxhYmVsLAoJCQlpbnB1dHR5cGU6IGlucHV0dHlwZSwKCQkJY2hlY2tlZENsYXNzOiBjaGVja2VkQ2xhc3MsCgkJCXVuY2hlY2tlZENsYXNzOiB1bmNoZWNrZWRDbGFzcywKCQkJY2hlY2tlZGljb246IGNoZWNrZWRTdGF0ZSwKCQkJdW5jaGVja2VkaWNvbjogdW5jaGVja2VkU3RhdGUKCQl9KTsKCgkJLy8gSWYgdGhlcmUncyBubyBzZWxlY3RlZCB0aGVtZSBjaGVjayB0aGUgZGF0YSBhdHRyCgkJaWYgKCAhby50aGVtZSApIHsKCQkJby50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLmVsZW1lbnQsICJjIiApOwoJCX0KCgkJbGFiZWwuYnV0dG9uTWFya3VwKHsKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWljb246IHVuY2hlY2tlZFN0YXRlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQltaW5pOiBtaW5pLAoJCQlpY29ucG9zOiBpY29ucG9zCgkJfSk7CgoJCS8vIFdyYXAgdGhlIGlucHV0ICsgbGFiZWwgaW4gYSBkaXYKCQl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoJCXdyYXBwZXIuY2xhc3NOYW1lID0gJ3VpLScgKyBpbnB1dHR5cGU7CgoJCWlucHV0LmFkZCggbGFiZWwgKS53cmFwQWxsKCB3cmFwcGVyICk7CgoJCWxhYmVsLmJpbmQoewoJCQl2bW91c2VvdmVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlpZiAoICQoIHRoaXMgKS5wYXJlbnQoKS5pcyggIi51aS1kaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQkJCX0KCQkJfSwKCgkJCXZjbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlzZWxmLl9jYWNoZVZhbHMoKTsKCgkJCQlpbnB1dC5wcm9wKCAiY2hlY2tlZCIsIGlucHV0dHlwZSA9PT0gInJhZGlvIiAmJiB0cnVlIHx8ICFpbnB1dC5wcm9wKCAiY2hlY2tlZCIgKSApOwoKCQkJCS8vIHRyaWdnZXIgY2xpY2sgaGFuZGxlcidzIGJvdW5kIGRpcmVjdGx5IHRvIHRoZSBpbnB1dCBhcyBhIHN1YnN0aXR1dGUgZm9yCgkJCQkvLyBob3cgbGFiZWwgY2xpY2tzIGJlaGF2ZSBub3JtYWxseSBpbiB0aGUgYnJvd3NlcnMKCQkJCS8vIFRPRE86IGl0IHdvdWxkIGJlIG5pY2UgdG8gbGV0IHRoZSBicm93c2VyJ3MgaGFuZGxlIHRoZSBjbGlja3MgYW5kIHBhc3MgdGhlbQoJCQkJLy8gICAgICAgdGhyb3VnaCB0byB0aGUgYXNzb2NpYXRlIGlucHV0LiB3ZSBjYW4gc3dhbGxvdyB0aGF0IGNsaWNrIGF0IHRoZSBwYXJlbnQKCQkJCS8vICAgICAgIHdyYXBwZXIgZWxlbWVudCBsZXZlbAoJCQkJaW5wdXQudHJpZ2dlckhhbmRsZXIoICdjbGljaycgKTsKCgkJCQkvLyBJbnB1dCBzZXQgZm9yIGNvbW1vbiByYWRpbyBidXR0b25zIHdpbGwgY29udGFpbiBhbGwgdGhlIHJhZGlvCgkJCQkvLyBidXR0b25zLCBidXQgd2lsbCBub3QgZm9yIGNoZWNrYm94ZXMuIGNsZWFyaW5nIHRoZSBjaGVja2VkIHN0YXR1cwoJCQkJLy8gb2Ygb3RoZXIgcmFkaW9zIGVuc3VyZXMgdGhlIGFjdGl2ZSBidXR0b24gc3RhdGUgaXMgYXBwbGllZCBwcm9wZXJseQoJCQkJc2VsZi5fZ2V0SW5wdXRTZXQoKS5ub3QoIGlucHV0ICkucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoKCQkJCXNlbGYuX3VwZGF0ZUFsbCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSk7CgoJCWlucHV0CgkJCS5iaW5kKHsKCQkJCXZtb3VzZWRvd246IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX2NhY2hlVmFscygpOwoJCQkJfSwKCgkJCQl2Y2xpY2s6IGZ1bmN0aW9uKCkgewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkJLy8gQWRkcyBjaGVja2VkIGF0dHJpYnV0ZSB0byBjaGVja2VkIGlucHV0IHdoZW4ga2V5Ym9hcmQgaXMgdXNlZAoJCQkJCWlmICggJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApIHsKCgkJCQkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgdHJ1ZSk7CgkJCQkJCXNlbGYuX2dldElucHV0U2V0KCkubm90KCAkdGhpcyApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQkJCQl9IGVsc2UgewoKCQkJCQkJJHRoaXMucHJvcCggImNoZWNrZWQiLCBmYWxzZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5fdXBkYXRlQWxsKCk7CgkJCQl9LAoKCQkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlsYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfQoJCQl9KTsKCgkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9jYWNoZVZhbHM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaChmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmpxbURhdGEoICJjYWNoZVZhbCIsIHRoaXMuY2hlY2tlZCApOwoJCX0pOwoJfSwKCgkvL3JldHVybnMgZWl0aGVyIGEgc2V0IG9mIHJhZGlvcyB3aXRoIHRoZSBzYW1lIG5hbWUgYXR0cmlidXRlLCBvciBhIHNpbmdsZSBjaGVja2JveAoJX2dldElucHV0U2V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQlyZXR1cm4gdGhpcy5lbGVtZW50OwoJCX0KCgkJcmV0dXJuIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiZm9ybSwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkuZmluZCggImlucHV0W25hbWU9JyIgKyB0aGlzLmVsZW1lbnRbMF0ubmFtZSArICInXVt0eXBlPSciICsgdGhpcy5pbnB1dHR5cGUgKyAiJ10iICk7Cgl9LAoKCV91cGRhdGVBbGw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQl2YXIgJHRoaXMgPSAkKCB0aGlzICk7CgoJCQlpZiAoIHRoaXMuY2hlY2tlZCB8fCBzZWxmLmlucHV0dHlwZSA9PT0gImNoZWNrYm94IiApIHsKCQkJCSR0aGlzLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9KQoJCS5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGlucHV0ID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCWFjdGl2ZSA9ICIgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQljaGVja2VkQ2xhc3MgPSB0aGlzLmNoZWNrZWRDbGFzcyArICggdGhpcy5lbGVtZW50LnBhcmVudHMoICIudWktY29udHJvbGdyb3VwLWhvcml6b250YWwiICkubGVuZ3RoID8gYWN0aXZlIDogIiIgKSwKCQkJbGFiZWwgPSB0aGlzLmxhYmVsOwoKCQlpZiAoIGlucHV0LmNoZWNrZWQgKSB7CgkJCWxhYmVsLnJlbW92ZUNsYXNzKCB0aGlzLnVuY2hlY2tlZENsYXNzICsgYWN0aXZlICkuYWRkQ2xhc3MoIGNoZWNrZWRDbGFzcyApLmJ1dHRvbk1hcmt1cCggeyBpY29uOiB0aGlzLmNoZWNrZWRpY29uIH0gKTsKCQl9IGVsc2UgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggY2hlY2tlZENsYXNzICkuYWRkQ2xhc3MoIHRoaXMudW5jaGVja2VkQ2xhc3MgKS5idXR0b25NYXJrdXAoIHsgaWNvbjogdGhpcy51bmNoZWNrZWRpY29uIH0gKTsKCQl9CgoJCWlmICggaW5wdXQuZGlzYWJsZWQgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbigpIHsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdHJ1ZSApLnBhcmVudCgpLmFkZENsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LnByb3AoICJkaXNhYmxlZCIsIGZhbHNlICkucGFyZW50KCkucmVtb3ZlQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmZvcm1SZXNldCApICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkkLm1vYmlsZS5jaGVja2JveHJhZGlvLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgJC5tb2JpbGUud2lkZ2V0LCB7CglvcHRpb25zOiB7CgkJdGhlbWU6IG51bGwsCgkJaWNvbjogbnVsbCwKCQlpY29ucG9zOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IHRydWUsCgkJaW5saW5lOiBudWxsLAoJCW1pbmk6IG51bGwsCgkJaW5pdFNlbGVjdG9yOiAiYnV0dG9uLCBbdHlwZT0nYnV0dG9uJ10sIFt0eXBlPSdzdWJtaXQnXSwgW3R5cGU9J3Jlc2V0J10iCgl9LAoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJJGJ1dHRvbiwKCQkJLy8gY3JlYXRlIGEgY29weSBvZiB0aGlzLm9wdGlvbnMgd2UgY2FuIHBhc3MgdG8gYnV0dG9uTWFya3VwCgkJCW8gPSAoIGZ1bmN0aW9uKCB0ZG8gKSB7CgkJCQl2YXIga2V5LCByZXQgPSB7fTsKCgkJCQlmb3IgKCBrZXkgaW4gdGRvICkgewoJCQkJCWlmICggdGRvWyBrZXkgXSAhPT0gbnVsbCAmJiBrZXkgIT09ICJpbml0U2VsZWN0b3IiICkgewoJCQkJCQlyZXRbIGtleSBdID0gdGRvWyBrZXkgXTsKCQkJCQl9CgkJCQl9CgoJCQkJcmV0dXJuIHJldDsKCQkJfSApKCB0aGlzLm9wdGlvbnMgKSwKCQkJY2xhc3NlcyA9ICIiLAoJCQkkYnV0dG9uUGxhY2Vob2xkZXI7CgoJCS8vIGlmIHRoaXMgaXMgYSBsaW5rLCBjaGVjayBpZiBpdCdzIGJlZW4gZW5oYW5jZWQgYW5kLCBpZiBub3QsIHVzZSB0aGUgcmlnaHQgZnVuY3Rpb24KCQlpZiAoICRlbFsgMCBdLnRhZ05hbWUgPT09ICJBIiApIHsKCQkJaWYgKCAhJGVsLmhhc0NsYXNzKCAidWktYnRuIiApICkgewoJCQkJJGVsLmJ1dHRvbk1hcmt1cCgpOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCS8vIGdldCB0aGUgaW5oZXJpdGVkIHRoZW1lCgkJLy8gVE9ETyBjZW50cmFsaXplIGZvciBhbGwgd2lkZ2V0cwoJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJdGhpcy5vcHRpb25zLnRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIHRoaXMuZWxlbWVudCwgImMiICk7CgkJfQoKCQkvLyBUT0RPOiBQb3N0IDEuMS0tb25jZSB3ZSBoYXZlIHRpbWUgdG8gdGVzdCB0aG9yb3VnaGx5LS1hbnkgY2xhc3NlcyBtYW51YWxseSBhcHBsaWVkIHRvIHRoZSBvcmlnaW5hbCBlbGVtZW50IHNob3VsZCBiZSBjYXJyaWVkIG92ZXIgdG8gdGhlIGVuaGFuY2VkIGVsZW1lbnQsIHdpdGggYW4gYC1lbmhhbmNlZGAgc3VmZml4LiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTc3CgkJLyogaWYgKCAkZWxbMF0uY2xhc3NOYW1lLmxlbmd0aCApIHsKCQkJY2xhc3NlcyA9ICRlbFswXS5jbGFzc05hbWU7CgkJfSAqLwoJCWlmICggISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLWxlZnQiICkgKSB7CgkJCWNsYXNzZXMgPSAidWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+JGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gInVpLWJ0bi1yaWdodCI7CgkJfQoKCQlpZiAoICAkZWwuYXR0ciggInR5cGUiICkgPT09ICJzdWJtaXQiIHx8ICRlbC5hdHRyKCAidHlwZSIgKSA9PT0gInJlc2V0IiApIHsKCQkJaWYgKCBjbGFzc2VzICkgewoJCQkJY2xhc3NlcyArPSAiIHVpLXN1Ym1pdCI7CgkJCX0gZWxzZSB7CgkJCQljbGFzc2VzID0gInVpLXN1Ym1pdCI7CgkJCX0KCQl9CgkJJCggImxhYmVsW2Zvcj0nIiArICRlbC5hdHRyKCAiaWQiICkgKyAiJ10iICkuYWRkQ2xhc3MoICJ1aS1zdWJtaXQiICk7CgoJCS8vIEFkZCBBUklBIHJvbGUKCQl0aGlzLmJ1dHRvbiA9ICQoICI8ZGl2PjwvZGl2PiIgKQoJCQlbICRlbC5odG1sKCkgPyAiaHRtbCIgOiAidGV4dCIgXSggJGVsLmh0bWwoKSB8fCAkZWwudmFsKCkgKQoJCQkuaW5zZXJ0QmVmb3JlKCAkZWwgKQoJCQkuYnV0dG9uTWFya3VwKCBvICkKCQkJLmFkZENsYXNzKCBjbGFzc2VzICkKCQkJLmFwcGVuZCggJGVsLmFkZENsYXNzKCAidWktYnRuLWhpZGRlbiIgKSApOwoKICAgICAgICAkYnV0dG9uID0gdGhpcy5idXR0b247CgoJCSRlbC5iaW5kKHsKCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJJGJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9LAoKCQkJYmx1cjogZnVuY3Rpb24oKSB7CgkJCQkkYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0KCQl9KTsKCgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCXZhciBvcCA9IHt9OwoKCQlvcFsga2V5IF0gPSB2YWx1ZTsKCQlpZiAoIGtleSAhPT0gImluaXRTZWxlY3RvciIgKSB7CgkJCXRoaXMuYnV0dG9uLmJ1dHRvbk1hcmt1cCggb3AgKTsKCQkJLy8gUmVjb3JkIHRoZSBvcHRpb24gY2hhbmdlIGluIHRoZSBvcHRpb25zIGFuZCBpbiB0aGUgRE9NIGRhdGEtKiBhdHRyaWJ1dGVzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgKCBrZXkucmVwbGFjZSggLyhbQS1aXSkvLCAiLSQxIiApLnRvTG93ZXJDYXNlKCkgKSwgdmFsdWUgKTsKCQl9CgkJdGhpcy5fc3VwZXIoICJfc2V0T3B0aW9uIiwga2V5LCB2YWx1ZSApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5idXR0b24uYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCWlmICggJGVsLnByb3AoImRpc2FibGVkIikgKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0gZWxzZSB7CgkJCXRoaXMuZW5hYmxlKCk7CgkJfQoKCQkvLyBHcmFiIHRoZSBidXR0b24ncyB0ZXh0IGVsZW1lbnQgZnJvbSBpdHMgaW1wbGVtZW50YXRpb24taW5kZXBlbmRlbnQgZGF0YSBpdGVtCgkJJCggdGhpcy5idXR0b24uZGF0YSggJ2J1dHRvbkVsZW1lbnRzJyApLnRleHQgKVsgJGVsLmh0bWwoKSA/ICJodG1sIiA6ICJ0ZXh0IiBdKCAkZWwuaHRtbCgpIHx8ICRlbC52YWwoKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLmJ1dHRvbi5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWRpc2FibGVkOiBmYWxzZSwKCQlpbml0U2VsZWN0b3I6ICJpbnB1dFt0eXBlPSdyYW5nZSddLCA6anFtRGF0YSh0eXBlPSdyYW5nZScpLCA6anFtRGF0YShyb2xlPSdzbGlkZXInKSIsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXBhcmVudFRoZW1lID0gJC5tb2JpbGUuZ2V0SW5oZXJpdGVkVGhlbWUoIGNvbnRyb2wsICJjIiApLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQljVHlwZSA9IGNvbnRyb2xbIDAgXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQlpc1NlbGVjdCA9IHRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBjVHlwZSA9PT0gInNlbGVjdCIsCgkJCWlzUmFuZ2VzbGlkZXIgPSBjb250cm9sLnBhcmVudCgpLmlzKCAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIgKSwKCQkJc2VsZWN0Q2xhc3MgPSAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQlsYWJlbCA9ICRsYWJlbC5hdHRyKCAiaWQiLCBsYWJlbElEICksCgkJCW1pbiA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwLAoJCQltYXggPSAgIXRoaXMuaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWRvbUhhbmRsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJhIiApLAoJCQloYW5kbGUgPSAkKCBkb21IYW5kbGUgKSwKCQkJZG9tU2xpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJc2xpZGVyID0gJCggZG9tU2xpZGVyICksCgkJCXZhbHVlYmcgPSB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICsgIiB1aS1idG4tY29ybmVyLWFsbCI7CgkJCQlyZXR1cm4gJCggYmcgKS5wcmVwZW5kVG8oIHNsaWRlciApOwoJCQl9KSgpIDogZmFsc2UsCgkJCW9wdGlvbnMsCgkJCXdyYXBwZXI7CgkJCQoJCWRvbUhhbmRsZS5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJZG9tU2xpZGVyLnNldEF0dHJpYnV0ZSggInJvbGUiLCAiYXBwbGljYXRpb24iICk7CgkJZG9tU2xpZGVyLmNsYXNzTmFtZSA9IFt0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciAiIDogInVpLXNsaWRlci10cmFjayAiLHNlbGVjdENsYXNzLCIgdWktYnRuLWRvd24tIix0cmFja1RoZW1lLCIgdWktYnRuLWNvcm5lci1hbGwiLCBtaW5pQ2xhc3NdLmpvaW4oICIiICk7CgkJZG9tSGFuZGxlLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItaGFuZGxlIjsKCQlkb21TbGlkZXIuYXBwZW5kQ2hpbGQoIGRvbUhhbmRsZSApOwoKCQloYW5kbGUuYnV0dG9uTWFya3VwKHsgY29ybmVyczogdHJ1ZSwgdGhlbWU6IHRoZW1lLCBzaGFkb3c6IHRydWUgfSkKCQkJCS5hdHRyKHsKCQkJCQkicm9sZSI6ICJzbGlkZXIiLAoJCQkJCSJhcmlhLXZhbHVlbWluIjogbWluLAoJCQkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkJCSJhcmlhLXZhbHVlbm93IjogdGhpcy5fdmFsdWUoKSwKCQkJCQkiYXJpYS12YWx1ZXRleHQiOiB0aGlzLl92YWx1ZSgpLAoJCQkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCQkJImFyaWEtbGFiZWxsZWRieSI6IGxhYmVsSUQKCQkJCX0pOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlzbGlkZXI6IHNsaWRlciwKCQkJaGFuZGxlOiBoYW5kbGUsCgkJCXR5cGU6IGNUeXBlLAoJCQlzdGVwOiBzdGVwLAoJCQltYXg6IG1heCwKCQkJbWluOiBtaW4sCgkJCXZhbHVlYmc6IHZhbHVlYmcsCgkJCWlzUmFuZ2VzbGlkZXI6IGlzUmFuZ2VzbGlkZXIsCgkJCWRyYWdnaW5nOiBmYWxzZSwKCQkJYmVmb3JlU3RhcnQ6IG51bGwsCgkJCXVzZXJNb2RpZmllZDogZmFsc2UsCgkJCW1vdXNlTW92ZWQ6IGZhbHNlCgkJfSk7CgoJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCXdyYXBwZXIuY2xhc3NOYW1lID0gInVpLXNsaWRlci1pbm5lcm9mZnNldCI7CgoJCQlmb3IgKCB2YXIgaiA9IDAsIGxlbmd0aCA9IGRvbVNsaWRlci5jaGlsZE5vZGVzLmxlbmd0aDsgaiA8IGxlbmd0aDsgaisrICkgewoJCQkJd3JhcHBlci5hcHBlbmRDaGlsZCggZG9tU2xpZGVyLmNoaWxkTm9kZXNbal0gKTsKCQkJfQoKCQkJZG9tU2xpZGVyLmFwcGVuZENoaWxkKCB3cmFwcGVyICk7CgoJCQkvLyBzbGlkZXIud3JhcElubmVyKCAiPGRpdiBjbGFzcz0ndWktc2xpZGVyLWlubmVyb2Zmc2V0Jz48L2Rpdj4iICk7CgoJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSB3aXRoIGEgc21vb3RoIHRyYW5zaXRpb24KCQkJaGFuZGxlLmFkZENsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCgkJCW9wdGlvbnMgPSBjb250cm9sLmZpbmQoICJvcHRpb24iICk7CgoJCQlmb3IgKCB2YXIgaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQl2YXIgc2lkZSA9ICFpID8gImIiIDogImEiLAoJCQkJCXNsaWRlclRoZW1lID0gIWkgPyAiIHVpLWJ0bi1kb3duLSIgKyB0cmFja1RoZW1lIDogKCAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLAoJCQkJCXNsaWRlckxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKSwKCQkJCQlzbGlkZXJJbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKTsKCgkJCQlzbGlkZXJJbWcuY2xhc3NOYW1lID0gWyJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIHNsaWRlclRoZW1lLCAiIHVpLWJ0bi1jb3JuZXItYWxsIl0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJbGFiZWwuYWRkQ2xhc3MoICJ1aS1zbGlkZXIiICk7CgkJCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItaW5wdXQiICk7CgoJCXRoaXMuX29uKCBjb250cm9sLCB7CgkJCSJjaGFuZ2UiOiAiX2NvbnRyb2xDaGFuZ2UiLAoJCQkia2V5dXAiOiAiX2NvbnRyb2xLZXl1cCIsCgkJCSJibHVyIjogIl9jb250cm9sQmx1ciIsCgkJCSJ2bW91c2V1cCI6ICJfY29udHJvbFZNb3VzZVVwIgoJCX0pOwoKCQlzbGlkZXIuYmluZCggInZtb3VzZWRvd24iLCAkLnByb3h5KCB0aGlzLl9zbGlkZXJWTW91c2VEb3duLCB0aGlzICkgKQoJCQkuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCS8vIFdlIGhhdmUgdG8gaW5zdGFudGlhdGUgYSBuZXcgZnVuY3Rpb24gb2JqZWN0IGZvciB0aGUgdW5iaW5kIHRvIHdvcmsgcHJvcGVybHkKCQkvLyBzaW5jZSB0aGUgbWV0aG9kIGl0c2VsZiBpcyBkZWZpbmVkIGluIHRoZSBwcm90b3R5cGUgKGNhdXNpbmcgaXQgdG8gdW5iaW5kIGV2ZXJ5dGhpbmcpCgkJdGhpcy5fb24oIGRvY3VtZW50LCB7ICJ2bW91c2Vtb3ZlIjogIl9wcmV2ZW50RG9jdW1lbnREcmFnIiB9KTsKCQl0aGlzLl9vbiggc2xpZGVyLmFkZCggZG9jdW1lbnQgKSwgeyAidm1vdXNldXAiOiAiX3NsaWRlclZNb3VzZVVwIiB9KTsKCgkJc2xpZGVyLmluc2VydEFmdGVyKCBjb250cm9sICk7CgoJCS8vIHdyYXAgaW4gYSBkaXYgZm9yIHN0eWxpbmcgcHVycG9zZXMKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmICFpc1Jhbmdlc2xpZGVyICkgewoJCQl3cmFwcGVyID0gdGhpcy5vcHRpb25zLm1pbmkgPyAiPGRpdiBjbGFzcz0ndWktc2xpZGVyIHVpLW1pbmknPiIgOiAiPGRpdiBjbGFzcz0ndWktc2xpZGVyJz4iOwoJCQkKCQkJY29udHJvbC5hZGQoIHNsaWRlciApLndyYXBBbGwoIHdyYXBwZXIgKTsKCQl9CgoJCS8vIE9ubHkgYWRkIGZvY3VzIGNsYXNzIHRvIHRvZ2dsZSBzd2l0Y2gsIHNsaWRlcnMgZ2V0IGl0IGF1dG9tYXRpY2FsbHkgZnJvbSB1aS1idG4KCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuaGFuZGxlLmJpbmQoewoJCQkJZm9jdXM6IGZ1bmN0aW9uKCkgewoJCQkJCXNsaWRlci5hZGRDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQkJfSwKCgkJCQlibHVyOiBmdW5jdGlvbigpIHsKCQkJCQlzbGlkZXIucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQkvLyBiaW5kIHRoZSBoYW5kbGUgZXZlbnQgY2FsbGJhY2tzIGFuZCBzZXQgdGhlIGNvbnRleHQgdG8gdGhlIHdpZGdldCBpbnN0YW5jZQoJCXRoaXMuX29uKCB0aGlzLmhhbmRsZSwgewoJCQkidm1vdXNlZG93biI6ICJfaGFuZGxlVk1vdXNlRG93biIsCgkJCSJrZXlkb3duIjogIl9oYW5kbGVLZXlkb3duIiwKCQkJImtleXVwIjogIl9oYW5kbGVLZXl1cCIKCQl9KTsKCgkJdGhpcy5oYW5kbGUuYmluZCggInZjbGljayIsIGZhbHNlICk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLnJlZnJlc2goIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB0cnVlICk7Cgl9LAoKCV9jb250cm9sQ2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJLy8gaWYgdGhlIHVzZXIgZHJhZ2dlZCB0aGUgaGFuZGxlLCB0aGUgImNoYW5nZSIgZXZlbnQgd2FzIHRyaWdnZXJlZCBmcm9tIGluc2lkZSByZWZyZXNoKCk7IGRvbid0IGNhbGwgcmVmcmVzaCgpIGFnYWluCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiY29udHJvbGNoYW5nZSIsIGV2ZW50ICkgPT09IGZhbHNlICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggIXRoaXMubW91c2VNb3ZlZCApIHsKCQkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7CgkJfQoJfSwKCglfY29udHJvbEtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7IC8vIG5lY2Vzc2FyeT8KCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCksIHRydWUsIHRydWUgKTsKCX0sCgoJX2NvbnRyb2xCbHVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5fY2hlY2tlZFJlZnJlc2goKTsKCX0sCgoJLy8gTk9URSBmb3JjZSBmb2N1cyBvbiBoYW5kbGUKCV9oYW5kbGVWTW91c2VEb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdGhpcy5oYW5kbGUuZm9jdXMoKTsKCX0sCgoJX2hhbmRsZUtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQl2YXIgaW5kZXggPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBJbiBhbGwgY2FzZXMgcHJldmVudCB0aGUgZGVmYXVsdCBhbmQgbWFyayB0aGUgaGFuZGxlIGFzIGFjdGl2ZQoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuRU5EOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgoJCQkJaWYgKCAhdGhpcy5fa2V5U2xpZGluZyApIHsKCQkJCQl0aGlzLl9rZXlTbGlkaW5nID0gdHJ1ZTsKCQkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJCX0KCgkJCQlicmVhazsKCQl9CgoJCS8vIG1vdmUgdGhlIHNsaWRlciBhY2NvcmRpbmcgdG8gdGhlIGtleXByZXNzCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWluICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkVORDoKCQkJCXRoaXMucmVmcmVzaCggdGhpcy5tYXggKTsKCQkJCWJyZWFrOwoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlVQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUklHSFQ6CgkJCQl0aGlzLnJlZnJlc2goIGluZGV4ICsgdGhpcy5zdGVwICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfRE9XTjoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCAtIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJfQoJfSwgLy8gcmVtb3ZlIGFjdGl2ZSBtYXJrCgoJX2hhbmRsZUtleXVwOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9rZXlTbGlkaW5nICkgewoJCQl0aGlzLl9rZXlTbGlkaW5nID0gZmFsc2U7CgkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCApICkgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICggdGhpcy5fdHJpZ2dlciggImJlZm9yZXN0YXJ0IiwgZXZlbnQgKSA9PT0gZmFsc2UgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJdGhpcy5kcmFnZ2luZyA9IHRydWU7CgkJdGhpcy51c2VyTW9kaWZpZWQgPSBmYWxzZTsKCQl0aGlzLm1vdXNlTW92ZWQgPSBmYWxzZTsKCgkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0ID0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJfQoKCQkKCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgkJdGhpcy5fdHJpZ2dlciggInN0YXJ0IiApOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX3NsaWRlclZNb3VzZVVwOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZHJhZ2dpbmcgKSB7CgkJCXRoaXMuZHJhZ2dpbmcgPSBmYWxzZTsKCgkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCS8vIG1ha2UgdGhlIGhhbmRsZSBtb3ZlIHdpdGggYSBzbW9vdGggdHJhbnNpdGlvbgoJCQkJdGhpcy5oYW5kbGUuYWRkQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoKCQkJCWlmICggdGhpcy5tb3VzZU1vdmVkICkgewoJCQkJCS8vIHRoaXMgaXMgYSBkcmFnLCBjaGFuZ2UgdGhlIHZhbHVlIG9ubHkgaWYgdXNlciBkcmFnZ2VkIGVub3VnaAoJCQkJCWlmICggdGhpcy51c2VyTW9kaWZpZWQgKSB7CgkJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ICk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzIGlzIGp1c3QgYSBjbGljaywgY2hhbmdlIHRoZSB2YWx1ZQoJCQkJCXRoaXMucmVmcmVzaCggdGhpcy5iZWZvcmVTdGFydCA9PT0gMCA/IDEgOiAwICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoJCQl0aGlzLl90cmlnZ2VyKCAic3RvcCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0sCgoJX3ByZXZlbnREb2N1bWVudERyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy8gTk9URTogd2UgZG9uJ3QgZG8gdGhpcyBpbiByZWZyZXNoIGJlY2F1c2Ugd2Ugc3RpbGwgd2FudCB0bwoJCQkvLyAgICAgICBzdXBwb3J0IHByb2dyYW1tYXRpYyBhbHRlcmF0aW9uIG9mIGRpc2FibGVkIGlucHV0cwoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJkcmFnIiwgZXZlbnQgKSA9PT0gZmFsc2UpIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCQlpZiAoIHRoaXMuZHJhZ2dpbmcgJiYgIXRoaXMub3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJCQoJCQkJLy8gdGhpcy5tb3VzZU1vdmVkIG11c3QgYmUgdXBkYXRlZCBiZWZvcmUgcmVmcmVzaCgpIGJlY2F1c2UgaXQgd2lsbCBiZSB1c2VkIGluIHRoZSBjb250cm9sICJjaGFuZ2UiIGV2ZW50CgkJCQl0aGlzLm1vdXNlTW92ZWQgPSB0cnVlOwoKCQkJCWlmICggdGhpcy5pc1RvZ2dsZVN3aXRjaCApIHsKCQkJCQkvLyBtYWtlIHRoZSBoYW5kbGUgbW92ZSBpbiBzeW5jIHdpdGggdGhlIG1vdXNlCgkJCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zbGlkZXItaGFuZGxlLXNuYXBwaW5nIiApOwoJCQkJfQoJCQkJCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCggdW5kZWZpbmVkLCBmYWxzZSwgdHJ1ZSApOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbiggdmFsLCBpc2Zyb21Db250cm9sLCBwcmV2ZW50SW5wdXRVcGRhdGUgKSB7CgkJLy8gTk9URTogd2UgZG9uJ3QgcmV0dXJuIGhlcmUgYmVjYXVzZSB3ZSB3YW50IHRvIHN1cHBvcnQgcHJvZ3JhbW1hdGljCgkJLy8gICAgICAgYWx0ZXJhdGlvbiBvZiB0aGUgaW5wdXQgdmFsdWUsIHdoaWNoIHNob3VsZCBzdGlsbCB1cGRhdGUgdGhlIHNsaWRlcgoJCQoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5lbGVtZW50LCAiYyIgKSwKCQkJdGhlbWUgPSB0aGlzLm9wdGlvbnMudGhlbWUgfHwgcGFyZW50VGhlbWUsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJbGVmdCwgd2lkdGgsIGRhdGEsIHRvbDsKCgkJc2VsZi5zbGlkZXJbMF0uY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItc3dpdGNoIiA6ICJ1aS1zbGlkZXItdHJhY2siLCIgdWktYnRuLWRvd24tIiArIHRyYWNrVGhlbWUsJyB1aS1idG4tY29ybmVyLWFsbCcsICggdGhpcy5vcHRpb25zLm1pbmkgKSA/ICIgdWktbWluaSI6IiJdLmpvaW4oICIiICk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5lbGVtZW50LmF0dHIoICJkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5kaXNhYmxlKCk7CgkJfQoKCQkvLyBzZXQgdGhlIHN0b3JlZCB2YWx1ZSBmb3IgY29tcGFyaXNvbiBsYXRlcgoJCXRoaXMudmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggdGhpcy5vcHRpb25zLmhpZ2hsaWdodCAmJiAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiB0aGlzLnNsaWRlci5maW5kKCAiLnVpLXNsaWRlci1iZyIgKS5sZW5ndGggPT09IDAgKSB7CgkJCXRoaXMudmFsdWViZyA9IChmdW5jdGlvbigpIHsKCQkJCXZhciBiZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CgkJCQliZy5jbGFzc05hbWUgPSAidWktc2xpZGVyLWJnICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyArICIgdWktYnRuLWNvcm5lci1hbGwiOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5idXR0b25NYXJrdXAoeyBjb3JuZXJzOiB0cnVlLCB0aGVtZTogdGhlbWUsIHNoYWRvdzogdHJ1ZSB9KTsKCgkJdmFyIHB4U3RlcCwgcGVyY2VudCwKCQkJY29udHJvbCA9IHRoaXMuZWxlbWVudCwKCQkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoLAoJCQlvcHRpb25FbGVtZW50cyA9IGlzSW5wdXQgPyBbXSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKSwKCQkJbWluID0gIGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDEsCgkJCXN0ZXAgPSAoIGlzSW5wdXQgJiYgcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApID4gMCApID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAic3RlcCIgKSApIDogMTsKCQkJCgkJaWYgKCB0eXBlb2YgdmFsID09PSAib2JqZWN0IiApIHsKCQkJZGF0YSA9IHZhbDsKCQkJLy8gYSBzbGlnaHQgdG9sZXJhbmNlIGhlbHBlZCBnZXQgdG8gdGhlIGVuZHMgb2YgdGhlIHNsaWRlcgoJCQl0b2wgPSA4OwoKCQkJbGVmdCA9IHRoaXMuc2xpZGVyLm9mZnNldCgpLmxlZnQ7CgkJCXdpZHRoID0gdGhpcy5zbGlkZXIud2lkdGgoKTsKCQkJcHhTdGVwID0gd2lkdGgvKChtYXgtbWluKS9zdGVwKTsKCQkJaWYgKCAhdGhpcy5kcmFnZ2luZyB8fAoJCQkJCWRhdGEucGFnZVggPCBsZWZ0IC0gdG9sIHx8CgkJCQkJZGF0YS5wYWdlWCA+IGxlZnQgKyB3aWR0aCArIHRvbCApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIHB4U3RlcCA+IDEgKSB7CgkJCQlwZXJjZW50ID0gKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwOwoJCQl9IGVsc2UgewoJCQkJcGVyY2VudCA9IE1hdGgucm91bmQoICggKCBkYXRhLnBhZ2VYIC0gbGVmdCApIC8gd2lkdGggKSAqIDEwMCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJaWYgKCB2YWwgPT0gbnVsbCApIHsKCQkJCXZhbCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLnZhbCgpIHx8IDAgKSA6IGNvbnRyb2xbMF0uc2VsZWN0ZWRJbmRleDsKCQkJfQoJCQlwZXJjZW50ID0gKCBwYXJzZUZsb2F0KCB2YWwgKSAtIG1pbiApIC8gKCBtYXggLSBtaW4gKSAqIDEwMDsKCQl9CgoJCWlmICggaXNOYU4oIHBlcmNlbnQgKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIG5ld3ZhbCA9ICggcGVyY2VudCAvIDEwMCApICogKCBtYXggLSBtaW4gKSArIG1pbjsKCgkJLy9mcm9tIGpRdWVyeSBVSSBzbGlkZXIsIHRoZSBmb2xsb3dpbmcgc291cmNlIHdpbGwgcm91bmQgdG8gdGhlIG5lYXJlc3Qgc3RlcAoJCXZhciB2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJdmFyIGFsaWduVmFsdWUgPSBuZXd2YWwgLSB2YWxNb2RTdGVwOwoKCQlpZiAoIE1hdGguYWJzKCB2YWxNb2RTdGVwICkgKiAyID49IHN0ZXAgKSB7CgkJCWFsaWduVmFsdWUgKz0gKCB2YWxNb2RTdGVwID4gMCApID8gc3RlcCA6ICggLXN0ZXAgKTsKCQl9CgoJCXZhciBwZXJjZW50UGVyU3RlcCA9IDEwMC8oKG1heC1taW4pL3N0ZXApOwoJCS8vIFNpbmNlIEphdmFTY3JpcHQgaGFzIHByb2JsZW1zIHdpdGggbGFyZ2UgZmxvYXRzLCByb3VuZAoJCS8vIHRoZSBmaW5hbCB2YWx1ZSB0byA1IGRpZ2l0cyBhZnRlciB0aGUgZGVjaW1hbCBwb2ludCAoc2VlIGpRdWVyeVVJOiAjNDEyNCkKCQluZXd2YWwgPSBwYXJzZUZsb2F0KCBhbGlnblZhbHVlLnRvRml4ZWQoNSkgKTsKCgkJaWYgKCB0eXBlb2YgcHhTdGVwID09PSAidW5kZWZpbmVkIiApIHsKCQkJcHhTdGVwID0gd2lkdGggLyAoIChtYXgtbWluKSAvIHN0ZXAgKTsKCQl9CgkJaWYgKCBweFN0ZXAgPiAxICYmIGlzSW5wdXQgKSB7CgkJCXBlcmNlbnQgPSAoIG5ld3ZhbCAtIG1pbiApICogcGVyY2VudFBlclN0ZXAgKiAoIDEgLyBzdGVwICk7CgkJfQoJCWlmICggcGVyY2VudCA8IDAgKSB7CgkJCXBlcmNlbnQgPSAwOwoJCX0KCgkJaWYgKCBwZXJjZW50ID4gMTAwICkgewoJCQlwZXJjZW50ID0gMTAwOwoJCX0KCgkJaWYgKCBuZXd2YWwgPCBtaW4gKSB7CgkJCW5ld3ZhbCA9IG1pbjsKCQl9CgoJCWlmICggbmV3dmFsID4gbWF4ICkgewoJCQluZXd2YWwgPSBtYXg7CgkJfQoKCQl0aGlzLmhhbmRsZS5jc3MoICJsZWZ0IiwgcGVyY2VudCArICIlIiApOwoKCQl0aGlzLmhhbmRsZVswXS5zZXRBdHRyaWJ1dGUoICJhcmlhLXZhbHVlbm93IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5hdHRyKCAidmFsdWUiICkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZXRleHQiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAidGl0bGUiLCBpc0lucHV0ID8gbmV3dmFsIDogb3B0aW9uRWxlbWVudHMuZXEoIG5ld3ZhbCApLmdldEVuY29kZWRUZXh0KCkgKTsKCgkJaWYgKCB0aGlzLnZhbHVlYmcgKSB7CgkJCXRoaXMudmFsdWViZy5jc3MoICJ3aWR0aCIsIHBlcmNlbnQgKyAiJSIgKTsKCQl9CgoJCS8vIGRyYWcgdGhlIGxhYmVsIHdpZHRocwoJCWlmICggdGhpcy5fbGFiZWxzICkgewoJCQl2YXIgaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwLAoJCQkJYVBlcmNlbnQgPSBwZXJjZW50ICYmIGhhbmRsZVBlcmNlbnQgKyAoIDEwMCAtIGhhbmRsZVBlcmNlbnQgKSAqIHBlcmNlbnQgLyAxMDAsCgkJCQliUGVyY2VudCA9IHBlcmNlbnQgPT09IDEwMCA/IDAgOiBNYXRoLm1pbiggaGFuZGxlUGVyY2VudCArIDEwMCAtIGFQZXJjZW50LCAxMDAgKTsKCgkJCXRoaXMuX2xhYmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGFiID0gJCggdGhpcyApLmlzKCAiLnVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFyIHZhbHVlQ2hhbmdlZCA9IGZhbHNlOwoKCQkJLy8gdXBkYXRlIGNvbnRyb2wicyB2YWx1ZQoJCQlpZiAoIGlzSW5wdXQgKSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sLnZhbCgpICE9PSBuZXd2YWw7CgkJCQljb250cm9sLnZhbCggbmV3dmFsICk7CgkJCX0gZWxzZSB7CgkJCQl2YWx1ZUNoYW5nZWQgPSBjb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCAhPT0gbmV3dmFsOwoJCQkJY29udHJvbFsgMCBdLnNlbGVjdGVkSW5kZXggPSBuZXd2YWw7CgkJCX0KCQkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY2hhbmdlIiwgdmFsICkgPT09IGZhbHNlKSB7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggIWlzZnJvbUNvbnRyb2wgJiYgdmFsdWVDaGFuZ2VkICkgewoJCQkJY29udHJvbC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQl9CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCBmYWxzZSApOwoJCXRoaXMuc2xpZGVyLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCBmYWxzZSApOwoJCXJldHVybiB0aGlzLl9zZXRPcHRpb24oICJkaXNhYmxlZCIsIGZhbHNlICk7Cgl9LAoKCWRpc2FibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGlzYWJsZWQiLCB0cnVlICk7CgkJdGhpcy5zbGlkZXIuYWRkQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKS5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHRydWUgKTsKCQlyZXR1cm4gdGhpcy5fc2V0T3B0aW9uKCAiZGlzYWJsZWQiLCB0cnVlICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnNsaWRlci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnJhbmdlc2xpZGVyIiwgJC5tb2JpbGUud2lkZ2V0LCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWRpc2FibGVkOiBmYWxzZSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0ncmFuZ2VzbGlkZXInKSIsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlY29uZExhYmVsLAoJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCWVsQ2xhc3MgPSB0aGlzLm9wdGlvbnMubWluaSA/ICJ1aS1yYW5nZXNsaWRlciB1aS1taW5pIiA6ICJ1aS1yYW5nZXNsaWRlciIsCgkJCV9pbnB1dEZpcnN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5maXJzdCgpLAoJCQlfaW5wdXRMYXN0ID0gJGVsLmZpbmQoICJpbnB1dCIgKS5sYXN0KCksCgkJCWxhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyRmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5zbGlkZXIsCgkJCWZpcnN0SGFuZGxlID0gJC5kYXRhKCBfaW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLAoJCQlfc2xpZGVycyA9ICQoICI8ZGl2IGNsYXNzPVwidWktcmFuZ2VzbGlkZXItc2xpZGVyc1wiIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCQkJCgkJCWlmICggJGVsLmZpbmQoICJsYWJlbCIgKS5sZW5ndGggPiAxICkgewoJCQkJc2Vjb25kTGFiZWwgPSAkZWwuZmluZCggImxhYmVsIiApLmxhc3QoKS5oaWRlKCk7CgkJCX0KCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCQkJCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCWxhYmVsLnByZXBlbmRUbyggJGVsICk7CgkJCWZpcnN0SGFuZGxlLnByZXBlbmRUbyggX3NsaWRlckxhc3QgKTsKCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfaW5wdXRGaXJzdDogX2lucHV0Rmlyc3QsCgkJCQlfaW5wdXRMYXN0OiBfaW5wdXRMYXN0LAoJCQkJX3NsaWRlckZpcnN0OiBfc2xpZGVyRmlyc3QsCgkJCQlfc2xpZGVyTGFzdDogX3NsaWRlckxhc3QsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoJCQkKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpewoJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCS8vd2UgbXVzdCB3YWl0IGZvciB0aGUgc3RhY2sgdG8gdW53aW5kIGJlZm9yZSB1cGRhdGVpbmcgb3RoZXIgd2lzZSBzbGlkZXJzIHdpbGwgbm90IGhhdmUgdXBkYXRlZCB5ZXQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKXsKCQkJCXNlbGYuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQl9LDApOwoJCX0sCgoJCV9kcmFnRmlyc3RIYW5kbGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJLy9pZiB0aGUgZmlyc3QgaGFuZGxlIGlzIGRyYWdnZWQgc2VuZCB0aGUgZXZlbnQgdG8gdGhlIGZpcnN0IHNsaWRlcgoJCQkkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5yZWZyZXNoKCBldmVudCApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSwKCgkJX3NsaWRlZHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5pcyggdGhpcy5faW5wdXRGaXJzdCApLAoJCQkJb3RoZXJTbGlkZXIgPSAoIGZpcnN0ICkgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIGRyYWcgd2FzIGluaXRpYXRlZCBvbiBhbiBleHRyZW1lIGFuZCB0aGUgb3RoZXIgaGFuZGxlIGlzIGZvY3VzZWQgc2VuZCB0aGUgZXZlbnRzIHRvCgkJCS8vdGhlIGNsb3Nlc3QgaGFuZGxlCgkJCWlmICggKCB0aGlzLl9wcm94eSA9PT0gImZpcnN0IiAmJiBmaXJzdCApIHx8ICggdGhpcy5fcHJveHkgPT09ICJsYXN0IiAmJiAhZmlyc3QgKSApIHsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgkJCQoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250IAoJCQkvL3RoaXMgbWFrZXMgY2xpY2tzIG9uIHRoZSB0cmFjayBnbyB0aGUgdGhlIGxhc3QgaGFuZGxlIHVzZWQKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS50cmlnZ2VyKCAidm1vdXNldXAiICk7CgkJCXRoaXMuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/IDEgOiAiIiApOwoJCX0sCgoJCV9zbGlkZWJlZm9yZXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSB0cmFjayBpcyB0aGUgdGFyZ2V0IHJlbWVtYmVyIHRoaXMgYW5kIHRoZSBvcmlnaW5hbCB2YWx1ZQoJCQlpZiAoICQoIGV2ZW50Lm9yaWdpbmFsRXZlbnQudGFyZ2V0ICkuaGFzQ2xhc3MoICJ1aS1zbGlkZXItdHJhY2siICkgKSB7CgkJCQl0aGlzLl9zbGlkZXJUYXJnZXQgPSB0cnVlOwoJCQkJdGhpcy5fdGFyZ2V0VmFsID0gJCggZXZlbnQudGFyZ2V0ICkudmFsKCk7CgkJCX0KCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdGhpcy5fc3VwZXJBcHBseSggb3B0aW9ucyApOwoJCQl0aGlzLnJlZnJlc2goKTsKCQl9LAoKCQlyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCQkkZWwuZmluZCggImlucHV0IiApLnNsaWRlcih7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCXRyYWNrVGhlbWU6IG8udHJhY2tUaGVtZSwKCQkJCWRpc2FibGVkOiBvLmRpc2FibGVkLAoJCQkJbWluaTogby5taW5pLAoJCQkJaGlnaGxpZ2h0OiBvLmhpZ2hsaWdodAoJCQl9KS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQl9LAoKCQlfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggZXZlbnQudHlwZSA9PT0gImtleXVwIiApIHsKCQkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQltaW4gPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpLCAxMCApLAoJCQkJbWF4ID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRMYXN0LnZhbCgpLCAxMCApLAoJCQkJZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApLAoJCQkJdGhpc1NsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRGaXJzdCA6IHRoaXMuX2lucHV0TGFzdCwKCQkJCW90aGVyU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoJCQkKCQkJCgkJCWlmKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApewoJCQkJdGhpc1NsaWRlci5ibHVyKCk7CgkJCX0gZWxzZSBpZiggZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgKXsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIG1pbiA+IG1heCAmJiAhdGhpcy5fc2xpZGVyVGFyZ2V0ICkgewoJCQkJLy90aGlzIHByZXZlbnRzIG1pbiBmcm9tIGJlaW5nIGdyZWF0ZXIgdGhlbiBtYXgKCQkJCXRoaXNTbGlkZXIudmFsKCBmaXJzdCA/IG1heDogbWluICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCXRoaXMuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCX0gZWxzZSBpZiAoIG1pbiA+IG1heCApIHsKCQkJCS8vdGhpcyBtYWtlcyBpdCBzbyBjbGlja3Mgb24gdGhlIHRhcmdldCBvbiBlaXRoZXIgZXh0cmVtZSBnbyB0byB0aGUgY2xvc2VzdCBoYW5kbGUKCQkJCXRoaXNTbGlkZXIudmFsKCB0aGlzLl90YXJnZXRWYWwgKS5zbGlkZXIoICJyZWZyZXNoIiApOwoKCQkJCS8vWW91IG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBzbyBmaXJzdCBzbGlkZXIgaXMgdXBkYXRlZCBiZWZvcmUgdXBkYXRpbmcgc2Vjb25kCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlvdGhlclNsaWRlci52YWwoIGZpcnN0ID8gbWluOiBtYXggKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5mb2N1cygpOwoJCQkJCXNlbGYuX3NsaWRlckZpcnN0LmNzcyggInotaW5kZXgiLCBmaXJzdCA/ICIiIDogMSApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCQl9LCAwICk7CgkJCQl0aGlzLl9wcm94eSA9ICggZmlyc3QgKSA/ICJmaXJzdCIgOiAibGFzdCI7CgkJCX0KCQkJLy9maXhlcyBpc3N1ZSB3aGVyZSB3aGVuIGJvdGggX3NsaWRlcnMgYXJlIGF0IG1pbiB0aGV5IGNhbm5vdCBiZSBhZGp1c3RlZAoJCQlpZiAoIG1pbiA9PT0gbWF4ICkgewoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsIDEgKTsKCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMCApOwoJCQl9IGVsc2UgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGVTbGlkZXIiICkuaGFuZGxlLmNzcyggInotaW5kZXgiLCAiIiApOwoJCQkJJC5kYXRhKCB0aGlzU2xpZGVyLmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuY3NzKCAiei1pbmRleCIsICIiICk7CgkJCX0KCQkJCgkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkKCQkJaWYgKCBtaW4gPj0gbWF4ICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfSwKCgkJX3VwZGF0ZUhpZ2hsaWdodDogZnVuY3Rpb24oKSB7CgkJCXZhciBtaW4gPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZVNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlU2xpZGVyIiApLmhhbmRsZS5nZXQoMCkuc3R5bGUubGVmdCwgMTAgKSwKCQkJCXdpZHRoID0gKG1heCAtIG1pbik7CgoJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS1zbGlkZXItYmciICkuY3NzKHsKCQkJCSJtYXJnaW4tbGVmdCI6IG1pbiArICIlIiwKCQkJCSJ3aWR0aCI6IHdpZHRoICsgIiUiCgkJCX0pOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXIgdWktbWluaSIgKS5maW5kKCAibGFiZWwiICkuc2hvdygpOwoJCQl0aGlzLl9pbnB1dEZpcnN0LmFmdGVyKCB0aGlzLl9zbGlkZXJGaXJzdCApOwoJCQl0aGlzLl9pbnB1dExhc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckxhc3QgKTsKCQkJdGhpcy5fc2xpZGVycy5yZW1vdmUoKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICJpbnB1dCIgKS5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IHVpLXJhbmdlc2xpZGVyLWxhc3QiICkuc2xpZGVyKCAiZGVzdHJveSIgKTsKCQl9CgoJfSk7CgokLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQubW9iaWxlLnJhbmdlc2xpZGVyLCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICk7CgovL2F1dG8gc2VsZi1pbml0IHdpZGdldHMKJCggZG9jdW1lbnQgKS5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnJhbmdlc2xpZGVyLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuc2VsZWN0bWVudSIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlkaXNhYmxlZDogZmFsc2UsCgkJaWNvbjogImFycm93LWQiLAoJCWljb25wb3M6ICJyaWdodCIsCgkJaW5saW5lOiBmYWxzZSwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpY29uc2hhZG93OiB0cnVlLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWRpdmlkZXJUaGVtZTogImIiLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCWluaXRTZWxlY3RvcjogInNlbGVjdDpub3QoIDpqcW1EYXRhKHJvbGU9J3NsaWRlcicpICkiLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJdGhpcy5zZWxlY3QgPSB0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1idG4tbGVmdCB1aS1idG4tcmlnaHQiICkud3JhcCggIjxkaXYgY2xhc3M9J3VpLXNlbGVjdCIgKyBjbGFzc2VzICsgIic+IiApOwoJCXRoaXMuc2VsZWN0SUQgID0gdGhpcy5zZWxlY3QuYXR0ciggImlkIiApOwoJCXRoaXMubGFiZWwgPSAkKCAibGFiZWxbZm9yPSciKyB0aGlzLnNlbGVjdElEICsiJ10iICkuYWRkQ2xhc3MoICJ1aS1zZWxlY3QiICk7CgkJdGhpcy5pc011bHRpcGxlID0gdGhpcy5zZWxlY3RbIDAgXS5tdWx0aXBsZTsKCQlpZiAoICF0aGlzLm9wdGlvbnMudGhlbWUgKSB7CgkJCXRoaXMub3B0aW9ucy50aGVtZSA9ICQubW9iaWxlLmdldEluaGVyaXRlZFRoZW1lKCB0aGlzLnNlbGVjdCwgImMiICk7CgkJfQoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHdyYXBwZXIgPSB0aGlzLmVsZW1lbnQucGFyZW50cyggIi51aS1zZWxlY3QiICk7CgkJaWYgKCB3cmFwcGVyLmxlbmd0aCA+IDAgKSB7CgkJCWlmICggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCwgLnVpLWJ0bi1yaWdodCIgKSApIHsKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggd3JhcHBlci5pcyggIi51aS1idG4tbGVmdCIgKSA/ICJ1aS1idG4tbGVmdCIgOiAidWktYnRuLXJpZ2h0IiApOwoJCQl9CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRBZnRlciggd3JhcHBlciApOwoJCQl3cmFwcGVyLnJlbW92ZSgpOwoJCX0KCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcHJlRXh0ZW5zaW9uKCk7CgoJCS8vIEFsbG93cyBmb3IgZXh0ZW5zaW9uIG9mIHRoZSBuYXRpdmUgc2VsZWN0IGZvciBjdXN0b20gc2VsZWN0cyBhbmQgb3RoZXIgcGx1Z2lucwoJCS8vIHNlZSBzZWxlY3QuY3VzdG9tIGZvciBleGFtcGxlIGV4dGVuc2lvbgoJCS8vIFRPRE8gZXhwbG9yZSBwbHVnaW4gcmVnaXN0cmF0aW9uCgkJdGhpcy5fdHJpZ2dlciggImJlZm9yZUNyZWF0ZSIgKTsKCgkJdGhpcy5idXR0b24gPSB0aGlzLl9idXR0b24oKTsKCgkJdmFyIHNlbGYgPSB0aGlzLAoKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCgkJCWlubGluZSA9IG9wdGlvbnMuaW5saW5lIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpbmxpbmUiICksCgkJCW1pbmkgPSBvcHRpb25zLm1pbmkgfHwgdGhpcy5zZWxlY3QuanFtRGF0YSggIm1pbmkiICksCgkJCWljb25wb3MgPSBvcHRpb25zLmljb24gPyAoIG9wdGlvbnMuaWNvbnBvcyB8fCB0aGlzLnNlbGVjdC5qcW1EYXRhKCAiaWNvbnBvcyIgKSApIDogZmFsc2UsCgoJCQkvLyBJRSB0aHJvd3MgYW4gZXhjZXB0aW9uIGF0IG9wdGlvbnMuaXRlbSgpIGZ1bmN0aW9uIHdoZW4KCQkJLy8gdGhlcmUgaXMgbm8gc2VsZWN0ZWQgaXRlbQoJCQkvLyBzZWxlY3QgZmlyc3QgaW4gdGhpcyBjYXNlCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnNlbGVjdFsgMCBdLnNlbGVjdGVkSW5kZXggPT09IC0xID8gMCA6IHRoaXMuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCgkJCS8vIFRPRE8gdmFsdWVzIGJ1dHRvbklkIGFuZCBtZW51SWQgYXJlIHVuZGVmaW5lZCBoZXJlCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYnV0dG9uTWFya3VwKCB7CgkJCQkJdGhlbWU6IG9wdGlvbnMudGhlbWUsCgkJCQkJaWNvbjogb3B0aW9ucy5pY29uLAoJCQkJCWljb25wb3M6IGljb25wb3MsCgkJCQkJaW5saW5lOiBpbmxpbmUsCgkJCQkJY29ybmVyczogb3B0aW9ucy5jb3JuZXJzLAoJCQkJCXNoYWRvdzogb3B0aW9ucy5zaGFkb3csCgkJCQkJaWNvbnNoYWRvdzogb3B0aW9ucy5pY29uc2hhZG93LAoJCQkJCW1pbmk6IG1pbmkKCQkJCX0pOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1idG4tdXAtYyB1aS1idG4tY29ybmVyLWFsbCIgKQoJCQkJLmhpZGUoKQoJCQkJLmFwcGVuZFRvKCBidXR0b24uYWRkQ2xhc3MoJ3VpLWxpLWhhcy1jb3VudCcpICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0cignZGlzYWJsZWQnKSkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIEV2ZW50cyBvbiBuYXRpdmUgc2VsZWN0CgkJdGhpcy5zZWxlY3QuY2hhbmdlKGZ1bmN0aW9uKCkgewoJCQlzZWxmLnJlZnJlc2goKTsKCQkJCgkJCWlmICggISFvcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCQl0aGlzLmJsdXIoKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5idWlsZCgpOwoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQl0aGlzLnNlbGVjdAoJCQkuYXBwZW5kVG8oIHNlbGYuYnV0dG9uICkKCQkJLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBBZGQgYWN0aXZlIGNsYXNzIHRvIGJ1dHRvbgoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLmFkZENsYXNzKCAkLm1vYmlsZS5mb2N1c0NsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyB2bW91c2VvdmVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3ZlciIgKTsKCQkJfSkKCQkJLmJpbmQoICJ2bW91c2Vtb3ZlIiwgZnVuY3Rpb24oKSB7CgkJCQkvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIG9uIHNjcm9sbC90b3VjaG1vdmUKCQkJCXNlbGYuYnV0dG9uLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImNoYW5nZSBibHVyIHZtb3VzZW91dCIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24udHJpZ2dlciggInZtb3VzZW91dCIgKQoJCQkJCS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJjaGFuZ2UgYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgc2VsZi5vcHRpb25zLnRoZW1lICk7CgkJCX0pOwoKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgc2VsZWN0IHVwb24gdGFwLCB0aGlzIHByZXZlbnRzIHRoYXQgZnJvbSBoYXBwZW5pbmcKCQlzZWxmLmJ1dHRvbi5iaW5kKCAidm1vdXNlZG93biIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5sYWJlbC5iaW5kKCAiY2xpY2sgZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuc2VsZWN0LmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJfSk7CgkJc2VsZi5idXR0b24uYmluZCggIm1vdXNldXAiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsJCQkJCgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewkJCQkKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCgl9LAoKCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fc2VsZWN0T3B0aW9ucygpLmZpbHRlciggIjpzZWxlY3RlZCIgKTsKCX0sCgoJc2VsZWN0ZWRJbmRpY2VzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXJldHVybiB0aGlzLnNlbGVjdGVkKCkubWFwKGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gc2VsZi5fc2VsZWN0T3B0aW9ucygpLmluZGV4KCB0aGlzICk7CgkJfSkuZ2V0KCk7Cgl9LAoKCXNldEJ1dHRvblRleHQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCksCgkJCXRleHQgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQlzcGFuID0gJCggZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggInNwYW4iICkgKTsKCgkJdGhpcy5idXR0b24uZmluZCggIi51aS1idG4tdGV4dCIgKS5odG1sKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGVjdGVkLmxlbmd0aCApIHsKCQkJCXRleHQgPSBzZWxlY3RlZC5tYXAoZnVuY3Rpb24oKSB7CgkJCQkJcmV0dXJuICQoIHRoaXMgKS50ZXh0KCk7CgkJCQl9KS5nZXQoKS5qb2luKCAiLCAiICk7CgkJCX0gZWxzZSB7CgkJCQl0ZXh0ID0gc2VsZi5wbGFjZWhvbGRlcjsKCQkJfQoKCQkJLy8gVE9ETyBwb3NzaWJseSBhZ2dyZWdhdGUgbXVsdGlwbGUgc2VsZWN0IG9wdGlvbiBjbGFzc2VzCgkJCXJldHVybiBzcGFuLnRleHQoIHRleHQgKQoJCQkJLmFkZENsYXNzKCBzZWxmLnNlbGVjdC5hdHRyKCAiY2xhc3MiICkgKQoJCQkJLmFkZENsYXNzKCBzZWxlY3RlZC5hdHRyKCAiY2xhc3MiICkgKTsKCQl9KTsKCX0sCgoJc2V0QnV0dG9uQ291bnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKTsKCgkJLy8gbXVsdGlwbGUgY291bnQgaW5zaWRlIGJ1dHRvbgoJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQl0aGlzLmJ1dHRvbkNvdW50WyBzZWxlY3RlZC5sZW5ndGggPiAxID8gInNob3ciIDogImhpZGUiIF0oKS50ZXh0KCBzZWxlY3RlZC5sZW5ndGggKTsKCQl9Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0QnV0dG9uVGV4dCgpOwoJCXRoaXMuc2V0QnV0dG9uQ291bnQoKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKLy9hdXRvIHNlbGYtaW5pdCB3aWRnZXRzCiQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUuc2VsZWN0bWVudS5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQsIHRydWUgKTsKfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCWZ1bmN0aW9uIGZpdFNlZ21lbnRJbnNpZGVTZWdtZW50KCB3aW5TaXplLCBzZWdTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7CgkJdmFyIHJldCA9IGRlc2lyZWQ7CgoJCWlmICggd2luU2l6ZSA8IHNlZ1NpemUgKSB7CgkJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCQlyZXQgPSBvZmZzZXQgKyAoIHdpblNpemUgLSBzZWdTaXplICkgLyAyOwoJCX0gZWxzZSB7CgkJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQkJcmV0ID0gTWF0aC5taW4oIE1hdGgubWF4KCBvZmZzZXQsIGRlc2lyZWQgLSBzZWdTaXplIC8gMiApLCBvZmZzZXQgKyB3aW5TaXplIC0gc2VnU2l6ZSApOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglmdW5jdGlvbiB3aW5kb3dDb29yZHMoKSB7CgkJdmFyICR3aW4gPSAkLm1vYmlsZS53aW5kb3c7CgoJCXJldHVybiB7CgkJCXg6ICR3aW4uc2Nyb2xsTGVmdCgpLAoJCQl5OiAkd2luLnNjcm9sbFRvcCgpLAoJCQljeDogKCB3aW5kb3cuaW5uZXJXaWR0aCB8fCAkd2luLndpZHRoKCkgKSwKCQkJY3k6ICggd2luZG93LmlubmVySGVpZ2h0IHx8ICR3aW4uaGVpZ2h0KCkgKQoJCX07Cgl9CgoJJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS53aWRnZXQsIHsKCQlvcHRpb25zOiB7CgkJCXRoZW1lOiBudWxsLAoJCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJCXNoYWRvdzogdHJ1ZSwKCQkJY29ybmVyczogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQkJdG9sZXJhbmNlOiBudWxsLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiwKCQkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCQljbG9zZUxpbmtFdmVudHM6ICJjbGljay5wb3B1cCIsCgkJCW5hdmlnYXRlRXZlbnRzOiAibmF2aWdhdGUucG9wdXAiLAoJCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCgkJCS8vIE5PVEUgV2luZG93cyBQaG9uZSA3IGhhcyBhIHNjcm9sbCBwb3NpdGlvbiBjYWNoaW5nIGlzc3VlIHRoYXQKCQkJLy8gICAgICByZXF1aXJlcyB1cyB0byBkaXNhYmxlIHBvcHVwIGhpc3RvcnkgbWFuYWdlbWVudCBieSBkZWZhdWx0CgkJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJCS8vCgkJCS8vIE5PVEUgdGhpcyBvcHRpb24gaXMgbW9kaWZpZWQgaW4gX2NyZWF0ZSEKCQkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCQl9LAoKCQlfZWF0RXZlbnRBbmRDbG9zZTogZnVuY3Rpb24oIGUgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCS8vIE1ha2Ugc3VyZSB0aGUgc2NyZWVuIHNpemUgaXMgaW5jcmVhc2VkIGJleW9uZCB0aGUgcGFnZSBoZWlnaHQgaWYgdGhlIHBvcHVwJ3MgY2F1c2VzIHRoZSBkb2N1bWVudCB0byBpbmNyZWFzZSBpbiBoZWlnaHQKCQlfcmVzaXplU2NyZWVuOiBmdW5jdGlvbigpIHsKCQkJdmFyIHBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICk7CgoJCQl0aGlzLl91aS5zY3JlZW4ucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJCQlpZiAoIHBvcHVwSGVpZ2h0ID4gdGhpcy5fdWkuc2NyZWVuLmhlaWdodCgpICkgewoJCQkJdGhpcy5fdWkuc2NyZWVuLmhlaWdodCggcG9wdXBIZWlnaHQgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dLZXlVcDogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5faXNPcGVuICYmIGUua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCQlyZXR1cm4gdGhpcy5fZWF0RXZlbnRBbmRDbG9zZSggZSApOwoJCQl9CgkJfSwKCgkJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQkJdmFyIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpOwoKCQkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQkJaWYgKCB3aW5Db29yZHMueCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMueCAmJgoJCQkJCXdpbkNvb3Jkcy55ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy55ICYmCgkJCQkJd2luQ29vcmRzLmN4ID09PSB0aGlzLl9yZXNpemVEYXRhLndpbkNvb3Jkcy5jeCAmJgoJCQkJCXdpbkNvb3Jkcy5jeSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5Db29yZHMuY3kgKSB7CgkJCQkJLy8gdGltZW91dCBub3QgcmVmcmVzaGVkCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjbGVhciBleGlzdGluZyB0aW1lb3V0IC0gaXQgd2lsbCBiZSByZWZyZXNoZWQgYmVsb3cKCQkJCQljbGVhclRpbWVvdXQoIHRoaXMuX3Jlc2l6ZURhdGEudGltZW91dElkICk7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3Jlc2l6ZURhdGEgPSB7CgkJCQl0aW1lb3V0SWQ6IHNldFRpbWVvdXQoICQucHJveHkoIHRoaXMsICJfcmVzaXplVGltZW91dCIgKSwgMjAwICksCgkJCQl3aW5Db29yZHM6IHdpbkNvb3JkcwoJCQl9OwoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJX3Jlc2l6ZVRpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCWlmICggIXRoaXMuX2V4cGVjdFJlc2l6ZUV2ZW50KCkgKSB7CgkJCQkJaWYgKCB0aGlzLl91aS5jb250YWluZXIuaGFzQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkgKSB7CgkJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoJCQkJCQl0aGlzLnJlcG9zaXRpb24oIHsgcG9zaXRpb25UbzogIndpbmRvdyIgfSApOwoJCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCQl9CgoJCQkJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJCXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyA9IGZhbHNlOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJdGhpcy5fcmVzaXplRGF0YSA9IG51bGw7CgkJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSBmYWxzZTsKCQkJfQoJCX0sCgoJCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgc2VsZiA9IHRoaXM7CgoJCQlpZiAoIHRoaXMuX2lnbm9yZVJlc2l6ZVRvICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9pZ25vcmVSZXNpemVUbyApOwoJCQl9CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZVRvID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7IHNlbGYuX2lnbm9yZVJlc2l6ZVRvID0gMDsgfSwgMTAwMCApOwoJCX0sCgoJCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKCBlICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiAmJiB0aGlzLl9pZ25vcmVSZXNpemVUbyA9PT0gMCApIHsKCQkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkJIXRoaXMuX3VpLmNvbnRhaW5lci5oYXNDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKSApIHsKCQkJCQkvLyBlZmZlY3RpdmVseSByYXBpZC1jbG9zZSB0aGUgcG9wdXAgd2hpbGUgbGVhdmluZyB0aGUgc2NyZWVuIGludGFjdAoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkKCQkJCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggIXRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyAmJiB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gdHJ1ZTsKCQkJfQoJCX0sCgoJCS8vIFdoZW4gdGhlIHBvcHVwIGlzIG9wZW4sIGF0dGVtcHRpbmcgdG8gZm9jdXMgb24gYW4gZWxlbWVudCB0aGF0IGlzIG5vdCBhCgkJLy8gY2hpbGQgb2YgdGhlIHBvcHVwIHdpbGwgcmVkaXJlY3QgZm9jdXMgdG8gdGhlIHBvcHVwCgkJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIGUgKSB7CgkJCXZhciB0Z3QgPSBlLnRhcmdldCwgJHRndCwgdWkgPSB0aGlzLl91aTsKCgkJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCB0Z3QgIT09IHVpLmNvbnRhaW5lclsgMCBdICkgewoJCQkJJHRndCA9ICQoIGUudGFyZ2V0ICk7CgkJCQlpZiAoIDAgPT09ICR0Z3QucGFyZW50cygpLmZpbHRlciggdWkuY29udGFpbmVyWyAwIF0gKS5sZW5ndGggKSB7CgkJCQkJJCggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCApLm9uZSggImZvY3VzIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCSR0Z3QuYmx1cigpOwoJCQkJCX0pOwoJCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0gZWxzZSBpZiAoIHVpLmZvY3VzRWxlbWVudFsgMCBdID09PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJCQl1aS5mb2N1c0VsZW1lbnQgPSAkdGd0OwoJCQkJfQoJCQl9CgoJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIHVpID0gewoJCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuJz48L2Rpdj4iICksCgkJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQkJY29udGFpbmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktcG9wdXAtY29udGFpbmVyIHVpLXBvcHVwLWhpZGRlbic+PC9kaXY+IiApCgkJCQl9LAoJCQkJdGhpc1BhZ2UgPSB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQkJbXlJZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICksCgkJCQlzZWxmID0gdGhpczsKCgkJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCQkvLyBXZSBjYW4ndCBkbyBpdCBpbiB0aGUgb3B0aW9uIGRlY2xhcmF0aW9ucyBiZWNhdXNlIHRob3NlIGFyZSBydW4gYmVmb3JlCgkJCS8vIGl0IGlzIGRldGVybWluZWQgd2hldGhlciB0aGVyZSBzaGFsbCBiZSBBSkFYIG5hdi4KCQkJdGhpcy5vcHRpb25zLmhpc3RvcnkgPSB0aGlzLm9wdGlvbnMuaGlzdG9yeSAmJiAkLm1vYmlsZS5hamF4RW5hYmxlZCAmJiAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZDsKCgkJCWlmICggdGhpc1BhZ2UubGVuZ3RoID09PSAwICkgewoJCQkJdGhpc1BhZ2UgPSAkKCAiYm9keSIgKTsKCQkJfQoKCQkJLy8gZGVmaW5lIHRoZSBjb250YWluZXIgZm9yIG5hdmlnYXRpb24gZXZlbnQgYmluZGluZ3MKCQkJLy8gVE9ETyB0aGlzIHdvdWxkIGJlIG5pY2UgYXQgdGhlIHRoZSBtb2JpbGUgd2lkZ2V0IGxldmVsCgkJCXRoaXMub3B0aW9ucy5jb250YWluZXIgPSB0aGlzLm9wdGlvbnMuY29udGFpbmVyIHx8ICQubW9iaWxlLnBhZ2VDb250YWluZXI7CgoJCQkvLyBBcHBseSB0aGUgcHJvdG8KCQkJdGhpc1BhZ2UuYXBwZW5kKCB1aS5zY3JlZW4gKTsKCQkJdWkuY29udGFpbmVyLmluc2VydEFmdGVyKCB1aS5zY3JlZW4gKTsKCQkJLy8gTGVhdmUgYSBwbGFjZWhvbGRlciB3aGVyZSB0aGUgZWxlbWVudCB1c2VkIHRvIGJlCgkJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGlzLmVsZW1lbnQgKTsKCQkJaWYgKCBteUlkICkgewoJCQkJdWkuc2NyZWVuLmF0dHIoICJpZCIsIG15SWQgKyAiLXNjcmVlbiIgKTsKCQkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJCXVpLnBsYWNlaG9sZGVyLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCQl9CgkJCXVpLmNvbnRhaW5lci5hcHBlbmQoIHRoaXMuZWxlbWVudCApOwoJCQl1aS5mb2N1c0VsZW1lbnQgPSB1aS5jb250YWluZXI7CgoJCQkvLyBBZGQgY2xhc3MgdG8gcG9wdXAgZWxlbWVudAoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1wb3B1cCIgKTsKCgkJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9zY3JvbGxUb3A6IDAsCgkJCQlfcGFnZTogdGhpc1BhZ2UsCgkJCQlfdWk6IHVpLAoJCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCQlfY3VycmVudFRyYW5zaXRpb246IGZhbHNlLAoJCQkJX3ByZXJlcXM6IG51bGwsCgkJCQlfaXNPcGVuOiBmYWxzZSwKCQkJCV90b2xlcmFuY2U6IG51bGwsCgkJCQlfcmVzaXplRGF0YTogbnVsbCwKCQkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJCV9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3M6IGZhbHNlCgkJCX0pOwoKCQkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJLy8gQ2F1c2UgaW5pdGlhbCBvcHRpb25zIHRvIGJlIGFwcGxpZWQgYnkgdGhlaXIgaGFuZGxlciBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIHRoZSBvcHRpb24gdG8gdW5kZWZpbmVkCgkJCQkvLyAtIHRoZSBoYW5kbGVyIHRoZW4gc2V0cyBpdCB0byB0aGUgaW5pdGlhbCB2YWx1ZQoJCQkJc2VsZi5vcHRpb25zWyBrZXkgXSA9IHVuZGVmaW5lZDsKCQkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSwgdHJ1ZSApOwoJCQl9KTsKCgkJCXVpLnNjcmVlbi5iaW5kKCAidmNsaWNrIiwgJC5wcm94eSggdGhpcywgIl9lYXRFdmVudEFuZENsb3NlIiApICk7CgoJCQl0aGlzLl9vbiggJC5tb2JpbGUud2luZG93LCB7CgkJCQlvcmllbnRhdGlvbmNoYW5nZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZSIgKSwKCQkJCXJlc2l6ZTogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dSZXNpemUiICksCgkJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCQl9KTsKCQkJdGhpcy5fb24oICQubW9iaWxlLmRvY3VtZW50LCB7CgkJCQlmb2N1c2luOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZURvY3VtZW50Rm9jdXNJbiIgKQoJCQl9KTsKCQl9LAoKCQlfYXBwbHlUaGVtZTogZnVuY3Rpb24oIGRzdCwgdGhlbWUsIHByZWZpeCApIHsKCQkJdmFyIGNsYXNzZXMgPSAoIGRzdC5hdHRyKCAiY2xhc3MiICkgfHwgIiIpLnNwbGl0KCAiICIgKSwKCQkJCWFscmVhZHlBZGRlZCA9IHRydWUsCgkJCQljdXJyZW50VGhlbWUgPSBudWxsLAoJCQkJbWF0Y2hlcywKCQkJCXRoZW1lU3RyID0gU3RyaW5nKCB0aGVtZSApOwoKCQkJd2hpbGUgKCBjbGFzc2VzLmxlbmd0aCA+IDAgKSB7CgkJCQljdXJyZW50VGhlbWUgPSBjbGFzc2VzLnBvcCgpOwoJCQkJbWF0Y2hlcyA9ICggbmV3IFJlZ0V4cCggIl51aS0iICsgcHJlZml4ICsgIi0oW2Etel0pJCIgKSApLmV4ZWMoIGN1cnJlbnRUaGVtZSApOwoJCQkJaWYgKCBtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoID4gMSApIHsKCQkJCQljdXJyZW50VGhlbWUgPSBtYXRjaGVzWyAxIF07CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWN1cnJlbnRUaGVtZSA9IG51bGw7CgkJCQl9CgkJCX0KCgkJCWlmICggdGhlbWUgIT09IGN1cnJlbnRUaGVtZSApIHsKCQkJCWRzdC5yZW1vdmVDbGFzcyggInVpLSIgKyBwcmVmaXggKyAiLSIgKyBjdXJyZW50VGhlbWUgKTsKCQkJCWlmICggISAoIHRoZW1lID09PSBudWxsIHx8IHRoZW1lID09PSAibm9uZSIgKSApIHsKCQkJCQlkc3QuYWRkQ2xhc3MoICJ1aS0iICsgcHJlZml4ICsgIi0iICsgdGhlbWVTdHIgKTsKCQkJCX0KCQkJfQoJCX0sCgoJCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9hcHBseVRoZW1lKCB0aGlzLmVsZW1lbnQsIHZhbHVlLCAiYm9keSIgKTsKCQl9LAoKCQlfc2V0T3ZlcmxheVRoZW1lOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2FwcGx5VGhlbWUoIHRoaXMuX3VpLnNjcmVlbiwgdmFsdWUsICJvdmVybGF5IiApOwoKCQkJaWYgKCB0aGlzLl9pc09wZW4gKSB7CgkJCQl0aGlzLl91aS5zY3JlZW4uYWRkQ2xhc3MoICJpbiIgKTsKCQkJfQoJCX0sCgoJCV9zZXRTaGFkb3c6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRDb3JuZXJzOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoJCX0sCgoJCV9hcHBseVRyYW5zaXRpb246IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJaWYgKCB2YWx1ZSAmJiB2YWx1ZSAhPT0gIm5vbmUiICkgewoJCQkJdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHZhbHVlICk7CgkJCQlpZiAoIHRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9PT0gIm5vbmUiICkgewoJCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICIiOwoJCQkJfQoJCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gKTsKCQkJfQoJCX0sCgoJCV9zZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCWlmICggIXRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJX3NldFRvbGVyYW5jZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl2YXIgdG9sID0geyB0OiAzMCwgcjogMTUsIGI6IDMwLCBsOiAxNSB9OwoKCQkJaWYgKCB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdmFyIGFyID0gU3RyaW5nKCB2YWx1ZSApLnNwbGl0KCAiLCIgKTsKCgkJCQkkLmVhY2goIGFyLCBmdW5jdGlvbiggaWR4LCB2YWwgKSB7IGFyWyBpZHggXSA9IHBhcnNlSW50KCB2YWwsIDEwICk7IH0gKTsKCgkJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCQkvLyBBbGwgdmFsdWVzIGFyZSB0byBiZSB0aGUgc2FtZQoJCQkJCWNhc2UgMToKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gdG9sLnIgPSB0b2wuYiA9IHRvbC5sID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJLy8gVGhlIGZpcnN0IHZhbHVlIGRlbm90ZXMgdG9wL2JvdHRvbSB0b2xlcmFuY2UsIGFuZCB0aGUgc2Vjb25kIHZhbHVlIGRlbm90ZXMgbGVmdC9yaWdodCB0b2xlcmFuY2UKCQkJCQljYXNlIDI6CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCQl0b2wudCA9IHRvbC5iID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLmwgPSB0b2wuciA9IGFyWyAxIF07CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vIFRoZSBhcnJheSBjb250YWlucyB2YWx1ZXMgaW4gdGhlIG9yZGVyIHRvcCwgcmlnaHQsIGJvdHRvbSwgbGVmdAoJCQkJCWNhc2UgNDoKCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJCXRvbC50ID0gYXJbIDAgXTsKCQkJCQkJfQoJCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQkJdG9sLnIgPSBhclsgMSBdOwoJCQkJCQl9CgkJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCQl0b2wuYiA9IGFyWyAyIF07CgkJCQkJCX0KCQkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJCXRvbC5sID0gYXJbIDMgXTsKCQkJCQkJfQoJCQkJCQlicmVhazsKCgkJCQkJZGVmYXVsdDoKCQkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCgkJCXRoaXMuX3RvbGVyYW5jZSA9IHRvbDsKCQl9LAoKCQlfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQkJdmFyIGV4Y2x1c2lvbnMsIHNldHRlciA9ICJfc2V0IiArIGtleS5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKCAxICk7CgoJCQlpZiAoIHRoaXNbIHNldHRlciBdICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzWyBzZXR0ZXIgXSggdmFsdWUgKTsKCQkJfQoKCQkJLy8gVE9ETyBSRU1PVkUgRk9SIDEuMi4xIGJ5IG1vdmluZyB0aGVtIG91dCB0byBhIGRlZmF1bHQgb3B0aW9ucyBvYmplY3QKCQkJZXhjbHVzaW9ucyA9IFsKCQkJCSJpbml0U2VsZWN0b3IiLAoJCQkJImNsb3NlTGlua1NlbGVjdG9yIiwKCQkJCSJjbG9zZUxpbmtFdmVudHMiLAoJCQkJIm5hdmlnYXRlRXZlbnRzIiwKCQkJCSJjbG9zZUV2ZW50cyIsCgkJCQkiaGlzdG9yeSIsCgkJCQkiY29udGFpbmVyIgoJCQldOwoKCQkJJC5tb2JpbGUud2lkZ2V0LnByb3RvdHlwZS5fc2V0T3B0aW9uLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJaWYgKCAkLmluQXJyYXkoIGtleSwgZXhjbHVzaW9ucyApID09PSAtMSApIHsKCQkJCS8vIFJlY29yZCB0aGUgb3B0aW9uIGNoYW5nZSBpbiB0aGUgb3B0aW9ucyBhbmQgaW4gdGhlIERPTSBkYXRhLSogYXR0cmlidXRlcwoJCQkJdGhpcy5lbGVtZW50LmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAoIGtleS5yZXBsYWNlKCAvKFtBLVpdKS8sICItJDEiICkudG9Mb3dlckNhc2UoKSApLCB2YWx1ZSApOwoJCQl9CgkJfSwKCgkJLy8gVHJ5IGFuZCBjZW50ZXIgdGhlIG92ZXJsYXkgb3ZlciB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMKCQlfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQkJLy8gcmVjdGFuZ2xlIHdpdGhpbiB3aGljaCB0aGUgcG9wdXAgbXVzdCBmaXQKCQkJdmFyCgkJCQl3aW5Db29yZHMgPSB3aW5kb3dDb29yZHMoKSwKCQkJCXJjID0gewoJCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJCXk6IHdpbkNvb3Jkcy55ICsgdGhpcy5fdG9sZXJhbmNlLnQsCgkJCQkJY3g6IHdpbkNvb3Jkcy5jeCAtIHRoaXMuX3RvbGVyYW5jZS5sIC0gdGhpcy5fdG9sZXJhbmNlLnIsCgkJCQkJY3k6IHdpbkNvb3Jkcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJCX0sCgkJCQltZW51U2l6ZSwgcmV0OwoKCQkJLy8gQ2xhbXAgdGhlIHdpZHRoIG9mIHRoZSBtZW51IGJlZm9yZSBncmFiYmluZyBpdHMgc2l6ZQoJCQl0aGlzLl91aS5jb250YWluZXIuY3NzKCAibWF4LXdpZHRoIiwgcmMuY3ggKTsKCQkJbWVudVNpemUgPSB7CgkJCQljeDogdGhpcy5fdWkuY29udGFpbmVyLm91dGVyV2lkdGgoIHRydWUgKSwKCQkJCWN5OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJIZWlnaHQoIHRydWUgKQoJCQl9OwoKCQkJLy8gQ2VudGVyIHRoZSBtZW51IG92ZXIgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMsIHdoaWxlIG5vdCBnb2luZyBvdXRzaWRlCgkJCS8vIHRoZSB3aW5kb3cgdG9sZXJhbmNlcy4gVGhpcyB3aWxsIGNlbnRlciB3cnQuIHRoZSB3aW5kb3cgaWYgdGhlIHBvcHVwIGlzIHRvbyBsYXJnZS4KCQkJcmV0ID0gewoJCQkJeDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJjLmN4LCBtZW51U2l6ZS5jeCwgcmMueCwgZGVzaXJlZC54ICksCgkJCQl5OiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmMuY3ksIG1lbnVTaXplLmN5LCByYy55LCBkZXNpcmVkLnkgKQoJCQl9OwoKCQkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCQlyZXQueSA9IE1hdGgubWF4KCAwLCByZXQueSApOwoKCQkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkJLy8gYWxpZ24gdGhlIGJvdHRvbSB3aXRoIHRoZSBib3R0b20gb2YgdGhlIGRvY3VtZW50CgoJCQkvLyBmaXggZm9yICQubW9iaWxlLmRvY3VtZW50LmhlaWdodCgpIGJ1ZyBpbiBjb3JlIDEuNy4yLgoJCQl2YXIgZG9jRWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGRvY0JvZHkgPSBkb2N1bWVudC5ib2R5LAoJCQkJZG9jSGVpZ2h0ID0gTWF0aC5tYXgoIGRvY0VsLmNsaWVudEhlaWdodCwgZG9jQm9keS5zY3JvbGxIZWlnaHQsIGRvY0JvZHkub2Zmc2V0SGVpZ2h0LCBkb2NFbC5zY3JvbGxIZWlnaHQsIGRvY0VsLm9mZnNldEhlaWdodCApOwoKCQkJcmV0LnkgLT0gTWF0aC5taW4oIHJldC55LCBNYXRoLm1heCggMCwgcmV0LnkgKyBtZW51U2l6ZS5jeSAtIGRvY0hlaWdodCApICk7CgoJCQlyZXR1cm4geyBsZWZ0OiByZXQueCwgdG9wOiByZXQueSB9OwoJCX0sCgoJCV9jcmVhdGVQcmVyZXFzOiBmdW5jdGlvbiggc2NyZWVuUHJlcmVxLCBjb250YWluZXJQcmVyZXEsIHdoZW5Eb25lICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsIHByZXJlcXM7CgoJCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxcyBhbmQgc2VsZi5fcHJlcmVxcy4gVGhlIGxvY2FsIHZhcmlhYmxlIHJlbWFpbnMgaW4KCQkJLy8gdGhlIGNsb3N1cmUgb2YgdGhlIGZ1bmN0aW9ucyB3aGljaCBjYWxsIHRoZSBjYWxsYmFja3MgcGFzc2VkIGluLiBUaGUgY29tcGFyaXNvbiBiZXR3ZWVuIHRoZSBsb2NhbCB2YXJpYWJsZSBhbmQKCQkJLy8gc2VsZi5fcHJlcmVxcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhIGZ1bmN0aW9uIGhhcyBiZWVuIHBhc3NlZCB0byAuYW5pbWF0aW9uQ29tcGxldGUoKSBpdCB3aWxsIGJlIGNhbGxlZAoJCQkvLyBuZXh0IHRpbWUgYW4gYW5pbWF0aW9uIGNvbXBsZXRlcywgZXZlbiBpZiB0aGF0J3Mgbm90IHRoZSBhbmltYXRpb24gd2hvc2UgZW5kIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2gKCQkJLy8gKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zIGR1cmluZyB0aGUgb3BlbmluZyBhbmltYXRpb24sIHRoZSAuYW5pbWF0aW9uQ29tcGxldGUgaGFuZGxlciBpcyBub3QgY2FsbGVkIGZvcgoJCQkvLyB0aGF0IGFuaW1hdGlvbiBhbnltb3JlLCBidXQgdGhlIGhhbmRsZXIgcmVtYWlucyBhdHRhY2hlZCwgc28gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZAoJCQkvLyAtIG1ha2luZyBpdCBzdGFsZS4gQ29tcGFyaW5nIHRoZSBsb2NhbCB2YXJpYWJsZSBwcmVyZXFzIHRvIHRoZSB3aWRnZXQtbGV2ZWwgdmFyaWFibGUgc2VsZi5fcHJlcmVxcyBlbnN1cmVzIHRoYXQKCQkJLy8gY2FsbGJhY2tzIHRyaWdnZXJlZCBieSBhIHN0YWxlIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCQlwcmVyZXFzID0gewoJCQkJc2NyZWVuOiAkLkRlZmVycmVkKCksCgkJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCQl9OwoKCQkJcHJlcmVxcy5zY3JlZW4udGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJc2NyZWVuUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJcHJlcmVxcy5jb250YWluZXIudGhlbiggZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHByZXJlcXMgPT09IHNlbGYuX3ByZXJlcXMgKSB7CgkJCQkJY29udGFpbmVyUHJlcmVxKCk7CgkJCQl9CgkJCX0pOwoKCQkJJC53aGVuKCBwcmVyZXFzLnNjcmVlbiwgcHJlcmVxcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJCWlmICggcHJlcmVxcyA9PT0gc2VsZi5fcHJlcmVxcyApIHsKCQkJCQlzZWxmLl9wcmVyZXFzID0gbnVsbDsKCQkJCQl3aGVuRG9uZSgpOwoJCQkJfQoJCQl9KTsKCgkJCXNlbGYuX3ByZXJlcXMgPSBwcmVyZXFzOwoJCX0sCgoJCV9hbmltYXRlOiBmdW5jdGlvbiggYXJncyApIHsKCQkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkJLy8gICAgICB0aGlzIGhhZCBhbiBhbmltYXRlIGNhbGxiYWNrIHRoYXQgd291bGQgcmVzb2x2ZSB0aGUgZGVmZXJyZWQKCQkJLy8gICAgICBub3cgdGhlIGRlZmVycmVkIGlzIHJlc29sdmVkIGltbWVkaWF0ZWx5CgkJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQkJdGhpcy5fdWkuc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApCgkJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQkJYXJncy5wcmVyZXFzLnNjcmVlbi5yZXNvbHZlKCk7CgoJCQlpZiAoIGFyZ3MudHJhbnNpdGlvbiAmJiBhcmdzLnRyYW5zaXRpb24gIT09ICJub25lIiApIHsKCQkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBhcmdzLnRyYW5zaXRpb24gKTsKCQkJCX0KCQkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoIGFyZ3MucHJlcmVxcy5jb250YWluZXIsICJyZXNvbHZlIiApICkKCQkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCQkucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoIGFyZ3MuY2xhc3NUb1JlbW92ZSApOwoJCQlhcmdzLnByZXJlcXMuY29udGFpbmVyLnJlc29sdmUoKTsKCQl9LAoKCQkvLyBUaGUgZGVzaXJlZCBjb29yZGluYXRlcyBwYXNzZWQgaW4gd2lsbCBiZSByZXR1cm5lZCB1bnRvdWNoZWQgaWYgbm8gcmVmZXJlbmNlIGVsZW1lbnQgY2FuIGJlIGlkZW50aWZpZWQgdmlhCgkJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCQkvLyB4IGFuZCB5IGNvb3JkaW5hdGVzIGJ5IHNwZWNpZnlpbmcgdGhlIGNlbnRlciBtaWRkbGUgb2YgdGhlIHdpbmRvdyBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIGFic2VudC4KCQkvLyBvcHRpb25zOiB7IHg6IGNvb3JkaW5hdGUsIHk6IGNvb3JkaW5hdGUsIHBvc2l0aW9uVG86IHN0cmluZzogIm9yaWdpbiIsICJ3aW5kb3ciLCBvciBqUXVlcnkgc2VsZWN0b3IKCQlfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG8gKSB7CgkJCXZhciBkc3QgPSBudWxsLCBvZmZzZXQsIHdpbkNvb3JkcyA9IHdpbmRvd0Nvb3JkcygpLCB4ID0gby54LCB5ID0gby55LCBwVG8gPSBvLnBvc2l0aW9uVG87CgoJCQkvLyBFc3RhYmxpc2ggd2hpY2ggZWxlbWVudCB3aWxsIHNlcnZlIGFzIHRoZSByZWZlcmVuY2UKCQkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJCWlmICggcFRvID09PSAid2luZG93IiApIHsKCQkJCQl4ID0gd2luQ29vcmRzLmN4IC8gMiArIHdpbkNvb3Jkcy54OwoJCQkJCXkgPSB3aW5Db29yZHMuY3kgLyAyICsgd2luQ29vcmRzLnk7CgkJCQl9IGVsc2UgewoJCQkJCXRyeSB7CgkJCQkJCWRzdCA9ICQoIHBUbyApOwoJCQkJCX0gY2F0Y2goIGUgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJCWlmICggZHN0ICkgewoJCQkJCQlkc3QuZmlsdGVyKCAiOnZpc2libGUiICk7CgkJCQkJCWlmICggZHN0Lmxlbmd0aCA9PT0gMCApIHsKCQkJCQkJCWRzdCA9IG51bGw7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIElmIGFuIGVsZW1lbnQgd2FzIGZvdW5kLCBjZW50ZXIgb3ZlciBpdAoJCQlpZiAoIGRzdCApIHsKCQkJCW9mZnNldCA9IGRzdC5vZmZzZXQoKTsKCQkJCXggPSBvZmZzZXQubGVmdCArIGRzdC5vdXRlcldpZHRoKCkgLyAyOwoJCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJCX0KCgkJCS8vIE1ha2Ugc3VyZSB4IGFuZCB5IGFyZSB2YWxpZCBudW1iZXJzIC0gY2VudGVyIG92ZXIgdGhlIHdpbmRvdwoJCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQkJeCA9IHdpbkNvb3Jkcy5jeCAvIDIgKyB3aW5Db29yZHMueDsKCQkJfQoJCQlpZiAoICQudHlwZSggeSApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeSApICkgewoJCQkJeSA9IHdpbkNvb3Jkcy5jeSAvIDIgKyB3aW5Db29yZHMueTsKCQkJfQoKCQkJcmV0dXJuIHsgeDogeCwgeTogeSB9OwoJCX0sCgoJCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggbyApIHsKCQkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCQlvID0geyB4OiBvLngsIHk6IG8ueSwgcG9zaXRpb25Ubzogby5wb3NpdGlvblRvIH07CgkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVwb3NpdGlvbiIsIG8gKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvICkgKSApOwoJCX0sCgoJCXJlcG9zaXRpb246IGZ1bmN0aW9uKCBvICkgewoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCQkJfQoJCX0sCgoJCV9vcGVuUHJlcmVxc0NvbXBsZXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyLmFkZENsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLmF0dHIoICJ0YWJpbmRleCIsICIwIiApLmZvY3VzKCk7CgkJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJCX0sCgoJCV9vcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIG8gPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApLAoJCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQkJYW5kcm9pZEJsYWNrbGlzdCA9ICggZnVuY3Rpb24oKSB7CgkJCQkJdmFyIHcgPSB3aW5kb3csCgkJCQkJCXVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XC5dKykvICksCgkJCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQkJYW5kdmVyc2lvbiA9ICEhYW5kcm9pZG1hdGNoICYmIGFuZHJvaWRtYXRjaFsgMSBdLAoJCQkJCQljaHJvbWVtYXRjaCA9IHVhLmluZGV4T2YoICJDaHJvbWUiICkgPiAtMTsKCgkJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCQlpZiggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCQl9CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSgpKTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcm9wZW4iIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5ub29wLAoJCQkJJC5ub29wLAoJCQkJJC5wcm94eSggdGhpcywgIl9vcGVuUHJlcmVxc0NvbXBsZXRlIiApICk7CgoJCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG8udHJhbnNpdGlvbjsKCQkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvLnRyYW5zaXRpb24gKTsKCgkJCWlmICggIXRoaXMub3B0aW9ucy50aGVtZSApIHsKCQkJCXRoaXMuX3NldFRoZW1lKCB0aGlzLl9wYWdlLmpxbURhdGEoICJ0aGVtZSIgKSB8fCAkLm1vYmlsZS5nZXRJbmhlcml0ZWRUaGVtZSggdGhpcy5fcGFnZSwgImMiICkgKTsKCQkJfQoKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApOwoKCQkJLy8gR2l2ZSBhcHBsaWNhdGlvbnMgYSBjaGFuY2UgdG8gbW9kaWZ5IHRoZSBjb250ZW50cyBvZiB0aGUgY29udGFpbmVyIGJlZm9yZSBpdCBhcHBlYXJzCgkJCXRoaXMuX3JlcG9zaXRpb24oIG8gKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSAmJiBhbmRyb2lkQmxhY2tsaXN0ICkgewoJCQkJLyogVE9ETzoKCQkJCVRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkCgkJCQlhYm92ZSB0aGUgcG9wdXAgaXRzZWxmIHdoZW4gY2VydGFpbiBvdGhlciBzdHlsZXMgZXhpc3Qgb24gdGhlIHNhbWUgcGFnZSAtLSBuYW1lbHksIGFueSBlbGVtZW50IHNldCB0byBgcG9zaXRpb246IGZpeGVkYCBhbmQgY2VydGFpbgoJCQkJdHlwZXMgb2YgaW5wdXQuIFRoZXNlIGlzc3VlcyBhcmUgcmVtaW5pc2NlbnQgb2YgcHJldmlvdXNseSB1bmNvdmVyZWQgYnVncyBpbiBvbGRlciB2ZXJzaW9ucyBvZiBBbmRyb2lkJ3MgbmF0aXZlIGJyb3dzZXI6CgkJCQlodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgoJCQkJVGhpcyBmaXggY2xvc2VzIHRoZSBmb2xsb3dpbmcgYnVncyAoIEkgdXNlICJjbG9zZXMiIHdpdGggcmVsdWN0YW5jZSwgYW5kIHN0cmVzcyB0aGF0IHRoaXMgaXNzdWUgc2hvdWxkIGJlIHJldmlzaXRlZCBhcyBzb29uIGFzIHBvc3NpYmxlICk6CgoJCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODE2CgkJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4NDQKCQkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkJKi8KCgkJCQkvLyBUT0RPIHNvcnQgb3V0IHdoeSB0aGlzLl9wYWdlIGlzbid0IHdvcmtpbmcKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCQl9CgkJCXRoaXMuX2FuaW1hdGUoewoJCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJCXRyYW5zaXRpb246IG8udHJhbnNpdGlvbiwKCQkJCWNsYXNzVG9SZW1vdmU6ICIiLAoJCQkJc2NyZWVuQ2xhc3NUb0FkZDogImluIiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCQlhcHBseVRyYW5zaXRpb246IGZhbHNlLAoJCQkJcHJlcmVxczogdGhpcy5fcHJlcmVxcwoJCQl9KTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFTY3JlZW46IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5zY3JlZW4KCQkJCS5yZW1vdmVDbGFzcyggIm91dCIgKQoJCQkJLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9LAoKCQlfY2xvc2VQcmVyZXFDb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl91aS5jb250YWluZXIKCQkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4iICkKCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJfSwKCgkJX2Nsb3NlUHJlcmVxc0RvbmU6IGZ1bmN0aW9uKCkgewoJCQl2YXIgb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVBdHRyKCAidGFiaW5kZXgiICk7CgoJCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJCSQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9IHVuZGVmaW5lZDsKCgkJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJjbG9zZSIgKTsKCQl9LAoKCQlfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLW9wZW4iICk7CgoJCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJCS8vIENvdW50IGRvd24gdG8gdHJpZ2dlcmluZyAicG9wdXBhZnRlcmNsb3NlIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJCS8vIDEuIFRoZSBwb3B1cCB3aW5kb3cgcmV2ZXJzZSBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCQl0aGlzLl9jcmVhdGVQcmVyZXFzKAoJCQkJJC5wcm94eSggdGhpcywgIl9jbG9zZVByZXJlcVNjcmVlbiIgKSwKCQkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXFDb250YWluZXIiICksCgkJCQkkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUHJlcmVxc0RvbmUiICkgKTsKCgkJCXRoaXMuX2FuaW1hdGUoIHsKCQkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQkJdHJhbnNpdGlvbjogKCBpbW1lZGlhdGUgPyAibm9uZSIgOiAoIHRoaXMuX2N1cnJlbnRUcmFuc2l0aW9uICkgKSwKCQkJCWNsYXNzVG9SZW1vdmU6ICJpbiIsCgkJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJyZXZlcnNlIG91dCIsCgkJCQlhcHBseVRyYW5zaXRpb246IHRydWUsCgkJCQlwcmVyZXFzOiB0aGlzLl9wcmVyZXFzCgkJCX0pOwoJCX0sCgoJCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQkJdGhpcy5fc2V0VGhlbWUoICJub25lIiApOwoJCQl0aGlzLmVsZW1lbnQKCQkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkJLy8gaW5zZXJ0QWZ0ZXIoKSB3aWxsIGRvIG5vdGhpbmcgaWYgdGhlIHBheWxvYWQgZGl2IHdhcyBub3QgYXR0YWNoZWQKCQkJCS8vIHRvIHRoZSBET00gYXQgdGhlIHRpbWUgdGhlIHdpZGdldCB3YXMgY3JlYXRlZCwgYW5kIHNvIHRoZSBwYXlsb2FkCgkJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJCS8vIElmIHRoYXQgaGFwcGVucyBhbmQgd2UgcmVtb3ZlIHRoZSBjb250YWluZXIgYSBmZXcgbGluZXMgYmVsb3csIHdlCgkJCQkvLyB3aWxsIGNhdXNlIGFuIGluZmluaXRlIHJlY3Vyc2lvbiAtICM1MjQ0CgkJCQkuZGV0YWNoKCkKCQkJCS5pbnNlcnRBZnRlciggdGhpcy5fdWkucGxhY2Vob2xkZXIgKQoJCQkJLnJlbW92ZUNsYXNzKCAidWktcG9wdXAgdWktb3ZlcmxheS1zaGFkb3cgdWktY29ybmVyLWFsbCIgKTsKCQkJdGhpcy5fdWkuc2NyZWVuLnJlbW92ZSgpOwoJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJCXRoaXMuX3VpLnBsYWNlaG9sZGVyLnJlbW92ZSgpOwoJCX0sCgoJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPT09IHRoaXMgKSB7CgkJCQl0aGlzLmVsZW1lbnQub25lKCAicG9wdXBhZnRlcmNsb3NlIiwgJC5wcm94eSggdGhpcywgIl91bmVuaGFuY2UiICkgKTsKCQkJCXRoaXMuY2xvc2UoKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuX3VuZW5oYW5jZSgpOwoJCQl9CgkJfSwKCgkJX2Nsb3NlUG9wdXA6IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoJCQl2YXIgcGFyc2VkRHN0LCB0b1VybCwgbyA9IHRoaXMub3B0aW9ucywgaW1tZWRpYXRlID0gZmFsc2U7CgoJCQkvLyByZXN0b3JlIGxvY2F0aW9uIG9uIHNjcmVlbgoJCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQkJaWYgKCBlICYmIGUudHlwZSA9PT0gInBhZ2ViZWZvcmVjaGFuZ2UiICYmIGRhdGEgKSB7CgkJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJCS8vIHRha2UgdGhlIHRpbWUgdG8gcnVuIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24KCQkJCWlmICggdHlwZW9mIGRhdGEudG9QYWdlID09PSAic3RyaW5nIiApIHsKCQkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJCX0gZWxzZSB7CgkJCQkJcGFyc2VkRHN0ID0gZGF0YS50b1BhZ2UuanFtRGF0YSggInVybCIgKTsKCQkJCX0KCQkJCXBhcnNlZERzdCA9ICQubW9iaWxlLnBhdGgucGFyc2VVcmwoIHBhcnNlZERzdCApOwoJCQkJdG9VcmwgPSBwYXJzZWREc3QucGF0aG5hbWUgKyBwYXJzZWREc3Quc2VhcmNoICsgcGFyc2VkRHN0Lmhhc2g7CgoJCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkJLy8gR29pbmcgdG8gYSBkaWZmZXJlbnQgcGFnZSAtIGNsb3NlIGltbWVkaWF0ZWx5CgkJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfQoJCQl9CgoJCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJCW8uY29udGFpbmVyLnVuYmluZCggby5jbG9zZUV2ZW50cyApOwoJCQkvLyB1bmJpbmQgY2xpY2sgaGFuZGxlcnMgYWRkZWQgd2hlbiBoaXN0b3J5IGlzIGRpc2FibGVkCgkJCXRoaXMuZWxlbWVudC51bmRlbGVnYXRlKCBvLmNsb3NlTGlua1NlbGVjdG9yLCBvLmNsb3NlTGlua0V2ZW50cyApOwoKCQkJdGhpcy5fY2xvc2UoIGltbWVkaWF0ZSApOwoJCX0sCgoJCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCQkvLyBOT1RFIHRoZSBwYWdlYmVmb3JlY2hhbmdlIGlzIGJvdW5kIHRvIGNhdGNoIG5hdmlnYXRpb24gZXZlbnRzIHRoYXQgZG9uJ3QKCQkvLyAgICAgIGFsdGVyIHRoZSB1cmwgKGVnLCBkaWFsb2dzIGZyb20gcG9wdXBzKQoJCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLm9wdGlvbnMuY29udGFpbmVyCgkJCQkub25lKCB0aGlzLm9wdGlvbnMuY2xvc2VFdmVudHMsICQucHJveHkoIHRoaXMsICJfY2xvc2VQb3B1cCIgKSApOwoJCX0sCgoJCS8vIFRPRE8gbm8gY2xlYXIgZGVsaW5pYXRpb24gb2Ygd2hhdCBzaG91bGQgYmUgaGVyZSBhbmQKCQkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCQlvcGVuOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJdmFyIHNlbGYgPSB0aGlzLCBvcHRzID0gdGhpcy5vcHRpb25zLCB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeTsKCgkJCS8vIG1ha2Ugc3VyZSBvcGVuIGlzIGlkZW1wb3RlbnQKCQkJaWYoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdGhpczsKCQkJdGhpcy5fc2Nyb2xsVG9wID0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpOwoKCQkJLy8gaWYgaGlzdG9yeSBhbHRlcmF0aW9uIGlzIGRpc2FibGVkIGNsb3NlIG9uIG5hdmlnYXRlIGV2ZW50cwoJCQkvLyBhbmQgbGVhdmUgdGhlIHVybCBhcyBpcwoJCQlpZiggISggb3B0cy5oaXN0b3J5ICkgKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCQkvLyBXaGVuIGhpc3RveSBpcyBkaXNhYmxlZCB3ZSBoYXZlIHRvIGdyYWIgdGhlIGRhdGEtcmVsCgkJCQkvLyBiYWNrIGxpbmsgY2xpY2tzIHNvIHdlIGNhbiBjbG9zZSB0aGUgcG9wdXAgaW5zdGVhZCBvZgoJCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQkJc2VsZi5lbGVtZW50CgkJCQkJLmRlbGVnYXRlKCBvcHRzLmNsb3NlTGlua1NlbGVjdG9yLCBvcHRzLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIGUgKSB7CgkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0pOwoKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gY2FjaGUgc29tZSB2YWx1ZXMgZm9yIG1pbi9yZWFkYWJpbGl0eQoJCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUudXJsSGlzdG9yeTsKCQkJaGFzaGtleSA9ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCWFjdGl2ZVBhZ2UgPSAkLm1vYmlsZS5hY3RpdmVQYWdlOwoJCQljdXJyZW50SXNEaWFsb2cgPSBhY3RpdmVQYWdlLmlzKCAiLnVpLWRpYWxvZyIgKTsKCQkJdGhpcy5fbXlVcmwgPSB1cmwgPSB1cmxIaXN0b3J5LmdldEFjdGl2ZSgpLnVybDsKCQkJaGFzSGFzaCA9ICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA+IC0xICkgJiYgIWN1cnJlbnRJc0RpYWxvZyAmJiAoIHVybEhpc3RvcnkuYWN0aXZlSW5kZXggPiAwICk7CgoJCQlpZiAoIGhhc0hhc2ggKSB7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkJLy8gb3RoZXJ3aXNlLCBpZiB0aGUgcGFnZSBpcyBhIGRpYWxvZyBzaW1wbHkgdGFjayBvbiB0aGUgaGFzaCBrZXkKCQkJaWYgKCB1cmwuaW5kZXhPZiggaGFzaGtleSApID09PSAtMSAmJiAhY3VycmVudElzRGlhbG9nICl7CgkJCQl1cmwgPSB1cmwgKyAodXJsLmluZGV4T2YoICIjIiApID4gLTEgPyBoYXNoa2V5IDogIiMiICsgaGFzaGtleSk7CgkJCX0gZWxzZSB7CgkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoICsgaGFzaGtleTsKCQkJfQoKCQkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJCWlmICggdXJsSGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09IHVybEhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCXVybCArPSBoYXNoa2V5OwoJCQl9CgoJCQkvLyBzd2FsbG93IHRoZSB0aGUgaW5pdGlhbCBuYXZpZ2F0aW9uIGV2ZW50LCBhbmQgYmluZCBmb3IgdGhlIG5leHQKCQkJJCh3aW5kb3cpLm9uZSggImJlZm9yZW5hdmlnYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCQkJfSk7CgoJCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCQkkLm1vYmlsZS5uYXZpZ2F0ZSggdXJsLCB7cm9sZTogImRpYWxvZyJ9ICk7CgkJfSwKCgkJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCQkvLyBtYWtlIHN1cmUgY2xvc2UgaXMgaWRlbXBvdGVudAoJCQlpZiggJC5tb2JpbGUucG9wdXAuYWN0aXZlICE9PSB0aGlzICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9zY3JvbGxUb3AgPSAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCQlpZiggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJdGhpcy51cmxBbHRlcmVkID0gZmFsc2U7CgkJCX0gZWxzZSB7CgkJCQkvLyBzaW11bGF0ZSB0aGUgbmF2IGJpbmRpbmdzIGhhdmluZyBmaXJlZAoJCQkJdGhpcy5fY2xvc2VQb3B1cCgpOwoJCQl9CgkJfQoJfSk7CgoKCS8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKCSQubW9iaWxlLnBvcHVwLmhhbmRsZUxpbmsgPSBmdW5jdGlvbiggJGxpbmsgKSB7CgkJdmFyIGNsb3Nlc3RQYWdlID0gJGxpbmsuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSIgKSwKCQkJc2NvcGUgPSAoICggY2xvc2VzdFBhZ2UubGVuZ3RoID09PSAwICkgPyAkKCAiYm9keSIgKSA6IGNsb3Nlc3RQYWdlICksCgkJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoLCBpZTcgKHdwNykgcmV0dXJuIHRoZSBhYnNvbHV0ZSBocmVmCgkJCS8vICAgICAgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJCXBvcHVwID0gJCggJC5tb2JpbGUucGF0aC5wYXJzZVVybCgkbGluay5hdHRyKCAiaHJlZiIgKSkuaGFzaCwgc2NvcGVbMF0gKSwKCQkJb2Zmc2V0OwoKCQlpZiAoIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJCW9mZnNldCA9ICRsaW5rLm9mZnNldCgpOwoJCQlwb3B1cC5wb3B1cCggIm9wZW4iLCB7CgkJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCQl5OiBvZmZzZXQudG9wICsgJGxpbmsub3V0ZXJIZWlnaHQoKSAvIDIsCgkJCQl0cmFuc2l0aW9uOiAkbGluay5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCQl9KTsKCQl9CgoJCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CgkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCS8vIENoZWNrIGlmIHdlIGFyZSBpbiBhIGxpc3R2aWV3CgkJCXZhciAkcGFyZW50ID0gJGxpbmsucGFyZW50KCkucGFyZW50KCk7CgkJCWlmICgkcGFyZW50Lmhhc0NsYXNzKCJ1aS1saSIpKSB7CgkJCQkkbGluayA9ICRwYXJlbnQucGFyZW50KCk7CgkJCX0KCQkJJGxpbmsucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJfSwgMzAwICk7Cgl9OwoKCS8vIFRPRE8gbW92ZSBpbnNpZGUgX2NyZWF0ZQoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2ViZWZvcmVjaGFuZ2UiLCBmdW5jdGlvbiggZSwgZGF0YSApIHsKCQlpZiAoIGRhdGEub3B0aW9ucy5yb2xlID09PSAicG9wdXAiICkgewoJCQkkLm1vYmlsZS5wb3B1cC5oYW5kbGVMaW5rKCBkYXRhLm9wdGlvbnMubGluayApOwoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfQoJfSk7CgoJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSAgewoJCSQubW9iaWxlLnBvcHVwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJfSk7Cgp9KSggalF1ZXJ5ICk7CgovKgoqIGN1c3RvbSAic2VsZWN0bWVudSIgcGx1Z2luCiovCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciBleHRlbmRTZWxlY3QgPSBmdW5jdGlvbiggd2lkZ2V0ICkgewoKCQl2YXIgc2VsZWN0ID0gd2lkZ2V0LnNlbGVjdCwKCQkJb3JpZ0Rlc3Ryb3kgPSB3aWRnZXQuX2Rlc3Ryb3ksCgkJCXNlbGVjdElEICA9IHdpZGdldC5zZWxlY3RJRCwKCQkJcHJlZml4ID0gKCBzZWxlY3RJRCA/IHNlbGVjdElEIDogKCAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAidXVpZC0iICsgd2lkZ2V0LnV1aWQgKSApLAoJCQlwb3B1cElEID0gcHJlZml4ICsgIi1saXN0Ym94IiwKCQkJZGlhbG9nSUQgPSBwcmVmaXggKyAiLWRpYWxvZyIsCgkJCWxhYmVsID0gd2lkZ2V0LmxhYmVsLAoJCQl0aGlzUGFnZSA9IHdpZGdldC5zZWxlY3QuY2xvc2VzdCggIi51aS1wYWdlIiApLAoJCQlzZWxlY3RPcHRpb25zID0gd2lkZ2V0Ll9zZWxlY3RPcHRpb25zKCksCgkJCWlzTXVsdGlwbGUgPSB3aWRnZXQuaXNNdWx0aXBsZSA9IHdpZGdldC5zZWxlY3RbIDAgXS5tdWx0aXBsZSwKCQkJYnV0dG9uSWQgPSBzZWxlY3RJRCArICItYnV0dG9uIiwKCQkJbWVudUlkID0gc2VsZWN0SUQgKyAiLW1lbnUiLAoJCQltZW51UGFnZSA9ICQoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2RpYWxvZycgaWQ9JyIgKyBkaWFsb2dJRCArICInIGRhdGEtIiArJC5tb2JpbGUubnMgKyAidGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLnRoZW1lICsiJyBkYXRhLSIgKyQubW9iaWxlLm5zICsgIm92ZXJsYXktdGhlbWU9JyIrIHdpZGdldC5vcHRpb25zLm92ZXJsYXlUaGVtZSArIic+IiArCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdoZWFkZXInPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXRpdGxlJz4iICsgbGFiZWwuZ2V0RW5jb2RlZFRleHQoKSArICI8L2Rpdj4iKwoJCQkJIjwvZGl2PiIrCgkJCQkiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdjb250ZW50Jz48L2Rpdj4iKwoJCQkJIjwvZGl2PiIgKSwKCgkJCWxpc3Rib3ggPSAgJCggIjxkaXYgaWQ9JyIgKyBwb3B1cElEICsgIicgY2xhc3M9J3VpLXNlbGVjdG1lbnUnPiIgKS5pbnNlcnRBZnRlciggd2lkZ2V0LnNlbGVjdCApLnBvcHVwKCB7IHRoZW1lOiB3aWRnZXQub3B0aW9ucy5vdmVybGF5VGhlbWUgfSApLAoKCQkJbGlzdCA9ICQoICI8dWw+IiwgewoJCQkJImNsYXNzIjogInVpLXNlbGVjdG1lbnUtbGlzdCIsCgkJCQkiaWQiOiBtZW51SWQsCgkJCQkicm9sZSI6ICJsaXN0Ym94IiwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBidXR0b25JZAoJCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInRoZW1lIiwgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGl2aWRlci10aGVtZSIsIHdpZGdldC5vcHRpb25zLmRpdmlkZXJUaGVtZSApCgkJCQkJLmFwcGVuZFRvKCBsaXN0Ym94ICksCgoKCQkJaGVhZGVyID0gJCggIjxkaXY+IiwgewoJCQkJImNsYXNzIjogInVpLWhlYWRlciB1aS1iYXItIiArIHdpZGdldC5vcHRpb25zLnRoZW1lCgkJCX0pLnByZXBlbmRUbyggbGlzdGJveCApLAoKCQkJaGVhZGVyVGl0bGUgPSAkKCAiPGgxPiIsIHsKCQkJCSJjbGFzcyI6ICJ1aS10aXRsZSIKCQkJfSkuYXBwZW5kVG8oIGhlYWRlciApLAoKCQkJbWVudVBhZ2VDb250ZW50LAoJCQltZW51UGFnZUNsb3NlLAoJCQloZWFkZXJDbG9zZTsKCgkJaWYgKCB3aWRnZXQuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInRleHQiOiB3aWRnZXQub3B0aW9ucy5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4tbGVmdCIKCQkJfSkuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiLCAibm90ZXh0IiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJpY29uIiwgImRlbGV0ZSIgKS5hcHBlbmRUbyggaGVhZGVyICkuYnV0dG9uTWFya3VwKCk7CgkJfQoKCQkkLmV4dGVuZCggd2lkZ2V0LCB7CgkJCXNlbGVjdDogd2lkZ2V0LnNlbGVjdCwKCQkJc2VsZWN0SUQ6IHNlbGVjdElELAoJCQlidXR0b25JZDogYnV0dG9uSWQsCgkJCW1lbnVJZDogbWVudUlkLAoJCQlwb3B1cElEOiBwb3B1cElELAoJCQlkaWFsb2dJRDogZGlhbG9nSUQsCgkJCXRoaXNQYWdlOiB0aGlzUGFnZSwKCQkJbWVudVBhZ2U6IG1lbnVQYWdlLAoJCQlsYWJlbDogbGFiZWwsCgkJCXNlbGVjdE9wdGlvbnM6IHNlbGVjdE9wdGlvbnMsCgkJCWlzTXVsdGlwbGU6IGlzTXVsdGlwbGUsCgkJCXRoZW1lOiB3aWRnZXQub3B0aW9ucy50aGVtZSwKCQkJbGlzdGJveDogbGlzdGJveCwKCQkJbGlzdDogbGlzdCwKCQkJaGVhZGVyOiBoZWFkZXIsCgkJCWhlYWRlclRpdGxlOiBoZWFkZXJUaXRsZSwKCQkJaGVhZGVyQ2xvc2U6IGhlYWRlckNsb3NlLAoJCQltZW51UGFnZUNvbnRlbnQ6IG1lbnVQYWdlQ29udGVudCwKCQkJbWVudVBhZ2VDbG9zZTogbWVudVBhZ2VDbG9zZSwKCQkJcGxhY2Vob2xkZXI6ICIiLAoKCQkJYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCS8vIENyZWF0ZSBsaXN0IGZyb20gc2VsZWN0LCB1cGRhdGUgc3RhdGUKCQkJCXNlbGYucmVmcmVzaCgpOwoKCQkJCWlmICggc2VsZi5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCQkJLy8gTWFwIHVuZGVmaW5lZCB0byBmYWxzZSwgYmVjYXVzZSBzZWxmLl9vcmlnVGFiSW5kZXggPT09IHVuZGVmaW5lZAoJCQkJCS8vIGluZGljYXRlcyB0aGF0IHdlIGhhdmUgbm90IHlldCBjaGVja2VkIHdoZXRoZXIgdGhlIHNlbGVjdCBoYXMKCQkJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkJCS8vIHdlIGhhdmUgY2hlY2tlZCB0aGUgc2VsZWN0IGZvciBzdWNoIGFuIGF0dHJpYnV0ZSwgYW5kIGhhdmUgZm91bmQKCQkJCQkvLyBub25lIHByZXNlbnQuCgkJCQkJc2VsZi5fb3JpZ1RhYkluZGV4ID0gKCBzZWxmLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQkJCX0KCQkJCXNlbGYuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCQkkKCB0aGlzICkuYmx1cigpOwoJCQkJCXNlbGYuYnV0dG9uLmZvY3VzKCk7CgkJCQl9KTsKCgkJCQkvLyBCdXR0b24gZXZlbnRzCgkJCQlzZWxmLmJ1dHRvbi5iaW5kKCAidmNsaWNrIGtleWRvd24iICwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCWlmICggc2VsZi5vcHRpb25zLmRpc2FibGVkIHx8IHNlbGYuaXNPcGVuICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlpZiAoZXZlbnQudHlwZSA9PT0gInZjbGljayIgfHwKCQkJCQkJCWV2ZW50LmtleUNvZGUgJiYgKGV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuRU5URVIgfHwKCQkJCQkJCQkJCQkJCQkJCWV2ZW50LmtleUNvZGUgPT09ICQubW9iaWxlLmtleUNvZGUuU1BBQ0UpKSB7CgoJCQkJCQlzZWxmLl9kZWNpZGVGb3JtYXQoKTsKCQkJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmJ1dHRvbi5hdHRyKCAiaHJlZiIsICIjIiArIHNlbGYucG9wdXBJRCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgInBvcHVwIiApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJc2VsZi5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyBzZWxmLmRpYWxvZ0lEICkuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJyZWwiLCAiZGlhbG9nIiApOwoJCQkJCQl9CgkJCQkJCXNlbGYuaXNPcGVuID0gdHJ1ZTsKCQkJCQkJLy8gRG8gbm90IHByZXZlbnQgZGVmYXVsdCwgc28gdGhlIG5hdmlnYXRpb24gbWF5IGhhdmUgYSBjaGFuY2UgdG8gYWN0dWFsbHkgb3BlbiB0aGUgY2hvc2VuIGZvcm1hdAoJCQkJCX0KCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBmb3IgbGlzdCBpdGVtcwoJCQkJc2VsZi5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICkKCQkJCQkuYmluZCggImZvY3VzaW4iLCBmdW5jdGlvbiggZSApIHsKCQkJCQkJJCggZS50YXJnZXQgKQoJCQkJCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW92ZXIiICk7CgoJCQkJCX0pCgkJCQkJLmJpbmQoICJmb2N1c291dCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJCQkkKCBlLnRhcmdldCApCgkJCQkJCQkuYXR0ciggInRhYmluZGV4IiwgIi0xIiApCgkJCQkJCQkudHJpZ2dlciggInZtb3VzZW91dCIgKTsKCQkJCQl9KQoJCQkJCS5kZWxlZ2F0ZSggImxpOm5vdCgudWktZGlzYWJsZWQsIC51aS1saS1kaXZpZGVyKSIsICJjbGljayIsIGZ1bmN0aW9uKCBldmVudCApIHsKCgkJCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCQkJdmFyIG9sZEluZGV4ID0gc2VsZi5zZWxlY3RbIDAgXS5zZWxlY3RlZEluZGV4LAoJCQkJCQkJbmV3SW5kZXggPSBzZWxmLmxpc3QuZmluZCggImxpOm5vdCgudWktbGktZGl2aWRlcikiICkuaW5kZXgoIHRoaXMgKSwKCQkJCQkJCW9wdGlvbiA9IHNlbGYuX3NlbGVjdE9wdGlvbnMoKS5lcSggbmV3SW5kZXggKVsgMCBdOwoKCQkJCQkJLy8gdG9nZ2xlIHNlbGVjdGVkIHN0YXR1cyBvbiB0aGUgdGFnIGZvciBtdWx0aSBzZWxlY3RzCgkJCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCQkJLy8gdG9nZ2xlIGNoZWNrYm94IGNsYXNzIGZvciBtdWx0aXBsZSBzZWxlY3RzCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJJCggdGhpcyApLmZpbmQoICIudWktaWNvbiIgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb24iLCBvcHRpb24uc2VsZWN0ZWQgKQoJCQkJCQkJCS50b2dnbGVDbGFzcyggInVpLWljb24tY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJCQl9CgoJCQkJCQkvLyB0cmlnZ2VyIGNoYW5nZSBpZiB2YWx1ZSBjaGFuZ2VkCgkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQkJCXNlbGYuc2VsZWN0LnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCQkJCX0KCgkJCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCQkJLy8gV2UgbmVlZCB0byBncmFiIHRoZSBjbGlja2VkIGl0ZW0gdGhlIGhhcmQgd2F5LCBiZWNhdXNlIHRoZSBsaXN0IG1heSBoYXZlIGJlZW4gcmVidWlsdAoJCQkJCQlpZiAoIHNlbGYuaXNNdWx0aXBsZSApIHsKCQkJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkJCS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApLmZpbmQoICJhIiApLmZpcnN0KCkuZm9jdXMoKTsKCQkJCQkJfQoJCQkJCQllbHNlIHsKCQkJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQkJfQoKCQkJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCQl9KQoJCQkJCS5rZXlkb3duKGZ1bmN0aW9uKCBldmVudCApIHsgIC8va2V5Ym9hcmQgZXZlbnRzIGZvciBtZW51IGl0ZW1zCgkJCQkJCXZhciB0YXJnZXQgPSAkKCBldmVudC50YXJnZXQgKSwKCQkJCQkJCWxpID0gdGFyZ2V0LmNsb3Nlc3QoICJsaSIgKSwKCQkJCQkJCXByZXYsIG5leHQ7CgoJCQkJCQkvLyBzd2l0Y2ggbG9naWMgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJCQkJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCQkJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQkJCQkJY2FzZSAzODoKCQkJCQkJCXByZXYgPSBsaS5wcmV2KCkubm90KCAiLnVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgoJCQkJCQkJaWYgKCBwcmV2LmlzKCAiLnVpLWxpLWRpdmlkZXIiICkgKSB7CgkJCQkJCQkJcHJldiA9IHByZXYucHJldigpOwoJCQkJCQkJfQoKCQkJCQkJCS8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cyBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIHByZXYubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCXByZXYuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gZG93biBvciByaWdodCBhcnJvdyBrZXlzCgkJCQkJCWNhc2UgNDA6CgkJCQkJCQluZXh0ID0gbGkubmV4dCgpOwoKCQkJCQkJCWlmICggbmV4dC5pcyggIi51aS1saS1kaXZpZGVyIiApICkgewoJCQkJCQkJCW5leHQgPSBuZXh0Lm5leHQoKTsKCQkJCQkJCX0KCgkJCQkJCQkvLyBpZiB0aGVyZSdzIGEgbmV4dCBvcHRpb24sIGZvY3VzIGl0CgkJCQkJCQlpZiAoIG5leHQubGVuZ3RoICkgewoJCQkJCQkJCXRhcmdldAoJCQkJCQkJCQkuYmx1cigpCgkJCQkJCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQkJCQkJCW5leHQuYWRkQ2xhc3MoICJ1aS1idG4tZG93bi0iICsgd2lkZ2V0Lm9wdGlvbnMudGhlbWUgKS5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJCQkJCQl9CgoJCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCQkJLy8gSWYgZW50ZXIgb3Igc3BhY2UgaXMgcHJlc3NlZCwgdHJpZ2dlciBjbGljawoJCQkJCQljYXNlIDEzOgoJCQkJCQljYXNlIDMyOgoJCQkJCQkJdGFyZ2V0LnRyaWdnZXIoICJjbGljayIgKTsKCgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCgkJCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkJCS8vIGJ5IHJlbW92aW5nIHRoZSBpbmxpbmUgc3R5bGUgYW5kIGVuc3VyaW5nIHBhZ2UgaW5jbHVzaW9uCgkJCQlzZWxmLm1lbnVQYWdlLmJpbmQoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCS8vIFRPRE8gY2VudHJhbGl6ZSBwYWdlIHJlbW92YWwgYmluZGluZyAvIGhhbmRsaW5nIGluIHRoZSBwYWdlIHBsdWdpbi4KCQkJCQkvLyBTdWdnZXN0aW9uIGZyb20gQGpibGFzIHRvIGRvIHJlZmNvdW50aW5nCgkJCQkJLy8KCQkJCQkvLyBUT0RPIGV4dHJlbWVseSBjb25mdXNpbmcgZGVwZW5kZW5jeSBvbiB0aGUgb3BlbiBtZXRob2Qgd2hlcmUgdGhlIHBhZ2VoaWRlLnJlbW92ZQoJCQkJCS8vIGJpbmRpbmdzIGFyZSBzdHJpcHBlZCB0byBwcmV2ZW50IHRoZSBwYXJlbnQgcGFnZSBmcm9tIGRpc2FwcGVhcmluZy4gVGhlIHdheQoJCQkJCS8vIHdlJ3JlIGtlZXBpbmcgcGFnZXMgaW4gdGhlIERPTSByaWdodCBub3cgc3Vja3MKCQkJCQkvLwoJCQkJCS8vIHJlYmluZCB0aGUgcGFnZSByZW1vdmUgdGhhdCB3YXMgdW5ib3VuZCBpbiB0aGUgb3BlbiBmdW5jdGlvbgoJCQkJCS8vIHRvIGFsbG93IGZvciB0aGUgcGFyZW50IHBhZ2UgcmVtb3ZhbCBmcm9tIGFjdGlvbnMgb3RoZXIgdGhhbiB0aGUgdXNlCgkJCQkJLy8gb2YgYSBkaWFsb2cgc2l6ZWQgY3VzdG9tIHNlbGVjdAoJCQkJCS8vCgkJCQkJLy8gZG9pbmcgdGhpcyBoZXJlIHByb3ZpZGVzIGZvciB0aGUgYmFjayBidXR0b24gb24gdGhlIGN1c3RvbSBzZWxlY3QgZGlhbG9nCgkJCQkJJC5tb2JpbGUuX2JpbmRQYWdlUmVtb3ZlLmNhbGwoIHNlbGYudGhpc1BhZ2UgKTsKCQkJCX0pOwoKCQkJCS8vIEV2ZW50cyBvbiB0aGUgcG9wdXAKCQkJCXNlbGYubGlzdGJveC5iaW5kKCAicG9wdXBhZnRlcmNsb3NlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0pOwoKCQkJCS8vIENsb3NlIGJ1dHRvbiBvbiBzbWFsbCBvdmVybGF5cwoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJc2VsZi5oZWFkZXJDbG9zZS5jbGljayhmdW5jdGlvbigpIHsKCQkJCQkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAib3ZlcmxheSIgKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0KCgkJCQkvLyB0cmFjayB0aGlzIGRlcGVuZGVuY3kgc28gdGhhdCB3aGVuIHRoZSBwYXJlbnQgcGFnZQoJCQkJLy8gaXMgcmVtb3ZlZCBvbiBwYWdlaGlkZSBpdCB3aWxsIGFsc28gcmVtb3ZlIHRoZSBtZW51cGFnZQoJCQkJc2VsZi50aGlzUGFnZS5hZGREZXBlbmRlbnRzKCB0aGlzLm1lbnVQYWdlICk7CgkJCX0sCgoJCQlfaXNSZWJ1aWxkUmVxdWlyZWQ6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQkJCW9wdGlvbnMgPSB0aGlzLl9zZWxlY3RPcHRpb25zKCk7CgoJCQkJLy8gVE9ETyBleGNlZWRpbmdseSBuYWl2ZSBtZXRob2QgdG8gZGV0ZXJtaW5lIGRpZmZlcmVuY2UKCQkJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJCQkvLyBmcm9tIHRoZSB1c2VyIGluIHRoZSByZWZyZXNoIG1ldGhvZAoJCQkJcmV0dXJuIG9wdGlvbnMudGV4dCgpICE9PSBsaXN0LnRleHQoKTsKCQkJfSwKCgkJCXNlbGVjdGVkOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkOm5vdCggOmpxbURhdGEocGxhY2Vob2xkZXI9J3RydWUnKSApIiApOwoJCQl9LAoKCQkJcmVmcmVzaDogZnVuY3Rpb24oIGZvcmNlUmVidWlsZCAsIGZvbyApIHsKCQkJCXZhciBzZWxmID0gdGhpcywKCQkJCXNlbGVjdCA9IHRoaXMuZWxlbWVudCwKCQkJCWlzTXVsdGlwbGUgPSB0aGlzLmlzTXVsdGlwbGUsCgkJCQlpbmRpY2llczsKCgkJCQlpZiAoICBmb3JjZVJlYnVpbGQgfHwgdGhpcy5faXNSZWJ1aWxkUmVxdWlyZWQoKSApIHsKCQkJCQlzZWxmLl9idWlsZExpc3QoKTsKCQkJCX0KCgkJCQlpbmRpY2llcyA9IHRoaXMuc2VsZWN0ZWRJbmRpY2VzKCk7CgoJCQkJc2VsZi5zZXRCdXR0b25UZXh0KCk7CgkJCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCQkJc2VsZi5saXN0LmZpbmQoICJsaTpub3QoLnVpLWxpLWRpdmlkZXIpIiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApCgkJCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkJCS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQkJCQkJaWYgKCAkLmluQXJyYXkoIGksIGluZGljaWVzICkgPiAtMSApIHsKCQkJCQkJCXZhciBpdGVtID0gJCggdGhpcyApOwoKCQkJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCQkJaXRlbS5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsIHRydWUgKTsKCgkJCQkJCQkvLyBNdWx0aXBsZSBzZWxlY3RzOiBhZGQgdGhlICJvbiIgY2hlY2tib3ggc3RhdGUgdG8gdGhlIGljb24KCQkJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQkJCWl0ZW0uZmluZCggIi51aS1pY29uIiApLnJlbW92ZUNsYXNzKCAidWktaWNvbi1jaGVja2JveC1vZmYiICkuYWRkQ2xhc3MoICJ1aS1pY29uLWNoZWNrYm94LW9uIiApOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlpZiAoIGl0ZW0uaXMoICIudWktc2VsZWN0bWVudS1wbGFjZWhvbGRlciIgKSApIHsKCQkJCQkJCQkJaXRlbS5uZXh0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJaXRlbS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJfSwKCgkJCWNsb3NlOiBmdW5jdGlvbigpIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmRpc2FibGVkIHx8ICF0aGlzLmlzT3BlbiApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJdmFyIHNlbGYgPSB0aGlzOwoKCQkJCWlmICggc2VsZi5tZW51VHlwZSA9PT0gInBhZ2UiICkgewoJCQkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCQkJc2VsZi5saXN0LmFwcGVuZFRvKCBzZWxmLmxpc3Rib3ggKTsKCQkJCX0gZWxzZSB7CgkJCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJCQl9CgoJCQkJc2VsZi5fZm9jdXNCdXR0b24oKTsKCQkJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJCQlzZWxmLmlzT3BlbiA9IGZhbHNlOwoJCQl9LAoKCQkJb3BlbjogZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmJ1dHRvbi5jbGljaygpOwoJCQl9LAoKCQkJX2RlY2lkZUZvcm1hdDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdywKCQkJCQlzZWxmTGlzdFBhcmVudCA9IHNlbGYubGlzdC5wYXJlbnQoKSwKCQkJCQltZW51SGVpZ2h0ID0gc2VsZkxpc3RQYXJlbnQub3V0ZXJIZWlnaHQoKSwKCQkJCQltZW51V2lkdGggPSBzZWxmTGlzdFBhcmVudC5vdXRlcldpZHRoKCksCgkJCQkJYWN0aXZlUGFnZSA9ICQoICIuIiArICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyApLAoJCQkJCXNjcm9sbFRvcCA9ICR3aW5kb3cuc2Nyb2xsVG9wKCksCgkJCQkJYnRuT2Zmc2V0ID0gc2VsZi5idXR0b24ub2Zmc2V0KCkudG9wLAoJCQkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCksCgkJCQkJc2NyZWVuV2lkdGggPSAkd2luZG93LndpZHRoKCk7CgoJCQkJZnVuY3Rpb24gZm9jdXNNZW51SXRlbSgpIHsKCQkJCQl2YXIgc2VsZWN0b3IgPSBzZWxmLmxpc3QuZmluZCggIi4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKyAiIGEiICk7CgkJCQkJaWYgKCBzZWxlY3Rvci5sZW5ndGggPT09IDAgKSB7CgkJCQkJCXNlbGVjdG9yID0gc2VsZi5saXN0LmZpbmQoICJsaS51aS1idG46bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkgYSIgKTsKCQkJCQl9CgkJCQkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpLmNsb3Nlc3QoICJsaSIgKS5hZGRDbGFzcyggInVpLWJ0bi1kb3duLSIgKyB3aWRnZXQub3B0aW9ucy50aGVtZSApOwoJCQkJfQoKCQkJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJCQlzZWxmLm1lbnVQYWdlLmFwcGVuZFRvKCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICkucGFnZSgpOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50ID0gbWVudVBhZ2UuZmluZCggIi51aS1jb250ZW50IiApOwoJCQkJCXNlbGYubWVudVBhZ2VDbG9zZSA9IG1lbnVQYWdlLmZpbmQoICIudWktaGVhZGVyIGEiICk7CgoJCQkJCS8vIHByZXZlbnQgdGhlIHBhcmVudCBwYWdlIGZyb20gYmVpbmcgcmVtb3ZlZCBmcm9tIHRoZSBET00sCgkJCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCQkJLy8gZmFsbCBpbnRvIGEgYmxhY2sgaG9sZQoJCQkJCXNlbGYudGhpc1BhZ2UudW5iaW5kKCAicGFnZWhpZGUucmVtb3ZlIiApOwoKCQkJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQkJCWlmICggc2Nyb2xsVG9wID09PSAwICYmIGJ0bk9mZnNldCA+IHNjcmVlbkhlaWdodCApIHsKCQkJCQkJc2VsZi50aGlzUGFnZS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQkJCX0pOwoJCQkJCX0KCgkJCQkJc2VsZi5tZW51UGFnZQoJCQkJCQkub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJCWZvY3VzTWVudUl0ZW0oKTsKCQkJCQkJfSkKCQkJCQkJLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQkJCX0pOwoKCQkJCQlzZWxmLm1lbnVUeXBlID0gInBhZ2UiOwoJCQkJCXNlbGYubWVudVBhZ2VDb250ZW50LmFwcGVuZCggc2VsZi5saXN0ICk7CgkJCQkJc2VsZi5tZW51UGFnZS5maW5kKCJkaXYgLnVpLXRpdGxlIikudGV4dChzZWxmLmxhYmVsLnRleHQoKSk7CgkJCQl9IGVsc2UgewoJCQkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQkJCXNlbGYubGlzdGJveC5vbmUoICJwb3B1cGFmdGVyb3BlbiIsIGZvY3VzTWVudUl0ZW0gKTsKCQkJCX0KCQkJfSwKCgkJCV9idWlsZExpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgkJCQkJcGxhY2Vob2xkZXIgPSB0aGlzLnBsYWNlaG9sZGVyLAoJCQkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCQkJb3B0Z3JvdXBzID0gW10sCgkJCQkJbGlzID0gW10sCgkJCQkJZGF0YUljb24gPSBzZWxmLmlzTXVsdGlwbGUgPyAiY2hlY2tib3gtb2ZmIiA6ICJmYWxzZSI7CgoJCQkJc2VsZi5saXN0LmVtcHR5KCkuZmlsdGVyKCAiLnVpLWxpc3R2aWV3IiApLmxpc3R2aWV3KCAiZGVzdHJveSIgKTsKCgkJCQl2YXIgJG9wdGlvbnMgPSBzZWxmLnNlbGVjdC5maW5kKCAib3B0aW9uIiApLAoJCQkJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGgsCgkJCQkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXSwKCQkJCQlkYXRhUHJlZml4ID0gJ2RhdGEtJyArICQubW9iaWxlLm5zLAoJCQkJCWRhdGFJbmRleEF0dHIgPSBkYXRhUHJlZml4ICsgJ29wdGlvbi1pbmRleCcsCgkJCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICdpY29uJywKCQkJCQlkYXRhUm9sZUF0dHIgPSBkYXRhUHJlZml4ICsgJ3JvbGUnLAoJCQkJCWRhdGFQbGFjZWhvbGRlckF0dHIgPSBkYXRhUHJlZml4ICsgJ3BsYWNlaG9sZGVyJywKCQkJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJCQlpc1BsYWNlaG9sZGVySXRlbSA9IGZhbHNlLAoJCQkJCW9wdEdyb3VwOwoKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgbnVtT3B0aW9ucztpKyssIGlzUGxhY2Vob2xkZXJJdGVtID0gZmFsc2UpIHsKCQkJCQl2YXIgb3B0aW9uID0gJG9wdGlvbnNbaV0sCgkJCQkJCSRvcHRpb24gPSAkKCBvcHRpb24gKSwKCQkJCQkJcGFyZW50ID0gb3B0aW9uLnBhcmVudE5vZGUsCgkJCQkJCXRleHQgPSAkb3B0aW9uLnRleHQoKSwKCQkJCQkJYW5jaG9yICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdhJyApLAoJCQkJCQljbGFzc2VzID0gW107CgoJCQkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICdocmVmJywgJyMnICk7CgkJCQkJYW5jaG9yLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggdGV4dCApICk7CgoJCQkJCS8vIEFyZSB3ZSBpbnNpZGUgYW4gb3B0Z3JvdXA/CgkJCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCQkJdmFyIG9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggJ2xhYmVsJyApOwoJCQkJCQlpZiAoIG9wdExhYmVsICE9PSBvcHRHcm91cCApIHsKCQkJCQkJCXZhciBkaXZpZGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2xpJyApOwoJCQkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoIGRhdGFSb2xlQXR0ciwgJ2xpc3QtZGl2aWRlcicgKTsKCQkJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCQkJZGl2aWRlci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdExhYmVsICkgKTsKCQkJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJCQlvcHRHcm91cCA9IG9wdExhYmVsOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoIG5lZWRQbGFjZWhvbGRlciAmJiAoICFvcHRpb24uZ2V0QXR0cmlidXRlKCAidmFsdWUiICkgfHwgdGV4dC5sZW5ndGggPT09IDAgfHwgJG9wdGlvbi5qcW1EYXRhKCAicGxhY2Vob2xkZXIiICkgKSApIHsKCQkJCQkJbmVlZFBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkJCS8vIElmIHdlIGhhdmUgaWRlbnRpZmllZCBhIHBsYWNlaG9sZGVyLCByZWNvcmQgdGhlIGZhY3QgdGhhdCBpdCB3YXMKCQkJCQkJLy8gdXMgd2hvIGhhdmUgYWRkZWQgdGhlIHBsYWNlaG9sZGVyIHRvIHRoZSBvcHRpb24gYW5kIG1hcmsgaXQKCQkJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCQkJaWYgKCBudWxsID09PSBvcHRpb24uZ2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyICkgKSB7CgkJCQkJCQl0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgPSB0cnVlOwoJCQkJCQl9CgkJCQkJCW9wdGlvbi5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQkJaWYgKCBvLmhpZGVQbGFjZWhvbGRlck1lbnVJdGVtcyApIHsKCQkJCQkJCWNsYXNzZXMucHVzaCggInVpLXNlbGVjdG1lbnUtcGxhY2Vob2xkZXIiICk7CgkJCQkJCX0KCQkJCQkJaWYgKCBwbGFjZWhvbGRlciAhPT0gdGV4dCApIHsKCQkJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCXZhciBpdGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTsKCQkJCQlpZiAoIG9wdGlvbi5kaXNhYmxlZCApIHsKCQkJCQkJY2xhc3Nlcy5wdXNoKCAidWktZGlzYWJsZWQiICk7CgkJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLWRpc2FibGVkJyx0cnVlKTsKCQkJCQl9CgkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsaSApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhSWNvbkF0dHIsIGRhdGFJY29uICk7CgkJCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFQbGFjZWhvbGRlckF0dHIsIHRydWUgKTsKCQkJCQl9CgkJCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCAncm9sZScsICdvcHRpb24nICk7CgkJCQkJYW5jaG9yLnNldEF0dHJpYnV0ZSggJ3RhYmluZGV4JywgJy0xJyApOwoJCQkJCWl0ZW0uYXBwZW5kQ2hpbGQoIGFuY2hvciApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBpdGVtICk7CgkJCQl9CgoJCQkJc2VsZi5saXN0WzBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoKCQkJCS8vIEhpZGUgaGVhZGVyIGlmIGl0J3Mgbm90IGEgbXVsdGlzZWxlY3QgYW5kIHRoZXJlJ3Mgbm8gcGxhY2Vob2xkZXIKCQkJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQkJCXRoaXMuaGVhZGVyLmhpZGUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJCQl9CgoJCQkJLy8gTm93IHBvcHVsYXRlZCwgY3JlYXRlIGxpc3R2aWV3CgkJCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCQkJfSwKCgkJCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICI8YT4iLCB7CgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJCSJpZCI6IHRoaXMuYnV0dG9uSWQsCgkJCQkJImFyaWEtaGFzcG9wdXAiOiAidHJ1ZSIsCgoJCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkJImFyaWEtb3ducyI6IHRoaXMubWVudUlkCgkJCQl9KTsKCQkJfSwKCgkJCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuY2xvc2UoKTsKCgkJCQkvLyBSZXN0b3JlIHRoZSB0YWJpbmRleCBhdHRyaWJ1dGUgdG8gaXRzIG9yaWdpbmFsIHZhbHVlCgkJCQlpZiAoIHRoaXMuX29yaWdUYWJJbmRleCAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgdGhpcy5fb3JpZ1RhYkluZGV4ICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQkJaWYgKCB0aGlzLl9yZW1vdmVQbGFjZWhvbGRlckF0dHIgKSB7CgkJCQkJdGhpcy5fc2VsZWN0T3B0aW9ucygpLnJlbW92ZUF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJwbGFjZWhvbGRlciIgKTsKCQkJCX0KCgkJCQkvLyBSZW1vdmUgdGhlIHBvcHVwCgkJCQl0aGlzLmxpc3Rib3gucmVtb3ZlKCk7CgoJCQkJLy8gQ2hhaW4gdXAKCQkJCW9yaWdEZXN0cm95LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQkJfQoJCX0pOwoJfTsKCgkvLyBpc3N1ZSAjMzg5NCAtIGNvcmUgZG9lc24ndCB0cmlnZ2VyIGV2ZW50cyBvbiBkaXNhYmxlZCBkZWxlZ2F0ZXMKCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJzZWxlY3RtZW51YmVmb3JlY3JlYXRlIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBzZWxlY3RtZW51V2lkZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuZGF0YSggIm1vYmlsZS1zZWxlY3RtZW51IiApOwoKCQlpZiAoICFzZWxlY3RtZW51V2lkZ2V0Lm9wdGlvbnMubmF0aXZlTWVudSAmJgoJCQkJc2VsZWN0bWVudVdpZGdldC5lbGVtZW50LnBhcmVudHMoICI6anFtRGF0YShyb2xlPSdwb3B1cCcpIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJZXh0ZW5kU2VsZWN0KCBzZWxlY3RtZW51V2lkZ2V0ICk7CgkJfQoJfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQubW9iaWxlLndpZGdldCwgJC5leHRlbmQoIHsKCQlvcHRpb25zOiB7CgkJCXNoYWRvdzogZmFsc2UsCgkJCWNvcm5lcnM6IHRydWUsCgkJCWV4Y2x1ZGVJbnZpc2libGU6IHRydWUsCgkJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJCW1pbmk6IGZhbHNlLAoJCQlpbml0U2VsZWN0b3I6ICI6anFtRGF0YShyb2xlPSdjb250cm9sZ3JvdXAnKSIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJCXVpID0gewoJCQkJCWlubmVyOiAkKCAiPGRpdiBjbGFzcz0ndWktY29udHJvbGdyb3VwLWNvbnRyb2xzJz48L2Rpdj4iICksCgkJCQkJbGVnZW5kOiAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJyBjbGFzcz0ndWktY29udHJvbGdyb3VwLWxhYmVsJz48L2Rpdj4iICkKCQkJCX0sCgkJCQlncm91cGxlZ2VuZCA9ICRlbC5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCXNlbGYgPSB0aGlzOwoKCQkJLy8gQXBwbHkgdGhlIHByb3RvCgkJCSRlbC53cmFwSW5uZXIoIHVpLmlubmVyICk7CgkJCWlmICggZ3JvdXBsZWdlbmQubGVuZ3RoICkgewoJCQkJdWkubGVnZW5kLmFwcGVuZCggZ3JvdXBsZWdlbmQgKS5pbnNlcnRCZWZvcmUoICRlbC5jaGlsZHJlbiggMCApICk7CgkJCX0KCQkJJGVsLmFkZENsYXNzKCAidWktY29ybmVyLWFsbCB1aS1jb250cm9sZ3JvdXAiICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2luaXRpYWxSZWZyZXNoOiB0cnVlCgkJCX0pOwoKCQkJJC5lYWNoKCB0aGlzLm9wdGlvbnMsIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJLy8gQ2F1c2UgaW5pdGlhbCBvcHRpb25zIHRvIGJlIGFwcGxpZWQgYnkgdGhlaXIgaGFuZGxlciBieSB0ZW1wb3JhcmlseSBzZXR0aW5nIHRoZSBvcHRpb24gdG8gdW5kZWZpbmVkCgkJCQkvLyAtIHRoZSBoYW5kbGVyIHRoZW4gc2V0cyBpdCB0byB0aGUgaW5pdGlhbCB2YWx1ZQoJCQkJc2VsZi5vcHRpb25zWyBrZXkgXSA9IHVuZGVmaW5lZDsKCQkJCXNlbGYuX3NldE9wdGlvbigga2V5LCB2YWx1ZSwgdHJ1ZSApOwoJCQl9KTsKCQl9LAoKCQlfaW5pdDogZnVuY3Rpb24oKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCV9zZXRPcHRpb246IGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQl2YXIgc2V0dGVyID0gIl9zZXQiICsga2V5LmNoYXJBdCggMCApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoIDEgKTsKCgkJCWlmICggdGhpc1sgc2V0dGVyIF0gIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXNbIHNldHRlciBdKCB2YWx1ZSApOwoJCQl9CgoJCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQuYXR0ciggImRhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICgga2V5LnJlcGxhY2UoIC8oW0EtWl0pLywgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICksIHZhbHVlICk7CgkJfSwKCgkJX3NldFR5cGU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgdmFsdWUgKTsKCQkJdGhpcy5yZWZyZXNoKCk7CgkJfSwKCgkJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIHZhbHVlICk7CgkJfSwKCgkJX3NldFNoYWRvdzogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1zaGFkb3ciLCB2YWx1ZSApOwoJCX0sCgoJCV9zZXRNaW5pOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCX0sCgoJCWNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICIudWktY29udHJvbGdyb3VwLWNvbnRyb2xzIiApOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgZWxzID0gdGhpcy5lbGVtZW50LmZpbmQoICIudWktYnRuIiApLm5vdCggIi51aS1zbGlkZXItaGFuZGxlIiApLAoJCQkJY3JlYXRlID0gdGhpcy5faW5pdGlhbFJlZnJlc2g7CgkJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiOm1vYmlsZS1jaGVja2JveHJhZGlvIiApLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJCQl9CgkJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywgdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywgY3JlYXRlICk7CgkJCXRoaXMuX2luaXRpYWxSZWZyZXNoID0gZmFsc2U7CgkJfQoJfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKCS8vIFRPRE86IEltcGxlbWVudCBhIG1lY2hhbmlzbSB0byBhbGxvdyB3aWRnZXRzIHRvIGJlY29tZSBlbmhhbmNlZCBpbiB0aGUKCS8vIGNvcnJlY3Qgb3JkZXIgd2hlbiB0aGVpciBjb3JyZWN0IGVuaGFuY2VtZW50IGRlcGVuZHMgb24gb3RoZXIgd2lkZ2V0cyBpbgoJLy8gdGhlIHBhZ2UgYmVpbmcgY29ycmVjdGx5IGVuaGFuY2VkIGFscmVhZHkuCgkvLwoJLy8gRm9yIG5vdywgd2Ugd2FpdCB1bnRpbCBkb20tcmVhZHkgdG8gYXR0YWNoIHRoZSBjb250cm9sZ3JvdXAncyBlbmhhbmNlbWVudAoJLy8gaG9vaywgYmVjYXVzZSBieSB0aGF0IHRpbWUsIGFsbCB0aGUgb3RoZXIgd2lkZ2V0cycgZW5oYW5jZW1lbnQgaG9va3Mgc2hvdWxkCgkvLyBhbHJlYWR5IGJlIGluIHBsYWNlLCBlbnN1cmluZyB0aGF0IGFsbCB3aWRnZXRzIHRoYXQgbmVlZCB0byBiZSBncm91cGVkIHdpbGwKCS8vIGFscmVhZHkgaGF2ZSBiZWVuIGVuaGFuY2VkIGJ5IHRoZSB0aW1lIHRoZSBjb250cm9sZ3JvdXAgaXMgY3JlYXRlZC4KCSQoIGZ1bmN0aW9uKCkgewoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgIHsKCQkJJC5tb2JpbGUuY29udHJvbGdyb3VwLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCwgdHJ1ZSApOwoJCX0pOwoJfSk7Cn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQoIGRvY3VtZW50ICkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCBlLnRhcmdldCApCgkJLmZpbmQoICJhIiApCgkJLmpxbUVuaGFuY2VhYmxlKCkKCQkubm90KCAiLnVpLWJ0biwgLnVpLWxpbmstaW5oZXJpdCwgOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiICkKCQkuYWRkQ2xhc3MoICJ1aS1saW5rIiApOwoKfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoKCSQud2lkZ2V0KCAibW9iaWxlLmZpeGVkdG9vbGJhciIsICQubW9iaWxlLndpZGdldCwgewoJCW9wdGlvbnM6IHsKCQkJdmlzaWJsZU9uUGFnZVNob3c6IHRydWUsCgkJCWRpc2FibGVQYWdlWm9vbTogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogInNsaWRlIiwgLy9jYW4gYmUgbm9uZSwgZmFkZSwgc2xpZGUgKHNsaWRlIG1hcHMgdG8gc2xpZGV1cCBvciBzbGlkZWRvd24pCgkJCWZ1bGxzY3JlZW46IGZhbHNlLAoJCQl0YXBUb2dnbGU6IHRydWUsCgkJCXRhcFRvZ2dsZUJsYWNrbGlzdDogImEsIGJ1dHRvbiwgaW5wdXQsIHNlbGVjdCwgdGV4dGFyZWEsIC51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfSwKCQkJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJJGVsID0gc2VsZi5lbGVtZW50LAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiLAoJCQkJJHBhZ2UgPSAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoKCQkJLy8gRmVhdHVyZSBkZXRlY3Rpbmcgc3VwcG9ydCBmb3IKCQkJaWYgKCBvLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXNlbGYuZGVzdHJveSgpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkkZWwuYWRkQ2xhc3MoICJ1aS0iKyB0YnR5cGUgKyItZml4ZWQiICk7CgoJCQkvLyAiZnVsbHNjcmVlbiIgb3ZlcmxheSBwb3NpdGlvbmluZwoJCQlpZiAoIG8uZnVsbHNjcmVlbiApIHsKCQkJCSRlbC5hZGRDbGFzcyggInVpLSIrIHRidHlwZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJJHBhZ2UuYWRkQ2xhc3MoICJ1aS1wYWdlLSIgKyB0YnR5cGUgKyAiLWZ1bGxzY3JlZW4iICk7CgkJCX0KCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJZWxzZXsKCQkJCSRwYWdlLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGJ0eXBlICsgIi1maXhlZCIgKTsKCQkJfQoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV90aGlzUGFnZTogbnVsbAoJCQl9KTsKIAoJCQlzZWxmLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJc2VsZi5fYmluZFBhZ2VFdmVudHMoKTsKCQkJc2VsZi5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJfSwKCgkJX2FkZFRyYW5zaXRpb25DbGFzczogZnVuY3Rpb24oKSB7CgkJCXZhciB0Y2xhc3MgPSB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbjsKCgkJCWlmICggdGNsYXNzICYmIHRjbGFzcyAhPT0gIm5vbmUiICkgewoJCQkJLy8gdXNlIGFwcHJvcHJpYXRlIHNsaWRlIGZvciBoZWFkZXIgb3IgZm9vdGVyCgkJCQlpZiAoIHRjbGFzcyA9PT0gInNsaWRlIiApIHsKCQkJCQl0Y2xhc3MgPSB0aGlzLmVsZW1lbnQuaXMoICIudWktaGVhZGVyIiApID8gInNsaWRlZG93biIgOiAic2xpZGV1cCI7CgkJCQl9CgoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0Y2xhc3MgKTsKCQkJfQoJCX0sCgoJCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3RoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHRoaXMuX3RoaXNQYWdlLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCQkJaWYgKCBvLmRpc2FibGVQYWdlWm9vbSApIHsKCQkJCSQubW9iaWxlLnpvb20uZGlzYWJsZSggdHJ1ZSApOwoJCQl9CgkJCWlmICggIW8udmlzaWJsZU9uUGFnZVNob3cgKSB7CgkJCQl0aGlzLmhpZGUoIHRydWUgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVBbmltYXRpb25TdGFydDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggdGhpcy5fdGhpc1BhZ2UgKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlU2hvdzogZnVuY3Rpb24oKSB7CgkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoIHRoaXMuX3RoaXNQYWdlICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyAidGhyb3R0bGVkcmVzaXplIjogInVwZGF0ZVBhZ2VQYWRkaW5nIiB9ICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZUhpZGU6IGZ1bmN0aW9uKCBlLCB1aSApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoICQubW9iaWxlLndpbmRvdywgInRocm90dGxlZHJlc2l6ZSIgKTsKCQkJfQoKCQkJaWYgKCBvLnRyYWNrUGVyc2lzdGVudFRvb2xiYXJzICkgewoJCQkJdmFyIHRoaXNGb290ZXIgPSAkKCAiLnVpLWZvb3Rlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMuX3RoaXNQYWdlICksCgkJCQkJdGhpc0hlYWRlciA9ICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQpIiwgdGhpcy5fdGhpc1BhZ2UgKSwKCQkJCQluZXh0Rm9vdGVyID0gdGhpc0Zvb3Rlci5sZW5ndGggJiYgdWkubmV4dFBhZ2UgJiYgJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZD0nIiArIHRoaXNGb290ZXIuanFtRGF0YSggImlkIiApICsgIicpIiwgdWkubmV4dFBhZ2UgKSB8fCAkKCksCgkJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCgkJCS8vIHRiUGFnZSBhcmd1bWVudCBjYW4gYmUgYSBQYWdlIG9iamVjdCBvciBhbiBldmVudCwgaWYgY29taW5nIGZyb20gdGhyb3R0bGVkIHJlc2l6ZS4gCgkJCXRiUGFnZSA9ICggdGJQYWdlICYmIHRiUGFnZS50eXBlID09PSB1bmRlZmluZWQgJiYgdGJQYWdlICkgfHwgdGhpcy5fdGhpc1BhZ2UgfHwgJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJJCggdGJQYWdlICkuY3NzKCAicGFkZGluZy0iICsgKCBoZWFkZXIgPyAidG9wIiA6ICJib3R0b20iICksICRlbC5vdXRlckhlaWdodCgpICsgcG9zICk7CgkJfSwKCgkJX3VzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuaGVpZ2h0KCksCgkJCQl2aWV3cG9ydEhlaWdodCA9ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpLAoJCQkJdGJ0eXBlID0gJGVsLmlzKCAiOmpxbURhdGEocm9sZT0naGVhZGVyJykiICkgPyAiaGVhZGVyIiA6ICJmb290ZXIiOwoKCQkJcmV0dXJuICFub3RyYW5zaXRpb24gJiYKCQkJCSggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gIT09ICJub25lIiAmJgoJCQkJKAoJCQkJCSggdGJ0eXBlID09PSAiaGVhZGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsID4gZWxIZWlnaHQgKSB8fAoJCQkJCSggdGJ0eXBlID09PSAiZm9vdGVyIiAmJiAhdGhpcy5vcHRpb25zLmZ1bGxzY3JlZW4gJiYgc2Nyb2xsICsgdmlld3BvcnRIZWlnaHQgPCBwSGVpZ2h0IC0gZWxIZWlnaHQgKQoJCQkJKSB8fCB0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbgoJCQkJKTsKCQl9LAoKCQlzaG93OiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQ7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLnJlbW92ZUNsYXNzKCAib3V0ICIgKyBoaWRlQ2xhc3MgKQoJCQkJCS5hZGRDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uICgpIHsKCQkJCQkJJGVsLnJlbW92ZUNsYXNzKCdpbicpOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLnJlbW92ZUNsYXNzKCBoaWRlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gdHJ1ZTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgaGlkZUNsYXNzID0gInVpLWZpeGVkLWhpZGRlbiIsCgkJCQkkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkvLyBpZiBpdCdzIGEgc2xpZGUgdHJhbnNpdGlvbiwgb3VyIG5ldyB0cmFuc2l0aW9ucyBuZWVkIHRoZSByZXZlcnNlIGNsYXNzIGFzIHdlbGwgdG8gc2xpZGUgb3V0d2FyZAoJCQkJb3V0Y2xhc3MgPSAib3V0IiArICggdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gPT09ICJzbGlkZSIgPyAiIHJldmVyc2UiIDogIiIgKTsKCgkJCWlmKCB0aGlzLl91c2VUcmFuc2l0aW9uKCBub3RyYW5zaXRpb24gKSApIHsKCQkJCSRlbAoJCQkJCS5hZGRDbGFzcyggb3V0Y2xhc3MgKQoJCQkJCS5yZW1vdmVDbGFzcyggImluIiApCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKGZ1bmN0aW9uKCkgewoJCQkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQkJCX0pOwoJCQl9CgkJCWVsc2UgewoJCQkJJGVsLmFkZENsYXNzKCBoaWRlQ2xhc3MgKS5yZW1vdmVDbGFzcyggb3V0Y2xhc3MgKTsKCQkJfQoJCQl0aGlzLl92aXNpYmxlID0gZmFsc2U7CgkJfSwKCgkJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQkJdGhpc1sgdGhpcy5fdmlzaWJsZSA/ICJoaWRlIiA6ICJzaG93IiBdKCk7CgkJfSwKCgkJX2JpbmRUb2dnbGVIYW5kbGVyczogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgkJCQkkZWwgPSBzZWxmLmVsZW1lbnQsCgkJCQlkZWxheVNob3csIGRlbGF5SGlkZSwKCQkJCWlzVmlzaWJsZSA9IHRydWU7CgoJCQkvLyB0YXAgdG9nZ2xlCgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkKCQkJCS5iaW5kKCAidmNsaWNrIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJaWYgKCBvLnRhcFRvZ2dsZSAmJiAhJCggZS50YXJnZXQgKS5jbG9zZXN0KCBvLnRhcFRvZ2dsZUJsYWNrbGlzdCApLmxlbmd0aCApIHsKCQkJCQkJc2VsZi50b2dnbGUoKTsKCQkJCQl9CgkJCQl9KQoJCQkJLmJpbmQoICJmb2N1c2luIGZvY3Vzb3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJLy90aGlzIGhpZGVzIHRoZSB0b29sYmFycyBvbiBhIGtleWJvYXJkIHBvcCB0byBnaXZlIG1vcmUgc2NyZWVuIHJvb20gYW5kIHByZXZlbnQgaW9zIGJ1ZyB3aGljaCAKCQkJCQkvL3Bvc2l0aW9ucyBmaXhlZCB0b29sYmFycyBpbiB0aGUgbWlkZGxlIG9mIHRoZSBzY3JlZW4gb24gcG9wIGlmIHRoZSBpbnB1dCBpcyBuZWFyIHRoZSB0b3Agb3IKCQkJCQkvL2JvdHRvbSBvZiB0aGUgc2NyZWVuIGFkZHJlc3NlcyBpc3N1ZXMgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJLy9hbmQgaXNzdWUgIzQxMTMgSGVhZGVyIGFuZCBmb290ZXIgY2hhbmdlIHRoZWlyIHBvc2l0aW9uIGFmdGVyIGtleWJvYXJkIHBvcHVwIC0gaU9TCgkJCQkJLy9hbmQgaXNzdWUgIzQ0MTAgRm9vdGVyIG5hdmJhciBtb3ZlcyB1cCB3aGVuIGNsaWNraW5nIG9uIGEgdGV4dGJveCBpbiBhbiBBbmRyb2lkIGVudmlyb25tZW50CgkJCQkJaWYgKCBzY3JlZW4ud2lkdGggPCAxMDI1ICYmICQoIGUudGFyZ2V0ICkuaXMoIG8uaGlkZUR1cmluZ0ZvY3VzICkgJiYgISQoIGUudGFyZ2V0ICkuY2xvc2VzdCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICkubGVuZ3RoICkgewoJCQkJCQkvL0ZpeCBmb3IgaXNzdWUgIzQ3MjQgTW92aW5nIHRocm91Z2ggZm9ybSBpbiBNb2JpbGUgU2FmYXJpIHdpdGggIk5leHQiIGFuZCAiUHJldmlvdXMiIHN5c3RlbSAKCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsgCgkJCQkJCX0gZWxzZSBpZiAoIGUudHlwZSA9PT0gImZvY3VzaW4iICYmICEhaXNWaXNpYmxlICkgewoJCQkJCQkJLy9pZiB3ZSBoYXZlIGp1bXBlZCB0byBhbm90aGVyIGlucHV0IGNsZWFyIHRoZSB0aW1lIG91dCB0byBjYW5jZWwgdGhlIHNob3cuCgkJCQkJCQljbGVhclRpbWVvdXQoIGRlbGF5U2hvdyApOwoJCQkJCQkJaXNWaXNpYmxlID0gZmFsc2U7CgkJCQkJCQlkZWxheUhpZGUgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLmhpZGUoKTsKCQkJCQkJCX0sIDAgKTsgCgkJCQkJCX0KCQkJCQl9CgkJCQl9KTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaXMoICIudWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwoKCS8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwoJJC5tb2JpbGUuZG9jdW1lbnQKCQkuYmluZCggInBhZ2VjcmVhdGUgY3JlYXRlIiwgZnVuY3Rpb24oIGUgKSB7CgoJCQkvLyBERVBSRUNBVEVEIGluIDEuMTogc3VwcG9ydCBmb3IgZGF0YS1mdWxsc2NyZWVuPXRydWV8ZmFsc2Ugb24gdGhlIHBhZ2UgZWxlbWVudC4KCQkJLy8gVGhpcyBsaW5lIGVuc3VyZXMgaXQgc3RpbGwgd29ya3MsIGJ1dCB3ZSByZWNvbW1lbmQgbW92aW5nIHRoZSBhdHRyaWJ1dGUgdG8gdGhlIHRvb2xiYXJzIHRoZW1zZWx2ZXMuCgkJCWlmICggJCggZS50YXJnZXQgKS5qcW1EYXRhKCAiZnVsbHNjcmVlbiIgKSApIHsKCQkJCSQoICQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUub3B0aW9ucy5pbml0U2VsZWN0b3IsIGUudGFyZ2V0ICkubm90KCAiOmpxbURhdGEoZnVsbHNjcmVlbikiICkuanFtRGF0YSggImZ1bGxzY3JlZW4iLCB0cnVlICk7CgkJCX0KCgkJCSQubW9iaWxlLmZpeGVkdG9vbGJhci5wcm90b3R5cGUuZW5oYW5jZVdpdGhpbiggZS50YXJnZXQgKTsKCQl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC53aWRnZXQoICJtb2JpbGUuZml4ZWR0b29sYmFyIiwgJC5tb2JpbGUuZml4ZWR0b29sYmFyLCB7CgoJCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3N1cGVyKCk7CgkJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCQl9LAoKCQkJLy9jaGVjayB0aGUgYnJvd3NlciBhbmQgdmVyc2lvbiBhbmQgcnVuIG5lZWRlZCB3b3JrYXJvdW5kcwoJCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudCwKCQkJCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLAoJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCXdrbWF0Y2ggPSB1YS5tYXRjaCggL0FwcGxlV2ViS2l0XC8oWzAtOV0rKS8gKSwKCQkJCXdrdmVyc2lvbiA9ICEhd2ttYXRjaCAmJiB3a21hdGNoWyAxIF0sCgkJCQlvcyA9IG51bGwsCgkJCQlzZWxmID0gdGhpczsKCQkJCS8vc2V0IHRoZSBvcyB3ZSBhcmUgd29ya2luZyBpbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCQlpZiggcGxhdGZvcm0uaW5kZXhPZiggImlQaG9uZSIgKSA+IC0xIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUGFkIiApID4gLTEgIHx8IHBsYXRmb3JtLmluZGV4T2YoICJpUG9kIiApID4gLTEgKXsKCQkJCQlvcyA9ICJpb3MiOwoJCQkJfSBlbHNlIGlmKCB1YS5pbmRleE9mKCAiQW5kcm9pZCIgKSA+IC0xICl7CgkJCQkJb3MgPSAiYW5kcm9pZCI7CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCQlpZiggb3MgPT09ICJpb3MiICkgewoJCQkJCS8vaU9TICB3b3JrYXJvdW5kcwoJCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQl9IGVsc2UgaWYoIG9zID09PSAiYW5kcm9pZCIgJiYgd2t2ZXJzaW9uICYmIHdrdmVyc2lvbiA8IDUzNCApIHsKCQkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJCXNlbGYuX2JpbmRTY3JvbGxXb3JrYXJvdW5kKCk7CgkJCQkJc2VsZi5fYmluZExpc3RUaHVtYldvcmthcm91bmQoKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9LAoKCQkJLy9VdGlsaXR5IGNsYXNzIGZvciBjaGVja2luZyBoZWFkZXIgYW5kIGZvb3RlciBwb3NpdGlvbnMgcmVsYXRpdmUgdG8gdmlld3BvcnQKCQkJX3ZpZXdwb3J0T2Zmc2V0OiBmdW5jdGlvbigpIHsKCQkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQkJaGVhZGVyID0gJGVsLmlzKCAiLnVpLWhlYWRlciIgKSwKCQkJCQlvZmZzZXQgPSBNYXRoLmFicygkZWwub2Zmc2V0KCkudG9wIC0gJC5tb2JpbGUud2luZG93LnNjcm9sbFRvcCgpKTsKCQkJCWlmKCAhaGVhZGVyICkgewoJCQkJCW9mZnNldCA9IE1hdGgucm91bmQob2Zmc2V0IC0gJC5tb2JpbGUud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkpLTYwOwoJCQkJfQoJCQkJcmV0dXJuIG9mZnNldDsKCQkJfSwKCgkJCS8vYmluZCBldmVudHMgZm9yIF90cmlnZ2VyUmVkcmF3KCkgZnVuY3Rpb24gCgkJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCQl2YXIgc2VsZiA9IHRoaXM7CgkJCQkvL2JpbmQgdG8gc2Nyb2xsc3RvcCBhbmQgY2hlY2sgaWYgdGhlIHRvb2xiYXJzIGFyZSBjb3JyZWN0bHkgcG9zaXRpb25lZAoJCQkJdGhpcy5fb24oICQubW9iaWxlLndpbmRvdywgeyBzY3JvbGxzdG9wOiBmdW5jdGlvbigpIHsKCQkJCQl2YXIgdmlld3BvcnRPZmZzZXQgPSBzZWxmLl92aWV3cG9ydE9mZnNldCgpOwoJCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQkJaWYoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlKSB7CgkJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCQl9CgkJCQl9fSk7CgkJCX0sCgoJCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlICM0MjUwIFBlcnNpc3RlbnQgZm9vdGVyIGluc3RhYmlsaXR5IGluIHYxLjEgd2l0aCBsb25nIHNlbGVjdCBsaXN0cyBpbiBBbmRyb2lkIDIuMy4zCgkJCS8vYW5kIGlzc3VlICMzNzQ4IEFuZHJvaWQgMi54OiBQYWdlIHRyYW5zaXRpb25zIGJyb2tlbiB3aGVuIGZpeGVkIHRvb2xiYXJzIHVzZWQKCQkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCQkvL3NldHRpbmcgdGhlIGxpJ3MgdG8gLXdlYmtpdC10cmFuc2Zvcm06dHJhbnNsYXRlM2QoMCwwLDApOyBzb2x2ZXMgdGhpcyBwcm9ibGVtIHRvIGF2b2lkZSBwb3RlbnRpYWwgaXNzdWVzIGluIG90aGVyCgkJCS8vcGxhdGZvcm1zIHdlIHNjb3BlIHRoaXMgd2l0aCB0aGUgY2xhc3MgdWktYW5kcm9pZC0yeC1maXgKCQkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCIudWktcGFnZSIpLmFkZENsYXNzKCAidWktYW5kcm9pZC0yeC1maXhlZCIgKTsKCQkJfSwKCQkJLy90aGlzIGFkZHJlc3NlcyBpc3N1ZXMgIzQzMzcgRml4ZWQgaGVhZGVyIHByb2JsZW0gYWZ0ZXIgc2Nyb2xsaW5nIGNvbnRlbnQgb24gaU9TIGFuZCBBbmRyb2lkCgkJCS8vYW5kIGRldmljZSBidWdzIHByb2plY3QgaXNzdWUgIzEgRm9ybSBlbGVtZW50cyBjYW4gbG9zZSBjbGljayBoaXQgYXJlYSBpbiBwb3NpdGlvbjogZml4ZWQgY29udGFpbmVycy4KCQkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkJLy9hZGRpbmcgMXB4IG9mIHBhZGRpbmcgdG8gdGhlIGJvdHRvbSB0aGVuIHJlbW92aW5nIGl0IGNhdXNlcyBhICJyZWRyYXciCgkJCS8vd2hpY2ggcG9zaXRpb25zIHRoZSB0b29sYmFycyBjb3JyZWN0bHkgKHRoZXkgd2lsbCBhbHdheXMgYmUgdmlzdWFsbHkgY29ycmVjdCkgCgkJCV90cmlnZ2VyUmVkcmF3OiBmdW5jdGlvbigpIHsKCQkJCXZhciBwYWRkaW5nQm90dG9tID0gcGFyc2VGbG9hdCggJCggIi51aS1wYWdlLWFjdGl2ZSIgKS5jc3MoICJwYWRkaW5nLWJvdHRvbSIgKSApOwoJCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgKCBwYWRkaW5nQm90dG9tICsgMSApICsicHgiICk7CgkJCQkvL2lmIHRoZSBwYWRkaW5nIGlzIHJlc2V0IHdpdGggb3V0IGEgdGltZW91dCB0aGUgcmVwb3NpdGlvbiB3aWxsIG5vdCBvY2N1cmUuCgkJCQkvL3RoaXMgaXMgaW5kZXBlbmRhbnQgb2YgSlFNIHRoZSBicm93c2VyIHNlZW1zIHRvIG5lZWQgdGhlIHRpbWUgdG8gcmVhY3QuCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkkKCAiLnVpLXBhZ2UtYWN0aXZlIiApLmNzcyggInBhZGRpbmctYm90dG9tIiwgcGFkZGluZ0JvdHRvbSArICJweCIgKTsKCQkJCX0sIDAgKTsKCQkJfSwKCgkJCWRlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fc3VwZXIoKTsKCQkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54IAoJCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoIi51aS1wYWdlLWFjdGl2ZSIpLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJCX0KCX0pOwoKCX0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCAkLm1vYmlsZS53aWRnZXQsIHsKCW9wdGlvbnM6IHsKCQljbGFzc2VzOiB7CgkJCXBhbmVsOiAidWktcGFuZWwiLAoJCQlwYW5lbE9wZW46ICJ1aS1wYW5lbC1vcGVuIiwKCQkJcGFuZWxDbG9zZWQ6ICJ1aS1wYW5lbC1jbG9zZWQiLAoJCQlwYW5lbEZpeGVkOiAidWktcGFuZWwtZml4ZWQiLAoJCQlwYW5lbElubmVyOiAidWktcGFuZWwtaW5uZXIiLAoJCQltb2RhbDogInVpLXBhbmVsLWRpc21pc3MiLAoJCQltb2RhbE9wZW46ICJ1aS1wYW5lbC1kaXNtaXNzLW9wZW4iLAoJCQlwYWdlUGFuZWw6ICJ1aS1wYWdlLXBhbmVsIiwKCQkJcGFnZVBhbmVsT3BlbjogInVpLXBhZ2UtcGFuZWwtb3BlbiIsCgkJCWNvbnRlbnRXcmFwOiAidWktcGFuZWwtY29udGVudC13cmFwIiwKCQkJY29udGVudFdyYXBPcGVuOiAidWktcGFuZWwtY29udGVudC13cmFwLW9wZW4iLAoJCQljb250ZW50V3JhcENsb3NlZDogInVpLXBhbmVsLWNvbnRlbnQtd3JhcC1jbG9zZWQiLAoJCQljb250ZW50Rml4ZWRUb29sYmFyOiAidWktcGFuZWwtY29udGVudC1maXhlZC10b29sYmFyIiwKCQkJY29udGVudEZpeGVkVG9vbGJhck9wZW46ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXItb3BlbiIsCgkJCWNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQ6ICJ1aS1wYW5lbC1jb250ZW50LWZpeGVkLXRvb2xiYXItY2xvc2VkIiwKCQkJYW5pbWF0ZTogInVpLXBhbmVsLWFuaW1hdGUiCgkJfSwKCQlhbmltYXRlOiB0cnVlLAoJCXRoZW1lOiAiYyIsCgkJcG9zaXRpb246ICJsZWZ0IiwKCQlkaXNtaXNzaWJsZTogdHJ1ZSwKCQlkaXNwbGF5OiAicmV2ZWFsIiwgLy9hY2NlcHRzIHJldmVhbCwgcHVzaCwgb3ZlcmxheQoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3BhbmVsJykiLAoJCXN3aXBlQ2xvc2U6IHRydWUsCgkJcG9zaXRpb25GaXhlZDogZmFsc2UKCX0sCgoJX3BhbmVsSUQ6IG51bGwsCglfY2xvc2VMaW5rOiBudWxsLAoJX3BhZ2U6IG51bGwsCglfbW9kYWw6IG51bGwsCglfcGFuZWxJbm5lcjogbnVsbCwKCV93cmFwcGVyOiBudWxsLAoJX2ZpeGVkVG9vbGJhcjogbnVsbCwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSRlbCA9IHNlbGYuZWxlbWVudCwKCQkJcGFnZSA9ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlfZ2V0UGFnZVRoZW1lID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHRoZW1lID0gJC5kYXRhKCBwYWdlWzBdLCAibW9iaWxlUGFnZSIgKS5vcHRpb25zLnRoZW1lLAoJCQkJJHBhZ2VUaGVtZUNsYXNzID0gInVpLWJvZHktIiArICR0aGVtZTsKCQkJCXJldHVybiAkcGFnZVRoZW1lQ2xhc3M7CgkJCX0sCgkJCV9nZXRQYW5lbElubmVyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJHBhbmVsSW5uZXIgPSAkZWwuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciApOwoJCQkJaWYgKCAkcGFuZWxJbm5lci5sZW5ndGggPT09IDAgKSB7CgkJCQkJJHBhbmVsSW5uZXIgPSAkZWwuY2hpbGRyZW4oKS53cmFwQWxsKCAnPGRpdiBjbGFzcz0iJyArIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKyAnIiAvPicgKS5wYXJlbnQoKTsKCQkJCX0KCQkJCXJldHVybiAkcGFuZWxJbm5lcjsKCQkJfSwKCQkJX2dldFdyYXBwZXIgPSBmdW5jdGlvbigpIHsKCQkJCXZhciAkd3JhcHBlciA9IHBhZ2UuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXAgKTsKCQkJCWlmICggJHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQkJCSR3cmFwcGVyID0gcGFnZS5jaGlsZHJlbiggIi51aS1oZWFkZXI6bm90KDpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpKSwgLnVpLWNvbnRlbnQ6bm90KDpqcW1EYXRhKHJvbGU9J3BvcHVwJykpLCAudWktZm9vdGVyOm5vdCg6anFtRGF0YShwb3NpdGlvbj0nZml4ZWQnKSkiICkud3JhcEFsbCggJzxkaXYgY2xhc3M9IicgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5jb250ZW50V3JhcCArICcgJyArIF9nZXRQYWdlVGhlbWUoKSArICciIC8+JyApLnBhcmVudCgpOwoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCQkJCSR3cmFwcGVyLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICR3cmFwcGVyOwoJCQl9LAoJCQlfZ2V0Rml4ZWRUb29sYmFyID0gZnVuY3Rpb24oKSB7CgkJCQl2YXIgJGZpeGVkVG9vbGJhciA9IHBhZ2UuZmluZCggIi4iICsgc2VsZi5vcHRpb25zLmNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhciApOwoJCQkJaWYgKCAkZml4ZWRUb29sYmFyLmxlbmd0aCA9PT0gMCApIHsKCQkJCQkkZml4ZWRUb29sYmFyID0gcGFnZS5maW5kKCAiLnVpLWhlYWRlcjpqcW1EYXRhKHBvc2l0aW9uPSdmaXhlZCcpLCAudWktZm9vdGVyOmpxbURhdGEocG9zaXRpb249J2ZpeGVkJykiICkuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXIgKTsKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXNlbGYub3B0aW9ucy5hbmltYXRlICkgewoJCQkJCQkkZml4ZWRUb29sYmFyLmFkZENsYXNzKCBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICRmaXhlZFRvb2xiYXI7CgkJCX07CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiAkZWwuYXR0ciggImlkIiApLAoJCQlfY2xvc2VMaW5rOiAkZWwuZmluZCggIjpqcW1EYXRhKHJlbD0nY2xvc2UnKSIgKSwKCQkJX3BhZ2U6ICRlbC5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApLAoJCQlfcGFnZVRoZW1lOiBfZ2V0UGFnZVRoZW1lKCksCgkJCV9wYW5lbElubmVyOiBfZ2V0UGFuZWxJbm5lcigpLAoJCQlfd3JhcHBlcjogX2dldFdyYXBwZXIoKSwKCQkJX2ZpeGVkVG9vbGJhcjogX2dldEZpeGVkVG9vbGJhcigpCgkJfSk7CgkJCgkJc2VsZi5fYWRkUGFuZWxDbGFzc2VzKCk7CgkJc2VsZi5fd3JhcHBlci5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKTsKCQlzZWxmLl9maXhlZFRvb2xiYXIuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKTsKCQkvLyBhZGQgY2xhc3MgdG8gcGFnZSBzbyB3ZSBjYW4gc2V0ICJvdmVyZmxvdy14OiBoaWRkZW47IiBmb3IgaXQgdG8gZml4IEFuZHJvaWQgem9vbSBpc3N1ZQoJCXNlbGYuX3BhZ2UuYWRkQ2xhc3MoIHNlbGYub3B0aW9ucy5jbGFzc2VzLnBhZ2VQYW5lbCApOwoJCQoJCS8vIGlmIGFuaW1hdGluZywgYWRkIHRoZSBjbGFzcyB0byBkbyBzbwoJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhc2VsZi5vcHRpb25zLmFuaW1hdGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggc2VsZi5vcHRpb25zLmNsYXNzZXMuYW5pbWF0ZSApOwoJCX0KCQkKCQlzZWxmLl9iaW5kVXBkYXRlTGF5b3V0KCk7CgkJc2VsZi5fYmluZENsb3NlRXZlbnRzKCk7CgkJc2VsZi5fYmluZExpbmtMaXN0ZW5lcnMoKTsKCQlzZWxmLl9iaW5kUGFnZUV2ZW50cygpOwoKCQlpZiAoICEhc2VsZi5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQlzZWxmLl9jcmVhdGVNb2RhbCgpOwoJCX0KCgkJc2VsZi5fYmluZFN3aXBlRXZlbnRzKCk7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuX21vZGFsID0gJCggIjxkaXYgY2xhc3M9JyIgKyBzZWxmLm9wdGlvbnMuY2xhc3Nlcy5tb2RhbCArICInIGRhdGEtcGFuZWxpZD0nIiArIHNlbGYuX3BhbmVsSUQgKyAiJz48L2Rpdj4iICkKCQkJLm9uKCAibW91c2Vkb3duIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmNsb3NlKCk7CgkJCX0pCgkJCS5hcHBlbmRUbyggdGhpcy5fcGFnZSApOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQ7CgoJCWlmICggdGhpcy5vcHRpb25zLnRoZW1lICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiB1aS1ib2R5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWU7CgkJfQoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCApIHsKCQkJcGFuZWxDbGFzc2VzICs9ICIgIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsRml4ZWQ7CgkJfQoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQoJCXNlbGYuX2Nsb3NlTGluay5vbiggImNsaWNrLnBhbmVsIiAsIGZ1bmN0aW9uKCBlICkgewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJCXNlbGYuY2xvc2UoKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0pOwoJCXNlbGYuZWxlbWVudC5vbiggImNsaWNrLnBhbmVsIiAsICJhOmpxbURhdGEoYWpheD0nZmFsc2UnKSIsIGZ1bmN0aW9uKCBlICkgewoJCQlzZWxmLmNsb3NlKCk7CgkJfSk7CQkKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJc2VsZi5fc2Nyb2xsSW50b1ZpZXcoIHBhbmVsSW5uZXJIZWlnaHQgKTsKCQl9IGVsc2UgewoJCQlzZWxmLl9maXhQYW5lbCgpOwoJCX0KCX0sCgoJX3Njcm9sbEludG9WaWV3OiBmdW5jdGlvbiggcGFuZWxJbm5lckhlaWdodCApIHsKCQlpZiAoIHBhbmVsSW5uZXJIZWlnaHQgPCAkKCB3aW5kb3cgKS5zY3JvbGxUb3AoKSApIHsKCQkJd2luZG93LnNjcm9sbFRvKCAwLCAwICk7CgkJfQkKCX0sCgoJX2JpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb24oICQoIHdpbmRvdyApLCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAiX3Bvc2l0aW9uUGFuZWwiIH0pOwoJfSwKCglfdW5iaW5kRml4TGlzdGVuZXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29mZiggJCggd2luZG93ICksICJ0aHJvdHRsZWRyZXNpemUiICk7Cgl9LAoKCV91bmZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgoJX2ZpeFBhbmVsOiBmdW5jdGlvbigpIHsKCQlpZiAoICEhdGhpcy5vcHRpb25zLnBvc2l0aW9uRml4ZWQgJiYgJC5zdXBwb3J0LmZpeGVkUG9zaXRpb24gKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZCApOwoJCX0KCX0sCgkKCV9iaW5kVXBkYXRlTGF5b3V0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJCgkJc2VsZi5lbGVtZW50Lm9uKCAidXBkYXRlbGF5b3V0IiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJc2VsZi5fcGFnZS5vbiggImNsaWNrLnBhbmVsIiAsICJhIiwgZnVuY3Rpb24oIGUgKSB7CgkJCWlmICggdGhpcy5ocmVmLnNwbGl0KCAiIyIgKVsgMSBdID09PSBzZWxmLl9wYW5lbElEICYmIHNlbGYuX3BhbmVsSUQgIT09IHVuZGVmaW5lZCApIHsKCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCXZhciAkbGluayA9ICQoIHRoaXMgKTsKCQkJCWlmICggISAkbGluay5oYXNDbGFzcyggInVpLWxpbmsiICkgKSB7CgkJCQkJJGxpbmsuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQkJc2VsZi5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJCSRsaW5rLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCX0pOwoJCQkJfQoJCQkJc2VsZi50b2dnbGUoKTsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0pOwoJfSwKCQoJX2JpbmRTd2lwZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlhcmVhID0gc2VsZi5fbW9kYWwgPyBzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl9tb2RhbCApIDogc2VsZi5lbGVtZW50OwoJCQoJCS8vIG9uIHN3aXBlLCBjbG9zZSB0aGUgcGFuZWwKCQlpZiggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbiggZSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCWFyZWEub24oICJzd2lwZXJpZ2h0LnBhbmVsIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0KCQl9Cgl9LAoKCV9iaW5kUGFnZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCQkKCQlzZWxmLl9wYWdlCgkJCS8vIENsb3NlIHRoZSBwYW5lbCBpZiBhbm90aGVyIHBhbmVsIG9uIHRoZSBwYWdlIG9wZW5zCgkJCS5vbiggInBhbmVsYmVmb3Jlb3BlbiIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICYmIGUudGFyZ2V0ICE9PSBzZWxmLmVsZW1lbnRbIDAgXSApIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9CgkJCX0pCgkJCS8vIGNsZWFuIHVwIG9wZW4gcGFuZWxzIGFmdGVyIHBhZ2UgaGlkZQoJCQkub24oICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBzZWxmLl9vcGVuICkgewoJCQkJCXNlbGYuY2xvc2UoIHRydWUgKTsKCQkJCX0KCQkJfSkKCQkJLy8gb24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoKCV9jb250ZW50V3JhcE9wZW5DbGFzc2VzOiBudWxsLAoJX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzOiBudWxsLAoJX21vZGFsT3BlbkNsYXNzZXM6IG51bGwsCgoJb3BlbjogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoICF0aGlzLl9vcGVuICkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQlvID0gc2VsZi5vcHRpb25zLAoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuX3BhZ2Uub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlLmpxbURhdGEoICJwYW5lbCIsICJvcGVuIiApOwoJCQkJCQoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZWxlbWVudC5hZGQoIHNlbGYuX3dyYXBwZXIgKS5vbiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlzZXRUaW1lb3V0KCBjb21wbGV0ZSwgMCApOwoJCQkJCX0KCQkJCQkKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlCgkJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApCgkJCQkJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBzZWxmLm9wdGlvbnMudGhlbWUgKTsKCQkJCQl9CgkJCQkJCgkJCQkJc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsT3BlbiApOwoJCQkJCQoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJCQkKCQkJCQkvLyBGaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCWlmICggc2VsZi5vcHRpb25zLnRoZW1lICYmIHNlbGYub3B0aW9ucy5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIuY3NzKCAibWluLWhlaWdodCIsIHNlbGYuX3BhZ2UuY3NzKCAibWluLWhlaWdodCIgKSApOwoJCQkJCX0KCQkJCQkKCQkJCQlzZWxmLl9jb250ZW50V3JhcE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5jb250ZW50V3JhcCApOwoJCQkJCXNlbGYuX3dyYXBwZXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuY29udGVudFdyYXBDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgKyAiICIgKyBvLmNsYXNzZXMuY29udGVudFdyYXBPcGVuICk7CgkJCQkJCQoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5jb250ZW50Rml4ZWRUb29sYmFyICk7CgkJCQkJc2VsZi5fZml4ZWRUb29sYmFyCgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKQoJCQkJCQkuYWRkQ2xhc3MoIHNlbGYuX2ZpeGVkVG9vbGJhck9wZW5DbGFzc2VzICsgIiAiICsgby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCQkJCQoJCQkJCXNlbGYuX21vZGFsT3BlbkNsYXNzZXMgPSBzZWxmLl9nZXRQb3NEaXNwbGF5Q2xhc3Nlcyggby5jbGFzc2VzLm1vZGFsICkgKyAiICIgKyBvLmNsYXNzZXMubW9kYWxPcGVuOwoJCQkJCWlmICggc2VsZi5fbW9kYWwgKSB7CgkJCQkJCXNlbGYuX21vZGFsLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJc2VsZi5fcGFnZS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCQkKCQkJCQlzZWxmLl9iaW5kRml4TGlzdGVuZXIoKTsKCQkJCQkKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLmxlbmd0aCA8IDAgKSB7CgkJCQlpbW1lZGlhdGUgPSB0cnVlOwoJCQl9CgkJCQoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCQkJCgkJCWlmICggc2VsZi5fcGFnZS5qcW1EYXRhKCdwYW5lbCcpID09PSAib3BlbiIgKSB7CgkJCQlzZWxmLl9wYWdlLm9uKCAicGFuZWxjbG9zZSIsIGZ1bmN0aW9uKCkgewoJCQkJCV9vcGVuUGFuZWwoKTsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJX29wZW5QYW5lbCgpOwoJCQl9CgkJCQoJCQlzZWxmLl9vcGVuID0gdHJ1ZTsKCQl9Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsCgkJCQlzZWxmID0gdGhpcywKCQkJCV9jbG9zZVBhbmVsID0gZnVuY3Rpb24oKSB7CgkJCQkJaWYgKCAhaW1tZWRpYXRlICYmICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQkJc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fd3JhcHBlciApLm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoJCQkJCQoJCQkJCXNlbGYuX3BhZ2UucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlUGFuZWxPcGVuICk7CgkJCQkJc2VsZi5lbGVtZW50LnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgkJCQkJc2VsZi5fd3JhcHBlci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhci5yZW1vdmVDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJPcGVuICk7CgkJCQkJCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoIHNlbGYub3B0aW9ucy50aGVtZSAmJiBzZWxmLm9wdGlvbnMuZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlLnJlbW92ZUNsYXNzKCAidWktYm9keS0iICsgc2VsZi5vcHRpb25zLnRoZW1lICkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VUaGVtZSApOwoJCQkJCQkvLyByZXNldCBmaXggZm9yIElFNyBtaW4taGVpZ2h0IGJ1ZwoJCQkJCQlzZWxmLl93cmFwcGVyLmNzcyggIm1pbi1oZWlnaHQiLCAiIiApOwoJCQkJCX0KCQkJCQlzZWxmLmVsZW1lbnQuYWRkKCBzZWxmLl93cmFwcGVyICkub2ZmKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCXNlbGYuZWxlbWVudC5hZGRDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICk7CgkJCQkJCgkJCQkJc2VsZi5fd3JhcHBlcgoJCQkJCQkucmVtb3ZlQ2xhc3MoIHNlbGYuX2NvbnRlbnRXcmFwT3BlbkNsYXNzZXMgKQoJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb250ZW50V3JhcENsb3NlZCApOwoJCQkJCQkKCQkJCQlzZWxmLl9maXhlZFRvb2xiYXIKCQkJCQkJLnJlbW92ZUNsYXNzKCBzZWxmLl9maXhlZFRvb2xiYXJPcGVuQ2xhc3NlcyApCgkJCQkJCS5hZGRDbGFzcyggby5jbGFzc2VzLmNvbnRlbnRGaXhlZFRvb2xiYXJDbG9zZWQgKTsKCQkJCQkJCgkJCQkJc2VsZi5fZml4UGFuZWwoKTsKCQkJCQlzZWxmLl91bmJpbmRGaXhMaXN0ZW5lcigpOwoJCQkJCSQubW9iaWxlLnJlc2V0QWN0aXZlUGFnZUhlaWdodCgpOwoJCQkJCQoJCQkJCXNlbGYuX3BhZ2UuanFtUmVtb3ZlRGF0YSggInBhbmVsIiApOwoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgkJCQkKCQkJaWYgKCB0aGlzLmVsZW1lbnQuY2xvc2VzdCggIi51aS1wYWdlLWFjdGl2ZSIgKS5sZW5ndGggPCAwICkgewoJCQkJaW1tZWRpYXRlID0gdHJ1ZTsKCQkJfQoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgkKCXRvZ2dsZTogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdGhpc1sgdGhpcy5fb3BlbiA/ICJjbG9zZSIgOiAib3BlbiIgXSgpOwoJfSwKCglfdHJhbnNpdGlvbkVuZEV2ZW50czogIndlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQgb3RyYW5zaXRpb25lbmQgdHJhbnNpdGlvbmVuZCBtc1RyYW5zaXRpb25FbmQiLAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgY2xhc3NlcyA9IHRoaXMub3B0aW9ucy5jbGFzc2VzLAoJCQl0aGVtZSA9IHRoaXMub3B0aW9ucy50aGVtZSwKCQkJaGFzT3RoZXJTaWJsaW5nUGFuZWxzID0gdGhpcy5lbGVtZW50LnNpYmxpbmdzKCAiLiIgKyBjbGFzc2VzLnBhbmVsICkubGVuZ3RoOwoKCQkvLyBjcmVhdGUKCQlpZiAoICFoYXNPdGhlclNpYmxpbmdQYW5lbHMgKSB7CgkJCXRoaXMuX3dyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCQkJdGhpcy5fcGFnZS5maW5kKCAiYSIgKS51bmJpbmQoICJwYW5lbG9wZW4gcGFuZWxjbG9zZSIgKTsKCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggY2xhc3Nlcy5wYWdlUGFuZWwgKTsKCQkJaWYgKCB0aGlzLl9vcGVuICkgewoJCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCQl0aGlzLl9wYWdlLnJlbW92ZUNsYXNzKCBjbGFzc2VzLnBhZ2VQYW5lbE9wZW4gKTsKCQkJCWlmICggdGhlbWUgKSB7CgkJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQkJfQoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9IGVsc2UgaWYgKCB0aGlzLl9vcGVuICkgewoJCQl0aGlzLl93cmFwcGVyLnJlbW92ZUNsYXNzKCBjbGFzc2VzLmNvbnRlbnRXcmFwT3BlbiApOwoJCQl0aGlzLl9maXhlZFRvb2xiYXIucmVtb3ZlQ2xhc3MoIGNsYXNzZXMuY29udGVudEZpeGVkVG9vbGJhck9wZW4gKTsKCQkJdGhpcy5fcGFnZS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgkJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoIGNsYXNzZXMucGFnZVBhbmVsT3BlbiApOwoJCQlpZiAoIHRoZW1lICkgewoJCQkJdGhpcy5fcGFnZS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoZW1lICkuYWRkQ2xhc3MoIHRoaXMuX3BhZ2VUaGVtZSApOwoJCQl9CgkJfQoJCQoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCBbIHRoaXMuX2dldFBhbmVsQ2xhc3NlcygpLCBjbGFzc2VzLnBhbmVsQW5pbWF0ZSBdLmpvaW4oICIgIiApICkKCQkJLm9mZiggInN3aXBlbGVmdC5wYW5lbCBzd2lwZXJpZ2h0LnBhbmVsIiApCgkJCS5vZmYoICJwYW5lbGJlZm9yZW9wZW4iICkKCQkJLm9mZiggInBhbmVsaGlkZSIgKQoJCQkub2ZmKCAia2V5dXAucGFuZWwiICkKCQkJLm9mZiggInVwZGF0ZWxheW91dCIgKTsKCgkJdGhpcy5fY2xvc2VMaW5rLm9mZiggImNsaWNrLnBhbmVsIiApOwoKCQlpZiAoIHRoaXMuX21vZGFsICkgewoJCQl0aGlzLl9tb2RhbC5yZW1vdmUoKTsKCQl9CgoJCS8vIG9wZW4gYW5kIGNsb3NlCgkJdGhpcy5lbGVtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApCgkJCS5yZW1vdmVDbGFzcyggWyBjbGFzc2VzLnBhbmVsVW5maXhlZCwgY2xhc3Nlcy5wYW5lbENsb3NlZCwgY2xhc3Nlcy5wYW5lbE9wZW4gXS5qb2luKCAiICIgKSApOwoJfQp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokKCBkb2N1bWVudCApLmJpbmQoICJwYWdlY3JlYXRlIGNyZWF0ZSIsIGZ1bmN0aW9uKCBlICkgewoJJC5tb2JpbGUucGFuZWwucHJvdG90eXBlLmVuaGFuY2VXaXRoaW4oIGUudGFyZ2V0ICk7Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLndpZGdldCwgewoKCQlvcHRpb25zOiB7CgkJCWNsYXNzZXM6IHsKCQkJCXRhYmxlOiAidWktdGFibGUiCgkJCX0sCgkJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J3RhYmxlJykiCgkJfSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJc2VsZi5yZWZyZXNoKCB0cnVlICk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24gKGNyZWF0ZSkgewoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQl0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQkJaWYgKCBjcmVhdGUgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLnRhYmxlICk7CgkJCX0KCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQlzZWxmLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5IGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJc2VsZi5hbGxIZWFkZXJzID0gc2VsZi5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCgkJCXRycy5lYWNoKGZ1bmN0aW9uKCl7CgoJCQkJdmFyIGNvbHRhbGx5ID0gMDsKCgkJCQkkKCB0aGlzICkuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uKCBpICl7CgoJCQkJCXZhciBzcGFuID0gcGFyc2VJbnQoICQoIHRoaXMgKS5hdHRyKCAiY29sc3BhbiIgKSwgMTAgKSwKCQkJCQkJc2VsID0gIjpudGgtY2hpbGQoIiArICggY29sdGFsbHkgKyAxICkgKyAiKSI7CgkJCQkJJCggdGhpcyApCgkJCQkJCS5qcW1EYXRhKCAiY29sc3RhcnQiLCBjb2x0YWxseSArIDEgKTsKCgkJCQkJaWYoIHNwYW4gKXsKCQkJCQkJZm9yKCB2YXIgaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICl7CgkJCQkJCQljb2x0YWxseSsrOwoJCQkJCQkJc2VsICs9ICIsIDpudGgtY2hpbGQoIiArICggY29sdGFsbHkgKyAxICkgKyAiKSI7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICggY3JlYXRlID09PSB1bmRlZmluZWQgKSB7CgkJCQkJCSQodGhpcykuanFtRGF0YSgiY2VsbHMiLCAiIik7CgkJCQkJfQoJCQkJCS8vIFN0b3JlICJjZWxscyIgZGF0YSBvbiBoZWFkZXIgYXMgYSByZWZlcmVuY2UgdG8gYWxsIGNlbGxzIGluIHRoZSBzYW1lIGNvbHVtbiBhcyB0aGlzIFRICgkJCQkJJCggdGhpcyApCgkJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBzZWxmLmVsZW1lbnQuZmluZCggInRyIiApLm5vdCggdHJzLmVxKDApICkubm90KCB0aGlzICkuY2hpbGRyZW4oIHNlbCApICk7CgoJCQkJCWNvbHRhbGx5Kys7CgoJCQkJfSk7CgoJCQl9KTsKCgkJCS8vIHVwZGF0ZSB0YWJsZSBtb2RlcwoJCQlpZiAoIGNyZWF0ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICdyZWZyZXNoJyApOwoJCQl9Cgl9Cgp9KTsKCi8vYXV0byBzZWxmLWluaXQgd2lkZ2V0cwokLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAicGFnZWNyZWF0ZSBjcmVhdGUiLCBmdW5jdGlvbiggZSApIHsKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5lbmhhbmNlV2l0aGluKCBlLnRhcmdldCApOwp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLm1vZGUgPSAiY29sdW1udG9nZ2xlIjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtbkJ0blRoZW1lID0gbnVsbDsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNvbHVtblBvcHVwVGhlbWUgPSBudWxsOwoKJC5tb2JpbGUudGFibGUucHJvdG90eXBlLm9wdGlvbnMuY29sdW1uQnRuVGV4dCA9ICJDb2x1bW5zLi4uIjsKCiQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMgPSAkLmV4dGVuZCgKCSQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsCgl7CgkJcG9wdXA6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUtcG9wdXAiLAoJCWNvbHVtbkJ0bjogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZS1idG4iLAoJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQljb2x1bW5Ub2dnbGVUYWJsZTogInVpLXRhYmxlLWNvbHVtbnRvZ2dsZSIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgkKCXZhciAkdGFibGUgPSAkKCB0aGlzICksCgkJc2VsZiA9ICR0YWJsZS5kYXRhKCAibW9iaWxlLXRhYmxlIiApLAoJCWV2ZW50ID0gZS50eXBlLAoJCW8gPSBzZWxmLm9wdGlvbnMsCgkJbnMgPSAkLm1vYmlsZS5ucywKCQlpZCA9ICggJHRhYmxlLmF0dHIoICJpZCIgKSB8fCBvLmNsYXNzZXMucG9wdXAgKSArICItcG9wdXAiLCAvKiBUT0RPIEJFVFRFUiBGQUxMQkFDSyBJRCBIRVJFICovCgkJJG1lbnVCdXR0b24sCgkJJHBvcHVwLAoJCSRtZW51LAoJCSRzd2l0Y2hib2FyZDsKCglpZiAoIG8ubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQlzZWxmLmVsZW1lbnQuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5jb2x1bW5Ub2dnbGVUYWJsZSApOwoJCgkJJG1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInIGNsYXNzPSciICsgby5jbGFzc2VzLmNvbHVtbkJ0biArICInIGRhdGEtIiArIG5zICsgInJlbD0ncG9wdXAnIGRhdGEtIiArIG5zICsgIm1pbmk9J3RydWUnPiIgKyBvLmNvbHVtbkJ0blRleHQgKyAiPC9hPiIgKSwKCQkkcG9wdXAgPSAkKCAiPGRpdiBkYXRhLSIgKyBucyArICJyb2xlPSdwb3B1cCcgZGF0YS0iICsgbnMgKyAicm9sZT0nZmllbGRjb250YWluJyBjbGFzcz0nIiArIG8uY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iKSwKCQkkbWVudSA9ICQoIjxmaWVsZHNldCBkYXRhLSIgKyBucyArICJyb2xlPSdjb250cm9sZ3JvdXAnPjwvZmllbGRzZXQ+Iik7Cgl9CgkKCS8vIGNyZWF0ZSB0aGUgaGlkZS9zaG93IHRvZ2dsZXMKCXNlbGYuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKGZ1bmN0aW9uKCBpICkgewoKCQl2YXIgcHJpb3JpdHkgPSAkKCB0aGlzICkuanFtRGF0YSggInByaW9yaXR5IiApLAoJCQkkY2VsbHMgPSAkKCB0aGlzICkuYWRkKCAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApICk7CgoJCWlmICggcHJpb3JpdHkgKSB7CgoJCQkkY2VsbHMuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wcmlvcml0eVByZWZpeCArIHByaW9yaXR5ICk7CgoJCQlpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArICQoIHRoaXMgKS50ZXh0KCkgKyAiPC9sYWJlbD4iICkKCQkJCQkuYXBwZW5kVG8oICRtZW51ICkKCQkJCQkuY2hpbGRyZW4oIDAgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCAkY2VsbHMgKQoJCQkJCS5jaGVja2JveHJhZGlvKHsKCQkJCQkJdGhlbWU6IG8uY29sdW1uUG9wdXBUaGVtZQoJCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJJCggJyMnICsgaWQgKyAnIGZpZWxkc2V0IGRpdjplcSgnICsgaSArJyknKS5maW5kKCdpbnB1dCcpLmpxbURhdGEoICdjZWxscycsICRjZWxscyApOwoJCQl9CgkJfQoJfSk7CgkKCWlmICggZXZlbnQgIT09ICJyZWZyZXNoIiApIHsKCQkkbWVudS5hcHBlbmRUbyggJHBvcHVwICk7Cgl9CgoJLy8gYmluZCBjaGFuZ2UgZXZlbnQgbGlzdGVuZXJzIHRvIGlucHV0cyAtIFRPRE86IG1vdmUgdG8gYSBwcml2YXRlIG1ldGhvZD8KCWlmICggJG1lbnUgPT09IHVuZGVmaW5lZCApIHsKCQkkc3dpdGNoYm9hcmQgPSAkKCcjJyArIGlkICsgJyBmaWVsZHNldCcpOwoJfSBlbHNlIHsKCQkkc3dpdGNoYm9hcmQgPSAkbWVudTsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJJHN3aXRjaGJvYXJkLm9uKCAiY2hhbmdlIiwgImlucHV0IiwgZnVuY3Rpb24oIGUgKXsKCQkJaWYoIHRoaXMuY2hlY2tlZCApewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApLmFkZENsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiApOwoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtdmlzaWJsZSIgKS5hZGRDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIiApOwoJCQl9CgkJfSk7CgoJCSRtZW51QnV0dG9uCgkJCS5pbnNlcnRCZWZvcmUoICR0YWJsZSApCgkJCS5idXR0b25NYXJrdXAoewoJCQkJdGhlbWU6IG8uY29sdW1uQnRuVGhlbWUKCQkJfSk7CgoJCSRwb3B1cAoJCQkuaW5zZXJ0QmVmb3JlKCAkdGFibGUgKQoJCQkucG9wdXAoKTsKCX0KCgkvLyByZWZyZXNoIG1ldGhvZAoJc2VsZi51cGRhdGUgPSBmdW5jdGlvbigpewoJCSRzd2l0Y2hib2FyZC5maW5kKCAiaW5wdXQiICkuZWFjaCggZnVuY3Rpb24oKXsKCQkJaWYgKHRoaXMuY2hlY2tlZCkgewoJCQkJdGhpcy5jaGVja2VkID0gJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5lcSgwKS5jc3MoICJkaXNwbGF5IiApID09PSAidGFibGUtY2VsbCI7CgkJCQlpZiAoZXZlbnQgPT09ICJyZWZyZXNoIikgewoJCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiICkuYWRkQ2xhc3MoJ3VpLXRhYmxlLWNlbGwtdmlzaWJsZScpOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJJCggdGhpcyApLmpxbURhdGEoICJjZWxscyIgKS5hZGRDbGFzcygndWktdGFibGUtY2VsbC1oaWRkZW4nKTsKCQkJfQoJCQkkKCB0aGlzICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfSk7Cgl9OwoKCSQubW9iaWxlLndpbmRvdy5vbiggInRocm90dGxlZHJlc2l6ZSIsIHNlbGYudXBkYXRlICk7CgoJc2VsZi51cGRhdGUoKTsKCn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5tb2RlID0gInJlZmxvdyI7CgokLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzID0gJC5leHRlbmQoCgkkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLAoJewoJCXJlZmxvd1RhYmxlOiAidWktdGFibGUtcmVmbG93IiwKCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCX0KKTsKCiQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiOmpxbURhdGEocm9sZT0ndGFibGUnKSIsICJ0YWJsZWNyZWF0ZSByZWZyZXNoIiwgZnVuY3Rpb24oIGUgKSB7CgoJdmFyICR0YWJsZSA9ICQoIHRoaXMgKSwKCQlldmVudCA9IGUudHlwZSwKCQlzZWxmID0gJHRhYmxlLmRhdGEoICJtb2JpbGUtdGFibGUiICksCgkJbyA9IHNlbGYub3B0aW9uczsKCgkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCglpZiggby5tb2RlICE9PSAicmVmbG93IiApewoJCXJldHVybjsKCX0KCglpZiAoIGV2ZW50ICE9PSAicmVmcmVzaCIgKSB7CgkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucmVmbG93VGFibGUgKTsKCX0KCgkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCXZhciByZXZlcnNlSGVhZGVycyA9ICAkKCBzZWxmLmFsbEhlYWRlcnMuZ2V0KCkucmV2ZXJzZSgpICk7CgoJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJcmV2ZXJzZUhlYWRlcnMuZWFjaChmdW5jdGlvbiggaSApewoJCXZhciAkY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQljb2xzdGFydCA9ICQoIHRoaXMgKS5qcW1EYXRhKCAiY29sc3RhcnQiICksCgkJCWhpZXJhcmNoeUNsYXNzID0gJGNlbGxzLm5vdCggdGhpcyApLmZpbHRlciggInRoZWFkIHRoIiApLmxlbmd0aCAmJiAiIHVpLXRhYmxlLWNlbGwtbGFiZWwtdG9wIiwKCQkJdGV4dCA9ICQodGhpcykudGV4dCgpOwoKCQkJaWYoIHRleHQgIT09ICIiICApewoKCQkJCWlmKCBoaWVyYXJjaHlDbGFzcyApewoJCQkJCXZhciBpdGVyYXRpb24gPSBwYXJzZUludCggJCggdGhpcyApLmF0dHIoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCQlmaWx0ZXIgPSAiIjsKCgkJCQkJaWYoIGl0ZXJhdGlvbiApewoJCQkJCQlmaWx0ZXIgPSAidGQ6bnRoLWNoaWxkKCIrIGl0ZXJhdGlvbiArIm4gKyAiICsgKCBjb2xzdGFydCApICsiKSI7CgkJCQkJfQoJCQkJCSRjZWxscy5maWx0ZXIoIGZpbHRlciApLnByZXBlbmQoICI8YiBjbGFzcz0nIiArIG8uY2xhc3Nlcy5jZWxsTGFiZWxzICsgaGllcmFyY2h5Q2xhc3MgKyAiJz4iICsgdGV4dCArICI8L2I+IiAgKTsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCSRjZWxscy5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBvLmNsYXNzZXMuY2VsbExhYmVscyArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJCQkJfQoKCQkJfQoJfSk7Cgp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93ICkgewoKCSQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCA9IHRydWU7CgoJLy8gVGhpcyBmaXggYWRkcmVzc2VzIGFuIGlPUyBidWcsIHNvIHJldHVybiBlYXJseSBpZiB0aGUgVUEgY2xhaW1zIGl0J3Mgc29tZXRoaW5nIGVsc2UuCgl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJaWYoICEoIC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiAvT1MgWzEtNV1fWzAtOV9dKiBsaWtlIE1hYyBPUyBYL2kudGVzdCggdWEgKSAmJiB1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSApICl7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXZhciB6b29tID0gJC5tb2JpbGUuem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCglmdW5jdGlvbiBjaGVja1RpbHQoIGUgKSB7CgkJZXZ0ID0gZS5vcmlnaW5hbEV2ZW50OwoJCWFpZyA9IGV2dC5hY2NlbGVyYXRpb25JbmNsdWRpbmdHcmF2aXR5OwoKCQl4ID0gTWF0aC5hYnMoIGFpZy54ICk7CgkJeSA9IE1hdGguYWJzKCBhaWcueSApOwoJCXogPSBNYXRoLmFicyggYWlnLnogKTsKCgkJLy8gSWYgcG9ydHJhaXQgb3JpZW50YXRpb24gYW5kIGluIG9uZSBvZiB0aGUgZGFuZ2VyIHpvbmVzCgkJaWYgKCAhd2luZG93Lm9yaWVudGF0aW9uICYmICggeCA+IDcgfHwgKCAoIHogPiA2ICYmIHkgPCA4IHx8IHogPCA4ICYmIHkgPiA2ICkgJiYgeCA+IDUgKSApICkgewoJCQkJaWYgKCB6b29tLmVuYWJsZWQgKSB7CgkJCQkJem9vbS5kaXNhYmxlKCk7CgkJCQl9CgkJfQllbHNlIGlmICggIXpvb20uZW5hYmxlZCApIHsKCQkJCXpvb20uZW5hYmxlKCk7CgkJfQoJfQoKCSQubW9iaWxlLmRvY3VtZW50Lm9uKCAibW9iaWxlaW5pdCIsIGZ1bmN0aW9uKCl7CgkJaWYoICQubW9iaWxlLmlvc29yaWVudGF0aW9uZml4RW5hYmxlZCApewoJCQkkLm1vYmlsZS53aW5kb3cKCQkJCS5iaW5kKCAib3JpZW50YXRpb25jaGFuZ2UuaW9zb3JpZW50YXRpb25maXgiLCB6b29tLmVuYWJsZSApCgkJCQkuYmluZCggImRldmljZW1vdGlvbi5pb3NvcmllbnRhdGlvbmZpeCIsIGNoZWNrVGlsdCApOwoJCX0KCX0pOwoKfSggalF1ZXJ5LCB0aGlzICkpOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhcgkkaHRtbCA9ICQoICJodG1sIiApLAoJCQkkaGVhZCA9ICQoICJoZWFkIiApLAoJCQkkd2luZG93ID0gJC5tb2JpbGUud2luZG93OwoKCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCWZ1bmN0aW9uIGhpZGVSZW5kZXJpbmdDbGFzcygpIHsKCQkkaHRtbC5yZW1vdmVDbGFzcyggInVpLW1vYmlsZS1yZW5kZXJpbmciICk7Cgl9CgoJLy8gdHJpZ2dlciBtb2JpbGVpbml0IGV2ZW50IC0gdXNlZnVsIGhvb2sgZm9yIGNvbmZpZ3VyaW5nICQubW9iaWxlIHNldHRpbmdzIGJlZm9yZSB0aGV5J3JlIHVzZWQKCSQoIHdpbmRvdy5kb2N1bWVudCApLnRyaWdnZXIoICJtb2JpbGVpbml0IiApOwoKCS8vIHN1cHBvcnQgY29uZGl0aW9ucwoJLy8gaWYgZGV2aWNlIHN1cHBvcnQgY29uZGl0aW9uKHMpIGFyZW4ndCBtZXQsIGxlYXZlIHRoaW5ncyBhcyB0aGV5IGFyZSAtPiBhIGJhc2ljLCB1c2FibGUgZXhwZXJpZW5jZSwKCS8vIG90aGVyd2lzZSwgcHJvY2VlZCB3aXRoIHRoZSBlbmhhbmNlbWVudHMKCWlmICggISQubW9iaWxlLmdyYWRlQSgpICkgewoJCXJldHVybjsKCX0KCgkvLyBvdmVycmlkZSBhamF4RW5hYmxlZCBvbiBwbGF0Zm9ybXMgdGhhdCBoYXZlIGtub3duIGNvbmZsaWN0cyB3aXRoIGhhc2ggaGlzdG9yeSB1cGRhdGVzCgkvLyBvciBnZW5lcmFsbHkgd29yayBiZXR0ZXIgYnJvd3NpbmcgaW4gcmVndWxhciBodHRwIGZvciBmdWxsIHBhZ2UgcmVmcmVzaGVzIChCQjUsIE9wZXJhIE1pbmkpCglpZiAoICQubW9iaWxlLmFqYXhCbGFja2xpc3QgKSB7CgkJJC5tb2JpbGUuYWpheEVuYWJsZWQgPSBmYWxzZTsKCX0KCgkvLyBBZGQgbW9iaWxlLCBpbml0aWFsIGxvYWQgInJlbmRlcmluZyIgY2xhc3NlcyB0byBkb2NFbAoJJGh0bWwuYWRkQ2xhc3MoICJ1aS1tb2JpbGUgdWktbW9iaWxlLXJlbmRlcmluZyIgKTsKCgkvLyBUaGlzIGlzIGEgZmFsbGJhY2suIElmIGFueXRoaW5nIGdvZXMgd3JvbmcgKEpTIGVycm9ycywgZXRjKSwgb3IgZXZlbnRzIGRvbid0IGZpcmUsCgkvLyB0aGlzIGVuc3VyZXMgdGhlIHJlbmRlcmluZyBjbGFzcyBpcyByZW1vdmVkIGFmdGVyIDUgc2Vjb25kcywgc28gY29udGVudCBpcyB2aXNpYmxlIGFuZCBhY2Nlc3NpYmxlCglzZXRUaW1lb3V0KCBoaWRlUmVuZGVyaW5nQ2xhc3MsIDUwMDAgKTsKCgkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCQkvLyBmaW5kIGFuZCBlbmhhbmNlIHRoZSBwYWdlcyBpbiB0aGUgZG9tIGFuZCB0cmFuc2l0aW9uIHRvIHRoZSBmaXJzdCBwYWdlLgoJCWluaXRpYWxpemVQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gZmluZCBwcmVzZW50IHBhZ2VzCgkJCXZhciBwYXRoID0gJC5tb2JpbGUucGF0aCwKCQkJCSRwYWdlcyA9ICQoICI6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApLAoJCQkJaGFzaCA9IHBhdGguc3RyaXBIYXNoKCBwYXRoLnN0cmlwUXVlcnlQYXJhbXMocGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaCkgKSwKCQkJCWhhc2hQYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIGhhc2ggKTsKCgkJCS8vIGlmIG5vIHBhZ2VzIGFyZSBmb3VuZCwgY3JlYXRlIG9uZSB3aXRoIGJvZHkncyBpbm5lciBodG1sCgkJCWlmICggISRwYWdlcy5sZW5ndGggKSB7CgkJCQkkcGFnZXMgPSAkKCAiYm9keSIgKS53cmFwSW5uZXIoICI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnPjwvZGl2PiIgKS5jaGlsZHJlbiggMCApOwoJCQl9CgoJCQkvLyBhZGQgZGlhbG9ncywgc2V0IGRhdGEtdXJsIGF0dHJzCgkJCSRwYWdlcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICR0aGlzID0gJCggdGhpcyApOwoKCQkJCS8vIHVubGVzcyB0aGUgZGF0YSB1cmwgaXMgYWxyZWFkeSBzZXQgc2V0IGl0IHRvIHRoZSBwYXRobmFtZQoJCQkJaWYgKCAhJHRoaXMuanFtRGF0YSggInVybCIgKSApIHsKCQkJCQkkdGhpcy5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiwgJHRoaXMuYXR0ciggImlkIiApIHx8IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoICk7CgkJCQl9CgkJCX0pOwoKCQkJLy8gZGVmaW5lIGZpcnN0IHBhZ2UgaW4gZG9tIGNhc2Ugb25lIGJhY2tzIG91dCB0byB0aGUgZGlyZWN0b3J5IHJvb3QgKG5vdCBhbHdheXMgdGhlIGZpcnN0IHBhZ2UgdmlzaXRlZCwgYnV0IGRlZmluZWQgYXMgZmFsbGJhY2spCgkJCSQubW9iaWxlLmZpcnN0UGFnZSA9ICRwYWdlcy5maXJzdCgpOwoKCQkJLy8gZGVmaW5lIHBhZ2UgY29udGFpbmVyCgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIgPSAkLm1vYmlsZS5maXJzdFBhZ2UucGFyZW50KCkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5zaG93UGFnZUxvYWRpbmdNc2coKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAnOmpxbURhdGEocm9sZT0icGFnZSIpJyApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS51cmxIaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiggJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlLm5hdmlnYXRvci5zcXVhc2goIHBhdGgucGFyc2VMb2NhdGlvbigpLmhyZWYgKTsKCQkJCX0KCgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlKCAkLm1vYmlsZS5maXJzdFBhZ2UsIHsKCQkJCQl0cmFuc2l0aW9uOiAibm9uZSIsCgkJCQkJcmV2ZXJzZTogdHJ1ZSwKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZQoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQkvLyB0cmlnZ2VyIGhhc2hjaGFuZ2Ugb3IgbmF2aWdhdGUgdG8gc3F1YXNoIGFuZCByZWNvcmQgdGhlIGNvcnJlY3QKCQkJCS8vIGhpc3RvcnkgZW50cnkgZm9yIGFuIGluaXRpYWwgaGFzaCBwYXRoCgkJCQlpZiggISQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkd2luZG93LnRyaWdnZXIoICJoYXNoY2hhbmdlIiwgW3RydWVdICk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIFRPRE8gZmlndXJlIG91dCBob3cgdG8gc2ltcGxpZnkgdGhpcyBpbnRlcmFjdGlvbiB3aXRoIHRoZSBpbml0aWFsIGhpc3RvcnkgZW50cnkKCQkJCQkvLyBhdCB0aGUgYm90dG9tIGpzL25hdmlnYXRlL25hdmlnYXRlLmpzCgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5zdGFjayA9IFtdOwoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCAkLm1vYmlsZS5wYXRoLmlzUGF0aCggbG9jYXRpb24uaGFzaCApID8gbG9jYXRpb24uaGFzaCA6IGxvY2F0aW9uLmhyZWYgKTsKCQkJCX0KCQkJfQoJCX0KCX0pOwoKCS8vIGluaXRpYWxpemUgZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOwoKCS8vIGNoZWNrIHdoaWNoIHNjcm9sbFRvcCB2YWx1ZSBzaG91bGQgYmUgdXNlZCBieSBzY3JvbGxpbmcgdG8gMSBpbW1lZGlhdGVseSBhdCBkb21yZWFkeQoJLy8gdGhlbiBjaGVjayB3aGF0IHRoZSBzY3JvbGwgdG9wIGlzLiBBbmRyb2lkIHdpbGwgcmVwb3J0IDAuLi4gb3RoZXJzIDEKCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCSQoZnVuY3Rpb24oKSB7CgkJd2luZG93LnNjcm9sbFRvKCAwLCAxICk7CgoJCS8vIGlmIGRlZmF1bHRIb21lU2Nyb2xsIGhhc24ndCBiZWVuIHNldCB5ZXQsIHNlZSBpZiBzY3JvbGxUb3AgaXMgMQoJCS8vIGl0IHNob3VsZCBiZSAxIGluIG1vc3QgYnJvd3NlcnMsIGJ1dCBhbmRyb2lkIHRyZWF0cyAxIGFzIDAgKGZvciBoaWRpbmcgYWRkciBiYXIpCgkJLy8gc28gaWYgaXQncyAxLCB1c2UgMCBmcm9tIG5vdyBvbgoJCSQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsID0gKCAhJC5zdXBwb3J0LnNjcm9sbFRvcCB8fCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCkgPT09IDEgKSA/IDAgOiAxOwoKCQkvL2RvbS1yZWFkeSBpbml0cwoJCWlmICggJC5tb2JpbGUuYXV0b0luaXRpYWxpemVQYWdlICkgewoJCQkkLm1vYmlsZS5pbml0aWFsaXplUGFnZSgpOwoJCX0KCgkJLy8gd2luZG93IGxvYWQgZXZlbnQKCQkvLyBoaWRlIGlPUyBicm93c2VyIGNocm9tZSBvbiBsb2FkCgkJJHdpbmRvdy5sb2FkKCAkLm1vYmlsZS5zaWxlbnRTY3JvbGwgKTsKCgkJaWYgKCAhJC5zdXBwb3J0LmNzc1BvaW50ZXJFdmVudHMgKSB7CgkJCS8vIElFIGFuZCBPcGVyYSBkb24ndCBzdXBwb3J0IENTUyBwb2ludGVyLWV2ZW50czogbm9uZSB0aGF0IHdlIHVzZSB0byBkaXNhYmxlIGxpbmstYmFzZWQgYnV0dG9ucwoJCQkvLyBieSBhZGRpbmcgdGhlICd1aS1kaXNhYmxlZCcgY2xhc3MgdG8gdGhlbS4gVXNpbmcgYSBKYXZhU2NyaXB0IHdvcmthcm91bmQgZm9yIHRob3NlIGJyb3dzZXIuCgkJCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzU1OAoKCQkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICIudWktZGlzYWJsZWQiLCAidmNsaWNrIiwKCQkJCWZ1bmN0aW9uKCBlICkgewoJCQkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJCQllLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJfQoJCQkpOwoJCX0KCX0pOwp9KCBqUXVlcnksIHRoaXMgKSk7CgoKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Length": "359006",
                    "Date": "Fri, 07 Nov 2014 06:49:43 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}