{
    "url": "http://localhost:9999/ActivKonnect/wrapframe/src/wrapframe.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>window.location.href</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>element.href = window.location.href;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ActivKonnect/wrapframe/src/wrapframe.js",
                "path": "/ActivKonnect/wrapframe/src/wrapframe.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9BY3Rpdktvbm5lY3Qvd3JhcGZyYW1lL3NyYy93cmFwZnJhbWUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTUzMzQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6MTY6MDkgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjE2OjA5IEdNVA0KDQovKmpzbGludCBpbmRlbnQ6IDQsIG1heGxlbjogMTAwLCB2YXJzOiB0cnVlLCBicm93c2VyOiB0cnVlICovCgooZnVuY3Rpb24gKGRvY3VtZW50LCB3aW5kb3csIG5hdmlnYXRvciwgcm9vdCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8vIENvbnN0YW50cwogICAgdmFyIE1FU1NFTkdFUl9BR0VOVCA9ICdXcmFwRnJhbWVNZXNzZW5nZXInLAogICAgICAgIEVOQUJMRV9FVkVOVCA9ICdXcmFwRnJhbWUuZW5hYmxlJywKICAgICAgICBSRVNJWkVfRVZFTlQgPSAnV3JhcEZyYW1lLnJlc2l6ZScsCiAgICAgICAgU0NST0xMX0VWRU5UID0gJ1dyYXBGcmFtZS5zY3JvbGwnLAogICAgICAgIEVOQUJMRV9NU0cgPSAnZW5hYmxlJywKICAgICAgICBFTkFCTEVEX01TRyA9ICdlbmFibGVkJywKICAgICAgICBSRUZSRVNIX1JBVEUgPSAxMDAwMCAvIDYwOwoKICAgIC8vIE1lbWJlcnMKICAgIHZhciB3ZlNlbGYgPSB7fSwKICAgICAgICBpZVZlcnNpb24sCiAgICAgICAgb2xkSWUsCiAgICAgICAgbm90U29PbGRJZSwKICAgICAgICBteVVuZGVmaW5lZDsKCiAgICAvLyBPYmplY3RzCiAgICB2YXIgTWVzc2VuZ2VyLCBJZnJhbWUsIEluc2lkZTsKCiAgICAvLyBNZXRob2RzCiAgICB2YXIgY2hlY2tJZVZlcnNpb24sCiAgICAgICAgZ2V0TWFyZ2luLAogICAgICAgIGdldEVsZW1lbnRCb3VuZGluZ0JveCwKICAgICAgICBvbkhhc2hDaGFuZ2UsCiAgICAgICAgb25FdmVudCwKICAgICAgICBwYXJzZVVybCwKICAgICAgICBvcmlnaW5PZlVybCwKICAgICAgICBpbnNpZGUsCiAgICAgICAgZ2VuZXNpczsKCiAgICAvLyBPYmplY3RzIGJvZGllcwogICAgTWVzc2VuZ2VyID0gZnVuY3Rpb24gKG9iamVjdCwgY2hhbm5lbCwgdGFyZ2V0KSB7CiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgICAgICByZWNlaXZlQ2FsbGJhY2tzID0gW107CgogICAgICAgIHZhciBzZW5kLCBvblJlY2VpdmUsIGRpc3BhdGNoTWVzc2FnZSwgZW5jb2RlLCBkZWNvZGU7CgogICAgICAgIGlmIChvbGRJZSkgewogICAgICAgICAgICBlbmNvZGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGRhdGEpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZGVjb2RlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpOwogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGVuY29kZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRlY29kZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YTsKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIHNlbmQgPSBmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICBvYmplY3QucG9zdE1lc3NhZ2UoZW5jb2RlKHsKICAgICAgICAgICAgICAgIGFnZW50OiBNRVNTRU5HRVJfQUdFTlQsCiAgICAgICAgICAgICAgICBjaGFubmVsOiBjaGFubmVsLAogICAgICAgICAgICAgICAgcGF5bG9hZDogbWVzc2FnZQogICAgICAgICAgICB9KSwgdGFyZ2V0KTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgfTsKCiAgICAgICAgb25SZWNlaXZlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHJlY2VpdmVDYWxsYmFja3MucHVzaChjYWxsYmFjayk7CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIH07CgogICAgICAgIGRpc3BhdGNoTWVzc2FnZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICB2YXIgbWVzc2FnZSwgaTsKCiAgICAgICAgICAgIGlmIChldmVudC5vcmlnaW4gPT09IHRhcmdldCkgewogICAgICAgICAgICAgICAgbWVzc2FnZSA9IGRlY29kZShldmVudC5kYXRhKTsKCiAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5hZ2VudCA9PT0gTUVTU0VOR0VSX0FHRU5UICYmIG1lc3NhZ2UuY2hhbm5lbCA9PT0gY2hhbm5lbCkgewogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCByZWNlaXZlQ2FsbGJhY2tzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpdmVDYWxsYmFja3NbaV0obWVzc2FnZS5wYXlsb2FkKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZWxmLnNlbmQgPSBzZW5kOwogICAgICAgIHNlbGYub25SZWNlaXZlID0gb25SZWNlaXZlOwoKICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvbkV2ZW50KHdpbmRvdywgJ21lc3NhZ2UnLCBkaXNwYXRjaE1lc3NhZ2UsIGZhbHNlKTsKICAgICAgICB9KCkpOwogICAgfTsKCiAgICBJZnJhbWUgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0cykgewogICAgICAgIC8vIE1lbWJlcnMKICAgICAgICB2YXIgaWZyYW1lLAogICAgICAgICAgICBzZXR0aW5ncyA9IHsKICAgICAgICAgICAgICAgIGZvbGxvd1dpZHRoOiBvcHRzLmhhc093blByb3BlcnR5KCdmb2xsb3dXaWR0aCcpID8gb3B0cy5mb2xsb3dXaWR0aCA6IGZhbHNlLAogICAgICAgICAgICAgICAgZm9sbG93SGVpZ2h0OiBvcHRzLmhhc093blByb3BlcnR5KCdmb2xsb3dIZWlnaHQnKSA/IG9wdHMuZm9sbG93SGVpZ2h0IDogdHJ1ZSwKICAgICAgICAgICAgICAgIHNjcm9sbFRvOiBvcHRzLmhhc093blByb3BlcnR5KCdzY3JvbGxUbycpID8gb3B0cy5zY3JvbGxUbyA6IFswLCAwXSwKICAgICAgICAgICAgICAgIHNyYzogb3B0cy5zcmMKICAgICAgICAgICAgfTsKCiAgICAgICAgLy8gTWV0aG9kcwogICAgICAgIHZhciBnZW5lc2lzLCB1cGRhdGVTaXplLCBoYW5kbGVFbmFibGluZywgc2Nyb2xsLCBnZXRTY3JvbGxUb3AsIGdldFNjcm9sbExlZnQ7CgogICAgICAgIC8vIE1ldGhvZHMgYm9kaWVzCiAgICAgICAgZ2VuZXNpcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWZyYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaWZyYW1lJyk7CiAgICAgICAgICAgIGlmcmFtZS5zcmMgPSBzZXR0aW5ncy5zcmM7CiAgICAgICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ3Njcm9sbGluZycsICdubycpOwogICAgICAgICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdmcmFtZWJvcmRlcicsICcwJyk7CiAgICAgICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgJzEwMCUnKTsKICAgICAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgJzEwMCUnKTsKICAgICAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnc3R5bGUnLAogICAgICAgICAgICAgICAgJ3dpZHRoOiAxMDAlOyAnICsKICAgICAgICAgICAgICAgICdoZWlnaHQ6IDEwMCU7ICcgKwogICAgICAgICAgICAgICAgJ2JvcmRlcjogbm9uZTsgJyArCiAgICAgICAgICAgICAgICAncGFkZGluZzogMDsgJyArCiAgICAgICAgICAgICAgICAnbWFyZ2luOiAwOyAnICsKICAgICAgICAgICAgICAgICdvdmVyZmxvdzogaGlkZGVuOycpOwoKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChpZnJhbWUpOwogICAgICAgIH07CgogICAgICAgIHVwZGF0ZVNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewogICAgICAgICAgICBpZiAoc2V0dGluZ3MuZm9sbG93V2lkdGgpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChzZXR0aW5ncy5mb2xsb3dIZWlnaHQpIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGdldFNjcm9sbFRvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCwgYiwgZDsKCiAgICAgICAgICAgIGlmICh3aW5kb3cucGFnZVlPZmZzZXQgIT09IG15VW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB3aW5kb3cucGFnZVlPZmZzZXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiID0gZG9jdW1lbnQuYm9keTsKICAgICAgICAgICAgICAgIGQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICBkID0gKGQuY2xpZW50SGVpZ2h0KSA/IGQgOiBiOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gZC5zY3JvbGxUb3A7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfTsKCiAgICAgICAgZ2V0U2Nyb2xsTGVmdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIG91dHB1dCwgYiwgZDsKCiAgICAgICAgICAgIGlmICh3aW5kb3cucGFnZVhPZmZzZXQgIT09IG15VW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSB3aW5kb3cucGFnZVhPZmZzZXQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBiID0gZG9jdW1lbnQuYm9keTsKICAgICAgICAgICAgICAgIGQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICBkID0gKGQuY2xpZW50V2lkdGgpID8gZCA6IGI7CiAgICAgICAgICAgICAgICBvdXRwdXQgPSBkLnNjcm9sbEhlaWdodDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9OwoKICAgICAgICBzY3JvbGwgPSBmdW5jdGlvbiAobW9kZSwgYXJncykgewogICAgICAgICAgICB2YXIgaWZyYW1lQmJveCwgdGFyZ2V0ID0gW107CgogICAgICAgICAgICBmdW5jdGlvbiBjYWxjdWxhdGVTY3JvbGwoYXJnLCBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHZhciBvdXRwdXQ7CgogICAgICAgICAgICAgICAgaWYgKGFyZyA8IDApIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSAwOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvZmZzZXQgKyBhcmc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG1vZGUgPT09ICd0bycpIHsKICAgICAgICAgICAgICAgIGlmcmFtZUJib3ggPSBpZnJhbWUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CgogICAgICAgICAgICAgICAgdGFyZ2V0WzBdID0gY2FsY3VsYXRlU2Nyb2xsKGFyZ3NbMF0sIGdldFNjcm9sbExlZnQoKSArIGlmcmFtZUJib3gubGVmdCk7CiAgICAgICAgICAgICAgICB0YXJnZXRbMV0gPSBjYWxjdWxhdGVTY3JvbGwoYXJnc1sxXSwgZ2V0U2Nyb2xsVG9wKCkgKyBpZnJhbWVCYm94LnRvcCk7CgogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKHRhcmdldFswXSwgdGFyZ2V0WzFdKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtb2RlID09PSAnYnknKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkoYXJnc1swXSwgYXJnc1sxXSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2J5LWxpbmVzJykgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbEJ5TGluZXMoYXJnc1swXSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2FuY2hvcicpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gYXJnc1swXTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGhhbmRsZUVuYWJsaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0T3JpZ2luID0gb3JpZ2luT2ZVcmwoc2V0dGluZ3Muc3JjKSwKICAgICAgICAgICAgICAgIGFjdGl2YXRpb25NYW5hZ2VyID0gbmV3IE1lc3NlbmdlcigKICAgICAgICAgICAgICAgICAgICBpZnJhbWUuY29udGVudFdpbmRvdywKICAgICAgICAgICAgICAgICAgICBFTkFCTEVfRVZFTlQsCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0T3JpZ2luCiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgZW5hYmxlZCA9IGZhbHNlOwoKICAgICAgICAgICAgZnVuY3Rpb24gZW5hYmxlKCkgewogICAgICAgICAgICAgICAgaWYgKCFlbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZhdGlvbk1hbmFnZXIuc2VuZChFTkFCTEVfTVNHKTsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGVuYWJsZSwgUkVGUkVTSF9SQVRFKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYWN0aXZhdGlvbk1hbmFnZXIub25SZWNlaXZlKGZ1bmN0aW9uIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBpZiAobWVzc2FnZSA9PT0gRU5BQkxFRF9NU0cpIHsKICAgICAgICAgICAgICAgICAgICBlbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBvbkV2ZW50KGlmcmFtZSwgJ2xvYWQnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBlbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBlbmFibGUoKTsKICAgICAgICAgICAgICAgIHNjcm9sbCgndG8nLCBzZXR0aW5ncy5zY3JvbGxUbyk7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9OwoKICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0T3JpZ2luID0gb3JpZ2luT2ZVcmwoc2V0dGluZ3Muc3JjKTsKCiAgICAgICAgICAgIGdlbmVzaXMoKTsKICAgICAgICAgICAgaGFuZGxlRW5hYmxpbmcoKTsKCiAgICAgICAgICAgIG5ldyBNZXNzZW5nZXIoaWZyYW1lLmNvbnRlbnRXaW5kb3csIFJFU0laRV9FVkVOVCwgdGFyZ2V0T3JpZ2luKQogICAgICAgICAgICAgICAgLm9uUmVjZWl2ZShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVNpemUobWVzc2FnZVswXSwgbWVzc2FnZVsxXSk7CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIG5ldyBNZXNzZW5nZXIoaWZyYW1lLmNvbnRlbnRXaW5kb3csIFNDUk9MTF9FVkVOVCwgdGFyZ2V0T3JpZ2luKQogICAgICAgICAgICAgICAgLm9uUmVjZWl2ZShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgIHNjcm9sbChtZXNzYWdlLm1vZGUsIG1lc3NhZ2UuYXJncyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICB9KCkpOwogICAgfTsKCiAgICBJbnNpZGUgPSBmdW5jdGlvbiAob3JpZ2luLCBvbkVuYWJsZSwgb3B0cykgewogICAgICAgIC8vIE1lbWJlcnMKICAgICAgICB2YXIgc2V0dGluZ3MsCiAgICAgICAgICAgIHNpemVNZXNzZW5nZXIgPSBuZXcgTWVzc2VuZ2VyKHdpbmRvdy5wYXJlbnQsIFJFU0laRV9FVkVOVCwgb3JpZ2luKSwKICAgICAgICAgICAgc2Nyb2xsTWVzc2VuZ2VyID0gbmV3IE1lc3Nlbmdlcih3aW5kb3cucGFyZW50LCBTQ1JPTExfRVZFTlQsIG9yaWdpbiksCiAgICAgICAgICAgIHJ1bk9uRW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCA+PSAyLAogICAgICAgICAgICBlbmFibGVkID0gZmFsc2U7CgogICAgICAgIC8vIE1ldGhvZHMKICAgICAgICB2YXIgZW5hYmxlLAogICAgICAgICAgICBnZXREb2N1bWVudFNpemUsCiAgICAgICAgICAgIG9uRG9jdW1lbnRTaXplQ2hhbmdlLAogICAgICAgICAgICBoaWphY2tTdHlsZSwKICAgICAgICAgICAgaGlqYWNrU2Nyb2xsLAogICAgICAgICAgICBzY3JvbGwsCiAgICAgICAgICAgIHNjcm9sbFRvLAogICAgICAgICAgICBzY3JvbGxCeSwKICAgICAgICAgICAgc2Nyb2xsQnlMaW5lcywKICAgICAgICAgICAgc2Nyb2xsVG9BbmNob3I7CgogICAgICAgIC8vIE1ldGhvZCBib2RpZXMKICAgICAgICBlbmFibGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIG9uRG9jdW1lbnRTaXplQ2hhbmdlKHNpemVNZXNzZW5nZXIuc2VuZCk7CiAgICAgICAgICAgIG9uSGFzaENoYW5nZShzY3JvbGxUb0FuY2hvcik7CiAgICAgICAgICAgIGhpamFja1Njcm9sbCgpOwogICAgICAgICAgICBoaWphY2tTdHlsZSgpOwoKICAgICAgICAgICAgaWYgKHJ1bk9uRW5hYmxlKSB7CiAgICAgICAgICAgICAgICBvbkVuYWJsZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgZ2V0RG9jdW1lbnRTaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZWxlbWVudHMgPSBzZXR0aW5ncy53YXRjaGVkRWxlbWVudHMoKSwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBlbGVtZW50Qm94LAogICAgICAgICAgICAgICAgYm94ID0gewogICAgICAgICAgICAgICAgICAgIHRvcDogMCwKICAgICAgICAgICAgICAgICAgICByaWdodDogMCwKICAgICAgICAgICAgICAgICAgICBib3R0b206IDAsCiAgICAgICAgICAgICAgICAgICAgbGVmdDogMAogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgaWYgKCEobm90U29PbGRJZSAmJiBlbGVtZW50c1tpXSA9PT0gZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGVsZW1lbnRCb3ggPSBnZXRFbGVtZW50Qm91bmRpbmdCb3goZWxlbWVudHNbaV0pOwoKICAgICAgICAgICAgICAgICAgICBib3gudG9wID0gTWF0aC5taW4oYm94LnRvcCwgZWxlbWVudEJveC50b3ApOwogICAgICAgICAgICAgICAgICAgIGJveC5yaWdodCA9IE1hdGgubWF4KGJveC5yaWdodCwgZWxlbWVudEJveC5yaWdodCk7CiAgICAgICAgICAgICAgICAgICAgYm94LmJvdHRvbSA9IE1hdGgubWF4KGJveC5ib3R0b20sIGVsZW1lbnRCb3guYm90dG9tKTsKICAgICAgICAgICAgICAgICAgICBib3gubGVmdCA9IE1hdGgubWluKGJveC5sZWZ0LCBlbGVtZW50Qm94LmxlZnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gW2JveC5yaWdodCAtIGJveC5sZWZ0LCBib3guYm90dG9tIC0gYm94LnRvcF07CiAgICAgICAgfTsKCiAgICAgICAgb25Eb2N1bWVudFNpemVDaGFuZ2UgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIGxhc3RTaXplID0gW251bGwsIG51bGxdOwoKICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tTaXplKCkgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTaXplID0gZ2V0RG9jdW1lbnRTaXplKCk7CgogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTaXplWzBdICE9PSBsYXN0U2l6ZVswXSB8fCBjdXJyZW50U2l6ZVsxXSAhPT0gbGFzdFNpemVbMV0pIHsKICAgICAgICAgICAgICAgICAgICBsYXN0U2l6ZSA9IGN1cnJlbnRTaXplOwogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGN1cnJlbnRTaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgc2V0SW50ZXJ2YWwoY2hlY2tTaXplLCBSRUZSRVNIX1JBVEUpOwogICAgICAgICAgICBjaGVja1NpemUoKTsKICAgICAgICB9OwoKICAgICAgICBoaWphY2tTdHlsZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5LAogICAgICAgICAgICAgICAgaHRtbCA9IGJvZHkucGFyZW50Tm9kZTsKCiAgICAgICAgICAgIGh0bWwuc3R5bGUuaGVpZ2h0ID0gJ2F1dG8nOwogICAgICAgICAgICBodG1sLnN0eWxlLndpZHRoID0gJ2F1dG8nOwogICAgICAgICAgICBodG1sLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBodG1sLnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7CgogICAgICAgICAgICBpZiAobm90U29PbGRJZSkgewogICAgICAgICAgICAgICAgYm9keS5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgYm9keS5zdHlsZS56b29tID0gJzEnOwogICAgICAgICAgICAgICAgYm9keS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGhpamFja1Njcm9sbCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvID0gc2Nyb2xsVG87CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxCeSA9IHNjcm9sbEJ5OwogICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnlMaW5lcyA9IHNjcm9sbEJ5TGluZXM7CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUb0FuY2hvciA9IHNjcm9sbFRvQW5jaG9yOwogICAgICAgIH07CgogICAgICAgIHNjcm9sbCA9IGZ1bmN0aW9uIChtb2RlLCBhcmdzKSB7CiAgICAgICAgICAgIHNjcm9sbE1lc3Nlbmdlci5zZW5kKHsKICAgICAgICAgICAgICAgIG1vZGU6IG1vZGUsCiAgICAgICAgICAgICAgICBhcmdzOiBhcmdzCiAgICAgICAgICAgIH0pOwogICAgICAgIH07CgogICAgICAgIHNjcm9sbFRvID0gZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbCgndG8nLCBbeCwgeV0pOwogICAgICAgIH07CgogICAgICAgIHNjcm9sbEJ5ID0gZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbCgnYnknLCBbeCwgeV0pOwogICAgICAgIH07CgogICAgICAgIHNjcm9sbEJ5TGluZXMgPSBmdW5jdGlvbiAobikgewogICAgICAgICAgICByZXR1cm4gc2Nyb2xsKCdieS1saW5lcycsIFtuXSk7CiAgICAgICAgfTsKCiAgICAgICAgc2Nyb2xsVG9BbmNob3IgPSBmdW5jdGlvbiAobmFtZSkgewogICAgICAgICAgICBzY3JvbGwoJ2FuY2hvcicsIFtuYW1lXSk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gQ29uc3RydWN0b3IgY29kZQogICAgICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBlbmFibGVNZXNzZW5nZXIgPSBuZXcgTWVzc2VuZ2VyKHdpbmRvdy5wYXJlbnQsIEVOQUJMRV9FVkVOVCwgb3JpZ2luKQogICAgICAgICAgICAgICAgLm9uUmVjZWl2ZShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlID09PSBFTkFCTEVfTVNHICYmICFlbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZU1lc3Nlbmdlci5zZW5kKEVOQUJMRURfTVNHKTsKICAgICAgICAgICAgICAgICAgICAgICAgZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgdmFsaWRPcHRzID0gb3B0cyB8fCB7fTsKCiAgICAgICAgICAgIHNldHRpbmdzID0gewogICAgICAgICAgICAgICAgd2F0Y2hlZEVsZW1lbnRzOiB2YWxpZE9wdHMuaGFzT3duUHJvcGVydHkoJ3dhdGNoZWRFbGVtZW50cycpID8KICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRPcHRzLndhdGNoZWRFbGVtZW50cyA6CiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvdXRwdXQgPSBbZG9jdW1lbnQuYm9keV07CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFub3RTb09sZEllKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgfSgpKTsKICAgIH07CgogICAgY2hlY2tJZVZlcnNpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHZlcnNpb24gPSBudWxsLAogICAgICAgICAgICB1c2VyQWdlbnQsCiAgICAgICAgICAgIHJlOwoKICAgICAgICBpZiAobmF2aWdhdG9yLmFwcE5hbWUgPT09ICdNaWNyb3NvZnQgSW50ZXJuZXQgRXhwbG9yZXInKSB7CiAgICAgICAgICAgIHVzZXJBZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgICAgIHJlICA9IG5ldyBSZWdFeHAoIk1TSUUgKFswLTldezEsfVtcXC4wLTldezAsfSkiKTsKCiAgICAgICAgICAgIGlmIChyZS5leGVjKHVzZXJBZ2VudCkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZlcnNpb24gPSBwYXJzZUZsb2F0KFJlZ0V4cC4kMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB2ZXJzaW9uOwogICAgfTsKCiAgICBnZXRNYXJnaW4gPSBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSkgewogICAgICAgIHZhciB2YWx1ZSwgbWF0Y2gsIG91dHB1dDsKCiAgICAgICAgaWYgKG5vdFNvT2xkSWUgJiYgZWxlbWVudCA9PT0gZG9jdW1lbnQuYm9keS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlICE9PSBteVVuZGVmaW5lZCkgewogICAgICAgICAgICB2YWx1ZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQsIG51bGwpW25hbWVdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhbHVlID0gZWxlbWVudC5jdXJyZW50U3R5bGVbbmFtZV07CiAgICAgICAgfQoKICAgICAgICBtYXRjaCA9IHZhbHVlLm1hdGNoKC8oXGQrKXB4Lyk7CgogICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICBvdXRwdXQgPSBwYXJzZUludChtYXRjaFsxXSwgMTApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG91dHB1dCA9IDA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfTsKCiAgICBnZXRFbGVtZW50Qm91bmRpbmdCb3ggPSBmdW5jdGlvbiAoZWxlbWVudCkgewogICAgICAgIHZhciBiY3IgPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB0b3A6IGJjci50b3AgLSBnZXRNYXJnaW4oZWxlbWVudCwgJ21hcmdpblRvcCcpLAogICAgICAgICAgICByaWdodDogYmNyLnJpZ2h0ICsgZ2V0TWFyZ2luKGVsZW1lbnQsICdtYXJnaW5SaWdodCcpLAogICAgICAgICAgICBib3R0b206IGJjci5ib3R0b20gKyBnZXRNYXJnaW4oZWxlbWVudCwgJ21hcmdpbkJvdHRvbScpLAogICAgICAgICAgICBsZWZ0OiBiY3IubGVmdCAtIGdldE1hcmdpbihlbGVtZW50LCAnbWFyZ2luTGVmdCcpCiAgICAgICAgfTsKICAgIH07CgogICAgb25IYXNoQ2hhbmdlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgdmFyIGxhc3RIYXNoID0gJyc7CgogICAgICAgIGZ1bmN0aW9uIGNoZWNrSGFzaCgpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7CgogICAgICAgICAgICBpZiAoY3VycmVudEhhc2ggIT09IGxhc3RIYXNoICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoICE9PSAnJykgewogICAgICAgICAgICAgICAgbGFzdEhhc2ggPSBjdXJyZW50SGFzaDsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKGN1cnJlbnRIYXNoKTsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5oYXNoID0gJyc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNldEludGVydmFsKGNoZWNrSGFzaCwgUkVGUkVTSF9SQVRFKTsKICAgICAgICBjaGVja0hhc2goKTsKICAgIH07CgogICAgb25FdmVudCA9IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudCwgY2FsbGJhY2ssIGNhcHR1cmUpIHsKICAgICAgICBpZiAoZWxlbWVudC5hZGRFdmVudExpc3RlbmVyICE9PSBteVVuZGVmaW5lZCkgewogICAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGNhbGxiYWNrLCBjYXB0dXJlKTsKICAgICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuYXR0YWNoRXZlbnQgIT09IG15VW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoJ29uJyArIGV2ZW50LCBjYWxsYmFjaywgY2FwdHVyZSk7CiAgICAgICAgfQogICAgfTsKCiAgICBwYXJzZVVybCA9IGZ1bmN0aW9uICh1cmwpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBlbGVtZW50LmhyZWYgPSB1cmw7CgogICAgICAgIGlmIChlbGVtZW50Lmhvc3RuYW1lID09PSAnJykgewogICAgICAgICAgICBlbGVtZW50LmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHByb3RvY29sOiBlbGVtZW50LnByb3RvY29sLAogICAgICAgICAgICBob3N0bmFtZTogZWxlbWVudC5ob3N0bmFtZSwKICAgICAgICAgICAgcG9ydDogZWxlbWVudC5wb3J0CiAgICAgICAgfTsKICAgIH07CgogICAgb3JpZ2luT2ZVcmwgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgdmFyIHBhcnNlZCA9IHBhcnNlVXJsKHVybCksCiAgICAgICAgICAgIHBvcnQgPSBwYXJzZUludChwYXJzZWQucG9ydCwgMTApLAogICAgICAgICAgICBvdXRwdXQ7CgogICAgICAgIGlmIChpc05hTihwb3J0KQogICAgICAgICAgICAgICAgfHwgKHBhcnNlZC5wcm90b2NvbCA9PT0gJ2h0dHA6JyAmJiBwb3J0ID09PSA4MCkKICAgICAgICAgICAgICAgIHx8IChwYXJzZWQucHJvdG9jb2wgPT09ICdodHRwczonICYmIHBvcnQgPT09IDQ0MykpIHsKICAgICAgICAgICAgb3V0cHV0ID0gcGFyc2VkLnByb3RvY29sICsgJy8vJyArIHBhcnNlZC5ob3N0bmFtZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvdXRwdXQgPSBwYXJzZWQucHJvdG9jb2wgKyAnLy8nICsgcGFyc2VkLmhvc3RuYW1lICsgJzonICsgcG9ydDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9OwoKICAgIGluc2lkZSA9IChmdW5jdGlvbiAoKSB7CiAgICAgICAgZnVuY3Rpb24gSShhcmdzKSB7CiAgICAgICAgICAgIHJldHVybiBJbnNpZGUuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfQoKICAgICAgICBJLnByb3RvdHlwZSA9IEluc2lkZS5wcm90b3R5cGU7CgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBuZXcgSShhcmd1bWVudHMpOwogICAgICAgIH07CiAgICB9KCkpOwoKICAgIGdlbmVzaXMgPSBmdW5jdGlvbiAoZWxlbWVudCwgb3B0cykgewogICAgICAgIHJldHVybiBuZXcgSWZyYW1lKGVsZW1lbnQsIG9wdHMpOwogICAgfTsKCiAgICAvLyBFeHBvcnRzCiAgICB3ZlNlbGYuSW5zaWRlID0gSW5zaWRlOwogICAgd2ZTZWxmLklmcmFtZSA9IElmcmFtZTsKICAgIHdmU2VsZi5pbnNpZGUgPSBpbnNpZGU7CiAgICB3ZlNlbGYuZ2VuZXNpcyA9IGdlbmVzaXM7CgogICAgcm9vdC53cmFwRnJhbWUgPSB3ZlNlbGY7CgogICAgLy8gQ29uc3RydWN0b3IgY29kZQogICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZVZlcnNpb24gPSBjaGVja0llVmVyc2lvbigpOwogICAgICAgIG9sZEllID0gKGllVmVyc2lvbiAhPT0gbnVsbCAmJiBpZVZlcnNpb24gPD0gOSk7CiAgICAgICAgbm90U29PbGRJZSA9IChpZVZlcnNpb24gIT09IG51bGwgJiYgaWVWZXJzaW9uIDw9IDEwKTsKICAgIH0oKSk7Cn0oZG9jdW1lbnQsIHdpbmRvdywgbmF2aWdhdG9yLCB3aW5kb3cpKTsK",
                "body": "Lypqc2xpbnQgaW5kZW50OiA0LCBtYXhsZW46IDEwMCwgdmFyczogdHJ1ZSwgYnJvd3NlcjogdHJ1ZSAqLwoKKGZ1bmN0aW9uIChkb2N1bWVudCwgd2luZG93LCBuYXZpZ2F0b3IsIHJvb3QpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvLyBDb25zdGFudHMKICAgIHZhciBNRVNTRU5HRVJfQUdFTlQgPSAnV3JhcEZyYW1lTWVzc2VuZ2VyJywKICAgICAgICBFTkFCTEVfRVZFTlQgPSAnV3JhcEZyYW1lLmVuYWJsZScsCiAgICAgICAgUkVTSVpFX0VWRU5UID0gJ1dyYXBGcmFtZS5yZXNpemUnLAogICAgICAgIFNDUk9MTF9FVkVOVCA9ICdXcmFwRnJhbWUuc2Nyb2xsJywKICAgICAgICBFTkFCTEVfTVNHID0gJ2VuYWJsZScsCiAgICAgICAgRU5BQkxFRF9NU0cgPSAnZW5hYmxlZCcsCiAgICAgICAgUkVGUkVTSF9SQVRFID0gMTAwMDAgLyA2MDsKCiAgICAvLyBNZW1iZXJzCiAgICB2YXIgd2ZTZWxmID0ge30sCiAgICAgICAgaWVWZXJzaW9uLAogICAgICAgIG9sZEllLAogICAgICAgIG5vdFNvT2xkSWUsCiAgICAgICAgbXlVbmRlZmluZWQ7CgogICAgLy8gT2JqZWN0cwogICAgdmFyIE1lc3NlbmdlciwgSWZyYW1lLCBJbnNpZGU7CgogICAgLy8gTWV0aG9kcwogICAgdmFyIGNoZWNrSWVWZXJzaW9uLAogICAgICAgIGdldE1hcmdpbiwKICAgICAgICBnZXRFbGVtZW50Qm91bmRpbmdCb3gsCiAgICAgICAgb25IYXNoQ2hhbmdlLAogICAgICAgIG9uRXZlbnQsCiAgICAgICAgcGFyc2VVcmwsCiAgICAgICAgb3JpZ2luT2ZVcmwsCiAgICAgICAgaW5zaWRlLAogICAgICAgIGdlbmVzaXM7CgogICAgLy8gT2JqZWN0cyBib2RpZXMKICAgIE1lc3NlbmdlciA9IGZ1bmN0aW9uIChvYmplY3QsIGNoYW5uZWwsIHRhcmdldCkgewogICAgICAgIHZhciBzZWxmID0gdGhpcywKICAgICAgICAgICAgcmVjZWl2ZUNhbGxiYWNrcyA9IFtdOwoKICAgICAgICB2YXIgc2VuZCwgb25SZWNlaXZlLCBkaXNwYXRjaE1lc3NhZ2UsIGVuY29kZSwgZGVjb2RlOwoKICAgICAgICBpZiAob2xkSWUpIHsKICAgICAgICAgICAgZW5jb2RlID0gZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShkYXRhKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRlY29kZSA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTsKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbmNvZGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkZWNvZGUgPSBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBzZW5kID0gZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgb2JqZWN0LnBvc3RNZXNzYWdlKGVuY29kZSh7CiAgICAgICAgICAgICAgICBhZ2VudDogTUVTU0VOR0VSX0FHRU5ULAogICAgICAgICAgICAgICAgY2hhbm5lbDogY2hhbm5lbCwKICAgICAgICAgICAgICAgIHBheWxvYWQ6IG1lc3NhZ2UKICAgICAgICAgICAgfSksIHRhcmdldCk7CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIH07CgogICAgICAgIG9uUmVjZWl2ZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICByZWNlaXZlQ2FsbGJhY2tzLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICB9OwoKICAgICAgICBkaXNwYXRjaE1lc3NhZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgdmFyIG1lc3NhZ2UsIGk7CgogICAgICAgICAgICBpZiAoZXZlbnQub3JpZ2luID09PSB0YXJnZXQpIHsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBkZWNvZGUoZXZlbnQuZGF0YSk7CgogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuYWdlbnQgPT09IE1FU1NFTkdFUl9BR0VOVCAmJiBtZXNzYWdlLmNoYW5uZWwgPT09IGNoYW5uZWwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcmVjZWl2ZUNhbGxiYWNrcy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICByZWNlaXZlQ2FsbGJhY2tzW2ldKG1lc3NhZ2UucGF5bG9hZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgICAgc2VsZi5zZW5kID0gc2VuZDsKICAgICAgICBzZWxmLm9uUmVjZWl2ZSA9IG9uUmVjZWl2ZTsKCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgb25FdmVudCh3aW5kb3csICdtZXNzYWdlJywgZGlzcGF0Y2hNZXNzYWdlLCBmYWxzZSk7CiAgICAgICAgfSgpKTsKICAgIH07CgogICAgSWZyYW1lID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdHMpIHsKICAgICAgICAvLyBNZW1iZXJzCiAgICAgICAgdmFyIGlmcmFtZSwKICAgICAgICAgICAgc2V0dGluZ3MgPSB7CiAgICAgICAgICAgICAgICBmb2xsb3dXaWR0aDogb3B0cy5oYXNPd25Qcm9wZXJ0eSgnZm9sbG93V2lkdGgnKSA/IG9wdHMuZm9sbG93V2lkdGggOiBmYWxzZSwKICAgICAgICAgICAgICAgIGZvbGxvd0hlaWdodDogb3B0cy5oYXNPd25Qcm9wZXJ0eSgnZm9sbG93SGVpZ2h0JykgPyBvcHRzLmZvbGxvd0hlaWdodCA6IHRydWUsCiAgICAgICAgICAgICAgICBzY3JvbGxUbzogb3B0cy5oYXNPd25Qcm9wZXJ0eSgnc2Nyb2xsVG8nKSA/IG9wdHMuc2Nyb2xsVG8gOiBbMCwgMF0sCiAgICAgICAgICAgICAgICBzcmM6IG9wdHMuc3JjCiAgICAgICAgICAgIH07CgogICAgICAgIC8vIE1ldGhvZHMKICAgICAgICB2YXIgZ2VuZXNpcywgdXBkYXRlU2l6ZSwgaGFuZGxlRW5hYmxpbmcsIHNjcm9sbCwgZ2V0U2Nyb2xsVG9wLCBnZXRTY3JvbGxMZWZ0OwoKICAgICAgICAvLyBNZXRob2RzIGJvZGllcwogICAgICAgIGdlbmVzaXMgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGlmcmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2lmcmFtZScpOwogICAgICAgICAgICBpZnJhbWUuc3JjID0gc2V0dGluZ3Muc3JjOwogICAgICAgICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCdzY3JvbGxpbmcnLCAnbm8nKTsKICAgICAgICAgICAgaWZyYW1lLnNldEF0dHJpYnV0ZSgnZnJhbWVib3JkZXInLCAnMCcpOwogICAgICAgICAgICBpZnJhbWUuc2V0QXR0cmlidXRlKCd3aWR0aCcsICcxMDAlJyk7CiAgICAgICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsICcxMDAlJyk7CiAgICAgICAgICAgIGlmcmFtZS5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywKICAgICAgICAgICAgICAgICd3aWR0aDogMTAwJTsgJyArCiAgICAgICAgICAgICAgICAnaGVpZ2h0OiAxMDAlOyAnICsKICAgICAgICAgICAgICAgICdib3JkZXI6IG5vbmU7ICcgKwogICAgICAgICAgICAgICAgJ3BhZGRpbmc6IDA7ICcgKwogICAgICAgICAgICAgICAgJ21hcmdpbjogMDsgJyArCiAgICAgICAgICAgICAgICAnb3ZlcmZsb3c6IGhpZGRlbjsnKTsKCiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoaWZyYW1lKTsKICAgICAgICB9OwoKICAgICAgICB1cGRhdGVTaXplID0gZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgICAgICAgICAgaWYgKHNldHRpbmdzLmZvbGxvd1dpZHRoKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLndpZHRoID0gd2lkdGggKyAncHgnOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2V0dGluZ3MuZm9sbG93SGVpZ2h0KSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnN0eWxlLmhlaWdodCA9IGhlaWdodCArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBnZXRTY3JvbGxUb3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQsIGIsIGQ7CgogICAgICAgICAgICBpZiAod2luZG93LnBhZ2VZT2Zmc2V0ICE9PSBteVVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gd2luZG93LnBhZ2VZT2Zmc2V0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYiA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgICAgICAgICBkID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgICAgZCA9IChkLmNsaWVudEhlaWdodCkgPyBkIDogYjsKICAgICAgICAgICAgICAgIG91dHB1dCA9IGQuc2Nyb2xsVG9wOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH07CgogICAgICAgIGdldFNjcm9sbExlZnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBvdXRwdXQsIGIsIGQ7CgogICAgICAgICAgICBpZiAod2luZG93LnBhZ2VYT2Zmc2V0ICE9PSBteVVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgb3V0cHV0ID0gd2luZG93LnBhZ2VYT2Zmc2V0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYiA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgICAgICAgICBkID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgICAgZCA9IChkLmNsaWVudFdpZHRoKSA/IGQgOiBiOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gZC5zY3JvbGxIZWlnaHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgfTsKCiAgICAgICAgc2Nyb2xsID0gZnVuY3Rpb24gKG1vZGUsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIGlmcmFtZUJib3gsIHRhcmdldCA9IFtdOwoKICAgICAgICAgICAgZnVuY3Rpb24gY2FsY3VsYXRlU2Nyb2xsKGFyZywgb2Zmc2V0KSB7CiAgICAgICAgICAgICAgICB2YXIgb3V0cHV0OwoKICAgICAgICAgICAgICAgIGlmIChhcmcgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gMDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gb2Zmc2V0ICsgYXJnOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtb2RlID09PSAndG8nKSB7CiAgICAgICAgICAgICAgICBpZnJhbWVCYm94ID0gaWZyYW1lLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwoKICAgICAgICAgICAgICAgIHRhcmdldFswXSA9IGNhbGN1bGF0ZVNjcm9sbChhcmdzWzBdLCBnZXRTY3JvbGxMZWZ0KCkgKyBpZnJhbWVCYm94LmxlZnQpOwogICAgICAgICAgICAgICAgdGFyZ2V0WzFdID0gY2FsY3VsYXRlU2Nyb2xsKGFyZ3NbMV0sIGdldFNjcm9sbFRvcCgpICsgaWZyYW1lQmJveC50b3ApOwoKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbyh0YXJnZXRbMF0sIHRhcmdldFsxXSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobW9kZSA9PT0gJ2J5JykgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbEJ5KGFyZ3NbMF0sIGFyZ3NbMV0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdieS1saW5lcycpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxCeUxpbmVzKGFyZ3NbMF0pOwogICAgICAgICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdhbmNob3InKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9IGFyZ3NbMF07CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBoYW5kbGVFbmFibGluZyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRhcmdldE9yaWdpbiA9IG9yaWdpbk9mVXJsKHNldHRpbmdzLnNyYyksCiAgICAgICAgICAgICAgICBhY3RpdmF0aW9uTWFuYWdlciA9IG5ldyBNZXNzZW5nZXIoCiAgICAgICAgICAgICAgICAgICAgaWZyYW1lLmNvbnRlbnRXaW5kb3csCiAgICAgICAgICAgICAgICAgICAgRU5BQkxFX0VWRU5ULAogICAgICAgICAgICAgICAgICAgIHRhcmdldE9yaWdpbgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIGVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGVuYWJsZSgpIHsKICAgICAgICAgICAgICAgIGlmICghZW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgIGFjdGl2YXRpb25NYW5hZ2VyLnNlbmQoRU5BQkxFX01TRyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChlbmFibGUsIFJFRlJFU0hfUkFURSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFjdGl2YXRpb25NYW5hZ2VyLm9uUmVjZWl2ZShmdW5jdGlvbiAobWVzc2FnZSkgewogICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UgPT09IEVOQUJMRURfTVNHKSB7CiAgICAgICAgICAgICAgICAgICAgZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgb25FdmVudChpZnJhbWUsICdsb2FkJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZW5hYmxlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgZW5hYmxlKCk7CiAgICAgICAgICAgICAgICBzY3JvbGwoJ3RvJywgc2V0dGluZ3Muc2Nyb2xsVG8pOwogICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfTsKCiAgICAgICAgKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIHRhcmdldE9yaWdpbiA9IG9yaWdpbk9mVXJsKHNldHRpbmdzLnNyYyk7CgogICAgICAgICAgICBnZW5lc2lzKCk7CiAgICAgICAgICAgIGhhbmRsZUVuYWJsaW5nKCk7CgogICAgICAgICAgICBuZXcgTWVzc2VuZ2VyKGlmcmFtZS5jb250ZW50V2luZG93LCBSRVNJWkVfRVZFTlQsIHRhcmdldE9yaWdpbikKICAgICAgICAgICAgICAgIC5vblJlY2VpdmUoZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICB1cGRhdGVTaXplKG1lc3NhZ2VbMF0sIG1lc3NhZ2VbMV0pOwogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBuZXcgTWVzc2VuZ2VyKGlmcmFtZS5jb250ZW50V2luZG93LCBTQ1JPTExfRVZFTlQsIHRhcmdldE9yaWdpbikKICAgICAgICAgICAgICAgIC5vblJlY2VpdmUoZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICBzY3JvbGwobWVzc2FnZS5tb2RlLCBtZXNzYWdlLmFyZ3MpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgfSgpKTsKICAgIH07CgogICAgSW5zaWRlID0gZnVuY3Rpb24gKG9yaWdpbiwgb25FbmFibGUsIG9wdHMpIHsKICAgICAgICAvLyBNZW1iZXJzCiAgICAgICAgdmFyIHNldHRpbmdzLAogICAgICAgICAgICBzaXplTWVzc2VuZ2VyID0gbmV3IE1lc3Nlbmdlcih3aW5kb3cucGFyZW50LCBSRVNJWkVfRVZFTlQsIG9yaWdpbiksCiAgICAgICAgICAgIHNjcm9sbE1lc3NlbmdlciA9IG5ldyBNZXNzZW5nZXIod2luZG93LnBhcmVudCwgU0NST0xMX0VWRU5ULCBvcmlnaW4pLAogICAgICAgICAgICBydW5PbkVuYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggPj0gMiwKICAgICAgICAgICAgZW5hYmxlZCA9IGZhbHNlOwoKICAgICAgICAvLyBNZXRob2RzCiAgICAgICAgdmFyIGVuYWJsZSwKICAgICAgICAgICAgZ2V0RG9jdW1lbnRTaXplLAogICAgICAgICAgICBvbkRvY3VtZW50U2l6ZUNoYW5nZSwKICAgICAgICAgICAgaGlqYWNrU3R5bGUsCiAgICAgICAgICAgIGhpamFja1Njcm9sbCwKICAgICAgICAgICAgc2Nyb2xsLAogICAgICAgICAgICBzY3JvbGxUbywKICAgICAgICAgICAgc2Nyb2xsQnksCiAgICAgICAgICAgIHNjcm9sbEJ5TGluZXMsCiAgICAgICAgICAgIHNjcm9sbFRvQW5jaG9yOwoKICAgICAgICAvLyBNZXRob2QgYm9kaWVzCiAgICAgICAgZW5hYmxlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvbkRvY3VtZW50U2l6ZUNoYW5nZShzaXplTWVzc2VuZ2VyLnNlbmQpOwogICAgICAgICAgICBvbkhhc2hDaGFuZ2Uoc2Nyb2xsVG9BbmNob3IpOwogICAgICAgICAgICBoaWphY2tTY3JvbGwoKTsKICAgICAgICAgICAgaGlqYWNrU3R5bGUoKTsKCiAgICAgICAgICAgIGlmIChydW5PbkVuYWJsZSkgewogICAgICAgICAgICAgICAgb25FbmFibGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGdldERvY3VtZW50U2l6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnRzID0gc2V0dGluZ3Mud2F0Y2hlZEVsZW1lbnRzKCksCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgZWxlbWVudEJveCwKICAgICAgICAgICAgICAgIGJveCA9IHsKICAgICAgICAgICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgICAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgICAgICAgICAgICAgYm90dG9tOiAwLAogICAgICAgICAgICAgICAgICAgIGxlZnQ6IDAKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgIGlmICghKG5vdFNvT2xkSWUgJiYgZWxlbWVudHNbaV0gPT09IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBlbGVtZW50Qm94ID0gZ2V0RWxlbWVudEJvdW5kaW5nQm94KGVsZW1lbnRzW2ldKTsKCiAgICAgICAgICAgICAgICAgICAgYm94LnRvcCA9IE1hdGgubWluKGJveC50b3AsIGVsZW1lbnRCb3gudG9wKTsKICAgICAgICAgICAgICAgICAgICBib3gucmlnaHQgPSBNYXRoLm1heChib3gucmlnaHQsIGVsZW1lbnRCb3gucmlnaHQpOwogICAgICAgICAgICAgICAgICAgIGJveC5ib3R0b20gPSBNYXRoLm1heChib3guYm90dG9tLCBlbGVtZW50Qm94LmJvdHRvbSk7CiAgICAgICAgICAgICAgICAgICAgYm94LmxlZnQgPSBNYXRoLm1pbihib3gubGVmdCwgZWxlbWVudEJveC5sZWZ0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIFtib3gucmlnaHQgLSBib3gubGVmdCwgYm94LmJvdHRvbSAtIGJveC50b3BdOwogICAgICAgIH07CgogICAgICAgIG9uRG9jdW1lbnRTaXplQ2hhbmdlID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBsYXN0U2l6ZSA9IFtudWxsLCBudWxsXTsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGNoZWNrU2l6ZSgpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2l6ZSA9IGdldERvY3VtZW50U2l6ZSgpOwoKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U2l6ZVswXSAhPT0gbGFzdFNpemVbMF0gfHwgY3VycmVudFNpemVbMV0gIT09IGxhc3RTaXplWzFdKSB7CiAgICAgICAgICAgICAgICAgICAgbGFzdFNpemUgPSBjdXJyZW50U2l6ZTsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhjdXJyZW50U2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHNldEludGVydmFsKGNoZWNrU2l6ZSwgUkVGUkVTSF9SQVRFKTsKICAgICAgICAgICAgY2hlY2tTaXplKCk7CiAgICAgICAgfTsKCiAgICAgICAgaGlqYWNrU3R5bGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQuYm9keSwKICAgICAgICAgICAgICAgIGh0bWwgPSBib2R5LnBhcmVudE5vZGU7CgogICAgICAgICAgICBodG1sLnN0eWxlLmhlaWdodCA9ICdhdXRvJzsKICAgICAgICAgICAgaHRtbC5zdHlsZS53aWR0aCA9ICdhdXRvJzsKICAgICAgICAgICAgaHRtbC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgaHRtbC5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwoKICAgICAgICAgICAgaWYgKG5vdFNvT2xkSWUpIHsKICAgICAgICAgICAgICAgIGJvZHkuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJzsKICAgICAgICAgICAgICAgIGJvZHkuc3R5bGUuem9vbSA9ICcxJzsKICAgICAgICAgICAgICAgIGJvZHkuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBoaWphY2tTY3JvbGwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbyA9IHNjcm9sbFRvOwogICAgICAgICAgICB3aW5kb3cuc2Nyb2xsQnkgPSBzY3JvbGxCeTsKICAgICAgICAgICAgd2luZG93LnNjcm9sbEJ5TGluZXMgPSBzY3JvbGxCeUxpbmVzOwogICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG9BbmNob3IgPSBzY3JvbGxUb0FuY2hvcjsKICAgICAgICB9OwoKICAgICAgICBzY3JvbGwgPSBmdW5jdGlvbiAobW9kZSwgYXJncykgewogICAgICAgICAgICBzY3JvbGxNZXNzZW5nZXIuc2VuZCh7CiAgICAgICAgICAgICAgICBtb2RlOiBtb2RlLAogICAgICAgICAgICAgICAgYXJnczogYXJncwogICAgICAgICAgICB9KTsKICAgICAgICB9OwoKICAgICAgICBzY3JvbGxUbyA9IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgICAgIHJldHVybiBzY3JvbGwoJ3RvJywgW3gsIHldKTsKICAgICAgICB9OwoKICAgICAgICBzY3JvbGxCeSA9IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgICAgIHJldHVybiBzY3JvbGwoJ2J5JywgW3gsIHldKTsKICAgICAgICB9OwoKICAgICAgICBzY3JvbGxCeUxpbmVzID0gZnVuY3Rpb24gKG4pIHsKICAgICAgICAgICAgcmV0dXJuIHNjcm9sbCgnYnktbGluZXMnLCBbbl0pOwogICAgICAgIH07CgogICAgICAgIHNjcm9sbFRvQW5jaG9yID0gZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICAgICAgc2Nyb2xsKCdhbmNob3InLCBbbmFtZV0pOwogICAgICAgIH07CgogICAgICAgIC8vIENvbnN0cnVjdG9yIGNvZGUKICAgICAgICAoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB2YXIgZW5hYmxlTWVzc2VuZ2VyID0gbmV3IE1lc3Nlbmdlcih3aW5kb3cucGFyZW50LCBFTkFCTEVfRVZFTlQsIG9yaWdpbikKICAgICAgICAgICAgICAgIC5vblJlY2VpdmUoZnVuY3Rpb24gKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZSA9PT0gRU5BQkxFX01TRyAmJiAhZW5hYmxlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGVNZXNzZW5nZXIuc2VuZChFTkFCTEVEX01TRyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVuYWJsZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBlbmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHZhbGlkT3B0cyA9IG9wdHMgfHwge307CgogICAgICAgICAgICBzZXR0aW5ncyA9IHsKICAgICAgICAgICAgICAgIHdhdGNoZWRFbGVtZW50czogdmFsaWRPcHRzLmhhc093blByb3BlcnR5KCd3YXRjaGVkRWxlbWVudHMnKSA/CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkT3B0cy53YXRjaGVkRWxlbWVudHMgOgogICAgICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgb3V0cHV0ID0gW2RvY3VtZW50LmJvZHldOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm90U29PbGRJZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0oKSk7CiAgICB9OwoKICAgIGNoZWNrSWVWZXJzaW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB2ZXJzaW9uID0gbnVsbCwKICAgICAgICAgICAgdXNlckFnZW50LAogICAgICAgICAgICByZTsKCiAgICAgICAgaWYgKG5hdmlnYXRvci5hcHBOYW1lID09PSAnTWljcm9zb2Z0IEludGVybmV0IEV4cGxvcmVyJykgewogICAgICAgICAgICB1c2VyQWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50OwogICAgICAgICAgICByZSAgPSBuZXcgUmVnRXhwKCJNU0lFIChbMC05XXsxLH1bXFwuMC05XXswLH0pIik7CgogICAgICAgICAgICBpZiAocmUuZXhlYyh1c2VyQWdlbnQpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2ZXJzaW9uID0gcGFyc2VGbG9hdChSZWdFeHAuJDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmVyc2lvbjsKICAgIH07CgogICAgZ2V0TWFyZ2luID0gZnVuY3Rpb24gKGVsZW1lbnQsIG5hbWUpIHsKICAgICAgICB2YXIgdmFsdWUsIG1hdGNoLCBvdXRwdXQ7CgogICAgICAgIGlmIChub3RTb09sZEllICYmIGVsZW1lbnQgPT09IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZSkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSAhPT0gbXlVbmRlZmluZWQpIHsKICAgICAgICAgICAgdmFsdWUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtZW50LCBudWxsKVtuYW1lXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWx1ZSA9IGVsZW1lbnQuY3VycmVudFN0eWxlW25hbWVdOwogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggPSB2YWx1ZS5tYXRjaCgvKFxkKylweC8pOwoKICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgb3V0cHV0ID0gcGFyc2VJbnQobWF0Y2hbMV0sIDEwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvdXRwdXQgPSAwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH07CgogICAgZ2V0RWxlbWVudEJvdW5kaW5nQm94ID0gZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgICB2YXIgYmNyID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdG9wOiBiY3IudG9wIC0gZ2V0TWFyZ2luKGVsZW1lbnQsICdtYXJnaW5Ub3AnKSwKICAgICAgICAgICAgcmlnaHQ6IGJjci5yaWdodCArIGdldE1hcmdpbihlbGVtZW50LCAnbWFyZ2luUmlnaHQnKSwKICAgICAgICAgICAgYm90dG9tOiBiY3IuYm90dG9tICsgZ2V0TWFyZ2luKGVsZW1lbnQsICdtYXJnaW5Cb3R0b20nKSwKICAgICAgICAgICAgbGVmdDogYmNyLmxlZnQgLSBnZXRNYXJnaW4oZWxlbWVudCwgJ21hcmdpbkxlZnQnKQogICAgICAgIH07CiAgICB9OwoKICAgIG9uSGFzaENoYW5nZSA9IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgIHZhciBsYXN0SGFzaCA9ICcnOwoKICAgICAgICBmdW5jdGlvbiBjaGVja0hhc2goKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50SGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoOwoKICAgICAgICAgICAgaWYgKGN1cnJlbnRIYXNoICE9PSBsYXN0SGFzaCAmJiB3aW5kb3cubG9jYXRpb24uaGFzaCAhPT0gJycpIHsKICAgICAgICAgICAgICAgIGxhc3RIYXNoID0gY3VycmVudEhhc2g7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhjdXJyZW50SGFzaCk7CiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9ICcnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBzZXRJbnRlcnZhbChjaGVja0hhc2gsIFJFRlJFU0hfUkFURSk7CiAgICAgICAgY2hlY2tIYXNoKCk7CiAgICB9OwoKICAgIG9uRXZlbnQgPSBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnQsIGNhbGxiYWNrLCBjYXB0dXJlKSB7CiAgICAgICAgaWYgKGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lciAhPT0gbXlVbmRlZmluZWQpIHsKICAgICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBjYWxsYmFjaywgY2FwdHVyZSk7CiAgICAgICAgfSBlbHNlIGlmIChlbGVtZW50LmF0dGFjaEV2ZW50ICE9PSBteVVuZGVmaW5lZCkgewogICAgICAgICAgICBlbGVtZW50LmF0dGFjaEV2ZW50KCdvbicgKyBldmVudCwgY2FsbGJhY2ssIGNhcHR1cmUpOwogICAgICAgIH0KICAgIH07CgogICAgcGFyc2VVcmwgPSBmdW5jdGlvbiAodXJsKSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgZWxlbWVudC5ocmVmID0gdXJsOwoKICAgICAgICBpZiAoZWxlbWVudC5ob3N0bmFtZSA9PT0gJycpIHsKICAgICAgICAgICAgZWxlbWVudC5ocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcm90b2NvbDogZWxlbWVudC5wcm90b2NvbCwKICAgICAgICAgICAgaG9zdG5hbWU6IGVsZW1lbnQuaG9zdG5hbWUsCiAgICAgICAgICAgIHBvcnQ6IGVsZW1lbnQucG9ydAogICAgICAgIH07CiAgICB9OwoKICAgIG9yaWdpbk9mVXJsID0gZnVuY3Rpb24gKHVybCkgewogICAgICAgIHZhciBwYXJzZWQgPSBwYXJzZVVybCh1cmwpLAogICAgICAgICAgICBwb3J0ID0gcGFyc2VJbnQocGFyc2VkLnBvcnQsIDEwKSwKICAgICAgICAgICAgb3V0cHV0OwoKICAgICAgICBpZiAoaXNOYU4ocG9ydCkKICAgICAgICAgICAgICAgIHx8IChwYXJzZWQucHJvdG9jb2wgPT09ICdodHRwOicgJiYgcG9ydCA9PT0gODApCiAgICAgICAgICAgICAgICB8fCAocGFyc2VkLnByb3RvY29sID09PSAnaHR0cHM6JyAmJiBwb3J0ID09PSA0NDMpKSB7CiAgICAgICAgICAgIG91dHB1dCA9IHBhcnNlZC5wcm90b2NvbCArICcvLycgKyBwYXJzZWQuaG9zdG5hbWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3V0cHV0ID0gcGFyc2VkLnByb3RvY29sICsgJy8vJyArIHBhcnNlZC5ob3N0bmFtZSArICc6JyArIHBvcnQ7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgfTsKCiAgICBpbnNpZGUgPSAoZnVuY3Rpb24gKCkgewogICAgICAgIGZ1bmN0aW9uIEkoYXJncykgewogICAgICAgICAgICByZXR1cm4gSW5zaWRlLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH0KCiAgICAgICAgSS5wcm90b3R5cGUgPSBJbnNpZGUucHJvdG90eXBlOwoKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gbmV3IEkoYXJndW1lbnRzKTsKICAgICAgICB9OwogICAgfSgpKTsKCiAgICBnZW5lc2lzID0gZnVuY3Rpb24gKGVsZW1lbnQsIG9wdHMpIHsKICAgICAgICByZXR1cm4gbmV3IElmcmFtZShlbGVtZW50LCBvcHRzKTsKICAgIH07CgogICAgLy8gRXhwb3J0cwogICAgd2ZTZWxmLkluc2lkZSA9IEluc2lkZTsKICAgIHdmU2VsZi5JZnJhbWUgPSBJZnJhbWU7CiAgICB3ZlNlbGYuaW5zaWRlID0gaW5zaWRlOwogICAgd2ZTZWxmLmdlbmVzaXMgPSBnZW5lc2lzOwoKICAgIHJvb3Qud3JhcEZyYW1lID0gd2ZTZWxmOwoKICAgIC8vIENvbnN0cnVjdG9yIGNvZGUKICAgIChmdW5jdGlvbiAoKSB7CiAgICAgICAgaWVWZXJzaW9uID0gY2hlY2tJZVZlcnNpb24oKTsKICAgICAgICBvbGRJZSA9IChpZVZlcnNpb24gIT09IG51bGwgJiYgaWVWZXJzaW9uIDw9IDkpOwogICAgICAgIG5vdFNvT2xkSWUgPSAoaWVWZXJzaW9uICE9PSBudWxsICYmIGllVmVyc2lvbiA8PSAxMCk7CiAgICB9KCkpOwp9KGRvY3VtZW50LCB3aW5kb3csIG5hdmlnYXRvciwgd2luZG93KSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:16:09 GMT",
                    "Content-Length": "15334",
                    "Date": "Sun, 09 Nov 2014 03:16:09 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}