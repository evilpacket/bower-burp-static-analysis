{
    "url": "http://localhost:9999/synapticism/ajaxinate/dist/ajaxinate.part.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.hash</b> and written to <b>$()</b> via the following statements:<ul><li>var $body = $('body' ...t' ) .offset() .top;</li><li>var $hash = $('[id=\"'+hash+'\"]');</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/synapticism/ajaxinate/dist/ajaxinate.part.js",
                "path": "/synapticism/ajaxinate/dist/ajaxinate.part.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9zeW5hcHRpY2lzbS9hamF4aW5hdGUvZGlzdC9hamF4aW5hdGUucGFydC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjQxOTcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMDY6NDQ6MjQgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDA2OjQ0OjI0IEdNVA0KDQovKiEKICogSGlzdG9yeSBBUEkgSmF2YVNjcmlwdCBMaWJyYXJ5IHY0LjEuMAogKgogKiBTdXBwb3J0OiBJRTgrLCBGRjMrLCBPcGVyYSA5KywgU2FmYXJpLCBDaHJvbWUgYW5kIG90aGVyCiAqCiAqIENvcHlyaWdodCAyMDExLTIwMTMsIERtaXRyaWkgUGFraHRpbm92ICggc3BiLnBpa3NlbEBnbWFpbC5jb20gKQogKgogKiBodHRwOi8vc3BiLXBpa3NlbC5ydS8KICoKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXM6CiAqICAgaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9taXQtbGljZW5zZS5waHAKICogICBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvZ3BsLmh0bWwKICoKICogVXBkYXRlOiAyMDE0LTAzLTI0IDEzOjE0CiAqLwooZnVuY3Rpb24od2luZG93KSB7CiAgICAvLyBQcmV2ZW50IHRoZSBjb2RlIGZyb20gcnVubmluZyBpZiB0aGVyZSBpcyBubyB3aW5kb3cuaGlzdG9yeSBvYmplY3QKICAgIGlmICghd2luZG93Lmhpc3RvcnkpIHJldHVybjsKICAgIC8vIHN5bWxpbmsgdG8gZG9jdW1lbnQKICAgIHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICAgIC8vIEhUTUwgZWxlbWVudAogICAgdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICAgIC8vIHN5bWxpbmsgdG8gY29uc3RydWN0b3Igb2YgT2JqZWN0CiAgICB2YXIgT2JqZWN0ID0gd2luZG93WydPYmplY3QnXTsKICAgIC8vIHN5bWxpbmsgdG8gSlNPTiBPYmplY3QKICAgIHZhciBKU09OID0gd2luZG93WydKU09OJ107CiAgICAvLyBzeW1saW5rIHRvIGluc3RhbmNlIG9iamVjdCBvZiAnTG9jYXRpb24nCiAgICB2YXIgd2luZG93TG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAvLyBzeW1saW5rIHRvIGluc3RhbmNlIG9iamVjdCBvZiAnSGlzdG9yeScKICAgIHZhciB3aW5kb3dIaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7CiAgICAvLyBuZXcgaW5zdGFuY2Ugb2YgJ0hpc3RvcnknLiBUaGUgZGVmYXVsdCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgb3JpZ2luYWwgb2JqZWN0IGluc3RhbmNlCiAgICB2YXIgaGlzdG9yeU9iamVjdCA9IHdpbmRvd0hpc3Rvcnk7CiAgICAvLyBzeW1saW5rIHRvIG1ldGhvZCAnaGlzdG9yeS5wdXNoU3RhdGUnCiAgICB2YXIgaGlzdG9yeVB1c2hTdGF0ZSA9IHdpbmRvd0hpc3RvcnkucHVzaFN0YXRlOwogICAgLy8gc3ltbGluayB0byBtZXRob2QgJ2hpc3RvcnkucmVwbGFjZVN0YXRlJwogICAgdmFyIGhpc3RvcnlSZXBsYWNlU3RhdGUgPSB3aW5kb3dIaXN0b3J5LnJlcGxhY2VTdGF0ZTsKICAgIC8vIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIEhUTUw1LUhpc3RvcnktQVBJCiAgICB2YXIgaXNTdXBwb3J0SGlzdG9yeUFQSSA9ICEhaGlzdG9yeVB1c2hTdGF0ZTsKICAgIC8vIHZlcmlmaWVzIHRoZSBwcmVzZW5jZSBvZiBhbiBvYmplY3QgJ3N0YXRlJyBpbiBpbnRlcmZhY2UgJ0hpc3RvcnknCiAgICB2YXIgaXNTdXBwb3J0U3RhdGVPYmplY3RJbkhpc3RvcnkgPSAnc3RhdGUnIGluIHdpbmRvd0hpc3Rvcnk7CiAgICAvLyBzeW1saW5rIHRvIG1ldGhvZCAnT2JqZWN0LmRlZmluZVByb3BlcnR5JwogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgLy8gbmV3IGluc3RhbmNlIG9mICdMb2NhdGlvbicsIGZvciBJRTggd2lsbCB1c2UgdGhlIGVsZW1lbnQgSFRNTEFuY2hvckVsZW1lbnQsIGluc3RlYWQgb2YgcHVyZSBvYmplY3QKICAgIHZhciBsb2NhdGlvbk9iamVjdCA9IHJlZGVmaW5lUHJvcGVydHkoe30sICd0JykgPyB7fSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIC8vIHByZWZpeCBmb3IgdGhlIG5hbWVzIG9mIGV2ZW50cwogICAgdmFyIGV2ZW50TmFtZVByZWZpeCA9ICcnOwogICAgLy8gU3RyaW5nIHRoYXQgd2lsbCBjb250YWluIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QKICAgIHZhciBhZGRFdmVudExpc3RlbmVyTmFtZSA9IHdpbmRvdy5hZGRFdmVudExpc3RlbmVyID8gJ2FkZEV2ZW50TGlzdGVuZXInIDogKGV2ZW50TmFtZVByZWZpeCA9ICdvbicpICYmICdhdHRhY2hFdmVudCc7CiAgICAvLyBTdHJpbmcgdGhhdCB3aWxsIGNvbnRhaW4gdGhlIG5hbWUgb2YgdGhlIG1ldGhvZAogICAgdmFyIHJlbW92ZUV2ZW50TGlzdGVuZXJOYW1lID0gd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIgPyAncmVtb3ZlRXZlbnRMaXN0ZW5lcicgOiAnZGV0YWNoRXZlbnQnOwogICAgLy8gU3RyaW5nIHRoYXQgd2lsbCBjb250YWluIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QKICAgIHZhciBkaXNwYXRjaEV2ZW50TmFtZSA9IHdpbmRvdy5kaXNwYXRjaEV2ZW50ID8gJ2Rpc3BhdGNoRXZlbnQnIDogJ2ZpcmVFdmVudCc7CiAgICAvLyByZWZlcmVuY2UgbmF0aXZlIG1ldGhvZHMgZm9yIHRoZSBldmVudHMKICAgIHZhciBhZGRFdmVudCA9IHdpbmRvd1thZGRFdmVudExpc3RlbmVyTmFtZV07CiAgICB2YXIgcmVtb3ZlRXZlbnQgPSB3aW5kb3dbcmVtb3ZlRXZlbnRMaXN0ZW5lck5hbWVdOwogICAgdmFyIGRpc3BhdGNoID0gd2luZG93W2Rpc3BhdGNoRXZlbnROYW1lXTsKICAgIC8vIGRlZmF1bHQgc2V0dGluZ3MKICAgIHZhciBzZXR0aW5ncyA9IHsiYmFzZXBhdGgiOiAnLycsICJyZWRpcmVjdCI6IDAsICJ0eXBlIjogJy8nfTsKICAgIC8vIGtleSBmb3IgdGhlIHNlc3Npb25TdG9yYWdlCiAgICB2YXIgc2Vzc2lvblN0b3JhZ2VLZXkgPSAnX19oaXN0b3J5QVBJX18nOwogICAgLy8gQW5jaG9yIEVsZW1lbnQgZm9yIHBhcnNlVVJMIGZ1bmN0aW9uCiAgICB2YXIgYW5jaG9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgIC8vIGxhc3QgVVJMIGJlZm9yZSBjaGFuZ2UgdG8gbmV3IFVSTAogICAgdmFyIGxhc3RVUkwgPSB3aW5kb3dMb2NhdGlvbi5ocmVmOwogICAgLy8gQ29udHJvbCBVUkwsIG5lZWQgdG8gZml4IHRoZSBidWcgaW4gT3BlcmEKICAgIHZhciBjaGVja1VybEZvclBvcFN0YXRlID0gJyc7CiAgICAvLyB0cmlnZ2VyIGV2ZW50ICdvbnBvcHN0YXRlJyBvbiBwYWdlIGxvYWQKICAgIHZhciBpc0ZpcmVJbml0aWFsU3RhdGUgPSBmYWxzZTsKICAgIC8vIHN0b3JlIGEgbGlzdCBvZiAnc3RhdGUnIG9iamVjdHMgaW4gdGhlIGN1cnJlbnQgc2Vzc2lvbgogICAgdmFyIHN0YXRlU3RvcmFnZSA9IHt9OwogICAgLy8gaW4gdGhpcyBvYmplY3Qgd2lsbCBiZSBzdG9yZWQgY3VzdG9tIGhhbmRsZXJzCiAgICB2YXIgZXZlbnRzTGlzdCA9IHt9OwogICAgLy8gc3RvcmVkIGxhc3QgdGl0bGUKICAgIHZhciBsYXN0VGl0bGUgPSBkb2N1bWVudC50aXRsZTsKCiAgICAvKioKICAgICAqIFByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIHJlcGxhY2VkIGluIHRoZSBnbG9iYWwKICAgICAqIG9iamVjdCAnd2luZG93JywgdG8gcHJldmVudCBjb25mbGljdHMKICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgZXZlbnRzRGVzY3JpcHRvcnMgPSB7CiAgICAgICAgIm9uaGFzaGNoYW5nZSI6IG51bGwsCiAgICAgICAgIm9ucG9wc3RhdGUiOiBudWxsCiAgICB9OwoKICAgIC8qKgogICAgICogRml4IGZvciBDaHJvbWUgaW4gaU9TCiAgICAgKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2Rldm90ZS9IVE1MNS1IaXN0b3J5LUFQSS9pc3N1ZXMvMjkKICAgICAqLwogICAgdmFyIGZhc3RGaXhDaHJvbWUgPSBmdW5jdGlvbihtZXRob2QsIGFyZ3MpIHsKICAgICAgICB2YXIgaXNOZWVkRml4ID0gd2luZG93Lmhpc3RvcnkgIT09IHdpbmRvd0hpc3Rvcnk7CiAgICAgICAgaWYgKGlzTmVlZEZpeCkgewogICAgICAgICAgICB3aW5kb3cuaGlzdG9yeSA9IHdpbmRvd0hpc3Rvcnk7CiAgICAgICAgfQogICAgICAgIG1ldGhvZC5hcHBseSh3aW5kb3dIaXN0b3J5LCBhcmdzKTsKICAgICAgICBpZiAoaXNOZWVkRml4KSB7CiAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5ID0gaGlzdG9yeU9iamVjdDsKICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvcGVydGllcyB0aGF0IHdpbGwgYmUgcmVwbGFjZWQvYWRkZWQgdG8gb2JqZWN0CiAgICAgKiAnd2luZG93Lmhpc3RvcnknLCBpbmNsdWRlcyB0aGUgb2JqZWN0ICdoaXN0b3J5LmxvY2F0aW9uJywKICAgICAqIGZvciBhIGNvbXBsZXRlIHRoZSB3b3JrIHdpdGggdGhlIFVSTCBhZGRyZXNzCiAgICAgKgogICAgICogQHR5cGUge09iamVjdH0KICAgICAqLwogICAgdmFyIGhpc3RvcnlEZXNjcmlwdG9ycyA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gW3R5cGVdCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IFtiYXNlcGF0aF0KICAgICAgICAgKi8KICAgICAgICAicmVkaXJlY3QiOiBmdW5jdGlvbih0eXBlLCBiYXNlcGF0aCkgewogICAgICAgICAgICBzZXR0aW5nc1siYmFzZXBhdGgiXSA9IGJhc2VwYXRoID0gYmFzZXBhdGggPT0gbnVsbCA/IHNldHRpbmdzWyJiYXNlcGF0aCJdIDogYmFzZXBhdGg7CiAgICAgICAgICAgIHNldHRpbmdzWyJ0eXBlIl0gPSB0eXBlID0gdHlwZSA9PSBudWxsID8gc2V0dGluZ3NbInR5cGUiXSA6IHR5cGU7CiAgICAgICAgICAgIGlmICh3aW5kb3cudG9wID09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVsYXRpdmUgPSBwYXJzZVVSTChudWxsLCBmYWxzZSwgdHJ1ZSkuX3JlbGF0aXZlOwogICAgICAgICAgICAgICAgdmFyIHBhdGggPSB3aW5kb3dMb2NhdGlvbi5wYXRobmFtZSArIHdpbmRvd0xvY2F0aW9uLnNlYXJjaDsKICAgICAgICAgICAgICAgIGlmIChpc1N1cHBvcnRIaXN0b3J5QVBJKSB7CiAgICAgICAgICAgICAgICAgICAgcGF0aCA9IHBhdGgucmVwbGFjZSgvKFteXC9dKSQvLCAnJDEvJyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbGF0aXZlICE9IGJhc2VwYXRoICYmIChuZXcgUmVnRXhwKCJeIiArIGJhc2VwYXRoICsgIiQiLCAiaSIpKS50ZXN0KHBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd0xvY2F0aW9uLnJlcGxhY2UocmVsYXRpdmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocGF0aCAhPSBiYXNlcGF0aCkgewogICAgICAgICAgICAgICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoLyhbXlwvXSlcPy8sICckMS8/Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKChuZXcgUmVnRXhwKCJeIiArIGJhc2VwYXRoLCAiaSIpKS50ZXN0KHBhdGgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvd0xvY2F0aW9uLnJlcGxhY2UoYmFzZXBhdGggKyAnIycgKyBwYXRoLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZShuZXcgUmVnRXhwKCJeIiArIGJhc2VwYXRoLCAiaSIpLCB0eXBlKSArIHdpbmRvd0xvY2F0aW9uLmhhc2gpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG1ldGhvZCBhZGRzIGEgc3RhdGUgb2JqZWN0IGVudHJ5CiAgICAgICAgICogdG8gdGhlIGhpc3RvcnkuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGl0bGUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3VybF0KICAgICAgICAgKi8KICAgICAgICBwdXNoU3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCB0aXRsZSwgdXJsKSB7CiAgICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQudGl0bGU7CiAgICAgICAgICAgIGlmIChsYXN0VGl0bGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBsYXN0VGl0bGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGlzdG9yeVB1c2hTdGF0ZSAmJiBmYXN0Rml4Q2hyb21lKGhpc3RvcnlQdXNoU3RhdGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGNoYW5nZVN0YXRlKHN0YXRlLCB1cmwpOwogICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IHQ7CiAgICAgICAgICAgIGxhc3RUaXRsZSA9IHRpdGxlOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogVGhlIG1ldGhvZCB1cGRhdGVzIHRoZSBzdGF0ZSBvYmplY3QsCiAgICAgICAgICogdGl0bGUsIGFuZCBvcHRpb25hbGx5IHRoZSBVUkwgb2YgdGhlCiAgICAgICAgICogY3VycmVudCBlbnRyeSBpbiB0aGUgaGlzdG9yeS4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0aXRsZQogICAgICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdXJsXQogICAgICAgICAqLwogICAgICAgIHJlcGxhY2VTdGF0ZTogZnVuY3Rpb24oc3RhdGUsIHRpdGxlLCB1cmwpIHsKICAgICAgICAgICAgdmFyIHQgPSBkb2N1bWVudC50aXRsZTsKICAgICAgICAgICAgaWYgKGxhc3RUaXRsZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IGxhc3RUaXRsZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGUgc3RhdGVTdG9yYWdlW3dpbmRvd0xvY2F0aW9uLmhyZWZdOwogICAgICAgICAgICBoaXN0b3J5UmVwbGFjZVN0YXRlICYmIGZhc3RGaXhDaHJvbWUoaGlzdG9yeVJlcGxhY2VTdGF0ZSwgYXJndW1lbnRzKTsKICAgICAgICAgICAgY2hhbmdlU3RhdGUoc3RhdGUsIHVybCwgdHJ1ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gdDsKICAgICAgICAgICAgbGFzdFRpdGxlID0gdGl0bGU7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBPYmplY3QgJ2hpc3RvcnkubG9jYXRpb24nIGlzIHNpbWlsYXIgdG8gdGhlCiAgICAgICAgICogb2JqZWN0ICd3aW5kb3cubG9jYXRpb24nLCBleGNlcHQgdGhhdCBpbgogICAgICAgICAqIEhUTUw0IGJyb3dzZXJzIGl0IHdpbGwgYmVoYXZlIGEgYml0IGRpZmZlcmVudGx5CiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkKICAgICAgICAgKi8KICAgICAgICAibG9jYXRpb24iOiB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IHZhbHVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydEhpc3RvcnlBUEkgPyB3aW5kb3dMb2NhdGlvbiA6IGxvY2F0aW9uT2JqZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBBIHN0YXRlIG9iamVjdCBpcyBhbiBvYmplY3QgcmVwcmVzZW50aW5nCiAgICAgICAgICogYSB1c2VyIGludGVyZmFjZSBzdGF0ZS4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeQogICAgICAgICAqLwogICAgICAgICJzdGF0ZSI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZVN0b3JhZ2Vbd2luZG93TG9jYXRpb24uaHJlZl0gfHwgbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgLyoqCiAgICAgKiBQcm9wZXJ0aWVzIGZvciBvYmplY3QgJ2hpc3RvcnkubG9jYXRpb24nLgogICAgICogT2JqZWN0ICdoaXN0b3J5LmxvY2F0aW9uJyBpcyBzaW1pbGFyIHRvIHRoZQogICAgICogb2JqZWN0ICd3aW5kb3cubG9jYXRpb24nLCBleGNlcHQgdGhhdCBpbgogICAgICogSFRNTDQgYnJvd3NlcnMgaXQgd2lsbCBiZWhhdmUgYSBiaXQgZGlmZmVyZW50bHkKICAgICAqCiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgbG9jYXRpb25EZXNjcmlwdG9ycyA9IHsKICAgICAgICAvKioKICAgICAgICAgKiBOYXZpZ2F0ZXMgdG8gdGhlIGdpdmVuIHBhZ2UuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICBhc3NpZ246IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICBpZiAoKCcnICsgdXJsKS5pbmRleE9mKCcjJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGNoYW5nZVN0YXRlKG51bGwsIHVybCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmVsb2FkcyB0aGUgY3VycmVudCBwYWdlLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgcmVsb2FkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgd2luZG93TG9jYXRpb24ucmVsb2FkKCk7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHBhZ2UgZnJvbQogICAgICAgICAqIHRoZSBzZXNzaW9uIGhpc3RvcnkgYW5kIG5hdmlnYXRlcwogICAgICAgICAqIHRvIHRoZSBnaXZlbiBwYWdlLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgcmVwbGFjZTogZnVuY3Rpb24odXJsKSB7CiAgICAgICAgICAgIGlmICgoJycgKyB1cmwpLmluZGV4T2YoJyMnKSA9PT0gMCkgewogICAgICAgICAgICAgICAgY2hhbmdlU3RhdGUobnVsbCwgdXJsLCB0cnVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdpbmRvd0xvY2F0aW9uLnJlcGxhY2UodXJsKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgbG9jYXRpb24uCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICB0b1N0cmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmhyZWY7CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHBhZ2UncyBsb2NhdGlvbi4KICAgICAgICAgKiBDYW4gYmUgc2V0LCB0byBuYXZpZ2F0ZSB0byBhbm90aGVyIHBhZ2UuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAiaHJlZiI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVVSTCgpLl9ocmVmOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHBhZ2UncyBwcm90b2NvbC4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeS5sb2NhdGlvbgogICAgICAgICAqLwogICAgICAgICJwcm90b2NvbCI6IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgaG9zdCBhbmQgcG9ydCBudW1iZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAiaG9zdCI6IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgaG9zdC4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeS5sb2NhdGlvbgogICAgICAgICAqLwogICAgICAgICJob3N0bmFtZSI6IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgcG9ydCBudW1iZXIuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAicG9ydCI6IG51bGwsCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgcGF0aCBvbmx5LgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgInBhdGhuYW1lIjogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVVJMKCkuX3BhdGhuYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHBhZ2UncyBzZWFyY2gKICAgICAgICAgKiBzdHJpbmcsIGJlZ2lubmluZyB3aXRoIHRoZSBjaGFyYWN0ZXIKICAgICAgICAgKiAnPycgYW5kIHRvIHRoZSBzeW1ib2wgJyMnCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAic2VhcmNoIjogewogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVVJMKCkuX3NlYXJjaDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgaGFzaAogICAgICAgICAqIHN0cmluZywgYmVnaW5uaW5nIHdpdGggdGhlIGNoYXJhY3RlcgogICAgICAgICAqICcjJyBhbmQgdG8gdGhlIGVuZCBsaW5lCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAiaGFzaCI6IHsKICAgICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgY2hhbmdlU3RhdGUobnVsbCwgKCcnICsgdmFsdWUpLnJlcGxhY2UoL14oI3wpLywgJyMnKSwgZmFsc2UsIGxhc3RVUkwpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlVVJMKCkuX2hhc2g7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogSnVzdCBlbXB0eSBmdW5jdGlvbgogICAgICoKICAgICAqIEByZXR1cm4gdm9pZAogICAgICovCiAgICBmdW5jdGlvbiBlbXB0eUZ1bmN0aW9uKCkgewogICAgICAgIC8vIGR1bW15CiAgICB9CgogICAgLyoqCiAgICAgKiBQcmVwYXJlcyBhIHBhcnRzIG9mIHRoZSBjdXJyZW50IG9yIHNwZWNpZmllZCByZWZlcmVuY2UgZm9yIGxhdGVyIHVzZSBpbiB0aGUgbGlicmFyeQogICAgICoKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbaHJlZl0KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2lzV2luZG93TG9jYXRpb25dCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc05vdEFQSV0KICAgICAqIEByZXR1cm4ge09iamVjdH0KICAgICAqLwogICAgZnVuY3Rpb24gcGFyc2VVUkwoaHJlZiwgaXNXaW5kb3dMb2NhdGlvbiwgaXNOb3RBUEkpIHsKICAgICAgICB2YXIgcmUgPSAvKD86KFtcdzAtOV0rOikpPyg/OlwvXC8oPzpbXkBdKkApPyhbXlwvOlw/I10rKSg/OjooWzAtOV0rKSk/KT8oW15cPyNdKikoPzooXD9bXiNdKyl8XD8pPyg/OigjLiopKT8vOwogICAgICAgIGlmIChocmVmICE9IG51bGwgJiYgaHJlZiAhPT0gJycgJiYgIWlzV2luZG93TG9jYXRpb24pIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBwYXJzZVVSTCgpLCBfcGF0aG5hbWUgPSBjdXJyZW50Ll9wYXRobmFtZSwgX3Byb3RvY29sID0gY3VycmVudC5fcHJvdG9jb2w7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgdG8gdHlwZSBvZiBzdHJpbmcKICAgICAgICAgICAgaHJlZiA9ICcnICsgaHJlZjsKICAgICAgICAgICAgLy8gY29udmVydCByZWxhdGl2ZSBsaW5rIHRvIHRoZSBhYnNvbHV0ZQogICAgICAgICAgICBocmVmID0gL14oPzpbXHcwLTldK1w6KT9cL1wvLy50ZXN0KGhyZWYpID8gaHJlZi5pbmRleE9mKCIvIikgPT09IDAKICAgICAgICAgICAgICAgID8gX3Byb3RvY29sICsgaHJlZiA6IGhyZWYgOiBfcHJvdG9jb2wgKyAiLy8iICsgY3VycmVudC5faG9zdCArICgKICAgICAgICAgICAgICAgIGhyZWYuaW5kZXhPZigiLyIpID09PSAwID8gaHJlZiA6IGhyZWYuaW5kZXhPZigiPyIpID09PSAwCiAgICAgICAgICAgICAgICAgICAgPyBfcGF0aG5hbWUgKyBocmVmIDogaHJlZi5pbmRleE9mKCIjIikgPT09IDAKICAgICAgICAgICAgICAgICAgICA/IF9wYXRobmFtZSArIGN1cnJlbnQuX3NlYXJjaCArIGhyZWYgOiBfcGF0aG5hbWUucmVwbGFjZSgvW15cL10rJC9nLCAnJykgKyBocmVmCiAgICAgICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhyZWYgPSBpc1dpbmRvd0xvY2F0aW9uID8gaHJlZiA6IHdpbmRvd0xvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgIC8vIGlmIGN1cnJlbnQgYnJvd3NlciBub3Qgc3VwcG9ydCBIaXN0b3J5LUFQSQogICAgICAgICAgICBpZiAoIWlzU3VwcG9ydEhpc3RvcnlBUEkgfHwgaXNOb3RBUEkpIHsKICAgICAgICAgICAgICAgIC8vIGdldCBoYXNoIGZyYWdtZW50CiAgICAgICAgICAgICAgICBocmVmID0gaHJlZi5yZXBsYWNlKC9eW14jXSovLCAnJykgfHwgIiMiOwogICAgICAgICAgICAgICAgLy8gZm9ybSB0aGUgYWJzb2x1dGUgbGluayBmcm9tIHRoZSBoYXNoCiAgICAgICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZGV2b3RlL0hUTUw1LUhpc3RvcnktQVBJL2lzc3Vlcy81MAogICAgICAgICAgICAgICAgaHJlZiA9IHdpbmRvd0xvY2F0aW9uLnByb3RvY29sLnJlcGxhY2UoLzouKiR8JC8sICc6JykgKyAnLy8nICsgd2luZG93TG9jYXRpb24uaG9zdCArIHNldHRpbmdzWydiYXNlcGF0aCddCiAgICAgICAgICAgICAgICAgICAgKyBocmVmLnJlcGxhY2UobmV3IFJlZ0V4cCgiXiNbXC9dPyg/OiIgKyBzZXR0aW5nc1sidHlwZSJdICsgIik/IiksICIiKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvLyB0aGF0IHdvdWxkIGdldCByaWQgb2YgdGhlIGxpbmtzIG9mIHRoZSBmb3JtOiAvLi4vLi4vCiAgICAgICAgYW5jaG9yRWxlbWVudC5ocmVmID0gaHJlZjsKICAgICAgICAvLyBkZWNvbXBvc2UgdGhlIGxpbmsgaW4gcGFydHMKICAgICAgICB2YXIgcmVzdWx0ID0gcmUuZXhlYyhhbmNob3JFbGVtZW50LmhyZWYpOwogICAgICAgIC8vIGhvc3QgbmFtZSB3aXRoIHRoZSBwb3J0IG51bWJlcgogICAgICAgIHZhciBob3N0ID0gcmVzdWx0WzJdICsgKHJlc3VsdFszXSA/ICc6JyArIHJlc3VsdFszXSA6ICcnKTsKICAgICAgICAvLyBmb2xkZXIKICAgICAgICB2YXIgcGF0aG5hbWUgPSByZXN1bHRbNF0gfHwgJy8nOwogICAgICAgIC8vIHRoZSBxdWVyeSBzdHJpbmcKICAgICAgICB2YXIgc2VhcmNoID0gcmVzdWx0WzVdIHx8ICcnOwogICAgICAgIC8vIGhhc2gKICAgICAgICB2YXIgaGFzaCA9IHJlc3VsdFs2XSA9PT0gJyMnID8gJycgOiAocmVzdWx0WzZdIHx8ICcnKTsKICAgICAgICAvLyByZWxhdGl2ZSBsaW5rLCBubyBwcm90b2NvbCwgbm8gaG9zdAogICAgICAgIHZhciByZWxhdGl2ZSA9IHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKICAgICAgICAvLyBzcGVjaWFsIGxpbmtzIGZvciBzZXQgdG8gaGFzaC1saW5rLCBpZiBicm93c2VyIG5vdCBzdXBwb3J0IEhpc3RvcnkgQVBJCiAgICAgICAgdmFyIG5vaGFzaCA9IHBhdGhuYW1lLnJlcGxhY2UobmV3IFJlZ0V4cCgiXiIgKyBzZXR0aW5nc1siYmFzZXBhdGgiXSwgImkiKSwgc2V0dGluZ3NbInR5cGUiXSkgKyBzZWFyY2g7CiAgICAgICAgLy8gcmVzdWx0CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgX2hyZWY6IHJlc3VsdFsxXSArICcvLycgKyBob3N0ICsgcmVsYXRpdmUsCiAgICAgICAgICAgIF9wcm90b2NvbDogcmVzdWx0WzFdLAogICAgICAgICAgICBfaG9zdDogaG9zdCwKICAgICAgICAgICAgX2hvc3RuYW1lOiByZXN1bHRbMl0sCiAgICAgICAgICAgIF9wb3J0OiByZXN1bHRbM10gfHwgJycsCiAgICAgICAgICAgIF9wYXRobmFtZTogcGF0aG5hbWUsCiAgICAgICAgICAgIF9zZWFyY2g6IHNlYXJjaCwKICAgICAgICAgICAgX2hhc2g6IGhhc2gsCiAgICAgICAgICAgIF9yZWxhdGl2ZTogcmVsYXRpdmUsCiAgICAgICAgICAgIF9ub2hhc2g6IG5vaGFzaCwKICAgICAgICAgICAgX3NwZWNpYWw6IG5vaGFzaCArIGhhc2gKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBJbml0aWFsaXppbmcgc3RvcmFnZSBmb3IgdGhlIGN1c3RvbSBzdGF0ZSdzIG9iamVjdAogICAgICovCiAgICBmdW5jdGlvbiBzdG9yYWdlSW5pdGlhbGl6ZSgpIHsKICAgICAgICB2YXIgc2Vzc2lvblN0b3JhZ2U7CiAgICAgICAgLyoqCiAgICAgICAgICogc2Vzc2lvblN0b3JhZ2UgdGhyb3dzIGVycm9yIHdoZW4gY29va2llcyBhcmUgZGlzYWJsZWQKICAgICAgICAgKiBDaHJvbWUgY29udGVudCBzZXR0aW5ncyB3aGVuIHJ1bm5pbmcgdGhlIHNpdGUgaW4gYSBGYWNlYm9vayBJRnJhbWUuCiAgICAgICAgICogc2VlOiBodHRwczovL2dpdGh1Yi5jb20vZGV2b3RlL0hUTUw1LUhpc3RvcnktQVBJL2lzc3Vlcy8zNAogICAgICAgICAqIGFuZDogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTI5NzY5ODgvNjY5MzYwCiAgICAgICAgICovCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UgPSB3aW5kb3dbJ3Nlc3Npb25TdG9yYWdlJ107CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXkgKyAndCcsICcxJyk7CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXkgKyAndCcpOwogICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlID0gewogICAgICAgICAgICAgICAgZ2V0SXRlbTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNvb2tpZSA9IGRvY3VtZW50LmNvb2tpZS5zcGxpdChrZXkgKyAiPSIpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjb29raWUubGVuZ3RoID4gMSAmJiBjb29raWUucG9wKCkuc3BsaXQoIjsiKS5zaGlmdCgpIHx8ICdudWxsJzsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXRJdGVtOiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXRlID0ge307CiAgICAgICAgICAgICAgICAgICAgLy8gaW5zZXJ0IG9uZSBjdXJyZW50IGVsZW1lbnQgdG8gY29va2llCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlW3dpbmRvd0xvY2F0aW9uLmhyZWZdID0gaGlzdG9yeU9iamVjdC5zdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5jb29raWUgPSBrZXkgKyAnPScgKyBKU09OLnN0cmluZ2lmeShzdGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBnZXQgY2FjaGUgZnJvbSB0aGUgc3RvcmFnZSBpbiBicm93c2VyCiAgICAgICAgICAgIHN0YXRlU3RvcmFnZSA9IEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShzZXNzaW9uU3RvcmFnZUtleSkpIHx8IHt9OwogICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgICAgIHN0YXRlU3RvcmFnZSA9IHt9OwogICAgICAgIH0KCiAgICAgICAgLy8gaGFuZyB1cCB0aGUgZXZlbnQgaGFuZGxlciB0byBldmVudCB1bmxvYWQgcGFnZQogICAgICAgIGFkZEV2ZW50KGV2ZW50TmFtZVByZWZpeCArICd1bmxvYWQnLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gc2F2ZSBjdXJyZW50IHN0YXRlJ3Mgb2JqZWN0CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KHN0YXRlU3RvcmFnZSkpOwogICAgICAgIH0sIGZhbHNlKTsKICAgIH0KCiAgICAvKioKICAgICAqIFRoaXMgbWV0aG9kIGlzIGltcGxlbWVudGVkIHRvIG92ZXJyaWRlIHRoZSBidWlsdC1pbihuYXRpdmUpCiAgICAgKiBwcm9wZXJ0aWVzIGluIHRoZSBicm93c2VyLCB1bmZvcnR1bmF0ZWx5IHNvbWUgYnJvd3NlcnMgYXJlCiAgICAgKiBub3QgYWxsb3dlZCB0byBvdmVycmlkZSBhbGwgdGhlIHByb3BlcnRpZXMgYW5kIGV2ZW4gYWRkLgogICAgICogRm9yIHRoaXMgcmVhc29uLCB0aGlzIHdhcyB3cml0dGVuIGJ5IGEgbWV0aG9kIHRoYXQgdHJpZXMgdG8KICAgICAqIGRvIGV2ZXJ5dGhpbmcgbmVjZXNzYXJ5IHRvIGdldCB0aGUgZGVzaXJlZCByZXN1bHQuCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IGluIHdoaWNoIHdpbGwgYmUgb3ZlcnJpZGRlbi9hZGRlZCBwcm9wZXJ0eQogICAgICogQHBhcmFtIHtTdHJpbmd9IHByb3AgVGhlIHByb3BlcnR5IG5hbWUgdG8gYmUgb3ZlcnJpZGRlbi9hZGRlZAogICAgICogQHBhcmFtIHtPYmplY3R9IFtkZXNjcmlwdG9yXSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzIHNldC9nZXQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtvbldyYXBwZWRdIFRoZSBmdW5jdGlvbiB0byBiZSBjYWxsZWQgd2hlbiB0aGUgd3JhcHBlciBpcyBjcmVhdGVkCiAgICAgKiBAcmV0dXJuIHtPYmplY3R8Qm9vbGVhbn0gUmV0dXJucyBhbiBvYmplY3Qgb24gc3VjY2Vzcywgb3RoZXJ3aXNlIHJldHVybnMgZmFsc2UKICAgICAqLwogICAgZnVuY3Rpb24gcmVkZWZpbmVQcm9wZXJ0eShvYmplY3QsIHByb3AsIGRlc2NyaXB0b3IsIG9uV3JhcHBlZCkgewogICAgICAgIC8vIHRlc3Qgb25seSBpZiBkZXNjcmlwdG9yIGlzIHVuZGVmaW5lZAogICAgICAgIGRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yIHx8IHtzZXQ6IGVtcHR5RnVuY3Rpb259OwogICAgICAgIC8vIHZhcmlhYmxlIHdpbGwgaGF2ZSBhIHZhbHVlIG9mIHRydWUgdGhlIHN1Y2Nlc3Mgb2YgYXR0ZW1wdHMgdG8gc2V0IGRlc2NyaXB0b3JzCiAgICAgICAgdmFyIGlzRGVmaW5lZFNldHRlciA9ICFkZXNjcmlwdG9yLnNldDsKICAgICAgICB2YXIgaXNEZWZpbmVkR2V0dGVyID0gIWRlc2NyaXB0b3IuZ2V0OwogICAgICAgIC8vIGZvciB0ZXN0cyBvZiBhdHRlbXB0cyB0byBzZXQgZGVzY3JpcHRvcnMKICAgICAgICB2YXIgdGVzdCA9IHtjb25maWd1cmFibGU6IHRydWUsIHNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlzRGVmaW5lZFNldHRlciA9IDE7CiAgICAgICAgfSwgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaXNEZWZpbmVkR2V0dGVyID0gMTsKICAgICAgICB9fTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gdGVzdGluZyBmb3IgdGhlIHBvc3NpYmlsaXR5IG9mIG92ZXJyaWRpbmcvYWRkaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkob2JqZWN0LCBwcm9wLCB0ZXN0KTsKICAgICAgICAgICAgLy8gcnVubmluZyB0aGUgdGVzdAogICAgICAgICAgICBvYmplY3RbcHJvcF0gPSBvYmplY3RbcHJvcF07CiAgICAgICAgICAgIC8vIGF0dGVtcHQgdG8gb3ZlcnJpZGUgcHJvcGVydHkgdXNpbmcgdGhlIHN0YW5kYXJkIG1ldGhvZAogICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShvYmplY3QsIHByb3AsIGRlc2NyaXB0b3IpOwogICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiB0aGUgdmFyaWFibGUgJ2lzRGVmaW5lZCcgaGFzIGEgZmFsc2UgdmFsdWUsIGl0IG1lYW5zIHRoYXQgbmVlZCB0byB0cnkgb3RoZXIgbWV0aG9kcwogICAgICAgIGlmICghaXNEZWZpbmVkU2V0dGVyIHx8ICFpc0RlZmluZWRHZXR0ZXIpIHsKICAgICAgICAgICAgLy8gdHJ5IHRvIG92ZXJyaWRlL2FkZCB0aGUgcHJvcGVydHksIHVzaW5nIGRlcHJlY2F0ZWQgZnVuY3Rpb25zCiAgICAgICAgICAgIGlmIChvYmplY3QuX19kZWZpbmVHZXR0ZXJfXykgewogICAgICAgICAgICAgICAgLy8gdGVzdGluZyBmb3IgdGhlIHBvc3NpYmlsaXR5IG9mIG92ZXJyaWRpbmcvYWRkaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIG9iamVjdC5fX2RlZmluZUdldHRlcl9fKHByb3AsIHRlc3QuZ2V0KTsKICAgICAgICAgICAgICAgIG9iamVjdC5fX2RlZmluZVNldHRlcl9fKHByb3AsIHRlc3Quc2V0KTsKICAgICAgICAgICAgICAgIC8vIHJ1bm5pbmcgdGhlIHRlc3QKICAgICAgICAgICAgICAgIG9iamVjdFtwcm9wXSA9IG9iamVjdFtwcm9wXTsKICAgICAgICAgICAgICAgIC8vIGF0dGVtcHQgdG8gb3ZlcnJpZGUgcHJvcGVydHkgdXNpbmcgdGhlIGRlcHJlY2F0ZWQgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICBkZXNjcmlwdG9yLmdldCAmJiBvYmplY3QuX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCBkZXNjcmlwdG9yLmdldCk7CiAgICAgICAgICAgICAgICBkZXNjcmlwdG9yLnNldCAmJiBvYmplY3QuX19kZWZpbmVTZXR0ZXJfXyhwcm9wLCBkZXNjcmlwdG9yLnNldCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJyb3dzZXIgcmVmdXNlZCB0byBvdmVycmlkZSB0aGUgcHJvcGVydHksIHVzaW5nIHRoZSBzdGFuZGFyZCBhbmQgZGVwcmVjYXRlZCBtZXRob2RzCiAgICAgICAgICAgIGlmICgoIWlzRGVmaW5lZFNldHRlciB8fCAhaXNEZWZpbmVkR2V0dGVyKSAmJiBvYmplY3QgPT09IHdpbmRvdykgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAvLyBzYXZlIG9yaWdpbmFsIHZhbHVlIGZyb20gdGhpcyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFZhbHVlID0gb2JqZWN0W3Byb3BdOwogICAgICAgICAgICAgICAgICAgIC8vIHNldCBudWxsIHRvIGJ1aWx0LWluKG5hdGl2ZSkgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICBvYmplY3RbcHJvcF0gPSBudWxsOwogICAgICAgICAgICAgICAgfSBjYXRjaChfZV8pIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIFRoaXMgcnVsZSBmb3IgSW50ZXJuZXQgRXhwbG9yZXIgOAogICAgICAgICAgICAgICAgaWYgKCdleGVjU2NyaXB0JyBpbiB3aW5kb3cpIHsKICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgKiB0byBJRTggb3ZlcnJpZGUgdGhlIGdsb2JhbCBwcm9wZXJ0aWVzIHVzaW5nCiAgICAgICAgICAgICAgICAgICAgICogVkJTY3JpcHQsIGRlY2xhcmluZyBpdCBpbiBnbG9iYWwgc2NvcGUgd2l0aAogICAgICAgICAgICAgICAgICAgICAqIHRoZSBzYW1lIG5hbWVzLgogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgIHdpbmRvd1snZXhlY1NjcmlwdCddKCdQdWJsaWMgJyArIHByb3AsICdWQlNjcmlwdCcpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAvKioKICAgICAgICAgICAgICAgICAgICAgICAgICogVGhpcyBoYWNrIGFsbG93cyB0byBvdmVycmlkZSBhIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAqIHdpdGggdGhlIHNldCAnY29uZmlndXJhYmxlOiBmYWxzZScsIHdvcmtpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICogaW4gdGhlIGhhY2sgJ1NhZmFyaScgdG8gJ01hYycKICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KG9iamVjdCwgcHJvcCwge3ZhbHVlOiBlbXB0eUZ1bmN0aW9ufSk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChfZV8pIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZXQgb2xkIHZhbHVlIHRvIG5ldyB2YXJpYWJsZQogICAgICAgICAgICAgICAgb2JqZWN0W3Byb3BdID0gb3JpZ2luYWxWYWx1ZTsKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWlzRGVmaW5lZFNldHRlciB8fCAhaXNEZWZpbmVkR2V0dGVyKSB7CiAgICAgICAgICAgICAgICAvLyB0aGUgbGFzdCBzdGFnZSBvZiB0cnlpbmcgdG8gb3ZlcnJpZGUgdGhlIHByb3BlcnR5CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdyYXAgdGhlIG9iamVjdCBpbiBhIG5ldyBlbXB0eSBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXAgPSBPYmplY3QuY3JlYXRlKG9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KE9iamVjdC5nZXRQcm90b3R5cGVPZih0ZW1wKSA9PT0gb2JqZWN0ID8gdGVtcCA6IG9iamVjdCwgcHJvcCwgZGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcih2YXIga2V5IGluIG9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbmVlZCB0byBiaW5kIGEgZnVuY3Rpb24gdG8gdGhlIG9yaWdpbmFsIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3Rba2V5XSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBba2V5XSA9IG9iamVjdFtrZXldLmJpbmQob2JqZWN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdG8gcnVuIGEgZnVuY3Rpb24gdGhhdCB3aWxsIGluZm9ybSBhYm91dCB3aGF0IHRoZSBvYmplY3Qgd2FzIHRvIHdyYXBwZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uV3JhcHBlZC5jYWxsKHRlbXAsIHRlbXAsIG9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0ID0gdGVtcDsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBzb21ldGltZXMgd29ya3Mgb3ZlcnJpZGUgc2ltcGx5IGJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIHByb3BlcnR5IG9mIHRoZSBjb25zdHJ1Y3RvcgogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShvYmplY3QuY29uc3RydWN0b3IucHJvdG90eXBlLCBwcm9wLCBkZXNjcmlwdG9yKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgICAgICAgICAgICAgIC8vIGFsbCBtZXRob2RzIGhhdmUgZmFpbGVkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb2JqZWN0OwogICAgfQoKICAgIC8qKgogICAgICogQWRkcyB0aGUgbWlzc2luZyBwcm9wZXJ0eSBpbiBkZXNjcmlwdG9yCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdCBBbiBvYmplY3QgdGhhdCBzdG9yZXMgdmFsdWVzCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcHJvcCBOYW1lIG9mIHRoZSBwcm9wZXJ0eSBpbiB0aGUgb2JqZWN0CiAgICAgKiBAcGFyYW0ge09iamVjdHxudWxsfSBkZXNjcmlwdG9yIERlc2NyaXB0b3IKICAgICAqIEByZXR1cm4ge09iamVjdH0gUmV0dXJucyB0aGUgZ2VuZXJhdGVkIGRlc2NyaXB0b3IKICAgICAqLwogICAgZnVuY3Rpb24gcHJlcGFyZURlc2NyaXB0b3JzRm9yT2JqZWN0KG9iamVjdCwgcHJvcCwgZGVzY3JpcHRvcikgewogICAgICAgIGRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yIHx8IHt9OwogICAgICAgIC8vIHRoZSBkZWZhdWx0IGZvciB0aGUgb2JqZWN0ICdsb2NhdGlvbicgaXMgdGhlIHN0YW5kYXJkIG9iamVjdCAnd2luZG93LmxvY2F0aW9uJwogICAgICAgIG9iamVjdCA9IG9iamVjdCA9PT0gbG9jYXRpb25EZXNjcmlwdG9ycyA/IHdpbmRvd0xvY2F0aW9uIDogb2JqZWN0OwogICAgICAgIC8vIHNldHRlciBmb3Igb2JqZWN0IHByb3BlcnRpZXMKICAgICAgICBkZXNjcmlwdG9yLnNldCA9IChkZXNjcmlwdG9yLnNldCB8fCBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICBvYmplY3RbcHJvcF0gPSB2YWx1ZTsKICAgICAgICB9KTsKICAgICAgICAvLyBnZXR0ZXIgZm9yIG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgICAgZGVzY3JpcHRvci5nZXQgPSAoZGVzY3JpcHRvci5nZXQgfHwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBvYmplY3RbcHJvcF07CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGRlc2NyaXB0b3I7CiAgICB9CgogICAgLyoqCiAgICAgKiBXcmFwcGVyIGZvciB0aGUgbWV0aG9kcyAnYWRkRXZlbnRMaXN0ZW5lci9hdHRhY2hFdmVudCcgaW4gdGhlIGNvbnRleHQgb2YgdGhlICd3aW5kb3cnCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0eXBlIGZvciB3aGljaCB0aGUgdXNlciBpcyByZWdpc3RlcmluZwogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgVGhlIG1ldGhvZCB0byBiZSBjYWxsZWQgd2hlbiB0aGUgZXZlbnQgb2NjdXJzLgogICAgICogQHBhcmFtIHtCb29sZWFufSBjYXB0dXJlIElmIHRydWUsIGNhcHR1cmUgaW5kaWNhdGVzIHRoYXQgdGhlIHVzZXIgd2lzaGVzIHRvIGluaXRpYXRlIGNhcHR1cmUuCiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIsIGNhcHR1cmUpIHsKICAgICAgICBpZiAoZXZlbnQgaW4gZXZlbnRzTGlzdCkgewogICAgICAgICAgICAvLyBoZXJlIHN0b3JlZCB0aGUgZXZlbnQgbGlzdGVuZXJzICdwb3BzdGF0ZS9oYXNoY2hhbmdlJwogICAgICAgICAgICBldmVudHNMaXN0W2V2ZW50XS5wdXNoKGxpc3RlbmVyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBGaXJlRm94IHN1cHBvcnQgbm9uLXN0YW5kYXJ0IGZvdXIgYXJndW1lbnQgYVdhbnRzVW50cnVzdGVkCiAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kZXZvdGUvSFRNTDUtSGlzdG9yeS1BUEkvaXNzdWVzLzEzCiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMykgewogICAgICAgICAgICAgICAgYWRkRXZlbnQoZXZlbnQsIGxpc3RlbmVyLCBjYXB0dXJlLCBhcmd1bWVudHNbM10pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWRkRXZlbnQoZXZlbnQsIGxpc3RlbmVyLCBjYXB0dXJlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFdyYXBwZXIgZm9yIHRoZSBtZXRob2RzICdyZW1vdmVFdmVudExpc3RlbmVyL2RldGFjaEV2ZW50JyBpbiB0aGUgY29udGV4dCBvZiB0aGUgJ3dpbmRvdycKICAgICAqCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZlbnQgVGhlIGV2ZW50IHR5cGUgZm9yIHdoaWNoIHRoZSB1c2VyIGlzIHJlZ2lzdGVyZWQKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBwYXJhbWV0ZXIgaW5kaWNhdGVzIHRoZSBMaXN0ZW5lciB0byBiZSByZW1vdmVkLgogICAgICogQHBhcmFtIHtCb29sZWFufSBjYXB0dXJlIFdhcyByZWdpc3RlcmVkIGFzIGEgY2FwdHVyaW5nIGxpc3RlbmVyIG9yIG5vdC4KICAgICAqIEByZXR1cm4gdm9pZAogICAgICovCiAgICBmdW5jdGlvbiByZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lciwgY2FwdHVyZSkgewogICAgICAgIHZhciBsaXN0ID0gZXZlbnRzTGlzdFtldmVudF07CiAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgZm9yKHZhciBpID0gbGlzdC5sZW5ndGg7IC0taTspIHsKICAgICAgICAgICAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lcikgewogICAgICAgICAgICAgICAgICAgIGxpc3Quc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVtb3ZlRXZlbnQoZXZlbnQsIGxpc3RlbmVyLCBjYXB0dXJlKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBXcmFwcGVyIGZvciB0aGUgbWV0aG9kcyAnZGlzcGF0Y2hFdmVudC9maXJlRXZlbnQnIGluIHRoZSBjb250ZXh0IG9mIHRoZSAnd2luZG93JwogICAgICoKICAgICAqIEBwYXJhbSB7RXZlbnR8U3RyaW5nfSBldmVudCBJbnN0YW5jZSBvZiBFdmVudCBvciBldmVudCB0eXBlIHN0cmluZyBpZiAnZXZlbnRPYmplY3QnIHVzZWQKICAgICAqIEBwYXJhbSB7Kn0gW2V2ZW50T2JqZWN0XSBGb3IgSW50ZXJuZXQgRXhwbG9yZXIgOCByZXF1aXJlZCBldmVudCBvYmplY3Qgb24gdGhpcyBhcmd1bWVudAogICAgICogQHJldHVybiB7Qm9vbGVhbn0gSWYgJ3ByZXZlbnREZWZhdWx0JyB3YXMgY2FsbGVkIHRoZSB2YWx1ZSBpcyBmYWxzZSwgZWxzZSB0aGUgdmFsdWUgaXMgdHJ1ZS4KICAgICAqLwogICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChldmVudCwgZXZlbnRPYmplY3QpIHsKICAgICAgICB2YXIgZXZlbnRUeXBlID0gKCcnICsgKHR5cGVvZiBldmVudCA9PT0gInN0cmluZyIgPyBldmVudCA6IGV2ZW50LnR5cGUpKS5yZXBsYWNlKC9eb24vLCAnJyk7CiAgICAgICAgdmFyIGxpc3QgPSBldmVudHNMaXN0W2V2ZW50VHlwZV07CiAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gbmVlZCB0byB1bmRlcnN0YW5kIHRoYXQgdGhlcmUgaXMgb25lIG9iamVjdCBvZiBFdmVudAogICAgICAgICAgICBldmVudE9iamVjdCA9IHR5cGVvZiBldmVudCA9PT0gInN0cmluZyIgPyBldmVudE9iamVjdCA6IGV2ZW50OwogICAgICAgICAgICBpZiAoZXZlbnRPYmplY3QudGFyZ2V0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIG5lZWQgdG8gb3ZlcnJpZGUgc29tZSBvZiB0aGUgcHJvcGVydGllcyBvZiB0aGUgRXZlbnQgb2JqZWN0CiAgICAgICAgICAgICAgICBmb3IodmFyIHByb3BzID0gWyd0YXJnZXQnLCAnY3VycmVudFRhcmdldCcsICdzcmNFbGVtZW50JywgJ3R5cGUnXTsgZXZlbnQgPSBwcm9wcy5wb3AoKTspIHsKICAgICAgICAgICAgICAgICAgICAvLyB1c2UgJ3JlZGVmaW5lUHJvcGVydHknIHRvIG92ZXJyaWRlIHRoZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgZXZlbnRPYmplY3QgPSByZWRlZmluZVByb3BlcnR5KGV2ZW50T2JqZWN0LCBldmVudCwgewogICAgICAgICAgICAgICAgICAgICAgICBnZXQ6IGV2ZW50ID09PSAndHlwZScgPyBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudFR5cGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3c7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBydW4gZnVuY3Rpb24gZGVmaW5lZCBpbiB0aGUgYXR0cmlidXRlcyAnb25wb3BzdGF0ZS9vbmhhc2hjaGFuZ2UnIGluIHRoZSAnd2luZG93JyBjb250ZXh0CiAgICAgICAgICAgICgoZXZlbnRUeXBlID09PSAncG9wc3RhdGUnID8gd2luZG93Lm9ucG9wc3RhdGUgOiB3aW5kb3cub25oYXNoY2hhbmdlKQogICAgICAgICAgICAgICAgfHwgZW1wdHlGdW5jdGlvbikuY2FsbCh3aW5kb3csIGV2ZW50T2JqZWN0KTsKICAgICAgICAgICAgLy8gcnVuIG90aGVyIGZ1bmN0aW9ucyB0aGF0IGFyZSBpbiB0aGUgbGlzdCBvZiBoYW5kbGVycwogICAgICAgICAgICBmb3IodmFyIGkgPSAwLCBsZW4gPSBsaXN0Lmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0W2ldLmNhbGwod2luZG93LCBldmVudE9iamVjdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BhdGNoKGV2ZW50LCBldmVudE9iamVjdCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogZGlzcGF0Y2ggY3VycmVudCBzdGF0ZSBldmVudAogICAgICovCiAgICBmdW5jdGlvbiBmaXJlUG9wU3RhdGUoKSB7CiAgICAgICAgdmFyIG8gPSBkb2N1bWVudC5jcmVhdGVFdmVudCA/IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdFdmVudCcpIDogZG9jdW1lbnQuY3JlYXRlRXZlbnRPYmplY3QoKTsKICAgICAgICBpZiAoby5pbml0RXZlbnQpIHsKICAgICAgICAgICAgby5pbml0RXZlbnQoJ3BvcHN0YXRlJywgZmFsc2UsIGZhbHNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvLnR5cGUgPSAncG9wc3RhdGUnOwogICAgICAgIH0KICAgICAgICBvLnN0YXRlID0gaGlzdG9yeU9iamVjdC5zdGF0ZTsKICAgICAgICAvLyBzZW5kIGEgbmV3bHkgY3JlYXRlZCBldmVudHMgdG8gYmUgcHJvY2Vzc2VkCiAgICAgICAgZGlzcGF0Y2hFdmVudChvKTsKICAgIH0KCiAgICAvKioKICAgICAqIGZpcmUgaW5pdGlhbCBzdGF0ZSBmb3Igbm9uLUhUTUw1IGJyb3dzZXJzCiAgICAgKi8KICAgIGZ1bmN0aW9uIGZpcmVJbml0aWFsU3RhdGUoKSB7CiAgICAgICAgaWYgKGlzRmlyZUluaXRpYWxTdGF0ZSkgewogICAgICAgICAgICBpc0ZpcmVJbml0aWFsU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgZmlyZVBvcFN0YXRlKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2hhbmdlIHRoZSBkYXRhIG9mIHRoZSBjdXJyZW50IGhpc3RvcnkgZm9yIEhUTUw0IGJyb3dzZXJzCiAgICAgKgogICAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3VybF0KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gW3JlcGxhY2VdCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2xhc3RVUkxWYWx1ZV0KICAgICAqIEByZXR1cm4gdm9pZAogICAgICovCiAgICBmdW5jdGlvbiBjaGFuZ2VTdGF0ZShzdGF0ZSwgdXJsLCByZXBsYWNlLCBsYXN0VVJMVmFsdWUpIHsKICAgICAgICBpZiAoIWlzU3VwcG9ydEhpc3RvcnlBUEkpIHsKICAgICAgICAgICAgLy8gbm9ybWFsaXphdGlvbiB1cmwKICAgICAgICAgICAgdmFyIHVybE9iamVjdCA9IHBhcnNlVVJMKHVybCk7CiAgICAgICAgICAgIC8vIGlmIGN1cnJlbnQgdXJsIG5vdCBlcXVhbCBuZXcgdXJsCiAgICAgICAgICAgIGlmICh1cmxPYmplY3QuX3JlbGF0aXZlICE9PSBwYXJzZVVSTCgpLl9yZWxhdGl2ZSkgewogICAgICAgICAgICAgICAgLy8gaWYgZW1wdHkgbGFzdFVSTFZhbHVlIHRvIHNraXAgaGFzaCBjaGFuZ2UgZXZlbnQKICAgICAgICAgICAgICAgIGxhc3RVUkwgPSBsYXN0VVJMVmFsdWU7CiAgICAgICAgICAgICAgICBpZiAocmVwbGFjZSkgewogICAgICAgICAgICAgICAgICAgIC8vIG9ubHkgcmVwbGFjZSBoYXNoLCBub3Qgc3RvcmUgdG8gaGlzdG9yeQogICAgICAgICAgICAgICAgICAgIHdpbmRvd0xvY2F0aW9uLnJlcGxhY2UoIiMiICsgdXJsT2JqZWN0Ll9zcGVjaWFsKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2hhbmdlIGhhc2ggYW5kIGFkZCBuZXcgcmVjb3JkIHRvIGhpc3RvcnkKICAgICAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5oYXNoID0gdXJsT2JqZWN0Ll9zcGVjaWFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghaXNTdXBwb3J0U3RhdGVPYmplY3RJbkhpc3RvcnkgJiYgc3RhdGUpIHsKICAgICAgICAgICAgc3RhdGVTdG9yYWdlW3dpbmRvd0xvY2F0aW9uLmhyZWZdID0gc3RhdGU7CiAgICAgICAgfQogICAgICAgIGlzRmlyZUluaXRpYWxTdGF0ZSA9IGZhbHNlOwogICAgfQoKICAgIC8qKgogICAgICogRXZlbnQgaGFuZGxlciBmdW5jdGlvbiBjaGFuZ2VzIHRoZSBoYXNoIGluIHRoZSBhZGRyZXNzIGJhcgogICAgICoKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50CiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gb25IYXNoQ2hhbmdlKGV2ZW50KSB7CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2Rldm90ZS9IVE1MNS1IaXN0b3J5LUFQSS9pc3N1ZXMvNDYKICAgICAgICB2YXIgZmlyZU5vdyA9IGxhc3RVUkw7CiAgICAgICAgLy8gbmV3IHZhbHVlIHRvIGxhc3RVUkwKICAgICAgICBsYXN0VVJMID0gd2luZG93TG9jYXRpb24uaHJlZjsKICAgICAgICAvLyBpZiBub3QgZW1wdHkgZmlyZU5vdywgb3RoZXJ3aXNlIHNraXBwZWQgdGhlIGN1cnJlbnQgaGFuZGxlciBldmVudAogICAgICAgIGlmIChmaXJlTm93KSB7CiAgICAgICAgICAgIC8vIGlmIGNoZWNrVXJsRm9yUG9wU3RhdGUgZXF1YWwgY3VycmVudCB1cmwsIHRoaXMgbWVhbnMgdGhhdCB0aGUgZXZlbnQgd2FzIHJhaXNlZCBwb3BzdGF0ZSBicm93c2VyCiAgICAgICAgICAgIGlmIChjaGVja1VybEZvclBvcFN0YXRlICE9PSB3aW5kb3dMb2NhdGlvbi5ocmVmKSB7CiAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UsCiAgICAgICAgICAgICAgICAvLyB0aGUgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IHBvcHN0YXRlIGV2ZW50IG9yIGp1c3QgZG9lcyBub3QgcnVuIHRoZSBldmVudCBieSBjaGFuZ2luZyB0aGUgaGFzaC4KICAgICAgICAgICAgICAgIGZpcmVQb3BTdGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGN1cnJlbnQgZXZlbnQgb2JqZWN0CiAgICAgICAgICAgIGV2ZW50ID0gZXZlbnQgfHwgd2luZG93LmV2ZW50OwoKICAgICAgICAgICAgdmFyIG9sZFVSTE9iamVjdCA9IHBhcnNlVVJMKGxhc3RVUkwsIHRydWUpOwogICAgICAgICAgICB2YXIgbmV3VVJMT2JqZWN0ID0gcGFyc2VVUkwoKTsKICAgICAgICAgICAgLy8gSFRNTDQgYnJvd3NlciBub3Qgc3VwcG9ydCBwcm9wZXJ0aWVzIG9sZFVSTC9uZXdVUkwKICAgICAgICAgICAgaWYgKCFldmVudC5vbGRVUkwpIHsKICAgICAgICAgICAgICAgIGV2ZW50Lm9sZFVSTCA9IG9sZFVSTE9iamVjdC5faHJlZjsKICAgICAgICAgICAgICAgIGV2ZW50Lm5ld1VSTCA9IG5ld1VSTE9iamVjdC5faHJlZjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkVVJMT2JqZWN0Ll9oYXNoICE9PSBuZXdVUkxPYmplY3QuX2hhc2gpIHsKICAgICAgICAgICAgICAgIC8vIGlmIGN1cnJlbnQgaGFzaCBub3QgZXF1YWwgcHJldmlvdXMgaGFzaAogICAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGUgZXZlbnQgaGFuZGxlciBpcyBmdWxseSBsb2FkZWQgZG9jdW1lbnQKICAgICAqCiAgICAgKiBAcGFyYW0geyp9IFtub1Njcm9sbF0KICAgICAqIEByZXR1cm4gdm9pZAogICAgICovCiAgICBmdW5jdGlvbiBvbkxvYWQobm9TY3JvbGwpIHsKICAgICAgICAvLyBHZXQgcmlkIG9mIHRoZSBldmVudHMgcG9wc3RhdGUgd2hlbiB0aGUgZmlyc3QgbG9hZGluZyBhIGRvY3VtZW50IGluIHRoZSB3ZWJraXQgYnJvd3NlcnMKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBoYW5nIHVwIHRoZSBldmVudCBoYW5kbGVyIGZvciB0aGUgYnVpbHQtaW4gcG9wc3RhdGUgZXZlbnQgaW4gdGhlIGJyb3dzZXIKICAgICAgICAgICAgYWRkRXZlbnQoJ3BvcHN0YXRlJywgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgLy8gc2V0IHRoZSBjdXJyZW50IHVybCwgdGhhdCBzdXBwcmVzcyB0aGUgY3JlYXRpb24gb2YgdGhlIHBvcHN0YXRlIGV2ZW50IGJ5IGNoYW5naW5nIHRoZSBoYXNoCiAgICAgICAgICAgICAgICBjaGVja1VybEZvclBvcFN0YXRlID0gd2luZG93TG9jYXRpb24uaHJlZjsKICAgICAgICAgICAgICAgIC8vIGZvciBTYWZhcmkgYnJvd3NlciBpbiBPUyBXaW5kb3dzIG5vdCBpbXBsZW1lbnRlZCAnc3RhdGUnIG9iamVjdCBpbiAnSGlzdG9yeScgaW50ZXJmYWNlCiAgICAgICAgICAgICAgICAvLyBhbmQgbm90IGltcGxlbWVudGVkIGluIG9sZCBIVE1MNCBicm93c2VycwogICAgICAgICAgICAgICAgaWYgKCFpc1N1cHBvcnRTdGF0ZU9iamVjdEluSGlzdG9yeSkgewogICAgICAgICAgICAgICAgICAgIGUgPSByZWRlZmluZVByb3BlcnR5KGUsICdzdGF0ZScsIHtnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGlzdG9yeU9iamVjdC5zdGF0ZTsKICAgICAgICAgICAgICAgICAgICB9fSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZW5kIGV2ZW50cyB0byBiZSBwcm9jZXNzZWQKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZSk7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9LCAwKTsKICAgICAgICAvLyBmb3Igbm9uLUhUTUw1IGJyb3dzZXJzCiAgICAgICAgaWYgKCFpc1N1cHBvcnRIaXN0b3J5QVBJICYmIG5vU2Nyb2xsICE9PSB0cnVlICYmIGhpc3RvcnlPYmplY3QubG9jYXRpb24pIHsKICAgICAgICAgICAgLy8gc2Nyb2xsIHdpbmRvdyB0byBhbmNob3IgZWxlbWVudAogICAgICAgICAgICBzY3JvbGxUb0FuY2hvcklkKGhpc3RvcnlPYmplY3QubG9jYXRpb24uaGFzaCk7CiAgICAgICAgICAgIC8vIGZpcmUgaW5pdGlhbCBzdGF0ZSBmb3Igbm9uLUhUTUw1IGJyb3dzZXIgYWZ0ZXIgbG9hZCBwYWdlCiAgICAgICAgICAgIGZpcmVJbml0aWFsU3RhdGUoKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBGaW5kcyB0aGUgY2xvc2VzdCBhbmNlc3RvciBhbmNob3IgZWxlbWVudCAoaW5jbHVkaW5nIHRoZSB0YXJnZXQgaXRzZWxmKS4KICAgICAqCiAgICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSB0YXJnZXQgVGhlIGVsZW1lbnQgdG8gc3RhcnQgc2Nhbm5pbmcgZnJvbS4KICAgICAqIEByZXR1cm4ge0hUTUxFbGVtZW50fSBBbiBlbGVtZW50IHdoaWNoIGlzIHRoZSBjbG9zZXN0IGFuY2VzdG9yIGFuY2hvci4KICAgICAqLwogICAgZnVuY3Rpb24gYW5jaG9yVGFyZ2V0KHRhcmdldCkgewogICAgICAgIHdoaWxlICh0YXJnZXQpIHsKICAgICAgICAgICAgaWYgKHRhcmdldC5ub2RlTmFtZSA9PT0gJ0EnKSByZXR1cm4gdGFyZ2V0OwogICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBIYW5kbGVzIGFuY2hvciBlbGVtZW50cyB3aXRoIGEgaGFzaCBmcmFnbWVudCBmb3Igbm9uLUhUTUw1IGJyb3dzZXJzCiAgICAgKgogICAgICogQHBhcmFtIHtFdmVudH0gZQogICAgICovCiAgICBmdW5jdGlvbiBvbkFuY2hvckNsaWNrKGUpIHsKICAgICAgICB2YXIgZXZlbnQgPSBlIHx8IHdpbmRvdy5ldmVudDsKICAgICAgICB2YXIgdGFyZ2V0ID0gYW5jaG9yVGFyZ2V0KGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50KTsKICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9ICJkZWZhdWx0UHJldmVudGVkIiBpbiBldmVudCA/IGV2ZW50WydkZWZhdWx0UHJldmVudGVkJ10gOiBldmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQubm9kZU5hbWUgPT09ICJBIiAmJiAhZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICB2YXIgY3VycmVudCA9IHBhcnNlVVJMKCk7CiAgICAgICAgICAgIHZhciBleHBlY3QgPSBwYXJzZVVSTCh0YXJnZXQuZ2V0QXR0cmlidXRlKCJocmVmIiwgMikpOwogICAgICAgICAgICB2YXIgaXNFcXVhbEJhc2VVUkwgPSBjdXJyZW50Ll9ocmVmLnNwbGl0KCcjJykuc2hpZnQoKSA9PT0gZXhwZWN0Ll9ocmVmLnNwbGl0KCcjJykuc2hpZnQoKTsKICAgICAgICAgICAgaWYgKGlzRXF1YWxCYXNlVVJMICYmIGV4cGVjdC5faGFzaCkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQuX2hhc2ggIT09IGV4cGVjdC5faGFzaCkgewogICAgICAgICAgICAgICAgICAgIGhpc3RvcnlPYmplY3QubG9jYXRpb24uaGFzaCA9IGV4cGVjdC5faGFzaDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNjcm9sbFRvQW5jaG9ySWQoZXhwZWN0Ll9oYXNoKTsKICAgICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBTY3JvbGwgcGFnZSB0byBjdXJyZW50IGFuY2hvciBpbiB1cmwtaGFzaAogICAgICoKICAgICAqIEBwYXJhbSBoYXNoCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNjcm9sbFRvQW5jaG9ySWQoaGFzaCkgewogICAgICAgIHZhciB0YXJnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoYXNoID0gKGhhc2ggfHwgJycpLnJlcGxhY2UoL14jLywgJycpKTsKICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5pZCA9PT0gaGFzaCAmJiB0YXJnZXQubm9kZU5hbWUgPT09ICJBIikgewogICAgICAgICAgICB2YXIgcmVjdCA9IHRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKChkb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdCB8fCAwKSwgcmVjdC50b3AgKyAoZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCB8fCAwKQogICAgICAgICAgICAgICAgLSAoZG9jdW1lbnRFbGVtZW50LmNsaWVudFRvcCB8fCAwKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogTGlicmFyeSBpbml0aWFsaXphdGlvbgogICAgICoKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IHJldHVybiB0cnVlIGlmIGFsbCBpcyB3ZWxsLCBvdGhlcndpc2UgcmV0dXJuIGZhbHNlIHZhbHVlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgICAgLyoqCiAgICAgICAgICogR2V0IGN1c3RvbSBzZXR0aW5ncyBmcm9tIHRoZSBxdWVyeSBzdHJpbmcKICAgICAgICAgKi8KICAgICAgICB2YXIgc2NyaXB0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKTsKICAgICAgICB2YXIgc3JjID0gKHNjcmlwdHNbc2NyaXB0cy5sZW5ndGggLSAxXSB8fCB7fSkuc3JjIHx8ICcnOwogICAgICAgIHZhciBhcmcgPSBzcmMuaW5kZXhPZignPycpICE9PSAtMSA/IHNyYy5zcGxpdCgnPycpLnBvcCgpIDogJyc7CiAgICAgICAgYXJnLnJlcGxhY2UoLyhcdyspKD86PShbXiZdKikpPy9nLCBmdW5jdGlvbihhLCBrZXksIHZhbHVlKSB7CiAgICAgICAgICAgIHNldHRpbmdzW2tleV0gPSAodmFsdWUgfHwgKGtleSA9PT0gJ2Jhc2VwYXRoJyA/ICcvJyA6ICcnKSkucmVwbGFjZSgvXigwfGZhbHNlKSQvLCAnJyk7CiAgICAgICAgfSk7CgogICAgICAgIC8qKgogICAgICAgICAqIGhhbmcgdXAgdGhlIGV2ZW50IGhhbmRsZXIgdG8gbGlzdGVuIHRvIHRoZSBldmVudHMgaGFzaGNoYW5nZQogICAgICAgICAqLwogICAgICAgIGFkZEV2ZW50KGV2ZW50TmFtZVByZWZpeCArICdoYXNoY2hhbmdlJywgb25IYXNoQ2hhbmdlLCBmYWxzZSk7CgogICAgICAgIC8vIGEgbGlzdCBvZiBvYmplY3RzIHdpdGggcGFpcnMgb2YgZGVzY3JpcHRvcnMvb2JqZWN0CiAgICAgICAgdmFyIGRhdGEgPSBbbG9jYXRpb25EZXNjcmlwdG9ycywgbG9jYXRpb25PYmplY3QsIGV2ZW50c0Rlc2NyaXB0b3JzLCB3aW5kb3csIGhpc3RvcnlEZXNjcmlwdG9ycywgaGlzdG9yeU9iamVjdF07CgogICAgICAgIC8vIGlmIGJyb3dzZXIgc3VwcG9ydCBvYmplY3QgJ3N0YXRlJyBpbiBpbnRlcmZhY2UgJ0hpc3RvcnknCiAgICAgICAgaWYgKGlzU3VwcG9ydFN0YXRlT2JqZWN0SW5IaXN0b3J5KSB7CiAgICAgICAgICAgIC8vIHJlbW92ZSBzdGF0ZSBwcm9wZXJ0eSBmcm9tIGRlc2NyaXB0b3IKICAgICAgICAgICAgZGVsZXRlIGhpc3RvcnlEZXNjcmlwdG9yc1snc3RhdGUnXTsKICAgICAgICB9CgogICAgICAgIC8vIGluaXRpYWxpemluZyBkZXNjcmlwdG9ycwogICAgICAgIGZvcih2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIGZvcih2YXIgcHJvcCBpbiBkYXRhW2ldKSB7CiAgICAgICAgICAgICAgICBpZiAoZGF0YVtpXS5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YVtpXVtwcm9wXSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgZGVzY3JpcHRvciBpcyBhIHNpbXBsZSBmdW5jdGlvbiwgc2ltcGx5IGp1c3QgYXNzaWduIGl0IGFuIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhW2kgKyAxXVtwcm9wXSA9IGRhdGFbaV1bcHJvcF07CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gcHJlcGFyZSB0aGUgZGVzY3JpcHRvciB0aGUgcmVxdWlyZWQgZm9ybWF0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXNjcmlwdG9yID0gcHJlcGFyZURlc2NyaXB0b3JzRm9yT2JqZWN0KGRhdGFbaV0sIHByb3AsIGRhdGFbaV1bcHJvcF0pOwogICAgICAgICAgICAgICAgICAgICAgICAvLyB0cnkgdG8gc2V0IHRoZSBkZXNjcmlwdG9yIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlZGVmaW5lUHJvcGVydHkoZGF0YVtpICsgMV0sIHByb3AsIGRlc2NyaXB0b3IsIGZ1bmN0aW9uKG4sIG8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlzIHNhdGlzZmllZCBpZiB0aGUgZmFpbGVkIG92ZXJyaWRlIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobyA9PT0gaGlzdG9yeU9iamVjdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSBwcm9ibGVtIG9jY3VycyBpbiBTYWZhcmkgb24gdGhlIE1hYwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5ID0gaGlzdG9yeU9iamVjdCA9IGRhdGFbaSArIDFdID0gbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHRoZXJlIGlzIG5vIHBvc3NpYmlsaXR5IG92ZXJyaWRlLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgZGVzY3JpcHRvcnMsIHN1Y2ggYXMgSUU3CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVtb3ZlIHByZXZpb3VzbHkgaHVuZyBldmVudCBoYW5kbGVycwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRXZlbnQoZXZlbnROYW1lUHJlZml4ICsgJ2hhc2hjaGFuZ2UnLCBvbkhhc2hDaGFuZ2UsIGZhbHNlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmYWlsIHRvIGluaXRpYWxpemUgOigKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY3JlYXRlIGEgcmVwb3NpdG9yeSBmb3IgY3VzdG9tIGhhbmRsZXJzIG9ucG9wc3RhdGUvb25oYXNoY2hhbmdlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhW2kgKyAxXSA9PT0gd2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudHNMaXN0W3Byb3BdID0gZXZlbnRzTGlzdFtwcm9wLnN1YnN0cigyKV0gPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gcmVkaXJlY3QgaWYgbmVjZXNzYXJ5CiAgICAgICAgaWYgKHNldHRpbmdzWydyZWRpcmVjdCddKSB7CiAgICAgICAgICAgIGhpc3RvcnlPYmplY3RbJ3JlZGlyZWN0J10oKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBvYmplY3QgJ3N0YXRlJyBpbiBpbnRlcmZhY2UgJ0hpc3RvcnknCiAgICAgICAgaWYgKCFpc1N1cHBvcnRTdGF0ZU9iamVjdEluSGlzdG9yeSAmJiBKU09OKSB7CiAgICAgICAgICAgIHN0b3JhZ2VJbml0aWFsaXplKCk7CiAgICAgICAgfQoKICAgICAgICAvLyB0cmFjayBjbGlja3Mgb24gYW5jaG9ycwogICAgICAgIGlmICghaXNTdXBwb3J0SGlzdG9yeUFQSSkgewogICAgICAgICAgICBkb2N1bWVudFthZGRFdmVudExpc3RlbmVyTmFtZV0oZXZlbnROYW1lUHJlZml4ICsgImNsaWNrIiwgb25BbmNob3JDbGljaywgZmFsc2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICAgICAgICAgICAgb25Mb2FkKHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICghaXNTdXBwb3J0SGlzdG9yeUFQSSAmJiBwYXJzZVVSTCgpLl9yZWxhdGl2ZSAhPT0gc2V0dGluZ3NbImJhc2VwYXRoIl0pIHsKICAgICAgICAgICAgICAgIGlzRmlyZUluaXRpYWxTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIE5lZWQgdG8gYXZvaWQgdHJpZ2dlcmluZyBldmVudHMgcG9wc3RhdGUgdGhlIGluaXRpYWwgcGFnZSBsb2FkLgogICAgICAgICAgICAgKiBIYW5nIGhhbmRsZXIgcG9wc3RhdGUgYXMgd2lsbCBiZSBmdWxseSBsb2FkZWQgZG9jdW1lbnQgdGhhdAogICAgICAgICAgICAgKiB3b3VsZCBwcmV2ZW50IHRyaWdnZXJpbmcgZXZlbnQgb25wb3BzdGF0ZQogICAgICAgICAgICAgKi8KICAgICAgICAgICAgYWRkRXZlbnQoZXZlbnROYW1lUHJlZml4ICsgJ2xvYWQnLCBvbkxvYWQsIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIC8vIGV2ZXJ5dGhpbmcgd2VudCB3ZWxsCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdGFydGluZyB0aGUgbGlicmFyeQogICAgICovCiAgICBpZiAoIWluaXRpYWxpemUoKSkgewogICAgICAgIC8vIGlmIHVuYWJsZSB0byBpbml0aWFsaXplIGRlc2NyaXB0b3JzCiAgICAgICAgLy8gdGhlcmVmb3JlIHF1aXRlIG9sZCBicm93c2VyIGFuZCB0aGVyZQogICAgICAgIC8vIGlzIG5vIHNlbnNlIHRvIGNvbnRpbnVlIHRvIHBlcmZvcm0KICAgICAgICByZXR1cm47CiAgICB9CgogICAgLyoqCiAgICAgKiBJZiB0aGUgcHJvcGVydHkgaGlzdG9yeS5lbXVsYXRlIHdpbGwgYmUgdHJ1ZSwKICAgICAqIHRoaXMgd2lsbCBiZSB0YWxraW5nIGFib3V0IHdoYXQncyBnb2luZyBvbgogICAgICogZW11bGF0aW9uIGNhcGFiaWxpdGllcyBIVE1MNS1IaXN0b3J5LUFQSS4KICAgICAqIE90aGVyd2lzZSB0aGVyZSBpcyBubyBlbXVsYXRpb24sIGllIHRoZQogICAgICogYnVpbHQtaW4gYnJvd3NlciBjYXBhYmlsaXRpZXMuCiAgICAgKgogICAgICogQHR5cGUge2Jvb2xlYW59CiAgICAgKiBAY29uc3QKICAgICAqLwogICAgaGlzdG9yeU9iamVjdFsnZW11bGF0ZSddID0gIWlzU3VwcG9ydEhpc3RvcnlBUEk7CgogICAgLyoqCiAgICAgKiBSZXBsYWNlIHRoZSBvcmlnaW5hbCBtZXRob2RzIG9uIHRoZSB3cmFwcGVyCiAgICAgKi8KICAgIHdpbmRvd1thZGRFdmVudExpc3RlbmVyTmFtZV0gPSBhZGRFdmVudExpc3RlbmVyOwogICAgd2luZG93W3JlbW92ZUV2ZW50TGlzdGVuZXJOYW1lXSA9IHJlbW92ZUV2ZW50TGlzdGVuZXI7CiAgICB3aW5kb3dbZGlzcGF0Y2hFdmVudE5hbWVdID0gZGlzcGF0Y2hFdmVudDsKCn0pKHdpbmRvdyk7Ci8qKgogKiBDb3B5cmlnaHQgKGMpIDIwMTEtMjAxNCBGZWxpeCBHbmFzcwogKiBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICovCihmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CgogIC8qIENvbW1vbkpTICovCiAgaWYgKHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnKSAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCkKCiAgLyogQU1EIG1vZHVsZSAqLwogIGVsc2UgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoZmFjdG9yeSkKCiAgLyogQnJvd3NlciBnbG9iYWwgKi8KICBlbHNlIHJvb3QuU3Bpbm5lciA9IGZhY3RvcnkoKQp9Cih0aGlzLCBmdW5jdGlvbigpIHsKICAidXNlIHN0cmljdCI7CgogIHZhciBwcmVmaXhlcyA9IFsnd2Via2l0JywgJ01veicsICdtcycsICdPJ10gLyogVmVuZG9yIHByZWZpeGVzICovCiAgICAsIGFuaW1hdGlvbnMgPSB7fSAvKiBBbmltYXRpb24gcnVsZXMga2V5ZWQgYnkgdGhlaXIgbmFtZSAqLwogICAgLCB1c2VDc3NBbmltYXRpb25zIC8qIFdoZXRoZXIgdG8gdXNlIENTUyBhbmltYXRpb25zIG9yIHNldFRpbWVvdXQgKi8KCiAgLyoqCiAgICogVXRpbGl0eSBmdW5jdGlvbiB0byBjcmVhdGUgZWxlbWVudHMuIElmIG5vIHRhZyBuYW1lIGlzIGdpdmVuLAogICAqIGEgRElWIGlzIGNyZWF0ZWQuIE9wdGlvbmFsbHkgcHJvcGVydGllcyBjYW4gYmUgcGFzc2VkLgogICAqLwogIGZ1bmN0aW9uIGNyZWF0ZUVsKHRhZywgcHJvcCkgewogICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcgfHwgJ2RpdicpCiAgICAgICwgbgoKICAgIGZvcihuIGluIHByb3ApIGVsW25dID0gcHJvcFtuXQogICAgcmV0dXJuIGVsCiAgfQoKICAvKioKICAgKiBBcHBlbmRzIGNoaWxkcmVuIGFuZCByZXR1cm5zIHRoZSBwYXJlbnQuCiAgICovCiAgZnVuY3Rpb24gaW5zKHBhcmVudCAvKiBjaGlsZDEsIGNoaWxkMiwgLi4uKi8pIHsKICAgIGZvciAodmFyIGk9MSwgbj1hcmd1bWVudHMubGVuZ3RoOyBpPG47IGkrKykKICAgICAgcGFyZW50LmFwcGVuZENoaWxkKGFyZ3VtZW50c1tpXSkKCiAgICByZXR1cm4gcGFyZW50CiAgfQoKICAvKioKICAgKiBJbnNlcnQgYSBuZXcgc3R5bGVzaGVldCB0byBob2xkIHRoZSBAa2V5ZnJhbWUgb3IgVk1MIHJ1bGVzLgogICAqLwogIHZhciBzaGVldCA9IChmdW5jdGlvbigpIHsKICAgIHZhciBlbCA9IGNyZWF0ZUVsKCdzdHlsZScsIHt0eXBlIDogJ3RleHQvY3NzJ30pCiAgICBpbnMoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2hlYWQnKVswXSwgZWwpCiAgICByZXR1cm4gZWwuc2hlZXQgfHwgZWwuc3R5bGVTaGVldAogIH0oKSkKCiAgLyoqCiAgICogQ3JlYXRlcyBhbiBvcGFjaXR5IGtleWZyYW1lIGFuaW1hdGlvbiBydWxlIGFuZCByZXR1cm5zIGl0cyBuYW1lLgogICAqIFNpbmNlIG1vc3QgbW9iaWxlIFdlYmtpdHMgaGF2ZSB0aW1pbmcgaXNzdWVzIHdpdGggYW5pbWF0aW9uLWRlbGF5LAogICAqIHdlIGNyZWF0ZSBzZXBhcmF0ZSBydWxlcyBmb3IgZWFjaCBsaW5lL3NlZ21lbnQuCiAgICovCiAgZnVuY3Rpb24gYWRkQW5pbWF0aW9uKGFscGhhLCB0cmFpbCwgaSwgbGluZXMpIHsKICAgIHZhciBuYW1lID0gWydvcGFjaXR5JywgdHJhaWwsIH5+KGFscGhhKjEwMCksIGksIGxpbmVzXS5qb2luKCctJykKICAgICAgLCBzdGFydCA9IDAuMDEgKyBpL2xpbmVzICogMTAwCiAgICAgICwgeiA9IE1hdGgubWF4KDEgLSAoMS1hbHBoYSkgLyB0cmFpbCAqICgxMDAtc3RhcnQpLCBhbHBoYSkKICAgICAgLCBwcmVmaXggPSB1c2VDc3NBbmltYXRpb25zLnN1YnN0cmluZygwLCB1c2VDc3NBbmltYXRpb25zLmluZGV4T2YoJ0FuaW1hdGlvbicpKS50b0xvd2VyQ2FzZSgpCiAgICAgICwgcHJlID0gcHJlZml4ICYmICctJyArIHByZWZpeCArICctJyB8fCAnJwoKICAgIGlmICghYW5pbWF0aW9uc1tuYW1lXSkgewogICAgICBzaGVldC5pbnNlcnRSdWxlKAogICAgICAgICdAJyArIHByZSArICdrZXlmcmFtZXMgJyArIG5hbWUgKyAneycgKwogICAgICAgICcwJXtvcGFjaXR5OicgKyB6ICsgJ30nICsKICAgICAgICBzdGFydCArICcle29wYWNpdHk6JyArIGFscGhhICsgJ30nICsKICAgICAgICAoc3RhcnQrMC4wMSkgKyAnJXtvcGFjaXR5OjF9JyArCiAgICAgICAgKHN0YXJ0K3RyYWlsKSAlIDEwMCArICcle29wYWNpdHk6JyArIGFscGhhICsgJ30nICsKICAgICAgICAnMTAwJXtvcGFjaXR5OicgKyB6ICsgJ30nICsKICAgICAgICAnfScsIHNoZWV0LmNzc1J1bGVzLmxlbmd0aCkKCiAgICAgIGFuaW1hdGlvbnNbbmFtZV0gPSAxCiAgICB9CgogICAgcmV0dXJuIG5hbWUKICB9CgogIC8qKgogICAqIFRyaWVzIHZhcmlvdXMgdmVuZG9yIHByZWZpeGVzIGFuZCByZXR1cm5zIHRoZSBmaXJzdCBzdXBwb3J0ZWQgcHJvcGVydHkuCiAgICovCiAgZnVuY3Rpb24gdmVuZG9yKGVsLCBwcm9wKSB7CiAgICB2YXIgcyA9IGVsLnN0eWxlCiAgICAgICwgcHAKICAgICAgLCBpCgogICAgcHJvcCA9IHByb3AuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBwcm9wLnNsaWNlKDEpCiAgICBmb3IoaT0wOyBpPHByZWZpeGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHBwID0gcHJlZml4ZXNbaV0rcHJvcAogICAgICBpZihzW3BwXSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gcHAKICAgIH0KICAgIGlmKHNbcHJvcF0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIHByb3AKICB9CgogIC8qKgogICAqIFNldHMgbXVsdGlwbGUgc3R5bGUgcHJvcGVydGllcyBhdCBvbmNlLgogICAqLwogIGZ1bmN0aW9uIGNzcyhlbCwgcHJvcCkgewogICAgZm9yICh2YXIgbiBpbiBwcm9wKQogICAgICBlbC5zdHlsZVt2ZW5kb3IoZWwsIG4pfHxuXSA9IHByb3Bbbl0KCiAgICByZXR1cm4gZWwKICB9CgogIC8qKgogICAqIEZpbGxzIGluIGRlZmF1bHQgdmFsdWVzLgogICAqLwogIGZ1bmN0aW9uIG1lcmdlKG9iaikgewogICAgZm9yICh2YXIgaT0xOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBkZWYgPSBhcmd1bWVudHNbaV0KICAgICAgZm9yICh2YXIgbiBpbiBkZWYpCiAgICAgICAgaWYgKG9ialtuXSA9PT0gdW5kZWZpbmVkKSBvYmpbbl0gPSBkZWZbbl0KICAgIH0KICAgIHJldHVybiBvYmoKICB9CgogIC8qKgogICAqIFJldHVybnMgdGhlIGFic29sdXRlIHBhZ2Utb2Zmc2V0IG9mIHRoZSBnaXZlbiBlbGVtZW50LgogICAqLwogIGZ1bmN0aW9uIHBvcyhlbCkgewogICAgdmFyIG8gPSB7IHg6ZWwub2Zmc2V0TGVmdCwgeTplbC5vZmZzZXRUb3AgfQogICAgd2hpbGUoKGVsID0gZWwub2Zmc2V0UGFyZW50KSkKICAgICAgby54Kz1lbC5vZmZzZXRMZWZ0LCBvLnkrPWVsLm9mZnNldFRvcAoKICAgIHJldHVybiBvCiAgfQoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBsaW5lIGNvbG9yIGZyb20gdGhlIGdpdmVuIHN0cmluZyBvciBhcnJheS4KICAgKi8KICBmdW5jdGlvbiBnZXRDb2xvcihjb2xvciwgaWR4KSB7CiAgICByZXR1cm4gdHlwZW9mIGNvbG9yID09ICdzdHJpbmcnID8gY29sb3IgOiBjb2xvcltpZHggJSBjb2xvci5sZW5ndGhdCiAgfQoKICAvLyBCdWlsdC1pbiBkZWZhdWx0cwoKICB2YXIgZGVmYXVsdHMgPSB7CiAgICBsaW5lczogMTIsICAgICAgICAgICAgLy8gVGhlIG51bWJlciBvZiBsaW5lcyB0byBkcmF3CiAgICBsZW5ndGg6IDcsICAgICAgICAgICAgLy8gVGhlIGxlbmd0aCBvZiBlYWNoIGxpbmUKICAgIHdpZHRoOiA1LCAgICAgICAgICAgICAvLyBUaGUgbGluZSB0aGlja25lc3MKICAgIHJhZGl1czogMTAsICAgICAgICAgICAvLyBUaGUgcmFkaXVzIG9mIHRoZSBpbm5lciBjaXJjbGUKICAgIHJvdGF0ZTogMCwgICAgICAgICAgICAvLyBSb3RhdGlvbiBvZmZzZXQKICAgIGNvcm5lcnM6IDEsICAgICAgICAgICAvLyBSb3VuZG5lc3MgKDAuLjEpCiAgICBjb2xvcjogJyMwMDAnLCAgICAgICAgLy8gI3JnYiBvciAjcnJnZ2JiCiAgICBkaXJlY3Rpb246IDEsICAgICAgICAgLy8gMTogY2xvY2t3aXNlLCAtMTogY291bnRlcmNsb2Nrd2lzZQogICAgc3BlZWQ6IDEsICAgICAgICAgICAgIC8vIFJvdW5kcyBwZXIgc2Vjb25kCiAgICB0cmFpbDogMTAwLCAgICAgICAgICAgLy8gQWZ0ZXJnbG93IHBlcmNlbnRhZ2UKICAgIG9wYWNpdHk6IDEvNCwgICAgICAgICAvLyBPcGFjaXR5IG9mIHRoZSBsaW5lcwogICAgZnBzOiAyMCwgICAgICAgICAgICAgIC8vIEZyYW1lcyBwZXIgc2Vjb25kIHdoZW4gdXNpbmcgc2V0VGltZW91dCgpCiAgICB6SW5kZXg6IDJlOSwgICAgICAgICAgLy8gVXNlIGEgaGlnaCB6LWluZGV4IGJ5IGRlZmF1bHQKICAgIGNsYXNzTmFtZTogJ3NwaW5uZXInLCAvLyBDU1MgY2xhc3MgdG8gYXNzaWduIHRvIHRoZSBlbGVtZW50CiAgICB0b3A6ICc1MCUnLCAgICAgICAgICAgLy8gY2VudGVyIHZlcnRpY2FsbHkKICAgIGxlZnQ6ICc1MCUnLCAgICAgICAgICAvLyBjZW50ZXIgaG9yaXpvbnRhbGx5CiAgICBwb3NpdGlvbjogJ2Fic29sdXRlJyAgLy8gZWxlbWVudCBwb3NpdGlvbgogIH0KCiAgLyoqIFRoZSBjb25zdHJ1Y3RvciAqLwogIGZ1bmN0aW9uIFNwaW5uZXIobykgewogICAgdGhpcy5vcHRzID0gbWVyZ2UobyB8fCB7fSwgU3Bpbm5lci5kZWZhdWx0cywgZGVmYXVsdHMpCiAgfQoKICAvLyBHbG9iYWwgZGVmYXVsdHMgdGhhdCBvdmVycmlkZSB0aGUgYnVpbHQtaW5zOgogIFNwaW5uZXIuZGVmYXVsdHMgPSB7fQoKICBtZXJnZShTcGlubmVyLnByb3RvdHlwZSwgewoKICAgIC8qKgogICAgICogQWRkcyB0aGUgc3Bpbm5lciB0byB0aGUgZ2l2ZW4gdGFyZ2V0IGVsZW1lbnQuIElmIHRoaXMgaW5zdGFuY2UgaXMgYWxyZWFkeQogICAgICogc3Bpbm5pbmcsIGl0IGlzIGF1dG9tYXRpY2FsbHkgcmVtb3ZlZCBmcm9tIGl0cyBwcmV2aW91cyB0YXJnZXQgYiBjYWxsaW5nCiAgICAgKiBzdG9wKCkgaW50ZXJuYWxseS4KICAgICAqLwogICAgc3BpbjogZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgIHRoaXMuc3RvcCgpCgogICAgICB2YXIgc2VsZiA9IHRoaXMKICAgICAgICAsIG8gPSBzZWxmLm9wdHMKICAgICAgICAsIGVsID0gc2VsZi5lbCA9IGNzcyhjcmVhdGVFbCgwLCB7Y2xhc3NOYW1lOiBvLmNsYXNzTmFtZX0pLCB7cG9zaXRpb246IG8ucG9zaXRpb24sIHdpZHRoOiAwLCB6SW5kZXg6IG8uekluZGV4fSkKICAgICAgICAsIG1pZCA9IG8ucmFkaXVzK28ubGVuZ3RoK28ud2lkdGgKCiAgICAgIGNzcyhlbCwgewogICAgICAgIGxlZnQ6IG8ubGVmdCwKICAgICAgICB0b3A6IG8udG9wCiAgICAgIH0pCiAgICAgICAgCiAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICB0YXJnZXQuaW5zZXJ0QmVmb3JlKGVsLCB0YXJnZXQuZmlyc3RDaGlsZHx8bnVsbCkKICAgICAgfQoKICAgICAgZWwuc2V0QXR0cmlidXRlKCdyb2xlJywgJ3Byb2dyZXNzYmFyJykKICAgICAgc2VsZi5saW5lcyhlbCwgc2VsZi5vcHRzKQoKICAgICAgaWYgKCF1c2VDc3NBbmltYXRpb25zKSB7CiAgICAgICAgLy8gTm8gQ1NTIGFuaW1hdGlvbiBzdXBwb3J0LCB1c2Ugc2V0VGltZW91dCgpIGluc3RlYWQKICAgICAgICB2YXIgaSA9IDAKICAgICAgICAgICwgc3RhcnQgPSAoby5saW5lcyAtIDEpICogKDEgLSBvLmRpcmVjdGlvbikgLyAyCiAgICAgICAgICAsIGFscGhhCiAgICAgICAgICAsIGZwcyA9IG8uZnBzCiAgICAgICAgICAsIGYgPSBmcHMvby5zcGVlZAogICAgICAgICAgLCBvc3RlcCA9ICgxLW8ub3BhY2l0eSkgLyAoZipvLnRyYWlsIC8gMTAwKQogICAgICAgICAgLCBhc3RlcCA9IGYvby5saW5lcwoKICAgICAgICA7KGZ1bmN0aW9uIGFuaW0oKSB7CiAgICAgICAgICBpKys7CiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG8ubGluZXM7IGorKykgewogICAgICAgICAgICBhbHBoYSA9IE1hdGgubWF4KDEgLSAoaSArIChvLmxpbmVzIC0gaikgKiBhc3RlcCkgJSBmICogb3N0ZXAsIG8ub3BhY2l0eSkKCiAgICAgICAgICAgIHNlbGYub3BhY2l0eShlbCwgaiAqIG8uZGlyZWN0aW9uICsgc3RhcnQsIGFscGhhLCBvKQogICAgICAgICAgfQogICAgICAgICAgc2VsZi50aW1lb3V0ID0gc2VsZi5lbCAmJiBzZXRUaW1lb3V0KGFuaW0sIH5+KDEwMDAvZnBzKSkKICAgICAgICB9KSgpCiAgICAgIH0KICAgICAgcmV0dXJuIHNlbGYKICAgIH0sCgogICAgLyoqCiAgICAgKiBTdG9wcyBhbmQgcmVtb3ZlcyB0aGUgU3Bpbm5lci4KICAgICAqLwogICAgc3RvcDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBlbCA9IHRoaXMuZWwKICAgICAgaWYgKGVsKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCkKICAgICAgICBpZiAoZWwucGFyZW50Tm9kZSkgZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlbCkKICAgICAgICB0aGlzLmVsID0gdW5kZWZpbmVkCiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCBkcmF3cyB0aGUgaW5kaXZpZHVhbCBsaW5lcy4gV2lsbCBiZSBvdmVyd3JpdHRlbgogICAgICogaW4gVk1MIGZhbGxiYWNrIG1vZGUgYmVsb3cuCiAgICAgKi8KICAgIGxpbmVzOiBmdW5jdGlvbihlbCwgbykgewogICAgICB2YXIgaSA9IDAKICAgICAgICAsIHN0YXJ0ID0gKG8ubGluZXMgLSAxKSAqICgxIC0gby5kaXJlY3Rpb24pIC8gMgogICAgICAgICwgc2VnCgogICAgICBmdW5jdGlvbiBmaWxsKGNvbG9yLCBzaGFkb3cpIHsKICAgICAgICByZXR1cm4gY3NzKGNyZWF0ZUVsKCksIHsKICAgICAgICAgIHBvc2l0aW9uOiAnYWJzb2x1dGUnLAogICAgICAgICAgd2lkdGg6IChvLmxlbmd0aCtvLndpZHRoKSArICdweCcsCiAgICAgICAgICBoZWlnaHQ6IG8ud2lkdGggKyAncHgnLAogICAgICAgICAgYmFja2dyb3VuZDogY29sb3IsCiAgICAgICAgICBib3hTaGFkb3c6IHNoYWRvdywKICAgICAgICAgIHRyYW5zZm9ybU9yaWdpbjogJ2xlZnQnLAogICAgICAgICAgdHJhbnNmb3JtOiAncm90YXRlKCcgKyB+figzNjAvby5saW5lcyppK28ucm90YXRlKSArICdkZWcpIHRyYW5zbGF0ZSgnICsgby5yYWRpdXMrJ3B4JyArJywwKScsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IChvLmNvcm5lcnMgKiBvLndpZHRoPj4xKSArICdweCcKICAgICAgICB9KQogICAgICB9CgogICAgICBmb3IgKDsgaSA8IG8ubGluZXM7IGkrKykgewogICAgICAgIHNlZyA9IGNzcyhjcmVhdGVFbCgpLCB7CiAgICAgICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywKICAgICAgICAgIHRvcDogMSt+KG8ud2lkdGgvMikgKyAncHgnLAogICAgICAgICAgdHJhbnNmb3JtOiBvLmh3YWNjZWwgPyAndHJhbnNsYXRlM2QoMCwwLDApJyA6ICcnLAogICAgICAgICAgb3BhY2l0eTogby5vcGFjaXR5LAogICAgICAgICAgYW5pbWF0aW9uOiB1c2VDc3NBbmltYXRpb25zICYmIGFkZEFuaW1hdGlvbihvLm9wYWNpdHksIG8udHJhaWwsIHN0YXJ0ICsgaSAqIG8uZGlyZWN0aW9uLCBvLmxpbmVzKSArICcgJyArIDEvby5zcGVlZCArICdzIGxpbmVhciBpbmZpbml0ZScKICAgICAgICB9KQoKICAgICAgICBpZiAoby5zaGFkb3cpIGlucyhzZWcsIGNzcyhmaWxsKCcjMDAwJywgJzAgMCA0cHggJyArICcjMDAwJyksIHt0b3A6IDIrJ3B4J30pKQogICAgICAgIGlucyhlbCwgaW5zKHNlZywgZmlsbChnZXRDb2xvcihvLmNvbG9yLCBpKSwgJzAgMCAxcHggcmdiYSgwLDAsMCwuMSknKSkpCiAgICAgIH0KICAgICAgcmV0dXJuIGVsCiAgICB9LAoKICAgIC8qKgogICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgYWRqdXN0cyB0aGUgb3BhY2l0eSBvZiBhIHNpbmdsZSBsaW5lLgogICAgICogV2lsbCBiZSBvdmVyd3JpdHRlbiBpbiBWTUwgZmFsbGJhY2sgbW9kZSBiZWxvdy4KICAgICAqLwogICAgb3BhY2l0eTogZnVuY3Rpb24oZWwsIGksIHZhbCkgewogICAgICBpZiAoaSA8IGVsLmNoaWxkTm9kZXMubGVuZ3RoKSBlbC5jaGlsZE5vZGVzW2ldLnN0eWxlLm9wYWNpdHkgPSB2YWwKICAgIH0KCiAgfSkKCgogIGZ1bmN0aW9uIGluaXRWTUwoKSB7CgogICAgLyogVXRpbGl0eSBmdW5jdGlvbiB0byBjcmVhdGUgYSBWTUwgdGFnICovCiAgICBmdW5jdGlvbiB2bWwodGFnLCBhdHRyKSB7CiAgICAgIHJldHVybiBjcmVhdGVFbCgnPCcgKyB0YWcgKyAnIHhtbG5zPSJ1cm46c2NoZW1hcy1taWNyb3NvZnQuY29tOnZtbCIgY2xhc3M9InNwaW4tdm1sIj4nLCBhdHRyKQogICAgfQoKICAgIC8vIE5vIENTUyB0cmFuc2Zvcm1zIGJ1dCBWTUwgc3VwcG9ydCwgYWRkIGEgQ1NTIHJ1bGUgZm9yIFZNTCBlbGVtZW50czoKICAgIHNoZWV0LmFkZFJ1bGUoJy5zcGluLXZtbCcsICdiZWhhdmlvcjp1cmwoI2RlZmF1bHQjVk1MKScpCgogICAgU3Bpbm5lci5wcm90b3R5cGUubGluZXMgPSBmdW5jdGlvbihlbCwgbykgewogICAgICB2YXIgciA9IG8ubGVuZ3RoK28ud2lkdGgKICAgICAgICAsIHMgPSAyKnIKCiAgICAgIGZ1bmN0aW9uIGdycCgpIHsKICAgICAgICByZXR1cm4gY3NzKAogICAgICAgICAgdm1sKCdncm91cCcsIHsKICAgICAgICAgICAgY29vcmRzaXplOiBzICsgJyAnICsgcywKICAgICAgICAgICAgY29vcmRvcmlnaW46IC1yICsgJyAnICsgLXIKICAgICAgICAgIH0pLAogICAgICAgICAgeyB3aWR0aDogcywgaGVpZ2h0OiBzIH0KICAgICAgICApCiAgICAgIH0KCiAgICAgIHZhciBtYXJnaW4gPSAtKG8ud2lkdGgrby5sZW5ndGgpKjIgKyAncHgnCiAgICAgICAgLCBnID0gY3NzKGdycCgpLCB7cG9zaXRpb246ICdhYnNvbHV0ZScsIHRvcDogbWFyZ2luLCBsZWZ0OiBtYXJnaW59KQogICAgICAgICwgaQoKICAgICAgZnVuY3Rpb24gc2VnKGksIGR4LCBmaWx0ZXIpIHsKICAgICAgICBpbnMoZywKICAgICAgICAgIGlucyhjc3MoZ3JwKCksIHtyb3RhdGlvbjogMzYwIC8gby5saW5lcyAqIGkgKyAnZGVnJywgbGVmdDogfn5keH0pLAogICAgICAgICAgICBpbnMoY3NzKHZtbCgncm91bmRyZWN0Jywge2FyY3NpemU6IG8uY29ybmVyc30pLCB7CiAgICAgICAgICAgICAgICB3aWR0aDogciwKICAgICAgICAgICAgICAgIGhlaWdodDogby53aWR0aCwKICAgICAgICAgICAgICAgIGxlZnQ6IG8ucmFkaXVzLAogICAgICAgICAgICAgICAgdG9wOiAtby53aWR0aD4+MSwKICAgICAgICAgICAgICAgIGZpbHRlcjogZmlsdGVyCiAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgdm1sKCdmaWxsJywge2NvbG9yOiBnZXRDb2xvcihvLmNvbG9yLCBpKSwgb3BhY2l0eTogby5vcGFjaXR5fSksCiAgICAgICAgICAgICAgdm1sKCdzdHJva2UnLCB7b3BhY2l0eTogMH0pIC8vIHRyYW5zcGFyZW50IHN0cm9rZSB0byBmaXggY29sb3IgYmxlZWRpbmcgdXBvbiBvcGFjaXR5IGNoYW5nZQogICAgICAgICAgICApCiAgICAgICAgICApCiAgICAgICAgKQogICAgICB9CgogICAgICBpZiAoby5zaGFkb3cpCiAgICAgICAgZm9yIChpID0gMTsgaSA8PSBvLmxpbmVzOyBpKyspCiAgICAgICAgICBzZWcoaSwgLTIsICdwcm9naWQ6RFhJbWFnZVRyYW5zZm9ybS5NaWNyb3NvZnQuQmx1cihwaXhlbHJhZGl1cz0yLG1ha2VzaGFkb3c9MSxzaGFkb3dvcGFjaXR5PS4zKScpCgogICAgICBmb3IgKGkgPSAxOyBpIDw9IG8ubGluZXM7IGkrKykgc2VnKGkpCiAgICAgIHJldHVybiBpbnMoZWwsIGcpCiAgICB9CgogICAgU3Bpbm5lci5wcm90b3R5cGUub3BhY2l0eSA9IGZ1bmN0aW9uKGVsLCBpLCB2YWwsIG8pIHsKICAgICAgdmFyIGMgPSBlbC5maXJzdENoaWxkCiAgICAgIG8gPSBvLnNoYWRvdyAmJiBvLmxpbmVzIHx8IDAKICAgICAgaWYgKGMgJiYgaStvIDwgYy5jaGlsZE5vZGVzLmxlbmd0aCkgewogICAgICAgIGMgPSBjLmNoaWxkTm9kZXNbaStvXTsgYyA9IGMgJiYgYy5maXJzdENoaWxkOyBjID0gYyAmJiBjLmZpcnN0Q2hpbGQKICAgICAgICBpZiAoYykgYy5vcGFjaXR5ID0gdmFsCiAgICAgIH0KICAgIH0KICB9CgogIHZhciBwcm9iZSA9IGNzcyhjcmVhdGVFbCgnZ3JvdXAnKSwge2JlaGF2aW9yOiAndXJsKCNkZWZhdWx0I1ZNTCknfSkKCiAgaWYgKCF2ZW5kb3IocHJvYmUsICd0cmFuc2Zvcm0nKSAmJiBwcm9iZS5hZGopIGluaXRWTUwoKQogIGVsc2UgdXNlQ3NzQW5pbWF0aW9ucyA9IHZlbmRvcihwcm9iZSwgJ2FuaW1hdGlvbicpCgogIHJldHVybiBTcGlubmVyCgp9KSk7CgovKioKICogQ29weXJpZ2h0IChjKSAyMDExLTIwMTQgRmVsaXggR25hc3MKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqLwoKLyoKCkJhc2ljIFVzYWdlOgo9PT09PT09PT09PT0KCiQoJyNlbCcpLnNwaW4oKTsgLy8gQ3JlYXRlcyBhIGRlZmF1bHQgU3Bpbm5lciB1c2luZyB0aGUgdGV4dCBjb2xvciBvZiAjZWwuCiQoJyNlbCcpLnNwaW4oeyAuLi4gfSk7IC8vIENyZWF0ZXMgYSBTcGlubmVyIHVzaW5nIHRoZSBwcm92aWRlZCBvcHRpb25zLgoKJCgnI2VsJykuc3BpbihmYWxzZSk7IC8vIFN0b3BzIGFuZCByZW1vdmVzIHRoZSBzcGlubmVyLgoKVXNpbmcgUHJlc2V0czoKPT09PT09PT09PT09PT0KCiQoJyNlbCcpLnNwaW4oJ3NtYWxsJyk7IC8vIENyZWF0ZXMgYSAnc21hbGwnIFNwaW5uZXIgdXNpbmcgdGhlIHRleHQgY29sb3Igb2YgI2VsLgokKCcjZWwnKS5zcGluKCdsYXJnZScsICcjZmZmJyk7IC8vIENyZWF0ZXMgYSAnbGFyZ2UnIHdoaXRlIFNwaW5uZXIuCgpBZGRpbmcgYSBjdXN0b20gcHJlc2V0Ogo9PT09PT09PT09PT09PT09PT09PT09PQoKJC5mbi5zcGluLnByZXNldHMuZmxvd2VyID0gewogIGxpbmVzOiA5CiAgbGVuZ3RoOiAxMAogIHdpZHRoOiAyMAogIHJhZGl1czogMAp9CgokKCcjZWwnKS5zcGluKCdmbG93ZXInLCAncmVkJyk7CgoqLwoKKGZ1bmN0aW9uKGZhY3RvcnkpIHsKCiAgaWYgKHR5cGVvZiBleHBvcnRzID09ICdvYmplY3QnKSB7CiAgICAvLyBDb21tb25KUwogICAgZmFjdG9yeShyZXF1aXJlKCdqcXVlcnknKSwgcmVxdWlyZSgnc3BpbicpKQogIH0KICBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgewogICAgLy8gQU1ELCByZWdpc3RlciBhcyBhbm9ueW1vdXMgbW9kdWxlCiAgICBkZWZpbmUoWydqcXVlcnknLCAnc3BpbiddLCBmYWN0b3J5KQogIH0KICBlbHNlIHsKICAgIC8vIEJyb3dzZXIgZ2xvYmFscwogICAgaWYgKCF3aW5kb3cuU3Bpbm5lcikgdGhyb3cgbmV3IEVycm9yKCdTcGluLmpzIG5vdCBwcmVzZW50JykKICAgIGZhY3Rvcnkod2luZG93LmpRdWVyeSwgd2luZG93LlNwaW5uZXIpCiAgfQoKfShmdW5jdGlvbigkLCBTcGlubmVyKSB7CgogICQuZm4uc3BpbiA9IGZ1bmN0aW9uKG9wdHMsIGNvbG9yKSB7CgogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKICAgICAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgICBkYXRhID0gJHRoaXMuZGF0YSgpOwoKICAgICAgaWYgKGRhdGEuc3Bpbm5lcikgewogICAgICAgIGRhdGEuc3Bpbm5lci5zdG9wKCk7CiAgICAgICAgZGVsZXRlIGRhdGEuc3Bpbm5lcjsKICAgICAgfQogICAgICBpZiAob3B0cyAhPT0gZmFsc2UpIHsKICAgICAgICBvcHRzID0gJC5leHRlbmQoCiAgICAgICAgICB7IGNvbG9yOiBjb2xvciB8fCAkdGhpcy5jc3MoJ2NvbG9yJykgfSwKICAgICAgICAgICQuZm4uc3Bpbi5wcmVzZXRzW29wdHNdIHx8IG9wdHMKICAgICAgICApCiAgICAgICAgZGF0YS5zcGlubmVyID0gbmV3IFNwaW5uZXIob3B0cykuc3Bpbih0aGlzKQogICAgICB9CiAgICB9KQogIH0KCiAgJC5mbi5zcGluLnByZXNldHMgPSB7CiAgICB0aW55OiB7IGxpbmVzOiA4LCBsZW5ndGg6IDIsIHdpZHRoOiAyLCByYWRpdXM6IDMgfSwKICAgIHNtYWxsOiB7IGxpbmVzOiA4LCBsZW5ndGg6IDQsIHdpZHRoOiAzLCByYWRpdXM6IDUgfSwKICAgIGxhcmdlOiB7IGxpbmVzOiAxMCwgbGVuZ3RoOiA4LCB3aWR0aDogNCwgcmFkaXVzOiA4IH0KICB9Cgp9KSk7CgovLyA9PT09IEFKQVhJTkFURSA9PT09IC8vCgovLyBEb2N1bWVudGF0aW9uOiBodHRwczovL2dpdGh1Yi5jb20vc3luYXB0aWNpc20vYWpheGluYXRlCgovLyBHbG9iYWwgbmFtZXNwYWNlIG9iamVjdDsgaW5zcGlyYXRpb24gZm9yIHRoZSBkZXNpZ24gb2YgdGhpcyB2aWEgUnlhbiBGbG9yZW5jZTogaHR0cDovL3J5YW5mbG9yZW5jZS5jb20vYXV0aG9yaW5nLWpxdWVyeS1wbHVnaW5zLXdpdGgtb2JqZWN0LW9yaWVudGVkLWphdmFzY3JpcHQvCnZhciBYTjggPSB7fTsKCjsoZnVuY3Rpb24oJCwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkKXsKICAndXNlIHN0cmljdCc7CgogIC8vIEluaXRpYWxpemUgSFRNTDUtSGlzdG9yeS1BUEkgcG9seWZpbGwgd2l0aCB0aGlzIHNpbmdsZSBsaW5lCiAgdmFyIGxvY2F0aW9uID0gd2luZG93Lmhpc3RvcnkubG9jYXRpb24gfHwgd2luZG93LmxvY2F0aW9uOwoKICAvLyBDaGVjayB0byBzZWUgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgdGhlIEhUTUw1IGhpc3RvcnkgQVBJOyBpZiBub3QsIGZhaWwgZWFybHkgYW5kIGxldCB0aGUgc2l0ZSBsb2FkIG5vcm1hbGx5CiAgaWYgKCAhKHdpbmRvdy5oaXN0b3J5ICYmIGhpc3RvcnkucHVzaFN0YXRlKSApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CgogIC8vIENvbnN0cnVjdG9yIGZ1bmN0aW9uCiAgdmFyIEFqYXhpbmF0ZSA9IHRoaXMuQWpheGluYXRlID0gZnVuY3Rpb24oZWxlbWVudCwgb3B0cyl7CiAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgdGhpcy5vcHRzID0gJC5leHRlbmQoe30sICQuZm4uYWpheGluYXRlLmRlZmF1bHRzLCBvcHRzKTsKICAgIHRoaXMuaW5pdCgpOwogIH07CgogIC8vIFByb3RvdHlwZSBsb2dpYwogIEFqYXhpbmF0ZS5wcm90b3R5cGUgPSB7CiAgICBpbml0OiBmdW5jdGlvbigpewoKICAgICAgLy8gRmV0Y2ggaW5pdGlhbCBjb250ZW50IGFuZCBtZW51CiAgICAgIHRoaXMuY29udGVudCA9ICQodGhpcy5vcHRzLmNvbnRlbnRTZWwpLmZpbHRlcignOmZpcnN0Jyk7CiAgICAgIHRoaXMubWVudSA9ICQodGhpcy5vcHRzLm1lbnVTZWwpLmZpbHRlcignOmZpcnN0Jyk7CgogICAgICAvLyBJbnZhbGlkIGNvbnRlbnQgc2VsZWN0b3I7IGFib3J0IG1pc3Npb24hIChXZSBjYW4gaGFuZGxlIGEgYmFkIG1lbnUgc2VsZWN0b3IsIGhvd2V2ZXIuLi4pCiAgICAgIGlmICghdGhpcy5jb250ZW50Lmxlbmd0aCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgLy8gSW5pdGlhbGl6ZSBpbnRlcm5hbCBsaW5rIHNlbGVjdG9yCiAgICAgIHRoaXMuaW50ZXJuYWxTZWwoKTsKCiAgICAgIC8vIEluaXRpYWxpemUgZXZlbnQgaGFuZGxlcnMgZm9yIHRoZSBlbGVtZW50KHMpIHNwZWNpZmllZAogICAgICB0aGlzLnByZXAodGhpcy5lbGVtZW50KTsKCiAgICAgIC8vIEluaXRpYWxpemUgcG9wc3RhdGUgZXZlbnQgaGFuZGxlcgogICAgICB0aGlzLnBvcHBlcigpOwoKICAgICAgLy8gSW5pdGlhbGl6ZSBzcGlubmVyCiAgICAgIHRoaXMuc3Bpbm5lcigpOwogICAgfSwKCgoKICAgIC8vIEludGVybmFsIGxpbmsgc2xlY3RvcgogICAgaW50ZXJuYWxTZWw6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIFJlZ2lzdGVyIHRoZSBjdXN0b20gc2VsZWN0b3IgdG8gaWRlbnRpZnkgaW50ZXJuYWwgbGlua3MKICAgICAgJC5leHByWyc6J10uaW50ZXJuYWwgPSBmdW5jdGlvbihvYmosaW5kZXgsbWV0YSxzdGFjayl7CiAgICAgICAgdmFyCiAgICAgICAgICAkdGhpcyAgID0gJChvYmopLAogICAgICAgICAgdXJsICAgICA9ICR0aGlzLmF0dHIoJ2hyZWYnKSB8fCAnJywKICAgICAgICAgIHJvb3R1cmwgPSBzZWxmLnJvb3QoKTsKCiAgICAgICAgLy8gVGhlIGxpbmsgaXMgImludGVybmFsIiBpZjogdGhlIGRvbWFpbiBtYXRjaGVzIHRoZSBjdXJyZW50IGRvbWFpbiBvciB0aGVyZSBpcyBubyBwcm90b2NvbCAoaS5lLiBpdCBpcyBhIHJlbGF0aXZlIGxpbmspCiAgICAgICAgcmV0dXJuIHVybC5zdWJzdHJpbmcoMCxyb290dXJsLmxlbmd0aCkgPT09IHJvb3R1cmwgfHwgdXJsLmluZGV4T2YoJzonKSA9PT0gLTE7CiAgICAgIH07CiAgICB9LCAvLyBlbmQgaW50ZXJuYWxTZWwoKQoKCgogICAgLy8gUHJpbWFyeSBldmVudCBiaW5kaW5nIGZ1bmN0aW9uCiAgICBwcmVwOiBmdW5jdGlvbihlbGVtZW50KXsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgLy8gU2VsZWN0IGFsbCBhbmNob3IgdGFncyB3aXRoaW4gdGhlIHRhcmdldCBlbGVtZW50OyB1c2VzIG5hdGl2ZSBKYXZhU2NyaXB0IG1ldGhvZHMgKGZhc3QpCiAgICAgICQoZWxlbWVudCkuZmluZCgnYScpCgogICAgICAvLyBOb3cgZmlsdGVyIHRoZSByZXN1bHRzIHRvIGZpbmQgY2VydGFpbiBpbnRlcm5hbCBsaW5rczsgdXNlcyBjb21wbGV4IGpRdWVyeSBzZWxlY3RvcnMgKHNsb3cpCiAgICAgIC5maWx0ZXIoJzppbnRlcm5hbCcgKyBzZWxmLm9wdHMuZmlsdGVycykKCiAgICAgIC8vIE1hbmFnZSBjbGljayBldmVudAogICAgICAub24oJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpewogICAgICAgIHZhcgogICAgICAgICAgJHRoaXMgPSAkKHRoaXMpLAogICAgICAgICAgdXJsICAgPSAkdGhpcy5hdHRyKCdocmVmJyksCiAgICAgICAgICB0aXRsZSA9ICR0aGlzLmF0dHIoJ3RpdGxlJykgfHwgbnVsbDsgLy8gTm90IGh1Z2VseSBpbXBvcnRhbnQgYnV0IHdlJ2xsIHVzZSBhIHRpdGxlIGF0dHJpYnV0ZSBpZiBvbmUgaGFwcGVucyB0byBiZSBwcmVzZW50CgogICAgICAgIC8vIFJldHVybiBmYWxzZSAoYW5kIHByZXZlbnQgYWxsIGFjdGlvbnMpIHVuZGVyIHRoZXNlIGNpcmN1bXN0YW5jZXM6CiAgICAgICAgLy8gLSBVUkwgaXMgdGhlIHNhbWUgYXMgdGhlIGN1cnJlbnQgbG9jYXRpb24gKG5vIHNlbnNlIGluIHJlbG9hZGluZyBhbnl0aGluZykKICAgICAgICAvLyAtIFVSTCBpcyBqdXN0IGEgaGFzaCAoZGl0dG8pCiAgICAgICAgaWYgKCB1cmwgPT09IGxvY2F0aW9uLmhyZWYgfHwgdXJsID09PSAnIycgKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICAvLyBSZXR1cm4gdHJ1ZSAoYW5kIGFsbG93IG5vcm1hbCBicm93c2VyIGJlaGF2aW9yKSB1bmRlciB0aGVzZSBjaXJjdW1zdGFuY2VzOgogICAgICAgIC8vIC0gTWlkZGxlIG1vdXNlIGJ1dHRvbiBjbGlja3MgKGV2ZW50LndoaWNoID09PSAyKTsgcmVmZXJlbmNlOiBodHRwczovL2FwaS5qcXVlcnkuY29tL2V2ZW50LndoaWNoLwogICAgICAgIC8vIC0gQ29tbWFuZCBhbmQgY29udHJvbCBrZXkgY2xpY2tzIGUuZy4gdG8gb3BlbiBpbiBhIG5ldyB0YWI7IHJlZmVyZW5jZTogaHR0cHM6Ly9naXRodWIuY29tL2Jyb3dzZXJzdGF0ZS9hamF4aWZ5L3B1bGwvMTUvZmlsZXMKICAgICAgICAvLyAtIFNlZSBhbHNvOiBldmVudC5hbHRLZXksIGV2ZW50LnNoaWZ0S2V5IChub3QgaW1wbGVtZW50ZWQpCiAgICAgICAgLy8gLSBVUkwgbm90IHNldCAoc2hvdWxkbid0IGhhcHBlbikgb3IgVVJMIGJlZ2lucyB3aXRoIGEgaGFzaCAoaW4gZG9jdW1lbnQgbGluaykKICAgICAgICAvLyAtIFVSTCBtYXRjaGVzIHRoZSBleGNlcHRpb25zIGRlZmluZWQgaW4gdGhlIG9wdGlvbnMgKGRlZmF1bHRzOiBjZXJ0YWluIGZpbGUgZXh0ZW5zaW9ucyBlLmcuIGltYWdlcywgYXVkaW8gZmlsZXMsIGV0Yy4pCiAgICAgICAgaWYgKAogICAgICAgICAgZXZlbnQud2hpY2ggPT09IDIgfHwKICAgICAgICAgIGV2ZW50Lm1ldGFLZXkgICAgIHx8CiAgICAgICAgICBldmVudC5jdHJsS2V5ICAgICB8fAogICAgICAgICAgIXVybCAgICAgICAgICAgICAgfHwKICAgICAgICAgIHVybFswXSA9PT0gJyMnICAgIHx8CiAgICAgICAgICB1cmwubWF0Y2goc2VsZi5vcHRzLmV4Y2VwdGlvbnMpCiAgICAgICAgKSB7CiAgICAgICAgICAvLyBAVE9ETzogLnRyaWdnZXIoJ2ludGVybmFsRXhjZXB0aW9uJykgY3VzdG9tIGV2ZW50PwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBEb24ndCBtYWtlIGEgcGFnZSByZXF1ZXN0IGlmIHdlJ3ZlIGNvbWUgdGhpcyBmYXIKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAvLyBQdXNoIGFuZCBsb2FkCiAgICAgICAgc2VsZi5wdXNoZXIodGl0bGUsdXJsKTsKICAgICAgfSk7CiAgICB9LCAvLyBlbmQgcHJlcCgpCgoKCiAgICAvLyBQdXNoIHN0YXRlIGhhbmRsZXI7IGlzb2xhdGVkIGhlcmUgZm9yIGdyZWF0ZXIgbW9kdWxhcml0eTsgeW91IGNhbiBjYWxsIHRoaXMgZnJvbSBwbHVnaW5zIG1vcmUgZWFzaWx5CiAgICBwdXNoZXI6IGZ1bmN0aW9uKHRpdGxlLHVybCl7CgogICAgICAvLyBJbml0aWF0ZSBhIHN0YXRlIG9iamVjdCBmb3IgdGhpcyBwdXNoOyBAVE9ETzogZmxlc2ggdGhpcyBvdXQgYSBiaXQsIGl0J3Mgbm90IGh1Z2VseSB1c2VmdWwgaW4gaXRzIHByZXNlbnQgc3RhdGUKICAgICAgdmFyIHN0YXRlID0gewogICAgICAgIHRpdGxlOiB0aXRsZSwKICAgICAgICB1cmw6IHVybAogICAgICB9OwoKICAgICAgLy8gUHVzaCBzdGF0ZQogICAgICBoaXN0b3J5LnB1c2hTdGF0ZShzdGF0ZSx0aXRsZSx1cmwpOwoKICAgICAgLy8gTG9hZCBuZXcgY29udGVudCB2aWEgQUpBWAogICAgICB0aGlzLmxvYWQodXJsKTsKICAgIH0sIC8vIGVuZCBwdXNoZXIoKQoKCgogICAgLy8gVGhlIHBvcHN0YXRlIGV2ZW50IGZpcmVzIHdoZW4gdGhlIHVzZXIgbmF2aWdhdGVzIGJhY2t3YXJkIG9yIGZvcndhcmQgaW4gdGhlIGJyb3dzZXIKICAgIHBvcHBlcjogZnVuY3Rpb24oKXsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwoKICAgICAgJCh3aW5kb3cpLm9uKCdwb3BzdGF0ZScsIGZ1bmN0aW9uKGV2ZW50KXsKCiAgICAgICAgLy8gQFRPRE86IGNoZWNrIHByZXZpb3VzIHN0YXRlIG9iamVjdCB0byBzZWUgd2hldGhlciBtb3JlIHRoYW4ganVzdCB0aGUgaGFzaCBoYXMgY2hhbmdlZAogICAgICAgIC8vIEdldCB5b3VyIGhhc2g6IGh0dHA6Ly9sZWEudmVyb3UubWUvMjAxMS8wNS9nZXQteW91ci1oYXNoLXRoZS1idWxsZXRwcm9vZi13YXkvCiAgICAgICAgaWYgKGxvY2F0aW9uLmhhc2guc3Vic3RyaW5nKDEpID09PSAnJykgewogICAgICAgICAgc2VsZi5sb2FkKGxvY2F0aW9uLmhyZWYpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LCAvLyBlbmQgcG9wcGVyKCkKCgoKICAgIC8vIENvbmRpdGlvbmFsbHkgaW5pdGlhbGl6ZSBzcGlubmVyIGRpdjsgZGVncmFkZXMgZ3JhY2VmdWxseSBpZiBzcGluLmpzIG5vdCBmb3VuZAogICAgc3Bpbm5lcjogZnVuY3Rpb24oKXsKICAgICAgaWYgKCAkLmlzRnVuY3Rpb24od2luZG93LlNwaW5uZXIpICkgewogICAgICAgIHRoaXMuY29udGVudC5iZWZvcmUoJzxkaXYgaWQ9InNwaW5uZXIiIHN0eWxlPSJwb3NpdGlvbjogZml4ZWQ7IGhlaWdodDogMTAwJTsgd2lkdGg6IDEwMCU7Ij48L2Rpdj4nKTsKICAgICAgICAkKCcjc3Bpbm5lcicpLnNwaW4odGhpcy5vcHRzLnNwaW5PcHRzKS5oaWRlKCk7CiAgICAgIH0KICAgIH0sIC8vIGVuZCBzcGlubmVyKCkKCgoKICAgIC8vIFRoaXMgZnVuY3Rpb24gZHluYW1pY2FsbHkgbG9hZHMgY29udGVudCBmcm9tIHRoZSByZXF1ZXN0ZWQgcGFnZQogICAgbG9hZDogZnVuY3Rpb24odXJsKXsKICAgICAgdmFyCiAgICAgICAgc2VsZiAgICAgICA9IHRoaXMsCiAgICAgICAgJGJvZHkgICAgICA9ICQoZG9jdW1lbnQuYm9keSksCiAgICAgICAgJHNwaW5uZXIgICA9ICQoJyNzcGlubmVyJyksCiAgICAgICAgY29udGVudFNlbCA9IHRoaXMub3B0cy5jb250ZW50U2VsLAogICAgICAgIG1lbnVTZWwgICAgPSB0aGlzLm9wdHMubWVudVNlbDsKCiAgICAgIC8vIERpbSBleGlzdGluZyBjb250ZW50OyB1c2UgYW5pbWF0ZSB0byBwcmVzZXJ2ZSB0aGUgZWxlbWVudCdzIGhlaWdodCAoYXZvaWRzIHNjcm9sbGJhciBmbGlja2VyKQogICAgICB0aGlzLmNvbnRlbnQuYW5pbWF0ZSh7IG9wYWNpdHk6IHRoaXMub3B0cy5vdXRPcGFjaXR5IH0sIHRoaXMub3B0cy5vdXREZWxheSk7CgogICAgICAvLyBTcGluIHNwaW4gc3VnYXI7IG5vIGRlbGF5IG5lZWRlZCBoZXJlCiAgICAgICRzcGlubmVyLnNob3coKTsKCiAgICAgIC8vIEFKQVggcGFnZSByZXF1ZXN0OyBmZXRjaCB0aGUgY29udGVudCB3ZSBuZWVkCiAgICAgICQuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSx0ZXh0U3RhdHVzLGpxWEhSKXsKCiAgICAgICAgICAvLyBRdWlja2x5IGZhZGUgY29udGVudCBvdXQgZW50aXJlbHkKICAgICAgICAgIHNlbGYuY29udGVudC5hbmltYXRlKHsgb3BhY2l0eTogMCB9LCAyMCk7CgogICAgICAgICAgdmFyCiAgICAgICAgICAgICRkYXRhICAgICAgICAgPSAkKHNlbGYuZG9jSGVscChkYXRhKSksCiAgICAgICAgICAgICRkb2NCb2R5ICAgICAgPSAkZGF0YS5maW5kKCcjZG9jLWJvZHk6Zmlyc3QnKSwKICAgICAgICAgICAgJGNvbnRlbnQgICAgICA9ICRkb2NCb2R5LmZpbmQoY29udGVudFNlbCkuZmlsdGVyKCc6Zmlyc3QnKSwKICAgICAgICAgICAgJG1lbnUgICAgICAgICA9ICRkb2NCb2R5LmZpbmQobWVudVNlbCkuZmlsdGVyKCc6Zmlyc3QnKTsKCiAgICAgICAgICAvLyBJZiBubyBjb250ZW50IGlzIHJlY2VpdmVkIGZvciBhbnkgcmVhc29uIGp1c3QgZm9yd2FyZCB0aGUgdXNlciBvbiB0byB0aGUgdGFyZ2V0IFVSTAogICAgICAgICAgaWYgKCEkY29udGVudC5sZW5ndGgpIHsKICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN0b3AgYW5pbWF0aW9uIGltbWVkaWF0ZWx5CiAgICAgICAgICBzZWxmLmNvbnRlbnQuc3RvcCh0cnVlLHRydWUpOwoKICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY29udGVudCBhbmQgcHJlcCBldmVudCBoYW5kbGVycwogICAgICAgICAgc2VsZi5wcmVwKCBzZWxmLmNvbnRlbnQuaHRtbCggJGNvbnRlbnQuaHRtbCgpICkgKTsKCiAgICAgICAgICAvLyBTd2FwIHRoZSBtZW51KHMpIGFuZCBwcmVwIGV2ZW50IGhhbmRsZXJzIGlmIGEgbWVudSBpcyBmb3VuZAogICAgICAgICAgaWYgKCRtZW51Lmxlbmd0aCkgewogICAgICAgICAgICBzZWxmLnByZXAoIHNlbGYubWVudS5odG1sKCAkbWVudS5odG1sKCkgKSApOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEhhcm1vbml6ZSBib2R5IGNsYXNzZXM7IG1ha2VzIFdvcmRQcmVzcyBwYWdlcyByZW5kZXIgc21vb3RobHkgYnV0IGFsc28gZ2VuZXJhbGx5IHVzZWZ1bAogICAgICAgICAgJGJvZHkuYXR0cignY2xhc3MnLCAkZG9jQm9keS5hdHRyKCdjbGFzcycpKTsKCiAgICAgICAgICAvLyBGYWRlIHRoZSBjb250ZW50IGJhY2sgaW4KICAgICAgICAgIHNlbGYuY29udGVudC5hbmltYXRlKHsgb3BhY2l0eTogMSB9LCBzZWxmLm9wdHMuaW5EZWxheSk7CgogICAgICAgICAgLy8gVXBkYXRlIGJvZHkgc2NyaXB0cyBvdXRzaWRlIG9mIHRoZSBjb250ZW50IGFyZWEKICAgICAgICAgIHNlbGYuc2NyaXB0cyggJGRvY0JvZHkuZmluZCgnc2NyaXB0Jykubm90KGNvbnRlbnRTZWwrJzpmaXJzdCBzY3JpcHQnKSApOwoKICAgICAgICAgIC8vIFVwZGF0ZSBkb2N1bWVudCB0aXRsZQogICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBzZWxmLnNhbml0aXplKCAkZGF0YS5maW5kKCcjZG9jLXRpdGxlOmZpcnN0JykudGV4dCgpICk7CiAgICAgICAgfSwKCiAgICAgICAgLy8gRXJyb3IgaGFuZGxpbmc7IGZhbGwgYmFjayBvbiByZWd1bGFyIHBhZ2UgbG9hZCBpZiBhbnl0aGluZyBnb2VzIHdyb25nCiAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKGpxWEhSLHRleHRTdGF0dXMsZXJyb3JUaHJvd24pewogICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24uaHJlZiA9IHVybDsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LCAvLyBlbmQgZXJyb3IgaGFuZGxpbmcKCiAgICAgICAgLy8gQ2xlYW4gdXAgYWZ0ZXIgY29tcGxldGluZyB0aGUgQUpBWCBjYWxsCiAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uKGpxWEhSLHRleHRTdGF0dXMpewoKICAgICAgICAgIC8vIEZhZGUgb3V0IHNwaW5uZXIKICAgICAgICAgICRzcGlubmVyLmZhZGVPdXQoc2VsZi5vcHRzLnNwaW5GYWRlLCBmdW5jdGlvbigpeyAkKHRoaXMpLmhpZGUoKTsgfSk7CgogICAgICAgICAgLy8gU2Nyb2xsIHRvIHRoZSBhcHByb3ByaWF0ZSBsb2NhdGlvbgogICAgICAgICAgc2VsZi5zY3JvbGwoKTsKCiAgICAgICAgICAvLyBVcGRhdGUgYW5hbHl0aWNzCiAgICAgICAgICBzZWxmLmFuYWx5dGljcyh1cmwpOwoKICAgICAgICB9IC8vIGVuZCBjb21wbGV0ZQoKICAgICAgfSk7IC8vIGVuZCAkLmFqYXgKCiAgICB9LCAvLyBlbmQgbG9hZCgpCgoKCiAgICAvLyBVcGRhdGUgc2NyaXB0cwogICAgc2NyaXB0czogZnVuY3Rpb24oJHNjcmlwdHMpewogICAgICB2YXIKICAgICAgICAkYm9keSAgICAgICA9ICQoJ2JvZHknKSwKICAgICAgICBjb250ZW50U2NyICA9IHRoaXMub3B0cy5jb250ZW50U2VsICsgJzpmaXJzdCBzY3JpcHQnOyAvLyBTZWxlY3RzIGNvbnRlbnQgc2NyaXB0cwoKICAgICAgLy8gRmV0Y2ggYm9keSBzY3JpcHRzIG5vdCBpbiB0aGUgY29udGVudCAod2hpY2ggd2lsbCBiZSByZXBsYWNlZCBhbnlob3cpCiAgICAgIGlmICggJHNjcmlwdHMubGVuZ3RoICkgewogICAgICAgICRzY3JpcHRzLmRldGFjaCgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsgLy8gRWFybHkgZXhpdDsgdGhlcmUgYXJlIG5vIHNjcmlwdHMgdG8gd29yayB3aXRoCiAgICAgIH0KCiAgICAgIC8vIFVwZGF0ZSB0aGUgYm9keSBzY3JpcHRzIG91dHNpZGUgb2YgdGhlIGNvbnRlbnQgYXJlYTsgd2UncmUgYXNzdW1pbmcgdGhhdCBoZWFkZXIgc2NyaXB0cyBkb24ndCBjaGFuZ2UKICAgICAgJHNjcmlwdHMuZWFjaChmdW5jdGlvbigpewogICAgICAgIHZhciAkdGhpcyA9ICQodGhpcyk7CgogICAgICAgIC8vIElmIHRoZSBjdXJyZW50IHNjcmlwdCBpc24ndCBlbXB0eSB3ZSBhc3N1bWUgaXQgbXVzdCBiZSBpbmxpbmUKICAgICAgICBpZiAoICR0aGlzLmh0bWwoKSAhPT0gJycgKSB7CgogICAgICAgICAgLy8gU2F2ZSB0aGUgY3VycmVjdCBzY3JpcHQgY29udGVudHMgZm9yIHVzZSBpbiB0aGUgbG9vcCB0byBmb2xsb3cKICAgICAgICAgIHZhcgogICAgICAgICAgICBpbmxpbmVTY3JpcHQgPSAkdGhpcy5odG1sKCksCiAgICAgICAgICAgIGlzTmV3ICAgICAgICA9IHRydWU7CgogICAgICAgICAgLy8gQ2hlY2sgZXhpc3Rpbmcgc2NyaXB0cyB0byBzZWUgaWYgdGhleSBjb250YWluIHRoZSBzYW1lIHN0dWZmCiAgICAgICAgICAkLmVhY2goICRib2R5LmZpbmQoJ3NjcmlwdDpub3QoOmVtcHR5KScpLm5vdChjb250ZW50U2NyKSwgZnVuY3Rpb24oKXsKICAgICAgICAgICAgaWYgKCAkdGhpcy5odG1sKCkgPT09IGlubGluZVNjcmlwdCApIHsKICAgICAgICAgICAgICBpc05ldyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBQYXN0ZSBuZXcgc3R1ZmYgaW4gaWYgaXQgaXNuJ3QgZm91bmQgaW4gdGhlIGN1cnJlbnQgRE9NOyB0aGlzIGlzIHF1aXRlIGEga2x1ZGdlCiAgICAgICAgICBpZiAoIGlzTmV3ID09PSB0cnVlICkgewogICAgICAgICAgICAkYm9keS5maW5kKCdzY3JpcHQ6bm90KDplbXB0eSknKS5ub3QoY29udGVudFNjcikuZmlsdGVyKCc6Zmlyc3QnKS5iZWZvcmUoJzxzY3JpcHQ+JyArICR0aGlzLmh0bWwoKSArICc8L3NjcmlwdD4nKTsKICAgICAgICAgIH0KCiAgICAgICAgLy8gRmV0Y2ggbmV3IG5vbi1pbmxpbmUgc2NyaXB0cwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgLy8gVGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIGVhY2ggc2NyaXB0OyBubyBzZW5zZSBpbiByZXBlYXRpbmcgb3Vyc2VsdmVzIGhlcmUKICAgICAgICAgIGlmICggISRib2R5LmZpbmQoJ3NjcmlwdFtzcmMqPSInICsgJHRoaXMuYXR0cignc3JjJykgKyAnIl0nKS5sZW5ndGggKSB7CiAgICAgICAgICAgIC8vICQuZ2V0U2NyaXB0IGRvZXMgbm90IGNhY2hlIHNjcmlwdHMgYnkgZGVmYXVsdCBzbyB3ZSdsbCBza2lwIHRoZSBzaG9ydGN1dCBhbmQgZ28gc3RyYWlnaHQgdG8gdGhlIHNvdXJjZQogICAgICAgICAgICAkLmFqYXgoewogICAgICAgICAgICAgIHVybDogJHRoaXMuYXR0cignc3JjJyksCiAgICAgICAgICAgICAgZGF0YVR5cGU6ICJzY3JpcHQiLAogICAgICAgICAgICAgIGNhY2hlOiB0cnVlLAogICAgICAgICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbigpeyAvLyBJbiBjYXNlIGNhY2hpbmcgaXNuJ3Qgd29ya2luZy4uLiBhZGQgdGhlIHNjcmlwdCB0byB0aGUgRE9NCiAgICAgICAgICAgICAgICB2YXIgbmV3U2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgICAgICAgICBuZXdTY3JpcHQuc3JjID0gJHRoaXMuYXR0cignc3JjJyk7IC8vIE5vIG5lZWQgZm9yIHR5cGU9InRleHQvamF2YXNjcmlwdCIgaW4gSFRNTDUKICAgICAgICAgICAgICAgICRib2R5WzBdLmFwcGVuZENoaWxkKG5ld1NjcmlwdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsgLy8gZW5kICQuYWpheCgpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsgLy8gZW5kICRzY3JpcHRzLmVhY2goKQogICAgfSwgLy8gZW5kIHNjcmlwdHMoKQoKCgogICAgLy8gRXNjYXBlIEhUTUwgZW50aXRpZXMgaW4gYSBzdHJpbmcKICAgIHNhbml0aXplOiBmdW5jdGlvbihzdHIpewogICAgICByZXR1cm4gU3RyaW5nKHN0cikucmVwbGFjZSgvWyY8PiInXC8hPV0vZywgZnVuY3Rpb24ocyl7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICImIjogIiZhbXA7IiwKICAgICAgICAgICI8IjogIiZsdDsiLAogICAgICAgICAgIj4iOiAiJmd0OyIsCiAgICAgICAgICAnIic6ICImcXVvdDsiLAogICAgICAgICAgIiciOiAiJmFwb3M7IiwKICAgICAgICAgICIvIjogIiYjMDQ3OyIsCiAgICAgICAgICAiISI6ICImIzAzMzsiLAogICAgICAgICAgIj0iOiAiJiMwNjE7IgogICAgICAgIH1bc107CiAgICAgIH0pOwogICAgfSwgLy8gZW5kIHNhbml0aXplKCkKCgoKICAgIC8vIFVwZGF0ZSBzY3JvbGwgcG9zaXRpb24KICAgIHNjcm9sbDogZnVuY3Rpb24oKXsKICAgICAgdmFyCiAgICAgICAgJGJvZHkgICAgICAgPSAkKCdib2R5JyksCiAgICAgICAgaGFzaCAgICAgICAgPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSwKICAgICAgICBzY3JvbGxEZWxheSA9IHRoaXMub3B0cy5zY3JvbGxEZWxheSwKICAgICAgICB0b3AgICAgICAgICA9ICQodGhpcy5vcHRzLmNvbnRlbnRTZWwpLmZpbHRlcignOmZpcnN0Jykub2Zmc2V0KCkudG9wOwoKICAgICAgLy8gVGVzdCBmb3IgdGhlIHByZXNlbmNlIG9mIGEgaGFzaCBpbiB0aGUgbG9jYXRpb24KICAgICAgaWYgKGhhc2ggIT09ICcnKSB7CgogICAgICAgIC8vIERlZmluZSB0aGUgc2VsZWN0b3IKICAgICAgICB2YXIgJGhhc2ggPSAkKCdbaWQ9IicraGFzaCsnIl0nKTsKCiAgICAgICAgLy8gVGVzdCB3aGV0aGVyIHRoZSBzZWxlY3RvciBleGlzdHM7IHNjcm9sbCB0aGVyZSBpZiBmb3VuZCBhbmQgZmFsbCBiYWNrIG9uIHJlZ3VsYXIgc2Nyb2xsIHJvdXRpbmUgaWYgbm90CiAgICAgICAgaWYgKCAkaGFzaC5sZW5ndGggKSB7CiAgICAgICAgICAkYm9keS5hbmltYXRlKHsgc2Nyb2xsVG9wOiAkaGFzaC5vZmZzZXQoKS50b3AgfSwgc2Nyb2xsRGVsYXksICJzd2luZyIpOwogICAgICAgICAgcmV0dXJuOyAvLyBFYXJseSBleGl0IGZyb20gZnVuY3Rpb247IHdlJ3ZlIGdvdCBzb21ldGhpbmcgdG8gc2Nyb2xsIHRvIGFuZCBpdCdzIGdvaW5nIHRvIGJlIGJlbG93IHRoZSBmb2xkCiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTY3JvbGwgdG8gdGhlIHRvcCBvZiB0aGUgY29udGVudCBjb250YWluZXIgd2hlbiBiZWxvdyB0aGUgZm9sZAogICAgICBpZiAoICQod2luZG93KS5zY3JvbGxUb3AoKSA+IHRvcCApIHsKICAgICAgICAkYm9keS5hbmltYXRlKHsgc2Nyb2xsVG9wOiB0b3AgfSwgc2Nyb2xsRGVsYXksICJzd2luZyIpOwogICAgICB9CgogICAgfSwgLy8gZW5kIHNjcm9sbCgpCgoKCiAgICAvLyBVcGRhdGUgR29vZ2xlIEFuYWx5dGljcyBvbiBjb250ZW50IGxvYWQKICAgIGFuYWx5dGljczogZnVuY3Rpb24odXJsKXsKICAgICAgdmFyIHJlbGF0aXZlVXJsID0gJy8nICsgdXJsLnJlcGxhY2UodGhpcy5yb290KCksICcnKTsgLy8gU2V0IHRoZSByZWxhdGl2ZSBVUkwgcmVxdWlyZWQgYnkgR29vZ2xlIEFuYWx5dGljcwoKICAgICAgLy8gSW5mb3JtIEdvb2dsZSBBbmFseXRpY3Mgb2YgdGhlIGNoYW5nZTsgY29tcGF0aWJsZSB3aXRoIHRoZSBuZXcgVW5pdmVyc2FsIEFuYWx5dGljcyBzY3JpcHQKICAgICAgaWYgKCB0eXBlb2Ygd2luZG93LmdhICE9PSAndW5kZWZpbmVkJyApIHsKICAgICAgICB3aW5kb3cuZ2EoJ3NlbmQnLCAncGFnZXZpZXcnLCByZWxhdGl2ZVVybCk7CiAgICAgIH0gZWxzZSBpZiAoIHR5cGVvZiB3aW5kb3cuX2dhcSAhPT0gJ3VuZGVmaW5lZCcgKSB7CiAgICAgICAgd2luZG93Ll9nYXEucHVzaChbJ190cmFja1BhZ2V2aWV3JywgcmVsYXRpdmVVcmxdKTsgLy8gTGVnYWN5IGFuYWx5dGljczsgcmVmOiBodHRwczovL2dpdGh1Yi5jb20vYnJvd3NlcnN0YXRlL2FqYXhpZnkvcHVsbC8yNQogICAgICB9CiAgICB9LCAvLyBlbmQgYW5hbHl0aWNzKCkKCgoKICAgIC8vIERvY3VtZW50IGhlbHBlcjsgYnJvd3NlcnMgb2Z0ZW4gc3RyaXAgb3V0IGh0bWwsIGhlYWQsIGJvZHksIHRpdGxlLCBiYXNlLCBhbmQgbWV0YSB0YWdzIHdoZW4gdXNpbmcgLmlubmVySFRNTDsgc2VlIGh0dHBzOi8vYXBpLmpxdWVyeS5jb20vbG9hZC8KICAgIC8vIFRoaXMgZnVuY3Rpb24gYWxsb3dzIGFjY2VzcyB0byB0aGVzZSB0YWdzIGJ5IHRyYW5zZm9ybWluZyB0aGVtIHRvIGRpdnMgd2l0aCBpZHMgdGhhdCBtYXRjaCB0aGUgb3JpZ2luYWwgZS5nLiAjZG9jLXRpdGxlCiAgICAvLyBTZWUgYWxzbzogaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vY293Ym95Lzc0Mjk1Mi8KICAgIGRvY0hlbHA6IGZ1bmN0aW9uKGh0bWwpewogICAgICB2YXIKICAgICAgICByZXN1bHQgPSBTdHJpbmcoaHRtbCkKICAgICAgICAgIC5yZXBsYWNlKC88XCFET0NUWVBFW14+XSo+L2ksICcnKQogICAgICAgICAgLnJlcGxhY2UoLzwoaHRtbHxoZWFkfGJvZHl8dGl0bGV8YmFzZXxtZXRhKShbXHNcPl0pL2dpLCc8ZGl2IGlkPSJkb2MtJDEiJDInKQogICAgICAgICAgLnJlcGxhY2UoLzxcLyhodG1sfGhlYWR8Ym9keXx0aXRsZXxiYXNlfG1ldGEpXD4vZ2ksJzwvZGl2PicpCiAgICAgIDsKICAgICAgcmV0dXJuICQudHJpbShyZXN1bHQpOwogICAgfSwgLy8gZW5kIGRvY0hlbHAoKQoKCgogICAgLy8gVXRpbGl0eSBmdW5jdGlvbiB0byBnZXQgdGhlIHJvb3QgVVJMIHdpdGggdHJhaWxpbmcgc2xhc2ggZS5nLiBodHRwKHMpOi8veW91cmRvbWFpbi5jb20vCiAgICByb290OiBmdW5jdGlvbigpewogICAgICB2YXIKICAgICAgICBwb3J0ID0gZG9jdW1lbnQubG9jYXRpb24ucG9ydCA/ICc6JyArIGRvY3VtZW50LmxvY2F0aW9uLnBvcnQgOiAnJywKICAgICAgICB1cmwgPSBkb2N1bWVudC5sb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyAoZG9jdW1lbnQubG9jYXRpb24uaG9zdG5hbWUgfHwgZG9jdW1lbnQubG9jYXRpb24uaG9zdCkgKyBwb3J0ICsgJy8nOwogICAgICByZXR1cm4gdXJsOwogICAgfSAvLyBlbmQgcm9vdCgpCgogIH07IC8vIGVuZCBBamF4aW5hdGUucHJvdG90eXBlCgoKCiAgLy8gQSBsaWdodHdlaWdodCBwbHVnaW4gd3JhcHBlciBhcm91bmQgdGhlIGNvbnN0cnVjdG9yIHByZXZlbnRpbmcgbXVsdGlwbGUgaW5zdGFudGlhdGlvbnMKICAkLmZuLmFqYXhpbmF0ZSA9IGZ1bmN0aW9uIChvcHRzKXsKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgaWYgKCEkLmRhdGEodGhpcywgJ1hOOF9hamF4aW5hdGUnKSkgewogICAgICAgICQuZGF0YSh0aGlzLCAnWE44X2FqYXhpbmF0ZScsIG5ldyBBamF4aW5hdGUodGhpcywgb3B0cykpOwogICAgICB9CiAgICB9KTsKICB9OwoKCgogIC8vIEV4dGVuc2libGUgZGVmYXVsdCBzZXR0aW5ncwogICQuZm4uYWpheGluYXRlLmRlZmF1bHRzID0gewogICAgY29udGVudFNlbDogICAgJyNjb250ZW50JyAvLyBUaGUgc2VsZWN0b3IgZm9yIGFsbCBwYWdlIGNvbnRlbnRzCiAgLCBtZW51U2VsOiAgICAgICAnI21lbnUnICAgIC8vIFRoZSBzZWxlY3RvciBmb3IgdGhlIGVudGlyZSBtZW51CiAgLCBvdXREZWxheTogICAgICA2MDAKICAsIG91dE9wYWNpdHk6ICAgIDAuMiAgICAgICAgLy8gRGltbWluZyByYXRoZXIgdGhhbiBjb21wbGV0ZWx5IGhpZGluZyBjb250ZW50CiAgLCBpbkRlbGF5OiAgICAgICAxMjAKICAsIHNjcm9sbERlbGF5OiAgIDMwMAogICwgc3BpbkZhZGU6ICAgICAgMzAwICAgICAgICAvLyBTcGlubmVyIGZhZGUgb3V0IGR1cmF0aW9uCiAgLCBzcGluT3B0czogeyAgICAgICAgICAgICAgIC8vIHNwaW4uanMgb3B0aW9uczsgcmVmZXJlbmNlOiBodHRwczovL2ZnbmFzcy5naXRodWIuaW8vc3Bpbi5qcy8KICAgICAgbGluZXM6ICAyNQogICAgLCBsZW5ndGg6IDAKICAgICwgd2lkdGg6ICA0CiAgICAsIHJhZGl1czogMjUKICAgICwgc3BlZWQ6ICAxLjUKICAgICwgdHJhaWw6ICA0MAogICAgLCB0b3A6ICAgICcyNSUnCiAgfQoKICAvLyBXaGl0ZWxpc3RlZCBleHRlbnNpb25zIChyZWdleHApOyB0aGVzZSB3aWxsIG5lZ2F0ZSB0aGUgY3VzdG9tICJpbnRlcm5hbCIgc2VsZWN0b3IKICAsIGV4Y2VwdGlvbnM6IC9cLihqcGd8anBlZ3xwbmd8Z2lmfGJtcHxwZGZ8bXAzfGZsYWN8d2F2fHJhcnx6aXApJC9pCgogIC8vIEFkZGl0aW9uYWwgc2VsZWN0b3JzIHRvIGZpbHRlciB3aGVuIGJpbmRpbmcgZXZlbnRzIChzdHJpbmcpOyB1c2UgIjpub3Qoc2VsZWN0b3IpIiwgZm9yIGV4YW1wbGUsIHRvIHNraXAgY2VydGFpbiBzZWxlY3RvcnMgZS5nLiBgOm5vdChbaHJlZio9InRlc3QiXSlgIGV0Yy4KICAsIGZpbHRlcnM6ICcnCiAgfTsKCn0pLmFwcGx5KFhOOCwgW2pRdWVyeSwgd2luZG93LCBkb2N1bWVudF0pOwo=",
                "body": "LyohCiAqIEhpc3RvcnkgQVBJIEphdmFTY3JpcHQgTGlicmFyeSB2NC4xLjAKICoKICogU3VwcG9ydDogSUU4KywgRkYzKywgT3BlcmEgOSssIFNhZmFyaSwgQ2hyb21lIGFuZCBvdGhlcgogKgogKiBDb3B5cmlnaHQgMjAxMS0yMDEzLCBEbWl0cmlpIFBha2h0aW5vdiAoIHNwYi5waWtzZWxAZ21haWwuY29tICkKICoKICogaHR0cDovL3NwYi1waWtzZWwucnUvCiAqCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBhbmQgR1BMIGxpY2Vuc2VzOgogKiAgIGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwCiAqICAgaHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzL2dwbC5odG1sCiAqCiAqIFVwZGF0ZTogMjAxNC0wMy0yNCAxMzoxNAogKi8KKGZ1bmN0aW9uKHdpbmRvdykgewogICAgLy8gUHJldmVudCB0aGUgY29kZSBmcm9tIHJ1bm5pbmcgaWYgdGhlcmUgaXMgbm8gd2luZG93Lmhpc3Rvcnkgb2JqZWN0CiAgICBpZiAoIXdpbmRvdy5oaXN0b3J5KSByZXR1cm47CiAgICAvLyBzeW1saW5rIHRvIGRvY3VtZW50CiAgICB2YXIgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQ7CiAgICAvLyBIVE1MIGVsZW1lbnQKICAgIHZhciBkb2N1bWVudEVsZW1lbnQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CiAgICAvLyBzeW1saW5rIHRvIGNvbnN0cnVjdG9yIG9mIE9iamVjdAogICAgdmFyIE9iamVjdCA9IHdpbmRvd1snT2JqZWN0J107CiAgICAvLyBzeW1saW5rIHRvIEpTT04gT2JqZWN0CiAgICB2YXIgSlNPTiA9IHdpbmRvd1snSlNPTiddOwogICAgLy8gc3ltbGluayB0byBpbnN0YW5jZSBvYmplY3Qgb2YgJ0xvY2F0aW9uJwogICAgdmFyIHdpbmRvd0xvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOwogICAgLy8gc3ltbGluayB0byBpbnN0YW5jZSBvYmplY3Qgb2YgJ0hpc3RvcnknCiAgICB2YXIgd2luZG93SGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgLy8gbmV3IGluc3RhbmNlIG9mICdIaXN0b3J5Jy4gVGhlIGRlZmF1bHQgaXMgYSByZWZlcmVuY2UgdG8gdGhlIG9yaWdpbmFsIG9iamVjdCBpbnN0YW5jZQogICAgdmFyIGhpc3RvcnlPYmplY3QgPSB3aW5kb3dIaXN0b3J5OwogICAgLy8gc3ltbGluayB0byBtZXRob2QgJ2hpc3RvcnkucHVzaFN0YXRlJwogICAgdmFyIGhpc3RvcnlQdXNoU3RhdGUgPSB3aW5kb3dIaXN0b3J5LnB1c2hTdGF0ZTsKICAgIC8vIHN5bWxpbmsgdG8gbWV0aG9kICdoaXN0b3J5LnJlcGxhY2VTdGF0ZScKICAgIHZhciBoaXN0b3J5UmVwbGFjZVN0YXRlID0gd2luZG93SGlzdG9yeS5yZXBsYWNlU3RhdGU7CiAgICAvLyBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBIVE1MNS1IaXN0b3J5LUFQSQogICAgdmFyIGlzU3VwcG9ydEhpc3RvcnlBUEkgPSAhIWhpc3RvcnlQdXNoU3RhdGU7CiAgICAvLyB2ZXJpZmllcyB0aGUgcHJlc2VuY2Ugb2YgYW4gb2JqZWN0ICdzdGF0ZScgaW4gaW50ZXJmYWNlICdIaXN0b3J5JwogICAgdmFyIGlzU3VwcG9ydFN0YXRlT2JqZWN0SW5IaXN0b3J5ID0gJ3N0YXRlJyBpbiB3aW5kb3dIaXN0b3J5OwogICAgLy8gc3ltbGluayB0byBtZXRob2QgJ09iamVjdC5kZWZpbmVQcm9wZXJ0eScKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIC8vIG5ldyBpbnN0YW5jZSBvZiAnTG9jYXRpb24nLCBmb3IgSUU4IHdpbGwgdXNlIHRoZSBlbGVtZW50IEhUTUxBbmNob3JFbGVtZW50LCBpbnN0ZWFkIG9mIHB1cmUgb2JqZWN0CiAgICB2YXIgbG9jYXRpb25PYmplY3QgPSByZWRlZmluZVByb3BlcnR5KHt9LCAndCcpID8ge30gOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAvLyBwcmVmaXggZm9yIHRoZSBuYW1lcyBvZiBldmVudHMKICAgIHZhciBldmVudE5hbWVQcmVmaXggPSAnJzsKICAgIC8vIFN0cmluZyB0aGF0IHdpbGwgY29udGFpbiB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kCiAgICB2YXIgYWRkRXZlbnRMaXN0ZW5lck5hbWUgPSB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lciA/ICdhZGRFdmVudExpc3RlbmVyJyA6IChldmVudE5hbWVQcmVmaXggPSAnb24nKSAmJiAnYXR0YWNoRXZlbnQnOwogICAgLy8gU3RyaW5nIHRoYXQgd2lsbCBjb250YWluIHRoZSBuYW1lIG9mIHRoZSBtZXRob2QKICAgIHZhciByZW1vdmVFdmVudExpc3RlbmVyTmFtZSA9IHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyID8gJ3JlbW92ZUV2ZW50TGlzdGVuZXInIDogJ2RldGFjaEV2ZW50JzsKICAgIC8vIFN0cmluZyB0aGF0IHdpbGwgY29udGFpbiB0aGUgbmFtZSBvZiB0aGUgbWV0aG9kCiAgICB2YXIgZGlzcGF0Y2hFdmVudE5hbWUgPSB3aW5kb3cuZGlzcGF0Y2hFdmVudCA/ICdkaXNwYXRjaEV2ZW50JyA6ICdmaXJlRXZlbnQnOwogICAgLy8gcmVmZXJlbmNlIG5hdGl2ZSBtZXRob2RzIGZvciB0aGUgZXZlbnRzCiAgICB2YXIgYWRkRXZlbnQgPSB3aW5kb3dbYWRkRXZlbnRMaXN0ZW5lck5hbWVdOwogICAgdmFyIHJlbW92ZUV2ZW50ID0gd2luZG93W3JlbW92ZUV2ZW50TGlzdGVuZXJOYW1lXTsKICAgIHZhciBkaXNwYXRjaCA9IHdpbmRvd1tkaXNwYXRjaEV2ZW50TmFtZV07CiAgICAvLyBkZWZhdWx0IHNldHRpbmdzCiAgICB2YXIgc2V0dGluZ3MgPSB7ImJhc2VwYXRoIjogJy8nLCAicmVkaXJlY3QiOiAwLCAidHlwZSI6ICcvJ307CiAgICAvLyBrZXkgZm9yIHRoZSBzZXNzaW9uU3RvcmFnZQogICAgdmFyIHNlc3Npb25TdG9yYWdlS2V5ID0gJ19faGlzdG9yeUFQSV9fJzsKICAgIC8vIEFuY2hvciBFbGVtZW50IGZvciBwYXJzZVVSTCBmdW5jdGlvbgogICAgdmFyIGFuY2hvckVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAvLyBsYXN0IFVSTCBiZWZvcmUgY2hhbmdlIHRvIG5ldyBVUkwKICAgIHZhciBsYXN0VVJMID0gd2luZG93TG9jYXRpb24uaHJlZjsKICAgIC8vIENvbnRyb2wgVVJMLCBuZWVkIHRvIGZpeCB0aGUgYnVnIGluIE9wZXJhCiAgICB2YXIgY2hlY2tVcmxGb3JQb3BTdGF0ZSA9ICcnOwogICAgLy8gdHJpZ2dlciBldmVudCAnb25wb3BzdGF0ZScgb24gcGFnZSBsb2FkCiAgICB2YXIgaXNGaXJlSW5pdGlhbFN0YXRlID0gZmFsc2U7CiAgICAvLyBzdG9yZSBhIGxpc3Qgb2YgJ3N0YXRlJyBvYmplY3RzIGluIHRoZSBjdXJyZW50IHNlc3Npb24KICAgIHZhciBzdGF0ZVN0b3JhZ2UgPSB7fTsKICAgIC8vIGluIHRoaXMgb2JqZWN0IHdpbGwgYmUgc3RvcmVkIGN1c3RvbSBoYW5kbGVycwogICAgdmFyIGV2ZW50c0xpc3QgPSB7fTsKICAgIC8vIHN0b3JlZCBsYXN0IHRpdGxlCiAgICB2YXIgbGFzdFRpdGxlID0gZG9jdW1lbnQudGl0bGU7CgogICAgLyoqCiAgICAgKiBQcm9wZXJ0aWVzIHRoYXQgd2lsbCBiZSByZXBsYWNlZCBpbiB0aGUgZ2xvYmFsCiAgICAgKiBvYmplY3QgJ3dpbmRvdycsIHRvIHByZXZlbnQgY29uZmxpY3RzCiAgICAgKgogICAgICogQHR5cGUge09iamVjdH0KICAgICAqLwogICAgdmFyIGV2ZW50c0Rlc2NyaXB0b3JzID0gewogICAgICAgICJvbmhhc2hjaGFuZ2UiOiBudWxsLAogICAgICAgICJvbnBvcHN0YXRlIjogbnVsbAogICAgfTsKCiAgICAvKioKICAgICAqIEZpeCBmb3IgQ2hyb21lIGluIGlPUwogICAgICogU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kZXZvdGUvSFRNTDUtSGlzdG9yeS1BUEkvaXNzdWVzLzI5CiAgICAgKi8KICAgIHZhciBmYXN0Rml4Q2hyb21lID0gZnVuY3Rpb24obWV0aG9kLCBhcmdzKSB7CiAgICAgICAgdmFyIGlzTmVlZEZpeCA9IHdpbmRvdy5oaXN0b3J5ICE9PSB3aW5kb3dIaXN0b3J5OwogICAgICAgIGlmIChpc05lZWRGaXgpIHsKICAgICAgICAgICAgd2luZG93Lmhpc3RvcnkgPSB3aW5kb3dIaXN0b3J5OwogICAgICAgIH0KICAgICAgICBtZXRob2QuYXBwbHkod2luZG93SGlzdG9yeSwgYXJncyk7CiAgICAgICAgaWYgKGlzTmVlZEZpeCkgewogICAgICAgICAgICB3aW5kb3cuaGlzdG9yeSA9IGhpc3RvcnlPYmplY3Q7CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIFByb3BlcnRpZXMgdGhhdCB3aWxsIGJlIHJlcGxhY2VkL2FkZGVkIHRvIG9iamVjdAogICAgICogJ3dpbmRvdy5oaXN0b3J5JywgaW5jbHVkZXMgdGhlIG9iamVjdCAnaGlzdG9yeS5sb2NhdGlvbicsCiAgICAgKiBmb3IgYSBjb21wbGV0ZSB0aGUgd29yayB3aXRoIHRoZSBVUkwgYWRkcmVzcwogICAgICoKICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgKi8KICAgIHZhciBoaXN0b3J5RGVzY3JpcHRvcnMgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IFt0eXBlXQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBbYmFzZXBhdGhdCiAgICAgICAgICovCiAgICAgICAgInJlZGlyZWN0IjogZnVuY3Rpb24odHlwZSwgYmFzZXBhdGgpIHsKICAgICAgICAgICAgc2V0dGluZ3NbImJhc2VwYXRoIl0gPSBiYXNlcGF0aCA9IGJhc2VwYXRoID09IG51bGwgPyBzZXR0aW5nc1siYmFzZXBhdGgiXSA6IGJhc2VwYXRoOwogICAgICAgICAgICBzZXR0aW5nc1sidHlwZSJdID0gdHlwZSA9IHR5cGUgPT0gbnVsbCA/IHNldHRpbmdzWyJ0eXBlIl0gOiB0eXBlOwogICAgICAgICAgICBpZiAod2luZG93LnRvcCA9PSB3aW5kb3cuc2VsZikgewogICAgICAgICAgICAgICAgdmFyIHJlbGF0aXZlID0gcGFyc2VVUkwobnVsbCwgZmFsc2UsIHRydWUpLl9yZWxhdGl2ZTsKICAgICAgICAgICAgICAgIHZhciBwYXRoID0gd2luZG93TG9jYXRpb24ucGF0aG5hbWUgKyB3aW5kb3dMb2NhdGlvbi5zZWFyY2g7CiAgICAgICAgICAgICAgICBpZiAoaXNTdXBwb3J0SGlzdG9yeUFQSSkgewogICAgICAgICAgICAgICAgICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoLyhbXlwvXSkkLywgJyQxLycpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZWxhdGl2ZSAhPSBiYXNlcGF0aCAmJiAobmV3IFJlZ0V4cCgiXiIgKyBiYXNlcGF0aCArICIkIiwgImkiKSkudGVzdChwYXRoKSkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5yZXBsYWNlKHJlbGF0aXZlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHBhdGggIT0gYmFzZXBhdGgpIHsKICAgICAgICAgICAgICAgICAgICBwYXRoID0gcGF0aC5yZXBsYWNlKC8oW15cL10pXD8vLCAnJDEvPycpOwogICAgICAgICAgICAgICAgICAgIGlmICgobmV3IFJlZ0V4cCgiXiIgKyBiYXNlcGF0aCwgImkiKSkudGVzdChwYXRoKSkgewogICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5yZXBsYWNlKGJhc2VwYXRoICsgJyMnICsgcGF0aC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2UobmV3IFJlZ0V4cCgiXiIgKyBiYXNlcGF0aCwgImkiKSwgdHlwZSkgKyB3aW5kb3dMb2NhdGlvbi5oYXNoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBtZXRob2QgYWRkcyBhIHN0YXRlIG9iamVjdCBlbnRyeQogICAgICAgICAqIHRvIHRoZSBoaXN0b3J5LgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5CiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IHRpdGxlCiAgICAgICAgICogQHBhcmFtIHtzdHJpbmd9IFt1cmxdCiAgICAgICAgICovCiAgICAgICAgcHVzaFN0YXRlOiBmdW5jdGlvbihzdGF0ZSwgdGl0bGUsIHVybCkgewogICAgICAgICAgICB2YXIgdCA9IGRvY3VtZW50LnRpdGxlOwogICAgICAgICAgICBpZiAobGFzdFRpdGxlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gbGFzdFRpdGxlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhpc3RvcnlQdXNoU3RhdGUgJiYgZmFzdEZpeENocm9tZShoaXN0b3J5UHVzaFN0YXRlLCBhcmd1bWVudHMpOwogICAgICAgICAgICBjaGFuZ2VTdGF0ZShzdGF0ZSwgdXJsKTsKICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSB0OwogICAgICAgICAgICBsYXN0VGl0bGUgPSB0aXRsZTsKICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFRoZSBtZXRob2QgdXBkYXRlcyB0aGUgc3RhdGUgb2JqZWN0LAogICAgICAgICAqIHRpdGxlLCBhbmQgb3B0aW9uYWxseSB0aGUgVVJMIG9mIHRoZQogICAgICAgICAqIGN1cnJlbnQgZW50cnkgaW4gdGhlIGhpc3RvcnkuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGl0bGUKICAgICAgICAgKiBAcGFyYW0ge3N0cmluZ30gW3VybF0KICAgICAgICAgKi8KICAgICAgICByZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCB0aXRsZSwgdXJsKSB7CiAgICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQudGl0bGU7CiAgICAgICAgICAgIGlmIChsYXN0VGl0bGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBsYXN0VGl0bGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlIHN0YXRlU3RvcmFnZVt3aW5kb3dMb2NhdGlvbi5ocmVmXTsKICAgICAgICAgICAgaGlzdG9yeVJlcGxhY2VTdGF0ZSAmJiBmYXN0Rml4Q2hyb21lKGhpc3RvcnlSZXBsYWNlU3RhdGUsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGNoYW5nZVN0YXRlKHN0YXRlLCB1cmwsIHRydWUpOwogICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IHQ7CiAgICAgICAgICAgIGxhc3RUaXRsZSA9IHRpdGxlOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogT2JqZWN0ICdoaXN0b3J5LmxvY2F0aW9uJyBpcyBzaW1pbGFyIHRvIHRoZQogICAgICAgICAqIG9iamVjdCAnd2luZG93LmxvY2F0aW9uJywgZXhjZXB0IHRoYXQgaW4KICAgICAgICAgKiBIVE1MNCBicm93c2VycyBpdCB3aWxsIGJlaGF2ZSBhIGJpdCBkaWZmZXJlbnRseQogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5CiAgICAgICAgICovCiAgICAgICAgImxvY2F0aW9uIjogewogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSB2YWx1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc1N1cHBvcnRIaXN0b3J5QVBJID8gd2luZG93TG9jYXRpb24gOiBsb2NhdGlvbk9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogQSBzdGF0ZSBvYmplY3QgaXMgYW4gb2JqZWN0IHJlcHJlc2VudGluZwogICAgICAgICAqIGEgdXNlciBpbnRlcmZhY2Ugc3RhdGUuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkKICAgICAgICAgKi8KICAgICAgICAic3RhdGUiOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGVTdG9yYWdlW3dpbmRvd0xvY2F0aW9uLmhyZWZdIHx8IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgIC8qKgogICAgICogUHJvcGVydGllcyBmb3Igb2JqZWN0ICdoaXN0b3J5LmxvY2F0aW9uJy4KICAgICAqIE9iamVjdCAnaGlzdG9yeS5sb2NhdGlvbicgaXMgc2ltaWxhciB0byB0aGUKICAgICAqIG9iamVjdCAnd2luZG93LmxvY2F0aW9uJywgZXhjZXB0IHRoYXQgaW4KICAgICAqIEhUTUw0IGJyb3dzZXJzIGl0IHdpbGwgYmVoYXZlIGEgYml0IGRpZmZlcmVudGx5CiAgICAgKgogICAgICogQHR5cGUge09iamVjdH0KICAgICAqLwogICAgdmFyIGxvY2F0aW9uRGVzY3JpcHRvcnMgPSB7CiAgICAgICAgLyoqCiAgICAgICAgICogTmF2aWdhdGVzIHRvIHRoZSBnaXZlbiBwYWdlLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgYXNzaWduOiBmdW5jdGlvbih1cmwpIHsKICAgICAgICAgICAgaWYgKCgnJyArIHVybCkuaW5kZXhPZignIycpID09PSAwKSB7CiAgICAgICAgICAgICAgICBjaGFuZ2VTdGF0ZShudWxsLCB1cmwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2luZG93TG9jYXRpb24uYXNzaWduKHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFJlbG9hZHMgdGhlIGN1cnJlbnQgcGFnZS4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeS5sb2NhdGlvbgogICAgICAgICAqLwogICAgICAgIHJlbG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHdpbmRvd0xvY2F0aW9uLnJlbG9hZCgpOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmVtb3ZlcyB0aGUgY3VycmVudCBwYWdlIGZyb20KICAgICAgICAgKiB0aGUgc2Vzc2lvbiBoaXN0b3J5IGFuZCBuYXZpZ2F0ZXMKICAgICAgICAgKiB0byB0aGUgZ2l2ZW4gcGFnZS4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeS5sb2NhdGlvbgogICAgICAgICAqLwogICAgICAgIHJlcGxhY2U6IGZ1bmN0aW9uKHVybCkgewogICAgICAgICAgICBpZiAoKCcnICsgdXJsKS5pbmRleE9mKCcjJykgPT09IDApIHsKICAgICAgICAgICAgICAgIGNoYW5nZVN0YXRlKG51bGwsIHVybCwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5yZXBsYWNlKHVybCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIGxvY2F0aW9uLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5ocmVmOwogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgbG9jYXRpb24uCiAgICAgICAgICogQ2FuIGJlIHNldCwgdG8gbmF2aWdhdGUgdG8gYW5vdGhlciBwYWdlLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgImhyZWYiOiB7CiAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VVUkwoKS5faHJlZjsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3MgcHJvdG9jb2wuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAicHJvdG9jb2wiOiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIGhvc3QgYW5kIHBvcnQgbnVtYmVyLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgImhvc3QiOiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIGhvc3QuCiAgICAgICAgICoKICAgICAgICAgKiBAbmFtZXNwYWNlIGhpc3RvcnkubG9jYXRpb24KICAgICAgICAgKi8KICAgICAgICAiaG9zdG5hbWUiOiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIHBvcnQgbnVtYmVyLgogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgInBvcnQiOiBudWxsLAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIHBhdGggb25seS4KICAgICAgICAgKgogICAgICAgICAqIEBuYW1lc3BhY2UgaGlzdG9yeS5sb2NhdGlvbgogICAgICAgICAqLwogICAgICAgICJwYXRobmFtZSI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVVSTCgpLl9wYXRobmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyB0aGUgY3VycmVudCBwYWdlJ3Mgc2VhcmNoCiAgICAgICAgICogc3RyaW5nLCBiZWdpbm5pbmcgd2l0aCB0aGUgY2hhcmFjdGVyCiAgICAgICAgICogJz8nIGFuZCB0byB0aGUgc3ltYm9sICcjJwogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgInNlYXJjaCI6IHsKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVVSTCgpLl9zZWFyY2g7CiAgICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIC8qKgogICAgICAgICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcGFnZSdzIGhhc2gKICAgICAgICAgKiBzdHJpbmcsIGJlZ2lubmluZyB3aXRoIHRoZSBjaGFyYWN0ZXIKICAgICAgICAgKiAnIycgYW5kIHRvIHRoZSBlbmQgbGluZQogICAgICAgICAqCiAgICAgICAgICogQG5hbWVzcGFjZSBoaXN0b3J5LmxvY2F0aW9uCiAgICAgICAgICovCiAgICAgICAgImhhc2giOiB7CiAgICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICAgIGNoYW5nZVN0YXRlKG51bGwsICgnJyArIHZhbHVlKS5yZXBsYWNlKC9eKCN8KS8sICcjJyksIGZhbHNlLCBsYXN0VVJMKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZVVSTCgpLl9oYXNoOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAvKioKICAgICAqIEp1c3QgZW1wdHkgZnVuY3Rpb24KICAgICAqCiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gZW1wdHlGdW5jdGlvbigpIHsKICAgICAgICAvLyBkdW1teQogICAgfQoKICAgIC8qKgogICAgICogUHJlcGFyZXMgYSBwYXJ0cyBvZiB0aGUgY3VycmVudCBvciBzcGVjaWZpZWQgcmVmZXJlbmNlIGZvciBsYXRlciB1c2UgaW4gdGhlIGxpYnJhcnkKICAgICAqCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2hyZWZdCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpc1dpbmRvd0xvY2F0aW9uXQogICAgICogQHBhcmFtIHtib29sZWFufSBbaXNOb3RBUEldCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9CiAgICAgKi8KICAgIGZ1bmN0aW9uIHBhcnNlVVJMKGhyZWYsIGlzV2luZG93TG9jYXRpb24sIGlzTm90QVBJKSB7CiAgICAgICAgdmFyIHJlID0gLyg/OihbXHcwLTldKzopKT8oPzpcL1wvKD86W15AXSpAKT8oW15cLzpcPyNdKykoPzo6KFswLTldKykpPyk/KFteXD8jXSopKD86KFw/W14jXSspfFw/KT8oPzooIy4qKSk/LzsKICAgICAgICBpZiAoaHJlZiAhPSBudWxsICYmIGhyZWYgIT09ICcnICYmICFpc1dpbmRvd0xvY2F0aW9uKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50ID0gcGFyc2VVUkwoKSwgX3BhdGhuYW1lID0gY3VycmVudC5fcGF0aG5hbWUsIF9wcm90b2NvbCA9IGN1cnJlbnQuX3Byb3RvY29sOwogICAgICAgICAgICAvLyBjb252ZXJ0IHRvIHR5cGUgb2Ygc3RyaW5nCiAgICAgICAgICAgIGhyZWYgPSAnJyArIGhyZWY7CiAgICAgICAgICAgIC8vIGNvbnZlcnQgcmVsYXRpdmUgbGluayB0byB0aGUgYWJzb2x1dGUKICAgICAgICAgICAgaHJlZiA9IC9eKD86W1x3MC05XStcOik/XC9cLy8udGVzdChocmVmKSA/IGhyZWYuaW5kZXhPZigiLyIpID09PSAwCiAgICAgICAgICAgICAgICA/IF9wcm90b2NvbCArIGhyZWYgOiBocmVmIDogX3Byb3RvY29sICsgIi8vIiArIGN1cnJlbnQuX2hvc3QgKyAoCiAgICAgICAgICAgICAgICBocmVmLmluZGV4T2YoIi8iKSA9PT0gMCA/IGhyZWYgOiBocmVmLmluZGV4T2YoIj8iKSA9PT0gMAogICAgICAgICAgICAgICAgICAgID8gX3BhdGhuYW1lICsgaHJlZiA6IGhyZWYuaW5kZXhPZigiIyIpID09PSAwCiAgICAgICAgICAgICAgICAgICAgPyBfcGF0aG5hbWUgKyBjdXJyZW50Ll9zZWFyY2ggKyBocmVmIDogX3BhdGhuYW1lLnJlcGxhY2UoL1teXC9dKyQvZywgJycpICsgaHJlZgogICAgICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBocmVmID0gaXNXaW5kb3dMb2NhdGlvbiA/IGhyZWYgOiB3aW5kb3dMb2NhdGlvbi5ocmVmOwogICAgICAgICAgICAvLyBpZiBjdXJyZW50IGJyb3dzZXIgbm90IHN1cHBvcnQgSGlzdG9yeS1BUEkKICAgICAgICAgICAgaWYgKCFpc1N1cHBvcnRIaXN0b3J5QVBJIHx8IGlzTm90QVBJKSB7CiAgICAgICAgICAgICAgICAvLyBnZXQgaGFzaCBmcmFnbWVudAogICAgICAgICAgICAgICAgaHJlZiA9IGhyZWYucmVwbGFjZSgvXlteI10qLywgJycpIHx8ICIjIjsKICAgICAgICAgICAgICAgIC8vIGZvcm0gdGhlIGFic29sdXRlIGxpbmsgZnJvbSB0aGUgaGFzaAogICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2Rldm90ZS9IVE1MNS1IaXN0b3J5LUFQSS9pc3N1ZXMvNTAKICAgICAgICAgICAgICAgIGhyZWYgPSB3aW5kb3dMb2NhdGlvbi5wcm90b2NvbC5yZXBsYWNlKC86LiokfCQvLCAnOicpICsgJy8vJyArIHdpbmRvd0xvY2F0aW9uLmhvc3QgKyBzZXR0aW5nc1snYmFzZXBhdGgnXQogICAgICAgICAgICAgICAgICAgICsgaHJlZi5yZXBsYWNlKG5ldyBSZWdFeHAoIl4jW1wvXT8oPzoiICsgc2V0dGluZ3NbInR5cGUiXSArICIpPyIpLCAiIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLy8gdGhhdCB3b3VsZCBnZXQgcmlkIG9mIHRoZSBsaW5rcyBvZiB0aGUgZm9ybTogLy4uLy4uLwogICAgICAgIGFuY2hvckVsZW1lbnQuaHJlZiA9IGhyZWY7CiAgICAgICAgLy8gZGVjb21wb3NlIHRoZSBsaW5rIGluIHBhcnRzCiAgICAgICAgdmFyIHJlc3VsdCA9IHJlLmV4ZWMoYW5jaG9yRWxlbWVudC5ocmVmKTsKICAgICAgICAvLyBob3N0IG5hbWUgd2l0aCB0aGUgcG9ydCBudW1iZXIKICAgICAgICB2YXIgaG9zdCA9IHJlc3VsdFsyXSArIChyZXN1bHRbM10gPyAnOicgKyByZXN1bHRbM10gOiAnJyk7CiAgICAgICAgLy8gZm9sZGVyCiAgICAgICAgdmFyIHBhdGhuYW1lID0gcmVzdWx0WzRdIHx8ICcvJzsKICAgICAgICAvLyB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgdmFyIHNlYXJjaCA9IHJlc3VsdFs1XSB8fCAnJzsKICAgICAgICAvLyBoYXNoCiAgICAgICAgdmFyIGhhc2ggPSByZXN1bHRbNl0gPT09ICcjJyA/ICcnIDogKHJlc3VsdFs2XSB8fCAnJyk7CiAgICAgICAgLy8gcmVsYXRpdmUgbGluaywgbm8gcHJvdG9jb2wsIG5vIGhvc3QKICAgICAgICB2YXIgcmVsYXRpdmUgPSBwYXRobmFtZSArIHNlYXJjaCArIGhhc2g7CiAgICAgICAgLy8gc3BlY2lhbCBsaW5rcyBmb3Igc2V0IHRvIGhhc2gtbGluaywgaWYgYnJvd3NlciBub3Qgc3VwcG9ydCBIaXN0b3J5IEFQSQogICAgICAgIHZhciBub2hhc2ggPSBwYXRobmFtZS5yZXBsYWNlKG5ldyBSZWdFeHAoIl4iICsgc2V0dGluZ3NbImJhc2VwYXRoIl0sICJpIiksIHNldHRpbmdzWyJ0eXBlIl0pICsgc2VhcmNoOwogICAgICAgIC8vIHJlc3VsdAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIF9ocmVmOiByZXN1bHRbMV0gKyAnLy8nICsgaG9zdCArIHJlbGF0aXZlLAogICAgICAgICAgICBfcHJvdG9jb2w6IHJlc3VsdFsxXSwKICAgICAgICAgICAgX2hvc3Q6IGhvc3QsCiAgICAgICAgICAgIF9ob3N0bmFtZTogcmVzdWx0WzJdLAogICAgICAgICAgICBfcG9ydDogcmVzdWx0WzNdIHx8ICcnLAogICAgICAgICAgICBfcGF0aG5hbWU6IHBhdGhuYW1lLAogICAgICAgICAgICBfc2VhcmNoOiBzZWFyY2gsCiAgICAgICAgICAgIF9oYXNoOiBoYXNoLAogICAgICAgICAgICBfcmVsYXRpdmU6IHJlbGF0aXZlLAogICAgICAgICAgICBfbm9oYXNoOiBub2hhc2gsCiAgICAgICAgICAgIF9zcGVjaWFsOiBub2hhc2ggKyBoYXNoCiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSW5pdGlhbGl6aW5nIHN0b3JhZ2UgZm9yIHRoZSBjdXN0b20gc3RhdGUncyBvYmplY3QKICAgICAqLwogICAgZnVuY3Rpb24gc3RvcmFnZUluaXRpYWxpemUoKSB7CiAgICAgICAgdmFyIHNlc3Npb25TdG9yYWdlOwogICAgICAgIC8qKgogICAgICAgICAqIHNlc3Npb25TdG9yYWdlIHRocm93cyBlcnJvciB3aGVuIGNvb2tpZXMgYXJlIGRpc2FibGVkCiAgICAgICAgICogQ2hyb21lIGNvbnRlbnQgc2V0dGluZ3Mgd2hlbiBydW5uaW5nIHRoZSBzaXRlIGluIGEgRmFjZWJvb2sgSUZyYW1lLgogICAgICAgICAqIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL2Rldm90ZS9IVE1MNS1IaXN0b3J5LUFQSS9pc3N1ZXMvMzQKICAgICAgICAgKiBhbmQ6IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzEyOTc2OTg4LzY2OTM2MAogICAgICAgICAqLwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlID0gd2luZG93WydzZXNzaW9uU3RvcmFnZSddOwogICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHNlc3Npb25TdG9yYWdlS2V5ICsgJ3QnLCAnMScpOwogICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKHNlc3Npb25TdG9yYWdlS2V5ICsgJ3QnKTsKICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgICAgICBzZXNzaW9uU3RvcmFnZSA9IHsKICAgICAgICAgICAgICAgIGdldEl0ZW06IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICAgIHZhciBjb29raWUgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoa2V5ICsgIj0iKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29va2llLmxlbmd0aCA+IDEgJiYgY29va2llLnBvcCgpLnNwbGl0KCI7Iikuc2hpZnQoKSB8fCAnbnVsbCc7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0SXRlbTogZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHt9OwogICAgICAgICAgICAgICAgICAgIC8vIGluc2VydCBvbmUgY3VycmVudCBlbGVtZW50IHRvIGNvb2tpZQogICAgICAgICAgICAgICAgICAgIGlmIChzdGF0ZVt3aW5kb3dMb2NhdGlvbi5ocmVmXSA9IGhpc3RvcnlPYmplY3Quc3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0ga2V5ICsgJz0nICsgSlNPTi5zdHJpbmdpZnkoc3RhdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgLy8gZ2V0IGNhY2hlIGZyb20gdGhlIHN0b3JhZ2UgaW4gYnJvd3NlcgogICAgICAgICAgICBzdGF0ZVN0b3JhZ2UgPSBKU09OLnBhcnNlKHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oc2Vzc2lvblN0b3JhZ2VLZXkpKSB8fCB7fTsKICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgICAgICBzdGF0ZVN0b3JhZ2UgPSB7fTsKICAgICAgICB9CgogICAgICAgIC8vIGhhbmcgdXAgdGhlIGV2ZW50IGhhbmRsZXIgdG8gZXZlbnQgdW5sb2FkIHBhZ2UKICAgICAgICBhZGRFdmVudChldmVudE5hbWVQcmVmaXggKyAndW5sb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIC8vIHNhdmUgY3VycmVudCBzdGF0ZSdzIG9iamVjdAogICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHNlc3Npb25TdG9yYWdlS2V5LCBKU09OLnN0cmluZ2lmeShzdGF0ZVN0b3JhZ2UpKTsKICAgICAgICB9LCBmYWxzZSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBpbXBsZW1lbnRlZCB0byBvdmVycmlkZSB0aGUgYnVpbHQtaW4obmF0aXZlKQogICAgICogcHJvcGVydGllcyBpbiB0aGUgYnJvd3NlciwgdW5mb3J0dW5hdGVseSBzb21lIGJyb3dzZXJzIGFyZQogICAgICogbm90IGFsbG93ZWQgdG8gb3ZlcnJpZGUgYWxsIHRoZSBwcm9wZXJ0aWVzIGFuZCBldmVuIGFkZC4KICAgICAqIEZvciB0aGlzIHJlYXNvbiwgdGhpcyB3YXMgd3JpdHRlbiBieSBhIG1ldGhvZCB0aGF0IHRyaWVzIHRvCiAgICAgKiBkbyBldmVyeXRoaW5nIG5lY2Vzc2FyeSB0byBnZXQgdGhlIGRlc2lyZWQgcmVzdWx0LgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgVGhlIG9iamVjdCBpbiB3aGljaCB3aWxsIGJlIG92ZXJyaWRkZW4vYWRkZWQgcHJvcGVydHkKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwcm9wIFRoZSBwcm9wZXJ0eSBuYW1lIHRvIGJlIG92ZXJyaWRkZW4vYWRkZWQKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbZGVzY3JpcHRvcl0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllcyBzZXQvZ2V0CiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbb25XcmFwcGVkXSBUaGUgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIHdoZW4gdGhlIHdyYXBwZXIgaXMgY3JlYXRlZAogICAgICogQHJldHVybiB7T2JqZWN0fEJvb2xlYW59IFJldHVybnMgYW4gb2JqZWN0IG9uIHN1Y2Nlc3MsIG90aGVyd2lzZSByZXR1cm5zIGZhbHNlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHJlZGVmaW5lUHJvcGVydHkob2JqZWN0LCBwcm9wLCBkZXNjcmlwdG9yLCBvbldyYXBwZWQpIHsKICAgICAgICAvLyB0ZXN0IG9ubHkgaWYgZGVzY3JpcHRvciBpcyB1bmRlZmluZWQKICAgICAgICBkZXNjcmlwdG9yID0gZGVzY3JpcHRvciB8fCB7c2V0OiBlbXB0eUZ1bmN0aW9ufTsKICAgICAgICAvLyB2YXJpYWJsZSB3aWxsIGhhdmUgYSB2YWx1ZSBvZiB0cnVlIHRoZSBzdWNjZXNzIG9mIGF0dGVtcHRzIHRvIHNldCBkZXNjcmlwdG9ycwogICAgICAgIHZhciBpc0RlZmluZWRTZXR0ZXIgPSAhZGVzY3JpcHRvci5zZXQ7CiAgICAgICAgdmFyIGlzRGVmaW5lZEdldHRlciA9ICFkZXNjcmlwdG9yLmdldDsKICAgICAgICAvLyBmb3IgdGVzdHMgb2YgYXR0ZW1wdHMgdG8gc2V0IGRlc2NyaXB0b3JzCiAgICAgICAgdmFyIHRlc3QgPSB7Y29uZmlndXJhYmxlOiB0cnVlLCBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpc0RlZmluZWRTZXR0ZXIgPSAxOwogICAgICAgIH0sIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlzRGVmaW5lZEdldHRlciA9IDE7CiAgICAgICAgfX07CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIHRlc3RpbmcgZm9yIHRoZSBwb3NzaWJpbGl0eSBvZiBvdmVycmlkaW5nL2FkZGluZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgIGRlZmluZVByb3BlcnR5KG9iamVjdCwgcHJvcCwgdGVzdCk7CiAgICAgICAgICAgIC8vIHJ1bm5pbmcgdGhlIHRlc3QKICAgICAgICAgICAgb2JqZWN0W3Byb3BdID0gb2JqZWN0W3Byb3BdOwogICAgICAgICAgICAvLyBhdHRlbXB0IHRvIG92ZXJyaWRlIHByb3BlcnR5IHVzaW5nIHRoZSBzdGFuZGFyZCBtZXRob2QKICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkob2JqZWN0LCBwcm9wLCBkZXNjcmlwdG9yKTsKICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgIH0KCiAgICAgICAgLy8gSWYgdGhlIHZhcmlhYmxlICdpc0RlZmluZWQnIGhhcyBhIGZhbHNlIHZhbHVlLCBpdCBtZWFucyB0aGF0IG5lZWQgdG8gdHJ5IG90aGVyIG1ldGhvZHMKICAgICAgICBpZiAoIWlzRGVmaW5lZFNldHRlciB8fCAhaXNEZWZpbmVkR2V0dGVyKSB7CiAgICAgICAgICAgIC8vIHRyeSB0byBvdmVycmlkZS9hZGQgdGhlIHByb3BlcnR5LCB1c2luZyBkZXByZWNhdGVkIGZ1bmN0aW9ucwogICAgICAgICAgICBpZiAob2JqZWN0Ll9fZGVmaW5lR2V0dGVyX18pIHsKICAgICAgICAgICAgICAgIC8vIHRlc3RpbmcgZm9yIHRoZSBwb3NzaWJpbGl0eSBvZiBvdmVycmlkaW5nL2FkZGluZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBvYmplY3QuX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCB0ZXN0LmdldCk7CiAgICAgICAgICAgICAgICBvYmplY3QuX19kZWZpbmVTZXR0ZXJfXyhwcm9wLCB0ZXN0LnNldCk7CiAgICAgICAgICAgICAgICAvLyBydW5uaW5nIHRoZSB0ZXN0CiAgICAgICAgICAgICAgICBvYmplY3RbcHJvcF0gPSBvYmplY3RbcHJvcF07CiAgICAgICAgICAgICAgICAvLyBhdHRlbXB0IHRvIG92ZXJyaWRlIHByb3BlcnR5IHVzaW5nIHRoZSBkZXByZWNhdGVkIGZ1bmN0aW9ucwogICAgICAgICAgICAgICAgZGVzY3JpcHRvci5nZXQgJiYgb2JqZWN0Ll9fZGVmaW5lR2V0dGVyX18ocHJvcCwgZGVzY3JpcHRvci5nZXQpOwogICAgICAgICAgICAgICAgZGVzY3JpcHRvci5zZXQgJiYgb2JqZWN0Ll9fZGVmaW5lU2V0dGVyX18ocHJvcCwgZGVzY3JpcHRvci5zZXQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBCcm93c2VyIHJlZnVzZWQgdG8gb3ZlcnJpZGUgdGhlIHByb3BlcnR5LCB1c2luZyB0aGUgc3RhbmRhcmQgYW5kIGRlcHJlY2F0ZWQgbWV0aG9kcwogICAgICAgICAgICBpZiAoKCFpc0RlZmluZWRTZXR0ZXIgfHwgIWlzRGVmaW5lZEdldHRlcikgJiYgb2JqZWN0ID09PSB3aW5kb3cpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgLy8gc2F2ZSBvcmlnaW5hbCB2YWx1ZSBmcm9tIHRoaXMgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxWYWx1ZSA9IG9iamVjdFtwcm9wXTsKICAgICAgICAgICAgICAgICAgICAvLyBzZXQgbnVsbCB0byBidWlsdC1pbihuYXRpdmUpIHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0W3Byb3BdID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBUaGlzIHJ1bGUgZm9yIEludGVybmV0IEV4cGxvcmVyIDgKICAgICAgICAgICAgICAgIGlmICgnZXhlY1NjcmlwdCcgaW4gd2luZG93KSB7CiAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICogdG8gSUU4IG92ZXJyaWRlIHRoZSBnbG9iYWwgcHJvcGVydGllcyB1c2luZwogICAgICAgICAgICAgICAgICAgICAqIFZCU2NyaXB0LCBkZWNsYXJpbmcgaXQgaW4gZ2xvYmFsIHNjb3BlIHdpdGgKICAgICAgICAgICAgICAgICAgICAgKiB0aGUgc2FtZSBuYW1lcy4KICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICB3aW5kb3dbJ2V4ZWNTY3JpcHQnXSgnUHVibGljICcgKyBwcm9wLCAnVkJTY3JpcHQnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAgICAgICAgICAgICAqIFRoaXMgaGFjayBhbGxvd3MgdG8gb3ZlcnJpZGUgYSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgKiB3aXRoIHRoZSBzZXQgJ2NvbmZpZ3VyYWJsZTogZmFsc2UnLCB3b3JraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAqIGluIHRoZSBoYWNrICdTYWZhcmknIHRvICdNYWMnCiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShvYmplY3QsIHByb3AsIHt2YWx1ZTogZW1wdHlGdW5jdGlvbn0pOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2goX2VfKSB7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gc2V0IG9sZCB2YWx1ZSB0byBuZXcgdmFyaWFibGUKICAgICAgICAgICAgICAgIG9iamVjdFtwcm9wXSA9IG9yaWdpbmFsVmFsdWU7CgogICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0RlZmluZWRTZXR0ZXIgfHwgIWlzRGVmaW5lZEdldHRlcikgewogICAgICAgICAgICAgICAgLy8gdGhlIGxhc3Qgc3RhZ2Ugb2YgdHJ5aW5nIHRvIG92ZXJyaWRlIHRoZSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB3cmFwIHRoZSBvYmplY3QgaW4gYSBuZXcgZW1wdHkgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wID0gT2JqZWN0LmNyZWF0ZShvYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZpbmVQcm9wZXJ0eShPYmplY3QuZ2V0UHJvdG90eXBlT2YodGVtcCkgPT09IG9iamVjdCA/IHRlbXAgOiBvYmplY3QsIHByb3AsIGRlc2NyaXB0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IodmFyIGtleSBpbiBvYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG5lZWQgdG8gYmluZCBhIGZ1bmN0aW9uIHRvIHRoZSBvcmlnaW5hbCBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0W2tleV0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZW1wW2tleV0gPSBvYmplY3Rba2V5XS5iaW5kKG9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvIHJ1biBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBpbmZvcm0gYWJvdXQgd2hhdCB0aGUgb2JqZWN0IHdhcyB0byB3cmFwcGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbldyYXBwZWQuY2FsbCh0ZW1wLCB0ZW1wLCBvYmplY3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoKF9lXykgewogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCA9IHRlbXA7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaChfZV8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gc29tZXRpbWVzIHdvcmtzIG92ZXJyaWRlIHNpbXBseSBieSBhc3NpZ25pbmcgdGhlIHByb3RvdHlwZSBwcm9wZXJ0eSBvZiB0aGUgY29uc3RydWN0b3IKICAgICAgICAgICAgICAgICAgICAgICAgZGVmaW5lUHJvcGVydHkob2JqZWN0LmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvcCwgZGVzY3JpcHRvcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaChfZV8pIHsKICAgICAgICAgICAgICAgICAgICAvLyBhbGwgbWV0aG9kcyBoYXZlIGZhaWxlZAogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgdGhlIG1pc3NpbmcgcHJvcGVydHkgaW4gZGVzY3JpcHRvcgogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3QgQW4gb2JqZWN0IHRoYXQgc3RvcmVzIHZhbHVlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHByb3AgTmFtZSBvZiB0aGUgcHJvcGVydHkgaW4gdGhlIG9iamVjdAogICAgICogQHBhcmFtIHtPYmplY3R8bnVsbH0gZGVzY3JpcHRvciBEZXNjcmlwdG9yCiAgICAgKiBAcmV0dXJuIHtPYmplY3R9IFJldHVybnMgdGhlIGdlbmVyYXRlZCBkZXNjcmlwdG9yCiAgICAgKi8KICAgIGZ1bmN0aW9uIHByZXBhcmVEZXNjcmlwdG9yc0Zvck9iamVjdChvYmplY3QsIHByb3AsIGRlc2NyaXB0b3IpIHsKICAgICAgICBkZXNjcmlwdG9yID0gZGVzY3JpcHRvciB8fCB7fTsKICAgICAgICAvLyB0aGUgZGVmYXVsdCBmb3IgdGhlIG9iamVjdCAnbG9jYXRpb24nIGlzIHRoZSBzdGFuZGFyZCBvYmplY3QgJ3dpbmRvdy5sb2NhdGlvbicKICAgICAgICBvYmplY3QgPSBvYmplY3QgPT09IGxvY2F0aW9uRGVzY3JpcHRvcnMgPyB3aW5kb3dMb2NhdGlvbiA6IG9iamVjdDsKICAgICAgICAvLyBzZXR0ZXIgZm9yIG9iamVjdCBwcm9wZXJ0aWVzCiAgICAgICAgZGVzY3JpcHRvci5zZXQgPSAoZGVzY3JpcHRvci5zZXQgfHwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgb2JqZWN0W3Byb3BdID0gdmFsdWU7CiAgICAgICAgfSk7CiAgICAgICAgLy8gZ2V0dGVyIGZvciBvYmplY3QgcHJvcGVydGllcwogICAgICAgIGRlc2NyaXB0b3IuZ2V0ID0gKGRlc2NyaXB0b3IuZ2V0IHx8IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W3Byb3BdOwogICAgICAgIH0pOwogICAgICAgIHJldHVybiBkZXNjcmlwdG9yOwogICAgfQoKICAgIC8qKgogICAgICogV3JhcHBlciBmb3IgdGhlIG1ldGhvZHMgJ2FkZEV2ZW50TGlzdGVuZXIvYXR0YWNoRXZlbnQnIGluIHRoZSBjb250ZXh0IG9mIHRoZSAnd2luZG93JwogICAgICoKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBldmVudCBUaGUgZXZlbnQgdHlwZSBmb3Igd2hpY2ggdGhlIHVzZXIgaXMgcmVnaXN0ZXJpbmcKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIFRoZSBtZXRob2QgdG8gYmUgY2FsbGVkIHdoZW4gdGhlIGV2ZW50IG9jY3Vycy4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gY2FwdHVyZSBJZiB0cnVlLCBjYXB0dXJlIGluZGljYXRlcyB0aGF0IHRoZSB1c2VyIHdpc2hlcyB0byBpbml0aWF0ZSBjYXB0dXJlLgogICAgICogQHJldHVybiB2b2lkCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyLCBjYXB0dXJlKSB7CiAgICAgICAgaWYgKGV2ZW50IGluIGV2ZW50c0xpc3QpIHsKICAgICAgICAgICAgLy8gaGVyZSBzdG9yZWQgdGhlIGV2ZW50IGxpc3RlbmVycyAncG9wc3RhdGUvaGFzaGNoYW5nZScKICAgICAgICAgICAgZXZlbnRzTGlzdFtldmVudF0ucHVzaChsaXN0ZW5lcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRmlyZUZveCBzdXBwb3J0IG5vbi1zdGFuZGFydCBmb3VyIGFyZ3VtZW50IGFXYW50c1VudHJ1c3RlZAogICAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vZGV2b3RlL0hUTUw1LUhpc3RvcnktQVBJL2lzc3Vlcy8xMwogICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDMpIHsKICAgICAgICAgICAgICAgIGFkZEV2ZW50KGV2ZW50LCBsaXN0ZW5lciwgY2FwdHVyZSwgYXJndW1lbnRzWzNdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFkZEV2ZW50KGV2ZW50LCBsaXN0ZW5lciwgY2FwdHVyZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBXcmFwcGVyIGZvciB0aGUgbWV0aG9kcyAncmVtb3ZlRXZlbnRMaXN0ZW5lci9kZXRhY2hFdmVudCcgaW4gdGhlIGNvbnRleHQgb2YgdGhlICd3aW5kb3cnCiAgICAgKgogICAgICogQHBhcmFtIHtTdHJpbmd9IGV2ZW50IFRoZSBldmVudCB0eXBlIGZvciB3aGljaCB0aGUgdXNlciBpcyByZWdpc3RlcmVkCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciBUaGUgcGFyYW1ldGVyIGluZGljYXRlcyB0aGUgTGlzdGVuZXIgdG8gYmUgcmVtb3ZlZC4KICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gY2FwdHVyZSBXYXMgcmVnaXN0ZXJlZCBhcyBhIGNhcHR1cmluZyBsaXN0ZW5lciBvciBub3QuCiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXIsIGNhcHR1cmUpIHsKICAgICAgICB2YXIgbGlzdCA9IGV2ZW50c0xpc3RbZXZlbnRdOwogICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIGZvcih2YXIgaSA9IGxpc3QubGVuZ3RoOyAtLWk7KSB7CiAgICAgICAgICAgICAgICBpZiAobGlzdFtpXSA9PT0gbGlzdGVuZXIpIHsKICAgICAgICAgICAgICAgICAgICBsaXN0LnNwbGljZShpLCAxKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbW92ZUV2ZW50KGV2ZW50LCBsaXN0ZW5lciwgY2FwdHVyZSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogV3JhcHBlciBmb3IgdGhlIG1ldGhvZHMgJ2Rpc3BhdGNoRXZlbnQvZmlyZUV2ZW50JyBpbiB0aGUgY29udGV4dCBvZiB0aGUgJ3dpbmRvdycKICAgICAqCiAgICAgKiBAcGFyYW0ge0V2ZW50fFN0cmluZ30gZXZlbnQgSW5zdGFuY2Ugb2YgRXZlbnQgb3IgZXZlbnQgdHlwZSBzdHJpbmcgaWYgJ2V2ZW50T2JqZWN0JyB1c2VkCiAgICAgKiBAcGFyYW0geyp9IFtldmVudE9iamVjdF0gRm9yIEludGVybmV0IEV4cGxvcmVyIDggcmVxdWlyZWQgZXZlbnQgb2JqZWN0IG9uIHRoaXMgYXJndW1lbnQKICAgICAqIEByZXR1cm4ge0Jvb2xlYW59IElmICdwcmV2ZW50RGVmYXVsdCcgd2FzIGNhbGxlZCB0aGUgdmFsdWUgaXMgZmFsc2UsIGVsc2UgdGhlIHZhbHVlIGlzIHRydWUuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnQoZXZlbnQsIGV2ZW50T2JqZWN0KSB7CiAgICAgICAgdmFyIGV2ZW50VHlwZSA9ICgnJyArICh0eXBlb2YgZXZlbnQgPT09ICJzdHJpbmciID8gZXZlbnQgOiBldmVudC50eXBlKSkucmVwbGFjZSgvXm9uLywgJycpOwogICAgICAgIHZhciBsaXN0ID0gZXZlbnRzTGlzdFtldmVudFR5cGVdOwogICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIC8vIG5lZWQgdG8gdW5kZXJzdGFuZCB0aGF0IHRoZXJlIGlzIG9uZSBvYmplY3Qgb2YgRXZlbnQKICAgICAgICAgICAgZXZlbnRPYmplY3QgPSB0eXBlb2YgZXZlbnQgPT09ICJzdHJpbmciID8gZXZlbnRPYmplY3QgOiBldmVudDsKICAgICAgICAgICAgaWYgKGV2ZW50T2JqZWN0LnRhcmdldCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBuZWVkIHRvIG92ZXJyaWRlIHNvbWUgb2YgdGhlIHByb3BlcnRpZXMgb2YgdGhlIEV2ZW50IG9iamVjdAogICAgICAgICAgICAgICAgZm9yKHZhciBwcm9wcyA9IFsndGFyZ2V0JywgJ2N1cnJlbnRUYXJnZXQnLCAnc3JjRWxlbWVudCcsICd0eXBlJ107IGV2ZW50ID0gcHJvcHMucG9wKCk7KSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdXNlICdyZWRlZmluZVByb3BlcnR5JyB0byBvdmVycmlkZSB0aGUgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIGV2ZW50T2JqZWN0ID0gcmVkZWZpbmVQcm9wZXJ0eShldmVudE9iamVjdCwgZXZlbnQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgZ2V0OiBldmVudCA9PT0gJ3R5cGUnID8gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZlbnRUeXBlOwogICAgICAgICAgICAgICAgICAgICAgICB9IDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcnVuIGZ1bmN0aW9uIGRlZmluZWQgaW4gdGhlIGF0dHJpYnV0ZXMgJ29ucG9wc3RhdGUvb25oYXNoY2hhbmdlJyBpbiB0aGUgJ3dpbmRvdycgY29udGV4dAogICAgICAgICAgICAoKGV2ZW50VHlwZSA9PT0gJ3BvcHN0YXRlJyA/IHdpbmRvdy5vbnBvcHN0YXRlIDogd2luZG93Lm9uaGFzaGNoYW5nZSkKICAgICAgICAgICAgICAgIHx8IGVtcHR5RnVuY3Rpb24pLmNhbGwod2luZG93LCBldmVudE9iamVjdCk7CiAgICAgICAgICAgIC8vIHJ1biBvdGhlciBmdW5jdGlvbnMgdGhhdCBhcmUgaW4gdGhlIGxpc3Qgb2YgaGFuZGxlcnMKICAgICAgICAgICAgZm9yKHZhciBpID0gMCwgbGVuID0gbGlzdC5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgbGlzdFtpXS5jYWxsKHdpbmRvdywgZXZlbnRPYmplY3QpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaChldmVudCwgZXZlbnRPYmplY3QpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIGRpc3BhdGNoIGN1cnJlbnQgc3RhdGUgZXZlbnQKICAgICAqLwogICAgZnVuY3Rpb24gZmlyZVBvcFN0YXRlKCkgewogICAgICAgIHZhciBvID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQgPyBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKSA6IGRvY3VtZW50LmNyZWF0ZUV2ZW50T2JqZWN0KCk7CiAgICAgICAgaWYgKG8uaW5pdEV2ZW50KSB7CiAgICAgICAgICAgIG8uaW5pdEV2ZW50KCdwb3BzdGF0ZScsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgby50eXBlID0gJ3BvcHN0YXRlJzsKICAgICAgICB9CiAgICAgICAgby5zdGF0ZSA9IGhpc3RvcnlPYmplY3Quc3RhdGU7CiAgICAgICAgLy8gc2VuZCBhIG5ld2x5IGNyZWF0ZWQgZXZlbnRzIHRvIGJlIHByb2Nlc3NlZAogICAgICAgIGRpc3BhdGNoRXZlbnQobyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBmaXJlIGluaXRpYWwgc3RhdGUgZm9yIG5vbi1IVE1MNSBicm93c2VycwogICAgICovCiAgICBmdW5jdGlvbiBmaXJlSW5pdGlhbFN0YXRlKCkgewogICAgICAgIGlmIChpc0ZpcmVJbml0aWFsU3RhdGUpIHsKICAgICAgICAgICAgaXNGaXJlSW5pdGlhbFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgIGZpcmVQb3BTdGF0ZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENoYW5nZSB0aGUgZGF0YSBvZiB0aGUgY3VycmVudCBoaXN0b3J5IGZvciBIVE1MNCBicm93c2VycwogICAgICoKICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IFt1cmxdCiAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtyZXBsYWNlXQogICAgICogQHBhcmFtIHtzdHJpbmd9IFtsYXN0VVJMVmFsdWVdCiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gY2hhbmdlU3RhdGUoc3RhdGUsIHVybCwgcmVwbGFjZSwgbGFzdFVSTFZhbHVlKSB7CiAgICAgICAgaWYgKCFpc1N1cHBvcnRIaXN0b3J5QVBJKSB7CiAgICAgICAgICAgIC8vIG5vcm1hbGl6YXRpb24gdXJsCiAgICAgICAgICAgIHZhciB1cmxPYmplY3QgPSBwYXJzZVVSTCh1cmwpOwogICAgICAgICAgICAvLyBpZiBjdXJyZW50IHVybCBub3QgZXF1YWwgbmV3IHVybAogICAgICAgICAgICBpZiAodXJsT2JqZWN0Ll9yZWxhdGl2ZSAhPT0gcGFyc2VVUkwoKS5fcmVsYXRpdmUpIHsKICAgICAgICAgICAgICAgIC8vIGlmIGVtcHR5IGxhc3RVUkxWYWx1ZSB0byBza2lwIGhhc2ggY2hhbmdlIGV2ZW50CiAgICAgICAgICAgICAgICBsYXN0VVJMID0gbGFzdFVSTFZhbHVlOwogICAgICAgICAgICAgICAgaWYgKHJlcGxhY2UpIHsKICAgICAgICAgICAgICAgICAgICAvLyBvbmx5IHJlcGxhY2UgaGFzaCwgbm90IHN0b3JlIHRvIGhpc3RvcnkKICAgICAgICAgICAgICAgICAgICB3aW5kb3dMb2NhdGlvbi5yZXBsYWNlKCIjIiArIHVybE9iamVjdC5fc3BlY2lhbCk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIGNoYW5nZSBoYXNoIGFuZCBhZGQgbmV3IHJlY29yZCB0byBoaXN0b3J5CiAgICAgICAgICAgICAgICAgICAgd2luZG93TG9jYXRpb24uaGFzaCA9IHVybE9iamVjdC5fc3BlY2lhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWlzU3VwcG9ydFN0YXRlT2JqZWN0SW5IaXN0b3J5ICYmIHN0YXRlKSB7CiAgICAgICAgICAgIHN0YXRlU3RvcmFnZVt3aW5kb3dMb2NhdGlvbi5ocmVmXSA9IHN0YXRlOwogICAgICAgIH0KICAgICAgICBpc0ZpcmVJbml0aWFsU3RhdGUgPSBmYWxzZTsKICAgIH0KCiAgICAvKioKICAgICAqIEV2ZW50IGhhbmRsZXIgZnVuY3Rpb24gY2hhbmdlcyB0aGUgaGFzaCBpbiB0aGUgYWRkcmVzcyBiYXIKICAgICAqCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudAogICAgICogQHJldHVybiB2b2lkCiAgICAgKi8KICAgIGZ1bmN0aW9uIG9uSGFzaENoYW5nZShldmVudCkgewogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9kZXZvdGUvSFRNTDUtSGlzdG9yeS1BUEkvaXNzdWVzLzQ2CiAgICAgICAgdmFyIGZpcmVOb3cgPSBsYXN0VVJMOwogICAgICAgIC8vIG5ldyB2YWx1ZSB0byBsYXN0VVJMCiAgICAgICAgbGFzdFVSTCA9IHdpbmRvd0xvY2F0aW9uLmhyZWY7CiAgICAgICAgLy8gaWYgbm90IGVtcHR5IGZpcmVOb3csIG90aGVyd2lzZSBza2lwcGVkIHRoZSBjdXJyZW50IGhhbmRsZXIgZXZlbnQKICAgICAgICBpZiAoZmlyZU5vdykgewogICAgICAgICAgICAvLyBpZiBjaGVja1VybEZvclBvcFN0YXRlIGVxdWFsIGN1cnJlbnQgdXJsLCB0aGlzIG1lYW5zIHRoYXQgdGhlIGV2ZW50IHdhcyByYWlzZWQgcG9wc3RhdGUgYnJvd3NlcgogICAgICAgICAgICBpZiAoY2hlY2tVcmxGb3JQb3BTdGF0ZSAhPT0gd2luZG93TG9jYXRpb24uaHJlZikgewogICAgICAgICAgICAgICAgLy8gb3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgLy8gdGhlIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBwb3BzdGF0ZSBldmVudCBvciBqdXN0IGRvZXMgbm90IHJ1biB0aGUgZXZlbnQgYnkgY2hhbmdpbmcgdGhlIGhhc2guCiAgICAgICAgICAgICAgICBmaXJlUG9wU3RhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBjdXJyZW50IGV2ZW50IG9iamVjdAogICAgICAgICAgICBldmVudCA9IGV2ZW50IHx8IHdpbmRvdy5ldmVudDsKCiAgICAgICAgICAgIHZhciBvbGRVUkxPYmplY3QgPSBwYXJzZVVSTChsYXN0VVJMLCB0cnVlKTsKICAgICAgICAgICAgdmFyIG5ld1VSTE9iamVjdCA9IHBhcnNlVVJMKCk7CiAgICAgICAgICAgIC8vIEhUTUw0IGJyb3dzZXIgbm90IHN1cHBvcnQgcHJvcGVydGllcyBvbGRVUkwvbmV3VVJMCiAgICAgICAgICAgIGlmICghZXZlbnQub2xkVVJMKSB7CiAgICAgICAgICAgICAgICBldmVudC5vbGRVUkwgPSBvbGRVUkxPYmplY3QuX2hyZWY7CiAgICAgICAgICAgICAgICBldmVudC5uZXdVUkwgPSBuZXdVUkxPYmplY3QuX2hyZWY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZFVSTE9iamVjdC5faGFzaCAhPT0gbmV3VVJMT2JqZWN0Ll9oYXNoKSB7CiAgICAgICAgICAgICAgICAvLyBpZiBjdXJyZW50IGhhc2ggbm90IGVxdWFsIHByZXZpb3VzIGhhc2gKICAgICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogVGhlIGV2ZW50IGhhbmRsZXIgaXMgZnVsbHkgbG9hZGVkIGRvY3VtZW50CiAgICAgKgogICAgICogQHBhcmFtIHsqfSBbbm9TY3JvbGxdCiAgICAgKiBAcmV0dXJuIHZvaWQKICAgICAqLwogICAgZnVuY3Rpb24gb25Mb2FkKG5vU2Nyb2xsKSB7CiAgICAgICAgLy8gR2V0IHJpZCBvZiB0aGUgZXZlbnRzIHBvcHN0YXRlIHdoZW4gdGhlIGZpcnN0IGxvYWRpbmcgYSBkb2N1bWVudCBpbiB0aGUgd2Via2l0IGJyb3dzZXJzCiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gaGFuZyB1cCB0aGUgZXZlbnQgaGFuZGxlciBmb3IgdGhlIGJ1aWx0LWluIHBvcHN0YXRlIGV2ZW50IGluIHRoZSBicm93c2VyCiAgICAgICAgICAgIGFkZEV2ZW50KCdwb3BzdGF0ZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgICAgICAgICAgIC8vIHNldCB0aGUgY3VycmVudCB1cmwsIHRoYXQgc3VwcHJlc3MgdGhlIGNyZWF0aW9uIG9mIHRoZSBwb3BzdGF0ZSBldmVudCBieSBjaGFuZ2luZyB0aGUgaGFzaAogICAgICAgICAgICAgICAgY2hlY2tVcmxGb3JQb3BTdGF0ZSA9IHdpbmRvd0xvY2F0aW9uLmhyZWY7CiAgICAgICAgICAgICAgICAvLyBmb3IgU2FmYXJpIGJyb3dzZXIgaW4gT1MgV2luZG93cyBub3QgaW1wbGVtZW50ZWQgJ3N0YXRlJyBvYmplY3QgaW4gJ0hpc3RvcnknIGludGVyZmFjZQogICAgICAgICAgICAgICAgLy8gYW5kIG5vdCBpbXBsZW1lbnRlZCBpbiBvbGQgSFRNTDQgYnJvd3NlcnMKICAgICAgICAgICAgICAgIGlmICghaXNTdXBwb3J0U3RhdGVPYmplY3RJbkhpc3RvcnkpIHsKICAgICAgICAgICAgICAgICAgICBlID0gcmVkZWZpbmVQcm9wZXJ0eShlLCAnc3RhdGUnLCB7Z2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhpc3RvcnlPYmplY3Quc3RhdGU7CiAgICAgICAgICAgICAgICAgICAgfX0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gc2VuZCBldmVudHMgdG8gYmUgcHJvY2Vzc2VkCiAgICAgICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGUpOwogICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgfSwgMCk7CiAgICAgICAgLy8gZm9yIG5vbi1IVE1MNSBicm93c2VycwogICAgICAgIGlmICghaXNTdXBwb3J0SGlzdG9yeUFQSSAmJiBub1Njcm9sbCAhPT0gdHJ1ZSAmJiBoaXN0b3J5T2JqZWN0LmxvY2F0aW9uKSB7CiAgICAgICAgICAgIC8vIHNjcm9sbCB3aW5kb3cgdG8gYW5jaG9yIGVsZW1lbnQKICAgICAgICAgICAgc2Nyb2xsVG9BbmNob3JJZChoaXN0b3J5T2JqZWN0LmxvY2F0aW9uLmhhc2gpOwogICAgICAgICAgICAvLyBmaXJlIGluaXRpYWwgc3RhdGUgZm9yIG5vbi1IVE1MNSBicm93c2VyIGFmdGVyIGxvYWQgcGFnZQogICAgICAgICAgICBmaXJlSW5pdGlhbFN0YXRlKCk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRmluZHMgdGhlIGNsb3Nlc3QgYW5jZXN0b3IgYW5jaG9yIGVsZW1lbnQgKGluY2x1ZGluZyB0aGUgdGFyZ2V0IGl0c2VsZikuCiAgICAgKgogICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gdGFyZ2V0IFRoZSBlbGVtZW50IHRvIHN0YXJ0IHNjYW5uaW5nIGZyb20uCiAgICAgKiBAcmV0dXJuIHtIVE1MRWxlbWVudH0gQW4gZWxlbWVudCB3aGljaCBpcyB0aGUgY2xvc2VzdCBhbmNlc3RvciBhbmNob3IuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGFuY2hvclRhcmdldCh0YXJnZXQpIHsKICAgICAgICB3aGlsZSAodGFyZ2V0KSB7CiAgICAgICAgICAgIGlmICh0YXJnZXQubm9kZU5hbWUgPT09ICdBJykgcmV0dXJuIHRhcmdldDsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogSGFuZGxlcyBhbmNob3IgZWxlbWVudHMgd2l0aCBhIGhhc2ggZnJhZ21lbnQgZm9yIG5vbi1IVE1MNSBicm93c2VycwogICAgICoKICAgICAqIEBwYXJhbSB7RXZlbnR9IGUKICAgICAqLwogICAgZnVuY3Rpb24gb25BbmNob3JDbGljayhlKSB7CiAgICAgICAgdmFyIGV2ZW50ID0gZSB8fCB3aW5kb3cuZXZlbnQ7CiAgICAgICAgdmFyIHRhcmdldCA9IGFuY2hvclRhcmdldChldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudCk7CiAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSAiZGVmYXVsdFByZXZlbnRlZCIgaW4gZXZlbnQgPyBldmVudFsnZGVmYXVsdFByZXZlbnRlZCddIDogZXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0Lm5vZGVOYW1lID09PSAiQSIgJiYgIWRlZmF1bHRQcmV2ZW50ZWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBwYXJzZVVSTCgpOwogICAgICAgICAgICB2YXIgZXhwZWN0ID0gcGFyc2VVUkwodGFyZ2V0LmdldEF0dHJpYnV0ZSgiaHJlZiIsIDIpKTsKICAgICAgICAgICAgdmFyIGlzRXF1YWxCYXNlVVJMID0gY3VycmVudC5faHJlZi5zcGxpdCgnIycpLnNoaWZ0KCkgPT09IGV4cGVjdC5faHJlZi5zcGxpdCgnIycpLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmIChpc0VxdWFsQmFzZVVSTCAmJiBleHBlY3QuX2hhc2gpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Ll9oYXNoICE9PSBleHBlY3QuX2hhc2gpIHsKICAgICAgICAgICAgICAgICAgICBoaXN0b3J5T2JqZWN0LmxvY2F0aW9uLmhhc2ggPSBleHBlY3QuX2hhc2g7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzY3JvbGxUb0FuY2hvcklkKGV4cGVjdC5faGFzaCk7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU2Nyb2xsIHBhZ2UgdG8gY3VycmVudCBhbmNob3IgaW4gdXJsLWhhc2gKICAgICAqCiAgICAgKiBAcGFyYW0gaGFzaAogICAgICovCiAgICBmdW5jdGlvbiBzY3JvbGxUb0FuY2hvcklkKGhhc2gpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFzaCA9IChoYXNoIHx8ICcnKS5yZXBsYWNlKC9eIy8sICcnKSk7CiAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuaWQgPT09IGhhc2ggJiYgdGFyZ2V0Lm5vZGVOYW1lID09PSAiQSIpIHsKICAgICAgICAgICAgdmFyIHJlY3QgPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygoZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQgfHwgMCksIHJlY3QudG9wICsgKGRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3AgfHwgMCkKICAgICAgICAgICAgICAgIC0gKGRvY3VtZW50RWxlbWVudC5jbGllbnRUb3AgfHwgMCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIExpYnJhcnkgaW5pdGlhbGl6YXRpb24KICAgICAqCiAgICAgKiBAcmV0dXJuIHtCb29sZWFufSByZXR1cm4gdHJ1ZSBpZiBhbGwgaXMgd2VsbCwgb3RoZXJ3aXNlIHJldHVybiBmYWxzZSB2YWx1ZQogICAgICovCiAgICBmdW5jdGlvbiBpbml0aWFsaXplKCkgewogICAgICAgIC8qKgogICAgICAgICAqIEdldCBjdXN0b20gc2V0dGluZ3MgZnJvbSB0aGUgcXVlcnkgc3RyaW5nCiAgICAgICAgICovCiAgICAgICAgdmFyIHNjcmlwdHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0Jyk7CiAgICAgICAgdmFyIHNyYyA9IChzY3JpcHRzW3NjcmlwdHMubGVuZ3RoIC0gMV0gfHwge30pLnNyYyB8fCAnJzsKICAgICAgICB2YXIgYXJnID0gc3JjLmluZGV4T2YoJz8nKSAhPT0gLTEgPyBzcmMuc3BsaXQoJz8nKS5wb3AoKSA6ICcnOwogICAgICAgIGFyZy5yZXBsYWNlKC8oXHcrKSg/Oj0oW14mXSopKT8vZywgZnVuY3Rpb24oYSwga2V5LCB2YWx1ZSkgewogICAgICAgICAgICBzZXR0aW5nc1trZXldID0gKHZhbHVlIHx8IChrZXkgPT09ICdiYXNlcGF0aCcgPyAnLycgOiAnJykpLnJlcGxhY2UoL14oMHxmYWxzZSkkLywgJycpOwogICAgICAgIH0pOwoKICAgICAgICAvKioKICAgICAgICAgKiBoYW5nIHVwIHRoZSBldmVudCBoYW5kbGVyIHRvIGxpc3RlbiB0byB0aGUgZXZlbnRzIGhhc2hjaGFuZ2UKICAgICAgICAgKi8KICAgICAgICBhZGRFdmVudChldmVudE5hbWVQcmVmaXggKyAnaGFzaGNoYW5nZScsIG9uSGFzaENoYW5nZSwgZmFsc2UpOwoKICAgICAgICAvLyBhIGxpc3Qgb2Ygb2JqZWN0cyB3aXRoIHBhaXJzIG9mIGRlc2NyaXB0b3JzL29iamVjdAogICAgICAgIHZhciBkYXRhID0gW2xvY2F0aW9uRGVzY3JpcHRvcnMsIGxvY2F0aW9uT2JqZWN0LCBldmVudHNEZXNjcmlwdG9ycywgd2luZG93LCBoaXN0b3J5RGVzY3JpcHRvcnMsIGhpc3RvcnlPYmplY3RdOwoKICAgICAgICAvLyBpZiBicm93c2VyIHN1cHBvcnQgb2JqZWN0ICdzdGF0ZScgaW4gaW50ZXJmYWNlICdIaXN0b3J5JwogICAgICAgIGlmIChpc1N1cHBvcnRTdGF0ZU9iamVjdEluSGlzdG9yeSkgewogICAgICAgICAgICAvLyByZW1vdmUgc3RhdGUgcHJvcGVydHkgZnJvbSBkZXNjcmlwdG9yCiAgICAgICAgICAgIGRlbGV0ZSBoaXN0b3J5RGVzY3JpcHRvcnNbJ3N0YXRlJ107CiAgICAgICAgfQoKICAgICAgICAvLyBpbml0aWFsaXppbmcgZGVzY3JpcHRvcnMKICAgICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBmb3IodmFyIHByb3AgaW4gZGF0YVtpXSkgewogICAgICAgICAgICAgICAgaWYgKGRhdGFbaV0uaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGFbaV1bcHJvcF0gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIGRlc2NyaXB0b3IgaXMgYSBzaW1wbGUgZnVuY3Rpb24sIHNpbXBseSBqdXN0IGFzc2lnbiBpdCBhbiBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVtpICsgMV1bcHJvcF0gPSBkYXRhW2ldW3Byb3BdOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByZXBhcmUgdGhlIGRlc2NyaXB0b3IgdGhlIHJlcXVpcmVkIGZvcm1hdAogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGVzY3JpcHRvciA9IHByZXBhcmVEZXNjcmlwdG9yc0Zvck9iamVjdChkYXRhW2ldLCBwcm9wLCBkYXRhW2ldW3Byb3BdKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gdHJ5IHRvIHNldCB0aGUgZGVzY3JpcHRvciBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZWRlZmluZVByb3BlcnR5KGRhdGFbaSArIDFdLCBwcm9wLCBkZXNjcmlwdG9yLCBmdW5jdGlvbihuLCBvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpcyBzYXRpc2ZpZWQgaWYgdGhlIGZhaWxlZCBvdmVycmlkZSBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG8gPT09IGhpc3RvcnlPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgcHJvYmxlbSBvY2N1cnMgaW4gU2FmYXJpIG9uIHRoZSBNYWMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cuaGlzdG9yeSA9IGhpc3RvcnlPYmplY3QgPSBkYXRhW2kgKyAxXSA9IG47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB0aGVyZSBpcyBubyBwb3NzaWJpbGl0eSBvdmVycmlkZS4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IGRlc2NyaXB0b3JzLCBzdWNoIGFzIElFNwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBwcmV2aW91c2x5IGh1bmcgZXZlbnQgaGFuZGxlcnMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUV2ZW50KGV2ZW50TmFtZVByZWZpeCArICdoYXNoY2hhbmdlJywgb25IYXNoQ2hhbmdlLCBmYWxzZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmFpbCB0byBpbml0aWFsaXplIDooCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNyZWF0ZSBhIHJlcG9zaXRvcnkgZm9yIGN1c3RvbSBoYW5kbGVycyBvbnBvcHN0YXRlL29uaGFzaGNoYW5nZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YVtpICsgMV0gPT09IHdpbmRvdykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRzTGlzdFtwcm9wXSA9IGV2ZW50c0xpc3RbcHJvcC5zdWJzdHIoMildID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHJlZGlyZWN0IGlmIG5lY2Vzc2FyeQogICAgICAgIGlmIChzZXR0aW5nc1sncmVkaXJlY3QnXSkgewogICAgICAgICAgICBoaXN0b3J5T2JqZWN0WydyZWRpcmVjdCddKCk7CiAgICAgICAgfQoKICAgICAgICAvLyBJZiBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgb2JqZWN0ICdzdGF0ZScgaW4gaW50ZXJmYWNlICdIaXN0b3J5JwogICAgICAgIGlmICghaXNTdXBwb3J0U3RhdGVPYmplY3RJbkhpc3RvcnkgJiYgSlNPTikgewogICAgICAgICAgICBzdG9yYWdlSW5pdGlhbGl6ZSgpOwogICAgICAgIH0KCiAgICAgICAgLy8gdHJhY2sgY2xpY2tzIG9uIGFuY2hvcnMKICAgICAgICBpZiAoIWlzU3VwcG9ydEhpc3RvcnlBUEkpIHsKICAgICAgICAgICAgZG9jdW1lbnRbYWRkRXZlbnRMaXN0ZW5lck5hbWVdKGV2ZW50TmFtZVByZWZpeCArICJjbGljayIsIG9uQW5jaG9yQ2xpY2ssIGZhbHNlKTsKICAgICAgICB9CgogICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7CiAgICAgICAgICAgIG9uTG9hZCh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoIWlzU3VwcG9ydEhpc3RvcnlBUEkgJiYgcGFyc2VVUkwoKS5fcmVsYXRpdmUgIT09IHNldHRpbmdzWyJiYXNlcGF0aCJdKSB7CiAgICAgICAgICAgICAgICBpc0ZpcmVJbml0aWFsU3RhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBOZWVkIHRvIGF2b2lkIHRyaWdnZXJpbmcgZXZlbnRzIHBvcHN0YXRlIHRoZSBpbml0aWFsIHBhZ2UgbG9hZC4KICAgICAgICAgICAgICogSGFuZyBoYW5kbGVyIHBvcHN0YXRlIGFzIHdpbGwgYmUgZnVsbHkgbG9hZGVkIGRvY3VtZW50IHRoYXQKICAgICAgICAgICAgICogd291bGQgcHJldmVudCB0cmlnZ2VyaW5nIGV2ZW50IG9ucG9wc3RhdGUKICAgICAgICAgICAgICovCiAgICAgICAgICAgIGFkZEV2ZW50KGV2ZW50TmFtZVByZWZpeCArICdsb2FkJywgb25Mb2FkLCBmYWxzZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBldmVyeXRoaW5nIHdlbnQgd2VsbAogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogU3RhcnRpbmcgdGhlIGxpYnJhcnkKICAgICAqLwogICAgaWYgKCFpbml0aWFsaXplKCkpIHsKICAgICAgICAvLyBpZiB1bmFibGUgdG8gaW5pdGlhbGl6ZSBkZXNjcmlwdG9ycwogICAgICAgIC8vIHRoZXJlZm9yZSBxdWl0ZSBvbGQgYnJvd3NlciBhbmQgdGhlcmUKICAgICAgICAvLyBpcyBubyBzZW5zZSB0byBjb250aW51ZSB0byBwZXJmb3JtCiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8qKgogICAgICogSWYgdGhlIHByb3BlcnR5IGhpc3RvcnkuZW11bGF0ZSB3aWxsIGJlIHRydWUsCiAgICAgKiB0aGlzIHdpbGwgYmUgdGFsa2luZyBhYm91dCB3aGF0J3MgZ29pbmcgb24KICAgICAqIGVtdWxhdGlvbiBjYXBhYmlsaXRpZXMgSFRNTDUtSGlzdG9yeS1BUEkuCiAgICAgKiBPdGhlcndpc2UgdGhlcmUgaXMgbm8gZW11bGF0aW9uLCBpZSB0aGUKICAgICAqIGJ1aWx0LWluIGJyb3dzZXIgY2FwYWJpbGl0aWVzLgogICAgICoKICAgICAqIEB0eXBlIHtib29sZWFufQogICAgICogQGNvbnN0CiAgICAgKi8KICAgIGhpc3RvcnlPYmplY3RbJ2VtdWxhdGUnXSA9ICFpc1N1cHBvcnRIaXN0b3J5QVBJOwoKICAgIC8qKgogICAgICogUmVwbGFjZSB0aGUgb3JpZ2luYWwgbWV0aG9kcyBvbiB0aGUgd3JhcHBlcgogICAgICovCiAgICB3aW5kb3dbYWRkRXZlbnRMaXN0ZW5lck5hbWVdID0gYWRkRXZlbnRMaXN0ZW5lcjsKICAgIHdpbmRvd1tyZW1vdmVFdmVudExpc3RlbmVyTmFtZV0gPSByZW1vdmVFdmVudExpc3RlbmVyOwogICAgd2luZG93W2Rpc3BhdGNoRXZlbnROYW1lXSA9IGRpc3BhdGNoRXZlbnQ7Cgp9KSh3aW5kb3cpOwovKioKICogQ29weXJpZ2h0IChjKSAyMDExLTIwMTQgRmVsaXggR25hc3MKICogTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlCiAqLwooZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewoKICAvKiBDb21tb25KUyAqLwogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JykgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpCgogIC8qIEFNRCBtb2R1bGUgKi8KICBlbHNlIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKGZhY3RvcnkpCgogIC8qIEJyb3dzZXIgZ2xvYmFsICovCiAgZWxzZSByb290LlNwaW5uZXIgPSBmYWN0b3J5KCkKfQoodGhpcywgZnVuY3Rpb24oKSB7CiAgInVzZSBzdHJpY3QiOwoKICB2YXIgcHJlZml4ZXMgPSBbJ3dlYmtpdCcsICdNb3onLCAnbXMnLCAnTyddIC8qIFZlbmRvciBwcmVmaXhlcyAqLwogICAgLCBhbmltYXRpb25zID0ge30gLyogQW5pbWF0aW9uIHJ1bGVzIGtleWVkIGJ5IHRoZWlyIG5hbWUgKi8KICAgICwgdXNlQ3NzQW5pbWF0aW9ucyAvKiBXaGV0aGVyIHRvIHVzZSBDU1MgYW5pbWF0aW9ucyBvciBzZXRUaW1lb3V0ICovCgogIC8qKgogICAqIFV0aWxpdHkgZnVuY3Rpb24gdG8gY3JlYXRlIGVsZW1lbnRzLiBJZiBubyB0YWcgbmFtZSBpcyBnaXZlbiwKICAgKiBhIERJViBpcyBjcmVhdGVkLiBPcHRpb25hbGx5IHByb3BlcnRpZXMgY2FuIGJlIHBhc3NlZC4KICAgKi8KICBmdW5jdGlvbiBjcmVhdGVFbCh0YWcsIHByb3ApIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnIHx8ICdkaXYnKQogICAgICAsIG4KCiAgICBmb3IobiBpbiBwcm9wKSBlbFtuXSA9IHByb3Bbbl0KICAgIHJldHVybiBlbAogIH0KCiAgLyoqCiAgICogQXBwZW5kcyBjaGlsZHJlbiBhbmQgcmV0dXJucyB0aGUgcGFyZW50LgogICAqLwogIGZ1bmN0aW9uIGlucyhwYXJlbnQgLyogY2hpbGQxLCBjaGlsZDIsIC4uLiovKSB7CiAgICBmb3IgKHZhciBpPTEsIG49YXJndW1lbnRzLmxlbmd0aDsgaTxuOyBpKyspCiAgICAgIHBhcmVudC5hcHBlbmRDaGlsZChhcmd1bWVudHNbaV0pCgogICAgcmV0dXJuIHBhcmVudAogIH0KCiAgLyoqCiAgICogSW5zZXJ0IGEgbmV3IHN0eWxlc2hlZXQgdG8gaG9sZCB0aGUgQGtleWZyYW1lIG9yIFZNTCBydWxlcy4KICAgKi8KICB2YXIgc2hlZXQgPSAoZnVuY3Rpb24oKSB7CiAgICB2YXIgZWwgPSBjcmVhdGVFbCgnc3R5bGUnLCB7dHlwZSA6ICd0ZXh0L2Nzcyd9KQogICAgaW5zKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF0sIGVsKQogICAgcmV0dXJuIGVsLnNoZWV0IHx8IGVsLnN0eWxlU2hlZXQKICB9KCkpCgogIC8qKgogICAqIENyZWF0ZXMgYW4gb3BhY2l0eSBrZXlmcmFtZSBhbmltYXRpb24gcnVsZSBhbmQgcmV0dXJucyBpdHMgbmFtZS4KICAgKiBTaW5jZSBtb3N0IG1vYmlsZSBXZWJraXRzIGhhdmUgdGltaW5nIGlzc3VlcyB3aXRoIGFuaW1hdGlvbi1kZWxheSwKICAgKiB3ZSBjcmVhdGUgc2VwYXJhdGUgcnVsZXMgZm9yIGVhY2ggbGluZS9zZWdtZW50LgogICAqLwogIGZ1bmN0aW9uIGFkZEFuaW1hdGlvbihhbHBoYSwgdHJhaWwsIGksIGxpbmVzKSB7CiAgICB2YXIgbmFtZSA9IFsnb3BhY2l0eScsIHRyYWlsLCB+fihhbHBoYSoxMDApLCBpLCBsaW5lc10uam9pbignLScpCiAgICAgICwgc3RhcnQgPSAwLjAxICsgaS9saW5lcyAqIDEwMAogICAgICAsIHogPSBNYXRoLm1heCgxIC0gKDEtYWxwaGEpIC8gdHJhaWwgKiAoMTAwLXN0YXJ0KSwgYWxwaGEpCiAgICAgICwgcHJlZml4ID0gdXNlQ3NzQW5pbWF0aW9ucy5zdWJzdHJpbmcoMCwgdXNlQ3NzQW5pbWF0aW9ucy5pbmRleE9mKCdBbmltYXRpb24nKSkudG9Mb3dlckNhc2UoKQogICAgICAsIHByZSA9IHByZWZpeCAmJiAnLScgKyBwcmVmaXggKyAnLScgfHwgJycKCiAgICBpZiAoIWFuaW1hdGlvbnNbbmFtZV0pIHsKICAgICAgc2hlZXQuaW5zZXJ0UnVsZSgKICAgICAgICAnQCcgKyBwcmUgKyAna2V5ZnJhbWVzICcgKyBuYW1lICsgJ3snICsKICAgICAgICAnMCV7b3BhY2l0eTonICsgeiArICd9JyArCiAgICAgICAgc3RhcnQgKyAnJXtvcGFjaXR5OicgKyBhbHBoYSArICd9JyArCiAgICAgICAgKHN0YXJ0KzAuMDEpICsgJyV7b3BhY2l0eToxfScgKwogICAgICAgIChzdGFydCt0cmFpbCkgJSAxMDAgKyAnJXtvcGFjaXR5OicgKyBhbHBoYSArICd9JyArCiAgICAgICAgJzEwMCV7b3BhY2l0eTonICsgeiArICd9JyArCiAgICAgICAgJ30nLCBzaGVldC5jc3NSdWxlcy5sZW5ndGgpCgogICAgICBhbmltYXRpb25zW25hbWVdID0gMQogICAgfQoKICAgIHJldHVybiBuYW1lCiAgfQoKICAvKioKICAgKiBUcmllcyB2YXJpb3VzIHZlbmRvciBwcmVmaXhlcyBhbmQgcmV0dXJucyB0aGUgZmlyc3Qgc3VwcG9ydGVkIHByb3BlcnR5LgogICAqLwogIGZ1bmN0aW9uIHZlbmRvcihlbCwgcHJvcCkgewogICAgdmFyIHMgPSBlbC5zdHlsZQogICAgICAsIHBwCiAgICAgICwgaQoKICAgIHByb3AgPSBwcm9wLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zbGljZSgxKQogICAgZm9yKGk9MDsgaTxwcmVmaXhlcy5sZW5ndGg7IGkrKykgewogICAgICBwcCA9IHByZWZpeGVzW2ldK3Byb3AKICAgICAgaWYoc1twcF0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIHBwCiAgICB9CiAgICBpZihzW3Byb3BdICE9PSB1bmRlZmluZWQpIHJldHVybiBwcm9wCiAgfQoKICAvKioKICAgKiBTZXRzIG11bHRpcGxlIHN0eWxlIHByb3BlcnRpZXMgYXQgb25jZS4KICAgKi8KICBmdW5jdGlvbiBjc3MoZWwsIHByb3ApIHsKICAgIGZvciAodmFyIG4gaW4gcHJvcCkKICAgICAgZWwuc3R5bGVbdmVuZG9yKGVsLCBuKXx8bl0gPSBwcm9wW25dCgogICAgcmV0dXJuIGVsCiAgfQoKICAvKioKICAgKiBGaWxscyBpbiBkZWZhdWx0IHZhbHVlcy4KICAgKi8KICBmdW5jdGlvbiBtZXJnZShvYmopIHsKICAgIGZvciAodmFyIGk9MTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgZGVmID0gYXJndW1lbnRzW2ldCiAgICAgIGZvciAodmFyIG4gaW4gZGVmKQogICAgICAgIGlmIChvYmpbbl0gPT09IHVuZGVmaW5lZCkgb2JqW25dID0gZGVmW25dCiAgICB9CiAgICByZXR1cm4gb2JqCiAgfQoKICAvKioKICAgKiBSZXR1cm5zIHRoZSBhYnNvbHV0ZSBwYWdlLW9mZnNldCBvZiB0aGUgZ2l2ZW4gZWxlbWVudC4KICAgKi8KICBmdW5jdGlvbiBwb3MoZWwpIHsKICAgIHZhciBvID0geyB4OmVsLm9mZnNldExlZnQsIHk6ZWwub2Zmc2V0VG9wIH0KICAgIHdoaWxlKChlbCA9IGVsLm9mZnNldFBhcmVudCkpCiAgICAgIG8ueCs9ZWwub2Zmc2V0TGVmdCwgby55Kz1lbC5vZmZzZXRUb3AKCiAgICByZXR1cm4gbwogIH0KCiAgLyoqCiAgICogUmV0dXJucyB0aGUgbGluZSBjb2xvciBmcm9tIHRoZSBnaXZlbiBzdHJpbmcgb3IgYXJyYXkuCiAgICovCiAgZnVuY3Rpb24gZ2V0Q29sb3IoY29sb3IsIGlkeCkgewogICAgcmV0dXJuIHR5cGVvZiBjb2xvciA9PSAnc3RyaW5nJyA/IGNvbG9yIDogY29sb3JbaWR4ICUgY29sb3IubGVuZ3RoXQogIH0KCiAgLy8gQnVpbHQtaW4gZGVmYXVsdHMKCiAgdmFyIGRlZmF1bHRzID0gewogICAgbGluZXM6IDEyLCAgICAgICAgICAgIC8vIFRoZSBudW1iZXIgb2YgbGluZXMgdG8gZHJhdwogICAgbGVuZ3RoOiA3LCAgICAgICAgICAgIC8vIFRoZSBsZW5ndGggb2YgZWFjaCBsaW5lCiAgICB3aWR0aDogNSwgICAgICAgICAgICAgLy8gVGhlIGxpbmUgdGhpY2tuZXNzCiAgICByYWRpdXM6IDEwLCAgICAgICAgICAgLy8gVGhlIHJhZGl1cyBvZiB0aGUgaW5uZXIgY2lyY2xlCiAgICByb3RhdGU6IDAsICAgICAgICAgICAgLy8gUm90YXRpb24gb2Zmc2V0CiAgICBjb3JuZXJzOiAxLCAgICAgICAgICAgLy8gUm91bmRuZXNzICgwLi4xKQogICAgY29sb3I6ICcjMDAwJywgICAgICAgIC8vICNyZ2Igb3IgI3JyZ2diYgogICAgZGlyZWN0aW9uOiAxLCAgICAgICAgIC8vIDE6IGNsb2Nrd2lzZSwgLTE6IGNvdW50ZXJjbG9ja3dpc2UKICAgIHNwZWVkOiAxLCAgICAgICAgICAgICAvLyBSb3VuZHMgcGVyIHNlY29uZAogICAgdHJhaWw6IDEwMCwgICAgICAgICAgIC8vIEFmdGVyZ2xvdyBwZXJjZW50YWdlCiAgICBvcGFjaXR5OiAxLzQsICAgICAgICAgLy8gT3BhY2l0eSBvZiB0aGUgbGluZXMKICAgIGZwczogMjAsICAgICAgICAgICAgICAvLyBGcmFtZXMgcGVyIHNlY29uZCB3aGVuIHVzaW5nIHNldFRpbWVvdXQoKQogICAgekluZGV4OiAyZTksICAgICAgICAgIC8vIFVzZSBhIGhpZ2ggei1pbmRleCBieSBkZWZhdWx0CiAgICBjbGFzc05hbWU6ICdzcGlubmVyJywgLy8gQ1NTIGNsYXNzIHRvIGFzc2lnbiB0byB0aGUgZWxlbWVudAogICAgdG9wOiAnNTAlJywgICAgICAgICAgIC8vIGNlbnRlciB2ZXJ0aWNhbGx5CiAgICBsZWZ0OiAnNTAlJywgICAgICAgICAgLy8gY2VudGVyIGhvcml6b250YWxseQogICAgcG9zaXRpb246ICdhYnNvbHV0ZScgIC8vIGVsZW1lbnQgcG9zaXRpb24KICB9CgogIC8qKiBUaGUgY29uc3RydWN0b3IgKi8KICBmdW5jdGlvbiBTcGlubmVyKG8pIHsKICAgIHRoaXMub3B0cyA9IG1lcmdlKG8gfHwge30sIFNwaW5uZXIuZGVmYXVsdHMsIGRlZmF1bHRzKQogIH0KCiAgLy8gR2xvYmFsIGRlZmF1bHRzIHRoYXQgb3ZlcnJpZGUgdGhlIGJ1aWx0LWluczoKICBTcGlubmVyLmRlZmF1bHRzID0ge30KCiAgbWVyZ2UoU3Bpbm5lci5wcm90b3R5cGUsIHsKCiAgICAvKioKICAgICAqIEFkZHMgdGhlIHNwaW5uZXIgdG8gdGhlIGdpdmVuIHRhcmdldCBlbGVtZW50LiBJZiB0aGlzIGluc3RhbmNlIGlzIGFscmVhZHkKICAgICAqIHNwaW5uaW5nLCBpdCBpcyBhdXRvbWF0aWNhbGx5IHJlbW92ZWQgZnJvbSBpdHMgcHJldmlvdXMgdGFyZ2V0IGIgY2FsbGluZwogICAgICogc3RvcCgpIGludGVybmFsbHkuCiAgICAgKi8KICAgIHNwaW46IGZ1bmN0aW9uKHRhcmdldCkgewogICAgICB0aGlzLnN0b3AoKQoKICAgICAgdmFyIHNlbGYgPSB0aGlzCiAgICAgICAgLCBvID0gc2VsZi5vcHRzCiAgICAgICAgLCBlbCA9IHNlbGYuZWwgPSBjc3MoY3JlYXRlRWwoMCwge2NsYXNzTmFtZTogby5jbGFzc05hbWV9KSwge3Bvc2l0aW9uOiBvLnBvc2l0aW9uLCB3aWR0aDogMCwgekluZGV4OiBvLnpJbmRleH0pCiAgICAgICAgLCBtaWQgPSBvLnJhZGl1cytvLmxlbmd0aCtvLndpZHRoCgogICAgICBjc3MoZWwsIHsKICAgICAgICBsZWZ0OiBvLmxlZnQsCiAgICAgICAgdG9wOiBvLnRvcAogICAgICB9KQogICAgICAgIAogICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShlbCwgdGFyZ2V0LmZpcnN0Q2hpbGR8fG51bGwpCiAgICAgIH0KCiAgICAgIGVsLnNldEF0dHJpYnV0ZSgncm9sZScsICdwcm9ncmVzc2JhcicpCiAgICAgIHNlbGYubGluZXMoZWwsIHNlbGYub3B0cykKCiAgICAgIGlmICghdXNlQ3NzQW5pbWF0aW9ucykgewogICAgICAgIC8vIE5vIENTUyBhbmltYXRpb24gc3VwcG9ydCwgdXNlIHNldFRpbWVvdXQoKSBpbnN0ZWFkCiAgICAgICAgdmFyIGkgPSAwCiAgICAgICAgICAsIHN0YXJ0ID0gKG8ubGluZXMgLSAxKSAqICgxIC0gby5kaXJlY3Rpb24pIC8gMgogICAgICAgICAgLCBhbHBoYQogICAgICAgICAgLCBmcHMgPSBvLmZwcwogICAgICAgICAgLCBmID0gZnBzL28uc3BlZWQKICAgICAgICAgICwgb3N0ZXAgPSAoMS1vLm9wYWNpdHkpIC8gKGYqby50cmFpbCAvIDEwMCkKICAgICAgICAgICwgYXN0ZXAgPSBmL28ubGluZXMKCiAgICAgICAgOyhmdW5jdGlvbiBhbmltKCkgewogICAgICAgICAgaSsrOwogICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBvLmxpbmVzOyBqKyspIHsKICAgICAgICAgICAgYWxwaGEgPSBNYXRoLm1heCgxIC0gKGkgKyAoby5saW5lcyAtIGopICogYXN0ZXApICUgZiAqIG9zdGVwLCBvLm9wYWNpdHkpCgogICAgICAgICAgICBzZWxmLm9wYWNpdHkoZWwsIGogKiBvLmRpcmVjdGlvbiArIHN0YXJ0LCBhbHBoYSwgbykKICAgICAgICAgIH0KICAgICAgICAgIHNlbGYudGltZW91dCA9IHNlbGYuZWwgJiYgc2V0VGltZW91dChhbmltLCB+figxMDAwL2ZwcykpCiAgICAgICAgfSkoKQogICAgICB9CiAgICAgIHJldHVybiBzZWxmCiAgICB9LAoKICAgIC8qKgogICAgICogU3RvcHMgYW5kIHJlbW92ZXMgdGhlIFNwaW5uZXIuCiAgICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgZWwgPSB0aGlzLmVsCiAgICAgIGlmIChlbCkgewogICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpCiAgICAgICAgaWYgKGVsLnBhcmVudE5vZGUpIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpCiAgICAgICAgdGhpcy5lbCA9IHVuZGVmaW5lZAogICAgICB9CiAgICAgIHJldHVybiB0aGlzCiAgICB9LAoKICAgIC8qKgogICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgZHJhd3MgdGhlIGluZGl2aWR1YWwgbGluZXMuIFdpbGwgYmUgb3ZlcndyaXR0ZW4KICAgICAqIGluIFZNTCBmYWxsYmFjayBtb2RlIGJlbG93LgogICAgICovCiAgICBsaW5lczogZnVuY3Rpb24oZWwsIG8pIHsKICAgICAgdmFyIGkgPSAwCiAgICAgICAgLCBzdGFydCA9IChvLmxpbmVzIC0gMSkgKiAoMSAtIG8uZGlyZWN0aW9uKSAvIDIKICAgICAgICAsIHNlZwoKICAgICAgZnVuY3Rpb24gZmlsbChjb2xvciwgc2hhZG93KSB7CiAgICAgICAgcmV0dXJuIGNzcyhjcmVhdGVFbCgpLCB7CiAgICAgICAgICBwb3NpdGlvbjogJ2Fic29sdXRlJywKICAgICAgICAgIHdpZHRoOiAoby5sZW5ndGgrby53aWR0aCkgKyAncHgnLAogICAgICAgICAgaGVpZ2h0OiBvLndpZHRoICsgJ3B4JywKICAgICAgICAgIGJhY2tncm91bmQ6IGNvbG9yLAogICAgICAgICAgYm94U2hhZG93OiBzaGFkb3csCiAgICAgICAgICB0cmFuc2Zvcm1PcmlnaW46ICdsZWZ0JywKICAgICAgICAgIHRyYW5zZm9ybTogJ3JvdGF0ZSgnICsgfn4oMzYwL28ubGluZXMqaStvLnJvdGF0ZSkgKyAnZGVnKSB0cmFuc2xhdGUoJyArIG8ucmFkaXVzKydweCcgKycsMCknLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiAoby5jb3JuZXJzICogby53aWR0aD4+MSkgKyAncHgnCiAgICAgICAgfSkKICAgICAgfQoKICAgICAgZm9yICg7IGkgPCBvLmxpbmVzOyBpKyspIHsKICAgICAgICBzZWcgPSBjc3MoY3JlYXRlRWwoKSwgewogICAgICAgICAgcG9zaXRpb246ICdhYnNvbHV0ZScsCiAgICAgICAgICB0b3A6IDErfihvLndpZHRoLzIpICsgJ3B4JywKICAgICAgICAgIHRyYW5zZm9ybTogby5od2FjY2VsID8gJ3RyYW5zbGF0ZTNkKDAsMCwwKScgOiAnJywKICAgICAgICAgIG9wYWNpdHk6IG8ub3BhY2l0eSwKICAgICAgICAgIGFuaW1hdGlvbjogdXNlQ3NzQW5pbWF0aW9ucyAmJiBhZGRBbmltYXRpb24oby5vcGFjaXR5LCBvLnRyYWlsLCBzdGFydCArIGkgKiBvLmRpcmVjdGlvbiwgby5saW5lcykgKyAnICcgKyAxL28uc3BlZWQgKyAncyBsaW5lYXIgaW5maW5pdGUnCiAgICAgICAgfSkKCiAgICAgICAgaWYgKG8uc2hhZG93KSBpbnMoc2VnLCBjc3MoZmlsbCgnIzAwMCcsICcwIDAgNHB4ICcgKyAnIzAwMCcpLCB7dG9wOiAyKydweCd9KSkKICAgICAgICBpbnMoZWwsIGlucyhzZWcsIGZpbGwoZ2V0Q29sb3Ioby5jb2xvciwgaSksICcwIDAgMXB4IHJnYmEoMCwwLDAsLjEpJykpKQogICAgICB9CiAgICAgIHJldHVybiBlbAogICAgfSwKCiAgICAvKioKICAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IGFkanVzdHMgdGhlIG9wYWNpdHkgb2YgYSBzaW5nbGUgbGluZS4KICAgICAqIFdpbGwgYmUgb3ZlcndyaXR0ZW4gaW4gVk1MIGZhbGxiYWNrIG1vZGUgYmVsb3cuCiAgICAgKi8KICAgIG9wYWNpdHk6IGZ1bmN0aW9uKGVsLCBpLCB2YWwpIHsKICAgICAgaWYgKGkgPCBlbC5jaGlsZE5vZGVzLmxlbmd0aCkgZWwuY2hpbGROb2Rlc1tpXS5zdHlsZS5vcGFjaXR5ID0gdmFsCiAgICB9CgogIH0pCgoKICBmdW5jdGlvbiBpbml0Vk1MKCkgewoKICAgIC8qIFV0aWxpdHkgZnVuY3Rpb24gdG8gY3JlYXRlIGEgVk1MIHRhZyAqLwogICAgZnVuY3Rpb24gdm1sKHRhZywgYXR0cikgewogICAgICByZXR1cm4gY3JlYXRlRWwoJzwnICsgdGFnICsgJyB4bWxucz0idXJuOnNjaGVtYXMtbWljcm9zb2Z0LmNvbTp2bWwiIGNsYXNzPSJzcGluLXZtbCI+JywgYXR0cikKICAgIH0KCiAgICAvLyBObyBDU1MgdHJhbnNmb3JtcyBidXQgVk1MIHN1cHBvcnQsIGFkZCBhIENTUyBydWxlIGZvciBWTUwgZWxlbWVudHM6CiAgICBzaGVldC5hZGRSdWxlKCcuc3Bpbi12bWwnLCAnYmVoYXZpb3I6dXJsKCNkZWZhdWx0I1ZNTCknKQoKICAgIFNwaW5uZXIucHJvdG90eXBlLmxpbmVzID0gZnVuY3Rpb24oZWwsIG8pIHsKICAgICAgdmFyIHIgPSBvLmxlbmd0aCtvLndpZHRoCiAgICAgICAgLCBzID0gMipyCgogICAgICBmdW5jdGlvbiBncnAoKSB7CiAgICAgICAgcmV0dXJuIGNzcygKICAgICAgICAgIHZtbCgnZ3JvdXAnLCB7CiAgICAgICAgICAgIGNvb3Jkc2l6ZTogcyArICcgJyArIHMsCiAgICAgICAgICAgIGNvb3Jkb3JpZ2luOiAtciArICcgJyArIC1yCiAgICAgICAgICB9KSwKICAgICAgICAgIHsgd2lkdGg6IHMsIGhlaWdodDogcyB9CiAgICAgICAgKQogICAgICB9CgogICAgICB2YXIgbWFyZ2luID0gLShvLndpZHRoK28ubGVuZ3RoKSoyICsgJ3B4JwogICAgICAgICwgZyA9IGNzcyhncnAoKSwge3Bvc2l0aW9uOiAnYWJzb2x1dGUnLCB0b3A6IG1hcmdpbiwgbGVmdDogbWFyZ2lufSkKICAgICAgICAsIGkKCiAgICAgIGZ1bmN0aW9uIHNlZyhpLCBkeCwgZmlsdGVyKSB7CiAgICAgICAgaW5zKGcsCiAgICAgICAgICBpbnMoY3NzKGdycCgpLCB7cm90YXRpb246IDM2MCAvIG8ubGluZXMgKiBpICsgJ2RlZycsIGxlZnQ6IH5+ZHh9KSwKICAgICAgICAgICAgaW5zKGNzcyh2bWwoJ3JvdW5kcmVjdCcsIHthcmNzaXplOiBvLmNvcm5lcnN9KSwgewogICAgICAgICAgICAgICAgd2lkdGg6IHIsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IG8ud2lkdGgsCiAgICAgICAgICAgICAgICBsZWZ0OiBvLnJhZGl1cywKICAgICAgICAgICAgICAgIHRvcDogLW8ud2lkdGg+PjEsCiAgICAgICAgICAgICAgICBmaWx0ZXI6IGZpbHRlcgogICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgIHZtbCgnZmlsbCcsIHtjb2xvcjogZ2V0Q29sb3Ioby5jb2xvciwgaSksIG9wYWNpdHk6IG8ub3BhY2l0eX0pLAogICAgICAgICAgICAgIHZtbCgnc3Ryb2tlJywge29wYWNpdHk6IDB9KSAvLyB0cmFuc3BhcmVudCBzdHJva2UgdG8gZml4IGNvbG9yIGJsZWVkaW5nIHVwb24gb3BhY2l0eSBjaGFuZ2UKICAgICAgICAgICAgKQogICAgICAgICAgKQogICAgICAgICkKICAgICAgfQoKICAgICAgaWYgKG8uc2hhZG93KQogICAgICAgIGZvciAoaSA9IDE7IGkgPD0gby5saW5lczsgaSsrKQogICAgICAgICAgc2VnKGksIC0yLCAncHJvZ2lkOkRYSW1hZ2VUcmFuc2Zvcm0uTWljcm9zb2Z0LkJsdXIocGl4ZWxyYWRpdXM9MixtYWtlc2hhZG93PTEsc2hhZG93b3BhY2l0eT0uMyknKQoKICAgICAgZm9yIChpID0gMTsgaSA8PSBvLmxpbmVzOyBpKyspIHNlZyhpKQogICAgICByZXR1cm4gaW5zKGVsLCBnKQogICAgfQoKICAgIFNwaW5uZXIucHJvdG90eXBlLm9wYWNpdHkgPSBmdW5jdGlvbihlbCwgaSwgdmFsLCBvKSB7CiAgICAgIHZhciBjID0gZWwuZmlyc3RDaGlsZAogICAgICBvID0gby5zaGFkb3cgJiYgby5saW5lcyB8fCAwCiAgICAgIGlmIChjICYmIGkrbyA8IGMuY2hpbGROb2Rlcy5sZW5ndGgpIHsKICAgICAgICBjID0gYy5jaGlsZE5vZGVzW2krb107IGMgPSBjICYmIGMuZmlyc3RDaGlsZDsgYyA9IGMgJiYgYy5maXJzdENoaWxkCiAgICAgICAgaWYgKGMpIGMub3BhY2l0eSA9IHZhbAogICAgICB9CiAgICB9CiAgfQoKICB2YXIgcHJvYmUgPSBjc3MoY3JlYXRlRWwoJ2dyb3VwJyksIHtiZWhhdmlvcjogJ3VybCgjZGVmYXVsdCNWTUwpJ30pCgogIGlmICghdmVuZG9yKHByb2JlLCAndHJhbnNmb3JtJykgJiYgcHJvYmUuYWRqKSBpbml0Vk1MKCkKICBlbHNlIHVzZUNzc0FuaW1hdGlvbnMgPSB2ZW5kb3IocHJvYmUsICdhbmltYXRpb24nKQoKICByZXR1cm4gU3Bpbm5lcgoKfSkpOwoKLyoqCiAqIENvcHlyaWdodCAoYykgMjAxMS0yMDE0IEZlbGl4IEduYXNzCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogKi8KCi8qCgpCYXNpYyBVc2FnZToKPT09PT09PT09PT09CgokKCcjZWwnKS5zcGluKCk7IC8vIENyZWF0ZXMgYSBkZWZhdWx0IFNwaW5uZXIgdXNpbmcgdGhlIHRleHQgY29sb3Igb2YgI2VsLgokKCcjZWwnKS5zcGluKHsgLi4uIH0pOyAvLyBDcmVhdGVzIGEgU3Bpbm5lciB1c2luZyB0aGUgcHJvdmlkZWQgb3B0aW9ucy4KCiQoJyNlbCcpLnNwaW4oZmFsc2UpOyAvLyBTdG9wcyBhbmQgcmVtb3ZlcyB0aGUgc3Bpbm5lci4KClVzaW5nIFByZXNldHM6Cj09PT09PT09PT09PT09CgokKCcjZWwnKS5zcGluKCdzbWFsbCcpOyAvLyBDcmVhdGVzIGEgJ3NtYWxsJyBTcGlubmVyIHVzaW5nIHRoZSB0ZXh0IGNvbG9yIG9mICNlbC4KJCgnI2VsJykuc3BpbignbGFyZ2UnLCAnI2ZmZicpOyAvLyBDcmVhdGVzIGEgJ2xhcmdlJyB3aGl0ZSBTcGlubmVyLgoKQWRkaW5nIGEgY3VzdG9tIHByZXNldDoKPT09PT09PT09PT09PT09PT09PT09PT0KCiQuZm4uc3Bpbi5wcmVzZXRzLmZsb3dlciA9IHsKICBsaW5lczogOQogIGxlbmd0aDogMTAKICB3aWR0aDogMjAKICByYWRpdXM6IDAKfQoKJCgnI2VsJykuc3BpbignZmxvd2VyJywgJ3JlZCcpOwoKKi8KCihmdW5jdGlvbihmYWN0b3J5KSB7CgogIGlmICh0eXBlb2YgZXhwb3J0cyA9PSAnb2JqZWN0JykgewogICAgLy8gQ29tbW9uSlMKICAgIGZhY3RvcnkocmVxdWlyZSgnanF1ZXJ5JyksIHJlcXVpcmUoJ3NwaW4nKSkKICB9CiAgZWxzZSBpZiAodHlwZW9mIGRlZmluZSA9PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQpIHsKICAgIC8vIEFNRCwgcmVnaXN0ZXIgYXMgYW5vbnltb3VzIG1vZHVsZQogICAgZGVmaW5lKFsnanF1ZXJ5JywgJ3NwaW4nXSwgZmFjdG9yeSkKICB9CiAgZWxzZSB7CiAgICAvLyBCcm93c2VyIGdsb2JhbHMKICAgIGlmICghd2luZG93LlNwaW5uZXIpIHRocm93IG5ldyBFcnJvcignU3Bpbi5qcyBub3QgcHJlc2VudCcpCiAgICBmYWN0b3J5KHdpbmRvdy5qUXVlcnksIHdpbmRvdy5TcGlubmVyKQogIH0KCn0oZnVuY3Rpb24oJCwgU3Bpbm5lcikgewoKICAkLmZuLnNwaW4gPSBmdW5jdGlvbihvcHRzLCBjb2xvcikgewoKICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKSB7CiAgICAgIHZhciAkdGhpcyA9ICQodGhpcyksCiAgICAgICAgZGF0YSA9ICR0aGlzLmRhdGEoKTsKCiAgICAgIGlmIChkYXRhLnNwaW5uZXIpIHsKICAgICAgICBkYXRhLnNwaW5uZXIuc3RvcCgpOwogICAgICAgIGRlbGV0ZSBkYXRhLnNwaW5uZXI7CiAgICAgIH0KICAgICAgaWYgKG9wdHMgIT09IGZhbHNlKSB7CiAgICAgICAgb3B0cyA9ICQuZXh0ZW5kKAogICAgICAgICAgeyBjb2xvcjogY29sb3IgfHwgJHRoaXMuY3NzKCdjb2xvcicpIH0sCiAgICAgICAgICAkLmZuLnNwaW4ucHJlc2V0c1tvcHRzXSB8fCBvcHRzCiAgICAgICAgKQogICAgICAgIGRhdGEuc3Bpbm5lciA9IG5ldyBTcGlubmVyKG9wdHMpLnNwaW4odGhpcykKICAgICAgfQogICAgfSkKICB9CgogICQuZm4uc3Bpbi5wcmVzZXRzID0gewogICAgdGlueTogeyBsaW5lczogOCwgbGVuZ3RoOiAyLCB3aWR0aDogMiwgcmFkaXVzOiAzIH0sCiAgICBzbWFsbDogeyBsaW5lczogOCwgbGVuZ3RoOiA0LCB3aWR0aDogMywgcmFkaXVzOiA1IH0sCiAgICBsYXJnZTogeyBsaW5lczogMTAsIGxlbmd0aDogOCwgd2lkdGg6IDQsIHJhZGl1czogOCB9CiAgfQoKfSkpOwoKLy8gPT09PSBBSkFYSU5BVEUgPT09PSAvLwoKLy8gRG9jdW1lbnRhdGlvbjogaHR0cHM6Ly9naXRodWIuY29tL3N5bmFwdGljaXNtL2FqYXhpbmF0ZQoKLy8gR2xvYmFsIG5hbWVzcGFjZSBvYmplY3Q7IGluc3BpcmF0aW9uIGZvciB0aGUgZGVzaWduIG9mIHRoaXMgdmlhIFJ5YW4gRmxvcmVuY2U6IGh0dHA6Ly9yeWFuZmxvcmVuY2UuY29tL2F1dGhvcmluZy1qcXVlcnktcGx1Z2lucy13aXRoLW9iamVjdC1vcmllbnRlZC1qYXZhc2NyaXB0Lwp2YXIgWE44ID0ge307Cgo7KGZ1bmN0aW9uKCQsIHdpbmRvdywgZG9jdW1lbnQsIHVuZGVmaW5lZCl7CiAgJ3VzZSBzdHJpY3QnOwoKICAvLyBJbml0aWFsaXplIEhUTUw1LUhpc3RvcnktQVBJIHBvbHlmaWxsIHdpdGggdGhpcyBzaW5nbGUgbGluZQogIHZhciBsb2NhdGlvbiA9IHdpbmRvdy5oaXN0b3J5LmxvY2F0aW9uIHx8IHdpbmRvdy5sb2NhdGlvbjsKCiAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIHRoZSBIVE1MNSBoaXN0b3J5IEFQSTsgaWYgbm90LCBmYWlsIGVhcmx5IGFuZCBsZXQgdGhlIHNpdGUgbG9hZCBub3JtYWxseQogIGlmICggISh3aW5kb3cuaGlzdG9yeSAmJiBoaXN0b3J5LnB1c2hTdGF0ZSkgKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvLyBDb25zdHJ1Y3RvciBmdW5jdGlvbgogIHZhciBBamF4aW5hdGUgPSB0aGlzLkFqYXhpbmF0ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIG9wdHMpewogICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgIHRoaXMub3B0cyA9ICQuZXh0ZW5kKHt9LCAkLmZuLmFqYXhpbmF0ZS5kZWZhdWx0cywgb3B0cyk7CiAgICB0aGlzLmluaXQoKTsKICB9OwoKICAvLyBQcm90b3R5cGUgbG9naWMKICBBamF4aW5hdGUucHJvdG90eXBlID0gewogICAgaW5pdDogZnVuY3Rpb24oKXsKCiAgICAgIC8vIEZldGNoIGluaXRpYWwgY29udGVudCBhbmQgbWVudQogICAgICB0aGlzLmNvbnRlbnQgPSAkKHRoaXMub3B0cy5jb250ZW50U2VsKS5maWx0ZXIoJzpmaXJzdCcpOwogICAgICB0aGlzLm1lbnUgPSAkKHRoaXMub3B0cy5tZW51U2VsKS5maWx0ZXIoJzpmaXJzdCcpOwoKICAgICAgLy8gSW52YWxpZCBjb250ZW50IHNlbGVjdG9yOyBhYm9ydCBtaXNzaW9uISAoV2UgY2FuIGhhbmRsZSBhIGJhZCBtZW51IHNlbGVjdG9yLCBob3dldmVyLi4uKQogICAgICBpZiAoIXRoaXMuY29udGVudC5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIEluaXRpYWxpemUgaW50ZXJuYWwgbGluayBzZWxlY3RvcgogICAgICB0aGlzLmludGVybmFsU2VsKCk7CgogICAgICAvLyBJbml0aWFsaXplIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgZWxlbWVudChzKSBzcGVjaWZpZWQKICAgICAgdGhpcy5wcmVwKHRoaXMuZWxlbWVudCk7CgogICAgICAvLyBJbml0aWFsaXplIHBvcHN0YXRlIGV2ZW50IGhhbmRsZXIKICAgICAgdGhpcy5wb3BwZXIoKTsKCiAgICAgIC8vIEluaXRpYWxpemUgc3Bpbm5lcgogICAgICB0aGlzLnNwaW5uZXIoKTsKICAgIH0sCgoKCiAgICAvLyBJbnRlcm5hbCBsaW5rIHNsZWN0b3IKICAgIGludGVybmFsU2VsOiBmdW5jdGlvbigpewogICAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgICAvLyBSZWdpc3RlciB0aGUgY3VzdG9tIHNlbGVjdG9yIHRvIGlkZW50aWZ5IGludGVybmFsIGxpbmtzCiAgICAgICQuZXhwclsnOiddLmludGVybmFsID0gZnVuY3Rpb24ob2JqLGluZGV4LG1ldGEsc3RhY2spewogICAgICAgIHZhcgogICAgICAgICAgJHRoaXMgICA9ICQob2JqKSwKICAgICAgICAgIHVybCAgICAgPSAkdGhpcy5hdHRyKCdocmVmJykgfHwgJycsCiAgICAgICAgICByb290dXJsID0gc2VsZi5yb290KCk7CgogICAgICAgIC8vIFRoZSBsaW5rIGlzICJpbnRlcm5hbCIgaWY6IHRoZSBkb21haW4gbWF0Y2hlcyB0aGUgY3VycmVudCBkb21haW4gb3IgdGhlcmUgaXMgbm8gcHJvdG9jb2wgKGkuZS4gaXQgaXMgYSByZWxhdGl2ZSBsaW5rKQogICAgICAgIHJldHVybiB1cmwuc3Vic3RyaW5nKDAscm9vdHVybC5sZW5ndGgpID09PSByb290dXJsIHx8IHVybC5pbmRleE9mKCc6JykgPT09IC0xOwogICAgICB9OwogICAgfSwgLy8gZW5kIGludGVybmFsU2VsKCkKCgoKICAgIC8vIFByaW1hcnkgZXZlbnQgYmluZGluZyBmdW5jdGlvbgogICAgcHJlcDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgIC8vIFNlbGVjdCBhbGwgYW5jaG9yIHRhZ3Mgd2l0aGluIHRoZSB0YXJnZXQgZWxlbWVudDsgdXNlcyBuYXRpdmUgSmF2YVNjcmlwdCBtZXRob2RzIChmYXN0KQogICAgICAkKGVsZW1lbnQpLmZpbmQoJ2EnKQoKICAgICAgLy8gTm93IGZpbHRlciB0aGUgcmVzdWx0cyB0byBmaW5kIGNlcnRhaW4gaW50ZXJuYWwgbGlua3M7IHVzZXMgY29tcGxleCBqUXVlcnkgc2VsZWN0b3JzIChzbG93KQogICAgICAuZmlsdGVyKCc6aW50ZXJuYWwnICsgc2VsZi5vcHRzLmZpbHRlcnMpCgogICAgICAvLyBNYW5hZ2UgY2xpY2sgZXZlbnQKICAgICAgLm9uKCdjbGljaycsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICB2YXIKICAgICAgICAgICR0aGlzID0gJCh0aGlzKSwKICAgICAgICAgIHVybCAgID0gJHRoaXMuYXR0cignaHJlZicpLAogICAgICAgICAgdGl0bGUgPSAkdGhpcy5hdHRyKCd0aXRsZScpIHx8IG51bGw7IC8vIE5vdCBodWdlbHkgaW1wb3J0YW50IGJ1dCB3ZSdsbCB1c2UgYSB0aXRsZSBhdHRyaWJ1dGUgaWYgb25lIGhhcHBlbnMgdG8gYmUgcHJlc2VudAoKICAgICAgICAvLyBSZXR1cm4gZmFsc2UgKGFuZCBwcmV2ZW50IGFsbCBhY3Rpb25zKSB1bmRlciB0aGVzZSBjaXJjdW1zdGFuY2VzOgogICAgICAgIC8vIC0gVVJMIGlzIHRoZSBzYW1lIGFzIHRoZSBjdXJyZW50IGxvY2F0aW9uIChubyBzZW5zZSBpbiByZWxvYWRpbmcgYW55dGhpbmcpCiAgICAgICAgLy8gLSBVUkwgaXMganVzdCBhIGhhc2ggKGRpdHRvKQogICAgICAgIGlmICggdXJsID09PSBsb2NhdGlvbi5ocmVmIHx8IHVybCA9PT0gJyMnICkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgLy8gUmV0dXJuIHRydWUgKGFuZCBhbGxvdyBub3JtYWwgYnJvd3NlciBiZWhhdmlvcikgdW5kZXIgdGhlc2UgY2lyY3Vtc3RhbmNlczoKICAgICAgICAvLyAtIE1pZGRsZSBtb3VzZSBidXR0b24gY2xpY2tzIChldmVudC53aGljaCA9PT0gMik7IHJlZmVyZW5jZTogaHR0cHM6Ly9hcGkuanF1ZXJ5LmNvbS9ldmVudC53aGljaC8KICAgICAgICAvLyAtIENvbW1hbmQgYW5kIGNvbnRyb2wga2V5IGNsaWNrcyBlLmcuIHRvIG9wZW4gaW4gYSBuZXcgdGFiOyByZWZlcmVuY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9icm93c2Vyc3RhdGUvYWpheGlmeS9wdWxsLzE1L2ZpbGVzCiAgICAgICAgLy8gLSBTZWUgYWxzbzogZXZlbnQuYWx0S2V5LCBldmVudC5zaGlmdEtleSAobm90IGltcGxlbWVudGVkKQogICAgICAgIC8vIC0gVVJMIG5vdCBzZXQgKHNob3VsZG4ndCBoYXBwZW4pIG9yIFVSTCBiZWdpbnMgd2l0aCBhIGhhc2ggKGluIGRvY3VtZW50IGxpbmspCiAgICAgICAgLy8gLSBVUkwgbWF0Y2hlcyB0aGUgZXhjZXB0aW9ucyBkZWZpbmVkIGluIHRoZSBvcHRpb25zIChkZWZhdWx0czogY2VydGFpbiBmaWxlIGV4dGVuc2lvbnMgZS5nLiBpbWFnZXMsIGF1ZGlvIGZpbGVzLCBldGMuKQogICAgICAgIGlmICgKICAgICAgICAgIGV2ZW50LndoaWNoID09PSAyIHx8CiAgICAgICAgICBldmVudC5tZXRhS2V5ICAgICB8fAogICAgICAgICAgZXZlbnQuY3RybEtleSAgICAgfHwKICAgICAgICAgICF1cmwgICAgICAgICAgICAgIHx8CiAgICAgICAgICB1cmxbMF0gPT09ICcjJyAgICB8fAogICAgICAgICAgdXJsLm1hdGNoKHNlbGYub3B0cy5leGNlcHRpb25zKQogICAgICAgICkgewogICAgICAgICAgLy8gQFRPRE86IC50cmlnZ2VyKCdpbnRlcm5hbEV4Y2VwdGlvbicpIGN1c3RvbSBldmVudD8KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gRG9uJ3QgbWFrZSBhIHBhZ2UgcmVxdWVzdCBpZiB3ZSd2ZSBjb21lIHRoaXMgZmFyCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgLy8gUHVzaCBhbmQgbG9hZAogICAgICAgIHNlbGYucHVzaGVyKHRpdGxlLHVybCk7CiAgICAgIH0pOwogICAgfSwgLy8gZW5kIHByZXAoKQoKCgogICAgLy8gUHVzaCBzdGF0ZSBoYW5kbGVyOyBpc29sYXRlZCBoZXJlIGZvciBncmVhdGVyIG1vZHVsYXJpdHk7IHlvdSBjYW4gY2FsbCB0aGlzIGZyb20gcGx1Z2lucyBtb3JlIGVhc2lseQogICAgcHVzaGVyOiBmdW5jdGlvbih0aXRsZSx1cmwpewoKICAgICAgLy8gSW5pdGlhdGUgYSBzdGF0ZSBvYmplY3QgZm9yIHRoaXMgcHVzaDsgQFRPRE86IGZsZXNoIHRoaXMgb3V0IGEgYml0LCBpdCdzIG5vdCBodWdlbHkgdXNlZnVsIGluIGl0cyBwcmVzZW50IHN0YXRlCiAgICAgIHZhciBzdGF0ZSA9IHsKICAgICAgICB0aXRsZTogdGl0bGUsCiAgICAgICAgdXJsOiB1cmwKICAgICAgfTsKCiAgICAgIC8vIFB1c2ggc3RhdGUKICAgICAgaGlzdG9yeS5wdXNoU3RhdGUoc3RhdGUsdGl0bGUsdXJsKTsKCiAgICAgIC8vIExvYWQgbmV3IGNvbnRlbnQgdmlhIEFKQVgKICAgICAgdGhpcy5sb2FkKHVybCk7CiAgICB9LCAvLyBlbmQgcHVzaGVyKCkKCgoKICAgIC8vIFRoZSBwb3BzdGF0ZSBldmVudCBmaXJlcyB3aGVuIHRoZSB1c2VyIG5hdmlnYXRlcyBiYWNrd2FyZCBvciBmb3J3YXJkIGluIHRoZSBicm93c2VyCiAgICBwb3BwZXI6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBzZWxmID0gdGhpczsKCiAgICAgICQod2luZG93KS5vbigncG9wc3RhdGUnLCBmdW5jdGlvbihldmVudCl7CgogICAgICAgIC8vIEBUT0RPOiBjaGVjayBwcmV2aW91cyBzdGF0ZSBvYmplY3QgdG8gc2VlIHdoZXRoZXIgbW9yZSB0aGFuIGp1c3QgdGhlIGhhc2ggaGFzIGNoYW5nZWQKICAgICAgICAvLyBHZXQgeW91ciBoYXNoOiBodHRwOi8vbGVhLnZlcm91Lm1lLzIwMTEvMDUvZ2V0LXlvdXItaGFzaC10aGUtYnVsbGV0cHJvb2Ytd2F5LwogICAgICAgIGlmIChsb2NhdGlvbi5oYXNoLnN1YnN0cmluZygxKSA9PT0gJycpIHsKICAgICAgICAgIHNlbGYubG9hZChsb2NhdGlvbi5ocmVmKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwgLy8gZW5kIHBvcHBlcigpCgoKCiAgICAvLyBDb25kaXRpb25hbGx5IGluaXRpYWxpemUgc3Bpbm5lciBkaXY7IGRlZ3JhZGVzIGdyYWNlZnVsbHkgaWYgc3Bpbi5qcyBub3QgZm91bmQKICAgIHNwaW5uZXI6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICggJC5pc0Z1bmN0aW9uKHdpbmRvdy5TcGlubmVyKSApIHsKICAgICAgICB0aGlzLmNvbnRlbnQuYmVmb3JlKCc8ZGl2IGlkPSJzcGlubmVyIiBzdHlsZT0icG9zaXRpb246IGZpeGVkOyBoZWlnaHQ6IDEwMCU7IHdpZHRoOiAxMDAlOyI+PC9kaXY+Jyk7CiAgICAgICAgJCgnI3NwaW5uZXInKS5zcGluKHRoaXMub3B0cy5zcGluT3B0cykuaGlkZSgpOwogICAgICB9CiAgICB9LCAvLyBlbmQgc3Bpbm5lcigpCgoKCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGR5bmFtaWNhbGx5IGxvYWRzIGNvbnRlbnQgZnJvbSB0aGUgcmVxdWVzdGVkIHBhZ2UKICAgIGxvYWQ6IGZ1bmN0aW9uKHVybCl7CiAgICAgIHZhcgogICAgICAgIHNlbGYgICAgICAgPSB0aGlzLAogICAgICAgICRib2R5ICAgICAgPSAkKGRvY3VtZW50LmJvZHkpLAogICAgICAgICRzcGlubmVyICAgPSAkKCcjc3Bpbm5lcicpLAogICAgICAgIGNvbnRlbnRTZWwgPSB0aGlzLm9wdHMuY29udGVudFNlbCwKICAgICAgICBtZW51U2VsICAgID0gdGhpcy5vcHRzLm1lbnVTZWw7CgogICAgICAvLyBEaW0gZXhpc3RpbmcgY29udGVudDsgdXNlIGFuaW1hdGUgdG8gcHJlc2VydmUgdGhlIGVsZW1lbnQncyBoZWlnaHQgKGF2b2lkcyBzY3JvbGxiYXIgZmxpY2tlcikKICAgICAgdGhpcy5jb250ZW50LmFuaW1hdGUoeyBvcGFjaXR5OiB0aGlzLm9wdHMub3V0T3BhY2l0eSB9LCB0aGlzLm9wdHMub3V0RGVsYXkpOwoKICAgICAgLy8gU3BpbiBzcGluIHN1Z2FyOyBubyBkZWxheSBuZWVkZWQgaGVyZQogICAgICAkc3Bpbm5lci5zaG93KCk7CgogICAgICAvLyBBSkFYIHBhZ2UgcmVxdWVzdDsgZmV0Y2ggdGhlIGNvbnRlbnQgd2UgbmVlZAogICAgICAkLmFqYXgoewogICAgICAgIHVybDogdXJsLAogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEsdGV4dFN0YXR1cyxqcVhIUil7CgogICAgICAgICAgLy8gUXVpY2tseSBmYWRlIGNvbnRlbnQgb3V0IGVudGlyZWx5CiAgICAgICAgICBzZWxmLmNvbnRlbnQuYW5pbWF0ZSh7IG9wYWNpdHk6IDAgfSwgMjApOwoKICAgICAgICAgIHZhcgogICAgICAgICAgICAkZGF0YSAgICAgICAgID0gJChzZWxmLmRvY0hlbHAoZGF0YSkpLAogICAgICAgICAgICAkZG9jQm9keSAgICAgID0gJGRhdGEuZmluZCgnI2RvYy1ib2R5OmZpcnN0JyksCiAgICAgICAgICAgICRjb250ZW50ICAgICAgPSAkZG9jQm9keS5maW5kKGNvbnRlbnRTZWwpLmZpbHRlcignOmZpcnN0JyksCiAgICAgICAgICAgICRtZW51ICAgICAgICAgPSAkZG9jQm9keS5maW5kKG1lbnVTZWwpLmZpbHRlcignOmZpcnN0Jyk7CgogICAgICAgICAgLy8gSWYgbm8gY29udGVudCBpcyByZWNlaXZlZCBmb3IgYW55IHJlYXNvbiBqdXN0IGZvcndhcmQgdGhlIHVzZXIgb24gdG8gdGhlIHRhcmdldCBVUkwKICAgICAgICAgIGlmICghJGNvbnRlbnQubGVuZ3RoKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdG9wIGFuaW1hdGlvbiBpbW1lZGlhdGVseQogICAgICAgICAgc2VsZi5jb250ZW50LnN0b3AodHJ1ZSx0cnVlKTsKCiAgICAgICAgICAvLyBVcGRhdGUgdGhlIGNvbnRlbnQgYW5kIHByZXAgZXZlbnQgaGFuZGxlcnMKICAgICAgICAgIHNlbGYucHJlcCggc2VsZi5jb250ZW50Lmh0bWwoICRjb250ZW50Lmh0bWwoKSApICk7CgogICAgICAgICAgLy8gU3dhcCB0aGUgbWVudShzKSBhbmQgcHJlcCBldmVudCBoYW5kbGVycyBpZiBhIG1lbnUgaXMgZm91bmQKICAgICAgICAgIGlmICgkbWVudS5sZW5ndGgpIHsKICAgICAgICAgICAgc2VsZi5wcmVwKCBzZWxmLm1lbnUuaHRtbCggJG1lbnUuaHRtbCgpICkgKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBIYXJtb25pemUgYm9keSBjbGFzc2VzOyBtYWtlcyBXb3JkUHJlc3MgcGFnZXMgcmVuZGVyIHNtb290aGx5IGJ1dCBhbHNvIGdlbmVyYWxseSB1c2VmdWwKICAgICAgICAgICRib2R5LmF0dHIoJ2NsYXNzJywgJGRvY0JvZHkuYXR0cignY2xhc3MnKSk7CgogICAgICAgICAgLy8gRmFkZSB0aGUgY29udGVudCBiYWNrIGluCiAgICAgICAgICBzZWxmLmNvbnRlbnQuYW5pbWF0ZSh7IG9wYWNpdHk6IDEgfSwgc2VsZi5vcHRzLmluRGVsYXkpOwoKICAgICAgICAgIC8vIFVwZGF0ZSBib2R5IHNjcmlwdHMgb3V0c2lkZSBvZiB0aGUgY29udGVudCBhcmVhCiAgICAgICAgICBzZWxmLnNjcmlwdHMoICRkb2NCb2R5LmZpbmQoJ3NjcmlwdCcpLm5vdChjb250ZW50U2VsKyc6Zmlyc3Qgc2NyaXB0JykgKTsKCiAgICAgICAgICAvLyBVcGRhdGUgZG9jdW1lbnQgdGl0bGUKICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gc2VsZi5zYW5pdGl6ZSggJGRhdGEuZmluZCgnI2RvYy10aXRsZTpmaXJzdCcpLnRleHQoKSApOwogICAgICAgIH0sCgogICAgICAgIC8vIEVycm9yIGhhbmRsaW5nOyBmYWxsIGJhY2sgb24gcmVndWxhciBwYWdlIGxvYWQgaWYgYW55dGhpbmcgZ29lcyB3cm9uZwogICAgICAgIGVycm9yOiBmdW5jdGlvbihqcVhIUix0ZXh0U3RhdHVzLGVycm9yVGhyb3duKXsKICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLmhyZWYgPSB1cmw7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSwgLy8gZW5kIGVycm9yIGhhbmRsaW5nCgogICAgICAgIC8vIENsZWFuIHVwIGFmdGVyIGNvbXBsZXRpbmcgdGhlIEFKQVggY2FsbAogICAgICAgIGNvbXBsZXRlOiBmdW5jdGlvbihqcVhIUix0ZXh0U3RhdHVzKXsKCiAgICAgICAgICAvLyBGYWRlIG91dCBzcGlubmVyCiAgICAgICAgICAkc3Bpbm5lci5mYWRlT3V0KHNlbGYub3B0cy5zcGluRmFkZSwgZnVuY3Rpb24oKXsgJCh0aGlzKS5oaWRlKCk7IH0pOwoKICAgICAgICAgIC8vIFNjcm9sbCB0byB0aGUgYXBwcm9wcmlhdGUgbG9jYXRpb24KICAgICAgICAgIHNlbGYuc2Nyb2xsKCk7CgogICAgICAgICAgLy8gVXBkYXRlIGFuYWx5dGljcwogICAgICAgICAgc2VsZi5hbmFseXRpY3ModXJsKTsKCiAgICAgICAgfSAvLyBlbmQgY29tcGxldGUKCiAgICAgIH0pOyAvLyBlbmQgJC5hamF4CgogICAgfSwgLy8gZW5kIGxvYWQoKQoKCgogICAgLy8gVXBkYXRlIHNjcmlwdHMKICAgIHNjcmlwdHM6IGZ1bmN0aW9uKCRzY3JpcHRzKXsKICAgICAgdmFyCiAgICAgICAgJGJvZHkgICAgICAgPSAkKCdib2R5JyksCiAgICAgICAgY29udGVudFNjciAgPSB0aGlzLm9wdHMuY29udGVudFNlbCArICc6Zmlyc3Qgc2NyaXB0JzsgLy8gU2VsZWN0cyBjb250ZW50IHNjcmlwdHMKCiAgICAgIC8vIEZldGNoIGJvZHkgc2NyaXB0cyBub3QgaW4gdGhlIGNvbnRlbnQgKHdoaWNoIHdpbGwgYmUgcmVwbGFjZWQgYW55aG93KQogICAgICBpZiAoICRzY3JpcHRzLmxlbmd0aCApIHsKICAgICAgICAkc2NyaXB0cy5kZXRhY2goKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7IC8vIEVhcmx5IGV4aXQ7IHRoZXJlIGFyZSBubyBzY3JpcHRzIHRvIHdvcmsgd2l0aAogICAgICB9CgogICAgICAvLyBVcGRhdGUgdGhlIGJvZHkgc2NyaXB0cyBvdXRzaWRlIG9mIHRoZSBjb250ZW50IGFyZWE7IHdlJ3JlIGFzc3VtaW5nIHRoYXQgaGVhZGVyIHNjcmlwdHMgZG9uJ3QgY2hhbmdlCiAgICAgICRzY3JpcHRzLmVhY2goZnVuY3Rpb24oKXsKICAgICAgICB2YXIgJHRoaXMgPSAkKHRoaXMpOwoKICAgICAgICAvLyBJZiB0aGUgY3VycmVudCBzY3JpcHQgaXNuJ3QgZW1wdHkgd2UgYXNzdW1lIGl0IG11c3QgYmUgaW5saW5lCiAgICAgICAgaWYgKCAkdGhpcy5odG1sKCkgIT09ICcnICkgewoKICAgICAgICAgIC8vIFNhdmUgdGhlIGN1cnJlY3Qgc2NyaXB0IGNvbnRlbnRzIGZvciB1c2UgaW4gdGhlIGxvb3AgdG8gZm9sbG93CiAgICAgICAgICB2YXIKICAgICAgICAgICAgaW5saW5lU2NyaXB0ID0gJHRoaXMuaHRtbCgpLAogICAgICAgICAgICBpc05ldyAgICAgICAgPSB0cnVlOwoKICAgICAgICAgIC8vIENoZWNrIGV4aXN0aW5nIHNjcmlwdHMgdG8gc2VlIGlmIHRoZXkgY29udGFpbiB0aGUgc2FtZSBzdHVmZgogICAgICAgICAgJC5lYWNoKCAkYm9keS5maW5kKCdzY3JpcHQ6bm90KDplbXB0eSknKS5ub3QoY29udGVudFNjciksIGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIGlmICggJHRoaXMuaHRtbCgpID09PSBpbmxpbmVTY3JpcHQgKSB7CiAgICAgICAgICAgICAgaXNOZXcgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gUGFzdGUgbmV3IHN0dWZmIGluIGlmIGl0IGlzbid0IGZvdW5kIGluIHRoZSBjdXJyZW50IERPTTsgdGhpcyBpcyBxdWl0ZSBhIGtsdWRnZQogICAgICAgICAgaWYgKCBpc05ldyA9PT0gdHJ1ZSApIHsKICAgICAgICAgICAgJGJvZHkuZmluZCgnc2NyaXB0Om5vdCg6ZW1wdHkpJykubm90KGNvbnRlbnRTY3IpLmZpbHRlcignOmZpcnN0JykuYmVmb3JlKCc8c2NyaXB0PicgKyAkdGhpcy5odG1sKCkgKyAnPC9zY3JpcHQ+Jyk7CiAgICAgICAgICB9CgogICAgICAgIC8vIEZldGNoIG5ldyBub24taW5saW5lIHNjcmlwdHMKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIC8vIFRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiBlYWNoIHNjcmlwdDsgbm8gc2Vuc2UgaW4gcmVwZWF0aW5nIG91cnNlbHZlcyBoZXJlCiAgICAgICAgICBpZiAoICEkYm9keS5maW5kKCdzY3JpcHRbc3JjKj0iJyArICR0aGlzLmF0dHIoJ3NyYycpICsgJyJdJykubGVuZ3RoICkgewogICAgICAgICAgICAvLyAkLmdldFNjcmlwdCBkb2VzIG5vdCBjYWNoZSBzY3JpcHRzIGJ5IGRlZmF1bHQgc28gd2UnbGwgc2tpcCB0aGUgc2hvcnRjdXQgYW5kIGdvIHN0cmFpZ2h0IHRvIHRoZSBzb3VyY2UKICAgICAgICAgICAgJC5hamF4KHsKICAgICAgICAgICAgICB1cmw6ICR0aGlzLmF0dHIoJ3NyYycpLAogICAgICAgICAgICAgIGRhdGFUeXBlOiAic2NyaXB0IiwKICAgICAgICAgICAgICBjYWNoZTogdHJ1ZSwKICAgICAgICAgICAgICBjb21wbGV0ZTogZnVuY3Rpb24oKXsgLy8gSW4gY2FzZSBjYWNoaW5nIGlzbid0IHdvcmtpbmcuLi4gYWRkIHRoZSBzY3JpcHQgdG8gdGhlIERPTQogICAgICAgICAgICAgICAgdmFyIG5ld1NjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwogICAgICAgICAgICAgICAgbmV3U2NyaXB0LnNyYyA9ICR0aGlzLmF0dHIoJ3NyYycpOyAvLyBObyBuZWVkIGZvciB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIGluIEhUTUw1CiAgICAgICAgICAgICAgICAkYm9keVswXS5hcHBlbmRDaGlsZChuZXdTY3JpcHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7IC8vIGVuZCAkLmFqYXgoKQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7IC8vIGVuZCAkc2NyaXB0cy5lYWNoKCkKICAgIH0sIC8vIGVuZCBzY3JpcHRzKCkKCgoKICAgIC8vIEVzY2FwZSBIVE1MIGVudGl0aWVzIGluIGEgc3RyaW5nCiAgICBzYW5pdGl6ZTogZnVuY3Rpb24oc3RyKXsKICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoL1smPD4iJ1wvIT1dL2csIGZ1bmN0aW9uKHMpewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAiJiI6ICImYW1wOyIsCiAgICAgICAgICAiPCI6ICImbHQ7IiwKICAgICAgICAgICI+IjogIiZndDsiLAogICAgICAgICAgJyInOiAiJnF1b3Q7IiwKICAgICAgICAgICInIjogIiZhcG9zOyIsCiAgICAgICAgICAiLyI6ICImIzA0NzsiLAogICAgICAgICAgIiEiOiAiJiMwMzM7IiwKICAgICAgICAgICI9IjogIiYjMDYxOyIKICAgICAgICB9W3NdOwogICAgICB9KTsKICAgIH0sIC8vIGVuZCBzYW5pdGl6ZSgpCgoKCiAgICAvLyBVcGRhdGUgc2Nyb2xsIHBvc2l0aW9uCiAgICBzY3JvbGw6IGZ1bmN0aW9uKCl7CiAgICAgIHZhcgogICAgICAgICRib2R5ICAgICAgID0gJCgnYm9keScpLAogICAgICAgIGhhc2ggICAgICAgID0gbG9jYXRpb24uaGFzaC5zdWJzdHJpbmcoMSksCiAgICAgICAgc2Nyb2xsRGVsYXkgPSB0aGlzLm9wdHMuc2Nyb2xsRGVsYXksCiAgICAgICAgdG9wICAgICAgICAgPSAkKHRoaXMub3B0cy5jb250ZW50U2VsKS5maWx0ZXIoJzpmaXJzdCcpLm9mZnNldCgpLnRvcDsKCiAgICAgIC8vIFRlc3QgZm9yIHRoZSBwcmVzZW5jZSBvZiBhIGhhc2ggaW4gdGhlIGxvY2F0aW9uCiAgICAgIGlmIChoYXNoICE9PSAnJykgewoKICAgICAgICAvLyBEZWZpbmUgdGhlIHNlbGVjdG9yCiAgICAgICAgdmFyICRoYXNoID0gJCgnW2lkPSInK2hhc2grJyJdJyk7CgogICAgICAgIC8vIFRlc3Qgd2hldGhlciB0aGUgc2VsZWN0b3IgZXhpc3RzOyBzY3JvbGwgdGhlcmUgaWYgZm91bmQgYW5kIGZhbGwgYmFjayBvbiByZWd1bGFyIHNjcm9sbCByb3V0aW5lIGlmIG5vdAogICAgICAgIGlmICggJGhhc2gubGVuZ3RoICkgewogICAgICAgICAgJGJvZHkuYW5pbWF0ZSh7IHNjcm9sbFRvcDogJGhhc2gub2Zmc2V0KCkudG9wIH0sIHNjcm9sbERlbGF5LCAic3dpbmciKTsKICAgICAgICAgIHJldHVybjsgLy8gRWFybHkgZXhpdCBmcm9tIGZ1bmN0aW9uOyB3ZSd2ZSBnb3Qgc29tZXRoaW5nIHRvIHNjcm9sbCB0byBhbmQgaXQncyBnb2luZyB0byBiZSBiZWxvdyB0aGUgZm9sZAogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU2Nyb2xsIHRvIHRoZSB0b3Agb2YgdGhlIGNvbnRlbnQgY29udGFpbmVyIHdoZW4gYmVsb3cgdGhlIGZvbGQKICAgICAgaWYgKCAkKHdpbmRvdykuc2Nyb2xsVG9wKCkgPiB0b3AgKSB7CiAgICAgICAgJGJvZHkuYW5pbWF0ZSh7IHNjcm9sbFRvcDogdG9wIH0sIHNjcm9sbERlbGF5LCAic3dpbmciKTsKICAgICAgfQoKICAgIH0sIC8vIGVuZCBzY3JvbGwoKQoKCgogICAgLy8gVXBkYXRlIEdvb2dsZSBBbmFseXRpY3Mgb24gY29udGVudCBsb2FkCiAgICBhbmFseXRpY3M6IGZ1bmN0aW9uKHVybCl7CiAgICAgIHZhciByZWxhdGl2ZVVybCA9ICcvJyArIHVybC5yZXBsYWNlKHRoaXMucm9vdCgpLCAnJyk7IC8vIFNldCB0aGUgcmVsYXRpdmUgVVJMIHJlcXVpcmVkIGJ5IEdvb2dsZSBBbmFseXRpY3MKCiAgICAgIC8vIEluZm9ybSBHb29nbGUgQW5hbHl0aWNzIG9mIHRoZSBjaGFuZ2U7IGNvbXBhdGlibGUgd2l0aCB0aGUgbmV3IFVuaXZlcnNhbCBBbmFseXRpY3Mgc2NyaXB0CiAgICAgIGlmICggdHlwZW9mIHdpbmRvdy5nYSAhPT0gJ3VuZGVmaW5lZCcgKSB7CiAgICAgICAgd2luZG93LmdhKCdzZW5kJywgJ3BhZ2V2aWV3JywgcmVsYXRpdmVVcmwpOwogICAgICB9IGVsc2UgaWYgKCB0eXBlb2Ygd2luZG93Ll9nYXEgIT09ICd1bmRlZmluZWQnICkgewogICAgICAgIHdpbmRvdy5fZ2FxLnB1c2goWydfdHJhY2tQYWdldmlldycsIHJlbGF0aXZlVXJsXSk7IC8vIExlZ2FjeSBhbmFseXRpY3M7IHJlZjogaHR0cHM6Ly9naXRodWIuY29tL2Jyb3dzZXJzdGF0ZS9hamF4aWZ5L3B1bGwvMjUKICAgICAgfQogICAgfSwgLy8gZW5kIGFuYWx5dGljcygpCgoKCiAgICAvLyBEb2N1bWVudCBoZWxwZXI7IGJyb3dzZXJzIG9mdGVuIHN0cmlwIG91dCBodG1sLCBoZWFkLCBib2R5LCB0aXRsZSwgYmFzZSwgYW5kIG1ldGEgdGFncyB3aGVuIHVzaW5nIC5pbm5lckhUTUw7IHNlZSBodHRwczovL2FwaS5qcXVlcnkuY29tL2xvYWQvCiAgICAvLyBUaGlzIGZ1bmN0aW9uIGFsbG93cyBhY2Nlc3MgdG8gdGhlc2UgdGFncyBieSB0cmFuc2Zvcm1pbmcgdGhlbSB0byBkaXZzIHdpdGggaWRzIHRoYXQgbWF0Y2ggdGhlIG9yaWdpbmFsIGUuZy4gI2RvYy10aXRsZQogICAgLy8gU2VlIGFsc286IGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2Nvd2JveS83NDI5NTIvCiAgICBkb2NIZWxwOiBmdW5jdGlvbihodG1sKXsKICAgICAgdmFyCiAgICAgICAgcmVzdWx0ID0gU3RyaW5nKGh0bWwpCiAgICAgICAgICAucmVwbGFjZSgvPFwhRE9DVFlQRVtePl0qPi9pLCAnJykKICAgICAgICAgIC5yZXBsYWNlKC88KGh0bWx8aGVhZHxib2R5fHRpdGxlfGJhc2V8bWV0YSkoW1xzXD5dKS9naSwnPGRpdiBpZD0iZG9jLSQxIiQyJykKICAgICAgICAgIC5yZXBsYWNlKC88XC8oaHRtbHxoZWFkfGJvZHl8dGl0bGV8YmFzZXxtZXRhKVw+L2dpLCc8L2Rpdj4nKQogICAgICA7CiAgICAgIHJldHVybiAkLnRyaW0ocmVzdWx0KTsKICAgIH0sIC8vIGVuZCBkb2NIZWxwKCkKCgoKICAgIC8vIFV0aWxpdHkgZnVuY3Rpb24gdG8gZ2V0IHRoZSByb290IFVSTCB3aXRoIHRyYWlsaW5nIHNsYXNoIGUuZy4gaHR0cChzKTovL3lvdXJkb21haW4uY29tLwogICAgcm9vdDogZnVuY3Rpb24oKXsKICAgICAgdmFyCiAgICAgICAgcG9ydCA9IGRvY3VtZW50LmxvY2F0aW9uLnBvcnQgPyAnOicgKyBkb2N1bWVudC5sb2NhdGlvbi5wb3J0IDogJycsCiAgICAgICAgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgKGRvY3VtZW50LmxvY2F0aW9uLmhvc3RuYW1lIHx8IGRvY3VtZW50LmxvY2F0aW9uLmhvc3QpICsgcG9ydCArICcvJzsKICAgICAgcmV0dXJuIHVybDsKICAgIH0gLy8gZW5kIHJvb3QoKQoKICB9OyAvLyBlbmQgQWpheGluYXRlLnByb3RvdHlwZQoKCgogIC8vIEEgbGlnaHR3ZWlnaHQgcGx1Z2luIHdyYXBwZXIgYXJvdW5kIHRoZSBjb25zdHJ1Y3RvciBwcmV2ZW50aW5nIG11bHRpcGxlIGluc3RhbnRpYXRpb25zCiAgJC5mbi5hamF4aW5hdGUgPSBmdW5jdGlvbiAob3B0cyl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIGlmICghJC5kYXRhKHRoaXMsICdYTjhfYWpheGluYXRlJykpIHsKICAgICAgICAkLmRhdGEodGhpcywgJ1hOOF9hamF4aW5hdGUnLCBuZXcgQWpheGluYXRlKHRoaXMsIG9wdHMpKTsKICAgICAgfQogICAgfSk7CiAgfTsKCgoKICAvLyBFeHRlbnNpYmxlIGRlZmF1bHQgc2V0dGluZ3MKICAkLmZuLmFqYXhpbmF0ZS5kZWZhdWx0cyA9IHsKICAgIGNvbnRlbnRTZWw6ICAgICcjY29udGVudCcgLy8gVGhlIHNlbGVjdG9yIGZvciBhbGwgcGFnZSBjb250ZW50cwogICwgbWVudVNlbDogICAgICAgJyNtZW51JyAgICAvLyBUaGUgc2VsZWN0b3IgZm9yIHRoZSBlbnRpcmUgbWVudQogICwgb3V0RGVsYXk6ICAgICAgNjAwCiAgLCBvdXRPcGFjaXR5OiAgICAwLjIgICAgICAgIC8vIERpbW1pbmcgcmF0aGVyIHRoYW4gY29tcGxldGVseSBoaWRpbmcgY29udGVudAogICwgaW5EZWxheTogICAgICAgMTIwCiAgLCBzY3JvbGxEZWxheTogICAzMDAKICAsIHNwaW5GYWRlOiAgICAgIDMwMCAgICAgICAgLy8gU3Bpbm5lciBmYWRlIG91dCBkdXJhdGlvbgogICwgc3Bpbk9wdHM6IHsgICAgICAgICAgICAgICAvLyBzcGluLmpzIG9wdGlvbnM7IHJlZmVyZW5jZTogaHR0cHM6Ly9mZ25hc3MuZ2l0aHViLmlvL3NwaW4uanMvCiAgICAgIGxpbmVzOiAgMjUKICAgICwgbGVuZ3RoOiAwCiAgICAsIHdpZHRoOiAgNAogICAgLCByYWRpdXM6IDI1CiAgICAsIHNwZWVkOiAgMS41CiAgICAsIHRyYWlsOiAgNDAKICAgICwgdG9wOiAgICAnMjUlJwogIH0KCiAgLy8gV2hpdGVsaXN0ZWQgZXh0ZW5zaW9ucyAocmVnZXhwKTsgdGhlc2Ugd2lsbCBuZWdhdGUgdGhlIGN1c3RvbSAiaW50ZXJuYWwiIHNlbGVjdG9yCiAgLCBleGNlcHRpb25zOiAvXC4oanBnfGpwZWd8cG5nfGdpZnxibXB8cGRmfG1wM3xmbGFjfHdhdnxyYXJ8emlwKSQvaQoKICAvLyBBZGRpdGlvbmFsIHNlbGVjdG9ycyB0byBmaWx0ZXIgd2hlbiBiaW5kaW5nIGV2ZW50cyAoc3RyaW5nKTsgdXNlICI6bm90KHNlbGVjdG9yKSIsIGZvciBleGFtcGxlLCB0byBza2lwIGNlcnRhaW4gc2VsZWN0b3JzIGUuZy4gYDpub3QoW2hyZWYqPSJ0ZXN0Il0pYCBldGMuCiAgLCBmaWx0ZXJzOiAnJwogIH07Cgp9KS5hcHBseShYTjgsIFtqUXVlcnksIHdpbmRvdywgZG9jdW1lbnRdKTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 06:44:24 GMT",
                    "Content-Length": "64197",
                    "Date": "Thu, 06 Nov 2014 06:44:24 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}